{
  "module_name": "hdmi_audio.c",
  "hash_id": "257c7f47d87e3c756e20798e3ff7151f6d44cbb36085cc8c4dca3abce92d0e17",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/msm/hdmi/hdmi_audio.c",
  "human_readable_source": "\n \n\n#include <linux/hdmi.h>\n#include \"hdmi.h\"\n\n \nstatic int nchannels[] = { 2, 4, 6, 8 };\n\n \n#define MSM_HDMI_SAMPLE_RATE_32KHZ\t\t0\n#define MSM_HDMI_SAMPLE_RATE_44_1KHZ\t\t1\n#define MSM_HDMI_SAMPLE_RATE_48KHZ\t\t2\n#define MSM_HDMI_SAMPLE_RATE_88_2KHZ\t\t3\n#define MSM_HDMI_SAMPLE_RATE_96KHZ\t\t4\n#define MSM_HDMI_SAMPLE_RATE_176_4KHZ\t\t5\n#define MSM_HDMI_SAMPLE_RATE_192KHZ\t\t6\n#define MSM_HDMI_SAMPLE_RATE_MAX\t\t7\n\n\nstruct hdmi_msm_audio_acr {\n\tuint32_t n;\t \n\tuint32_t cts;\t \n};\n\nstruct hdmi_msm_audio_arcs {\n\tunsigned long int pixclock;\n\tstruct hdmi_msm_audio_acr lut[MSM_HDMI_SAMPLE_RATE_MAX];\n};\n\n#define HDMI_MSM_AUDIO_ARCS(pclk, ...) { (1000 * (pclk)), __VA_ARGS__ }\n\n \n \nstatic const struct hdmi_msm_audio_arcs acr_lut[] = {\n\t \n\tHDMI_MSM_AUDIO_ARCS(25200, {\n\t\t{4096, 25200}, {6272, 28000}, {6144, 25200}, {12544, 28000},\n\t\t{12288, 25200}, {25088, 28000}, {24576, 25200} }),\n\t \n\tHDMI_MSM_AUDIO_ARCS(27000, {\n\t\t{4096, 27000}, {6272, 30000}, {6144, 27000}, {12544, 30000},\n\t\t{12288, 27000}, {25088, 30000}, {24576, 27000} }),\n\t \n\tHDMI_MSM_AUDIO_ARCS(27030, {\n\t\t{4096, 27027}, {6272, 30030}, {6144, 27027}, {12544, 30030},\n\t\t{12288, 27027}, {25088, 30030}, {24576, 27027} }),\n\t \n\tHDMI_MSM_AUDIO_ARCS(74250, {\n\t\t{4096, 74250}, {6272, 82500}, {6144, 74250}, {12544, 82500},\n\t\t{12288, 74250}, {25088, 82500}, {24576, 74250} }),\n\t \n\tHDMI_MSM_AUDIO_ARCS(148500, {\n\t\t{4096, 148500}, {6272, 165000}, {6144, 148500}, {12544, 165000},\n\t\t{12288, 148500}, {25088, 165000}, {24576, 148500} }),\n};\n\nstatic const struct hdmi_msm_audio_arcs *get_arcs(unsigned long int pixclock)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(acr_lut); i++) {\n\t\tconst struct hdmi_msm_audio_arcs *arcs = &acr_lut[i];\n\t\tif (arcs->pixclock == pixclock)\n\t\t\treturn arcs;\n\t}\n\n\treturn NULL;\n}\n\nint msm_hdmi_audio_update(struct hdmi *hdmi)\n{\n\tstruct hdmi_audio *audio = &hdmi->audio;\n\tstruct hdmi_audio_infoframe *info = &audio->infoframe;\n\tconst struct hdmi_msm_audio_arcs *arcs = NULL;\n\tbool enabled = audio->enabled;\n\tuint32_t acr_pkt_ctrl, vbi_pkt_ctrl, aud_pkt_ctrl;\n\tuint32_t infofrm_ctrl, audio_config;\n\n\tDBG(\"audio: enabled=%d, channels=%d, channel_allocation=0x%x, \"\n\t\t\"level_shift_value=%d, downmix_inhibit=%d, rate=%d\",\n\t\taudio->enabled, info->channels,  info->channel_allocation,\n\t\tinfo->level_shift_value, info->downmix_inhibit, audio->rate);\n\tDBG(\"video: power_on=%d, pixclock=%lu\", hdmi->power_on, hdmi->pixclock);\n\n\tif (enabled && !(hdmi->power_on && hdmi->pixclock)) {\n\t\tDBG(\"disabling audio: no video\");\n\t\tenabled = false;\n\t}\n\n\tif (enabled) {\n\t\tarcs = get_arcs(hdmi->pixclock);\n\t\tif (!arcs) {\n\t\t\tDBG(\"disabling audio: unsupported pixclock: %lu\",\n\t\t\t\t\thdmi->pixclock);\n\t\t\tenabled = false;\n\t\t}\n\t}\n\n\t \n\tacr_pkt_ctrl = hdmi_read(hdmi, REG_HDMI_ACR_PKT_CTRL);\n\tvbi_pkt_ctrl = hdmi_read(hdmi, REG_HDMI_VBI_PKT_CTRL);\n\taud_pkt_ctrl = hdmi_read(hdmi, REG_HDMI_AUDIO_PKT_CTRL1);\n\tinfofrm_ctrl = hdmi_read(hdmi, REG_HDMI_INFOFRAME_CTRL0);\n\taudio_config = hdmi_read(hdmi, REG_HDMI_AUDIO_CFG);\n\n\t \n\tacr_pkt_ctrl &= ~HDMI_ACR_PKT_CTRL_SELECT__MASK;\n\n\tif (enabled) {\n\t\tuint32_t n, cts, multiplier;\n\t\tenum hdmi_acr_cts select;\n\t\tuint8_t buf[14];\n\n\t\tn   = arcs->lut[audio->rate].n;\n\t\tcts = arcs->lut[audio->rate].cts;\n\n\t\tif ((MSM_HDMI_SAMPLE_RATE_192KHZ == audio->rate) ||\n\t\t\t\t(MSM_HDMI_SAMPLE_RATE_176_4KHZ == audio->rate)) {\n\t\t\tmultiplier = 4;\n\t\t\tn >>= 2;  \n\t\t} else if ((MSM_HDMI_SAMPLE_RATE_96KHZ == audio->rate) ||\n\t\t\t\t(MSM_HDMI_SAMPLE_RATE_88_2KHZ == audio->rate)) {\n\t\t\tmultiplier = 2;\n\t\t\tn >>= 1;  \n\t\t} else {\n\t\t\tmultiplier = 1;\n\t\t}\n\n\t\tDBG(\"n=%u, cts=%u, multiplier=%u\", n, cts, multiplier);\n\n\t\tacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_SOURCE;\n\t\tacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_AUDIO_PRIORITY;\n\t\tacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_N_MULTIPLIER(multiplier);\n\n\t\tif ((MSM_HDMI_SAMPLE_RATE_48KHZ == audio->rate) ||\n\t\t\t\t(MSM_HDMI_SAMPLE_RATE_96KHZ == audio->rate) ||\n\t\t\t\t(MSM_HDMI_SAMPLE_RATE_192KHZ == audio->rate))\n\t\t\tselect = ACR_48;\n\t\telse if ((MSM_HDMI_SAMPLE_RATE_44_1KHZ == audio->rate) ||\n\t\t\t\t(MSM_HDMI_SAMPLE_RATE_88_2KHZ == audio->rate) ||\n\t\t\t\t(MSM_HDMI_SAMPLE_RATE_176_4KHZ == audio->rate))\n\t\t\tselect = ACR_44;\n\t\telse  \n\t\t\tselect = ACR_32;\n\n\t\tacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_SELECT(select);\n\n\t\thdmi_write(hdmi, REG_HDMI_ACR_0(select - 1),\n\t\t\t\tHDMI_ACR_0_CTS(cts));\n\t\thdmi_write(hdmi, REG_HDMI_ACR_1(select - 1),\n\t\t\t\tHDMI_ACR_1_N(n));\n\n\t\thdmi_write(hdmi, REG_HDMI_AUDIO_PKT_CTRL2,\n\t\t\t\tCOND(info->channels != 2, HDMI_AUDIO_PKT_CTRL2_LAYOUT) |\n\t\t\t\tHDMI_AUDIO_PKT_CTRL2_OVERRIDE);\n\n\t\tacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_CONT;\n\t\tacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_SEND;\n\n\t\t \n\t\thdmi_audio_infoframe_pack(info, buf, sizeof(buf));\n\t\thdmi_write(hdmi, REG_HDMI_AUDIO_INFO0,\n\t\t\t\t(buf[3] <<  0) | (buf[4] <<  8) |\n\t\t\t\t(buf[5] << 16) | (buf[6] << 24));\n\t\thdmi_write(hdmi, REG_HDMI_AUDIO_INFO1,\n\t\t\t\t(buf[7] <<  0) | (buf[8] << 8));\n\n\t\thdmi_write(hdmi, REG_HDMI_GC, 0);\n\n\t\tvbi_pkt_ctrl |= HDMI_VBI_PKT_CTRL_GC_ENABLE;\n\t\tvbi_pkt_ctrl |= HDMI_VBI_PKT_CTRL_GC_EVERY_FRAME;\n\n\t\taud_pkt_ctrl |= HDMI_AUDIO_PKT_CTRL1_AUDIO_SAMPLE_SEND;\n\n\t\tinfofrm_ctrl |= HDMI_INFOFRAME_CTRL0_AUDIO_INFO_SEND;\n\t\tinfofrm_ctrl |= HDMI_INFOFRAME_CTRL0_AUDIO_INFO_CONT;\n\t\tinfofrm_ctrl |= HDMI_INFOFRAME_CTRL0_AUDIO_INFO_SOURCE;\n\t\tinfofrm_ctrl |= HDMI_INFOFRAME_CTRL0_AUDIO_INFO_UPDATE;\n\n\t\taudio_config &= ~HDMI_AUDIO_CFG_FIFO_WATERMARK__MASK;\n\t\taudio_config |= HDMI_AUDIO_CFG_FIFO_WATERMARK(4);\n\t\taudio_config |= HDMI_AUDIO_CFG_ENGINE_ENABLE;\n\t} else {\n\t\tacr_pkt_ctrl &= ~HDMI_ACR_PKT_CTRL_CONT;\n\t\tacr_pkt_ctrl &= ~HDMI_ACR_PKT_CTRL_SEND;\n\t\tvbi_pkt_ctrl &= ~HDMI_VBI_PKT_CTRL_GC_ENABLE;\n\t\tvbi_pkt_ctrl &= ~HDMI_VBI_PKT_CTRL_GC_EVERY_FRAME;\n\t\taud_pkt_ctrl &= ~HDMI_AUDIO_PKT_CTRL1_AUDIO_SAMPLE_SEND;\n\t\tinfofrm_ctrl &= ~HDMI_INFOFRAME_CTRL0_AUDIO_INFO_SEND;\n\t\tinfofrm_ctrl &= ~HDMI_INFOFRAME_CTRL0_AUDIO_INFO_CONT;\n\t\tinfofrm_ctrl &= ~HDMI_INFOFRAME_CTRL0_AUDIO_INFO_SOURCE;\n\t\tinfofrm_ctrl &= ~HDMI_INFOFRAME_CTRL0_AUDIO_INFO_UPDATE;\n\t\taudio_config &= ~HDMI_AUDIO_CFG_ENGINE_ENABLE;\n\t}\n\n\thdmi_write(hdmi, REG_HDMI_ACR_PKT_CTRL, acr_pkt_ctrl);\n\thdmi_write(hdmi, REG_HDMI_VBI_PKT_CTRL, vbi_pkt_ctrl);\n\thdmi_write(hdmi, REG_HDMI_AUDIO_PKT_CTRL1, aud_pkt_ctrl);\n\thdmi_write(hdmi, REG_HDMI_INFOFRAME_CTRL0, infofrm_ctrl);\n\n\thdmi_write(hdmi, REG_HDMI_AUD_INT,\n\t\t\tCOND(enabled, HDMI_AUD_INT_AUD_FIFO_URUN_INT) |\n\t\t\tCOND(enabled, HDMI_AUD_INT_AUD_SAM_DROP_INT));\n\n\thdmi_write(hdmi, REG_HDMI_AUDIO_CFG, audio_config);\n\n\n\tDBG(\"audio %sabled\", enabled ? \"en\" : \"dis\");\n\n\treturn 0;\n}\n\nint msm_hdmi_audio_info_setup(struct hdmi *hdmi, bool enabled,\n\tuint32_t num_of_channels, uint32_t channel_allocation,\n\tuint32_t level_shift, bool down_mix)\n{\n\tstruct hdmi_audio *audio;\n\n\tif (!hdmi)\n\t\treturn -ENXIO;\n\n\taudio = &hdmi->audio;\n\n\tif (num_of_channels >= ARRAY_SIZE(nchannels))\n\t\treturn -EINVAL;\n\n\taudio->enabled = enabled;\n\taudio->infoframe.channels = nchannels[num_of_channels];\n\taudio->infoframe.channel_allocation = channel_allocation;\n\taudio->infoframe.level_shift_value = level_shift;\n\taudio->infoframe.downmix_inhibit = down_mix;\n\n\treturn msm_hdmi_audio_update(hdmi);\n}\n\nvoid msm_hdmi_audio_set_sample_rate(struct hdmi *hdmi, int rate)\n{\n\tstruct hdmi_audio *audio;\n\n\tif (!hdmi)\n\t\treturn;\n\n\taudio = &hdmi->audio;\n\n\tif ((rate < 0) || (rate >= MSM_HDMI_SAMPLE_RATE_MAX))\n\t\treturn;\n\n\taudio->rate = rate;\n\tmsm_hdmi_audio_update(hdmi);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}