{
  "module_name": "dpu_encoder_phys_cmd.c",
  "hash_id": "25c809c90c907d1cb22766d75ee61fb074a6d299c47aad5e38985db21ed08139",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/msm/disp/dpu1/dpu_encoder_phys_cmd.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt)\t\"[drm:%s:%d] \" fmt, __func__, __LINE__\n#include <linux/delay.h>\n#include \"dpu_encoder_phys.h\"\n#include \"dpu_hw_interrupts.h\"\n#include \"dpu_hw_pingpong.h\"\n#include \"dpu_core_irq.h\"\n#include \"dpu_formats.h\"\n#include \"dpu_trace.h\"\n#include \"disp/msm_disp_snapshot.h\"\n\n#define DPU_DEBUG_CMDENC(e, fmt, ...) DPU_DEBUG(\"enc%d intf%d \" fmt, \\\n\t\t(e) && (e)->base.parent ? \\\n\t\t(e)->base.parent->base.id : -1, \\\n\t\t(e) ? (e)->base.hw_intf->idx - INTF_0 : -1, ##__VA_ARGS__)\n\n#define DPU_ERROR_CMDENC(e, fmt, ...) DPU_ERROR(\"enc%d intf%d \" fmt, \\\n\t\t(e) && (e)->base.parent ? \\\n\t\t(e)->base.parent->base.id : -1, \\\n\t\t(e) ? (e)->base.hw_intf->idx - INTF_0 : -1, ##__VA_ARGS__)\n\n#define to_dpu_encoder_phys_cmd(x) \\\n\tcontainer_of(x, struct dpu_encoder_phys_cmd, base)\n\n#define PP_TIMEOUT_MAX_TRIALS\t10\n\n \n#define DEFAULT_TEARCHECK_SYNC_THRESH_START\t4\n#define DEFAULT_TEARCHECK_SYNC_THRESH_CONTINUE\t4\n\nstatic void dpu_encoder_phys_cmd_enable_te(struct dpu_encoder_phys *phys_enc);\n\nstatic bool dpu_encoder_phys_cmd_is_master(struct dpu_encoder_phys *phys_enc)\n{\n\treturn (phys_enc->split_role != ENC_ROLE_SLAVE);\n}\n\nstatic void _dpu_encoder_phys_cmd_update_intf_cfg(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\tstruct dpu_hw_ctl *ctl;\n\tstruct dpu_hw_intf_cfg intf_cfg = { 0 };\n\tstruct dpu_hw_intf_cmd_mode_cfg cmd_mode_cfg = {};\n\n\tctl = phys_enc->hw_ctl;\n\tif (!ctl->ops.setup_intf_cfg)\n\t\treturn;\n\n\tintf_cfg.intf = phys_enc->hw_intf->idx;\n\tintf_cfg.intf_mode_sel = DPU_CTL_MODE_SEL_CMD;\n\tintf_cfg.stream_sel = cmd_enc->stream_sel;\n\tintf_cfg.mode_3d = dpu_encoder_helper_get_3d_blend_mode(phys_enc);\n\tintf_cfg.dsc = dpu_encoder_helper_get_dsc(phys_enc);\n\tctl->ops.setup_intf_cfg(ctl, &intf_cfg);\n\n\t \n\tif (test_bit(DPU_CTL_ACTIVE_CFG, &ctl->caps->features) && phys_enc->hw_intf->ops.bind_pingpong_blk)\n\t\tphys_enc->hw_intf->ops.bind_pingpong_blk(\n\t\t\t\tphys_enc->hw_intf,\n\t\t\t\tphys_enc->hw_pp->idx);\n\n\tif (intf_cfg.dsc != 0)\n\t\tcmd_mode_cfg.data_compress = true;\n\n\tif (phys_enc->hw_intf->ops.program_intf_cmd_cfg)\n\t\tphys_enc->hw_intf->ops.program_intf_cmd_cfg(phys_enc->hw_intf, &cmd_mode_cfg);\n}\n\nstatic void dpu_encoder_phys_cmd_pp_tx_done_irq(void *arg, int irq_idx)\n{\n\tstruct dpu_encoder_phys *phys_enc = arg;\n\tunsigned long lock_flags;\n\tint new_cnt;\n\tu32 event = DPU_ENCODER_FRAME_EVENT_DONE;\n\n\tif (!phys_enc->hw_pp)\n\t\treturn;\n\n\tDPU_ATRACE_BEGIN(\"pp_done_irq\");\n\t \n\tdpu_encoder_frame_done_callback(phys_enc->parent, phys_enc, event);\n\n\tspin_lock_irqsave(phys_enc->enc_spinlock, lock_flags);\n\tnew_cnt = atomic_add_unless(&phys_enc->pending_kickoff_cnt, -1, 0);\n\tspin_unlock_irqrestore(phys_enc->enc_spinlock, lock_flags);\n\n\ttrace_dpu_enc_phys_cmd_pp_tx_done(DRMID(phys_enc->parent),\n\t\t\t\t\t  phys_enc->hw_pp->idx - PINGPONG_0,\n\t\t\t\t\t  new_cnt, event);\n\n\t \n\twake_up_all(&phys_enc->pending_kickoff_wq);\n\tDPU_ATRACE_END(\"pp_done_irq\");\n}\n\nstatic void dpu_encoder_phys_cmd_te_rd_ptr_irq(void *arg, int irq_idx)\n{\n\tstruct dpu_encoder_phys *phys_enc = arg;\n\tstruct dpu_encoder_phys_cmd *cmd_enc;\n\n\tif (phys_enc->has_intf_te) {\n\t\tif (!phys_enc->hw_intf)\n\t\t\treturn;\n\t} else {\n\t\tif (!phys_enc->hw_pp)\n\t\t\treturn;\n\t}\n\n\tDPU_ATRACE_BEGIN(\"rd_ptr_irq\");\n\tcmd_enc = to_dpu_encoder_phys_cmd(phys_enc);\n\n\tdpu_encoder_vblank_callback(phys_enc->parent, phys_enc);\n\n\tatomic_add_unless(&cmd_enc->pending_vblank_cnt, -1, 0);\n\twake_up_all(&cmd_enc->pending_vblank_wq);\n\tDPU_ATRACE_END(\"rd_ptr_irq\");\n}\n\nstatic void dpu_encoder_phys_cmd_ctl_start_irq(void *arg, int irq_idx)\n{\n\tstruct dpu_encoder_phys *phys_enc = arg;\n\n\tDPU_ATRACE_BEGIN(\"ctl_start_irq\");\n\n\tatomic_add_unless(&phys_enc->pending_ctlstart_cnt, -1, 0);\n\n\t \n\twake_up_all(&phys_enc->pending_kickoff_wq);\n\tDPU_ATRACE_END(\"ctl_start_irq\");\n}\n\nstatic void dpu_encoder_phys_cmd_underrun_irq(void *arg, int irq_idx)\n{\n\tstruct dpu_encoder_phys *phys_enc = arg;\n\n\tdpu_encoder_underrun_callback(phys_enc->parent, phys_enc);\n}\n\nstatic void dpu_encoder_phys_cmd_atomic_mode_set(\n\t\tstruct dpu_encoder_phys *phys_enc,\n\t\tstruct drm_crtc_state *crtc_state,\n\t\tstruct drm_connector_state *conn_state)\n{\n\tphys_enc->irq[INTR_IDX_CTL_START] = phys_enc->hw_ctl->caps->intr_start;\n\n\tphys_enc->irq[INTR_IDX_PINGPONG] = phys_enc->hw_pp->caps->intr_done;\n\n\tif (phys_enc->has_intf_te)\n\t\tphys_enc->irq[INTR_IDX_RDPTR] = phys_enc->hw_intf->cap->intr_tear_rd_ptr;\n\telse\n\t\tphys_enc->irq[INTR_IDX_RDPTR] = phys_enc->hw_pp->caps->intr_rdptr;\n\n\tphys_enc->irq[INTR_IDX_UNDERRUN] = phys_enc->hw_intf->cap->intr_underrun;\n}\n\nstatic int _dpu_encoder_phys_cmd_handle_ppdone_timeout(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\tu32 frame_event = DPU_ENCODER_FRAME_EVENT_ERROR;\n\tbool do_log = false;\n\tstruct drm_encoder *drm_enc;\n\n\tif (!phys_enc->hw_pp)\n\t\treturn -EINVAL;\n\n\tdrm_enc = phys_enc->parent;\n\n\tcmd_enc->pp_timeout_report_cnt++;\n\tif (cmd_enc->pp_timeout_report_cnt == PP_TIMEOUT_MAX_TRIALS) {\n\t\tframe_event |= DPU_ENCODER_FRAME_EVENT_PANEL_DEAD;\n\t\tdo_log = true;\n\t} else if (cmd_enc->pp_timeout_report_cnt == 1) {\n\t\tdo_log = true;\n\t}\n\n\ttrace_dpu_enc_phys_cmd_pdone_timeout(DRMID(drm_enc),\n\t\t     phys_enc->hw_pp->idx - PINGPONG_0,\n\t\t     cmd_enc->pp_timeout_report_cnt,\n\t\t     atomic_read(&phys_enc->pending_kickoff_cnt),\n\t\t     frame_event);\n\n\t \n\tif (do_log) {\n\t\tDRM_ERROR(\"id:%d pp:%d kickoff timeout %d cnt %d koff_cnt %d\\n\",\n\t\t\t  DRMID(drm_enc),\n\t\t\t  phys_enc->hw_pp->idx - PINGPONG_0,\n\t\t\t  phys_enc->hw_ctl->idx - CTL_0,\n\t\t\t  cmd_enc->pp_timeout_report_cnt,\n\t\t\t  atomic_read(&phys_enc->pending_kickoff_cnt));\n\t\tmsm_disp_snapshot_state(drm_enc->dev);\n\t\tdpu_core_irq_unregister_callback(phys_enc->dpu_kms,\n\t\t\t\tphys_enc->irq[INTR_IDX_RDPTR]);\n\t}\n\n\tatomic_add_unless(&phys_enc->pending_kickoff_cnt, -1, 0);\n\n\t \n\tphys_enc->enable_state = DPU_ENC_ERR_NEEDS_HW_RESET;\n\n\tdpu_encoder_frame_done_callback(phys_enc->parent, phys_enc, frame_event);\n\n\treturn -ETIMEDOUT;\n}\n\nstatic int _dpu_encoder_phys_cmd_wait_for_idle(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\tstruct dpu_encoder_wait_info wait_info;\n\tint ret;\n\n\twait_info.wq = &phys_enc->pending_kickoff_wq;\n\twait_info.atomic_cnt = &phys_enc->pending_kickoff_cnt;\n\twait_info.timeout_ms = KICKOFF_TIMEOUT_MS;\n\n\tret = dpu_encoder_helper_wait_for_irq(phys_enc,\n\t\t\tphys_enc->irq[INTR_IDX_PINGPONG],\n\t\t\tdpu_encoder_phys_cmd_pp_tx_done_irq,\n\t\t\t&wait_info);\n\tif (ret == -ETIMEDOUT)\n\t\t_dpu_encoder_phys_cmd_handle_ppdone_timeout(phys_enc);\n\telse if (!ret)\n\t\tcmd_enc->pp_timeout_report_cnt = 0;\n\n\treturn ret;\n}\n\nstatic int dpu_encoder_phys_cmd_control_vblank_irq(\n\t\tstruct dpu_encoder_phys *phys_enc,\n\t\tbool enable)\n{\n\tint ret = 0;\n\tint refcount;\n\n\tif (!phys_enc->hw_pp) {\n\t\tDPU_ERROR(\"invalid encoder\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\trefcount = atomic_read(&phys_enc->vblank_refcount);\n\n\t \n\tif (!dpu_encoder_phys_cmd_is_master(phys_enc))\n\t\tgoto end;\n\n\t \n\tif (!enable && refcount == 0) {\n\t\tret = -EINVAL;\n\t\tgoto end;\n\t}\n\n\tDRM_DEBUG_KMS(\"id:%u pp:%d enable=%s/%d\\n\", DRMID(phys_enc->parent),\n\t\t      phys_enc->hw_pp->idx - PINGPONG_0,\n\t\t      enable ? \"true\" : \"false\", refcount);\n\n\tif (enable && atomic_inc_return(&phys_enc->vblank_refcount) == 1)\n\t\tret = dpu_core_irq_register_callback(phys_enc->dpu_kms,\n\t\t\t\tphys_enc->irq[INTR_IDX_RDPTR],\n\t\t\t\tdpu_encoder_phys_cmd_te_rd_ptr_irq,\n\t\t\t\tphys_enc);\n\telse if (!enable && atomic_dec_return(&phys_enc->vblank_refcount) == 0)\n\t\tret = dpu_core_irq_unregister_callback(phys_enc->dpu_kms,\n\t\t\t\tphys_enc->irq[INTR_IDX_RDPTR]);\n\nend:\n\tif (ret) {\n\t\tDRM_ERROR(\"vblank irq err id:%u pp:%d ret:%d, enable %s/%d\\n\",\n\t\t\t  DRMID(phys_enc->parent),\n\t\t\t  phys_enc->hw_pp->idx - PINGPONG_0, ret,\n\t\t\t  enable ? \"true\" : \"false\", refcount);\n\t}\n\n\treturn ret;\n}\n\nstatic void dpu_encoder_phys_cmd_irq_control(struct dpu_encoder_phys *phys_enc,\n\t\tbool enable)\n{\n\ttrace_dpu_enc_phys_cmd_irq_ctrl(DRMID(phys_enc->parent),\n\t\t\tphys_enc->hw_pp->idx - PINGPONG_0,\n\t\t\tenable, atomic_read(&phys_enc->vblank_refcount));\n\n\tif (enable) {\n\t\tdpu_core_irq_register_callback(phys_enc->dpu_kms,\n\t\t\t\tphys_enc->irq[INTR_IDX_PINGPONG],\n\t\t\t\tdpu_encoder_phys_cmd_pp_tx_done_irq,\n\t\t\t\tphys_enc);\n\t\tdpu_core_irq_register_callback(phys_enc->dpu_kms,\n\t\t\t\tphys_enc->irq[INTR_IDX_UNDERRUN],\n\t\t\t\tdpu_encoder_phys_cmd_underrun_irq,\n\t\t\t\tphys_enc);\n\t\tdpu_encoder_phys_cmd_control_vblank_irq(phys_enc, true);\n\n\t\tif (dpu_encoder_phys_cmd_is_master(phys_enc))\n\t\t\tdpu_core_irq_register_callback(phys_enc->dpu_kms,\n\t\t\t\t\tphys_enc->irq[INTR_IDX_CTL_START],\n\t\t\t\t\tdpu_encoder_phys_cmd_ctl_start_irq,\n\t\t\t\t\tphys_enc);\n\t} else {\n\t\tif (dpu_encoder_phys_cmd_is_master(phys_enc))\n\t\t\tdpu_core_irq_unregister_callback(phys_enc->dpu_kms,\n\t\t\t\t\tphys_enc->irq[INTR_IDX_CTL_START]);\n\n\t\tdpu_core_irq_unregister_callback(phys_enc->dpu_kms,\n\t\t\t\tphys_enc->irq[INTR_IDX_UNDERRUN]);\n\t\tdpu_encoder_phys_cmd_control_vblank_irq(phys_enc, false);\n\t\tdpu_core_irq_unregister_callback(phys_enc->dpu_kms,\n\t\t\t\tphys_enc->irq[INTR_IDX_PINGPONG]);\n\t}\n}\n\nstatic void dpu_encoder_phys_cmd_tearcheck_config(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\tstruct dpu_hw_tear_check tc_cfg = { 0 };\n\tstruct drm_display_mode *mode;\n\tbool tc_enable = true;\n\tunsigned long vsync_hz;\n\tstruct dpu_kms *dpu_kms;\n\n\tif (phys_enc->has_intf_te) {\n\t\tif (!phys_enc->hw_intf ||\n\t\t    !phys_enc->hw_intf->ops.enable_tearcheck) {\n\t\t\tDPU_DEBUG_CMDENC(cmd_enc, \"tearcheck not supported\\n\");\n\t\t\treturn;\n\t\t}\n\n\t\tDPU_DEBUG_CMDENC(cmd_enc, \"\");\n\t} else {\n\t\tif (!phys_enc->hw_pp ||\n\t\t    !phys_enc->hw_pp->ops.enable_tearcheck) {\n\t\t\tDPU_DEBUG_CMDENC(cmd_enc, \"tearcheck not supported\\n\");\n\t\t\treturn;\n\t\t}\n\n\t\tDPU_DEBUG_CMDENC(cmd_enc, \"pp %d\\n\", phys_enc->hw_pp->idx - PINGPONG_0);\n\t}\n\n\tmode = &phys_enc->cached_mode;\n\n\tdpu_kms = phys_enc->dpu_kms;\n\n\t \n\tvsync_hz = dpu_kms_get_clk_rate(dpu_kms, \"vsync\");\n\tif (!vsync_hz) {\n\t\tDPU_DEBUG_CMDENC(cmd_enc, \"invalid - no vsync clock\\n\");\n\t\treturn;\n\t}\n\n\ttc_cfg.vsync_count = vsync_hz /\n\t\t\t\t(mode->vtotal * drm_mode_vrefresh(mode));\n\n\t \n\ttc_cfg.hw_vsync_mode = 1;\n\ttc_cfg.sync_cfg_height = mode->vtotal * 2;\n\ttc_cfg.vsync_init_val = mode->vdisplay;\n\ttc_cfg.sync_threshold_start = DEFAULT_TEARCHECK_SYNC_THRESH_START;\n\ttc_cfg.sync_threshold_continue = DEFAULT_TEARCHECK_SYNC_THRESH_CONTINUE;\n\ttc_cfg.start_pos = mode->vdisplay;\n\ttc_cfg.rd_ptr_irq = mode->vdisplay + 1;\n\n\tDPU_DEBUG_CMDENC(cmd_enc,\n\t\t\"tc vsync_clk_speed_hz %lu vtotal %u vrefresh %u\\n\",\n\t\tvsync_hz, mode->vtotal, drm_mode_vrefresh(mode));\n\tDPU_DEBUG_CMDENC(cmd_enc,\n\t\t\"tc enable %u start_pos %u rd_ptr_irq %u\\n\",\n\t\ttc_enable, tc_cfg.start_pos, tc_cfg.rd_ptr_irq);\n\tDPU_DEBUG_CMDENC(cmd_enc,\n\t\t\"tc hw_vsync_mode %u vsync_count %u vsync_init_val %u\\n\",\n\t\ttc_cfg.hw_vsync_mode, tc_cfg.vsync_count,\n\t\ttc_cfg.vsync_init_val);\n\tDPU_DEBUG_CMDENC(cmd_enc,\n\t\t\"tc cfgheight %u thresh_start %u thresh_cont %u\\n\",\n\t\ttc_cfg.sync_cfg_height, tc_cfg.sync_threshold_start,\n\t\ttc_cfg.sync_threshold_continue);\n\n\tif (phys_enc->has_intf_te)\n\t\tphys_enc->hw_intf->ops.enable_tearcheck(phys_enc->hw_intf, &tc_cfg);\n\telse\n\t\tphys_enc->hw_pp->ops.enable_tearcheck(phys_enc->hw_pp, &tc_cfg);\n}\n\nstatic void _dpu_encoder_phys_cmd_pingpong_config(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\n\tif (!phys_enc->hw_pp || !phys_enc->hw_ctl->ops.setup_intf_cfg) {\n\t\tDPU_ERROR(\"invalid arg(s), enc %d\\n\", phys_enc != NULL);\n\t\treturn;\n\t}\n\n\tDPU_DEBUG_CMDENC(cmd_enc, \"pp %d, enabling mode:\\n\",\n\t\t\tphys_enc->hw_pp->idx - PINGPONG_0);\n\tdrm_mode_debug_printmodeline(&phys_enc->cached_mode);\n\n\t_dpu_encoder_phys_cmd_update_intf_cfg(phys_enc);\n\tdpu_encoder_phys_cmd_tearcheck_config(phys_enc);\n}\n\nstatic bool dpu_encoder_phys_cmd_needs_single_flush(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\t \n\treturn false;\n}\n\nstatic void dpu_encoder_phys_cmd_enable_helper(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_hw_ctl *ctl;\n\n\tif (!phys_enc->hw_pp) {\n\t\tDPU_ERROR(\"invalid arg(s), encoder %d\\n\", phys_enc != NULL);\n\t\treturn;\n\t}\n\n\tdpu_encoder_helper_split_config(phys_enc, phys_enc->hw_intf->idx);\n\n\t_dpu_encoder_phys_cmd_pingpong_config(phys_enc);\n\n\tif (!dpu_encoder_phys_cmd_is_master(phys_enc))\n\t\treturn;\n\n\tctl = phys_enc->hw_ctl;\n\tctl->ops.update_pending_flush_intf(ctl, phys_enc->hw_intf->idx);\n}\n\nstatic void dpu_encoder_phys_cmd_enable(struct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\n\tif (!phys_enc->hw_pp) {\n\t\tDPU_ERROR(\"invalid phys encoder\\n\");\n\t\treturn;\n\t}\n\n\tDPU_DEBUG_CMDENC(cmd_enc, \"pp %d\\n\", phys_enc->hw_pp->idx - PINGPONG_0);\n\n\tif (phys_enc->enable_state == DPU_ENC_ENABLED) {\n\t\tDPU_ERROR(\"already enabled\\n\");\n\t\treturn;\n\t}\n\n\tdpu_encoder_phys_cmd_enable_helper(phys_enc);\n\tphys_enc->enable_state = DPU_ENC_ENABLED;\n}\n\nstatic void _dpu_encoder_phys_cmd_connect_te(\n\t\tstruct dpu_encoder_phys *phys_enc, bool enable)\n{\n\tif (phys_enc->has_intf_te) {\n\t\tif (!phys_enc->hw_intf || !phys_enc->hw_intf->ops.connect_external_te)\n\t\t\treturn;\n\n\t\ttrace_dpu_enc_phys_cmd_connect_te(DRMID(phys_enc->parent), enable);\n\t\tphys_enc->hw_intf->ops.connect_external_te(phys_enc->hw_intf, enable);\n\t} else {\n\t\tif (!phys_enc->hw_pp || !phys_enc->hw_pp->ops.connect_external_te)\n\t\t\treturn;\n\n\t\ttrace_dpu_enc_phys_cmd_connect_te(DRMID(phys_enc->parent), enable);\n\t\tphys_enc->hw_pp->ops.connect_external_te(phys_enc->hw_pp, enable);\n\t}\n}\n\nstatic void dpu_encoder_phys_cmd_prepare_idle_pc(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\t_dpu_encoder_phys_cmd_connect_te(phys_enc, false);\n}\n\nstatic int dpu_encoder_phys_cmd_get_line_count(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_hw_pingpong *hw_pp;\n\tstruct dpu_hw_intf *hw_intf;\n\n\tif (!dpu_encoder_phys_cmd_is_master(phys_enc))\n\t\treturn -EINVAL;\n\n\tif (phys_enc->has_intf_te) {\n\t\thw_intf = phys_enc->hw_intf;\n\t\tif (!hw_intf || !hw_intf->ops.get_line_count)\n\t\t\treturn -EINVAL;\n\t\treturn hw_intf->ops.get_line_count(hw_intf);\n\t}\n\n\thw_pp = phys_enc->hw_pp;\n\tif (!hw_pp || !hw_pp->ops.get_line_count)\n\t\treturn -EINVAL;\n\treturn hw_pp->ops.get_line_count(hw_pp);\n}\n\nstatic void dpu_encoder_phys_cmd_disable(struct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\tstruct dpu_hw_ctl *ctl;\n\n\tif (phys_enc->enable_state == DPU_ENC_DISABLED) {\n\t\tDPU_ERROR_CMDENC(cmd_enc, \"already disabled\\n\");\n\t\treturn;\n\t}\n\n\tif (phys_enc->has_intf_te) {\n\t\tDRM_DEBUG_KMS(\"id:%u intf:%d state:%d\\n\", DRMID(phys_enc->parent),\n\t\t\t      phys_enc->hw_intf->idx - INTF_0,\n\t\t\t      phys_enc->enable_state);\n\n\t\tif (phys_enc->hw_intf->ops.disable_tearcheck)\n\t\t\tphys_enc->hw_intf->ops.disable_tearcheck(phys_enc->hw_intf);\n\t} else {\n\t\tif (!phys_enc->hw_pp) {\n\t\t\tDPU_ERROR(\"invalid encoder\\n\");\n\t\t\treturn;\n\t\t}\n\n\t\tDRM_DEBUG_KMS(\"id:%u pp:%d state:%d\\n\", DRMID(phys_enc->parent),\n\t\t\t      phys_enc->hw_pp->idx - PINGPONG_0,\n\t\t\t      phys_enc->enable_state);\n\n\t\tif (phys_enc->hw_pp->ops.disable_tearcheck)\n\t\t\tphys_enc->hw_pp->ops.disable_tearcheck(phys_enc->hw_pp);\n\t}\n\n\tif (phys_enc->hw_intf->ops.bind_pingpong_blk) {\n\t\tphys_enc->hw_intf->ops.bind_pingpong_blk(\n\t\t\t\tphys_enc->hw_intf,\n\t\t\t\tPINGPONG_NONE);\n\n\t\tctl = phys_enc->hw_ctl;\n\t\tctl->ops.update_pending_flush_intf(ctl, phys_enc->hw_intf->idx);\n\t}\n\n\tphys_enc->enable_state = DPU_ENC_DISABLED;\n}\n\nstatic void dpu_encoder_phys_cmd_destroy(struct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\n\tkfree(cmd_enc);\n}\n\nstatic void dpu_encoder_phys_cmd_prepare_for_kickoff(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\tint ret;\n\n\tif (!phys_enc->hw_pp) {\n\t\tDPU_ERROR(\"invalid encoder\\n\");\n\t\treturn;\n\t}\n\tDRM_DEBUG_KMS(\"id:%u pp:%d pending_cnt:%d\\n\", DRMID(phys_enc->parent),\n\t\t      phys_enc->hw_pp->idx - PINGPONG_0,\n\t\t      atomic_read(&phys_enc->pending_kickoff_cnt));\n\n\t \n\tret = _dpu_encoder_phys_cmd_wait_for_idle(phys_enc);\n\tif (ret) {\n\t\t \n\t\tatomic_set(&phys_enc->pending_kickoff_cnt, 0);\n\t\tDRM_ERROR(\"failed wait_for_idle: id:%u ret:%d pp:%d\\n\",\n\t\t\t  DRMID(phys_enc->parent), ret,\n\t\t\t  phys_enc->hw_pp->idx - PINGPONG_0);\n\t}\n\n\tdpu_encoder_phys_cmd_enable_te(phys_enc);\n\n\tDPU_DEBUG_CMDENC(cmd_enc, \"pp:%d pending_cnt %d\\n\",\n\t\t\tphys_enc->hw_pp->idx - PINGPONG_0,\n\t\t\tatomic_read(&phys_enc->pending_kickoff_cnt));\n}\n\nstatic void dpu_encoder_phys_cmd_enable_te(struct dpu_encoder_phys *phys_enc)\n{\n\tif (!phys_enc)\n\t\treturn;\n\tif (!dpu_encoder_phys_cmd_is_master(phys_enc))\n\t\treturn;\n\n\tif (phys_enc->has_intf_te) {\n\t\tif (!phys_enc->hw_intf->ops.disable_autorefresh)\n\t\t\treturn;\n\n\t\tphys_enc->hw_intf->ops.disable_autorefresh(\n\t\t\t\tphys_enc->hw_intf,\n\t\t\t\tDRMID(phys_enc->parent),\n\t\t\t\tphys_enc->cached_mode.vdisplay);\n\t} else {\n\t\tif (!phys_enc->hw_pp ||\n\t\t    !phys_enc->hw_pp->ops.disable_autorefresh)\n\t\t\treturn;\n\n\t\tphys_enc->hw_pp->ops.disable_autorefresh(\n\t\t\t\tphys_enc->hw_pp,\n\t\t\t\tDRMID(phys_enc->parent),\n\t\t\t\tphys_enc->cached_mode.vdisplay);\n\t}\n}\n\nstatic int _dpu_encoder_phys_cmd_wait_for_ctl_start(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tstruct dpu_encoder_phys_cmd *cmd_enc =\n\t\t\tto_dpu_encoder_phys_cmd(phys_enc);\n\tstruct dpu_encoder_wait_info wait_info;\n\tint ret;\n\n\twait_info.wq = &phys_enc->pending_kickoff_wq;\n\twait_info.atomic_cnt = &phys_enc->pending_ctlstart_cnt;\n\twait_info.timeout_ms = KICKOFF_TIMEOUT_MS;\n\n\tret = dpu_encoder_helper_wait_for_irq(phys_enc,\n\t\t\tphys_enc->irq[INTR_IDX_CTL_START],\n\t\t\tdpu_encoder_phys_cmd_ctl_start_irq,\n\t\t\t&wait_info);\n\tif (ret == -ETIMEDOUT) {\n\t\tDPU_ERROR_CMDENC(cmd_enc, \"ctl start interrupt wait failed\\n\");\n\t\tret = -EINVAL;\n\t} else if (!ret)\n\t\tret = 0;\n\n\treturn ret;\n}\n\nstatic int dpu_encoder_phys_cmd_wait_for_tx_complete(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tint rc;\n\n\trc = _dpu_encoder_phys_cmd_wait_for_idle(phys_enc);\n\tif (rc) {\n\t\tDRM_ERROR(\"failed wait_for_idle: id:%u ret:%d intf:%d\\n\",\n\t\t\t  DRMID(phys_enc->parent), rc,\n\t\t\t  phys_enc->hw_intf->idx - INTF_0);\n\t}\n\n\treturn rc;\n}\n\nstatic int dpu_encoder_phys_cmd_wait_for_commit_done(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\t \n\tif (!dpu_encoder_phys_cmd_is_master(phys_enc))\n\t\treturn 0;\n\n\tif (phys_enc->hw_ctl->ops.is_started(phys_enc->hw_ctl))\n\t\treturn dpu_encoder_phys_cmd_wait_for_tx_complete(phys_enc);\n\n\treturn _dpu_encoder_phys_cmd_wait_for_ctl_start(phys_enc);\n}\n\nstatic int dpu_encoder_phys_cmd_wait_for_vblank(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tint rc = 0;\n\tstruct dpu_encoder_phys_cmd *cmd_enc;\n\tstruct dpu_encoder_wait_info wait_info;\n\n\tcmd_enc = to_dpu_encoder_phys_cmd(phys_enc);\n\n\t \n\tif (!dpu_encoder_phys_cmd_is_master(phys_enc))\n\t\treturn rc;\n\n\twait_info.wq = &cmd_enc->pending_vblank_wq;\n\twait_info.atomic_cnt = &cmd_enc->pending_vblank_cnt;\n\twait_info.timeout_ms = KICKOFF_TIMEOUT_MS;\n\n\tatomic_inc(&cmd_enc->pending_vblank_cnt);\n\n\trc = dpu_encoder_helper_wait_for_irq(phys_enc,\n\t\t\tphys_enc->irq[INTR_IDX_RDPTR],\n\t\t\tdpu_encoder_phys_cmd_te_rd_ptr_irq,\n\t\t\t&wait_info);\n\n\treturn rc;\n}\n\nstatic void dpu_encoder_phys_cmd_handle_post_kickoff(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\t \n\t_dpu_encoder_phys_cmd_connect_te(phys_enc, true);\n}\n\nstatic void dpu_encoder_phys_cmd_trigger_start(\n\t\tstruct dpu_encoder_phys *phys_enc)\n{\n\tdpu_encoder_helper_trigger_start(phys_enc);\n}\n\nstatic void dpu_encoder_phys_cmd_init_ops(\n\t\tstruct dpu_encoder_phys_ops *ops)\n{\n\tops->is_master = dpu_encoder_phys_cmd_is_master;\n\tops->atomic_mode_set = dpu_encoder_phys_cmd_atomic_mode_set;\n\tops->enable = dpu_encoder_phys_cmd_enable;\n\tops->disable = dpu_encoder_phys_cmd_disable;\n\tops->destroy = dpu_encoder_phys_cmd_destroy;\n\tops->control_vblank_irq = dpu_encoder_phys_cmd_control_vblank_irq;\n\tops->wait_for_commit_done = dpu_encoder_phys_cmd_wait_for_commit_done;\n\tops->prepare_for_kickoff = dpu_encoder_phys_cmd_prepare_for_kickoff;\n\tops->wait_for_tx_complete = dpu_encoder_phys_cmd_wait_for_tx_complete;\n\tops->wait_for_vblank = dpu_encoder_phys_cmd_wait_for_vblank;\n\tops->trigger_start = dpu_encoder_phys_cmd_trigger_start;\n\tops->needs_single_flush = dpu_encoder_phys_cmd_needs_single_flush;\n\tops->irq_control = dpu_encoder_phys_cmd_irq_control;\n\tops->restore = dpu_encoder_phys_cmd_enable_helper;\n\tops->prepare_idle_pc = dpu_encoder_phys_cmd_prepare_idle_pc;\n\tops->handle_post_kickoff = dpu_encoder_phys_cmd_handle_post_kickoff;\n\tops->get_line_count = dpu_encoder_phys_cmd_get_line_count;\n}\n\nstruct dpu_encoder_phys *dpu_encoder_phys_cmd_init(\n\t\tstruct dpu_enc_phys_init_params *p)\n{\n\tstruct dpu_encoder_phys *phys_enc = NULL;\n\tstruct dpu_encoder_phys_cmd *cmd_enc = NULL;\n\n\tDPU_DEBUG(\"intf\\n\");\n\n\tcmd_enc = kzalloc(sizeof(*cmd_enc), GFP_KERNEL);\n\tif (!cmd_enc) {\n\t\tDPU_ERROR(\"failed to allocate\\n\");\n\t\treturn ERR_PTR(-ENOMEM);\n\t}\n\tphys_enc = &cmd_enc->base;\n\n\tdpu_encoder_phys_init(phys_enc, p);\n\n\tdpu_encoder_phys_cmd_init_ops(&phys_enc->ops);\n\tphys_enc->intf_mode = INTF_MODE_CMD;\n\tcmd_enc->stream_sel = 0;\n\n\tphys_enc->has_intf_te = test_bit(DPU_INTF_TE,\n\t\t\t\t\t &phys_enc->hw_intf->cap->features);\n\n\tatomic_set(&cmd_enc->pending_vblank_cnt, 0);\n\tinit_waitqueue_head(&cmd_enc->pending_vblank_wq);\n\n\tDPU_DEBUG_CMDENC(cmd_enc, \"created\\n\");\n\n\treturn phys_enc;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}