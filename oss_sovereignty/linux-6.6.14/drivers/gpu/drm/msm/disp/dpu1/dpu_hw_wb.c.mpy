{
  "module_name": "dpu_hw_wb.c",
  "hash_id": "735b0e142b12edf6a10c2a3abe4f870fe184749f967c0656cc8a4be528ff9cab",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/msm/disp/dpu1/dpu_hw_wb.c",
  "human_readable_source": "\n  \n\n#include \"dpu_hw_mdss.h\"\n#include \"dpu_hwio.h\"\n#include \"dpu_hw_catalog.h\"\n#include \"dpu_hw_wb.h\"\n#include \"dpu_formats.h\"\n#include \"dpu_kms.h\"\n\n#define WB_DST_FORMAT                         0x000\n#define WB_DST_OP_MODE                        0x004\n#define WB_DST_PACK_PATTERN                   0x008\n#define WB_DST0_ADDR                          0x00C\n#define WB_DST1_ADDR                          0x010\n#define WB_DST2_ADDR                          0x014\n#define WB_DST3_ADDR                          0x018\n#define WB_DST_YSTRIDE0                       0x01C\n#define WB_DST_YSTRIDE1                       0x020\n#define WB_DST_YSTRIDE1                       0x020\n#define WB_DST_DITHER_BITDEPTH                0x024\n#define WB_DST_MATRIX_ROW0                    0x030\n#define WB_DST_MATRIX_ROW1                    0x034\n#define WB_DST_MATRIX_ROW2                    0x038\n#define WB_DST_MATRIX_ROW3                    0x03C\n#define WB_DST_WRITE_CONFIG                   0x048\n#define WB_ROTATION_DNSCALER                  0x050\n#define WB_ROTATOR_PIPE_DOWNSCALER            0x054\n#define WB_N16_INIT_PHASE_X_C03               0x060\n#define WB_N16_INIT_PHASE_X_C12               0x064\n#define WB_N16_INIT_PHASE_Y_C03               0x068\n#define WB_N16_INIT_PHASE_Y_C12               0x06C\n#define WB_OUT_SIZE                           0x074\n#define WB_ALPHA_X_VALUE                      0x078\n#define WB_DANGER_LUT                         0x084\n#define WB_SAFE_LUT                           0x088\n#define WB_QOS_CTRL                           0x090\n#define WB_CREQ_LUT_0                         0x098\n#define WB_CREQ_LUT_1                         0x09C\n#define WB_UBWC_STATIC_CTRL                   0x144\n#define WB_MUX                                0x150\n#define WB_CROP_CTRL                          0x154\n#define WB_CROP_OFFSET                        0x158\n#define WB_CSC_BASE                           0x260\n#define WB_DST_ADDR_SW_STATUS                 0x2B0\n#define WB_CDP_CNTL                           0x2B4\n#define WB_OUT_IMAGE_SIZE                     0x2C0\n#define WB_OUT_XY                             0x2C4\n\nstatic void dpu_hw_wb_setup_outaddress(struct dpu_hw_wb *ctx,\n\t\tstruct dpu_hw_wb_cfg *data)\n{\n\tstruct dpu_hw_blk_reg_map *c = &ctx->hw;\n\n\tDPU_REG_WRITE(c, WB_DST0_ADDR, data->dest.plane_addr[0]);\n\tDPU_REG_WRITE(c, WB_DST1_ADDR, data->dest.plane_addr[1]);\n\tDPU_REG_WRITE(c, WB_DST2_ADDR, data->dest.plane_addr[2]);\n\tDPU_REG_WRITE(c, WB_DST3_ADDR, data->dest.plane_addr[3]);\n}\n\nstatic void dpu_hw_wb_setup_format(struct dpu_hw_wb *ctx,\n\t\tstruct dpu_hw_wb_cfg *data)\n{\n\tstruct dpu_hw_blk_reg_map *c = &ctx->hw;\n\tconst struct dpu_format *fmt = data->dest.format;\n\tu32 dst_format, pattern, ystride0, ystride1, outsize, chroma_samp;\n\tu32 write_config = 0;\n\tu32 opmode = 0;\n\tu32 dst_addr_sw = 0;\n\n\tchroma_samp = fmt->chroma_sample;\n\n\tdst_format = (chroma_samp << 23) |\n\t\t(fmt->fetch_planes << 19) |\n\t\t(fmt->bits[C3_ALPHA] << 6) |\n\t\t(fmt->bits[C2_R_Cr] << 4) |\n\t\t(fmt->bits[C1_B_Cb] << 2) |\n\t\t(fmt->bits[C0_G_Y] << 0);\n\n\tif (fmt->bits[C3_ALPHA] || fmt->alpha_enable) {\n\t\tdst_format |= BIT(8);  \n\t\tif (!fmt->alpha_enable ||\n\t\t\t!(ctx->caps->features & BIT(DPU_WB_PIPE_ALPHA)))\n\t\t\tdst_format |= BIT(14);  \n\t}\n\n\tpattern = (fmt->element[3] << 24) |\n\t\t(fmt->element[2] << 16) |\n\t\t(fmt->element[1] << 8)  |\n\t\t(fmt->element[0] << 0);\n\n\tdst_format |= (fmt->unpack_align_msb << 18) |\n\t\t(fmt->unpack_tight << 17) |\n\t\t((fmt->unpack_count - 1) << 12) |\n\t\t((fmt->bpp - 1) << 9);\n\n\tystride0 = data->dest.plane_pitch[0] |\n\t\t(data->dest.plane_pitch[1] << 16);\n\tystride1 = data->dest.plane_pitch[2] |\n\t(data->dest.plane_pitch[3] << 16);\n\n\tif (drm_rect_height(&data->roi) && drm_rect_width(&data->roi))\n\t\toutsize = (drm_rect_height(&data->roi) << 16) | drm_rect_width(&data->roi);\n\telse\n\t\toutsize = (data->dest.height << 16) | data->dest.width;\n\n\tDPU_REG_WRITE(c, WB_ALPHA_X_VALUE, 0xFF);\n\tDPU_REG_WRITE(c, WB_DST_FORMAT, dst_format);\n\tDPU_REG_WRITE(c, WB_DST_OP_MODE, opmode);\n\tDPU_REG_WRITE(c, WB_DST_PACK_PATTERN, pattern);\n\tDPU_REG_WRITE(c, WB_DST_YSTRIDE0, ystride0);\n\tDPU_REG_WRITE(c, WB_DST_YSTRIDE1, ystride1);\n\tDPU_REG_WRITE(c, WB_OUT_SIZE, outsize);\n\tDPU_REG_WRITE(c, WB_DST_WRITE_CONFIG, write_config);\n\tDPU_REG_WRITE(c, WB_DST_ADDR_SW_STATUS, dst_addr_sw);\n}\n\nstatic void dpu_hw_wb_roi(struct dpu_hw_wb *ctx, struct dpu_hw_wb_cfg *wb)\n{\n\tstruct dpu_hw_blk_reg_map *c = &ctx->hw;\n\tu32 image_size, out_size, out_xy;\n\n\timage_size = (wb->dest.height << 16) | wb->dest.width;\n\tout_xy = 0;\n\tout_size = (drm_rect_height(&wb->roi) << 16) | drm_rect_width(&wb->roi);\n\n\tDPU_REG_WRITE(c, WB_OUT_IMAGE_SIZE, image_size);\n\tDPU_REG_WRITE(c, WB_OUT_XY, out_xy);\n\tDPU_REG_WRITE(c, WB_OUT_SIZE, out_size);\n}\n\nstatic void dpu_hw_wb_setup_qos_lut(struct dpu_hw_wb *ctx,\n\t\tstruct dpu_hw_qos_cfg *cfg)\n{\n\tif (!ctx || !cfg)\n\t\treturn;\n\n\t_dpu_hw_setup_qos_lut(&ctx->hw, WB_DANGER_LUT,\n\t\t\t      test_bit(DPU_WB_QOS_8LVL, &ctx->caps->features),\n\t\t\t      cfg);\n}\n\nstatic void dpu_hw_wb_setup_cdp(struct dpu_hw_wb *ctx,\n\t\t\t\tconst struct dpu_format *fmt,\n\t\t\t\tbool enable)\n{\n\tif (!ctx)\n\t\treturn;\n\n\tdpu_setup_cdp(&ctx->hw, WB_CDP_CNTL, fmt, enable);\n}\n\nstatic void dpu_hw_wb_bind_pingpong_blk(\n\t\tstruct dpu_hw_wb *ctx,\n\t\tconst enum dpu_pingpong pp)\n{\n\tstruct dpu_hw_blk_reg_map *c;\n\tint mux_cfg;\n\n\tif (!ctx)\n\t\treturn;\n\n\tc = &ctx->hw;\n\n\tmux_cfg = DPU_REG_READ(c, WB_MUX);\n\tmux_cfg &= ~0xf;\n\n\tif (pp)\n\t\tmux_cfg |= (pp - PINGPONG_0) & 0x7;\n\telse\n\t\tmux_cfg |= 0xf;\n\n\tDPU_REG_WRITE(c, WB_MUX, mux_cfg);\n}\n\nstatic void _setup_wb_ops(struct dpu_hw_wb_ops *ops,\n\t\tunsigned long features)\n{\n\tops->setup_outaddress = dpu_hw_wb_setup_outaddress;\n\tops->setup_outformat = dpu_hw_wb_setup_format;\n\n\tif (test_bit(DPU_WB_XY_ROI_OFFSET, &features))\n\t\tops->setup_roi = dpu_hw_wb_roi;\n\n\tif (test_bit(DPU_WB_QOS, &features))\n\t\tops->setup_qos_lut = dpu_hw_wb_setup_qos_lut;\n\n\tif (test_bit(DPU_WB_CDP, &features))\n\t\tops->setup_cdp = dpu_hw_wb_setup_cdp;\n\n\tif (test_bit(DPU_WB_INPUT_CTRL, &features))\n\t\tops->bind_pingpong_blk = dpu_hw_wb_bind_pingpong_blk;\n}\n\nstruct dpu_hw_wb *dpu_hw_wb_init(const struct dpu_wb_cfg *cfg,\n\t\tvoid __iomem *addr)\n{\n\tstruct dpu_hw_wb *c;\n\n\tif (!addr)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tc = kzalloc(sizeof(*c), GFP_KERNEL);\n\tif (!c)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tc->hw.blk_addr = addr + cfg->base;\n\tc->hw.log_mask = DPU_DBG_MASK_WB;\n\n\t \n\tc->idx = cfg->id;\n\tc->caps = cfg;\n\t_setup_wb_ops(&c->ops, c->caps->features);\n\n\treturn c;\n}\n\nvoid dpu_hw_wb_destroy(struct dpu_hw_wb *hw_wb)\n{\n\tkfree(hw_wb);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}