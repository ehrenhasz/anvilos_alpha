{
  "module_name": "mdp4_lvds_pll.c",
  "hash_id": "2cb368226c958cf0402c3bccc42bd9c71b355aea4081a0e37a80a802a4da5408",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/msm/disp/mdp4/mdp4_lvds_pll.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n\n#include \"mdp4_kms.h\"\n\nstruct mdp4_lvds_pll {\n\tstruct clk_hw pll_hw;\n\tstruct drm_device *dev;\n\tunsigned long pixclk;\n};\n#define to_mdp4_lvds_pll(x) container_of(x, struct mdp4_lvds_pll, pll_hw)\n\nstatic struct mdp4_kms *get_kms(struct mdp4_lvds_pll *lvds_pll)\n{\n\tstruct msm_drm_private *priv = lvds_pll->dev->dev_private;\n\treturn to_mdp4_kms(to_mdp_kms(priv->kms));\n}\n\nstruct pll_rate {\n\tunsigned long rate;\n\tstruct {\n\t\tuint32_t val;\n\t\tuint32_t reg;\n\t} conf[32];\n};\n\n \nstatic const struct pll_rate freqtbl[] = {\n\t{ 72000000, {\n\t\t{ 0x8f, REG_MDP4_LVDS_PHY_PLL_CTRL_1 },\n\t\t{ 0x30, REG_MDP4_LVDS_PHY_PLL_CTRL_2 },\n\t\t{ 0xc6, REG_MDP4_LVDS_PHY_PLL_CTRL_3 },\n\t\t{ 0x10, REG_MDP4_LVDS_PHY_PLL_CTRL_5 },\n\t\t{ 0x07, REG_MDP4_LVDS_PHY_PLL_CTRL_6 },\n\t\t{ 0x62, REG_MDP4_LVDS_PHY_PLL_CTRL_7 },\n\t\t{ 0x41, REG_MDP4_LVDS_PHY_PLL_CTRL_8 },\n\t\t{ 0x0d, REG_MDP4_LVDS_PHY_PLL_CTRL_9 },\n\t\t{ 0, 0 } }\n\t},\n};\n\nstatic const struct pll_rate *find_rate(unsigned long rate)\n{\n\tint i;\n\tfor (i = 1; i < ARRAY_SIZE(freqtbl); i++)\n\t\tif (rate > freqtbl[i].rate)\n\t\t\treturn &freqtbl[i-1];\n\treturn &freqtbl[i-1];\n}\n\nstatic int mpd4_lvds_pll_enable(struct clk_hw *hw)\n{\n\tstruct mdp4_lvds_pll *lvds_pll = to_mdp4_lvds_pll(hw);\n\tstruct mdp4_kms *mdp4_kms = get_kms(lvds_pll);\n\tconst struct pll_rate *pll_rate = find_rate(lvds_pll->pixclk);\n\tint i;\n\n\tDBG(\"pixclk=%lu (%lu)\", lvds_pll->pixclk, pll_rate->rate);\n\n\tif (WARN_ON(!pll_rate))\n\t\treturn -EINVAL;\n\n\tmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_PHY_RESET, 0x33);\n\n\tfor (i = 0; pll_rate->conf[i].reg; i++)\n\t\tmdp4_write(mdp4_kms, pll_rate->conf[i].reg, pll_rate->conf[i].val);\n\n\tmdp4_write(mdp4_kms, REG_MDP4_LVDS_PHY_PLL_CTRL_0, 0x01);\n\n\t \n\twhile (!mdp4_read(mdp4_kms, REG_MDP4_LVDS_PHY_PLL_LOCKED))\n\t\tcpu_relax();\n\n\treturn 0;\n}\n\nstatic void mpd4_lvds_pll_disable(struct clk_hw *hw)\n{\n\tstruct mdp4_lvds_pll *lvds_pll = to_mdp4_lvds_pll(hw);\n\tstruct mdp4_kms *mdp4_kms = get_kms(lvds_pll);\n\n\tDBG(\"\");\n\n\tmdp4_write(mdp4_kms, REG_MDP4_LVDS_PHY_CFG0, 0x0);\n\tmdp4_write(mdp4_kms, REG_MDP4_LVDS_PHY_PLL_CTRL_0, 0x0);\n}\n\nstatic unsigned long mpd4_lvds_pll_recalc_rate(struct clk_hw *hw,\n\t\t\t\tunsigned long parent_rate)\n{\n\tstruct mdp4_lvds_pll *lvds_pll = to_mdp4_lvds_pll(hw);\n\treturn lvds_pll->pixclk;\n}\n\nstatic long mpd4_lvds_pll_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\tunsigned long *parent_rate)\n{\n\tconst struct pll_rate *pll_rate = find_rate(rate);\n\treturn pll_rate->rate;\n}\n\nstatic int mpd4_lvds_pll_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\tunsigned long parent_rate)\n{\n\tstruct mdp4_lvds_pll *lvds_pll = to_mdp4_lvds_pll(hw);\n\tlvds_pll->pixclk = rate;\n\treturn 0;\n}\n\n\nstatic const struct clk_ops mpd4_lvds_pll_ops = {\n\t.enable = mpd4_lvds_pll_enable,\n\t.disable = mpd4_lvds_pll_disable,\n\t.recalc_rate = mpd4_lvds_pll_recalc_rate,\n\t.round_rate = mpd4_lvds_pll_round_rate,\n\t.set_rate = mpd4_lvds_pll_set_rate,\n};\n\nstatic const char *mpd4_lvds_pll_parents[] = {\n\t\"pxo\",\n};\n\nstatic struct clk_init_data pll_init = {\n\t.name = \"mpd4_lvds_pll\",\n\t.ops = &mpd4_lvds_pll_ops,\n\t.parent_names = mpd4_lvds_pll_parents,\n\t.num_parents = ARRAY_SIZE(mpd4_lvds_pll_parents),\n};\n\nstruct clk *mpd4_lvds_pll_init(struct drm_device *dev)\n{\n\tstruct mdp4_lvds_pll *lvds_pll;\n\tstruct clk *clk;\n\tint ret;\n\n\tlvds_pll = devm_kzalloc(dev->dev, sizeof(*lvds_pll), GFP_KERNEL);\n\tif (!lvds_pll) {\n\t\tret = -ENOMEM;\n\t\tgoto fail;\n\t}\n\n\tlvds_pll->dev = dev;\n\n\tlvds_pll->pll_hw.init = &pll_init;\n\tclk = devm_clk_register(dev->dev, &lvds_pll->pll_hw);\n\tif (IS_ERR(clk)) {\n\t\tret = PTR_ERR(clk);\n\t\tgoto fail;\n\t}\n\n\treturn clk;\n\nfail:\n\treturn ERR_PTR(ret);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}