{
  "module_name": "mdp4_plane.c",
  "hash_id": "e58f2d24b85ef64a09b6cfb8d51bde7ea7ef601f896168f4714f4d603ab6aef9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/msm/disp/mdp4/mdp4_plane.c",
  "human_readable_source": "\n \n\n#include <drm/drm_atomic.h>\n#include <drm/drm_damage_helper.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem_atomic_helper.h>\n\n#include \"mdp4_kms.h\"\n\n#define DOWN_SCALE_MAX\t8\n#define UP_SCALE_MAX\t8\n\nstruct mdp4_plane {\n\tstruct drm_plane base;\n\tconst char *name;\n\n\tenum mdp4_pipe pipe;\n\n\tuint32_t caps;\n\tuint32_t nformats;\n\tuint32_t formats[32];\n\n\tbool enabled;\n};\n#define to_mdp4_plane(x) container_of(x, struct mdp4_plane, base)\n\n \nstatic inline\nenum mdp4_frame_format mdp4_get_frame_format(struct drm_framebuffer *fb)\n{\n\tbool is_tile = false;\n\n\tif (fb->modifier == DRM_FORMAT_MOD_SAMSUNG_64_32_TILE)\n\t\tis_tile = true;\n\n\tif (fb->format->format == DRM_FORMAT_NV12 && is_tile)\n\t\treturn FRAME_TILE_YCBCR_420;\n\n\treturn FRAME_LINEAR;\n}\n\nstatic void mdp4_plane_set_scanout(struct drm_plane *plane,\n\t\tstruct drm_framebuffer *fb);\nstatic int mdp4_plane_mode_set(struct drm_plane *plane,\n\t\tstruct drm_crtc *crtc, struct drm_framebuffer *fb,\n\t\tint crtc_x, int crtc_y,\n\t\tunsigned int crtc_w, unsigned int crtc_h,\n\t\tuint32_t src_x, uint32_t src_y,\n\t\tuint32_t src_w, uint32_t src_h);\n\nstatic struct mdp4_kms *get_kms(struct drm_plane *plane)\n{\n\tstruct msm_drm_private *priv = plane->dev->dev_private;\n\treturn to_mdp4_kms(to_mdp_kms(priv->kms));\n}\n\nstatic void mdp4_plane_destroy(struct drm_plane *plane)\n{\n\tstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\n\n\tdrm_plane_cleanup(plane);\n\n\tkfree(mdp4_plane);\n}\n\n \nstatic void mdp4_plane_install_properties(struct drm_plane *plane,\n\t\tstruct drm_mode_object *obj)\n{\n\t\n}\n\nstatic int mdp4_plane_set_property(struct drm_plane *plane,\n\t\tstruct drm_property *property, uint64_t val)\n{\n\t\n\treturn -EINVAL;\n}\n\nstatic const struct drm_plane_funcs mdp4_plane_funcs = {\n\t\t.update_plane = drm_atomic_helper_update_plane,\n\t\t.disable_plane = drm_atomic_helper_disable_plane,\n\t\t.destroy = mdp4_plane_destroy,\n\t\t.set_property = mdp4_plane_set_property,\n\t\t.reset = drm_atomic_helper_plane_reset,\n\t\t.atomic_duplicate_state = drm_atomic_helper_plane_duplicate_state,\n\t\t.atomic_destroy_state = drm_atomic_helper_plane_destroy_state,\n};\n\nstatic int mdp4_plane_prepare_fb(struct drm_plane *plane,\n\t\t\t\t struct drm_plane_state *new_state)\n{\n\tstruct msm_drm_private *priv = plane->dev->dev_private;\n\tstruct msm_kms *kms = priv->kms;\n\n\tif (!new_state->fb)\n\t\treturn 0;\n\n\tdrm_gem_plane_helper_prepare_fb(plane, new_state);\n\n\treturn msm_framebuffer_prepare(new_state->fb, kms->aspace, false);\n}\n\nstatic void mdp4_plane_cleanup_fb(struct drm_plane *plane,\n\t\t\t\t  struct drm_plane_state *old_state)\n{\n\tstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\n\tstruct mdp4_kms *mdp4_kms = get_kms(plane);\n\tstruct msm_kms *kms = &mdp4_kms->base.base;\n\tstruct drm_framebuffer *fb = old_state->fb;\n\n\tif (!fb)\n\t\treturn;\n\n\tDBG(\"%s: cleanup: FB[%u]\", mdp4_plane->name, fb->base.id);\n\tmsm_framebuffer_cleanup(fb, kms->aspace, false);\n}\n\n\nstatic int mdp4_plane_atomic_check(struct drm_plane *plane,\n\t\tstruct drm_atomic_state *state)\n{\n\treturn 0;\n}\n\nstatic void mdp4_plane_atomic_update(struct drm_plane *plane,\n\t\t\t\t     struct drm_atomic_state *state)\n{\n\tstruct drm_plane_state *new_state = drm_atomic_get_new_plane_state(state,\n\t\t\t\t\t\t\t\t\t   plane);\n\tint ret;\n\n\tret = mdp4_plane_mode_set(plane,\n\t\t\tnew_state->crtc, new_state->fb,\n\t\t\tnew_state->crtc_x, new_state->crtc_y,\n\t\t\tnew_state->crtc_w, new_state->crtc_h,\n\t\t\tnew_state->src_x,  new_state->src_y,\n\t\t\tnew_state->src_w, new_state->src_h);\n\t \n\tWARN_ON(ret < 0);\n}\n\nstatic const struct drm_plane_helper_funcs mdp4_plane_helper_funcs = {\n\t\t.prepare_fb = mdp4_plane_prepare_fb,\n\t\t.cleanup_fb = mdp4_plane_cleanup_fb,\n\t\t.atomic_check = mdp4_plane_atomic_check,\n\t\t.atomic_update = mdp4_plane_atomic_update,\n};\n\nstatic void mdp4_plane_set_scanout(struct drm_plane *plane,\n\t\tstruct drm_framebuffer *fb)\n{\n\tstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\n\tstruct mdp4_kms *mdp4_kms = get_kms(plane);\n\tstruct msm_kms *kms = &mdp4_kms->base.base;\n\tenum mdp4_pipe pipe = mdp4_plane->pipe;\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_STRIDE_A(pipe),\n\t\t\tMDP4_PIPE_SRC_STRIDE_A_P0(fb->pitches[0]) |\n\t\t\tMDP4_PIPE_SRC_STRIDE_A_P1(fb->pitches[1]));\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_STRIDE_B(pipe),\n\t\t\tMDP4_PIPE_SRC_STRIDE_B_P2(fb->pitches[2]) |\n\t\t\tMDP4_PIPE_SRC_STRIDE_B_P3(fb->pitches[3]));\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRCP0_BASE(pipe),\n\t\t\tmsm_framebuffer_iova(fb, kms->aspace, 0));\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRCP1_BASE(pipe),\n\t\t\tmsm_framebuffer_iova(fb, kms->aspace, 1));\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRCP2_BASE(pipe),\n\t\t\tmsm_framebuffer_iova(fb, kms->aspace, 2));\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRCP3_BASE(pipe),\n\t\t\tmsm_framebuffer_iova(fb, kms->aspace, 3));\n}\n\nstatic void mdp4_write_csc_config(struct mdp4_kms *mdp4_kms,\n\t\tenum mdp4_pipe pipe, struct csc_cfg *csc)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(csc->matrix); i++) {\n\t\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_MV(pipe, i),\n\t\t\t\tcsc->matrix[i]);\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(csc->post_bias) ; i++) {\n\t\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_PRE_BV(pipe, i),\n\t\t\t\tcsc->pre_bias[i]);\n\n\t\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_POST_BV(pipe, i),\n\t\t\t\tcsc->post_bias[i]);\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(csc->post_clamp) ; i++) {\n\t\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_PRE_LV(pipe, i),\n\t\t\t\tcsc->pre_clamp[i]);\n\n\t\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_POST_LV(pipe, i),\n\t\t\t\tcsc->post_clamp[i]);\n\t}\n}\n\n#define MDP4_VG_PHASE_STEP_DEFAULT\t0x20000000\n\nstatic int mdp4_plane_mode_set(struct drm_plane *plane,\n\t\tstruct drm_crtc *crtc, struct drm_framebuffer *fb,\n\t\tint crtc_x, int crtc_y,\n\t\tunsigned int crtc_w, unsigned int crtc_h,\n\t\tuint32_t src_x, uint32_t src_y,\n\t\tuint32_t src_w, uint32_t src_h)\n{\n\tstruct drm_device *dev = plane->dev;\n\tstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\n\tstruct mdp4_kms *mdp4_kms = get_kms(plane);\n\tenum mdp4_pipe pipe = mdp4_plane->pipe;\n\tconst struct mdp_format *format;\n\tuint32_t op_mode = 0;\n\tuint32_t phasex_step = MDP4_VG_PHASE_STEP_DEFAULT;\n\tuint32_t phasey_step = MDP4_VG_PHASE_STEP_DEFAULT;\n\tenum mdp4_frame_format frame_type;\n\n\tif (!(crtc && fb)) {\n\t\tDBG(\"%s: disabled!\", mdp4_plane->name);\n\t\treturn 0;\n\t}\n\n\tframe_type = mdp4_get_frame_format(fb);\n\n\t \n\tsrc_x = src_x >> 16;\n\tsrc_y = src_y >> 16;\n\tsrc_w = src_w >> 16;\n\tsrc_h = src_h >> 16;\n\n\tDBG(\"%s: FB[%u] %u,%u,%u,%u -> CRTC[%u] %d,%d,%u,%u\", mdp4_plane->name,\n\t\t\tfb->base.id, src_x, src_y, src_w, src_h,\n\t\t\tcrtc->base.id, crtc_x, crtc_y, crtc_w, crtc_h);\n\n\tformat = to_mdp_format(msm_framebuffer_format(fb));\n\n\tif (src_w > (crtc_w * DOWN_SCALE_MAX)) {\n\t\tDRM_DEV_ERROR(dev->dev, \"Width down scaling exceeds limits!\\n\");\n\t\treturn -ERANGE;\n\t}\n\n\tif (src_h > (crtc_h * DOWN_SCALE_MAX)) {\n\t\tDRM_DEV_ERROR(dev->dev, \"Height down scaling exceeds limits!\\n\");\n\t\treturn -ERANGE;\n\t}\n\n\tif (crtc_w > (src_w * UP_SCALE_MAX)) {\n\t\tDRM_DEV_ERROR(dev->dev, \"Width up scaling exceeds limits!\\n\");\n\t\treturn -ERANGE;\n\t}\n\n\tif (crtc_h > (src_h * UP_SCALE_MAX)) {\n\t\tDRM_DEV_ERROR(dev->dev, \"Height up scaling exceeds limits!\\n\");\n\t\treturn -ERANGE;\n\t}\n\n\tif (src_w != crtc_w) {\n\t\tuint32_t sel_unit = SCALE_FIR;\n\t\top_mode |= MDP4_PIPE_OP_MODE_SCALEX_EN;\n\n\t\tif (MDP_FORMAT_IS_YUV(format)) {\n\t\t\tif (crtc_w > src_w)\n\t\t\t\tsel_unit = SCALE_PIXEL_RPT;\n\t\t\telse if (crtc_w <= (src_w / 4))\n\t\t\t\tsel_unit = SCALE_MN_PHASE;\n\n\t\t\top_mode |= MDP4_PIPE_OP_MODE_SCALEX_UNIT_SEL(sel_unit);\n\t\t\tphasex_step = mult_frac(MDP4_VG_PHASE_STEP_DEFAULT,\n\t\t\t\t\tsrc_w, crtc_w);\n\t\t}\n\t}\n\n\tif (src_h != crtc_h) {\n\t\tuint32_t sel_unit = SCALE_FIR;\n\t\top_mode |= MDP4_PIPE_OP_MODE_SCALEY_EN;\n\n\t\tif (MDP_FORMAT_IS_YUV(format)) {\n\n\t\t\tif (crtc_h > src_h)\n\t\t\t\tsel_unit = SCALE_PIXEL_RPT;\n\t\t\telse if (crtc_h <= (src_h / 4))\n\t\t\t\tsel_unit = SCALE_MN_PHASE;\n\n\t\t\top_mode |= MDP4_PIPE_OP_MODE_SCALEY_UNIT_SEL(sel_unit);\n\t\t\tphasey_step = mult_frac(MDP4_VG_PHASE_STEP_DEFAULT,\n\t\t\t\t\tsrc_h, crtc_h);\n\t\t}\n\t}\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_SIZE(pipe),\n\t\t\tMDP4_PIPE_SRC_SIZE_WIDTH(src_w) |\n\t\t\tMDP4_PIPE_SRC_SIZE_HEIGHT(src_h));\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_XY(pipe),\n\t\t\tMDP4_PIPE_SRC_XY_X(src_x) |\n\t\t\tMDP4_PIPE_SRC_XY_Y(src_y));\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_DST_SIZE(pipe),\n\t\t\tMDP4_PIPE_DST_SIZE_WIDTH(crtc_w) |\n\t\t\tMDP4_PIPE_DST_SIZE_HEIGHT(crtc_h));\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_DST_XY(pipe),\n\t\t\tMDP4_PIPE_DST_XY_X(crtc_x) |\n\t\t\tMDP4_PIPE_DST_XY_Y(crtc_y));\n\n\tmdp4_plane_set_scanout(plane, fb);\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_FORMAT(pipe),\n\t\t\tMDP4_PIPE_SRC_FORMAT_A_BPC(format->bpc_a) |\n\t\t\tMDP4_PIPE_SRC_FORMAT_R_BPC(format->bpc_r) |\n\t\t\tMDP4_PIPE_SRC_FORMAT_G_BPC(format->bpc_g) |\n\t\t\tMDP4_PIPE_SRC_FORMAT_B_BPC(format->bpc_b) |\n\t\t\tCOND(format->alpha_enable, MDP4_PIPE_SRC_FORMAT_ALPHA_ENABLE) |\n\t\t\tMDP4_PIPE_SRC_FORMAT_CPP(format->cpp - 1) |\n\t\t\tMDP4_PIPE_SRC_FORMAT_UNPACK_COUNT(format->unpack_count - 1) |\n\t\t\tMDP4_PIPE_SRC_FORMAT_FETCH_PLANES(format->fetch_type) |\n\t\t\tMDP4_PIPE_SRC_FORMAT_CHROMA_SAMP(format->chroma_sample) |\n\t\t\tMDP4_PIPE_SRC_FORMAT_FRAME_FORMAT(frame_type) |\n\t\t\tCOND(format->unpack_tight, MDP4_PIPE_SRC_FORMAT_UNPACK_TIGHT));\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_UNPACK(pipe),\n\t\t\tMDP4_PIPE_SRC_UNPACK_ELEM0(format->unpack[0]) |\n\t\t\tMDP4_PIPE_SRC_UNPACK_ELEM1(format->unpack[1]) |\n\t\t\tMDP4_PIPE_SRC_UNPACK_ELEM2(format->unpack[2]) |\n\t\t\tMDP4_PIPE_SRC_UNPACK_ELEM3(format->unpack[3]));\n\n\tif (MDP_FORMAT_IS_YUV(format)) {\n\t\tstruct csc_cfg *csc = mdp_get_default_csc_cfg(CSC_YUV2RGB);\n\n\t\top_mode |= MDP4_PIPE_OP_MODE_SRC_YCBCR;\n\t\top_mode |= MDP4_PIPE_OP_MODE_CSC_EN;\n\t\tmdp4_write_csc_config(mdp4_kms, pipe, csc);\n\t}\n\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_OP_MODE(pipe), op_mode);\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_PHASEX_STEP(pipe), phasex_step);\n\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_PHASEY_STEP(pipe), phasey_step);\n\n\tif (frame_type != FRAME_LINEAR)\n\t\tmdp4_write(mdp4_kms, REG_MDP4_PIPE_SSTILE_FRAME_SIZE(pipe),\n\t\t\t\tMDP4_PIPE_SSTILE_FRAME_SIZE_WIDTH(src_w) |\n\t\t\t\tMDP4_PIPE_SSTILE_FRAME_SIZE_HEIGHT(src_h));\n\n\treturn 0;\n}\n\nstatic const char *pipe_names[] = {\n\t\t\"VG1\", \"VG2\",\n\t\t\"RGB1\", \"RGB2\", \"RGB3\",\n\t\t\"VG3\", \"VG4\",\n};\n\nenum mdp4_pipe mdp4_plane_pipe(struct drm_plane *plane)\n{\n\tstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\n\treturn mdp4_plane->pipe;\n}\n\nstatic const uint64_t supported_format_modifiers[] = {\n\tDRM_FORMAT_MOD_SAMSUNG_64_32_TILE,\n\tDRM_FORMAT_MOD_LINEAR,\n\tDRM_FORMAT_MOD_INVALID\n};\n\n \nstruct drm_plane *mdp4_plane_init(struct drm_device *dev,\n\t\tenum mdp4_pipe pipe_id, bool private_plane)\n{\n\tstruct drm_plane *plane = NULL;\n\tstruct mdp4_plane *mdp4_plane;\n\tint ret;\n\tenum drm_plane_type type;\n\n\tmdp4_plane = kzalloc(sizeof(*mdp4_plane), GFP_KERNEL);\n\tif (!mdp4_plane) {\n\t\tret = -ENOMEM;\n\t\tgoto fail;\n\t}\n\n\tplane = &mdp4_plane->base;\n\n\tmdp4_plane->pipe = pipe_id;\n\tmdp4_plane->name = pipe_names[pipe_id];\n\tmdp4_plane->caps = mdp4_pipe_caps(pipe_id);\n\n\tmdp4_plane->nformats = mdp_get_formats(mdp4_plane->formats,\n\t\t\tARRAY_SIZE(mdp4_plane->formats),\n\t\t\t!pipe_supports_yuv(mdp4_plane->caps));\n\n\ttype = private_plane ? DRM_PLANE_TYPE_PRIMARY : DRM_PLANE_TYPE_OVERLAY;\n\tret = drm_universal_plane_init(dev, plane, 0xff, &mdp4_plane_funcs,\n\t\t\t\t mdp4_plane->formats, mdp4_plane->nformats,\n\t\t\t\t supported_format_modifiers, type, NULL);\n\tif (ret)\n\t\tgoto fail;\n\n\tdrm_plane_helper_add(plane, &mdp4_plane_helper_funcs);\n\n\tmdp4_plane_install_properties(plane, &plane->base);\n\n\tdrm_plane_enable_fb_damage_clips(plane);\n\n\treturn plane;\n\nfail:\n\tif (plane)\n\t\tmdp4_plane_destroy(plane);\n\n\treturn ERR_PTR(ret);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}