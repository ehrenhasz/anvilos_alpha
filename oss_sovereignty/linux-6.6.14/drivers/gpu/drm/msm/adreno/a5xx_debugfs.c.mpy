{
  "module_name": "a5xx_debugfs.c",
  "hash_id": "be0f7b08eaed72407e6b87de35debde49b6bf4fd0daa09724454c9b6474f2218",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/msm/adreno/a5xx_debugfs.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/debugfs.h>\n\n#include <drm/drm_debugfs.h>\n#include <drm/drm_file.h>\n#include <drm/drm_print.h>\n\n#include \"a5xx_gpu.h\"\n\nstatic void pfp_print(struct msm_gpu *gpu, struct drm_printer *p)\n{\n\tint i;\n\n\tdrm_printf(p, \"PFP state:\\n\");\n\n\tfor (i = 0; i < 36; i++) {\n\t\tgpu_write(gpu, REG_A5XX_CP_PFP_STAT_ADDR, i);\n\t\tdrm_printf(p, \"  %02x: %08x\\n\", i,\n\t\t\tgpu_read(gpu, REG_A5XX_CP_PFP_STAT_DATA));\n\t}\n}\n\nstatic void me_print(struct msm_gpu *gpu, struct drm_printer *p)\n{\n\tint i;\n\n\tdrm_printf(p, \"ME state:\\n\");\n\n\tfor (i = 0; i < 29; i++) {\n\t\tgpu_write(gpu, REG_A5XX_CP_ME_STAT_ADDR, i);\n\t\tdrm_printf(p, \"  %02x: %08x\\n\", i,\n\t\t\tgpu_read(gpu, REG_A5XX_CP_ME_STAT_DATA));\n\t}\n}\n\nstatic void meq_print(struct msm_gpu *gpu, struct drm_printer *p)\n{\n\tint i;\n\n\tdrm_printf(p, \"MEQ state:\\n\");\n\tgpu_write(gpu, REG_A5XX_CP_MEQ_DBG_ADDR, 0);\n\n\tfor (i = 0; i < 64; i++) {\n\t\tdrm_printf(p, \"  %02x: %08x\\n\", i,\n\t\t\tgpu_read(gpu, REG_A5XX_CP_MEQ_DBG_DATA));\n\t}\n}\n\nstatic void roq_print(struct msm_gpu *gpu, struct drm_printer *p)\n{\n\tint i;\n\n\tdrm_printf(p, \"ROQ state:\\n\");\n\tgpu_write(gpu, REG_A5XX_CP_ROQ_DBG_ADDR, 0);\n\n\tfor (i = 0; i < 512 / 4; i++) {\n\t\tuint32_t val[4];\n\t\tint j;\n\t\tfor (j = 0; j < 4; j++)\n\t\t\tval[j] = gpu_read(gpu, REG_A5XX_CP_ROQ_DBG_DATA);\n\t\tdrm_printf(p, \"  %02x: %08x %08x %08x %08x\\n\", i,\n\t\t\tval[0], val[1], val[2], val[3]);\n\t}\n}\n\nstatic int show(struct seq_file *m, void *arg)\n{\n\tstruct drm_info_node *node = m->private;\n\tstruct drm_device *dev = node->minor->dev;\n\tstruct msm_drm_private *priv = dev->dev_private;\n\tstruct drm_printer p = drm_seq_file_printer(m);\n\tvoid (*show)(struct msm_gpu *gpu, struct drm_printer *p) =\n\t\tnode->info_ent->data;\n\n\tshow(priv->gpu, &p);\n\treturn 0;\n}\n\n#define ENT(n) { .name = #n, .show = show, .data = n ##_print }\nstatic struct drm_info_list a5xx_debugfs_list[] = {\n\tENT(pfp),\n\tENT(me),\n\tENT(meq),\n\tENT(roq),\n};\n\n \nstatic int\nreset_set(void *data, u64 val)\n{\n\tstruct drm_device *dev = data;\n\tstruct msm_drm_private *priv = dev->dev_private;\n\tstruct msm_gpu *gpu = priv->gpu;\n\tstruct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);\n\tstruct a5xx_gpu *a5xx_gpu = to_a5xx_gpu(adreno_gpu);\n\n\tif (!capable(CAP_SYS_ADMIN))\n\t\treturn -EINVAL;\n\n\t \n\n\tmutex_lock(&gpu->lock);\n\n\trelease_firmware(adreno_gpu->fw[ADRENO_FW_PM4]);\n\tadreno_gpu->fw[ADRENO_FW_PM4] = NULL;\n\n\trelease_firmware(adreno_gpu->fw[ADRENO_FW_PFP]);\n\tadreno_gpu->fw[ADRENO_FW_PFP] = NULL;\n\n\tif (a5xx_gpu->pm4_bo) {\n\t\tmsm_gem_unpin_iova(a5xx_gpu->pm4_bo, gpu->aspace);\n\t\tdrm_gem_object_put(a5xx_gpu->pm4_bo);\n\t\ta5xx_gpu->pm4_bo = NULL;\n\t}\n\n\tif (a5xx_gpu->pfp_bo) {\n\t\tmsm_gem_unpin_iova(a5xx_gpu->pfp_bo, gpu->aspace);\n\t\tdrm_gem_object_put(a5xx_gpu->pfp_bo);\n\t\ta5xx_gpu->pfp_bo = NULL;\n\t}\n\n\tgpu->needs_hw_init = true;\n\n\tpm_runtime_get_sync(&gpu->pdev->dev);\n\tgpu->funcs->recover(gpu);\n\n\tpm_runtime_put_sync(&gpu->pdev->dev);\n\tmutex_unlock(&gpu->lock);\n\n\treturn 0;\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(reset_fops, NULL, reset_set, \"%llx\\n\");\n\n\nvoid a5xx_debugfs_init(struct msm_gpu *gpu, struct drm_minor *minor)\n{\n\tstruct drm_device *dev;\n\n\tif (!minor)\n\t\treturn;\n\n\tdev = minor->dev;\n\n\tdrm_debugfs_create_files(a5xx_debugfs_list,\n\t\t\t\t ARRAY_SIZE(a5xx_debugfs_list),\n\t\t\t\t minor->debugfs_root, minor);\n\n\tdebugfs_create_file_unsafe(\"reset\", S_IWUGO, minor->debugfs_root, dev,\n\t\t\t\t&reset_fops);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}