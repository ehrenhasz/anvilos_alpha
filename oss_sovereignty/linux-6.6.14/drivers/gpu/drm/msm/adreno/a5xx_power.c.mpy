{
  "module_name": "a5xx_power.c",
  "hash_id": "5b34c34aea47ae54544b8ce4818ac4c7c94686e35644a784de392a32205e7a9e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/msm/adreno/a5xx_power.c",
  "human_readable_source": "\n \n\n#include <linux/pm_opp.h>\n#include \"a5xx_gpu.h\"\n\n \n\n#define AGC_INIT_BASE REG_A5XX_GPMU_DATA_RAM_BASE\n#define AGC_INIT_MSG_MAGIC (AGC_INIT_BASE + 5)\n#define AGC_MSG_BASE (AGC_INIT_BASE + 7)\n\n#define AGC_MSG_STATE (AGC_MSG_BASE + 0)\n#define AGC_MSG_COMMAND (AGC_MSG_BASE + 1)\n#define AGC_MSG_PAYLOAD_SIZE (AGC_MSG_BASE + 3)\n#define AGC_MSG_PAYLOAD(_o) ((AGC_MSG_BASE + 5) + (_o))\n\n#define AGC_POWER_CONFIG_PRODUCTION_ID 1\n#define AGC_INIT_MSG_VALUE 0xBABEFACE\n\n \n#define AGC_LM_CONFIG (136/4)\n#define AGC_LM_CONFIG_GPU_VERSION_SHIFT 17\n#define AGC_LM_CONFIG_ENABLE_GPMU_ADAPTIVE 1\n#define AGC_LM_CONFIG_THROTTLE_DISABLE (2 << 8)\n#define AGC_LM_CONFIG_ISENSE_ENABLE (1 << 4)\n#define AGC_LM_CONFIG_ENABLE_ERROR (3 << 4)\n#define AGC_LM_CONFIG_LLM_ENABLED (1 << 16)\n#define AGC_LM_CONFIG_BCL_DISABLED (1 << 24)\n\n#define AGC_LEVEL_CONFIG (140/4)\n\nstatic struct {\n\tuint32_t reg;\n\tuint32_t value;\n} a5xx_sequence_regs[] = {\n\t{ 0xB9A1, 0x00010303 },\n\t{ 0xB9A2, 0x13000000 },\n\t{ 0xB9A3, 0x00460020 },\n\t{ 0xB9A4, 0x10000000 },\n\t{ 0xB9A5, 0x040A1707 },\n\t{ 0xB9A6, 0x00010000 },\n\t{ 0xB9A7, 0x0E000904 },\n\t{ 0xB9A8, 0x10000000 },\n\t{ 0xB9A9, 0x01165000 },\n\t{ 0xB9AA, 0x000E0002 },\n\t{ 0xB9AB, 0x03884141 },\n\t{ 0xB9AC, 0x10000840 },\n\t{ 0xB9AD, 0x572A5000 },\n\t{ 0xB9AE, 0x00000003 },\n\t{ 0xB9AF, 0x00000000 },\n\t{ 0xB9B0, 0x10000000 },\n\t{ 0xB828, 0x6C204010 },\n\t{ 0xB829, 0x6C204011 },\n\t{ 0xB82A, 0x6C204012 },\n\t{ 0xB82B, 0x6C204013 },\n\t{ 0xB82C, 0x6C204014 },\n\t{ 0xB90F, 0x00000004 },\n\t{ 0xB910, 0x00000002 },\n\t{ 0xB911, 0x00000002 },\n\t{ 0xB912, 0x00000002 },\n\t{ 0xB913, 0x00000002 },\n\t{ 0xB92F, 0x00000004 },\n\t{ 0xB930, 0x00000005 },\n\t{ 0xB931, 0x00000005 },\n\t{ 0xB932, 0x00000005 },\n\t{ 0xB933, 0x00000005 },\n\t{ 0xB96F, 0x00000001 },\n\t{ 0xB970, 0x00000003 },\n\t{ 0xB94F, 0x00000004 },\n\t{ 0xB950, 0x0000000B },\n\t{ 0xB951, 0x0000000B },\n\t{ 0xB952, 0x0000000B },\n\t{ 0xB953, 0x0000000B },\n\t{ 0xB907, 0x00000019 },\n\t{ 0xB927, 0x00000019 },\n\t{ 0xB947, 0x00000019 },\n\t{ 0xB967, 0x00000019 },\n\t{ 0xB987, 0x00000019 },\n\t{ 0xB906, 0x00220001 },\n\t{ 0xB926, 0x00220001 },\n\t{ 0xB946, 0x00220001 },\n\t{ 0xB966, 0x00220001 },\n\t{ 0xB986, 0x00300000 },\n\t{ 0xAC40, 0x0340FF41 },\n\t{ 0xAC41, 0x03BEFED0 },\n\t{ 0xAC42, 0x00331FED },\n\t{ 0xAC43, 0x021FFDD3 },\n\t{ 0xAC44, 0x5555AAAA },\n\t{ 0xAC45, 0x5555AAAA },\n\t{ 0xB9BA, 0x00000008 },\n};\n\n \nstatic inline uint32_t _get_mvolts(struct msm_gpu *gpu, uint32_t freq)\n{\n\tstruct drm_device *dev = gpu->dev;\n\tstruct msm_drm_private *priv = dev->dev_private;\n\tstruct platform_device *pdev = priv->gpu_pdev;\n\tstruct dev_pm_opp *opp;\n\tu32 ret = 0;\n\n\topp = dev_pm_opp_find_freq_exact(&pdev->dev, freq, true);\n\n\tif (!IS_ERR(opp)) {\n\t\tret = dev_pm_opp_get_voltage(opp) / 1000;\n\t\tdev_pm_opp_put(opp);\n\t}\n\n\treturn ret;\n}\n\n \nstatic void a530_lm_setup(struct msm_gpu *gpu)\n{\n\tstruct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);\n\tstruct a5xx_gpu *a5xx_gpu = to_a5xx_gpu(adreno_gpu);\n\tunsigned int i;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(a5xx_sequence_regs); i++)\n\t\tgpu_write(gpu, a5xx_sequence_regs[i].reg,\n\t\t\ta5xx_sequence_regs[i].value);\n\n\t \n\tgpu_write(gpu, REG_A5XX_GPMU_TEMP_SENSOR_ID, 0x60007);\n\tgpu_write(gpu, REG_A5XX_GPMU_DELTA_TEMP_THRESHOLD, 0x01);\n\tgpu_write(gpu, REG_A5XX_GPMU_TEMP_SENSOR_CONFIG, 0x01);\n\n\t \n\tgpu_write(gpu, REG_A5XX_GPMU_GPMU_VOLTAGE, 0x80000000 | 0);\n\n\tgpu_write(gpu, REG_A5XX_GPMU_BASE_LEAKAGE, a5xx_gpu->lm_leakage);\n\n\t \n\tgpu_write(gpu, REG_A5XX_GPMU_GPMU_PWR_THRESHOLD, 0x80000000 | 6000);\n\n\tgpu_write(gpu, REG_A5XX_GPMU_BEC_ENABLE, 0x10001FFF);\n\tgpu_write(gpu, REG_A5XX_GDPM_CONFIG1, 0x00201FF1);\n\n\t \n\tgpu_write(gpu, REG_A5XX_GPMU_BEC_ENABLE, 0x10001FFF);\n\tgpu_write(gpu, REG_A5XX_GDPM_CONFIG1, 0x201FF1);\n\n\tgpu_write(gpu, AGC_MSG_STATE, 1);\n\tgpu_write(gpu, AGC_MSG_COMMAND, AGC_POWER_CONFIG_PRODUCTION_ID);\n\n\t \n\tgpu_write(gpu, AGC_MSG_PAYLOAD(0), 5448);\n\tgpu_write(gpu, AGC_MSG_PAYLOAD(1), 1);\n\n\t \n\tgpu_write(gpu, AGC_MSG_PAYLOAD(2), _get_mvolts(gpu, gpu->fast_rate));\n\tgpu_write(gpu, AGC_MSG_PAYLOAD(3), gpu->fast_rate / 1000000);\n\n\tgpu_write(gpu, AGC_MSG_PAYLOAD_SIZE, 4 * sizeof(uint32_t));\n\tgpu_write(gpu, AGC_INIT_MSG_MAGIC, AGC_INIT_MSG_VALUE);\n}\n\n#define PAYLOAD_SIZE(_size) ((_size) * sizeof(u32))\n#define LM_DCVS_LIMIT 1\n#define LEVEL_CONFIG ~(0x303)\n\nstatic void a540_lm_setup(struct msm_gpu *gpu)\n{\n\tstruct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);\n\tu32 config;\n\n\t \n\tconfig = AGC_LM_CONFIG_BCL_DISABLED;\n\tconfig |= adreno_patchid(adreno_gpu) << AGC_LM_CONFIG_GPU_VERSION_SHIFT;\n\n\t \n\tconfig |= AGC_LM_CONFIG_THROTTLE_DISABLE;\n\n\t \n\tgpu_write(gpu, REG_A5XX_GPMU_GPMU_VOLTAGE, 0x80000000 | 0);\n\n\t \n\tgpu_write(gpu, REG_A5XX_GPMU_GPMU_PWR_THRESHOLD, 0x80000000 | 6000);\n\n\tgpu_write(gpu, AGC_MSG_STATE, 0x80000001);\n\tgpu_write(gpu, AGC_MSG_COMMAND, AGC_POWER_CONFIG_PRODUCTION_ID);\n\n\tgpu_write(gpu, AGC_MSG_PAYLOAD(0), 5448);\n\tgpu_write(gpu, AGC_MSG_PAYLOAD(1), 1);\n\n\tgpu_write(gpu, AGC_MSG_PAYLOAD(2), _get_mvolts(gpu, gpu->fast_rate));\n\tgpu_write(gpu, AGC_MSG_PAYLOAD(3), gpu->fast_rate / 1000000);\n\n\tgpu_write(gpu, AGC_MSG_PAYLOAD(AGC_LM_CONFIG), config);\n\tgpu_write(gpu, AGC_MSG_PAYLOAD(AGC_LEVEL_CONFIG), LEVEL_CONFIG);\n\tgpu_write(gpu, AGC_MSG_PAYLOAD_SIZE,\n\tPAYLOAD_SIZE(AGC_LEVEL_CONFIG + 1));\n\n\tgpu_write(gpu, AGC_INIT_MSG_MAGIC, AGC_INIT_MSG_VALUE);\n}\n\n \nstatic void a5xx_pc_init(struct msm_gpu *gpu)\n{\n\tgpu_write(gpu, REG_A5XX_GPMU_PWR_COL_INTER_FRAME_CTRL, 0x7F);\n\tgpu_write(gpu, REG_A5XX_GPMU_PWR_COL_BINNING_CTRL, 0);\n\tgpu_write(gpu, REG_A5XX_GPMU_PWR_COL_INTER_FRAME_HYST, 0xA0080);\n\tgpu_write(gpu, REG_A5XX_GPMU_PWR_COL_STAGGER_DELAY, 0x600040);\n}\n\n \nstatic int a5xx_gpmu_init(struct msm_gpu *gpu)\n{\n\tstruct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);\n\tstruct a5xx_gpu *a5xx_gpu = to_a5xx_gpu(adreno_gpu);\n\tstruct msm_ringbuffer *ring = gpu->rb[0];\n\n\tif (!a5xx_gpu->gpmu_dwords)\n\t\treturn 0;\n\n\t \n\tOUT_PKT7(ring, CP_SET_PROTECTED_MODE, 1);\n\tOUT_RING(ring, 0);\n\n\t \n\tOUT_PKT7(ring, CP_INDIRECT_BUFFER_PFE, 3);\n\tOUT_RING(ring, lower_32_bits(a5xx_gpu->gpmu_iova));\n\tOUT_RING(ring, upper_32_bits(a5xx_gpu->gpmu_iova));\n\tOUT_RING(ring, a5xx_gpu->gpmu_dwords);\n\n\t \n\tOUT_PKT7(ring, CP_SET_PROTECTED_MODE, 1);\n\tOUT_RING(ring, 1);\n\n\ta5xx_flush(gpu, ring, true);\n\n\tif (!a5xx_idle(gpu, ring)) {\n\t\tDRM_ERROR(\"%s: Unable to load GPMU firmware. GPMU will not be active\\n\",\n\t\t\tgpu->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (adreno_is_a530(adreno_gpu))\n\t\tgpu_write(gpu, REG_A5XX_GPMU_WFI_CONFIG, 0x4014);\n\n\t \n\tgpu_write(gpu, REG_A5XX_GPMU_CM3_SYSRESET, 0x0);\n\n\t \n\tif (spin_usecs(gpu, 25, REG_A5XX_GPMU_GENERAL_0, 0xFFFFFFFF,\n\t\t0xBABEFACE))\n\t\tDRM_ERROR(\"%s: GPMU firmware initialization timed out\\n\",\n\t\t\tgpu->name);\n\n\tif (!adreno_is_a530(adreno_gpu)) {\n\t\tu32 val = gpu_read(gpu, REG_A5XX_GPMU_GENERAL_1);\n\n\t\tif (val)\n\t\t\tDRM_ERROR(\"%s: GPMU firmware initialization failed: %d\\n\",\n\t\t\t\t  gpu->name, val);\n\t}\n\n\treturn 0;\n}\n\n \nstatic void a5xx_lm_enable(struct msm_gpu *gpu)\n{\n\tstruct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);\n\n\t \n\tif (!adreno_is_a530(adreno_gpu))\n\t\treturn;\n\n\tgpu_write(gpu, REG_A5XX_GDPM_INT_MASK, 0x0);\n\tgpu_write(gpu, REG_A5XX_GDPM_INT_EN, 0x0A);\n\tgpu_write(gpu, REG_A5XX_GPMU_GPMU_VOLTAGE_INTR_EN_MASK, 0x01);\n\tgpu_write(gpu, REG_A5XX_GPMU_TEMP_THRESHOLD_INTR_EN_MASK, 0x50000);\n\tgpu_write(gpu, REG_A5XX_GPMU_THROTTLE_UNMASK_FORCE_CTRL, 0x30000);\n\n\tgpu_write(gpu, REG_A5XX_GPMU_CLOCK_THROTTLE_CTRL, 0x011);\n}\n\nint a5xx_power_init(struct msm_gpu *gpu)\n{\n\tstruct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);\n\tint ret;\n\n\t \n\tif (!(adreno_is_a530(adreno_gpu) || adreno_is_a540(adreno_gpu)))\n\t\treturn 0;\n\n\t \n\tif (adreno_is_a530(adreno_gpu))\n\t\ta530_lm_setup(gpu);\n\telse if (adreno_is_a540(adreno_gpu))\n\t\ta540_lm_setup(gpu);\n\n\t \n\ta5xx_pc_init(gpu);\n\n\t \n\tret = a5xx_gpmu_init(gpu);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ta5xx_lm_enable(gpu);\n\n\treturn 0;\n}\n\nvoid a5xx_gpmu_ucode_init(struct msm_gpu *gpu)\n{\n\tstruct adreno_gpu *adreno_gpu = to_adreno_gpu(gpu);\n\tstruct a5xx_gpu *a5xx_gpu = to_a5xx_gpu(adreno_gpu);\n\tstruct drm_device *drm = gpu->dev;\n\tuint32_t dwords = 0, offset = 0, bosize;\n\tunsigned int *data, *ptr, *cmds;\n\tunsigned int cmds_size;\n\n\tif (!(adreno_is_a530(adreno_gpu) || adreno_is_a540(adreno_gpu)))\n\t\treturn;\n\n\tif (a5xx_gpu->gpmu_bo)\n\t\treturn;\n\n\tdata = (unsigned int *) adreno_gpu->fw[ADRENO_FW_GPMU]->data;\n\n\t \n\n\tif (adreno_gpu->fw[ADRENO_FW_GPMU]->size < 8 ||\n\t\t(data[0] < 2) || (data[0] >=\n\t\t\t(adreno_gpu->fw[ADRENO_FW_GPMU]->size >> 2)))\n\t\treturn;\n\n\t \n\tif (data[1] != 2)\n\t\treturn;\n\n\tcmds = data + data[2] + 3;\n\tcmds_size = data[0] - data[2] - 2;\n\n\t \n\tbosize = (cmds_size + (cmds_size / TYPE4_MAX_PAYLOAD) + 1) << 2;\n\n\tptr = msm_gem_kernel_new(drm, bosize,\n\t\tMSM_BO_WC | MSM_BO_GPU_READONLY, gpu->aspace,\n\t\t&a5xx_gpu->gpmu_bo, &a5xx_gpu->gpmu_iova);\n\tif (IS_ERR(ptr))\n\t\treturn;\n\n\tmsm_gem_object_set_name(a5xx_gpu->gpmu_bo, \"gpmufw\");\n\n\twhile (cmds_size > 0) {\n\t\tint i;\n\t\tuint32_t _size = cmds_size > TYPE4_MAX_PAYLOAD ?\n\t\t\tTYPE4_MAX_PAYLOAD : cmds_size;\n\n\t\tptr[dwords++] = PKT4(REG_A5XX_GPMU_INST_RAM_BASE + offset,\n\t\t\t_size);\n\n\t\tfor (i = 0; i < _size; i++)\n\t\t\tptr[dwords++] = *cmds++;\n\n\t\toffset += _size;\n\t\tcmds_size -= _size;\n\t}\n\n\tmsm_gem_put_vaddr(a5xx_gpu->gpmu_bo);\n\ta5xx_gpu->gpmu_dwords = dwords;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}