{
  "module_name": "sti_plane.c",
  "hash_id": "018de7848a53baaecc2be39dff0286ebd96f57207588ceae9af128b9967004b1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/sti/sti_plane.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n\n#include <drm/drm_blend.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem_dma_helper.h>\n\n#include \"sti_compositor.h\"\n#include \"sti_drv.h\"\n#include \"sti_plane.h\"\n\nconst char *sti_plane_to_str(struct sti_plane *plane)\n{\n\tswitch (plane->desc) {\n\tcase STI_GDP_0:\n\t\treturn \"GDP0\";\n\tcase STI_GDP_1:\n\t\treturn \"GDP1\";\n\tcase STI_GDP_2:\n\t\treturn \"GDP2\";\n\tcase STI_GDP_3:\n\t\treturn \"GDP3\";\n\tcase STI_HQVDP_0:\n\t\treturn \"HQVDP0\";\n\tcase STI_CURSOR:\n\t\treturn \"CURSOR\";\n\tdefault:\n\t\treturn \"<UNKNOWN PLANE>\";\n\t}\n}\n\n#define STI_FPS_INTERVAL_MS     3000\n\nvoid sti_plane_update_fps(struct sti_plane *plane,\n\t\t\t  bool new_frame,\n\t\t\t  bool new_field)\n{\n\tstruct drm_plane_state *state = plane->drm_plane.state;\n\tktime_t now;\n\tstruct sti_fps_info *fps;\n\tint fpks, fipks, ms_since_last, num_frames, num_fields;\n\n\tnow = ktime_get();\n\n\t \n\tfps = &plane->fps_info;\n\n\tif (new_field)\n\t\tfps->curr_field_counter++;\n\n\t \n\tif (!new_frame)\n\t\treturn;\n\n\tfps->curr_frame_counter++;\n\tms_since_last = ktime_to_ms(ktime_sub(now, fps->last_timestamp));\n\tnum_frames = fps->curr_frame_counter - fps->last_frame_counter;\n\n\tif (num_frames <= 0  || ms_since_last < STI_FPS_INTERVAL_MS)\n\t\treturn;\n\n\tfps->last_timestamp = now;\n\tfps->last_frame_counter = fps->curr_frame_counter;\n\n\tif (state->fb) {\n\t\tfpks = (num_frames * 1000000) / ms_since_last;\n\t\tsnprintf(plane->fps_info.fps_str, FPS_LENGTH,\n\t\t\t \"%-8s %4dx%-4d %.4s @ %3d.%-3.3d fps (%s)\",\n\t\t\t plane->drm_plane.name,\n\t\t\t state->fb->width,\n\t\t\t state->fb->height,\n\t\t\t (char *)&state->fb->format->format,\n\t\t\t fpks / 1000, fpks % 1000,\n\t\t\t sti_plane_to_str(plane));\n\t}\n\n\tif (fps->curr_field_counter) {\n\t\t \n\t\tnum_fields = fps->curr_field_counter - fps->last_field_counter;\n\t\tfps->last_field_counter = fps->curr_field_counter;\n\t\tfipks = (num_fields * 1000000) / ms_since_last;\n\t\tsnprintf(plane->fps_info.fips_str,\n\t\t\t FPS_LENGTH, \" - %3d.%-3.3d field/sec\",\n\t\t\t fipks / 1000, fipks % 1000);\n\t} else {\n\t\tplane->fps_info.fips_str[0] = '\\0';\n\t}\n\n\tif (fps->output)\n\t\tDRM_INFO(\"%s%s\\n\",\n\t\t\t plane->fps_info.fps_str,\n\t\t\t plane->fps_info.fips_str);\n}\n\nstatic int sti_plane_get_default_zpos(enum drm_plane_type type)\n{\n\tswitch (type) {\n\tcase DRM_PLANE_TYPE_PRIMARY:\n\t\treturn 0;\n\tcase DRM_PLANE_TYPE_OVERLAY:\n\t\treturn 1;\n\tcase DRM_PLANE_TYPE_CURSOR:\n\t\treturn 7;\n\t}\n\treturn 0;\n}\n\nstatic void sti_plane_attach_zorder_property(struct drm_plane *drm_plane,\n\t\t\t\t\t     enum drm_plane_type type)\n{\n\tint zpos = sti_plane_get_default_zpos(type);\n\n\tswitch (type) {\n\tcase DRM_PLANE_TYPE_PRIMARY:\n\tcase DRM_PLANE_TYPE_OVERLAY:\n\t\tdrm_plane_create_zpos_property(drm_plane, zpos, 0, 6);\n\t\tbreak;\n\tcase DRM_PLANE_TYPE_CURSOR:\n\t\tdrm_plane_create_zpos_immutable_property(drm_plane, zpos);\n\t\tbreak;\n\t}\n}\n\nvoid sti_plane_init_property(struct sti_plane *plane,\n\t\t\t     enum drm_plane_type type)\n{\n\tsti_plane_attach_zorder_property(&plane->drm_plane, type);\n\n\tDRM_DEBUG_DRIVER(\"drm plane:%d mapped to %s\\n\",\n\t\t\t plane->drm_plane.base.id, sti_plane_to_str(plane));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}