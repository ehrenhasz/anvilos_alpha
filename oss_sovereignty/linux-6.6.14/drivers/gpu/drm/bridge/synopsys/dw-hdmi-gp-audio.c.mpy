{
  "module_name": "dw-hdmi-gp-audio.c",
  "hash_id": "417fff5787bea5c0fe019de1e21b9f88a9fcc9419e1ca39f549635db1d900d81",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/bridge/synopsys/dw-hdmi-gp-audio.c",
  "human_readable_source": "\n \n#include <linux/io.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/dmaengine.h>\n#include <linux/dma-mapping.h>\n#include <drm/bridge/dw_hdmi.h>\n#include <drm/drm_edid.h>\n#include <drm/drm_connector.h>\n\n#include <sound/hdmi-codec.h>\n#include <sound/asoundef.h>\n#include <sound/core.h>\n#include <sound/initval.h>\n#include <sound/pcm.h>\n#include <sound/pcm_drm_eld.h>\n#include <sound/pcm_iec958.h>\n#include <sound/dmaengine_pcm.h>\n\n#include \"dw-hdmi-audio.h\"\n\n#define DRIVER_NAME \"dw-hdmi-gp-audio\"\n#define DRV_NAME    \"hdmi-gp-audio\"\n\nstruct snd_dw_hdmi {\n\tstruct dw_hdmi_audio_data data;\n\tstruct platform_device  *audio_pdev;\n\tunsigned int pos;\n};\n\nstruct dw_hdmi_channel_conf {\n\tu8 conf1;\n\tu8 ca;\n};\n\n \nstatic struct dw_hdmi_channel_conf default_hdmi_channel_config[7] = {\n\t{ 0x03, 0x00 },\t \n\t{ 0x0b, 0x02 },\t \n\t{ 0x33, 0x08 },\t \n\t{ 0x37, 0x09 },\t \n\t{ 0x3f, 0x0b },\t \n\t{ 0x7f, 0x0f },\t \n\t{ 0xff, 0x13 },\t \n};\n\nstatic int audio_hw_params(struct device *dev,  void *data,\n\t\t\t   struct hdmi_codec_daifmt *daifmt,\n\t\t\t   struct hdmi_codec_params *params)\n{\n\tstruct snd_dw_hdmi *dw = dev_get_drvdata(dev);\n\tu8 ca;\n\n\tdw_hdmi_set_sample_rate(dw->data.hdmi, params->sample_rate);\n\n\tca = default_hdmi_channel_config[params->channels - 2].ca;\n\n\tdw_hdmi_set_channel_count(dw->data.hdmi, params->channels);\n\tdw_hdmi_set_channel_allocation(dw->data.hdmi, ca);\n\n\tdw_hdmi_set_sample_non_pcm(dw->data.hdmi,\n\t\t\t\t   params->iec.status[0] & IEC958_AES0_NONAUDIO);\n\tdw_hdmi_set_sample_width(dw->data.hdmi, params->sample_width);\n\n\treturn 0;\n}\n\nstatic void audio_shutdown(struct device *dev, void *data)\n{\n}\n\nstatic int audio_mute_stream(struct device *dev, void *data,\n\t\t\t     bool enable, int direction)\n{\n\tstruct snd_dw_hdmi *dw = dev_get_drvdata(dev);\n\n\tif (!enable)\n\t\tdw_hdmi_audio_enable(dw->data.hdmi);\n\telse\n\t\tdw_hdmi_audio_disable(dw->data.hdmi);\n\n\treturn 0;\n}\n\nstatic int audio_get_eld(struct device *dev, void *data,\n\t\t\t u8 *buf, size_t len)\n{\n\tstruct dw_hdmi_audio_data *audio = data;\n\tu8 *eld;\n\n\teld = audio->get_eld(audio->hdmi);\n\tif (eld)\n\t\tmemcpy(buf, eld, min_t(size_t, MAX_ELD_BYTES, len));\n\telse\n\t\t \n\t\tmemset(buf, 0, len);\n\n\treturn 0;\n}\n\nstatic int audio_hook_plugged_cb(struct device *dev, void *data,\n\t\t\t\t hdmi_codec_plugged_cb fn,\n\t\t\t\t struct device *codec_dev)\n{\n\tstruct snd_dw_hdmi *dw = dev_get_drvdata(dev);\n\n\treturn dw_hdmi_set_plugged_cb(dw->data.hdmi, fn, codec_dev);\n}\n\nstatic const struct hdmi_codec_ops audio_codec_ops = {\n\t.hw_params = audio_hw_params,\n\t.audio_shutdown = audio_shutdown,\n\t.mute_stream = audio_mute_stream,\n\t.get_eld = audio_get_eld,\n\t.hook_plugged_cb = audio_hook_plugged_cb,\n};\n\nstatic int snd_dw_hdmi_probe(struct platform_device *pdev)\n{\n\tstruct dw_hdmi_audio_data *data = pdev->dev.platform_data;\n\tstruct snd_dw_hdmi *dw;\n\n\tconst struct hdmi_codec_pdata codec_data = {\n\t\t.i2s = 1,\n\t\t.spdif = 0,\n\t\t.ops = &audio_codec_ops,\n\t\t.max_i2s_channels = 8,\n\t\t.data = data,\n\t};\n\n\tdw = devm_kzalloc(&pdev->dev, sizeof(*dw), GFP_KERNEL);\n\tif (!dw)\n\t\treturn -ENOMEM;\n\n\tdw->data = *data;\n\n\tplatform_set_drvdata(pdev, dw);\n\n\tdw->audio_pdev = platform_device_register_data(&pdev->dev,\n\t\t\t\t\t\t       HDMI_CODEC_DRV_NAME, 1,\n\t\t\t\t\t\t       &codec_data,\n\t\t\t\t\t\t       sizeof(codec_data));\n\n\treturn PTR_ERR_OR_ZERO(dw->audio_pdev);\n}\n\nstatic void snd_dw_hdmi_remove(struct platform_device *pdev)\n{\n\tstruct snd_dw_hdmi *dw = platform_get_drvdata(pdev);\n\n\tplatform_device_unregister(dw->audio_pdev);\n}\n\nstatic struct platform_driver snd_dw_hdmi_driver = {\n\t.probe\t= snd_dw_hdmi_probe,\n\t.remove_new = snd_dw_hdmi_remove,\n\t.driver\t= {\n\t\t.name = DRIVER_NAME,\n\t},\n};\n\nmodule_platform_driver(snd_dw_hdmi_driver);\n\nMODULE_AUTHOR(\"Shengjiu Wang <shengjiu.wang@nxp.com>\");\nMODULE_DESCRIPTION(\"Synopsys Designware HDMI GPA ALSA interface\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:\" DRIVER_NAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}