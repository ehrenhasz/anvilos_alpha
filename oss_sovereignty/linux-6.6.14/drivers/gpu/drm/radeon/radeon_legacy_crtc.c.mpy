{
  "module_name": "radeon_legacy_crtc.c",
  "hash_id": "058c68aafc3974c9619d6706c7448498f278a174a66c866a624f7603a75dbd67",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/radeon_legacy_crtc.c",
  "human_readable_source": " \n\n#include <drm/drm_fixed.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_modeset_helper_vtables.h>\n#include <drm/drm_vblank.h>\n#include <drm/radeon_drm.h>\n\n#include \"atom.h\"\n#include \"radeon.h\"\n\nstatic void radeon_overscan_setup(struct drm_crtc *crtc,\n\t\t\t\t  struct drm_display_mode *mode)\n{\n\tstruct drm_device *dev = crtc->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\n\tWREG32(RADEON_OVR_CLR + radeon_crtc->crtc_offset, 0);\n\tWREG32(RADEON_OVR_WID_LEFT_RIGHT + radeon_crtc->crtc_offset, 0);\n\tWREG32(RADEON_OVR_WID_TOP_BOTTOM + radeon_crtc->crtc_offset, 0);\n}\n\nstatic void radeon_legacy_rmx_mode_set(struct drm_crtc *crtc,\n\t\t\t\t       struct drm_display_mode *mode)\n{\n\tstruct drm_device *dev = crtc->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tint xres = mode->hdisplay;\n\tint yres = mode->vdisplay;\n\tbool hscale = true, vscale = true;\n\tint hsync_wid;\n\tint vsync_wid;\n\tint hsync_start;\n\tint blank_width;\n\tu32 scale, inc, crtc_more_cntl;\n\tu32 fp_horz_stretch, fp_vert_stretch, fp_horz_vert_active;\n\tu32 fp_h_sync_strt_wid, fp_crtc_h_total_disp;\n\tu32 fp_v_sync_strt_wid, fp_crtc_v_total_disp;\n\tstruct drm_display_mode *native_mode = &radeon_crtc->native_mode;\n\n\tfp_vert_stretch = RREG32(RADEON_FP_VERT_STRETCH) &\n\t\t(RADEON_VERT_STRETCH_RESERVED |\n\t\t RADEON_VERT_AUTO_RATIO_INC);\n\tfp_horz_stretch = RREG32(RADEON_FP_HORZ_STRETCH) &\n\t\t(RADEON_HORZ_FP_LOOP_STRETCH |\n\t\t RADEON_HORZ_AUTO_RATIO_INC);\n\n\tcrtc_more_cntl = 0;\n\tif ((rdev->family == CHIP_RS100) ||\n\t    (rdev->family == CHIP_RS200)) {\n\t\t \n\t\tcrtc_more_cntl |= RADEON_CRTC_H_CUTOFF_ACTIVE_EN;\n\t}\n\n\n\tfp_crtc_h_total_disp = ((((mode->crtc_htotal / 8) - 1) & 0x3ff)\n\t\t\t\t| ((((mode->crtc_hdisplay / 8) - 1) & 0x1ff) << 16));\n\n\thsync_wid = (mode->crtc_hsync_end - mode->crtc_hsync_start) / 8;\n\tif (!hsync_wid)\n\t\thsync_wid = 1;\n\thsync_start = mode->crtc_hsync_start - 8;\n\n\tfp_h_sync_strt_wid = ((hsync_start & 0x1fff)\n\t\t\t      | ((hsync_wid & 0x3f) << 16)\n\t\t\t      | ((mode->flags & DRM_MODE_FLAG_NHSYNC)\n\t\t\t\t ? RADEON_CRTC_H_SYNC_POL\n\t\t\t\t : 0));\n\n\tfp_crtc_v_total_disp = (((mode->crtc_vtotal - 1) & 0xffff)\n\t\t\t\t| ((mode->crtc_vdisplay - 1) << 16));\n\n\tvsync_wid = mode->crtc_vsync_end - mode->crtc_vsync_start;\n\tif (!vsync_wid)\n\t\tvsync_wid = 1;\n\n\tfp_v_sync_strt_wid = (((mode->crtc_vsync_start - 1) & 0xfff)\n\t\t\t      | ((vsync_wid & 0x1f) << 16)\n\t\t\t      | ((mode->flags & DRM_MODE_FLAG_NVSYNC)\n\t\t\t\t ? RADEON_CRTC_V_SYNC_POL\n\t\t\t\t : 0));\n\n\tfp_horz_vert_active = 0;\n\n\tif (native_mode->hdisplay == 0 ||\n\t    native_mode->vdisplay == 0) {\n\t\thscale = false;\n\t\tvscale = false;\n\t} else {\n\t\tif (xres > native_mode->hdisplay)\n\t\t\txres = native_mode->hdisplay;\n\t\tif (yres > native_mode->vdisplay)\n\t\t\tyres = native_mode->vdisplay;\n\n\t\tif (xres == native_mode->hdisplay)\n\t\t\thscale = false;\n\t\tif (yres == native_mode->vdisplay)\n\t\t\tvscale = false;\n\t}\n\n\tswitch (radeon_crtc->rmx_type) {\n\tcase RMX_FULL:\n\tcase RMX_ASPECT:\n\t\tif (!hscale)\n\t\t\tfp_horz_stretch |= ((xres/8-1) << 16);\n\t\telse {\n\t\t\tinc = (fp_horz_stretch & RADEON_HORZ_AUTO_RATIO_INC) ? 1 : 0;\n\t\t\tscale = ((xres + inc) * RADEON_HORZ_STRETCH_RATIO_MAX)\n\t\t\t\t/ native_mode->hdisplay + 1;\n\t\t\tfp_horz_stretch |= (((scale) & RADEON_HORZ_STRETCH_RATIO_MASK) |\n\t\t\t\t\tRADEON_HORZ_STRETCH_BLEND |\n\t\t\t\t\tRADEON_HORZ_STRETCH_ENABLE |\n\t\t\t\t\t((native_mode->hdisplay/8-1) << 16));\n\t\t}\n\n\t\tif (!vscale)\n\t\t\tfp_vert_stretch |= ((yres-1) << 12);\n\t\telse {\n\t\t\tinc = (fp_vert_stretch & RADEON_VERT_AUTO_RATIO_INC) ? 1 : 0;\n\t\t\tscale = ((yres + inc) * RADEON_VERT_STRETCH_RATIO_MAX)\n\t\t\t\t/ native_mode->vdisplay + 1;\n\t\t\tfp_vert_stretch |= (((scale) & RADEON_VERT_STRETCH_RATIO_MASK) |\n\t\t\t\t\tRADEON_VERT_STRETCH_ENABLE |\n\t\t\t\t\tRADEON_VERT_STRETCH_BLEND |\n\t\t\t\t\t((native_mode->vdisplay-1) << 12));\n\t\t}\n\t\tbreak;\n\tcase RMX_CENTER:\n\t\tfp_horz_stretch |= ((xres/8-1) << 16);\n\t\tfp_vert_stretch |= ((yres-1) << 12);\n\n\t\tcrtc_more_cntl |= (RADEON_CRTC_AUTO_HORZ_CENTER_EN |\n\t\t\t\tRADEON_CRTC_AUTO_VERT_CENTER_EN);\n\n\t\tblank_width = (mode->crtc_hblank_end - mode->crtc_hblank_start) / 8;\n\t\tif (blank_width > 110)\n\t\t\tblank_width = 110;\n\n\t\tfp_crtc_h_total_disp = (((blank_width) & 0x3ff)\n\t\t\t\t| ((((mode->crtc_hdisplay / 8) - 1) & 0x1ff) << 16));\n\n\t\thsync_wid = (mode->crtc_hsync_end - mode->crtc_hsync_start) / 8;\n\t\tif (!hsync_wid)\n\t\t\thsync_wid = 1;\n\n\t\tfp_h_sync_strt_wid = ((((mode->crtc_hsync_start - mode->crtc_hblank_start) / 8) & 0x1fff)\n\t\t\t\t| ((hsync_wid & 0x3f) << 16)\n\t\t\t\t| ((mode->flags & DRM_MODE_FLAG_NHSYNC)\n\t\t\t\t\t? RADEON_CRTC_H_SYNC_POL\n\t\t\t\t\t: 0));\n\n\t\tfp_crtc_v_total_disp = (((mode->crtc_vblank_end - mode->crtc_vblank_start) & 0xffff)\n\t\t\t\t| ((mode->crtc_vdisplay - 1) << 16));\n\n\t\tvsync_wid = mode->crtc_vsync_end - mode->crtc_vsync_start;\n\t\tif (!vsync_wid)\n\t\t\tvsync_wid = 1;\n\n\t\tfp_v_sync_strt_wid = ((((mode->crtc_vsync_start - mode->crtc_vblank_start) & 0xfff)\n\t\t\t\t\t| ((vsync_wid & 0x1f) << 16)\n\t\t\t\t\t| ((mode->flags & DRM_MODE_FLAG_NVSYNC)\n\t\t\t\t\t\t? RADEON_CRTC_V_SYNC_POL\n\t\t\t\t\t\t: 0)));\n\n\t\tfp_horz_vert_active = (((native_mode->vdisplay) & 0xfff) |\n\t\t\t\t(((native_mode->hdisplay / 8) & 0x1ff) << 16));\n\t\tbreak;\n\tcase RMX_OFF:\n\tdefault:\n\t\tfp_horz_stretch |= ((xres/8-1) << 16);\n\t\tfp_vert_stretch |= ((yres-1) << 12);\n\t\tbreak;\n\t}\n\n\tWREG32(RADEON_FP_HORZ_STRETCH,      fp_horz_stretch);\n\tWREG32(RADEON_FP_VERT_STRETCH,      fp_vert_stretch);\n\tWREG32(RADEON_CRTC_MORE_CNTL,       crtc_more_cntl);\n\tWREG32(RADEON_FP_HORZ_VERT_ACTIVE,  fp_horz_vert_active);\n\tWREG32(RADEON_FP_H_SYNC_STRT_WID,   fp_h_sync_strt_wid);\n\tWREG32(RADEON_FP_V_SYNC_STRT_WID,   fp_v_sync_strt_wid);\n\tWREG32(RADEON_FP_CRTC_H_TOTAL_DISP, fp_crtc_h_total_disp);\n\tWREG32(RADEON_FP_CRTC_V_TOTAL_DISP, fp_crtc_v_total_disp);\n}\n\nstatic void radeon_pll_wait_for_read_update_complete(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tint i = 0;\n\n\t \n\tfor (i = 0;\n\t     (i < 10000 &&\n\t      RREG32_PLL(RADEON_PPLL_REF_DIV) & RADEON_PPLL_ATOMIC_UPDATE_R);\n\t     i++);\n}\n\nstatic void radeon_pll_write_update(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\n\twhile (RREG32_PLL(RADEON_PPLL_REF_DIV) & RADEON_PPLL_ATOMIC_UPDATE_R);\n\n\tWREG32_PLL_P(RADEON_PPLL_REF_DIV,\n\t\t\t   RADEON_PPLL_ATOMIC_UPDATE_W,\n\t\t\t   ~(RADEON_PPLL_ATOMIC_UPDATE_W));\n}\n\nstatic void radeon_pll2_wait_for_read_update_complete(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tint i = 0;\n\n\n\t \n\tfor (i = 0;\n\t     (i < 10000 &&\n\t      RREG32_PLL(RADEON_P2PLL_REF_DIV) & RADEON_P2PLL_ATOMIC_UPDATE_R);\n\t     i++);\n}\n\nstatic void radeon_pll2_write_update(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\n\twhile (RREG32_PLL(RADEON_P2PLL_REF_DIV) & RADEON_P2PLL_ATOMIC_UPDATE_R);\n\n\tWREG32_PLL_P(RADEON_P2PLL_REF_DIV,\n\t\t\t   RADEON_P2PLL_ATOMIC_UPDATE_W,\n\t\t\t   ~(RADEON_P2PLL_ATOMIC_UPDATE_W));\n}\n\nstatic uint8_t radeon_compute_pll_gain(uint16_t ref_freq, uint16_t ref_div,\n\t\t\t\t       uint16_t fb_div)\n{\n\tunsigned int vcoFreq;\n\n\tif (!ref_div)\n\t\treturn 1;\n\n\tvcoFreq = ((unsigned)ref_freq * fb_div) / ref_div;\n\n\t \n\tif (vcoFreq >= 30000)\n\t\t \n\t\treturn 7;\n\telse if (vcoFreq >= 18000)\n\t\t \n\t\treturn 4;\n\telse\n\t\t \n\t\treturn 1;\n}\n\nstatic void radeon_crtc_dpms(struct drm_crtc *crtc, int mode)\n{\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tstruct drm_device *dev = crtc->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t crtc_ext_cntl = 0;\n\tuint32_t mask;\n\n\tif (radeon_crtc->crtc_id)\n\t\tmask = (RADEON_CRTC2_DISP_DIS |\n\t\t\tRADEON_CRTC2_VSYNC_DIS |\n\t\t\tRADEON_CRTC2_HSYNC_DIS |\n\t\t\tRADEON_CRTC2_DISP_REQ_EN_B);\n\telse\n\t\tmask = (RADEON_CRTC_DISPLAY_DIS |\n\t\t\tRADEON_CRTC_VSYNC_DIS |\n\t\t\tRADEON_CRTC_HSYNC_DIS);\n\n\t \n\tif (rdev->flags & RADEON_SINGLE_CRTC)\n\t\tcrtc_ext_cntl = RADEON_CRTC_CRT_ON;\n\n\tswitch (mode) {\n\tcase DRM_MODE_DPMS_ON:\n\t\tradeon_crtc->enabled = true;\n\t\t \n\t\tradeon_pm_compute_clocks(rdev);\n\t\tif (radeon_crtc->crtc_id)\n\t\t\tWREG32_P(RADEON_CRTC2_GEN_CNTL, RADEON_CRTC2_EN, ~(RADEON_CRTC2_EN | mask));\n\t\telse {\n\t\t\tWREG32_P(RADEON_CRTC_GEN_CNTL, RADEON_CRTC_EN, ~(RADEON_CRTC_EN |\n\t\t\t\t\t\t\t\t\t RADEON_CRTC_DISP_REQ_EN_B));\n\t\t\tWREG32_P(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl, ~(mask | crtc_ext_cntl));\n\t\t}\n\t\tif (dev->num_crtcs > radeon_crtc->crtc_id)\n\t\t\tdrm_crtc_vblank_on(crtc);\n\t\tradeon_crtc_load_lut(crtc);\n\t\tbreak;\n\tcase DRM_MODE_DPMS_STANDBY:\n\tcase DRM_MODE_DPMS_SUSPEND:\n\tcase DRM_MODE_DPMS_OFF:\n\t\tif (dev->num_crtcs > radeon_crtc->crtc_id)\n\t\t\tdrm_crtc_vblank_off(crtc);\n\t\tif (radeon_crtc->crtc_id)\n\t\t\tWREG32_P(RADEON_CRTC2_GEN_CNTL, mask, ~(RADEON_CRTC2_EN | mask));\n\t\telse {\n\t\t\tWREG32_P(RADEON_CRTC_GEN_CNTL, RADEON_CRTC_DISP_REQ_EN_B, ~(RADEON_CRTC_EN |\n\t\t\t\t\t\t\t\t\t\t    RADEON_CRTC_DISP_REQ_EN_B));\n\t\t\tWREG32_P(RADEON_CRTC_EXT_CNTL, mask, ~(mask | crtc_ext_cntl));\n\t\t}\n\t\tradeon_crtc->enabled = false;\n\t\t \n\t\tradeon_pm_compute_clocks(rdev);\n\t\tbreak;\n\t}\n}\n\nint radeon_crtc_set_base(struct drm_crtc *crtc, int x, int y,\n\t\t\t struct drm_framebuffer *old_fb)\n{\n\treturn radeon_crtc_do_set_base(crtc, old_fb, x, y, 0);\n}\n\nint radeon_crtc_set_base_atomic(struct drm_crtc *crtc,\n\t\t\t\tstruct drm_framebuffer *fb,\n\t\t\t\tint x, int y, enum mode_set_atomic state)\n{\n\treturn radeon_crtc_do_set_base(crtc, fb, x, y, 1);\n}\n\nint radeon_crtc_do_set_base(struct drm_crtc *crtc,\n\t\t\t struct drm_framebuffer *fb,\n\t\t\t int x, int y, int atomic)\n{\n\tstruct drm_device *dev = crtc->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tstruct drm_framebuffer *target_fb;\n\tstruct drm_gem_object *obj;\n\tstruct radeon_bo *rbo;\n\tuint64_t base;\n\tuint32_t crtc_offset, crtc_offset_cntl, crtc_tile_x0_y0 = 0;\n\tuint32_t crtc_pitch, pitch_pixels;\n\tuint32_t tiling_flags;\n\tint format;\n\tuint32_t gen_cntl_reg, gen_cntl_val;\n\tint r;\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\t \n\tif (!atomic && !crtc->primary->fb) {\n\t\tDRM_DEBUG_KMS(\"No FB bound\\n\");\n\t\treturn 0;\n\t}\n\n\tif (atomic)\n\t\ttarget_fb = fb;\n\telse\n\t\ttarget_fb = crtc->primary->fb;\n\n\tswitch (target_fb->format->cpp[0] * 8) {\n\tcase 8:\n\t\tformat = 2;\n\t\tbreak;\n\tcase 15:       \n\t\tformat = 3;\n\t\tbreak;\n\tcase 16:       \n\t\tformat = 4;\n\t\tbreak;\n\tcase 24:       \n\t\tformat = 5;\n\t\tbreak;\n\tcase 32:       \n\t\tformat = 6;\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\t \n\tobj = target_fb->obj[0];\n\trbo = gem_to_radeon_bo(obj);\nretry:\n\tr = radeon_bo_reserve(rbo, false);\n\tif (unlikely(r != 0))\n\t\treturn r;\n\t \n\tr = radeon_bo_pin_restricted(rbo, RADEON_GEM_DOMAIN_VRAM, 1 << 27,\n\t\t\t\t     &base);\n\tif (unlikely(r != 0)) {\n\t\tradeon_bo_unreserve(rbo);\n\n\t\t \n\t\tif (!atomic && fb && fb != crtc->primary->fb) {\n\t\t\tstruct radeon_bo *old_rbo;\n\t\t\tunsigned long nsize, osize;\n\n\t\t\told_rbo = gem_to_radeon_bo(fb->obj[0]);\n\t\t\tosize = radeon_bo_size(old_rbo);\n\t\t\tnsize = radeon_bo_size(rbo);\n\t\t\tif (nsize <= osize && !radeon_bo_reserve(old_rbo, false)) {\n\t\t\t\tradeon_bo_unpin(old_rbo);\n\t\t\t\tradeon_bo_unreserve(old_rbo);\n\t\t\t\tfb = NULL;\n\t\t\t\tgoto retry;\n\t\t\t}\n\t\t}\n\t\treturn -EINVAL;\n\t}\n\tradeon_bo_get_tiling_flags(rbo, &tiling_flags, NULL);\n\tradeon_bo_unreserve(rbo);\n\tif (tiling_flags & RADEON_TILING_MICRO)\n\t\tDRM_ERROR(\"trying to scanout microtiled buffer\\n\");\n\n\t \n\t \n\tradeon_crtc->legacy_display_base_addr = rdev->mc.vram_start;\n\n\tbase -= radeon_crtc->legacy_display_base_addr;\n\n\tcrtc_offset_cntl = 0;\n\n\tpitch_pixels = target_fb->pitches[0] / target_fb->format->cpp[0];\n\tcrtc_pitch = DIV_ROUND_UP(pitch_pixels * target_fb->format->cpp[0] * 8,\n\t\t\t\t  target_fb->format->cpp[0] * 8 * 8);\n\tcrtc_pitch |= crtc_pitch << 16;\n\n\tcrtc_offset_cntl |= RADEON_CRTC_GUI_TRIG_OFFSET_LEFT_EN;\n\tif (tiling_flags & RADEON_TILING_MACRO) {\n\t\tif (ASIC_IS_R300(rdev))\n\t\t\tcrtc_offset_cntl |= (R300_CRTC_X_Y_MODE_EN |\n\t\t\t\t\t     R300_CRTC_MICRO_TILE_BUFFER_DIS |\n\t\t\t\t\t     R300_CRTC_MACRO_TILE_EN);\n\t\telse\n\t\t\tcrtc_offset_cntl |= RADEON_CRTC_TILE_EN;\n\t} else {\n\t\tif (ASIC_IS_R300(rdev))\n\t\t\tcrtc_offset_cntl &= ~(R300_CRTC_X_Y_MODE_EN |\n\t\t\t\t\t      R300_CRTC_MICRO_TILE_BUFFER_DIS |\n\t\t\t\t\t      R300_CRTC_MACRO_TILE_EN);\n\t\telse\n\t\t\tcrtc_offset_cntl &= ~RADEON_CRTC_TILE_EN;\n\t}\n\n\tif (tiling_flags & RADEON_TILING_MACRO) {\n\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\tcrtc_tile_x0_y0 = x | (y << 16);\n\t\t\tbase &= ~0x7ff;\n\t\t} else {\n\t\t\tint byteshift = target_fb->format->cpp[0] * 8 >> 4;\n\t\t\tint tile_addr = (((y >> 3) * pitch_pixels +  x) >> (8 - byteshift)) << 11;\n\t\t\tbase += tile_addr + ((x << byteshift) % 256) + ((y % 8) << 8);\n\t\t\tcrtc_offset_cntl |= (y % 16);\n\t\t}\n\t} else {\n\t\tint offset = y * pitch_pixels + x;\n\t\tswitch (target_fb->format->cpp[0] * 8) {\n\t\tcase 8:\n\t\t\toffset *= 1;\n\t\t\tbreak;\n\t\tcase 15:\n\t\tcase 16:\n\t\t\toffset *= 2;\n\t\t\tbreak;\n\t\tcase 24:\n\t\t\toffset *= 3;\n\t\t\tbreak;\n\t\tcase 32:\n\t\t\toffset *= 4;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn false;\n\t\t}\n\t\tbase += offset;\n\t}\n\n\tbase &= ~7;\n\n\tif (radeon_crtc->crtc_id == 1)\n\t\tgen_cntl_reg = RADEON_CRTC2_GEN_CNTL;\n\telse\n\t\tgen_cntl_reg = RADEON_CRTC_GEN_CNTL;\n\n\tgen_cntl_val = RREG32(gen_cntl_reg);\n\tgen_cntl_val &= ~(0xf << 8);\n\tgen_cntl_val |= (format << 8);\n\tgen_cntl_val &= ~RADEON_CRTC_VSTAT_MODE_MASK;\n\tWREG32(gen_cntl_reg, gen_cntl_val);\n\n\tcrtc_offset = (u32)base;\n\n\tWREG32(RADEON_DISPLAY_BASE_ADDR + radeon_crtc->crtc_offset, radeon_crtc->legacy_display_base_addr);\n\n\tif (ASIC_IS_R300(rdev)) {\n\t\tif (radeon_crtc->crtc_id)\n\t\t\tWREG32(R300_CRTC2_TILE_X0_Y0, crtc_tile_x0_y0);\n\t\telse\n\t\t\tWREG32(R300_CRTC_TILE_X0_Y0, crtc_tile_x0_y0);\n\t}\n\tWREG32(RADEON_CRTC_OFFSET_CNTL + radeon_crtc->crtc_offset, crtc_offset_cntl);\n\tWREG32(RADEON_CRTC_OFFSET + radeon_crtc->crtc_offset, crtc_offset);\n\tWREG32(RADEON_CRTC_PITCH + radeon_crtc->crtc_offset, crtc_pitch);\n\n\tif (!atomic && fb && fb != crtc->primary->fb) {\n\t\trbo = gem_to_radeon_bo(fb->obj[0]);\n\t\tr = radeon_bo_reserve(rbo, false);\n\t\tif (unlikely(r != 0))\n\t\t\treturn r;\n\t\tradeon_bo_unpin(rbo);\n\t\tradeon_bo_unreserve(rbo);\n\t}\n\n\t \n\tradeon_bandwidth_update(rdev);\n\n\treturn 0;\n}\n\nstatic bool radeon_set_crtc_timing(struct drm_crtc *crtc, struct drm_display_mode *mode)\n{\n\tstruct drm_device *dev = crtc->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tconst struct drm_framebuffer *fb = crtc->primary->fb;\n\tstruct drm_encoder *encoder;\n\tint format;\n\tint hsync_start;\n\tint hsync_wid;\n\tint vsync_wid;\n\tuint32_t crtc_h_total_disp;\n\tuint32_t crtc_h_sync_strt_wid;\n\tuint32_t crtc_v_total_disp;\n\tuint32_t crtc_v_sync_strt_wid;\n\tbool is_tv = false;\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\tlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\n\t\tif (encoder->crtc == crtc) {\n\t\t\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\t\t\tif (radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT) {\n\t\t\t\tis_tv = true;\n\t\t\t\tDRM_INFO(\"crtc %d is connected to a TV\\n\", radeon_crtc->crtc_id);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tswitch (fb->format->cpp[0] * 8) {\n\tcase 8:\n\t\tformat = 2;\n\t\tbreak;\n\tcase 15:       \n\t\tformat = 3;\n\t\tbreak;\n\tcase 16:       \n\t\tformat = 4;\n\t\tbreak;\n\tcase 24:       \n\t\tformat = 5;\n\t\tbreak;\n\tcase 32:       \n\t\tformat = 6;\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\tcrtc_h_total_disp = ((((mode->crtc_htotal / 8) - 1) & 0x3ff)\n\t\t\t     | ((((mode->crtc_hdisplay / 8) - 1) & 0x1ff) << 16));\n\n\thsync_wid = (mode->crtc_hsync_end - mode->crtc_hsync_start) / 8;\n\tif (!hsync_wid)\n\t\thsync_wid = 1;\n\thsync_start = mode->crtc_hsync_start - 8;\n\n\tcrtc_h_sync_strt_wid = ((hsync_start & 0x1fff)\n\t\t\t\t| ((hsync_wid & 0x3f) << 16)\n\t\t\t\t| ((mode->flags & DRM_MODE_FLAG_NHSYNC)\n\t\t\t\t   ? RADEON_CRTC_H_SYNC_POL\n\t\t\t\t   : 0));\n\n\t \n\tcrtc_v_total_disp = (((mode->crtc_vtotal - 1) & 0xffff)\n\t\t\t     | ((mode->crtc_vdisplay - 1) << 16));\n\n\tvsync_wid = mode->crtc_vsync_end - mode->crtc_vsync_start;\n\tif (!vsync_wid)\n\t\tvsync_wid = 1;\n\n\tcrtc_v_sync_strt_wid = (((mode->crtc_vsync_start - 1) & 0xfff)\n\t\t\t\t| ((vsync_wid & 0x1f) << 16)\n\t\t\t\t| ((mode->flags & DRM_MODE_FLAG_NVSYNC)\n\t\t\t\t   ? RADEON_CRTC_V_SYNC_POL\n\t\t\t\t   : 0));\n\n\tif (radeon_crtc->crtc_id) {\n\t\tuint32_t crtc2_gen_cntl;\n\t\tuint32_t disp2_merge_cntl;\n\n\t\t \n\t\tcrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL) & 0x00718080;\n\t\tcrtc2_gen_cntl |= ((format << 8)\n\t\t\t\t   | RADEON_CRTC2_VSYNC_DIS\n\t\t\t\t   | RADEON_CRTC2_HSYNC_DIS\n\t\t\t\t   | RADEON_CRTC2_DISP_DIS\n\t\t\t\t   | RADEON_CRTC2_DISP_REQ_EN_B\n\t\t\t\t   | ((mode->flags & DRM_MODE_FLAG_DBLSCAN)\n\t\t\t\t      ? RADEON_CRTC2_DBL_SCAN_EN\n\t\t\t\t      : 0)\n\t\t\t\t   | ((mode->flags & DRM_MODE_FLAG_CSYNC)\n\t\t\t\t      ? RADEON_CRTC2_CSYNC_EN\n\t\t\t\t      : 0)\n\t\t\t\t   | ((mode->flags & DRM_MODE_FLAG_INTERLACE)\n\t\t\t\t      ? RADEON_CRTC2_INTERLACE_EN\n\t\t\t\t      : 0));\n\n\t\t \n\t\tif ((rdev->family == CHIP_RS400) || (rdev->family == CHIP_RS480))\n\t\t\tcrtc2_gen_cntl |= RADEON_CRTC2_EN;\n\n\t\tdisp2_merge_cntl = RREG32(RADEON_DISP2_MERGE_CNTL);\n\t\tdisp2_merge_cntl &= ~RADEON_DISP2_RGB_OFFSET_EN;\n\n\t\tWREG32(RADEON_DISP2_MERGE_CNTL, disp2_merge_cntl);\n\t\tWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\n\n\t\tWREG32(RADEON_FP_H2_SYNC_STRT_WID, crtc_h_sync_strt_wid);\n\t\tWREG32(RADEON_FP_V2_SYNC_STRT_WID, crtc_v_sync_strt_wid);\n\t} else {\n\t\tuint32_t crtc_gen_cntl;\n\t\tuint32_t crtc_ext_cntl;\n\t\tuint32_t disp_merge_cntl;\n\n\t\tcrtc_gen_cntl = RREG32(RADEON_CRTC_GEN_CNTL) & 0x00718000;\n\t\tcrtc_gen_cntl |= (RADEON_CRTC_EXT_DISP_EN\n\t\t\t\t | (format << 8)\n\t\t\t\t | RADEON_CRTC_DISP_REQ_EN_B\n\t\t\t\t | ((mode->flags & DRM_MODE_FLAG_DBLSCAN)\n\t\t\t\t    ? RADEON_CRTC_DBL_SCAN_EN\n\t\t\t\t    : 0)\n\t\t\t\t | ((mode->flags & DRM_MODE_FLAG_CSYNC)\n\t\t\t\t    ? RADEON_CRTC_CSYNC_EN\n\t\t\t\t    : 0)\n\t\t\t\t | ((mode->flags & DRM_MODE_FLAG_INTERLACE)\n\t\t\t\t    ? RADEON_CRTC_INTERLACE_EN\n\t\t\t\t    : 0));\n\n\t\t \n\t\tif ((rdev->family == CHIP_RS400) || (rdev->family == CHIP_RS480))\n\t\t\tcrtc_gen_cntl |= RADEON_CRTC_EN;\n\n\t\tcrtc_ext_cntl = RREG32(RADEON_CRTC_EXT_CNTL);\n\t\tcrtc_ext_cntl |= (RADEON_XCRT_CNT_EN |\n\t\t\t\t  RADEON_CRTC_VSYNC_DIS |\n\t\t\t\t  RADEON_CRTC_HSYNC_DIS |\n\t\t\t\t  RADEON_CRTC_DISPLAY_DIS);\n\n\t\tdisp_merge_cntl = RREG32(RADEON_DISP_MERGE_CNTL);\n\t\tdisp_merge_cntl &= ~RADEON_DISP_RGB_OFFSET_EN;\n\n\t\tWREG32(RADEON_DISP_MERGE_CNTL, disp_merge_cntl);\n\t\tWREG32(RADEON_CRTC_GEN_CNTL, crtc_gen_cntl);\n\t\tWREG32(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl);\n\t}\n\n\tif (is_tv)\n\t\tradeon_legacy_tv_adjust_crtc_reg(encoder, &crtc_h_total_disp,\n\t\t\t\t\t\t &crtc_h_sync_strt_wid, &crtc_v_total_disp,\n\t\t\t\t\t\t &crtc_v_sync_strt_wid);\n\n\tWREG32(RADEON_CRTC_H_TOTAL_DISP + radeon_crtc->crtc_offset, crtc_h_total_disp);\n\tWREG32(RADEON_CRTC_H_SYNC_STRT_WID + radeon_crtc->crtc_offset, crtc_h_sync_strt_wid);\n\tWREG32(RADEON_CRTC_V_TOTAL_DISP + radeon_crtc->crtc_offset, crtc_v_total_disp);\n\tWREG32(RADEON_CRTC_V_SYNC_STRT_WID + radeon_crtc->crtc_offset, crtc_v_sync_strt_wid);\n\n\treturn true;\n}\n\nstatic void radeon_set_pll(struct drm_crtc *crtc, struct drm_display_mode *mode)\n{\n\tstruct drm_device *dev = crtc->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tstruct drm_encoder *encoder;\n\tuint32_t feedback_div = 0;\n\tuint32_t frac_fb_div = 0;\n\tuint32_t reference_div = 0;\n\tuint32_t post_divider = 0;\n\tuint32_t freq = 0;\n\tuint8_t pll_gain;\n\tbool use_bios_divs = false;\n\t \n\tuint32_t pll_ref_div = 0;\n\tuint32_t pll_fb_post_div = 0;\n\tuint32_t htotal_cntl = 0;\n\tbool is_tv = false;\n\tstruct radeon_pll *pll;\n\n\tstruct {\n\t\tint divider;\n\t\tint bitvalue;\n\t} *post_div, post_divs[]   = {\n\t\t \n\t\t{  1, 0 },               \n\t\t{  2, 1 },               \n\t\t{  4, 2 },               \n\t\t{  8, 3 },               \n\t\t{  3, 4 },               \n\t\t{ 16, 5 },               \n\t\t{  6, 6 },               \n\t\t{ 12, 7 },               \n\t\t{  0, 0 }\n\t};\n\n\tif (radeon_crtc->crtc_id)\n\t\tpll = &rdev->clock.p2pll;\n\telse\n\t\tpll = &rdev->clock.p1pll;\n\n\tpll->flags = RADEON_PLL_LEGACY;\n\n\tif (mode->clock > 200000)  \n\t\tpll->flags |= RADEON_PLL_PREFER_HIGH_FB_DIV;\n\telse\n\t\tpll->flags |= RADEON_PLL_PREFER_LOW_REF_DIV;\n\n\tlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\n\t\tif (encoder->crtc == crtc) {\n\t\t\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\n\t\t\tif (radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT) {\n\t\t\t\tis_tv = true;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (encoder->encoder_type != DRM_MODE_ENCODER_DAC)\n\t\t\t\tpll->flags |= RADEON_PLL_NO_ODD_POST_DIV;\n\t\t\tif (encoder->encoder_type == DRM_MODE_ENCODER_LVDS) {\n\t\t\t\tif (!rdev->is_atom_bios) {\n\t\t\t\t\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\t\t\t\t\tstruct radeon_encoder_lvds *lvds = (struct radeon_encoder_lvds *)radeon_encoder->enc_priv;\n\t\t\t\t\tif (lvds) {\n\t\t\t\t\t\tif (lvds->use_bios_dividers) {\n\t\t\t\t\t\t\tpll_ref_div = lvds->panel_ref_divider;\n\t\t\t\t\t\t\tpll_fb_post_div   = (lvds->panel_fb_divider |\n\t\t\t\t\t\t\t\t\t     (lvds->panel_post_divider << 16));\n\t\t\t\t\t\t\thtotal_cntl  = 0;\n\t\t\t\t\t\t\tuse_bios_divs = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tpll->flags |= RADEON_PLL_USE_REF_DIV;\n\t\t\t}\n\t\t}\n\t}\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tif (!use_bios_divs) {\n\t\tradeon_compute_pll_legacy(pll, mode->clock,\n\t\t\t\t\t  &freq, &feedback_div, &frac_fb_div,\n\t\t\t\t\t  &reference_div, &post_divider);\n\n\t\tfor (post_div = &post_divs[0]; post_div->divider; ++post_div) {\n\t\t\tif (post_div->divider == post_divider)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (!post_div->divider)\n\t\t\tpost_div = &post_divs[0];\n\n\t\tDRM_DEBUG_KMS(\"dc=%u, fd=%d, rd=%d, pd=%d\\n\",\n\t\t\t  (unsigned)freq,\n\t\t\t  feedback_div,\n\t\t\t  reference_div,\n\t\t\t  post_divider);\n\n\t\tpll_ref_div   = reference_div;\n#if defined(__powerpc__) && (0)  \n\t\t \n\t\tif (info->MacModel == RADEON_MAC_IBOOK)\n\t\t\tpll_fb_post_div = 0x000600ad;\n\t\telse\n#endif\n\t\t\tpll_fb_post_div     = (feedback_div | (post_div->bitvalue << 16));\n\n\t\thtotal_cntl    = mode->htotal & 0x7;\n\n\t}\n\n\tpll_gain = radeon_compute_pll_gain(pll->reference_freq,\n\t\t\t\t\t   pll_ref_div & 0x3ff,\n\t\t\t\t\t   pll_fb_post_div & 0x7ff);\n\n\tif (radeon_crtc->crtc_id) {\n\t\tuint32_t pixclks_cntl = ((RREG32_PLL(RADEON_PIXCLKS_CNTL) &\n\t\t\t\t\t  ~(RADEON_PIX2CLK_SRC_SEL_MASK)) |\n\t\t\t\t\t RADEON_PIX2CLK_SRC_SEL_P2PLLCLK);\n\n\t\tif (is_tv) {\n\t\t\tradeon_legacy_tv_adjust_pll2(encoder, &htotal_cntl,\n\t\t\t\t\t\t     &pll_ref_div, &pll_fb_post_div,\n\t\t\t\t\t\t     &pixclks_cntl);\n\t\t}\n\n\t\tWREG32_PLL_P(RADEON_PIXCLKS_CNTL,\n\t\t\t     RADEON_PIX2CLK_SRC_SEL_CPUCLK,\n\t\t\t     ~(RADEON_PIX2CLK_SRC_SEL_MASK));\n\n\t\tWREG32_PLL_P(RADEON_P2PLL_CNTL,\n\t\t\t     RADEON_P2PLL_RESET\n\t\t\t     | RADEON_P2PLL_ATOMIC_UPDATE_EN\n\t\t\t     | ((uint32_t)pll_gain << RADEON_P2PLL_PVG_SHIFT),\n\t\t\t     ~(RADEON_P2PLL_RESET\n\t\t\t       | RADEON_P2PLL_ATOMIC_UPDATE_EN\n\t\t\t       | RADEON_P2PLL_PVG_MASK));\n\n\t\tWREG32_PLL_P(RADEON_P2PLL_REF_DIV,\n\t\t\t     pll_ref_div,\n\t\t\t     ~RADEON_P2PLL_REF_DIV_MASK);\n\n\t\tWREG32_PLL_P(RADEON_P2PLL_DIV_0,\n\t\t\t     pll_fb_post_div,\n\t\t\t     ~RADEON_P2PLL_FB0_DIV_MASK);\n\n\t\tWREG32_PLL_P(RADEON_P2PLL_DIV_0,\n\t\t\t     pll_fb_post_div,\n\t\t\t     ~RADEON_P2PLL_POST0_DIV_MASK);\n\n\t\tradeon_pll2_write_update(dev);\n\t\tradeon_pll2_wait_for_read_update_complete(dev);\n\n\t\tWREG32_PLL(RADEON_HTOTAL2_CNTL, htotal_cntl);\n\n\t\tWREG32_PLL_P(RADEON_P2PLL_CNTL,\n\t\t\t     0,\n\t\t\t     ~(RADEON_P2PLL_RESET\n\t\t\t       | RADEON_P2PLL_SLEEP\n\t\t\t       | RADEON_P2PLL_ATOMIC_UPDATE_EN));\n\n\t\tDRM_DEBUG_KMS(\"Wrote2: 0x%08x 0x%08x 0x%08x (0x%08x)\\n\",\n\t\t\t  (unsigned)pll_ref_div,\n\t\t\t  (unsigned)pll_fb_post_div,\n\t\t\t  (unsigned)htotal_cntl,\n\t\t\t  RREG32_PLL(RADEON_P2PLL_CNTL));\n\t\tDRM_DEBUG_KMS(\"Wrote2: rd=%u, fd=%u, pd=%u\\n\",\n\t\t\t  (unsigned)pll_ref_div & RADEON_P2PLL_REF_DIV_MASK,\n\t\t\t  (unsigned)pll_fb_post_div & RADEON_P2PLL_FB0_DIV_MASK,\n\t\t\t  (unsigned)((pll_fb_post_div &\n\t\t\t\t      RADEON_P2PLL_POST0_DIV_MASK) >> 16));\n\n\t\tmdelay(50);  \n\n\t\tWREG32_PLL_P(RADEON_PIXCLKS_CNTL,\n\t\t\t     RADEON_PIX2CLK_SRC_SEL_P2PLLCLK,\n\t\t\t     ~(RADEON_PIX2CLK_SRC_SEL_MASK));\n\n\t\tWREG32_PLL(RADEON_PIXCLKS_CNTL, pixclks_cntl);\n\t} else {\n\t\tuint32_t pixclks_cntl;\n\n\n\t\tif (is_tv) {\n\t\t\tpixclks_cntl = RREG32_PLL(RADEON_PIXCLKS_CNTL);\n\t\t\tradeon_legacy_tv_adjust_pll1(encoder, &htotal_cntl, &pll_ref_div,\n\t\t\t\t\t\t     &pll_fb_post_div, &pixclks_cntl);\n\t\t}\n\n\t\tif (rdev->flags & RADEON_IS_MOBILITY) {\n\t\t\t \n\t\t\tif ((pll_ref_div == (RREG32_PLL(RADEON_PPLL_REF_DIV) & RADEON_PPLL_REF_DIV_MASK)) &&\n\t\t\t    (pll_fb_post_div == (RREG32_PLL(RADEON_PPLL_DIV_3) &\n\t\t\t\t\t\t (RADEON_PPLL_POST3_DIV_MASK | RADEON_PPLL_FB3_DIV_MASK)))) {\n\t\t\t\tWREG32_P(RADEON_CLOCK_CNTL_INDEX,\n\t\t\t\t\t RADEON_PLL_DIV_SEL,\n\t\t\t\t\t ~(RADEON_PLL_DIV_SEL));\n\t\t\t\tr100_pll_errata_after_index(rdev);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tWREG32_PLL_P(RADEON_VCLK_ECP_CNTL,\n\t\t\t     RADEON_VCLK_SRC_SEL_CPUCLK,\n\t\t\t     ~(RADEON_VCLK_SRC_SEL_MASK));\n\t\tWREG32_PLL_P(RADEON_PPLL_CNTL,\n\t\t\t     RADEON_PPLL_RESET\n\t\t\t     | RADEON_PPLL_ATOMIC_UPDATE_EN\n\t\t\t     | RADEON_PPLL_VGA_ATOMIC_UPDATE_EN\n\t\t\t     | ((uint32_t)pll_gain << RADEON_PPLL_PVG_SHIFT),\n\t\t\t     ~(RADEON_PPLL_RESET\n\t\t\t       | RADEON_PPLL_ATOMIC_UPDATE_EN\n\t\t\t       | RADEON_PPLL_VGA_ATOMIC_UPDATE_EN\n\t\t\t       | RADEON_PPLL_PVG_MASK));\n\n\t\tWREG32_P(RADEON_CLOCK_CNTL_INDEX,\n\t\t\t RADEON_PLL_DIV_SEL,\n\t\t\t ~(RADEON_PLL_DIV_SEL));\n\t\tr100_pll_errata_after_index(rdev);\n\n\t\tif (ASIC_IS_R300(rdev) ||\n\t\t    (rdev->family == CHIP_RS300) ||\n\t\t    (rdev->family == CHIP_RS400) ||\n\t\t    (rdev->family == CHIP_RS480)) {\n\t\t\tif (pll_ref_div & R300_PPLL_REF_DIV_ACC_MASK) {\n\t\t\t\t \n\t\t\t\tWREG32_PLL_P(RADEON_PPLL_REF_DIV,\n\t\t\t\t\t     pll_ref_div,\n\t\t\t\t\t     0);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tWREG32_PLL_P(RADEON_PPLL_REF_DIV,\n\t\t\t\t\t     (pll_ref_div << R300_PPLL_REF_DIV_ACC_SHIFT),\n\t\t\t\t\t     ~R300_PPLL_REF_DIV_ACC_MASK);\n\t\t\t}\n\t\t} else\n\t\t\tWREG32_PLL_P(RADEON_PPLL_REF_DIV,\n\t\t\t\t     pll_ref_div,\n\t\t\t\t     ~RADEON_PPLL_REF_DIV_MASK);\n\n\t\tWREG32_PLL_P(RADEON_PPLL_DIV_3,\n\t\t\t     pll_fb_post_div,\n\t\t\t     ~RADEON_PPLL_FB3_DIV_MASK);\n\n\t\tWREG32_PLL_P(RADEON_PPLL_DIV_3,\n\t\t\t     pll_fb_post_div,\n\t\t\t     ~RADEON_PPLL_POST3_DIV_MASK);\n\n\t\tradeon_pll_write_update(dev);\n\t\tradeon_pll_wait_for_read_update_complete(dev);\n\n\t\tWREG32_PLL(RADEON_HTOTAL_CNTL, htotal_cntl);\n\n\t\tWREG32_PLL_P(RADEON_PPLL_CNTL,\n\t\t\t     0,\n\t\t\t     ~(RADEON_PPLL_RESET\n\t\t\t       | RADEON_PPLL_SLEEP\n\t\t\t       | RADEON_PPLL_ATOMIC_UPDATE_EN\n\t\t\t       | RADEON_PPLL_VGA_ATOMIC_UPDATE_EN));\n\n\t\tDRM_DEBUG_KMS(\"Wrote: 0x%08x 0x%08x 0x%08x (0x%08x)\\n\",\n\t\t\t  pll_ref_div,\n\t\t\t  pll_fb_post_div,\n\t\t\t  (unsigned)htotal_cntl,\n\t\t\t  RREG32_PLL(RADEON_PPLL_CNTL));\n\t\tDRM_DEBUG_KMS(\"Wrote: rd=%d, fd=%d, pd=%d\\n\",\n\t\t\t  pll_ref_div & RADEON_PPLL_REF_DIV_MASK,\n\t\t\t  pll_fb_post_div & RADEON_PPLL_FB3_DIV_MASK,\n\t\t\t  (pll_fb_post_div & RADEON_PPLL_POST3_DIV_MASK) >> 16);\n\n\t\tmdelay(50);  \n\n\t\tWREG32_PLL_P(RADEON_VCLK_ECP_CNTL,\n\t\t\t     RADEON_VCLK_SRC_SEL_PPLLCLK,\n\t\t\t     ~(RADEON_VCLK_SRC_SEL_MASK));\n\n\t\tif (is_tv)\n\t\t\tWREG32_PLL(RADEON_PIXCLKS_CNTL, pixclks_cntl);\n\t}\n}\n\nstatic bool radeon_crtc_mode_fixup(struct drm_crtc *crtc,\n\t\t\t\t   const struct drm_display_mode *mode,\n\t\t\t\t   struct drm_display_mode *adjusted_mode)\n{\n\tif (!radeon_crtc_scaling_mode_fixup(crtc, mode, adjusted_mode))\n\t\treturn false;\n\treturn true;\n}\n\nstatic int radeon_crtc_mode_set(struct drm_crtc *crtc,\n\t\t\t\t struct drm_display_mode *mode,\n\t\t\t\t struct drm_display_mode *adjusted_mode,\n\t\t\t\t int x, int y, struct drm_framebuffer *old_fb)\n{\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\n\t \n\tradeon_crtc_set_base(crtc, x, y, old_fb);\n\tradeon_set_crtc_timing(crtc, adjusted_mode);\n\tradeon_set_pll(crtc, adjusted_mode);\n\tradeon_overscan_setup(crtc, adjusted_mode);\n\tif (radeon_crtc->crtc_id == 0) {\n\t\tradeon_legacy_rmx_mode_set(crtc, adjusted_mode);\n\t} else {\n\t\tif (radeon_crtc->rmx_type != RMX_OFF) {\n\t\t\t \n\t\t\tDRM_ERROR(\"Mode need scaling but only first crtc can do that.\\n\");\n\t\t}\n\t}\n\tradeon_cursor_reset(crtc);\n\treturn 0;\n}\n\nstatic void radeon_crtc_prepare(struct drm_crtc *crtc)\n{\n\tstruct drm_device *dev = crtc->dev;\n\tstruct drm_crtc *crtci;\n\n\t \n\tlist_for_each_entry(crtci, &dev->mode_config.crtc_list, head)\n\t\tradeon_crtc_dpms(crtci, DRM_MODE_DPMS_OFF);\n}\n\nstatic void radeon_crtc_commit(struct drm_crtc *crtc)\n{\n\tstruct drm_device *dev = crtc->dev;\n\tstruct drm_crtc *crtci;\n\n\t \n\tlist_for_each_entry(crtci, &dev->mode_config.crtc_list, head) {\n\t\tif (crtci->enabled)\n\t\t\tradeon_crtc_dpms(crtci, DRM_MODE_DPMS_ON);\n\t}\n}\n\nstatic void radeon_crtc_disable(struct drm_crtc *crtc)\n{\n\tradeon_crtc_dpms(crtc, DRM_MODE_DPMS_OFF);\n\tif (crtc->primary->fb) {\n\t\tint r;\n\t\tstruct radeon_bo *rbo;\n\n\t\trbo = gem_to_radeon_bo(crtc->primary->fb->obj[0]);\n\t\tr = radeon_bo_reserve(rbo, false);\n\t\tif (unlikely(r))\n\t\t\tDRM_ERROR(\"failed to reserve rbo before unpin\\n\");\n\t\telse {\n\t\t\tradeon_bo_unpin(rbo);\n\t\t\tradeon_bo_unreserve(rbo);\n\t\t}\n\t}\n}\n\nstatic const struct drm_crtc_helper_funcs legacy_helper_funcs = {\n\t.dpms = radeon_crtc_dpms,\n\t.mode_fixup = radeon_crtc_mode_fixup,\n\t.mode_set = radeon_crtc_mode_set,\n\t.mode_set_base = radeon_crtc_set_base,\n\t.mode_set_base_atomic = radeon_crtc_set_base_atomic,\n\t.prepare = radeon_crtc_prepare,\n\t.commit = radeon_crtc_commit,\n\t.disable = radeon_crtc_disable,\n\t.get_scanout_position = radeon_get_crtc_scanout_position,\n};\n\n\nvoid radeon_legacy_init_crtc(struct drm_device *dev,\n\t\t\t       struct radeon_crtc *radeon_crtc)\n{\n\tif (radeon_crtc->crtc_id == 1)\n\t\tradeon_crtc->crtc_offset = RADEON_CRTC2_H_TOTAL_DISP - RADEON_CRTC_H_TOTAL_DISP;\n\tdrm_crtc_helper_add(&radeon_crtc->base, &legacy_helper_funcs);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}