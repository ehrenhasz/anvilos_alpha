{
  "module_name": "radeon_cursor.c",
  "hash_id": "c19b3914a2fab694c42d6f6645a1f9240a0360acdbba73db25871edec5fcb951",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/radeon_cursor.c",
  "human_readable_source": " \n\n#include <drm/drm_device.h>\n#include <drm/radeon_drm.h>\n\n#include \"radeon.h\"\n\nstatic void radeon_lock_cursor(struct drm_crtc *crtc, bool lock)\n{\n\tstruct radeon_device *rdev = crtc->dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tuint32_t cur_lock;\n\n\tif (ASIC_IS_DCE4(rdev)) {\n\t\tcur_lock = RREG32(EVERGREEN_CUR_UPDATE + radeon_crtc->crtc_offset);\n\t\tif (lock)\n\t\t\tcur_lock |= EVERGREEN_CURSOR_UPDATE_LOCK;\n\t\telse\n\t\t\tcur_lock &= ~EVERGREEN_CURSOR_UPDATE_LOCK;\n\t\tWREG32(EVERGREEN_CUR_UPDATE + radeon_crtc->crtc_offset, cur_lock);\n\t} else if (ASIC_IS_AVIVO(rdev)) {\n\t\tcur_lock = RREG32(AVIVO_D1CUR_UPDATE + radeon_crtc->crtc_offset);\n\t\tif (lock)\n\t\t\tcur_lock |= AVIVO_D1CURSOR_UPDATE_LOCK;\n\t\telse\n\t\t\tcur_lock &= ~AVIVO_D1CURSOR_UPDATE_LOCK;\n\t\tWREG32(AVIVO_D1CUR_UPDATE + radeon_crtc->crtc_offset, cur_lock);\n\t} else {\n\t\tcur_lock = RREG32(RADEON_CUR_OFFSET + radeon_crtc->crtc_offset);\n\t\tif (lock)\n\t\t\tcur_lock |= RADEON_CUR_LOCK;\n\t\telse\n\t\t\tcur_lock &= ~RADEON_CUR_LOCK;\n\t\tWREG32(RADEON_CUR_OFFSET + radeon_crtc->crtc_offset, cur_lock);\n\t}\n}\n\nstatic void radeon_hide_cursor(struct drm_crtc *crtc)\n{\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tstruct radeon_device *rdev = crtc->dev->dev_private;\n\n\tif (ASIC_IS_DCE4(rdev)) {\n\t\tWREG32_IDX(EVERGREEN_CUR_CONTROL + radeon_crtc->crtc_offset,\n\t\t\t   EVERGREEN_CURSOR_MODE(EVERGREEN_CURSOR_24_8_PRE_MULT) |\n\t\t\t   EVERGREEN_CURSOR_URGENT_CONTROL(EVERGREEN_CURSOR_URGENT_1_2));\n\t} else if (ASIC_IS_AVIVO(rdev)) {\n\t\tWREG32_IDX(AVIVO_D1CUR_CONTROL + radeon_crtc->crtc_offset,\n\t\t\t   (AVIVO_D1CURSOR_MODE_24BPP << AVIVO_D1CURSOR_MODE_SHIFT));\n\t} else {\n\t\tu32 reg;\n\t\tswitch (radeon_crtc->crtc_id) {\n\t\tcase 0:\n\t\t\treg = RADEON_CRTC_GEN_CNTL;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\treg = RADEON_CRTC2_GEN_CNTL;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn;\n\t\t}\n\t\tWREG32_IDX(reg, RREG32_IDX(reg) & ~RADEON_CRTC_CUR_EN);\n\t}\n}\n\nstatic void radeon_show_cursor(struct drm_crtc *crtc)\n{\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tstruct radeon_device *rdev = crtc->dev->dev_private;\n\n\tif (radeon_crtc->cursor_out_of_bounds)\n\t\treturn;\n\n\tif (ASIC_IS_DCE4(rdev)) {\n\t\tWREG32(EVERGREEN_CUR_SURFACE_ADDRESS_HIGH + radeon_crtc->crtc_offset,\n\t\t       upper_32_bits(radeon_crtc->cursor_addr));\n\t\tWREG32(EVERGREEN_CUR_SURFACE_ADDRESS + radeon_crtc->crtc_offset,\n\t\t       lower_32_bits(radeon_crtc->cursor_addr));\n\t\tWREG32(RADEON_MM_INDEX, EVERGREEN_CUR_CONTROL + radeon_crtc->crtc_offset);\n\t\tWREG32(RADEON_MM_DATA, EVERGREEN_CURSOR_EN |\n\t\t       EVERGREEN_CURSOR_MODE(EVERGREEN_CURSOR_24_8_PRE_MULT) |\n\t\t       EVERGREEN_CURSOR_URGENT_CONTROL(EVERGREEN_CURSOR_URGENT_1_2));\n\t} else if (ASIC_IS_AVIVO(rdev)) {\n\t\tif (rdev->family >= CHIP_RV770) {\n\t\t\tif (radeon_crtc->crtc_id)\n\t\t\t\tWREG32(R700_D2CUR_SURFACE_ADDRESS_HIGH,\n\t\t\t\t       upper_32_bits(radeon_crtc->cursor_addr));\n\t\t\telse\n\t\t\t\tWREG32(R700_D1CUR_SURFACE_ADDRESS_HIGH,\n\t\t\t\t       upper_32_bits(radeon_crtc->cursor_addr));\n\t\t}\n\n\t\tWREG32(AVIVO_D1CUR_SURFACE_ADDRESS + radeon_crtc->crtc_offset,\n\t\t       lower_32_bits(radeon_crtc->cursor_addr));\n\t\tWREG32(RADEON_MM_INDEX, AVIVO_D1CUR_CONTROL + radeon_crtc->crtc_offset);\n\t\tWREG32(RADEON_MM_DATA, AVIVO_D1CURSOR_EN |\n\t\t       (AVIVO_D1CURSOR_MODE_24BPP << AVIVO_D1CURSOR_MODE_SHIFT));\n\t} else {\n\t\t \n\t\tWREG32(RADEON_CUR_OFFSET + radeon_crtc->crtc_offset,\n\t\t       radeon_crtc->cursor_addr - radeon_crtc->legacy_display_base_addr);\n\n\t\tswitch (radeon_crtc->crtc_id) {\n\t\tcase 0:\n\t\t\tWREG32(RADEON_MM_INDEX, RADEON_CRTC_GEN_CNTL);\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tWREG32(RADEON_MM_INDEX, RADEON_CRTC2_GEN_CNTL);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn;\n\t\t}\n\n\t\tWREG32_P(RADEON_MM_DATA, (RADEON_CRTC_CUR_EN |\n\t\t\t\t\t  (RADEON_CRTC_CUR_MODE_24BPP << RADEON_CRTC_CUR_MODE_SHIFT)),\n\t\t\t ~(RADEON_CRTC_CUR_EN | RADEON_CRTC_CUR_MODE_MASK));\n\t}\n}\n\nstatic int radeon_cursor_move_locked(struct drm_crtc *crtc, int x, int y)\n{\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tstruct radeon_device *rdev = crtc->dev->dev_private;\n\tint xorigin = 0, yorigin = 0;\n\tint w = radeon_crtc->cursor_width;\n\n\tradeon_crtc->cursor_x = x;\n\tradeon_crtc->cursor_y = y;\n\n\tif (ASIC_IS_AVIVO(rdev)) {\n\t\t \n\t\tx += crtc->x;\n\t\ty += crtc->y;\n\t}\n\n\tif (x < 0)\n\t\txorigin = min(-x, radeon_crtc->max_cursor_width - 1);\n\tif (y < 0)\n\t\tyorigin = min(-y, radeon_crtc->max_cursor_height - 1);\n\n\tif (!ASIC_IS_AVIVO(rdev)) {\n\t\tx += crtc->x;\n\t\ty += crtc->y;\n\t}\n\tDRM_DEBUG(\"x %d y %d c->x %d c->y %d\\n\", x, y, crtc->x, crtc->y);\n\n\t \n\tif (ASIC_IS_AVIVO(rdev) && !ASIC_IS_DCE6(rdev)) {\n\t\tint i = 0;\n\t\tstruct drm_crtc *crtc_p;\n\n\t\t \n\t\tlist_for_each_entry(crtc_p, &crtc->dev->mode_config.crtc_list, head) {\n\t\t\tif (crtc_p->enabled)\n\t\t\t\ti++;\n\t\t}\n\t\tif (i > 1) {\n\t\t\tint cursor_end, frame_end;\n\n\t\t\tcursor_end = x + w;\n\t\t\tframe_end = crtc->x + crtc->mode.crtc_hdisplay;\n\t\t\tif (cursor_end >= frame_end) {\n\t\t\t\tw = w - (cursor_end - frame_end);\n\t\t\t\tif (!(frame_end & 0x7f))\n\t\t\t\t\tw--;\n\t\t\t} else if (cursor_end <= 0) {\n\t\t\t\tgoto out_of_bounds;\n\t\t\t} else if (!(cursor_end & 0x7f)) {\n\t\t\t\tw--;\n\t\t\t}\n\t\t\tif (w <= 0) {\n\t\t\t\tgoto out_of_bounds;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (x <= (crtc->x - w) || y <= (crtc->y - radeon_crtc->cursor_height) ||\n\t    x >= (crtc->x + crtc->mode.hdisplay) ||\n\t    y >= (crtc->y + crtc->mode.vdisplay))\n\t\tgoto out_of_bounds;\n\n\tx += xorigin;\n\ty += yorigin;\n\n\tif (ASIC_IS_DCE4(rdev)) {\n\t\tWREG32(EVERGREEN_CUR_POSITION + radeon_crtc->crtc_offset, (x << 16) | y);\n\t\tWREG32(EVERGREEN_CUR_HOT_SPOT + radeon_crtc->crtc_offset, (xorigin << 16) | yorigin);\n\t\tWREG32(EVERGREEN_CUR_SIZE + radeon_crtc->crtc_offset,\n\t\t       ((w - 1) << 16) | (radeon_crtc->cursor_height - 1));\n\t} else if (ASIC_IS_AVIVO(rdev)) {\n\t\tWREG32(AVIVO_D1CUR_POSITION + radeon_crtc->crtc_offset, (x << 16) | y);\n\t\tWREG32(AVIVO_D1CUR_HOT_SPOT + radeon_crtc->crtc_offset, (xorigin << 16) | yorigin);\n\t\tWREG32(AVIVO_D1CUR_SIZE + radeon_crtc->crtc_offset,\n\t\t       ((w - 1) << 16) | (radeon_crtc->cursor_height - 1));\n\t} else {\n\t\tx -= crtc->x;\n\t\ty -= crtc->y;\n\n\t\tif (crtc->mode.flags & DRM_MODE_FLAG_DBLSCAN)\n\t\t\ty *= 2;\n\n\t\tWREG32(RADEON_CUR_HORZ_VERT_OFF + radeon_crtc->crtc_offset,\n\t\t       (RADEON_CUR_LOCK\n\t\t\t| (xorigin << 16)\n\t\t\t| yorigin));\n\t\tWREG32(RADEON_CUR_HORZ_VERT_POSN + radeon_crtc->crtc_offset,\n\t\t       (RADEON_CUR_LOCK\n\t\t\t| (x << 16)\n\t\t\t| y));\n\t\t \n\t\tWREG32(RADEON_CUR_OFFSET + radeon_crtc->crtc_offset,\n\t\t       radeon_crtc->cursor_addr - radeon_crtc->legacy_display_base_addr +\n\t\t       yorigin * 256);\n\t}\n\n\tif (radeon_crtc->cursor_out_of_bounds) {\n\t\tradeon_crtc->cursor_out_of_bounds = false;\n\t\tif (radeon_crtc->cursor_bo)\n\t\t\tradeon_show_cursor(crtc);\n\t}\n\n\treturn 0;\n\n out_of_bounds:\n\tif (!radeon_crtc->cursor_out_of_bounds) {\n\t\tradeon_hide_cursor(crtc);\n\t\tradeon_crtc->cursor_out_of_bounds = true;\n\t}\n\treturn 0;\n}\n\nint radeon_crtc_cursor_move(struct drm_crtc *crtc,\n\t\t\t    int x, int y)\n{\n\tint ret;\n\n\tradeon_lock_cursor(crtc, true);\n\tret = radeon_cursor_move_locked(crtc, x, y);\n\tradeon_lock_cursor(crtc, false);\n\n\treturn ret;\n}\n\nint radeon_crtc_cursor_set2(struct drm_crtc *crtc,\n\t\t\t    struct drm_file *file_priv,\n\t\t\t    uint32_t handle,\n\t\t\t    uint32_t width,\n\t\t\t    uint32_t height,\n\t\t\t    int32_t hot_x,\n\t\t\t    int32_t hot_y)\n{\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\tstruct radeon_device *rdev = crtc->dev->dev_private;\n\tstruct drm_gem_object *obj;\n\tstruct radeon_bo *robj;\n\tint ret;\n\n\tif (!handle) {\n\t\t \n\t\tradeon_hide_cursor(crtc);\n\t\tobj = NULL;\n\t\tgoto unpin;\n\t}\n\n\tif ((width > radeon_crtc->max_cursor_width) ||\n\t    (height > radeon_crtc->max_cursor_height)) {\n\t\tDRM_ERROR(\"bad cursor width or height %d x %d\\n\", width, height);\n\t\treturn -EINVAL;\n\t}\n\n\tobj = drm_gem_object_lookup(file_priv, handle);\n\tif (!obj) {\n\t\tDRM_ERROR(\"Cannot find cursor object %x for crtc %d\\n\", handle, radeon_crtc->crtc_id);\n\t\treturn -ENOENT;\n\t}\n\n\trobj = gem_to_radeon_bo(obj);\n\tret = radeon_bo_reserve(robj, false);\n\tif (ret != 0) {\n\t\tdrm_gem_object_put(obj);\n\t\treturn ret;\n\t}\n\t \n\tret = radeon_bo_pin_restricted(robj, RADEON_GEM_DOMAIN_VRAM,\n\t\t\t\t       ASIC_IS_AVIVO(rdev) ? 0 : 1 << 27,\n\t\t\t\t       &radeon_crtc->cursor_addr);\n\tradeon_bo_unreserve(robj);\n\tif (ret) {\n\t\tDRM_ERROR(\"Failed to pin new cursor BO (%d)\\n\", ret);\n\t\tdrm_gem_object_put(obj);\n\t\treturn ret;\n\t}\n\n\tradeon_lock_cursor(crtc, true);\n\n\tif (width != radeon_crtc->cursor_width ||\n\t    height != radeon_crtc->cursor_height ||\n\t    hot_x != radeon_crtc->cursor_hot_x ||\n\t    hot_y != radeon_crtc->cursor_hot_y) {\n\t\tint x, y;\n\n\t\tx = radeon_crtc->cursor_x + radeon_crtc->cursor_hot_x - hot_x;\n\t\ty = radeon_crtc->cursor_y + radeon_crtc->cursor_hot_y - hot_y;\n\n\t\tradeon_crtc->cursor_width = width;\n\t\tradeon_crtc->cursor_height = height;\n\t\tradeon_crtc->cursor_hot_x = hot_x;\n\t\tradeon_crtc->cursor_hot_y = hot_y;\n\n\t\tradeon_cursor_move_locked(crtc, x, y);\n\t}\n\n\tradeon_show_cursor(crtc);\n\n\tradeon_lock_cursor(crtc, false);\n\nunpin:\n\tif (radeon_crtc->cursor_bo) {\n\t\tstruct radeon_bo *robj = gem_to_radeon_bo(radeon_crtc->cursor_bo);\n\t\tret = radeon_bo_reserve(robj, false);\n\t\tif (likely(ret == 0)) {\n\t\t\tradeon_bo_unpin(robj);\n\t\t\tradeon_bo_unreserve(robj);\n\t\t}\n\t\tdrm_gem_object_put(radeon_crtc->cursor_bo);\n\t}\n\n\tradeon_crtc->cursor_bo = obj;\n\treturn 0;\n}\n\n \nvoid radeon_cursor_reset(struct drm_crtc *crtc)\n{\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\n\tif (radeon_crtc->cursor_bo) {\n\t\tradeon_lock_cursor(crtc, true);\n\n\t\tradeon_cursor_move_locked(crtc, radeon_crtc->cursor_x,\n\t\t\t\t\t  radeon_crtc->cursor_y);\n\n\t\tradeon_show_cursor(crtc);\n\n\t\tradeon_lock_cursor(crtc, false);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}