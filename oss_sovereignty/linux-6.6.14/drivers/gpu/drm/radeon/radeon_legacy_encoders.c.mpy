{
  "module_name": "radeon_legacy_encoders.c",
  "hash_id": "3f599e2668b56bc1d09db07c4c22d47733fe98d02b70bda92e0ec5e831387341",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/radeon_legacy_encoders.c",
  "human_readable_source": " \n\n#include <linux/backlight.h>\n#include <linux/pci.h>\n\n#include <drm/drm_device.h>\n#include <drm/drm_file.h>\n#include <drm/drm_modeset_helper_vtables.h>\n#include <drm/drm_util.h>\n#include <drm/radeon_drm.h>\n\n#include <acpi/video.h>\n\n#include \"radeon.h\"\n#include \"radeon_asic.h\"\n#include \"radeon_legacy_encoders.h\"\n#include \"atom.h\"\n#ifdef CONFIG_PMAC_BACKLIGHT\n#include <asm/backlight.h>\n#endif\n\nstatic void radeon_legacy_encoder_disable(struct drm_encoder *encoder)\n{\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tconst struct drm_encoder_helper_funcs *encoder_funcs;\n\n\tencoder_funcs = encoder->helper_private;\n\tencoder_funcs->dpms(encoder, DRM_MODE_DPMS_OFF);\n\tradeon_encoder->active_device = 0;\n}\n\nstatic void radeon_legacy_lvds_update(struct drm_encoder *encoder, int mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint32_t lvds_gen_cntl, lvds_pll_cntl, pixclks_cntl, disp_pwr_man;\n\tint panel_pwr_delay = 2000;\n\tbool is_mac = false;\n\tuint8_t backlight_level;\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tlvds_gen_cntl = RREG32(RADEON_LVDS_GEN_CNTL);\n\tbacklight_level = (lvds_gen_cntl >> RADEON_LVDS_BL_MOD_LEVEL_SHIFT) & 0xff;\n\n\tif (radeon_encoder->enc_priv) {\n\t\tif (rdev->is_atom_bios) {\n\t\t\tstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\n\t\t\tpanel_pwr_delay = lvds->panel_pwr_delay;\n\t\t\tif (lvds->bl_dev)\n\t\t\t\tbacklight_level = lvds->backlight_level;\n\t\t} else {\n\t\t\tstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\n\t\t\tpanel_pwr_delay = lvds->panel_pwr_delay;\n\t\t\tif (lvds->bl_dev)\n\t\t\t\tbacklight_level = lvds->backlight_level;\n\t\t}\n\t}\n\n\t \n\tif ((rdev->mode_info.connector_table == CT_IBOOK) ||\n\t    (rdev->mode_info.connector_table == CT_POWERBOOK_EXTERNAL) ||\n\t    (rdev->mode_info.connector_table == CT_POWERBOOK_INTERNAL) ||\n\t    (rdev->mode_info.connector_table == CT_POWERBOOK_VGA))\n\t\tis_mac = true;\n\n\tswitch (mode) {\n\tcase DRM_MODE_DPMS_ON:\n\t\tdisp_pwr_man = RREG32(RADEON_DISP_PWR_MAN);\n\t\tdisp_pwr_man |= RADEON_AUTO_PWRUP_EN;\n\t\tWREG32(RADEON_DISP_PWR_MAN, disp_pwr_man);\n\t\tlvds_pll_cntl = RREG32(RADEON_LVDS_PLL_CNTL);\n\t\tlvds_pll_cntl |= RADEON_LVDS_PLL_EN;\n\t\tWREG32(RADEON_LVDS_PLL_CNTL, lvds_pll_cntl);\n\t\tmdelay(1);\n\n\t\tlvds_pll_cntl = RREG32(RADEON_LVDS_PLL_CNTL);\n\t\tlvds_pll_cntl &= ~RADEON_LVDS_PLL_RESET;\n\t\tWREG32(RADEON_LVDS_PLL_CNTL, lvds_pll_cntl);\n\n\t\tlvds_gen_cntl &= ~(RADEON_LVDS_DISPLAY_DIS |\n\t\t\t\t   RADEON_LVDS_BL_MOD_LEVEL_MASK);\n\t\tlvds_gen_cntl |= (RADEON_LVDS_ON | RADEON_LVDS_EN |\n\t\t\t\t  RADEON_LVDS_DIGON | RADEON_LVDS_BLON |\n\t\t\t\t  (backlight_level << RADEON_LVDS_BL_MOD_LEVEL_SHIFT));\n\t\tif (is_mac)\n\t\t\tlvds_gen_cntl |= RADEON_LVDS_BL_MOD_EN;\n\t\tmdelay(panel_pwr_delay);\n\t\tWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\n\t\tbreak;\n\tcase DRM_MODE_DPMS_STANDBY:\n\tcase DRM_MODE_DPMS_SUSPEND:\n\tcase DRM_MODE_DPMS_OFF:\n\t\tpixclks_cntl = RREG32_PLL(RADEON_PIXCLKS_CNTL);\n\t\tWREG32_PLL_P(RADEON_PIXCLKS_CNTL, 0, ~RADEON_PIXCLK_LVDS_ALWAYS_ONb);\n\t\tlvds_gen_cntl |= RADEON_LVDS_DISPLAY_DIS;\n\t\tif (is_mac) {\n\t\t\tlvds_gen_cntl &= ~RADEON_LVDS_BL_MOD_EN;\n\t\t\tWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\n\t\t\tlvds_gen_cntl &= ~(RADEON_LVDS_ON | RADEON_LVDS_EN);\n\t\t} else {\n\t\t\tWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\n\t\t\tlvds_gen_cntl &= ~(RADEON_LVDS_ON | RADEON_LVDS_BLON | RADEON_LVDS_EN | RADEON_LVDS_DIGON);\n\t\t}\n\t\tmdelay(panel_pwr_delay);\n\t\tWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\n\t\tWREG32_PLL(RADEON_PIXCLKS_CNTL, pixclks_cntl);\n\t\tmdelay(panel_pwr_delay);\n\t\tbreak;\n\t}\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\telse\n\t\tradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\n}\n\nstatic void radeon_legacy_lvds_dpms(struct drm_encoder *encoder, int mode)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tDRM_DEBUG(\"\\n\");\n\n\tif (radeon_encoder->enc_priv) {\n\t\tif (rdev->is_atom_bios) {\n\t\t\tstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\n\t\t\tlvds->dpms_mode = mode;\n\t\t} else {\n\t\t\tstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\n\t\t\tlvds->dpms_mode = mode;\n\t\t}\n\t}\n\n\tradeon_legacy_lvds_update(encoder, mode);\n}\n\nstatic void radeon_legacy_lvds_prepare(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, true);\n\telse\n\t\tradeon_combios_output_lock(encoder, true);\n\tradeon_legacy_lvds_dpms(encoder, DRM_MODE_DPMS_OFF);\n}\n\nstatic void radeon_legacy_lvds_commit(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\n\tradeon_legacy_lvds_dpms(encoder, DRM_MODE_DPMS_ON);\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, false);\n\telse\n\t\tradeon_combios_output_lock(encoder, false);\n}\n\nstatic void radeon_legacy_lvds_mode_set(struct drm_encoder *encoder,\n\t\t\t\t\tstruct drm_display_mode *mode,\n\t\t\t\t\tstruct drm_display_mode *adjusted_mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint32_t lvds_pll_cntl, lvds_gen_cntl, lvds_ss_gen_cntl;\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tlvds_pll_cntl = RREG32(RADEON_LVDS_PLL_CNTL);\n\tlvds_pll_cntl &= ~RADEON_LVDS_PLL_EN;\n\n\tlvds_ss_gen_cntl = RREG32(RADEON_LVDS_SS_GEN_CNTL);\n\tif (rdev->is_atom_bios) {\n\t\t \n\t\tradeon_encoder->pixel_clock = adjusted_mode->clock;\n\t\tatombios_digital_setup(encoder, PANEL_ENCODER_ACTION_ENABLE);\n\t\tlvds_gen_cntl = RREG32(RADEON_LVDS_GEN_CNTL);\n\t} else {\n\t\tstruct radeon_encoder_lvds *lvds = (struct radeon_encoder_lvds *)radeon_encoder->enc_priv;\n\t\tif (lvds) {\n\t\t\tDRM_DEBUG_KMS(\"bios LVDS_GEN_CNTL: 0x%x\\n\", lvds->lvds_gen_cntl);\n\t\t\tlvds_gen_cntl = lvds->lvds_gen_cntl;\n\t\t\tlvds_ss_gen_cntl &= ~((0xf << RADEON_LVDS_PWRSEQ_DELAY1_SHIFT) |\n\t\t\t\t\t      (0xf << RADEON_LVDS_PWRSEQ_DELAY2_SHIFT));\n\t\t\tlvds_ss_gen_cntl |= ((lvds->panel_digon_delay << RADEON_LVDS_PWRSEQ_DELAY1_SHIFT) |\n\t\t\t\t\t     (lvds->panel_blon_delay << RADEON_LVDS_PWRSEQ_DELAY2_SHIFT));\n\t\t} else\n\t\t\tlvds_gen_cntl = RREG32(RADEON_LVDS_GEN_CNTL);\n\t}\n\tlvds_gen_cntl |= RADEON_LVDS_DISPLAY_DIS;\n\tlvds_gen_cntl &= ~(RADEON_LVDS_ON |\n\t\t\t   RADEON_LVDS_BLON |\n\t\t\t   RADEON_LVDS_EN |\n\t\t\t   RADEON_LVDS_RST_FM);\n\n\tif (ASIC_IS_R300(rdev))\n\t\tlvds_pll_cntl &= ~(R300_LVDS_SRC_SEL_MASK);\n\n\tif (radeon_crtc->crtc_id == 0) {\n\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\tif (radeon_encoder->rmx_type != RMX_OFF)\n\t\t\t\tlvds_pll_cntl |= R300_LVDS_SRC_SEL_RMX;\n\t\t} else\n\t\t\tlvds_gen_cntl &= ~RADEON_LVDS_SEL_CRTC2;\n\t} else {\n\t\tif (ASIC_IS_R300(rdev))\n\t\t\tlvds_pll_cntl |= R300_LVDS_SRC_SEL_CRTC2;\n\t\telse\n\t\t\tlvds_gen_cntl |= RADEON_LVDS_SEL_CRTC2;\n\t}\n\n\tWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\n\tWREG32(RADEON_LVDS_PLL_CNTL, lvds_pll_cntl);\n\tWREG32(RADEON_LVDS_SS_GEN_CNTL, lvds_ss_gen_cntl);\n\n\tif (rdev->family == CHIP_RV410)\n\t\tWREG32(RADEON_CLOCK_CNTL_INDEX, 0);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n\telse\n\t\tradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n}\n\nstatic bool radeon_legacy_mode_fixup(struct drm_encoder *encoder,\n\t\t\t\t     const struct drm_display_mode *mode,\n\t\t\t\t     struct drm_display_mode *adjusted_mode)\n{\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\n\t \n\tradeon_encoder_set_active_device(encoder);\n\tdrm_mode_set_crtcinfo(adjusted_mode, 0);\n\n\t \n\tif (radeon_encoder->active_device & (ATOM_DEVICE_LCD_SUPPORT))\n\t\tradeon_panel_mode_fixup(encoder, adjusted_mode);\n\n\treturn true;\n}\n\nstatic const struct drm_encoder_helper_funcs radeon_legacy_lvds_helper_funcs = {\n\t.dpms = radeon_legacy_lvds_dpms,\n\t.mode_fixup = radeon_legacy_mode_fixup,\n\t.prepare = radeon_legacy_lvds_prepare,\n\t.mode_set = radeon_legacy_lvds_mode_set,\n\t.commit = radeon_legacy_lvds_commit,\n\t.disable = radeon_legacy_encoder_disable,\n};\n\nu8\nradeon_legacy_get_backlight_level(struct radeon_encoder *radeon_encoder)\n{\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tu8 backlight_level;\n\n\tbacklight_level = (RREG32(RADEON_LVDS_GEN_CNTL) >>\n\t\t\t   RADEON_LVDS_BL_MOD_LEVEL_SHIFT) & 0xff;\n\n\treturn backlight_level;\n}\n\nvoid\nradeon_legacy_set_backlight_level(struct radeon_encoder *radeon_encoder, u8 level)\n{\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tint dpms_mode = DRM_MODE_DPMS_ON;\n\n\tif (radeon_encoder->enc_priv) {\n\t\tif (rdev->is_atom_bios) {\n\t\t\tstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\n\t\t\tif (lvds->backlight_level > 0)\n\t\t\t\tdpms_mode = lvds->dpms_mode;\n\t\t\telse\n\t\t\t\tdpms_mode = DRM_MODE_DPMS_OFF;\n\t\t\tlvds->backlight_level = level;\n\t\t} else {\n\t\t\tstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\n\t\t\tif (lvds->backlight_level > 0)\n\t\t\t\tdpms_mode = lvds->dpms_mode;\n\t\t\telse\n\t\t\t\tdpms_mode = DRM_MODE_DPMS_OFF;\n\t\t\tlvds->backlight_level = level;\n\t\t}\n\t}\n\n\tradeon_legacy_lvds_update(&radeon_encoder->base, dpms_mode);\n}\n\nstatic uint8_t radeon_legacy_lvds_level(struct backlight_device *bd)\n{\n\tstruct radeon_backlight_privdata *pdata = bl_get_data(bd);\n\tuint8_t level;\n\n\t \n\tif (bd->props.brightness < 0)\n\t\tlevel = 0;\n\telse if (bd->props.brightness > RADEON_MAX_BL_LEVEL)\n\t\tlevel = RADEON_MAX_BL_LEVEL;\n\telse\n\t\tlevel = bd->props.brightness;\n\n\tif (pdata->negative)\n\t\tlevel = RADEON_MAX_BL_LEVEL - level;\n\n\treturn level;\n}\n\nstatic int radeon_legacy_backlight_update_status(struct backlight_device *bd)\n{\n\tstruct radeon_backlight_privdata *pdata = bl_get_data(bd);\n\tstruct radeon_encoder *radeon_encoder = pdata->encoder;\n\n\tradeon_legacy_set_backlight_level(radeon_encoder,\n\t\t\t\t\t  radeon_legacy_lvds_level(bd));\n\n\treturn 0;\n}\n\nstatic int radeon_legacy_backlight_get_brightness(struct backlight_device *bd)\n{\n\tstruct radeon_backlight_privdata *pdata = bl_get_data(bd);\n\tstruct radeon_encoder *radeon_encoder = pdata->encoder;\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint8_t backlight_level;\n\n\tbacklight_level = (RREG32(RADEON_LVDS_GEN_CNTL) >>\n\t\t\t   RADEON_LVDS_BL_MOD_LEVEL_SHIFT) & 0xff;\n\n\treturn pdata->negative ? RADEON_MAX_BL_LEVEL - backlight_level : backlight_level;\n}\n\nstatic const struct backlight_ops radeon_backlight_ops = {\n\t.get_brightness = radeon_legacy_backlight_get_brightness,\n\t.update_status\t= radeon_legacy_backlight_update_status,\n};\n\nvoid radeon_legacy_backlight_init(struct radeon_encoder *radeon_encoder,\n\t\t\t\t  struct drm_connector *drm_connector)\n{\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct backlight_device *bd;\n\tstruct backlight_properties props;\n\tstruct radeon_backlight_privdata *pdata;\n\tuint8_t backlight_level;\n\tchar bl_name[16];\n\n\tif (!radeon_encoder->enc_priv)\n\t\treturn;\n\n#ifdef CONFIG_PMAC_BACKLIGHT\n\tif (!pmac_has_backlight_type(\"ati\") &&\n\t    !pmac_has_backlight_type(\"mnca\"))\n\t\treturn;\n#endif\n\n\tif (!acpi_video_backlight_use_native()) {\n\t\tdrm_info(dev, \"Skipping radeon legacy LVDS backlight registration\\n\");\n\t\treturn;\n\t}\n\n\tpdata = kmalloc(sizeof(struct radeon_backlight_privdata), GFP_KERNEL);\n\tif (!pdata) {\n\t\tDRM_ERROR(\"Memory allocation failed\\n\");\n\t\tgoto error;\n\t}\n\n\tmemset(&props, 0, sizeof(props));\n\tprops.max_brightness = RADEON_MAX_BL_LEVEL;\n\tprops.type = BACKLIGHT_RAW;\n\tsnprintf(bl_name, sizeof(bl_name),\n\t\t \"radeon_bl%d\", dev->primary->index);\n\tbd = backlight_device_register(bl_name, drm_connector->kdev,\n\t\t\t\t       pdata, &radeon_backlight_ops, &props);\n\tif (IS_ERR(bd)) {\n\t\tDRM_ERROR(\"Backlight registration failed\\n\");\n\t\tgoto error;\n\t}\n\n\tpdata->encoder = radeon_encoder;\n\n\tbacklight_level = (RREG32(RADEON_LVDS_GEN_CNTL) >>\n\t\t\t   RADEON_LVDS_BL_MOD_LEVEL_SHIFT) & 0xff;\n\n\t \n\tif (backlight_level == 0)\n\t\tpdata->negative = true;\n\telse if (backlight_level == 0xff)\n\t\tpdata->negative = false;\n\telse {\n\t\t \n\t\tpdata->negative = (rdev->family != CHIP_RV200 &&\n\t\t\t\t   rdev->family != CHIP_RV250 &&\n\t\t\t\t   rdev->family != CHIP_RV280 &&\n\t\t\t\t   rdev->family != CHIP_RV350);\n\n#ifdef CONFIG_PMAC_BACKLIGHT\n\t\tpdata->negative = (pdata->negative ||\n\t\t\t\t   of_machine_is_compatible(\"PowerBook4,3\") ||\n\t\t\t\t   of_machine_is_compatible(\"PowerBook6,3\") ||\n\t\t\t\t   of_machine_is_compatible(\"PowerBook6,5\"));\n#endif\n\t}\n\n\tif (rdev->is_atom_bios) {\n\t\tstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\n\t\tlvds->bl_dev = bd;\n\t} else {\n\t\tstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\n\t\tlvds->bl_dev = bd;\n\t}\n\n\tbd->props.brightness = radeon_legacy_backlight_get_brightness(bd);\n\tbd->props.power = FB_BLANK_UNBLANK;\n\tbacklight_update_status(bd);\n\n\tDRM_INFO(\"radeon legacy LVDS backlight initialized\\n\");\n\trdev->mode_info.bl_encoder = radeon_encoder;\n\n\treturn;\n\nerror:\n\tkfree(pdata);\n\treturn;\n}\n\nstatic void radeon_legacy_backlight_exit(struct radeon_encoder *radeon_encoder)\n{\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct backlight_device *bd = NULL;\n\n\tif (!radeon_encoder->enc_priv)\n\t\treturn;\n\n\tif (rdev->is_atom_bios) {\n\t\tstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\n\t\tbd = lvds->bl_dev;\n\t\tlvds->bl_dev = NULL;\n\t} else {\n\t\tstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\n\t\tbd = lvds->bl_dev;\n\t\tlvds->bl_dev = NULL;\n\t}\n\n\tif (bd) {\n\t\tstruct radeon_backlight_privdata *pdata;\n\n\t\tpdata = bl_get_data(bd);\n\t\tbacklight_device_unregister(bd);\n\t\tkfree(pdata);\n\n\t\tDRM_INFO(\"radeon legacy LVDS backlight unloaded\\n\");\n\t}\n}\n\nstatic void radeon_lvds_enc_destroy(struct drm_encoder *encoder)\n{\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\n\tif (radeon_encoder->enc_priv) {\n\t\tradeon_legacy_backlight_exit(radeon_encoder);\n\t\tkfree(radeon_encoder->enc_priv);\n\t}\n\tdrm_encoder_cleanup(encoder);\n\tkfree(radeon_encoder);\n}\n\nstatic const struct drm_encoder_funcs radeon_legacy_lvds_enc_funcs = {\n\t.destroy = radeon_lvds_enc_destroy,\n};\n\nstatic void radeon_legacy_primary_dac_dpms(struct drm_encoder *encoder, int mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t crtc_ext_cntl = RREG32(RADEON_CRTC_EXT_CNTL);\n\tuint32_t dac_cntl = RREG32(RADEON_DAC_CNTL);\n\tuint32_t dac_macro_cntl = RREG32(RADEON_DAC_MACRO_CNTL);\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tswitch (mode) {\n\tcase DRM_MODE_DPMS_ON:\n\t\tcrtc_ext_cntl |= RADEON_CRTC_CRT_ON;\n\t\tdac_cntl &= ~RADEON_DAC_PDWN;\n\t\tdac_macro_cntl &= ~(RADEON_DAC_PDWN_R |\n\t\t\t\t    RADEON_DAC_PDWN_G |\n\t\t\t\t    RADEON_DAC_PDWN_B);\n\t\tbreak;\n\tcase DRM_MODE_DPMS_STANDBY:\n\tcase DRM_MODE_DPMS_SUSPEND:\n\tcase DRM_MODE_DPMS_OFF:\n\t\tcrtc_ext_cntl &= ~RADEON_CRTC_CRT_ON;\n\t\tdac_cntl |= RADEON_DAC_PDWN;\n\t\tdac_macro_cntl |= (RADEON_DAC_PDWN_R |\n\t\t\t\t   RADEON_DAC_PDWN_G |\n\t\t\t\t   RADEON_DAC_PDWN_B);\n\t\tbreak;\n\t}\n\n\t \n\tif (!(rdev->flags & RADEON_SINGLE_CRTC))\n\t\tWREG32(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl);\n\tWREG32(RADEON_DAC_CNTL, dac_cntl);\n\tWREG32(RADEON_DAC_MACRO_CNTL, dac_macro_cntl);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\telse\n\t\tradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\n}\n\nstatic void radeon_legacy_primary_dac_prepare(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, true);\n\telse\n\t\tradeon_combios_output_lock(encoder, true);\n\tradeon_legacy_primary_dac_dpms(encoder, DRM_MODE_DPMS_OFF);\n}\n\nstatic void radeon_legacy_primary_dac_commit(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\n\tradeon_legacy_primary_dac_dpms(encoder, DRM_MODE_DPMS_ON);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, false);\n\telse\n\t\tradeon_combios_output_lock(encoder, false);\n}\n\nstatic void radeon_legacy_primary_dac_mode_set(struct drm_encoder *encoder,\n\t\t\t\t\t       struct drm_display_mode *mode,\n\t\t\t\t\t       struct drm_display_mode *adjusted_mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint32_t disp_output_cntl, dac_cntl, dac2_cntl, dac_macro_cntl;\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tif (radeon_crtc->crtc_id == 0) {\n\t\tif (rdev->family == CHIP_R200 || ASIC_IS_R300(rdev)) {\n\t\t\tdisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL) &\n\t\t\t\t~(RADEON_DISP_DAC_SOURCE_MASK);\n\t\t\tWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\n\t\t} else {\n\t\t\tdac2_cntl = RREG32(RADEON_DAC_CNTL2)  & ~(RADEON_DAC2_DAC_CLK_SEL);\n\t\t\tWREG32(RADEON_DAC_CNTL2, dac2_cntl);\n\t\t}\n\t} else {\n\t\tif (rdev->family == CHIP_R200 || ASIC_IS_R300(rdev)) {\n\t\t\tdisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL) &\n\t\t\t\t~(RADEON_DISP_DAC_SOURCE_MASK);\n\t\t\tdisp_output_cntl |= RADEON_DISP_DAC_SOURCE_CRTC2;\n\t\t\tWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\n\t\t} else {\n\t\t\tdac2_cntl = RREG32(RADEON_DAC_CNTL2) | RADEON_DAC2_DAC_CLK_SEL;\n\t\t\tWREG32(RADEON_DAC_CNTL2, dac2_cntl);\n\t\t}\n\t}\n\n\tdac_cntl = (RADEON_DAC_MASK_ALL |\n\t\t    RADEON_DAC_VGA_ADR_EN |\n\t\t     \n\t\t    RADEON_DAC_8BIT_EN);\n\n\tWREG32_P(RADEON_DAC_CNTL,\n\t\t       dac_cntl,\n\t\t       RADEON_DAC_RANGE_CNTL |\n\t\t       RADEON_DAC_BLANKING);\n\n\tif (radeon_encoder->enc_priv) {\n\t\tstruct radeon_encoder_primary_dac *p_dac = (struct radeon_encoder_primary_dac *)radeon_encoder->enc_priv;\n\t\tdac_macro_cntl = p_dac->ps2_pdac_adj;\n\t} else\n\t\tdac_macro_cntl = RREG32(RADEON_DAC_MACRO_CNTL);\n\tdac_macro_cntl |= RADEON_DAC_PDWN_R | RADEON_DAC_PDWN_G | RADEON_DAC_PDWN_B;\n\tWREG32(RADEON_DAC_MACRO_CNTL, dac_macro_cntl);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n\telse\n\t\tradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n}\n\nstatic enum drm_connector_status radeon_legacy_primary_dac_detect(struct drm_encoder *encoder,\n\t\t\t\t\t\t\t\t  struct drm_connector *connector)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t vclk_ecp_cntl, crtc_ext_cntl;\n\tuint32_t dac_ext_cntl, dac_cntl, dac_macro_cntl, tmp;\n\tenum drm_connector_status found = connector_status_disconnected;\n\tbool color = true;\n\n\t \n\tif (ASIC_IS_RN50(rdev)) {\n\t\treturn connector_status_connected;\n\t}\n\n\t \n\tvclk_ecp_cntl = RREG32_PLL(RADEON_VCLK_ECP_CNTL);\n\tcrtc_ext_cntl = RREG32(RADEON_CRTC_EXT_CNTL);\n\tdac_ext_cntl = RREG32(RADEON_DAC_EXT_CNTL);\n\tdac_cntl = RREG32(RADEON_DAC_CNTL);\n\tdac_macro_cntl = RREG32(RADEON_DAC_MACRO_CNTL);\n\n\ttmp = vclk_ecp_cntl &\n\t\t~(RADEON_PIXCLK_ALWAYS_ONb | RADEON_PIXCLK_DAC_ALWAYS_ONb);\n\tWREG32_PLL(RADEON_VCLK_ECP_CNTL, tmp);\n\n\ttmp = crtc_ext_cntl | RADEON_CRTC_CRT_ON;\n\tWREG32(RADEON_CRTC_EXT_CNTL, tmp);\n\n\ttmp = RADEON_DAC_FORCE_BLANK_OFF_EN |\n\t\tRADEON_DAC_FORCE_DATA_EN;\n\n\tif (color)\n\t\ttmp |= RADEON_DAC_FORCE_DATA_SEL_RGB;\n\telse\n\t\ttmp |= RADEON_DAC_FORCE_DATA_SEL_G;\n\n\tif (ASIC_IS_R300(rdev))\n\t\ttmp |= (0x1b6 << RADEON_DAC_FORCE_DATA_SHIFT);\n\telse if (ASIC_IS_RV100(rdev))\n\t\ttmp |= (0x1ac << RADEON_DAC_FORCE_DATA_SHIFT);\n\telse\n\t\ttmp |= (0x180 << RADEON_DAC_FORCE_DATA_SHIFT);\n\n\tWREG32(RADEON_DAC_EXT_CNTL, tmp);\n\n\ttmp = dac_cntl & ~(RADEON_DAC_RANGE_CNTL_MASK | RADEON_DAC_PDWN);\n\ttmp |= RADEON_DAC_RANGE_CNTL_PS2 | RADEON_DAC_CMP_EN;\n\tWREG32(RADEON_DAC_CNTL, tmp);\n\n\ttmp = dac_macro_cntl;\n\ttmp &= ~(RADEON_DAC_PDWN_R |\n\t\t RADEON_DAC_PDWN_G |\n\t\t RADEON_DAC_PDWN_B);\n\n\tWREG32(RADEON_DAC_MACRO_CNTL, tmp);\n\n\tmdelay(2);\n\n\tif (RREG32(RADEON_DAC_CNTL) & RADEON_DAC_CMP_OUTPUT)\n\t\tfound = connector_status_connected;\n\n\t \n\tWREG32(RADEON_DAC_CNTL, dac_cntl);\n\tWREG32(RADEON_DAC_MACRO_CNTL, dac_macro_cntl);\n\tWREG32(RADEON_DAC_EXT_CNTL, dac_ext_cntl);\n\tWREG32(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl);\n\tWREG32_PLL(RADEON_VCLK_ECP_CNTL, vclk_ecp_cntl);\n\n\treturn found;\n}\n\nstatic const struct drm_encoder_helper_funcs radeon_legacy_primary_dac_helper_funcs = {\n\t.dpms = radeon_legacy_primary_dac_dpms,\n\t.mode_fixup = radeon_legacy_mode_fixup,\n\t.prepare = radeon_legacy_primary_dac_prepare,\n\t.mode_set = radeon_legacy_primary_dac_mode_set,\n\t.commit = radeon_legacy_primary_dac_commit,\n\t.detect = radeon_legacy_primary_dac_detect,\n\t.disable = radeon_legacy_encoder_disable,\n};\n\n\nstatic const struct drm_encoder_funcs radeon_legacy_primary_dac_enc_funcs = {\n\t.destroy = radeon_enc_destroy,\n};\n\nstatic void radeon_legacy_tmds_int_dpms(struct drm_encoder *encoder, int mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t fp_gen_cntl = RREG32(RADEON_FP_GEN_CNTL);\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tswitch (mode) {\n\tcase DRM_MODE_DPMS_ON:\n\t\tfp_gen_cntl |= (RADEON_FP_FPON | RADEON_FP_TMDS_EN);\n\t\tbreak;\n\tcase DRM_MODE_DPMS_STANDBY:\n\tcase DRM_MODE_DPMS_SUSPEND:\n\tcase DRM_MODE_DPMS_OFF:\n\t\tfp_gen_cntl &= ~(RADEON_FP_FPON | RADEON_FP_TMDS_EN);\n\t\tbreak;\n\t}\n\n\tWREG32(RADEON_FP_GEN_CNTL, fp_gen_cntl);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\telse\n\t\tradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\n}\n\nstatic void radeon_legacy_tmds_int_prepare(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, true);\n\telse\n\t\tradeon_combios_output_lock(encoder, true);\n\tradeon_legacy_tmds_int_dpms(encoder, DRM_MODE_DPMS_OFF);\n}\n\nstatic void radeon_legacy_tmds_int_commit(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\n\tradeon_legacy_tmds_int_dpms(encoder, DRM_MODE_DPMS_ON);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, true);\n\telse\n\t\tradeon_combios_output_lock(encoder, true);\n}\n\nstatic void radeon_legacy_tmds_int_mode_set(struct drm_encoder *encoder,\n\t\t\t\t\t    struct drm_display_mode *mode,\n\t\t\t\t\t    struct drm_display_mode *adjusted_mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint32_t tmp, tmds_pll_cntl, tmds_transmitter_cntl, fp_gen_cntl;\n\tint i;\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\ttmp = tmds_pll_cntl = RREG32(RADEON_TMDS_PLL_CNTL);\n\ttmp &= 0xfffff;\n\tif (rdev->family == CHIP_RV280) {\n\t\t \n\t\ttmp ^= (1 << 22);\n\t\ttmds_pll_cntl ^= (1 << 22);\n\t}\n\n\tif (radeon_encoder->enc_priv) {\n\t\tstruct radeon_encoder_int_tmds *tmds = (struct radeon_encoder_int_tmds *)radeon_encoder->enc_priv;\n\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tif (tmds->tmds_pll[i].freq == 0)\n\t\t\t\tbreak;\n\t\t\tif ((uint32_t)(mode->clock / 10) < tmds->tmds_pll[i].freq) {\n\t\t\t\ttmp = tmds->tmds_pll[i].value ;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (ASIC_IS_R300(rdev) || (rdev->family == CHIP_RV280)) {\n\t\tif (tmp & 0xfff00000)\n\t\t\ttmds_pll_cntl = tmp;\n\t\telse {\n\t\t\ttmds_pll_cntl &= 0xfff00000;\n\t\t\ttmds_pll_cntl |= tmp;\n\t\t}\n\t} else\n\t\ttmds_pll_cntl = tmp;\n\n\ttmds_transmitter_cntl = RREG32(RADEON_TMDS_TRANSMITTER_CNTL) &\n\t\t~(RADEON_TMDS_TRANSMITTER_PLLRST);\n\n\tif (rdev->family == CHIP_R200 ||\n\t    rdev->family == CHIP_R100 ||\n\t    ASIC_IS_R300(rdev))\n\t\ttmds_transmitter_cntl &= ~(RADEON_TMDS_TRANSMITTER_PLLEN);\n\telse  \n\t\ttmds_transmitter_cntl |= RADEON_TMDS_TRANSMITTER_PLLEN;\n\n\tfp_gen_cntl = (RREG32(RADEON_FP_GEN_CNTL) |\n\t\t      (RADEON_FP_CRTC_DONT_SHADOW_VPAR |\n\t\t       RADEON_FP_CRTC_DONT_SHADOW_HEND));\n\n\tfp_gen_cntl &= ~(RADEON_FP_FPON | RADEON_FP_TMDS_EN);\n\n\tfp_gen_cntl &= ~(RADEON_FP_RMX_HVSYNC_CONTROL_EN |\n\t\t\t RADEON_FP_DFP_SYNC_SEL |\n\t\t\t RADEON_FP_CRT_SYNC_SEL |\n\t\t\t RADEON_FP_CRTC_LOCK_8DOT |\n\t\t\t RADEON_FP_USE_SHADOW_EN |\n\t\t\t RADEON_FP_CRTC_USE_SHADOW_VEND |\n\t\t\t RADEON_FP_CRT_SYNC_ALT);\n\n\tif (1)  \n\t\tfp_gen_cntl |= RADEON_FP_PANEL_FORMAT;   \n\telse\n\t\tfp_gen_cntl &= ~RADEON_FP_PANEL_FORMAT; \n\n\tif (radeon_crtc->crtc_id == 0) {\n\t\tif (ASIC_IS_R300(rdev) || rdev->family == CHIP_R200) {\n\t\t\tfp_gen_cntl &= ~R200_FP_SOURCE_SEL_MASK;\n\t\t\tif (radeon_encoder->rmx_type != RMX_OFF)\n\t\t\t\tfp_gen_cntl |= R200_FP_SOURCE_SEL_RMX;\n\t\t\telse\n\t\t\t\tfp_gen_cntl |= R200_FP_SOURCE_SEL_CRTC1;\n\t\t} else\n\t\t\tfp_gen_cntl &= ~RADEON_FP_SEL_CRTC2;\n\t} else {\n\t\tif (ASIC_IS_R300(rdev) || rdev->family == CHIP_R200) {\n\t\t\tfp_gen_cntl &= ~R200_FP_SOURCE_SEL_MASK;\n\t\t\tfp_gen_cntl |= R200_FP_SOURCE_SEL_CRTC2;\n\t\t} else\n\t\t\tfp_gen_cntl |= RADEON_FP_SEL_CRTC2;\n\t}\n\n\tWREG32(RADEON_TMDS_PLL_CNTL, tmds_pll_cntl);\n\tWREG32(RADEON_TMDS_TRANSMITTER_CNTL, tmds_transmitter_cntl);\n\tWREG32(RADEON_FP_GEN_CNTL, fp_gen_cntl);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n\telse\n\t\tradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n}\n\nstatic const struct drm_encoder_helper_funcs radeon_legacy_tmds_int_helper_funcs = {\n\t.dpms = radeon_legacy_tmds_int_dpms,\n\t.mode_fixup = radeon_legacy_mode_fixup,\n\t.prepare = radeon_legacy_tmds_int_prepare,\n\t.mode_set = radeon_legacy_tmds_int_mode_set,\n\t.commit = radeon_legacy_tmds_int_commit,\n\t.disable = radeon_legacy_encoder_disable,\n};\n\n\nstatic const struct drm_encoder_funcs radeon_legacy_tmds_int_enc_funcs = {\n\t.destroy = radeon_enc_destroy,\n};\n\nstatic void radeon_legacy_tmds_ext_dpms(struct drm_encoder *encoder, int mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t fp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tswitch (mode) {\n\tcase DRM_MODE_DPMS_ON:\n\t\tfp2_gen_cntl &= ~RADEON_FP2_BLANK_EN;\n\t\tfp2_gen_cntl |= (RADEON_FP2_ON | RADEON_FP2_DVO_EN);\n\t\tbreak;\n\tcase DRM_MODE_DPMS_STANDBY:\n\tcase DRM_MODE_DPMS_SUSPEND:\n\tcase DRM_MODE_DPMS_OFF:\n\t\tfp2_gen_cntl |= RADEON_FP2_BLANK_EN;\n\t\tfp2_gen_cntl &= ~(RADEON_FP2_ON | RADEON_FP2_DVO_EN);\n\t\tbreak;\n\t}\n\n\tWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\telse\n\t\tradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\n}\n\nstatic void radeon_legacy_tmds_ext_prepare(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, true);\n\telse\n\t\tradeon_combios_output_lock(encoder, true);\n\tradeon_legacy_tmds_ext_dpms(encoder, DRM_MODE_DPMS_OFF);\n}\n\nstatic void radeon_legacy_tmds_ext_commit(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\tradeon_legacy_tmds_ext_dpms(encoder, DRM_MODE_DPMS_ON);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, false);\n\telse\n\t\tradeon_combios_output_lock(encoder, false);\n}\n\nstatic void radeon_legacy_tmds_ext_mode_set(struct drm_encoder *encoder,\n\t\t\t\t\t    struct drm_display_mode *mode,\n\t\t\t\t\t    struct drm_display_mode *adjusted_mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint32_t fp2_gen_cntl;\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tif (rdev->is_atom_bios) {\n\t\tradeon_encoder->pixel_clock = adjusted_mode->clock;\n\t\tatombios_dvo_setup(encoder, ATOM_ENABLE);\n\t\tfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\n\t} else {\n\t\tfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\n\n\t\tif (1)  \n\t\t\tfp2_gen_cntl |= RADEON_FP2_PANEL_FORMAT;  \n\t\telse\n\t\t\tfp2_gen_cntl &= ~RADEON_FP2_PANEL_FORMAT; \n\n\t\tfp2_gen_cntl &= ~(RADEON_FP2_ON |\n\t\t\t\t  RADEON_FP2_DVO_EN |\n\t\t\t\t  RADEON_FP2_DVO_RATE_SEL_SDR);\n\n\t\t \n\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\tif ((rdev->pdev->device == 0x4850) &&\n\t\t\t    (rdev->pdev->subsystem_vendor == 0x1028) &&\n\t\t\t    (rdev->pdev->subsystem_device == 0x2001))  \n\t\t\t\tfp2_gen_cntl |= R300_FP2_DVO_CLOCK_MODE_SINGLE;\n\t\t\telse\n\t\t\t\tfp2_gen_cntl |= RADEON_FP2_PAD_FLOP_EN | R300_FP2_DVO_CLOCK_MODE_SINGLE;\n\n\t\t\t \n\t\t}\n\t\tif (!radeon_combios_external_tmds_setup(encoder))\n\t\t\tradeon_external_tmds_setup(encoder);\n\t}\n\n\tif (radeon_crtc->crtc_id == 0) {\n\t\tif ((rdev->family == CHIP_R200) || ASIC_IS_R300(rdev)) {\n\t\t\tfp2_gen_cntl &= ~R200_FP2_SOURCE_SEL_MASK;\n\t\t\tif (radeon_encoder->rmx_type != RMX_OFF)\n\t\t\t\tfp2_gen_cntl |= R200_FP2_SOURCE_SEL_RMX;\n\t\t\telse\n\t\t\t\tfp2_gen_cntl |= R200_FP2_SOURCE_SEL_CRTC1;\n\t\t} else\n\t\t\tfp2_gen_cntl &= ~RADEON_FP2_SRC_SEL_CRTC2;\n\t} else {\n\t\tif ((rdev->family == CHIP_R200) || ASIC_IS_R300(rdev)) {\n\t\t\tfp2_gen_cntl &= ~R200_FP2_SOURCE_SEL_MASK;\n\t\t\tfp2_gen_cntl |= R200_FP2_SOURCE_SEL_CRTC2;\n\t\t} else\n\t\t\tfp2_gen_cntl |= RADEON_FP2_SRC_SEL_CRTC2;\n\t}\n\n\tWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n\telse\n\t\tradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n}\n\nstatic void radeon_ext_tmds_enc_destroy(struct drm_encoder *encoder)\n{\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\t \n\tkfree(radeon_encoder->enc_priv);\n\tdrm_encoder_cleanup(encoder);\n\tkfree(radeon_encoder);\n}\n\nstatic const struct drm_encoder_helper_funcs radeon_legacy_tmds_ext_helper_funcs = {\n\t.dpms = radeon_legacy_tmds_ext_dpms,\n\t.mode_fixup = radeon_legacy_mode_fixup,\n\t.prepare = radeon_legacy_tmds_ext_prepare,\n\t.mode_set = radeon_legacy_tmds_ext_mode_set,\n\t.commit = radeon_legacy_tmds_ext_commit,\n\t.disable = radeon_legacy_encoder_disable,\n};\n\n\nstatic const struct drm_encoder_funcs radeon_legacy_tmds_ext_enc_funcs = {\n\t.destroy = radeon_ext_tmds_enc_destroy,\n};\n\nstatic void radeon_legacy_tv_dac_dpms(struct drm_encoder *encoder, int mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint32_t fp2_gen_cntl = 0, crtc2_gen_cntl = 0, tv_dac_cntl = 0;\n\tuint32_t tv_master_cntl = 0;\n\tbool is_tv;\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tis_tv = radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT ? true : false;\n\n\tif (rdev->family == CHIP_R200)\n\t\tfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\n\telse {\n\t\tif (is_tv)\n\t\t\ttv_master_cntl = RREG32(RADEON_TV_MASTER_CNTL);\n\t\telse\n\t\t\tcrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL);\n\t\ttv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\n\t}\n\n\tswitch (mode) {\n\tcase DRM_MODE_DPMS_ON:\n\t\tif (rdev->family == CHIP_R200) {\n\t\t\tfp2_gen_cntl |= (RADEON_FP2_ON | RADEON_FP2_DVO_EN);\n\t\t} else {\n\t\t\tif (is_tv)\n\t\t\t\ttv_master_cntl |= RADEON_TV_ON;\n\t\t\telse\n\t\t\t\tcrtc2_gen_cntl |= RADEON_CRTC2_CRT2_ON;\n\n\t\t\tif (rdev->family == CHIP_R420 ||\n\t\t\t    rdev->family == CHIP_R423 ||\n\t\t\t    rdev->family == CHIP_RV410)\n\t\t\t\ttv_dac_cntl &= ~(R420_TV_DAC_RDACPD |\n\t\t\t\t\t\t R420_TV_DAC_GDACPD |\n\t\t\t\t\t\t R420_TV_DAC_BDACPD |\n\t\t\t\t\t\t RADEON_TV_DAC_BGSLEEP);\n\t\t\telse\n\t\t\t\ttv_dac_cntl &= ~(RADEON_TV_DAC_RDACPD |\n\t\t\t\t\t\t RADEON_TV_DAC_GDACPD |\n\t\t\t\t\t\t RADEON_TV_DAC_BDACPD |\n\t\t\t\t\t\t RADEON_TV_DAC_BGSLEEP);\n\t\t}\n\t\tbreak;\n\tcase DRM_MODE_DPMS_STANDBY:\n\tcase DRM_MODE_DPMS_SUSPEND:\n\tcase DRM_MODE_DPMS_OFF:\n\t\tif (rdev->family == CHIP_R200)\n\t\t\tfp2_gen_cntl &= ~(RADEON_FP2_ON | RADEON_FP2_DVO_EN);\n\t\telse {\n\t\t\tif (is_tv)\n\t\t\t\ttv_master_cntl &= ~RADEON_TV_ON;\n\t\t\telse\n\t\t\t\tcrtc2_gen_cntl &= ~RADEON_CRTC2_CRT2_ON;\n\n\t\t\tif (rdev->family == CHIP_R420 ||\n\t\t\t    rdev->family == CHIP_R423 ||\n\t\t\t    rdev->family == CHIP_RV410)\n\t\t\t\ttv_dac_cntl |= (R420_TV_DAC_RDACPD |\n\t\t\t\t\t\tR420_TV_DAC_GDACPD |\n\t\t\t\t\t\tR420_TV_DAC_BDACPD |\n\t\t\t\t\t\tRADEON_TV_DAC_BGSLEEP);\n\t\t\telse\n\t\t\t\ttv_dac_cntl |= (RADEON_TV_DAC_RDACPD |\n\t\t\t\t\t\tRADEON_TV_DAC_GDACPD |\n\t\t\t\t\t\tRADEON_TV_DAC_BDACPD |\n\t\t\t\t\t\tRADEON_TV_DAC_BGSLEEP);\n\t\t}\n\t\tbreak;\n\t}\n\n\tif (rdev->family == CHIP_R200) {\n\t\tWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\n\t} else {\n\t\tif (is_tv)\n\t\t\tWREG32(RADEON_TV_MASTER_CNTL, tv_master_cntl);\n\t\t \n\t\telse if (!(rdev->flags & RADEON_SINGLE_CRTC))\n\t\t\tWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\n\t\tWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\n\t}\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\telse\n\t\tradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\n\n}\n\nstatic void radeon_legacy_tv_dac_prepare(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, true);\n\telse\n\t\tradeon_combios_output_lock(encoder, true);\n\tradeon_legacy_tv_dac_dpms(encoder, DRM_MODE_DPMS_OFF);\n}\n\nstatic void radeon_legacy_tv_dac_commit(struct drm_encoder *encoder)\n{\n\tstruct radeon_device *rdev = encoder->dev->dev_private;\n\n\tradeon_legacy_tv_dac_dpms(encoder, DRM_MODE_DPMS_ON);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atom_output_lock(encoder, true);\n\telse\n\t\tradeon_combios_output_lock(encoder, true);\n}\n\nstatic void radeon_legacy_tv_dac_mode_set(struct drm_encoder *encoder,\n\t\tstruct drm_display_mode *mode,\n\t\tstruct drm_display_mode *adjusted_mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\n\tuint32_t tv_dac_cntl, gpiopad_a = 0, dac2_cntl, disp_output_cntl = 0;\n\tuint32_t disp_hw_debug = 0, fp2_gen_cntl = 0, disp_tv_out_cntl = 0;\n\tbool is_tv = false;\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tis_tv = radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT ? true : false;\n\n\tif (rdev->family != CHIP_R200) {\n\t\ttv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\n\t\tif (rdev->family == CHIP_R420 ||\n\t\t    rdev->family == CHIP_R423 ||\n\t\t    rdev->family == CHIP_RV410) {\n\t\t\ttv_dac_cntl &= ~(RADEON_TV_DAC_STD_MASK |\n\t\t\t\t\t RADEON_TV_DAC_BGADJ_MASK |\n\t\t\t\t\t R420_TV_DAC_DACADJ_MASK |\n\t\t\t\t\t R420_TV_DAC_RDACPD |\n\t\t\t\t\t R420_TV_DAC_GDACPD |\n\t\t\t\t\t R420_TV_DAC_BDACPD |\n\t\t\t\t\t R420_TV_DAC_TVENABLE);\n\t\t} else {\n\t\t\ttv_dac_cntl &= ~(RADEON_TV_DAC_STD_MASK |\n\t\t\t\t\t RADEON_TV_DAC_BGADJ_MASK |\n\t\t\t\t\t RADEON_TV_DAC_DACADJ_MASK |\n\t\t\t\t\t RADEON_TV_DAC_RDACPD |\n\t\t\t\t\t RADEON_TV_DAC_GDACPD |\n\t\t\t\t\t RADEON_TV_DAC_BDACPD);\n\t\t}\n\n\t\ttv_dac_cntl |= RADEON_TV_DAC_NBLANK | RADEON_TV_DAC_NHOLD;\n\n\t\tif (is_tv) {\n\t\t\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t\t\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t\t\t    tv_dac->tv_std == TV_STD_PAL_M ||\n\t\t\t    tv_dac->tv_std == TV_STD_PAL_60)\n\t\t\t\ttv_dac_cntl |= tv_dac->ntsc_tvdac_adj;\n\t\t\telse\n\t\t\t\ttv_dac_cntl |= tv_dac->pal_tvdac_adj;\n\n\t\t\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t\t\t    tv_dac->tv_std == TV_STD_NTSC_J)\n\t\t\t\ttv_dac_cntl |= RADEON_TV_DAC_STD_NTSC;\n\t\t\telse\n\t\t\t\ttv_dac_cntl |= RADEON_TV_DAC_STD_PAL;\n\t\t} else\n\t\t\ttv_dac_cntl |= (RADEON_TV_DAC_STD_PS2 |\n\t\t\t\t\ttv_dac->ps2_tvdac_adj);\n\n\t\tWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\n\t}\n\n\tif (ASIC_IS_R300(rdev)) {\n\t\tgpiopad_a = RREG32(RADEON_GPIOPAD_A) | 1;\n\t\tdisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL);\n\t} else if (rdev->family != CHIP_R200)\n\t\tdisp_hw_debug = RREG32(RADEON_DISP_HW_DEBUG);\n\telse if (rdev->family == CHIP_R200)\n\t\tfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\n\n\tif (rdev->family >= CHIP_R200)\n\t\tdisp_tv_out_cntl = RREG32(RADEON_DISP_TV_OUT_CNTL);\n\n\tif (is_tv) {\n\t\tuint32_t dac_cntl;\n\n\t\tdac_cntl = RREG32(RADEON_DAC_CNTL);\n\t\tdac_cntl &= ~RADEON_DAC_TVO_EN;\n\t\tWREG32(RADEON_DAC_CNTL, dac_cntl);\n\n\t\tif (ASIC_IS_R300(rdev))\n\t\t\tgpiopad_a = RREG32(RADEON_GPIOPAD_A) & ~1;\n\n\t\tdac2_cntl = RREG32(RADEON_DAC_CNTL2) & ~RADEON_DAC2_DAC2_CLK_SEL;\n\t\tif (radeon_crtc->crtc_id == 0) {\n\t\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\t\tdisp_output_cntl &= ~RADEON_DISP_TVDAC_SOURCE_MASK;\n\t\t\t\tdisp_output_cntl |= (RADEON_DISP_TVDAC_SOURCE_CRTC |\n\t\t\t\t\t\t     RADEON_DISP_TV_SOURCE_CRTC);\n\t\t\t}\n\t\t\tif (rdev->family >= CHIP_R200) {\n\t\t\t\tdisp_tv_out_cntl &= ~RADEON_DISP_TV_PATH_SRC_CRTC2;\n\t\t\t} else {\n\t\t\t\tdisp_hw_debug |= RADEON_CRT2_DISP1_SEL;\n\t\t\t}\n\t\t} else {\n\t\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\t\tdisp_output_cntl &= ~RADEON_DISP_TVDAC_SOURCE_MASK;\n\t\t\t\tdisp_output_cntl |= RADEON_DISP_TV_SOURCE_CRTC;\n\t\t\t}\n\t\t\tif (rdev->family >= CHIP_R200) {\n\t\t\t\tdisp_tv_out_cntl |= RADEON_DISP_TV_PATH_SRC_CRTC2;\n\t\t\t} else {\n\t\t\t\tdisp_hw_debug &= ~RADEON_CRT2_DISP1_SEL;\n\t\t\t}\n\t\t}\n\t\tWREG32(RADEON_DAC_CNTL2, dac2_cntl);\n\t} else {\n\n\t\tdac2_cntl = RREG32(RADEON_DAC_CNTL2) | RADEON_DAC2_DAC2_CLK_SEL;\n\n\t\tif (radeon_crtc->crtc_id == 0) {\n\t\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\t\tdisp_output_cntl &= ~RADEON_DISP_TVDAC_SOURCE_MASK;\n\t\t\t\tdisp_output_cntl |= RADEON_DISP_TVDAC_SOURCE_CRTC;\n\t\t\t} else if (rdev->family == CHIP_R200) {\n\t\t\t\tfp2_gen_cntl &= ~(R200_FP2_SOURCE_SEL_MASK |\n\t\t\t\t\t\t  RADEON_FP2_DVO_RATE_SEL_SDR);\n\t\t\t} else\n\t\t\t\tdisp_hw_debug |= RADEON_CRT2_DISP1_SEL;\n\t\t} else {\n\t\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\t\tdisp_output_cntl &= ~RADEON_DISP_TVDAC_SOURCE_MASK;\n\t\t\t\tdisp_output_cntl |= RADEON_DISP_TVDAC_SOURCE_CRTC2;\n\t\t\t} else if (rdev->family == CHIP_R200) {\n\t\t\t\tfp2_gen_cntl &= ~(R200_FP2_SOURCE_SEL_MASK |\n\t\t\t\t\t\t  RADEON_FP2_DVO_RATE_SEL_SDR);\n\t\t\t\tfp2_gen_cntl |= R200_FP2_SOURCE_SEL_CRTC2;\n\t\t\t} else\n\t\t\t\tdisp_hw_debug &= ~RADEON_CRT2_DISP1_SEL;\n\t\t}\n\t\tWREG32(RADEON_DAC_CNTL2, dac2_cntl);\n\t}\n\n\tif (ASIC_IS_R300(rdev)) {\n\t\tWREG32_P(RADEON_GPIOPAD_A, gpiopad_a, ~1);\n\t\tWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\n\t} else if (rdev->family != CHIP_R200)\n\t\tWREG32(RADEON_DISP_HW_DEBUG, disp_hw_debug);\n\telse if (rdev->family == CHIP_R200)\n\t\tWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\n\n\tif (rdev->family >= CHIP_R200)\n\t\tWREG32(RADEON_DISP_TV_OUT_CNTL, disp_tv_out_cntl);\n\n\tif (is_tv)\n\t\tradeon_legacy_tv_mode_set(encoder, mode, adjusted_mode);\n\n\tif (rdev->is_atom_bios)\n\t\tradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n\telse\n\t\tradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\n\n}\n\nstatic bool r300_legacy_tv_detect(struct drm_encoder *encoder,\n\t\t\t\t  struct drm_connector *connector)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t crtc2_gen_cntl, tv_dac_cntl, dac_cntl2, dac_ext_cntl;\n\tuint32_t disp_output_cntl, gpiopad_a, tmp;\n\tbool found = false;\n\n\t \n\tgpiopad_a = RREG32(RADEON_GPIOPAD_A);\n\tdac_cntl2 = RREG32(RADEON_DAC_CNTL2);\n\tcrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL);\n\tdac_ext_cntl = RREG32(RADEON_DAC_EXT_CNTL);\n\ttv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\n\tdisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL);\n\n\tWREG32_P(RADEON_GPIOPAD_A, 0, ~1);\n\n\tWREG32(RADEON_DAC_CNTL2, RADEON_DAC2_DAC2_CLK_SEL);\n\n\tWREG32(RADEON_CRTC2_GEN_CNTL,\n\t       RADEON_CRTC2_CRT2_ON | RADEON_CRTC2_VSYNC_TRISTAT);\n\n\ttmp = disp_output_cntl & ~RADEON_DISP_TVDAC_SOURCE_MASK;\n\ttmp |= RADEON_DISP_TVDAC_SOURCE_CRTC2;\n\tWREG32(RADEON_DISP_OUTPUT_CNTL, tmp);\n\n\tWREG32(RADEON_DAC_EXT_CNTL,\n\t       RADEON_DAC2_FORCE_BLANK_OFF_EN |\n\t       RADEON_DAC2_FORCE_DATA_EN |\n\t       RADEON_DAC_FORCE_DATA_SEL_RGB |\n\t       (0xec << RADEON_DAC_FORCE_DATA_SHIFT));\n\n\tWREG32(RADEON_TV_DAC_CNTL,\n\t       RADEON_TV_DAC_STD_NTSC |\n\t       (8 << RADEON_TV_DAC_BGADJ_SHIFT) |\n\t       (6 << RADEON_TV_DAC_DACADJ_SHIFT));\n\n\tRREG32(RADEON_TV_DAC_CNTL);\n\tmdelay(4);\n\n\tWREG32(RADEON_TV_DAC_CNTL,\n\t       RADEON_TV_DAC_NBLANK |\n\t       RADEON_TV_DAC_NHOLD |\n\t       RADEON_TV_MONITOR_DETECT_EN |\n\t       RADEON_TV_DAC_STD_NTSC |\n\t       (8 << RADEON_TV_DAC_BGADJ_SHIFT) |\n\t       (6 << RADEON_TV_DAC_DACADJ_SHIFT));\n\n\tRREG32(RADEON_TV_DAC_CNTL);\n\tmdelay(6);\n\n\ttmp = RREG32(RADEON_TV_DAC_CNTL);\n\tif ((tmp & RADEON_TV_DAC_GDACDET) != 0) {\n\t\tfound = true;\n\t\tDRM_DEBUG_KMS(\"S-video TV connection detected\\n\");\n\t} else if ((tmp & RADEON_TV_DAC_BDACDET) != 0) {\n\t\tfound = true;\n\t\tDRM_DEBUG_KMS(\"Composite TV connection detected\\n\");\n\t}\n\n\tWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\n\tWREG32(RADEON_DAC_EXT_CNTL, dac_ext_cntl);\n\tWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\n\tWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\n\tWREG32(RADEON_DAC_CNTL2, dac_cntl2);\n\tWREG32_P(RADEON_GPIOPAD_A, gpiopad_a, ~1);\n\treturn found;\n}\n\nstatic bool radeon_legacy_tv_detect(struct drm_encoder *encoder,\n\t\t\t\t    struct drm_connector *connector)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t tv_dac_cntl, dac_cntl2;\n\tuint32_t config_cntl, tv_pre_dac_mux_cntl, tv_master_cntl, tmp;\n\tbool found = false;\n\n\tif (ASIC_IS_R300(rdev))\n\t\treturn r300_legacy_tv_detect(encoder, connector);\n\n\tdac_cntl2 = RREG32(RADEON_DAC_CNTL2);\n\ttv_master_cntl = RREG32(RADEON_TV_MASTER_CNTL);\n\ttv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\n\tconfig_cntl = RREG32(RADEON_CONFIG_CNTL);\n\ttv_pre_dac_mux_cntl = RREG32(RADEON_TV_PRE_DAC_MUX_CNTL);\n\n\ttmp = dac_cntl2 & ~RADEON_DAC2_DAC2_CLK_SEL;\n\tWREG32(RADEON_DAC_CNTL2, tmp);\n\n\ttmp = tv_master_cntl | RADEON_TV_ON;\n\ttmp &= ~(RADEON_TV_ASYNC_RST |\n\t\t RADEON_RESTART_PHASE_FIX |\n\t\t RADEON_CRT_FIFO_CE_EN |\n\t\t RADEON_TV_FIFO_CE_EN |\n\t\t RADEON_RE_SYNC_NOW_SEL_MASK);\n\ttmp |= RADEON_TV_FIFO_ASYNC_RST | RADEON_CRT_ASYNC_RST;\n\tWREG32(RADEON_TV_MASTER_CNTL, tmp);\n\n\ttmp = RADEON_TV_DAC_NBLANK | RADEON_TV_DAC_NHOLD |\n\t\tRADEON_TV_MONITOR_DETECT_EN | RADEON_TV_DAC_STD_NTSC |\n\t\t(8 << RADEON_TV_DAC_BGADJ_SHIFT);\n\n\tif (config_cntl & RADEON_CFG_ATI_REV_ID_MASK)\n\t\ttmp |= (4 << RADEON_TV_DAC_DACADJ_SHIFT);\n\telse\n\t\ttmp |= (8 << RADEON_TV_DAC_DACADJ_SHIFT);\n\tWREG32(RADEON_TV_DAC_CNTL, tmp);\n\n\ttmp = RADEON_C_GRN_EN | RADEON_CMP_BLU_EN |\n\t\tRADEON_RED_MX_FORCE_DAC_DATA |\n\t\tRADEON_GRN_MX_FORCE_DAC_DATA |\n\t\tRADEON_BLU_MX_FORCE_DAC_DATA |\n\t\t(0x109 << RADEON_TV_FORCE_DAC_DATA_SHIFT);\n\tWREG32(RADEON_TV_PRE_DAC_MUX_CNTL, tmp);\n\n\tmdelay(3);\n\ttmp = RREG32(RADEON_TV_DAC_CNTL);\n\tif (tmp & RADEON_TV_DAC_GDACDET) {\n\t\tfound = true;\n\t\tDRM_DEBUG_KMS(\"S-video TV connection detected\\n\");\n\t} else if ((tmp & RADEON_TV_DAC_BDACDET) != 0) {\n\t\tfound = true;\n\t\tDRM_DEBUG_KMS(\"Composite TV connection detected\\n\");\n\t}\n\n\tWREG32(RADEON_TV_PRE_DAC_MUX_CNTL, tv_pre_dac_mux_cntl);\n\tWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\n\tWREG32(RADEON_TV_MASTER_CNTL, tv_master_cntl);\n\tWREG32(RADEON_DAC_CNTL2, dac_cntl2);\n\treturn found;\n}\n\nstatic bool radeon_legacy_ext_dac_detect(struct drm_encoder *encoder,\n\t\t\t\t\t struct drm_connector *connector)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t gpio_monid, fp2_gen_cntl, disp_output_cntl, crtc2_gen_cntl;\n\tuint32_t disp_lin_trans_grph_a, disp_lin_trans_grph_b, disp_lin_trans_grph_c;\n\tuint32_t disp_lin_trans_grph_d, disp_lin_trans_grph_e, disp_lin_trans_grph_f;\n\tuint32_t tmp, crtc2_h_total_disp, crtc2_v_total_disp;\n\tuint32_t crtc2_h_sync_strt_wid, crtc2_v_sync_strt_wid;\n\tbool found = false;\n\tint i;\n\n\t \n\tgpio_monid = RREG32(RADEON_GPIO_MONID);\n\tfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\n\tdisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL);\n\tcrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL);\n\tdisp_lin_trans_grph_a = RREG32(RADEON_DISP_LIN_TRANS_GRPH_A);\n\tdisp_lin_trans_grph_b = RREG32(RADEON_DISP_LIN_TRANS_GRPH_B);\n\tdisp_lin_trans_grph_c = RREG32(RADEON_DISP_LIN_TRANS_GRPH_C);\n\tdisp_lin_trans_grph_d = RREG32(RADEON_DISP_LIN_TRANS_GRPH_D);\n\tdisp_lin_trans_grph_e = RREG32(RADEON_DISP_LIN_TRANS_GRPH_E);\n\tdisp_lin_trans_grph_f = RREG32(RADEON_DISP_LIN_TRANS_GRPH_F);\n\tcrtc2_h_total_disp = RREG32(RADEON_CRTC2_H_TOTAL_DISP);\n\tcrtc2_v_total_disp = RREG32(RADEON_CRTC2_V_TOTAL_DISP);\n\tcrtc2_h_sync_strt_wid = RREG32(RADEON_CRTC2_H_SYNC_STRT_WID);\n\tcrtc2_v_sync_strt_wid = RREG32(RADEON_CRTC2_V_SYNC_STRT_WID);\n\n\ttmp = RREG32(RADEON_GPIO_MONID);\n\ttmp &= ~RADEON_GPIO_A_0;\n\tWREG32(RADEON_GPIO_MONID, tmp);\n\n\tWREG32(RADEON_FP2_GEN_CNTL, (RADEON_FP2_ON |\n\t\t\t\t     RADEON_FP2_PANEL_FORMAT |\n\t\t\t\t     R200_FP2_SOURCE_SEL_TRANS_UNIT |\n\t\t\t\t     RADEON_FP2_DVO_EN |\n\t\t\t\t     R200_FP2_DVO_RATE_SEL_SDR));\n\n\tWREG32(RADEON_DISP_OUTPUT_CNTL, (RADEON_DISP_DAC_SOURCE_RMX |\n\t\t\t\t\t RADEON_DISP_TRANS_MATRIX_GRAPHICS));\n\n\tWREG32(RADEON_CRTC2_GEN_CNTL, (RADEON_CRTC2_EN |\n\t\t\t\t       RADEON_CRTC2_DISP_REQ_EN_B));\n\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_A, 0x00000000);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_B, 0x000003f0);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_C, 0x00000000);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_D, 0x000003f0);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_E, 0x00000000);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_F, 0x000003f0);\n\n\tWREG32(RADEON_CRTC2_H_TOTAL_DISP, 0x01000008);\n\tWREG32(RADEON_CRTC2_H_SYNC_STRT_WID, 0x00000800);\n\tWREG32(RADEON_CRTC2_V_TOTAL_DISP, 0x00080001);\n\tWREG32(RADEON_CRTC2_V_SYNC_STRT_WID, 0x00000080);\n\n\tfor (i = 0; i < 200; i++) {\n\t\ttmp = RREG32(RADEON_GPIO_MONID);\n\t\tif (tmp & RADEON_GPIO_Y_0)\n\t\t\tfound = true;\n\n\t\tif (found)\n\t\t\tbreak;\n\n\t\tif (!drm_can_sleep())\n\t\t\tmdelay(1);\n\t\telse\n\t\t\tmsleep(1);\n\t}\n\n\t \n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_A, disp_lin_trans_grph_a);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_B, disp_lin_trans_grph_b);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_C, disp_lin_trans_grph_c);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_D, disp_lin_trans_grph_d);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_E, disp_lin_trans_grph_e);\n\tWREG32(RADEON_DISP_LIN_TRANS_GRPH_F, disp_lin_trans_grph_f);\n\tWREG32(RADEON_CRTC2_H_TOTAL_DISP, crtc2_h_total_disp);\n\tWREG32(RADEON_CRTC2_V_TOTAL_DISP, crtc2_v_total_disp);\n\tWREG32(RADEON_CRTC2_H_SYNC_STRT_WID, crtc2_h_sync_strt_wid);\n\tWREG32(RADEON_CRTC2_V_SYNC_STRT_WID, crtc2_v_sync_strt_wid);\n\tWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\n\tWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\n\tWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\n\tWREG32(RADEON_GPIO_MONID, gpio_monid);\n\n\treturn found;\n}\n\nstatic enum drm_connector_status radeon_legacy_tv_dac_detect(struct drm_encoder *encoder,\n\t\t\t\t\t\t\t     struct drm_connector *connector)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t crtc2_gen_cntl = 0, tv_dac_cntl, dac_cntl2, dac_ext_cntl;\n\tuint32_t gpiopad_a = 0, pixclks_cntl, tmp;\n\tuint32_t disp_output_cntl = 0, disp_hw_debug = 0, crtc_ext_cntl = 0;\n\tenum drm_connector_status found = connector_status_disconnected;\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\n\tbool color = true;\n\tstruct drm_crtc *crtc;\n\n\t \n\tlist_for_each_entry(crtc, &dev->mode_config.crtc_list, head) {\n\t\tstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\n\t\tif ((radeon_crtc->crtc_id == 1) && crtc->enabled) {\n\t\t\tif (encoder->crtc != crtc) {\n\t\t\t\treturn connector_status_disconnected;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (connector->connector_type == DRM_MODE_CONNECTOR_SVIDEO ||\n\t    connector->connector_type == DRM_MODE_CONNECTOR_Composite ||\n\t    connector->connector_type == DRM_MODE_CONNECTOR_9PinDIN) {\n\t\tbool tv_detect;\n\n\t\tif (radeon_encoder->active_device && !(radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT))\n\t\t\treturn connector_status_disconnected;\n\n\t\ttv_detect = radeon_legacy_tv_detect(encoder, connector);\n\t\tif (tv_detect && tv_dac)\n\t\t\tfound = connector_status_connected;\n\t\treturn found;\n\t}\n\n\t \n\tif (radeon_encoder->active_device && !(radeon_encoder->active_device & ATOM_DEVICE_CRT_SUPPORT)) {\n\t\tDRM_INFO(\"not detecting due to %08x\\n\", radeon_encoder->active_device);\n\t\treturn connector_status_disconnected;\n\t}\n\n\t \n\tif (rdev->family == CHIP_R200) {\n\t\tif (radeon_legacy_ext_dac_detect(encoder, connector))\n\t\t\tfound = connector_status_connected;\n\t\treturn found;\n\t}\n\n\t \n\tpixclks_cntl = RREG32_PLL(RADEON_PIXCLKS_CNTL);\n\n\tif (rdev->flags & RADEON_SINGLE_CRTC) {\n\t\tcrtc_ext_cntl = RREG32(RADEON_CRTC_EXT_CNTL);\n\t} else {\n\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\tgpiopad_a = RREG32(RADEON_GPIOPAD_A);\n\t\t\tdisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL);\n\t\t} else {\n\t\t\tdisp_hw_debug = RREG32(RADEON_DISP_HW_DEBUG);\n\t\t}\n\t\tcrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL);\n\t}\n\ttv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\n\tdac_ext_cntl = RREG32(RADEON_DAC_EXT_CNTL);\n\tdac_cntl2 = RREG32(RADEON_DAC_CNTL2);\n\n\ttmp = pixclks_cntl & ~(RADEON_PIX2CLK_ALWAYS_ONb\n\t\t\t       | RADEON_PIX2CLK_DAC_ALWAYS_ONb);\n\tWREG32_PLL(RADEON_PIXCLKS_CNTL, tmp);\n\n\tif (rdev->flags & RADEON_SINGLE_CRTC) {\n\t\ttmp = crtc_ext_cntl | RADEON_CRTC_CRT_ON;\n\t\tWREG32(RADEON_CRTC_EXT_CNTL, tmp);\n\t} else {\n\t\ttmp = crtc2_gen_cntl & ~RADEON_CRTC2_PIX_WIDTH_MASK;\n\t\ttmp |= RADEON_CRTC2_CRT2_ON |\n\t\t\t(2 << RADEON_CRTC2_PIX_WIDTH_SHIFT);\n\t\tWREG32(RADEON_CRTC2_GEN_CNTL, tmp);\n\n\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\tWREG32_P(RADEON_GPIOPAD_A, 1, ~1);\n\t\t\ttmp = disp_output_cntl & ~RADEON_DISP_TVDAC_SOURCE_MASK;\n\t\t\ttmp |= RADEON_DISP_TVDAC_SOURCE_CRTC2;\n\t\t\tWREG32(RADEON_DISP_OUTPUT_CNTL, tmp);\n\t\t} else {\n\t\t\ttmp = disp_hw_debug & ~RADEON_CRT2_DISP1_SEL;\n\t\t\tWREG32(RADEON_DISP_HW_DEBUG, tmp);\n\t\t}\n\t}\n\n\ttmp = RADEON_TV_DAC_NBLANK |\n\t\tRADEON_TV_DAC_NHOLD |\n\t\tRADEON_TV_MONITOR_DETECT_EN |\n\t\tRADEON_TV_DAC_STD_PS2;\n\n\tWREG32(RADEON_TV_DAC_CNTL, tmp);\n\n\ttmp = RADEON_DAC2_FORCE_BLANK_OFF_EN |\n\t\tRADEON_DAC2_FORCE_DATA_EN;\n\n\tif (color)\n\t\ttmp |= RADEON_DAC_FORCE_DATA_SEL_RGB;\n\telse\n\t\ttmp |= RADEON_DAC_FORCE_DATA_SEL_G;\n\n\tif (ASIC_IS_R300(rdev))\n\t\ttmp |= (0x1b6 << RADEON_DAC_FORCE_DATA_SHIFT);\n\telse\n\t\ttmp |= (0x180 << RADEON_DAC_FORCE_DATA_SHIFT);\n\n\tWREG32(RADEON_DAC_EXT_CNTL, tmp);\n\n\ttmp = dac_cntl2 | RADEON_DAC2_DAC2_CLK_SEL | RADEON_DAC2_CMP_EN;\n\tWREG32(RADEON_DAC_CNTL2, tmp);\n\n\tmdelay(10);\n\n\tif (ASIC_IS_R300(rdev)) {\n\t\tif (RREG32(RADEON_DAC_CNTL2) & RADEON_DAC2_CMP_OUT_B)\n\t\t\tfound = connector_status_connected;\n\t} else {\n\t\tif (RREG32(RADEON_DAC_CNTL2) & RADEON_DAC2_CMP_OUTPUT)\n\t\t\tfound = connector_status_connected;\n\t}\n\n\t \n\tWREG32(RADEON_DAC_CNTL2, dac_cntl2);\n\tWREG32(RADEON_DAC_EXT_CNTL, dac_ext_cntl);\n\tWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\n\n\tif (rdev->flags & RADEON_SINGLE_CRTC) {\n\t\tWREG32(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl);\n\t} else {\n\t\tWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\n\t\tif (ASIC_IS_R300(rdev)) {\n\t\t\tWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\n\t\t\tWREG32_P(RADEON_GPIOPAD_A, gpiopad_a, ~1);\n\t\t} else {\n\t\t\tWREG32(RADEON_DISP_HW_DEBUG, disp_hw_debug);\n\t\t}\n\t}\n\n\tWREG32_PLL(RADEON_PIXCLKS_CNTL, pixclks_cntl);\n\n\treturn found;\n\n}\n\nstatic const struct drm_encoder_helper_funcs radeon_legacy_tv_dac_helper_funcs = {\n\t.dpms = radeon_legacy_tv_dac_dpms,\n\t.mode_fixup = radeon_legacy_mode_fixup,\n\t.prepare = radeon_legacy_tv_dac_prepare,\n\t.mode_set = radeon_legacy_tv_dac_mode_set,\n\t.commit = radeon_legacy_tv_dac_commit,\n\t.detect = radeon_legacy_tv_dac_detect,\n\t.disable = radeon_legacy_encoder_disable,\n};\n\n\nstatic const struct drm_encoder_funcs radeon_legacy_tv_dac_enc_funcs = {\n\t.destroy = radeon_enc_destroy,\n};\n\n\nstatic struct radeon_encoder_int_tmds *radeon_legacy_get_tmds_info(struct radeon_encoder *encoder)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder_int_tmds *tmds;\n\tbool ret;\n\n\ttmds = kzalloc(sizeof(struct radeon_encoder_int_tmds), GFP_KERNEL);\n\n\tif (!tmds)\n\t\treturn NULL;\n\n\tif (rdev->is_atom_bios)\n\t\tret = radeon_atombios_get_tmds_info(encoder, tmds);\n\telse\n\t\tret = radeon_legacy_get_tmds_info_from_combios(encoder, tmds);\n\n\tif (!ret)\n\t\tradeon_legacy_get_tmds_info_from_table(encoder, tmds);\n\n\treturn tmds;\n}\n\nstatic struct radeon_encoder_ext_tmds *radeon_legacy_get_ext_tmds_info(struct radeon_encoder *encoder)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder_ext_tmds *tmds;\n\tbool ret;\n\n\tif (rdev->is_atom_bios)\n\t\treturn NULL;\n\n\ttmds = kzalloc(sizeof(struct radeon_encoder_ext_tmds), GFP_KERNEL);\n\n\tif (!tmds)\n\t\treturn NULL;\n\n\tret = radeon_legacy_get_ext_tmds_info_from_combios(encoder, tmds);\n\n\tif (!ret)\n\t\tradeon_legacy_get_ext_tmds_info_from_table(encoder, tmds);\n\n\treturn tmds;\n}\n\nvoid\nradeon_add_legacy_encoder(struct drm_device *dev, uint32_t encoder_enum, uint32_t supported_device)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct drm_encoder *encoder;\n\tstruct radeon_encoder *radeon_encoder;\n\n\t \n\tlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\n\t\tradeon_encoder = to_radeon_encoder(encoder);\n\t\tif (radeon_encoder->encoder_enum == encoder_enum) {\n\t\t\tradeon_encoder->devices |= supported_device;\n\t\t\treturn;\n\t\t}\n\n\t}\n\n\t \n\tradeon_encoder = kzalloc(sizeof(struct radeon_encoder), GFP_KERNEL);\n\tif (!radeon_encoder)\n\t\treturn;\n\n\tencoder = &radeon_encoder->base;\n\tif (rdev->flags & RADEON_SINGLE_CRTC)\n\t\tencoder->possible_crtcs = 0x1;\n\telse\n\t\tencoder->possible_crtcs = 0x3;\n\n\tradeon_encoder->enc_priv = NULL;\n\n\tradeon_encoder->encoder_enum = encoder_enum;\n\tradeon_encoder->encoder_id = (encoder_enum & OBJECT_ID_MASK) >> OBJECT_ID_SHIFT;\n\tradeon_encoder->devices = supported_device;\n\tradeon_encoder->rmx_type = RMX_OFF;\n\n\tswitch (radeon_encoder->encoder_id) {\n\tcase ENCODER_OBJECT_ID_INTERNAL_LVDS:\n\t\tencoder->possible_crtcs = 0x1;\n\t\tdrm_encoder_init(dev, encoder, &radeon_legacy_lvds_enc_funcs,\n\t\t\t\t DRM_MODE_ENCODER_LVDS, NULL);\n\t\tdrm_encoder_helper_add(encoder, &radeon_legacy_lvds_helper_funcs);\n\t\tif (rdev->is_atom_bios)\n\t\t\tradeon_encoder->enc_priv = radeon_atombios_get_lvds_info(radeon_encoder);\n\t\telse\n\t\t\tradeon_encoder->enc_priv = radeon_combios_get_lvds_info(radeon_encoder);\n\t\tradeon_encoder->rmx_type = RMX_FULL;\n\t\tbreak;\n\tcase ENCODER_OBJECT_ID_INTERNAL_TMDS1:\n\t\tdrm_encoder_init(dev, encoder, &radeon_legacy_tmds_int_enc_funcs,\n\t\t\t\t DRM_MODE_ENCODER_TMDS, NULL);\n\t\tdrm_encoder_helper_add(encoder, &radeon_legacy_tmds_int_helper_funcs);\n\t\tradeon_encoder->enc_priv = radeon_legacy_get_tmds_info(radeon_encoder);\n\t\tbreak;\n\tcase ENCODER_OBJECT_ID_INTERNAL_DAC1:\n\t\tdrm_encoder_init(dev, encoder, &radeon_legacy_primary_dac_enc_funcs,\n\t\t\t\t DRM_MODE_ENCODER_DAC, NULL);\n\t\tdrm_encoder_helper_add(encoder, &radeon_legacy_primary_dac_helper_funcs);\n\t\tif (rdev->is_atom_bios)\n\t\t\tradeon_encoder->enc_priv = radeon_atombios_get_primary_dac_info(radeon_encoder);\n\t\telse\n\t\t\tradeon_encoder->enc_priv = radeon_combios_get_primary_dac_info(radeon_encoder);\n\t\tbreak;\n\tcase ENCODER_OBJECT_ID_INTERNAL_DAC2:\n\t\tdrm_encoder_init(dev, encoder, &radeon_legacy_tv_dac_enc_funcs,\n\t\t\t\t DRM_MODE_ENCODER_TVDAC, NULL);\n\t\tdrm_encoder_helper_add(encoder, &radeon_legacy_tv_dac_helper_funcs);\n\t\tif (rdev->is_atom_bios)\n\t\t\tradeon_encoder->enc_priv = radeon_atombios_get_tv_dac_info(radeon_encoder);\n\t\telse\n\t\t\tradeon_encoder->enc_priv = radeon_combios_get_tv_dac_info(radeon_encoder);\n\t\tbreak;\n\tcase ENCODER_OBJECT_ID_INTERNAL_DVO1:\n\t\tdrm_encoder_init(dev, encoder, &radeon_legacy_tmds_ext_enc_funcs,\n\t\t\t\t DRM_MODE_ENCODER_TMDS, NULL);\n\t\tdrm_encoder_helper_add(encoder, &radeon_legacy_tmds_ext_helper_funcs);\n\t\tif (!rdev->is_atom_bios)\n\t\t\tradeon_encoder->enc_priv = radeon_legacy_get_ext_tmds_info(radeon_encoder);\n\t\tbreak;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}