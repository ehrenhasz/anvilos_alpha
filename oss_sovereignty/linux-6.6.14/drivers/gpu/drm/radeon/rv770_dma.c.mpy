{
  "module_name": "rv770_dma.c",
  "hash_id": "509f31ca418953c79ff4ed73433ba5c28a9177ca3a49bcfa3867145f10187653",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/rv770_dma.c",
  "human_readable_source": " \n\n#include \"radeon.h\"\n#include \"radeon_asic.h\"\n#include \"rv770d.h\"\n\n \nstruct radeon_fence *rv770_copy_dma(struct radeon_device *rdev,\n\t\t\t\t    uint64_t src_offset, uint64_t dst_offset,\n\t\t\t\t    unsigned num_gpu_pages,\n\t\t\t\t    struct dma_resv *resv)\n{\n\tstruct radeon_fence *fence;\n\tstruct radeon_sync sync;\n\tint ring_index = rdev->asic->copy.dma_ring_index;\n\tstruct radeon_ring *ring = &rdev->ring[ring_index];\n\tu32 size_in_dw, cur_size_in_dw;\n\tint i, num_loops;\n\tint r = 0;\n\n\tradeon_sync_create(&sync);\n\n\tsize_in_dw = (num_gpu_pages << RADEON_GPU_PAGE_SHIFT) / 4;\n\tnum_loops = DIV_ROUND_UP(size_in_dw, 0xFFFF);\n\tr = radeon_ring_lock(rdev, ring, num_loops * 5 + 8);\n\tif (r) {\n\t\tDRM_ERROR(\"radeon: moving bo (%d).\\n\", r);\n\t\tradeon_sync_free(rdev, &sync, NULL);\n\t\treturn ERR_PTR(r);\n\t}\n\n\tradeon_sync_resv(rdev, &sync, resv, false);\n\tradeon_sync_rings(rdev, &sync, ring->idx);\n\n\tfor (i = 0; i < num_loops; i++) {\n\t\tcur_size_in_dw = size_in_dw;\n\t\tif (cur_size_in_dw > 0xFFFF)\n\t\t\tcur_size_in_dw = 0xFFFF;\n\t\tsize_in_dw -= cur_size_in_dw;\n\t\tradeon_ring_write(ring, DMA_PACKET(DMA_PACKET_COPY, 0, 0, cur_size_in_dw));\n\t\tradeon_ring_write(ring, dst_offset & 0xfffffffc);\n\t\tradeon_ring_write(ring, src_offset & 0xfffffffc);\n\t\tradeon_ring_write(ring, upper_32_bits(dst_offset) & 0xff);\n\t\tradeon_ring_write(ring, upper_32_bits(src_offset) & 0xff);\n\t\tsrc_offset += cur_size_in_dw * 4;\n\t\tdst_offset += cur_size_in_dw * 4;\n\t}\n\n\tr = radeon_fence_emit(rdev, &fence, ring->idx);\n\tif (r) {\n\t\tradeon_ring_unlock_undo(rdev, ring);\n\t\tradeon_sync_free(rdev, &sync, NULL);\n\t\treturn ERR_PTR(r);\n\t}\n\n\tradeon_ring_unlock_commit(rdev, ring, false);\n\tradeon_sync_free(rdev, &sync, fence);\n\n\treturn fence;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}