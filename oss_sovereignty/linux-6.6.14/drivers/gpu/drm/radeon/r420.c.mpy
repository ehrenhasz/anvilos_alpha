{
  "module_name": "r420.c",
  "hash_id": "b37a005657d258f2b31c32ecc0acc7b143101d08e353551b6a0b34b72e35a5f0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/r420.c",
  "human_readable_source": " \n\n#include <linux/pci.h>\n#include <linux/seq_file.h>\n#include <linux/slab.h>\n\n#include <drm/drm_device.h>\n#include <drm/drm_file.h>\n\n#include \"atom.h\"\n#include \"r100d.h\"\n#include \"r420_reg_safe.h\"\n#include \"r420d.h\"\n#include \"radeon.h\"\n#include \"radeon_asic.h\"\n#include \"radeon_reg.h\"\n\nvoid r420_pm_init_profile(struct radeon_device *rdev)\n{\n\t \n\trdev->pm.profiles[PM_PROFILE_DEFAULT_IDX].dpms_off_ps_idx = rdev->pm.default_power_state_index;\n\trdev->pm.profiles[PM_PROFILE_DEFAULT_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\n\trdev->pm.profiles[PM_PROFILE_DEFAULT_IDX].dpms_off_cm_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_DEFAULT_IDX].dpms_on_cm_idx = 0;\n\t \n\trdev->pm.profiles[PM_PROFILE_LOW_SH_IDX].dpms_off_ps_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_LOW_SH_IDX].dpms_on_ps_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_LOW_SH_IDX].dpms_off_cm_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_LOW_SH_IDX].dpms_on_cm_idx = 0;\n\t \n\trdev->pm.profiles[PM_PROFILE_MID_SH_IDX].dpms_off_ps_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_MID_SH_IDX].dpms_on_ps_idx = 1;\n\trdev->pm.profiles[PM_PROFILE_MID_SH_IDX].dpms_off_cm_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_MID_SH_IDX].dpms_on_cm_idx = 0;\n\t \n\trdev->pm.profiles[PM_PROFILE_HIGH_SH_IDX].dpms_off_ps_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_HIGH_SH_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\n\trdev->pm.profiles[PM_PROFILE_HIGH_SH_IDX].dpms_off_cm_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_HIGH_SH_IDX].dpms_on_cm_idx = 0;\n\t \n\trdev->pm.profiles[PM_PROFILE_LOW_MH_IDX].dpms_off_ps_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_LOW_MH_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\n\trdev->pm.profiles[PM_PROFILE_LOW_MH_IDX].dpms_off_cm_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_LOW_MH_IDX].dpms_on_cm_idx = 0;\n\t \n\trdev->pm.profiles[PM_PROFILE_MID_MH_IDX].dpms_off_ps_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_MID_MH_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\n\trdev->pm.profiles[PM_PROFILE_MID_MH_IDX].dpms_off_cm_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_MID_MH_IDX].dpms_on_cm_idx = 0;\n\t \n\trdev->pm.profiles[PM_PROFILE_HIGH_MH_IDX].dpms_off_ps_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_HIGH_MH_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\n\trdev->pm.profiles[PM_PROFILE_HIGH_MH_IDX].dpms_off_cm_idx = 0;\n\trdev->pm.profiles[PM_PROFILE_HIGH_MH_IDX].dpms_on_cm_idx = 0;\n}\n\nstatic void r420_set_reg_safe(struct radeon_device *rdev)\n{\n\trdev->config.r300.reg_safe_bm = r420_reg_safe_bm;\n\trdev->config.r300.reg_safe_bm_size = ARRAY_SIZE(r420_reg_safe_bm);\n}\n\nvoid r420_pipes_init(struct radeon_device *rdev)\n{\n\tunsigned tmp;\n\tunsigned gb_pipe_select;\n\tunsigned num_pipes;\n\n\t \n\tWREG32(R300_GA_ENHANCE, R300_GA_DEADLOCK_CNTL | R300_GA_FASTSYNC_CNTL |\n\t       (1 << 2) | (1 << 3));\n\t \n\tif (r100_gui_wait_for_idle(rdev)) {\n\t\tpr_warn(\"Failed to wait GUI idle while programming pipes. Bad things might happen.\\n\");\n\t}\n\t \n\tgb_pipe_select = RREG32(R400_GB_PIPE_SELECT);\n\tnum_pipes = ((gb_pipe_select >> 12) & 3) + 1;\n\n\t \n\tif ((rdev->pdev->device == 0x5e4c) ||\n\t    (rdev->pdev->device == 0x5e4f))\n\t\tnum_pipes = 1;\n\n\trdev->num_gb_pipes = num_pipes;\n\ttmp = 0;\n\tswitch (num_pipes) {\n\tdefault:\n\t\t \n\t\tnum_pipes = 1;\n\t\tfallthrough;\n\tcase 1:\n\t\ttmp = (0 << 1);\n\t\tbreak;\n\tcase 2:\n\t\ttmp = (3 << 1);\n\t\tbreak;\n\tcase 3:\n\t\ttmp = (6 << 1);\n\t\tbreak;\n\tcase 4:\n\t\ttmp = (7 << 1);\n\t\tbreak;\n\t}\n\tWREG32(R500_SU_REG_DEST, (1 << num_pipes) - 1);\n\t \n\ttmp |= R300_TILE_SIZE_16 | R300_ENABLE_TILING;\n\tWREG32(R300_GB_TILE_CONFIG, tmp);\n\tif (r100_gui_wait_for_idle(rdev)) {\n\t\tpr_warn(\"Failed to wait GUI idle while programming pipes. Bad things might happen.\\n\");\n\t}\n\n\ttmp = RREG32(R300_DST_PIPE_CONFIG);\n\tWREG32(R300_DST_PIPE_CONFIG, tmp | R300_PIPE_AUTO_CONFIG);\n\n\tWREG32(R300_RB2D_DSTCACHE_MODE,\n\t       RREG32(R300_RB2D_DSTCACHE_MODE) |\n\t       R300_DC_AUTOFLUSH_ENABLE |\n\t       R300_DC_DC_DISABLE_IGNORE_PE);\n\n\tif (r100_gui_wait_for_idle(rdev)) {\n\t\tpr_warn(\"Failed to wait GUI idle while programming pipes. Bad things might happen.\\n\");\n\t}\n\n\tif (rdev->family == CHIP_RV530) {\n\t\ttmp = RREG32(RV530_GB_PIPE_SELECT2);\n\t\tif ((tmp & 3) == 3)\n\t\t\trdev->num_z_pipes = 2;\n\t\telse\n\t\t\trdev->num_z_pipes = 1;\n\t} else\n\t\trdev->num_z_pipes = 1;\n\n\tDRM_INFO(\"radeon: %d quad pipes, %d z pipes initialized.\\n\",\n\t\t rdev->num_gb_pipes, rdev->num_z_pipes);\n}\n\nu32 r420_mc_rreg(struct radeon_device *rdev, u32 reg)\n{\n\tunsigned long flags;\n\tu32 r;\n\n\tspin_lock_irqsave(&rdev->mc_idx_lock, flags);\n\tWREG32(R_0001F8_MC_IND_INDEX, S_0001F8_MC_IND_ADDR(reg));\n\tr = RREG32(R_0001FC_MC_IND_DATA);\n\tspin_unlock_irqrestore(&rdev->mc_idx_lock, flags);\n\treturn r;\n}\n\nvoid r420_mc_wreg(struct radeon_device *rdev, u32 reg, u32 v)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&rdev->mc_idx_lock, flags);\n\tWREG32(R_0001F8_MC_IND_INDEX, S_0001F8_MC_IND_ADDR(reg) |\n\t\tS_0001F8_MC_IND_WR_EN(1));\n\tWREG32(R_0001FC_MC_IND_DATA, v);\n\tspin_unlock_irqrestore(&rdev->mc_idx_lock, flags);\n}\n\nstatic void r420_debugfs(struct radeon_device *rdev)\n{\n\tr100_debugfs_rbbm_init(rdev);\n\tr420_debugfs_pipes_info_init(rdev);\n}\n\nstatic void r420_clock_resume(struct radeon_device *rdev)\n{\n\tu32 sclk_cntl;\n\n\tif (radeon_dynclks != -1 && radeon_dynclks)\n\t\tradeon_atom_set_clock_gating(rdev, 1);\n\tsclk_cntl = RREG32_PLL(R_00000D_SCLK_CNTL);\n\tsclk_cntl |= S_00000D_FORCE_CP(1) | S_00000D_FORCE_VIP(1);\n\tif (rdev->family == CHIP_R420)\n\t\tsclk_cntl |= S_00000D_FORCE_PX(1) | S_00000D_FORCE_TX(1);\n\tWREG32_PLL(R_00000D_SCLK_CNTL, sclk_cntl);\n}\n\nstatic void r420_cp_errata_init(struct radeon_device *rdev)\n{\n\tint r;\n\tstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\n\n\t \n\tradeon_scratch_get(rdev, &rdev->config.r300.resync_scratch);\n\tr = radeon_ring_lock(rdev, ring, 8);\n\tWARN_ON(r);\n\tradeon_ring_write(ring, PACKET0(R300_CP_RESYNC_ADDR, 1));\n\tradeon_ring_write(ring, rdev->config.r300.resync_scratch);\n\tradeon_ring_write(ring, 0xDEADBEEF);\n\tradeon_ring_unlock_commit(rdev, ring, false);\n}\n\nstatic void r420_cp_errata_fini(struct radeon_device *rdev)\n{\n\tint r;\n\tstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\n\n\t \n\tr = radeon_ring_lock(rdev, ring, 8);\n\tWARN_ON(r);\n\tradeon_ring_write(ring, PACKET0(R300_RB3D_DSTCACHE_CTLSTAT, 0));\n\tradeon_ring_write(ring, R300_RB3D_DC_FINISH);\n\tradeon_ring_unlock_commit(rdev, ring, false);\n\tradeon_scratch_free(rdev, rdev->config.r300.resync_scratch);\n}\n\nstatic int r420_startup(struct radeon_device *rdev)\n{\n\tint r;\n\n\t \n\tr100_set_common_regs(rdev);\n\t \n\tr300_mc_program(rdev);\n\t \n\tr420_clock_resume(rdev);\n\t \n\tif (rdev->flags & RADEON_IS_PCIE) {\n\t\tr = rv370_pcie_gart_enable(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\tif (rdev->flags & RADEON_IS_PCI) {\n\t\tr = r100_pci_gart_enable(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\tr420_pipes_init(rdev);\n\n\t \n\tr = radeon_wb_init(rdev);\n\tif (r)\n\t\treturn r;\n\n\tr = radeon_fence_driver_start_ring(rdev, RADEON_RING_TYPE_GFX_INDEX);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed initializing CP fences (%d).\\n\", r);\n\t\treturn r;\n\t}\n\n\t \n\tif (!rdev->irq.installed) {\n\t\tr = radeon_irq_kms_init(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\n\tr100_irq_set(rdev);\n\trdev->config.r300.hdp_cntl = RREG32(RADEON_HOST_PATH_CNTL);\n\t \n\tr = r100_cp_init(rdev, 1024 * 1024);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed initializing CP (%d).\\n\", r);\n\t\treturn r;\n\t}\n\tr420_cp_errata_init(rdev);\n\n\tr = radeon_ib_pool_init(rdev);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"IB initialization failed (%d).\\n\", r);\n\t\treturn r;\n\t}\n\n\treturn 0;\n}\n\nint r420_resume(struct radeon_device *rdev)\n{\n\tint r;\n\n\t \n\tif (rdev->flags & RADEON_IS_PCIE)\n\t\trv370_pcie_gart_disable(rdev);\n\tif (rdev->flags & RADEON_IS_PCI)\n\t\tr100_pci_gart_disable(rdev);\n\t \n\tr420_clock_resume(rdev);\n\t \n\tif (radeon_asic_reset(rdev)) {\n\t\tdev_warn(rdev->dev, \"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\\n\",\n\t\t\tRREG32(R_000E40_RBBM_STATUS),\n\t\t\tRREG32(R_0007C0_CP_STAT));\n\t}\n\t \n\tif (rdev->is_atom_bios) {\n\t\tatom_asic_init(rdev->mode_info.atom_context);\n\t} else {\n\t\tradeon_combios_asic_init(rdev->ddev);\n\t}\n\t \n\tr420_clock_resume(rdev);\n\t \n\tradeon_surface_init(rdev);\n\n\trdev->accel_working = true;\n\tr = r420_startup(rdev);\n\tif (r) {\n\t\trdev->accel_working = false;\n\t}\n\treturn r;\n}\n\nint r420_suspend(struct radeon_device *rdev)\n{\n\tradeon_pm_suspend(rdev);\n\tr420_cp_errata_fini(rdev);\n\tr100_cp_disable(rdev);\n\tradeon_wb_disable(rdev);\n\tr100_irq_disable(rdev);\n\tif (rdev->flags & RADEON_IS_PCIE)\n\t\trv370_pcie_gart_disable(rdev);\n\tif (rdev->flags & RADEON_IS_PCI)\n\t\tr100_pci_gart_disable(rdev);\n\treturn 0;\n}\n\nvoid r420_fini(struct radeon_device *rdev)\n{\n\tradeon_pm_fini(rdev);\n\tr100_cp_fini(rdev);\n\tradeon_wb_fini(rdev);\n\tradeon_ib_pool_fini(rdev);\n\tradeon_gem_fini(rdev);\n\tif (rdev->flags & RADEON_IS_PCIE)\n\t\trv370_pcie_gart_fini(rdev);\n\tif (rdev->flags & RADEON_IS_PCI)\n\t\tr100_pci_gart_fini(rdev);\n\tradeon_agp_fini(rdev);\n\tradeon_irq_kms_fini(rdev);\n\tradeon_fence_driver_fini(rdev);\n\tradeon_bo_fini(rdev);\n\tif (rdev->is_atom_bios) {\n\t\tradeon_atombios_fini(rdev);\n\t} else {\n\t\tradeon_combios_fini(rdev);\n\t}\n\tkfree(rdev->bios);\n\trdev->bios = NULL;\n}\n\nint r420_init(struct radeon_device *rdev)\n{\n\tint r;\n\n\t \n\tradeon_scratch_init(rdev);\n\t \n\tradeon_surface_init(rdev);\n\t \n\t \n\tr100_restore_sanity(rdev);\n\t \n\tif (!radeon_get_bios(rdev)) {\n\t\tif (ASIC_IS_AVIVO(rdev))\n\t\t\treturn -EINVAL;\n\t}\n\tif (rdev->is_atom_bios) {\n\t\tr = radeon_atombios_init(rdev);\n\t\tif (r) {\n\t\t\treturn r;\n\t\t}\n\t} else {\n\t\tr = radeon_combios_init(rdev);\n\t\tif (r) {\n\t\t\treturn r;\n\t\t}\n\t}\n\t \n\tif (radeon_asic_reset(rdev)) {\n\t\tdev_warn(rdev->dev,\n\t\t\t\"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\\n\",\n\t\t\tRREG32(R_000E40_RBBM_STATUS),\n\t\t\tRREG32(R_0007C0_CP_STAT));\n\t}\n\t \n\tif (radeon_boot_test_post_card(rdev) == false)\n\t\treturn -EINVAL;\n\n\t \n\tradeon_get_clock_info(rdev->ddev);\n\t \n\tif (rdev->flags & RADEON_IS_AGP) {\n\t\tr = radeon_agp_init(rdev);\n\t\tif (r) {\n\t\t\tradeon_agp_disable(rdev);\n\t\t}\n\t}\n\t \n\tr300_mc_init(rdev);\n\tr420_debugfs(rdev);\n\t \n\tradeon_fence_driver_init(rdev);\n\t \n\tr = radeon_bo_init(rdev);\n\tif (r) {\n\t\treturn r;\n\t}\n\tif (rdev->family == CHIP_R420)\n\t\tr100_enable_bm(rdev);\n\n\tif (rdev->flags & RADEON_IS_PCIE) {\n\t\tr = rv370_pcie_gart_init(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\tif (rdev->flags & RADEON_IS_PCI) {\n\t\tr = r100_pci_gart_init(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\tr420_set_reg_safe(rdev);\n\n\t \n\tradeon_pm_init(rdev);\n\n\trdev->accel_working = true;\n\tr = r420_startup(rdev);\n\tif (r) {\n\t\t \n\t\tdev_err(rdev->dev, \"Disabling GPU acceleration\\n\");\n\t\tr100_cp_fini(rdev);\n\t\tradeon_wb_fini(rdev);\n\t\tradeon_ib_pool_fini(rdev);\n\t\tradeon_irq_kms_fini(rdev);\n\t\tif (rdev->flags & RADEON_IS_PCIE)\n\t\t\trv370_pcie_gart_fini(rdev);\n\t\tif (rdev->flags & RADEON_IS_PCI)\n\t\t\tr100_pci_gart_fini(rdev);\n\t\tradeon_agp_fini(rdev);\n\t\trdev->accel_working = false;\n\t}\n\treturn 0;\n}\n\n \n#if defined(CONFIG_DEBUG_FS)\nstatic int r420_debugfs_pipes_info_show(struct seq_file *m, void *unused)\n{\n\tstruct radeon_device *rdev = m->private;\n\tuint32_t tmp;\n\n\ttmp = RREG32(R400_GB_PIPE_SELECT);\n\tseq_printf(m, \"GB_PIPE_SELECT 0x%08x\\n\", tmp);\n\ttmp = RREG32(R300_GB_TILE_CONFIG);\n\tseq_printf(m, \"GB_TILE_CONFIG 0x%08x\\n\", tmp);\n\ttmp = RREG32(R300_DST_PIPE_CONFIG);\n\tseq_printf(m, \"DST_PIPE_CONFIG 0x%08x\\n\", tmp);\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(r420_debugfs_pipes_info);\n#endif\n\nvoid r420_debugfs_pipes_info_init(struct radeon_device *rdev)\n{\n#if defined(CONFIG_DEBUG_FS)\n\tstruct dentry *root = rdev->ddev->primary->debugfs_root;\n\n\tdebugfs_create_file(\"r420_pipes_info\", 0444, root, rdev,\n\t\t\t    &r420_debugfs_pipes_info_fops);\n#endif\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}