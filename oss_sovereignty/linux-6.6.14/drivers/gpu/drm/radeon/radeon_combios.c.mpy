{
  "module_name": "radeon_combios.c",
  "hash_id": "6640aec2bcd89600b234dd2055f9c2706f9be9d3409357f81406f4a74cb6511c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/radeon_combios.c",
  "human_readable_source": " \n\n#include <linux/pci.h>\n\n#include <drm/drm_device.h>\n#include <drm/radeon_drm.h>\n\n#include \"radeon.h\"\n#include \"radeon_legacy_encoders.h\"\n#include \"atom.h\"\n\n#ifdef CONFIG_PPC_PMAC\n \n#include <asm/machdep.h>\n#include <asm/pmac_feature.h>\n#include <asm/prom.h>\n#endif  \n\n \n\n \nenum radeon_combios_table_offset {\n\t \n\tCOMBIOS_ASIC_INIT_1_TABLE,\n\tCOMBIOS_BIOS_SUPPORT_TABLE,\n\tCOMBIOS_DAC_PROGRAMMING_TABLE,\n\tCOMBIOS_MAX_COLOR_DEPTH_TABLE,\n\tCOMBIOS_CRTC_INFO_TABLE,\n\tCOMBIOS_PLL_INFO_TABLE,\n\tCOMBIOS_TV_INFO_TABLE,\n\tCOMBIOS_DFP_INFO_TABLE,\n\tCOMBIOS_HW_CONFIG_INFO_TABLE,\n\tCOMBIOS_MULTIMEDIA_INFO_TABLE,\n\tCOMBIOS_TV_STD_PATCH_TABLE,\n\tCOMBIOS_LCD_INFO_TABLE,\n\tCOMBIOS_MOBILE_INFO_TABLE,\n\tCOMBIOS_PLL_INIT_TABLE,\n\tCOMBIOS_MEM_CONFIG_TABLE,\n\tCOMBIOS_SAVE_MASK_TABLE,\n\tCOMBIOS_HARDCODED_EDID_TABLE,\n\tCOMBIOS_ASIC_INIT_2_TABLE,\n\tCOMBIOS_CONNECTOR_INFO_TABLE,\n\tCOMBIOS_DYN_CLK_1_TABLE,\n\tCOMBIOS_RESERVED_MEM_TABLE,\n\tCOMBIOS_EXT_TMDS_INFO_TABLE,\n\tCOMBIOS_MEM_CLK_INFO_TABLE,\n\tCOMBIOS_EXT_DAC_INFO_TABLE,\n\tCOMBIOS_MISC_INFO_TABLE,\n\tCOMBIOS_CRT_INFO_TABLE,\n\tCOMBIOS_INTEGRATED_SYSTEM_INFO_TABLE,\n\tCOMBIOS_COMPONENT_VIDEO_INFO_TABLE,\n\tCOMBIOS_FAN_SPEED_INFO_TABLE,\n\tCOMBIOS_OVERDRIVE_INFO_TABLE,\n\tCOMBIOS_OEM_INFO_TABLE,\n\tCOMBIOS_DYN_CLK_2_TABLE,\n\tCOMBIOS_POWER_CONNECTOR_INFO_TABLE,\n\tCOMBIOS_I2C_INFO_TABLE,\n\t \n\tCOMBIOS_ASIC_INIT_3_TABLE,\t \n\tCOMBIOS_ASIC_INIT_4_TABLE,\t \n\tCOMBIOS_DETECTED_MEM_TABLE,\t \n\tCOMBIOS_ASIC_INIT_5_TABLE,\t \n\tCOMBIOS_RAM_RESET_TABLE,\t \n\tCOMBIOS_POWERPLAY_INFO_TABLE,\t \n\tCOMBIOS_GPIO_INFO_TABLE,\t \n\tCOMBIOS_LCD_DDC_INFO_TABLE,\t \n\tCOMBIOS_TMDS_POWER_TABLE,\t \n\tCOMBIOS_TMDS_POWER_ON_TABLE,\t \n\tCOMBIOS_TMDS_POWER_OFF_TABLE,\t \n};\n\nenum radeon_combios_ddc {\n\tDDC_NONE_DETECTED,\n\tDDC_MONID,\n\tDDC_DVI,\n\tDDC_VGA,\n\tDDC_CRT2,\n\tDDC_LCD,\n\tDDC_GPIO,\n};\n\nenum radeon_combios_connector {\n\tCONNECTOR_NONE_LEGACY,\n\tCONNECTOR_PROPRIETARY_LEGACY,\n\tCONNECTOR_CRT_LEGACY,\n\tCONNECTOR_DVI_I_LEGACY,\n\tCONNECTOR_DVI_D_LEGACY,\n\tCONNECTOR_CTV_LEGACY,\n\tCONNECTOR_STV_LEGACY,\n\tCONNECTOR_UNSUPPORTED_LEGACY\n};\n\nstatic const int legacy_connector_convert[] = {\n\tDRM_MODE_CONNECTOR_Unknown,\n\tDRM_MODE_CONNECTOR_DVID,\n\tDRM_MODE_CONNECTOR_VGA,\n\tDRM_MODE_CONNECTOR_DVII,\n\tDRM_MODE_CONNECTOR_DVID,\n\tDRM_MODE_CONNECTOR_Composite,\n\tDRM_MODE_CONNECTOR_SVIDEO,\n\tDRM_MODE_CONNECTOR_Unknown,\n};\n\nstatic uint16_t combios_get_table_offset(struct drm_device *dev,\n\t\t\t\t\t enum radeon_combios_table_offset table)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tint rev, size;\n\tuint16_t offset = 0, check_offset;\n\n\tif (!rdev->bios)\n\t\treturn 0;\n\n\tswitch (table) {\n\t\t \n\tcase COMBIOS_ASIC_INIT_1_TABLE:\n\t\tcheck_offset = 0xc;\n\t\tbreak;\n\tcase COMBIOS_BIOS_SUPPORT_TABLE:\n\t\tcheck_offset = 0x14;\n\t\tbreak;\n\tcase COMBIOS_DAC_PROGRAMMING_TABLE:\n\t\tcheck_offset = 0x2a;\n\t\tbreak;\n\tcase COMBIOS_MAX_COLOR_DEPTH_TABLE:\n\t\tcheck_offset = 0x2c;\n\t\tbreak;\n\tcase COMBIOS_CRTC_INFO_TABLE:\n\t\tcheck_offset = 0x2e;\n\t\tbreak;\n\tcase COMBIOS_PLL_INFO_TABLE:\n\t\tcheck_offset = 0x30;\n\t\tbreak;\n\tcase COMBIOS_TV_INFO_TABLE:\n\t\tcheck_offset = 0x32;\n\t\tbreak;\n\tcase COMBIOS_DFP_INFO_TABLE:\n\t\tcheck_offset = 0x34;\n\t\tbreak;\n\tcase COMBIOS_HW_CONFIG_INFO_TABLE:\n\t\tcheck_offset = 0x36;\n\t\tbreak;\n\tcase COMBIOS_MULTIMEDIA_INFO_TABLE:\n\t\tcheck_offset = 0x38;\n\t\tbreak;\n\tcase COMBIOS_TV_STD_PATCH_TABLE:\n\t\tcheck_offset = 0x3e;\n\t\tbreak;\n\tcase COMBIOS_LCD_INFO_TABLE:\n\t\tcheck_offset = 0x40;\n\t\tbreak;\n\tcase COMBIOS_MOBILE_INFO_TABLE:\n\t\tcheck_offset = 0x42;\n\t\tbreak;\n\tcase COMBIOS_PLL_INIT_TABLE:\n\t\tcheck_offset = 0x46;\n\t\tbreak;\n\tcase COMBIOS_MEM_CONFIG_TABLE:\n\t\tcheck_offset = 0x48;\n\t\tbreak;\n\tcase COMBIOS_SAVE_MASK_TABLE:\n\t\tcheck_offset = 0x4a;\n\t\tbreak;\n\tcase COMBIOS_HARDCODED_EDID_TABLE:\n\t\tcheck_offset = 0x4c;\n\t\tbreak;\n\tcase COMBIOS_ASIC_INIT_2_TABLE:\n\t\tcheck_offset = 0x4e;\n\t\tbreak;\n\tcase COMBIOS_CONNECTOR_INFO_TABLE:\n\t\tcheck_offset = 0x50;\n\t\tbreak;\n\tcase COMBIOS_DYN_CLK_1_TABLE:\n\t\tcheck_offset = 0x52;\n\t\tbreak;\n\tcase COMBIOS_RESERVED_MEM_TABLE:\n\t\tcheck_offset = 0x54;\n\t\tbreak;\n\tcase COMBIOS_EXT_TMDS_INFO_TABLE:\n\t\tcheck_offset = 0x58;\n\t\tbreak;\n\tcase COMBIOS_MEM_CLK_INFO_TABLE:\n\t\tcheck_offset = 0x5a;\n\t\tbreak;\n\tcase COMBIOS_EXT_DAC_INFO_TABLE:\n\t\tcheck_offset = 0x5c;\n\t\tbreak;\n\tcase COMBIOS_MISC_INFO_TABLE:\n\t\tcheck_offset = 0x5e;\n\t\tbreak;\n\tcase COMBIOS_CRT_INFO_TABLE:\n\t\tcheck_offset = 0x60;\n\t\tbreak;\n\tcase COMBIOS_INTEGRATED_SYSTEM_INFO_TABLE:\n\t\tcheck_offset = 0x62;\n\t\tbreak;\n\tcase COMBIOS_COMPONENT_VIDEO_INFO_TABLE:\n\t\tcheck_offset = 0x64;\n\t\tbreak;\n\tcase COMBIOS_FAN_SPEED_INFO_TABLE:\n\t\tcheck_offset = 0x66;\n\t\tbreak;\n\tcase COMBIOS_OVERDRIVE_INFO_TABLE:\n\t\tcheck_offset = 0x68;\n\t\tbreak;\n\tcase COMBIOS_OEM_INFO_TABLE:\n\t\tcheck_offset = 0x6a;\n\t\tbreak;\n\tcase COMBIOS_DYN_CLK_2_TABLE:\n\t\tcheck_offset = 0x6c;\n\t\tbreak;\n\tcase COMBIOS_POWER_CONNECTOR_INFO_TABLE:\n\t\tcheck_offset = 0x6e;\n\t\tbreak;\n\tcase COMBIOS_I2C_INFO_TABLE:\n\t\tcheck_offset = 0x70;\n\t\tbreak;\n\t\t \n\tcase COMBIOS_ASIC_INIT_3_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MISC_INFO_TABLE);\n\t\tif (check_offset) {\n\t\t\trev = RBIOS8(check_offset);\n\t\t\tif (rev > 0) {\n\t\t\t\tcheck_offset = RBIOS16(check_offset + 0x3);\n\t\t\t\tif (check_offset)\n\t\t\t\t\toffset = check_offset;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_ASIC_INIT_4_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MISC_INFO_TABLE);\n\t\tif (check_offset) {\n\t\t\trev = RBIOS8(check_offset);\n\t\t\tif (rev > 0) {\n\t\t\t\tcheck_offset = RBIOS16(check_offset + 0x5);\n\t\t\t\tif (check_offset)\n\t\t\t\t\toffset = check_offset;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_DETECTED_MEM_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MISC_INFO_TABLE);\n\t\tif (check_offset) {\n\t\t\trev = RBIOS8(check_offset);\n\t\t\tif (rev > 0) {\n\t\t\t\tcheck_offset = RBIOS16(check_offset + 0x7);\n\t\t\t\tif (check_offset)\n\t\t\t\t\toffset = check_offset;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_ASIC_INIT_5_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MISC_INFO_TABLE);\n\t\tif (check_offset) {\n\t\t\trev = RBIOS8(check_offset);\n\t\t\tif (rev == 2) {\n\t\t\t\tcheck_offset = RBIOS16(check_offset + 0x9);\n\t\t\t\tif (check_offset)\n\t\t\t\t\toffset = check_offset;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_RAM_RESET_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MEM_CONFIG_TABLE);\n\t\tif (check_offset) {\n\t\t\twhile (RBIOS8(check_offset++));\n\t\t\tcheck_offset += 2;\n\t\t\tif (check_offset)\n\t\t\t\toffset = check_offset;\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_POWERPLAY_INFO_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MOBILE_INFO_TABLE);\n\t\tif (check_offset) {\n\t\t\tcheck_offset = RBIOS16(check_offset + 0x11);\n\t\t\tif (check_offset)\n\t\t\t\toffset = check_offset;\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_GPIO_INFO_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MOBILE_INFO_TABLE);\n\t\tif (check_offset) {\n\t\t\tcheck_offset = RBIOS16(check_offset + 0x13);\n\t\t\tif (check_offset)\n\t\t\t\toffset = check_offset;\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_LCD_DDC_INFO_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MOBILE_INFO_TABLE);\n\t\tif (check_offset) {\n\t\t\tcheck_offset = RBIOS16(check_offset + 0x15);\n\t\t\tif (check_offset)\n\t\t\t\toffset = check_offset;\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_TMDS_POWER_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MOBILE_INFO_TABLE);\n\t\tif (check_offset) {\n\t\t\tcheck_offset = RBIOS16(check_offset + 0x17);\n\t\t\tif (check_offset)\n\t\t\t\toffset = check_offset;\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_TMDS_POWER_ON_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_TMDS_POWER_TABLE);\n\t\tif (check_offset) {\n\t\t\tcheck_offset = RBIOS16(check_offset + 0x2);\n\t\t\tif (check_offset)\n\t\t\t\toffset = check_offset;\n\t\t}\n\t\tbreak;\n\tcase COMBIOS_TMDS_POWER_OFF_TABLE:\t \n\t\tcheck_offset =\n\t\t    combios_get_table_offset(dev, COMBIOS_TMDS_POWER_TABLE);\n\t\tif (check_offset) {\n\t\t\tcheck_offset = RBIOS16(check_offset + 0x4);\n\t\t\tif (check_offset)\n\t\t\t\toffset = check_offset;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tcheck_offset = 0;\n\t\tbreak;\n\t}\n\n\tsize = RBIOS8(rdev->bios_header_start + 0x6);\n\t \n\tif (table < COMBIOS_ASIC_INIT_3_TABLE && check_offset && check_offset < size)\n\t\toffset = RBIOS16(rdev->bios_header_start + check_offset);\n\n\treturn offset;\n}\n\nbool radeon_combios_check_hardcoded_edid(struct radeon_device *rdev)\n{\n\tint edid_info, size;\n\tstruct edid *edid;\n\tunsigned char *raw;\n\tedid_info = combios_get_table_offset(rdev->ddev, COMBIOS_HARDCODED_EDID_TABLE);\n\tif (!edid_info)\n\t\treturn false;\n\n\traw = rdev->bios + edid_info;\n\tsize = EDID_LENGTH * (raw[0x7e] + 1);\n\tedid = kmalloc(size, GFP_KERNEL);\n\tif (edid == NULL)\n\t\treturn false;\n\n\tmemcpy((unsigned char *)edid, raw, size);\n\n\tif (!drm_edid_is_valid(edid)) {\n\t\tkfree(edid);\n\t\treturn false;\n\t}\n\n\trdev->mode_info.bios_hardcoded_edid = edid;\n\trdev->mode_info.bios_hardcoded_edid_size = size;\n\treturn true;\n}\n\n \nstruct edid *\nradeon_bios_get_hardcoded_edid(struct radeon_device *rdev)\n{\n\tstruct edid *edid;\n\n\tif (rdev->mode_info.bios_hardcoded_edid) {\n\t\tedid = kmalloc(rdev->mode_info.bios_hardcoded_edid_size, GFP_KERNEL);\n\t\tif (edid) {\n\t\t\tmemcpy((unsigned char *)edid,\n\t\t\t       (unsigned char *)rdev->mode_info.bios_hardcoded_edid,\n\t\t\t       rdev->mode_info.bios_hardcoded_edid_size);\n\t\t\treturn edid;\n\t\t}\n\t}\n\treturn NULL;\n}\n\nstatic struct radeon_i2c_bus_rec combios_setup_i2c_bus(struct radeon_device *rdev,\n\t\t\t\t\t\t       enum radeon_combios_ddc ddc,\n\t\t\t\t\t\t       u32 clk_mask,\n\t\t\t\t\t\t       u32 data_mask)\n{\n\tstruct radeon_i2c_bus_rec i2c;\n\tint ddc_line = 0;\n\n\t \n\tswitch (ddc) {\n\tcase DDC_NONE_DETECTED:\n\tdefault:\n\t\tddc_line = 0;\n\t\tbreak;\n\tcase DDC_DVI:\n\t\tddc_line = RADEON_GPIO_DVI_DDC;\n\t\tbreak;\n\tcase DDC_VGA:\n\t\tddc_line = RADEON_GPIO_VGA_DDC;\n\t\tbreak;\n\tcase DDC_LCD:\n\t\tddc_line = RADEON_GPIOPAD_MASK;\n\t\tbreak;\n\tcase DDC_GPIO:\n\t\tddc_line = RADEON_MDGPIO_MASK;\n\t\tbreak;\n\tcase DDC_MONID:\n\t\tif (rdev->family == CHIP_RS300 ||\n\t\t    rdev->family == CHIP_RS400 ||\n\t\t    rdev->family == CHIP_RS480)\n\t\t\tddc_line = RADEON_GPIOPAD_MASK;\n\t\telse if (rdev->family == CHIP_R300 ||\n\t\t\t rdev->family == CHIP_R350) {\n\t\t\tddc_line = RADEON_GPIO_DVI_DDC;\n\t\t\tddc = DDC_DVI;\n\t\t} else\n\t\t\tddc_line = RADEON_GPIO_MONID;\n\t\tbreak;\n\tcase DDC_CRT2:\n\t\tif (rdev->family == CHIP_R200 ||\n\t\t    rdev->family == CHIP_R300 ||\n\t\t    rdev->family == CHIP_R350) {\n\t\t\tddc_line = RADEON_GPIO_DVI_DDC;\n\t\t\tddc = DDC_DVI;\n\t\t} else if (rdev->family == CHIP_RS300 ||\n\t\t\t   rdev->family == CHIP_RS400 ||\n\t\t\t   rdev->family == CHIP_RS480)\n\t\t\tddc_line = RADEON_GPIO_MONID;\n\t\telse if (rdev->family >= CHIP_RV350) {\n\t\t\tddc_line = RADEON_GPIO_MONID;\n\t\t\tddc = DDC_MONID;\n\t\t} else\n\t\t\tddc_line = RADEON_GPIO_CRT2_DDC;\n\t\tbreak;\n\t}\n\n\tif (ddc_line == RADEON_GPIOPAD_MASK) {\n\t\ti2c.mask_clk_reg = RADEON_GPIOPAD_MASK;\n\t\ti2c.mask_data_reg = RADEON_GPIOPAD_MASK;\n\t\ti2c.a_clk_reg = RADEON_GPIOPAD_A;\n\t\ti2c.a_data_reg = RADEON_GPIOPAD_A;\n\t\ti2c.en_clk_reg = RADEON_GPIOPAD_EN;\n\t\ti2c.en_data_reg = RADEON_GPIOPAD_EN;\n\t\ti2c.y_clk_reg = RADEON_GPIOPAD_Y;\n\t\ti2c.y_data_reg = RADEON_GPIOPAD_Y;\n\t} else if (ddc_line == RADEON_MDGPIO_MASK) {\n\t\ti2c.mask_clk_reg = RADEON_MDGPIO_MASK;\n\t\ti2c.mask_data_reg = RADEON_MDGPIO_MASK;\n\t\ti2c.a_clk_reg = RADEON_MDGPIO_A;\n\t\ti2c.a_data_reg = RADEON_MDGPIO_A;\n\t\ti2c.en_clk_reg = RADEON_MDGPIO_EN;\n\t\ti2c.en_data_reg = RADEON_MDGPIO_EN;\n\t\ti2c.y_clk_reg = RADEON_MDGPIO_Y;\n\t\ti2c.y_data_reg = RADEON_MDGPIO_Y;\n\t} else {\n\t\ti2c.mask_clk_reg = ddc_line;\n\t\ti2c.mask_data_reg = ddc_line;\n\t\ti2c.a_clk_reg = ddc_line;\n\t\ti2c.a_data_reg = ddc_line;\n\t\ti2c.en_clk_reg = ddc_line;\n\t\ti2c.en_data_reg = ddc_line;\n\t\ti2c.y_clk_reg = ddc_line;\n\t\ti2c.y_data_reg = ddc_line;\n\t}\n\n\tif (clk_mask && data_mask) {\n\t\t \n\t\ti2c.mask_clk_mask = clk_mask;\n\t\ti2c.mask_data_mask = data_mask;\n\t\ti2c.a_clk_mask = clk_mask;\n\t\ti2c.a_data_mask = data_mask;\n\t\ti2c.en_clk_mask = clk_mask;\n\t\ti2c.en_data_mask = data_mask;\n\t\ti2c.y_clk_mask = clk_mask;\n\t\ti2c.y_data_mask = data_mask;\n\t} else if ((ddc_line == RADEON_GPIOPAD_MASK) ||\n\t\t   (ddc_line == RADEON_MDGPIO_MASK)) {\n\t\t \n\t\ti2c.mask_clk_mask = (0x20 << 8);\n\t\ti2c.mask_data_mask = 0x80;\n\t\ti2c.a_clk_mask = (0x20 << 8);\n\t\ti2c.a_data_mask = 0x80;\n\t\ti2c.en_clk_mask = (0x20 << 8);\n\t\ti2c.en_data_mask = 0x80;\n\t\ti2c.y_clk_mask = (0x20 << 8);\n\t\ti2c.y_data_mask = 0x80;\n\t} else {\n\t\t \n\t\ti2c.mask_clk_mask = RADEON_GPIO_MASK_1;\n\t\ti2c.mask_data_mask = RADEON_GPIO_MASK_0;\n\t\ti2c.a_clk_mask = RADEON_GPIO_A_1;\n\t\ti2c.a_data_mask = RADEON_GPIO_A_0;\n\t\ti2c.en_clk_mask = RADEON_GPIO_EN_1;\n\t\ti2c.en_data_mask = RADEON_GPIO_EN_0;\n\t\ti2c.y_clk_mask = RADEON_GPIO_Y_1;\n\t\ti2c.y_data_mask = RADEON_GPIO_Y_0;\n\t}\n\n\tswitch (rdev->family) {\n\tcase CHIP_R100:\n\tcase CHIP_RV100:\n\tcase CHIP_RS100:\n\tcase CHIP_RV200:\n\tcase CHIP_RS200:\n\tcase CHIP_RS300:\n\t\tswitch (ddc_line) {\n\t\tcase RADEON_GPIO_DVI_DDC:\n\t\t\ti2c.hw_capable = true;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\ti2c.hw_capable = false;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase CHIP_R200:\n\t\tswitch (ddc_line) {\n\t\tcase RADEON_GPIO_DVI_DDC:\n\t\tcase RADEON_GPIO_MONID:\n\t\t\ti2c.hw_capable = true;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\ti2c.hw_capable = false;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase CHIP_RV250:\n\tcase CHIP_RV280:\n\t\tswitch (ddc_line) {\n\t\tcase RADEON_GPIO_VGA_DDC:\n\t\tcase RADEON_GPIO_DVI_DDC:\n\t\tcase RADEON_GPIO_CRT2_DDC:\n\t\t\ti2c.hw_capable = true;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\ti2c.hw_capable = false;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase CHIP_R300:\n\tcase CHIP_R350:\n\t\tswitch (ddc_line) {\n\t\tcase RADEON_GPIO_VGA_DDC:\n\t\tcase RADEON_GPIO_DVI_DDC:\n\t\t\ti2c.hw_capable = true;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\ti2c.hw_capable = false;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase CHIP_RV350:\n\tcase CHIP_RV380:\n\tcase CHIP_RS400:\n\tcase CHIP_RS480:\n\t\tswitch (ddc_line) {\n\t\tcase RADEON_GPIO_VGA_DDC:\n\t\tcase RADEON_GPIO_DVI_DDC:\n\t\t\ti2c.hw_capable = true;\n\t\t\tbreak;\n\t\tcase RADEON_GPIO_MONID:\n\t\t\t \n\t\t\ti2c.hw_capable = false;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\ti2c.hw_capable = false;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\ti2c.hw_capable = false;\n\t\tbreak;\n\t}\n\ti2c.mm_i2c = false;\n\n\ti2c.i2c_id = ddc;\n\ti2c.hpd = RADEON_HPD_NONE;\n\n\tif (ddc_line)\n\t\ti2c.valid = true;\n\telse\n\t\ti2c.valid = false;\n\n\treturn i2c;\n}\n\nstatic struct radeon_i2c_bus_rec radeon_combios_get_i2c_info_from_table(struct radeon_device *rdev)\n{\n\tstruct drm_device *dev = rdev->ddev;\n\tstruct radeon_i2c_bus_rec i2c;\n\tu16 offset;\n\tu8 id, blocks, clk, data;\n\tint i;\n\n\ti2c.valid = false;\n\n\toffset = combios_get_table_offset(dev, COMBIOS_I2C_INFO_TABLE);\n\tif (offset) {\n\t\tblocks = RBIOS8(offset + 2);\n\t\tfor (i = 0; i < blocks; i++) {\n\t\t\tid = RBIOS8(offset + 3 + (i * 5) + 0);\n\t\t\tif (id == 136) {\n\t\t\t\tclk = RBIOS8(offset + 3 + (i * 5) + 3);\n\t\t\t\tdata = RBIOS8(offset + 3 + (i * 5) + 4);\n\t\t\t\t \n\t\t\t\ti2c = combios_setup_i2c_bus(rdev, DDC_MONID,\n\t\t\t\t\t\t\t    (1 << clk), (1 << data));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn i2c;\n}\n\nvoid radeon_combios_i2c_init(struct radeon_device *rdev)\n{\n\tstruct drm_device *dev = rdev->ddev;\n\tstruct radeon_i2c_bus_rec i2c;\n\n\t \n\n\t \n\ti2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\trdev->i2c_bus[0] = radeon_i2c_create(dev, &i2c, \"DVI_DDC\");\n\t \n\ti2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\trdev->i2c_bus[1] = radeon_i2c_create(dev, &i2c, \"VGA_DDC\");\n\n\t \n\ti2c.valid = true;\n\ti2c.hw_capable = true;\n\ti2c.mm_i2c = true;\n\ti2c.i2c_id = 0xa0;\n\trdev->i2c_bus[2] = radeon_i2c_create(dev, &i2c, \"MM_I2C\");\n\n\tif (rdev->family == CHIP_R300 ||\n\t    rdev->family == CHIP_R350) {\n\t\t \n\t} else if (rdev->family == CHIP_RS300 ||\n\t\t   rdev->family == CHIP_RS400 ||\n\t\t   rdev->family == CHIP_RS480) {\n\t\t \n\t\ti2c = combios_setup_i2c_bus(rdev, DDC_CRT2, 0, 0);\n\t\trdev->i2c_bus[3] = radeon_i2c_create(dev, &i2c, \"MONID\");\n\n\t\t \n\t\ti2c = radeon_combios_get_i2c_info_from_table(rdev);\n\t\tif (i2c.valid)\n\t\t\trdev->i2c_bus[4] = radeon_i2c_create(dev, &i2c, \"GPIOPAD_MASK\");\n\t} else if ((rdev->family == CHIP_R200) ||\n\t\t   (rdev->family >= CHIP_R300)) {\n\t\t \n\t\ti2c = combios_setup_i2c_bus(rdev, DDC_MONID, 0, 0);\n\t\trdev->i2c_bus[3] = radeon_i2c_create(dev, &i2c, \"MONID\");\n\t} else {\n\t\t \n\t\ti2c = combios_setup_i2c_bus(rdev, DDC_MONID, 0, 0);\n\t\trdev->i2c_bus[3] = radeon_i2c_create(dev, &i2c, \"MONID\");\n\t\t \n\t\ti2c = combios_setup_i2c_bus(rdev, DDC_CRT2, 0, 0);\n\t\trdev->i2c_bus[4] = radeon_i2c_create(dev, &i2c, \"CRT2_DDC\");\n\t}\n}\n\nbool radeon_combios_get_clock_info(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint16_t pll_info;\n\tstruct radeon_pll *p1pll = &rdev->clock.p1pll;\n\tstruct radeon_pll *p2pll = &rdev->clock.p2pll;\n\tstruct radeon_pll *spll = &rdev->clock.spll;\n\tstruct radeon_pll *mpll = &rdev->clock.mpll;\n\tint8_t rev;\n\tuint16_t sclk, mclk;\n\n\tpll_info = combios_get_table_offset(dev, COMBIOS_PLL_INFO_TABLE);\n\tif (pll_info) {\n\t\trev = RBIOS8(pll_info);\n\n\t\t \n\t\tp1pll->reference_freq = RBIOS16(pll_info + 0xe);\n\t\tp1pll->reference_div = RBIOS16(pll_info + 0x10);\n\t\tp1pll->pll_out_min = RBIOS32(pll_info + 0x12);\n\t\tp1pll->pll_out_max = RBIOS32(pll_info + 0x16);\n\t\tp1pll->lcd_pll_out_min = p1pll->pll_out_min;\n\t\tp1pll->lcd_pll_out_max = p1pll->pll_out_max;\n\n\t\tif (rev > 9) {\n\t\t\tp1pll->pll_in_min = RBIOS32(pll_info + 0x36);\n\t\t\tp1pll->pll_in_max = RBIOS32(pll_info + 0x3a);\n\t\t} else {\n\t\t\tp1pll->pll_in_min = 40;\n\t\t\tp1pll->pll_in_max = 500;\n\t\t}\n\t\t*p2pll = *p1pll;\n\n\t\t \n\t\tspll->reference_freq = RBIOS16(pll_info + 0x1a);\n\t\tspll->reference_div = RBIOS16(pll_info + 0x1c);\n\t\tspll->pll_out_min = RBIOS32(pll_info + 0x1e);\n\t\tspll->pll_out_max = RBIOS32(pll_info + 0x22);\n\n\t\tif (rev > 10) {\n\t\t\tspll->pll_in_min = RBIOS32(pll_info + 0x48);\n\t\t\tspll->pll_in_max = RBIOS32(pll_info + 0x4c);\n\t\t} else {\n\t\t\t \n\t\t\tspll->pll_in_min = 40;\n\t\t\tspll->pll_in_max = 500;\n\t\t}\n\n\t\t \n\t\tmpll->reference_freq = RBIOS16(pll_info + 0x26);\n\t\tmpll->reference_div = RBIOS16(pll_info + 0x28);\n\t\tmpll->pll_out_min = RBIOS32(pll_info + 0x2a);\n\t\tmpll->pll_out_max = RBIOS32(pll_info + 0x2e);\n\n\t\tif (rev > 10) {\n\t\t\tmpll->pll_in_min = RBIOS32(pll_info + 0x5a);\n\t\t\tmpll->pll_in_max = RBIOS32(pll_info + 0x5e);\n\t\t} else {\n\t\t\t \n\t\t\tmpll->pll_in_min = 40;\n\t\t\tmpll->pll_in_max = 500;\n\t\t}\n\n\t\t \n\t\tsclk = RBIOS16(pll_info + 0xa);\n\t\tmclk = RBIOS16(pll_info + 0x8);\n\t\tif (sclk == 0)\n\t\t\tsclk = 200 * 100;\n\t\tif (mclk == 0)\n\t\t\tmclk = 200 * 100;\n\n\t\trdev->clock.default_sclk = sclk;\n\t\trdev->clock.default_mclk = mclk;\n\n\t\tif (RBIOS32(pll_info + 0x16))\n\t\t\trdev->clock.max_pixel_clock = RBIOS32(pll_info + 0x16);\n\t\telse\n\t\t\trdev->clock.max_pixel_clock = 35000;  \n\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nbool radeon_combios_sideport_present(struct radeon_device *rdev)\n{\n\tstruct drm_device *dev = rdev->ddev;\n\tu16 igp_info;\n\n\t \n\tif (rdev->family == CHIP_RS400)\n\t\treturn false;\n\n\tigp_info = combios_get_table_offset(dev, COMBIOS_INTEGRATED_SYSTEM_INFO_TABLE);\n\n\tif (igp_info) {\n\t\tif (RBIOS16(igp_info + 0x4))\n\t\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic const uint32_t default_primarydac_adj[CHIP_LAST] = {\n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000000,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000808,\t\t \n\t0x00000000,\t\t \n\t0x00000000,\t\t \n};\n\nstatic void radeon_legacy_get_primary_dac_info_from_table(struct radeon_device *rdev,\n\t\t\t\t\t\t\t  struct radeon_encoder_primary_dac *p_dac)\n{\n\tp_dac->ps2_pdac_adj = default_primarydac_adj[rdev->family];\n\treturn;\n}\n\nstruct radeon_encoder_primary_dac *radeon_combios_get_primary_dac_info(struct\n\t\t\t\t\t\t\t\t       radeon_encoder\n\t\t\t\t\t\t\t\t       *encoder)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint16_t dac_info;\n\tuint8_t rev, bg, dac;\n\tstruct radeon_encoder_primary_dac *p_dac;\n\tint found = 0;\n\n\tp_dac = kzalloc(sizeof(struct radeon_encoder_primary_dac),\n\t\t\tGFP_KERNEL);\n\n\tif (!p_dac)\n\t\treturn NULL;\n\n\t \n\tdac_info = combios_get_table_offset(dev, COMBIOS_CRT_INFO_TABLE);\n\tif (dac_info) {\n\t\trev = RBIOS8(dac_info) & 0x3;\n\t\tif (rev < 2) {\n\t\t\tbg = RBIOS8(dac_info + 0x2) & 0xf;\n\t\t\tdac = (RBIOS8(dac_info + 0x2) >> 4) & 0xf;\n\t\t\tp_dac->ps2_pdac_adj = (bg << 8) | (dac);\n\t\t} else {\n\t\t\tbg = RBIOS8(dac_info + 0x2) & 0xf;\n\t\t\tdac = RBIOS8(dac_info + 0x3) & 0xf;\n\t\t\tp_dac->ps2_pdac_adj = (bg << 8) | (dac);\n\t\t}\n\t\t \n\t\tif ((dac == 0) || (bg == 0))\n\t\t\tfound = 0;\n\t\telse\n\t\t\tfound = 1;\n\t}\n\n\t \n\t \n\tif (((rdev->pdev->device == 0x5159) &&\n\t    (rdev->pdev->subsystem_vendor == 0x174B) &&\n\t    (rdev->pdev->subsystem_device == 0x7c28)) ||\n\t \n\t   ((rdev->pdev->device == 0x514D) &&\n\t    (rdev->pdev->subsystem_vendor == 0x174B) &&\n\t    (rdev->pdev->subsystem_device == 0x7149))) {\n\t\t \n\t\tfound = 0;\n\t}\n\n\tif (!found)  \n\t\tradeon_legacy_get_primary_dac_info_from_table(rdev, p_dac);\n\n\treturn p_dac;\n}\n\nenum radeon_tv_std\nradeon_combios_get_tv_info(struct radeon_device *rdev)\n{\n\tstruct drm_device *dev = rdev->ddev;\n\tuint16_t tv_info;\n\tenum radeon_tv_std tv_std = TV_STD_NTSC;\n\n\ttv_info = combios_get_table_offset(dev, COMBIOS_TV_INFO_TABLE);\n\tif (tv_info) {\n\t\tif (RBIOS8(tv_info + 6) == 'T') {\n\t\t\tswitch (RBIOS8(tv_info + 7) & 0xf) {\n\t\t\tcase 1:\n\t\t\t\ttv_std = TV_STD_NTSC;\n\t\t\t\tDRM_DEBUG_KMS(\"Default TV standard: NTSC\\n\");\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\ttv_std = TV_STD_PAL;\n\t\t\t\tDRM_DEBUG_KMS(\"Default TV standard: PAL\\n\");\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\ttv_std = TV_STD_PAL_M;\n\t\t\t\tDRM_DEBUG_KMS(\"Default TV standard: PAL-M\\n\");\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\t\ttv_std = TV_STD_PAL_60;\n\t\t\t\tDRM_DEBUG_KMS(\"Default TV standard: PAL-60\\n\");\n\t\t\t\tbreak;\n\t\t\tcase 5:\n\t\t\t\ttv_std = TV_STD_NTSC_J;\n\t\t\t\tDRM_DEBUG_KMS(\"Default TV standard: NTSC-J\\n\");\n\t\t\t\tbreak;\n\t\t\tcase 6:\n\t\t\t\ttv_std = TV_STD_SCART_PAL;\n\t\t\t\tDRM_DEBUG_KMS(\"Default TV standard: SCART-PAL\\n\");\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\ttv_std = TV_STD_NTSC;\n\t\t\t\tDRM_DEBUG_KMS\n\t\t\t\t    (\"Unknown TV standard; defaulting to NTSC\\n\");\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tswitch ((RBIOS8(tv_info + 9) >> 2) & 0x3) {\n\t\t\tcase 0:\n\t\t\t\tDRM_DEBUG_KMS(\"29.498928713 MHz TV ref clk\\n\");\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\t\tDRM_DEBUG_KMS(\"28.636360000 MHz TV ref clk\\n\");\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tDRM_DEBUG_KMS(\"14.318180000 MHz TV ref clk\\n\");\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tDRM_DEBUG_KMS(\"27.000000000 MHz TV ref clk\\n\");\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn tv_std;\n}\n\nstatic const uint32_t default_tvdac_adj[CHIP_LAST] = {\n\t0x00000000,\t\t \n\t0x00280000,\t\t \n\t0x00000000,\t\t \n\t0x00880000,\t\t \n\t0x00000000,\t\t \n\t0x00000000,\t\t \n\t0x00770000,\t\t \n\t0x00290000,\t\t \n\t0x00560000,\t\t \n\t0x00780000,\t\t \n\t0x00770000,\t\t \n\t0x00780000,\t\t \n\t0x00780000,\t\t \n\t0x01080000,\t\t \n\t0x01080000,\t\t \n\t0x01080000,\t\t \n\t0x00780000,\t\t \n\t0x00780000,\t\t \n};\n\nstatic void radeon_legacy_get_tv_dac_info_from_table(struct radeon_device *rdev,\n\t\t\t\t\t\t     struct radeon_encoder_tv_dac *tv_dac)\n{\n\ttv_dac->ps2_tvdac_adj = default_tvdac_adj[rdev->family];\n\tif ((rdev->flags & RADEON_IS_MOBILITY) && (rdev->family == CHIP_RV250))\n\t\ttv_dac->ps2_tvdac_adj = 0x00880000;\n\ttv_dac->pal_tvdac_adj = tv_dac->ps2_tvdac_adj;\n\ttv_dac->ntsc_tvdac_adj = tv_dac->ps2_tvdac_adj;\n\treturn;\n}\n\nstruct radeon_encoder_tv_dac *radeon_combios_get_tv_dac_info(struct\n\t\t\t\t\t\t\t     radeon_encoder\n\t\t\t\t\t\t\t     *encoder)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint16_t dac_info;\n\tuint8_t rev, bg, dac;\n\tstruct radeon_encoder_tv_dac *tv_dac;\n\tint found = 0;\n\n\ttv_dac = kzalloc(sizeof(struct radeon_encoder_tv_dac), GFP_KERNEL);\n\tif (!tv_dac)\n\t\treturn NULL;\n\n\t \n\tdac_info = combios_get_table_offset(dev, COMBIOS_TV_INFO_TABLE);\n\tif (dac_info) {\n\t\trev = RBIOS8(dac_info + 0x3);\n\t\tif (rev > 4) {\n\t\t\tbg = RBIOS8(dac_info + 0xc) & 0xf;\n\t\t\tdac = RBIOS8(dac_info + 0xd) & 0xf;\n\t\t\ttv_dac->ps2_tvdac_adj = (bg << 16) | (dac << 20);\n\n\t\t\tbg = RBIOS8(dac_info + 0xe) & 0xf;\n\t\t\tdac = RBIOS8(dac_info + 0xf) & 0xf;\n\t\t\ttv_dac->pal_tvdac_adj = (bg << 16) | (dac << 20);\n\n\t\t\tbg = RBIOS8(dac_info + 0x10) & 0xf;\n\t\t\tdac = RBIOS8(dac_info + 0x11) & 0xf;\n\t\t\ttv_dac->ntsc_tvdac_adj = (bg << 16) | (dac << 20);\n\t\t\t \n\t\t\tif (tv_dac->ps2_tvdac_adj)\n\t\t\t\tfound = 1;\n\t\t} else if (rev > 1) {\n\t\t\tbg = RBIOS8(dac_info + 0xc) & 0xf;\n\t\t\tdac = (RBIOS8(dac_info + 0xc) >> 4) & 0xf;\n\t\t\ttv_dac->ps2_tvdac_adj = (bg << 16) | (dac << 20);\n\n\t\t\tbg = RBIOS8(dac_info + 0xd) & 0xf;\n\t\t\tdac = (RBIOS8(dac_info + 0xd) >> 4) & 0xf;\n\t\t\ttv_dac->pal_tvdac_adj = (bg << 16) | (dac << 20);\n\n\t\t\tbg = RBIOS8(dac_info + 0xe) & 0xf;\n\t\t\tdac = (RBIOS8(dac_info + 0xe) >> 4) & 0xf;\n\t\t\ttv_dac->ntsc_tvdac_adj = (bg << 16) | (dac << 20);\n\t\t\t \n\t\t\tif (tv_dac->ps2_tvdac_adj)\n\t\t\t\tfound = 1;\n\t\t}\n\t\ttv_dac->tv_std = radeon_combios_get_tv_info(rdev);\n\t}\n\tif (!found) {\n\t\t \n\t\tdac_info =\n\t\t    combios_get_table_offset(dev, COMBIOS_CRT_INFO_TABLE);\n\t\tif (dac_info) {\n\t\t\trev = RBIOS8(dac_info) & 0x3;\n\t\t\tif (rev < 2) {\n\t\t\t\tbg = RBIOS8(dac_info + 0x3) & 0xf;\n\t\t\t\tdac = (RBIOS8(dac_info + 0x3) >> 4) & 0xf;\n\t\t\t\ttv_dac->ps2_tvdac_adj =\n\t\t\t\t    (bg << 16) | (dac << 20);\n\t\t\t\ttv_dac->pal_tvdac_adj = tv_dac->ps2_tvdac_adj;\n\t\t\t\ttv_dac->ntsc_tvdac_adj = tv_dac->ps2_tvdac_adj;\n\t\t\t\t \n\t\t\t\tif (tv_dac->ps2_tvdac_adj)\n\t\t\t\t\tfound = 1;\n\t\t\t} else {\n\t\t\t\tbg = RBIOS8(dac_info + 0x4) & 0xf;\n\t\t\t\tdac = RBIOS8(dac_info + 0x5) & 0xf;\n\t\t\t\ttv_dac->ps2_tvdac_adj =\n\t\t\t\t    (bg << 16) | (dac << 20);\n\t\t\t\ttv_dac->pal_tvdac_adj = tv_dac->ps2_tvdac_adj;\n\t\t\t\ttv_dac->ntsc_tvdac_adj = tv_dac->ps2_tvdac_adj;\n\t\t\t\t \n\t\t\t\tif (tv_dac->ps2_tvdac_adj)\n\t\t\t\t\tfound = 1;\n\t\t\t}\n\t\t} else {\n\t\t\tDRM_INFO(\"No TV DAC info found in BIOS\\n\");\n\t\t}\n\t}\n\n\tif (!found)  \n\t\tradeon_legacy_get_tv_dac_info_from_table(rdev, tv_dac);\n\n\treturn tv_dac;\n}\n\nstatic struct radeon_encoder_lvds *radeon_legacy_get_lvds_info_from_regs(struct\n\t\t\t\t\t\t\t\t\t radeon_device\n\t\t\t\t\t\t\t\t\t *rdev)\n{\n\tstruct radeon_encoder_lvds *lvds;\n\tuint32_t fp_vert_stretch, fp_horz_stretch;\n\tuint32_t ppll_div_sel, ppll_val;\n\tuint32_t lvds_ss_gen_cntl = RREG32(RADEON_LVDS_SS_GEN_CNTL);\n\n\tlvds = kzalloc(sizeof(struct radeon_encoder_lvds), GFP_KERNEL);\n\n\tif (!lvds)\n\t\treturn NULL;\n\n\tfp_vert_stretch = RREG32(RADEON_FP_VERT_STRETCH);\n\tfp_horz_stretch = RREG32(RADEON_FP_HORZ_STRETCH);\n\n\t \n\tlvds->panel_pwr_delay = 200;\n\tlvds->panel_vcc_delay = 2000;\n\n\tlvds->lvds_gen_cntl = RREG32(RADEON_LVDS_GEN_CNTL);\n\tlvds->panel_digon_delay = (lvds_ss_gen_cntl >> RADEON_LVDS_PWRSEQ_DELAY1_SHIFT) & 0xf;\n\tlvds->panel_blon_delay = (lvds_ss_gen_cntl >> RADEON_LVDS_PWRSEQ_DELAY2_SHIFT) & 0xf;\n\n\tif (fp_vert_stretch & RADEON_VERT_STRETCH_ENABLE)\n\t\tlvds->native_mode.vdisplay =\n\t\t    ((fp_vert_stretch & RADEON_VERT_PANEL_SIZE) >>\n\t\t     RADEON_VERT_PANEL_SHIFT) + 1;\n\telse\n\t\tlvds->native_mode.vdisplay =\n\t\t    (RREG32(RADEON_CRTC_V_TOTAL_DISP) >> 16) + 1;\n\n\tif (fp_horz_stretch & RADEON_HORZ_STRETCH_ENABLE)\n\t\tlvds->native_mode.hdisplay =\n\t\t    (((fp_horz_stretch & RADEON_HORZ_PANEL_SIZE) >>\n\t\t      RADEON_HORZ_PANEL_SHIFT) + 1) * 8;\n\telse\n\t\tlvds->native_mode.hdisplay =\n\t\t    ((RREG32(RADEON_CRTC_H_TOTAL_DISP) >> 16) + 1) * 8;\n\n\tif ((lvds->native_mode.hdisplay < 640) ||\n\t    (lvds->native_mode.vdisplay < 480)) {\n\t\tlvds->native_mode.hdisplay = 640;\n\t\tlvds->native_mode.vdisplay = 480;\n\t}\n\n\tppll_div_sel = RREG8(RADEON_CLOCK_CNTL_INDEX + 1) & 0x3;\n\tppll_val = RREG32_PLL(RADEON_PPLL_DIV_0 + ppll_div_sel);\n\tif ((ppll_val & 0x000707ff) == 0x1bb)\n\t\tlvds->use_bios_dividers = false;\n\telse {\n\t\tlvds->panel_ref_divider =\n\t\t    RREG32_PLL(RADEON_PPLL_REF_DIV) & 0x3ff;\n\t\tlvds->panel_post_divider = (ppll_val >> 16) & 0x7;\n\t\tlvds->panel_fb_divider = ppll_val & 0x7ff;\n\n\t\tif ((lvds->panel_ref_divider != 0) &&\n\t\t    (lvds->panel_fb_divider > 3))\n\t\t\tlvds->use_bios_dividers = true;\n\t}\n\tlvds->panel_vcc_delay = 200;\n\n\tDRM_INFO(\"Panel info derived from registers\\n\");\n\tDRM_INFO(\"Panel Size %dx%d\\n\", lvds->native_mode.hdisplay,\n\t\t lvds->native_mode.vdisplay);\n\n\treturn lvds;\n}\n\nstruct radeon_encoder_lvds *radeon_combios_get_lvds_info(struct radeon_encoder\n\t\t\t\t\t\t\t *encoder)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint16_t lcd_info;\n\tuint32_t panel_setup;\n\tchar stmp[30];\n\tint tmp, i;\n\tstruct radeon_encoder_lvds *lvds = NULL;\n\n\tlcd_info = combios_get_table_offset(dev, COMBIOS_LCD_INFO_TABLE);\n\n\tif (lcd_info) {\n\t\tlvds = kzalloc(sizeof(struct radeon_encoder_lvds), GFP_KERNEL);\n\n\t\tif (!lvds)\n\t\t\treturn NULL;\n\n\t\tfor (i = 0; i < 24; i++)\n\t\t\tstmp[i] = RBIOS8(lcd_info + i + 1);\n\t\tstmp[24] = 0;\n\n\t\tDRM_INFO(\"Panel ID String: %s\\n\", stmp);\n\n\t\tlvds->native_mode.hdisplay = RBIOS16(lcd_info + 0x19);\n\t\tlvds->native_mode.vdisplay = RBIOS16(lcd_info + 0x1b);\n\n\t\tDRM_INFO(\"Panel Size %dx%d\\n\", lvds->native_mode.hdisplay,\n\t\t\t lvds->native_mode.vdisplay);\n\n\t\tlvds->panel_vcc_delay = RBIOS16(lcd_info + 0x2c);\n\t\tlvds->panel_vcc_delay = min_t(u16, lvds->panel_vcc_delay, 2000);\n\n\t\tlvds->panel_pwr_delay = RBIOS8(lcd_info + 0x24);\n\t\tlvds->panel_digon_delay = RBIOS16(lcd_info + 0x38) & 0xf;\n\t\tlvds->panel_blon_delay = (RBIOS16(lcd_info + 0x38) >> 4) & 0xf;\n\n\t\tlvds->panel_ref_divider = RBIOS16(lcd_info + 0x2e);\n\t\tlvds->panel_post_divider = RBIOS8(lcd_info + 0x30);\n\t\tlvds->panel_fb_divider = RBIOS16(lcd_info + 0x31);\n\t\tif ((lvds->panel_ref_divider != 0) &&\n\t\t    (lvds->panel_fb_divider > 3))\n\t\t\tlvds->use_bios_dividers = true;\n\n\t\tpanel_setup = RBIOS32(lcd_info + 0x39);\n\t\tlvds->lvds_gen_cntl = 0xff00;\n\t\tif (panel_setup & 0x1)\n\t\t\tlvds->lvds_gen_cntl |= RADEON_LVDS_PANEL_FORMAT;\n\n\t\tif ((panel_setup >> 4) & 0x1)\n\t\t\tlvds->lvds_gen_cntl |= RADEON_LVDS_PANEL_TYPE;\n\n\t\tswitch ((panel_setup >> 8) & 0x7) {\n\t\tcase 0:\n\t\t\tlvds->lvds_gen_cntl |= RADEON_LVDS_NO_FM;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tlvds->lvds_gen_cntl |= RADEON_LVDS_2_GREY;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tlvds->lvds_gen_cntl |= RADEON_LVDS_4_GREY;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tif ((panel_setup >> 16) & 0x1)\n\t\t\tlvds->lvds_gen_cntl |= RADEON_LVDS_FP_POL_LOW;\n\n\t\tif ((panel_setup >> 17) & 0x1)\n\t\t\tlvds->lvds_gen_cntl |= RADEON_LVDS_LP_POL_LOW;\n\n\t\tif ((panel_setup >> 18) & 0x1)\n\t\t\tlvds->lvds_gen_cntl |= RADEON_LVDS_DTM_POL_LOW;\n\n\t\tif ((panel_setup >> 23) & 0x1)\n\t\t\tlvds->lvds_gen_cntl |= RADEON_LVDS_BL_CLK_SEL;\n\n\t\tlvds->lvds_gen_cntl |= (panel_setup & 0xf0000000);\n\n\t\tfor (i = 0; i < 32; i++) {\n\t\t\ttmp = RBIOS16(lcd_info + 64 + i * 2);\n\t\t\tif (tmp == 0)\n\t\t\t\tbreak;\n\n\t\t\tif ((RBIOS16(tmp) == lvds->native_mode.hdisplay) &&\n\t\t\t    (RBIOS16(tmp + 2) == lvds->native_mode.vdisplay)) {\n\t\t\t\tu32 hss = (RBIOS16(tmp + 21) - RBIOS16(tmp + 19) - 1) * 8;\n\n\t\t\t\tif (hss > lvds->native_mode.hdisplay)\n\t\t\t\t\thss = (10 - 1) * 8;\n\n\t\t\t\tlvds->native_mode.htotal = lvds->native_mode.hdisplay +\n\t\t\t\t\t(RBIOS16(tmp + 17) - RBIOS16(tmp + 19)) * 8;\n\t\t\t\tlvds->native_mode.hsync_start = lvds->native_mode.hdisplay +\n\t\t\t\t\thss;\n\t\t\t\tlvds->native_mode.hsync_end = lvds->native_mode.hsync_start +\n\t\t\t\t\t(RBIOS8(tmp + 23) * 8);\n\n\t\t\t\tlvds->native_mode.vtotal = lvds->native_mode.vdisplay +\n\t\t\t\t\t(RBIOS16(tmp + 24) - RBIOS16(tmp + 26));\n\t\t\t\tlvds->native_mode.vsync_start = lvds->native_mode.vdisplay +\n\t\t\t\t\t((RBIOS16(tmp + 28) & 0x7ff) - RBIOS16(tmp + 26));\n\t\t\t\tlvds->native_mode.vsync_end = lvds->native_mode.vsync_start +\n\t\t\t\t\t((RBIOS16(tmp + 28) & 0xf800) >> 11);\n\n\t\t\t\tlvds->native_mode.clock = RBIOS16(tmp + 9) * 10;\n\t\t\t\tlvds->native_mode.flags = 0;\n\t\t\t\t \n\t\t\t\tdrm_mode_set_crtcinfo(&lvds->native_mode, CRTC_INTERLACE_HALVE_V);\n\n\t\t\t}\n\t\t}\n\t} else {\n\t\tDRM_INFO(\"No panel info found in BIOS\\n\");\n\t\tlvds = radeon_legacy_get_lvds_info_from_regs(rdev);\n\t}\n\n\tif (lvds)\n\t\tencoder->native_mode = lvds->native_mode;\n\treturn lvds;\n}\n\nstatic const struct radeon_tmds_pll default_tmds_pll[CHIP_LAST][4] = {\n\t{{12000, 0xa1b}, {0xffffffff, 0xa3f}, {0, 0}, {0, 0}},\t \n\t{{12000, 0xa1b}, {0xffffffff, 0xa3f}, {0, 0}, {0, 0}},\t \n\t{{0, 0}, {0, 0}, {0, 0}, {0, 0}},\t \n\t{{15000, 0xa1b}, {0xffffffff, 0xa3f}, {0, 0}, {0, 0}},\t \n\t{{12000, 0xa1b}, {0xffffffff, 0xa3f}, {0, 0}, {0, 0}},\t \n\t{{15000, 0xa1b}, {0xffffffff, 0xa3f}, {0, 0}, {0, 0}},\t \n\t{{15500, 0x81b}, {0xffffffff, 0x83f}, {0, 0}, {0, 0}},\t \n\t{{0, 0}, {0, 0}, {0, 0}, {0, 0}},\t \n\t{{13000, 0x400f4}, {15000, 0x400f7}, {0xffffffff, 0x40111}, {0, 0}},\t \n\t{{0xffffffff, 0xb01cb}, {0, 0}, {0, 0}, {0, 0}},\t \n\t{{0xffffffff, 0xb01cb}, {0, 0}, {0, 0}, {0, 0}},\t \n\t{{15000, 0xb0155}, {0xffffffff, 0xb01cb}, {0, 0}, {0, 0}},\t \n\t{{15000, 0xb0155}, {0xffffffff, 0xb01cb}, {0, 0}, {0, 0}},\t \n\t{{0xffffffff, 0xb01cb}, {0, 0}, {0, 0}, {0, 0}},\t \n\t{{0xffffffff, 0xb01cb}, {0, 0}, {0, 0}, {0, 0}},\t \n\t{{0xffffffff, 0xb01cb}, {0, 0}, {0, 0}, {0, 0}},\t \n\t{ {0, 0}, {0, 0}, {0, 0}, {0, 0} },\t \n\t{ {0, 0}, {0, 0}, {0, 0}, {0, 0} },\t \n};\n\nbool radeon_legacy_get_tmds_info_from_table(struct radeon_encoder *encoder,\n\t\t\t\t\t    struct radeon_encoder_int_tmds *tmds)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tint i;\n\n\tfor (i = 0; i < 4; i++) {\n\t\ttmds->tmds_pll[i].value =\n\t\t\tdefault_tmds_pll[rdev->family][i].value;\n\t\ttmds->tmds_pll[i].freq = default_tmds_pll[rdev->family][i].freq;\n\t}\n\n\treturn true;\n}\n\nbool radeon_legacy_get_tmds_info_from_combios(struct radeon_encoder *encoder,\n\t\t\t\t\t      struct radeon_encoder_int_tmds *tmds)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint16_t tmds_info;\n\tint i, n;\n\tuint8_t ver;\n\n\ttmds_info = combios_get_table_offset(dev, COMBIOS_DFP_INFO_TABLE);\n\n\tif (tmds_info) {\n\t\tver = RBIOS8(tmds_info);\n\t\tDRM_DEBUG_KMS(\"DFP table revision: %d\\n\", ver);\n\t\tif (ver == 3) {\n\t\t\tn = RBIOS8(tmds_info + 5) + 1;\n\t\t\tif (n > 4)\n\t\t\t\tn = 4;\n\t\t\tfor (i = 0; i < n; i++) {\n\t\t\t\ttmds->tmds_pll[i].value =\n\t\t\t\t    RBIOS32(tmds_info + i * 10 + 0x08);\n\t\t\t\ttmds->tmds_pll[i].freq =\n\t\t\t\t    RBIOS16(tmds_info + i * 10 + 0x10);\n\t\t\t\tDRM_DEBUG_KMS(\"TMDS PLL From COMBIOS %u %x\\n\",\n\t\t\t\t\t  tmds->tmds_pll[i].freq,\n\t\t\t\t\t  tmds->tmds_pll[i].value);\n\t\t\t}\n\t\t} else if (ver == 4) {\n\t\t\tint stride = 0;\n\t\t\tn = RBIOS8(tmds_info + 5) + 1;\n\t\t\tif (n > 4)\n\t\t\t\tn = 4;\n\t\t\tfor (i = 0; i < n; i++) {\n\t\t\t\ttmds->tmds_pll[i].value =\n\t\t\t\t    RBIOS32(tmds_info + stride + 0x08);\n\t\t\t\ttmds->tmds_pll[i].freq =\n\t\t\t\t    RBIOS16(tmds_info + stride + 0x10);\n\t\t\t\tif (i == 0)\n\t\t\t\t\tstride += 10;\n\t\t\t\telse\n\t\t\t\t\tstride += 6;\n\t\t\t\tDRM_DEBUG_KMS(\"TMDS PLL From COMBIOS %u %x\\n\",\n\t\t\t\t\t  tmds->tmds_pll[i].freq,\n\t\t\t\t\t  tmds->tmds_pll[i].value);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tDRM_INFO(\"No TMDS info found in BIOS\\n\");\n\t\treturn false;\n\t}\n\treturn true;\n}\n\nbool radeon_legacy_get_ext_tmds_info_from_table(struct radeon_encoder *encoder,\n\t\t\t\t\t\tstruct radeon_encoder_ext_tmds *tmds)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_i2c_bus_rec i2c_bus;\n\n\t \n\ti2c_bus = combios_setup_i2c_bus(rdev, DDC_MONID, 0, 0);\n\ttmds->i2c_bus = radeon_i2c_lookup(rdev, &i2c_bus);\n\n\t \n\tswitch (rdev->mode_info.connector_table) {\n\tcase CT_POWERBOOK_EXTERNAL:\n\tcase CT_MINI_EXTERNAL:\n\tdefault:\n\t\ttmds->dvo_chip = DVO_SIL164;\n\t\ttmds->slave_addr = 0x70 >> 1;  \n\t\tbreak;\n\t}\n\n\treturn true;\n}\n\nbool radeon_legacy_get_ext_tmds_info_from_combios(struct radeon_encoder *encoder,\n\t\t\t\t\t\t  struct radeon_encoder_ext_tmds *tmds)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint16_t offset;\n\tuint8_t ver;\n\tenum radeon_combios_ddc gpio;\n\tstruct radeon_i2c_bus_rec i2c_bus;\n\n\ttmds->i2c_bus = NULL;\n\tif (rdev->flags & RADEON_IS_IGP) {\n\t\ti2c_bus = combios_setup_i2c_bus(rdev, DDC_MONID, 0, 0);\n\t\ttmds->i2c_bus = radeon_i2c_lookup(rdev, &i2c_bus);\n\t\ttmds->dvo_chip = DVO_SIL164;\n\t\ttmds->slave_addr = 0x70 >> 1;  \n\t} else {\n\t\toffset = combios_get_table_offset(dev, COMBIOS_EXT_TMDS_INFO_TABLE);\n\t\tif (offset) {\n\t\t\tver = RBIOS8(offset);\n\t\t\tDRM_DEBUG_KMS(\"External TMDS Table revision: %d\\n\", ver);\n\t\t\ttmds->slave_addr = RBIOS8(offset + 4 + 2);\n\t\t\ttmds->slave_addr >>= 1;  \n\t\t\tgpio = RBIOS8(offset + 4 + 3);\n\t\t\tif (gpio == DDC_LCD) {\n\t\t\t\t \n\t\t\t\ti2c_bus.valid = true;\n\t\t\t\ti2c_bus.hw_capable = true;\n\t\t\t\ti2c_bus.mm_i2c = true;\n\t\t\t\ti2c_bus.i2c_id = 0xa0;\n\t\t\t} else\n\t\t\t\ti2c_bus = combios_setup_i2c_bus(rdev, gpio, 0, 0);\n\t\t\ttmds->i2c_bus = radeon_i2c_lookup(rdev, &i2c_bus);\n\t\t}\n\t}\n\n\tif (!tmds->i2c_bus) {\n\t\tDRM_INFO(\"No valid Ext TMDS info found in BIOS\\n\");\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nbool radeon_get_legacy_connector_info_from_table(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_i2c_bus_rec ddc_i2c;\n\tstruct radeon_hpd hpd;\n\n\trdev->mode_info.connector_table = radeon_connector_table;\n\tif (rdev->mode_info.connector_table == CT_NONE) {\n#ifdef CONFIG_PPC_PMAC\n\t\tif (of_machine_is_compatible(\"PowerBook3,3\")) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_POWERBOOK_VGA;\n\t\t} else if (of_machine_is_compatible(\"PowerBook3,4\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook3,5\")) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_POWERBOOK_INTERNAL;\n\t\t} else if (of_machine_is_compatible(\"PowerBook5,1\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook5,2\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook5,3\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook5,4\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook5,5\")) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_POWERBOOK_EXTERNAL;\n\t\t} else if (of_machine_is_compatible(\"PowerBook5,6\")) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_POWERBOOK_EXTERNAL;\n\t\t} else if (of_machine_is_compatible(\"PowerBook5,7\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook5,8\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook5,9\")) {\n\t\t\t \n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_POWERBOOK_EXTERNAL;\n\t\t} else if (of_machine_is_compatible(\"PowerBook4,1\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook4,2\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook4,3\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook6,3\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook6,5\") ||\n\t\t\t   of_machine_is_compatible(\"PowerBook6,7\")) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_IBOOK;\n\t\t} else if (of_machine_is_compatible(\"PowerMac3,5\")) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_MAC_G4_SILVER;\n\t\t} else if (of_machine_is_compatible(\"PowerMac4,4\")) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_EMAC;\n\t\t} else if (of_machine_is_compatible(\"PowerMac10,1\")) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_MINI_INTERNAL;\n\t\t} else if (of_machine_is_compatible(\"PowerMac10,2\")) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_MINI_EXTERNAL;\n\t\t} else if (of_machine_is_compatible(\"PowerMac12,1\")) {\n\t\t\t \n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_IMAC_G5_ISIGHT;\n\t\t} else if ((rdev->pdev->device == 0x4a48) &&\n\t\t\t   (rdev->pdev->subsystem_vendor == 0x1002) &&\n\t\t\t   (rdev->pdev->subsystem_device == 0x4a48)) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_MAC_X800;\n\t\t} else if ((of_machine_is_compatible(\"PowerMac7,2\") ||\n\t\t\t    of_machine_is_compatible(\"PowerMac7,3\")) &&\n\t\t\t   (rdev->pdev->device == 0x4150) &&\n\t\t\t   (rdev->pdev->subsystem_vendor == 0x1002) &&\n\t\t\t   (rdev->pdev->subsystem_device == 0x4150)) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_MAC_G5_9600;\n\t\t} else if ((rdev->pdev->device == 0x4c66) &&\n\t\t\t   (rdev->pdev->subsystem_vendor == 0x1002) &&\n\t\t\t   (rdev->pdev->subsystem_device == 0x4c66)) {\n\t\t\t \n\t\t\trdev->mode_info.connector_table = CT_SAM440EP;\n\t\t} else\n#endif  \n#ifdef CONFIG_PPC64\n\t\tif (ASIC_IS_RN50(rdev))\n\t\t\trdev->mode_info.connector_table = CT_RN50_POWER;\n\t\telse\n#endif\n\t\t\trdev->mode_info.connector_table = CT_GENERIC;\n\t}\n\n\tswitch (rdev->mode_info.connector_table) {\n\tcase CT_GENERIC:\n\t\tDRM_INFO(\"Connector Table: %d (generic)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tif (rdev->flags & RADEON_SINGLE_CRTC) {\n\t\t\t \n\t\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\t\thpd.hpd = RADEON_HPD_NONE;\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\t\tradeon_add_legacy_connector(dev, 0,\n\t\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA,\n\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t\t    &hpd);\n\t\t} else if (rdev->flags & RADEON_IS_MOBILITY) {\n\t\t\t \n\t\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_NONE_DETECTED, 0, 0);\n\t\t\thpd.hpd = RADEON_HPD_NONE;\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t\t  ATOM_DEVICE_LCD1_SUPPORT);\n\t\t\tradeon_add_legacy_connector(dev, 0,\n\t\t\t\t\t\t    ATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t\t    DRM_MODE_CONNECTOR_LVDS,\n\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_LVDS,\n\t\t\t\t\t\t    &hpd);\n\n\t\t\t \n\t\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\t\thpd.hpd = RADEON_HPD_NONE;\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\t\tradeon_add_legacy_connector(dev, 1,\n\t\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA,\n\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t\t    &hpd);\n\t\t} else {\n\t\t\t \n\t\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\t\thpd.hpd = RADEON_HPD_1;\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\t\tradeon_add_legacy_connector(dev, 0,\n\t\t\t\t\t\t    ATOM_DEVICE_DFP1_SUPPORT |\n\t\t\t\t\t\t    ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII,\n\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t\t    &hpd);\n\n\t\t\t \n\t\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\t\thpd.hpd = RADEON_HPD_NONE;\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\t\tradeon_add_legacy_connector(dev, 1,\n\t\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA,\n\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t\t    &hpd);\n\t\t}\n\n\t\tif (rdev->family != CHIP_R100 && rdev->family != CHIP_R200) {\n\t\t\t \n\t\t\tddc_i2c.valid = false;\n\t\t\thpd.hpd = RADEON_HPD_NONE;\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\t\tradeon_add_legacy_connector(dev, 2,\n\t\t\t\t\t\t    ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t\t    &hpd);\n\t\t}\n\t\tbreak;\n\tcase CT_IBOOK:\n\t\tDRM_INFO(\"Connector Table: %d (ibook)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_LCD1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0, ATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_LVDS, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_LVDS,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1, ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 2, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_POWERBOOK_EXTERNAL:\n\t\tDRM_INFO(\"Connector Table: %d (powerbook external tmds)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_LCD1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0, ATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_LVDS, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_LVDS,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\thpd.hpd = RADEON_HPD_2;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_DFP2_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_DFP2_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\t \n\t\tradeon_add_legacy_connector(dev, 1,\n\t\t\t\t\t    ATOM_DEVICE_DFP2_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 2, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_POWERBOOK_INTERNAL:\n\t\tDRM_INFO(\"Connector Table: %d (powerbook internal tmds)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_LCD1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0, ATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_LVDS, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_LVDS,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\thpd.hpd = RADEON_HPD_1;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1,\n\t\t\t\t\t    ATOM_DEVICE_DFP1_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 2, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_POWERBOOK_VGA:\n\t\tDRM_INFO(\"Connector Table: %d (powerbook vga)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_LCD1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0, ATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_LVDS, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_LVDS,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1, ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 2, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_MINI_EXTERNAL:\n\t\tDRM_INFO(\"Connector Table: %d (mini external tmds)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_CRT2, 0, 0);\n\t\thpd.hpd = RADEON_HPD_2;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_DFP2_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_DFP2_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\t \n\t\tradeon_add_legacy_connector(dev, 0,\n\t\t\t\t\t    ATOM_DEVICE_DFP2_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_MINI_INTERNAL:\n\t\tDRM_INFO(\"Connector Table: %d (mini internal tmds)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_CRT2, 0, 0);\n\t\thpd.hpd = RADEON_HPD_1;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0,\n\t\t\t\t\t    ATOM_DEVICE_DFP1_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_IMAC_G5_ISIGHT:\n\t\tDRM_INFO(\"Connector Table: %d (imac g5 isight)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_MONID, 0, 0);\n\t\thpd.hpd = RADEON_HPD_1;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0, ATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVID, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1, ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 2, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_EMAC:\n\t\tDRM_INFO(\"Connector Table: %d (emac)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0, ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_CRT2, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1, ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 2, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_RN50_POWER:\n\t\tDRM_INFO(\"Connector Table: %d (rn50-power)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0, ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t    &hpd);\n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_CRT2, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1, ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_MAC_X800:\n\t\tDRM_INFO(\"Connector Table: %d (mac x800)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\thpd.hpd = RADEON_HPD_1;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t  0),\n\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t  1),\n\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0,\n\t\t\t\t\t    ATOM_DEVICE_DFP1_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_MONID, 0, 0);\n\t\thpd.hpd = RADEON_HPD_2;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_DFP2_SUPPORT,\n\t\t\t\t\t\t\t\t  0),\n\t\t\t\t\t  ATOM_DEVICE_DFP2_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t  2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1,\n\t\t\t\t\t    ATOM_DEVICE_DFP2_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_MAC_G5_9600:\n\t\tDRM_INFO(\"Connector Table: %d (mac g5 9600)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\thpd.hpd = RADEON_HPD_1;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_DFP2_SUPPORT,\n\t\t\t\t\t\t\t\t  0),\n\t\t\t\t\t  ATOM_DEVICE_DFP2_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t  2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0,\n\t\t\t\t\t    ATOM_DEVICE_DFP2_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\thpd.hpd = RADEON_HPD_2;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t  0),\n\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t  1),\n\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1,\n\t\t\t\t\t    ATOM_DEVICE_DFP1_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 2, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_SAM440EP:\n\t\tDRM_INFO(\"Connector Table: %d (SAM440ep embedded board)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_NONE_DETECTED, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_LCD1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0, ATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_LVDS, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_LVDS,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\thpd.hpd = RADEON_HPD_1;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1,\n\t\t\t\t\t    ATOM_DEVICE_DFP1_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 2,\n\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 3, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tcase CT_MAC_G4_SILVER:\n\t\tDRM_INFO(\"Connector Table: %d (mac g4 silver)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\thpd.hpd = RADEON_HPD_1;  \n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 0,\n\t\t\t\t\t    ATOM_DEVICE_DFP1_SUPPORT |\n\t\t\t\t\t    ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 1, ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA, &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t    &hpd);\n\t\t \n\t\tddc_i2c.valid = false;\n\t\thpd.hpd = RADEON_HPD_NONE;\n\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\tATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\tradeon_add_legacy_connector(dev, 2, ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t    &hpd);\n\t\tbreak;\n\tdefault:\n\t\tDRM_INFO(\"Connector table: %d (invalid)\\n\",\n\t\t\t rdev->mode_info.connector_table);\n\t\treturn false;\n\t}\n\n\tradeon_link_encoder_connector(dev);\n\n\treturn true;\n}\n\nstatic bool radeon_apply_legacy_quirks(struct drm_device *dev,\n\t\t\t\t       int bios_index,\n\t\t\t\t       enum radeon_combios_connector\n\t\t\t\t       *legacy_connector,\n\t\t\t\t       struct radeon_i2c_bus_rec *ddc_i2c,\n\t\t\t\t       struct radeon_hpd *hpd)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\n\t \n\tif (rdev->pdev->device == 0x515e &&\n\t    rdev->pdev->subsystem_vendor == 0x1014) {\n\t\tif (*legacy_connector == CONNECTOR_CRT_LEGACY &&\n\t\t    ddc_i2c->mask_clk_reg == RADEON_GPIO_CRT2_DDC)\n\t\t\treturn false;\n\t}\n\n\t \n\tif (rdev->pdev->device == 0x5B60 &&\n\t    rdev->pdev->subsystem_vendor == 0x17af &&\n\t    rdev->pdev->subsystem_device == 0x201e && bios_index == 2) {\n\t\tif (*legacy_connector == CONNECTOR_DVI_I_LEGACY)\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic bool radeon_apply_legacy_tv_quirks(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\n\t \n\tif (rdev->pdev->device == 0x5975 &&\n\t    rdev->pdev->subsystem_vendor == 0x1025 &&\n\t    rdev->pdev->subsystem_device == 0x009f)\n\t\treturn false;\n\n\t \n\tif (rdev->pdev->device == 0x5974 &&\n\t    rdev->pdev->subsystem_vendor == 0x103c &&\n\t    rdev->pdev->subsystem_device == 0x280a)\n\t\treturn false;\n\n\t \n\tif (rdev->pdev->device == 0x5955 &&\n\t    rdev->pdev->subsystem_vendor == 0x1462 &&\n\t    rdev->pdev->subsystem_device == 0x0131)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic uint16_t combios_check_dl_dvi(struct drm_device *dev, int is_dvi_d)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t ext_tmds_info;\n\n\tif (rdev->flags & RADEON_IS_IGP) {\n\t\tif (is_dvi_d)\n\t\t\treturn CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D;\n\t\telse\n\t\t\treturn CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I;\n\t}\n\text_tmds_info = combios_get_table_offset(dev, COMBIOS_EXT_TMDS_INFO_TABLE);\n\tif (ext_tmds_info) {\n\t\tuint8_t rev = RBIOS8(ext_tmds_info);\n\t\tuint8_t flags = RBIOS8(ext_tmds_info + 4 + 5);\n\t\tif (rev >= 3) {\n\t\t\tif (is_dvi_d)\n\t\t\t\treturn CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D;\n\t\t\telse\n\t\t\t\treturn CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I;\n\t\t} else {\n\t\t\tif (flags & 1) {\n\t\t\t\tif (is_dvi_d)\n\t\t\t\t\treturn CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D;\n\t\t\t\telse\n\t\t\t\t\treturn CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I;\n\t\t\t}\n\t\t}\n\t}\n\tif (is_dvi_d)\n\t\treturn CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D;\n\telse\n\t\treturn CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I;\n}\n\nbool radeon_get_legacy_connector_info_from_bios(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t conn_info, entry, devices;\n\tuint16_t tmp, connector_object_id;\n\tenum radeon_combios_ddc ddc_type;\n\tenum radeon_combios_connector connector;\n\tint i = 0;\n\tstruct radeon_i2c_bus_rec ddc_i2c;\n\tstruct radeon_hpd hpd;\n\n\tconn_info = combios_get_table_offset(dev, COMBIOS_CONNECTOR_INFO_TABLE);\n\tif (conn_info) {\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tentry = conn_info + 2 + i * 2;\n\n\t\t\tif (!RBIOS16(entry))\n\t\t\t\tbreak;\n\n\t\t\ttmp = RBIOS16(entry);\n\n\t\t\tconnector = (tmp >> 12) & 0xf;\n\n\t\t\tddc_type = (tmp >> 8) & 0xf;\n\t\t\tif (ddc_type == 5)\n\t\t\t\tddc_i2c = radeon_combios_get_i2c_info_from_table(rdev);\n\t\t\telse\n\t\t\t\tddc_i2c = combios_setup_i2c_bus(rdev, ddc_type, 0, 0);\n\n\t\t\tswitch (connector) {\n\t\t\tcase CONNECTOR_PROPRIETARY_LEGACY:\n\t\t\tcase CONNECTOR_DVI_I_LEGACY:\n\t\t\tcase CONNECTOR_DVI_D_LEGACY:\n\t\t\t\tif ((tmp >> 4) & 0x1)\n\t\t\t\t\thpd.hpd = RADEON_HPD_2;\n\t\t\t\telse\n\t\t\t\t\thpd.hpd = RADEON_HPD_1;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\thpd.hpd = RADEON_HPD_NONE;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!radeon_apply_legacy_quirks(dev, i, &connector,\n\t\t\t\t\t\t\t&ddc_i2c, &hpd))\n\t\t\t\tcontinue;\n\n\t\t\tswitch (connector) {\n\t\t\tcase CONNECTOR_PROPRIETARY_LEGACY:\n\t\t\t\tif ((tmp >> 4) & 0x1)\n\t\t\t\t\tdevices = ATOM_DEVICE_DFP2_SUPPORT;\n\t\t\t\telse\n\t\t\t\t\tdevices = ATOM_DEVICE_DFP1_SUPPORT;\n\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t  (dev, devices, 0),\n\t\t\t\t\t\t\t  devices);\n\t\t\t\tradeon_add_legacy_connector(dev, i, devices,\n\t\t\t\t\t\t\t    legacy_connector_convert\n\t\t\t\t\t\t\t    [connector],\n\t\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D,\n\t\t\t\t\t\t\t    &hpd);\n\t\t\t\tbreak;\n\t\t\tcase CONNECTOR_CRT_LEGACY:\n\t\t\t\tif (tmp & 0x1) {\n\t\t\t\t\tdevices = ATOM_DEVICE_CRT2_SUPPORT;\n\t\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t\t  (dev,\n\t\t\t\t\t\t\t\t   ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t   2),\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\t\t\t} else {\n\t\t\t\t\tdevices = ATOM_DEVICE_CRT1_SUPPORT;\n\t\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t\t  (dev,\n\t\t\t\t\t\t\t\t   ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t   1),\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\t\t\t}\n\t\t\t\tradeon_add_legacy_connector(dev,\n\t\t\t\t\t\t\t    i,\n\t\t\t\t\t\t\t    devices,\n\t\t\t\t\t\t\t    legacy_connector_convert\n\t\t\t\t\t\t\t    [connector],\n\t\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t\t\t    &hpd);\n\t\t\t\tbreak;\n\t\t\tcase CONNECTOR_DVI_I_LEGACY:\n\t\t\t\tdevices = 0;\n\t\t\t\tif (tmp & 0x1) {\n\t\t\t\t\tdevices |= ATOM_DEVICE_CRT2_SUPPORT;\n\t\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t\t  (dev,\n\t\t\t\t\t\t\t\t   ATOM_DEVICE_CRT2_SUPPORT,\n\t\t\t\t\t\t\t\t   2),\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_CRT2_SUPPORT);\n\t\t\t\t} else {\n\t\t\t\t\tdevices |= ATOM_DEVICE_CRT1_SUPPORT;\n\t\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t\t  (dev,\n\t\t\t\t\t\t\t\t   ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t   1),\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\tif (rdev->pdev->device == 0x5159 &&\n\t\t\t\t    rdev->pdev->subsystem_vendor == 0x1014 &&\n\t\t\t\t    rdev->pdev->subsystem_device == 0x029A) {\n\t\t\t\t\ttmp &= ~(1 << 4);\n\t\t\t\t}\n\t\t\t\tif ((tmp >> 4) & 0x1) {\n\t\t\t\t\tdevices |= ATOM_DEVICE_DFP2_SUPPORT;\n\t\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t\t  (dev,\n\t\t\t\t\t\t\t\t   ATOM_DEVICE_DFP2_SUPPORT,\n\t\t\t\t\t\t\t\t   0),\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_DFP2_SUPPORT);\n\t\t\t\t\tconnector_object_id = combios_check_dl_dvi(dev, 0);\n\t\t\t\t} else {\n\t\t\t\t\tdevices |= ATOM_DEVICE_DFP1_SUPPORT;\n\t\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t\t  (dev,\n\t\t\t\t\t\t\t\t   ATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t   0),\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\t\t\t\t\tconnector_object_id = CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I;\n\t\t\t\t}\n\t\t\t\tradeon_add_legacy_connector(dev,\n\t\t\t\t\t\t\t    i,\n\t\t\t\t\t\t\t    devices,\n\t\t\t\t\t\t\t    legacy_connector_convert\n\t\t\t\t\t\t\t    [connector],\n\t\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t\t    connector_object_id,\n\t\t\t\t\t\t\t    &hpd);\n\t\t\t\tbreak;\n\t\t\tcase CONNECTOR_DVI_D_LEGACY:\n\t\t\t\tif ((tmp >> 4) & 0x1) {\n\t\t\t\t\tdevices = ATOM_DEVICE_DFP2_SUPPORT;\n\t\t\t\t\tconnector_object_id = combios_check_dl_dvi(dev, 1);\n\t\t\t\t} else {\n\t\t\t\t\tdevices = ATOM_DEVICE_DFP1_SUPPORT;\n\t\t\t\t\tconnector_object_id = CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I;\n\t\t\t\t}\n\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t  (dev, devices, 0),\n\t\t\t\t\t\t\t  devices);\n\t\t\t\tradeon_add_legacy_connector(dev, i, devices,\n\t\t\t\t\t\t\t    legacy_connector_convert\n\t\t\t\t\t\t\t    [connector],\n\t\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t\t    connector_object_id,\n\t\t\t\t\t\t\t    &hpd);\n\t\t\t\tbreak;\n\t\t\tcase CONNECTOR_CTV_LEGACY:\n\t\t\tcase CONNECTOR_STV_LEGACY:\n\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t  (dev,\n\t\t\t\t\t\t\t   ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t   2),\n\t\t\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\t\t\tradeon_add_legacy_connector(dev, i,\n\t\t\t\t\t\t\t    ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t    legacy_connector_convert\n\t\t\t\t\t\t\t    [connector],\n\t\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t\t\t    &hpd);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tDRM_ERROR(\"Unknown connector type: %d\\n\",\n\t\t\t\t\t  connector);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t}\n\t} else {\n\t\tuint16_t tmds_info =\n\t\t    combios_get_table_offset(dev, COMBIOS_DFP_INFO_TABLE);\n\t\tif (tmds_info) {\n\t\t\tDRM_DEBUG_KMS(\"Found DFP table, assuming DVI connector\\n\");\n\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t\t  ATOM_DEVICE_DFP1_SUPPORT);\n\n\t\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_DVI, 0, 0);\n\t\t\thpd.hpd = RADEON_HPD_1;\n\t\t\tradeon_add_legacy_connector(dev,\n\t\t\t\t\t\t    0,\n\t\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT |\n\t\t\t\t\t\t    ATOM_DEVICE_DFP1_SUPPORT,\n\t\t\t\t\t\t    DRM_MODE_CONNECTOR_DVII,\n\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I,\n\t\t\t\t\t\t    &hpd);\n\t\t} else {\n\t\t\tuint16_t crt_info =\n\t\t\t\tcombios_get_table_offset(dev, COMBIOS_CRT_INFO_TABLE);\n\t\t\tDRM_DEBUG_KMS(\"Found CRT table, assuming VGA connector\\n\");\n\t\t\tif (crt_info) {\n\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\t\tATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t\t\t  ATOM_DEVICE_CRT1_SUPPORT);\n\t\t\t\tddc_i2c = combios_setup_i2c_bus(rdev, DDC_VGA, 0, 0);\n\t\t\t\thpd.hpd = RADEON_HPD_NONE;\n\t\t\t\tradeon_add_legacy_connector(dev,\n\t\t\t\t\t\t\t    0,\n\t\t\t\t\t\t\t    ATOM_DEVICE_CRT1_SUPPORT,\n\t\t\t\t\t\t\t    DRM_MODE_CONNECTOR_VGA,\n\t\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_VGA,\n\t\t\t\t\t\t\t    &hpd);\n\t\t\t} else {\n\t\t\t\tDRM_DEBUG_KMS(\"No connector info found\\n\");\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (rdev->flags & RADEON_IS_MOBILITY || rdev->flags & RADEON_IS_IGP) {\n\t\tuint16_t lcd_info =\n\t\t    combios_get_table_offset(dev, COMBIOS_LCD_INFO_TABLE);\n\t\tif (lcd_info) {\n\t\t\tuint16_t lcd_ddc_info =\n\t\t\t    combios_get_table_offset(dev,\n\t\t\t\t\t\t     COMBIOS_LCD_DDC_INFO_TABLE);\n\n\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t  radeon_get_encoder_enum(dev,\n\t\t\t\t\t\t\t\t\tATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t\t\t\t\t0),\n\t\t\t\t\t\t  ATOM_DEVICE_LCD1_SUPPORT);\n\n\t\t\tif (lcd_ddc_info) {\n\t\t\t\tddc_type = RBIOS8(lcd_ddc_info + 2);\n\t\t\t\tswitch (ddc_type) {\n\t\t\t\tcase DDC_LCD:\n\t\t\t\t\tddc_i2c =\n\t\t\t\t\t\tcombios_setup_i2c_bus(rdev,\n\t\t\t\t\t\t\t\t      DDC_LCD,\n\t\t\t\t\t\t\t\t      RBIOS32(lcd_ddc_info + 3),\n\t\t\t\t\t\t\t\t      RBIOS32(lcd_ddc_info + 7));\n\t\t\t\t\tradeon_i2c_add(rdev, &ddc_i2c, \"LCD\");\n\t\t\t\t\tbreak;\n\t\t\t\tcase DDC_GPIO:\n\t\t\t\t\tddc_i2c =\n\t\t\t\t\t\tcombios_setup_i2c_bus(rdev,\n\t\t\t\t\t\t\t\t      DDC_GPIO,\n\t\t\t\t\t\t\t\t      RBIOS32(lcd_ddc_info + 3),\n\t\t\t\t\t\t\t\t      RBIOS32(lcd_ddc_info + 7));\n\t\t\t\t\tradeon_i2c_add(rdev, &ddc_i2c, \"LCD\");\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tddc_i2c =\n\t\t\t\t\t\tcombios_setup_i2c_bus(rdev, ddc_type, 0, 0);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tDRM_DEBUG_KMS(\"LCD DDC Info Table found!\\n\");\n\t\t\t} else\n\t\t\t\tddc_i2c.valid = false;\n\n\t\t\thpd.hpd = RADEON_HPD_NONE;\n\t\t\tradeon_add_legacy_connector(dev,\n\t\t\t\t\t\t    5,\n\t\t\t\t\t\t    ATOM_DEVICE_LCD1_SUPPORT,\n\t\t\t\t\t\t    DRM_MODE_CONNECTOR_LVDS,\n\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_LVDS,\n\t\t\t\t\t\t    &hpd);\n\t\t}\n\t}\n\n\t \n\tif (rdev->family != CHIP_R100 && rdev->family != CHIP_R200) {\n\t\tuint32_t tv_info =\n\t\t    combios_get_table_offset(dev, COMBIOS_TV_INFO_TABLE);\n\t\tif (tv_info) {\n\t\t\tif (RBIOS8(tv_info + 6) == 'T') {\n\t\t\t\tif (radeon_apply_legacy_tv_quirks(dev)) {\n\t\t\t\t\thpd.hpd = RADEON_HPD_NONE;\n\t\t\t\t\tddc_i2c.valid = false;\n\t\t\t\t\tradeon_add_legacy_encoder(dev,\n\t\t\t\t\t\t\t\t  radeon_get_encoder_enum\n\t\t\t\t\t\t\t\t  (dev,\n\t\t\t\t\t\t\t\t   ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t   2),\n\t\t\t\t\t\t\t\t  ATOM_DEVICE_TV1_SUPPORT);\n\t\t\t\t\tradeon_add_legacy_connector(dev, 6,\n\t\t\t\t\t\t\t\t    ATOM_DEVICE_TV1_SUPPORT,\n\t\t\t\t\t\t\t\t    DRM_MODE_CONNECTOR_SVIDEO,\n\t\t\t\t\t\t\t\t    &ddc_i2c,\n\t\t\t\t\t\t\t\t    CONNECTOR_OBJECT_ID_SVIDEO,\n\t\t\t\t\t\t\t\t    &hpd);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tradeon_link_encoder_connector(dev);\n\n\treturn true;\n}\n\nstatic const char *thermal_controller_names[] = {\n\t\"NONE\",\n\t\"lm63\",\n\t\"adm1032\",\n};\n\nvoid radeon_combios_get_power_modes(struct radeon_device *rdev)\n{\n\tstruct drm_device *dev = rdev->ddev;\n\tu16 offset, misc, misc2 = 0;\n\tu8 rev, tmp;\n\tint state_index = 0;\n\tstruct radeon_i2c_bus_rec i2c_bus;\n\n\trdev->pm.default_power_state_index = -1;\n\n\t \n\trdev->pm.power_state = kcalloc(2, sizeof(struct radeon_power_state),\n\t\t\t\t       GFP_KERNEL);\n\tif (rdev->pm.power_state) {\n\t\t \n\t\trdev->pm.power_state[0].clock_info =\n\t\t\tkcalloc(1, sizeof(struct radeon_pm_clock_info),\n\t\t\t\tGFP_KERNEL);\n\t\trdev->pm.power_state[1].clock_info =\n\t\t\tkcalloc(1, sizeof(struct radeon_pm_clock_info),\n\t\t\t\tGFP_KERNEL);\n\t\tif (!rdev->pm.power_state[0].clock_info ||\n\t\t    !rdev->pm.power_state[1].clock_info)\n\t\t\tgoto pm_failed;\n\t} else\n\t\tgoto pm_failed;\n\n\t \n\toffset = combios_get_table_offset(dev, COMBIOS_OVERDRIVE_INFO_TABLE);\n\tif (offset) {\n\t\tu8 thermal_controller = 0, gpio = 0, i2c_addr = 0, clk_bit = 0, data_bit = 0;\n\n\t\trev = RBIOS8(offset);\n\n\t\tif (rev == 0) {\n\t\t\tthermal_controller = RBIOS8(offset + 3);\n\t\t\tgpio = RBIOS8(offset + 4) & 0x3f;\n\t\t\ti2c_addr = RBIOS8(offset + 5);\n\t\t} else if (rev == 1) {\n\t\t\tthermal_controller = RBIOS8(offset + 4);\n\t\t\tgpio = RBIOS8(offset + 5) & 0x3f;\n\t\t\ti2c_addr = RBIOS8(offset + 6);\n\t\t} else if (rev == 2) {\n\t\t\tthermal_controller = RBIOS8(offset + 4);\n\t\t\tgpio = RBIOS8(offset + 5) & 0x3f;\n\t\t\ti2c_addr = RBIOS8(offset + 6);\n\t\t\tclk_bit = RBIOS8(offset + 0xa);\n\t\t\tdata_bit = RBIOS8(offset + 0xb);\n\t\t}\n\t\tif ((thermal_controller > 0) && (thermal_controller < 3)) {\n\t\t\tDRM_INFO(\"Possible %s thermal controller at 0x%02x\\n\",\n\t\t\t\t thermal_controller_names[thermal_controller],\n\t\t\t\t i2c_addr >> 1);\n\t\t\tif (gpio == DDC_LCD) {\n\t\t\t\t \n\t\t\t\ti2c_bus.valid = true;\n\t\t\t\ti2c_bus.hw_capable = true;\n\t\t\t\ti2c_bus.mm_i2c = true;\n\t\t\t\ti2c_bus.i2c_id = 0xa0;\n\t\t\t} else if (gpio == DDC_GPIO)\n\t\t\t\ti2c_bus = combios_setup_i2c_bus(rdev, gpio, 1 << clk_bit, 1 << data_bit);\n\t\t\telse\n\t\t\t\ti2c_bus = combios_setup_i2c_bus(rdev, gpio, 0, 0);\n\t\t\trdev->pm.i2c_bus = radeon_i2c_lookup(rdev, &i2c_bus);\n\t\t\tif (rdev->pm.i2c_bus) {\n\t\t\t\tstruct i2c_board_info info = { };\n\t\t\t\tconst char *name = thermal_controller_names[thermal_controller];\n\t\t\t\tinfo.addr = i2c_addr >> 1;\n\t\t\t\tstrscpy(info.type, name, sizeof(info.type));\n\t\t\t\ti2c_new_client_device(&rdev->pm.i2c_bus->adapter, &info);\n\t\t\t}\n\t\t}\n\t} else {\n\t\t \n\n\t\t \n\t\tif ((rdev->pdev->device == 0x4152) &&\n\t\t    (rdev->pdev->subsystem_vendor == 0x1043) &&\n\t\t    (rdev->pdev->subsystem_device == 0xc002)) {\n\t\t\ti2c_bus = combios_setup_i2c_bus(rdev, DDC_MONID, 0, 0);\n\t\t\trdev->pm.i2c_bus = radeon_i2c_lookup(rdev, &i2c_bus);\n\t\t\tif (rdev->pm.i2c_bus) {\n\t\t\t\tstruct i2c_board_info info = { };\n\t\t\t\tconst char *name = \"f75375\";\n\t\t\t\tinfo.addr = 0x28;\n\t\t\t\tstrscpy(info.type, name, sizeof(info.type));\n\t\t\t\ti2c_new_client_device(&rdev->pm.i2c_bus->adapter, &info);\n\t\t\t\tDRM_INFO(\"Possible %s thermal controller at 0x%02x\\n\",\n\t\t\t\t\t name, info.addr);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (rdev->flags & RADEON_IS_MOBILITY) {\n\t\toffset = combios_get_table_offset(dev, COMBIOS_POWERPLAY_INFO_TABLE);\n\t\tif (offset) {\n\t\t\trev = RBIOS8(offset);\n\t\t\t \n\t\t\trdev->pm.power_state[state_index].num_clock_modes = 1;\n\t\t\trdev->pm.power_state[state_index].clock_info[0].mclk = RBIOS32(offset + 0x5 + 0x2);\n\t\t\trdev->pm.power_state[state_index].clock_info[0].sclk = RBIOS32(offset + 0x5 + 0x6);\n\t\t\tif ((rdev->pm.power_state[state_index].clock_info[0].mclk == 0) ||\n\t\t\t    (rdev->pm.power_state[state_index].clock_info[0].sclk == 0))\n\t\t\t\tgoto default_mode;\n\t\t\trdev->pm.power_state[state_index].type =\n\t\t\t\tPOWER_STATE_TYPE_BATTERY;\n\t\t\tmisc = RBIOS16(offset + 0x5 + 0x0);\n\t\t\tif (rev > 4)\n\t\t\t\tmisc2 = RBIOS16(offset + 0x5 + 0xe);\n\t\t\trdev->pm.power_state[state_index].misc = misc;\n\t\t\trdev->pm.power_state[state_index].misc2 = misc2;\n\t\t\tif (misc & 0x4) {\n\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.type = VOLTAGE_GPIO;\n\t\t\t\tif (misc & 0x8)\n\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.active_high =\n\t\t\t\t\t\ttrue;\n\t\t\t\telse\n\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.active_high =\n\t\t\t\t\t\tfalse;\n\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.gpio.valid = true;\n\t\t\t\tif (rev < 6) {\n\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.gpio.reg =\n\t\t\t\t\t\tRBIOS16(offset + 0x5 + 0xb) * 4;\n\t\t\t\t\ttmp = RBIOS8(offset + 0x5 + 0xd);\n\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.gpio.mask = (1 << tmp);\n\t\t\t\t} else {\n\t\t\t\t\tu8 entries = RBIOS8(offset + 0x5 + 0xb);\n\t\t\t\t\tu16 voltage_table_offset = RBIOS16(offset + 0x5 + 0xc);\n\t\t\t\t\tif (entries && voltage_table_offset) {\n\t\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.gpio.reg =\n\t\t\t\t\t\t\tRBIOS16(voltage_table_offset) * 4;\n\t\t\t\t\t\ttmp = RBIOS8(voltage_table_offset + 0x2);\n\t\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.gpio.mask = (1 << tmp);\n\t\t\t\t\t} else\n\t\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.gpio.valid = false;\n\t\t\t\t}\n\t\t\t\tswitch ((misc2 & 0x700) >> 8) {\n\t\t\t\tcase 0:\n\t\t\t\tdefault:\n\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.delay = 0;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 1:\n\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.delay = 33;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.delay = 66;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 3:\n\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.delay = 99;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 4:\n\t\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.delay = 132;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else\n\t\t\t\trdev->pm.power_state[state_index].clock_info[0].voltage.type = VOLTAGE_NONE;\n\t\t\tif (rev > 6)\n\t\t\t\trdev->pm.power_state[state_index].pcie_lanes =\n\t\t\t\t\tRBIOS8(offset + 0x5 + 0x10);\n\t\t\trdev->pm.power_state[state_index].flags = RADEON_PM_STATE_SINGLE_DISPLAY_ONLY;\n\t\t\tstate_index++;\n\t\t} else {\n\t\t\t \n\t\t}\n\t} else {\n\t\t \n\t}\n\ndefault_mode:\n\t \n\trdev->pm.power_state[state_index].type =\n\t\tPOWER_STATE_TYPE_DEFAULT;\n\trdev->pm.power_state[state_index].num_clock_modes = 1;\n\trdev->pm.power_state[state_index].clock_info[0].mclk = rdev->clock.default_mclk;\n\trdev->pm.power_state[state_index].clock_info[0].sclk = rdev->clock.default_sclk;\n\trdev->pm.power_state[state_index].default_clock_mode = &rdev->pm.power_state[state_index].clock_info[0];\n\tif ((state_index > 0) &&\n\t    (rdev->pm.power_state[0].clock_info[0].voltage.type == VOLTAGE_GPIO))\n\t\trdev->pm.power_state[state_index].clock_info[0].voltage =\n\t\t\trdev->pm.power_state[0].clock_info[0].voltage;\n\telse\n\t\trdev->pm.power_state[state_index].clock_info[0].voltage.type = VOLTAGE_NONE;\n\trdev->pm.power_state[state_index].pcie_lanes = 16;\n\trdev->pm.power_state[state_index].flags = 0;\n\trdev->pm.default_power_state_index = state_index;\n\trdev->pm.num_power_states = state_index + 1;\n\n\trdev->pm.current_power_state_index = rdev->pm.default_power_state_index;\n\trdev->pm.current_clock_mode_index = 0;\n\treturn;\n\npm_failed:\n\trdev->pm.default_power_state_index = state_index;\n\trdev->pm.num_power_states = 0;\n\n\trdev->pm.current_power_state_index = rdev->pm.default_power_state_index;\n\trdev->pm.current_clock_mode_index = 0;\n}\n\nvoid radeon_external_tmds_setup(struct drm_encoder *encoder)\n{\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tstruct radeon_encoder_ext_tmds *tmds = radeon_encoder->enc_priv;\n\n\tif (!tmds)\n\t\treturn;\n\n\tswitch (tmds->dvo_chip) {\n\tcase DVO_SIL164:\n\t\t \n\t\tradeon_i2c_put_byte(tmds->i2c_bus,\n\t\t\t\t    tmds->slave_addr,\n\t\t\t\t    0x08, 0x30);\n\t\tradeon_i2c_put_byte(tmds->i2c_bus,\n\t\t\t\t       tmds->slave_addr,\n\t\t\t\t       0x09, 0x00);\n\t\tradeon_i2c_put_byte(tmds->i2c_bus,\n\t\t\t\t    tmds->slave_addr,\n\t\t\t\t    0x0a, 0x90);\n\t\tradeon_i2c_put_byte(tmds->i2c_bus,\n\t\t\t\t    tmds->slave_addr,\n\t\t\t\t    0x0c, 0x89);\n\t\tradeon_i2c_put_byte(tmds->i2c_bus,\n\t\t\t\t       tmds->slave_addr,\n\t\t\t\t       0x08, 0x3b);\n\t\tbreak;\n\tcase DVO_SIL1178:\n\t\t \n\t\t \n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n}\n\nbool radeon_combios_external_tmds_setup(struct drm_encoder *encoder)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint16_t offset;\n\tuint8_t blocks, slave_addr, rev;\n\tuint32_t index, id;\n\tuint32_t reg, val, and_mask, or_mask;\n\tstruct radeon_encoder_ext_tmds *tmds = radeon_encoder->enc_priv;\n\n\tif (!tmds)\n\t\treturn false;\n\n\tif (rdev->flags & RADEON_IS_IGP) {\n\t\toffset = combios_get_table_offset(dev, COMBIOS_TMDS_POWER_ON_TABLE);\n\t\trev = RBIOS8(offset);\n\t\tif (offset) {\n\t\t\trev = RBIOS8(offset);\n\t\t\tif (rev > 1) {\n\t\t\t\tblocks = RBIOS8(offset + 3);\n\t\t\t\tindex = offset + 4;\n\t\t\t\twhile (blocks > 0) {\n\t\t\t\t\tid = RBIOS16(index);\n\t\t\t\t\tindex += 2;\n\t\t\t\t\tswitch (id >> 13) {\n\t\t\t\t\tcase 0:\n\t\t\t\t\t\treg = (id & 0x1fff) * 4;\n\t\t\t\t\t\tval = RBIOS32(index);\n\t\t\t\t\t\tindex += 4;\n\t\t\t\t\t\tWREG32(reg, val);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 2:\n\t\t\t\t\t\treg = (id & 0x1fff) * 4;\n\t\t\t\t\t\tand_mask = RBIOS32(index);\n\t\t\t\t\t\tindex += 4;\n\t\t\t\t\t\tor_mask = RBIOS32(index);\n\t\t\t\t\t\tindex += 4;\n\t\t\t\t\t\tval = RREG32(reg);\n\t\t\t\t\t\tval = (val & and_mask) | or_mask;\n\t\t\t\t\t\tWREG32(reg, val);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 3:\n\t\t\t\t\t\tval = RBIOS16(index);\n\t\t\t\t\t\tindex += 2;\n\t\t\t\t\t\tudelay(val);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 4:\n\t\t\t\t\t\tval = RBIOS16(index);\n\t\t\t\t\t\tindex += 2;\n\t\t\t\t\t\tmdelay(val);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 6:\n\t\t\t\t\t\tslave_addr = id & 0xff;\n\t\t\t\t\t\tslave_addr >>= 1;  \n\t\t\t\t\t\tindex++;\n\t\t\t\t\t\treg = RBIOS8(index);\n\t\t\t\t\t\tindex++;\n\t\t\t\t\t\tval = RBIOS8(index);\n\t\t\t\t\t\tindex++;\n\t\t\t\t\t\tradeon_i2c_put_byte(tmds->i2c_bus,\n\t\t\t\t\t\t\t\t    slave_addr,\n\t\t\t\t\t\t\t\t    reg, val);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tDRM_ERROR(\"Unknown id %d\\n\", id >> 13);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tblocks--;\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t} else {\n\t\toffset = combios_get_table_offset(dev, COMBIOS_EXT_TMDS_INFO_TABLE);\n\t\tif (offset) {\n\t\t\tindex = offset + 10;\n\t\t\tid = RBIOS16(index);\n\t\t\twhile (id != 0xffff) {\n\t\t\t\tindex += 2;\n\t\t\t\tswitch (id >> 13) {\n\t\t\t\tcase 0:\n\t\t\t\t\treg = (id & 0x1fff) * 4;\n\t\t\t\t\tval = RBIOS32(index);\n\t\t\t\t\tWREG32(reg, val);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\treg = (id & 0x1fff) * 4;\n\t\t\t\t\tand_mask = RBIOS32(index);\n\t\t\t\t\tindex += 4;\n\t\t\t\t\tor_mask = RBIOS32(index);\n\t\t\t\t\tindex += 4;\n\t\t\t\t\tval = RREG32(reg);\n\t\t\t\t\tval = (val & and_mask) | or_mask;\n\t\t\t\t\tWREG32(reg, val);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 4:\n\t\t\t\t\tval = RBIOS16(index);\n\t\t\t\t\tindex += 2;\n\t\t\t\t\tudelay(val);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 5:\n\t\t\t\t\treg = id & 0x1fff;\n\t\t\t\t\tand_mask = RBIOS32(index);\n\t\t\t\t\tindex += 4;\n\t\t\t\t\tor_mask = RBIOS32(index);\n\t\t\t\t\tindex += 4;\n\t\t\t\t\tval = RREG32_PLL(reg);\n\t\t\t\t\tval = (val & and_mask) | or_mask;\n\t\t\t\t\tWREG32_PLL(reg, val);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 6:\n\t\t\t\t\treg = id & 0x1fff;\n\t\t\t\t\tval = RBIOS8(index);\n\t\t\t\t\tindex += 1;\n\t\t\t\t\tradeon_i2c_put_byte(tmds->i2c_bus,\n\t\t\t\t\t\t\t    tmds->slave_addr,\n\t\t\t\t\t\t\t    reg, val);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tDRM_ERROR(\"Unknown id %d\\n\", id >> 13);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tid = RBIOS16(index);\n\t\t\t}\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\nstatic void combios_parse_mmio_table(struct drm_device *dev, uint16_t offset)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\n\tif (offset) {\n\t\twhile (RBIOS16(offset)) {\n\t\t\tuint16_t cmd = ((RBIOS16(offset) & 0xe000) >> 13);\n\t\t\tuint32_t addr = (RBIOS16(offset) & 0x1fff);\n\t\t\tuint32_t val, and_mask, or_mask;\n\t\t\tuint32_t tmp;\n\n\t\t\toffset += 2;\n\t\t\tswitch (cmd) {\n\t\t\tcase 0:\n\t\t\t\tval = RBIOS32(offset);\n\t\t\t\toffset += 4;\n\t\t\t\tWREG32(addr, val);\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\t\tval = RBIOS32(offset);\n\t\t\t\toffset += 4;\n\t\t\t\tWREG32(addr, val);\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tand_mask = RBIOS32(offset);\n\t\t\t\toffset += 4;\n\t\t\t\tor_mask = RBIOS32(offset);\n\t\t\t\toffset += 4;\n\t\t\t\ttmp = RREG32(addr);\n\t\t\t\ttmp &= and_mask;\n\t\t\t\ttmp |= or_mask;\n\t\t\t\tWREG32(addr, tmp);\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tand_mask = RBIOS32(offset);\n\t\t\t\toffset += 4;\n\t\t\t\tor_mask = RBIOS32(offset);\n\t\t\t\toffset += 4;\n\t\t\t\ttmp = RREG32(addr);\n\t\t\t\ttmp &= and_mask;\n\t\t\t\ttmp |= or_mask;\n\t\t\t\tWREG32(addr, tmp);\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\t\tval = RBIOS16(offset);\n\t\t\t\toffset += 2;\n\t\t\t\tudelay(val);\n\t\t\t\tbreak;\n\t\t\tcase 5:\n\t\t\t\tval = RBIOS16(offset);\n\t\t\t\toffset += 2;\n\t\t\t\tswitch (addr) {\n\t\t\t\tcase 8:\n\t\t\t\t\twhile (val--) {\n\t\t\t\t\t\tif (!\n\t\t\t\t\t\t    (RREG32_PLL\n\t\t\t\t\t\t     (RADEON_CLK_PWRMGT_CNTL) &\n\t\t\t\t\t\t     RADEON_MC_BUSY))\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 9:\n\t\t\t\t\twhile (val--) {\n\t\t\t\t\t\tif ((RREG32(RADEON_MC_STATUS) &\n\t\t\t\t\t\t     RADEON_MC_IDLE))\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void combios_parse_pll_table(struct drm_device *dev, uint16_t offset)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\n\tif (offset) {\n\t\twhile (RBIOS8(offset)) {\n\t\t\tuint8_t cmd = ((RBIOS8(offset) & 0xc0) >> 6);\n\t\t\tuint8_t addr = (RBIOS8(offset) & 0x3f);\n\t\t\tuint32_t val, shift, tmp;\n\t\t\tuint32_t and_mask, or_mask;\n\n\t\t\toffset++;\n\t\t\tswitch (cmd) {\n\t\t\tcase 0:\n\t\t\t\tval = RBIOS32(offset);\n\t\t\t\toffset += 4;\n\t\t\t\tWREG32_PLL(addr, val);\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\t\tshift = RBIOS8(offset) * 8;\n\t\t\t\toffset++;\n\t\t\t\tand_mask = RBIOS8(offset) << shift;\n\t\t\t\tand_mask |= ~(0xff << shift);\n\t\t\t\toffset++;\n\t\t\t\tor_mask = RBIOS8(offset) << shift;\n\t\t\t\toffset++;\n\t\t\t\ttmp = RREG32_PLL(addr);\n\t\t\t\ttmp &= and_mask;\n\t\t\t\ttmp |= or_mask;\n\t\t\t\tWREG32_PLL(addr, tmp);\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\tcase 3:\n\t\t\t\ttmp = 1000;\n\t\t\t\tswitch (addr) {\n\t\t\t\tcase 1:\n\t\t\t\t\tudelay(150);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\tmdelay(1);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 3:\n\t\t\t\t\twhile (tmp--) {\n\t\t\t\t\t\tif (!\n\t\t\t\t\t\t    (RREG32_PLL\n\t\t\t\t\t\t     (RADEON_CLK_PWRMGT_CNTL) &\n\t\t\t\t\t\t     RADEON_MC_BUSY))\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 4:\n\t\t\t\t\twhile (tmp--) {\n\t\t\t\t\t\tif (RREG32_PLL\n\t\t\t\t\t\t    (RADEON_CLK_PWRMGT_CNTL) &\n\t\t\t\t\t\t    RADEON_DLL_READY)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 5:\n\t\t\t\t\ttmp =\n\t\t\t\t\t    RREG32_PLL(RADEON_CLK_PWRMGT_CNTL);\n\t\t\t\t\tif (tmp & RADEON_CG_NO1_DEBUG_0) {\n#if 0\n\t\t\t\t\t\tuint32_t mclk_cntl =\n\t\t\t\t\t\t    RREG32_PLL\n\t\t\t\t\t\t    (RADEON_MCLK_CNTL);\n\t\t\t\t\t\tmclk_cntl &= 0xffff0000;\n\t\t\t\t\t\t \n\n\t \n\twhile (ram--) {\n\t\taddr = ram * 1024 * 1024;\n\t\t \n\t\tWREG32_IDX((addr) | RADEON_MM_APER, 0xdeadbeef);\n\t\t \n\t\tif (RREG32_IDX((addr) | RADEON_MM_APER) != 0xdeadbeef)\n\t\t\treturn 0;\n\t}\n\n\treturn mem_size;\n}\n\nstatic void combios_write_ram_size(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint8_t rev;\n\tuint16_t offset;\n\tuint32_t mem_size = 0;\n\tuint32_t mem_cntl = 0;\n\n\t \n\tif (rdev->flags & RADEON_IS_IGP)\n\t\treturn;\n\n\t \n\toffset = combios_get_table_offset(dev, COMBIOS_DETECTED_MEM_TABLE);\n\tif (offset) {\n\t\trev = RBIOS8(offset);\n\t\tif (rev < 3) {\n\t\t\tmem_cntl = RBIOS32(offset + 1);\n\t\t\tmem_size = RBIOS16(offset + 5);\n\t\t\tif ((rdev->family < CHIP_R200) &&\n\t\t\t    !ASIC_IS_RN50(rdev))\n\t\t\t\tWREG32(RADEON_MEM_CNTL, mem_cntl);\n\t\t}\n\t}\n\n\tif (!mem_size) {\n\t\toffset =\n\t\t    combios_get_table_offset(dev, COMBIOS_MEM_CONFIG_TABLE);\n\t\tif (offset) {\n\t\t\trev = RBIOS8(offset - 1);\n\t\t\tif (rev < 1) {\n\t\t\t\tif ((rdev->family < CHIP_R200)\n\t\t\t\t    && !ASIC_IS_RN50(rdev)) {\n\t\t\t\t\tint ram = 0;\n\t\t\t\t\tint mem_addr_mapping = 0;\n\n\t\t\t\t\twhile (RBIOS8(offset)) {\n\t\t\t\t\t\tram = RBIOS8(offset);\n\t\t\t\t\t\tmem_addr_mapping =\n\t\t\t\t\t\t    RBIOS8(offset + 1);\n\t\t\t\t\t\tif (mem_addr_mapping != 0x25)\n\t\t\t\t\t\t\tram *= 2;\n\t\t\t\t\t\tmem_size =\n\t\t\t\t\t\t    combios_detect_ram(dev, ram,\n\t\t\t\t\t\t\t\t       mem_addr_mapping);\n\t\t\t\t\t\tif (mem_size)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\toffset += 2;\n\t\t\t\t\t}\n\t\t\t\t} else\n\t\t\t\t\tmem_size = RBIOS8(offset);\n\t\t\t} else {\n\t\t\t\tmem_size = RBIOS8(offset);\n\t\t\t\tmem_size *= 2;\t \n\t\t\t}\n\t\t}\n\t}\n\n\tmem_size *= (1024 * 1024);\t \n\tWREG32(RADEON_CONFIG_MEMSIZE, mem_size);\n}\n\nvoid radeon_combios_asic_init(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint16_t table;\n\n\t \n\tif (rdev->bios == NULL)\n\t\treturn;\n\n\t \n\ttable = combios_get_table_offset(dev, COMBIOS_ASIC_INIT_1_TABLE);\n\tif (table)\n\t\tcombios_parse_mmio_table(dev, table);\n\n\t \n\ttable = combios_get_table_offset(dev, COMBIOS_PLL_INIT_TABLE);\n\tif (table)\n\t\tcombios_parse_pll_table(dev, table);\n\n\t \n\ttable = combios_get_table_offset(dev, COMBIOS_ASIC_INIT_2_TABLE);\n\tif (table)\n\t\tcombios_parse_mmio_table(dev, table);\n\n\tif (!(rdev->flags & RADEON_IS_IGP)) {\n\t\t \n\t\ttable =\n\t\t    combios_get_table_offset(dev, COMBIOS_ASIC_INIT_4_TABLE);\n\t\tif (table)\n\t\t\tcombios_parse_mmio_table(dev, table);\n\n\t\t \n\t\ttable = combios_get_table_offset(dev, COMBIOS_RAM_RESET_TABLE);\n\t\tif (table)\n\t\t\tcombios_parse_ram_reset_table(dev, table);\n\n\t\t \n\t\ttable =\n\t\t    combios_get_table_offset(dev, COMBIOS_ASIC_INIT_3_TABLE);\n\t\tif (table)\n\t\t\tcombios_parse_mmio_table(dev, table);\n\n\t\t \n\t\tcombios_write_ram_size(dev);\n\t}\n\n\t \n\tif (rdev->family == CHIP_RS480 &&\n\t    rdev->pdev->subsystem_vendor == 0x103c &&\n\t    rdev->pdev->subsystem_device == 0x308b)\n\t\treturn;\n\n\t \n\tif (rdev->family == CHIP_RS480 &&\n\t    rdev->pdev->subsystem_vendor == 0x103c &&\n\t    rdev->pdev->subsystem_device == 0x30a4)\n\t\treturn;\n\n\t \n\tif (rdev->family == CHIP_RS480 &&\n\t    rdev->pdev->subsystem_vendor == 0x103c &&\n\t    rdev->pdev->subsystem_device == 0x30ae)\n\t\treturn;\n\n\t \n\tif (rdev->family == CHIP_RS480 &&\n\t    rdev->pdev->subsystem_vendor == 0x103c &&\n\t    rdev->pdev->subsystem_device == 0x280a)\n\t\treturn;\n\t \n\tif (rdev->family == CHIP_RS400 &&\n\t    rdev->pdev->subsystem_vendor == 0x1179 &&\n\t    rdev->pdev->subsystem_device == 0xff31)\n\t        return;\n\n\t \n\ttable = combios_get_table_offset(dev, COMBIOS_DYN_CLK_1_TABLE);\n\tif (table)\n\t\tcombios_parse_pll_table(dev, table);\n\n}\n\nvoid radeon_combios_initialize_bios_scratch_regs(struct drm_device *dev)\n{\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t bios_0_scratch, bios_6_scratch, bios_7_scratch;\n\n\tbios_0_scratch = RREG32(RADEON_BIOS_0_SCRATCH);\n\tbios_6_scratch = RREG32(RADEON_BIOS_6_SCRATCH);\n\tbios_7_scratch = RREG32(RADEON_BIOS_7_SCRATCH);\n\n\t \n\tbios_0_scratch &= ~RADEON_DRIVER_BRIGHTNESS_EN;\n\n\t \n\tbios_6_scratch |= (RADEON_DISPLAY_SWITCHING_DIS |\n\t\t\t   RADEON_ACC_MODE_CHANGE);\n\n\t \n\tbios_7_scratch |= RADEON_DRV_LOADED;\n\n\tWREG32(RADEON_BIOS_0_SCRATCH, bios_0_scratch);\n\tWREG32(RADEON_BIOS_6_SCRATCH, bios_6_scratch);\n\tWREG32(RADEON_BIOS_7_SCRATCH, bios_7_scratch);\n}\n\nvoid radeon_combios_output_lock(struct drm_encoder *encoder, bool lock)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t bios_6_scratch;\n\n\tbios_6_scratch = RREG32(RADEON_BIOS_6_SCRATCH);\n\n\tif (lock)\n\t\tbios_6_scratch |= RADEON_DRIVER_CRITICAL;\n\telse\n\t\tbios_6_scratch &= ~RADEON_DRIVER_CRITICAL;\n\n\tWREG32(RADEON_BIOS_6_SCRATCH, bios_6_scratch);\n}\n\nvoid\nradeon_combios_connected_scratch_regs(struct drm_connector *connector,\n\t\t\t\t      struct drm_encoder *encoder,\n\t\t\t\t      bool connected)\n{\n\tstruct drm_device *dev = connector->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_connector *radeon_connector =\n\t    to_radeon_connector(connector);\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint32_t bios_4_scratch = RREG32(RADEON_BIOS_4_SCRATCH);\n\tuint32_t bios_5_scratch = RREG32(RADEON_BIOS_5_SCRATCH);\n\n\tif ((radeon_encoder->devices & ATOM_DEVICE_TV1_SUPPORT) &&\n\t    (radeon_connector->devices & ATOM_DEVICE_TV1_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"TV1 connected\\n\");\n\t\t\t \n\t\t\tbios_4_scratch |= RADEON_TV1_ATTACHED_SVIDEO;\n\t\t\t \n\t\t\tbios_5_scratch |= RADEON_TV1_ON;\n\t\t\tbios_5_scratch |= RADEON_ACC_REQ_TV1;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"TV1 disconnected\\n\");\n\t\t\tbios_4_scratch &= ~RADEON_TV1_ATTACHED_MASK;\n\t\t\tbios_5_scratch &= ~RADEON_TV1_ON;\n\t\t\tbios_5_scratch &= ~RADEON_ACC_REQ_TV1;\n\t\t}\n\t}\n\tif ((radeon_encoder->devices & ATOM_DEVICE_LCD1_SUPPORT) &&\n\t    (radeon_connector->devices & ATOM_DEVICE_LCD1_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"LCD1 connected\\n\");\n\t\t\tbios_4_scratch |= RADEON_LCD1_ATTACHED;\n\t\t\tbios_5_scratch |= RADEON_LCD1_ON;\n\t\t\tbios_5_scratch |= RADEON_ACC_REQ_LCD1;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"LCD1 disconnected\\n\");\n\t\t\tbios_4_scratch &= ~RADEON_LCD1_ATTACHED;\n\t\t\tbios_5_scratch &= ~RADEON_LCD1_ON;\n\t\t\tbios_5_scratch &= ~RADEON_ACC_REQ_LCD1;\n\t\t}\n\t}\n\tif ((radeon_encoder->devices & ATOM_DEVICE_CRT1_SUPPORT) &&\n\t    (radeon_connector->devices & ATOM_DEVICE_CRT1_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"CRT1 connected\\n\");\n\t\t\tbios_4_scratch |= RADEON_CRT1_ATTACHED_COLOR;\n\t\t\tbios_5_scratch |= RADEON_CRT1_ON;\n\t\t\tbios_5_scratch |= RADEON_ACC_REQ_CRT1;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"CRT1 disconnected\\n\");\n\t\t\tbios_4_scratch &= ~RADEON_CRT1_ATTACHED_MASK;\n\t\t\tbios_5_scratch &= ~RADEON_CRT1_ON;\n\t\t\tbios_5_scratch &= ~RADEON_ACC_REQ_CRT1;\n\t\t}\n\t}\n\tif ((radeon_encoder->devices & ATOM_DEVICE_CRT2_SUPPORT) &&\n\t    (radeon_connector->devices & ATOM_DEVICE_CRT2_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"CRT2 connected\\n\");\n\t\t\tbios_4_scratch |= RADEON_CRT2_ATTACHED_COLOR;\n\t\t\tbios_5_scratch |= RADEON_CRT2_ON;\n\t\t\tbios_5_scratch |= RADEON_ACC_REQ_CRT2;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"CRT2 disconnected\\n\");\n\t\t\tbios_4_scratch &= ~RADEON_CRT2_ATTACHED_MASK;\n\t\t\tbios_5_scratch &= ~RADEON_CRT2_ON;\n\t\t\tbios_5_scratch &= ~RADEON_ACC_REQ_CRT2;\n\t\t}\n\t}\n\tif ((radeon_encoder->devices & ATOM_DEVICE_DFP1_SUPPORT) &&\n\t    (radeon_connector->devices & ATOM_DEVICE_DFP1_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"DFP1 connected\\n\");\n\t\t\tbios_4_scratch |= RADEON_DFP1_ATTACHED;\n\t\t\tbios_5_scratch |= RADEON_DFP1_ON;\n\t\t\tbios_5_scratch |= RADEON_ACC_REQ_DFP1;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"DFP1 disconnected\\n\");\n\t\t\tbios_4_scratch &= ~RADEON_DFP1_ATTACHED;\n\t\t\tbios_5_scratch &= ~RADEON_DFP1_ON;\n\t\t\tbios_5_scratch &= ~RADEON_ACC_REQ_DFP1;\n\t\t}\n\t}\n\tif ((radeon_encoder->devices & ATOM_DEVICE_DFP2_SUPPORT) &&\n\t    (radeon_connector->devices & ATOM_DEVICE_DFP2_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"DFP2 connected\\n\");\n\t\t\tbios_4_scratch |= RADEON_DFP2_ATTACHED;\n\t\t\tbios_5_scratch |= RADEON_DFP2_ON;\n\t\t\tbios_5_scratch |= RADEON_ACC_REQ_DFP2;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"DFP2 disconnected\\n\");\n\t\t\tbios_4_scratch &= ~RADEON_DFP2_ATTACHED;\n\t\t\tbios_5_scratch &= ~RADEON_DFP2_ON;\n\t\t\tbios_5_scratch &= ~RADEON_ACC_REQ_DFP2;\n\t\t}\n\t}\n\tWREG32(RADEON_BIOS_4_SCRATCH, bios_4_scratch);\n\tWREG32(RADEON_BIOS_5_SCRATCH, bios_5_scratch);\n}\n\nvoid\nradeon_combios_encoder_crtc_scratch_regs(struct drm_encoder *encoder, int crtc)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint32_t bios_5_scratch = RREG32(RADEON_BIOS_5_SCRATCH);\n\n\tif (radeon_encoder->devices & ATOM_DEVICE_TV1_SUPPORT) {\n\t\tbios_5_scratch &= ~RADEON_TV1_CRTC_MASK;\n\t\tbios_5_scratch |= (crtc << RADEON_TV1_CRTC_SHIFT);\n\t}\n\tif (radeon_encoder->devices & ATOM_DEVICE_CRT1_SUPPORT) {\n\t\tbios_5_scratch &= ~RADEON_CRT1_CRTC_MASK;\n\t\tbios_5_scratch |= (crtc << RADEON_CRT1_CRTC_SHIFT);\n\t}\n\tif (radeon_encoder->devices & ATOM_DEVICE_CRT2_SUPPORT) {\n\t\tbios_5_scratch &= ~RADEON_CRT2_CRTC_MASK;\n\t\tbios_5_scratch |= (crtc << RADEON_CRT2_CRTC_SHIFT);\n\t}\n\tif (radeon_encoder->devices & ATOM_DEVICE_LCD1_SUPPORT) {\n\t\tbios_5_scratch &= ~RADEON_LCD1_CRTC_MASK;\n\t\tbios_5_scratch |= (crtc << RADEON_LCD1_CRTC_SHIFT);\n\t}\n\tif (radeon_encoder->devices & ATOM_DEVICE_DFP1_SUPPORT) {\n\t\tbios_5_scratch &= ~RADEON_DFP1_CRTC_MASK;\n\t\tbios_5_scratch |= (crtc << RADEON_DFP1_CRTC_SHIFT);\n\t}\n\tif (radeon_encoder->devices & ATOM_DEVICE_DFP2_SUPPORT) {\n\t\tbios_5_scratch &= ~RADEON_DFP2_CRTC_MASK;\n\t\tbios_5_scratch |= (crtc << RADEON_DFP2_CRTC_SHIFT);\n\t}\n\tWREG32(RADEON_BIOS_5_SCRATCH, bios_5_scratch);\n}\n\nvoid\nradeon_combios_encoder_dpms_scratch_regs(struct drm_encoder *encoder, bool on)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tuint32_t bios_6_scratch = RREG32(RADEON_BIOS_6_SCRATCH);\n\n\tif (radeon_encoder->devices & (ATOM_DEVICE_TV_SUPPORT)) {\n\t\tif (on)\n\t\t\tbios_6_scratch |= RADEON_TV_DPMS_ON;\n\t\telse\n\t\t\tbios_6_scratch &= ~RADEON_TV_DPMS_ON;\n\t}\n\tif (radeon_encoder->devices & (ATOM_DEVICE_CRT_SUPPORT)) {\n\t\tif (on)\n\t\t\tbios_6_scratch |= RADEON_CRT_DPMS_ON;\n\t\telse\n\t\t\tbios_6_scratch &= ~RADEON_CRT_DPMS_ON;\n\t}\n\tif (radeon_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT)) {\n\t\tif (on)\n\t\t\tbios_6_scratch |= RADEON_LCD_DPMS_ON;\n\t\telse\n\t\t\tbios_6_scratch &= ~RADEON_LCD_DPMS_ON;\n\t}\n\tif (radeon_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\n\t\tif (on)\n\t\t\tbios_6_scratch |= RADEON_DFP_DPMS_ON;\n\t\telse\n\t\t\tbios_6_scratch &= ~RADEON_DFP_DPMS_ON;\n\t}\n\tWREG32(RADEON_BIOS_6_SCRATCH, bios_6_scratch);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}