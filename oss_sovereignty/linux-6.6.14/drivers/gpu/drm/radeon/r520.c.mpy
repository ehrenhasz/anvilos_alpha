{
  "module_name": "r520.c",
  "hash_id": "ea28ae7f185c3441d667937a00b0613dd542012899ad8825a649da7489975b81",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/r520.c",
  "human_readable_source": " \n\n#include \"radeon.h\"\n#include \"radeon_asic.h\"\n#include \"atom.h\"\n#include \"r520d.h\"\n\n \n\nint r520_mc_wait_for_idle(struct radeon_device *rdev)\n{\n\tunsigned i;\n\tuint32_t tmp;\n\n\tfor (i = 0; i < rdev->usec_timeout; i++) {\n\t\t \n\t\ttmp = RREG32_MC(R520_MC_STATUS);\n\t\tif (tmp & R520_MC_STATUS_IDLE) {\n\t\t\treturn 0;\n\t\t}\n\t\tudelay(1);\n\t}\n\treturn -1;\n}\n\nstatic void r520_gpu_init(struct radeon_device *rdev)\n{\n\tunsigned pipe_select_current, gb_pipe_select, tmp;\n\n\trv515_vga_render_disable(rdev);\n\t \n\t \n\tif (rdev->family == CHIP_RV530) {\n\t\tWREG32(0x4128, 0xFF);\n\t}\n\tr420_pipes_init(rdev);\n\tgb_pipe_select = RREG32(R400_GB_PIPE_SELECT);\n\ttmp = RREG32(R300_DST_PIPE_CONFIG);\n\tpipe_select_current = (tmp >> 2) & 3;\n\ttmp = (1 << pipe_select_current) |\n\t      (((gb_pipe_select >> 8) & 0xF) << 4);\n\tWREG32_PLL(0x000D, tmp);\n\tif (r520_mc_wait_for_idle(rdev)) {\n\t\tpr_warn(\"Failed to wait MC idle while programming pipes. Bad things might happen.\\n\");\n\t}\n}\n\nstatic void r520_vram_get_type(struct radeon_device *rdev)\n{\n\tuint32_t tmp;\n\n\trdev->mc.vram_width = 128;\n\trdev->mc.vram_is_ddr = true;\n\ttmp = RREG32_MC(R520_MC_CNTL0);\n\tswitch ((tmp & R520_MEM_NUM_CHANNELS_MASK) >> R520_MEM_NUM_CHANNELS_SHIFT) {\n\tcase 0:\n\t\trdev->mc.vram_width = 32;\n\t\tbreak;\n\tcase 1:\n\t\trdev->mc.vram_width = 64;\n\t\tbreak;\n\tcase 2:\n\t\trdev->mc.vram_width = 128;\n\t\tbreak;\n\tcase 3:\n\t\trdev->mc.vram_width = 256;\n\t\tbreak;\n\tdefault:\n\t\trdev->mc.vram_width = 128;\n\t\tbreak;\n\t}\n\tif (tmp & R520_MC_CHANNEL_SIZE)\n\t\trdev->mc.vram_width *= 2;\n}\n\nstatic void r520_mc_init(struct radeon_device *rdev)\n{\n\n\tr520_vram_get_type(rdev);\n\tr100_vram_init_sizes(rdev);\n\tradeon_vram_location(rdev, &rdev->mc, 0);\n\trdev->mc.gtt_base_align = 0;\n\tif (!(rdev->flags & RADEON_IS_AGP))\n\t\tradeon_gtt_location(rdev, &rdev->mc);\n\tradeon_update_bandwidth_info(rdev);\n}\n\nstatic void r520_mc_program(struct radeon_device *rdev)\n{\n\tstruct rv515_mc_save save;\n\n\t \n\trv515_mc_stop(rdev, &save);\n\n\t \n\tif (r520_mc_wait_for_idle(rdev))\n\t\tdev_warn(rdev->dev, \"Wait MC idle timeout before updating MC.\\n\");\n\t \n\tWREG32(R_0000F8_CONFIG_MEMSIZE, rdev->mc.real_vram_size);\n\t \n\tWREG32_MC(R_000004_MC_FB_LOCATION,\n\t\t\tS_000004_MC_FB_START(rdev->mc.vram_start >> 16) |\n\t\t\tS_000004_MC_FB_TOP(rdev->mc.vram_end >> 16));\n\tWREG32(R_000134_HDP_FB_LOCATION,\n\t\tS_000134_HDP_FB_START(rdev->mc.vram_start >> 16));\n\tif (rdev->flags & RADEON_IS_AGP) {\n\t\tWREG32_MC(R_000005_MC_AGP_LOCATION,\n\t\t\tS_000005_MC_AGP_START(rdev->mc.gtt_start >> 16) |\n\t\t\tS_000005_MC_AGP_TOP(rdev->mc.gtt_end >> 16));\n\t\tWREG32_MC(R_000006_AGP_BASE, lower_32_bits(rdev->mc.agp_base));\n\t\tWREG32_MC(R_000007_AGP_BASE_2,\n\t\t\tS_000007_AGP_BASE_ADDR_2(upper_32_bits(rdev->mc.agp_base)));\n\t} else {\n\t\tWREG32_MC(R_000005_MC_AGP_LOCATION, 0xFFFFFFFF);\n\t\tWREG32_MC(R_000006_AGP_BASE, 0);\n\t\tWREG32_MC(R_000007_AGP_BASE_2, 0);\n\t}\n\n\trv515_mc_resume(rdev, &save);\n}\n\nstatic int r520_startup(struct radeon_device *rdev)\n{\n\tint r;\n\n\tr520_mc_program(rdev);\n\t \n\trv515_clock_startup(rdev);\n\t \n\tr520_gpu_init(rdev);\n\t \n\tif (rdev->flags & RADEON_IS_PCIE) {\n\t\tr = rv370_pcie_gart_enable(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\n\t \n\tr = radeon_wb_init(rdev);\n\tif (r)\n\t\treturn r;\n\n\tr = radeon_fence_driver_start_ring(rdev, RADEON_RING_TYPE_GFX_INDEX);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed initializing CP fences (%d).\\n\", r);\n\t\treturn r;\n\t}\n\n\t \n\tif (!rdev->irq.installed) {\n\t\tr = radeon_irq_kms_init(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\n\trs600_irq_set(rdev);\n\trdev->config.r300.hdp_cntl = RREG32(RADEON_HOST_PATH_CNTL);\n\t \n\tr = r100_cp_init(rdev, 1024 * 1024);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed initializing CP (%d).\\n\", r);\n\t\treturn r;\n\t}\n\n\tr = radeon_ib_pool_init(rdev);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"IB initialization failed (%d).\\n\", r);\n\t\treturn r;\n\t}\n\n\treturn 0;\n}\n\nint r520_resume(struct radeon_device *rdev)\n{\n\tint r;\n\n\t \n\tif (rdev->flags & RADEON_IS_PCIE)\n\t\trv370_pcie_gart_disable(rdev);\n\t \n\trv515_clock_startup(rdev);\n\t \n\tif (radeon_asic_reset(rdev)) {\n\t\tdev_warn(rdev->dev, \"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\\n\",\n\t\t\tRREG32(R_000E40_RBBM_STATUS),\n\t\t\tRREG32(R_0007C0_CP_STAT));\n\t}\n\t \n\tatom_asic_init(rdev->mode_info.atom_context);\n\t \n\trv515_clock_startup(rdev);\n\t \n\tradeon_surface_init(rdev);\n\n\trdev->accel_working = true;\n\tr = r520_startup(rdev);\n\tif (r) {\n\t\trdev->accel_working = false;\n\t}\n\treturn r;\n}\n\nint r520_init(struct radeon_device *rdev)\n{\n\tint r;\n\n\t \n\tradeon_scratch_init(rdev);\n\t \n\tradeon_surface_init(rdev);\n\t \n\tr100_restore_sanity(rdev);\n\t \n\t \n\tif (!radeon_get_bios(rdev)) {\n\t\tif (ASIC_IS_AVIVO(rdev))\n\t\t\treturn -EINVAL;\n\t}\n\tif (rdev->is_atom_bios) {\n\t\tr = radeon_atombios_init(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t} else {\n\t\tdev_err(rdev->dev, \"Expecting atombios for RV515 GPU\\n\");\n\t\treturn -EINVAL;\n\t}\n\t \n\tif (radeon_asic_reset(rdev)) {\n\t\tdev_warn(rdev->dev,\n\t\t\t\"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\\n\",\n\t\t\tRREG32(R_000E40_RBBM_STATUS),\n\t\t\tRREG32(R_0007C0_CP_STAT));\n\t}\n\t \n\tif (radeon_boot_test_post_card(rdev) == false)\n\t\treturn -EINVAL;\n\n\tif (!radeon_card_posted(rdev) && rdev->bios) {\n\t\tDRM_INFO(\"GPU not posted. posting now...\\n\");\n\t\tatom_asic_init(rdev->mode_info.atom_context);\n\t}\n\t \n\tradeon_get_clock_info(rdev->ddev);\n\t \n\tif (rdev->flags & RADEON_IS_AGP) {\n\t\tr = radeon_agp_init(rdev);\n\t\tif (r) {\n\t\t\tradeon_agp_disable(rdev);\n\t\t}\n\t}\n\t \n\tr520_mc_init(rdev);\n\trv515_debugfs(rdev);\n\t \n\tradeon_fence_driver_init(rdev);\n\t \n\tr = radeon_bo_init(rdev);\n\tif (r)\n\t\treturn r;\n\tr = rv370_pcie_gart_init(rdev);\n\tif (r)\n\t\treturn r;\n\trv515_set_safe_registers(rdev);\n\n\t \n\tradeon_pm_init(rdev);\n\n\trdev->accel_working = true;\n\tr = r520_startup(rdev);\n\tif (r) {\n\t\t \n\t\tdev_err(rdev->dev, \"Disabling GPU acceleration\\n\");\n\t\tr100_cp_fini(rdev);\n\t\tradeon_wb_fini(rdev);\n\t\tradeon_ib_pool_fini(rdev);\n\t\tradeon_irq_kms_fini(rdev);\n\t\trv370_pcie_gart_fini(rdev);\n\t\tradeon_agp_fini(rdev);\n\t\trdev->accel_working = false;\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}