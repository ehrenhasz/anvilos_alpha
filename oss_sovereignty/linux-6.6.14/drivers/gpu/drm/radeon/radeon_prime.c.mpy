{
  "module_name": "radeon_prime.c",
  "hash_id": "d7d3f7826aa6e5e6671dda3bd62398235b77dde1643b02bb9db07e2407c9234e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/radeon_prime.c",
  "human_readable_source": " \n\n#include <linux/dma-buf.h>\n\n#include <drm/drm_prime.h>\n#include <drm/radeon_drm.h>\n\n#include <drm/ttm/ttm_tt.h>\n\n#include \"radeon.h\"\n#include \"radeon_prime.h\"\n\nstruct sg_table *radeon_gem_prime_get_sg_table(struct drm_gem_object *obj)\n{\n\tstruct radeon_bo *bo = gem_to_radeon_bo(obj);\n\n\treturn drm_prime_pages_to_sg(obj->dev, bo->tbo.ttm->pages,\n\t\t\t\t     bo->tbo.ttm->num_pages);\n}\n\nstruct drm_gem_object *radeon_gem_prime_import_sg_table(struct drm_device *dev,\n\t\t\t\t\t\t\tstruct dma_buf_attachment *attach,\n\t\t\t\t\t\t\tstruct sg_table *sg)\n{\n\tstruct dma_resv *resv = attach->dmabuf->resv;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_bo *bo;\n\tint ret;\n\n\tdma_resv_lock(resv, NULL);\n\tret = radeon_bo_create(rdev, attach->dmabuf->size, PAGE_SIZE, false,\n\t\t\t       RADEON_GEM_DOMAIN_GTT, 0, sg, resv, &bo);\n\tdma_resv_unlock(resv);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\tbo->tbo.base.funcs = &radeon_gem_object_funcs;\n\n\tmutex_lock(&rdev->gem.mutex);\n\tlist_add_tail(&bo->list, &rdev->gem.objects);\n\tmutex_unlock(&rdev->gem.mutex);\n\n\tbo->prime_shared_count = 1;\n\treturn &bo->tbo.base;\n}\n\nint radeon_gem_prime_pin(struct drm_gem_object *obj)\n{\n\tstruct radeon_bo *bo = gem_to_radeon_bo(obj);\n\tint ret = 0;\n\n\tret = radeon_bo_reserve(bo, false);\n\tif (unlikely(ret != 0))\n\t\treturn ret;\n\n\t \n\tret = radeon_bo_pin(bo, RADEON_GEM_DOMAIN_GTT, NULL);\n\tif (likely(ret == 0))\n\t\tbo->prime_shared_count++;\n\n\tradeon_bo_unreserve(bo);\n\treturn ret;\n}\n\nvoid radeon_gem_prime_unpin(struct drm_gem_object *obj)\n{\n\tstruct radeon_bo *bo = gem_to_radeon_bo(obj);\n\tint ret = 0;\n\n\tret = radeon_bo_reserve(bo, false);\n\tif (unlikely(ret != 0))\n\t\treturn;\n\n\tradeon_bo_unpin(bo);\n\tif (bo->prime_shared_count)\n\t\tbo->prime_shared_count--;\n\tradeon_bo_unreserve(bo);\n}\n\n\nstruct dma_buf *radeon_gem_prime_export(struct drm_gem_object *gobj,\n\t\t\t\t\tint flags)\n{\n\tstruct radeon_bo *bo = gem_to_radeon_bo(gobj);\n\tif (radeon_ttm_tt_has_userptr(bo->rdev, bo->tbo.ttm))\n\t\treturn ERR_PTR(-EPERM);\n\treturn drm_gem_prime_export(gobj, flags);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}