{
  "module_name": "rv770.c",
  "hash_id": "a240192a646e31b25485d0cd811595798f47aeb8b7bf0e76a37a3f3dceca8520",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/rv770.c",
  "human_readable_source": " \n\n#include <linux/firmware.h>\n#include <linux/pci.h>\n#include <linux/slab.h>\n\n#include <drm/drm_device.h>\n#include <drm/radeon_drm.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n\n#include \"atom.h\"\n#include \"avivod.h\"\n#include \"radeon.h\"\n#include \"radeon_asic.h\"\n#include \"radeon_audio.h\"\n#include \"rv770d.h\"\n#include \"rv770.h\"\n\n#define R700_PFP_UCODE_SIZE 848\n#define R700_PM4_UCODE_SIZE 1360\n\nstatic void rv770_gpu_init(struct radeon_device *rdev);\nvoid rv770_fini(struct radeon_device *rdev);\nstatic void rv770_pcie_gen2_enable(struct radeon_device *rdev);\nint evergreen_set_uvd_clocks(struct radeon_device *rdev, u32 vclk, u32 dclk);\n\nint rv770_set_uvd_clocks(struct radeon_device *rdev, u32 vclk, u32 dclk)\n{\n\tunsigned fb_div = 0, vclk_div = 0, dclk_div = 0;\n\tint r;\n\n\t \n\tif (rdev->family == CHIP_RV740)\n\t\treturn evergreen_set_uvd_clocks(rdev, vclk, dclk);\n\n\t \n\tWREG32_P(CG_UPLL_FUNC_CNTL_2,\n\t\t VCLK_SRC_SEL(1) | DCLK_SRC_SEL(1),\n\t\t ~(VCLK_SRC_SEL_MASK | DCLK_SRC_SEL_MASK));\n\n\tif (!vclk || !dclk) {\n\t\t \n\t\tWREG32_P(CG_UPLL_FUNC_CNTL, UPLL_SLEEP_MASK, ~UPLL_SLEEP_MASK);\n\t\treturn 0;\n\t}\n\n\tr = radeon_uvd_calc_upll_dividers(rdev, vclk, dclk, 50000, 160000,\n\t\t\t\t\t  43663, 0x03FFFFFE, 1, 30, ~0,\n\t\t\t\t\t  &fb_div, &vclk_div, &dclk_div);\n\tif (r)\n\t\treturn r;\n\n\tfb_div |= 1;\n\tvclk_div -= 1;\n\tdclk_div -= 1;\n\n\t \n\tWREG32_P(CG_UPLL_FUNC_CNTL_3, UPLL_FB_DIV(0x50000), ~UPLL_FB_DIV_MASK);\n\n\t \n\tWREG32_P(CG_UPLL_FUNC_CNTL, 0, ~(UPLL_RESET_MASK | UPLL_SLEEP_MASK));\n\n\t \n\tWREG32_P(CG_UPLL_FUNC_CNTL, UPLL_BYPASS_EN_MASK, ~UPLL_BYPASS_EN_MASK);\n\tWREG32_P(CG_UPLL_FUNC_CNTL_3, UPLL_FB_DIV(1), ~UPLL_FB_DIV(1));\n\n\tr = radeon_uvd_send_upll_ctlreq(rdev, CG_UPLL_FUNC_CNTL);\n\tif (r)\n\t\treturn r;\n\n\t \n\tWREG32_P(CG_UPLL_FUNC_CNTL, UPLL_RESET_MASK, ~UPLL_RESET_MASK);\n\n\t \n\tWREG32_P(CG_UPLL_FUNC_CNTL, UPLL_REF_DIV(1), ~UPLL_REF_DIV_MASK);\n\tWREG32_P(CG_UPLL_FUNC_CNTL_2,\n\t\t UPLL_SW_HILEN(vclk_div >> 1) |\n\t\t UPLL_SW_LOLEN((vclk_div >> 1) + (vclk_div & 1)) |\n\t\t UPLL_SW_HILEN2(dclk_div >> 1) |\n\t\t UPLL_SW_LOLEN2((dclk_div >> 1) + (dclk_div & 1)),\n\t\t ~UPLL_SW_MASK);\n\n\tWREG32_P(CG_UPLL_FUNC_CNTL_3, UPLL_FB_DIV(fb_div),\n\t\t ~UPLL_FB_DIV_MASK);\n\n\t \n\tmdelay(15);\n\n\t \n\tWREG32_P(CG_UPLL_FUNC_CNTL, 0, ~UPLL_RESET_MASK);\n\n\tmdelay(15);\n\n\t \n\tWREG32_P(CG_UPLL_FUNC_CNTL, 0, ~UPLL_BYPASS_EN_MASK);\n\tWREG32_P(CG_UPLL_FUNC_CNTL_3, 0, ~UPLL_FB_DIV(1));\n\n\tr = radeon_uvd_send_upll_ctlreq(rdev, CG_UPLL_FUNC_CNTL);\n\tif (r)\n\t\treturn r;\n\n\t \n\tWREG32_P(CG_UPLL_FUNC_CNTL_2,\n\t\t VCLK_SRC_SEL(2) | DCLK_SRC_SEL(2),\n\t\t ~(VCLK_SRC_SEL_MASK | DCLK_SRC_SEL_MASK));\n\n\tmdelay(100);\n\n\treturn 0;\n}\n\nstatic const u32 r7xx_golden_registers[] = {\n\t0x8d00, 0xffffffff, 0x0e0e0074,\n\t0x8d04, 0xffffffff, 0x013a2b34,\n\t0x9508, 0xffffffff, 0x00000002,\n\t0x8b20, 0xffffffff, 0,\n\t0x88c4, 0xffffffff, 0x000000c2,\n\t0x28350, 0xffffffff, 0,\n\t0x9058, 0xffffffff, 0x0fffc40f,\n\t0x240c, 0xffffffff, 0x00000380,\n\t0x733c, 0xffffffff, 0x00000002,\n\t0x2650, 0x00040000, 0,\n\t0x20bc, 0x00040000, 0,\n\t0x7300, 0xffffffff, 0x001000f0\n};\n\nstatic const u32 r7xx_golden_dyn_gpr_registers[] = {\n\t0x8db0, 0xffffffff, 0x98989898,\n\t0x8db4, 0xffffffff, 0x98989898,\n\t0x8db8, 0xffffffff, 0x98989898,\n\t0x8dbc, 0xffffffff, 0x98989898,\n\t0x8dc0, 0xffffffff, 0x98989898,\n\t0x8dc4, 0xffffffff, 0x98989898,\n\t0x8dc8, 0xffffffff, 0x98989898,\n\t0x8dcc, 0xffffffff, 0x98989898,\n\t0x88c4, 0xffffffff, 0x00000082\n};\n\nstatic const u32 rv770_golden_registers[] = {\n\t0x562c, 0xffffffff, 0,\n\t0x3f90, 0xffffffff, 0,\n\t0x9148, 0xffffffff, 0,\n\t0x3f94, 0xffffffff, 0,\n\t0x914c, 0xffffffff, 0,\n\t0x9698, 0x18000000, 0x18000000\n};\n\nstatic const u32 rv770ce_golden_registers[] = {\n\t0x562c, 0xffffffff, 0,\n\t0x3f90, 0xffffffff, 0x00cc0000,\n\t0x9148, 0xffffffff, 0x00cc0000,\n\t0x3f94, 0xffffffff, 0x00cc0000,\n\t0x914c, 0xffffffff, 0x00cc0000,\n\t0x9b7c, 0xffffffff, 0x00fa0000,\n\t0x3f8c, 0xffffffff, 0x00fa0000,\n\t0x9698, 0x18000000, 0x18000000\n};\n\nstatic const u32 rv770_mgcg_init[] = {\n\t0x8bcc, 0xffffffff, 0x130300f9,\n\t0x5448, 0xffffffff, 0x100,\n\t0x55e4, 0xffffffff, 0x100,\n\t0x160c, 0xffffffff, 0x100,\n\t0x5644, 0xffffffff, 0x100,\n\t0xc164, 0xffffffff, 0x100,\n\t0x8a18, 0xffffffff, 0x100,\n\t0x897c, 0xffffffff, 0x8000100,\n\t0x8b28, 0xffffffff, 0x3c000100,\n\t0x9144, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10000,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10001,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10002,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10003,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x0,\n\t0x9870, 0xffffffff, 0x100,\n\t0x8d58, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x0,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x1,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x2,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x3,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x4,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x5,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x6,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x7,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x8,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x9,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x8000,\n\t0x9490, 0xffffffff, 0x0,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x1,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x2,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x3,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x4,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x5,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x6,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x7,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x8,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x9,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x8000,\n\t0x9604, 0xffffffff, 0x0,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x1,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x2,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x3,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x4,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x5,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x6,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x7,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x8,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x9,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x80000000,\n\t0x9030, 0xffffffff, 0x100,\n\t0x9034, 0xffffffff, 0x100,\n\t0x9038, 0xffffffff, 0x100,\n\t0x903c, 0xffffffff, 0x100,\n\t0x9040, 0xffffffff, 0x100,\n\t0xa200, 0xffffffff, 0x100,\n\t0xa204, 0xffffffff, 0x100,\n\t0xa208, 0xffffffff, 0x100,\n\t0xa20c, 0xffffffff, 0x100,\n\t0x971c, 0xffffffff, 0x100,\n\t0x915c, 0xffffffff, 0x00020001,\n\t0x9160, 0xffffffff, 0x00040003,\n\t0x916c, 0xffffffff, 0x00060005,\n\t0x9170, 0xffffffff, 0x00080007,\n\t0x9174, 0xffffffff, 0x000a0009,\n\t0x9178, 0xffffffff, 0x000c000b,\n\t0x917c, 0xffffffff, 0x000e000d,\n\t0x9180, 0xffffffff, 0x0010000f,\n\t0x918c, 0xffffffff, 0x00120011,\n\t0x9190, 0xffffffff, 0x00140013,\n\t0x9194, 0xffffffff, 0x00020001,\n\t0x9198, 0xffffffff, 0x00040003,\n\t0x919c, 0xffffffff, 0x00060005,\n\t0x91a8, 0xffffffff, 0x00080007,\n\t0x91ac, 0xffffffff, 0x000a0009,\n\t0x91b0, 0xffffffff, 0x000c000b,\n\t0x91b4, 0xffffffff, 0x000e000d,\n\t0x91b8, 0xffffffff, 0x0010000f,\n\t0x91c4, 0xffffffff, 0x00120011,\n\t0x91c8, 0xffffffff, 0x00140013,\n\t0x91cc, 0xffffffff, 0x00020001,\n\t0x91d0, 0xffffffff, 0x00040003,\n\t0x91d4, 0xffffffff, 0x00060005,\n\t0x91e0, 0xffffffff, 0x00080007,\n\t0x91e4, 0xffffffff, 0x000a0009,\n\t0x91e8, 0xffffffff, 0x000c000b,\n\t0x91ec, 0xffffffff, 0x00020001,\n\t0x91f0, 0xffffffff, 0x00040003,\n\t0x91f4, 0xffffffff, 0x00060005,\n\t0x9200, 0xffffffff, 0x00080007,\n\t0x9204, 0xffffffff, 0x000a0009,\n\t0x9208, 0xffffffff, 0x000c000b,\n\t0x920c, 0xffffffff, 0x000e000d,\n\t0x9210, 0xffffffff, 0x0010000f,\n\t0x921c, 0xffffffff, 0x00120011,\n\t0x9220, 0xffffffff, 0x00140013,\n\t0x9224, 0xffffffff, 0x00020001,\n\t0x9228, 0xffffffff, 0x00040003,\n\t0x922c, 0xffffffff, 0x00060005,\n\t0x9238, 0xffffffff, 0x00080007,\n\t0x923c, 0xffffffff, 0x000a0009,\n\t0x9240, 0xffffffff, 0x000c000b,\n\t0x9244, 0xffffffff, 0x000e000d,\n\t0x9248, 0xffffffff, 0x0010000f,\n\t0x9254, 0xffffffff, 0x00120011,\n\t0x9258, 0xffffffff, 0x00140013,\n\t0x925c, 0xffffffff, 0x00020001,\n\t0x9260, 0xffffffff, 0x00040003,\n\t0x9264, 0xffffffff, 0x00060005,\n\t0x9270, 0xffffffff, 0x00080007,\n\t0x9274, 0xffffffff, 0x000a0009,\n\t0x9278, 0xffffffff, 0x000c000b,\n\t0x927c, 0xffffffff, 0x000e000d,\n\t0x9280, 0xffffffff, 0x0010000f,\n\t0x928c, 0xffffffff, 0x00120011,\n\t0x9290, 0xffffffff, 0x00140013,\n\t0x9294, 0xffffffff, 0x00020001,\n\t0x929c, 0xffffffff, 0x00040003,\n\t0x92a0, 0xffffffff, 0x00060005,\n\t0x92a4, 0xffffffff, 0x00080007\n};\n\nstatic const u32 rv710_golden_registers[] = {\n\t0x3f90, 0x00ff0000, 0x00fc0000,\n\t0x9148, 0x00ff0000, 0x00fc0000,\n\t0x3f94, 0x00ff0000, 0x00fc0000,\n\t0x914c, 0x00ff0000, 0x00fc0000,\n\t0xb4c, 0x00000020, 0x00000020,\n\t0xa180, 0xffffffff, 0x00003f3f\n};\n\nstatic const u32 rv710_mgcg_init[] = {\n\t0x8bcc, 0xffffffff, 0x13030040,\n\t0x5448, 0xffffffff, 0x100,\n\t0x55e4, 0xffffffff, 0x100,\n\t0x160c, 0xffffffff, 0x100,\n\t0x5644, 0xffffffff, 0x100,\n\t0xc164, 0xffffffff, 0x100,\n\t0x8a18, 0xffffffff, 0x100,\n\t0x897c, 0xffffffff, 0x8000100,\n\t0x8b28, 0xffffffff, 0x3c000100,\n\t0x9144, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10000,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x0,\n\t0x9870, 0xffffffff, 0x100,\n\t0x8d58, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x0,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x1,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x8000,\n\t0x9490, 0xffffffff, 0x0,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x1,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x8000,\n\t0x9604, 0xffffffff, 0x0,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x1,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x80000000,\n\t0x9030, 0xffffffff, 0x100,\n\t0x9034, 0xffffffff, 0x100,\n\t0x9038, 0xffffffff, 0x100,\n\t0x903c, 0xffffffff, 0x100,\n\t0x9040, 0xffffffff, 0x100,\n\t0xa200, 0xffffffff, 0x100,\n\t0xa204, 0xffffffff, 0x100,\n\t0xa208, 0xffffffff, 0x100,\n\t0xa20c, 0xffffffff, 0x100,\n\t0x971c, 0xffffffff, 0x100,\n\t0x915c, 0xffffffff, 0x00020001,\n\t0x9174, 0xffffffff, 0x00000003,\n\t0x9178, 0xffffffff, 0x00050001,\n\t0x917c, 0xffffffff, 0x00030002,\n\t0x918c, 0xffffffff, 0x00000004,\n\t0x9190, 0xffffffff, 0x00070006,\n\t0x9194, 0xffffffff, 0x00050001,\n\t0x9198, 0xffffffff, 0x00030002,\n\t0x91a8, 0xffffffff, 0x00000004,\n\t0x91ac, 0xffffffff, 0x00070006,\n\t0x91e8, 0xffffffff, 0x00000001,\n\t0x9294, 0xffffffff, 0x00000001,\n\t0x929c, 0xffffffff, 0x00000002,\n\t0x92a0, 0xffffffff, 0x00040003,\n\t0x9150, 0xffffffff, 0x4d940000\n};\n\nstatic const u32 rv730_golden_registers[] = {\n\t0x3f90, 0x00ff0000, 0x00f00000,\n\t0x9148, 0x00ff0000, 0x00f00000,\n\t0x3f94, 0x00ff0000, 0x00f00000,\n\t0x914c, 0x00ff0000, 0x00f00000,\n\t0x900c, 0xffffffff, 0x003b033f,\n\t0xb4c, 0x00000020, 0x00000020,\n\t0xa180, 0xffffffff, 0x00003f3f\n};\n\nstatic const u32 rv730_mgcg_init[] = {\n\t0x8bcc, 0xffffffff, 0x130300f9,\n\t0x5448, 0xffffffff, 0x100,\n\t0x55e4, 0xffffffff, 0x100,\n\t0x160c, 0xffffffff, 0x100,\n\t0x5644, 0xffffffff, 0x100,\n\t0xc164, 0xffffffff, 0x100,\n\t0x8a18, 0xffffffff, 0x100,\n\t0x897c, 0xffffffff, 0x8000100,\n\t0x8b28, 0xffffffff, 0x3c000100,\n\t0x9144, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10000,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10001,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x0,\n\t0x9870, 0xffffffff, 0x100,\n\t0x8d58, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x0,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x1,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x2,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x3,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x4,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x5,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x6,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x7,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x8000,\n\t0x9490, 0xffffffff, 0x0,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x1,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x2,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x3,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x4,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x5,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x6,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x7,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x8000,\n\t0x9604, 0xffffffff, 0x0,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x1,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x2,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x3,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x4,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x5,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x6,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x7,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x80000000,\n\t0x9030, 0xffffffff, 0x100,\n\t0x9034, 0xffffffff, 0x100,\n\t0x9038, 0xffffffff, 0x100,\n\t0x903c, 0xffffffff, 0x100,\n\t0x9040, 0xffffffff, 0x100,\n\t0xa200, 0xffffffff, 0x100,\n\t0xa204, 0xffffffff, 0x100,\n\t0xa208, 0xffffffff, 0x100,\n\t0xa20c, 0xffffffff, 0x100,\n\t0x971c, 0xffffffff, 0x100,\n\t0x915c, 0xffffffff, 0x00020001,\n\t0x916c, 0xffffffff, 0x00040003,\n\t0x9170, 0xffffffff, 0x00000005,\n\t0x9178, 0xffffffff, 0x00050001,\n\t0x917c, 0xffffffff, 0x00030002,\n\t0x918c, 0xffffffff, 0x00000004,\n\t0x9190, 0xffffffff, 0x00070006,\n\t0x9194, 0xffffffff, 0x00050001,\n\t0x9198, 0xffffffff, 0x00030002,\n\t0x91a8, 0xffffffff, 0x00000004,\n\t0x91ac, 0xffffffff, 0x00070006,\n\t0x91b0, 0xffffffff, 0x00050001,\n\t0x91b4, 0xffffffff, 0x00030002,\n\t0x91c4, 0xffffffff, 0x00000004,\n\t0x91c8, 0xffffffff, 0x00070006,\n\t0x91cc, 0xffffffff, 0x00050001,\n\t0x91d0, 0xffffffff, 0x00030002,\n\t0x91e0, 0xffffffff, 0x00000004,\n\t0x91e4, 0xffffffff, 0x00070006,\n\t0x91e8, 0xffffffff, 0x00000001,\n\t0x91ec, 0xffffffff, 0x00050001,\n\t0x91f0, 0xffffffff, 0x00030002,\n\t0x9200, 0xffffffff, 0x00000004,\n\t0x9204, 0xffffffff, 0x00070006,\n\t0x9208, 0xffffffff, 0x00050001,\n\t0x920c, 0xffffffff, 0x00030002,\n\t0x921c, 0xffffffff, 0x00000004,\n\t0x9220, 0xffffffff, 0x00070006,\n\t0x9224, 0xffffffff, 0x00050001,\n\t0x9228, 0xffffffff, 0x00030002,\n\t0x9238, 0xffffffff, 0x00000004,\n\t0x923c, 0xffffffff, 0x00070006,\n\t0x9240, 0xffffffff, 0x00050001,\n\t0x9244, 0xffffffff, 0x00030002,\n\t0x9254, 0xffffffff, 0x00000004,\n\t0x9258, 0xffffffff, 0x00070006,\n\t0x9294, 0xffffffff, 0x00000001,\n\t0x929c, 0xffffffff, 0x00000002,\n\t0x92a0, 0xffffffff, 0x00040003,\n\t0x92a4, 0xffffffff, 0x00000005\n};\n\nstatic const u32 rv740_golden_registers[] = {\n\t0x88c4, 0xffffffff, 0x00000082,\n\t0x28a50, 0xfffffffc, 0x00000004,\n\t0x2650, 0x00040000, 0,\n\t0x20bc, 0x00040000, 0,\n\t0x733c, 0xffffffff, 0x00000002,\n\t0x7300, 0xffffffff, 0x001000f0,\n\t0x3f90, 0x00ff0000, 0,\n\t0x9148, 0x00ff0000, 0,\n\t0x3f94, 0x00ff0000, 0,\n\t0x914c, 0x00ff0000, 0,\n\t0x240c, 0xffffffff, 0x00000380,\n\t0x8a14, 0x00000007, 0x00000007,\n\t0x8b24, 0xffffffff, 0x00ff0fff,\n\t0x28a4c, 0xffffffff, 0x00004000,\n\t0xa180, 0xffffffff, 0x00003f3f,\n\t0x8d00, 0xffffffff, 0x0e0e003a,\n\t0x8d04, 0xffffffff, 0x013a0e2a,\n\t0x8c00, 0xffffffff, 0xe400000f,\n\t0x8db0, 0xffffffff, 0x98989898,\n\t0x8db4, 0xffffffff, 0x98989898,\n\t0x8db8, 0xffffffff, 0x98989898,\n\t0x8dbc, 0xffffffff, 0x98989898,\n\t0x8dc0, 0xffffffff, 0x98989898,\n\t0x8dc4, 0xffffffff, 0x98989898,\n\t0x8dc8, 0xffffffff, 0x98989898,\n\t0x8dcc, 0xffffffff, 0x98989898,\n\t0x9058, 0xffffffff, 0x0fffc40f,\n\t0x900c, 0xffffffff, 0x003b033f,\n\t0x28350, 0xffffffff, 0,\n\t0x8cf0, 0x1fffffff, 0x08e00420,\n\t0x9508, 0xffffffff, 0x00000002,\n\t0x88c4, 0xffffffff, 0x000000c2,\n\t0x9698, 0x18000000, 0x18000000\n};\n\nstatic const u32 rv740_mgcg_init[] = {\n\t0x8bcc, 0xffffffff, 0x13030100,\n\t0x5448, 0xffffffff, 0x100,\n\t0x55e4, 0xffffffff, 0x100,\n\t0x160c, 0xffffffff, 0x100,\n\t0x5644, 0xffffffff, 0x100,\n\t0xc164, 0xffffffff, 0x100,\n\t0x8a18, 0xffffffff, 0x100,\n\t0x897c, 0xffffffff, 0x100,\n\t0x8b28, 0xffffffff, 0x100,\n\t0x9144, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10000,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10001,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10002,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x10003,\n\t0x9a50, 0xffffffff, 0x100,\n\t0x9a1c, 0xffffffff, 0x0,\n\t0x9870, 0xffffffff, 0x100,\n\t0x8d58, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x0,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x1,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x2,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x3,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x4,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x5,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x6,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x7,\n\t0x9510, 0xffffffff, 0x100,\n\t0x9500, 0xffffffff, 0x8000,\n\t0x9490, 0xffffffff, 0x0,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x1,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x2,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x3,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x4,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x5,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x6,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x7,\n\t0x949c, 0xffffffff, 0x100,\n\t0x9490, 0xffffffff, 0x8000,\n\t0x9604, 0xffffffff, 0x0,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x1,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x2,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x3,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x4,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x5,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x6,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x7,\n\t0x9654, 0xffffffff, 0x100,\n\t0x9604, 0xffffffff, 0x80000000,\n\t0x9030, 0xffffffff, 0x100,\n\t0x9034, 0xffffffff, 0x100,\n\t0x9038, 0xffffffff, 0x100,\n\t0x903c, 0xffffffff, 0x100,\n\t0x9040, 0xffffffff, 0x100,\n\t0xa200, 0xffffffff, 0x100,\n\t0xa204, 0xffffffff, 0x100,\n\t0xa208, 0xffffffff, 0x100,\n\t0xa20c, 0xffffffff, 0x100,\n\t0x971c, 0xffffffff, 0x100,\n\t0x915c, 0xffffffff, 0x00020001,\n\t0x9160, 0xffffffff, 0x00040003,\n\t0x916c, 0xffffffff, 0x00060005,\n\t0x9170, 0xffffffff, 0x00080007,\n\t0x9174, 0xffffffff, 0x000a0009,\n\t0x9178, 0xffffffff, 0x000c000b,\n\t0x917c, 0xffffffff, 0x000e000d,\n\t0x9180, 0xffffffff, 0x0010000f,\n\t0x918c, 0xffffffff, 0x00120011,\n\t0x9190, 0xffffffff, 0x00140013,\n\t0x9194, 0xffffffff, 0x00020001,\n\t0x9198, 0xffffffff, 0x00040003,\n\t0x919c, 0xffffffff, 0x00060005,\n\t0x91a8, 0xffffffff, 0x00080007,\n\t0x91ac, 0xffffffff, 0x000a0009,\n\t0x91b0, 0xffffffff, 0x000c000b,\n\t0x91b4, 0xffffffff, 0x000e000d,\n\t0x91b8, 0xffffffff, 0x0010000f,\n\t0x91c4, 0xffffffff, 0x00120011,\n\t0x91c8, 0xffffffff, 0x00140013,\n\t0x91cc, 0xffffffff, 0x00020001,\n\t0x91d0, 0xffffffff, 0x00040003,\n\t0x91d4, 0xffffffff, 0x00060005,\n\t0x91e0, 0xffffffff, 0x00080007,\n\t0x91e4, 0xffffffff, 0x000a0009,\n\t0x91e8, 0xffffffff, 0x000c000b,\n\t0x91ec, 0xffffffff, 0x00020001,\n\t0x91f0, 0xffffffff, 0x00040003,\n\t0x91f4, 0xffffffff, 0x00060005,\n\t0x9200, 0xffffffff, 0x00080007,\n\t0x9204, 0xffffffff, 0x000a0009,\n\t0x9208, 0xffffffff, 0x000c000b,\n\t0x920c, 0xffffffff, 0x000e000d,\n\t0x9210, 0xffffffff, 0x0010000f,\n\t0x921c, 0xffffffff, 0x00120011,\n\t0x9220, 0xffffffff, 0x00140013,\n\t0x9224, 0xffffffff, 0x00020001,\n\t0x9228, 0xffffffff, 0x00040003,\n\t0x922c, 0xffffffff, 0x00060005,\n\t0x9238, 0xffffffff, 0x00080007,\n\t0x923c, 0xffffffff, 0x000a0009,\n\t0x9240, 0xffffffff, 0x000c000b,\n\t0x9244, 0xffffffff, 0x000e000d,\n\t0x9248, 0xffffffff, 0x0010000f,\n\t0x9254, 0xffffffff, 0x00120011,\n\t0x9258, 0xffffffff, 0x00140013,\n\t0x9294, 0xffffffff, 0x00020001,\n\t0x929c, 0xffffffff, 0x00040003,\n\t0x92a0, 0xffffffff, 0x00060005,\n\t0x92a4, 0xffffffff, 0x00080007\n};\n\nstatic void rv770_init_golden_registers(struct radeon_device *rdev)\n{\n\tswitch (rdev->family) {\n\tcase CHIP_RV770:\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t r7xx_golden_registers,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(r7xx_golden_registers));\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t r7xx_golden_dyn_gpr_registers,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(r7xx_golden_dyn_gpr_registers));\n\t\tif (rdev->pdev->device == 0x994e)\n\t\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t\t rv770ce_golden_registers,\n\t\t\t\t\t\t\t (const u32)ARRAY_SIZE(rv770ce_golden_registers));\n\t\telse\n\t\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t\t rv770_golden_registers,\n\t\t\t\t\t\t\t (const u32)ARRAY_SIZE(rv770_golden_registers));\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t rv770_mgcg_init,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(rv770_mgcg_init));\n\t\tbreak;\n\tcase CHIP_RV730:\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t r7xx_golden_registers,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(r7xx_golden_registers));\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t r7xx_golden_dyn_gpr_registers,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(r7xx_golden_dyn_gpr_registers));\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t rv730_golden_registers,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(rv730_golden_registers));\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t rv730_mgcg_init,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(rv730_mgcg_init));\n\t\tbreak;\n\tcase CHIP_RV710:\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t r7xx_golden_registers,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(r7xx_golden_registers));\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t r7xx_golden_dyn_gpr_registers,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(r7xx_golden_dyn_gpr_registers));\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t rv710_golden_registers,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(rv710_golden_registers));\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t rv710_mgcg_init,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(rv710_mgcg_init));\n\t\tbreak;\n\tcase CHIP_RV740:\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t rv740_golden_registers,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(rv740_golden_registers));\n\t\tradeon_program_register_sequence(rdev,\n\t\t\t\t\t\t rv740_mgcg_init,\n\t\t\t\t\t\t (const u32)ARRAY_SIZE(rv740_mgcg_init));\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n#define PCIE_BUS_CLK                10000\n#define TCLK                        (PCIE_BUS_CLK / 10)\n\n \nu32 rv770_get_xclk(struct radeon_device *rdev)\n{\n\tu32 reference_clock = rdev->clock.spll.reference_freq;\n\tu32 tmp = RREG32(CG_CLKPIN_CNTL);\n\n\tif (tmp & MUX_TCLK_TO_XCLK)\n\t\treturn TCLK;\n\n\tif (tmp & XTALIN_DIVIDE)\n\t\treturn reference_clock / 4;\n\n\treturn reference_clock;\n}\n\nvoid rv770_page_flip(struct radeon_device *rdev, int crtc_id, u64 crtc_base, bool async)\n{\n\tstruct radeon_crtc *radeon_crtc = rdev->mode_info.crtcs[crtc_id];\n\tstruct drm_framebuffer *fb = radeon_crtc->base.primary->fb;\n\tu32 tmp = RREG32(AVIVO_D1GRPH_UPDATE + radeon_crtc->crtc_offset);\n\tint i;\n\n\t \n\ttmp |= AVIVO_D1GRPH_UPDATE_LOCK;\n\tWREG32(AVIVO_D1GRPH_UPDATE + radeon_crtc->crtc_offset, tmp);\n\n\t \n\tWREG32(AVIVO_D1GRPH_FLIP_CONTROL + radeon_crtc->crtc_offset,\n\t       async ? AVIVO_D1GRPH_SURFACE_UPDATE_H_RETRACE_EN : 0);\n\t \n\tWREG32(AVIVO_D1GRPH_PITCH + radeon_crtc->crtc_offset,\n\t       fb->pitches[0] / fb->format->cpp[0]);\n\t \n\tif (radeon_crtc->crtc_id) {\n\t\tWREG32(D2GRPH_SECONDARY_SURFACE_ADDRESS_HIGH, upper_32_bits(crtc_base));\n\t\tWREG32(D2GRPH_PRIMARY_SURFACE_ADDRESS_HIGH, upper_32_bits(crtc_base));\n\t} else {\n\t\tWREG32(D1GRPH_SECONDARY_SURFACE_ADDRESS_HIGH, upper_32_bits(crtc_base));\n\t\tWREG32(D1GRPH_PRIMARY_SURFACE_ADDRESS_HIGH, upper_32_bits(crtc_base));\n\t}\n\tWREG32(D1GRPH_SECONDARY_SURFACE_ADDRESS + radeon_crtc->crtc_offset,\n\t       (u32)crtc_base);\n\tWREG32(D1GRPH_PRIMARY_SURFACE_ADDRESS + radeon_crtc->crtc_offset,\n\t       (u32)crtc_base);\n\n\t \n\tfor (i = 0; i < rdev->usec_timeout; i++) {\n\t\tif (RREG32(AVIVO_D1GRPH_UPDATE + radeon_crtc->crtc_offset) & AVIVO_D1GRPH_SURFACE_UPDATE_PENDING)\n\t\t\tbreak;\n\t\tudelay(1);\n\t}\n\tDRM_DEBUG(\"Update pending now high. Unlocking vupdate_lock.\\n\");\n\n\t \n\ttmp &= ~AVIVO_D1GRPH_UPDATE_LOCK;\n\tWREG32(AVIVO_D1GRPH_UPDATE + radeon_crtc->crtc_offset, tmp);\n}\n\nbool rv770_page_flip_pending(struct radeon_device *rdev, int crtc_id)\n{\n\tstruct radeon_crtc *radeon_crtc = rdev->mode_info.crtcs[crtc_id];\n\n\t \n\treturn !!(RREG32(AVIVO_D1GRPH_UPDATE + radeon_crtc->crtc_offset) &\n\t\tAVIVO_D1GRPH_SURFACE_UPDATE_PENDING);\n}\n\n \nint rv770_get_temp(struct radeon_device *rdev)\n{\n\tu32 temp = (RREG32(CG_MULT_THERMAL_STATUS) & ASIC_T_MASK) >>\n\t\tASIC_T_SHIFT;\n\tint actual_temp;\n\n\tif (temp & 0x400)\n\t\tactual_temp = -256;\n\telse if (temp & 0x200)\n\t\tactual_temp = 255;\n\telse if (temp & 0x100) {\n\t\tactual_temp = temp & 0x1ff;\n\t\tactual_temp |= ~0x1ff;\n\t} else\n\t\tactual_temp = temp & 0xff;\n\n\treturn (actual_temp * 1000) / 2;\n}\n\nvoid rv770_pm_misc(struct radeon_device *rdev)\n{\n\tint req_ps_idx = rdev->pm.requested_power_state_index;\n\tint req_cm_idx = rdev->pm.requested_clock_mode_index;\n\tstruct radeon_power_state *ps = &rdev->pm.power_state[req_ps_idx];\n\tstruct radeon_voltage *voltage = &ps->clock_info[req_cm_idx].voltage;\n\n\tif ((voltage->type == VOLTAGE_SW) && voltage->voltage) {\n\t\t \n\t\tif (voltage->voltage == 0xff01)\n\t\t\treturn;\n\t\tif (voltage->voltage != rdev->pm.current_vddc) {\n\t\t\tradeon_atom_set_voltage(rdev, voltage->voltage, SET_VOLTAGE_TYPE_ASIC_VDDC);\n\t\t\trdev->pm.current_vddc = voltage->voltage;\n\t\t\tDRM_DEBUG(\"Setting: v: %d\\n\", voltage->voltage);\n\t\t}\n\t}\n}\n\n \nstatic int rv770_pcie_gart_enable(struct radeon_device *rdev)\n{\n\tu32 tmp;\n\tint r, i;\n\n\tif (rdev->gart.robj == NULL) {\n\t\tdev_err(rdev->dev, \"No VRAM object for PCIE GART.\\n\");\n\t\treturn -EINVAL;\n\t}\n\tr = radeon_gart_table_vram_pin(rdev);\n\tif (r)\n\t\treturn r;\n\t \n\tWREG32(VM_L2_CNTL, ENABLE_L2_CACHE | ENABLE_L2_FRAGMENT_PROCESSING |\n\t\t\t\tENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE |\n\t\t\t\tEFFECTIVE_L2_QUEUE_SIZE(7));\n\tWREG32(VM_L2_CNTL2, 0);\n\tWREG32(VM_L2_CNTL3, BANK_SELECT(0) | CACHE_UPDATE_MODE(2));\n\t \n\ttmp = ENABLE_L1_TLB | ENABLE_L1_FRAGMENT_PROCESSING |\n\t\tSYSTEM_ACCESS_MODE_NOT_IN_SYS |\n\t\tSYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU |\n\t\tEFFECTIVE_L1_TLB_SIZE(5) | EFFECTIVE_L1_QUEUE_SIZE(5);\n\tWREG32(MC_VM_MD_L1_TLB0_CNTL, tmp);\n\tWREG32(MC_VM_MD_L1_TLB1_CNTL, tmp);\n\tWREG32(MC_VM_MD_L1_TLB2_CNTL, tmp);\n\tif (rdev->family == CHIP_RV740)\n\t\tWREG32(MC_VM_MD_L1_TLB3_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB0_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB1_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB2_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB3_CNTL, tmp);\n\tWREG32(VM_CONTEXT0_PAGE_TABLE_START_ADDR, rdev->mc.gtt_start >> 12);\n\tWREG32(VM_CONTEXT0_PAGE_TABLE_END_ADDR, rdev->mc.gtt_end >> 12);\n\tWREG32(VM_CONTEXT0_PAGE_TABLE_BASE_ADDR, rdev->gart.table_addr >> 12);\n\tWREG32(VM_CONTEXT0_CNTL, ENABLE_CONTEXT | PAGE_TABLE_DEPTH(0) |\n\t\t\t\tRANGE_PROTECTION_FAULT_ENABLE_DEFAULT);\n\tWREG32(VM_CONTEXT0_PROTECTION_FAULT_DEFAULT_ADDR,\n\t\t\t(u32)(rdev->dummy_page.addr >> 12));\n\tfor (i = 1; i < 7; i++)\n\t\tWREG32(VM_CONTEXT0_CNTL + (i * 4), 0);\n\n\tr600_pcie_gart_tlb_flush(rdev);\n\tDRM_INFO(\"PCIE GART of %uM enabled (table at 0x%016llX).\\n\",\n\t\t (unsigned)(rdev->mc.gtt_size >> 20),\n\t\t (unsigned long long)rdev->gart.table_addr);\n\trdev->gart.ready = true;\n\treturn 0;\n}\n\nstatic void rv770_pcie_gart_disable(struct radeon_device *rdev)\n{\n\tu32 tmp;\n\tint i;\n\n\t \n\tfor (i = 0; i < 7; i++)\n\t\tWREG32(VM_CONTEXT0_CNTL + (i * 4), 0);\n\n\t \n\tWREG32(VM_L2_CNTL, ENABLE_L2_FRAGMENT_PROCESSING |\n\t\t\t\tEFFECTIVE_L2_QUEUE_SIZE(7));\n\tWREG32(VM_L2_CNTL2, 0);\n\tWREG32(VM_L2_CNTL3, BANK_SELECT(0) | CACHE_UPDATE_MODE(2));\n\t \n\ttmp = EFFECTIVE_L1_TLB_SIZE(5) | EFFECTIVE_L1_QUEUE_SIZE(5);\n\tWREG32(MC_VM_MD_L1_TLB0_CNTL, tmp);\n\tWREG32(MC_VM_MD_L1_TLB1_CNTL, tmp);\n\tWREG32(MC_VM_MD_L1_TLB2_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB0_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB1_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB2_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB3_CNTL, tmp);\n\tradeon_gart_table_vram_unpin(rdev);\n}\n\nstatic void rv770_pcie_gart_fini(struct radeon_device *rdev)\n{\n\tradeon_gart_fini(rdev);\n\trv770_pcie_gart_disable(rdev);\n\tradeon_gart_table_vram_free(rdev);\n}\n\n\nstatic void rv770_agp_enable(struct radeon_device *rdev)\n{\n\tu32 tmp;\n\tint i;\n\n\t \n\tWREG32(VM_L2_CNTL, ENABLE_L2_CACHE | ENABLE_L2_FRAGMENT_PROCESSING |\n\t\t\t\tENABLE_L2_PTE_CACHE_LRU_UPDATE_BY_WRITE |\n\t\t\t\tEFFECTIVE_L2_QUEUE_SIZE(7));\n\tWREG32(VM_L2_CNTL2, 0);\n\tWREG32(VM_L2_CNTL3, BANK_SELECT(0) | CACHE_UPDATE_MODE(2));\n\t \n\ttmp = ENABLE_L1_TLB | ENABLE_L1_FRAGMENT_PROCESSING |\n\t\tSYSTEM_ACCESS_MODE_NOT_IN_SYS |\n\t\tSYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU |\n\t\tEFFECTIVE_L1_TLB_SIZE(5) | EFFECTIVE_L1_QUEUE_SIZE(5);\n\tWREG32(MC_VM_MD_L1_TLB0_CNTL, tmp);\n\tWREG32(MC_VM_MD_L1_TLB1_CNTL, tmp);\n\tWREG32(MC_VM_MD_L1_TLB2_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB0_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB1_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB2_CNTL, tmp);\n\tWREG32(MC_VM_MB_L1_TLB3_CNTL, tmp);\n\tfor (i = 0; i < 7; i++)\n\t\tWREG32(VM_CONTEXT0_CNTL + (i * 4), 0);\n}\n\nstatic void rv770_mc_program(struct radeon_device *rdev)\n{\n\tstruct rv515_mc_save save;\n\tu32 tmp;\n\tint i, j;\n\n\t \n\tfor (i = 0, j = 0; i < 32; i++, j += 0x18) {\n\t\tWREG32((0x2c14 + j), 0x00000000);\n\t\tWREG32((0x2c18 + j), 0x00000000);\n\t\tWREG32((0x2c1c + j), 0x00000000);\n\t\tWREG32((0x2c20 + j), 0x00000000);\n\t\tWREG32((0x2c24 + j), 0x00000000);\n\t}\n\t \n\ttmp = RREG32(HDP_DEBUG1);\n\n\trv515_mc_stop(rdev, &save);\n\tif (r600_mc_wait_for_idle(rdev)) {\n\t\tdev_warn(rdev->dev, \"Wait for MC idle timedout !\\n\");\n\t}\n\t \n\tWREG32(VGA_HDP_CONTROL, VGA_MEMORY_DISABLE);\n\t \n\tif (rdev->flags & RADEON_IS_AGP) {\n\t\tif (rdev->mc.vram_start < rdev->mc.gtt_start) {\n\t\t\t \n\t\t\tWREG32(MC_VM_SYSTEM_APERTURE_LOW_ADDR,\n\t\t\t\trdev->mc.vram_start >> 12);\n\t\t\tWREG32(MC_VM_SYSTEM_APERTURE_HIGH_ADDR,\n\t\t\t\trdev->mc.gtt_end >> 12);\n\t\t} else {\n\t\t\t \n\t\t\tWREG32(MC_VM_SYSTEM_APERTURE_LOW_ADDR,\n\t\t\t\trdev->mc.gtt_start >> 12);\n\t\t\tWREG32(MC_VM_SYSTEM_APERTURE_HIGH_ADDR,\n\t\t\t\trdev->mc.vram_end >> 12);\n\t\t}\n\t} else {\n\t\tWREG32(MC_VM_SYSTEM_APERTURE_LOW_ADDR,\n\t\t\trdev->mc.vram_start >> 12);\n\t\tWREG32(MC_VM_SYSTEM_APERTURE_HIGH_ADDR,\n\t\t\trdev->mc.vram_end >> 12);\n\t}\n\tWREG32(MC_VM_SYSTEM_APERTURE_DEFAULT_ADDR, rdev->vram_scratch.gpu_addr >> 12);\n\ttmp = ((rdev->mc.vram_end >> 24) & 0xFFFF) << 16;\n\ttmp |= ((rdev->mc.vram_start >> 24) & 0xFFFF);\n\tWREG32(MC_VM_FB_LOCATION, tmp);\n\tWREG32(HDP_NONSURFACE_BASE, (rdev->mc.vram_start >> 8));\n\tWREG32(HDP_NONSURFACE_INFO, (2 << 7));\n\tWREG32(HDP_NONSURFACE_SIZE, 0x3FFFFFFF);\n\tif (rdev->flags & RADEON_IS_AGP) {\n\t\tWREG32(MC_VM_AGP_TOP, rdev->mc.gtt_end >> 16);\n\t\tWREG32(MC_VM_AGP_BOT, rdev->mc.gtt_start >> 16);\n\t\tWREG32(MC_VM_AGP_BASE, rdev->mc.agp_base >> 22);\n\t} else {\n\t\tWREG32(MC_VM_AGP_BASE, 0);\n\t\tWREG32(MC_VM_AGP_TOP, 0x0FFFFFFF);\n\t\tWREG32(MC_VM_AGP_BOT, 0x0FFFFFFF);\n\t}\n\tif (r600_mc_wait_for_idle(rdev)) {\n\t\tdev_warn(rdev->dev, \"Wait for MC idle timedout !\\n\");\n\t}\n\trv515_mc_resume(rdev, &save);\n\t \n\trv515_vga_render_disable(rdev);\n}\n\n\n \nvoid r700_cp_stop(struct radeon_device *rdev)\n{\n\tif (rdev->asic->copy.copy_ring_index == RADEON_RING_TYPE_GFX_INDEX)\n\t\tradeon_ttm_set_active_vram_size(rdev, rdev->mc.visible_vram_size);\n\tWREG32(CP_ME_CNTL, (CP_ME_HALT | CP_PFP_HALT));\n\tWREG32(SCRATCH_UMSK, 0);\n\trdev->ring[RADEON_RING_TYPE_GFX_INDEX].ready = false;\n}\n\nstatic int rv770_cp_load_microcode(struct radeon_device *rdev)\n{\n\tconst __be32 *fw_data;\n\tint i;\n\n\tif (!rdev->me_fw || !rdev->pfp_fw)\n\t\treturn -EINVAL;\n\n\tr700_cp_stop(rdev);\n\tWREG32(CP_RB_CNTL,\n#ifdef __BIG_ENDIAN\n\t       BUF_SWAP_32BIT |\n#endif\n\t       RB_NO_UPDATE | RB_BLKSZ(15) | RB_BUFSZ(3));\n\n\t \n\tWREG32(GRBM_SOFT_RESET, SOFT_RESET_CP);\n\tRREG32(GRBM_SOFT_RESET);\n\tmdelay(15);\n\tWREG32(GRBM_SOFT_RESET, 0);\n\n\tfw_data = (const __be32 *)rdev->pfp_fw->data;\n\tWREG32(CP_PFP_UCODE_ADDR, 0);\n\tfor (i = 0; i < R700_PFP_UCODE_SIZE; i++)\n\t\tWREG32(CP_PFP_UCODE_DATA, be32_to_cpup(fw_data++));\n\tWREG32(CP_PFP_UCODE_ADDR, 0);\n\n\tfw_data = (const __be32 *)rdev->me_fw->data;\n\tWREG32(CP_ME_RAM_WADDR, 0);\n\tfor (i = 0; i < R700_PM4_UCODE_SIZE; i++)\n\t\tWREG32(CP_ME_RAM_DATA, be32_to_cpup(fw_data++));\n\n\tWREG32(CP_PFP_UCODE_ADDR, 0);\n\tWREG32(CP_ME_RAM_WADDR, 0);\n\tWREG32(CP_ME_RAM_RADDR, 0);\n\treturn 0;\n}\n\nvoid r700_cp_fini(struct radeon_device *rdev)\n{\n\tstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\n\tr700_cp_stop(rdev);\n\tradeon_ring_fini(rdev, ring);\n\tradeon_scratch_free(rdev, ring->rptr_save_reg);\n}\n\nvoid rv770_set_clk_bypass_mode(struct radeon_device *rdev)\n{\n\tu32 tmp, i;\n\n\tif (rdev->flags & RADEON_IS_IGP)\n\t\treturn;\n\n\ttmp = RREG32(CG_SPLL_FUNC_CNTL_2);\n\ttmp &= SCLK_MUX_SEL_MASK;\n\ttmp |= SCLK_MUX_SEL(1) | SCLK_MUX_UPDATE;\n\tWREG32(CG_SPLL_FUNC_CNTL_2, tmp);\n\n\tfor (i = 0; i < rdev->usec_timeout; i++) {\n\t\tif (RREG32(CG_SPLL_STATUS) & SPLL_CHG_STATUS)\n\t\t\tbreak;\n\t\tudelay(1);\n\t}\n\n\ttmp &= ~SCLK_MUX_UPDATE;\n\tWREG32(CG_SPLL_FUNC_CNTL_2, tmp);\n\n\ttmp = RREG32(MPLL_CNTL_MODE);\n\tif ((rdev->family == CHIP_RV710) || (rdev->family == CHIP_RV730))\n\t\ttmp &= ~RV730_MPLL_MCLK_SEL;\n\telse\n\t\ttmp &= ~MPLL_MCLK_SEL;\n\tWREG32(MPLL_CNTL_MODE, tmp);\n}\n\n \nstatic void rv770_gpu_init(struct radeon_device *rdev)\n{\n\tint i, j, num_qd_pipes;\n\tu32 ta_aux_cntl;\n\tu32 sx_debug_1;\n\tu32 smx_dc_ctl0;\n\tu32 db_debug3;\n\tu32 num_gs_verts_per_thread;\n\tu32 vgt_gs_per_es;\n\tu32 gs_prim_buffer_depth = 0;\n\tu32 sq_ms_fifo_sizes;\n\tu32 sq_config;\n\tu32 sq_thread_resource_mgmt;\n\tu32 hdp_host_path_cntl;\n\tu32 sq_dyn_gpr_size_simd_ab_0;\n\tu32 gb_tiling_config = 0;\n\tu32 cc_gc_shader_pipe_config = 0;\n\tu32 mc_arb_ramcfg;\n\tu32 db_debug4, tmp;\n\tu32 inactive_pipes, shader_pipe_config;\n\tu32 disabled_rb_mask;\n\tunsigned active_number;\n\n\t \n\trdev->config.rv770.tiling_group_size = 256;\n\tswitch (rdev->family) {\n\tcase CHIP_RV770:\n\t\trdev->config.rv770.max_pipes = 4;\n\t\trdev->config.rv770.max_tile_pipes = 8;\n\t\trdev->config.rv770.max_simds = 10;\n\t\trdev->config.rv770.max_backends = 4;\n\t\trdev->config.rv770.max_gprs = 256;\n\t\trdev->config.rv770.max_threads = 248;\n\t\trdev->config.rv770.max_stack_entries = 512;\n\t\trdev->config.rv770.max_hw_contexts = 8;\n\t\trdev->config.rv770.max_gs_threads = 16 * 2;\n\t\trdev->config.rv770.sx_max_export_size = 128;\n\t\trdev->config.rv770.sx_max_export_pos_size = 16;\n\t\trdev->config.rv770.sx_max_export_smx_size = 112;\n\t\trdev->config.rv770.sq_num_cf_insts = 2;\n\n\t\trdev->config.rv770.sx_num_of_sets = 7;\n\t\trdev->config.rv770.sc_prim_fifo_size = 0xF9;\n\t\trdev->config.rv770.sc_hiz_tile_fifo_size = 0x30;\n\t\trdev->config.rv770.sc_earlyz_tile_fifo_fize = 0x130;\n\t\tbreak;\n\tcase CHIP_RV730:\n\t\trdev->config.rv770.max_pipes = 2;\n\t\trdev->config.rv770.max_tile_pipes = 4;\n\t\trdev->config.rv770.max_simds = 8;\n\t\trdev->config.rv770.max_backends = 2;\n\t\trdev->config.rv770.max_gprs = 128;\n\t\trdev->config.rv770.max_threads = 248;\n\t\trdev->config.rv770.max_stack_entries = 256;\n\t\trdev->config.rv770.max_hw_contexts = 8;\n\t\trdev->config.rv770.max_gs_threads = 16 * 2;\n\t\trdev->config.rv770.sx_max_export_size = 256;\n\t\trdev->config.rv770.sx_max_export_pos_size = 32;\n\t\trdev->config.rv770.sx_max_export_smx_size = 224;\n\t\trdev->config.rv770.sq_num_cf_insts = 2;\n\n\t\trdev->config.rv770.sx_num_of_sets = 7;\n\t\trdev->config.rv770.sc_prim_fifo_size = 0xf9;\n\t\trdev->config.rv770.sc_hiz_tile_fifo_size = 0x30;\n\t\trdev->config.rv770.sc_earlyz_tile_fifo_fize = 0x130;\n\t\tif (rdev->config.rv770.sx_max_export_pos_size > 16) {\n\t\t\trdev->config.rv770.sx_max_export_pos_size -= 16;\n\t\t\trdev->config.rv770.sx_max_export_smx_size += 16;\n\t\t}\n\t\tbreak;\n\tcase CHIP_RV710:\n\t\trdev->config.rv770.max_pipes = 2;\n\t\trdev->config.rv770.max_tile_pipes = 2;\n\t\trdev->config.rv770.max_simds = 2;\n\t\trdev->config.rv770.max_backends = 1;\n\t\trdev->config.rv770.max_gprs = 256;\n\t\trdev->config.rv770.max_threads = 192;\n\t\trdev->config.rv770.max_stack_entries = 256;\n\t\trdev->config.rv770.max_hw_contexts = 4;\n\t\trdev->config.rv770.max_gs_threads = 8 * 2;\n\t\trdev->config.rv770.sx_max_export_size = 128;\n\t\trdev->config.rv770.sx_max_export_pos_size = 16;\n\t\trdev->config.rv770.sx_max_export_smx_size = 112;\n\t\trdev->config.rv770.sq_num_cf_insts = 1;\n\n\t\trdev->config.rv770.sx_num_of_sets = 7;\n\t\trdev->config.rv770.sc_prim_fifo_size = 0x40;\n\t\trdev->config.rv770.sc_hiz_tile_fifo_size = 0x30;\n\t\trdev->config.rv770.sc_earlyz_tile_fifo_fize = 0x130;\n\t\tbreak;\n\tcase CHIP_RV740:\n\t\trdev->config.rv770.max_pipes = 4;\n\t\trdev->config.rv770.max_tile_pipes = 4;\n\t\trdev->config.rv770.max_simds = 8;\n\t\trdev->config.rv770.max_backends = 4;\n\t\trdev->config.rv770.max_gprs = 256;\n\t\trdev->config.rv770.max_threads = 248;\n\t\trdev->config.rv770.max_stack_entries = 512;\n\t\trdev->config.rv770.max_hw_contexts = 8;\n\t\trdev->config.rv770.max_gs_threads = 16 * 2;\n\t\trdev->config.rv770.sx_max_export_size = 256;\n\t\trdev->config.rv770.sx_max_export_pos_size = 32;\n\t\trdev->config.rv770.sx_max_export_smx_size = 224;\n\t\trdev->config.rv770.sq_num_cf_insts = 2;\n\n\t\trdev->config.rv770.sx_num_of_sets = 7;\n\t\trdev->config.rv770.sc_prim_fifo_size = 0x100;\n\t\trdev->config.rv770.sc_hiz_tile_fifo_size = 0x30;\n\t\trdev->config.rv770.sc_earlyz_tile_fifo_fize = 0x130;\n\n\t\tif (rdev->config.rv770.sx_max_export_pos_size > 16) {\n\t\t\trdev->config.rv770.sx_max_export_pos_size -= 16;\n\t\t\trdev->config.rv770.sx_max_export_smx_size += 16;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\t \n\tj = 0;\n\tfor (i = 0; i < 32; i++) {\n\t\tWREG32((0x2c14 + j), 0x00000000);\n\t\tWREG32((0x2c18 + j), 0x00000000);\n\t\tWREG32((0x2c1c + j), 0x00000000);\n\t\tWREG32((0x2c20 + j), 0x00000000);\n\t\tWREG32((0x2c24 + j), 0x00000000);\n\t\tj += 0x18;\n\t}\n\n\tWREG32(GRBM_CNTL, GRBM_READ_TIMEOUT(0xff));\n\n\t \n\tmc_arb_ramcfg = RREG32(MC_ARB_RAMCFG);\n\n\tshader_pipe_config = RREG32(CC_GC_SHADER_PIPE_CONFIG);\n\tinactive_pipes = (shader_pipe_config & INACTIVE_QD_PIPES_MASK) >> INACTIVE_QD_PIPES_SHIFT;\n\tfor (i = 0, tmp = 1, active_number = 0; i < R7XX_MAX_PIPES; i++) {\n\t\tif (!(inactive_pipes & tmp)) {\n\t\t\tactive_number++;\n\t\t}\n\t\ttmp <<= 1;\n\t}\n\tif (active_number == 1) {\n\t\tWREG32(SPI_CONFIG_CNTL, DISABLE_INTERP_1);\n\t} else {\n\t\tWREG32(SPI_CONFIG_CNTL, 0);\n\t}\n\n\tcc_gc_shader_pipe_config = RREG32(CC_GC_SHADER_PIPE_CONFIG) & 0xffffff00;\n\ttmp = rdev->config.rv770.max_simds -\n\t\tr600_count_pipe_bits((cc_gc_shader_pipe_config >> 16) & R7XX_MAX_SIMDS_MASK);\n\trdev->config.rv770.active_simds = tmp;\n\n\tswitch (rdev->config.rv770.max_tile_pipes) {\n\tcase 1:\n\tdefault:\n\t\tgb_tiling_config = PIPE_TILING(0);\n\t\tbreak;\n\tcase 2:\n\t\tgb_tiling_config = PIPE_TILING(1);\n\t\tbreak;\n\tcase 4:\n\t\tgb_tiling_config = PIPE_TILING(2);\n\t\tbreak;\n\tcase 8:\n\t\tgb_tiling_config = PIPE_TILING(3);\n\t\tbreak;\n\t}\n\trdev->config.rv770.tiling_npipes = rdev->config.rv770.max_tile_pipes;\n\n\tdisabled_rb_mask = (RREG32(CC_RB_BACKEND_DISABLE) >> 16) & R7XX_MAX_BACKENDS_MASK;\n\ttmp = 0;\n\tfor (i = 0; i < rdev->config.rv770.max_backends; i++)\n\t\ttmp |= (1 << i);\n\t \n\tif ((disabled_rb_mask & tmp) == tmp) {\n\t\tfor (i = 0; i < rdev->config.rv770.max_backends; i++)\n\t\t\tdisabled_rb_mask &= ~(1 << i);\n\t}\n\ttmp = (gb_tiling_config & PIPE_TILING__MASK) >> PIPE_TILING__SHIFT;\n\ttmp = r6xx_remap_render_backend(rdev, tmp, rdev->config.rv770.max_backends,\n\t\t\t\t\tR7XX_MAX_BACKENDS, disabled_rb_mask);\n\tgb_tiling_config |= tmp << 16;\n\trdev->config.rv770.backend_map = tmp;\n\n\tif (rdev->family == CHIP_RV770)\n\t\tgb_tiling_config |= BANK_TILING(1);\n\telse {\n\t\tif ((mc_arb_ramcfg & NOOFBANK_MASK) >> NOOFBANK_SHIFT)\n\t\t\tgb_tiling_config |= BANK_TILING(1);\n\t\telse\n\t\t\tgb_tiling_config |= BANK_TILING(0);\n\t}\n\trdev->config.rv770.tiling_nbanks = 4 << ((gb_tiling_config >> 4) & 0x3);\n\tgb_tiling_config |= GROUP_SIZE((mc_arb_ramcfg & BURSTLENGTH_MASK) >> BURSTLENGTH_SHIFT);\n\tif (((mc_arb_ramcfg & NOOFROWS_MASK) >> NOOFROWS_SHIFT) > 3) {\n\t\tgb_tiling_config |= ROW_TILING(3);\n\t\tgb_tiling_config |= SAMPLE_SPLIT(3);\n\t} else {\n\t\tgb_tiling_config |=\n\t\t\tROW_TILING(((mc_arb_ramcfg & NOOFROWS_MASK) >> NOOFROWS_SHIFT));\n\t\tgb_tiling_config |=\n\t\t\tSAMPLE_SPLIT(((mc_arb_ramcfg & NOOFROWS_MASK) >> NOOFROWS_SHIFT));\n\t}\n\n\tgb_tiling_config |= BANK_SWAPS(1);\n\trdev->config.rv770.tile_config = gb_tiling_config;\n\n\tWREG32(GB_TILING_CONFIG, gb_tiling_config);\n\tWREG32(DCP_TILING_CONFIG, (gb_tiling_config & 0xffff));\n\tWREG32(HDP_TILING_CONFIG, (gb_tiling_config & 0xffff));\n\tWREG32(DMA_TILING_CONFIG, (gb_tiling_config & 0xffff));\n\tWREG32(DMA_TILING_CONFIG2, (gb_tiling_config & 0xffff));\n\tif (rdev->family == CHIP_RV730) {\n\t\tWREG32(UVD_UDEC_DB_TILING_CONFIG, (gb_tiling_config & 0xffff));\n\t\tWREG32(UVD_UDEC_DBW_TILING_CONFIG, (gb_tiling_config & 0xffff));\n\t\tWREG32(UVD_UDEC_TILING_CONFIG, (gb_tiling_config & 0xffff));\n\t}\n\n\tWREG32(CGTS_SYS_TCC_DISABLE, 0);\n\tWREG32(CGTS_TCC_DISABLE, 0);\n\tWREG32(CGTS_USER_SYS_TCC_DISABLE, 0);\n\tWREG32(CGTS_USER_TCC_DISABLE, 0);\n\n\n\tnum_qd_pipes = R7XX_MAX_PIPES - r600_count_pipe_bits((cc_gc_shader_pipe_config & INACTIVE_QD_PIPES_MASK) >> 8);\n\tWREG32(VGT_OUT_DEALLOC_CNTL, (num_qd_pipes * 4) & DEALLOC_DIST_MASK);\n\tWREG32(VGT_VERTEX_REUSE_BLOCK_CNTL, ((num_qd_pipes * 4) - 2) & VTX_REUSE_DEPTH_MASK);\n\n\t \n\tWREG32(CP_QUEUE_THRESHOLDS, (ROQ_IB1_START(0x16) |\n\t\t\t\t     ROQ_IB2_START(0x2b)));\n\n\tWREG32(CP_MEQ_THRESHOLDS, STQ_SPLIT(0x30));\n\n\tta_aux_cntl = RREG32(TA_CNTL_AUX);\n\tWREG32(TA_CNTL_AUX, ta_aux_cntl | DISABLE_CUBE_ANISO);\n\n\tsx_debug_1 = RREG32(SX_DEBUG_1);\n\tsx_debug_1 |= ENABLE_NEW_SMX_ADDRESS;\n\tWREG32(SX_DEBUG_1, sx_debug_1);\n\n\tsmx_dc_ctl0 = RREG32(SMX_DC_CTL0);\n\tsmx_dc_ctl0 &= ~CACHE_DEPTH(0x1ff);\n\tsmx_dc_ctl0 |= CACHE_DEPTH((rdev->config.rv770.sx_num_of_sets * 64) - 1);\n\tWREG32(SMX_DC_CTL0, smx_dc_ctl0);\n\n\tif (rdev->family != CHIP_RV740)\n\t\tWREG32(SMX_EVENT_CTL, (ES_FLUSH_CTL(4) |\n\t\t\t\t       GS_FLUSH_CTL(4) |\n\t\t\t\t       ACK_FLUSH_CTL(3) |\n\t\t\t\t       SYNC_FLUSH_CTL));\n\n\tif (rdev->family != CHIP_RV770)\n\t\tWREG32(SMX_SAR_CTL0, 0x00003f3f);\n\n\tdb_debug3 = RREG32(DB_DEBUG3);\n\tdb_debug3 &= ~DB_CLK_OFF_DELAY(0x1f);\n\tswitch (rdev->family) {\n\tcase CHIP_RV770:\n\tcase CHIP_RV740:\n\t\tdb_debug3 |= DB_CLK_OFF_DELAY(0x1f);\n\t\tbreak;\n\tcase CHIP_RV710:\n\tcase CHIP_RV730:\n\tdefault:\n\t\tdb_debug3 |= DB_CLK_OFF_DELAY(2);\n\t\tbreak;\n\t}\n\tWREG32(DB_DEBUG3, db_debug3);\n\n\tif (rdev->family != CHIP_RV770) {\n\t\tdb_debug4 = RREG32(DB_DEBUG4);\n\t\tdb_debug4 |= DISABLE_TILE_COVERED_FOR_PS_ITER;\n\t\tWREG32(DB_DEBUG4, db_debug4);\n\t}\n\n\tWREG32(SX_EXPORT_BUFFER_SIZES, (COLOR_BUFFER_SIZE((rdev->config.rv770.sx_max_export_size / 4) - 1) |\n\t\t\t\t\tPOSITION_BUFFER_SIZE((rdev->config.rv770.sx_max_export_pos_size / 4) - 1) |\n\t\t\t\t\tSMX_BUFFER_SIZE((rdev->config.rv770.sx_max_export_smx_size / 4) - 1)));\n\n\tWREG32(PA_SC_FIFO_SIZE, (SC_PRIM_FIFO_SIZE(rdev->config.rv770.sc_prim_fifo_size) |\n\t\t\t\t SC_HIZ_TILE_FIFO_SIZE(rdev->config.rv770.sc_hiz_tile_fifo_size) |\n\t\t\t\t SC_EARLYZ_TILE_FIFO_SIZE(rdev->config.rv770.sc_earlyz_tile_fifo_fize)));\n\n\tWREG32(PA_SC_MULTI_CHIP_CNTL, 0);\n\n\tWREG32(VGT_NUM_INSTANCES, 1);\n\n\tWREG32(SPI_CONFIG_CNTL_1, VTX_DONE_DELAY(4));\n\n\tWREG32(CP_PERFMON_CNTL, 0);\n\n\tsq_ms_fifo_sizes = (CACHE_FIFO_SIZE(16 * rdev->config.rv770.sq_num_cf_insts) |\n\t\t\t    DONE_FIFO_HIWATER(0xe0) |\n\t\t\t    ALU_UPDATE_FIFO_HIWATER(0x8));\n\tswitch (rdev->family) {\n\tcase CHIP_RV770:\n\tcase CHIP_RV730:\n\tcase CHIP_RV710:\n\t\tsq_ms_fifo_sizes |= FETCH_FIFO_HIWATER(0x1);\n\t\tbreak;\n\tcase CHIP_RV740:\n\tdefault:\n\t\tsq_ms_fifo_sizes |= FETCH_FIFO_HIWATER(0x4);\n\t\tbreak;\n\t}\n\tWREG32(SQ_MS_FIFO_SIZES, sq_ms_fifo_sizes);\n\n\t \n\tsq_config = RREG32(SQ_CONFIG);\n\tsq_config &= ~(PS_PRIO(3) |\n\t\t       VS_PRIO(3) |\n\t\t       GS_PRIO(3) |\n\t\t       ES_PRIO(3));\n\tsq_config |= (DX9_CONSTS |\n\t\t      VC_ENABLE |\n\t\t      EXPORT_SRC_C |\n\t\t      PS_PRIO(0) |\n\t\t      VS_PRIO(1) |\n\t\t      GS_PRIO(2) |\n\t\t      ES_PRIO(3));\n\tif (rdev->family == CHIP_RV710)\n\t\t \n\t\tsq_config &= ~VC_ENABLE;\n\n\tWREG32(SQ_CONFIG, sq_config);\n\n\tWREG32(SQ_GPR_RESOURCE_MGMT_1,  (NUM_PS_GPRS((rdev->config.rv770.max_gprs * 24)/64) |\n\t\t\t\t\t NUM_VS_GPRS((rdev->config.rv770.max_gprs * 24)/64) |\n\t\t\t\t\t NUM_CLAUSE_TEMP_GPRS(((rdev->config.rv770.max_gprs * 24)/64)/2)));\n\n\tWREG32(SQ_GPR_RESOURCE_MGMT_2,  (NUM_GS_GPRS((rdev->config.rv770.max_gprs * 7)/64) |\n\t\t\t\t\t NUM_ES_GPRS((rdev->config.rv770.max_gprs * 7)/64)));\n\n\tsq_thread_resource_mgmt = (NUM_PS_THREADS((rdev->config.rv770.max_threads * 4)/8) |\n\t\t\t\t   NUM_VS_THREADS((rdev->config.rv770.max_threads * 2)/8) |\n\t\t\t\t   NUM_ES_THREADS((rdev->config.rv770.max_threads * 1)/8));\n\tif (((rdev->config.rv770.max_threads * 1) / 8) > rdev->config.rv770.max_gs_threads)\n\t\tsq_thread_resource_mgmt |= NUM_GS_THREADS(rdev->config.rv770.max_gs_threads);\n\telse\n\t\tsq_thread_resource_mgmt |= NUM_GS_THREADS((rdev->config.rv770.max_gs_threads * 1)/8);\n\tWREG32(SQ_THREAD_RESOURCE_MGMT, sq_thread_resource_mgmt);\n\n\tWREG32(SQ_STACK_RESOURCE_MGMT_1, (NUM_PS_STACK_ENTRIES((rdev->config.rv770.max_stack_entries * 1)/4) |\n\t\t\t\t\t\t     NUM_VS_STACK_ENTRIES((rdev->config.rv770.max_stack_entries * 1)/4)));\n\n\tWREG32(SQ_STACK_RESOURCE_MGMT_2, (NUM_GS_STACK_ENTRIES((rdev->config.rv770.max_stack_entries * 1)/4) |\n\t\t\t\t\t\t     NUM_ES_STACK_ENTRIES((rdev->config.rv770.max_stack_entries * 1)/4)));\n\n\tsq_dyn_gpr_size_simd_ab_0 = (SIMDA_RING0((rdev->config.rv770.max_gprs * 38)/64) |\n\t\t\t\t     SIMDA_RING1((rdev->config.rv770.max_gprs * 38)/64) |\n\t\t\t\t     SIMDB_RING0((rdev->config.rv770.max_gprs * 38)/64) |\n\t\t\t\t     SIMDB_RING1((rdev->config.rv770.max_gprs * 38)/64));\n\n\tWREG32(SQ_DYN_GPR_SIZE_SIMD_AB_0, sq_dyn_gpr_size_simd_ab_0);\n\tWREG32(SQ_DYN_GPR_SIZE_SIMD_AB_1, sq_dyn_gpr_size_simd_ab_0);\n\tWREG32(SQ_DYN_GPR_SIZE_SIMD_AB_2, sq_dyn_gpr_size_simd_ab_0);\n\tWREG32(SQ_DYN_GPR_SIZE_SIMD_AB_3, sq_dyn_gpr_size_simd_ab_0);\n\tWREG32(SQ_DYN_GPR_SIZE_SIMD_AB_4, sq_dyn_gpr_size_simd_ab_0);\n\tWREG32(SQ_DYN_GPR_SIZE_SIMD_AB_5, sq_dyn_gpr_size_simd_ab_0);\n\tWREG32(SQ_DYN_GPR_SIZE_SIMD_AB_6, sq_dyn_gpr_size_simd_ab_0);\n\tWREG32(SQ_DYN_GPR_SIZE_SIMD_AB_7, sq_dyn_gpr_size_simd_ab_0);\n\n\tWREG32(PA_SC_FORCE_EOV_MAX_CNTS, (FORCE_EOV_MAX_CLK_CNT(4095) |\n\t\t\t\t\t  FORCE_EOV_MAX_REZ_CNT(255)));\n\n\tif (rdev->family == CHIP_RV710)\n\t\tWREG32(VGT_CACHE_INVALIDATION, (CACHE_INVALIDATION(TC_ONLY) |\n\t\t\t\t\t\tAUTO_INVLD_EN(ES_AND_GS_AUTO)));\n\telse\n\t\tWREG32(VGT_CACHE_INVALIDATION, (CACHE_INVALIDATION(VC_AND_TC) |\n\t\t\t\t\t\tAUTO_INVLD_EN(ES_AND_GS_AUTO)));\n\n\tswitch (rdev->family) {\n\tcase CHIP_RV770:\n\tcase CHIP_RV730:\n\tcase CHIP_RV740:\n\t\tgs_prim_buffer_depth = 384;\n\t\tbreak;\n\tcase CHIP_RV710:\n\t\tgs_prim_buffer_depth = 128;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tnum_gs_verts_per_thread = rdev->config.rv770.max_pipes * 16;\n\tvgt_gs_per_es = gs_prim_buffer_depth + num_gs_verts_per_thread;\n\t \n\tif (vgt_gs_per_es > 256)\n\t\tvgt_gs_per_es = 256;\n\n\tWREG32(VGT_ES_PER_GS, 128);\n\tWREG32(VGT_GS_PER_ES, vgt_gs_per_es);\n\tWREG32(VGT_GS_PER_VS, 2);\n\n\t \n\tWREG32(VGT_GS_VERTEX_REUSE, 16);\n\tWREG32(PA_SC_LINE_STIPPLE_STATE, 0);\n\tWREG32(VGT_STRMOUT_EN, 0);\n\tWREG32(SX_MISC, 0);\n\tWREG32(PA_SC_MODE_CNTL, 0);\n\tWREG32(PA_SC_EDGERULE, 0xaaaaaaaa);\n\tWREG32(PA_SC_AA_CONFIG, 0);\n\tWREG32(PA_SC_CLIPRECT_RULE, 0xffff);\n\tWREG32(PA_SC_LINE_STIPPLE, 0);\n\tWREG32(SPI_INPUT_Z, 0);\n\tWREG32(SPI_PS_IN_CONTROL_0, NUM_INTERP(2));\n\tWREG32(CB_COLOR7_FRAG, 0);\n\n\t \n\tWREG32(CB_COLOR0_BASE, 0);\n\tWREG32(CB_COLOR1_BASE, 0);\n\tWREG32(CB_COLOR2_BASE, 0);\n\tWREG32(CB_COLOR3_BASE, 0);\n\tWREG32(CB_COLOR4_BASE, 0);\n\tWREG32(CB_COLOR5_BASE, 0);\n\tWREG32(CB_COLOR6_BASE, 0);\n\tWREG32(CB_COLOR7_BASE, 0);\n\n\tWREG32(TCP_CNTL, 0);\n\n\thdp_host_path_cntl = RREG32(HDP_HOST_PATH_CNTL);\n\tWREG32(HDP_HOST_PATH_CNTL, hdp_host_path_cntl);\n\n\tWREG32(PA_SC_MULTI_CHIP_CNTL, 0);\n\n\tWREG32(PA_CL_ENHANCE, (CLIP_VTX_REORDER_ENA |\n\t\t\t\t\t  NUM_CLIP_SEQ(3)));\n\tWREG32(VC_ENHANCE, 0);\n}\n\nvoid r700_vram_gtt_location(struct radeon_device *rdev, struct radeon_mc *mc)\n{\n\tu64 size_bf, size_af;\n\n\tif (mc->mc_vram_size > 0xE0000000) {\n\t\t \n\t\tdev_warn(rdev->dev, \"limiting VRAM\\n\");\n\t\tmc->real_vram_size = 0xE0000000;\n\t\tmc->mc_vram_size = 0xE0000000;\n\t}\n\tif (rdev->flags & RADEON_IS_AGP) {\n\t\tsize_bf = mc->gtt_start;\n\t\tsize_af = mc->mc_mask - mc->gtt_end;\n\t\tif (size_bf > size_af) {\n\t\t\tif (mc->mc_vram_size > size_bf) {\n\t\t\t\tdev_warn(rdev->dev, \"limiting VRAM\\n\");\n\t\t\t\tmc->real_vram_size = size_bf;\n\t\t\t\tmc->mc_vram_size = size_bf;\n\t\t\t}\n\t\t\tmc->vram_start = mc->gtt_start - mc->mc_vram_size;\n\t\t} else {\n\t\t\tif (mc->mc_vram_size > size_af) {\n\t\t\t\tdev_warn(rdev->dev, \"limiting VRAM\\n\");\n\t\t\t\tmc->real_vram_size = size_af;\n\t\t\t\tmc->mc_vram_size = size_af;\n\t\t\t}\n\t\t\tmc->vram_start = mc->gtt_end + 1;\n\t\t}\n\t\tmc->vram_end = mc->vram_start + mc->mc_vram_size - 1;\n\t\tdev_info(rdev->dev, \"VRAM: %lluM 0x%08llX - 0x%08llX (%lluM used)\\n\",\n\t\t\t\tmc->mc_vram_size >> 20, mc->vram_start,\n\t\t\t\tmc->vram_end, mc->real_vram_size >> 20);\n\t} else {\n\t\tradeon_vram_location(rdev, &rdev->mc, 0);\n\t\trdev->mc.gtt_base_align = 0;\n\t\tradeon_gtt_location(rdev, mc);\n\t}\n}\n\nstatic int rv770_mc_init(struct radeon_device *rdev)\n{\n\tu32 tmp;\n\tint chansize, numchan;\n\n\t \n\trdev->mc.vram_is_ddr = true;\n\ttmp = RREG32(MC_ARB_RAMCFG);\n\tif (tmp & CHANSIZE_OVERRIDE) {\n\t\tchansize = 16;\n\t} else if (tmp & CHANSIZE_MASK) {\n\t\tchansize = 64;\n\t} else {\n\t\tchansize = 32;\n\t}\n\ttmp = RREG32(MC_SHARED_CHMAP);\n\tswitch ((tmp & NOOFCHAN_MASK) >> NOOFCHAN_SHIFT) {\n\tcase 0:\n\tdefault:\n\t\tnumchan = 1;\n\t\tbreak;\n\tcase 1:\n\t\tnumchan = 2;\n\t\tbreak;\n\tcase 2:\n\t\tnumchan = 4;\n\t\tbreak;\n\tcase 3:\n\t\tnumchan = 8;\n\t\tbreak;\n\t}\n\trdev->mc.vram_width = numchan * chansize;\n\t \n\trdev->mc.aper_base = pci_resource_start(rdev->pdev, 0);\n\trdev->mc.aper_size = pci_resource_len(rdev->pdev, 0);\n\t \n\trdev->mc.mc_vram_size = RREG32(CONFIG_MEMSIZE);\n\trdev->mc.real_vram_size = RREG32(CONFIG_MEMSIZE);\n\trdev->mc.visible_vram_size = rdev->mc.aper_size;\n\tr700_vram_gtt_location(rdev, &rdev->mc);\n\tradeon_update_bandwidth_info(rdev);\n\n\treturn 0;\n}\n\nstatic void rv770_uvd_init(struct radeon_device *rdev)\n{\n\tint r;\n\n\tif (!rdev->has_uvd)\n\t\treturn;\n\n\tr = radeon_uvd_init(rdev);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed UVD (%d) init.\\n\", r);\n\t\t \n\t\trdev->has_uvd = false;\n\t\treturn;\n\t}\n\trdev->ring[R600_RING_TYPE_UVD_INDEX].ring_obj = NULL;\n\tr600_ring_init(rdev, &rdev->ring[R600_RING_TYPE_UVD_INDEX], 4096);\n}\n\nstatic void rv770_uvd_start(struct radeon_device *rdev)\n{\n\tint r;\n\n\tif (!rdev->has_uvd)\n\t\treturn;\n\n\tr = uvd_v2_2_resume(rdev);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed UVD resume (%d).\\n\", r);\n\t\tgoto error;\n\t}\n\tr = radeon_fence_driver_start_ring(rdev, R600_RING_TYPE_UVD_INDEX);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed initializing UVD fences (%d).\\n\", r);\n\t\tgoto error;\n\t}\n\treturn;\n\nerror:\n\trdev->ring[R600_RING_TYPE_UVD_INDEX].ring_size = 0;\n}\n\nstatic void rv770_uvd_resume(struct radeon_device *rdev)\n{\n\tstruct radeon_ring *ring;\n\tint r;\n\n\tif (!rdev->has_uvd || !rdev->ring[R600_RING_TYPE_UVD_INDEX].ring_size)\n\t\treturn;\n\n\tring = &rdev->ring[R600_RING_TYPE_UVD_INDEX];\n\tr = radeon_ring_init(rdev, ring, ring->ring_size, 0, PACKET0(UVD_NO_OP, 0));\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed initializing UVD ring (%d).\\n\", r);\n\t\treturn;\n\t}\n\tr = uvd_v1_0_init(rdev);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed initializing UVD (%d).\\n\", r);\n\t\treturn;\n\t}\n}\n\nstatic int rv770_startup(struct radeon_device *rdev)\n{\n\tstruct radeon_ring *ring;\n\tint r;\n\n\t \n\trv770_pcie_gen2_enable(rdev);\n\n\t \n\tr = r600_vram_scratch_init(rdev);\n\tif (r)\n\t\treturn r;\n\n\trv770_mc_program(rdev);\n\n\tif (rdev->flags & RADEON_IS_AGP) {\n\t\trv770_agp_enable(rdev);\n\t} else {\n\t\tr = rv770_pcie_gart_enable(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\n\trv770_gpu_init(rdev);\n\n\t \n\tr = radeon_wb_init(rdev);\n\tif (r)\n\t\treturn r;\n\n\tr = radeon_fence_driver_start_ring(rdev, RADEON_RING_TYPE_GFX_INDEX);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed initializing CP fences (%d).\\n\", r);\n\t\treturn r;\n\t}\n\n\tr = radeon_fence_driver_start_ring(rdev, R600_RING_TYPE_DMA_INDEX);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"failed initializing DMA fences (%d).\\n\", r);\n\t\treturn r;\n\t}\n\n\trv770_uvd_start(rdev);\n\n\t \n\tif (!rdev->irq.installed) {\n\t\tr = radeon_irq_kms_init(rdev);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\n\tr = r600_irq_init(rdev);\n\tif (r) {\n\t\tDRM_ERROR(\"radeon: IH init failed (%d).\\n\", r);\n\t\tradeon_irq_kms_fini(rdev);\n\t\treturn r;\n\t}\n\tr600_irq_set(rdev);\n\n\tring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\n\tr = radeon_ring_init(rdev, ring, ring->ring_size, RADEON_WB_CP_RPTR_OFFSET,\n\t\t\t     RADEON_CP_PACKET2);\n\tif (r)\n\t\treturn r;\n\n\tring = &rdev->ring[R600_RING_TYPE_DMA_INDEX];\n\tr = radeon_ring_init(rdev, ring, ring->ring_size, R600_WB_DMA_RPTR_OFFSET,\n\t\t\t     DMA_PACKET(DMA_PACKET_NOP, 0, 0, 0));\n\tif (r)\n\t\treturn r;\n\n\tr = rv770_cp_load_microcode(rdev);\n\tif (r)\n\t\treturn r;\n\tr = r600_cp_resume(rdev);\n\tif (r)\n\t\treturn r;\n\n\tr = r600_dma_resume(rdev);\n\tif (r)\n\t\treturn r;\n\n\trv770_uvd_resume(rdev);\n\n\tr = radeon_ib_pool_init(rdev);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"IB initialization failed (%d).\\n\", r);\n\t\treturn r;\n\t}\n\n\tr = radeon_audio_init(rdev);\n\tif (r) {\n\t\tDRM_ERROR(\"radeon: audio init failed\\n\");\n\t\treturn r;\n\t}\n\n\treturn 0;\n}\n\nint rv770_resume(struct radeon_device *rdev)\n{\n\tint r;\n\n\t \n\t \n\tatom_asic_init(rdev->mode_info.atom_context);\n\n\t \n\trv770_init_golden_registers(rdev);\n\n\tif (rdev->pm.pm_method == PM_METHOD_DPM)\n\t\tradeon_pm_resume(rdev);\n\n\trdev->accel_working = true;\n\tr = rv770_startup(rdev);\n\tif (r) {\n\t\tDRM_ERROR(\"r600 startup failed on resume\\n\");\n\t\trdev->accel_working = false;\n\t\treturn r;\n\t}\n\n\treturn r;\n\n}\n\nint rv770_suspend(struct radeon_device *rdev)\n{\n\tradeon_pm_suspend(rdev);\n\tradeon_audio_fini(rdev);\n\tif (rdev->has_uvd) {\n\t\tradeon_uvd_suspend(rdev);\n\t\tuvd_v1_0_fini(rdev);\n\t}\n\tr700_cp_stop(rdev);\n\tr600_dma_stop(rdev);\n\tr600_irq_suspend(rdev);\n\tradeon_wb_disable(rdev);\n\trv770_pcie_gart_disable(rdev);\n\n\treturn 0;\n}\n\n \nint rv770_init(struct radeon_device *rdev)\n{\n\tint r;\n\n\t \n\tif (!radeon_get_bios(rdev)) {\n\t\tif (ASIC_IS_AVIVO(rdev))\n\t\t\treturn -EINVAL;\n\t}\n\t \n\tif (!rdev->is_atom_bios) {\n\t\tdev_err(rdev->dev, \"Expecting atombios for R600 GPU\\n\");\n\t\treturn -EINVAL;\n\t}\n\tr = radeon_atombios_init(rdev);\n\tif (r)\n\t\treturn r;\n\t \n\tif (!radeon_card_posted(rdev)) {\n\t\tif (!rdev->bios) {\n\t\t\tdev_err(rdev->dev, \"Card not posted and no BIOS - ignoring\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tDRM_INFO(\"GPU not posted. posting now...\\n\");\n\t\tatom_asic_init(rdev->mode_info.atom_context);\n\t}\n\t \n\trv770_init_golden_registers(rdev);\n\t \n\tr600_scratch_init(rdev);\n\t \n\tradeon_surface_init(rdev);\n\t \n\tradeon_get_clock_info(rdev->ddev);\n\t \n\tradeon_fence_driver_init(rdev);\n\t \n\tif (rdev->flags & RADEON_IS_AGP) {\n\t\tr = radeon_agp_init(rdev);\n\t\tif (r)\n\t\t\tradeon_agp_disable(rdev);\n\t}\n\tr = rv770_mc_init(rdev);\n\tif (r)\n\t\treturn r;\n\t \n\tr = radeon_bo_init(rdev);\n\tif (r)\n\t\treturn r;\n\n\tif (!rdev->me_fw || !rdev->pfp_fw || !rdev->rlc_fw) {\n\t\tr = r600_init_microcode(rdev);\n\t\tif (r) {\n\t\t\tDRM_ERROR(\"Failed to load firmware!\\n\");\n\t\t\treturn r;\n\t\t}\n\t}\n\n\t \n\tradeon_pm_init(rdev);\n\n\trdev->ring[RADEON_RING_TYPE_GFX_INDEX].ring_obj = NULL;\n\tr600_ring_init(rdev, &rdev->ring[RADEON_RING_TYPE_GFX_INDEX], 1024 * 1024);\n\n\trdev->ring[R600_RING_TYPE_DMA_INDEX].ring_obj = NULL;\n\tr600_ring_init(rdev, &rdev->ring[R600_RING_TYPE_DMA_INDEX], 64 * 1024);\n\n\trv770_uvd_init(rdev);\n\n\trdev->ih.ring_obj = NULL;\n\tr600_ih_ring_init(rdev, 64 * 1024);\n\n\tr = r600_pcie_gart_init(rdev);\n\tif (r)\n\t\treturn r;\n\n\trdev->accel_working = true;\n\tr = rv770_startup(rdev);\n\tif (r) {\n\t\tdev_err(rdev->dev, \"disabling GPU acceleration\\n\");\n\t\tr700_cp_fini(rdev);\n\t\tr600_dma_fini(rdev);\n\t\tr600_irq_fini(rdev);\n\t\tradeon_wb_fini(rdev);\n\t\tradeon_ib_pool_fini(rdev);\n\t\tradeon_irq_kms_fini(rdev);\n\t\trv770_pcie_gart_fini(rdev);\n\t\trdev->accel_working = false;\n\t}\n\n\treturn 0;\n}\n\nvoid rv770_fini(struct radeon_device *rdev)\n{\n\tradeon_pm_fini(rdev);\n\tr700_cp_fini(rdev);\n\tr600_dma_fini(rdev);\n\tr600_irq_fini(rdev);\n\tradeon_wb_fini(rdev);\n\tradeon_ib_pool_fini(rdev);\n\tradeon_irq_kms_fini(rdev);\n\tuvd_v1_0_fini(rdev);\n\tradeon_uvd_fini(rdev);\n\trv770_pcie_gart_fini(rdev);\n\tr600_vram_scratch_fini(rdev);\n\tradeon_gem_fini(rdev);\n\tradeon_fence_driver_fini(rdev);\n\tradeon_agp_fini(rdev);\n\tradeon_bo_fini(rdev);\n\tradeon_atombios_fini(rdev);\n\tkfree(rdev->bios);\n\trdev->bios = NULL;\n}\n\nstatic void rv770_pcie_gen2_enable(struct radeon_device *rdev)\n{\n\tu32 link_width_cntl, lanes, speed_cntl, tmp;\n\tu16 link_cntl2;\n\n\tif (radeon_pcie_gen2 == 0)\n\t\treturn;\n\n\tif (rdev->flags & RADEON_IS_IGP)\n\t\treturn;\n\n\tif (!(rdev->flags & RADEON_IS_PCIE))\n\t\treturn;\n\n\t \n\tif (ASIC_IS_X2(rdev))\n\t\treturn;\n\n\tif ((rdev->pdev->bus->max_bus_speed != PCIE_SPEED_5_0GT) &&\n\t\t(rdev->pdev->bus->max_bus_speed != PCIE_SPEED_8_0GT))\n\t\treturn;\n\n\tDRM_INFO(\"enabling PCIE gen 2 link speeds, disable with radeon.pcie_gen2=0\\n\");\n\n\t \n\tlink_width_cntl = RREG32_PCIE_PORT(PCIE_LC_LINK_WIDTH_CNTL);\n\tlink_width_cntl &= ~LC_UPCONFIGURE_DIS;\n\tWREG32_PCIE_PORT(PCIE_LC_LINK_WIDTH_CNTL, link_width_cntl);\n\tlink_width_cntl = RREG32_PCIE_PORT(PCIE_LC_LINK_WIDTH_CNTL);\n\tif (link_width_cntl & LC_RENEGOTIATION_SUPPORT) {\n\t\tlanes = (link_width_cntl & LC_LINK_WIDTH_RD_MASK) >> LC_LINK_WIDTH_RD_SHIFT;\n\t\tlink_width_cntl &= ~(LC_LINK_WIDTH_MASK |\n\t\t\t\t     LC_RECONFIG_ARC_MISSING_ESCAPE);\n\t\tlink_width_cntl |= lanes | LC_RECONFIG_NOW |\n\t\t\tLC_RENEGOTIATE_EN | LC_UPCONFIGURE_SUPPORT;\n\t\tWREG32_PCIE_PORT(PCIE_LC_LINK_WIDTH_CNTL, link_width_cntl);\n\t} else {\n\t\tlink_width_cntl |= LC_UPCONFIGURE_DIS;\n\t\tWREG32_PCIE_PORT(PCIE_LC_LINK_WIDTH_CNTL, link_width_cntl);\n\t}\n\n\tspeed_cntl = RREG32_PCIE_PORT(PCIE_LC_SPEED_CNTL);\n\tif ((speed_cntl & LC_OTHER_SIDE_EVER_SENT_GEN2) &&\n\t    (speed_cntl & LC_OTHER_SIDE_SUPPORTS_GEN2)) {\n\n\t\ttmp = RREG32(0x541c);\n\t\tWREG32(0x541c, tmp | 0x8);\n\t\tWREG32(MM_CFGREGS_CNTL, MM_WR_TO_CFG_EN);\n\t\tlink_cntl2 = RREG16(0x4088);\n\t\tlink_cntl2 &= ~TARGET_LINK_SPEED_MASK;\n\t\tlink_cntl2 |= 0x2;\n\t\tWREG16(0x4088, link_cntl2);\n\t\tWREG32(MM_CFGREGS_CNTL, 0);\n\n\t\tspeed_cntl = RREG32_PCIE_PORT(PCIE_LC_SPEED_CNTL);\n\t\tspeed_cntl &= ~LC_TARGET_LINK_SPEED_OVERRIDE_EN;\n\t\tWREG32_PCIE_PORT(PCIE_LC_SPEED_CNTL, speed_cntl);\n\n\t\tspeed_cntl = RREG32_PCIE_PORT(PCIE_LC_SPEED_CNTL);\n\t\tspeed_cntl |= LC_CLR_FAILED_SPD_CHANGE_CNT;\n\t\tWREG32_PCIE_PORT(PCIE_LC_SPEED_CNTL, speed_cntl);\n\n\t\tspeed_cntl = RREG32_PCIE_PORT(PCIE_LC_SPEED_CNTL);\n\t\tspeed_cntl &= ~LC_CLR_FAILED_SPD_CHANGE_CNT;\n\t\tWREG32_PCIE_PORT(PCIE_LC_SPEED_CNTL, speed_cntl);\n\n\t\tspeed_cntl = RREG32_PCIE_PORT(PCIE_LC_SPEED_CNTL);\n\t\tspeed_cntl |= LC_GEN2_EN_STRAP;\n\t\tWREG32_PCIE_PORT(PCIE_LC_SPEED_CNTL, speed_cntl);\n\n\t} else {\n\t\tlink_width_cntl = RREG32_PCIE_PORT(PCIE_LC_LINK_WIDTH_CNTL);\n\t\t \n\t\tif (1)\n\t\t\tlink_width_cntl |= LC_UPCONFIGURE_DIS;\n\t\telse\n\t\t\tlink_width_cntl &= ~LC_UPCONFIGURE_DIS;\n\t\tWREG32_PCIE_PORT(PCIE_LC_LINK_WIDTH_CNTL, link_width_cntl);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}