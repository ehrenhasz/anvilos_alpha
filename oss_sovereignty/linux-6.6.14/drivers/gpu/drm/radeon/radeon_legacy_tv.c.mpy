{
  "module_name": "radeon_legacy_tv.c",
  "hash_id": "3c89af64960a16fbbfc6f4512e754c9edf4a9f4d54c855475f90df7c9a236951",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/radeon_legacy_tv.c",
  "human_readable_source": "\n\n#include <drm/drm_device.h>\n\n#include \"radeon.h\"\n\n \n\n\n \n#define MAX_H_POSITION 5  \n#define MAX_V_POSITION 5  \n\n \n#define H_POS_UNIT 10\n\n \n#define H_TABLE_POS1 6\n#define H_TABLE_POS2 8\n\n \n#define MAX_H_SIZE 5  \n\n \n#define NTSC_TV_CLOCK_T 233\n#define NTSC_TV_VFTOTAL 1\n#define NTSC_TV_LINES_PER_FRAME 525\n#define NTSC_TV_ZERO_H_SIZE 479166\n#define NTSC_TV_H_SIZE_UNIT 9478\n\n#define PAL_TV_CLOCK_T 188\n#define PAL_TV_VFTOTAL 3\n#define PAL_TV_LINES_PER_FRAME 625\n#define PAL_TV_ZERO_H_SIZE 473200\n#define PAL_TV_H_SIZE_UNIT 9360\n\n \n#define NTSC_TV_PLL_M_27 22\n#define NTSC_TV_PLL_N_27 175\n#define NTSC_TV_PLL_P_27 5\n\n#define PAL_TV_PLL_M_27 113\n#define PAL_TV_PLL_N_27 668\n#define PAL_TV_PLL_P_27 3\n\n \n#define NTSC_TV_PLL_M_14 33\n#define NTSC_TV_PLL_N_14 693\n#define NTSC_TV_PLL_P_14 7\n\n#define PAL_TV_PLL_M_14 19\n#define PAL_TV_PLL_N_14 353\n#define PAL_TV_PLL_P_14 5\n\n#define VERT_LEAD_IN_LINES 2\n#define FRAC_BITS 0xe\n#define FRAC_MASK 0x3fff\n\nstruct radeon_tv_mode_constants {\n\tuint16_t hor_resolution;\n\tuint16_t ver_resolution;\n\tenum radeon_tv_std standard;\n\tuint16_t hor_total;\n\tuint16_t ver_total;\n\tuint16_t hor_start;\n\tuint16_t hor_syncstart;\n\tuint16_t ver_syncstart;\n\tunsigned def_restart;\n\tuint16_t crtcPLL_N;\n\tuint8_t  crtcPLL_M;\n\tuint8_t  crtcPLL_post_div;\n\tunsigned pix_to_tv;\n};\n\nstatic const uint16_t hor_timing_NTSC[MAX_H_CODE_TIMING_LEN] = {\n\t0x0007,\n\t0x003f,\n\t0x0263,\n\t0x0a24,\n\t0x2a6b,\n\t0x0a36,\n\t0x126d,  \n\t0x1bfe,\n\t0x1a8f,  \n\t0x1ec7,\n\t0x3863,\n\t0x1bfe,\n\t0x1bfe,\n\t0x1a2a,\n\t0x1e95,\n\t0x0e31,\n\t0x201b,\n\t0\n};\n\nstatic const uint16_t vert_timing_NTSC[MAX_V_CODE_TIMING_LEN] = {\n\t0x2001,\n\t0x200d,\n\t0x1006,\n\t0x0c06,\n\t0x1006,\n\t0x1818,\n\t0x21e3,\n\t0x1006,\n\t0x0c06,\n\t0x1006,\n\t0x1817,\n\t0x21d4,\n\t0x0002,\n\t0\n};\n\nstatic const uint16_t hor_timing_PAL[MAX_H_CODE_TIMING_LEN] = {\n\t0x0007,\n\t0x0058,\n\t0x027c,\n\t0x0a31,\n\t0x2a77,\n\t0x0a95,\n\t0x124f,  \n\t0x1bfe,\n\t0x1b22,  \n\t0x1ef9,\n\t0x387c,\n\t0x1bfe,\n\t0x1bfe,\n\t0x1b31,\n\t0x1eb5,\n\t0x0e43,\n\t0x201b,\n\t0\n};\n\nstatic const uint16_t vert_timing_PAL[MAX_V_CODE_TIMING_LEN] = {\n\t0x2001,\n\t0x200c,\n\t0x1005,\n\t0x0c05,\n\t0x1005,\n\t0x1401,\n\t0x1821,\n\t0x2240,\n\t0x1005,\n\t0x0c05,\n\t0x1005,\n\t0x1401,\n\t0x1822,\n\t0x2230,\n\t0x0002,\n\t0\n};\n\n \nstatic const struct radeon_tv_mode_constants available_tv_modes[] = {\n\t{    \n\t\t800,                 \n\t\t600,                 \n\t\tTV_STD_NTSC,         \n\t\t990,                 \n\t\t740,                 \n\t\t813,                 \n\t\t824,                 \n\t\t632,                 \n\t\t625592,              \n\t\t592,                 \n\t\t91,                  \n\t\t4,                   \n\t\t1022,                \n\t},\n\t{    \n\t\t800,                \n\t\t600,                \n\t\tTV_STD_PAL,         \n\t\t1144,               \n\t\t706,                \n\t\t812,                \n\t\t824,                \n\t\t669,                \n\t\t696700,             \n\t\t1382,               \n\t\t231,                \n\t\t4,                  \n\t\t759,                \n\t},\n\t{    \n\t\t800,                 \n\t\t600,                 \n\t\tTV_STD_NTSC,         \n\t\t1018,                \n\t\t727,                 \n\t\t813,                 \n\t\t840,                 \n\t\t633,                 \n\t\t630627,              \n\t\t347,                 \n\t\t14,                  \n\t\t8,                   \n\t\t1022,                \n\t},\n\t{  \n\t\t800,                 \n\t\t600,                 \n\t\tTV_STD_PAL,          \n\t\t1131,                \n\t\t742,                 \n\t\t813,                 \n\t\t840,                 \n\t\t633,                 \n\t\t708369,              \n\t\t211,                 \n\t\t9,                   \n\t\t8,                   \n\t\t759,                 \n\t},\n};\n\n#define N_AVAILABLE_MODES ARRAY_SIZE(available_tv_modes)\n\nstatic const struct radeon_tv_mode_constants *radeon_legacy_tv_get_std_mode(struct radeon_encoder *radeon_encoder,\n\t\t\t\t\t\t\t\t\t    uint16_t *pll_ref_freq)\n{\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_crtc *radeon_crtc;\n\tstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\n\tconst struct radeon_tv_mode_constants *const_ptr;\n\tstruct radeon_pll *pll;\n\n\tradeon_crtc = to_radeon_crtc(radeon_encoder->base.crtc);\n\tif (radeon_crtc->crtc_id == 1)\n\t\tpll = &rdev->clock.p2pll;\n\telse\n\t\tpll = &rdev->clock.p1pll;\n\n\tif (pll_ref_freq)\n\t\t*pll_ref_freq = pll->reference_freq;\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t    tv_dac->tv_std == TV_STD_PAL_M) {\n\t\tif (pll->reference_freq == 2700)\n\t\t\tconst_ptr = &available_tv_modes[0];\n\t\telse\n\t\t\tconst_ptr = &available_tv_modes[2];\n\t} else {\n\t\tif (pll->reference_freq == 2700)\n\t\t\tconst_ptr = &available_tv_modes[1];\n\t\telse\n\t\t\tconst_ptr = &available_tv_modes[3];\n\t}\n\treturn const_ptr;\n}\n\nstatic long YCOEF_value[5] = { 2, 2, 0, 4, 0 };\nstatic long YCOEF_EN_value[5] = { 1, 1, 0, 1, 0 };\nstatic long SLOPE_value[5] = { 1, 2, 2, 4, 8 };\nstatic long SLOPE_limit[5] = { 6, 5, 4, 3, 2 };\n\nstatic void radeon_wait_pll_lock(struct drm_encoder *encoder, unsigned n_tests,\n\t\t\t\t unsigned n_wait_loops, unsigned cnt_threshold)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t save_pll_test;\n\tunsigned int i, j;\n\n\tWREG32(RADEON_TEST_DEBUG_MUX, (RREG32(RADEON_TEST_DEBUG_MUX) & 0xffff60ff) | 0x100);\n\tsave_pll_test = RREG32_PLL(RADEON_PLL_TEST_CNTL);\n\tWREG32_PLL(RADEON_PLL_TEST_CNTL, save_pll_test & ~RADEON_PLL_MASK_READ_B);\n\n\tWREG8(RADEON_CLOCK_CNTL_INDEX, RADEON_PLL_TEST_CNTL);\n\tfor (i = 0; i < n_tests; i++) {\n\t\tWREG8(RADEON_CLOCK_CNTL_DATA + 3, 0);\n\t\tfor (j = 0; j < n_wait_loops; j++)\n\t\t\tif (RREG8(RADEON_CLOCK_CNTL_DATA + 3) >= cnt_threshold)\n\t\t\t\tbreak;\n\t}\n\tWREG32_PLL(RADEON_PLL_TEST_CNTL, save_pll_test);\n\tWREG32(RADEON_TEST_DEBUG_MUX, RREG32(RADEON_TEST_DEBUG_MUX) & 0xffffe0ff);\n}\n\n\nstatic void radeon_legacy_tv_write_fifo(struct radeon_encoder *radeon_encoder,\n\t\t\t\t\tuint16_t addr, uint32_t value)\n{\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t tmp;\n\tint i = 0;\n\n\tWREG32(RADEON_TV_HOST_WRITE_DATA, value);\n\n\tWREG32(RADEON_TV_HOST_RD_WT_CNTL, addr);\n\tWREG32(RADEON_TV_HOST_RD_WT_CNTL, addr | RADEON_HOST_FIFO_WT);\n\n\tdo {\n\t\ttmp = RREG32(RADEON_TV_HOST_RD_WT_CNTL);\n\t\tif ((tmp & RADEON_HOST_FIFO_WT_ACK) == 0)\n\t\t\tbreak;\n\t\ti++;\n\t} while (i < 10000);\n\tWREG32(RADEON_TV_HOST_RD_WT_CNTL, 0);\n}\n\n#if 0  \nstatic uint32_t radeon_legacy_tv_read_fifo(struct radeon_encoder *radeon_encoder, uint16_t addr)\n{\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tuint32_t tmp;\n\tint i = 0;\n\n\tWREG32(RADEON_TV_HOST_RD_WT_CNTL, addr);\n\tWREG32(RADEON_TV_HOST_RD_WT_CNTL, addr | RADEON_HOST_FIFO_RD);\n\n\tdo {\n\t\ttmp = RREG32(RADEON_TV_HOST_RD_WT_CNTL);\n\t\tif ((tmp & RADEON_HOST_FIFO_RD_ACK) == 0)\n\t\t\tbreak;\n\t\ti++;\n\t} while (i < 10000);\n\tWREG32(RADEON_TV_HOST_RD_WT_CNTL, 0);\n\treturn RREG32(RADEON_TV_HOST_READ_DATA);\n}\n#endif\n\nstatic uint16_t radeon_get_htiming_tables_addr(uint32_t tv_uv_adr)\n{\n\tuint16_t h_table;\n\n\tswitch ((tv_uv_adr & RADEON_HCODE_TABLE_SEL_MASK) >> RADEON_HCODE_TABLE_SEL_SHIFT) {\n\tcase 0:\n\t\th_table = RADEON_TV_MAX_FIFO_ADDR_INTERNAL;\n\t\tbreak;\n\tcase 1:\n\t\th_table = ((tv_uv_adr & RADEON_TABLE1_BOT_ADR_MASK) >> RADEON_TABLE1_BOT_ADR_SHIFT) * 2;\n\t\tbreak;\n\tcase 2:\n\t\th_table = ((tv_uv_adr & RADEON_TABLE3_TOP_ADR_MASK) >> RADEON_TABLE3_TOP_ADR_SHIFT) * 2;\n\t\tbreak;\n\tdefault:\n\t\th_table = 0;\n\t\tbreak;\n\t}\n\treturn h_table;\n}\n\nstatic uint16_t radeon_get_vtiming_tables_addr(uint32_t tv_uv_adr)\n{\n\tuint16_t v_table;\n\n\tswitch ((tv_uv_adr & RADEON_VCODE_TABLE_SEL_MASK) >> RADEON_VCODE_TABLE_SEL_SHIFT) {\n\tcase 0:\n\t\tv_table = ((tv_uv_adr & RADEON_MAX_UV_ADR_MASK) >> RADEON_MAX_UV_ADR_SHIFT) * 2 + 1;\n\t\tbreak;\n\tcase 1:\n\t\tv_table = ((tv_uv_adr & RADEON_TABLE1_BOT_ADR_MASK) >> RADEON_TABLE1_BOT_ADR_SHIFT) * 2 + 1;\n\t\tbreak;\n\tcase 2:\n\t\tv_table = ((tv_uv_adr & RADEON_TABLE3_TOP_ADR_MASK) >> RADEON_TABLE3_TOP_ADR_SHIFT) * 2 + 1;\n\t\tbreak;\n\tdefault:\n\t\tv_table = 0;\n\t\tbreak;\n\t}\n\treturn v_table;\n}\n\nstatic void radeon_restore_tv_timing_tables(struct radeon_encoder *radeon_encoder)\n{\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\n\tuint16_t h_table, v_table;\n\tuint32_t tmp;\n\tint i;\n\n\tWREG32(RADEON_TV_UV_ADR, tv_dac->tv.tv_uv_adr);\n\th_table = radeon_get_htiming_tables_addr(tv_dac->tv.tv_uv_adr);\n\tv_table = radeon_get_vtiming_tables_addr(tv_dac->tv.tv_uv_adr);\n\n\tfor (i = 0; i < MAX_H_CODE_TIMING_LEN; i += 2, h_table--) {\n\t\ttmp = ((uint32_t)tv_dac->tv.h_code_timing[i] << 14) | ((uint32_t)tv_dac->tv.h_code_timing[i+1]);\n\t\tradeon_legacy_tv_write_fifo(radeon_encoder, h_table, tmp);\n\t\tif (tv_dac->tv.h_code_timing[i] == 0 || tv_dac->tv.h_code_timing[i + 1] == 0)\n\t\t\tbreak;\n\t}\n\tfor (i = 0; i < MAX_V_CODE_TIMING_LEN; i += 2, v_table++) {\n\t\ttmp = ((uint32_t)tv_dac->tv.v_code_timing[i+1] << 14) | ((uint32_t)tv_dac->tv.v_code_timing[i]);\n\t\tradeon_legacy_tv_write_fifo(radeon_encoder, v_table, tmp);\n\t\tif (tv_dac->tv.v_code_timing[i] == 0 || tv_dac->tv.v_code_timing[i + 1] == 0)\n\t\t\tbreak;\n\t}\n}\n\nstatic void radeon_legacy_write_tv_restarts(struct radeon_encoder *radeon_encoder)\n{\n\tstruct drm_device *dev = radeon_encoder->base.dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\n\tWREG32(RADEON_TV_FRESTART, tv_dac->tv.frestart);\n\tWREG32(RADEON_TV_HRESTART, tv_dac->tv.hrestart);\n\tWREG32(RADEON_TV_VRESTART, tv_dac->tv.vrestart);\n}\n\nstatic bool radeon_legacy_tv_init_restarts(struct drm_encoder *encoder)\n{\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\n\tint restart;\n\tunsigned int h_total, v_total, f_total;\n\tint v_offset, h_offset;\n\tu16 p1, p2, h_inc;\n\tbool h_changed;\n\tconst struct radeon_tv_mode_constants *const_ptr;\n\n\tconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, NULL);\n\tif (!const_ptr)\n\t\treturn false;\n\n\th_total = const_ptr->hor_total;\n\tv_total = const_ptr->ver_total;\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t    tv_dac->tv_std == TV_STD_PAL_M ||\n\t    tv_dac->tv_std == TV_STD_PAL_60)\n\t\tf_total = NTSC_TV_VFTOTAL + 1;\n\telse\n\t\tf_total = PAL_TV_VFTOTAL + 1;\n\n\t \n\th_offset = tv_dac->h_pos * H_POS_UNIT;\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t    tv_dac->tv_std == TV_STD_PAL_M) {\n\t\th_offset -= 50;\n\t\tp1 = hor_timing_NTSC[H_TABLE_POS1];\n\t\tp2 = hor_timing_NTSC[H_TABLE_POS2];\n\t} else {\n\t\tp1 = hor_timing_PAL[H_TABLE_POS1];\n\t\tp2 = hor_timing_PAL[H_TABLE_POS2];\n\t}\n\n\tp1 = (u16)((int)p1 + h_offset);\n\tp2 = (u16)((int)p2 - h_offset);\n\n\th_changed = (p1 != tv_dac->tv.h_code_timing[H_TABLE_POS1] ||\n\t\t     p2 != tv_dac->tv.h_code_timing[H_TABLE_POS2]);\n\n\ttv_dac->tv.h_code_timing[H_TABLE_POS1] = p1;\n\ttv_dac->tv.h_code_timing[H_TABLE_POS2] = p2;\n\n\t \n\th_offset = (h_offset * (int)(const_ptr->pix_to_tv)) / 1000;\n\n\t \n\trestart = const_ptr->def_restart;\n\n\t \n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t    tv_dac->tv_std == TV_STD_PAL_M ||\n\t    tv_dac->tv_std == TV_STD_PAL_60)\n\t\tv_offset = ((int)(v_total * h_total) * 2 * tv_dac->v_pos) / (int)(NTSC_TV_LINES_PER_FRAME);\n\telse\n\t\tv_offset = ((int)(v_total * h_total) * 2 * tv_dac->v_pos) / (int)(PAL_TV_LINES_PER_FRAME);\n\n\trestart -= v_offset + h_offset;\n\n\tDRM_DEBUG_KMS(\"compute_restarts: def = %u h = %d v = %d, p1 = %04x, p2 = %04x, restart = %d\\n\",\n\t\t  const_ptr->def_restart, tv_dac->h_pos, tv_dac->v_pos, p1, p2, restart);\n\n\ttv_dac->tv.hrestart = restart % h_total;\n\trestart /= h_total;\n\ttv_dac->tv.vrestart = restart % v_total;\n\trestart /= v_total;\n\ttv_dac->tv.frestart = restart % f_total;\n\n\tDRM_DEBUG_KMS(\"compute_restart: F/H/V=%u,%u,%u\\n\",\n\t\t  (unsigned)tv_dac->tv.frestart,\n\t\t  (unsigned)tv_dac->tv.vrestart,\n\t\t  (unsigned)tv_dac->tv.hrestart);\n\n\t \n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t    tv_dac->tv_std == TV_STD_PAL_M)\n\t\th_inc = (u16)((int)(const_ptr->hor_resolution * 4096 * NTSC_TV_CLOCK_T) /\n\t\t\t      (tv_dac->h_size * (int)(NTSC_TV_H_SIZE_UNIT) + (int)(NTSC_TV_ZERO_H_SIZE)));\n\telse\n\t\th_inc = (u16)((int)(const_ptr->hor_resolution * 4096 * PAL_TV_CLOCK_T) /\n\t\t\t      (tv_dac->h_size * (int)(PAL_TV_H_SIZE_UNIT) + (int)(PAL_TV_ZERO_H_SIZE)));\n\n\ttv_dac->tv.timing_cntl = (tv_dac->tv.timing_cntl & ~RADEON_H_INC_MASK) |\n\t\t((u32)h_inc << RADEON_H_INC_SHIFT);\n\n\tDRM_DEBUG_KMS(\"compute_restart: h_size = %d h_inc = %d\\n\", tv_dac->h_size, h_inc);\n\n\treturn h_changed;\n}\n\nvoid radeon_legacy_tv_mode_set(struct drm_encoder *encoder,\n\t\t\t       struct drm_display_mode *mode,\n\t\t\t       struct drm_display_mode *adjusted_mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct radeon_device *rdev = dev->dev_private;\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\n\tconst struct radeon_tv_mode_constants *const_ptr;\n\tstruct radeon_crtc *radeon_crtc;\n\tint i;\n\tuint16_t pll_ref_freq;\n\tuint32_t vert_space, flicker_removal, tmp;\n\tuint32_t tv_master_cntl, tv_rgb_cntl, tv_dac_cntl;\n\tuint32_t tv_modulator_cntl1, tv_modulator_cntl2;\n\tuint32_t tv_vscaler_cntl1, tv_vscaler_cntl2;\n\tuint32_t tv_pll_cntl, tv_ftotal;\n\tuint32_t tv_y_fall_cntl, tv_y_rise_cntl, tv_y_saw_tooth_cntl;\n\tuint32_t m, n, p;\n\tconst uint16_t *hor_timing;\n\tconst uint16_t *vert_timing;\n\n\tconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, &pll_ref_freq);\n\tif (!const_ptr)\n\t\treturn;\n\n\tradeon_crtc = to_radeon_crtc(encoder->crtc);\n\n\ttv_master_cntl = (RADEON_VIN_ASYNC_RST |\n\t\t\t  RADEON_CRT_FIFO_CE_EN |\n\t\t\t  RADEON_TV_FIFO_CE_EN |\n\t\t\t  RADEON_TV_ON);\n\n\tif (!ASIC_IS_R300(rdev))\n\t\ttv_master_cntl |= RADEON_TVCLK_ALWAYS_ONb;\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J)\n\t\ttv_master_cntl |= RADEON_RESTART_PHASE_FIX;\n\n\ttv_modulator_cntl1 = (RADEON_SLEW_RATE_LIMIT |\n\t\t\t      RADEON_SYNC_TIP_LEVEL |\n\t\t\t      RADEON_YFLT_EN |\n\t\t\t      RADEON_UVFLT_EN |\n\t\t\t      (6 << RADEON_CY_FILT_BLEND_SHIFT));\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J) {\n\t\ttv_modulator_cntl1 |= (0x46 << RADEON_SET_UP_LEVEL_SHIFT) |\n\t\t\t(0x3b << RADEON_BLANK_LEVEL_SHIFT);\n\t\ttv_modulator_cntl2 = (-111 & RADEON_TV_U_BURST_LEVEL_MASK) |\n\t\t\t((0 & RADEON_TV_V_BURST_LEVEL_MASK) << RADEON_TV_V_BURST_LEVEL_SHIFT);\n\t} else if (tv_dac->tv_std == TV_STD_SCART_PAL) {\n\t\ttv_modulator_cntl1 |= RADEON_ALT_PHASE_EN;\n\t\ttv_modulator_cntl2 = (0 & RADEON_TV_U_BURST_LEVEL_MASK) |\n\t\t\t((0 & RADEON_TV_V_BURST_LEVEL_MASK) << RADEON_TV_V_BURST_LEVEL_SHIFT);\n\t} else {\n\t\ttv_modulator_cntl1 |= RADEON_ALT_PHASE_EN |\n\t\t\t(0x3b << RADEON_SET_UP_LEVEL_SHIFT) |\n\t\t\t(0x3b << RADEON_BLANK_LEVEL_SHIFT);\n\t\ttv_modulator_cntl2 = (-78 & RADEON_TV_U_BURST_LEVEL_MASK) |\n\t\t\t((62 & RADEON_TV_V_BURST_LEVEL_MASK) << RADEON_TV_V_BURST_LEVEL_SHIFT);\n\t}\n\n\n\ttv_rgb_cntl = (RADEON_RGB_DITHER_EN\n\t\t       | RADEON_TVOUT_SCALE_EN\n\t\t       | (0x0b << RADEON_UVRAM_READ_MARGIN_SHIFT)\n\t\t       | (0x07 << RADEON_FIFORAM_FFMACRO_READ_MARGIN_SHIFT)\n\t\t       | RADEON_RGB_ATTEN_SEL(0x3)\n\t\t       | RADEON_RGB_ATTEN_VAL(0xc));\n\n\tif (radeon_crtc->crtc_id == 1)\n\t\ttv_rgb_cntl |= RADEON_RGB_SRC_SEL_CRTC2;\n\telse {\n\t\tif (radeon_crtc->rmx_type != RMX_OFF)\n\t\t\ttv_rgb_cntl |= RADEON_RGB_SRC_SEL_RMX;\n\t\telse\n\t\t\ttv_rgb_cntl |= RADEON_RGB_SRC_SEL_CRTC1;\n\t}\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t    tv_dac->tv_std == TV_STD_PAL_M ||\n\t    tv_dac->tv_std == TV_STD_PAL_60)\n\t\tvert_space = const_ptr->ver_total * 2 * 10000 / NTSC_TV_LINES_PER_FRAME;\n\telse\n\t\tvert_space = const_ptr->ver_total * 2 * 10000 / PAL_TV_LINES_PER_FRAME;\n\n\ttmp = RREG32(RADEON_TV_VSCALER_CNTL1);\n\ttmp &= 0xe3ff0000;\n\ttmp |= (vert_space * (1 << FRAC_BITS) / 10000);\n\ttv_vscaler_cntl1 = tmp;\n\n\tif (pll_ref_freq == 2700)\n\t\ttv_vscaler_cntl1 |= RADEON_RESTART_FIELD;\n\n\tif (const_ptr->hor_resolution == 1024)\n\t\ttv_vscaler_cntl1 |= (4 << RADEON_Y_DEL_W_SIG_SHIFT);\n\telse\n\t\ttv_vscaler_cntl1 |= (2 << RADEON_Y_DEL_W_SIG_SHIFT);\n\n\t \n\ttmp = const_ptr->ver_total * 2 * 1000;\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t    tv_dac->tv_std == TV_STD_PAL_M ||\n\t    tv_dac->tv_std == TV_STD_PAL_60) {\n\t\ttmp /= NTSC_TV_LINES_PER_FRAME;\n\t} else {\n\t\ttmp /= PAL_TV_LINES_PER_FRAME;\n\t}\n\tflicker_removal = (tmp + 500) / 1000;\n\n\tif (flicker_removal < 3)\n\t\tflicker_removal = 3;\n\tfor (i = 0; i < ARRAY_SIZE(SLOPE_limit); ++i) {\n\t\tif (flicker_removal == SLOPE_limit[i])\n\t\t\tbreak;\n\t}\n\n\ttv_y_saw_tooth_cntl = (vert_space * SLOPE_value[i] * (1 << (FRAC_BITS - 1)) +\n\t\t\t\t5001) / 10000 / 8 | ((SLOPE_value[i] *\n\t\t\t\t(1 << (FRAC_BITS - 1)) / 8) << 16);\n\ttv_y_fall_cntl =\n\t\t(YCOEF_EN_value[i] << 17) | ((YCOEF_value[i] * (1 << 8) / 8) << 24) |\n\t\tRADEON_Y_FALL_PING_PONG | (272 * SLOPE_value[i] / 8) * (1 << (FRAC_BITS - 1)) /\n\t\t1024;\n\ttv_y_rise_cntl = RADEON_Y_RISE_PING_PONG|\n\t\t(flicker_removal * 1024 - 272) * SLOPE_value[i] / 8 * (1 << (FRAC_BITS - 1)) / 1024;\n\n\ttv_vscaler_cntl2 = RREG32(RADEON_TV_VSCALER_CNTL2) & 0x00fffff0;\n\ttv_vscaler_cntl2 |= (0x10 << 24) |\n\t\tRADEON_DITHER_MODE |\n\t\tRADEON_Y_OUTPUT_DITHER_EN |\n\t\tRADEON_UV_OUTPUT_DITHER_EN |\n\t\tRADEON_UV_TO_BUF_DITHER_EN;\n\n\ttmp = (tv_vscaler_cntl1 >> RADEON_UV_INC_SHIFT) & RADEON_UV_INC_MASK;\n\ttmp = ((16384 * 256 * 10) / tmp + 5) / 10;\n\ttmp = (tmp << RADEON_UV_OUTPUT_POST_SCALE_SHIFT) | 0x000b0000;\n\ttv_dac->tv.timing_cntl = tmp;\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t    tv_dac->tv_std == TV_STD_PAL_M ||\n\t    tv_dac->tv_std == TV_STD_PAL_60)\n\t\ttv_dac_cntl = tv_dac->ntsc_tvdac_adj;\n\telse\n\t\ttv_dac_cntl = tv_dac->pal_tvdac_adj;\n\n\ttv_dac_cntl |= RADEON_TV_DAC_NBLANK | RADEON_TV_DAC_NHOLD;\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J)\n\t\ttv_dac_cntl |= RADEON_TV_DAC_STD_NTSC;\n\telse\n\t\ttv_dac_cntl |= RADEON_TV_DAC_STD_PAL;\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J) {\n\t\tif (pll_ref_freq == 2700) {\n\t\t\tm = NTSC_TV_PLL_M_27;\n\t\t\tn = NTSC_TV_PLL_N_27;\n\t\t\tp = NTSC_TV_PLL_P_27;\n\t\t} else {\n\t\t\tm = NTSC_TV_PLL_M_14;\n\t\t\tn = NTSC_TV_PLL_N_14;\n\t\t\tp = NTSC_TV_PLL_P_14;\n\t\t}\n\t} else {\n\t\tif (pll_ref_freq == 2700) {\n\t\t\tm = PAL_TV_PLL_M_27;\n\t\t\tn = PAL_TV_PLL_N_27;\n\t\t\tp = PAL_TV_PLL_P_27;\n\t\t} else {\n\t\t\tm = PAL_TV_PLL_M_14;\n\t\t\tn = PAL_TV_PLL_N_14;\n\t\t\tp = PAL_TV_PLL_P_14;\n\t\t}\n\t}\n\n\ttv_pll_cntl = (m & RADEON_TV_M0LO_MASK) |\n\t\t(((m >> 8) & RADEON_TV_M0HI_MASK) << RADEON_TV_M0HI_SHIFT) |\n\t\t((n & RADEON_TV_N0LO_MASK) << RADEON_TV_N0LO_SHIFT) |\n\t\t(((n >> 9) & RADEON_TV_N0HI_MASK) << RADEON_TV_N0HI_SHIFT) |\n\t\t((p & RADEON_TV_P_MASK) << RADEON_TV_P_SHIFT);\n\n\ttv_dac->tv.tv_uv_adr = 0xc8;\n\n\tif (tv_dac->tv_std == TV_STD_NTSC ||\n\t    tv_dac->tv_std == TV_STD_NTSC_J ||\n\t    tv_dac->tv_std == TV_STD_PAL_M ||\n\t    tv_dac->tv_std == TV_STD_PAL_60) {\n\t\ttv_ftotal = NTSC_TV_VFTOTAL;\n\t\thor_timing = hor_timing_NTSC;\n\t\tvert_timing = vert_timing_NTSC;\n\t} else {\n\t\thor_timing = hor_timing_PAL;\n\t\tvert_timing = vert_timing_PAL;\n\t\ttv_ftotal = PAL_TV_VFTOTAL;\n\t}\n\n\tfor (i = 0; i < MAX_H_CODE_TIMING_LEN; i++) {\n\t\ttv_dac->tv.h_code_timing[i] = hor_timing[i];\n\t\tif (tv_dac->tv.h_code_timing[i] == 0)\n\t\t\tbreak;\n\t}\n\n\tfor (i = 0; i < MAX_V_CODE_TIMING_LEN; i++) {\n\t\ttv_dac->tv.v_code_timing[i] = vert_timing[i];\n\t\tif (tv_dac->tv.v_code_timing[i] == 0)\n\t\t\tbreak;\n\t}\n\n\tradeon_legacy_tv_init_restarts(encoder);\n\n\t \n\t \n\t \n\t \n\n\t \n\tWREG32(RADEON_TV_MASTER_CNTL, (tv_master_cntl | RADEON_TV_ASYNC_RST |\n\t\t\t\t       RADEON_CRT_ASYNC_RST | RADEON_TV_FIFO_ASYNC_RST));\n\n\ttmp = RREG32(RADEON_TV_DAC_CNTL);\n\ttmp &= ~RADEON_TV_DAC_NBLANK;\n\ttmp |= RADEON_TV_DAC_BGSLEEP |\n\t\tRADEON_TV_DAC_RDACPD |\n\t\tRADEON_TV_DAC_GDACPD |\n\t\tRADEON_TV_DAC_BDACPD;\n\tWREG32(RADEON_TV_DAC_CNTL, tmp);\n\n\t \n\tWREG32_PLL_P(RADEON_TV_PLL_CNTL1, 0, ~RADEON_TVCLK_SRC_SEL_TVPLL);\n\tWREG32_PLL(RADEON_TV_PLL_CNTL, tv_pll_cntl);\n\tWREG32_PLL_P(RADEON_TV_PLL_CNTL1, RADEON_TVPLL_RESET, ~RADEON_TVPLL_RESET);\n\n\tradeon_wait_pll_lock(encoder, 200, 800, 135);\n\n\tWREG32_PLL_P(RADEON_TV_PLL_CNTL1, 0, ~RADEON_TVPLL_RESET);\n\n\tradeon_wait_pll_lock(encoder, 300, 160, 27);\n\tradeon_wait_pll_lock(encoder, 200, 800, 135);\n\n\tWREG32_PLL_P(RADEON_TV_PLL_CNTL1, 0, ~0xf);\n\tWREG32_PLL_P(RADEON_TV_PLL_CNTL1, RADEON_TVCLK_SRC_SEL_TVPLL, ~RADEON_TVCLK_SRC_SEL_TVPLL);\n\n\tWREG32_PLL_P(RADEON_TV_PLL_CNTL1, (1 << RADEON_TVPDC_SHIFT), ~RADEON_TVPDC_MASK);\n\tWREG32_PLL_P(RADEON_TV_PLL_CNTL1, 0, ~RADEON_TVPLL_SLEEP);\n\n\t \n\tWREG32(RADEON_TV_RGB_CNTL, tv_rgb_cntl);\n\tWREG32(RADEON_TV_HTOTAL, const_ptr->hor_total - 1);\n\tWREG32(RADEON_TV_HDISP, const_ptr->hor_resolution - 1);\n\tWREG32(RADEON_TV_HSTART, const_ptr->hor_start);\n\n\tWREG32(RADEON_TV_VTOTAL, const_ptr->ver_total - 1);\n\tWREG32(RADEON_TV_VDISP, const_ptr->ver_resolution - 1);\n\tWREG32(RADEON_TV_FTOTAL, tv_ftotal);\n\tWREG32(RADEON_TV_VSCALER_CNTL1, tv_vscaler_cntl1);\n\tWREG32(RADEON_TV_VSCALER_CNTL2, tv_vscaler_cntl2);\n\n\tWREG32(RADEON_TV_Y_FALL_CNTL, tv_y_fall_cntl);\n\tWREG32(RADEON_TV_Y_RISE_CNTL, tv_y_rise_cntl);\n\tWREG32(RADEON_TV_Y_SAW_TOOTH_CNTL, tv_y_saw_tooth_cntl);\n\n\tWREG32(RADEON_TV_MASTER_CNTL, (tv_master_cntl | RADEON_TV_ASYNC_RST |\n\t\t\t\t       RADEON_CRT_ASYNC_RST));\n\n\t \n\tradeon_legacy_write_tv_restarts(radeon_encoder);\n\n\t \n\tradeon_restore_tv_timing_tables(radeon_encoder);\n\n\tWREG32(RADEON_TV_MASTER_CNTL, (tv_master_cntl | RADEON_TV_ASYNC_RST));\n\n\t \n\tWREG32(RADEON_TV_SYNC_CNTL, (RADEON_SYNC_PUB | RADEON_TV_SYNC_IO_DRIVE));\n\tWREG32(RADEON_TV_TIMING_CNTL, tv_dac->tv.timing_cntl);\n\tWREG32(RADEON_TV_MODULATOR_CNTL1, tv_modulator_cntl1);\n\tWREG32(RADEON_TV_MODULATOR_CNTL2, tv_modulator_cntl2);\n\tWREG32(RADEON_TV_PRE_DAC_MUX_CNTL, (RADEON_Y_RED_EN |\n\t\t\t\t\t    RADEON_C_GRN_EN |\n\t\t\t\t\t    RADEON_CMP_BLU_EN |\n\t\t\t\t\t    RADEON_DAC_DITHER_EN));\n\n\tWREG32(RADEON_TV_CRC_CNTL, 0);\n\n\tWREG32(RADEON_TV_MASTER_CNTL, tv_master_cntl);\n\n\tWREG32(RADEON_TV_GAIN_LIMIT_SETTINGS, ((0x17f << RADEON_UV_GAIN_LIMIT_SHIFT) |\n\t\t\t\t\t       (0x5ff << RADEON_Y_GAIN_LIMIT_SHIFT)));\n\tWREG32(RADEON_TV_LINEAR_GAIN_SETTINGS, ((0x100 << RADEON_UV_GAIN_SHIFT) |\n\t\t\t\t\t\t(0x100 << RADEON_Y_GAIN_SHIFT)));\n\n\tWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\n\n}\n\nvoid radeon_legacy_tv_adjust_crtc_reg(struct drm_encoder *encoder,\n\t\t\t\t      uint32_t *h_total_disp, uint32_t *h_sync_strt_wid,\n\t\t\t\t      uint32_t *v_total_disp, uint32_t *v_sync_strt_wid)\n{\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tconst struct radeon_tv_mode_constants *const_ptr;\n\tuint32_t tmp;\n\n\tconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, NULL);\n\tif (!const_ptr)\n\t\treturn;\n\n\t*h_total_disp = (((const_ptr->hor_resolution / 8) - 1) << RADEON_CRTC_H_DISP_SHIFT) |\n\t\t(((const_ptr->hor_total / 8) - 1) << RADEON_CRTC_H_TOTAL_SHIFT);\n\n\ttmp = *h_sync_strt_wid;\n\ttmp &= ~(RADEON_CRTC_H_SYNC_STRT_PIX | RADEON_CRTC_H_SYNC_STRT_CHAR);\n\ttmp |= (((const_ptr->hor_syncstart / 8) - 1) << RADEON_CRTC_H_SYNC_STRT_CHAR_SHIFT) |\n\t\t(const_ptr->hor_syncstart & 7);\n\t*h_sync_strt_wid = tmp;\n\n\t*v_total_disp = ((const_ptr->ver_resolution - 1) << RADEON_CRTC_V_DISP_SHIFT) |\n\t\t((const_ptr->ver_total - 1) << RADEON_CRTC_V_TOTAL_SHIFT);\n\n\ttmp = *v_sync_strt_wid;\n\ttmp &= ~RADEON_CRTC_V_SYNC_STRT;\n\ttmp |= ((const_ptr->ver_syncstart - 1) << RADEON_CRTC_V_SYNC_STRT_SHIFT);\n\t*v_sync_strt_wid = tmp;\n}\n\nstatic int get_post_div(int value)\n{\n\tint post_div;\n\tswitch (value) {\n\tcase 1: post_div = 0; break;\n\tcase 2: post_div = 1; break;\n\tcase 3: post_div = 4; break;\n\tcase 4: post_div = 2; break;\n\tcase 6: post_div = 6; break;\n\tcase 8: post_div = 3; break;\n\tcase 12: post_div = 7; break;\n\tcase 16:\n\tdefault: post_div = 5; break;\n\t}\n\treturn post_div;\n}\n\nvoid radeon_legacy_tv_adjust_pll1(struct drm_encoder *encoder,\n\t\t\t\t  uint32_t *htotal_cntl, uint32_t *ppll_ref_div,\n\t\t\t\t  uint32_t *ppll_div_3, uint32_t *pixclks_cntl)\n{\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tconst struct radeon_tv_mode_constants *const_ptr;\n\n\tconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, NULL);\n\tif (!const_ptr)\n\t\treturn;\n\n\t*htotal_cntl = (const_ptr->hor_total & 0x7) | RADEON_HTOT_CNTL_VGA_EN;\n\n\t*ppll_ref_div = const_ptr->crtcPLL_M;\n\n\t*ppll_div_3 = (const_ptr->crtcPLL_N & 0x7ff) | (get_post_div(const_ptr->crtcPLL_post_div) << 16);\n\t*pixclks_cntl &= ~(RADEON_PIX2CLK_SRC_SEL_MASK | RADEON_PIXCLK_TV_SRC_SEL);\n\t*pixclks_cntl |= RADEON_PIX2CLK_SRC_SEL_P2PLLCLK;\n}\n\nvoid radeon_legacy_tv_adjust_pll2(struct drm_encoder *encoder,\n\t\t\t\t  uint32_t *htotal2_cntl, uint32_t *p2pll_ref_div,\n\t\t\t\t  uint32_t *p2pll_div_0, uint32_t *pixclks_cntl)\n{\n\tstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\n\tconst struct radeon_tv_mode_constants *const_ptr;\n\n\tconst_ptr = radeon_legacy_tv_get_std_mode(radeon_encoder, NULL);\n\tif (!const_ptr)\n\t\treturn;\n\n\t*htotal2_cntl = (const_ptr->hor_total & 0x7);\n\n\t*p2pll_ref_div = const_ptr->crtcPLL_M;\n\n\t*p2pll_div_0 = (const_ptr->crtcPLL_N & 0x7ff) | (get_post_div(const_ptr->crtcPLL_post_div) << 16);\n\t*pixclks_cntl &= ~RADEON_PIX2CLK_SRC_SEL_MASK;\n\t*pixclks_cntl |= RADEON_PIX2CLK_SRC_SEL_P2PLLCLK | RADEON_PIXCLK_TV_SRC_SEL;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}