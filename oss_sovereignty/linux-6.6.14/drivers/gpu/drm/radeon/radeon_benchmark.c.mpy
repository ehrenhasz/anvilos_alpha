{
  "module_name": "radeon_benchmark.c",
  "hash_id": "00113852a31f633020cd77c4d59bf813daa0f7af1d5ab44f786cb94968298b7f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/radeon/radeon_benchmark.c",
  "human_readable_source": " \n\n#include <drm/radeon_drm.h>\n#include \"radeon_reg.h\"\n#include \"radeon.h\"\n\n#define RADEON_BENCHMARK_COPY_BLIT 1\n#define RADEON_BENCHMARK_COPY_DMA  0\n\n#define RADEON_BENCHMARK_ITERATIONS 1024\n#define RADEON_BENCHMARK_COMMON_MODES_N 17\n\nstatic int radeon_benchmark_do_move(struct radeon_device *rdev, unsigned size,\n\t\t\t\t    uint64_t saddr, uint64_t daddr,\n\t\t\t\t    int flag, int n,\n\t\t\t\t    struct dma_resv *resv)\n{\n\tunsigned long start_jiffies;\n\tunsigned long end_jiffies;\n\tstruct radeon_fence *fence = NULL;\n\tint i, r;\n\n\tstart_jiffies = jiffies;\n\tfor (i = 0; i < n; i++) {\n\t\tswitch (flag) {\n\t\tcase RADEON_BENCHMARK_COPY_DMA:\n\t\t\tfence = radeon_copy_dma(rdev, saddr, daddr,\n\t\t\t\t\t\tsize / RADEON_GPU_PAGE_SIZE,\n\t\t\t\t\t\tresv);\n\t\t\tbreak;\n\t\tcase RADEON_BENCHMARK_COPY_BLIT:\n\t\t\tfence = radeon_copy_blit(rdev, saddr, daddr,\n\t\t\t\t\t\t size / RADEON_GPU_PAGE_SIZE,\n\t\t\t\t\t\t resv);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tDRM_ERROR(\"Unknown copy method\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tif (IS_ERR(fence))\n\t\t\treturn PTR_ERR(fence);\n\n\t\tr = radeon_fence_wait(fence, false);\n\t\tradeon_fence_unref(&fence);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\tend_jiffies = jiffies;\n\treturn jiffies_to_msecs(end_jiffies - start_jiffies);\n}\n\n\nstatic void radeon_benchmark_log_results(int n, unsigned size,\n\t\t\t\t\t unsigned int time,\n\t\t\t\t\t unsigned sdomain, unsigned ddomain,\n\t\t\t\t\t char *kind)\n{\n\tunsigned int throughput = (n * (size >> 10)) / time;\n\tDRM_INFO(\"radeon: %s %u bo moves of %u kB from\"\n\t\t \" %d to %d in %u ms, throughput: %u Mb/s or %u MB/s\\n\",\n\t\t kind, n, size >> 10, sdomain, ddomain, time,\n\t\t throughput * 8, throughput);\n}\n\nstatic void radeon_benchmark_move(struct radeon_device *rdev, unsigned size,\n\t\t\t\t  unsigned sdomain, unsigned ddomain)\n{\n\tstruct radeon_bo *dobj = NULL;\n\tstruct radeon_bo *sobj = NULL;\n\tuint64_t saddr, daddr;\n\tint r, n;\n\tint time;\n\n\tn = RADEON_BENCHMARK_ITERATIONS;\n\tr = radeon_bo_create(rdev, size, PAGE_SIZE, true, sdomain, 0, NULL, NULL, &sobj);\n\tif (r) {\n\t\tgoto out_cleanup;\n\t}\n\tr = radeon_bo_reserve(sobj, false);\n\tif (unlikely(r != 0))\n\t\tgoto out_cleanup;\n\tr = radeon_bo_pin(sobj, sdomain, &saddr);\n\tradeon_bo_unreserve(sobj);\n\tif (r) {\n\t\tgoto out_cleanup;\n\t}\n\tr = radeon_bo_create(rdev, size, PAGE_SIZE, true, ddomain, 0, NULL, NULL, &dobj);\n\tif (r) {\n\t\tgoto out_cleanup;\n\t}\n\tr = radeon_bo_reserve(dobj, false);\n\tif (unlikely(r != 0))\n\t\tgoto out_cleanup;\n\tr = radeon_bo_pin(dobj, ddomain, &daddr);\n\tradeon_bo_unreserve(dobj);\n\tif (r) {\n\t\tgoto out_cleanup;\n\t}\n\n\tif (rdev->asic->copy.dma) {\n\t\ttime = radeon_benchmark_do_move(rdev, size, saddr, daddr,\n\t\t\t\t\t\tRADEON_BENCHMARK_COPY_DMA, n,\n\t\t\t\t\t\tdobj->tbo.base.resv);\n\t\tif (time < 0)\n\t\t\tgoto out_cleanup;\n\t\tif (time > 0)\n\t\t\tradeon_benchmark_log_results(n, size, time,\n\t\t\t\t\t\t     sdomain, ddomain, \"dma\");\n\t}\n\n\tif (rdev->asic->copy.blit) {\n\t\ttime = radeon_benchmark_do_move(rdev, size, saddr, daddr,\n\t\t\t\t\t\tRADEON_BENCHMARK_COPY_BLIT, n,\n\t\t\t\t\t\tdobj->tbo.base.resv);\n\t\tif (time < 0)\n\t\t\tgoto out_cleanup;\n\t\tif (time > 0)\n\t\t\tradeon_benchmark_log_results(n, size, time,\n\t\t\t\t\t\t     sdomain, ddomain, \"blit\");\n\t}\n\nout_cleanup:\n\tif (sobj) {\n\t\tr = radeon_bo_reserve(sobj, false);\n\t\tif (likely(r == 0)) {\n\t\t\tradeon_bo_unpin(sobj);\n\t\t\tradeon_bo_unreserve(sobj);\n\t\t}\n\t\tradeon_bo_unref(&sobj);\n\t}\n\tif (dobj) {\n\t\tr = radeon_bo_reserve(dobj, false);\n\t\tif (likely(r == 0)) {\n\t\t\tradeon_bo_unpin(dobj);\n\t\t\tradeon_bo_unreserve(dobj);\n\t\t}\n\t\tradeon_bo_unref(&dobj);\n\t}\n\n\tif (r) {\n\t\tDRM_ERROR(\"Error while benchmarking BO move.\\n\");\n\t}\n}\n\nvoid radeon_benchmark(struct radeon_device *rdev, int test_number)\n{\n\tint i;\n\tint common_modes[RADEON_BENCHMARK_COMMON_MODES_N] = {\n\t\t640 * 480 * 4,\n\t\t720 * 480 * 4,\n\t\t800 * 600 * 4,\n\t\t848 * 480 * 4,\n\t\t1024 * 768 * 4,\n\t\t1152 * 768 * 4,\n\t\t1280 * 720 * 4,\n\t\t1280 * 800 * 4,\n\t\t1280 * 854 * 4,\n\t\t1280 * 960 * 4,\n\t\t1280 * 1024 * 4,\n\t\t1440 * 900 * 4,\n\t\t1400 * 1050 * 4,\n\t\t1680 * 1050 * 4,\n\t\t1600 * 1200 * 4,\n\t\t1920 * 1080 * 4,\n\t\t1920 * 1200 * 4\n\t};\n\n\tswitch (test_number) {\n\tcase 1:\n\t\t \n\t\tradeon_benchmark_move(rdev, 1024*1024, RADEON_GEM_DOMAIN_GTT,\n\t\t\t\t      RADEON_GEM_DOMAIN_VRAM);\n\t\tradeon_benchmark_move(rdev, 1024*1024, RADEON_GEM_DOMAIN_VRAM,\n\t\t\t\t      RADEON_GEM_DOMAIN_GTT);\n\t\tbreak;\n\tcase 2:\n\t\t \n\t\tradeon_benchmark_move(rdev, 1024*1024, RADEON_GEM_DOMAIN_VRAM,\n\t\t\t\t      RADEON_GEM_DOMAIN_VRAM);\n\t\tbreak;\n\tcase 3:\n\t\t \n\t\tfor (i = 1; i <= 16384; i <<= 1)\n\t\t\tradeon_benchmark_move(rdev, i * RADEON_GPU_PAGE_SIZE,\n\t\t\t\t\t      RADEON_GEM_DOMAIN_GTT,\n\t\t\t\t\t      RADEON_GEM_DOMAIN_VRAM);\n\t\tbreak;\n\tcase 4:\n\t\t \n\t\tfor (i = 1; i <= 16384; i <<= 1)\n\t\t\tradeon_benchmark_move(rdev, i * RADEON_GPU_PAGE_SIZE,\n\t\t\t\t\t      RADEON_GEM_DOMAIN_VRAM,\n\t\t\t\t\t      RADEON_GEM_DOMAIN_GTT);\n\t\tbreak;\n\tcase 5:\n\t\t \n\t\tfor (i = 1; i <= 16384; i <<= 1)\n\t\t\tradeon_benchmark_move(rdev, i * RADEON_GPU_PAGE_SIZE,\n\t\t\t\t\t      RADEON_GEM_DOMAIN_VRAM,\n\t\t\t\t\t      RADEON_GEM_DOMAIN_VRAM);\n\t\tbreak;\n\tcase 6:\n\t\t \n\t\tfor (i = 0; i < RADEON_BENCHMARK_COMMON_MODES_N; i++)\n\t\t\tradeon_benchmark_move(rdev, common_modes[i],\n\t\t\t\t\t      RADEON_GEM_DOMAIN_GTT,\n\t\t\t\t\t      RADEON_GEM_DOMAIN_VRAM);\n\t\tbreak;\n\tcase 7:\n\t\t \n\t\tfor (i = 0; i < RADEON_BENCHMARK_COMMON_MODES_N; i++)\n\t\t\tradeon_benchmark_move(rdev, common_modes[i],\n\t\t\t\t\t      RADEON_GEM_DOMAIN_VRAM,\n\t\t\t\t\t      RADEON_GEM_DOMAIN_GTT);\n\t\tbreak;\n\tcase 8:\n\t\t \n\t\tfor (i = 0; i < RADEON_BENCHMARK_COMMON_MODES_N; i++)\n\t\t\tradeon_benchmark_move(rdev, common_modes[i],\n\t\t\t\t\t      RADEON_GEM_DOMAIN_VRAM,\n\t\t\t\t\t      RADEON_GEM_DOMAIN_VRAM);\n\t\tbreak;\n\n\tdefault:\n\t\tDRM_ERROR(\"Unknown benchmark\\n\");\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}