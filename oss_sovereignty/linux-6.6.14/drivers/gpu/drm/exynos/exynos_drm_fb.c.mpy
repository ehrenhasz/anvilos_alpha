{
  "module_name": "exynos_drm_fb.c",
  "hash_id": "15d8e204a65fdd388587dafe87f13ec5df681ec8f3a33e26932b9aaee94880d4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/exynos/exynos_drm_fb.c",
  "human_readable_source": "\n \n\n#include <drm/drm_atomic.h>\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_crtc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_gem_framebuffer_helper.h>\n#include <drm/drm_probe_helper.h>\n#include <drm/exynos_drm.h>\n\n#include \"exynos_drm_crtc.h\"\n#include \"exynos_drm_drv.h\"\n#include \"exynos_drm_fb.h\"\n#include \"exynos_drm_fbdev.h\"\n\nstatic int check_fb_gem_memory_type(struct drm_device *drm_dev,\n\t\t\t\t    struct exynos_drm_gem *exynos_gem)\n{\n\tunsigned int flags;\n\n\t \n\tif (is_drm_iommu_supported(drm_dev))\n\t\treturn 0;\n\n\tflags = exynos_gem->flags;\n\n\t \n\tif (IS_NONCONTIG_BUFFER(flags)) {\n\t\tDRM_DEV_ERROR(drm_dev->dev,\n\t\t\t      \"Non-contiguous GEM memory is not supported.\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct drm_framebuffer_funcs exynos_drm_fb_funcs = {\n\t.destroy\t= drm_gem_fb_destroy,\n\t.create_handle\t= drm_gem_fb_create_handle,\n};\n\nstruct drm_framebuffer *\nexynos_drm_framebuffer_init(struct drm_device *dev,\n\t\t\t    const struct drm_mode_fb_cmd2 *mode_cmd,\n\t\t\t    struct exynos_drm_gem **exynos_gem,\n\t\t\t    int count)\n{\n\tstruct drm_framebuffer *fb;\n\tint i;\n\tint ret;\n\n\tfb = kzalloc(sizeof(*fb), GFP_KERNEL);\n\tif (!fb)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tfor (i = 0; i < count; i++) {\n\t\tret = check_fb_gem_memory_type(dev, exynos_gem[i]);\n\t\tif (ret < 0)\n\t\t\tgoto err;\n\n\t\tfb->obj[i] = &exynos_gem[i]->base;\n\t}\n\n\tdrm_helper_mode_fill_fb_struct(dev, fb, mode_cmd);\n\n\tret = drm_framebuffer_init(dev, fb, &exynos_drm_fb_funcs);\n\tif (ret < 0) {\n\t\tDRM_DEV_ERROR(dev->dev,\n\t\t\t      \"failed to initialize framebuffer\\n\");\n\t\tgoto err;\n\t}\n\n\treturn fb;\n\nerr:\n\tkfree(fb);\n\treturn ERR_PTR(ret);\n}\n\nstatic struct drm_framebuffer *\nexynos_user_fb_create(struct drm_device *dev, struct drm_file *file_priv,\n\t\t      const struct drm_mode_fb_cmd2 *mode_cmd)\n{\n\tconst struct drm_format_info *info = drm_get_format_info(dev, mode_cmd);\n\tstruct exynos_drm_gem *exynos_gem[MAX_FB_BUFFER];\n\tstruct drm_framebuffer *fb;\n\tint i;\n\tint ret;\n\n\tfor (i = 0; i < info->num_planes; i++) {\n\t\tunsigned int height = (i == 0) ? mode_cmd->height :\n\t\t\t\t     DIV_ROUND_UP(mode_cmd->height, info->vsub);\n\t\tunsigned long size = height * mode_cmd->pitches[i] +\n\t\t\t\t     mode_cmd->offsets[i];\n\n\t\texynos_gem[i] = exynos_drm_gem_get(file_priv,\n\t\t\t\t\t\t   mode_cmd->handles[i]);\n\t\tif (!exynos_gem[i]) {\n\t\t\tDRM_DEV_ERROR(dev->dev,\n\t\t\t\t      \"failed to lookup gem object\\n\");\n\t\t\tret = -ENOENT;\n\t\t\tgoto err;\n\t\t}\n\n\t\tif (size > exynos_gem[i]->size) {\n\t\t\ti++;\n\t\t\tret = -EINVAL;\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\tfb = exynos_drm_framebuffer_init(dev, mode_cmd, exynos_gem, i);\n\tif (IS_ERR(fb)) {\n\t\tret = PTR_ERR(fb);\n\t\tgoto err;\n\t}\n\n\treturn fb;\n\nerr:\n\twhile (i--)\n\t\texynos_drm_gem_put(exynos_gem[i]);\n\n\treturn ERR_PTR(ret);\n}\n\ndma_addr_t exynos_drm_fb_dma_addr(struct drm_framebuffer *fb, int index)\n{\n\tstruct exynos_drm_gem *exynos_gem;\n\n\tif (WARN_ON_ONCE(index >= MAX_FB_BUFFER))\n\t\treturn 0;\n\n\texynos_gem = to_exynos_gem(fb->obj[index]);\n\treturn exynos_gem->dma_addr + fb->offsets[index];\n}\n\nstatic struct drm_mode_config_helper_funcs exynos_drm_mode_config_helpers = {\n\t.atomic_commit_tail = drm_atomic_helper_commit_tail_rpm,\n};\n\nstatic const struct drm_mode_config_funcs exynos_drm_mode_config_funcs = {\n\t.fb_create = exynos_user_fb_create,\n\t.atomic_check = drm_atomic_helper_check,\n\t.atomic_commit = drm_atomic_helper_commit,\n};\n\nvoid exynos_drm_mode_config_init(struct drm_device *dev)\n{\n\tdev->mode_config.min_width = 0;\n\tdev->mode_config.min_height = 0;\n\n\t \n\tdev->mode_config.max_width = 4096;\n\tdev->mode_config.max_height = 4096;\n\n\tdev->mode_config.funcs = &exynos_drm_mode_config_funcs;\n\tdev->mode_config.helper_private = &exynos_drm_mode_config_helpers;\n\n\tdev->mode_config.normalize_zpos = true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}