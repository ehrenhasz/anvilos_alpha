{
  "module_name": "exynos_drm_fbdev.c",
  "hash_id": "1304b102f6fe36e8b99092f05791a620550c9bab9538709fd1a30f96b3d07487",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/exynos/exynos_drm_fbdev.c",
  "human_readable_source": "\n \n\n#include <linux/fb.h>\n\n#include <drm/drm_crtc_helper.h>\n#include <drm/drm_drv.h>\n#include <drm/drm_fb_helper.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem_framebuffer_helper.h>\n#include <drm/drm_prime.h>\n#include <drm/exynos_drm.h>\n\n#include \"exynos_drm_drv.h\"\n#include \"exynos_drm_fb.h\"\n#include \"exynos_drm_fbdev.h\"\n\n#define MAX_CONNECTOR\t\t4\n#define PREFERRED_BPP\t\t32\n\nstatic int exynos_drm_fb_mmap(struct fb_info *info, struct vm_area_struct *vma)\n{\n\tstruct drm_fb_helper *helper = info->par;\n\tstruct drm_gem_object *obj = drm_gem_fb_get_obj(helper->fb, 0);\n\n\treturn drm_gem_prime_mmap(obj, vma);\n}\n\nstatic void exynos_drm_fb_destroy(struct fb_info *info)\n{\n\tstruct drm_fb_helper *fb_helper = info->par;\n\tstruct drm_framebuffer *fb = fb_helper->fb;\n\n\tdrm_fb_helper_fini(fb_helper);\n\n\tdrm_framebuffer_remove(fb);\n\n\tdrm_client_release(&fb_helper->client);\n\tdrm_fb_helper_unprepare(fb_helper);\n\tkfree(fb_helper);\n}\n\nstatic const struct fb_ops exynos_drm_fb_ops = {\n\t.owner\t\t= THIS_MODULE,\n\t__FB_DEFAULT_DMAMEM_OPS_RDWR,\n\tDRM_FB_HELPER_DEFAULT_OPS,\n\t__FB_DEFAULT_DMAMEM_OPS_DRAW,\n\t.fb_mmap        = exynos_drm_fb_mmap,\n\t.fb_destroy\t= exynos_drm_fb_destroy,\n};\n\nstatic int exynos_drm_fbdev_update(struct drm_fb_helper *helper,\n\t\t\t\t   struct drm_fb_helper_surface_size *sizes,\n\t\t\t\t   struct exynos_drm_gem *exynos_gem)\n{\n\tstruct fb_info *fbi;\n\tstruct drm_framebuffer *fb = helper->fb;\n\tunsigned int size = fb->width * fb->height * fb->format->cpp[0];\n\tunsigned long offset;\n\n\tfbi = drm_fb_helper_alloc_info(helper);\n\tif (IS_ERR(fbi)) {\n\t\tDRM_DEV_ERROR(to_dma_dev(helper->dev),\n\t\t\t      \"failed to allocate fb info.\\n\");\n\t\treturn PTR_ERR(fbi);\n\t}\n\n\tfbi->fbops = &exynos_drm_fb_ops;\n\n\tdrm_fb_helper_fill_info(fbi, helper, sizes);\n\n\toffset = fbi->var.xoffset * fb->format->cpp[0];\n\toffset += fbi->var.yoffset * fb->pitches[0];\n\n\tfbi->flags |= FBINFO_VIRTFB;\n\tfbi->screen_buffer = exynos_gem->kvaddr + offset;\n\tfbi->screen_size = size;\n\tfbi->fix.smem_len = size;\n\n\treturn 0;\n}\n\nstatic int exynos_drm_fbdev_create(struct drm_fb_helper *helper,\n\t\t\t\t    struct drm_fb_helper_surface_size *sizes)\n{\n\tstruct exynos_drm_gem *exynos_gem;\n\tstruct drm_device *dev = helper->dev;\n\tstruct drm_mode_fb_cmd2 mode_cmd = { 0 };\n\tunsigned long size;\n\tint ret;\n\n\tDRM_DEV_DEBUG_KMS(dev->dev,\n\t\t\t  \"surface width(%d), height(%d) and bpp(%d\\n\",\n\t\t\t  sizes->surface_width, sizes->surface_height,\n\t\t\t  sizes->surface_bpp);\n\n\tmode_cmd.width = sizes->surface_width;\n\tmode_cmd.height = sizes->surface_height;\n\tmode_cmd.pitches[0] = sizes->surface_width * (sizes->surface_bpp >> 3);\n\tmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\n\t\t\t\t\t\t\t  sizes->surface_depth);\n\n\tsize = mode_cmd.pitches[0] * mode_cmd.height;\n\n\texynos_gem = exynos_drm_gem_create(dev, EXYNOS_BO_WC, size, true);\n\tif (IS_ERR(exynos_gem))\n\t\treturn PTR_ERR(exynos_gem);\n\n\thelper->fb =\n\t\texynos_drm_framebuffer_init(dev, &mode_cmd, &exynos_gem, 1);\n\tif (IS_ERR(helper->fb)) {\n\t\tDRM_DEV_ERROR(dev->dev, \"failed to create drm framebuffer.\\n\");\n\t\tret = PTR_ERR(helper->fb);\n\t\tgoto err_destroy_gem;\n\t}\n\n\tret = exynos_drm_fbdev_update(helper, sizes, exynos_gem);\n\tif (ret < 0)\n\t\tgoto err_destroy_framebuffer;\n\n\treturn 0;\n\nerr_destroy_framebuffer:\n\tdrm_framebuffer_cleanup(helper->fb);\n\thelper->fb = NULL;\nerr_destroy_gem:\n\texynos_drm_gem_destroy(exynos_gem);\n\treturn ret;\n}\n\nstatic const struct drm_fb_helper_funcs exynos_drm_fb_helper_funcs = {\n\t.fb_probe =\texynos_drm_fbdev_create,\n};\n\n \n\nstatic void exynos_drm_fbdev_client_unregister(struct drm_client_dev *client)\n{\n\tstruct drm_fb_helper *fb_helper = drm_fb_helper_from_client(client);\n\n\tif (fb_helper->info) {\n\t\tdrm_fb_helper_unregister_info(fb_helper);\n\t} else {\n\t\tdrm_client_release(&fb_helper->client);\n\t\tdrm_fb_helper_unprepare(fb_helper);\n\t\tkfree(fb_helper);\n\t}\n}\n\nstatic int exynos_drm_fbdev_client_restore(struct drm_client_dev *client)\n{\n\tdrm_fb_helper_lastclose(client->dev);\n\n\treturn 0;\n}\n\nstatic int exynos_drm_fbdev_client_hotplug(struct drm_client_dev *client)\n{\n\tstruct drm_fb_helper *fb_helper = drm_fb_helper_from_client(client);\n\tstruct drm_device *dev = client->dev;\n\tint ret;\n\n\tif (dev->fb_helper)\n\t\treturn drm_fb_helper_hotplug_event(dev->fb_helper);\n\n\tret = drm_fb_helper_init(dev, fb_helper);\n\tif (ret)\n\t\tgoto err_drm_err;\n\n\tif (!drm_drv_uses_atomic_modeset(dev))\n\t\tdrm_helper_disable_unused_functions(dev);\n\n\tret = drm_fb_helper_initial_config(fb_helper);\n\tif (ret)\n\t\tgoto err_drm_fb_helper_fini;\n\n\treturn 0;\n\nerr_drm_fb_helper_fini:\n\tdrm_fb_helper_fini(fb_helper);\nerr_drm_err:\n\tdrm_err(dev, \"Failed to setup fbdev emulation (ret=%d)\\n\", ret);\n\treturn ret;\n}\n\nstatic const struct drm_client_funcs exynos_drm_fbdev_client_funcs = {\n\t.owner\t\t= THIS_MODULE,\n\t.unregister\t= exynos_drm_fbdev_client_unregister,\n\t.restore\t= exynos_drm_fbdev_client_restore,\n\t.hotplug\t= exynos_drm_fbdev_client_hotplug,\n};\n\nvoid exynos_drm_fbdev_setup(struct drm_device *dev)\n{\n\tstruct drm_fb_helper *fb_helper;\n\tint ret;\n\n\tdrm_WARN(dev, !dev->registered, \"Device has not been registered.\\n\");\n\tdrm_WARN(dev, dev->fb_helper, \"fb_helper is already set!\\n\");\n\n\tfb_helper = kzalloc(sizeof(*fb_helper), GFP_KERNEL);\n\tif (!fb_helper)\n\t\treturn;\n\tdrm_fb_helper_prepare(dev, fb_helper, PREFERRED_BPP, &exynos_drm_fb_helper_funcs);\n\n\tret = drm_client_init(dev, &fb_helper->client, \"fbdev\", &exynos_drm_fbdev_client_funcs);\n\tif (ret)\n\t\tgoto err_drm_client_init;\n\n\tdrm_client_register(&fb_helper->client);\n\n\treturn;\n\nerr_drm_client_init:\n\tdrm_fb_helper_unprepare(fb_helper);\n\tkfree(fb_helper);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}