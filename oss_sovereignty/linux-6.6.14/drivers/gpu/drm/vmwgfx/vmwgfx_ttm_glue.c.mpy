{
  "module_name": "vmwgfx_ttm_glue.c",
  "hash_id": "3868c4dfee37d84227246b615409656c5782f71e178250f1b2b4e144708bc5fa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/vmwgfx/vmwgfx_ttm_glue.c",
  "human_readable_source": "\n \n\n#include \"vmwgfx_drv.h\"\n\nstatic int vmw_bo_vm_lookup(struct ttm_device *bdev,\n\t\t\t\t   struct drm_file *filp,\n\t\t\t\t   unsigned long offset,\n\t\t\t\t   unsigned long pages,\n\t\t\t\t   struct ttm_buffer_object **p_bo)\n{\n\tstruct vmw_private *dev_priv = container_of(bdev, struct vmw_private, bdev);\n\tstruct drm_device *drm = &dev_priv->drm;\n\tstruct drm_vma_offset_node *node;\n\tint ret;\n\n\t*p_bo = NULL;\n\n\tdrm_vma_offset_lock_lookup(bdev->vma_manager);\n\n\tnode = drm_vma_offset_lookup_locked(bdev->vma_manager, offset, pages);\n\tif (likely(node)) {\n\t\t*p_bo = container_of(node, struct ttm_buffer_object,\n\t\t\t\t  base.vma_node);\n\t\t*p_bo = ttm_bo_get_unless_zero(*p_bo);\n\t}\n\n\tdrm_vma_offset_unlock_lookup(bdev->vma_manager);\n\n\tif (!*p_bo) {\n\t\tdrm_err(drm, \"Could not find buffer object to map\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (!drm_vma_node_is_allowed(node, filp)) {\n\t\tret = -EACCES;\n\t\tgoto out_no_access;\n\t}\n\n\treturn 0;\nout_no_access:\n\tttm_bo_put(*p_bo);\n\treturn ret;\n}\n\nint vmw_mmap(struct file *filp, struct vm_area_struct *vma)\n{\n\tstatic const struct vm_operations_struct vmw_vm_ops = {\n\t\t.pfn_mkwrite = vmw_bo_vm_mkwrite,\n\t\t.page_mkwrite = vmw_bo_vm_mkwrite,\n\t\t.fault = vmw_bo_vm_fault,\n\t\t.open = ttm_bo_vm_open,\n\t\t.close = ttm_bo_vm_close,\n\t};\n\tstruct drm_file *file_priv = filp->private_data;\n\tstruct vmw_private *dev_priv = vmw_priv(file_priv->minor->dev);\n\tstruct ttm_device *bdev = &dev_priv->bdev;\n\tstruct ttm_buffer_object *bo;\n\tint ret;\n\n\tif (unlikely(vma->vm_pgoff < DRM_FILE_PAGE_OFFSET_START))\n\t\treturn -EINVAL;\n\n\tret = vmw_bo_vm_lookup(bdev, file_priv, vma->vm_pgoff, vma_pages(vma), &bo);\n\tif (unlikely(ret != 0))\n\t\treturn ret;\n\n\tret = ttm_bo_mmap_obj(vma, bo);\n\tif (unlikely(ret != 0))\n\t\tgoto out_unref;\n\n\tvma->vm_ops = &vmw_vm_ops;\n\n\t \n\tif (!is_cow_mapping(vma->vm_flags))\n\t\tvm_flags_mod(vma, VM_PFNMAP, VM_MIXEDMAP);\n\n\tttm_bo_put(bo);  \n\n\treturn 0;\n\nout_unref:\n\tttm_bo_put(bo);\n\treturn ret;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}