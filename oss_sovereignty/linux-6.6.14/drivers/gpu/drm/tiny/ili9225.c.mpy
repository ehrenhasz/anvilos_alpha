{
  "module_name": "ili9225.c",
  "hash_id": "509291117b3d46f99db87b22564b6e2cceef98f519eca431248ce539438ae31e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/tiny/ili9225.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/dma-buf.h>\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/property.h>\n#include <linux/spi/spi.h>\n#include <video/mipi_display.h>\n\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_damage_helper.h>\n#include <drm/drm_drv.h>\n#include <drm/drm_fb_dma_helper.h>\n#include <drm/drm_fbdev_generic.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem_atomic_helper.h>\n#include <drm/drm_gem_dma_helper.h>\n#include <drm/drm_gem_framebuffer_helper.h>\n#include <drm/drm_managed.h>\n#include <drm/drm_mipi_dbi.h>\n#include <drm/drm_rect.h>\n\n#define ILI9225_DRIVER_READ_CODE\t0x00\n#define ILI9225_DRIVER_OUTPUT_CONTROL\t0x01\n#define ILI9225_LCD_AC_DRIVING_CONTROL\t0x02\n#define ILI9225_ENTRY_MODE\t\t0x03\n#define ILI9225_DISPLAY_CONTROL_1\t0x07\n#define ILI9225_BLANK_PERIOD_CONTROL_1\t0x08\n#define ILI9225_FRAME_CYCLE_CONTROL\t0x0b\n#define ILI9225_INTERFACE_CONTROL\t0x0c\n#define ILI9225_OSCILLATION_CONTROL\t0x0f\n#define ILI9225_POWER_CONTROL_1\t\t0x10\n#define ILI9225_POWER_CONTROL_2\t\t0x11\n#define ILI9225_POWER_CONTROL_3\t\t0x12\n#define ILI9225_POWER_CONTROL_4\t\t0x13\n#define ILI9225_POWER_CONTROL_5\t\t0x14\n#define ILI9225_VCI_RECYCLING\t\t0x15\n#define ILI9225_RAM_ADDRESS_SET_1\t0x20\n#define ILI9225_RAM_ADDRESS_SET_2\t0x21\n#define ILI9225_WRITE_DATA_TO_GRAM\t0x22\n#define ILI9225_SOFTWARE_RESET\t\t0x28\n#define ILI9225_GATE_SCAN_CONTROL\t0x30\n#define ILI9225_VERTICAL_SCROLL_1\t0x31\n#define ILI9225_VERTICAL_SCROLL_2\t0x32\n#define ILI9225_VERTICAL_SCROLL_3\t0x33\n#define ILI9225_PARTIAL_DRIVING_POS_1\t0x34\n#define ILI9225_PARTIAL_DRIVING_POS_2\t0x35\n#define ILI9225_HORIZ_WINDOW_ADDR_1\t0x36\n#define ILI9225_HORIZ_WINDOW_ADDR_2\t0x37\n#define ILI9225_VERT_WINDOW_ADDR_1\t0x38\n#define ILI9225_VERT_WINDOW_ADDR_2\t0x39\n#define ILI9225_GAMMA_CONTROL_1\t\t0x50\n#define ILI9225_GAMMA_CONTROL_2\t\t0x51\n#define ILI9225_GAMMA_CONTROL_3\t\t0x52\n#define ILI9225_GAMMA_CONTROL_4\t\t0x53\n#define ILI9225_GAMMA_CONTROL_5\t\t0x54\n#define ILI9225_GAMMA_CONTROL_6\t\t0x55\n#define ILI9225_GAMMA_CONTROL_7\t\t0x56\n#define ILI9225_GAMMA_CONTROL_8\t\t0x57\n#define ILI9225_GAMMA_CONTROL_9\t\t0x58\n#define ILI9225_GAMMA_CONTROL_10\t0x59\n\nstatic inline int ili9225_command(struct mipi_dbi *dbi, u8 cmd, u16 data)\n{\n\tu8 par[2] = { data >> 8, data & 0xff };\n\n\treturn mipi_dbi_command_buf(dbi, cmd, par, 2);\n}\n\nstatic void ili9225_fb_dirty(struct iosys_map *src, struct drm_framebuffer *fb,\n\t\t\t     struct drm_rect *rect)\n{\n\tstruct mipi_dbi_dev *dbidev = drm_to_mipi_dbi_dev(fb->dev);\n\tunsigned int height = rect->y2 - rect->y1;\n\tunsigned int width = rect->x2 - rect->x1;\n\tstruct mipi_dbi *dbi = &dbidev->dbi;\n\tbool swap = dbi->swap_bytes;\n\tu16 x_start, y_start;\n\tu16 x1, x2, y1, y2;\n\tint ret = 0;\n\tbool full;\n\tvoid *tr;\n\n\tfull = width == fb->width && height == fb->height;\n\n\tDRM_DEBUG_KMS(\"Flushing [FB:%d] \" DRM_RECT_FMT \"\\n\", fb->base.id, DRM_RECT_ARG(rect));\n\n\tif (!dbi->dc || !full || swap ||\n\t    fb->format->format == DRM_FORMAT_XRGB8888) {\n\t\ttr = dbidev->tx_buf;\n\t\tret = mipi_dbi_buf_copy(tr, src, fb, rect, swap);\n\t\tif (ret)\n\t\t\tgoto err_msg;\n\t} else {\n\t\ttr = src->vaddr;  \n\t}\n\n\tswitch (dbidev->rotation) {\n\tdefault:\n\t\tx1 = rect->x1;\n\t\tx2 = rect->x2 - 1;\n\t\ty1 = rect->y1;\n\t\ty2 = rect->y2 - 1;\n\t\tx_start = x1;\n\t\ty_start = y1;\n\t\tbreak;\n\tcase 90:\n\t\tx1 = rect->y1;\n\t\tx2 = rect->y2 - 1;\n\t\ty1 = fb->width - rect->x2;\n\t\ty2 = fb->width - rect->x1 - 1;\n\t\tx_start = x1;\n\t\ty_start = y2;\n\t\tbreak;\n\tcase 180:\n\t\tx1 = fb->width - rect->x2;\n\t\tx2 = fb->width - rect->x1 - 1;\n\t\ty1 = fb->height - rect->y2;\n\t\ty2 = fb->height - rect->y1 - 1;\n\t\tx_start = x2;\n\t\ty_start = y2;\n\t\tbreak;\n\tcase 270:\n\t\tx1 = fb->height - rect->y2;\n\t\tx2 = fb->height - rect->y1 - 1;\n\t\ty1 = rect->x1;\n\t\ty2 = rect->x2 - 1;\n\t\tx_start = x2;\n\t\ty_start = y1;\n\t\tbreak;\n\t}\n\n\tili9225_command(dbi, ILI9225_HORIZ_WINDOW_ADDR_1, x2);\n\tili9225_command(dbi, ILI9225_HORIZ_WINDOW_ADDR_2, x1);\n\tili9225_command(dbi, ILI9225_VERT_WINDOW_ADDR_1, y2);\n\tili9225_command(dbi, ILI9225_VERT_WINDOW_ADDR_2, y1);\n\n\tili9225_command(dbi, ILI9225_RAM_ADDRESS_SET_1, x_start);\n\tili9225_command(dbi, ILI9225_RAM_ADDRESS_SET_2, y_start);\n\n\tret = mipi_dbi_command_buf(dbi, ILI9225_WRITE_DATA_TO_GRAM, tr,\n\t\t\t\t   width * height * 2);\nerr_msg:\n\tif (ret)\n\t\tdev_err_once(fb->dev->dev, \"Failed to update display %d\\n\", ret);\n}\n\nstatic void ili9225_pipe_update(struct drm_simple_display_pipe *pipe,\n\t\t\t\tstruct drm_plane_state *old_state)\n{\n\tstruct drm_plane_state *state = pipe->plane.state;\n\tstruct drm_shadow_plane_state *shadow_plane_state = to_drm_shadow_plane_state(state);\n\tstruct drm_framebuffer *fb = state->fb;\n\tstruct drm_rect rect;\n\tint idx;\n\n\tif (!pipe->crtc.state->active)\n\t\treturn;\n\n\tif (!drm_dev_enter(fb->dev, &idx))\n\t\treturn;\n\n\tif (drm_atomic_helper_damage_merged(old_state, state, &rect))\n\t\tili9225_fb_dirty(&shadow_plane_state->data[0], fb, &rect);\n\n\tdrm_dev_exit(idx);\n}\n\nstatic void ili9225_pipe_enable(struct drm_simple_display_pipe *pipe,\n\t\t\t\tstruct drm_crtc_state *crtc_state,\n\t\t\t\tstruct drm_plane_state *plane_state)\n{\n\tstruct mipi_dbi_dev *dbidev = drm_to_mipi_dbi_dev(pipe->crtc.dev);\n\tstruct drm_shadow_plane_state *shadow_plane_state = to_drm_shadow_plane_state(plane_state);\n\tstruct drm_framebuffer *fb = plane_state->fb;\n\tstruct device *dev = pipe->crtc.dev->dev;\n\tstruct mipi_dbi *dbi = &dbidev->dbi;\n\tstruct drm_rect rect = {\n\t\t.x1 = 0,\n\t\t.x2 = fb->width,\n\t\t.y1 = 0,\n\t\t.y2 = fb->height,\n\t};\n\tint ret, idx;\n\tu8 am_id;\n\n\tif (!drm_dev_enter(pipe->crtc.dev, &idx))\n\t\treturn;\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\tmipi_dbi_hw_reset(dbi);\n\n\t \n\n\tret = ili9225_command(dbi, ILI9225_POWER_CONTROL_1, 0x0000);\n\tif (ret) {\n\t\tDRM_DEV_ERROR(dev, \"Error sending command %d\\n\", ret);\n\t\tgoto out_exit;\n\t}\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_2, 0x0000);\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_3, 0x0000);\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_4, 0x0000);\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_5, 0x0000);\n\n\tmsleep(40);\n\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_2, 0x0018);\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_3, 0x6121);\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_4, 0x006f);\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_5, 0x495f);\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_1, 0x0800);\n\n\tmsleep(10);\n\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_2, 0x103b);\n\n\tmsleep(50);\n\n\tswitch (dbidev->rotation) {\n\tdefault:\n\t\tam_id = 0x30;\n\t\tbreak;\n\tcase 90:\n\t\tam_id = 0x18;\n\t\tbreak;\n\tcase 180:\n\t\tam_id = 0x00;\n\t\tbreak;\n\tcase 270:\n\t\tam_id = 0x28;\n\t\tbreak;\n\t}\n\tili9225_command(dbi, ILI9225_DRIVER_OUTPUT_CONTROL, 0x011c);\n\tili9225_command(dbi, ILI9225_LCD_AC_DRIVING_CONTROL, 0x0100);\n\tili9225_command(dbi, ILI9225_ENTRY_MODE, 0x1000 | am_id);\n\tili9225_command(dbi, ILI9225_DISPLAY_CONTROL_1, 0x0000);\n\tili9225_command(dbi, ILI9225_BLANK_PERIOD_CONTROL_1, 0x0808);\n\tili9225_command(dbi, ILI9225_FRAME_CYCLE_CONTROL, 0x1100);\n\tili9225_command(dbi, ILI9225_INTERFACE_CONTROL, 0x0000);\n\tili9225_command(dbi, ILI9225_OSCILLATION_CONTROL, 0x0d01);\n\tili9225_command(dbi, ILI9225_VCI_RECYCLING, 0x0020);\n\tili9225_command(dbi, ILI9225_RAM_ADDRESS_SET_1, 0x0000);\n\tili9225_command(dbi, ILI9225_RAM_ADDRESS_SET_2, 0x0000);\n\n\tili9225_command(dbi, ILI9225_GATE_SCAN_CONTROL, 0x0000);\n\tili9225_command(dbi, ILI9225_VERTICAL_SCROLL_1, 0x00db);\n\tili9225_command(dbi, ILI9225_VERTICAL_SCROLL_2, 0x0000);\n\tili9225_command(dbi, ILI9225_VERTICAL_SCROLL_3, 0x0000);\n\tili9225_command(dbi, ILI9225_PARTIAL_DRIVING_POS_1, 0x00db);\n\tili9225_command(dbi, ILI9225_PARTIAL_DRIVING_POS_2, 0x0000);\n\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_1, 0x0000);\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_2, 0x0808);\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_3, 0x080a);\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_4, 0x000a);\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_5, 0x0a08);\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_6, 0x0808);\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_7, 0x0000);\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_8, 0x0a00);\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_9, 0x0710);\n\tili9225_command(dbi, ILI9225_GAMMA_CONTROL_10, 0x0710);\n\n\tili9225_command(dbi, ILI9225_DISPLAY_CONTROL_1, 0x0012);\n\n\tmsleep(50);\n\n\tili9225_command(dbi, ILI9225_DISPLAY_CONTROL_1, 0x1017);\n\n\tili9225_fb_dirty(&shadow_plane_state->data[0], fb, &rect);\n\nout_exit:\n\tdrm_dev_exit(idx);\n}\n\nstatic void ili9225_pipe_disable(struct drm_simple_display_pipe *pipe)\n{\n\tstruct mipi_dbi_dev *dbidev = drm_to_mipi_dbi_dev(pipe->crtc.dev);\n\tstruct mipi_dbi *dbi = &dbidev->dbi;\n\n\tDRM_DEBUG_KMS(\"\\n\");\n\n\t \n\n\tili9225_command(dbi, ILI9225_DISPLAY_CONTROL_1, 0x0000);\n\tmsleep(50);\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_2, 0x0007);\n\tmsleep(50);\n\tili9225_command(dbi, ILI9225_POWER_CONTROL_1, 0x0a02);\n}\n\nstatic int ili9225_dbi_command(struct mipi_dbi *dbi, u8 *cmd, u8 *par,\n\t\t\t       size_t num)\n{\n\tstruct spi_device *spi = dbi->spi;\n\tunsigned int bpw = 8;\n\tu32 speed_hz;\n\tint ret;\n\n\tspi_bus_lock(spi->controller);\n\tgpiod_set_value_cansleep(dbi->dc, 0);\n\tspeed_hz = mipi_dbi_spi_cmd_max_speed(spi, 1);\n\tret = mipi_dbi_spi_transfer(spi, speed_hz, 8, cmd, 1);\n\tspi_bus_unlock(spi->controller);\n\tif (ret || !num)\n\t\treturn ret;\n\n\tif (*cmd == ILI9225_WRITE_DATA_TO_GRAM && !dbi->swap_bytes)\n\t\tbpw = 16;\n\n\tspi_bus_lock(spi->controller);\n\tgpiod_set_value_cansleep(dbi->dc, 1);\n\tspeed_hz = mipi_dbi_spi_cmd_max_speed(spi, num);\n\tret = mipi_dbi_spi_transfer(spi, speed_hz, bpw, par, num);\n\tspi_bus_unlock(spi->controller);\n\n\treturn ret;\n}\n\nstatic const struct drm_simple_display_pipe_funcs ili9225_pipe_funcs = {\n\t.mode_valid\t= mipi_dbi_pipe_mode_valid,\n\t.enable\t\t= ili9225_pipe_enable,\n\t.disable\t= ili9225_pipe_disable,\n\t.update\t\t= ili9225_pipe_update,\n\t.begin_fb_access = mipi_dbi_pipe_begin_fb_access,\n\t.end_fb_access\t= mipi_dbi_pipe_end_fb_access,\n\t.reset_plane\t= mipi_dbi_pipe_reset_plane,\n\t.duplicate_plane_state = mipi_dbi_pipe_duplicate_plane_state,\n\t.destroy_plane_state = mipi_dbi_pipe_destroy_plane_state,\n};\n\nstatic const struct drm_display_mode ili9225_mode = {\n\tDRM_SIMPLE_MODE(176, 220, 35, 44),\n};\n\nDEFINE_DRM_GEM_DMA_FOPS(ili9225_fops);\n\nstatic const struct drm_driver ili9225_driver = {\n\t.driver_features\t= DRIVER_GEM | DRIVER_MODESET | DRIVER_ATOMIC,\n\t.fops\t\t\t= &ili9225_fops,\n\tDRM_GEM_DMA_DRIVER_OPS_VMAP,\n\t.name\t\t\t= \"ili9225\",\n\t.desc\t\t\t= \"Ilitek ILI9225\",\n\t.date\t\t\t= \"20171106\",\n\t.major\t\t\t= 1,\n\t.minor\t\t\t= 0,\n};\n\nstatic const struct of_device_id ili9225_of_match[] = {\n\t{ .compatible = \"vot,v220hf01a-t\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, ili9225_of_match);\n\nstatic const struct spi_device_id ili9225_id[] = {\n\t{ \"v220hf01a-t\", 0 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(spi, ili9225_id);\n\nstatic int ili9225_probe(struct spi_device *spi)\n{\n\tstruct device *dev = &spi->dev;\n\tstruct mipi_dbi_dev *dbidev;\n\tstruct drm_device *drm;\n\tstruct mipi_dbi *dbi;\n\tstruct gpio_desc *rs;\n\tu32 rotation = 0;\n\tint ret;\n\n\tdbidev = devm_drm_dev_alloc(dev, &ili9225_driver,\n\t\t\t\t    struct mipi_dbi_dev, drm);\n\tif (IS_ERR(dbidev))\n\t\treturn PTR_ERR(dbidev);\n\n\tdbi = &dbidev->dbi;\n\tdrm = &dbidev->drm;\n\n\tdbi->reset = devm_gpiod_get(dev, \"reset\", GPIOD_OUT_HIGH);\n\tif (IS_ERR(dbi->reset))\n\t\treturn dev_err_probe(dev, PTR_ERR(dbi->reset), \"Failed to get GPIO 'reset'\\n\");\n\n\trs = devm_gpiod_get(dev, \"rs\", GPIOD_OUT_LOW);\n\tif (IS_ERR(rs))\n\t\treturn dev_err_probe(dev, PTR_ERR(rs), \"Failed to get GPIO 'rs'\\n\");\n\n\tdevice_property_read_u32(dev, \"rotation\", &rotation);\n\n\tret = mipi_dbi_spi_init(spi, dbi, rs);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tdbi->command = ili9225_dbi_command;\n\n\tret = mipi_dbi_dev_init(dbidev, &ili9225_pipe_funcs, &ili9225_mode, rotation);\n\tif (ret)\n\t\treturn ret;\n\n\tdrm_mode_config_reset(drm);\n\n\tret = drm_dev_register(drm, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tspi_set_drvdata(spi, drm);\n\n\tdrm_fbdev_generic_setup(drm, 0);\n\n\treturn 0;\n}\n\nstatic void ili9225_remove(struct spi_device *spi)\n{\n\tstruct drm_device *drm = spi_get_drvdata(spi);\n\n\tdrm_dev_unplug(drm);\n\tdrm_atomic_helper_shutdown(drm);\n}\n\nstatic void ili9225_shutdown(struct spi_device *spi)\n{\n\tdrm_atomic_helper_shutdown(spi_get_drvdata(spi));\n}\n\nstatic struct spi_driver ili9225_spi_driver = {\n\t.driver = {\n\t\t.name = \"ili9225\",\n\t\t.owner = THIS_MODULE,\n\t\t.of_match_table = ili9225_of_match,\n\t},\n\t.id_table = ili9225_id,\n\t.probe = ili9225_probe,\n\t.remove = ili9225_remove,\n\t.shutdown = ili9225_shutdown,\n};\nmodule_spi_driver(ili9225_spi_driver);\n\nMODULE_DESCRIPTION(\"Ilitek ILI9225 DRM driver\");\nMODULE_AUTHOR(\"David Lechner <david@lechnology.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}