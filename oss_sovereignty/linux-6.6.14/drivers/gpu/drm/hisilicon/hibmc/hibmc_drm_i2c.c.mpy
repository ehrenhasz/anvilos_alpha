{
  "module_name": "hibmc_drm_i2c.c",
  "hash_id": "cd9a296ec5443e1f0e0e6f977d0b9f6e09f5bf46f9ac88ada45fa677b074afd3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/hisilicon/hibmc/hibmc_drm_i2c.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/pci.h>\n\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_probe_helper.h>\n\n#include \"hibmc_drm_drv.h\"\n\n#define GPIO_DATA\t\t0x0802A0\n#define GPIO_DATA_DIRECTION\t0x0802A4\n\n#define I2C_SCL_MASK\t\tBIT(0)\n#define I2C_SDA_MASK\t\tBIT(1)\n\nstatic void hibmc_set_i2c_signal(void *data, u32 mask, int value)\n{\n\tstruct hibmc_connector *hibmc_connector = data;\n\tstruct hibmc_drm_private *priv = to_hibmc_drm_private(hibmc_connector->base.dev);\n\tu32 tmp_dir = readl(priv->mmio + GPIO_DATA_DIRECTION);\n\n\tif (value) {\n\t\ttmp_dir &= ~mask;\n\t\twritel(tmp_dir, priv->mmio + GPIO_DATA_DIRECTION);\n\t} else {\n\t\tu32 tmp_data = readl(priv->mmio + GPIO_DATA);\n\n\t\ttmp_data &= ~mask;\n\t\twritel(tmp_data, priv->mmio + GPIO_DATA);\n\n\t\ttmp_dir |= mask;\n\t\twritel(tmp_dir, priv->mmio + GPIO_DATA_DIRECTION);\n\t}\n}\n\nstatic int hibmc_get_i2c_signal(void *data, u32 mask)\n{\n\tstruct hibmc_connector *hibmc_connector = data;\n\tstruct hibmc_drm_private *priv = to_hibmc_drm_private(hibmc_connector->base.dev);\n\tu32 tmp_dir = readl(priv->mmio + GPIO_DATA_DIRECTION);\n\n\tif ((tmp_dir & mask) != mask) {\n\t\ttmp_dir &= ~mask;\n\t\twritel(tmp_dir, priv->mmio + GPIO_DATA_DIRECTION);\n\t}\n\n\treturn (readl(priv->mmio + GPIO_DATA) & mask) ? 1 : 0;\n}\n\nstatic void hibmc_ddc_setsda(void *data, int state)\n{\n\thibmc_set_i2c_signal(data, I2C_SDA_MASK, state);\n}\n\nstatic void hibmc_ddc_setscl(void *data, int state)\n{\n\thibmc_set_i2c_signal(data, I2C_SCL_MASK, state);\n}\n\nstatic int hibmc_ddc_getsda(void *data)\n{\n\treturn hibmc_get_i2c_signal(data, I2C_SDA_MASK);\n}\n\nstatic int hibmc_ddc_getscl(void *data)\n{\n\treturn hibmc_get_i2c_signal(data, I2C_SCL_MASK);\n}\n\nint hibmc_ddc_create(struct drm_device *drm_dev,\n\t\t     struct hibmc_connector *connector)\n{\n\tconnector->adapter.owner = THIS_MODULE;\n\tconnector->adapter.class = I2C_CLASS_DDC;\n\tsnprintf(connector->adapter.name, I2C_NAME_SIZE, \"HIS i2c bit bus\");\n\tconnector->adapter.dev.parent = drm_dev->dev;\n\ti2c_set_adapdata(&connector->adapter, connector);\n\tconnector->adapter.algo_data = &connector->bit_data;\n\n\tconnector->bit_data.udelay = 20;\n\tconnector->bit_data.timeout = usecs_to_jiffies(2000);\n\tconnector->bit_data.data = connector;\n\tconnector->bit_data.setsda = hibmc_ddc_setsda;\n\tconnector->bit_data.setscl = hibmc_ddc_setscl;\n\tconnector->bit_data.getsda = hibmc_ddc_getsda;\n\tconnector->bit_data.getscl = hibmc_ddc_getscl;\n\n\treturn i2c_bit_add_bus(&connector->adapter);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}