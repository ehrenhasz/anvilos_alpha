{
  "module_name": "vc4_hdmi_phy.c",
  "hash_id": "4218d1746192d5e4d20b7b6937caf0befc585202739f1bf9ba80302692451dc0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/vc4/vc4_hdmi_phy.c",
  "human_readable_source": "\n \n\n#include \"vc4_hdmi.h\"\n#include \"vc4_regs.h\"\n#include \"vc4_hdmi_regs.h\"\n\n#define VC4_HDMI_TX_PHY_RESET_CTL_PLL_RESETB\tBIT(5)\n#define VC4_HDMI_TX_PHY_RESET_CTL_PLLDIV_RESETB\tBIT(4)\n#define VC4_HDMI_TX_PHY_RESET_CTL_TX_CK_RESET\tBIT(3)\n#define VC4_HDMI_TX_PHY_RESET_CTL_TX_2_RESET\tBIT(2)\n#define VC4_HDMI_TX_PHY_RESET_CTL_TX_1_RESET\tBIT(1)\n#define VC4_HDMI_TX_PHY_RESET_CTL_TX_0_RESET\tBIT(0)\n\n#define VC4_HDMI_TX_PHY_POWERDOWN_CTL_RNDGEN_PWRDN\tBIT(4)\n\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_2_PREEMP_SHIFT\t29\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_2_PREEMP_MASK\tVC4_MASK(31, 29)\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_2_MAINDRV_SHIFT\t24\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_2_MAINDRV_MASK\tVC4_MASK(28, 24)\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_1_PREEMP_SHIFT\t21\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_1_PREEMP_MASK\tVC4_MASK(23, 21)\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_1_MAINDRV_SHIFT\t16\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_1_MAINDRV_MASK\tVC4_MASK(20, 16)\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_0_PREEMP_SHIFT\t13\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_0_PREEMP_MASK\tVC4_MASK(15, 13)\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_0_MAINDRV_SHIFT\t8\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_0_MAINDRV_MASK\tVC4_MASK(12, 8)\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_CK_PREEMP_SHIFT\t5\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_CK_PREEMP_MASK\tVC4_MASK(7, 5)\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_CK_MAINDRV_SHIFT\t0\n#define VC4_HDMI_TX_PHY_CTL_0_PREEMP_CK_MAINDRV_MASK\tVC4_MASK(4, 0)\n\n#define VC4_HDMI_TX_PHY_CTL_1_RES_SEL_DATA2_SHIFT\t15\n#define VC4_HDMI_TX_PHY_CTL_1_RES_SEL_DATA2_MASK\tVC4_MASK(19, 15)\n#define VC4_HDMI_TX_PHY_CTL_1_RES_SEL_DATA1_SHIFT\t10\n#define VC4_HDMI_TX_PHY_CTL_1_RES_SEL_DATA1_MASK\tVC4_MASK(14, 10)\n#define VC4_HDMI_TX_PHY_CTL_1_RES_SEL_DATA0_SHIFT\t5\n#define VC4_HDMI_TX_PHY_CTL_1_RES_SEL_DATA0_MASK\tVC4_MASK(9, 5)\n#define VC4_HDMI_TX_PHY_CTL_1_RES_SEL_CK_SHIFT\t\t0\n#define VC4_HDMI_TX_PHY_CTL_1_RES_SEL_CK_MASK\t\tVC4_MASK(4, 0)\n\n#define VC4_HDMI_TX_PHY_CTL_2_VCO_GAIN_SHIFT\t\t16\n#define VC4_HDMI_TX_PHY_CTL_2_VCO_GAIN_MASK\t\tVC4_MASK(19, 16)\n#define VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELDATA2_SHIFT\t12\n#define VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELDATA2_MASK\tVC4_MASK(15, 12)\n#define VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELDATA1_SHIFT\t8\n#define VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELDATA1_MASK\tVC4_MASK(11, 8)\n#define VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELDATA0_SHIFT\t4\n#define VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELDATA0_MASK\tVC4_MASK(7, 4)\n#define VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELCK_SHIFT\t0\n#define VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELCK_MASK\tVC4_MASK(3, 0)\n\n#define VC4_HDMI_TX_PHY_CTL_3_RP_SHIFT\t\t\t17\n#define VC4_HDMI_TX_PHY_CTL_3_RP_MASK\t\t\tVC4_MASK(19, 17)\n#define VC4_HDMI_TX_PHY_CTL_3_RZ_SHIFT\t\t\t12\n#define VC4_HDMI_TX_PHY_CTL_3_RZ_MASK\t\t\tVC4_MASK(16, 12)\n#define VC4_HDMI_TX_PHY_CTL_3_CP1_SHIFT\t\t\t10\n#define VC4_HDMI_TX_PHY_CTL_3_CP1_MASK\t\t\tVC4_MASK(11, 10)\n#define VC4_HDMI_TX_PHY_CTL_3_CP_SHIFT\t\t\t8\n#define VC4_HDMI_TX_PHY_CTL_3_CP_MASK\t\t\tVC4_MASK(9, 8)\n#define VC4_HDMI_TX_PHY_CTL_3_CZ_SHIFT\t\t\t6\n#define VC4_HDMI_TX_PHY_CTL_3_CZ_MASK\t\t\tVC4_MASK(7, 6)\n#define VC4_HDMI_TX_PHY_CTL_3_ICP_SHIFT\t\t\t0\n#define VC4_HDMI_TX_PHY_CTL_3_ICP_MASK\t\t\tVC4_MASK(5, 0)\n\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_MASH11_MODE\t\tBIT(13)\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_VC_RANGE_EN\t\tBIT(12)\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_EMULATE_VC_LOW\tBIT(11)\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_EMULATE_VC_HIGH\tBIT(10)\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_VCO_SEL_SHIFT\t\t9\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_VCO_SEL_MASK\t\tVC4_MASK(9, 9)\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_VCO_FB_DIV2\t\tBIT(8)\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_VCO_POST_DIV2\t\tBIT(7)\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_VCO_CONT_EN\t\tBIT(6)\n#define VC4_HDMI_TX_PHY_PLL_CTL_0_ENA_VCO_CLK\t\tBIT(5)\n\n#define VC4_HDMI_TX_PHY_PLL_CTL_1_CPP_SHIFT\t\t\t16\n#define VC4_HDMI_TX_PHY_PLL_CTL_1_CPP_MASK\t\t\tVC4_MASK(27, 16)\n#define VC4_HDMI_TX_PHY_PLL_CTL_1_FREQ_DOUBLER_DELAY_SHIFT\t14\n#define VC4_HDMI_TX_PHY_PLL_CTL_1_FREQ_DOUBLER_DELAY_MASK\tVC4_MASK(15, 14)\n#define VC4_HDMI_TX_PHY_PLL_CTL_1_FREQ_DOUBLER_ENABLE\t\tBIT(13)\n#define VC4_HDMI_TX_PHY_PLL_CTL_1_POST_RST_SEL_SHIFT\t\t11\n#define VC4_HDMI_TX_PHY_PLL_CTL_1_POST_RST_SEL_MASK\t\tVC4_MASK(12, 11)\n\n#define VC4_HDMI_TX_PHY_CLK_DIV_VCO_SHIFT\t\t8\n#define VC4_HDMI_TX_PHY_CLK_DIV_VCO_MASK\t\tVC4_MASK(15, 8)\n\n#define VC4_HDMI_TX_PHY_PLL_CFG_PDIV_SHIFT\t\t0\n#define VC4_HDMI_TX_PHY_PLL_CFG_PDIV_MASK\t\tVC4_MASK(3, 0)\n\n#define VC4_HDMI_TX_PHY_CHANNEL_SWAP_TXCK_OUT_SEL_MASK\tVC4_MASK(13, 12)\n#define VC4_HDMI_TX_PHY_CHANNEL_SWAP_TXCK_OUT_SEL_SHIFT\t12\n#define VC4_HDMI_TX_PHY_CHANNEL_SWAP_TX2_OUT_SEL_MASK\tVC4_MASK(9, 8)\n#define VC4_HDMI_TX_PHY_CHANNEL_SWAP_TX2_OUT_SEL_SHIFT\t8\n#define VC4_HDMI_TX_PHY_CHANNEL_SWAP_TX1_OUT_SEL_MASK\tVC4_MASK(5, 4)\n#define VC4_HDMI_TX_PHY_CHANNEL_SWAP_TX1_OUT_SEL_SHIFT\t4\n#define VC4_HDMI_TX_PHY_CHANNEL_SWAP_TX0_OUT_SEL_MASK\tVC4_MASK(1, 0)\n#define VC4_HDMI_TX_PHY_CHANNEL_SWAP_TX0_OUT_SEL_SHIFT\t0\n\n#define VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_1_MIN_LIMIT_MASK\t\tVC4_MASK(27, 0)\n#define VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_1_MIN_LIMIT_SHIFT\t0\n\n#define VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_2_MAX_LIMIT_MASK\t\tVC4_MASK(27, 0)\n#define VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_2_MAX_LIMIT_SHIFT\t0\n\n#define VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_4_STABLE_THRESHOLD_MASK\tVC4_MASK(31, 16)\n#define VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_4_STABLE_THRESHOLD_SHIFT\t16\n#define VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_4_HOLD_THRESHOLD_MASK\tVC4_MASK(15, 0)\n#define VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_4_HOLD_THRESHOLD_SHIFT\t0\n\n#define VC4_HDMI_RM_CONTROL_EN_FREEZE_COUNTERS\t\tBIT(19)\n#define VC4_HDMI_RM_CONTROL_EN_LOAD_INTEGRATOR\t\tBIT(17)\n#define VC4_HDMI_RM_CONTROL_FREE_RUN\t\t\tBIT(4)\n\n#define VC4_HDMI_RM_OFFSET_ONLY\t\t\t\tBIT(31)\n#define VC4_HDMI_RM_OFFSET_OFFSET_SHIFT\t\t\t0\n#define VC4_HDMI_RM_OFFSET_OFFSET_MASK\t\t\tVC4_MASK(30, 0)\n\n#define VC4_HDMI_RM_FORMAT_SHIFT_SHIFT\t\t\t24\n#define VC4_HDMI_RM_FORMAT_SHIFT_MASK\t\t\tVC4_MASK(25, 24)\n\n#define OSCILLATOR_FREQUENCY\t54000000\n\nvoid vc4_hdmi_phy_init(struct vc4_hdmi *vc4_hdmi,\n\t\t       struct vc4_hdmi_connector_state *conn_state)\n{\n\tunsigned long flags;\n\n\t \n\n\tspin_lock_irqsave(&vc4_hdmi->hw_lock, flags);\n\n\tHDMI_WRITE(HDMI_TX_PHY_RESET_CTL, 0xf << 16);\n\tHDMI_WRITE(HDMI_TX_PHY_RESET_CTL, 0);\n\n\tspin_unlock_irqrestore(&vc4_hdmi->hw_lock, flags);\n}\n\nvoid vc4_hdmi_phy_disable(struct vc4_hdmi *vc4_hdmi)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vc4_hdmi->hw_lock, flags);\n\tHDMI_WRITE(HDMI_TX_PHY_RESET_CTL, 0xf << 16);\n\tspin_unlock_irqrestore(&vc4_hdmi->hw_lock, flags);\n}\n\nvoid vc4_hdmi_phy_rng_enable(struct vc4_hdmi *vc4_hdmi)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vc4_hdmi->hw_lock, flags);\n\tHDMI_WRITE(HDMI_TX_PHY_CTL_0,\n\t\t   HDMI_READ(HDMI_TX_PHY_CTL_0) &\n\t\t   ~VC4_HDMI_TX_PHY_RNG_PWRDN);\n\tspin_unlock_irqrestore(&vc4_hdmi->hw_lock, flags);\n}\n\nvoid vc4_hdmi_phy_rng_disable(struct vc4_hdmi *vc4_hdmi)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vc4_hdmi->hw_lock, flags);\n\tHDMI_WRITE(HDMI_TX_PHY_CTL_0,\n\t\t   HDMI_READ(HDMI_TX_PHY_CTL_0) |\n\t\t   VC4_HDMI_TX_PHY_RNG_PWRDN);\n\tspin_unlock_irqrestore(&vc4_hdmi->hw_lock, flags);\n}\n\nstatic unsigned long long\nphy_get_vco_freq(unsigned long long clock, u8 *vco_sel, u8 *vco_div)\n{\n\tunsigned long long vco_freq = clock;\n\tunsigned int _vco_div = 0;\n\tunsigned int _vco_sel = 0;\n\n\twhile (vco_freq < 3000000000ULL) {\n\t\t_vco_div++;\n\t\tvco_freq = clock * _vco_div * 10;\n\t}\n\n\tif (vco_freq > 4500000000ULL)\n\t\t_vco_sel = 1;\n\n\t*vco_sel = _vco_sel;\n\t*vco_div = _vco_div;\n\n\treturn vco_freq;\n}\n\nstatic u8 phy_get_cp_current(unsigned long vco_freq)\n{\n\tif (vco_freq < 3700000000ULL)\n\t\treturn 0x1c;\n\n\treturn 0x18;\n}\n\nstatic u32 phy_get_rm_offset(unsigned long long vco_freq)\n{\n\tunsigned long long fref = OSCILLATOR_FREQUENCY;\n\tu64 offset = 0;\n\n\t \n\toffset = vco_freq * 2;\n\toffset = offset << 22;\n\tdo_div(offset, fref);\n\toffset >>= 2;\n\n\treturn offset;\n}\n\nstatic u8 phy_get_vco_gain(unsigned long long vco_freq)\n{\n\tif (vco_freq < 3350000000ULL)\n\t\treturn 0xf;\n\n\tif (vco_freq < 3700000000ULL)\n\t\treturn 0xc;\n\n\tif (vco_freq < 4050000000ULL)\n\t\treturn 0x6;\n\n\tif (vco_freq < 4800000000ULL)\n\t\treturn 0x5;\n\n\tif (vco_freq < 5200000000ULL)\n\t\treturn 0x7;\n\n\treturn 0x2;\n}\n\nstruct phy_lane_settings {\n\tstruct {\n\t\tu8 preemphasis;\n\t\tu8 main_driver;\n\t} amplitude;\n\n\tu8 res_sel_data;\n\tu8 term_res_sel_data;\n};\n\nstruct phy_settings {\n\tunsigned long long min_rate;\n\tunsigned long long max_rate;\n\tstruct phy_lane_settings channel[3];\n\tstruct phy_lane_settings clock;\n};\n\nstatic const struct phy_settings vc5_hdmi_phy_settings[] = {\n\t{\n\t\t0, 50000000,\n\t\t{\n\t\t\t{{0x0, 0x0A}, 0x12, 0x0},\n\t\t\t{{0x0, 0x0A}, 0x12, 0x0},\n\t\t\t{{0x0, 0x0A}, 0x12, 0x0}\n\t\t},\n\t\t{{0x0, 0x0A}, 0x18, 0x0},\n\t},\n\t{\n\t\t50000001, 75000000,\n\t\t{\n\t\t\t{{0x0, 0x09}, 0x12, 0x0},\n\t\t\t{{0x0, 0x09}, 0x12, 0x0},\n\t\t\t{{0x0, 0x09}, 0x12, 0x0}\n\t\t},\n\t\t{{0x0, 0x0C}, 0x18, 0x3},\n\t},\n\t{\n\t\t75000001,   165000000,\n\t\t{\n\t\t\t{{0x0, 0x09}, 0x12, 0x0},\n\t\t\t{{0x0, 0x09}, 0x12, 0x0},\n\t\t\t{{0x0, 0x09}, 0x12, 0x0}\n\t\t},\n\t\t{{0x0, 0x0C}, 0x18, 0x3},\n\t},\n\t{\n\t\t165000001,  250000000,\n\t\t{\n\t\t\t{{0x0, 0x0F}, 0x12, 0x1},\n\t\t\t{{0x0, 0x0F}, 0x12, 0x1},\n\t\t\t{{0x0, 0x0F}, 0x12, 0x1}\n\t\t},\n\t\t{{0x0, 0x0C}, 0x18, 0x3},\n\t},\n\t{\n\t\t250000001,  340000000,\n\t\t{\n\t\t\t{{0x2, 0x0D}, 0x12, 0x1},\n\t\t\t{{0x2, 0x0D}, 0x12, 0x1},\n\t\t\t{{0x2, 0x0D}, 0x12, 0x1}\n\t\t},\n\t\t{{0x0, 0x0C}, 0x18, 0xF},\n\t},\n\t{\n\t\t340000001,  450000000,\n\t\t{\n\t\t\t{{0x0, 0x1B}, 0x12, 0xF},\n\t\t\t{{0x0, 0x1B}, 0x12, 0xF},\n\t\t\t{{0x0, 0x1B}, 0x12, 0xF}\n\t\t},\n\t\t{{0x0, 0x0A}, 0x12, 0xF},\n\t},\n\t{\n\t\t450000001,  600000000,\n\t\t{\n\t\t\t{{0x0, 0x1C}, 0x12, 0xF},\n\t\t\t{{0x0, 0x1C}, 0x12, 0xF},\n\t\t\t{{0x0, 0x1C}, 0x12, 0xF}\n\t\t},\n\t\t{{0x0, 0x0B}, 0x13, 0xF},\n\t},\n};\n\nstatic const struct phy_settings *phy_get_settings(unsigned long long tmds_rate)\n{\n\tunsigned int count = ARRAY_SIZE(vc5_hdmi_phy_settings);\n\tunsigned int i;\n\n\tfor (i = 0; i < count; i++) {\n\t\tconst struct phy_settings *s = &vc5_hdmi_phy_settings[i];\n\n\t\tif (tmds_rate >= s->min_rate && tmds_rate <= s->max_rate)\n\t\t\treturn s;\n\t}\n\n\t \n\treturn &vc5_hdmi_phy_settings[count - 1];\n}\n\nstatic const struct phy_lane_settings *\nphy_get_channel_settings(enum vc4_hdmi_phy_channel chan,\n\t\t\t unsigned long long tmds_rate)\n{\n\tconst struct phy_settings *settings = phy_get_settings(tmds_rate);\n\n\tif (chan == PHY_LANE_CK)\n\t\treturn &settings->clock;\n\n\treturn &settings->channel[chan];\n}\n\nstatic void vc5_hdmi_reset_phy(struct vc4_hdmi *vc4_hdmi)\n{\n\tlockdep_assert_held(&vc4_hdmi->hw_lock);\n\n\tHDMI_WRITE(HDMI_TX_PHY_RESET_CTL, 0x0f);\n\tHDMI_WRITE(HDMI_TX_PHY_POWERDOWN_CTL, BIT(10));\n}\n\nvoid vc5_hdmi_phy_init(struct vc4_hdmi *vc4_hdmi,\n\t\t       struct vc4_hdmi_connector_state *conn_state)\n{\n\tconst struct phy_lane_settings *chan0_settings, *chan1_settings, *chan2_settings, *clock_settings;\n\tconst struct vc4_hdmi_variant *variant = vc4_hdmi->variant;\n\tunsigned long long pixel_freq = conn_state->tmds_char_rate;\n\tunsigned long long vco_freq;\n\tunsigned char word_sel;\n\tunsigned long flags;\n\tu8 vco_sel, vco_div;\n\n\tvco_freq = phy_get_vco_freq(pixel_freq, &vco_sel, &vco_div);\n\n\tspin_lock_irqsave(&vc4_hdmi->hw_lock, flags);\n\n\tvc5_hdmi_reset_phy(vc4_hdmi);\n\n\tHDMI_WRITE(HDMI_TX_PHY_POWERDOWN_CTL,\n\t\t   VC4_HDMI_TX_PHY_POWERDOWN_CTL_RNDGEN_PWRDN);\n\n\tHDMI_WRITE(HDMI_TX_PHY_RESET_CTL,\n\t\t   HDMI_READ(HDMI_TX_PHY_RESET_CTL) &\n\t\t   ~VC4_HDMI_TX_PHY_RESET_CTL_TX_0_RESET &\n\t\t   ~VC4_HDMI_TX_PHY_RESET_CTL_TX_1_RESET &\n\t\t   ~VC4_HDMI_TX_PHY_RESET_CTL_TX_2_RESET &\n\t\t   ~VC4_HDMI_TX_PHY_RESET_CTL_TX_CK_RESET);\n\n\tHDMI_WRITE(HDMI_RM_CONTROL,\n\t\t   HDMI_READ(HDMI_RM_CONTROL) |\n\t\t   VC4_HDMI_RM_CONTROL_EN_FREEZE_COUNTERS |\n\t\t   VC4_HDMI_RM_CONTROL_EN_LOAD_INTEGRATOR |\n\t\t   VC4_HDMI_RM_CONTROL_FREE_RUN);\n\n\tHDMI_WRITE(HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_1,\n\t\t   (HDMI_READ(HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_1) &\n\t\t    ~VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_1_MIN_LIMIT_MASK) |\n\t\t   VC4_SET_FIELD(0, VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_1_MIN_LIMIT));\n\n\tHDMI_WRITE(HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_2,\n\t\t   (HDMI_READ(HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_2) &\n\t\t    ~VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_2_MAX_LIMIT_MASK) |\n\t\t   VC4_SET_FIELD(0, VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_2_MAX_LIMIT));\n\n\tHDMI_WRITE(HDMI_RM_OFFSET,\n\t\t   VC4_SET_FIELD(phy_get_rm_offset(vco_freq),\n\t\t\t\t VC4_HDMI_RM_OFFSET_OFFSET) |\n\t\t   VC4_HDMI_RM_OFFSET_ONLY);\n\n\tHDMI_WRITE(HDMI_TX_PHY_CLK_DIV,\n\t\t   VC4_SET_FIELD(vco_div, VC4_HDMI_TX_PHY_CLK_DIV_VCO));\n\n\tHDMI_WRITE(HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_4,\n\t\t   VC4_SET_FIELD(0xe147, VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_4_HOLD_THRESHOLD) |\n\t\t   VC4_SET_FIELD(0xe14, VC4_HDMI_TX_PHY_PLL_CALIBRATION_CONFIG_4_STABLE_THRESHOLD));\n\n\tHDMI_WRITE(HDMI_TX_PHY_PLL_CTL_0,\n\t\t   VC4_HDMI_TX_PHY_PLL_CTL_0_ENA_VCO_CLK |\n\t\t   VC4_HDMI_TX_PHY_PLL_CTL_0_VCO_CONT_EN |\n\t\t   VC4_HDMI_TX_PHY_PLL_CTL_0_MASH11_MODE |\n\t\t   VC4_SET_FIELD(vco_sel, VC4_HDMI_TX_PHY_PLL_CTL_0_VCO_SEL));\n\n\tHDMI_WRITE(HDMI_TX_PHY_PLL_CTL_1,\n\t\t   HDMI_READ(HDMI_TX_PHY_PLL_CTL_1) |\n\t\t   VC4_HDMI_TX_PHY_PLL_CTL_1_FREQ_DOUBLER_ENABLE |\n\t\t   VC4_SET_FIELD(3, VC4_HDMI_TX_PHY_PLL_CTL_1_POST_RST_SEL) |\n\t\t   VC4_SET_FIELD(1, VC4_HDMI_TX_PHY_PLL_CTL_1_FREQ_DOUBLER_DELAY) |\n\t\t   VC4_SET_FIELD(0x8a, VC4_HDMI_TX_PHY_PLL_CTL_1_CPP));\n\n\tHDMI_WRITE(HDMI_RM_FORMAT,\n\t\t   HDMI_READ(HDMI_RM_FORMAT) |\n\t\t   VC4_SET_FIELD(2, VC4_HDMI_RM_FORMAT_SHIFT));\n\n\tHDMI_WRITE(HDMI_TX_PHY_PLL_CFG,\n\t\t   HDMI_READ(HDMI_TX_PHY_PLL_CFG) |\n\t\t   VC4_SET_FIELD(1, VC4_HDMI_TX_PHY_PLL_CFG_PDIV));\n\n\tif (pixel_freq >= 340000000)\n\t\tword_sel = 3;\n\telse\n\t\tword_sel = 0;\n\tHDMI_WRITE(HDMI_TX_PHY_TMDS_CLK_WORD_SEL, word_sel);\n\n\tHDMI_WRITE(HDMI_TX_PHY_CTL_3,\n\t\t   VC4_SET_FIELD(phy_get_cp_current(vco_freq),\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_3_ICP) |\n\t\t   VC4_SET_FIELD(1, VC4_HDMI_TX_PHY_CTL_3_CP) |\n\t\t   VC4_SET_FIELD(1, VC4_HDMI_TX_PHY_CTL_3_CP1) |\n\t\t   VC4_SET_FIELD(3, VC4_HDMI_TX_PHY_CTL_3_CZ) |\n\t\t   VC4_SET_FIELD(4, VC4_HDMI_TX_PHY_CTL_3_RP) |\n\t\t   VC4_SET_FIELD(6, VC4_HDMI_TX_PHY_CTL_3_RZ));\n\n\tchan0_settings =\n\t\tphy_get_channel_settings(variant->phy_lane_mapping[PHY_LANE_0],\n\t\t\t\t\t pixel_freq);\n\tchan1_settings =\n\t\tphy_get_channel_settings(variant->phy_lane_mapping[PHY_LANE_1],\n\t\t\t\t\t pixel_freq);\n\tchan2_settings =\n\t\tphy_get_channel_settings(variant->phy_lane_mapping[PHY_LANE_2],\n\t\t\t\t\t pixel_freq);\n\tclock_settings =\n\t\tphy_get_channel_settings(variant->phy_lane_mapping[PHY_LANE_CK],\n\t\t\t\t\t pixel_freq);\n\n\tHDMI_WRITE(HDMI_TX_PHY_CTL_0,\n\t\t   VC4_SET_FIELD(chan0_settings->amplitude.preemphasis,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_0_PREEMP_0_PREEMP) |\n\t\t   VC4_SET_FIELD(chan0_settings->amplitude.main_driver,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_0_PREEMP_0_MAINDRV) |\n\t\t   VC4_SET_FIELD(chan1_settings->amplitude.preemphasis,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_0_PREEMP_1_PREEMP) |\n\t\t   VC4_SET_FIELD(chan1_settings->amplitude.main_driver,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_0_PREEMP_1_MAINDRV) |\n\t\t   VC4_SET_FIELD(chan2_settings->amplitude.preemphasis,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_0_PREEMP_2_PREEMP) |\n\t\t   VC4_SET_FIELD(chan2_settings->amplitude.main_driver,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_0_PREEMP_2_MAINDRV) |\n\t\t   VC4_SET_FIELD(clock_settings->amplitude.preemphasis,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_0_PREEMP_CK_PREEMP) |\n\t\t   VC4_SET_FIELD(clock_settings->amplitude.main_driver,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_0_PREEMP_CK_MAINDRV));\n\n\tHDMI_WRITE(HDMI_TX_PHY_CTL_1,\n\t\t   HDMI_READ(HDMI_TX_PHY_CTL_1) |\n\t\t   VC4_SET_FIELD(chan0_settings->res_sel_data,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_1_RES_SEL_DATA0) |\n\t\t   VC4_SET_FIELD(chan1_settings->res_sel_data,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_1_RES_SEL_DATA1) |\n\t\t   VC4_SET_FIELD(chan2_settings->res_sel_data,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_1_RES_SEL_DATA2) |\n\t\t   VC4_SET_FIELD(clock_settings->res_sel_data,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_1_RES_SEL_CK));\n\n\tHDMI_WRITE(HDMI_TX_PHY_CTL_2,\n\t\t   VC4_SET_FIELD(chan0_settings->term_res_sel_data,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELDATA0) |\n\t\t   VC4_SET_FIELD(chan1_settings->term_res_sel_data,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELDATA1) |\n\t\t   VC4_SET_FIELD(chan2_settings->term_res_sel_data,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELDATA2) |\n\t\t   VC4_SET_FIELD(clock_settings->term_res_sel_data,\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_2_TERM_RES_SELCK) |\n\t\t   VC4_SET_FIELD(phy_get_vco_gain(vco_freq),\n\t\t\t\t VC4_HDMI_TX_PHY_CTL_2_VCO_GAIN));\n\n\tHDMI_WRITE(HDMI_TX_PHY_CHANNEL_SWAP,\n\t\t   VC4_SET_FIELD(variant->phy_lane_mapping[PHY_LANE_0],\n\t\t\t\t VC4_HDMI_TX_PHY_CHANNEL_SWAP_TX0_OUT_SEL) |\n\t\t   VC4_SET_FIELD(variant->phy_lane_mapping[PHY_LANE_1],\n\t\t\t\t VC4_HDMI_TX_PHY_CHANNEL_SWAP_TX1_OUT_SEL) |\n\t\t   VC4_SET_FIELD(variant->phy_lane_mapping[PHY_LANE_2],\n\t\t\t\t VC4_HDMI_TX_PHY_CHANNEL_SWAP_TX2_OUT_SEL) |\n\t\t   VC4_SET_FIELD(variant->phy_lane_mapping[PHY_LANE_CK],\n\t\t\t\t VC4_HDMI_TX_PHY_CHANNEL_SWAP_TXCK_OUT_SEL));\n\n\tHDMI_WRITE(HDMI_TX_PHY_RESET_CTL,\n\t\t   HDMI_READ(HDMI_TX_PHY_RESET_CTL) &\n\t\t   ~(VC4_HDMI_TX_PHY_RESET_CTL_PLL_RESETB |\n\t\t     VC4_HDMI_TX_PHY_RESET_CTL_PLLDIV_RESETB));\n\n\tHDMI_WRITE(HDMI_TX_PHY_RESET_CTL,\n\t\t   HDMI_READ(HDMI_TX_PHY_RESET_CTL) |\n\t\t   VC4_HDMI_TX_PHY_RESET_CTL_PLL_RESETB |\n\t\t   VC4_HDMI_TX_PHY_RESET_CTL_PLLDIV_RESETB);\n\n\tspin_unlock_irqrestore(&vc4_hdmi->hw_lock, flags);\n}\n\nvoid vc5_hdmi_phy_disable(struct vc4_hdmi *vc4_hdmi)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vc4_hdmi->hw_lock, flags);\n\tvc5_hdmi_reset_phy(vc4_hdmi);\n\tspin_unlock_irqrestore(&vc4_hdmi->hw_lock, flags);\n}\n\nvoid vc5_hdmi_phy_rng_enable(struct vc4_hdmi *vc4_hdmi)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vc4_hdmi->hw_lock, flags);\n\tHDMI_WRITE(HDMI_TX_PHY_POWERDOWN_CTL,\n\t\t   HDMI_READ(HDMI_TX_PHY_POWERDOWN_CTL) &\n\t\t   ~VC4_HDMI_TX_PHY_POWERDOWN_CTL_RNDGEN_PWRDN);\n\tspin_unlock_irqrestore(&vc4_hdmi->hw_lock, flags);\n}\n\nvoid vc5_hdmi_phy_rng_disable(struct vc4_hdmi *vc4_hdmi)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vc4_hdmi->hw_lock, flags);\n\tHDMI_WRITE(HDMI_TX_PHY_POWERDOWN_CTL,\n\t\t   HDMI_READ(HDMI_TX_PHY_POWERDOWN_CTL) |\n\t\t   VC4_HDMI_TX_PHY_POWERDOWN_CTL_RNDGEN_PWRDN);\n\tspin_unlock_irqrestore(&vc4_hdmi->hw_lock, flags);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}