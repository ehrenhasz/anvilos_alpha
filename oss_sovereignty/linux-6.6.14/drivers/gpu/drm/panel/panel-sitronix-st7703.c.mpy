{
  "module_name": "panel-sitronix-st7703.c",
  "hash_id": "6e3a3b7ce539f36210c4bbf35546bbee1324eccf7c0cbb51b88ceffc21d97672",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/panel/panel-sitronix-st7703.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/delay.h>\n#include <linux/gpio/consumer.h>\n#include <linux/media-bus-format.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/regulator/consumer.h>\n\n#include <video/display_timing.h>\n#include <video/mipi_display.h>\n\n#include <drm/drm_mipi_dsi.h>\n#include <drm/drm_modes.h>\n#include <drm/drm_panel.h>\n\n#define DRV_NAME \"panel-sitronix-st7703\"\n\n \n#define ST7703_CMD_ALL_PIXEL_OFF 0x22\n#define ST7703_CMD_ALL_PIXEL_ON\t 0x23\n#define ST7703_CMD_SETAPID\t 0xB1\n#define ST7703_CMD_SETDISP\t 0xB2\n#define ST7703_CMD_SETRGBIF\t 0xB3\n#define ST7703_CMD_SETCYC\t 0xB4\n#define ST7703_CMD_SETBGP\t 0xB5\n#define ST7703_CMD_SETVCOM\t 0xB6\n#define ST7703_CMD_SETOTP\t 0xB7\n#define ST7703_CMD_SETPOWER_EXT\t 0xB8\n#define ST7703_CMD_SETEXTC\t 0xB9\n#define ST7703_CMD_SETMIPI\t 0xBA\n#define ST7703_CMD_SETVDC\t 0xBC\n#define ST7703_CMD_UNKNOWN_BF\t 0xBF\n#define ST7703_CMD_SETSCR\t 0xC0\n#define ST7703_CMD_SETPOWER\t 0xC1\n#define ST7703_CMD_SETECO\t 0xC6\n#define ST7703_CMD_SETIO\t 0xC7\n#define ST7703_CMD_SETCABC\t 0xC8\n#define ST7703_CMD_SETPANEL\t 0xCC\n#define ST7703_CMD_SETGAMMA\t 0xE0\n#define ST7703_CMD_SETEQ\t 0xE3\n#define ST7703_CMD_SETGIP1\t 0xE9\n#define ST7703_CMD_SETGIP2\t 0xEA\n#define ST7703_CMD_UNKNOWN_EF\t 0xEF\n\nstruct st7703 {\n\tstruct device *dev;\n\tstruct drm_panel panel;\n\tstruct gpio_desc *reset_gpio;\n\tstruct regulator *vcc;\n\tstruct regulator *iovcc;\n\tbool prepared;\n\n\tstruct dentry *debugfs;\n\tconst struct st7703_panel_desc *desc;\n};\n\nstruct st7703_panel_desc {\n\tconst struct drm_display_mode *mode;\n\tunsigned int lanes;\n\tunsigned long mode_flags;\n\tenum mipi_dsi_pixel_format format;\n\tint (*init_sequence)(struct st7703 *ctx);\n};\n\nstatic inline struct st7703 *panel_to_st7703(struct drm_panel *panel)\n{\n\treturn container_of(panel, struct st7703, panel);\n}\n\nstatic int jh057n_init_sequence(struct st7703 *ctx)\n{\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\n\n\t \n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETEXTC,\n\t\t\t\t   0xF1, 0x12, 0x83);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETRGBIF,\n\t\t\t\t   0x10, 0x10, 0x05, 0x05, 0x03, 0xFF, 0x00, 0x00,\n\t\t\t\t   0x00, 0x00);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETSCR,\n\t\t\t\t   0x73, 0x73, 0x50, 0x50, 0x00, 0x00, 0x08, 0x70,\n\t\t\t\t   0x00);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETVDC, 0x4E);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETPANEL, 0x0B);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETCYC, 0x80);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETDISP, 0xF0, 0x12, 0x30);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETEQ,\n\t\t\t\t   0x07, 0x07, 0x0B, 0x0B, 0x03, 0x0B, 0x00, 0x00,\n\t\t\t\t   0x00, 0x00, 0xFF, 0x00, 0xC0, 0x10);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETBGP, 0x08, 0x08);\n\tmsleep(20);\n\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETVCOM, 0x3F, 0x3F);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_UNKNOWN_BF, 0x02, 0x11, 0x00);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETGIP1,\n\t\t\t\t   0x82, 0x10, 0x06, 0x05, 0x9E, 0x0A, 0xA5, 0x12,\n\t\t\t\t   0x31, 0x23, 0x37, 0x83, 0x04, 0xBC, 0x27, 0x38,\n\t\t\t\t   0x0C, 0x00, 0x03, 0x00, 0x00, 0x00, 0x0C, 0x00,\n\t\t\t\t   0x03, 0x00, 0x00, 0x00, 0x75, 0x75, 0x31, 0x88,\n\t\t\t\t   0x88, 0x88, 0x88, 0x88, 0x88, 0x13, 0x88, 0x64,\n\t\t\t\t   0x64, 0x20, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88,\n\t\t\t\t   0x02, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t\t   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETGIP2,\n\t\t\t\t   0x02, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t\t   0x00, 0x00, 0x00, 0x00, 0x02, 0x46, 0x02, 0x88,\n\t\t\t\t   0x88, 0x88, 0x88, 0x88, 0x88, 0x64, 0x88, 0x13,\n\t\t\t\t   0x57, 0x13, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88,\n\t\t\t\t   0x75, 0x88, 0x23, 0x14, 0x00, 0x00, 0x02, 0x00,\n\t\t\t\t   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t\t   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x0A,\n\t\t\t\t   0xA5, 0x00, 0x00, 0x00, 0x00);\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_SETGAMMA,\n\t\t\t\t   0x00, 0x09, 0x0E, 0x29, 0x2D, 0x3C, 0x41, 0x37,\n\t\t\t\t   0x07, 0x0B, 0x0D, 0x10, 0x11, 0x0F, 0x10, 0x11,\n\t\t\t\t   0x18, 0x00, 0x09, 0x0E, 0x29, 0x2D, 0x3C, 0x41,\n\t\t\t\t   0x37, 0x07, 0x0B, 0x0D, 0x10, 0x11, 0x0F, 0x10,\n\t\t\t\t   0x11, 0x18);\n\n\treturn 0;\n}\n\nstatic const struct drm_display_mode jh057n00900_mode = {\n\t.hdisplay    = 720,\n\t.hsync_start = 720 + 90,\n\t.hsync_end   = 720 + 90 + 20,\n\t.htotal\t     = 720 + 90 + 20 + 20,\n\t.vdisplay    = 1440,\n\t.vsync_start = 1440 + 20,\n\t.vsync_end   = 1440 + 20 + 4,\n\t.vtotal\t     = 1440 + 20 + 4 + 12,\n\t.clock\t     = 75276,\n\t.flags\t     = DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC,\n\t.width_mm    = 65,\n\t.height_mm   = 130,\n};\n\nstatic const struct st7703_panel_desc jh057n00900_panel_desc = {\n\t.mode = &jh057n00900_mode,\n\t.lanes = 4,\n\t.mode_flags = MIPI_DSI_MODE_VIDEO |\n\t\tMIPI_DSI_MODE_VIDEO_BURST | MIPI_DSI_MODE_VIDEO_SYNC_PULSE,\n\t.format = MIPI_DSI_FMT_RGB888,\n\t.init_sequence = jh057n_init_sequence,\n};\n\nstatic int xbd599_init_sequence(struct st7703 *ctx)\n{\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\n\n\t \n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETEXTC, 0xF1, 0x12, 0x83);\n\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETMIPI,\n\t\t\t       0x33,  \n\t\t\t       0x81,  \n\t\t\t       0x05,  \n\t\t\t       0xF9,  \n\t\t\t       0x0E,  \n\t\t\t       0x0E,  \n\t\t\t        \n\t\t\t       0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x44, 0x25, 0x00, 0x91, 0x0a, 0x00, 0x00, 0x02,\n\t\t\t       0x4F, 0x11, 0x00, 0x00, 0x37);\n\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETPOWER_EXT,\n\t\t\t       0x25,  \n\t\t\t       0x22,  \n\t\t\t       0x20,  \n\t\t\t       0x03   );\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETRGBIF,\n\t\t\t       0x10,  \n\t\t\t       0x10,  \n\t\t\t       0x05,  \n\t\t\t       0x05,  \n\t\t\t        \n\t\t\t       0x03, 0xFF,\n\t\t\t       0x00, 0x00,\n\t\t\t       0x00, 0x00);\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETSCR,\n\t\t\t       0x73,  \n\t\t\t       0x73,  \n\t\t\t       0x50,  \n\t\t\t       0x50,  \n\t\t\t       0x00,  \n\t\t\t       0xC0,  \n\t\t\t       0x08,  \n\t\t\t       0x70,  \n\t\t\t       0x00   );\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETVDC, 0x4E);\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETPANEL, 0x0B);\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETCYC, 0x80);\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETDISP,\n\t\t\t       0xF0,  \n\t\t\t       0x12,  \n\t\t\t       0xF0   );\n\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETEQ,\n\t\t\t       0x00,  \n\t\t\t       0x00,  \n\t\t\t       0x0B,  \n\t\t\t       0x0B,  \n\t\t\t       0x10,  \n\t\t\t       0x10,  \n\t\t\t       0x00,  \n\t\t\t       0x00,  \n\t\t\t       0x00,  \n\t\t\t       0x00,  \n\t\t\t       0xFF,  \n\t\t\t       0x00,  \n\t\t\t       0xC0,  \n\t\t\t       0x10   );\n\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETECO, 0x01, 0x00, 0xFF, 0xFF, 0x00);\n\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETPOWER,\n\t\t\t       0x74,  \n\t\t\t       0x00,  \n\t\t\t       0x32,  \n\t\t\t       0x32,  \n\t\t\t       0x77,  \n\t\t\t       0xF1,  \n\t\t\t       0xFF,  \n\t\t\t       0xFF,  \n\t\t\t       0xCC,  \n\t\t\t       0xCC,  \n\t\t\t       0x77,  \n\t\t\t       0x77   );\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETBGP,\n\t\t\t       0x07,  \n\t\t\t       0x07   );\n\tmsleep(20);\n\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETVCOM,\n\t\t\t       0x2C,  \n\t\t\t       0x2C   );\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_UNKNOWN_BF, 0x02, 0x11, 0x00);\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETGIP1,\n\t\t\t       0x82, 0x10, 0x06, 0x05, 0xA2, 0x0A, 0xA5, 0x12,\n\t\t\t       0x31, 0x23, 0x37, 0x83, 0x04, 0xBC, 0x27, 0x38,\n\t\t\t       0x0C, 0x00, 0x03, 0x00, 0x00, 0x00, 0x0C, 0x00,\n\t\t\t       0x03, 0x00, 0x00, 0x00, 0x75, 0x75, 0x31, 0x88,\n\t\t\t       0x88, 0x88, 0x88, 0x88, 0x88, 0x13, 0x88, 0x64,\n\t\t\t       0x64, 0x20, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88,\n\t\t\t       0x02, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00);\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETGIP2,\n\t\t\t       0x02, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x00, 0x00, 0x00, 0x00, 0x02, 0x46, 0x02, 0x88,\n\t\t\t       0x88, 0x88, 0x88, 0x88, 0x88, 0x64, 0x88, 0x13,\n\t\t\t       0x57, 0x13, 0x88, 0x88, 0x88, 0x88, 0x88, 0x88,\n\t\t\t       0x75, 0x88, 0x23, 0x14, 0x00, 0x00, 0x02, 0x00,\n\t\t\t       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0A,\n\t\t\t       0xA5, 0x00, 0x00, 0x00, 0x00);\n\n\t \n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETGAMMA,\n\t\t\t       0x00, 0x09, 0x0D, 0x23, 0x27, 0x3C, 0x41, 0x35,\n\t\t\t       0x07, 0x0D, 0x0E, 0x12, 0x13, 0x10, 0x12, 0x12,\n\t\t\t       0x18, 0x00, 0x09, 0x0D, 0x23, 0x27, 0x3C, 0x41,\n\t\t\t       0x35, 0x07, 0x0D, 0x0E, 0x12, 0x13, 0x10, 0x12,\n\t\t\t       0x12, 0x18);\n\n\treturn 0;\n}\n\nstatic const struct drm_display_mode xbd599_mode = {\n\t.hdisplay    = 720,\n\t.hsync_start = 720 + 40,\n\t.hsync_end   = 720 + 40 + 40,\n\t.htotal\t     = 720 + 40 + 40 + 40,\n\t.vdisplay    = 1440,\n\t.vsync_start = 1440 + 18,\n\t.vsync_end   = 1440 + 18 + 10,\n\t.vtotal\t     = 1440 + 18 + 10 + 17,\n\t.clock\t     = 69000,\n\t.flags\t     = DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC,\n\t.width_mm    = 68,\n\t.height_mm   = 136,\n};\n\nstatic const struct st7703_panel_desc xbd599_desc = {\n\t.mode = &xbd599_mode,\n\t.lanes = 4,\n\t.mode_flags = MIPI_DSI_MODE_VIDEO | MIPI_DSI_MODE_VIDEO_SYNC_PULSE,\n\t.format = MIPI_DSI_FMT_RGB888,\n\t.init_sequence = xbd599_init_sequence,\n};\n\nstatic int rg353v2_init_sequence(struct st7703 *ctx)\n{\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\n\n\t \n\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETEXTC, 0xf1, 0x12, 0x83);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETAPID, 0x00, 0x00, 0x00,\n\t\t\t       0xda, 0x80);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETDISP, 0x00, 0x13, 0x70);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETRGBIF, 0x10, 0x10, 0x28,\n\t\t\t       0x28, 0x03, 0xff, 0x00, 0x00, 0x00, 0x00);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETCYC, 0x80);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETBGP, 0x0a, 0x0a);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETVCOM, 0x92, 0x92);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETPOWER_EXT, 0x25, 0x22,\n\t\t\t       0xf0, 0x63);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETMIPI, 0x33, 0x81, 0x05,\n\t\t\t       0xf9, 0x0e, 0x0e, 0x20, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x00, 0x00, 0x00, 0x44, 0x25, 0x00, 0x90, 0x0a,\n\t\t\t       0x00, 0x00, 0x01, 0x4f, 0x01, 0x00, 0x00, 0x37);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETVDC, 0x47);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_UNKNOWN_BF, 0x02, 0x11, 0x00);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETSCR, 0x73, 0x73, 0x50, 0x50,\n\t\t\t       0x00, 0x00, 0x12, 0x50, 0x00);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETPOWER, 0x53, 0xc0, 0x32,\n\t\t\t       0x32, 0x77, 0xe1, 0xdd, 0xdd, 0x77, 0x77, 0x33,\n\t\t\t       0x33);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETECO, 0x82, 0x00, 0xbf, 0xff,\n\t\t\t       0x00, 0xff);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETIO, 0xb8, 0x00, 0x0a, 0x00,\n\t\t\t       0x00, 0x00);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETCABC, 0x10, 0x40, 0x1e,\n\t\t\t       0x02);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETPANEL, 0x0b);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETGAMMA, 0x00, 0x07, 0x0d,\n\t\t\t       0x37, 0x35, 0x3f, 0x41, 0x44, 0x06, 0x0c, 0x0d,\n\t\t\t       0x0f, 0x11, 0x10, 0x12, 0x14, 0x1a, 0x00, 0x07,\n\t\t\t       0x0d, 0x37, 0x35, 0x3f, 0x41, 0x44, 0x06, 0x0c,\n\t\t\t       0x0d, 0x0f, 0x11, 0x10, 0x12, 0x14, 0x1a);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETEQ, 0x07, 0x07, 0x0b, 0x0b,\n\t\t\t       0x0b, 0x0b, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00,\n\t\t\t       0xc0, 0x10);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETGIP1, 0xc8, 0x10, 0x02, 0x00,\n\t\t\t       0x00, 0xb0, 0xb1, 0x11, 0x31, 0x23, 0x28, 0x80,\n\t\t\t       0xb0, 0xb1, 0x27, 0x08, 0x00, 0x04, 0x02, 0x00,\n\t\t\t       0x00, 0x00, 0x00, 0x04, 0x02, 0x00, 0x00, 0x00,\n\t\t\t       0x88, 0x88, 0xba, 0x60, 0x24, 0x08, 0x88, 0x88,\n\t\t\t       0x88, 0x88, 0x88, 0x88, 0x88, 0xba, 0x71, 0x35,\n\t\t\t       0x18, 0x88, 0x88, 0x88, 0x88, 0x88, 0x00, 0x00,\n\t\t\t       0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x00, 0x00, 0x00);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_SETGIP2, 0x97, 0x0a, 0x82, 0x02,\n\t\t\t       0x03, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x81, 0x88, 0xba, 0x17, 0x53, 0x88, 0x88, 0x88,\n\t\t\t       0x88, 0x88, 0x88, 0x80, 0x88, 0xba, 0x06, 0x42,\n\t\t\t       0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x23, 0x00,\n\t\t\t       0x00, 0x02, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t\t\t       0x00);\n\tmipi_dsi_dcs_write_seq(dsi, ST7703_CMD_UNKNOWN_EF, 0xff, 0xff, 0x01);\n\n\treturn 0;\n}\n\nstatic const struct drm_display_mode rg353v2_mode = {\n\t.hdisplay\t= 640,\n\t.hsync_start\t= 640 + 40,\n\t.hsync_end\t= 640 + 40 + 2,\n\t.htotal\t\t= 640 + 40 + 2 + 80,\n\t.vdisplay\t= 480,\n\t.vsync_start\t= 480 + 18,\n\t.vsync_end\t= 480 + 18 + 2,\n\t.vtotal\t\t= 480 + 18 + 2 + 28,\n\t.clock\t\t= 24150,\n\t.flags\t\t= DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC,\n\t.width_mm\t= 70,\n\t.height_mm\t= 57,\n};\n\nstatic const struct st7703_panel_desc rg353v2_desc = {\n\t.mode = &rg353v2_mode,\n\t.lanes = 4,\n\t.mode_flags = MIPI_DSI_MODE_VIDEO | MIPI_DSI_MODE_VIDEO_BURST |\n\t\t      MIPI_DSI_MODE_NO_EOT_PACKET | MIPI_DSI_MODE_LPM,\n\t.format = MIPI_DSI_FMT_RGB888,\n\t.init_sequence = rg353v2_init_sequence,\n};\n\nstatic int st7703_enable(struct drm_panel *panel)\n{\n\tstruct st7703 *ctx = panel_to_st7703(panel);\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\n\tint ret;\n\n\tret = ctx->desc->init_sequence(ctx);\n\tif (ret < 0) {\n\t\tdev_err(ctx->dev, \"Panel init sequence failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tmsleep(20);\n\n\tret = mipi_dsi_dcs_exit_sleep_mode(dsi);\n\tif (ret < 0) {\n\t\tdev_err(ctx->dev, \"Failed to exit sleep mode: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tmsleep(60);\n\n\tret = mipi_dsi_dcs_set_display_on(dsi);\n\tif (ret)\n\t\treturn ret;\n\n\tdev_dbg(ctx->dev, \"Panel init sequence done\\n\");\n\n\treturn 0;\n}\n\nstatic int st7703_disable(struct drm_panel *panel)\n{\n\tstruct st7703 *ctx = panel_to_st7703(panel);\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\n\tint ret;\n\n\tret = mipi_dsi_dcs_set_display_off(dsi);\n\tif (ret < 0)\n\t\tdev_err(ctx->dev, \"Failed to turn off the display: %d\\n\", ret);\n\n\tret = mipi_dsi_dcs_enter_sleep_mode(dsi);\n\tif (ret < 0)\n\t\tdev_err(ctx->dev, \"Failed to enter sleep mode: %d\\n\", ret);\n\n\treturn 0;\n}\n\nstatic int st7703_unprepare(struct drm_panel *panel)\n{\n\tstruct st7703 *ctx = panel_to_st7703(panel);\n\n\tif (!ctx->prepared)\n\t\treturn 0;\n\n\tgpiod_set_value_cansleep(ctx->reset_gpio, 1);\n\tregulator_disable(ctx->iovcc);\n\tregulator_disable(ctx->vcc);\n\tctx->prepared = false;\n\n\treturn 0;\n}\n\nstatic int st7703_prepare(struct drm_panel *panel)\n{\n\tstruct st7703 *ctx = panel_to_st7703(panel);\n\tint ret;\n\n\tif (ctx->prepared)\n\t\treturn 0;\n\n\tdev_dbg(ctx->dev, \"Resetting the panel\\n\");\n\tgpiod_set_value_cansleep(ctx->reset_gpio, 1);\n\n\tret = regulator_enable(ctx->iovcc);\n\tif (ret < 0) {\n\t\tdev_err(ctx->dev, \"Failed to enable iovcc supply: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = regulator_enable(ctx->vcc);\n\tif (ret < 0) {\n\t\tdev_err(ctx->dev, \"Failed to enable vcc supply: %d\\n\", ret);\n\t\tregulator_disable(ctx->iovcc);\n\t\treturn ret;\n\t}\n\n\t \n\tusleep_range(10000, 20000);\n\n\tgpiod_set_value_cansleep(ctx->reset_gpio, 0);\n\tusleep_range(15000, 20000);\n\n\tctx->prepared = true;\n\n\treturn 0;\n}\n\nstatic const u32 mantix_bus_formats[] = {\n\tMEDIA_BUS_FMT_RGB888_1X24,\n};\n\nstatic int st7703_get_modes(struct drm_panel *panel,\n\t\t\t    struct drm_connector *connector)\n{\n\tstruct st7703 *ctx = panel_to_st7703(panel);\n\tstruct drm_display_mode *mode;\n\n\tmode = drm_mode_duplicate(connector->dev, ctx->desc->mode);\n\tif (!mode) {\n\t\tdev_err(ctx->dev, \"Failed to add mode %ux%u@%u\\n\",\n\t\t\tctx->desc->mode->hdisplay, ctx->desc->mode->vdisplay,\n\t\t\tdrm_mode_vrefresh(ctx->desc->mode));\n\t\treturn -ENOMEM;\n\t}\n\n\tdrm_mode_set_name(mode);\n\n\tmode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;\n\tconnector->display_info.width_mm = mode->width_mm;\n\tconnector->display_info.height_mm = mode->height_mm;\n\tdrm_mode_probed_add(connector, mode);\n\n\tdrm_display_info_set_bus_formats(&connector->display_info,\n\t\t\t\t\t mantix_bus_formats,\n\t\t\t\t\t ARRAY_SIZE(mantix_bus_formats));\n\n\treturn 1;\n}\n\nstatic const struct drm_panel_funcs st7703_drm_funcs = {\n\t.disable   = st7703_disable,\n\t.unprepare = st7703_unprepare,\n\t.prepare   = st7703_prepare,\n\t.enable\t   = st7703_enable,\n\t.get_modes = st7703_get_modes,\n};\n\nstatic int allpixelson_set(void *data, u64 val)\n{\n\tstruct st7703 *ctx = data;\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(ctx->dev);\n\n\tdev_dbg(ctx->dev, \"Setting all pixels on\\n\");\n\tmipi_dsi_generic_write_seq(dsi, ST7703_CMD_ALL_PIXEL_ON);\n\tmsleep(val * 1000);\n\t \n\tdrm_panel_disable(&ctx->panel);\n\tdrm_panel_unprepare(&ctx->panel);\n\tdrm_panel_prepare(&ctx->panel);\n\tdrm_panel_enable(&ctx->panel);\n\n\treturn 0;\n}\n\nDEFINE_SIMPLE_ATTRIBUTE(allpixelson_fops, NULL,\n\t\t\tallpixelson_set, \"%llu\\n\");\n\nstatic void st7703_debugfs_init(struct st7703 *ctx)\n{\n\tctx->debugfs = debugfs_create_dir(DRV_NAME, NULL);\n\n\tdebugfs_create_file(\"allpixelson\", 0600, ctx->debugfs, ctx,\n\t\t\t    &allpixelson_fops);\n}\n\nstatic void st7703_debugfs_remove(struct st7703 *ctx)\n{\n\tdebugfs_remove_recursive(ctx->debugfs);\n\tctx->debugfs = NULL;\n}\n\nstatic int st7703_probe(struct mipi_dsi_device *dsi)\n{\n\tstruct device *dev = &dsi->dev;\n\tstruct st7703 *ctx;\n\tint ret;\n\n\tctx = devm_kzalloc(dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tctx->reset_gpio = devm_gpiod_get(dev, \"reset\", GPIOD_OUT_LOW);\n\tif (IS_ERR(ctx->reset_gpio))\n\t\treturn dev_err_probe(dev, PTR_ERR(ctx->reset_gpio), \"Failed to get reset gpio\\n\");\n\n\tmipi_dsi_set_drvdata(dsi, ctx);\n\n\tctx->dev = dev;\n\tctx->desc = of_device_get_match_data(dev);\n\n\tdsi->mode_flags = ctx->desc->mode_flags;\n\tdsi->format = ctx->desc->format;\n\tdsi->lanes = ctx->desc->lanes;\n\n\tctx->vcc = devm_regulator_get(dev, \"vcc\");\n\tif (IS_ERR(ctx->vcc))\n\t\treturn dev_err_probe(dev, PTR_ERR(ctx->vcc), \"Failed to request vcc regulator\\n\");\n\n\tctx->iovcc = devm_regulator_get(dev, \"iovcc\");\n\tif (IS_ERR(ctx->iovcc))\n\t\treturn dev_err_probe(dev, PTR_ERR(ctx->iovcc),\n\t\t\t\t     \"Failed to request iovcc regulator\\n\");\n\n\tdrm_panel_init(&ctx->panel, dev, &st7703_drm_funcs,\n\t\t       DRM_MODE_CONNECTOR_DSI);\n\n\tret = drm_panel_of_backlight(&ctx->panel);\n\tif (ret)\n\t\treturn ret;\n\n\tdrm_panel_add(&ctx->panel);\n\n\tret = mipi_dsi_attach(dsi);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"mipi_dsi_attach failed (%d). Is host ready?\\n\", ret);\n\t\tdrm_panel_remove(&ctx->panel);\n\t\treturn ret;\n\t}\n\n\tdev_info(dev, \"%ux%u@%u %ubpp dsi %udl - ready\\n\",\n\t\t ctx->desc->mode->hdisplay, ctx->desc->mode->vdisplay,\n\t\t drm_mode_vrefresh(ctx->desc->mode),\n\t\t mipi_dsi_pixel_format_to_bpp(dsi->format), dsi->lanes);\n\n\tst7703_debugfs_init(ctx);\n\treturn 0;\n}\n\nstatic void st7703_shutdown(struct mipi_dsi_device *dsi)\n{\n\tstruct st7703 *ctx = mipi_dsi_get_drvdata(dsi);\n\tint ret;\n\n\tret = drm_panel_unprepare(&ctx->panel);\n\tif (ret < 0)\n\t\tdev_err(&dsi->dev, \"Failed to unprepare panel: %d\\n\", ret);\n\n\tret = drm_panel_disable(&ctx->panel);\n\tif (ret < 0)\n\t\tdev_err(&dsi->dev, \"Failed to disable panel: %d\\n\", ret);\n}\n\nstatic void st7703_remove(struct mipi_dsi_device *dsi)\n{\n\tstruct st7703 *ctx = mipi_dsi_get_drvdata(dsi);\n\tint ret;\n\n\tst7703_shutdown(dsi);\n\n\tret = mipi_dsi_detach(dsi);\n\tif (ret < 0)\n\t\tdev_err(&dsi->dev, \"Failed to detach from DSI host: %d\\n\", ret);\n\n\tdrm_panel_remove(&ctx->panel);\n\n\tst7703_debugfs_remove(ctx);\n}\n\nstatic const struct of_device_id st7703_of_match[] = {\n\t{ .compatible = \"anbernic,rg353v-panel-v2\", .data = &rg353v2_desc },\n\t{ .compatible = \"rocktech,jh057n00900\", .data = &jh057n00900_panel_desc },\n\t{ .compatible = \"xingbangda,xbd599\", .data = &xbd599_desc },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, st7703_of_match);\n\nstatic struct mipi_dsi_driver st7703_driver = {\n\t.probe\t= st7703_probe,\n\t.remove = st7703_remove,\n\t.shutdown = st7703_shutdown,\n\t.driver = {\n\t\t.name = DRV_NAME,\n\t\t.of_match_table = st7703_of_match,\n\t},\n};\nmodule_mipi_dsi_driver(st7703_driver);\n\nMODULE_AUTHOR(\"Guido G\u00fcnther <agx@sigxcpu.org>\");\nMODULE_DESCRIPTION(\"DRM driver for Sitronix ST7703 based MIPI DSI panels\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}