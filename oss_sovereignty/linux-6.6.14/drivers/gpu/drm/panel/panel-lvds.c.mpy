{
  "module_name": "panel-lvds.c",
  "hash_id": "eaac753f7d019326f17a2d589bd4f392a1a1fb04a20e97635f3f002b54daca72",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/panel/panel-lvds.c",
  "human_readable_source": "\n \n\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/consumer.h>\n#include <linux/slab.h>\n\n#include <video/display_timing.h>\n#include <video/of_display_timing.h>\n#include <video/videomode.h>\n\n#include <drm/drm_crtc.h>\n#include <drm/drm_of.h>\n#include <drm/drm_panel.h>\n\nstruct panel_lvds {\n\tstruct drm_panel panel;\n\tstruct device *dev;\n\n\tconst char *label;\n\tunsigned int width;\n\tunsigned int height;\n\tstruct drm_display_mode dmode;\n\tu32 bus_flags;\n\tunsigned int bus_format;\n\n\tstruct regulator *supply;\n\n\tstruct gpio_desc *enable_gpio;\n\tstruct gpio_desc *reset_gpio;\n\n\tenum drm_panel_orientation orientation;\n};\n\nstatic inline struct panel_lvds *to_panel_lvds(struct drm_panel *panel)\n{\n\treturn container_of(panel, struct panel_lvds, panel);\n}\n\nstatic int panel_lvds_unprepare(struct drm_panel *panel)\n{\n\tstruct panel_lvds *lvds = to_panel_lvds(panel);\n\n\tif (lvds->enable_gpio)\n\t\tgpiod_set_value_cansleep(lvds->enable_gpio, 0);\n\n\tif (lvds->supply)\n\t\tregulator_disable(lvds->supply);\n\n\treturn 0;\n}\n\nstatic int panel_lvds_prepare(struct drm_panel *panel)\n{\n\tstruct panel_lvds *lvds = to_panel_lvds(panel);\n\n\tif (lvds->supply) {\n\t\tint err;\n\n\t\terr = regulator_enable(lvds->supply);\n\t\tif (err < 0) {\n\t\t\tdev_err(lvds->dev, \"failed to enable supply: %d\\n\",\n\t\t\t\terr);\n\t\t\treturn err;\n\t\t}\n\t}\n\n\tif (lvds->enable_gpio)\n\t\tgpiod_set_value_cansleep(lvds->enable_gpio, 1);\n\n\treturn 0;\n}\n\nstatic int panel_lvds_get_modes(struct drm_panel *panel,\n\t\t\t\tstruct drm_connector *connector)\n{\n\tstruct panel_lvds *lvds = to_panel_lvds(panel);\n\tstruct drm_display_mode *mode;\n\n\tmode = drm_mode_duplicate(connector->dev, &lvds->dmode);\n\tif (!mode)\n\t\treturn 0;\n\n\tmode->type |= DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;\n\tdrm_mode_probed_add(connector, mode);\n\n\tconnector->display_info.width_mm = lvds->dmode.width_mm;\n\tconnector->display_info.height_mm = lvds->dmode.height_mm;\n\tdrm_display_info_set_bus_formats(&connector->display_info,\n\t\t\t\t\t &lvds->bus_format, 1);\n\tconnector->display_info.bus_flags = lvds->bus_flags;\n\n\t \n\tdrm_connector_set_panel_orientation(connector, lvds->orientation);\n\n\treturn 1;\n}\n\nstatic enum drm_panel_orientation panel_lvds_get_orientation(struct drm_panel *panel)\n{\n\tstruct panel_lvds *lvds = to_panel_lvds(panel);\n\n\treturn lvds->orientation;\n}\n\nstatic const struct drm_panel_funcs panel_lvds_funcs = {\n\t.unprepare = panel_lvds_unprepare,\n\t.prepare = panel_lvds_prepare,\n\t.get_modes = panel_lvds_get_modes,\n\t.get_orientation = panel_lvds_get_orientation,\n};\n\nstatic int panel_lvds_parse_dt(struct panel_lvds *lvds)\n{\n\tstruct device_node *np = lvds->dev->of_node;\n\tint ret;\n\n\tret = of_drm_get_panel_orientation(np, &lvds->orientation);\n\tif (ret < 0) {\n\t\tdev_err(lvds->dev, \"%pOF: failed to get orientation %d\\n\", np, ret);\n\t\treturn ret;\n\t}\n\n\tret = of_get_drm_panel_display_mode(np, &lvds->dmode, &lvds->bus_flags);\n\tif (ret < 0) {\n\t\tdev_err(lvds->dev, \"%pOF: problems parsing panel-timing (%d)\\n\",\n\t\t\tnp, ret);\n\t\treturn ret;\n\t}\n\n\tof_property_read_string(np, \"label\", &lvds->label);\n\n\tret = drm_of_lvds_get_data_mapping(np);\n\tif (ret < 0) {\n\t\tdev_err(lvds->dev, \"%pOF: invalid or missing %s DT property\\n\",\n\t\t\tnp, \"data-mapping\");\n\t\treturn ret;\n\t}\n\n\tlvds->bus_format = ret;\n\n\tlvds->bus_flags |= of_property_read_bool(np, \"data-mirror\") ?\n\t\t\t   DRM_BUS_FLAG_DATA_LSB_TO_MSB :\n\t\t\t   DRM_BUS_FLAG_DATA_MSB_TO_LSB;\n\n\treturn 0;\n}\n\nstatic int panel_lvds_probe(struct platform_device *pdev)\n{\n\tstruct panel_lvds *lvds;\n\tint ret;\n\n\tlvds = devm_kzalloc(&pdev->dev, sizeof(*lvds), GFP_KERNEL);\n\tif (!lvds)\n\t\treturn -ENOMEM;\n\n\tlvds->dev = &pdev->dev;\n\n\tret = panel_lvds_parse_dt(lvds);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tlvds->supply = devm_regulator_get_optional(lvds->dev, \"power\");\n\tif (IS_ERR(lvds->supply)) {\n\t\tret = PTR_ERR(lvds->supply);\n\n\t\tif (ret != -ENODEV) {\n\t\t\tif (ret != -EPROBE_DEFER)\n\t\t\t\tdev_err(lvds->dev, \"failed to request regulator: %d\\n\",\n\t\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tlvds->supply = NULL;\n\t}\n\n\t \n\tlvds->enable_gpio = devm_gpiod_get_optional(lvds->dev, \"enable\",\n\t\t\t\t\t\t     GPIOD_OUT_LOW);\n\tif (IS_ERR(lvds->enable_gpio)) {\n\t\tret = PTR_ERR(lvds->enable_gpio);\n\t\tdev_err(lvds->dev, \"failed to request %s GPIO: %d\\n\",\n\t\t\t\"enable\", ret);\n\t\treturn ret;\n\t}\n\n\tlvds->reset_gpio = devm_gpiod_get_optional(lvds->dev, \"reset\",\n\t\t\t\t\t\t     GPIOD_OUT_HIGH);\n\tif (IS_ERR(lvds->reset_gpio)) {\n\t\tret = PTR_ERR(lvds->reset_gpio);\n\t\tdev_err(lvds->dev, \"failed to request %s GPIO: %d\\n\",\n\t\t\t\"reset\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\n\t \n\tdrm_panel_init(&lvds->panel, lvds->dev, &panel_lvds_funcs,\n\t\t       DRM_MODE_CONNECTOR_LVDS);\n\n\tret = drm_panel_of_backlight(&lvds->panel);\n\tif (ret)\n\t\treturn ret;\n\n\tdrm_panel_add(&lvds->panel);\n\n\tdev_set_drvdata(lvds->dev, lvds);\n\treturn 0;\n}\n\nstatic void panel_lvds_remove(struct platform_device *pdev)\n{\n\tstruct panel_lvds *lvds = platform_get_drvdata(pdev);\n\n\tdrm_panel_remove(&lvds->panel);\n\n\tdrm_panel_disable(&lvds->panel);\n}\n\nstatic const struct of_device_id panel_lvds_of_table[] = {\n\t{ .compatible = \"panel-lvds\", },\n\t{   },\n};\n\nMODULE_DEVICE_TABLE(of, panel_lvds_of_table);\n\nstatic struct platform_driver panel_lvds_driver = {\n\t.probe\t\t= panel_lvds_probe,\n\t.remove_new\t= panel_lvds_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"panel-lvds\",\n\t\t.of_match_table = panel_lvds_of_table,\n\t},\n};\n\nmodule_platform_driver(panel_lvds_driver);\n\nMODULE_AUTHOR(\"Laurent Pinchart <laurent.pinchart@ideasonboard.com>\");\nMODULE_DESCRIPTION(\"LVDS Panel Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}