{
  "module_name": "panel-lg-lg4573.c",
  "hash_id": "bed6cebc9e0d48b5def3d3eaec01f99ec316f9d1127c1d0ec1bb559f36f42868",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/panel/panel-lg-lg4573.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/regulator/consumer.h>\n#include <linux/spi/spi.h>\n\n#include <video/mipi_display.h>\n#include <video/of_videomode.h>\n#include <video/videomode.h>\n\n#include <drm/drm_device.h>\n#include <drm/drm_modes.h>\n#include <drm/drm_panel.h>\n\nstruct lg4573 {\n\tstruct drm_panel panel;\n\tstruct spi_device *spi;\n\tstruct videomode vm;\n};\n\nstatic inline struct lg4573 *panel_to_lg4573(struct drm_panel *panel)\n{\n\treturn container_of(panel, struct lg4573, panel);\n}\n\nstatic int lg4573_spi_write_u16(struct lg4573 *ctx, u16 data)\n{\n\tstruct spi_transfer xfer = {\n\t\t.len = 2,\n\t};\n\t__be16 temp = cpu_to_be16(data);\n\tstruct spi_message msg;\n\n\tdev_dbg(ctx->panel.dev, \"writing data: %x\\n\", data);\n\txfer.tx_buf = &temp;\n\tspi_message_init(&msg);\n\tspi_message_add_tail(&xfer, &msg);\n\n\treturn spi_sync(ctx->spi, &msg);\n}\n\nstatic int lg4573_spi_write_u16_array(struct lg4573 *ctx, const u16 *buffer,\n\t\t\t\t      unsigned int count)\n{\n\tunsigned int i;\n\tint ret;\n\n\tfor (i = 0; i < count; i++) {\n\t\tret = lg4573_spi_write_u16(ctx, buffer[i]);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int lg4573_spi_write_dcs(struct lg4573 *ctx, u8 dcs)\n{\n\treturn lg4573_spi_write_u16(ctx, (0x70 << 8 | dcs));\n}\n\nstatic int lg4573_display_on(struct lg4573 *ctx)\n{\n\tint ret;\n\n\tret = lg4573_spi_write_dcs(ctx, MIPI_DCS_EXIT_SLEEP_MODE);\n\tif (ret)\n\t\treturn ret;\n\n\tmsleep(5);\n\n\treturn lg4573_spi_write_dcs(ctx, MIPI_DCS_SET_DISPLAY_ON);\n}\n\nstatic int lg4573_display_off(struct lg4573 *ctx)\n{\n\tint ret;\n\n\tret = lg4573_spi_write_dcs(ctx, MIPI_DCS_SET_DISPLAY_OFF);\n\tif (ret)\n\t\treturn ret;\n\n\tmsleep(120);\n\n\treturn lg4573_spi_write_dcs(ctx, MIPI_DCS_ENTER_SLEEP_MODE);\n}\n\nstatic int lg4573_display_mode_settings(struct lg4573 *ctx)\n{\n\tstatic const u16 display_mode_settings[] = {\n\t\t0x703A, 0x7270, 0x70B1, 0x7208,\n\t\t0x723B, 0x720F, 0x70B2, 0x7200,\n\t\t0x72C8, 0x70B3, 0x7200, 0x70B4,\n\t\t0x7200, 0x70B5, 0x7242, 0x7210,\n\t\t0x7210, 0x7200, 0x7220, 0x70B6,\n\t\t0x720B, 0x720F, 0x723C, 0x7213,\n\t\t0x7213, 0x72E8, 0x70B7, 0x7246,\n\t\t0x7206, 0x720C, 0x7200, 0x7200,\n\t};\n\n\tdev_dbg(ctx->panel.dev, \"transfer display mode settings\\n\");\n\treturn lg4573_spi_write_u16_array(ctx, display_mode_settings,\n\t\t\t\t\t  ARRAY_SIZE(display_mode_settings));\n}\n\nstatic int lg4573_power_settings(struct lg4573 *ctx)\n{\n\tstatic const u16 power_settings[] = {\n\t\t0x70C0, 0x7201, 0x7211, 0x70C3,\n\t\t0x7207, 0x7203, 0x7204, 0x7204,\n\t\t0x7204, 0x70C4, 0x7212, 0x7224,\n\t\t0x7218, 0x7218, 0x7202, 0x7249,\n\t\t0x70C5, 0x726F, 0x70C6, 0x7241,\n\t\t0x7263,\n\t};\n\n\tdev_dbg(ctx->panel.dev, \"transfer power settings\\n\");\n\treturn lg4573_spi_write_u16_array(ctx, power_settings,\n\t\t\t\t\t  ARRAY_SIZE(power_settings));\n}\n\nstatic int lg4573_gamma_settings(struct lg4573 *ctx)\n{\n\tstatic const u16 gamma_settings[] = {\n\t\t0x70D0, 0x7203, 0x7207, 0x7273,\n\t\t0x7235, 0x7200, 0x7201, 0x7220,\n\t\t0x7200, 0x7203, 0x70D1, 0x7203,\n\t\t0x7207, 0x7273, 0x7235, 0x7200,\n\t\t0x7201, 0x7220, 0x7200, 0x7203,\n\t\t0x70D2, 0x7203, 0x7207, 0x7273,\n\t\t0x7235, 0x7200, 0x7201, 0x7220,\n\t\t0x7200, 0x7203, 0x70D3, 0x7203,\n\t\t0x7207, 0x7273, 0x7235, 0x7200,\n\t\t0x7201, 0x7220, 0x7200, 0x7203,\n\t\t0x70D4, 0x7203, 0x7207, 0x7273,\n\t\t0x7235, 0x7200, 0x7201, 0x7220,\n\t\t0x7200, 0x7203, 0x70D5, 0x7203,\n\t\t0x7207, 0x7273, 0x7235, 0x7200,\n\t\t0x7201, 0x7220, 0x7200, 0x7203,\n\t};\n\n\tdev_dbg(ctx->panel.dev, \"transfer gamma settings\\n\");\n\treturn lg4573_spi_write_u16_array(ctx, gamma_settings,\n\t\t\t\t\t  ARRAY_SIZE(gamma_settings));\n}\n\nstatic int lg4573_init(struct lg4573 *ctx)\n{\n\tint ret;\n\n\tdev_dbg(ctx->panel.dev, \"initializing LCD\\n\");\n\n\tret = lg4573_display_mode_settings(ctx);\n\tif (ret)\n\t\treturn ret;\n\n\tret = lg4573_power_settings(ctx);\n\tif (ret)\n\t\treturn ret;\n\n\treturn lg4573_gamma_settings(ctx);\n}\n\nstatic int lg4573_power_on(struct lg4573 *ctx)\n{\n\treturn lg4573_display_on(ctx);\n}\n\nstatic int lg4573_disable(struct drm_panel *panel)\n{\n\tstruct lg4573 *ctx = panel_to_lg4573(panel);\n\n\treturn lg4573_display_off(ctx);\n}\n\nstatic int lg4573_enable(struct drm_panel *panel)\n{\n\tstruct lg4573 *ctx = panel_to_lg4573(panel);\n\n\tlg4573_init(ctx);\n\n\treturn lg4573_power_on(ctx);\n}\n\nstatic const struct drm_display_mode default_mode = {\n\t.clock = 28341,\n\t.hdisplay = 480,\n\t.hsync_start = 480 + 10,\n\t.hsync_end = 480 + 10 + 59,\n\t.htotal = 480 + 10 + 59 + 10,\n\t.vdisplay = 800,\n\t.vsync_start = 800 + 15,\n\t.vsync_end = 800 + 15 + 15,\n\t.vtotal = 800 + 15 + 15 + 15,\n};\n\nstatic int lg4573_get_modes(struct drm_panel *panel,\n\t\t\t    struct drm_connector *connector)\n{\n\tstruct drm_display_mode *mode;\n\n\tmode = drm_mode_duplicate(connector->dev, &default_mode);\n\tif (!mode) {\n\t\tdev_err(panel->dev, \"failed to add mode %ux%ux@%u\\n\",\n\t\t\tdefault_mode.hdisplay, default_mode.vdisplay,\n\t\t\tdrm_mode_vrefresh(&default_mode));\n\t\treturn -ENOMEM;\n\t}\n\n\tdrm_mode_set_name(mode);\n\n\tmode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;\n\tdrm_mode_probed_add(connector, mode);\n\n\tconnector->display_info.width_mm = 61;\n\tconnector->display_info.height_mm = 103;\n\n\treturn 1;\n}\n\nstatic const struct drm_panel_funcs lg4573_drm_funcs = {\n\t.disable = lg4573_disable,\n\t.enable = lg4573_enable,\n\t.get_modes = lg4573_get_modes,\n};\n\nstatic int lg4573_probe(struct spi_device *spi)\n{\n\tstruct lg4573 *ctx;\n\tint ret;\n\n\tctx = devm_kzalloc(&spi->dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tctx->spi = spi;\n\n\tspi_set_drvdata(spi, ctx);\n\tspi->bits_per_word = 8;\n\n\tret = spi_setup(spi);\n\tif (ret < 0) {\n\t\tdev_err(&spi->dev, \"SPI setup failed: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tdrm_panel_init(&ctx->panel, &spi->dev, &lg4573_drm_funcs,\n\t\t       DRM_MODE_CONNECTOR_DPI);\n\n\tdrm_panel_add(&ctx->panel);\n\n\treturn 0;\n}\n\nstatic void lg4573_remove(struct spi_device *spi)\n{\n\tstruct lg4573 *ctx = spi_get_drvdata(spi);\n\n\tlg4573_display_off(ctx);\n\tdrm_panel_remove(&ctx->panel);\n}\n\nstatic const struct of_device_id lg4573_of_match[] = {\n\t{ .compatible = \"lg,lg4573\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, lg4573_of_match);\n\nstatic struct spi_driver lg4573_driver = {\n\t.probe = lg4573_probe,\n\t.remove = lg4573_remove,\n\t.driver = {\n\t\t.name = \"lg4573\",\n\t\t.of_match_table = lg4573_of_match,\n\t},\n};\nmodule_spi_driver(lg4573_driver);\n\nMODULE_AUTHOR(\"Heiko Schocher <hs@denx.de>\");\nMODULE_DESCRIPTION(\"lg4573 LCD Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}