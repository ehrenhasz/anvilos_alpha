{
  "module_name": "panel-sitronix-st7789v.c",
  "hash_id": "e50daeb3f919610f7fd74285fc6134aeb07e21fb05c10b9ebf25892d13a1e8bb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/panel/panel-sitronix-st7789v.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/regulator/consumer.h>\n#include <linux/spi/spi.h>\n\n#include <video/mipi_display.h>\n#include <linux/media-bus-format.h>\n\n#include <drm/drm_device.h>\n#include <drm/drm_modes.h>\n#include <drm/drm_panel.h>\n\n#define ST7789V_RAMCTRL_CMD\t\t0xb0\n#define ST7789V_RAMCTRL_RM_RGB\t\t\tBIT(4)\n#define ST7789V_RAMCTRL_DM_RGB\t\t\tBIT(0)\n#define ST7789V_RAMCTRL_MAGIC\t\t\t(3 << 6)\n#define ST7789V_RAMCTRL_EPF(n)\t\t\t(((n) & 3) << 4)\n\n#define ST7789V_RGBCTRL_CMD\t\t0xb1\n#define ST7789V_RGBCTRL_WO\t\t\tBIT(7)\n#define ST7789V_RGBCTRL_RCM(n)\t\t\t(((n) & 3) << 5)\n#define ST7789V_RGBCTRL_VSYNC_HIGH\t\tBIT(3)\n#define ST7789V_RGBCTRL_HSYNC_HIGH\t\tBIT(2)\n#define ST7789V_RGBCTRL_PCLK_FALLING\t\tBIT(1)\n#define ST7789V_RGBCTRL_DE_LOW\t\t\tBIT(0)\n#define ST7789V_RGBCTRL_VBP(n)\t\t\t((n) & 0x7f)\n#define ST7789V_RGBCTRL_HBP(n)\t\t\t((n) & 0x1f)\n\n#define ST7789V_PORCTRL_CMD\t\t0xb2\n#define ST7789V_PORCTRL_IDLE_BP(n)\t\t(((n) & 0xf) << 4)\n#define ST7789V_PORCTRL_IDLE_FP(n)\t\t((n) & 0xf)\n#define ST7789V_PORCTRL_PARTIAL_BP(n)\t\t(((n) & 0xf) << 4)\n#define ST7789V_PORCTRL_PARTIAL_FP(n)\t\t((n) & 0xf)\n\n#define ST7789V_GCTRL_CMD\t\t0xb7\n#define ST7789V_GCTRL_VGHS(n)\t\t\t(((n) & 7) << 4)\n#define ST7789V_GCTRL_VGLS(n)\t\t\t((n) & 7)\n\n#define ST7789V_VCOMS_CMD\t\t0xbb\n\n#define ST7789V_LCMCTRL_CMD\t\t0xc0\n#define ST7789V_LCMCTRL_XBGR\t\t\tBIT(5)\n#define ST7789V_LCMCTRL_XMX\t\t\tBIT(3)\n#define ST7789V_LCMCTRL_XMH\t\t\tBIT(2)\n\n#define ST7789V_VDVVRHEN_CMD\t\t0xc2\n#define ST7789V_VDVVRHEN_CMDEN\t\t\tBIT(0)\n\n#define ST7789V_VRHS_CMD\t\t0xc3\n\n#define ST7789V_VDVS_CMD\t\t0xc4\n\n#define ST7789V_FRCTRL2_CMD\t\t0xc6\n\n#define ST7789V_PWCTRL1_CMD\t\t0xd0\n#define ST7789V_PWCTRL1_MAGIC\t\t\t0xa4\n#define ST7789V_PWCTRL1_AVDD(n)\t\t\t(((n) & 3) << 6)\n#define ST7789V_PWCTRL1_AVCL(n)\t\t\t(((n) & 3) << 4)\n#define ST7789V_PWCTRL1_VDS(n)\t\t\t((n) & 3)\n\n#define ST7789V_PVGAMCTRL_CMD\t\t0xe0\n#define ST7789V_PVGAMCTRL_JP0(n)\t\t(((n) & 3) << 4)\n#define ST7789V_PVGAMCTRL_JP1(n)\t\t(((n) & 3) << 4)\n#define ST7789V_PVGAMCTRL_VP0(n)\t\t((n) & 0xf)\n#define ST7789V_PVGAMCTRL_VP1(n)\t\t((n) & 0x3f)\n#define ST7789V_PVGAMCTRL_VP2(n)\t\t((n) & 0x3f)\n#define ST7789V_PVGAMCTRL_VP4(n)\t\t((n) & 0x1f)\n#define ST7789V_PVGAMCTRL_VP6(n)\t\t((n) & 0x1f)\n#define ST7789V_PVGAMCTRL_VP13(n)\t\t((n) & 0xf)\n#define ST7789V_PVGAMCTRL_VP20(n)\t\t((n) & 0x7f)\n#define ST7789V_PVGAMCTRL_VP27(n)\t\t((n) & 7)\n#define ST7789V_PVGAMCTRL_VP36(n)\t\t(((n) & 7) << 4)\n#define ST7789V_PVGAMCTRL_VP43(n)\t\t((n) & 0x7f)\n#define ST7789V_PVGAMCTRL_VP50(n)\t\t((n) & 0xf)\n#define ST7789V_PVGAMCTRL_VP57(n)\t\t((n) & 0x1f)\n#define ST7789V_PVGAMCTRL_VP59(n)\t\t((n) & 0x1f)\n#define ST7789V_PVGAMCTRL_VP61(n)\t\t((n) & 0x3f)\n#define ST7789V_PVGAMCTRL_VP62(n)\t\t((n) & 0x3f)\n#define ST7789V_PVGAMCTRL_VP63(n)\t\t(((n) & 0xf) << 4)\n\n#define ST7789V_NVGAMCTRL_CMD\t\t0xe1\n#define ST7789V_NVGAMCTRL_JN0(n)\t\t(((n) & 3) << 4)\n#define ST7789V_NVGAMCTRL_JN1(n)\t\t(((n) & 3) << 4)\n#define ST7789V_NVGAMCTRL_VN0(n)\t\t((n) & 0xf)\n#define ST7789V_NVGAMCTRL_VN1(n)\t\t((n) & 0x3f)\n#define ST7789V_NVGAMCTRL_VN2(n)\t\t((n) & 0x3f)\n#define ST7789V_NVGAMCTRL_VN4(n)\t\t((n) & 0x1f)\n#define ST7789V_NVGAMCTRL_VN6(n)\t\t((n) & 0x1f)\n#define ST7789V_NVGAMCTRL_VN13(n)\t\t((n) & 0xf)\n#define ST7789V_NVGAMCTRL_VN20(n)\t\t((n) & 0x7f)\n#define ST7789V_NVGAMCTRL_VN27(n)\t\t((n) & 7)\n#define ST7789V_NVGAMCTRL_VN36(n)\t\t(((n) & 7) << 4)\n#define ST7789V_NVGAMCTRL_VN43(n)\t\t((n) & 0x7f)\n#define ST7789V_NVGAMCTRL_VN50(n)\t\t((n) & 0xf)\n#define ST7789V_NVGAMCTRL_VN57(n)\t\t((n) & 0x1f)\n#define ST7789V_NVGAMCTRL_VN59(n)\t\t((n) & 0x1f)\n#define ST7789V_NVGAMCTRL_VN61(n)\t\t((n) & 0x3f)\n#define ST7789V_NVGAMCTRL_VN62(n)\t\t((n) & 0x3f)\n#define ST7789V_NVGAMCTRL_VN63(n)\t\t(((n) & 0xf) << 4)\n\n#define ST7789V_TEST(val, func)\t\t\t\\\n\tdo {\t\t\t\t\t\\\n\t\tif ((val = (func)))\t\t\\\n\t\t\treturn val;\t\t\\\n\t} while (0)\n\n#define ST7789V_IDS { 0x85, 0x85, 0x52 }\n#define ST7789V_IDS_SIZE 3\n\nstruct st7789_panel_info {\n\tconst struct drm_display_mode *mode;\n\tu32 bus_format;\n\tu32 bus_flags;\n\tbool invert_mode;\n\tbool partial_mode;\n\tu16 partial_start;\n\tu16 partial_end;\n};\n\nstruct st7789v {\n\tstruct drm_panel panel;\n\tconst struct st7789_panel_info *info;\n\tstruct spi_device *spi;\n\tstruct gpio_desc *reset;\n\tstruct regulator *power;\n\tenum drm_panel_orientation orientation;\n};\n\nenum st7789v_prefix {\n\tST7789V_COMMAND = 0,\n\tST7789V_DATA = 1,\n};\n\nstatic inline struct st7789v *panel_to_st7789v(struct drm_panel *panel)\n{\n\treturn container_of(panel, struct st7789v, panel);\n}\n\nstatic int st7789v_spi_write(struct st7789v *ctx, enum st7789v_prefix prefix,\n\t\t\t     u8 data)\n{\n\tstruct spi_transfer xfer = { };\n\tu16 txbuf = ((prefix & 1) << 8) | data;\n\n\txfer.tx_buf = &txbuf;\n\txfer.len = sizeof(txbuf);\n\n\treturn spi_sync_transfer(ctx->spi, &xfer, 1);\n}\n\nstatic int st7789v_write_command(struct st7789v *ctx, u8 cmd)\n{\n\treturn st7789v_spi_write(ctx, ST7789V_COMMAND, cmd);\n}\n\nstatic int st7789v_write_data(struct st7789v *ctx, u8 cmd)\n{\n\treturn st7789v_spi_write(ctx, ST7789V_DATA, cmd);\n}\n\nstatic int st7789v_read_data(struct st7789v *ctx, u8 cmd, u8 *buf,\n\t\t\t     unsigned int len)\n{\n\tstruct spi_transfer xfer[2] = { };\n\tstruct spi_message msg;\n\tu16 txbuf = ((ST7789V_COMMAND & 1) << 8) | cmd;\n\tu16 rxbuf[4] = {};\n\tu8 bit9 = 0;\n\tint ret, i;\n\n\tswitch (len) {\n\tcase 1:\n\tcase 3:\n\tcase 4:\n\t\tbreak;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tspi_message_init(&msg);\n\n\txfer[0].tx_buf = &txbuf;\n\txfer[0].len = sizeof(txbuf);\n\tspi_message_add_tail(&xfer[0], &msg);\n\n\txfer[1].rx_buf = rxbuf;\n\txfer[1].len = len * 2;\n\tspi_message_add_tail(&xfer[1], &msg);\n\n\tret = spi_sync(ctx->spi, &msg);\n\tif (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < len; i++) {\n\t\tbuf[i] = rxbuf[i] >> i | (bit9 << (9 - i));\n\t\tif (i)\n\t\t\tbit9 = rxbuf[i] & GENMASK(i - 1, 0);\n\t}\n\n\treturn 0;\n}\n\nstatic int st7789v_check_id(struct drm_panel *panel)\n{\n\tconst u8 st7789v_ids[ST7789V_IDS_SIZE] = ST7789V_IDS;\n\tstruct st7789v *ctx = panel_to_st7789v(panel);\n\tbool invalid_ids = false;\n\tint ret, i;\n\tu8 ids[3];\n\n\tif (ctx->spi->mode & SPI_NO_RX)\n\t\treturn 0;\n\n\tret = st7789v_read_data(ctx, MIPI_DCS_GET_DISPLAY_ID, ids, ST7789V_IDS_SIZE);\n\tif (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < ST7789V_IDS_SIZE; i++) {\n\t\tif (ids[i] != st7789v_ids[i]) {\n\t\t\tinvalid_ids = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (invalid_ids)\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\nstatic const struct drm_display_mode default_mode = {\n\t.clock = 7000,\n\t.hdisplay = 240,\n\t.hsync_start = 240 + 38,\n\t.hsync_end = 240 + 38 + 10,\n\t.htotal = 240 + 38 + 10 + 10,\n\t.vdisplay = 320,\n\t.vsync_start = 320 + 8,\n\t.vsync_end = 320 + 8 + 4,\n\t.vtotal = 320 + 8 + 4 + 4,\n\t.width_mm = 61,\n\t.height_mm = 103,\n\t.flags = DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_PVSYNC,\n};\n\nstatic const struct drm_display_mode t28cp45tn89_mode = {\n\t.clock = 6008,\n\t.hdisplay = 240,\n\t.hsync_start = 240 + 38,\n\t.hsync_end = 240 + 38 + 10,\n\t.htotal = 240 + 38 + 10 + 10,\n\t.vdisplay = 320,\n\t.vsync_start = 320 + 8,\n\t.vsync_end = 320 + 8 + 4,\n\t.vtotal = 320 + 8 + 4 + 4,\n\t.width_mm = 43,\n\t.height_mm = 57,\n\t.flags = DRM_MODE_FLAG_PVSYNC | DRM_MODE_FLAG_NVSYNC,\n};\n\nstatic const struct drm_display_mode et028013dma_mode = {\n\t.clock = 3000,\n\t.hdisplay = 240,\n\t.hsync_start = 240 + 38,\n\t.hsync_end = 240 + 38 + 10,\n\t.htotal = 240 + 38 + 10 + 10,\n\t.vdisplay = 320,\n\t.vsync_start = 320 + 8,\n\t.vsync_end = 320 + 8 + 4,\n\t.vtotal = 320 + 8 + 4 + 4,\n\t.width_mm = 43,\n\t.height_mm = 58,\n\t.flags = DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_PVSYNC,\n};\n\nstatic const struct drm_display_mode jt240mhqs_hwt_ek_e3_mode = {\n\t.clock = 6000,\n\t.hdisplay = 240,\n\t.hsync_start = 240 + 28,\n\t.hsync_end = 240 + 28 + 10,\n\t.htotal = 240 + 28 + 10 + 10,\n\t.vdisplay = 280,\n\t.vsync_start = 280 + 8,\n\t.vsync_end = 280 + 8 + 4,\n\t.vtotal = 280 + 8 + 4 + 4,\n\t.width_mm = 43,\n\t.height_mm = 37,\n\t.flags = DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_PVSYNC,\n};\n\nstatic const struct st7789_panel_info default_panel = {\n\t.mode = &default_mode,\n\t.invert_mode = true,\n\t.bus_format = MEDIA_BUS_FMT_RGB666_1X18,\n\t.bus_flags = DRM_BUS_FLAG_DE_HIGH |\n\t\t     DRM_BUS_FLAG_PIXDATA_SAMPLE_NEGEDGE,\n};\n\nstatic const struct st7789_panel_info t28cp45tn89_panel = {\n\t.mode = &t28cp45tn89_mode,\n\t.invert_mode = false,\n\t.bus_format = MEDIA_BUS_FMT_RGB565_1X16,\n\t.bus_flags = DRM_BUS_FLAG_DE_HIGH |\n\t\t     DRM_BUS_FLAG_PIXDATA_SAMPLE_POSEDGE,\n};\n\nstatic const struct st7789_panel_info et028013dma_panel = {\n\t.mode = &et028013dma_mode,\n\t.invert_mode = true,\n\t.bus_format = MEDIA_BUS_FMT_RGB666_1X18,\n\t.bus_flags = DRM_BUS_FLAG_DE_HIGH |\n\t\t     DRM_BUS_FLAG_PIXDATA_SAMPLE_POSEDGE,\n};\n\nstatic const struct st7789_panel_info jt240mhqs_hwt_ek_e3_panel = {\n\t.mode = &jt240mhqs_hwt_ek_e3_mode,\n\t.invert_mode = true,\n\t.bus_format = MEDIA_BUS_FMT_RGB666_1X18,\n\t.bus_flags = DRM_BUS_FLAG_DE_HIGH |\n\t\t     DRM_BUS_FLAG_PIXDATA_SAMPLE_NEGEDGE,\n\t.partial_mode = true,\n\t.partial_start = 38,\n\t.partial_end = 318,\n};\n\nstatic int st7789v_get_modes(struct drm_panel *panel,\n\t\t\t     struct drm_connector *connector)\n{\n\tstruct st7789v *ctx = panel_to_st7789v(panel);\n\tstruct drm_display_mode *mode;\n\n\tmode = drm_mode_duplicate(connector->dev, ctx->info->mode);\n\tif (!mode) {\n\t\tdev_err(panel->dev, \"failed to add mode %ux%u@%u\\n\",\n\t\t\tctx->info->mode->hdisplay, ctx->info->mode->vdisplay,\n\t\t\tdrm_mode_vrefresh(ctx->info->mode));\n\t\treturn -ENOMEM;\n\t}\n\n\tdrm_mode_set_name(mode);\n\n\tmode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;\n\tdrm_mode_probed_add(connector, mode);\n\n\tconnector->display_info.bpc = 6;\n\tconnector->display_info.width_mm = ctx->info->mode->width_mm;\n\tconnector->display_info.height_mm = ctx->info->mode->height_mm;\n\tconnector->display_info.bus_flags = ctx->info->bus_flags;\n\tdrm_display_info_set_bus_formats(&connector->display_info,\n\t\t\t\t\t &ctx->info->bus_format, 1);\n\n\t \n\tdrm_connector_set_panel_orientation(connector, ctx->orientation);\n\n\treturn 1;\n}\n\nstatic enum drm_panel_orientation st7789v_get_orientation(struct drm_panel *p)\n{\n\tstruct st7789v *ctx = panel_to_st7789v(p);\n\n\treturn ctx->orientation;\n}\n\nstatic int st7789v_prepare(struct drm_panel *panel)\n{\n\tstruct st7789v *ctx = panel_to_st7789v(panel);\n\tu8 mode, pixel_fmt, polarity;\n\tint ret;\n\n\tif (!ctx->info->partial_mode)\n\t\tmode = ST7789V_RGBCTRL_WO;\n\telse\n\t\tmode = 0;\n\n\tswitch (ctx->info->bus_format) {\n\tcase MEDIA_BUS_FMT_RGB666_1X18:\n\t\tpixel_fmt = MIPI_DCS_PIXEL_FMT_18BIT;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_RGB565_1X16:\n\t\tpixel_fmt = MIPI_DCS_PIXEL_FMT_16BIT;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(panel->dev, \"unsupported bus format: %d\\n\",\n\t\t\tctx->info->bus_format);\n\t\treturn -EINVAL;\n\t}\n\n\tpixel_fmt = (pixel_fmt << 4) | pixel_fmt;\n\n\tpolarity = 0;\n\tif (ctx->info->mode->flags & DRM_MODE_FLAG_PVSYNC)\n\t\tpolarity |= ST7789V_RGBCTRL_VSYNC_HIGH;\n\tif (ctx->info->mode->flags & DRM_MODE_FLAG_PHSYNC)\n\t\tpolarity |= ST7789V_RGBCTRL_HSYNC_HIGH;\n\tif (ctx->info->bus_flags & DRM_BUS_FLAG_PIXDATA_SAMPLE_NEGEDGE)\n\t\tpolarity |= ST7789V_RGBCTRL_PCLK_FALLING;\n\tif (ctx->info->bus_flags & DRM_BUS_FLAG_DE_LOW)\n\t\tpolarity |= ST7789V_RGBCTRL_DE_LOW;\n\n\tret = regulator_enable(ctx->power);\n\tif (ret)\n\t\treturn ret;\n\n\tgpiod_set_value(ctx->reset, 1);\n\tmsleep(30);\n\tgpiod_set_value(ctx->reset, 0);\n\tmsleep(120);\n\n\t \n\tret = st7789v_check_id(panel);\n\tif (ret)\n\t\tdev_warn(panel->dev, \"Unrecognized panel IDs\");\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, MIPI_DCS_EXIT_SLEEP_MODE));\n\n\t \n\tmsleep(120);\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx,\n\t\t\t\t\t\tMIPI_DCS_SET_ADDRESS_MODE));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, 0));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx,\n\t\t\t\t\t\tMIPI_DCS_SET_PIXEL_FORMAT));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, pixel_fmt));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_PORCTRL_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, 0xc));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, 0xc));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, 0));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PORCTRL_IDLE_BP(3) |\n\t\t\t\t\t     ST7789V_PORCTRL_IDLE_FP(3)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx,\n\t\t\t\t\t     ST7789V_PORCTRL_PARTIAL_BP(3) |\n\t\t\t\t\t     ST7789V_PORCTRL_PARTIAL_FP(3)));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_GCTRL_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_GCTRL_VGLS(5) |\n\t\t\t\t\t     ST7789V_GCTRL_VGHS(3)));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_VCOMS_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, 0x2b));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_LCMCTRL_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_LCMCTRL_XMH |\n\t\t\t\t\t     ST7789V_LCMCTRL_XMX |\n\t\t\t\t\t     ST7789V_LCMCTRL_XBGR));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_VDVVRHEN_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_VDVVRHEN_CMDEN));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_VRHS_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, 0xf));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_VDVS_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, 0x20));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_FRCTRL2_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, 0xf));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_PWCTRL1_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PWCTRL1_MAGIC));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PWCTRL1_AVDD(2) |\n\t\t\t\t\t     ST7789V_PWCTRL1_AVCL(2) |\n\t\t\t\t\t     ST7789V_PWCTRL1_VDS(1)));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_PVGAMCTRL_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP63(0xd)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP1(0xca)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP2(0xe)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP4(8)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP6(9)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP13(7)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP20(0x2d)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP27(0xb) |\n\t\t\t\t\t     ST7789V_PVGAMCTRL_VP36(3)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP43(0x3d)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_JP1(3) |\n\t\t\t\t\t     ST7789V_PVGAMCTRL_VP50(4)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP57(0xa)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP59(0xa)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP61(0x1b)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_PVGAMCTRL_VP62(0x28)));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_NVGAMCTRL_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN63(0xd)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN1(0xca)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN2(0xf)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN4(8)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN6(8)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN13(7)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN20(0x2e)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN27(0xc) |\n\t\t\t\t\t     ST7789V_NVGAMCTRL_VN36(5)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN43(0x40)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_JN1(3) |\n\t\t\t\t\t     ST7789V_NVGAMCTRL_VN50(4)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN57(9)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN59(0xb)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN61(0x1b)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_NVGAMCTRL_VN62(0x28)));\n\n\tif (ctx->info->invert_mode) {\n\t\tST7789V_TEST(ret, st7789v_write_command(ctx,\n\t\t\t\t\t\tMIPI_DCS_ENTER_INVERT_MODE));\n\t} else {\n\t\tST7789V_TEST(ret, st7789v_write_command(ctx,\n\t\t\t\t\t\tMIPI_DCS_EXIT_INVERT_MODE));\n\t}\n\n\tif (ctx->info->partial_mode) {\n\t\tu8 area_data[4] = {\n\t\t\t(ctx->info->partial_start >> 8) & 0xff,\n\t\t\t(ctx->info->partial_start >> 0) & 0xff,\n\t\t\t((ctx->info->partial_end - 1) >> 8) & 0xff,\n\t\t\t((ctx->info->partial_end - 1) >> 0) & 0xff,\n\t\t};\n\n\t\t \n\n\t\tST7789V_TEST(ret, st7789v_write_command(\n\t\t\t\t\t  ctx, MIPI_DCS_ENTER_PARTIAL_MODE));\n\n\t\tST7789V_TEST(ret, st7789v_write_command(\n\t\t\t\t\t  ctx, MIPI_DCS_SET_PAGE_ADDRESS));\n\t\tST7789V_TEST(ret, st7789v_write_data(ctx, area_data[0]));\n\t\tST7789V_TEST(ret, st7789v_write_data(ctx, area_data[1]));\n\t\tST7789V_TEST(ret, st7789v_write_data(ctx, area_data[2]));\n\t\tST7789V_TEST(ret, st7789v_write_data(ctx, area_data[3]));\n\n\t\tST7789V_TEST(ret, st7789v_write_command(\n\t\t\t\t\t  ctx, MIPI_DCS_SET_PARTIAL_ROWS));\n\t\tST7789V_TEST(ret, st7789v_write_data(ctx, area_data[0]));\n\t\tST7789V_TEST(ret, st7789v_write_data(ctx, area_data[1]));\n\t\tST7789V_TEST(ret, st7789v_write_data(ctx, area_data[2]));\n\t\tST7789V_TEST(ret, st7789v_write_data(ctx, area_data[3]));\n\t}\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_RAMCTRL_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_RAMCTRL_DM_RGB |\n\t\t\t\t\t     ST7789V_RAMCTRL_RM_RGB));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_RAMCTRL_EPF(3) |\n\t\t\t\t\t     ST7789V_RAMCTRL_MAGIC));\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, ST7789V_RGBCTRL_CMD));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, mode |\n\t\t\t\t\t     ST7789V_RGBCTRL_RCM(2) |\n\t\t\t\t\t     polarity));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_RGBCTRL_VBP(8)));\n\tST7789V_TEST(ret, st7789v_write_data(ctx, ST7789V_RGBCTRL_HBP(20)));\n\n\treturn 0;\n}\n\nstatic int st7789v_enable(struct drm_panel *panel)\n{\n\tstruct st7789v *ctx = panel_to_st7789v(panel);\n\n\treturn st7789v_write_command(ctx, MIPI_DCS_SET_DISPLAY_ON);\n}\n\nstatic int st7789v_disable(struct drm_panel *panel)\n{\n\tstruct st7789v *ctx = panel_to_st7789v(panel);\n\tint ret;\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, MIPI_DCS_SET_DISPLAY_OFF));\n\n\treturn 0;\n}\n\nstatic int st7789v_unprepare(struct drm_panel *panel)\n{\n\tstruct st7789v *ctx = panel_to_st7789v(panel);\n\tint ret;\n\n\tST7789V_TEST(ret, st7789v_write_command(ctx, MIPI_DCS_ENTER_SLEEP_MODE));\n\n\tregulator_disable(ctx->power);\n\n\treturn 0;\n}\n\nstatic const struct drm_panel_funcs st7789v_drm_funcs = {\n\t.disable = st7789v_disable,\n\t.enable\t= st7789v_enable,\n\t.get_modes = st7789v_get_modes,\n\t.get_orientation = st7789v_get_orientation,\n\t.prepare = st7789v_prepare,\n\t.unprepare = st7789v_unprepare,\n};\n\nstatic int st7789v_probe(struct spi_device *spi)\n{\n\tstruct device *dev = &spi->dev;\n\tstruct st7789v *ctx;\n\tint ret;\n\n\tctx = devm_kzalloc(dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tspi_set_drvdata(spi, ctx);\n\tctx->spi = spi;\n\n\tspi->bits_per_word = 9;\n\tret = spi_setup(spi);\n\tif (ret < 0)\n\t\treturn dev_err_probe(&spi->dev, ret, \"Failed to setup spi\\n\");\n\n\tctx->info = device_get_match_data(&spi->dev);\n\n\tdrm_panel_init(&ctx->panel, dev, &st7789v_drm_funcs,\n\t\t       DRM_MODE_CONNECTOR_DPI);\n\n\tctx->power = devm_regulator_get(dev, \"power\");\n\tret = PTR_ERR_OR_ZERO(ctx->power);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to get regulator\\n\");\n\n\tctx->reset = devm_gpiod_get_optional(dev, \"reset\", GPIOD_OUT_LOW);\n\tret = PTR_ERR_OR_ZERO(ctx->reset);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to get reset line\\n\");\n\n\tret = drm_panel_of_backlight(&ctx->panel);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to get backlight\\n\");\n\n\tof_drm_get_panel_orientation(spi->dev.of_node, &ctx->orientation);\n\n\tdrm_panel_add(&ctx->panel);\n\n\treturn 0;\n}\n\nstatic void st7789v_remove(struct spi_device *spi)\n{\n\tstruct st7789v *ctx = spi_get_drvdata(spi);\n\n\tdrm_panel_remove(&ctx->panel);\n}\n\nstatic const struct spi_device_id st7789v_spi_id[] = {\n\t{ \"st7789v\", (unsigned long) &default_panel },\n\t{ \"t28cp45tn89-v17\", (unsigned long) &t28cp45tn89_panel },\n\t{ \"et028013dma\", (unsigned long) &et028013dma_panel },\n\t{ \"jt240mhqs-hwt-ek-e3\", (unsigned long) &jt240mhqs_hwt_ek_e3_panel },\n\t{ }\n};\nMODULE_DEVICE_TABLE(spi, st7789v_spi_id);\n\nstatic const struct of_device_id st7789v_of_match[] = {\n\t{ .compatible = \"sitronix,st7789v\", .data = &default_panel },\n\t{ .compatible = \"inanbo,t28cp45tn89-v17\", .data = &t28cp45tn89_panel },\n\t{ .compatible = \"edt,et028013dma\", .data = &et028013dma_panel },\n\t{ .compatible = \"jasonic,jt240mhqs-hwt-ek-e3\",\n\t  .data = &jt240mhqs_hwt_ek_e3_panel },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, st7789v_of_match);\n\nstatic struct spi_driver st7789v_driver = {\n\t.probe = st7789v_probe,\n\t.remove = st7789v_remove,\n\t.id_table = st7789v_spi_id,\n\t.driver = {\n\t\t.name = \"st7789v\",\n\t\t.of_match_table = st7789v_of_match,\n\t},\n};\nmodule_spi_driver(st7789v_driver);\n\nMODULE_AUTHOR(\"Maxime Ripard <maxime.ripard@free-electrons.com>\");\nMODULE_DESCRIPTION(\"Sitronix st7789v LCD Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}