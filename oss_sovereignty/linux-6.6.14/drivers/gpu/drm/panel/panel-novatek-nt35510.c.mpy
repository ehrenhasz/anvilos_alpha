{
  "module_name": "panel-novatek-nt35510.c",
  "hash_id": "04f4210c45d968e68da7e27864900c2800a9367dacaab547cdfcbd44dd390cb7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/panel/panel-novatek-nt35510.c",
  "human_readable_source": "\n \n#include <linux/backlight.h>\n#include <linux/bitops.h>\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/regmap.h>\n#include <linux/regulator/consumer.h>\n\n#include <video/mipi_display.h>\n\n#include <drm/drm_mipi_dsi.h>\n#include <drm/drm_modes.h>\n#include <drm/drm_panel.h>\n\n#define MCS_CMD_MAUCCTR\t\t0xF0  \n#define MCS_CMD_READ_ID1\t0xDA\n#define MCS_CMD_READ_ID2\t0xDB\n#define MCS_CMD_READ_ID3\t0xDC\n#define MCS_CMD_MTP_READ_SETTING 0xF8  \n#define MCS_CMD_MTP_READ_PARAM 0xFF  \n\n \n#define NT35510_P0_DOPCTR 0xB1\n#define NT35510_P0_SDHDTCTR 0xB6\n#define NT35510_P0_GSEQCTR 0xB7\n#define NT35510_P0_SDEQCTR 0xB8\n#define NT35510_P0_SDVPCTR 0xBA\n#define NT35510_P0_DPFRCTR1 0xBD\n#define NT35510_P0_DPFRCTR2 0xBE\n#define NT35510_P0_DPFRCTR3 0xBF\n#define NT35510_P0_DPMCTR12 0xCC\n\n#define NT35510_P0_DOPCTR_LEN 2\n#define NT35510_P0_GSEQCTR_LEN 2\n#define NT35510_P0_SDEQCTR_LEN 4\n#define NT35510_P0_SDVPCTR_LEN 1\n#define NT35510_P0_DPFRCTR1_LEN 5\n#define NT35510_P0_DPFRCTR2_LEN 5\n#define NT35510_P0_DPFRCTR3_LEN 5\n#define NT35510_P0_DPMCTR12_LEN 3\n\n#define NT35510_DOPCTR_0_RAMKP BIT(7)  \n#define NT35510_DOPCTR_0_DSITE BIT(6)  \n#define NT35510_DOPCTR_0_DSIG BIT(5)  \n#define NT35510_DOPCTR_0_DSIM BIT(4)  \n#define NT35510_DOPCTR_0_EOTP BIT(3)  \n#define NT35510_DOPCTR_0_N565 BIT(2)  \n#define NT35510_DOPCTR_1_TW_PWR_SEL BIT(4)  \n#define NT35510_DOPCTR_1_CRGB BIT(3)  \n#define NT35510_DOPCTR_1_CTB BIT(2)  \n#define NT35510_DOPCTR_1_CRL BIT(1)  \n#define NT35510_P0_SDVPCTR_PRG BIT(2)  \n#define NT35510_P0_SDVPCTR_AVDD 0  \n#define NT35510_P0_SDVPCTR_OFFCOL 1  \n#define NT35510_P0_SDVPCTR_AVSS 2  \n#define NT35510_P0_SDVPCTR_HI_Z 3  \n\n \n#define NT35510_P1_SETAVDD 0xB0\n#define NT35510_P1_SETAVEE 0xB1\n#define NT35510_P1_SETVCL 0xB2\n#define NT35510_P1_SETVGH 0xB3\n#define NT35510_P1_SETVRGH 0xB4\n#define NT35510_P1_SETVGL 0xB5\n#define NT35510_P1_BT1CTR 0xB6\n#define NT35510_P1_BT2CTR 0xB7\n#define NT35510_P1_BT3CTR 0xB8\n#define NT35510_P1_BT4CTR 0xB9  \n#define NT35510_P1_BT5CTR 0xBA\n#define NT35510_P1_PFMCTR 0xBB\n#define NT35510_P1_SETVGP 0xBC\n#define NT35510_P1_SETVGN 0xBD\n#define NT35510_P1_SETVCMOFF 0xBE\n#define NT35510_P1_VGHCTR 0xBF  \n#define NT35510_P1_SET_GAMMA_RED_POS 0xD1\n#define NT35510_P1_SET_GAMMA_GREEN_POS 0xD2\n#define NT35510_P1_SET_GAMMA_BLUE_POS 0xD3\n#define NT35510_P1_SET_GAMMA_RED_NEG 0xD4\n#define NT35510_P1_SET_GAMMA_GREEN_NEG 0xD5\n#define NT35510_P1_SET_GAMMA_BLUE_NEG 0xD6\n\n \n#define NT35510_P1_AVDD_LEN 3\n#define NT35510_P1_AVEE_LEN 3\n#define NT35510_P1_VGH_LEN 3\n#define NT35510_P1_VGL_LEN 3\n#define NT35510_P1_VGP_LEN 3\n#define NT35510_P1_VGN_LEN 3\n \n#define NT35510_P1_BT1CTR_LEN 3\n#define NT35510_P1_BT2CTR_LEN 3\n#define NT35510_P1_BT4CTR_LEN 3\n#define NT35510_P1_BT5CTR_LEN 3\n \n#define NT35510_P1_GAMMA_LEN 52\n\n \nstruct nt35510_config {\n\t \n\tu32 width_mm;\n\t \n\tu32 height_mm;\n\t \n\tconst struct drm_display_mode mode;\n\t \n\tu8 avdd[NT35510_P1_AVDD_LEN];\n\t \n\tu8 bt1ctr[NT35510_P1_BT1CTR_LEN];\n\t \n\tu8 avee[NT35510_P1_AVEE_LEN];\n\t \n\tu8 bt2ctr[NT35510_P1_BT2CTR_LEN];\n\t \n\tu8 vgh[NT35510_P1_VGH_LEN];\n\t \n\tu8 bt4ctr[NT35510_P1_BT4CTR_LEN];\n\t \n\tu8 vgl[NT35510_P1_VGL_LEN];\n\t \n\tu8 bt5ctr[NT35510_P1_BT5CTR_LEN];\n\t \n\tu8 vgp[NT35510_P1_VGP_LEN];\n\t \n\tu8 vgn[NT35510_P1_VGN_LEN];\n\t \n\tu8 sdeqctr[NT35510_P0_SDEQCTR_LEN];\n\t \n\tu8 sdvpctr;\n\t \n\tu16 t1;\n\t \n\tu8 vbp;\n\t \n\tu8 vfp;\n\t \n\tu8 psel;\n\t \n\tu8 dpmctr12[NT35510_P0_DPMCTR12_LEN];\n\t \n\tu8 gamma_corr_pos_r[NT35510_P1_GAMMA_LEN];\n\t \n\tu8 gamma_corr_pos_g[NT35510_P1_GAMMA_LEN];\n\t \n\tu8 gamma_corr_pos_b[NT35510_P1_GAMMA_LEN];\n\t \n\tu8 gamma_corr_neg_r[NT35510_P1_GAMMA_LEN];\n\t \n\tu8 gamma_corr_neg_g[NT35510_P1_GAMMA_LEN];\n\t \n\tu8 gamma_corr_neg_b[NT35510_P1_GAMMA_LEN];\n};\n\n \nstruct nt35510 {\n\t \n\tstruct device *dev;\n\t \n\tconst struct nt35510_config *conf;\n\t \n\tstruct drm_panel panel;\n\t \n\tstruct regulator_bulk_data supplies[2];\n\t \n\tstruct gpio_desc *reset_gpio;\n};\n\n \nstatic const u8 nt35510_mauc_mtp_read_param[] = { 0xAA, 0x55, 0x25, 0x01 };\nstatic const u8 nt35510_mauc_mtp_read_setting[] = { 0x01, 0x02, 0x00, 0x20,\n\t\t\t\t\t\t    0x33, 0x13, 0x00, 0x40,\n\t\t\t\t\t\t    0x00, 0x00, 0x23, 0x02 };\nstatic const u8 nt35510_mauc_select_page_0[] = { 0x55, 0xAA, 0x52, 0x08, 0x00 };\nstatic const u8 nt35510_mauc_select_page_1[] = { 0x55, 0xAA, 0x52, 0x08, 0x01 };\nstatic const u8 nt35510_vgh_on[] = { 0x01 };\n\nstatic inline struct nt35510 *panel_to_nt35510(struct drm_panel *panel)\n{\n\treturn container_of(panel, struct nt35510, panel);\n}\n\n#define NT35510_ROTATE_0_SETTING\t0x02\n#define NT35510_ROTATE_180_SETTING\t0x00\n\nstatic int nt35510_send_long(struct nt35510 *nt, struct mipi_dsi_device *dsi,\n\t\t\t     u8 cmd, u8 cmdlen, const u8 *seq)\n{\n\tconst u8 *seqp = seq;\n\tint cmdwritten = 0;\n\tint chunk = cmdlen;\n\tint ret;\n\n\tif (chunk > 15)\n\t\tchunk = 15;\n\tret = mipi_dsi_dcs_write(dsi, cmd, seqp, chunk);\n\tif (ret < 0) {\n\t\tdev_err(nt->dev, \"error sending DCS command seq cmd %02x\\n\", cmd);\n\t\treturn ret;\n\t}\n\tcmdwritten += chunk;\n\tseqp += chunk;\n\n\twhile (cmdwritten < cmdlen) {\n\t\tchunk = cmdlen - cmdwritten;\n\t\tif (chunk > 15)\n\t\t\tchunk = 15;\n\t\tret = mipi_dsi_generic_write(dsi, seqp, chunk);\n\t\tif (ret < 0) {\n\t\t\tdev_err(nt->dev, \"error sending generic write seq %02x\\n\", cmd);\n\t\t\treturn ret;\n\t\t}\n\t\tcmdwritten += chunk;\n\t\tseqp += chunk;\n\t}\n\tdev_dbg(nt->dev, \"sent command %02x %02x bytes\\n\", cmd, cmdlen);\n\treturn 0;\n}\n\nstatic int nt35510_read_id(struct nt35510 *nt)\n{\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(nt->dev);\n\tu8 id1, id2, id3;\n\tint ret;\n\n\tret = mipi_dsi_dcs_read(dsi, MCS_CMD_READ_ID1, &id1, 1);\n\tif (ret < 0) {\n\t\tdev_err(nt->dev, \"could not read MTP ID1\\n\");\n\t\treturn ret;\n\t}\n\tret = mipi_dsi_dcs_read(dsi, MCS_CMD_READ_ID2, &id2, 1);\n\tif (ret < 0) {\n\t\tdev_err(nt->dev, \"could not read MTP ID2\\n\");\n\t\treturn ret;\n\t}\n\tret = mipi_dsi_dcs_read(dsi, MCS_CMD_READ_ID3, &id3, 1);\n\tif (ret < 0) {\n\t\tdev_err(nt->dev, \"could not read MTP ID3\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tdev_info(nt->dev, \"MTP ID manufacturer: %02x version: %02x driver: %02x\\n\", id1, id2, id3);\n\n\treturn 0;\n}\n\n \nstatic int nt35510_setup_power(struct nt35510 *nt)\n{\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(nt->dev);\n\tint ret;\n\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SETAVDD,\n\t\t\t\tNT35510_P1_AVDD_LEN,\n\t\t\t\tnt->conf->avdd);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_BT1CTR,\n\t\t\t\tNT35510_P1_BT1CTR_LEN,\n\t\t\t\tnt->conf->bt1ctr);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SETAVEE,\n\t\t\t\tNT35510_P1_AVEE_LEN,\n\t\t\t\tnt->conf->avee);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_BT2CTR,\n\t\t\t\tNT35510_P1_BT2CTR_LEN,\n\t\t\t\tnt->conf->bt2ctr);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SETVGH,\n\t\t\t\tNT35510_P1_VGH_LEN,\n\t\t\t\tnt->conf->vgh);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_BT4CTR,\n\t\t\t\tNT35510_P1_BT4CTR_LEN,\n\t\t\t\tnt->conf->bt4ctr);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_VGHCTR,\n\t\t\t\tARRAY_SIZE(nt35510_vgh_on),\n\t\t\t\tnt35510_vgh_on);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SETVGL,\n\t\t\t\tNT35510_P1_VGL_LEN,\n\t\t\t\tnt->conf->vgl);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_BT5CTR,\n\t\t\t\tNT35510_P1_BT5CTR_LEN,\n\t\t\t\tnt->conf->bt5ctr);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SETVGP,\n\t\t\t\tNT35510_P1_VGP_LEN,\n\t\t\t\tnt->conf->vgp);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SETVGN,\n\t\t\t\tNT35510_P1_VGN_LEN,\n\t\t\t\tnt->conf->vgn);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tusleep_range(10000, 20000);\n\n\treturn 0;\n}\n\n \nstatic int nt35510_setup_display(struct nt35510 *nt)\n{\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(nt->dev);\n\tconst struct nt35510_config *conf = nt->conf;\n\tu8 dopctr[NT35510_P0_DOPCTR_LEN];\n\tu8 gseqctr[NT35510_P0_GSEQCTR_LEN];\n\tu8 dpfrctr[NT35510_P0_DPFRCTR1_LEN];\n\t \n\tu8 addr_mode = NT35510_ROTATE_0_SETTING;\n\tu8 val;\n\tint ret;\n\n\t \n\tdopctr[0] = NT35510_DOPCTR_0_DSITE | NT35510_DOPCTR_0_EOTP |\n\t\tNT35510_DOPCTR_0_N565;\n\tdopctr[1] = NT35510_DOPCTR_1_CTB;\n\tret = nt35510_send_long(nt, dsi, NT35510_P0_DOPCTR,\n\t\t\t\tNT35510_P0_DOPCTR_LEN,\n\t\t\t\tdopctr);\n\tif (ret)\n\t\treturn ret;\n\n\tret = mipi_dsi_dcs_write(dsi, MIPI_DCS_SET_ADDRESS_MODE, &addr_mode,\n\t\t\t\t sizeof(addr_mode));\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tval = 0x0A;\n\tret = mipi_dsi_dcs_write(dsi, NT35510_P0_SDHDTCTR, &val,\n\t\t\t\t sizeof(val));\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tgseqctr[0] = 0x00;\n\tgseqctr[1] = 0x00;\n\tret = nt35510_send_long(nt, dsi, NT35510_P0_GSEQCTR,\n\t\t\t\tNT35510_P0_GSEQCTR_LEN,\n\t\t\t\tgseqctr);\n\tif (ret)\n\t\treturn ret;\n\n\tret = nt35510_send_long(nt, dsi, NT35510_P0_SDEQCTR,\n\t\t\t\tNT35510_P0_SDEQCTR_LEN,\n\t\t\t\tconf->sdeqctr);\n\tif (ret)\n\t\treturn ret;\n\n\tret = mipi_dsi_dcs_write(dsi, NT35510_P0_SDVPCTR,\n\t\t\t\t &conf->sdvpctr, 1);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tdpfrctr[0] = (conf->t1 >> 8) & 0xFF;\n\tdpfrctr[1] = conf->t1 & 0xFF;\n\t \n\tdpfrctr[2] = conf->vbp;\n\t \n\tdpfrctr[3] = conf->vfp;\n\tdpfrctr[4] = conf->psel;\n\tret = nt35510_send_long(nt, dsi, NT35510_P0_DPFRCTR1,\n\t\t\t\tNT35510_P0_DPFRCTR1_LEN,\n\t\t\t\tdpfrctr);\n\tif (ret)\n\t\treturn ret;\n\t \n\tdpfrctr[3]--;\n\tret = nt35510_send_long(nt, dsi, NT35510_P0_DPFRCTR2,\n\t\t\t\tNT35510_P0_DPFRCTR2_LEN,\n\t\t\t\tdpfrctr);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P0_DPFRCTR3,\n\t\t\t\tNT35510_P0_DPFRCTR3_LEN,\n\t\t\t\tdpfrctr);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mipi_dsi_dcs_set_tear_on(dsi, MIPI_DSI_DCS_TEAR_MODE_VBLANK);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = nt35510_send_long(nt, dsi, NT35510_P0_DPMCTR12,\n\t\t\t\tNT35510_P0_DPMCTR12_LEN,\n\t\t\t\tconf->dpmctr12);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int nt35510_set_brightness(struct backlight_device *bl)\n{\n\tstruct nt35510 *nt = bl_get_data(bl);\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(nt->dev);\n\tu8 brightness = bl->props.brightness;\n\tint ret;\n\n\tdev_dbg(nt->dev, \"set brightness %d\\n\", brightness);\n\tret = mipi_dsi_dcs_write(dsi, MIPI_DCS_SET_DISPLAY_BRIGHTNESS,\n\t\t\t\t &brightness,\n\t\t\t\t sizeof(brightness));\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic const struct backlight_ops nt35510_bl_ops = {\n\t.update_status = nt35510_set_brightness,\n};\n\n \nstatic int nt35510_power_on(struct nt35510 *nt)\n{\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(nt->dev);\n\tint ret;\n\n\tret = regulator_bulk_enable(ARRAY_SIZE(nt->supplies), nt->supplies);\n\tif (ret < 0) {\n\t\tdev_err(nt->dev, \"unable to enable regulators\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (nt->reset_gpio) {\n\t\tgpiod_set_value(nt->reset_gpio, 1);\n\t\t \n\t\tusleep_range(20, 1000);\n\t\tgpiod_set_value(nt->reset_gpio, 0);\n\t\t \n\t\tusleep_range(120000, 140000);\n\t}\n\n\tret = nt35510_send_long(nt, dsi, MCS_CMD_MTP_READ_PARAM,\n\t\t\t\tARRAY_SIZE(nt35510_mauc_mtp_read_param),\n\t\t\t\tnt35510_mauc_mtp_read_param);\n\tif (ret)\n\t\treturn ret;\n\n\tret = nt35510_send_long(nt, dsi, MCS_CMD_MTP_READ_SETTING,\n\t\t\t\tARRAY_SIZE(nt35510_mauc_mtp_read_setting),\n\t\t\t\tnt35510_mauc_mtp_read_setting);\n\tif (ret)\n\t\treturn ret;\n\n\tnt35510_read_id(nt);\n\n\t \n\tret = nt35510_send_long(nt, dsi, MCS_CMD_MAUCCTR,\n\t\t\t\tARRAY_SIZE(nt35510_mauc_select_page_1),\n\t\t\t\tnt35510_mauc_select_page_1);\n\tif (ret)\n\t\treturn ret;\n\n\tret = nt35510_setup_power(nt);\n\tif (ret)\n\t\treturn ret;\n\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SET_GAMMA_RED_POS,\n\t\t\t\tNT35510_P1_GAMMA_LEN,\n\t\t\t\tnt->conf->gamma_corr_pos_r);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SET_GAMMA_GREEN_POS,\n\t\t\t\tNT35510_P1_GAMMA_LEN,\n\t\t\t\tnt->conf->gamma_corr_pos_g);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SET_GAMMA_BLUE_POS,\n\t\t\t\tNT35510_P1_GAMMA_LEN,\n\t\t\t\tnt->conf->gamma_corr_pos_b);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SET_GAMMA_RED_NEG,\n\t\t\t\tNT35510_P1_GAMMA_LEN,\n\t\t\t\tnt->conf->gamma_corr_neg_r);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SET_GAMMA_GREEN_NEG,\n\t\t\t\tNT35510_P1_GAMMA_LEN,\n\t\t\t\tnt->conf->gamma_corr_neg_g);\n\tif (ret)\n\t\treturn ret;\n\tret = nt35510_send_long(nt, dsi, NT35510_P1_SET_GAMMA_BLUE_NEG,\n\t\t\t\tNT35510_P1_GAMMA_LEN,\n\t\t\t\tnt->conf->gamma_corr_neg_b);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = nt35510_send_long(nt, dsi, MCS_CMD_MAUCCTR,\n\t\t\t\tARRAY_SIZE(nt35510_mauc_select_page_0),\n\t\t\t\tnt35510_mauc_select_page_0);\n\tif (ret)\n\t\treturn ret;\n\n\tret = nt35510_setup_display(nt);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int nt35510_power_off(struct nt35510 *nt)\n{\n\tint ret;\n\n\tret = regulator_bulk_disable(ARRAY_SIZE(nt->supplies), nt->supplies);\n\tif (ret)\n\t\treturn ret;\n\n\tif (nt->reset_gpio)\n\t\tgpiod_set_value(nt->reset_gpio, 1);\n\n\treturn 0;\n}\n\nstatic int nt35510_unprepare(struct drm_panel *panel)\n{\n\tstruct nt35510 *nt = panel_to_nt35510(panel);\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(nt->dev);\n\tint ret;\n\n\tret = mipi_dsi_dcs_set_display_off(dsi);\n\tif (ret) {\n\t\tdev_err(nt->dev, \"failed to turn display off (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\tusleep_range(10000, 20000);\n\n\t \n\tret = mipi_dsi_dcs_enter_sleep_mode(dsi);\n\tif (ret) {\n\t\tdev_err(nt->dev, \"failed to enter sleep mode (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tusleep_range(5000, 10000);\n\n\tret = nt35510_power_off(nt);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int nt35510_prepare(struct drm_panel *panel)\n{\n\tstruct nt35510 *nt = panel_to_nt35510(panel);\n\tstruct mipi_dsi_device *dsi = to_mipi_dsi_device(nt->dev);\n\tint ret;\n\n\tret = nt35510_power_on(nt);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mipi_dsi_dcs_exit_sleep_mode(dsi);\n\tif (ret) {\n\t\tdev_err(nt->dev, \"failed to exit sleep mode (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\t \n\tusleep_range(120000, 150000);\n\n\tret = mipi_dsi_dcs_set_display_on(dsi);\n\tif (ret) {\n\t\tdev_err(nt->dev, \"failed to turn display on (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\t \n\tusleep_range(10000, 20000);\n\n\treturn 0;\n}\n\nstatic int nt35510_get_modes(struct drm_panel *panel,\n\t\t\t     struct drm_connector *connector)\n{\n\tstruct nt35510 *nt = panel_to_nt35510(panel);\n\tstruct drm_display_mode *mode;\n\tstruct drm_display_info *info;\n\n\tinfo = &connector->display_info;\n\tinfo->width_mm = nt->conf->width_mm;\n\tinfo->height_mm = nt->conf->height_mm;\n\tmode = drm_mode_duplicate(connector->dev, &nt->conf->mode);\n\tif (!mode) {\n\t\tdev_err(panel->dev, \"bad mode or failed to add mode\\n\");\n\t\treturn -EINVAL;\n\t}\n\tdrm_mode_set_name(mode);\n\tmode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;\n\n\tmode->width_mm = nt->conf->width_mm;\n\tmode->height_mm = nt->conf->height_mm;\n\tdrm_mode_probed_add(connector, mode);\n\n\treturn 1;  \n}\n\nstatic const struct drm_panel_funcs nt35510_drm_funcs = {\n\t.unprepare = nt35510_unprepare,\n\t.prepare = nt35510_prepare,\n\t.get_modes = nt35510_get_modes,\n};\n\nstatic int nt35510_probe(struct mipi_dsi_device *dsi)\n{\n\tstruct device *dev = &dsi->dev;\n\tstruct nt35510 *nt;\n\tint ret;\n\n\tnt = devm_kzalloc(dev, sizeof(struct nt35510), GFP_KERNEL);\n\tif (!nt)\n\t\treturn -ENOMEM;\n\tmipi_dsi_set_drvdata(dsi, nt);\n\tnt->dev = dev;\n\n\tdsi->lanes = 2;\n\tdsi->format = MIPI_DSI_FMT_RGB888;\n\t \n\tdsi->hs_rate = 349440000;\n\tdsi->lp_rate = 9600000;\n\tdsi->mode_flags = MIPI_DSI_CLOCK_NON_CONTINUOUS;\n\n\t \n\tnt->conf = of_device_get_match_data(dev);\n\tif (!nt->conf) {\n\t\tdev_err(dev, \"missing device configuration\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tnt->supplies[0].supply = \"vdd\";  \n\tnt->supplies[1].supply = \"vddi\";  \n\tret = devm_regulator_bulk_get(dev, ARRAY_SIZE(nt->supplies),\n\t\t\t\t      nt->supplies);\n\tif (ret < 0)\n\t\treturn ret;\n\tret = regulator_set_voltage(nt->supplies[0].consumer,\n\t\t\t\t    2300000, 4800000);\n\tif (ret)\n\t\treturn ret;\n\tret = regulator_set_voltage(nt->supplies[1].consumer,\n\t\t\t\t    1650000, 3300000);\n\tif (ret)\n\t\treturn ret;\n\n\tnt->reset_gpio = devm_gpiod_get_optional(dev, \"reset\", GPIOD_ASIS);\n\tif (IS_ERR(nt->reset_gpio)) {\n\t\tdev_err(dev, \"error getting RESET GPIO\\n\");\n\t\treturn PTR_ERR(nt->reset_gpio);\n\t}\n\n\tdrm_panel_init(&nt->panel, dev, &nt35510_drm_funcs,\n\t\t       DRM_MODE_CONNECTOR_DSI);\n\n\t \n\tret = drm_panel_of_backlight(&nt->panel);\n\tif (ret) {\n\t\tdev_err(dev, \"error getting external backlight %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tif (!nt->panel.backlight) {\n\t\tstruct backlight_device *bl;\n\n\t\tbl = devm_backlight_device_register(dev, \"nt35510\", dev, nt,\n\t\t\t\t\t\t    &nt35510_bl_ops, NULL);\n\t\tif (IS_ERR(bl)) {\n\t\t\tdev_err(dev, \"failed to register backlight device\\n\");\n\t\t\treturn PTR_ERR(bl);\n\t\t}\n\t\tbl->props.max_brightness = 255;\n\t\tbl->props.brightness = 255;\n\t\tbl->props.power = FB_BLANK_POWERDOWN;\n\t\tnt->panel.backlight = bl;\n\t}\n\n\tdrm_panel_add(&nt->panel);\n\n\tret = mipi_dsi_attach(dsi);\n\tif (ret < 0)\n\t\tdrm_panel_remove(&nt->panel);\n\n\treturn 0;\n}\n\nstatic void nt35510_remove(struct mipi_dsi_device *dsi)\n{\n\tstruct nt35510 *nt = mipi_dsi_get_drvdata(dsi);\n\tint ret;\n\n\tmipi_dsi_detach(dsi);\n\t \n\tret = nt35510_power_off(nt);\n\tif (ret)\n\t\tdev_err(&dsi->dev, \"Failed to power off\\n\");\n\n\tdrm_panel_remove(&nt->panel);\n}\n\n \n#define NT35510_GAMMA_POS_DEFAULT 0x00, 0x01, 0x00, 0x43, 0x00, \\\n\t\t0x6B, 0x00, 0x87, 0x00, 0xA3, 0x00, 0xCE, 0x00, 0xF1, 0x01, \\\n\t\t0x27, 0x01, 0x53, 0x01, 0x98, 0x01, 0xCE, 0x02, 0x22, 0x02, \\\n\t\t0x83, 0x02, 0x78, 0x02, 0x9E, 0x02, 0xDD, 0x03, 0x00, 0x03, \\\n\t\t0x2E, 0x03, 0x54, 0x03, 0x7F, 0x03, 0x95, 0x03, 0xB3, 0x03, \\\n\t\t0xC2, 0x03, 0xE1, 0x03, 0xF1, 0x03, 0xFE\n\n#define NT35510_GAMMA_NEG_DEFAULT 0x00, 0x01, 0x00, 0x43, 0x00, \\\n\t\t0x6B, 0x00, 0x87, 0x00, 0xA3, 0x00, 0xCE, 0x00, 0xF1, 0x01, \\\n\t\t0x27, 0x01, 0x53, 0x01, 0x98, 0x01, 0xCE, 0x02, 0x22, 0x02, \\\n\t\t0x43, 0x02, 0x50, 0x02, 0x9E, 0x02, 0xDD, 0x03, 0x00, 0x03, \\\n\t\t0x2E, 0x03, 0x54, 0x03, 0x7F, 0x03, 0x95, 0x03, 0xB3, 0x03, \\\n\t\t0xC2, 0x03, 0xE1, 0x03, 0xF1, 0x03, 0xFE\n\n \nstatic const struct nt35510_config nt35510_hydis_hva40wv1 = {\n\t.width_mm = 52,\n\t.height_mm = 86,\n\t \n\t.mode = {\n\t\t \n\t\t.clock = 20000,\n\t\t.hdisplay = 480,\n\t\t.hsync_start = 480 + 2,  \n\t\t.hsync_end = 480 + 2 + 0,  \n\t\t.htotal = 480 + 2 + 0 + 5,  \n\t\t.vdisplay = 800,\n\t\t.vsync_start = 800 + 2,  \n\t\t.vsync_end = 800 + 2 + 0,  \n\t\t.vtotal = 800 + 2 + 0 + 5,  \n\t\t.flags = 0,\n\t},\n\t \n\t.avdd = { 0x09, 0x09, 0x09 },\n\t \n\t.bt1ctr = { 0x34, 0x34, 0x34 },\n\t \n\t.avee = { 0x09, 0x09, 0x09 },\n\t \n\t.bt2ctr = { 0x24, 0x24, 0x24 },\n\t \n\t.vgh = { 0x05, 0x05, 0x05 },\n\t \n\t.bt4ctr = { 0x24, 0x24, 0x24 },\n\t \n\t.vgl = { 0x0B, 0x0B, 0x0B },\n\t \n\t.bt5ctr = { 0x24, 0x24, 0x24 },\n\t \n\t.vgp = { 0x00, 0xA3, 0x00 },\n\t \n\t.vgn = { 0x00, 0xA3, 0x00 },\n\t \n\t.sdeqctr = { 0x01, 0x05, 0x05, 0x05 },\n\t \n\t.sdvpctr = 0x01,\n\t \n\t.t1 = 0x0184,\n\t \n\t.vbp = 7,\n\t \n\t.vfp = 50,\n\t \n\t.psel = 0,\n\t \n\t.dpmctr12 = { 0x03, 0x00, 0x00, },\n\t \n\t.gamma_corr_pos_r = { NT35510_GAMMA_POS_DEFAULT },\n\t.gamma_corr_pos_g = { NT35510_GAMMA_POS_DEFAULT },\n\t.gamma_corr_pos_b = { NT35510_GAMMA_POS_DEFAULT },\n\t.gamma_corr_neg_r = { NT35510_GAMMA_NEG_DEFAULT },\n\t.gamma_corr_neg_g = { NT35510_GAMMA_NEG_DEFAULT },\n\t.gamma_corr_neg_b = { NT35510_GAMMA_NEG_DEFAULT },\n};\n\nstatic const struct of_device_id nt35510_of_match[] = {\n\t{\n\t\t.compatible = \"hydis,hva40wv1\",\n\t\t.data = &nt35510_hydis_hva40wv1,\n\t},\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, nt35510_of_match);\n\nstatic struct mipi_dsi_driver nt35510_driver = {\n\t.probe = nt35510_probe,\n\t.remove = nt35510_remove,\n\t.driver = {\n\t\t.name = \"panel-novatek-nt35510\",\n\t\t.of_match_table = nt35510_of_match,\n\t},\n};\nmodule_mipi_dsi_driver(nt35510_driver);\n\nMODULE_AUTHOR(\"Linus Walleij <linus.walleij@linaro.org>\");\nMODULE_DESCRIPTION(\"NT35510-based panel driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}