{
  "module_name": "vbox_drv.c",
  "hash_id": "93d4810678daf020383a2b22e132852a687bcb0f617b35a8af568d155d83c18f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/vboxvideo/vbox_drv.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/vt_kern.h>\n\n#include <drm/drm_aperture.h>\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_drv.h>\n#include <drm/drm_fbdev_generic.h>\n#include <drm/drm_file.h>\n#include <drm/drm_ioctl.h>\n#include <drm/drm_managed.h>\n#include <drm/drm_modeset_helper.h>\n#include <drm/drm_module.h>\n\n#include \"vbox_drv.h\"\n\nstatic int vbox_modeset = -1;\n\nMODULE_PARM_DESC(modeset, \"Disable/Enable modesetting\");\nmodule_param_named(modeset, vbox_modeset, int, 0400);\n\nstatic const struct drm_driver driver;\n\nstatic const struct pci_device_id pciidlist[] = {\n\t{ PCI_DEVICE(0x80ee, 0xbeef) },\n\t{ }\n};\nMODULE_DEVICE_TABLE(pci, pciidlist);\n\nstatic int vbox_pci_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\n{\n\tstruct vbox_private *vbox;\n\tint ret = 0;\n\n\tif (!vbox_check_supported(VBE_DISPI_ID_HGSMI))\n\t\treturn -ENODEV;\n\n\tret = drm_aperture_remove_conflicting_pci_framebuffers(pdev, &driver);\n\tif (ret)\n\t\treturn ret;\n\n\tvbox = devm_drm_dev_alloc(&pdev->dev, &driver,\n\t\t\t\t  struct vbox_private, ddev);\n\tif (IS_ERR(vbox))\n\t\treturn PTR_ERR(vbox);\n\n\tpci_set_drvdata(pdev, vbox);\n\tmutex_init(&vbox->hw_mutex);\n\n\tret = pcim_enable_device(pdev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = vbox_hw_init(vbox);\n\tif (ret)\n\t\treturn ret;\n\n\tret = vbox_mm_init(vbox);\n\tif (ret)\n\t\tgoto err_hw_fini;\n\n\tret = vbox_mode_init(vbox);\n\tif (ret)\n\t\tgoto err_hw_fini;\n\n\tret = vbox_irq_init(vbox);\n\tif (ret)\n\t\tgoto err_mode_fini;\n\n\tret = drm_dev_register(&vbox->ddev, 0);\n\tif (ret)\n\t\tgoto err_irq_fini;\n\n\tdrm_fbdev_generic_setup(&vbox->ddev, 32);\n\n\treturn 0;\n\nerr_irq_fini:\n\tvbox_irq_fini(vbox);\nerr_mode_fini:\n\tvbox_mode_fini(vbox);\nerr_hw_fini:\n\tvbox_hw_fini(vbox);\n\treturn ret;\n}\n\nstatic void vbox_pci_remove(struct pci_dev *pdev)\n{\n\tstruct vbox_private *vbox = pci_get_drvdata(pdev);\n\n\tdrm_dev_unregister(&vbox->ddev);\n\tdrm_atomic_helper_shutdown(&vbox->ddev);\n\tvbox_irq_fini(vbox);\n\tvbox_mode_fini(vbox);\n\tvbox_hw_fini(vbox);\n}\n\nstatic void vbox_pci_shutdown(struct pci_dev *pdev)\n{\n\tstruct vbox_private *vbox = pci_get_drvdata(pdev);\n\n\tdrm_atomic_helper_shutdown(&vbox->ddev);\n}\n\nstatic int vbox_pm_suspend(struct device *dev)\n{\n\tstruct vbox_private *vbox = dev_get_drvdata(dev);\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n\tint error;\n\n\terror = drm_mode_config_helper_suspend(&vbox->ddev);\n\tif (error)\n\t\treturn error;\n\n\tpci_save_state(pdev);\n\tpci_disable_device(pdev);\n\tpci_set_power_state(pdev, PCI_D3hot);\n\n\treturn 0;\n}\n\nstatic int vbox_pm_resume(struct device *dev)\n{\n\tstruct vbox_private *vbox = dev_get_drvdata(dev);\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n\n\tif (pci_enable_device(pdev))\n\t\treturn -EIO;\n\n\treturn drm_mode_config_helper_resume(&vbox->ddev);\n}\n\nstatic int vbox_pm_freeze(struct device *dev)\n{\n\tstruct vbox_private *vbox = dev_get_drvdata(dev);\n\n\treturn drm_mode_config_helper_suspend(&vbox->ddev);\n}\n\nstatic int vbox_pm_thaw(struct device *dev)\n{\n\tstruct vbox_private *vbox = dev_get_drvdata(dev);\n\n\treturn drm_mode_config_helper_resume(&vbox->ddev);\n}\n\nstatic int vbox_pm_poweroff(struct device *dev)\n{\n\tstruct vbox_private *vbox = dev_get_drvdata(dev);\n\n\treturn drm_mode_config_helper_suspend(&vbox->ddev);\n}\n\nstatic const struct dev_pm_ops vbox_pm_ops = {\n\t.suspend = vbox_pm_suspend,\n\t.resume = vbox_pm_resume,\n\t.freeze = vbox_pm_freeze,\n\t.thaw = vbox_pm_thaw,\n\t.poweroff = vbox_pm_poweroff,\n\t.restore = vbox_pm_resume,\n};\n\nstatic struct pci_driver vbox_pci_driver = {\n\t.name = DRIVER_NAME,\n\t.id_table = pciidlist,\n\t.probe = vbox_pci_probe,\n\t.remove = vbox_pci_remove,\n\t.shutdown = vbox_pci_shutdown,\n\t.driver.pm = pm_sleep_ptr(&vbox_pm_ops),\n};\n\nDEFINE_DRM_GEM_FOPS(vbox_fops);\n\nstatic const struct drm_driver driver = {\n\t.driver_features =\n\t    DRIVER_MODESET | DRIVER_GEM | DRIVER_ATOMIC,\n\n\t.fops = &vbox_fops,\n\t.name = DRIVER_NAME,\n\t.desc = DRIVER_DESC,\n\t.date = DRIVER_DATE,\n\t.major = DRIVER_MAJOR,\n\t.minor = DRIVER_MINOR,\n\t.patchlevel = DRIVER_PATCHLEVEL,\n\n\tDRM_GEM_VRAM_DRIVER,\n};\n\ndrm_module_pci_driver_if_modeset(vbox_pci_driver, vbox_modeset);\n\nMODULE_AUTHOR(\"Oracle Corporation\");\nMODULE_AUTHOR(\"Hans de Goede <hdegoede@redhat.com>\");\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL and additional rights\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}