{
  "module_name": "rockchip_drm_fb.c",
  "hash_id": "aba5f44ead648938478b500cd5d4a6a7d813064bd33638b04bd2a5074346fa92",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/rockchip/rockchip_drm_fb.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n\n#include <drm/drm.h>\n#include <drm/drm_atomic.h>\n#include <drm/drm_damage_helper.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem_framebuffer_helper.h>\n#include <drm/drm_probe_helper.h>\n\n#include \"rockchip_drm_drv.h\"\n#include \"rockchip_drm_fb.h\"\n#include \"rockchip_drm_gem.h\"\n\nstatic const struct drm_framebuffer_funcs rockchip_drm_fb_funcs = {\n\t.destroy       = drm_gem_fb_destroy,\n\t.create_handle = drm_gem_fb_create_handle,\n\t.dirty\t       = drm_atomic_helper_dirtyfb,\n};\n\nstatic const struct drm_mode_config_helper_funcs rockchip_mode_config_helpers = {\n\t.atomic_commit_tail = drm_atomic_helper_commit_tail_rpm,\n};\n\nstatic struct drm_framebuffer *\nrockchip_fb_create(struct drm_device *dev, struct drm_file *file,\n\t\t   const struct drm_mode_fb_cmd2 *mode_cmd)\n{\n\tstruct drm_afbc_framebuffer *afbc_fb;\n\tconst struct drm_format_info *info;\n\tint ret;\n\n\tinfo = drm_get_format_info(dev, mode_cmd);\n\tif (!info)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tafbc_fb = kzalloc(sizeof(*afbc_fb), GFP_KERNEL);\n\tif (!afbc_fb)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tret = drm_gem_fb_init_with_funcs(dev, &afbc_fb->base, file, mode_cmd,\n\t\t\t\t\t &rockchip_drm_fb_funcs);\n\tif (ret) {\n\t\tkfree(afbc_fb);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\tif (drm_is_afbc(mode_cmd->modifier[0])) {\n\t\tint ret, i;\n\n\t\tret = drm_gem_fb_afbc_init(dev, mode_cmd, afbc_fb);\n\t\tif (ret) {\n\t\t\tstruct drm_gem_object **obj = afbc_fb->base.obj;\n\n\t\t\tfor (i = 0; i < info->num_planes; ++i)\n\t\t\t\tdrm_gem_object_put(obj[i]);\n\n\t\t\tkfree(afbc_fb);\n\t\t\treturn ERR_PTR(ret);\n\t\t}\n\t}\n\n\treturn &afbc_fb->base;\n}\n\nstatic const struct drm_mode_config_funcs rockchip_drm_mode_config_funcs = {\n\t.fb_create = rockchip_fb_create,\n\t.atomic_check = drm_atomic_helper_check,\n\t.atomic_commit = drm_atomic_helper_commit,\n};\n\nvoid rockchip_drm_mode_config_init(struct drm_device *dev)\n{\n\tdev->mode_config.min_width = 0;\n\tdev->mode_config.min_height = 0;\n\n\t \n\tdev->mode_config.max_width = 4096;\n\tdev->mode_config.max_height = 4096;\n\n\tdev->mode_config.funcs = &rockchip_drm_mode_config_funcs;\n\tdev->mode_config.helper_private = &rockchip_mode_config_helpers;\n\n\tdev->mode_config.normalize_zpos = true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}