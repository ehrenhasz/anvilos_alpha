{
  "module_name": "sdma_v4_4.c",
  "hash_id": "7cbbd4b3773b679cb2f1327422ff4c2dd2ad6d486a22c0254003caaa66ef50a6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/sdma_v4_4.c",
  "human_readable_source": " \n#include \"amdgpu.h\"\n#include \"sdma/sdma_4_4_0_offset.h\"\n#include \"sdma/sdma_4_4_0_sh_mask.h\"\n#include \"soc15.h\"\n#include \"amdgpu_ras.h\"\n\n#define SDMA1_REG_OFFSET 0x600\n#define SDMA2_REG_OFFSET 0x1cda0\n#define SDMA3_REG_OFFSET 0x1d1a0\n#define SDMA4_REG_OFFSET 0x1d5a0\n\n \nstatic uint32_t sdma_v4_4_get_reg_offset(struct amdgpu_device *adev,\n\t\t\t\t\t uint32_t instance,\n\t\t\t\t\t uint32_t offset)\n{\n\tuint32_t sdma_base = adev->reg_offset[SDMA0_HWIP][0][0];\n\n\tswitch (instance) {\n\tcase 0:\n\t\treturn (sdma_base + offset);\n\tcase 1:\n\t\treturn (sdma_base + SDMA1_REG_OFFSET + offset);\n\tcase 2:\n\t\treturn (sdma_base + SDMA2_REG_OFFSET + offset);\n\tcase 3:\n\t\treturn (sdma_base + SDMA3_REG_OFFSET + offset);\n\tcase 4:\n\t\treturn (sdma_base + SDMA4_REG_OFFSET + offset);\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic const struct soc15_ras_field_entry sdma_v4_4_ras_fields[] = {\n\t{ \"SDMA_MBANK_DATA_BUF0_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF0_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF1_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF1_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF2_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF2_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF3_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF3_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF4_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF4_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF5_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF5_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF6_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF6_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF7_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF7_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF8_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF8_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF9_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF9_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF10_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF10_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF11_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF11_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF12_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF12_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF13_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF13_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF14_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF14_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MBANK_DATA_BUF15_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER, SDMA_MBANK_DATA_BUF15_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_UCODE_BUF_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_UCODE_BUF_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_RB_CMD_BUF_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_RB_CMD_BUF_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_IB_CMD_BUF_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_IB_CMD_BUF_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_UTCL1_RD_FIFO_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_UTCL1_RD_FIFO_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_UTCL1_RDBST_FIFO_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_UTCL1_RDBST_FIFO_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_UTCL1_WR_FIFO_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_UTCL1_WR_FIFO_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_DATA_LUT_FIFO_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_DATA_LUT_FIFO_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_SPLIT_DATA_BUF_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_SPLIT_DATA_BUF_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MC_WR_ADDR_FIFO_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_MC_WR_ADDR_FIFO_SED),\n\t0, 0,\n\t},\n\t{ \"SDMA_MC_RDRET_BUF_SED\", SOC15_REG_ENTRY(SDMA0, 0, regSDMA0_EDC_COUNTER2),\n\tSOC15_REG_FIELD(SDMA0_EDC_COUNTER2, SDMA_MC_WR_ADDR_FIFO_SED),\n\t0, 0,\n\t},\n};\n\nstatic void sdma_v4_4_get_ras_error_count(struct amdgpu_device *adev,\n\t\t\t\t\t  uint32_t reg_offset,\n\t\t\t\t\t  uint32_t value,\n\t\t\t\t\t  uint32_t instance,\n\t\t\t\t\t  uint32_t *sec_count)\n{\n\tuint32_t i;\n\tuint32_t sec_cnt;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(sdma_v4_4_ras_fields); i++) {\n\t\tif (sdma_v4_4_ras_fields[i].reg_offset != reg_offset)\n\t\t\tcontinue;\n\n\t\t \n\t\tsec_cnt = (value &\n\t\t\tsdma_v4_4_ras_fields[i].sec_count_mask) >>\n\t\t\tsdma_v4_4_ras_fields[i].sec_count_shift;\n\t\tif (sec_cnt) {\n\t\t\tdev_info(adev->dev, \"Detected %s in SDMA%d, SED %d\\n\",\n\t\t\t\t sdma_v4_4_ras_fields[i].name,\n\t\t\t\t instance, sec_cnt);\n\t\t\t*sec_count += sec_cnt;\n\t\t}\n\t}\n}\n\nstatic int sdma_v4_4_query_ras_error_count_by_instance(struct amdgpu_device *adev,\n\t\t\t\t\t   uint32_t instance,\n\t\t\t\t\t   void *ras_error_status)\n{\n\tstruct ras_err_data *err_data = (struct ras_err_data *)ras_error_status;\n\tuint32_t sec_count = 0;\n\tuint32_t reg_value = 0;\n\tuint32_t reg_offset = 0;\n\n\treg_offset = sdma_v4_4_get_reg_offset(adev, instance, regSDMA0_EDC_COUNTER);\n\treg_value = RREG32(reg_offset);\n\t \n\tif (reg_value)\n\t\tsdma_v4_4_get_ras_error_count(adev, regSDMA0_EDC_COUNTER, reg_value,\n\t\t\t\t\t      instance, &sec_count);\n\n\treg_offset = sdma_v4_4_get_reg_offset(adev, instance, regSDMA0_EDC_COUNTER2);\n\treg_value = RREG32(reg_offset);\n\t \n\tif (reg_value)\n\t\tsdma_v4_4_get_ras_error_count(adev, regSDMA0_EDC_COUNTER2, reg_value,\n\t\t\t\t\t      instance, &sec_count);\n\n\t \n\terr_data->ue_count += sec_count;\n\n\t \n\terr_data->ce_count = 0;\n\n\treturn 0;\n};\n\nstatic void sdma_v4_4_reset_ras_error_count(struct amdgpu_device *adev)\n{\n\tint i;\n\tuint32_t reg_offset;\n\n\t \n\tif (amdgpu_ras_is_supported(adev, AMDGPU_RAS_BLOCK__SDMA)) {\n\t\tfor (i = 0; i < adev->sdma.num_instances; i++) {\n\t\t\treg_offset = sdma_v4_4_get_reg_offset(adev, i, regSDMA0_EDC_COUNTER);\n\t\t\tWREG32(reg_offset, 0);\n\t\t\treg_offset = sdma_v4_4_get_reg_offset(adev, i, regSDMA0_EDC_COUNTER2);\n\t\t\tWREG32(reg_offset, 0);\n\t\t}\n\t}\n}\n\nstatic void sdma_v4_4_query_ras_error_count(struct amdgpu_device *adev,  void *ras_error_status)\n{\n\tint i = 0;\n\n\tfor (i = 0; i < adev->sdma.num_instances; i++) {\n\t\tif (sdma_v4_4_query_ras_error_count_by_instance(adev, i, ras_error_status)) {\n\t\t\tdev_err(adev->dev, \"Query ras error count failed in SDMA%d\\n\", i);\n\t\t\treturn;\n\t\t}\n\t}\n\n}\n\nconst struct amdgpu_ras_block_hw_ops sdma_v4_4_ras_hw_ops = {\n\t.query_ras_error_count = sdma_v4_4_query_ras_error_count,\n\t.reset_ras_error_count = sdma_v4_4_reset_ras_error_count,\n};\n\nstruct amdgpu_sdma_ras sdma_v4_4_ras = {\n\t.ras_block = {\n\t\t.hw_ops = &sdma_v4_4_ras_hw_ops,\n\t},\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}