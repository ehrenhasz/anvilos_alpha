{
  "module_name": "amdgpu_ring.h",
  "hash_id": "fbd39c96e0b767a281d4b207ccd550237da6b0386b1df1894dc9388fb7e94916",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/amdgpu_ring.h",
  "human_readable_source": " \n#ifndef __AMDGPU_RING_H__\n#define __AMDGPU_RING_H__\n\n#include <drm/amdgpu_drm.h>\n#include <drm/gpu_scheduler.h>\n#include <drm/drm_print.h>\n#include <drm/drm_suballoc.h>\n\nstruct amdgpu_device;\nstruct amdgpu_ring;\nstruct amdgpu_ib;\nstruct amdgpu_cs_parser;\nstruct amdgpu_job;\nstruct amdgpu_vm;\n\n \n#define AMDGPU_MAX_RINGS\t\t124\n#define AMDGPU_MAX_HWIP_RINGS\t\t64\n#define AMDGPU_MAX_GFX_RINGS\t\t2\n#define AMDGPU_MAX_SW_GFX_RINGS         2\n#define AMDGPU_MAX_COMPUTE_RINGS\t8\n#define AMDGPU_MAX_VCE_RINGS\t\t3\n#define AMDGPU_MAX_UVD_ENC_RINGS\t2\n\nenum amdgpu_ring_priority_level {\n\tAMDGPU_RING_PRIO_0,\n\tAMDGPU_RING_PRIO_1,\n\tAMDGPU_RING_PRIO_DEFAULT = 1,\n\tAMDGPU_RING_PRIO_2,\n\tAMDGPU_RING_PRIO_MAX\n};\n\n \n#define AMDGPU_FENCE_OWNER_UNDEFINED\t((void *)0ul)\n#define AMDGPU_FENCE_OWNER_VM\t\t((void *)1ul)\n#define AMDGPU_FENCE_OWNER_KFD\t\t((void *)2ul)\n\n#define AMDGPU_FENCE_FLAG_64BIT         (1 << 0)\n#define AMDGPU_FENCE_FLAG_INT           (1 << 1)\n#define AMDGPU_FENCE_FLAG_TC_WB_ONLY    (1 << 2)\n#define AMDGPU_FENCE_FLAG_EXEC          (1 << 3)\n\n#define to_amdgpu_ring(s) container_of((s), struct amdgpu_ring, sched)\n\n#define AMDGPU_IB_POOL_SIZE\t(1024 * 1024)\n\nenum amdgpu_ring_type {\n\tAMDGPU_RING_TYPE_GFX\t\t= AMDGPU_HW_IP_GFX,\n\tAMDGPU_RING_TYPE_COMPUTE\t= AMDGPU_HW_IP_COMPUTE,\n\tAMDGPU_RING_TYPE_SDMA\t\t= AMDGPU_HW_IP_DMA,\n\tAMDGPU_RING_TYPE_UVD\t\t= AMDGPU_HW_IP_UVD,\n\tAMDGPU_RING_TYPE_VCE\t\t= AMDGPU_HW_IP_VCE,\n\tAMDGPU_RING_TYPE_UVD_ENC\t= AMDGPU_HW_IP_UVD_ENC,\n\tAMDGPU_RING_TYPE_VCN_DEC\t= AMDGPU_HW_IP_VCN_DEC,\n\tAMDGPU_RING_TYPE_VCN_ENC\t= AMDGPU_HW_IP_VCN_ENC,\n\tAMDGPU_RING_TYPE_VCN_JPEG\t= AMDGPU_HW_IP_VCN_JPEG,\n\tAMDGPU_RING_TYPE_KIQ,\n\tAMDGPU_RING_TYPE_MES\n};\n\nenum amdgpu_ib_pool_type {\n\t \n\tAMDGPU_IB_POOL_DELAYED,\n\t \n\tAMDGPU_IB_POOL_IMMEDIATE,\n\t \n\tAMDGPU_IB_POOL_DIRECT,\n\n\tAMDGPU_IB_POOL_MAX\n};\n\nstruct amdgpu_ib {\n\tstruct drm_suballoc\t\t*sa_bo;\n\tuint32_t\t\t\tlength_dw;\n\tuint64_t\t\t\tgpu_addr;\n\tuint32_t\t\t\t*ptr;\n\tuint32_t\t\t\tflags;\n};\n\nstruct amdgpu_sched {\n\tu32\t\t\t\tnum_scheds;\n\tstruct drm_gpu_scheduler\t*sched[AMDGPU_MAX_HWIP_RINGS];\n};\n\n \nstruct amdgpu_fence_driver {\n\tuint64_t\t\t\tgpu_addr;\n\tvolatile uint32_t\t\t*cpu_addr;\n\t \n\tuint32_t\t\t\tsync_seq;\n\tatomic_t\t\t\tlast_seq;\n\tbool\t\t\t\tinitialized;\n\tstruct amdgpu_irq_src\t\t*irq_src;\n\tunsigned\t\t\tirq_type;\n\tstruct timer_list\t\tfallback_timer;\n\tunsigned\t\t\tnum_fences_mask;\n\tspinlock_t\t\t\tlock;\n\tstruct dma_fence\t\t**fences;\n};\n\nextern const struct drm_sched_backend_ops amdgpu_sched_ops;\n\nvoid amdgpu_fence_driver_clear_job_fences(struct amdgpu_ring *ring);\nvoid amdgpu_fence_driver_set_error(struct amdgpu_ring *ring, int error);\nvoid amdgpu_fence_driver_force_completion(struct amdgpu_ring *ring);\n\nint amdgpu_fence_driver_init_ring(struct amdgpu_ring *ring);\nint amdgpu_fence_driver_start_ring(struct amdgpu_ring *ring,\n\t\t\t\t   struct amdgpu_irq_src *irq_src,\n\t\t\t\t   unsigned irq_type);\nvoid amdgpu_fence_driver_hw_init(struct amdgpu_device *adev);\nvoid amdgpu_fence_driver_hw_fini(struct amdgpu_device *adev);\nint amdgpu_fence_driver_sw_init(struct amdgpu_device *adev);\nvoid amdgpu_fence_driver_sw_fini(struct amdgpu_device *adev);\nint amdgpu_fence_emit(struct amdgpu_ring *ring, struct dma_fence **fence, struct amdgpu_job *job,\n\t\t      unsigned flags);\nint amdgpu_fence_emit_polling(struct amdgpu_ring *ring, uint32_t *s,\n\t\t\t      uint32_t timeout);\nbool amdgpu_fence_process(struct amdgpu_ring *ring);\nint amdgpu_fence_wait_empty(struct amdgpu_ring *ring);\nsigned long amdgpu_fence_wait_polling(struct amdgpu_ring *ring,\n\t\t\t\t      uint32_t wait_seq,\n\t\t\t\t      signed long timeout);\nunsigned amdgpu_fence_count_emitted(struct amdgpu_ring *ring);\n\nvoid amdgpu_fence_driver_isr_toggle(struct amdgpu_device *adev, bool stop);\n\nu64 amdgpu_fence_last_unsignaled_time_us(struct amdgpu_ring *ring);\nvoid amdgpu_fence_update_start_timestamp(struct amdgpu_ring *ring, uint32_t seq,\n\t\t\t\t\t ktime_t timestamp);\n\n \n\n \nstruct amdgpu_ring_funcs {\n\tenum amdgpu_ring_type\ttype;\n\tuint32_t\t\talign_mask;\n\tu32\t\t\tnop;\n\tbool\t\t\tsupport_64bit_ptrs;\n\tbool\t\t\tno_user_fence;\n\tbool\t\t\tsecure_submission_supported;\n\tunsigned\t\textra_dw;\n\n\t \n\tu64 (*get_rptr)(struct amdgpu_ring *ring);\n\tu64 (*get_wptr)(struct amdgpu_ring *ring);\n\tvoid (*set_wptr)(struct amdgpu_ring *ring);\n\t \n\tint (*parse_cs)(struct amdgpu_cs_parser *p,\n\t\t\tstruct amdgpu_job *job,\n\t\t\tstruct amdgpu_ib *ib);\n\tint (*patch_cs_in_place)(struct amdgpu_cs_parser *p,\n\t\t\t\t struct amdgpu_job *job,\n\t\t\t\t struct amdgpu_ib *ib);\n\t \n\tunsigned emit_frame_size;\n\tunsigned emit_ib_size;\n\t \n\tvoid (*emit_ib)(struct amdgpu_ring *ring,\n\t\t\tstruct amdgpu_job *job,\n\t\t\tstruct amdgpu_ib *ib,\n\t\t\tuint32_t flags);\n\tvoid (*emit_fence)(struct amdgpu_ring *ring, uint64_t addr,\n\t\t\t   uint64_t seq, unsigned flags);\n\tvoid (*emit_pipeline_sync)(struct amdgpu_ring *ring);\n\tvoid (*emit_vm_flush)(struct amdgpu_ring *ring, unsigned vmid,\n\t\t\t      uint64_t pd_addr);\n\tvoid (*emit_hdp_flush)(struct amdgpu_ring *ring);\n\tvoid (*emit_gds_switch)(struct amdgpu_ring *ring, uint32_t vmid,\n\t\t\t\tuint32_t gds_base, uint32_t gds_size,\n\t\t\t\tuint32_t gws_base, uint32_t gws_size,\n\t\t\t\tuint32_t oa_base, uint32_t oa_size);\n\t \n\tint (*test_ring)(struct amdgpu_ring *ring);\n\tint (*test_ib)(struct amdgpu_ring *ring, long timeout);\n\t \n\tvoid (*insert_nop)(struct amdgpu_ring *ring, uint32_t count);\n\tvoid (*insert_start)(struct amdgpu_ring *ring);\n\tvoid (*insert_end)(struct amdgpu_ring *ring);\n\t \n\tvoid (*pad_ib)(struct amdgpu_ring *ring, struct amdgpu_ib *ib);\n\tunsigned (*init_cond_exec)(struct amdgpu_ring *ring);\n\tvoid (*patch_cond_exec)(struct amdgpu_ring *ring, unsigned offset);\n\t \n\tvoid (*begin_use)(struct amdgpu_ring *ring);\n\tvoid (*end_use)(struct amdgpu_ring *ring);\n\tvoid (*emit_switch_buffer) (struct amdgpu_ring *ring);\n\tvoid (*emit_cntxcntl) (struct amdgpu_ring *ring, uint32_t flags);\n\tvoid (*emit_gfx_shadow)(struct amdgpu_ring *ring, u64 shadow_va, u64 csa_va,\n\t\t\t\tu64 gds_va, bool init_shadow, int vmid);\n\tvoid (*emit_rreg)(struct amdgpu_ring *ring, uint32_t reg,\n\t\t\t  uint32_t reg_val_offs);\n\tvoid (*emit_wreg)(struct amdgpu_ring *ring, uint32_t reg, uint32_t val);\n\tvoid (*emit_reg_wait)(struct amdgpu_ring *ring, uint32_t reg,\n\t\t\t      uint32_t val, uint32_t mask);\n\tvoid (*emit_reg_write_reg_wait)(struct amdgpu_ring *ring,\n\t\t\t\t\tuint32_t reg0, uint32_t reg1,\n\t\t\t\t\tuint32_t ref, uint32_t mask);\n\tvoid (*emit_frame_cntl)(struct amdgpu_ring *ring, bool start,\n\t\t\t\tbool secure);\n\t \n\tvoid (*soft_recovery)(struct amdgpu_ring *ring, unsigned vmid);\n\tint (*preempt_ib)(struct amdgpu_ring *ring);\n\tvoid (*emit_mem_sync)(struct amdgpu_ring *ring);\n\tvoid (*emit_wave_limit)(struct amdgpu_ring *ring, bool enable);\n\tvoid (*patch_cntl)(struct amdgpu_ring *ring, unsigned offset);\n\tvoid (*patch_ce)(struct amdgpu_ring *ring, unsigned offset);\n\tvoid (*patch_de)(struct amdgpu_ring *ring, unsigned offset);\n};\n\nstruct amdgpu_ring {\n\tstruct amdgpu_device\t\t*adev;\n\tconst struct amdgpu_ring_funcs\t*funcs;\n\tstruct amdgpu_fence_driver\tfence_drv;\n\tstruct drm_gpu_scheduler\tsched;\n\n\tstruct amdgpu_bo\t*ring_obj;\n\tvolatile uint32_t\t*ring;\n\tunsigned\t\trptr_offs;\n\tu64\t\t\trptr_gpu_addr;\n\tvolatile u32\t\t*rptr_cpu_addr;\n\tu64\t\t\twptr;\n\tu64\t\t\twptr_old;\n\tunsigned\t\tring_size;\n\tunsigned\t\tmax_dw;\n\tint\t\t\tcount_dw;\n\tuint64_t\t\tgpu_addr;\n\tuint64_t\t\tptr_mask;\n\tuint32_t\t\tbuf_mask;\n\tu32\t\t\tidx;\n\tu32\t\t\txcc_id;\n\tu32\t\t\txcp_id;\n\tu32\t\t\tme;\n\tu32\t\t\tpipe;\n\tu32\t\t\tqueue;\n\tstruct amdgpu_bo\t*mqd_obj;\n\tuint64_t                mqd_gpu_addr;\n\tvoid                    *mqd_ptr;\n\tunsigned                mqd_size;\n\tuint64_t                eop_gpu_addr;\n\tu32\t\t\tdoorbell_index;\n\tbool\t\t\tuse_doorbell;\n\tbool\t\t\tuse_pollmem;\n\tunsigned\t\twptr_offs;\n\tu64\t\t\twptr_gpu_addr;\n\tvolatile u32\t\t*wptr_cpu_addr;\n\tunsigned\t\tfence_offs;\n\tu64\t\t\tfence_gpu_addr;\n\tvolatile u32\t\t*fence_cpu_addr;\n\tuint64_t\t\tcurrent_ctx;\n\tchar\t\t\tname[16];\n\tu32                     trail_seq;\n\tunsigned\t\ttrail_fence_offs;\n\tu64\t\t\ttrail_fence_gpu_addr;\n\tvolatile u32\t\t*trail_fence_cpu_addr;\n\tunsigned\t\tcond_exe_offs;\n\tu64\t\t\tcond_exe_gpu_addr;\n\tvolatile u32\t\t*cond_exe_cpu_addr;\n\tunsigned\t\tvm_hub;\n\tunsigned\t\tvm_inv_eng;\n\tstruct dma_fence\t*vmid_wait;\n\tbool\t\t\thas_compute_vm_bug;\n\tbool\t\t\tno_scheduler;\n\tint\t\t\thw_prio;\n\tunsigned \t\tnum_hw_submission;\n\tatomic_t\t\t*sched_score;\n\n\t \n\tbool\t\t\tis_mes_queue;\n\tuint32_t\t\thw_queue_id;\n\tstruct amdgpu_mes_ctx_data *mes_ctx;\n\n\tbool            is_sw_ring;\n\tunsigned int    entry_index;\n\n};\n\n#define amdgpu_ring_parse_cs(r, p, job, ib) ((r)->funcs->parse_cs((p), (job), (ib)))\n#define amdgpu_ring_patch_cs_in_place(r, p, job, ib) ((r)->funcs->patch_cs_in_place((p), (job), (ib)))\n#define amdgpu_ring_test_ring(r) (r)->funcs->test_ring((r))\n#define amdgpu_ring_test_ib(r, t) ((r)->funcs->test_ib ? (r)->funcs->test_ib((r), (t)) : 0)\n#define amdgpu_ring_get_rptr(r) (r)->funcs->get_rptr((r))\n#define amdgpu_ring_get_wptr(r) (r)->funcs->get_wptr((r))\n#define amdgpu_ring_set_wptr(r) (r)->funcs->set_wptr((r))\n#define amdgpu_ring_emit_ib(r, job, ib, flags) ((r)->funcs->emit_ib((r), (job), (ib), (flags)))\n#define amdgpu_ring_emit_pipeline_sync(r) (r)->funcs->emit_pipeline_sync((r))\n#define amdgpu_ring_emit_vm_flush(r, vmid, addr) (r)->funcs->emit_vm_flush((r), (vmid), (addr))\n#define amdgpu_ring_emit_fence(r, addr, seq, flags) (r)->funcs->emit_fence((r), (addr), (seq), (flags))\n#define amdgpu_ring_emit_gds_switch(r, v, db, ds, wb, ws, ab, as) (r)->funcs->emit_gds_switch((r), (v), (db), (ds), (wb), (ws), (ab), (as))\n#define amdgpu_ring_emit_hdp_flush(r) (r)->funcs->emit_hdp_flush((r))\n#define amdgpu_ring_emit_switch_buffer(r) (r)->funcs->emit_switch_buffer((r))\n#define amdgpu_ring_emit_cntxcntl(r, d) (r)->funcs->emit_cntxcntl((r), (d))\n#define amdgpu_ring_emit_gfx_shadow(r, s, c, g, i, v) ((r)->funcs->emit_gfx_shadow((r), (s), (c), (g), (i), (v)))\n#define amdgpu_ring_emit_rreg(r, d, o) (r)->funcs->emit_rreg((r), (d), (o))\n#define amdgpu_ring_emit_wreg(r, d, v) (r)->funcs->emit_wreg((r), (d), (v))\n#define amdgpu_ring_emit_reg_wait(r, d, v, m) (r)->funcs->emit_reg_wait((r), (d), (v), (m))\n#define amdgpu_ring_emit_reg_write_reg_wait(r, d0, d1, v, m) (r)->funcs->emit_reg_write_reg_wait((r), (d0), (d1), (v), (m))\n#define amdgpu_ring_emit_frame_cntl(r, b, s) (r)->funcs->emit_frame_cntl((r), (b), (s))\n#define amdgpu_ring_pad_ib(r, ib) ((r)->funcs->pad_ib((r), (ib)))\n#define amdgpu_ring_init_cond_exec(r) (r)->funcs->init_cond_exec((r))\n#define amdgpu_ring_patch_cond_exec(r,o) (r)->funcs->patch_cond_exec((r),(o))\n#define amdgpu_ring_preempt_ib(r) (r)->funcs->preempt_ib(r)\n#define amdgpu_ring_patch_cntl(r, o) ((r)->funcs->patch_cntl((r), (o)))\n#define amdgpu_ring_patch_ce(r, o) ((r)->funcs->patch_ce((r), (o)))\n#define amdgpu_ring_patch_de(r, o) ((r)->funcs->patch_de((r), (o)))\n\nunsigned int amdgpu_ring_max_ibs(enum amdgpu_ring_type type);\nint amdgpu_ring_alloc(struct amdgpu_ring *ring, unsigned ndw);\nvoid amdgpu_ring_ib_begin(struct amdgpu_ring *ring);\nvoid amdgpu_ring_ib_end(struct amdgpu_ring *ring);\nvoid amdgpu_ring_ib_on_emit_cntl(struct amdgpu_ring *ring);\nvoid amdgpu_ring_ib_on_emit_ce(struct amdgpu_ring *ring);\nvoid amdgpu_ring_ib_on_emit_de(struct amdgpu_ring *ring);\n\nvoid amdgpu_ring_insert_nop(struct amdgpu_ring *ring, uint32_t count);\nvoid amdgpu_ring_generic_pad_ib(struct amdgpu_ring *ring, struct amdgpu_ib *ib);\nvoid amdgpu_ring_commit(struct amdgpu_ring *ring);\nvoid amdgpu_ring_undo(struct amdgpu_ring *ring);\nint amdgpu_ring_init(struct amdgpu_device *adev, struct amdgpu_ring *ring,\n\t\t     unsigned int max_dw, struct amdgpu_irq_src *irq_src,\n\t\t     unsigned int irq_type, unsigned int hw_prio,\n\t\t     atomic_t *sched_score);\nvoid amdgpu_ring_fini(struct amdgpu_ring *ring);\nvoid amdgpu_ring_emit_reg_write_reg_wait_helper(struct amdgpu_ring *ring,\n\t\t\t\t\t\tuint32_t reg0, uint32_t val0,\n\t\t\t\t\t\tuint32_t reg1, uint32_t val1);\nbool amdgpu_ring_soft_recovery(struct amdgpu_ring *ring, unsigned int vmid,\n\t\t\t       struct dma_fence *fence);\n\nstatic inline void amdgpu_ring_set_preempt_cond_exec(struct amdgpu_ring *ring,\n\t\t\t\t\t\t\tbool cond_exec)\n{\n\t*ring->cond_exe_cpu_addr = cond_exec;\n}\n\nstatic inline void amdgpu_ring_clear_ring(struct amdgpu_ring *ring)\n{\n\tint i = 0;\n\twhile (i <= ring->buf_mask)\n\t\tring->ring[i++] = ring->funcs->nop;\n\n}\n\nstatic inline void amdgpu_ring_write(struct amdgpu_ring *ring, uint32_t v)\n{\n\tif (ring->count_dw <= 0)\n\t\tDRM_ERROR(\"amdgpu: writing more dwords to the ring than expected!\\n\");\n\tring->ring[ring->wptr++ & ring->buf_mask] = v;\n\tring->wptr &= ring->ptr_mask;\n\tring->count_dw--;\n}\n\nstatic inline void amdgpu_ring_write_multiple(struct amdgpu_ring *ring,\n\t\t\t\t\t      void *src, int count_dw)\n{\n\tunsigned occupied, chunk1, chunk2;\n\tvoid *dst;\n\n\tif (unlikely(ring->count_dw < count_dw))\n\t\tDRM_ERROR(\"amdgpu: writing more dwords to the ring than expected!\\n\");\n\n\toccupied = ring->wptr & ring->buf_mask;\n\tdst = (void *)&ring->ring[occupied];\n\tchunk1 = ring->buf_mask + 1 - occupied;\n\tchunk1 = (chunk1 >= count_dw) ? count_dw : chunk1;\n\tchunk2 = count_dw - chunk1;\n\tchunk1 <<= 2;\n\tchunk2 <<= 2;\n\n\tif (chunk1)\n\t\tmemcpy(dst, src, chunk1);\n\n\tif (chunk2) {\n\t\tsrc += chunk1;\n\t\tdst = (void *)ring->ring;\n\t\tmemcpy(dst, src, chunk2);\n\t}\n\n\tring->wptr += count_dw;\n\tring->wptr &= ring->ptr_mask;\n\tring->count_dw -= count_dw;\n}\n\n#define amdgpu_mes_ctx_get_offs_gpu_addr(ring, offset)\t\t\t\\\n\t(ring->is_mes_queue && ring->mes_ctx ?\t\t\t\t\\\n\t (ring->mes_ctx->meta_data_gpu_addr + offset) : 0)\n\n#define amdgpu_mes_ctx_get_offs_cpu_addr(ring, offset)\t\t\t\\\n\t(ring->is_mes_queue && ring->mes_ctx ?\t\t\t\t\\\n\t (void *)((uint8_t *)(ring->mes_ctx->meta_data_ptr) + offset) : \\\n\t NULL)\n\nint amdgpu_ring_test_helper(struct amdgpu_ring *ring);\n\nvoid amdgpu_debugfs_ring_init(struct amdgpu_device *adev,\n\t\t\t      struct amdgpu_ring *ring);\n\nint amdgpu_ring_init_mqd(struct amdgpu_ring *ring);\n\nstatic inline u32 amdgpu_ib_get_value(struct amdgpu_ib *ib, int idx)\n{\n\treturn ib->ptr[idx];\n}\n\nstatic inline void amdgpu_ib_set_value(struct amdgpu_ib *ib, int idx,\n\t\t\t\t       uint32_t value)\n{\n\tib->ptr[idx] = value;\n}\n\nint amdgpu_ib_get(struct amdgpu_device *adev, struct amdgpu_vm *vm,\n\t\t  unsigned size,\n\t\t  enum amdgpu_ib_pool_type pool,\n\t\t  struct amdgpu_ib *ib);\nvoid amdgpu_ib_free(struct amdgpu_device *adev, struct amdgpu_ib *ib,\n\t\t    struct dma_fence *f);\nint amdgpu_ib_schedule(struct amdgpu_ring *ring, unsigned num_ibs,\n\t\t       struct amdgpu_ib *ibs, struct amdgpu_job *job,\n\t\t       struct dma_fence **f);\nint amdgpu_ib_pool_init(struct amdgpu_device *adev);\nvoid amdgpu_ib_pool_fini(struct amdgpu_device *adev);\nint amdgpu_ib_ring_tests(struct amdgpu_device *adev);\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}