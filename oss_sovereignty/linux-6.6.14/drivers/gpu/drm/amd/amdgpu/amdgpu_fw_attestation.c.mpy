{
  "module_name": "amdgpu_fw_attestation.c",
  "hash_id": "3dd0939c130cdb345205849cf296d0f0e5ee0a37f22dafb0cb1f7663acbe9c39",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/amdgpu_fw_attestation.c",
  "human_readable_source": " \n\n#include <linux/debugfs.h>\n#include <linux/firmware.h>\n#include <linux/dma-mapping.h>\n\n#include \"amdgpu.h\"\n#include \"amdgpu_fw_attestation.h\"\n#include \"amdgpu_psp.h\"\n#include \"amdgpu_ucode.h\"\n#include \"soc15_common.h\"\n\n#define FW_ATTESTATION_DB_COOKIE        0x143b6a37\n#define FW_ATTESTATION_RECORD_VALID\t1\n#define FW_ATTESTATION_MAX_SIZE\t\t4096\n\nstruct FW_ATT_DB_HEADER {\n\tuint32_t AttDbVersion;            \n\tuint32_t AttDbCookie;             \n};\n\nstruct FW_ATT_RECORD {\n\tuint16_t AttFwIdV1;               \n\tuint16_t AttFwIdV2;               \n\tuint32_t AttFWVersion;            \n\tuint16_t AttFWActiveFunctionID;   \n\tuint8_t  AttSource;               \n\tuint8_t  RecordValid;             \n\tuint32_t AttFwTaId;               \n};\n\nstatic ssize_t amdgpu_fw_attestation_debugfs_read(struct file *f,\n\t\t\t\t\t\t  char __user *buf,\n\t\t\t\t\t\t  size_t size,\n\t\t\t\t\t\t  loff_t *pos)\n{\n\tstruct amdgpu_device *adev = (struct amdgpu_device *)file_inode(f)->i_private;\n\tuint64_t records_addr = 0;\n\tuint64_t vram_pos = 0;\n\tstruct FW_ATT_DB_HEADER fw_att_hdr = {0};\n\tstruct FW_ATT_RECORD fw_att_record = {0};\n\n\tif (size < sizeof(struct FW_ATT_RECORD)) {\n\t\tDRM_WARN(\"FW attestation input buffer not enough memory\");\n\t\treturn -EINVAL;\n\t}\n\n\tif ((*pos + sizeof(struct FW_ATT_DB_HEADER)) >= FW_ATTESTATION_MAX_SIZE) {\n\t\tDRM_WARN(\"FW attestation out of bounds\");\n\t\treturn 0;\n\t}\n\n\tif (psp_get_fw_attestation_records_addr(&adev->psp, &records_addr)) {\n\t\tDRM_WARN(\"Failed to get FW attestation record address\");\n\t\treturn -EINVAL;\n\t}\n\n\tvram_pos =  records_addr - adev->gmc.vram_start;\n\n\tif (*pos == 0) {\n\t\tamdgpu_device_vram_access(adev,\n\t\t\t\t\t  vram_pos,\n\t\t\t\t\t  (uint32_t *)&fw_att_hdr,\n\t\t\t\t\t  sizeof(struct FW_ATT_DB_HEADER),\n\t\t\t\t\t  false);\n\n\t\tif (fw_att_hdr.AttDbCookie != FW_ATTESTATION_DB_COOKIE) {\n\t\t\tDRM_WARN(\"Invalid FW attestation cookie\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tDRM_INFO(\"FW attestation version = 0x%X\", fw_att_hdr.AttDbVersion);\n\t}\n\n\tamdgpu_device_vram_access(adev,\n\t\t\t\t  vram_pos + sizeof(struct FW_ATT_DB_HEADER) + *pos,\n\t\t\t\t  (uint32_t *)&fw_att_record,\n\t\t\t\t  sizeof(struct FW_ATT_RECORD),\n\t\t\t\t  false);\n\n\tif (fw_att_record.RecordValid != FW_ATTESTATION_RECORD_VALID)\n\t\treturn 0;\n\n\tif (copy_to_user(buf, (void *)&fw_att_record, sizeof(struct FW_ATT_RECORD)))\n\t\treturn -EINVAL;\n\n\t*pos += sizeof(struct FW_ATT_RECORD);\n\n\treturn sizeof(struct FW_ATT_RECORD);\n}\n\nstatic const struct file_operations amdgpu_fw_attestation_debugfs_ops = {\n\t.owner = THIS_MODULE,\n\t.read = amdgpu_fw_attestation_debugfs_read,\n\t.write = NULL,\n\t.llseek = default_llseek\n};\n\nstatic int amdgpu_is_fw_attestation_supported(struct amdgpu_device *adev)\n{\n\tif (adev->flags & AMD_IS_APU)\n\t\treturn 0;\n\n\tif (adev->asic_type >= CHIP_SIENNA_CICHLID)\n\t\treturn 1;\n\n\treturn 0;\n}\n\nvoid amdgpu_fw_attestation_debugfs_init(struct amdgpu_device *adev)\n{\n\tif (!amdgpu_is_fw_attestation_supported(adev))\n\t\treturn;\n\n\tdebugfs_create_file(\"amdgpu_fw_attestation\",\n\t\t\t    0400,\n\t\t\t    adev_to_drm(adev)->primary->debugfs_root,\n\t\t\t    adev,\n\t\t\t    &amdgpu_fw_attestation_debugfs_ops);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}