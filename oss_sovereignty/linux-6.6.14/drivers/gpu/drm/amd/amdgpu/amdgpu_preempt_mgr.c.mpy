{
  "module_name": "amdgpu_preempt_mgr.c",
  "hash_id": "f0cbed34e6e88f5c66b9b85f7b68234b390ed84c4612f9ddc34daaf2eaaaa723",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/amdgpu_preempt_mgr.c",
  "human_readable_source": "\n \n\n#include \"amdgpu.h\"\n\n \nstatic ssize_t mem_info_preempt_used_show(struct device *dev,\n\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t  char *buf)\n{\n\tstruct drm_device *ddev = dev_get_drvdata(dev);\n\tstruct amdgpu_device *adev = drm_to_adev(ddev);\n\tstruct ttm_resource_manager *man = &adev->mman.preempt_mgr;\n\n\treturn sysfs_emit(buf, \"%llu\\n\", ttm_resource_manager_usage(man));\n}\n\nstatic DEVICE_ATTR_RO(mem_info_preempt_used);\n\n \nstatic int amdgpu_preempt_mgr_new(struct ttm_resource_manager *man,\n\t\t\t\t  struct ttm_buffer_object *tbo,\n\t\t\t\t  const struct ttm_place *place,\n\t\t\t\t  struct ttm_resource **res)\n{\n\t*res = kzalloc(sizeof(**res), GFP_KERNEL);\n\tif (!*res)\n\t\treturn -ENOMEM;\n\n\tttm_resource_init(tbo, place, *res);\n\t(*res)->start = AMDGPU_BO_INVALID_OFFSET;\n\treturn 0;\n}\n\n \nstatic void amdgpu_preempt_mgr_del(struct ttm_resource_manager *man,\n\t\t\t\t   struct ttm_resource *res)\n{\n\tttm_resource_fini(man, res);\n\tkfree(res);\n}\n\nstatic const struct ttm_resource_manager_func amdgpu_preempt_mgr_func = {\n\t.alloc = amdgpu_preempt_mgr_new,\n\t.free = amdgpu_preempt_mgr_del,\n};\n\n \nint amdgpu_preempt_mgr_init(struct amdgpu_device *adev)\n{\n\tstruct ttm_resource_manager *man = &adev->mman.preempt_mgr;\n\tint ret;\n\n\tman->use_tt = true;\n\tman->func = &amdgpu_preempt_mgr_func;\n\n\tttm_resource_manager_init(man, &adev->mman.bdev, (1 << 30));\n\n\tret = device_create_file(adev->dev, &dev_attr_mem_info_preempt_used);\n\tif (ret) {\n\t\tDRM_ERROR(\"Failed to create device file mem_info_preempt_used\\n\");\n\t\treturn ret;\n\t}\n\n\tttm_set_driver_manager(&adev->mman.bdev, AMDGPU_PL_PREEMPT, man);\n\tttm_resource_manager_set_used(man, true);\n\treturn 0;\n}\n\n \nvoid amdgpu_preempt_mgr_fini(struct amdgpu_device *adev)\n{\n\tstruct ttm_resource_manager *man = &adev->mman.preempt_mgr;\n\tint ret;\n\n\tttm_resource_manager_set_used(man, false);\n\n\tret = ttm_resource_manager_evict_all(&adev->mman.bdev, man);\n\tif (ret)\n\t\treturn;\n\n\tdevice_remove_file(adev->dev, &dev_attr_mem_info_preempt_used);\n\n\tttm_resource_manager_cleanup(man);\n\tttm_set_driver_manager(&adev->mman.bdev, AMDGPU_PL_PREEMPT, NULL);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}