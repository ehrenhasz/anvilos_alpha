{
  "module_name": "amdgpu_sched.c",
  "hash_id": "72069de36c4365b2cf57d6f1e961f4d133ebb513d7f13c235f98cb75a04b97a0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/amdgpu_sched.c",
  "human_readable_source": " \n\n#include <linux/fdtable.h>\n#include <linux/file.h>\n#include <linux/pid.h>\n\n#include <drm/amdgpu_drm.h>\n\n#include \"amdgpu.h\"\n#include \"amdgpu_sched.h\"\n#include \"amdgpu_vm.h\"\n\nstatic int amdgpu_sched_process_priority_override(struct amdgpu_device *adev,\n\t\t\t\t\t\t  int fd,\n\t\t\t\t\t\t  int32_t priority)\n{\n\tstruct fd f = fdget(fd);\n\tstruct amdgpu_fpriv *fpriv;\n\tstruct amdgpu_ctx_mgr *mgr;\n\tstruct amdgpu_ctx *ctx;\n\tuint32_t id;\n\tint r;\n\n\tif (!f.file)\n\t\treturn -EINVAL;\n\n\tr = amdgpu_file_to_fpriv(f.file, &fpriv);\n\tif (r) {\n\t\tfdput(f);\n\t\treturn r;\n\t}\n\n\tmgr = &fpriv->ctx_mgr;\n\tmutex_lock(&mgr->lock);\n\tidr_for_each_entry(&mgr->ctx_handles, ctx, id)\n\t\tamdgpu_ctx_priority_override(ctx, priority);\n\tmutex_unlock(&mgr->lock);\n\n\tfdput(f);\n\treturn 0;\n}\n\nstatic int amdgpu_sched_context_priority_override(struct amdgpu_device *adev,\n\t\t\t\t\t\t  int fd,\n\t\t\t\t\t\t  unsigned ctx_id,\n\t\t\t\t\t\t  int32_t priority)\n{\n\tstruct fd f = fdget(fd);\n\tstruct amdgpu_fpriv *fpriv;\n\tstruct amdgpu_ctx *ctx;\n\tint r;\n\n\tif (!f.file)\n\t\treturn -EINVAL;\n\n\tr = amdgpu_file_to_fpriv(f.file, &fpriv);\n\tif (r) {\n\t\tfdput(f);\n\t\treturn r;\n\t}\n\n\tctx = amdgpu_ctx_get(fpriv, ctx_id);\n\n\tif (!ctx) {\n\t\tfdput(f);\n\t\treturn -EINVAL;\n\t}\n\n\tamdgpu_ctx_priority_override(ctx, priority);\n\tamdgpu_ctx_put(ctx);\n\tfdput(f);\n\n\treturn 0;\n}\n\nint amdgpu_sched_ioctl(struct drm_device *dev, void *data,\n\t\t       struct drm_file *filp)\n{\n\tunion drm_amdgpu_sched *args = data;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tint r;\n\n\t \n\tswitch (args->in.op) {\n\tcase AMDGPU_SCHED_OP_PROCESS_PRIORITY_OVERRIDE:\n\tcase AMDGPU_SCHED_OP_CONTEXT_PRIORITY_OVERRIDE:\n\t\tbreak;\n\tdefault:\n\t\tDRM_ERROR(\"Invalid sched op specified: %d\\n\", args->in.op);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!amdgpu_ctx_priority_is_valid(args->in.priority)) {\n\t\tWARN(1, \"Invalid context priority %d\\n\", args->in.priority);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (args->in.op) {\n\tcase AMDGPU_SCHED_OP_PROCESS_PRIORITY_OVERRIDE:\n\t\tr = amdgpu_sched_process_priority_override(adev,\n\t\t\t\t\t\t\t   args->in.fd,\n\t\t\t\t\t\t\t   args->in.priority);\n\t\tbreak;\n\tcase AMDGPU_SCHED_OP_CONTEXT_PRIORITY_OVERRIDE:\n\t\tr = amdgpu_sched_context_priority_override(adev,\n\t\t\t\t\t\t\t   args->in.fd,\n\t\t\t\t\t\t\t   args->in.ctx_id,\n\t\t\t\t\t\t\t   args->in.priority);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tr = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn r;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}