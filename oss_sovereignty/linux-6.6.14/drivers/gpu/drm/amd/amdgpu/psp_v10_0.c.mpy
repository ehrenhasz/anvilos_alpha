{
  "module_name": "psp_v10_0.c",
  "hash_id": "ef02c8c097bcb52fd46983c2023c941ecb12f81ae6d499cc7b4bc171859e6e29",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/psp_v10_0.c",
  "human_readable_source": " \n\n#include <linux/firmware.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n\n#include \"amdgpu.h\"\n#include \"amdgpu_psp.h\"\n#include \"amdgpu_ucode.h\"\n#include \"soc15_common.h\"\n#include \"psp_v10_0.h\"\n\n#include \"mp/mp_10_0_offset.h\"\n#include \"gc/gc_9_1_offset.h\"\n#include \"sdma0/sdma0_4_1_offset.h\"\n\nMODULE_FIRMWARE(\"amdgpu/raven_asd.bin\");\nMODULE_FIRMWARE(\"amdgpu/picasso_asd.bin\");\nMODULE_FIRMWARE(\"amdgpu/raven2_asd.bin\");\nMODULE_FIRMWARE(\"amdgpu/picasso_ta.bin\");\nMODULE_FIRMWARE(\"amdgpu/raven2_ta.bin\");\nMODULE_FIRMWARE(\"amdgpu/raven_ta.bin\");\n\nstatic int psp_v10_0_init_microcode(struct psp_context *psp)\n{\n\tstruct amdgpu_device *adev = psp->adev;\n\tchar ucode_prefix[30];\n\tint err = 0;\n\tDRM_DEBUG(\"\\n\");\n\n\tamdgpu_ucode_ip_version_decode(adev, MP0_HWIP, ucode_prefix, sizeof(ucode_prefix));\n\n\terr = psp_init_asd_microcode(psp, ucode_prefix);\n\tif (err)\n\t\treturn err;\n\n\terr = psp_init_ta_microcode(psp, ucode_prefix);\n\tif ((adev->ip_versions[GC_HWIP][0] == IP_VERSION(9, 1, 0)) &&\n\t\t(adev->pdev->revision == 0xa1) &&\n\t\t(psp->securedisplay_context.context.bin_desc.fw_version >= 0x27000008)) {\n\t\tadev->psp.securedisplay_context.context.bin_desc.size_bytes = 0;\n\t}\n\treturn err;\n}\n\nstatic int psp_v10_0_ring_create(struct psp_context *psp,\n\t\t\t\t enum psp_ring_type ring_type)\n{\n\tint ret = 0;\n\tunsigned int psp_ring_reg = 0;\n\tstruct psp_ring *ring = &psp->km_ring;\n\tstruct amdgpu_device *adev = psp->adev;\n\n\t \n\tpsp_ring_reg = lower_32_bits(ring->ring_mem_mc_addr);\n\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_69, psp_ring_reg);\n\t \n\tpsp_ring_reg = upper_32_bits(ring->ring_mem_mc_addr);\n\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_70, psp_ring_reg);\n\t \n\tpsp_ring_reg = ring->ring_size;\n\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_71, psp_ring_reg);\n\t \n\tpsp_ring_reg = ring_type;\n\tpsp_ring_reg = psp_ring_reg << 16;\n\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_64, psp_ring_reg);\n\n\t \n\tmdelay(20);\n\n\t \n\tret = psp_wait_for(psp, SOC15_REG_OFFSET(MP0, 0, mmMP0_SMN_C2PMSG_64),\n\t\t\t   0x80000000, 0x8000FFFF, false);\n\n\treturn ret;\n}\n\nstatic int psp_v10_0_ring_stop(struct psp_context *psp,\n\t\t\t       enum psp_ring_type ring_type)\n{\n\tint ret = 0;\n\tunsigned int psp_ring_reg = 0;\n\tstruct amdgpu_device *adev = psp->adev;\n\n\t \n\tpsp_ring_reg = 3 << 16;\n\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_64, psp_ring_reg);\n\n\t \n\tmdelay(20);\n\n\t \n\tret = psp_wait_for(psp, SOC15_REG_OFFSET(MP0, 0, mmMP0_SMN_C2PMSG_64),\n\t\t\t   0x80000000, 0x80000000, false);\n\n\treturn ret;\n}\n\nstatic int psp_v10_0_ring_destroy(struct psp_context *psp,\n\t\t\t\t  enum psp_ring_type ring_type)\n{\n\tint ret = 0;\n\tstruct psp_ring *ring = &psp->km_ring;\n\tstruct amdgpu_device *adev = psp->adev;\n\n\tret = psp_v10_0_ring_stop(psp, ring_type);\n\tif (ret)\n\t\tDRM_ERROR(\"Fail to stop psp ring\\n\");\n\n\tamdgpu_bo_free_kernel(&adev->firmware.rbuf,\n\t\t\t      &ring->ring_mem_mc_addr,\n\t\t\t      (void **)&ring->ring_mem);\n\n\treturn ret;\n}\n\nstatic int psp_v10_0_mode1_reset(struct psp_context *psp)\n{\n\tDRM_INFO(\"psp mode 1 reset not supported now! \\n\");\n\treturn -EINVAL;\n}\n\nstatic uint32_t psp_v10_0_ring_get_wptr(struct psp_context *psp)\n{\n\tstruct amdgpu_device *adev = psp->adev;\n\n\treturn RREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_67);\n}\n\nstatic void psp_v10_0_ring_set_wptr(struct psp_context *psp, uint32_t value)\n{\n\tstruct amdgpu_device *adev = psp->adev;\n\n\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_67, value);\n}\n\nstatic const struct psp_funcs psp_v10_0_funcs = {\n\t.init_microcode = psp_v10_0_init_microcode,\n\t.ring_create = psp_v10_0_ring_create,\n\t.ring_stop = psp_v10_0_ring_stop,\n\t.ring_destroy = psp_v10_0_ring_destroy,\n\t.mode1_reset = psp_v10_0_mode1_reset,\n\t.ring_get_wptr = psp_v10_0_ring_get_wptr,\n\t.ring_set_wptr = psp_v10_0_ring_set_wptr,\n};\n\nvoid psp_v10_0_set_psp_funcs(struct psp_context *psp)\n{\n\tpsp->funcs = &psp_v10_0_funcs;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}