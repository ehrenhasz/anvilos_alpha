{
  "module_name": "mxgpu_vi.c",
  "hash_id": "2a65130dac0412393bc43b0f2d2e4031decbd98ce566863e6649fbda62cb45ff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/mxgpu_vi.c",
  "human_readable_source": " \n\n#include \"amdgpu.h\"\n#include \"vi.h\"\n#include \"bif/bif_5_0_d.h\"\n#include \"bif/bif_5_0_sh_mask.h\"\n#include \"vid.h\"\n#include \"gca/gfx_8_0_d.h\"\n#include \"gca/gfx_8_0_sh_mask.h\"\n#include \"gmc_v8_0.h\"\n#include \"gfx_v8_0.h\"\n#include \"sdma_v3_0.h\"\n#include \"tonga_ih.h\"\n#include \"gmc/gmc_8_2_d.h\"\n#include \"gmc/gmc_8_2_sh_mask.h\"\n#include \"oss/oss_3_0_d.h\"\n#include \"oss/oss_3_0_sh_mask.h\"\n#include \"dce/dce_10_0_d.h\"\n#include \"dce/dce_10_0_sh_mask.h\"\n#include \"smu/smu_7_1_3_d.h\"\n#include \"mxgpu_vi.h\"\n\n#include \"amdgpu_reset.h\"\n\n \nstatic const u32 xgpu_fiji_mgcg_cgcg_init[] = {\n\tmmRLC_CGTT_MGCG_OVERRIDE, 0xffffffff, 0xffffffff,\n\tmmGRBM_GFX_INDEX, 0xffffffff, 0xe0000000,\n\tmmCB_CGTT_SCLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_BCI_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_CP_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_CPC_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_CPF_CLK_CTRL, 0xffffffff, 0x40000100,\n\tmmCGTT_DRM_CLK_CTRL0, 0xffffffff, 0x00600100,\n\tmmCGTT_GDS_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_IA_CLK_CTRL, 0xffffffff, 0x06000100,\n\tmmCGTT_PA_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_WD_CLK_CTRL, 0xffffffff, 0x06000100,\n\tmmCGTT_PC_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_RLC_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_SC_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_SPI_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_SQ_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_SQG_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL0, 0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL1, 0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL2, 0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL3, 0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL4, 0xffffffff, 0x00000100,\n\tmmCGTT_TCI_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_TCP_CLK_CTRL, 0xffffffff, 0x00000100,\n\tmmCGTT_VGT_CLK_CTRL, 0xffffffff, 0x06000100,\n\tmmDB_CGTT_CLK_CTRL_0, 0xffffffff, 0x00000100,\n\tmmTA_CGTT_CTRL, 0xffffffff, 0x00000100,\n\tmmTCA_CGTT_SCLK_CTRL, 0xffffffff, 0x00000100,\n\tmmTCC_CGTT_SCLK_CTRL, 0xffffffff, 0x00000100,\n\tmmTD_CGTT_CTRL, 0xffffffff, 0x00000100,\n\tmmGRBM_GFX_INDEX, 0xffffffff, 0xe0000000,\n\tmmCGTS_SM_CTRL_REG, 0xffffffff, 0x96e00200,\n\tmmCP_RB_WPTR_POLL_CNTL, 0xffffffff, 0x00900100,\n\tmmRLC_CGCG_CGLS_CTRL, 0xffffffff, 0x0020003c,\n\tmmPCIE_INDEX, 0xffffffff, 0x0140001c,\n\tmmPCIE_DATA, 0x000f0000, 0x00000000,\n\tmmSMC_IND_INDEX_4, 0xffffffff, 0xC060000C,\n\tmmSMC_IND_DATA_4, 0xc0000fff, 0x00000100,\n\tmmXDMA_CLOCK_GATING_CNTL, 0xffffffff, 0x00000100,\n\tmmXDMA_MEM_POWER_CNTL, 0x00000101, 0x00000000,\n\tmmMC_MEM_POWER_LS, 0xffffffff, 0x00000104,\n\tmmCGTT_DRM_CLK_CTRL0, 0xff000fff, 0x00000100,\n\tmmHDP_XDP_CGTT_BLK_CTRL, 0xc0000fff, 0x00000104,\n\tmmCP_MEM_SLP_CNTL, 0x00000001, 0x00000001,\n\tmmSDMA0_CLK_CTRL, 0xff000ff0, 0x00000100,\n\tmmSDMA1_CLK_CTRL, 0xff000ff0, 0x00000100,\n};\n\nstatic const u32 xgpu_fiji_golden_settings_a10[] = {\n\tmmCB_HW_CONTROL_3, 0x000001ff, 0x00000040,\n\tmmDB_DEBUG2, 0xf00fffff, 0x00000400,\n\tmmDCI_CLK_CNTL, 0x00000080, 0x00000000,\n\tmmFBC_DEBUG_COMP, 0x000000f0, 0x00000070,\n\tmmFBC_MISC, 0x1f311fff, 0x12300000,\n\tmmHDMI_CONTROL, 0x31000111, 0x00000011,\n\tmmPA_SC_ENHANCE, 0xffffffff, 0x20000001,\n\tmmPA_SC_LINE_STIPPLE_STATE, 0x0000ff0f, 0x00000000,\n\tmmSDMA0_CHICKEN_BITS, 0xfc910007, 0x00810007,\n\tmmSDMA0_GFX_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA0_RLC0_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA0_RLC1_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA1_CHICKEN_BITS, 0xfc910007, 0x00810007,\n\tmmSDMA1_GFX_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA1_RLC0_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA1_RLC1_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSQ_RANDOM_WAVE_PRI, 0x001fffff, 0x000006fd,\n\tmmTA_CNTL_AUX, 0x000f000f, 0x000b0000,\n\tmmTCC_EXE_DISABLE, 0x00000002, 0x00000002,\n\tmmTCP_ADDR_CONFIG, 0x000003ff, 0x000000ff,\n\tmmVGT_RESET_DEBUG, 0x00000004, 0x00000004,\n\tmmVM_PRT_APERTURE0_LOW_ADDR, 0x0fffffff, 0x0fffffff,\n\tmmVM_PRT_APERTURE1_LOW_ADDR, 0x0fffffff, 0x0fffffff,\n\tmmVM_PRT_APERTURE2_LOW_ADDR, 0x0fffffff, 0x0fffffff,\n\tmmVM_PRT_APERTURE3_LOW_ADDR, 0x0fffffff, 0x0fffffff,\n};\n\nstatic const u32 xgpu_fiji_golden_common_all[] = {\n\tmmGRBM_GFX_INDEX, 0xffffffff, 0xe0000000,\n\tmmPA_SC_RASTER_CONFIG, 0xffffffff, 0x3a00161a,\n\tmmPA_SC_RASTER_CONFIG_1, 0xffffffff, 0x0000002e,\n\tmmGB_ADDR_CONFIG, 0xffffffff, 0x22011003,\n\tmmSPI_RESOURCE_RESERVE_CU_0, 0xffffffff, 0x00000800,\n\tmmSPI_RESOURCE_RESERVE_CU_1, 0xffffffff, 0x00000800,\n\tmmSPI_RESOURCE_RESERVE_EN_CU_0, 0xffffffff, 0x00007FBF,\n\tmmSPI_RESOURCE_RESERVE_EN_CU_1, 0xffffffff, 0x00007FAF,\n\tmmGRBM_GFX_INDEX, 0xffffffff, 0xe0000000,\n\tmmSPI_CONFIG_CNTL_1, 0x0000000f, 0x00000009,\n};\n\nstatic const u32 xgpu_tonga_mgcg_cgcg_init[] = {\n\tmmRLC_CGTT_MGCG_OVERRIDE,   0xffffffff, 0xffffffff,\n\tmmGRBM_GFX_INDEX,           0xffffffff, 0xe0000000,\n\tmmCB_CGTT_SCLK_CTRL,        0xffffffff, 0x00000100,\n\tmmCGTT_BCI_CLK_CTRL,        0xffffffff, 0x00000100,\n\tmmCGTT_CP_CLK_CTRL,         0xffffffff, 0x00000100,\n\tmmCGTT_CPC_CLK_CTRL,        0xffffffff, 0x00000100,\n\tmmCGTT_CPF_CLK_CTRL,        0xffffffff, 0x40000100,\n\tmmCGTT_DRM_CLK_CTRL0,       0xffffffff, 0x00600100,\n\tmmCGTT_GDS_CLK_CTRL,        0xffffffff, 0x00000100,\n\tmmCGTT_IA_CLK_CTRL,         0xffffffff, 0x06000100,\n\tmmCGTT_PA_CLK_CTRL,         0xffffffff, 0x00000100,\n\tmmCGTT_WD_CLK_CTRL,         0xffffffff, 0x06000100,\n\tmmCGTT_PC_CLK_CTRL,         0xffffffff, 0x00000100,\n\tmmCGTT_RLC_CLK_CTRL,        0xffffffff, 0x00000100,\n\tmmCGTT_SC_CLK_CTRL,         0xffffffff, 0x00000100,\n\tmmCGTT_SPI_CLK_CTRL,        0xffffffff, 0x00000100,\n\tmmCGTT_SQ_CLK_CTRL,         0xffffffff, 0x00000100,\n\tmmCGTT_SQG_CLK_CTRL,        0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL0,        0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL1,        0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL2,        0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL3,        0xffffffff, 0x00000100,\n\tmmCGTT_SX_CLK_CTRL4,        0xffffffff, 0x00000100,\n\tmmCGTT_TCI_CLK_CTRL,        0xffffffff, 0x00000100,\n\tmmCGTT_TCP_CLK_CTRL,        0xffffffff, 0x00000100,\n\tmmCGTT_VGT_CLK_CTRL,        0xffffffff, 0x06000100,\n\tmmDB_CGTT_CLK_CTRL_0,       0xffffffff, 0x00000100,\n\tmmTA_CGTT_CTRL,             0xffffffff, 0x00000100,\n\tmmTCA_CGTT_SCLK_CTRL,       0xffffffff, 0x00000100,\n\tmmTCC_CGTT_SCLK_CTRL,       0xffffffff, 0x00000100,\n\tmmTD_CGTT_CTRL,             0xffffffff, 0x00000100,\n\tmmGRBM_GFX_INDEX,           0xffffffff, 0xe0000000,\n\tmmCGTS_CU0_SP0_CTRL_REG,    0xffffffff, 0x00010000,\n\tmmCGTS_CU0_LDS_SQ_CTRL_REG, 0xffffffff, 0x00030002,\n\tmmCGTS_CU0_TA_SQC_CTRL_REG, 0xffffffff, 0x00040007,\n\tmmCGTS_CU0_SP1_CTRL_REG,    0xffffffff, 0x00060005,\n\tmmCGTS_CU0_TD_TCP_CTRL_REG, 0xffffffff, 0x00090008,\n\tmmCGTS_CU1_SP0_CTRL_REG,    0xffffffff, 0x00010000,\n\tmmCGTS_CU1_LDS_SQ_CTRL_REG, 0xffffffff, 0x00030002,\n\tmmCGTS_CU1_TA_CTRL_REG,     0xffffffff, 0x00040007,\n\tmmCGTS_CU1_SP1_CTRL_REG,    0xffffffff, 0x00060005,\n\tmmCGTS_CU1_TD_TCP_CTRL_REG, 0xffffffff, 0x00090008,\n\tmmCGTS_CU2_SP0_CTRL_REG,    0xffffffff, 0x00010000,\n\tmmCGTS_CU2_LDS_SQ_CTRL_REG, 0xffffffff, 0x00030002,\n\tmmCGTS_CU2_TA_CTRL_REG,     0xffffffff, 0x00040007,\n\tmmCGTS_CU2_SP1_CTRL_REG,    0xffffffff, 0x00060005,\n\tmmCGTS_CU2_TD_TCP_CTRL_REG, 0xffffffff, 0x00090008,\n\tmmCGTS_CU3_SP0_CTRL_REG,    0xffffffff, 0x00010000,\n\tmmCGTS_CU3_LDS_SQ_CTRL_REG, 0xffffffff, 0x00030002,\n\tmmCGTS_CU3_TA_CTRL_REG,     0xffffffff, 0x00040007,\n\tmmCGTS_CU3_SP1_CTRL_REG,    0xffffffff, 0x00060005,\n\tmmCGTS_CU3_TD_TCP_CTRL_REG, 0xffffffff, 0x00090008,\n\tmmCGTS_CU4_SP0_CTRL_REG,    0xffffffff, 0x00010000,\n\tmmCGTS_CU4_LDS_SQ_CTRL_REG, 0xffffffff, 0x00030002,\n\tmmCGTS_CU4_TA_SQC_CTRL_REG, 0xffffffff, 0x00040007,\n\tmmCGTS_CU4_SP1_CTRL_REG,    0xffffffff, 0x00060005,\n\tmmCGTS_CU4_TD_TCP_CTRL_REG, 0xffffffff, 0x00090008,\n\tmmCGTS_CU5_SP0_CTRL_REG,    0xffffffff, 0x00010000,\n\tmmCGTS_CU5_LDS_SQ_CTRL_REG, 0xffffffff, 0x00030002,\n\tmmCGTS_CU5_TA_CTRL_REG,     0xffffffff, 0x00040007,\n\tmmCGTS_CU5_SP1_CTRL_REG,    0xffffffff, 0x00060005,\n\tmmCGTS_CU5_TD_TCP_CTRL_REG, 0xffffffff, 0x00090008,\n\tmmCGTS_CU6_SP0_CTRL_REG,    0xffffffff, 0x00010000,\n\tmmCGTS_CU6_LDS_SQ_CTRL_REG, 0xffffffff, 0x00030002,\n\tmmCGTS_CU6_TA_CTRL_REG,     0xffffffff, 0x00040007,\n\tmmCGTS_CU6_SP1_CTRL_REG,    0xffffffff, 0x00060005,\n\tmmCGTS_CU6_TD_TCP_CTRL_REG, 0xffffffff, 0x00090008,\n\tmmCGTS_CU7_SP0_CTRL_REG,    0xffffffff, 0x00010000,\n\tmmCGTS_CU7_LDS_SQ_CTRL_REG, 0xffffffff, 0x00030002,\n\tmmCGTS_CU7_TA_CTRL_REG,     0xffffffff, 0x00040007,\n\tmmCGTS_CU7_SP1_CTRL_REG,    0xffffffff, 0x00060005,\n\tmmCGTS_CU7_TD_TCP_CTRL_REG, 0xffffffff, 0x00090008,\n\tmmCGTS_SM_CTRL_REG,         0xffffffff, 0x96e00200,\n\tmmCP_RB_WPTR_POLL_CNTL,     0xffffffff, 0x00900100,\n\tmmRLC_CGCG_CGLS_CTRL,       0xffffffff, 0x0020003c,\n\tmmPCIE_INDEX,               0xffffffff, 0x0140001c,\n\tmmPCIE_DATA,                0x000f0000, 0x00000000,\n\tmmSMC_IND_INDEX_4,          0xffffffff, 0xC060000C,\n\tmmSMC_IND_DATA_4,           0xc0000fff, 0x00000100,\n\tmmXDMA_CLOCK_GATING_CNTL,   0xffffffff, 0x00000100,\n\tmmXDMA_MEM_POWER_CNTL,      0x00000101, 0x00000000,\n\tmmMC_MEM_POWER_LS,          0xffffffff, 0x00000104,\n\tmmCGTT_DRM_CLK_CTRL0,       0xff000fff, 0x00000100,\n\tmmHDP_XDP_CGTT_BLK_CTRL,    0xc0000fff, 0x00000104,\n\tmmCP_MEM_SLP_CNTL,          0x00000001, 0x00000001,\n\tmmSDMA0_CLK_CTRL,           0xff000ff0, 0x00000100,\n\tmmSDMA1_CLK_CTRL,           0xff000ff0, 0x00000100,\n};\n\nstatic const u32 xgpu_tonga_golden_settings_a11[] = {\n\tmmCB_HW_CONTROL, 0xfffdf3cf, 0x00007208,\n\tmmCB_HW_CONTROL_3, 0x00000040, 0x00000040,\n\tmmDB_DEBUG2, 0xf00fffff, 0x00000400,\n\tmmDCI_CLK_CNTL, 0x00000080, 0x00000000,\n\tmmFBC_DEBUG_COMP, 0x000000f0, 0x00000070,\n\tmmFBC_MISC, 0x1f311fff, 0x12300000,\n\tmmGB_GPU_ID, 0x0000000f, 0x00000000,\n\tmmHDMI_CONTROL, 0x31000111, 0x00000011,\n\tmmMC_ARB_WTM_GRPWT_RD, 0x00000003, 0x00000000,\n\tmmMC_HUB_RDREQ_DMIF_LIMIT, 0x0000007f, 0x00000028,\n\tmmMC_HUB_WDP_UMC, 0x00007fb6, 0x00000991,\n\tmmPA_SC_ENHANCE, 0xffffffff, 0x20000001,\n\tmmPA_SC_FIFO_DEPTH_CNTL, 0x000003ff, 0x000000fc,\n\tmmPA_SC_LINE_STIPPLE_STATE, 0x0000ff0f, 0x00000000,\n\tmmRLC_CGCG_CGLS_CTRL, 0x00000003, 0x0000003c,\n\tmmSDMA0_CHICKEN_BITS, 0xfc910007, 0x00810007,\n\tmmSDMA0_CLK_CTRL, 0xff000fff, 0x00000000,\n\tmmSDMA0_GFX_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA0_RLC0_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA0_RLC1_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA1_CHICKEN_BITS, 0xfc910007, 0x00810007,\n\tmmSDMA1_CLK_CTRL, 0xff000fff, 0x00000000,\n\tmmSDMA1_GFX_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA1_RLC0_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSDMA1_RLC1_IB_CNTL, 0x800f0111, 0x00000100,\n\tmmSQ_RANDOM_WAVE_PRI, 0x001fffff, 0x000006fd,\n\tmmTA_CNTL_AUX, 0x000f000f, 0x000b0000,\n\tmmTCC_CTRL, 0x00100000, 0xf31fff7f,\n\tmmTCC_EXE_DISABLE, 0x00000002, 0x00000002,\n\tmmTCP_ADDR_CONFIG, 0x000003ff, 0x000002fb,\n\tmmTCP_CHAN_STEER_HI, 0xffffffff, 0x0000543b,\n\tmmTCP_CHAN_STEER_LO, 0xffffffff, 0xa9210876,\n\tmmVGT_RESET_DEBUG, 0x00000004, 0x00000004,\n\tmmVM_PRT_APERTURE0_LOW_ADDR, 0x0fffffff, 0x0fffffff,\n\tmmVM_PRT_APERTURE1_LOW_ADDR, 0x0fffffff, 0x0fffffff,\n\tmmVM_PRT_APERTURE2_LOW_ADDR, 0x0fffffff, 0x0fffffff,\n\tmmVM_PRT_APERTURE3_LOW_ADDR, 0x0fffffff, 0x0fffffff,\n};\n\nstatic const u32 xgpu_tonga_golden_common_all[] = {\n\tmmGRBM_GFX_INDEX,               0xffffffff, 0xe0000000,\n\tmmPA_SC_RASTER_CONFIG,          0xffffffff, 0x16000012,\n\tmmPA_SC_RASTER_CONFIG_1,        0xffffffff, 0x0000002A,\n\tmmGB_ADDR_CONFIG,               0xffffffff, 0x22011002,\n\tmmSPI_RESOURCE_RESERVE_CU_0,    0xffffffff, 0x00000800,\n\tmmSPI_RESOURCE_RESERVE_CU_1,    0xffffffff, 0x00000800,\n\tmmSPI_RESOURCE_RESERVE_EN_CU_0, 0xffffffff, 0x00007FBF,\n};\n\nvoid xgpu_vi_init_golden_registers(struct amdgpu_device *adev)\n{\n\tswitch (adev->asic_type) {\n\tcase CHIP_FIJI:\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\txgpu_fiji_mgcg_cgcg_init,\n\t\t\t\t\t\t\tARRAY_SIZE(\n\t\t\t\t\t\t\t\txgpu_fiji_mgcg_cgcg_init));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\txgpu_fiji_golden_settings_a10,\n\t\t\t\t\t\t\tARRAY_SIZE(\n\t\t\t\t\t\t\t\txgpu_fiji_golden_settings_a10));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\txgpu_fiji_golden_common_all,\n\t\t\t\t\t\t\tARRAY_SIZE(\n\t\t\t\t\t\t\t\txgpu_fiji_golden_common_all));\n\t\tbreak;\n\tcase CHIP_TONGA:\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\txgpu_tonga_mgcg_cgcg_init,\n\t\t\t\t\t\t\tARRAY_SIZE(\n\t\t\t\t\t\t\t\txgpu_tonga_mgcg_cgcg_init));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\txgpu_tonga_golden_settings_a11,\n\t\t\t\t\t\t\tARRAY_SIZE(\n\t\t\t\t\t\t\t\txgpu_tonga_golden_settings_a11));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\txgpu_tonga_golden_common_all,\n\t\t\t\t\t\t\tARRAY_SIZE(\n\t\t\t\t\t\t\t\txgpu_tonga_golden_common_all));\n\t\tbreak;\n\tdefault:\n\t\tBUG_ON(\"Doesn't support chip type.\\n\");\n\t\tbreak;\n\t}\n}\n\n \nstatic void xgpu_vi_mailbox_send_ack(struct amdgpu_device *adev)\n{\n\tu32 reg;\n\tint timeout = VI_MAILBOX_TIMEDOUT;\n\tu32 mask = REG_FIELD_MASK(MAILBOX_CONTROL, RCV_MSG_VALID);\n\n\treg = RREG32_NO_KIQ(mmMAILBOX_CONTROL);\n\treg = REG_SET_FIELD(reg, MAILBOX_CONTROL, RCV_MSG_ACK, 1);\n\tWREG32_NO_KIQ(mmMAILBOX_CONTROL, reg);\n\n\t \n\treg = RREG32_NO_KIQ(mmMAILBOX_CONTROL);\n\twhile (reg & mask) {\n\t\tif (timeout <= 0) {\n\t\t\tpr_err(\"RCV_MSG_VALID is not cleared\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tmdelay(1);\n\t\ttimeout -= 1;\n\n\t\treg = RREG32_NO_KIQ(mmMAILBOX_CONTROL);\n\t}\n}\n\nstatic void xgpu_vi_mailbox_set_valid(struct amdgpu_device *adev, bool val)\n{\n\tu32 reg;\n\n\treg = RREG32_NO_KIQ(mmMAILBOX_CONTROL);\n\treg = REG_SET_FIELD(reg, MAILBOX_CONTROL,\n\t\t\t    TRN_MSG_VALID, val ? 1 : 0);\n\tWREG32_NO_KIQ(mmMAILBOX_CONTROL, reg);\n}\n\nstatic void xgpu_vi_mailbox_trans_msg(struct amdgpu_device *adev,\n\t\t\t\t      enum idh_request req)\n{\n\tu32 reg;\n\n\treg = RREG32_NO_KIQ(mmMAILBOX_MSGBUF_TRN_DW0);\n\treg = REG_SET_FIELD(reg, MAILBOX_MSGBUF_TRN_DW0,\n\t\t\t    MSGBUF_DATA, req);\n\tWREG32_NO_KIQ(mmMAILBOX_MSGBUF_TRN_DW0, reg);\n\n\txgpu_vi_mailbox_set_valid(adev, true);\n}\n\nstatic int xgpu_vi_mailbox_rcv_msg(struct amdgpu_device *adev,\n\t\t\t\t   enum idh_event event)\n{\n\tu32 reg;\n\tu32 mask = REG_FIELD_MASK(MAILBOX_CONTROL, RCV_MSG_VALID);\n\n\t \n\tif (event != IDH_FLR_NOTIFICATION_CMPL) {\n\t\treg = RREG32_NO_KIQ(mmMAILBOX_CONTROL);\n\t\tif (!(reg & mask))\n\t\t\treturn -ENOENT;\n\t}\n\n\treg = RREG32_NO_KIQ(mmMAILBOX_MSGBUF_RCV_DW0);\n\tif (reg != event)\n\t\treturn -ENOENT;\n\n\t \n\txgpu_vi_mailbox_send_ack(adev);\n\n\treturn 0;\n}\n\nstatic int xgpu_vi_poll_ack(struct amdgpu_device *adev)\n{\n\tint r = 0, timeout = VI_MAILBOX_TIMEDOUT;\n\tu32 mask = REG_FIELD_MASK(MAILBOX_CONTROL, TRN_MSG_ACK);\n\tu32 reg;\n\n\treg = RREG32_NO_KIQ(mmMAILBOX_CONTROL);\n\twhile (!(reg & mask)) {\n\t\tif (timeout <= 0) {\n\t\t\tpr_err(\"Doesn't get ack from pf.\\n\");\n\t\t\tr = -ETIME;\n\t\t\tbreak;\n\t\t}\n\t\tmdelay(5);\n\t\ttimeout -= 5;\n\n\t\treg = RREG32_NO_KIQ(mmMAILBOX_CONTROL);\n\t}\n\n\treturn r;\n}\n\nstatic int xgpu_vi_poll_msg(struct amdgpu_device *adev, enum idh_event event)\n{\n\tint r = 0, timeout = VI_MAILBOX_TIMEDOUT;\n\n\tr = xgpu_vi_mailbox_rcv_msg(adev, event);\n\twhile (r) {\n\t\tif (timeout <= 0) {\n\t\t\tpr_err(\"Doesn't get ack from pf.\\n\");\n\t\t\tr = -ETIME;\n\t\t\tbreak;\n\t\t}\n\t\tmdelay(5);\n\t\ttimeout -= 5;\n\n\t\tr = xgpu_vi_mailbox_rcv_msg(adev, event);\n\t}\n\n\treturn r;\n}\n\nstatic int xgpu_vi_send_access_requests(struct amdgpu_device *adev,\n\t\t\t\t\tenum idh_request request)\n{\n\tint r;\n\n\txgpu_vi_mailbox_trans_msg(adev, request);\n\n\t \n\tr = xgpu_vi_poll_ack(adev);\n\tif (r)\n\t\treturn r;\n\n\txgpu_vi_mailbox_set_valid(adev, false);\n\n\t \n\tif (request == IDH_REQ_GPU_INIT_ACCESS ||\n\t\trequest == IDH_REQ_GPU_FINI_ACCESS ||\n\t\trequest == IDH_REQ_GPU_RESET_ACCESS) {\n\t\tr = xgpu_vi_poll_msg(adev, IDH_READY_TO_ACCESS_GPU);\n\t\tif (r) {\n\t\t\tpr_err(\"Doesn't get ack from pf, give up\\n\");\n\t\t\treturn r;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int xgpu_vi_request_reset(struct amdgpu_device *adev)\n{\n\treturn xgpu_vi_send_access_requests(adev, IDH_REQ_GPU_RESET_ACCESS);\n}\n\nstatic int xgpu_vi_wait_reset_cmpl(struct amdgpu_device *adev)\n{\n\treturn xgpu_vi_poll_msg(adev, IDH_FLR_NOTIFICATION_CMPL);\n}\n\nstatic int xgpu_vi_request_full_gpu_access(struct amdgpu_device *adev,\n\t\t\t\t\t   bool init)\n{\n\tenum idh_request req;\n\n\treq = init ? IDH_REQ_GPU_INIT_ACCESS : IDH_REQ_GPU_FINI_ACCESS;\n\treturn xgpu_vi_send_access_requests(adev, req);\n}\n\nstatic int xgpu_vi_release_full_gpu_access(struct amdgpu_device *adev,\n\t\t\t\t\t   bool init)\n{\n\tenum idh_request req;\n\tint r = 0;\n\n\treq = init ? IDH_REL_GPU_INIT_ACCESS : IDH_REL_GPU_FINI_ACCESS;\n\tr = xgpu_vi_send_access_requests(adev, req);\n\n\treturn r;\n}\n\n \nstatic int xgpu_vi_mailbox_ack_irq(struct amdgpu_device *adev,\n\t\t\t\t   struct amdgpu_irq_src *source,\n\t\t\t\t   struct amdgpu_iv_entry *entry)\n{\n\tDRM_DEBUG(\"get ack intr and do nothing.\\n\");\n\treturn 0;\n}\n\nstatic int xgpu_vi_set_mailbox_ack_irq(struct amdgpu_device *adev,\n\t\t\t\t       struct amdgpu_irq_src *src,\n\t\t\t\t       unsigned type,\n\t\t\t\t       enum amdgpu_interrupt_state state)\n{\n\tu32 tmp = RREG32_NO_KIQ(mmMAILBOX_INT_CNTL);\n\n\ttmp = REG_SET_FIELD(tmp, MAILBOX_INT_CNTL, ACK_INT_EN,\n\t\t\t    (state == AMDGPU_IRQ_STATE_ENABLE) ? 1 : 0);\n\tWREG32_NO_KIQ(mmMAILBOX_INT_CNTL, tmp);\n\n\treturn 0;\n}\n\nstatic void xgpu_vi_mailbox_flr_work(struct work_struct *work)\n{\n\tstruct amdgpu_virt *virt = container_of(work, struct amdgpu_virt, flr_work);\n\tstruct amdgpu_device *adev = container_of(virt, struct amdgpu_device, virt);\n\n\t \n\tif (xgpu_vi_poll_msg(adev, IDH_FLR_NOTIFICATION_CMPL)) {\n\t\tpr_err(\"failed to receive FLR_CMPL\\n\");\n\t\treturn;\n\t}\n\n\t \n\tif (amdgpu_device_should_recover_gpu(adev)) {\n\t\tstruct amdgpu_reset_context reset_context;\n\t\tmemset(&reset_context, 0, sizeof(reset_context));\n\n\t\treset_context.method = AMD_RESET_METHOD_NONE;\n\t\treset_context.reset_req_dev = adev;\n\t\tclear_bit(AMDGPU_NEED_FULL_RESET, &reset_context.flags);\n\n\t\tamdgpu_device_gpu_recover(adev, NULL, &reset_context);\n\t}\n}\n\nstatic int xgpu_vi_set_mailbox_rcv_irq(struct amdgpu_device *adev,\n\t\t\t\t       struct amdgpu_irq_src *src,\n\t\t\t\t       unsigned type,\n\t\t\t\t       enum amdgpu_interrupt_state state)\n{\n\tu32 tmp = RREG32_NO_KIQ(mmMAILBOX_INT_CNTL);\n\n\ttmp = REG_SET_FIELD(tmp, MAILBOX_INT_CNTL, VALID_INT_EN,\n\t\t\t    (state == AMDGPU_IRQ_STATE_ENABLE) ? 1 : 0);\n\tWREG32_NO_KIQ(mmMAILBOX_INT_CNTL, tmp);\n\n\treturn 0;\n}\n\nstatic int xgpu_vi_mailbox_rcv_irq(struct amdgpu_device *adev,\n\t\t\t\t   struct amdgpu_irq_src *source,\n\t\t\t\t   struct amdgpu_iv_entry *entry)\n{\n\tint r;\n\n\t \n\tif (!amdgpu_gpu_recovery) {\n\t\t \n\t\tr = xgpu_vi_mailbox_rcv_msg(adev, IDH_FLR_NOTIFICATION);\n\n\t\t \n\t\tif (!r && !amdgpu_in_reset(adev))\n\t\t\tWARN_ONCE(!amdgpu_reset_domain_schedule(adev->reset_domain,\n\t\t\t\t\t\t\t\t&adev->virt.flr_work),\n\t\t\t\t  \"Failed to queue work! at %s\",\n\t\t\t\t  __func__);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct amdgpu_irq_src_funcs xgpu_vi_mailbox_ack_irq_funcs = {\n\t.set = xgpu_vi_set_mailbox_ack_irq,\n\t.process = xgpu_vi_mailbox_ack_irq,\n};\n\nstatic const struct amdgpu_irq_src_funcs xgpu_vi_mailbox_rcv_irq_funcs = {\n\t.set = xgpu_vi_set_mailbox_rcv_irq,\n\t.process = xgpu_vi_mailbox_rcv_irq,\n};\n\nvoid xgpu_vi_mailbox_set_irq_funcs(struct amdgpu_device *adev)\n{\n\tadev->virt.ack_irq.num_types = 1;\n\tadev->virt.ack_irq.funcs = &xgpu_vi_mailbox_ack_irq_funcs;\n\tadev->virt.rcv_irq.num_types = 1;\n\tadev->virt.rcv_irq.funcs = &xgpu_vi_mailbox_rcv_irq_funcs;\n}\n\nint xgpu_vi_mailbox_add_irq_id(struct amdgpu_device *adev)\n{\n\tint r;\n\n\tr = amdgpu_irq_add_id(adev, AMDGPU_IRQ_CLIENTID_LEGACY, 135, &adev->virt.rcv_irq);\n\tif (r)\n\t\treturn r;\n\n\tr = amdgpu_irq_add_id(adev, AMDGPU_IRQ_CLIENTID_LEGACY, 138, &adev->virt.ack_irq);\n\tif (r) {\n\t\tamdgpu_irq_put(adev, &adev->virt.rcv_irq, 0);\n\t\treturn r;\n\t}\n\n\treturn 0;\n}\n\nint xgpu_vi_mailbox_get_irq(struct amdgpu_device *adev)\n{\n\tint r;\n\n\tr = amdgpu_irq_get(adev, &adev->virt.rcv_irq, 0);\n\tif (r)\n\t\treturn r;\n\tr = amdgpu_irq_get(adev, &adev->virt.ack_irq, 0);\n\tif (r) {\n\t\tamdgpu_irq_put(adev, &adev->virt.rcv_irq, 0);\n\t\treturn r;\n\t}\n\n\tINIT_WORK(&adev->virt.flr_work, xgpu_vi_mailbox_flr_work);\n\n\treturn 0;\n}\n\nvoid xgpu_vi_mailbox_put_irq(struct amdgpu_device *adev)\n{\n\tamdgpu_irq_put(adev, &adev->virt.ack_irq, 0);\n\tamdgpu_irq_put(adev, &adev->virt.rcv_irq, 0);\n}\n\nconst struct amdgpu_virt_ops xgpu_vi_virt_ops = {\n\t.req_full_gpu\t\t= xgpu_vi_request_full_gpu_access,\n\t.rel_full_gpu\t\t= xgpu_vi_release_full_gpu_access,\n\t.reset_gpu\t\t= xgpu_vi_request_reset,\n\t.wait_reset             = xgpu_vi_wait_reset_cmpl,\n\t.trans_msg\t\t= NULL,  \n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}