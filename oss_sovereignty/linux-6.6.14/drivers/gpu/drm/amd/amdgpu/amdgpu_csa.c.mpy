{
  "module_name": "amdgpu_csa.c",
  "hash_id": "301d8084c1304ee40dcad8927a3464d47484358268cb9b344b5a59c16416e8d1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/amdgpu_csa.c",
  "human_readable_source": " \n\n#include <drm/drm_exec.h>\n\n#include \"amdgpu.h\"\n\nuint64_t amdgpu_csa_vaddr(struct amdgpu_device *adev)\n{\n\tuint64_t addr = adev->vm_manager.max_pfn << AMDGPU_GPU_PAGE_SHIFT;\n\n\taddr -= AMDGPU_VA_RESERVED_SIZE;\n\taddr = amdgpu_gmc_sign_extend(addr);\n\n\treturn addr;\n}\n\nint amdgpu_allocate_static_csa(struct amdgpu_device *adev, struct amdgpu_bo **bo,\n\t\t\t\tu32 domain, uint32_t size)\n{\n\tvoid *ptr;\n\n\tamdgpu_bo_create_kernel(adev, size, PAGE_SIZE,\n\t\t\t\tdomain, bo,\n\t\t\t\tNULL, &ptr);\n\tif (!*bo)\n\t\treturn -ENOMEM;\n\n\tmemset(ptr, 0, size);\n\tadev->virt.csa_cpu_addr = ptr;\n\treturn 0;\n}\n\nvoid amdgpu_free_static_csa(struct amdgpu_bo **bo)\n{\n\tamdgpu_bo_free_kernel(bo, NULL, NULL);\n}\n\n \nint amdgpu_map_static_csa(struct amdgpu_device *adev, struct amdgpu_vm *vm,\n\t\t\t  struct amdgpu_bo *bo, struct amdgpu_bo_va **bo_va,\n\t\t\t  uint64_t csa_addr, uint32_t size)\n{\n\tstruct drm_exec exec;\n\tint r;\n\n\tdrm_exec_init(&exec, DRM_EXEC_INTERRUPTIBLE_WAIT);\n\tdrm_exec_until_all_locked(&exec) {\n\t\tr = amdgpu_vm_lock_pd(vm, &exec, 0);\n\t\tif (likely(!r))\n\t\t\tr = drm_exec_lock_obj(&exec, &bo->tbo.base);\n\t\tdrm_exec_retry_on_contention(&exec);\n\t\tif (unlikely(r)) {\n\t\t\tDRM_ERROR(\"failed to reserve CSA,PD BOs: err=%d\\n\", r);\n\t\t\tgoto error;\n\t\t}\n\t}\n\n\t*bo_va = amdgpu_vm_bo_add(adev, vm, bo);\n\tif (!*bo_va) {\n\t\tr = -ENOMEM;\n\t\tgoto error;\n\t}\n\n\tr = amdgpu_vm_bo_map(adev, *bo_va, csa_addr, 0, size,\n\t\t\t     AMDGPU_PTE_READABLE | AMDGPU_PTE_WRITEABLE |\n\t\t\t     AMDGPU_PTE_EXECUTABLE);\n\n\tif (r) {\n\t\tDRM_ERROR(\"failed to do bo_map on static CSA, err=%d\\n\", r);\n\t\tamdgpu_vm_bo_del(adev, *bo_va);\n\t\tgoto error;\n\t}\n\nerror:\n\tdrm_exec_fini(&exec);\n\treturn r;\n}\n\nint amdgpu_unmap_static_csa(struct amdgpu_device *adev, struct amdgpu_vm *vm,\n\t\t\t    struct amdgpu_bo *bo, struct amdgpu_bo_va *bo_va,\n\t\t\t    uint64_t csa_addr)\n{\n\tstruct drm_exec exec;\n\tint r;\n\n\tdrm_exec_init(&exec, DRM_EXEC_INTERRUPTIBLE_WAIT);\n\tdrm_exec_until_all_locked(&exec) {\n\t\tr = amdgpu_vm_lock_pd(vm, &exec, 0);\n\t\tif (likely(!r))\n\t\t\tr = drm_exec_lock_obj(&exec, &bo->tbo.base);\n\t\tdrm_exec_retry_on_contention(&exec);\n\t\tif (unlikely(r)) {\n\t\t\tDRM_ERROR(\"failed to reserve CSA,PD BOs: err=%d\\n\", r);\n\t\t\tgoto error;\n\t\t}\n\t}\n\n\tr = amdgpu_vm_bo_unmap(adev, bo_va, csa_addr);\n\tif (r) {\n\t\tDRM_ERROR(\"failed to do bo_unmap on static CSA, err=%d\\n\", r);\n\t\tgoto error;\n\t}\n\n\tamdgpu_vm_bo_del(adev, bo_va);\n\nerror:\n\tdrm_exec_fini(&exec);\n\treturn r;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}