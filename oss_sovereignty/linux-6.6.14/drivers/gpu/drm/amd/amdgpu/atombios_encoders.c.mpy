{
  "module_name": "atombios_encoders.c",
  "hash_id": "11963e324feed8a58615460c54a0266e90654cfb8f076003835b8edeb9d40ed4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/atombios_encoders.c",
  "human_readable_source": " \n\n#include <linux/pci.h>\n\n#include <acpi/video.h>\n\n#include <drm/amdgpu_drm.h>\n#include \"amdgpu.h\"\n#include \"amdgpu_connectors.h\"\n#include \"amdgpu_display.h\"\n#include \"atom.h\"\n#include \"atombios_encoders.h\"\n#include \"atombios_dp.h\"\n#include <linux/backlight.h>\n#include \"bif/bif_4_1_d.h\"\n\nu8\namdgpu_atombios_encoder_get_backlight_level_from_reg(struct amdgpu_device *adev)\n{\n\tu8 backlight_level;\n\tu32 bios_2_scratch;\n\n\tbios_2_scratch = RREG32(mmBIOS_SCRATCH_2);\n\n\tbacklight_level = ((bios_2_scratch & ATOM_S2_CURRENT_BL_LEVEL_MASK) >>\n\t\t\t   ATOM_S2_CURRENT_BL_LEVEL_SHIFT);\n\n\treturn backlight_level;\n}\n\nvoid\namdgpu_atombios_encoder_set_backlight_level_to_reg(struct amdgpu_device *adev,\n\t\t\t\t\t    u8 backlight_level)\n{\n\tu32 bios_2_scratch;\n\n\tbios_2_scratch = RREG32(mmBIOS_SCRATCH_2);\n\n\tbios_2_scratch &= ~ATOM_S2_CURRENT_BL_LEVEL_MASK;\n\tbios_2_scratch |= ((backlight_level << ATOM_S2_CURRENT_BL_LEVEL_SHIFT) &\n\t\t\t   ATOM_S2_CURRENT_BL_LEVEL_MASK);\n\n\tWREG32(mmBIOS_SCRATCH_2, bios_2_scratch);\n}\n\nu8\namdgpu_atombios_encoder_get_backlight_level(struct amdgpu_encoder *amdgpu_encoder)\n{\n\tstruct drm_device *dev = amdgpu_encoder->base.dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\n\tif (!(adev->mode_info.firmware_flags & ATOM_BIOS_INFO_BL_CONTROLLED_BY_GPU))\n\t\treturn 0;\n\n\treturn amdgpu_atombios_encoder_get_backlight_level_from_reg(adev);\n}\n\nvoid\namdgpu_atombios_encoder_set_backlight_level(struct amdgpu_encoder *amdgpu_encoder,\n\t\t\t\t     u8 level)\n{\n\tstruct drm_encoder *encoder = &amdgpu_encoder->base;\n\tstruct drm_device *dev = amdgpu_encoder->base.dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder_atom_dig *dig;\n\n\tif (!(adev->mode_info.firmware_flags & ATOM_BIOS_INFO_BL_CONTROLLED_BY_GPU))\n\t\treturn;\n\n\tif ((amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT)) &&\n\t    amdgpu_encoder->enc_priv) {\n\t\tdig = amdgpu_encoder->enc_priv;\n\t\tdig->backlight_level = level;\n\t\tamdgpu_atombios_encoder_set_backlight_level_to_reg(adev, dig->backlight_level);\n\n\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\n\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\n\t\t\tif (dig->backlight_level == 0)\n\t\t\t\tamdgpu_atombios_encoder_setup_dig_transmitter(encoder,\n\t\t\t\t\t\t\t\t       ATOM_TRANSMITTER_ACTION_LCD_BLOFF, 0, 0);\n\t\t\telse {\n\t\t\t\tamdgpu_atombios_encoder_setup_dig_transmitter(encoder,\n\t\t\t\t\t\t\t\t       ATOM_TRANSMITTER_ACTION_BL_BRIGHTNESS_CONTROL, 0, 0);\n\t\t\t\tamdgpu_atombios_encoder_setup_dig_transmitter(encoder,\n\t\t\t\t\t\t\t\t       ATOM_TRANSMITTER_ACTION_LCD_BLON, 0, 0);\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic u8 amdgpu_atombios_encoder_backlight_level(struct backlight_device *bd)\n{\n\tu8 level;\n\n\t \n\tif (bd->props.brightness < 0)\n\t\tlevel = 0;\n\telse if (bd->props.brightness > AMDGPU_MAX_BL_LEVEL)\n\t\tlevel = AMDGPU_MAX_BL_LEVEL;\n\telse\n\t\tlevel = bd->props.brightness;\n\n\treturn level;\n}\n\nstatic int amdgpu_atombios_encoder_update_backlight_status(struct backlight_device *bd)\n{\n\tstruct amdgpu_backlight_privdata *pdata = bl_get_data(bd);\n\tstruct amdgpu_encoder *amdgpu_encoder = pdata->encoder;\n\n\tamdgpu_atombios_encoder_set_backlight_level(amdgpu_encoder,\n\t\t\t\t\t     amdgpu_atombios_encoder_backlight_level(bd));\n\n\treturn 0;\n}\n\nstatic int\namdgpu_atombios_encoder_get_backlight_brightness(struct backlight_device *bd)\n{\n\tstruct amdgpu_backlight_privdata *pdata = bl_get_data(bd);\n\tstruct amdgpu_encoder *amdgpu_encoder = pdata->encoder;\n\tstruct drm_device *dev = amdgpu_encoder->base.dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\n\treturn amdgpu_atombios_encoder_get_backlight_level_from_reg(adev);\n}\n\nstatic const struct backlight_ops amdgpu_atombios_encoder_backlight_ops = {\n\t.get_brightness = amdgpu_atombios_encoder_get_backlight_brightness,\n\t.update_status\t= amdgpu_atombios_encoder_update_backlight_status,\n};\n\nvoid amdgpu_atombios_encoder_init_backlight(struct amdgpu_encoder *amdgpu_encoder,\n\t\t\t\t     struct drm_connector *drm_connector)\n{\n\tstruct drm_device *dev = amdgpu_encoder->base.dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct backlight_device *bd;\n\tstruct backlight_properties props;\n\tstruct amdgpu_backlight_privdata *pdata;\n\tstruct amdgpu_encoder_atom_dig *dig;\n\tchar bl_name[16];\n\n\t \n\tif ((adev->pdev->subsystem_vendor == PCI_VENDOR_ID_APPLE) &&\n\t    (adev->pdev->device == 0x6741))\n\t\treturn;\n\n\tif (!amdgpu_encoder->enc_priv)\n\t\treturn;\n\n\tif (!(adev->mode_info.firmware_flags & ATOM_BIOS_INFO_BL_CONTROLLED_BY_GPU))\n\t\tgoto register_acpi_backlight;\n\n\tif (!acpi_video_backlight_use_native()) {\n\t\tdrm_info(dev, \"Skipping amdgpu atom DIG backlight registration\\n\");\n\t\tgoto register_acpi_backlight;\n\t}\n\n\tpdata = kmalloc(sizeof(struct amdgpu_backlight_privdata), GFP_KERNEL);\n\tif (!pdata) {\n\t\tDRM_ERROR(\"Memory allocation failed\\n\");\n\t\tgoto error;\n\t}\n\n\tmemset(&props, 0, sizeof(props));\n\tprops.max_brightness = AMDGPU_MAX_BL_LEVEL;\n\tprops.type = BACKLIGHT_RAW;\n\tsnprintf(bl_name, sizeof(bl_name),\n\t\t \"amdgpu_bl%d\", dev->primary->index);\n\tbd = backlight_device_register(bl_name, drm_connector->kdev,\n\t\t\t\t       pdata, &amdgpu_atombios_encoder_backlight_ops, &props);\n\tif (IS_ERR(bd)) {\n\t\tDRM_ERROR(\"Backlight registration failed\\n\");\n\t\tgoto error;\n\t}\n\n\tpdata->encoder = amdgpu_encoder;\n\n\tdig = amdgpu_encoder->enc_priv;\n\tdig->bl_dev = bd;\n\n\tbd->props.brightness = amdgpu_atombios_encoder_get_backlight_brightness(bd);\n\tbd->props.power = FB_BLANK_UNBLANK;\n\tbacklight_update_status(bd);\n\n\tDRM_INFO(\"amdgpu atom DIG backlight initialized\\n\");\n\n\treturn;\n\nerror:\n\tkfree(pdata);\n\treturn;\n\nregister_acpi_backlight:\n\t \n\tacpi_video_register_backlight();\n\treturn;\n}\n\nvoid\namdgpu_atombios_encoder_fini_backlight(struct amdgpu_encoder *amdgpu_encoder)\n{\n\tstruct drm_device *dev = amdgpu_encoder->base.dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct backlight_device *bd = NULL;\n\tstruct amdgpu_encoder_atom_dig *dig;\n\n\tif (!amdgpu_encoder->enc_priv)\n\t\treturn;\n\n\tif (!(adev->mode_info.firmware_flags & ATOM_BIOS_INFO_BL_CONTROLLED_BY_GPU))\n\t\treturn;\n\n\tdig = amdgpu_encoder->enc_priv;\n\tbd = dig->bl_dev;\n\tdig->bl_dev = NULL;\n\n\tif (bd) {\n\t\tstruct amdgpu_legacy_backlight_privdata *pdata;\n\n\t\tpdata = bl_get_data(bd);\n\t\tbacklight_device_unregister(bd);\n\t\tkfree(pdata);\n\n\t\tDRM_INFO(\"amdgpu atom LVDS backlight unloaded\\n\");\n\t}\n}\n\nbool amdgpu_atombios_encoder_is_digital(struct drm_encoder *encoder)\n{\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tswitch (amdgpu_encoder->encoder_id) {\n\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nbool amdgpu_atombios_encoder_mode_fixup(struct drm_encoder *encoder,\n\t\t\t\t const struct drm_display_mode *mode,\n\t\t\t\t struct drm_display_mode *adjusted_mode)\n{\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\n\t \n\tamdgpu_encoder_set_active_device(encoder);\n\tdrm_mode_set_crtcinfo(adjusted_mode, 0);\n\n\t \n\tif ((mode->flags & DRM_MODE_FLAG_INTERLACE)\n\t    && (mode->crtc_vsync_start < (mode->crtc_vdisplay + 2)))\n\t\tadjusted_mode->crtc_vsync_start = adjusted_mode->crtc_vdisplay + 2;\n\n\t \n\tif (mode->crtc_vsync_start == mode->crtc_vdisplay)\n\t\tadjusted_mode->crtc_vsync_start++;\n\n\t \n\tif (amdgpu_encoder->active_device & (ATOM_DEVICE_LCD_SUPPORT))\n\t\tamdgpu_panel_mode_fixup(encoder, adjusted_mode);\n\telse if (amdgpu_encoder->rmx_type != RMX_OFF)\n\t\tamdgpu_panel_mode_fixup(encoder, adjusted_mode);\n\n\tif ((amdgpu_encoder->active_device & (ATOM_DEVICE_DFP_SUPPORT | ATOM_DEVICE_LCD_SUPPORT)) ||\n\t    (amdgpu_encoder_get_dp_bridge_encoder_id(encoder) != ENCODER_OBJECT_ID_NONE)) {\n\t\tstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\n\t\tamdgpu_atombios_dp_set_link_config(connector, adjusted_mode);\n\t}\n\n\treturn true;\n}\n\nstatic void\namdgpu_atombios_encoder_setup_dac(struct drm_encoder *encoder, int action)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tDAC_ENCODER_CONTROL_PS_ALLOCATION args;\n\tint index = 0;\n\n\tmemset(&args, 0, sizeof(args));\n\n\tswitch (amdgpu_encoder->encoder_id) {\n\tcase ENCODER_OBJECT_ID_INTERNAL_DAC1:\n\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\n\t\tindex = GetIndexIntoMasterTable(COMMAND, DAC1EncoderControl);\n\t\tbreak;\n\tcase ENCODER_OBJECT_ID_INTERNAL_DAC2:\n\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2:\n\t\tindex = GetIndexIntoMasterTable(COMMAND, DAC2EncoderControl);\n\t\tbreak;\n\t}\n\n\targs.ucAction = action;\n\targs.ucDacStandard = ATOM_DAC1_PS2;\n\targs.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\n\tamdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\n\n}\n\nstatic u8 amdgpu_atombios_encoder_get_bpc(struct drm_encoder *encoder)\n{\n\tint bpc = 8;\n\n\tif (encoder->crtc) {\n\t\tstruct amdgpu_crtc *amdgpu_crtc = to_amdgpu_crtc(encoder->crtc);\n\t\tbpc = amdgpu_crtc->bpc;\n\t}\n\n\tswitch (bpc) {\n\tcase 0:\n\t\treturn PANEL_BPC_UNDEFINE;\n\tcase 6:\n\t\treturn PANEL_6BIT_PER_COLOR;\n\tcase 8:\n\tdefault:\n\t\treturn PANEL_8BIT_PER_COLOR;\n\tcase 10:\n\t\treturn PANEL_10BIT_PER_COLOR;\n\tcase 12:\n\t\treturn PANEL_12BIT_PER_COLOR;\n\tcase 16:\n\t\treturn PANEL_16BIT_PER_COLOR;\n\t}\n}\n\nunion dvo_encoder_control {\n\tENABLE_EXTERNAL_TMDS_ENCODER_PS_ALLOCATION ext_tmds;\n\tDVO_ENCODER_CONTROL_PS_ALLOCATION dvo;\n\tDVO_ENCODER_CONTROL_PS_ALLOCATION_V3 dvo_v3;\n\tDVO_ENCODER_CONTROL_PS_ALLOCATION_V1_4 dvo_v4;\n};\n\nstatic void\namdgpu_atombios_encoder_setup_dvo(struct drm_encoder *encoder, int action)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tunion dvo_encoder_control args;\n\tint index = GetIndexIntoMasterTable(COMMAND, DVOEncoderControl);\n\tuint8_t frev, crev;\n\n\tmemset(&args, 0, sizeof(args));\n\n\tif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\n\t\treturn;\n\n\tswitch (frev) {\n\tcase 1:\n\t\tswitch (crev) {\n\t\tcase 1:\n\t\t\t \n\t\t\targs.ext_tmds.sXTmdsEncoder.ucEnable = action;\n\n\t\t\tif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.ext_tmds.sXTmdsEncoder.ucMisc |= PANEL_ENCODER_MISC_DUAL;\n\n\t\t\targs.ext_tmds.sXTmdsEncoder.ucMisc |= ATOM_PANEL_MISC_888RGB;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\t \n\t\t\targs.dvo.sDVOEncoder.ucAction = action;\n\t\t\targs.dvo.sDVOEncoder.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\t \n\t\t\targs.dvo.sDVOEncoder.ucDeviceType = ATOM_DEVICE_DFP1_INDEX;\n\n\t\t\tif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.dvo.sDVOEncoder.usDevAttr.sDigAttrib.ucAttribute |= PANEL_ENCODER_MISC_DUAL;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\t \n\t\t\targs.dvo_v3.ucAction = action;\n\t\t\targs.dvo_v3.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\targs.dvo_v3.ucDVOConfig = 0;  \n\t\t\tbreak;\n\t\tcase 4:\n\t\t\t \n\t\t\targs.dvo_v4.ucAction = action;\n\t\t\targs.dvo_v4.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\targs.dvo_v4.ucDVOConfig = 0;  \n\t\t\targs.dvo_v4.ucBitPerColor = amdgpu_atombios_encoder_get_bpc(encoder);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tDRM_ERROR(\"Unknown table version %d, %d\\n\", frev, crev);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tDRM_ERROR(\"Unknown table version %d, %d\\n\", frev, crev);\n\t\tbreak;\n\t}\n\n\tamdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\n}\n\nint amdgpu_atombios_encoder_get_encoder_mode(struct drm_encoder *encoder)\n{\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tstruct drm_connector *connector;\n\tstruct amdgpu_connector *amdgpu_connector;\n\tstruct amdgpu_connector_atom_dig *dig_connector;\n\n\t \n\tif (amdgpu_encoder_get_dp_bridge_encoder_id(encoder) != ENCODER_OBJECT_ID_NONE)\n\t\treturn ATOM_ENCODER_MODE_DP;\n\n\t \n\tif ((amdgpu_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_DVO1) ||\n\t    (amdgpu_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1))\n\t\treturn ATOM_ENCODER_MODE_DVO;\n\n\tconnector = amdgpu_get_connector_for_encoder(encoder);\n\t \n\tif (!connector)\n\t\tconnector = amdgpu_get_connector_for_encoder_init(encoder);\n\tamdgpu_connector = to_amdgpu_connector(connector);\n\n\tswitch (connector->connector_type) {\n\tcase DRM_MODE_CONNECTOR_DVII:\n\tcase DRM_MODE_CONNECTOR_HDMIB:  \n\t\tif (amdgpu_audio != 0) {\n\t\t\tif (amdgpu_connector->use_digital &&\n\t\t\t    (amdgpu_connector->audio == AMDGPU_AUDIO_ENABLE))\n\t\t\t\treturn ATOM_ENCODER_MODE_HDMI;\n\t\t\telse if (connector->display_info.is_hdmi &&\n\t\t\t\t (amdgpu_connector->audio == AMDGPU_AUDIO_AUTO))\n\t\t\t\treturn ATOM_ENCODER_MODE_HDMI;\n\t\t\telse if (amdgpu_connector->use_digital)\n\t\t\t\treturn ATOM_ENCODER_MODE_DVI;\n\t\t\telse\n\t\t\t\treturn ATOM_ENCODER_MODE_CRT;\n\t\t} else if (amdgpu_connector->use_digital) {\n\t\t\treturn ATOM_ENCODER_MODE_DVI;\n\t\t} else {\n\t\t\treturn ATOM_ENCODER_MODE_CRT;\n\t\t}\n\t\tbreak;\n\tcase DRM_MODE_CONNECTOR_DVID:\n\tcase DRM_MODE_CONNECTOR_HDMIA:\n\tdefault:\n\t\tif (amdgpu_audio != 0) {\n\t\t\tif (amdgpu_connector->audio == AMDGPU_AUDIO_ENABLE)\n\t\t\t\treturn ATOM_ENCODER_MODE_HDMI;\n\t\t\telse if (connector->display_info.is_hdmi &&\n\t\t\t\t (amdgpu_connector->audio == AMDGPU_AUDIO_AUTO))\n\t\t\t\treturn ATOM_ENCODER_MODE_HDMI;\n\t\t\telse\n\t\t\t\treturn ATOM_ENCODER_MODE_DVI;\n\t\t} else {\n\t\t\treturn ATOM_ENCODER_MODE_DVI;\n\t\t}\n\tcase DRM_MODE_CONNECTOR_LVDS:\n\t\treturn ATOM_ENCODER_MODE_LVDS;\n\tcase DRM_MODE_CONNECTOR_DisplayPort:\n\t\tdig_connector = amdgpu_connector->con_priv;\n\t\tif ((dig_connector->dp_sink_type == CONNECTOR_OBJECT_ID_DISPLAYPORT) ||\n\t\t    (dig_connector->dp_sink_type == CONNECTOR_OBJECT_ID_eDP)) {\n\t\t\treturn ATOM_ENCODER_MODE_DP;\n\t\t} else if (amdgpu_audio != 0) {\n\t\t\tif (amdgpu_connector->audio == AMDGPU_AUDIO_ENABLE)\n\t\t\t\treturn ATOM_ENCODER_MODE_HDMI;\n\t\t\telse if (connector->display_info.is_hdmi &&\n\t\t\t\t (amdgpu_connector->audio == AMDGPU_AUDIO_AUTO))\n\t\t\t\treturn ATOM_ENCODER_MODE_HDMI;\n\t\t\telse\n\t\t\t\treturn ATOM_ENCODER_MODE_DVI;\n\t\t} else {\n\t\t\treturn ATOM_ENCODER_MODE_DVI;\n\t\t}\n\tcase DRM_MODE_CONNECTOR_eDP:\n\t\treturn ATOM_ENCODER_MODE_DP;\n\tcase DRM_MODE_CONNECTOR_DVIA:\n\tcase DRM_MODE_CONNECTOR_VGA:\n\t\treturn ATOM_ENCODER_MODE_CRT;\n\tcase DRM_MODE_CONNECTOR_Composite:\n\tcase DRM_MODE_CONNECTOR_SVIDEO:\n\tcase DRM_MODE_CONNECTOR_9PinDIN:\n\t\t \n\t\treturn ATOM_ENCODER_MODE_TV;\n\t}\n}\n\n \n\nunion dig_encoder_control {\n\tDIG_ENCODER_CONTROL_PS_ALLOCATION v1;\n\tDIG_ENCODER_CONTROL_PARAMETERS_V2 v2;\n\tDIG_ENCODER_CONTROL_PARAMETERS_V3 v3;\n\tDIG_ENCODER_CONTROL_PARAMETERS_V4 v4;\n\tDIG_ENCODER_CONTROL_PARAMETERS_V5 v5;\n};\n\nvoid\namdgpu_atombios_encoder_setup_dig_encoder(struct drm_encoder *encoder,\n\t\t\t\t   int action, int panel_mode)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tstruct amdgpu_encoder_atom_dig *dig = amdgpu_encoder->enc_priv;\n\tstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\n\tunion dig_encoder_control args;\n\tint index = GetIndexIntoMasterTable(COMMAND, DIGxEncoderControl);\n\tuint8_t frev, crev;\n\tint dp_clock = 0;\n\tint dp_lane_count = 0;\n\tint hpd_id = AMDGPU_HPD_NONE;\n\n\tif (connector) {\n\t\tstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\n\t\tstruct amdgpu_connector_atom_dig *dig_connector =\n\t\t\tamdgpu_connector->con_priv;\n\n\t\tdp_clock = dig_connector->dp_clock;\n\t\tdp_lane_count = dig_connector->dp_lane_count;\n\t\thpd_id = amdgpu_connector->hpd.hpd;\n\t}\n\n\t \n\tif (dig->dig_encoder == -1)\n\t\treturn;\n\n\tmemset(&args, 0, sizeof(args));\n\n\tif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\n\t\treturn;\n\n\tswitch (frev) {\n\tcase 1:\n\t\tswitch (crev) {\n\t\tcase 1:\n\t\t\targs.v1.ucAction = action;\n\t\t\targs.v1.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\tif (action == ATOM_ENCODER_CMD_SETUP_PANEL_MODE)\n\t\t\t\targs.v3.ucPanelMode = panel_mode;\n\t\t\telse\n\t\t\t\targs.v1.ucEncoderMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\n\n\t\t\tif (ENCODER_MODE_IS_DP(args.v1.ucEncoderMode))\n\t\t\t\targs.v1.ucLaneNum = dp_lane_count;\n\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.v1.ucLaneNum = 8;\n\t\t\telse\n\t\t\t\targs.v1.ucLaneNum = 4;\n\n\t\t\tif (ENCODER_MODE_IS_DP(args.v1.ucEncoderMode) && (dp_clock == 270000))\n\t\t\t\targs.v1.ucConfig |= ATOM_ENCODER_CONFIG_DPLINKRATE_2_70GHZ;\n\t\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\t\t\targs.v1.ucConfig = ATOM_ENCODER_CONFIG_V2_TRANSMITTER1;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\n\t\t\t\targs.v1.ucConfig = ATOM_ENCODER_CONFIG_V2_TRANSMITTER2;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\t\t\targs.v1.ucConfig = ATOM_ENCODER_CONFIG_V2_TRANSMITTER3;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (dig->linkb)\n\t\t\t\targs.v1.ucConfig |= ATOM_ENCODER_CONFIG_LINKB;\n\t\t\telse\n\t\t\t\targs.v1.ucConfig |= ATOM_ENCODER_CONFIG_LINKA;\n\t\t\tbreak;\n\t\tcase 2:\n\t\tcase 3:\n\t\t\targs.v3.ucAction = action;\n\t\t\targs.v3.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\tif (action == ATOM_ENCODER_CMD_SETUP_PANEL_MODE)\n\t\t\t\targs.v3.ucPanelMode = panel_mode;\n\t\t\telse\n\t\t\t\targs.v3.ucEncoderMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\n\n\t\t\tif (ENCODER_MODE_IS_DP(args.v3.ucEncoderMode))\n\t\t\t\targs.v3.ucLaneNum = dp_lane_count;\n\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.v3.ucLaneNum = 8;\n\t\t\telse\n\t\t\t\targs.v3.ucLaneNum = 4;\n\n\t\t\tif (ENCODER_MODE_IS_DP(args.v3.ucEncoderMode) && (dp_clock == 270000))\n\t\t\t\targs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V3_DPLINKRATE_2_70GHZ;\n\t\t\targs.v3.acConfig.ucDigSel = dig->dig_encoder;\n\t\t\targs.v3.ucBitPerColor = amdgpu_atombios_encoder_get_bpc(encoder);\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\targs.v4.ucAction = action;\n\t\t\targs.v4.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\tif (action == ATOM_ENCODER_CMD_SETUP_PANEL_MODE)\n\t\t\t\targs.v4.ucPanelMode = panel_mode;\n\t\t\telse\n\t\t\t\targs.v4.ucEncoderMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\n\n\t\t\tif (ENCODER_MODE_IS_DP(args.v4.ucEncoderMode))\n\t\t\t\targs.v4.ucLaneNum = dp_lane_count;\n\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.v4.ucLaneNum = 8;\n\t\t\telse\n\t\t\t\targs.v4.ucLaneNum = 4;\n\n\t\t\tif (ENCODER_MODE_IS_DP(args.v4.ucEncoderMode)) {\n\t\t\t\tif (dp_clock == 540000)\n\t\t\t\t\targs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_5_40GHZ;\n\t\t\t\telse if (dp_clock == 324000)\n\t\t\t\t\targs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_3_24GHZ;\n\t\t\t\telse if (dp_clock == 270000)\n\t\t\t\t\targs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_2_70GHZ;\n\t\t\t\telse\n\t\t\t\t\targs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_1_62GHZ;\n\t\t\t}\n\t\t\targs.v4.acConfig.ucDigSel = dig->dig_encoder;\n\t\t\targs.v4.ucBitPerColor = amdgpu_atombios_encoder_get_bpc(encoder);\n\t\t\tif (hpd_id == AMDGPU_HPD_NONE)\n\t\t\t\targs.v4.ucHPD_ID = 0;\n\t\t\telse\n\t\t\t\targs.v4.ucHPD_ID = hpd_id + 1;\n\t\t\tbreak;\n\t\tcase 5:\n\t\t\tswitch (action) {\n\t\t\tcase ATOM_ENCODER_CMD_SETUP_PANEL_MODE:\n\t\t\t\targs.v5.asDPPanelModeParam.ucAction = action;\n\t\t\t\targs.v5.asDPPanelModeParam.ucPanelMode = panel_mode;\n\t\t\t\targs.v5.asDPPanelModeParam.ucDigId = dig->dig_encoder;\n\t\t\t\tbreak;\n\t\t\tcase ATOM_ENCODER_CMD_STREAM_SETUP:\n\t\t\t\targs.v5.asStreamParam.ucAction = action;\n\t\t\t\targs.v5.asStreamParam.ucDigId = dig->dig_encoder;\n\t\t\t\targs.v5.asStreamParam.ucDigMode =\n\t\t\t\t\tamdgpu_atombios_encoder_get_encoder_mode(encoder);\n\t\t\t\tif (ENCODER_MODE_IS_DP(args.v5.asStreamParam.ucDigMode))\n\t\t\t\t\targs.v5.asStreamParam.ucLaneNum = dp_lane_count;\n\t\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder,\n\t\t\t\t\t\t\t\t\tamdgpu_encoder->pixel_clock))\n\t\t\t\t\targs.v5.asStreamParam.ucLaneNum = 8;\n\t\t\t\telse\n\t\t\t\t\targs.v5.asStreamParam.ucLaneNum = 4;\n\t\t\t\targs.v5.asStreamParam.ulPixelClock =\n\t\t\t\t\tcpu_to_le32(amdgpu_encoder->pixel_clock / 10);\n\t\t\t\targs.v5.asStreamParam.ucBitPerColor =\n\t\t\t\t\tamdgpu_atombios_encoder_get_bpc(encoder);\n\t\t\t\targs.v5.asStreamParam.ucLinkRateIn270Mhz = dp_clock / 27000;\n\t\t\t\tbreak;\n\t\t\tcase ATOM_ENCODER_CMD_DP_LINK_TRAINING_START:\n\t\t\tcase ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN1:\n\t\t\tcase ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN2:\n\t\t\tcase ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN3:\n\t\t\tcase ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN4:\n\t\t\tcase ATOM_ENCODER_CMD_DP_LINK_TRAINING_COMPLETE:\n\t\t\tcase ATOM_ENCODER_CMD_DP_VIDEO_OFF:\n\t\t\tcase ATOM_ENCODER_CMD_DP_VIDEO_ON:\n\t\t\t\targs.v5.asCmdParam.ucAction = action;\n\t\t\t\targs.v5.asCmdParam.ucDigId = dig->dig_encoder;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tDRM_ERROR(\"Unsupported action 0x%x\\n\", action);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tDRM_ERROR(\"Unknown table version %d, %d\\n\", frev, crev);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tDRM_ERROR(\"Unknown table version %d, %d\\n\", frev, crev);\n\t\tbreak;\n\t}\n\n\tamdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\n\n}\n\nunion dig_transmitter_control {\n\tDIG_TRANSMITTER_CONTROL_PS_ALLOCATION v1;\n\tDIG_TRANSMITTER_CONTROL_PARAMETERS_V2 v2;\n\tDIG_TRANSMITTER_CONTROL_PARAMETERS_V3 v3;\n\tDIG_TRANSMITTER_CONTROL_PARAMETERS_V4 v4;\n\tDIG_TRANSMITTER_CONTROL_PARAMETERS_V1_5 v5;\n\tDIG_TRANSMITTER_CONTROL_PARAMETERS_V1_6 v6;\n};\n\nvoid\namdgpu_atombios_encoder_setup_dig_transmitter(struct drm_encoder *encoder, int action,\n\t\t\t\t\t      uint8_t lane_num, uint8_t lane_set)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tstruct amdgpu_encoder_atom_dig *dig = amdgpu_encoder->enc_priv;\n\tstruct drm_connector *connector;\n\tunion dig_transmitter_control args;\n\tint index = 0;\n\tuint8_t frev, crev;\n\tbool is_dp = false;\n\tint pll_id = 0;\n\tint dp_clock = 0;\n\tint dp_lane_count = 0;\n\tint connector_object_id = 0;\n\tint dig_encoder = dig->dig_encoder;\n\tint hpd_id = AMDGPU_HPD_NONE;\n\n\tif (action == ATOM_TRANSMITTER_ACTION_INIT) {\n\t\tconnector = amdgpu_get_connector_for_encoder_init(encoder);\n\t\t \n\t\tdig_encoder = 0;\n\t} else\n\t\tconnector = amdgpu_get_connector_for_encoder(encoder);\n\n\tif (connector) {\n\t\tstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\n\t\tstruct amdgpu_connector_atom_dig *dig_connector =\n\t\t\tamdgpu_connector->con_priv;\n\n\t\thpd_id = amdgpu_connector->hpd.hpd;\n\t\tdp_clock = dig_connector->dp_clock;\n\t\tdp_lane_count = dig_connector->dp_lane_count;\n\t\tconnector_object_id =\n\t\t\t(amdgpu_connector->connector_object_id & OBJECT_ID_MASK) >> OBJECT_ID_SHIFT;\n\t}\n\n\tif (encoder->crtc) {\n\t\tstruct amdgpu_crtc *amdgpu_crtc = to_amdgpu_crtc(encoder->crtc);\n\t\tpll_id = amdgpu_crtc->pll_id;\n\t}\n\n\t \n\tif (dig_encoder == -1)\n\t\treturn;\n\n\tif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)))\n\t\tis_dp = true;\n\n\tmemset(&args, 0, sizeof(args));\n\n\tswitch (amdgpu_encoder->encoder_id) {\n\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\n\t\tindex = GetIndexIntoMasterTable(COMMAND, DVOOutputControl);\n\t\tbreak;\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\n\t\tindex = GetIndexIntoMasterTable(COMMAND, UNIPHYTransmitterControl);\n\t\tbreak;\n\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\n\t\tindex = GetIndexIntoMasterTable(COMMAND, LVTMATransmitterControl);\n\t\tbreak;\n\t}\n\n\tif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\n\t\treturn;\n\n\tswitch (frev) {\n\tcase 1:\n\t\tswitch (crev) {\n\t\tcase 1:\n\t\t\targs.v1.ucAction = action;\n\t\t\tif (action == ATOM_TRANSMITTER_ACTION_INIT) {\n\t\t\t\targs.v1.usInitInfo = cpu_to_le16(connector_object_id);\n\t\t\t} else if (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH) {\n\t\t\t\targs.v1.asMode.ucLaneSel = lane_num;\n\t\t\t\targs.v1.asMode.ucLaneSet = lane_set;\n\t\t\t} else {\n\t\t\t\tif (is_dp)\n\t\t\t\t\targs.v1.usPixelClock = cpu_to_le16(dp_clock / 10);\n\t\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\t\targs.v1.usPixelClock = cpu_to_le16((amdgpu_encoder->pixel_clock / 2) / 10);\n\t\t\t\telse\n\t\t\t\t\targs.v1.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\t}\n\n\t\t\targs.v1.ucConfig = ATOM_TRANSMITTER_CONFIG_CLKSRC_PPLL;\n\n\t\t\tif (dig_encoder)\n\t\t\t\targs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_DIG2_ENCODER;\n\t\t\telse\n\t\t\t\targs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_DIG1_ENCODER;\n\n\t\t\tif (dig->linkb)\n\t\t\t\targs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LINKB;\n\t\t\telse\n\t\t\t\targs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LINKA;\n\n\t\t\tif (is_dp)\n\t\t\t\targs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_COHERENT;\n\t\t\telse if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\n\t\t\t\tif (dig->coherent_mode)\n\t\t\t\t\targs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_COHERENT;\n\t\t\t\tif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\t\targs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_8LANE_LINK;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\targs.v2.ucAction = action;\n\t\t\tif (action == ATOM_TRANSMITTER_ACTION_INIT) {\n\t\t\t\targs.v2.usInitInfo = cpu_to_le16(connector_object_id);\n\t\t\t} else if (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH) {\n\t\t\t\targs.v2.asMode.ucLaneSel = lane_num;\n\t\t\t\targs.v2.asMode.ucLaneSet = lane_set;\n\t\t\t} else {\n\t\t\t\tif (is_dp)\n\t\t\t\t\targs.v2.usPixelClock = cpu_to_le16(dp_clock / 10);\n\t\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\t\targs.v2.usPixelClock = cpu_to_le16((amdgpu_encoder->pixel_clock / 2) / 10);\n\t\t\t\telse\n\t\t\t\t\targs.v2.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\t}\n\n\t\t\targs.v2.acConfig.ucEncoderSel = dig_encoder;\n\t\t\tif (dig->linkb)\n\t\t\t\targs.v2.acConfig.ucLinkSel = 1;\n\n\t\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\t\t\targs.v2.acConfig.ucTransmitterSel = 0;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\t\t\targs.v2.acConfig.ucTransmitterSel = 1;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\t\t\targs.v2.acConfig.ucTransmitterSel = 2;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (is_dp) {\n\t\t\t\targs.v2.acConfig.fCoherentMode = 1;\n\t\t\t\targs.v2.acConfig.fDPConnector = 1;\n\t\t\t} else if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\n\t\t\t\tif (dig->coherent_mode)\n\t\t\t\t\targs.v2.acConfig.fCoherentMode = 1;\n\t\t\t\tif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\t\targs.v2.acConfig.fDualLinkConnector = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\targs.v3.ucAction = action;\n\t\t\tif (action == ATOM_TRANSMITTER_ACTION_INIT) {\n\t\t\t\targs.v3.usInitInfo = cpu_to_le16(connector_object_id);\n\t\t\t} else if (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH) {\n\t\t\t\targs.v3.asMode.ucLaneSel = lane_num;\n\t\t\t\targs.v3.asMode.ucLaneSet = lane_set;\n\t\t\t} else {\n\t\t\t\tif (is_dp)\n\t\t\t\t\targs.v3.usPixelClock = cpu_to_le16(dp_clock / 10);\n\t\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\t\targs.v3.usPixelClock = cpu_to_le16((amdgpu_encoder->pixel_clock / 2) / 10);\n\t\t\t\telse\n\t\t\t\t\targs.v3.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\t}\n\n\t\t\tif (is_dp)\n\t\t\t\targs.v3.ucLaneNum = dp_lane_count;\n\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.v3.ucLaneNum = 8;\n\t\t\telse\n\t\t\t\targs.v3.ucLaneNum = 4;\n\n\t\t\tif (dig->linkb)\n\t\t\t\targs.v3.acConfig.ucLinkSel = 1;\n\t\t\tif (dig_encoder & 1)\n\t\t\t\targs.v3.acConfig.ucEncoderSel = 1;\n\n\t\t\t \n\t\t\t \n\t\t\tif (is_dp && adev->clock.dp_extclk)\n\t\t\t\targs.v3.acConfig.ucRefClkSource = 2;  \n\t\t\telse\n\t\t\t\targs.v3.acConfig.ucRefClkSource = pll_id;\n\n\t\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\t\t\targs.v3.acConfig.ucTransmitterSel = 0;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\t\t\targs.v3.acConfig.ucTransmitterSel = 1;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\t\t\targs.v3.acConfig.ucTransmitterSel = 2;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (is_dp)\n\t\t\t\targs.v3.acConfig.fCoherentMode = 1;  \n\t\t\telse if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\n\t\t\t\tif (dig->coherent_mode)\n\t\t\t\t\targs.v3.acConfig.fCoherentMode = 1;\n\t\t\t\tif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\t\targs.v3.acConfig.fDualLinkConnector = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\targs.v4.ucAction = action;\n\t\t\tif (action == ATOM_TRANSMITTER_ACTION_INIT) {\n\t\t\t\targs.v4.usInitInfo = cpu_to_le16(connector_object_id);\n\t\t\t} else if (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH) {\n\t\t\t\targs.v4.asMode.ucLaneSel = lane_num;\n\t\t\t\targs.v4.asMode.ucLaneSet = lane_set;\n\t\t\t} else {\n\t\t\t\tif (is_dp)\n\t\t\t\t\targs.v4.usPixelClock = cpu_to_le16(dp_clock / 10);\n\t\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\t\targs.v4.usPixelClock = cpu_to_le16((amdgpu_encoder->pixel_clock / 2) / 10);\n\t\t\t\telse\n\t\t\t\t\targs.v4.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\t}\n\n\t\t\tif (is_dp)\n\t\t\t\targs.v4.ucLaneNum = dp_lane_count;\n\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.v4.ucLaneNum = 8;\n\t\t\telse\n\t\t\t\targs.v4.ucLaneNum = 4;\n\n\t\t\tif (dig->linkb)\n\t\t\t\targs.v4.acConfig.ucLinkSel = 1;\n\t\t\tif (dig_encoder & 1)\n\t\t\t\targs.v4.acConfig.ucEncoderSel = 1;\n\n\t\t\t \n\t\t\t \n\t\t\tif (is_dp) {\n\t\t\t\tif (adev->clock.dp_extclk)\n\t\t\t\t\targs.v4.acConfig.ucRefClkSource = ENCODER_REFCLK_SRC_EXTCLK;\n\t\t\t\telse\n\t\t\t\t\targs.v4.acConfig.ucRefClkSource = ENCODER_REFCLK_SRC_DCPLL;\n\t\t\t} else\n\t\t\t\targs.v4.acConfig.ucRefClkSource = pll_id;\n\n\t\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\t\t\targs.v4.acConfig.ucTransmitterSel = 0;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\t\t\targs.v4.acConfig.ucTransmitterSel = 1;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\t\t\targs.v4.acConfig.ucTransmitterSel = 2;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (is_dp)\n\t\t\t\targs.v4.acConfig.fCoherentMode = 1;  \n\t\t\telse if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\n\t\t\t\tif (dig->coherent_mode)\n\t\t\t\t\targs.v4.acConfig.fCoherentMode = 1;\n\t\t\t\tif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\t\targs.v4.acConfig.fDualLinkConnector = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 5:\n\t\t\targs.v5.ucAction = action;\n\t\t\tif (is_dp)\n\t\t\t\targs.v5.usSymClock = cpu_to_le16(dp_clock / 10);\n\t\t\telse\n\t\t\t\targs.v5.usSymClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\n\t\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\t\t\tif (dig->linkb)\n\t\t\t\t\targs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYB;\n\t\t\t\telse\n\t\t\t\t\targs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYA;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\t\t\tif (dig->linkb)\n\t\t\t\t\targs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYD;\n\t\t\t\telse\n\t\t\t\t\targs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYC;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\t\t\tif (dig->linkb)\n\t\t\t\t\targs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYF;\n\t\t\t\telse\n\t\t\t\t\targs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYE;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\n\t\t\t\targs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYG;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (is_dp)\n\t\t\t\targs.v5.ucLaneNum = dp_lane_count;\n\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.v5.ucLaneNum = 8;\n\t\t\telse\n\t\t\t\targs.v5.ucLaneNum = 4;\n\t\t\targs.v5.ucConnObjId = connector_object_id;\n\t\t\targs.v5.ucDigMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\n\n\t\t\tif (is_dp && adev->clock.dp_extclk)\n\t\t\t\targs.v5.asConfig.ucPhyClkSrcId = ENCODER_REFCLK_SRC_EXTCLK;\n\t\t\telse\n\t\t\t\targs.v5.asConfig.ucPhyClkSrcId = pll_id;\n\n\t\t\tif (is_dp)\n\t\t\t\targs.v5.asConfig.ucCoherentMode = 1;  \n\t\t\telse if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\n\t\t\t\tif (dig->coherent_mode)\n\t\t\t\t\targs.v5.asConfig.ucCoherentMode = 1;\n\t\t\t}\n\t\t\tif (hpd_id == AMDGPU_HPD_NONE)\n\t\t\t\targs.v5.asConfig.ucHPDSel = 0;\n\t\t\telse\n\t\t\t\targs.v5.asConfig.ucHPDSel = hpd_id + 1;\n\t\t\targs.v5.ucDigEncoderSel = 1 << dig_encoder;\n\t\t\targs.v5.ucDPLaneSet = lane_set;\n\t\t\tbreak;\n\t\tcase 6:\n\t\t\targs.v6.ucAction = action;\n\t\t\tif (is_dp)\n\t\t\t\targs.v6.ulSymClock = cpu_to_le32(dp_clock / 10);\n\t\t\telse\n\t\t\t\targs.v6.ulSymClock = cpu_to_le32(amdgpu_encoder->pixel_clock / 10);\n\n\t\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\t\t\tif (dig->linkb)\n\t\t\t\t\targs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYB;\n\t\t\t\telse\n\t\t\t\t\targs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYA;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\t\t\tif (dig->linkb)\n\t\t\t\t\targs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYD;\n\t\t\t\telse\n\t\t\t\t\targs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYC;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\t\t\tif (dig->linkb)\n\t\t\t\t\targs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYF;\n\t\t\t\telse\n\t\t\t\t\targs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYE;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\n\t\t\t\targs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYG;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (is_dp)\n\t\t\t\targs.v6.ucLaneNum = dp_lane_count;\n\t\t\telse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.v6.ucLaneNum = 8;\n\t\t\telse\n\t\t\t\targs.v6.ucLaneNum = 4;\n\t\t\targs.v6.ucConnObjId = connector_object_id;\n\t\t\tif (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH)\n\t\t\t\targs.v6.ucDPLaneSet = lane_set;\n\t\t\telse\n\t\t\t\targs.v6.ucDigMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\n\n\t\t\tif (hpd_id == AMDGPU_HPD_NONE)\n\t\t\t\targs.v6.ucHPDSel = 0;\n\t\t\telse\n\t\t\t\targs.v6.ucHPDSel = hpd_id + 1;\n\t\t\targs.v6.ucDigEncoderSel = 1 << dig_encoder;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tDRM_ERROR(\"Unknown table version %d, %d\\n\", frev, crev);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tDRM_ERROR(\"Unknown table version %d, %d\\n\", frev, crev);\n\t\tbreak;\n\t}\n\n\tamdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\n}\n\nbool\namdgpu_atombios_encoder_set_edp_panel_power(struct drm_connector *connector,\n\t\t\t\t     int action)\n{\n\tstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\n\tstruct drm_device *dev = amdgpu_connector->base.dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tunion dig_transmitter_control args;\n\tint index = GetIndexIntoMasterTable(COMMAND, UNIPHYTransmitterControl);\n\tuint8_t frev, crev;\n\n\tif (connector->connector_type != DRM_MODE_CONNECTOR_eDP)\n\t\tgoto done;\n\n\tif ((action != ATOM_TRANSMITTER_ACTION_POWER_ON) &&\n\t    (action != ATOM_TRANSMITTER_ACTION_POWER_OFF))\n\t\tgoto done;\n\n\tif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\n\t\tgoto done;\n\n\tmemset(&args, 0, sizeof(args));\n\n\targs.v1.ucAction = action;\n\n\tamdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\n\n\t \n\tif (action == ATOM_TRANSMITTER_ACTION_POWER_ON) {\n\t\tint i;\n\n\t\tfor (i = 0; i < 300; i++) {\n\t\t\tif (amdgpu_display_hpd_sense(adev, amdgpu_connector->hpd.hpd))\n\t\t\t\treturn true;\n\t\t\tmdelay(1);\n\t\t}\n\t\treturn false;\n\t}\ndone:\n\treturn true;\n}\n\nunion external_encoder_control {\n\tEXTERNAL_ENCODER_CONTROL_PS_ALLOCATION v1;\n\tEXTERNAL_ENCODER_CONTROL_PS_ALLOCATION_V3 v3;\n};\n\nstatic void\namdgpu_atombios_encoder_setup_external_encoder(struct drm_encoder *encoder,\n\t\t\t\t\tstruct drm_encoder *ext_encoder,\n\t\t\t\t\tint action)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tstruct amdgpu_encoder *ext_amdgpu_encoder = to_amdgpu_encoder(ext_encoder);\n\tunion external_encoder_control args;\n\tstruct drm_connector *connector;\n\tint index = GetIndexIntoMasterTable(COMMAND, ExternalEncoderControl);\n\tu8 frev, crev;\n\tint dp_clock = 0;\n\tint dp_lane_count = 0;\n\tint connector_object_id = 0;\n\tu32 ext_enum = (ext_amdgpu_encoder->encoder_enum & ENUM_ID_MASK) >> ENUM_ID_SHIFT;\n\n\tif (action == EXTERNAL_ENCODER_ACTION_V3_ENCODER_INIT)\n\t\tconnector = amdgpu_get_connector_for_encoder_init(encoder);\n\telse\n\t\tconnector = amdgpu_get_connector_for_encoder(encoder);\n\n\tif (connector) {\n\t\tstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\n\t\tstruct amdgpu_connector_atom_dig *dig_connector =\n\t\t\tamdgpu_connector->con_priv;\n\n\t\tdp_clock = dig_connector->dp_clock;\n\t\tdp_lane_count = dig_connector->dp_lane_count;\n\t\tconnector_object_id =\n\t\t\t(amdgpu_connector->connector_object_id & OBJECT_ID_MASK) >> OBJECT_ID_SHIFT;\n\t}\n\n\tmemset(&args, 0, sizeof(args));\n\n\tif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\n\t\treturn;\n\n\tswitch (frev) {\n\tcase 1:\n\t\t \n\t\tbreak;\n\tcase 2:\n\t\tswitch (crev) {\n\t\tcase 1:\n\t\tcase 2:\n\t\t\targs.v1.sDigEncoder.ucAction = action;\n\t\t\targs.v1.sDigEncoder.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\targs.v1.sDigEncoder.ucEncoderMode =\n\t\t\t\tamdgpu_atombios_encoder_get_encoder_mode(encoder);\n\n\t\t\tif (ENCODER_MODE_IS_DP(args.v1.sDigEncoder.ucEncoderMode)) {\n\t\t\t\tif (dp_clock == 270000)\n\t\t\t\t\targs.v1.sDigEncoder.ucConfig |= ATOM_ENCODER_CONFIG_DPLINKRATE_2_70GHZ;\n\t\t\t\targs.v1.sDigEncoder.ucLaneNum = dp_lane_count;\n\t\t\t} else if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.v1.sDigEncoder.ucLaneNum = 8;\n\t\t\telse\n\t\t\t\targs.v1.sDigEncoder.ucLaneNum = 4;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\targs.v3.sExtEncoder.ucAction = action;\n\t\t\tif (action == EXTERNAL_ENCODER_ACTION_V3_ENCODER_INIT)\n\t\t\t\targs.v3.sExtEncoder.usConnectorId = cpu_to_le16(connector_object_id);\n\t\t\telse\n\t\t\t\targs.v3.sExtEncoder.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\n\t\t\targs.v3.sExtEncoder.ucEncoderMode =\n\t\t\t\tamdgpu_atombios_encoder_get_encoder_mode(encoder);\n\n\t\t\tif (ENCODER_MODE_IS_DP(args.v3.sExtEncoder.ucEncoderMode)) {\n\t\t\t\tif (dp_clock == 270000)\n\t\t\t\t\targs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_DPLINKRATE_2_70GHZ;\n\t\t\t\telse if (dp_clock == 540000)\n\t\t\t\t\targs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_DPLINKRATE_5_40GHZ;\n\t\t\t\targs.v3.sExtEncoder.ucLaneNum = dp_lane_count;\n\t\t\t} else if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\n\t\t\t\targs.v3.sExtEncoder.ucLaneNum = 8;\n\t\t\telse\n\t\t\t\targs.v3.sExtEncoder.ucLaneNum = 4;\n\t\t\tswitch (ext_enum) {\n\t\t\tcase GRAPH_OBJECT_ENUM_ID1:\n\t\t\t\targs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_ENCODER1;\n\t\t\t\tbreak;\n\t\t\tcase GRAPH_OBJECT_ENUM_ID2:\n\t\t\t\targs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_ENCODER2;\n\t\t\t\tbreak;\n\t\t\tcase GRAPH_OBJECT_ENUM_ID3:\n\t\t\t\targs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_ENCODER3;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\targs.v3.sExtEncoder.ucBitPerColor = amdgpu_atombios_encoder_get_bpc(encoder);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tDRM_ERROR(\"Unknown table version: %d, %d\\n\", frev, crev);\n\t\t\treturn;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tDRM_ERROR(\"Unknown table version: %d, %d\\n\", frev, crev);\n\t\treturn;\n\t}\n\tamdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\n}\n\nstatic void\namdgpu_atombios_encoder_setup_dig(struct drm_encoder *encoder, int action)\n{\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tstruct drm_encoder *ext_encoder = amdgpu_get_external_encoder(encoder);\n\tstruct amdgpu_encoder_atom_dig *dig = amdgpu_encoder->enc_priv;\n\tstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\n\tstruct amdgpu_connector *amdgpu_connector = NULL;\n\tstruct amdgpu_connector_atom_dig *amdgpu_dig_connector = NULL;\n\n\tif (connector) {\n\t\tamdgpu_connector = to_amdgpu_connector(connector);\n\t\tamdgpu_dig_connector = amdgpu_connector->con_priv;\n\t}\n\n\tif (action == ATOM_ENABLE) {\n\t\tif (!connector)\n\t\t\tdig->panel_mode = DP_PANEL_MODE_EXTERNAL_DP_MODE;\n\t\telse\n\t\t\tdig->panel_mode = amdgpu_atombios_dp_get_panel_mode(encoder, connector);\n\n\t\t \n\t\tamdgpu_atombios_encoder_setup_dig_encoder(encoder, ATOM_ENCODER_CMD_SETUP, 0);\n\t\tamdgpu_atombios_encoder_setup_dig_encoder(encoder,\n\t\t\t\t\t\t   ATOM_ENCODER_CMD_SETUP_PANEL_MODE,\n\t\t\t\t\t\t   dig->panel_mode);\n\t\tif (ext_encoder)\n\t\t\tamdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder,\n\t\t\t\t\t\t\t\tEXTERNAL_ENCODER_ACTION_V3_ENCODER_SETUP);\n\t\tif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\n\t\t    connector) {\n\t\t\tif (connector->connector_type == DRM_MODE_CONNECTOR_eDP) {\n\t\t\t\tamdgpu_atombios_encoder_set_edp_panel_power(connector,\n\t\t\t\t\t\t\t\t     ATOM_TRANSMITTER_ACTION_POWER_ON);\n\t\t\t\tamdgpu_dig_connector->edp_on = true;\n\t\t\t}\n\t\t}\n\t\t \n\t\tamdgpu_atombios_encoder_setup_dig_transmitter(encoder,\n\t\t\t\t\t\t       ATOM_TRANSMITTER_ACTION_ENABLE,\n\t\t\t\t\t\t       0, 0);\n\t\tif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\n\t\t    connector) {\n\t\t\t \n\t\t\tamdgpu_atombios_dp_link_train(encoder, connector);\n\t\t\tamdgpu_atombios_encoder_setup_dig_encoder(encoder, ATOM_ENCODER_CMD_DP_VIDEO_ON, 0);\n\t\t}\n\t\tif (amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT))\n\t\t\tamdgpu_atombios_encoder_set_backlight_level(amdgpu_encoder, dig->backlight_level);\n\t\tif (ext_encoder)\n\t\t\tamdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder, ATOM_ENABLE);\n\t} else {\n\t\tif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\n\t\t    connector)\n\t\t\tamdgpu_atombios_encoder_setup_dig_encoder(encoder,\n\t\t\t\t\t\t\t   ATOM_ENCODER_CMD_DP_VIDEO_OFF, 0);\n\t\tif (ext_encoder)\n\t\t\tamdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder, ATOM_DISABLE);\n\t\tif (amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT))\n\t\t\tamdgpu_atombios_encoder_setup_dig_transmitter(encoder,\n\t\t\t\t\t\t\t       ATOM_TRANSMITTER_ACTION_LCD_BLOFF, 0, 0);\n\n\t\tif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\n\t\t    connector)\n\t\t\tamdgpu_atombios_dp_set_rx_power_state(connector, DP_SET_POWER_D3);\n\t\t \n\t\tamdgpu_atombios_encoder_setup_dig_transmitter(encoder,\n\t\t\t\t\t\t       ATOM_TRANSMITTER_ACTION_DISABLE, 0, 0);\n\t\tif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\n\t\t    connector) {\n\t\t\tif (connector->connector_type == DRM_MODE_CONNECTOR_eDP) {\n\t\t\t\tamdgpu_atombios_encoder_set_edp_panel_power(connector,\n\t\t\t\t\t\t\t\t     ATOM_TRANSMITTER_ACTION_POWER_OFF);\n\t\t\t\tamdgpu_dig_connector->edp_on = false;\n\t\t\t}\n\t\t}\n\t}\n}\n\nvoid\namdgpu_atombios_encoder_dpms(struct drm_encoder *encoder, int mode)\n{\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\n\tDRM_DEBUG_KMS(\"encoder dpms %d to mode %d, devices %08x, active_devices %08x\\n\",\n\t\t  amdgpu_encoder->encoder_id, mode, amdgpu_encoder->devices,\n\t\t  amdgpu_encoder->active_device);\n\tswitch (amdgpu_encoder->encoder_id) {\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\n\t\tswitch (mode) {\n\t\tcase DRM_MODE_DPMS_ON:\n\t\t\tamdgpu_atombios_encoder_setup_dig(encoder, ATOM_ENABLE);\n\t\t\tbreak;\n\t\tcase DRM_MODE_DPMS_STANDBY:\n\t\tcase DRM_MODE_DPMS_SUSPEND:\n\t\tcase DRM_MODE_DPMS_OFF:\n\t\t\tamdgpu_atombios_encoder_setup_dig(encoder, ATOM_DISABLE);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\n\t\tswitch (mode) {\n\t\tcase DRM_MODE_DPMS_ON:\n\t\t\tamdgpu_atombios_encoder_setup_dvo(encoder, ATOM_ENABLE);\n\t\t\tbreak;\n\t\tcase DRM_MODE_DPMS_STANDBY:\n\t\tcase DRM_MODE_DPMS_SUSPEND:\n\t\tcase DRM_MODE_DPMS_OFF:\n\t\t\tamdgpu_atombios_encoder_setup_dvo(encoder, ATOM_DISABLE);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\n\t\tswitch (mode) {\n\t\tcase DRM_MODE_DPMS_ON:\n\t\t\tamdgpu_atombios_encoder_setup_dac(encoder, ATOM_ENABLE);\n\t\t\tbreak;\n\t\tcase DRM_MODE_DPMS_STANDBY:\n\t\tcase DRM_MODE_DPMS_SUSPEND:\n\t\tcase DRM_MODE_DPMS_OFF:\n\t\t\tamdgpu_atombios_encoder_setup_dac(encoder, ATOM_DISABLE);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n}\n\nunion crtc_source_param {\n\tSELECT_CRTC_SOURCE_PS_ALLOCATION v1;\n\tSELECT_CRTC_SOURCE_PARAMETERS_V2 v2;\n\tSELECT_CRTC_SOURCE_PARAMETERS_V3 v3;\n};\n\nvoid\namdgpu_atombios_encoder_set_crtc_source(struct drm_encoder *encoder)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tstruct amdgpu_crtc *amdgpu_crtc = to_amdgpu_crtc(encoder->crtc);\n\tunion crtc_source_param args;\n\tint index = GetIndexIntoMasterTable(COMMAND, SelectCRTC_Source);\n\tuint8_t frev, crev;\n\tstruct amdgpu_encoder_atom_dig *dig;\n\n\tmemset(&args, 0, sizeof(args));\n\n\tif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\n\t\treturn;\n\n\tswitch (frev) {\n\tcase 1:\n\t\tswitch (crev) {\n\t\tcase 1:\n\t\tdefault:\n\t\t\targs.v1.ucCRTC = amdgpu_crtc->crtc_id;\n\t\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_TMDS1:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1:\n\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_DFP1_INDEX;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_LVDS:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_LVTM1:\n\t\t\t\tif (amdgpu_encoder->devices & ATOM_DEVICE_LCD1_SUPPORT)\n\t\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_LCD1_INDEX;\n\t\t\t\telse\n\t\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_DFP3_INDEX;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_DVO1:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_DDI:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\n\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_DFP2_INDEX;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_DAC1:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\n\t\t\t\tif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\n\t\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_TV1_INDEX;\n\t\t\t\telse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\n\t\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_CV_INDEX;\n\t\t\t\telse\n\t\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_CRT1_INDEX;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_DAC2:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2:\n\t\t\t\tif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\n\t\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_TV1_INDEX;\n\t\t\t\telse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\n\t\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_CV_INDEX;\n\t\t\t\telse\n\t\t\t\t\targs.v1.ucDevice = ATOM_DEVICE_CRT2_INDEX;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\targs.v2.ucCRTC = amdgpu_crtc->crtc_id;\n\t\t\tif (amdgpu_encoder_get_dp_bridge_encoder_id(encoder) != ENCODER_OBJECT_ID_NONE) {\n\t\t\t\tstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\n\n\t\t\t\tif (connector->connector_type == DRM_MODE_CONNECTOR_LVDS)\n\t\t\t\t\targs.v2.ucEncodeMode = ATOM_ENCODER_MODE_LVDS;\n\t\t\t\telse if (connector->connector_type == DRM_MODE_CONNECTOR_VGA)\n\t\t\t\t\targs.v2.ucEncodeMode = ATOM_ENCODER_MODE_CRT;\n\t\t\t\telse\n\t\t\t\t\targs.v2.ucEncodeMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\n\t\t\t} else if (amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT)) {\n\t\t\t\targs.v2.ucEncodeMode = ATOM_ENCODER_MODE_LVDS;\n\t\t\t} else {\n\t\t\t\targs.v2.ucEncodeMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\n\t\t\t}\n\t\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\n\t\t\t\tdig = amdgpu_encoder->enc_priv;\n\t\t\t\tswitch (dig->dig_encoder) {\n\t\t\t\tcase 0:\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DIG1_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 1:\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DIG2_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DIG3_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 3:\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DIG4_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 4:\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DIG5_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 5:\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DIG6_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 6:\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DIG7_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\n\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DVO_ENCODER_ID;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\n\t\t\t\tif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\n\t\t\t\telse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\n\t\t\t\telse\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DAC1_ENCODER_ID;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2:\n\t\t\t\tif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\n\t\t\t\telse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\n\t\t\t\telse\n\t\t\t\t\targs.v2.ucEncoderID = ASIC_INT_DAC2_ENCODER_ID;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\targs.v3.ucCRTC = amdgpu_crtc->crtc_id;\n\t\t\tif (amdgpu_encoder_get_dp_bridge_encoder_id(encoder) != ENCODER_OBJECT_ID_NONE) {\n\t\t\t\tstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\n\n\t\t\t\tif (connector->connector_type == DRM_MODE_CONNECTOR_LVDS)\n\t\t\t\t\targs.v2.ucEncodeMode = ATOM_ENCODER_MODE_LVDS;\n\t\t\t\telse if (connector->connector_type == DRM_MODE_CONNECTOR_VGA)\n\t\t\t\t\targs.v2.ucEncodeMode = ATOM_ENCODER_MODE_CRT;\n\t\t\t\telse\n\t\t\t\t\targs.v2.ucEncodeMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\n\t\t\t} else if (amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT)) {\n\t\t\t\targs.v2.ucEncodeMode = ATOM_ENCODER_MODE_LVDS;\n\t\t\t} else {\n\t\t\t\targs.v2.ucEncodeMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\n\t\t\t}\n\t\t\targs.v3.ucDstBpc = amdgpu_atombios_encoder_get_bpc(encoder);\n\t\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\n\t\t\t\tdig = amdgpu_encoder->enc_priv;\n\t\t\t\tswitch (dig->dig_encoder) {\n\t\t\t\tcase 0:\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DIG1_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 1:\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DIG2_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DIG3_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 3:\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DIG4_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 4:\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DIG5_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 5:\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DIG6_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 6:\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DIG7_ENCODER_ID;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\n\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DVO_ENCODER_ID;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\n\t\t\t\tif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\n\t\t\t\telse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\n\t\t\t\telse\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DAC1_ENCODER_ID;\n\t\t\t\tbreak;\n\t\t\tcase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2:\n\t\t\t\tif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\n\t\t\t\telse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\n\t\t\t\telse\n\t\t\t\t\targs.v3.ucEncoderID = ASIC_INT_DAC2_ENCODER_ID;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tDRM_ERROR(\"Unknown table version: %d, %d\\n\", frev, crev);\n\t\treturn;\n\t}\n\n\tamdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\n}\n\n \nvoid\namdgpu_atombios_encoder_init_dig(struct amdgpu_device *adev)\n{\n\tstruct drm_device *dev = adev_to_drm(adev);\n\tstruct drm_encoder *encoder;\n\n\tlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\n\t\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\t\tstruct drm_encoder *ext_encoder = amdgpu_get_external_encoder(encoder);\n\n\t\tswitch (amdgpu_encoder->encoder_id) {\n\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\n\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\n\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\n\t\tcase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\n\t\t\tamdgpu_atombios_encoder_setup_dig_transmitter(encoder, ATOM_TRANSMITTER_ACTION_INIT,\n\t\t\t\t\t\t\t       0, 0);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (ext_encoder)\n\t\t\tamdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder,\n\t\t\t\t\t\t\t\tEXTERNAL_ENCODER_ACTION_V3_ENCODER_INIT);\n\t}\n}\n\nstatic bool\namdgpu_atombios_encoder_dac_load_detect(struct drm_encoder *encoder,\n\t\t\t\t struct drm_connector *connector)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\n\n\tif (amdgpu_encoder->devices & (ATOM_DEVICE_TV_SUPPORT |\n\t\t\t\t       ATOM_DEVICE_CV_SUPPORT |\n\t\t\t\t       ATOM_DEVICE_CRT_SUPPORT)) {\n\t\tDAC_LOAD_DETECTION_PS_ALLOCATION args;\n\t\tint index = GetIndexIntoMasterTable(COMMAND, DAC_LoadDetection);\n\t\tuint8_t frev, crev;\n\n\t\tmemset(&args, 0, sizeof(args));\n\n\t\tif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\n\t\t\treturn false;\n\n\t\targs.sDacload.ucMisc = 0;\n\n\t\tif ((amdgpu_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_DAC1) ||\n\t\t    (amdgpu_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1))\n\t\t\targs.sDacload.ucDacType = ATOM_DAC_A;\n\t\telse\n\t\t\targs.sDacload.ucDacType = ATOM_DAC_B;\n\n\t\tif (amdgpu_connector->devices & ATOM_DEVICE_CRT1_SUPPORT)\n\t\t\targs.sDacload.usDeviceID = cpu_to_le16(ATOM_DEVICE_CRT1_SUPPORT);\n\t\telse if (amdgpu_connector->devices & ATOM_DEVICE_CRT2_SUPPORT)\n\t\t\targs.sDacload.usDeviceID = cpu_to_le16(ATOM_DEVICE_CRT2_SUPPORT);\n\t\telse if (amdgpu_connector->devices & ATOM_DEVICE_CV_SUPPORT) {\n\t\t\targs.sDacload.usDeviceID = cpu_to_le16(ATOM_DEVICE_CV_SUPPORT);\n\t\t\tif (crev >= 3)\n\t\t\t\targs.sDacload.ucMisc = DAC_LOAD_MISC_YPrPb;\n\t\t} else if (amdgpu_connector->devices & ATOM_DEVICE_TV1_SUPPORT) {\n\t\t\targs.sDacload.usDeviceID = cpu_to_le16(ATOM_DEVICE_TV1_SUPPORT);\n\t\t\tif (crev >= 3)\n\t\t\t\targs.sDacload.ucMisc = DAC_LOAD_MISC_YPrPb;\n\t\t}\n\n\t\tamdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\n\n\t\treturn true;\n\t} else\n\t\treturn false;\n}\n\nenum drm_connector_status\namdgpu_atombios_encoder_dac_detect(struct drm_encoder *encoder,\n\t\t\t    struct drm_connector *connector)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\n\tuint32_t bios_0_scratch;\n\n\tif (!amdgpu_atombios_encoder_dac_load_detect(encoder, connector)) {\n\t\tDRM_DEBUG_KMS(\"detect returned false \\n\");\n\t\treturn connector_status_unknown;\n\t}\n\n\tbios_0_scratch = RREG32(mmBIOS_SCRATCH_0);\n\n\tDRM_DEBUG_KMS(\"Bios 0 scratch %x %08x\\n\", bios_0_scratch, amdgpu_encoder->devices);\n\tif (amdgpu_connector->devices & ATOM_DEVICE_CRT1_SUPPORT) {\n\t\tif (bios_0_scratch & ATOM_S0_CRT1_MASK)\n\t\t\treturn connector_status_connected;\n\t}\n\tif (amdgpu_connector->devices & ATOM_DEVICE_CRT2_SUPPORT) {\n\t\tif (bios_0_scratch & ATOM_S0_CRT2_MASK)\n\t\t\treturn connector_status_connected;\n\t}\n\tif (amdgpu_connector->devices & ATOM_DEVICE_CV_SUPPORT) {\n\t\tif (bios_0_scratch & (ATOM_S0_CV_MASK|ATOM_S0_CV_MASK_A))\n\t\t\treturn connector_status_connected;\n\t}\n\tif (amdgpu_connector->devices & ATOM_DEVICE_TV1_SUPPORT) {\n\t\tif (bios_0_scratch & (ATOM_S0_TV1_COMPOSITE | ATOM_S0_TV1_COMPOSITE_A))\n\t\t\treturn connector_status_connected;  \n\t\telse if (bios_0_scratch & (ATOM_S0_TV1_SVIDEO | ATOM_S0_TV1_SVIDEO_A))\n\t\t\treturn connector_status_connected;  \n\t}\n\treturn connector_status_disconnected;\n}\n\nenum drm_connector_status\namdgpu_atombios_encoder_dig_detect(struct drm_encoder *encoder,\n\t\t\t    struct drm_connector *connector)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\n\tstruct drm_encoder *ext_encoder = amdgpu_get_external_encoder(encoder);\n\tu32 bios_0_scratch;\n\n\tif (!ext_encoder)\n\t\treturn connector_status_unknown;\n\n\tif ((amdgpu_connector->devices & ATOM_DEVICE_CRT_SUPPORT) == 0)\n\t\treturn connector_status_unknown;\n\n\t \n\tamdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder,\n\t\t\t\t\t\tEXTERNAL_ENCODER_ACTION_V3_DACLOAD_DETECTION);\n\n\tbios_0_scratch = RREG32(mmBIOS_SCRATCH_0);\n\n\tDRM_DEBUG_KMS(\"Bios 0 scratch %x %08x\\n\", bios_0_scratch, amdgpu_encoder->devices);\n\tif (amdgpu_connector->devices & ATOM_DEVICE_CRT1_SUPPORT) {\n\t\tif (bios_0_scratch & ATOM_S0_CRT1_MASK)\n\t\t\treturn connector_status_connected;\n\t}\n\tif (amdgpu_connector->devices & ATOM_DEVICE_CRT2_SUPPORT) {\n\t\tif (bios_0_scratch & ATOM_S0_CRT2_MASK)\n\t\t\treturn connector_status_connected;\n\t}\n\tif (amdgpu_connector->devices & ATOM_DEVICE_CV_SUPPORT) {\n\t\tif (bios_0_scratch & (ATOM_S0_CV_MASK|ATOM_S0_CV_MASK_A))\n\t\t\treturn connector_status_connected;\n\t}\n\tif (amdgpu_connector->devices & ATOM_DEVICE_TV1_SUPPORT) {\n\t\tif (bios_0_scratch & (ATOM_S0_TV1_COMPOSITE | ATOM_S0_TV1_COMPOSITE_A))\n\t\t\treturn connector_status_connected;  \n\t\telse if (bios_0_scratch & (ATOM_S0_TV1_SVIDEO | ATOM_S0_TV1_SVIDEO_A))\n\t\t\treturn connector_status_connected;  \n\t}\n\treturn connector_status_disconnected;\n}\n\nvoid\namdgpu_atombios_encoder_setup_ext_encoder_ddc(struct drm_encoder *encoder)\n{\n\tstruct drm_encoder *ext_encoder = amdgpu_get_external_encoder(encoder);\n\n\tif (ext_encoder)\n\t\t \n\t\tamdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder,\n\t\t\t\t\t\t\tEXTERNAL_ENCODER_ACTION_V3_DDC_SETUP);\n\n}\n\nvoid\namdgpu_atombios_encoder_set_bios_scratch_regs(struct drm_connector *connector,\n\t\t\t\t       struct drm_encoder *encoder,\n\t\t\t\t       bool connected)\n{\n\tstruct drm_device *dev = connector->dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_connector *amdgpu_connector =\n\t    to_amdgpu_connector(connector);\n\tstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\n\tuint32_t bios_0_scratch, bios_3_scratch, bios_6_scratch;\n\n\tbios_0_scratch = RREG32(mmBIOS_SCRATCH_0);\n\tbios_3_scratch = RREG32(mmBIOS_SCRATCH_3);\n\tbios_6_scratch = RREG32(mmBIOS_SCRATCH_6);\n\n\tif ((amdgpu_encoder->devices & ATOM_DEVICE_LCD1_SUPPORT) &&\n\t    (amdgpu_connector->devices & ATOM_DEVICE_LCD1_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"LCD1 connected\\n\");\n\t\t\tbios_0_scratch |= ATOM_S0_LCD1;\n\t\t\tbios_3_scratch |= ATOM_S3_LCD1_ACTIVE;\n\t\t\tbios_6_scratch |= ATOM_S6_ACC_REQ_LCD1;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"LCD1 disconnected\\n\");\n\t\t\tbios_0_scratch &= ~ATOM_S0_LCD1;\n\t\t\tbios_3_scratch &= ~ATOM_S3_LCD1_ACTIVE;\n\t\t\tbios_6_scratch &= ~ATOM_S6_ACC_REQ_LCD1;\n\t\t}\n\t}\n\tif ((amdgpu_encoder->devices & ATOM_DEVICE_CRT1_SUPPORT) &&\n\t    (amdgpu_connector->devices & ATOM_DEVICE_CRT1_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"CRT1 connected\\n\");\n\t\t\tbios_0_scratch |= ATOM_S0_CRT1_COLOR;\n\t\t\tbios_3_scratch |= ATOM_S3_CRT1_ACTIVE;\n\t\t\tbios_6_scratch |= ATOM_S6_ACC_REQ_CRT1;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"CRT1 disconnected\\n\");\n\t\t\tbios_0_scratch &= ~ATOM_S0_CRT1_MASK;\n\t\t\tbios_3_scratch &= ~ATOM_S3_CRT1_ACTIVE;\n\t\t\tbios_6_scratch &= ~ATOM_S6_ACC_REQ_CRT1;\n\t\t}\n\t}\n\tif ((amdgpu_encoder->devices & ATOM_DEVICE_CRT2_SUPPORT) &&\n\t    (amdgpu_connector->devices & ATOM_DEVICE_CRT2_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"CRT2 connected\\n\");\n\t\t\tbios_0_scratch |= ATOM_S0_CRT2_COLOR;\n\t\t\tbios_3_scratch |= ATOM_S3_CRT2_ACTIVE;\n\t\t\tbios_6_scratch |= ATOM_S6_ACC_REQ_CRT2;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"CRT2 disconnected\\n\");\n\t\t\tbios_0_scratch &= ~ATOM_S0_CRT2_MASK;\n\t\t\tbios_3_scratch &= ~ATOM_S3_CRT2_ACTIVE;\n\t\t\tbios_6_scratch &= ~ATOM_S6_ACC_REQ_CRT2;\n\t\t}\n\t}\n\tif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP1_SUPPORT) &&\n\t    (amdgpu_connector->devices & ATOM_DEVICE_DFP1_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"DFP1 connected\\n\");\n\t\t\tbios_0_scratch |= ATOM_S0_DFP1;\n\t\t\tbios_3_scratch |= ATOM_S3_DFP1_ACTIVE;\n\t\t\tbios_6_scratch |= ATOM_S6_ACC_REQ_DFP1;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"DFP1 disconnected\\n\");\n\t\t\tbios_0_scratch &= ~ATOM_S0_DFP1;\n\t\t\tbios_3_scratch &= ~ATOM_S3_DFP1_ACTIVE;\n\t\t\tbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP1;\n\t\t}\n\t}\n\tif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP2_SUPPORT) &&\n\t    (amdgpu_connector->devices & ATOM_DEVICE_DFP2_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"DFP2 connected\\n\");\n\t\t\tbios_0_scratch |= ATOM_S0_DFP2;\n\t\t\tbios_3_scratch |= ATOM_S3_DFP2_ACTIVE;\n\t\t\tbios_6_scratch |= ATOM_S6_ACC_REQ_DFP2;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"DFP2 disconnected\\n\");\n\t\t\tbios_0_scratch &= ~ATOM_S0_DFP2;\n\t\t\tbios_3_scratch &= ~ATOM_S3_DFP2_ACTIVE;\n\t\t\tbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP2;\n\t\t}\n\t}\n\tif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP3_SUPPORT) &&\n\t    (amdgpu_connector->devices & ATOM_DEVICE_DFP3_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"DFP3 connected\\n\");\n\t\t\tbios_0_scratch |= ATOM_S0_DFP3;\n\t\t\tbios_3_scratch |= ATOM_S3_DFP3_ACTIVE;\n\t\t\tbios_6_scratch |= ATOM_S6_ACC_REQ_DFP3;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"DFP3 disconnected\\n\");\n\t\t\tbios_0_scratch &= ~ATOM_S0_DFP3;\n\t\t\tbios_3_scratch &= ~ATOM_S3_DFP3_ACTIVE;\n\t\t\tbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP3;\n\t\t}\n\t}\n\tif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP4_SUPPORT) &&\n\t    (amdgpu_connector->devices & ATOM_DEVICE_DFP4_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"DFP4 connected\\n\");\n\t\t\tbios_0_scratch |= ATOM_S0_DFP4;\n\t\t\tbios_3_scratch |= ATOM_S3_DFP4_ACTIVE;\n\t\t\tbios_6_scratch |= ATOM_S6_ACC_REQ_DFP4;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"DFP4 disconnected\\n\");\n\t\t\tbios_0_scratch &= ~ATOM_S0_DFP4;\n\t\t\tbios_3_scratch &= ~ATOM_S3_DFP4_ACTIVE;\n\t\t\tbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP4;\n\t\t}\n\t}\n\tif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP5_SUPPORT) &&\n\t    (amdgpu_connector->devices & ATOM_DEVICE_DFP5_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"DFP5 connected\\n\");\n\t\t\tbios_0_scratch |= ATOM_S0_DFP5;\n\t\t\tbios_3_scratch |= ATOM_S3_DFP5_ACTIVE;\n\t\t\tbios_6_scratch |= ATOM_S6_ACC_REQ_DFP5;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"DFP5 disconnected\\n\");\n\t\t\tbios_0_scratch &= ~ATOM_S0_DFP5;\n\t\t\tbios_3_scratch &= ~ATOM_S3_DFP5_ACTIVE;\n\t\t\tbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP5;\n\t\t}\n\t}\n\tif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP6_SUPPORT) &&\n\t    (amdgpu_connector->devices & ATOM_DEVICE_DFP6_SUPPORT)) {\n\t\tif (connected) {\n\t\t\tDRM_DEBUG_KMS(\"DFP6 connected\\n\");\n\t\t\tbios_0_scratch |= ATOM_S0_DFP6;\n\t\t\tbios_3_scratch |= ATOM_S3_DFP6_ACTIVE;\n\t\t\tbios_6_scratch |= ATOM_S6_ACC_REQ_DFP6;\n\t\t} else {\n\t\t\tDRM_DEBUG_KMS(\"DFP6 disconnected\\n\");\n\t\t\tbios_0_scratch &= ~ATOM_S0_DFP6;\n\t\t\tbios_3_scratch &= ~ATOM_S3_DFP6_ACTIVE;\n\t\t\tbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP6;\n\t\t}\n\t}\n\n\tWREG32(mmBIOS_SCRATCH_0, bios_0_scratch);\n\tWREG32(mmBIOS_SCRATCH_3, bios_3_scratch);\n\tWREG32(mmBIOS_SCRATCH_6, bios_6_scratch);\n}\n\nunion lvds_info {\n\tstruct _ATOM_LVDS_INFO info;\n\tstruct _ATOM_LVDS_INFO_V12 info_12;\n};\n\nstruct amdgpu_encoder_atom_dig *\namdgpu_atombios_encoder_get_lcd_info(struct amdgpu_encoder *encoder)\n{\n\tstruct drm_device *dev = encoder->base.dev;\n\tstruct amdgpu_device *adev = drm_to_adev(dev);\n\tstruct amdgpu_mode_info *mode_info = &adev->mode_info;\n\tint index = GetIndexIntoMasterTable(DATA, LVDS_Info);\n\tuint16_t data_offset, misc;\n\tunion lvds_info *lvds_info;\n\tuint8_t frev, crev;\n\tstruct amdgpu_encoder_atom_dig *lvds = NULL;\n\tint encoder_enum = (encoder->encoder_enum & ENUM_ID_MASK) >> ENUM_ID_SHIFT;\n\n\tif (amdgpu_atom_parse_data_header(mode_info->atom_context, index, NULL,\n\t\t\t\t   &frev, &crev, &data_offset)) {\n\t\tlvds_info =\n\t\t\t(union lvds_info *)(mode_info->atom_context->bios + data_offset);\n\t\tlvds =\n\t\t    kzalloc(sizeof(struct amdgpu_encoder_atom_dig), GFP_KERNEL);\n\n\t\tif (!lvds)\n\t\t\treturn NULL;\n\n\t\tlvds->native_mode.clock =\n\t\t    le16_to_cpu(lvds_info->info.sLCDTiming.usPixClk) * 10;\n\t\tlvds->native_mode.hdisplay =\n\t\t    le16_to_cpu(lvds_info->info.sLCDTiming.usHActive);\n\t\tlvds->native_mode.vdisplay =\n\t\t    le16_to_cpu(lvds_info->info.sLCDTiming.usVActive);\n\t\tlvds->native_mode.htotal = lvds->native_mode.hdisplay +\n\t\t\tle16_to_cpu(lvds_info->info.sLCDTiming.usHBlanking_Time);\n\t\tlvds->native_mode.hsync_start = lvds->native_mode.hdisplay +\n\t\t\tle16_to_cpu(lvds_info->info.sLCDTiming.usHSyncOffset);\n\t\tlvds->native_mode.hsync_end = lvds->native_mode.hsync_start +\n\t\t\tle16_to_cpu(lvds_info->info.sLCDTiming.usHSyncWidth);\n\t\tlvds->native_mode.vtotal = lvds->native_mode.vdisplay +\n\t\t\tle16_to_cpu(lvds_info->info.sLCDTiming.usVBlanking_Time);\n\t\tlvds->native_mode.vsync_start = lvds->native_mode.vdisplay +\n\t\t\tle16_to_cpu(lvds_info->info.sLCDTiming.usVSyncOffset);\n\t\tlvds->native_mode.vsync_end = lvds->native_mode.vsync_start +\n\t\t\tle16_to_cpu(lvds_info->info.sLCDTiming.usVSyncWidth);\n\t\tlvds->panel_pwr_delay =\n\t\t    le16_to_cpu(lvds_info->info.usOffDelayInMs);\n\t\tlvds->lcd_misc = lvds_info->info.ucLVDS_Misc;\n\n\t\tmisc = le16_to_cpu(lvds_info->info.sLCDTiming.susModeMiscInfo.usAccess);\n\t\tif (misc & ATOM_VSYNC_POLARITY)\n\t\t\tlvds->native_mode.flags |= DRM_MODE_FLAG_NVSYNC;\n\t\tif (misc & ATOM_HSYNC_POLARITY)\n\t\t\tlvds->native_mode.flags |= DRM_MODE_FLAG_NHSYNC;\n\t\tif (misc & ATOM_COMPOSITESYNC)\n\t\t\tlvds->native_mode.flags |= DRM_MODE_FLAG_CSYNC;\n\t\tif (misc & ATOM_INTERLACE)\n\t\t\tlvds->native_mode.flags |= DRM_MODE_FLAG_INTERLACE;\n\t\tif (misc & ATOM_DOUBLE_CLOCK_MODE)\n\t\t\tlvds->native_mode.flags |= DRM_MODE_FLAG_DBLSCAN;\n\n\t\tlvds->native_mode.width_mm = le16_to_cpu(lvds_info->info.sLCDTiming.usImageHSize);\n\t\tlvds->native_mode.height_mm = le16_to_cpu(lvds_info->info.sLCDTiming.usImageVSize);\n\n\t\t \n\t\tdrm_mode_set_crtcinfo(&lvds->native_mode, CRTC_INTERLACE_HALVE_V);\n\n\t\tlvds->lcd_ss_id = lvds_info->info.ucSS_Id;\n\n\t\tencoder->native_mode = lvds->native_mode;\n\n\t\tif (encoder_enum == 2)\n\t\t\tlvds->linkb = true;\n\t\telse\n\t\t\tlvds->linkb = false;\n\n\t\t \n\t\tif (le16_to_cpu(lvds_info->info.usModePatchTableOffset)) {\n\t\t\tATOM_FAKE_EDID_PATCH_RECORD *fake_edid_record;\n\t\t\tATOM_PANEL_RESOLUTION_PATCH_RECORD *panel_res_record;\n\t\t\tbool bad_record = false;\n\t\t\tu8 *record;\n\n\t\t\tif ((frev == 1) && (crev < 2))\n\t\t\t\t \n\t\t\t\trecord = (u8 *)(mode_info->atom_context->bios +\n\t\t\t\t\t\tle16_to_cpu(lvds_info->info.usModePatchTableOffset));\n\t\t\telse\n\t\t\t\t \n\t\t\t\trecord = (u8 *)(mode_info->atom_context->bios +\n\t\t\t\t\t\tdata_offset +\n\t\t\t\t\t\tle16_to_cpu(lvds_info->info.usModePatchTableOffset));\n\t\t\twhile (*record != ATOM_RECORD_END_TYPE) {\n\t\t\t\tswitch (*record) {\n\t\t\t\tcase LCD_MODE_PATCH_RECORD_MODE_TYPE:\n\t\t\t\t\trecord += sizeof(ATOM_PATCH_RECORD_MODE);\n\t\t\t\t\tbreak;\n\t\t\t\tcase LCD_RTS_RECORD_TYPE:\n\t\t\t\t\trecord += sizeof(ATOM_LCD_RTS_RECORD);\n\t\t\t\t\tbreak;\n\t\t\t\tcase LCD_CAP_RECORD_TYPE:\n\t\t\t\t\trecord += sizeof(ATOM_LCD_MODE_CONTROL_CAP);\n\t\t\t\t\tbreak;\n\t\t\t\tcase LCD_FAKE_EDID_PATCH_RECORD_TYPE:\n\t\t\t\t\tfake_edid_record = (ATOM_FAKE_EDID_PATCH_RECORD *)record;\n\t\t\t\t\tif (fake_edid_record->ucFakeEDIDLength) {\n\t\t\t\t\t\tstruct edid *edid;\n\t\t\t\t\t\tint edid_size =\n\t\t\t\t\t\t\tmax((int)EDID_LENGTH, (int)fake_edid_record->ucFakeEDIDLength);\n\t\t\t\t\t\tedid = kmalloc(edid_size, GFP_KERNEL);\n\t\t\t\t\t\tif (edid) {\n\t\t\t\t\t\t\tmemcpy((u8 *)edid, (u8 *)&fake_edid_record->ucFakeEDIDString[0],\n\t\t\t\t\t\t\t       fake_edid_record->ucFakeEDIDLength);\n\n\t\t\t\t\t\t\tif (drm_edid_is_valid(edid)) {\n\t\t\t\t\t\t\t\tadev->mode_info.bios_hardcoded_edid = edid;\n\t\t\t\t\t\t\t\tadev->mode_info.bios_hardcoded_edid_size = edid_size;\n\t\t\t\t\t\t\t} else\n\t\t\t\t\t\t\t\tkfree(edid);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\trecord += fake_edid_record->ucFakeEDIDLength ?\n\t\t\t\t\t\t  struct_size(fake_edid_record,\n\t\t\t\t\t\t\t      ucFakeEDIDString,\n\t\t\t\t\t\t\t      fake_edid_record->ucFakeEDIDLength) :\n\t\t\t\t\t\t   \n\t\t\t\t\t\t  sizeof(ATOM_FAKE_EDID_PATCH_RECORD) + 1;\n\t\t\t\t\tbreak;\n\t\t\t\tcase LCD_PANEL_RESOLUTION_RECORD_TYPE:\n\t\t\t\t\tpanel_res_record = (ATOM_PANEL_RESOLUTION_PATCH_RECORD *)record;\n\t\t\t\t\tlvds->native_mode.width_mm = panel_res_record->usHSize;\n\t\t\t\t\tlvds->native_mode.height_mm = panel_res_record->usVSize;\n\t\t\t\t\trecord += sizeof(ATOM_PANEL_RESOLUTION_PATCH_RECORD);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tDRM_ERROR(\"Bad LCD record %d\\n\", *record);\n\t\t\t\t\tbad_record = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (bad_record)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn lvds;\n}\n\nstruct amdgpu_encoder_atom_dig *\namdgpu_atombios_encoder_get_dig_info(struct amdgpu_encoder *amdgpu_encoder)\n{\n\tint encoder_enum = (amdgpu_encoder->encoder_enum & ENUM_ID_MASK) >> ENUM_ID_SHIFT;\n\tstruct amdgpu_encoder_atom_dig *dig = kzalloc(sizeof(struct amdgpu_encoder_atom_dig), GFP_KERNEL);\n\n\tif (!dig)\n\t\treturn NULL;\n\n\t \n\tdig->coherent_mode = true;\n\tdig->dig_encoder = -1;\n\n\tif (encoder_enum == 2)\n\t\tdig->linkb = true;\n\telse\n\t\tdig->linkb = false;\n\n\treturn dig;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}