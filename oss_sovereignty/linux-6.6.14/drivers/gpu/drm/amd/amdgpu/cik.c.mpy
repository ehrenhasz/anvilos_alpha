{
  "module_name": "cik.c",
  "hash_id": "7c5c5a0101b9f4e77f6f0d90024e3d92420d5d185f0996651071db14f8d78f31",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/cik.c",
  "human_readable_source": " \n#include <linux/firmware.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n\n#include <drm/amdgpu_drm.h>\n\n#include \"amdgpu.h\"\n#include \"amdgpu_atombios.h\"\n#include \"amdgpu_ih.h\"\n#include \"amdgpu_uvd.h\"\n#include \"amdgpu_vce.h\"\n#include \"cikd.h\"\n#include \"atom.h\"\n#include \"amd_pcie.h\"\n\n#include \"cik.h\"\n#include \"gmc_v7_0.h\"\n#include \"cik_ih.h\"\n#include \"dce_v8_0.h\"\n#include \"gfx_v7_0.h\"\n#include \"cik_sdma.h\"\n#include \"uvd_v4_2.h\"\n#include \"vce_v2_0.h\"\n#include \"cik_dpm.h\"\n\n#include \"uvd/uvd_4_2_d.h\"\n\n#include \"smu/smu_7_0_1_d.h\"\n#include \"smu/smu_7_0_1_sh_mask.h\"\n\n#include \"dce/dce_8_0_d.h\"\n#include \"dce/dce_8_0_sh_mask.h\"\n\n#include \"bif/bif_4_1_d.h\"\n#include \"bif/bif_4_1_sh_mask.h\"\n\n#include \"gca/gfx_7_2_d.h\"\n#include \"gca/gfx_7_2_enum.h\"\n#include \"gca/gfx_7_2_sh_mask.h\"\n\n#include \"gmc/gmc_7_1_d.h\"\n#include \"gmc/gmc_7_1_sh_mask.h\"\n\n#include \"oss/oss_2_0_d.h\"\n#include \"oss/oss_2_0_sh_mask.h\"\n\n#include \"amdgpu_dm.h\"\n#include \"amdgpu_amdkfd.h\"\n#include \"amdgpu_vkms.h\"\n\nstatic const struct amdgpu_video_codec_info cik_video_codecs_encode_array[] =\n{\n\t{\n\t\t.codec_type = AMDGPU_INFO_VIDEO_CAPS_CODEC_IDX_MPEG4_AVC,\n\t\t.max_width = 2048,\n\t\t.max_height = 1152,\n\t\t.max_pixels_per_frame = 2048 * 1152,\n\t\t.max_level = 0,\n\t},\n};\n\nstatic const struct amdgpu_video_codecs cik_video_codecs_encode =\n{\n\t.codec_count = ARRAY_SIZE(cik_video_codecs_encode_array),\n\t.codec_array = cik_video_codecs_encode_array,\n};\n\nstatic const struct amdgpu_video_codec_info cik_video_codecs_decode_array[] =\n{\n\t{\n\t\t.codec_type = AMDGPU_INFO_VIDEO_CAPS_CODEC_IDX_MPEG2,\n\t\t.max_width = 2048,\n\t\t.max_height = 1152,\n\t\t.max_pixels_per_frame = 2048 * 1152,\n\t\t.max_level = 3,\n\t},\n\t{\n\t\t.codec_type = AMDGPU_INFO_VIDEO_CAPS_CODEC_IDX_MPEG4,\n\t\t.max_width = 2048,\n\t\t.max_height = 1152,\n\t\t.max_pixels_per_frame = 2048 * 1152,\n\t\t.max_level = 5,\n\t},\n\t{\n\t\t.codec_type = AMDGPU_INFO_VIDEO_CAPS_CODEC_IDX_MPEG4_AVC,\n\t\t.max_width = 2048,\n\t\t.max_height = 1152,\n\t\t.max_pixels_per_frame = 2048 * 1152,\n\t\t.max_level = 41,\n\t},\n\t{\n\t\t.codec_type = AMDGPU_INFO_VIDEO_CAPS_CODEC_IDX_VC1,\n\t\t.max_width = 2048,\n\t\t.max_height = 1152,\n\t\t.max_pixels_per_frame = 2048 * 1152,\n\t\t.max_level = 4,\n\t},\n};\n\nstatic const struct amdgpu_video_codecs cik_video_codecs_decode =\n{\n\t.codec_count = ARRAY_SIZE(cik_video_codecs_decode_array),\n\t.codec_array = cik_video_codecs_decode_array,\n};\n\nstatic int cik_query_video_codecs(struct amdgpu_device *adev, bool encode,\n\t\t\t\t  const struct amdgpu_video_codecs **codecs)\n{\n\tswitch (adev->asic_type) {\n\tcase CHIP_BONAIRE:\n\tcase CHIP_HAWAII:\n\tcase CHIP_KAVERI:\n\tcase CHIP_KABINI:\n\tcase CHIP_MULLINS:\n\t\tif (encode)\n\t\t\t*codecs = &cik_video_codecs_encode;\n\t\telse\n\t\t\t*codecs = &cik_video_codecs_decode;\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\n \nstatic u32 cik_pcie_rreg(struct amdgpu_device *adev, u32 reg)\n{\n\tunsigned long flags;\n\tu32 r;\n\n\tspin_lock_irqsave(&adev->pcie_idx_lock, flags);\n\tWREG32(mmPCIE_INDEX, reg);\n\t(void)RREG32(mmPCIE_INDEX);\n\tr = RREG32(mmPCIE_DATA);\n\tspin_unlock_irqrestore(&adev->pcie_idx_lock, flags);\n\treturn r;\n}\n\nstatic void cik_pcie_wreg(struct amdgpu_device *adev, u32 reg, u32 v)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&adev->pcie_idx_lock, flags);\n\tWREG32(mmPCIE_INDEX, reg);\n\t(void)RREG32(mmPCIE_INDEX);\n\tWREG32(mmPCIE_DATA, v);\n\t(void)RREG32(mmPCIE_DATA);\n\tspin_unlock_irqrestore(&adev->pcie_idx_lock, flags);\n}\n\nstatic u32 cik_smc_rreg(struct amdgpu_device *adev, u32 reg)\n{\n\tunsigned long flags;\n\tu32 r;\n\n\tspin_lock_irqsave(&adev->smc_idx_lock, flags);\n\tWREG32(mmSMC_IND_INDEX_0, (reg));\n\tr = RREG32(mmSMC_IND_DATA_0);\n\tspin_unlock_irqrestore(&adev->smc_idx_lock, flags);\n\treturn r;\n}\n\nstatic void cik_smc_wreg(struct amdgpu_device *adev, u32 reg, u32 v)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&adev->smc_idx_lock, flags);\n\tWREG32(mmSMC_IND_INDEX_0, (reg));\n\tWREG32(mmSMC_IND_DATA_0, (v));\n\tspin_unlock_irqrestore(&adev->smc_idx_lock, flags);\n}\n\nstatic u32 cik_uvd_ctx_rreg(struct amdgpu_device *adev, u32 reg)\n{\n\tunsigned long flags;\n\tu32 r;\n\n\tspin_lock_irqsave(&adev->uvd_ctx_idx_lock, flags);\n\tWREG32(mmUVD_CTX_INDEX, ((reg) & 0x1ff));\n\tr = RREG32(mmUVD_CTX_DATA);\n\tspin_unlock_irqrestore(&adev->uvd_ctx_idx_lock, flags);\n\treturn r;\n}\n\nstatic void cik_uvd_ctx_wreg(struct amdgpu_device *adev, u32 reg, u32 v)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&adev->uvd_ctx_idx_lock, flags);\n\tWREG32(mmUVD_CTX_INDEX, ((reg) & 0x1ff));\n\tWREG32(mmUVD_CTX_DATA, (v));\n\tspin_unlock_irqrestore(&adev->uvd_ctx_idx_lock, flags);\n}\n\nstatic u32 cik_didt_rreg(struct amdgpu_device *adev, u32 reg)\n{\n\tunsigned long flags;\n\tu32 r;\n\n\tspin_lock_irqsave(&adev->didt_idx_lock, flags);\n\tWREG32(mmDIDT_IND_INDEX, (reg));\n\tr = RREG32(mmDIDT_IND_DATA);\n\tspin_unlock_irqrestore(&adev->didt_idx_lock, flags);\n\treturn r;\n}\n\nstatic void cik_didt_wreg(struct amdgpu_device *adev, u32 reg, u32 v)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&adev->didt_idx_lock, flags);\n\tWREG32(mmDIDT_IND_INDEX, (reg));\n\tWREG32(mmDIDT_IND_DATA, (v));\n\tspin_unlock_irqrestore(&adev->didt_idx_lock, flags);\n}\n\nstatic const u32 bonaire_golden_spm_registers[] =\n{\n\t0xc200, 0xe0ffffff, 0xe0000000\n};\n\nstatic const u32 bonaire_golden_common_registers[] =\n{\n\t0x31dc, 0xffffffff, 0x00000800,\n\t0x31dd, 0xffffffff, 0x00000800,\n\t0x31e6, 0xffffffff, 0x00007fbf,\n\t0x31e7, 0xffffffff, 0x00007faf\n};\n\nstatic const u32 bonaire_golden_registers[] =\n{\n\t0xcd5, 0x00000333, 0x00000333,\n\t0xcd4, 0x000c0fc0, 0x00040200,\n\t0x2684, 0x00010000, 0x00058208,\n\t0xf000, 0xffff1fff, 0x00140000,\n\t0xf080, 0xfdfc0fff, 0x00000100,\n\t0xf08d, 0x40000000, 0x40000200,\n\t0x260c, 0xffffffff, 0x00000000,\n\t0x260d, 0xf00fffff, 0x00000400,\n\t0x260e, 0x0002021c, 0x00020200,\n\t0x31e, 0x00000080, 0x00000000,\n\t0x16ec, 0x000000f0, 0x00000070,\n\t0x16f0, 0xf0311fff, 0x80300000,\n\t0x263e, 0x73773777, 0x12010001,\n\t0xd43, 0x00810000, 0x408af000,\n\t0x1c0c, 0x31000111, 0x00000011,\n\t0xbd2, 0x73773777, 0x12010001,\n\t0x883, 0x00007fb6, 0x0021a1b1,\n\t0x884, 0x00007fb6, 0x002021b1,\n\t0x860, 0x00007fb6, 0x00002191,\n\t0x886, 0x00007fb6, 0x002121b1,\n\t0x887, 0x00007fb6, 0x002021b1,\n\t0x877, 0x00007fb6, 0x00002191,\n\t0x878, 0x00007fb6, 0x00002191,\n\t0xd8a, 0x0000003f, 0x0000000a,\n\t0xd8b, 0x0000003f, 0x0000000a,\n\t0xab9, 0x00073ffe, 0x000022a2,\n\t0x903, 0x000007ff, 0x00000000,\n\t0x2285, 0xf000003f, 0x00000007,\n\t0x22fc, 0x00002001, 0x00000001,\n\t0x22c9, 0xffffffff, 0x00ffffff,\n\t0xc281, 0x0000ff0f, 0x00000000,\n\t0xa293, 0x07ffffff, 0x06000000,\n\t0x136, 0x00000fff, 0x00000100,\n\t0xf9e, 0x00000001, 0x00000002,\n\t0x2440, 0x03000000, 0x0362c688,\n\t0x2300, 0x000000ff, 0x00000001,\n\t0x390, 0x00001fff, 0x00001fff,\n\t0x2418, 0x0000007f, 0x00000020,\n\t0x2542, 0x00010000, 0x00010000,\n\t0x2b05, 0x000003ff, 0x000000f3,\n\t0x2b03, 0xffffffff, 0x00001032\n};\n\nstatic const u32 bonaire_mgcg_cgcg_init[] =\n{\n\t0x3108, 0xffffffff, 0xfffffffc,\n\t0xc200, 0xffffffff, 0xe0000000,\n\t0xf0a8, 0xffffffff, 0x00000100,\n\t0xf082, 0xffffffff, 0x00000100,\n\t0xf0b0, 0xffffffff, 0xc0000100,\n\t0xf0b2, 0xffffffff, 0xc0000100,\n\t0xf0b1, 0xffffffff, 0xc0000100,\n\t0x1579, 0xffffffff, 0x00600100,\n\t0xf0a0, 0xffffffff, 0x00000100,\n\t0xf085, 0xffffffff, 0x06000100,\n\t0xf088, 0xffffffff, 0x00000100,\n\t0xf086, 0xffffffff, 0x06000100,\n\t0xf081, 0xffffffff, 0x00000100,\n\t0xf0b8, 0xffffffff, 0x00000100,\n\t0xf089, 0xffffffff, 0x00000100,\n\t0xf080, 0xffffffff, 0x00000100,\n\t0xf08c, 0xffffffff, 0x00000100,\n\t0xf08d, 0xffffffff, 0x00000100,\n\t0xf094, 0xffffffff, 0x00000100,\n\t0xf095, 0xffffffff, 0x00000100,\n\t0xf096, 0xffffffff, 0x00000100,\n\t0xf097, 0xffffffff, 0x00000100,\n\t0xf098, 0xffffffff, 0x00000100,\n\t0xf09f, 0xffffffff, 0x00000100,\n\t0xf09e, 0xffffffff, 0x00000100,\n\t0xf084, 0xffffffff, 0x06000100,\n\t0xf0a4, 0xffffffff, 0x00000100,\n\t0xf09d, 0xffffffff, 0x00000100,\n\t0xf0ad, 0xffffffff, 0x00000100,\n\t0xf0ac, 0xffffffff, 0x00000100,\n\t0xf09c, 0xffffffff, 0x00000100,\n\t0xc200, 0xffffffff, 0xe0000000,\n\t0xf008, 0xffffffff, 0x00010000,\n\t0xf009, 0xffffffff, 0x00030002,\n\t0xf00a, 0xffffffff, 0x00040007,\n\t0xf00b, 0xffffffff, 0x00060005,\n\t0xf00c, 0xffffffff, 0x00090008,\n\t0xf00d, 0xffffffff, 0x00010000,\n\t0xf00e, 0xffffffff, 0x00030002,\n\t0xf00f, 0xffffffff, 0x00040007,\n\t0xf010, 0xffffffff, 0x00060005,\n\t0xf011, 0xffffffff, 0x00090008,\n\t0xf012, 0xffffffff, 0x00010000,\n\t0xf013, 0xffffffff, 0x00030002,\n\t0xf014, 0xffffffff, 0x00040007,\n\t0xf015, 0xffffffff, 0x00060005,\n\t0xf016, 0xffffffff, 0x00090008,\n\t0xf017, 0xffffffff, 0x00010000,\n\t0xf018, 0xffffffff, 0x00030002,\n\t0xf019, 0xffffffff, 0x00040007,\n\t0xf01a, 0xffffffff, 0x00060005,\n\t0xf01b, 0xffffffff, 0x00090008,\n\t0xf01c, 0xffffffff, 0x00010000,\n\t0xf01d, 0xffffffff, 0x00030002,\n\t0xf01e, 0xffffffff, 0x00040007,\n\t0xf01f, 0xffffffff, 0x00060005,\n\t0xf020, 0xffffffff, 0x00090008,\n\t0xf021, 0xffffffff, 0x00010000,\n\t0xf022, 0xffffffff, 0x00030002,\n\t0xf023, 0xffffffff, 0x00040007,\n\t0xf024, 0xffffffff, 0x00060005,\n\t0xf025, 0xffffffff, 0x00090008,\n\t0xf026, 0xffffffff, 0x00010000,\n\t0xf027, 0xffffffff, 0x00030002,\n\t0xf028, 0xffffffff, 0x00040007,\n\t0xf029, 0xffffffff, 0x00060005,\n\t0xf02a, 0xffffffff, 0x00090008,\n\t0xf000, 0xffffffff, 0x96e00200,\n\t0x21c2, 0xffffffff, 0x00900100,\n\t0x3109, 0xffffffff, 0x0020003f,\n\t0xe, 0xffffffff, 0x0140001c,\n\t0xf, 0x000f0000, 0x000f0000,\n\t0x88, 0xffffffff, 0xc060000c,\n\t0x89, 0xc0000fff, 0x00000100,\n\t0x3e4, 0xffffffff, 0x00000100,\n\t0x3e6, 0x00000101, 0x00000000,\n\t0x82a, 0xffffffff, 0x00000104,\n\t0x1579, 0xff000fff, 0x00000100,\n\t0xc33, 0xc0000fff, 0x00000104,\n\t0x3079, 0x00000001, 0x00000001,\n\t0x3403, 0xff000ff0, 0x00000100,\n\t0x3603, 0xff000ff0, 0x00000100\n};\n\nstatic const u32 spectre_golden_spm_registers[] =\n{\n\t0xc200, 0xe0ffffff, 0xe0000000\n};\n\nstatic const u32 spectre_golden_common_registers[] =\n{\n\t0x31dc, 0xffffffff, 0x00000800,\n\t0x31dd, 0xffffffff, 0x00000800,\n\t0x31e6, 0xffffffff, 0x00007fbf,\n\t0x31e7, 0xffffffff, 0x00007faf\n};\n\nstatic const u32 spectre_golden_registers[] =\n{\n\t0xf000, 0xffff1fff, 0x96940200,\n\t0xf003, 0xffff0001, 0xff000000,\n\t0xf080, 0xfffc0fff, 0x00000100,\n\t0x1bb6, 0x00010101, 0x00010000,\n\t0x260d, 0xf00fffff, 0x00000400,\n\t0x260e, 0xfffffffc, 0x00020200,\n\t0x16ec, 0x000000f0, 0x00000070,\n\t0x16f0, 0xf0311fff, 0x80300000,\n\t0x263e, 0x73773777, 0x12010001,\n\t0x26df, 0x00ff0000, 0x00fc0000,\n\t0xbd2, 0x73773777, 0x12010001,\n\t0x2285, 0xf000003f, 0x00000007,\n\t0x22c9, 0xffffffff, 0x00ffffff,\n\t0xa0d4, 0x3f3f3fff, 0x00000082,\n\t0xa0d5, 0x0000003f, 0x00000000,\n\t0xf9e, 0x00000001, 0x00000002,\n\t0x244f, 0xffff03df, 0x00000004,\n\t0x31da, 0x00000008, 0x00000008,\n\t0x2300, 0x000008ff, 0x00000800,\n\t0x2542, 0x00010000, 0x00010000,\n\t0x2b03, 0xffffffff, 0x54763210,\n\t0x853e, 0x01ff01ff, 0x00000002,\n\t0x8526, 0x007ff800, 0x00200000,\n\t0x8057, 0xffffffff, 0x00000f40,\n\t0xc24d, 0xffffffff, 0x00000001\n};\n\nstatic const u32 spectre_mgcg_cgcg_init[] =\n{\n\t0x3108, 0xffffffff, 0xfffffffc,\n\t0xc200, 0xffffffff, 0xe0000000,\n\t0xf0a8, 0xffffffff, 0x00000100,\n\t0xf082, 0xffffffff, 0x00000100,\n\t0xf0b0, 0xffffffff, 0x00000100,\n\t0xf0b2, 0xffffffff, 0x00000100,\n\t0xf0b1, 0xffffffff, 0x00000100,\n\t0x1579, 0xffffffff, 0x00600100,\n\t0xf0a0, 0xffffffff, 0x00000100,\n\t0xf085, 0xffffffff, 0x06000100,\n\t0xf088, 0xffffffff, 0x00000100,\n\t0xf086, 0xffffffff, 0x06000100,\n\t0xf081, 0xffffffff, 0x00000100,\n\t0xf0b8, 0xffffffff, 0x00000100,\n\t0xf089, 0xffffffff, 0x00000100,\n\t0xf080, 0xffffffff, 0x00000100,\n\t0xf08c, 0xffffffff, 0x00000100,\n\t0xf08d, 0xffffffff, 0x00000100,\n\t0xf094, 0xffffffff, 0x00000100,\n\t0xf095, 0xffffffff, 0x00000100,\n\t0xf096, 0xffffffff, 0x00000100,\n\t0xf097, 0xffffffff, 0x00000100,\n\t0xf098, 0xffffffff, 0x00000100,\n\t0xf09f, 0xffffffff, 0x00000100,\n\t0xf09e, 0xffffffff, 0x00000100,\n\t0xf084, 0xffffffff, 0x06000100,\n\t0xf0a4, 0xffffffff, 0x00000100,\n\t0xf09d, 0xffffffff, 0x00000100,\n\t0xf0ad, 0xffffffff, 0x00000100,\n\t0xf0ac, 0xffffffff, 0x00000100,\n\t0xf09c, 0xffffffff, 0x00000100,\n\t0xc200, 0xffffffff, 0xe0000000,\n\t0xf008, 0xffffffff, 0x00010000,\n\t0xf009, 0xffffffff, 0x00030002,\n\t0xf00a, 0xffffffff, 0x00040007,\n\t0xf00b, 0xffffffff, 0x00060005,\n\t0xf00c, 0xffffffff, 0x00090008,\n\t0xf00d, 0xffffffff, 0x00010000,\n\t0xf00e, 0xffffffff, 0x00030002,\n\t0xf00f, 0xffffffff, 0x00040007,\n\t0xf010, 0xffffffff, 0x00060005,\n\t0xf011, 0xffffffff, 0x00090008,\n\t0xf012, 0xffffffff, 0x00010000,\n\t0xf013, 0xffffffff, 0x00030002,\n\t0xf014, 0xffffffff, 0x00040007,\n\t0xf015, 0xffffffff, 0x00060005,\n\t0xf016, 0xffffffff, 0x00090008,\n\t0xf017, 0xffffffff, 0x00010000,\n\t0xf018, 0xffffffff, 0x00030002,\n\t0xf019, 0xffffffff, 0x00040007,\n\t0xf01a, 0xffffffff, 0x00060005,\n\t0xf01b, 0xffffffff, 0x00090008,\n\t0xf01c, 0xffffffff, 0x00010000,\n\t0xf01d, 0xffffffff, 0x00030002,\n\t0xf01e, 0xffffffff, 0x00040007,\n\t0xf01f, 0xffffffff, 0x00060005,\n\t0xf020, 0xffffffff, 0x00090008,\n\t0xf021, 0xffffffff, 0x00010000,\n\t0xf022, 0xffffffff, 0x00030002,\n\t0xf023, 0xffffffff, 0x00040007,\n\t0xf024, 0xffffffff, 0x00060005,\n\t0xf025, 0xffffffff, 0x00090008,\n\t0xf026, 0xffffffff, 0x00010000,\n\t0xf027, 0xffffffff, 0x00030002,\n\t0xf028, 0xffffffff, 0x00040007,\n\t0xf029, 0xffffffff, 0x00060005,\n\t0xf02a, 0xffffffff, 0x00090008,\n\t0xf02b, 0xffffffff, 0x00010000,\n\t0xf02c, 0xffffffff, 0x00030002,\n\t0xf02d, 0xffffffff, 0x00040007,\n\t0xf02e, 0xffffffff, 0x00060005,\n\t0xf02f, 0xffffffff, 0x00090008,\n\t0xf000, 0xffffffff, 0x96e00200,\n\t0x21c2, 0xffffffff, 0x00900100,\n\t0x3109, 0xffffffff, 0x0020003f,\n\t0xe, 0xffffffff, 0x0140001c,\n\t0xf, 0x000f0000, 0x000f0000,\n\t0x88, 0xffffffff, 0xc060000c,\n\t0x89, 0xc0000fff, 0x00000100,\n\t0x3e4, 0xffffffff, 0x00000100,\n\t0x3e6, 0x00000101, 0x00000000,\n\t0x82a, 0xffffffff, 0x00000104,\n\t0x1579, 0xff000fff, 0x00000100,\n\t0xc33, 0xc0000fff, 0x00000104,\n\t0x3079, 0x00000001, 0x00000001,\n\t0x3403, 0xff000ff0, 0x00000100,\n\t0x3603, 0xff000ff0, 0x00000100\n};\n\nstatic const u32 kalindi_golden_spm_registers[] =\n{\n\t0xc200, 0xe0ffffff, 0xe0000000\n};\n\nstatic const u32 kalindi_golden_common_registers[] =\n{\n\t0x31dc, 0xffffffff, 0x00000800,\n\t0x31dd, 0xffffffff, 0x00000800,\n\t0x31e6, 0xffffffff, 0x00007fbf,\n\t0x31e7, 0xffffffff, 0x00007faf\n};\n\nstatic const u32 kalindi_golden_registers[] =\n{\n\t0xf000, 0xffffdfff, 0x6e944040,\n\t0x1579, 0xff607fff, 0xfc000100,\n\t0xf088, 0xff000fff, 0x00000100,\n\t0xf089, 0xff000fff, 0x00000100,\n\t0xf080, 0xfffc0fff, 0x00000100,\n\t0x1bb6, 0x00010101, 0x00010000,\n\t0x260c, 0xffffffff, 0x00000000,\n\t0x260d, 0xf00fffff, 0x00000400,\n\t0x16ec, 0x000000f0, 0x00000070,\n\t0x16f0, 0xf0311fff, 0x80300000,\n\t0x263e, 0x73773777, 0x12010001,\n\t0x263f, 0xffffffff, 0x00000010,\n\t0x26df, 0x00ff0000, 0x00fc0000,\n\t0x200c, 0x00001f0f, 0x0000100a,\n\t0xbd2, 0x73773777, 0x12010001,\n\t0x902, 0x000fffff, 0x000c007f,\n\t0x2285, 0xf000003f, 0x00000007,\n\t0x22c9, 0x3fff3fff, 0x00ffcfff,\n\t0xc281, 0x0000ff0f, 0x00000000,\n\t0xa293, 0x07ffffff, 0x06000000,\n\t0x136, 0x00000fff, 0x00000100,\n\t0xf9e, 0x00000001, 0x00000002,\n\t0x31da, 0x00000008, 0x00000008,\n\t0x2300, 0x000000ff, 0x00000003,\n\t0x853e, 0x01ff01ff, 0x00000002,\n\t0x8526, 0x007ff800, 0x00200000,\n\t0x8057, 0xffffffff, 0x00000f40,\n\t0x2231, 0x001f3ae3, 0x00000082,\n\t0x2235, 0x0000001f, 0x00000010,\n\t0xc24d, 0xffffffff, 0x00000000\n};\n\nstatic const u32 kalindi_mgcg_cgcg_init[] =\n{\n\t0x3108, 0xffffffff, 0xfffffffc,\n\t0xc200, 0xffffffff, 0xe0000000,\n\t0xf0a8, 0xffffffff, 0x00000100,\n\t0xf082, 0xffffffff, 0x00000100,\n\t0xf0b0, 0xffffffff, 0x00000100,\n\t0xf0b2, 0xffffffff, 0x00000100,\n\t0xf0b1, 0xffffffff, 0x00000100,\n\t0x1579, 0xffffffff, 0x00600100,\n\t0xf0a0, 0xffffffff, 0x00000100,\n\t0xf085, 0xffffffff, 0x06000100,\n\t0xf088, 0xffffffff, 0x00000100,\n\t0xf086, 0xffffffff, 0x06000100,\n\t0xf081, 0xffffffff, 0x00000100,\n\t0xf0b8, 0xffffffff, 0x00000100,\n\t0xf089, 0xffffffff, 0x00000100,\n\t0xf080, 0xffffffff, 0x00000100,\n\t0xf08c, 0xffffffff, 0x00000100,\n\t0xf08d, 0xffffffff, 0x00000100,\n\t0xf094, 0xffffffff, 0x00000100,\n\t0xf095, 0xffffffff, 0x00000100,\n\t0xf096, 0xffffffff, 0x00000100,\n\t0xf097, 0xffffffff, 0x00000100,\n\t0xf098, 0xffffffff, 0x00000100,\n\t0xf09f, 0xffffffff, 0x00000100,\n\t0xf09e, 0xffffffff, 0x00000100,\n\t0xf084, 0xffffffff, 0x06000100,\n\t0xf0a4, 0xffffffff, 0x00000100,\n\t0xf09d, 0xffffffff, 0x00000100,\n\t0xf0ad, 0xffffffff, 0x00000100,\n\t0xf0ac, 0xffffffff, 0x00000100,\n\t0xf09c, 0xffffffff, 0x00000100,\n\t0xc200, 0xffffffff, 0xe0000000,\n\t0xf008, 0xffffffff, 0x00010000,\n\t0xf009, 0xffffffff, 0x00030002,\n\t0xf00a, 0xffffffff, 0x00040007,\n\t0xf00b, 0xffffffff, 0x00060005,\n\t0xf00c, 0xffffffff, 0x00090008,\n\t0xf00d, 0xffffffff, 0x00010000,\n\t0xf00e, 0xffffffff, 0x00030002,\n\t0xf00f, 0xffffffff, 0x00040007,\n\t0xf010, 0xffffffff, 0x00060005,\n\t0xf011, 0xffffffff, 0x00090008,\n\t0xf000, 0xffffffff, 0x96e00200,\n\t0x21c2, 0xffffffff, 0x00900100,\n\t0x3109, 0xffffffff, 0x0020003f,\n\t0xe, 0xffffffff, 0x0140001c,\n\t0xf, 0x000f0000, 0x000f0000,\n\t0x88, 0xffffffff, 0xc060000c,\n\t0x89, 0xc0000fff, 0x00000100,\n\t0x82a, 0xffffffff, 0x00000104,\n\t0x1579, 0xff000fff, 0x00000100,\n\t0xc33, 0xc0000fff, 0x00000104,\n\t0x3079, 0x00000001, 0x00000001,\n\t0x3403, 0xff000ff0, 0x00000100,\n\t0x3603, 0xff000ff0, 0x00000100\n};\n\nstatic const u32 hawaii_golden_spm_registers[] =\n{\n\t0xc200, 0xe0ffffff, 0xe0000000\n};\n\nstatic const u32 hawaii_golden_common_registers[] =\n{\n\t0xc200, 0xffffffff, 0xe0000000,\n\t0xa0d4, 0xffffffff, 0x3a00161a,\n\t0xa0d5, 0xffffffff, 0x0000002e,\n\t0x2684, 0xffffffff, 0x00018208,\n\t0x263e, 0xffffffff, 0x12011003\n};\n\nstatic const u32 hawaii_golden_registers[] =\n{\n\t0xcd5, 0x00000333, 0x00000333,\n\t0x2684, 0x00010000, 0x00058208,\n\t0x260c, 0xffffffff, 0x00000000,\n\t0x260d, 0xf00fffff, 0x00000400,\n\t0x260e, 0x0002021c, 0x00020200,\n\t0x31e, 0x00000080, 0x00000000,\n\t0x16ec, 0x000000f0, 0x00000070,\n\t0x16f0, 0xf0311fff, 0x80300000,\n\t0xd43, 0x00810000, 0x408af000,\n\t0x1c0c, 0x31000111, 0x00000011,\n\t0xbd2, 0x73773777, 0x12010001,\n\t0x848, 0x0000007f, 0x0000001b,\n\t0x877, 0x00007fb6, 0x00002191,\n\t0xd8a, 0x0000003f, 0x0000000a,\n\t0xd8b, 0x0000003f, 0x0000000a,\n\t0xab9, 0x00073ffe, 0x000022a2,\n\t0x903, 0x000007ff, 0x00000000,\n\t0x22fc, 0x00002001, 0x00000001,\n\t0x22c9, 0xffffffff, 0x00ffffff,\n\t0xc281, 0x0000ff0f, 0x00000000,\n\t0xa293, 0x07ffffff, 0x06000000,\n\t0xf9e, 0x00000001, 0x00000002,\n\t0x31da, 0x00000008, 0x00000008,\n\t0x31dc, 0x00000f00, 0x00000800,\n\t0x31dd, 0x00000f00, 0x00000800,\n\t0x31e6, 0x00ffffff, 0x00ff7fbf,\n\t0x31e7, 0x00ffffff, 0x00ff7faf,\n\t0x2300, 0x000000ff, 0x00000800,\n\t0x390, 0x00001fff, 0x00001fff,\n\t0x2418, 0x0000007f, 0x00000020,\n\t0x2542, 0x00010000, 0x00010000,\n\t0x2b80, 0x00100000, 0x000ff07c,\n\t0x2b05, 0x000003ff, 0x0000000f,\n\t0x2b04, 0xffffffff, 0x7564fdec,\n\t0x2b03, 0xffffffff, 0x3120b9a8,\n\t0x2b02, 0x20000000, 0x0f9c0000\n};\n\nstatic const u32 hawaii_mgcg_cgcg_init[] =\n{\n\t0x3108, 0xffffffff, 0xfffffffd,\n\t0xc200, 0xffffffff, 0xe0000000,\n\t0xf0a8, 0xffffffff, 0x00000100,\n\t0xf082, 0xffffffff, 0x00000100,\n\t0xf0b0, 0xffffffff, 0x00000100,\n\t0xf0b2, 0xffffffff, 0x00000100,\n\t0xf0b1, 0xffffffff, 0x00000100,\n\t0x1579, 0xffffffff, 0x00200100,\n\t0xf0a0, 0xffffffff, 0x00000100,\n\t0xf085, 0xffffffff, 0x06000100,\n\t0xf088, 0xffffffff, 0x00000100,\n\t0xf086, 0xffffffff, 0x06000100,\n\t0xf081, 0xffffffff, 0x00000100,\n\t0xf0b8, 0xffffffff, 0x00000100,\n\t0xf089, 0xffffffff, 0x00000100,\n\t0xf080, 0xffffffff, 0x00000100,\n\t0xf08c, 0xffffffff, 0x00000100,\n\t0xf08d, 0xffffffff, 0x00000100,\n\t0xf094, 0xffffffff, 0x00000100,\n\t0xf095, 0xffffffff, 0x00000100,\n\t0xf096, 0xffffffff, 0x00000100,\n\t0xf097, 0xffffffff, 0x00000100,\n\t0xf098, 0xffffffff, 0x00000100,\n\t0xf09f, 0xffffffff, 0x00000100,\n\t0xf09e, 0xffffffff, 0x00000100,\n\t0xf084, 0xffffffff, 0x06000100,\n\t0xf0a4, 0xffffffff, 0x00000100,\n\t0xf09d, 0xffffffff, 0x00000100,\n\t0xf0ad, 0xffffffff, 0x00000100,\n\t0xf0ac, 0xffffffff, 0x00000100,\n\t0xf09c, 0xffffffff, 0x00000100,\n\t0xc200, 0xffffffff, 0xe0000000,\n\t0xf008, 0xffffffff, 0x00010000,\n\t0xf009, 0xffffffff, 0x00030002,\n\t0xf00a, 0xffffffff, 0x00040007,\n\t0xf00b, 0xffffffff, 0x00060005,\n\t0xf00c, 0xffffffff, 0x00090008,\n\t0xf00d, 0xffffffff, 0x00010000,\n\t0xf00e, 0xffffffff, 0x00030002,\n\t0xf00f, 0xffffffff, 0x00040007,\n\t0xf010, 0xffffffff, 0x00060005,\n\t0xf011, 0xffffffff, 0x00090008,\n\t0xf012, 0xffffffff, 0x00010000,\n\t0xf013, 0xffffffff, 0x00030002,\n\t0xf014, 0xffffffff, 0x00040007,\n\t0xf015, 0xffffffff, 0x00060005,\n\t0xf016, 0xffffffff, 0x00090008,\n\t0xf017, 0xffffffff, 0x00010000,\n\t0xf018, 0xffffffff, 0x00030002,\n\t0xf019, 0xffffffff, 0x00040007,\n\t0xf01a, 0xffffffff, 0x00060005,\n\t0xf01b, 0xffffffff, 0x00090008,\n\t0xf01c, 0xffffffff, 0x00010000,\n\t0xf01d, 0xffffffff, 0x00030002,\n\t0xf01e, 0xffffffff, 0x00040007,\n\t0xf01f, 0xffffffff, 0x00060005,\n\t0xf020, 0xffffffff, 0x00090008,\n\t0xf021, 0xffffffff, 0x00010000,\n\t0xf022, 0xffffffff, 0x00030002,\n\t0xf023, 0xffffffff, 0x00040007,\n\t0xf024, 0xffffffff, 0x00060005,\n\t0xf025, 0xffffffff, 0x00090008,\n\t0xf026, 0xffffffff, 0x00010000,\n\t0xf027, 0xffffffff, 0x00030002,\n\t0xf028, 0xffffffff, 0x00040007,\n\t0xf029, 0xffffffff, 0x00060005,\n\t0xf02a, 0xffffffff, 0x00090008,\n\t0xf02b, 0xffffffff, 0x00010000,\n\t0xf02c, 0xffffffff, 0x00030002,\n\t0xf02d, 0xffffffff, 0x00040007,\n\t0xf02e, 0xffffffff, 0x00060005,\n\t0xf02f, 0xffffffff, 0x00090008,\n\t0xf030, 0xffffffff, 0x00010000,\n\t0xf031, 0xffffffff, 0x00030002,\n\t0xf032, 0xffffffff, 0x00040007,\n\t0xf033, 0xffffffff, 0x00060005,\n\t0xf034, 0xffffffff, 0x00090008,\n\t0xf035, 0xffffffff, 0x00010000,\n\t0xf036, 0xffffffff, 0x00030002,\n\t0xf037, 0xffffffff, 0x00040007,\n\t0xf038, 0xffffffff, 0x00060005,\n\t0xf039, 0xffffffff, 0x00090008,\n\t0xf03a, 0xffffffff, 0x00010000,\n\t0xf03b, 0xffffffff, 0x00030002,\n\t0xf03c, 0xffffffff, 0x00040007,\n\t0xf03d, 0xffffffff, 0x00060005,\n\t0xf03e, 0xffffffff, 0x00090008,\n\t0x30c6, 0xffffffff, 0x00020200,\n\t0xcd4, 0xffffffff, 0x00000200,\n\t0x570, 0xffffffff, 0x00000400,\n\t0x157a, 0xffffffff, 0x00000000,\n\t0xbd4, 0xffffffff, 0x00000902,\n\t0xf000, 0xffffffff, 0x96940200,\n\t0x21c2, 0xffffffff, 0x00900100,\n\t0x3109, 0xffffffff, 0x0020003f,\n\t0xe, 0xffffffff, 0x0140001c,\n\t0xf, 0x000f0000, 0x000f0000,\n\t0x88, 0xffffffff, 0xc060000c,\n\t0x89, 0xc0000fff, 0x00000100,\n\t0x3e4, 0xffffffff, 0x00000100,\n\t0x3e6, 0x00000101, 0x00000000,\n\t0x82a, 0xffffffff, 0x00000104,\n\t0x1579, 0xff000fff, 0x00000100,\n\t0xc33, 0xc0000fff, 0x00000104,\n\t0x3079, 0x00000001, 0x00000001,\n\t0x3403, 0xff000ff0, 0x00000100,\n\t0x3603, 0xff000ff0, 0x00000100\n};\n\nstatic const u32 godavari_golden_registers[] =\n{\n\t0x1579, 0xff607fff, 0xfc000100,\n\t0x1bb6, 0x00010101, 0x00010000,\n\t0x260c, 0xffffffff, 0x00000000,\n\t0x260c0, 0xf00fffff, 0x00000400,\n\t0x184c, 0xffffffff, 0x00010000,\n\t0x16ec, 0x000000f0, 0x00000070,\n\t0x16f0, 0xf0311fff, 0x80300000,\n\t0x263e, 0x73773777, 0x12010001,\n\t0x263f, 0xffffffff, 0x00000010,\n\t0x200c, 0x00001f0f, 0x0000100a,\n\t0xbd2, 0x73773777, 0x12010001,\n\t0x902, 0x000fffff, 0x000c007f,\n\t0x2285, 0xf000003f, 0x00000007,\n\t0x22c9, 0xffffffff, 0x00ff0fff,\n\t0xc281, 0x0000ff0f, 0x00000000,\n\t0xa293, 0x07ffffff, 0x06000000,\n\t0x136, 0x00000fff, 0x00000100,\n\t0x3405, 0x00010000, 0x00810001,\n\t0x3605, 0x00010000, 0x00810001,\n\t0xf9e, 0x00000001, 0x00000002,\n\t0x31da, 0x00000008, 0x00000008,\n\t0x31dc, 0x00000f00, 0x00000800,\n\t0x31dd, 0x00000f00, 0x00000800,\n\t0x31e6, 0x00ffffff, 0x00ff7fbf,\n\t0x31e7, 0x00ffffff, 0x00ff7faf,\n\t0x2300, 0x000000ff, 0x00000001,\n\t0x853e, 0x01ff01ff, 0x00000002,\n\t0x8526, 0x007ff800, 0x00200000,\n\t0x8057, 0xffffffff, 0x00000f40,\n\t0x2231, 0x001f3ae3, 0x00000082,\n\t0x2235, 0x0000001f, 0x00000010,\n\t0xc24d, 0xffffffff, 0x00000000\n};\n\nstatic void cik_init_golden_registers(struct amdgpu_device *adev)\n{\n\t \n\tmutex_lock(&adev->grbm_idx_mutex);\n\n\tswitch (adev->asic_type) {\n\tcase CHIP_BONAIRE:\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tbonaire_mgcg_cgcg_init,\n\t\t\t\t\t\t\tARRAY_SIZE(bonaire_mgcg_cgcg_init));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tbonaire_golden_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(bonaire_golden_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tbonaire_golden_common_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(bonaire_golden_common_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tbonaire_golden_spm_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(bonaire_golden_spm_registers));\n\t\tbreak;\n\tcase CHIP_KABINI:\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tkalindi_mgcg_cgcg_init,\n\t\t\t\t\t\t\tARRAY_SIZE(kalindi_mgcg_cgcg_init));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tkalindi_golden_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(kalindi_golden_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tkalindi_golden_common_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(kalindi_golden_common_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tkalindi_golden_spm_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(kalindi_golden_spm_registers));\n\t\tbreak;\n\tcase CHIP_MULLINS:\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tkalindi_mgcg_cgcg_init,\n\t\t\t\t\t\t\tARRAY_SIZE(kalindi_mgcg_cgcg_init));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tgodavari_golden_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(godavari_golden_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tkalindi_golden_common_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(kalindi_golden_common_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tkalindi_golden_spm_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(kalindi_golden_spm_registers));\n\t\tbreak;\n\tcase CHIP_KAVERI:\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tspectre_mgcg_cgcg_init,\n\t\t\t\t\t\t\tARRAY_SIZE(spectre_mgcg_cgcg_init));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tspectre_golden_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(spectre_golden_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tspectre_golden_common_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(spectre_golden_common_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\tspectre_golden_spm_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(spectre_golden_spm_registers));\n\t\tbreak;\n\tcase CHIP_HAWAII:\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\thawaii_mgcg_cgcg_init,\n\t\t\t\t\t\t\tARRAY_SIZE(hawaii_mgcg_cgcg_init));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\thawaii_golden_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(hawaii_golden_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\thawaii_golden_common_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(hawaii_golden_common_registers));\n\t\tamdgpu_device_program_register_sequence(adev,\n\t\t\t\t\t\t\thawaii_golden_spm_registers,\n\t\t\t\t\t\t\tARRAY_SIZE(hawaii_golden_spm_registers));\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tmutex_unlock(&adev->grbm_idx_mutex);\n}\n\n \nstatic u32 cik_get_xclk(struct amdgpu_device *adev)\n{\n\tu32 reference_clock = adev->clock.spll.reference_freq;\n\n\tif (adev->flags & AMD_IS_APU) {\n\t\tif (RREG32_SMC(ixGENERAL_PWRMGT) & GENERAL_PWRMGT__GPU_COUNTER_CLK_MASK)\n\t\t\treturn reference_clock / 2;\n\t} else {\n\t\tif (RREG32_SMC(ixCG_CLKPIN_CNTL) & CG_CLKPIN_CNTL__XTALIN_DIVIDE_MASK)\n\t\t\treturn reference_clock / 4;\n\t}\n\treturn reference_clock;\n}\n\n \nvoid cik_srbm_select(struct amdgpu_device *adev,\n\t\t     u32 me, u32 pipe, u32 queue, u32 vmid)\n{\n\tu32 srbm_gfx_cntl =\n\t\t(((pipe << SRBM_GFX_CNTL__PIPEID__SHIFT) & SRBM_GFX_CNTL__PIPEID_MASK)|\n\t\t((me << SRBM_GFX_CNTL__MEID__SHIFT) & SRBM_GFX_CNTL__MEID_MASK)|\n\t\t((vmid << SRBM_GFX_CNTL__VMID__SHIFT) & SRBM_GFX_CNTL__VMID_MASK)|\n\t\t((queue << SRBM_GFX_CNTL__QUEUEID__SHIFT) & SRBM_GFX_CNTL__QUEUEID_MASK));\n\tWREG32(mmSRBM_GFX_CNTL, srbm_gfx_cntl);\n}\n\nstatic void cik_vga_set_state(struct amdgpu_device *adev, bool state)\n{\n\tuint32_t tmp;\n\n\ttmp = RREG32(mmCONFIG_CNTL);\n\tif (!state)\n\t\ttmp |= CONFIG_CNTL__VGA_DIS_MASK;\n\telse\n\t\ttmp &= ~CONFIG_CNTL__VGA_DIS_MASK;\n\tWREG32(mmCONFIG_CNTL, tmp);\n}\n\nstatic bool cik_read_disabled_bios(struct amdgpu_device *adev)\n{\n\tu32 bus_cntl;\n\tu32 d1vga_control = 0;\n\tu32 d2vga_control = 0;\n\tu32 vga_render_control = 0;\n\tu32 rom_cntl;\n\tbool r;\n\n\tbus_cntl = RREG32(mmBUS_CNTL);\n\tif (adev->mode_info.num_crtc) {\n\t\td1vga_control = RREG32(mmD1VGA_CONTROL);\n\t\td2vga_control = RREG32(mmD2VGA_CONTROL);\n\t\tvga_render_control = RREG32(mmVGA_RENDER_CONTROL);\n\t}\n\trom_cntl = RREG32_SMC(ixROM_CNTL);\n\n\t \n\tWREG32(mmBUS_CNTL, (bus_cntl & ~BUS_CNTL__BIOS_ROM_DIS_MASK));\n\tif (adev->mode_info.num_crtc) {\n\t\t \n\t\tWREG32(mmD1VGA_CONTROL,\n\t\t       (d1vga_control & ~(D1VGA_CONTROL__D1VGA_MODE_ENABLE_MASK |\n\t\t\t\t\t  D1VGA_CONTROL__D1VGA_TIMING_SELECT_MASK)));\n\t\tWREG32(mmD2VGA_CONTROL,\n\t\t       (d2vga_control & ~(D1VGA_CONTROL__D1VGA_MODE_ENABLE_MASK |\n\t\t\t\t\t  D1VGA_CONTROL__D1VGA_TIMING_SELECT_MASK)));\n\t\tWREG32(mmVGA_RENDER_CONTROL,\n\t\t       (vga_render_control & ~VGA_RENDER_CONTROL__VGA_VSTATUS_CNTL_MASK));\n\t}\n\tWREG32_SMC(ixROM_CNTL, rom_cntl | ROM_CNTL__SCK_OVERWRITE_MASK);\n\n\tr = amdgpu_read_bios(adev);\n\n\t \n\tWREG32(mmBUS_CNTL, bus_cntl);\n\tif (adev->mode_info.num_crtc) {\n\t\tWREG32(mmD1VGA_CONTROL, d1vga_control);\n\t\tWREG32(mmD2VGA_CONTROL, d2vga_control);\n\t\tWREG32(mmVGA_RENDER_CONTROL, vga_render_control);\n\t}\n\tWREG32_SMC(ixROM_CNTL, rom_cntl);\n\treturn r;\n}\n\nstatic bool cik_read_bios_from_rom(struct amdgpu_device *adev,\n\t\t\t\t   u8 *bios, u32 length_bytes)\n{\n\tu32 *dw_ptr;\n\tunsigned long flags;\n\tu32 i, length_dw;\n\n\tif (bios == NULL)\n\t\treturn false;\n\tif (length_bytes == 0)\n\t\treturn false;\n\t \n\tif (adev->flags & AMD_IS_APU)\n\t\treturn false;\n\n\tdw_ptr = (u32 *)bios;\n\tlength_dw = ALIGN(length_bytes, 4) / 4;\n\t \n\tspin_lock_irqsave(&adev->smc_idx_lock, flags);\n\t \n\tWREG32(mmSMC_IND_INDEX_0, ixROM_INDEX);\n\tWREG32(mmSMC_IND_DATA_0, 0);\n\t \n\tWREG32(mmSMC_IND_INDEX_0, ixROM_DATA);\n\tfor (i = 0; i < length_dw; i++)\n\t\tdw_ptr[i] = RREG32(mmSMC_IND_DATA_0);\n\tspin_unlock_irqrestore(&adev->smc_idx_lock, flags);\n\n\treturn true;\n}\n\nstatic const struct amdgpu_allowed_register_entry cik_allowed_read_registers[] = {\n\t{mmGRBM_STATUS},\n\t{mmGRBM_STATUS2},\n\t{mmGRBM_STATUS_SE0},\n\t{mmGRBM_STATUS_SE1},\n\t{mmGRBM_STATUS_SE2},\n\t{mmGRBM_STATUS_SE3},\n\t{mmSRBM_STATUS},\n\t{mmSRBM_STATUS2},\n\t{mmSDMA0_STATUS_REG + SDMA0_REGISTER_OFFSET},\n\t{mmSDMA0_STATUS_REG + SDMA1_REGISTER_OFFSET},\n\t{mmCP_STAT},\n\t{mmCP_STALLED_STAT1},\n\t{mmCP_STALLED_STAT2},\n\t{mmCP_STALLED_STAT3},\n\t{mmCP_CPF_BUSY_STAT},\n\t{mmCP_CPF_STALLED_STAT1},\n\t{mmCP_CPF_STATUS},\n\t{mmCP_CPC_BUSY_STAT},\n\t{mmCP_CPC_STALLED_STAT1},\n\t{mmCP_CPC_STATUS},\n\t{mmGB_ADDR_CONFIG},\n\t{mmMC_ARB_RAMCFG},\n\t{mmGB_TILE_MODE0},\n\t{mmGB_TILE_MODE1},\n\t{mmGB_TILE_MODE2},\n\t{mmGB_TILE_MODE3},\n\t{mmGB_TILE_MODE4},\n\t{mmGB_TILE_MODE5},\n\t{mmGB_TILE_MODE6},\n\t{mmGB_TILE_MODE7},\n\t{mmGB_TILE_MODE8},\n\t{mmGB_TILE_MODE9},\n\t{mmGB_TILE_MODE10},\n\t{mmGB_TILE_MODE11},\n\t{mmGB_TILE_MODE12},\n\t{mmGB_TILE_MODE13},\n\t{mmGB_TILE_MODE14},\n\t{mmGB_TILE_MODE15},\n\t{mmGB_TILE_MODE16},\n\t{mmGB_TILE_MODE17},\n\t{mmGB_TILE_MODE18},\n\t{mmGB_TILE_MODE19},\n\t{mmGB_TILE_MODE20},\n\t{mmGB_TILE_MODE21},\n\t{mmGB_TILE_MODE22},\n\t{mmGB_TILE_MODE23},\n\t{mmGB_TILE_MODE24},\n\t{mmGB_TILE_MODE25},\n\t{mmGB_TILE_MODE26},\n\t{mmGB_TILE_MODE27},\n\t{mmGB_TILE_MODE28},\n\t{mmGB_TILE_MODE29},\n\t{mmGB_TILE_MODE30},\n\t{mmGB_TILE_MODE31},\n\t{mmGB_MACROTILE_MODE0},\n\t{mmGB_MACROTILE_MODE1},\n\t{mmGB_MACROTILE_MODE2},\n\t{mmGB_MACROTILE_MODE3},\n\t{mmGB_MACROTILE_MODE4},\n\t{mmGB_MACROTILE_MODE5},\n\t{mmGB_MACROTILE_MODE6},\n\t{mmGB_MACROTILE_MODE7},\n\t{mmGB_MACROTILE_MODE8},\n\t{mmGB_MACROTILE_MODE9},\n\t{mmGB_MACROTILE_MODE10},\n\t{mmGB_MACROTILE_MODE11},\n\t{mmGB_MACROTILE_MODE12},\n\t{mmGB_MACROTILE_MODE13},\n\t{mmGB_MACROTILE_MODE14},\n\t{mmGB_MACROTILE_MODE15},\n\t{mmCC_RB_BACKEND_DISABLE, true},\n\t{mmGC_USER_RB_BACKEND_DISABLE, true},\n\t{mmGB_BACKEND_MAP, false},\n\t{mmPA_SC_RASTER_CONFIG, true},\n\t{mmPA_SC_RASTER_CONFIG_1, true},\n};\n\n\nstatic uint32_t cik_get_register_value(struct amdgpu_device *adev,\n\t\t\t\t       bool indexed, u32 se_num,\n\t\t\t\t       u32 sh_num, u32 reg_offset)\n{\n\tif (indexed) {\n\t\tuint32_t val;\n\t\tunsigned se_idx = (se_num == 0xffffffff) ? 0 : se_num;\n\t\tunsigned sh_idx = (sh_num == 0xffffffff) ? 0 : sh_num;\n\n\t\tswitch (reg_offset) {\n\t\tcase mmCC_RB_BACKEND_DISABLE:\n\t\t\treturn adev->gfx.config.rb_config[se_idx][sh_idx].rb_backend_disable;\n\t\tcase mmGC_USER_RB_BACKEND_DISABLE:\n\t\t\treturn adev->gfx.config.rb_config[se_idx][sh_idx].user_rb_backend_disable;\n\t\tcase mmPA_SC_RASTER_CONFIG:\n\t\t\treturn adev->gfx.config.rb_config[se_idx][sh_idx].raster_config;\n\t\tcase mmPA_SC_RASTER_CONFIG_1:\n\t\t\treturn adev->gfx.config.rb_config[se_idx][sh_idx].raster_config_1;\n\t\t}\n\n\t\tmutex_lock(&adev->grbm_idx_mutex);\n\t\tif (se_num != 0xffffffff || sh_num != 0xffffffff)\n\t\t\tamdgpu_gfx_select_se_sh(adev, se_num, sh_num, 0xffffffff, 0);\n\n\t\tval = RREG32(reg_offset);\n\n\t\tif (se_num != 0xffffffff || sh_num != 0xffffffff)\n\t\t\tamdgpu_gfx_select_se_sh(adev, 0xffffffff, 0xffffffff, 0xffffffff, 0);\n\t\tmutex_unlock(&adev->grbm_idx_mutex);\n\t\treturn val;\n\t} else {\n\t\tunsigned idx;\n\n\t\tswitch (reg_offset) {\n\t\tcase mmGB_ADDR_CONFIG:\n\t\t\treturn adev->gfx.config.gb_addr_config;\n\t\tcase mmMC_ARB_RAMCFG:\n\t\t\treturn adev->gfx.config.mc_arb_ramcfg;\n\t\tcase mmGB_TILE_MODE0:\n\t\tcase mmGB_TILE_MODE1:\n\t\tcase mmGB_TILE_MODE2:\n\t\tcase mmGB_TILE_MODE3:\n\t\tcase mmGB_TILE_MODE4:\n\t\tcase mmGB_TILE_MODE5:\n\t\tcase mmGB_TILE_MODE6:\n\t\tcase mmGB_TILE_MODE7:\n\t\tcase mmGB_TILE_MODE8:\n\t\tcase mmGB_TILE_MODE9:\n\t\tcase mmGB_TILE_MODE10:\n\t\tcase mmGB_TILE_MODE11:\n\t\tcase mmGB_TILE_MODE12:\n\t\tcase mmGB_TILE_MODE13:\n\t\tcase mmGB_TILE_MODE14:\n\t\tcase mmGB_TILE_MODE15:\n\t\tcase mmGB_TILE_MODE16:\n\t\tcase mmGB_TILE_MODE17:\n\t\tcase mmGB_TILE_MODE18:\n\t\tcase mmGB_TILE_MODE19:\n\t\tcase mmGB_TILE_MODE20:\n\t\tcase mmGB_TILE_MODE21:\n\t\tcase mmGB_TILE_MODE22:\n\t\tcase mmGB_TILE_MODE23:\n\t\tcase mmGB_TILE_MODE24:\n\t\tcase mmGB_TILE_MODE25:\n\t\tcase mmGB_TILE_MODE26:\n\t\tcase mmGB_TILE_MODE27:\n\t\tcase mmGB_TILE_MODE28:\n\t\tcase mmGB_TILE_MODE29:\n\t\tcase mmGB_TILE_MODE30:\n\t\tcase mmGB_TILE_MODE31:\n\t\t\tidx = (reg_offset - mmGB_TILE_MODE0);\n\t\t\treturn adev->gfx.config.tile_mode_array[idx];\n\t\tcase mmGB_MACROTILE_MODE0:\n\t\tcase mmGB_MACROTILE_MODE1:\n\t\tcase mmGB_MACROTILE_MODE2:\n\t\tcase mmGB_MACROTILE_MODE3:\n\t\tcase mmGB_MACROTILE_MODE4:\n\t\tcase mmGB_MACROTILE_MODE5:\n\t\tcase mmGB_MACROTILE_MODE6:\n\t\tcase mmGB_MACROTILE_MODE7:\n\t\tcase mmGB_MACROTILE_MODE8:\n\t\tcase mmGB_MACROTILE_MODE9:\n\t\tcase mmGB_MACROTILE_MODE10:\n\t\tcase mmGB_MACROTILE_MODE11:\n\t\tcase mmGB_MACROTILE_MODE12:\n\t\tcase mmGB_MACROTILE_MODE13:\n\t\tcase mmGB_MACROTILE_MODE14:\n\t\tcase mmGB_MACROTILE_MODE15:\n\t\t\tidx = (reg_offset - mmGB_MACROTILE_MODE0);\n\t\t\treturn adev->gfx.config.macrotile_mode_array[idx];\n\t\tdefault:\n\t\t\treturn RREG32(reg_offset);\n\t\t}\n\t}\n}\n\nstatic int cik_read_register(struct amdgpu_device *adev, u32 se_num,\n\t\t\t     u32 sh_num, u32 reg_offset, u32 *value)\n{\n\tuint32_t i;\n\n\t*value = 0;\n\tfor (i = 0; i < ARRAY_SIZE(cik_allowed_read_registers); i++) {\n\t\tbool indexed = cik_allowed_read_registers[i].grbm_indexed;\n\n\t\tif (reg_offset != cik_allowed_read_registers[i].reg_offset)\n\t\t\tcontinue;\n\n\t\t*value = cik_get_register_value(adev, indexed, se_num, sh_num,\n\t\t\t\t\t\treg_offset);\n\t\treturn 0;\n\t}\n\treturn -EINVAL;\n}\n\nstruct kv_reset_save_regs {\n\tu32 gmcon_reng_execute;\n\tu32 gmcon_misc;\n\tu32 gmcon_misc3;\n};\n\nstatic void kv_save_regs_for_reset(struct amdgpu_device *adev,\n\t\t\t\t   struct kv_reset_save_regs *save)\n{\n\tsave->gmcon_reng_execute = RREG32(mmGMCON_RENG_EXECUTE);\n\tsave->gmcon_misc = RREG32(mmGMCON_MISC);\n\tsave->gmcon_misc3 = RREG32(mmGMCON_MISC3);\n\n\tWREG32(mmGMCON_RENG_EXECUTE, save->gmcon_reng_execute &\n\t\t~GMCON_RENG_EXECUTE__RENG_EXECUTE_ON_PWR_UP_MASK);\n\tWREG32(mmGMCON_MISC, save->gmcon_misc &\n\t\t~(GMCON_MISC__RENG_EXECUTE_ON_REG_UPDATE_MASK |\n\t\t\tGMCON_MISC__STCTRL_STUTTER_EN_MASK));\n}\n\nstatic void kv_restore_regs_for_reset(struct amdgpu_device *adev,\n\t\t\t\t      struct kv_reset_save_regs *save)\n{\n\tint i;\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0x200010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0x300010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0x210000);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0xa00010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0x21003);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0xb00010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0x2b00);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0xc00010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0xd00010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0x420000);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0x100010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0x120202);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0x500010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0x3e3e36);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0x600010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0x373f3e);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0x700010ff);\n\n\tfor (i = 0; i < 5; i++)\n\t\tWREG32(mmGMCON_PGFSM_WRITE, 0);\n\n\tWREG32(mmGMCON_PGFSM_WRITE, 0x3e1332);\n\tWREG32(mmGMCON_PGFSM_CONFIG, 0xe00010ff);\n\n\tWREG32(mmGMCON_MISC3, save->gmcon_misc3);\n\tWREG32(mmGMCON_MISC, save->gmcon_misc);\n\tWREG32(mmGMCON_RENG_EXECUTE, save->gmcon_reng_execute);\n}\n\n \nstatic int cik_asic_pci_config_reset(struct amdgpu_device *adev)\n{\n\tstruct kv_reset_save_regs kv_save = { 0 };\n\tu32 i;\n\tint r = -EINVAL;\n\n\tamdgpu_atombios_scratch_regs_engine_hung(adev, true);\n\n\tif (adev->flags & AMD_IS_APU)\n\t\tkv_save_regs_for_reset(adev, &kv_save);\n\n\t \n\tpci_clear_master(adev->pdev);\n\t \n\tamdgpu_device_pci_config_reset(adev);\n\n\tudelay(100);\n\n\t \n\tfor (i = 0; i < adev->usec_timeout; i++) {\n\t\tif (RREG32(mmCONFIG_MEMSIZE) != 0xffffffff) {\n\t\t\t \n\t\t\tpci_set_master(adev->pdev);\n\t\t\tadev->has_hw_reset = true;\n\t\t\tr = 0;\n\t\t\tbreak;\n\t\t}\n\t\tudelay(1);\n\t}\n\n\t \n\tif (adev->flags & AMD_IS_APU)\n\t\tkv_restore_regs_for_reset(adev, &kv_save);\n\n\tamdgpu_atombios_scratch_regs_engine_hung(adev, false);\n\n\treturn r;\n}\n\nstatic bool cik_asic_supports_baco(struct amdgpu_device *adev)\n{\n\tswitch (adev->asic_type) {\n\tcase CHIP_BONAIRE:\n\tcase CHIP_HAWAII:\n\t\treturn amdgpu_dpm_is_baco_supported(adev);\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic enum amd_reset_method\ncik_asic_reset_method(struct amdgpu_device *adev)\n{\n\tbool baco_reset;\n\n\tif (amdgpu_reset_method == AMD_RESET_METHOD_LEGACY ||\n\t    amdgpu_reset_method == AMD_RESET_METHOD_BACO)\n\t\treturn amdgpu_reset_method;\n\n\tif (amdgpu_reset_method != -1)\n\t\tdev_warn(adev->dev, \"Specified reset:%d isn't supported, using AUTO instead.\\n\",\n\t\t\t\t  amdgpu_reset_method);\n\n\tswitch (adev->asic_type) {\n\tcase CHIP_BONAIRE:\n\tcase CHIP_HAWAII:\n\t\tbaco_reset = cik_asic_supports_baco(adev);\n\t\tbreak;\n\tdefault:\n\t\tbaco_reset = false;\n\t\tbreak;\n\t}\n\n\tif (baco_reset)\n\t\treturn AMD_RESET_METHOD_BACO;\n\telse\n\t\treturn AMD_RESET_METHOD_LEGACY;\n}\n\n \nstatic int cik_asic_reset(struct amdgpu_device *adev)\n{\n\tint r;\n\n\t \n\tif (adev->flags & AMD_IS_APU)\n\t\treturn 0;\n\n\tif (cik_asic_reset_method(adev) == AMD_RESET_METHOD_BACO) {\n\t\tdev_info(adev->dev, \"BACO reset\\n\");\n\t\tr = amdgpu_dpm_baco_reset(adev);\n\t} else {\n\t\tdev_info(adev->dev, \"PCI CONFIG reset\\n\");\n\t\tr = cik_asic_pci_config_reset(adev);\n\t}\n\n\treturn r;\n}\n\nstatic u32 cik_get_config_memsize(struct amdgpu_device *adev)\n{\n\treturn RREG32(mmCONFIG_MEMSIZE);\n}\n\nstatic int cik_set_uvd_clock(struct amdgpu_device *adev, u32 clock,\n\t\t\t      u32 cntl_reg, u32 status_reg)\n{\n\tint r, i;\n\tstruct atom_clock_dividers dividers;\n\tuint32_t tmp;\n\n\tr = amdgpu_atombios_get_clock_dividers(adev,\n\t\t\t\t\t       COMPUTE_GPUCLK_INPUT_FLAG_DEFAULT_GPUCLK,\n\t\t\t\t\t       clock, false, &dividers);\n\tif (r)\n\t\treturn r;\n\n\ttmp = RREG32_SMC(cntl_reg);\n\ttmp &= ~(CG_DCLK_CNTL__DCLK_DIR_CNTL_EN_MASK |\n\t\tCG_DCLK_CNTL__DCLK_DIVIDER_MASK);\n\ttmp |= dividers.post_divider;\n\tWREG32_SMC(cntl_reg, tmp);\n\n\tfor (i = 0; i < 100; i++) {\n\t\tif (RREG32_SMC(status_reg) & CG_DCLK_STATUS__DCLK_STATUS_MASK)\n\t\t\tbreak;\n\t\tmdelay(10);\n\t}\n\tif (i == 100)\n\t\treturn -ETIMEDOUT;\n\n\treturn 0;\n}\n\nstatic int cik_set_uvd_clocks(struct amdgpu_device *adev, u32 vclk, u32 dclk)\n{\n\tint r = 0;\n\n\tr = cik_set_uvd_clock(adev, vclk, ixCG_VCLK_CNTL, ixCG_VCLK_STATUS);\n\tif (r)\n\t\treturn r;\n\n\tr = cik_set_uvd_clock(adev, dclk, ixCG_DCLK_CNTL, ixCG_DCLK_STATUS);\n\treturn r;\n}\n\nstatic int cik_set_vce_clocks(struct amdgpu_device *adev, u32 evclk, u32 ecclk)\n{\n\tint r, i;\n\tstruct atom_clock_dividers dividers;\n\tu32 tmp;\n\n\tr = amdgpu_atombios_get_clock_dividers(adev,\n\t\t\t\t\t       COMPUTE_GPUCLK_INPUT_FLAG_DEFAULT_GPUCLK,\n\t\t\t\t\t       ecclk, false, &dividers);\n\tif (r)\n\t\treturn r;\n\n\tfor (i = 0; i < 100; i++) {\n\t\tif (RREG32_SMC(ixCG_ECLK_STATUS) & CG_ECLK_STATUS__ECLK_STATUS_MASK)\n\t\t\tbreak;\n\t\tmdelay(10);\n\t}\n\tif (i == 100)\n\t\treturn -ETIMEDOUT;\n\n\ttmp = RREG32_SMC(ixCG_ECLK_CNTL);\n\ttmp &= ~(CG_ECLK_CNTL__ECLK_DIR_CNTL_EN_MASK |\n\t\tCG_ECLK_CNTL__ECLK_DIVIDER_MASK);\n\ttmp |= dividers.post_divider;\n\tWREG32_SMC(ixCG_ECLK_CNTL, tmp);\n\n\tfor (i = 0; i < 100; i++) {\n\t\tif (RREG32_SMC(ixCG_ECLK_STATUS) & CG_ECLK_STATUS__ECLK_STATUS_MASK)\n\t\t\tbreak;\n\t\tmdelay(10);\n\t}\n\tif (i == 100)\n\t\treturn -ETIMEDOUT;\n\n\treturn 0;\n}\n\nstatic void cik_pcie_gen3_enable(struct amdgpu_device *adev)\n{\n\tstruct pci_dev *root = adev->pdev->bus->self;\n\tu32 speed_cntl, current_data_rate;\n\tint i;\n\tu16 tmp16;\n\n\tif (pci_is_root_bus(adev->pdev->bus))\n\t\treturn;\n\n\tif (amdgpu_pcie_gen2 == 0)\n\t\treturn;\n\n\tif (adev->flags & AMD_IS_APU)\n\t\treturn;\n\n\tif (!(adev->pm.pcie_gen_mask & (CAIL_PCIE_LINK_SPEED_SUPPORT_GEN2 |\n\t\t\t\t\tCAIL_PCIE_LINK_SPEED_SUPPORT_GEN3)))\n\t\treturn;\n\n\tspeed_cntl = RREG32_PCIE(ixPCIE_LC_SPEED_CNTL);\n\tcurrent_data_rate = (speed_cntl & PCIE_LC_SPEED_CNTL__LC_CURRENT_DATA_RATE_MASK) >>\n\t\tPCIE_LC_SPEED_CNTL__LC_CURRENT_DATA_RATE__SHIFT;\n\tif (adev->pm.pcie_gen_mask & CAIL_PCIE_LINK_SPEED_SUPPORT_GEN3) {\n\t\tif (current_data_rate == 2) {\n\t\t\tDRM_INFO(\"PCIE gen 3 link speeds already enabled\\n\");\n\t\t\treturn;\n\t\t}\n\t\tDRM_INFO(\"enabling PCIE gen 3 link speeds, disable with amdgpu.pcie_gen2=0\\n\");\n\t} else if (adev->pm.pcie_gen_mask & CAIL_PCIE_LINK_SPEED_SUPPORT_GEN2) {\n\t\tif (current_data_rate == 1) {\n\t\t\tDRM_INFO(\"PCIE gen 2 link speeds already enabled\\n\");\n\t\t\treturn;\n\t\t}\n\t\tDRM_INFO(\"enabling PCIE gen 2 link speeds, disable with amdgpu.pcie_gen2=0\\n\");\n\t}\n\n\tif (!pci_is_pcie(root) || !pci_is_pcie(adev->pdev))\n\t\treturn;\n\n\tif (adev->pm.pcie_gen_mask & CAIL_PCIE_LINK_SPEED_SUPPORT_GEN3) {\n\t\t \n\t\tif (current_data_rate != 2) {\n\t\t\tu16 bridge_cfg, gpu_cfg;\n\t\t\tu16 bridge_cfg2, gpu_cfg2;\n\t\t\tu32 max_lw, current_lw, tmp;\n\n\t\t\tpcie_capability_set_word(root, PCI_EXP_LNKCTL, PCI_EXP_LNKCTL_HAWD);\n\t\t\tpcie_capability_set_word(adev->pdev, PCI_EXP_LNKCTL, PCI_EXP_LNKCTL_HAWD);\n\n\t\t\ttmp = RREG32_PCIE(ixPCIE_LC_STATUS1);\n\t\t\tmax_lw = (tmp & PCIE_LC_STATUS1__LC_DETECTED_LINK_WIDTH_MASK) >>\n\t\t\t\tPCIE_LC_STATUS1__LC_DETECTED_LINK_WIDTH__SHIFT;\n\t\t\tcurrent_lw = (tmp & PCIE_LC_STATUS1__LC_OPERATING_LINK_WIDTH_MASK)\n\t\t\t\t>> PCIE_LC_STATUS1__LC_OPERATING_LINK_WIDTH__SHIFT;\n\n\t\t\tif (current_lw < max_lw) {\n\t\t\t\ttmp = RREG32_PCIE(ixPCIE_LC_LINK_WIDTH_CNTL);\n\t\t\t\tif (tmp & PCIE_LC_LINK_WIDTH_CNTL__LC_RENEGOTIATION_SUPPORT_MASK) {\n\t\t\t\t\ttmp &= ~(PCIE_LC_LINK_WIDTH_CNTL__LC_LINK_WIDTH_MASK |\n\t\t\t\t\t\tPCIE_LC_LINK_WIDTH_CNTL__LC_UPCONFIGURE_DIS_MASK);\n\t\t\t\t\ttmp |= (max_lw <<\n\t\t\t\t\t\tPCIE_LC_LINK_WIDTH_CNTL__LC_LINK_WIDTH__SHIFT);\n\t\t\t\t\ttmp |= PCIE_LC_LINK_WIDTH_CNTL__LC_UPCONFIGURE_SUPPORT_MASK |\n\t\t\t\t\tPCIE_LC_LINK_WIDTH_CNTL__LC_RENEGOTIATE_EN_MASK |\n\t\t\t\t\tPCIE_LC_LINK_WIDTH_CNTL__LC_RECONFIG_NOW_MASK;\n\t\t\t\t\tWREG32_PCIE(ixPCIE_LC_LINK_WIDTH_CNTL, tmp);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (i = 0; i < 10; i++) {\n\t\t\t\t \n\t\t\t\tpcie_capability_read_word(adev->pdev,\n\t\t\t\t\t\t\t  PCI_EXP_DEVSTA,\n\t\t\t\t\t\t\t  &tmp16);\n\t\t\t\tif (tmp16 & PCI_EXP_DEVSTA_TRPND)\n\t\t\t\t\tbreak;\n\n\t\t\t\tpcie_capability_read_word(root, PCI_EXP_LNKCTL,\n\t\t\t\t\t\t\t  &bridge_cfg);\n\t\t\t\tpcie_capability_read_word(adev->pdev,\n\t\t\t\t\t\t\t  PCI_EXP_LNKCTL,\n\t\t\t\t\t\t\t  &gpu_cfg);\n\n\t\t\t\tpcie_capability_read_word(root, PCI_EXP_LNKCTL2,\n\t\t\t\t\t\t\t  &bridge_cfg2);\n\t\t\t\tpcie_capability_read_word(adev->pdev,\n\t\t\t\t\t\t\t  PCI_EXP_LNKCTL2,\n\t\t\t\t\t\t\t  &gpu_cfg2);\n\n\t\t\t\ttmp = RREG32_PCIE(ixPCIE_LC_CNTL4);\n\t\t\t\ttmp |= PCIE_LC_CNTL4__LC_SET_QUIESCE_MASK;\n\t\t\t\tWREG32_PCIE(ixPCIE_LC_CNTL4, tmp);\n\n\t\t\t\ttmp = RREG32_PCIE(ixPCIE_LC_CNTL4);\n\t\t\t\ttmp |= PCIE_LC_CNTL4__LC_REDO_EQ_MASK;\n\t\t\t\tWREG32_PCIE(ixPCIE_LC_CNTL4, tmp);\n\n\t\t\t\tmsleep(100);\n\n\t\t\t\t \n\t\t\t\tpcie_capability_clear_and_set_word(root, PCI_EXP_LNKCTL,\n\t\t\t\t\t\t\t\t   PCI_EXP_LNKCTL_HAWD,\n\t\t\t\t\t\t\t\t   bridge_cfg &\n\t\t\t\t\t\t\t\t   PCI_EXP_LNKCTL_HAWD);\n\t\t\t\tpcie_capability_clear_and_set_word(adev->pdev, PCI_EXP_LNKCTL,\n\t\t\t\t\t\t\t\t   PCI_EXP_LNKCTL_HAWD,\n\t\t\t\t\t\t\t\t   gpu_cfg &\n\t\t\t\t\t\t\t\t   PCI_EXP_LNKCTL_HAWD);\n\n\t\t\t\t \n\t\t\t\tpcie_capability_read_word(root, PCI_EXP_LNKCTL2,\n\t\t\t\t\t\t\t  &tmp16);\n\t\t\t\ttmp16 &= ~(PCI_EXP_LNKCTL2_ENTER_COMP |\n\t\t\t\t\t   PCI_EXP_LNKCTL2_TX_MARGIN);\n\t\t\t\ttmp16 |= (bridge_cfg2 &\n\t\t\t\t\t  (PCI_EXP_LNKCTL2_ENTER_COMP |\n\t\t\t\t\t   PCI_EXP_LNKCTL2_TX_MARGIN));\n\t\t\t\tpcie_capability_write_word(root,\n\t\t\t\t\t\t\t   PCI_EXP_LNKCTL2,\n\t\t\t\t\t\t\t   tmp16);\n\n\t\t\t\tpcie_capability_read_word(adev->pdev,\n\t\t\t\t\t\t\t  PCI_EXP_LNKCTL2,\n\t\t\t\t\t\t\t  &tmp16);\n\t\t\t\ttmp16 &= ~(PCI_EXP_LNKCTL2_ENTER_COMP |\n\t\t\t\t\t   PCI_EXP_LNKCTL2_TX_MARGIN);\n\t\t\t\ttmp16 |= (gpu_cfg2 &\n\t\t\t\t\t  (PCI_EXP_LNKCTL2_ENTER_COMP |\n\t\t\t\t\t   PCI_EXP_LNKCTL2_TX_MARGIN));\n\t\t\t\tpcie_capability_write_word(adev->pdev,\n\t\t\t\t\t\t\t   PCI_EXP_LNKCTL2,\n\t\t\t\t\t\t\t   tmp16);\n\n\t\t\t\ttmp = RREG32_PCIE(ixPCIE_LC_CNTL4);\n\t\t\t\ttmp &= ~PCIE_LC_CNTL4__LC_SET_QUIESCE_MASK;\n\t\t\t\tWREG32_PCIE(ixPCIE_LC_CNTL4, tmp);\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tspeed_cntl |= PCIE_LC_SPEED_CNTL__LC_FORCE_EN_SW_SPEED_CHANGE_MASK |\n\t\tPCIE_LC_SPEED_CNTL__LC_FORCE_DIS_HW_SPEED_CHANGE_MASK;\n\tspeed_cntl &= ~PCIE_LC_SPEED_CNTL__LC_FORCE_DIS_SW_SPEED_CHANGE_MASK;\n\tWREG32_PCIE(ixPCIE_LC_SPEED_CNTL, speed_cntl);\n\n\tpcie_capability_read_word(adev->pdev, PCI_EXP_LNKCTL2, &tmp16);\n\ttmp16 &= ~PCI_EXP_LNKCTL2_TLS;\n\n\tif (adev->pm.pcie_gen_mask & CAIL_PCIE_LINK_SPEED_SUPPORT_GEN3)\n\t\ttmp16 |= PCI_EXP_LNKCTL2_TLS_8_0GT;  \n\telse if (adev->pm.pcie_gen_mask & CAIL_PCIE_LINK_SPEED_SUPPORT_GEN2)\n\t\ttmp16 |= PCI_EXP_LNKCTL2_TLS_5_0GT;  \n\telse\n\t\ttmp16 |= PCI_EXP_LNKCTL2_TLS_2_5GT;  \n\tpcie_capability_write_word(adev->pdev, PCI_EXP_LNKCTL2, tmp16);\n\n\tspeed_cntl = RREG32_PCIE(ixPCIE_LC_SPEED_CNTL);\n\tspeed_cntl |= PCIE_LC_SPEED_CNTL__LC_INITIATE_LINK_SPEED_CHANGE_MASK;\n\tWREG32_PCIE(ixPCIE_LC_SPEED_CNTL, speed_cntl);\n\n\tfor (i = 0; i < adev->usec_timeout; i++) {\n\t\tspeed_cntl = RREG32_PCIE(ixPCIE_LC_SPEED_CNTL);\n\t\tif ((speed_cntl & PCIE_LC_SPEED_CNTL__LC_INITIATE_LINK_SPEED_CHANGE_MASK) == 0)\n\t\t\tbreak;\n\t\tudelay(1);\n\t}\n}\n\nstatic void cik_program_aspm(struct amdgpu_device *adev)\n{\n\tu32 data, orig;\n\tbool disable_l0s = false, disable_l1 = false, disable_plloff_in_l1 = false;\n\tbool disable_clkreq = false;\n\n\tif (!amdgpu_device_should_use_aspm(adev))\n\t\treturn;\n\n\tif (pci_is_root_bus(adev->pdev->bus))\n\t\treturn;\n\n\t \n\tif (adev->flags & AMD_IS_APU)\n\t\treturn;\n\n\torig = data = RREG32_PCIE(ixPCIE_LC_N_FTS_CNTL);\n\tdata &= ~PCIE_LC_N_FTS_CNTL__LC_XMIT_N_FTS_MASK;\n\tdata |= (0x24 << PCIE_LC_N_FTS_CNTL__LC_XMIT_N_FTS__SHIFT) |\n\t\tPCIE_LC_N_FTS_CNTL__LC_XMIT_N_FTS_OVERRIDE_EN_MASK;\n\tif (orig != data)\n\t\tWREG32_PCIE(ixPCIE_LC_N_FTS_CNTL, data);\n\n\torig = data = RREG32_PCIE(ixPCIE_LC_CNTL3);\n\tdata |= PCIE_LC_CNTL3__LC_GO_TO_RECOVERY_MASK;\n\tif (orig != data)\n\t\tWREG32_PCIE(ixPCIE_LC_CNTL3, data);\n\n\torig = data = RREG32_PCIE(ixPCIE_P_CNTL);\n\tdata |= PCIE_P_CNTL__P_IGNORE_EDB_ERR_MASK;\n\tif (orig != data)\n\t\tWREG32_PCIE(ixPCIE_P_CNTL, data);\n\n\torig = data = RREG32_PCIE(ixPCIE_LC_CNTL);\n\tdata &= ~(PCIE_LC_CNTL__LC_L0S_INACTIVITY_MASK |\n\t\tPCIE_LC_CNTL__LC_L1_INACTIVITY_MASK);\n\tdata |= PCIE_LC_CNTL__LC_PMI_TO_L1_DIS_MASK;\n\tif (!disable_l0s)\n\t\tdata |= (7 << PCIE_LC_CNTL__LC_L0S_INACTIVITY__SHIFT);\n\n\tif (!disable_l1) {\n\t\tdata |= (7 << PCIE_LC_CNTL__LC_L1_INACTIVITY__SHIFT);\n\t\tdata &= ~PCIE_LC_CNTL__LC_PMI_TO_L1_DIS_MASK;\n\t\tif (orig != data)\n\t\t\tWREG32_PCIE(ixPCIE_LC_CNTL, data);\n\n\t\tif (!disable_plloff_in_l1) {\n\t\t\tbool clk_req_support;\n\n\t\t\torig = data = RREG32_PCIE(ixPB0_PIF_PWRDOWN_0);\n\t\t\tdata &= ~(PB0_PIF_PWRDOWN_0__PLL_POWER_STATE_IN_OFF_0_MASK |\n\t\t\t\tPB0_PIF_PWRDOWN_0__PLL_POWER_STATE_IN_TXS2_0_MASK);\n\t\t\tdata |= (7 << PB0_PIF_PWRDOWN_0__PLL_POWER_STATE_IN_OFF_0__SHIFT) |\n\t\t\t\t(7 << PB0_PIF_PWRDOWN_0__PLL_POWER_STATE_IN_TXS2_0__SHIFT);\n\t\t\tif (orig != data)\n\t\t\t\tWREG32_PCIE(ixPB0_PIF_PWRDOWN_0, data);\n\n\t\t\torig = data = RREG32_PCIE(ixPB0_PIF_PWRDOWN_1);\n\t\t\tdata &= ~(PB0_PIF_PWRDOWN_1__PLL_POWER_STATE_IN_OFF_1_MASK |\n\t\t\t\tPB0_PIF_PWRDOWN_1__PLL_POWER_STATE_IN_TXS2_1_MASK);\n\t\t\tdata |= (7 << PB0_PIF_PWRDOWN_1__PLL_POWER_STATE_IN_OFF_1__SHIFT) |\n\t\t\t\t(7 << PB0_PIF_PWRDOWN_1__PLL_POWER_STATE_IN_TXS2_1__SHIFT);\n\t\t\tif (orig != data)\n\t\t\t\tWREG32_PCIE(ixPB0_PIF_PWRDOWN_1, data);\n\n\t\t\torig = data = RREG32_PCIE(ixPB1_PIF_PWRDOWN_0);\n\t\t\tdata &= ~(PB1_PIF_PWRDOWN_0__PLL_POWER_STATE_IN_OFF_0_MASK |\n\t\t\t\tPB1_PIF_PWRDOWN_0__PLL_POWER_STATE_IN_TXS2_0_MASK);\n\t\t\tdata |= (7 << PB1_PIF_PWRDOWN_0__PLL_POWER_STATE_IN_OFF_0__SHIFT) |\n\t\t\t\t(7 << PB1_PIF_PWRDOWN_0__PLL_POWER_STATE_IN_TXS2_0__SHIFT);\n\t\t\tif (orig != data)\n\t\t\t\tWREG32_PCIE(ixPB1_PIF_PWRDOWN_0, data);\n\n\t\t\torig = data = RREG32_PCIE(ixPB1_PIF_PWRDOWN_1);\n\t\t\tdata &= ~(PB1_PIF_PWRDOWN_1__PLL_POWER_STATE_IN_OFF_1_MASK |\n\t\t\t\tPB1_PIF_PWRDOWN_1__PLL_POWER_STATE_IN_TXS2_1_MASK);\n\t\t\tdata |= (7 << PB1_PIF_PWRDOWN_1__PLL_POWER_STATE_IN_OFF_1__SHIFT) |\n\t\t\t\t(7 << PB1_PIF_PWRDOWN_1__PLL_POWER_STATE_IN_TXS2_1__SHIFT);\n\t\t\tif (orig != data)\n\t\t\t\tWREG32_PCIE(ixPB1_PIF_PWRDOWN_1, data);\n\n\t\t\torig = data = RREG32_PCIE(ixPCIE_LC_LINK_WIDTH_CNTL);\n\t\t\tdata &= ~PCIE_LC_LINK_WIDTH_CNTL__LC_DYN_LANES_PWR_STATE_MASK;\n\t\t\tdata |= ~(3 << PCIE_LC_LINK_WIDTH_CNTL__LC_DYN_LANES_PWR_STATE__SHIFT);\n\t\t\tif (orig != data)\n\t\t\t\tWREG32_PCIE(ixPCIE_LC_LINK_WIDTH_CNTL, data);\n\n\t\t\tif (!disable_clkreq) {\n\t\t\t\tstruct pci_dev *root = adev->pdev->bus->self;\n\t\t\t\tu32 lnkcap;\n\n\t\t\t\tclk_req_support = false;\n\t\t\t\tpcie_capability_read_dword(root, PCI_EXP_LNKCAP, &lnkcap);\n\t\t\t\tif (lnkcap & PCI_EXP_LNKCAP_CLKPM)\n\t\t\t\t\tclk_req_support = true;\n\t\t\t} else {\n\t\t\t\tclk_req_support = false;\n\t\t\t}\n\n\t\t\tif (clk_req_support) {\n\t\t\t\torig = data = RREG32_PCIE(ixPCIE_LC_CNTL2);\n\t\t\t\tdata |= PCIE_LC_CNTL2__LC_ALLOW_PDWN_IN_L1_MASK |\n\t\t\t\t\tPCIE_LC_CNTL2__LC_ALLOW_PDWN_IN_L23_MASK;\n\t\t\t\tif (orig != data)\n\t\t\t\t\tWREG32_PCIE(ixPCIE_LC_CNTL2, data);\n\n\t\t\t\torig = data = RREG32_SMC(ixTHM_CLK_CNTL);\n\t\t\t\tdata &= ~(THM_CLK_CNTL__CMON_CLK_SEL_MASK |\n\t\t\t\t\tTHM_CLK_CNTL__TMON_CLK_SEL_MASK);\n\t\t\t\tdata |= (1 << THM_CLK_CNTL__CMON_CLK_SEL__SHIFT) |\n\t\t\t\t\t(1 << THM_CLK_CNTL__TMON_CLK_SEL__SHIFT);\n\t\t\t\tif (orig != data)\n\t\t\t\t\tWREG32_SMC(ixTHM_CLK_CNTL, data);\n\n\t\t\t\torig = data = RREG32_SMC(ixMISC_CLK_CTRL);\n\t\t\t\tdata &= ~(MISC_CLK_CTRL__DEEP_SLEEP_CLK_SEL_MASK |\n\t\t\t\t\tMISC_CLK_CTRL__ZCLK_SEL_MASK);\n\t\t\t\tdata |= (1 << MISC_CLK_CTRL__DEEP_SLEEP_CLK_SEL__SHIFT) |\n\t\t\t\t\t(1 << MISC_CLK_CTRL__ZCLK_SEL__SHIFT);\n\t\t\t\tif (orig != data)\n\t\t\t\t\tWREG32_SMC(ixMISC_CLK_CTRL, data);\n\n\t\t\t\torig = data = RREG32_SMC(ixCG_CLKPIN_CNTL);\n\t\t\t\tdata &= ~CG_CLKPIN_CNTL__BCLK_AS_XCLK_MASK;\n\t\t\t\tif (orig != data)\n\t\t\t\t\tWREG32_SMC(ixCG_CLKPIN_CNTL, data);\n\n\t\t\t\torig = data = RREG32_SMC(ixCG_CLKPIN_CNTL_2);\n\t\t\t\tdata &= ~CG_CLKPIN_CNTL_2__FORCE_BIF_REFCLK_EN_MASK;\n\t\t\t\tif (orig != data)\n\t\t\t\t\tWREG32_SMC(ixCG_CLKPIN_CNTL_2, data);\n\n\t\t\t\torig = data = RREG32_SMC(ixMPLL_BYPASSCLK_SEL);\n\t\t\t\tdata &= ~MPLL_BYPASSCLK_SEL__MPLL_CLKOUT_SEL_MASK;\n\t\t\t\tdata |= (4 << MPLL_BYPASSCLK_SEL__MPLL_CLKOUT_SEL__SHIFT);\n\t\t\t\tif (orig != data)\n\t\t\t\t\tWREG32_SMC(ixMPLL_BYPASSCLK_SEL, data);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tif (orig != data)\n\t\t\tWREG32_PCIE(ixPCIE_LC_CNTL, data);\n\t}\n\n\torig = data = RREG32_PCIE(ixPCIE_CNTL2);\n\tdata |= PCIE_CNTL2__SLV_MEM_LS_EN_MASK |\n\t\tPCIE_CNTL2__MST_MEM_LS_EN_MASK |\n\t\tPCIE_CNTL2__REPLAY_MEM_LS_EN_MASK;\n\tif (orig != data)\n\t\tWREG32_PCIE(ixPCIE_CNTL2, data);\n\n\tif (!disable_l0s) {\n\t\tdata = RREG32_PCIE(ixPCIE_LC_N_FTS_CNTL);\n\t\tif ((data & PCIE_LC_N_FTS_CNTL__LC_N_FTS_MASK) ==\n\t\t\t\tPCIE_LC_N_FTS_CNTL__LC_N_FTS_MASK) {\n\t\t\tdata = RREG32_PCIE(ixPCIE_LC_STATUS1);\n\t\t\tif ((data & PCIE_LC_STATUS1__LC_REVERSE_XMIT_MASK) &&\n\t\t\t(data & PCIE_LC_STATUS1__LC_REVERSE_RCVR_MASK)) {\n\t\t\t\torig = data = RREG32_PCIE(ixPCIE_LC_CNTL);\n\t\t\t\tdata &= ~PCIE_LC_CNTL__LC_L0S_INACTIVITY_MASK;\n\t\t\t\tif (orig != data)\n\t\t\t\t\tWREG32_PCIE(ixPCIE_LC_CNTL, data);\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic uint32_t cik_get_rev_id(struct amdgpu_device *adev)\n{\n\treturn (RREG32(mmCC_DRM_ID_STRAPS) & CC_DRM_ID_STRAPS__ATI_REV_ID_MASK)\n\t\t>> CC_DRM_ID_STRAPS__ATI_REV_ID__SHIFT;\n}\n\nstatic void cik_flush_hdp(struct amdgpu_device *adev, struct amdgpu_ring *ring)\n{\n\tif (!ring || !ring->funcs->emit_wreg) {\n\t\tWREG32(mmHDP_MEM_COHERENCY_FLUSH_CNTL, 1);\n\t\tRREG32(mmHDP_MEM_COHERENCY_FLUSH_CNTL);\n\t} else {\n\t\tamdgpu_ring_emit_wreg(ring, mmHDP_MEM_COHERENCY_FLUSH_CNTL, 1);\n\t}\n}\n\nstatic void cik_invalidate_hdp(struct amdgpu_device *adev,\n\t\t\t       struct amdgpu_ring *ring)\n{\n\tif (!ring || !ring->funcs->emit_wreg) {\n\t\tWREG32(mmHDP_DEBUG0, 1);\n\t\tRREG32(mmHDP_DEBUG0);\n\t} else {\n\t\tamdgpu_ring_emit_wreg(ring, mmHDP_DEBUG0, 1);\n\t}\n}\n\nstatic bool cik_need_full_reset(struct amdgpu_device *adev)\n{\n\t \n\treturn true;\n}\n\nstatic void cik_get_pcie_usage(struct amdgpu_device *adev, uint64_t *count0,\n\t\t\t       uint64_t *count1)\n{\n\tuint32_t perfctr = 0;\n\tuint64_t cnt0_of, cnt1_of;\n\tint tmp;\n\n\t \n\tif (adev->flags & AMD_IS_APU)\n\t\treturn;\n\n\t \n\t \n\tperfctr = REG_SET_FIELD(perfctr, PCIE_PERF_CNTL_TXCLK, EVENT0_SEL, 40);\n\tperfctr = REG_SET_FIELD(perfctr, PCIE_PERF_CNTL_TXCLK, EVENT1_SEL, 104);\n\n\t \n\tWREG32_PCIE(ixPCIE_PERF_CNTL_TXCLK, perfctr);\n\t \n\tWREG32_PCIE(ixPCIE_PERF_COUNT_CNTL, 0x00000005);\n\n\tmsleep(1000);\n\n\t \n\tWREG32_PCIE(ixPCIE_PERF_COUNT_CNTL, 0x00000002);\n\n\t \n\ttmp = RREG32_PCIE(ixPCIE_PERF_CNTL_TXCLK);\n\tcnt0_of = REG_GET_FIELD(tmp, PCIE_PERF_CNTL_TXCLK, COUNTER0_UPPER);\n\tcnt1_of = REG_GET_FIELD(tmp, PCIE_PERF_CNTL_TXCLK, COUNTER1_UPPER);\n\n\t \n\t*count0 = RREG32_PCIE(ixPCIE_PERF_COUNT0_TXCLK) | (cnt0_of << 32);\n\t*count1 = RREG32_PCIE(ixPCIE_PERF_COUNT1_TXCLK) | (cnt1_of << 32);\n}\n\nstatic bool cik_need_reset_on_init(struct amdgpu_device *adev)\n{\n\tu32 clock_cntl, pc;\n\n\tif (adev->flags & AMD_IS_APU)\n\t\treturn false;\n\n\t \n\tclock_cntl = RREG32_SMC(ixSMC_SYSCON_CLOCK_CNTL_0);\n\tpc = RREG32_SMC(ixSMC_PC_C);\n\tif ((0 == REG_GET_FIELD(clock_cntl, SMC_SYSCON_CLOCK_CNTL_0, ck_disable)) &&\n\t    (0x20100 <= pc))\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic uint64_t cik_get_pcie_replay_count(struct amdgpu_device *adev)\n{\n\tuint64_t nak_r, nak_g;\n\n\t \n\tnak_r = RREG32_PCIE(ixPCIE_RX_NUM_NAK);\n\tnak_g = RREG32_PCIE(ixPCIE_RX_NUM_NAK_GENERATED);\n\n\t \n\treturn (nak_r + nak_g);\n}\n\nstatic void cik_pre_asic_init(struct amdgpu_device *adev)\n{\n}\n\nstatic const struct amdgpu_asic_funcs cik_asic_funcs =\n{\n\t.read_disabled_bios = &cik_read_disabled_bios,\n\t.read_bios_from_rom = &cik_read_bios_from_rom,\n\t.read_register = &cik_read_register,\n\t.reset = &cik_asic_reset,\n\t.reset_method = &cik_asic_reset_method,\n\t.set_vga_state = &cik_vga_set_state,\n\t.get_xclk = &cik_get_xclk,\n\t.set_uvd_clocks = &cik_set_uvd_clocks,\n\t.set_vce_clocks = &cik_set_vce_clocks,\n\t.get_config_memsize = &cik_get_config_memsize,\n\t.flush_hdp = &cik_flush_hdp,\n\t.invalidate_hdp = &cik_invalidate_hdp,\n\t.need_full_reset = &cik_need_full_reset,\n\t.init_doorbell_index = &legacy_doorbell_index_init,\n\t.get_pcie_usage = &cik_get_pcie_usage,\n\t.need_reset_on_init = &cik_need_reset_on_init,\n\t.get_pcie_replay_count = &cik_get_pcie_replay_count,\n\t.supports_baco = &cik_asic_supports_baco,\n\t.pre_asic_init = &cik_pre_asic_init,\n\t.query_video_codecs = &cik_query_video_codecs,\n};\n\nstatic int cik_common_early_init(void *handle)\n{\n\tstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\n\n\tadev->smc_rreg = &cik_smc_rreg;\n\tadev->smc_wreg = &cik_smc_wreg;\n\tadev->pcie_rreg = &cik_pcie_rreg;\n\tadev->pcie_wreg = &cik_pcie_wreg;\n\tadev->uvd_ctx_rreg = &cik_uvd_ctx_rreg;\n\tadev->uvd_ctx_wreg = &cik_uvd_ctx_wreg;\n\tadev->didt_rreg = &cik_didt_rreg;\n\tadev->didt_wreg = &cik_didt_wreg;\n\n\tadev->asic_funcs = &cik_asic_funcs;\n\n\tadev->rev_id = cik_get_rev_id(adev);\n\tadev->external_rev_id = 0xFF;\n\tswitch (adev->asic_type) {\n\tcase CHIP_BONAIRE:\n\t\tadev->cg_flags =\n\t\t\tAMD_CG_SUPPORT_GFX_MGCG |\n\t\t\tAMD_CG_SUPPORT_GFX_MGLS |\n\t\t\t \n\t\t\tAMD_CG_SUPPORT_GFX_CGLS |\n\t\t\tAMD_CG_SUPPORT_GFX_CGTS |\n\t\t\tAMD_CG_SUPPORT_GFX_CGTS_LS |\n\t\t\tAMD_CG_SUPPORT_GFX_CP_LS |\n\t\t\tAMD_CG_SUPPORT_MC_LS |\n\t\t\tAMD_CG_SUPPORT_MC_MGCG |\n\t\t\tAMD_CG_SUPPORT_SDMA_MGCG |\n\t\t\tAMD_CG_SUPPORT_SDMA_LS |\n\t\t\tAMD_CG_SUPPORT_BIF_LS |\n\t\t\tAMD_CG_SUPPORT_VCE_MGCG |\n\t\t\tAMD_CG_SUPPORT_UVD_MGCG |\n\t\t\tAMD_CG_SUPPORT_HDP_LS |\n\t\t\tAMD_CG_SUPPORT_HDP_MGCG;\n\t\tadev->pg_flags = 0;\n\t\tadev->external_rev_id = adev->rev_id + 0x14;\n\t\tbreak;\n\tcase CHIP_HAWAII:\n\t\tadev->cg_flags =\n\t\t\tAMD_CG_SUPPORT_GFX_MGCG |\n\t\t\tAMD_CG_SUPPORT_GFX_MGLS |\n\t\t\t \n\t\t\tAMD_CG_SUPPORT_GFX_CGLS |\n\t\t\tAMD_CG_SUPPORT_GFX_CGTS |\n\t\t\tAMD_CG_SUPPORT_GFX_CP_LS |\n\t\t\tAMD_CG_SUPPORT_MC_LS |\n\t\t\tAMD_CG_SUPPORT_MC_MGCG |\n\t\t\tAMD_CG_SUPPORT_SDMA_MGCG |\n\t\t\tAMD_CG_SUPPORT_SDMA_LS |\n\t\t\tAMD_CG_SUPPORT_BIF_LS |\n\t\t\tAMD_CG_SUPPORT_VCE_MGCG |\n\t\t\tAMD_CG_SUPPORT_UVD_MGCG |\n\t\t\tAMD_CG_SUPPORT_HDP_LS |\n\t\t\tAMD_CG_SUPPORT_HDP_MGCG;\n\t\tadev->pg_flags = 0;\n\t\tadev->external_rev_id = 0x28;\n\t\tbreak;\n\tcase CHIP_KAVERI:\n\t\tadev->cg_flags =\n\t\t\tAMD_CG_SUPPORT_GFX_MGCG |\n\t\t\tAMD_CG_SUPPORT_GFX_MGLS |\n\t\t\t \n\t\t\tAMD_CG_SUPPORT_GFX_CGLS |\n\t\t\tAMD_CG_SUPPORT_GFX_CGTS |\n\t\t\tAMD_CG_SUPPORT_GFX_CGTS_LS |\n\t\t\tAMD_CG_SUPPORT_GFX_CP_LS |\n\t\t\tAMD_CG_SUPPORT_SDMA_MGCG |\n\t\t\tAMD_CG_SUPPORT_SDMA_LS |\n\t\t\tAMD_CG_SUPPORT_BIF_LS |\n\t\t\tAMD_CG_SUPPORT_VCE_MGCG |\n\t\t\tAMD_CG_SUPPORT_UVD_MGCG |\n\t\t\tAMD_CG_SUPPORT_HDP_LS |\n\t\t\tAMD_CG_SUPPORT_HDP_MGCG;\n\t\tadev->pg_flags =\n\t\t\t \n\t\t\tAMD_PG_SUPPORT_UVD |\n\t\t\tAMD_PG_SUPPORT_VCE |\n\t\t\t \n\t\t\t0;\n\t\tif (adev->pdev->device == 0x1312 ||\n\t\t\tadev->pdev->device == 0x1316 ||\n\t\t\tadev->pdev->device == 0x1317)\n\t\t\tadev->external_rev_id = 0x41;\n\t\telse\n\t\t\tadev->external_rev_id = 0x1;\n\t\tbreak;\n\tcase CHIP_KABINI:\n\tcase CHIP_MULLINS:\n\t\tadev->cg_flags =\n\t\t\tAMD_CG_SUPPORT_GFX_MGCG |\n\t\t\tAMD_CG_SUPPORT_GFX_MGLS |\n\t\t\t \n\t\t\tAMD_CG_SUPPORT_GFX_CGLS |\n\t\t\tAMD_CG_SUPPORT_GFX_CGTS |\n\t\t\tAMD_CG_SUPPORT_GFX_CGTS_LS |\n\t\t\tAMD_CG_SUPPORT_GFX_CP_LS |\n\t\t\tAMD_CG_SUPPORT_SDMA_MGCG |\n\t\t\tAMD_CG_SUPPORT_SDMA_LS |\n\t\t\tAMD_CG_SUPPORT_BIF_LS |\n\t\t\tAMD_CG_SUPPORT_VCE_MGCG |\n\t\t\tAMD_CG_SUPPORT_UVD_MGCG |\n\t\t\tAMD_CG_SUPPORT_HDP_LS |\n\t\t\tAMD_CG_SUPPORT_HDP_MGCG;\n\t\tadev->pg_flags =\n\t\t\t \n\t\t\tAMD_PG_SUPPORT_UVD |\n\t\t\t \n\t\t\t0;\n\t\tif (adev->asic_type == CHIP_KABINI) {\n\t\t\tif (adev->rev_id == 0)\n\t\t\t\tadev->external_rev_id = 0x81;\n\t\t\telse if (adev->rev_id == 1)\n\t\t\t\tadev->external_rev_id = 0x82;\n\t\t\telse if (adev->rev_id == 2)\n\t\t\t\tadev->external_rev_id = 0x85;\n\t\t} else\n\t\t\tadev->external_rev_id = adev->rev_id + 0xa1;\n\t\tbreak;\n\tdefault:\n\t\t \n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int cik_common_sw_init(void *handle)\n{\n\treturn 0;\n}\n\nstatic int cik_common_sw_fini(void *handle)\n{\n\treturn 0;\n}\n\nstatic int cik_common_hw_init(void *handle)\n{\n\tstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\n\n\t \n\tcik_init_golden_registers(adev);\n\t \n\tcik_pcie_gen3_enable(adev);\n\t \n\tcik_program_aspm(adev);\n\n\treturn 0;\n}\n\nstatic int cik_common_hw_fini(void *handle)\n{\n\treturn 0;\n}\n\nstatic int cik_common_suspend(void *handle)\n{\n\tstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\n\n\treturn cik_common_hw_fini(adev);\n}\n\nstatic int cik_common_resume(void *handle)\n{\n\tstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\n\n\treturn cik_common_hw_init(adev);\n}\n\nstatic bool cik_common_is_idle(void *handle)\n{\n\treturn true;\n}\n\nstatic int cik_common_wait_for_idle(void *handle)\n{\n\treturn 0;\n}\n\nstatic int cik_common_soft_reset(void *handle)\n{\n\t \n\treturn 0;\n}\n\nstatic int cik_common_set_clockgating_state(void *handle,\n\t\t\t\t\t    enum amd_clockgating_state state)\n{\n\treturn 0;\n}\n\nstatic int cik_common_set_powergating_state(void *handle,\n\t\t\t\t\t    enum amd_powergating_state state)\n{\n\treturn 0;\n}\n\nstatic const struct amd_ip_funcs cik_common_ip_funcs = {\n\t.name = \"cik_common\",\n\t.early_init = cik_common_early_init,\n\t.late_init = NULL,\n\t.sw_init = cik_common_sw_init,\n\t.sw_fini = cik_common_sw_fini,\n\t.hw_init = cik_common_hw_init,\n\t.hw_fini = cik_common_hw_fini,\n\t.suspend = cik_common_suspend,\n\t.resume = cik_common_resume,\n\t.is_idle = cik_common_is_idle,\n\t.wait_for_idle = cik_common_wait_for_idle,\n\t.soft_reset = cik_common_soft_reset,\n\t.set_clockgating_state = cik_common_set_clockgating_state,\n\t.set_powergating_state = cik_common_set_powergating_state,\n};\n\nstatic const struct amdgpu_ip_block_version cik_common_ip_block =\n{\n\t.type = AMD_IP_BLOCK_TYPE_COMMON,\n\t.major = 1,\n\t.minor = 0,\n\t.rev = 0,\n\t.funcs = &cik_common_ip_funcs,\n};\n\nint cik_set_ip_blocks(struct amdgpu_device *adev)\n{\n\tswitch (adev->asic_type) {\n\tcase CHIP_BONAIRE:\n\t\tamdgpu_device_ip_block_add(adev, &cik_common_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &gmc_v7_0_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &cik_ih_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &gfx_v7_2_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &cik_sdma_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &pp_smu_ip_block);\n\t\tif (adev->enable_virtual_display)\n\t\t\tamdgpu_device_ip_block_add(adev, &amdgpu_vkms_ip_block);\n#if defined(CONFIG_DRM_AMD_DC)\n\t\telse if (amdgpu_device_has_dc_support(adev))\n\t\t\tamdgpu_device_ip_block_add(adev, &dm_ip_block);\n#endif\n\t\telse\n\t\t\tamdgpu_device_ip_block_add(adev, &dce_v8_2_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &uvd_v4_2_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &vce_v2_0_ip_block);\n\t\tbreak;\n\tcase CHIP_HAWAII:\n\t\tamdgpu_device_ip_block_add(adev, &cik_common_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &gmc_v7_0_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &cik_ih_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &gfx_v7_3_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &cik_sdma_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &pp_smu_ip_block);\n\t\tif (adev->enable_virtual_display)\n\t\t\tamdgpu_device_ip_block_add(adev, &amdgpu_vkms_ip_block);\n#if defined(CONFIG_DRM_AMD_DC)\n\t\telse if (amdgpu_device_has_dc_support(adev))\n\t\t\tamdgpu_device_ip_block_add(adev, &dm_ip_block);\n#endif\n\t\telse\n\t\t\tamdgpu_device_ip_block_add(adev, &dce_v8_5_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &uvd_v4_2_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &vce_v2_0_ip_block);\n\t\tbreak;\n\tcase CHIP_KAVERI:\n\t\tamdgpu_device_ip_block_add(adev, &cik_common_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &gmc_v7_0_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &cik_ih_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &gfx_v7_1_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &cik_sdma_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &kv_smu_ip_block);\n\t\tif (adev->enable_virtual_display)\n\t\t\tamdgpu_device_ip_block_add(adev, &amdgpu_vkms_ip_block);\n#if defined(CONFIG_DRM_AMD_DC)\n\t\telse if (amdgpu_device_has_dc_support(adev))\n\t\t\tamdgpu_device_ip_block_add(adev, &dm_ip_block);\n#endif\n\t\telse\n\t\t\tamdgpu_device_ip_block_add(adev, &dce_v8_1_ip_block);\n\n\t\tamdgpu_device_ip_block_add(adev, &uvd_v4_2_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &vce_v2_0_ip_block);\n\t\tbreak;\n\tcase CHIP_KABINI:\n\tcase CHIP_MULLINS:\n\t\tamdgpu_device_ip_block_add(adev, &cik_common_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &gmc_v7_0_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &cik_ih_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &gfx_v7_2_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &cik_sdma_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &kv_smu_ip_block);\n\t\tif (adev->enable_virtual_display)\n\t\t\tamdgpu_device_ip_block_add(adev, &amdgpu_vkms_ip_block);\n#if defined(CONFIG_DRM_AMD_DC)\n\t\telse if (amdgpu_device_has_dc_support(adev))\n\t\t\tamdgpu_device_ip_block_add(adev, &dm_ip_block);\n#endif\n\t\telse\n\t\t\tamdgpu_device_ip_block_add(adev, &dce_v8_3_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &uvd_v4_2_ip_block);\n\t\tamdgpu_device_ip_block_add(adev, &vce_v2_0_ip_block);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}