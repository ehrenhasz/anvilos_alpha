{
  "module_name": "amdgpu_benchmark.c",
  "hash_id": "9ef70add2753fdba41c5e4325cd0d22c6223281173ee2bc89ef26f3e8eb7ae64",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/amdgpu_benchmark.c",
  "human_readable_source": " \n\n#include <drm/amdgpu_drm.h>\n#include \"amdgpu.h\"\n\n#define AMDGPU_BENCHMARK_ITERATIONS 1024\n#define AMDGPU_BENCHMARK_COMMON_MODES_N 17\n\nstatic int amdgpu_benchmark_do_move(struct amdgpu_device *adev, unsigned size,\n\t\t\t\t    uint64_t saddr, uint64_t daddr, int n, s64 *time_ms)\n{\n\tktime_t stime, etime;\n\tstruct dma_fence *fence;\n\tint i, r;\n\n\tstime = ktime_get();\n\tfor (i = 0; i < n; i++) {\n\t\tstruct amdgpu_ring *ring = adev->mman.buffer_funcs_ring;\n\t\tr = amdgpu_copy_buffer(ring, saddr, daddr, size, NULL, &fence,\n\t\t\t\t       false, false, false);\n\t\tif (r)\n\t\t\tgoto exit_do_move;\n\t\tr = dma_fence_wait(fence, false);\n\t\tdma_fence_put(fence);\n\t\tif (r)\n\t\t\tgoto exit_do_move;\n\t}\n\nexit_do_move:\n\tetime = ktime_get();\n\t*time_ms = ktime_ms_delta(etime, stime);\n\n\treturn r;\n}\n\n\nstatic void amdgpu_benchmark_log_results(struct amdgpu_device *adev,\n\t\t\t\t\t int n, unsigned size,\n\t\t\t\t\t s64 time_ms,\n\t\t\t\t\t unsigned sdomain, unsigned ddomain,\n\t\t\t\t\t char *kind)\n{\n\ts64 throughput = (n * (size >> 10));\n\n\tthroughput = div64_s64(throughput, time_ms);\n\n\tdev_info(adev->dev, \"amdgpu: %s %u bo moves of %u kB from\"\n\t\t \" %d to %d in %lld ms, throughput: %lld Mb/s or %lld MB/s\\n\",\n\t\t kind, n, size >> 10, sdomain, ddomain, time_ms,\n\t\t throughput * 8, throughput);\n}\n\nstatic int amdgpu_benchmark_move(struct amdgpu_device *adev, unsigned size,\n\t\t\t\t unsigned sdomain, unsigned ddomain)\n{\n\tstruct amdgpu_bo *dobj = NULL;\n\tstruct amdgpu_bo *sobj = NULL;\n\tuint64_t saddr, daddr;\n\ts64 time_ms;\n\tint r, n;\n\n\tn = AMDGPU_BENCHMARK_ITERATIONS;\n\n\tr = amdgpu_bo_create_kernel(adev, size,\n\t\t\t\t    PAGE_SIZE, sdomain,\n\t\t\t\t    &sobj,\n\t\t\t\t    &saddr,\n\t\t\t\t    NULL);\n\tif (r)\n\t\tgoto out_cleanup;\n\tr = amdgpu_bo_create_kernel(adev, size,\n\t\t\t\t    PAGE_SIZE, ddomain,\n\t\t\t\t    &dobj,\n\t\t\t\t    &daddr,\n\t\t\t\t    NULL);\n\tif (r)\n\t\tgoto out_cleanup;\n\n\tif (adev->mman.buffer_funcs) {\n\t\tr = amdgpu_benchmark_do_move(adev, size, saddr, daddr, n, &time_ms);\n\t\tif (r)\n\t\t\tgoto out_cleanup;\n\t\telse\n\t\t\tamdgpu_benchmark_log_results(adev, n, size, time_ms,\n\t\t\t\t\t\t     sdomain, ddomain, \"dma\");\n\t}\n\nout_cleanup:\n\t \n\tif (r < 0)\n\t\tdev_info(adev->dev, \"Error while benchmarking BO move.\\n\");\n\n\tif (sobj)\n\t\tamdgpu_bo_free_kernel(&sobj, &saddr, NULL);\n\tif (dobj)\n\t\tamdgpu_bo_free_kernel(&dobj, &daddr, NULL);\n\treturn r;\n}\n\nint amdgpu_benchmark(struct amdgpu_device *adev, int test_number)\n{\n\tint i, r;\n\tstatic const int common_modes[AMDGPU_BENCHMARK_COMMON_MODES_N] = {\n\t\t640 * 480 * 4,\n\t\t720 * 480 * 4,\n\t\t800 * 600 * 4,\n\t\t848 * 480 * 4,\n\t\t1024 * 768 * 4,\n\t\t1152 * 768 * 4,\n\t\t1280 * 720 * 4,\n\t\t1280 * 800 * 4,\n\t\t1280 * 854 * 4,\n\t\t1280 * 960 * 4,\n\t\t1280 * 1024 * 4,\n\t\t1440 * 900 * 4,\n\t\t1400 * 1050 * 4,\n\t\t1680 * 1050 * 4,\n\t\t1600 * 1200 * 4,\n\t\t1920 * 1080 * 4,\n\t\t1920 * 1200 * 4\n\t};\n\n\tmutex_lock(&adev->benchmark_mutex);\n\tswitch (test_number) {\n\tcase 1:\n\t\tdev_info(adev->dev,\n\t\t\t \"benchmark test: %d (simple test, VRAM to GTT and GTT to VRAM)\\n\",\n\t\t\t test_number);\n\t\t \n\t\tr = amdgpu_benchmark_move(adev, 1024*1024, AMDGPU_GEM_DOMAIN_GTT,\n\t\t\t\t\t  AMDGPU_GEM_DOMAIN_VRAM);\n\t\tif (r)\n\t\t\tgoto done;\n\t\tr = amdgpu_benchmark_move(adev, 1024*1024, AMDGPU_GEM_DOMAIN_VRAM,\n\t\t\t\t\t  AMDGPU_GEM_DOMAIN_GTT);\n\t\tif (r)\n\t\t\tgoto done;\n\t\tbreak;\n\tcase 2:\n\t\tdev_info(adev->dev,\n\t\t\t \"benchmark test: %d (simple test, VRAM to VRAM)\\n\",\n\t\t\t test_number);\n\t\t \n\t\tr = amdgpu_benchmark_move(adev, 1024*1024, AMDGPU_GEM_DOMAIN_VRAM,\n\t\t\t\t\t  AMDGPU_GEM_DOMAIN_VRAM);\n\t\tif (r)\n\t\t\tgoto done;\n\t\tbreak;\n\tcase 3:\n\t\tdev_info(adev->dev,\n\t\t\t \"benchmark test: %d (GTT to VRAM, buffer size sweep, powers of 2)\\n\",\n\t\t\t test_number);\n\t\t \n\t\tfor (i = 1; i <= 16384; i <<= 1) {\n\t\t\tr = amdgpu_benchmark_move(adev, i * AMDGPU_GPU_PAGE_SIZE,\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_GTT,\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_VRAM);\n\t\t\tif (r)\n\t\t\t\tgoto done;\n\t\t}\n\t\tbreak;\n\tcase 4:\n\t\tdev_info(adev->dev,\n\t\t\t \"benchmark test: %d (VRAM to GTT, buffer size sweep, powers of 2)\\n\",\n\t\t\t test_number);\n\t\t \n\t\tfor (i = 1; i <= 16384; i <<= 1) {\n\t\t\tr = amdgpu_benchmark_move(adev, i * AMDGPU_GPU_PAGE_SIZE,\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_VRAM,\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_GTT);\n\t\t\tif (r)\n\t\t\t\tgoto done;\n\t\t}\n\t\tbreak;\n\tcase 5:\n\t\tdev_info(adev->dev,\n\t\t\t \"benchmark test: %d (VRAM to VRAM, buffer size sweep, powers of 2)\\n\",\n\t\t\t test_number);\n\t\t \n\t\tfor (i = 1; i <= 16384; i <<= 1) {\n\t\t\tr = amdgpu_benchmark_move(adev, i * AMDGPU_GPU_PAGE_SIZE,\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_VRAM,\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_VRAM);\n\t\t\tif (r)\n\t\t\t\tgoto done;\n\t\t}\n\t\tbreak;\n\tcase 6:\n\t\tdev_info(adev->dev,\n\t\t\t \"benchmark test: %d (GTT to VRAM, buffer size sweep, common modes)\\n\",\n\t\t\t test_number);\n\t\t \n\t\tfor (i = 0; i < AMDGPU_BENCHMARK_COMMON_MODES_N; i++) {\n\t\t\tr = amdgpu_benchmark_move(adev, common_modes[i],\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_GTT,\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_VRAM);\n\t\t\tif (r)\n\t\t\t\tgoto done;\n\t\t}\n\t\tbreak;\n\tcase 7:\n\t\tdev_info(adev->dev,\n\t\t\t \"benchmark test: %d (VRAM to GTT, buffer size sweep, common modes)\\n\",\n\t\t\t test_number);\n\t\t \n\t\tfor (i = 0; i < AMDGPU_BENCHMARK_COMMON_MODES_N; i++) {\n\t\t\tr = amdgpu_benchmark_move(adev, common_modes[i],\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_VRAM,\n\t\t\t\t\t\t  AMDGPU_GEM_DOMAIN_GTT);\n\t\t\tif (r)\n\t\t\t\tgoto done;\n\t\t}\n\t\tbreak;\n\tcase 8:\n\t\tdev_info(adev->dev,\n\t\t\t \"benchmark test: %d (VRAM to VRAM, buffer size sweep, common modes)\\n\",\n\t\t\t test_number);\n\t\t \n\t\tfor (i = 0; i < AMDGPU_BENCHMARK_COMMON_MODES_N; i++) {\n\t\t\tr = amdgpu_benchmark_move(adev, common_modes[i],\n\t\t\t\t\t      AMDGPU_GEM_DOMAIN_VRAM,\n\t\t\t\t\t      AMDGPU_GEM_DOMAIN_VRAM);\n\t\t\tif (r)\n\t\t\t\tgoto done;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tdev_info(adev->dev, \"Unknown benchmark %d\\n\", test_number);\n\t\tr = -EINVAL;\n\t\tbreak;\n\t}\n\ndone:\n\tmutex_unlock(&adev->benchmark_mutex);\n\n\treturn r;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}