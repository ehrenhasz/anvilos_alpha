{
  "module_name": "amdgpu_mes.h",
  "hash_id": "8e355a5095e860f1c66b41b210bc3d7fb1a54a5d51bc8ec436b86699a9795515",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/amdgpu_mes.h",
  "human_readable_source": " \n\n#ifndef __AMDGPU_MES_H__\n#define __AMDGPU_MES_H__\n\n#include \"amdgpu_irq.h\"\n#include \"kgd_kfd_interface.h\"\n#include \"amdgpu_gfx.h\"\n#include \"amdgpu_doorbell.h\"\n#include <linux/sched/mm.h>\n\n#define AMDGPU_MES_MAX_COMPUTE_PIPES        8\n#define AMDGPU_MES_MAX_GFX_PIPES            2\n#define AMDGPU_MES_MAX_SDMA_PIPES           2\n\n#define AMDGPU_MES_API_VERSION_SHIFT\t12\n#define AMDGPU_MES_FEAT_VERSION_SHIFT\t24\n\n#define AMDGPU_MES_VERSION_MASK\t\t0x00000fff\n#define AMDGPU_MES_API_VERSION_MASK\t0x00fff000\n#define AMDGPU_MES_FEAT_VERSION_MASK\t0xff000000\n\nenum amdgpu_mes_priority_level {\n\tAMDGPU_MES_PRIORITY_LEVEL_LOW       = 0,\n\tAMDGPU_MES_PRIORITY_LEVEL_NORMAL    = 1,\n\tAMDGPU_MES_PRIORITY_LEVEL_MEDIUM    = 2,\n\tAMDGPU_MES_PRIORITY_LEVEL_HIGH      = 3,\n\tAMDGPU_MES_PRIORITY_LEVEL_REALTIME  = 4,\n\tAMDGPU_MES_PRIORITY_NUM_LEVELS\n};\n\n#define AMDGPU_MES_PROC_CTX_SIZE 0x1000  \n#define AMDGPU_MES_GANG_CTX_SIZE 0x1000  \n\nstruct amdgpu_mes_funcs;\n\nenum admgpu_mes_pipe {\n\tAMDGPU_MES_SCHED_PIPE = 0,\n\tAMDGPU_MES_KIQ_PIPE,\n\tAMDGPU_MAX_MES_PIPES = 2,\n};\n\nstruct amdgpu_mes {\n\tstruct amdgpu_device            *adev;\n\n\tstruct mutex                    mutex_hidden;\n\n\tstruct idr                      pasid_idr;\n\tstruct idr                      gang_id_idr;\n\tstruct idr                      queue_id_idr;\n\tstruct ida                      doorbell_ida;\n\n\tspinlock_t                      queue_id_lock;\n\n\tuint32_t\t\t\tsched_version;\n\tuint32_t\t\t\tkiq_version;\n\n\tuint32_t                        total_max_queue;\n\tuint32_t                        max_doorbell_slices;\n\n\tuint64_t                        default_process_quantum;\n\tuint64_t                        default_gang_quantum;\n\n\tstruct amdgpu_ring              ring;\n\tspinlock_t                      ring_lock;\n\n\tconst struct firmware           *fw[AMDGPU_MAX_MES_PIPES];\n\n\t \n\tstruct amdgpu_bo\t\t*ucode_fw_obj[AMDGPU_MAX_MES_PIPES];\n\tuint64_t\t\t\tucode_fw_gpu_addr[AMDGPU_MAX_MES_PIPES];\n\tuint32_t\t\t\t*ucode_fw_ptr[AMDGPU_MAX_MES_PIPES];\n\tuint64_t                        uc_start_addr[AMDGPU_MAX_MES_PIPES];\n\n\t \n\tstruct amdgpu_bo\t\t*data_fw_obj[AMDGPU_MAX_MES_PIPES];\n\tuint64_t\t\t\tdata_fw_gpu_addr[AMDGPU_MAX_MES_PIPES];\n\tuint32_t\t\t\t*data_fw_ptr[AMDGPU_MAX_MES_PIPES];\n\tuint64_t                        data_start_addr[AMDGPU_MAX_MES_PIPES];\n\n\t \n\tstruct amdgpu_bo\t\t*eop_gpu_obj[AMDGPU_MAX_MES_PIPES];\n\tuint64_t                        eop_gpu_addr[AMDGPU_MAX_MES_PIPES];\n\n\tvoid                            *mqd_backup[AMDGPU_MAX_MES_PIPES];\n\tstruct amdgpu_irq_src\t        irq[AMDGPU_MAX_MES_PIPES];\n\n\tuint32_t                        vmid_mask_gfxhub;\n\tuint32_t                        vmid_mask_mmhub;\n\tuint32_t                        compute_hqd_mask[AMDGPU_MES_MAX_COMPUTE_PIPES];\n\tuint32_t                        gfx_hqd_mask[AMDGPU_MES_MAX_GFX_PIPES];\n\tuint32_t                        sdma_hqd_mask[AMDGPU_MES_MAX_SDMA_PIPES];\n\tuint32_t                        aggregated_doorbells[AMDGPU_MES_PRIORITY_NUM_LEVELS];\n\tuint32_t                        sch_ctx_offs;\n\tuint64_t\t\t\tsch_ctx_gpu_addr;\n\tuint64_t\t\t\t*sch_ctx_ptr;\n\tuint32_t\t\t\tquery_status_fence_offs;\n\tuint64_t\t\t\tquery_status_fence_gpu_addr;\n\tuint64_t\t\t\t*query_status_fence_ptr;\n\tuint32_t                        read_val_offs;\n\tuint64_t\t\t\tread_val_gpu_addr;\n\tuint32_t\t\t\t*read_val_ptr;\n\n\tuint32_t\t\t\tsaved_flags;\n\n\t \n\tint                             (*kiq_hw_init)(struct amdgpu_device *adev);\n\tint                             (*kiq_hw_fini)(struct amdgpu_device *adev);\n\n\t \n\tuint32_t\t\t\tdb_start_dw_offset;\n\tuint32_t\t\t\tnum_mes_dbs;\n\tunsigned long\t\t\t*doorbell_bitmap;\n\n\t \n\tconst struct amdgpu_mes_funcs   *funcs;\n};\n\nstruct amdgpu_mes_process {\n\tint\t\t\tpasid;\n\tstruct\t\t\tamdgpu_vm *vm;\n\tuint64_t\t\tpd_gpu_addr;\n\tstruct amdgpu_bo \t*proc_ctx_bo;\n\tuint64_t \t\tproc_ctx_gpu_addr;\n\tvoid \t\t\t*proc_ctx_cpu_ptr;\n\tuint64_t \t\tprocess_quantum;\n\tstruct \t\t\tlist_head gang_list;\n\tuint32_t \t\tdoorbell_index;\n\tstruct mutex\t\tdoorbell_lock;\n};\n\nstruct amdgpu_mes_gang {\n\tint \t\t\t\tgang_id;\n\tint \t\t\t\tpriority;\n\tint \t\t\t\tinprocess_gang_priority;\n\tint \t\t\t\tglobal_priority_level;\n\tstruct list_head \t\tlist;\n\tstruct amdgpu_mes_process \t*process;\n\tstruct amdgpu_bo \t\t*gang_ctx_bo;\n\tuint64_t \t\t\tgang_ctx_gpu_addr;\n\tvoid \t\t\t\t*gang_ctx_cpu_ptr;\n\tuint64_t \t\t\tgang_quantum;\n\tstruct list_head \t\tqueue_list;\n};\n\nstruct amdgpu_mes_queue {\n\tstruct list_head \t\tlist;\n\tstruct amdgpu_mes_gang \t\t*gang;\n\tint \t\t\t\tqueue_id;\n\tuint64_t \t\t\tdoorbell_off;\n\tstruct amdgpu_bo\t\t*mqd_obj;\n\tvoid\t\t\t\t*mqd_cpu_ptr;\n\tuint64_t \t\t\tmqd_gpu_addr;\n\tuint64_t \t\t\twptr_gpu_addr;\n\tint \t\t\t\tqueue_type;\n\tint \t\t\t\tpaging;\n\tstruct amdgpu_ring \t\t*ring;\n};\n\nstruct amdgpu_mes_queue_properties {\n\tint \t\t\tqueue_type;\n\tuint64_t                hqd_base_gpu_addr;\n\tuint64_t                rptr_gpu_addr;\n\tuint64_t                wptr_gpu_addr;\n\tuint64_t                wptr_mc_addr;\n\tuint32_t                queue_size;\n\tuint64_t                eop_gpu_addr;\n\tuint32_t                hqd_pipe_priority;\n\tuint32_t                hqd_queue_priority;\n\tbool \t\t\tpaging;\n\tstruct amdgpu_ring \t*ring;\n\t \n\tuint64_t       \t\tdoorbell_off;\n};\n\nstruct amdgpu_mes_gang_properties {\n\tuint32_t \tpriority;\n\tuint32_t \tgang_quantum;\n\tuint32_t \tinprocess_gang_priority;\n\tuint32_t \tpriority_level;\n\tint \t\tglobal_priority_level;\n};\n\nstruct mes_add_queue_input {\n\tuint32_t\tprocess_id;\n\tuint64_t\tpage_table_base_addr;\n\tuint64_t\tprocess_va_start;\n\tuint64_t\tprocess_va_end;\n\tuint64_t\tprocess_quantum;\n\tuint64_t\tprocess_context_addr;\n\tuint64_t\tgang_quantum;\n\tuint64_t\tgang_context_addr;\n\tuint32_t\tinprocess_gang_priority;\n\tuint32_t\tgang_global_priority_level;\n\tuint32_t\tdoorbell_offset;\n\tuint64_t\tmqd_addr;\n\tuint64_t\twptr_addr;\n\tuint64_t\twptr_mc_addr;\n\tuint32_t\tqueue_type;\n\tuint32_t\tpaging;\n\tuint32_t        gws_base;\n\tuint32_t        gws_size;\n\tuint64_t\ttba_addr;\n\tuint64_t\ttma_addr;\n\tuint32_t\ttrap_en;\n\tuint32_t\tskip_process_ctx_clear;\n\tuint32_t\tis_kfd_process;\n\tuint32_t\tis_aql_queue;\n\tuint32_t\tqueue_size;\n\tuint32_t\texclusively_scheduled;\n};\n\nstruct mes_remove_queue_input {\n\tuint32_t\tdoorbell_offset;\n\tuint64_t\tgang_context_addr;\n};\n\nstruct mes_unmap_legacy_queue_input {\n\tenum amdgpu_unmap_queues_action    action;\n\tuint32_t                           queue_type;\n\tuint32_t                           doorbell_offset;\n\tuint32_t                           pipe_id;\n\tuint32_t                           queue_id;\n\tuint64_t                           trail_fence_addr;\n\tuint64_t                           trail_fence_data;\n};\n\nstruct mes_suspend_gang_input {\n\tbool\t\tsuspend_all_gangs;\n\tuint64_t\tgang_context_addr;\n\tuint64_t\tsuspend_fence_addr;\n\tuint32_t\tsuspend_fence_value;\n};\n\nstruct mes_resume_gang_input {\n\tbool\t\tresume_all_gangs;\n\tuint64_t\tgang_context_addr;\n};\n\nenum mes_misc_opcode {\n\tMES_MISC_OP_WRITE_REG,\n\tMES_MISC_OP_READ_REG,\n\tMES_MISC_OP_WRM_REG_WAIT,\n\tMES_MISC_OP_WRM_REG_WR_WAIT,\n\tMES_MISC_OP_SET_SHADER_DEBUGGER,\n};\n\nstruct mes_misc_op_input {\n\tenum mes_misc_opcode op;\n\n\tunion {\n\t\tstruct {\n\t\t\tuint32_t                  reg_offset;\n\t\t\tuint64_t                  buffer_addr;\n\t\t} read_reg;\n\n\t\tstruct {\n\t\t\tuint32_t                  reg_offset;\n\t\t\tuint32_t                  reg_value;\n\t\t} write_reg;\n\n\t\tstruct {\n\t\t\tuint32_t                   ref;\n\t\t\tuint32_t                   mask;\n\t\t\tuint32_t                   reg0;\n\t\t\tuint32_t                   reg1;\n\t\t} wrm_reg;\n\n\t\tstruct {\n\t\t\tuint64_t process_context_addr;\n\t\t\tunion {\n\t\t\t\tstruct {\n\t\t\t\t\tuint64_t single_memop : 1;\n\t\t\t\t\tuint64_t single_alu_op : 1;\n\t\t\t\t\tuint64_t reserved: 30;\n\t\t\t\t};\n\t\t\t\tuint32_t u32all;\n\t\t\t} flags;\n\t\t\tuint32_t spi_gdbg_per_vmid_cntl;\n\t\t\tuint32_t tcp_watch_cntl[4];\n\t\t\tuint32_t trap_en;\n\t\t} set_shader_debugger;\n\t};\n};\n\nstruct amdgpu_mes_funcs {\n\tint (*add_hw_queue)(struct amdgpu_mes *mes,\n\t\t\t    struct mes_add_queue_input *input);\n\n\tint (*remove_hw_queue)(struct amdgpu_mes *mes,\n\t\t\t       struct mes_remove_queue_input *input);\n\n\tint (*unmap_legacy_queue)(struct amdgpu_mes *mes,\n\t\t\t\t  struct mes_unmap_legacy_queue_input *input);\n\n\tint (*suspend_gang)(struct amdgpu_mes *mes,\n\t\t\t    struct mes_suspend_gang_input *input);\n\n\tint (*resume_gang)(struct amdgpu_mes *mes,\n\t\t\t   struct mes_resume_gang_input *input);\n\n\tint (*misc_op)(struct amdgpu_mes *mes,\n\t\t       struct mes_misc_op_input *input);\n};\n\n#define amdgpu_mes_kiq_hw_init(adev) (adev)->mes.kiq_hw_init((adev))\n#define amdgpu_mes_kiq_hw_fini(adev) (adev)->mes.kiq_hw_fini((adev))\n\nint amdgpu_mes_ctx_get_offs(struct amdgpu_ring *ring, unsigned int id_offs);\n\nint amdgpu_mes_init_microcode(struct amdgpu_device *adev, int pipe);\nint amdgpu_mes_init(struct amdgpu_device *adev);\nvoid amdgpu_mes_fini(struct amdgpu_device *adev);\n\nint amdgpu_mes_create_process(struct amdgpu_device *adev, int pasid,\n\t\t\t      struct amdgpu_vm *vm);\nvoid amdgpu_mes_destroy_process(struct amdgpu_device *adev, int pasid);\n\nint amdgpu_mes_add_gang(struct amdgpu_device *adev, int pasid,\n\t\t\tstruct amdgpu_mes_gang_properties *gprops,\n\t\t\tint *gang_id);\nint amdgpu_mes_remove_gang(struct amdgpu_device *adev, int gang_id);\n\nint amdgpu_mes_suspend(struct amdgpu_device *adev);\nint amdgpu_mes_resume(struct amdgpu_device *adev);\n\nint amdgpu_mes_add_hw_queue(struct amdgpu_device *adev, int gang_id,\n\t\t\t    struct amdgpu_mes_queue_properties *qprops,\n\t\t\t    int *queue_id);\nint amdgpu_mes_remove_hw_queue(struct amdgpu_device *adev, int queue_id);\n\nint amdgpu_mes_unmap_legacy_queue(struct amdgpu_device *adev,\n\t\t\t\t  struct amdgpu_ring *ring,\n\t\t\t\t  enum amdgpu_unmap_queues_action action,\n\t\t\t\t  u64 gpu_addr, u64 seq);\n\nuint32_t amdgpu_mes_rreg(struct amdgpu_device *adev, uint32_t reg);\nint amdgpu_mes_wreg(struct amdgpu_device *adev,\n\t\t    uint32_t reg, uint32_t val);\nint amdgpu_mes_reg_wait(struct amdgpu_device *adev, uint32_t reg,\n\t\t\tuint32_t val, uint32_t mask);\nint amdgpu_mes_reg_write_reg_wait(struct amdgpu_device *adev,\n\t\t\t\t  uint32_t reg0, uint32_t reg1,\n\t\t\t\t  uint32_t ref, uint32_t mask);\nint amdgpu_mes_set_shader_debugger(struct amdgpu_device *adev,\n\t\t\t\tuint64_t process_context_addr,\n\t\t\t\tuint32_t spi_gdbg_per_vmid_cntl,\n\t\t\t\tconst uint32_t *tcp_watch_cntl,\n\t\t\t\tuint32_t flags,\n\t\t\t\tbool trap_en);\n\nint amdgpu_mes_add_ring(struct amdgpu_device *adev, int gang_id,\n\t\t\tint queue_type, int idx,\n\t\t\tstruct amdgpu_mes_ctx_data *ctx_data,\n\t\t\tstruct amdgpu_ring **out);\nvoid amdgpu_mes_remove_ring(struct amdgpu_device *adev,\n\t\t\t    struct amdgpu_ring *ring);\n\nuint32_t amdgpu_mes_get_aggregated_doorbell_index(struct amdgpu_device *adev,\n\t\t\t\t\t\t   enum amdgpu_mes_priority_level prio);\n\nint amdgpu_mes_ctx_alloc_meta_data(struct amdgpu_device *adev,\n\t\t\t\t   struct amdgpu_mes_ctx_data *ctx_data);\nvoid amdgpu_mes_ctx_free_meta_data(struct amdgpu_mes_ctx_data *ctx_data);\nint amdgpu_mes_ctx_map_meta_data(struct amdgpu_device *adev,\n\t\t\t\t struct amdgpu_vm *vm,\n\t\t\t\t struct amdgpu_mes_ctx_data *ctx_data);\nint amdgpu_mes_ctx_unmap_meta_data(struct amdgpu_device *adev,\n\t\t\t\t   struct amdgpu_mes_ctx_data *ctx_data);\n\nint amdgpu_mes_self_test(struct amdgpu_device *adev);\n\nint amdgpu_mes_doorbell_process_slice(struct amdgpu_device *adev);\n\n \nstatic inline void amdgpu_mes_lock(struct amdgpu_mes *mes)\n{\n\tmutex_lock(&mes->mutex_hidden);\n\tmes->saved_flags = memalloc_noreclaim_save();\n}\n\nstatic inline void amdgpu_mes_unlock(struct amdgpu_mes *mes)\n{\n\tmemalloc_noreclaim_restore(mes->saved_flags);\n\tmutex_unlock(&mes->mutex_hidden);\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}