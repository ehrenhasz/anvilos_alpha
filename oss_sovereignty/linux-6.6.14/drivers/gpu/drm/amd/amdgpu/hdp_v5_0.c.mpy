{
  "module_name": "hdp_v5_0.c",
  "hash_id": "397483830bccf19d21817a5cb79e6c92a65305316f555185411321e53ff82bb3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/hdp_v5_0.c",
  "human_readable_source": " \n#include \"amdgpu.h\"\n#include \"amdgpu_atombios.h\"\n#include \"hdp_v5_0.h\"\n\n#include \"hdp/hdp_5_0_0_offset.h\"\n#include \"hdp/hdp_5_0_0_sh_mask.h\"\n#include <uapi/linux/kfd_ioctl.h>\n\nstatic void hdp_v5_0_flush_hdp(struct amdgpu_device *adev,\n\t\t\t\tstruct amdgpu_ring *ring)\n{\n\tif (!ring || !ring->funcs->emit_wreg)\n\t\tWREG32_NO_KIQ((adev->rmmio_remap.reg_offset + KFD_MMIO_REMAP_HDP_MEM_FLUSH_CNTL) >> 2, 0);\n\telse\n\t\tamdgpu_ring_emit_wreg(ring, (adev->rmmio_remap.reg_offset + KFD_MMIO_REMAP_HDP_MEM_FLUSH_CNTL) >> 2, 0);\n}\n\nstatic void hdp_v5_0_invalidate_hdp(struct amdgpu_device *adev,\n\t\t\t\t    struct amdgpu_ring *ring)\n{\n\tif (!ring || !ring->funcs->emit_wreg) {\n\t\tWREG32_SOC15_NO_KIQ(HDP, 0, mmHDP_READ_CACHE_INVALIDATE, 1);\n\t} else {\n\t\tamdgpu_ring_emit_wreg(ring, SOC15_REG_OFFSET(\n\t\t\t\t\tHDP, 0, mmHDP_READ_CACHE_INVALIDATE), 1);\n\t}\n}\n\nstatic void hdp_v5_0_update_mem_power_gating(struct amdgpu_device *adev,\n\t\t\t\t\t  bool enable)\n{\n\tuint32_t hdp_clk_cntl, hdp_clk_cntl1;\n\tuint32_t hdp_mem_pwr_cntl;\n\n\tif (!(adev->cg_flags & (AMD_CG_SUPPORT_HDP_LS |\n\t\t\t\tAMD_CG_SUPPORT_HDP_DS |\n\t\t\t\tAMD_CG_SUPPORT_HDP_SD)))\n\t\treturn;\n\n\thdp_clk_cntl = hdp_clk_cntl1 = RREG32_SOC15(HDP, 0, mmHDP_CLK_CNTL);\n\thdp_mem_pwr_cntl = RREG32_SOC15(HDP, 0, mmHDP_MEM_POWER_CTRL);\n\n\t \n\thdp_clk_cntl = REG_SET_FIELD(hdp_clk_cntl, HDP_CLK_CNTL,\n\t\t\t\t     IPH_MEM_CLK_SOFT_OVERRIDE, 1);\n\thdp_clk_cntl = REG_SET_FIELD(hdp_clk_cntl, HDP_CLK_CNTL,\n\t\t\t\t     RC_MEM_CLK_SOFT_OVERRIDE, 1);\n\tWREG32_SOC15(HDP, 0, mmHDP_CLK_CNTL, hdp_clk_cntl);\n\n\t \n\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t IPH_MEM_POWER_CTRL_EN, 0);\n\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t IPH_MEM_POWER_LS_EN, 0);\n\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t IPH_MEM_POWER_DS_EN, 0);\n\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t IPH_MEM_POWER_SD_EN, 0);\n\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t RC_MEM_POWER_CTRL_EN, 0);\n\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t RC_MEM_POWER_LS_EN, 0);\n\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t RC_MEM_POWER_DS_EN, 0);\n\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t RC_MEM_POWER_SD_EN, 0);\n\tWREG32_SOC15(HDP, 0, mmHDP_MEM_POWER_CTRL, hdp_mem_pwr_cntl);\n\n\t \n\tif (enable) {\n\t\t \n\t\tif (adev->cg_flags & AMD_CG_SUPPORT_HDP_LS) {\n\t\t\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl,\n\t\t\t\t\t\t\t HDP_MEM_POWER_CTRL,\n\t\t\t\t\t\t\t IPH_MEM_POWER_LS_EN, 1);\n\t\t\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl,\n\t\t\t\t\t\t\t HDP_MEM_POWER_CTRL,\n\t\t\t\t\t\t\t RC_MEM_POWER_LS_EN, 1);\n\t\t} else if (adev->cg_flags & AMD_CG_SUPPORT_HDP_DS) {\n\t\t\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl,\n\t\t\t\t\t\t\t HDP_MEM_POWER_CTRL,\n\t\t\t\t\t\t\t IPH_MEM_POWER_DS_EN, 1);\n\t\t\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl,\n\t\t\t\t\t\t\t HDP_MEM_POWER_CTRL,\n\t\t\t\t\t\t\t RC_MEM_POWER_DS_EN, 1);\n\t\t} else if (adev->cg_flags & AMD_CG_SUPPORT_HDP_SD) {\n\t\t\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl,\n\t\t\t\t\t\t\t HDP_MEM_POWER_CTRL,\n\t\t\t\t\t\t\t IPH_MEM_POWER_SD_EN, 1);\n\t\t\t \n\t\t\tif (adev->cg_flags & AMD_CG_SUPPORT_HDP_DS)\n\t\t\t\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl,\n\t\t\t\t\t\t\t\t HDP_MEM_POWER_CTRL,\n\t\t\t\t\t\t\t\t RC_MEM_POWER_DS_EN, 1);\n\t\t\telse if (adev->cg_flags & AMD_CG_SUPPORT_HDP_LS)\n\t\t\t\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl,\n\t\t\t\t\t\t\t\t HDP_MEM_POWER_CTRL,\n\t\t\t\t\t\t\t\t RC_MEM_POWER_LS_EN, 1);\n\t\t}\n\n\t\t \n\t\tif (adev->cg_flags & (AMD_CG_SUPPORT_HDP_LS | AMD_CG_SUPPORT_HDP_DS |\n\t\t\t\t      AMD_CG_SUPPORT_HDP_SD)) {\n\t\t\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t\t\t IPH_MEM_POWER_CTRL_EN, 1);\n\t\t\thdp_mem_pwr_cntl = REG_SET_FIELD(hdp_mem_pwr_cntl, HDP_MEM_POWER_CTRL,\n\t\t\t\t\t\t\t RC_MEM_POWER_CTRL_EN, 1);\n\t\t\tWREG32_SOC15(HDP, 0, mmHDP_MEM_POWER_CTRL, hdp_mem_pwr_cntl);\n\t\t}\n\t}\n\n\t \n\thdp_clk_cntl = REG_SET_FIELD(hdp_clk_cntl, HDP_CLK_CNTL,\n\t\t\t\t     IPH_MEM_CLK_SOFT_OVERRIDE, 0);\n\thdp_clk_cntl = REG_SET_FIELD(hdp_clk_cntl, HDP_CLK_CNTL,\n\t\t\t\t     RC_MEM_CLK_SOFT_OVERRIDE, 0);\n\tWREG32_SOC15(HDP, 0, mmHDP_CLK_CNTL, hdp_clk_cntl);\n}\n\nstatic void hdp_v5_0_update_medium_grain_clock_gating(struct amdgpu_device *adev,\n\t\t\t\t\t\t      bool enable)\n{\n\tuint32_t hdp_clk_cntl;\n\n\tif (!(adev->cg_flags & AMD_CG_SUPPORT_HDP_MGCG))\n\t\treturn;\n\n\thdp_clk_cntl = RREG32_SOC15(HDP, 0, mmHDP_CLK_CNTL);\n\n\tif (enable) {\n\t\thdp_clk_cntl &=\n\t\t\t~(uint32_t)\n\t\t\t(HDP_CLK_CNTL__IPH_MEM_CLK_SOFT_OVERRIDE_MASK |\n\t\t\t HDP_CLK_CNTL__RC_MEM_CLK_SOFT_OVERRIDE_MASK |\n\t\t\t HDP_CLK_CNTL__DBUS_CLK_SOFT_OVERRIDE_MASK |\n\t\t\t HDP_CLK_CNTL__DYN_CLK_SOFT_OVERRIDE_MASK |\n\t\t\t HDP_CLK_CNTL__XDP_REG_CLK_SOFT_OVERRIDE_MASK |\n\t\t\t HDP_CLK_CNTL__HDP_REG_CLK_SOFT_OVERRIDE_MASK);\n\t} else {\n\t\thdp_clk_cntl |= HDP_CLK_CNTL__IPH_MEM_CLK_SOFT_OVERRIDE_MASK |\n\t\t\tHDP_CLK_CNTL__RC_MEM_CLK_SOFT_OVERRIDE_MASK |\n\t\t\tHDP_CLK_CNTL__DBUS_CLK_SOFT_OVERRIDE_MASK |\n\t\t\tHDP_CLK_CNTL__DYN_CLK_SOFT_OVERRIDE_MASK |\n\t\t\tHDP_CLK_CNTL__XDP_REG_CLK_SOFT_OVERRIDE_MASK |\n\t\t\tHDP_CLK_CNTL__HDP_REG_CLK_SOFT_OVERRIDE_MASK;\n\t}\n\n\tWREG32_SOC15(HDP, 0, mmHDP_CLK_CNTL, hdp_clk_cntl);\n}\n\nstatic void hdp_v5_0_update_clock_gating(struct amdgpu_device *adev,\n\t\t\t\t\t      bool enable)\n{\n\thdp_v5_0_update_mem_power_gating(adev, enable);\n\thdp_v5_0_update_medium_grain_clock_gating(adev, enable);\n}\n\nstatic void hdp_v5_0_get_clockgating_state(struct amdgpu_device *adev,\n\t\t\t\t\t    u64 *flags)\n{\n\tuint32_t tmp;\n\n\t \n\ttmp = RREG32_SOC15(HDP, 0, mmHDP_CLK_CNTL);\n\tif (!(tmp & (HDP_CLK_CNTL__IPH_MEM_CLK_SOFT_OVERRIDE_MASK |\n\t\t     HDP_CLK_CNTL__RC_MEM_CLK_SOFT_OVERRIDE_MASK |\n\t\t     HDP_CLK_CNTL__DBUS_CLK_SOFT_OVERRIDE_MASK |\n\t\t     HDP_CLK_CNTL__DYN_CLK_SOFT_OVERRIDE_MASK |\n\t\t     HDP_CLK_CNTL__XDP_REG_CLK_SOFT_OVERRIDE_MASK |\n\t\t     HDP_CLK_CNTL__HDP_REG_CLK_SOFT_OVERRIDE_MASK)))\n\t\t*flags |= AMD_CG_SUPPORT_HDP_MGCG;\n\n\t \n\ttmp = RREG32_SOC15(HDP, 0, mmHDP_MEM_POWER_CTRL);\n\tif (tmp & HDP_MEM_POWER_CTRL__IPH_MEM_POWER_LS_EN_MASK)\n\t\t*flags |= AMD_CG_SUPPORT_HDP_LS;\n\telse if (tmp & HDP_MEM_POWER_CTRL__IPH_MEM_POWER_DS_EN_MASK)\n\t\t*flags |= AMD_CG_SUPPORT_HDP_DS;\n\telse if (tmp & HDP_MEM_POWER_CTRL__IPH_MEM_POWER_SD_EN_MASK)\n\t\t*flags |= AMD_CG_SUPPORT_HDP_SD;\n}\n\nstatic void hdp_v5_0_init_registers(struct amdgpu_device *adev)\n{\n\tu32 tmp;\n\n\ttmp = RREG32_SOC15(HDP, 0, mmHDP_MISC_CNTL);\n\ttmp |= HDP_MISC_CNTL__FLUSH_INVALIDATE_CACHE_MASK;\n\tWREG32_SOC15(HDP, 0, mmHDP_MISC_CNTL, tmp);\n}\n\nconst struct amdgpu_hdp_funcs hdp_v5_0_funcs = {\n\t.flush_hdp = hdp_v5_0_flush_hdp,\n\t.invalidate_hdp = hdp_v5_0_invalidate_hdp,\n\t.update_clock_gating = hdp_v5_0_update_clock_gating,\n\t.get_clock_gating_state = hdp_v5_0_get_clockgating_state,\n\t.init_registers = hdp_v5_0_init_registers,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}