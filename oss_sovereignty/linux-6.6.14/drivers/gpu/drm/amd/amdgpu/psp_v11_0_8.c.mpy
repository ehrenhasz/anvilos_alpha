{
  "module_name": "psp_v11_0_8.c",
  "hash_id": "84460239a9c21d6c8ec9753f5a313d9aa1c3fa9111ebc1955fed7c4517c62949",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/psp_v11_0_8.c",
  "human_readable_source": " \n#include \"amdgpu.h\"\n#include \"amdgpu_psp.h\"\n#include \"amdgpu_ucode.h\"\n#include \"soc15_common.h\"\n#include \"psp_v11_0_8.h\"\n\n#include \"mp/mp_11_0_8_offset.h\"\n\nstatic int psp_v11_0_8_ring_stop(struct psp_context *psp,\n\t\t\t       enum psp_ring_type ring_type)\n{\n\tint ret = 0;\n\tstruct amdgpu_device *adev = psp->adev;\n\n\tif (amdgpu_sriov_vf(adev)) {\n\t\t \n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_101,\n\t\t\t     GFX_CTRL_CMD_ID_DESTROY_GPCOM_RING);\n\t\t \n\t\tmdelay(20);\n\t\t \n\t\tret = psp_wait_for(psp, SOC15_REG_OFFSET(MP0, 0, mmMP0_SMN_C2PMSG_101),\n\t\t\t\t   0x80000000, 0x80000000, false);\n\t} else {\n\t\t \n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_64,\n\t\t\t     GFX_CTRL_CMD_ID_DESTROY_RINGS);\n\t\t \n\t\tmdelay(20);\n\t\t \n\t\tret = psp_wait_for(psp, SOC15_REG_OFFSET(MP0, 0, mmMP0_SMN_C2PMSG_64),\n\t\t\t\t   0x80000000, 0x80000000, false);\n\t}\n\n\treturn ret;\n}\n\nstatic int psp_v11_0_8_ring_create(struct psp_context *psp,\n\t\t\t\t enum psp_ring_type ring_type)\n{\n\tint ret = 0;\n\tunsigned int psp_ring_reg = 0;\n\tstruct psp_ring *ring = &psp->km_ring;\n\tstruct amdgpu_device *adev = psp->adev;\n\n\tif (amdgpu_sriov_vf(adev)) {\n\t\tret = psp_v11_0_8_ring_stop(psp, ring_type);\n\t\tif (ret) {\n\t\t\tDRM_ERROR(\"psp_v11_0_8_ring_stop_sriov failed!\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\t \n\t\tpsp_ring_reg = lower_32_bits(ring->ring_mem_mc_addr);\n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_102, psp_ring_reg);\n\t\t \n\t\tpsp_ring_reg = upper_32_bits(ring->ring_mem_mc_addr);\n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_103, psp_ring_reg);\n\n\t\t \n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_101,\n\t\t\t     GFX_CTRL_CMD_ID_INIT_GPCOM_RING);\n\n\t\t \n\t\tmdelay(20);\n\n\t\t \n\t\tret = psp_wait_for(psp, SOC15_REG_OFFSET(MP0, 0, mmMP0_SMN_C2PMSG_101),\n\t\t\t\t   0x80000000, 0x8000FFFF, false);\n\n\t} else {\n\t\t \n\t\tret = psp_wait_for(psp, SOC15_REG_OFFSET(MP0, 0, mmMP0_SMN_C2PMSG_64),\n\t\t\t\t   0x80000000, 0x80000000, false);\n\t\tif (ret) {\n\t\t\tDRM_ERROR(\"Failed to wait for trust OS ready for ring creation\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\t \n\t\tpsp_ring_reg = lower_32_bits(ring->ring_mem_mc_addr);\n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_69, psp_ring_reg);\n\t\t \n\t\tpsp_ring_reg = upper_32_bits(ring->ring_mem_mc_addr);\n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_70, psp_ring_reg);\n\t\t \n\t\tpsp_ring_reg = ring->ring_size;\n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_71, psp_ring_reg);\n\t\t \n\t\tpsp_ring_reg = ring_type;\n\t\tpsp_ring_reg = psp_ring_reg << 16;\n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_64, psp_ring_reg);\n\n\t\t \n\t\tmdelay(20);\n\n\t\t \n\t\tret = psp_wait_for(psp, SOC15_REG_OFFSET(MP0, 0, mmMP0_SMN_C2PMSG_64),\n\t\t\t\t   0x80000000, 0x8000FFFF, false);\n\t}\n\n\treturn ret;\n}\n\nstatic int psp_v11_0_8_ring_destroy(struct psp_context *psp,\n\t\t\t\t  enum psp_ring_type ring_type)\n{\n\tint ret = 0;\n\tstruct psp_ring *ring = &psp->km_ring;\n\tstruct amdgpu_device *adev = psp->adev;\n\n\tret = psp_v11_0_8_ring_stop(psp, ring_type);\n\tif (ret)\n\t\tDRM_ERROR(\"Fail to stop psp ring\\n\");\n\n\tamdgpu_bo_free_kernel(&adev->firmware.rbuf,\n\t\t\t      &ring->ring_mem_mc_addr,\n\t\t\t      (void **)&ring->ring_mem);\n\n\treturn ret;\n}\n\nstatic uint32_t psp_v11_0_8_ring_get_wptr(struct psp_context *psp)\n{\n\tuint32_t data;\n\tstruct amdgpu_device *adev = psp->adev;\n\n\tif (amdgpu_sriov_vf(adev))\n\t\tdata = RREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_102);\n\telse\n\t\tdata = RREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_67);\n\n\treturn data;\n}\n\nstatic void psp_v11_0_8_ring_set_wptr(struct psp_context *psp, uint32_t value)\n{\n\tstruct amdgpu_device *adev = psp->adev;\n\n\tif (amdgpu_sriov_vf(adev)) {\n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_102, value);\n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_101,\n\t\t\t     GFX_CTRL_CMD_ID_CONSUME_CMD);\n\t} else\n\t\tWREG32_SOC15(MP0, 0, mmMP0_SMN_C2PMSG_67, value);\n}\n\nstatic const struct psp_funcs psp_v11_0_8_funcs = {\n\t.ring_create = psp_v11_0_8_ring_create,\n\t.ring_stop = psp_v11_0_8_ring_stop,\n\t.ring_destroy = psp_v11_0_8_ring_destroy,\n\t.ring_get_wptr = psp_v11_0_8_ring_get_wptr,\n\t.ring_set_wptr = psp_v11_0_8_ring_set_wptr,\n};\n\nvoid psp_v11_0_8_set_psp_funcs(struct psp_context *psp)\n{\n\tpsp->funcs = &psp_v11_0_8_funcs;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}