{
  "module_name": "amdgpu_atomfirmware.c",
  "hash_id": "1bc4e390c07aef1a34884262eca6ec0d7c7d4fa36f6ef4fbdb0a1141db3898d1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdgpu/amdgpu_atomfirmware.c",
  "human_readable_source": " \n\n#include <drm/amdgpu_drm.h>\n#include \"amdgpu.h\"\n#include \"atomfirmware.h\"\n#include \"amdgpu_atomfirmware.h\"\n#include \"atom.h\"\n#include \"atombios.h\"\n#include \"soc15_hw_ip.h\"\n\nunion firmware_info {\n\tstruct atom_firmware_info_v3_1 v31;\n\tstruct atom_firmware_info_v3_2 v32;\n\tstruct atom_firmware_info_v3_3 v33;\n\tstruct atom_firmware_info_v3_4 v34;\n};\n\n \nuint32_t amdgpu_atomfirmware_query_firmware_capability(struct amdgpu_device *adev)\n{\n\tstruct amdgpu_mode_info *mode_info = &adev->mode_info;\n\tint index;\n\tu16 data_offset, size;\n\tunion firmware_info *firmware_info;\n\tu8 frev, crev;\n\tu32 fw_cap = 0;\n\n\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\tfirmwareinfo);\n\n\tif (amdgpu_atom_parse_data_header(adev->mode_info.atom_context,\n\t\t\t\tindex, &size, &frev, &crev, &data_offset)) {\n\t\t \n\t\tif ((frev == 3 && crev >= 1) || (frev > 3)) {\n\t\t\tfirmware_info = (union firmware_info *)\n\t\t\t\t(mode_info->atom_context->bios + data_offset);\n\t\t\tfw_cap = le32_to_cpu(firmware_info->v31.firmware_capability);\n\t\t}\n\t}\n\n\treturn fw_cap;\n}\n\n \nbool amdgpu_atomfirmware_gpu_virtualization_supported(struct amdgpu_device *adev)\n{\n\tu32 fw_cap;\n\n\tfw_cap = adev->mode_info.firmware_flags;\n\n\treturn (fw_cap & ATOM_FIRMWARE_CAP_GPU_VIRTUALIZATION) ? true : false;\n}\n\nvoid amdgpu_atomfirmware_scratch_regs_init(struct amdgpu_device *adev)\n{\n\tint index = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t\tfirmwareinfo);\n\tuint16_t data_offset;\n\n\tif (amdgpu_atom_parse_data_header(adev->mode_info.atom_context, index, NULL,\n\t\t\t\t\t  NULL, NULL, &data_offset)) {\n\t\tstruct atom_firmware_info_v3_1 *firmware_info =\n\t\t\t(struct atom_firmware_info_v3_1 *)(adev->mode_info.atom_context->bios +\n\t\t\t\t\t\t\t   data_offset);\n\n\t\tadev->bios_scratch_reg_offset =\n\t\t\tle32_to_cpu(firmware_info->bios_scratch_reg_startaddr);\n\t}\n}\n\nstatic int amdgpu_atomfirmware_allocate_fb_v2_1(struct amdgpu_device *adev,\n\tstruct vram_usagebyfirmware_v2_1 *fw_usage, int *usage_bytes)\n{\n\tu32 start_addr, fw_size, drv_size;\n\n\tstart_addr = le32_to_cpu(fw_usage->start_address_in_kb);\n\tfw_size = le16_to_cpu(fw_usage->used_by_firmware_in_kb);\n\tdrv_size = le16_to_cpu(fw_usage->used_by_driver_in_kb);\n\n\tDRM_DEBUG(\"atom firmware v2_1 requested %08x %dkb fw %dkb drv\\n\",\n\t\t\t  start_addr,\n\t\t\t  fw_size,\n\t\t\t  drv_size);\n\n\tif ((start_addr & ATOM_VRAM_OPERATION_FLAGS_MASK) ==\n\t\t(u32)(ATOM_VRAM_BLOCK_SRIOV_MSG_SHARE_RESERVATION <<\n\t\tATOM_VRAM_OPERATION_FLAGS_SHIFT)) {\n\t\t \n\t\tadev->mman.fw_vram_usage_start_offset = (start_addr &\n\t\t\t(~ATOM_VRAM_OPERATION_FLAGS_MASK)) << 10;\n\t\tadev->mman.fw_vram_usage_size = fw_size << 10;\n\t\t \n\t\t*usage_bytes = 0;\n\t} else {\n\t\t*usage_bytes = drv_size << 10;\n\t}\n\treturn 0;\n}\n\nstatic int amdgpu_atomfirmware_allocate_fb_v2_2(struct amdgpu_device *adev,\n\t\tstruct vram_usagebyfirmware_v2_2 *fw_usage, int *usage_bytes)\n{\n\tu32 fw_start_addr, fw_size, drv_start_addr, drv_size;\n\n\tfw_start_addr = le32_to_cpu(fw_usage->fw_region_start_address_in_kb);\n\tfw_size = le16_to_cpu(fw_usage->used_by_firmware_in_kb);\n\n\tdrv_start_addr = le32_to_cpu(fw_usage->driver_region0_start_address_in_kb);\n\tdrv_size = le32_to_cpu(fw_usage->used_by_driver_region0_in_kb);\n\n\tDRM_DEBUG(\"atom requested fw start at %08x %dkb and drv start at %08x %dkb\\n\",\n\t\t\t  fw_start_addr,\n\t\t\t  fw_size,\n\t\t\t  drv_start_addr,\n\t\t\t  drv_size);\n\n\tif (amdgpu_sriov_vf(adev) &&\n\t    ((fw_start_addr & (ATOM_VRAM_BLOCK_NEEDS_NO_RESERVATION <<\n\t\tATOM_VRAM_OPERATION_FLAGS_SHIFT)) == 0)) {\n\t\t \n\t\tadev->mman.fw_vram_usage_start_offset = (fw_start_addr &\n\t\t\t(~ATOM_VRAM_OPERATION_FLAGS_MASK)) << 10;\n\t\tadev->mman.fw_vram_usage_size = fw_size << 10;\n\t}\n\n\tif (amdgpu_sriov_vf(adev) &&\n\t    ((drv_start_addr & (ATOM_VRAM_BLOCK_NEEDS_NO_RESERVATION <<\n\t\tATOM_VRAM_OPERATION_FLAGS_SHIFT)) == 0)) {\n\t\t \n\t\tadev->mman.drv_vram_usage_start_offset = (drv_start_addr &\n\t\t\t(~ATOM_VRAM_OPERATION_FLAGS_MASK)) << 10;\n\t\tadev->mman.drv_vram_usage_size = drv_size << 10;\n\t}\n\n\t*usage_bytes = 0;\n\treturn 0;\n}\n\nint amdgpu_atomfirmware_allocate_fb_scratch(struct amdgpu_device *adev)\n{\n\tstruct atom_context *ctx = adev->mode_info.atom_context;\n\tint index = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t\tvram_usagebyfirmware);\n\tstruct vram_usagebyfirmware_v2_1 *fw_usage_v2_1;\n\tstruct vram_usagebyfirmware_v2_2 *fw_usage_v2_2;\n\tu16 data_offset;\n\tu8 frev, crev;\n\tint usage_bytes = 0;\n\n\tif (amdgpu_atom_parse_data_header(ctx, index, NULL, &frev, &crev, &data_offset)) {\n\t\tif (frev == 2 && crev == 1) {\n\t\t\tfw_usage_v2_1 =\n\t\t\t\t(struct vram_usagebyfirmware_v2_1 *)(ctx->bios + data_offset);\n\t\t\tamdgpu_atomfirmware_allocate_fb_v2_1(adev,\n\t\t\t\t\tfw_usage_v2_1,\n\t\t\t\t\t&usage_bytes);\n\t\t} else if (frev >= 2 && crev >= 2) {\n\t\t\tfw_usage_v2_2 =\n\t\t\t\t(struct vram_usagebyfirmware_v2_2 *)(ctx->bios + data_offset);\n\t\t\tamdgpu_atomfirmware_allocate_fb_v2_2(adev,\n\t\t\t\t\tfw_usage_v2_2,\n\t\t\t\t\t&usage_bytes);\n\t\t}\n\t}\n\n\tctx->scratch_size_bytes = 0;\n\tif (usage_bytes == 0)\n\t\tusage_bytes = 20 * 1024;\n\t \n\tctx->scratch = kzalloc(usage_bytes, GFP_KERNEL);\n\tif (!ctx->scratch)\n\t\treturn -ENOMEM;\n\tctx->scratch_size_bytes = usage_bytes;\n\treturn 0;\n}\n\nunion igp_info {\n\tstruct atom_integrated_system_info_v1_11 v11;\n\tstruct atom_integrated_system_info_v1_12 v12;\n\tstruct atom_integrated_system_info_v2_1 v21;\n};\n\nunion umc_info {\n\tstruct atom_umc_info_v3_1 v31;\n\tstruct atom_umc_info_v3_2 v32;\n\tstruct atom_umc_info_v3_3 v33;\n\tstruct atom_umc_info_v4_0 v40;\n};\n\nunion vram_info {\n\tstruct atom_vram_info_header_v2_3 v23;\n\tstruct atom_vram_info_header_v2_4 v24;\n\tstruct atom_vram_info_header_v2_5 v25;\n\tstruct atom_vram_info_header_v2_6 v26;\n\tstruct atom_vram_info_header_v3_0 v30;\n};\n\nunion vram_module {\n\tstruct atom_vram_module_v9 v9;\n\tstruct atom_vram_module_v10 v10;\n\tstruct atom_vram_module_v11 v11;\n\tstruct atom_vram_module_v3_0 v30;\n};\n\nstatic int convert_atom_mem_type_to_vram_type(struct amdgpu_device *adev,\n\t\t\t\t\t      int atom_mem_type)\n{\n\tint vram_type;\n\n\tif (adev->flags & AMD_IS_APU) {\n\t\tswitch (atom_mem_type) {\n\t\tcase Ddr2MemType:\n\t\tcase LpDdr2MemType:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_DDR2;\n\t\t\tbreak;\n\t\tcase Ddr3MemType:\n\t\tcase LpDdr3MemType:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_DDR3;\n\t\t\tbreak;\n\t\tcase Ddr4MemType:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_DDR4;\n\t\t\tbreak;\n\t\tcase LpDdr4MemType:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_LPDDR4;\n\t\t\tbreak;\n\t\tcase Ddr5MemType:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_DDR5;\n\t\t\tbreak;\n\t\tcase LpDdr5MemType:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_LPDDR5;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_UNKNOWN;\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tswitch (atom_mem_type) {\n\t\tcase ATOM_DGPU_VRAM_TYPE_GDDR5:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_GDDR5;\n\t\t\tbreak;\n\t\tcase ATOM_DGPU_VRAM_TYPE_HBM2:\n\t\tcase ATOM_DGPU_VRAM_TYPE_HBM2E:\n\t\tcase ATOM_DGPU_VRAM_TYPE_HBM3:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_HBM;\n\t\t\tbreak;\n\t\tcase ATOM_DGPU_VRAM_TYPE_GDDR6:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_GDDR6;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tvram_type = AMDGPU_VRAM_TYPE_UNKNOWN;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn vram_type;\n}\n\n\nint\namdgpu_atomfirmware_get_vram_info(struct amdgpu_device *adev,\n\t\t\t\t  int *vram_width, int *vram_type,\n\t\t\t\t  int *vram_vendor)\n{\n\tstruct amdgpu_mode_info *mode_info = &adev->mode_info;\n\tint index, i = 0;\n\tu16 data_offset, size;\n\tunion igp_info *igp_info;\n\tunion vram_info *vram_info;\n\tunion vram_module *vram_module;\n\tu8 frev, crev;\n\tu8 mem_type;\n\tu8 mem_vendor;\n\tu32 mem_channel_number;\n\tu32 mem_channel_width;\n\tu32 module_id;\n\n\tif (adev->flags & AMD_IS_APU)\n\t\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t\t    integratedsysteminfo);\n\telse\n\t\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t\t    vram_info);\n\n\tif (amdgpu_atom_parse_data_header(mode_info->atom_context,\n\t\t\t\t\t  index, &size,\n\t\t\t\t\t  &frev, &crev, &data_offset)) {\n\t\tif (adev->flags & AMD_IS_APU) {\n\t\t\tigp_info = (union igp_info *)\n\t\t\t\t(mode_info->atom_context->bios + data_offset);\n\t\t\tswitch (frev) {\n\t\t\tcase 1:\n\t\t\t\tswitch (crev) {\n\t\t\t\tcase 11:\n\t\t\t\tcase 12:\n\t\t\t\t\tmem_channel_number = igp_info->v11.umachannelnumber;\n\t\t\t\t\tif (!mem_channel_number)\n\t\t\t\t\t\tmem_channel_number = 1;\n\t\t\t\t\tmem_type = igp_info->v11.memorytype;\n\t\t\t\t\tif (mem_type == LpDdr5MemType)\n\t\t\t\t\t\tmem_channel_width = 32;\n\t\t\t\t\telse\n\t\t\t\t\t\tmem_channel_width = 64;\n\t\t\t\t\tif (vram_width)\n\t\t\t\t\t\t*vram_width = mem_channel_number * mem_channel_width;\n\t\t\t\t\tif (vram_type)\n\t\t\t\t\t\t*vram_type = convert_atom_mem_type_to_vram_type(adev, mem_type);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn -EINVAL;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tswitch (crev) {\n\t\t\t\tcase 1:\n\t\t\t\tcase 2:\n\t\t\t\t\tmem_channel_number = igp_info->v21.umachannelnumber;\n\t\t\t\t\tif (!mem_channel_number)\n\t\t\t\t\t\tmem_channel_number = 1;\n\t\t\t\t\tmem_type = igp_info->v21.memorytype;\n\t\t\t\t\tif (mem_type == LpDdr5MemType)\n\t\t\t\t\t\tmem_channel_width = 32;\n\t\t\t\t\telse\n\t\t\t\t\t\tmem_channel_width = 64;\n\t\t\t\t\tif (vram_width)\n\t\t\t\t\t\t*vram_width = mem_channel_number * mem_channel_width;\n\t\t\t\t\tif (vram_type)\n\t\t\t\t\t\t*vram_type = convert_atom_mem_type_to_vram_type(adev, mem_type);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn -EINVAL;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t} else {\n\t\t\tvram_info = (union vram_info *)\n\t\t\t\t(mode_info->atom_context->bios + data_offset);\n\t\t\tmodule_id = (RREG32(adev->bios_scratch_reg_offset + 4) & 0x00ff0000) >> 16;\n\t\t\tif (frev == 3) {\n\t\t\t\tswitch (crev) {\n\t\t\t\t \n\t\t\t\tcase 0:\n\t\t\t\t\tvram_module = (union vram_module *)vram_info->v30.vram_module;\n\t\t\t\t\tmem_vendor = (vram_module->v30.dram_vendor_id) & 0xF;\n\t\t\t\t\tif (vram_vendor)\n\t\t\t\t\t\t*vram_vendor = mem_vendor;\n\t\t\t\t\tmem_type = vram_info->v30.memory_type;\n\t\t\t\t\tif (vram_type)\n\t\t\t\t\t\t*vram_type = convert_atom_mem_type_to_vram_type(adev, mem_type);\n\t\t\t\t\tmem_channel_number = vram_info->v30.channel_num;\n\t\t\t\t\tmem_channel_width = vram_info->v30.channel_width;\n\t\t\t\t\tif (vram_width)\n\t\t\t\t\t\t*vram_width = mem_channel_number * (1 << mem_channel_width);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn -EINVAL;\n\t\t\t\t}\n\t\t\t} else if (frev == 2) {\n\t\t\t\tswitch (crev) {\n\t\t\t\t \n\t\t\t\tcase 3:\n\t\t\t\t\tif (module_id > vram_info->v23.vram_module_num)\n\t\t\t\t\t\tmodule_id = 0;\n\t\t\t\t\tvram_module = (union vram_module *)vram_info->v23.vram_module;\n\t\t\t\t\twhile (i < module_id) {\n\t\t\t\t\t\tvram_module = (union vram_module *)\n\t\t\t\t\t\t\t((u8 *)vram_module + vram_module->v9.vram_module_size);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tmem_type = vram_module->v9.memory_type;\n\t\t\t\t\tif (vram_type)\n\t\t\t\t\t\t*vram_type = convert_atom_mem_type_to_vram_type(adev, mem_type);\n\t\t\t\t\tmem_channel_number = vram_module->v9.channel_num;\n\t\t\t\t\tmem_channel_width = vram_module->v9.channel_width;\n\t\t\t\t\tif (vram_width)\n\t\t\t\t\t\t*vram_width = mem_channel_number * (1 << mem_channel_width);\n\t\t\t\t\tmem_vendor = (vram_module->v9.vender_rev_id) & 0xF;\n\t\t\t\t\tif (vram_vendor)\n\t\t\t\t\t\t*vram_vendor = mem_vendor;\n\t\t\t\t\tbreak;\n\t\t\t\t \n\t\t\t\tcase 4:\n\t\t\t\t\tif (module_id > vram_info->v24.vram_module_num)\n\t\t\t\t\t\tmodule_id = 0;\n\t\t\t\t\tvram_module = (union vram_module *)vram_info->v24.vram_module;\n\t\t\t\t\twhile (i < module_id) {\n\t\t\t\t\t\tvram_module = (union vram_module *)\n\t\t\t\t\t\t\t((u8 *)vram_module + vram_module->v10.vram_module_size);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tmem_type = vram_module->v10.memory_type;\n\t\t\t\t\tif (vram_type)\n\t\t\t\t\t\t*vram_type = convert_atom_mem_type_to_vram_type(adev, mem_type);\n\t\t\t\t\tmem_channel_number = vram_module->v10.channel_num;\n\t\t\t\t\tmem_channel_width = vram_module->v10.channel_width;\n\t\t\t\t\tif (vram_width)\n\t\t\t\t\t\t*vram_width = mem_channel_number * (1 << mem_channel_width);\n\t\t\t\t\tmem_vendor = (vram_module->v10.vender_rev_id) & 0xF;\n\t\t\t\t\tif (vram_vendor)\n\t\t\t\t\t\t*vram_vendor = mem_vendor;\n\t\t\t\t\tbreak;\n\t\t\t\t \n\t\t\t\tcase 5:\n\t\t\t\t\tif (module_id > vram_info->v25.vram_module_num)\n\t\t\t\t\t\tmodule_id = 0;\n\t\t\t\t\tvram_module = (union vram_module *)vram_info->v25.vram_module;\n\t\t\t\t\twhile (i < module_id) {\n\t\t\t\t\t\tvram_module = (union vram_module *)\n\t\t\t\t\t\t\t((u8 *)vram_module + vram_module->v11.vram_module_size);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tmem_type = vram_module->v11.memory_type;\n\t\t\t\t\tif (vram_type)\n\t\t\t\t\t\t*vram_type = convert_atom_mem_type_to_vram_type(adev, mem_type);\n\t\t\t\t\tmem_channel_number = vram_module->v11.channel_num;\n\t\t\t\t\tmem_channel_width = vram_module->v11.channel_width;\n\t\t\t\t\tif (vram_width)\n\t\t\t\t\t\t*vram_width = mem_channel_number * (1 << mem_channel_width);\n\t\t\t\t\tmem_vendor = (vram_module->v11.vender_rev_id) & 0xF;\n\t\t\t\t\tif (vram_vendor)\n\t\t\t\t\t\t*vram_vendor = mem_vendor;\n\t\t\t\t\tbreak;\n\t\t\t\t \n\t\t\t\tcase 6:\n\t\t\t\t\tif (module_id > vram_info->v26.vram_module_num)\n\t\t\t\t\t\tmodule_id = 0;\n\t\t\t\t\tvram_module = (union vram_module *)vram_info->v26.vram_module;\n\t\t\t\t\twhile (i < module_id) {\n\t\t\t\t\t\tvram_module = (union vram_module *)\n\t\t\t\t\t\t\t((u8 *)vram_module + vram_module->v9.vram_module_size);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tmem_type = vram_module->v9.memory_type;\n\t\t\t\t\tif (vram_type)\n\t\t\t\t\t\t*vram_type = convert_atom_mem_type_to_vram_type(adev, mem_type);\n\t\t\t\t\tmem_channel_number = vram_module->v9.channel_num;\n\t\t\t\t\tmem_channel_width = vram_module->v9.channel_width;\n\t\t\t\t\tif (vram_width)\n\t\t\t\t\t\t*vram_width = mem_channel_number * (1 << mem_channel_width);\n\t\t\t\t\tmem_vendor = (vram_module->v9.vender_rev_id) & 0xF;\n\t\t\t\t\tif (vram_vendor)\n\t\t\t\t\t\t*vram_vendor = mem_vendor;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn -EINVAL;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t}\n\n\t}\n\n\treturn 0;\n}\n\n \nbool amdgpu_atomfirmware_mem_ecc_supported(struct amdgpu_device *adev)\n{\n\tstruct amdgpu_mode_info *mode_info = &adev->mode_info;\n\tint index;\n\tu16 data_offset, size;\n\tunion umc_info *umc_info;\n\tu8 frev, crev;\n\tbool ecc_default_enabled = false;\n\tu8 umc_config;\n\tu32 umc_config1;\n\n\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\tumc_info);\n\n\tif (amdgpu_atom_parse_data_header(mode_info->atom_context,\n\t\t\t\tindex, &size, &frev, &crev, &data_offset)) {\n\t\tumc_info = (union umc_info *)(mode_info->atom_context->bios + data_offset);\n\t\tif (frev == 3) {\n\t\t\tswitch (crev) {\n\t\t\tcase 1:\n\t\t\t\tumc_config = le32_to_cpu(umc_info->v31.umc_config);\n\t\t\t\tecc_default_enabled =\n\t\t\t\t\t(umc_config & UMC_CONFIG__DEFAULT_MEM_ECC_ENABLE) ? true : false;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tumc_config = le32_to_cpu(umc_info->v32.umc_config);\n\t\t\t\tecc_default_enabled =\n\t\t\t\t\t(umc_config & UMC_CONFIG__DEFAULT_MEM_ECC_ENABLE) ? true : false;\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tumc_config = le32_to_cpu(umc_info->v33.umc_config);\n\t\t\t\tumc_config1 = le32_to_cpu(umc_info->v33.umc_config1);\n\t\t\t\tecc_default_enabled =\n\t\t\t\t\t((umc_config & UMC_CONFIG__DEFAULT_MEM_ECC_ENABLE) ||\n\t\t\t\t\t (umc_config1 & UMC_CONFIG1__ENABLE_ECC_CAPABLE)) ? true : false;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\t \n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else if (frev == 4) {\n\t\t\tswitch (crev) {\n\t\t\tcase 0:\n\t\t\t\tumc_config1 = le32_to_cpu(umc_info->v40.umc_config1);\n\t\t\t\tecc_default_enabled =\n\t\t\t\t\t(umc_config1 & UMC_CONFIG1__ENABLE_ECC_CAPABLE) ? true : false;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\t \n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn ecc_default_enabled;\n}\n\n \nbool amdgpu_atomfirmware_sram_ecc_supported(struct amdgpu_device *adev)\n{\n\tu32 fw_cap;\n\n\tfw_cap = adev->mode_info.firmware_flags;\n\n\treturn (fw_cap & ATOM_FIRMWARE_CAP_SRAM_ECC) ? true : false;\n}\n\n \nbool amdgpu_atomfirmware_dynamic_boot_config_supported(struct amdgpu_device *adev)\n{\n\tu32 fw_cap;\n\n\tfw_cap = adev->mode_info.firmware_flags;\n\n\treturn (fw_cap & ATOM_FIRMWARE_CAP_DYNAMIC_BOOT_CFG_ENABLE) ? true : false;\n}\n\n \nbool amdgpu_atomfirmware_ras_rom_addr(struct amdgpu_device *adev,\n\t\t\t\t      u8 *i2c_address)\n{\n\tstruct amdgpu_mode_info *mode_info = &adev->mode_info;\n\tint index;\n\tu16 data_offset, size;\n\tunion firmware_info *firmware_info;\n\tu8 frev, crev;\n\n\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t    firmwareinfo);\n\n\tif (amdgpu_atom_parse_data_header(adev->mode_info.atom_context,\n\t\t\t\t\t  index, &size, &frev, &crev,\n\t\t\t\t\t  &data_offset)) {\n\t\t \n\t\tif ((frev == 3 && crev >= 4) || (frev > 3)) {\n\t\t\tfirmware_info = (union firmware_info *)\n\t\t\t\t(mode_info->atom_context->bios + data_offset);\n\t\t\t \n\t\t\tif (firmware_info->v34.ras_rom_i2c_slave_addr) {\n\t\t\t\tif (i2c_address)\n\t\t\t\t\t*i2c_address = firmware_info->v34.ras_rom_i2c_slave_addr;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn false;\n}\n\n\nunion smu_info {\n\tstruct atom_smu_info_v3_1 v31;\n\tstruct atom_smu_info_v4_0 v40;\n};\n\nunion gfx_info {\n\tstruct atom_gfx_info_v2_2 v22;\n\tstruct atom_gfx_info_v2_4 v24;\n\tstruct atom_gfx_info_v2_7 v27;\n\tstruct atom_gfx_info_v3_0 v30;\n};\n\nint amdgpu_atomfirmware_get_clock_info(struct amdgpu_device *adev)\n{\n\tstruct amdgpu_mode_info *mode_info = &adev->mode_info;\n\tstruct amdgpu_pll *spll = &adev->clock.spll;\n\tstruct amdgpu_pll *mpll = &adev->clock.mpll;\n\tuint8_t frev, crev;\n\tuint16_t data_offset;\n\tint ret = -EINVAL, index;\n\n\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t    firmwareinfo);\n\tif (amdgpu_atom_parse_data_header(mode_info->atom_context, index, NULL,\n\t\t\t\t   &frev, &crev, &data_offset)) {\n\t\tunion firmware_info *firmware_info =\n\t\t\t(union firmware_info *)(mode_info->atom_context->bios +\n\t\t\t\t\t\tdata_offset);\n\n\t\tadev->clock.default_sclk =\n\t\t\tle32_to_cpu(firmware_info->v31.bootup_sclk_in10khz);\n\t\tadev->clock.default_mclk =\n\t\t\tle32_to_cpu(firmware_info->v31.bootup_mclk_in10khz);\n\n\t\tadev->pm.current_sclk = adev->clock.default_sclk;\n\t\tadev->pm.current_mclk = adev->clock.default_mclk;\n\n\t\tret = 0;\n\t}\n\n\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t    smu_info);\n\tif (amdgpu_atom_parse_data_header(mode_info->atom_context, index, NULL,\n\t\t\t\t   &frev, &crev, &data_offset)) {\n\t\tunion smu_info *smu_info =\n\t\t\t(union smu_info *)(mode_info->atom_context->bios +\n\t\t\t\t\t   data_offset);\n\n\t\t \n\t\tif (frev == 3)\n\t\t\tspll->reference_freq = le32_to_cpu(smu_info->v31.core_refclk_10khz);\n\t\telse if (frev == 4)\n\t\t\tspll->reference_freq = le32_to_cpu(smu_info->v40.core_refclk_10khz);\n\n\t\tspll->reference_div = 0;\n\t\tspll->min_post_div = 1;\n\t\tspll->max_post_div = 1;\n\t\tspll->min_ref_div = 2;\n\t\tspll->max_ref_div = 0xff;\n\t\tspll->min_feedback_div = 4;\n\t\tspll->max_feedback_div = 0xff;\n\t\tspll->best_vco = 0;\n\n\t\tret = 0;\n\t}\n\n\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t    umc_info);\n\tif (amdgpu_atom_parse_data_header(mode_info->atom_context, index, NULL,\n\t\t\t\t   &frev, &crev, &data_offset)) {\n\t\tunion umc_info *umc_info =\n\t\t\t(union umc_info *)(mode_info->atom_context->bios +\n\t\t\t\t\t   data_offset);\n\n\t\t \n\t\tmpll->reference_freq = le32_to_cpu(umc_info->v31.mem_refclk_10khz);\n\n\t\tmpll->reference_div = 0;\n\t\tmpll->min_post_div = 1;\n\t\tmpll->max_post_div = 1;\n\t\tmpll->min_ref_div = 2;\n\t\tmpll->max_ref_div = 0xff;\n\t\tmpll->min_feedback_div = 4;\n\t\tmpll->max_feedback_div = 0xff;\n\t\tmpll->best_vco = 0;\n\n\t\tret = 0;\n\t}\n\n\t \n\tif (adev->asic_type >= CHIP_NAVI10) {\n\t\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t\t   gfx_info);\n\t\tif (amdgpu_atom_parse_data_header(mode_info->atom_context, index, NULL,\n\t\t\t\t\t  &frev, &crev, &data_offset)) {\n\t\t\tunion gfx_info *gfx_info = (union gfx_info *)\n\t\t\t\t(mode_info->atom_context->bios + data_offset);\n\t\t\tif ((frev == 3) ||\n\t\t\t    (frev == 2 && crev == 6)) {\n\t\t\t\tspll->reference_freq = le32_to_cpu(gfx_info->v30.golden_tsc_count_lower_refclk);\n\t\t\t\tret = 0;\n\t\t\t} else if ((frev == 2) &&\n\t\t\t\t   (crev >= 2) &&\n\t\t\t\t   (crev != 6)) {\n\t\t\t\tspll->reference_freq = le32_to_cpu(gfx_info->v22.rlc_gpu_timer_refclk);\n\t\t\t\tret = 0;\n\t\t\t} else {\n\t\t\t\tBUG();\n\t\t\t}\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nint amdgpu_atomfirmware_get_gfx_info(struct amdgpu_device *adev)\n{\n\tstruct amdgpu_mode_info *mode_info = &adev->mode_info;\n\tint index;\n\tuint8_t frev, crev;\n\tuint16_t data_offset;\n\n\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t    gfx_info);\n\tif (amdgpu_atom_parse_data_header(mode_info->atom_context, index, NULL,\n\t\t\t\t   &frev, &crev, &data_offset)) {\n\t\tunion gfx_info *gfx_info = (union gfx_info *)\n\t\t\t(mode_info->atom_context->bios + data_offset);\n\t\tif (frev == 2) {\n\t\t\tswitch (crev) {\n\t\t\tcase 4:\n\t\t\t\tadev->gfx.config.max_shader_engines = gfx_info->v24.max_shader_engines;\n\t\t\t\tadev->gfx.config.max_cu_per_sh = gfx_info->v24.max_cu_per_sh;\n\t\t\t\tadev->gfx.config.max_sh_per_se = gfx_info->v24.max_sh_per_se;\n\t\t\t\tadev->gfx.config.max_backends_per_se = gfx_info->v24.max_backends_per_se;\n\t\t\t\tadev->gfx.config.max_texture_channel_caches = gfx_info->v24.max_texture_channel_caches;\n\t\t\t\tadev->gfx.config.max_gprs = le16_to_cpu(gfx_info->v24.gc_num_gprs);\n\t\t\t\tadev->gfx.config.max_gs_threads = gfx_info->v24.gc_num_max_gs_thds;\n\t\t\t\tadev->gfx.config.gs_vgt_table_depth = gfx_info->v24.gc_gs_table_depth;\n\t\t\t\tadev->gfx.config.gs_prim_buffer_depth =\n\t\t\t\t\tle16_to_cpu(gfx_info->v24.gc_gsprim_buff_depth);\n\t\t\t\tadev->gfx.config.double_offchip_lds_buf =\n\t\t\t\t\tgfx_info->v24.gc_double_offchip_lds_buffer;\n\t\t\t\tadev->gfx.cu_info.wave_front_size = le16_to_cpu(gfx_info->v24.gc_wave_size);\n\t\t\t\tadev->gfx.cu_info.max_waves_per_simd = le16_to_cpu(gfx_info->v24.gc_max_waves_per_simd);\n\t\t\t\tadev->gfx.cu_info.max_scratch_slots_per_cu = gfx_info->v24.gc_max_scratch_slots_per_cu;\n\t\t\t\tadev->gfx.cu_info.lds_size = le16_to_cpu(gfx_info->v24.gc_lds_size);\n\t\t\t\treturn 0;\n\t\t\tcase 7:\n\t\t\t\tadev->gfx.config.max_shader_engines = gfx_info->v27.max_shader_engines;\n\t\t\t\tadev->gfx.config.max_cu_per_sh = gfx_info->v27.max_cu_per_sh;\n\t\t\t\tadev->gfx.config.max_sh_per_se = gfx_info->v27.max_sh_per_se;\n\t\t\t\tadev->gfx.config.max_backends_per_se = gfx_info->v27.max_backends_per_se;\n\t\t\t\tadev->gfx.config.max_texture_channel_caches = gfx_info->v27.max_texture_channel_caches;\n\t\t\t\tadev->gfx.config.max_gprs = le16_to_cpu(gfx_info->v27.gc_num_gprs);\n\t\t\t\tadev->gfx.config.max_gs_threads = gfx_info->v27.gc_num_max_gs_thds;\n\t\t\t\tadev->gfx.config.gs_vgt_table_depth = gfx_info->v27.gc_gs_table_depth;\n\t\t\t\tadev->gfx.config.gs_prim_buffer_depth = le16_to_cpu(gfx_info->v27.gc_gsprim_buff_depth);\n\t\t\t\tadev->gfx.config.double_offchip_lds_buf = gfx_info->v27.gc_double_offchip_lds_buffer;\n\t\t\t\tadev->gfx.cu_info.wave_front_size = le16_to_cpu(gfx_info->v27.gc_wave_size);\n\t\t\t\tadev->gfx.cu_info.max_waves_per_simd = le16_to_cpu(gfx_info->v27.gc_max_waves_per_simd);\n\t\t\t\tadev->gfx.cu_info.max_scratch_slots_per_cu = gfx_info->v27.gc_max_scratch_slots_per_cu;\n\t\t\t\tadev->gfx.cu_info.lds_size = le16_to_cpu(gfx_info->v27.gc_lds_size);\n\t\t\t\treturn 0;\n\t\t\tdefault:\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t} else if (frev == 3) {\n\t\t\tswitch (crev) {\n\t\t\tcase 0:\n\t\t\t\tadev->gfx.config.max_shader_engines = gfx_info->v30.max_shader_engines;\n\t\t\t\tadev->gfx.config.max_cu_per_sh = gfx_info->v30.max_cu_per_sh;\n\t\t\t\tadev->gfx.config.max_sh_per_se = gfx_info->v30.max_sh_per_se;\n\t\t\t\tadev->gfx.config.max_backends_per_se = gfx_info->v30.max_backends_per_se;\n\t\t\t\tadev->gfx.config.max_texture_channel_caches = gfx_info->v30.max_texture_channel_caches;\n\t\t\t\treturn 0;\n\t\t\tdefault:\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t} else {\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t}\n\treturn -EINVAL;\n}\n\n \nbool amdgpu_atomfirmware_mem_training_supported(struct amdgpu_device *adev)\n{\n\tu32 fw_cap;\n\n\tfw_cap = adev->mode_info.firmware_flags;\n\n\treturn (fw_cap & ATOM_FIRMWARE_CAP_ENABLE_2STAGE_BIST_TRAINING) ? true : false;\n}\n\nint amdgpu_atomfirmware_get_fw_reserved_fb_size(struct amdgpu_device *adev)\n{\n\tstruct atom_context *ctx = adev->mode_info.atom_context;\n\tunion firmware_info *firmware_info;\n\tint index;\n\tu16 data_offset, size;\n\tu8 frev, crev;\n\tint fw_reserved_fb_size;\n\n\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\tfirmwareinfo);\n\n\tif (!amdgpu_atom_parse_data_header(ctx, index, &size,\n\t\t\t\t&frev, &crev, &data_offset))\n\t\t \n\t\treturn 0;\n\n\tfirmware_info = (union firmware_info *)(ctx->bios + data_offset);\n\n\tif (frev != 3)\n\t\treturn -EINVAL;\n\n\tswitch (crev) {\n\tcase 4:\n\t\tfw_reserved_fb_size =\n\t\t\t(firmware_info->v34.fw_reserved_size_in_kb << 10);\n\t\tbreak;\n\tdefault:\n\t\tfw_reserved_fb_size = 0;\n\t\tbreak;\n\t}\n\n\treturn fw_reserved_fb_size;\n}\n\n \nint amdgpu_atomfirmware_asic_init(struct amdgpu_device *adev, bool fb_reset)\n{\n\tstruct amdgpu_mode_info *mode_info = &adev->mode_info;\n\tstruct atom_context *ctx;\n\tuint8_t frev, crev;\n\tuint16_t data_offset;\n\tuint32_t bootup_sclk_in10khz, bootup_mclk_in10khz;\n\tstruct asic_init_ps_allocation_v2_1 asic_init_ps_v2_1;\n\tint index;\n\n\tif (!mode_info)\n\t\treturn -EINVAL;\n\n\tctx = mode_info->atom_context;\n\tif (!ctx)\n\t\treturn -EINVAL;\n\n\t \n\tindex = get_index_into_master_table(atom_master_list_of_data_tables_v2_1,\n\t\t\t\t\t    firmwareinfo);\n\tif (amdgpu_atom_parse_data_header(ctx, index, NULL,\n\t\t\t\t&frev, &crev, &data_offset)) {\n\t\tunion firmware_info *firmware_info =\n\t\t\t(union firmware_info *)(ctx->bios +\n\t\t\t\t\t\tdata_offset);\n\n\t\tbootup_sclk_in10khz =\n\t\t\tle32_to_cpu(firmware_info->v31.bootup_sclk_in10khz);\n\t\tbootup_mclk_in10khz =\n\t\t\tle32_to_cpu(firmware_info->v31.bootup_mclk_in10khz);\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\tindex = get_index_into_master_table(atom_master_list_of_command_functions_v2_1,\n\t\t\t\t\tasic_init);\n\tif (amdgpu_atom_parse_cmd_header(mode_info->atom_context, index, &frev, &crev)) {\n\t\tif (frev == 2 && crev >= 1) {\n\t\t\tmemset(&asic_init_ps_v2_1, 0, sizeof(asic_init_ps_v2_1));\n\t\t\tasic_init_ps_v2_1.param.engineparam.sclkfreqin10khz = bootup_sclk_in10khz;\n\t\t\tasic_init_ps_v2_1.param.memparam.mclkfreqin10khz = bootup_mclk_in10khz;\n\t\t\tasic_init_ps_v2_1.param.engineparam.engineflag = b3NORMAL_ENGINE_INIT;\n\t\t\tif (!fb_reset)\n\t\t\t\tasic_init_ps_v2_1.param.memparam.memflag = b3DRAM_SELF_REFRESH_EXIT;\n\t\t\telse\n\t\t\t\tasic_init_ps_v2_1.param.memparam.memflag = 0;\n\t\t} else {\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\treturn amdgpu_atom_execute_table(ctx, ATOM_CMD_INIT, (uint32_t *)&asic_init_ps_v2_1);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}