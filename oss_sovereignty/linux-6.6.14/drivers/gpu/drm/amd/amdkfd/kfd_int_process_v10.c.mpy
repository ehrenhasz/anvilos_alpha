{
  "module_name": "kfd_int_process_v10.c",
  "hash_id": "69bd59996b3a6c9d6a57d8a126af1abd1fbd1a9bad48b26838441a5ab5e31ba8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdkfd/kfd_int_process_v10.c",
  "human_readable_source": " \n\n#include \"kfd_events.h\"\n#include \"kfd_debug.h\"\n#include \"soc15_int.h\"\n#include \"kfd_device_queue_manager.h\"\n\n \n\nenum SQ_INTERRUPT_WORD_ENCODING {\n\tSQ_INTERRUPT_WORD_ENCODING_AUTO = 0x0,\n\tSQ_INTERRUPT_WORD_ENCODING_INST,\n\tSQ_INTERRUPT_WORD_ENCODING_ERROR,\n};\n\nenum SQ_INTERRUPT_ERROR_TYPE {\n\tSQ_INTERRUPT_ERROR_TYPE_EDC_FUE = 0x0,\n\tSQ_INTERRUPT_ERROR_TYPE_ILLEGAL_INST,\n\tSQ_INTERRUPT_ERROR_TYPE_MEMVIOL,\n\tSQ_INTERRUPT_ERROR_TYPE_EDC_FED,\n};\n\n \n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE__SHIFT 0\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__WLT__SHIFT 1\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_BUF0_FULL__SHIFT 2\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_BUF1_FULL__SHIFT 3\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_UTC_ERROR__SHIFT 7\n#define SQ_INTERRUPT_WORD_AUTO_CTXID1__SE_ID__SHIFT 4\n#define SQ_INTERRUPT_WORD_AUTO_CTXID1__ENCODING__SHIFT 6\n\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_MASK 0x00000001\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__WLT_MASK 0x00000002\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_BUF0_FULL_MASK 0x00000004\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_BUF1_FULL_MASK 0x00000008\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_UTC_ERROR_MASK 0x00000080\n#define SQ_INTERRUPT_WORD_AUTO_CTXID1__SE_ID_MASK 0x030\n#define SQ_INTERRUPT_WORD_AUTO_CTXID1__ENCODING_MASK 0x0c0\n\n \n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__DATA__SHIFT 0\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__SA_ID__SHIFT 23\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__PRIV__SHIFT 24\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__WAVE_ID__SHIFT 25\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__SIMD_ID__SHIFT 30\n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__WGP_ID__SHIFT 0\n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__SE_ID__SHIFT 4\n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__ENCODING__SHIFT 6\n\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__DATA_MASK 0x000007fffff\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__SA_ID_MASK 0x0000800000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__PRIV_MASK 0x00001000000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__WAVE_ID_MASK 0x0003e000000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__SIMD_ID_MASK 0x000c0000000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__WGP_ID_MASK 0x00f\n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__SE_ID_MASK 0x030\n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__ENCODING_MASK 0x0c0\n\n#define KFD_CTXID0__ERR_TYPE_MASK 0x780000\n#define KFD_CTXID0__ERR_TYPE__SHIFT 19\n\n \n#define KFD_CONTEXT_ID1_ENC_TYPE_WAVE_MASK\t0x40\n \n#define KFD_CONTEXT_ID0_PRIV_MASK\t\t0x1000000\n \n#define KFD_CONTEXT_ID0_DEBUG_DOORBELL_MASK\t0x0003ff\n#define KFD_CONTEXT_ID0_DEBUG_TRAP_CODE_SHIFT\t10\n#define KFD_CONTEXT_ID0_DEBUG_TRAP_CODE_MASK\t0x07fc00\n#define KFD_DEBUG_DOORBELL_ID(ctxid0)\t((ctxid0) &\t\\\n\t\t\t\tKFD_CONTEXT_ID0_DEBUG_DOORBELL_MASK)\n#define KFD_DEBUG_TRAP_CODE(ctxid0)\t(((ctxid0) &\t\\\n\t\t\t\tKFD_CONTEXT_ID0_DEBUG_TRAP_CODE_MASK)\t\\\n\t\t\t\t>> KFD_CONTEXT_ID0_DEBUG_TRAP_CODE_SHIFT)\n#define KFD_DEBUG_CP_BAD_OP_ECODE_MASK\t\t0x3fffc00\n#define KFD_DEBUG_CP_BAD_OP_ECODE_SHIFT\t\t10\n#define KFD_DEBUG_CP_BAD_OP_ECODE(ctxid0) (((ctxid0) &\t\t\t\\\n\t\t\t\tKFD_DEBUG_CP_BAD_OP_ECODE_MASK)\t\t\\\n\t\t\t\t>> KFD_DEBUG_CP_BAD_OP_ECODE_SHIFT)\n\nstatic void event_interrupt_poison_consumption(struct kfd_node *dev,\n\t\t\t\tuint16_t pasid, uint16_t client_id)\n{\n\tint old_poison, ret = -EINVAL;\n\tstruct kfd_process *p = kfd_lookup_process_by_pasid(pasid);\n\n\tif (!p)\n\t\treturn;\n\n\t \n\told_poison = atomic_cmpxchg(&p->poison, 0, 1);\n\tkfd_unref_process(p);\n\tif (old_poison)\n\t\treturn;\n\n\tswitch (client_id) {\n\tcase SOC15_IH_CLIENTID_SE0SH:\n\tcase SOC15_IH_CLIENTID_SE1SH:\n\tcase SOC15_IH_CLIENTID_SE2SH:\n\tcase SOC15_IH_CLIENTID_SE3SH:\n\tcase SOC15_IH_CLIENTID_UTCL2:\n\t\tret = kfd_dqm_evict_pasid(dev->dqm, pasid);\n\t\tbreak;\n\tcase SOC15_IH_CLIENTID_SDMA0:\n\tcase SOC15_IH_CLIENTID_SDMA1:\n\tcase SOC15_IH_CLIENTID_SDMA2:\n\tcase SOC15_IH_CLIENTID_SDMA3:\n\tcase SOC15_IH_CLIENTID_SDMA4:\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tkfd_signal_poison_consumed_event(dev, pasid);\n\n\t \n\tif (!ret) {\n\t\tdev_warn(dev->adev->dev,\n\t\t\t\"RAS poison consumption, unmap queue flow succeeded: client id %d\\n\",\n\t\t\tclient_id);\n\t\tamdgpu_amdkfd_ras_poison_consumption_handler(dev->adev, false);\n\t} else {\n\t\tdev_warn(dev->adev->dev,\n\t\t\t\"RAS poison consumption, fall back to gpu reset flow: client id %d\\n\",\n\t\t\tclient_id);\n\t\tamdgpu_amdkfd_ras_poison_consumption_handler(dev->adev, true);\n\t}\n}\n\nstatic bool event_interrupt_isr_v10(struct kfd_node *dev,\n\t\t\t\t\tconst uint32_t *ih_ring_entry,\n\t\t\t\t\tuint32_t *patched_ihre,\n\t\t\t\t\tbool *patched_flag)\n{\n\tuint16_t source_id, client_id, pasid, vmid;\n\tconst uint32_t *data = ih_ring_entry;\n\n\tsource_id = SOC15_SOURCE_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tclient_id = SOC15_CLIENT_ID_FROM_IH_ENTRY(ih_ring_entry);\n\n\t \n\tvmid = SOC15_VMID_FROM_IH_ENTRY(ih_ring_entry);\n\tif (!KFD_IRQ_IS_FENCE(client_id, source_id) &&\n\t   (vmid < dev->vm_info.first_vmid_kfd ||\n\t    vmid > dev->vm_info.last_vmid_kfd))\n\t\treturn false;\n\n\tpasid = SOC15_PASID_FROM_IH_ENTRY(ih_ring_entry);\n\n\t \n\tif (client_id != SOC15_IH_CLIENTID_GRBM_CP &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA0 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA1 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA2 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA3 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA4 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA5 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA6 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA7 &&\n\t    client_id != SOC15_IH_CLIENTID_VMC &&\n\t    client_id != SOC15_IH_CLIENTID_VMC1 &&\n\t    client_id != SOC15_IH_CLIENTID_UTCL2 &&\n\t    client_id != SOC15_IH_CLIENTID_SE0SH &&\n\t    client_id != SOC15_IH_CLIENTID_SE1SH &&\n\t    client_id != SOC15_IH_CLIENTID_SE2SH &&\n\t    client_id != SOC15_IH_CLIENTID_SE3SH)\n\t\treturn false;\n\n\tpr_debug(\"client id 0x%x, source id %d, vmid %d, pasid 0x%x. raw data:\\n\",\n\t\t client_id, source_id, vmid, pasid);\n\tpr_debug(\"%8X, %8X, %8X, %8X, %8X, %8X, %8X, %8X.\\n\",\n\t\t data[0], data[1], data[2], data[3],\n\t\t data[4], data[5], data[6], data[7]);\n\n\t \n\tif (WARN_ONCE(pasid == 0, \"Bug: No PASID in KFD interrupt\"))\n\t\treturn 0;\n\n\t \n\treturn source_id == SOC15_INTSRC_CP_END_OF_PIPE ||\n\t\tsource_id == SOC15_INTSRC_SDMA_TRAP ||\n\t\tsource_id == SOC15_INTSRC_SQ_INTERRUPT_MSG ||\n\t\tsource_id == SOC15_INTSRC_CP_BAD_OPCODE ||\n\t\tclient_id == SOC15_IH_CLIENTID_VMC ||\n\t\tclient_id == SOC15_IH_CLIENTID_VMC1 ||\n\t\tclient_id == SOC15_IH_CLIENTID_UTCL2 ||\n\t\tKFD_IRQ_IS_FENCE(client_id, source_id);\n}\n\nstatic void event_interrupt_wq_v10(struct kfd_node *dev,\n\t\t\t\t\tconst uint32_t *ih_ring_entry)\n{\n\tuint16_t source_id, client_id, pasid, vmid;\n\tuint32_t context_id0, context_id1;\n\tuint32_t encoding, sq_intr_err_type;\n\n\tsource_id = SOC15_SOURCE_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tclient_id = SOC15_CLIENT_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tpasid = SOC15_PASID_FROM_IH_ENTRY(ih_ring_entry);\n\tvmid = SOC15_VMID_FROM_IH_ENTRY(ih_ring_entry);\n\tcontext_id0 = SOC15_CONTEXT_ID0_FROM_IH_ENTRY(ih_ring_entry);\n\tcontext_id1 = SOC15_CONTEXT_ID1_FROM_IH_ENTRY(ih_ring_entry);\n\n\tif (client_id == SOC15_IH_CLIENTID_GRBM_CP ||\n\t    client_id == SOC15_IH_CLIENTID_SE0SH ||\n\t    client_id == SOC15_IH_CLIENTID_SE1SH ||\n\t    client_id == SOC15_IH_CLIENTID_SE2SH ||\n\t    client_id == SOC15_IH_CLIENTID_SE3SH) {\n\t\tif (source_id == SOC15_INTSRC_CP_END_OF_PIPE)\n\t\t\tkfd_signal_event_interrupt(pasid, context_id0, 32);\n\t\telse if (source_id == SOC15_INTSRC_SQ_INTERRUPT_MSG) {\n\t\t\tencoding = REG_GET_FIELD(context_id1,\n\t\t\t\t\t\tSQ_INTERRUPT_WORD_WAVE_CTXID1, ENCODING);\n\t\t\tswitch (encoding) {\n\t\t\tcase SQ_INTERRUPT_WORD_ENCODING_AUTO:\n\t\t\t\tpr_debug_ratelimited(\n\t\t\t\t\t\"sq_intr: auto, se %d, ttrace %d, wlt %d, ttrac_buf0_full %d, ttrac_buf1_full %d, ttrace_utc_err %d\\n\",\n\t\t\t\t\tREG_GET_FIELD(context_id1, SQ_INTERRUPT_WORD_AUTO_CTXID1,\n\t\t\t\t\t\t\tSE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0,\n\t\t\t\t\t\t\tTHREAD_TRACE),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0,\n\t\t\t\t\t\t\tWLT),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0,\n\t\t\t\t\t\t\tTHREAD_TRACE_BUF0_FULL),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0,\n\t\t\t\t\t\t\tTHREAD_TRACE_BUF1_FULL),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0,\n\t\t\t\t\t\t\tTHREAD_TRACE_UTC_ERROR));\n\t\t\t\tbreak;\n\t\t\tcase SQ_INTERRUPT_WORD_ENCODING_INST:\n\t\t\t\tpr_debug_ratelimited(\"sq_intr: inst, se %d, data 0x%x, sa %d, priv %d, wave_id %d, simd_id %d, wgp_id %d\\n\",\n\t\t\t\t\tREG_GET_FIELD(context_id1, SQ_INTERRUPT_WORD_WAVE_CTXID1,\n\t\t\t\t\t\t\tSE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tDATA),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tSA_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tPRIV),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tWAVE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tSIMD_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id1, SQ_INTERRUPT_WORD_WAVE_CTXID1,\n\t\t\t\t\t\t\tWGP_ID));\n\t\t\t\tif (context_id0 & SQ_INTERRUPT_WORD_WAVE_CTXID0__PRIV_MASK) {\n\t\t\t\t\tif (kfd_set_dbg_ev_from_interrupt(dev, pasid,\n\t\t\t\t\t\t\tKFD_DEBUG_DOORBELL_ID(context_id0),\n\t\t\t\t\t\t\tKFD_DEBUG_TRAP_CODE(context_id0),\n\t\t\t\t\t\t\tNULL, 0))\n\t\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase SQ_INTERRUPT_WORD_ENCODING_ERROR:\n\t\t\t\tsq_intr_err_type = REG_GET_FIELD(context_id0, KFD_CTXID0,\n\t\t\t\t\t\t\t\tERR_TYPE);\n\t\t\t\tpr_warn_ratelimited(\"sq_intr: error, se %d, data 0x%x, sa %d, priv %d, wave_id %d, simd_id %d, wgp_id %d, err_type %d\\n\",\n\t\t\t\t\tREG_GET_FIELD(context_id1, SQ_INTERRUPT_WORD_WAVE_CTXID1,\n\t\t\t\t\t\t\tSE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tDATA),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tSA_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tPRIV),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tWAVE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0,\n\t\t\t\t\t\t\tSIMD_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id1, SQ_INTERRUPT_WORD_WAVE_CTXID1,\n\t\t\t\t\t\t\tWGP_ID),\n\t\t\t\t\tsq_intr_err_type);\n\t\t\t\tif (sq_intr_err_type != SQ_INTERRUPT_ERROR_TYPE_ILLEGAL_INST &&\n\t\t\t\t\tsq_intr_err_type != SQ_INTERRUPT_ERROR_TYPE_MEMVIOL) {\n\t\t\t\t\tevent_interrupt_poison_consumption(dev, pasid, source_id);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tkfd_signal_event_interrupt(pasid, context_id0 & 0x7fffff, 23);\n\t\t} else if (source_id == SOC15_INTSRC_CP_BAD_OPCODE) {\n\t\t\tkfd_set_dbg_ev_from_interrupt(dev, pasid,\n\t\t\t\tKFD_DEBUG_DOORBELL_ID(context_id0),\n\t\t\t\tKFD_EC_MASK(KFD_DEBUG_CP_BAD_OP_ECODE(context_id0)),\n\t\t\t\tNULL,\n\t\t\t\t0);\n\t\t}\n\t} else if (client_id == SOC15_IH_CLIENTID_SDMA0 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA1 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA2 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA3 ||\n\t\t   (client_id == SOC15_IH_CLIENTID_SDMA3_Sienna_Cichlid &&\n\t\t    KFD_GC_VERSION(dev) == IP_VERSION(10, 3, 0)) ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA4 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA5 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA6 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA7) {\n\t\tif (source_id == SOC15_INTSRC_SDMA_TRAP) {\n\t\t\tkfd_signal_event_interrupt(pasid, context_id0 & 0xfffffff, 28);\n\t\t} else if (source_id == SOC15_INTSRC_SDMA_ECC) {\n\t\t\tevent_interrupt_poison_consumption(dev, pasid, source_id);\n\t\t\treturn;\n\t\t}\n\t} else if (client_id == SOC15_IH_CLIENTID_VMC ||\n\t\t   client_id == SOC15_IH_CLIENTID_VMC1 ||\n\t\t   client_id == SOC15_IH_CLIENTID_UTCL2) {\n\t\tstruct kfd_vm_fault_info info = {0};\n\t\tuint16_t ring_id = SOC15_RING_ID_FROM_IH_ENTRY(ih_ring_entry);\n\t\tstruct kfd_hsa_memory_exception_data exception_data;\n\n\t\tif (client_id == SOC15_IH_CLIENTID_UTCL2 &&\n\t\t\t\tamdgpu_amdkfd_ras_query_utcl2_poison_status(dev->adev)) {\n\t\t\tevent_interrupt_poison_consumption(dev, pasid, client_id);\n\t\t\treturn;\n\t\t}\n\n\t\tinfo.vmid = vmid;\n\t\tinfo.mc_id = client_id;\n\t\tinfo.page_addr = ih_ring_entry[4] |\n\t\t\t(uint64_t)(ih_ring_entry[5] & 0xf) << 32;\n\t\tinfo.prot_valid = ring_id & 0x08;\n\t\tinfo.prot_read  = ring_id & 0x10;\n\t\tinfo.prot_write = ring_id & 0x20;\n\n\t\tmemset(&exception_data, 0, sizeof(exception_data));\n\t\texception_data.gpu_id = dev->id;\n\t\texception_data.va = (info.page_addr) << PAGE_SHIFT;\n\t\texception_data.failure.NotPresent = info.prot_valid ? 1 : 0;\n\t\texception_data.failure.NoExecute = info.prot_exec ? 1 : 0;\n\t\texception_data.failure.ReadOnly = info.prot_write ? 1 : 0;\n\t\texception_data.failure.imprecise = 0;\n\n\t\tkfd_set_dbg_ev_from_interrupt(dev,\n\t\t\t\t\t\tpasid,\n\t\t\t\t\t\t-1,\n\t\t\t\t\t\tKFD_EC_MASK(EC_DEVICE_MEMORY_VIOLATION),\n\t\t\t\t\t\t&exception_data,\n\t\t\t\t\t\tsizeof(exception_data));\n\t} else if (KFD_IRQ_IS_FENCE(client_id, source_id)) {\n\t\tkfd_process_close_interrupt_drain(pasid);\n\t}\n}\n\nconst struct kfd_event_interrupt_class event_interrupt_class_v10 = {\n\t.interrupt_isr = event_interrupt_isr_v10,\n\t.interrupt_wq = event_interrupt_wq_v10,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}