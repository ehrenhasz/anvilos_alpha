{
  "module_name": "kfd_int_process_v9.c",
  "hash_id": "05b88dfd9244abb1cc616accddbce1f3d0f2a979633b7600afa795dc4f494666",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdkfd/kfd_int_process_v9.c",
  "human_readable_source": "\n \n\n#include \"kfd_priv.h\"\n#include \"kfd_events.h\"\n#include \"kfd_debug.h\"\n#include \"soc15_int.h\"\n#include \"kfd_device_queue_manager.h\"\n#include \"kfd_smi_events.h\"\n\n \n\nenum SQ_INTERRUPT_WORD_ENCODING {\n\tSQ_INTERRUPT_WORD_ENCODING_AUTO = 0x0,\n\tSQ_INTERRUPT_WORD_ENCODING_INST,\n\tSQ_INTERRUPT_WORD_ENCODING_ERROR,\n};\n\nenum SQ_INTERRUPT_ERROR_TYPE {\n\tSQ_INTERRUPT_ERROR_TYPE_EDC_FUE = 0x0,\n\tSQ_INTERRUPT_ERROR_TYPE_ILLEGAL_INST,\n\tSQ_INTERRUPT_ERROR_TYPE_MEMVIOL,\n\tSQ_INTERRUPT_ERROR_TYPE_EDC_FED,\n};\n\n \n#define SQ_INTERRUPT_WORD_AUTO_CTXID__THREAD_TRACE__SHIFT 0\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__WLT__SHIFT 1\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__THREAD_TRACE_BUF_FULL__SHIFT 2\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__REG_TIMESTAMP__SHIFT 3\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__CMD_TIMESTAMP__SHIFT 4\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__HOST_CMD_OVERFLOW__SHIFT 5\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__HOST_REG_OVERFLOW__SHIFT 6\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__IMMED_OVERFLOW__SHIFT 7\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__THREAD_TRACE_UTC_ERROR__SHIFT 8\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__SE_ID__SHIFT 24\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__ENCODING__SHIFT 26\n\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__THREAD_TRACE_MASK 0x00000001\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__WLT_MASK 0x00000002\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__THREAD_TRACE_BUF_FULL_MASK 0x00000004\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__REG_TIMESTAMP_MASK 0x00000008\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__CMD_TIMESTAMP_MASK 0x00000010\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__HOST_CMD_OVERFLOW_MASK 0x00000020\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__HOST_REG_OVERFLOW_MASK 0x00000040\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__IMMED_OVERFLOW_MASK 0x00000080\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__THREAD_TRACE_UTC_ERROR_MASK 0x00000100\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__SE_ID_MASK 0x03000000\n#define SQ_INTERRUPT_WORD_AUTO_CTXID__ENCODING_MASK 0x0c000000\n\n \n#define SQ_INTERRUPT_WORD_WAVE_CTXID__DATA__SHIFT 0\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__SH_ID__SHIFT 12\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__PRIV__SHIFT 13\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__WAVE_ID__SHIFT 14\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__SIMD_ID__SHIFT 18\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__CU_ID__SHIFT 20\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__SE_ID__SHIFT 24\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__ENCODING__SHIFT 26\n\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__DATA_MASK 0x00000fff\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__SH_ID_MASK 0x00001000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__PRIV_MASK 0x00002000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__WAVE_ID_MASK 0x0003c000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__SIMD_ID_MASK 0x000c0000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__CU_ID_MASK 0x00f00000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__SE_ID_MASK 0x03000000\n#define SQ_INTERRUPT_WORD_WAVE_CTXID__ENCODING_MASK 0x0c000000\n\n \n#define KFD_CONTEXT_ID_GET_SQ_INT_DATA(ctx0, ctx1)                             \\\n\t((ctx0 & 0xfff) | ((ctx0 >> 16) & 0xf000) | ((ctx1 << 16) & 0xff0000))\n\n#define KFD_SQ_INT_DATA__ERR_TYPE_MASK 0xF00000\n#define KFD_SQ_INT_DATA__ERR_TYPE__SHIFT 20\n\n \n#define KFD_INT_DATA_DEBUG_DOORBELL_MASK\t0x0003ff\n#define KFD_INT_DATA_DEBUG_TRAP_CODE_SHIFT\t10\n#define KFD_INT_DATA_DEBUG_TRAP_CODE_MASK\t0x07fc00\n#define KFD_DEBUG_DOORBELL_ID(sq_int_data)\t((sq_int_data) &\t\\\n\t\t\t\tKFD_INT_DATA_DEBUG_DOORBELL_MASK)\n#define KFD_DEBUG_TRAP_CODE(sq_int_data)\t(((sq_int_data) &\t\\\n\t\t\t\tKFD_INT_DATA_DEBUG_TRAP_CODE_MASK)\t\\\n\t\t\t\t>> KFD_INT_DATA_DEBUG_TRAP_CODE_SHIFT)\n#define KFD_DEBUG_CP_BAD_OP_ECODE_MASK\t\t0x3fffc00\n#define KFD_DEBUG_CP_BAD_OP_ECODE_SHIFT\t\t10\n#define KFD_DEBUG_CP_BAD_OP_ECODE(ctxid0)\t(((ctxid0) &\t\t\\\n\t\t\t\tKFD_DEBUG_CP_BAD_OP_ECODE_MASK)\t\t\\\n\t\t\t\t>> KFD_DEBUG_CP_BAD_OP_ECODE_SHIFT)\n\nstatic void event_interrupt_poison_consumption_v9(struct kfd_node *dev,\n\t\t\t\tuint16_t pasid, uint16_t client_id)\n{\n\tint old_poison, ret = -EINVAL;\n\tstruct kfd_process *p = kfd_lookup_process_by_pasid(pasid);\n\n\tif (!p)\n\t\treturn;\n\n\t \n\told_poison = atomic_cmpxchg(&p->poison, 0, 1);\n\tkfd_unref_process(p);\n\tif (old_poison)\n\t\treturn;\n\n\tswitch (client_id) {\n\tcase SOC15_IH_CLIENTID_SE0SH:\n\tcase SOC15_IH_CLIENTID_SE1SH:\n\tcase SOC15_IH_CLIENTID_SE2SH:\n\tcase SOC15_IH_CLIENTID_SE3SH:\n\tcase SOC15_IH_CLIENTID_UTCL2:\n\t\tret = kfd_dqm_evict_pasid(dev->dqm, pasid);\n\t\tbreak;\n\tcase SOC15_IH_CLIENTID_SDMA0:\n\tcase SOC15_IH_CLIENTID_SDMA1:\n\tcase SOC15_IH_CLIENTID_SDMA2:\n\tcase SOC15_IH_CLIENTID_SDMA3:\n\tcase SOC15_IH_CLIENTID_SDMA4:\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tkfd_signal_poison_consumed_event(dev, pasid);\n\n\t \n\tif (!ret) {\n\t\tdev_warn(dev->adev->dev,\n\t\t\t\"RAS poison consumption, unmap queue flow succeeded: client id %d\\n\",\n\t\t\tclient_id);\n\t\tamdgpu_amdkfd_ras_poison_consumption_handler(dev->adev, false);\n\t} else {\n\t\tdev_warn(dev->adev->dev,\n\t\t\t\"RAS poison consumption, fall back to gpu reset flow: client id %d\\n\",\n\t\t\tclient_id);\n\t\tamdgpu_amdkfd_ras_poison_consumption_handler(dev->adev, true);\n\t}\n}\n\nstatic bool context_id_expected(struct kfd_dev *dev)\n{\n\tswitch (KFD_GC_VERSION(dev)) {\n\tcase IP_VERSION(9, 0, 1):\n\t\treturn dev->mec_fw_version >= 0x817a;\n\tcase IP_VERSION(9, 1, 0):\n\tcase IP_VERSION(9, 2, 1):\n\tcase IP_VERSION(9, 2, 2):\n\tcase IP_VERSION(9, 3, 0):\n\tcase IP_VERSION(9, 4, 0):\n\t\treturn dev->mec_fw_version >= 0x17a;\n\tdefault:\n\t\t \n\t\treturn KFD_GC_VERSION(dev) >= IP_VERSION(9, 4, 1);\n\t}\n}\n\nstatic bool event_interrupt_isr_v9(struct kfd_node *dev,\n\t\t\t\t\tconst uint32_t *ih_ring_entry,\n\t\t\t\t\tuint32_t *patched_ihre,\n\t\t\t\t\tbool *patched_flag)\n{\n\tuint16_t source_id, client_id, pasid, vmid;\n\tconst uint32_t *data = ih_ring_entry;\n\n\tsource_id = SOC15_SOURCE_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tclient_id = SOC15_CLIENT_ID_FROM_IH_ENTRY(ih_ring_entry);\n\n\t \n\tvmid = SOC15_VMID_FROM_IH_ENTRY(ih_ring_entry);\n\tif (!KFD_IRQ_IS_FENCE(client_id, source_id) &&\n\t   (vmid < dev->vm_info.first_vmid_kfd ||\n\t    vmid > dev->vm_info.last_vmid_kfd))\n\t\treturn false;\n\n\tpasid = SOC15_PASID_FROM_IH_ENTRY(ih_ring_entry);\n\n\t \n\tif (client_id != SOC15_IH_CLIENTID_GRBM_CP &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA0 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA1 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA2 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA3 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA4 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA5 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA6 &&\n\t    client_id != SOC15_IH_CLIENTID_SDMA7 &&\n\t    client_id != SOC15_IH_CLIENTID_VMC &&\n\t    client_id != SOC15_IH_CLIENTID_VMC1 &&\n\t    client_id != SOC15_IH_CLIENTID_UTCL2 &&\n\t    client_id != SOC15_IH_CLIENTID_SE0SH &&\n\t    client_id != SOC15_IH_CLIENTID_SE1SH &&\n\t    client_id != SOC15_IH_CLIENTID_SE2SH &&\n\t    client_id != SOC15_IH_CLIENTID_SE3SH &&\n\t    !KFD_IRQ_IS_FENCE(client_id, source_id))\n\t\treturn false;\n\n\t \n\tif (!pasid && dev->dqm->sched_policy == KFD_SCHED_POLICY_NO_HWS) {\n\t\tconst uint32_t pasid_mask = 0xffff;\n\n\t\t*patched_flag = true;\n\t\tmemcpy(patched_ihre, ih_ring_entry,\n\t\t\t\tdev->kfd->device_info.ih_ring_entry_size);\n\n\t\tpasid = dev->dqm->vmid_pasid[vmid];\n\n\t\t \n\t\tpatched_ihre[3] = cpu_to_le32((le32_to_cpu(patched_ihre[3])\n\t\t\t\t\t& ~pasid_mask) | pasid);\n\t}\n\n\tpr_debug(\"client id 0x%x, source id %d, vmid %d, pasid 0x%x. raw data:\\n\",\n\t\t client_id, source_id, vmid, pasid);\n\tpr_debug(\"%8X, %8X, %8X, %8X, %8X, %8X, %8X, %8X.\\n\",\n\t\t data[0], data[1], data[2], data[3],\n\t\t data[4], data[5], data[6], data[7]);\n\n\t \n\tif (WARN_ONCE(pasid == 0, \"Bug: No PASID in KFD interrupt\"))\n\t\treturn false;\n\n\t \n\tif (source_id == SOC15_INTSRC_CP_END_OF_PIPE) {\n\t\tuint32_t context_id =\n\t\t\tSOC15_CONTEXT_ID0_FROM_IH_ENTRY(ih_ring_entry);\n\n\t\tif (context_id == 0 && context_id_expected(dev->kfd))\n\t\t\treturn false;\n\t}\n\n\t \n\treturn source_id == SOC15_INTSRC_CP_END_OF_PIPE ||\n\t\tsource_id == SOC15_INTSRC_SDMA_TRAP ||\n\t\tsource_id == SOC15_INTSRC_SDMA_ECC ||\n\t\tsource_id == SOC15_INTSRC_SQ_INTERRUPT_MSG ||\n\t\tsource_id == SOC15_INTSRC_CP_BAD_OPCODE ||\n\t\tKFD_IRQ_IS_FENCE(client_id, source_id) ||\n\t\t((client_id == SOC15_IH_CLIENTID_VMC ||\n\t\tclient_id == SOC15_IH_CLIENTID_VMC1 ||\n\t\tclient_id == SOC15_IH_CLIENTID_UTCL2) &&\n\t\t!amdgpu_no_queue_eviction_on_vm_fault);\n}\n\nstatic void event_interrupt_wq_v9(struct kfd_node *dev,\n\t\t\t\t\tconst uint32_t *ih_ring_entry)\n{\n\tuint16_t source_id, client_id, pasid, vmid;\n\tuint32_t context_id0, context_id1;\n\tuint32_t sq_intr_err, sq_int_data, encoding;\n\n\tsource_id = SOC15_SOURCE_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tclient_id = SOC15_CLIENT_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tpasid = SOC15_PASID_FROM_IH_ENTRY(ih_ring_entry);\n\tvmid = SOC15_VMID_FROM_IH_ENTRY(ih_ring_entry);\n\tcontext_id0 = SOC15_CONTEXT_ID0_FROM_IH_ENTRY(ih_ring_entry);\n\tcontext_id1 = SOC15_CONTEXT_ID1_FROM_IH_ENTRY(ih_ring_entry);\n\n\tif (client_id == SOC15_IH_CLIENTID_GRBM_CP ||\n\t    client_id == SOC15_IH_CLIENTID_SE0SH ||\n\t    client_id == SOC15_IH_CLIENTID_SE1SH ||\n\t    client_id == SOC15_IH_CLIENTID_SE2SH ||\n\t    client_id == SOC15_IH_CLIENTID_SE3SH) {\n\t\tif (source_id == SOC15_INTSRC_CP_END_OF_PIPE)\n\t\t\tkfd_signal_event_interrupt(pasid, context_id0, 32);\n\t\telse if (source_id == SOC15_INTSRC_SQ_INTERRUPT_MSG) {\n\t\t\tsq_int_data = KFD_CONTEXT_ID_GET_SQ_INT_DATA(context_id0, context_id1);\n\t\t\tencoding = REG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, ENCODING);\n\t\t\tswitch (encoding) {\n\t\t\tcase SQ_INTERRUPT_WORD_ENCODING_AUTO:\n\t\t\t\tpr_debug_ratelimited(\n\t\t\t\t\t\"sq_intr: auto, se %d, ttrace %d, wlt %d, ttrac_buf_full %d, reg_tms %d, cmd_tms %d, host_cmd_ovf %d, host_reg_ovf %d, immed_ovf %d, ttrace_utc_err %d\\n\",\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, SE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, THREAD_TRACE),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, WLT),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, THREAD_TRACE_BUF_FULL),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, REG_TIMESTAMP),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, CMD_TIMESTAMP),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, HOST_CMD_OVERFLOW),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, HOST_REG_OVERFLOW),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, IMMED_OVERFLOW),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID, THREAD_TRACE_UTC_ERROR));\n\t\t\t\tbreak;\n\t\t\tcase SQ_INTERRUPT_WORD_ENCODING_INST:\n\t\t\t\tpr_debug_ratelimited(\"sq_intr: inst, se %d, data 0x%x, sh %d, priv %d, wave_id %d, simd_id %d, cu_id %d, intr_data 0x%x\\n\",\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, SE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, DATA),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, SH_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, PRIV),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, WAVE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, SIMD_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, CU_ID),\n\t\t\t\t\tsq_int_data);\n\t\t\t\tif (context_id0 & SQ_INTERRUPT_WORD_WAVE_CTXID__PRIV_MASK) {\n\t\t\t\t\tif (kfd_set_dbg_ev_from_interrupt(dev, pasid,\n\t\t\t\t\t\t\tKFD_DEBUG_DOORBELL_ID(sq_int_data),\n\t\t\t\t\t\t\tKFD_DEBUG_TRAP_CODE(sq_int_data),\n\t\t\t\t\t\t\tNULL, 0))\n\t\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase SQ_INTERRUPT_WORD_ENCODING_ERROR:\n\t\t\t\tsq_intr_err = REG_GET_FIELD(sq_int_data, KFD_SQ_INT_DATA, ERR_TYPE);\n\t\t\t\tpr_warn_ratelimited(\"sq_intr: error, se %d, data 0x%x, sh %d, priv %d, wave_id %d, simd_id %d, cu_id %d, err_type %d\\n\",\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, SE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, DATA),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, SH_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, PRIV),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, WAVE_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, SIMD_ID),\n\t\t\t\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID, CU_ID),\n\t\t\t\t\tsq_intr_err);\n\t\t\t\tif (sq_intr_err != SQ_INTERRUPT_ERROR_TYPE_ILLEGAL_INST &&\n\t\t\t\t\tsq_intr_err != SQ_INTERRUPT_ERROR_TYPE_MEMVIOL) {\n\t\t\t\t\tevent_interrupt_poison_consumption_v9(dev, pasid, client_id);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tkfd_signal_event_interrupt(pasid, sq_int_data, 24);\n\t\t} else if (source_id == SOC15_INTSRC_CP_BAD_OPCODE) {\n\t\t\tkfd_set_dbg_ev_from_interrupt(dev, pasid,\n\t\t\t\tKFD_DEBUG_DOORBELL_ID(context_id0),\n\t\t\t\tKFD_EC_MASK(KFD_DEBUG_CP_BAD_OP_ECODE(context_id0)),\n\t\t\t\tNULL, 0);\n\t\t}\n\t} else if (client_id == SOC15_IH_CLIENTID_SDMA0 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA1 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA2 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA3 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA4 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA5 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA6 ||\n\t\t   client_id == SOC15_IH_CLIENTID_SDMA7) {\n\t\tif (source_id == SOC15_INTSRC_SDMA_TRAP) {\n\t\t\tkfd_signal_event_interrupt(pasid, context_id0 & 0xfffffff, 28);\n\t\t} else if (source_id == SOC15_INTSRC_SDMA_ECC) {\n\t\t\tevent_interrupt_poison_consumption_v9(dev, pasid, client_id);\n\t\t\treturn;\n\t\t}\n\t} else if (client_id == SOC15_IH_CLIENTID_VMC ||\n\t\t   client_id == SOC15_IH_CLIENTID_VMC1 ||\n\t\t   client_id == SOC15_IH_CLIENTID_UTCL2) {\n\t\tstruct kfd_vm_fault_info info = {0};\n\t\tuint16_t ring_id = SOC15_RING_ID_FROM_IH_ENTRY(ih_ring_entry);\n\t\tstruct kfd_hsa_memory_exception_data exception_data;\n\n\t\tif (client_id == SOC15_IH_CLIENTID_UTCL2 &&\n\t\t    amdgpu_amdkfd_ras_query_utcl2_poison_status(dev->adev)) {\n\t\t\tevent_interrupt_poison_consumption_v9(dev, pasid, client_id);\n\t\t\treturn;\n\t\t}\n\n\t\tinfo.vmid = vmid;\n\t\tinfo.mc_id = client_id;\n\t\tinfo.page_addr = ih_ring_entry[4] |\n\t\t\t(uint64_t)(ih_ring_entry[5] & 0xf) << 32;\n\t\tinfo.prot_valid = ring_id & 0x08;\n\t\tinfo.prot_read  = ring_id & 0x10;\n\t\tinfo.prot_write = ring_id & 0x20;\n\n\t\tmemset(&exception_data, 0, sizeof(exception_data));\n\t\texception_data.gpu_id = dev->id;\n\t\texception_data.va = (info.page_addr) << PAGE_SHIFT;\n\t\texception_data.failure.NotPresent = info.prot_valid ? 1 : 0;\n\t\texception_data.failure.NoExecute = info.prot_exec ? 1 : 0;\n\t\texception_data.failure.ReadOnly = info.prot_write ? 1 : 0;\n\t\texception_data.failure.imprecise = 0;\n\n\t\tkfd_set_dbg_ev_from_interrupt(dev,\n\t\t\t\t\t\tpasid,\n\t\t\t\t\t\t-1,\n\t\t\t\t\t\tKFD_EC_MASK(EC_DEVICE_MEMORY_VIOLATION),\n\t\t\t\t\t\t&exception_data,\n\t\t\t\t\t\tsizeof(exception_data));\n\t\tkfd_smi_event_update_vmfault(dev, pasid);\n\t} else if (KFD_IRQ_IS_FENCE(client_id, source_id)) {\n\t\tkfd_process_close_interrupt_drain(pasid);\n\t}\n}\n\nstatic bool event_interrupt_isr_v9_4_3(struct kfd_node *node,\n\t\t\t\tconst uint32_t *ih_ring_entry,\n\t\t\t\tuint32_t *patched_ihre,\n\t\t\t\tbool *patched_flag)\n{\n\tuint16_t node_id, vmid;\n\n\t \n\tnode_id = SOC15_NODEID_FROM_IH_ENTRY(ih_ring_entry);\n\tvmid = SOC15_VMID_FROM_IH_ENTRY(ih_ring_entry);\n\tif (kfd_irq_is_from_node(node, node_id, vmid))\n\t\treturn event_interrupt_isr_v9(node, ih_ring_entry,\n\t\t\t\t\tpatched_ihre, patched_flag);\n\treturn false;\n}\n\nconst struct kfd_event_interrupt_class event_interrupt_class_v9 = {\n\t.interrupt_isr = event_interrupt_isr_v9,\n\t.interrupt_wq = event_interrupt_wq_v9,\n};\n\nconst struct kfd_event_interrupt_class event_interrupt_class_v9_4_3 = {\n\t.interrupt_isr = event_interrupt_isr_v9_4_3,\n\t.interrupt_wq = event_interrupt_wq_v9,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}