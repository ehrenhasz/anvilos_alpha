{
  "module_name": "kfd_packet_manager_v9.c",
  "hash_id": "c0c6475bfc82bb21ea5da64efb2b9146a43a93f80dda89d50d616db0b3900502",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdkfd/kfd_packet_manager_v9.c",
  "human_readable_source": "\n \n\n#include \"kfd_kernel_queue.h\"\n#include \"kfd_device_queue_manager.h\"\n#include \"kfd_pm4_headers_ai.h\"\n#include \"kfd_pm4_headers_aldebaran.h\"\n#include \"kfd_pm4_opcodes.h\"\n#include \"gc/gc_10_1_0_sh_mask.h\"\n\nstatic int pm_map_process_v9(struct packet_manager *pm,\n\t\tuint32_t *buffer, struct qcm_process_device *qpd)\n{\n\tstruct pm4_mes_map_process *packet;\n\tuint64_t vm_page_table_base_addr = qpd->page_table_base;\n\tstruct kfd_node *kfd = pm->dqm->dev;\n\tstruct kfd_process_device *pdd =\n\t\t\tcontainer_of(qpd, struct kfd_process_device, qpd);\n\n\tpacket = (struct pm4_mes_map_process *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_map_process));\n\tpacket->header.u32All = pm_build_pm4_header(IT_MAP_PROCESS,\n\t\t\t\t\tsizeof(struct pm4_mes_map_process));\n\tpacket->bitfields2.diq_enable = (qpd->is_debug) ? 1 : 0;\n\tpacket->bitfields2.process_quantum = 10;\n\tpacket->bitfields2.pasid = qpd->pqm->process->pasid;\n\tpacket->bitfields14.gds_size = qpd->gds_size & 0x3F;\n\tpacket->bitfields14.gds_size_hi = (qpd->gds_size >> 6) & 0xF;\n\tpacket->bitfields14.num_gws = (qpd->mapped_gws_queue) ? qpd->num_gws : 0;\n\tpacket->bitfields14.num_oac = qpd->num_oac;\n\tpacket->bitfields14.sdma_enable = 1;\n\tpacket->bitfields14.num_queues = (qpd->is_debug) ? 0 : qpd->queue_count;\n\n\tif (kfd->dqm->trap_debug_vmid && pdd->process->debug_trap_enabled &&\n\t\t\tpdd->process->runtime_info.runtime_state == DEBUG_RUNTIME_STATE_ENABLED) {\n\t\tpacket->bitfields2.debug_vmid = kfd->dqm->trap_debug_vmid;\n\t\tpacket->bitfields2.new_debug = 1;\n\t}\n\n\tpacket->sh_mem_config = qpd->sh_mem_config;\n\tpacket->sh_mem_bases = qpd->sh_mem_bases;\n\tif (qpd->tba_addr) {\n\t\tpacket->sq_shader_tba_lo = lower_32_bits(qpd->tba_addr >> 8);\n\t\t \n\t\tpacket->sq_shader_tba_hi = upper_32_bits(qpd->tba_addr >> 8)\n\t\t\t\t| 1 << SQ_SHADER_TBA_HI__TRAP_EN__SHIFT;\n\n\t\tpacket->sq_shader_tma_lo = lower_32_bits(qpd->tma_addr >> 8);\n\t\tpacket->sq_shader_tma_hi = upper_32_bits(qpd->tma_addr >> 8);\n\t}\n\n\tpacket->gds_addr_lo = lower_32_bits(qpd->gds_context_area);\n\tpacket->gds_addr_hi = upper_32_bits(qpd->gds_context_area);\n\n\tpacket->vm_context_page_table_base_addr_lo32 =\n\t\t\tlower_32_bits(vm_page_table_base_addr);\n\tpacket->vm_context_page_table_base_addr_hi32 =\n\t\t\tupper_32_bits(vm_page_table_base_addr);\n\n\treturn 0;\n}\n\nstatic int pm_map_process_aldebaran(struct packet_manager *pm,\n\t\tuint32_t *buffer, struct qcm_process_device *qpd)\n{\n\tstruct pm4_mes_map_process_aldebaran *packet;\n\tuint64_t vm_page_table_base_addr = qpd->page_table_base;\n\tstruct kfd_dev *kfd = pm->dqm->dev->kfd;\n\tstruct kfd_process_device *pdd =\n\t\t\tcontainer_of(qpd, struct kfd_process_device, qpd);\n\tint i;\n\n\tpacket = (struct pm4_mes_map_process_aldebaran *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_map_process_aldebaran));\n\tpacket->header.u32All = pm_build_pm4_header(IT_MAP_PROCESS,\n\t\t\tsizeof(struct pm4_mes_map_process_aldebaran));\n\tpacket->bitfields2.diq_enable = (qpd->is_debug) ? 1 : 0;\n\tpacket->bitfields2.process_quantum = 10;\n\tpacket->bitfields2.pasid = qpd->pqm->process->pasid;\n\tpacket->bitfields14.gds_size = qpd->gds_size & 0x3F;\n\tpacket->bitfields14.gds_size_hi = (qpd->gds_size >> 6) & 0xF;\n\tpacket->bitfields14.num_gws = (qpd->mapped_gws_queue) ? qpd->num_gws : 0;\n\tpacket->bitfields14.num_oac = qpd->num_oac;\n\tpacket->bitfields14.sdma_enable = 1;\n\tpacket->bitfields14.num_queues = (qpd->is_debug) ? 0 : qpd->queue_count;\n\tpacket->spi_gdbg_per_vmid_cntl = pdd->spi_dbg_override |\n\t\t\t\t\t\tpdd->spi_dbg_launch_mode;\n\n\tif (pdd->process->debug_trap_enabled) {\n\t\tfor (i = 0; i < kfd->device_info.num_of_watch_points; i++)\n\t\t\tpacket->tcp_watch_cntl[i] = pdd->watch_points[i];\n\n\t\tpacket->bitfields2.single_memops =\n\t\t\t\t!!(pdd->process->dbg_flags & KFD_DBG_TRAP_FLAG_SINGLE_MEM_OP);\n\t}\n\n\tpacket->sh_mem_config = qpd->sh_mem_config;\n\tpacket->sh_mem_bases = qpd->sh_mem_bases;\n\tif (qpd->tba_addr) {\n\t\tpacket->sq_shader_tba_lo = lower_32_bits(qpd->tba_addr >> 8);\n\t\tpacket->sq_shader_tba_hi = upper_32_bits(qpd->tba_addr >> 8);\n\t\tpacket->sq_shader_tma_lo = lower_32_bits(qpd->tma_addr >> 8);\n\t\tpacket->sq_shader_tma_hi = upper_32_bits(qpd->tma_addr >> 8);\n\t}\n\n\tpacket->gds_addr_lo = lower_32_bits(qpd->gds_context_area);\n\tpacket->gds_addr_hi = upper_32_bits(qpd->gds_context_area);\n\n\tpacket->vm_context_page_table_base_addr_lo32 =\n\t\t\tlower_32_bits(vm_page_table_base_addr);\n\tpacket->vm_context_page_table_base_addr_hi32 =\n\t\t\tupper_32_bits(vm_page_table_base_addr);\n\n\treturn 0;\n}\n\nstatic int pm_runlist_v9(struct packet_manager *pm, uint32_t *buffer,\n\t\t\tuint64_t ib, size_t ib_size_in_dwords, bool chain)\n{\n\tstruct pm4_mes_runlist *packet;\n\n\tint concurrent_proc_cnt = 0;\n\tstruct kfd_node *kfd = pm->dqm->dev;\n\n\t \n\tconcurrent_proc_cnt = min(pm->dqm->processes_count,\n\t\t\tkfd->max_proc_per_quantum);\n\n\tpacket = (struct pm4_mes_runlist *)buffer;\n\n\tmemset(buffer, 0, sizeof(struct pm4_mes_runlist));\n\tpacket->header.u32All = pm_build_pm4_header(IT_RUN_LIST,\n\t\t\t\t\t\tsizeof(struct pm4_mes_runlist));\n\n\tpacket->bitfields4.ib_size = ib_size_in_dwords;\n\tpacket->bitfields4.chain = chain ? 1 : 0;\n\tpacket->bitfields4.offload_polling = 0;\n\tpacket->bitfields4.chained_runlist_idle_disable = chain ? 1 : 0;\n\tpacket->bitfields4.valid = 1;\n\tpacket->bitfields4.process_cnt = concurrent_proc_cnt;\n\tpacket->ordinal2 = lower_32_bits(ib);\n\tpacket->ib_base_hi = upper_32_bits(ib);\n\n\treturn 0;\n}\n\nstatic int pm_set_resources_v9(struct packet_manager *pm, uint32_t *buffer,\n\t\t\t\tstruct scheduling_resources *res)\n{\n\tstruct pm4_mes_set_resources *packet;\n\n\tpacket = (struct pm4_mes_set_resources *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_set_resources));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_SET_RESOURCES,\n\t\t\t\t\tsizeof(struct pm4_mes_set_resources));\n\n\tpacket->bitfields2.queue_type =\n\t\t\tqueue_type__mes_set_resources__hsa_interface_queue_hiq;\n\tpacket->bitfields2.vmid_mask = res->vmid_mask;\n\tpacket->bitfields2.unmap_latency = KFD_UNMAP_LATENCY_MS / 100;\n\tpacket->bitfields7.oac_mask = res->oac_mask;\n\tpacket->bitfields8.gds_heap_base = res->gds_heap_base;\n\tpacket->bitfields8.gds_heap_size = res->gds_heap_size;\n\n\tpacket->gws_mask_lo = lower_32_bits(res->gws_mask);\n\tpacket->gws_mask_hi = upper_32_bits(res->gws_mask);\n\n\tpacket->queue_mask_lo = lower_32_bits(res->queue_mask);\n\tpacket->queue_mask_hi = upper_32_bits(res->queue_mask);\n\n\treturn 0;\n}\n\nstatic inline bool pm_use_ext_eng(struct kfd_dev *dev)\n{\n\treturn dev->adev->ip_versions[SDMA0_HWIP][0] >= IP_VERSION(5, 2, 0);\n}\n\nstatic int pm_map_queues_v9(struct packet_manager *pm, uint32_t *buffer,\n\t\tstruct queue *q, bool is_static)\n{\n\tstruct pm4_mes_map_queues *packet;\n\tbool use_static = is_static;\n\n\tpacket = (struct pm4_mes_map_queues *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_map_queues));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_MAP_QUEUES,\n\t\t\t\t\tsizeof(struct pm4_mes_map_queues));\n\tpacket->bitfields2.num_queues = 1;\n\tpacket->bitfields2.queue_sel =\n\t\tqueue_sel__mes_map_queues__map_to_hws_determined_queue_slots_vi;\n\n\tpacket->bitfields2.engine_sel =\n\t\tengine_sel__mes_map_queues__compute_vi;\n\tpacket->bitfields2.gws_control_queue = q->gws ? 1 : 0;\n\tpacket->bitfields2.extended_engine_sel =\n\t\textended_engine_sel__mes_map_queues__legacy_engine_sel;\n\tpacket->bitfields2.queue_type =\n\t\tqueue_type__mes_map_queues__normal_compute_vi;\n\n\tswitch (q->properties.type) {\n\tcase KFD_QUEUE_TYPE_COMPUTE:\n\t\tif (use_static)\n\t\t\tpacket->bitfields2.queue_type =\n\t\tqueue_type__mes_map_queues__normal_latency_static_queue_vi;\n\t\tbreak;\n\tcase KFD_QUEUE_TYPE_DIQ:\n\t\tpacket->bitfields2.queue_type =\n\t\t\tqueue_type__mes_map_queues__debug_interface_queue_vi;\n\t\tbreak;\n\tcase KFD_QUEUE_TYPE_SDMA:\n\tcase KFD_QUEUE_TYPE_SDMA_XGMI:\n\t\tuse_static = false;  \n\t\tif (q->properties.sdma_engine_id < 2 &&\n\t\t    !pm_use_ext_eng(q->device->kfd))\n\t\t\tpacket->bitfields2.engine_sel = q->properties.sdma_engine_id +\n\t\t\t\tengine_sel__mes_map_queues__sdma0_vi;\n\t\telse {\n\t\t\t \n\t\t\tif (q->properties.sdma_engine_id >= 8)\n\t\t\t\tpacket->bitfields2.extended_engine_sel =\n\t\t\t\t\textended_engine_sel__mes_map_queues__sdma8_to_15_sel;\n\t\t\telse\n\t\t\t\tpacket->bitfields2.extended_engine_sel =\n\t\t\t\t\textended_engine_sel__mes_map_queues__sdma0_to_7_sel;\n\n\t\t\tpacket->bitfields2.engine_sel = q->properties.sdma_engine_id % 8;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"queue type %d\", q->properties.type);\n\t\treturn -EINVAL;\n\t}\n\tpacket->bitfields3.doorbell_offset =\n\t\t\tq->properties.doorbell_off;\n\n\tpacket->mqd_addr_lo =\n\t\t\tlower_32_bits(q->gart_mqd_addr);\n\n\tpacket->mqd_addr_hi =\n\t\t\tupper_32_bits(q->gart_mqd_addr);\n\n\tpacket->wptr_addr_lo =\n\t\t\tlower_32_bits((uint64_t)q->properties.write_ptr);\n\n\tpacket->wptr_addr_hi =\n\t\t\tupper_32_bits((uint64_t)q->properties.write_ptr);\n\n\treturn 0;\n}\n\nstatic int pm_set_grace_period_v9(struct packet_manager *pm,\n\t\tuint32_t *buffer,\n\t\tuint32_t grace_period)\n{\n\tstruct pm4_mec_write_data_mmio *packet;\n\tuint32_t reg_offset = 0;\n\tuint32_t reg_data = 0;\n\n\tpm->dqm->dev->kfd2kgd->build_grace_period_packet_info(\n\t\t\tpm->dqm->dev->adev,\n\t\t\tpm->dqm->wait_times,\n\t\t\tgrace_period,\n\t\t\t&reg_offset,\n\t\t\t&reg_data);\n\n\tif (grace_period == USE_DEFAULT_GRACE_PERIOD)\n\t\treg_data = pm->dqm->wait_times;\n\n\tpacket = (struct pm4_mec_write_data_mmio *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mec_write_data_mmio));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_WRITE_DATA,\n\t\t\t\t\tsizeof(struct pm4_mec_write_data_mmio));\n\n\tpacket->bitfields2.dst_sel  = dst_sel___write_data__mem_mapped_register;\n\tpacket->bitfields2.addr_incr =\n\t\t\taddr_incr___write_data__do_not_increment_address;\n\n\tpacket->bitfields3.dst_mmreg_addr = reg_offset;\n\n\tpacket->data = reg_data;\n\n\treturn 0;\n}\n\nstatic int pm_unmap_queues_v9(struct packet_manager *pm, uint32_t *buffer,\n\t\t\tenum kfd_unmap_queues_filter filter,\n\t\t\tuint32_t filter_param, bool reset)\n{\n\tstruct pm4_mes_unmap_queues *packet;\n\n\tpacket = (struct pm4_mes_unmap_queues *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_unmap_queues));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_UNMAP_QUEUES,\n\t\t\t\t\tsizeof(struct pm4_mes_unmap_queues));\n\n\tpacket->bitfields2.extended_engine_sel =\n\t\t\t\tpm_use_ext_eng(pm->dqm->dev->kfd) ?\n\t\textended_engine_sel__mes_unmap_queues__sdma0_to_7_sel :\n\t\textended_engine_sel__mes_unmap_queues__legacy_engine_sel;\n\n\tpacket->bitfields2.engine_sel =\n\t\tengine_sel__mes_unmap_queues__compute;\n\n\tif (reset)\n\t\tpacket->bitfields2.action =\n\t\t\taction__mes_unmap_queues__reset_queues;\n\telse\n\t\tpacket->bitfields2.action =\n\t\t\taction__mes_unmap_queues__preempt_queues;\n\n\tswitch (filter) {\n\tcase KFD_UNMAP_QUEUES_FILTER_BY_PASID:\n\t\tpacket->bitfields2.queue_sel =\n\t\t\tqueue_sel__mes_unmap_queues__perform_request_on_pasid_queues;\n\t\tpacket->bitfields3a.pasid = filter_param;\n\t\tbreak;\n\tcase KFD_UNMAP_QUEUES_FILTER_ALL_QUEUES:\n\t\tpacket->bitfields2.queue_sel =\n\t\t\tqueue_sel__mes_unmap_queues__unmap_all_queues;\n\t\tbreak;\n\tcase KFD_UNMAP_QUEUES_FILTER_DYNAMIC_QUEUES:\n\t\t \n\t\tpacket->bitfields2.queue_sel =\n\t\t\tqueue_sel__mes_unmap_queues__unmap_all_non_static_queues;\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"filter %d\", filter);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n\n}\n\nstatic int pm_query_status_v9(struct packet_manager *pm, uint32_t *buffer,\n\t\t\tuint64_t fence_address,\tuint64_t fence_value)\n{\n\tstruct pm4_mes_query_status *packet;\n\n\tpacket = (struct pm4_mes_query_status *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_query_status));\n\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_QUERY_STATUS,\n\t\t\t\t\tsizeof(struct pm4_mes_query_status));\n\n\tpacket->bitfields2.context_id = 0;\n\tpacket->bitfields2.interrupt_sel =\n\t\t\tinterrupt_sel__mes_query_status__completion_status;\n\tpacket->bitfields2.command =\n\t\t\tcommand__mes_query_status__fence_only_after_write_ack;\n\n\tpacket->addr_hi = upper_32_bits((uint64_t)fence_address);\n\tpacket->addr_lo = lower_32_bits((uint64_t)fence_address);\n\tpacket->data_hi = upper_32_bits((uint64_t)fence_value);\n\tpacket->data_lo = lower_32_bits((uint64_t)fence_value);\n\n\treturn 0;\n}\n\nconst struct packet_manager_funcs kfd_v9_pm_funcs = {\n\t.map_process\t\t= pm_map_process_v9,\n\t.runlist\t\t= pm_runlist_v9,\n\t.set_resources\t\t= pm_set_resources_v9,\n\t.map_queues\t\t= pm_map_queues_v9,\n\t.unmap_queues\t\t= pm_unmap_queues_v9,\n\t.set_grace_period       = pm_set_grace_period_v9,\n\t.query_status\t\t= pm_query_status_v9,\n\t.release_mem\t\t= NULL,\n\t.map_process_size\t= sizeof(struct pm4_mes_map_process),\n\t.runlist_size\t\t= sizeof(struct pm4_mes_runlist),\n\t.set_resources_size\t= sizeof(struct pm4_mes_set_resources),\n\t.map_queues_size\t= sizeof(struct pm4_mes_map_queues),\n\t.unmap_queues_size\t= sizeof(struct pm4_mes_unmap_queues),\n\t.set_grace_period_size  = sizeof(struct pm4_mec_write_data_mmio),\n\t.query_status_size\t= sizeof(struct pm4_mes_query_status),\n\t.release_mem_size\t= 0,\n};\n\nconst struct packet_manager_funcs kfd_aldebaran_pm_funcs = {\n\t.map_process\t\t= pm_map_process_aldebaran,\n\t.runlist\t\t= pm_runlist_v9,\n\t.set_resources\t\t= pm_set_resources_v9,\n\t.map_queues\t\t= pm_map_queues_v9,\n\t.unmap_queues\t\t= pm_unmap_queues_v9,\n\t.set_grace_period       = pm_set_grace_period_v9,\n\t.query_status\t\t= pm_query_status_v9,\n\t.release_mem\t\t= NULL,\n\t.map_process_size\t= sizeof(struct pm4_mes_map_process_aldebaran),\n\t.runlist_size\t\t= sizeof(struct pm4_mes_runlist),\n\t.set_resources_size\t= sizeof(struct pm4_mes_set_resources),\n\t.map_queues_size\t= sizeof(struct pm4_mes_map_queues),\n\t.unmap_queues_size\t= sizeof(struct pm4_mes_unmap_queues),\n\t.set_grace_period_size  = sizeof(struct pm4_mec_write_data_mmio),\n\t.query_status_size\t= sizeof(struct pm4_mes_query_status),\n\t.release_mem_size\t= 0,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}