{
  "module_name": "kfd_packet_manager_vi.c",
  "hash_id": "741473f13dc69ce43d197621f730cad688d1125f12c50c96a96c1b0bb9e20373",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdkfd/kfd_packet_manager_vi.c",
  "human_readable_source": "\n \n\n#include \"kfd_kernel_queue.h\"\n#include \"kfd_device_queue_manager.h\"\n#include \"kfd_pm4_headers_vi.h\"\n#include \"kfd_pm4_opcodes.h\"\n\nunsigned int pm_build_pm4_header(unsigned int opcode, size_t packet_size)\n{\n\tunion PM4_MES_TYPE_3_HEADER header;\n\n\theader.u32All = 0;\n\theader.opcode = opcode;\n\theader.count = packet_size / 4 - 2;\n\theader.type = PM4_TYPE_3;\n\n\treturn header.u32All;\n}\n\nstatic int pm_map_process_vi(struct packet_manager *pm, uint32_t *buffer,\n\t\t\t\tstruct qcm_process_device *qpd)\n{\n\tstruct pm4_mes_map_process *packet;\n\n\tpacket = (struct pm4_mes_map_process *)buffer;\n\n\tmemset(buffer, 0, sizeof(struct pm4_mes_map_process));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_MAP_PROCESS,\n\t\t\t\t\tsizeof(struct pm4_mes_map_process));\n\tpacket->bitfields2.diq_enable = (qpd->is_debug) ? 1 : 0;\n\tpacket->bitfields2.process_quantum = 10;\n\tpacket->bitfields2.pasid = qpd->pqm->process->pasid;\n\tpacket->bitfields3.page_table_base = qpd->page_table_base;\n\tpacket->bitfields10.gds_size = qpd->gds_size;\n\tpacket->bitfields10.num_gws = qpd->num_gws;\n\tpacket->bitfields10.num_oac = qpd->num_oac;\n\tpacket->bitfields10.num_queues = (qpd->is_debug) ? 0 : qpd->queue_count;\n\n\tpacket->sh_mem_config = qpd->sh_mem_config;\n\tpacket->sh_mem_bases = qpd->sh_mem_bases;\n\tpacket->sh_mem_ape1_base = qpd->sh_mem_ape1_base;\n\tpacket->sh_mem_ape1_limit = qpd->sh_mem_ape1_limit;\n\n\tpacket->sh_hidden_private_base_vmid = qpd->sh_hidden_private_base;\n\n\tpacket->gds_addr_lo = lower_32_bits(qpd->gds_context_area);\n\tpacket->gds_addr_hi = upper_32_bits(qpd->gds_context_area);\n\n\treturn 0;\n}\n\nstatic int pm_runlist_vi(struct packet_manager *pm, uint32_t *buffer,\n\t\t\tuint64_t ib, size_t ib_size_in_dwords, bool chain)\n{\n\tstruct pm4_mes_runlist *packet;\n\tint concurrent_proc_cnt = 0;\n\tstruct kfd_node *kfd = pm->dqm->dev;\n\n\tif (WARN_ON(!ib))\n\t\treturn -EFAULT;\n\n\t \n\tconcurrent_proc_cnt = min(pm->dqm->processes_count,\n\t\t\tkfd->max_proc_per_quantum);\n\n\tpacket = (struct pm4_mes_runlist *)buffer;\n\n\tmemset(buffer, 0, sizeof(struct pm4_mes_runlist));\n\tpacket->header.u32All = pm_build_pm4_header(IT_RUN_LIST,\n\t\t\t\t\t\tsizeof(struct pm4_mes_runlist));\n\n\tpacket->bitfields4.ib_size = ib_size_in_dwords;\n\tpacket->bitfields4.chain = chain ? 1 : 0;\n\tpacket->bitfields4.offload_polling = 0;\n\tpacket->bitfields4.valid = 1;\n\tpacket->bitfields4.process_cnt = concurrent_proc_cnt;\n\tpacket->ordinal2 = lower_32_bits(ib);\n\tpacket->bitfields3.ib_base_hi = upper_32_bits(ib);\n\n\treturn 0;\n}\n\nstatic int pm_set_resources_vi(struct packet_manager *pm, uint32_t *buffer,\n\t\t\t       struct scheduling_resources *res)\n{\n\tstruct pm4_mes_set_resources *packet;\n\n\tpacket = (struct pm4_mes_set_resources *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_set_resources));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_SET_RESOURCES,\n\t\t\t\t\tsizeof(struct pm4_mes_set_resources));\n\n\tpacket->bitfields2.queue_type =\n\t\t\tqueue_type__mes_set_resources__hsa_interface_queue_hiq;\n\tpacket->bitfields2.vmid_mask = res->vmid_mask;\n\tpacket->bitfields2.unmap_latency = KFD_UNMAP_LATENCY_MS / 100;\n\tpacket->bitfields7.oac_mask = res->oac_mask;\n\tpacket->bitfields8.gds_heap_base = res->gds_heap_base;\n\tpacket->bitfields8.gds_heap_size = res->gds_heap_size;\n\n\tpacket->gws_mask_lo = lower_32_bits(res->gws_mask);\n\tpacket->gws_mask_hi = upper_32_bits(res->gws_mask);\n\n\tpacket->queue_mask_lo = lower_32_bits(res->queue_mask);\n\tpacket->queue_mask_hi = upper_32_bits(res->queue_mask);\n\n\treturn 0;\n}\n\nstatic int pm_map_queues_vi(struct packet_manager *pm, uint32_t *buffer,\n\t\tstruct queue *q, bool is_static)\n{\n\tstruct pm4_mes_map_queues *packet;\n\tbool use_static = is_static;\n\n\tpacket = (struct pm4_mes_map_queues *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_map_queues));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_MAP_QUEUES,\n\t\t\t\t\tsizeof(struct pm4_mes_map_queues));\n\tpacket->bitfields2.num_queues = 1;\n\tpacket->bitfields2.queue_sel =\n\t\tqueue_sel__mes_map_queues__map_to_hws_determined_queue_slots_vi;\n\n\tpacket->bitfields2.engine_sel =\n\t\tengine_sel__mes_map_queues__compute_vi;\n\tpacket->bitfields2.queue_type =\n\t\tqueue_type__mes_map_queues__normal_compute_vi;\n\n\tswitch (q->properties.type) {\n\tcase KFD_QUEUE_TYPE_COMPUTE:\n\t\tif (use_static)\n\t\t\tpacket->bitfields2.queue_type =\n\t\tqueue_type__mes_map_queues__normal_latency_static_queue_vi;\n\t\tbreak;\n\tcase KFD_QUEUE_TYPE_DIQ:\n\t\tpacket->bitfields2.queue_type =\n\t\t\tqueue_type__mes_map_queues__debug_interface_queue_vi;\n\t\tbreak;\n\tcase KFD_QUEUE_TYPE_SDMA:\n\tcase KFD_QUEUE_TYPE_SDMA_XGMI:\n\t\tpacket->bitfields2.engine_sel = q->properties.sdma_engine_id +\n\t\t\t\tengine_sel__mes_map_queues__sdma0_vi;\n\t\tuse_static = false;  \n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"queue type %d\", q->properties.type);\n\t\treturn -EINVAL;\n\t}\n\tpacket->bitfields3.doorbell_offset =\n\t\t\tq->properties.doorbell_off;\n\n\tpacket->mqd_addr_lo =\n\t\t\tlower_32_bits(q->gart_mqd_addr);\n\n\tpacket->mqd_addr_hi =\n\t\t\tupper_32_bits(q->gart_mqd_addr);\n\n\tpacket->wptr_addr_lo =\n\t\t\tlower_32_bits((uint64_t)q->properties.write_ptr);\n\n\tpacket->wptr_addr_hi =\n\t\t\tupper_32_bits((uint64_t)q->properties.write_ptr);\n\n\treturn 0;\n}\n\nstatic int pm_unmap_queues_vi(struct packet_manager *pm, uint32_t *buffer,\n\t\t\tenum kfd_unmap_queues_filter filter,\n\t\t\tuint32_t filter_param, bool reset)\n{\n\tstruct pm4_mes_unmap_queues *packet;\n\n\tpacket = (struct pm4_mes_unmap_queues *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_unmap_queues));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_UNMAP_QUEUES,\n\t\t\t\t\tsizeof(struct pm4_mes_unmap_queues));\n\n\tpacket->bitfields2.engine_sel =\n\t\t\tengine_sel__mes_unmap_queues__compute;\n\n\tif (reset)\n\t\tpacket->bitfields2.action =\n\t\t\taction__mes_unmap_queues__reset_queues;\n\telse\n\t\tpacket->bitfields2.action =\n\t\t\taction__mes_unmap_queues__preempt_queues;\n\n\tswitch (filter) {\n\tcase KFD_UNMAP_QUEUES_FILTER_BY_PASID:\n\t\tpacket->bitfields2.queue_sel =\n\t\t\tqueue_sel__mes_unmap_queues__perform_request_on_pasid_queues;\n\t\tpacket->bitfields3a.pasid = filter_param;\n\t\tbreak;\n\tcase KFD_UNMAP_QUEUES_FILTER_ALL_QUEUES:\n\t\tpacket->bitfields2.queue_sel =\n\t\t\tqueue_sel__mes_unmap_queues__unmap_all_queues;\n\t\tbreak;\n\tcase KFD_UNMAP_QUEUES_FILTER_DYNAMIC_QUEUES:\n\t\t \n\t\tpacket->bitfields2.queue_sel =\n\t\t\tqueue_sel__mes_unmap_queues__unmap_all_non_static_queues;\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"filter %d\", filter);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n\n}\n\nstatic int pm_query_status_vi(struct packet_manager *pm, uint32_t *buffer,\n\t\t\tuint64_t fence_address,\tuint64_t fence_value)\n{\n\tstruct pm4_mes_query_status *packet;\n\n\tpacket = (struct pm4_mes_query_status *)buffer;\n\tmemset(buffer, 0, sizeof(struct pm4_mes_query_status));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_QUERY_STATUS,\n\t\t\t\t\tsizeof(struct pm4_mes_query_status));\n\n\tpacket->bitfields2.context_id = 0;\n\tpacket->bitfields2.interrupt_sel =\n\t\t\tinterrupt_sel__mes_query_status__completion_status;\n\tpacket->bitfields2.command =\n\t\t\tcommand__mes_query_status__fence_only_after_write_ack;\n\n\tpacket->addr_hi = upper_32_bits((uint64_t)fence_address);\n\tpacket->addr_lo = lower_32_bits((uint64_t)fence_address);\n\tpacket->data_hi = upper_32_bits((uint64_t)fence_value);\n\tpacket->data_lo = lower_32_bits((uint64_t)fence_value);\n\n\treturn 0;\n}\n\nstatic int pm_release_mem_vi(uint64_t gpu_addr, uint32_t *buffer)\n{\n\tstruct pm4_mec_release_mem *packet;\n\n\tpacket = (struct pm4_mec_release_mem *)buffer;\n\tmemset(buffer, 0, sizeof(*packet));\n\n\tpacket->header.u32All = pm_build_pm4_header(IT_RELEASE_MEM,\n\t\t\t\t\t\t sizeof(*packet));\n\n\tpacket->bitfields2.event_type = CACHE_FLUSH_AND_INV_TS_EVENT;\n\tpacket->bitfields2.event_index = event_index___release_mem__end_of_pipe;\n\tpacket->bitfields2.tcl1_action_ena = 1;\n\tpacket->bitfields2.tc_action_ena = 1;\n\tpacket->bitfields2.cache_policy = cache_policy___release_mem__lru;\n\tpacket->bitfields2.atc = 0;\n\n\tpacket->bitfields3.data_sel = data_sel___release_mem__send_32_bit_low;\n\tpacket->bitfields3.int_sel =\n\t\tint_sel___release_mem__send_interrupt_after_write_confirm;\n\n\tpacket->bitfields4.address_lo_32b = (gpu_addr & 0xffffffff) >> 2;\n\tpacket->address_hi = upper_32_bits(gpu_addr);\n\n\tpacket->data_lo = 0;\n\n\treturn 0;\n}\n\nconst struct packet_manager_funcs kfd_vi_pm_funcs = {\n\t.map_process\t\t= pm_map_process_vi,\n\t.runlist\t\t= pm_runlist_vi,\n\t.set_resources\t\t= pm_set_resources_vi,\n\t.map_queues\t\t= pm_map_queues_vi,\n\t.unmap_queues\t\t= pm_unmap_queues_vi,\n\t.set_grace_period\t= NULL,\n\t.query_status\t\t= pm_query_status_vi,\n\t.release_mem\t\t= pm_release_mem_vi,\n\t.map_process_size\t= sizeof(struct pm4_mes_map_process),\n\t.runlist_size\t\t= sizeof(struct pm4_mes_runlist),\n\t.set_resources_size\t= sizeof(struct pm4_mes_set_resources),\n\t.map_queues_size\t= sizeof(struct pm4_mes_map_queues),\n\t.unmap_queues_size\t= sizeof(struct pm4_mes_unmap_queues),\n\t.set_grace_period_size\t= 0,\n\t.query_status_size\t= sizeof(struct pm4_mes_query_status),\n\t.release_mem_size\t= sizeof(struct pm4_mec_release_mem)\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}