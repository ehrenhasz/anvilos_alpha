{
  "module_name": "kfd_int_process_v11.c",
  "hash_id": "66c38920ab147359ef840a7b3cbcba081427d3dc8c46107c234f45e67cd19764",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/amdkfd/kfd_int_process_v11.c",
  "human_readable_source": " \n\n#include \"kfd_priv.h\"\n#include \"kfd_events.h\"\n#include \"soc15_int.h\"\n#include \"kfd_device_queue_manager.h\"\n#include \"ivsrcid/vmc/irqsrcs_vmc_1_0.h\"\n#include \"kfd_smi_events.h\"\n#include \"kfd_debug.h\"\n\n \n\nenum SQ_INTERRUPT_WORD_ENCODING {\n\tSQ_INTERRUPT_WORD_ENCODING_AUTO = 0x0,\n\tSQ_INTERRUPT_WORD_ENCODING_INST,\n\tSQ_INTERRUPT_WORD_ENCODING_ERROR,\n};\n\nenum SQ_INTERRUPT_ERROR_TYPE {\n\tSQ_INTERRUPT_ERROR_TYPE_EDC_FUE = 0x0,\n\tSQ_INTERRUPT_ERROR_TYPE_ILLEGAL_INST,\n\tSQ_INTERRUPT_ERROR_TYPE_MEMVIOL,\n\tSQ_INTERRUPT_ERROR_TYPE_EDC_FED,\n};\n\n \n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE__SHIFT\t\t0\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__WLT__SHIFT\t\t\t1\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_BUF_FULL__SHIFT\t2\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__REG_TIMESTAMP__SHIFT\t\t3\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__CMD_TIMESTAMP__SHIFT\t\t4\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__HOST_CMD_OVERFLOW__SHIFT\t\t5\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__HOST_REG_OVERFLOW__SHIFT\t\t6\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__IMMED_OVERFLOW__SHIFT\t\t7\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_UTC_ERROR__SHIFT\t8\n#define SQ_INTERRUPT_WORD_AUTO_CTXID1__ENCODING__SHIFT\t\t\t6\n\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_MASK\t\t0x00000001\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__WLT_MASK\t\t\t\t0x00000002\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_BUF_FULL_MASK\t0x00000004\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__REG_TIMESTAMP_MASK\t\t0x00000008\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__CMD_TIMESTAMP_MASK\t\t0x00000010\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__HOST_CMD_OVERFLOW_MASK\t\t0x00000020\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__HOST_REG_OVERFLOW_MASK\t\t0x00000040\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__IMMED_OVERFLOW_MASK\t\t0x00000080\n#define SQ_INTERRUPT_WORD_AUTO_CTXID0__THREAD_TRACE_UTC_ERROR_MASK\t0x00000100\n#define SQ_INTERRUPT_WORD_AUTO_CTXID1__ENCODING_MASK\t\t\t0x000000c0\n\n \n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__DATA__SHIFT\t0\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__SH_ID__SHIFT\t25\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__PRIV__SHIFT\t26\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__WAVE_ID__SHIFT\t27\n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__SIMD_ID__SHIFT\t0\n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__WGP_ID__SHIFT\t2\n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__ENCODING__SHIFT\t6\n\n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__DATA_MASK\t0x00ffffff  \n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__SH_ID_MASK\t0x02000000  \n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__PRIV_MASK\t0x04000000  \n#define SQ_INTERRUPT_WORD_WAVE_CTXID0__WAVE_ID_MASK\t0xf8000000  \n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__SIMD_ID_MASK\t0x00000003  \n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__WGP_ID_MASK\t0x0000003c  \n#define SQ_INTERRUPT_WORD_WAVE_CTXID1__ENCODING_MASK\t0x000000c0  \n\n \n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__DETAIL__SHIFT\t0\n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__TYPE__SHIFT\t21\n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__SH_ID__SHIFT\t25\n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__PRIV__SHIFT\t26\n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__WAVE_ID__SHIFT\t27\n#define SQ_INTERRUPT_WORD_ERROR_CTXID1__SIMD_ID__SHIFT\t0\n#define SQ_INTERRUPT_WORD_ERROR_CTXID1__WGP_ID__SHIFT\t2\n#define SQ_INTERRUPT_WORD_ERROR_CTXID1__ENCODING__SHIFT\t6\n\n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__DETAIL_MASK\t0x001fffff  \n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__TYPE_MASK\t0x01e00000  \n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__SH_ID_MASK\t0x02000000  \n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__PRIV_MASK\t0x04000000  \n#define SQ_INTERRUPT_WORD_ERROR_CTXID0__WAVE_ID_MASK\t0xf8000000  \n#define SQ_INTERRUPT_WORD_ERROR_CTXID1__SIMD_ID_MASK\t0x00000003  \n#define SQ_INTERRUPT_WORD_ERROR_CTXID1__WGP_ID_MASK\t0x0000003c  \n#define SQ_INTERRUPT_WORD_ERROR_CTXID1__ENCODING_MASK\t0x000000c0  \n\n \n#define KFD_CTXID0_TRAP_CODE_SHIFT\t10\n#define KFD_CTXID0_TRAP_CODE_MASK\t0xfffc00\n#define KFD_CTXID0_CP_BAD_OP_ECODE_MASK\t0x3ffffff\n#define KFD_CTXID0_DOORBELL_ID_MASK\t0x0003ff\n\n#define KFD_CTXID0_TRAP_CODE(ctxid0)\t\t(((ctxid0) &  \\\n\t\t\t\tKFD_CTXID0_TRAP_CODE_MASK) >> \\\n\t\t\t\tKFD_CTXID0_TRAP_CODE_SHIFT)\n#define KFD_CTXID0_CP_BAD_OP_ECODE(ctxid0)\t(((ctxid0) &        \\\n\t\t\t\tKFD_CTXID0_CP_BAD_OP_ECODE_MASK) >> \\\n\t\t\t\tKFD_CTXID0_TRAP_CODE_SHIFT)\n#define KFD_CTXID0_DOORBELL_ID(ctxid0)\t\t((ctxid0) & \\\n\t\t\t\tKFD_CTXID0_DOORBELL_ID_MASK)\n\nstatic void print_sq_intr_info_auto(uint32_t context_id0, uint32_t context_id1)\n{\n\tpr_debug_ratelimited(\n\t\t\"sq_intr: auto, ttrace %d, wlt %d, ttrace_buf_full %d, reg_tms %d, cmd_tms %d, host_cmd_ovf %d, host_reg_ovf %d, immed_ovf %d, ttrace_utc_err %d\\n\",\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0, THREAD_TRACE),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0, WLT),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0, THREAD_TRACE_BUF_FULL),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0, REG_TIMESTAMP),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0, CMD_TIMESTAMP),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0, HOST_CMD_OVERFLOW),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0, HOST_REG_OVERFLOW),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0, IMMED_OVERFLOW),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_AUTO_CTXID0, THREAD_TRACE_UTC_ERROR));\n}\n\nstatic void print_sq_intr_info_inst(uint32_t context_id0, uint32_t context_id1)\n{\n\tpr_debug_ratelimited(\n\t\t\"sq_intr: inst, data 0x%08x, sh %d, priv %d, wave_id %d, simd_id %d, wgp_id %d\\n\",\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0, DATA),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0, SH_ID),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0, PRIV),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_WAVE_CTXID0, WAVE_ID),\n\t\tREG_GET_FIELD(context_id1, SQ_INTERRUPT_WORD_WAVE_CTXID1, SIMD_ID),\n\t\tREG_GET_FIELD(context_id1, SQ_INTERRUPT_WORD_WAVE_CTXID1, WGP_ID));\n}\n\nstatic void print_sq_intr_info_error(uint32_t context_id0, uint32_t context_id1)\n{\n\tpr_warn_ratelimited(\n\t\t\"sq_intr: error, detail 0x%08x, type %d, sh %d, priv %d, wave_id %d, simd_id %d, wgp_id %d\\n\",\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_ERROR_CTXID0, DETAIL),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_ERROR_CTXID0, TYPE),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_ERROR_CTXID0, SH_ID),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_ERROR_CTXID0, PRIV),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_ERROR_CTXID0, WAVE_ID),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_ERROR_CTXID1, SIMD_ID),\n\t\tREG_GET_FIELD(context_id0, SQ_INTERRUPT_WORD_ERROR_CTXID1, WGP_ID));\n}\n\nstatic void event_interrupt_poison_consumption_v11(struct kfd_node *dev,\n\t\t\t\tuint16_t pasid, uint16_t source_id)\n{\n\tint ret = -EINVAL;\n\tstruct kfd_process *p = kfd_lookup_process_by_pasid(pasid);\n\n\tif (!p)\n\t\treturn;\n\n\t \n\tif (atomic_read(&p->poison)) {\n\t\tkfd_unref_process(p);\n\t\treturn;\n\t}\n\n\tatomic_set(&p->poison, 1);\n\tkfd_unref_process(p);\n\n\tswitch (source_id) {\n\tcase SOC15_INTSRC_SQ_INTERRUPT_MSG:\n\t\tif (dev->dqm->ops.reset_queues)\n\t\t\tret = dev->dqm->ops.reset_queues(dev->dqm, pasid);\n\t\tbreak;\n\tcase SOC21_INTSRC_SDMA_ECC:\n\tdefault:\n\t\tbreak;\n\t}\n\n\tkfd_signal_poison_consumed_event(dev, pasid);\n\n\t \n\tif (!ret)\n\t\tamdgpu_amdkfd_ras_poison_consumption_handler(dev->adev, false);\n\telse\n\t\tamdgpu_amdkfd_ras_poison_consumption_handler(dev->adev, true);\n}\n\nstatic bool event_interrupt_isr_v11(struct kfd_node *dev,\n\t\t\t\t\tconst uint32_t *ih_ring_entry,\n\t\t\t\t\tuint32_t *patched_ihre,\n\t\t\t\t\tbool *patched_flag)\n{\n\tuint16_t source_id, client_id, pasid, vmid;\n\tconst uint32_t *data = ih_ring_entry;\n\tuint32_t context_id0;\n\n\tsource_id = SOC15_SOURCE_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tclient_id = SOC15_CLIENT_ID_FROM_IH_ENTRY(ih_ring_entry);\n\t \n\tvmid = SOC15_VMID_FROM_IH_ENTRY(ih_ring_entry);\n\tif (!KFD_IRQ_IS_FENCE(client_id, source_id) &&\n\t    (vmid < dev->vm_info.first_vmid_kfd ||\n\t    vmid > dev->vm_info.last_vmid_kfd))\n\t\treturn false;\n\n\tpasid = SOC15_PASID_FROM_IH_ENTRY(ih_ring_entry);\n\tcontext_id0 = SOC15_CONTEXT_ID0_FROM_IH_ENTRY(ih_ring_entry);\n\n\tif ((source_id == SOC15_INTSRC_CP_END_OF_PIPE) &&\n\t    (context_id0 & AMDGPU_FENCE_MES_QUEUE_FLAG))\n\t\treturn false;\n\n\tpr_debug(\"client id 0x%x, source id %d, vmid %d, pasid 0x%x. raw data:\\n\",\n\t\t client_id, source_id, vmid, pasid);\n\tpr_debug(\"%8X, %8X, %8X, %8X, %8X, %8X, %8X, %8X.\\n\",\n\t\t data[0], data[1], data[2], data[3],\n\t\t data[4], data[5], data[6], data[7]);\n\n\t \n\tif (WARN_ONCE(pasid == 0, \"Bug: No PASID in KFD interrupt\"))\n\t\treturn false;\n\n\t \n\treturn source_id == SOC15_INTSRC_CP_END_OF_PIPE ||\n\t\tsource_id == SOC15_INTSRC_SQ_INTERRUPT_MSG ||\n\t\tsource_id == SOC15_INTSRC_CP_BAD_OPCODE ||\n\t\tsource_id == SOC21_INTSRC_SDMA_TRAP ||\n\t\tKFD_IRQ_IS_FENCE(client_id, source_id) ||\n\t\t(((client_id == SOC21_IH_CLIENTID_VMC) ||\n\t\t ((client_id == SOC21_IH_CLIENTID_GFX) &&\n\t\t  (source_id == UTCL2_1_0__SRCID__FAULT))) &&\n\t\t  !amdgpu_no_queue_eviction_on_vm_fault);\n}\n\nstatic void event_interrupt_wq_v11(struct kfd_node *dev,\n\t\t\t\t\tconst uint32_t *ih_ring_entry)\n{\n\tuint16_t source_id, client_id, ring_id, pasid, vmid;\n\tuint32_t context_id0, context_id1;\n\tuint8_t sq_int_enc, sq_int_priv, sq_int_errtype;\n\tstruct kfd_vm_fault_info info = {0};\n\tstruct kfd_hsa_memory_exception_data exception_data;\n\n\tsource_id = SOC15_SOURCE_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tclient_id = SOC15_CLIENT_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tring_id = SOC15_RING_ID_FROM_IH_ENTRY(ih_ring_entry);\n\tpasid = SOC15_PASID_FROM_IH_ENTRY(ih_ring_entry);\n\tvmid = SOC15_VMID_FROM_IH_ENTRY(ih_ring_entry);\n\tcontext_id0 = SOC15_CONTEXT_ID0_FROM_IH_ENTRY(ih_ring_entry);\n\tcontext_id1 = SOC15_CONTEXT_ID1_FROM_IH_ENTRY(ih_ring_entry);\n\n\t \n\tif (client_id == SOC21_IH_CLIENTID_VMC ||\n\t     ((client_id == SOC21_IH_CLIENTID_GFX) &&\n\t     (source_id == UTCL2_1_0__SRCID__FAULT))) {\n\n\t\tinfo.vmid = vmid;\n\t\tinfo.mc_id = client_id;\n\t\tinfo.page_addr = ih_ring_entry[4] |\n\t\t\t(uint64_t)(ih_ring_entry[5] & 0xf) << 32;\n\t\tinfo.prot_valid = ring_id & 0x08;\n\t\tinfo.prot_read  = ring_id & 0x10;\n\t\tinfo.prot_write = ring_id & 0x20;\n\n\t\tmemset(&exception_data, 0, sizeof(exception_data));\n\t\texception_data.gpu_id = dev->id;\n\t\texception_data.va = (info.page_addr) << PAGE_SHIFT;\n\t\texception_data.failure.NotPresent = info.prot_valid ? 1 : 0;\n\t\texception_data.failure.NoExecute = info.prot_exec ? 1 : 0;\n\t\texception_data.failure.ReadOnly = info.prot_write ? 1 : 0;\n\t\texception_data.failure.imprecise = 0;\n\n\t\tkfd_set_dbg_ev_from_interrupt(dev, pasid, -1,\n\t\t\t\t\t      KFD_EC_MASK(EC_DEVICE_MEMORY_VIOLATION),\n\t\t\t\t\t      &exception_data, sizeof(exception_data));\n\t\tkfd_smi_event_update_vmfault(dev, pasid);\n\n\t \n\t} else if (client_id == SOC21_IH_CLIENTID_GRBM_CP ||\n\t\t   client_id == SOC21_IH_CLIENTID_GFX) {\n\n\t\t \n\t\tif (source_id == SOC15_INTSRC_CP_END_OF_PIPE)\n\t\t\tkfd_signal_event_interrupt(pasid, context_id0, 32);\n\t\telse if (source_id == SOC15_INTSRC_CP_BAD_OPCODE)\n\t\t\tkfd_set_dbg_ev_from_interrupt(dev, pasid,\n\t\t\t\tKFD_CTXID0_DOORBELL_ID(context_id0),\n\t\t\t\tKFD_EC_MASK(KFD_CTXID0_CP_BAD_OP_ECODE(context_id0)),\n\t\t\t\tNULL, 0);\n\n\t\t \n\t\telse if (source_id == SOC21_INTSRC_SDMA_TRAP)\n\t\t\tkfd_signal_event_interrupt(pasid, context_id0 & 0xfffffff, 28);\n\t\telse if (source_id == SOC21_INTSRC_SDMA_ECC) {\n\t\t\tevent_interrupt_poison_consumption_v11(dev, pasid, source_id);\n\t\t\treturn;\n\t\t}\n\n\t\t \n\t\telse if (source_id == SOC15_INTSRC_SQ_INTERRUPT_MSG) {\n\t\t\tsq_int_enc = REG_GET_FIELD(context_id1,\n\t\t\t\t\tSQ_INTERRUPT_WORD_WAVE_CTXID1, ENCODING);\n\t\t\tswitch (sq_int_enc) {\n\t\t\tcase SQ_INTERRUPT_WORD_ENCODING_AUTO:\n\t\t\t\tprint_sq_intr_info_auto(context_id0, context_id1);\n\t\t\t\tbreak;\n\t\t\tcase SQ_INTERRUPT_WORD_ENCODING_INST:\n\t\t\t\tprint_sq_intr_info_inst(context_id0, context_id1);\n\t\t\t\tsq_int_priv = REG_GET_FIELD(context_id0,\n\t\t\t\t\t\tSQ_INTERRUPT_WORD_WAVE_CTXID0, PRIV);\n\t\t\t\tif (sq_int_priv && (kfd_set_dbg_ev_from_interrupt(dev, pasid,\n\t\t\t\t\t\tKFD_CTXID0_DOORBELL_ID(context_id0),\n\t\t\t\t\t\tKFD_CTXID0_TRAP_CODE(context_id0),\n\t\t\t\t\t\tNULL, 0)))\n\t\t\t\t\treturn;\n\t\t\t\tbreak;\n\t\t\tcase SQ_INTERRUPT_WORD_ENCODING_ERROR:\n\t\t\t\tprint_sq_intr_info_error(context_id0, context_id1);\n\t\t\t\tsq_int_errtype = REG_GET_FIELD(context_id0,\n\t\t\t\t\t\tSQ_INTERRUPT_WORD_ERROR_CTXID0, TYPE);\n\t\t\t\tif (sq_int_errtype != SQ_INTERRUPT_ERROR_TYPE_ILLEGAL_INST &&\n\t\t\t\t    sq_int_errtype != SQ_INTERRUPT_ERROR_TYPE_MEMVIOL) {\n\t\t\t\t\tevent_interrupt_poison_consumption_v11(\n\t\t\t\t\t\t\tdev, pasid, source_id);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tkfd_signal_event_interrupt(pasid, context_id0 & 0xffffff, 24);\n\t\t}\n\n\t} else if (KFD_IRQ_IS_FENCE(client_id, source_id)) {\n\t\tkfd_process_close_interrupt_drain(pasid);\n\t}\n}\n\nconst struct kfd_event_interrupt_class event_interrupt_class_v11 = {\n\t.interrupt_isr = event_interrupt_isr_v11,\n\t.interrupt_wq = event_interrupt_wq_v11,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}