{
  "module_name": "vega20_thermal.c",
  "hash_id": "4715314425981ac0e1d390ae15af319e230239da3566b8151bb1b37cb3e9823e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/pm/powerplay/hwmgr/vega20_thermal.c",
  "human_readable_source": " \n\n#include \"vega20_thermal.h\"\n#include \"vega20_hwmgr.h\"\n#include \"vega20_smumgr.h\"\n#include \"vega20_ppsmc.h\"\n#include \"vega20_inc.h\"\n#include \"soc15_common.h\"\n#include \"pp_debug.h\"\n\nstatic int vega20_disable_fan_control_feature(struct pp_hwmgr *hwmgr)\n{\n\tstruct vega20_hwmgr *data = hwmgr->backend;\n\tint ret = 0;\n\n\tif (data->smu_features[GNLD_FAN_CONTROL].supported) {\n\t\tret = vega20_enable_smc_features(\n\t\t\t\thwmgr, false,\n\t\t\t\tdata->smu_features[GNLD_FAN_CONTROL].\n\t\t\t\tsmu_feature_bitmap);\n\t\tPP_ASSERT_WITH_CODE(!ret,\n\t\t\t\t\"Disable FAN CONTROL feature Failed!\",\n\t\t\t\treturn ret);\n\t\tdata->smu_features[GNLD_FAN_CONTROL].enabled = false;\n\t}\n\n\treturn ret;\n}\n\nint vega20_fan_ctrl_stop_smc_fan_control(struct pp_hwmgr *hwmgr)\n{\n\tstruct vega20_hwmgr *data = hwmgr->backend;\n\n\tif (data->smu_features[GNLD_FAN_CONTROL].supported)\n\t\treturn vega20_disable_fan_control_feature(hwmgr);\n\n\treturn 0;\n}\n\nstatic int vega20_enable_fan_control_feature(struct pp_hwmgr *hwmgr)\n{\n\tstruct vega20_hwmgr *data = hwmgr->backend;\n\tint ret = 0;\n\n\tif (data->smu_features[GNLD_FAN_CONTROL].supported) {\n\t\tret = vega20_enable_smc_features(\n\t\t\t\thwmgr, true,\n\t\t\t\tdata->smu_features[GNLD_FAN_CONTROL].\n\t\t\t\tsmu_feature_bitmap);\n\t\tPP_ASSERT_WITH_CODE(!ret,\n\t\t\t\t\"Enable FAN CONTROL feature Failed!\",\n\t\t\t\treturn ret);\n\t\tdata->smu_features[GNLD_FAN_CONTROL].enabled = true;\n\t}\n\n\treturn ret;\n}\n\nint vega20_fan_ctrl_start_smc_fan_control(struct pp_hwmgr *hwmgr)\n{\n\tstruct vega20_hwmgr *data = hwmgr->backend;\n\n\tif (data->smu_features[GNLD_FAN_CONTROL].supported)\n\t\treturn vega20_enable_fan_control_feature(hwmgr);\n\n\treturn 0;\n}\n\nstatic int vega20_fan_ctrl_set_static_mode(struct pp_hwmgr *hwmgr, uint32_t mode)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\n\tWREG32_SOC15(THM, 0, mmCG_FDO_CTRL2,\n\t\t\tREG_SET_FIELD(RREG32_SOC15(THM, 0, mmCG_FDO_CTRL2),\n\t\t\t\tCG_FDO_CTRL2, TMIN, 0));\n\tWREG32_SOC15(THM, 0, mmCG_FDO_CTRL2,\n\t\t\tREG_SET_FIELD(RREG32_SOC15(THM, 0, mmCG_FDO_CTRL2),\n\t\t\t\tCG_FDO_CTRL2, FDO_PWM_MODE, mode));\n\n\treturn 0;\n}\n\nstatic int vega20_get_current_rpm(struct pp_hwmgr *hwmgr, uint32_t *current_rpm)\n{\n\tint ret = 0;\n\n\tPP_ASSERT_WITH_CODE((ret = smum_send_msg_to_smc(hwmgr,\n\t\t\t\tPPSMC_MSG_GetCurrentRpm,\n\t\t\t\tcurrent_rpm)) == 0,\n\t\t\t\"Attempt to get current RPM from SMC Failed!\",\n\t\t\treturn ret);\n\n\treturn 0;\n}\n\nint vega20_fan_ctrl_get_fan_speed_pwm(struct pp_hwmgr *hwmgr,\n\t\tuint32_t *speed)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\tuint32_t duty100, duty;\n\tuint64_t tmp64;\n\n\tduty100 = REG_GET_FIELD(RREG32_SOC15(THM, 0, mmCG_FDO_CTRL1),\n\t\t\t\tCG_FDO_CTRL1, FMAX_DUTY100);\n\tduty = REG_GET_FIELD(RREG32_SOC15(THM, 0, mmCG_THERMAL_STATUS),\n\t\t\t\tCG_THERMAL_STATUS, FDO_PWM_DUTY);\n\n\tif (!duty100)\n\t\treturn -EINVAL;\n\n\ttmp64 = (uint64_t)duty * 255;\n\tdo_div(tmp64, duty100);\n\t*speed = MIN((uint32_t)tmp64, 255);\n\n\treturn 0;\n}\n\nint vega20_fan_ctrl_set_fan_speed_pwm(struct pp_hwmgr *hwmgr,\n\t\tuint32_t speed)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\tuint32_t duty100;\n\tuint32_t duty;\n\tuint64_t tmp64;\n\n\tspeed = MIN(speed, 255);\n\n\tif (PP_CAP(PHM_PlatformCaps_MicrocodeFanControl))\n\t\tvega20_fan_ctrl_stop_smc_fan_control(hwmgr);\n\n\tduty100 = REG_GET_FIELD(RREG32_SOC15(THM, 0, mmCG_FDO_CTRL1),\n\t\t\t\t    CG_FDO_CTRL1, FMAX_DUTY100);\n\n\tif (duty100 == 0)\n\t\treturn -EINVAL;\n\n\ttmp64 = (uint64_t)speed * duty100;\n\tdo_div(tmp64, 255);\n\tduty = (uint32_t)tmp64;\n\n\tWREG32_SOC15(THM, 0, mmCG_FDO_CTRL0,\n\t\tREG_SET_FIELD(RREG32_SOC15(THM, 0, mmCG_FDO_CTRL0),\n\t\t\tCG_FDO_CTRL0, FDO_STATIC_DUTY, duty));\n\n\treturn vega20_fan_ctrl_set_static_mode(hwmgr, FDO_PWM_MODE_STATIC);\n}\n\nint vega20_fan_ctrl_get_fan_speed_info(struct pp_hwmgr *hwmgr,\n\t\tstruct phm_fan_speed_info *fan_speed_info)\n{\n\tmemset(fan_speed_info, 0, sizeof(*fan_speed_info));\n\tfan_speed_info->supports_percent_read = true;\n\tfan_speed_info->supports_percent_write = true;\n\tfan_speed_info->supports_rpm_read = true;\n\tfan_speed_info->supports_rpm_write = true;\n\n\treturn 0;\n}\n\nint vega20_fan_ctrl_get_fan_speed_rpm(struct pp_hwmgr *hwmgr, uint32_t *speed)\n{\n\t*speed = 0;\n\n\treturn vega20_get_current_rpm(hwmgr, speed);\n}\n\nint vega20_fan_ctrl_set_fan_speed_rpm(struct pp_hwmgr *hwmgr, uint32_t speed)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\tuint32_t tach_period, crystal_clock_freq;\n\tint result = 0;\n\n\tif (!speed)\n\t\treturn -EINVAL;\n\n\tif (PP_CAP(PHM_PlatformCaps_MicrocodeFanControl)) {\n\t\tresult = vega20_fan_ctrl_stop_smc_fan_control(hwmgr);\n\t\tif (result)\n\t\t\treturn result;\n\t}\n\n\tcrystal_clock_freq = amdgpu_asic_get_xclk((struct amdgpu_device *)hwmgr->adev);\n\ttach_period = 60 * crystal_clock_freq * 10000 / (8 * speed);\n\tWREG32_SOC15(THM, 0, mmCG_TACH_CTRL,\n\t\t\tREG_SET_FIELD(RREG32_SOC15(THM, 0, mmCG_TACH_CTRL),\n\t\t\t\tCG_TACH_CTRL, TARGET_PERIOD,\n\t\t\t\ttach_period));\n\n\treturn vega20_fan_ctrl_set_static_mode(hwmgr, FDO_PWM_MODE_STATIC_RPM);\n}\n\n \nint vega20_thermal_get_temperature(struct pp_hwmgr *hwmgr)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\tint temp = 0;\n\n\ttemp = RREG32_SOC15(THM, 0, mmCG_MULT_THERMAL_STATUS);\n\n\ttemp = (temp & CG_MULT_THERMAL_STATUS__CTF_TEMP_MASK) >>\n\t\t\tCG_MULT_THERMAL_STATUS__CTF_TEMP__SHIFT;\n\n\ttemp = temp & 0x1ff;\n\n\ttemp *= PP_TEMPERATURE_UNITS_PER_CENTIGRADES;\n\treturn temp;\n}\n\n \nstatic int vega20_thermal_set_temperature_range(struct pp_hwmgr *hwmgr,\n\t\tstruct PP_TemperatureRange *range)\n{\n\tstruct phm_ppt_v3_information *pptable_information =\n\t\t(struct phm_ppt_v3_information *)hwmgr->pptable;\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\tint low = VEGA20_THERMAL_MINIMUM_ALERT_TEMP;\n\tint high = VEGA20_THERMAL_MAXIMUM_ALERT_TEMP;\n\tuint32_t val;\n\n\t \n\tif (low < range->min / PP_TEMPERATURE_UNITS_PER_CENTIGRADES)\n\t\tlow = range->min / PP_TEMPERATURE_UNITS_PER_CENTIGRADES;\n\tif (high > pptable_information->us_software_shutdown_temp)\n\t\thigh = pptable_information->us_software_shutdown_temp;\n\n\tif (low > high)\n\t\treturn -EINVAL;\n\n\tval = RREG32_SOC15(THM, 0, mmTHM_THERMAL_INT_CTRL);\n\n\tval = CGS_REG_SET_FIELD(val, THM_THERMAL_INT_CTRL, MAX_IH_CREDIT, 5);\n\tval = CGS_REG_SET_FIELD(val, THM_THERMAL_INT_CTRL, THERM_IH_HW_ENA, 1);\n\tval = CGS_REG_SET_FIELD(val, THM_THERMAL_INT_CTRL, DIG_THERM_INTH, high);\n\tval = CGS_REG_SET_FIELD(val, THM_THERMAL_INT_CTRL, DIG_THERM_INTL, low);\n\tval &= ~THM_THERMAL_INT_CTRL__THERM_TRIGGER_MASK_MASK;\n\tval &= ~THM_THERMAL_INT_CTRL__THERM_INTH_MASK_MASK;\n\tval &= ~THM_THERMAL_INT_CTRL__THERM_INTL_MASK_MASK;\n\n\tWREG32_SOC15(THM, 0, mmTHM_THERMAL_INT_CTRL, val);\n\n\treturn 0;\n}\n\n \nstatic int vega20_thermal_enable_alert(struct pp_hwmgr *hwmgr)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\tuint32_t val = 0;\n\n\tval |= (1 << THM_THERMAL_INT_ENA__THERM_INTH_CLR__SHIFT);\n\tval |= (1 << THM_THERMAL_INT_ENA__THERM_INTL_CLR__SHIFT);\n\tval |= (1 << THM_THERMAL_INT_ENA__THERM_TRIGGER_CLR__SHIFT);\n\n\tWREG32_SOC15(THM, 0, mmTHM_THERMAL_INT_ENA, val);\n\n\treturn 0;\n}\n\n \nint vega20_thermal_disable_alert(struct pp_hwmgr *hwmgr)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\n\tWREG32_SOC15(THM, 0, mmTHM_THERMAL_INT_ENA, 0);\n\n\treturn 0;\n}\n\n \nint vega20_thermal_stop_thermal_controller(struct pp_hwmgr *hwmgr)\n{\n\tint result = vega20_thermal_disable_alert(hwmgr);\n\n\treturn result;\n}\n\n \nstatic int vega20_thermal_setup_fan_table(struct pp_hwmgr *hwmgr)\n{\n\tint ret;\n\tstruct vega20_hwmgr *data = (struct vega20_hwmgr *)(hwmgr->backend);\n\tPPTable_t *table = &(data->smc_state_table.pp_table);\n\n\tret = smum_send_msg_to_smc_with_parameter(hwmgr,\n\t\t\t\tPPSMC_MSG_SetFanTemperatureTarget,\n\t\t\t\t(uint32_t)table->FanTargetTemperature,\n\t\t\t\tNULL);\n\n\treturn ret;\n}\n\nint vega20_start_thermal_controller(struct pp_hwmgr *hwmgr,\n\t\t\t\tstruct PP_TemperatureRange *range)\n{\n\tint ret = 0;\n\n\tif (range == NULL)\n\t\treturn -EINVAL;\n\n\tret = vega20_thermal_set_temperature_range(hwmgr, range);\n\tif (ret)\n\t\treturn ret;\n\n\tret = vega20_thermal_enable_alert(hwmgr);\n\tif (ret)\n\t\treturn ret;\n\n\tret = vega20_thermal_setup_fan_table(hwmgr);\n\n\treturn ret;\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}