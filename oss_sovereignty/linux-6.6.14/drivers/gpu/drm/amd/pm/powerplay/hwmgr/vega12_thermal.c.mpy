{
  "module_name": "vega12_thermal.c",
  "hash_id": "77b5ed27a3b8412c7ef5c6d4c5101db3424dc057d51362b61ab2ad2f1fc35ba5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/pm/powerplay/hwmgr/vega12_thermal.c",
  "human_readable_source": " \n\n#include \"vega12_thermal.h\"\n#include \"vega12_hwmgr.h\"\n#include \"vega12_smumgr.h\"\n#include \"vega12_ppsmc.h\"\n#include \"vega12_inc.h\"\n#include \"soc15_common.h\"\n#include \"pp_debug.h\"\n\nstatic int vega12_get_current_rpm(struct pp_hwmgr *hwmgr, uint32_t *current_rpm)\n{\n\tPP_ASSERT_WITH_CODE(!smum_send_msg_to_smc(hwmgr,\n\t\t\t\tPPSMC_MSG_GetCurrentRpm,\n\t\t\t\tcurrent_rpm),\n\t\t\t\"Attempt to get current RPM from SMC Failed!\",\n\t\t\treturn -EINVAL);\n\n\treturn 0;\n}\n\nint vega12_fan_ctrl_get_fan_speed_info(struct pp_hwmgr *hwmgr,\n\t\tstruct phm_fan_speed_info *fan_speed_info)\n{\n\tmemset(fan_speed_info, 0, sizeof(*fan_speed_info));\n\tfan_speed_info->supports_percent_read = false;\n\tfan_speed_info->supports_percent_write = false;\n\tfan_speed_info->supports_rpm_read = true;\n\tfan_speed_info->supports_rpm_write = true;\n\n\treturn 0;\n}\n\nint vega12_fan_ctrl_get_fan_speed_rpm(struct pp_hwmgr *hwmgr, uint32_t *speed)\n{\n\t*speed = 0;\n\n\treturn vega12_get_current_rpm(hwmgr, speed);\n}\n\n \nstatic int vega12_enable_fan_control_feature(struct pp_hwmgr *hwmgr)\n{\n#if 0\n\tstruct vega12_hwmgr *data = (struct vega12_hwmgr *)(hwmgr->backend);\n\n\tif (data->smu_features[GNLD_FAN_CONTROL].supported) {\n\t\tPP_ASSERT_WITH_CODE(!vega12_enable_smc_features(\n\t\t\t\thwmgr, true,\n\t\t\t\tdata->smu_features[GNLD_FAN_CONTROL].\n\t\t\t\tsmu_feature_bitmap),\n\t\t\t\t\"Attempt to Enable FAN CONTROL feature Failed!\",\n\t\t\t\treturn -1);\n\t\tdata->smu_features[GNLD_FAN_CONTROL].enabled = true;\n\t}\n#endif\n\treturn 0;\n}\n\nstatic int vega12_disable_fan_control_feature(struct pp_hwmgr *hwmgr)\n{\n#if 0\n\tstruct vega12_hwmgr *data = (struct vega12_hwmgr *)(hwmgr->backend);\n\n\tif (data->smu_features[GNLD_FAN_CONTROL].supported) {\n\t\tPP_ASSERT_WITH_CODE(!vega12_enable_smc_features(\n\t\t\t\thwmgr, false,\n\t\t\t\tdata->smu_features[GNLD_FAN_CONTROL].\n\t\t\t\tsmu_feature_bitmap),\n\t\t\t\t\"Attempt to Enable FAN CONTROL feature Failed!\",\n\t\t\t\treturn -1);\n\t\tdata->smu_features[GNLD_FAN_CONTROL].enabled = false;\n\t}\n#endif\n\treturn 0;\n}\n\nint vega12_fan_ctrl_start_smc_fan_control(struct pp_hwmgr *hwmgr)\n{\n\tstruct vega12_hwmgr *data = (struct vega12_hwmgr *)(hwmgr->backend);\n\n\tif (data->smu_features[GNLD_FAN_CONTROL].supported)\n\t\tPP_ASSERT_WITH_CODE(\n\t\t\t\t!vega12_enable_fan_control_feature(hwmgr),\n\t\t\t\t\"Attempt to Enable SMC FAN CONTROL Feature Failed!\",\n\t\t\t\treturn -1);\n\n\treturn 0;\n}\n\n\nint vega12_fan_ctrl_stop_smc_fan_control(struct pp_hwmgr *hwmgr)\n{\n\tstruct vega12_hwmgr *data = (struct vega12_hwmgr *)(hwmgr->backend);\n\n\tif (data->smu_features[GNLD_FAN_CONTROL].supported)\n\t\tPP_ASSERT_WITH_CODE(!vega12_disable_fan_control_feature(hwmgr),\n\t\t\t\t\"Attempt to Disable SMC FAN CONTROL Feature Failed!\",\n\t\t\t\treturn -1);\n\n\treturn 0;\n}\n\n \nint vega12_fan_ctrl_reset_fan_speed_to_default(struct pp_hwmgr *hwmgr)\n{\n\treturn vega12_fan_ctrl_start_smc_fan_control(hwmgr);\n}\n\n \nint vega12_thermal_get_temperature(struct pp_hwmgr *hwmgr)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\tint temp = 0;\n\n\ttemp = RREG32_SOC15(THM, 0, mmCG_MULT_THERMAL_STATUS);\n\n\ttemp = (temp & CG_MULT_THERMAL_STATUS__CTF_TEMP_MASK) >>\n\t\t\tCG_MULT_THERMAL_STATUS__CTF_TEMP__SHIFT;\n\n\ttemp = temp & 0x1ff;\n\n\ttemp *= PP_TEMPERATURE_UNITS_PER_CENTIGRADES;\n\treturn temp;\n}\n\n \nstatic int vega12_thermal_set_temperature_range(struct pp_hwmgr *hwmgr,\n\t\tstruct PP_TemperatureRange *range)\n{\n\tstruct phm_ppt_v3_information *pptable_information =\n\t\t(struct phm_ppt_v3_information *)hwmgr->pptable;\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\tint low = VEGA12_THERMAL_MINIMUM_ALERT_TEMP;\n\tint high = VEGA12_THERMAL_MAXIMUM_ALERT_TEMP;\n\tuint32_t val;\n\n\t \n\tif (low < range->min / PP_TEMPERATURE_UNITS_PER_CENTIGRADES)\n\t\tlow = range->min / PP_TEMPERATURE_UNITS_PER_CENTIGRADES;\n\tif (high > pptable_information->us_software_shutdown_temp)\n\t\thigh = pptable_information->us_software_shutdown_temp;\n\n\tif (low > high)\n\t\treturn -EINVAL;\n\n\tval = RREG32_SOC15(THM, 0, mmTHM_THERMAL_INT_CTRL);\n\n\tval = REG_SET_FIELD(val, THM_THERMAL_INT_CTRL, MAX_IH_CREDIT, 5);\n\tval = REG_SET_FIELD(val, THM_THERMAL_INT_CTRL, THERM_IH_HW_ENA, 1);\n\tval = REG_SET_FIELD(val, THM_THERMAL_INT_CTRL, DIG_THERM_INTH, high);\n\tval = REG_SET_FIELD(val, THM_THERMAL_INT_CTRL, DIG_THERM_INTL, low);\n\tval &= ~THM_THERMAL_INT_CTRL__THERM_TRIGGER_MASK_MASK;\n\tval &= ~THM_THERMAL_INT_CTRL__THERM_INTH_MASK_MASK;\n\tval &= ~THM_THERMAL_INT_CTRL__THERM_INTL_MASK_MASK;\n\n\tWREG32_SOC15(THM, 0, mmTHM_THERMAL_INT_CTRL, val);\n\n\treturn 0;\n}\n\n \nstatic int vega12_thermal_enable_alert(struct pp_hwmgr *hwmgr)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\tuint32_t val = 0;\n\n\tval |= (1 << THM_THERMAL_INT_ENA__THERM_INTH_CLR__SHIFT);\n\tval |= (1 << THM_THERMAL_INT_ENA__THERM_INTL_CLR__SHIFT);\n\tval |= (1 << THM_THERMAL_INT_ENA__THERM_TRIGGER_CLR__SHIFT);\n\n\tWREG32_SOC15(THM, 0, mmTHM_THERMAL_INT_ENA, val);\n\n\treturn 0;\n}\n\n \nint vega12_thermal_disable_alert(struct pp_hwmgr *hwmgr)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\n\tWREG32_SOC15(THM, 0, mmTHM_THERMAL_INT_ENA, 0);\n\n\treturn 0;\n}\n\n \nint vega12_thermal_stop_thermal_controller(struct pp_hwmgr *hwmgr)\n{\n\tint result = vega12_thermal_disable_alert(hwmgr);\n\n\treturn result;\n}\n\n \nstatic int vega12_thermal_setup_fan_table(struct pp_hwmgr *hwmgr)\n{\n\tint ret;\n\tstruct vega12_hwmgr *data = (struct vega12_hwmgr *)(hwmgr->backend);\n\tPPTable_t *table = &(data->smc_state_table.pp_table);\n\n\tret = smum_send_msg_to_smc_with_parameter(hwmgr,\n\t\t\t\tPPSMC_MSG_SetFanTemperatureTarget,\n\t\t\t\t(uint32_t)table->FanTargetTemperature,\n\t\t\t\tNULL);\n\n\treturn ret;\n}\n\n \nstatic int vega12_thermal_start_smc_fan_control(struct pp_hwmgr *hwmgr)\n{\n\t \n\tif (PP_CAP(PHM_PlatformCaps_MicrocodeFanControl))\n\t\tvega12_fan_ctrl_start_smc_fan_control(hwmgr);\n\n\treturn 0;\n}\n\n\nint vega12_start_thermal_controller(struct pp_hwmgr *hwmgr,\n\t\t\t\tstruct PP_TemperatureRange *range)\n{\n\tint ret = 0;\n\n\tif (range == NULL)\n\t\treturn -EINVAL;\n\n\tret = vega12_thermal_set_temperature_range(hwmgr, range);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\tvega12_thermal_enable_alert(hwmgr);\n\t \n\tret = vega12_thermal_setup_fan_table(hwmgr);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\tvega12_thermal_start_smc_fan_control(hwmgr);\n\n\treturn 0;\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}