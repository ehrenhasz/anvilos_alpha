{
  "module_name": "smu7_clockpowergating.c",
  "hash_id": "b2a70674b7c6b4fe898b2a290b0b1b8b4f3086b1699b2ba4dd305f34b432227c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/pm/powerplay/hwmgr/smu7_clockpowergating.c",
  "human_readable_source": " \n\n#include \"smu7_hwmgr.h\"\n#include \"smu7_clockpowergating.h\"\n#include \"smu7_common.h\"\n\nstatic int smu7_enable_disable_uvd_dpm(struct pp_hwmgr *hwmgr, bool enable)\n{\n\treturn smum_send_msg_to_smc(hwmgr, enable ?\n\t\t\tPPSMC_MSG_UVDDPM_Enable :\n\t\t\tPPSMC_MSG_UVDDPM_Disable,\n\t\t\tNULL);\n}\n\nstatic int smu7_enable_disable_vce_dpm(struct pp_hwmgr *hwmgr, bool enable)\n{\n\treturn smum_send_msg_to_smc(hwmgr, enable ?\n\t\t\tPPSMC_MSG_VCEDPM_Enable :\n\t\t\tPPSMC_MSG_VCEDPM_Disable,\n\t\t\tNULL);\n}\n\nstatic int smu7_update_uvd_dpm(struct pp_hwmgr *hwmgr, bool bgate)\n{\n\tif (!bgate)\n\t\tsmum_update_smc_table(hwmgr, SMU_UVD_TABLE);\n\treturn smu7_enable_disable_uvd_dpm(hwmgr, !bgate);\n}\n\nstatic int smu7_update_vce_dpm(struct pp_hwmgr *hwmgr, bool bgate)\n{\n\tif (!bgate)\n\t\tsmum_update_smc_table(hwmgr, SMU_VCE_TABLE);\n\treturn smu7_enable_disable_vce_dpm(hwmgr, !bgate);\n}\n\nint smu7_powerdown_uvd(struct pp_hwmgr *hwmgr)\n{\n\tif (phm_cf_want_uvd_power_gating(hwmgr))\n\t\treturn smum_send_msg_to_smc(hwmgr,\n\t\t\t\tPPSMC_MSG_UVDPowerOFF,\n\t\t\t\tNULL);\n\treturn 0;\n}\n\nstatic int smu7_powerup_uvd(struct pp_hwmgr *hwmgr)\n{\n\tif (phm_cf_want_uvd_power_gating(hwmgr)) {\n\t\tif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\n\t\t\t\t  PHM_PlatformCaps_UVDDynamicPowerGating)) {\n\t\t\treturn smum_send_msg_to_smc_with_parameter(hwmgr,\n\t\t\t\t\tPPSMC_MSG_UVDPowerON, 1, NULL);\n\t\t} else {\n\t\t\treturn smum_send_msg_to_smc_with_parameter(hwmgr,\n\t\t\t\t\tPPSMC_MSG_UVDPowerON, 0, NULL);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int smu7_powerdown_vce(struct pp_hwmgr *hwmgr)\n{\n\tif (phm_cf_want_vce_power_gating(hwmgr))\n\t\treturn smum_send_msg_to_smc(hwmgr,\n\t\t\t\tPPSMC_MSG_VCEPowerOFF,\n\t\t\t\tNULL);\n\treturn 0;\n}\n\nstatic int smu7_powerup_vce(struct pp_hwmgr *hwmgr)\n{\n\tif (phm_cf_want_vce_power_gating(hwmgr))\n\t\treturn smum_send_msg_to_smc(hwmgr,\n\t\t\t\tPPSMC_MSG_VCEPowerON,\n\t\t\t\tNULL);\n\treturn 0;\n}\n\nint smu7_disable_clock_power_gating(struct pp_hwmgr *hwmgr)\n{\n\tstruct smu7_hwmgr *data = (struct smu7_hwmgr *)(hwmgr->backend);\n\n\tdata->uvd_power_gated = false;\n\tdata->vce_power_gated = false;\n\n\tsmu7_powerup_uvd(hwmgr);\n\tsmu7_powerup_vce(hwmgr);\n\n\treturn 0;\n}\n\nvoid smu7_powergate_uvd(struct pp_hwmgr *hwmgr, bool bgate)\n{\n\tstruct smu7_hwmgr *data = (struct smu7_hwmgr *)(hwmgr->backend);\n\n\tdata->uvd_power_gated = bgate;\n\n\tif (bgate) {\n\t\tamdgpu_device_ip_set_powergating_state(hwmgr->adev,\n\t\t\t\t\t\tAMD_IP_BLOCK_TYPE_UVD,\n\t\t\t\t\t\tAMD_PG_STATE_GATE);\n\t\tamdgpu_device_ip_set_clockgating_state(hwmgr->adev,\n\t\t\t\tAMD_IP_BLOCK_TYPE_UVD,\n\t\t\t\tAMD_CG_STATE_GATE);\n\t\tsmu7_update_uvd_dpm(hwmgr, true);\n\t\tsmu7_powerdown_uvd(hwmgr);\n\t} else {\n\t\tsmu7_powerup_uvd(hwmgr);\n\t\tamdgpu_device_ip_set_clockgating_state(hwmgr->adev,\n\t\t\t\tAMD_IP_BLOCK_TYPE_UVD,\n\t\t\t\tAMD_CG_STATE_UNGATE);\n\t\tamdgpu_device_ip_set_powergating_state(hwmgr->adev,\n\t\t\t\t\t\tAMD_IP_BLOCK_TYPE_UVD,\n\t\t\t\t\t\tAMD_PG_STATE_UNGATE);\n\t\tsmu7_update_uvd_dpm(hwmgr, false);\n\t}\n\n}\n\nvoid smu7_powergate_vce(struct pp_hwmgr *hwmgr, bool bgate)\n{\n\tstruct smu7_hwmgr *data = (struct smu7_hwmgr *)(hwmgr->backend);\n\n\tdata->vce_power_gated = bgate;\n\n\tif (bgate) {\n\t\tamdgpu_device_ip_set_powergating_state(hwmgr->adev,\n\t\t\t\t\t\tAMD_IP_BLOCK_TYPE_VCE,\n\t\t\t\t\t\tAMD_PG_STATE_GATE);\n\t\tamdgpu_device_ip_set_clockgating_state(hwmgr->adev,\n\t\t\t\tAMD_IP_BLOCK_TYPE_VCE,\n\t\t\t\tAMD_CG_STATE_GATE);\n\t\tsmu7_update_vce_dpm(hwmgr, true);\n\t\tsmu7_powerdown_vce(hwmgr);\n\t} else {\n\t\tsmu7_powerup_vce(hwmgr);\n\t\tamdgpu_device_ip_set_clockgating_state(hwmgr->adev,\n\t\t\t\tAMD_IP_BLOCK_TYPE_VCE,\n\t\t\t\tAMD_CG_STATE_UNGATE);\n\t\tamdgpu_device_ip_set_powergating_state(hwmgr->adev,\n\t\t\t\t\t\tAMD_IP_BLOCK_TYPE_VCE,\n\t\t\t\t\t\tAMD_PG_STATE_UNGATE);\n\t\tsmu7_update_vce_dpm(hwmgr, false);\n\t}\n}\n\nint smu7_update_clock_gatings(struct pp_hwmgr *hwmgr,\n\t\t\t\t\tconst uint32_t *msg_id)\n{\n\tPPSMC_Msg msg;\n\tuint32_t value;\n\n\tif (!(hwmgr->feature_mask & PP_ENABLE_GFX_CG_THRU_SMU))\n\t\treturn 0;\n\n\tswitch ((*msg_id & PP_GROUP_MASK) >> PP_GROUP_SHIFT) {\n\tcase PP_GROUP_GFX:\n\t\tswitch ((*msg_id & PP_BLOCK_MASK) >> PP_BLOCK_SHIFT) {\n\t\tcase PP_BLOCK_GFX_CG:\n\t\t\tif (PP_STATE_SUPPORT_CG & *msg_id) {\n\t\t\t\tmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_GFX_CGCG_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tif (PP_STATE_SUPPORT_LS & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS\n\t\t\t\t\t? PPSMC_MSG_EnableClockGatingFeature\n\t\t\t\t\t: PPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_GFX_CGLS_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase PP_BLOCK_GFX_3D:\n\t\t\tif (PP_STATE_SUPPORT_CG & *msg_id) {\n\t\t\t\tmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_GFX_3DCG_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\n\t\t\tif  (PP_STATE_SUPPORT_LS & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_GFX_3DLS_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase PP_BLOCK_GFX_RLC:\n\t\t\tif (PP_STATE_SUPPORT_LS & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_GFX_RLC_LS_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase PP_BLOCK_GFX_CP:\n\t\t\tif (PP_STATE_SUPPORT_LS & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_GFX_CP_LS_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase PP_BLOCK_GFX_MG:\n\t\t\tif (PP_STATE_SUPPORT_CG & *msg_id) {\n\t\t\t\tmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG)\t?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = (CG_CPF_MGCG_MASK | CG_RLC_MGCG_MASK |\n\t\t\t\t\t\tCG_GFX_OTHERS_MGCG_MASK);\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\n\tcase PP_GROUP_SYS:\n\t\tswitch ((*msg_id & PP_BLOCK_MASK) >> PP_BLOCK_SHIFT) {\n\t\tcase PP_BLOCK_SYS_BIF:\n\t\t\tif (PP_STATE_SUPPORT_CG & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_CG ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_BIF_MGCG_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tif  (PP_STATE_SUPPORT_LS & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_BIF_MGLS_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase PP_BLOCK_SYS_MC:\n\t\t\tif (PP_STATE_SUPPORT_CG & *msg_id) {\n\t\t\t\tmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG)\t?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_MC_MGCG_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\n\t\t\tif (PP_STATE_SUPPORT_LS & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_MC_MGLS_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase PP_BLOCK_SYS_DRM:\n\t\t\tif (PP_STATE_SUPPORT_CG & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_CG ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_DRM_MGCG_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tif (PP_STATE_SUPPORT_LS & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_DRM_MGLS_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase PP_BLOCK_SYS_HDP:\n\t\t\tif (PP_STATE_SUPPORT_CG & *msg_id) {\n\t\t\t\tmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_HDP_MGCG_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\n\t\t\tif (PP_STATE_SUPPORT_LS & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_HDP_MGLS_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase PP_BLOCK_SYS_SDMA:\n\t\t\tif (PP_STATE_SUPPORT_CG & *msg_id) {\n\t\t\t\tmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG)\t?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_SDMA_MGCG_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\n\t\t\tif (PP_STATE_SUPPORT_LS & *msg_id) {\n\t\t\t\tmsg = (*msg_id & PP_STATE_MASK) & PP_STATE_LS ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_SDMA_MGLS_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase PP_BLOCK_SYS_ROM:\n\t\t\tif (PP_STATE_SUPPORT_CG & *msg_id) {\n\t\t\t\tmsg = ((*msg_id & PP_STATE_MASK) & PP_STATE_CG) ?\n\t\t\t\t\t\tPPSMC_MSG_EnableClockGatingFeature :\n\t\t\t\t\t\tPPSMC_MSG_DisableClockGatingFeature;\n\t\t\t\tvalue = CG_SYS_ROM_MASK;\n\n\t\t\t\tif (smum_send_msg_to_smc_with_parameter(\n\t\t\t\t\t\thwmgr, msg, value, NULL))\n\t\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\n\t}\n\n\treturn 0;\n}\n\n \nint smu7_powergate_gfx(struct pp_hwmgr *hwmgr, bool enable)\n{\n\tstruct amdgpu_device *adev = hwmgr->adev;\n\n\tif (enable)\n\t\treturn smum_send_msg_to_smc_with_parameter(hwmgr,\n\t\t\t\t\tPPSMC_MSG_GFX_CU_PG_ENABLE,\n\t\t\t\t\tadev->gfx.cu_info.number,\n\t\t\t\t\tNULL);\n\telse\n\t\treturn smum_send_msg_to_smc(hwmgr,\n\t\t\t\tPPSMC_MSG_GFX_CU_PG_DISABLE,\n\t\t\t\tNULL);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}