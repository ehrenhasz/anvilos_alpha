{
  "module_name": "amdgpu_dm_psr.c",
  "hash_id": "99c9182337f6d2b449781a9b96ac1fa160ec333d27b4f3ecb518586d9ab96bcb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_psr.c",
  "human_readable_source": " \n\n#include \"amdgpu_dm_psr.h\"\n#include \"dc_dmub_srv.h\"\n#include \"dc.h\"\n#include \"dm_helpers.h\"\n#include \"amdgpu_dm.h\"\n#include \"modules/power/power_helpers.h\"\n\nstatic bool link_supports_psrsu(struct dc_link *link)\n{\n\tstruct dc *dc = link->ctx->dc;\n\n\tif (!dc->caps.dmcub_support)\n\t\treturn false;\n\n\tif (dc->ctx->dce_version < DCN_VERSION_3_1)\n\t\treturn false;\n\n\tif (!is_psr_su_specific_panel(link))\n\t\treturn false;\n\n\tif (!link->dpcd_caps.alpm_caps.bits.AUX_WAKE_ALPM_CAP ||\n\t    !link->dpcd_caps.psr_info.psr_dpcd_caps.bits.Y_COORDINATE_REQUIRED)\n\t\treturn false;\n\n\tif (link->dpcd_caps.psr_info.psr_dpcd_caps.bits.SU_GRANULARITY_REQUIRED &&\n\t    !link->dpcd_caps.psr_info.psr2_su_y_granularity_cap)\n\t\treturn false;\n\n\treturn dc_dmub_check_min_version(dc->ctx->dmub_srv->dmub);\n}\n\n \nvoid amdgpu_dm_set_psr_caps(struct dc_link *link)\n{\n\tif (!(link->connector_signal & SIGNAL_TYPE_EDP)) {\n\t\tlink->psr_settings.psr_feature_enabled = false;\n\t\treturn;\n\t}\n\n\tif (link->type == dc_connection_none) {\n\t\tlink->psr_settings.psr_feature_enabled = false;\n\t\treturn;\n\t}\n\n\tif (link->dpcd_caps.psr_info.psr_version == 0) {\n\t\tlink->psr_settings.psr_version = DC_PSR_VERSION_UNSUPPORTED;\n\t\tlink->psr_settings.psr_feature_enabled = false;\n\n\t} else {\n\t\tif (link_supports_psrsu(link))\n\t\t\tlink->psr_settings.psr_version = DC_PSR_VERSION_SU_1;\n\t\telse\n\t\t\tlink->psr_settings.psr_version = DC_PSR_VERSION_1;\n\n\t\tlink->psr_settings.psr_feature_enabled = true;\n\t}\n\n\tDRM_INFO(\"PSR support %d, DC PSR ver %d, sink PSR ver %d DPCD caps 0x%x su_y_granularity %d\\n\",\n\t\tlink->psr_settings.psr_feature_enabled,\n\t\tlink->psr_settings.psr_version,\n\t\tlink->dpcd_caps.psr_info.psr_version,\n\t\tlink->dpcd_caps.psr_info.psr_dpcd_caps.raw,\n\t\tlink->dpcd_caps.psr_info.psr2_su_y_granularity_cap);\n\n}\n\n \nbool amdgpu_dm_link_setup_psr(struct dc_stream_state *stream)\n{\n\tstruct dc_link *link = NULL;\n\tstruct psr_config psr_config = {0};\n\tstruct psr_context psr_context = {0};\n\tstruct dc *dc = NULL;\n\tbool ret = false;\n\n\tif (stream == NULL)\n\t\treturn false;\n\n\tlink = stream->link;\n\tdc = link->ctx->dc;\n\n\tif (link->psr_settings.psr_version != DC_PSR_VERSION_UNSUPPORTED) {\n\t\tmod_power_calc_psr_configs(&psr_config, link, stream);\n\n\t\t \n\t\tpsr_config.allow_smu_optimizations =\n\t\t\t(amdgpu_dc_feature_mask & DC_PSR_ALLOW_SMU_OPT) &&\n\t\t\tmod_power_only_edp(dc->current_state, stream);\n\t\tpsr_config.allow_multi_disp_optimizations =\n\t\t\t(amdgpu_dc_feature_mask & DC_PSR_ALLOW_MULTI_DISP_OPT);\n\n\t\tif (!psr_su_set_dsc_slice_height(dc, link, stream, &psr_config))\n\t\t\treturn false;\n\n\t\tret = dc_link_setup_psr(link, stream, &psr_config, &psr_context);\n\n\t}\n\tDRM_DEBUG_DRIVER(\"PSR link: %d\\n\",\tlink->psr_settings.psr_feature_enabled);\n\n\treturn ret;\n}\n\n \nbool amdgpu_dm_psr_enable(struct dc_stream_state *stream)\n{\n\tstruct dc_link *link = stream->link;\n\tunsigned int vsync_rate_hz = 0;\n\tstruct dc_static_screen_params params = {0};\n\t \n\t\n\tunsigned int num_frames_static = 2;\n\tunsigned int power_opt = 0;\n\tbool psr_enable = true;\n\n\tDRM_DEBUG_DRIVER(\"Enabling psr...\\n\");\n\n\tvsync_rate_hz = div64_u64(div64_u64((\n\t\t\tstream->timing.pix_clk_100hz * 100),\n\t\t\tstream->timing.v_total),\n\t\t\tstream->timing.h_total);\n\n\t \n\tif (vsync_rate_hz != 0) {\n\t\tunsigned int frame_time_microsec = 1000000 / vsync_rate_hz;\n\n\t\tnum_frames_static = (30000 / frame_time_microsec) + 1;\n\t}\n\n\tparams.triggers.cursor_update = true;\n\tparams.triggers.overlay_update = true;\n\tparams.triggers.surface_update = true;\n\tparams.num_frames = num_frames_static;\n\n\tdc_stream_set_static_screen_params(link->ctx->dc,\n\t\t\t\t\t   &stream, 1,\n\t\t\t\t\t   &params);\n\n\t \n\tif (link->psr_settings.psr_version < DC_PSR_VERSION_SU_1)\n\t\tpower_opt |= psr_power_opt_z10_static_screen;\n\n\treturn dc_link_set_psr_allow_active(link, &psr_enable, false, false, &power_opt);\n}\n\n \nbool amdgpu_dm_psr_disable(struct dc_stream_state *stream)\n{\n\tunsigned int power_opt = 0;\n\tbool psr_enable = false;\n\n\tDRM_DEBUG_DRIVER(\"Disabling psr...\\n\");\n\n\treturn dc_link_set_psr_allow_active(stream->link, &psr_enable, true, false, &power_opt);\n}\n\n \nbool amdgpu_dm_psr_disable_all(struct amdgpu_display_manager *dm)\n{\n\tDRM_DEBUG_DRIVER(\"Disabling psr if psr is enabled on any stream\\n\");\n\treturn dc_set_psr_allow_active(dm->dc, false);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}