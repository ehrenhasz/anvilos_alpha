{
  "module_name": "dc_fpu.c",
  "hash_id": "80ef1ba842f9f55ec1b28db4a3ff775552c2105965defc011091f1ed6cb51945",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/amdgpu_dm/dc_fpu.c",
  "human_readable_source": "\n \n\n#include \"dc_trace.h\"\n\n#if defined(CONFIG_X86)\n#include <asm/fpu/api.h>\n#elif defined(CONFIG_PPC64)\n#include <asm/switch_to.h>\n#include <asm/cputable.h>\n#elif defined(CONFIG_ARM64)\n#include <asm/neon.h>\n#elif defined(CONFIG_LOONGARCH)\n#include <asm/fpu.h>\n#endif\n\n \n\nstatic DEFINE_PER_CPU(int, fpu_recursion_depth);\n\n \ninline void dc_assert_fp_enabled(void)\n{\n\tint *pcpu, depth = 0;\n\n\tpcpu = get_cpu_ptr(&fpu_recursion_depth);\n\tdepth = *pcpu;\n\tput_cpu_ptr(&fpu_recursion_depth);\n\n\tASSERT(depth >= 1);\n}\n\n \nvoid dc_fpu_begin(const char *function_name, const int line)\n{\n\tint *pcpu;\n\n\tpcpu = get_cpu_ptr(&fpu_recursion_depth);\n\t*pcpu += 1;\n\n\tif (*pcpu == 1) {\n#if defined(CONFIG_X86) || defined(CONFIG_LOONGARCH)\n\t\tmigrate_disable();\n\t\tkernel_fpu_begin();\n#elif defined(CONFIG_PPC64)\n\t\tif (cpu_has_feature(CPU_FTR_VSX_COMP)) {\n\t\t\tpreempt_disable();\n\t\t\tenable_kernel_vsx();\n\t\t} else if (cpu_has_feature(CPU_FTR_ALTIVEC_COMP)) {\n\t\t\tpreempt_disable();\n\t\t\tenable_kernel_altivec();\n\t\t} else if (!cpu_has_feature(CPU_FTR_FPU_UNAVAILABLE)) {\n\t\t\tpreempt_disable();\n\t\t\tenable_kernel_fp();\n\t\t}\n#elif defined(CONFIG_ARM64)\n\t\tkernel_neon_begin();\n#endif\n\t}\n\n\tTRACE_DCN_FPU(true, function_name, line, *pcpu);\n\tput_cpu_ptr(&fpu_recursion_depth);\n}\n\n \nvoid dc_fpu_end(const char *function_name, const int line)\n{\n\tint *pcpu;\n\n\tpcpu = get_cpu_ptr(&fpu_recursion_depth);\n\t*pcpu -= 1;\n\tif (*pcpu <= 0) {\n#if defined(CONFIG_X86) || defined(CONFIG_LOONGARCH)\n\t\tkernel_fpu_end();\n\t\tmigrate_enable();\n#elif defined(CONFIG_PPC64)\n\t\tif (cpu_has_feature(CPU_FTR_VSX_COMP)) {\n\t\t\tdisable_kernel_vsx();\n\t\t\tpreempt_enable();\n\t\t} else if (cpu_has_feature(CPU_FTR_ALTIVEC_COMP)) {\n\t\t\tdisable_kernel_altivec();\n\t\t\tpreempt_enable();\n\t\t} else if (!cpu_has_feature(CPU_FTR_FPU_UNAVAILABLE)) {\n\t\t\tdisable_kernel_fp();\n\t\t\tpreempt_enable();\n\t\t}\n#elif defined(CONFIG_ARM64)\n\t\tkernel_neon_end();\n#endif\n\t}\n\n\tTRACE_DCN_FPU(false, function_name, line, *pcpu);\n\tput_cpu_ptr(&fpu_recursion_depth);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}