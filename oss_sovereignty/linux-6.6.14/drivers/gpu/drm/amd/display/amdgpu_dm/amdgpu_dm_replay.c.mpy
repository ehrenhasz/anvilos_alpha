{
  "module_name": "amdgpu_dm_replay.c",
  "hash_id": "c5bf606a32852d7950b14c0f82e629555a4bd3320666e8282014aae77b93e901",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_replay.c",
  "human_readable_source": " \n\n#include \"amdgpu_dm_replay.h\"\n#include \"dc.h\"\n#include \"dm_helpers.h\"\n#include \"amdgpu_dm.h\"\n#include \"modules/power/power_helpers.h\"\n#include \"dmub/inc/dmub_cmd.h\"\n#include \"dc/inc/link.h\"\n\n \nstatic bool link_supports_replay(struct dc_link *link, struct amdgpu_dm_connector *aconnector)\n{\n\tstruct dm_connector_state *state = to_dm_connector_state(aconnector->base.state);\n\tstruct dpcd_caps *dpcd_caps = &link->dpcd_caps;\n\tstruct adaptive_sync_caps *as_caps = &link->dpcd_caps.adaptive_sync_caps;\n\n\tif (!state->freesync_capable)\n\t\treturn false;\n\n\tif (!aconnector->vsdb_info.replay_mode)\n\t\treturn false;\n\n\t\n\tif (dpcd_caps->edp_rev < EDP_REVISION_13)\n\t\treturn false;\n\n\tif (!dpcd_caps->alpm_caps.bits.AUX_WAKE_ALPM_CAP)\n\t\treturn false;\n\n\t\n\tif (!as_caps->dp_adap_sync_caps.bits.ADAPTIVE_SYNC_SDP_SUPPORT)\n\t\treturn false;\n\n\treturn true;\n}\n\n \nbool amdgpu_dm_setup_replay(struct dc_link *link, struct amdgpu_dm_connector *aconnector)\n{\n\tstruct replay_config pr_config;\n\tunion replay_debug_flags *debug_flags = NULL;\n\n\t\n\tif (link->replay_settings.config.replay_supported)\n\t\treturn true;\n\n\tif (!dc_is_embedded_signal(link->connector_signal))\n\t\treturn false;\n\n\tif (link->panel_config.psr.disallow_replay)\n\t\treturn false;\n\n\tif (!link_supports_replay(link, aconnector))\n\t\treturn false;\n\n\t\n\tpr_config.replay_supported = true;\n\tpr_config.replay_power_opt_supported = 0;\n\tpr_config.replay_enable_option |= pr_enable_option_static_screen;\n\tpr_config.replay_timing_sync_supported = aconnector->max_vfreq >= 2 * aconnector->min_vfreq ? true : false;\n\n\tif (!pr_config.replay_timing_sync_supported)\n\t\tpr_config.replay_enable_option &= ~pr_enable_option_general_ui;\n\n\tdebug_flags = (union replay_debug_flags *)&pr_config.debug_flags;\n\tdebug_flags->u32All = 0;\n\tdebug_flags->bitfields.visual_confirm =\n\t\tlink->ctx->dc->debug.visual_confirm == VISUAL_CONFIRM_REPLAY ? true : false;\n\n\tlink->replay_settings.replay_feature_enabled = true;\n\n\tinit_replay_config(link, &pr_config);\n\n\treturn true;\n}\n\n\n \nbool amdgpu_dm_replay_enable(struct dc_stream_state *stream, bool wait)\n{\n\tuint64_t state;\n\tunsigned int retry_count;\n\tbool replay_active = true;\n\tconst unsigned int max_retry = 1000;\n\tbool force_static = true;\n\tstruct dc_link *link = NULL;\n\n\n\tif (stream == NULL)\n\t\treturn false;\n\n\tlink = stream->link;\n\n\tif (link == NULL)\n\t\treturn false;\n\n\tlink->dc->link_srv->edp_setup_replay(link, stream);\n\n\tlink->dc->link_srv->edp_set_replay_allow_active(link, NULL, false, false, NULL);\n\n\tlink->dc->link_srv->edp_set_replay_allow_active(link, &replay_active, false, true, NULL);\n\n\tif (wait == true) {\n\n\t\tfor (retry_count = 0; retry_count <= max_retry; retry_count++) {\n\t\t\tdc_link_get_replay_state(link, &state);\n\t\t\tif (replay_active) {\n\t\t\t\tif (state != REPLAY_STATE_0 &&\n\t\t\t\t\t(!force_static || state == REPLAY_STATE_3))\n\t\t\t\t\tbreak;\n\t\t\t} else {\n\t\t\t\tif (state == REPLAY_STATE_0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tudelay(500);\n\t\t}\n\n\t\t \n\t\tif (retry_count >= max_retry)\n\t\t\tASSERT(0);\n\t} else {\n\t\t \n\t}\n\n\treturn true;\n}\n\n \nbool amdgpu_dm_replay_disable(struct dc_stream_state *stream)\n{\n\n\tif (stream->link) {\n\t\tDRM_DEBUG_DRIVER(\"Disabling replay...\\n\");\n\t\tstream->link->dc->link_srv->edp_set_replay_allow_active(stream->link, NULL, false, false, NULL);\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}