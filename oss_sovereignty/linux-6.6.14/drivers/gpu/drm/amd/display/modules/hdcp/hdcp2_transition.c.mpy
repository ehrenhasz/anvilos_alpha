{
  "module_name": "hdcp2_transition.c",
  "hash_id": "21bd2ee70de46a7aef501c6612a23e9e001a636abaaba8a85a21be8ff7926d13",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/modules/hdcp/hdcp2_transition.c",
  "human_readable_source": " \n\n#include \"hdcp.h\"\n\nenum mod_hdcp_status mod_hdcp_hdcp2_transition(struct mod_hdcp *hdcp,\n\t\tstruct mod_hdcp_event_context *event_ctx,\n\t\tstruct mod_hdcp_transition_input_hdcp2 *input,\n\t\tstruct mod_hdcp_output *output)\n{\n\tenum mod_hdcp_status status = MOD_HDCP_STATUS_SUCCESS;\n\tstruct mod_hdcp_connection *conn = &hdcp->connection;\n\tstruct mod_hdcp_link_adjustment *adjust = &hdcp->connection.link.adjust;\n\n\tswitch (current_state(hdcp)) {\n\tcase H2_A0_KNOWN_HDCP2_CAPABLE_RX:\n\t\tif (input->hdcp2version_read != PASS ||\n\t\t\t\tinput->hdcp2_capable_check != PASS) {\n\t\t\tadjust->hdcp2.disable = 1;\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, HDCP_INITIALIZED);\n\t\t} else {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, H2_A1_SEND_AKE_INIT);\n\t\t}\n\t\tbreak;\n\tcase H2_A1_SEND_AKE_INIT:\n\t\tif (input->create_session != PASS ||\n\t\t\t\tinput->ake_init_prepare != PASS) {\n\t\t\t \n\t\t\tadjust->hdcp2.disable = 1;\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (input->ake_init_write != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tset_watchdog_in_ms(hdcp, 100, output);\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A1_VALIDATE_AKE_CERT);\n\t\tbreak;\n\tcase H2_A1_VALIDATE_AKE_CERT:\n\t\tif (input->ake_cert_available != PASS) {\n\t\t\tif (event_ctx->event ==\n\t\t\t\t\tMOD_HDCP_EVENT_WATCHDOG_TIMEOUT) {\n\t\t\t\t \n\t\t\t\t \n\t\t\t\tfail_and_restart_in_ms(1000, &status, output);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tcallback_in_ms(10, output);\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\t}\n\t\t\tbreak;\n\t\t} else if (input->ake_cert_read != PASS ||\n\t\t\t\tinput->ake_cert_validation != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tif (conn->is_km_stored &&\n\t\t\t\t!adjust->hdcp2.force_no_stored_km) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, H2_A1_SEND_STORED_KM);\n\t\t} else {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, H2_A1_SEND_NO_STORED_KM);\n\t\t}\n\t\tbreak;\n\tcase H2_A1_SEND_NO_STORED_KM:\n\t\tif (input->no_stored_km_write != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tif (adjust->hdcp2.increase_h_prime_timeout)\n\t\t\tset_watchdog_in_ms(hdcp, 2000, output);\n\t\telse\n\t\t\tset_watchdog_in_ms(hdcp, 1000, output);\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A1_READ_H_PRIME);\n\t\tbreak;\n\tcase H2_A1_READ_H_PRIME:\n\t\tif (input->h_prime_available != PASS) {\n\t\t\tif (event_ctx->event ==\n\t\t\t\t\tMOD_HDCP_EVENT_WATCHDOG_TIMEOUT) {\n\t\t\t\t \n\t\t\t\tfail_and_restart_in_ms(1000, &status, output);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tcallback_in_ms(100, output);\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\t}\n\t\t\tbreak;\n\t\t} else if (input->h_prime_read != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tset_watchdog_in_ms(hdcp, 200, output);\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A1_READ_PAIRING_INFO_AND_VALIDATE_H_PRIME);\n\t\tbreak;\n\tcase H2_A1_READ_PAIRING_INFO_AND_VALIDATE_H_PRIME:\n\t\tif (input->pairing_available != PASS) {\n\t\t\tif (event_ctx->event ==\n\t\t\t\t\tMOD_HDCP_EVENT_WATCHDOG_TIMEOUT) {\n\t\t\t\t \n\t\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tcallback_in_ms(20, output);\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\t}\n\t\t\tbreak;\n\t\t} else if (input->pairing_info_read != PASS ||\n\t\t\t\tinput->h_prime_validation != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A2_LOCALITY_CHECK);\n\t\tbreak;\n\tcase H2_A1_SEND_STORED_KM:\n\t\tif (input->stored_km_write != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tset_watchdog_in_ms(hdcp, 200, output);\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A1_VALIDATE_H_PRIME);\n\t\tbreak;\n\tcase H2_A1_VALIDATE_H_PRIME:\n\t\tif (input->h_prime_available != PASS) {\n\t\t\tif (event_ctx->event ==\n\t\t\t\t\tMOD_HDCP_EVENT_WATCHDOG_TIMEOUT) {\n\t\t\t\t \n\t\t\t\tfail_and_restart_in_ms(1000, &status, output);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tcallback_in_ms(20, output);\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\t}\n\t\t\tbreak;\n\t\t} else if (input->h_prime_read != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (input->h_prime_validation != PASS) {\n\t\t\t \n\t\t\tadjust->hdcp2.force_no_stored_km = 1;\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A2_LOCALITY_CHECK);\n\t\tbreak;\n\tcase H2_A2_LOCALITY_CHECK:\n\t\tif (hdcp->state.stay_count > 10 ||\n\t\t\t\tinput->lc_init_prepare != PASS ||\n\t\t\t\tinput->lc_init_write != PASS ||\n\t\t\t\tinput->l_prime_available_poll != PASS ||\n\t\t\t\tinput->l_prime_read != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (input->l_prime_validation != PASS) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tincrement_stay_counter(hdcp);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A3_EXCHANGE_KS_AND_TEST_FOR_REPEATER);\n\t\tbreak;\n\tcase H2_A3_EXCHANGE_KS_AND_TEST_FOR_REPEATER:\n\t\tif (input->eks_prepare != PASS ||\n\t\t\t\tinput->eks_write != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tif (conn->is_repeater) {\n\t\t\tset_watchdog_in_ms(hdcp, 3000, output);\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, H2_A6_WAIT_FOR_RX_ID_LIST);\n\t\t} else {\n\t\t\t \n\t\t\tcallback_in_ms(210, output);\n\t\t\tset_state_id(hdcp, output, H2_ENABLE_ENCRYPTION);\n\t\t}\n\t\tbreak;\n\tcase H2_ENABLE_ENCRYPTION:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (event_ctx->rx_id_list_ready && conn->is_repeater) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, H2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\t\tbreak;\n\t\t} else if (input->enable_encryption != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A5_AUTHENTICATED);\n\t\tset_auth_complete(hdcp, output);\n\t\tbreak;\n\tcase H2_A5_AUTHENTICATED:\n\t\tif (input->rxstatus_read == FAIL ||\n\t\t\t\tinput->reauth_request_check == FAIL) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (event_ctx->rx_id_list_ready && conn->is_repeater) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, H2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(500, output);\n\t\tincrement_stay_counter(hdcp);\n\t\tbreak;\n\tcase H2_A6_WAIT_FOR_RX_ID_LIST:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (!event_ctx->rx_id_list_ready) {\n\t\t\tif (event_ctx->event == MOD_HDCP_EVENT_WATCHDOG_TIMEOUT) {\n\t\t\t\t \n\t\t\t\t \n\t\t\t\tfail_and_restart_in_ms(100, &status, output);\n\t\t\t} else {\n\t\t\t\tcallback_in_ms(300, output);\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\tbreak;\n\tcase H2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS ||\n\t\t\t\tinput->rx_id_list_read != PASS ||\n\t\t\t\tinput->device_count_check != PASS ||\n\t\t\t\tinput->rx_id_list_validation != PASS ||\n\t\t\t\tinput->repeater_auth_ack_write != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A9_SEND_STREAM_MANAGEMENT);\n\t\tbreak;\n\tcase H2_A9_SEND_STREAM_MANAGEMENT:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (event_ctx->rx_id_list_ready && conn->is_repeater) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, H2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\t\tbreak;\n\t\t} else if (input->prepare_stream_manage != PASS ||\n\t\t\t\tinput->stream_manage_write != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tset_watchdog_in_ms(hdcp, 100, output);\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, H2_A9_VALIDATE_STREAM_READY);\n\t\tbreak;\n\tcase H2_A9_VALIDATE_STREAM_READY:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (event_ctx->rx_id_list_ready && conn->is_repeater) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, H2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\t\tbreak;\n\t\t} else if (input->stream_ready_available != PASS) {\n\t\t\tif (event_ctx->event == MOD_HDCP_EVENT_WATCHDOG_TIMEOUT) {\n\t\t\t\t \n\t\t\t\thdcp->auth.count.stream_management_retry_count++;\n\t\t\t\tcallback_in_ms(0, output);\n\t\t\t\tset_state_id(hdcp, output, H2_A9_SEND_STREAM_MANAGEMENT);\n\t\t\t} else {\n\t\t\t\tcallback_in_ms(10, output);\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\t}\n\t\t\tbreak;\n\t\t} else if (input->stream_ready_read != PASS ||\n\t\t\t\tinput->stream_ready_validation != PASS) {\n\t\t\t \n\t\t\tif (hdcp->auth.count.stream_management_retry_count > 10) {\n\t\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\t} else {\n\t\t\t\thdcp->auth.count.stream_management_retry_count++;\n\t\t\t\tcallback_in_ms(0, output);\n\t\t\t\tset_state_id(hdcp, output, H2_A9_SEND_STREAM_MANAGEMENT);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(200, output);\n\t\tset_state_id(hdcp, output, H2_ENABLE_ENCRYPTION);\n\t\tbreak;\n\tdefault:\n\t\tstatus = MOD_HDCP_STATUS_INVALID_STATE;\n\t\tfail_and_restart_in_ms(0, &status, output);\n\t\tbreak;\n\t}\n\n\treturn status;\n}\n\nenum mod_hdcp_status mod_hdcp_hdcp2_dp_transition(struct mod_hdcp *hdcp,\n\t\tstruct mod_hdcp_event_context *event_ctx,\n\t\tstruct mod_hdcp_transition_input_hdcp2 *input,\n\t\tstruct mod_hdcp_output *output)\n{\n\tenum mod_hdcp_status status = MOD_HDCP_STATUS_SUCCESS;\n\tstruct mod_hdcp_connection *conn = &hdcp->connection;\n\tstruct mod_hdcp_link_adjustment *adjust = &hdcp->connection.link.adjust;\n\n\tswitch (current_state(hdcp)) {\n\tcase D2_A0_DETERMINE_RX_HDCP_CAPABLE:\n\t\tif (input->rx_caps_read_dp != PASS ||\n\t\t\t\tinput->hdcp2_capable_check != PASS) {\n\t\t\tadjust->hdcp2.disable = 1;\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, HDCP_INITIALIZED);\n\t\t} else {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, D2_A1_SEND_AKE_INIT);\n\t\t}\n\t\tbreak;\n\tcase D2_A1_SEND_AKE_INIT:\n\t\tif (input->create_session != PASS ||\n\t\t\t\tinput->ake_init_prepare != PASS) {\n\t\t\t \n\t\t\tadjust->hdcp2.disable = 1;\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (input->ake_init_write != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(100, output);\n\t\tset_state_id(hdcp, output, D2_A1_VALIDATE_AKE_CERT);\n\t\tbreak;\n\tcase D2_A1_VALIDATE_AKE_CERT:\n\t\tif (input->ake_cert_read != PASS ||\n\t\t\t\tinput->ake_cert_validation != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tif (conn->is_km_stored &&\n\t\t\t\t!adjust->hdcp2.force_no_stored_km) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, D2_A1_SEND_STORED_KM);\n\t\t} else {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, D2_A1_SEND_NO_STORED_KM);\n\t\t}\n\t\tbreak;\n\tcase D2_A1_SEND_NO_STORED_KM:\n\t\tif (input->no_stored_km_write != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tif (adjust->hdcp2.increase_h_prime_timeout)\n\t\t\tset_watchdog_in_ms(hdcp, 2000, output);\n\t\telse\n\t\t\tset_watchdog_in_ms(hdcp, 1000, output);\n\t\tset_state_id(hdcp, output, D2_A1_READ_H_PRIME);\n\t\tbreak;\n\tcase D2_A1_READ_H_PRIME:\n\t\tif (input->h_prime_available != PASS) {\n\t\t\tif (event_ctx->event ==\n\t\t\t\t\tMOD_HDCP_EVENT_WATCHDOG_TIMEOUT)\n\t\t\t\t \n\t\t\t\tfail_and_restart_in_ms(1000, &status, output);\n\t\t\telse\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\tbreak;\n\t\t} else if (input->h_prime_read != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tset_watchdog_in_ms(hdcp, 200, output);\n\t\tset_state_id(hdcp, output, D2_A1_READ_PAIRING_INFO_AND_VALIDATE_H_PRIME);\n\t\tbreak;\n\tcase D2_A1_READ_PAIRING_INFO_AND_VALIDATE_H_PRIME:\n\t\tif (input->pairing_available != PASS) {\n\t\t\tif (event_ctx->event ==\n\t\t\t\t\tMOD_HDCP_EVENT_WATCHDOG_TIMEOUT)\n\t\t\t\t \n\t\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\telse\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\tbreak;\n\t\t} else if (input->pairing_info_read != PASS ||\n\t\t\t\tinput->h_prime_validation != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, D2_A2_LOCALITY_CHECK);\n\t\tbreak;\n\tcase D2_A1_SEND_STORED_KM:\n\t\tif (input->stored_km_write != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tset_watchdog_in_ms(hdcp, 200, output);\n\t\tset_state_id(hdcp, output, D2_A1_VALIDATE_H_PRIME);\n\t\tbreak;\n\tcase D2_A1_VALIDATE_H_PRIME:\n\t\tif (input->h_prime_available != PASS) {\n\t\t\tif (event_ctx->event ==\n\t\t\t\t\tMOD_HDCP_EVENT_WATCHDOG_TIMEOUT)\n\t\t\t\t \n\t\t\t\tfail_and_restart_in_ms(1000, &status, output);\n\t\t\telse\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\tbreak;\n\t\t} else if (input->h_prime_read != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (input->h_prime_validation != PASS) {\n\t\t\t \n\t\t\tadjust->hdcp2.force_no_stored_km = 1;\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, D2_A2_LOCALITY_CHECK);\n\t\tbreak;\n\tcase D2_A2_LOCALITY_CHECK:\n\t\tif (hdcp->state.stay_count > 10 ||\n\t\t\t\tinput->lc_init_prepare != PASS ||\n\t\t\t\tinput->lc_init_write != PASS ||\n\t\t\t\tinput->l_prime_read != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (input->l_prime_validation != PASS) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tincrement_stay_counter(hdcp);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, D2_A34_EXCHANGE_KS_AND_TEST_FOR_REPEATER);\n\t\tbreak;\n\tcase D2_A34_EXCHANGE_KS_AND_TEST_FOR_REPEATER:\n\t\tif (input->eks_prepare != PASS ||\n\t\t\t\tinput->eks_write != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tif (conn->is_repeater) {\n\t\t\tset_watchdog_in_ms(hdcp, 3000, output);\n\t\t\tset_state_id(hdcp, output, D2_A6_WAIT_FOR_RX_ID_LIST);\n\t\t} else {\n\t\t\tcallback_in_ms(1, output);\n\t\t\tset_state_id(hdcp, output, D2_SEND_CONTENT_STREAM_TYPE);\n\t\t}\n\t\tbreak;\n\tcase D2_SEND_CONTENT_STREAM_TYPE:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS ||\n\t\t\t\tinput->link_integrity_check_dp != PASS ||\n\t\t\t\tinput->content_stream_type_write != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(210, output);\n\t\tset_state_id(hdcp, output, D2_ENABLE_ENCRYPTION);\n\t\tbreak;\n\tcase D2_ENABLE_ENCRYPTION:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS ||\n\t\t\t\tinput->link_integrity_check_dp != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (event_ctx->rx_id_list_ready && conn->is_repeater) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, D2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\t\tbreak;\n\t\t} else if (input->enable_encryption != PASS ||\n\t\t\t\t(is_dp_mst_hdcp(hdcp) && input->stream_encryption_dp != PASS)) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tset_state_id(hdcp, output, D2_A5_AUTHENTICATED);\n\t\tset_auth_complete(hdcp, output);\n\t\tbreak;\n\tcase D2_A5_AUTHENTICATED:\n\t\tif (input->rxstatus_read == FAIL ||\n\t\t\t\tinput->reauth_request_check == FAIL) {\n\t\t\tfail_and_restart_in_ms(100, &status, output);\n\t\t\tbreak;\n\t\t} else if (input->link_integrity_check_dp == FAIL) {\n\t\t\tif (hdcp->connection.hdcp2_retry_count >= 1)\n\t\t\t\tadjust->hdcp2.force_type = MOD_HDCP_FORCE_TYPE_0;\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (event_ctx->rx_id_list_ready && conn->is_repeater) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, D2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\t\tbreak;\n\t\t}\n\t\tincrement_stay_counter(hdcp);\n\t\tbreak;\n\tcase D2_A6_WAIT_FOR_RX_ID_LIST:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS ||\n\t\t\t\tinput->link_integrity_check_dp != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (!event_ctx->rx_id_list_ready) {\n\t\t\tif (event_ctx->event == MOD_HDCP_EVENT_WATCHDOG_TIMEOUT)\n\t\t\t\t \n\t\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\telse\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, D2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\tbreak;\n\tcase D2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS ||\n\t\t\t\tinput->link_integrity_check_dp != PASS ||\n\t\t\t\tinput->rx_id_list_read != PASS ||\n\t\t\t\tinput->device_count_check != PASS ||\n\t\t\t\tinput->rx_id_list_validation != PASS ||\n\t\t\t\tinput->repeater_auth_ack_write != PASS) {\n\t\t\t \n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(0, output);\n\t\tset_state_id(hdcp, output, D2_A9_SEND_STREAM_MANAGEMENT);\n\t\tbreak;\n\tcase D2_A9_SEND_STREAM_MANAGEMENT:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS ||\n\t\t\t\tinput->link_integrity_check_dp != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (event_ctx->rx_id_list_ready) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, D2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\t\tbreak;\n\t\t} else if (input->prepare_stream_manage != PASS ||\n\t\t\t\tinput->stream_manage_write != PASS) {\n\t\t\tif (event_ctx->event == MOD_HDCP_EVENT_CALLBACK)\n\t\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\telse\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(100, output);\n\t\tset_state_id(hdcp, output, D2_A9_VALIDATE_STREAM_READY);\n\t\tbreak;\n\tcase D2_A9_VALIDATE_STREAM_READY:\n\t\tif (input->rxstatus_read != PASS ||\n\t\t\t\tinput->reauth_request_check != PASS ||\n\t\t\t\tinput->link_integrity_check_dp != PASS) {\n\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\tbreak;\n\t\t} else if (event_ctx->rx_id_list_ready) {\n\t\t\tcallback_in_ms(0, output);\n\t\t\tset_state_id(hdcp, output, D2_A78_VERIFY_RX_ID_LIST_AND_SEND_ACK);\n\t\t\tbreak;\n\t\t} else if (input->stream_ready_read != PASS ||\n\t\t\t\tinput->stream_ready_validation != PASS) {\n\t\t\t \n\t\t\tif (hdcp->auth.count.stream_management_retry_count > 10) {\n\t\t\t\tfail_and_restart_in_ms(0, &status, output);\n\t\t\t} else if (event_ctx->event == MOD_HDCP_EVENT_CALLBACK) {\n\t\t\t\thdcp->auth.count.stream_management_retry_count++;\n\t\t\t\tcallback_in_ms(0, output);\n\t\t\t\tset_state_id(hdcp, output, D2_A9_SEND_STREAM_MANAGEMENT);\n\t\t\t} else {\n\t\t\t\tincrement_stay_counter(hdcp);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcallback_in_ms(200, output);\n\t\tset_state_id(hdcp, output, D2_ENABLE_ENCRYPTION);\n\t\tbreak;\n\tdefault:\n\t\tstatus = MOD_HDCP_STATUS_INVALID_STATE;\n\t\tfail_and_restart_in_ms(0, &status, output);\n\t\tbreak;\n\t}\n\treturn status;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}