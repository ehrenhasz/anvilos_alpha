{
  "module_name": "power_helpers.c",
  "hash_id": "23a57a3c3b40bd4b1e25585b360b739ca827ffc82c882d63a6a64f058054b5da",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/modules/power/power_helpers.c",
  "human_readable_source": " \n\n#include \"power_helpers.h\"\n#include \"dc/inc/hw/dmcu.h\"\n#include \"dc/inc/hw/abm.h\"\n#include \"dc.h\"\n#include \"core_types.h\"\n#include \"dmub_cmd.h\"\n\n#define DIV_ROUNDUP(a, b) (((a)+((b)/2))/(b))\n#define bswap16_based_on_endian(big_endian, value) \\\n\t(big_endian) ? cpu_to_be16(value) : cpu_to_le16(value)\n\n \nstatic const unsigned char min_reduction_table[13] = {\n0xff, 0xfa, 0xf0, 0xf0, 0xd9, 0xcd, 0xc0, 0xb1, 0x99, 0x93, 0x80, 0x82, 0x66};\n\n \nstatic const unsigned char max_reduction_table[13] = {\n0xf5, 0xe5, 0xd9, 0xcd, 0xb1, 0xa5, 0xa5, 0x80, 0x65, 0x4d, 0x4d, 0x4d, 0x32};\n\n \nstatic const unsigned char min_reduction_table_v_2_2[13] = {\n0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xeb, 0xd4, 0xc0, 0xc0};\n\n \nstatic const unsigned char max_reduction_table_v_2_2[13] = {\n0xf5, 0xe5, 0xbf, 0xb1, 0xa5, 0x85, 0x7c, 0x65, 0x4d, 0x40, 0x32, 0x20, 0x20};\n\n \nstatic const unsigned char abm_config[abm_defines_max_config][abm_defines_max_level] = {\n \n{       2,              5,              7,              8       },\t \n{       2,              5,              8,              11      },\t \n{       0,              2,              4,              8       },\t \n{       3,              6,              10,             12      },\t \n};\n\nstruct abm_parameters {\n\tunsigned char min_reduction;\n\tunsigned char max_reduction;\n\tunsigned char bright_pos_gain;\n\tunsigned char dark_pos_gain;\n\tunsigned char brightness_gain;\n\tunsigned char contrast_factor;\n\tunsigned char deviation_gain;\n\tunsigned char min_knee;\n\tunsigned char max_knee;\n\tunsigned short blRampReduction;\n\tunsigned short blRampStart;\n};\n\nstatic const struct abm_parameters abm_settings_config0[abm_defines_max_level] = {\n\n\t{0xff,   0xbf,    0x20,       0x00,     0xff,        0x99,     0xb3, 0x40,     0xe0,     0xf777,  0xcccc},\n\t{0xde,   0x85,    0x20,       0x00,     0xe0,        0x90,     0xa8, 0x40,     0xc8,     0xf777,  0xcccc},\n\t{0xb0,   0x50,    0x20,       0x00,     0xc0,        0x88,     0x78, 0x70,     0xa0,     0xeeee,  0x9999},\n\t{0x82,   0x40,    0x20,       0x00,     0x00,        0xb8,     0xb3, 0x70,     0x70,     0xe333,  0xb333},\n};\n\nstatic const struct abm_parameters abm_settings_config1[abm_defines_max_level] = {\n\n\t{0xf0,   0xd9,    0x20,       0x00,     0x00,        0xff,     0xb3, 0x70,     0x70,     0xcccc,  0xcccc},\n\t{0xcd,   0xa5,    0x20,       0x00,     0x00,        0xff,     0xb3, 0x70,     0x70,     0xcccc,  0xcccc},\n\t{0x99,   0x65,    0x20,       0x00,     0x00,        0xff,     0xb3, 0x70,     0x70,     0xcccc,  0xcccc},\n\t{0x82,   0x4d,    0x20,       0x00,     0x00,        0xff,     0xb3, 0x70,     0x70,     0xcccc,  0xcccc},\n};\n\nstatic const struct abm_parameters abm_settings_config2[abm_defines_max_level] = {\n\n\t{0xf0,   0xbf,    0x20,       0x00,     0x88,        0x99,     0xb3, 0x40,     0xe0,    0x0000,  0xcccc},\n\t{0xd8,   0x85,    0x20,       0x00,     0x70,        0x90,     0xa8, 0x40,     0xc8,    0x0700,  0xb333},\n\t{0xb8,   0x58,    0x20,       0x00,     0x64,        0x88,     0x78, 0x70,     0xa0,    0x7000,  0x9999},\n\t{0x82,   0x40,    0x20,       0x00,     0x00,        0xb8,     0xb3, 0x70,     0x70,    0xc333,  0xb333},\n};\n\nstatic const struct abm_parameters * const abm_settings[] = {\n\tabm_settings_config0,\n\tabm_settings_config1,\n\tabm_settings_config2,\n};\n\nstatic const struct dm_bl_data_point custom_backlight_curve0[] = {\n\t\t{2, 14}, {4, 16}, {6, 18}, {8, 21}, {10, 23}, {12, 26}, {14, 29}, {16, 32}, {18, 35},\n\t\t{20, 38}, {22, 41}, {24, 44}, {26, 48}, {28, 52}, {30, 55}, {32, 59}, {34, 62},\n\t\t{36, 67}, {38, 71}, {40, 75}, {42, 80}, {44, 84}, {46, 88}, {48, 93}, {50, 98},\n\t\t{52, 103}, {54, 108}, {56, 113}, {58, 118}, {60, 123}, {62, 129}, {64, 135}, {66, 140},\n\t\t{68, 146}, {70, 152}, {72, 158}, {74, 164}, {76, 171}, {78, 177}, {80, 183}, {82, 190},\n\t\t{84, 197}, {86, 204}, {88, 211}, {90, 218}, {92, 225}, {94, 232}, {96, 240}, {98, 247}};\n\nstruct custom_backlight_profile {\n\tuint8_t  ac_level_percentage;\n\tuint8_t  dc_level_percentage;\n\tuint8_t  min_input_signal;\n\tuint8_t  max_input_signal;\n\tuint8_t  num_data_points;\n\tconst struct dm_bl_data_point *data_points;\n};\n\nstatic const struct custom_backlight_profile custom_backlight_profiles[] = {\n\t\t{100, 32, 12, 255, ARRAY_SIZE(custom_backlight_curve0), custom_backlight_curve0},\n};\n\n#define NUM_AMBI_LEVEL    5\n#define NUM_AGGR_LEVEL    4\n#define NUM_POWER_FN_SEGS 8\n#define NUM_BL_CURVE_SEGS 16\n#define IRAM_SIZE 256\n\n#define IRAM_RESERVE_AREA_START_V2 0xF0  \n#define IRAM_RESERVE_AREA_END_V2 0xF6  \n\n#define IRAM_RESERVE_AREA_START_V2_2 0xF0  \n#define IRAM_RESERVE_AREA_END_V2_2 0xFF  \n\n#pragma pack(push, 1)\n \nstruct iram_table_v_2 {\n\t \n\tuint16_t min_abm_backlight;\t\t\t\t\t \n\n\t \n\tuint8_t min_reduction[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t\t \n\tuint8_t max_reduction[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t\t \n\tuint8_t bright_pos_gain[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t \n\tuint8_t bright_neg_gain[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t \n\tuint8_t dark_pos_gain[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t\t \n\tuint8_t dark_neg_gain[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t\t \n\tuint8_t iir_curve[NUM_AMBI_LEVEL];\t\t\t\t \n\tuint8_t deviation_gain;\t\t\t\t\t\t \n\n\t \n\tuint16_t crgb_thresh[NUM_POWER_FN_SEGS];\t\t\t \n\tuint16_t crgb_offset[NUM_POWER_FN_SEGS];\t\t\t \n\tuint16_t crgb_slope[NUM_POWER_FN_SEGS];\t\t\t\t \n\n\t \n\t \n\tuint16_t backlight_thresholds[NUM_BL_CURVE_SEGS];\t\t \n\t \n\tuint16_t backlight_offsets[NUM_BL_CURVE_SEGS];\t\t\t \n\n\t \n\tuint8_t psr_state;\t\t\t\t\t\t \n\tuint8_t dmcu_mcp_interface_version;\t\t\t\t \n\tuint8_t dmcu_abm_feature_version;\t\t\t\t \n\tuint8_t dmcu_psr_feature_version;\t\t\t\t \n\tuint16_t dmcu_version;\t\t\t\t\t\t \n\tuint8_t dmcu_state;\t\t\t\t\t\t \n\n\tuint16_t blRampReduction;\t\t\t\t\t \n\tuint16_t blRampStart;\t\t\t\t\t\t \n\tuint8_t dummy5;\t\t\t\t\t\t\t \n\tuint8_t dummy6;\t\t\t\t\t\t\t \n\tuint8_t dummy7;\t\t\t\t\t\t\t \n\tuint8_t dummy8;\t\t\t\t\t\t\t \n\tuint8_t dummy9;\t\t\t\t\t\t\t \n};\n\nstruct iram_table_v_2_2 {\n\t \n\tuint16_t flags;\t\t\t\t\t\t\t \n\n\t \n\tuint8_t min_reduction[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t\t \n\tuint8_t max_reduction[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t\t \n\tuint8_t bright_pos_gain[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t \n\tuint8_t dark_pos_gain[NUM_AMBI_LEVEL][NUM_AGGR_LEVEL];\t\t \n\tuint8_t hybrid_factor[NUM_AGGR_LEVEL];\t\t\t\t \n\tuint8_t contrast_factor[NUM_AGGR_LEVEL];\t\t\t \n\tuint8_t deviation_gain[NUM_AGGR_LEVEL];\t\t\t\t \n\tuint8_t iir_curve[NUM_AMBI_LEVEL];\t\t\t\t \n\tuint8_t min_knee[NUM_AGGR_LEVEL];\t\t\t\t \n\tuint8_t max_knee[NUM_AGGR_LEVEL];\t\t\t\t \n\tuint16_t min_abm_backlight;\t\t\t\t\t \n\tuint8_t pad[19];\t\t\t\t\t\t \n\n\t \n\tuint16_t crgb_thresh[NUM_POWER_FN_SEGS];\t\t\t \n\tuint16_t crgb_offset[NUM_POWER_FN_SEGS];\t\t\t \n\tuint16_t crgb_slope[NUM_POWER_FN_SEGS];\t\t\t\t \n\n\t \n\t \n\tuint16_t backlight_thresholds[NUM_BL_CURVE_SEGS];\t\t \n\t \n\tuint16_t backlight_offsets[NUM_BL_CURVE_SEGS];\t\t\t \n\n\t \n\tuint8_t psr_state;\t\t\t\t\t\t \n\tuint8_t dmcu_mcp_interface_version;\t\t\t\t \n\tuint8_t dmcu_abm_feature_version;\t\t\t\t \n\tuint8_t dmcu_psr_feature_version;\t\t\t\t \n\tuint16_t dmcu_version;\t\t\t\t\t\t \n\tuint8_t dmcu_state;\t\t\t\t\t\t \n\n\tuint8_t dummy1;\t\t\t\t\t\t\t \n\tuint8_t dummy2;\t\t\t\t\t\t\t \n\tuint8_t dummy3;\t\t\t\t\t\t\t \n\tuint8_t dummy4;\t\t\t\t\t\t\t \n\tuint8_t dummy5;\t\t\t\t\t\t\t \n\tuint8_t dummy6;\t\t\t\t\t\t\t \n\tuint8_t dummy7;\t\t\t\t\t\t\t \n\tuint8_t dummy8;\t\t\t\t\t\t\t \n\tuint8_t dummy9;\t\t\t\t\t\t\t \n};\n#pragma pack(pop)\n\nstatic void fill_backlight_transform_table(struct dmcu_iram_parameters params,\n\t\tstruct iram_table_v_2 *table)\n{\n\tunsigned int i;\n\tunsigned int num_entries = NUM_BL_CURVE_SEGS;\n\tunsigned int lut_index;\n\n\ttable->backlight_thresholds[0] = 0;\n\ttable->backlight_offsets[0] = params.backlight_lut_array[0];\n\ttable->backlight_thresholds[num_entries-1] = 0xFFFF;\n\ttable->backlight_offsets[num_entries-1] =\n\t\tparams.backlight_lut_array[params.backlight_lut_array_size - 1];\n\n\t \n\tfor (i = 1; i+1 < num_entries; i++) {\n\t\tlut_index = (params.backlight_lut_array_size - 1) * i / (num_entries - 1);\n\t\tASSERT(lut_index < params.backlight_lut_array_size);\n\n\t\ttable->backlight_thresholds[i] =\n\t\t\tcpu_to_be16(DIV_ROUNDUP((i * 65536), num_entries));\n\t\ttable->backlight_offsets[i] =\n\t\t\tcpu_to_be16(params.backlight_lut_array[lut_index]);\n\t}\n}\n\nstatic void fill_backlight_transform_table_v_2_2(struct dmcu_iram_parameters params,\n\t\tstruct iram_table_v_2_2 *table, bool big_endian)\n{\n\tunsigned int i;\n\tunsigned int num_entries = NUM_BL_CURVE_SEGS;\n\tunsigned int lut_index;\n\n\ttable->backlight_thresholds[0] = 0;\n\ttable->backlight_offsets[0] = params.backlight_lut_array[0];\n\ttable->backlight_thresholds[num_entries-1] = 0xFFFF;\n\ttable->backlight_offsets[num_entries-1] =\n\t\tparams.backlight_lut_array[params.backlight_lut_array_size - 1];\n\n\t \n\tfor (i = 1; i+1 < num_entries; i++) {\n\t\tlut_index = DIV_ROUNDUP((i * params.backlight_lut_array_size), num_entries);\n\t\tASSERT(lut_index < params.backlight_lut_array_size);\n\n\t\ttable->backlight_thresholds[i] = (big_endian) ?\n\t\t\tcpu_to_be16(DIV_ROUNDUP((i * 65536), num_entries)) :\n\t\t\tcpu_to_le16(DIV_ROUNDUP((i * 65536), num_entries));\n\t\ttable->backlight_offsets[i] = (big_endian) ?\n\t\t\tcpu_to_be16(params.backlight_lut_array[lut_index]) :\n\t\t\tcpu_to_le16(params.backlight_lut_array[lut_index]);\n\t}\n}\n\nstatic void fill_iram_v_2(struct iram_table_v_2 *ram_table, struct dmcu_iram_parameters params)\n{\n\tunsigned int set = params.set;\n\n\tram_table->min_abm_backlight =\n\t\t\tcpu_to_be16(params.min_abm_backlight);\n\tram_table->deviation_gain = 0xb3;\n\n\tram_table->blRampReduction =\n\t\tcpu_to_be16(params.backlight_ramping_reduction);\n\tram_table->blRampStart =\n\t\tcpu_to_be16(params.backlight_ramping_start);\n\n\tram_table->min_reduction[0][0] = min_reduction_table[abm_config[set][0]];\n\tram_table->min_reduction[1][0] = min_reduction_table[abm_config[set][0]];\n\tram_table->min_reduction[2][0] = min_reduction_table[abm_config[set][0]];\n\tram_table->min_reduction[3][0] = min_reduction_table[abm_config[set][0]];\n\tram_table->min_reduction[4][0] = min_reduction_table[abm_config[set][0]];\n\tram_table->max_reduction[0][0] = max_reduction_table[abm_config[set][0]];\n\tram_table->max_reduction[1][0] = max_reduction_table[abm_config[set][0]];\n\tram_table->max_reduction[2][0] = max_reduction_table[abm_config[set][0]];\n\tram_table->max_reduction[3][0] = max_reduction_table[abm_config[set][0]];\n\tram_table->max_reduction[4][0] = max_reduction_table[abm_config[set][0]];\n\n\tram_table->min_reduction[0][1] = min_reduction_table[abm_config[set][1]];\n\tram_table->min_reduction[1][1] = min_reduction_table[abm_config[set][1]];\n\tram_table->min_reduction[2][1] = min_reduction_table[abm_config[set][1]];\n\tram_table->min_reduction[3][1] = min_reduction_table[abm_config[set][1]];\n\tram_table->min_reduction[4][1] = min_reduction_table[abm_config[set][1]];\n\tram_table->max_reduction[0][1] = max_reduction_table[abm_config[set][1]];\n\tram_table->max_reduction[1][1] = max_reduction_table[abm_config[set][1]];\n\tram_table->max_reduction[2][1] = max_reduction_table[abm_config[set][1]];\n\tram_table->max_reduction[3][1] = max_reduction_table[abm_config[set][1]];\n\tram_table->max_reduction[4][1] = max_reduction_table[abm_config[set][1]];\n\n\tram_table->min_reduction[0][2] = min_reduction_table[abm_config[set][2]];\n\tram_table->min_reduction[1][2] = min_reduction_table[abm_config[set][2]];\n\tram_table->min_reduction[2][2] = min_reduction_table[abm_config[set][2]];\n\tram_table->min_reduction[3][2] = min_reduction_table[abm_config[set][2]];\n\tram_table->min_reduction[4][2] = min_reduction_table[abm_config[set][2]];\n\tram_table->max_reduction[0][2] = max_reduction_table[abm_config[set][2]];\n\tram_table->max_reduction[1][2] = max_reduction_table[abm_config[set][2]];\n\tram_table->max_reduction[2][2] = max_reduction_table[abm_config[set][2]];\n\tram_table->max_reduction[3][2] = max_reduction_table[abm_config[set][2]];\n\tram_table->max_reduction[4][2] = max_reduction_table[abm_config[set][2]];\n\n\tram_table->min_reduction[0][3] = min_reduction_table[abm_config[set][3]];\n\tram_table->min_reduction[1][3] = min_reduction_table[abm_config[set][3]];\n\tram_table->min_reduction[2][3] = min_reduction_table[abm_config[set][3]];\n\tram_table->min_reduction[3][3] = min_reduction_table[abm_config[set][3]];\n\tram_table->min_reduction[4][3] = min_reduction_table[abm_config[set][3]];\n\tram_table->max_reduction[0][3] = max_reduction_table[abm_config[set][3]];\n\tram_table->max_reduction[1][3] = max_reduction_table[abm_config[set][3]];\n\tram_table->max_reduction[2][3] = max_reduction_table[abm_config[set][3]];\n\tram_table->max_reduction[3][3] = max_reduction_table[abm_config[set][3]];\n\tram_table->max_reduction[4][3] = max_reduction_table[abm_config[set][3]];\n\n\tram_table->bright_pos_gain[0][0] = 0x20;\n\tram_table->bright_pos_gain[0][1] = 0x20;\n\tram_table->bright_pos_gain[0][2] = 0x20;\n\tram_table->bright_pos_gain[0][3] = 0x20;\n\tram_table->bright_pos_gain[1][0] = 0x20;\n\tram_table->bright_pos_gain[1][1] = 0x20;\n\tram_table->bright_pos_gain[1][2] = 0x20;\n\tram_table->bright_pos_gain[1][3] = 0x20;\n\tram_table->bright_pos_gain[2][0] = 0x20;\n\tram_table->bright_pos_gain[2][1] = 0x20;\n\tram_table->bright_pos_gain[2][2] = 0x20;\n\tram_table->bright_pos_gain[2][3] = 0x20;\n\tram_table->bright_pos_gain[3][0] = 0x20;\n\tram_table->bright_pos_gain[3][1] = 0x20;\n\tram_table->bright_pos_gain[3][2] = 0x20;\n\tram_table->bright_pos_gain[3][3] = 0x20;\n\tram_table->bright_pos_gain[4][0] = 0x20;\n\tram_table->bright_pos_gain[4][1] = 0x20;\n\tram_table->bright_pos_gain[4][2] = 0x20;\n\tram_table->bright_pos_gain[4][3] = 0x20;\n\tram_table->bright_neg_gain[0][0] = 0x00;\n\tram_table->bright_neg_gain[0][1] = 0x00;\n\tram_table->bright_neg_gain[0][2] = 0x00;\n\tram_table->bright_neg_gain[0][3] = 0x00;\n\tram_table->bright_neg_gain[1][0] = 0x00;\n\tram_table->bright_neg_gain[1][1] = 0x00;\n\tram_table->bright_neg_gain[1][2] = 0x00;\n\tram_table->bright_neg_gain[1][3] = 0x00;\n\tram_table->bright_neg_gain[2][0] = 0x00;\n\tram_table->bright_neg_gain[2][1] = 0x00;\n\tram_table->bright_neg_gain[2][2] = 0x00;\n\tram_table->bright_neg_gain[2][3] = 0x00;\n\tram_table->bright_neg_gain[3][0] = 0x00;\n\tram_table->bright_neg_gain[3][1] = 0x00;\n\tram_table->bright_neg_gain[3][2] = 0x00;\n\tram_table->bright_neg_gain[3][3] = 0x00;\n\tram_table->bright_neg_gain[4][0] = 0x00;\n\tram_table->bright_neg_gain[4][1] = 0x00;\n\tram_table->bright_neg_gain[4][2] = 0x00;\n\tram_table->bright_neg_gain[4][3] = 0x00;\n\tram_table->dark_pos_gain[0][0] = 0x00;\n\tram_table->dark_pos_gain[0][1] = 0x00;\n\tram_table->dark_pos_gain[0][2] = 0x00;\n\tram_table->dark_pos_gain[0][3] = 0x00;\n\tram_table->dark_pos_gain[1][0] = 0x00;\n\tram_table->dark_pos_gain[1][1] = 0x00;\n\tram_table->dark_pos_gain[1][2] = 0x00;\n\tram_table->dark_pos_gain[1][3] = 0x00;\n\tram_table->dark_pos_gain[2][0] = 0x00;\n\tram_table->dark_pos_gain[2][1] = 0x00;\n\tram_table->dark_pos_gain[2][2] = 0x00;\n\tram_table->dark_pos_gain[2][3] = 0x00;\n\tram_table->dark_pos_gain[3][0] = 0x00;\n\tram_table->dark_pos_gain[3][1] = 0x00;\n\tram_table->dark_pos_gain[3][2] = 0x00;\n\tram_table->dark_pos_gain[3][3] = 0x00;\n\tram_table->dark_pos_gain[4][0] = 0x00;\n\tram_table->dark_pos_gain[4][1] = 0x00;\n\tram_table->dark_pos_gain[4][2] = 0x00;\n\tram_table->dark_pos_gain[4][3] = 0x00;\n\tram_table->dark_neg_gain[0][0] = 0x00;\n\tram_table->dark_neg_gain[0][1] = 0x00;\n\tram_table->dark_neg_gain[0][2] = 0x00;\n\tram_table->dark_neg_gain[0][3] = 0x00;\n\tram_table->dark_neg_gain[1][0] = 0x00;\n\tram_table->dark_neg_gain[1][1] = 0x00;\n\tram_table->dark_neg_gain[1][2] = 0x00;\n\tram_table->dark_neg_gain[1][3] = 0x00;\n\tram_table->dark_neg_gain[2][0] = 0x00;\n\tram_table->dark_neg_gain[2][1] = 0x00;\n\tram_table->dark_neg_gain[2][2] = 0x00;\n\tram_table->dark_neg_gain[2][3] = 0x00;\n\tram_table->dark_neg_gain[3][0] = 0x00;\n\tram_table->dark_neg_gain[3][1] = 0x00;\n\tram_table->dark_neg_gain[3][2] = 0x00;\n\tram_table->dark_neg_gain[3][3] = 0x00;\n\tram_table->dark_neg_gain[4][0] = 0x00;\n\tram_table->dark_neg_gain[4][1] = 0x00;\n\tram_table->dark_neg_gain[4][2] = 0x00;\n\tram_table->dark_neg_gain[4][3] = 0x00;\n\n\tram_table->iir_curve[0] = 0x65;\n\tram_table->iir_curve[1] = 0x65;\n\tram_table->iir_curve[2] = 0x65;\n\tram_table->iir_curve[3] = 0x65;\n\tram_table->iir_curve[4] = 0x65;\n\n\t\n\tram_table->crgb_thresh[0] = cpu_to_be16(0x13b6);\n\tram_table->crgb_thresh[1] = cpu_to_be16(0x1648);\n\tram_table->crgb_thresh[2] = cpu_to_be16(0x18e3);\n\tram_table->crgb_thresh[3] = cpu_to_be16(0x1b41);\n\tram_table->crgb_thresh[4] = cpu_to_be16(0x1d46);\n\tram_table->crgb_thresh[5] = cpu_to_be16(0x1f21);\n\tram_table->crgb_thresh[6] = cpu_to_be16(0x2167);\n\tram_table->crgb_thresh[7] = cpu_to_be16(0x2384);\n\tram_table->crgb_offset[0] = cpu_to_be16(0x2999);\n\tram_table->crgb_offset[1] = cpu_to_be16(0x3999);\n\tram_table->crgb_offset[2] = cpu_to_be16(0x4666);\n\tram_table->crgb_offset[3] = cpu_to_be16(0x5999);\n\tram_table->crgb_offset[4] = cpu_to_be16(0x6333);\n\tram_table->crgb_offset[5] = cpu_to_be16(0x7800);\n\tram_table->crgb_offset[6] = cpu_to_be16(0x8c00);\n\tram_table->crgb_offset[7] = cpu_to_be16(0xa000);\n\tram_table->crgb_slope[0]  = cpu_to_be16(0x3147);\n\tram_table->crgb_slope[1]  = cpu_to_be16(0x2978);\n\tram_table->crgb_slope[2]  = cpu_to_be16(0x23a2);\n\tram_table->crgb_slope[3]  = cpu_to_be16(0x1f55);\n\tram_table->crgb_slope[4]  = cpu_to_be16(0x1c63);\n\tram_table->crgb_slope[5]  = cpu_to_be16(0x1a0f);\n\tram_table->crgb_slope[6]  = cpu_to_be16(0x178d);\n\tram_table->crgb_slope[7]  = cpu_to_be16(0x15ab);\n\n\tfill_backlight_transform_table(\n\t\t\tparams, ram_table);\n}\n\nstatic void fill_iram_v_2_2(struct iram_table_v_2_2 *ram_table, struct dmcu_iram_parameters params)\n{\n\tunsigned int set = params.set;\n\n\tram_table->flags = 0x0;\n\n\tram_table->min_abm_backlight =\n\t\t\tcpu_to_be16(params.min_abm_backlight);\n\n\tram_table->deviation_gain[0] = 0xb3;\n\tram_table->deviation_gain[1] = 0xa8;\n\tram_table->deviation_gain[2] = 0x98;\n\tram_table->deviation_gain[3] = 0x68;\n\n\tram_table->min_reduction[0][0] = min_reduction_table_v_2_2[abm_config[set][0]];\n\tram_table->min_reduction[1][0] = min_reduction_table_v_2_2[abm_config[set][0]];\n\tram_table->min_reduction[2][0] = min_reduction_table_v_2_2[abm_config[set][0]];\n\tram_table->min_reduction[3][0] = min_reduction_table_v_2_2[abm_config[set][0]];\n\tram_table->min_reduction[4][0] = min_reduction_table_v_2_2[abm_config[set][0]];\n\tram_table->max_reduction[0][0] = max_reduction_table_v_2_2[abm_config[set][0]];\n\tram_table->max_reduction[1][0] = max_reduction_table_v_2_2[abm_config[set][0]];\n\tram_table->max_reduction[2][0] = max_reduction_table_v_2_2[abm_config[set][0]];\n\tram_table->max_reduction[3][0] = max_reduction_table_v_2_2[abm_config[set][0]];\n\tram_table->max_reduction[4][0] = max_reduction_table_v_2_2[abm_config[set][0]];\n\n\tram_table->min_reduction[0][1] = min_reduction_table_v_2_2[abm_config[set][1]];\n\tram_table->min_reduction[1][1] = min_reduction_table_v_2_2[abm_config[set][1]];\n\tram_table->min_reduction[2][1] = min_reduction_table_v_2_2[abm_config[set][1]];\n\tram_table->min_reduction[3][1] = min_reduction_table_v_2_2[abm_config[set][1]];\n\tram_table->min_reduction[4][1] = min_reduction_table_v_2_2[abm_config[set][1]];\n\tram_table->max_reduction[0][1] = max_reduction_table_v_2_2[abm_config[set][1]];\n\tram_table->max_reduction[1][1] = max_reduction_table_v_2_2[abm_config[set][1]];\n\tram_table->max_reduction[2][1] = max_reduction_table_v_2_2[abm_config[set][1]];\n\tram_table->max_reduction[3][1] = max_reduction_table_v_2_2[abm_config[set][1]];\n\tram_table->max_reduction[4][1] = max_reduction_table_v_2_2[abm_config[set][1]];\n\n\tram_table->min_reduction[0][2] = min_reduction_table_v_2_2[abm_config[set][2]];\n\tram_table->min_reduction[1][2] = min_reduction_table_v_2_2[abm_config[set][2]];\n\tram_table->min_reduction[2][2] = min_reduction_table_v_2_2[abm_config[set][2]];\n\tram_table->min_reduction[3][2] = min_reduction_table_v_2_2[abm_config[set][2]];\n\tram_table->min_reduction[4][2] = min_reduction_table_v_2_2[abm_config[set][2]];\n\tram_table->max_reduction[0][2] = max_reduction_table_v_2_2[abm_config[set][2]];\n\tram_table->max_reduction[1][2] = max_reduction_table_v_2_2[abm_config[set][2]];\n\tram_table->max_reduction[2][2] = max_reduction_table_v_2_2[abm_config[set][2]];\n\tram_table->max_reduction[3][2] = max_reduction_table_v_2_2[abm_config[set][2]];\n\tram_table->max_reduction[4][2] = max_reduction_table_v_2_2[abm_config[set][2]];\n\n\tram_table->min_reduction[0][3] = min_reduction_table_v_2_2[abm_config[set][3]];\n\tram_table->min_reduction[1][3] = min_reduction_table_v_2_2[abm_config[set][3]];\n\tram_table->min_reduction[2][3] = min_reduction_table_v_2_2[abm_config[set][3]];\n\tram_table->min_reduction[3][3] = min_reduction_table_v_2_2[abm_config[set][3]];\n\tram_table->min_reduction[4][3] = min_reduction_table_v_2_2[abm_config[set][3]];\n\tram_table->max_reduction[0][3] = max_reduction_table_v_2_2[abm_config[set][3]];\n\tram_table->max_reduction[1][3] = max_reduction_table_v_2_2[abm_config[set][3]];\n\tram_table->max_reduction[2][3] = max_reduction_table_v_2_2[abm_config[set][3]];\n\tram_table->max_reduction[3][3] = max_reduction_table_v_2_2[abm_config[set][3]];\n\tram_table->max_reduction[4][3] = max_reduction_table_v_2_2[abm_config[set][3]];\n\n\tram_table->bright_pos_gain[0][0] = 0x20;\n\tram_table->bright_pos_gain[0][1] = 0x20;\n\tram_table->bright_pos_gain[0][2] = 0x20;\n\tram_table->bright_pos_gain[0][3] = 0x20;\n\tram_table->bright_pos_gain[1][0] = 0x20;\n\tram_table->bright_pos_gain[1][1] = 0x20;\n\tram_table->bright_pos_gain[1][2] = 0x20;\n\tram_table->bright_pos_gain[1][3] = 0x20;\n\tram_table->bright_pos_gain[2][0] = 0x20;\n\tram_table->bright_pos_gain[2][1] = 0x20;\n\tram_table->bright_pos_gain[2][2] = 0x20;\n\tram_table->bright_pos_gain[2][3] = 0x20;\n\tram_table->bright_pos_gain[3][0] = 0x20;\n\tram_table->bright_pos_gain[3][1] = 0x20;\n\tram_table->bright_pos_gain[3][2] = 0x20;\n\tram_table->bright_pos_gain[3][3] = 0x20;\n\tram_table->bright_pos_gain[4][0] = 0x20;\n\tram_table->bright_pos_gain[4][1] = 0x20;\n\tram_table->bright_pos_gain[4][2] = 0x20;\n\tram_table->bright_pos_gain[4][3] = 0x20;\n\n\tram_table->dark_pos_gain[0][0] = 0x00;\n\tram_table->dark_pos_gain[0][1] = 0x00;\n\tram_table->dark_pos_gain[0][2] = 0x00;\n\tram_table->dark_pos_gain[0][3] = 0x00;\n\tram_table->dark_pos_gain[1][0] = 0x00;\n\tram_table->dark_pos_gain[1][1] = 0x00;\n\tram_table->dark_pos_gain[1][2] = 0x00;\n\tram_table->dark_pos_gain[1][3] = 0x00;\n\tram_table->dark_pos_gain[2][0] = 0x00;\n\tram_table->dark_pos_gain[2][1] = 0x00;\n\tram_table->dark_pos_gain[2][2] = 0x00;\n\tram_table->dark_pos_gain[2][3] = 0x00;\n\tram_table->dark_pos_gain[3][0] = 0x00;\n\tram_table->dark_pos_gain[3][1] = 0x00;\n\tram_table->dark_pos_gain[3][2] = 0x00;\n\tram_table->dark_pos_gain[3][3] = 0x00;\n\tram_table->dark_pos_gain[4][0] = 0x00;\n\tram_table->dark_pos_gain[4][1] = 0x00;\n\tram_table->dark_pos_gain[4][2] = 0x00;\n\tram_table->dark_pos_gain[4][3] = 0x00;\n\n\tram_table->hybrid_factor[0] = 0xff;\n\tram_table->hybrid_factor[1] = 0xff;\n\tram_table->hybrid_factor[2] = 0xff;\n\tram_table->hybrid_factor[3] = 0xc0;\n\n\tram_table->contrast_factor[0] = 0x99;\n\tram_table->contrast_factor[1] = 0x99;\n\tram_table->contrast_factor[2] = 0x90;\n\tram_table->contrast_factor[3] = 0x80;\n\n\tram_table->iir_curve[0] = 0x65;\n\tram_table->iir_curve[1] = 0x65;\n\tram_table->iir_curve[2] = 0x65;\n\tram_table->iir_curve[3] = 0x65;\n\tram_table->iir_curve[4] = 0x65;\n\n\t\n\tram_table->crgb_thresh[0] = cpu_to_be16(0x127c);\n\tram_table->crgb_thresh[1] = cpu_to_be16(0x151b);\n\tram_table->crgb_thresh[2] = cpu_to_be16(0x17d5);\n\tram_table->crgb_thresh[3] = cpu_to_be16(0x1a56);\n\tram_table->crgb_thresh[4] = cpu_to_be16(0x1c83);\n\tram_table->crgb_thresh[5] = cpu_to_be16(0x1e72);\n\tram_table->crgb_thresh[6] = cpu_to_be16(0x20f0);\n\tram_table->crgb_thresh[7] = cpu_to_be16(0x232b);\n\tram_table->crgb_offset[0] = cpu_to_be16(0x2999);\n\tram_table->crgb_offset[1] = cpu_to_be16(0x3999);\n\tram_table->crgb_offset[2] = cpu_to_be16(0x4666);\n\tram_table->crgb_offset[3] = cpu_to_be16(0x5999);\n\tram_table->crgb_offset[4] = cpu_to_be16(0x6333);\n\tram_table->crgb_offset[5] = cpu_to_be16(0x7800);\n\tram_table->crgb_offset[6] = cpu_to_be16(0x8c00);\n\tram_table->crgb_offset[7] = cpu_to_be16(0xa000);\n\tram_table->crgb_slope[0]  = cpu_to_be16(0x3609);\n\tram_table->crgb_slope[1]  = cpu_to_be16(0x2dfa);\n\tram_table->crgb_slope[2]  = cpu_to_be16(0x27ea);\n\tram_table->crgb_slope[3]  = cpu_to_be16(0x235d);\n\tram_table->crgb_slope[4]  = cpu_to_be16(0x2042);\n\tram_table->crgb_slope[5]  = cpu_to_be16(0x1dc3);\n\tram_table->crgb_slope[6]  = cpu_to_be16(0x1b1a);\n\tram_table->crgb_slope[7]  = cpu_to_be16(0x1910);\n\n\tfill_backlight_transform_table_v_2_2(\n\t\t\tparams, ram_table, true);\n}\n\nstatic void fill_iram_v_2_3(struct iram_table_v_2_2 *ram_table, struct dmcu_iram_parameters params, bool big_endian)\n{\n\tunsigned int i, j;\n\tunsigned int set = params.set;\n\n\tram_table->flags = 0x0;\n\tram_table->min_abm_backlight = (big_endian) ?\n\t\tcpu_to_be16(params.min_abm_backlight) :\n\t\tcpu_to_le16(params.min_abm_backlight);\n\n\tfor (i = 0; i < NUM_AGGR_LEVEL; i++) {\n\t\tram_table->hybrid_factor[i] = abm_settings[set][i].brightness_gain;\n\t\tram_table->contrast_factor[i] = abm_settings[set][i].contrast_factor;\n\t\tram_table->deviation_gain[i] = abm_settings[set][i].deviation_gain;\n\t\tram_table->min_knee[i] = abm_settings[set][i].min_knee;\n\t\tram_table->max_knee[i] = abm_settings[set][i].max_knee;\n\n\t\tfor (j = 0; j < NUM_AMBI_LEVEL; j++) {\n\t\t\tram_table->min_reduction[j][i] = abm_settings[set][i].min_reduction;\n\t\t\tram_table->max_reduction[j][i] = abm_settings[set][i].max_reduction;\n\t\t\tram_table->bright_pos_gain[j][i] = abm_settings[set][i].bright_pos_gain;\n\t\t\tram_table->dark_pos_gain[j][i] = abm_settings[set][i].dark_pos_gain;\n\t\t}\n\t}\n\n\tram_table->iir_curve[0] = 0x65;\n\tram_table->iir_curve[1] = 0x65;\n\tram_table->iir_curve[2] = 0x65;\n\tram_table->iir_curve[3] = 0x65;\n\tram_table->iir_curve[4] = 0x65;\n\n\t\n\tram_table->crgb_thresh[0] = bswap16_based_on_endian(big_endian, 0x127c);\n\tram_table->crgb_thresh[1] = bswap16_based_on_endian(big_endian, 0x151b);\n\tram_table->crgb_thresh[2] = bswap16_based_on_endian(big_endian, 0x17d5);\n\tram_table->crgb_thresh[3] = bswap16_based_on_endian(big_endian, 0x1a56);\n\tram_table->crgb_thresh[4] = bswap16_based_on_endian(big_endian, 0x1c83);\n\tram_table->crgb_thresh[5] = bswap16_based_on_endian(big_endian, 0x1e72);\n\tram_table->crgb_thresh[6] = bswap16_based_on_endian(big_endian, 0x20f0);\n\tram_table->crgb_thresh[7] = bswap16_based_on_endian(big_endian, 0x232b);\n\tram_table->crgb_offset[0] = bswap16_based_on_endian(big_endian, 0x2999);\n\tram_table->crgb_offset[1] = bswap16_based_on_endian(big_endian, 0x3999);\n\tram_table->crgb_offset[2] = bswap16_based_on_endian(big_endian, 0x4666);\n\tram_table->crgb_offset[3] = bswap16_based_on_endian(big_endian, 0x5999);\n\tram_table->crgb_offset[4] = bswap16_based_on_endian(big_endian, 0x6333);\n\tram_table->crgb_offset[5] = bswap16_based_on_endian(big_endian, 0x7800);\n\tram_table->crgb_offset[6] = bswap16_based_on_endian(big_endian, 0x8c00);\n\tram_table->crgb_offset[7] = bswap16_based_on_endian(big_endian, 0xa000);\n\tram_table->crgb_slope[0]  = bswap16_based_on_endian(big_endian, 0x3609);\n\tram_table->crgb_slope[1]  = bswap16_based_on_endian(big_endian, 0x2dfa);\n\tram_table->crgb_slope[2]  = bswap16_based_on_endian(big_endian, 0x27ea);\n\tram_table->crgb_slope[3]  = bswap16_based_on_endian(big_endian, 0x235d);\n\tram_table->crgb_slope[4]  = bswap16_based_on_endian(big_endian, 0x2042);\n\tram_table->crgb_slope[5]  = bswap16_based_on_endian(big_endian, 0x1dc3);\n\tram_table->crgb_slope[6]  = bswap16_based_on_endian(big_endian, 0x1b1a);\n\tram_table->crgb_slope[7]  = bswap16_based_on_endian(big_endian, 0x1910);\n\n\tfill_backlight_transform_table_v_2_2(\n\t\t\tparams, ram_table, big_endian);\n}\n\nbool dmub_init_abm_config(struct resource_pool *res_pool,\n\tstruct dmcu_iram_parameters params,\n\tunsigned int inst)\n{\n\tstruct iram_table_v_2_2 ram_table;\n\tstruct abm_config_table config;\n\tunsigned int set = params.set;\n\tbool result = false;\n\tuint32_t i, j = 0;\n\n\tif (res_pool->abm == NULL && res_pool->multiple_abms[inst] == NULL)\n\t\treturn false;\n\n\tmemset(&ram_table, 0, sizeof(ram_table));\n\tmemset(&config, 0, sizeof(config));\n\n\tfill_iram_v_2_3(&ram_table, params, false);\n\n\t\n\tfor (i = 0; i < NUM_POWER_FN_SEGS; i++) {\n\t\tconfig.crgb_thresh[i] = ram_table.crgb_thresh[i];\n\t\tconfig.crgb_offset[i] = ram_table.crgb_offset[i];\n\t\tconfig.crgb_slope[i] = ram_table.crgb_slope[i];\n\t}\n\n\tfor (i = 0; i < NUM_BL_CURVE_SEGS; i++) {\n\t\tconfig.backlight_thresholds[i] = ram_table.backlight_thresholds[i];\n\t\tconfig.backlight_offsets[i] = ram_table.backlight_offsets[i];\n\t}\n\n\tfor (i = 0; i < NUM_AMBI_LEVEL; i++)\n\t\tconfig.iir_curve[i] = ram_table.iir_curve[i];\n\n\tfor (i = 0; i < NUM_AMBI_LEVEL; i++) {\n\t\tfor (j = 0; j < NUM_AGGR_LEVEL; j++) {\n\t\t\tconfig.min_reduction[i][j] = ram_table.min_reduction[i][j];\n\t\t\tconfig.max_reduction[i][j] = ram_table.max_reduction[i][j];\n\t\t\tconfig.bright_pos_gain[i][j] = ram_table.bright_pos_gain[i][j];\n\t\t\tconfig.dark_pos_gain[i][j] = ram_table.dark_pos_gain[i][j];\n\t\t}\n\t}\n\n\tfor (i = 0; i < NUM_AGGR_LEVEL; i++) {\n\t\tconfig.hybrid_factor[i] = ram_table.hybrid_factor[i];\n\t\tconfig.contrast_factor[i] = ram_table.contrast_factor[i];\n\t\tconfig.deviation_gain[i] = ram_table.deviation_gain[i];\n\t\tconfig.min_knee[i] = ram_table.min_knee[i];\n\t\tconfig.max_knee[i] = ram_table.max_knee[i];\n\t}\n\n\tif (params.backlight_ramping_override) {\n\t\tfor (i = 0; i < NUM_AGGR_LEVEL; i++) {\n\t\t\tconfig.blRampReduction[i] = params.backlight_ramping_reduction;\n\t\t\tconfig.blRampStart[i] = params.backlight_ramping_start;\n\t\t\t}\n\t\t} else {\n\t\t\tfor (i = 0; i < NUM_AGGR_LEVEL; i++) {\n\t\t\t\tconfig.blRampReduction[i] = abm_settings[set][i].blRampReduction;\n\t\t\t\tconfig.blRampStart[i] = abm_settings[set][i].blRampStart;\n\t\t\t\t}\n\t\t\t}\n\n\tconfig.min_abm_backlight = ram_table.min_abm_backlight;\n\n\tif (res_pool->multiple_abms[inst]) {\n\t\tresult = res_pool->multiple_abms[inst]->funcs->init_abm_config(\n\t\t\tres_pool->multiple_abms[inst], (char *)(&config), sizeof(struct abm_config_table), inst);\n\t} else\n\t\tresult = res_pool->abm->funcs->init_abm_config(\n\t\t\tres_pool->abm, (char *)(&config), sizeof(struct abm_config_table), 0);\n\n\treturn result;\n}\n\nbool dmcu_load_iram(struct dmcu *dmcu,\n\tstruct dmcu_iram_parameters params)\n{\n\tunsigned char ram_table[IRAM_SIZE];\n\tbool result = false;\n\n\tif (dmcu == NULL)\n\t\treturn false;\n\n\tif (dmcu && !dmcu->funcs->is_dmcu_initialized(dmcu))\n\t\treturn true;\n\n\tmemset(&ram_table, 0, sizeof(ram_table));\n\n\tif (dmcu->dmcu_version.abm_version == 0x24) {\n\t\tfill_iram_v_2_3((struct iram_table_v_2_2 *)ram_table, params, true);\n\t\tresult = dmcu->funcs->load_iram(dmcu, 0, (char *)(&ram_table),\n\t\t\t\t\t\tIRAM_RESERVE_AREA_START_V2_2);\n\t} else if (dmcu->dmcu_version.abm_version == 0x23) {\n\t\tfill_iram_v_2_3((struct iram_table_v_2_2 *)ram_table, params, true);\n\n\t\tresult = dmcu->funcs->load_iram(\n\t\t\t\tdmcu, 0, (char *)(&ram_table), IRAM_RESERVE_AREA_START_V2_2);\n\t} else if (dmcu->dmcu_version.abm_version == 0x22) {\n\t\tfill_iram_v_2_2((struct iram_table_v_2_2 *)ram_table, params);\n\n\t\tresult = dmcu->funcs->load_iram(\n\t\t\t\tdmcu, 0, (char *)(&ram_table), IRAM_RESERVE_AREA_START_V2_2);\n\t} else {\n\t\tfill_iram_v_2((struct iram_table_v_2 *)ram_table, params);\n\n\t\tresult = dmcu->funcs->load_iram(\n\t\t\t\tdmcu, 0, (char *)(&ram_table), IRAM_RESERVE_AREA_START_V2);\n\n\t\tif (result)\n\t\t\tresult = dmcu->funcs->load_iram(\n\t\t\t\t\tdmcu, IRAM_RESERVE_AREA_END_V2 + 1,\n\t\t\t\t\t(char *)(&ram_table) + IRAM_RESERVE_AREA_END_V2 + 1,\n\t\t\t\t\tsizeof(ram_table) - IRAM_RESERVE_AREA_END_V2 - 1);\n\t}\n\n\treturn result;\n}\n\n \nbool is_psr_su_specific_panel(struct dc_link *link)\n{\n\tbool isPSRSUSupported = false;\n\tstruct dpcd_caps *dpcd_caps = &link->dpcd_caps;\n\n\tif (dpcd_caps->edp_rev >= DP_EDP_14) {\n\t\tif (dpcd_caps->psr_info.psr_version >= DP_PSR2_WITH_Y_COORD_ET_SUPPORTED)\n\t\t\tisPSRSUSupported = true;\n\t\t \n\t\tif (dpcd_caps->sink_dev_id == DP_BRANCH_DEVICE_ID_001CF8) {\n\t\t\t \n\t\t\tif (dpcd_caps->psr_info.psr_version < DP_PSR2_WITH_Y_COORD_IS_SUPPORTED)\n\t\t\t\tisPSRSUSupported = false;\n\t\t\telse if (dpcd_caps->dsc_caps.dsc_basic_caps.fields.dsc_support.DSC_SUPPORT &&\n\t\t\t\t((dpcd_caps->sink_dev_id_str[1] == 0x08 && dpcd_caps->sink_dev_id_str[0] == 0x08) ||\n\t\t\t\t(dpcd_caps->sink_dev_id_str[1] == 0x08 && dpcd_caps->sink_dev_id_str[0] == 0x07)))\n\t\t\t\tisPSRSUSupported = false;\n\t\t\telse if (dpcd_caps->sink_dev_id_str[1] == 0x08 && dpcd_caps->sink_dev_id_str[0] == 0x03)\n\t\t\t\tisPSRSUSupported = false;\n\t\t\telse if (dpcd_caps->psr_info.force_psrsu_cap == 0x1)\n\t\t\t\tisPSRSUSupported = true;\n\t\t}\n\t}\n\n\treturn isPSRSUSupported;\n}\n\n \nvoid mod_power_calc_psr_configs(struct psr_config *psr_config,\n\t\tstruct dc_link *link,\n\t\tconst struct dc_stream_state *stream)\n{\n\tunsigned int num_vblank_lines = 0;\n\tunsigned int vblank_time_in_us = 0;\n\tunsigned int sdp_tx_deadline_in_us = 0;\n\tunsigned int line_time_in_us = 0;\n\tstruct dpcd_caps *dpcd_caps = &link->dpcd_caps;\n\tconst int psr_setup_time_step_in_us = 55;\t \n\n\t \n\tnum_vblank_lines = stream->timing.v_total -\n\t\t\t stream->timing.v_addressable -\n\t\t\t stream->timing.v_border_top -\n\t\t\t stream->timing.v_border_bottom;\n\n\tvblank_time_in_us = (stream->timing.h_total * num_vblank_lines * 1000) / (stream->timing.pix_clk_100hz / 10);\n\n\tline_time_in_us = ((stream->timing.h_total * 1000) / (stream->timing.pix_clk_100hz / 10)) + 1;\n\n\t \n\tpsr_config->psr_rfb_setup_time =\n\t\t(6 - dpcd_caps->psr_info.psr_dpcd_caps.bits.PSR_SETUP_TIME) * psr_setup_time_step_in_us;\n\n\tif (psr_config->psr_rfb_setup_time > vblank_time_in_us) {\n\t\tlink->psr_settings.psr_frame_capture_indication_req = true;\n\t\tlink->psr_settings.psr_sdp_transmit_line_num_deadline = num_vblank_lines;\n\t} else {\n\t\tsdp_tx_deadline_in_us = vblank_time_in_us - psr_config->psr_rfb_setup_time;\n\n\t\t \n\t\tlink->psr_settings.psr_frame_capture_indication_req = false;\n\t\tlink->psr_settings.psr_sdp_transmit_line_num_deadline = sdp_tx_deadline_in_us / line_time_in_us;\n\t}\n\n\tpsr_config->psr_sdp_transmit_line_num_deadline = link->psr_settings.psr_sdp_transmit_line_num_deadline;\n\tpsr_config->line_time_in_us = line_time_in_us;\n\tpsr_config->su_y_granularity = dpcd_caps->psr_info.psr2_su_y_granularity_cap;\n\tpsr_config->su_granularity_required = dpcd_caps->psr_info.psr_dpcd_caps.bits.SU_GRANULARITY_REQUIRED;\n\tpsr_config->psr_frame_capture_indication_req = link->psr_settings.psr_frame_capture_indication_req;\n\tpsr_config->psr_exit_link_training_required =\n\t\t!link->dpcd_caps.psr_info.psr_dpcd_caps.bits.LINK_TRAINING_ON_EXIT_NOT_REQUIRED;\n}\n\nvoid init_replay_config(struct dc_link *link, struct replay_config *pr_config)\n{\n\tlink->replay_settings.config = *pr_config;\n}\n\nbool mod_power_only_edp(const struct dc_state *context, const struct dc_stream_state *stream)\n{\n\treturn context && context->stream_count == 1 && dc_is_embedded_signal(stream->signal);\n}\n\nbool psr_su_set_dsc_slice_height(struct dc *dc, struct dc_link *link,\n\t\t\t      struct dc_stream_state *stream,\n\t\t\t      struct psr_config *config)\n{\n\tuint16_t pic_height;\n\tuint16_t slice_height;\n\n\tconfig->dsc_slice_height = 0;\n\tif ((link->connector_signal & SIGNAL_TYPE_EDP) &&\n\t    (!dc->caps.edp_dsc_support ||\n\t    link->panel_config.dsc.disable_dsc_edp ||\n\t    !link->dpcd_caps.dsc_caps.dsc_basic_caps.fields.dsc_support.DSC_SUPPORT ||\n\t    !stream->timing.dsc_cfg.num_slices_v))\n\t\treturn true;\n\n\tpic_height = stream->timing.v_addressable +\n\t\tstream->timing.v_border_top + stream->timing.v_border_bottom;\n\n\tif (stream->timing.dsc_cfg.num_slices_v == 0)\n\t\treturn false;\n\n\tslice_height = pic_height / stream->timing.dsc_cfg.num_slices_v;\n\tconfig->dsc_slice_height = slice_height;\n\n\tif (slice_height) {\n\t\tif (config->su_y_granularity &&\n\t\t    (slice_height % config->su_y_granularity)) {\n\t\t\tASSERT(0);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\nbool fill_custom_backlight_caps(unsigned int config_no, struct dm_acpi_atif_backlight_caps *caps)\n{\n\tunsigned int data_points_size;\n\n\tif (config_no >= ARRAY_SIZE(custom_backlight_profiles))\n\t\treturn false;\n\n\tdata_points_size = custom_backlight_profiles[config_no].num_data_points\n\t\t\t* sizeof(custom_backlight_profiles[config_no].data_points[0]);\n\n\tcaps->size = sizeof(struct dm_acpi_atif_backlight_caps) - sizeof(caps->data_points) + data_points_size;\n\tcaps->flags = 0;\n\tcaps->error_code = 0;\n\tcaps->ac_level_percentage = custom_backlight_profiles[config_no].ac_level_percentage;\n\tcaps->dc_level_percentage = custom_backlight_profiles[config_no].dc_level_percentage;\n\tcaps->min_input_signal = custom_backlight_profiles[config_no].min_input_signal;\n\tcaps->max_input_signal = custom_backlight_profiles[config_no].max_input_signal;\n\tcaps->num_data_points = custom_backlight_profiles[config_no].num_data_points;\n\tmemcpy(caps->data_points, custom_backlight_profiles[config_no].data_points, data_points_size);\n\treturn true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}