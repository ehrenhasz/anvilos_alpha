{
  "module_name": "dcn20_fpu.c",
  "hash_id": "e81546421b54b84add8ff60117c5c263cd30dc364151905ee88e59b767b1400e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/dcn20/dcn20_fpu.c",
  "human_readable_source": "\n \n\n#include \"resource.h\"\n#include \"clk_mgr.h\"\n#include \"dchubbub.h\"\n#include \"dcn20/dcn20_resource.h\"\n#include \"dcn21/dcn21_resource.h\"\n#include \"clk_mgr/dcn21/rn_clk_mgr.h\"\n\n#include \"link.h\"\n#include \"dcn20_fpu.h\"\n\n#define DC_LOGGER_INIT(logger)\n\n#ifndef MAX\n#define MAX(X, Y) ((X) > (Y) ? (X) : (Y))\n#endif\n#ifndef MIN\n#define MIN(X, Y) ((X) < (Y) ? (X) : (Y))\n#endif\n\n \n#define LPDDR_MEM_RETRAIN_LATENCY 4.977  \n\n \n\nstruct _vcs_dpi_ip_params_st dcn2_0_ip = {\n\t.odm_capable = 1,\n\t.gpuvm_enable = 0,\n\t.hostvm_enable = 0,\n\t.gpuvm_max_page_table_levels = 4,\n\t.hostvm_max_page_table_levels = 4,\n\t.hostvm_cached_page_table_levels = 0,\n\t.pte_group_size_bytes = 2048,\n\t.num_dsc = 6,\n\t.rob_buffer_size_kbytes = 168,\n\t.det_buffer_size_kbytes = 164,\n\t.dpte_buffer_size_in_pte_reqs_luma = 84,\n\t.pde_proc_buffer_size_64k_reqs = 48,\n\t.dpp_output_buffer_pixels = 2560,\n\t.opp_output_buffer_lines = 1,\n\t.pixel_chunk_size_kbytes = 8,\n\t.pte_chunk_size_kbytes = 2,\n\t.meta_chunk_size_kbytes = 2,\n\t.writeback_chunk_size_kbytes = 2,\n\t.line_buffer_size_bits = 789504,\n\t.is_line_buffer_bpp_fixed = 0,\n\t.line_buffer_fixed_bpp = 0,\n\t.dcc_supported = true,\n\t.max_line_buffer_lines = 12,\n\t.writeback_luma_buffer_size_kbytes = 12,\n\t.writeback_chroma_buffer_size_kbytes = 8,\n\t.writeback_chroma_line_buffer_width_pixels = 4,\n\t.writeback_max_hscl_ratio = 1,\n\t.writeback_max_vscl_ratio = 1,\n\t.writeback_min_hscl_ratio = 1,\n\t.writeback_min_vscl_ratio = 1,\n\t.writeback_max_hscl_taps = 12,\n\t.writeback_max_vscl_taps = 12,\n\t.writeback_line_buffer_luma_buffer_size = 0,\n\t.writeback_line_buffer_chroma_buffer_size = 14643,\n\t.cursor_buffer_size = 8,\n\t.cursor_chunk_size = 2,\n\t.max_num_otg = 6,\n\t.max_num_dpp = 6,\n\t.max_num_wb = 1,\n\t.max_dchub_pscl_bw_pix_per_clk = 4,\n\t.max_pscl_lb_bw_pix_per_clk = 2,\n\t.max_lb_vscl_bw_pix_per_clk = 4,\n\t.max_vscl_hscl_bw_pix_per_clk = 4,\n\t.max_hscl_ratio = 8,\n\t.max_vscl_ratio = 8,\n\t.hscl_mults = 4,\n\t.vscl_mults = 4,\n\t.max_hscl_taps = 8,\n\t.max_vscl_taps = 8,\n\t.dispclk_ramp_margin_percent = 1,\n\t.underscan_factor = 1.10,\n\t.min_vblank_lines = 32, \n\t.dppclk_delay_subtotal = 77, \n\t.dppclk_delay_scl_lb_only = 16,\n\t.dppclk_delay_scl = 50,\n\t.dppclk_delay_cnvc_formatter = 8,\n\t.dppclk_delay_cnvc_cursor = 6,\n\t.dispclk_delay_subtotal = 87, \n\t.dcfclk_cstate_latency = 10, \n\t.max_inter_dcn_tile_repeaters = 8,\n\t.xfc_supported = true,\n\t.xfc_fill_bw_overhead_percent = 10.0,\n\t.xfc_fill_constant_bytes = 0,\n\t.number_of_cursors = 1,\n};\n\nstruct _vcs_dpi_ip_params_st dcn2_0_nv14_ip = {\n\t.odm_capable = 1,\n\t.gpuvm_enable = 0,\n\t.hostvm_enable = 0,\n\t.gpuvm_max_page_table_levels = 4,\n\t.hostvm_max_page_table_levels = 4,\n\t.hostvm_cached_page_table_levels = 0,\n\t.num_dsc = 5,\n\t.rob_buffer_size_kbytes = 168,\n\t.det_buffer_size_kbytes = 164,\n\t.dpte_buffer_size_in_pte_reqs_luma = 84,\n\t.dpte_buffer_size_in_pte_reqs_chroma = 42,\n\t.dpp_output_buffer_pixels = 2560,\n\t.opp_output_buffer_lines = 1,\n\t.pixel_chunk_size_kbytes = 8,\n\t.pte_enable = 1,\n\t.max_page_table_levels = 4,\n\t.pte_chunk_size_kbytes = 2,\n\t.meta_chunk_size_kbytes = 2,\n\t.writeback_chunk_size_kbytes = 2,\n\t.line_buffer_size_bits = 789504,\n\t.is_line_buffer_bpp_fixed = 0,\n\t.line_buffer_fixed_bpp = 0,\n\t.dcc_supported = true,\n\t.max_line_buffer_lines = 12,\n\t.writeback_luma_buffer_size_kbytes = 12,\n\t.writeback_chroma_buffer_size_kbytes = 8,\n\t.writeback_chroma_line_buffer_width_pixels = 4,\n\t.writeback_max_hscl_ratio = 1,\n\t.writeback_max_vscl_ratio = 1,\n\t.writeback_min_hscl_ratio = 1,\n\t.writeback_min_vscl_ratio = 1,\n\t.writeback_max_hscl_taps = 12,\n\t.writeback_max_vscl_taps = 12,\n\t.writeback_line_buffer_luma_buffer_size = 0,\n\t.writeback_line_buffer_chroma_buffer_size = 14643,\n\t.cursor_buffer_size = 8,\n\t.cursor_chunk_size = 2,\n\t.max_num_otg = 5,\n\t.max_num_dpp = 5,\n\t.max_num_wb = 1,\n\t.max_dchub_pscl_bw_pix_per_clk = 4,\n\t.max_pscl_lb_bw_pix_per_clk = 2,\n\t.max_lb_vscl_bw_pix_per_clk = 4,\n\t.max_vscl_hscl_bw_pix_per_clk = 4,\n\t.max_hscl_ratio = 8,\n\t.max_vscl_ratio = 8,\n\t.hscl_mults = 4,\n\t.vscl_mults = 4,\n\t.max_hscl_taps = 8,\n\t.max_vscl_taps = 8,\n\t.dispclk_ramp_margin_percent = 1,\n\t.underscan_factor = 1.10,\n\t.min_vblank_lines = 32, \n\t.dppclk_delay_subtotal = 77, \n\t.dppclk_delay_scl_lb_only = 16,\n\t.dppclk_delay_scl = 50,\n\t.dppclk_delay_cnvc_formatter = 8,\n\t.dppclk_delay_cnvc_cursor = 6,\n\t.dispclk_delay_subtotal = 87, \n\t.dcfclk_cstate_latency = 10, \n\t.max_inter_dcn_tile_repeaters = 8,\n\t.xfc_supported = true,\n\t.xfc_fill_bw_overhead_percent = 10.0,\n\t.xfc_fill_constant_bytes = 0,\n\t.ptoi_supported = 0,\n\t.number_of_cursors = 1,\n};\n\nstruct _vcs_dpi_soc_bounding_box_st dcn2_0_soc = {\n\t \n\t.clock_limits = {\n\t\t\t{\n\t\t\t\t.state = 0,\n\t\t\t\t.dcfclk_mhz = 560.0,\n\t\t\t\t.fabricclk_mhz = 560.0,\n\t\t\t\t.dispclk_mhz = 513.0,\n\t\t\t\t.dppclk_mhz = 513.0,\n\t\t\t\t.phyclk_mhz = 540.0,\n\t\t\t\t.socclk_mhz = 560.0,\n\t\t\t\t.dscclk_mhz = 171.0,\n\t\t\t\t.dram_speed_mts = 8960.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 1,\n\t\t\t\t.dcfclk_mhz = 694.0,\n\t\t\t\t.fabricclk_mhz = 694.0,\n\t\t\t\t.dispclk_mhz = 642.0,\n\t\t\t\t.dppclk_mhz = 642.0,\n\t\t\t\t.phyclk_mhz = 600.0,\n\t\t\t\t.socclk_mhz = 694.0,\n\t\t\t\t.dscclk_mhz = 214.0,\n\t\t\t\t.dram_speed_mts = 11104.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 2,\n\t\t\t\t.dcfclk_mhz = 875.0,\n\t\t\t\t.fabricclk_mhz = 875.0,\n\t\t\t\t.dispclk_mhz = 734.0,\n\t\t\t\t.dppclk_mhz = 734.0,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 875.0,\n\t\t\t\t.dscclk_mhz = 245.0,\n\t\t\t\t.dram_speed_mts = 14000.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 3,\n\t\t\t\t.dcfclk_mhz = 1000.0,\n\t\t\t\t.fabricclk_mhz = 1000.0,\n\t\t\t\t.dispclk_mhz = 1100.0,\n\t\t\t\t.dppclk_mhz = 1100.0,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 1000.0,\n\t\t\t\t.dscclk_mhz = 367.0,\n\t\t\t\t.dram_speed_mts = 16000.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 4,\n\t\t\t\t.dcfclk_mhz = 1200.0,\n\t\t\t\t.fabricclk_mhz = 1200.0,\n\t\t\t\t.dispclk_mhz = 1284.0,\n\t\t\t\t.dppclk_mhz = 1284.0,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 1200.0,\n\t\t\t\t.dscclk_mhz = 428.0,\n\t\t\t\t.dram_speed_mts = 16000.0,\n\t\t\t},\n\t\t\t \n\t\t\t{\n\t\t\t\t.state = 5,\n\t\t\t\t.dcfclk_mhz = 1200.0,\n\t\t\t\t.fabricclk_mhz = 1200.0,\n\t\t\t\t.dispclk_mhz = 1284.0,\n\t\t\t\t.dppclk_mhz = 1284.0,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 1200.0,\n\t\t\t\t.dscclk_mhz = 428.0,\n\t\t\t\t.dram_speed_mts = 16000.0,\n\t\t\t},\n\t\t},\n\t.num_states = 5,\n\t.sr_exit_time_us = 8.6,\n\t.sr_enter_plus_exit_time_us = 10.9,\n\t.urgent_latency_us = 4.0,\n\t.urgent_latency_pixel_data_only_us = 4.0,\n\t.urgent_latency_pixel_mixed_with_vm_data_us = 4.0,\n\t.urgent_latency_vm_data_only_us = 4.0,\n\t.urgent_out_of_order_return_per_channel_pixel_only_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_pixel_and_vm_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_vm_only_bytes = 4096,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_only = 40.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm = 40.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_vm_only = 40.0,\n\t.max_avg_sdp_bw_use_normal_percent = 40.0,\n\t.max_avg_dram_bw_use_normal_percent = 40.0,\n\t.writeback_latency_us = 12.0,\n\t.ideal_dram_bw_after_urgent_percent = 40.0,\n\t.max_request_size_bytes = 256,\n\t.dram_channel_width_bytes = 2,\n\t.fabric_datapath_to_dcn_data_return_bytes = 64,\n\t.dcn_downspread_percent = 0.5,\n\t.downspread_percent = 0.38,\n\t.dram_page_open_time_ns = 50.0,\n\t.dram_rw_turnaround_time_ns = 17.5,\n\t.dram_return_buffer_per_channel_bytes = 8192,\n\t.round_trip_ping_latency_dcfclk_cycles = 131,\n\t.urgent_out_of_order_return_per_channel_bytes = 256,\n\t.channel_interleave_bytes = 256,\n\t.num_banks = 8,\n\t.num_chans = 16,\n\t.vmm_page_size_bytes = 4096,\n\t.dram_clock_change_latency_us = 404.0,\n\t.dummy_pstate_latency_us = 5.0,\n\t.writeback_dram_clock_change_latency_us = 23.0,\n\t.return_bus_width_bytes = 64,\n\t.dispclk_dppclk_vco_speed_mhz = 3850,\n\t.xfc_bus_transport_time_us = 20,\n\t.xfc_xbuf_latency_tolerance_us = 4,\n\t.use_urgent_burst_bw = 0\n};\n\nstruct _vcs_dpi_soc_bounding_box_st dcn2_0_nv14_soc = {\n\t.clock_limits = {\n\t\t\t{\n\t\t\t\t.state = 0,\n\t\t\t\t.dcfclk_mhz = 560.0,\n\t\t\t\t.fabricclk_mhz = 560.0,\n\t\t\t\t.dispclk_mhz = 513.0,\n\t\t\t\t.dppclk_mhz = 513.0,\n\t\t\t\t.phyclk_mhz = 540.0,\n\t\t\t\t.socclk_mhz = 560.0,\n\t\t\t\t.dscclk_mhz = 171.0,\n\t\t\t\t.dram_speed_mts = 8960.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 1,\n\t\t\t\t.dcfclk_mhz = 694.0,\n\t\t\t\t.fabricclk_mhz = 694.0,\n\t\t\t\t.dispclk_mhz = 642.0,\n\t\t\t\t.dppclk_mhz = 642.0,\n\t\t\t\t.phyclk_mhz = 600.0,\n\t\t\t\t.socclk_mhz = 694.0,\n\t\t\t\t.dscclk_mhz = 214.0,\n\t\t\t\t.dram_speed_mts = 11104.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 2,\n\t\t\t\t.dcfclk_mhz = 875.0,\n\t\t\t\t.fabricclk_mhz = 875.0,\n\t\t\t\t.dispclk_mhz = 734.0,\n\t\t\t\t.dppclk_mhz = 734.0,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 875.0,\n\t\t\t\t.dscclk_mhz = 245.0,\n\t\t\t\t.dram_speed_mts = 14000.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 3,\n\t\t\t\t.dcfclk_mhz = 1000.0,\n\t\t\t\t.fabricclk_mhz = 1000.0,\n\t\t\t\t.dispclk_mhz = 1100.0,\n\t\t\t\t.dppclk_mhz = 1100.0,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 1000.0,\n\t\t\t\t.dscclk_mhz = 367.0,\n\t\t\t\t.dram_speed_mts = 16000.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 4,\n\t\t\t\t.dcfclk_mhz = 1200.0,\n\t\t\t\t.fabricclk_mhz = 1200.0,\n\t\t\t\t.dispclk_mhz = 1284.0,\n\t\t\t\t.dppclk_mhz = 1284.0,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 1200.0,\n\t\t\t\t.dscclk_mhz = 428.0,\n\t\t\t\t.dram_speed_mts = 16000.0,\n\t\t\t},\n\t\t\t \n\t\t\t{\n\t\t\t\t.state = 5,\n\t\t\t\t.dcfclk_mhz = 1200.0,\n\t\t\t\t.fabricclk_mhz = 1200.0,\n\t\t\t\t.dispclk_mhz = 1284.0,\n\t\t\t\t.dppclk_mhz = 1284.0,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 1200.0,\n\t\t\t\t.dscclk_mhz = 428.0,\n\t\t\t\t.dram_speed_mts = 16000.0,\n\t\t\t},\n\t\t},\n\t.num_states = 5,\n\t.sr_exit_time_us = 11.6,\n\t.sr_enter_plus_exit_time_us = 13.9,\n\t.urgent_latency_us = 4.0,\n\t.urgent_latency_pixel_data_only_us = 4.0,\n\t.urgent_latency_pixel_mixed_with_vm_data_us = 4.0,\n\t.urgent_latency_vm_data_only_us = 4.0,\n\t.urgent_out_of_order_return_per_channel_pixel_only_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_pixel_and_vm_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_vm_only_bytes = 4096,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_only = 40.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm = 40.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_vm_only = 40.0,\n\t.max_avg_sdp_bw_use_normal_percent = 40.0,\n\t.max_avg_dram_bw_use_normal_percent = 40.0,\n\t.writeback_latency_us = 12.0,\n\t.ideal_dram_bw_after_urgent_percent = 40.0,\n\t.max_request_size_bytes = 256,\n\t.dram_channel_width_bytes = 2,\n\t.fabric_datapath_to_dcn_data_return_bytes = 64,\n\t.dcn_downspread_percent = 0.5,\n\t.downspread_percent = 0.38,\n\t.dram_page_open_time_ns = 50.0,\n\t.dram_rw_turnaround_time_ns = 17.5,\n\t.dram_return_buffer_per_channel_bytes = 8192,\n\t.round_trip_ping_latency_dcfclk_cycles = 131,\n\t.urgent_out_of_order_return_per_channel_bytes = 256,\n\t.channel_interleave_bytes = 256,\n\t.num_banks = 8,\n\t.num_chans = 8,\n\t.vmm_page_size_bytes = 4096,\n\t.dram_clock_change_latency_us = 404.0,\n\t.dummy_pstate_latency_us = 5.0,\n\t.writeback_dram_clock_change_latency_us = 23.0,\n\t.return_bus_width_bytes = 64,\n\t.dispclk_dppclk_vco_speed_mhz = 3850,\n\t.xfc_bus_transport_time_us = 20,\n\t.xfc_xbuf_latency_tolerance_us = 4,\n\t.use_urgent_burst_bw = 0\n};\n\nstruct _vcs_dpi_soc_bounding_box_st dcn2_0_nv12_soc = {\n\t.clock_limits = {\n\t\t{\n\t\t\t.state = 0,\n\t\t\t.dcfclk_mhz = 560.0,\n\t\t\t.fabricclk_mhz = 560.0,\n\t\t\t.dispclk_mhz = 513.0,\n\t\t\t.dppclk_mhz = 513.0,\n\t\t\t.phyclk_mhz = 540.0,\n\t\t\t.socclk_mhz = 560.0,\n\t\t\t.dscclk_mhz = 171.0,\n\t\t\t.dram_speed_mts = 1069.0,\n\t\t},\n\t\t{\n\t\t\t.state = 1,\n\t\t\t.dcfclk_mhz = 694.0,\n\t\t\t.fabricclk_mhz = 694.0,\n\t\t\t.dispclk_mhz = 642.0,\n\t\t\t.dppclk_mhz = 642.0,\n\t\t\t.phyclk_mhz = 600.0,\n\t\t\t.socclk_mhz = 694.0,\n\t\t\t.dscclk_mhz = 214.0,\n\t\t\t.dram_speed_mts = 1324.0,\n\t\t},\n\t\t{\n\t\t\t.state = 2,\n\t\t\t.dcfclk_mhz = 875.0,\n\t\t\t.fabricclk_mhz = 875.0,\n\t\t\t.dispclk_mhz = 734.0,\n\t\t\t.dppclk_mhz = 734.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.socclk_mhz = 875.0,\n\t\t\t.dscclk_mhz = 245.0,\n\t\t\t.dram_speed_mts = 1670.0,\n\t\t},\n\t\t{\n\t\t\t.state = 3,\n\t\t\t.dcfclk_mhz = 1000.0,\n\t\t\t.fabricclk_mhz = 1000.0,\n\t\t\t.dispclk_mhz = 1100.0,\n\t\t\t.dppclk_mhz = 1100.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.socclk_mhz = 1000.0,\n\t\t\t.dscclk_mhz = 367.0,\n\t\t\t.dram_speed_mts = 2000.0,\n\t\t},\n\t\t{\n\t\t\t.state = 4,\n\t\t\t.dcfclk_mhz = 1200.0,\n\t\t\t.fabricclk_mhz = 1200.0,\n\t\t\t.dispclk_mhz = 1284.0,\n\t\t\t.dppclk_mhz = 1284.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.socclk_mhz = 1200.0,\n\t\t\t.dscclk_mhz = 428.0,\n\t\t\t.dram_speed_mts = 2000.0,\n\t\t},\n\t\t{\n\t\t\t.state = 5,\n\t\t\t.dcfclk_mhz = 1200.0,\n\t\t\t.fabricclk_mhz = 1200.0,\n\t\t\t.dispclk_mhz = 1284.0,\n\t\t\t.dppclk_mhz = 1284.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.socclk_mhz = 1200.0,\n\t\t\t.dscclk_mhz = 428.0,\n\t\t\t.dram_speed_mts = 2000.0,\n\t\t},\n\t},\n\n\t.num_states = 5,\n\t.sr_exit_time_us = 1.9,\n\t.sr_enter_plus_exit_time_us = 4.4,\n\t.urgent_latency_us = 3.0,\n\t.urgent_latency_pixel_data_only_us = 4.0,\n\t.urgent_latency_pixel_mixed_with_vm_data_us = 4.0,\n\t.urgent_latency_vm_data_only_us = 4.0,\n\t.urgent_out_of_order_return_per_channel_pixel_only_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_pixel_and_vm_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_vm_only_bytes = 4096,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_only = 40.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm = 40.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_vm_only = 40.0,\n\t.max_avg_sdp_bw_use_normal_percent = 40.0,\n\t.max_avg_dram_bw_use_normal_percent = 40.0,\n\t.writeback_latency_us = 12.0,\n\t.ideal_dram_bw_after_urgent_percent = 40.0,\n\t.max_request_size_bytes = 256,\n\t.dram_channel_width_bytes = 16,\n\t.fabric_datapath_to_dcn_data_return_bytes = 64,\n\t.dcn_downspread_percent = 0.5,\n\t.downspread_percent = 0.5,\n\t.dram_page_open_time_ns = 50.0,\n\t.dram_rw_turnaround_time_ns = 17.5,\n\t.dram_return_buffer_per_channel_bytes = 8192,\n\t.round_trip_ping_latency_dcfclk_cycles = 131,\n\t.urgent_out_of_order_return_per_channel_bytes = 4096,\n\t.channel_interleave_bytes = 256,\n\t.num_banks = 8,\n\t.num_chans = 16,\n\t.vmm_page_size_bytes = 4096,\n\t.dram_clock_change_latency_us = 45.0,\n\t.writeback_dram_clock_change_latency_us = 23.0,\n\t.return_bus_width_bytes = 64,\n\t.dispclk_dppclk_vco_speed_mhz = 3850,\n\t.xfc_bus_transport_time_us = 20,\n\t.xfc_xbuf_latency_tolerance_us = 50,\n\t.use_urgent_burst_bw = 0,\n};\n\nstruct _vcs_dpi_ip_params_st dcn2_1_ip = {\n\t.odm_capable = 1,\n\t.gpuvm_enable = 1,\n\t.hostvm_enable = 1,\n\t.gpuvm_max_page_table_levels = 1,\n\t.hostvm_max_page_table_levels = 4,\n\t.hostvm_cached_page_table_levels = 2,\n\t.num_dsc = 3,\n\t.rob_buffer_size_kbytes = 168,\n\t.det_buffer_size_kbytes = 164,\n\t.dpte_buffer_size_in_pte_reqs_luma = 44,\n\t.dpte_buffer_size_in_pte_reqs_chroma = 42,\n\t.dpp_output_buffer_pixels = 2560,\n\t.opp_output_buffer_lines = 1,\n\t.pixel_chunk_size_kbytes = 8,\n\t.pte_enable = 1,\n\t.max_page_table_levels = 4,\n\t.pte_chunk_size_kbytes = 2,\n\t.meta_chunk_size_kbytes = 2,\n\t.min_meta_chunk_size_bytes = 256,\n\t.writeback_chunk_size_kbytes = 2,\n\t.line_buffer_size_bits = 789504,\n\t.is_line_buffer_bpp_fixed = 0,\n\t.line_buffer_fixed_bpp = 0,\n\t.dcc_supported = true,\n\t.max_line_buffer_lines = 12,\n\t.writeback_luma_buffer_size_kbytes = 12,\n\t.writeback_chroma_buffer_size_kbytes = 8,\n\t.writeback_chroma_line_buffer_width_pixels = 4,\n\t.writeback_max_hscl_ratio = 1,\n\t.writeback_max_vscl_ratio = 1,\n\t.writeback_min_hscl_ratio = 1,\n\t.writeback_min_vscl_ratio = 1,\n\t.writeback_max_hscl_taps = 12,\n\t.writeback_max_vscl_taps = 12,\n\t.writeback_line_buffer_luma_buffer_size = 0,\n\t.writeback_line_buffer_chroma_buffer_size = 14643,\n\t.cursor_buffer_size = 8,\n\t.cursor_chunk_size = 2,\n\t.max_num_otg = 4,\n\t.max_num_dpp = 4,\n\t.max_num_wb = 1,\n\t.max_dchub_pscl_bw_pix_per_clk = 4,\n\t.max_pscl_lb_bw_pix_per_clk = 2,\n\t.max_lb_vscl_bw_pix_per_clk = 4,\n\t.max_vscl_hscl_bw_pix_per_clk = 4,\n\t.max_hscl_ratio = 4,\n\t.max_vscl_ratio = 4,\n\t.hscl_mults = 4,\n\t.vscl_mults = 4,\n\t.max_hscl_taps = 8,\n\t.max_vscl_taps = 8,\n\t.dispclk_ramp_margin_percent = 1,\n\t.underscan_factor = 1.10,\n\t.min_vblank_lines = 32, \n\t.dppclk_delay_subtotal = 77, \n\t.dppclk_delay_scl_lb_only = 16,\n\t.dppclk_delay_scl = 50,\n\t.dppclk_delay_cnvc_formatter = 8,\n\t.dppclk_delay_cnvc_cursor = 6,\n\t.dispclk_delay_subtotal = 87, \n\t.dcfclk_cstate_latency = 10, \n\t.max_inter_dcn_tile_repeaters = 8,\n\n\t.xfc_supported = false,\n\t.xfc_fill_bw_overhead_percent = 10.0,\n\t.xfc_fill_constant_bytes = 0,\n\t.ptoi_supported = 0,\n\t.number_of_cursors = 1,\n};\n\nstruct _vcs_dpi_soc_bounding_box_st dcn2_1_soc = {\n\t.clock_limits = {\n\t\t\t{\n\t\t\t\t.state = 0,\n\t\t\t\t.dcfclk_mhz = 400.0,\n\t\t\t\t.fabricclk_mhz = 400.0,\n\t\t\t\t.dispclk_mhz = 600.0,\n\t\t\t\t.dppclk_mhz = 400.00,\n\t\t\t\t.phyclk_mhz = 600.0,\n\t\t\t\t.socclk_mhz = 278.0,\n\t\t\t\t.dscclk_mhz = 205.67,\n\t\t\t\t.dram_speed_mts = 1600.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 1,\n\t\t\t\t.dcfclk_mhz = 464.52,\n\t\t\t\t.fabricclk_mhz = 800.0,\n\t\t\t\t.dispclk_mhz = 654.55,\n\t\t\t\t.dppclk_mhz = 626.09,\n\t\t\t\t.phyclk_mhz = 600.0,\n\t\t\t\t.socclk_mhz = 278.0,\n\t\t\t\t.dscclk_mhz = 205.67,\n\t\t\t\t.dram_speed_mts = 1600.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 2,\n\t\t\t\t.dcfclk_mhz = 514.29,\n\t\t\t\t.fabricclk_mhz = 933.0,\n\t\t\t\t.dispclk_mhz = 757.89,\n\t\t\t\t.dppclk_mhz = 685.71,\n\t\t\t\t.phyclk_mhz = 600.0,\n\t\t\t\t.socclk_mhz = 278.0,\n\t\t\t\t.dscclk_mhz = 287.67,\n\t\t\t\t.dram_speed_mts = 1866.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 3,\n\t\t\t\t.dcfclk_mhz = 576.00,\n\t\t\t\t.fabricclk_mhz = 1067.0,\n\t\t\t\t.dispclk_mhz = 847.06,\n\t\t\t\t.dppclk_mhz = 757.89,\n\t\t\t\t.phyclk_mhz = 600.0,\n\t\t\t\t.socclk_mhz = 715.0,\n\t\t\t\t.dscclk_mhz = 318.334,\n\t\t\t\t.dram_speed_mts = 2134.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 4,\n\t\t\t\t.dcfclk_mhz = 626.09,\n\t\t\t\t.fabricclk_mhz = 1200.0,\n\t\t\t\t.dispclk_mhz = 900.00,\n\t\t\t\t.dppclk_mhz = 847.06,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 953.0,\n\t\t\t\t.dscclk_mhz = 300.0,\n\t\t\t\t.dram_speed_mts = 2400.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 5,\n\t\t\t\t.dcfclk_mhz = 685.71,\n\t\t\t\t.fabricclk_mhz = 1333.0,\n\t\t\t\t.dispclk_mhz = 1028.57,\n\t\t\t\t.dppclk_mhz = 960.00,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 278.0,\n\t\t\t\t.dscclk_mhz = 342.86,\n\t\t\t\t.dram_speed_mts = 2666.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 6,\n\t\t\t\t.dcfclk_mhz = 757.89,\n\t\t\t\t.fabricclk_mhz = 1467.0,\n\t\t\t\t.dispclk_mhz = 1107.69,\n\t\t\t\t.dppclk_mhz = 1028.57,\n\t\t\t\t.phyclk_mhz = 810.0,\n\t\t\t\t.socclk_mhz = 715.0,\n\t\t\t\t.dscclk_mhz = 369.23,\n\t\t\t\t.dram_speed_mts = 3200.0,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.state = 7,\n\t\t\t\t.dcfclk_mhz = 847.06,\n\t\t\t\t.fabricclk_mhz = 1600.0,\n\t\t\t\t.dispclk_mhz = 1395.0,\n\t\t\t\t.dppclk_mhz = 1285.00,\n\t\t\t\t.phyclk_mhz = 1325.0,\n\t\t\t\t.socclk_mhz = 953.0,\n\t\t\t\t.dscclk_mhz = 489.0,\n\t\t\t\t.dram_speed_mts = 4266.0,\n\t\t\t},\n\t\t\t \n\t\t\t{\n\t\t\t\t.state = 8,\n\t\t\t\t.dcfclk_mhz = 847.06,\n\t\t\t\t.fabricclk_mhz = 1600.0,\n\t\t\t\t.dispclk_mhz = 1395.0,\n\t\t\t\t.dppclk_mhz = 1285.0,\n\t\t\t\t.phyclk_mhz = 1325.0,\n\t\t\t\t.socclk_mhz = 953.0,\n\t\t\t\t.dscclk_mhz = 489.0,\n\t\t\t\t.dram_speed_mts = 4266.0,\n\t\t\t},\n\n\t\t},\n\n\t.sr_exit_time_us = 12.5,\n\t.sr_enter_plus_exit_time_us = 17.0,\n\t.urgent_latency_us = 4.0,\n\t.urgent_latency_pixel_data_only_us = 4.0,\n\t.urgent_latency_pixel_mixed_with_vm_data_us = 4.0,\n\t.urgent_latency_vm_data_only_us = 4.0,\n\t.urgent_out_of_order_return_per_channel_pixel_only_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_pixel_and_vm_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_vm_only_bytes = 4096,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_only = 80.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm = 75.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_vm_only = 40.0,\n\t.max_avg_sdp_bw_use_normal_percent = 60.0,\n\t.max_avg_dram_bw_use_normal_percent = 100.0,\n\t.writeback_latency_us = 12.0,\n\t.max_request_size_bytes = 256,\n\t.dram_channel_width_bytes = 4,\n\t.fabric_datapath_to_dcn_data_return_bytes = 32,\n\t.dcn_downspread_percent = 0.5,\n\t.downspread_percent = 0.38,\n\t.dram_page_open_time_ns = 50.0,\n\t.dram_rw_turnaround_time_ns = 17.5,\n\t.dram_return_buffer_per_channel_bytes = 8192,\n\t.round_trip_ping_latency_dcfclk_cycles = 128,\n\t.urgent_out_of_order_return_per_channel_bytes = 4096,\n\t.channel_interleave_bytes = 256,\n\t.num_banks = 8,\n\t.num_chans = 4,\n\t.vmm_page_size_bytes = 4096,\n\t.dram_clock_change_latency_us = 23.84,\n\t.return_bus_width_bytes = 64,\n\t.dispclk_dppclk_vco_speed_mhz = 3600,\n\t.xfc_bus_transport_time_us = 4,\n\t.xfc_xbuf_latency_tolerance_us = 4,\n\t.use_urgent_burst_bw = 1,\n\t.num_states = 8\n};\n\nstruct wm_table ddr4_wm_table_gs = {\n\t.entries = {\n\t\t{\n\t\t\t.wm_inst = WM_A,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 7.09,\n\t\t\t.sr_enter_plus_exit_time_us = 8.14,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_B,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 10.12,\n\t\t\t.sr_enter_plus_exit_time_us = 11.48,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_C,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 10.12,\n\t\t\t.sr_enter_plus_exit_time_us = 11.48,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_D,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 10.12,\n\t\t\t.sr_enter_plus_exit_time_us = 11.48,\n\t\t\t.valid = true,\n\t\t},\n\t}\n};\n\nstruct wm_table lpddr4_wm_table_gs = {\n\t.entries = {\n\t\t{\n\t\t\t.wm_inst = WM_A,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 5.32,\n\t\t\t.sr_enter_plus_exit_time_us = 6.38,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_B,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 9.82,\n\t\t\t.sr_enter_plus_exit_time_us = 11.196,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_C,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 9.89,\n\t\t\t.sr_enter_plus_exit_time_us = 11.24,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_D,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 9.748,\n\t\t\t.sr_enter_plus_exit_time_us = 11.102,\n\t\t\t.valid = true,\n\t\t},\n\t}\n};\n\nstruct wm_table lpddr4_wm_table_with_disabled_ppt = {\n\t.entries = {\n\t\t{\n\t\t\t.wm_inst = WM_A,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 8.32,\n\t\t\t.sr_enter_plus_exit_time_us = 9.38,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_B,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 9.82,\n\t\t\t.sr_enter_plus_exit_time_us = 11.196,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_C,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 9.89,\n\t\t\t.sr_enter_plus_exit_time_us = 11.24,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_D,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 9.748,\n\t\t\t.sr_enter_plus_exit_time_us = 11.102,\n\t\t\t.valid = true,\n\t\t},\n\t}\n};\n\nstruct wm_table ddr4_wm_table_rn = {\n\t.entries = {\n\t\t{\n\t\t\t.wm_inst = WM_A,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 11.90,\n\t\t\t.sr_enter_plus_exit_time_us = 12.80,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_B,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 13.18,\n\t\t\t.sr_enter_plus_exit_time_us = 14.30,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_C,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 13.18,\n\t\t\t.sr_enter_plus_exit_time_us = 14.30,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_D,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 13.18,\n\t\t\t.sr_enter_plus_exit_time_us = 14.30,\n\t\t\t.valid = true,\n\t\t},\n\t}\n};\n\nstruct wm_table ddr4_1R_wm_table_rn = {\n\t.entries = {\n\t\t{\n\t\t\t.wm_inst = WM_A,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 13.90,\n\t\t\t.sr_enter_plus_exit_time_us = 14.80,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_B,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 13.90,\n\t\t\t.sr_enter_plus_exit_time_us = 14.80,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_C,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 13.90,\n\t\t\t.sr_enter_plus_exit_time_us = 14.80,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_D,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.72,\n\t\t\t.sr_exit_time_us = 13.90,\n\t\t\t.sr_enter_plus_exit_time_us = 14.80,\n\t\t\t.valid = true,\n\t\t},\n\t}\n};\n\nstruct wm_table lpddr4_wm_table_rn = {\n\t.entries = {\n\t\t{\n\t\t\t.wm_inst = WM_A,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 7.32,\n\t\t\t.sr_enter_plus_exit_time_us = 8.38,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_B,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 9.82,\n\t\t\t.sr_enter_plus_exit_time_us = 11.196,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_C,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 9.89,\n\t\t\t.sr_enter_plus_exit_time_us = 11.24,\n\t\t\t.valid = true,\n\t\t},\n\t\t{\n\t\t\t.wm_inst = WM_D,\n\t\t\t.wm_type = WM_TYPE_PSTATE_CHG,\n\t\t\t.pstate_latency_us = 11.65333,\n\t\t\t.sr_exit_time_us = 9.748,\n\t\t\t.sr_enter_plus_exit_time_us = 11.102,\n\t\t\t.valid = true,\n\t\t},\n\t}\n};\n\nvoid dcn20_populate_dml_writeback_from_context(struct dc *dc,\n\t\t\t\t\t       struct resource_context *res_ctx,\n\t\t\t\t\t       display_e2e_pipe_params_st *pipes)\n{\n\tint pipe_cnt, i;\n\n\tdc_assert_fp_enabled();\n\n\tfor (i = 0, pipe_cnt = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tstruct dc_writeback_info *wb_info = &res_ctx->pipe_ctx[i].stream->writeback_info[0];\n\n\t\tif (!res_ctx->pipe_ctx[i].stream)\n\t\t\tcontinue;\n\n\t\t \n\t\tpipes[pipe_cnt].dout.wb_enable = (wb_info->wb_enabled == true) ? 1 : 0;\n\t\tpipes[pipe_cnt].dout.num_active_wb++;\n\t\tpipes[pipe_cnt].dout.wb.wb_src_height = wb_info->dwb_params.cnv_params.crop_height;\n\t\tpipes[pipe_cnt].dout.wb.wb_src_width = wb_info->dwb_params.cnv_params.crop_width;\n\t\tpipes[pipe_cnt].dout.wb.wb_dst_width = wb_info->dwb_params.dest_width;\n\t\tpipes[pipe_cnt].dout.wb.wb_dst_height = wb_info->dwb_params.dest_height;\n\t\tpipes[pipe_cnt].dout.wb.wb_htaps_luma = 1;\n\t\tpipes[pipe_cnt].dout.wb.wb_vtaps_luma = 1;\n\t\tpipes[pipe_cnt].dout.wb.wb_htaps_chroma = wb_info->dwb_params.scaler_taps.h_taps_c;\n\t\tpipes[pipe_cnt].dout.wb.wb_vtaps_chroma = wb_info->dwb_params.scaler_taps.v_taps_c;\n\t\tpipes[pipe_cnt].dout.wb.wb_hratio = 1.0;\n\t\tpipes[pipe_cnt].dout.wb.wb_vratio = 1.0;\n\t\tif (wb_info->dwb_params.out_format == dwb_scaler_mode_yuv420) {\n\t\t\tif (wb_info->dwb_params.output_depth == DWB_OUTPUT_PIXEL_DEPTH_8BPC)\n\t\t\t\tpipes[pipe_cnt].dout.wb.wb_pixel_format = dm_420_8;\n\t\t\telse\n\t\t\t\tpipes[pipe_cnt].dout.wb.wb_pixel_format = dm_420_10;\n\t\t} else {\n\t\t\tpipes[pipe_cnt].dout.wb.wb_pixel_format = dm_444_32;\n\t\t}\n\n\t\tpipe_cnt++;\n\t}\n}\n\nvoid dcn20_fpu_set_wb_arb_params(struct mcif_arb_params *wb_arb_params,\n\t\t\t\t struct dc_state *context,\n\t\t\t\t display_e2e_pipe_params_st *pipes,\n\t\t\t\t int pipe_cnt, int i)\n{\n\tint k;\n\n\tdc_assert_fp_enabled();\n\n\tfor (k = 0; k < sizeof(wb_arb_params->cli_watermark)/sizeof(wb_arb_params->cli_watermark[0]); k++) {\n\t\twb_arb_params->cli_watermark[k] = get_wm_writeback_urgent(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\t\twb_arb_params->pstate_watermark[k] = get_wm_writeback_dram_clock_change(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\t}\n\twb_arb_params->time_per_pixel = 16.0 * 1000 / (context->res_ctx.pipe_ctx[i].stream->phy_pix_clk / 1000);  \n}\n\nstatic bool is_dtbclk_required(struct dc *dc, struct dc_state *context)\n{\n\tint i;\n\tfor (i = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tif (!context->res_ctx.pipe_ctx[i].stream)\n\t\t\tcontinue;\n\t\tif (dc->link_srv->dp_is_128b_132b_signal(&context->res_ctx.pipe_ctx[i]))\n\t\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic enum dcn_zstate_support_state  decide_zstate_support(struct dc *dc, struct dc_state *context)\n{\n\tint plane_count;\n\tint i;\n\n\tplane_count = 0;\n\tfor (i = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tif (context->res_ctx.pipe_ctx[i].plane_state)\n\t\t\tplane_count++;\n\t}\n\n\t \n\tif (plane_count == 0)\n\t\treturn DCN_ZSTATE_SUPPORT_ALLOW;\n\telse if (context->stream_count == 1 &&  context->streams[0]->signal == SIGNAL_TYPE_EDP) {\n\t\tstruct dc_link *link = context->streams[0]->sink->link;\n\t\tstruct dc_stream_status *stream_status = &context->stream_status[0];\n\t\tint minmum_z8_residency = dc->debug.minimum_z8_residency_time > 0 ? dc->debug.minimum_z8_residency_time : 1000;\n\t\tbool allow_z8 = context->bw_ctx.dml.vba.StutterPeriod > (double)minmum_z8_residency;\n\t\tbool is_pwrseq0 = link->link_index == 0;\n\n\t\t \n\t\tif (stream_status->plane_count > 1)\n\t\t\treturn DCN_ZSTATE_SUPPORT_DISALLOW;\n\n\t\tif (is_pwrseq0 && context->bw_ctx.dml.vba.StutterPeriod > 5000.0)\n\t\t\treturn DCN_ZSTATE_SUPPORT_ALLOW;\n\t\telse if (is_pwrseq0 && link->psr_settings.psr_version == DC_PSR_VERSION_1 && !link->panel_config.psr.disable_psr)\n\t\t\treturn allow_z8 ? DCN_ZSTATE_SUPPORT_ALLOW_Z8_Z10_ONLY : DCN_ZSTATE_SUPPORT_ALLOW_Z10_ONLY;\n\t\telse\n\t\t\treturn allow_z8 ? DCN_ZSTATE_SUPPORT_ALLOW_Z8_ONLY : DCN_ZSTATE_SUPPORT_DISALLOW;\n\t} else {\n\t\treturn DCN_ZSTATE_SUPPORT_DISALLOW;\n\t}\n}\n\nstatic void dcn20_adjust_freesync_v_startup(\n\t\tconst struct dc_crtc_timing *dc_crtc_timing, int *vstartup_start)\n{\n\tstruct dc_crtc_timing patched_crtc_timing;\n\tuint32_t asic_blank_end   = 0;\n\tuint32_t asic_blank_start = 0;\n\tuint32_t newVstartup\t  = 0;\n\n\tpatched_crtc_timing = *dc_crtc_timing;\n\n\tif (patched_crtc_timing.flags.INTERLACE == 1) {\n\t\tif (patched_crtc_timing.v_front_porch < 2)\n\t\t\tpatched_crtc_timing.v_front_porch = 2;\n\t} else {\n\t\tif (patched_crtc_timing.v_front_porch < 1)\n\t\t\tpatched_crtc_timing.v_front_porch = 1;\n\t}\n\n\t \n\tasic_blank_start = patched_crtc_timing.v_total -\n\t\t\t\t\tpatched_crtc_timing.v_front_porch;\n\n\t \n\tasic_blank_end = asic_blank_start -\n\t\t\t\t\tpatched_crtc_timing.v_border_bottom -\n\t\t\t\t\tpatched_crtc_timing.v_addressable -\n\t\t\t\t\tpatched_crtc_timing.v_border_top;\n\n\tnewVstartup = asic_blank_end + (patched_crtc_timing.v_total - asic_blank_start);\n\n\t*vstartup_start = ((newVstartup > *vstartup_start) ? newVstartup : *vstartup_start);\n}\n\nvoid dcn20_calculate_dlg_params(struct dc *dc,\n\t\t\t\tstruct dc_state *context,\n\t\t\t\tdisplay_e2e_pipe_params_st *pipes,\n\t\t\t\tint pipe_cnt,\n\t\t\t\tint vlevel)\n{\n\tint i, pipe_idx, active_hubp_count = 0;\n\n\tdc_assert_fp_enabled();\n\n\t \n\tdc->res_pool->funcs->set_mcif_arb_params(dc, context, pipes, pipe_cnt);\n\n\tcontext->bw_ctx.bw.dcn.clk.dispclk_khz = context->bw_ctx.dml.vba.DISPCLK * 1000;\n\tcontext->bw_ctx.bw.dcn.clk.dcfclk_khz = context->bw_ctx.dml.vba.DCFCLK * 1000;\n\tcontext->bw_ctx.bw.dcn.clk.socclk_khz = context->bw_ctx.dml.vba.SOCCLK * 1000;\n\tcontext->bw_ctx.bw.dcn.clk.dramclk_khz = context->bw_ctx.dml.vba.DRAMSpeed * 1000 / 16;\n\n\tif (dc->debug.min_dram_clk_khz > context->bw_ctx.bw.dcn.clk.dramclk_khz)\n\t\tcontext->bw_ctx.bw.dcn.clk.dramclk_khz = dc->debug.min_dram_clk_khz;\n\n\tcontext->bw_ctx.bw.dcn.clk.dcfclk_deep_sleep_khz = context->bw_ctx.dml.vba.DCFCLKDeepSleep * 1000;\n\tcontext->bw_ctx.bw.dcn.clk.fclk_khz = context->bw_ctx.dml.vba.FabricClock * 1000;\n\tcontext->bw_ctx.bw.dcn.clk.p_state_change_support =\n\t\tcontext->bw_ctx.dml.vba.DRAMClockChangeSupport[vlevel][context->bw_ctx.dml.vba.maxMpcComb]\n\t\t\t\t\t\t\t!= dm_dram_clock_change_unsupported;\n\n\t \n\tcontext->bw_ctx.bw.dcn.clk.p_state_change_support |= context->bw_ctx.bw.dcn.clk.fw_based_mclk_switching;\n\n\tcontext->bw_ctx.bw.dcn.clk.dppclk_khz = 0;\n\n\tcontext->bw_ctx.bw.dcn.clk.dtbclk_en = is_dtbclk_required(dc, context);\n\n\tif (context->bw_ctx.bw.dcn.clk.dispclk_khz < dc->debug.min_disp_clk_khz)\n\t\tcontext->bw_ctx.bw.dcn.clk.dispclk_khz = dc->debug.min_disp_clk_khz;\n\n\tfor (i = 0, pipe_idx = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tif (!context->res_ctx.pipe_ctx[i].stream)\n\t\t\tcontinue;\n\t\tif (context->res_ctx.pipe_ctx[i].plane_state)\n\t\t\tactive_hubp_count++;\n\t\tpipes[pipe_idx].pipe.dest.vstartup_start = get_vstartup(&context->bw_ctx.dml, pipes, pipe_cnt, pipe_idx);\n\t\tpipes[pipe_idx].pipe.dest.vupdate_offset = get_vupdate_offset(&context->bw_ctx.dml, pipes, pipe_cnt, pipe_idx);\n\t\tpipes[pipe_idx].pipe.dest.vupdate_width = get_vupdate_width(&context->bw_ctx.dml, pipes, pipe_cnt, pipe_idx);\n\t\tpipes[pipe_idx].pipe.dest.vready_offset = get_vready_offset(&context->bw_ctx.dml, pipes, pipe_cnt, pipe_idx);\n\n\t\tif (context->res_ctx.pipe_ctx[i].stream->mall_stream_config.type == SUBVP_PHANTOM) {\n\t\t\t \n\t\t\tcontext->res_ctx.pipe_ctx[i].det_buffer_size_kb = 0;\n\t\t\tcontext->res_ctx.pipe_ctx[i].unbounded_req = false;\n\t\t} else {\n\t\t\tcontext->res_ctx.pipe_ctx[i].det_buffer_size_kb = context->bw_ctx.dml.ip.det_buffer_size_kbytes;\n\t\t\tcontext->res_ctx.pipe_ctx[i].unbounded_req = pipes[pipe_idx].pipe.src.unbounded_req_mode;\n\t\t}\n\n\t\tif (context->bw_ctx.bw.dcn.clk.dppclk_khz < pipes[pipe_idx].clks_cfg.dppclk_mhz * 1000)\n\t\t\tcontext->bw_ctx.bw.dcn.clk.dppclk_khz = pipes[pipe_idx].clks_cfg.dppclk_mhz * 1000;\n\t\tcontext->res_ctx.pipe_ctx[i].plane_res.bw.dppclk_khz =\n\t\t\t\t\t\tpipes[pipe_idx].clks_cfg.dppclk_mhz * 1000;\n\t\tcontext->res_ctx.pipe_ctx[i].pipe_dlg_param = pipes[pipe_idx].pipe.dest;\n\t\tif (dc->ctx->dce_version < DCN_VERSION_3_1 &&\n\t\t    context->res_ctx.pipe_ctx[i].stream->adaptive_sync_infopacket.valid)\n\t\t\tdcn20_adjust_freesync_v_startup(\n\t\t\t\t&context->res_ctx.pipe_ctx[i].stream->timing,\n\t\t\t\t&context->res_ctx.pipe_ctx[i].pipe_dlg_param.vstartup_start);\n\n\t\tpipe_idx++;\n\t}\n\t \n\tif (!active_hubp_count) {\n\t\tcontext->bw_ctx.bw.dcn.clk.p_state_change_support = true;\n\t}\n\t \n\tcontext->bw_ctx.bw.dcn.clk.bw_dppclk_khz = context->bw_ctx.bw.dcn.clk.dppclk_khz;\n\tcontext->bw_ctx.bw.dcn.clk.bw_dispclk_khz = context->bw_ctx.bw.dcn.clk.dispclk_khz;\n\tcontext->bw_ctx.bw.dcn.clk.max_supported_dppclk_khz = context->bw_ctx.dml.soc.clock_limits[vlevel].dppclk_mhz * 1000;\n\tcontext->bw_ctx.bw.dcn.clk.max_supported_dispclk_khz = context->bw_ctx.dml.soc.clock_limits[vlevel].dispclk_mhz * 1000;\n\n\tcontext->bw_ctx.bw.dcn.compbuf_size_kb = context->bw_ctx.dml.ip.config_return_buffer_size_in_kbytes\n\t\t\t\t\t\t- context->bw_ctx.dml.ip.det_buffer_size_kbytes * pipe_idx;\n\n\tfor (i = 0, pipe_idx = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tbool cstate_en = context->bw_ctx.dml.vba.PrefetchMode[vlevel][context->bw_ctx.dml.vba.maxMpcComb] != 2;\n\n\t\tif (!context->res_ctx.pipe_ctx[i].stream)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (dc->ctx->dce_version == DCN_VERSION_2_01)\n\t\t\tcstate_en = false;\n\n\t\tcontext->bw_ctx.dml.funcs.rq_dlg_get_dlg_reg(&context->bw_ctx.dml,\n\t\t\t\t&context->res_ctx.pipe_ctx[i].dlg_regs,\n\t\t\t\t&context->res_ctx.pipe_ctx[i].ttu_regs,\n\t\t\t\tpipes,\n\t\t\t\tpipe_cnt,\n\t\t\t\tpipe_idx,\n\t\t\t\tcstate_en,\n\t\t\t\tcontext->bw_ctx.bw.dcn.clk.p_state_change_support,\n\t\t\t\tfalse, false, true);\n\n\t\tcontext->bw_ctx.dml.funcs.rq_dlg_get_rq_reg(&context->bw_ctx.dml,\n\t\t\t\t&context->res_ctx.pipe_ctx[i].rq_regs,\n\t\t\t\t&pipes[pipe_idx].pipe);\n\t\tpipe_idx++;\n\t}\n\tcontext->bw_ctx.bw.dcn.clk.zstate_support = decide_zstate_support(dc, context);\n}\n\nstatic void swizzle_to_dml_params(\n\t\tenum swizzle_mode_values swizzle,\n\t\tunsigned int *sw_mode)\n{\n\tswitch (swizzle) {\n\tcase DC_SW_LINEAR:\n\t\t*sw_mode = dm_sw_linear;\n\t\tbreak;\n\tcase DC_SW_4KB_S:\n\t\t*sw_mode = dm_sw_4kb_s;\n\t\tbreak;\n\tcase DC_SW_4KB_S_X:\n\t\t*sw_mode = dm_sw_4kb_s_x;\n\t\tbreak;\n\tcase DC_SW_4KB_D:\n\t\t*sw_mode = dm_sw_4kb_d;\n\t\tbreak;\n\tcase DC_SW_4KB_D_X:\n\t\t*sw_mode = dm_sw_4kb_d_x;\n\t\tbreak;\n\tcase DC_SW_64KB_S:\n\t\t*sw_mode = dm_sw_64kb_s;\n\t\tbreak;\n\tcase DC_SW_64KB_S_X:\n\t\t*sw_mode = dm_sw_64kb_s_x;\n\t\tbreak;\n\tcase DC_SW_64KB_S_T:\n\t\t*sw_mode = dm_sw_64kb_s_t;\n\t\tbreak;\n\tcase DC_SW_64KB_D:\n\t\t*sw_mode = dm_sw_64kb_d;\n\t\tbreak;\n\tcase DC_SW_64KB_D_X:\n\t\t*sw_mode = dm_sw_64kb_d_x;\n\t\tbreak;\n\tcase DC_SW_64KB_D_T:\n\t\t*sw_mode = dm_sw_64kb_d_t;\n\t\tbreak;\n\tcase DC_SW_64KB_R_X:\n\t\t*sw_mode = dm_sw_64kb_r_x;\n\t\tbreak;\n\tcase DC_SW_VAR_S:\n\t\t*sw_mode = dm_sw_var_s;\n\t\tbreak;\n\tcase DC_SW_VAR_S_X:\n\t\t*sw_mode = dm_sw_var_s_x;\n\t\tbreak;\n\tcase DC_SW_VAR_D:\n\t\t*sw_mode = dm_sw_var_d;\n\t\tbreak;\n\tcase DC_SW_VAR_D_X:\n\t\t*sw_mode = dm_sw_var_d_x;\n\t\tbreak;\n\tcase DC_SW_VAR_R_X:\n\t\t*sw_mode = dm_sw_var_r_x;\n\t\tbreak;\n\tdefault:\n\t\tASSERT(0);  \n\t\tbreak;\n\t}\n}\n\nint dcn20_populate_dml_pipes_from_context(struct dc *dc,\n\t\t\t\t\t  struct dc_state *context,\n\t\t\t\t\t  display_e2e_pipe_params_st *pipes,\n\t\t\t\t\t  bool fast_validate)\n{\n\tint pipe_cnt, i;\n\tbool synchronized_vblank = true;\n\tstruct resource_context *res_ctx = &context->res_ctx;\n\n\tdc_assert_fp_enabled();\n\n\tfor (i = 0, pipe_cnt = -1; i < dc->res_pool->pipe_count; i++) {\n\t\tif (!res_ctx->pipe_ctx[i].stream)\n\t\t\tcontinue;\n\n\t\tif (pipe_cnt < 0) {\n\t\t\tpipe_cnt = i;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (res_ctx->pipe_ctx[pipe_cnt].stream == res_ctx->pipe_ctx[i].stream)\n\t\t\tcontinue;\n\n\t\tif (dc->debug.disable_timing_sync ||\n\t\t\t(!resource_are_streams_timing_synchronizable(\n\t\t\t\tres_ctx->pipe_ctx[pipe_cnt].stream,\n\t\t\t\tres_ctx->pipe_ctx[i].stream) &&\n\t\t\t!resource_are_vblanks_synchronizable(\n\t\t\t\tres_ctx->pipe_ctx[pipe_cnt].stream,\n\t\t\t\tres_ctx->pipe_ctx[i].stream))) {\n\t\t\tsynchronized_vblank = false;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tfor (i = 0, pipe_cnt = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tstruct dc_crtc_timing *timing = &res_ctx->pipe_ctx[i].stream->timing;\n\t\tunsigned int v_total;\n\t\tunsigned int front_porch;\n\t\tint output_bpc;\n\t\tstruct audio_check aud_check = {0};\n\n\t\tif (!res_ctx->pipe_ctx[i].stream)\n\t\t\tcontinue;\n\n\t\tv_total = timing->v_total;\n\t\tfront_porch = timing->v_front_porch;\n\n\t\t \n\n\t\tpipes[pipe_cnt].clks_cfg.refclk_mhz = dc->res_pool->ref_clocks.dchub_ref_clock_inKhz / 1000.0;\n\n\t\tpipes[pipe_cnt].pipe.dest.use_maximum_vstartup = dc->ctx->dce_version == DCN_VERSION_2_01;\n\n\t\tpipes[pipe_cnt].dout.dsc_enable = res_ctx->pipe_ctx[i].stream->timing.flags.DSC;\n\t\t \n\t\tpipes[pipe_cnt].dout.dsc_slices = res_ctx->pipe_ctx[i].stream->timing.dsc_cfg.num_slices_h;\n\t\tif (res_ctx->pipe_ctx[i].stream->use_dynamic_meta) {\n\t\t\tpipes[pipe_cnt].pipe.src.dynamic_metadata_enable = true;\n\t\t\t \n\t\t\tpipes[pipe_cnt].pipe.src.dynamic_metadata_lines_before_active =\n\t\t\t\t(v_total - timing->v_addressable\n\t\t\t\t\t- timing->v_border_top - timing->v_border_bottom) / 2;\n\t\t\t \n\t\t\tpipes[pipe_cnt].pipe.src.dynamic_metadata_xmit_bytes =\n\t\t\t\tdc_is_dp_signal(res_ctx->pipe_ctx[i].stream->signal) ? 36 : 32;\n\t\t}\n\t\tpipes[pipe_cnt].pipe.src.dcc = false;\n\t\tpipes[pipe_cnt].pipe.src.dcc_rate = 1;\n\t\tpipes[pipe_cnt].pipe.dest.synchronized_vblank_all_planes = synchronized_vblank;\n\t\tpipes[pipe_cnt].pipe.dest.synchronize_timings = synchronized_vblank;\n\t\tpipes[pipe_cnt].pipe.dest.hblank_start = timing->h_total - timing->h_front_porch;\n\t\tpipes[pipe_cnt].pipe.dest.hblank_end = pipes[pipe_cnt].pipe.dest.hblank_start\n\t\t\t\t- timing->h_addressable\n\t\t\t\t- timing->h_border_left\n\t\t\t\t- timing->h_border_right;\n\t\tpipes[pipe_cnt].pipe.dest.vblank_start = v_total - front_porch;\n\t\tpipes[pipe_cnt].pipe.dest.vblank_end = pipes[pipe_cnt].pipe.dest.vblank_start\n\t\t\t\t- timing->v_addressable\n\t\t\t\t- timing->v_border_top\n\t\t\t\t- timing->v_border_bottom;\n\t\tpipes[pipe_cnt].pipe.dest.htotal = timing->h_total;\n\t\tpipes[pipe_cnt].pipe.dest.vtotal = v_total;\n\t\tpipes[pipe_cnt].pipe.dest.hactive =\n\t\t\ttiming->h_addressable + timing->h_border_left + timing->h_border_right;\n\t\tpipes[pipe_cnt].pipe.dest.vactive =\n\t\t\ttiming->v_addressable + timing->v_border_top + timing->v_border_bottom;\n\t\tpipes[pipe_cnt].pipe.dest.interlaced = timing->flags.INTERLACE;\n\t\tpipes[pipe_cnt].pipe.dest.pixel_rate_mhz = timing->pix_clk_100hz/10000.0;\n\t\tif (timing->timing_3d_format == TIMING_3D_FORMAT_HW_FRAME_PACKING)\n\t\t\tpipes[pipe_cnt].pipe.dest.pixel_rate_mhz *= 2;\n\t\tpipes[pipe_cnt].pipe.dest.otg_inst = res_ctx->pipe_ctx[i].stream_res.tg->inst;\n\t\tpipes[pipe_cnt].dout.dp_lanes = 4;\n\t\tpipes[pipe_cnt].dout.dp_rate = dm_dp_rate_na;\n\t\tpipes[pipe_cnt].dout.is_virtual = 0;\n\t\tpipes[pipe_cnt].pipe.dest.vtotal_min = res_ctx->pipe_ctx[i].stream->adjust.v_total_min;\n\t\tpipes[pipe_cnt].pipe.dest.vtotal_max = res_ctx->pipe_ctx[i].stream->adjust.v_total_max;\n\t\tswitch (resource_get_num_odm_splits(&res_ctx->pipe_ctx[i])) {\n\t\tcase 1:\n\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine = dm_odm_combine_mode_2to1;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine = dm_odm_combine_mode_4to1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine = dm_odm_combine_mode_disabled;\n\t\t}\n\t\tpipes[pipe_cnt].pipe.src.hsplit_grp = res_ctx->pipe_ctx[i].pipe_idx;\n\t\tif (res_ctx->pipe_ctx[i].top_pipe && res_ctx->pipe_ctx[i].top_pipe->plane_state\n\t\t\t\t== res_ctx->pipe_ctx[i].plane_state) {\n\t\t\tstruct pipe_ctx *first_pipe = res_ctx->pipe_ctx[i].top_pipe;\n\t\t\tint split_idx = 0;\n\n\t\t\twhile (first_pipe->top_pipe && first_pipe->top_pipe->plane_state\n\t\t\t\t\t== res_ctx->pipe_ctx[i].plane_state) {\n\t\t\t\tfirst_pipe = first_pipe->top_pipe;\n\t\t\t\tsplit_idx++;\n\t\t\t}\n\t\t\t \n\t\t\tif (split_idx == 0)\n\t\t\t\tpipes[pipe_cnt].pipe.src.hsplit_grp = first_pipe->pipe_idx;\n\t\t\telse if (split_idx == 1)\n\t\t\t\tpipes[pipe_cnt].pipe.src.hsplit_grp = res_ctx->pipe_ctx[i].pipe_idx;\n\t\t\telse if (split_idx == 2)\n\t\t\t\tpipes[pipe_cnt].pipe.src.hsplit_grp = res_ctx->pipe_ctx[i].top_pipe->pipe_idx;\n\t\t} else if (res_ctx->pipe_ctx[i].prev_odm_pipe) {\n\t\t\tstruct pipe_ctx *first_pipe = res_ctx->pipe_ctx[i].prev_odm_pipe;\n\n\t\t\twhile (first_pipe->prev_odm_pipe)\n\t\t\t\tfirst_pipe = first_pipe->prev_odm_pipe;\n\t\t\tpipes[pipe_cnt].pipe.src.hsplit_grp = first_pipe->pipe_idx;\n\t\t}\n\n\t\tswitch (res_ctx->pipe_ctx[i].stream->signal) {\n\t\tcase SIGNAL_TYPE_DISPLAY_PORT_MST:\n\t\tcase SIGNAL_TYPE_DISPLAY_PORT:\n\t\t\tpipes[pipe_cnt].dout.output_type = dm_dp;\n\t\t\tif (dc->link_srv->dp_is_128b_132b_signal(&res_ctx->pipe_ctx[i]))\n\t\t\t\tpipes[pipe_cnt].dout.output_type = dm_dp2p0;\n\t\t\tbreak;\n\t\tcase SIGNAL_TYPE_EDP:\n\t\t\tpipes[pipe_cnt].dout.output_type = dm_edp;\n\t\t\tbreak;\n\t\tcase SIGNAL_TYPE_HDMI_TYPE_A:\n\t\tcase SIGNAL_TYPE_DVI_SINGLE_LINK:\n\t\tcase SIGNAL_TYPE_DVI_DUAL_LINK:\n\t\t\tpipes[pipe_cnt].dout.output_type = dm_hdmi;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\tpipes[pipe_cnt].dout.is_virtual = 1;\n\t\t\tpipes[pipe_cnt].dout.output_type = dm_dp;\n\t\t\tpipes[pipe_cnt].dout.dp_lanes = 4;\n\t\t}\n\n\t\tswitch (res_ctx->pipe_ctx[i].stream->timing.display_color_depth) {\n\t\tcase COLOR_DEPTH_666:\n\t\t\toutput_bpc = 6;\n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_888:\n\t\t\toutput_bpc = 8;\n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_101010:\n\t\t\toutput_bpc = 10;\n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_121212:\n\t\t\toutput_bpc = 12;\n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_141414:\n\t\t\toutput_bpc = 14;\n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_161616:\n\t\t\toutput_bpc = 16;\n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_999:\n\t\t\toutput_bpc = 9;\n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_111111:\n\t\t\toutput_bpc = 11;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\toutput_bpc = 8;\n\t\t\tbreak;\n\t\t}\n\n\t\tswitch (res_ctx->pipe_ctx[i].stream->timing.pixel_encoding) {\n\t\tcase PIXEL_ENCODING_RGB:\n\t\tcase PIXEL_ENCODING_YCBCR444:\n\t\t\tpipes[pipe_cnt].dout.output_format = dm_444;\n\t\t\tpipes[pipe_cnt].dout.output_bpp = output_bpc * 3;\n\t\t\tbreak;\n\t\tcase PIXEL_ENCODING_YCBCR420:\n\t\t\tpipes[pipe_cnt].dout.output_format = dm_420;\n\t\t\tpipes[pipe_cnt].dout.output_bpp = (output_bpc * 3.0) / 2;\n\t\t\tbreak;\n\t\tcase PIXEL_ENCODING_YCBCR422:\n\t\t\tif (res_ctx->pipe_ctx[i].stream->timing.flags.DSC &&\n\t\t\t    !res_ctx->pipe_ctx[i].stream->timing.dsc_cfg.ycbcr422_simple)\n\t\t\t\tpipes[pipe_cnt].dout.output_format = dm_n422;\n\t\t\telse\n\t\t\t\tpipes[pipe_cnt].dout.output_format = dm_s422;\n\t\t\tpipes[pipe_cnt].dout.output_bpp = output_bpc * 2;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpipes[pipe_cnt].dout.output_format = dm_444;\n\t\t\tpipes[pipe_cnt].dout.output_bpp = output_bpc * 3;\n\t\t}\n\n\t\tif (res_ctx->pipe_ctx[i].stream->timing.flags.DSC)\n\t\t\tpipes[pipe_cnt].dout.output_bpp = res_ctx->pipe_ctx[i].stream->timing.dsc_cfg.bits_per_pixel / 16.0;\n\n\t\t \n\t\tpipes[pipe_cnt].dout.dsc_input_bpc = 12;\n\t\t \n\t\tget_audio_check(&res_ctx->pipe_ctx[i].stream->audio_info, &aud_check);\n\t\tpipes[pipe_cnt].dout.max_audio_sample_rate = aud_check.max_audiosample_rate / 1000;\n\t\t \n\t\tif (res_ctx->pipe_ctx[i].plane_state &&\n\t\t\t\t(res_ctx->pipe_ctx[i].plane_state->address.type == PLN_ADDR_TYPE_VIDEO_PROGRESSIVE ||\n\t\t\t\t res_ctx->pipe_ctx[i].stream->mall_stream_config.type == SUBVP_PHANTOM))\n\t\t\tpipes[pipe_cnt].pipe.src.num_cursors = 0;\n\t\telse\n\t\t\tpipes[pipe_cnt].pipe.src.num_cursors = dc->dml.ip.number_of_cursors;\n\n\t\tpipes[pipe_cnt].pipe.src.cur0_src_width = 256;\n\t\tpipes[pipe_cnt].pipe.src.cur0_bpp = dm_cur_32bit;\n\n\t\tif (!res_ctx->pipe_ctx[i].plane_state) {\n\t\t\tpipes[pipe_cnt].pipe.src.is_hsplit = pipes[pipe_cnt].pipe.dest.odm_combine != dm_odm_combine_mode_disabled;\n\t\t\tpipes[pipe_cnt].pipe.src.source_scan = dm_horz;\n\t\t\tpipes[pipe_cnt].pipe.src.source_rotation = dm_rotation_0;\n\t\t\tpipes[pipe_cnt].pipe.src.sw_mode = dm_sw_4kb_s;\n\t\t\tpipes[pipe_cnt].pipe.src.macro_tile_size = dm_64k_tile;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_width = timing->h_addressable;\n\t\t\tif (pipes[pipe_cnt].pipe.src.viewport_width > 1920)\n\t\t\t\tpipes[pipe_cnt].pipe.src.viewport_width = 1920;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_height = timing->v_addressable;\n\t\t\tif (pipes[pipe_cnt].pipe.src.viewport_height > 1080)\n\t\t\t\tpipes[pipe_cnt].pipe.src.viewport_height = 1080;\n\t\t\tpipes[pipe_cnt].pipe.src.surface_height_y = pipes[pipe_cnt].pipe.src.viewport_height;\n\t\t\tpipes[pipe_cnt].pipe.src.surface_width_y = pipes[pipe_cnt].pipe.src.viewport_width;\n\t\t\tpipes[pipe_cnt].pipe.src.surface_height_c = pipes[pipe_cnt].pipe.src.viewport_height;\n\t\t\tpipes[pipe_cnt].pipe.src.surface_width_c = pipes[pipe_cnt].pipe.src.viewport_width;\n\t\t\tpipes[pipe_cnt].pipe.src.data_pitch = ((pipes[pipe_cnt].pipe.src.viewport_width + 255) / 256) * 256;\n\t\t\tpipes[pipe_cnt].pipe.src.source_format = dm_444_32;\n\t\t\tpipes[pipe_cnt].pipe.dest.recout_width = pipes[pipe_cnt].pipe.src.viewport_width;  \n\t\t\tpipes[pipe_cnt].pipe.dest.recout_height = pipes[pipe_cnt].pipe.src.viewport_height;  \n\t\t\tpipes[pipe_cnt].pipe.dest.full_recout_width = pipes[pipe_cnt].pipe.dest.recout_width;   \n\t\t\tpipes[pipe_cnt].pipe.dest.full_recout_height = pipes[pipe_cnt].pipe.dest.recout_height;  \n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.lb_depth = dm_lb_16;\n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.hscl_ratio = 1.0;\n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.vscl_ratio = 1.0;\n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.scl_enable = 0;  \n\t\t\tpipes[pipe_cnt].pipe.scale_taps.htaps = 1;\n\t\t\tpipes[pipe_cnt].pipe.scale_taps.vtaps = 1;\n\t\t\tpipes[pipe_cnt].pipe.dest.vtotal_min = v_total;\n\t\t\tpipes[pipe_cnt].pipe.dest.vtotal_max = v_total;\n\n\t\t\tif (pipes[pipe_cnt].pipe.dest.odm_combine == dm_odm_combine_mode_2to1) {\n\t\t\t\tpipes[pipe_cnt].pipe.src.viewport_width /= 2;\n\t\t\t\tpipes[pipe_cnt].pipe.dest.recout_width /= 2;\n\t\t\t} else if (pipes[pipe_cnt].pipe.dest.odm_combine == dm_odm_combine_mode_4to1) {\n\t\t\t\tpipes[pipe_cnt].pipe.src.viewport_width /= 4;\n\t\t\t\tpipes[pipe_cnt].pipe.dest.recout_width /= 4;\n\t\t\t}\n\t\t} else {\n\t\t\tstruct dc_plane_state *pln = res_ctx->pipe_ctx[i].plane_state;\n\t\t\tstruct scaler_data *scl = &res_ctx->pipe_ctx[i].plane_res.scl_data;\n\n\t\t\tpipes[pipe_cnt].pipe.src.immediate_flip = pln->flip_immediate;\n\t\t\tpipes[pipe_cnt].pipe.src.is_hsplit = (res_ctx->pipe_ctx[i].bottom_pipe && res_ctx->pipe_ctx[i].bottom_pipe->plane_state == pln)\n\t\t\t\t\t|| (res_ctx->pipe_ctx[i].top_pipe && res_ctx->pipe_ctx[i].top_pipe->plane_state == pln)\n\t\t\t\t\t|| pipes[pipe_cnt].pipe.dest.odm_combine != dm_odm_combine_mode_disabled;\n\n\t\t\t \n\t\t\tif (pln->stereo_format == PLANE_STEREO_FORMAT_SIDE_BY_SIDE ||\n\t\t\t    pln->stereo_format == PLANE_STEREO_FORMAT_TOP_AND_BOTTOM) {\n\t\t\t\tpipes[pipe_cnt].pipe.src.is_hsplit = false;\n\t\t\t\tpipes[pipe_cnt].pipe.src.hsplit_grp = res_ctx->pipe_ctx[i].pipe_idx;\n\t\t\t}\n\n\t\t\tpipes[pipe_cnt].pipe.src.source_scan = pln->rotation == ROTATION_ANGLE_90\n\t\t\t\t\t|| pln->rotation == ROTATION_ANGLE_270 ? dm_vert : dm_horz;\n\t\t\tswitch (pln->rotation) {\n\t\t\tcase ROTATION_ANGLE_0:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_rotation = dm_rotation_0;\n\t\t\t\tbreak;\n\t\t\tcase ROTATION_ANGLE_90:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_rotation = dm_rotation_90;\n\t\t\t\tbreak;\n\t\t\tcase ROTATION_ANGLE_180:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_rotation = dm_rotation_180;\n\t\t\t\tbreak;\n\t\t\tcase ROTATION_ANGLE_270:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_rotation = dm_rotation_270;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_y_y = scl->viewport.y;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_y_c = scl->viewport_c.y;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_x_y = scl->viewport.x;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_x_c = scl->viewport_c.x;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_width = scl->viewport.width;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_width_c = scl->viewport_c.width;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_height = scl->viewport.height;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_height_c = scl->viewport_c.height;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_width_max = pln->src_rect.width;\n\t\t\tpipes[pipe_cnt].pipe.src.viewport_height_max = pln->src_rect.height;\n\t\t\tpipes[pipe_cnt].pipe.src.surface_width_y = pln->plane_size.surface_size.width;\n\t\t\tpipes[pipe_cnt].pipe.src.surface_height_y = pln->plane_size.surface_size.height;\n\t\t\tpipes[pipe_cnt].pipe.src.surface_width_c = pln->plane_size.chroma_size.width;\n\t\t\tpipes[pipe_cnt].pipe.src.surface_height_c = pln->plane_size.chroma_size.height;\n\t\t\tif (pln->format == SURFACE_PIXEL_FORMAT_GRPH_RGBE_ALPHA\n\t\t\t\t\t|| pln->format >= SURFACE_PIXEL_FORMAT_VIDEO_BEGIN) {\n\t\t\t\tpipes[pipe_cnt].pipe.src.data_pitch = pln->plane_size.surface_pitch;\n\t\t\t\tpipes[pipe_cnt].pipe.src.data_pitch_c = pln->plane_size.chroma_pitch;\n\t\t\t\tpipes[pipe_cnt].pipe.src.meta_pitch = pln->dcc.meta_pitch;\n\t\t\t\tpipes[pipe_cnt].pipe.src.meta_pitch_c = pln->dcc.meta_pitch_c;\n\t\t\t} else {\n\t\t\t\tpipes[pipe_cnt].pipe.src.data_pitch = pln->plane_size.surface_pitch;\n\t\t\t\tpipes[pipe_cnt].pipe.src.meta_pitch = pln->dcc.meta_pitch;\n\t\t\t}\n\t\t\tpipes[pipe_cnt].pipe.src.dcc = pln->dcc.enable;\n\t\t\tpipes[pipe_cnt].pipe.dest.recout_width = scl->recout.width;\n\t\t\tpipes[pipe_cnt].pipe.dest.recout_height = scl->recout.height;\n\t\t\tpipes[pipe_cnt].pipe.dest.full_recout_height = scl->recout.height;\n\t\t\tpipes[pipe_cnt].pipe.dest.full_recout_width = scl->recout.width;\n\t\t\tif (pipes[pipe_cnt].pipe.dest.odm_combine == dm_odm_combine_mode_2to1)\n\t\t\t\tpipes[pipe_cnt].pipe.dest.full_recout_width *= 2;\n\t\t\telse if (pipes[pipe_cnt].pipe.dest.odm_combine == dm_odm_combine_mode_4to1)\n\t\t\t\tpipes[pipe_cnt].pipe.dest.full_recout_width *= 4;\n\t\t\telse {\n\t\t\t\tstruct pipe_ctx *split_pipe = res_ctx->pipe_ctx[i].bottom_pipe;\n\n\t\t\t\twhile (split_pipe && split_pipe->plane_state == pln) {\n\t\t\t\t\tpipes[pipe_cnt].pipe.dest.full_recout_width += split_pipe->plane_res.scl_data.recout.width;\n\t\t\t\t\tsplit_pipe = split_pipe->bottom_pipe;\n\t\t\t\t}\n\t\t\t\tsplit_pipe = res_ctx->pipe_ctx[i].top_pipe;\n\t\t\t\twhile (split_pipe && split_pipe->plane_state == pln) {\n\t\t\t\t\tpipes[pipe_cnt].pipe.dest.full_recout_width += split_pipe->plane_res.scl_data.recout.width;\n\t\t\t\t\tsplit_pipe = split_pipe->top_pipe;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.lb_depth = dm_lb_16;\n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.hscl_ratio = (double) scl->ratios.horz.value / (1ULL<<32);\n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.hscl_ratio_c = (double) scl->ratios.horz_c.value / (1ULL<<32);\n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.vscl_ratio = (double) scl->ratios.vert.value / (1ULL<<32);\n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.vscl_ratio_c = (double) scl->ratios.vert_c.value / (1ULL<<32);\n\t\t\tpipes[pipe_cnt].pipe.scale_ratio_depth.scl_enable =\n\t\t\t\t\tscl->ratios.vert.value != dc_fixpt_one.value\n\t\t\t\t\t|| scl->ratios.horz.value != dc_fixpt_one.value\n\t\t\t\t\t|| scl->ratios.vert_c.value != dc_fixpt_one.value\n\t\t\t\t\t|| scl->ratios.horz_c.value != dc_fixpt_one.value  \n\t\t\t\t\t|| dc->debug.always_scale;  \n\t\t\tpipes[pipe_cnt].pipe.scale_taps.htaps = scl->taps.h_taps;\n\t\t\tpipes[pipe_cnt].pipe.scale_taps.htaps_c = scl->taps.h_taps_c;\n\t\t\tpipes[pipe_cnt].pipe.scale_taps.vtaps = scl->taps.v_taps;\n\t\t\tpipes[pipe_cnt].pipe.scale_taps.vtaps_c = scl->taps.v_taps_c;\n\n\t\t\tpipes[pipe_cnt].pipe.src.macro_tile_size =\n\t\t\t\t\tswizzle_mode_to_macro_tile_size(pln->tiling_info.gfx9.swizzle);\n\t\t\tswizzle_to_dml_params(pln->tiling_info.gfx9.swizzle,\n\t\t\t\t\t&pipes[pipe_cnt].pipe.src.sw_mode);\n\n\t\t\tswitch (pln->format) {\n\t\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCbCr:\n\t\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCrCb:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_format = dm_420_8;\n\t\t\t\tbreak;\n\t\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCbCr:\n\t\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCrCb:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_format = dm_420_10;\n\t\t\t\tbreak;\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616F:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616F:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_format = dm_444_64;\n\t\t\t\tbreak;\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB1555:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB565:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_format = dm_444_16;\n\t\t\t\tbreak;\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_PALETA_256_COLORS:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_format = dm_444_8;\n\t\t\t\tbreak;\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_RGBE_ALPHA:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_format = dm_rgbe_alpha;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tpipes[pipe_cnt].pipe.src.source_format = dm_444_32;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tpipe_cnt++;\n\t}\n\n\t \n\tdc->res_pool->funcs->populate_dml_writeback_from_context(dc, res_ctx, pipes);\n\n\treturn pipe_cnt;\n}\n\nvoid dcn20_calculate_wm(struct dc *dc, struct dc_state *context,\n\t\t\tdisplay_e2e_pipe_params_st *pipes,\n\t\t\tint *out_pipe_cnt,\n\t\t\tint *pipe_split_from,\n\t\t\tint vlevel,\n\t\t\tbool fast_validate)\n{\n\tint pipe_cnt, i, pipe_idx;\n\n\tdc_assert_fp_enabled();\n\n\tfor (i = 0, pipe_idx = 0, pipe_cnt = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tif (!context->res_ctx.pipe_ctx[i].stream)\n\t\t\tcontinue;\n\n\t\tpipes[pipe_cnt].clks_cfg.refclk_mhz = dc->res_pool->ref_clocks.dchub_ref_clock_inKhz / 1000.0;\n\t\tpipes[pipe_cnt].clks_cfg.dispclk_mhz = context->bw_ctx.dml.vba.RequiredDISPCLK[vlevel][context->bw_ctx.dml.vba.maxMpcComb];\n\n\t\tif (pipe_split_from[i] < 0) {\n\t\t\tpipes[pipe_cnt].clks_cfg.dppclk_mhz =\n\t\t\t\t\tcontext->bw_ctx.dml.vba.RequiredDPPCLK[vlevel][context->bw_ctx.dml.vba.maxMpcComb][pipe_idx];\n\t\t\tif (context->bw_ctx.dml.vba.BlendingAndTiming[pipe_idx] == pipe_idx)\n\t\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine =\n\t\t\t\t\t\tcontext->bw_ctx.dml.vba.ODMCombineEnabled[pipe_idx];\n\t\t\telse\n\t\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine = 0;\n\t\t\tpipe_idx++;\n\t\t} else {\n\t\t\tpipes[pipe_cnt].clks_cfg.dppclk_mhz =\n\t\t\t\t\tcontext->bw_ctx.dml.vba.RequiredDPPCLK[vlevel][context->bw_ctx.dml.vba.maxMpcComb][pipe_split_from[i]];\n\t\t\tif (context->bw_ctx.dml.vba.BlendingAndTiming[pipe_split_from[i]] == pipe_split_from[i])\n\t\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine =\n\t\t\t\t\t\tcontext->bw_ctx.dml.vba.ODMCombineEnabled[pipe_split_from[i]];\n\t\t\telse\n\t\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine = 0;\n\t\t}\n\n\t\tif (dc->config.forced_clocks) {\n\t\t\tpipes[pipe_cnt].clks_cfg.dispclk_mhz = context->bw_ctx.dml.soc.clock_limits[0].dispclk_mhz;\n\t\t\tpipes[pipe_cnt].clks_cfg.dppclk_mhz = context->bw_ctx.dml.soc.clock_limits[0].dppclk_mhz;\n\t\t}\n\t\tif (dc->debug.min_disp_clk_khz > pipes[pipe_cnt].clks_cfg.dispclk_mhz * 1000)\n\t\t\tpipes[pipe_cnt].clks_cfg.dispclk_mhz = dc->debug.min_disp_clk_khz / 1000.0;\n\t\tif (dc->debug.min_dpp_clk_khz > pipes[pipe_cnt].clks_cfg.dppclk_mhz * 1000)\n\t\t\tpipes[pipe_cnt].clks_cfg.dppclk_mhz = dc->debug.min_dpp_clk_khz / 1000.0;\n\n\t\tpipe_cnt++;\n\t}\n\n\tif (pipe_cnt != pipe_idx) {\n\t\tif (dc->res_pool->funcs->populate_dml_pipes)\n\t\t\tpipe_cnt = dc->res_pool->funcs->populate_dml_pipes(dc,\n\t\t\t\tcontext, pipes, fast_validate);\n\t\telse\n\t\t\tpipe_cnt = dcn20_populate_dml_pipes_from_context(dc,\n\t\t\t\tcontext, pipes, fast_validate);\n\t}\n\n\t*out_pipe_cnt = pipe_cnt;\n\n\tpipes[0].clks_cfg.voltage = vlevel;\n\tpipes[0].clks_cfg.dcfclk_mhz = context->bw_ctx.dml.soc.clock_limits[vlevel].dcfclk_mhz;\n\tpipes[0].clks_cfg.socclk_mhz = context->bw_ctx.dml.soc.clock_limits[vlevel].socclk_mhz;\n\n\t \n\tif (vlevel < 1) {\n\t\tpipes[0].clks_cfg.voltage = 1;\n\t\tpipes[0].clks_cfg.dcfclk_mhz = context->bw_ctx.dml.soc.clock_limits[1].dcfclk_mhz;\n\t\tpipes[0].clks_cfg.socclk_mhz = context->bw_ctx.dml.soc.clock_limits[1].socclk_mhz;\n\t}\n\tcontext->bw_ctx.bw.dcn.watermarks.b.urgent_ns = get_wm_urgent(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.b.cstate_pstate.cstate_enter_plus_exit_ns = get_wm_stutter_enter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.b.cstate_pstate.cstate_exit_ns = get_wm_stutter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.b.cstate_pstate.pstate_change_ns = get_wm_dram_clock_change(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.b.pte_meta_urgent_ns = get_wm_memory_trip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.b.frac_urg_bw_nom = get_fraction_of_urgent_bandwidth(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.b.frac_urg_bw_flip = get_fraction_of_urgent_bandwidth_imm_flip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.b.urgent_latency_ns = get_urgent_latency(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\n\tif (vlevel < 2) {\n\t\tpipes[0].clks_cfg.voltage = 2;\n\t\tpipes[0].clks_cfg.dcfclk_mhz = context->bw_ctx.dml.soc.clock_limits[2].dcfclk_mhz;\n\t\tpipes[0].clks_cfg.socclk_mhz = context->bw_ctx.dml.soc.clock_limits[2].socclk_mhz;\n\t}\n\tcontext->bw_ctx.bw.dcn.watermarks.c.urgent_ns = get_wm_urgent(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.c.cstate_pstate.cstate_enter_plus_exit_ns = get_wm_stutter_enter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.c.cstate_pstate.cstate_exit_ns = get_wm_stutter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.c.cstate_pstate.pstate_change_ns = get_wm_dram_clock_change(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.c.pte_meta_urgent_ns = get_wm_memory_trip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.c.frac_urg_bw_nom = get_fraction_of_urgent_bandwidth(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.c.frac_urg_bw_flip = get_fraction_of_urgent_bandwidth_imm_flip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\n\tif (vlevel < 3) {\n\t\tpipes[0].clks_cfg.voltage = 3;\n\t\tpipes[0].clks_cfg.dcfclk_mhz = context->bw_ctx.dml.soc.clock_limits[2].dcfclk_mhz;\n\t\tpipes[0].clks_cfg.socclk_mhz = context->bw_ctx.dml.soc.clock_limits[2].socclk_mhz;\n\t}\n\tcontext->bw_ctx.bw.dcn.watermarks.d.urgent_ns = get_wm_urgent(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.d.cstate_pstate.cstate_enter_plus_exit_ns = get_wm_stutter_enter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.d.cstate_pstate.cstate_exit_ns = get_wm_stutter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.d.cstate_pstate.pstate_change_ns = get_wm_dram_clock_change(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.d.pte_meta_urgent_ns = get_wm_memory_trip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.d.frac_urg_bw_nom = get_fraction_of_urgent_bandwidth(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.d.frac_urg_bw_flip = get_fraction_of_urgent_bandwidth_imm_flip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\n\tpipes[0].clks_cfg.voltage = vlevel;\n\tpipes[0].clks_cfg.dcfclk_mhz = context->bw_ctx.dml.soc.clock_limits[vlevel].dcfclk_mhz;\n\tpipes[0].clks_cfg.socclk_mhz = context->bw_ctx.dml.soc.clock_limits[vlevel].socclk_mhz;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.urgent_ns = get_wm_urgent(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.cstate_pstate.cstate_enter_plus_exit_ns = get_wm_stutter_enter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.cstate_pstate.cstate_exit_ns = get_wm_stutter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.cstate_pstate.pstate_change_ns = get_wm_dram_clock_change(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.pte_meta_urgent_ns = get_wm_memory_trip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.frac_urg_bw_nom = get_fraction_of_urgent_bandwidth(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.frac_urg_bw_flip = get_fraction_of_urgent_bandwidth_imm_flip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n}\n\nvoid dcn20_update_bounding_box(struct dc *dc,\n\t\t\t       struct _vcs_dpi_soc_bounding_box_st *bb,\n\t\t\t       struct pp_smu_nv_clock_table *max_clocks,\n\t\t\t       unsigned int *uclk_states,\n\t\t\t       unsigned int num_states)\n{\n\tint num_calculated_states = 0;\n\tint min_dcfclk = 0;\n\tint i;\n\n\tdc_assert_fp_enabled();\n\n\tif (num_states == 0)\n\t\treturn;\n\n\tmemset(bb->clock_limits, 0, sizeof(bb->clock_limits));\n\n\tif (dc->bb_overrides.min_dcfclk_mhz > 0) {\n\t\tmin_dcfclk = dc->bb_overrides.min_dcfclk_mhz;\n\t} else {\n\t\tif (ASICREV_IS_NAVI12_P(dc->ctx->asic_id.hw_internal_rev))\n\t\t\tmin_dcfclk = 310;\n\t\telse\n\t\t\t\n\t\t\t\n\t\t\tmin_dcfclk = 506;\n\t}\n\n\tfor (i = 0; i < num_states; i++) {\n\t\tint min_fclk_required_by_uclk;\n\t\tbb->clock_limits[i].state = i;\n\t\tbb->clock_limits[i].dram_speed_mts = uclk_states[i] * 16 / 1000;\n\n\t\t\n\t\tmin_fclk_required_by_uclk = div_u64(((unsigned long long)uclk_states[i]) * 1080,\n\t\t\t1000000);\n\n\t\tbb->clock_limits[i].fabricclk_mhz = (min_fclk_required_by_uclk < min_dcfclk) ?\n\t\t\t\tmin_dcfclk : min_fclk_required_by_uclk;\n\n\t\tbb->clock_limits[i].socclk_mhz = (bb->clock_limits[i].fabricclk_mhz > max_clocks->socClockInKhz / 1000) ?\n\t\t\t\tmax_clocks->socClockInKhz / 1000 : bb->clock_limits[i].fabricclk_mhz;\n\n\t\tbb->clock_limits[i].dcfclk_mhz = (bb->clock_limits[i].fabricclk_mhz > max_clocks->dcfClockInKhz / 1000) ?\n\t\t\t\tmax_clocks->dcfClockInKhz / 1000 : bb->clock_limits[i].fabricclk_mhz;\n\n\t\tbb->clock_limits[i].dispclk_mhz = max_clocks->displayClockInKhz / 1000;\n\t\tbb->clock_limits[i].dppclk_mhz = max_clocks->displayClockInKhz / 1000;\n\t\tbb->clock_limits[i].dscclk_mhz = max_clocks->displayClockInKhz / (1000 * 3);\n\n\t\tbb->clock_limits[i].phyclk_mhz = max_clocks->phyClockInKhz / 1000;\n\n\t\tnum_calculated_states++;\n\t}\n\n\tbb->clock_limits[num_calculated_states - 1].socclk_mhz = max_clocks->socClockInKhz / 1000;\n\tbb->clock_limits[num_calculated_states - 1].fabricclk_mhz = max_clocks->socClockInKhz / 1000;\n\tbb->clock_limits[num_calculated_states - 1].dcfclk_mhz = max_clocks->dcfClockInKhz / 1000;\n\n\tbb->num_states = num_calculated_states;\n\n\t\n\tmemcpy(&bb->clock_limits[num_calculated_states], &bb->clock_limits[num_calculated_states - 1], sizeof(struct _vcs_dpi_voltage_scaling_st));\n\tbb->clock_limits[num_calculated_states].state = bb->num_states;\n}\n\nvoid dcn20_cap_soc_clocks(struct _vcs_dpi_soc_bounding_box_st *bb,\n\t\t\t  struct pp_smu_nv_clock_table max_clocks)\n{\n\tint i;\n\n\tdc_assert_fp_enabled();\n\n\t\n\tfor (i = 0; i < bb->num_states; i++) {\n\t\tif ((bb->clock_limits[i].dcfclk_mhz > (max_clocks.dcfClockInKhz / 1000))\n\t\t\t\t&& max_clocks.dcfClockInKhz != 0)\n\t\t\tbb->clock_limits[i].dcfclk_mhz = (max_clocks.dcfClockInKhz / 1000);\n\n\t\tif ((bb->clock_limits[i].dram_speed_mts > (max_clocks.uClockInKhz / 1000) * 16)\n\t\t\t\t\t\t&& max_clocks.uClockInKhz != 0)\n\t\t\tbb->clock_limits[i].dram_speed_mts = (max_clocks.uClockInKhz / 1000) * 16;\n\n\t\tif ((bb->clock_limits[i].fabricclk_mhz > (max_clocks.fabricClockInKhz / 1000))\n\t\t\t\t\t\t&& max_clocks.fabricClockInKhz != 0)\n\t\t\tbb->clock_limits[i].fabricclk_mhz = (max_clocks.fabricClockInKhz / 1000);\n\n\t\tif ((bb->clock_limits[i].dispclk_mhz > (max_clocks.displayClockInKhz / 1000))\n\t\t\t\t\t\t&& max_clocks.displayClockInKhz != 0)\n\t\t\tbb->clock_limits[i].dispclk_mhz = (max_clocks.displayClockInKhz / 1000);\n\n\t\tif ((bb->clock_limits[i].dppclk_mhz > (max_clocks.dppClockInKhz / 1000))\n\t\t\t\t\t\t&& max_clocks.dppClockInKhz != 0)\n\t\t\tbb->clock_limits[i].dppclk_mhz = (max_clocks.dppClockInKhz / 1000);\n\n\t\tif ((bb->clock_limits[i].phyclk_mhz > (max_clocks.phyClockInKhz / 1000))\n\t\t\t\t\t\t&& max_clocks.phyClockInKhz != 0)\n\t\t\tbb->clock_limits[i].phyclk_mhz = (max_clocks.phyClockInKhz / 1000);\n\n\t\tif ((bb->clock_limits[i].socclk_mhz > (max_clocks.socClockInKhz / 1000))\n\t\t\t\t\t\t&& max_clocks.socClockInKhz != 0)\n\t\t\tbb->clock_limits[i].socclk_mhz = (max_clocks.socClockInKhz / 1000);\n\n\t\tif ((bb->clock_limits[i].dscclk_mhz > (max_clocks.dscClockInKhz / 1000))\n\t\t\t\t\t\t&& max_clocks.dscClockInKhz != 0)\n\t\t\tbb->clock_limits[i].dscclk_mhz = (max_clocks.dscClockInKhz / 1000);\n\t}\n\n\t\n\tfor (i = bb->num_states - 1; i > 1; i--) {\n\t\tbool duplicate = true;\n\n\t\tif (bb->clock_limits[i-1].dcfclk_mhz != bb->clock_limits[i].dcfclk_mhz)\n\t\t\tduplicate = false;\n\t\tif (bb->clock_limits[i-1].dispclk_mhz != bb->clock_limits[i].dispclk_mhz)\n\t\t\tduplicate = false;\n\t\tif (bb->clock_limits[i-1].dppclk_mhz != bb->clock_limits[i].dppclk_mhz)\n\t\t\tduplicate = false;\n\t\tif (bb->clock_limits[i-1].dram_speed_mts != bb->clock_limits[i].dram_speed_mts)\n\t\t\tduplicate = false;\n\t\tif (bb->clock_limits[i-1].dscclk_mhz != bb->clock_limits[i].dscclk_mhz)\n\t\t\tduplicate = false;\n\t\tif (bb->clock_limits[i-1].fabricclk_mhz != bb->clock_limits[i].fabricclk_mhz)\n\t\t\tduplicate = false;\n\t\tif (bb->clock_limits[i-1].phyclk_mhz != bb->clock_limits[i].phyclk_mhz)\n\t\t\tduplicate = false;\n\t\tif (bb->clock_limits[i-1].socclk_mhz != bb->clock_limits[i].socclk_mhz)\n\t\t\tduplicate = false;\n\n\t\tif (duplicate)\n\t\t\tbb->num_states--;\n\t}\n}\n\nvoid dcn20_patch_bounding_box(struct dc *dc, struct _vcs_dpi_soc_bounding_box_st *bb)\n{\n\tdc_assert_fp_enabled();\n\n\tif ((int)(bb->sr_exit_time_us * 1000) != dc->bb_overrides.sr_exit_time_ns\n\t\t\t&& dc->bb_overrides.sr_exit_time_ns) {\n\t\tbb->sr_exit_time_us = dc->bb_overrides.sr_exit_time_ns / 1000.0;\n\t}\n\n\tif ((int)(bb->sr_enter_plus_exit_time_us * 1000)\n\t\t\t\t!= dc->bb_overrides.sr_enter_plus_exit_time_ns\n\t\t\t&& dc->bb_overrides.sr_enter_plus_exit_time_ns) {\n\t\tbb->sr_enter_plus_exit_time_us =\n\t\t\t\tdc->bb_overrides.sr_enter_plus_exit_time_ns / 1000.0;\n\t}\n\n\tif ((int)(bb->sr_exit_z8_time_us * 1000)\n\t\t\t\t!= dc->bb_overrides.sr_exit_z8_time_ns\n\t\t\t&& dc->bb_overrides.sr_exit_z8_time_ns) {\n\t\tbb->sr_exit_z8_time_us = dc->bb_overrides.sr_exit_z8_time_ns / 1000.0;\n\t}\n\n\tif ((int)(bb->sr_enter_plus_exit_z8_time_us * 1000)\n\t\t\t\t!= dc->bb_overrides.sr_enter_plus_exit_z8_time_ns\n\t\t\t&& dc->bb_overrides.sr_enter_plus_exit_z8_time_ns) {\n\t\tbb->sr_enter_plus_exit_z8_time_us = dc->bb_overrides.sr_enter_plus_exit_z8_time_ns / 1000.0;\n\t}\n\tif ((int)(bb->urgent_latency_us * 1000) != dc->bb_overrides.urgent_latency_ns\n\t\t\t&& dc->bb_overrides.urgent_latency_ns) {\n\t\tbb->urgent_latency_us = dc->bb_overrides.urgent_latency_ns / 1000.0;\n\t}\n\n\tif ((int)(bb->dram_clock_change_latency_us * 1000)\n\t\t\t\t!= dc->bb_overrides.dram_clock_change_latency_ns\n\t\t\t&& dc->bb_overrides.dram_clock_change_latency_ns) {\n\t\tbb->dram_clock_change_latency_us =\n\t\t\t\tdc->bb_overrides.dram_clock_change_latency_ns / 1000.0;\n\t}\n\n\tif ((int)(bb->dummy_pstate_latency_us * 1000)\n\t\t\t\t!= dc->bb_overrides.dummy_clock_change_latency_ns\n\t\t\t&& dc->bb_overrides.dummy_clock_change_latency_ns) {\n\t\tbb->dummy_pstate_latency_us =\n\t\t\t\tdc->bb_overrides.dummy_clock_change_latency_ns / 1000.0;\n\t}\n}\n\nstatic bool dcn20_validate_bandwidth_internal(struct dc *dc, struct dc_state *context,\n\t\tbool fast_validate)\n{\n\tbool out = false;\n\n\tBW_VAL_TRACE_SETUP();\n\n\tint vlevel = 0;\n\tint pipe_split_from[MAX_PIPES];\n\tint pipe_cnt = 0;\n\tdisplay_e2e_pipe_params_st *pipes = kzalloc(dc->res_pool->pipe_count * sizeof(display_e2e_pipe_params_st), GFP_ATOMIC);\n\tDC_LOGGER_INIT(dc->ctx->logger);\n\n\tBW_VAL_TRACE_COUNT();\n\n\tout = dcn20_fast_validate_bw(dc, context, pipes, &pipe_cnt, pipe_split_from, &vlevel, fast_validate);\n\n\tif (pipe_cnt == 0)\n\t\tgoto validate_out;\n\n\tif (!out)\n\t\tgoto validate_fail;\n\n\tBW_VAL_TRACE_END_VOLTAGE_LEVEL();\n\n\tif (fast_validate) {\n\t\tBW_VAL_TRACE_SKIP(fast);\n\t\tgoto validate_out;\n\t}\n\n\tdcn20_calculate_wm(dc, context, pipes, &pipe_cnt, pipe_split_from, vlevel, fast_validate);\n\tdcn20_calculate_dlg_params(dc, context, pipes, pipe_cnt, vlevel);\n\n\tBW_VAL_TRACE_END_WATERMARKS();\n\n\tgoto validate_out;\n\nvalidate_fail:\n\tDC_LOG_WARNING(\"Mode Validation Warning: %s failed validation.\\n\",\n\t\tdml_get_status_message(context->bw_ctx.dml.vba.ValidationStatus[context->bw_ctx.dml.vba.soc.num_states]));\n\n\tBW_VAL_TRACE_SKIP(fail);\n\tout = false;\n\nvalidate_out:\n\tkfree(pipes);\n\n\tBW_VAL_TRACE_FINISH();\n\n\treturn out;\n}\n\nbool dcn20_validate_bandwidth_fp(struct dc *dc,\n\t\t\t\t struct dc_state *context,\n\t\t\t\t bool fast_validate)\n{\n\tbool voltage_supported = false;\n\tbool full_pstate_supported = false;\n\tbool dummy_pstate_supported = false;\n\tdouble p_state_latency_us;\n\n\tdc_assert_fp_enabled();\n\n\tp_state_latency_us = context->bw_ctx.dml.soc.dram_clock_change_latency_us;\n\tcontext->bw_ctx.dml.soc.disable_dram_clock_change_vactive_support =\n\t\tdc->debug.disable_dram_clock_change_vactive_support;\n\tcontext->bw_ctx.dml.soc.allow_dram_clock_one_display_vactive =\n\t\tdc->debug.enable_dram_clock_change_one_display_vactive;\n\n\t \n\tASSERT(context != dc->current_state);\n\n\tif (fast_validate) {\n\t\treturn dcn20_validate_bandwidth_internal(dc, context, true);\n\t}\n\n\t\n\tvoltage_supported = dcn20_validate_bandwidth_internal(dc, context, false);\n\tfull_pstate_supported = context->bw_ctx.bw.dcn.clk.p_state_change_support;\n\n\tif (context->bw_ctx.dml.soc.dummy_pstate_latency_us == 0 ||\n\t\t(voltage_supported && full_pstate_supported)) {\n\t\tcontext->bw_ctx.bw.dcn.clk.p_state_change_support = full_pstate_supported;\n\t\tgoto restore_dml_state;\n\t}\n\n\t\n\tcontext->bw_ctx.dml.soc.dram_clock_change_latency_us = context->bw_ctx.dml.soc.dummy_pstate_latency_us;\n\n\tvoltage_supported = dcn20_validate_bandwidth_internal(dc, context, false);\n\tdummy_pstate_supported = context->bw_ctx.bw.dcn.clk.p_state_change_support;\n\n\tif (voltage_supported && (dummy_pstate_supported || !(context->stream_count))) {\n\t\tcontext->bw_ctx.bw.dcn.clk.p_state_change_support = false;\n\t\tgoto restore_dml_state;\n\t}\n\n\t\n\tASSERT(false);\n\nrestore_dml_state:\n\tcontext->bw_ctx.dml.soc.dram_clock_change_latency_us = p_state_latency_us;\n\treturn voltage_supported;\n}\n\nvoid dcn20_fpu_set_wm_ranges(int i,\n\t\t\t     struct pp_smu_wm_range_sets *ranges,\n\t\t\t     struct _vcs_dpi_soc_bounding_box_st *loaded_bb)\n{\n\tdc_assert_fp_enabled();\n\n\tranges->reader_wm_sets[i].min_fill_clk_mhz = (i > 0) ? (loaded_bb->clock_limits[i - 1].dram_speed_mts / 16) + 1 : 0;\n\tranges->reader_wm_sets[i].max_fill_clk_mhz = loaded_bb->clock_limits[i].dram_speed_mts / 16;\n}\n\nvoid dcn20_fpu_adjust_dppclk(struct vba_vars_st *v,\n\t\t\t     int vlevel,\n\t\t\t     int max_mpc_comb,\n\t\t\t     int pipe_idx,\n\t\t\t     bool is_validating_bw)\n{\n\tdc_assert_fp_enabled();\n\n\tif (is_validating_bw)\n\t\tv->RequiredDPPCLK[vlevel][max_mpc_comb][pipe_idx] *= 2;\n\telse\n\t\tv->RequiredDPPCLK[vlevel][max_mpc_comb][pipe_idx] /= 2;\n}\n\nint dcn21_populate_dml_pipes_from_context(struct dc *dc,\n\t\t\t\t\t  struct dc_state *context,\n\t\t\t\t\t  display_e2e_pipe_params_st *pipes,\n\t\t\t\t\t  bool fast_validate)\n{\n\tuint32_t pipe_cnt;\n\tint i;\n\n\tdc_assert_fp_enabled();\n\n\tpipe_cnt = dcn20_populate_dml_pipes_from_context(dc, context, pipes, fast_validate);\n\n\tfor (i = 0; i < pipe_cnt; i++) {\n\n\t\tpipes[i].pipe.src.hostvm = dc->res_pool->hubbub->riommu_active;\n\t\tpipes[i].pipe.src.gpuvm = 1;\n\t}\n\n\treturn pipe_cnt;\n}\n\nstatic void patch_bounding_box(struct dc *dc, struct _vcs_dpi_soc_bounding_box_st *bb)\n{\n\tint i;\n\n\tif (dc->bb_overrides.sr_exit_time_ns) {\n\t\tfor (i = 0; i < WM_SET_COUNT; i++) {\n\t\t\t  dc->clk_mgr->bw_params->wm_table.entries[i].sr_exit_time_us =\n\t\t\t\t\t  dc->bb_overrides.sr_exit_time_ns / 1000.0;\n\t\t}\n\t}\n\n\tif (dc->bb_overrides.sr_enter_plus_exit_time_ns) {\n\t\tfor (i = 0; i < WM_SET_COUNT; i++) {\n\t\t\t  dc->clk_mgr->bw_params->wm_table.entries[i].sr_enter_plus_exit_time_us =\n\t\t\t\t\t  dc->bb_overrides.sr_enter_plus_exit_time_ns / 1000.0;\n\t\t}\n\t}\n\n\tif (dc->bb_overrides.urgent_latency_ns) {\n\t\tbb->urgent_latency_us = dc->bb_overrides.urgent_latency_ns / 1000.0;\n\t}\n\n\tif (dc->bb_overrides.dram_clock_change_latency_ns) {\n\t\tfor (i = 0; i < WM_SET_COUNT; i++) {\n\t\t\tdc->clk_mgr->bw_params->wm_table.entries[i].pstate_latency_us =\n\t\t\t\tdc->bb_overrides.dram_clock_change_latency_ns / 1000.0;\n\t\t}\n\t}\n}\n\nstatic void calculate_wm_set_for_vlevel(int vlevel,\n\t\t\t\t\tstruct wm_range_table_entry *table_entry,\n\t\t\t\t\tstruct dcn_watermarks *wm_set,\n\t\t\t\t\tstruct display_mode_lib *dml,\n\t\t\t\t\tdisplay_e2e_pipe_params_st *pipes,\n\t\t\t\t\tint pipe_cnt)\n{\n\tdouble dram_clock_change_latency_cached = dml->soc.dram_clock_change_latency_us;\n\n\tASSERT(vlevel < dml->soc.num_states);\n\t \n\tpipes[0].clks_cfg.voltage = vlevel;\n\tpipes[0].clks_cfg.dcfclk_mhz = dml->soc.clock_limits[vlevel].dcfclk_mhz;\n\tpipes[0].clks_cfg.socclk_mhz = dml->soc.clock_limits[vlevel].socclk_mhz;\n\n\tdml->soc.dram_clock_change_latency_us = table_entry->pstate_latency_us;\n\tdml->soc.sr_exit_time_us = table_entry->sr_exit_time_us;\n\tdml->soc.sr_enter_plus_exit_time_us = table_entry->sr_enter_plus_exit_time_us;\n\n\twm_set->urgent_ns = get_wm_urgent(dml, pipes, pipe_cnt) * 1000;\n\twm_set->cstate_pstate.cstate_enter_plus_exit_ns = get_wm_stutter_enter_exit(dml, pipes, pipe_cnt) * 1000;\n\twm_set->cstate_pstate.cstate_exit_ns = get_wm_stutter_exit(dml, pipes, pipe_cnt) * 1000;\n\twm_set->cstate_pstate.pstate_change_ns = get_wm_dram_clock_change(dml, pipes, pipe_cnt) * 1000;\n\twm_set->pte_meta_urgent_ns = get_wm_memory_trip(dml, pipes, pipe_cnt) * 1000;\n\twm_set->frac_urg_bw_nom = get_fraction_of_urgent_bandwidth(dml, pipes, pipe_cnt) * 1000;\n\twm_set->frac_urg_bw_flip = get_fraction_of_urgent_bandwidth_imm_flip(dml, pipes, pipe_cnt) * 1000;\n\twm_set->urgent_latency_ns = get_urgent_latency(dml, pipes, pipe_cnt) * 1000;\n\tdml->soc.dram_clock_change_latency_us = dram_clock_change_latency_cached;\n}\n\nstatic void dcn21_calculate_wm(struct dc *dc, struct dc_state *context,\n\t\t\tdisplay_e2e_pipe_params_st *pipes,\n\t\t\tint *out_pipe_cnt,\n\t\t\tint *pipe_split_from,\n\t\t\tint vlevel_req,\n\t\t\tbool fast_validate)\n{\n\tint pipe_cnt, i, pipe_idx;\n\tint vlevel, vlevel_max;\n\tstruct wm_range_table_entry *table_entry;\n\tstruct clk_bw_params *bw_params = dc->clk_mgr->bw_params;\n\n\tASSERT(bw_params);\n\n\tpatch_bounding_box(dc, &context->bw_ctx.dml.soc);\n\n\tfor (i = 0, pipe_idx = 0, pipe_cnt = 0; i < dc->res_pool->pipe_count; i++) {\n\t\t\tif (!context->res_ctx.pipe_ctx[i].stream)\n\t\t\t\tcontinue;\n\n\t\t\tpipes[pipe_cnt].clks_cfg.refclk_mhz = dc->res_pool->ref_clocks.dchub_ref_clock_inKhz / 1000.0;\n\t\t\tpipes[pipe_cnt].clks_cfg.dispclk_mhz = context->bw_ctx.dml.vba.RequiredDISPCLK[vlevel_req][context->bw_ctx.dml.vba.maxMpcComb];\n\n\t\t\tif (pipe_split_from[i] < 0) {\n\t\t\t\tpipes[pipe_cnt].clks_cfg.dppclk_mhz =\n\t\t\t\t\t\tcontext->bw_ctx.dml.vba.RequiredDPPCLK[vlevel_req][context->bw_ctx.dml.vba.maxMpcComb][pipe_idx];\n\t\t\t\tif (context->bw_ctx.dml.vba.BlendingAndTiming[pipe_idx] == pipe_idx)\n\t\t\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine =\n\t\t\t\t\t\t\tcontext->bw_ctx.dml.vba.ODMCombineEnablePerState[vlevel_req][pipe_idx];\n\t\t\t\telse\n\t\t\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine = 0;\n\t\t\t\tpipe_idx++;\n\t\t\t} else {\n\t\t\t\tpipes[pipe_cnt].clks_cfg.dppclk_mhz =\n\t\t\t\t\t\tcontext->bw_ctx.dml.vba.RequiredDPPCLK[vlevel_req][context->bw_ctx.dml.vba.maxMpcComb][pipe_split_from[i]];\n\t\t\t\tif (context->bw_ctx.dml.vba.BlendingAndTiming[pipe_split_from[i]] == pipe_split_from[i])\n\t\t\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine =\n\t\t\t\t\t\t\tcontext->bw_ctx.dml.vba.ODMCombineEnablePerState[vlevel_req][pipe_split_from[i]];\n\t\t\t\telse\n\t\t\t\t\tpipes[pipe_cnt].pipe.dest.odm_combine = 0;\n\t\t\t}\n\t\t\tpipe_cnt++;\n\t}\n\n\tif (pipe_cnt != pipe_idx) {\n\t\tif (dc->res_pool->funcs->populate_dml_pipes)\n\t\t\tpipe_cnt = dc->res_pool->funcs->populate_dml_pipes(dc,\n\t\t\t\tcontext, pipes, fast_validate);\n\t\telse\n\t\t\tpipe_cnt = dcn21_populate_dml_pipes_from_context(dc,\n\t\t\t\tcontext, pipes, fast_validate);\n\t}\n\n\t*out_pipe_cnt = pipe_cnt;\n\n\tvlevel_max = bw_params->clk_table.num_entries - 1;\n\n\n\t \n\ttable_entry = &bw_params->wm_table.entries[WM_D];\n\tif (table_entry->wm_type == WM_TYPE_RETRAINING)\n\t\tvlevel = 0;\n\telse\n\t\tvlevel = vlevel_max;\n\tcalculate_wm_set_for_vlevel(vlevel, table_entry, &context->bw_ctx.bw.dcn.watermarks.d,\n\t\t\t\t\t\t&context->bw_ctx.dml, pipes, pipe_cnt);\n\t \n\ttable_entry = &bw_params->wm_table.entries[WM_C];\n\tvlevel = MIN(MAX(vlevel_req, 3), vlevel_max);\n\tcalculate_wm_set_for_vlevel(vlevel, table_entry, &context->bw_ctx.bw.dcn.watermarks.c,\n\t\t\t\t\t\t&context->bw_ctx.dml, pipes, pipe_cnt);\n\t \n\ttable_entry = &bw_params->wm_table.entries[WM_B];\n\tvlevel = MIN(MAX(vlevel_req, 2), vlevel_max);\n\tcalculate_wm_set_for_vlevel(vlevel, table_entry, &context->bw_ctx.bw.dcn.watermarks.b,\n\t\t\t\t\t\t&context->bw_ctx.dml, pipes, pipe_cnt);\n\n\t \n\ttable_entry = &bw_params->wm_table.entries[WM_A];\n\tvlevel = MIN(vlevel_req, vlevel_max);\n\tcalculate_wm_set_for_vlevel(vlevel, table_entry, &context->bw_ctx.bw.dcn.watermarks.a,\n\t\t\t\t\t\t&context->bw_ctx.dml, pipes, pipe_cnt);\n}\n\nbool dcn21_validate_bandwidth_fp(struct dc *dc,\n\t\t\t\t struct dc_state *context,\n\t\t\t\t bool fast_validate)\n{\n\tbool out = false;\n\n\tBW_VAL_TRACE_SETUP();\n\n\tint vlevel = 0;\n\tint pipe_split_from[MAX_PIPES];\n\tint pipe_cnt = 0;\n\tdisplay_e2e_pipe_params_st *pipes = kzalloc(dc->res_pool->pipe_count * sizeof(display_e2e_pipe_params_st), GFP_ATOMIC);\n\tDC_LOGGER_INIT(dc->ctx->logger);\n\n\tBW_VAL_TRACE_COUNT();\n\n\tdc_assert_fp_enabled();\n\n\t \n\tASSERT(context != dc->current_state);\n\n\tout = dcn21_fast_validate_bw(dc, context, pipes, &pipe_cnt, pipe_split_from, &vlevel, fast_validate);\n\n\tif (pipe_cnt == 0)\n\t\tgoto validate_out;\n\n\tif (!out)\n\t\tgoto validate_fail;\n\n\tBW_VAL_TRACE_END_VOLTAGE_LEVEL();\n\n\tif (fast_validate) {\n\t\tBW_VAL_TRACE_SKIP(fast);\n\t\tgoto validate_out;\n\t}\n\n\tdcn21_calculate_wm(dc, context, pipes, &pipe_cnt, pipe_split_from, vlevel, fast_validate);\n\tdcn20_calculate_dlg_params(dc, context, pipes, pipe_cnt, vlevel);\n\n\tBW_VAL_TRACE_END_WATERMARKS();\n\n\tgoto validate_out;\n\nvalidate_fail:\n\tDC_LOG_WARNING(\"Mode Validation Warning: %s failed validation.\\n\",\n\t\t\tdml_get_status_message(context->bw_ctx.dml.vba.ValidationStatus[context->bw_ctx.dml.vba.soc.num_states]));\n\n\tBW_VAL_TRACE_SKIP(fail);\n\tout = false;\n\nvalidate_out:\n\tkfree(pipes);\n\n\tBW_VAL_TRACE_FINISH();\n\n\treturn out;\n}\n\nstatic struct _vcs_dpi_voltage_scaling_st construct_low_pstate_lvl(struct clk_limit_table *clk_table, unsigned int high_voltage_lvl)\n{\n\tstruct _vcs_dpi_voltage_scaling_st low_pstate_lvl;\n\tint i;\n\n\tlow_pstate_lvl.state = 1;\n\tlow_pstate_lvl.dcfclk_mhz = clk_table->entries[0].dcfclk_mhz;\n\tlow_pstate_lvl.fabricclk_mhz = clk_table->entries[0].fclk_mhz;\n\tlow_pstate_lvl.socclk_mhz = clk_table->entries[0].socclk_mhz;\n\tlow_pstate_lvl.dram_speed_mts = clk_table->entries[0].memclk_mhz * 2;\n\n\tlow_pstate_lvl.dispclk_mhz = dcn2_1_soc.clock_limits[high_voltage_lvl].dispclk_mhz;\n\tlow_pstate_lvl.dppclk_mhz = dcn2_1_soc.clock_limits[high_voltage_lvl].dppclk_mhz;\n\tlow_pstate_lvl.dram_bw_per_chan_gbps = dcn2_1_soc.clock_limits[high_voltage_lvl].dram_bw_per_chan_gbps;\n\tlow_pstate_lvl.dscclk_mhz = dcn2_1_soc.clock_limits[high_voltage_lvl].dscclk_mhz;\n\tlow_pstate_lvl.dtbclk_mhz = dcn2_1_soc.clock_limits[high_voltage_lvl].dtbclk_mhz;\n\tlow_pstate_lvl.phyclk_d18_mhz = dcn2_1_soc.clock_limits[high_voltage_lvl].phyclk_d18_mhz;\n\tlow_pstate_lvl.phyclk_mhz = dcn2_1_soc.clock_limits[high_voltage_lvl].phyclk_mhz;\n\n\tfor (i = clk_table->num_entries; i > 1; i--)\n\t\tclk_table->entries[i] = clk_table->entries[i-1];\n\tclk_table->entries[1] = clk_table->entries[0];\n\tclk_table->num_entries++;\n\n\treturn low_pstate_lvl;\n}\n\nvoid dcn21_update_bw_bounding_box(struct dc *dc, struct clk_bw_params *bw_params)\n{\n\tstruct _vcs_dpi_voltage_scaling_st *s = dc->scratch.update_bw_bounding_box.clock_limits;\n\tstruct dcn21_resource_pool *pool = TO_DCN21_RES_POOL(dc->res_pool);\n\tstruct clk_limit_table *clk_table = &bw_params->clk_table;\n\tunsigned int i, closest_clk_lvl = 0, k = 0;\n\tint j;\n\n\tdc_assert_fp_enabled();\n\n\tdcn2_1_ip.max_num_otg = pool->base.res_cap->num_timing_generator;\n\tdcn2_1_ip.max_num_dpp = pool->base.pipe_count;\n\tdcn2_1_soc.num_chans = bw_params->num_channels;\n\n\tASSERT(clk_table->num_entries);\n\t \n\tmemcpy(s, dcn2_1_soc.clock_limits, sizeof(dcn2_1_soc.clock_limits));\n\n\tfor (i = 0; i < clk_table->num_entries; i++) {\n\t\t \n\t\tfor (closest_clk_lvl = 0, j = dcn2_1_soc.num_states - 1; j >= 0; j--) {\n\t\t\tif ((unsigned int) dcn2_1_soc.clock_limits[j].dcfclk_mhz <= clk_table->entries[i].dcfclk_mhz) {\n\t\t\t\tclosest_clk_lvl = j;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tif (i == 1)\n\t\t\tk++;\n\n\t\ts[k].state = k;\n\t\ts[k].dcfclk_mhz = clk_table->entries[i].dcfclk_mhz;\n\t\ts[k].fabricclk_mhz = clk_table->entries[i].fclk_mhz;\n\t\ts[k].socclk_mhz = clk_table->entries[i].socclk_mhz;\n\t\ts[k].dram_speed_mts = clk_table->entries[i].memclk_mhz * 2;\n\n\t\ts[k].dispclk_mhz = dcn2_1_soc.clock_limits[closest_clk_lvl].dispclk_mhz;\n\t\ts[k].dppclk_mhz = dcn2_1_soc.clock_limits[closest_clk_lvl].dppclk_mhz;\n\t\ts[k].dram_bw_per_chan_gbps =\n\t\t\tdcn2_1_soc.clock_limits[closest_clk_lvl].dram_bw_per_chan_gbps;\n\t\ts[k].dscclk_mhz = dcn2_1_soc.clock_limits[closest_clk_lvl].dscclk_mhz;\n\t\ts[k].dtbclk_mhz = dcn2_1_soc.clock_limits[closest_clk_lvl].dtbclk_mhz;\n\t\ts[k].phyclk_d18_mhz = dcn2_1_soc.clock_limits[closest_clk_lvl].phyclk_d18_mhz;\n\t\ts[k].phyclk_mhz = dcn2_1_soc.clock_limits[closest_clk_lvl].phyclk_mhz;\n\n\t\tk++;\n\t}\n\n\tmemcpy(&dcn2_1_soc.clock_limits, s, sizeof(dcn2_1_soc.clock_limits));\n\n\tif (clk_table->num_entries) {\n\t\tdcn2_1_soc.num_states = clk_table->num_entries + 1;\n\t\t \n\t\tdcn2_1_soc.clock_limits[1] = construct_low_pstate_lvl(clk_table, closest_clk_lvl);\n\t\t \n\t\tdcn2_1_soc.clock_limits[dcn2_1_soc.num_states] = dcn2_1_soc.clock_limits[dcn2_1_soc.num_states - 1];\n\t\tdcn2_1_soc.clock_limits[dcn2_1_soc.num_states].state = dcn2_1_soc.num_states;\n\t}\n\n\tdml_init_instance(&dc->dml, &dcn2_1_soc, &dcn2_1_ip, DML_PROJECT_DCN21);\n}\n\nvoid dcn21_clk_mgr_set_bw_params_wm_table(struct clk_bw_params *bw_params)\n{\n\tdc_assert_fp_enabled();\n\n\tbw_params->wm_table.entries[WM_D].pstate_latency_us = LPDDR_MEM_RETRAIN_LATENCY;\n\tbw_params->wm_table.entries[WM_D].wm_inst = WM_D;\n\tbw_params->wm_table.entries[WM_D].wm_type = WM_TYPE_RETRAINING;\n\tbw_params->wm_table.entries[WM_D].valid = true;\n}\n\nvoid dcn201_populate_dml_writeback_from_context_fpu(struct dc *dc,\n\t\t\t\t\t\t    struct resource_context *res_ctx,\n\t\t\t\t\t\t    display_e2e_pipe_params_st *pipes)\n{\n\tint pipe_cnt, i, j;\n\tdouble max_calc_writeback_dispclk;\n\tdouble writeback_dispclk;\n\tstruct writeback_st dout_wb;\n\n\tdc_assert_fp_enabled();\n\n\tfor (i = 0, pipe_cnt = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tstruct dc_stream_state *stream = res_ctx->pipe_ctx[i].stream;\n\n\t\tif (!stream)\n\t\t\tcontinue;\n\t\tmax_calc_writeback_dispclk = 0;\n\n\t\t \n\t\tpipes[pipe_cnt].dout.wb_enable = 0;\n\t\tpipes[pipe_cnt].dout.num_active_wb = 0;\n\t\tfor (j = 0; j < stream->num_wb_info; j++) {\n\t\t\tstruct dc_writeback_info *wb_info = &stream->writeback_info[j];\n\n\t\t\tif (wb_info->wb_enabled && wb_info->writeback_source_plane &&\n\t\t\t\t\t(wb_info->writeback_source_plane == res_ctx->pipe_ctx[i].plane_state)) {\n\t\t\t\tpipes[pipe_cnt].dout.wb_enable = 1;\n\t\t\t\tpipes[pipe_cnt].dout.num_active_wb++;\n\t\t\t\tdout_wb.wb_src_height = wb_info->dwb_params.cnv_params.crop_en ?\n\t\t\t\t\twb_info->dwb_params.cnv_params.crop_height :\n\t\t\t\t\twb_info->dwb_params.cnv_params.src_height;\n\t\t\t\tdout_wb.wb_src_width = wb_info->dwb_params.cnv_params.crop_en ?\n\t\t\t\t\twb_info->dwb_params.cnv_params.crop_width :\n\t\t\t\t\twb_info->dwb_params.cnv_params.src_width;\n\t\t\t\tdout_wb.wb_dst_width = wb_info->dwb_params.dest_width;\n\t\t\t\tdout_wb.wb_dst_height = wb_info->dwb_params.dest_height;\n\t\t\t\tdout_wb.wb_htaps_luma = wb_info->dwb_params.scaler_taps.h_taps;\n\t\t\t\tdout_wb.wb_vtaps_luma = wb_info->dwb_params.scaler_taps.v_taps;\n\t\t\t\tdout_wb.wb_htaps_chroma = wb_info->dwb_params.scaler_taps.h_taps_c;\n\t\t\t\tdout_wb.wb_vtaps_chroma = wb_info->dwb_params.scaler_taps.v_taps_c;\n\t\t\t\tdout_wb.wb_hratio = wb_info->dwb_params.cnv_params.crop_en ?\n\t\t\t\t\t(double)wb_info->dwb_params.cnv_params.crop_width /\n\t\t\t\t\t\t(double)wb_info->dwb_params.dest_width :\n\t\t\t\t\t(double)wb_info->dwb_params.cnv_params.src_width /\n\t\t\t\t\t\t(double)wb_info->dwb_params.dest_width;\n\t\t\t\tdout_wb.wb_vratio = wb_info->dwb_params.cnv_params.crop_en ?\n\t\t\t\t\t(double)wb_info->dwb_params.cnv_params.crop_height /\n\t\t\t\t\t\t(double)wb_info->dwb_params.dest_height :\n\t\t\t\t\t(double)wb_info->dwb_params.cnv_params.src_height /\n\t\t\t\t\t\t(double)wb_info->dwb_params.dest_height;\n\t\t\t\tif (wb_info->dwb_params.out_format == dwb_scaler_mode_yuv420) {\n\t\t\t\t\tif (wb_info->dwb_params.output_depth == DWB_OUTPUT_PIXEL_DEPTH_8BPC)\n\t\t\t\t\t\tdout_wb.wb_pixel_format = dm_420_8;\n\t\t\t\t\telse\n\t\t\t\t\t\tdout_wb.wb_pixel_format = dm_420_10;\n\t\t\t\t} else\n\t\t\t\t\tdout_wb.wb_pixel_format = dm_444_32;\n\n\t\t\t\t \n\t\t\t\twriteback_dispclk = CalculateWriteBackDISPCLK(\n\t\t\t\t\t\tdout_wb.wb_pixel_format,\n\t\t\t\t\t\tpipes[pipe_cnt].pipe.dest.pixel_rate_mhz,\n\t\t\t\t\t\tdout_wb.wb_hratio,\n\t\t\t\t\t\tdout_wb.wb_vratio,\n\t\t\t\t\t\tdout_wb.wb_htaps_luma,\n\t\t\t\t\t\tdout_wb.wb_vtaps_luma,\n\t\t\t\t\t\tdout_wb.wb_htaps_chroma,\n\t\t\t\t\t\tdout_wb.wb_vtaps_chroma,\n\t\t\t\t\t\tdout_wb.wb_dst_width,\n\t\t\t\t\t\tpipes[pipe_cnt].pipe.dest.htotal,\n\t\t\t\t\t\t2);\n\n\t\t\t\tif (writeback_dispclk > max_calc_writeback_dispclk) {\n\t\t\t\t\tmax_calc_writeback_dispclk = writeback_dispclk;\n\t\t\t\t\tpipes[pipe_cnt].dout.wb = dout_wb;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tpipe_cnt++;\n\t}\n\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}