{
  "module_name": "dcn20_dpp.c",
  "hash_id": "0ebee4a2ecc02cd5e056afb517d737ffdef9cc29171719878339a8a6fcfcaf11",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn20/dcn20_dpp.c",
  "human_readable_source": " \n\n#include \"dm_services.h\"\n\n#include \"core_types.h\"\n\n#include \"reg_helper.h\"\n#include \"dcn20_dpp.h\"\n#include \"basics/conversion.h\"\n\n#define NUM_PHASES    64\n#define HORZ_MAX_TAPS 8\n#define VERT_MAX_TAPS 8\n\n#define BLACK_OFFSET_RGB_Y 0x0\n#define BLACK_OFFSET_CBCR  0x8000\n\n#define REG(reg)\\\n\tdpp->tf_regs->reg\n\n#define CTX \\\n\tdpp->base.ctx\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\tdpp->tf_shift->field_name, dpp->tf_mask->field_name\n\nvoid dpp20_read_state(struct dpp *dpp_base,\n\t\tstruct dcn_dpp_state *s)\n{\n\tstruct dcn20_dpp *dpp = TO_DCN20_DPP(dpp_base);\n\n\tREG_GET(DPP_CONTROL,\n\t\t\tDPP_CLOCK_ENABLE, &s->is_enabled);\n\tREG_GET(CM_DGAM_CONTROL,\n\t\t\tCM_DGAM_LUT_MODE, &s->dgam_lut_mode);\n\t\n\t\n\t\n\tREG_GET(CM_GAMUT_REMAP_CONTROL,\n\t\t\tCM_GAMUT_REMAP_MODE, &s->gamut_remap_mode);\n\tif (s->gamut_remap_mode) {\n\t\ts->gamut_remap_c11_c12 = REG_READ(CM_GAMUT_REMAP_C11_C12);\n\t\ts->gamut_remap_c13_c14 = REG_READ(CM_GAMUT_REMAP_C13_C14);\n\t\ts->gamut_remap_c21_c22 = REG_READ(CM_GAMUT_REMAP_C21_C22);\n\t\ts->gamut_remap_c23_c24 = REG_READ(CM_GAMUT_REMAP_C23_C24);\n\t\ts->gamut_remap_c31_c32 = REG_READ(CM_GAMUT_REMAP_C31_C32);\n\t\ts->gamut_remap_c33_c34 = REG_READ(CM_GAMUT_REMAP_C33_C34);\n\t}\n}\n\nvoid dpp2_power_on_obuf(\n\t\tstruct dpp *dpp_base,\n\tbool power_on)\n{\n\tstruct dcn20_dpp *dpp = TO_DCN20_DPP(dpp_base);\n\n\tREG_UPDATE(CM_MEM_PWR_CTRL, SHARED_MEM_PWR_DIS, power_on == true ? 1:0);\n\n\tREG_UPDATE(OBUF_MEM_PWR_CTRL,\n\t\t\tOBUF_MEM_PWR_FORCE, power_on == true ? 0:1);\n\n\tREG_UPDATE(DSCL_MEM_PWR_CTRL,\n\t\t\tLUT_MEM_PWR_FORCE, power_on == true ? 0:1);\n}\n\nvoid dpp2_dummy_program_input_lut(\n\t\tstruct dpp *dpp_base,\n\t\tconst struct dc_gamma *gamma)\n{}\n\nstatic void dpp2_cnv_setup (\n\t\tstruct dpp *dpp_base,\n\t\tenum surface_pixel_format format,\n\t\tenum expansion_mode mode,\n\t\tstruct dc_csc_transform input_csc_color_matrix,\n\t\tenum dc_color_space input_color_space,\n\t\tstruct cnv_alpha_2bit_lut *alpha_2bit_lut)\n{\n\tstruct dcn20_dpp *dpp = TO_DCN20_DPP(dpp_base);\n\tuint32_t pixel_format = 0;\n\tuint32_t alpha_en = 1;\n\tenum dc_color_space color_space = COLOR_SPACE_SRGB;\n\tenum dcn20_input_csc_select select = DCN2_ICSC_SELECT_BYPASS;\n\tbool force_disable_cursor = false;\n\tstruct out_csc_color_matrix tbl_entry;\n\tuint32_t is_2bit = 0;\n\tint i = 0;\n\n\tREG_SET_2(FORMAT_CONTROL, 0,\n\t\tCNVC_BYPASS, 0,\n\t\tFORMAT_EXPANSION_MODE, mode);\n\n\t\n    \n    \n    \n    \n\tREG_UPDATE(FORMAT_CONTROL, FORMAT_CNV16, 0);\n\tREG_UPDATE(FORMAT_CONTROL, CNVC_BYPASS_MSB_ALIGN, 0);\n\tREG_UPDATE(FORMAT_CONTROL, CLAMP_POSITIVE, 0);\n\tREG_UPDATE(FORMAT_CONTROL, CLAMP_POSITIVE_C, 0);\n\n\tswitch (format) {\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB1555:\n\t\tpixel_format = 1;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB565:\n\t\tpixel_format = 3;\n\t\talpha_en = 0;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB8888:\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR8888:\n\t\tpixel_format = 8;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB2101010:\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR2101010:\n\t\tpixel_format = 10;\n\t\tis_2bit = 1;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCbCr:\n\t\tforce_disable_cursor = false;\n\t\tpixel_format = 65;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = DCN2_ICSC_SELECT_ICSC_A;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCrCb:\n\t\tforce_disable_cursor = true;\n\t\tpixel_format = 64;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = DCN2_ICSC_SELECT_ICSC_A;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCbCr:\n\t\tforce_disable_cursor = true;\n\t\tpixel_format = 67;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = DCN2_ICSC_SELECT_ICSC_A;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCrCb:\n\t\tforce_disable_cursor = true;\n\t\tpixel_format = 66;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = DCN2_ICSC_SELECT_ICSC_A;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616:\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616:\n\t\tpixel_format = 26;  \n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616F:\n\t\tpixel_format = 24;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616F:\n\t\tpixel_format = 25;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_AYCrCb8888:\n\t\tpixel_format = 12;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = DCN2_ICSC_SELECT_ICSC_A;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB111110_FIX:\n\t\tpixel_format = 112;\n\t\talpha_en = 0;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_BGR101111_FIX:\n\t\tpixel_format = 113;\n\t\talpha_en = 0;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_ACrYCb2101010:\n\t\tpixel_format = 114;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = DCN2_ICSC_SELECT_ICSC_A;\n\t\tis_2bit = 1;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_CrYCbA1010102:\n\t\tpixel_format = 115;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = DCN2_ICSC_SELECT_ICSC_A;\n\t\tis_2bit = 1;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB111110_FLOAT:\n\t\tpixel_format = 118;\n\t\talpha_en = 0;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_BGR101111_FLOAT:\n\t\tpixel_format = 119;\n\t\talpha_en = 0;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\t \n\tcolor_space = input_color_space ? input_color_space : color_space;\n\n\tif (is_2bit == 1 && alpha_2bit_lut != NULL) {\n\t\tREG_UPDATE(ALPHA_2BIT_LUT, ALPHA_2BIT_LUT0, alpha_2bit_lut->lut0);\n\t\tREG_UPDATE(ALPHA_2BIT_LUT, ALPHA_2BIT_LUT1, alpha_2bit_lut->lut1);\n\t\tREG_UPDATE(ALPHA_2BIT_LUT, ALPHA_2BIT_LUT2, alpha_2bit_lut->lut2);\n\t\tREG_UPDATE(ALPHA_2BIT_LUT, ALPHA_2BIT_LUT3, alpha_2bit_lut->lut3);\n\t}\n\n\tREG_SET(CNVC_SURFACE_PIXEL_FORMAT, 0,\n\t\t\tCNVC_SURFACE_PIXEL_FORMAT, pixel_format);\n\tREG_UPDATE(FORMAT_CONTROL, FORMAT_CONTROL__ALPHA_EN, alpha_en);\n\n\t\n\tif (input_csc_color_matrix.enable_adjustment\n\t\t\t\t== true) {\n\t\tfor (i = 0; i < 12; i++)\n\t\t\ttbl_entry.regval[i] = input_csc_color_matrix.matrix[i];\n\n\t\ttbl_entry.color_space = input_color_space;\n\n\t\tif (color_space >= COLOR_SPACE_YCBCR601)\n\t\t\tselect = DCN2_ICSC_SELECT_ICSC_A;\n\t\telse\n\t\t\tselect = DCN2_ICSC_SELECT_BYPASS;\n\n\t\tdpp2_program_input_csc(dpp_base, color_space, select, &tbl_entry);\n\t} else\n\tdpp2_program_input_csc(dpp_base, color_space, select, NULL);\n\n\tif (force_disable_cursor) {\n\t\tREG_UPDATE(CURSOR_CONTROL,\n\t\t\t\tCURSOR_ENABLE, 0);\n\t\tREG_UPDATE(CURSOR0_CONTROL,\n\t\t\t\tCUR0_ENABLE, 0);\n\n\t}\n\tdpp2_power_on_obuf(dpp_base, true);\n\n}\n\n \nvoid dscl2_calc_lb_num_partitions(\n\t\tconst struct scaler_data *scl_data,\n\t\tenum lb_memory_config lb_config,\n\t\tint *num_part_y,\n\t\tint *num_part_c)\n{\n\tint memory_line_size_y, memory_line_size_c, memory_line_size_a,\n\tlb_memory_size, lb_memory_size_c, lb_memory_size_a, num_partitions_a;\n\n\tint line_size = scl_data->viewport.width < scl_data->recout.width ?\n\t\t\tscl_data->viewport.width : scl_data->recout.width;\n\tint line_size_c = scl_data->viewport_c.width < scl_data->recout.width ?\n\t\t\tscl_data->viewport_c.width : scl_data->recout.width;\n\n\tif (line_size == 0)\n\t\tline_size = 1;\n\n\tif (line_size_c == 0)\n\t\tline_size_c = 1;\n\n\tmemory_line_size_y = (line_size + 5) / 6;  \n\tmemory_line_size_c = (line_size_c + 5) / 6;  \n\tmemory_line_size_a = (line_size + 5) / 6;  \n\n\tif (lb_config == LB_MEMORY_CONFIG_1) {\n\t\tlb_memory_size = 970;\n\t\tlb_memory_size_c = 970;\n\t\tlb_memory_size_a = 970;\n\t} else if (lb_config == LB_MEMORY_CONFIG_2) {\n\t\tlb_memory_size = 1290;\n\t\tlb_memory_size_c = 1290;\n\t\tlb_memory_size_a = 1290;\n\t} else if (lb_config == LB_MEMORY_CONFIG_3) {\n\t\t \n\t\tlb_memory_size = 970 + 1290 + 484 + 484 + 484;\n\t\tlb_memory_size_c = 970 + 1290;\n\t\tlb_memory_size_a = 970 + 1290 + 484;\n\t} else {\n\t\tlb_memory_size = 970 + 1290 + 484;\n\t\tlb_memory_size_c = 970 + 1290 + 484;\n\t\tlb_memory_size_a = 970 + 1290 + 484;\n\t}\n\t*num_part_y = lb_memory_size / memory_line_size_y;\n\t*num_part_c = lb_memory_size_c / memory_line_size_c;\n\tnum_partitions_a = lb_memory_size_a / memory_line_size_a;\n\n\tif (scl_data->lb_params.alpha_en\n\t\t\t&& (num_partitions_a < *num_part_y))\n\t\t*num_part_y = num_partitions_a;\n\n\tif (*num_part_y > 64)\n\t\t*num_part_y = 64;\n\tif (*num_part_c > 64)\n\t\t*num_part_c = 64;\n}\n\nvoid dpp2_cnv_set_alpha_keyer(\n\t\tstruct dpp *dpp_base,\n\t\tstruct cnv_color_keyer_params *color_keyer)\n{\n\tstruct dcn20_dpp *dpp = TO_DCN20_DPP(dpp_base);\n\n\tREG_UPDATE(COLOR_KEYER_CONTROL, COLOR_KEYER_EN, color_keyer->color_keyer_en);\n\n\tREG_UPDATE(COLOR_KEYER_CONTROL, COLOR_KEYER_MODE, color_keyer->color_keyer_mode);\n\n\tREG_UPDATE(COLOR_KEYER_ALPHA, COLOR_KEYER_ALPHA_LOW, color_keyer->color_keyer_alpha_low);\n\tREG_UPDATE(COLOR_KEYER_ALPHA, COLOR_KEYER_ALPHA_HIGH, color_keyer->color_keyer_alpha_high);\n\n\tREG_UPDATE(COLOR_KEYER_RED, COLOR_KEYER_RED_LOW, color_keyer->color_keyer_red_low);\n\tREG_UPDATE(COLOR_KEYER_RED, COLOR_KEYER_RED_HIGH, color_keyer->color_keyer_red_high);\n\n\tREG_UPDATE(COLOR_KEYER_GREEN, COLOR_KEYER_GREEN_LOW, color_keyer->color_keyer_green_low);\n\tREG_UPDATE(COLOR_KEYER_GREEN, COLOR_KEYER_GREEN_HIGH, color_keyer->color_keyer_green_high);\n\n\tREG_UPDATE(COLOR_KEYER_BLUE, COLOR_KEYER_BLUE_LOW, color_keyer->color_keyer_blue_low);\n\tREG_UPDATE(COLOR_KEYER_BLUE, COLOR_KEYER_BLUE_HIGH, color_keyer->color_keyer_blue_high);\n}\n\nvoid dpp2_set_cursor_attributes(\n\t\tstruct dpp *dpp_base,\n\t\tstruct dc_cursor_attributes *cursor_attributes)\n{\n\tenum dc_cursor_color_format color_format = cursor_attributes->color_format;\n\tstruct dcn20_dpp *dpp = TO_DCN20_DPP(dpp_base);\n\tint cur_rom_en = 0;\n\n\tif (color_format == CURSOR_MODE_COLOR_PRE_MULTIPLIED_ALPHA ||\n\t\tcolor_format == CURSOR_MODE_COLOR_UN_PRE_MULTIPLIED_ALPHA) {\n\t\tif (cursor_attributes->attribute_flags.bits.ENABLE_CURSOR_DEGAMMA) {\n\t\t\tcur_rom_en = 1;\n\t\t}\n\t}\n\n\tREG_UPDATE_3(CURSOR0_CONTROL,\n\t\t\tCUR0_MODE, color_format,\n\t\t\tCUR0_EXPANSION_MODE, 0,\n\t\t\tCUR0_ROM_EN, cur_rom_en);\n\n\tif (color_format == CURSOR_MODE_MONO) {\n\t\t \n\t\tREG_UPDATE(CURSOR0_COLOR0,\n\t\t\t\tCUR0_COLOR0, 0x00000000);\n\t\tREG_UPDATE(CURSOR0_COLOR1,\n\t\t\t\tCUR0_COLOR1, 0xFFFFFFFF);\n\t}\n}\n\nvoid oppn20_dummy_program_regamma_pwl(\n\t\tstruct dpp *dpp,\n\t\tconst struct pwl_params *params,\n\t\tenum opp_regamma mode)\n{}\n\nstatic struct dpp_funcs dcn20_dpp_funcs = {\n\t.dpp_read_state = dpp20_read_state,\n\t.dpp_reset = dpp_reset,\n\t.dpp_set_scaler = dpp1_dscl_set_scaler_manual_scale,\n\t.dpp_get_optimal_number_of_taps = dpp1_get_optimal_number_of_taps,\n\t.dpp_set_gamut_remap = dpp2_cm_set_gamut_remap,\n\t.dpp_set_csc_adjustment = NULL,\n\t.dpp_set_csc_default = NULL,\n\t.dpp_program_regamma_pwl = oppn20_dummy_program_regamma_pwl,\n\t.dpp_set_degamma\t\t= dpp2_set_degamma,\n\t.dpp_program_input_lut\t\t= dpp2_dummy_program_input_lut,\n\t.dpp_full_bypass\t\t= dpp1_full_bypass,\n\t.dpp_setup\t\t\t= dpp2_cnv_setup,\n\t.dpp_program_degamma_pwl\t= dpp2_set_degamma_pwl,\n\t.dpp_program_blnd_lut = dpp20_program_blnd_lut,\n\t.dpp_program_shaper_lut = dpp20_program_shaper,\n\t.dpp_program_3dlut = dpp20_program_3dlut,\n\t.dpp_program_bias_and_scale = NULL,\n\t.dpp_cnv_set_alpha_keyer = dpp2_cnv_set_alpha_keyer,\n\t.set_cursor_attributes = dpp2_set_cursor_attributes,\n\t.set_cursor_position = dpp1_set_cursor_position,\n\t.set_optional_cursor_attributes = dpp1_cnv_set_optional_cursor_attributes,\n\t.dpp_dppclk_control = dpp1_dppclk_control,\n\t.dpp_set_hdr_multiplier = dpp2_set_hdr_multiplier,\n};\n\nstatic struct dpp_caps dcn20_dpp_cap = {\n\t.dscl_data_proc_format = DSCL_DATA_PRCESSING_FLOAT_FORMAT,\n\t.dscl_calc_lb_num_partitions = dscl2_calc_lb_num_partitions,\n};\n\nbool dpp2_construct(\n\tstruct dcn20_dpp *dpp,\n\tstruct dc_context *ctx,\n\tuint32_t inst,\n\tconst struct dcn2_dpp_registers *tf_regs,\n\tconst struct dcn2_dpp_shift *tf_shift,\n\tconst struct dcn2_dpp_mask *tf_mask)\n{\n\tdpp->base.ctx = ctx;\n\n\tdpp->base.inst = inst;\n\tdpp->base.funcs = &dcn20_dpp_funcs;\n\tdpp->base.caps = &dcn20_dpp_cap;\n\n\tdpp->tf_regs = tf_regs;\n\tdpp->tf_shift = tf_shift;\n\tdpp->tf_mask = tf_mask;\n\n\tdpp->lb_pixel_depth_supported =\n\t\tLB_PIXEL_DEPTH_18BPP |\n\t\tLB_PIXEL_DEPTH_24BPP |\n\t\tLB_PIXEL_DEPTH_30BPP |\n\t\tLB_PIXEL_DEPTH_36BPP;\n\n\tdpp->lb_bits_per_entry = LB_BITS_PER_ENTRY;\n\tdpp->lb_memory_size = LB_TOTAL_NUMBER_OF_ENTRIES;  \n\n\treturn true;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}