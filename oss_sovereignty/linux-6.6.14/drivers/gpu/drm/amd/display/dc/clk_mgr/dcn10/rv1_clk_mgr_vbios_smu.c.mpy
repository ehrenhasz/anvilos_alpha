{
  "module_name": "rv1_clk_mgr_vbios_smu.c",
  "hash_id": "e4449cbc21afa608f5386de9ffc0bae4775008f18a93f24c1d5427d71687ebc8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn10/rv1_clk_mgr_vbios_smu.c",
  "human_readable_source": " \n\n#include \"core_types.h\"\n#include \"clk_mgr_internal.h\"\n#include \"reg_helper.h\"\n#include <linux/delay.h>\n\n#include \"rv1_clk_mgr_vbios_smu.h\"\n\n#define MAX_INSTANCE\t5\n#define MAX_SEGMENT\t\t5\n\nstruct IP_BASE_INSTANCE {\n\tunsigned int segment[MAX_SEGMENT];\n};\n\nstruct IP_BASE {\n\tstruct IP_BASE_INSTANCE instance[MAX_INSTANCE];\n};\n\n\nstatic const struct IP_BASE MP1_BASE  = { { { { 0x00016000, 0, 0, 0, 0 } },\n\t\t\t\t\t\t\t\t\t\t\t { { 0, 0, 0, 0, 0 } },\n\t\t\t\t\t\t\t\t\t\t\t { { 0, 0, 0, 0, 0 } },\n\t\t\t\t\t\t\t\t\t\t\t { { 0, 0, 0, 0, 0 } },\n\t\t\t\t\t\t\t\t\t\t\t { { 0, 0, 0, 0, 0 } } } };\n\n#define mmMP1_SMN_C2PMSG_91            0x29B\n#define mmMP1_SMN_C2PMSG_83            0x293\n#define mmMP1_SMN_C2PMSG_67            0x283\n#define mmMP1_SMN_C2PMSG_91_BASE_IDX   0\n#define mmMP1_SMN_C2PMSG_83_BASE_IDX   0\n#define mmMP1_SMN_C2PMSG_67_BASE_IDX   0\n\n#define MP1_SMN_C2PMSG_91__CONTENT_MASK                    0xffffffffL\n#define MP1_SMN_C2PMSG_83__CONTENT_MASK                    0xffffffffL\n#define MP1_SMN_C2PMSG_67__CONTENT_MASK                    0xffffffffL\n#define MP1_SMN_C2PMSG_91__CONTENT__SHIFT                  0x00000000\n#define MP1_SMN_C2PMSG_83__CONTENT__SHIFT                  0x00000000\n#define MP1_SMN_C2PMSG_67__CONTENT__SHIFT                  0x00000000\n\n#define REG(reg_name) \\\n\t(MP1_BASE.instance[0].segment[mm ## reg_name ## _BASE_IDX] + mm ## reg_name)\n\n#define FN(reg_name, field) \\\n\tFD(reg_name##__##field)\n\n#define VBIOSSMC_MSG_SetDispclkFreq           0x4\n#define VBIOSSMC_MSG_SetDprefclkFreq          0x5\n\n#define VBIOSSMC_Status_BUSY                      0x0\n#define VBIOSSMC_Result_OK                        0x1\n#define VBIOSSMC_Result_Failed                    0xFF\n#define VBIOSSMC_Result_UnknownCmd                0xFE\n#define VBIOSSMC_Result_CmdRejectedPrereq         0xFD\n#define VBIOSSMC_Result_CmdRejectedBusy           0xFC\n\n \nstatic uint32_t rv1_smu_wait_for_response(struct clk_mgr_internal *clk_mgr, unsigned int delay_us, unsigned int max_retries)\n{\n\tuint32_t res_val = VBIOSSMC_Status_BUSY;\n\n\tdo {\n\t\tres_val = REG_READ(MP1_SMN_C2PMSG_91);\n\t\tif (res_val != VBIOSSMC_Status_BUSY)\n\t\t\tbreak;\n\n\t\tif (delay_us >= 1000)\n\t\t\tmsleep(delay_us/1000);\n\t\telse if (delay_us > 0)\n\t\t\tudelay(delay_us);\n\t} while (max_retries--);\n\n\treturn res_val;\n}\n\nstatic int rv1_vbios_smu_send_msg_with_param(struct clk_mgr_internal *clk_mgr,\n\t\tunsigned int msg_id, unsigned int param)\n{\n\tuint32_t result;\n\n\t \n\tREG_WRITE(MP1_SMN_C2PMSG_91, VBIOSSMC_Status_BUSY);\n\n\t \n\tREG_WRITE(MP1_SMN_C2PMSG_83, param);\n\n\t \n\tREG_WRITE(MP1_SMN_C2PMSG_67, msg_id);\n\n\tresult = rv1_smu_wait_for_response(clk_mgr, 10, 1000);\n\n\tASSERT(result == VBIOSSMC_Result_OK);\n\n\t \n\treturn REG_READ(MP1_SMN_C2PMSG_83);\n}\n\nint rv1_vbios_smu_set_dispclk(struct clk_mgr_internal *clk_mgr, int requested_dispclk_khz)\n{\n\tint actual_dispclk_set_mhz = -1;\n\tstruct dc *dc = clk_mgr->base.ctx->dc;\n\tstruct dmcu *dmcu = dc->res_pool->dmcu;\n\n\t \n\tactual_dispclk_set_mhz = rv1_vbios_smu_send_msg_with_param(\n\t\t\tclk_mgr,\n\t\t\tVBIOSSMC_MSG_SetDispclkFreq,\n\t\t\tkhz_to_mhz_ceil(requested_dispclk_khz));\n\n\tif (dmcu && dmcu->funcs->is_dmcu_initialized(dmcu)) {\n\t\tif (clk_mgr->dfs_bypass_disp_clk != actual_dispclk_set_mhz)\n\t\t\tdmcu->funcs->set_psr_wait_loop(dmcu,\n\t\t\t\t\tactual_dispclk_set_mhz / 7);\n\t}\n\n\treturn actual_dispclk_set_mhz * 1000;\n}\n\nint rv1_vbios_smu_set_dprefclk(struct clk_mgr_internal *clk_mgr)\n{\n\tint actual_dprefclk_set_mhz = -1;\n\n\tactual_dprefclk_set_mhz = rv1_vbios_smu_send_msg_with_param(\n\t\t\tclk_mgr,\n\t\t\tVBIOSSMC_MSG_SetDprefclkFreq,\n\t\t\tkhz_to_mhz_ceil(clk_mgr->base.dprefclk_khz));\n\n\t \n\n\treturn actual_dprefclk_set_mhz * 1000;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}