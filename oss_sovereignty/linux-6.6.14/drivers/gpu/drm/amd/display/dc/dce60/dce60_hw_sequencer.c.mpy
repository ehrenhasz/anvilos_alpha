{
  "module_name": "dce60_hw_sequencer.c",
  "hash_id": "9f412f6aeaa3750450c8dfe1b8e62493498b14283f92c2cbdcf8b4f5e1762185",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dce60/dce60_hw_sequencer.c",
  "human_readable_source": " \n\n#include \"dm_services.h\"\n#include \"dc.h\"\n#include \"core_types.h\"\n#include \"dce60_hw_sequencer.h\"\n\n#include \"dce/dce_hwseq.h\"\n#include \"dce110/dce110_hw_sequencer.h\"\n#include \"dce100/dce100_hw_sequencer.h\"\n\n \n#include \"dce/dce_6_0_d.h\"\n#include \"dce/dce_6_0_sh_mask.h\"\n\n#define DC_LOGGER_INIT()\n\n \n\n \n\n \nstatic bool dce60_should_enable_fbc(struct dc *dc,\n\t\tstruct dc_state *context,\n\t\tuint32_t *pipe_idx)\n{\n\tuint32_t i;\n\tstruct pipe_ctx *pipe_ctx = NULL;\n\tstruct resource_context *res_ctx = &context->res_ctx;\n\tunsigned int underlay_idx = dc->res_pool->underlay_pipe_index;\n\n\n\tASSERT(dc->fbc_compressor);\n\n\t \n\tif (!dc->ctx->fbc_gpu_addr)\n\t\treturn false;\n\n\t \n\tif (context->stream_count != 1)\n\t\treturn false;\n\n\tfor (i = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tif (res_ctx->pipe_ctx[i].stream) {\n\n\t\t\tpipe_ctx = &res_ctx->pipe_ctx[i];\n\n\t\t\tif (!pipe_ctx)\n\t\t\t\tcontinue;\n\n\t\t\t \n\t\t\tif (pipe_ctx->pipe_idx != underlay_idx) {\n\t\t\t\t*pipe_idx = i;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (i == dc->res_pool->pipe_count)\n\t\treturn false;\n\n\tif (!pipe_ctx->stream->link)\n\t\treturn false;\n\n\t \n\tif (pipe_ctx->stream->link->connector_signal != SIGNAL_TYPE_EDP)\n\t\treturn false;\n\n\t \n\tif (pipe_ctx->stream->link->psr_settings.psr_feature_enabled)\n\t\treturn false;\n\n\t \n\tif (!pipe_ctx->plane_state)\n\t\treturn false;\n\n\t \n\tif (pipe_ctx->plane_state->tiling_info.gfx8.array_mode == DC_ARRAY_LINEAR_GENERAL)\n\t\treturn false;\n\n\treturn true;\n}\n\n \nstatic void dce60_enable_fbc(\n\t\tstruct dc *dc,\n\t\tstruct dc_state *context)\n{\n\tuint32_t pipe_idx = 0;\n\n\tif (dce60_should_enable_fbc(dc, context, &pipe_idx)) {\n\t\t \n\t\tstruct compr_addr_and_pitch_params params = {0, 0, 0};\n\t\tstruct compressor *compr = dc->fbc_compressor;\n\t\tstruct pipe_ctx *pipe_ctx = &context->res_ctx.pipe_ctx[pipe_idx];\n\n\t\tparams.source_view_width = pipe_ctx->stream->timing.h_addressable;\n\t\tparams.source_view_height = pipe_ctx->stream->timing.v_addressable;\n\t\tparams.inst = pipe_ctx->stream_res.tg->inst;\n\t\tcompr->compr_surface_address.quad_part = dc->ctx->fbc_gpu_addr;\n\n\t\tcompr->funcs->surface_address_and_pitch(compr, &params);\n\t\tcompr->funcs->set_fbc_invalidation_triggers(compr, 1);\n\n\t\tcompr->funcs->enable_fbc(compr, &params);\n\t}\n}\n\n\n \n\nstatic void dce60_set_default_colors(struct pipe_ctx *pipe_ctx)\n{\n\tstruct default_adjustment default_adjust = { 0 };\n\n\tdefault_adjust.force_hw_default = false;\n\tdefault_adjust.in_color_space = pipe_ctx->plane_state->color_space;\n\tdefault_adjust.out_color_space = pipe_ctx->stream->output_color_space;\n\tdefault_adjust.csc_adjust_type = GRAPHICS_CSC_ADJUST_TYPE_SW;\n\tdefault_adjust.surface_pixel_format = pipe_ctx->plane_res.scl_data.format;\n\n\t \n\tdefault_adjust.color_depth =\n\t\tpipe_ctx->stream->timing.display_color_depth;\n\n\t \n\tdefault_adjust.lb_color_depth = pipe_ctx->plane_res.scl_data.lb_params.depth;\n\n\tpipe_ctx->plane_res.xfm->funcs->opp_set_csc_default(\n\t\t\t\t\tpipe_ctx->plane_res.xfm, &default_adjust);\n}\n\n \nstatic void dce60_program_surface_visibility(const struct dc *dc,\n\t\tstruct pipe_ctx *pipe_ctx)\n{\n\tbool blank_target = false;\n\n\t \n\n\tif (!pipe_ctx->plane_state->visible)\n\t\tblank_target = true;\n\n\t \n\tpipe_ctx->stream_res.tg->funcs->set_blank(pipe_ctx->stream_res.tg, blank_target);\n\n}\n\n\nstatic void dce60_get_surface_visual_confirm_color(const struct pipe_ctx *pipe_ctx,\n\t\tstruct tg_color *color)\n{\n\tuint32_t color_value = MAX_TG_COLOR_VALUE * (4 - pipe_ctx->stream_res.tg->inst) / 4;\n\n\tswitch (pipe_ctx->plane_res.scl_data.format) {\n\tcase PIXEL_FORMAT_ARGB8888:\n\t\t \n\t\tcolor->color_r_cr = color_value;\n\t\tbreak;\n\n\tcase PIXEL_FORMAT_ARGB2101010:\n\t\t \n\t\tcolor->color_b_cb = color_value;\n\t\tbreak;\n\tcase PIXEL_FORMAT_420BPP8:\n\t\t \n\t\tcolor->color_g_y = color_value;\n\t\tbreak;\n\tcase PIXEL_FORMAT_420BPP10:\n\t\t \n\t\tcolor->color_g_y = color_value;\n\t\tcolor->color_r_cr = color_value;\n\t\tbreak;\n\tcase PIXEL_FORMAT_FP16:\n\t\t \n\t\tcolor->color_r_cr = color_value;\n\t\tcolor->color_b_cb = color_value;\n\t\tcolor->color_g_y = color_value;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void dce60_program_scaler(const struct dc *dc,\n\t\tconst struct pipe_ctx *pipe_ctx)\n{\n\tstruct tg_color color = {0};\n\n\t \n\n\tif (dc->debug.visual_confirm == VISUAL_CONFIRM_SURFACE)\n\t\tdce60_get_surface_visual_confirm_color(pipe_ctx, &color);\n\telse\n\t\tcolor_space_to_black_color(dc,\n\t\t\t\tpipe_ctx->stream->output_color_space,\n\t\t\t\t&color);\n\n\tpipe_ctx->plane_res.xfm->funcs->transform_set_pixel_storage_depth(\n\t\tpipe_ctx->plane_res.xfm,\n\t\tpipe_ctx->plane_res.scl_data.lb_params.depth,\n\t\t&pipe_ctx->stream->bit_depth_params);\n\n\tif (pipe_ctx->stream_res.tg->funcs->set_overscan_blank_color) {\n\t\t \n\t\tif (pipe_ctx->stream->timing.pixel_encoding == PIXEL_ENCODING_YCBCR420)\n\t\t\tcolor.color_r_cr = color.color_g_y;\n\n\t\tpipe_ctx->stream_res.tg->funcs->set_overscan_blank_color(\n\t\t\t\tpipe_ctx->stream_res.tg,\n\t\t\t\t&color);\n\t}\n\n\tpipe_ctx->plane_res.xfm->funcs->transform_set_scaler(pipe_ctx->plane_res.xfm,\n\t\t&pipe_ctx->plane_res.scl_data);\n}\n\nstatic void\ndce60_program_front_end_for_pipe(\n\t\tstruct dc *dc, struct pipe_ctx *pipe_ctx)\n{\n\tstruct mem_input *mi = pipe_ctx->plane_res.mi;\n\tstruct dc_plane_state *plane_state = pipe_ctx->plane_state;\n\tstruct xfm_grph_csc_adjustment adjust;\n\tstruct out_csc_color_matrix tbl_entry;\n\tunsigned int i;\n\tstruct dce_hwseq *hws = dc->hwseq;\n\n\tDC_LOGGER_INIT();\n\tmemset(&tbl_entry, 0, sizeof(tbl_entry));\n\n\tmemset(&adjust, 0, sizeof(adjust));\n\tadjust.gamut_adjust_type = GRAPHICS_GAMUT_ADJUST_TYPE_BYPASS;\n\n\tdce_enable_fe_clock(dc->hwseq, mi->inst, true);\n\n\tdce60_set_default_colors(pipe_ctx);\n\tif (pipe_ctx->stream->csc_color_matrix.enable_adjustment\n\t\t\t== true) {\n\t\ttbl_entry.color_space =\n\t\t\tpipe_ctx->stream->output_color_space;\n\n\t\tfor (i = 0; i < 12; i++)\n\t\t\ttbl_entry.regval[i] =\n\t\t\tpipe_ctx->stream->csc_color_matrix.matrix[i];\n\n\t\tpipe_ctx->plane_res.xfm->funcs->opp_set_csc_adjustment\n\t\t\t\t(pipe_ctx->plane_res.xfm, &tbl_entry);\n\t}\n\n\tif (pipe_ctx->stream->gamut_remap_matrix.enable_remap == true) {\n\t\tadjust.gamut_adjust_type = GRAPHICS_GAMUT_ADJUST_TYPE_SW;\n\n\t\tfor (i = 0; i < CSC_TEMPERATURE_MATRIX_SIZE; i++)\n\t\t\tadjust.temperature_matrix[i] =\n\t\t\t\tpipe_ctx->stream->gamut_remap_matrix.matrix[i];\n\t}\n\n\tpipe_ctx->plane_res.xfm->funcs->transform_set_gamut_remap(pipe_ctx->plane_res.xfm, &adjust);\n\n\tpipe_ctx->plane_res.scl_data.lb_params.alpha_en = pipe_ctx->bottom_pipe != 0;\n\n\tdce60_program_scaler(dc, pipe_ctx);\n\n\tmi->funcs->mem_input_program_surface_config(\n\t\t\tmi,\n\t\t\tplane_state->format,\n\t\t\t&plane_state->tiling_info,\n\t\t\t&plane_state->plane_size,\n\t\t\tplane_state->rotation,\n\t\t\tNULL,\n\t\t\tfalse);\n\tif (mi->funcs->set_blank)\n\t\tmi->funcs->set_blank(mi, pipe_ctx->plane_state->visible);\n\n\tif (dc->config.gpu_vm_support)\n\t\tmi->funcs->mem_input_program_pte_vm(\n\t\t\t\tpipe_ctx->plane_res.mi,\n\t\t\t\tplane_state->format,\n\t\t\t\t&plane_state->tiling_info,\n\t\t\t\tplane_state->rotation);\n\n\t \n\tif (pipe_ctx->plane_state->update_flags.bits.full_update ||\n\t\t\tpipe_ctx->plane_state->update_flags.bits.in_transfer_func_change ||\n\t\t\tpipe_ctx->plane_state->update_flags.bits.gamma_change)\n\t\thws->funcs.set_input_transfer_func(dc, pipe_ctx, pipe_ctx->plane_state);\n\n\tif (pipe_ctx->plane_state->update_flags.bits.full_update)\n\t\thws->funcs.set_output_transfer_func(dc, pipe_ctx, pipe_ctx->stream);\n\n\tDC_LOG_SURFACE(\n\t\t\t\"Pipe:%d %p: addr hi:0x%x, \"\n\t\t\t\"addr low:0x%x, \"\n\t\t\t\"src: %d, %d, %d,\"\n\t\t\t\" %d; dst: %d, %d, %d, %d;\"\n\t\t\t\"clip: %d, %d, %d, %d\\n\",\n\t\t\tpipe_ctx->pipe_idx,\n\t\t\t(void *) pipe_ctx->plane_state,\n\t\t\tpipe_ctx->plane_state->address.grph.addr.high_part,\n\t\t\tpipe_ctx->plane_state->address.grph.addr.low_part,\n\t\t\tpipe_ctx->plane_state->src_rect.x,\n\t\t\tpipe_ctx->plane_state->src_rect.y,\n\t\t\tpipe_ctx->plane_state->src_rect.width,\n\t\t\tpipe_ctx->plane_state->src_rect.height,\n\t\t\tpipe_ctx->plane_state->dst_rect.x,\n\t\t\tpipe_ctx->plane_state->dst_rect.y,\n\t\t\tpipe_ctx->plane_state->dst_rect.width,\n\t\t\tpipe_ctx->plane_state->dst_rect.height,\n\t\t\tpipe_ctx->plane_state->clip_rect.x,\n\t\t\tpipe_ctx->plane_state->clip_rect.y,\n\t\t\tpipe_ctx->plane_state->clip_rect.width,\n\t\t\tpipe_ctx->plane_state->clip_rect.height);\n\n\tDC_LOG_SURFACE(\n\t\t\t\"Pipe %d: width, height, x, y\\n\"\n\t\t\t\"viewport:%d, %d, %d, %d\\n\"\n\t\t\t\"recout:  %d, %d, %d, %d\\n\",\n\t\t\tpipe_ctx->pipe_idx,\n\t\t\tpipe_ctx->plane_res.scl_data.viewport.width,\n\t\t\tpipe_ctx->plane_res.scl_data.viewport.height,\n\t\t\tpipe_ctx->plane_res.scl_data.viewport.x,\n\t\t\tpipe_ctx->plane_res.scl_data.viewport.y,\n\t\t\tpipe_ctx->plane_res.scl_data.recout.width,\n\t\t\tpipe_ctx->plane_res.scl_data.recout.height,\n\t\t\tpipe_ctx->plane_res.scl_data.recout.x,\n\t\t\tpipe_ctx->plane_res.scl_data.recout.y);\n}\n\nstatic void dce60_apply_ctx_for_surface(\n\t\tstruct dc *dc,\n\t\tconst struct dc_stream_state *stream,\n\t\tint num_planes,\n\t\tstruct dc_state *context)\n{\n\tint i;\n\n\tif (num_planes == 0)\n\t\treturn;\n\n\tif (dc->fbc_compressor)\n\t\tdc->fbc_compressor->funcs->disable_fbc(dc->fbc_compressor);\n\n\tfor (i = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tstruct pipe_ctx *pipe_ctx = &context->res_ctx.pipe_ctx[i];\n\n\t\tif (pipe_ctx->stream != stream)\n\t\t\tcontinue;\n\n\t\t \n\t\tpipe_ctx->plane_res.mi->funcs->allocate_mem_input(\n\t\t\t\tpipe_ctx->plane_res.mi,\n\t\t\t\tpipe_ctx->stream->timing.h_total,\n\t\t\t\tpipe_ctx->stream->timing.v_total,\n\t\t\t\tpipe_ctx->stream->timing.pix_clk_100hz / 10,\n\t\t\t\tcontext->stream_count);\n\n\t\tdce60_program_front_end_for_pipe(dc, pipe_ctx);\n\n\t\tdc->hwss.update_plane_addr(dc, pipe_ctx);\n\n\t\tdce60_program_surface_visibility(dc, pipe_ctx);\n\n\t}\n\n\tif (dc->fbc_compressor)\n\t\tdce60_enable_fbc(dc, context);\n}\n\nvoid dce60_hw_sequencer_construct(struct dc *dc)\n{\n\tdce110_hw_sequencer_construct(dc);\n\n\tdc->hwseq->funcs.enable_display_power_gating = dce100_enable_display_power_gating;\n\tdc->hwss.apply_ctx_for_surface = dce60_apply_ctx_for_surface;\n\tdc->hwss.cursor_lock = dce60_pipe_control_lock;\n\tdc->hwss.pipe_control_lock = dce60_pipe_control_lock;\n\tdc->hwss.prepare_bandwidth = dce100_prepare_bandwidth;\n\tdc->hwss.optimize_bandwidth = dce100_optimize_bandwidth;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}