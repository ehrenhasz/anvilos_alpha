{
  "module_name": "display_mode_vba.c",
  "hash_id": "73ea38f8ce9cbeca5e691720baf9950b10e7b3e50418be8f76bcc90a50974dd3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/display_mode_vba.c",
  "human_readable_source": " \n\n\n#include \"display_mode_lib.h\"\n#include \"display_mode_vba.h\"\n#include \"dml_inline_defs.h\"\n\n \n\n\nstatic void fetch_socbb_params(struct display_mode_lib *mode_lib);\nstatic void fetch_ip_params(struct display_mode_lib *mode_lib);\nstatic void fetch_pipe_params(struct display_mode_lib *mode_lib);\nstatic void recalculate_params(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tconst display_e2e_pipe_params_st *pipes,\n\t\tunsigned int num_pipes);\n\nstatic unsigned int CursorBppEnumToBits(enum cursor_bpp ebpp);\nstatic void cache_debug_params(struct display_mode_lib *mode_lib);\n\nunsigned int dml_get_voltage_level(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tconst display_e2e_pipe_params_st *pipes,\n\t\tunsigned int num_pipes)\n{\n\tbool need_recalculate = memcmp(&mode_lib->soc, &mode_lib->vba.soc, sizeof(mode_lib->vba.soc)) != 0\n\t\t\t|| memcmp(&mode_lib->ip, &mode_lib->vba.ip, sizeof(mode_lib->vba.ip)) != 0\n\t\t\t|| num_pipes != mode_lib->vba.cache_num_pipes\n\t\t\t|| memcmp(pipes, mode_lib->vba.cache_pipes,\n\t\t\t\t\tsizeof(display_e2e_pipe_params_st) * num_pipes) != 0;\n\n\tmode_lib->vba.soc = mode_lib->soc;\n\tmode_lib->vba.ip = mode_lib->ip;\n\tmemcpy(mode_lib->vba.cache_pipes, pipes, sizeof(*pipes) * num_pipes);\n\tmode_lib->vba.cache_num_pipes = num_pipes;\n\n\tif (need_recalculate && pipes[0].clks_cfg.dppclk_mhz != 0)\n\t\tmode_lib->funcs.recalculate(mode_lib);\n\telse {\n\t\tfetch_socbb_params(mode_lib);\n\t\tfetch_ip_params(mode_lib);\n\t\tfetch_pipe_params(mode_lib);\n\t\tPixelClockAdjustmentForProgressiveToInterlaceUnit(mode_lib);\n\t}\n\tmode_lib->funcs.validate(mode_lib);\n\tcache_debug_params(mode_lib);\n\n\treturn mode_lib->vba.VoltageLevel;\n}\n\n#define dml_get_attr_func(attr, var)  double get_##attr(struct display_mode_lib *mode_lib, const display_e2e_pipe_params_st *pipes, unsigned int num_pipes) \\\n{ \\\n\trecalculate_params(mode_lib, pipes, num_pipes); \\\n\treturn var; \\\n}\n\ndml_get_attr_func(clk_dcf_deepsleep, mode_lib->vba.DCFCLKDeepSleep);\ndml_get_attr_func(wm_urgent, mode_lib->vba.UrgentWatermark);\ndml_get_attr_func(wm_memory_trip, mode_lib->vba.UrgentLatency);\ndml_get_attr_func(wm_writeback_urgent, mode_lib->vba.WritebackUrgentWatermark);\ndml_get_attr_func(wm_stutter_exit, mode_lib->vba.StutterExitWatermark);\ndml_get_attr_func(wm_stutter_enter_exit, mode_lib->vba.StutterEnterPlusExitWatermark);\ndml_get_attr_func(wm_z8_stutter_exit, mode_lib->vba.Z8StutterExitWatermark);\ndml_get_attr_func(wm_z8_stutter_enter_exit, mode_lib->vba.Z8StutterEnterPlusExitWatermark);\ndml_get_attr_func(stutter_efficiency_z8, mode_lib->vba.Z8StutterEfficiency);\ndml_get_attr_func(stutter_num_bursts_z8, mode_lib->vba.Z8NumberOfStutterBurstsPerFrame);\ndml_get_attr_func(wm_dram_clock_change, mode_lib->vba.DRAMClockChangeWatermark);\ndml_get_attr_func(wm_writeback_dram_clock_change, mode_lib->vba.WritebackDRAMClockChangeWatermark);\ndml_get_attr_func(stutter_efficiency, mode_lib->vba.StutterEfficiency);\ndml_get_attr_func(stutter_efficiency_no_vblank, mode_lib->vba.StutterEfficiencyNotIncludingVBlank);\ndml_get_attr_func(stutter_period, mode_lib->vba.StutterPeriod);\ndml_get_attr_func(urgent_latency, mode_lib->vba.UrgentLatency);\ndml_get_attr_func(urgent_extra_latency, mode_lib->vba.UrgentExtraLatency);\ndml_get_attr_func(nonurgent_latency, mode_lib->vba.NonUrgentLatencyTolerance);\ndml_get_attr_func(dram_clock_change_latency, mode_lib->vba.MinActiveDRAMClockChangeLatencySupported);\ndml_get_attr_func(dispclk_calculated, mode_lib->vba.DISPCLK_calculated);\ndml_get_attr_func(total_data_read_bw, mode_lib->vba.TotalDataReadBandwidth);\ndml_get_attr_func(return_bw, mode_lib->vba.ReturnBW);\ndml_get_attr_func(tcalc, mode_lib->vba.TCalc);\ndml_get_attr_func(fraction_of_urgent_bandwidth, mode_lib->vba.FractionOfUrgentBandwidth);\ndml_get_attr_func(fraction_of_urgent_bandwidth_imm_flip, mode_lib->vba.FractionOfUrgentBandwidthImmediateFlip);\n\n\ndml_get_attr_func(cstate_max_cap_mode, mode_lib->vba.DCHUBBUB_ARB_CSTATE_MAX_CAP_MODE);\ndml_get_attr_func(comp_buffer_size_kbytes, mode_lib->vba.CompressedBufferSizeInkByte);\ndml_get_attr_func(pixel_chunk_size_in_kbyte, mode_lib->vba.PixelChunkSizeInKByte);\ndml_get_attr_func(alpha_pixel_chunk_size_in_kbyte, mode_lib->vba.AlphaPixelChunkSizeInKByte);\ndml_get_attr_func(meta_chunk_size_in_kbyte, mode_lib->vba.MetaChunkSize);\ndml_get_attr_func(min_pixel_chunk_size_in_byte, mode_lib->vba.MinPixelChunkSizeBytes);\ndml_get_attr_func(min_meta_chunk_size_in_byte, mode_lib->vba.MinMetaChunkSizeBytes);\ndml_get_attr_func(fclk_watermark, mode_lib->vba.Watermark.FCLKChangeWatermark);\ndml_get_attr_func(usr_retraining_watermark, mode_lib->vba.Watermark.USRRetrainingWatermark);\n\ndml_get_attr_func(comp_buffer_reserved_space_kbytes, mode_lib->vba.CompBufReservedSpaceKBytes);\ndml_get_attr_func(comp_buffer_reserved_space_64bytes, mode_lib->vba.CompBufReservedSpace64B);\ndml_get_attr_func(comp_buffer_reserved_space_zs, mode_lib->vba.CompBufReservedSpaceZs);\ndml_get_attr_func(unbounded_request_enabled, mode_lib->vba.UnboundedRequestEnabled);\n\n#define dml_get_pipe_attr_func(attr, var)  double get_##attr(struct display_mode_lib *mode_lib, const display_e2e_pipe_params_st *pipes, unsigned int num_pipes, unsigned int which_pipe) \\\n{\\\n\tunsigned int which_plane; \\\n\trecalculate_params(mode_lib, pipes, num_pipes); \\\n\twhich_plane = mode_lib->vba.pipe_plane[which_pipe]; \\\n\treturn var[which_plane]; \\\n}\n\ndml_get_pipe_attr_func(dsc_delay, mode_lib->vba.DSCDelay);\ndml_get_pipe_attr_func(dppclk_calculated, mode_lib->vba.DPPCLK_calculated);\ndml_get_pipe_attr_func(dscclk_calculated, mode_lib->vba.DSCCLK_calculated);\ndml_get_pipe_attr_func(min_ttu_vblank, mode_lib->vba.MinTTUVBlank);\ndml_get_pipe_attr_func(min_ttu_vblank_in_us, mode_lib->vba.MinTTUVBlank);\ndml_get_pipe_attr_func(vratio_prefetch_l, mode_lib->vba.VRatioPrefetchY);\ndml_get_pipe_attr_func(vratio_prefetch_c, mode_lib->vba.VRatioPrefetchC);\ndml_get_pipe_attr_func(dst_x_after_scaler, mode_lib->vba.DSTXAfterScaler);\ndml_get_pipe_attr_func(dst_y_after_scaler, mode_lib->vba.DSTYAfterScaler);\ndml_get_pipe_attr_func(dst_y_per_vm_vblank, mode_lib->vba.DestinationLinesToRequestVMInVBlank);\ndml_get_pipe_attr_func(dst_y_per_row_vblank, mode_lib->vba.DestinationLinesToRequestRowInVBlank);\ndml_get_pipe_attr_func(dst_y_prefetch, mode_lib->vba.DestinationLinesForPrefetch);\ndml_get_pipe_attr_func(dst_y_per_vm_flip, mode_lib->vba.DestinationLinesToRequestVMInImmediateFlip);\ndml_get_pipe_attr_func(dst_y_per_row_flip, mode_lib->vba.DestinationLinesToRequestRowInImmediateFlip);\ndml_get_pipe_attr_func(refcyc_per_vm_group_vblank, mode_lib->vba.TimePerVMGroupVBlank);\ndml_get_pipe_attr_func(refcyc_per_vm_group_flip, mode_lib->vba.TimePerVMGroupFlip);\ndml_get_pipe_attr_func(refcyc_per_vm_req_vblank, mode_lib->vba.TimePerVMRequestVBlank);\ndml_get_pipe_attr_func(refcyc_per_vm_req_flip, mode_lib->vba.TimePerVMRequestFlip);\ndml_get_pipe_attr_func(refcyc_per_vm_group_vblank_in_us, mode_lib->vba.TimePerVMGroupVBlank);\ndml_get_pipe_attr_func(refcyc_per_vm_group_flip_in_us, mode_lib->vba.TimePerVMGroupFlip);\ndml_get_pipe_attr_func(refcyc_per_vm_req_vblank_in_us, mode_lib->vba.TimePerVMRequestVBlank);\ndml_get_pipe_attr_func(refcyc_per_vm_req_flip_in_us, mode_lib->vba.TimePerVMRequestFlip);\ndml_get_pipe_attr_func(refcyc_per_vm_dmdata_in_us, mode_lib->vba.Tdmdl_vm);\ndml_get_pipe_attr_func(dmdata_dl_delta_in_us, mode_lib->vba.Tdmdl);\ndml_get_pipe_attr_func(refcyc_per_line_delivery_l_in_us, mode_lib->vba.DisplayPipeLineDeliveryTimeLuma);\ndml_get_pipe_attr_func(refcyc_per_line_delivery_c_in_us, mode_lib->vba.DisplayPipeLineDeliveryTimeChroma);\ndml_get_pipe_attr_func(refcyc_per_line_delivery_pre_l_in_us, mode_lib->vba.DisplayPipeLineDeliveryTimeLumaPrefetch);\ndml_get_pipe_attr_func(refcyc_per_line_delivery_pre_c_in_us, mode_lib->vba.DisplayPipeLineDeliveryTimeChromaPrefetch);\ndml_get_pipe_attr_func(refcyc_per_req_delivery_l_in_us, mode_lib->vba.DisplayPipeRequestDeliveryTimeLuma);\ndml_get_pipe_attr_func(refcyc_per_req_delivery_c_in_us, mode_lib->vba.DisplayPipeRequestDeliveryTimeChroma);\ndml_get_pipe_attr_func(refcyc_per_req_delivery_pre_l_in_us, mode_lib->vba.DisplayPipeRequestDeliveryTimeLumaPrefetch);\ndml_get_pipe_attr_func(refcyc_per_req_delivery_pre_c_in_us, mode_lib->vba.DisplayPipeRequestDeliveryTimeChromaPrefetch);\ndml_get_pipe_attr_func(refcyc_per_cursor_req_delivery_in_us, mode_lib->vba.CursorRequestDeliveryTime);\ndml_get_pipe_attr_func(refcyc_per_cursor_req_delivery_pre_in_us, mode_lib->vba.CursorRequestDeliveryTimePrefetch);\ndml_get_pipe_attr_func(refcyc_per_meta_chunk_nom_l_in_us, mode_lib->vba.TimePerMetaChunkNominal);\ndml_get_pipe_attr_func(refcyc_per_meta_chunk_nom_c_in_us, mode_lib->vba.TimePerChromaMetaChunkNominal);\ndml_get_pipe_attr_func(refcyc_per_meta_chunk_vblank_l_in_us, mode_lib->vba.TimePerMetaChunkVBlank);\ndml_get_pipe_attr_func(refcyc_per_meta_chunk_vblank_c_in_us, mode_lib->vba.TimePerChromaMetaChunkVBlank);\ndml_get_pipe_attr_func(refcyc_per_meta_chunk_flip_l_in_us, mode_lib->vba.TimePerMetaChunkFlip);\ndml_get_pipe_attr_func(refcyc_per_meta_chunk_flip_c_in_us, mode_lib->vba.TimePerChromaMetaChunkFlip);\ndml_get_pipe_attr_func(vstartup, mode_lib->vba.VStartup);\ndml_get_pipe_attr_func(vupdate_offset, mode_lib->vba.VUpdateOffsetPix);\ndml_get_pipe_attr_func(vupdate_width, mode_lib->vba.VUpdateWidthPix);\ndml_get_pipe_attr_func(vready_offset, mode_lib->vba.VReadyOffsetPix);\ndml_get_pipe_attr_func(vready_at_or_after_vsync, mode_lib->vba.VREADY_AT_OR_AFTER_VSYNC);\ndml_get_pipe_attr_func(min_dst_y_next_start, mode_lib->vba.MIN_DST_Y_NEXT_START);\ndml_get_pipe_attr_func(dst_y_per_pte_row_nom_l, mode_lib->vba.DST_Y_PER_PTE_ROW_NOM_L);\ndml_get_pipe_attr_func(dst_y_per_pte_row_nom_c, mode_lib->vba.DST_Y_PER_PTE_ROW_NOM_C);\ndml_get_pipe_attr_func(dst_y_per_meta_row_nom_l, mode_lib->vba.DST_Y_PER_META_ROW_NOM_L);\ndml_get_pipe_attr_func(dst_y_per_meta_row_nom_c, mode_lib->vba.DST_Y_PER_META_ROW_NOM_C);\ndml_get_pipe_attr_func(refcyc_per_pte_group_nom_l_in_us, mode_lib->vba.time_per_pte_group_nom_luma);\ndml_get_pipe_attr_func(refcyc_per_pte_group_nom_c_in_us, mode_lib->vba.time_per_pte_group_nom_chroma);\ndml_get_pipe_attr_func(refcyc_per_pte_group_vblank_l_in_us, mode_lib->vba.time_per_pte_group_vblank_luma);\ndml_get_pipe_attr_func(refcyc_per_pte_group_vblank_c_in_us, mode_lib->vba.time_per_pte_group_vblank_chroma);\ndml_get_pipe_attr_func(refcyc_per_pte_group_flip_l_in_us, mode_lib->vba.time_per_pte_group_flip_luma);\ndml_get_pipe_attr_func(refcyc_per_pte_group_flip_c_in_us, mode_lib->vba.time_per_pte_group_flip_chroma);\ndml_get_pipe_attr_func(vstartup_calculated, mode_lib->vba.VStartup);\ndml_get_pipe_attr_func(dpte_row_height_linear_c, mode_lib->vba.dpte_row_height_linear_chroma);\ndml_get_pipe_attr_func(swath_height_l, mode_lib->vba.SwathHeightY);\ndml_get_pipe_attr_func(swath_height_c, mode_lib->vba.SwathHeightC);\ndml_get_pipe_attr_func(det_stored_buffer_size_l_bytes, mode_lib->vba.DETBufferSizeY);\ndml_get_pipe_attr_func(det_stored_buffer_size_c_bytes, mode_lib->vba.DETBufferSizeC);\ndml_get_pipe_attr_func(dpte_group_size_in_bytes, mode_lib->vba.dpte_group_bytes);\ndml_get_pipe_attr_func(vm_group_size_in_bytes, mode_lib->vba.vm_group_bytes);\ndml_get_pipe_attr_func(dpte_row_height_linear_l, mode_lib->vba.dpte_row_height_linear);\ndml_get_pipe_attr_func(pte_buffer_mode, mode_lib->vba.PTE_BUFFER_MODE);\ndml_get_pipe_attr_func(subviewport_lines_needed_in_mall, mode_lib->vba.SubViewportLinesNeededInMALL);\ndml_get_pipe_attr_func(surface_size_in_mall, mode_lib->vba.SurfaceSizeInMALL)\n\ndouble get_total_immediate_flip_bytes(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tconst display_e2e_pipe_params_st *pipes,\n\t\tunsigned int num_pipes)\n{\n\trecalculate_params(mode_lib, pipes, num_pipes);\n\treturn mode_lib->vba.TotImmediateFlipBytes;\n}\n\ndouble get_total_immediate_flip_bw(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tconst display_e2e_pipe_params_st *pipes,\n\t\tunsigned int num_pipes)\n{\n\tunsigned int k;\n\tdouble immediate_flip_bw = 0.0;\n\trecalculate_params(mode_lib, pipes, num_pipes);\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k)\n\t\timmediate_flip_bw += mode_lib->vba.ImmediateFlipBW[k];\n\treturn immediate_flip_bw;\n}\n\ndouble get_total_prefetch_bw(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tconst display_e2e_pipe_params_st *pipes,\n\t\tunsigned int num_pipes)\n{\n\tunsigned int k;\n\tdouble total_prefetch_bw = 0.0;\n\n\trecalculate_params(mode_lib, pipes, num_pipes);\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k)\n\t\ttotal_prefetch_bw += mode_lib->vba.PrefetchBandwidth[k];\n\treturn total_prefetch_bw;\n}\n\nunsigned int get_total_surface_size_in_mall_bytes(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tconst display_e2e_pipe_params_st *pipes,\n\t\tunsigned int num_pipes)\n{\n\tunsigned int k;\n\tunsigned int size = 0.0;\n\trecalculate_params(mode_lib, pipes, num_pipes);\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k)\n\t\tsize += mode_lib->vba.SurfaceSizeInMALL[k];\n\treturn size;\n}\n\nstatic unsigned int get_pipe_idx(struct display_mode_lib *mode_lib, unsigned int plane_idx)\n{\n\tint pipe_idx = -1;\n\tint i;\n\n\tASSERT(plane_idx < DC__NUM_DPP__MAX);\n\n\tfor (i = 0; i < DC__NUM_DPP__MAX ; i++) {\n\t\tif (plane_idx == mode_lib->vba.pipe_plane[i]) {\n\t\t\tpipe_idx = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tASSERT(pipe_idx >= 0);\n\n\treturn pipe_idx;\n}\n\n\ndouble get_det_buffer_size_kbytes(struct display_mode_lib *mode_lib, const display_e2e_pipe_params_st *pipes,\n\t\tunsigned int num_pipes, unsigned int pipe_idx)\n{\n\tunsigned int plane_idx;\n\tdouble det_buf_size_kbytes;\n\n\trecalculate_params(mode_lib, pipes, num_pipes);\n\tplane_idx = mode_lib->vba.pipe_plane[pipe_idx];\n\n\tdml_print(\"DML::%s: num_pipes=%d pipe_idx=%d plane_idx=%0d\\n\", __func__, num_pipes, pipe_idx, plane_idx);\n\tdet_buf_size_kbytes = mode_lib->vba.DETBufferSizeInKByte[plane_idx]; \n\n\tdml_print(\"DML::%s: det_buf_size_kbytes=%3.2f\\n\", __func__, det_buf_size_kbytes);\n\n\treturn det_buf_size_kbytes;\n}\n\nbool get_is_phantom_pipe(struct display_mode_lib *mode_lib, const display_e2e_pipe_params_st *pipes,\n\t\tunsigned int num_pipes, unsigned int pipe_idx)\n{\n\tunsigned int plane_idx;\n\n\trecalculate_params(mode_lib, pipes, num_pipes);\n\tplane_idx = mode_lib->vba.pipe_plane[pipe_idx];\n\tdml_print(\"DML::%s: num_pipes=%d pipe_idx=%d UseMALLForPStateChange=%0d\\n\", __func__, num_pipes, pipe_idx,\n\t\t\tmode_lib->vba.UsesMALLForPStateChange[plane_idx]);\n\treturn (mode_lib->vba.UsesMALLForPStateChange[plane_idx] == dm_use_mall_pstate_change_phantom_pipe);\n}\n\nstatic void fetch_socbb_params(struct display_mode_lib *mode_lib)\n{\n\tsoc_bounding_box_st *soc = &mode_lib->vba.soc;\n\tint i;\n\n\t\n\tmode_lib->vba.ReturnBusWidth = soc->return_bus_width_bytes;\n\tmode_lib->vba.NumberOfChannels = soc->num_chans;\n\tmode_lib->vba.PercentOfIdealDRAMFabricAndSDPPortBWReceivedAfterUrgLatencyPixelDataOnly =\n\t\t\tsoc->pct_ideal_dram_sdp_bw_after_urgent_pixel_only; \n\tmode_lib->vba.PercentOfIdealDRAMFabricAndSDPPortBWReceivedAfterUrgLatencyPixelMixedWithVMData =\n\t\t\tsoc->pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm;\n\tmode_lib->vba.PercentOfIdealDRAMFabricAndSDPPortBWReceivedAfterUrgLatencyVMDataOnly =\n\t\t\tsoc->pct_ideal_dram_sdp_bw_after_urgent_vm_only;\n\tmode_lib->vba.MaxAveragePercentOfIdealSDPPortBWDisplayCanUseInNormalSystemOperation =\n\t\t\tsoc->max_avg_sdp_bw_use_normal_percent;\n\tmode_lib->vba.MaxAveragePercentOfIdealDRAMBWDisplayCanUseInNormalSystemOperation =\n\t\t\tsoc->max_avg_dram_bw_use_normal_percent;\n\tmode_lib->vba.UrgentLatencyPixelDataOnly = soc->urgent_latency_pixel_data_only_us;\n\tmode_lib->vba.UrgentLatencyPixelMixedWithVMData = soc->urgent_latency_pixel_mixed_with_vm_data_us;\n\tmode_lib->vba.UrgentLatencyVMDataOnly = soc->urgent_latency_vm_data_only_us;\n\tmode_lib->vba.RoundTripPingLatencyCycles = soc->round_trip_ping_latency_dcfclk_cycles;\n\tmode_lib->vba.UrgentOutOfOrderReturnPerChannelPixelDataOnly =\n\t\t\tsoc->urgent_out_of_order_return_per_channel_pixel_only_bytes;\n\tmode_lib->vba.UrgentOutOfOrderReturnPerChannelPixelMixedWithVMData =\n\t\t\tsoc->urgent_out_of_order_return_per_channel_pixel_and_vm_bytes;\n\tmode_lib->vba.UrgentOutOfOrderReturnPerChannelVMDataOnly =\n\t\t\tsoc->urgent_out_of_order_return_per_channel_vm_only_bytes;\n\tmode_lib->vba.WritebackLatency = soc->writeback_latency_us;\n\tmode_lib->vba.SRExitTime = soc->sr_exit_time_us;\n\tmode_lib->vba.SREnterPlusExitTime = soc->sr_enter_plus_exit_time_us;\n\tmode_lib->vba.PercentOfIdealFabricAndSDPPortBWReceivedAfterUrgLatency = soc->pct_ideal_sdp_bw_after_urgent;\n\tmode_lib->vba.PercentOfIdealDRAMBWReceivedAfterUrgLatencyPixelMixedWithVMData = soc->pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm;\n\tmode_lib->vba.PercentOfIdealDRAMBWReceivedAfterUrgLatencyPixelDataOnly = soc->pct_ideal_dram_sdp_bw_after_urgent_pixel_only;\n\tmode_lib->vba.PercentOfIdealDRAMBWReceivedAfterUrgLatencyVMDataOnly = soc->pct_ideal_dram_sdp_bw_after_urgent_vm_only;\n\tmode_lib->vba.MaxAveragePercentOfIdealFabricAndSDPPortBWDisplayCanUseInNormalSystemOperation =\n\t\t\tsoc->max_avg_sdp_bw_use_normal_percent;\n\tmode_lib->vba.SRExitZ8Time = soc->sr_exit_z8_time_us;\n\tmode_lib->vba.SREnterPlusExitZ8Time = soc->sr_enter_plus_exit_z8_time_us;\n\tmode_lib->vba.FCLKChangeLatency = soc->fclk_change_latency_us;\n\tmode_lib->vba.USRRetrainingLatency = soc->usr_retraining_latency_us;\n\tmode_lib->vba.SMNLatency = soc->smn_latency_us;\n\tmode_lib->vba.MALLAllocatedForDCNFinal = soc->mall_allocated_for_dcn_mbytes;\n\n\tmode_lib->vba.PercentOfIdealDRAMBWReceivedAfterUrgLatencySTROBE = soc->pct_ideal_dram_bw_after_urgent_strobe;\n\tmode_lib->vba.MaxAveragePercentOfIdealFabricBWDisplayCanUseInNormalSystemOperation =\n\t\t\tsoc->max_avg_fabric_bw_use_normal_percent;\n\tmode_lib->vba.MaxAveragePercentOfIdealDRAMBWDisplayCanUseInNormalSystemOperationSTROBE =\n\t\t\tsoc->max_avg_dram_bw_use_normal_strobe_percent;\n\n\tmode_lib->vba.DRAMClockChangeRequirementFinal = soc->dram_clock_change_requirement_final;\n\tmode_lib->vba.FCLKChangeRequirementFinal = 1;\n\tmode_lib->vba.USRRetrainingRequiredFinal = 1;\n\tmode_lib->vba.AllowForPStateChangeOrStutterInVBlankFinal = soc->allow_for_pstate_or_stutter_in_vblank_final;\n\tmode_lib->vba.DRAMClockChangeLatency = soc->dram_clock_change_latency_us;\n\tmode_lib->vba.DummyPStateCheck = soc->dram_clock_change_latency_us == soc->dummy_pstate_latency_us;\n\tmode_lib->vba.DRAMClockChangeSupportsVActive = !soc->disable_dram_clock_change_vactive_support ||\n\t\t\tmode_lib->vba.DummyPStateCheck;\n\tmode_lib->vba.AllowDramClockChangeOneDisplayVactive = soc->allow_dram_clock_one_display_vactive;\n\tmode_lib->vba.AllowDRAMSelfRefreshOrDRAMClockChangeInVblank =\n\t\tsoc->allow_dram_self_refresh_or_dram_clock_change_in_vblank;\n\n\tmode_lib->vba.Downspreading = soc->downspread_percent;\n\tmode_lib->vba.DRAMChannelWidth = soc->dram_channel_width_bytes;   \n\tmode_lib->vba.FabricDatapathToDCNDataReturn = soc->fabric_datapath_to_dcn_data_return_bytes; \n\tmode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading = soc->dcn_downspread_percent;   \n\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed = soc->dispclk_dppclk_vco_speed_mhz;   \n\tmode_lib->vba.VMMPageSize = soc->vmm_page_size_bytes;\n\tmode_lib->vba.GPUVMMinPageSize = soc->gpuvm_min_page_size_bytes / 1024;\n\tmode_lib->vba.HostVMMinPageSize = soc->hostvm_min_page_size_bytes / 1024;\n\t\n\t\n\tfor (i = 0; i < mode_lib->vba.soc.num_states; i++)\n\t\tif (soc->clock_limits[i].state == mode_lib->vba.VoltageLevel)\n\t\t\tbreak;\n\n\tmode_lib->vba.DCFCLK = soc->clock_limits[i].dcfclk_mhz;\n\tmode_lib->vba.SOCCLK = soc->clock_limits[i].socclk_mhz;\n\tmode_lib->vba.DRAMSpeed = soc->clock_limits[i].dram_speed_mts;\n\tmode_lib->vba.FabricClock = soc->clock_limits[i].fabricclk_mhz;\n\n\tmode_lib->vba.XFCBusTransportTime = soc->xfc_bus_transport_time_us;\n\tmode_lib->vba.XFCXBUFLatencyTolerance = soc->xfc_xbuf_latency_tolerance_us;\n\tmode_lib->vba.UseUrgentBurstBandwidth = soc->use_urgent_burst_bw;\n\n\tmode_lib->vba.SupportGFX7CompatibleTilingIn32bppAnd64bpp = false;\n\tmode_lib->vba.WritebackLumaAndChromaScalingSupported = true;\n\tmode_lib->vba.MaxHSCLRatio = 4;\n\tmode_lib->vba.MaxVSCLRatio = 4;\n\tmode_lib->vba.Cursor64BppSupport = true;\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tmode_lib->vba.DCFCLKPerState[i] = soc->clock_limits[i].dcfclk_mhz;\n\t\tmode_lib->vba.FabricClockPerState[i] = soc->clock_limits[i].fabricclk_mhz;\n\t\tmode_lib->vba.SOCCLKPerState[i] = soc->clock_limits[i].socclk_mhz;\n\t\tmode_lib->vba.PHYCLKPerState[i] = soc->clock_limits[i].phyclk_mhz;\n\t\tmode_lib->vba.PHYCLKD18PerState[i] = soc->clock_limits[i].phyclk_d18_mhz;\n\t\tmode_lib->vba.PHYCLKD32PerState[i] = soc->clock_limits[i].phyclk_d32_mhz;\n\t\tmode_lib->vba.MaxDppclk[i] = soc->clock_limits[i].dppclk_mhz;\n\t\tmode_lib->vba.MaxDSCCLK[i] = soc->clock_limits[i].dscclk_mhz;\n\t\tmode_lib->vba.DRAMSpeedPerState[i] = soc->clock_limits[i].dram_speed_mts;\n\t\t\n\t\tmode_lib->vba.MaxDispclk[i] = soc->clock_limits[i].dispclk_mhz;\n\t\tmode_lib->vba.DTBCLKPerState[i] = soc->clock_limits[i].dtbclk_mhz;\n\t}\n\n\tmode_lib->vba.DoUrgentLatencyAdjustment =\n\t\tsoc->do_urgent_latency_adjustment;\n\tmode_lib->vba.UrgentLatencyAdjustmentFabricClockComponent =\n\t\tsoc->urgent_latency_adjustment_fabric_clock_component_us;\n\tmode_lib->vba.UrgentLatencyAdjustmentFabricClockReference =\n\t\tsoc->urgent_latency_adjustment_fabric_clock_reference_mhz;\n\tmode_lib->vba.MaxVRatioPre = soc->max_vratio_pre;\n}\n\nstatic void fetch_ip_params(struct display_mode_lib *mode_lib)\n{\n\tip_params_st *ip = &mode_lib->vba.ip;\n\n\t\n\tmode_lib->vba.UseMinimumRequiredDCFCLK = ip->use_min_dcfclk;\n\tmode_lib->vba.ClampMinDCFCLK = ip->clamp_min_dcfclk;\n\tmode_lib->vba.MaxNumDPP = ip->max_num_dpp;\n\tmode_lib->vba.MaxNumOTG = ip->max_num_otg;\n\tmode_lib->vba.MaxNumHDMIFRLOutputs = ip->max_num_hdmi_frl_outputs;\n\tmode_lib->vba.MaxNumWriteback = ip->max_num_wb;\n\tmode_lib->vba.CursorChunkSize = ip->cursor_chunk_size;\n\tmode_lib->vba.CursorBufferSize = ip->cursor_buffer_size;\n\n\tmode_lib->vba.MaxDCHUBToPSCLThroughput = ip->max_dchub_pscl_bw_pix_per_clk;\n\tmode_lib->vba.MaxPSCLToLBThroughput = ip->max_pscl_lb_bw_pix_per_clk;\n\tmode_lib->vba.ROBBufferSizeInKByte = ip->rob_buffer_size_kbytes;\n\tmode_lib->vba.DETBufferSizeInKByte[0] = ip->det_buffer_size_kbytes;\n\tmode_lib->vba.ConfigReturnBufferSizeInKByte = ip->config_return_buffer_size_in_kbytes;\n\tmode_lib->vba.CompressedBufferSegmentSizeInkByte = ip->compressed_buffer_segment_size_in_kbytes;\n\tmode_lib->vba.MetaFIFOSizeInKEntries = ip->meta_fifo_size_in_kentries;\n\tmode_lib->vba.ZeroSizeBufferEntries = ip->zero_size_buffer_entries;\n\tmode_lib->vba.COMPBUF_RESERVED_SPACE_64B = ip->compbuf_reserved_space_64b;\n\tmode_lib->vba.COMPBUF_RESERVED_SPACE_ZS = ip->compbuf_reserved_space_zs;\n\tmode_lib->vba.MaximumDSCBitsPerComponent = ip->maximum_dsc_bits_per_component;\n\tmode_lib->vba.DSC422NativeSupport = ip->dsc422_native_support;\n     \n\tmode_lib->vba.nomDETInKByte = ip->det_buffer_size_kbytes;\n\tmode_lib->vba.CompbufReservedSpace64B  = ip->compbuf_reserved_space_64b;\n\tmode_lib->vba.CompbufReservedSpaceZs = ip->compbuf_reserved_space_zs;\n\tmode_lib->vba.CompressedBufferSegmentSizeInkByteFinal = ip->compressed_buffer_segment_size_in_kbytes;\n\tmode_lib->vba.LineBufferSizeFinal = ip->line_buffer_size_bits;\n\tmode_lib->vba.AlphaPixelChunkSizeInKByte = ip->alpha_pixel_chunk_size_kbytes; \n\tmode_lib->vba.MinPixelChunkSizeBytes = ip->min_pixel_chunk_size_bytes; \n\tmode_lib->vba.MaximumPixelsPerLinePerDSCUnit = ip->maximum_pixels_per_line_per_dsc_unit;\n\tmode_lib->vba.MaxNumDP2p0Outputs = ip->max_num_dp2p0_outputs;\n\tmode_lib->vba.MaxNumDP2p0Streams = ip->max_num_dp2p0_streams;\n\tmode_lib->vba.DCCMetaBufferSizeBytes = ip->dcc_meta_buffer_size_bytes;\n\n\tmode_lib->vba.PixelChunkSizeInKByte = ip->pixel_chunk_size_kbytes;\n\tmode_lib->vba.MetaChunkSize = ip->meta_chunk_size_kbytes;\n\tmode_lib->vba.MinMetaChunkSizeBytes = ip->min_meta_chunk_size_bytes;\n\tmode_lib->vba.WritebackChunkSize = ip->writeback_chunk_size_kbytes;\n\tmode_lib->vba.LineBufferSize = ip->line_buffer_size_bits;\n\tmode_lib->vba.MaxLineBufferLines = ip->max_line_buffer_lines;\n\tmode_lib->vba.PTEBufferSizeInRequestsLuma = ip->dpte_buffer_size_in_pte_reqs_luma;\n\tmode_lib->vba.PTEBufferSizeInRequestsChroma = ip->dpte_buffer_size_in_pte_reqs_chroma;\n\tmode_lib->vba.DPPOutputBufferPixels = ip->dpp_output_buffer_pixels;\n\tmode_lib->vba.OPPOutputBufferLines = ip->opp_output_buffer_lines;\n\tmode_lib->vba.MaxHSCLRatio = ip->max_hscl_ratio;\n\tmode_lib->vba.MaxVSCLRatio = ip->max_vscl_ratio;\n\tmode_lib->vba.WritebackInterfaceLumaBufferSize = ip->writeback_luma_buffer_size_kbytes * 1024;\n\tmode_lib->vba.WritebackInterfaceChromaBufferSize = ip->writeback_chroma_buffer_size_kbytes * 1024;\n\n\tmode_lib->vba.WritebackInterfaceBufferSize = ip->writeback_interface_buffer_size_kbytes;\n\tmode_lib->vba.WritebackLineBufferSize = ip->writeback_line_buffer_buffer_size;\n\n\tmode_lib->vba.WritebackChromaLineBufferWidth =\n\t\t\tip->writeback_chroma_line_buffer_width_pixels;\n\tmode_lib->vba.WritebackLineBufferLumaBufferSize =\n\t\t\tip->writeback_line_buffer_luma_buffer_size;\n\tmode_lib->vba.WritebackLineBufferChromaBufferSize =\n\t\t\tip->writeback_line_buffer_chroma_buffer_size;\n\tmode_lib->vba.Writeback10bpc420Supported = ip->writeback_10bpc420_supported;\n\tmode_lib->vba.WritebackMaxHSCLRatio = ip->writeback_max_hscl_ratio;\n\tmode_lib->vba.WritebackMaxVSCLRatio = ip->writeback_max_vscl_ratio;\n\tmode_lib->vba.WritebackMinHSCLRatio = ip->writeback_min_hscl_ratio;\n\tmode_lib->vba.WritebackMinVSCLRatio = ip->writeback_min_vscl_ratio;\n\tmode_lib->vba.WritebackMaxHSCLTaps = ip->writeback_max_hscl_taps;\n\tmode_lib->vba.WritebackMaxVSCLTaps = ip->writeback_max_vscl_taps;\n\tmode_lib->vba.WritebackConfiguration = dm_normal;\n\tmode_lib->vba.GPUVMMaxPageTableLevels = ip->gpuvm_max_page_table_levels;\n\tmode_lib->vba.HostVMMaxNonCachedPageTableLevels = ip->hostvm_max_page_table_levels;\n\tmode_lib->vba.HostVMMaxPageTableLevels = ip->hostvm_max_page_table_levels;\n\tmode_lib->vba.HostVMCachedPageTableLevels = ip->hostvm_cached_page_table_levels;\n\tmode_lib->vba.MaxInterDCNTileRepeaters = ip->max_inter_dcn_tile_repeaters;\n\tmode_lib->vba.NumberOfDSC = ip->num_dsc;\n\tmode_lib->vba.ODMCapability = ip->odm_capable;\n\tmode_lib->vba.DISPCLKRampingMargin = ip->dispclk_ramp_margin_percent;\n\n\tmode_lib->vba.XFCSupported = ip->xfc_supported;\n\tmode_lib->vba.XFCFillBWOverhead = ip->xfc_fill_bw_overhead_percent;\n\tmode_lib->vba.XFCFillConstant = ip->xfc_fill_constant_bytes;\n\tmode_lib->vba.DPPCLKDelaySubtotal = ip->dppclk_delay_subtotal;\n\tmode_lib->vba.DPPCLKDelaySCL = ip->dppclk_delay_scl;\n\tmode_lib->vba.DPPCLKDelaySCLLBOnly = ip->dppclk_delay_scl_lb_only;\n\tmode_lib->vba.DPPCLKDelayCNVCFormater = ip->dppclk_delay_cnvc_formatter;\n\tmode_lib->vba.DPPCLKDelayCNVCCursor = ip->dppclk_delay_cnvc_cursor;\n\tmode_lib->vba.DISPCLKDelaySubtotal = ip->dispclk_delay_subtotal;\n\tmode_lib->vba.DynamicMetadataVMEnabled = ip->dynamic_metadata_vm_enabled;\n\tmode_lib->vba.ODMCombine4To1Supported = ip->odm_combine_4to1_supported;\n\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP = ip->ptoi_supported;\n\tmode_lib->vba.PDEProcessingBufIn64KBReqs = ip->pde_proc_buffer_size_64k_reqs;\n\tmode_lib->vba.PTEGroupSize = ip->pte_group_size_bytes;\n\tmode_lib->vba.SupportGFX7CompatibleTilingIn32bppAnd64bpp = ip->gfx7_compat_tiling_supported;\n}\n\nstatic void fetch_pipe_params(struct display_mode_lib *mode_lib)\n{\n\tdisplay_e2e_pipe_params_st *pipes = mode_lib->vba.cache_pipes;\n\tip_params_st *ip = &mode_lib->vba.ip;\n\n\tunsigned int OTGInstPlane[DC__NUM_DPP__MAX];\n\tunsigned int j, k;\n\tbool PlaneVisited[DC__NUM_DPP__MAX];\n\tbool visited[DC__NUM_DPP__MAX];\n\n\t\n\tfor (k = 0; k < mode_lib->vba.cache_num_pipes; ++k)\n\t\tvisited[k] = false;\n\n\tmode_lib->vba.NumberOfActivePlanes = 0;\n\tmode_lib->vba.NumberOfActiveSurfaces = 0;\n\tmode_lib->vba.ImmediateFlipSupport = false;\n\tfor (j = 0; j < mode_lib->vba.cache_num_pipes; ++j) {\n\t\tdisplay_pipe_source_params_st *src = &pipes[j].pipe.src;\n\t\tdisplay_pipe_dest_params_st *dst = &pipes[j].pipe.dest;\n\t\tscaler_ratio_depth_st *scl = &pipes[j].pipe.scale_ratio_depth;\n\t\tscaler_taps_st *taps = &pipes[j].pipe.scale_taps;\n\t\tdisplay_output_params_st *dout = &pipes[j].dout;\n\t\tdisplay_clocks_and_cfg_st *clks = &pipes[j].clks_cfg;\n\n\t\tif (visited[j])\n\t\t\tcontinue;\n\t\tvisited[j] = true;\n\n\t\tmode_lib->vba.ImmediateFlipRequirement[j] = dm_immediate_flip_not_required;\n\t\tmode_lib->vba.pipe_plane[j] = mode_lib->vba.NumberOfActivePlanes;\n\t\tmode_lib->vba.DPPPerPlane[mode_lib->vba.NumberOfActivePlanes] = 1;\n\t\tmode_lib->vba.SourceScan[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\t(enum scan_direction_class) (src->source_scan);\n\t\tmode_lib->vba.ViewportWidth[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->viewport_width;\n\t\tmode_lib->vba.ViewportWidthChroma[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->viewport_width_c;\n\t\tmode_lib->vba.ViewportHeight[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->viewport_height;\n\t\tmode_lib->vba.ViewportHeightChroma[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->viewport_height_c;\n\t\tmode_lib->vba.ViewportYStartY[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->viewport_y_y;\n\t\tmode_lib->vba.ViewportYStartC[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->viewport_y_c;\n\t\tmode_lib->vba.SourceRotation[mode_lib->vba.NumberOfActiveSurfaces] = src->source_rotation;\n\t\tmode_lib->vba.ViewportXStartY[mode_lib->vba.NumberOfActiveSurfaces] = src->viewport_x_y;\n\t\tmode_lib->vba.ViewportXStartC[mode_lib->vba.NumberOfActiveSurfaces] = src->viewport_x_c;\n\t\t\n\t\tmode_lib->vba.ViewportStationary[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->viewport_stationary;\n\t\tmode_lib->vba.UsesMALLForPStateChange[mode_lib->vba.NumberOfActivePlanes] = src->use_mall_for_pstate_change;\n\t\tmode_lib->vba.UseMALLForStaticScreen[mode_lib->vba.NumberOfActivePlanes] = src->use_mall_for_static_screen;\n\t\tmode_lib->vba.GPUVMMinPageSizeKBytes[mode_lib->vba.NumberOfActivePlanes] = src->gpuvm_min_page_size_kbytes;\n\t\tmode_lib->vba.RefreshRate[mode_lib->vba.NumberOfActivePlanes] = dst->refresh_rate; \n\t\tmode_lib->vba.OutputLinkDPRate[mode_lib->vba.NumberOfActivePlanes] = dout->dp_rate;\n\t\tmode_lib->vba.ODMUse[mode_lib->vba.NumberOfActivePlanes] = dst->odm_combine_policy;\n\t\tmode_lib->vba.DETSizeOverride[mode_lib->vba.NumberOfActivePlanes] = src->det_size_override;\n\t\tif (src->det_size_override)\n\t\t\tmode_lib->vba.DETBufferSizeInKByte[mode_lib->vba.NumberOfActivePlanes] = src->det_size_override;\n\t\telse\n\t\t\tmode_lib->vba.DETBufferSizeInKByte[mode_lib->vba.NumberOfActivePlanes] = ip->det_buffer_size_kbytes;\n\t\t\n\t\tmode_lib->vba.OutputMultistreamEn[mode_lib->vba.NumberOfActiveSurfaces] = dout->dp_multistream_en;\n\t\tmode_lib->vba.OutputMultistreamId[mode_lib->vba.NumberOfActiveSurfaces] = dout->dp_multistream_id;\n\t\tmode_lib->vba.PitchY[mode_lib->vba.NumberOfActivePlanes] = src->data_pitch;\n\t\tmode_lib->vba.SurfaceWidthY[mode_lib->vba.NumberOfActivePlanes] = src->surface_width_y;\n\t\tmode_lib->vba.SurfaceHeightY[mode_lib->vba.NumberOfActivePlanes] = src->surface_height_y;\n\t\tmode_lib->vba.PitchC[mode_lib->vba.NumberOfActivePlanes] = src->data_pitch_c;\n\t\tmode_lib->vba.SurfaceHeightC[mode_lib->vba.NumberOfActivePlanes] = src->surface_height_c;\n\t\tmode_lib->vba.SurfaceWidthC[mode_lib->vba.NumberOfActivePlanes] = src->surface_width_c;\n\t\tmode_lib->vba.DCCMetaPitchY[mode_lib->vba.NumberOfActivePlanes] = src->meta_pitch;\n\t\tmode_lib->vba.DCCMetaPitchC[mode_lib->vba.NumberOfActivePlanes] = src->meta_pitch_c;\n\t\tmode_lib->vba.HRatio[mode_lib->vba.NumberOfActivePlanes] = scl->hscl_ratio;\n\t\tmode_lib->vba.HRatioChroma[mode_lib->vba.NumberOfActivePlanes] = scl->hscl_ratio_c;\n\t\tmode_lib->vba.VRatio[mode_lib->vba.NumberOfActivePlanes] = scl->vscl_ratio;\n\t\tmode_lib->vba.VRatioChroma[mode_lib->vba.NumberOfActivePlanes] = scl->vscl_ratio_c;\n\t\tmode_lib->vba.ScalerEnabled[mode_lib->vba.NumberOfActivePlanes] = scl->scl_enable;\n\t\tmode_lib->vba.Interlace[mode_lib->vba.NumberOfActivePlanes] = dst->interlaced;\n\t\tif (dst->interlaced && !ip->ptoi_supported) {\n\t\t\tmode_lib->vba.VRatio[mode_lib->vba.NumberOfActivePlanes] *= 2.0;\n\t\t\tmode_lib->vba.VRatioChroma[mode_lib->vba.NumberOfActivePlanes] *= 2.0;\n\t\t}\n\t\tmode_lib->vba.htaps[mode_lib->vba.NumberOfActivePlanes] = taps->htaps;\n\t\tmode_lib->vba.vtaps[mode_lib->vba.NumberOfActivePlanes] = taps->vtaps;\n\t\tmode_lib->vba.HTAPsChroma[mode_lib->vba.NumberOfActivePlanes] = taps->htaps_c;\n\t\tmode_lib->vba.VTAPsChroma[mode_lib->vba.NumberOfActivePlanes] = taps->vtaps_c;\n\t\tmode_lib->vba.HTotal[mode_lib->vba.NumberOfActivePlanes] = dst->htotal;\n\t\tmode_lib->vba.VTotal[mode_lib->vba.NumberOfActivePlanes] = dst->vtotal;\n\t\tmode_lib->vba.VFrontPorch[mode_lib->vba.NumberOfActivePlanes] = dst->vfront_porch;\n\t\tmode_lib->vba.VBlankNom[mode_lib->vba.NumberOfActivePlanes] = dst->vblank_nom;\n\t\tmode_lib->vba.DCCFractionOfZeroSizeRequestsLuma[mode_lib->vba.NumberOfActivePlanes] = src->dcc_fraction_of_zs_req_luma;\n\t\tmode_lib->vba.DCCFractionOfZeroSizeRequestsChroma[mode_lib->vba.NumberOfActivePlanes] = src->dcc_fraction_of_zs_req_chroma;\n\t\tmode_lib->vba.DCCEnable[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->dcc_use_global ?\n\t\t\t\t\t\tip->dcc_supported : src->dcc && ip->dcc_supported;\n\t\tmode_lib->vba.DCCRate[mode_lib->vba.NumberOfActivePlanes] = src->dcc_rate;\n\t\t \n\t\tmode_lib->vba.DCCRateLuma[mode_lib->vba.NumberOfActivePlanes] = src->dcc_rate;\n\t\tmode_lib->vba.DCCRateChroma[mode_lib->vba.NumberOfActivePlanes] = src->dcc_rate_chroma;\n\t\tmode_lib->vba.SourcePixelFormat[mode_lib->vba.NumberOfActivePlanes] = (enum source_format_class) (src->source_format);\n\t\tmode_lib->vba.HActive[mode_lib->vba.NumberOfActivePlanes] = dst->hactive;\n\t\tmode_lib->vba.VActive[mode_lib->vba.NumberOfActivePlanes] = dst->vactive;\n\t\tmode_lib->vba.SurfaceTiling[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\t(enum dm_swizzle_mode) (src->sw_mode);\n\t\tmode_lib->vba.ScalerRecoutWidth[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdst->recout_width; \n\t\tmode_lib->vba.ODMCombineEnabled[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdst->odm_combine;\n\t\tmode_lib->vba.OutputFormat[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\t(enum output_format_class) (dout->output_format);\n\t\tmode_lib->vba.OutputBpp[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->output_bpp;\n\t\tmode_lib->vba.Output[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\t(enum output_encoder_class) (dout->output_type);\n\t\tmode_lib->vba.skip_dio_check[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->is_virtual;\n\n\t\tif (dout->dsc_enable)\n\t\t\tmode_lib->vba.ForcedOutputLinkBPP[mode_lib->vba.NumberOfActivePlanes] = dout->output_bpp;\n\t\telse\n\t\t\tmode_lib->vba.ForcedOutputLinkBPP[mode_lib->vba.NumberOfActivePlanes] = 0.0;\n\n\t\tmode_lib->vba.OutputLinkDPLanes[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->dp_lanes;\n\t\t \n\t\tmode_lib->vba.AudioSampleRate[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\tdout->max_audio_sample_rate;\n\t\tmode_lib->vba.AudioSampleLayout[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t1;\n\t\tmode_lib->vba.DRAMClockChangeLatencyOverride = 0.0;\n\t\tmode_lib->vba.DSCEnabled[mode_lib->vba.NumberOfActivePlanes] = dout->dsc_enable;\n\t\tmode_lib->vba.DSCEnable[mode_lib->vba.NumberOfActivePlanes] = dout->dsc_enable;\n\t\tmode_lib->vba.NumberOfDSCSlices[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->dsc_slices;\n\t\tif (!dout->dsc_input_bpc) {\n\t\t\tmode_lib->vba.DSCInputBitPerComponent[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tip->maximum_dsc_bits_per_component;\n\t\t} else {\n\t\t\tmode_lib->vba.DSCInputBitPerComponent[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->dsc_input_bpc;\n\t\t}\n\t\tmode_lib->vba.WritebackEnable[mode_lib->vba.NumberOfActivePlanes] = dout->wb_enable;\n\t\tmode_lib->vba.ActiveWritebacksPerPlane[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->num_active_wb;\n\t\tmode_lib->vba.WritebackSourceHeight[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_src_height;\n\t\tmode_lib->vba.WritebackSourceWidth[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_src_width;\n\t\tmode_lib->vba.WritebackDestinationWidth[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_dst_width;\n\t\tmode_lib->vba.WritebackDestinationHeight[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_dst_height;\n\t\tmode_lib->vba.WritebackHRatio[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_hratio;\n\t\tmode_lib->vba.WritebackVRatio[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_vratio;\n\t\tmode_lib->vba.WritebackPixelFormat[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\t(enum source_format_class) (dout->wb.wb_pixel_format);\n\t\tmode_lib->vba.WritebackHTaps[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_htaps_luma;\n\t\tmode_lib->vba.WritebackVTaps[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_vtaps_luma;\n\t\tmode_lib->vba.WritebackLumaHTaps[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_htaps_luma;\n\t\tmode_lib->vba.WritebackLumaVTaps[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_vtaps_luma;\n\t\tmode_lib->vba.WritebackChromaHTaps[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_htaps_chroma;\n\t\tmode_lib->vba.WritebackChromaVTaps[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_vtaps_chroma;\n\t\tmode_lib->vba.WritebackHRatio[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_hratio;\n\t\tmode_lib->vba.WritebackVRatio[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tdout->wb.wb_vratio;\n\n\t\tmode_lib->vba.DynamicMetadataEnable[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->dynamic_metadata_enable;\n\t\tmode_lib->vba.DynamicMetadataLinesBeforeActiveRequired[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->dynamic_metadata_lines_before_active;\n\t\tmode_lib->vba.DynamicMetadataTransmittedBytes[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\tsrc->dynamic_metadata_xmit_bytes;\n\n\t\tmode_lib->vba.XFCEnabled[mode_lib->vba.NumberOfActivePlanes] = src->xfc_enable\n\t\t\t\t&& ip->xfc_supported;\n\t\tmode_lib->vba.XFCSlvChunkSize = src->xfc_params.xfc_slv_chunk_size_bytes;\n\t\tmode_lib->vba.XFCTSlvVupdateOffset = src->xfc_params.xfc_tslv_vupdate_offset_us;\n\t\tmode_lib->vba.XFCTSlvVupdateWidth = src->xfc_params.xfc_tslv_vupdate_width_us;\n\t\tmode_lib->vba.XFCTSlvVreadyOffset = src->xfc_params.xfc_tslv_vready_offset_us;\n\t\tmode_lib->vba.PixelClock[mode_lib->vba.NumberOfActivePlanes] = dst->pixel_rate_mhz;\n\t\tmode_lib->vba.PixelClockBackEnd[mode_lib->vba.NumberOfActivePlanes] = dst->pixel_rate_mhz;\n\t\tmode_lib->vba.DPPCLK[mode_lib->vba.NumberOfActivePlanes] = clks->dppclk_mhz;\n\t\tmode_lib->vba.DRRDisplay[mode_lib->vba.NumberOfActiveSurfaces] = dst->drr_display;\n\t\tif (ip->is_line_buffer_bpp_fixed)\n\t\t\tmode_lib->vba.LBBitPerPixel[mode_lib->vba.NumberOfActivePlanes] =\n\t\t\t\t\tip->line_buffer_fixed_bpp;\n\t\telse {\n\t\t\tunsigned int lb_depth;\n\n\t\t\tswitch (scl->lb_depth) {\n\t\t\tcase dm_lb_6:\n\t\t\t\tlb_depth = 18;\n\t\t\t\tbreak;\n\t\t\tcase dm_lb_8:\n\t\t\t\tlb_depth = 24;\n\t\t\t\tbreak;\n\t\t\tcase dm_lb_10:\n\t\t\t\tlb_depth = 30;\n\t\t\t\tbreak;\n\t\t\tcase dm_lb_12:\n\t\t\t\tlb_depth = 36;\n\t\t\t\tbreak;\n\t\t\tcase dm_lb_16:\n\t\t\t\tlb_depth = 48;\n\t\t\t\tbreak;\n\t\t\tcase dm_lb_19:\n\t\t\t\tlb_depth = 57;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tlb_depth = 36;\n\t\t\t}\n\t\t\tmode_lib->vba.LBBitPerPixel[mode_lib->vba.NumberOfActivePlanes] = lb_depth;\n\t\t}\n\t\tmode_lib->vba.NumberOfCursors[mode_lib->vba.NumberOfActivePlanes] = 0;\n\t\t\n\t\t\n\t\tfor (k = 0; k < DC__NUM_CURSOR__MAX; ++k) {\n\t\t\tswitch (k) {\n\t\t\tcase 0:\n\t\t\t\tmode_lib->vba.CursorBPP[mode_lib->vba.NumberOfActivePlanes][0] =\n\t\t\t\t\t\tCursorBppEnumToBits(\n\t\t\t\t\t\t\t\t(enum cursor_bpp) (src->cur0_bpp));\n\t\t\t\tmode_lib->vba.CursorWidth[mode_lib->vba.NumberOfActivePlanes][0] =\n\t\t\t\t\t\tsrc->cur0_src_width;\n\t\t\t\tif (src->cur0_src_width > 0)\n\t\t\t\t\tmode_lib->vba.NumberOfCursors[mode_lib->vba.NumberOfActivePlanes]++;\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\t\tmode_lib->vba.CursorBPP[mode_lib->vba.NumberOfActivePlanes][1] =\n\t\t\t\t\t\tCursorBppEnumToBits(\n\t\t\t\t\t\t\t\t(enum cursor_bpp) (src->cur1_bpp));\n\t\t\t\tmode_lib->vba.CursorWidth[mode_lib->vba.NumberOfActivePlanes][1] =\n\t\t\t\t\t\tsrc->cur1_src_width;\n\t\t\t\tif (src->cur1_src_width > 0)\n\t\t\t\t\tmode_lib->vba.NumberOfCursors[mode_lib->vba.NumberOfActivePlanes]++;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdml_print(\n\t\t\t\t\t\t\"ERROR: Number of cursors specified exceeds supported maximum\\n\")\n\t\t\t\t;\n\t\t\t}\n\t\t}\n\n\t\tOTGInstPlane[mode_lib->vba.NumberOfActivePlanes] = dst->otg_inst;\n\n\t\tif (j == 0)\n\t\t\tmode_lib->vba.UseMaximumVStartup = dst->use_maximum_vstartup;\n\t\telse\n\t\t\tmode_lib->vba.UseMaximumVStartup = mode_lib->vba.UseMaximumVStartup\n\t\t\t\t\t\t\t\t\t|| dst->use_maximum_vstartup;\n\n\t\tif (dst->odm_combine && !src->is_hsplit)\n\t\t\tdml_print(\n\t\t\t\t\t\"ERROR: ODM Combine is specified but is_hsplit has not be specified for pipe %i\\n\",\n\t\t\t\t\tj);\n\n\t\tif (src->is_hsplit) {\n\t\t\tfor (k = j + 1; k < mode_lib->vba.cache_num_pipes; ++k) {\n\t\t\t\tdisplay_pipe_source_params_st *src_k = &pipes[k].pipe.src;\n\t\t\t\tdisplay_pipe_dest_params_st *dst_k = &pipes[k].pipe.dest;\n\n\t\t\t\tif (src_k->is_hsplit && !visited[k]\n\t\t\t\t\t\t&& src->hsplit_grp == src_k->hsplit_grp) {\n\t\t\t\t\tmode_lib->vba.pipe_plane[k] =\n\t\t\t\t\t\t\tmode_lib->vba.NumberOfActivePlanes;\n\t\t\t\t\tmode_lib->vba.DPPPerPlane[mode_lib->vba.NumberOfActivePlanes]++;\n\t\t\t\t\tif (src_k->det_size_override)\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeInKByte[mode_lib->vba.NumberOfActivePlanes] = src_k->det_size_override;\n\t\t\t\t\tif (mode_lib->vba.SourceScan[mode_lib->vba.NumberOfActivePlanes]\n\t\t\t\t\t\t\t== dm_horz) {\n\t\t\t\t\t\tmode_lib->vba.ViewportWidth[mode_lib->vba.NumberOfActivePlanes] +=\n\t\t\t\t\t\t\t\tsrc_k->viewport_width;\n\t\t\t\t\t\tmode_lib->vba.ViewportWidthChroma[mode_lib->vba.NumberOfActivePlanes] +=\n\t\t\t\t\t\t\t\tsrc_k->viewport_width_c;\n\t\t\t\t\t\tmode_lib->vba.ScalerRecoutWidth[mode_lib->vba.NumberOfActivePlanes] +=\n\t\t\t\t\t\t\t\tdst_k->recout_width;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.ViewportHeight[mode_lib->vba.NumberOfActivePlanes] +=\n\t\t\t\t\t\t\t\tsrc_k->viewport_height;\n\t\t\t\t\t\tmode_lib->vba.ViewportHeightChroma[mode_lib->vba.NumberOfActivePlanes] +=\n\t\t\t\t\t\t\t\tsrc_k->viewport_height_c;\n\t\t\t\t\t}\n\n\t\t\t\t\tvisited[k] = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (src->viewport_width_max) {\n\t\t\tint hdiv_c = src->source_format >= dm_420_8 && src->source_format <= dm_422_10 ? 2 : 1;\n\t\t\tint vdiv_c = src->source_format >= dm_420_8 && src->source_format <= dm_420_12 ? 2 : 1;\n\n\t\t\tif (mode_lib->vba.ViewportWidth[mode_lib->vba.NumberOfActivePlanes] > src->viewport_width_max)\n\t\t\t\tmode_lib->vba.ViewportWidth[mode_lib->vba.NumberOfActivePlanes] = src->viewport_width_max;\n\t\t\tif (mode_lib->vba.ViewportHeight[mode_lib->vba.NumberOfActivePlanes] > src->viewport_height_max)\n\t\t\t\tmode_lib->vba.ViewportHeight[mode_lib->vba.NumberOfActivePlanes] = src->viewport_height_max;\n\t\t\tif (mode_lib->vba.ViewportWidthChroma[mode_lib->vba.NumberOfActivePlanes] > src->viewport_width_max / hdiv_c)\n\t\t\t\tmode_lib->vba.ViewportWidthChroma[mode_lib->vba.NumberOfActivePlanes] = src->viewport_width_max / hdiv_c;\n\t\t\tif (mode_lib->vba.ViewportHeightChroma[mode_lib->vba.NumberOfActivePlanes] > src->viewport_height_max / vdiv_c)\n\t\t\t\tmode_lib->vba.ViewportHeightChroma[mode_lib->vba.NumberOfActivePlanes] = src->viewport_height_max / vdiv_c;\n\t\t}\n\n\t\tif (pipes[j].pipe.src.immediate_flip) {\n\t\t\tmode_lib->vba.ImmediateFlipSupport = true;\n\t\t\tmode_lib->vba.ImmediateFlipRequirement[j] = dm_immediate_flip_required;\n\t\t}\n\n\t\tmode_lib->vba.NumberOfActivePlanes++;\n\t\tmode_lib->vba.NumberOfActiveSurfaces++;\n\t}\n\n\t\n\t\n\n\tfor (j = 0; j < mode_lib->vba.NumberOfActivePlanes; ++j)\n\t\tPlaneVisited[j] = false;\n\n\tfor (j = 0; j < mode_lib->vba.NumberOfActivePlanes; ++j) {\n\t\tfor (k = j + 1; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\tif (!PlaneVisited[k] && OTGInstPlane[j] == OTGInstPlane[k]) {\n\t\t\t\t\n\t\t\t\tmode_lib->vba.BlendingAndTiming[j] = j;\n\t\t\t\tPlaneVisited[j] = true;\n\t\t\t\tmode_lib->vba.BlendingAndTiming[k] = j;\n\t\t\t\tPlaneVisited[k] = true;\n\t\t\t}\n\t\t}\n\n\t\tif (!PlaneVisited[j]) {\n\t\t\tmode_lib->vba.BlendingAndTiming[j] = j;\n\t\t\tPlaneVisited[j] = true;\n\t\t}\n\t}\n\n\tmode_lib->vba.SynchronizeTimingsFinal = pipes[0].pipe.dest.synchronize_timings;\n\tmode_lib->vba.DCCProgrammingAssumesScanDirectionUnknownFinal = false;\n\n\tmode_lib->vba.DisableUnboundRequestIfCompBufReservedSpaceNeedAdjustment = 0;\n\n\tmode_lib->vba.UseUnboundedRequesting = dm_unbounded_requesting;\n\tfor (k = 0; k < mode_lib->vba.cache_num_pipes; ++k) {\n\t\tif (pipes[k].pipe.src.unbounded_req_mode == 0)\n\t\t\tmode_lib->vba.UseUnboundedRequesting = dm_unbounded_requesting_disable;\n\t}\n\t\n\t\n\tmode_lib->vba.SynchronizedVBlank = pipes[0].pipe.dest.synchronized_vblank_all_planes;\n\tfor (k = 1; k < mode_lib->vba.cache_num_pipes; ++k) {\n\t\tASSERT(mode_lib->vba.SynchronizedVBlank == pipes[k].pipe.dest.synchronized_vblank_all_planes);\n\t}\n\n\tmode_lib->vba.GPUVMEnable = false;\n\tmode_lib->vba.HostVMEnable = false;\n\tmode_lib->vba.OverrideGPUVMPageTableLevels = 0;\n\tmode_lib->vba.OverrideHostVMPageTableLevels = 0;\n\n\tfor (k = 0; k < mode_lib->vba.cache_num_pipes; ++k) {\n\t\tmode_lib->vba.GPUVMEnable = mode_lib->vba.GPUVMEnable || !!pipes[k].pipe.src.gpuvm || !!pipes[k].pipe.src.vm;\n\t\tmode_lib->vba.OverrideGPUVMPageTableLevels =\n\t\t\t\t(pipes[k].pipe.src.gpuvm_levels_force_en\n\t\t\t\t\t\t&& mode_lib->vba.OverrideGPUVMPageTableLevels\n\t\t\t\t\t\t\t\t< pipes[k].pipe.src.gpuvm_levels_force) ?\n\t\t\t\t\t\tpipes[k].pipe.src.gpuvm_levels_force :\n\t\t\t\t\t\tmode_lib->vba.OverrideGPUVMPageTableLevels;\n\n\t\tmode_lib->vba.HostVMEnable = mode_lib->vba.HostVMEnable || !!pipes[k].pipe.src.hostvm || !!pipes[k].pipe.src.vm;\n\t\tmode_lib->vba.OverrideHostVMPageTableLevels =\n\t\t\t\t(pipes[k].pipe.src.hostvm_levels_force_en\n\t\t\t\t\t\t&& mode_lib->vba.OverrideHostVMPageTableLevels\n\t\t\t\t\t\t\t\t< pipes[k].pipe.src.hostvm_levels_force) ?\n\t\t\t\t\t\tpipes[k].pipe.src.hostvm_levels_force :\n\t\t\t\t\t\tmode_lib->vba.OverrideHostVMPageTableLevels;\n\t}\n\n\tif (mode_lib->vba.OverrideGPUVMPageTableLevels)\n\t\tmode_lib->vba.GPUVMMaxPageTableLevels = mode_lib->vba.OverrideGPUVMPageTableLevels;\n\n\tif (mode_lib->vba.OverrideHostVMPageTableLevels)\n\t\tmode_lib->vba.HostVMMaxPageTableLevels = mode_lib->vba.OverrideHostVMPageTableLevels;\n\n\tmode_lib->vba.GPUVMEnable = mode_lib->vba.GPUVMEnable && !!ip->gpuvm_enable;\n\tmode_lib->vba.HostVMEnable = mode_lib->vba.HostVMEnable && !!ip->hostvm_enable;\n\n\tfor (k = 0; k < mode_lib->vba.cache_num_pipes; ++k) {\n\t\tmode_lib->vba.ForceOneRowForFrame[k] = pipes[k].pipe.src.force_one_row_for_frame;\n\t\tmode_lib->vba.PteBufferMode[k] = pipes[k].pipe.src.pte_buffer_mode;\n\n\t\tif (mode_lib->vba.PteBufferMode[k] == 0 && mode_lib->vba.GPUVMEnable) {\n\t\t\tif (mode_lib->vba.ForceOneRowForFrame[k] ||\n\t\t\t\t(mode_lib->vba.GPUVMMinPageSizeKBytes[k] > 64*1024) ||\n\t\t\t\t(mode_lib->vba.UsesMALLForPStateChange[k] != dm_use_mall_pstate_change_disable) ||\n\t\t\t\t(mode_lib->vba.UseMALLForStaticScreen[k] != dm_use_mall_static_screen_disable)) {\n#ifdef __DML_VBA_DEBUG__\n\t\t\t\tdml_print(\"DML::%s: ERROR: Invalid PteBufferMode=%d for plane %0d!\\n\",\n\t\t\t\t\t\t__func__, mode_lib->vba.PteBufferMode[k], k);\n\t\t\t\tdml_print(\"DML::%s:  -  ForceOneRowForFrame     = %d\\n\",\n\t\t\t\t\t\t__func__, mode_lib->vba.ForceOneRowForFrame[k]);\n\t\t\t\tdml_print(\"DML::%s:  -  GPUVMMinPageSizeKBytes  = %d\\n\",\n\t\t\t\t\t\t__func__, mode_lib->vba.GPUVMMinPageSizeKBytes[k]);\n\t\t\t\tdml_print(\"DML::%s:  -  UseMALLForPStateChange  = %d\\n\",\n\t\t\t\t\t\t__func__, (int) mode_lib->vba.UsesMALLForPStateChange[k]);\n\t\t\t\tdml_print(\"DML::%s:  -  UseMALLForStaticScreen  = %d\\n\",\n\t\t\t\t\t\t__func__, (int) mode_lib->vba.UseMALLForStaticScreen[k]);\n#endif\n\t\t\t\tASSERT(0);\n\t\t\t}\n\t\t}\n\t}\n}\n\n \nstatic void cache_debug_params(struct display_mode_lib *mode_lib)\n{\n\tint k = 0;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; k++)\n\t\tmode_lib->vba.CachedActiveDRAMClockChangeLatencyMargin[k] = mode_lib->vba.ActiveDRAMClockChangeLatencyMargin[k];\n}\n\n\n\nstatic void recalculate_params(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tconst display_e2e_pipe_params_st *pipes,\n\t\tunsigned int num_pipes)\n{\n\t\n\tif (memcmp(&mode_lib->soc, &mode_lib->vba.soc, sizeof(mode_lib->vba.soc)) != 0\n\t\t\t|| memcmp(&mode_lib->ip, &mode_lib->vba.ip, sizeof(mode_lib->vba.ip)) != 0\n\t\t\t|| num_pipes != mode_lib->vba.cache_num_pipes\n\t\t\t|| memcmp(\n\t\t\t\t\tpipes,\n\t\t\t\t\tmode_lib->vba.cache_pipes,\n\t\t\t\t\tsizeof(display_e2e_pipe_params_st) * num_pipes) != 0) {\n\t\tmode_lib->vba.soc = mode_lib->soc;\n\t\tmode_lib->vba.ip = mode_lib->ip;\n\t\tmemcpy(mode_lib->vba.cache_pipes, pipes, sizeof(*pipes) * num_pipes);\n\t\tmode_lib->vba.cache_num_pipes = num_pipes;\n\t\tmode_lib->funcs.recalculate(mode_lib);\n\t}\n}\n\nvoid Calculate256BBlockSizes(\n\t\tenum source_format_class SourcePixelFormat,\n\t\tenum dm_swizzle_mode SurfaceTiling,\n\t\tunsigned int BytePerPixelY,\n\t\tunsigned int BytePerPixelC,\n\t\tunsigned int *BlockHeight256BytesY,\n\t\tunsigned int *BlockHeight256BytesC,\n\t\tunsigned int *BlockWidth256BytesY,\n\t\tunsigned int *BlockWidth256BytesC)\n{\n\tif ((SourcePixelFormat == dm_444_64 || SourcePixelFormat == dm_444_32\n\t\t\t|| SourcePixelFormat == dm_444_16 || SourcePixelFormat == dm_444_8)) {\n\t\tif (SurfaceTiling == dm_sw_linear) {\n\t\t\t*BlockHeight256BytesY = 1;\n\t\t} else if (SourcePixelFormat == dm_444_64) {\n\t\t\t*BlockHeight256BytesY = 4;\n\t\t} else if (SourcePixelFormat == dm_444_8) {\n\t\t\t*BlockHeight256BytesY = 16;\n\t\t} else {\n\t\t\t*BlockHeight256BytesY = 8;\n\t\t}\n\t\t*BlockWidth256BytesY = 256 / BytePerPixelY / *BlockHeight256BytesY;\n\t\t*BlockHeight256BytesC = 0;\n\t\t*BlockWidth256BytesC = 0;\n\t} else {\n\t\tif (SurfaceTiling == dm_sw_linear) {\n\t\t\t*BlockHeight256BytesY = 1;\n\t\t\t*BlockHeight256BytesC = 1;\n\t\t} else if (SourcePixelFormat == dm_420_8) {\n\t\t\t*BlockHeight256BytesY = 16;\n\t\t\t*BlockHeight256BytesC = 8;\n\t\t} else {\n\t\t\t*BlockHeight256BytesY = 8;\n\t\t\t*BlockHeight256BytesC = 8;\n\t\t}\n\t\t*BlockWidth256BytesY = 256 / BytePerPixelY / *BlockHeight256BytesY;\n\t\t*BlockWidth256BytesC = 256 / BytePerPixelC / *BlockHeight256BytesC;\n\t}\n}\n\nbool CalculateMinAndMaxPrefetchMode(\n\t\tenum self_refresh_affinity AllowDRAMSelfRefreshOrDRAMClockChangeInVblank,\n\t\tunsigned int *MinPrefetchMode,\n\t\tunsigned int *MaxPrefetchMode)\n{\n\tif (AllowDRAMSelfRefreshOrDRAMClockChangeInVblank\n\t\t\t== dm_neither_self_refresh_nor_mclk_switch) {\n\t\t*MinPrefetchMode = 2;\n\t\t*MaxPrefetchMode = 2;\n\t\treturn false;\n\t} else if (AllowDRAMSelfRefreshOrDRAMClockChangeInVblank == dm_allow_self_refresh) {\n\t\t*MinPrefetchMode = 1;\n\t\t*MaxPrefetchMode = 1;\n\t\treturn false;\n\t} else if (AllowDRAMSelfRefreshOrDRAMClockChangeInVblank\n\t\t\t== dm_allow_self_refresh_and_mclk_switch) {\n\t\t*MinPrefetchMode = 0;\n\t\t*MaxPrefetchMode = 0;\n\t\treturn false;\n\t} else if (AllowDRAMSelfRefreshOrDRAMClockChangeInVblank\n\t\t\t== dm_try_to_allow_self_refresh_and_mclk_switch) {\n\t\t*MinPrefetchMode = 0;\n\t\t*MaxPrefetchMode = 2;\n\t\treturn false;\n\t}\n\t*MinPrefetchMode = 0;\n\t*MaxPrefetchMode = 2;\n\treturn true;\n}\n\nvoid PixelClockAdjustmentForProgressiveToInterlaceUnit(struct display_mode_lib *mode_lib)\n{\n\tunsigned int k;\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.PixelClockBackEnd[k] = mode_lib->vba.PixelClock[k];\n\t\tif (mode_lib->vba.Interlace[k] == 1\n\t\t\t\t&& mode_lib->vba.ProgressiveToInterlaceUnitInOPP == true) {\n\t\t\tmode_lib->vba.PixelClock[k] = 2 * mode_lib->vba.PixelClock[k];\n\t\t}\n\t}\n}\n\nstatic unsigned int CursorBppEnumToBits(enum cursor_bpp ebpp)\n{\n\tswitch (ebpp) {\n\tcase dm_cur_2bit:\n\t\treturn 2;\n\tcase dm_cur_32bit:\n\t\treturn 32;\n\tcase dm_cur_64bit:\n\t\treturn 64;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nvoid ModeSupportAndSystemConfiguration(struct display_mode_lib *mode_lib)\n{\n\tsoc_bounding_box_st *soc = &mode_lib->vba.soc;\n\tunsigned int k;\n\tunsigned int total_pipes = 0;\n\tunsigned int pipe_idx = 0;\n\n\tmode_lib->vba.VoltageLevel = mode_lib->vba.cache_pipes[0].clks_cfg.voltage;\n\tmode_lib->vba.ReturnBW = mode_lib->vba.ReturnBWPerState[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb];\n\tif (mode_lib->vba.ReturnBW == 0)\n\t\tmode_lib->vba.ReturnBW = mode_lib->vba.ReturnBWPerState[mode_lib->vba.VoltageLevel][0];\n\tmode_lib->vba.FabricAndDRAMBandwidth = mode_lib->vba.FabricAndDRAMBandwidthPerState[mode_lib->vba.VoltageLevel];\n\n\tfetch_socbb_params(mode_lib);\n\tfetch_ip_params(mode_lib);\n\tfetch_pipe_params(mode_lib);\n\n\tmode_lib->vba.DCFCLK = mode_lib->vba.cache_pipes[0].clks_cfg.dcfclk_mhz;\n\tmode_lib->vba.SOCCLK = mode_lib->vba.cache_pipes[0].clks_cfg.socclk_mhz;\n\tif (mode_lib->vba.cache_pipes[0].clks_cfg.dispclk_mhz > 0.0)\n\t\tmode_lib->vba.DISPCLK = mode_lib->vba.cache_pipes[0].clks_cfg.dispclk_mhz;\n\telse\n\t\tmode_lib->vba.DISPCLK = soc->clock_limits[mode_lib->vba.VoltageLevel].dispclk_mhz;\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\ttotal_pipes += mode_lib->vba.DPPPerPlane[k];\n\t\tpipe_idx = get_pipe_idx(mode_lib, k);\n\t\tif (mode_lib->vba.cache_pipes[pipe_idx].clks_cfg.dppclk_mhz > 0.0)\n\t\t\tmode_lib->vba.DPPCLK[k] = mode_lib->vba.cache_pipes[pipe_idx].clks_cfg.dppclk_mhz;\n\t\telse\n\t\t\tmode_lib->vba.DPPCLK[k] = soc->clock_limits[mode_lib->vba.VoltageLevel].dppclk_mhz;\n\t}\n\tASSERT(total_pipes <= DC__NUM_DPP__MAX);\n}\n\ndouble CalculateWriteBackDISPCLK(\n\t\tenum source_format_class WritebackPixelFormat,\n\t\tdouble PixelClock,\n\t\tdouble WritebackHRatio,\n\t\tdouble WritebackVRatio,\n\t\tunsigned int WritebackLumaHTaps,\n\t\tunsigned int WritebackLumaVTaps,\n\t\tunsigned int WritebackChromaHTaps,\n\t\tunsigned int WritebackChromaVTaps,\n\t\tdouble WritebackDestinationWidth,\n\t\tunsigned int HTotal,\n\t\tunsigned int WritebackChromaLineBufferWidth)\n{\n\tdouble CalculateWriteBackDISPCLK = 1.01 * PixelClock * dml_max(\n\t\tdml_ceil(WritebackLumaHTaps / 4.0, 1) / WritebackHRatio,\n\t\tdml_max((WritebackLumaVTaps * dml_ceil(1.0 / WritebackVRatio, 1) * dml_ceil(WritebackDestinationWidth / 4.0, 1)\n\t\t\t+ dml_ceil(WritebackDestinationWidth / 4.0, 1)) / (double) HTotal + dml_ceil(1.0 / WritebackVRatio, 1)\n\t\t\t* (dml_ceil(WritebackLumaVTaps / 4.0, 1) + 4.0) / (double) HTotal,\n\t\t\tdml_ceil(1.0 / WritebackVRatio, 1) * WritebackDestinationWidth / (double) HTotal));\n\tif (WritebackPixelFormat != dm_444_32) {\n\t\tCalculateWriteBackDISPCLK = dml_max(CalculateWriteBackDISPCLK, 1.01 * PixelClock * dml_max(\n\t\t\tdml_ceil(WritebackChromaHTaps / 2.0, 1) / (2 * WritebackHRatio),\n\t\t\tdml_max((WritebackChromaVTaps * dml_ceil(1 / (2 * WritebackVRatio), 1) * dml_ceil(WritebackDestinationWidth / 2.0 / 2.0, 1)\n\t\t\t\t+ dml_ceil(WritebackDestinationWidth / 2.0 / WritebackChromaLineBufferWidth, 1)) / HTotal\n\t\t\t\t+ dml_ceil(1 / (2 * WritebackVRatio), 1) * (dml_ceil(WritebackChromaVTaps / 4.0, 1) + 4) / HTotal,\n\t\t\t\tdml_ceil(1.0 / (2 * WritebackVRatio), 1) * WritebackDestinationWidth / 2.0 / HTotal)));\n\t}\n\treturn CalculateWriteBackDISPCLK;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}