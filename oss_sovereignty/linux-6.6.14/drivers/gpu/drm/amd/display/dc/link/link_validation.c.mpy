{
  "module_name": "link_validation.c",
  "hash_id": "7e82d4b9ba1ee0e4617e53f1c1cea9825d6818f8e3624be54d82dd7bdc499bcb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/link/link_validation.c",
  "human_readable_source": " \n\n \n#include \"link_validation.h\"\n#include \"protocols/link_dp_capability.h\"\n#include \"protocols/link_dp_dpia_bw.h\"\n#include \"resource.h\"\n\n#define DC_LOGGER_INIT(logger)\n\nstatic uint32_t get_tmds_output_pixel_clock_100hz(const struct dc_crtc_timing *timing)\n{\n\n\tuint32_t pxl_clk = timing->pix_clk_100hz;\n\n\tif (timing->pixel_encoding == PIXEL_ENCODING_YCBCR420)\n\t\tpxl_clk /= 2;\n\telse if (timing->pixel_encoding == PIXEL_ENCODING_YCBCR422)\n\t\tpxl_clk = pxl_clk * 2 / 3;\n\n\tif (timing->display_color_depth == COLOR_DEPTH_101010)\n\t\tpxl_clk = pxl_clk * 10 / 8;\n\telse if (timing->display_color_depth == COLOR_DEPTH_121212)\n\t\tpxl_clk = pxl_clk * 12 / 8;\n\n\treturn pxl_clk;\n}\n\nstatic bool dp_active_dongle_validate_timing(\n\t\tconst struct dc_crtc_timing *timing,\n\t\tconst struct dpcd_caps *dpcd_caps)\n{\n\tconst struct dc_dongle_caps *dongle_caps = &dpcd_caps->dongle_caps;\n\n\tswitch (dpcd_caps->dongle_type) {\n\tcase DISPLAY_DONGLE_DP_VGA_CONVERTER:\n\tcase DISPLAY_DONGLE_DP_DVI_CONVERTER:\n\tcase DISPLAY_DONGLE_DP_DVI_DONGLE:\n\t\tif (timing->pixel_encoding == PIXEL_ENCODING_RGB)\n\t\t\treturn true;\n\t\telse\n\t\t\treturn false;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (dpcd_caps->dongle_type == DISPLAY_DONGLE_DP_HDMI_CONVERTER &&\n\t\t\tdongle_caps->extendedCapValid == true) {\n\t\t \n\t\tswitch (timing->pixel_encoding) {\n\t\tcase PIXEL_ENCODING_RGB:\n\t\tcase PIXEL_ENCODING_YCBCR444:\n\t\t\tbreak;\n\t\tcase PIXEL_ENCODING_YCBCR422:\n\t\t\tif (!dongle_caps->is_dp_hdmi_ycbcr422_pass_through)\n\t\t\t\treturn false;\n\t\t\tbreak;\n\t\tcase PIXEL_ENCODING_YCBCR420:\n\t\t\tif (!dongle_caps->is_dp_hdmi_ycbcr420_pass_through)\n\t\t\t\treturn false;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\treturn false;\n\t\t}\n\n\t\tswitch (timing->display_color_depth) {\n\t\tcase COLOR_DEPTH_666:\n\t\tcase COLOR_DEPTH_888:\n\t\t\t \n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_101010:\n\t\t\tif (dongle_caps->dp_hdmi_max_bpc < 10)\n\t\t\t\treturn false;\n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_121212:\n\t\t\tif (dongle_caps->dp_hdmi_max_bpc < 12)\n\t\t\t\treturn false;\n\t\t\tbreak;\n\t\tcase COLOR_DEPTH_141414:\n\t\tcase COLOR_DEPTH_161616:\n\t\tdefault:\n\t\t\t \n\t\t\treturn false;\n\t\t}\n\n\t\t \n\t\tswitch (timing->timing_3d_format) {\n\t\tcase TIMING_3D_FORMAT_NONE:\n\t\tcase TIMING_3D_FORMAT_FRAME_ALTERNATE:\n\t\t\t \n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\treturn false;\n\t\t}\n\n\t\tif (dongle_caps->dp_hdmi_frl_max_link_bw_in_kbps > 0) { \n\t\t\tstruct dc_crtc_timing outputTiming = *timing;\n\n#if defined(CONFIG_DRM_AMD_DC_FP)\n\t\t\tif (timing->flags.DSC && !timing->dsc_cfg.is_frl)\n\t\t\t\t \n\t\t\t\toutputTiming.flags.DSC = 0;\n#endif\n\t\t\tif (dc_bandwidth_in_kbps_from_timing(&outputTiming, DC_LINK_ENCODING_HDMI_FRL) >\n\t\t\t\t\tdongle_caps->dp_hdmi_frl_max_link_bw_in_kbps)\n\t\t\t\treturn false;\n\t\t} else { \n\t\t\tif (get_tmds_output_pixel_clock_100hz(timing) > (dongle_caps->dp_hdmi_max_pixel_clk_in_khz * 10))\n\t\t\t\treturn false;\n\t\t}\n\t}\n\n\tif (dpcd_caps->channel_coding_cap.bits.DP_128b_132b_SUPPORTED == 0 &&\n\t\t\tdpcd_caps->dsc_caps.dsc_basic_caps.fields.dsc_support.DSC_PASSTHROUGH_SUPPORT == 0 &&\n\t\t\tdongle_caps->dfp_cap_ext.supported) {\n\n\t\tif (dongle_caps->dfp_cap_ext.max_pixel_rate_in_mps < (timing->pix_clk_100hz / 10000))\n\t\t\treturn false;\n\n\t\tif (dongle_caps->dfp_cap_ext.max_video_h_active_width < timing->h_addressable)\n\t\t\treturn false;\n\n\t\tif (dongle_caps->dfp_cap_ext.max_video_v_active_height < timing->v_addressable)\n\t\t\treturn false;\n\n\t\tif (timing->pixel_encoding == PIXEL_ENCODING_RGB) {\n\t\t\tif (!dongle_caps->dfp_cap_ext.encoding_format_caps.support_rgb)\n\t\t\t\treturn false;\n\t\t\tif (timing->display_color_depth == COLOR_DEPTH_666 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.rgb_color_depth_caps.support_6bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_888 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.rgb_color_depth_caps.support_8bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_101010 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.rgb_color_depth_caps.support_10bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_121212 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.rgb_color_depth_caps.support_12bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_161616 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.rgb_color_depth_caps.support_16bpc)\n\t\t\t\treturn false;\n\t\t} else if (timing->pixel_encoding == PIXEL_ENCODING_YCBCR444) {\n\t\t\tif (!dongle_caps->dfp_cap_ext.encoding_format_caps.support_rgb)\n\t\t\t\treturn false;\n\t\t\tif (timing->display_color_depth == COLOR_DEPTH_888 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr444_color_depth_caps.support_8bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_101010 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr444_color_depth_caps.support_10bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_121212 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr444_color_depth_caps.support_12bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_161616 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr444_color_depth_caps.support_16bpc)\n\t\t\t\treturn false;\n\t\t} else if (timing->pixel_encoding == PIXEL_ENCODING_YCBCR422) {\n\t\t\tif (!dongle_caps->dfp_cap_ext.encoding_format_caps.support_rgb)\n\t\t\t\treturn false;\n\t\t\tif (timing->display_color_depth == COLOR_DEPTH_888 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr422_color_depth_caps.support_8bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_101010 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr422_color_depth_caps.support_10bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_121212 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr422_color_depth_caps.support_12bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_161616 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr422_color_depth_caps.support_16bpc)\n\t\t\t\treturn false;\n\t\t} else if (timing->pixel_encoding == PIXEL_ENCODING_YCBCR420) {\n\t\t\tif (!dongle_caps->dfp_cap_ext.encoding_format_caps.support_rgb)\n\t\t\t\treturn false;\n\t\t\tif (timing->display_color_depth == COLOR_DEPTH_888 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr420_color_depth_caps.support_8bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_101010 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr420_color_depth_caps.support_10bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_121212 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr420_color_depth_caps.support_12bpc)\n\t\t\t\treturn false;\n\t\t\telse if (timing->display_color_depth == COLOR_DEPTH_161616 &&\n\t\t\t\t\t!dongle_caps->dfp_cap_ext.ycbcr420_color_depth_caps.support_16bpc)\n\t\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\nuint32_t dp_link_bandwidth_kbps(\n\tconst struct dc_link *link,\n\tconst struct dc_link_settings *link_settings)\n{\n\tuint32_t total_data_bw_efficiency_x10000 = 0;\n\tuint32_t link_rate_per_lane_kbps = 0;\n\n\tswitch (link_dp_get_encoding_format(link_settings)) {\n\tcase DP_8b_10b_ENCODING:\n\t\t \n\t\tlink_rate_per_lane_kbps = link_settings->link_rate * LINK_RATE_REF_FREQ_IN_KHZ * BITS_PER_DP_BYTE;\n\t\ttotal_data_bw_efficiency_x10000 = DATA_EFFICIENCY_8b_10b_x10000;\n\t\tif (dp_should_enable_fec(link)) {\n\t\t\ttotal_data_bw_efficiency_x10000 /= 100;\n\t\t\ttotal_data_bw_efficiency_x10000 *= DATA_EFFICIENCY_8b_10b_FEC_EFFICIENCY_x100;\n\t\t}\n\t\tbreak;\n\tcase DP_128b_132b_ENCODING:\n\t\t \n\t\tlink_rate_per_lane_kbps = link_settings->link_rate * 10000;\n\t\ttotal_data_bw_efficiency_x10000 = DATA_EFFICIENCY_128b_132b_x10000;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\t \n\treturn link_rate_per_lane_kbps * link_settings->lane_count / 10000 * total_data_bw_efficiency_x10000;\n}\n\nstatic bool dp_validate_mode_timing(\n\tstruct dc_link *link,\n\tconst struct dc_crtc_timing *timing)\n{\n\tuint32_t req_bw;\n\tuint32_t max_bw;\n\n\tconst struct dc_link_settings *link_setting;\n\n\t \n\tif (timing->pixel_encoding == PIXEL_ENCODING_YCBCR420 &&\n\t\t\t!link->dpcd_caps.dprx_feature.bits.VSC_SDP_COLORIMETRY_SUPPORTED &&\n\t\t\tdal_graphics_object_id_get_connector_id(link->link_id) != CONNECTOR_ID_VIRTUAL)\n\t\treturn false;\n\n\t \n\tif ((timing->pix_clk_100hz / 10) == (uint32_t) 25175 &&\n\t\ttiming->h_addressable == (uint32_t) 640 &&\n\t\ttiming->v_addressable == (uint32_t) 480)\n\t\treturn true;\n\n\tlink_setting = dp_get_verified_link_cap(link);\n\n\t \n\t \n\n\treq_bw = dc_bandwidth_in_kbps_from_timing(timing, dc_link_get_highest_encoding_format(link));\n\tmax_bw = dp_link_bandwidth_kbps(link, link_setting);\n\n\tif (req_bw <= max_bw) {\n\t\t \n\n\t\t \n\t\t \n\t\treturn true;\n\t} else\n\t\treturn false;\n}\n\nenum dc_status link_validate_mode_timing(\n\t\tconst struct dc_stream_state *stream,\n\t\tstruct dc_link *link,\n\t\tconst struct dc_crtc_timing *timing)\n{\n\tuint32_t max_pix_clk = stream->link->dongle_max_pix_clk * 10;\n\tstruct dpcd_caps *dpcd_caps = &link->dpcd_caps;\n\n\t \n\tif (link->remote_sinks[0] && link->remote_sinks[0]->sink_signal == SIGNAL_TYPE_VIRTUAL)\n\t\treturn DC_OK;\n\n\t \n\tif (max_pix_clk != 0 && get_tmds_output_pixel_clock_100hz(timing) > max_pix_clk)\n\t\treturn DC_EXCEED_DONGLE_CAP;\n\n\t \n\tif (!dp_active_dongle_validate_timing(timing, dpcd_caps))\n\t\treturn DC_EXCEED_DONGLE_CAP;\n\n\tswitch (stream->signal) {\n\tcase SIGNAL_TYPE_EDP:\n\tcase SIGNAL_TYPE_DISPLAY_PORT:\n\t\tif (!dp_validate_mode_timing(\n\t\t\t\tlink,\n\t\t\t\ttiming))\n\t\t\treturn DC_NO_DP_LINK_BANDWIDTH;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn DC_OK;\n}\n\nbool link_validate_dpia_bandwidth(const struct dc_stream_state *stream, const unsigned int num_streams)\n{\n\tbool ret = true;\n\tint bw_needed[MAX_DPIA_NUM];\n\tstruct dc_link *link[MAX_DPIA_NUM];\n\n\tif (!num_streams || num_streams > MAX_DPIA_NUM)\n\t\treturn ret;\n\n\tfor (uint8_t i = 0; i < num_streams; ++i) {\n\n\t\tlink[i] = stream[i].link;\n\t\tbw_needed[i] = dc_bandwidth_in_kbps_from_timing(&stream[i].timing,\n\t\t\t\tdc_link_get_highest_encoding_format(link[i]));\n\t}\n\n\tret = dpia_validate_usb4_bw(link, bw_needed, num_streams);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}