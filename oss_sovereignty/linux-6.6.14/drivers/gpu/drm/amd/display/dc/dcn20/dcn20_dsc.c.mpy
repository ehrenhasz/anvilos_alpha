{
  "module_name": "dcn20_dsc.c",
  "hash_id": "f80a749cc624481686bf8fea7fc43e6351e4557ddc308c72f559c46922aed98b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn20/dcn20_dsc.c",
  "human_readable_source": " \n\n#include <drm/display/drm_dsc_helper.h>\n\n#include \"reg_helper.h\"\n#include \"dcn20_dsc.h\"\n#include \"dsc/dscc_types.h\"\n#include \"dsc/rc_calc.h\"\n\nstatic void dsc_write_to_registers(struct display_stream_compressor *dsc, const struct dsc_reg_values *reg_vals);\n\n \nstatic void dsc2_read_state(struct display_stream_compressor *dsc, struct dcn_dsc_state *s);\nstatic bool dsc2_validate_stream(struct display_stream_compressor *dsc, const struct dsc_config *dsc_cfg);\nstatic void dsc2_set_config(struct display_stream_compressor *dsc, const struct dsc_config *dsc_cfg,\n\t\tstruct dsc_optc_config *dsc_optc_cfg);\nstatic void dsc2_enable(struct display_stream_compressor *dsc, int opp_pipe);\nstatic void dsc2_disable(struct display_stream_compressor *dsc);\nstatic void dsc2_disconnect(struct display_stream_compressor *dsc);\n\nstatic const struct dsc_funcs dcn20_dsc_funcs = {\n\t.dsc_get_enc_caps = dsc2_get_enc_caps,\n\t.dsc_read_state = dsc2_read_state,\n\t.dsc_validate_stream = dsc2_validate_stream,\n\t.dsc_set_config = dsc2_set_config,\n\t.dsc_get_packed_pps = dsc2_get_packed_pps,\n\t.dsc_enable = dsc2_enable,\n\t.dsc_disable = dsc2_disable,\n\t.dsc_disconnect = dsc2_disconnect,\n};\n\n \n#define CTX \\\n\tdsc20->base.ctx\n\n#define REG(reg)\\\n\tdsc20->dsc_regs->reg\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\tdsc20->dsc_shift->field_name, dsc20->dsc_mask->field_name\n#define DC_LOGGER \\\n\tdsc->ctx->logger\n\nenum dsc_bits_per_comp {\n\tDSC_BPC_8 = 8,\n\tDSC_BPC_10 = 10,\n\tDSC_BPC_12 = 12,\n\tDSC_BPC_UNKNOWN\n};\n\n \n\nvoid dsc2_construct(struct dcn20_dsc *dsc,\n\t\tstruct dc_context *ctx,\n\t\tint inst,\n\t\tconst struct dcn20_dsc_registers *dsc_regs,\n\t\tconst struct dcn20_dsc_shift *dsc_shift,\n\t\tconst struct dcn20_dsc_mask *dsc_mask)\n{\n\tdsc->base.ctx = ctx;\n\tdsc->base.inst = inst;\n\tdsc->base.funcs = &dcn20_dsc_funcs;\n\n\tdsc->dsc_regs = dsc_regs;\n\tdsc->dsc_shift = dsc_shift;\n\tdsc->dsc_mask = dsc_mask;\n\n\tdsc->max_image_width = 5184;\n}\n\n\n#define DCN20_MAX_PIXEL_CLOCK_Mhz      1188\n#define DCN20_MAX_DISPLAY_CLOCK_Mhz    1200\n\n \nvoid dsc2_get_enc_caps(struct dsc_enc_caps *dsc_enc_caps, int pixel_clock_100Hz)\n{\n\tdsc_enc_caps->dsc_version = 0x21;  \n\n\tdsc_enc_caps->slice_caps.bits.NUM_SLICES_1 = 1;\n\tdsc_enc_caps->slice_caps.bits.NUM_SLICES_2 = 1;\n\tdsc_enc_caps->slice_caps.bits.NUM_SLICES_3 = 1;\n\tdsc_enc_caps->slice_caps.bits.NUM_SLICES_4 = 1;\n\n\tdsc_enc_caps->lb_bit_depth = 13;\n\tdsc_enc_caps->is_block_pred_supported = true;\n\n\tdsc_enc_caps->color_formats.bits.RGB = 1;\n\tdsc_enc_caps->color_formats.bits.YCBCR_444 = 1;\n\tdsc_enc_caps->color_formats.bits.YCBCR_SIMPLE_422 = 1;\n\tdsc_enc_caps->color_formats.bits.YCBCR_NATIVE_422 = 0;\n\tdsc_enc_caps->color_formats.bits.YCBCR_NATIVE_420 = 1;\n\n\tdsc_enc_caps->color_depth.bits.COLOR_DEPTH_8_BPC = 1;\n\tdsc_enc_caps->color_depth.bits.COLOR_DEPTH_10_BPC = 1;\n\tdsc_enc_caps->color_depth.bits.COLOR_DEPTH_12_BPC = 1;\n\n\t \n\tdsc_enc_caps->max_total_throughput_mps = DCN20_MAX_DISPLAY_CLOCK_Mhz;\n\n\t \n\tif (pixel_clock_100Hz >= DCN20_MAX_PIXEL_CLOCK_Mhz*10000) {\n\t\tdsc_enc_caps->slice_caps.bits.NUM_SLICES_1 = 0;\n\t\tdsc_enc_caps->slice_caps.bits.NUM_SLICES_8 = 1;\n\t\tdsc_enc_caps->max_total_throughput_mps = DCN20_MAX_DISPLAY_CLOCK_Mhz * 2;\n\t}\n\n\t \n\tdsc_enc_caps->max_slice_width = 5184;  \n\tdsc_enc_caps->bpp_increment_div = 16;  \n}\n\n\n \nstatic void dsc2_read_state(struct display_stream_compressor *dsc, struct dcn_dsc_state *s)\n{\n\tstruct dcn20_dsc *dsc20 = TO_DCN20_DSC(dsc);\n\n\tREG_GET(DSC_TOP_CONTROL, DSC_CLOCK_EN, &s->dsc_clock_en);\n\tREG_GET(DSCC_PPS_CONFIG3, SLICE_WIDTH, &s->dsc_slice_width);\n\tREG_GET(DSCC_PPS_CONFIG1, BITS_PER_PIXEL, &s->dsc_bits_per_pixel);\n\tREG_GET(DSCC_PPS_CONFIG3, SLICE_HEIGHT, &s->dsc_slice_height);\n\tREG_GET(DSCC_PPS_CONFIG1, CHUNK_SIZE, &s->dsc_chunk_size);\n\tREG_GET(DSCC_PPS_CONFIG2, PIC_WIDTH, &s->dsc_pic_width);\n\tREG_GET(DSCC_PPS_CONFIG2, PIC_HEIGHT, &s->dsc_pic_height);\n\tREG_GET(DSCC_PPS_CONFIG7, SLICE_BPG_OFFSET, &s->dsc_slice_bpg_offset);\n\tREG_GET_2(DSCRM_DSC_FORWARD_CONFIG, DSCRM_DSC_FORWARD_EN, &s->dsc_fw_en,\n\t\tDSCRM_DSC_OPP_PIPE_SOURCE, &s->dsc_opp_source);\n}\n\n\nstatic bool dsc2_validate_stream(struct display_stream_compressor *dsc, const struct dsc_config *dsc_cfg)\n{\n\tstruct dsc_optc_config dsc_optc_cfg;\n\tstruct dcn20_dsc *dsc20 = TO_DCN20_DSC(dsc);\n\n\tif (dsc_cfg->pic_width > dsc20->max_image_width)\n\t\treturn false;\n\n\treturn dsc_prepare_config(dsc_cfg, &dsc20->reg_vals, &dsc_optc_cfg);\n}\n\n\nvoid dsc_config_log(struct display_stream_compressor *dsc, const struct dsc_config *config)\n{\n\tDC_LOG_DSC(\"\\tnum_slices_h %d\", config->dc_dsc_cfg.num_slices_h);\n\tDC_LOG_DSC(\"\\tnum_slices_v %d\", config->dc_dsc_cfg.num_slices_v);\n\tDC_LOG_DSC(\"\\tbits_per_pixel %d (%d.%04d)\",\n\t\tconfig->dc_dsc_cfg.bits_per_pixel,\n\t\tconfig->dc_dsc_cfg.bits_per_pixel / 16,\n\t\t((config->dc_dsc_cfg.bits_per_pixel % 16) * 10000) / 16);\n\tDC_LOG_DSC(\"\\tcolor_depth %d\", config->color_depth);\n}\n\nstatic void dsc2_set_config(struct display_stream_compressor *dsc, const struct dsc_config *dsc_cfg,\n\t\tstruct dsc_optc_config *dsc_optc_cfg)\n{\n\tbool is_config_ok;\n\tstruct dcn20_dsc *dsc20 = TO_DCN20_DSC(dsc);\n\n\tDC_LOG_DSC(\"Setting DSC Config at DSC inst %d\", dsc->inst);\n\tdsc_config_log(dsc, dsc_cfg);\n\tis_config_ok = dsc_prepare_config(dsc_cfg, &dsc20->reg_vals, dsc_optc_cfg);\n\tASSERT(is_config_ok);\n\tDC_LOG_DSC(\"programming DSC Picture Parameter Set (PPS):\");\n\tdsc_log_pps(dsc, &dsc20->reg_vals.pps);\n\tdsc_write_to_registers(dsc, &dsc20->reg_vals);\n}\n\n\nbool dsc2_get_packed_pps(struct display_stream_compressor *dsc, const struct dsc_config *dsc_cfg, uint8_t *dsc_packed_pps)\n{\n\tbool is_config_ok;\n\tstruct dsc_reg_values dsc_reg_vals;\n\tstruct dsc_optc_config dsc_optc_cfg;\n\n\tmemset(&dsc_reg_vals, 0, sizeof(dsc_reg_vals));\n\tmemset(&dsc_optc_cfg, 0, sizeof(dsc_optc_cfg));\n\n\tDC_LOG_DSC(\"Getting packed DSC PPS for DSC Config:\");\n\tdsc_config_log(dsc, dsc_cfg);\n\tDC_LOG_DSC(\"DSC Picture Parameter Set (PPS):\");\n\tis_config_ok = dsc_prepare_config(dsc_cfg, &dsc_reg_vals, &dsc_optc_cfg);\n\tASSERT(is_config_ok);\n\tdrm_dsc_pps_payload_pack((struct drm_dsc_picture_parameter_set *)dsc_packed_pps, &dsc_reg_vals.pps);\n\tdsc_log_pps(dsc, &dsc_reg_vals.pps);\n\n\treturn is_config_ok;\n}\n\n\nstatic void dsc2_enable(struct display_stream_compressor *dsc, int opp_pipe)\n{\n\tstruct dcn20_dsc *dsc20 = TO_DCN20_DSC(dsc);\n\tint dsc_clock_en;\n\tint dsc_fw_config;\n\tint enabled_opp_pipe;\n\n\tDC_LOG_DSC(\"enable DSC %d at opp pipe %d\", dsc->inst, opp_pipe);\n\n\tREG_GET(DSC_TOP_CONTROL, DSC_CLOCK_EN, &dsc_clock_en);\n\tREG_GET_2(DSCRM_DSC_FORWARD_CONFIG, DSCRM_DSC_FORWARD_EN, &dsc_fw_config, DSCRM_DSC_OPP_PIPE_SOURCE, &enabled_opp_pipe);\n\tif ((dsc_clock_en || dsc_fw_config) && enabled_opp_pipe != opp_pipe) {\n\t\tDC_LOG_DSC(\"ERROR: DSC %d at opp pipe %d already enabled!\", dsc->inst, enabled_opp_pipe);\n\t\tASSERT(0);\n\t}\n\n\tREG_UPDATE(DSC_TOP_CONTROL,\n\t\tDSC_CLOCK_EN, 1);\n\n\tREG_UPDATE_2(DSCRM_DSC_FORWARD_CONFIG,\n\t\tDSCRM_DSC_FORWARD_EN, 1,\n\t\tDSCRM_DSC_OPP_PIPE_SOURCE, opp_pipe);\n}\n\n\nstatic void dsc2_disable(struct display_stream_compressor *dsc)\n{\n\tstruct dcn20_dsc *dsc20 = TO_DCN20_DSC(dsc);\n\tint dsc_clock_en;\n\tint dsc_fw_config;\n\tint enabled_opp_pipe;\n\n\tDC_LOG_DSC(\"disable DSC %d\", dsc->inst);\n\n\tREG_GET(DSC_TOP_CONTROL, DSC_CLOCK_EN, &dsc_clock_en);\n\tREG_GET_2(DSCRM_DSC_FORWARD_CONFIG, DSCRM_DSC_FORWARD_EN, &dsc_fw_config, DSCRM_DSC_OPP_PIPE_SOURCE, &enabled_opp_pipe);\n\tif (!dsc_clock_en || !dsc_fw_config) {\n\t\tDC_LOG_DSC(\"ERROR: DSC %d at opp pipe %d already disabled!\", dsc->inst, enabled_opp_pipe);\n\t\tASSERT(0);\n\t}\n\n\tREG_UPDATE(DSCRM_DSC_FORWARD_CONFIG,\n\t\tDSCRM_DSC_FORWARD_EN, 0);\n\n\tREG_UPDATE(DSC_TOP_CONTROL,\n\t\tDSC_CLOCK_EN, 0);\n}\n\nstatic void dsc2_disconnect(struct display_stream_compressor *dsc)\n{\n\tstruct dcn20_dsc *dsc20 = TO_DCN20_DSC(dsc);\n\n\tDC_LOG_DSC(\"disconnect DSC %d\", dsc->inst);\n\n\tREG_UPDATE(DSCRM_DSC_FORWARD_CONFIG,\n\t\tDSCRM_DSC_FORWARD_EN, 0);\n}\n\n \nvoid dsc_log_pps(struct display_stream_compressor *dsc, struct drm_dsc_config *pps)\n{\n\tint i;\n\tint bits_per_pixel = pps->bits_per_pixel;\n\n\tDC_LOG_DSC(\"\\tdsc_version_major %d\", pps->dsc_version_major);\n\tDC_LOG_DSC(\"\\tdsc_version_minor %d\", pps->dsc_version_minor);\n\tDC_LOG_DSC(\"\\tbits_per_component %d\", pps->bits_per_component);\n\tDC_LOG_DSC(\"\\tline_buf_depth %d\", pps->line_buf_depth);\n\tDC_LOG_DSC(\"\\tblock_pred_enable %d\", pps->block_pred_enable);\n\tDC_LOG_DSC(\"\\tconvert_rgb %d\", pps->convert_rgb);\n\tDC_LOG_DSC(\"\\tsimple_422 %d\", pps->simple_422);\n\tDC_LOG_DSC(\"\\tvbr_enable %d\", pps->vbr_enable);\n\tDC_LOG_DSC(\"\\tbits_per_pixel %d (%d.%04d)\", bits_per_pixel, bits_per_pixel / 16, ((bits_per_pixel % 16) * 10000) / 16);\n\tDC_LOG_DSC(\"\\tpic_height %d\", pps->pic_height);\n\tDC_LOG_DSC(\"\\tpic_width %d\", pps->pic_width);\n\tDC_LOG_DSC(\"\\tslice_height %d\", pps->slice_height);\n\tDC_LOG_DSC(\"\\tslice_width %d\", pps->slice_width);\n\tDC_LOG_DSC(\"\\tslice_chunk_size %d\", pps->slice_chunk_size);\n\tDC_LOG_DSC(\"\\tinitial_xmit_delay %d\", pps->initial_xmit_delay);\n\tDC_LOG_DSC(\"\\tinitial_dec_delay %d\", pps->initial_dec_delay);\n\tDC_LOG_DSC(\"\\tinitial_scale_value %d\", pps->initial_scale_value);\n\tDC_LOG_DSC(\"\\tscale_increment_interval %d\", pps->scale_increment_interval);\n\tDC_LOG_DSC(\"\\tscale_decrement_interval %d\", pps->scale_decrement_interval);\n\tDC_LOG_DSC(\"\\tfirst_line_bpg_offset %d\", pps->first_line_bpg_offset);\n\tDC_LOG_DSC(\"\\tnfl_bpg_offset %d\", pps->nfl_bpg_offset);\n\tDC_LOG_DSC(\"\\tslice_bpg_offset %d\", pps->slice_bpg_offset);\n\tDC_LOG_DSC(\"\\tinitial_offset %d\", pps->initial_offset);\n\tDC_LOG_DSC(\"\\tfinal_offset %d\", pps->final_offset);\n\tDC_LOG_DSC(\"\\tflatness_min_qp %d\", pps->flatness_min_qp);\n\tDC_LOG_DSC(\"\\tflatness_max_qp %d\", pps->flatness_max_qp);\n\t \n\tDC_LOG_DSC(\"\\tnative_420 %d\", pps->native_420);\n\tDC_LOG_DSC(\"\\tnative_422 %d\", pps->native_422);\n\tDC_LOG_DSC(\"\\tsecond_line_bpg_offset %d\", pps->second_line_bpg_offset);\n\tDC_LOG_DSC(\"\\tnsl_bpg_offset %d\", pps->nsl_bpg_offset);\n\tDC_LOG_DSC(\"\\tsecond_line_offset_adj %d\", pps->second_line_offset_adj);\n\tDC_LOG_DSC(\"\\trc_model_size %d\", pps->rc_model_size);\n\tDC_LOG_DSC(\"\\trc_edge_factor %d\", pps->rc_edge_factor);\n\tDC_LOG_DSC(\"\\trc_quant_incr_limit0 %d\", pps->rc_quant_incr_limit0);\n\tDC_LOG_DSC(\"\\trc_quant_incr_limit1 %d\", pps->rc_quant_incr_limit1);\n\tDC_LOG_DSC(\"\\trc_tgt_offset_high %d\", pps->rc_tgt_offset_high);\n\tDC_LOG_DSC(\"\\trc_tgt_offset_low %d\", pps->rc_tgt_offset_low);\n\n\tfor (i = 0; i < NUM_BUF_RANGES - 1; i++)\n\t\tDC_LOG_DSC(\"\\trc_buf_thresh[%d] %d\", i, pps->rc_buf_thresh[i]);\n\n\tfor (i = 0; i < NUM_BUF_RANGES; i++) {\n\t\tDC_LOG_DSC(\"\\trc_range_parameters[%d].range_min_qp %d\", i, pps->rc_range_params[i].range_min_qp);\n\t\tDC_LOG_DSC(\"\\trc_range_parameters[%d].range_max_qp %d\", i, pps->rc_range_params[i].range_max_qp);\n\t\tDC_LOG_DSC(\"\\trc_range_parameters[%d].range_bpg_offset %d\", i, pps->rc_range_params[i].range_bpg_offset);\n\t}\n}\n\nvoid dsc_override_rc_params(struct rc_params *rc, const struct dc_dsc_rc_params_override *override)\n{\n\tuint8_t i;\n\n\trc->rc_model_size = override->rc_model_size;\n\tfor (i = 0; i < DC_DSC_RC_BUF_THRESH_SIZE; i++)\n\t\trc->rc_buf_thresh[i] = override->rc_buf_thresh[i];\n\tfor (i = 0; i < DC_DSC_QP_SET_SIZE; i++) {\n\t\trc->qp_min[i] = override->rc_minqp[i];\n\t\trc->qp_max[i] = override->rc_maxqp[i];\n\t\trc->ofs[i] = override->rc_offset[i];\n\t}\n\n\trc->rc_tgt_offset_hi = override->rc_tgt_offset_hi;\n\trc->rc_tgt_offset_lo = override->rc_tgt_offset_lo;\n\trc->rc_edge_factor = override->rc_edge_factor;\n\trc->rc_quant_incr_limit0 = override->rc_quant_incr_limit0;\n\trc->rc_quant_incr_limit1 = override->rc_quant_incr_limit1;\n\n\trc->initial_fullness_offset = override->initial_fullness_offset;\n\trc->initial_xmit_delay = override->initial_delay;\n\n\trc->flatness_min_qp = override->flatness_min_qp;\n\trc->flatness_max_qp = override->flatness_max_qp;\n\trc->flatness_det_thresh = override->flatness_det_thresh;\n}\n\nbool dsc_prepare_config(const struct dsc_config *dsc_cfg, struct dsc_reg_values *dsc_reg_vals,\n\t\t\tstruct dsc_optc_config *dsc_optc_cfg)\n{\n\tstruct dsc_parameters dsc_params;\n\tstruct rc_params rc;\n\n\t \n\tASSERT(dsc_cfg->dc_dsc_cfg.num_slices_h);\n\tASSERT(dsc_cfg->dc_dsc_cfg.num_slices_v);\n\tASSERT(dsc_cfg->dc_dsc_cfg.version_minor == 1 || dsc_cfg->dc_dsc_cfg.version_minor == 2);\n\tASSERT(dsc_cfg->pic_width);\n\tASSERT(dsc_cfg->pic_height);\n\tASSERT((dsc_cfg->dc_dsc_cfg.version_minor == 1 &&\n\t\t  (8 <= dsc_cfg->dc_dsc_cfg.linebuf_depth && dsc_cfg->dc_dsc_cfg.linebuf_depth <= 13)) ||\n\t\t(dsc_cfg->dc_dsc_cfg.version_minor == 2 &&\n\t\t  ((8 <= dsc_cfg->dc_dsc_cfg.linebuf_depth && dsc_cfg->dc_dsc_cfg.linebuf_depth <= 15) ||\n\t\t    dsc_cfg->dc_dsc_cfg.linebuf_depth == 0)));\n\tASSERT(96 <= dsc_cfg->dc_dsc_cfg.bits_per_pixel && dsc_cfg->dc_dsc_cfg.bits_per_pixel <= 0x3ff); \n\n\tif (!dsc_cfg->dc_dsc_cfg.num_slices_v || !dsc_cfg->dc_dsc_cfg.num_slices_h ||\n\t\t!(dsc_cfg->dc_dsc_cfg.version_minor == 1 || dsc_cfg->dc_dsc_cfg.version_minor == 2) ||\n\t\t!dsc_cfg->pic_width || !dsc_cfg->pic_height ||\n\t\t!((dsc_cfg->dc_dsc_cfg.version_minor == 1 && \n\t\t\t8 <= dsc_cfg->dc_dsc_cfg.linebuf_depth && dsc_cfg->dc_dsc_cfg.linebuf_depth <= 13) ||\n\t\t(dsc_cfg->dc_dsc_cfg.version_minor == 2 && \n\t\t\t((8 <= dsc_cfg->dc_dsc_cfg.linebuf_depth && dsc_cfg->dc_dsc_cfg.linebuf_depth <= 15) ||\n\t\t\tdsc_cfg->dc_dsc_cfg.linebuf_depth == 0))) ||\n\t\t!(96 <= dsc_cfg->dc_dsc_cfg.bits_per_pixel && dsc_cfg->dc_dsc_cfg.bits_per_pixel <= 0x3ff)) {\n\t\tdm_output_to_console(\"%s: Invalid parameters\\n\", __func__);\n\t\treturn false;\n\t}\n\n\tdsc_init_reg_values(dsc_reg_vals);\n\n\t \n\tdsc_reg_vals->pixel_format = dsc_dc_pixel_encoding_to_dsc_pixel_format(dsc_cfg->pixel_encoding, dsc_cfg->dc_dsc_cfg.ycbcr422_simple);\n\tdsc_reg_vals->num_slices_h = dsc_cfg->dc_dsc_cfg.num_slices_h;\n\tdsc_reg_vals->num_slices_v = dsc_cfg->dc_dsc_cfg.num_slices_v;\n\tdsc_reg_vals->pps.dsc_version_minor = dsc_cfg->dc_dsc_cfg.version_minor;\n\tdsc_reg_vals->pps.pic_width = dsc_cfg->pic_width;\n\tdsc_reg_vals->pps.pic_height = dsc_cfg->pic_height;\n\tdsc_reg_vals->pps.bits_per_component = dsc_dc_color_depth_to_dsc_bits_per_comp(dsc_cfg->color_depth);\n\tdsc_reg_vals->pps.block_pred_enable = dsc_cfg->dc_dsc_cfg.block_pred_enable;\n\tdsc_reg_vals->pps.line_buf_depth = dsc_cfg->dc_dsc_cfg.linebuf_depth;\n\tdsc_reg_vals->alternate_ich_encoding_en = dsc_reg_vals->pps.dsc_version_minor == 1 ? 0 : 1;\n\tdsc_reg_vals->ich_reset_at_eol = (dsc_cfg->is_odm || dsc_reg_vals->num_slices_h > 1) ? 0xF : 0;\n\n\t\n\t\n\tdsc_reg_vals->pps.slice_width = dsc_cfg->pic_width / dsc_cfg->dc_dsc_cfg.num_slices_h;\n\tdsc_reg_vals->pps.slice_height = dsc_cfg->pic_height / dsc_cfg->dc_dsc_cfg.num_slices_v;\n\n\tASSERT(dsc_reg_vals->pps.slice_height * dsc_cfg->dc_dsc_cfg.num_slices_v == dsc_cfg->pic_height);\n\tif (!(dsc_reg_vals->pps.slice_height * dsc_cfg->dc_dsc_cfg.num_slices_v == dsc_cfg->pic_height)) {\n\t\tdm_output_to_console(\"%s: pix height %d not divisible by num_slices_v %d\\n\\n\", __func__, dsc_cfg->pic_height, dsc_cfg->dc_dsc_cfg.num_slices_v);\n\t\treturn false;\n\t}\n\n\tdsc_reg_vals->bpp_x32 = dsc_cfg->dc_dsc_cfg.bits_per_pixel << 1;\n\tif (dsc_reg_vals->pixel_format == DSC_PIXFMT_NATIVE_YCBCR420 || dsc_reg_vals->pixel_format == DSC_PIXFMT_NATIVE_YCBCR422)\n\t\tdsc_reg_vals->pps.bits_per_pixel = dsc_reg_vals->bpp_x32;\n\telse\n\t\tdsc_reg_vals->pps.bits_per_pixel = dsc_reg_vals->bpp_x32 >> 1;\n\n\tdsc_reg_vals->pps.convert_rgb = dsc_reg_vals->pixel_format == DSC_PIXFMT_RGB ? 1 : 0;\n\tdsc_reg_vals->pps.native_422 = (dsc_reg_vals->pixel_format == DSC_PIXFMT_NATIVE_YCBCR422);\n\tdsc_reg_vals->pps.native_420 = (dsc_reg_vals->pixel_format == DSC_PIXFMT_NATIVE_YCBCR420);\n\tdsc_reg_vals->pps.simple_422 = (dsc_reg_vals->pixel_format == DSC_PIXFMT_SIMPLE_YCBCR422);\n\n\tcalc_rc_params(&rc, &dsc_reg_vals->pps);\n\n\tif (dsc_cfg->dc_dsc_cfg.rc_params_ovrd)\n\t\tdsc_override_rc_params(&rc, dsc_cfg->dc_dsc_cfg.rc_params_ovrd);\n\n\tif (dscc_compute_dsc_parameters(&dsc_reg_vals->pps, &rc, &dsc_params)) {\n\t\tdm_output_to_console(\"%s: DSC config failed\\n\", __func__);\n\t\treturn false;\n\t}\n\n\tdsc_update_from_dsc_parameters(dsc_reg_vals, &dsc_params);\n\n\tdsc_optc_cfg->bytes_per_pixel = dsc_params.bytes_per_pixel;\n\tdsc_optc_cfg->slice_width = dsc_reg_vals->pps.slice_width;\n\tdsc_optc_cfg->is_pixel_format_444 = dsc_reg_vals->pixel_format == DSC_PIXFMT_RGB ||\n\t\t\t\t\tdsc_reg_vals->pixel_format == DSC_PIXFMT_YCBCR444 ||\n\t\t\t\t\tdsc_reg_vals->pixel_format == DSC_PIXFMT_SIMPLE_YCBCR422;\n\n\treturn true;\n}\n\n\nenum dsc_pixel_format dsc_dc_pixel_encoding_to_dsc_pixel_format(enum dc_pixel_encoding dc_pix_enc, bool is_ycbcr422_simple)\n{\n\tenum dsc_pixel_format dsc_pix_fmt = DSC_PIXFMT_UNKNOWN;\n\n\t \n\n\tswitch (dc_pix_enc) {\n\tcase PIXEL_ENCODING_RGB:\n\t\tdsc_pix_fmt = DSC_PIXFMT_RGB;\n\t\tbreak;\n\tcase PIXEL_ENCODING_YCBCR422:\n\t\tif (is_ycbcr422_simple)\n\t\t\tdsc_pix_fmt = DSC_PIXFMT_SIMPLE_YCBCR422;\n\t\telse\n\t\t\tdsc_pix_fmt = DSC_PIXFMT_NATIVE_YCBCR422;\n\t\tbreak;\n\tcase PIXEL_ENCODING_YCBCR444:\n\t\tdsc_pix_fmt = DSC_PIXFMT_YCBCR444;\n\t\tbreak;\n\tcase PIXEL_ENCODING_YCBCR420:\n\t\tdsc_pix_fmt = DSC_PIXFMT_NATIVE_YCBCR420;\n\t\tbreak;\n\tdefault:\n\t\tdsc_pix_fmt = DSC_PIXFMT_UNKNOWN;\n\t\tbreak;\n\t}\n\n\tASSERT(dsc_pix_fmt != DSC_PIXFMT_UNKNOWN);\n\treturn dsc_pix_fmt;\n}\n\n\nenum dsc_bits_per_comp dsc_dc_color_depth_to_dsc_bits_per_comp(enum dc_color_depth dc_color_depth)\n{\n\tenum dsc_bits_per_comp bpc = DSC_BPC_UNKNOWN;\n\n\tswitch (dc_color_depth) {\n\tcase COLOR_DEPTH_888:\n\t\tbpc = DSC_BPC_8;\n\t\tbreak;\n\tcase COLOR_DEPTH_101010:\n\t\tbpc = DSC_BPC_10;\n\t\tbreak;\n\tcase COLOR_DEPTH_121212:\n\t\tbpc = DSC_BPC_12;\n\t\tbreak;\n\tdefault:\n\t\tbpc = DSC_BPC_UNKNOWN;\n\t\tbreak;\n\t}\n\n\treturn bpc;\n}\n\n\nvoid dsc_init_reg_values(struct dsc_reg_values *reg_vals)\n{\n\tint i;\n\n\tmemset(reg_vals, 0, sizeof(struct dsc_reg_values));\n\n\t \n\treg_vals->dsc_clock_enable            = 1;\n\treg_vals->dsc_clock_gating_disable    = 0;\n\treg_vals->underflow_recovery_en       = 0;\n\treg_vals->underflow_occurred_int_en   = 0;\n\treg_vals->underflow_occurred_status   = 0;\n\treg_vals->ich_reset_at_eol            = 0;\n\treg_vals->alternate_ich_encoding_en   = 0;\n\treg_vals->rc_buffer_model_size        = 0;\n\t \n\treg_vals->dsc_dbg_en                  = 0;\n\n\tfor (i = 0; i < 4; i++)\n\t\treg_vals->rc_buffer_model_overflow_int_en[i] = 0;\n\n\t \n\treg_vals->pps.dsc_version_minor           = 2;\n\treg_vals->pps.dsc_version_major           = 1;\n\treg_vals->pps.line_buf_depth              = 9;\n\treg_vals->pps.bits_per_component          = 8;\n\treg_vals->pps.block_pred_enable           = 1;\n\treg_vals->pps.slice_chunk_size            = 0;\n\treg_vals->pps.pic_width                   = 0;\n\treg_vals->pps.pic_height                  = 0;\n\treg_vals->pps.slice_width                 = 0;\n\treg_vals->pps.slice_height                = 0;\n\treg_vals->pps.initial_xmit_delay          = 170;\n\treg_vals->pps.initial_dec_delay           = 0;\n\treg_vals->pps.initial_scale_value         = 0;\n\treg_vals->pps.scale_increment_interval    = 0;\n\treg_vals->pps.scale_decrement_interval    = 0;\n\treg_vals->pps.nfl_bpg_offset              = 0;\n\treg_vals->pps.slice_bpg_offset            = 0;\n\treg_vals->pps.nsl_bpg_offset              = 0;\n\treg_vals->pps.initial_offset              = 6144;\n\treg_vals->pps.final_offset                = 0;\n\treg_vals->pps.flatness_min_qp             = 3;\n\treg_vals->pps.flatness_max_qp             = 12;\n\treg_vals->pps.rc_model_size               = 8192;\n\treg_vals->pps.rc_edge_factor              = 6;\n\treg_vals->pps.rc_quant_incr_limit0        = 11;\n\treg_vals->pps.rc_quant_incr_limit1        = 11;\n\treg_vals->pps.rc_tgt_offset_low           = 3;\n\treg_vals->pps.rc_tgt_offset_high          = 3;\n}\n\n \nvoid dsc_update_from_dsc_parameters(struct dsc_reg_values *reg_vals, const struct dsc_parameters *dsc_params)\n{\n\tint i;\n\n\treg_vals->pps = dsc_params->pps;\n\n\t\n\tfor (i = 0; i < NUM_BUF_RANGES - 1; i++)\n\t\treg_vals->pps.rc_buf_thresh[i] = reg_vals->pps.rc_buf_thresh[i] >> 6;\n\n\treg_vals->rc_buffer_model_size = dsc_params->rc_buffer_model_size;\n}\n\nstatic void dsc_write_to_registers(struct display_stream_compressor *dsc, const struct dsc_reg_values *reg_vals)\n{\n\tuint32_t temp_int;\n\tstruct dcn20_dsc *dsc20 = TO_DCN20_DSC(dsc);\n\n\tREG_SET(DSC_DEBUG_CONTROL, 0,\n\t\tDSC_DBG_EN, reg_vals->dsc_dbg_en);\n\n\t\n\tREG_SET_5(DSCCIF_CONFIG0, 0,\n\t\tINPUT_INTERFACE_UNDERFLOW_RECOVERY_EN, reg_vals->underflow_recovery_en,\n\t\tINPUT_INTERFACE_UNDERFLOW_OCCURRED_INT_EN, reg_vals->underflow_occurred_int_en,\n\t\tINPUT_INTERFACE_UNDERFLOW_OCCURRED_STATUS, reg_vals->underflow_occurred_status,\n\t\tINPUT_PIXEL_FORMAT, reg_vals->pixel_format,\n\t\tDSCCIF_CONFIG0__BITS_PER_COMPONENT, reg_vals->pps.bits_per_component);\n\n\tREG_SET_2(DSCCIF_CONFIG1, 0,\n\t\tPIC_WIDTH, reg_vals->pps.pic_width,\n\t\tPIC_HEIGHT, reg_vals->pps.pic_height);\n\n\t\n\tif (dsc20->dsc_mask->ICH_RESET_AT_END_OF_LINE == 0) {\n\t\tREG_SET_3(DSCC_CONFIG0, 0,\n\t\t\t  NUMBER_OF_SLICES_PER_LINE, reg_vals->num_slices_h - 1,\n\t\t\t  ALTERNATE_ICH_ENCODING_EN, reg_vals->alternate_ich_encoding_en,\n\t\t\t  NUMBER_OF_SLICES_IN_VERTICAL_DIRECTION, reg_vals->num_slices_v - 1);\n\t} else {\n\t\tREG_SET_4(DSCC_CONFIG0, 0, ICH_RESET_AT_END_OF_LINE,\n\t\t\t  reg_vals->ich_reset_at_eol, NUMBER_OF_SLICES_PER_LINE,\n\t\t\t  reg_vals->num_slices_h - 1, ALTERNATE_ICH_ENCODING_EN,\n\t\t\t  reg_vals->alternate_ich_encoding_en, NUMBER_OF_SLICES_IN_VERTICAL_DIRECTION,\n\t\t\t  reg_vals->num_slices_v - 1);\n\t}\n\n\tREG_SET(DSCC_CONFIG1, 0,\n\t\t\tDSCC_RATE_CONTROL_BUFFER_MODEL_SIZE, reg_vals->rc_buffer_model_size);\n\t \n\n\tREG_SET_4(DSCC_INTERRUPT_CONTROL_STATUS, 0,\n\t\tDSCC_RATE_CONTROL_BUFFER_MODEL0_OVERFLOW_OCCURRED_INT_EN, reg_vals->rc_buffer_model_overflow_int_en[0],\n\t\tDSCC_RATE_CONTROL_BUFFER_MODEL1_OVERFLOW_OCCURRED_INT_EN, reg_vals->rc_buffer_model_overflow_int_en[1],\n\t\tDSCC_RATE_CONTROL_BUFFER_MODEL2_OVERFLOW_OCCURRED_INT_EN, reg_vals->rc_buffer_model_overflow_int_en[2],\n\t\tDSCC_RATE_CONTROL_BUFFER_MODEL3_OVERFLOW_OCCURRED_INT_EN, reg_vals->rc_buffer_model_overflow_int_en[3]);\n\n\tREG_SET_3(DSCC_PPS_CONFIG0, 0,\n\t\tDSC_VERSION_MINOR, reg_vals->pps.dsc_version_minor,\n\t\tLINEBUF_DEPTH, reg_vals->pps.line_buf_depth,\n\t\tDSCC_PPS_CONFIG0__BITS_PER_COMPONENT, reg_vals->pps.bits_per_component);\n\n\tif (reg_vals->pixel_format == DSC_PIXFMT_NATIVE_YCBCR420 || reg_vals->pixel_format == DSC_PIXFMT_NATIVE_YCBCR422)\n\t\ttemp_int = reg_vals->bpp_x32;\n\telse\n\t\ttemp_int = reg_vals->bpp_x32 >> 1;\n\n\tREG_SET_7(DSCC_PPS_CONFIG1, 0,\n\t\tBITS_PER_PIXEL, temp_int,\n\t\tSIMPLE_422, reg_vals->pixel_format == DSC_PIXFMT_SIMPLE_YCBCR422,\n\t\tCONVERT_RGB, reg_vals->pixel_format == DSC_PIXFMT_RGB,\n\t\tBLOCK_PRED_ENABLE, reg_vals->pps.block_pred_enable,\n\t\tNATIVE_422, reg_vals->pixel_format == DSC_PIXFMT_NATIVE_YCBCR422,\n\t\tNATIVE_420, reg_vals->pixel_format == DSC_PIXFMT_NATIVE_YCBCR420,\n\t\tCHUNK_SIZE, reg_vals->pps.slice_chunk_size);\n\n\tREG_SET_2(DSCC_PPS_CONFIG2, 0,\n\t\tPIC_WIDTH, reg_vals->pps.pic_width,\n\t\tPIC_HEIGHT, reg_vals->pps.pic_height);\n\n\tREG_SET_2(DSCC_PPS_CONFIG3, 0,\n\t\tSLICE_WIDTH, reg_vals->pps.slice_width,\n\t\tSLICE_HEIGHT, reg_vals->pps.slice_height);\n\n\tREG_SET(DSCC_PPS_CONFIG4, 0,\n\t\tINITIAL_XMIT_DELAY, reg_vals->pps.initial_xmit_delay);\n\n\tREG_SET_2(DSCC_PPS_CONFIG5, 0,\n\t\tINITIAL_SCALE_VALUE, reg_vals->pps.initial_scale_value,\n\t\tSCALE_INCREMENT_INTERVAL, reg_vals->pps.scale_increment_interval);\n\n\tREG_SET_3(DSCC_PPS_CONFIG6, 0,\n\t\tSCALE_DECREMENT_INTERVAL, reg_vals->pps.scale_decrement_interval,\n\t\tFIRST_LINE_BPG_OFFSET, reg_vals->pps.first_line_bpg_offset,\n\t\tSECOND_LINE_BPG_OFFSET, reg_vals->pps.second_line_bpg_offset);\n\n\tREG_SET_2(DSCC_PPS_CONFIG7, 0,\n\t\tNFL_BPG_OFFSET, reg_vals->pps.nfl_bpg_offset,\n\t\tSLICE_BPG_OFFSET, reg_vals->pps.slice_bpg_offset);\n\n\tREG_SET_2(DSCC_PPS_CONFIG8, 0,\n\t\tNSL_BPG_OFFSET, reg_vals->pps.nsl_bpg_offset,\n\t\tSECOND_LINE_OFFSET_ADJ, reg_vals->pps.second_line_offset_adj);\n\n\tREG_SET_2(DSCC_PPS_CONFIG9, 0,\n\t\tINITIAL_OFFSET, reg_vals->pps.initial_offset,\n\t\tFINAL_OFFSET, reg_vals->pps.final_offset);\n\n\tREG_SET_3(DSCC_PPS_CONFIG10, 0,\n\t\tFLATNESS_MIN_QP, reg_vals->pps.flatness_min_qp,\n\t\tFLATNESS_MAX_QP, reg_vals->pps.flatness_max_qp,\n\t\tRC_MODEL_SIZE, reg_vals->pps.rc_model_size);\n\n\tREG_SET_5(DSCC_PPS_CONFIG11, 0,\n\t\tRC_EDGE_FACTOR, reg_vals->pps.rc_edge_factor,\n\t\tRC_QUANT_INCR_LIMIT0, reg_vals->pps.rc_quant_incr_limit0,\n\t\tRC_QUANT_INCR_LIMIT1, reg_vals->pps.rc_quant_incr_limit1,\n\t\tRC_TGT_OFFSET_LO, reg_vals->pps.rc_tgt_offset_low,\n\t\tRC_TGT_OFFSET_HI, reg_vals->pps.rc_tgt_offset_high);\n\n\tREG_SET_4(DSCC_PPS_CONFIG12, 0,\n\t\tRC_BUF_THRESH0, reg_vals->pps.rc_buf_thresh[0],\n\t\tRC_BUF_THRESH1, reg_vals->pps.rc_buf_thresh[1],\n\t\tRC_BUF_THRESH2, reg_vals->pps.rc_buf_thresh[2],\n\t\tRC_BUF_THRESH3, reg_vals->pps.rc_buf_thresh[3]);\n\n\tREG_SET_4(DSCC_PPS_CONFIG13, 0,\n\t\tRC_BUF_THRESH4, reg_vals->pps.rc_buf_thresh[4],\n\t\tRC_BUF_THRESH5, reg_vals->pps.rc_buf_thresh[5],\n\t\tRC_BUF_THRESH6, reg_vals->pps.rc_buf_thresh[6],\n\t\tRC_BUF_THRESH7, reg_vals->pps.rc_buf_thresh[7]);\n\n\tREG_SET_4(DSCC_PPS_CONFIG14, 0,\n\t\tRC_BUF_THRESH8, reg_vals->pps.rc_buf_thresh[8],\n\t\tRC_BUF_THRESH9, reg_vals->pps.rc_buf_thresh[9],\n\t\tRC_BUF_THRESH10, reg_vals->pps.rc_buf_thresh[10],\n\t\tRC_BUF_THRESH11, reg_vals->pps.rc_buf_thresh[11]);\n\n\tREG_SET_5(DSCC_PPS_CONFIG15, 0,\n\t\tRC_BUF_THRESH12, reg_vals->pps.rc_buf_thresh[12],\n\t\tRC_BUF_THRESH13, reg_vals->pps.rc_buf_thresh[13],\n\t\tRANGE_MIN_QP0, reg_vals->pps.rc_range_params[0].range_min_qp,\n\t\tRANGE_MAX_QP0, reg_vals->pps.rc_range_params[0].range_max_qp,\n\t\tRANGE_BPG_OFFSET0, reg_vals->pps.rc_range_params[0].range_bpg_offset);\n\n\tREG_SET_6(DSCC_PPS_CONFIG16, 0,\n\t\tRANGE_MIN_QP1, reg_vals->pps.rc_range_params[1].range_min_qp,\n\t\tRANGE_MAX_QP1, reg_vals->pps.rc_range_params[1].range_max_qp,\n\t\tRANGE_BPG_OFFSET1, reg_vals->pps.rc_range_params[1].range_bpg_offset,\n\t\tRANGE_MIN_QP2, reg_vals->pps.rc_range_params[2].range_min_qp,\n\t\tRANGE_MAX_QP2, reg_vals->pps.rc_range_params[2].range_max_qp,\n\t\tRANGE_BPG_OFFSET2, reg_vals->pps.rc_range_params[2].range_bpg_offset);\n\n\tREG_SET_6(DSCC_PPS_CONFIG17, 0,\n\t\tRANGE_MIN_QP3, reg_vals->pps.rc_range_params[3].range_min_qp,\n\t\tRANGE_MAX_QP3, reg_vals->pps.rc_range_params[3].range_max_qp,\n\t\tRANGE_BPG_OFFSET3, reg_vals->pps.rc_range_params[3].range_bpg_offset,\n\t\tRANGE_MIN_QP4, reg_vals->pps.rc_range_params[4].range_min_qp,\n\t\tRANGE_MAX_QP4, reg_vals->pps.rc_range_params[4].range_max_qp,\n\t\tRANGE_BPG_OFFSET4, reg_vals->pps.rc_range_params[4].range_bpg_offset);\n\n\tREG_SET_6(DSCC_PPS_CONFIG18, 0,\n\t\tRANGE_MIN_QP5, reg_vals->pps.rc_range_params[5].range_min_qp,\n\t\tRANGE_MAX_QP5, reg_vals->pps.rc_range_params[5].range_max_qp,\n\t\tRANGE_BPG_OFFSET5, reg_vals->pps.rc_range_params[5].range_bpg_offset,\n\t\tRANGE_MIN_QP6, reg_vals->pps.rc_range_params[6].range_min_qp,\n\t\tRANGE_MAX_QP6, reg_vals->pps.rc_range_params[6].range_max_qp,\n\t\tRANGE_BPG_OFFSET6, reg_vals->pps.rc_range_params[6].range_bpg_offset);\n\n\tREG_SET_6(DSCC_PPS_CONFIG19, 0,\n\t\tRANGE_MIN_QP7, reg_vals->pps.rc_range_params[7].range_min_qp,\n\t\tRANGE_MAX_QP7, reg_vals->pps.rc_range_params[7].range_max_qp,\n\t\tRANGE_BPG_OFFSET7, reg_vals->pps.rc_range_params[7].range_bpg_offset,\n\t\tRANGE_MIN_QP8, reg_vals->pps.rc_range_params[8].range_min_qp,\n\t\tRANGE_MAX_QP8, reg_vals->pps.rc_range_params[8].range_max_qp,\n\t\tRANGE_BPG_OFFSET8, reg_vals->pps.rc_range_params[8].range_bpg_offset);\n\n\tREG_SET_6(DSCC_PPS_CONFIG20, 0,\n\t\tRANGE_MIN_QP9, reg_vals->pps.rc_range_params[9].range_min_qp,\n\t\tRANGE_MAX_QP9, reg_vals->pps.rc_range_params[9].range_max_qp,\n\t\tRANGE_BPG_OFFSET9, reg_vals->pps.rc_range_params[9].range_bpg_offset,\n\t\tRANGE_MIN_QP10, reg_vals->pps.rc_range_params[10].range_min_qp,\n\t\tRANGE_MAX_QP10, reg_vals->pps.rc_range_params[10].range_max_qp,\n\t\tRANGE_BPG_OFFSET10, reg_vals->pps.rc_range_params[10].range_bpg_offset);\n\n\tREG_SET_6(DSCC_PPS_CONFIG21, 0,\n\t\tRANGE_MIN_QP11, reg_vals->pps.rc_range_params[11].range_min_qp,\n\t\tRANGE_MAX_QP11, reg_vals->pps.rc_range_params[11].range_max_qp,\n\t\tRANGE_BPG_OFFSET11, reg_vals->pps.rc_range_params[11].range_bpg_offset,\n\t\tRANGE_MIN_QP12, reg_vals->pps.rc_range_params[12].range_min_qp,\n\t\tRANGE_MAX_QP12, reg_vals->pps.rc_range_params[12].range_max_qp,\n\t\tRANGE_BPG_OFFSET12, reg_vals->pps.rc_range_params[12].range_bpg_offset);\n\n\tREG_SET_6(DSCC_PPS_CONFIG22, 0,\n\t\tRANGE_MIN_QP13, reg_vals->pps.rc_range_params[13].range_min_qp,\n\t\tRANGE_MAX_QP13, reg_vals->pps.rc_range_params[13].range_max_qp,\n\t\tRANGE_BPG_OFFSET13, reg_vals->pps.rc_range_params[13].range_bpg_offset,\n\t\tRANGE_MIN_QP14, reg_vals->pps.rc_range_params[14].range_min_qp,\n\t\tRANGE_MAX_QP14, reg_vals->pps.rc_range_params[14].range_max_qp,\n\t\tRANGE_BPG_OFFSET14, reg_vals->pps.rc_range_params[14].range_bpg_offset);\n\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}