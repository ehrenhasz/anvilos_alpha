{
  "module_name": "dcn20_mmhubbub.c",
  "hash_id": "a8510006b12bcf07602596e1489eac27cc99bacbb61b236bc4b52fddf47f3a82",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn20/dcn20_mmhubbub.c",
  "human_readable_source": " \n\n\n#include \"reg_helper.h\"\n#include \"resource.h\"\n#include \"mcif_wb.h\"\n#include \"dcn20_mmhubbub.h\"\n\n\n#define REG(reg)\\\n\tmcif_wb20->mcif_wb_regs->reg\n\n#define CTX \\\n\tmcif_wb20->base.ctx\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\tmcif_wb20->mcif_wb_shift->field_name, mcif_wb20->mcif_wb_mask->field_name\n\n#define MCIF_ADDR(addr) (((unsigned long long)addr & 0xffffffffff) + 0xFE) >> 8\n#define MCIF_ADDR_HIGH(addr) (unsigned long long)addr >> 40\n\n \n\nstatic void mmhubbub2_config_mcif_buf(struct mcif_wb *mcif_wb,\n\t\tstruct mcif_buf_params *params,\n\t\tunsigned int dest_height)\n{\n\tstruct dcn20_mmhubbub *mcif_wb20 = TO_DCN20_MMHUBBUB(mcif_wb);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUFMGR_SW_CONTROL, MCIF_WB_BUFMGR_SW_LOCK, params->swlock);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUF_1_ADDR_Y, MCIF_WB_BUF_1_ADDR_Y, MCIF_ADDR(params->luma_address[0]));\n\tREG_UPDATE(MCIF_WB_BUF_1_ADDR_Y_HIGH, MCIF_WB_BUF_1_ADDR_Y_HIGH, MCIF_ADDR_HIGH(params->luma_address[0]));\n\t \n\tREG_UPDATE(MCIF_WB_BUF_1_ADDR_Y_OFFSET, MCIF_WB_BUF_1_ADDR_Y_OFFSET, 0);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUF_1_ADDR_C, MCIF_WB_BUF_1_ADDR_C, MCIF_ADDR(params->chroma_address[0]));\n\tREG_UPDATE(MCIF_WB_BUF_1_ADDR_C_HIGH, MCIF_WB_BUF_1_ADDR_C_HIGH, MCIF_ADDR_HIGH(params->chroma_address[0]));\n\t \n\tREG_UPDATE(MCIF_WB_BUF_1_ADDR_C_OFFSET, MCIF_WB_BUF_1_ADDR_C_OFFSET, 0);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUF_2_ADDR_Y, MCIF_WB_BUF_2_ADDR_Y, MCIF_ADDR(params->luma_address[1]));\n\tREG_UPDATE(MCIF_WB_BUF_2_ADDR_Y_HIGH, MCIF_WB_BUF_2_ADDR_Y_HIGH, MCIF_ADDR_HIGH(params->luma_address[1]));\n\t \n\tREG_UPDATE(MCIF_WB_BUF_2_ADDR_Y_OFFSET, MCIF_WB_BUF_2_ADDR_Y_OFFSET, 0);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUF_2_ADDR_C, MCIF_WB_BUF_2_ADDR_C, MCIF_ADDR(params->chroma_address[1]));\n\tREG_UPDATE(MCIF_WB_BUF_2_ADDR_C_HIGH, MCIF_WB_BUF_2_ADDR_C_HIGH, MCIF_ADDR_HIGH(params->chroma_address[1]));\n\t \n\tREG_UPDATE(MCIF_WB_BUF_2_ADDR_C_OFFSET, MCIF_WB_BUF_2_ADDR_C_OFFSET, 0);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUF_3_ADDR_Y, MCIF_WB_BUF_3_ADDR_Y, MCIF_ADDR(params->luma_address[2]));\n\tREG_UPDATE(MCIF_WB_BUF_3_ADDR_Y_HIGH, MCIF_WB_BUF_3_ADDR_Y_HIGH, MCIF_ADDR_HIGH(params->luma_address[2]));\n\t \n\tREG_UPDATE(MCIF_WB_BUF_3_ADDR_Y_OFFSET, MCIF_WB_BUF_3_ADDR_Y_OFFSET, 0);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUF_3_ADDR_C, MCIF_WB_BUF_3_ADDR_C, MCIF_ADDR(params->chroma_address[2]));\n\tREG_UPDATE(MCIF_WB_BUF_3_ADDR_C_HIGH, MCIF_WB_BUF_3_ADDR_C_HIGH, MCIF_ADDR_HIGH(params->chroma_address[2]));\n\t \n\tREG_UPDATE(MCIF_WB_BUF_3_ADDR_C_OFFSET, MCIF_WB_BUF_3_ADDR_C_OFFSET, 0);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUF_4_ADDR_Y, MCIF_WB_BUF_4_ADDR_Y, MCIF_ADDR(params->luma_address[3]));\n\tREG_UPDATE(MCIF_WB_BUF_4_ADDR_Y_HIGH, MCIF_WB_BUF_4_ADDR_Y_HIGH, MCIF_ADDR_HIGH(params->luma_address[3]));\n\t \n\tREG_UPDATE(MCIF_WB_BUF_4_ADDR_Y_OFFSET, MCIF_WB_BUF_4_ADDR_Y_OFFSET, 0);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUF_4_ADDR_C, MCIF_WB_BUF_4_ADDR_C, MCIF_ADDR(params->chroma_address[3]));\n\tREG_UPDATE(MCIF_WB_BUF_4_ADDR_C_HIGH, MCIF_WB_BUF_4_ADDR_C_HIGH, MCIF_ADDR_HIGH(params->chroma_address[3]));\n\t \n\tREG_UPDATE(MCIF_WB_BUF_4_ADDR_C_OFFSET, MCIF_WB_BUF_4_ADDR_C_OFFSET, 0);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUF_LUMA_SIZE, MCIF_WB_BUF_LUMA_SIZE, (params->luma_pitch>>8) * dest_height);\n\tREG_UPDATE(MCIF_WB_BUF_CHROMA_SIZE, MCIF_WB_BUF_CHROMA_SIZE, (params->chroma_pitch>>8) * dest_height);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUFMGR_SW_CONTROL, MCIF_WB_BUF_ADDR_FENCE_EN, 1);\n\n\t \n\tREG_UPDATE_2(MCIF_WB_BUF_PITCH, MCIF_WB_BUF_LUMA_PITCH, params->luma_pitch >> 8,\n\t\t\tMCIF_WB_BUF_CHROMA_PITCH, params->chroma_pitch >> 8);\n\n\t \n\t \n\t \n\tREG_UPDATE(MCIF_WB_WARM_UP_CNTL, MCIF_WB_PITCH_SIZE_WARMUP, params->warmup_pitch);\n}\n\nstatic void mmhubbub2_config_mcif_arb(struct mcif_wb *mcif_wb,\n\t\tstruct mcif_arb_params *params)\n{\n\tstruct dcn20_mmhubbub *mcif_wb20 = TO_DCN20_MMHUBBUB(mcif_wb);\n\n\t \n\tREG_UPDATE(MCIF_WB_ARBITRATION_CONTROL, MCIF_WB_TIME_PER_PIXEL, params->time_per_pixel);\n\n\t \n\t \n\t \n\tREG_UPDATE(MCIF_WB_SCLK_CHANGE, MCIF_WB_CLI_WATERMARK_MASK, 0x0);\n\t \n\tREG_UPDATE(MCIF_WB_WATERMARK, MCIF_WB_CLI_WATERMARK,  params->cli_watermark[0]);\n\tREG_UPDATE(MCIF_WB_SCLK_CHANGE, MCIF_WB_CLI_WATERMARK_MASK, 0x1);\n\t \n\tREG_UPDATE(MCIF_WB_WATERMARK, MCIF_WB_CLI_WATERMARK,  params->cli_watermark[1]);\n\tREG_UPDATE(MCIF_WB_SCLK_CHANGE, MCIF_WB_CLI_WATERMARK_MASK, 0x2);\n\t \n\tREG_UPDATE(MCIF_WB_WATERMARK, MCIF_WB_CLI_WATERMARK,  params->cli_watermark[2]);\n\tREG_UPDATE(MCIF_WB_SCLK_CHANGE, MCIF_WB_CLI_WATERMARK_MASK, 0x3);\n\t \n\tREG_UPDATE(MCIF_WB_WATERMARK, MCIF_WB_CLI_WATERMARK,  params->cli_watermark[3]);\n\n\t \n\t \n\tREG_UPDATE(MCIF_WB_NB_PSTATE_CONTROL, NB_PSTATE_CHANGE_WATERMARK_MASK, 0x0);\n\tREG_UPDATE(MCIF_WB_NB_PSTATE_LATENCY_WATERMARK,\n\t\t\tNB_PSTATE_CHANGE_REFRESH_WATERMARK, params->pstate_watermark[0]);\n\t \n\tREG_UPDATE(MCIF_WB_NB_PSTATE_CONTROL, NB_PSTATE_CHANGE_WATERMARK_MASK, 0x1);\n\tREG_UPDATE(MCIF_WB_NB_PSTATE_LATENCY_WATERMARK,\n\t\t\tNB_PSTATE_CHANGE_REFRESH_WATERMARK, params->pstate_watermark[1]);\n\t \n\tREG_UPDATE(MCIF_WB_NB_PSTATE_CONTROL, NB_PSTATE_CHANGE_WATERMARK_MASK, 0x2);\n\tREG_UPDATE(MCIF_WB_NB_PSTATE_LATENCY_WATERMARK,\n\t\t\tNB_PSTATE_CHANGE_REFRESH_WATERMARK, params->pstate_watermark[2]);\n\t \n\tREG_UPDATE(MCIF_WB_NB_PSTATE_CONTROL, NB_PSTATE_CHANGE_WATERMARK_MASK, 0x3);\n\tREG_UPDATE(MCIF_WB_NB_PSTATE_LATENCY_WATERMARK,\n\t\t\tNB_PSTATE_CHANGE_REFRESH_WATERMARK, params->pstate_watermark[3]);\n\n\t \n\tREG_UPDATE(MULTI_LEVEL_QOS_CTRL, MAX_SCALED_TIME_TO_URGENT, params->max_scaled_time);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUFMGR_VCE_CONTROL, MCIF_WB_BUFMGR_SLICE_SIZE, params->slice_lines-1);\n\n\t \n\t \n\t \n\tREG_UPDATE(MCIF_WB_ARBITRATION_CONTROL, MCIF_WB_CLIENT_ARBITRATION_SLICE,  params->arbitration_slice);\n}\n\nvoid mmhubbub2_config_mcif_irq(struct mcif_wb *mcif_wb,\n\t\tstruct mcif_irq_params *params)\n{\n\tstruct dcn20_mmhubbub *mcif_wb20 = TO_DCN20_MMHUBBUB(mcif_wb);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUFMGR_SW_CONTROL, MCIF_WB_BUFMGR_SW_INT_EN, params->sw_int_en);\n\tREG_UPDATE(MCIF_WB_BUFMGR_SW_CONTROL, MCIF_WB_BUFMGR_SW_SLICE_INT_EN, params->sw_slice_int_en);\n\tREG_UPDATE(MCIF_WB_BUFMGR_SW_CONTROL, MCIF_WB_BUFMGR_SW_OVERRUN_INT_EN,  params->sw_overrun_int_en);\n\n\tREG_UPDATE(MCIF_WB_BUFMGR_VCE_CONTROL, MCIF_WB_BUFMGR_VCE_INT_EN,  params->vce_int_en);\n\tif (mcif_wb20->mcif_wb_mask->MCIF_WB_BUFMGR_VCE_SLICE_INT_EN)\n\t\tREG_UPDATE(MCIF_WB_BUFMGR_VCE_CONTROL, MCIF_WB_BUFMGR_VCE_SLICE_INT_EN,  params->vce_slice_int_en);\n}\n\nvoid mmhubbub2_enable_mcif(struct mcif_wb *mcif_wb)\n{\n\tstruct dcn20_mmhubbub *mcif_wb20 = TO_DCN20_MMHUBBUB(mcif_wb);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUFMGR_SW_CONTROL, MCIF_WB_BUFMGR_ENABLE, 1);\n}\n\nvoid mmhubbub2_disable_mcif(struct mcif_wb *mcif_wb)\n{\n\tstruct dcn20_mmhubbub *mcif_wb20 = TO_DCN20_MMHUBBUB(mcif_wb);\n\n\t \n\tREG_UPDATE(MCIF_WB_BUFMGR_SW_CONTROL, MCIF_WB_BUFMGR_ENABLE, 0);\n}\n\n \n \n \n \n \n \n\nvoid mcifwb2_dump_frame(struct mcif_wb *mcif_wb,\n\t\tstruct mcif_buf_params *mcif_params,\n\t\tenum dwb_scaler_mode out_format,\n\t\tunsigned int dest_width,\n\t\tunsigned int dest_height,\n\t\tstruct mcif_wb_frame_dump_info *dump_info,\n\t\tunsigned char *luma_buffer,\n\t\tunsigned char *chroma_buffer,\n\t\tunsigned char *dest_luma_buffer,\n\t\tunsigned char *dest_chroma_buffer)\n{\n\tstruct dcn20_mmhubbub *mcif_wb20 = TO_DCN20_MMHUBBUB(mcif_wb);\n\n\tREG_UPDATE(MCIF_WB_BUFMGR_SW_CONTROL, MCIF_WB_BUFMGR_SW_LOCK, 0xf);\n\n\tmemcpy(dest_luma_buffer,   luma_buffer,   mcif_params->luma_pitch * dest_height);\n\tmemcpy(dest_chroma_buffer, chroma_buffer, mcif_params->chroma_pitch * dest_height / 2);\n\n\tREG_UPDATE(MCIF_WB_BUFMGR_SW_CONTROL, MCIF_WB_BUFMGR_SW_LOCK, 0x0);\n\n\tdump_info->format\t= out_format;\n\tdump_info->width\t= dest_width;\n\tdump_info->height\t= dest_height;\n\tdump_info->luma_pitch\t= mcif_params->luma_pitch;\n\tdump_info->chroma_pitch\t= mcif_params->chroma_pitch;\n\tdump_info->size\t\t= dest_height * (mcif_params->luma_pitch + mcif_params->chroma_pitch);\n}\n\nstatic const struct mcif_wb_funcs dcn20_mmhubbub_funcs = {\n\t.enable_mcif\t\t= mmhubbub2_enable_mcif,\n\t.disable_mcif\t\t= mmhubbub2_disable_mcif,\n\t.config_mcif_buf\t= mmhubbub2_config_mcif_buf,\n\t.config_mcif_arb\t= mmhubbub2_config_mcif_arb,\n\t.config_mcif_irq\t= mmhubbub2_config_mcif_irq,\n\t.dump_frame\t\t= mcifwb2_dump_frame,\n};\n\nvoid dcn20_mmhubbub_construct(struct dcn20_mmhubbub *mcif_wb20,\n\t\tstruct dc_context *ctx,\n\t\tconst struct dcn20_mmhubbub_registers *mcif_wb_regs,\n\t\tconst struct dcn20_mmhubbub_shift *mcif_wb_shift,\n\t\tconst struct dcn20_mmhubbub_mask *mcif_wb_mask,\n\t\tint inst)\n{\n\tmcif_wb20->base.ctx = ctx;\n\n\tmcif_wb20->base.inst = inst;\n\tmcif_wb20->base.funcs = &dcn20_mmhubbub_funcs;\n\n\tmcif_wb20->mcif_wb_regs = mcif_wb_regs;\n\tmcif_wb20->mcif_wb_shift = mcif_wb_shift;\n\tmcif_wb20->mcif_wb_mask = mcif_wb_mask;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}