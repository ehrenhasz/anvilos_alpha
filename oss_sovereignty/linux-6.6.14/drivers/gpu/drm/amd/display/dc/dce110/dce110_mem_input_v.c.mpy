{
  "module_name": "dce110_mem_input_v.c",
  "hash_id": "1ef763138f845adb5e7e4b71cccda211af6503195ae87538e1a5bb80f8d4a94a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dce110/dce110_mem_input_v.c",
  "human_readable_source": " \n#include \"dm_services.h\"\n\n#include \"dce/dce_11_0_d.h\"\n#include \"dce/dce_11_0_sh_mask.h\"\n \n#include \"gmc/gmc_8_2_d.h\"\n#include \"gmc/gmc_8_2_sh_mask.h\"\n\n#include \"include/logger_interface.h\"\n#include \"inc/dce_calcs.h\"\n\n#include \"dce/dce_mem_input.h\"\n#include \"dce110_mem_input_v.h\"\n\nstatic void set_flip_control(\n\tstruct dce_mem_input *mem_input110,\n\tbool immediate)\n{\n\tuint32_t value = 0;\n\n\tvalue = dm_read_reg(\n\t\t\tmem_input110->base.ctx,\n\t\t\tmmUNP_FLIP_CONTROL);\n\n\tset_reg_field_value(value, 1,\n\t\t\tUNP_FLIP_CONTROL,\n\t\t\tGRPH_SURFACE_UPDATE_PENDING_MODE);\n\n\tdm_write_reg(\n\t\t\tmem_input110->base.ctx,\n\t\t\tmmUNP_FLIP_CONTROL,\n\t\t\tvalue);\n}\n\n \nstatic void program_pri_addr_c(\n\tstruct dce_mem_input *mem_input110,\n\tPHYSICAL_ADDRESS_LOC address)\n{\n\tuint32_t value = 0;\n\tuint32_t temp = 0;\n\t \n\ttemp = address.high_part &\nUNP_GRPH_PRIMARY_SURFACE_ADDRESS_HIGH_C__GRPH_PRIMARY_SURFACE_ADDRESS_HIGH_C_MASK;\n\n\tset_reg_field_value(value, temp,\n\t\tUNP_GRPH_PRIMARY_SURFACE_ADDRESS_HIGH_C,\n\t\tGRPH_PRIMARY_SURFACE_ADDRESS_HIGH_C);\n\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_PRIMARY_SURFACE_ADDRESS_HIGH_C,\n\t\tvalue);\n\n\ttemp = 0;\n\tvalue = 0;\n\ttemp = address.low_part >>\n\tUNP_GRPH_PRIMARY_SURFACE_ADDRESS_C__GRPH_PRIMARY_SURFACE_ADDRESS_C__SHIFT;\n\n\tset_reg_field_value(value, temp,\n\t\tUNP_GRPH_PRIMARY_SURFACE_ADDRESS_C,\n\t\tGRPH_PRIMARY_SURFACE_ADDRESS_C);\n\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_PRIMARY_SURFACE_ADDRESS_C,\n\t\tvalue);\n}\n\n \nstatic void program_pri_addr_l(\n\tstruct dce_mem_input *mem_input110,\n\tPHYSICAL_ADDRESS_LOC address)\n{\n\tuint32_t value = 0;\n\tuint32_t temp = 0;\n\n\t \n\ttemp = address.high_part &\nUNP_GRPH_PRIMARY_SURFACE_ADDRESS_HIGH_L__GRPH_PRIMARY_SURFACE_ADDRESS_HIGH_L_MASK;\n\n\tset_reg_field_value(value, temp,\n\t\tUNP_GRPH_PRIMARY_SURFACE_ADDRESS_HIGH_L,\n\t\tGRPH_PRIMARY_SURFACE_ADDRESS_HIGH_L);\n\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_PRIMARY_SURFACE_ADDRESS_HIGH_L,\n\t\tvalue);\n\n\ttemp = 0;\n\tvalue = 0;\n\ttemp = address.low_part >>\n\tUNP_GRPH_PRIMARY_SURFACE_ADDRESS_L__GRPH_PRIMARY_SURFACE_ADDRESS_L__SHIFT;\n\n\tset_reg_field_value(value, temp,\n\t\tUNP_GRPH_PRIMARY_SURFACE_ADDRESS_L,\n\t\tGRPH_PRIMARY_SURFACE_ADDRESS_L);\n\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_PRIMARY_SURFACE_ADDRESS_L,\n\t\tvalue);\n}\n\nstatic void program_addr(\n\tstruct dce_mem_input *mem_input110,\n\tconst struct dc_plane_address *addr)\n{\n\tswitch (addr->type) {\n\tcase PLN_ADDR_TYPE_GRAPHICS:\n\t\tprogram_pri_addr_l(\n\t\t\tmem_input110,\n\t\t\taddr->grph.addr);\n\t\tbreak;\n\tcase PLN_ADDR_TYPE_VIDEO_PROGRESSIVE:\n\t\tprogram_pri_addr_c(\n\t\t\tmem_input110,\n\t\t\taddr->video_progressive.chroma_addr);\n\t\tprogram_pri_addr_l(\n\t\t\tmem_input110,\n\t\t\taddr->video_progressive.luma_addr);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tBREAK_TO_DEBUGGER();\n\t}\n}\n\nstatic void enable(struct dce_mem_input *mem_input110)\n{\n\tuint32_t value = 0;\n\n\tvalue = dm_read_reg(mem_input110->base.ctx, mmUNP_GRPH_ENABLE);\n\tset_reg_field_value(value, 1, UNP_GRPH_ENABLE, GRPH_ENABLE);\n\tdm_write_reg(mem_input110->base.ctx,\n\t\tmmUNP_GRPH_ENABLE,\n\t\tvalue);\n}\n\nstatic void program_tiling(\n\tstruct dce_mem_input *mem_input110,\n\tconst union dc_tiling_info *info,\n\tconst enum surface_pixel_format pixel_format)\n{\n\tuint32_t value = 0;\n\n\tset_reg_field_value(value, info->gfx8.num_banks,\n\t\tUNP_GRPH_CONTROL, GRPH_NUM_BANKS);\n\n\tset_reg_field_value(value, info->gfx8.bank_width,\n\t\tUNP_GRPH_CONTROL, GRPH_BANK_WIDTH_L);\n\n\tset_reg_field_value(value, info->gfx8.bank_height,\n\t\tUNP_GRPH_CONTROL, GRPH_BANK_HEIGHT_L);\n\n\tset_reg_field_value(value, info->gfx8.tile_aspect,\n\t\tUNP_GRPH_CONTROL, GRPH_MACRO_TILE_ASPECT_L);\n\n\tset_reg_field_value(value, info->gfx8.tile_split,\n\t\tUNP_GRPH_CONTROL, GRPH_TILE_SPLIT_L);\n\n\tset_reg_field_value(value, info->gfx8.tile_mode,\n\t\tUNP_GRPH_CONTROL, GRPH_MICRO_TILE_MODE_L);\n\n\tset_reg_field_value(value, info->gfx8.pipe_config,\n\t\tUNP_GRPH_CONTROL, GRPH_PIPE_CONFIG);\n\n\tset_reg_field_value(value, info->gfx8.array_mode,\n\t\tUNP_GRPH_CONTROL, GRPH_ARRAY_MODE);\n\n\tset_reg_field_value(value, 1,\n\t\tUNP_GRPH_CONTROL, GRPH_COLOR_EXPANSION_MODE);\n\n\tset_reg_field_value(value, 0,\n\t\tUNP_GRPH_CONTROL, GRPH_Z);\n\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_CONTROL,\n\t\tvalue);\n\n\tvalue = 0;\n\n\tset_reg_field_value(value, info->gfx8.bank_width_c,\n\t\tUNP_GRPH_CONTROL_C, GRPH_BANK_WIDTH_C);\n\n\tset_reg_field_value(value, info->gfx8.bank_height_c,\n\t\tUNP_GRPH_CONTROL_C, GRPH_BANK_HEIGHT_C);\n\n\tset_reg_field_value(value, info->gfx8.tile_aspect_c,\n\t\tUNP_GRPH_CONTROL_C, GRPH_MACRO_TILE_ASPECT_C);\n\n\tset_reg_field_value(value, info->gfx8.tile_split_c,\n\t\tUNP_GRPH_CONTROL_C, GRPH_TILE_SPLIT_C);\n\n\tset_reg_field_value(value, info->gfx8.tile_mode_c,\n\t\tUNP_GRPH_CONTROL_C, GRPH_MICRO_TILE_MODE_C);\n\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_CONTROL_C,\n\t\tvalue);\n}\n\nstatic void program_size_and_rotation(\n\tstruct dce_mem_input *mem_input110,\n\tenum dc_rotation_angle rotation,\n\tconst struct plane_size *plane_size)\n{\n\tuint32_t value = 0;\n\tstruct plane_size local_size = *plane_size;\n\n\tif (rotation == ROTATION_ANGLE_90 ||\n\t\trotation == ROTATION_ANGLE_270) {\n\n\t\tswap(local_size.surface_size.x,\n\t\t     local_size.surface_size.y);\n\t\tswap(local_size.surface_size.width,\n\t\t     local_size.surface_size.height);\n\t\tswap(local_size.chroma_size.x,\n\t\t     local_size.chroma_size.y);\n\t\tswap(local_size.chroma_size.width,\n\t\t     local_size.chroma_size.height);\n\t}\n\n\tvalue = 0;\n\tset_reg_field_value(value, local_size.surface_pitch,\n\t\t\tUNP_GRPH_PITCH_L, GRPH_PITCH_L);\n\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_PITCH_L,\n\t\tvalue);\n\n\tvalue = 0;\n\tset_reg_field_value(value, local_size.chroma_pitch,\n\t\t\tUNP_GRPH_PITCH_C, GRPH_PITCH_C);\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_PITCH_C,\n\t\tvalue);\n\n\tvalue = 0;\n\tset_reg_field_value(value, 0,\n\t\t\tUNP_GRPH_X_START_L, GRPH_X_START_L);\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_X_START_L,\n\t\tvalue);\n\n\tvalue = 0;\n\tset_reg_field_value(value, 0,\n\t\t\tUNP_GRPH_X_START_C, GRPH_X_START_C);\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_X_START_C,\n\t\tvalue);\n\n\tvalue = 0;\n\tset_reg_field_value(value, 0,\n\t\t\tUNP_GRPH_Y_START_L, GRPH_Y_START_L);\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_Y_START_L,\n\t\tvalue);\n\n\tvalue = 0;\n\tset_reg_field_value(value, 0,\n\t\t\tUNP_GRPH_Y_START_C, GRPH_Y_START_C);\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_Y_START_C,\n\t\tvalue);\n\n\tvalue = 0;\n\tset_reg_field_value(value, local_size.surface_size.x +\n\t\t\tlocal_size.surface_size.width,\n\t\t\tUNP_GRPH_X_END_L, GRPH_X_END_L);\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_X_END_L,\n\t\tvalue);\n\n\tvalue = 0;\n\tset_reg_field_value(value, local_size.chroma_size.x +\n\t\t\tlocal_size.chroma_size.width,\n\t\t\tUNP_GRPH_X_END_C, GRPH_X_END_C);\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_X_END_C,\n\t\tvalue);\n\n\tvalue = 0;\n\tset_reg_field_value(value, local_size.surface_size.y +\n\t\t\tlocal_size.surface_size.height,\n\t\t\tUNP_GRPH_Y_END_L, GRPH_Y_END_L);\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_Y_END_L,\n\t\tvalue);\n\n\tvalue = 0;\n\tset_reg_field_value(value, local_size.chroma_size.y +\n\t\t\tlocal_size.chroma_size.height,\n\t\t\tUNP_GRPH_Y_END_C, GRPH_Y_END_C);\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_GRPH_Y_END_C,\n\t\tvalue);\n\n\tvalue = 0;\n\tswitch (rotation) {\n\tcase ROTATION_ANGLE_90:\n\t\tset_reg_field_value(value, 3,\n\t\t\tUNP_HW_ROTATION, ROTATION_ANGLE);\n\t\tbreak;\n\tcase ROTATION_ANGLE_180:\n\t\tset_reg_field_value(value, 2,\n\t\t\tUNP_HW_ROTATION, ROTATION_ANGLE);\n\t\tbreak;\n\tcase ROTATION_ANGLE_270:\n\t\tset_reg_field_value(value, 1,\n\t\t\tUNP_HW_ROTATION, ROTATION_ANGLE);\n\t\tbreak;\n\tdefault:\n\t\tset_reg_field_value(value, 0,\n\t\t\tUNP_HW_ROTATION, ROTATION_ANGLE);\n\t\tbreak;\n\t}\n\n\tdm_write_reg(\n\t\tmem_input110->base.ctx,\n\t\tmmUNP_HW_ROTATION,\n\t\tvalue);\n}\n\nstatic void program_pixel_format(\n\tstruct dce_mem_input *mem_input110,\n\tenum surface_pixel_format format)\n{\n\tif (format < SURFACE_PIXEL_FORMAT_VIDEO_BEGIN) {\n\t\tuint32_t value;\n\t\tuint8_t grph_depth;\n\t\tuint8_t grph_format;\n\n\t\tvalue =\tdm_read_reg(\n\t\t\t\tmem_input110->base.ctx,\n\t\t\t\tmmUNP_GRPH_CONTROL);\n\n\t\tswitch (format) {\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_PALETA_256_COLORS:\n\t\t\tgrph_depth = 0;\n\t\t\tgrph_format = 0;\n\t\t\tbreak;\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB565:\n\t\t\tgrph_depth = 1;\n\t\t\tgrph_format = 1;\n\t\t\tbreak;\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB8888:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR8888:\n\t\t\tgrph_depth = 2;\n\t\t\tgrph_format = 0;\n\t\t\tbreak;\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB2101010:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR2101010:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR2101010_XR_BIAS:\n\t\t\tgrph_depth = 2;\n\t\t\tgrph_format = 1;\n\t\t\tbreak;\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616F:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616F:\n\t\t\tgrph_depth = 3;\n\t\t\tgrph_format = 0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tgrph_depth = 2;\n\t\t\tgrph_format = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\tgrph_depth,\n\t\t\t\tUNP_GRPH_CONTROL,\n\t\t\t\tGRPH_DEPTH);\n\t\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\tgrph_format,\n\t\t\t\tUNP_GRPH_CONTROL,\n\t\t\t\tGRPH_FORMAT);\n\n\t\tdm_write_reg(\n\t\t\t\tmem_input110->base.ctx,\n\t\t\t\tmmUNP_GRPH_CONTROL,\n\t\t\t\tvalue);\n\n\t\tvalue =\tdm_read_reg(\n\t\t\t\tmem_input110->base.ctx,\n\t\t\t\tmmUNP_GRPH_CONTROL_EXP);\n\n\t\t \n\t\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\t0,\n\t\t\t\tUNP_GRPH_CONTROL_EXP,\n\t\t\t\tVIDEO_FORMAT);\n\t\tdm_write_reg(\n\t\t\t\tmem_input110->base.ctx,\n\t\t\t\tmmUNP_GRPH_CONTROL_EXP,\n\t\t\t\tvalue);\n\n\t} else {\n\t\t \n\t\tuint32_t value;\n\t\tuint8_t video_format;\n\n\t\tvalue =\tdm_read_reg(\n\t\t\t\tmem_input110->base.ctx,\n\t\t\t\tmmUNP_GRPH_CONTROL_EXP);\n\n\t\tswitch (format) {\n\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCbCr:\n\t\t\tvideo_format = 2;\n\t\t\tbreak;\n\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCrCb:\n\t\t\tvideo_format = 3;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tvideo_format = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tvideo_format,\n\t\t\tUNP_GRPH_CONTROL_EXP,\n\t\t\tVIDEO_FORMAT);\n\n\t\tdm_write_reg(\n\t\t\tmem_input110->base.ctx,\n\t\t\tmmUNP_GRPH_CONTROL_EXP,\n\t\t\tvalue);\n\t}\n}\n\nstatic bool dce_mem_input_v_is_surface_pending(struct mem_input *mem_input)\n{\n\tstruct dce_mem_input *mem_input110 = TO_DCE_MEM_INPUT(mem_input);\n\tuint32_t value;\n\n\tvalue = dm_read_reg(mem_input110->base.ctx, mmUNP_GRPH_UPDATE);\n\n\tif (get_reg_field_value(value, UNP_GRPH_UPDATE,\n\t\t\tGRPH_SURFACE_UPDATE_PENDING))\n\t\treturn true;\n\n\tmem_input->current_address = mem_input->request_address;\n\treturn false;\n}\n\nstatic bool dce_mem_input_v_program_surface_flip_and_addr(\n\tstruct mem_input *mem_input,\n\tconst struct dc_plane_address *address,\n\tbool flip_immediate)\n{\n\tstruct dce_mem_input *mem_input110 = TO_DCE_MEM_INPUT(mem_input);\n\n\tset_flip_control(mem_input110, flip_immediate);\n\tprogram_addr(mem_input110,\n\t\taddress);\n\n\tmem_input->request_address = *address;\n\n\treturn true;\n}\n\n \nstatic const unsigned int dvmm_Hw_Setting_2DTiling[4][9] = {\n\t\t{  8, 64, 64,  8,  8, 1, 4, 0, 0},\n\t\t{ 16, 64, 32,  8, 16, 1, 8, 0, 0},\n\t\t{ 32, 32, 32, 16, 16, 1, 8, 0, 0},\n\t\t{ 64,  8, 32, 16, 16, 1, 8, 0, 0},  \n};\n\nstatic const unsigned int dvmm_Hw_Setting_1DTiling[4][9] = {\n\t\t{  8, 512, 8, 1, 0, 1, 0, 0, 0},   \n\t\t{ 16, 256, 8, 2, 0, 1, 0, 0, 0},\n\t\t{ 32, 128, 8, 4, 0, 1, 0, 0, 0},\n\t\t{ 64,  64, 8, 4, 0, 1, 0, 0, 0},  \n};\n\nstatic const unsigned int dvmm_Hw_Setting_Linear[4][9] = {\n\t\t{  8, 4096, 1, 8, 0, 1, 0, 0, 0},\n\t\t{ 16, 2048, 1, 8, 0, 1, 0, 0, 0},\n\t\t{ 32, 1024, 1, 8, 0, 1, 0, 0, 0},\n\t\t{ 64,  512, 1, 8, 0, 1, 0, 0, 0},  \n};\n\n \nstatic const unsigned int *get_dvmm_hw_setting(\n\t\tunion dc_tiling_info *tiling_info,\n\t\tenum surface_pixel_format format,\n\t\tbool chroma)\n{\n\tenum bits_per_pixel {\n\t\tbpp_8 = 0,\n\t\tbpp_16,\n\t\tbpp_32,\n\t\tbpp_64\n\t} bpp;\n\n\tif (format >= SURFACE_PIXEL_FORMAT_INVALID)\n\t\tbpp = bpp_32;\n\telse if (format >= SURFACE_PIXEL_FORMAT_VIDEO_BEGIN)\n\t\tbpp = chroma ? bpp_16 : bpp_8;\n\telse\n\t\tbpp = bpp_8;\n\n\tswitch (tiling_info->gfx8.array_mode) {\n\tcase DC_ARRAY_1D_TILED_THIN1:\n\tcase DC_ARRAY_1D_TILED_THICK:\n\tcase DC_ARRAY_PRT_TILED_THIN1:\n\t\treturn dvmm_Hw_Setting_1DTiling[bpp];\n\tcase DC_ARRAY_2D_TILED_THIN1:\n\tcase DC_ARRAY_2D_TILED_THICK:\n\tcase DC_ARRAY_2D_TILED_X_THICK:\n\tcase DC_ARRAY_PRT_2D_TILED_THIN1:\n\tcase DC_ARRAY_PRT_2D_TILED_THICK:\n\t\treturn dvmm_Hw_Setting_2DTiling[bpp];\n\tcase DC_ARRAY_LINEAR_GENERAL:\n\tcase DC_ARRAY_LINEAR_ALLIGNED:\n\t\treturn dvmm_Hw_Setting_Linear[bpp];\n\tdefault:\n\t\treturn dvmm_Hw_Setting_2DTiling[bpp];\n\t}\n}\n\nstatic void dce_mem_input_v_program_pte_vm(\n\t\tstruct mem_input *mem_input,\n\t\tenum surface_pixel_format format,\n\t\tunion dc_tiling_info *tiling_info,\n\t\tenum dc_rotation_angle rotation)\n{\n\tstruct dce_mem_input *mem_input110 = TO_DCE_MEM_INPUT(mem_input);\n\tconst unsigned int *pte = get_dvmm_hw_setting(tiling_info, format, false);\n\tconst unsigned int *pte_chroma = get_dvmm_hw_setting(tiling_info, format, true);\n\n\tunsigned int page_width = 0;\n\tunsigned int page_height = 0;\n\tunsigned int page_width_chroma = 0;\n\tunsigned int page_height_chroma = 0;\n\tunsigned int temp_page_width = pte[1];\n\tunsigned int temp_page_height = pte[2];\n\tunsigned int min_pte_before_flip = 0;\n\tunsigned int min_pte_before_flip_chroma = 0;\n\tuint32_t value = 0;\n\n\twhile ((temp_page_width >>= 1) != 0)\n\t\tpage_width++;\n\twhile ((temp_page_height >>= 1) != 0)\n\t\tpage_height++;\n\n\ttemp_page_width = pte_chroma[1];\n\ttemp_page_height = pte_chroma[2];\n\twhile ((temp_page_width >>= 1) != 0)\n\t\tpage_width_chroma++;\n\twhile ((temp_page_height >>= 1) != 0)\n\t\tpage_height_chroma++;\n\n\tswitch (rotation) {\n\tcase ROTATION_ANGLE_90:\n\tcase ROTATION_ANGLE_270:\n\t\tmin_pte_before_flip = pte[4];\n\t\tmin_pte_before_flip_chroma = pte_chroma[4];\n\t\tbreak;\n\tdefault:\n\t\tmin_pte_before_flip = pte[3];\n\t\tmin_pte_before_flip_chroma = pte_chroma[3];\n\t\tbreak;\n\t}\n\n\tvalue = dm_read_reg(mem_input110->base.ctx, mmUNP_PIPE_OUTSTANDING_REQUEST_LIMIT);\n\t \n\tset_reg_field_value(value, 0xff, UNP_PIPE_OUTSTANDING_REQUEST_LIMIT, UNP_PIPE_OUTSTANDING_REQUEST_LIMIT_L);\n\tset_reg_field_value(value, 0xff, UNP_PIPE_OUTSTANDING_REQUEST_LIMIT, UNP_PIPE_OUTSTANDING_REQUEST_LIMIT_C);\n\tdm_write_reg(mem_input110->base.ctx, mmUNP_PIPE_OUTSTANDING_REQUEST_LIMIT, value);\n\n\tvalue = dm_read_reg(mem_input110->base.ctx, mmUNP_DVMM_PTE_CONTROL);\n\tset_reg_field_value(value, page_width, UNP_DVMM_PTE_CONTROL, DVMM_PAGE_WIDTH);\n\tset_reg_field_value(value, page_height, UNP_DVMM_PTE_CONTROL, DVMM_PAGE_HEIGHT);\n\tset_reg_field_value(value, min_pte_before_flip, UNP_DVMM_PTE_CONTROL, DVMM_MIN_PTE_BEFORE_FLIP);\n\tdm_write_reg(mem_input110->base.ctx, mmUNP_DVMM_PTE_CONTROL, value);\n\n\tvalue = dm_read_reg(mem_input110->base.ctx, mmUNP_DVMM_PTE_ARB_CONTROL);\n\tset_reg_field_value(value, pte[5], UNP_DVMM_PTE_ARB_CONTROL, DVMM_PTE_REQ_PER_CHUNK);\n\tset_reg_field_value(value, 0xff, UNP_DVMM_PTE_ARB_CONTROL, DVMM_MAX_PTE_REQ_OUTSTANDING);\n\tdm_write_reg(mem_input110->base.ctx, mmUNP_DVMM_PTE_ARB_CONTROL, value);\n\n\tvalue = dm_read_reg(mem_input110->base.ctx, mmUNP_DVMM_PTE_CONTROL_C);\n\tset_reg_field_value(value, page_width_chroma, UNP_DVMM_PTE_CONTROL_C, DVMM_PAGE_WIDTH_C);\n\tset_reg_field_value(value, page_height_chroma, UNP_DVMM_PTE_CONTROL_C, DVMM_PAGE_HEIGHT_C);\n\tset_reg_field_value(value, min_pte_before_flip_chroma, UNP_DVMM_PTE_CONTROL_C, DVMM_MIN_PTE_BEFORE_FLIP_C);\n\tdm_write_reg(mem_input110->base.ctx, mmUNP_DVMM_PTE_CONTROL_C, value);\n\n\tvalue = dm_read_reg(mem_input110->base.ctx, mmUNP_DVMM_PTE_ARB_CONTROL_C);\n\tset_reg_field_value(value, pte_chroma[5], UNP_DVMM_PTE_ARB_CONTROL_C, DVMM_PTE_REQ_PER_CHUNK_C);\n\tset_reg_field_value(value, 0xff, UNP_DVMM_PTE_ARB_CONTROL_C, DVMM_MAX_PTE_REQ_OUTSTANDING_C);\n\tdm_write_reg(mem_input110->base.ctx, mmUNP_DVMM_PTE_ARB_CONTROL_C, value);\n}\n\nstatic void dce_mem_input_v_program_surface_config(\n\tstruct mem_input *mem_input,\n\tenum surface_pixel_format format,\n\tunion dc_tiling_info *tiling_info,\n\tstruct plane_size *plane_size,\n\tenum dc_rotation_angle rotation,\n\tstruct dc_plane_dcc_param *dcc,\n\tbool horizotal_mirror)\n{\n\tstruct dce_mem_input *mem_input110 = TO_DCE_MEM_INPUT(mem_input);\n\n\tenable(mem_input110);\n\tprogram_tiling(mem_input110, tiling_info, format);\n\tprogram_size_and_rotation(mem_input110, rotation, plane_size);\n\tprogram_pixel_format(mem_input110, format);\n}\n\nstatic void program_urgency_watermark(\n\tconst struct dc_context *ctx,\n\tconst uint32_t urgency_addr,\n\tconst uint32_t wm_addr,\n\tstruct dce_watermarks marks_low,\n\tuint32_t total_dest_line_time_ns)\n{\n\t \n\tuint32_t urgency_cntl = 0;\n\tuint32_t wm_mask_cntl = 0;\n\n\t \n\twm_mask_cntl = dm_read_reg(ctx, wm_addr);\n\tset_reg_field_value(wm_mask_cntl,\n\t\t\t1,\n\t\t\tDPGV0_WATERMARK_MASK_CONTROL,\n\t\t\tURGENCY_WATERMARK_MASK);\n\tdm_write_reg(ctx, wm_addr, wm_mask_cntl);\n\n\turgency_cntl = dm_read_reg(ctx, urgency_addr);\n\n\tset_reg_field_value(\n\t\turgency_cntl,\n\t\tmarks_low.a_mark,\n\t\tDPGV0_PIPE_URGENCY_CONTROL,\n\t\tURGENCY_LOW_WATERMARK);\n\n\tset_reg_field_value(\n\t\turgency_cntl,\n\t\ttotal_dest_line_time_ns,\n\t\tDPGV0_PIPE_URGENCY_CONTROL,\n\t\tURGENCY_HIGH_WATERMARK);\n\tdm_write_reg(ctx, urgency_addr, urgency_cntl);\n\n\t \n\twm_mask_cntl = dm_read_reg(ctx, wm_addr);\n\tset_reg_field_value(wm_mask_cntl,\n\t\t\t2,\n\t\t\tDPGV0_WATERMARK_MASK_CONTROL,\n\t\t\tURGENCY_WATERMARK_MASK);\n\tdm_write_reg(ctx, wm_addr, wm_mask_cntl);\n\n\turgency_cntl = dm_read_reg(ctx, urgency_addr);\n\n\tset_reg_field_value(urgency_cntl,\n\t\tmarks_low.b_mark,\n\t\tDPGV0_PIPE_URGENCY_CONTROL,\n\t\tURGENCY_LOW_WATERMARK);\n\n\tset_reg_field_value(urgency_cntl,\n\t\ttotal_dest_line_time_ns,\n\t\tDPGV0_PIPE_URGENCY_CONTROL,\n\t\tURGENCY_HIGH_WATERMARK);\n\n\tdm_write_reg(ctx, urgency_addr, urgency_cntl);\n}\n\nstatic void program_urgency_watermark_l(\n\tconst struct dc_context *ctx,\n\tstruct dce_watermarks marks_low,\n\tuint32_t total_dest_line_time_ns)\n{\n\tprogram_urgency_watermark(\n\t\tctx,\n\t\tmmDPGV0_PIPE_URGENCY_CONTROL,\n\t\tmmDPGV0_WATERMARK_MASK_CONTROL,\n\t\tmarks_low,\n\t\ttotal_dest_line_time_ns);\n}\n\nstatic void program_urgency_watermark_c(\n\tconst struct dc_context *ctx,\n\tstruct dce_watermarks marks_low,\n\tuint32_t total_dest_line_time_ns)\n{\n\tprogram_urgency_watermark(\n\t\tctx,\n\t\tmmDPGV1_PIPE_URGENCY_CONTROL,\n\t\tmmDPGV1_WATERMARK_MASK_CONTROL,\n\t\tmarks_low,\n\t\ttotal_dest_line_time_ns);\n}\n\nstatic void program_stutter_watermark(\n\tconst struct dc_context *ctx,\n\tconst uint32_t stutter_addr,\n\tconst uint32_t wm_addr,\n\tstruct dce_watermarks marks)\n{\n\t \n\tuint32_t stutter_cntl = 0;\n\tuint32_t wm_mask_cntl = 0;\n\n\t \n\n\twm_mask_cntl = dm_read_reg(ctx, wm_addr);\n\tset_reg_field_value(wm_mask_cntl,\n\t\t1,\n\t\tDPGV0_WATERMARK_MASK_CONTROL,\n\t\tSTUTTER_EXIT_SELF_REFRESH_WATERMARK_MASK);\n\tdm_write_reg(ctx, wm_addr, wm_mask_cntl);\n\n\tstutter_cntl = dm_read_reg(ctx, stutter_addr);\n\n\tif (ctx->dc->debug.disable_stutter) {\n\t\tset_reg_field_value(stutter_cntl,\n\t\t\t0,\n\t\t\tDPGV0_PIPE_STUTTER_CONTROL,\n\t\t\tSTUTTER_ENABLE);\n\t} else {\n\t\tset_reg_field_value(stutter_cntl,\n\t\t\t1,\n\t\t\tDPGV0_PIPE_STUTTER_CONTROL,\n\t\t\tSTUTTER_ENABLE);\n\t}\n\n\tset_reg_field_value(stutter_cntl,\n\t\t1,\n\t\tDPGV0_PIPE_STUTTER_CONTROL,\n\t\tSTUTTER_IGNORE_FBC);\n\n\t \n\tset_reg_field_value(stutter_cntl,\n\t\tmarks.a_mark,\n\t\tDPGV0_PIPE_STUTTER_CONTROL,\n\t\tSTUTTER_EXIT_SELF_REFRESH_WATERMARK);\n\tdm_write_reg(ctx, stutter_addr, stutter_cntl);\n\n\t \n\twm_mask_cntl = dm_read_reg(ctx, wm_addr);\n\tset_reg_field_value(wm_mask_cntl,\n\t\t2,\n\t\tDPGV0_WATERMARK_MASK_CONTROL,\n\t\tSTUTTER_EXIT_SELF_REFRESH_WATERMARK_MASK);\n\tdm_write_reg(ctx, wm_addr, wm_mask_cntl);\n\n\tstutter_cntl = dm_read_reg(ctx, stutter_addr);\n\t \n\tset_reg_field_value(stutter_cntl,\n\t\tmarks.b_mark,\n\t\tDPGV0_PIPE_STUTTER_CONTROL,\n\t\tSTUTTER_EXIT_SELF_REFRESH_WATERMARK);\n\tdm_write_reg(ctx, stutter_addr, stutter_cntl);\n}\n\nstatic void program_stutter_watermark_l(\n\tconst struct dc_context *ctx,\n\tstruct dce_watermarks marks)\n{\n\tprogram_stutter_watermark(ctx,\n\t\t\tmmDPGV0_PIPE_STUTTER_CONTROL,\n\t\t\tmmDPGV0_WATERMARK_MASK_CONTROL,\n\t\t\tmarks);\n}\n\nstatic void program_stutter_watermark_c(\n\tconst struct dc_context *ctx,\n\tstruct dce_watermarks marks)\n{\n\tprogram_stutter_watermark(ctx,\n\t\t\tmmDPGV1_PIPE_STUTTER_CONTROL,\n\t\t\tmmDPGV1_WATERMARK_MASK_CONTROL,\n\t\t\tmarks);\n}\n\nstatic void program_nbp_watermark(\n\tconst struct dc_context *ctx,\n\tconst uint32_t wm_mask_ctrl_addr,\n\tconst uint32_t nbp_pstate_ctrl_addr,\n\tstruct dce_watermarks marks)\n{\n\tuint32_t value;\n\n\t \n\n\tvalue = dm_read_reg(ctx, wm_mask_ctrl_addr);\n\n\tset_reg_field_value(\n\t\tvalue,\n\t\t1,\n\t\tDPGV0_WATERMARK_MASK_CONTROL,\n\t\tNB_PSTATE_CHANGE_WATERMARK_MASK);\n\tdm_write_reg(ctx, wm_mask_ctrl_addr, value);\n\n\tvalue = dm_read_reg(ctx, nbp_pstate_ctrl_addr);\n\n\tset_reg_field_value(\n\t\tvalue,\n\t\t1,\n\t\tDPGV0_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\tNB_PSTATE_CHANGE_ENABLE);\n\tset_reg_field_value(\n\t\tvalue,\n\t\t1,\n\t\tDPGV0_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\tNB_PSTATE_CHANGE_URGENT_DURING_REQUEST);\n\tset_reg_field_value(\n\t\tvalue,\n\t\t1,\n\t\tDPGV0_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\tNB_PSTATE_CHANGE_NOT_SELF_REFRESH_DURING_REQUEST);\n\tdm_write_reg(ctx, nbp_pstate_ctrl_addr, value);\n\n\t \n\tvalue = dm_read_reg(ctx, nbp_pstate_ctrl_addr);\n\tset_reg_field_value(\n\t\tvalue,\n\t\tmarks.a_mark,\n\t\tDPGV0_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\tNB_PSTATE_CHANGE_WATERMARK);\n\tdm_write_reg(ctx, nbp_pstate_ctrl_addr, value);\n\n\t \n\tvalue = dm_read_reg(ctx, wm_mask_ctrl_addr);\n\tset_reg_field_value(\n\t\tvalue,\n\t\t2,\n\t\tDPGV0_WATERMARK_MASK_CONTROL,\n\t\tNB_PSTATE_CHANGE_WATERMARK_MASK);\n\tdm_write_reg(ctx, wm_mask_ctrl_addr, value);\n\n\tvalue = dm_read_reg(ctx, nbp_pstate_ctrl_addr);\n\tset_reg_field_value(\n\t\tvalue,\n\t\t1,\n\t\tDPGV0_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\tNB_PSTATE_CHANGE_ENABLE);\n\tset_reg_field_value(\n\t\tvalue,\n\t\t1,\n\t\tDPGV0_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\tNB_PSTATE_CHANGE_URGENT_DURING_REQUEST);\n\tset_reg_field_value(\n\t\tvalue,\n\t\t1,\n\t\tDPGV0_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\tNB_PSTATE_CHANGE_NOT_SELF_REFRESH_DURING_REQUEST);\n\tdm_write_reg(ctx, nbp_pstate_ctrl_addr, value);\n\n\t \n\tvalue = dm_read_reg(ctx, nbp_pstate_ctrl_addr);\n\tset_reg_field_value(\n\t\tvalue,\n\t\tmarks.b_mark,\n\t\tDPGV0_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\tNB_PSTATE_CHANGE_WATERMARK);\n\tdm_write_reg(ctx, nbp_pstate_ctrl_addr, value);\n}\n\nstatic void program_nbp_watermark_l(\n\tconst struct dc_context *ctx,\n\tstruct dce_watermarks marks)\n{\n\tprogram_nbp_watermark(ctx,\n\t\t\tmmDPGV0_WATERMARK_MASK_CONTROL,\n\t\t\tmmDPGV0_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\t\tmarks);\n}\n\nstatic void program_nbp_watermark_c(\n\tconst struct dc_context *ctx,\n\tstruct dce_watermarks marks)\n{\n\tprogram_nbp_watermark(ctx,\n\t\t\tmmDPGV1_WATERMARK_MASK_CONTROL,\n\t\t\tmmDPGV1_PIPE_NB_PSTATE_CHANGE_CONTROL,\n\t\t\tmarks);\n}\n\nstatic void dce_mem_input_v_program_display_marks(\n\tstruct mem_input *mem_input,\n\tstruct dce_watermarks nbp,\n\tstruct dce_watermarks stutter,\n\tstruct dce_watermarks stutter_enter,\n\tstruct dce_watermarks urgent,\n\tuint32_t total_dest_line_time_ns)\n{\n\tprogram_urgency_watermark_l(\n\t\tmem_input->ctx,\n\t\turgent,\n\t\ttotal_dest_line_time_ns);\n\n\tprogram_nbp_watermark_l(\n\t\tmem_input->ctx,\n\t\tnbp);\n\n\tprogram_stutter_watermark_l(\n\t\tmem_input->ctx,\n\t\tstutter);\n\n}\n\nstatic void dce_mem_input_program_chroma_display_marks(\n\tstruct mem_input *mem_input,\n\tstruct dce_watermarks nbp,\n\tstruct dce_watermarks stutter,\n\tstruct dce_watermarks urgent,\n\tuint32_t total_dest_line_time_ns)\n{\n\tprogram_urgency_watermark_c(\n\t\tmem_input->ctx,\n\t\turgent,\n\t\ttotal_dest_line_time_ns);\n\n\tprogram_nbp_watermark_c(\n\t\tmem_input->ctx,\n\t\tnbp);\n\n\tprogram_stutter_watermark_c(\n\t\tmem_input->ctx,\n\t\tstutter);\n}\n\nstatic void dce110_allocate_mem_input_v(\n\tstruct mem_input *mi,\n\tuint32_t h_total, \n\tuint32_t v_total, \n\tuint32_t pix_clk_khz, \n\tuint32_t total_stream_num)\n{\n\tuint32_t addr;\n\tuint32_t value;\n\tuint32_t pix_dur;\n\tif (pix_clk_khz != 0) {\n\t\taddr = mmDPGV0_PIPE_ARBITRATION_CONTROL1;\n\t\tvalue = dm_read_reg(mi->ctx, addr);\n\t\tpix_dur = 1000000000ULL / pix_clk_khz;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tpix_dur,\n\t\t\tDPGV0_PIPE_ARBITRATION_CONTROL1,\n\t\t\tPIXEL_DURATION);\n\t\tdm_write_reg(mi->ctx, addr, value);\n\n\t\taddr = mmDPGV1_PIPE_ARBITRATION_CONTROL1;\n\t\tvalue = dm_read_reg(mi->ctx, addr);\n\t\tpix_dur = 1000000000ULL / pix_clk_khz;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tpix_dur,\n\t\t\tDPGV1_PIPE_ARBITRATION_CONTROL1,\n\t\t\tPIXEL_DURATION);\n\t\tdm_write_reg(mi->ctx, addr, value);\n\n\t\taddr = mmDPGV0_PIPE_ARBITRATION_CONTROL2;\n\t\tvalue = 0x4000800;\n\t\tdm_write_reg(mi->ctx, addr, value);\n\n\t\taddr = mmDPGV1_PIPE_ARBITRATION_CONTROL2;\n\t\tvalue = 0x4000800;\n\t\tdm_write_reg(mi->ctx, addr, value);\n\t}\n\n}\n\nstatic void dce110_free_mem_input_v(\n\tstruct mem_input *mi,\n\tuint32_t total_stream_num)\n{\n}\n\nstatic const struct mem_input_funcs dce110_mem_input_v_funcs = {\n\t.mem_input_program_display_marks =\n\t\t\tdce_mem_input_v_program_display_marks,\n\t.mem_input_program_chroma_display_marks =\n\t\t\tdce_mem_input_program_chroma_display_marks,\n\t.allocate_mem_input = dce110_allocate_mem_input_v,\n\t.free_mem_input = dce110_free_mem_input_v,\n\t.mem_input_program_surface_flip_and_addr =\n\t\t\tdce_mem_input_v_program_surface_flip_and_addr,\n\t.mem_input_program_pte_vm =\n\t\t\tdce_mem_input_v_program_pte_vm,\n\t.mem_input_program_surface_config =\n\t\t\tdce_mem_input_v_program_surface_config,\n\t.mem_input_is_flip_pending =\n\t\t\tdce_mem_input_v_is_surface_pending\n};\n \n \n \n\nvoid dce110_mem_input_v_construct(\n\tstruct dce_mem_input *dce_mi,\n\tstruct dc_context *ctx)\n{\n\tdce_mi->base.funcs = &dce110_mem_input_v_funcs;\n\tdce_mi->base.ctx = ctx;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}