{
  "module_name": "dcn201_dpp.c",
  "hash_id": "9240e87f4958011756d08e53b2543886e1e2938ae6abf2a16bfc709e85430085",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn201/dcn201_dpp.c",
  "human_readable_source": " \n\n#include \"dm_services.h\"\n\n#include \"core_types.h\"\n\n#include \"reg_helper.h\"\n#include \"dcn201_dpp.h\"\n#include \"basics/conversion.h\"\n\n#define REG(reg)\\\n\tdpp->tf_regs->reg\n\n#define CTX \\\n\tdpp->base.ctx\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\tdpp->tf_shift->field_name, dpp->tf_mask->field_name\n\nstatic void dpp201_cnv_setup(\n\t\tstruct dpp *dpp_base,\n\t\tenum surface_pixel_format format,\n\t\tenum expansion_mode mode,\n\t\tstruct dc_csc_transform input_csc_color_matrix,\n\t\tenum dc_color_space input_color_space,\n\t\tstruct cnv_alpha_2bit_lut *alpha_2bit_lut)\n{\n\tstruct dcn201_dpp *dpp = TO_DCN201_DPP(dpp_base);\n\tuint32_t pixel_format = 0;\n\tuint32_t alpha_en = 1;\n\tenum dc_color_space color_space = COLOR_SPACE_SRGB;\n\tenum dcn10_input_csc_select select = INPUT_CSC_SELECT_BYPASS;\n\tbool force_disable_cursor = false;\n\tuint32_t is_2bit = 0;\n\n\tREG_SET_2(FORMAT_CONTROL, 0,\n\t\tCNVC_BYPASS, 0,\n\t\tFORMAT_EXPANSION_MODE, mode);\n\n\tREG_UPDATE(FORMAT_CONTROL, FORMAT_CNV16, 0);\n\tREG_UPDATE(FORMAT_CONTROL, CNVC_BYPASS_MSB_ALIGN, 0);\n\tREG_UPDATE(FORMAT_CONTROL, CLAMP_POSITIVE, 0);\n\tREG_UPDATE(FORMAT_CONTROL, CLAMP_POSITIVE_C, 0);\n\n\tswitch (format) {\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB1555:\n\t\tpixel_format = 1;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB565:\n\t\tpixel_format = 3;\n\t\talpha_en = 0;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB8888:\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR8888:\n\t\tpixel_format = 8;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB2101010:\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR2101010:\n\t\tpixel_format = 10;\n\t\tis_2bit = 1;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCbCr:\n\t\tforce_disable_cursor = false;\n\t\tpixel_format = 65;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = INPUT_CSC_SELECT_ICSC;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCrCb:\n\t\tforce_disable_cursor = true;\n\t\tpixel_format = 64;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = INPUT_CSC_SELECT_ICSC;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCbCr:\n\t\tforce_disable_cursor = true;\n\t\tpixel_format = 67;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = INPUT_CSC_SELECT_ICSC;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCrCb:\n\t\tforce_disable_cursor = true;\n\t\tpixel_format = 66;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = INPUT_CSC_SELECT_ICSC;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616:\n\t\tpixel_format = 22;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616F:\n\t\tpixel_format = 24;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616F:\n\t\tpixel_format = 25;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_AYCrCb8888:\n\t\tpixel_format = 12;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = INPUT_CSC_SELECT_ICSC;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB111110_FIX:\n\t\tpixel_format = 112;\n\t\talpha_en = 0;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_BGR101111_FIX:\n\t\tpixel_format = 113;\n\t\talpha_en = 0;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_ACrYCb2101010:\n\t\tpixel_format = 114;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = INPUT_CSC_SELECT_ICSC;\n\t\tis_2bit = 1;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_VIDEO_CrYCbA1010102:\n\t\tpixel_format = 115;\n\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\tselect = INPUT_CSC_SELECT_ICSC;\n\t\tis_2bit = 1;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB111110_FLOAT:\n\t\tpixel_format = 118;\n\t\talpha_en = 0;\n\t\tbreak;\n\tcase SURFACE_PIXEL_FORMAT_GRPH_BGR101111_FLOAT:\n\t\tpixel_format = 119;\n\t\talpha_en = 0;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\t \n\tcolor_space = input_color_space ? input_color_space : color_space;\n\n\tif (is_2bit == 1 && alpha_2bit_lut != NULL) {\n\t\tREG_UPDATE(ALPHA_2BIT_LUT, ALPHA_2BIT_LUT0, alpha_2bit_lut->lut0);\n\t\tREG_UPDATE(ALPHA_2BIT_LUT, ALPHA_2BIT_LUT1, alpha_2bit_lut->lut1);\n\t\tREG_UPDATE(ALPHA_2BIT_LUT, ALPHA_2BIT_LUT2, alpha_2bit_lut->lut2);\n\t\tREG_UPDATE(ALPHA_2BIT_LUT, ALPHA_2BIT_LUT3, alpha_2bit_lut->lut3);\n\t}\n\n\tREG_SET(CNVC_SURFACE_PIXEL_FORMAT, 0,\n\t\t\tCNVC_SURFACE_PIXEL_FORMAT, pixel_format);\n\tREG_UPDATE(FORMAT_CONTROL, FORMAT_CONTROL__ALPHA_EN, alpha_en);\n\n\tdpp1_program_input_csc(dpp_base, color_space, select, NULL);\n\n\tif (force_disable_cursor) {\n\t\tREG_UPDATE(CURSOR_CONTROL,\n\t\t\t\tCURSOR_ENABLE, 0);\n\t\tREG_UPDATE(CURSOR0_CONTROL,\n\t\t\t\tCUR0_ENABLE, 0);\n\t}\n\tdpp2_power_on_obuf(dpp_base, true);\n}\n\n#define IDENTITY_RATIO(ratio) (dc_fixpt_u3d19(ratio) == (1 << 19))\n\nstatic bool dpp201_get_optimal_number_of_taps(\n\t\tstruct dpp *dpp,\n\t\tstruct scaler_data *scl_data,\n\t\tconst struct scaling_taps *in_taps)\n{\n\tif (scl_data->viewport.width  != scl_data->h_active &&\n\t\tscl_data->viewport.height != scl_data->v_active &&\n\t\tdpp->caps->dscl_data_proc_format == DSCL_DATA_PRCESSING_FIXED_FORMAT &&\n\t\tscl_data->format == PIXEL_FORMAT_FP16)\n\t\treturn false;\n\n\tif (scl_data->viewport.width > scl_data->h_active &&\n\t\tdpp->ctx->dc->debug.max_downscale_src_width != 0 &&\n\t\tscl_data->viewport.width > dpp->ctx->dc->debug.max_downscale_src_width)\n\t\treturn false;\n\n\tif (scl_data->ratios.horz.value == (8ll << 32))\n\t\tscl_data->ratios.horz.value--;\n\tif (scl_data->ratios.vert.value == (8ll << 32))\n\t\tscl_data->ratios.vert.value--;\n\tif (scl_data->ratios.horz_c.value == (8ll << 32))\n\t\tscl_data->ratios.horz_c.value--;\n\tif (scl_data->ratios.vert_c.value == (8ll << 32))\n\t\tscl_data->ratios.vert_c.value--;\n\n\tif (in_taps->h_taps == 0) {\n\t\tif (dc_fixpt_ceil(scl_data->ratios.horz) > 4)\n\t\t\tscl_data->taps.h_taps = 8;\n\t\telse\n\t\t\tscl_data->taps.h_taps = 4;\n\t} else\n\t\tscl_data->taps.h_taps = in_taps->h_taps;\n\n\tif (in_taps->v_taps == 0) {\n\t\tif (dc_fixpt_ceil(scl_data->ratios.vert) > 4)\n\t\t\tscl_data->taps.v_taps = 8;\n\t\telse\n\t\t\tscl_data->taps.v_taps = 4;\n\t} else\n\t\tscl_data->taps.v_taps = in_taps->v_taps;\n\tif (in_taps->v_taps_c == 0) {\n\t\tif (dc_fixpt_ceil(scl_data->ratios.vert_c) > 4)\n\t\t\tscl_data->taps.v_taps_c = 4;\n\t\telse\n\t\t\tscl_data->taps.v_taps_c = 2;\n\t} else\n\t\tscl_data->taps.v_taps_c = in_taps->v_taps_c;\n\tif (in_taps->h_taps_c == 0) {\n\t\tif (dc_fixpt_ceil(scl_data->ratios.horz_c) > 4)\n\t\t\tscl_data->taps.h_taps_c = 4;\n\t\telse\n\t\t\tscl_data->taps.h_taps_c = 2;\n\t} else if ((in_taps->h_taps_c % 2) != 0 && in_taps->h_taps_c != 1)\n\t\tscl_data->taps.h_taps_c = in_taps->h_taps_c - 1;\n\telse\n\t\tscl_data->taps.h_taps_c = in_taps->h_taps_c;\n\n\tif (!dpp->ctx->dc->debug.always_scale) {\n\t\tif (IDENTITY_RATIO(scl_data->ratios.horz))\n\t\t\tscl_data->taps.h_taps = 1;\n\t\tif (IDENTITY_RATIO(scl_data->ratios.vert))\n\t\t\tscl_data->taps.v_taps = 1;\n\t\tif (IDENTITY_RATIO(scl_data->ratios.horz_c))\n\t\t\tscl_data->taps.h_taps_c = 1;\n\t\tif (IDENTITY_RATIO(scl_data->ratios.vert_c))\n\t\t\tscl_data->taps.v_taps_c = 1;\n\t}\n\n\treturn true;\n}\n\nstatic struct dpp_funcs dcn201_dpp_funcs = {\n\t.dpp_read_state = dpp20_read_state,\n\t.dpp_reset = dpp_reset,\n\t.dpp_set_scaler = dpp1_dscl_set_scaler_manual_scale,\n\t.dpp_get_optimal_number_of_taps = dpp201_get_optimal_number_of_taps,\n\t.dpp_set_gamut_remap = dpp1_cm_set_gamut_remap,\n\t.dpp_set_csc_adjustment = NULL,\n\t.dpp_set_csc_default = NULL,\n\t.dpp_program_regamma_pwl = oppn20_dummy_program_regamma_pwl,\n\t.dpp_set_degamma = dpp2_set_degamma,\n\t.dpp_program_input_lut = dpp2_dummy_program_input_lut,\n\t.dpp_full_bypass = dpp1_full_bypass,\n\t.dpp_setup = dpp201_cnv_setup,\n\t.dpp_program_degamma_pwl = dpp2_set_degamma_pwl,\n\t.dpp_program_blnd_lut = dpp20_program_blnd_lut,\n\t.dpp_program_shaper_lut = dpp20_program_shaper,\n\t.dpp_program_3dlut = dpp20_program_3dlut,\n\t.dpp_program_bias_and_scale = NULL,\n\t.dpp_cnv_set_alpha_keyer = dpp2_cnv_set_alpha_keyer,\n\t.set_cursor_attributes = dpp2_set_cursor_attributes,\n\t.set_cursor_position = dpp1_set_cursor_position,\n\t.set_optional_cursor_attributes = dpp1_cnv_set_optional_cursor_attributes,\n\t.dpp_dppclk_control = dpp1_dppclk_control,\n\t.dpp_set_hdr_multiplier = dpp2_set_hdr_multiplier,\n};\n\nstatic struct dpp_caps dcn201_dpp_cap = {\n\t.dscl_data_proc_format = DSCL_DATA_PRCESSING_FLOAT_FORMAT,\n\t.dscl_calc_lb_num_partitions = dscl2_calc_lb_num_partitions,\n};\n\nbool dpp201_construct(\n\tstruct dcn201_dpp *dpp,\n\tstruct dc_context *ctx,\n\tuint32_t inst,\n\tconst struct dcn201_dpp_registers *tf_regs,\n\tconst struct dcn201_dpp_shift *tf_shift,\n\tconst struct dcn201_dpp_mask *tf_mask)\n{\n\tdpp->base.ctx = ctx;\n\n\tdpp->base.inst = inst;\n\tdpp->base.funcs = &dcn201_dpp_funcs;\n\tdpp->base.caps = &dcn201_dpp_cap;\n\n\tdpp->tf_regs = tf_regs;\n\tdpp->tf_shift = tf_shift;\n\tdpp->tf_mask = tf_mask;\n\n\tdpp->lb_pixel_depth_supported =\n\t\tLB_PIXEL_DEPTH_18BPP |\n\t\tLB_PIXEL_DEPTH_24BPP |\n\t\tLB_PIXEL_DEPTH_30BPP;\n\n\tdpp->lb_bits_per_entry = LB_BITS_PER_ENTRY;\n\tdpp->lb_memory_size = LB_TOTAL_NUMBER_OF_ENTRIES;\n\n\treturn true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}