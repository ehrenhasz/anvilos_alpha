{
  "module_name": "dcn21_hubbub.c",
  "hash_id": "b82c89c0ae77058a71951ff23f0d5c79e859737bef7885847627cffc793cb9ae",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn21/dcn21_hubbub.c",
  "human_readable_source": " \n#include <linux/delay.h>\n#include \"dm_services.h\"\n#include \"dcn20/dcn20_hubbub.h\"\n#include \"dcn21_hubbub.h\"\n#include \"reg_helper.h\"\n\n#define REG(reg)\\\n\thubbub1->regs->reg\n#define DC_LOGGER \\\n\thubbub1->base.ctx->logger\n#define CTX \\\n\thubbub1->base.ctx\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\thubbub1->shifts->field_name, hubbub1->masks->field_name\n\n#define REG(reg)\\\n\thubbub1->regs->reg\n\n#define CTX \\\n\thubbub1->base.ctx\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\thubbub1->shifts->field_name, hubbub1->masks->field_name\n\nstatic uint32_t convert_and_clamp(\n\tuint32_t wm_ns,\n\tuint32_t refclk_mhz,\n\tuint32_t clamp_value)\n{\n\tuint32_t ret_val = 0;\n\tret_val = wm_ns * refclk_mhz;\n\tret_val /= 1000;\n\n\tif (ret_val > clamp_value)\n\t\tret_val = clamp_value;\n\n\treturn ret_val;\n}\n\nvoid dcn21_dchvm_init(struct hubbub *hubbub)\n{\n\tstruct dcn20_hubbub *hubbub1 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t riommu_active;\n\tint i;\n\n\t\n\tREG_UPDATE(DCHVM_CTRL0, HOSTVM_INIT_REQ, 1);\n\n\t\n\tfor (i = 0; i < 100; i++) {\n\t\tREG_GET(DCHVM_RIOMMU_STAT0, RIOMMU_ACTIVE, &riommu_active);\n\n\t\tif (riommu_active)\n\t\t\tbreak;\n\t\telse\n\t\t\tudelay(5);\n\t}\n\n\tif (riommu_active) {\n\t\t\n\t\tREG_UPDATE(DCHVM_RIOMMU_CTRL0, HOSTVM_POWERSTATUS, 1);\n\n\t\t\n\t\tREG_UPDATE(DCHVM_RIOMMU_CTRL0, HOSTVM_PREFETCH_REQ, 1);\n\n\t\t\n\t\tREG_UPDATE_4(DCHVM_CLK_CTRL,\n\t\t\t\t\t\tHVM_DISPCLK_R_GATE_DIS, 0,\n\t\t\t\t\t\tHVM_DISPCLK_G_GATE_DIS, 0,\n\t\t\t\t\t\tHVM_DCFCLK_R_GATE_DIS, 0,\n\t\t\t\t\t\tHVM_DCFCLK_G_GATE_DIS, 0);\n\n\t\t\n\t\tREG_WAIT(DCHVM_RIOMMU_STAT0, HOSTVM_PREFETCH_DONE, 1, 5, 100);\n\n\t\thubbub->riommu_active = true;\n\t}\n}\n\nint hubbub21_init_dchub(struct hubbub *hubbub,\n\t\tstruct dcn_hubbub_phys_addr_config *pa_config)\n{\n\tstruct dcn20_hubbub *hubbub1 = TO_DCN20_HUBBUB(hubbub);\n\tstruct dcn_vmid_page_table_config phys_config;\n\n\tREG_SET(DCN_VM_FB_LOCATION_BASE, 0,\n\t\t\tFB_BASE, pa_config->system_aperture.fb_base >> 24);\n\tREG_SET(DCN_VM_FB_LOCATION_TOP, 0,\n\t\t\tFB_TOP, pa_config->system_aperture.fb_top >> 24);\n\tREG_SET(DCN_VM_FB_OFFSET, 0,\n\t\t\tFB_OFFSET, pa_config->system_aperture.fb_offset >> 24);\n\tREG_SET(DCN_VM_AGP_BOT, 0,\n\t\t\tAGP_BOT, pa_config->system_aperture.agp_bot >> 24);\n\tREG_SET(DCN_VM_AGP_TOP, 0,\n\t\t\tAGP_TOP, pa_config->system_aperture.agp_top >> 24);\n\tREG_SET(DCN_VM_AGP_BASE, 0,\n\t\t\tAGP_BASE, pa_config->system_aperture.agp_base >> 24);\n\n\tif (pa_config->gart_config.page_table_start_addr != pa_config->gart_config.page_table_end_addr) {\n\t\tphys_config.page_table_start_addr = pa_config->gart_config.page_table_start_addr >> 12;\n\t\tphys_config.page_table_end_addr = pa_config->gart_config.page_table_end_addr >> 12;\n\t\tphys_config.page_table_base_addr = pa_config->gart_config.page_table_base_addr | 1; \n\t\tphys_config.depth = 0;\n\t\tphys_config.block_size = 0;\n\t\t\n\t\tdcn20_vmid_setup(&hubbub1->vmid[0], &phys_config);\n\t}\n\n\tdcn21_dchvm_init(hubbub);\n\n\treturn hubbub1->num_vmid;\n}\n\nbool hubbub21_program_urgent_watermarks(\n\t\tstruct hubbub *hubbub,\n\t\tstruct dcn_watermark_set *watermarks,\n\t\tunsigned int refclk_mhz,\n\t\tbool safe_to_lower)\n{\n\tstruct dcn20_hubbub *hubbub1 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t prog_wm_value;\n\tbool wm_pending = false;\n\n\t \n\t \n\tif (safe_to_lower || watermarks->a.urgent_ns > hubbub1->watermarks.a.urgent_ns) {\n\t\thubbub1->watermarks.a.urgent_ns = watermarks->a.urgent_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->a.urgent_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_URGENCY_WATERMARK_A, prog_wm_value);\n\n\t\tDC_LOG_BANDWIDTH_CALCS(\"URGENCY_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->a.urgent_ns, prog_wm_value);\n\t} else if (watermarks->a.urgent_ns < hubbub1->watermarks.a.urgent_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->a.frac_urg_bw_flip\n\t\t\t> hubbub1->watermarks.a.frac_urg_bw_flip) {\n\t\thubbub1->watermarks.a.frac_urg_bw_flip = watermarks->a.frac_urg_bw_flip;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_A, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_FLIP_A, watermarks->a.frac_urg_bw_flip);\n\t} else if (watermarks->a.frac_urg_bw_flip\n\t\t\t< hubbub1->watermarks.a.frac_urg_bw_flip)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->a.frac_urg_bw_nom\n\t\t\t> hubbub1->watermarks.a.frac_urg_bw_nom) {\n\t\thubbub1->watermarks.a.frac_urg_bw_nom = watermarks->a.frac_urg_bw_nom;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_NOM_A, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_NOM_A, watermarks->a.frac_urg_bw_nom);\n\t} else if (watermarks->a.frac_urg_bw_nom\n\t\t\t< hubbub1->watermarks.a.frac_urg_bw_nom)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->a.urgent_latency_ns > hubbub1->watermarks.a.urgent_latency_ns) {\n\t\thubbub1->watermarks.a.urgent_latency_ns = watermarks->a.urgent_latency_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->a.urgent_latency_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_A, 0,\n\t\t\t\tDCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_A, prog_wm_value);\n\t} else if (watermarks->a.urgent_latency_ns < hubbub1->watermarks.a.urgent_latency_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->b.urgent_ns > hubbub1->watermarks.b.urgent_ns) {\n\t\thubbub1->watermarks.b.urgent_ns = watermarks->b.urgent_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->b.urgent_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_B, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_URGENCY_WATERMARK_B, prog_wm_value);\n\n\t\tDC_LOG_BANDWIDTH_CALCS(\"URGENCY_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->b.urgent_ns, prog_wm_value);\n\t} else if (watermarks->b.urgent_ns < hubbub1->watermarks.b.urgent_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->a.frac_urg_bw_flip\n\t\t\t> hubbub1->watermarks.a.frac_urg_bw_flip) {\n\t\thubbub1->watermarks.a.frac_urg_bw_flip = watermarks->a.frac_urg_bw_flip;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_B, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_FLIP_B, watermarks->a.frac_urg_bw_flip);\n\t} else if (watermarks->a.frac_urg_bw_flip\n\t\t\t< hubbub1->watermarks.a.frac_urg_bw_flip)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->a.frac_urg_bw_nom\n\t\t\t> hubbub1->watermarks.a.frac_urg_bw_nom) {\n\t\thubbub1->watermarks.a.frac_urg_bw_nom = watermarks->a.frac_urg_bw_nom;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_NOM_B, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_NOM_B, watermarks->a.frac_urg_bw_nom);\n\t} else if (watermarks->a.frac_urg_bw_nom\n\t\t\t< hubbub1->watermarks.a.frac_urg_bw_nom)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->b.urgent_latency_ns > hubbub1->watermarks.b.urgent_latency_ns) {\n\t\thubbub1->watermarks.b.urgent_latency_ns = watermarks->b.urgent_latency_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->b.urgent_latency_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_B, 0,\n\t\t\t\tDCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_B, prog_wm_value);\n\t} else if (watermarks->b.urgent_latency_ns < hubbub1->watermarks.b.urgent_latency_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->c.urgent_ns > hubbub1->watermarks.c.urgent_ns) {\n\t\thubbub1->watermarks.c.urgent_ns = watermarks->c.urgent_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->c.urgent_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_C, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_URGENCY_WATERMARK_C, prog_wm_value);\n\n\t\tDC_LOG_BANDWIDTH_CALCS(\"URGENCY_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->c.urgent_ns, prog_wm_value);\n\t} else if (watermarks->c.urgent_ns < hubbub1->watermarks.c.urgent_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->a.frac_urg_bw_flip\n\t\t\t> hubbub1->watermarks.a.frac_urg_bw_flip) {\n\t\thubbub1->watermarks.a.frac_urg_bw_flip = watermarks->a.frac_urg_bw_flip;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_C, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_FLIP_C, watermarks->a.frac_urg_bw_flip);\n\t} else if (watermarks->a.frac_urg_bw_flip\n\t\t\t< hubbub1->watermarks.a.frac_urg_bw_flip)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->a.frac_urg_bw_nom\n\t\t\t> hubbub1->watermarks.a.frac_urg_bw_nom) {\n\t\thubbub1->watermarks.a.frac_urg_bw_nom = watermarks->a.frac_urg_bw_nom;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_NOM_C, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_NOM_C, watermarks->a.frac_urg_bw_nom);\n\t} else if (watermarks->a.frac_urg_bw_nom\n\t\t\t< hubbub1->watermarks.a.frac_urg_bw_nom)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->c.urgent_latency_ns > hubbub1->watermarks.c.urgent_latency_ns) {\n\t\thubbub1->watermarks.c.urgent_latency_ns = watermarks->c.urgent_latency_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->c.urgent_latency_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_C, 0,\n\t\t\t\tDCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_C, prog_wm_value);\n\t} else if (watermarks->c.urgent_latency_ns < hubbub1->watermarks.c.urgent_latency_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->d.urgent_ns > hubbub1->watermarks.d.urgent_ns) {\n\t\thubbub1->watermarks.d.urgent_ns = watermarks->d.urgent_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->d.urgent_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_D, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_URGENCY_WATERMARK_D, prog_wm_value);\n\n\t\tDC_LOG_BANDWIDTH_CALCS(\"URGENCY_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->d.urgent_ns, prog_wm_value);\n\t} else if (watermarks->d.urgent_ns < hubbub1->watermarks.d.urgent_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->a.frac_urg_bw_flip\n\t\t\t> hubbub1->watermarks.a.frac_urg_bw_flip) {\n\t\thubbub1->watermarks.a.frac_urg_bw_flip = watermarks->a.frac_urg_bw_flip;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_D, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_FLIP_D, watermarks->a.frac_urg_bw_flip);\n\t} else if (watermarks->a.frac_urg_bw_flip\n\t\t\t< hubbub1->watermarks.a.frac_urg_bw_flip)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->a.frac_urg_bw_nom\n\t\t\t> hubbub1->watermarks.a.frac_urg_bw_nom) {\n\t\thubbub1->watermarks.a.frac_urg_bw_nom = watermarks->a.frac_urg_bw_nom;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_NOM_D, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_NOM_D, watermarks->a.frac_urg_bw_nom);\n\t} else if (watermarks->a.frac_urg_bw_nom\n\t\t\t< hubbub1->watermarks.a.frac_urg_bw_nom)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->d.urgent_latency_ns > hubbub1->watermarks.d.urgent_latency_ns) {\n\t\thubbub1->watermarks.d.urgent_latency_ns = watermarks->d.urgent_latency_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->d.urgent_latency_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_D, 0,\n\t\t\t\tDCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_D, prog_wm_value);\n\t} else if (watermarks->d.urgent_latency_ns < hubbub1->watermarks.d.urgent_latency_ns)\n\t\twm_pending = true;\n\n\treturn wm_pending;\n}\n\nbool hubbub21_program_stutter_watermarks(\n\t\tstruct hubbub *hubbub,\n\t\tstruct dcn_watermark_set *watermarks,\n\t\tunsigned int refclk_mhz,\n\t\tbool safe_to_lower)\n{\n\tstruct dcn20_hubbub *hubbub1 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t prog_wm_value;\n\tbool wm_pending = false;\n\n\t \n\tif (safe_to_lower || watermarks->a.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t> hubbub1->watermarks.a.cstate_pstate.cstate_enter_plus_exit_ns) {\n\t\thubbub1->watermarks.a.cstate_pstate.cstate_enter_plus_exit_ns =\n\t\t\t\twatermarks->a.cstate_pstate.cstate_enter_plus_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->a.cstate_pstate.cstate_enter_plus_exit_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_A, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_SR_ENTER_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_ENTER_EXIT_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->a.cstate_pstate.cstate_enter_plus_exit_ns, prog_wm_value);\n\t} else if (watermarks->a.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t< hubbub1->watermarks.a.cstate_pstate.cstate_enter_plus_exit_ns)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->a.cstate_pstate.cstate_exit_ns\n\t\t\t> hubbub1->watermarks.a.cstate_pstate.cstate_exit_ns) {\n\t\thubbub1->watermarks.a.cstate_pstate.cstate_exit_ns =\n\t\t\t\twatermarks->a.cstate_pstate.cstate_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->a.cstate_pstate.cstate_exit_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_A, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_SR_EXIT_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_EXIT_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->a.cstate_pstate.cstate_exit_ns, prog_wm_value);\n\t} else if (watermarks->a.cstate_pstate.cstate_exit_ns\n\t\t\t< hubbub1->watermarks.a.cstate_pstate.cstate_exit_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->b.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t> hubbub1->watermarks.b.cstate_pstate.cstate_enter_plus_exit_ns) {\n\t\thubbub1->watermarks.b.cstate_pstate.cstate_enter_plus_exit_ns =\n\t\t\t\twatermarks->b.cstate_pstate.cstate_enter_plus_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->b.cstate_pstate.cstate_enter_plus_exit_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_B, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_SR_ENTER_WATERMARK_B, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_ENTER_EXIT_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->b.cstate_pstate.cstate_enter_plus_exit_ns, prog_wm_value);\n\t} else if (watermarks->b.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t< hubbub1->watermarks.b.cstate_pstate.cstate_enter_plus_exit_ns)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->b.cstate_pstate.cstate_exit_ns\n\t\t\t> hubbub1->watermarks.b.cstate_pstate.cstate_exit_ns) {\n\t\thubbub1->watermarks.b.cstate_pstate.cstate_exit_ns =\n\t\t\t\twatermarks->b.cstate_pstate.cstate_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->b.cstate_pstate.cstate_exit_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_B, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_SR_EXIT_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_EXIT_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->b.cstate_pstate.cstate_exit_ns, prog_wm_value);\n\t} else if (watermarks->b.cstate_pstate.cstate_exit_ns\n\t\t\t< hubbub1->watermarks.b.cstate_pstate.cstate_exit_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->c.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t> hubbub1->watermarks.c.cstate_pstate.cstate_enter_plus_exit_ns) {\n\t\thubbub1->watermarks.c.cstate_pstate.cstate_enter_plus_exit_ns =\n\t\t\t\twatermarks->c.cstate_pstate.cstate_enter_plus_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->c.cstate_pstate.cstate_enter_plus_exit_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_C, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_SR_ENTER_WATERMARK_C, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_ENTER_EXIT_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->c.cstate_pstate.cstate_enter_plus_exit_ns, prog_wm_value);\n\t} else if (watermarks->c.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t< hubbub1->watermarks.c.cstate_pstate.cstate_enter_plus_exit_ns)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->c.cstate_pstate.cstate_exit_ns\n\t\t\t> hubbub1->watermarks.c.cstate_pstate.cstate_exit_ns) {\n\t\thubbub1->watermarks.c.cstate_pstate.cstate_exit_ns =\n\t\t\t\twatermarks->c.cstate_pstate.cstate_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->c.cstate_pstate.cstate_exit_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_C, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_SR_EXIT_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_EXIT_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->c.cstate_pstate.cstate_exit_ns, prog_wm_value);\n\t} else if (watermarks->c.cstate_pstate.cstate_exit_ns\n\t\t\t< hubbub1->watermarks.c.cstate_pstate.cstate_exit_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->d.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t> hubbub1->watermarks.d.cstate_pstate.cstate_enter_plus_exit_ns) {\n\t\thubbub1->watermarks.d.cstate_pstate.cstate_enter_plus_exit_ns =\n\t\t\t\twatermarks->d.cstate_pstate.cstate_enter_plus_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->d.cstate_pstate.cstate_enter_plus_exit_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_D, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_SR_ENTER_WATERMARK_D, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_ENTER_EXIT_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->d.cstate_pstate.cstate_enter_plus_exit_ns, prog_wm_value);\n\t} else if (watermarks->d.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t< hubbub1->watermarks.d.cstate_pstate.cstate_enter_plus_exit_ns)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->d.cstate_pstate.cstate_exit_ns\n\t\t\t> hubbub1->watermarks.d.cstate_pstate.cstate_exit_ns) {\n\t\thubbub1->watermarks.d.cstate_pstate.cstate_exit_ns =\n\t\t\t\twatermarks->d.cstate_pstate.cstate_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->d.cstate_pstate.cstate_exit_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_D, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_SR_EXIT_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_EXIT_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->d.cstate_pstate.cstate_exit_ns, prog_wm_value);\n\t} else if (watermarks->d.cstate_pstate.cstate_exit_ns\n\t\t\t< hubbub1->watermarks.d.cstate_pstate.cstate_exit_ns)\n\t\twm_pending = true;\n\n\treturn wm_pending;\n}\n\nbool hubbub21_program_pstate_watermarks(\n\t\tstruct hubbub *hubbub,\n\t\tstruct dcn_watermark_set *watermarks,\n\t\tunsigned int refclk_mhz,\n\t\tbool safe_to_lower)\n{\n\tstruct dcn20_hubbub *hubbub1 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t prog_wm_value;\n\n\tbool wm_pending = false;\n\n\t \n\tif (safe_to_lower || watermarks->a.cstate_pstate.pstate_change_ns\n\t\t\t> hubbub1->watermarks.a.cstate_pstate.pstate_change_ns) {\n\t\thubbub1->watermarks.a.cstate_pstate.pstate_change_ns =\n\t\t\t\twatermarks->a.cstate_pstate.pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->a.cstate_pstate.pstate_change_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_A, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_DRAM_CLK_CHANGE_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"DRAM_CLK_CHANGE_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->a.cstate_pstate.pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->a.cstate_pstate.pstate_change_ns\n\t\t\t< hubbub1->watermarks.a.cstate_pstate.pstate_change_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->b.cstate_pstate.pstate_change_ns\n\t\t\t> hubbub1->watermarks.b.cstate_pstate.pstate_change_ns) {\n\t\thubbub1->watermarks.b.cstate_pstate.pstate_change_ns =\n\t\t\t\twatermarks->b.cstate_pstate.pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->b.cstate_pstate.pstate_change_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_B, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_DRAM_CLK_CHANGE_WATERMARK_B, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"DRAM_CLK_CHANGE_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->b.cstate_pstate.pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->b.cstate_pstate.pstate_change_ns\n\t\t\t< hubbub1->watermarks.b.cstate_pstate.pstate_change_ns)\n\t\twm_pending = false;\n\n\t \n\tif (safe_to_lower || watermarks->c.cstate_pstate.pstate_change_ns\n\t\t\t> hubbub1->watermarks.c.cstate_pstate.pstate_change_ns) {\n\t\thubbub1->watermarks.c.cstate_pstate.pstate_change_ns =\n\t\t\t\twatermarks->c.cstate_pstate.pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->c.cstate_pstate.pstate_change_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_C, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_DRAM_CLK_CHANGE_WATERMARK_C, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"DRAM_CLK_CHANGE_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->c.cstate_pstate.pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->c.cstate_pstate.pstate_change_ns\n\t\t\t< hubbub1->watermarks.c.cstate_pstate.pstate_change_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->d.cstate_pstate.pstate_change_ns\n\t\t\t> hubbub1->watermarks.d.cstate_pstate.pstate_change_ns) {\n\t\thubbub1->watermarks.d.cstate_pstate.pstate_change_ns =\n\t\t\t\twatermarks->d.cstate_pstate.pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->d.cstate_pstate.pstate_change_ns,\n\t\t\t\trefclk_mhz, 0x1fffff);\n\t\tREG_SET_2(DCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_D, prog_wm_value,\n\t\t\t\tDCHUBBUB_ARB_VM_ROW_ALLOW_DRAM_CLK_CHANGE_WATERMARK_D, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"DRAM_CLK_CHANGE_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->d.cstate_pstate.pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->d.cstate_pstate.pstate_change_ns\n\t\t\t< hubbub1->watermarks.d.cstate_pstate.pstate_change_ns)\n\t\twm_pending = true;\n\n\treturn wm_pending;\n}\n\nbool hubbub21_program_watermarks(\n\t\tstruct hubbub *hubbub,\n\t\tstruct dcn_watermark_set *watermarks,\n\t\tunsigned int refclk_mhz,\n\t\tbool safe_to_lower)\n{\n\tstruct dcn20_hubbub *hubbub1 = TO_DCN20_HUBBUB(hubbub);\n\tbool wm_pending = false;\n\n\tif (hubbub21_program_urgent_watermarks(hubbub, watermarks, refclk_mhz, safe_to_lower))\n\t\twm_pending = true;\n\n\tif (hubbub21_program_stutter_watermarks(hubbub, watermarks, refclk_mhz, safe_to_lower))\n\t\twm_pending = true;\n\n\tif (hubbub21_program_pstate_watermarks(hubbub, watermarks, refclk_mhz, safe_to_lower))\n\t\twm_pending = true;\n\n\t \n\tREG_SET(DCHUBBUB_ARB_SAT_LEVEL, 0,\n\t\t\tDCHUBBUB_ARB_SAT_LEVEL, 60 * refclk_mhz);\n\tREG_UPDATE_2(DCHUBBUB_ARB_DF_REQ_OUTSTAND,\n\t\t\tDCHUBBUB_ARB_MIN_REQ_OUTSTAND, 0x1FF,\n\t\t\tDCHUBBUB_ARB_MIN_REQ_OUTSTAND_COMMIT_THRESHOLD, 0xA);\n\tREG_UPDATE(DCHUBBUB_ARB_HOSTVM_CNTL,\n\t\t\tDCHUBBUB_ARB_MAX_QOS_COMMIT_THRESHOLD, 0xF);\n\n\thubbub1_allow_self_refresh_control(hubbub, !hubbub->ctx->dc->debug.disable_stutter);\n\n\treturn wm_pending;\n}\n\nvoid hubbub21_wm_read_state(struct hubbub *hubbub,\n\t\tstruct dcn_hubbub_wm *wm)\n{\n\tstruct dcn20_hubbub *hubbub1 = TO_DCN20_HUBBUB(hubbub);\n\tstruct dcn_hubbub_wm_set *s;\n\n\tmemset(wm, 0, sizeof(struct dcn_hubbub_wm));\n\n\ts = &wm->sets[0];\n\ts->wm_set = 0;\n\tREG_GET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A,\n\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A, &s->data_urgent);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_A,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_A, &s->sr_enter);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_A,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_A, &s->sr_exit);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_A,\n\t\t\t DCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_A, &s->dram_clk_change);\n\n\ts = &wm->sets[1];\n\ts->wm_set = 1;\n\tREG_GET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_B,\n\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_B, &s->data_urgent);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_B,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_B, &s->sr_enter);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_B,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_B, &s->sr_exit);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_B,\n\t\t\tDCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_B, &s->dram_clk_change);\n\n\ts = &wm->sets[2];\n\ts->wm_set = 2;\n\tREG_GET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_C,\n\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_C, &s->data_urgent);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_C,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_C, &s->sr_enter);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_C,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_C, &s->sr_exit);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_C,\n\t\t\tDCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_C, &s->dram_clk_change);\n\n\ts = &wm->sets[3];\n\ts->wm_set = 3;\n\tREG_GET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_D,\n\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_D, &s->data_urgent);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_D,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_D, &s->sr_enter);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_D,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_D, &s->sr_exit);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_D,\n\t\t\tDCHUBBUB_ARB_ALLOW_DRAM_CLK_CHANGE_WATERMARK_D, &s->dram_clk_change);\n}\n\nstatic void hubbub21_apply_DEDCN21_147_wa(struct hubbub *hubbub)\n{\n\tstruct dcn20_hubbub *hubbub1 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t prog_wm_value;\n\n\tprog_wm_value = REG_READ(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A);\n\tREG_WRITE(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A, prog_wm_value);\n}\n\nstatic const struct hubbub_funcs hubbub21_funcs = {\n\t.update_dchub = hubbub2_update_dchub,\n\t.init_dchub_sys_ctx = hubbub21_init_dchub,\n\t.init_vm_ctx = hubbub2_init_vm_ctx,\n\t.dcc_support_swizzle = hubbub2_dcc_support_swizzle,\n\t.dcc_support_pixel_format = hubbub2_dcc_support_pixel_format,\n\t.get_dcc_compression_cap = hubbub2_get_dcc_compression_cap,\n\t.wm_read_state = hubbub21_wm_read_state,\n\t.get_dchub_ref_freq = hubbub2_get_dchub_ref_freq,\n\t.program_watermarks = hubbub21_program_watermarks,\n\t.allow_self_refresh_control = hubbub1_allow_self_refresh_control,\n\t.apply_DEDCN21_147_wa = hubbub21_apply_DEDCN21_147_wa,\n\t.hubbub_read_state = hubbub2_read_state,\n};\n\nvoid hubbub21_construct(struct dcn20_hubbub *hubbub,\n\tstruct dc_context *ctx,\n\tconst struct dcn_hubbub_registers *hubbub_regs,\n\tconst struct dcn_hubbub_shift *hubbub_shift,\n\tconst struct dcn_hubbub_mask *hubbub_mask)\n{\n\thubbub->base.ctx = ctx;\n\n\thubbub->base.funcs = &hubbub21_funcs;\n\n\thubbub->regs = hubbub_regs;\n\thubbub->shifts = hubbub_shift;\n\thubbub->masks = hubbub_mask;\n\n\thubbub->debug_test_index_pstate = 0xB;\n\thubbub->detile_buf_size = 164 * 1024;  \n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}