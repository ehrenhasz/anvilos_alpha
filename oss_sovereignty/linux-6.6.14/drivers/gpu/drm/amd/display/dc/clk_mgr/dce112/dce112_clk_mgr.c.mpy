{
  "module_name": "dce112_clk_mgr.c",
  "hash_id": "a6a8e29bbcad646145a288690df53f47ab6e3045038f771e54b1babab07e6dd5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/clk_mgr/dce112/dce112_clk_mgr.c",
  "human_readable_source": " \n\n#include \"core_types.h\"\n#include \"clk_mgr_internal.h\"\n\n#include \"dce/dce_11_2_d.h\"\n#include \"dce/dce_11_2_sh_mask.h\"\n#include \"dce100/dce_clk_mgr.h\"\n#include \"dce110/dce110_clk_mgr.h\"\n#include \"dce112_clk_mgr.h\"\n#include \"dal_asic_id.h\"\n\n \n#define SR(reg_name)\\\n\t.reg_name = mm ## reg_name\n\n \n#define SRI(reg_name, block, id)\\\n\t.reg_name = mm ## block ## id ## _ ## reg_name\n\nstatic const struct clk_mgr_registers disp_clk_regs = {\n\t\tCLK_COMMON_REG_LIST_DCE_BASE()\n};\n\nstatic const struct clk_mgr_shift disp_clk_shift = {\n\t\tCLK_COMMON_MASK_SH_LIST_DCE_COMMON_BASE(__SHIFT)\n};\n\nstatic const struct clk_mgr_mask disp_clk_mask = {\n\t\tCLK_COMMON_MASK_SH_LIST_DCE_COMMON_BASE(_MASK)\n};\n\nstatic const struct state_dependent_clocks dce112_max_clks_by_state[] = {\n \n{ .display_clk_khz = 0, .pixel_clk_khz = 0 },\n \n{ .display_clk_khz = 389189, .pixel_clk_khz = 346672 },\n \n{ .display_clk_khz = 459000, .pixel_clk_khz = 400000 },\n \n{ .display_clk_khz = 667000, .pixel_clk_khz = 600000 },\n \n{ .display_clk_khz = 1132000, .pixel_clk_khz = 600000 } };\n\n\n\nint dce112_set_clock(struct clk_mgr *clk_mgr_base, int requested_clk_khz)\n{\n\tstruct clk_mgr_internal *clk_mgr_dce = TO_CLK_MGR_INTERNAL(clk_mgr_base);\n\tstruct bp_set_dce_clock_parameters dce_clk_params;\n\tstruct dc_bios *bp = clk_mgr_base->ctx->dc_bios;\n\tstruct dc *dc = clk_mgr_base->ctx->dc;\n\tstruct dmcu *dmcu = dc->res_pool->dmcu;\n\tint actual_clock = requested_clk_khz;\n\t \n\tmemset(&dce_clk_params, 0, sizeof(dce_clk_params));\n\n\t \n\trequested_clk_khz = max(requested_clk_khz,\n\t\t\t\tclk_mgr_dce->base.dentist_vco_freq_khz / 62);\n\n\tdce_clk_params.target_clock_frequency = requested_clk_khz;\n\tdce_clk_params.pll_id = CLOCK_SOURCE_ID_DFS;\n\tdce_clk_params.clock_type = DCECLOCK_TYPE_DISPLAY_CLOCK;\n\n\tbp->funcs->set_dce_clock(bp, &dce_clk_params);\n\tactual_clock = dce_clk_params.target_clock_frequency;\n\n\t \n\tif (requested_clk_khz == 0)\n\t\tclk_mgr_dce->cur_min_clks_state = DM_PP_CLOCKS_STATE_NOMINAL;\n\n\t \n\t \n\tdce_clk_params.target_clock_frequency = 0;\n\tdce_clk_params.clock_type = DCECLOCK_TYPE_DPREFCLK;\n\n\tif (!((clk_mgr_base->ctx->asic_id.chip_family == FAMILY_AI) &&\n\t       ASICREV_IS_VEGA20_P(clk_mgr_base->ctx->asic_id.hw_internal_rev)))\n\t\tdce_clk_params.flags.USE_GENLOCK_AS_SOURCE_FOR_DPREFCLK =\n\t\t\t(dce_clk_params.pll_id ==\n\t\t\t\t\tCLOCK_SOURCE_COMBO_DISPLAY_PLL0);\n\telse\n\t\tdce_clk_params.flags.USE_GENLOCK_AS_SOURCE_FOR_DPREFCLK = false;\n\n\tbp->funcs->set_dce_clock(bp, &dce_clk_params);\n\n\tif (dmcu && dmcu->funcs->is_dmcu_initialized(dmcu)) {\n\t\tif (clk_mgr_dce->dfs_bypass_disp_clk != actual_clock)\n\t\t\tdmcu->funcs->set_psr_wait_loop(dmcu,\n\t\t\t\t\tactual_clock / 1000 / 7);\n\t}\n\n\tclk_mgr_dce->dfs_bypass_disp_clk = actual_clock;\n\treturn actual_clock;\n}\n\nint dce112_set_dispclk(struct clk_mgr_internal *clk_mgr, int requested_clk_khz)\n{\n\tstruct bp_set_dce_clock_parameters dce_clk_params;\n\tstruct dc_bios *bp = clk_mgr->base.ctx->dc_bios;\n\tstruct dc *dc = clk_mgr->base.ctx->dc;\n\tstruct dmcu *dmcu = dc->res_pool->dmcu;\n\tint actual_clock = requested_clk_khz;\n\t \n\tmemset(&dce_clk_params, 0, sizeof(dce_clk_params));\n\n\t \n\tif (requested_clk_khz > 0)\n\t\trequested_clk_khz = max(requested_clk_khz,\n\t\t\t\tclk_mgr->base.dentist_vco_freq_khz / 62);\n\n\tdce_clk_params.target_clock_frequency = requested_clk_khz;\n\tdce_clk_params.pll_id = CLOCK_SOURCE_ID_DFS;\n\tdce_clk_params.clock_type = DCECLOCK_TYPE_DISPLAY_CLOCK;\n\n\tbp->funcs->set_dce_clock(bp, &dce_clk_params);\n\tactual_clock = dce_clk_params.target_clock_frequency;\n\n\t \n\tif (requested_clk_khz == 0)\n\t\tclk_mgr->cur_min_clks_state = DM_PP_CLOCKS_STATE_NOMINAL;\n\n\n\tif (dmcu && dmcu->funcs->is_dmcu_initialized(dmcu)) {\n\t\tif (clk_mgr->dfs_bypass_disp_clk != actual_clock)\n\t\t\tdmcu->funcs->set_psr_wait_loop(dmcu,\n\t\t\t\t\tactual_clock / 1000 / 7);\n\t}\n\n\tclk_mgr->dfs_bypass_disp_clk = actual_clock;\n\treturn actual_clock;\n\n}\n\nint dce112_set_dprefclk(struct clk_mgr_internal *clk_mgr)\n{\n\tstruct bp_set_dce_clock_parameters dce_clk_params;\n\tstruct dc_bios *bp = clk_mgr->base.ctx->dc_bios;\n\n\tmemset(&dce_clk_params, 0, sizeof(dce_clk_params));\n\n\t \n\t \n\tdce_clk_params.target_clock_frequency = 0;\n\tdce_clk_params.pll_id = CLOCK_SOURCE_ID_DFS;\n\tdce_clk_params.clock_type = DCECLOCK_TYPE_DPREFCLK;\n\tif (!((clk_mgr->base.ctx->asic_id.chip_family == FAMILY_AI) &&\n\t       ASICREV_IS_VEGA20_P(clk_mgr->base.ctx->asic_id.hw_internal_rev)))\n\t\tdce_clk_params.flags.USE_GENLOCK_AS_SOURCE_FOR_DPREFCLK =\n\t\t\t(dce_clk_params.pll_id ==\n\t\t\t\t\tCLOCK_SOURCE_COMBO_DISPLAY_PLL0);\n\telse\n\t\tdce_clk_params.flags.USE_GENLOCK_AS_SOURCE_FOR_DPREFCLK = false;\n\n\tbp->funcs->set_dce_clock(bp, &dce_clk_params);\n\n\t \n\treturn dce_clk_params.target_clock_frequency;\n}\n\nstatic void dce112_update_clocks(struct clk_mgr *clk_mgr_base,\n\t\t\tstruct dc_state *context,\n\t\t\tbool safe_to_lower)\n{\n\tstruct clk_mgr_internal *clk_mgr_dce = TO_CLK_MGR_INTERNAL(clk_mgr_base);\n\tstruct dm_pp_power_level_change_request level_change_req;\n\tint patched_disp_clk = context->bw_ctx.bw.dce.dispclk_khz;\n\n\t \n\tif (!clk_mgr_dce->dfs_bypass_active)\n\t\tpatched_disp_clk = patched_disp_clk * 115 / 100;\n\n\tlevel_change_req.power_level = dce_get_required_clocks_state(clk_mgr_base, context);\n\t \n\tif ((level_change_req.power_level < clk_mgr_dce->cur_min_clks_state && safe_to_lower)\n\t\t\t|| level_change_req.power_level > clk_mgr_dce->cur_min_clks_state) {\n\t\tif (dm_pp_apply_power_level_change_request(clk_mgr_base->ctx, &level_change_req))\n\t\t\tclk_mgr_dce->cur_min_clks_state = level_change_req.power_level;\n\t}\n\n\tif (should_set_clock(safe_to_lower, patched_disp_clk, clk_mgr_base->clks.dispclk_khz)) {\n\t\tpatched_disp_clk = dce112_set_clock(clk_mgr_base, patched_disp_clk);\n\t\tclk_mgr_base->clks.dispclk_khz = patched_disp_clk;\n\t}\n\tdce11_pplib_apply_display_requirements(clk_mgr_base->ctx->dc, context);\n}\n\nstatic struct clk_mgr_funcs dce112_funcs = {\n\t.get_dp_ref_clk_frequency = dce_get_dp_ref_freq_khz,\n\t.update_clocks = dce112_update_clocks\n};\n\nvoid dce112_clk_mgr_construct(\n\t\tstruct dc_context *ctx,\n\t\tstruct clk_mgr_internal *clk_mgr)\n{\n\tdce_clk_mgr_construct(ctx, clk_mgr);\n\n\tmemcpy(clk_mgr->max_clks_by_state,\n\t\tdce112_max_clks_by_state,\n\t\tsizeof(dce112_max_clks_by_state));\n\n\tclk_mgr->regs = &disp_clk_regs;\n\tclk_mgr->clk_mgr_shift = &disp_clk_shift;\n\tclk_mgr->clk_mgr_mask = &disp_clk_mask;\n\tclk_mgr->base.funcs = &dce112_funcs;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}