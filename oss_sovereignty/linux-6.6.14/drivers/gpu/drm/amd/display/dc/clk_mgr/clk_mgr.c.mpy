{
  "module_name": "clk_mgr.c",
  "hash_id": "eabd4bdf69439fff27429f5383fb7ed11ac3832ddbeea33e5e59fdd17dbb1f63",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/clk_mgr/clk_mgr.c",
  "human_readable_source": " \n\n#include <linux/slab.h>\n\n#include \"dal_asic_id.h\"\n#include \"dc_types.h\"\n#include \"dccg.h\"\n#include \"clk_mgr_internal.h\"\n#include \"link.h\"\n\n#include \"dce100/dce_clk_mgr.h\"\n#include \"dce110/dce110_clk_mgr.h\"\n#include \"dce112/dce112_clk_mgr.h\"\n#include \"dce120/dce120_clk_mgr.h\"\n#include \"dce60/dce60_clk_mgr.h\"\n#include \"dcn10/rv1_clk_mgr.h\"\n#include \"dcn10/rv2_clk_mgr.h\"\n#include \"dcn20/dcn20_clk_mgr.h\"\n#include \"dcn21/rn_clk_mgr.h\"\n#include \"dcn201/dcn201_clk_mgr.h\"\n#include \"dcn30/dcn30_clk_mgr.h\"\n#include \"dcn301/vg_clk_mgr.h\"\n#include \"dcn31/dcn31_clk_mgr.h\"\n#include \"dcn314/dcn314_clk_mgr.h\"\n#include \"dcn315/dcn315_clk_mgr.h\"\n#include \"dcn316/dcn316_clk_mgr.h\"\n#include \"dcn32/dcn32_clk_mgr.h\"\n\nint clk_mgr_helper_get_active_display_cnt(\n\t\tstruct dc *dc,\n\t\tstruct dc_state *context)\n{\n\tint i, display_count;\n\n\tdisplay_count = 0;\n\tfor (i = 0; i < context->stream_count; i++) {\n\t\tconst struct dc_stream_state *stream = context->streams[i];\n\n\t\t \n\t\tif (stream->mall_stream_config.type == SUBVP_PHANTOM)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (!stream->dpms_off || stream->signal == SIGNAL_TYPE_VIRTUAL)\n\t\t\tdisplay_count++;\n\t}\n\n\treturn display_count;\n}\n\nint clk_mgr_helper_get_active_plane_cnt(\n\t\tstruct dc *dc,\n\t\tstruct dc_state *context)\n{\n\tint i, total_plane_count;\n\n\ttotal_plane_count = 0;\n\tfor (i = 0; i < context->stream_count; i++) {\n\t\tconst struct dc_stream_status stream_status = context->stream_status[i];\n\n\t\t \n\t\ttotal_plane_count += stream_status.plane_count;\n\t}\n\n\treturn total_plane_count;\n}\n\nvoid clk_mgr_exit_optimized_pwr_state(const struct dc *dc, struct clk_mgr *clk_mgr)\n{\n\tstruct dc_link *edp_links[MAX_NUM_EDP];\n\tstruct dc_link *edp_link = NULL;\n\tint edp_num;\n\tunsigned int panel_inst;\n\n\tdc_get_edp_links(dc, edp_links, &edp_num);\n\tif (dc->hwss.exit_optimized_pwr_state)\n\t\tdc->hwss.exit_optimized_pwr_state(dc, dc->current_state);\n\n\tif (edp_num) {\n\t\tfor (panel_inst = 0; panel_inst < edp_num; panel_inst++) {\n\t\t\tbool allow_active = false;\n\n\t\t\tedp_link = edp_links[panel_inst];\n\t\t\tif (!edp_link->psr_settings.psr_feature_enabled)\n\t\t\t\tcontinue;\n\t\t\tclk_mgr->psr_allow_active_cache = edp_link->psr_settings.psr_allow_active;\n\t\t\tdc->link_srv->edp_set_psr_allow_active(edp_link, &allow_active, false, false, NULL);\n\t\t\tdc->link_srv->edp_set_replay_allow_active(edp_link, &allow_active, false, false, NULL);\n\t\t}\n\t}\n\n}\n\nvoid clk_mgr_optimize_pwr_state(const struct dc *dc, struct clk_mgr *clk_mgr)\n{\n\tstruct dc_link *edp_links[MAX_NUM_EDP];\n\tstruct dc_link *edp_link = NULL;\n\tint edp_num;\n\tunsigned int panel_inst;\n\n\tdc_get_edp_links(dc, edp_links, &edp_num);\n\tif (edp_num) {\n\t\tfor (panel_inst = 0; panel_inst < edp_num; panel_inst++) {\n\t\t\tedp_link = edp_links[panel_inst];\n\t\t\tif (!edp_link->psr_settings.psr_feature_enabled)\n\t\t\t\tcontinue;\n\t\t\tdc->link_srv->edp_set_psr_allow_active(edp_link,\n\t\t\t\t\t&clk_mgr->psr_allow_active_cache, false, false, NULL);\n\t\t\tdc->link_srv->edp_set_replay_allow_active(edp_link,\n\t\t\t\t\t&clk_mgr->psr_allow_active_cache, false, false, NULL);\n\t\t}\n\t}\n\n\tif (dc->hwss.optimize_pwr_state)\n\t\tdc->hwss.optimize_pwr_state(dc, dc->current_state);\n\n}\n\nstruct clk_mgr *dc_clk_mgr_create(struct dc_context *ctx, struct pp_smu_funcs *pp_smu, struct dccg *dccg)\n{\n\tstruct hw_asic_id asic_id = ctx->asic_id;\n\n\tswitch (asic_id.chip_family) {\n#if defined(CONFIG_DRM_AMD_DC_SI)\n\tcase FAMILY_SI: {\n\t\tstruct clk_mgr_internal *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\t\tdce60_clk_mgr_construct(ctx, clk_mgr);\n\t\tdce_clk_mgr_construct(ctx, clk_mgr);\n\t\treturn &clk_mgr->base;\n\t}\n#endif\n\tcase FAMILY_CI:\n\tcase FAMILY_KV: {\n\t\tstruct clk_mgr_internal *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\t\tdce_clk_mgr_construct(ctx, clk_mgr);\n\t\treturn &clk_mgr->base;\n\t}\n\tcase FAMILY_CZ: {\n\t\tstruct clk_mgr_internal *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\t\tdce110_clk_mgr_construct(ctx, clk_mgr);\n\t\treturn &clk_mgr->base;\n\t}\n\tcase FAMILY_VI: {\n\t\tstruct clk_mgr_internal *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\t\tif (ASIC_REV_IS_TONGA_P(asic_id.hw_internal_rev) ||\n\t\t\t\tASIC_REV_IS_FIJI_P(asic_id.hw_internal_rev)) {\n\t\t\tdce_clk_mgr_construct(ctx, clk_mgr);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\tif (ASIC_REV_IS_POLARIS10_P(asic_id.hw_internal_rev) ||\n\t\t\t\tASIC_REV_IS_POLARIS11_M(asic_id.hw_internal_rev) ||\n\t\t\t\tASIC_REV_IS_POLARIS12_V(asic_id.hw_internal_rev)) {\n\t\t\tdce112_clk_mgr_construct(ctx, clk_mgr);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\tif (ASIC_REV_IS_VEGAM(asic_id.hw_internal_rev)) {\n\t\t\tdce112_clk_mgr_construct(ctx, clk_mgr);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\treturn &clk_mgr->base;\n\t}\n\tcase FAMILY_AI: {\n\t\tstruct clk_mgr_internal *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\t\tif (ASICREV_IS_VEGA20_P(asic_id.hw_internal_rev))\n\t\t\tdce121_clk_mgr_construct(ctx, clk_mgr);\n\t\telse\n\t\t\tdce120_clk_mgr_construct(ctx, clk_mgr);\n\t\treturn &clk_mgr->base;\n\t}\n#if defined(CONFIG_DRM_AMD_DC_FP)\n\tcase FAMILY_RV: {\n\t\tstruct clk_mgr_internal *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\n\t\tif (ASICREV_IS_RENOIR(asic_id.hw_internal_rev)) {\n\t\t\trn_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\n\t\tif (ASICREV_IS_GREEN_SARDINE(asic_id.hw_internal_rev)) {\n\t\t\trn_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\tif (ASICREV_IS_RAVEN2(asic_id.hw_internal_rev)) {\n\t\t\trv2_clk_mgr_construct(ctx, clk_mgr, pp_smu);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\tif (ASICREV_IS_RAVEN(asic_id.hw_internal_rev) ||\n\t\t\t\tASICREV_IS_PICASSO(asic_id.hw_internal_rev)) {\n\t\t\trv1_clk_mgr_construct(ctx, clk_mgr, pp_smu);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\treturn &clk_mgr->base;\n\t}\n\tcase FAMILY_NV: {\n\t\tstruct clk_mgr_internal *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\t\tif (ASICREV_IS_SIENNA_CICHLID_P(asic_id.hw_internal_rev)) {\n\t\t\tdcn3_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\tif (ASICREV_IS_DIMGREY_CAVEFISH_P(asic_id.hw_internal_rev)) {\n\t\t\tdcn3_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\tif (ASICREV_IS_BEIGE_GOBY_P(asic_id.hw_internal_rev)) {\n\t\t\tdcn3_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\tif (asic_id.chip_id == DEVICE_ID_NV_13FE) {\n\t\t\tdcn201_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\t\treturn &clk_mgr->base;\n\t\t}\n\t\tdcn20_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\treturn &clk_mgr->base;\n\t}\n\tcase FAMILY_VGH:\n\t\tif (ASICREV_IS_VANGOGH(asic_id.hw_internal_rev)) {\n\t\t\tstruct clk_mgr_vgh *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\t\tif (clk_mgr == NULL) {\n\t\t\t\tBREAK_TO_DEBUGGER();\n\t\t\t\treturn NULL;\n\t\t\t}\n\t\t\tvg_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\t\treturn &clk_mgr->base.base;\n\t\t}\n\t\tbreak;\n\n\tcase FAMILY_YELLOW_CARP: {\n\t\tstruct clk_mgr_dcn31 *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\n\t\tdcn31_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\treturn &clk_mgr->base.base;\n\t}\n\t\tbreak;\n\tcase AMDGPU_FAMILY_GC_10_3_6: {\n\t\tstruct clk_mgr_dcn315 *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\n\t\tdcn315_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\treturn &clk_mgr->base.base;\n\t}\n\t\tbreak;\n\tcase AMDGPU_FAMILY_GC_10_3_7: {\n\t\tstruct clk_mgr_dcn316 *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\n\t\tdcn316_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\treturn &clk_mgr->base.base;\n\t}\n\t\tbreak;\n\tcase AMDGPU_FAMILY_GC_11_0_0: {\n\t    struct clk_mgr_internal *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t    if (clk_mgr == NULL) {\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn NULL;\n\t    }\n\n\t    dcn32_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t    return &clk_mgr->base;\n\t    break;\n\t}\n\n\tcase AMDGPU_FAMILY_GC_11_0_1: {\n\t\tstruct clk_mgr_dcn314 *clk_mgr = kzalloc(sizeof(*clk_mgr), GFP_KERNEL);\n\n\t\tif (clk_mgr == NULL) {\n\t\t\tBREAK_TO_DEBUGGER();\n\t\t\treturn NULL;\n\t\t}\n\n\t\tdcn314_clk_mgr_construct(ctx, clk_mgr, pp_smu, dccg);\n\t\treturn &clk_mgr->base.base;\n\t}\n\tbreak;\n\n#endif  \n\tdefault:\n\t\tASSERT(0);  \n\t\tbreak;\n\t}\n\n\treturn NULL;\n}\n\nvoid dc_destroy_clk_mgr(struct clk_mgr *clk_mgr_base)\n{\n\tstruct clk_mgr_internal *clk_mgr = TO_CLK_MGR_INTERNAL(clk_mgr_base);\n\n#ifdef CONFIG_DRM_AMD_DC_FP\n\tswitch (clk_mgr_base->ctx->asic_id.chip_family) {\n\tcase FAMILY_NV:\n\t\tif (ASICREV_IS_SIENNA_CICHLID_P(clk_mgr_base->ctx->asic_id.hw_internal_rev)) {\n\t\t\tdcn3_clk_mgr_destroy(clk_mgr);\n\t\t} else if (ASICREV_IS_DIMGREY_CAVEFISH_P(clk_mgr_base->ctx->asic_id.hw_internal_rev)) {\n\t\t\tdcn3_clk_mgr_destroy(clk_mgr);\n\t\t}\n\t\tif (ASICREV_IS_BEIGE_GOBY_P(clk_mgr_base->ctx->asic_id.hw_internal_rev)) {\n\t\t\tdcn3_clk_mgr_destroy(clk_mgr);\n\t\t}\n\t\tbreak;\n\n\tcase FAMILY_VGH:\n\t\tif (ASICREV_IS_VANGOGH(clk_mgr_base->ctx->asic_id.hw_internal_rev))\n\t\t\tvg_clk_mgr_destroy(clk_mgr);\n\t\tbreak;\n\n\tcase FAMILY_YELLOW_CARP:\n\t\tdcn31_clk_mgr_destroy(clk_mgr);\n\t\tbreak;\n\n\tcase AMDGPU_FAMILY_GC_10_3_6:\n\t\tdcn315_clk_mgr_destroy(clk_mgr);\n\t\tbreak;\n\n\tcase AMDGPU_FAMILY_GC_10_3_7:\n\t\tdcn316_clk_mgr_destroy(clk_mgr);\n\t\tbreak;\n\n\tcase AMDGPU_FAMILY_GC_11_0_0:\n\t\tdcn32_clk_mgr_destroy(clk_mgr);\n\t\tbreak;\n\n\tcase AMDGPU_FAMILY_GC_11_0_1:\n\t\tdcn314_clk_mgr_destroy(clk_mgr);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n#endif  \n\n\tkfree(clk_mgr);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}