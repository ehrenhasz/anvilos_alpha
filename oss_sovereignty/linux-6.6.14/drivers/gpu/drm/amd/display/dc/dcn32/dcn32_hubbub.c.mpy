{
  "module_name": "dcn32_hubbub.c",
  "hash_id": "800dff67c5e13bc208fb6b1839e6635edf7158f748143c1320959ce39734b54e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn32/dcn32_hubbub.c",
  "human_readable_source": " \n\n\n#include \"dcn30/dcn30_hubbub.h\"\n#include \"dcn32_hubbub.h\"\n#include \"dm_services.h\"\n#include \"reg_helper.h\"\n\n\n#define CTX \\\n\thubbub2->base.ctx\n#define DC_LOGGER \\\n\thubbub2->base.ctx->logger\n#define REG(reg)\\\n\thubbub2->regs->reg\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\thubbub2->shifts->field_name, hubbub2->masks->field_name\n\n \n#define DCN32_CRB_SEGMENT_SIZE_KB 64\n\nstatic void dcn32_init_crb(struct hubbub *hubbub)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\n\tREG_GET(DCHUBBUB_DET0_CTRL, DET0_SIZE_CURRENT,\n\t\t&hubbub2->det0_size);\n\n\tREG_GET(DCHUBBUB_DET1_CTRL, DET1_SIZE_CURRENT,\n\t\t&hubbub2->det1_size);\n\n\tREG_GET(DCHUBBUB_DET2_CTRL, DET2_SIZE_CURRENT,\n\t\t&hubbub2->det2_size);\n\n\tREG_GET(DCHUBBUB_DET3_CTRL, DET3_SIZE_CURRENT,\n\t\t&hubbub2->det3_size);\n\n\tREG_GET(DCHUBBUB_COMPBUF_CTRL, COMPBUF_SIZE_CURRENT,\n\t\t&hubbub2->compbuf_size_segments);\n\n\tREG_SET_2(COMPBUF_RESERVED_SPACE, 0,\n\t\t\tCOMPBUF_RESERVED_SPACE_64B, hubbub2->pixel_chunk_size / 32,\n\t\t\tCOMPBUF_RESERVED_SPACE_ZS, hubbub2->pixel_chunk_size / 128);\n\tREG_UPDATE(DCHUBBUB_DEBUG_CTRL_0, DET_DEPTH, 0x47F);\n}\n\nvoid hubbub32_set_request_limit(struct hubbub *hubbub, int memory_channel_count, int words_per_channel)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\n\tuint32_t request_limit = 3 * memory_channel_count * words_per_channel / 4;\n\n\tASSERT((request_limit & (~0xFFF)) == 0); \n\tASSERT(request_limit > 0); \n\n\tif (request_limit > 0xFFF)\n\t\trequest_limit = 0xFFF;\n\n\tif (request_limit > 0)\n\t\tREG_UPDATE(SDPIF_REQUEST_RATE_LIMIT, SDPIF_REQUEST_RATE_LIMIT, request_limit);\n}\n\n\nvoid dcn32_program_det_size(struct hubbub *hubbub, int hubp_inst, unsigned int det_buffer_size_in_kbyte)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\n\tunsigned int det_size_segments = (det_buffer_size_in_kbyte + DCN32_CRB_SEGMENT_SIZE_KB - 1) / DCN32_CRB_SEGMENT_SIZE_KB;\n\n\tswitch (hubp_inst) {\n\tcase 0:\n\t\tREG_UPDATE(DCHUBBUB_DET0_CTRL,\n\t\t\t\t\tDET0_SIZE, det_size_segments);\n\t\thubbub2->det0_size = det_size_segments;\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE(DCHUBBUB_DET1_CTRL,\n\t\t\t\t\tDET1_SIZE, det_size_segments);\n\t\thubbub2->det1_size = det_size_segments;\n\t\tbreak;\n\tcase 2:\n\t\tREG_UPDATE(DCHUBBUB_DET2_CTRL,\n\t\t\t\t\tDET2_SIZE, det_size_segments);\n\t\thubbub2->det2_size = det_size_segments;\n\t\tbreak;\n\tcase 3:\n\t\tREG_UPDATE(DCHUBBUB_DET3_CTRL,\n\t\t\t\t\tDET3_SIZE, det_size_segments);\n\t\thubbub2->det3_size = det_size_segments;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (hubbub2->det0_size + hubbub2->det1_size + hubbub2->det2_size\n\t\t\t+ hubbub2->det3_size + hubbub2->compbuf_size_segments > hubbub2->crb_size_segs) {\n\t\t \n\t\tDC_LOG_WARNING(\"CRB Config Warning: DET size (%d,%d,%d,%d) + Compbuf size (%d) >  CRB segments (%d)\\n\",\n\t\t\t\t\t\thubbub2->det0_size, hubbub2->det1_size, hubbub2->det2_size, hubbub2->det3_size,\n\t\t\t\t\t\thubbub2->compbuf_size_segments, hubbub2->crb_size_segs);\n\t}\n}\n\nstatic void dcn32_program_compbuf_size(struct hubbub *hubbub, unsigned int compbuf_size_kb, bool safe_to_increase)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\tunsigned int compbuf_size_segments = (compbuf_size_kb + DCN32_CRB_SEGMENT_SIZE_KB - 1) / DCN32_CRB_SEGMENT_SIZE_KB;\n\n\tif (safe_to_increase || compbuf_size_segments <= hubbub2->compbuf_size_segments) {\n\t\tif (compbuf_size_segments > hubbub2->compbuf_size_segments) {\n\t\t\tREG_WAIT(DCHUBBUB_DET0_CTRL, DET0_SIZE_CURRENT, hubbub2->det0_size, 1, 100);\n\t\t\tREG_WAIT(DCHUBBUB_DET1_CTRL, DET1_SIZE_CURRENT, hubbub2->det1_size, 1, 100);\n\t\t\tREG_WAIT(DCHUBBUB_DET2_CTRL, DET2_SIZE_CURRENT, hubbub2->det2_size, 1, 100);\n\t\t\tREG_WAIT(DCHUBBUB_DET3_CTRL, DET3_SIZE_CURRENT, hubbub2->det3_size, 1, 100);\n\t\t}\n\t\t \n\t\tASSERT(hubbub2->det0_size + hubbub2->det1_size + hubbub2->det2_size\n\t\t\t\t+ hubbub2->det3_size + compbuf_size_segments <= hubbub2->crb_size_segs);\n\t\tREG_UPDATE(DCHUBBUB_COMPBUF_CTRL, COMPBUF_SIZE, compbuf_size_segments);\n\t\thubbub2->compbuf_size_segments = compbuf_size_segments;\n\t\tASSERT(REG_GET(DCHUBBUB_COMPBUF_CTRL, CONFIG_ERROR, &compbuf_size_segments) && !compbuf_size_segments);\n\t}\n}\n\nstatic uint32_t convert_and_clamp(\n\tuint32_t wm_ns,\n\tuint32_t refclk_mhz,\n\tuint32_t clamp_value)\n{\n\tuint32_t ret_val = 0;\n\tret_val = wm_ns * refclk_mhz;\n\n\tret_val /= 1000;\n\n\tif (ret_val > clamp_value)\n\t\tret_val = clamp_value;\n\n\treturn ret_val;\n}\n\nbool hubbub32_program_urgent_watermarks(\n\t\tstruct hubbub *hubbub,\n\t\tstruct dcn_watermark_set *watermarks,\n\t\tunsigned int refclk_mhz,\n\t\tbool safe_to_lower)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t prog_wm_value;\n\tbool wm_pending = false;\n\n\t \n\t \n\tif (safe_to_lower || watermarks->a.urgent_ns > hubbub2->watermarks.a.urgent_ns) {\n\t\thubbub2->watermarks.a.urgent_ns = watermarks->a.urgent_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->a.urgent_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A, prog_wm_value);\n\n\t\tDC_LOG_BANDWIDTH_CALCS(\"URGENCY_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->a.urgent_ns, prog_wm_value);\n\t} else if (watermarks->a.urgent_ns < hubbub2->watermarks.a.urgent_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->a.frac_urg_bw_flip\n\t\t\t> hubbub2->watermarks.a.frac_urg_bw_flip) {\n\t\thubbub2->watermarks.a.frac_urg_bw_flip = watermarks->a.frac_urg_bw_flip;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_A, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_FLIP_A, watermarks->a.frac_urg_bw_flip);\n\t} else if (watermarks->a.frac_urg_bw_flip\n\t\t\t< hubbub2->watermarks.a.frac_urg_bw_flip)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->a.frac_urg_bw_nom\n\t\t\t> hubbub2->watermarks.a.frac_urg_bw_nom) {\n\t\thubbub2->watermarks.a.frac_urg_bw_nom = watermarks->a.frac_urg_bw_nom;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_NOM_A, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_NOM_A, watermarks->a.frac_urg_bw_nom);\n\t} else if (watermarks->a.frac_urg_bw_nom\n\t\t\t< hubbub2->watermarks.a.frac_urg_bw_nom)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->a.urgent_latency_ns > hubbub2->watermarks.a.urgent_latency_ns) {\n\t\thubbub2->watermarks.a.urgent_latency_ns = watermarks->a.urgent_latency_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->a.urgent_latency_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_A, 0,\n\t\t\t\tDCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_A, prog_wm_value);\n\t} else if (watermarks->a.urgent_latency_ns < hubbub2->watermarks.a.urgent_latency_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->b.urgent_ns > hubbub2->watermarks.b.urgent_ns) {\n\t\thubbub2->watermarks.b.urgent_ns = watermarks->b.urgent_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->b.urgent_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_B, prog_wm_value);\n\n\t\tDC_LOG_BANDWIDTH_CALCS(\"URGENCY_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->b.urgent_ns, prog_wm_value);\n\t} else if (watermarks->b.urgent_ns < hubbub2->watermarks.b.urgent_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->b.frac_urg_bw_flip\n\t\t\t> hubbub2->watermarks.b.frac_urg_bw_flip) {\n\t\thubbub2->watermarks.b.frac_urg_bw_flip = watermarks->b.frac_urg_bw_flip;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_B, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_FLIP_B, watermarks->b.frac_urg_bw_flip);\n\t} else if (watermarks->b.frac_urg_bw_flip\n\t\t\t< hubbub2->watermarks.b.frac_urg_bw_flip)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->b.frac_urg_bw_nom\n\t\t\t> hubbub2->watermarks.b.frac_urg_bw_nom) {\n\t\thubbub2->watermarks.b.frac_urg_bw_nom = watermarks->b.frac_urg_bw_nom;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_NOM_B, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_NOM_B, watermarks->b.frac_urg_bw_nom);\n\t} else if (watermarks->b.frac_urg_bw_nom\n\t\t\t< hubbub2->watermarks.b.frac_urg_bw_nom)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->b.urgent_latency_ns > hubbub2->watermarks.b.urgent_latency_ns) {\n\t\thubbub2->watermarks.b.urgent_latency_ns = watermarks->b.urgent_latency_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->b.urgent_latency_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_B, 0,\n\t\t\t\tDCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_B, prog_wm_value);\n\t} else if (watermarks->b.urgent_latency_ns < hubbub2->watermarks.b.urgent_latency_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->c.urgent_ns > hubbub2->watermarks.c.urgent_ns) {\n\t\thubbub2->watermarks.c.urgent_ns = watermarks->c.urgent_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->c.urgent_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_C, prog_wm_value);\n\n\t\tDC_LOG_BANDWIDTH_CALCS(\"URGENCY_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->c.urgent_ns, prog_wm_value);\n\t} else if (watermarks->c.urgent_ns < hubbub2->watermarks.c.urgent_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->c.frac_urg_bw_flip\n\t\t\t> hubbub2->watermarks.c.frac_urg_bw_flip) {\n\t\thubbub2->watermarks.c.frac_urg_bw_flip = watermarks->c.frac_urg_bw_flip;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_C, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_FLIP_C, watermarks->c.frac_urg_bw_flip);\n\t} else if (watermarks->c.frac_urg_bw_flip\n\t\t\t< hubbub2->watermarks.c.frac_urg_bw_flip)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->c.frac_urg_bw_nom\n\t\t\t> hubbub2->watermarks.c.frac_urg_bw_nom) {\n\t\thubbub2->watermarks.c.frac_urg_bw_nom = watermarks->c.frac_urg_bw_nom;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_NOM_C, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_NOM_C, watermarks->c.frac_urg_bw_nom);\n\t} else if (watermarks->c.frac_urg_bw_nom\n\t\t\t< hubbub2->watermarks.c.frac_urg_bw_nom)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->c.urgent_latency_ns > hubbub2->watermarks.c.urgent_latency_ns) {\n\t\thubbub2->watermarks.c.urgent_latency_ns = watermarks->c.urgent_latency_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->c.urgent_latency_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_C, 0,\n\t\t\t\tDCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_C, prog_wm_value);\n\t} else if (watermarks->c.urgent_latency_ns < hubbub2->watermarks.c.urgent_latency_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->d.urgent_ns > hubbub2->watermarks.d.urgent_ns) {\n\t\thubbub2->watermarks.d.urgent_ns = watermarks->d.urgent_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->d.urgent_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_D, prog_wm_value);\n\n\t\tDC_LOG_BANDWIDTH_CALCS(\"URGENCY_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->d.urgent_ns, prog_wm_value);\n\t} else if (watermarks->d.urgent_ns < hubbub2->watermarks.d.urgent_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->d.frac_urg_bw_flip\n\t\t\t> hubbub2->watermarks.d.frac_urg_bw_flip) {\n\t\thubbub2->watermarks.d.frac_urg_bw_flip = watermarks->d.frac_urg_bw_flip;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_D, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_FLIP_D, watermarks->d.frac_urg_bw_flip);\n\t} else if (watermarks->d.frac_urg_bw_flip\n\t\t\t< hubbub2->watermarks.d.frac_urg_bw_flip)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->d.frac_urg_bw_nom\n\t\t\t> hubbub2->watermarks.d.frac_urg_bw_nom) {\n\t\thubbub2->watermarks.d.frac_urg_bw_nom = watermarks->d.frac_urg_bw_nom;\n\n\t\tREG_SET(DCHUBBUB_ARB_FRAC_URG_BW_NOM_D, 0,\n\t\t\t\tDCHUBBUB_ARB_FRAC_URG_BW_NOM_D, watermarks->d.frac_urg_bw_nom);\n\t} else if (watermarks->d.frac_urg_bw_nom\n\t\t\t< hubbub2->watermarks.d.frac_urg_bw_nom)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->d.urgent_latency_ns > hubbub2->watermarks.d.urgent_latency_ns) {\n\t\thubbub2->watermarks.d.urgent_latency_ns = watermarks->d.urgent_latency_ns;\n\t\tprog_wm_value = convert_and_clamp(watermarks->d.urgent_latency_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_D, 0,\n\t\t\t\tDCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_D, prog_wm_value);\n\t} else if (watermarks->d.urgent_latency_ns < hubbub2->watermarks.d.urgent_latency_ns)\n\t\twm_pending = true;\n\n\treturn wm_pending;\n}\n\nbool hubbub32_program_stutter_watermarks(\n\t\tstruct hubbub *hubbub,\n\t\tstruct dcn_watermark_set *watermarks,\n\t\tunsigned int refclk_mhz,\n\t\tbool safe_to_lower)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t prog_wm_value;\n\tbool wm_pending = false;\n\n\t \n\tif (safe_to_lower || watermarks->a.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t> hubbub2->watermarks.a.cstate_pstate.cstate_enter_plus_exit_ns) {\n\t\thubbub2->watermarks.a.cstate_pstate.cstate_enter_plus_exit_ns =\n\t\t\t\twatermarks->a.cstate_pstate.cstate_enter_plus_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->a.cstate_pstate.cstate_enter_plus_exit_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_ENTER_EXIT_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->a.cstate_pstate.cstate_enter_plus_exit_ns, prog_wm_value);\n\t} else if (watermarks->a.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t< hubbub2->watermarks.a.cstate_pstate.cstate_enter_plus_exit_ns)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->a.cstate_pstate.cstate_exit_ns\n\t\t\t> hubbub2->watermarks.a.cstate_pstate.cstate_exit_ns) {\n\t\thubbub2->watermarks.a.cstate_pstate.cstate_exit_ns =\n\t\t\t\twatermarks->a.cstate_pstate.cstate_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->a.cstate_pstate.cstate_exit_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_EXIT_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->a.cstate_pstate.cstate_exit_ns, prog_wm_value);\n\t} else if (watermarks->a.cstate_pstate.cstate_exit_ns\n\t\t\t< hubbub2->watermarks.a.cstate_pstate.cstate_exit_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->b.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t> hubbub2->watermarks.b.cstate_pstate.cstate_enter_plus_exit_ns) {\n\t\thubbub2->watermarks.b.cstate_pstate.cstate_enter_plus_exit_ns =\n\t\t\t\twatermarks->b.cstate_pstate.cstate_enter_plus_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->b.cstate_pstate.cstate_enter_plus_exit_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_B, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_ENTER_EXIT_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->b.cstate_pstate.cstate_enter_plus_exit_ns, prog_wm_value);\n\t} else if (watermarks->b.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t< hubbub2->watermarks.b.cstate_pstate.cstate_enter_plus_exit_ns)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->b.cstate_pstate.cstate_exit_ns\n\t\t\t> hubbub2->watermarks.b.cstate_pstate.cstate_exit_ns) {\n\t\thubbub2->watermarks.b.cstate_pstate.cstate_exit_ns =\n\t\t\t\twatermarks->b.cstate_pstate.cstate_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->b.cstate_pstate.cstate_exit_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_B, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_EXIT_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->b.cstate_pstate.cstate_exit_ns, prog_wm_value);\n\t} else if (watermarks->b.cstate_pstate.cstate_exit_ns\n\t\t\t< hubbub2->watermarks.b.cstate_pstate.cstate_exit_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->c.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t> hubbub2->watermarks.c.cstate_pstate.cstate_enter_plus_exit_ns) {\n\t\thubbub2->watermarks.c.cstate_pstate.cstate_enter_plus_exit_ns =\n\t\t\t\twatermarks->c.cstate_pstate.cstate_enter_plus_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->c.cstate_pstate.cstate_enter_plus_exit_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_C, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_ENTER_EXIT_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->c.cstate_pstate.cstate_enter_plus_exit_ns, prog_wm_value);\n\t} else if (watermarks->c.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t< hubbub2->watermarks.c.cstate_pstate.cstate_enter_plus_exit_ns)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->c.cstate_pstate.cstate_exit_ns\n\t\t\t> hubbub2->watermarks.c.cstate_pstate.cstate_exit_ns) {\n\t\thubbub2->watermarks.c.cstate_pstate.cstate_exit_ns =\n\t\t\t\twatermarks->c.cstate_pstate.cstate_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->c.cstate_pstate.cstate_exit_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_C, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_EXIT_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->c.cstate_pstate.cstate_exit_ns, prog_wm_value);\n\t} else if (watermarks->c.cstate_pstate.cstate_exit_ns\n\t\t\t< hubbub2->watermarks.c.cstate_pstate.cstate_exit_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->d.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t> hubbub2->watermarks.d.cstate_pstate.cstate_enter_plus_exit_ns) {\n\t\thubbub2->watermarks.d.cstate_pstate.cstate_enter_plus_exit_ns =\n\t\t\t\twatermarks->d.cstate_pstate.cstate_enter_plus_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->d.cstate_pstate.cstate_enter_plus_exit_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_D, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_ENTER_EXIT_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->d.cstate_pstate.cstate_enter_plus_exit_ns, prog_wm_value);\n\t} else if (watermarks->d.cstate_pstate.cstate_enter_plus_exit_ns\n\t\t\t< hubbub2->watermarks.d.cstate_pstate.cstate_enter_plus_exit_ns)\n\t\twm_pending = true;\n\n\tif (safe_to_lower || watermarks->d.cstate_pstate.cstate_exit_ns\n\t\t\t> hubbub2->watermarks.d.cstate_pstate.cstate_exit_ns) {\n\t\thubbub2->watermarks.d.cstate_pstate.cstate_exit_ns =\n\t\t\t\twatermarks->d.cstate_pstate.cstate_exit_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->d.cstate_pstate.cstate_exit_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_D, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"SR_EXIT_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\",\n\t\t\twatermarks->d.cstate_pstate.cstate_exit_ns, prog_wm_value);\n\t} else if (watermarks->d.cstate_pstate.cstate_exit_ns\n\t\t\t< hubbub2->watermarks.d.cstate_pstate.cstate_exit_ns)\n\t\twm_pending = true;\n\n\treturn wm_pending;\n}\n\n\nbool hubbub32_program_pstate_watermarks(\n\t\tstruct hubbub *hubbub,\n\t\tstruct dcn_watermark_set *watermarks,\n\t\tunsigned int refclk_mhz,\n\t\tbool safe_to_lower)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t prog_wm_value;\n\n\tbool wm_pending = false;\n\n\t \n\t \n\tif (safe_to_lower || watermarks->a.cstate_pstate.pstate_change_ns\n\t\t\t> hubbub2->watermarks.a.cstate_pstate.pstate_change_ns) {\n\t\thubbub2->watermarks.a.cstate_pstate.pstate_change_ns =\n\t\t\t\twatermarks->a.cstate_pstate.pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->a.cstate_pstate.pstate_change_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"DRAM_CLK_CHANGE_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->a.cstate_pstate.pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->a.cstate_pstate.pstate_change_ns\n\t\t\t< hubbub2->watermarks.a.cstate_pstate.pstate_change_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->b.cstate_pstate.pstate_change_ns\n\t\t\t> hubbub2->watermarks.b.cstate_pstate.pstate_change_ns) {\n\t\thubbub2->watermarks.b.cstate_pstate.pstate_change_ns =\n\t\t\t\twatermarks->b.cstate_pstate.pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->b.cstate_pstate.pstate_change_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_B, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"DRAM_CLK_CHANGE_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->b.cstate_pstate.pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->b.cstate_pstate.pstate_change_ns\n\t\t\t< hubbub2->watermarks.b.cstate_pstate.pstate_change_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->c.cstate_pstate.pstate_change_ns\n\t\t\t> hubbub2->watermarks.c.cstate_pstate.pstate_change_ns) {\n\t\thubbub2->watermarks.c.cstate_pstate.pstate_change_ns =\n\t\t\t\twatermarks->c.cstate_pstate.pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->c.cstate_pstate.pstate_change_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_C, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"DRAM_CLK_CHANGE_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->c.cstate_pstate.pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->c.cstate_pstate.pstate_change_ns\n\t\t\t< hubbub2->watermarks.c.cstate_pstate.pstate_change_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->d.cstate_pstate.pstate_change_ns\n\t\t\t> hubbub2->watermarks.d.cstate_pstate.pstate_change_ns) {\n\t\thubbub2->watermarks.d.cstate_pstate.pstate_change_ns =\n\t\t\t\twatermarks->d.cstate_pstate.pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->d.cstate_pstate.pstate_change_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_D, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"DRAM_CLK_CHANGE_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->d.cstate_pstate.pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->d.cstate_pstate.pstate_change_ns\n\t\t\t< hubbub2->watermarks.d.cstate_pstate.pstate_change_ns)\n\t\twm_pending = true;\n\n\t \n\t \n\tif (safe_to_lower || watermarks->a.cstate_pstate.fclk_pstate_change_ns\n\t\t\t> hubbub2->watermarks.a.cstate_pstate.fclk_pstate_change_ns) {\n\t\thubbub2->watermarks.a.cstate_pstate.fclk_pstate_change_ns =\n\t\t\t\twatermarks->a.cstate_pstate.fclk_pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->a.cstate_pstate.fclk_pstate_change_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"FCLK_CHANGE_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->a.cstate_pstate.fclk_pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->a.cstate_pstate.fclk_pstate_change_ns\n\t\t\t< hubbub2->watermarks.a.cstate_pstate.fclk_pstate_change_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->b.cstate_pstate.fclk_pstate_change_ns\n\t\t\t> hubbub2->watermarks.b.cstate_pstate.fclk_pstate_change_ns) {\n\t\thubbub2->watermarks.b.cstate_pstate.fclk_pstate_change_ns =\n\t\t\t\twatermarks->b.cstate_pstate.fclk_pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->b.cstate_pstate.fclk_pstate_change_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_B, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"FCLK_CHANGE_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->b.cstate_pstate.fclk_pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->b.cstate_pstate.fclk_pstate_change_ns\n\t\t\t< hubbub2->watermarks.b.cstate_pstate.fclk_pstate_change_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->c.cstate_pstate.fclk_pstate_change_ns\n\t\t\t> hubbub2->watermarks.c.cstate_pstate.fclk_pstate_change_ns) {\n\t\thubbub2->watermarks.c.cstate_pstate.fclk_pstate_change_ns =\n\t\t\t\twatermarks->c.cstate_pstate.fclk_pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->c.cstate_pstate.fclk_pstate_change_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_C, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"FCLK_CHANGE_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->c.cstate_pstate.fclk_pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->c.cstate_pstate.fclk_pstate_change_ns\n\t\t\t< hubbub2->watermarks.c.cstate_pstate.fclk_pstate_change_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->d.cstate_pstate.fclk_pstate_change_ns\n\t\t\t> hubbub2->watermarks.d.cstate_pstate.fclk_pstate_change_ns) {\n\t\thubbub2->watermarks.d.cstate_pstate.fclk_pstate_change_ns =\n\t\t\t\twatermarks->d.cstate_pstate.fclk_pstate_change_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->d.cstate_pstate.fclk_pstate_change_ns,\n\t\t\t\trefclk_mhz, 0xffff);\n\t\tREG_SET(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_D, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"FCLK_CHANGE_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->d.cstate_pstate.fclk_pstate_change_ns, prog_wm_value);\n\t} else if (watermarks->d.cstate_pstate.fclk_pstate_change_ns\n\t\t\t< hubbub2->watermarks.d.cstate_pstate.fclk_pstate_change_ns)\n\t\twm_pending = true;\n\n\treturn wm_pending;\n}\n\n\nbool hubbub32_program_usr_watermarks(\n\t\tstruct hubbub *hubbub,\n\t\tstruct dcn_watermark_set *watermarks,\n\t\tunsigned int refclk_mhz,\n\t\tbool safe_to_lower)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t prog_wm_value;\n\n\tbool wm_pending = false;\n\n\t \n\tif (safe_to_lower || watermarks->a.usr_retraining_ns\n\t\t\t> hubbub2->watermarks.a.usr_retraining_ns) {\n\t\thubbub2->watermarks.a.usr_retraining_ns = watermarks->a.usr_retraining_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->a.usr_retraining_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_A, 0,\n\t\t\t\tDCHUBBUB_ARB_USR_RETRAINING_WATERMARK_A, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"USR_RETRAINING_WATERMARK_A calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->a.usr_retraining_ns, prog_wm_value);\n\t} else if (watermarks->a.usr_retraining_ns\n\t\t\t< hubbub2->watermarks.a.usr_retraining_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->b.usr_retraining_ns\n\t\t\t> hubbub2->watermarks.b.usr_retraining_ns) {\n\t\thubbub2->watermarks.b.usr_retraining_ns = watermarks->b.usr_retraining_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->b.usr_retraining_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_B, 0,\n\t\t\t\tDCHUBBUB_ARB_USR_RETRAINING_WATERMARK_B, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"USR_RETRAINING_WATERMARK_B calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->b.usr_retraining_ns, prog_wm_value);\n\t} else if (watermarks->b.usr_retraining_ns\n\t\t\t< hubbub2->watermarks.b.usr_retraining_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->c.usr_retraining_ns\n\t\t\t> hubbub2->watermarks.c.usr_retraining_ns) {\n\t\thubbub2->watermarks.c.usr_retraining_ns =\n\t\t\t\twatermarks->c.usr_retraining_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->c.usr_retraining_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_C, 0,\n\t\t\t\tDCHUBBUB_ARB_USR_RETRAINING_WATERMARK_C, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"USR_RETRAINING_WATERMARK_C calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->c.usr_retraining_ns, prog_wm_value);\n\t} else if (watermarks->c.usr_retraining_ns\n\t\t\t< hubbub2->watermarks.c.usr_retraining_ns)\n\t\twm_pending = true;\n\n\t \n\tif (safe_to_lower || watermarks->d.usr_retraining_ns\n\t\t\t> hubbub2->watermarks.d.usr_retraining_ns) {\n\t\thubbub2->watermarks.d.usr_retraining_ns =\n\t\t\t\twatermarks->d.usr_retraining_ns;\n\t\tprog_wm_value = convert_and_clamp(\n\t\t\t\twatermarks->d.usr_retraining_ns,\n\t\t\t\trefclk_mhz, 0x3fff);\n\t\tREG_SET(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_D, 0,\n\t\t\t\tDCHUBBUB_ARB_USR_RETRAINING_WATERMARK_D, prog_wm_value);\n\t\tDC_LOG_BANDWIDTH_CALCS(\"USR_RETRAINING_WATERMARK_D calculated =%d\\n\"\n\t\t\t\"HW register value = 0x%x\\n\\n\",\n\t\t\twatermarks->d.usr_retraining_ns, prog_wm_value);\n\t} else if (watermarks->d.usr_retraining_ns\n\t\t\t< hubbub2->watermarks.d.usr_retraining_ns)\n\t\twm_pending = true;\n\n\treturn wm_pending;\n}\n\nvoid hubbub32_force_usr_retraining_allow(struct hubbub *hubbub, bool allow)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\n\t \n\n\tREG_UPDATE_2(DCHUBBUB_ARB_USR_RETRAINING_CNTL,\n\t\t\tDCHUBBUB_ARB_ALLOW_USR_RETRAINING_FORCE_VALUE, allow,\n\t\t\tDCHUBBUB_ARB_ALLOW_USR_RETRAINING_FORCE_ENABLE, allow);\n}\n\nstatic bool hubbub32_program_watermarks(\n\t\tstruct hubbub *hubbub,\n\t\tstruct dcn_watermark_set *watermarks,\n\t\tunsigned int refclk_mhz,\n\t\tbool safe_to_lower)\n{\n\tbool wm_pending = false;\n\n\tif (hubbub32_program_urgent_watermarks(hubbub, watermarks, refclk_mhz, safe_to_lower))\n\t\twm_pending = true;\n\n\tif (hubbub32_program_stutter_watermarks(hubbub, watermarks, refclk_mhz, safe_to_lower))\n\t\twm_pending = true;\n\n\tif (hubbub32_program_pstate_watermarks(hubbub, watermarks, refclk_mhz, safe_to_lower))\n\t\twm_pending = true;\n\n\tif (hubbub32_program_usr_watermarks(hubbub, watermarks, refclk_mhz, safe_to_lower))\n\t\twm_pending = true;\n\n\t \n\t \n\n\thubbub1_allow_self_refresh_control(hubbub, !hubbub->ctx->dc->debug.disable_stutter);\n\n\thubbub32_force_usr_retraining_allow(hubbub, hubbub->ctx->dc->debug.force_usr_allow);\n\n\treturn wm_pending;\n}\n\n \nstatic void hubbub32_init_watermarks(struct hubbub *hubbub)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t reg;\n\n\treg = REG_READ(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A);\n\tREG_WRITE(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_B, reg);\n\tREG_WRITE(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_C, reg);\n\tREG_WRITE(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_D, reg);\n\n\treg = REG_READ(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_A);\n\tREG_WRITE(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_B, reg);\n\tREG_WRITE(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_C, reg);\n\tREG_WRITE(DCHUBBUB_ARB_FRAC_URG_BW_FLIP_D, reg);\n\n\treg = REG_READ(DCHUBBUB_ARB_FRAC_URG_BW_NOM_A);\n\tREG_WRITE(DCHUBBUB_ARB_FRAC_URG_BW_NOM_B, reg);\n\tREG_WRITE(DCHUBBUB_ARB_FRAC_URG_BW_NOM_C, reg);\n\tREG_WRITE(DCHUBBUB_ARB_FRAC_URG_BW_NOM_D, reg);\n\n\treg = REG_READ(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_A);\n\tREG_WRITE(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_B, reg);\n\tREG_WRITE(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_C, reg);\n\tREG_WRITE(DCHUBBUB_ARB_REFCYC_PER_TRIP_TO_MEMORY_D, reg);\n\n\treg = REG_READ(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_A);\n\tREG_WRITE(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_B, reg);\n\tREG_WRITE(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_C, reg);\n\tREG_WRITE(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_D, reg);\n\n\treg = REG_READ(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_A);\n\tREG_WRITE(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_B, reg);\n\tREG_WRITE(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_C, reg);\n\tREG_WRITE(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_D, reg);\n\n\treg = REG_READ(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_A);\n\tREG_WRITE(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_B, reg);\n\tREG_WRITE(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_C, reg);\n\tREG_WRITE(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_D, reg);\n\n\treg = REG_READ(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_A);\n\tREG_WRITE(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_B, reg);\n\tREG_WRITE(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_C, reg);\n\tREG_WRITE(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_D, reg);\n\n\treg = REG_READ(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_A);\n\tREG_WRITE(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_B, reg);\n\tREG_WRITE(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_C, reg);\n\tREG_WRITE(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_D, reg);\n}\n\nstatic void hubbub32_wm_read_state(struct hubbub *hubbub,\n\t\tstruct dcn_hubbub_wm *wm)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\tstruct dcn_hubbub_wm_set *s;\n\n\tmemset(wm, 0, sizeof(struct dcn_hubbub_wm));\n\n\ts = &wm->sets[0];\n\ts->wm_set = 0;\n\tREG_GET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A,\n\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A, &s->data_urgent);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_A,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_A, &s->sr_enter);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_A,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_A, &s->sr_exit);\n\n\tREG_GET(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_A,\n\t\t\t DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_A, &s->dram_clk_change);\n\n\tREG_GET(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_A,\n\t\t\t DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_A, &s->usr_retrain);\n\n\tREG_GET(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_A,\n\t\t\t DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_A, &s->fclk_pstate_change);\n\n\ts = &wm->sets[1];\n\ts->wm_set = 1;\n\tREG_GET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_B,\n\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_B, &s->data_urgent);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_B,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_B, &s->sr_enter);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_B,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_B, &s->sr_exit);\n\n\tREG_GET(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_B,\n\t\t\tDCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_B, &s->dram_clk_change);\n\n\tREG_GET(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_B,\n\t\t\t DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_B, &s->usr_retrain);\n\n\tREG_GET(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_B,\n\t\t\tDCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_B, &s->fclk_pstate_change);\n\n\ts = &wm->sets[2];\n\ts->wm_set = 2;\n\tREG_GET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_C,\n\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_C, &s->data_urgent);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_C,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_C, &s->sr_enter);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_C,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_C, &s->sr_exit);\n\n\tREG_GET(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_C,\n\t\t\tDCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_C, &s->dram_clk_change);\n\n\tREG_GET(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_C,\n\t\t\t DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_C, &s->usr_retrain);\n\n\tREG_GET(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_C,\n\t\t\tDCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_C, &s->fclk_pstate_change);\n\n\ts = &wm->sets[3];\n\ts->wm_set = 3;\n\tREG_GET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_D,\n\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_D, &s->data_urgent);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_D,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_ENTER_WATERMARK_D, &s->sr_enter);\n\n\tREG_GET(DCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_D,\n\t\t\tDCHUBBUB_ARB_ALLOW_SR_EXIT_WATERMARK_D, &s->sr_exit);\n\n\tREG_GET(DCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_D,\n\t\t\tDCHUBBUB_ARB_UCLK_PSTATE_CHANGE_WATERMARK_D, &s->dram_clk_change);\n\n\tREG_GET(DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_D,\n\t\t\t DCHUBBUB_ARB_USR_RETRAINING_WATERMARK_D, &s->usr_retrain);\n\n\tREG_GET(DCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_D,\n\t\t\tDCHUBBUB_ARB_FCLK_PSTATE_CHANGE_WATERMARK_D, &s->fclk_pstate_change);\n}\n\nvoid hubbub32_force_wm_propagate_to_pipes(struct hubbub *hubbub)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\tuint32_t refclk_mhz = hubbub->ctx->dc->res_pool->ref_clocks.dchub_ref_clock_inKhz / 1000;\n\tuint32_t prog_wm_value = convert_and_clamp(hubbub2->watermarks.a.urgent_ns,\n\t\t\trefclk_mhz, 0x3fff);\n\n\tREG_SET(DCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A, 0,\n\t\t\tDCHUBBUB_ARB_DATA_URGENCY_WATERMARK_A, prog_wm_value);\n}\n\nvoid hubbub32_init(struct hubbub *hubbub)\n{\n\tstruct dcn20_hubbub *hubbub2 = TO_DCN20_HUBBUB(hubbub);\n\n\t \n\tif (hubbub->ctx->dc->debug.disable_clock_gate) {\n\t\t \n\t\t \n\n\t\tREG_UPDATE_2(DCHUBBUB_CLOCK_CNTL,\n\t\t\tDISPCLK_R_DCHUBBUB_GATE_DIS, 1,\n\t\t\tDCFCLK_R_DCHUBBUB_GATE_DIS, 1);\n\t}\n\t \n\tREG_UPDATE(DCHUBBUB_SDPIF_CFG0,\n\t\t\tSDPIF_PORT_CONTROL, 1);\n\t \n\tREG_UPDATE(DCHUBBUB_SDPIF_CFG1,\n\t\t\tSDPIF_MAX_NUM_OUTSTANDING, 1);\n\t \n\tREG_UPDATE_2(DCHUBBUB_ARB_DF_REQ_OUTSTAND,\n\t\t\tDCHUBBUB_ARB_MAX_REQ_OUTSTAND, 512,\n\t\t\tDCHUBBUB_ARB_MIN_REQ_OUTSTAND, 512);\n}\n\nstatic const struct hubbub_funcs hubbub32_funcs = {\n\t.update_dchub = hubbub2_update_dchub,\n\t.init_dchub_sys_ctx = hubbub3_init_dchub_sys_ctx,\n\t.init_vm_ctx = hubbub2_init_vm_ctx,\n\t.dcc_support_swizzle = hubbub3_dcc_support_swizzle,\n\t.dcc_support_pixel_format = hubbub2_dcc_support_pixel_format,\n\t.get_dcc_compression_cap = hubbub3_get_dcc_compression_cap,\n\t.wm_read_state = hubbub32_wm_read_state,\n\t.get_dchub_ref_freq = hubbub2_get_dchub_ref_freq,\n\t.program_watermarks = hubbub32_program_watermarks,\n\t.allow_self_refresh_control = hubbub1_allow_self_refresh_control,\n\t.is_allow_self_refresh_enabled = hubbub1_is_allow_self_refresh_enabled,\n\t.verify_allow_pstate_change_high = hubbub1_verify_allow_pstate_change_high,\n\t.force_wm_propagate_to_pipes = hubbub32_force_wm_propagate_to_pipes,\n\t.force_pstate_change_control = hubbub3_force_pstate_change_control,\n\t.init_watermarks = hubbub32_init_watermarks,\n\t.program_det_size = dcn32_program_det_size,\n\t.program_compbuf_size = dcn32_program_compbuf_size,\n\t.init_crb = dcn32_init_crb,\n\t.hubbub_read_state = hubbub2_read_state,\n\t.force_usr_retraining_allow = hubbub32_force_usr_retraining_allow,\n\t.set_request_limit = hubbub32_set_request_limit\n};\n\nvoid hubbub32_construct(struct dcn20_hubbub *hubbub2,\n\tstruct dc_context *ctx,\n\tconst struct dcn_hubbub_registers *hubbub_regs,\n\tconst struct dcn_hubbub_shift *hubbub_shift,\n\tconst struct dcn_hubbub_mask *hubbub_mask,\n\tint det_size_kb,\n\tint pixel_chunk_size_kb,\n\tint config_return_buffer_size_kb)\n{\n\thubbub2->base.ctx = ctx;\n\thubbub2->base.funcs = &hubbub32_funcs;\n\thubbub2->regs = hubbub_regs;\n\thubbub2->shifts = hubbub_shift;\n\thubbub2->masks = hubbub_mask;\n\n\thubbub2->debug_test_index_pstate = 0xB;\n\thubbub2->detile_buf_size = det_size_kb * 1024;\n\thubbub2->pixel_chunk_size = pixel_chunk_size_kb * 1024;\n\thubbub2->crb_size_segs = config_return_buffer_size_kb / DCN32_CRB_SEGMENT_SIZE_KB;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}