{
  "module_name": "display_rq_dlg_calc_32.c",
  "hash_id": "be6670847d56cae12661f8f08c617a62f21af29a85f6660f2c6c138906cfbc41",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/dcn32/display_rq_dlg_calc_32.c",
  "human_readable_source": " \n\n\n#include \"../display_mode_lib.h\"\n#include \"../display_mode_vba.h\"\n#include \"../dml_inline_defs.h\"\n#include \"display_rq_dlg_calc_32.h\"\n\nstatic bool is_dual_plane(enum source_format_class source_format)\n{\n\tbool ret_val = 0;\n\n\tif ((source_format == dm_420_12) || (source_format == dm_420_8) || (source_format == dm_420_10)\n\t\t|| (source_format == dm_rgbe_alpha))\n\t\tret_val = 1;\n\n\treturn ret_val;\n}\n\nvoid dml32_rq_dlg_get_rq_reg(display_rq_regs_st *rq_regs,\n\t\tstruct display_mode_lib *mode_lib,\n\t\tconst display_e2e_pipe_params_st *e2e_pipe_param,\n\t\tconst unsigned int num_pipes,\n\t\tconst unsigned int pipe_idx)\n{\n\tconst display_pipe_source_params_st *src = &e2e_pipe_param[pipe_idx].pipe.src;\n\tbool dual_plane = is_dual_plane((enum source_format_class) (src->source_format));\n\tdouble stored_swath_l_bytes;\n\tdouble stored_swath_c_bytes;\n\tbool is_phantom_pipe;\n\tuint32_t pixel_chunk_bytes = 0;\n\tuint32_t min_pixel_chunk_bytes = 0;\n\tuint32_t meta_chunk_bytes = 0;\n\tuint32_t min_meta_chunk_bytes = 0;\n\tuint32_t dpte_group_bytes = 0;\n\tuint32_t mpte_group_bytes = 0;\n\n\tuint32_t p1_pixel_chunk_bytes = 0;\n\tuint32_t p1_min_pixel_chunk_bytes = 0;\n\tuint32_t p1_meta_chunk_bytes = 0;\n\tuint32_t p1_min_meta_chunk_bytes = 0;\n\tuint32_t p1_dpte_group_bytes = 0;\n\tuint32_t p1_mpte_group_bytes = 0;\n\n\tunsigned int detile_buf_size_in_bytes;\n\tunsigned int detile_buf_plane1_addr;\n\tunsigned int pte_row_height_linear;\n\n\tmemset(rq_regs, 0, sizeof(*rq_regs));\n\n\tdml_print(\"DML_DLG::%s: Calculation for pipe[%d] start, num_pipes=%d\\n\", __func__, pipe_idx, num_pipes);\n\n\tpixel_chunk_bytes = get_pixel_chunk_size_in_kbyte(mode_lib, e2e_pipe_param, num_pipes) * 1024; \n\tmin_pixel_chunk_bytes = get_min_pixel_chunk_size_in_byte(mode_lib, e2e_pipe_param, num_pipes); \n\n\tif (pixel_chunk_bytes == 64 * 1024)\n\t\tmin_pixel_chunk_bytes = 0;\n\n\tmeta_chunk_bytes = get_meta_chunk_size_in_kbyte(mode_lib, e2e_pipe_param, num_pipes) * 1024; \n\tmin_meta_chunk_bytes = get_min_meta_chunk_size_in_byte(mode_lib, e2e_pipe_param, num_pipes); \n\n\tdpte_group_bytes = get_dpte_group_size_in_bytes(mode_lib, e2e_pipe_param, num_pipes, pipe_idx); \n\tmpte_group_bytes = get_vm_group_size_in_bytes(mode_lib, e2e_pipe_param, num_pipes, pipe_idx); \n\n\tp1_pixel_chunk_bytes = pixel_chunk_bytes;\n\tp1_min_pixel_chunk_bytes = min_pixel_chunk_bytes;\n\tp1_meta_chunk_bytes = meta_chunk_bytes;\n\tp1_min_meta_chunk_bytes = min_meta_chunk_bytes;\n\tp1_dpte_group_bytes = dpte_group_bytes;\n\tp1_mpte_group_bytes = mpte_group_bytes;\n\n\tif ((enum source_format_class) src->source_format == dm_rgbe_alpha)\n\t\tp1_pixel_chunk_bytes = get_alpha_pixel_chunk_size_in_kbyte(mode_lib, e2e_pipe_param, num_pipes) * 1024;\n\n\trq_regs->rq_regs_l.chunk_size = dml_log2(pixel_chunk_bytes) - 10;\n\trq_regs->rq_regs_c.chunk_size = dml_log2(p1_pixel_chunk_bytes) - 10;\n\n\tif (min_pixel_chunk_bytes == 0)\n\t\trq_regs->rq_regs_l.min_chunk_size = 0;\n\telse\n\t\trq_regs->rq_regs_l.min_chunk_size = dml_log2(min_pixel_chunk_bytes) - 8 + 1;\n\n\tif (p1_min_pixel_chunk_bytes == 0)\n\t\trq_regs->rq_regs_c.min_chunk_size = 0;\n\telse\n\t\trq_regs->rq_regs_c.min_chunk_size = dml_log2(p1_min_pixel_chunk_bytes) - 8 + 1;\n\n\trq_regs->rq_regs_l.meta_chunk_size = dml_log2(meta_chunk_bytes) - 10;\n\trq_regs->rq_regs_c.meta_chunk_size = dml_log2(p1_meta_chunk_bytes) - 10;\n\n\tif (min_meta_chunk_bytes == 0)\n\t\trq_regs->rq_regs_l.min_meta_chunk_size = 0;\n\telse\n\t\trq_regs->rq_regs_l.min_meta_chunk_size = dml_log2(min_meta_chunk_bytes) - 6 + 1;\n\n\tif (p1_min_meta_chunk_bytes == 0)\n\t\trq_regs->rq_regs_c.min_meta_chunk_size = 0;\n\telse\n\t\trq_regs->rq_regs_c.min_meta_chunk_size = dml_log2(p1_min_meta_chunk_bytes) - 6 + 1;\n\n\trq_regs->rq_regs_l.dpte_group_size = dml_log2(dpte_group_bytes) - 6;\n\trq_regs->rq_regs_l.mpte_group_size = dml_log2(mpte_group_bytes) - 6;\n\trq_regs->rq_regs_c.dpte_group_size = dml_log2(p1_dpte_group_bytes) - 6;\n\trq_regs->rq_regs_c.mpte_group_size = dml_log2(p1_mpte_group_bytes) - 6;\n\n\tdetile_buf_size_in_bytes = get_det_buffer_size_kbytes(mode_lib, e2e_pipe_param, num_pipes, pipe_idx) * 1024;\n\tdetile_buf_plane1_addr = 0;\n\tpte_row_height_linear = get_dpte_row_height_linear_l(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx);\n\n\tif (src->sw_mode == dm_sw_linear)\n\t\tASSERT(pte_row_height_linear >= 8);\n\n\trq_regs->rq_regs_l.pte_row_height_linear = dml_floor(dml_log2(pte_row_height_linear), 1) - 3;\n\n\tif (dual_plane) {\n\t\tunsigned int p1_pte_row_height_linear = get_dpte_row_height_linear_c(mode_lib, e2e_pipe_param,\n\t\t\t\tnum_pipes, pipe_idx);\n\t\t;\n\t\tif (src->sw_mode == dm_sw_linear)\n\t\t\tASSERT(p1_pte_row_height_linear >= 8);\n\n\t\trq_regs->rq_regs_c.pte_row_height_linear = dml_floor(dml_log2(p1_pte_row_height_linear), 1) - 3;\n\t}\n\n\trq_regs->rq_regs_l.swath_height = dml_log2(get_swath_height_l(mode_lib, e2e_pipe_param, num_pipes, pipe_idx));\n\trq_regs->rq_regs_c.swath_height = dml_log2(get_swath_height_c(mode_lib, e2e_pipe_param, num_pipes, pipe_idx));\n\n\t\n\t\n\tif (pixel_chunk_bytes >= 32 * 1024 || (dual_plane && p1_pixel_chunk_bytes >= 32 * 1024)) { \n\t\trq_regs->drq_expansion_mode = 0;\n\t} else {\n\t\trq_regs->drq_expansion_mode = 2;\n\t}\n\trq_regs->prq_expansion_mode = 1;\n\trq_regs->mrq_expansion_mode = 1;\n\trq_regs->crq_expansion_mode = 1;\n\n\tstored_swath_l_bytes = get_det_stored_buffer_size_l_bytes(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx);\n\tstored_swath_c_bytes = get_det_stored_buffer_size_c_bytes(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx);\n\tis_phantom_pipe = get_is_phantom_pipe(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);\n\n\t\n\tif (dual_plane) {\n\t\tif (is_phantom_pipe) {\n\t\t\tdetile_buf_plane1_addr = ((1024.0 * 1024.0) / 2.0 / 1024.0); \n\t\t} else {\n\t\t\tif (stored_swath_l_bytes / stored_swath_c_bytes <= 1.5) {\n\t\t\t\tdetile_buf_plane1_addr = (detile_buf_size_in_bytes / 2.0 / 1024.0); \n#ifdef __DML_RQ_DLG_CALC_DEBUG__\n\t\t\t\tdml_print(\"DML_DLG: %s: detile_buf_plane1_addr = %d (1/2 to chroma)\\n\",\n\t\t\t\t\t\t__func__, detile_buf_plane1_addr);\n#endif\n\t\t\t} else {\n\t\t\t\tdetile_buf_plane1_addr =\n\t\t\t\t\t\tdml_round_to_multiple(\n\t\t\t\t\t\t\t\t(unsigned int) ((2.0 * detile_buf_size_in_bytes) / 3.0),\n\t\t\t\t\t\t\t\t1024, 0) / 1024.0; \n#ifdef __DML_RQ_DLG_CALC_DEBUG__\n\t\t\t\tdml_print(\"DML_DLG: %s: detile_buf_plane1_addr = %d (1/3 chroma)\\n\",\n\t\t\t\t\t\t__func__, detile_buf_plane1_addr);\n#endif\n\t\t\t}\n\t\t}\n\t}\n\trq_regs->plane1_base_address = detile_buf_plane1_addr;\n\n#ifdef __DML_RQ_DLG_CALC_DEBUG__\n\tdml_print(\"DML_DLG: %s: is_phantom_pipe = %d\\n\", __func__, is_phantom_pipe);\n\tdml_print(\"DML_DLG: %s: stored_swath_l_bytes = %f\\n\", __func__, stored_swath_l_bytes);\n\tdml_print(\"DML_DLG: %s: stored_swath_c_bytes = %f\\n\", __func__, stored_swath_c_bytes);\n\tdml_print(\"DML_DLG: %s: detile_buf_size_in_bytes = %d\\n\", __func__, detile_buf_size_in_bytes);\n\tdml_print(\"DML_DLG: %s: detile_buf_plane1_addr = %d\\n\", __func__, detile_buf_plane1_addr);\n\tdml_print(\"DML_DLG: %s: plane1_base_address = %d\\n\", __func__, rq_regs->plane1_base_address);\n#endif\n\tprint__rq_regs_st(mode_lib, rq_regs);\n\tdml_print(\"DML_DLG::%s: Calculation for pipe[%d] done, num_pipes=%d\\n\", __func__, pipe_idx, num_pipes);\n}\n\nvoid dml32_rq_dlg_get_dlg_reg(struct display_mode_lib *mode_lib,\n\t\tdisplay_dlg_regs_st *dlg_regs,\n\t\tdisplay_ttu_regs_st *ttu_regs,\n\t\tdisplay_e2e_pipe_params_st *e2e_pipe_param,\n\t\tconst unsigned int num_pipes,\n\t\tconst unsigned int pipe_idx)\n{\n\tconst display_pipe_source_params_st *src = &e2e_pipe_param[pipe_idx].pipe.src;\n\tconst display_pipe_dest_params_st *dst = &e2e_pipe_param[pipe_idx].pipe.dest;\n\tconst display_clocks_and_cfg_st *clks = &e2e_pipe_param[pipe_idx].clks_cfg;\n\tdouble refcyc_per_req_delivery_pre_cur0 = 0.;\n\tdouble refcyc_per_req_delivery_cur0 = 0.;\n\tdouble refcyc_per_req_delivery_pre_c = 0.;\n\tdouble refcyc_per_req_delivery_c = 0.;\n\tdouble refcyc_per_req_delivery_pre_l;\n\tdouble refcyc_per_req_delivery_l;\n\tdouble refcyc_per_line_delivery_pre_c = 0.;\n\tdouble refcyc_per_line_delivery_c = 0.;\n\tdouble refcyc_per_line_delivery_pre_l;\n\tdouble refcyc_per_line_delivery_l;\n\tdouble min_ttu_vblank;\n\tdouble vratio_pre_l;\n\tdouble vratio_pre_c;\n\tunsigned int min_dst_y_next_start;\n\tunsigned int htotal = dst->htotal;\n\tunsigned int hblank_end = dst->hblank_end;\n\tunsigned int vblank_end = dst->vblank_end;\n\tbool interlaced = dst->interlaced;\n\tdouble pclk_freq_in_mhz = dst->pixel_rate_mhz;\n\tunsigned int vready_after_vcount0;\n\tdouble refclk_freq_in_mhz = clks->refclk_mhz;\n\tdouble ref_freq_to_pix_freq = refclk_freq_in_mhz / pclk_freq_in_mhz;\n\tbool dual_plane = 0;\n\tunsigned int pipe_index_in_combine[DC__NUM_PIPES__MAX];\n\tunsigned int dst_x_after_scaler;\n\tunsigned int dst_y_after_scaler;\n\tdouble dst_y_prefetch;\n\tdouble dst_y_per_vm_vblank;\n\tdouble dst_y_per_row_vblank;\n\tdouble dst_y_per_vm_flip;\n\tdouble dst_y_per_row_flip;\n\tdouble max_dst_y_per_vm_vblank = 32.0;\n\tdouble max_dst_y_per_row_vblank = 16.0;\n\tdouble dst_y_per_pte_row_nom_l;\n\tdouble dst_y_per_pte_row_nom_c;\n\tdouble dst_y_per_meta_row_nom_l;\n\tdouble dst_y_per_meta_row_nom_c;\n\tdouble refcyc_per_pte_group_nom_l;\n\tdouble refcyc_per_pte_group_nom_c;\n\tdouble refcyc_per_pte_group_vblank_l;\n\tdouble refcyc_per_pte_group_vblank_c;\n\tdouble refcyc_per_pte_group_flip_l;\n\tdouble refcyc_per_pte_group_flip_c;\n\tdouble refcyc_per_meta_chunk_nom_l;\n\tdouble refcyc_per_meta_chunk_nom_c;\n\tdouble refcyc_per_meta_chunk_vblank_l;\n\tdouble refcyc_per_meta_chunk_vblank_c;\n\tdouble refcyc_per_meta_chunk_flip_l;\n\tdouble refcyc_per_meta_chunk_flip_c;\n\n\tmemset(dlg_regs, 0, sizeof(*dlg_regs));\n\tmemset(ttu_regs, 0, sizeof(*ttu_regs));\n\tdml_print(\"DML_DLG::%s: Calculation for pipe[%d] starts, num_pipes=%d\\n\", __func__, pipe_idx, num_pipes);\n\tdml_print(\"DML_DLG: %s: refclk_freq_in_mhz     = %3.2f\\n\", __func__, refclk_freq_in_mhz);\n\tdml_print(\"DML_DLG: %s: pclk_freq_in_mhz = %3.2f\\n\", __func__, pclk_freq_in_mhz);\n\tdml_print(\"DML_DLG: %s: ref_freq_to_pix_freq   = %3.2f\\n\", __func__, ref_freq_to_pix_freq);\n\tdml_print(\"DML_DLG: %s: interlaced = %d\\n\", __func__, interlaced);\n\tASSERT(ref_freq_to_pix_freq < 4.0);\n\n\tdlg_regs->ref_freq_to_pix_freq = (unsigned int) (ref_freq_to_pix_freq * dml_pow(2, 19));\n\tdlg_regs->refcyc_per_htotal = (unsigned int) (ref_freq_to_pix_freq * (double) htotal * dml_pow(2, 8));\n\tdlg_regs->dlg_vblank_end = interlaced ? (vblank_end / 2) : vblank_end; \n\n\tmin_ttu_vblank = get_min_ttu_vblank_in_us(mode_lib, e2e_pipe_param, num_pipes, pipe_idx); \n\tmin_dst_y_next_start = get_min_dst_y_next_start(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);\n\n\tdml_print(\"DML_DLG: %s: min_ttu_vblank (us)    = %3.2f\\n\", __func__, min_ttu_vblank);\n\tdml_print(\"DML_DLG: %s: min_dst_y_next_start = %d\\n\", __func__, min_dst_y_next_start);\n\tdml_print(\"DML_DLG: %s: ref_freq_to_pix_freq   = %3.2f\\n\", __func__, ref_freq_to_pix_freq);\n\n\tdual_plane = is_dual_plane((enum source_format_class) (src->source_format));\n\n\tvready_after_vcount0 = get_vready_at_or_after_vsync(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx); \n\tdlg_regs->vready_after_vcount0 = vready_after_vcount0;\n\n\tdml_print(\"DML_DLG: %s: vready_after_vcount0 = %d\\n\", __func__, dlg_regs->vready_after_vcount0);\n\n\tdst_x_after_scaler = dml_ceil(get_dst_x_after_scaler(mode_lib, e2e_pipe_param, num_pipes, pipe_idx), 1);\n\tdst_y_after_scaler = dml_ceil(get_dst_y_after_scaler(mode_lib, e2e_pipe_param, num_pipes, pipe_idx), 1);\n\n\t\n\tdml_print(\"DML_DLG: %s: input dst_x_after_scaler   = %d\\n\", __func__, dst_x_after_scaler);\n\tdml_print(\"DML_DLG: %s: input dst_y_after_scaler   = %d\\n\", __func__, dst_y_after_scaler);\n\n\t\n\tif (dst->odm_combine == dm_odm_combine_mode_2to1 || dst->odm_combine == dm_odm_combine_mode_4to1) {\n\t\t\n\t\tbool visited[DC__NUM_PIPES__MAX];\n\t\tunsigned int i, j, k;\n\n\t\tfor (k = 0; k < num_pipes; ++k) {\n\t\t\tvisited[k] = false;\n\t\t\tpipe_index_in_combine[k] = 0;\n\t\t}\n\n\t\tfor (i = 0; i < num_pipes; i++) {\n\t\t\tif (e2e_pipe_param[i].pipe.src.is_hsplit && !visited[i]) {\n\n\t\t\t\tunsigned int grp = e2e_pipe_param[i].pipe.src.hsplit_grp;\n\t\t\t\tunsigned int grp_idx = 0;\n\n\t\t\t\tfor (j = i; j < num_pipes; j++) {\n\t\t\t\t\tif (e2e_pipe_param[j].pipe.src.hsplit_grp == grp\n\t\t\t\t\t\t&& e2e_pipe_param[j].pipe.src.is_hsplit && !visited[j]) {\n\t\t\t\t\t\tpipe_index_in_combine[j] = grp_idx;\n\t\t\t\t\t\tdml_print(\"DML_DLG: %s: pipe[%d] is in grp %d idx %d\\n\",\n\t\t\t\t\t\t\t\t__func__, j, grp, grp_idx);\n\t\t\t\t\t\tgrp_idx++;\n\t\t\t\t\t\tvisited[j] = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif (dst->odm_combine == dm_odm_combine_mode_disabled) {\n\t\t\n\t\tdlg_regs->refcyc_h_blank_end = (unsigned int) ((double) hblank_end * ref_freq_to_pix_freq);\n\t} else {\n\t\tif (dst->odm_combine == dm_odm_combine_mode_2to1 || dst->odm_combine == dm_odm_combine_mode_4to1) {\n\t\t\t\n\t\t\tunsigned int odm_combine_factor = (dst->odm_combine == dm_odm_combine_mode_2to1 ? 2 : 4);\n\t\t\tunsigned int odm_pipe_index = pipe_index_in_combine[pipe_idx];\n\n\t\t\tdlg_regs->refcyc_h_blank_end = (unsigned int) (((double) hblank_end\n\t\t\t\t+ odm_pipe_index * (double) dst->hactive / odm_combine_factor) * ref_freq_to_pix_freq);\n\t\t}\n\t}\n\tASSERT(dlg_regs->refcyc_h_blank_end < (unsigned int)dml_pow(2, 13));\n\n\tdml_print(\"DML_DLG: %s: htotal= %d\\n\", __func__, htotal);\n\tdml_print(\"DML_DLG: %s: dst_x_after_scaler[%d]= %d\\n\", __func__, pipe_idx, dst_x_after_scaler);\n\tdml_print(\"DML_DLG: %s: dst_y_after_scaler[%d] = %d\\n\", __func__, pipe_idx, dst_y_after_scaler);\n\n\tdst_y_prefetch = get_dst_y_prefetch(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);        \n\t\n\tdst_y_per_vm_vblank = get_dst_y_per_vm_vblank(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);\n\t\n\tdst_y_per_row_vblank = get_dst_y_per_row_vblank(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);\n\tdst_y_per_vm_flip = get_dst_y_per_vm_flip(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);    \n\tdst_y_per_row_flip = get_dst_y_per_row_flip(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);  \n\n\t\n\tif (htotal <= 75) {\n\t\tmax_dst_y_per_vm_vblank = 100.0;\n\t\tmax_dst_y_per_row_vblank = 100.0;\n\t}\n\n\tdml_print(\"DML_DLG: %s: dst_y_prefetch (after rnd) = %3.2f\\n\", __func__, dst_y_prefetch);\n\tdml_print(\"DML_DLG: %s: dst_y_per_vm_flip    = %3.2f\\n\", __func__, dst_y_per_vm_flip);\n\tdml_print(\"DML_DLG: %s: dst_y_per_row_flip   = %3.2f\\n\", __func__, dst_y_per_row_flip);\n\tdml_print(\"DML_DLG: %s: dst_y_per_vm_vblank  = %3.2f\\n\", __func__, dst_y_per_vm_vblank);\n\tdml_print(\"DML_DLG: %s: dst_y_per_row_vblank = %3.2f\\n\", __func__, dst_y_per_row_vblank);\n\n\tASSERT(dst_y_per_vm_vblank < max_dst_y_per_vm_vblank);\n\tASSERT(dst_y_per_row_vblank < max_dst_y_per_row_vblank);\n\tASSERT(dst_y_prefetch > (dst_y_per_vm_vblank + dst_y_per_row_vblank));\n\n\tvratio_pre_l = get_vratio_prefetch_l(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);    \n\tvratio_pre_c = get_vratio_prefetch_c(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);    \n\n\tdml_print(\"DML_DLG: %s: vratio_pre_l = %3.2f\\n\", __func__, vratio_pre_l);\n\tdml_print(\"DML_DLG: %s: vratio_pre_c = %3.2f\\n\", __func__, vratio_pre_c);\n\n\t\n\trefcyc_per_line_delivery_pre_l = get_refcyc_per_line_delivery_pre_l_in_us(mode_lib, e2e_pipe_param, num_pipes, pipe_idx) * refclk_freq_in_mhz;   \n\trefcyc_per_line_delivery_l = get_refcyc_per_line_delivery_l_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz;       \n\n\tdml_print(\"DML_DLG: %s: refcyc_per_line_delivery_pre_l = %3.2f\\n\", __func__, refcyc_per_line_delivery_pre_l);\n\tdml_print(\"DML_DLG: %s: refcyc_per_line_delivery_l     = %3.2f\\n\", __func__, refcyc_per_line_delivery_l);\n\n\tif (dual_plane) {\n\t\trefcyc_per_line_delivery_pre_c = get_refcyc_per_line_delivery_pre_c_in_us(mode_lib, e2e_pipe_param,\n\t\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;     \n\t\trefcyc_per_line_delivery_c = get_refcyc_per_line_delivery_c_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\t\tpipe_idx) * refclk_freq_in_mhz; \n\n\t\tdml_print(\"DML_DLG: %s: refcyc_per_line_delivery_pre_c = %3.2f\\n\",\n\t\t\t\t__func__, refcyc_per_line_delivery_pre_c);\n\t\tdml_print(\"DML_DLG: %s: refcyc_per_line_delivery_c     = %3.2f\\n\",\n\t\t\t\t__func__, refcyc_per_line_delivery_c);\n\t}\n\n\tif (src->dynamic_metadata_enable && src->gpuvm)\n\t\tdlg_regs->refcyc_per_vm_dmdata = get_refcyc_per_vm_dmdata_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\t\tpipe_idx) * refclk_freq_in_mhz; \n\n\tdlg_regs->dmdata_dl_delta = get_dmdata_dl_delta_in_us(mode_lib, e2e_pipe_param, num_pipes, pipe_idx)\n\t\t* refclk_freq_in_mhz; \n\n\trefcyc_per_req_delivery_pre_l = get_refcyc_per_req_delivery_pre_l_in_us(mode_lib, e2e_pipe_param, num_pipes, pipe_idx) * refclk_freq_in_mhz; \n\trefcyc_per_req_delivery_l = get_refcyc_per_req_delivery_l_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz;     \n\n\tdml_print(\"DML_DLG: %s: refcyc_per_req_delivery_pre_l = %3.2f\\n\", __func__, refcyc_per_req_delivery_pre_l);\n\tdml_print(\"DML_DLG: %s: refcyc_per_req_delivery_l     = %3.2f\\n\", __func__, refcyc_per_req_delivery_l);\n\n\tif (dual_plane) {\n\t\trefcyc_per_req_delivery_pre_c = get_refcyc_per_req_delivery_pre_c_in_us(mode_lib, e2e_pipe_param,\n\t\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;  \n\t\trefcyc_per_req_delivery_c = get_refcyc_per_req_delivery_c_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\t\tpipe_idx) * refclk_freq_in_mhz;      \n\n\t\tdml_print(\"DML_DLG: %s: refcyc_per_req_delivery_pre_c = %3.2f\\n\",\n\t\t\t\t__func__, refcyc_per_req_delivery_pre_c);\n\t\tdml_print(\"DML_DLG: %s: refcyc_per_req_delivery_c     = %3.2f\\n\", __func__, refcyc_per_req_delivery_c);\n\t}\n\n\t\n\tASSERT(src->num_cursors <= 1);\n\tif (src->num_cursors > 0) {\n\t\trefcyc_per_req_delivery_pre_cur0 = get_refcyc_per_cursor_req_delivery_pre_in_us(mode_lib,\n\t\t\t\te2e_pipe_param, num_pipes, pipe_idx) * refclk_freq_in_mhz;  \n\t\trefcyc_per_req_delivery_cur0 = get_refcyc_per_cursor_req_delivery_in_us(mode_lib, e2e_pipe_param,\n\t\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;      \n\n\t\tdml_print(\"DML_DLG: %s: refcyc_per_req_delivery_pre_cur0 = %3.2f\\n\",\n\t\t\t\t__func__, refcyc_per_req_delivery_pre_cur0);\n\t\tdml_print(\"DML_DLG: %s: refcyc_per_req_delivery_cur0     = %3.2f\\n\",\n\t\t\t\t__func__, refcyc_per_req_delivery_cur0);\n\t}\n\n\t\n\tdlg_regs->min_dst_y_next_start = min_dst_y_next_start * dml_pow(2, 2);\n\tASSERT(dlg_regs->min_dst_y_next_start < (unsigned int)dml_pow(2, 18));\n\n\tdlg_regs->dst_y_after_scaler = dst_y_after_scaler; \n\tdlg_regs->refcyc_x_after_scaler = dst_x_after_scaler * ref_freq_to_pix_freq; \n\tdlg_regs->dst_y_prefetch = (unsigned int) (dst_y_prefetch * dml_pow(2, 2));\n\tdlg_regs->dst_y_per_vm_vblank = (unsigned int) (dst_y_per_vm_vblank * dml_pow(2, 2));\n\tdlg_regs->dst_y_per_row_vblank = (unsigned int) (dst_y_per_row_vblank * dml_pow(2, 2));\n\tdlg_regs->dst_y_per_vm_flip = (unsigned int) (dst_y_per_vm_flip * dml_pow(2, 2));\n\tdlg_regs->dst_y_per_row_flip = (unsigned int) (dst_y_per_row_flip * dml_pow(2, 2));\n\n\tdlg_regs->vratio_prefetch = (unsigned int) (vratio_pre_l * dml_pow(2, 19));\n\tdlg_regs->vratio_prefetch_c = (unsigned int) (vratio_pre_c * dml_pow(2, 19));\n\n\tdml_print(\"DML_DLG: %s: dlg_regs->dst_y_per_vm_vblank  = 0x%x\\n\", __func__, dlg_regs->dst_y_per_vm_vblank);\n\tdml_print(\"DML_DLG: %s: dlg_regs->dst_y_per_row_vblank = 0x%x\\n\", __func__, dlg_regs->dst_y_per_row_vblank);\n\tdml_print(\"DML_DLG: %s: dlg_regs->dst_y_per_vm_flip    = 0x%x\\n\", __func__, dlg_regs->dst_y_per_vm_flip);\n\tdml_print(\"DML_DLG: %s: dlg_regs->dst_y_per_row_flip   = 0x%x\\n\", __func__, dlg_regs->dst_y_per_row_flip);\n\n\tdlg_regs->refcyc_per_vm_group_vblank = get_refcyc_per_vm_group_vblank_in_us(mode_lib, e2e_pipe_param,\n\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;               \n\tdlg_regs->refcyc_per_vm_group_flip = get_refcyc_per_vm_group_flip_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz;                 \n\tdlg_regs->refcyc_per_vm_req_vblank = get_refcyc_per_vm_req_vblank_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz * dml_pow(2, 10);                 \n\tdlg_regs->refcyc_per_vm_req_flip = get_refcyc_per_vm_req_flip_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz * dml_pow(2, 10);  \n\n\t\n\tdst_y_per_pte_row_nom_l = get_dst_y_per_pte_row_nom_l(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);\n\t\n\tdst_y_per_pte_row_nom_c = get_dst_y_per_pte_row_nom_c(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);\n\t\n\tdst_y_per_meta_row_nom_l = get_dst_y_per_meta_row_nom_l(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);\n\t\n\tdst_y_per_meta_row_nom_c = get_dst_y_per_meta_row_nom_c(mode_lib, e2e_pipe_param, num_pipes, pipe_idx);\n\n\trefcyc_per_pte_group_nom_l = get_refcyc_per_pte_group_nom_l_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz;         \n\trefcyc_per_pte_group_nom_c = get_refcyc_per_pte_group_nom_c_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz;         \n\trefcyc_per_pte_group_vblank_l = get_refcyc_per_pte_group_vblank_l_in_us(mode_lib, e2e_pipe_param,\n\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;      \n\trefcyc_per_pte_group_vblank_c = get_refcyc_per_pte_group_vblank_c_in_us(mode_lib, e2e_pipe_param,\n\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;      \n\trefcyc_per_pte_group_flip_l = get_refcyc_per_pte_group_flip_l_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz;        \n\trefcyc_per_pte_group_flip_c = get_refcyc_per_pte_group_flip_c_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz;        \n\n\trefcyc_per_meta_chunk_nom_l = get_refcyc_per_meta_chunk_nom_l_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz;        \n\trefcyc_per_meta_chunk_nom_c = get_refcyc_per_meta_chunk_nom_c_in_us(mode_lib, e2e_pipe_param, num_pipes,\n\t\t\tpipe_idx) * refclk_freq_in_mhz;        \n\trefcyc_per_meta_chunk_vblank_l = get_refcyc_per_meta_chunk_vblank_l_in_us(mode_lib, e2e_pipe_param,\n\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;     \n\trefcyc_per_meta_chunk_vblank_c = get_refcyc_per_meta_chunk_vblank_c_in_us(mode_lib, e2e_pipe_param,\n\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;     \n\trefcyc_per_meta_chunk_flip_l = get_refcyc_per_meta_chunk_flip_l_in_us(mode_lib, e2e_pipe_param,\n\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;       \n\trefcyc_per_meta_chunk_flip_c = get_refcyc_per_meta_chunk_flip_c_in_us(mode_lib, e2e_pipe_param,\n\t\t\tnum_pipes, pipe_idx) * refclk_freq_in_mhz;       \n\n\tdlg_regs->dst_y_per_pte_row_nom_l = dst_y_per_pte_row_nom_l * dml_pow(2, 2);\n\tdlg_regs->dst_y_per_pte_row_nom_c = dst_y_per_pte_row_nom_c * dml_pow(2, 2);\n\tdlg_regs->dst_y_per_meta_row_nom_l = dst_y_per_meta_row_nom_l * dml_pow(2, 2);\n\tdlg_regs->dst_y_per_meta_row_nom_c = dst_y_per_meta_row_nom_c * dml_pow(2, 2);\n\tdlg_regs->refcyc_per_pte_group_nom_l = refcyc_per_pte_group_nom_l;\n\tdlg_regs->refcyc_per_pte_group_nom_c = refcyc_per_pte_group_nom_c;\n\tdlg_regs->refcyc_per_pte_group_vblank_l = refcyc_per_pte_group_vblank_l;\n\tdlg_regs->refcyc_per_pte_group_vblank_c = refcyc_per_pte_group_vblank_c;\n\tdlg_regs->refcyc_per_pte_group_flip_l = refcyc_per_pte_group_flip_l;\n\tdlg_regs->refcyc_per_pte_group_flip_c = refcyc_per_pte_group_flip_c;\n\tdlg_regs->refcyc_per_meta_chunk_nom_l = refcyc_per_meta_chunk_nom_l;\n\tdlg_regs->refcyc_per_meta_chunk_nom_c = refcyc_per_meta_chunk_nom_c;\n\tdlg_regs->refcyc_per_meta_chunk_vblank_l = refcyc_per_meta_chunk_vblank_l;\n\tdlg_regs->refcyc_per_meta_chunk_vblank_c = refcyc_per_meta_chunk_vblank_c;\n\tdlg_regs->refcyc_per_meta_chunk_flip_l = refcyc_per_meta_chunk_flip_l;\n\tdlg_regs->refcyc_per_meta_chunk_flip_c = refcyc_per_meta_chunk_flip_c;\n\tdlg_regs->refcyc_per_line_delivery_pre_l = (unsigned int) dml_floor(refcyc_per_line_delivery_pre_l, 1);\n\tdlg_regs->refcyc_per_line_delivery_l = (unsigned int) dml_floor(refcyc_per_line_delivery_l, 1);\n\tdlg_regs->refcyc_per_line_delivery_pre_c = (unsigned int) dml_floor(refcyc_per_line_delivery_pre_c, 1);\n\tdlg_regs->refcyc_per_line_delivery_c = (unsigned int) dml_floor(refcyc_per_line_delivery_c, 1);\n\n\tdlg_regs->chunk_hdl_adjust_cur0 = 3;\n\tdlg_regs->dst_y_offset_cur0 = 0;\n\tdlg_regs->chunk_hdl_adjust_cur1 = 3;\n\tdlg_regs->dst_y_offset_cur1 = 0;\n\n\tdlg_regs->dst_y_delta_drq_limit = 0x7fff; \n\n\tttu_regs->refcyc_per_req_delivery_pre_l = (unsigned int) (refcyc_per_req_delivery_pre_l * dml_pow(2, 10));\n\tttu_regs->refcyc_per_req_delivery_l = (unsigned int) (refcyc_per_req_delivery_l * dml_pow(2, 10));\n\tttu_regs->refcyc_per_req_delivery_pre_c = (unsigned int) (refcyc_per_req_delivery_pre_c * dml_pow(2, 10));\n\tttu_regs->refcyc_per_req_delivery_c = (unsigned int) (refcyc_per_req_delivery_c * dml_pow(2, 10));\n\tttu_regs->refcyc_per_req_delivery_pre_cur0 =\n\t\t\t(unsigned int) (refcyc_per_req_delivery_pre_cur0 * dml_pow(2, 10));\n\tttu_regs->refcyc_per_req_delivery_cur0 = (unsigned int) (refcyc_per_req_delivery_cur0 * dml_pow(2, 10));\n\tttu_regs->refcyc_per_req_delivery_pre_cur1 = 0;\n\tttu_regs->refcyc_per_req_delivery_cur1 = 0;\n\tttu_regs->qos_level_low_wm = 0;\n\n\tttu_regs->qos_level_high_wm = (unsigned int) (4.0 * (double) htotal * ref_freq_to_pix_freq);\n\n\tttu_regs->qos_level_flip = 14;\n\tttu_regs->qos_level_fixed_l = 8;\n\tttu_regs->qos_level_fixed_c = 8;\n\tttu_regs->qos_level_fixed_cur0 = 8;\n\tttu_regs->qos_ramp_disable_l = 0;\n\tttu_regs->qos_ramp_disable_c = 0;\n\tttu_regs->qos_ramp_disable_cur0 = 0;\n\tttu_regs->min_ttu_vblank = min_ttu_vblank * refclk_freq_in_mhz;\n\n\t\n\tASSERT(refcyc_per_req_delivery_pre_l < dml_pow(2, 13));\n\tASSERT(refcyc_per_req_delivery_l < dml_pow(2, 13));\n\tASSERT(refcyc_per_req_delivery_pre_c < dml_pow(2, 13));\n\tASSERT(refcyc_per_req_delivery_c < dml_pow(2, 13));\n\tif (dlg_regs->refcyc_per_vm_group_vblank >= (unsigned int) dml_pow(2, 23))\n\t\tdlg_regs->refcyc_per_vm_group_vblank = dml_pow(2, 23) - 1;\n\n\tif (dlg_regs->refcyc_per_vm_group_flip >= (unsigned int) dml_pow(2, 23))\n\t\tdlg_regs->refcyc_per_vm_group_flip = dml_pow(2, 23) - 1;\n\n\tif (dlg_regs->refcyc_per_vm_req_vblank >= (unsigned int) dml_pow(2, 23))\n\t\tdlg_regs->refcyc_per_vm_req_vblank = dml_pow(2, 23) - 1;\n\n\tif (dlg_regs->refcyc_per_vm_req_flip >= (unsigned int) dml_pow(2, 23))\n\t\tdlg_regs->refcyc_per_vm_req_flip = dml_pow(2, 23) - 1;\n\n\tASSERT(dlg_regs->dst_y_after_scaler < (unsigned int) 8);\n\tASSERT(dlg_regs->refcyc_x_after_scaler < (unsigned int)dml_pow(2, 13));\n\tASSERT(dlg_regs->dst_y_per_pte_row_nom_l < (unsigned int)dml_pow(2, 17));\n\tif (dual_plane) {\n\t\tif (dlg_regs->dst_y_per_pte_row_nom_c >= (unsigned int) dml_pow(2, 17)) {\n\t\t\t\n\t\t\tdml_print(\"DML_DLG: %s: Warning dst_y_per_pte_row_nom_c %u > register max U15.2 %u\\n\",\n\t\t\t\t\t__func__, dlg_regs->dst_y_per_pte_row_nom_c, (unsigned int)dml_pow(2, 17) - 1);\n\t\t}\n\t}\n\tASSERT(dlg_regs->dst_y_per_meta_row_nom_l < (unsigned int)dml_pow(2, 17));\n\tASSERT(dlg_regs->dst_y_per_meta_row_nom_c < (unsigned int)dml_pow(2, 17));\n\n\tif (dlg_regs->refcyc_per_pte_group_nom_l >= (unsigned int) dml_pow(2, 23))\n\t\tdlg_regs->refcyc_per_pte_group_nom_l = dml_pow(2, 23) - 1;\n\tif (dual_plane) {\n\t\tif (dlg_regs->refcyc_per_pte_group_nom_c >= (unsigned int) dml_pow(2, 23))\n\t\t\tdlg_regs->refcyc_per_pte_group_nom_c = dml_pow(2, 23) - 1;\n\t}\n\tASSERT(dlg_regs->refcyc_per_pte_group_vblank_l < (unsigned int)dml_pow(2, 13));\n\tif (dual_plane) {\n\t\tASSERT(dlg_regs->refcyc_per_pte_group_vblank_c < (unsigned int)dml_pow(2, 13));\n\t}\n\n\tif (dlg_regs->refcyc_per_meta_chunk_nom_l >= (unsigned int) dml_pow(2, 23))\n\t\tdlg_regs->refcyc_per_meta_chunk_nom_l = dml_pow(2, 23) - 1;\n\tif (dual_plane) {\n\t\tif (dlg_regs->refcyc_per_meta_chunk_nom_c >= (unsigned int) dml_pow(2, 23))\n\t\t\tdlg_regs->refcyc_per_meta_chunk_nom_c = dml_pow(2, 23) - 1;\n\t}\n\tASSERT(dlg_regs->refcyc_per_meta_chunk_vblank_l < (unsigned int)dml_pow(2, 13));\n\tASSERT(dlg_regs->refcyc_per_meta_chunk_vblank_c < (unsigned int)dml_pow(2, 13));\n\tASSERT(dlg_regs->refcyc_per_line_delivery_pre_l < (unsigned int)dml_pow(2, 13));\n\tASSERT(dlg_regs->refcyc_per_line_delivery_l < (unsigned int)dml_pow(2, 13));\n\tASSERT(dlg_regs->refcyc_per_line_delivery_pre_c < (unsigned int)dml_pow(2, 13));\n\tASSERT(dlg_regs->refcyc_per_line_delivery_c < (unsigned int)dml_pow(2, 13));\n\tASSERT(ttu_regs->qos_level_low_wm < dml_pow(2, 14));\n\tASSERT(ttu_regs->qos_level_high_wm < dml_pow(2, 14));\n\tASSERT(ttu_regs->min_ttu_vblank < dml_pow(2, 24));\n\n\tprint__ttu_regs_st(mode_lib, ttu_regs);\n\tprint__dlg_regs_st(mode_lib, dlg_regs);\n\tdml_print(\"DML_DLG::%s: Calculation for pipe[%d] done, num_pipes=%d\\n\", __func__, pipe_idx, num_pipes);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}