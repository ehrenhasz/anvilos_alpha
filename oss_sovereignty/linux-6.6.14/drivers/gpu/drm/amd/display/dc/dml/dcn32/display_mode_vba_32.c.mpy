{
  "module_name": "display_mode_vba_32.c",
  "hash_id": "a574390589c7282506f91c9db8c25a655078251c85226fd6aed5aa71158f4be7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/dcn32/display_mode_vba_32.c",
  "human_readable_source": " \n\n#include \"dc.h\"\n#include \"../display_mode_lib.h\"\n#include \"display_mode_vba_32.h\"\n#include \"../dml_inline_defs.h\"\n#include \"display_mode_vba_util_32.h\"\n\nvoid dml32_recalculate(struct display_mode_lib *mode_lib);\nstatic void DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation(\n\t\tstruct display_mode_lib *mode_lib);\nvoid dml32_ModeSupportAndSystemConfigurationFull(struct display_mode_lib *mode_lib);\n\nvoid dml32_recalculate(struct display_mode_lib *mode_lib)\n{\n\tModeSupportAndSystemConfiguration(mode_lib);\n\n\tdml32_CalculateMaxDETAndMinCompressedBufferSize(mode_lib->vba.ConfigReturnBufferSizeInKByte,\n\t\t\tmode_lib->vba.ROBBufferSizeInKByte,\n\t\t\tDC__NUM_DPP,\n\t\t\tfalse, \n\t\t\t0, \n\n\t\t\t \n\t\t\t&mode_lib->vba.MaxTotalDETInKByte, &mode_lib->vba.nomDETInKByte,\n\t\t\t&mode_lib->vba.MinCompressedBufferSizeInKByte);\n\n\tPixelClockAdjustmentForProgressiveToInterlaceUnit(mode_lib);\n#ifdef __DML_VBA_DEBUG__\n\tdml_print(\"DML::%s: Calling DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\\n\", __func__);\n#endif\n\tDISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation(mode_lib);\n}\n\nstatic void DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation(\n\t\tstruct display_mode_lib *mode_lib)\n{\n\tstruct vba_vars_st *v = &mode_lib->vba;\n\tunsigned int j, k;\n\tbool ImmediateFlipRequirementFinal;\n\tint iteration;\n\tdouble MaxTotalRDBandwidth;\n\tunsigned int NextPrefetchMode;\n\tdouble MaxTotalRDBandwidthNoUrgentBurst = 0.0;\n\tbool DestinationLineTimesForPrefetchLessThan2 = false;\n\tbool VRatioPrefetchMoreThanMax = false;\n\tdouble TWait;\n\tdouble TotalWRBandwidth = 0;\n\tdouble WRBandwidth = 0;\n\n#ifdef __DML_VBA_DEBUG__\n\tdml_print(\"DML::%s: --- START ---\\n\", __func__);\n\tdml_print(\"DML::%s: mode_lib->vba.PrefetchMode = %d\\n\", __func__, mode_lib->vba.PrefetchMode);\n\tdml_print(\"DML::%s: mode_lib->vba.ImmediateFlipSupport = %d\\n\", __func__, mode_lib->vba.ImmediateFlipSupport);\n\tdml_print(\"DML::%s: mode_lib->vba.VoltageLevel = %d\\n\", __func__, mode_lib->vba.VoltageLevel);\n#endif\n\n\tv->WritebackDISPCLK = 0.0;\n\tv->GlobalDPPCLK = 0.0;\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tif (mode_lib->vba.WritebackEnable[k]) {\n\t\t\tv->WritebackDISPCLK = dml_max(v->WritebackDISPCLK,\n\t\t\t\t\tdml32_CalculateWriteBackDISPCLK(\n\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[k],\n\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k], mode_lib->vba.WritebackHRatio[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackHTaps[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackVTaps[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackSourceWidth[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[k],\n\t\t\t\t\t\t\tmode_lib->vba.HTotal[k], mode_lib->vba.WritebackLineBufferSize,\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed));\n\t\t}\n\t}\n\n\tv->DISPCLK_calculated = v->WritebackDISPCLK;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\tv->DISPCLK_calculated = dml_max(v->DISPCLK_calculated,\n\t\t\t\t\tdml32_CalculateRequiredDispclk(\n\t\t\t\t\t\t\tmode_lib->vba.ODMCombineEnabled[k],\n\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading,\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLKRampingMargin,\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed,\n\t\t\t\t\t\t\tmode_lib->vba.MaxDppclk[v->soc.num_states - 1]));\n\t\t}\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tdml32_CalculateSinglePipeDPPCLKAndSCLThroughput(mode_lib->vba.HRatio[k],\n\t\t\t\tmode_lib->vba.HRatioChroma[k],\n\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\tmode_lib->vba.VRatioChroma[k],\n\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput,\n\t\t\t\tmode_lib->vba.MaxPSCLToLBThroughput,\n\t\t\t\tmode_lib->vba.PixelClock[k],\n\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\tmode_lib->vba.htaps[k],\n\t\t\t\tmode_lib->vba.HTAPsChroma[k],\n\t\t\t\tmode_lib->vba.vtaps[k],\n\t\t\t\tmode_lib->vba.VTAPsChroma[k],\n\n\t\t\t\t \n\t\t\t\t&v->PSCL_THROUGHPUT_LUMA[k], &v->PSCL_THROUGHPUT_CHROMA[k],\n\t\t\t\t&v->DPPCLKUsingSingleDPP[k]);\n\t}\n\n\tdml32_CalculateDPPCLK(mode_lib->vba.NumberOfActiveSurfaces, mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading,\n\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed, v->DPPCLKUsingSingleDPP, mode_lib->vba.DPPPerPlane,\n\t\t\t \n\t\t\t&v->GlobalDPPCLK, v->DPPCLK);\n\n\tfor (k = 0; k < v->NumberOfActiveSurfaces; ++k) {\n\t\tv->DPPCLK_calculated[k] = v->DPPCLK[k];\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tdml32_CalculateBytePerPixelAndBlockSizes(\n\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\tmode_lib->vba.SurfaceTiling[k],\n\n\t\t\t\t \n\t\t\t\t&v->BytePerPixelY[k],\n\t\t\t\t&v->BytePerPixelC[k],\n\t\t\t\t&v->BytePerPixelDETY[k],\n\t\t\t\t&v->BytePerPixelDETC[k],\n\t\t\t\t&v->BlockHeight256BytesY[k],\n\t\t\t\t&v->BlockHeight256BytesC[k],\n\t\t\t\t&v->BlockWidth256BytesY[k],\n\t\t\t\t&v->BlockWidth256BytesC[k],\n\t\t\t\t&v->BlockHeightY[k],\n\t\t\t\t&v->BlockHeightC[k],\n\t\t\t\t&v->BlockWidthY[k],\n\t\t\t\t&v->BlockWidthC[k]);\n\t}\n\n#ifdef __DML_VBA_DEBUG__\n\tdml_print(\"DML::%s: %d\\n\", __func__, __LINE__);\n#endif\n\tdml32_CalculateSwathWidth(\n\t\t\tfalse,  \n\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\tmode_lib->vba.SourcePixelFormat,\n\t\t\tmode_lib->vba.SourceRotation,\n\t\t\tmode_lib->vba.ViewportStationary,\n\t\t\tmode_lib->vba.ViewportWidth,\n\t\t\tmode_lib->vba.ViewportHeight,\n\t\t\tmode_lib->vba.ViewportXStartY,\n\t\t\tmode_lib->vba.ViewportYStartY,\n\t\t\tmode_lib->vba.ViewportXStartC,\n\t\t\tmode_lib->vba.ViewportYStartC,\n\t\t\tmode_lib->vba.SurfaceWidthY,\n\t\t\tmode_lib->vba.SurfaceWidthC,\n\t\t\tmode_lib->vba.SurfaceHeightY,\n\t\t\tmode_lib->vba.SurfaceHeightC,\n\t\t\tmode_lib->vba.ODMCombineEnabled,\n\t\t\tv->BytePerPixelY,\n\t\t\tv->BytePerPixelC,\n\t\t\tv->BlockHeight256BytesY,\n\t\t\tv->BlockHeight256BytesC,\n\t\t\tv->BlockWidth256BytesY,\n\t\t\tv->BlockWidth256BytesC,\n\t\t\tmode_lib->vba.BlendingAndTiming,\n\t\t\tmode_lib->vba.HActive,\n\t\t\tmode_lib->vba.HRatio,\n\t\t\tmode_lib->vba.DPPPerPlane,\n\n\t\t\t \n\t\t\tv->SwathWidthSingleDPPY, v->SwathWidthSingleDPPC, v->SwathWidthY, v->SwathWidthC,\n\t\t\tv->dummy_vars\n\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t.dummy_integer_array[0], \n\t\t\tv->dummy_vars\n\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t.dummy_integer_array[1], \n\t\t\tv->swath_width_luma_ub, v->swath_width_chroma_ub);\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tv->ReadBandwidthSurfaceLuma[k] = v->SwathWidthSingleDPPY[k] * v->BytePerPixelY[k]\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]) * mode_lib->vba.VRatio[k];\n\t\tv->ReadBandwidthSurfaceChroma[k] = v->SwathWidthSingleDPPC[k] * v->BytePerPixelC[k]\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k])\n\t\t\t\t* mode_lib->vba.VRatioChroma[k];\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: ReadBandwidthSurfaceLuma[%i] = %fBps\\n\",\n\t\t\t\t__func__, k, v->ReadBandwidthSurfaceLuma[k]);\n\t\tdml_print(\"DML::%s: ReadBandwidthSurfaceChroma[%i] = %fBps\\n\",\n\t\t\t\t__func__, k, v->ReadBandwidthSurfaceChroma[k]);\n#endif\n\t}\n\n\t{\n\t\t\n\t\t\n\t\tdml32_CalculateSwathAndDETConfiguration(\n\t\t\t\tmode_lib->vba.DETSizeOverride,\n\t\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\t\tmode_lib->vba.ConfigReturnBufferSizeInKByte,\n\t\t\t\tmode_lib->vba.MaxTotalDETInKByte,\n\t\t\t\tmode_lib->vba.MinCompressedBufferSizeInKByte,\n\t\t\t\tfalse,  \n\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\tmode_lib->vba.nomDETInKByte,\n\t\t\t\tmode_lib->vba.UseUnboundedRequesting,\n\t\t\t\tmode_lib->vba.DisableUnboundRequestIfCompBufReservedSpaceNeedAdjustment,\n\t\t\t\tmode_lib->vba.ip.pixel_chunk_size_kbytes,\n\t\t\t\tmode_lib->vba.ip.rob_buffer_size_kbytes,\n\t\t\t\tmode_lib->vba.CompressedBufferSegmentSizeInkByteFinal,\n\t\t\t\tv->dummy_vars\n\t\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t.dummy_output_encoder_array,  \n\t\t\t\tv->ReadBandwidthSurfaceLuma,\n\t\t\t\tv->ReadBandwidthSurfaceChroma,\n\t\t\t\tv->dummy_vars\n\t\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t.dummy_single_array[0],  \n\t\t\t\tv->dummy_vars\n\t\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t.dummy_single_array[1],  \n\t\t\t\tmode_lib->vba.SourceRotation,\n\t\t\t\tmode_lib->vba.ViewportStationary,\n\t\t\t\tmode_lib->vba.SourcePixelFormat,\n\t\t\t\tmode_lib->vba.SurfaceTiling,\n\t\t\t\tmode_lib->vba.ViewportWidth,\n\t\t\t\tmode_lib->vba.ViewportHeight,\n\t\t\t\tmode_lib->vba.ViewportXStartY,\n\t\t\t\tmode_lib->vba.ViewportYStartY,\n\t\t\t\tmode_lib->vba.ViewportXStartC,\n\t\t\t\tmode_lib->vba.ViewportYStartC,\n\t\t\t\tmode_lib->vba.SurfaceWidthY,\n\t\t\t\tmode_lib->vba.SurfaceWidthC,\n\t\t\t\tmode_lib->vba.SurfaceHeightY,\n\t\t\t\tmode_lib->vba.SurfaceHeightC,\n\t\t\t\tv->BlockHeight256BytesY,\n\t\t\t\tv->BlockHeight256BytesC,\n\t\t\t\tv->BlockWidth256BytesY,\n\t\t\t\tv->BlockWidth256BytesC,\n\t\t\t\tmode_lib->vba.ODMCombineEnabled,\n\t\t\t\tmode_lib->vba.BlendingAndTiming,\n\t\t\t\tv->BytePerPixelY,\n\t\t\t\tv->BytePerPixelC,\n\t\t\t\tv->BytePerPixelDETY,\n\t\t\t\tv->BytePerPixelDETC,\n\t\t\t\tmode_lib->vba.HActive,\n\t\t\t\tmode_lib->vba.HRatio,\n\t\t\t\tmode_lib->vba.HRatioChroma,\n\t\t\t\tmode_lib->vba.DPPPerPlane,\n\n\t\t\t\t \n\t\t\t\tv->dummy_vars\n\t\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t.dummy_long_array[0],  \n\t\t\t\tv->dummy_vars\n\t\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t.dummy_long_array[1],  \n\t\t\t\tv->dummy_vars\n\t\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t.dummy_double_array[0],  \n\t\t\t\tv->dummy_vars\n\t\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t.dummy_double_array[1],  \n\t\t\t\tmode_lib->vba.SwathHeightY,\n\t\t\t\tmode_lib->vba.SwathHeightC,\n\t\t\t\tmode_lib->vba.DETBufferSizeInKByte,\n\t\t\t\tmode_lib->vba.DETBufferSizeY,\n\t\t\t\tmode_lib->vba.DETBufferSizeC,\n\t\t\t\t&v->UnboundedRequestEnabled,\n\t\t\t\t&v->CompressedBufferSizeInkByte,\n\t\t\t\t&v->CompBufReservedSpaceKBytes,\n\t\t\t\t&v->dummy_vars\n\t\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t.dummy_boolean,        \n\t\t\t\tv->dummy_vars\n\t\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t.dummy_boolean_array,  \n\t\t\t\t&v->dummy_vars\n\t\t\t\t\t .DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t\t .dummy_boolean);  \n\t}\n\n\tv->CompBufReservedSpaceZs     = v->CompBufReservedSpaceKBytes * 1024.0 / 256.0;\n\tv->CompBufReservedSpace64B    = v->CompBufReservedSpaceKBytes * 1024.0 / 64.0;\n\n\t\n\tdml32_CalculateDCFCLKDeepSleep(\n\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\tv->BytePerPixelY,\n\t\t\tv->BytePerPixelC,\n\t\t\tmode_lib->vba.VRatio,\n\t\t\tmode_lib->vba.VRatioChroma,\n\t\t\tv->SwathWidthY,\n\t\t\tv->SwathWidthC,\n\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\tmode_lib->vba.HRatio,\n\t\t\tmode_lib->vba.HRatioChroma,\n\t\t\tmode_lib->vba.PixelClock,\n\t\t\tv->PSCL_THROUGHPUT_LUMA,\n\t\t\tv->PSCL_THROUGHPUT_CHROMA,\n\t\t\tmode_lib->vba.DPPCLK,\n\t\t\tv->ReadBandwidthSurfaceLuma,\n\t\t\tv->ReadBandwidthSurfaceChroma,\n\t\t\tmode_lib->vba.ReturnBusWidth,\n\n\t\t\t \n\t\t\t&v->DCFCLKDeepSleep);\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tif ((mode_lib->vba.BlendingAndTiming[k] != k) || !mode_lib->vba.DSCEnabled[k]) {\n\t\t\tv->DSCCLK_calculated[k] = 0.0;\n\t\t} else {\n\t\t\tif (mode_lib->vba.OutputFormat[k] == dm_420)\n\t\t\t\tmode_lib->vba.DSCFormatFactor = 2;\n\t\t\telse if (mode_lib->vba.OutputFormat[k] == dm_444)\n\t\t\t\tmode_lib->vba.DSCFormatFactor = 1;\n\t\t\telse if (mode_lib->vba.OutputFormat[k] == dm_n422)\n\t\t\t\tmode_lib->vba.DSCFormatFactor = 2;\n\t\t\telse\n\t\t\t\tmode_lib->vba.DSCFormatFactor = 1;\n\t\t\tif (mode_lib->vba.ODMCombineEnabled[k] == dm_odm_combine_mode_4to1)\n\t\t\t\tv->DSCCLK_calculated[k] = mode_lib->vba.PixelClockBackEnd[k] / 12\n\t\t\t\t\t\t/ mode_lib->vba.DSCFormatFactor\n\t\t\t\t\t\t/ (1 - mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100);\n\t\t\telse if (mode_lib->vba.ODMCombineEnabled[k] == dm_odm_combine_mode_2to1)\n\t\t\t\tv->DSCCLK_calculated[k] = mode_lib->vba.PixelClockBackEnd[k] / 6\n\t\t\t\t\t\t/ mode_lib->vba.DSCFormatFactor\n\t\t\t\t\t\t/ (1 - mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100);\n\t\t\telse\n\t\t\t\tv->DSCCLK_calculated[k] = mode_lib->vba.PixelClockBackEnd[k] / 3\n\t\t\t\t\t\t/ mode_lib->vba.DSCFormatFactor\n\t\t\t\t\t\t/ (1 - mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100);\n\t\t}\n\t}\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tv->DSCDelay[k] = dml32_DSCDelayRequirement(mode_lib->vba.DSCEnabled[k],\n\t\t\t\tmode_lib->vba.ODMCombineEnabled[k], mode_lib->vba.DSCInputBitPerComponent[k],\n\t\t\t\tmode_lib->vba.OutputBppPerState[mode_lib->vba.VoltageLevel][k],\n\t\t\t\tmode_lib->vba.HActive[k], mode_lib->vba.HTotal[k],\n\t\t\t\tmode_lib->vba.NumberOfDSCSlices[k], mode_lib->vba.OutputFormat[k],\n\t\t\t\tmode_lib->vba.Output[k], mode_lib->vba.PixelClock[k],\n\t\t\t\tmode_lib->vba.PixelClockBackEnd[k], mode_lib->vba.ip.dsc_delay_factor_wa);\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k)\n\t\tfor (j = 0; j < mode_lib->vba.NumberOfActiveSurfaces; ++j) \n\t\t\tif (j != k && mode_lib->vba.BlendingAndTiming[k] == j && mode_lib->vba.DSCEnabled[j])\n\t\t\t\tv->DSCDelay[k] = v->DSCDelay[j];\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tv->ImmediateFlipSupportedSurface[k] = mode_lib->vba.ImmediateFlipSupport\n\t\t\t\t&& (mode_lib->vba.ImmediateFlipRequirement[k] != dm_immediate_flip_not_required);\n\t}\n\n\t\n\tdml32_CalculateSurfaceSizeInMall(\n\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\tmode_lib->vba.MALLAllocatedForDCNFinal,\n\t\t\t\tmode_lib->vba.UseMALLForStaticScreen,\n\t\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\t\tmode_lib->vba.DCCEnable,\n\t\t\t\tmode_lib->vba.ViewportStationary,\n\t\t\t\tmode_lib->vba.ViewportXStartY,\n\t\t\t\tmode_lib->vba.ViewportYStartY,\n\t\t\t\tmode_lib->vba.ViewportXStartC,\n\t\t\t\tmode_lib->vba.ViewportYStartC,\n\t\t\t\tmode_lib->vba.ViewportWidth,\n\t\t\t\tmode_lib->vba.ViewportHeight,\n\t\t\t\tv->BytePerPixelY,\n\t\t\t\tmode_lib->vba.ViewportWidthChroma,\n\t\t\t\tmode_lib->vba.ViewportHeightChroma,\n\t\t\t\tv->BytePerPixelC,\n\t\t\t\tmode_lib->vba.SurfaceWidthY,\n\t\t\t\tmode_lib->vba.SurfaceWidthC,\n\t\t\t\tmode_lib->vba.SurfaceHeightY,\n\t\t\t\tmode_lib->vba.SurfaceHeightC,\n\t\t\t\tv->BlockWidth256BytesY,\n\t\t\t\tv->BlockWidth256BytesC,\n\t\t\t\tv->BlockHeight256BytesY,\n\t\t\t\tv->BlockHeight256BytesC,\n\t\t\t\tv->BlockWidthY,\n\t\t\t\tv->BlockWidthC,\n\t\t\t\tv->BlockHeightY,\n\t\t\t\tv->BlockHeightC,\n\t\t\t\tmode_lib->vba.DCCMetaPitchY,\n\t\t\t\tmode_lib->vba.DCCMetaPitchC,\n\n\t\t\t\t \n\t\t\t\tv->SurfaceSizeInMALL,\n\t\t\t\t&v->dummy_vars.\n\t\t\t\tDISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t.dummy_boolean2);  \n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].PixelClock = mode_lib->vba.PixelClock[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].DPPPerSurface = mode_lib->vba.DPPPerPlane[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].SourceRotation = mode_lib->vba.SourceRotation[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].ViewportHeight = mode_lib->vba.ViewportHeight[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].ViewportHeightChroma = mode_lib->vba.ViewportHeightChroma[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BlockWidth256BytesY = v->BlockWidth256BytesY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BlockHeight256BytesY = v->BlockHeight256BytesY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BlockWidth256BytesC = v->BlockWidth256BytesC[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BlockHeight256BytesC = v->BlockHeight256BytesC[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BlockWidthY = v->BlockWidthY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BlockHeightY = v->BlockHeightY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BlockWidthC = v->BlockWidthC[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BlockHeightC = v->BlockHeightC[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].InterlaceEnable = mode_lib->vba.Interlace[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].HTotal = mode_lib->vba.HTotal[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].DCCEnable = mode_lib->vba.DCCEnable[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].SourcePixelFormat = mode_lib->vba.SourcePixelFormat[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].SurfaceTiling = mode_lib->vba.SurfaceTiling[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BytePerPixelY = v->BytePerPixelY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].BytePerPixelC = v->BytePerPixelC[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].ProgressiveToInterlaceUnitInOPP = mode_lib->vba.ProgressiveToInterlaceUnitInOPP;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].VRatio = mode_lib->vba.VRatio[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].VRatioChroma = mode_lib->vba.VRatioChroma[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].VTaps = mode_lib->vba.vtaps[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].VTapsChroma = mode_lib->vba.VTAPsChroma[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].PitchY = mode_lib->vba.PitchY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].DCCMetaPitchY = mode_lib->vba.DCCMetaPitchY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].PitchC = mode_lib->vba.PitchC[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].DCCMetaPitchC = mode_lib->vba.DCCMetaPitchC[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].ViewportStationary = mode_lib->vba.ViewportStationary[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].ViewportXStart = mode_lib->vba.ViewportXStartY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].ViewportYStart = mode_lib->vba.ViewportYStartY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].ViewportXStartC = mode_lib->vba.ViewportXStartC[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].ViewportYStartC = mode_lib->vba.ViewportYStartC[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].FORCE_ONE_ROW_FOR_FRAME = mode_lib->vba.ForceOneRowForFrame[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].SwathHeightY = mode_lib->vba.SwathHeightY[k];\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters[k].SwathHeightC = mode_lib->vba.SwathHeightC[k];\n\t}\n\n\t{\n\n\t\tdml32_CalculateVMRowAndSwath(\n\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.SurfaceParameters,\n\t\t\t\tv->SurfaceSizeInMALL,\n\t\t\t\tmode_lib->vba.PTEBufferSizeInRequestsLuma,\n\t\t\t\tmode_lib->vba.PTEBufferSizeInRequestsChroma,\n\t\t\t\tmode_lib->vba.DCCMetaBufferSizeBytes,\n\t\t\t\tmode_lib->vba.UseMALLForStaticScreen,\n\t\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\t\tmode_lib->vba.MALLAllocatedForDCNFinal,\n\t\t\t\tv->SwathWidthY,\n\t\t\t\tv->SwathWidthC,\n\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\tmode_lib->vba.HostVMEnable,\n\t\t\t\tmode_lib->vba.HostVMMaxNonCachedPageTableLevels,\n\t\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\t\tmode_lib->vba.GPUVMMinPageSizeKBytes,\n\t\t\t\tmode_lib->vba.HostVMMinPageSize,\n\n\t\t\t\t \n\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_boolean_array2[0],  \n\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_boolean_array2[1],  \n\t\t\t\tv->dpte_row_width_luma_ub,\n\t\t\t\tv->dpte_row_width_chroma_ub,\n\t\t\t\tv->dpte_row_height,\n\t\t\t\tv->dpte_row_height_chroma,\n\t\t\t\tv->dpte_row_height_linear,\n\t\t\t\tv->dpte_row_height_linear_chroma,\n\t\t\t\tv->meta_req_width,\n\t\t\t\tv->meta_req_width_chroma,\n\t\t\t\tv->meta_req_height,\n\t\t\t\tv->meta_req_height_chroma,\n\t\t\t\tv->meta_row_width,\n\t\t\t\tv->meta_row_width_chroma,\n\t\t\t\tv->meta_row_height,\n\t\t\t\tv->meta_row_height_chroma,\n\t\t\t\tv->vm_group_bytes,\n\t\t\t\tv->dpte_group_bytes,\n\t\t\t\tv->PixelPTEReqWidthY,\n\t\t\t\tv->PixelPTEReqHeightY,\n\t\t\t\tv->PTERequestSizeY,\n\t\t\t\tv->PixelPTEReqWidthC,\n\t\t\t\tv->PixelPTEReqHeightC,\n\t\t\t\tv->PTERequestSizeC,\n\t\t\t\tv->dpde0_bytes_per_frame_ub_l,\n\t\t\t\tv->meta_pte_bytes_per_frame_ub_l,\n\t\t\t\tv->dpde0_bytes_per_frame_ub_c,\n\t\t\t\tv->meta_pte_bytes_per_frame_ub_c,\n\t\t\t\tv->PrefetchSourceLinesY,\n\t\t\t\tv->PrefetchSourceLinesC,\n\t\t\t\tv->VInitPreFillY, v->VInitPreFillC,\n\t\t\t\tv->MaxNumSwathY,\n\t\t\t\tv->MaxNumSwathC,\n\t\t\t\tv->meta_row_bw,\n\t\t\t\tv->dpte_row_bw,\n\t\t\t\tv->PixelPTEBytesPerRow,\n\t\t\t\tv->PDEAndMetaPTEBytesFrame,\n\t\t\t\tv->MetaRowByte,\n\t\t\t\tv->Use_One_Row_For_Frame,\n\t\t\t\tv->Use_One_Row_For_Frame_Flip,\n\t\t\t\tv->UsesMALLForStaticScreen,\n\t\t\t\tv->PTE_BUFFER_MODE,\n\t\t\t\tv->BIGK_FRAGMENT_SIZE);\n\t}\n\n\n\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.ReorderBytes = mode_lib->vba.NumberOfChannels\n\t\t\t* dml_max3(mode_lib->vba.UrgentOutOfOrderReturnPerChannelPixelDataOnly,\n\t\t\t\t\tmode_lib->vba.UrgentOutOfOrderReturnPerChannelPixelMixedWithVMData,\n\t\t\t\t\tmode_lib->vba.UrgentOutOfOrderReturnPerChannelVMDataOnly);\n\n\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.VMDataOnlyReturnBW = dml32_get_return_bw_mbps_vm_only(\n\t\t\t&mode_lib->vba.soc,\n\t\t\tmode_lib->vba.VoltageLevel,\n\t\t\tmode_lib->vba.DCFCLK,\n\t\t\tmode_lib->vba.FabricClock,\n\t\t\tmode_lib->vba.DRAMSpeed);\n\n#ifdef __DML_VBA_DEBUG__\n\tdml_print(\"DML::%s: mode_lib->vba.ReturnBusWidth = %f\\n\", __func__, mode_lib->vba.ReturnBusWidth);\n\tdml_print(\"DML::%s: mode_lib->vba.DCFCLK = %f\\n\", __func__, mode_lib->vba.DCFCLK);\n\tdml_print(\"DML::%s: mode_lib->vba.FabricClock = %f\\n\", __func__, mode_lib->vba.FabricClock);\n\tdml_print(\"DML::%s: mode_lib->vba.FabricDatapathToDCNDataReturn = %f\\n\", __func__,\n\t\t\tmode_lib->vba.FabricDatapathToDCNDataReturn);\n\tdml_print(\"DML::%s: mode_lib->vba.PercentOfIdealSDPPortBWReceivedAfterUrgLatency = %f\\n\",\n\t\t\t__func__, mode_lib->vba.PercentOfIdealSDPPortBWReceivedAfterUrgLatency);\n\tdml_print(\"DML::%s: mode_lib->vba.DRAMSpeed = %f\\n\", __func__, mode_lib->vba.DRAMSpeed);\n\tdml_print(\"DML::%s: mode_lib->vba.NumberOfChannels = %f\\n\", __func__, mode_lib->vba.NumberOfChannels);\n\tdml_print(\"DML::%s: mode_lib->vba.DRAMChannelWidth = %f\\n\", __func__, mode_lib->vba.DRAMChannelWidth);\n\tdml_print(\"DML::%s: mode_lib->vba.PercentOfIdealDRAMBWReceivedAfterUrgLatencyVMDataOnly = %f\\n\",\n\t\t\t__func__, mode_lib->vba.PercentOfIdealDRAMBWReceivedAfterUrgLatencyVMDataOnly);\n\tdml_print(\"DML::%s: VMDataOnlyReturnBW = %f\\n\", __func__, VMDataOnlyReturnBW);\n\tdml_print(\"DML::%s: ReturnBW = %f\\n\", __func__, mode_lib->vba.ReturnBW);\n#endif\n\n\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.HostVMInefficiencyFactor = 1.0;\n\n\tif (mode_lib->vba.GPUVMEnable && mode_lib->vba.HostVMEnable)\n\t\tv->dummy_vars\n\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t.HostVMInefficiencyFactor =\n\t\t\tmode_lib->vba.ReturnBW / v->dummy_vars\n\t\t\t\t.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation\n\t\t\t\t.VMDataOnlyReturnBW;\n\n\tmode_lib->vba.TotalDCCActiveDPP = 0;\n\tmode_lib->vba.TotalActiveDPP = 0;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tmode_lib->vba.TotalActiveDPP = mode_lib->vba.TotalActiveDPP + mode_lib->vba.DPPPerPlane[k];\n\t\tif (mode_lib->vba.DCCEnable[k])\n\t\t\tmode_lib->vba.TotalDCCActiveDPP = mode_lib->vba.TotalDCCActiveDPP\n\t\t\t\t\t+ mode_lib->vba.DPPPerPlane[k];\n\t}\n\n\tv->UrgentExtraLatency = dml32_CalculateExtraLatency(\n\t\t\tmode_lib->vba.RoundTripPingLatencyCycles,\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.ReorderBytes,\n\t\t\tmode_lib->vba.DCFCLK,\n\t\t\tmode_lib->vba.TotalActiveDPP,\n\t\t\tmode_lib->vba.PixelChunkSizeInKByte,\n\t\t\tmode_lib->vba.TotalDCCActiveDPP,\n\t\t\tmode_lib->vba.MetaChunkSize,\n\t\t\tmode_lib->vba.ReturnBW,\n\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\tmode_lib->vba.HostVMEnable,\n\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\tv->dpte_group_bytes,\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.HostVMInefficiencyFactor,\n\t\t\tmode_lib->vba.HostVMMinPageSize,\n\t\t\tmode_lib->vba.HostVMMaxNonCachedPageTableLevels);\n\n\tmode_lib->vba.TCalc = 24.0 / v->DCFCLKDeepSleep;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\t\tv->WritebackDelay[mode_lib->vba.VoltageLevel][k] = mode_lib->vba.WritebackLatency\n\t\t\t\t\t\t+ dml32_CalculateWriteBackDelay(\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVTaps[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationHeight[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackSourceHeight[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.HTotal[k]) / mode_lib->vba.DISPCLK;\n\t\t\t} else\n\t\t\t\tv->WritebackDelay[mode_lib->vba.VoltageLevel][k] = 0;\n\t\t\tfor (j = 0; j < mode_lib->vba.NumberOfActiveSurfaces; ++j) {\n\t\t\t\tif (mode_lib->vba.BlendingAndTiming[j] == k &&\n\t\t\t\t\tmode_lib->vba.WritebackEnable[j] == true) {\n\t\t\t\t\tv->WritebackDelay[mode_lib->vba.VoltageLevel][k] =\n\t\t\t\t\t\tdml_max(v->WritebackDelay[mode_lib->vba.VoltageLevel][k],\n\t\t\t\t\t\tmode_lib->vba.WritebackLatency +\n\t\t\t\t\t\tdml32_CalculateWriteBackDelay(\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[j],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[j],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[j],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVTaps[j],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[j],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationHeight[j],\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackSourceHeight[j],\n\t\t\t\t\t\t\t\tmode_lib->vba.HTotal[k]) / mode_lib->vba.DISPCLK);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k)\n\t\tfor (j = 0; j < mode_lib->vba.NumberOfActiveSurfaces; ++j)\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == j)\n\t\t\t\tv->WritebackDelay[mode_lib->vba.VoltageLevel][k] =\n\t\t\t\t\t\tv->WritebackDelay[mode_lib->vba.VoltageLevel][j];\n\n\tv->UrgentLatency = dml32_CalculateUrgentLatency(mode_lib->vba.UrgentLatencyPixelDataOnly,\n\t\t\tmode_lib->vba.UrgentLatencyPixelMixedWithVMData,\n\t\t\tmode_lib->vba.UrgentLatencyVMDataOnly,\n\t\t\tmode_lib->vba.DoUrgentLatencyAdjustment,\n\t\t\tmode_lib->vba.UrgentLatencyAdjustmentFabricClockComponent,\n\t\t\tmode_lib->vba.UrgentLatencyAdjustmentFabricClockReference,\n\t\t\tmode_lib->vba.FabricClock);\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tdml32_CalculateUrgentBurstFactor(mode_lib->vba.UsesMALLForPStateChange[k],\n\t\t\t\tv->swath_width_luma_ub[k],\n\t\t\t\tv->swath_width_chroma_ub[k],\n\t\t\t\tmode_lib->vba.SwathHeightY[k],\n\t\t\t\tmode_lib->vba.SwathHeightC[k],\n\t\t\t\tmode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k],\n\t\t\t\tv->UrgentLatency,\n\t\t\t\tmode_lib->vba.CursorBufferSize,\n\t\t\t\tmode_lib->vba.CursorWidth[k][0],\n\t\t\t\tmode_lib->vba.CursorBPP[k][0],\n\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\tmode_lib->vba.VRatioChroma[k],\n\t\t\t\tv->BytePerPixelDETY[k],\n\t\t\t\tv->BytePerPixelDETC[k],\n\t\t\t\tmode_lib->vba.DETBufferSizeY[k],\n\t\t\t\tmode_lib->vba.DETBufferSizeC[k],\n\n\t\t\t\t \n\t\t\t\t&v->UrgBurstFactorCursor[k],\n\t\t\t\t&v->UrgBurstFactorLuma[k],\n\t\t\t\t&v->UrgBurstFactorChroma[k],\n\t\t\t\t&v->NoUrgentLatencyHiding[k]);\n\n\t\tv->cursor_bw[k] = mode_lib->vba.NumberOfCursors[k] * mode_lib->vba.CursorWidth[k][0] * mode_lib->vba.CursorBPP[k][0] / 8 / (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]) * mode_lib->vba.VRatio[k];\n\t}\n\n\tv->NotEnoughDETSwathFillLatencyHiding = dml32_CalculateDETSwathFillLatencyHiding(\n\t\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\t\tmode_lib->vba.ReturnBW,\n\t\t\t\t\t\tv->UrgentLatency,\n\t\t\t\t\t\tmode_lib->vba.SwathHeightY,\n\t\t\t\t\t\tmode_lib->vba.SwathHeightC,\n\t\t\t\t\t\tv->swath_width_luma_ub,\n\t\t\t\t\t\tv->swath_width_chroma_ub,\n\t\t\t\t\t\tv->BytePerPixelDETY,\n\t\t\t\t\t\tv->BytePerPixelDETC,\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeY,\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeC,\n\t\t\t\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\t\t\t\tmode_lib->vba.HTotal,\n\t\t\t\t\t\tmode_lib->vba.PixelClock,\n\t\t\t\t\t\tmode_lib->vba.VRatio,\n\t\t\t\t\t\tmode_lib->vba.VRatioChroma,\n\t\t\t\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\t\t\t\tmode_lib->vba.UseUnboundedRequesting);\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tv->MaxVStartupLines[k] = ((mode_lib->vba.Interlace[k] &&\n\t\t\t\t!mode_lib->vba.ProgressiveToInterlaceUnitInOPP) ?\n\t\t\t\tdml_floor((mode_lib->vba.VTotal[k] - mode_lib->vba.VActive[k]) / 2.0, 1.0) :\n\t\t\t\tmode_lib->vba.VTotal[k] - mode_lib->vba.VActive[k]) - dml_max(1.0,\n\t\t\t\tdml_ceil((double) v->WritebackDelay[mode_lib->vba.VoltageLevel][k]\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]), 1));\n\n\t\t\n\t\tif (v->MaxVStartupLines[k] > 1023)\n\t\t\tv->MaxVStartupLines[k] = 1023;\n\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: k=%d MaxVStartupLines = %d\\n\", __func__, k, v->MaxVStartupLines[k]);\n\t\tdml_print(\"DML::%s: k=%d VoltageLevel = %d\\n\", __func__, k, mode_lib->vba.VoltageLevel);\n\t\tdml_print(\"DML::%s: k=%d WritebackDelay = %f\\n\", __func__,\n\t\t\t\tk, v->WritebackDelay[mode_lib->vba.VoltageLevel][k]);\n#endif\n\t}\n\n\tv->MaximumMaxVStartupLines = 0;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k)\n\t\tv->MaximumMaxVStartupLines = dml_max(v->MaximumMaxVStartupLines, v->MaxVStartupLines[k]);\n\n\tImmediateFlipRequirementFinal = false;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tImmediateFlipRequirementFinal = ImmediateFlipRequirementFinal\n\t\t\t\t|| (mode_lib->vba.ImmediateFlipRequirement[k] == dm_immediate_flip_required);\n\t}\n#ifdef __DML_VBA_DEBUG__\n\tdml_print(\"DML::%s: ImmediateFlipRequirementFinal = %d\\n\", __func__, ImmediateFlipRequirementFinal);\n#endif\n\t\n\t\n\tdml32_CalculateMinAndMaxPrefetchMode(\n\t\t\tmode_lib->vba.AllowForPStateChangeOrStutterInVBlankFinal,\n\t\t\t&mode_lib->vba.MinPrefetchMode,\n\t\t\t&mode_lib->vba.MaxPrefetchMode);\n\n\tv->VStartupLines = __DML_VBA_MIN_VSTARTUP__;\n\n\titeration = 0;\n\tMaxTotalRDBandwidth = 0;\n\tNextPrefetchMode = mode_lib->vba.PrefetchModePerState[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb];\n\n\tdo {\n\t\tMaxTotalRDBandwidth = 0;\n\t\tDestinationLineTimesForPrefetchLessThan2 = false;\n\t\tVRatioPrefetchMoreThanMax = false;\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: Start loop: VStartup = %d\\n\", __func__, mode_lib->vba.VStartupLines);\n#endif\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t \n\t\t\tTWait = dml32_CalculateTWait(\n\t\t\t\tmode_lib->vba.PrefetchModePerState[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb],\n\t\t\t\tmode_lib->vba.UsesMALLForPStateChange[k],\n\t\t\t\tmode_lib->vba.SynchronizeDRRDisplaysForUCLKPStateChangeFinal,\n\t\t\t\tmode_lib->vba.DRRDisplay[k],\n\t\t\t\tmode_lib->vba.DRAMClockChangeLatency,\n\t\t\t\tmode_lib->vba.FCLKChangeLatency, v->UrgentLatency,\n\t\t\t\tmode_lib->vba.SREnterPlusExitTime);\n\n\t\t\tmemset(&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe, 0, sizeof(DmlPipe));\n\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.Dppclk = mode_lib->vba.DPPCLK[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.Dispclk = mode_lib->vba.DISPCLK;\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.PixelClock = mode_lib->vba.PixelClock[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.DCFClkDeepSleep = v->DCFCLKDeepSleep;\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.DPPPerSurface = mode_lib->vba.DPPPerPlane[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.ScalerEnabled = mode_lib->vba.ScalerEnabled[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.SourceRotation = mode_lib->vba.SourceRotation[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.BlockWidth256BytesY = v->BlockWidth256BytesY[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.BlockHeight256BytesY = v->BlockHeight256BytesY[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.BlockWidth256BytesC = v->BlockWidth256BytesC[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.BlockHeight256BytesC = v->BlockHeight256BytesC[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.InterlaceEnable = mode_lib->vba.Interlace[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.NumberOfCursors = mode_lib->vba.NumberOfCursors[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.VBlank = mode_lib->vba.VTotal[k] - mode_lib->vba.VActive[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.HTotal = mode_lib->vba.HTotal[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.HActive = mode_lib->vba.HActive[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.DCCEnable = mode_lib->vba.DCCEnable[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.ODMMode = mode_lib->vba.ODMCombineEnabled[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.SourcePixelFormat = mode_lib->vba.SourcePixelFormat[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.BytePerPixelY = v->BytePerPixelY[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.BytePerPixelC = v->BytePerPixelC[k];\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe.ProgressiveToInterlaceUnitInOPP = mode_lib->vba.ProgressiveToInterlaceUnitInOPP;\n\t\t\tv->ErrorResult[k] = dml32_CalculatePrefetchSchedule(\n\t\t\t\t\tv,\n\t\t\t\t\tk,\n\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.HostVMInefficiencyFactor,\n\t\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.myPipe,\n\t\t\t\t\tv->DSCDelay[k],\n\t\t\t\t\t(unsigned int) (v->SwathWidthY[k] / v->HRatio[k]),\n\t\t\t\t\tdml_min(v->VStartupLines, v->MaxVStartupLines[k]),\n\t\t\t\t\tv->MaxVStartupLines[k],\n\t\t\t\t\tv->UrgentLatency,\n\t\t\t\t\tv->UrgentExtraLatency,\n\t\t\t\t\tv->TCalc,\n\t\t\t\t\tv->PDEAndMetaPTEBytesFrame[k],\n\t\t\t\t\tv->MetaRowByte[k],\n\t\t\t\t\tv->PixelPTEBytesPerRow[k],\n\t\t\t\t\tv->PrefetchSourceLinesY[k],\n\t\t\t\t\tv->SwathWidthY[k],\n\t\t\t\t\tv->VInitPreFillY[k],\n\t\t\t\t\tv->MaxNumSwathY[k],\n\t\t\t\t\tv->PrefetchSourceLinesC[k],\n\t\t\t\t\tv->SwathWidthC[k],\n\t\t\t\t\tv->VInitPreFillC[k],\n\t\t\t\t\tv->MaxNumSwathC[k],\n\t\t\t\t\tv->swath_width_luma_ub[k],\n\t\t\t\t\tv->swath_width_chroma_ub[k],\n\t\t\t\t\tv->SwathHeightY[k],\n\t\t\t\t\tv->SwathHeightC[k],\n\t\t\t\t\tTWait,\n\t\t\t\t\t(v->DRAMSpeedPerState[mode_lib->vba.VoltageLevel] <= MEM_STROBE_FREQ_MHZ ||\n\t\t\t\t\t\tv->DCFCLKPerState[mode_lib->vba.VoltageLevel] <= DCFCLK_FREQ_EXTRA_PREFETCH_REQ_MHZ) ?\n\t\t\t\t\t\t\tmode_lib->vba.ip.min_prefetch_in_strobe_us : 0,\n\t\t\t\t\t \n\t\t\t\t\t&v->DSTXAfterScaler[k],\n\t\t\t\t\t&v->DSTYAfterScaler[k],\n\t\t\t\t\t&v->DestinationLinesForPrefetch[k],\n\t\t\t\t\t&v->PrefetchBandwidth[k],\n\t\t\t\t\t&v->DestinationLinesToRequestVMInVBlank[k],\n\t\t\t\t\t&v->DestinationLinesToRequestRowInVBlank[k],\n\t\t\t\t\t&v->VRatioPrefetchY[k],\n\t\t\t\t\t&v->VRatioPrefetchC[k],\n\t\t\t\t\t&v->RequiredPrefetchPixDataBWLuma[k],\n\t\t\t\t\t&v->RequiredPrefetchPixDataBWChroma[k],\n\t\t\t\t\t&v->NotEnoughTimeForDynamicMetadata[k],\n\t\t\t\t\t&v->Tno_bw[k], &v->prefetch_vmrow_bw[k],\n\t\t\t\t\t&v->Tdmdl_vm[k],\n\t\t\t\t\t&v->Tdmdl[k],\n\t\t\t\t\t&v->TSetup[k],\n\t\t\t\t\t&v->VUpdateOffsetPix[k],\n\t\t\t\t\t&v->VUpdateWidthPix[k],\n\t\t\t\t\t&v->VReadyOffsetPix[k]);\n\n#ifdef __DML_VBA_DEBUG__\n\t\t\tdml_print(\"DML::%s: k=%0d Prefetch calculation errResult=%0d\\n\",\n\t\t\t\t\t__func__, k, mode_lib->vba.ErrorResult[k]);\n#endif\n\t\t\tv->VStartup[k] = dml_min(v->VStartupLines, v->MaxVStartupLines[k]);\n\t\t}\n\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tdml32_CalculateUrgentBurstFactor(mode_lib->vba.UsesMALLForPStateChange[k],\n\t\t\t\t\tv->swath_width_luma_ub[k],\n\t\t\t\t\tv->swath_width_chroma_ub[k],\n\t\t\t\t\tmode_lib->vba.SwathHeightY[k],\n\t\t\t\t\tmode_lib->vba.SwathHeightC[k],\n\t\t\t\t\tmode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k],\n\t\t\t\t\tv->UrgentLatency,\n\t\t\t\t\tmode_lib->vba.CursorBufferSize,\n\t\t\t\t\tmode_lib->vba.CursorWidth[k][0],\n\t\t\t\t\tmode_lib->vba.CursorBPP[k][0],\n\t\t\t\t\tv->VRatioPrefetchY[k],\n\t\t\t\t\tv->VRatioPrefetchC[k],\n\t\t\t\t\tv->BytePerPixelDETY[k],\n\t\t\t\t\tv->BytePerPixelDETC[k],\n\t\t\t\t\tmode_lib->vba.DETBufferSizeY[k],\n\t\t\t\t\tmode_lib->vba.DETBufferSizeC[k],\n\t\t\t\t\t \n\t\t\t\t\t&v->UrgBurstFactorCursorPre[k],\n\t\t\t\t\t&v->UrgBurstFactorLumaPre[k],\n\t\t\t\t\t&v->UrgBurstFactorChromaPre[k],\n\t\t\t\t\t&v->NoUrgentLatencyHidingPre[k]);\n\n\t\t\tv->cursor_bw_pre[k] = mode_lib->vba.NumberOfCursors[k] * mode_lib->vba.CursorWidth[k][0] * mode_lib->vba.CursorBPP[k][0] /\n\t\t\t\t\t8.0 / (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]) * v->VRatioPrefetchY[k];\n\n#ifdef __DML_VBA_DEBUG__\n\t\t\tdml_print(\"DML::%s: k=%0d DPPPerSurface=%d\\n\", __func__, k, mode_lib->vba.DPPPerPlane[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d UrgBurstFactorLuma=%f\\n\", __func__, k, v->UrgBurstFactorLuma[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d UrgBurstFactorChroma=%f\\n\", __func__, k, v->UrgBurstFactorChroma[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d UrgBurstFactorLumaPre=%f\\n\", __func__, k,\n\t\t\t\t\tv->UrgBurstFactorLumaPre[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d UrgBurstFactorChromaPre=%f\\n\", __func__, k,\n\t\t\t\t\tv->UrgBurstFactorChromaPre[k]);\n\n\t\t\tdml_print(\"DML::%s: k=%0d VRatioPrefetchY=%f\\n\", __func__, k, v->VRatioPrefetchY[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d VRatioY=%f\\n\", __func__, k, mode_lib->vba.VRatio[k]);\n\n\t\t\tdml_print(\"DML::%s: k=%0d prefetch_vmrow_bw=%f\\n\", __func__, k, v->prefetch_vmrow_bw[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d ReadBandwidthSurfaceLuma=%f\\n\", __func__, k,\n\t\t\t\t\tv->ReadBandwidthSurfaceLuma[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d ReadBandwidthSurfaceChroma=%f\\n\", __func__, k,\n\t\t\t\t\tv->ReadBandwidthSurfaceChroma[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d cursor_bw=%f\\n\", __func__, k, v->cursor_bw[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d meta_row_bw=%f\\n\", __func__, k, v->meta_row_bw[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d dpte_row_bw=%f\\n\", __func__, k, v->dpte_row_bw[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d RequiredPrefetchPixDataBWLuma=%f\\n\", __func__, k,\n\t\t\t\t\tv->RequiredPrefetchPixDataBWLuma[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d RequiredPrefetchPixDataBWChroma=%f\\n\", __func__, k,\n\t\t\t\t\tv->RequiredPrefetchPixDataBWChroma[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d cursor_bw_pre=%f\\n\", __func__, k, v->cursor_bw_pre[k]);\n\t\t\tdml_print(\"DML::%s: k=%0d MaxTotalRDBandwidthNoUrgentBurst=%f\\n\", __func__, k,\n\t\t\t\t\tMaxTotalRDBandwidthNoUrgentBurst);\n#endif\n\t\t\tif (v->DestinationLinesForPrefetch[k] < 2)\n\t\t\t\tDestinationLineTimesForPrefetchLessThan2 = true;\n\n\t\t\tif (v->VRatioPrefetchY[k] > v->MaxVRatioPre\n\t\t\t\t\t|| v->VRatioPrefetchC[k] > v->MaxVRatioPre)\n\t\t\t\tVRatioPrefetchMoreThanMax = true;\n\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t\n\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t}\n\n\t\tv->FractionOfUrgentBandwidth = MaxTotalRDBandwidthNoUrgentBurst / mode_lib->vba.ReturnBW;\n\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: MaxTotalRDBandwidthNoUrgentBurst=%f\\n\",\n\t\t\t\t__func__, MaxTotalRDBandwidthNoUrgentBurst);\n\t\tdml_print(\"DML::%s: ReturnBW=%f\\n\", __func__, mode_lib->vba.ReturnBW);\n\t\tdml_print(\"DML::%s: FractionOfUrgentBandwidth=%f\\n\",\n\t\t\t\t__func__, mode_lib->vba.FractionOfUrgentBandwidth);\n#endif\n\n\t\t{\n\t\t\tdml32_CalculatePrefetchBandwithSupport(\n\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\tmode_lib->vba.ReturnBW,\n\t\t\t\t\tv->NoUrgentLatencyHidingPre,\n\t\t\t\t\tv->ReadBandwidthSurfaceLuma,\n\t\t\t\t\tv->ReadBandwidthSurfaceChroma,\n\t\t\t\t\tv->RequiredPrefetchPixDataBWLuma,\n\t\t\t\t\tv->RequiredPrefetchPixDataBWChroma,\n\t\t\t\t\tv->cursor_bw,\n\t\t\t\t\tv->meta_row_bw,\n\t\t\t\t\tv->dpte_row_bw,\n\t\t\t\t\tv->cursor_bw_pre,\n\t\t\t\t\tv->prefetch_vmrow_bw,\n\t\t\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\t\t\tv->UrgBurstFactorLuma,\n\t\t\t\t\tv->UrgBurstFactorChroma,\n\t\t\t\t\tv->UrgBurstFactorCursor,\n\t\t\t\t\tv->UrgBurstFactorLumaPre,\n\t\t\t\t\tv->UrgBurstFactorChromaPre,\n\t\t\t\t\tv->UrgBurstFactorCursorPre,\n\t\t\t\t\tv->PrefetchBandwidth,\n\t\t\t\t\tv->VRatio,\n\t\t\t\t\tv->MaxVRatioPre,\n\n\t\t\t\t\t \n\t\t\t\t\t&MaxTotalRDBandwidth,\n\t\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_single[0],\n\t\t\t\t\t&v->PrefetchModeSupported);\n\t\t}\n\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k)\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector[k] = 1.0;\n\n\t\t{\n\t\t\tdml32_CalculatePrefetchBandwithSupport(mode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\tmode_lib->vba.ReturnBW,\n\t\t\t\t\tv->NoUrgentLatencyHidingPre,\n\t\t\t\t\tv->ReadBandwidthSurfaceLuma,\n\t\t\t\t\tv->ReadBandwidthSurfaceChroma,\n\t\t\t\t\tv->RequiredPrefetchPixDataBWLuma,\n\t\t\t\t\tv->RequiredPrefetchPixDataBWChroma,\n\t\t\t\t\tv->cursor_bw,\n\t\t\t\t\tv->meta_row_bw,\n\t\t\t\t\tv->dpte_row_bw,\n\t\t\t\t\tv->cursor_bw_pre,\n\t\t\t\t\tv->prefetch_vmrow_bw,\n\t\t\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\tv->PrefetchBandwidth,\n\t\t\t\t\tv->VRatio,\n\t\t\t\t\tv->MaxVRatioPre,\n\n\t\t\t\t\t \n\t\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_single[0],\n\t\t\t\t\t&v->FractionOfUrgentBandwidth,\n\t\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_boolean);\n\t\t}\n\n\t\tif (VRatioPrefetchMoreThanMax != false || DestinationLineTimesForPrefetchLessThan2 != false) {\n\t\t\tv->PrefetchModeSupported = false;\n\t\t}\n\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tif (v->ErrorResult[k] == true || v->NotEnoughTimeForDynamicMetadata[k]) {\n\t\t\t\tv->PrefetchModeSupported = false;\n\t\t\t}\n\t\t}\n\n\t\tif (v->PrefetchModeSupported == true && mode_lib->vba.ImmediateFlipSupport == true) {\n\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip = dml32_CalculateBandwidthAvailableForImmediateFlip(\n\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\tmode_lib->vba.ReturnBW,\n\t\t\t\t\tv->ReadBandwidthSurfaceLuma,\n\t\t\t\t\tv->ReadBandwidthSurfaceChroma,\n\t\t\t\t\tv->RequiredPrefetchPixDataBWLuma,\n\t\t\t\t\tv->RequiredPrefetchPixDataBWChroma,\n\t\t\t\t\tv->cursor_bw,\n\t\t\t\t\tv->cursor_bw_pre,\n\t\t\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\t\t\tv->UrgBurstFactorLuma,\n\t\t\t\t\tv->UrgBurstFactorChroma,\n\t\t\t\t\tv->UrgBurstFactorCursor,\n\t\t\t\t\tv->UrgBurstFactorLumaPre,\n\t\t\t\t\tv->UrgBurstFactorChromaPre,\n\t\t\t\t\tv->UrgBurstFactorCursorPre);\n\n\t\t\tmode_lib->vba.TotImmediateFlipBytes = 0;\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tif (mode_lib->vba.ImmediateFlipRequirement[k] != dm_immediate_flip_not_required) {\n\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes = mode_lib->vba.TotImmediateFlipBytes\n\t\t\t\t\t\t\t+ mode_lib->vba.DPPPerPlane[k]\n\t\t\t\t\t\t\t\t\t* (v->PDEAndMetaPTEBytesFrame[k]\n\t\t\t\t\t\t\t\t\t\t\t+ v->MetaRowByte[k]);\n\t\t\t\t\tif (v->use_one_row_for_frame_flip[k][0][0]) {\n\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes =\n\t\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes\n\t\t\t\t\t\t\t\t\t\t+ 2 * v->PixelPTEBytesPerRow[k];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes =\n\t\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes\n\t\t\t\t\t\t\t\t\t\t+ v->PixelPTEBytesPerRow[k];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tdml32_CalculateFlipSchedule(v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.HostVMInefficiencyFactor,\n\t\t\t\t\t\tv->UrgentExtraLatency,\n\t\t\t\t\t\tv->UrgentLatency,\n\t\t\t\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\t\t\t\tmode_lib->vba.HostVMEnable,\n\t\t\t\t\t\tmode_lib->vba.HostVMMaxNonCachedPageTableLevels,\n\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\tmode_lib->vba.HostVMMinPageSize,\n\t\t\t\t\t\tv->PDEAndMetaPTEBytesFrame[k],\n\t\t\t\t\t\tv->MetaRowByte[k],\n\t\t\t\t\t\tv->PixelPTEBytesPerRow[k],\n\t\t\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip,\n\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes,\n\t\t\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\t\t\tmode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k],\n\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\tmode_lib->vba.VRatioChroma[k],\n\t\t\t\t\t\tv->Tno_bw[k],\n\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\tv->dpte_row_height[k],\n\t\t\t\t\t\tv->meta_row_height[k],\n\t\t\t\t\t\tv->dpte_row_height_chroma[k],\n\t\t\t\t\t\tv->meta_row_height_chroma[k],\n\t\t\t\t\t\tv->Use_One_Row_For_Frame_Flip[k],\n\n\t\t\t\t\t\t \n\t\t\t\t\t\t&v->DestinationLinesToRequestVMInImmediateFlip[k],\n\t\t\t\t\t\t&v->DestinationLinesToRequestRowInImmediateFlip[k],\n\t\t\t\t\t\t&v->final_flip_bw[k],\n\t\t\t\t\t\t&v->ImmediateFlipSupportedForPipe[k]);\n\t\t\t}\n\n\t\t\t{\n\t\t\t\tdml32_CalculateImmediateFlipBandwithSupport(mode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\t\tmode_lib->vba.ReturnBW,\n\t\t\t\t\t\tmode_lib->vba.ImmediateFlipRequirement,\n\t\t\t\t\t\tv->final_flip_bw,\n\t\t\t\t\t\tv->ReadBandwidthSurfaceLuma,\n\t\t\t\t\t\tv->ReadBandwidthSurfaceChroma,\n\t\t\t\t\t\tv->RequiredPrefetchPixDataBWLuma,\n\t\t\t\t\t\tv->RequiredPrefetchPixDataBWChroma,\n\t\t\t\t\t\tv->cursor_bw,\n\t\t\t\t\t\tv->meta_row_bw,\n\t\t\t\t\t\tv->dpte_row_bw,\n\t\t\t\t\t\tv->cursor_bw_pre,\n\t\t\t\t\t\tv->prefetch_vmrow_bw,\n\t\t\t\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\t\t\t\tv->UrgBurstFactorLuma,\n\t\t\t\t\t\tv->UrgBurstFactorChroma,\n\t\t\t\t\t\tv->UrgBurstFactorCursor,\n\t\t\t\t\t\tv->UrgBurstFactorLumaPre,\n\t\t\t\t\t\tv->UrgBurstFactorChromaPre,\n\t\t\t\t\t\tv->UrgBurstFactorCursorPre,\n\n\t\t\t\t\t\t \n\t\t\t\t\t\t&v->total_dcn_read_bw_with_flip,    \n\t\t\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_single[0],                        \n\t\t\t\t\t\t&v->ImmediateFlipSupported);        \n\n\t\t\t\tdml32_CalculateImmediateFlipBandwithSupport(mode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\t\tmode_lib->vba.ReturnBW,\n\t\t\t\t\t\tmode_lib->vba.ImmediateFlipRequirement,\n\t\t\t\t\t\tv->final_flip_bw,\n\t\t\t\t\t\tv->ReadBandwidthSurfaceLuma,\n\t\t\t\t\t\tv->ReadBandwidthSurfaceChroma,\n\t\t\t\t\t\tv->RequiredPrefetchPixDataBWLuma,\n\t\t\t\t\t\tv->RequiredPrefetchPixDataBWChroma,\n\t\t\t\t\t\tv->cursor_bw,\n\t\t\t\t\t\tv->meta_row_bw,\n\t\t\t\t\t\tv->dpte_row_bw,\n\t\t\t\t\t\tv->cursor_bw_pre,\n\t\t\t\t\t\tv->prefetch_vmrow_bw,\n\t\t\t\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\t\t\t\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_unit_vector,\n\n\t\t\t\t\t\t \n\t\t\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_single[1],                                \n\t\t\t\t\t\t&v->FractionOfUrgentBandwidthImmediateFlip, \n\t\t\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_boolean);                              \n\t\t\t}\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tif (mode_lib->vba.ImmediateFlipRequirement[k] != dm_immediate_flip_not_required && v->ImmediateFlipSupportedForPipe[k] == false) {\n\t\t\t\t\tv->ImmediateFlipSupported = false;\n#ifdef __DML_VBA_DEBUG__\n\t\t\t\t\tdml_print(\"DML::%s: Pipe %0d not supporting iflip\\n\", __func__, k);\n#endif\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tv->ImmediateFlipSupported = false;\n\t\t}\n\n\t\t \n\t\tv->PrefetchAndImmediateFlipSupported = (v->PrefetchModeSupported == true &&\n\t\t\t\t((!mode_lib->vba.ImmediateFlipSupport && !mode_lib->vba.HostVMEnable && !ImmediateFlipRequirementFinal) ||\n\t\t\t\t\t\tv->ImmediateFlipSupported)) ? true : false;\n\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: PrefetchModeSupported = %d\\n\", __func__, locals->PrefetchModeSupported);\n\t\tfor (uint k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k)\n\t\t\tdml_print(\"DML::%s: ImmediateFlipRequirement[%d] = %d\\n\", __func__, k,  mode_lib->vba.ImmediateFlipRequirement[k] == dm_immediate_flip_required);\n\t\tdml_print(\"DML::%s: ImmediateFlipSupported = %d\\n\", __func__, locals->ImmediateFlipSupported);\n\t\tdml_print(\"DML::%s: ImmediateFlipSupport = %d\\n\", __func__, mode_lib->vba.ImmediateFlipSupport);\n\t\tdml_print(\"DML::%s: HostVMEnable = %d\\n\", __func__, mode_lib->vba.HostVMEnable);\n\t\tdml_print(\"DML::%s: PrefetchAndImmediateFlipSupported = %d\\n\", __func__, locals->PrefetchAndImmediateFlipSupported);\n\t\tdml_print(\"DML::%s: Done loop: Vstartup=%d, Max Vstartup=%d\\n\", __func__, locals->VStartupLines, locals->MaximumMaxVStartupLines);\n#endif\n\n\t\tv->VStartupLines = v->VStartupLines + 1;\n\n\t\tif (v->VStartupLines > v->MaximumMaxVStartupLines) {\n#ifdef __DML_VBA_DEBUG__\n\t\t\tdml_print(\"DML::%s: Vstartup exceeds max vstartup, exiting loop\\n\", __func__);\n#endif\n\t\t\tbreak;  \n\t\t}\n\t\titeration++;\n\t\tif (iteration > 2500) {\n#ifdef __DML_VBA_DEBUG__\n\t\t\tdml_print(\"DML::%s: too many errors, exit now\\n\", __func__);\n\t\t\tassert(0);\n#endif\n\t\t}\n\t} while (!(v->PrefetchAndImmediateFlipSupported || NextPrefetchMode > mode_lib->vba.MaxPrefetchMode));\n\n\n\tif (v->VStartupLines <= v->MaximumMaxVStartupLines) {\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: Good, Prefetch and flip scheduling found solution at VStartupLines=%d\\n\", __func__, locals->VStartupLines-1);\n#endif\n\t}\n\n\n\t\n\t{\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.UrgentLatency = v->UrgentLatency;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.ExtraLatency = v->UrgentExtraLatency;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.WritebackLatency = mode_lib->vba.WritebackLatency;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.DRAMClockChangeLatency = mode_lib->vba.DRAMClockChangeLatency;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.FCLKChangeLatency = mode_lib->vba.FCLKChangeLatency;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.SRExitTime = mode_lib->vba.SRExitTime;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.SREnterPlusExitTime = mode_lib->vba.SREnterPlusExitTime;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.SRExitZ8Time = mode_lib->vba.SRExitZ8Time;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.SREnterPlusExitZ8Time = mode_lib->vba.SREnterPlusExitZ8Time;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.USRRetrainingLatency = mode_lib->vba.USRRetrainingLatency;\n\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters.SMNLatency = mode_lib->vba.SMNLatency;\n\n\t\tdml32_CalculateWatermarksMALLUseAndDRAMSpeedChangeSupport(\n\t\t\tv,\n\t\t\tv->PrefetchModePerState[v->VoltageLevel][v->maxMpcComb],\n\t\t\tv->DCFCLK,\n\t\t\tv->ReturnBW,\n\t\t\tv->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.mmSOCParameters,\n\t\t\tv->SOCCLK,\n\t\t\tv->DCFCLKDeepSleep,\n\t\t\tv->DETBufferSizeY,\n\t\t\tv->DETBufferSizeC,\n\t\t\tv->SwathHeightY,\n\t\t\tv->SwathHeightC,\n\t\t\tv->SwathWidthY,\n\t\t\tv->SwathWidthC,\n\t\t\tv->DPPPerPlane,\n\t\t\tv->BytePerPixelDETY,\n\t\t\tv->BytePerPixelDETC,\n\t\t\tv->DSTXAfterScaler,\n\t\t\tv->DSTYAfterScaler,\n\t\t\tv->UnboundedRequestEnabled,\n\t\t\tv->CompressedBufferSizeInkByte,\n\n\t\t\t \n\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_dramchange_support,\n\t\t\tv->MaxActiveDRAMClockChangeLatencySupported,\n\t\t\tv->SubViewportLinesNeededInMALL,\n\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_fclkchange_support,\n\t\t\t&v->MinActiveFCLKChangeLatencySupported,\n\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_USRRetrainingSupport,\n\t\t\tmode_lib->vba.ActiveDRAMClockChangeLatencyMargin);\n\n\t\t \n\t\tv->UrgentWatermark = v->Watermark.UrgentWatermark;\n\t\tv->WritebackUrgentWatermark = v->Watermark.WritebackUrgentWatermark;\n\t\tv->DRAMClockChangeWatermark = v->Watermark.DRAMClockChangeWatermark;\n\t\tv->WritebackDRAMClockChangeWatermark = v->Watermark.WritebackDRAMClockChangeWatermark;\n\t\tv->StutterExitWatermark = v->Watermark.StutterExitWatermark;\n\t\tv->StutterEnterPlusExitWatermark = v->Watermark.StutterEnterPlusExitWatermark;\n\t\tv->Z8StutterExitWatermark = v->Watermark.Z8StutterExitWatermark;\n\t\tv->Z8StutterEnterPlusExitWatermark = v->Watermark.Z8StutterEnterPlusExitWatermark;\n\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\t\tv->WritebackAllowDRAMClockChangeEndPosition[k] = dml_max(0,\n\t\t\t\t\t\tv->VStartup[k] * mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t\t- v->Watermark.WritebackDRAMClockChangeWatermark);\n\t\t\t\tv->WritebackAllowFCLKChangeEndPosition[k] = dml_max(0,\n\t\t\t\t\t\tv->VStartup[k] * mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t\t- v->Watermark.WritebackFCLKChangeWatermark);\n\t\t\t} else {\n\t\t\t\tv->WritebackAllowDRAMClockChangeEndPosition[k] = 0;\n\t\t\t\tv->WritebackAllowFCLKChangeEndPosition[k] = 0;\n\t\t\t}\n\t\t}\n\t}\n\n\t\n\tdml32_CalculatePixelDeliveryTimes(\n\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\tmode_lib->vba.VRatio,\n\t\t\tmode_lib->vba.VRatioChroma,\n\t\t\tv->VRatioPrefetchY,\n\t\t\tv->VRatioPrefetchC,\n\t\t\tv->swath_width_luma_ub,\n\t\t\tv->swath_width_chroma_ub,\n\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\tmode_lib->vba.HRatio,\n\t\t\tmode_lib->vba.HRatioChroma,\n\t\t\tmode_lib->vba.PixelClock,\n\t\t\tv->PSCL_THROUGHPUT_LUMA,\n\t\t\tv->PSCL_THROUGHPUT_CHROMA,\n\t\t\tmode_lib->vba.DPPCLK,\n\t\t\tv->BytePerPixelC,\n\t\t\tmode_lib->vba.SourceRotation,\n\t\t\tmode_lib->vba.NumberOfCursors,\n\t\t\tmode_lib->vba.CursorWidth,\n\t\t\tmode_lib->vba.CursorBPP,\n\t\t\tv->BlockWidth256BytesY,\n\t\t\tv->BlockHeight256BytesY,\n\t\t\tv->BlockWidth256BytesC,\n\t\t\tv->BlockHeight256BytesC,\n\n\t\t\t \n\t\t\tv->DisplayPipeLineDeliveryTimeLuma,\n\t\t\tv->DisplayPipeLineDeliveryTimeChroma,\n\t\t\tv->DisplayPipeLineDeliveryTimeLumaPrefetch,\n\t\t\tv->DisplayPipeLineDeliveryTimeChromaPrefetch,\n\t\t\tv->DisplayPipeRequestDeliveryTimeLuma,\n\t\t\tv->DisplayPipeRequestDeliveryTimeChroma,\n\t\t\tv->DisplayPipeRequestDeliveryTimeLumaPrefetch,\n\t\t\tv->DisplayPipeRequestDeliveryTimeChromaPrefetch,\n\t\t\tv->CursorRequestDeliveryTime,\n\t\t\tv->CursorRequestDeliveryTimePrefetch);\n\n\tdml32_CalculateMetaAndPTETimes(v->Use_One_Row_For_Frame,\n\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\tmode_lib->vba.MetaChunkSize,\n\t\t\tmode_lib->vba.MinMetaChunkSizeBytes,\n\t\t\tmode_lib->vba.HTotal,\n\t\t\tmode_lib->vba.VRatio,\n\t\t\tmode_lib->vba.VRatioChroma,\n\t\t\tv->DestinationLinesToRequestRowInVBlank,\n\t\t\tv->DestinationLinesToRequestRowInImmediateFlip,\n\t\t\tmode_lib->vba.DCCEnable,\n\t\t\tmode_lib->vba.PixelClock,\n\t\t\tv->BytePerPixelY,\n\t\t\tv->BytePerPixelC,\n\t\t\tmode_lib->vba.SourceRotation,\n\t\t\tv->dpte_row_height,\n\t\t\tv->dpte_row_height_chroma,\n\t\t\tv->meta_row_width,\n\t\t\tv->meta_row_width_chroma,\n\t\t\tv->meta_row_height,\n\t\t\tv->meta_row_height_chroma,\n\t\t\tv->meta_req_width,\n\t\t\tv->meta_req_width_chroma,\n\t\t\tv->meta_req_height,\n\t\t\tv->meta_req_height_chroma,\n\t\t\tv->dpte_group_bytes,\n\t\t\tv->PTERequestSizeY,\n\t\t\tv->PTERequestSizeC,\n\t\t\tv->PixelPTEReqWidthY,\n\t\t\tv->PixelPTEReqHeightY,\n\t\t\tv->PixelPTEReqWidthC,\n\t\t\tv->PixelPTEReqHeightC,\n\t\t\tv->dpte_row_width_luma_ub,\n\t\t\tv->dpte_row_width_chroma_ub,\n\n\t\t\t \n\t\t\tv->DST_Y_PER_PTE_ROW_NOM_L,\n\t\t\tv->DST_Y_PER_PTE_ROW_NOM_C,\n\t\t\tv->DST_Y_PER_META_ROW_NOM_L,\n\t\t\tv->DST_Y_PER_META_ROW_NOM_C,\n\t\t\tv->TimePerMetaChunkNominal,\n\t\t\tv->TimePerChromaMetaChunkNominal,\n\t\t\tv->TimePerMetaChunkVBlank,\n\t\t\tv->TimePerChromaMetaChunkVBlank,\n\t\t\tv->TimePerMetaChunkFlip,\n\t\t\tv->TimePerChromaMetaChunkFlip,\n\t\t\tv->time_per_pte_group_nom_luma,\n\t\t\tv->time_per_pte_group_vblank_luma,\n\t\t\tv->time_per_pte_group_flip_luma,\n\t\t\tv->time_per_pte_group_nom_chroma,\n\t\t\tv->time_per_pte_group_vblank_chroma,\n\t\t\tv->time_per_pte_group_flip_chroma);\n\n\tdml32_CalculateVMGroupAndRequestTimes(\n\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\tmode_lib->vba.HTotal,\n\t\t\tv->BytePerPixelC,\n\t\t\tv->DestinationLinesToRequestVMInVBlank,\n\t\t\tv->DestinationLinesToRequestVMInImmediateFlip,\n\t\t\tmode_lib->vba.DCCEnable,\n\t\t\tmode_lib->vba.PixelClock,\n\t\t\tv->dpte_row_width_luma_ub,\n\t\t\tv->dpte_row_width_chroma_ub,\n\t\t\tv->vm_group_bytes,\n\t\t\tv->dpde0_bytes_per_frame_ub_l,\n\t\t\tv->dpde0_bytes_per_frame_ub_c,\n\t\t\tv->meta_pte_bytes_per_frame_ub_l,\n\t\t\tv->meta_pte_bytes_per_frame_ub_c,\n\n\t\t\t \n\t\t\tv->TimePerVMGroupVBlank,\n\t\t\tv->TimePerVMGroupFlip,\n\t\t\tv->TimePerVMRequestVBlank,\n\t\t\tv->TimePerVMRequestFlip);\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tif (mode_lib->vba.PrefetchModePerState[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb] == 0) {\n\t\t\tv->MinTTUVBlank[k] = dml_max4(v->Watermark.DRAMClockChangeWatermark,\n\t\t\t\t\tv->Watermark.FCLKChangeWatermark, v->Watermark.StutterEnterPlusExitWatermark,\n\t\t\t\t\tv->Watermark.UrgentWatermark);\n\t\t} else if (mode_lib->vba.PrefetchModePerState[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb]\n\t\t\t\t== 1) {\n\t\t\tv->MinTTUVBlank[k] = dml_max3(v->Watermark.FCLKChangeWatermark,\n\t\t\t\t\tv->Watermark.StutterEnterPlusExitWatermark, v->Watermark.UrgentWatermark);\n\t\t} else if (mode_lib->vba.PrefetchModePerState[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb]\n\t\t\t\t== 2) {\n\t\t\tv->MinTTUVBlank[k] = dml_max(v->Watermark.StutterEnterPlusExitWatermark,\n\t\t\t\t\tv->Watermark.UrgentWatermark);\n\t\t} else {\n\t\t\tv->MinTTUVBlank[k] = v->Watermark.UrgentWatermark;\n\t\t}\n\t\tif (!mode_lib->vba.DynamicMetadataEnable[k])\n\t\t\tv->MinTTUVBlank[k] = mode_lib->vba.TCalc + v->MinTTUVBlank[k];\n\t}\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: Calculate DCC configuration for surface k=%d\\n\", __func__, k);\n#endif\n\t\tdml32_CalculateDCCConfiguration(\n\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\tmode_lib->vba.DCCProgrammingAssumesScanDirectionUnknownFinal,\n\t\t\t\tmode_lib->vba.SourcePixelFormat[k], mode_lib->vba.SurfaceWidthY[k],\n\t\t\t\tmode_lib->vba.SurfaceWidthC[k],\n\t\t\t\tmode_lib->vba.SurfaceHeightY[k],\n\t\t\t\tmode_lib->vba.SurfaceHeightC[k],\n\t\t\t\tmode_lib->vba.nomDETInKByte,\n\t\t\t\tv->BlockHeight256BytesY[k],\n\t\t\t\tv->BlockHeight256BytesC[k],\n\t\t\t\tmode_lib->vba.SurfaceTiling[k],\n\t\t\t\tv->BytePerPixelY[k],\n\t\t\t\tv->BytePerPixelC[k],\n\t\t\t\tv->BytePerPixelDETY[k],\n\t\t\t\tv->BytePerPixelDETC[k],\n\t\t\t\t(enum dm_rotation_angle) mode_lib->vba.SourceScan[k],\n\t\t\t\t \n\t\t\t\t&v->DCCYMaxUncompressedBlock[k],\n\t\t\t\t&v->DCCCMaxUncompressedBlock[k],\n\t\t\t\t&v->DCCYMaxCompressedBlock[k],\n\t\t\t\t&v->DCCCMaxCompressedBlock[k],\n\t\t\t\t&v->DCCYIndependentBlock[k],\n\t\t\t\t&v->DCCCIndependentBlock[k]);\n\t}\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tbool isInterlaceTiming;\n\t\tdouble Tvstartup_margin = (v->MaxVStartupLines[k] - v->VStartup[k]) * mode_lib->vba.HTotal[k]\n\t\t\t\t/ mode_lib->vba.PixelClock[k];\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: k=%d, MinTTUVBlank = %f (before vstartup margin)\\n\", __func__, k,\n\t\t\t\tv->MinTTUVBlank[k]);\n#endif\n\n\t\tv->MinTTUVBlank[k] = v->MinTTUVBlank[k] + Tvstartup_margin;\n\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: k=%d, Tvstartup_margin = %f\\n\", __func__, k, Tvstartup_margin);\n\t\tdml_print(\"DML::%s: k=%d, MaxVStartupLines = %d\\n\", __func__, k, v->MaxVStartupLines[k]);\n\t\tdml_print(\"DML::%s: k=%d, VStartup = %d\\n\", __func__, k, v->VStartup[k]);\n\t\tdml_print(\"DML::%s: k=%d, MinTTUVBlank = %f\\n\", __func__, k, v->MinTTUVBlank[k]);\n#endif\n\n\t\tv->Tdmdl[k] = v->Tdmdl[k] + Tvstartup_margin;\n\t\tif (mode_lib->vba.DynamicMetadataEnable[k] && mode_lib->vba.DynamicMetadataVMEnabled)\n\t\t\tv->Tdmdl_vm[k] = v->Tdmdl_vm[k] + Tvstartup_margin;\n\n\t\tisInterlaceTiming = (mode_lib->vba.Interlace[k] &&\n\t\t\t\t!mode_lib->vba.ProgressiveToInterlaceUnitInOPP);\n\n\t\tv->MIN_DST_Y_NEXT_START[k] = ((isInterlaceTiming ? dml_floor((mode_lib->vba.VTotal[k] -\n\t\t\t\t\t\tmode_lib->vba.VFrontPorch[k]) / 2.0, 1.0) :\n\t\t\t\t\t\tmode_lib->vba.VTotal[k]) - mode_lib->vba.VFrontPorch[k])\n\t\t\t\t\t\t+ dml_max(1.0,\n\t\t\t\t\t\tdml_ceil(v->WritebackDelay[mode_lib->vba.VoltageLevel][k]\n\t\t\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]), 1.0))\n\t\t\t\t\t\t+ dml_floor(4.0 * v->TSetup[k] / (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]), 1.0) / 4.0;\n\n\t\tv->VStartup[k] = (isInterlaceTiming ? (2 * v->MaxVStartupLines[k]) : v->MaxVStartupLines[k]);\n\n\t\tif (((v->VUpdateOffsetPix[k] + v->VUpdateWidthPix[k] + v->VReadyOffsetPix[k])\n\t\t\t/ mode_lib->vba.HTotal[k]) <= (isInterlaceTiming ? dml_floor((mode_lib->vba.VTotal[k]\n\t\t\t- mode_lib->vba.VActive[k] - mode_lib->vba.VFrontPorch[k] - v->VStartup[k]) / 2.0, 1.0) :\n\t\t\t(int) (mode_lib->vba.VTotal[k] - mode_lib->vba.VActive[k]\n\t\t       - mode_lib->vba.VFrontPorch[k] - v->VStartup[k]))) {\n\t\t\tv->VREADY_AT_OR_AFTER_VSYNC[k] = true;\n\t\t} else {\n\t\t\tv->VREADY_AT_OR_AFTER_VSYNC[k] = false;\n\t\t}\n#ifdef __DML_VBA_DEBUG__\n\t\tdml_print(\"DML::%s: k=%d, VStartup = %d (max)\\n\", __func__, k, v->VStartup[k]);\n\t\tdml_print(\"DML::%s: k=%d, VUpdateOffsetPix = %d\\n\", __func__, k, v->VUpdateOffsetPix[k]);\n\t\tdml_print(\"DML::%s: k=%d, VUpdateWidthPix = %d\\n\", __func__, k, v->VUpdateWidthPix[k]);\n\t\tdml_print(\"DML::%s: k=%d, VReadyOffsetPix = %d\\n\", __func__, k, v->VReadyOffsetPix[k]);\n\t\tdml_print(\"DML::%s: k=%d, HTotal = %d\\n\", __func__, k, mode_lib->vba.HTotal[k]);\n\t\tdml_print(\"DML::%s: k=%d, VTotal = %d\\n\", __func__, k, mode_lib->vba.VTotal[k]);\n\t\tdml_print(\"DML::%s: k=%d, VActive = %d\\n\", __func__, k, mode_lib->vba.VActive[k]);\n\t\tdml_print(\"DML::%s: k=%d, VFrontPorch = %d\\n\", __func__, k, mode_lib->vba.VFrontPorch[k]);\n\t\tdml_print(\"DML::%s: k=%d, VStartup = %d\\n\", __func__, k, v->VStartup[k]);\n\t\tdml_print(\"DML::%s: k=%d, TSetup = %f\\n\", __func__, k, v->TSetup[k]);\n\t\tdml_print(\"DML::%s: k=%d, MIN_DST_Y_NEXT_START = %f\\n\", __func__, k, v->MIN_DST_Y_NEXT_START[k]);\n\t\tdml_print(\"DML::%s: k=%d, VREADY_AT_OR_AFTER_VSYNC = %d\\n\", __func__, k,\n\t\t\t\tv->VREADY_AT_OR_AFTER_VSYNC[k]);\n#endif\n\t}\n\n\t{\n\t\t\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tif (mode_lib->vba.WritebackEnable[k] == true\n\t\t\t\t\t&& mode_lib->vba.WritebackPixelFormat[k] == dm_444_32) {\n\t\t\t\tWRBandwidth = mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t\t/ (mode_lib->vba.HTotal[k] * mode_lib->vba.WritebackSourceHeight[k]\n\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]) * 4;\n\t\t\t} else if (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\t\tWRBandwidth = mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t\t/ (mode_lib->vba.HTotal[k] * mode_lib->vba.WritebackSourceHeight[k]\n\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]) * 8;\n\t\t\t}\n\t\t\tTotalWRBandwidth = TotalWRBandwidth + WRBandwidth;\n\t\t}\n\n\t\tv->TotalDataReadBandwidth = 0;\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tv->TotalDataReadBandwidth = v->TotalDataReadBandwidth + v->ReadBandwidthSurfaceLuma[k]\n\t\t\t\t\t+ v->ReadBandwidthSurfaceChroma[k];\n#ifdef __DML_VBA_DEBUG__\n\t\t\tdml_print(\"DML::%s: k=%d, TotalDataReadBandwidth = %f\\n\",\n\t\t\t\t\t__func__, k, v->TotalDataReadBandwidth);\n\t\t\tdml_print(\"DML::%s: k=%d, ReadBandwidthSurfaceLuma = %f\\n\",\n\t\t\t\t\t__func__, k, v->ReadBandwidthSurfaceLuma[k]);\n\t\t\tdml_print(\"DML::%s: k=%d, ReadBandwidthSurfaceChroma = %f\\n\",\n\t\t\t\t\t__func__, k, v->ReadBandwidthSurfaceChroma[k]);\n#endif\n\t\t}\n\t}\n\n\t\n\tdml32_CalculateStutterEfficiency(v->CompressedBufferSizeInkByte,\n\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\tv->UnboundedRequestEnabled,\n\t\t\tmode_lib->vba.MetaFIFOSizeInKEntries,\n\t\t\tmode_lib->vba.ZeroSizeBufferEntries,\n\t\t\tmode_lib->vba.PixelChunkSizeInKByte,\n\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\tmode_lib->vba.ROBBufferSizeInKByte,\n\t\t\tv->TotalDataReadBandwidth,\n\t\t\tmode_lib->vba.DCFCLK,\n\t\t\tmode_lib->vba.ReturnBW,\n\t\t\tv->CompbufReservedSpace64B,\n\t\t\tv->CompbufReservedSpaceZs,\n\t\t\tmode_lib->vba.SRExitTime,\n\t\t\tmode_lib->vba.SRExitZ8Time,\n\t\t\tmode_lib->vba.SynchronizeTimingsFinal,\n\t\t\tmode_lib->vba.BlendingAndTiming,\n\t\t\tv->Watermark.StutterEnterPlusExitWatermark,\n\t\t\tv->Watermark.Z8StutterEnterPlusExitWatermark,\n\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP,\n\t\t\tmode_lib->vba.Interlace,\n\t\t\tv->MinTTUVBlank, mode_lib->vba.DPPPerPlane,\n\t\t\tmode_lib->vba.DETBufferSizeY,\n\t\t\tv->BytePerPixelY,\n\t\t\tv->BytePerPixelDETY,\n\t\t\tv->SwathWidthY,\n\t\t\tmode_lib->vba.SwathHeightY,\n\t\t\tmode_lib->vba.SwathHeightC,\n\t\t\tmode_lib->vba.DCCRateLuma,\n\t\t\tmode_lib->vba.DCCRateChroma,\n\t\t\tmode_lib->vba.DCCFractionOfZeroSizeRequestsLuma,\n\t\t\tmode_lib->vba.DCCFractionOfZeroSizeRequestsChroma,\n\t\t\tmode_lib->vba.HTotal, mode_lib->vba.VTotal,\n\t\t\tmode_lib->vba.PixelClock,\n\t\t\tmode_lib->vba.VRatio,\n\t\t\tmode_lib->vba.SourceRotation,\n\t\t\tv->BlockHeight256BytesY,\n\t\t\tv->BlockWidth256BytesY,\n\t\t\tv->BlockHeight256BytesC,\n\t\t\tv->BlockWidth256BytesC,\n\t\t\tv->DCCYMaxUncompressedBlock,\n\t\t\tv->DCCCMaxUncompressedBlock,\n\t\t\tmode_lib->vba.VActive,\n\t\t\tmode_lib->vba.DCCEnable,\n\t\t\tmode_lib->vba.WritebackEnable,\n\t\t\tv->ReadBandwidthSurfaceLuma,\n\t\t\tv->ReadBandwidthSurfaceChroma,\n\t\t\tv->meta_row_bw,\n\t\t\tv->dpte_row_bw,\n\t\t\t \n\t\t\t&v->StutterEfficiencyNotIncludingVBlank,\n\t\t\t&v->StutterEfficiency,\n\t\t\t&v->NumberOfStutterBurstsPerFrame,\n\t\t\t&v->Z8StutterEfficiencyNotIncludingVBlank,\n\t\t\t&v->Z8StutterEfficiency,\n\t\t\t&v->Z8NumberOfStutterBurstsPerFrame,\n\t\t\t&v->StutterPeriod,\n\t\t\t&v->DCHUBBUB_ARB_CSTATE_MAX_CAP_MODE);\n\n#ifdef __DML_VBA_ALLOW_DELTA__\n\t{\n\t\tunsigned int dummy_integer[1];\n\n\t\t\n\t\tdml32_CalculateStutterEfficiency(v->CompressedBufferSizeInkByte,\n\t\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\t\tv->UnboundedRequestEnabled,\n\t\t\t\tmode_lib->vba.MetaFIFOSizeInKEntries,\n\t\t\t\tmode_lib->vba.ZeroSizeBufferEntries,\n\t\t\t\tmode_lib->vba.PixelChunkSizeInKByte,\n\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\tmode_lib->vba.ROBBufferSizeInKByte,\n\t\t\t\tv->TotalDataReadBandwidth,\n\t\t\t\tmode_lib->vba.DCFCLK,\n\t\t\t\tmode_lib->vba.ReturnBW,\n\t\t\t\t0, \n\t\t\t\t0, \n\t\t\t\tmode_lib->vba.SRExitTime,\n\t\t\t\tmode_lib->vba.SRExitZ8Time,\n\t\t\t\tmode_lib->vba.SynchronizeTimingsFinal,\n\t\t\t\tmode_lib->vba.BlendingAndTiming,\n\t\t\t\tv->Watermark.StutterEnterPlusExitWatermark,\n\t\t\t\tv->Watermark.Z8StutterEnterPlusExitWatermark,\n\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP,\n\t\t\t\tmode_lib->vba.Interlace,\n\t\t\t\tv->MinTTUVBlank,\n\t\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\t\tmode_lib->vba.DETBufferSizeY,\n\t\t\t\tv->BytePerPixelY, v->BytePerPixelDETY,\n\t\t\t\tv->SwathWidthY, mode_lib->vba.SwathHeightY,\n\t\t\t\tmode_lib->vba.SwathHeightC,\n\t\t\t\tmode_lib->vba.DCCRateLuma,\n\t\t\t\tmode_lib->vba.DCCRateChroma,\n\t\t\t\tmode_lib->vba.DCCFractionOfZeroSizeRequestsLuma,\n\t\t\t\tmode_lib->vba.DCCFractionOfZeroSizeRequestsChroma,\n\t\t\t\tmode_lib->vba.HTotal,\n\t\t\t\tmode_lib->vba.VTotal,\n\t\t\t\tmode_lib->vba.PixelClock,\n\t\t\t\tmode_lib->vba.VRatio,\n\t\t\t\tmode_lib->vba.SourceRotation,\n\t\t\t\tv->BlockHeight256BytesY,\n\t\t\t\tv->BlockWidth256BytesY,\n\t\t\t\tv->BlockHeight256BytesC,\n\t\t\t\tv->BlockWidth256BytesC,\n\t\t\t\tv->DCCYMaxUncompressedBlock,\n\t\t\t\tv->DCCCMaxUncompressedBlock,\n\t\t\t\tmode_lib->vba.VActive,\n\t\t\t\tmode_lib->vba.DCCEnable,\n\t\t\t\tmode_lib->vba.WritebackEnable,\n\t\t\t\tv->ReadBandwidthSurfaceLuma,\n\t\t\t\tv->ReadBandwidthSurfaceChroma,\n\t\t\t\tv->meta_row_bw, v->dpte_row_bw,\n\n\t\t\t\t \n\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_single[0],\n\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_single[1],\n\t\t\t\t&dummy_integer[0],\n\t\t\t\t&v->Z8StutterEfficiencyNotIncludingVBlankBestCase,\n\t\t\t\t&v->Z8StutterEfficiencyBestCase,\n\t\t\t\t&v->Z8NumberOfStutterBurstsPerFrameBestCase,\n\t\t\t\t&v->StutterPeriodBestCase,\n\t\t\t\t&v->dummy_vars.DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation.dummy_boolean);\n\t}\n#else\n\tv->Z8StutterEfficiencyNotIncludingVBlankBestCase = v->Z8StutterEfficiencyNotIncludingVBlank;\n\tv->Z8StutterEfficiencyBestCase = v->Z8StutterEfficiency;\n\tv->Z8NumberOfStutterBurstsPerFrameBestCase = v->Z8NumberOfStutterBurstsPerFrame;\n\tv->StutterPeriodBestCase = v->StutterPeriod;\n#endif\n\n#ifdef __DML_VBA_DEBUG__\n\tdml_print(\"DML::%s: --- END ---\\n\", __func__);\n#endif\n}\n\nstatic void mode_support_configuration(struct vba_vars_st *v,\n\t\t\t\t  struct display_mode_lib *mode_lib)\n{\n\tint i, j, start_state;\n\n\tif (mode_lib->validate_max_state)\n\t\tstart_state = v->soc.num_states - 1;\n\telse\n\t\tstart_state = 0;\n\n\tfor (i = v->soc.num_states - 1; i >= start_state; i--) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tif (mode_lib->vba.ScaleRatioAndTapsSupport == true\n\t\t\t\t&& mode_lib->vba.SourceFormatPixelAndScanSupport == true\n\t\t\t\t&& mode_lib->vba.ViewportSizeSupport[i][j] == true\n\t\t\t\t&& !mode_lib->vba.LinkRateDoesNotMatchDPVersion\n\t\t\t\t&& !mode_lib->vba.LinkRateForMultistreamNotIndicated\n\t\t\t\t&& !mode_lib->vba.BPPForMultistreamNotIndicated\n\t\t\t\t&& !mode_lib->vba.MultistreamWithHDMIOreDP\n\t\t\t\t&& !mode_lib->vba.ExceededMultistreamSlots[i]\n\t\t\t\t&& !mode_lib->vba.MSOOrODMSplitWithNonDPLink\n\t\t\t\t&& !mode_lib->vba.NotEnoughLanesForMSO\n\t\t\t\t&& mode_lib->vba.LinkCapacitySupport[i] == true && !mode_lib->vba.P2IWith420\n\t\t\t\t\n\t\t\t\t&& !mode_lib->vba.DSC422NativeNotSupported\n\t\t\t\t&& !mode_lib->vba.MPCCombineMethodIncompatible\n\t\t\t\t&& mode_lib->vba.ODMCombine2To1SupportCheckOK[i] == true\n\t\t\t\t&& mode_lib->vba.ODMCombine4To1SupportCheckOK[i] == true\n\t\t\t\t&& mode_lib->vba.NotEnoughDSCUnits[i] == false\n\t\t\t\t&& !mode_lib->vba.NotEnoughDSCSlices[i]\n\t\t\t\t&& !mode_lib->vba.ImmediateFlipOrHostVMAndPStateWithMALLFullFrameOrPhantomPipe\n\t\t\t\t&& !mode_lib->vba.InvalidCombinationOfMALLUseForPStateAndStaticScreen\n\t\t\t\t&& mode_lib->vba.DSCCLKRequiredMoreThanSupported[i] == false\n\t\t\t\t&& mode_lib->vba.PixelsPerLinePerDSCUnitSupport[i]\n\t\t\t\t&& mode_lib->vba.DTBCLKRequiredMoreThanSupported[i] == false\n\t\t\t\t&& !mode_lib->vba.InvalidCombinationOfMALLUseForPState\n\t\t\t\t&& !mode_lib->vba.ImmediateFlipRequiredButTheRequirementForEachSurfaceIsNotSpecified\n\t\t\t\t&& mode_lib->vba.ROBSupport[i][j] == true\n\t\t\t\t&& mode_lib->vba.DISPCLK_DPPCLK_Support[i][j] == true\n\t\t\t\t&& mode_lib->vba.TotalAvailablePipesSupport[i][j] == true\n\t\t\t\t&& mode_lib->vba.NumberOfOTGSupport == true\n\t\t\t\t&& mode_lib->vba.NumberOfHDMIFRLSupport == true\n\t\t\t\t&& mode_lib->vba.EnoughWritebackUnits == true\n\t\t\t\t&& mode_lib->vba.WritebackLatencySupport == true\n\t\t\t\t&& mode_lib->vba.WritebackScaleRatioAndTapsSupport == true\n\t\t\t\t&& mode_lib->vba.CursorSupport == true && mode_lib->vba.PitchSupport == true\n\t\t\t\t&& mode_lib->vba.ViewportExceedsSurface == false\n\t\t\t\t&& mode_lib->vba.PrefetchSupported[i][j] == true\n\t\t\t\t&& mode_lib->vba.VActiveBandwithSupport[i][j] == true\n\t\t\t\t&& mode_lib->vba.DynamicMetadataSupported[i][j] == true\n\t\t\t\t&& mode_lib->vba.TotalVerticalActiveBandwidthSupport[i][j] == true\n\t\t\t\t&& mode_lib->vba.VRatioInPrefetchSupported[i][j] == true\n\t\t\t\t&& mode_lib->vba.PTEBufferSizeNotExceeded[i][j] == true\n\t\t\t\t&& mode_lib->vba.DCCMetaBufferSizeNotExceeded[i][j] == true\n\t\t\t\t&& mode_lib->vba.NonsupportedDSCInputBPC == false\n\t\t\t\t&& !mode_lib->vba.ExceededMALLSize\n\t\t\t\t&& (mode_lib->vba.NotEnoughDETSwathFillLatencyHidingPerState[i][j] == false\n\t\t\t\t|| i == v->soc.num_states - 1)\n\t\t\t\t&& ((mode_lib->vba.HostVMEnable == false\n\t\t\t\t&& !mode_lib->vba.ImmediateFlipRequiredFinal)\n\t\t\t\t|| mode_lib->vba.ImmediateFlipSupportedForState[i][j])\n\t\t\t\t&& (!mode_lib->vba.DRAMClockChangeRequirementFinal\n\t\t\t\t|| i == v->soc.num_states - 1\n\t\t\t\t|| mode_lib->vba.DRAMClockChangeSupport[i][j] != dm_dram_clock_change_unsupported)\n\t\t\t\t&& (!mode_lib->vba.FCLKChangeRequirementFinal || i == v->soc.num_states - 1\n\t\t\t\t|| mode_lib->vba.FCLKChangeSupport[i][j] != dm_fclock_change_unsupported)\n\t\t\t\t&& (!mode_lib->vba.USRRetrainingRequiredFinal\n\t\t\t\t|| mode_lib->vba.USRRetrainingSupport[i][j])) {\n\t\t\t\tmode_lib->vba.ModeSupport[i][j] = true;\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.ModeSupport[i][j] = false;\n\t\t\t}\n\t\t}\n\t}\n}\n\nvoid dml32_ModeSupportAndSystemConfigurationFull(struct display_mode_lib *mode_lib)\n{\n\tstruct vba_vars_st *v = &mode_lib->vba;\n\tint i, j, start_state;\n\tunsigned int k, m;\n\tunsigned int MaximumMPCCombine;\n\tunsigned int NumberOfNonCombinedSurfaceOfMaximumBandwidth;\n\tunsigned int TotalSlots;\n\tbool CompBufReservedSpaceNeedAdjustment;\n\tbool CompBufReservedSpaceNeedAdjustmentSingleDPP;\n\n#ifdef __DML_VBA_DEBUG__\n\tdml_print(\"DML::%s: called\\n\", __func__);\n#endif\n\n\t \n\tif (mode_lib->validate_max_state)\n\t\tstart_state = v->soc.num_states - 1;\n\telse\n\t\tstart_state = 0;\n\n\t \n\n\tmode_lib->vba.ScaleRatioAndTapsSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (mode_lib->vba.ScalerEnabled[k] == false\n\t\t\t\t&& ((mode_lib->vba.SourcePixelFormat[k] != dm_444_64\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_32\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_8\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_rgbe\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_rgbe_alpha)\n\t\t\t\t\t\t|| mode_lib->vba.HRatio[k] != 1.0 || mode_lib->vba.htaps[k] != 1.0\n\t\t\t\t\t\t|| mode_lib->vba.VRatio[k] != 1.0 || mode_lib->vba.vtaps[k] != 1.0)) {\n\t\t\tmode_lib->vba.ScaleRatioAndTapsSupport = false;\n\t\t} else if (mode_lib->vba.vtaps[k] < 1.0 || mode_lib->vba.vtaps[k] > 8.0 || mode_lib->vba.htaps[k] < 1.0\n\t\t\t\t|| mode_lib->vba.htaps[k] > 8.0\n\t\t\t\t|| (mode_lib->vba.htaps[k] > 1.0 && (mode_lib->vba.htaps[k] % 2) == 1)\n\t\t\t\t|| mode_lib->vba.HRatio[k] > mode_lib->vba.MaxHSCLRatio\n\t\t\t\t|| mode_lib->vba.VRatio[k] > mode_lib->vba.MaxVSCLRatio\n\t\t\t\t|| mode_lib->vba.HRatio[k] > mode_lib->vba.htaps[k]\n\t\t\t\t|| mode_lib->vba.VRatio[k] > mode_lib->vba.vtaps[k]\n\t\t\t\t|| (mode_lib->vba.SourcePixelFormat[k] != dm_444_64\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_32\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_8\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_rgbe\n\t\t\t\t\t\t&& (mode_lib->vba.VTAPsChroma[k] < 1\n\t\t\t\t\t\t\t\t|| mode_lib->vba.VTAPsChroma[k] > 8\n\t\t\t\t\t\t\t\t|| mode_lib->vba.HTAPsChroma[k] < 1\n\t\t\t\t\t\t\t\t|| mode_lib->vba.HTAPsChroma[k] > 8\n\t\t\t\t\t\t\t\t|| (mode_lib->vba.HTAPsChroma[k] > 1\n\t\t\t\t\t\t\t\t\t\t&& mode_lib->vba.HTAPsChroma[k] % 2\n\t\t\t\t\t\t\t\t\t\t\t\t== 1)\n\t\t\t\t\t\t\t\t|| mode_lib->vba.HRatioChroma[k]\n\t\t\t\t\t\t\t\t\t\t> mode_lib->vba.MaxHSCLRatio\n\t\t\t\t\t\t\t\t|| mode_lib->vba.VRatioChroma[k]\n\t\t\t\t\t\t\t\t\t\t> mode_lib->vba.MaxVSCLRatio\n\t\t\t\t\t\t\t\t|| mode_lib->vba.HRatioChroma[k]\n\t\t\t\t\t\t\t\t\t\t> mode_lib->vba.HTAPsChroma[k]\n\t\t\t\t\t\t\t\t|| mode_lib->vba.VRatioChroma[k]\n\t\t\t\t\t\t\t\t\t\t> mode_lib->vba.VTAPsChroma[k]))) {\n\t\t\tmode_lib->vba.ScaleRatioAndTapsSupport = false;\n\t\t}\n\t}\n\n\t \n\tmode_lib->vba.SourceFormatPixelAndScanSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (mode_lib->vba.SurfaceTiling[k] == dm_sw_linear\n\t\t\t&& (!(!IsVertical((enum dm_rotation_angle) mode_lib->vba.SourceScan[k]))\n\t\t\t\t|| mode_lib->vba.DCCEnable[k] == true)) {\n\t\t\tmode_lib->vba.SourceFormatPixelAndScanSupport = false;\n\t\t}\n\t}\n\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tdml32_CalculateBytePerPixelAndBlockSizes(\n\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\tmode_lib->vba.SurfaceTiling[k],\n\n\t\t\t\t \n\t\t\t\t&mode_lib->vba.BytePerPixelY[k],\n\t\t\t\t&mode_lib->vba.BytePerPixelC[k],\n\t\t\t\t&mode_lib->vba.BytePerPixelInDETY[k],\n\t\t\t\t&mode_lib->vba.BytePerPixelInDETC[k],\n\t\t\t\t&mode_lib->vba.Read256BlockHeightY[k],\n\t\t\t\t&mode_lib->vba.Read256BlockHeightC[k],\n\t\t\t\t&mode_lib->vba.Read256BlockWidthY[k],\n\t\t\t\t&mode_lib->vba.Read256BlockWidthC[k],\n\t\t\t\t&mode_lib->vba.MacroTileHeightY[k],\n\t\t\t\t&mode_lib->vba.MacroTileHeightC[k],\n\t\t\t\t&mode_lib->vba.MacroTileWidthY[k],\n\t\t\t\t&mode_lib->vba.MacroTileWidthC[k]);\n\t}\n\n\t \n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (!IsVertical(mode_lib->vba.SourceRotation[k])) {\n\t\t\tv->SwathWidthYSingleDPP[k] = mode_lib->vba.ViewportWidth[k];\n\t\t\tv->SwathWidthCSingleDPP[k] = mode_lib->vba.ViewportWidthChroma[k];\n\t\t} else {\n\t\t\tv->SwathWidthYSingleDPP[k] = mode_lib->vba.ViewportHeight[k];\n\t\t\tv->SwathWidthCSingleDPP[k] = mode_lib->vba.ViewportHeightChroma[k];\n\t\t}\n\t}\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tv->ReadBandwidthLuma[k] = v->SwathWidthYSingleDPP[k] * dml_ceil(v->BytePerPixelInDETY[k], 1.0)\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]) * mode_lib->vba.VRatio[k];\n\t\tv->ReadBandwidthChroma[k] = v->SwathWidthYSingleDPP[k] / 2 * dml_ceil(v->BytePerPixelInDETC[k], 2.0)\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]) * mode_lib->vba.VRatio[k]\n\t\t\t\t/ 2.0;\n\t}\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true && mode_lib->vba.WritebackPixelFormat[k] == dm_444_64) {\n\t\t\tv->WriteBandwidth[k] = mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t/ (mode_lib->vba.WritebackSourceHeight[k] * mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]) * 8.0;\n\t\t} else if (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\tv->WriteBandwidth[k] = mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t/ (mode_lib->vba.WritebackSourceHeight[k] * mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]) * 4.0;\n\t\t} else {\n\t\t\tv->WriteBandwidth[k] = 0.0;\n\t\t}\n\t}\n\n\t \n\n\tmode_lib->vba.WritebackLatencySupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true\n\t\t\t\t&& (v->WriteBandwidth[k]\n\t\t\t\t\t\t> mode_lib->vba.WritebackInterfaceBufferSize * 1024\n\t\t\t\t\t\t\t\t/ mode_lib->vba.WritebackLatency)) {\n\t\t\tmode_lib->vba.WritebackLatencySupport = false;\n\t\t}\n\t}\n\n\t \n\tmode_lib->vba.EnoughWritebackUnits = true;\n\tmode_lib->vba.TotalNumberOfActiveWriteback = 0;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true)\n\t\t\tmode_lib->vba.TotalNumberOfActiveWriteback = mode_lib->vba.TotalNumberOfActiveWriteback + 1;\n\t}\n\n\tif (mode_lib->vba.TotalNumberOfActiveWriteback > mode_lib->vba.MaxNumWriteback)\n\t\tmode_lib->vba.EnoughWritebackUnits = false;\n\n\t \n\tmode_lib->vba.WritebackScaleRatioAndTapsSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\tif (mode_lib->vba.WritebackHRatio[k] > mode_lib->vba.WritebackMaxHSCLRatio\n\t\t\t\t\t|| mode_lib->vba.WritebackVRatio[k] > mode_lib->vba.WritebackMaxVSCLRatio\n\t\t\t\t\t|| mode_lib->vba.WritebackHRatio[k] < mode_lib->vba.WritebackMinHSCLRatio\n\t\t\t\t\t|| mode_lib->vba.WritebackVRatio[k] < mode_lib->vba.WritebackMinVSCLRatio\n\t\t\t\t\t|| mode_lib->vba.WritebackHTaps[k] > mode_lib->vba.WritebackMaxHSCLTaps\n\t\t\t\t\t|| mode_lib->vba.WritebackVTaps[k] > mode_lib->vba.WritebackMaxVSCLTaps\n\t\t\t\t\t|| mode_lib->vba.WritebackHRatio[k] > mode_lib->vba.WritebackHTaps[k]\n\t\t\t\t\t|| mode_lib->vba.WritebackVRatio[k] > mode_lib->vba.WritebackVTaps[k]\n\t\t\t\t\t|| (mode_lib->vba.WritebackHTaps[k] > 2.0\n\t\t\t\t\t\t\t&& ((mode_lib->vba.WritebackHTaps[k] % 2) == 1))) {\n\t\t\t\tmode_lib->vba.WritebackScaleRatioAndTapsSupport = false;\n\t\t\t}\n\t\t\tif (2.0 * mode_lib->vba.WritebackDestinationWidth[k] * (mode_lib->vba.WritebackVTaps[k] - 1)\n\t\t\t\t\t* 57 > mode_lib->vba.WritebackLineBufferSize) {\n\t\t\t\tmode_lib->vba.WritebackScaleRatioAndTapsSupport = false;\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tdml32_CalculateSinglePipeDPPCLKAndSCLThroughput(mode_lib->vba.HRatio[k], mode_lib->vba.HRatioChroma[k],\n\t\t\t\tmode_lib->vba.VRatio[k], mode_lib->vba.VRatioChroma[k],\n\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput, mode_lib->vba.MaxPSCLToLBThroughput,\n\t\t\t\tmode_lib->vba.PixelClock[k], mode_lib->vba.SourcePixelFormat[k],\n\t\t\t\tmode_lib->vba.htaps[k], mode_lib->vba.HTAPsChroma[k], mode_lib->vba.vtaps[k],\n\t\t\t\tmode_lib->vba.VTAPsChroma[k],\n\t\t\t\t \n\t\t\t\t&mode_lib->vba.PSCL_FACTOR[k], &mode_lib->vba.PSCL_FACTOR_CHROMA[k],\n\t\t\t\t&mode_lib->vba.MinDPPCLKUsingSingleDPP[k]);\n\t}\n\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\n\t\tif (mode_lib->vba.SurfaceTiling[k] == dm_sw_linear) {\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportLuma = 8192;\n\t\t} else if (!IsVertical(mode_lib->vba.SourceRotation[k]) && v->BytePerPixelC[k] > 0\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_rgbe_alpha) {\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportLuma = 7680;\n\t\t} else if (IsVertical(mode_lib->vba.SourceRotation[k]) && v->BytePerPixelC[k] > 0\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_rgbe_alpha) {\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportLuma = 4320;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_rgbe_alpha) {\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportLuma = 3840;\n\t\t} else if (IsVertical(mode_lib->vba.SourceRotation[k]) && v->BytePerPixelY[k] == 8 &&\n\t\t\t\tmode_lib->vba.DCCEnable[k] == true) {\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportLuma = 3072;\n\t\t} else {\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportLuma = 6144;\n\t\t}\n\n\t\tif (mode_lib->vba.SourcePixelFormat[k] == dm_420_8 || mode_lib->vba.SourcePixelFormat[k] == dm_420_10\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_420_12) {\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportChroma = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportLuma / 2.0;\n\t\t} else {\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportChroma = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportLuma;\n\t\t}\n\t\tv->MaximumSwathWidthInLineBufferLuma = mode_lib->vba.LineBufferSizeFinal\n\t\t\t\t* dml_max(mode_lib->vba.HRatio[k], 1.0) / mode_lib->vba.LBBitPerPixel[k]\n\t\t\t\t/ (mode_lib->vba.vtaps[k] + dml_max(dml_ceil(mode_lib->vba.VRatio[k], 1.0) - 2, 0.0));\n\t\tif (v->BytePerPixelC[k] == 0.0) {\n\t\t\tv->MaximumSwathWidthInLineBufferChroma = 0;\n\t\t} else {\n\t\t\tv->MaximumSwathWidthInLineBufferChroma = mode_lib->vba.LineBufferSizeFinal\n\t\t\t\t\t* dml_max(mode_lib->vba.HRatioChroma[k], 1.0) / mode_lib->vba.LBBitPerPixel[k]\n\t\t\t\t\t/ (mode_lib->vba.VTAPsChroma[k]\n\t\t\t\t\t\t\t+ dml_max(dml_ceil(mode_lib->vba.VRatioChroma[k], 1.0) - 2,\n\t\t\t\t\t\t\t\t\t0.0));\n\t\t}\n\t\tv->MaximumSwathWidthLuma[k] = dml_min(v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportLuma,\n\t\t\t\tv->MaximumSwathWidthInLineBufferLuma);\n\t\tv->MaximumSwathWidthChroma[k] = dml_min(v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaximumSwathWidthSupportChroma,\n\t\t\t\tv->MaximumSwathWidthInLineBufferChroma);\n\t}\n\n\tdml32_CalculateSwathAndDETConfiguration(\n\t\t\tmode_lib->vba.DETSizeOverride,\n\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\tmode_lib->vba.ConfigReturnBufferSizeInKByte,\n\t\t\tmode_lib->vba.MaxTotalDETInKByte,\n\t\t\tmode_lib->vba.MinCompressedBufferSizeInKByte,\n\t\t\t1,  \n\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\tmode_lib->vba.nomDETInKByte,\n\t\t\tmode_lib->vba.UseUnboundedRequesting,\n\t\t\tmode_lib->vba.DisableUnboundRequestIfCompBufReservedSpaceNeedAdjustment,\n\t\t\tmode_lib->vba.ip.pixel_chunk_size_kbytes,\n\t\t\tmode_lib->vba.ip.rob_buffer_size_kbytes,\n\t\t\tmode_lib->vba.CompressedBufferSegmentSizeInkByteFinal,\n\t\t\tmode_lib->vba.Output,\n\t\t\tmode_lib->vba.ReadBandwidthLuma,\n\t\t\tmode_lib->vba.ReadBandwidthChroma,\n\t\t\tmode_lib->vba.MaximumSwathWidthLuma,\n\t\t\tmode_lib->vba.MaximumSwathWidthChroma,\n\t\t\tmode_lib->vba.SourceRotation,\n\t\t\tmode_lib->vba.ViewportStationary,\n\t\t\tmode_lib->vba.SourcePixelFormat,\n\t\t\tmode_lib->vba.SurfaceTiling,\n\t\t\tmode_lib->vba.ViewportWidth,\n\t\t\tmode_lib->vba.ViewportHeight,\n\t\t\tmode_lib->vba.ViewportXStartY,\n\t\t\tmode_lib->vba.ViewportYStartY,\n\t\t\tmode_lib->vba.ViewportXStartC,\n\t\t\tmode_lib->vba.ViewportYStartC,\n\t\t\tmode_lib->vba.SurfaceWidthY,\n\t\t\tmode_lib->vba.SurfaceWidthC,\n\t\t\tmode_lib->vba.SurfaceHeightY,\n\t\t\tmode_lib->vba.SurfaceHeightC,\n\t\t\tmode_lib->vba.Read256BlockHeightY,\n\t\t\tmode_lib->vba.Read256BlockHeightC,\n\t\t\tmode_lib->vba.Read256BlockWidthY,\n\t\t\tmode_lib->vba.Read256BlockWidthC,\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_odm_mode,\n\t\t\tmode_lib->vba.BlendingAndTiming,\n\t\t\tmode_lib->vba.BytePerPixelY,\n\t\t\tmode_lib->vba.BytePerPixelC,\n\t\t\tmode_lib->vba.BytePerPixelInDETY,\n\t\t\tmode_lib->vba.BytePerPixelInDETC,\n\t\t\tmode_lib->vba.HActive,\n\t\t\tmode_lib->vba.HRatio,\n\t\t\tmode_lib->vba.HRatioChroma,\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[0],  \n\n\t\t\t \n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[1],  \n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[2],  \n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_double_array[0],  \n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_double_array[1],  \n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[3],  \n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[4],  \n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[5],  \n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[6],  \n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[7],  \n\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_boolean_array[0][0],  \n\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[0][0],  \n\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[1][0],  \n\t\t\t&CompBufReservedSpaceNeedAdjustmentSingleDPP,\n\t\t\tmode_lib->vba.SingleDPPViewportSizeSupportPerSurface, \n\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_boolean_array[1][0]);  \n\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MPCCombineMethodAsNeededForPStateChangeAndVoltage = false;\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MPCCombineMethodAsPossible = false;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tif (mode_lib->vba.MPCCombineUse[k] == dm_mpc_reduce_voltage_and_clocks)\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MPCCombineMethodAsNeededForPStateChangeAndVoltage = true;\n\t\tif (mode_lib->vba.MPCCombineUse[k] == dm_mpc_always_when_possible)\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MPCCombineMethodAsPossible = true;\n\t}\n\tmode_lib->vba.MPCCombineMethodIncompatible = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MPCCombineMethodAsNeededForPStateChangeAndVoltage\n\t\t\t&& v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MPCCombineMethodAsPossible;\n\n\tfor (i = start_state; i < v->soc.num_states; i++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j] = 0;\n\t\t\tmode_lib->vba.TotalAvailablePipesSupport[i][j] = true;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ODMModeNoDSC = dm_odm_combine_mode_disabled;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ODMModeDSC = dm_odm_combine_mode_disabled;\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tdml32_CalculateODMMode(\n\t\t\t\t\t\tmode_lib->vba.MaximumPixelsPerLinePerDSCUnit,\n\t\t\t\t\t\tmode_lib->vba.HActive[k],\n\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\tmode_lib->vba.ODMUse[k],\n\t\t\t\t\t\tmode_lib->vba.MaxDispclk[i],\n\t\t\t\t\t\tmode_lib->vba.MaxDispclk[v->soc.num_states - 1],\n\t\t\t\t\t\tfalse,\n\t\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j],\n\t\t\t\t\t\tmode_lib->vba.MaxNumDPP,\n\t\t\t\t\t\tmode_lib->vba.PixelClock[k],\n\t\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading,\n\t\t\t\t\t\tmode_lib->vba.DISPCLKRampingMargin,\n\t\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed,\n\t\t\t\t\t\tmode_lib->vba.NumberOfDSCSlices[k],\n\n\t\t\t\t\t\t \n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalAvailablePipesSupportNoDSC,\n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NumberOfDPPNoDSC,\n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ODMModeNoDSC,\n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.RequiredDISPCLKPerSurfaceNoDSC);\n\n\t\t\t\tdml32_CalculateODMMode(\n\t\t\t\t\t\tmode_lib->vba.MaximumPixelsPerLinePerDSCUnit,\n\t\t\t\t\t\tmode_lib->vba.HActive[k],\n\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\tmode_lib->vba.ODMUse[k],\n\t\t\t\t\t\tmode_lib->vba.MaxDispclk[i],\n\t\t\t\t\t\tmode_lib->vba.MaxDispclk[v->soc.num_states - 1],\n\t\t\t\t\t\ttrue,\n\t\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j],\n\t\t\t\t\t\tmode_lib->vba.MaxNumDPP,\n\t\t\t\t\t\tmode_lib->vba.PixelClock[k],\n\t\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading,\n\t\t\t\t\t\tmode_lib->vba.DISPCLKRampingMargin,\n\t\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed,\n\t\t\t\t\t\tmode_lib->vba.NumberOfDSCSlices[k],\n\n\t\t\t\t\t\t \n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalAvailablePipesSupportDSC,\n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NumberOfDPPDSC,\n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ODMModeDSC,\n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.RequiredDISPCLKPerSurfaceDSC);\n\n\t\t\t\tdml32_CalculateOutputLink(\n\t\t\t\t\t\tmode_lib->vba.PHYCLKPerState[i],\n\t\t\t\t\t\tmode_lib->vba.PHYCLKD18PerState[i],\n\t\t\t\t\t\tmode_lib->vba.PHYCLKD32PerState[i],\n\t\t\t\t\t\tmode_lib->vba.Downspreading,\n\t\t\t\t\t\t(mode_lib->vba.BlendingAndTiming[k] == k),\n\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\tmode_lib->vba.HTotal[k],\n\t\t\t\t\t\tmode_lib->vba.HActive[k],\n\t\t\t\t\t\tmode_lib->vba.PixelClockBackEnd[k],\n\t\t\t\t\t\tmode_lib->vba.ForcedOutputLinkBPP[k],\n\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k],\n\t\t\t\t\t\tmode_lib->vba.NumberOfDSCSlices[k],\n\t\t\t\t\t\tmode_lib->vba.AudioSampleRate[k],\n\t\t\t\t\t\tmode_lib->vba.AudioSampleLayout[k],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ODMModeNoDSC,\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ODMModeDSC,\n\t\t\t\t\t\tmode_lib->vba.DSCEnable[k],\n\t\t\t\t\t\tmode_lib->vba.OutputLinkDPLanes[k],\n\t\t\t\t\t\tmode_lib->vba.OutputLinkDPRate[k],\n\n\t\t\t\t\t\t \n\t\t\t\t\t\t&mode_lib->vba.RequiresDSC[i][k],\n\t\t\t\t\t\t&mode_lib->vba.RequiresFEC[i][k],\n\t\t\t\t\t\t&mode_lib->vba.OutputBppPerState[i][k],\n\t\t\t\t\t\t&mode_lib->vba.OutputTypePerState[i][k],\n\t\t\t\t\t\t&mode_lib->vba.OutputRatePerState[i][k],\n\t\t\t\t\t\t&mode_lib->vba.RequiredSlots[i][k]);\n\n\t\t\t\tif (mode_lib->vba.RequiresDSC[i][k] == false) {\n\t\t\t\t\tmode_lib->vba.ODMCombineEnablePerState[i][k] = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ODMModeNoDSC;\n\t\t\t\t\tmode_lib->vba.RequiredDISPCLKPerSurface[i][j][k] =\n\t\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.RequiredDISPCLKPerSurfaceNoDSC;\n\t\t\t\t\tif (!v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalAvailablePipesSupportNoDSC)\n\t\t\t\t\t\tmode_lib->vba.TotalAvailablePipesSupport[i][j] = false;\n\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j] =\n\t\t\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j] + v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NumberOfDPPNoDSC;\n\t\t\t\t} else {\n\t\t\t\t\tmode_lib->vba.ODMCombineEnablePerState[i][k] = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ODMModeDSC;\n\t\t\t\t\tmode_lib->vba.RequiredDISPCLKPerSurface[i][j][k] =\n\t\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.RequiredDISPCLKPerSurfaceDSC;\n\t\t\t\t\tif (!v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalAvailablePipesSupportDSC)\n\t\t\t\t\t\tmode_lib->vba.TotalAvailablePipesSupport[i][j] = false;\n\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j] =\n\t\t\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j] + v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NumberOfDPPDSC;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tif (mode_lib->vba.ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_4to1) {\n\t\t\t\t\tmode_lib->vba.MPCCombine[i][j][k] = false;\n\t\t\t\t\tmode_lib->vba.NoOfDPP[i][j][k] = 4;\n\t\t\t\t} else if (mode_lib->vba.ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_2to1) {\n\t\t\t\t\tmode_lib->vba.MPCCombine[i][j][k] = false;\n\t\t\t\t\tmode_lib->vba.NoOfDPP[i][j][k] = 2;\n\t\t\t\t} else if (mode_lib->vba.MPCCombineUse[k] == dm_mpc_never) {\n\t\t\t\t\tmode_lib->vba.MPCCombine[i][j][k] = false;\n\t\t\t\t\tmode_lib->vba.NoOfDPP[i][j][k] = 1;\n\t\t\t\t} else if (dml32_RoundToDFSGranularity(\n\t\t\t\t\t\tmode_lib->vba.MinDPPCLKUsingSingleDPP[k]\n\t\t\t\t\t\t\t\t* (1 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading\n\t\t\t\t\t\t\t\t\t\t\t\t/ 100), 1,\n\t\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed) <= mode_lib->vba.MaxDppclk[i] &&\n\t\t\t\tmode_lib->vba.SingleDPPViewportSizeSupportPerSurface[k] == true) {\n\t\t\t\t\tmode_lib->vba.MPCCombine[i][j][k] = false;\n\t\t\t\t\tmode_lib->vba.NoOfDPP[i][j][k] = 1;\n\t\t\t\t} else if (mode_lib->vba.TotalNumberOfActiveDPP[i][j] < mode_lib->vba.MaxNumDPP) {\n\t\t\t\t\tmode_lib->vba.MPCCombine[i][j][k] = true;\n\t\t\t\t\tmode_lib->vba.NoOfDPP[i][j][k] = 2;\n\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j] =\n\t\t\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j] + 1;\n\t\t\t\t} else {\n\t\t\t\t\tmode_lib->vba.MPCCombine[i][j][k] = false;\n\t\t\t\t\tmode_lib->vba.NoOfDPP[i][j][k] = 1;\n\t\t\t\t\tmode_lib->vba.TotalAvailablePipesSupport[i][j] = false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tmode_lib->vba.TotalNumberOfSingleDPPSurfaces[i][j] = 0;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NoChroma = true;\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tif (mode_lib->vba.NoOfDPP[i][j][k] == 1)\n\t\t\t\t\tmode_lib->vba.TotalNumberOfSingleDPPSurfaces[i][j] =\n\t\t\t\t\t\t\tmode_lib->vba.TotalNumberOfSingleDPPSurfaces[i][j] + 1;\n\t\t\t\tif (mode_lib->vba.SourcePixelFormat[k] == dm_420_8\n\t\t\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_420_10\n\t\t\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_420_12\n\t\t\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_rgbe_alpha) {\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NoChroma = false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t\n\t\t\t\n\t\t\tCompBufReservedSpaceNeedAdjustment = (mode_lib->vba.TotalNumberOfActiveDPP[i][j] > 1) ? 0 : CompBufReservedSpaceNeedAdjustmentSingleDPP;\n\n\n\n\t\t\tif (j == 1 && !dml32_UnboundedRequest(mode_lib->vba.UseUnboundedRequesting,\n\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j], v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NoChroma,\n\t\t\t\t\tmode_lib->vba.Output[0],\n\t\t\t\t\tmode_lib->vba.SurfaceTiling[0],\n\t\t\t\t\tCompBufReservedSpaceNeedAdjustment,\n\t\t\t\t\tmode_lib->vba.DisableUnboundRequestIfCompBufReservedSpaceNeedAdjustment)) {\n\t\t\t\twhile (!(mode_lib->vba.TotalNumberOfActiveDPP[i][j] >= mode_lib->vba.MaxNumDPP\n\t\t\t\t\t\t|| mode_lib->vba.TotalNumberOfSingleDPPSurfaces[i][j] == 0)) {\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.BWOfNonCombinedSurfaceOfMaximumBandwidth = 0;\n\t\t\t\t\tNumberOfNonCombinedSurfaceOfMaximumBandwidth = 0;\n\n\t\t\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\t\t\tif (mode_lib->vba.MPCCombineUse[k]\n\t\t\t\t\t\t\t!= dm_mpc_never &&\n\t\t\t\t\t\t\tmode_lib->vba.MPCCombineUse[k] != dm_mpc_reduce_voltage &&\n\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthLuma[k] +\n\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthChroma[k] >\n\t\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.BWOfNonCombinedSurfaceOfMaximumBandwidth &&\n\t\t\t\t\t\t\t(mode_lib->vba.ODMCombineEnablePerState[i][k] !=\n\t\t\t\t\t\t\tdm_odm_combine_mode_2to1 &&\n\t\t\t\t\t\t\tmode_lib->vba.ODMCombineEnablePerState[i][k] !=\n\t\t\t\t\t\t\tdm_odm_combine_mode_4to1) &&\n\t\t\t\t\t\t\t\tmode_lib->vba.MPCCombine[i][j][k] == false) {\n\t\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.BWOfNonCombinedSurfaceOfMaximumBandwidth =\n\t\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthLuma[k]\n\t\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthChroma[k];\n\t\t\t\t\t\t\tNumberOfNonCombinedSurfaceOfMaximumBandwidth = k;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmode_lib->vba.MPCCombine[i][j][NumberOfNonCombinedSurfaceOfMaximumBandwidth] =\n\t\t\t\t\t\t\ttrue;\n\t\t\t\t\tmode_lib->vba.NoOfDPP[i][j][NumberOfNonCombinedSurfaceOfMaximumBandwidth] = 2;\n\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j] =\n\t\t\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP[i][j] + 1;\n\t\t\t\t\tmode_lib->vba.TotalNumberOfSingleDPPSurfaces[i][j] =\n\t\t\t\t\t\t\tmode_lib->vba.TotalNumberOfSingleDPPSurfaces[i][j] - 1;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t\n\t\t\tmode_lib->vba.WritebackRequiredDISPCLK = 0;\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tif (mode_lib->vba.WritebackEnable[k]) {\n\t\t\t\t\tmode_lib->vba.WritebackRequiredDISPCLK = dml_max(\n\t\t\t\t\t\t\tmode_lib->vba.WritebackRequiredDISPCLK,\n\t\t\t\t\t\t\tdml32_CalculateWriteBackDISPCLK(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackSourceWidth[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.HTotal[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLineBufferSize,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tmode_lib->vba.RequiredDISPCLK[i][j] = mode_lib->vba.WritebackRequiredDISPCLK;\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tmode_lib->vba.RequiredDISPCLK[i][j] = dml_max(mode_lib->vba.RequiredDISPCLK[i][j],\n\t\t\t\t\t\tmode_lib->vba.RequiredDISPCLKPerSurface[i][j][k]);\n\t\t\t}\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k)\n\t\t\t\tmode_lib->vba.NoOfDPPThisState[k] = mode_lib->vba.NoOfDPP[i][j][k];\n\n\t\t\tdml32_CalculateDPPCLK(mode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading,\n\t\t\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed, mode_lib->vba.MinDPPCLKUsingSingleDPP,\n\t\t\t\t\tmode_lib->vba.NoOfDPPThisState,\n\t\t\t\t\t \n\t\t\t\t\t&mode_lib->vba.GlobalDPPCLK, mode_lib->vba.RequiredDPPCLKThisState);\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k)\n\t\t\t\tmode_lib->vba.RequiredDPPCLK[i][j][k] = mode_lib->vba.RequiredDPPCLKThisState[k];\n\n\t\t\tmode_lib->vba.DISPCLK_DPPCLK_Support[i][j] = !((mode_lib->vba.RequiredDISPCLK[i][j]\n\t\t\t\t\t> mode_lib->vba.MaxDispclk[i])\n\t\t\t\t\t|| (mode_lib->vba.GlobalDPPCLK > mode_lib->vba.MaxDppclk[i]));\n\n\t\t\tif (mode_lib->vba.TotalNumberOfActiveDPP[i][j] > mode_lib->vba.MaxNumDPP)\n\t\t\t\tmode_lib->vba.TotalAvailablePipesSupport[i][j] = false;\n\t\t} \n\t} \n\n\t \n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveOTG = 0;\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveHDMIFRL = 0;\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveDP2p0 = 0;\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveDP2p0Outputs = 0;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveOTG = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveOTG + 1;\n\t\t\tif (mode_lib->vba.Output[k] == dm_dp2p0) {\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveDP2p0 = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveDP2p0 + 1;\n\t\t\t\tif (mode_lib->vba.OutputMultistreamId[k]\n\t\t\t\t\t\t== k || mode_lib->vba.OutputMultistreamEn[k] == false) {\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveDP2p0Outputs = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveDP2p0Outputs + 1;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tmode_lib->vba.NumberOfOTGSupport = (v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveOTG <= mode_lib->vba.MaxNumOTG);\n\tmode_lib->vba.NumberOfHDMIFRLSupport = (v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveHDMIFRL <= mode_lib->vba.MaxNumHDMIFRLOutputs);\n\tmode_lib->vba.NumberOfDP2p0Support = (v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveDP2p0 <= mode_lib->vba.MaxNumDP2p0Streams\n\t\t\t&& v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalNumberOfActiveDP2p0Outputs <= mode_lib->vba.MaxNumDP2p0Outputs);\n\n\t \n\tmode_lib->vba.NonsupportedDSCInputBPC = false;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (!(mode_lib->vba.DSCInputBitPerComponent[k] == 12.0\n\t\t\t\t|| mode_lib->vba.DSCInputBitPerComponent[k] == 10.0\n\t\t\t\t|| mode_lib->vba.DSCInputBitPerComponent[k] == 8.0)\n\t\t\t\t|| mode_lib->vba.DSCInputBitPerComponent[k] > mode_lib->vba.MaximumDSCBitsPerComponent) {\n\t\t\tmode_lib->vba.NonsupportedDSCInputBPC = true;\n\t\t}\n\t}\n\n\tfor (i = start_state; i < v->soc.num_states; ++i) {\n\t\tmode_lib->vba.ExceededMultistreamSlots[i] = false;\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tif (mode_lib->vba.OutputMultistreamEn[k] == true && mode_lib->vba.OutputMultistreamId[k] == k) {\n\t\t\t\tTotalSlots = mode_lib->vba.RequiredSlots[i][k];\n\t\t\t\tfor (j = 0; j < mode_lib->vba.NumberOfActiveSurfaces; ++j) {\n\t\t\t\t\tif (mode_lib->vba.OutputMultistreamId[j] == k)\n\t\t\t\t\t\tTotalSlots = TotalSlots + mode_lib->vba.RequiredSlots[i][j];\n\t\t\t\t}\n\t\t\t\tif (mode_lib->vba.Output[k] == dm_dp && TotalSlots > 63)\n\t\t\t\t\tmode_lib->vba.ExceededMultistreamSlots[i] = true;\n\t\t\t\tif (mode_lib->vba.Output[k] == dm_dp2p0 && TotalSlots > 64)\n\t\t\t\t\tmode_lib->vba.ExceededMultistreamSlots[i] = true;\n\t\t\t}\n\t\t}\n\t\tmode_lib->vba.LinkCapacitySupport[i] = true;\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k\n\t\t\t\t&& (mode_lib->vba.Output[k] == dm_dp || mode_lib->vba.Output[k] == dm_dp2p0\n\t\t\t\t\t|| mode_lib->vba.Output[k] == dm_edp\n\t\t\t\t\t|| mode_lib->vba.Output[k] == dm_hdmi)\n\t\t\t\t&& mode_lib->vba.OutputBppPerState[i][k] == 0 &&\n\t\t\t\t(mode_lib->vba.UsesMALLForPStateChange[k] != dm_use_mall_pstate_change_phantom_pipe)) {\n\t\t\t\t \n\t\t\t\tmode_lib->vba.LinkCapacitySupport[i] = false;\n\t\t\t}\n\t\t}\n\t}\n\n\tmode_lib->vba.P2IWith420 = false;\n\tmode_lib->vba.DSCOnlyIfNecessaryWithBPP = false;\n\tmode_lib->vba.DSC422NativeNotSupported = false;\n\tmode_lib->vba.LinkRateDoesNotMatchDPVersion = false;\n\tmode_lib->vba.LinkRateForMultistreamNotIndicated = false;\n\tmode_lib->vba.BPPForMultistreamNotIndicated = false;\n\tmode_lib->vba.MultistreamWithHDMIOreDP = false;\n\tmode_lib->vba.MSOOrODMSplitWithNonDPLink = false;\n\tmode_lib->vba.NotEnoughLanesForMSO = false;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tif (mode_lib->vba.BlendingAndTiming[k] == k\n\t\t\t\t&& (mode_lib->vba.Output[k] == dm_dp || mode_lib->vba.Output[k] == dm_dp2p0\n\t\t\t\t\t\t|| mode_lib->vba.Output[k] == dm_edp\n\t\t\t\t\t\t|| mode_lib->vba.Output[k] == dm_hdmi)) {\n\t\t\tif (mode_lib->vba.OutputFormat[k]\n\t\t\t\t\t== dm_420 && mode_lib->vba.Interlace[k] == 1 &&\n\t\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP == true)\n\t\t\t\tmode_lib->vba.P2IWith420 = true;\n\n\t\t\tif (mode_lib->vba.DSCEnable[k] && mode_lib->vba.ForcedOutputLinkBPP[k] != 0)\n\t\t\t\tmode_lib->vba.DSCOnlyIfNecessaryWithBPP = true;\n\t\t\tif (mode_lib->vba.DSCEnable[k] && mode_lib->vba.OutputFormat[k] == dm_n422\n\t\t\t\t\t&& !mode_lib->vba.DSC422NativeSupport)\n\t\t\t\tmode_lib->vba.DSC422NativeNotSupported = true;\n\n\t\t\tif (((mode_lib->vba.OutputLinkDPRate[k] == dm_dp_rate_hbr\n\t\t\t\t\t|| mode_lib->vba.OutputLinkDPRate[k] == dm_dp_rate_hbr2\n\t\t\t\t\t|| mode_lib->vba.OutputLinkDPRate[k] == dm_dp_rate_hbr3)\n\t\t\t\t\t&& mode_lib->vba.Output[k] != dm_dp && mode_lib->vba.Output[k] != dm_edp)\n\t\t\t\t\t|| ((mode_lib->vba.OutputLinkDPRate[k] == dm_dp_rate_uhbr10\n\t\t\t\t\t\t\t|| mode_lib->vba.OutputLinkDPRate[k] == dm_dp_rate_uhbr13p5\n\t\t\t\t\t\t\t|| mode_lib->vba.OutputLinkDPRate[k] == dm_dp_rate_uhbr20)\n\t\t\t\t\t\t\t&& mode_lib->vba.Output[k] != dm_dp2p0))\n\t\t\t\tmode_lib->vba.LinkRateDoesNotMatchDPVersion = true;\n\n\t\t\tif (mode_lib->vba.OutputMultistreamEn[k] == true) {\n\t\t\t\tif (mode_lib->vba.OutputMultistreamId[k] == k\n\t\t\t\t\t&& mode_lib->vba.OutputLinkDPRate[k] == dm_dp_rate_na)\n\t\t\t\t\tmode_lib->vba.LinkRateForMultistreamNotIndicated = true;\n\t\t\t\tif (mode_lib->vba.OutputMultistreamId[k] == k && mode_lib->vba.ForcedOutputLinkBPP[k] == 0)\n\t\t\t\t\tmode_lib->vba.BPPForMultistreamNotIndicated = true;\n\t\t\t\tfor (j = 0; j < mode_lib->vba.NumberOfActiveSurfaces; ++j) {\n\t\t\t\t\tif (mode_lib->vba.OutputMultistreamId[k] == j\n\t\t\t\t\t\t&& mode_lib->vba.ForcedOutputLinkBPP[k] == 0)\n\t\t\t\t\t\tmode_lib->vba.BPPForMultistreamNotIndicated = true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ((mode_lib->vba.Output[k] == dm_edp || mode_lib->vba.Output[k] == dm_hdmi)) {\n\t\t\t\tif (mode_lib->vba.OutputMultistreamEn[k] == true && mode_lib->vba.OutputMultistreamId[k] == k)\n\t\t\t\t\tmode_lib->vba.MultistreamWithHDMIOreDP = true;\n\t\t\t\tfor (j = 0; j < mode_lib->vba.NumberOfActiveSurfaces; ++j) {\n\t\t\t\t\tif (mode_lib->vba.OutputMultistreamEn[k] == true && mode_lib->vba.OutputMultistreamId[k] == j)\n\t\t\t\t\t\tmode_lib->vba.MultistreamWithHDMIOreDP = true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (mode_lib->vba.Output[k] != dm_dp\n\t\t\t\t\t&& (mode_lib->vba.ODMUse[k] == dm_odm_split_policy_1to2\n\t\t\t\t\t\t\t|| mode_lib->vba.ODMUse[k] == dm_odm_mso_policy_1to2\n\t\t\t\t\t\t\t|| mode_lib->vba.ODMUse[k] == dm_odm_mso_policy_1to4))\n\t\t\t\tmode_lib->vba.MSOOrODMSplitWithNonDPLink = true;\n\n\t\t\tif ((mode_lib->vba.ODMUse[k] == dm_odm_mso_policy_1to2\n\t\t\t\t\t&& mode_lib->vba.OutputLinkDPLanes[k] < 2)\n\t\t\t\t\t|| (mode_lib->vba.ODMUse[k] == dm_odm_mso_policy_1to4\n\t\t\t\t\t\t\t&& mode_lib->vba.OutputLinkDPLanes[k] < 4))\n\t\t\t\tmode_lib->vba.NotEnoughLanesForMSO = true;\n\t\t}\n\t}\n\n\tfor (i = start_state; i < v->soc.num_states; ++i) {\n\t\tmode_lib->vba.DTBCLKRequiredMoreThanSupported[i] = false;\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k\n\t\t\t\t\t&& dml32_RequiredDTBCLK(mode_lib->vba.RequiresDSC[i][k],\n\t\t\t\t\t\t\tmode_lib->vba.PixelClockBackEnd[k],\n\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\tmode_lib->vba.OutputBppPerState[i][k],\n\t\t\t\t\t\t\tmode_lib->vba.NumberOfDSCSlices[k], mode_lib->vba.HTotal[k],\n\t\t\t\t\t\t\tmode_lib->vba.HActive[k], mode_lib->vba.AudioSampleRate[k],\n\t\t\t\t\t\t\tmode_lib->vba.AudioSampleLayout[k])\n\t\t\t\t\t\t\t> mode_lib->vba.DTBCLKPerState[i]) {\n\t\t\t\tmode_lib->vba.DTBCLKRequiredMoreThanSupported[i] = true;\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (i = start_state; i < v->soc.num_states; ++i) {\n\t\tmode_lib->vba.ODMCombine2To1SupportCheckOK[i] = true;\n\t\tmode_lib->vba.ODMCombine4To1SupportCheckOK[i] = true;\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k\n\t\t\t\t\t&& mode_lib->vba.ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_2to1\n\t\t\t\t\t&& mode_lib->vba.Output[k] == dm_hdmi) {\n\t\t\t\tmode_lib->vba.ODMCombine2To1SupportCheckOK[i] = false;\n\t\t\t}\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k\n\t\t\t\t\t&& mode_lib->vba.ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_4to1\n\t\t\t\t\t&& (mode_lib->vba.Output[k] == dm_dp || mode_lib->vba.Output[k] == dm_edp\n\t\t\t\t\t\t\t|| mode_lib->vba.Output[k] == dm_hdmi)) {\n\t\t\t\tmode_lib->vba.ODMCombine4To1SupportCheckOK[i] = false;\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (i = start_state; i < v->soc.num_states; i++) {\n\t\tmode_lib->vba.DSCCLKRequiredMoreThanSupported[i] = false;\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\t\tif (mode_lib->vba.Output[k] == dm_dp || mode_lib->vba.Output[k] == dm_dp2p0\n\t\t\t\t\t\t|| mode_lib->vba.Output[k] == dm_edp) {\n\t\t\t\t\tif (mode_lib->vba.OutputFormat[k] == dm_420) {\n\t\t\t\t\t\tmode_lib->vba.DSCFormatFactor = 2;\n\t\t\t\t\t} else if (mode_lib->vba.OutputFormat[k] == dm_444) {\n\t\t\t\t\t\tmode_lib->vba.DSCFormatFactor = 1;\n\t\t\t\t\t} else if (mode_lib->vba.OutputFormat[k] == dm_n422) {\n\t\t\t\t\t\tmode_lib->vba.DSCFormatFactor = 2;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.DSCFormatFactor = 1;\n\t\t\t\t\t}\n\t\t\t\t\tif (mode_lib->vba.RequiresDSC[i][k] == true) {\n\t\t\t\t\t\tif (mode_lib->vba.ODMCombineEnablePerState[i][k]\n\t\t\t\t\t\t\t\t== dm_odm_combine_mode_4to1) {\n\t\t\t\t\t\t\tif (mode_lib->vba.PixelClockBackEnd[k] / 12.0 / mode_lib->vba.DSCFormatFactor > (1.0 - mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0) * mode_lib->vba.MaxDSCCLK[i])\n\t\t\t\t\t\t\t\tmode_lib->vba.DSCCLKRequiredMoreThanSupported[i] = true;\n\t\t\t\t\t\t} else if (mode_lib->vba.ODMCombineEnablePerState[i][k]\n\t\t\t\t\t\t\t\t== dm_odm_combine_mode_2to1) {\n\t\t\t\t\t\t\tif (mode_lib->vba.PixelClockBackEnd[k] / 6.0 / mode_lib->vba.DSCFormatFactor > (1.0 - mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0) * mode_lib->vba.MaxDSCCLK[i])\n\t\t\t\t\t\t\t\tmode_lib->vba.DSCCLKRequiredMoreThanSupported[i] = true;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif (mode_lib->vba.PixelClockBackEnd[k] / 3.0 / mode_lib->vba.DSCFormatFactor > (1.0 - mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0) * mode_lib->vba.MaxDSCCLK[i])\n\t\t\t\t\t\t\t\tmode_lib->vba.DSCCLKRequiredMoreThanSupported[i] = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalDSCUnitsRequired = 0;\n\n\tfor (i = start_state; i < v->soc.num_states; ++i) {\n\t\tmode_lib->vba.NotEnoughDSCUnits[i] = false;\n\t\tmode_lib->vba.NotEnoughDSCSlices[i] = false;\n\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalDSCUnitsRequired = 0;\n\t\tmode_lib->vba.PixelsPerLinePerDSCUnitSupport[i] = true;\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tif (mode_lib->vba.RequiresDSC[i][k] == true) {\n\t\t\t\tif (mode_lib->vba.ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_4to1) {\n\t\t\t\t\tif (mode_lib->vba.HActive[k]\n\t\t\t\t\t\t\t> 4 * mode_lib->vba.MaximumPixelsPerLinePerDSCUnit)\n\t\t\t\t\t\tmode_lib->vba.PixelsPerLinePerDSCUnitSupport[i] = false;\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalDSCUnitsRequired = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalDSCUnitsRequired + 4;\n\t\t\t\t\tif (mode_lib->vba.NumberOfDSCSlices[k] > 16)\n\t\t\t\t\t\tmode_lib->vba.NotEnoughDSCSlices[i] = true;\n\t\t\t\t} else if (mode_lib->vba.ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_2to1) {\n\t\t\t\t\tif (mode_lib->vba.HActive[k]\n\t\t\t\t\t\t\t> 2 * mode_lib->vba.MaximumPixelsPerLinePerDSCUnit)\n\t\t\t\t\t\tmode_lib->vba.PixelsPerLinePerDSCUnitSupport[i] = false;\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalDSCUnitsRequired = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalDSCUnitsRequired + 2;\n\t\t\t\t\tif (mode_lib->vba.NumberOfDSCSlices[k] > 8)\n\t\t\t\t\t\tmode_lib->vba.NotEnoughDSCSlices[i] = true;\n\t\t\t\t} else {\n\t\t\t\t\tif (mode_lib->vba.HActive[k] > mode_lib->vba.MaximumPixelsPerLinePerDSCUnit)\n\t\t\t\t\t\tmode_lib->vba.PixelsPerLinePerDSCUnitSupport[i] = false;\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalDSCUnitsRequired = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalDSCUnitsRequired + 1;\n\t\t\t\t\tif (mode_lib->vba.NumberOfDSCSlices[k] > 4)\n\t\t\t\t\t\tmode_lib->vba.NotEnoughDSCSlices[i] = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.TotalDSCUnitsRequired > mode_lib->vba.NumberOfDSC)\n\t\t\tmode_lib->vba.NotEnoughDSCUnits[i] = true;\n\t}\n\n\t \n\tfor (i = start_state; i < v->soc.num_states; ++i) {\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\tmode_lib->vba.DSCDelayPerState[i][k] = dml32_DSCDelayRequirement(\n\t\t\t\t\tmode_lib->vba.RequiresDSC[i][k], mode_lib->vba.ODMCombineEnablePerState[i][k],\n\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k],\n\t\t\t\t\tmode_lib->vba.OutputBppPerState[i][k], mode_lib->vba.HActive[k],\n\t\t\t\t\tmode_lib->vba.HTotal[k], mode_lib->vba.NumberOfDSCSlices[k],\n\t\t\t\t\tmode_lib->vba.OutputFormat[k], mode_lib->vba.Output[k],\n\t\t\t\t\tmode_lib->vba.PixelClock[k], mode_lib->vba.PixelClockBackEnd[k],\n\t\t\t\t\tmode_lib->vba.ip.dsc_delay_factor_wa);\n\t\t}\n\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\tfor (m = 0; m <= mode_lib->vba.NumberOfActiveSurfaces - 1; m++) {\n\t\t\t\tfor (j = 0; j <= mode_lib->vba.NumberOfActiveSurfaces - 1; j++) {\n\t\t\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == m &&\n\t\t\t\t\t\t\tmode_lib->vba.RequiresDSC[i][m] == true) {\n\t\t\t\t\t\tmode_lib->vba.DSCDelayPerState[i][k] =\n\t\t\t\t\t\t\tmode_lib->vba.DSCDelayPerState[i][m];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t\n\t\n\tfor (i = start_state; i < (int) v->soc.num_states; ++i) {\n\t\tfor (j = 0; j <= 1; ++j) {\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tmode_lib->vba.RequiredDPPCLKThisState[k] = mode_lib->vba.RequiredDPPCLK[i][j][k];\n\t\t\t\tmode_lib->vba.NoOfDPPThisState[k] = mode_lib->vba.NoOfDPP[i][j][k];\n\t\t\t\tmode_lib->vba.ODMCombineEnableThisState[k] =\n\t\t\t\t\t\tmode_lib->vba.ODMCombineEnablePerState[i][k];\n\t\t\t}\n\n\t\t\tdml32_CalculateSwathAndDETConfiguration(\n\t\t\t\t\tmode_lib->vba.DETSizeOverride,\n\t\t\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\t\t\tmode_lib->vba.ConfigReturnBufferSizeInKByte,\n\t\t\t\t\tmode_lib->vba.MaxTotalDETInKByte,\n\t\t\t\t\tmode_lib->vba.MinCompressedBufferSizeInKByte,\n\t\t\t\t\tfalse,  \n\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\tmode_lib->vba.nomDETInKByte,\n\t\t\t\t\tmode_lib->vba.UseUnboundedRequesting,\n\t\t\t\t\tmode_lib->vba.DisableUnboundRequestIfCompBufReservedSpaceNeedAdjustment,\n\t\t\t\t\tmode_lib->vba.ip.pixel_chunk_size_kbytes,\n\t\t\t\t\tmode_lib->vba.ip.rob_buffer_size_kbytes,\n\t\t\t\t\tmode_lib->vba.CompressedBufferSegmentSizeInkByteFinal,\n\t\t\t\t\tmode_lib->vba.Output,\n\t\t\t\t\tmode_lib->vba.ReadBandwidthLuma,\n\t\t\t\t\tmode_lib->vba.ReadBandwidthChroma,\n\t\t\t\t\tmode_lib->vba.MaximumSwathWidthLuma,\n\t\t\t\t\tmode_lib->vba.MaximumSwathWidthChroma,\n\t\t\t\t\tmode_lib->vba.SourceRotation,\n\t\t\t\t\tmode_lib->vba.ViewportStationary,\n\t\t\t\t\tmode_lib->vba.SourcePixelFormat,\n\t\t\t\t\tmode_lib->vba.SurfaceTiling,\n\t\t\t\t\tmode_lib->vba.ViewportWidth,\n\t\t\t\t\tmode_lib->vba.ViewportHeight,\n\t\t\t\t\tmode_lib->vba.ViewportXStartY,\n\t\t\t\t\tmode_lib->vba.ViewportYStartY,\n\t\t\t\t\tmode_lib->vba.ViewportXStartC,\n\t\t\t\t\tmode_lib->vba.ViewportYStartC,\n\t\t\t\t\tmode_lib->vba.SurfaceWidthY,\n\t\t\t\t\tmode_lib->vba.SurfaceWidthC,\n\t\t\t\t\tmode_lib->vba.SurfaceHeightY,\n\t\t\t\t\tmode_lib->vba.SurfaceHeightC,\n\t\t\t\t\tmode_lib->vba.Read256BlockHeightY,\n\t\t\t\t\tmode_lib->vba.Read256BlockHeightC,\n\t\t\t\t\tmode_lib->vba.Read256BlockWidthY,\n\t\t\t\t\tmode_lib->vba.Read256BlockWidthC,\n\t\t\t\t\tmode_lib->vba.ODMCombineEnableThisState,\n\t\t\t\t\tmode_lib->vba.BlendingAndTiming,\n\t\t\t\t\tmode_lib->vba.BytePerPixelY,\n\t\t\t\t\tmode_lib->vba.BytePerPixelC,\n\t\t\t\t\tmode_lib->vba.BytePerPixelInDETY,\n\t\t\t\t\tmode_lib->vba.BytePerPixelInDETC,\n\t\t\t\t\tmode_lib->vba.HActive,\n\t\t\t\t\tmode_lib->vba.HRatio,\n\t\t\t\t\tmode_lib->vba.HRatioChroma,\n\t\t\t\t\tmode_lib->vba.NoOfDPPThisState,\n\t\t\t\t\t \n\t\t\t\t\tmode_lib->vba.swath_width_luma_ub_this_state,\n\t\t\t\t\tmode_lib->vba.swath_width_chroma_ub_this_state,\n\t\t\t\t\tmode_lib->vba.SwathWidthYThisState,\n\t\t\t\t\tmode_lib->vba.SwathWidthCThisState,\n\t\t\t\t\tmode_lib->vba.SwathHeightYThisState,\n\t\t\t\t\tmode_lib->vba.SwathHeightCThisState,\n\t\t\t\t\tmode_lib->vba.DETBufferSizeInKByteThisState,\n\t\t\t\t\tmode_lib->vba.DETBufferSizeYThisState,\n\t\t\t\t\tmode_lib->vba.DETBufferSizeCThisState,\n\t\t\t\t\t&mode_lib->vba.UnboundedRequestEnabledThisState,\n\t\t\t\t\t&mode_lib->vba.CompressedBufferSizeInkByteThisState,\n\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer[0],  \n\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_boolean[0],  \n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_boolean_array[0],\n\t\t\t\t\t&mode_lib->vba.ViewportSizeSupport[i][j]);\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tmode_lib->vba.swath_width_luma_ub_all_states[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.swath_width_luma_ub_this_state[k];\n\t\t\t\tmode_lib->vba.swath_width_chroma_ub_all_states[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.swath_width_chroma_ub_this_state[k];\n\t\t\t\tmode_lib->vba.SwathWidthYAllStates[i][j][k] = mode_lib->vba.SwathWidthYThisState[k];\n\t\t\t\tmode_lib->vba.SwathWidthCAllStates[i][j][k] = mode_lib->vba.SwathWidthCThisState[k];\n\t\t\t\tmode_lib->vba.SwathHeightYAllStates[i][j][k] = mode_lib->vba.SwathHeightYThisState[k];\n\t\t\t\tmode_lib->vba.SwathHeightCAllStates[i][j][k] = mode_lib->vba.SwathHeightCThisState[k];\n\t\t\t\tmode_lib->vba.UnboundedRequestEnabledAllStates[i][j] =\n\t\t\t\t\t\tmode_lib->vba.UnboundedRequestEnabledThisState;\n\t\t\t\tmode_lib->vba.CompressedBufferSizeInkByteAllStates[i][j] =\n\t\t\t\t\t\tmode_lib->vba.CompressedBufferSizeInkByteThisState;\n\t\t\t\tmode_lib->vba.DETBufferSizeInKByteAllStates[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeInKByteThisState[k];\n\t\t\t\tmode_lib->vba.DETBufferSizeYAllStates[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeYThisState[k];\n\t\t\t\tmode_lib->vba.DETBufferSizeCAllStates[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeCThisState[k];\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tmode_lib->vba.cursor_bw[k] = mode_lib->vba.NumberOfCursors[k] * mode_lib->vba.CursorWidth[k][0]\n\t\t\t\t* mode_lib->vba.CursorBPP[k][0] / 8.0\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]) * mode_lib->vba.VRatio[k];\n\t}\n\n\tdml32_CalculateSurfaceSizeInMall(\n\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\tmode_lib->vba.MALLAllocatedForDCNFinal,\n\t\t\tmode_lib->vba.UseMALLForStaticScreen,\n\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\tmode_lib->vba.DCCEnable,\n\t\t\tmode_lib->vba.ViewportStationary,\n\t\t\tmode_lib->vba.ViewportXStartY,\n\t\t\tmode_lib->vba.ViewportYStartY,\n\t\t\tmode_lib->vba.ViewportXStartC,\n\t\t\tmode_lib->vba.ViewportYStartC,\n\t\t\tmode_lib->vba.ViewportWidth,\n\t\t\tmode_lib->vba.ViewportHeight,\n\t\t\tmode_lib->vba.BytePerPixelY,\n\t\t\tmode_lib->vba.ViewportWidthChroma,\n\t\t\tmode_lib->vba.ViewportHeightChroma,\n\t\t\tmode_lib->vba.BytePerPixelC,\n\t\t\tmode_lib->vba.SurfaceWidthY,\n\t\t\tmode_lib->vba.SurfaceWidthC,\n\t\t\tmode_lib->vba.SurfaceHeightY,\n\t\t\tmode_lib->vba.SurfaceHeightC,\n\t\t\tmode_lib->vba.Read256BlockWidthY,\n\t\t\tmode_lib->vba.Read256BlockWidthC,\n\t\t\tmode_lib->vba.Read256BlockHeightY,\n\t\t\tmode_lib->vba.Read256BlockHeightC,\n\t\t\tmode_lib->vba.MacroTileWidthY,\n\t\t\tmode_lib->vba.MacroTileWidthC,\n\t\t\tmode_lib->vba.MacroTileHeightY,\n\t\t\tmode_lib->vba.MacroTileHeightC,\n\t\t\tmode_lib->vba.DCCMetaPitchY,\n\t\t\tmode_lib->vba.DCCMetaPitchC,\n\n\t\t\t \n\t\t\tmode_lib->vba.SurfaceSizeInMALL,\n\t\t\t&mode_lib->vba.ExceededMALLSize);\n\n\tfor (i = start_state; i < v->soc.num_states; i++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\tmode_lib->vba.swath_width_luma_ub_this_state[k] =\n\t\t\t\t\t\tmode_lib->vba.swath_width_luma_ub_all_states[i][j][k];\n\t\t\t\tmode_lib->vba.swath_width_chroma_ub_this_state[k] =\n\t\t\t\t\t\tmode_lib->vba.swath_width_chroma_ub_all_states[i][j][k];\n\t\t\t\tmode_lib->vba.SwathWidthYThisState[k] = mode_lib->vba.SwathWidthYAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.SwathWidthCThisState[k] = mode_lib->vba.SwathWidthCAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.SwathHeightYThisState[k] = mode_lib->vba.SwathHeightYAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.SwathHeightCThisState[k] = mode_lib->vba.SwathHeightCAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.DETBufferSizeInKByteThisState[k] =\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeInKByteAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.DETBufferSizeYThisState[k] =\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeYAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.DETBufferSizeCThisState[k] =\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeCAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.RequiredDPPCLKThisState[k] = mode_lib->vba.RequiredDPPCLK[i][j][k];\n\t\t\t\tmode_lib->vba.NoOfDPPThisState[k] = mode_lib->vba.NoOfDPP[i][j][k];\n\t\t\t}\n\n\t\t\tmode_lib->vba.TotalNumberOfDCCActiveDPP[i][j] = 0;\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tif (mode_lib->vba.DCCEnable[k] == true) {\n\t\t\t\t\tmode_lib->vba.TotalNumberOfDCCActiveDPP[i][j] =\n\t\t\t\t\t\t\tmode_lib->vba.TotalNumberOfDCCActiveDPP[i][j]\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.NoOfDPP[i][j][k];\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].PixelClock = mode_lib->vba.PixelClock[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].DPPPerSurface = mode_lib->vba.NoOfDPP[i][j][k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].SourceRotation = mode_lib->vba.SourceRotation[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].ViewportHeight = mode_lib->vba.ViewportHeight[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].ViewportHeightChroma = mode_lib->vba.ViewportHeightChroma[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BlockWidth256BytesY = mode_lib->vba.Read256BlockWidthY[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BlockHeight256BytesY = mode_lib->vba.Read256BlockHeightY[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BlockWidth256BytesC = mode_lib->vba.Read256BlockWidthC[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BlockHeight256BytesC = mode_lib->vba.Read256BlockHeightC[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BlockWidthY = mode_lib->vba.MacroTileWidthY[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BlockHeightY = mode_lib->vba.MacroTileHeightY[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BlockWidthC = mode_lib->vba.MacroTileWidthC[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BlockHeightC = mode_lib->vba.MacroTileHeightC[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].InterlaceEnable = mode_lib->vba.Interlace[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].HTotal = mode_lib->vba.HTotal[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].DCCEnable = mode_lib->vba.DCCEnable[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].SourcePixelFormat = mode_lib->vba.SourcePixelFormat[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].SurfaceTiling = mode_lib->vba.SurfaceTiling[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BytePerPixelY = mode_lib->vba.BytePerPixelY[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].BytePerPixelC = mode_lib->vba.BytePerPixelC[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].ProgressiveToInterlaceUnitInOPP =\n\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP;\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].VRatio = mode_lib->vba.VRatio[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].VRatioChroma = mode_lib->vba.VRatioChroma[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].VTaps = mode_lib->vba.vtaps[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].VTapsChroma = mode_lib->vba.VTAPsChroma[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].PitchY = mode_lib->vba.PitchY[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].DCCMetaPitchY = mode_lib->vba.DCCMetaPitchY[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].PitchC = mode_lib->vba.PitchC[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].DCCMetaPitchC = mode_lib->vba.DCCMetaPitchC[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].ViewportStationary = mode_lib->vba.ViewportStationary[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].ViewportXStart = mode_lib->vba.ViewportXStartY[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].ViewportYStart = mode_lib->vba.ViewportYStartY[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].ViewportXStartC = mode_lib->vba.ViewportXStartC[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].ViewportYStartC = mode_lib->vba.ViewportYStartC[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].FORCE_ONE_ROW_FOR_FRAME = mode_lib->vba.ForceOneRowForFrame[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].SwathHeightY = mode_lib->vba.SwathHeightYThisState[k];\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters[k].SwathHeightC = mode_lib->vba.SwathHeightCThisState[k];\n\t\t\t}\n\n\t\t\t{\n\t\t\t\tdml32_CalculateVMRowAndSwath(\n\t\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SurfParameters,\n\t\t\t\t\t\tmode_lib->vba.SurfaceSizeInMALL,\n\t\t\t\t\t\tmode_lib->vba.PTEBufferSizeInRequestsLuma,\n\t\t\t\t\t\tmode_lib->vba.PTEBufferSizeInRequestsChroma,\n\t\t\t\t\t\tmode_lib->vba.DCCMetaBufferSizeBytes,\n\t\t\t\t\t\tmode_lib->vba.UseMALLForStaticScreen,\n\t\t\t\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\t\t\t\tmode_lib->vba.MALLAllocatedForDCNFinal,\n\t\t\t\t\t\tmode_lib->vba.SwathWidthYThisState,\n\t\t\t\t\t\tmode_lib->vba.SwathWidthCThisState,\n\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\tmode_lib->vba.HostVMEnable,\n\t\t\t\t\t\tmode_lib->vba.HostVMMaxNonCachedPageTableLevels,\n\t\t\t\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\t\t\t\tmode_lib->vba.GPUVMMinPageSizeKBytes,\n\t\t\t\t\t\tmode_lib->vba.HostVMMinPageSize,\n\n\t\t\t\t\t\t \n\t\t\t\t\t\tmode_lib->vba.PTEBufferSizeNotExceededPerState,\n\t\t\t\t\t\tmode_lib->vba.DCCMetaBufferSizeNotExceededPerState,\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[0],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[1],\n\t\t\t\t\t\tmode_lib->vba.dpte_row_height,\n\t\t\t\t\t\tmode_lib->vba.dpte_row_height_chroma,\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[2],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[3],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[4],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[5],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[6],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[7],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[8],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[9],\n\t\t\t\t\t\tmode_lib->vba.meta_row_height,\n\t\t\t\t\t\tmode_lib->vba.meta_row_height_chroma,\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[10],\n\t\t\t\t\t\tmode_lib->vba.dpte_group_bytes,\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[11],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[12],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[13],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[14],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[15],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[16],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[17],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[18],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[19],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[20],\n\t\t\t\t\t\tmode_lib->vba.PrefetchLinesYThisState,\n\t\t\t\t\t\tmode_lib->vba.PrefetchLinesCThisState,\n\t\t\t\t\t\tmode_lib->vba.PrefillY,\n\t\t\t\t\t\tmode_lib->vba.PrefillC,\n\t\t\t\t\t\tmode_lib->vba.MaxNumSwY,\n\t\t\t\t\t\tmode_lib->vba.MaxNumSwC,\n\t\t\t\t\t\tmode_lib->vba.meta_row_bandwidth_this_state,\n\t\t\t\t\t\tmode_lib->vba.dpte_row_bandwidth_this_state,\n\t\t\t\t\t\tmode_lib->vba.DPTEBytesPerRowThisState,\n\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrameThisState,\n\t\t\t\t\t\tmode_lib->vba.MetaRowBytesThisState,\n\t\t\t\t\t\tmode_lib->vba.use_one_row_for_frame_this_state,\n\t\t\t\t\t\tmode_lib->vba.use_one_row_for_frame_flip_this_state,\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_boolean_array[0], \n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_boolean_array[1], \n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer_array[21]); \n\t\t\t}\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tmode_lib->vba.PrefetchLinesY[i][j][k] = mode_lib->vba.PrefetchLinesYThisState[k];\n\t\t\t\tmode_lib->vba.PrefetchLinesC[i][j][k] = mode_lib->vba.PrefetchLinesCThisState[k];\n\t\t\t\tmode_lib->vba.meta_row_bandwidth[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.meta_row_bandwidth_this_state[k];\n\t\t\t\tmode_lib->vba.dpte_row_bandwidth[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.dpte_row_bandwidth_this_state[k];\n\t\t\t\tmode_lib->vba.DPTEBytesPerRow[i][j][k] = mode_lib->vba.DPTEBytesPerRowThisState[k];\n\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrame[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrameThisState[k];\n\t\t\t\tmode_lib->vba.MetaRowBytes[i][j][k] = mode_lib->vba.MetaRowBytesThisState[k];\n\t\t\t\tmode_lib->vba.use_one_row_for_frame[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.use_one_row_for_frame_this_state[k];\n\t\t\t\tmode_lib->vba.use_one_row_for_frame_flip[i][j][k] =\n\t\t\t\t\t\tmode_lib->vba.use_one_row_for_frame_flip_this_state[k];\n\t\t\t}\n\n\t\t\tmode_lib->vba.PTEBufferSizeNotExceeded[i][j] = true;\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tif (mode_lib->vba.PTEBufferSizeNotExceededPerState[k] == false)\n\t\t\t\t\tmode_lib->vba.PTEBufferSizeNotExceeded[i][j] = false;\n\t\t\t}\n\n\t\t\tmode_lib->vba.DCCMetaBufferSizeNotExceeded[i][j] = true;\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tif (mode_lib->vba.DCCMetaBufferSizeNotExceededPerState[k] == false)\n\t\t\t\t\tmode_lib->vba.DCCMetaBufferSizeNotExceeded[i][j] = false;\n\t\t\t}\n\n\t\t\tmode_lib->vba.UrgLatency[i] = dml32_CalculateUrgentLatency(\n\t\t\t\t\tmode_lib->vba.UrgentLatencyPixelDataOnly,\n\t\t\t\t\tmode_lib->vba.UrgentLatencyPixelMixedWithVMData,\n\t\t\t\t\tmode_lib->vba.UrgentLatencyVMDataOnly, mode_lib->vba.DoUrgentLatencyAdjustment,\n\t\t\t\t\tmode_lib->vba.UrgentLatencyAdjustmentFabricClockComponent,\n\t\t\t\t\tmode_lib->vba.UrgentLatencyAdjustmentFabricClockReference,\n\t\t\t\t\tmode_lib->vba.FabricClockPerState[i]);\n\n\t\t\t\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tdml32_CalculateUrgentBurstFactor(\n\t\t\t\t\t\tmode_lib->vba.UsesMALLForPStateChange[k],\n\t\t\t\t\t\tmode_lib->vba.swath_width_luma_ub_this_state[k],\n\t\t\t\t\t\tmode_lib->vba.swath_width_chroma_ub_this_state[k],\n\t\t\t\t\t\tmode_lib->vba.SwathHeightYThisState[k],\n\t\t\t\t\t\tmode_lib->vba.SwathHeightCThisState[k],\n\t\t\t\t\t\t(double) mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k],\n\t\t\t\t\t\tmode_lib->vba.UrgLatency[i],\n\t\t\t\t\t\tmode_lib->vba.CursorBufferSize,\n\t\t\t\t\t\tmode_lib->vba.CursorWidth[k][0],\n\t\t\t\t\t\tmode_lib->vba.CursorBPP[k][0],\n\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\tmode_lib->vba.VRatioChroma[k],\n\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETY[k],\n\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETC[k],\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeYThisState[k],\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeCThisState[k],\n\t\t\t\t\t\t \n\t\t\t\t\t\t&mode_lib->vba.UrgentBurstFactorCursor[k],\n\t\t\t\t\t\t&mode_lib->vba.UrgentBurstFactorLuma[k],\n\t\t\t\t\t\t&mode_lib->vba.UrgentBurstFactorChroma[k],\n\t\t\t\t\t\t&mode_lib->vba.NoUrgentLatencyHiding[k]);\n\t\t\t}\n\n\t\t\tdml32_CalculateDCFCLKDeepSleep(\n\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\tmode_lib->vba.BytePerPixelY,\n\t\t\t\t\tmode_lib->vba.BytePerPixelC,\n\t\t\t\t\tmode_lib->vba.VRatio,\n\t\t\t\t\tmode_lib->vba.VRatioChroma,\n\t\t\t\t\tmode_lib->vba.SwathWidthYThisState,\n\t\t\t\t\tmode_lib->vba.SwathWidthCThisState,\n\t\t\t\t\tmode_lib->vba.NoOfDPPThisState,\n\t\t\t\t\tmode_lib->vba.HRatio,\n\t\t\t\t\tmode_lib->vba.HRatioChroma,\n\t\t\t\t\tmode_lib->vba.PixelClock,\n\t\t\t\t\tmode_lib->vba.PSCL_FACTOR,\n\t\t\t\t\tmode_lib->vba.PSCL_FACTOR_CHROMA,\n\t\t\t\t\tmode_lib->vba.RequiredDPPCLKThisState,\n\t\t\t\t\tmode_lib->vba.ReadBandwidthLuma,\n\t\t\t\t\tmode_lib->vba.ReadBandwidthChroma,\n\t\t\t\t\tmode_lib->vba.ReturnBusWidth,\n\n\t\t\t\t\t \n\t\t\t\t\t&mode_lib->vba.ProjectedDCFCLKDeepSleep[i][j]);\n\t\t}\n\t}\n\n\t\n\tfor (i = start_state; i < (int) v->soc.num_states; ++i) {\n\t\tfor (j = 0; j <= 1; ++j) {\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\t\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\t\t\t\tmode_lib->vba.WritebackDelayTime[k] =\n\t\t\t\t\t\t\tmode_lib->vba.WritebackLatency\n\t\t\t\t\t\t+ dml32_CalculateWriteBackDelay(\n\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackVTaps[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationHeight[k],\n\t\t\t\t\t\t\tmode_lib->vba.WritebackSourceHeight[k],\n\t\t\t\t\t\t\tmode_lib->vba.HTotal[k])\n\t\t\t\t\t\t\t/ mode_lib->vba.RequiredDISPCLK[i][j];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.WritebackDelayTime[k] = 0.0;\n\t\t\t\t\t}\n\t\t\t\t\tfor (m = 0; m <= mode_lib->vba.NumberOfActiveSurfaces - 1; m++) {\n\t\t\t\t\t\tif (mode_lib->vba.BlendingAndTiming[m]\n\t\t\t\t\t\t\t\t== k && mode_lib->vba.WritebackEnable[m] == true) {\n\t\t\t\t\t\t\tmode_lib->vba.WritebackDelayTime[k] =\n\t\t\t\t\t\t\t\tdml_max(mode_lib->vba.WritebackDelayTime[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLatency\n\t\t\t\t\t\t\t\t+ dml32_CalculateWriteBackDelay(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[m],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[m],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[m],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVTaps[m],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[m],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationHeight[m],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackSourceHeight[m],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.HTotal[m]) /\n\t\t\t\t\t\t\t\t\tmode_lib->vba.RequiredDISPCLK[i][j]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\tfor (m = 0; m <= mode_lib->vba.NumberOfActiveSurfaces - 1; m++) {\n\t\t\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == m) {\n\t\t\t\t\t\tmode_lib->vba.WritebackDelayTime[k] =\n\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDelayTime[m];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tmode_lib->vba.MaxMaxVStartup[i][j] = 0;\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\tmode_lib->vba.MaximumVStartup[i][j][k] = ((mode_lib->vba.Interlace[k] &&\n\t\t\t\t\t\t\t\t!mode_lib->vba.ProgressiveToInterlaceUnitInOPP) ?\n\t\t\t\t\t\t\t\tdml_floor((mode_lib->vba.VTotal[k] -\n\t\t\t\t\t\t\t\t\tmode_lib->vba.VActive[k]) / 2.0, 1.0) :\n\t\t\t\t\t\t\t\tmode_lib->vba.VTotal[k] - mode_lib->vba.VActive[k])\n\t\t\t\t\t\t\t\t- dml_max(1.0, dml_ceil(1.0 *\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDelayTime[k] /\n\t\t\t\t\t\t\t\t\t(mode_lib->vba.HTotal[k] /\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k]), 1.0));\n\n\t\t\t\t\n\t\t\t\tif (mode_lib->vba.MaximumVStartup[i][j][k] > 1023)\n\t\t\t\t\tmode_lib->vba.MaximumVStartup[i][j][k] = 1023;\n\n\t\t\t\tmode_lib->vba.MaxMaxVStartup[i][j] = dml_max(mode_lib->vba.MaxMaxVStartup[i][j],\n\t\t\t\t\t\tmode_lib->vba.MaximumVStartup[i][j][k]);\n\t\t\t}\n\t\t}\n\t}\n\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ReorderingBytes = mode_lib->vba.NumberOfChannels\n\t\t\t* dml_max3(mode_lib->vba.UrgentOutOfOrderReturnPerChannelPixelDataOnly,\n\t\t\t\t\tmode_lib->vba.UrgentOutOfOrderReturnPerChannelPixelMixedWithVMData,\n\t\t\t\t\tmode_lib->vba.UrgentOutOfOrderReturnPerChannelVMDataOnly);\n\n\tdml32_CalculateMinAndMaxPrefetchMode(mode_lib->vba.AllowForPStateChangeOrStutterInVBlankFinal,\n\t\t\t&mode_lib->vba.MinPrefetchMode,\n\t\t\t&mode_lib->vba.MaxPrefetchMode);\n\n\tfor (i = start_state; i < (int) v->soc.num_states; ++i) {\n\t\tfor (j = 0; j <= 1; ++j)\n\t\t\tmode_lib->vba.DCFCLKState[i][j] = mode_lib->vba.DCFCLKPerState[i];\n\t}\n\n\t \n\tmode_lib->vba.ImmediateFlipRequiredFinal = false;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tmode_lib->vba.ImmediateFlipRequiredFinal = mode_lib->vba.ImmediateFlipRequiredFinal\n\t\t\t\t|| (mode_lib->vba.ImmediateFlipRequirement[k] == dm_immediate_flip_required);\n\t}\n\n\tmode_lib->vba.ImmediateFlipRequiredButTheRequirementForEachSurfaceIsNotSpecified = false;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tmode_lib->vba.ImmediateFlipRequiredButTheRequirementForEachSurfaceIsNotSpecified =\n\t\t\t\tmode_lib->vba.ImmediateFlipRequiredButTheRequirementForEachSurfaceIsNotSpecified\n\t\t\t\t\t\t|| ((mode_lib->vba.ImmediateFlipRequirement[k]\n\t\t\t\t\t\t\t\t!= dm_immediate_flip_required)\n\t\t\t\t\t\t\t\t&& (mode_lib->vba.ImmediateFlipRequirement[k]\n\t\t\t\t\t\t\t\t\t\t!= dm_immediate_flip_not_required));\n\t}\n\tmode_lib->vba.ImmediateFlipRequiredButTheRequirementForEachSurfaceIsNotSpecified =\n\t\t\tmode_lib->vba.ImmediateFlipRequiredButTheRequirementForEachSurfaceIsNotSpecified\n\t\t\t\t\t&& mode_lib->vba.ImmediateFlipRequiredFinal;\n\n\tmode_lib->vba.ImmediateFlipOrHostVMAndPStateWithMALLFullFrameOrPhantomPipe = false;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tmode_lib->vba.ImmediateFlipOrHostVMAndPStateWithMALLFullFrameOrPhantomPipe =\n\t\t\tmode_lib->vba.ImmediateFlipOrHostVMAndPStateWithMALLFullFrameOrPhantomPipe ||\n\t\t\t((mode_lib->vba.HostVMEnable == true || mode_lib->vba.ImmediateFlipRequirement[k] !=\n\t\t\t\t\tdm_immediate_flip_not_required) &&\n\t\t\t(mode_lib->vba.UsesMALLForPStateChange[k] == dm_use_mall_pstate_change_full_frame ||\n\t\t\tmode_lib->vba.UsesMALLForPStateChange[k] == dm_use_mall_pstate_change_phantom_pipe));\n\t}\n\n\tmode_lib->vba.InvalidCombinationOfMALLUseForPStateAndStaticScreen = false;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tmode_lib->vba.InvalidCombinationOfMALLUseForPStateAndStaticScreen =\n\t\t\tmode_lib->vba.InvalidCombinationOfMALLUseForPStateAndStaticScreen\n\t\t\t|| ((mode_lib->vba.UseMALLForStaticScreen[k] == dm_use_mall_static_screen_enable\n\t\t\t|| mode_lib->vba.UseMALLForStaticScreen[k] == dm_use_mall_static_screen_optimize)\n\t\t\t&& (mode_lib->vba.UsesMALLForPStateChange[k] == dm_use_mall_pstate_change_phantom_pipe))\n\t\t\t|| ((mode_lib->vba.UseMALLForStaticScreen[k] == dm_use_mall_static_screen_disable\n\t\t\t|| mode_lib->vba.UseMALLForStaticScreen[k] == dm_use_mall_static_screen_optimize)\n\t\t\t&& (mode_lib->vba.UsesMALLForPStateChange[k] == dm_use_mall_pstate_change_full_frame));\n\t}\n\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.FullFrameMALLPStateMethod = false;\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SubViewportMALLPStateMethod = false;\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.PhantomPipeMALLPStateMethod = false;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tif (mode_lib->vba.UsesMALLForPStateChange[k] == dm_use_mall_pstate_change_full_frame)\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.FullFrameMALLPStateMethod = true;\n\t\tif (mode_lib->vba.UsesMALLForPStateChange[k] == dm_use_mall_pstate_change_sub_viewport)\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SubViewportMALLPStateMethod = true;\n\t\tif (mode_lib->vba.UsesMALLForPStateChange[k] == dm_use_mall_pstate_change_phantom_pipe)\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.PhantomPipeMALLPStateMethod = true;\n\t}\n\tmode_lib->vba.InvalidCombinationOfMALLUseForPState = (v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SubViewportMALLPStateMethod\n\t\t\t!= v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.PhantomPipeMALLPStateMethod) || (v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.SubViewportMALLPStateMethod && v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.FullFrameMALLPStateMethod);\n\n\tif (mode_lib->vba.UseMinimumRequiredDCFCLK == true) {\n\t\tdml32_UseMinimumDCFCLK(\n\t\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\t\tmode_lib->vba.DRRDisplay,\n\t\t\t\tmode_lib->vba.SynchronizeDRRDisplaysForUCLKPStateChangeFinal,\n\t\t\t\tmode_lib->vba.MaxInterDCNTileRepeaters,\n\t\t\t\tmode_lib->vba.MaxPrefetchMode,\n\t\t\t\tmode_lib->vba.DRAMClockChangeLatency,\n\t\t\t\tmode_lib->vba.FCLKChangeLatency,\n\t\t\t\tmode_lib->vba.SREnterPlusExitTime,\n\t\t\t\tmode_lib->vba.ReturnBusWidth,\n\t\t\t\tmode_lib->vba.RoundTripPingLatencyCycles,\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ReorderingBytes,\n\t\t\t\tmode_lib->vba.PixelChunkSizeInKByte,\n\t\t\t\tmode_lib->vba.MetaChunkSize,\n\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\t\tmode_lib->vba.HostVMEnable,\n\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\tmode_lib->vba.HostVMMinPageSize,\n\t\t\t\tmode_lib->vba.HostVMMaxNonCachedPageTableLevels,\n\t\t\t\tmode_lib->vba.DynamicMetadataVMEnabled,\n\t\t\t\tmode_lib->vba.ImmediateFlipRequiredFinal,\n\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP,\n\t\t\t\tmode_lib->vba.MaxAveragePercentOfIdealSDPPortBWDisplayCanUseInNormalSystemOperation,\n\t\t\t\tmode_lib->vba.PercentOfIdealFabricAndSDPPortBWReceivedAfterUrgLatency,\n\t\t\t\tmode_lib->vba.VTotal,\n\t\t\t\tmode_lib->vba.VActive,\n\t\t\t\tmode_lib->vba.DynamicMetadataTransmittedBytes,\n\t\t\t\tmode_lib->vba.DynamicMetadataLinesBeforeActiveRequired,\n\t\t\t\tmode_lib->vba.Interlace,\n\t\t\t\tmode_lib->vba.RequiredDPPCLK,\n\t\t\t\tmode_lib->vba.RequiredDISPCLK,\n\t\t\t\tmode_lib->vba.UrgLatency,\n\t\t\t\tmode_lib->vba.NoOfDPP,\n\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep,\n\t\t\t\tmode_lib->vba.MaximumVStartup,\n\t\t\t\tmode_lib->vba.TotalNumberOfActiveDPP,\n\t\t\t\tmode_lib->vba.TotalNumberOfDCCActiveDPP,\n\t\t\t\tmode_lib->vba.dpte_group_bytes,\n\t\t\t\tmode_lib->vba.PrefetchLinesY,\n\t\t\t\tmode_lib->vba.PrefetchLinesC,\n\t\t\t\tmode_lib->vba.swath_width_luma_ub_all_states,\n\t\t\t\tmode_lib->vba.swath_width_chroma_ub_all_states,\n\t\t\t\tmode_lib->vba.BytePerPixelY,\n\t\t\t\tmode_lib->vba.BytePerPixelC,\n\t\t\t\tmode_lib->vba.HTotal,\n\t\t\t\tmode_lib->vba.PixelClock,\n\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrame,\n\t\t\t\tmode_lib->vba.DPTEBytesPerRow,\n\t\t\t\tmode_lib->vba.MetaRowBytes,\n\t\t\t\tmode_lib->vba.DynamicMetadataEnable,\n\t\t\t\tmode_lib->vba.ReadBandwidthLuma,\n\t\t\t\tmode_lib->vba.ReadBandwidthChroma,\n\t\t\t\tmode_lib->vba.DCFCLKPerState,\n\n\t\t\t\t \n\t\t\t\tmode_lib->vba.DCFCLKState);\n\t} \n\n\tfor (i = start_state; i < (int) v->soc.num_states; ++i) {\n\t\tfor (j = 0; j <= 1; ++j) {\n\t\t\tmode_lib->vba.ReturnBWPerState[i][j] = dml32_get_return_bw_mbps(&mode_lib->vba.soc, i,\n\t\t\t\t\tmode_lib->vba.HostVMEnable, mode_lib->vba.DCFCLKState[i][j],\n\t\t\t\t\tmode_lib->vba.FabricClockPerState[i], mode_lib->vba.DRAMSpeedPerState[i]);\n\t\t}\n\t}\n\n\t\n\tfor (i = start_state; i < (int) v->soc.num_states; ++i) {\n\t\tfor (j = 0; j <= 1; ++j) {\n\t\t\tif ((mode_lib->vba.ROBBufferSizeInKByte - mode_lib->vba.PixelChunkSizeInKByte) * 1024\n\t\t\t\t\t/ mode_lib->vba.ReturnBWPerState[i][j]\n\t\t\t\t\t> (mode_lib->vba.RoundTripPingLatencyCycles + 32)\n\t\t\t\t\t\t\t/ mode_lib->vba.DCFCLKState[i][j]\n\t\t\t\t\t\t\t+ v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ReorderingBytes / mode_lib->vba.ReturnBWPerState[i][j]) {\n\t\t\t\tmode_lib->vba.ROBSupport[i][j] = true;\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.ROBSupport[i][j] = false;\n\t\t\t}\n\t\t}\n\t}\n\n\t\n\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaxTotalVActiveRDBandwidth = 0;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaxTotalVActiveRDBandwidth += mode_lib->vba.ReadBandwidthLuma[k]\n\t\t\t\t+ mode_lib->vba.ReadBandwidthChroma[k];\n\t}\n\n\tfor (i = start_state; i < (int) v->soc.num_states; ++i) {\n\t\tfor (j = 0; j <= 1; ++j) {\n\t\t\tmode_lib->vba.MaxTotalVerticalActiveAvailableBandwidth[i][j] =\n\t\t\t\tdml_min3(mode_lib->vba.ReturnBusWidth * mode_lib->vba.DCFCLKState[i][j]\n\t\t\t\t\t* mode_lib->vba.MaxAveragePercentOfIdealSDPPortBWDisplayCanUseInNormalSystemOperation / 100,\n\t\t\t\t\tmode_lib->vba.FabricClockPerState[i]\n\t\t\t\t\t* mode_lib->vba.FabricDatapathToDCNDataReturn\n\t\t\t\t\t* mode_lib->vba.MaxAveragePercentOfIdealFabricBWDisplayCanUseInNormalSystemOperation / 100,\n\t\t\t\t\tmode_lib->vba.DRAMSpeedPerState[i]\n\t\t\t\t\t* mode_lib->vba.NumberOfChannels\n\t\t\t\t\t* mode_lib->vba.DRAMChannelWidth\n\t\t\t\t\t* (i < 2 ? mode_lib->vba.MaxAveragePercentOfIdealDRAMBWDisplayCanUseInNormalSystemOperationSTROBE : mode_lib->vba.MaxAveragePercentOfIdealDRAMBWDisplayCanUseInNormalSystemOperation) / 100);\n\n\t\t\tif (v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.MaxTotalVActiveRDBandwidth\n\t\t\t\t\t<= mode_lib->vba.MaxTotalVerticalActiveAvailableBandwidth[i][j]) {\n\t\t\t\tmode_lib->vba.TotalVerticalActiveBandwidthSupport[i][j] = true;\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.TotalVerticalActiveBandwidthSupport[i][j] = false;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\n\tfor (i = start_state; i < (int) v->soc.num_states; ++i) {\n\t\tfor (j = 0; j <= 1; ++j) {\n\n\t\t\tmode_lib->vba.TimeCalc = 24 / mode_lib->vba.ProjectedDCFCLKDeepSleep[i][j];\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tmode_lib->vba.NoOfDPPThisState[k] = mode_lib->vba.NoOfDPP[i][j][k];\n\t\t\t\tmode_lib->vba.swath_width_luma_ub_this_state[k] =\n\t\t\t\t\t\tmode_lib->vba.swath_width_luma_ub_all_states[i][j][k];\n\t\t\t\tmode_lib->vba.swath_width_chroma_ub_this_state[k] =\n\t\t\t\t\t\tmode_lib->vba.swath_width_chroma_ub_all_states[i][j][k];\n\t\t\t\tmode_lib->vba.SwathWidthYThisState[k] = mode_lib->vba.SwathWidthYAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.SwathWidthCThisState[k] = mode_lib->vba.SwathWidthCAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.SwathHeightYThisState[k] = mode_lib->vba.SwathHeightYAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.SwathHeightCThisState[k] = mode_lib->vba.SwathHeightCAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.UnboundedRequestEnabledThisState =\n\t\t\t\t\t\tmode_lib->vba.UnboundedRequestEnabledAllStates[i][j];\n\t\t\t\tmode_lib->vba.CompressedBufferSizeInkByteThisState =\n\t\t\t\t\t\tmode_lib->vba.CompressedBufferSizeInkByteAllStates[i][j];\n\t\t\t\tmode_lib->vba.DETBufferSizeInKByteThisState[k] =\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeInKByteAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.DETBufferSizeYThisState[k] =\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeYAllStates[i][j][k];\n\t\t\t\tmode_lib->vba.DETBufferSizeCThisState[k] =\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeCAllStates[i][j][k];\n\t\t\t}\n\n\t\t\tmode_lib->vba.VActiveBandwithSupport[i][j] = dml32_CalculateVActiveBandwithSupport(\n\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\tmode_lib->vba.ReturnBWPerState[i][j],\n\t\t\t\t\tmode_lib->vba.NoUrgentLatencyHiding,\n\t\t\t\t\tmode_lib->vba.ReadBandwidthLuma,\n\t\t\t\t\tmode_lib->vba.ReadBandwidthChroma,\n\t\t\t\t\tmode_lib->vba.cursor_bw,\n\t\t\t\t\tmode_lib->vba.meta_row_bandwidth_this_state,\n\t\t\t\t\tmode_lib->vba.dpte_row_bandwidth_this_state,\n\t\t\t\t\tmode_lib->vba.NoOfDPPThisState,\n\t\t\t\t\tmode_lib->vba.UrgentBurstFactorLuma,\n\t\t\t\t\tmode_lib->vba.UrgentBurstFactorChroma,\n\t\t\t\t\tmode_lib->vba.UrgentBurstFactorCursor);\n\n\t\t\tmode_lib->vba.NotEnoughDETSwathFillLatencyHidingPerState[i][j] = dml32_CalculateDETSwathFillLatencyHiding(\n\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\tmode_lib->vba.ReturnBWPerState[i][j],\n\t\t\t\t\tmode_lib->vba.UrgLatency[i],\n\t\t\t\t\tmode_lib->vba.SwathHeightYThisState,\n\t\t\t\t\tmode_lib->vba.SwathHeightCThisState,\n\t\t\t\t\tmode_lib->vba.swath_width_luma_ub_this_state,\n\t\t\t\t\tmode_lib->vba.swath_width_chroma_ub_this_state,\n\t\t\t\t\tmode_lib->vba.BytePerPixelInDETY,\n\t\t\t\t\tmode_lib->vba.BytePerPixelInDETC,\n\t\t\t\t\tmode_lib->vba.DETBufferSizeYThisState,\n\t\t\t\t\tmode_lib->vba.DETBufferSizeCThisState,\n\t\t\t\t\tmode_lib->vba.NoOfDPPThisState,\n\t\t\t\t\tmode_lib->vba.HTotal,\n\t\t\t\t\tmode_lib->vba.PixelClock,\n\t\t\t\t\tmode_lib->vba.VRatio,\n\t\t\t\t\tmode_lib->vba.VRatioChroma,\n\t\t\t\t\tmode_lib->vba.UsesMALLForPStateChange,\n\t\t\t\t\tmode_lib->vba.UseUnboundedRequesting);\n\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.VMDataOnlyReturnBWPerState = dml32_get_return_bw_mbps_vm_only(&mode_lib->vba.soc, i,\n\t\t\t\t\tmode_lib->vba.DCFCLKState[i][j], mode_lib->vba.FabricClockPerState[i],\n\t\t\t\t\tmode_lib->vba.DRAMSpeedPerState[i]);\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.HostVMInefficiencyFactor = 1;\n\n\t\t\tif (mode_lib->vba.GPUVMEnable && mode_lib->vba.HostVMEnable)\n\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.HostVMInefficiencyFactor = mode_lib->vba.ReturnBWPerState[i][j]\n\t\t\t\t\t\t/ v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.VMDataOnlyReturnBWPerState;\n\n\t\t\tmode_lib->vba.ExtraLatency = dml32_CalculateExtraLatency(\n\t\t\t\t\tmode_lib->vba.RoundTripPingLatencyCycles, v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.ReorderingBytes,\n\t\t\t\t\tmode_lib->vba.DCFCLKState[i][j], mode_lib->vba.TotalNumberOfActiveDPP[i][j],\n\t\t\t\t\tmode_lib->vba.PixelChunkSizeInKByte,\n\t\t\t\t\tmode_lib->vba.TotalNumberOfDCCActiveDPP[i][j], mode_lib->vba.MetaChunkSize,\n\t\t\t\t\tmode_lib->vba.ReturnBWPerState[i][j], mode_lib->vba.GPUVMEnable,\n\t\t\t\t\tmode_lib->vba.HostVMEnable, mode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\tmode_lib->vba.NoOfDPPThisState, mode_lib->vba.dpte_group_bytes,\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.HostVMInefficiencyFactor, mode_lib->vba.HostVMMinPageSize,\n\t\t\t\t\tmode_lib->vba.HostVMMaxNonCachedPageTableLevels);\n\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NextPrefetchModeState = mode_lib->vba.MinPrefetchMode;\n\n\t\t\tmode_lib->vba.NextMaxVStartup = mode_lib->vba.MaxMaxVStartup[i][j];\n\n\t\t\tdo {\n\t\t\t\tmode_lib->vba.PrefetchModePerState[i][j] = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NextPrefetchModeState;\n\t\t\t\tmode_lib->vba.MaxVStartup = mode_lib->vba.NextMaxVStartup;\n\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\t\tmode_lib->vba.TWait = dml32_CalculateTWait(\n\t\t\t\t\t\t\tmode_lib->vba.PrefetchModePerState[i][j],\n\t\t\t\t\t\t\tmode_lib->vba.UsesMALLForPStateChange[k],\n\t\t\t\t\t\t\tmode_lib->vba.SynchronizeDRRDisplaysForUCLKPStateChangeFinal,\n\t\t\t\t\t\t\tmode_lib->vba.DRRDisplay[k],\n\t\t\t\t\t\t\tmode_lib->vba.DRAMClockChangeLatency,\n\t\t\t\t\t\t\tmode_lib->vba.FCLKChangeLatency, mode_lib->vba.UrgLatency[i],\n\t\t\t\t\t\t\tmode_lib->vba.SREnterPlusExitTime);\n\n\t\t\t\t\tmemset(&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull, 0, sizeof(DmlPipe));\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.Dppclk = mode_lib->vba.RequiredDPPCLK[i][j][k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.Dispclk = mode_lib->vba.RequiredDISPCLK[i][j];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.PixelClock = mode_lib->vba.PixelClock[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.DCFClkDeepSleep = mode_lib->vba.ProjectedDCFCLKDeepSleep[i][j];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.DPPPerSurface = mode_lib->vba.NoOfDPP[i][j][k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.ScalerEnabled = mode_lib->vba.ScalerEnabled[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.SourceRotation = mode_lib->vba.SourceRotation[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.BlockWidth256BytesY = mode_lib->vba.Read256BlockWidthY[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.BlockHeight256BytesY = mode_lib->vba.Read256BlockHeightY[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.BlockWidth256BytesC = mode_lib->vba.Read256BlockWidthC[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.BlockHeight256BytesC = mode_lib->vba.Read256BlockHeightC[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.InterlaceEnable = mode_lib->vba.Interlace[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.NumberOfCursors = mode_lib->vba.NumberOfCursors[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.VBlank = mode_lib->vba.VTotal[k] - mode_lib->vba.VActive[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.HTotal = mode_lib->vba.HTotal[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.HActive = mode_lib->vba.HActive[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.DCCEnable = mode_lib->vba.DCCEnable[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.ODMMode = mode_lib->vba.ODMCombineEnablePerState[i][k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.SourcePixelFormat = mode_lib->vba.SourcePixelFormat[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.BytePerPixelY = mode_lib->vba.BytePerPixelY[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.BytePerPixelC = mode_lib->vba.BytePerPixelC[k];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe.ProgressiveToInterlaceUnitInOPP =\n\t\t\t\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP;\n\n\t\t\t\t\tmode_lib->vba.NoTimeForPrefetch[i][j][k] =\n\t\t\t\t\t\tdml32_CalculatePrefetchSchedule(\n\t\t\t\t\t\t\tv,\n\t\t\t\t\t\t\tk,\n\t\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.HostVMInefficiencyFactor,\n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.myPipe,\n\t\t\t\t\t\t\tv->DSCDelayPerState[i][k],\n\t\t\t\t\t\t\tv->SwathWidthYThisState[k] / v->HRatio[k],\n\t\t\t\t\t\t\tdml_min(v->MaxVStartup, v->MaximumVStartup[i][j][k]),\n\t\t\t\t\t\t\tv->MaximumVStartup[i][j][k],\n\t\t\t\t\t\t\tv->UrgLatency[i],\n\t\t\t\t\t\t\tv->ExtraLatency,\n\t\t\t\t\t\t\tv->TimeCalc,\n\t\t\t\t\t\t\tv->PDEAndMetaPTEBytesPerFrame[i][j][k],\n\t\t\t\t\t\t\tv->MetaRowBytes[i][j][k],\n\t\t\t\t\t\t\tv->DPTEBytesPerRow[i][j][k],\n\t\t\t\t\t\t\tv->PrefetchLinesY[i][j][k],\n\t\t\t\t\t\t\tv->SwathWidthYThisState[k],\n\t\t\t\t\t\t\tv->PrefillY[k],\n\t\t\t\t\t\t\tv->MaxNumSwY[k],\n\t\t\t\t\t\t\tv->PrefetchLinesC[i][j][k],\n\t\t\t\t\t\t\tv->SwathWidthCThisState[k],\n\t\t\t\t\t\t\tv->PrefillC[k],\n\t\t\t\t\t\t\tv->MaxNumSwC[k],\n\t\t\t\t\t\t\tv->swath_width_luma_ub_this_state[k],\n\t\t\t\t\t\t\tv->swath_width_chroma_ub_this_state[k],\n\t\t\t\t\t\t\tv->SwathHeightYThisState[k],\n\t\t\t\t\t\t\tv->SwathHeightCThisState[k], v->TWait,\n\t\t\t\t\t\t\t(v->DRAMSpeedPerState[i] <= MEM_STROBE_FREQ_MHZ || v->DCFCLKState[i][j] <= DCFCLK_FREQ_EXTRA_PREFETCH_REQ_MHZ) ?\n\t\t\t\t\t\t\t\t\tmode_lib->vba.ip.min_prefetch_in_strobe_us : 0,\n\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.DSTXAfterScaler[k],\n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.DSTYAfterScaler[k],\n\t\t\t\t\t\t\t&v->LineTimesForPrefetch[k],\n\t\t\t\t\t\t\t&v->PrefetchBW[k],\n\t\t\t\t\t\t\t&v->LinesForMetaPTE[k],\n\t\t\t\t\t\t\t&v->LinesForMetaAndDPTERow[k],\n\t\t\t\t\t\t\t&v->VRatioPreY[i][j][k],\n\t\t\t\t\t\t\t&v->VRatioPreC[i][j][k],\n\t\t\t\t\t\t\t&v->RequiredPrefetchPixelDataBWLuma[0][0][k],\n\t\t\t\t\t\t\t&v->RequiredPrefetchPixelDataBWChroma[0][0][k],\n\t\t\t\t\t\t\t&v->NoTimeForDynamicMetadata[i][j][k],\n\t\t\t\t\t\t\t&v->Tno_bw[k],\n\t\t\t\t\t\t\t&v->prefetch_vmrow_bw[k],\n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single[0],         \n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single[1],         \n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single[2],         \n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer[0],         \t\t\t\t\t\t\t    \n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single[3],         \n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single[4]);        \n\t\t\t\t}\n\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\t\tdml32_CalculateUrgentBurstFactor(\n\t\t\t\t\t\t\tmode_lib->vba.UsesMALLForPStateChange[k],\n\t\t\t\t\t\t\tmode_lib->vba.swath_width_luma_ub_this_state[k],\n\t\t\t\t\t\t\tmode_lib->vba.swath_width_chroma_ub_this_state[k],\n\t\t\t\t\t\t\tmode_lib->vba.SwathHeightYThisState[k],\n\t\t\t\t\t\t\tmode_lib->vba.SwathHeightCThisState[k],\n\t\t\t\t\t\t\tmode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\tmode_lib->vba.UrgLatency[i], mode_lib->vba.CursorBufferSize,\n\t\t\t\t\t\t\tmode_lib->vba.CursorWidth[k][0], mode_lib->vba.CursorBPP[k][0],\n\t\t\t\t\t\t\tmode_lib->vba.VRatioPreY[i][j][k],\n\t\t\t\t\t\t\tmode_lib->vba.VRatioPreC[i][j][k],\n\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETY[k],\n\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETC[k],\n\t\t\t\t\t\t\tmode_lib->vba.DETBufferSizeYThisState[k],\n\t\t\t\t\t\t\tmode_lib->vba.DETBufferSizeCThisState[k],\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t&mode_lib->vba.UrgentBurstFactorCursorPre[k],\n\t\t\t\t\t\t\t&mode_lib->vba.UrgentBurstFactorLumaPre[k],\n\t\t\t\t\t\t\t&mode_lib->vba.UrgentBurstFactorChromaPre[k],\n\t\t\t\t\t\t\t&mode_lib->vba.NotUrgentLatencyHidingPre[k]);\n\t\t\t\t}\n\n\t\t\t\t{\n\t\t\t\t\tdml32_CalculatePrefetchBandwithSupport(\n\t\t\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\t\t\tmode_lib->vba.ReturnBWPerState[i][j],\n\t\t\t\t\t\t\tmode_lib->vba.NotUrgentLatencyHidingPre,\n\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthLuma,\n\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthChroma,\n\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixelDataBWLuma[0][0],\n\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixelDataBWChroma[0][0],\n\t\t\t\t\t\t\tmode_lib->vba.cursor_bw,\n\t\t\t\t\t\t\tmode_lib->vba.meta_row_bandwidth_this_state,\n\t\t\t\t\t\t\tmode_lib->vba.dpte_row_bandwidth_this_state,\n\t\t\t\t\t\t\tmode_lib->vba.cursor_bw_pre,\n\t\t\t\t\t\t\tmode_lib->vba.prefetch_vmrow_bw,\n\t\t\t\t\t\t\tmode_lib->vba.NoOfDPPThisState,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorLuma,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorChroma,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorCursor,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorLumaPre,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorChromaPre,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorCursorPre,\n\t\t\t\t\t\t\tv->PrefetchBW,\n\t\t\t\t\t\t\tv->VRatio,\n\t\t\t\t\t\t\tv->MaxVRatioPre,\n\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single[0],   \n\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single[1],   \n\t\t\t\t\t\t\t&mode_lib->vba.PrefetchSupported[i][j]);\n\t\t\t\t}\n\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\t\tif (mode_lib->vba.LineTimesForPrefetch[k]\n\t\t\t\t\t\t\t< 2.0 || mode_lib->vba.LinesForMetaPTE[k] >= 32.0\n\t\t\t\t\t\t\t|| mode_lib->vba.LinesForMetaAndDPTERow[k] >= 16.0\n\t\t\t\t\t\t\t|| mode_lib->vba.NoTimeForPrefetch[i][j][k] == true) {\n\t\t\t\t\t\tmode_lib->vba.PrefetchSupported[i][j] = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tmode_lib->vba.DynamicMetadataSupported[i][j] = true;\n\t\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\t\tif (mode_lib->vba.NoTimeForDynamicMetadata[i][j][k] == true)\n\t\t\t\t\t\tmode_lib->vba.DynamicMetadataSupported[i][j] = false;\n\t\t\t\t}\n\n\t\t\t\tmode_lib->vba.VRatioInPrefetchSupported[i][j] = true;\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\t\tif (mode_lib->vba.VRatioPreY[i][j][k] > mode_lib->vba.MaxVRatioPre\n\t\t\t\t\t\t\t|| mode_lib->vba.VRatioPreC[i][j][k] > mode_lib->vba.MaxVRatioPre\n\t\t\t\t\t\t\t|| mode_lib->vba.NoTimeForPrefetch[i][j][k] == true) {\n\t\t\t\t\t\tmode_lib->vba.VRatioInPrefetchSupported[i][j] = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tmode_lib->vba.AnyLinesForVMOrRowTooLarge = false;\n\t\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\t\tif (mode_lib->vba.LinesForMetaAndDPTERow[k] >= 16\n\t\t\t\t\t\t\t|| mode_lib->vba.LinesForMetaPTE[k] >= 32) {\n\t\t\t\t\t\tmode_lib->vba.AnyLinesForVMOrRowTooLarge = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (mode_lib->vba.PrefetchSupported[i][j] == true\n\t\t\t\t\t\t&& mode_lib->vba.VRatioInPrefetchSupported[i][j] == true) {\n\t\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip =\n\t\t\t\t\t\t\tdml32_CalculateBandwidthAvailableForImmediateFlip(\n\t\t\t\t\t\t\tmode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\t\t\tmode_lib->vba.ReturnBWPerState[i][j],\n\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthLuma,\n\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthChroma,\n\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixelDataBWLuma[0][0],\n\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixelDataBWChroma[0][0],\n\t\t\t\t\t\t\tmode_lib->vba.cursor_bw,\n\t\t\t\t\t\t\tmode_lib->vba.cursor_bw_pre,\n\t\t\t\t\t\t\tmode_lib->vba.NoOfDPPThisState,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorLuma,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorChroma,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorCursor,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorLumaPre,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorChromaPre,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorCursorPre);\n\n\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes = 0.0;\n\t\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\t\t\tif (!(mode_lib->vba.ImmediateFlipRequirement[k] ==\n\t\t\t\t\t\t\t\tdm_immediate_flip_not_required)) {\n\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes =\n\t\t\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes\n\t\t\t\t\t\t\t\t+ mode_lib->vba.NoOfDPP[i][j][k]\n\t\t\t\t\t\t\t\t* mode_lib->vba.PDEAndMetaPTEBytesPerFrame[i][j][k]\n\t\t\t\t\t\t\t\t+ mode_lib->vba.MetaRowBytes[i][j][k];\n\t\t\t\t\t\t\tif (mode_lib->vba.use_one_row_for_frame_flip[i][j][k]) {\n\t\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes =\n\t\t\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes + 2\n\t\t\t\t\t\t\t\t* mode_lib->vba.DPTEBytesPerRow[i][j][k];\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes =\n\t\t\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes\n\t\t\t\t\t\t\t\t+ mode_lib->vba.DPTEBytesPerRow[i][j][k];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\t\t\tdml32_CalculateFlipSchedule(v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.HostVMInefficiencyFactor,\n\t\t\t\t\t\t\tmode_lib->vba.ExtraLatency,\n\t\t\t\t\t\t\tmode_lib->vba.UrgLatency[i],\n\t\t\t\t\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\t\t\t\t\tmode_lib->vba.HostVMEnable,\n\t\t\t\t\t\t\tmode_lib->vba.HostVMMaxNonCachedPageTableLevels,\n\t\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\t\tmode_lib->vba.HostVMMinPageSize,\n\t\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrame[i][j][k],\n\t\t\t\t\t\t\tmode_lib->vba.MetaRowBytes[i][j][k],\n\t\t\t\t\t\t\tmode_lib->vba.DPTEBytesPerRow[i][j][k],\n\t\t\t\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip,\n\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes,\n\t\t\t\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\t\t\t\t(mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]),\n\t\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\t\tmode_lib->vba.VRatioChroma[k],\n\t\t\t\t\t\t\tmode_lib->vba.Tno_bw[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\t\tmode_lib->vba.dpte_row_height[k],\n\t\t\t\t\t\t\tmode_lib->vba.meta_row_height[k],\n\t\t\t\t\t\t\tmode_lib->vba.dpte_row_height_chroma[k],\n\t\t\t\t\t\t\tmode_lib->vba.meta_row_height_chroma[k],\n\t\t\t\t\t\t\tmode_lib->vba.use_one_row_for_frame_flip[i][j][k], \n\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t&mode_lib->vba.DestinationLinesToRequestVMInImmediateFlip[k],\n\t\t\t\t\t\t\t&mode_lib->vba.DestinationLinesToRequestRowInImmediateFlip[k],\n\t\t\t\t\t\t\t&mode_lib->vba.final_flip_bw[k],\n\t\t\t\t\t\t\t&mode_lib->vba.ImmediateFlipSupportedForPipe[k]);\n\t\t\t\t\t}\n\n\t\t\t\t\t{\n\t\t\t\t\t\tdml32_CalculateImmediateFlipBandwithSupport(mode_lib->vba.NumberOfActiveSurfaces,\n\t\t\t\t\t\t\t\tmode_lib->vba.ReturnBWPerState[i][j],\n\t\t\t\t\t\t\t\tmode_lib->vba.ImmediateFlipRequirement,\n\t\t\t\t\t\t\t\tmode_lib->vba.final_flip_bw,\n\t\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthLuma,\n\t\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthChroma,\n\t\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixelDataBWLuma[0][0],\n\t\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixelDataBWChroma[0][0],\n\t\t\t\t\t\t\t\tmode_lib->vba.cursor_bw,\n\t\t\t\t\t\t\t\tmode_lib->vba.meta_row_bandwidth_this_state,\n\t\t\t\t\t\t\t\tmode_lib->vba.dpte_row_bandwidth_this_state,\n\t\t\t\t\t\t\t\tmode_lib->vba.cursor_bw_pre,\n\t\t\t\t\t\t\t\tmode_lib->vba.prefetch_vmrow_bw,\n\t\t\t\t\t\t\t\tmode_lib->vba.DPPPerPlane,\n\t\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorLuma,\n\t\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorChroma,\n\t\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorCursor,\n\t\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorLumaPre,\n\t\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorChromaPre,\n\t\t\t\t\t\t\t\tmode_lib->vba.UrgentBurstFactorCursorPre,\n\n\t\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single[0], \n\t\t\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single[1], \n\t\t\t\t\t\t\t\t&mode_lib->vba.ImmediateFlipSupportedForState[i][j]); \n\t\t\t\t\t}\n\n\t\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\t\t\t\t\tif (!(mode_lib->vba.ImmediateFlipRequirement[k]\n\t\t\t\t\t\t\t\t== dm_immediate_flip_not_required)\n\t\t\t\t\t\t\t\t&& (mode_lib->vba.ImmediateFlipSupportedForPipe[k]\n\t\t\t\t\t\t\t\t\t\t== false))\n\t\t\t\t\t\t\tmode_lib->vba.ImmediateFlipSupportedForState[i][j] = false;\n\t\t\t\t\t}\n\t\t\t\t} else { \n\t\t\t\t\tmode_lib->vba.ImmediateFlipSupportedForState[i][j] = false;\n\t\t\t\t}\n\n\t\t\t\tif (mode_lib->vba.MaxVStartup <= __DML_VBA_MIN_VSTARTUP__\n\t\t\t\t\t\t|| mode_lib->vba.AnyLinesForVMOrRowTooLarge == false) {\n\t\t\t\t\tmode_lib->vba.NextMaxVStartup = mode_lib->vba.MaxMaxVStartup[i][j];\n\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NextPrefetchModeState = v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NextPrefetchModeState + 1;\n\t\t\t\t} else {\n\t\t\t\t\tmode_lib->vba.NextMaxVStartup = mode_lib->vba.NextMaxVStartup - 1;\n\t\t\t\t}\n\t\t\t} while (!((mode_lib->vba.PrefetchSupported[i][j] == true\n\t\t\t\t\t&& mode_lib->vba.DynamicMetadataSupported[i][j] == true\n\t\t\t\t\t&& mode_lib->vba.VRatioInPrefetchSupported[i][j] == true &&\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t((mode_lib->vba.HostVMEnable == false\n\t\t\t\t\t\t\t&& !mode_lib->vba.ImmediateFlipRequiredFinal)\n\t\t\t\t\t\t\t|| mode_lib->vba.ImmediateFlipSupportedForState[i][j] == true))\n\t\t\t\t\t|| (mode_lib->vba.NextMaxVStartup == mode_lib->vba.MaxMaxVStartup[i][j]\n\t\t\t\t\t\t\t&& v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.NextPrefetchModeState > mode_lib->vba.MaxPrefetchMode)));\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActiveSurfaces; ++k) {\n\t\t\t\tmode_lib->vba.use_one_row_for_frame_this_state[k] =\n\t\t\t\t\t\tmode_lib->vba.use_one_row_for_frame[i][j][k];\n\t\t\t}\n\n\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.UrgentLatency = mode_lib->vba.UrgLatency[i];\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.ExtraLatency = mode_lib->vba.ExtraLatency;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.WritebackLatency = mode_lib->vba.WritebackLatency;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.DRAMClockChangeLatency = mode_lib->vba.DRAMClockChangeLatency;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.FCLKChangeLatency = mode_lib->vba.FCLKChangeLatency;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.SRExitTime = mode_lib->vba.SRExitTime;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.SREnterPlusExitTime = mode_lib->vba.SREnterPlusExitTime;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.SRExitZ8Time = mode_lib->vba.SRExitZ8Time;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.SREnterPlusExitZ8Time = mode_lib->vba.SREnterPlusExitZ8Time;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.USRRetrainingLatency = mode_lib->vba.USRRetrainingLatency;\n\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters.SMNLatency = mode_lib->vba.SMNLatency;\n\n\t\t\t{\n\t\t\t\tdml32_CalculateWatermarksMALLUseAndDRAMSpeedChangeSupport(\n\t\t\t\t\t\tv,\n\t\t\t\t\t\tv->PrefetchModePerState[i][j],\n\t\t\t\t\t\tv->DCFCLKState[i][j],\n\t\t\t\t\t\tv->ReturnBWPerState[i][j],\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.mSOCParameters,\n\t\t\t\t\t\tv->SOCCLKPerState[i],\n\t\t\t\t\t\tv->ProjectedDCFCLKDeepSleep[i][j],\n\t\t\t\t\t\tv->DETBufferSizeYThisState,\n\t\t\t\t\t\tv->DETBufferSizeCThisState,\n\t\t\t\t\t\tv->SwathHeightYThisState,\n\t\t\t\t\t\tv->SwathHeightCThisState,\n\t\t\t\t\t\tv->SwathWidthYThisState, \n\t\t\t\t\t\tv->SwathWidthCThisState,\n\t\t\t\t\t\tv->NoOfDPPThisState,\n\t\t\t\t\t\tv->BytePerPixelInDETY,\n\t\t\t\t\t\tv->BytePerPixelInDETC,\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.DSTXAfterScaler,\n\t\t\t\t\t\tv->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.DSTYAfterScaler,\n\t\t\t\t\t\tv->UnboundedRequestEnabledThisState,\n\t\t\t\t\t\tv->CompressedBufferSizeInkByteThisState,\n\n\t\t\t\t\t\t \n\t\t\t\t\t\t&v->DRAMClockChangeSupport[i][j],\n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single2[0], \n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_integer[0], \n\t\t\t\t\t\t&v->FCLKChangeSupport[i][j],\n\t\t\t\t\t\t&v->dummy_vars.dml32_ModeSupportAndSystemConfigurationFull.dummy_single2[1], \n\t\t\t\t\t\t&mode_lib->vba.USRRetrainingSupport[i][j],\n\t\t\t\t\t\tmode_lib->vba.ActiveDRAMClockChangeLatencyMarginPerState[i][j]);\n\t\t\t}\n\t\t}\n\t} \n\n\t \n\tmode_lib->vba.CursorSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (mode_lib->vba.CursorWidth[k][0] > 0.0) {\n\t\t\tif (mode_lib->vba.CursorBPP[k][0] == 64 && mode_lib->vba.Cursor64BppSupport == false)\n\t\t\t\tmode_lib->vba.CursorSupport = false;\n\t\t}\n\t}\n\n\t \n\tmode_lib->vba.PitchSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tmode_lib->vba.AlignedYPitch[k] = dml_ceil(\n\t\t\t\tdml_max(mode_lib->vba.PitchY[k], mode_lib->vba.SurfaceWidthY[k]),\n\t\t\t\tmode_lib->vba.MacroTileWidthY[k]);\n\t\tif (mode_lib->vba.DCCEnable[k] == true) {\n\t\t\tmode_lib->vba.AlignedDCCMetaPitchY[k] = dml_ceil(\n\t\t\t\t\tdml_max(mode_lib->vba.DCCMetaPitchY[k], mode_lib->vba.SurfaceWidthY[k]),\n\t\t\t\t\t64.0 * mode_lib->vba.Read256BlockWidthY[k]);\n\t\t} else {\n\t\t\tmode_lib->vba.AlignedDCCMetaPitchY[k] = mode_lib->vba.DCCMetaPitchY[k];\n\t\t}\n\t\tif (mode_lib->vba.SourcePixelFormat[k] != dm_444_64 && mode_lib->vba.SourcePixelFormat[k] != dm_444_32\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_16\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_16\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_rgbe\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_8) {\n\t\t\tmode_lib->vba.AlignedCPitch[k] = dml_ceil(\n\t\t\t\t\tdml_max(mode_lib->vba.PitchC[k], mode_lib->vba.SurfaceWidthC[k]),\n\t\t\t\t\tmode_lib->vba.MacroTileWidthC[k]);\n\t\t\tif (mode_lib->vba.DCCEnable[k] == true) {\n\t\t\t\tmode_lib->vba.AlignedDCCMetaPitchC[k] = dml_ceil(\n\t\t\t\t\t\tdml_max(mode_lib->vba.DCCMetaPitchC[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.SurfaceWidthC[k]),\n\t\t\t\t\t\t64.0 * mode_lib->vba.Read256BlockWidthC[k]);\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.AlignedDCCMetaPitchC[k] = mode_lib->vba.DCCMetaPitchC[k];\n\t\t\t}\n\t\t} else {\n\t\t\tmode_lib->vba.AlignedCPitch[k] = mode_lib->vba.PitchC[k];\n\t\t\tmode_lib->vba.AlignedDCCMetaPitchC[k] = mode_lib->vba.DCCMetaPitchC[k];\n\t\t}\n\t\tif (mode_lib->vba.AlignedYPitch[k] > mode_lib->vba.PitchY[k]\n\t\t\t\t|| mode_lib->vba.AlignedCPitch[k] > mode_lib->vba.PitchC[k]\n\t\t\t\t|| mode_lib->vba.AlignedDCCMetaPitchY[k] > mode_lib->vba.DCCMetaPitchY[k]\n\t\t\t\t|| mode_lib->vba.AlignedDCCMetaPitchC[k] > mode_lib->vba.DCCMetaPitchC[k]) {\n\t\t\tmode_lib->vba.PitchSupport = false;\n\t\t}\n\t}\n\n\tmode_lib->vba.ViewportExceedsSurface = false;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (mode_lib->vba.ViewportWidth[k] > mode_lib->vba.SurfaceWidthY[k]\n\t\t\t\t|| mode_lib->vba.ViewportHeight[k] > mode_lib->vba.SurfaceHeightY[k]) {\n\t\t\tmode_lib->vba.ViewportExceedsSurface = true;\n\t\t\tif (mode_lib->vba.SourcePixelFormat[k] != dm_444_64\n\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_32\n\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_16\n\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_8\n\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_rgbe) {\n\t\t\t\tif (mode_lib->vba.ViewportWidthChroma[k] > mode_lib->vba.SurfaceWidthC[k]\n\t\t\t\t\t\t|| mode_lib->vba.ViewportHeightChroma[k]\n\t\t\t\t\t\t\t\t> mode_lib->vba.SurfaceHeightC[k]) {\n\t\t\t\t\tmode_lib->vba.ViewportExceedsSurface = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tmode_support_configuration(v, mode_lib);\n\n\tMaximumMPCCombine = 0;\n\n\tfor (i = v->soc.num_states; i >= start_state; i--) {\n\t\tif (i == v->soc.num_states || mode_lib->vba.ModeSupport[i][0] == true ||\n\t\t\t\tmode_lib->vba.ModeSupport[i][1] == true) {\n\t\t\tmode_lib->vba.VoltageLevel = i;\n\t\t\tmode_lib->vba.ModeIsSupported = mode_lib->vba.ModeSupport[i][0] == true\n\t\t\t\t\t|| mode_lib->vba.ModeSupport[i][1] == true;\n\n\t\t\tif (mode_lib->vba.ModeSupport[i][0] == true)\n\t\t\t\tMaximumMPCCombine = 0;\n\t\t\telse\n\t\t\t\tMaximumMPCCombine = 1;\n\t\t}\n\t}\n\n\tmode_lib->vba.ImmediateFlipSupport =\n\t\t\tmode_lib->vba.ImmediateFlipSupportedForState[mode_lib->vba.VoltageLevel][MaximumMPCCombine];\n\tmode_lib->vba.UnboundedRequestEnabled =\n\t\t\tmode_lib->vba.UnboundedRequestEnabledAllStates[mode_lib->vba.VoltageLevel][MaximumMPCCombine];\n\tmode_lib->vba.CompressedBufferSizeInkByte =\n\t\t\tmode_lib->vba.CompressedBufferSizeInkByteAllStates[mode_lib->vba.VoltageLevel][MaximumMPCCombine]; \n\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tmode_lib->vba.MPCCombineEnable[k] =\n\t\t\t\tmode_lib->vba.MPCCombine[mode_lib->vba.VoltageLevel][MaximumMPCCombine][k];\n\t\tmode_lib->vba.DPPPerPlane[k] = mode_lib->vba.NoOfDPP[mode_lib->vba.VoltageLevel][MaximumMPCCombine][k];\n\t\tmode_lib->vba.SwathHeightY[k] =\n\t\t\t\tmode_lib->vba.SwathHeightYAllStates[mode_lib->vba.VoltageLevel][MaximumMPCCombine][k];\n\t\tmode_lib->vba.SwathHeightC[k] =\n\t\t\t\tmode_lib->vba.SwathHeightCAllStates[mode_lib->vba.VoltageLevel][MaximumMPCCombine][k];\n\t\tmode_lib->vba.DETBufferSizeInKByte[k] =\n\t\t\tmode_lib->vba.DETBufferSizeInKByteAllStates[mode_lib->vba.VoltageLevel][MaximumMPCCombine][k];\n\t\tmode_lib->vba.DETBufferSizeY[k] =\n\t\t\t\tmode_lib->vba.DETBufferSizeYAllStates[mode_lib->vba.VoltageLevel][MaximumMPCCombine][k];\n\t\tmode_lib->vba.DETBufferSizeC[k] =\n\t\t\t\tmode_lib->vba.DETBufferSizeCAllStates[mode_lib->vba.VoltageLevel][MaximumMPCCombine][k];\n\t\tmode_lib->vba.OutputType[k] = mode_lib->vba.OutputTypePerState[mode_lib->vba.VoltageLevel][k];\n\t\tmode_lib->vba.OutputRate[k] = mode_lib->vba.OutputRatePerState[mode_lib->vba.VoltageLevel][k];\n\t}\n\n\tmode_lib->vba.DCFCLK = mode_lib->vba.DCFCLKState[mode_lib->vba.VoltageLevel][MaximumMPCCombine];\n\tmode_lib->vba.DRAMSpeed = mode_lib->vba.DRAMSpeedPerState[mode_lib->vba.VoltageLevel];\n\tmode_lib->vba.FabricClock = mode_lib->vba.FabricClockPerState[mode_lib->vba.VoltageLevel];\n\tmode_lib->vba.SOCCLK = mode_lib->vba.SOCCLKPerState[mode_lib->vba.VoltageLevel];\n\tmode_lib->vba.ReturnBW = mode_lib->vba.ReturnBWPerState[mode_lib->vba.VoltageLevel][MaximumMPCCombine];\n\tmode_lib->vba.DISPCLK = mode_lib->vba.RequiredDISPCLK[mode_lib->vba.VoltageLevel][MaximumMPCCombine];\n\tmode_lib->vba.maxMpcComb = MaximumMPCCombine;\n\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActiveSurfaces - 1; k++) {\n\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\tmode_lib->vba.ODMCombineEnabled[k] =\n\t\t\t\t\tmode_lib->vba.ODMCombineEnablePerState[mode_lib->vba.VoltageLevel][k];\n\t\t} else {\n\t\t\tmode_lib->vba.ODMCombineEnabled[k] = dm_odm_combine_mode_disabled;\n\t\t}\n\n\t\tmode_lib->vba.DSCEnabled[k] = mode_lib->vba.RequiresDSC[mode_lib->vba.VoltageLevel][k];\n\t\tmode_lib->vba.FECEnable[k] = mode_lib->vba.RequiresFEC[mode_lib->vba.VoltageLevel][k];\n\t\tmode_lib->vba.OutputBpp[k] = mode_lib->vba.OutputBppPerState[mode_lib->vba.VoltageLevel][k];\n\t}\n\n\tmode_lib->vba.UrgentWatermark = mode_lib->vba.Watermark.UrgentWatermark;\n\tmode_lib->vba.StutterEnterPlusExitWatermark = mode_lib->vba.Watermark.StutterEnterPlusExitWatermark;\n\tmode_lib->vba.StutterExitWatermark = mode_lib->vba.Watermark.StutterExitWatermark;\n\tmode_lib->vba.WritebackDRAMClockChangeWatermark = mode_lib->vba.Watermark.WritebackDRAMClockChangeWatermark;\n\tmode_lib->vba.DRAMClockChangeWatermark = mode_lib->vba.Watermark.DRAMClockChangeWatermark;\n\tmode_lib->vba.UrgentLatency = mode_lib->vba.UrgLatency[mode_lib->vba.VoltageLevel];\n\tmode_lib->vba.DCFCLKDeepSleep = mode_lib->vba.ProjectedDCFCLKDeepSleep[mode_lib->vba.VoltageLevel][MaximumMPCCombine];\n\n\t \n} \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}