{
  "module_name": "link_dp_training_fixed_vs_pe_retimer.c",
  "hash_id": "f008e546931fef8cc1400f615383030d47b50199d1c85c5b346a4afd0317589b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/link/protocols/link_dp_training_fixed_vs_pe_retimer.c",
  "human_readable_source": " \n\n \n#include \"link_dp_training_fixed_vs_pe_retimer.h\"\n#include \"link_dp_training_8b_10b.h\"\n#include \"link_dpcd.h\"\n#include \"link_dp_phy.h\"\n#include \"link_dp_capability.h\"\n#include \"link_ddc.h\"\n\n#define DC_LOGGER \\\n\tlink->ctx->logger\n\nvoid dp_fixed_vs_pe_read_lane_adjust(\n\tstruct dc_link *link,\n\tunion dpcd_training_lane dpcd_lane_adjust[LANE_COUNT_DP_MAX])\n{\n\tconst uint8_t vendor_lttpr_write_data_vs[3] = {0x0, 0x53, 0x63};\n\tconst uint8_t vendor_lttpr_write_data_pe[3] = {0x0, 0x54, 0x63};\n\tuint8_t dprx_vs = 0;\n\tuint8_t dprx_pe = 0;\n\tuint8_t lane;\n\n\t \n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_vs[0], sizeof(vendor_lttpr_write_data_vs));\n\n\tlink_query_fixed_vs_pe_retimer(link->ddc, &dprx_vs, 1);\n\n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pe[0], sizeof(vendor_lttpr_write_data_pe));\n\n\tlink_query_fixed_vs_pe_retimer(link->ddc, &dprx_pe, 1);\n\n\tfor (lane = 0; lane < LANE_COUNT_DP_MAX; lane++) {\n\t\tdpcd_lane_adjust[lane].bits.VOLTAGE_SWING_SET  = (dprx_vs >> (2 * lane)) & 0x3;\n\t\tdpcd_lane_adjust[lane].bits.PRE_EMPHASIS_SET = (dprx_pe >> (2 * lane)) & 0x3;\n\t}\n}\n\n\nvoid dp_fixed_vs_pe_set_retimer_lane_settings(\n\tstruct dc_link *link,\n\tconst union dpcd_training_lane dpcd_lane_adjust[LANE_COUNT_DP_MAX],\n\tuint8_t lane_count)\n{\n\tconst uint8_t vendor_lttpr_write_data_reset[4] = {0x1, 0x50, 0x63, 0xFF};\n\tuint8_t vendor_lttpr_write_data_vs[4] = {0x1, 0x51, 0x63, 0x0};\n\tuint8_t vendor_lttpr_write_data_pe[4] = {0x1, 0x52, 0x63, 0x0};\n\tuint8_t lane = 0;\n\n\tfor (lane = 0; lane < lane_count; lane++) {\n\t\tvendor_lttpr_write_data_vs[3] |=\n\t\t\t\tdpcd_lane_adjust[lane].bits.VOLTAGE_SWING_SET << (2 * lane);\n\t\tvendor_lttpr_write_data_pe[3] |=\n\t\t\t\tdpcd_lane_adjust[lane].bits.PRE_EMPHASIS_SET << (2 * lane);\n\t}\n\n\t \n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_reset[0], sizeof(vendor_lttpr_write_data_reset));\n\n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_vs[0], sizeof(vendor_lttpr_write_data_vs));\n\n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pe[0], sizeof(vendor_lttpr_write_data_pe));\n}\n\nstatic enum link_training_result perform_fixed_vs_pe_nontransparent_training_sequence(\n\t\tstruct dc_link *link,\n\t\tconst struct link_resource *link_res,\n\t\tstruct link_training_settings *lt_settings)\n{\n\tenum link_training_result status = LINK_TRAINING_SUCCESS;\n\tuint8_t lane = 0;\n\tuint8_t toggle_rate = 0x6;\n\tuint8_t target_rate = 0x6;\n\tbool apply_toggle_rate_wa = false;\n\tuint8_t repeater_cnt;\n\tuint8_t repeater_id;\n\n\t \n\tif (lt_settings->cr_pattern_time < 16000)\n\t\tlt_settings->cr_pattern_time = 16000;\n\n\t \n\tapply_toggle_rate_wa = ((link->vendor_specific_lttpr_link_rate_wa == target_rate) || (link->vendor_specific_lttpr_link_rate_wa == 0));\n\ttarget_rate = get_dpcd_link_rate(&lt_settings->link_settings);\n\ttoggle_rate = (target_rate == 0x6) ? 0xA : 0x6;\n\n\tif (apply_toggle_rate_wa)\n\t\tlt_settings->link_settings.link_rate = toggle_rate;\n\n\tif (link->ctx->dc->work_arounds.lt_early_cr_pattern)\n\t\tstart_clock_recovery_pattern_early(link, link_res, lt_settings, DPRX);\n\n\t \n\tdpcd_set_link_settings(link, lt_settings);\n\n\t \n\tif (apply_toggle_rate_wa) {\n\t\tcore_link_write_dpcd(\n\t\t\t\tlink,\n\t\t\t\tDP_LINK_BW_SET,\n\t\t\t\t&target_rate,\n\t\t\t\t1);\n\t}\n\n\tlink->vendor_specific_lttpr_link_rate_wa = target_rate;\n\n\tif (lt_settings->lttpr_mode == LTTPR_MODE_NON_TRANSPARENT) {\n\n\t\t \n\t\trepeater_cnt = dp_parse_lttpr_repeater_count(link->dpcd_caps.lttpr_caps.phy_repeater_cnt);\n\n\t\tfor (repeater_id = repeater_cnt; (repeater_id > 0 && status == LINK_TRAINING_SUCCESS);\n\t\t\t\trepeater_id--) {\n\t\t\tstatus = perform_8b_10b_clock_recovery_sequence(link, link_res, lt_settings, repeater_id);\n\n\t\t\tif (status != LINK_TRAINING_SUCCESS) {\n\t\t\t\trepeater_training_done(link, repeater_id);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tstatus = perform_8b_10b_channel_equalization_sequence(link,\n\t\t\t\t\tlink_res,\n\t\t\t\t\tlt_settings,\n\t\t\t\t\trepeater_id);\n\n\t\t\trepeater_training_done(link, repeater_id);\n\n\t\t\tif (status != LINK_TRAINING_SUCCESS)\n\t\t\t\tbreak;\n\n\t\t\tfor (lane = 0; lane < LANE_COUNT_DP_MAX; lane++) {\n\t\t\t\tlt_settings->dpcd_lane_settings[lane].raw = 0;\n\t\t\t\tlt_settings->hw_lane_settings[lane].VOLTAGE_SWING = 0;\n\t\t\t\tlt_settings->hw_lane_settings[lane].PRE_EMPHASIS = 0;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (status == LINK_TRAINING_SUCCESS) {\n\t\tstatus = perform_8b_10b_clock_recovery_sequence(link, link_res, lt_settings, DPRX);\n\t\tif (status == LINK_TRAINING_SUCCESS) {\n\t\t\tstatus = perform_8b_10b_channel_equalization_sequence(link,\n\t\t\t\t\t\t\t\t       link_res,\n\t\t\t\t\t\t\t\t       lt_settings,\n\t\t\t\t\t\t\t\t       DPRX);\n\t\t}\n\t}\n\n\treturn status;\n}\n\n\nenum link_training_result dp_perform_fixed_vs_pe_training_sequence_legacy(\n\tstruct dc_link *link,\n\tconst struct link_resource *link_res,\n\tstruct link_training_settings *lt_settings)\n{\n\tconst uint8_t vendor_lttpr_write_data_reset[4] = {0x1, 0x50, 0x63, 0xFF};\n\tconst uint8_t offset = dp_parse_lttpr_repeater_count(\n\t\t\tlink->dpcd_caps.lttpr_caps.phy_repeater_cnt);\n\tconst uint8_t vendor_lttpr_write_data_intercept_en[4] = {0x1, 0x55, 0x63, 0x0};\n\tconst uint8_t vendor_lttpr_write_data_intercept_dis[4] = {0x1, 0x55, 0x63, 0x68};\n\tuint32_t pre_disable_intercept_delay_ms = 0;\n\tuint8_t vendor_lttpr_write_data_vs[4] = {0x1, 0x51, 0x63, 0x0};\n\tuint8_t vendor_lttpr_write_data_pe[4] = {0x1, 0x52, 0x63, 0x0};\n\tconst uint8_t vendor_lttpr_write_data_4lane_1[4] = {0x1, 0x6E, 0xF2, 0x19};\n\tconst uint8_t vendor_lttpr_write_data_4lane_2[4] = {0x1, 0x6B, 0xF2, 0x01};\n\tconst uint8_t vendor_lttpr_write_data_4lane_3[4] = {0x1, 0x6D, 0xF2, 0x18};\n\tconst uint8_t vendor_lttpr_write_data_4lane_4[4] = {0x1, 0x6C, 0xF2, 0x03};\n\tconst uint8_t vendor_lttpr_write_data_4lane_5[4] = {0x1, 0x03, 0xF3, 0x06};\n\tenum link_training_result status = LINK_TRAINING_SUCCESS;\n\tuint8_t lane = 0;\n\tunion down_spread_ctrl downspread = {0};\n\tunion lane_count_set lane_count_set = {0};\n\tuint8_t toggle_rate;\n\tuint8_t rate;\n\n\t \n\tASSERT(link_dp_get_encoding_format(&lt_settings->link_settings) ==\n\t\t\tDP_8b_10b_ENCODING);\n\n\tif (lt_settings->lttpr_mode == LTTPR_MODE_NON_TRANSPARENT) {\n\t\tstatus = perform_fixed_vs_pe_nontransparent_training_sequence(link, link_res, lt_settings);\n\t\treturn status;\n\t}\n\n\tif (offset != 0xFF) {\n\t\tif (offset == 2) {\n\t\t\tpre_disable_intercept_delay_ms = link->dc->debug.fixed_vs_aux_delay_config_wa;\n\n\t\t \n\t\t} else if (offset > 2) {\n\t\t\tpre_disable_intercept_delay_ms = link->dc->debug.fixed_vs_aux_delay_config_wa * 2;\n\t\t}\n\t}\n\n\t \n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_reset[0], sizeof(vendor_lttpr_write_data_reset));\n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_vs[0], sizeof(vendor_lttpr_write_data_vs));\n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pe[0], sizeof(vendor_lttpr_write_data_pe));\n\n\t \n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_intercept_en[0], sizeof(vendor_lttpr_write_data_intercept_en));\n\n\n\t \n\n\tdownspread.raw = (uint8_t)(lt_settings->link_settings.link_spread);\n\n\tlane_count_set.bits.LANE_COUNT_SET =\n\tlt_settings->link_settings.lane_count;\n\n\tlane_count_set.bits.ENHANCED_FRAMING = lt_settings->enhanced_framing;\n\tlane_count_set.bits.POST_LT_ADJ_REQ_GRANTED = 0;\n\n\n\tif (lt_settings->pattern_for_eq < DP_TRAINING_PATTERN_SEQUENCE_4) {\n\t\tlane_count_set.bits.POST_LT_ADJ_REQ_GRANTED =\n\t\t\t\tlink->dpcd_caps.max_ln_count.bits.POST_LT_ADJ_REQ_SUPPORTED;\n\t}\n\n\tcore_link_write_dpcd(link, DP_DOWNSPREAD_CTRL,\n\t\t&downspread.raw, sizeof(downspread));\n\n\tcore_link_write_dpcd(link, DP_LANE_COUNT_SET,\n\t\t&lane_count_set.raw, 1);\n\n\trate = get_dpcd_link_rate(&lt_settings->link_settings);\n\n\t \n\ttoggle_rate = (rate == 0x6) ? 0xA : 0x6;\n\n\tif (link->vendor_specific_lttpr_link_rate_wa == rate || link->vendor_specific_lttpr_link_rate_wa == 0) {\n\t\tcore_link_write_dpcd(\n\t\t\t\tlink,\n\t\t\t\tDP_LINK_BW_SET,\n\t\t\t\t&toggle_rate,\n\t\t\t\t1);\n\t}\n\n\tlink->vendor_specific_lttpr_link_rate_wa = rate;\n\n\tcore_link_write_dpcd(link, DP_LINK_BW_SET, &rate, 1);\n\n\tDC_LOG_HW_LINK_TRAINING(\"%s\\n %x rate = %x\\n %x lane = %x framing = %x\\n %x spread = %x\\n\",\n\t\t__func__,\n\t\tDP_LINK_BW_SET,\n\t\tlt_settings->link_settings.link_rate,\n\t\tDP_LANE_COUNT_SET,\n\t\tlt_settings->link_settings.lane_count,\n\t\tlt_settings->enhanced_framing,\n\t\tDP_DOWNSPREAD_CTRL,\n\t\tlt_settings->link_settings.link_spread);\n\n\tif (lt_settings->link_settings.lane_count == LANE_COUNT_FOUR) {\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_1[0], sizeof(vendor_lttpr_write_data_4lane_1));\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_2[0], sizeof(vendor_lttpr_write_data_4lane_2));\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_3[0], sizeof(vendor_lttpr_write_data_4lane_3));\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_4[0], sizeof(vendor_lttpr_write_data_4lane_4));\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_5[0], sizeof(vendor_lttpr_write_data_4lane_5));\n\t}\n\n\t \n\n\t \n\tif (status == LINK_TRAINING_SUCCESS) {\n\t\tconst uint8_t max_vendor_dpcd_retries = 10;\n\t\tuint32_t retries_cr;\n\t\tuint32_t retry_count;\n\t\tuint32_t wait_time_microsec;\n\t\tenum dc_lane_count lane_count = lt_settings->link_settings.lane_count;\n\t\tunion lane_status dpcd_lane_status[LANE_COUNT_DP_MAX];\n\t\tunion lane_align_status_updated dpcd_lane_status_updated;\n\t\tunion lane_adjust dpcd_lane_adjust[LANE_COUNT_DP_MAX] = {0};\n\t\tuint8_t i = 0;\n\n\t\tretries_cr = 0;\n\t\tretry_count = 0;\n\n\t\tmemset(&dpcd_lane_status, '\\0', sizeof(dpcd_lane_status));\n\t\tmemset(&dpcd_lane_status_updated, '\\0',\n\t\tsizeof(dpcd_lane_status_updated));\n\n\t\twhile ((retries_cr < LINK_TRAINING_MAX_RETRY_COUNT) &&\n\t\t\t(retry_count < LINK_TRAINING_MAX_CR_RETRY)) {\n\n\n\t\t\t \n\t\t\tdp_set_hw_lane_settings(\n\t\t\t\t\tlink,\n\t\t\t\t\tlink_res,\n\t\t\t\t\tlt_settings,\n\t\t\t\t\t0);\n\n\t\t\t \n\t\t\tif (!retry_count) {\n\t\t\t\t \n\t\t\t\tdpcd_set_lt_pattern_and_lane_settings(\n\t\t\t\t\t\tlink,\n\t\t\t\t\t\tlt_settings,\n\t\t\t\t\t\tlt_settings->pattern_for_cr,\n\t\t\t\t\t\t0);\n\t\t\t\t \n\t\t\t\tfor (i = 0; i < max_vendor_dpcd_retries; i++) {\n\t\t\t\t\tif (pre_disable_intercept_delay_ms != 0)\n\t\t\t\t\t\tmsleep(pre_disable_intercept_delay_ms);\n\t\t\t\t\tif (link_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t\t\t&vendor_lttpr_write_data_intercept_dis[0],\n\t\t\t\t\t\t\tsizeof(vendor_lttpr_write_data_intercept_dis)))\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t\t\t&vendor_lttpr_write_data_intercept_en[0],\n\t\t\t\t\t\t\tsizeof(vendor_lttpr_write_data_intercept_en));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tvendor_lttpr_write_data_vs[3] = 0;\n\t\t\t\tvendor_lttpr_write_data_pe[3] = 0;\n\n\t\t\t\tfor (lane = 0; lane < lane_count; lane++) {\n\t\t\t\t\tvendor_lttpr_write_data_vs[3] |=\n\t\t\t\t\t\t\tlt_settings->dpcd_lane_settings[lane].bits.VOLTAGE_SWING_SET << (2 * lane);\n\t\t\t\t\tvendor_lttpr_write_data_pe[3] |=\n\t\t\t\t\t\t\tlt_settings->dpcd_lane_settings[lane].bits.PRE_EMPHASIS_SET << (2 * lane);\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t\t&vendor_lttpr_write_data_vs[0], sizeof(vendor_lttpr_write_data_vs));\n\t\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t\t&vendor_lttpr_write_data_pe[0], sizeof(vendor_lttpr_write_data_pe));\n\n\t\t\t\tdpcd_set_lane_settings(\n\t\t\t\t\t\tlink,\n\t\t\t\t\t\tlt_settings,\n\t\t\t\t\t\t0);\n\t\t\t}\n\n\t\t\t \n\t\t\twait_time_microsec = lt_settings->cr_pattern_time;\n\n\t\t\tdp_wait_for_training_aux_rd_interval(\n\t\t\t\t\tlink,\n\t\t\t\t\twait_time_microsec);\n\n\t\t\t \n\t\t\tdp_get_lane_status_and_lane_adjust(\n\t\t\t\t\tlink,\n\t\t\t\t\tlt_settings,\n\t\t\t\t\tdpcd_lane_status,\n\t\t\t\t\t&dpcd_lane_status_updated,\n\t\t\t\t\tdpcd_lane_adjust,\n\t\t\t\t\t0);\n\n\t\t\t \n\t\t\tif (dp_is_cr_done(lane_count, dpcd_lane_status)) {\n\t\t\t\tstatus = LINK_TRAINING_SUCCESS;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t \n\t\t\tif (dp_is_max_vs_reached(lt_settings))\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\t \n\t\t\tif (lt_settings->dpcd_lane_settings[0].bits.VOLTAGE_SWING_SET ==\n\t\t\t\t\tdpcd_lane_adjust[0].bits.VOLTAGE_SWING_LANE)\n\t\t\t\tretries_cr++;\n\t\t\telse\n\t\t\t\tretries_cr = 0;\n\n\t\t\t \n\t\t\tdp_decide_lane_settings(lt_settings, dpcd_lane_adjust,\n\t\t\t\t\tlt_settings->hw_lane_settings, lt_settings->dpcd_lane_settings);\n\t\t\tretry_count++;\n\t\t}\n\n\t\tif (retry_count >= LINK_TRAINING_MAX_CR_RETRY) {\n\t\t\tASSERT(0);\n\t\t\tDC_LOG_ERROR(\"%s: Link Training Error, could not get CR after %d tries. Possibly voltage swing issue\",\n\t\t\t\t__func__,\n\t\t\t\tLINK_TRAINING_MAX_CR_RETRY);\n\n\t\t}\n\n\t\tstatus = dp_get_cr_failure(lane_count, dpcd_lane_status);\n\t}\n\n\t \n\tif (status == LINK_TRAINING_SUCCESS) {\n\t\tenum dc_dp_training_pattern tr_pattern;\n\t\tuint32_t retries_ch_eq;\n\t\tuint32_t wait_time_microsec;\n\t\tenum dc_lane_count lane_count = lt_settings->link_settings.lane_count;\n\t\tunion lane_align_status_updated dpcd_lane_status_updated = {0};\n\t\tunion lane_status dpcd_lane_status[LANE_COUNT_DP_MAX] = {0};\n\t\tunion lane_adjust dpcd_lane_adjust[LANE_COUNT_DP_MAX] = {0};\n\n\t\t \n\t\ttr_pattern = lt_settings->pattern_for_eq;\n\n\t\tdp_set_hw_training_pattern(link, link_res, tr_pattern, 0);\n\n\t\tstatus = LINK_TRAINING_EQ_FAIL_EQ;\n\n\t\tfor (retries_ch_eq = 0; retries_ch_eq <= LINK_TRAINING_MAX_RETRY_COUNT;\n\t\t\tretries_ch_eq++) {\n\n\t\t\tdp_set_hw_lane_settings(link, link_res, lt_settings, 0);\n\n\t\t\tvendor_lttpr_write_data_vs[3] = 0;\n\t\t\tvendor_lttpr_write_data_pe[3] = 0;\n\n\t\t\tfor (lane = 0; lane < lane_count; lane++) {\n\t\t\t\tvendor_lttpr_write_data_vs[3] |=\n\t\t\t\t\t\tlt_settings->dpcd_lane_settings[lane].bits.VOLTAGE_SWING_SET << (2 * lane);\n\t\t\t\tvendor_lttpr_write_data_pe[3] |=\n\t\t\t\t\t\tlt_settings->dpcd_lane_settings[lane].bits.PRE_EMPHASIS_SET << (2 * lane);\n\t\t\t}\n\n\t\t\t \n\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t&vendor_lttpr_write_data_vs[0], sizeof(vendor_lttpr_write_data_vs));\n\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t&vendor_lttpr_write_data_pe[0], sizeof(vendor_lttpr_write_data_pe));\n\n\t\t\t \n\t\t\tif (!retries_ch_eq)\n\t\t\t\t \n\n\t\t\t\tdpcd_set_lt_pattern_and_lane_settings(\n\t\t\t\t\tlink,\n\t\t\t\t\tlt_settings,\n\t\t\t\t\ttr_pattern, 0);\n\t\t\telse\n\t\t\t\tdpcd_set_lane_settings(link, lt_settings, 0);\n\n\t\t\t \n\t\t\twait_time_microsec = lt_settings->eq_pattern_time;\n\n\t\t\tdp_wait_for_training_aux_rd_interval(\n\t\t\t\t\tlink,\n\t\t\t\t\twait_time_microsec);\n\n\t\t\t \n\t\t\tdp_get_lane_status_and_lane_adjust(\n\t\t\t\tlink,\n\t\t\t\tlt_settings,\n\t\t\t\tdpcd_lane_status,\n\t\t\t\t&dpcd_lane_status_updated,\n\t\t\t\tdpcd_lane_adjust,\n\t\t\t\t0);\n\n\t\t\t \n\t\t\tif (!dp_is_cr_done(lane_count, dpcd_lane_status)) {\n\t\t\t\tstatus = LINK_TRAINING_EQ_FAIL_CR;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t \n\t\t\tif (dp_is_ch_eq_done(lane_count, dpcd_lane_status) &&\n\t\t\t\t\tdp_is_symbol_locked(lane_count, dpcd_lane_status) &&\n\t\t\t\t\tdp_is_interlane_aligned(dpcd_lane_status_updated)) {\n\t\t\t\tstatus = LINK_TRAINING_SUCCESS;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t \n\t\t\tdp_decide_lane_settings(lt_settings, dpcd_lane_adjust,\n\t\t\t\t\tlt_settings->hw_lane_settings, lt_settings->dpcd_lane_settings);\n\t\t}\n\t}\n\n\treturn status;\n}\n\nenum link_training_result dp_perform_fixed_vs_pe_training_sequence(\n\tstruct dc_link *link,\n\tconst struct link_resource *link_res,\n\tstruct link_training_settings *lt_settings)\n{\n\tconst uint8_t vendor_lttpr_write_data_reset[4] = {0x1, 0x50, 0x63, 0xFF};\n\tconst uint8_t offset = dp_parse_lttpr_repeater_count(\n\t\t\tlink->dpcd_caps.lttpr_caps.phy_repeater_cnt);\n\tconst uint8_t vendor_lttpr_write_data_intercept_en[4] = {0x1, 0x55, 0x63, 0x0};\n\tconst uint8_t vendor_lttpr_write_data_intercept_dis[4] = {0x1, 0x55, 0x63, 0x6E};\n\tconst uint8_t vendor_lttpr_write_data_adicora_eq1[4] = {0x1, 0x55, 0x63, 0x2E};\n\tconst uint8_t vendor_lttpr_write_data_adicora_eq2[4] = {0x1, 0x55, 0x63, 0x01};\n\tconst uint8_t vendor_lttpr_write_data_adicora_eq3[4] = {0x1, 0x55, 0x63, 0x68};\n\tuint32_t pre_disable_intercept_delay_ms = 0;\n\tuint8_t vendor_lttpr_write_data_vs[4] = {0x1, 0x51, 0x63, 0x0};\n\tuint8_t vendor_lttpr_write_data_pe[4] = {0x1, 0x52, 0x63, 0x0};\n\tconst uint8_t vendor_lttpr_write_data_4lane_1[4] = {0x1, 0x6E, 0xF2, 0x19};\n\tconst uint8_t vendor_lttpr_write_data_4lane_2[4] = {0x1, 0x6B, 0xF2, 0x01};\n\tconst uint8_t vendor_lttpr_write_data_4lane_3[4] = {0x1, 0x6D, 0xF2, 0x18};\n\tconst uint8_t vendor_lttpr_write_data_4lane_4[4] = {0x1, 0x6C, 0xF2, 0x03};\n\tconst uint8_t vendor_lttpr_write_data_4lane_5[4] = {0x1, 0x03, 0xF3, 0x06};\n\tenum link_training_result status = LINK_TRAINING_SUCCESS;\n\tuint8_t lane = 0;\n\tunion down_spread_ctrl downspread = {0};\n\tunion lane_count_set lane_count_set = {0};\n\tuint8_t toggle_rate;\n\tuint8_t rate;\n\n\t \n\tASSERT(link_dp_get_encoding_format(&lt_settings->link_settings) ==\n\t\t\tDP_8b_10b_ENCODING);\n\n\tif (lt_settings->lttpr_mode == LTTPR_MODE_NON_TRANSPARENT) {\n\t\tstatus = perform_fixed_vs_pe_nontransparent_training_sequence(link, link_res, lt_settings);\n\t\treturn status;\n\t}\n\n\tif (offset != 0xFF) {\n\t\tif (offset == 2) {\n\t\t\tpre_disable_intercept_delay_ms = link->dc->debug.fixed_vs_aux_delay_config_wa;\n\n\t\t \n\t\t} else if (offset > 2) {\n\t\t\tpre_disable_intercept_delay_ms = link->dc->debug.fixed_vs_aux_delay_config_wa * 2;\n\t\t}\n\t}\n\n\t \n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_reset[0], sizeof(vendor_lttpr_write_data_reset));\n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_vs[0], sizeof(vendor_lttpr_write_data_vs));\n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pe[0], sizeof(vendor_lttpr_write_data_pe));\n\n\t \n\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_intercept_en[0], sizeof(vendor_lttpr_write_data_intercept_en));\n\n\t \n\n\tdownspread.raw = (uint8_t)(lt_settings->link_settings.link_spread);\n\n\tlane_count_set.bits.LANE_COUNT_SET =\n\tlt_settings->link_settings.lane_count;\n\n\tlane_count_set.bits.ENHANCED_FRAMING = lt_settings->enhanced_framing;\n\tlane_count_set.bits.POST_LT_ADJ_REQ_GRANTED = 0;\n\n\n\tif (lt_settings->pattern_for_eq < DP_TRAINING_PATTERN_SEQUENCE_4) {\n\t\tlane_count_set.bits.POST_LT_ADJ_REQ_GRANTED =\n\t\t\t\tlink->dpcd_caps.max_ln_count.bits.POST_LT_ADJ_REQ_SUPPORTED;\n\t}\n\n\tcore_link_write_dpcd(link, DP_DOWNSPREAD_CTRL,\n\t\t&downspread.raw, sizeof(downspread));\n\n\tcore_link_write_dpcd(link, DP_LANE_COUNT_SET,\n\t\t&lane_count_set.raw, 1);\n\n\trate = get_dpcd_link_rate(&lt_settings->link_settings);\n\n\t \n\ttoggle_rate = (rate == 0x6) ? 0xA : 0x6;\n\n\tif (link->vendor_specific_lttpr_link_rate_wa == rate || link->vendor_specific_lttpr_link_rate_wa == 0) {\n\t\tcore_link_write_dpcd(\n\t\t\t\tlink,\n\t\t\t\tDP_LINK_BW_SET,\n\t\t\t\t&toggle_rate,\n\t\t\t\t1);\n\t}\n\n\tlink->vendor_specific_lttpr_link_rate_wa = rate;\n\n\tcore_link_write_dpcd(link, DP_LINK_BW_SET, &rate, 1);\n\n\tDC_LOG_HW_LINK_TRAINING(\"%s\\n %x rate = %x\\n %x lane = %x framing = %x\\n %x spread = %x\\n\",\n\t\t__func__,\n\t\tDP_LINK_BW_SET,\n\t\tlt_settings->link_settings.link_rate,\n\t\tDP_LANE_COUNT_SET,\n\t\tlt_settings->link_settings.lane_count,\n\t\tlt_settings->enhanced_framing,\n\t\tDP_DOWNSPREAD_CTRL,\n\t\tlt_settings->link_settings.link_spread);\n\n\tif (lt_settings->link_settings.lane_count == LANE_COUNT_FOUR) {\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_1[0], sizeof(vendor_lttpr_write_data_4lane_1));\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_2[0], sizeof(vendor_lttpr_write_data_4lane_2));\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_3[0], sizeof(vendor_lttpr_write_data_4lane_3));\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_4[0], sizeof(vendor_lttpr_write_data_4lane_4));\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_4lane_5[0], sizeof(vendor_lttpr_write_data_4lane_5));\n\t}\n\n\t \n\n\t \n\tif (status == LINK_TRAINING_SUCCESS) {\n\t\tconst uint8_t max_vendor_dpcd_retries = 10;\n\t\tuint32_t retries_cr;\n\t\tuint32_t retry_count;\n\t\tuint32_t wait_time_microsec;\n\t\tenum dc_lane_count lane_count = lt_settings->link_settings.lane_count;\n\t\tunion lane_status dpcd_lane_status[LANE_COUNT_DP_MAX];\n\t\tunion lane_align_status_updated dpcd_lane_status_updated;\n\t\tunion lane_adjust dpcd_lane_adjust[LANE_COUNT_DP_MAX] = {0};\n\t\tuint8_t i = 0;\n\n\t\tretries_cr = 0;\n\t\tretry_count = 0;\n\n\t\tmemset(&dpcd_lane_status, '\\0', sizeof(dpcd_lane_status));\n\t\tmemset(&dpcd_lane_status_updated, '\\0',\n\t\tsizeof(dpcd_lane_status_updated));\n\n\t\twhile ((retries_cr < LINK_TRAINING_MAX_RETRY_COUNT) &&\n\t\t\t(retry_count < LINK_TRAINING_MAX_CR_RETRY)) {\n\n\n\t\t\t \n\t\t\tdp_set_hw_lane_settings(\n\t\t\t\t\tlink,\n\t\t\t\t\tlink_res,\n\t\t\t\t\tlt_settings,\n\t\t\t\t\t0);\n\n\t\t\t \n\t\t\tif (!retry_count) {\n\t\t\t\t \n\t\t\t\tdpcd_set_lt_pattern_and_lane_settings(\n\t\t\t\t\t\tlink,\n\t\t\t\t\t\tlt_settings,\n\t\t\t\t\t\tlt_settings->pattern_for_cr,\n\t\t\t\t\t\t0);\n\t\t\t\t \n\t\t\t\tfor (i = 0; i < max_vendor_dpcd_retries; i++) {\n\t\t\t\t\tif (pre_disable_intercept_delay_ms != 0)\n\t\t\t\t\t\tmsleep(pre_disable_intercept_delay_ms);\n\t\t\t\t\tif (link_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t\t\t&vendor_lttpr_write_data_intercept_dis[0],\n\t\t\t\t\t\t\tsizeof(vendor_lttpr_write_data_intercept_dis)))\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t\t\t&vendor_lttpr_write_data_intercept_en[0],\n\t\t\t\t\t\t\tsizeof(vendor_lttpr_write_data_intercept_en));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tvendor_lttpr_write_data_vs[3] = 0;\n\t\t\t\tvendor_lttpr_write_data_pe[3] = 0;\n\n\t\t\t\tfor (lane = 0; lane < lane_count; lane++) {\n\t\t\t\t\tvendor_lttpr_write_data_vs[3] |=\n\t\t\t\t\t\t\tlt_settings->dpcd_lane_settings[lane].bits.VOLTAGE_SWING_SET << (2 * lane);\n\t\t\t\t\tvendor_lttpr_write_data_pe[3] |=\n\t\t\t\t\t\t\tlt_settings->dpcd_lane_settings[lane].bits.PRE_EMPHASIS_SET << (2 * lane);\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t\t&vendor_lttpr_write_data_vs[0], sizeof(vendor_lttpr_write_data_vs));\n\t\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t\t&vendor_lttpr_write_data_pe[0], sizeof(vendor_lttpr_write_data_pe));\n\n\t\t\t\tdpcd_set_lane_settings(\n\t\t\t\t\t\tlink,\n\t\t\t\t\t\tlt_settings,\n\t\t\t\t\t\t0);\n\t\t\t}\n\n\t\t\t \n\t\t\twait_time_microsec = lt_settings->cr_pattern_time;\n\n\t\t\tdp_wait_for_training_aux_rd_interval(\n\t\t\t\t\tlink,\n\t\t\t\t\twait_time_microsec);\n\n\t\t\t \n\t\t\tdp_get_lane_status_and_lane_adjust(\n\t\t\t\t\tlink,\n\t\t\t\t\tlt_settings,\n\t\t\t\t\tdpcd_lane_status,\n\t\t\t\t\t&dpcd_lane_status_updated,\n\t\t\t\t\tdpcd_lane_adjust,\n\t\t\t\t\t0);\n\n\t\t\t \n\t\t\tif (dp_is_cr_done(lane_count, dpcd_lane_status)) {\n\t\t\t\tstatus = LINK_TRAINING_SUCCESS;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t \n\t\t\tif (dp_is_max_vs_reached(lt_settings))\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\t \n\t\t\tif (lt_settings->dpcd_lane_settings[0].bits.VOLTAGE_SWING_SET ==\n\t\t\t\t\tdpcd_lane_adjust[0].bits.VOLTAGE_SWING_LANE)\n\t\t\t\tretries_cr++;\n\t\t\telse\n\t\t\t\tretries_cr = 0;\n\n\t\t\t \n\t\t\tdp_decide_lane_settings(lt_settings, dpcd_lane_adjust,\n\t\t\t\t\tlt_settings->hw_lane_settings, lt_settings->dpcd_lane_settings);\n\t\t\tretry_count++;\n\t\t}\n\n\t\tif (retry_count >= LINK_TRAINING_MAX_CR_RETRY) {\n\t\t\tASSERT(0);\n\t\t\tDC_LOG_ERROR(\"%s: Link Training Error, could not get CR after %d tries. Possibly voltage swing issue\",\n\t\t\t\t__func__,\n\t\t\t\tLINK_TRAINING_MAX_CR_RETRY);\n\n\t\t}\n\n\t\tstatus = dp_get_cr_failure(lane_count, dpcd_lane_status);\n\t}\n\n\t \n\tif (status == LINK_TRAINING_SUCCESS) {\n\t\tenum dc_dp_training_pattern tr_pattern;\n\t\tuint32_t retries_ch_eq;\n\t\tuint32_t wait_time_microsec;\n\t\tenum dc_lane_count lane_count = lt_settings->link_settings.lane_count;\n\t\tunion lane_align_status_updated dpcd_lane_status_updated = {0};\n\t\tunion lane_status dpcd_lane_status[LANE_COUNT_DP_MAX] = {0};\n\t\tunion lane_adjust dpcd_lane_adjust[LANE_COUNT_DP_MAX] = {0};\n\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_adicora_eq1[0],\n\t\t\t\tsizeof(vendor_lttpr_write_data_adicora_eq1));\n\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_adicora_eq2[0],\n\t\t\t\tsizeof(vendor_lttpr_write_data_adicora_eq2));\n\n\n\t\t \n\t\ttr_pattern = lt_settings->pattern_for_eq;\n\n\t\tdp_set_hw_training_pattern(link, link_res, tr_pattern, 0);\n\n\t\tstatus = LINK_TRAINING_EQ_FAIL_EQ;\n\n\t\tfor (retries_ch_eq = 0; retries_ch_eq <= LINK_TRAINING_MAX_RETRY_COUNT;\n\t\t\tretries_ch_eq++) {\n\n\t\t\tdp_set_hw_lane_settings(link, link_res, lt_settings, 0);\n\n\t\t\tvendor_lttpr_write_data_vs[3] = 0;\n\t\t\tvendor_lttpr_write_data_pe[3] = 0;\n\n\t\t\tfor (lane = 0; lane < lane_count; lane++) {\n\t\t\t\tvendor_lttpr_write_data_vs[3] |=\n\t\t\t\t\t\tlt_settings->dpcd_lane_settings[lane].bits.VOLTAGE_SWING_SET << (2 * lane);\n\t\t\t\tvendor_lttpr_write_data_pe[3] |=\n\t\t\t\t\t\tlt_settings->dpcd_lane_settings[lane].bits.PRE_EMPHASIS_SET << (2 * lane);\n\t\t\t}\n\n\t\t\t \n\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t&vendor_lttpr_write_data_vs[0], sizeof(vendor_lttpr_write_data_vs));\n\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t&vendor_lttpr_write_data_pe[0], sizeof(vendor_lttpr_write_data_pe));\n\n\t\t\t \n\t\t\tif (!retries_ch_eq) {\n\t\t\t\t \n\n\t\t\t\tdpcd_set_lt_pattern_and_lane_settings(\n\t\t\t\t\tlink,\n\t\t\t\t\tlt_settings,\n\t\t\t\t\ttr_pattern, 0);\n\n\t\t\t\tlink_configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t\t&vendor_lttpr_write_data_adicora_eq3[0],\n\t\t\t\t\t\tsizeof(vendor_lttpr_write_data_adicora_eq3));\n\n\t\t\t} else\n\t\t\t\tdpcd_set_lane_settings(link, lt_settings, 0);\n\n\t\t\t \n\t\t\twait_time_microsec = lt_settings->eq_pattern_time;\n\n\t\t\tdp_wait_for_training_aux_rd_interval(\n\t\t\t\t\tlink,\n\t\t\t\t\twait_time_microsec);\n\n\t\t\t \n\t\t\tdp_get_lane_status_and_lane_adjust(\n\t\t\t\tlink,\n\t\t\t\tlt_settings,\n\t\t\t\tdpcd_lane_status,\n\t\t\t\t&dpcd_lane_status_updated,\n\t\t\t\tdpcd_lane_adjust,\n\t\t\t\t0);\n\n\t\t\t \n\t\t\tif (!dp_is_cr_done(lane_count, dpcd_lane_status)) {\n\t\t\t\tstatus = LINK_TRAINING_EQ_FAIL_CR;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t \n\t\t\tif (dp_is_ch_eq_done(lane_count, dpcd_lane_status) &&\n\t\t\t\t\tdp_is_symbol_locked(lane_count, dpcd_lane_status) &&\n\t\t\t\t\tdp_is_interlane_aligned(dpcd_lane_status_updated)) {\n\t\t\t\tstatus = LINK_TRAINING_SUCCESS;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t \n\t\t\tdp_decide_lane_settings(lt_settings, dpcd_lane_adjust,\n\t\t\t\t\tlt_settings->hw_lane_settings, lt_settings->dpcd_lane_settings);\n\t\t}\n\t}\n\n\treturn status;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}