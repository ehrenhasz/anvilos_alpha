{
  "module_name": "bw_fixed.c",
  "hash_id": "9f4897440782e3cb60343219f373e32bc741662d269c6db69d9e9987319becf8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/calcs/bw_fixed.c",
  "human_readable_source": " \n#include \"dm_services.h\"\n#include \"bw_fixed.h\"\n\n#define MAX_I64 \\\n\t((int64_t)((1ULL << 63) - 1))\n\n#define MIN_I64 \\\n\t(-MAX_I64 - 1)\n\n#define FRACTIONAL_PART_MASK \\\n\t((1ULL << BW_FIXED_BITS_PER_FRACTIONAL_PART) - 1)\n\n#define GET_FRACTIONAL_PART(x) \\\n\t(FRACTIONAL_PART_MASK & (x))\n\nstatic uint64_t abs_i64(int64_t arg)\n{\n\tif (arg >= 0)\n\t\treturn (uint64_t)(arg);\n\telse\n\t\treturn (uint64_t)(-arg);\n}\n\nstruct bw_fixed bw_int_to_fixed_nonconst(int64_t value)\n{\n\tstruct bw_fixed res;\n\n\tASSERT(value < BW_FIXED_MAX_I32 && value > BW_FIXED_MIN_I32);\n\tres.value = value << BW_FIXED_BITS_PER_FRACTIONAL_PART;\n\treturn res;\n}\n\nstruct bw_fixed bw_frc_to_fixed(int64_t numerator, int64_t denominator)\n{\n\tstruct bw_fixed res;\n\tbool arg1_negative = numerator < 0;\n\tbool arg2_negative = denominator < 0;\n\tuint64_t arg1_value;\n\tuint64_t arg2_value;\n\tuint64_t remainder;\n\n\t \n\tuint64_t res_value;\n\n\tASSERT(denominator != 0);\n\n\targ1_value = abs_i64(numerator);\n\targ2_value = abs_i64(denominator);\n\tres_value = div64_u64_rem(arg1_value, arg2_value, &remainder);\n\n\tASSERT(res_value <= BW_FIXED_MAX_I32);\n\n\t \n\t{\n\t\tuint32_t i = BW_FIXED_BITS_PER_FRACTIONAL_PART;\n\n\t\tdo {\n\t\t\tremainder <<= 1;\n\n\t\t\tres_value <<= 1;\n\n\t\t\tif (remainder >= arg2_value) {\n\t\t\t\tres_value |= 1;\n\t\t\t\tremainder -= arg2_value;\n\t\t\t}\n\t\t} while (--i != 0);\n\t}\n\n\t \n\t{\n\t\tuint64_t summand = (remainder << 1) >= arg2_value;\n\n\t\tASSERT(res_value <= MAX_I64 - summand);\n\n\t\tres_value += summand;\n\t}\n\n\tres.value = (int64_t)(res_value);\n\n\tif (arg1_negative ^ arg2_negative)\n\t\tres.value = -res.value;\n\treturn res;\n}\n\nstruct bw_fixed bw_floor2(\n\tconst struct bw_fixed arg,\n\tconst struct bw_fixed significance)\n{\n\tstruct bw_fixed result;\n\tint64_t multiplicand;\n\n\tmultiplicand = div64_s64(arg.value, abs_i64(significance.value));\n\tresult.value = abs_i64(significance.value) * multiplicand;\n\tASSERT(abs_i64(result.value) <= abs_i64(arg.value));\n\treturn result;\n}\n\nstruct bw_fixed bw_ceil2(\n\tconst struct bw_fixed arg,\n\tconst struct bw_fixed significance)\n{\n\tstruct bw_fixed result;\n\tint64_t multiplicand;\n\n\tmultiplicand = div64_s64(arg.value, abs_i64(significance.value));\n\tresult.value = abs_i64(significance.value) * multiplicand;\n\tif (abs_i64(result.value) < abs_i64(arg.value)) {\n\t\tif (arg.value < 0)\n\t\t\tresult.value -= abs_i64(significance.value);\n\t\telse\n\t\t\tresult.value += abs_i64(significance.value);\n\t}\n\treturn result;\n}\n\nstruct bw_fixed bw_mul(const struct bw_fixed arg1, const struct bw_fixed arg2)\n{\n\tstruct bw_fixed res;\n\n\tbool arg1_negative = arg1.value < 0;\n\tbool arg2_negative = arg2.value < 0;\n\n\tuint64_t arg1_value = abs_i64(arg1.value);\n\tuint64_t arg2_value = abs_i64(arg2.value);\n\n\tuint64_t arg1_int = BW_FIXED_GET_INTEGER_PART(arg1_value);\n\tuint64_t arg2_int = BW_FIXED_GET_INTEGER_PART(arg2_value);\n\n\tuint64_t arg1_fra = GET_FRACTIONAL_PART(arg1_value);\n\tuint64_t arg2_fra = GET_FRACTIONAL_PART(arg2_value);\n\n\tuint64_t tmp;\n\n\tres.value = arg1_int * arg2_int;\n\n\tASSERT(res.value <= BW_FIXED_MAX_I32);\n\n\tres.value <<= BW_FIXED_BITS_PER_FRACTIONAL_PART;\n\n\ttmp = arg1_int * arg2_fra;\n\n\tASSERT(tmp <= (uint64_t)(MAX_I64 - res.value));\n\n\tres.value += tmp;\n\n\ttmp = arg2_int * arg1_fra;\n\n\tASSERT(tmp <= (uint64_t)(MAX_I64 - res.value));\n\n\tres.value += tmp;\n\n\ttmp = arg1_fra * arg2_fra;\n\n\ttmp = (tmp >> BW_FIXED_BITS_PER_FRACTIONAL_PART) +\n\t\t(tmp >= (uint64_t)(bw_frc_to_fixed(1, 2).value));\n\n\tASSERT(tmp <= (uint64_t)(MAX_I64 - res.value));\n\n\tres.value += tmp;\n\n\tif (arg1_negative ^ arg2_negative)\n\t\tres.value = -res.value;\n\treturn res;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}