{
  "module_name": "dcn31_dccg.c",
  "hash_id": "52da865dcaf38647f3640160eca585fdedba2da753e66fbfce9323def0339642",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn31/dcn31_dccg.c",
  "human_readable_source": " \n\n#include \"reg_helper.h\"\n#include \"core_types.h\"\n#include \"dcn31_dccg.h\"\n#include \"dal_asic_id.h\"\n\n#define TO_DCN_DCCG(dccg)\\\n\tcontainer_of(dccg, struct dcn_dccg, base)\n\n#define REG(reg) \\\n\t(dccg_dcn->regs->reg)\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\tdccg_dcn->dccg_shift->field_name, dccg_dcn->dccg_mask->field_name\n\n#define CTX \\\n\tdccg_dcn->base.ctx\n#define DC_LOGGER \\\n\tdccg->ctx->logger\n\nvoid dccg31_update_dpp_dto(struct dccg *dccg, int dpp_inst, int req_dppclk)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tif (dccg->dpp_clock_gated[dpp_inst]) {\n\t\t \n\t\treturn;\n\t}\n\n\tif (dccg->ref_dppclk && req_dppclk) {\n\t\tint ref_dppclk = dccg->ref_dppclk;\n\t\tint modulo, phase;\n\n\t\t\n\t\tmodulo = 0xff;   \n\t\tphase = ((modulo * req_dppclk) + ref_dppclk - 1) / ref_dppclk;\n\n\t\tif (phase > 0xff) {\n\t\t\tASSERT(false);\n\t\t\tphase = 0xff;\n\t\t}\n\n\t\tREG_SET_2(DPPCLK_DTO_PARAM[dpp_inst], 0,\n\t\t\t\tDPPCLK0_DTO_PHASE, phase,\n\t\t\t\tDPPCLK0_DTO_MODULO, modulo);\n\t\tREG_UPDATE(DPPCLK_DTO_CTRL,\n\t\t\t\tDPPCLK_DTO_ENABLE[dpp_inst], 1);\n\t} else {\n\t\tREG_UPDATE(DPPCLK_DTO_CTRL,\n\t\t\t\tDPPCLK_DTO_ENABLE[dpp_inst], 0);\n\t}\n\tdccg->pipe_dppclk_khz[dpp_inst] = req_dppclk;\n}\n\nstatic enum phyd32clk_clock_source get_phy_mux_symclk(\n\t\tstruct dcn_dccg *dccg_dcn,\n\t\tenum phyd32clk_clock_source src)\n{\n\tif (dccg_dcn->base.ctx->asic_id.chip_family == FAMILY_YELLOW_CARP &&\n\t\t\tdccg_dcn->base.ctx->asic_id.hw_internal_rev == YELLOW_CARP_B0) {\n\t\tif (src == PHYD32CLKC)\n\t\t\tsrc = PHYD32CLKF;\n\t\tif (src == PHYD32CLKD)\n\t\t\tsrc = PHYD32CLKG;\n\t}\n\treturn src;\n}\n\nstatic void dccg31_enable_dpstreamclk(struct dccg *dccg, int otg_inst)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\t \n\tswitch (otg_inst) {\n\tcase 0:\n\t\tREG_UPDATE(DPSTREAMCLK_CNTL,\n\t\t\t\tDPSTREAMCLK_PIPE0_EN, 1);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE(DPSTREAMCLK_CNTL,\n\t\t\t\tDPSTREAMCLK_PIPE1_EN, 1);\n\t\tbreak;\n\tcase 2:\n\t\tREG_UPDATE(DPSTREAMCLK_CNTL,\n\t\t\t\tDPSTREAMCLK_PIPE2_EN, 1);\n\t\tbreak;\n\tcase 3:\n\t\tREG_UPDATE(DPSTREAMCLK_CNTL,\n\t\t\t\tDPSTREAMCLK_PIPE3_EN, 1);\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.dpstream)\n\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\tDPSTREAMCLK_GATE_DISABLE, 1,\n\t\t\tDPSTREAMCLK_ROOT_GATE_DISABLE, 1);\n}\n\nstatic void dccg31_disable_dpstreamclk(struct dccg *dccg, int otg_inst)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.dpstream)\n\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\tDPSTREAMCLK_ROOT_GATE_DISABLE, 0,\n\t\t\t\tDPSTREAMCLK_GATE_DISABLE, 0);\n\n\tswitch (otg_inst) {\n\tcase 0:\n\t\tREG_UPDATE(DPSTREAMCLK_CNTL,\n\t\t\t\tDPSTREAMCLK_PIPE0_EN, 0);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE(DPSTREAMCLK_CNTL,\n\t\t\t\tDPSTREAMCLK_PIPE1_EN, 0);\n\t\tbreak;\n\tcase 2:\n\t\tREG_UPDATE(DPSTREAMCLK_CNTL,\n\t\t\t\tDPSTREAMCLK_PIPE2_EN, 0);\n\t\tbreak;\n\tcase 3:\n\t\tREG_UPDATE(DPSTREAMCLK_CNTL,\n\t\t\t\tDPSTREAMCLK_PIPE3_EN, 0);\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n}\n\nvoid dccg31_set_dpstreamclk(\n\t\tstruct dccg *dccg,\n\t\tenum streamclk_source src,\n\t\tint otg_inst,\n\t\tint dp_hpo_inst)\n{\n\tif (src == REFCLK)\n\t\tdccg31_disable_dpstreamclk(dccg, otg_inst);\n\telse\n\t\tdccg31_enable_dpstreamclk(dccg, otg_inst);\n}\n\nvoid dccg31_enable_symclk32_se(\n\t\tstruct dccg *dccg,\n\t\tint hpo_se_inst,\n\t\tenum phyd32clk_clock_source phyd32clk)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tphyd32clk = get_phy_mux_symclk(dccg_dcn, phyd32clk);\n\n\t \n\tswitch (hpo_se_inst) {\n\tcase 0:\n\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.symclk32_se)\n\t\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\t\tSYMCLK32_SE0_GATE_DISABLE, 1,\n\t\t\t\t\tSYMCLK32_ROOT_SE0_GATE_DISABLE, 1);\n\t\tREG_UPDATE_2(SYMCLK32_SE_CNTL,\n\t\t\t\tSYMCLK32_SE0_SRC_SEL, phyd32clk,\n\t\t\t\tSYMCLK32_SE0_EN, 1);\n\t\tbreak;\n\tcase 1:\n\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.symclk32_se)\n\t\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\t\tSYMCLK32_SE1_GATE_DISABLE, 1,\n\t\t\t\t\tSYMCLK32_ROOT_SE1_GATE_DISABLE, 1);\n\t\tREG_UPDATE_2(SYMCLK32_SE_CNTL,\n\t\t\t\tSYMCLK32_SE1_SRC_SEL, phyd32clk,\n\t\t\t\tSYMCLK32_SE1_EN, 1);\n\t\tbreak;\n\tcase 2:\n\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.symclk32_se)\n\t\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\t\tSYMCLK32_SE2_GATE_DISABLE, 1,\n\t\t\t\t\tSYMCLK32_ROOT_SE2_GATE_DISABLE, 1);\n\t\tREG_UPDATE_2(SYMCLK32_SE_CNTL,\n\t\t\t\tSYMCLK32_SE2_SRC_SEL, phyd32clk,\n\t\t\t\tSYMCLK32_SE2_EN, 1);\n\t\tbreak;\n\tcase 3:\n\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.symclk32_se)\n\t\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\t\tSYMCLK32_SE3_GATE_DISABLE, 1,\n\t\t\t\t\tSYMCLK32_ROOT_SE3_GATE_DISABLE, 1);\n\t\tREG_UPDATE_2(SYMCLK32_SE_CNTL,\n\t\t\t\tSYMCLK32_SE3_SRC_SEL, phyd32clk,\n\t\t\t\tSYMCLK32_SE3_EN, 1);\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n}\n\nvoid dccg31_disable_symclk32_se(\n\t\tstruct dccg *dccg,\n\t\tint hpo_se_inst)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\t \n\tswitch (hpo_se_inst) {\n\tcase 0:\n\t\tREG_UPDATE_2(SYMCLK32_SE_CNTL,\n\t\t\t\tSYMCLK32_SE0_SRC_SEL, 0,\n\t\t\t\tSYMCLK32_SE0_EN, 0);\n\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.symclk32_se)\n\t\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\t\tSYMCLK32_SE0_GATE_DISABLE, 0,\n\t\t\t\t\tSYMCLK32_ROOT_SE0_GATE_DISABLE, 0);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE_2(SYMCLK32_SE_CNTL,\n\t\t\t\tSYMCLK32_SE1_SRC_SEL, 0,\n\t\t\t\tSYMCLK32_SE1_EN, 0);\n\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.symclk32_se)\n\t\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\t\tSYMCLK32_SE1_GATE_DISABLE, 0,\n\t\t\t\t\tSYMCLK32_ROOT_SE1_GATE_DISABLE, 0);\n\t\tbreak;\n\tcase 2:\n\t\tREG_UPDATE_2(SYMCLK32_SE_CNTL,\n\t\t\t\tSYMCLK32_SE2_SRC_SEL, 0,\n\t\t\t\tSYMCLK32_SE2_EN, 0);\n\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.symclk32_se)\n\t\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\t\tSYMCLK32_SE2_GATE_DISABLE, 0,\n\t\t\t\t\tSYMCLK32_ROOT_SE2_GATE_DISABLE, 0);\n\t\tbreak;\n\tcase 3:\n\t\tREG_UPDATE_2(SYMCLK32_SE_CNTL,\n\t\t\t\tSYMCLK32_SE3_SRC_SEL, 0,\n\t\t\t\tSYMCLK32_SE3_EN, 0);\n\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.symclk32_se)\n\t\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\t\tSYMCLK32_SE3_GATE_DISABLE, 0,\n\t\t\t\t\tSYMCLK32_ROOT_SE3_GATE_DISABLE, 0);\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n}\n\nvoid dccg31_enable_symclk32_le(\n\t\tstruct dccg *dccg,\n\t\tint hpo_le_inst,\n\t\tenum phyd32clk_clock_source phyd32clk)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tphyd32clk = get_phy_mux_symclk(dccg_dcn, phyd32clk);\n\n\t \n\tswitch (hpo_le_inst) {\n\tcase 0:\n\t\tREG_UPDATE_2(SYMCLK32_LE_CNTL,\n\t\t\t\tSYMCLK32_LE0_SRC_SEL, phyd32clk,\n\t\t\t\tSYMCLK32_LE0_EN, 1);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE_2(SYMCLK32_LE_CNTL,\n\t\t\t\tSYMCLK32_LE1_SRC_SEL, phyd32clk,\n\t\t\t\tSYMCLK32_LE1_EN, 1);\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n}\n\nvoid dccg31_disable_symclk32_le(\n\t\tstruct dccg *dccg,\n\t\tint hpo_le_inst)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\t \n\tswitch (hpo_le_inst) {\n\tcase 0:\n\t\tREG_UPDATE_2(SYMCLK32_LE_CNTL,\n\t\t\t\tSYMCLK32_LE0_SRC_SEL, 0,\n\t\t\t\tSYMCLK32_LE0_EN, 0);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE_2(SYMCLK32_LE_CNTL,\n\t\t\t\tSYMCLK32_LE1_SRC_SEL, 0,\n\t\t\t\tSYMCLK32_LE1_EN, 0);\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n}\n\nvoid dccg31_set_symclk32_le_root_clock_gating(\n\t\tstruct dccg *dccg,\n\t\tint hpo_le_inst,\n\t\tbool enable)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tif (!dccg->ctx->dc->debug.root_clock_optimization.bits.symclk32_le)\n\t\treturn;\n\n\tswitch (hpo_le_inst) {\n\tcase 0:\n\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\tSYMCLK32_LE0_GATE_DISABLE, enable ? 1 : 0,\n\t\t\t\tSYMCLK32_ROOT_LE0_GATE_DISABLE, enable ? 1 : 0);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE_2(DCCG_GATE_DISABLE_CNTL3,\n\t\t\t\tSYMCLK32_LE1_GATE_DISABLE, enable ? 1 : 0,\n\t\t\t\tSYMCLK32_ROOT_LE1_GATE_DISABLE, enable ? 1 : 0);\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n}\n\nvoid dccg31_disable_dscclk(struct dccg *dccg, int inst)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tif (!dccg->ctx->dc->debug.root_clock_optimization.bits.dsc)\n\t\treturn;\n\t\n\tswitch (inst) {\n\tcase 0:\n\t\tREG_UPDATE(DSCCLK_DTO_CTRL,\n\t\t\t\tDSCCLK0_DTO_ENABLE, 1);\n\t\tREG_UPDATE_2(DSCCLK0_DTO_PARAM,\n\t\t\t\tDSCCLK0_DTO_PHASE, 0,\n\t\t\t\tDSCCLK0_DTO_MODULO, 1);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE(DSCCLK_DTO_CTRL,\n\t\t\t\tDSCCLK1_DTO_ENABLE, 1);\n\t\tREG_UPDATE_2(DSCCLK1_DTO_PARAM,\n\t\t\t\tDSCCLK1_DTO_PHASE, 0,\n\t\t\t\tDSCCLK1_DTO_MODULO, 1);\n\t\tbreak;\n\tcase 2:\n\t\tREG_UPDATE(DSCCLK_DTO_CTRL,\n\t\t\t\tDSCCLK2_DTO_ENABLE, 1);\n\t\tREG_UPDATE_2(DSCCLK2_DTO_PARAM,\n\t\t\t\tDSCCLK2_DTO_PHASE, 0,\n\t\t\t\tDSCCLK2_DTO_MODULO, 1);\n\t\tbreak;\n\tcase 3:\n\t\tif (REG(DSCCLK3_DTO_PARAM)) {\n\t\t\tREG_UPDATE(DSCCLK_DTO_CTRL,\n\t\t\t\t\tDSCCLK3_DTO_ENABLE, 1);\n\t\t\tREG_UPDATE_2(DSCCLK3_DTO_PARAM,\n\t\t\t\t\tDSCCLK3_DTO_PHASE, 0,\n\t\t\t\t\tDSCCLK3_DTO_MODULO, 1);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n}\n\nvoid dccg31_enable_dscclk(struct dccg *dccg, int inst)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tif (!dccg->ctx->dc->debug.root_clock_optimization.bits.dsc)\n\t\treturn;\n\t\n\tswitch (inst) {\n\tcase 0:\n\t\tREG_UPDATE_2(DSCCLK0_DTO_PARAM,\n\t\t\t\tDSCCLK0_DTO_PHASE, 0,\n\t\t\t\tDSCCLK0_DTO_MODULO, 0);\n\t\tREG_UPDATE(DSCCLK_DTO_CTRL,\n\t\t\t\tDSCCLK0_DTO_ENABLE, 0);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE_2(DSCCLK1_DTO_PARAM,\n\t\t\t\tDSCCLK1_DTO_PHASE, 0,\n\t\t\t\tDSCCLK1_DTO_MODULO, 0);\n\t\tREG_UPDATE(DSCCLK_DTO_CTRL,\n\t\t\t\tDSCCLK1_DTO_ENABLE, 0);\n\t\tbreak;\n\tcase 2:\n\t\tREG_UPDATE_2(DSCCLK2_DTO_PARAM,\n\t\t\t\tDSCCLK2_DTO_PHASE, 0,\n\t\t\t\tDSCCLK2_DTO_MODULO, 0);\n\t\tREG_UPDATE(DSCCLK_DTO_CTRL,\n\t\t\t\tDSCCLK2_DTO_ENABLE, 0);\n\t\tbreak;\n\tcase 3:\n\t\tif (REG(DSCCLK3_DTO_PARAM)) {\n\t\t\tREG_UPDATE(DSCCLK_DTO_CTRL,\n\t\t\t\t\tDSCCLK3_DTO_ENABLE, 0);\n\t\t\tREG_UPDATE_2(DSCCLK3_DTO_PARAM,\n\t\t\t\t\tDSCCLK3_DTO_PHASE, 0,\n\t\t\t\t\tDSCCLK3_DTO_MODULO, 0);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n}\n\nvoid dccg31_set_physymclk(\n\t\tstruct dccg *dccg,\n\t\tint phy_inst,\n\t\tenum physymclk_clock_source clk_src,\n\t\tbool force_enable)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\t \n\tswitch (phy_inst) {\n\tcase 0:\n\t\tif (force_enable) {\n\t\t\tREG_UPDATE_2(PHYASYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYASYMCLK_FORCE_EN, 1,\n\t\t\t\t\tPHYASYMCLK_FORCE_SRC_SEL, clk_src);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYASYMCLK_GATE_DISABLE, 1);\n\t\t} else {\n\t\t\tREG_UPDATE_2(PHYASYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYASYMCLK_FORCE_EN, 0,\n\t\t\t\t\tPHYASYMCLK_FORCE_SRC_SEL, 0);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYASYMCLK_GATE_DISABLE, 0);\n\t\t}\n\t\tbreak;\n\tcase 1:\n\t\tif (force_enable) {\n\t\t\tREG_UPDATE_2(PHYBSYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYBSYMCLK_FORCE_EN, 1,\n\t\t\t\t\tPHYBSYMCLK_FORCE_SRC_SEL, clk_src);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYBSYMCLK_GATE_DISABLE, 1);\n\t\t} else {\n\t\t\tREG_UPDATE_2(PHYBSYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYBSYMCLK_FORCE_EN, 0,\n\t\t\t\t\tPHYBSYMCLK_FORCE_SRC_SEL, 0);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYBSYMCLK_GATE_DISABLE, 0);\n\t\t}\n\t\tbreak;\n\tcase 2:\n\t\tif (force_enable) {\n\t\t\tREG_UPDATE_2(PHYCSYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYCSYMCLK_FORCE_EN, 1,\n\t\t\t\t\tPHYCSYMCLK_FORCE_SRC_SEL, clk_src);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYCSYMCLK_GATE_DISABLE, 1);\n\t\t} else {\n\t\t\tREG_UPDATE_2(PHYCSYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYCSYMCLK_FORCE_EN, 0,\n\t\t\t\t\tPHYCSYMCLK_FORCE_SRC_SEL, 0);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYCSYMCLK_GATE_DISABLE, 0);\n\t\t}\n\t\tbreak;\n\tcase 3:\n\t\tif (force_enable) {\n\t\t\tREG_UPDATE_2(PHYDSYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYDSYMCLK_FORCE_EN, 1,\n\t\t\t\t\tPHYDSYMCLK_FORCE_SRC_SEL, clk_src);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYDSYMCLK_GATE_DISABLE, 1);\n\t\t} else {\n\t\t\tREG_UPDATE_2(PHYDSYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYDSYMCLK_FORCE_EN, 0,\n\t\t\t\t\tPHYDSYMCLK_FORCE_SRC_SEL, 0);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYDSYMCLK_GATE_DISABLE, 0);\n\t\t}\n\t\tbreak;\n\tcase 4:\n\t\tif (force_enable) {\n\t\t\tREG_UPDATE_2(PHYESYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYESYMCLK_FORCE_EN, 1,\n\t\t\t\t\tPHYESYMCLK_FORCE_SRC_SEL, clk_src);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYESYMCLK_GATE_DISABLE, 1);\n\t\t} else {\n\t\t\tREG_UPDATE_2(PHYESYMCLK_CLOCK_CNTL,\n\t\t\t\t\tPHYESYMCLK_FORCE_EN, 0,\n\t\t\t\t\tPHYESYMCLK_FORCE_SRC_SEL, 0);\n\t\t\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk)\n\t\t\t\tREG_UPDATE(DCCG_GATE_DISABLE_CNTL2,\n\t\t\t\t\tPHYESYMCLK_GATE_DISABLE, 0);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn;\n\t}\n}\n\n \nvoid dccg31_set_dtbclk_dto(\n\t\tstruct dccg *dccg,\n\t\tconst struct dtbclk_dto_params *params)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\tint req_dtbclk_khz = params->pixclk_khz;\n\tuint32_t dtbdto_div;\n\n\t \n\tif (params->num_odm_segments == 4) {\n\t\tdtbdto_div = 2;\n\t\treq_dtbclk_khz = params->pixclk_khz / 4;\n\t} else if ((params->num_odm_segments == 2) ||\n\t\t\t(params->timing->pixel_encoding == PIXEL_ENCODING_YCBCR420) ||\n\t\t\t(params->timing->flags.DSC && params->timing->pixel_encoding == PIXEL_ENCODING_YCBCR422\n\t\t\t\t\t&& !params->timing->dsc_cfg.ycbcr422_simple)) {\n\t\tdtbdto_div = 4;\n\t\treq_dtbclk_khz = params->pixclk_khz / 2;\n\t} else\n\t\tdtbdto_div = 8;\n\n\tif (params->ref_dtbclk_khz && req_dtbclk_khz) {\n\t\tuint32_t modulo, phase;\n\n\t\t\n\t\tmodulo = params->ref_dtbclk_khz * 1000;\n\t\tphase = div_u64((((unsigned long long)modulo * req_dtbclk_khz) + params->ref_dtbclk_khz - 1),\n\t\t\t\tparams->ref_dtbclk_khz);\n\n\t\tREG_UPDATE(OTG_PIXEL_RATE_CNTL[params->otg_inst],\n\t\t\t\tDTBCLK_DTO_DIV[params->otg_inst], dtbdto_div);\n\n\t\tREG_WRITE(DTBCLK_DTO_MODULO[params->otg_inst], modulo);\n\t\tREG_WRITE(DTBCLK_DTO_PHASE[params->otg_inst], phase);\n\n\t\tREG_UPDATE(OTG_PIXEL_RATE_CNTL[params->otg_inst],\n\t\t\t\tDTBCLK_DTO_ENABLE[params->otg_inst], 1);\n\n\t\tREG_WAIT(OTG_PIXEL_RATE_CNTL[params->otg_inst],\n\t\t\t\tDTBCLKDTO_ENABLE_STATUS[params->otg_inst], 1,\n\t\t\t\t1, 100);\n\n\t\t \n\t\tREG_UPDATE(OTG_PIXEL_RATE_CNTL[params->otg_inst],\n\t\t\t\tPIPE_DTO_SRC_SEL[params->otg_inst], 1);\n\t} else {\n\t\tREG_UPDATE_3(OTG_PIXEL_RATE_CNTL[params->otg_inst],\n\t\t\t\tDTBCLK_DTO_ENABLE[params->otg_inst], 0,\n\t\t\t\tPIPE_DTO_SRC_SEL[params->otg_inst], 0,\n\t\t\t\tDTBCLK_DTO_DIV[params->otg_inst], dtbdto_div);\n\n\t\tREG_WRITE(DTBCLK_DTO_MODULO[params->otg_inst], 0);\n\t\tREG_WRITE(DTBCLK_DTO_PHASE[params->otg_inst], 0);\n\t}\n}\n\nvoid dccg31_set_audio_dtbclk_dto(\n\t\tstruct dccg *dccg,\n\t\tconst struct dtbclk_dto_params *params)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tif (params->ref_dtbclk_khz && params->req_audio_dtbclk_khz) {\n\t\tuint32_t modulo, phase;\n\n\t\t\n\t\tmodulo = params->ref_dtbclk_khz * 1000;\n\t\tphase = div_u64((((unsigned long long)modulo * params->req_audio_dtbclk_khz) + params->ref_dtbclk_khz - 1),\n\t\t\tparams->ref_dtbclk_khz);\n\n\n\t\tREG_WRITE(DCCG_AUDIO_DTBCLK_DTO_MODULO, modulo);\n\t\tREG_WRITE(DCCG_AUDIO_DTBCLK_DTO_PHASE, phase);\n\n\t\t\n\t\t\n\n\t\tREG_UPDATE(DCCG_AUDIO_DTO_SOURCE,\n\t\t\t\tDCCG_AUDIO_DTO_SEL, 4);  \n\t} else {\n\t\tREG_WRITE(DCCG_AUDIO_DTBCLK_DTO_PHASE, 0);\n\t\tREG_WRITE(DCCG_AUDIO_DTBCLK_DTO_MODULO, 0);\n\n\t\tREG_UPDATE(DCCG_AUDIO_DTO_SOURCE,\n\t\t\t\tDCCG_AUDIO_DTO_SEL, 3);  \n\t}\n}\n\nvoid dccg31_get_dccg_ref_freq(struct dccg *dccg,\n\t\tunsigned int xtalin_freq_inKhz,\n\t\tunsigned int *dccg_ref_freq_inKhz)\n{\n\t \n\t*dccg_ref_freq_inKhz = xtalin_freq_inKhz;\n\treturn;\n}\n\nvoid dccg31_set_dispclk_change_mode(\n\tstruct dccg *dccg,\n\tenum dentist_dispclk_change_mode change_mode)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tREG_UPDATE(DENTIST_DISPCLK_CNTL, DENTIST_DISPCLK_CHG_MODE,\n\t\t   change_mode == DISPCLK_CHANGE_MODE_RAMPING ? 2 : 0);\n}\n\nvoid dccg31_init(struct dccg *dccg)\n{\n\t \n\tdccg31_disable_symclk32_se(dccg, 0);\n\tdccg31_disable_symclk32_se(dccg, 1);\n\tdccg31_disable_symclk32_se(dccg, 2);\n\tdccg31_disable_symclk32_se(dccg, 3);\n\n\tdccg31_set_symclk32_le_root_clock_gating(dccg, 0, false);\n\tdccg31_set_symclk32_le_root_clock_gating(dccg, 1, false);\n\n\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.dpstream) {\n\t\tdccg31_disable_dpstreamclk(dccg, 0);\n\t\tdccg31_disable_dpstreamclk(dccg, 1);\n\t\tdccg31_disable_dpstreamclk(dccg, 2);\n\t\tdccg31_disable_dpstreamclk(dccg, 3);\n\t}\n\n\tif (dccg->ctx->dc->debug.root_clock_optimization.bits.physymclk) {\n\t\tdccg31_set_physymclk(dccg, 0, PHYSYMCLK_FORCE_SRC_SYMCLK, false);\n\t\tdccg31_set_physymclk(dccg, 1, PHYSYMCLK_FORCE_SRC_SYMCLK, false);\n\t\tdccg31_set_physymclk(dccg, 2, PHYSYMCLK_FORCE_SRC_SYMCLK, false);\n\t\tdccg31_set_physymclk(dccg, 3, PHYSYMCLK_FORCE_SRC_SYMCLK, false);\n\t\tdccg31_set_physymclk(dccg, 4, PHYSYMCLK_FORCE_SRC_SYMCLK, false);\n\t}\n}\n\nvoid dccg31_otg_add_pixel(struct dccg *dccg,\n\t\t\t\t uint32_t otg_inst)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tREG_UPDATE(OTG_PIXEL_RATE_CNTL[otg_inst],\n\t\t\tOTG_ADD_PIXEL[otg_inst], 1);\n}\n\nvoid dccg31_otg_drop_pixel(struct dccg *dccg,\n\t\t\t\t  uint32_t otg_inst)\n{\n\tstruct dcn_dccg *dccg_dcn = TO_DCN_DCCG(dccg);\n\n\tREG_UPDATE(OTG_PIXEL_RATE_CNTL[otg_inst],\n\t\t\tOTG_DROP_PIXEL[otg_inst], 1);\n}\n\nstatic const struct dccg_funcs dccg31_funcs = {\n\t.update_dpp_dto = dccg31_update_dpp_dto,\n\t.get_dccg_ref_freq = dccg31_get_dccg_ref_freq,\n\t.dccg_init = dccg31_init,\n\t.set_dpstreamclk = dccg31_set_dpstreamclk,\n\t.enable_symclk32_se = dccg31_enable_symclk32_se,\n\t.disable_symclk32_se = dccg31_disable_symclk32_se,\n\t.enable_symclk32_le = dccg31_enable_symclk32_le,\n\t.disable_symclk32_le = dccg31_disable_symclk32_le,\n\t.set_physymclk = dccg31_set_physymclk,\n\t.set_dtbclk_dto = dccg31_set_dtbclk_dto,\n\t.set_audio_dtbclk_dto = dccg31_set_audio_dtbclk_dto,\n\t.set_fifo_errdet_ovr_en = dccg2_set_fifo_errdet_ovr_en,\n\t.otg_add_pixel = dccg31_otg_add_pixel,\n\t.otg_drop_pixel = dccg31_otg_drop_pixel,\n\t.set_dispclk_change_mode = dccg31_set_dispclk_change_mode,\n\t.disable_dsc = dccg31_disable_dscclk,\n\t.enable_dsc = dccg31_enable_dscclk,\n};\n\nstruct dccg *dccg31_create(\n\tstruct dc_context *ctx,\n\tconst struct dccg_registers *regs,\n\tconst struct dccg_shift *dccg_shift,\n\tconst struct dccg_mask *dccg_mask)\n{\n\tstruct dcn_dccg *dccg_dcn = kzalloc(sizeof(*dccg_dcn), GFP_KERNEL);\n\tstruct dccg *base;\n\n\tif (dccg_dcn == NULL) {\n\t\tBREAK_TO_DEBUGGER();\n\t\treturn NULL;\n\t}\n\n\tbase = &dccg_dcn->base;\n\tbase->ctx = ctx;\n\tbase->funcs = &dccg31_funcs;\n\n\tdccg_dcn->regs = regs;\n\tdccg_dcn->dccg_shift = dccg_shift;\n\tdccg_dcn->dccg_mask = dccg_mask;\n\n\treturn &dccg_dcn->base;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}