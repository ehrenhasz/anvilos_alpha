{
  "module_name": "dcn31_hpo_dp_stream_encoder.c",
  "hash_id": "b9187ba352a4b82c5761bc4c92beeb711233a2cd14b488d1613340edfba8a126",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn31/dcn31_hpo_dp_stream_encoder.c",
  "human_readable_source": " \n\n#include \"dc_bios_types.h\"\n#include \"dcn31_hpo_dp_stream_encoder.h\"\n#include \"reg_helper.h\"\n#include \"dc.h\"\n\n#define DC_LOGGER \\\n\t\tenc3->base.ctx->logger\n\n#define REG(reg)\\\n\t(enc3->regs->reg)\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\tenc3->hpo_se_shift->field_name, enc3->hpo_se_mask->field_name\n\n#define CTX \\\n\tenc3->base.ctx\n\n\nenum dp2_pixel_encoding {\n\tDP_SYM32_ENC_PIXEL_ENCODING_RGB_YCBCR444,\n\tDP_SYM32_ENC_PIXEL_ENCODING_YCBCR422,\n\tDP_SYM32_ENC_PIXEL_ENCODING_YCBCR420,\n\tDP_SYM32_ENC_PIXEL_ENCODING_Y_ONLY\n};\n\nenum dp2_uncompressed_component_depth {\n\tDP_SYM32_ENC_COMPONENT_DEPTH_6BPC,\n\tDP_SYM32_ENC_COMPONENT_DEPTH_8BPC,\n\tDP_SYM32_ENC_COMPONENT_DEPTH_10BPC,\n\tDP_SYM32_ENC_COMPONENT_DEPTH_12BPC\n};\n\n\nstatic void dcn31_hpo_dp_stream_enc_enable_stream(\n\t\tstruct hpo_dp_stream_encoder *enc)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\t \n\tREG_UPDATE(DP_STREAM_ENC_CLOCK_CONTROL,\n\t\t\tDP_STREAM_ENC_CLOCK_EN, 1);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_CONTROL,\n\t\t\tDP_SYM32_ENC_RESET, 1);\n\t \n\tREG_WAIT(DP_SYM32_ENC_CONTROL,\n\t\t\tDP_SYM32_ENC_RESET_DONE, 1,\n\t\t\t1, 10);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_CONTROL,\n\t\t\tDP_SYM32_ENC_RESET, 0);\n\t \n\tREG_WAIT(DP_SYM32_ENC_CONTROL,\n\t\t\tDP_SYM32_ENC_RESET_DONE, 0,\n\t\t\t1, 10);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_CONTROL,\n\t\t\tDP_SYM32_ENC_ENABLE, 1);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_dp_unblank(\n\t\tstruct hpo_dp_stream_encoder *enc,\n\t\tuint32_t stream_source)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\t \n\tREG_UPDATE(DP_STREAM_ENC_INPUT_MUX_CONTROL,\n\t\t\tDP_STREAM_ENC_INPUT_MUX_PIXEL_STREAM_SOURCE_SEL, stream_source);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_VID_STREAM_CONTROL,\n\t\t\tVID_STREAM_ENABLE, 1);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_VID_FIFO_CONTROL,\n\t\t\tPIXEL_TO_SYMBOL_FIFO_RESET, 1);\n\tREG_WAIT(DP_SYM32_ENC_VID_FIFO_CONTROL,\n\t\t\tPIXEL_TO_SYMBOL_FIFO_RESET_DONE, 1,\n\t\t\t1, 10);\n\tREG_UPDATE(DP_SYM32_ENC_VID_FIFO_CONTROL,\n\t\t\tPIXEL_TO_SYMBOL_FIFO_RESET, 0);\n\tREG_WAIT(DP_SYM32_ENC_VID_FIFO_CONTROL,\t \n\t\t\tPIXEL_TO_SYMBOL_FIFO_RESET_DONE, 0,\n\t\t\t1, 10);\n\tREG_UPDATE(DP_SYM32_ENC_VID_FIFO_CONTROL,\n\t\t\tPIXEL_TO_SYMBOL_FIFO_ENABLE, 1);\n\n\t \n\tREG_UPDATE(DP_STREAM_ENC_CLOCK_RAMP_ADJUSTER_FIFO_STATUS_CONTROL0,\n\t\t\tFIFO_RESET, 1);\n\tREG_WAIT(DP_STREAM_ENC_CLOCK_RAMP_ADJUSTER_FIFO_STATUS_CONTROL0,\n\t\t\tFIFO_RESET_DONE, 1,\n\t\t\t1, 10);\n\tREG_UPDATE(DP_STREAM_ENC_CLOCK_RAMP_ADJUSTER_FIFO_STATUS_CONTROL0,\n\t\t\tFIFO_RESET, 0);\n\tREG_WAIT(DP_STREAM_ENC_CLOCK_RAMP_ADJUSTER_FIFO_STATUS_CONTROL0,\n\t\t\tFIFO_RESET_DONE, 0,\n\t\t\t1, 10);\n\n\t \n\tREG_UPDATE_2(DP_SYM32_ENC_VID_CRC_CONTROL,\n\t\t\tCRC_ENABLE, 1,\n\t\t\tCRC_CONT_MODE_ENABLE, 1);\n\n\tREG_UPDATE(DP_STREAM_ENC_CLOCK_RAMP_ADJUSTER_FIFO_STATUS_CONTROL0,\n\t\t\tFIFO_ENABLE, 1);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_dp_blank(\n\t\tstruct hpo_dp_stream_encoder *enc)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_VID_STREAM_CONTROL,\n\t\t\tVID_STREAM_ENABLE, 0);\n\n\t \n\tREG_WAIT(DP_SYM32_ENC_VID_STREAM_CONTROL,\n\t\t\tVID_STREAM_STATUS, 0,\n\t\t\t10, 5000);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_SDP_CONTROL,\n\t\t\tSDP_STREAM_ENABLE, 0);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_VID_FIFO_CONTROL,\n\t\t\tPIXEL_TO_SYMBOL_FIFO_ENABLE, 0);\n\n\t \n\tREG_UPDATE(DP_STREAM_ENC_CLOCK_RAMP_ADJUSTER_FIFO_STATUS_CONTROL0,\n\t\t\tFIFO_ENABLE, 0);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_disable(\n\t\tstruct hpo_dp_stream_encoder *enc)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_CONTROL,\n\t\t\tDP_SYM32_ENC_ENABLE, 0);\n\n\t \n\tREG_UPDATE(DP_STREAM_ENC_CLOCK_CONTROL,\n\t\t\tDP_STREAM_ENC_CLOCK_EN, 0);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_set_stream_attribute(\n\t\tstruct hpo_dp_stream_encoder *enc,\n\t\tstruct dc_crtc_timing *crtc_timing,\n\t\tenum dc_color_space output_color_space,\n\t\tbool use_vsc_sdp_for_colorimetry,\n\t\tbool compressed_format,\n\t\tbool double_buffer_en)\n{\n\tenum dp2_pixel_encoding pixel_encoding;\n\tenum dp2_uncompressed_component_depth component_depth;\n\tuint32_t h_active_start;\n\tuint32_t v_active_start;\n\tuint32_t h_blank;\n\tuint32_t h_back_porch;\n\tuint32_t h_width;\n\tuint32_t v_height;\n\tuint64_t v_freq;\n\tuint8_t misc0 = 0;\n\tuint8_t misc1 = 0;\n\tuint8_t hsp;\n\tuint8_t vsp;\n\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\tstruct dc_crtc_timing hw_crtc_timing = *crtc_timing;\n\n\t \n\n\t \n\tif (hw_crtc_timing.flags.INTERLACE) {\n\t\tBREAK_TO_DEBUGGER();\n\t}\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_VID_MSA_DOUBLE_BUFFER_CONTROL,\n\t\t\tMSA_DOUBLE_BUFFER_ENABLE, double_buffer_en);\n\tREG_UPDATE(DP_SYM32_ENC_VID_PIXEL_FORMAT_DOUBLE_BUFFER_CONTROL,\n\t\t\tPIXEL_FORMAT_DOUBLE_BUFFER_ENABLE, double_buffer_en);\n\n\t \n\tswitch (hw_crtc_timing.pixel_encoding) {\n\tcase PIXEL_ENCODING_YCBCR422:\n\t\tpixel_encoding = DP_SYM32_ENC_PIXEL_ENCODING_YCBCR422;\n\t\tmisc0 = misc0 | 0x2;  \n\t\tbreak;\n\tcase PIXEL_ENCODING_YCBCR444:\n\t\tpixel_encoding = DP_SYM32_ENC_PIXEL_ENCODING_RGB_YCBCR444;\n\t\tmisc0 = misc0 | 0x4;  \n\n\t\tif (hw_crtc_timing.flags.Y_ONLY) {\n\t\t\tpixel_encoding =  DP_SYM32_ENC_PIXEL_ENCODING_Y_ONLY;\n\t\t\tif (hw_crtc_timing.display_color_depth != COLOR_DEPTH_666) {\n\t\t\t\t \n\t\t\t\tmisc1 = misc1 | 0x80;  \n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase PIXEL_ENCODING_YCBCR420:\n\t\tpixel_encoding = DP_SYM32_ENC_PIXEL_ENCODING_YCBCR420;\n\t\tmisc1 = misc1 | 0x40;   \n\t\tbreak;\n\tcase PIXEL_ENCODING_RGB:\n\tdefault:\n\t\tpixel_encoding = DP_SYM32_ENC_PIXEL_ENCODING_RGB_YCBCR444;\n\t\tbreak;\n\t}\n\n\t \n\tif (use_vsc_sdp_for_colorimetry)\n\t\tmisc1 = misc1 | 0x40;\n\telse\n\t\tmisc1 = misc1 & ~0x40;\n\n\t \n\tswitch (hw_crtc_timing.display_color_depth) {\n\tcase COLOR_DEPTH_666:\n\t\tcomponent_depth = DP_SYM32_ENC_COMPONENT_DEPTH_6BPC;\n\t\t\n\t\tbreak;\n\tcase COLOR_DEPTH_888:\n\t\tcomponent_depth = DP_SYM32_ENC_COMPONENT_DEPTH_8BPC;\n\t\tmisc0 = misc0 | 0x20;  \n\t\tbreak;\n\tcase COLOR_DEPTH_101010:\n\t\tcomponent_depth = DP_SYM32_ENC_COMPONENT_DEPTH_10BPC;\n\t\tmisc0 = misc0 | 0x40;  \n\t\tbreak;\n\tcase COLOR_DEPTH_121212:\n\t\tcomponent_depth = DP_SYM32_ENC_COMPONENT_DEPTH_12BPC;\n\t\tmisc0 = misc0 | 0x60;  \n\t\tbreak;\n\tdefault:\n\t\tcomponent_depth = DP_SYM32_ENC_COMPONENT_DEPTH_6BPC;\n\t\tbreak;\n\t}\n\n\tREG_UPDATE_3(DP_SYM32_ENC_VID_PIXEL_FORMAT,\n\t\t\tPIXEL_ENCODING_TYPE, compressed_format,\n\t\t\tUNCOMPRESSED_PIXEL_ENCODING, pixel_encoding,\n\t\t\tUNCOMPRESSED_COMPONENT_DEPTH, component_depth);\n\n\tswitch (output_color_space) {\n\tcase COLOR_SPACE_SRGB:\n\t\tmisc1 = misc1 & ~0x80;  \n\t\tbreak;\n\tcase COLOR_SPACE_SRGB_LIMITED:\n\t\tmisc0 = misc0 | 0x8;  \n\t\tmisc1 = misc1 & ~0x80;  \n\t\tbreak;\n\tcase COLOR_SPACE_YCBCR601:\n\tcase COLOR_SPACE_YCBCR601_LIMITED:\n\t\tmisc0 = misc0 | 0x8;  \n\t\tmisc1 = misc1 & ~0x80;  \n\t\tif (hw_crtc_timing.pixel_encoding == PIXEL_ENCODING_YCBCR422)\n\t\t\tmisc0 = misc0 | 0x2;  \n\t\telse if (hw_crtc_timing.pixel_encoding == PIXEL_ENCODING_YCBCR444)\n\t\t\tmisc0 = misc0 | 0x4;  \n\t\tbreak;\n\tcase COLOR_SPACE_YCBCR709:\n\tcase COLOR_SPACE_YCBCR709_LIMITED:\n\t\tmisc0 = misc0 | 0x18;  \n\t\tmisc1 = misc1 & ~0x80;  \n\t\tif (hw_crtc_timing.pixel_encoding == PIXEL_ENCODING_YCBCR422)\n\t\t\tmisc0 = misc0 | 0x2;  \n\t\telse if (hw_crtc_timing.pixel_encoding == PIXEL_ENCODING_YCBCR444)\n\t\t\tmisc0 = misc0 | 0x4;  \n\t\tbreak;\n\tcase COLOR_SPACE_2020_RGB_LIMITEDRANGE:\n\tcase COLOR_SPACE_2020_RGB_FULLRANGE:\n\tcase COLOR_SPACE_2020_YCBCR:\n\tcase COLOR_SPACE_XR_RGB:\n\tcase COLOR_SPACE_MSREF_SCRGB:\n\tcase COLOR_SPACE_ADOBERGB:\n\tcase COLOR_SPACE_DCIP3:\n\tcase COLOR_SPACE_XV_YCC_709:\n\tcase COLOR_SPACE_XV_YCC_601:\n\tcase COLOR_SPACE_DISPLAYNATIVE:\n\tcase COLOR_SPACE_DOLBYVISION:\n\tcase COLOR_SPACE_APPCTRL:\n\tcase COLOR_SPACE_CUSTOMPOINTS:\n\tcase COLOR_SPACE_UNKNOWN:\n\tcase COLOR_SPACE_YCBCR709_BLACK:\n\t\t \n\t\tbreak;\n\t}\n\n\t \n\th_blank = hw_crtc_timing.h_total - hw_crtc_timing.h_border_left -\n\t\t\thw_crtc_timing.h_addressable - hw_crtc_timing.h_border_right;\n\n\th_back_porch = h_blank - hw_crtc_timing.h_front_porch -\n\t\t\thw_crtc_timing.h_sync_width;\n\n\t \n\th_active_start = hw_crtc_timing.h_sync_width + h_back_porch;\n\n\tv_active_start = hw_crtc_timing.v_total - hw_crtc_timing.v_border_top -\n\t\t\thw_crtc_timing.v_addressable - hw_crtc_timing.v_border_bottom -\n\t\t\thw_crtc_timing.v_front_porch;\n\n\th_width = hw_crtc_timing.h_border_left + hw_crtc_timing.h_addressable + hw_crtc_timing.h_border_right;\n\tv_height = hw_crtc_timing.v_border_top + hw_crtc_timing.v_addressable + hw_crtc_timing.v_border_bottom;\n\thsp = hw_crtc_timing.flags.HSYNC_POSITIVE_POLARITY ? 0 : 0x80;\n\tvsp = hw_crtc_timing.flags.VSYNC_POSITIVE_POLARITY ? 0 : 0x80;\n\tv_freq = (uint64_t)hw_crtc_timing.pix_clk_100hz * 100;\n\n\t \n\tREG_SET_4(DP_SYM32_ENC_VID_MSA0, 0,\n\t\t\tMSA_DATA_LANE_0, 0,\n\t\t\tMSA_DATA_LANE_1, 0,\n\t\t\tMSA_DATA_LANE_2, 0,\n\t\t\tMSA_DATA_LANE_3, v_freq >> 40);\n\n\tREG_SET_4(DP_SYM32_ENC_VID_MSA1, 0,\n\t\t\tMSA_DATA_LANE_0, 0,\n\t\t\tMSA_DATA_LANE_1, 0,\n\t\t\tMSA_DATA_LANE_2, 0,\n\t\t\tMSA_DATA_LANE_3, (v_freq >> 32) & 0xff);\n\n\tREG_SET_4(DP_SYM32_ENC_VID_MSA2, 0,\n\t\t\tMSA_DATA_LANE_0, 0,\n\t\t\tMSA_DATA_LANE_1, 0,\n\t\t\tMSA_DATA_LANE_2, 0,\n\t\t\tMSA_DATA_LANE_3, (v_freq >> 24) & 0xff);\n\n\tREG_SET_4(DP_SYM32_ENC_VID_MSA3, 0,\n\t\t\tMSA_DATA_LANE_0, hw_crtc_timing.h_total >> 8,\n\t\t\tMSA_DATA_LANE_1, h_active_start >> 8,\n\t\t\tMSA_DATA_LANE_2, h_width >> 8,\n\t\t\tMSA_DATA_LANE_3, (v_freq >> 16) & 0xff);\n\n\tREG_SET_4(DP_SYM32_ENC_VID_MSA4, 0,\n\t\t\tMSA_DATA_LANE_0, hw_crtc_timing.h_total & 0xff,\n\t\t\tMSA_DATA_LANE_1, h_active_start & 0xff,\n\t\t\tMSA_DATA_LANE_2, h_width & 0xff,\n\t\t\tMSA_DATA_LANE_3, (v_freq >> 8) & 0xff);\n\n\tREG_SET_4(DP_SYM32_ENC_VID_MSA5, 0,\n\t\t\tMSA_DATA_LANE_0, hw_crtc_timing.v_total >> 8,\n\t\t\tMSA_DATA_LANE_1, v_active_start >> 8,\n\t\t\tMSA_DATA_LANE_2, v_height >> 8,\n\t\t\tMSA_DATA_LANE_3, v_freq & 0xff);\n\n\tREG_SET_4(DP_SYM32_ENC_VID_MSA6, 0,\n\t\t\tMSA_DATA_LANE_0, hw_crtc_timing.v_total & 0xff,\n\t\t\tMSA_DATA_LANE_1, v_active_start & 0xff,\n\t\t\tMSA_DATA_LANE_2, v_height & 0xff,\n\t\t\tMSA_DATA_LANE_3, misc0);\n\n\tREG_SET_4(DP_SYM32_ENC_VID_MSA7, 0,\n\t\t\tMSA_DATA_LANE_0, hsp | (hw_crtc_timing.h_sync_width >> 8),\n\t\t\tMSA_DATA_LANE_1, vsp | (hw_crtc_timing.v_sync_width >> 8),\n\t\t\tMSA_DATA_LANE_2, 0,\n\t\t\tMSA_DATA_LANE_3, misc1);\n\n\tREG_SET_4(DP_SYM32_ENC_VID_MSA8, 0,\n\t\t\tMSA_DATA_LANE_0, hw_crtc_timing.h_sync_width & 0xff,\n\t\t\tMSA_DATA_LANE_1, hw_crtc_timing.v_sync_width & 0xff,\n\t\t\tMSA_DATA_LANE_2, 0,\n\t\t\tMSA_DATA_LANE_3, 0);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_update_dp_info_packets_sdp_line_num(\n\t\tstruct hpo_dp_stream_encoder *enc,\n\t\tstruct encoder_info_frame *info_frame)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\tif (info_frame->adaptive_sync.valid == true &&\n\t\tinfo_frame->sdp_line_num.adaptive_sync_line_num_valid == true) {\n\t\t\n\t\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL5, GSP_SOF_REFERENCE, 1);\n\n\t\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL5, GSP_TRANSMISSION_LINE_NUMBER,\n\t\t\t\t\tinfo_frame->sdp_line_num.adaptive_sync_line_num);\n\t}\n}\n\nstatic void dcn31_hpo_dp_stream_enc_update_dp_info_packets(\n\t\tstruct hpo_dp_stream_encoder *enc,\n\t\tconst struct encoder_info_frame *info_frame)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\tuint32_t dmdata_packet_enabled = 0;\n\n\tif (info_frame->vsc.valid)\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t0,   \n\t\t\t\t&info_frame->vsc,\n\t\t\t\ttrue);\n\n\tif (info_frame->spd.valid)\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t2,   \n\t\t\t\t&info_frame->spd,\n\t\t\t\ttrue);\n\n\tif (info_frame->hdrsmd.valid)\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t3,   \n\t\t\t\t&info_frame->hdrsmd,\n\t\t\t\ttrue);\n\n\tif (info_frame->adaptive_sync.valid)\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t5,   \n\t\t\t\t&info_frame->adaptive_sync,\n\t\t\t\ttrue);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL0, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, info_frame->vsc.valid);\n\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL2, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, info_frame->spd.valid);\n\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL3, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, info_frame->hdrsmd.valid);\n\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL5, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, info_frame->adaptive_sync.valid);\n\n\t \n\tREG_GET(DP_SYM32_ENC_SDP_METADATA_PACKET_CONTROL,\n\t\t\tMETADATA_PACKET_ENABLE, &dmdata_packet_enabled);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_SDP_CONTROL,\n\t\t\tSDP_STREAM_ENABLE, 1);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_stop_dp_info_packets(\n\tstruct hpo_dp_stream_encoder *enc)\n{\n\t \n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\tuint32_t asp_enable = 0;\n\tuint32_t atp_enable = 0;\n\tuint32_t aip_enable = 0;\n\tuint32_t acm_enable = 0;\n\n\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL0, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, 0);\n\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL2, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, 0);\n\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL3, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, 0);\n\n\t \n\tREG_GET_4(DP_SYM32_ENC_SDP_AUDIO_CONTROL0,\n\t\t\tASP_ENABLE, &asp_enable,\n\t\t\tATP_ENABLE, &atp_enable,\n\t\t\tAIP_ENABLE, &aip_enable,\n\t\t\tACM_ENABLE, &acm_enable);\n\tif (!(asp_enable || atp_enable || aip_enable || acm_enable))\n\t\tREG_UPDATE(DP_SYM32_ENC_SDP_CONTROL,\n\t\t\t\tSDP_STREAM_ENABLE, 0);\n}\n\nstatic uint32_t hpo_dp_is_gsp_enabled(\n\t\tstruct hpo_dp_stream_encoder *enc)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\tuint32_t gsp0_enabled = 0;\n\tuint32_t gsp2_enabled = 0;\n\tuint32_t gsp3_enabled = 0;\n\tuint32_t gsp11_enabled = 0;\n\n\tREG_GET(DP_SYM32_ENC_SDP_GSP_CONTROL0, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, &gsp0_enabled);\n\tREG_GET(DP_SYM32_ENC_SDP_GSP_CONTROL2, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, &gsp2_enabled);\n\tREG_GET(DP_SYM32_ENC_SDP_GSP_CONTROL3, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, &gsp3_enabled);\n\tREG_GET(DP_SYM32_ENC_SDP_GSP_CONTROL11, GSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, &gsp11_enabled);\n\n\treturn (gsp0_enabled || gsp2_enabled || gsp3_enabled || gsp11_enabled);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_set_dsc_pps_info_packet(\n\t\tstruct hpo_dp_stream_encoder *enc,\n\t\tbool enable,\n\t\tuint8_t *dsc_packed_pps,\n\t\tbool immediate_update)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\tif (enable) {\n\t\tstruct dc_info_packet pps_sdp;\n\t\tint i;\n\n\t\t \n\t\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL11,\n\t\t\t\tGSP_PAYLOAD_SIZE, 3);\n\n\t\t \n\t\tpps_sdp.valid = true;\n\t\tpps_sdp.hb0 = 0;\n\t\tpps_sdp.hb1 = DC_DP_INFOFRAME_TYPE_PPS;\n\t\tpps_sdp.hb2 = 127;\n\t\tpps_sdp.hb3 = 0;\n\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tmemcpy(pps_sdp.sb, &dsc_packed_pps[i * 32], 32);\n\t\t\tenc3->base.vpg->funcs->update_generic_info_packet(\n\t\t\t\t\t\t\tenc3->base.vpg,\n\t\t\t\t\t\t\t11 + i,\n\t\t\t\t\t\t\t&pps_sdp,\n\t\t\t\t\t\t\timmediate_update);\n\t\t}\n\n\t\t \n\t\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL11,\n\t\t\t\tGSP_TRANSMISSION_LINE_NUMBER, 2);\n\n\t\tREG_UPDATE_2(DP_SYM32_ENC_VID_VBID_CONTROL,\n\t\t\t\tVBID_6_COMPRESSEDSTREAM_FLAG_SOF_REFERENCE, 0,\n\t\t\t\tVBID_6_COMPRESSEDSTREAM_FLAG_LINE_NUMBER, 3);\n\n\t\t \n\t\tREG_UPDATE(DP_SYM32_ENC_SDP_GSP_CONTROL11,\n\t\t\t\tGSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, 1);\n\t\tREG_UPDATE(DP_SYM32_ENC_SDP_CONTROL,\n\t\t\t\tSDP_STREAM_ENABLE, 1);\n\t} else {\n\t\t \n\t\tREG_UPDATE_2(DP_SYM32_ENC_SDP_GSP_CONTROL11,\n\t\t\t\tGSP_VIDEO_CONTINUOUS_TRANSMISSION_ENABLE, 0,\n\t\t\t\tGSP_PAYLOAD_SIZE, 0);\n\t}\n}\n\nstatic void dcn31_hpo_dp_stream_enc_map_stream_to_link(\n\t\tstruct hpo_dp_stream_encoder *enc,\n\t\tuint32_t stream_enc_inst,\n\t\tuint32_t link_enc_inst)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\tASSERT(stream_enc_inst < 4 && link_enc_inst < 2);\n\n\tswitch (stream_enc_inst) {\n\tcase 0:\n\t\tREG_UPDATE(DP_STREAM_MAPPER_CONTROL0,\n\t\t\t\tDP_STREAM_LINK_TARGET, link_enc_inst);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE(DP_STREAM_MAPPER_CONTROL1,\n\t\t\t\tDP_STREAM_LINK_TARGET, link_enc_inst);\n\t\tbreak;\n\tcase 2:\n\t\tREG_UPDATE(DP_STREAM_MAPPER_CONTROL2,\n\t\t\t\tDP_STREAM_LINK_TARGET, link_enc_inst);\n\t\tbreak;\n\tcase 3:\n\t\tREG_UPDATE(DP_STREAM_MAPPER_CONTROL3,\n\t\t\t\tDP_STREAM_LINK_TARGET, link_enc_inst);\n\t\tbreak;\n\t}\n}\n\nstatic void dcn31_hpo_dp_stream_enc_audio_setup(\n\tstruct hpo_dp_stream_encoder *enc,\n\tunsigned int az_inst,\n\tstruct audio_info *info)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\t \n\tREG_UPDATE(DP_STREAM_ENC_AUDIO_CONTROL,\n\t\t\tDP_STREAM_ENC_INPUT_MUX_AUDIO_STREAM_SOURCE_SEL, az_inst);\n\n\tASSERT(enc->apg);\n\tenc->apg->funcs->se_audio_setup(enc->apg, az_inst, info);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_audio_enable(\n\tstruct hpo_dp_stream_encoder *enc)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_SDP_AUDIO_CONTROL0, ASP_ENABLE, 1);\n\n\t \n\tREG_UPDATE_2(DP_SYM32_ENC_SDP_AUDIO_CONTROL0,\n\t\t\tATP_ENABLE, 1,\n\t\t\tAIP_ENABLE, 1);\n\n\t \n\tREG_UPDATE(DP_SYM32_ENC_SDP_CONTROL,\n\t\t\tSDP_STREAM_ENABLE, 1);\n\n\t \n\tenc->apg->funcs->enable_apg(enc->apg);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_audio_disable(\n\tstruct hpo_dp_stream_encoder *enc)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\t \n\tREG_UPDATE_4(DP_SYM32_ENC_SDP_AUDIO_CONTROL0,\n\t\t\tASP_ENABLE, 0,\n\t\t\tATP_ENABLE, 0,\n\t\t\tAIP_ENABLE, 0,\n\t\t\tACM_ENABLE, 0);\n\n\t \n\tif (!(hpo_dp_is_gsp_enabled(enc)))\n\t\tREG_UPDATE(DP_SYM32_ENC_SDP_CONTROL,\n\t\t\t\tSDP_STREAM_ENABLE, 0);\n\n\t \n\tenc->apg->funcs->disable_apg(enc->apg);\n}\n\nstatic void dcn31_hpo_dp_stream_enc_read_state(\n\t\tstruct hpo_dp_stream_encoder *enc,\n\t\tstruct hpo_dp_stream_encoder_state *s)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\tREG_GET(DP_SYM32_ENC_CONTROL,\n\t\t\tDP_SYM32_ENC_ENABLE, &s->stream_enc_enabled);\n\tREG_GET(DP_SYM32_ENC_VID_STREAM_CONTROL,\n\t\t\tVID_STREAM_ENABLE, &s->vid_stream_enabled);\n\tREG_GET(DP_STREAM_ENC_INPUT_MUX_CONTROL,\n\t\t\tDP_STREAM_ENC_INPUT_MUX_PIXEL_STREAM_SOURCE_SEL, &s->otg_inst);\n\n\tREG_GET_3(DP_SYM32_ENC_VID_PIXEL_FORMAT,\n\t\t\tPIXEL_ENCODING_TYPE, &s->compressed_format,\n\t\t\tUNCOMPRESSED_PIXEL_ENCODING, &s->pixel_encoding,\n\t\t\tUNCOMPRESSED_COMPONENT_DEPTH, &s->component_depth);\n\n\tREG_GET(DP_SYM32_ENC_SDP_CONTROL,\n\t\t\tSDP_STREAM_ENABLE, &s->sdp_enabled);\n\n\tswitch (enc->inst) {\n\tcase 0:\n\t\tREG_GET(DP_STREAM_MAPPER_CONTROL0,\n\t\t\t\tDP_STREAM_LINK_TARGET, &s->mapped_to_link_enc);\n\t\tbreak;\n\tcase 1:\n\t\tREG_GET(DP_STREAM_MAPPER_CONTROL1,\n\t\t\t\tDP_STREAM_LINK_TARGET, &s->mapped_to_link_enc);\n\t\tbreak;\n\tcase 2:\n\t\tREG_GET(DP_STREAM_MAPPER_CONTROL2,\n\t\t\t\tDP_STREAM_LINK_TARGET, &s->mapped_to_link_enc);\n\t\tbreak;\n\tcase 3:\n\t\tREG_GET(DP_STREAM_MAPPER_CONTROL3,\n\t\t\t\tDP_STREAM_LINK_TARGET, &s->mapped_to_link_enc);\n\t\tbreak;\n\t}\n}\n\nstatic void dcn31_set_hblank_min_symbol_width(\n\t\tstruct hpo_dp_stream_encoder *enc,\n\t\tuint16_t width)\n{\n\tstruct dcn31_hpo_dp_stream_encoder *enc3 = DCN3_1_HPO_DP_STREAM_ENC_FROM_HPO_STREAM_ENC(enc);\n\n\tREG_SET(DP_SYM32_ENC_HBLANK_CONTROL, 0,\n\t\t\tHBLANK_MINIMUM_SYMBOL_WIDTH, width);\n}\n\nstatic const struct hpo_dp_stream_encoder_funcs dcn30_str_enc_funcs = {\n\t.enable_stream = dcn31_hpo_dp_stream_enc_enable_stream,\n\t.dp_unblank = dcn31_hpo_dp_stream_enc_dp_unblank,\n\t.dp_blank = dcn31_hpo_dp_stream_enc_dp_blank,\n\t.disable = dcn31_hpo_dp_stream_enc_disable,\n\t.set_stream_attribute = dcn31_hpo_dp_stream_enc_set_stream_attribute,\n\t.update_dp_info_packets_sdp_line_num = dcn31_hpo_dp_stream_enc_update_dp_info_packets_sdp_line_num,\n\t.update_dp_info_packets = dcn31_hpo_dp_stream_enc_update_dp_info_packets,\n\t.stop_dp_info_packets = dcn31_hpo_dp_stream_enc_stop_dp_info_packets,\n\t.dp_set_dsc_pps_info_packet = dcn31_hpo_dp_stream_enc_set_dsc_pps_info_packet,\n\t.map_stream_to_link = dcn31_hpo_dp_stream_enc_map_stream_to_link,\n\t.dp_audio_setup = dcn31_hpo_dp_stream_enc_audio_setup,\n\t.dp_audio_enable = dcn31_hpo_dp_stream_enc_audio_enable,\n\t.dp_audio_disable = dcn31_hpo_dp_stream_enc_audio_disable,\n\t.read_state = dcn31_hpo_dp_stream_enc_read_state,\n\t.set_hblank_min_symbol_width = dcn31_set_hblank_min_symbol_width,\n};\n\nvoid dcn31_hpo_dp_stream_encoder_construct(\n\tstruct dcn31_hpo_dp_stream_encoder *enc3,\n\tstruct dc_context *ctx,\n\tstruct dc_bios *bp,\n\tuint32_t inst,\n\tenum engine_id eng_id,\n\tstruct vpg *vpg,\n\tstruct apg *apg,\n\tconst struct dcn31_hpo_dp_stream_encoder_registers *regs,\n\tconst struct dcn31_hpo_dp_stream_encoder_shift *hpo_se_shift,\n\tconst struct dcn31_hpo_dp_stream_encoder_mask *hpo_se_mask)\n{\n\tenc3->base.funcs = &dcn30_str_enc_funcs;\n\tenc3->base.ctx = ctx;\n\tenc3->base.inst = inst;\n\tenc3->base.id = eng_id;\n\tenc3->base.bp = bp;\n\tenc3->base.vpg = vpg;\n\tenc3->base.apg = apg;\n\tenc3->regs = regs;\n\tenc3->hpo_se_shift = hpo_se_shift;\n\tenc3->hpo_se_mask = hpo_se_mask;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}