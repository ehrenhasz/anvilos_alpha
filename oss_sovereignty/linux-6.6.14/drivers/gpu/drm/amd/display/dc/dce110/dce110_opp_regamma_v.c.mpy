{
  "module_name": "dce110_opp_regamma_v.c",
  "hash_id": "55c108ad28eaad022c97a368fa23f115cac610f08de6b2a10dc1af678bad39d2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dce110/dce110_opp_regamma_v.c",
  "human_readable_source": " \n\n#include \"dm_services.h\"\n\n \n#include \"dce/dce_11_0_d.h\"\n#include \"dce/dce_11_0_sh_mask.h\"\n\n#include \"dce110_transform_v.h\"\n\nstatic void power_on_lut(struct transform *xfm,\n\tbool power_on, bool inputgamma, bool regamma)\n{\n\tuint32_t value = dm_read_reg(xfm->ctx, mmDCFEV_MEM_PWR_CTRL);\n\tint i;\n\n\tif (power_on) {\n\t\tif (inputgamma)\n\t\t\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\t1,\n\t\t\t\tDCFEV_MEM_PWR_CTRL,\n\t\t\t\tCOL_MAN_INPUT_GAMMA_MEM_PWR_DIS);\n\t\tif (regamma)\n\t\t\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\t1,\n\t\t\t\tDCFEV_MEM_PWR_CTRL,\n\t\t\t\tCOL_MAN_GAMMA_CORR_MEM_PWR_DIS);\n\t} else {\n\t\tif (inputgamma)\n\t\t\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\t0,\n\t\t\t\tDCFEV_MEM_PWR_CTRL,\n\t\t\t\tCOL_MAN_INPUT_GAMMA_MEM_PWR_DIS);\n\t\tif (regamma)\n\t\t\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\t0,\n\t\t\t\tDCFEV_MEM_PWR_CTRL,\n\t\t\t\tCOL_MAN_GAMMA_CORR_MEM_PWR_DIS);\n\t}\n\n\tdm_write_reg(xfm->ctx, mmDCFEV_MEM_PWR_CTRL, value);\n\n\tfor (i = 0; i < 3; i++) {\n\t\tvalue = dm_read_reg(xfm->ctx, mmDCFEV_MEM_PWR_CTRL);\n\t\tif (get_reg_field_value(value,\n\t\t\t\tDCFEV_MEM_PWR_CTRL,\n\t\t\t\tCOL_MAN_INPUT_GAMMA_MEM_PWR_DIS) &&\n\t\t\tget_reg_field_value(value,\n\t\t\t\t\tDCFEV_MEM_PWR_CTRL,\n\t\t\t\t\tCOL_MAN_GAMMA_CORR_MEM_PWR_DIS))\n\t\t\tbreak;\n\n\t\tudelay(2);\n\t}\n}\n\nstatic void set_bypass_input_gamma(struct dce_transform *xfm_dce)\n{\n\tuint32_t value;\n\n\tvalue = dm_read_reg(xfm_dce->base.ctx,\n\t\t\tmmCOL_MAN_INPUT_GAMMA_CONTROL1);\n\n\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\t0,\n\t\t\t\tCOL_MAN_INPUT_GAMMA_CONTROL1,\n\t\t\t\tINPUT_GAMMA_MODE);\n\n\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmCOL_MAN_INPUT_GAMMA_CONTROL1, value);\n}\n\nstatic void configure_regamma_mode(struct dce_transform *xfm_dce, uint32_t mode)\n{\n\tuint32_t value = 0;\n\n\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\tmode,\n\t\t\t\tGAMMA_CORR_CONTROL,\n\t\t\t\tGAMMA_CORR_MODE);\n\n\tdm_write_reg(xfm_dce->base.ctx, mmGAMMA_CORR_CONTROL, 0);\n}\n\n \nstatic void regamma_config_regions_and_segments(\n\tstruct dce_transform *xfm_dce, const struct pwl_params *params)\n{\n\tconst struct gamma_curve *curve;\n\tuint32_t value = 0;\n\n\t{\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tparams->arr_points[0].custom_float_x,\n\t\t\tGAMMA_CORR_CNTLA_START_CNTL,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION_START);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\t0,\n\t\t\tGAMMA_CORR_CNTLA_START_CNTL,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION_START_SEGMENT);\n\n\t\tdm_write_reg(xfm_dce->base.ctx, mmGAMMA_CORR_CNTLA_START_CNTL,\n\t\t\t\tvalue);\n\t}\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tparams->arr_points[0].custom_float_slope,\n\t\t\tGAMMA_CORR_CNTLA_SLOPE_CNTL,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION_LINEAR_SLOPE);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_SLOPE_CNTL, value);\n\t}\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tparams->arr_points[1].custom_float_x,\n\t\t\tGAMMA_CORR_CNTLA_END_CNTL1,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION_END);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_END_CNTL1, value);\n\t}\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tparams->arr_points[1].custom_float_slope,\n\t\t\tGAMMA_CORR_CNTLA_END_CNTL2,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION_END_BASE);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tparams->arr_points[1].custom_float_y,\n\t\t\tGAMMA_CORR_CNTLA_END_CNTL2,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION_END_SLOPE);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_END_CNTL2, value);\n\t}\n\n\tcurve = params->arr_curve_points;\n\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_0_1,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION0_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_0_1,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION0_NUM_SEGMENTS);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_0_1,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION1_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_0_1,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION1_NUM_SEGMENTS);\n\n\t\tdm_write_reg(\n\t\t\t\txfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_REGION_0_1,\n\t\t\tvalue);\n\t}\n\n\tcurve += 2;\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_2_3,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION2_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_2_3,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION2_NUM_SEGMENTS);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_2_3,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION3_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_2_3,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION3_NUM_SEGMENTS);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_REGION_2_3,\n\t\t\tvalue);\n\t}\n\n\tcurve += 2;\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_4_5,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION4_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_4_5,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION4_NUM_SEGMENTS);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_4_5,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION5_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_4_5,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION5_NUM_SEGMENTS);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_REGION_4_5,\n\t\t\tvalue);\n\t}\n\n\tcurve += 2;\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_6_7,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION6_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_6_7,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION6_NUM_SEGMENTS);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_6_7,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION7_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_6_7,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION7_NUM_SEGMENTS);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_REGION_6_7,\n\t\t\tvalue);\n\t}\n\n\tcurve += 2;\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_8_9,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION8_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_8_9,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION8_NUM_SEGMENTS);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_8_9,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION9_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_8_9,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION9_NUM_SEGMENTS);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_REGION_8_9,\n\t\t\tvalue);\n\t}\n\n\tcurve += 2;\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_10_11,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION10_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_10_11,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION10_NUM_SEGMENTS);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_10_11,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION11_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_10_11,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION11_NUM_SEGMENTS);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_REGION_10_11,\n\t\t\tvalue);\n\t}\n\n\tcurve += 2;\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_12_13,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION12_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_12_13,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION12_NUM_SEGMENTS);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_12_13,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION13_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_12_13,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION13_NUM_SEGMENTS);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_REGION_12_13,\n\t\t\tvalue);\n\t}\n\n\tcurve += 2;\n\t{\n\t\tvalue = 0;\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_14_15,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION14_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[0].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_14_15,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION14_NUM_SEGMENTS);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].offset,\n\t\t\tGAMMA_CORR_CNTLA_REGION_14_15,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION15_LUT_OFFSET);\n\n\t\tset_reg_field_value(\n\t\t\tvalue,\n\t\t\tcurve[1].segments_num,\n\t\t\tGAMMA_CORR_CNTLA_REGION_14_15,\n\t\t\tGAMMA_CORR_CNTLA_EXP_REGION15_NUM_SEGMENTS);\n\n\t\tdm_write_reg(xfm_dce->base.ctx,\n\t\t\tmmGAMMA_CORR_CNTLA_REGION_14_15,\n\t\t\tvalue);\n\t}\n}\n\nstatic void program_pwl(struct dce_transform *xfm_dce,\n\t\tconst struct pwl_params *params)\n{\n\tuint32_t value = 0;\n\n\tset_reg_field_value(\n\t\tvalue,\n\t\t7,\n\t\tGAMMA_CORR_LUT_WRITE_EN_MASK,\n\t\tGAMMA_CORR_LUT_WRITE_EN_MASK);\n\n\tdm_write_reg(xfm_dce->base.ctx,\n\t\tmmGAMMA_CORR_LUT_WRITE_EN_MASK, value);\n\n\tdm_write_reg(xfm_dce->base.ctx,\n\t\tmmGAMMA_CORR_LUT_INDEX, 0);\n\n\t \n\t{\n\t\tconst uint32_t addr = mmGAMMA_CORR_LUT_DATA;\n\t\tuint32_t i = 0;\n\t\tconst struct pwl_result_data *rgb =\n\t\t\t\tparams->rgb_resulted;\n\n\t\twhile (i != params->hw_points_num) {\n\t\t\tdm_write_reg(xfm_dce->base.ctx, addr, rgb->red_reg);\n\t\t\tdm_write_reg(xfm_dce->base.ctx, addr, rgb->green_reg);\n\t\t\tdm_write_reg(xfm_dce->base.ctx, addr, rgb->blue_reg);\n\n\t\t\tdm_write_reg(xfm_dce->base.ctx, addr,\n\t\t\t\trgb->delta_red_reg);\n\t\t\tdm_write_reg(xfm_dce->base.ctx, addr,\n\t\t\t\trgb->delta_green_reg);\n\t\t\tdm_write_reg(xfm_dce->base.ctx, addr,\n\t\t\t\trgb->delta_blue_reg);\n\n\t\t\t++rgb;\n\t\t\t++i;\n\t\t}\n\t}\n}\n\nvoid dce110_opp_program_regamma_pwl_v(\n\tstruct transform *xfm,\n\tconst struct pwl_params *params)\n{\n\tstruct dce_transform *xfm_dce = TO_DCE_TRANSFORM(xfm);\n\n\t \n\tregamma_config_regions_and_segments(xfm_dce, params);\n\n\tset_bypass_input_gamma(xfm_dce);\n\n\t \n\tpower_on_lut(xfm, true, false, true);\n\n\t \n\tprogram_pwl(xfm_dce, params);\n\n\t \n\tconfigure_regamma_mode(xfm_dce, 1);\n\n\t \n\tpower_on_lut(xfm, false, false, true);\n}\n\nvoid dce110_opp_power_on_regamma_lut_v(\n\tstruct transform *xfm,\n\tbool power_on)\n{\n\tuint32_t value = dm_read_reg(xfm->ctx, mmDCFEV_MEM_PWR_CTRL);\n\n\tset_reg_field_value(\n\t\tvalue,\n\t\t0,\n\t\tDCFEV_MEM_PWR_CTRL,\n\t\tCOL_MAN_GAMMA_CORR_MEM_PWR_FORCE);\n\n\tset_reg_field_value(\n\t\tvalue,\n\t\tpower_on,\n\t\tDCFEV_MEM_PWR_CTRL,\n\t\tCOL_MAN_GAMMA_CORR_MEM_PWR_DIS);\n\n\tset_reg_field_value(\n\t\tvalue,\n\t\t0,\n\t\tDCFEV_MEM_PWR_CTRL,\n\t\tCOL_MAN_INPUT_GAMMA_MEM_PWR_FORCE);\n\n\tset_reg_field_value(\n\t\tvalue,\n\t\tpower_on,\n\t\tDCFEV_MEM_PWR_CTRL,\n\t\tCOL_MAN_INPUT_GAMMA_MEM_PWR_DIS);\n\n\tdm_write_reg(xfm->ctx, mmDCFEV_MEM_PWR_CTRL, value);\n}\n\nvoid dce110_opp_set_regamma_mode_v(\n\tstruct transform *xfm,\n\tenum opp_regamma mode)\n{\n\t\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}