{
  "module_name": "link_hwss_hpo_dp.c",
  "hash_id": "0dfddcc4f5fed386355277da07ae7f9840fc60781f1f8782e7223893392cd498",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/link/hwss/link_hwss_hpo_dp.c",
  "human_readable_source": " \n#include \"link_hwss_hpo_dp.h\"\n#include \"dm_helpers.h\"\n#include \"core_types.h\"\n#include \"dccg.h\"\n#include \"clk_mgr.h\"\n\nvoid set_hpo_dp_throttled_vcp_size(struct pipe_ctx *pipe_ctx,\n\t\tstruct fixed31_32 throttled_vcp_size)\n{\n\tstruct hpo_dp_stream_encoder *hpo_dp_stream_encoder =\n\t\t\tpipe_ctx->stream_res.hpo_dp_stream_enc;\n\tstruct hpo_dp_link_encoder *hpo_dp_link_encoder =\n\t\t\tpipe_ctx->link_res.hpo_dp_link_enc;\n\n\thpo_dp_link_encoder->funcs->set_throttled_vcp_size(hpo_dp_link_encoder,\n\t\t\thpo_dp_stream_encoder->inst,\n\t\t\tthrottled_vcp_size);\n}\n\nvoid set_hpo_dp_hblank_min_symbol_width(struct pipe_ctx *pipe_ctx,\n\t\tconst struct dc_link_settings *link_settings,\n\t\tstruct fixed31_32 throttled_vcp_size)\n{\n\tstruct hpo_dp_stream_encoder *hpo_dp_stream_encoder =\n\t\t\tpipe_ctx->stream_res.hpo_dp_stream_enc;\n\tstruct dc_crtc_timing *timing = &pipe_ctx->stream->timing;\n\tstruct fixed31_32 h_blank_in_ms, time_slot_in_ms, mtp_cnt_per_h_blank;\n\tuint32_t link_bw_in_kbps =\n\t\t\thpo_dp_stream_encoder->ctx->dc->link_srv->dp_link_bandwidth_kbps(\n\t\t\t\t\tpipe_ctx->stream->link, link_settings);\n\tuint16_t hblank_min_symbol_width = 0;\n\n\tif (link_bw_in_kbps > 0) {\n\t\th_blank_in_ms = dc_fixpt_div(dc_fixpt_from_int(\n\t\t\t\ttiming->h_total - timing->h_addressable),\n\t\t\t\tdc_fixpt_from_fraction(timing->pix_clk_100hz, 10));\n\t\ttime_slot_in_ms = dc_fixpt_from_fraction(32 * 4, link_bw_in_kbps);\n\t\tmtp_cnt_per_h_blank = dc_fixpt_div(h_blank_in_ms,\n\t\t\t\tdc_fixpt_mul_int(time_slot_in_ms, 64));\n\t\thblank_min_symbol_width = dc_fixpt_floor(\n\t\t\t\tdc_fixpt_mul(mtp_cnt_per_h_blank, throttled_vcp_size));\n\t}\n\n\thpo_dp_stream_encoder->funcs->set_hblank_min_symbol_width(hpo_dp_stream_encoder,\n\t\t\thblank_min_symbol_width);\n}\n\nvoid setup_hpo_dp_stream_encoder(struct pipe_ctx *pipe_ctx)\n{\n\tstruct hpo_dp_stream_encoder *stream_enc = pipe_ctx->stream_res.hpo_dp_stream_enc;\n\tstruct hpo_dp_link_encoder *link_enc = pipe_ctx->link_res.hpo_dp_link_enc;\n\n\tstream_enc->funcs->enable_stream(stream_enc);\n\tstream_enc->funcs->map_stream_to_link(stream_enc, stream_enc->inst, link_enc->inst);\n}\n\nvoid reset_hpo_dp_stream_encoder(struct pipe_ctx *pipe_ctx)\n{\n\tstruct hpo_dp_stream_encoder *stream_enc = pipe_ctx->stream_res.hpo_dp_stream_enc;\n\n\tstream_enc->funcs->disable(stream_enc);\n}\n\nvoid setup_hpo_dp_stream_attribute(struct pipe_ctx *pipe_ctx)\n{\n\tstruct hpo_dp_stream_encoder *stream_enc = pipe_ctx->stream_res.hpo_dp_stream_enc;\n\tstruct dc_stream_state *stream = pipe_ctx->stream;\n\tstruct dc_link *link = stream->link;\n\n\tstream_enc->funcs->set_stream_attribute(\n\t\t\tstream_enc,\n\t\t\t&stream->timing,\n\t\t\tstream->output_color_space,\n\t\t\tstream->use_vsc_sdp_for_colorimetry,\n\t\t\tstream->timing.flags.DSC,\n\t\t\tfalse);\n\tlink->dc->link_srv->dp_trace_source_sequence(link,\n\t\t\tDPCD_SOURCE_SEQ_AFTER_DP_STREAM_ATTR);\n}\n\nvoid enable_hpo_dp_link_output(struct dc_link *link,\n\t\tconst struct link_resource *link_res,\n\t\tenum signal_type signal,\n\t\tenum clock_source_id clock_source,\n\t\tconst struct dc_link_settings *link_settings)\n{\n\tif (link->dc->res_pool->dccg->funcs->set_symclk32_le_root_clock_gating)\n\t\tlink->dc->res_pool->dccg->funcs->set_symclk32_le_root_clock_gating(\n\t\t\t\tlink->dc->res_pool->dccg,\n\t\t\t\tlink_res->hpo_dp_link_enc->inst,\n\t\t\t\ttrue);\n\tlink_res->hpo_dp_link_enc->funcs->enable_link_phy(\n\t\t\tlink_res->hpo_dp_link_enc,\n\t\t\tlink_settings,\n\t\t\tlink->link_enc->transmitter,\n\t\t\tlink->link_enc->hpd_source);\n}\n\nvoid disable_hpo_dp_link_output(struct dc_link *link,\n\t\tconst struct link_resource *link_res,\n\t\tenum signal_type signal)\n{\n\t\tlink_res->hpo_dp_link_enc->funcs->link_disable(link_res->hpo_dp_link_enc);\n\t\tlink_res->hpo_dp_link_enc->funcs->disable_link_phy(\n\t\t\t\tlink_res->hpo_dp_link_enc, signal);\n\t\tif (link->dc->res_pool->dccg->funcs->set_symclk32_le_root_clock_gating)\n\t\t\tlink->dc->res_pool->dccg->funcs->set_symclk32_le_root_clock_gating(\n\t\t\t\t\tlink->dc->res_pool->dccg,\n\t\t\t\t\tlink_res->hpo_dp_link_enc->inst,\n\t\t\t\t\tfalse);\n}\n\nstatic void set_hpo_dp_link_test_pattern(struct dc_link *link,\n\t\tconst struct link_resource *link_res,\n\t\tstruct encoder_set_dp_phy_pattern_param *tp_params)\n{\n\tlink_res->hpo_dp_link_enc->funcs->set_link_test_pattern(\n\t\t\tlink_res->hpo_dp_link_enc, tp_params);\n\tlink->dc->link_srv->dp_trace_source_sequence(link, DPCD_SOURCE_SEQ_AFTER_SET_SOURCE_PATTERN);\n}\n\nstatic void set_hpo_dp_lane_settings(struct dc_link *link,\n\t\tconst struct link_resource *link_res,\n\t\tconst struct dc_link_settings *link_settings,\n\t\tconst struct dc_lane_settings lane_settings[LANE_COUNT_DP_MAX])\n{\n\tlink_res->hpo_dp_link_enc->funcs->set_ffe(\n\t\t\tlink_res->hpo_dp_link_enc,\n\t\t\tlink_settings,\n\t\t\tlane_settings[0].FFE_PRESET.raw);\n}\n\nvoid update_hpo_dp_stream_allocation_table(struct dc_link *link,\n\t\tconst struct link_resource *link_res,\n\t\tconst struct link_mst_stream_allocation_table *table)\n{\n\tlink_res->hpo_dp_link_enc->funcs->update_stream_allocation_table(\n\t\t\tlink_res->hpo_dp_link_enc,\n\t\t\ttable);\n}\n\nvoid setup_hpo_dp_audio_output(struct pipe_ctx *pipe_ctx,\n\t\tstruct audio_output *audio_output, uint32_t audio_inst)\n{\n\tpipe_ctx->stream_res.hpo_dp_stream_enc->funcs->dp_audio_setup(\n\t\t\tpipe_ctx->stream_res.hpo_dp_stream_enc,\n\t\t\taudio_inst,\n\t\t\t&pipe_ctx->stream->audio_info);\n}\n\nvoid enable_hpo_dp_audio_packet(struct pipe_ctx *pipe_ctx)\n{\n\tpipe_ctx->stream_res.hpo_dp_stream_enc->funcs->dp_audio_enable(\n\t\t\tpipe_ctx->stream_res.hpo_dp_stream_enc);\n}\n\nvoid disable_hpo_dp_audio_packet(struct pipe_ctx *pipe_ctx)\n{\n\tif (pipe_ctx->stream_res.audio)\n\t\tpipe_ctx->stream_res.hpo_dp_stream_enc->funcs->dp_audio_disable(\n\t\t\t\tpipe_ctx->stream_res.hpo_dp_stream_enc);\n}\n\nstatic const struct link_hwss hpo_dp_link_hwss = {\n\t.setup_stream_encoder = setup_hpo_dp_stream_encoder,\n\t.reset_stream_encoder = reset_hpo_dp_stream_encoder,\n\t.setup_stream_attribute = setup_hpo_dp_stream_attribute,\n\t.disable_link_output = disable_hpo_dp_link_output,\n\t.setup_audio_output = setup_hpo_dp_audio_output,\n\t.enable_audio_packet = enable_hpo_dp_audio_packet,\n\t.disable_audio_packet = disable_hpo_dp_audio_packet,\n\t.ext = {\n\t\t.set_throttled_vcp_size = set_hpo_dp_throttled_vcp_size,\n\t\t.set_hblank_min_symbol_width = set_hpo_dp_hblank_min_symbol_width,\n\t\t.enable_dp_link_output = enable_hpo_dp_link_output,\n\t\t.set_dp_link_test_pattern  = set_hpo_dp_link_test_pattern,\n\t\t.set_dp_lane_settings = set_hpo_dp_lane_settings,\n\t\t.update_stream_allocation_table = update_hpo_dp_stream_allocation_table,\n\t},\n};\n\nbool can_use_hpo_dp_link_hwss(const struct dc_link *link,\n\t\tconst struct link_resource *link_res)\n{\n\treturn link_res->hpo_dp_link_enc != NULL;\n}\n\nconst struct link_hwss *get_hpo_dp_link_hwss(void)\n{\n\treturn &hpo_dp_link_hwss;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}