{
  "module_name": "dce_calcs.c",
  "hash_id": "93d6ee9a01767c2e4cb80d6b1d0a32ab5de48081f2164b12e9405824d4ee3e8f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/calcs/dce_calcs.c",
  "human_readable_source": " \n\n#include <linux/slab.h>\n\n#include \"resource.h\"\n#include \"dm_services.h\"\n#include \"dce_calcs.h\"\n#include \"dc.h\"\n#include \"core_types.h\"\n#include \"dal_asic_id.h\"\n#include \"calcs_logger.h\"\n\n \n\n \n\nstatic enum bw_calcs_version bw_calcs_version_from_asic_id(struct hw_asic_id asic_id)\n{\n\tswitch (asic_id.chip_family) {\n\n\tcase FAMILY_CZ:\n\t\tif (ASIC_REV_IS_STONEY(asic_id.hw_internal_rev))\n\t\t\treturn BW_CALCS_VERSION_STONEY;\n\t\treturn BW_CALCS_VERSION_CARRIZO;\n\n\tcase FAMILY_VI:\n\t\tif (ASIC_REV_IS_POLARIS12_V(asic_id.hw_internal_rev))\n\t\t\treturn BW_CALCS_VERSION_POLARIS12;\n\t\tif (ASIC_REV_IS_POLARIS10_P(asic_id.hw_internal_rev))\n\t\t\treturn BW_CALCS_VERSION_POLARIS10;\n\t\tif (ASIC_REV_IS_POLARIS11_M(asic_id.hw_internal_rev))\n\t\t\treturn BW_CALCS_VERSION_POLARIS11;\n\t\tif (ASIC_REV_IS_VEGAM(asic_id.hw_internal_rev))\n\t\t\treturn BW_CALCS_VERSION_VEGAM;\n\t\treturn BW_CALCS_VERSION_INVALID;\n\n\tcase FAMILY_AI:\n\t\treturn BW_CALCS_VERSION_VEGA10;\n\n\tdefault:\n\t\treturn BW_CALCS_VERSION_INVALID;\n\t}\n}\n\nstatic void calculate_bandwidth(\n\tconst struct bw_calcs_dceip *dceip,\n\tconst struct bw_calcs_vbios *vbios,\n\tstruct bw_calcs_data *data)\n\n{\n\tconst int32_t pixels_per_chunk = 512;\n\tconst int32_t high = 2;\n\tconst int32_t mid = 1;\n\tconst int32_t low = 0;\n\tconst uint32_t s_low = 0;\n\tconst uint32_t s_mid1 = 1;\n\tconst uint32_t s_mid2 = 2;\n\tconst uint32_t s_mid3 = 3;\n\tconst uint32_t s_mid4 = 4;\n\tconst uint32_t s_mid5 = 5;\n\tconst uint32_t s_mid6 = 6;\n\tconst uint32_t s_high = 7;\n\tconst uint32_t dmif_chunk_buff_margin = 1;\n\n\tuint32_t max_chunks_fbc_mode;\n\tint32_t num_cursor_lines;\n\n\tint32_t i, j, k;\n\tstruct bw_fixed *yclk;\n\tstruct bw_fixed *sclk;\n\tbool d0_underlay_enable;\n\tbool d1_underlay_enable;\n\tbool fbc_enabled;\n\tbool lpt_enabled;\n\tenum bw_defines sclk_message;\n\tenum bw_defines yclk_message;\n\tenum bw_defines *tiling_mode;\n\tenum bw_defines *surface_type;\n\tenum bw_defines voltage;\n\tenum bw_defines pipe_check;\n\tenum bw_defines hsr_check;\n\tenum bw_defines vsr_check;\n\tenum bw_defines lb_size_check;\n\tenum bw_defines fbc_check;\n\tenum bw_defines rotation_check;\n\tenum bw_defines mode_check;\n\tenum bw_defines nbp_state_change_enable_blank;\n\t \n\tint32_t number_of_displays_enabled = 0;\n\tint32_t number_of_displays_enabled_with_margin = 0;\n\tint32_t number_of_aligned_displays_with_no_margin = 0;\n\n\tyclk = kcalloc(3, sizeof(*yclk), GFP_KERNEL);\n\tif (!yclk)\n\t\treturn;\n\n\tsclk = kcalloc(8, sizeof(*sclk), GFP_KERNEL);\n\tif (!sclk)\n\t\tgoto free_yclk;\n\n\ttiling_mode = kcalloc(maximum_number_of_surfaces, sizeof(*tiling_mode), GFP_KERNEL);\n\tif (!tiling_mode)\n\t\tgoto free_sclk;\n\n\tsurface_type = kcalloc(maximum_number_of_surfaces, sizeof(*surface_type), GFP_KERNEL);\n\tif (!surface_type)\n\t\tgoto free_tiling_mode;\n\n\tyclk[low] = vbios->low_yclk;\n\tyclk[mid] = vbios->mid_yclk;\n\tyclk[high] = vbios->high_yclk;\n\tsclk[s_low] = vbios->low_sclk;\n\tsclk[s_mid1] = vbios->mid1_sclk;\n\tsclk[s_mid2] = vbios->mid2_sclk;\n\tsclk[s_mid3] = vbios->mid3_sclk;\n\tsclk[s_mid4] = vbios->mid4_sclk;\n\tsclk[s_mid5] = vbios->mid5_sclk;\n\tsclk[s_mid6] = vbios->mid6_sclk;\n\tsclk[s_high] = vbios->high_sclk;\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\n\n\n\n\tif (data->d0_underlay_mode == bw_def_none)\n\t\td0_underlay_enable = false;\n\telse\n\t\td0_underlay_enable = true;\n\tif (data->d1_underlay_mode == bw_def_none)\n\t\td1_underlay_enable = false;\n\telse\n\t\td1_underlay_enable = true;\n\tdata->number_of_underlay_surfaces = d0_underlay_enable + d1_underlay_enable;\n\tswitch (data->underlay_surface_type) {\n\tcase bw_def_420:\n\t\tsurface_type[0] = bw_def_underlay420_luma;\n\t\tsurface_type[2] = bw_def_underlay420_luma;\n\t\tdata->bytes_per_pixel[0] = 1;\n\t\tdata->bytes_per_pixel[2] = 1;\n\t\tsurface_type[1] = bw_def_underlay420_chroma;\n\t\tsurface_type[3] = bw_def_underlay420_chroma;\n\t\tdata->bytes_per_pixel[1] = 2;\n\t\tdata->bytes_per_pixel[3] = 2;\n\t\tdata->lb_size_per_component[0] = dceip->underlay420_luma_lb_size_per_component;\n\t\tdata->lb_size_per_component[1] = dceip->underlay420_chroma_lb_size_per_component;\n\t\tdata->lb_size_per_component[2] = dceip->underlay420_luma_lb_size_per_component;\n\t\tdata->lb_size_per_component[3] = dceip->underlay420_chroma_lb_size_per_component;\n\t\tbreak;\n\tcase bw_def_422:\n\t\tsurface_type[0] = bw_def_underlay422;\n\t\tsurface_type[2] = bw_def_underlay422;\n\t\tdata->bytes_per_pixel[0] = 2;\n\t\tdata->bytes_per_pixel[2] = 2;\n\t\tdata->lb_size_per_component[0] = dceip->underlay422_lb_size_per_component;\n\t\tdata->lb_size_per_component[2] = dceip->underlay422_lb_size_per_component;\n\t\tbreak;\n\tdefault:\n\t\tsurface_type[0] = bw_def_underlay444;\n\t\tsurface_type[2] = bw_def_underlay444;\n\t\tdata->bytes_per_pixel[0] = 4;\n\t\tdata->bytes_per_pixel[2] = 4;\n\t\tdata->lb_size_per_component[0] = dceip->lb_size_per_component444;\n\t\tdata->lb_size_per_component[2] = dceip->lb_size_per_component444;\n\t\tbreak;\n\t}\n\tif (d0_underlay_enable) {\n\t\tswitch (data->underlay_surface_type) {\n\t\tcase bw_def_420:\n\t\t\tdata->enable[0] = 1;\n\t\t\tdata->enable[1] = 1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdata->enable[0] = 1;\n\t\t\tdata->enable[1] = 0;\n\t\t\tbreak;\n\t\t}\n\t}\n\telse {\n\t\tdata->enable[0] = 0;\n\t\tdata->enable[1] = 0;\n\t}\n\tif (d1_underlay_enable) {\n\t\tswitch (data->underlay_surface_type) {\n\t\tcase bw_def_420:\n\t\t\tdata->enable[2] = 1;\n\t\t\tdata->enable[3] = 1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdata->enable[2] = 1;\n\t\t\tdata->enable[3] = 0;\n\t\t\tbreak;\n\t\t}\n\t}\n\telse {\n\t\tdata->enable[2] = 0;\n\t\tdata->enable[3] = 0;\n\t}\n\tdata->use_alpha[0] = 0;\n\tdata->use_alpha[1] = 0;\n\tdata->use_alpha[2] = 0;\n\tdata->use_alpha[3] = 0;\n\tdata->scatter_gather_enable_for_pipe[0] = vbios->scatter_gather_enable;\n\tdata->scatter_gather_enable_for_pipe[1] = vbios->scatter_gather_enable;\n\tdata->scatter_gather_enable_for_pipe[2] = vbios->scatter_gather_enable;\n\tdata->scatter_gather_enable_for_pipe[3] = vbios->scatter_gather_enable;\n\t \n\tdata->interlace_mode[0] = data->interlace_mode[4];\n\tdata->interlace_mode[1] = data->interlace_mode[4];\n\t \n\tdata->interlace_mode[2] = data->interlace_mode[5];\n\tdata->interlace_mode[3] = data->interlace_mode[5];\n\t \n\tdata->h_total[0] = data->h_total[4];\n\tdata->v_total[0] = data->v_total[4];\n\tdata->h_total[1] = data->h_total[4];\n\tdata->v_total[1] = data->v_total[4];\n\t \n\tdata->h_total[2] = data->h_total[5];\n\tdata->v_total[2] = data->v_total[5];\n\tdata->h_total[3] = data->h_total[5];\n\tdata->v_total[3] = data->v_total[5];\n\t \n\tdata->pixel_rate[0] = data->pixel_rate[4];\n\tdata->pixel_rate[1] = data->pixel_rate[4];\n\t \n\tdata->pixel_rate[2] = data->pixel_rate[5];\n\tdata->pixel_rate[3] = data->pixel_rate[5];\n\tif ((data->underlay_tiling_mode == bw_def_array_linear_general || data->underlay_tiling_mode == bw_def_array_linear_aligned)) {\n\t\ttiling_mode[0] = bw_def_linear;\n\t\ttiling_mode[1] = bw_def_linear;\n\t\ttiling_mode[2] = bw_def_linear;\n\t\ttiling_mode[3] = bw_def_linear;\n\t}\n\telse {\n\t\ttiling_mode[0] = bw_def_landscape;\n\t\ttiling_mode[1] = bw_def_landscape;\n\t\ttiling_mode[2] = bw_def_landscape;\n\t\ttiling_mode[3] = bw_def_landscape;\n\t}\n\tdata->lb_bpc[0] = data->underlay_lb_bpc;\n\tdata->lb_bpc[1] = data->underlay_lb_bpc;\n\tdata->lb_bpc[2] = data->underlay_lb_bpc;\n\tdata->lb_bpc[3] = data->underlay_lb_bpc;\n\tdata->compression_rate[0] = bw_int_to_fixed(1);\n\tdata->compression_rate[1] = bw_int_to_fixed(1);\n\tdata->compression_rate[2] = bw_int_to_fixed(1);\n\tdata->compression_rate[3] = bw_int_to_fixed(1);\n\tdata->access_one_channel_only[0] = 0;\n\tdata->access_one_channel_only[1] = 0;\n\tdata->access_one_channel_only[2] = 0;\n\tdata->access_one_channel_only[3] = 0;\n\tdata->cursor_width_pixels[0] = bw_int_to_fixed(0);\n\tdata->cursor_width_pixels[1] = bw_int_to_fixed(0);\n\tdata->cursor_width_pixels[2] = bw_int_to_fixed(0);\n\tdata->cursor_width_pixels[3] = bw_int_to_fixed(0);\n\t \n\tfbc_enabled = false;\n\tlpt_enabled = false;\n\tfor (i = 4; i <= maximum_number_of_surfaces - 3; i++) {\n\t\tif (i < data->number_of_displays + 4) {\n\t\t\tif (i == 4 && data->d0_underlay_mode == bw_def_underlay_only) {\n\t\t\t\tdata->enable[i] = 0;\n\t\t\t\tdata->use_alpha[i] = 0;\n\t\t\t}\n\t\t\telse if (i == 4 && data->d0_underlay_mode == bw_def_blend) {\n\t\t\t\tdata->enable[i] = 1;\n\t\t\t\tdata->use_alpha[i] = 1;\n\t\t\t}\n\t\t\telse if (i == 4) {\n\t\t\t\tdata->enable[i] = 1;\n\t\t\t\tdata->use_alpha[i] = 0;\n\t\t\t}\n\t\t\telse if (i == 5 && data->d1_underlay_mode == bw_def_underlay_only) {\n\t\t\t\tdata->enable[i] = 0;\n\t\t\t\tdata->use_alpha[i] = 0;\n\t\t\t}\n\t\t\telse if (i == 5 && data->d1_underlay_mode == bw_def_blend) {\n\t\t\t\tdata->enable[i] = 1;\n\t\t\t\tdata->use_alpha[i] = 1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->enable[i] = 1;\n\t\t\t\tdata->use_alpha[i] = 0;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tdata->enable[i] = 0;\n\t\t\tdata->use_alpha[i] = 0;\n\t\t}\n\t\tdata->scatter_gather_enable_for_pipe[i] = vbios->scatter_gather_enable;\n\t\tsurface_type[i] = bw_def_graphics;\n\t\tdata->lb_size_per_component[i] = dceip->lb_size_per_component444;\n\t\tif (data->graphics_tiling_mode == bw_def_array_linear_general || data->graphics_tiling_mode == bw_def_array_linear_aligned) {\n\t\t\ttiling_mode[i] = bw_def_linear;\n\t\t}\n\t\telse {\n\t\t\ttiling_mode[i] = bw_def_tiled;\n\t\t}\n\t\tdata->lb_bpc[i] = data->graphics_lb_bpc;\n\t\tif ((data->fbc_en[i] == 1 && (dceip->argb_compression_support || data->d0_underlay_mode != bw_def_blended))) {\n\t\t\tdata->compression_rate[i] = bw_int_to_fixed(vbios->average_compression_rate);\n\t\t\tdata->access_one_channel_only[i] = data->lpt_en[i];\n\t\t}\n\t\telse {\n\t\t\tdata->compression_rate[i] = bw_int_to_fixed(1);\n\t\t\tdata->access_one_channel_only[i] = 0;\n\t\t}\n\t\tif (data->fbc_en[i] == 1) {\n\t\t\tfbc_enabled = true;\n\t\t\tif (data->lpt_en[i] == 1) {\n\t\t\t\tlpt_enabled = true;\n\t\t\t}\n\t\t}\n\t\tdata->cursor_width_pixels[i] = bw_int_to_fixed(vbios->cursor_width);\n\t}\n\t \n\tdata->scatter_gather_enable_for_pipe[maximum_number_of_surfaces - 2] = 0;\n\tdata->scatter_gather_enable_for_pipe[maximum_number_of_surfaces - 1] = 0;\n\tif (data->d1_display_write_back_dwb_enable == 1) {\n\t\tdata->enable[maximum_number_of_surfaces - 2] = 1;\n\t\tdata->enable[maximum_number_of_surfaces - 1] = 1;\n\t}\n\telse {\n\t\tdata->enable[maximum_number_of_surfaces - 2] = 0;\n\t\tdata->enable[maximum_number_of_surfaces - 1] = 0;\n\t}\n\tsurface_type[maximum_number_of_surfaces - 2] = bw_def_display_write_back420_luma;\n\tsurface_type[maximum_number_of_surfaces - 1] = bw_def_display_write_back420_chroma;\n\tdata->lb_size_per_component[maximum_number_of_surfaces - 2] = dceip->underlay420_luma_lb_size_per_component;\n\tdata->lb_size_per_component[maximum_number_of_surfaces - 1] = dceip->underlay420_chroma_lb_size_per_component;\n\tdata->bytes_per_pixel[maximum_number_of_surfaces - 2] = 1;\n\tdata->bytes_per_pixel[maximum_number_of_surfaces - 1] = 2;\n\tdata->interlace_mode[maximum_number_of_surfaces - 2] = data->interlace_mode[5];\n\tdata->interlace_mode[maximum_number_of_surfaces - 1] = data->interlace_mode[5];\n\tdata->h_taps[maximum_number_of_surfaces - 2] = bw_int_to_fixed(1);\n\tdata->h_taps[maximum_number_of_surfaces - 1] = bw_int_to_fixed(1);\n\tdata->v_taps[maximum_number_of_surfaces - 2] = bw_int_to_fixed(1);\n\tdata->v_taps[maximum_number_of_surfaces - 1] = bw_int_to_fixed(1);\n\tdata->rotation_angle[maximum_number_of_surfaces - 2] = bw_int_to_fixed(0);\n\tdata->rotation_angle[maximum_number_of_surfaces - 1] = bw_int_to_fixed(0);\n\ttiling_mode[maximum_number_of_surfaces - 2] = bw_def_linear;\n\ttiling_mode[maximum_number_of_surfaces - 1] = bw_def_linear;\n\tdata->lb_bpc[maximum_number_of_surfaces - 2] = 8;\n\tdata->lb_bpc[maximum_number_of_surfaces - 1] = 8;\n\tdata->compression_rate[maximum_number_of_surfaces - 2] = bw_int_to_fixed(1);\n\tdata->compression_rate[maximum_number_of_surfaces - 1] = bw_int_to_fixed(1);\n\tdata->access_one_channel_only[maximum_number_of_surfaces - 2] = 0;\n\tdata->access_one_channel_only[maximum_number_of_surfaces - 1] = 0;\n\t \n\tdata->h_total[maximum_number_of_surfaces - 2] = data->h_total[5];\n\tdata->h_total[maximum_number_of_surfaces - 1] = data->h_total[5];\n\tdata->v_total[maximum_number_of_surfaces - 2] = data->v_total[5];\n\tdata->v_total[maximum_number_of_surfaces - 1] = data->v_total[5];\n\tdata->pixel_rate[maximum_number_of_surfaces - 2] = data->pixel_rate[5];\n\tdata->pixel_rate[maximum_number_of_surfaces - 1] = data->pixel_rate[5];\n\tdata->src_width[maximum_number_of_surfaces - 2] = data->src_width[5];\n\tdata->src_width[maximum_number_of_surfaces - 1] = data->src_width[5];\n\tdata->src_height[maximum_number_of_surfaces - 2] = data->src_height[5];\n\tdata->src_height[maximum_number_of_surfaces - 1] = data->src_height[5];\n\tdata->pitch_in_pixels[maximum_number_of_surfaces - 2] = data->src_width[5];\n\tdata->pitch_in_pixels[maximum_number_of_surfaces - 1] = data->src_width[5];\n\tdata->h_scale_ratio[maximum_number_of_surfaces - 2] = bw_int_to_fixed(1);\n\tdata->h_scale_ratio[maximum_number_of_surfaces - 1] = bw_int_to_fixed(1);\n\tdata->v_scale_ratio[maximum_number_of_surfaces - 2] = bw_int_to_fixed(1);\n\tdata->v_scale_ratio[maximum_number_of_surfaces - 1] = bw_int_to_fixed(1);\n\tdata->stereo_mode[maximum_number_of_surfaces - 2] = bw_def_mono;\n\tdata->stereo_mode[maximum_number_of_surfaces - 1] = bw_def_mono;\n\tdata->cursor_width_pixels[maximum_number_of_surfaces - 2] = bw_int_to_fixed(0);\n\tdata->cursor_width_pixels[maximum_number_of_surfaces - 1] = bw_int_to_fixed(0);\n\tdata->use_alpha[maximum_number_of_surfaces - 2] = 0;\n\tdata->use_alpha[maximum_number_of_surfaces - 1] = 0;\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (bw_equ(data->h_scale_ratio[i], bw_int_to_fixed(1)) && bw_equ(data->v_scale_ratio[i], bw_int_to_fixed(1)) && surface_type[i] == bw_def_graphics && data->stereo_mode[i] == bw_def_mono && data->interlace_mode[i] == 0) {\n\t\t\t\tdata->h_taps[i] = bw_int_to_fixed(1);\n\t\t\t\tdata->v_taps[i] = bw_int_to_fixed(1);\n\t\t\t}\n\t\t\tif (surface_type[i] == bw_def_display_write_back420_chroma || surface_type[i] == bw_def_underlay420_chroma) {\n\t\t\t\tdata->pitch_in_pixels_after_surface_type[i] = bw_div(data->pitch_in_pixels[i], bw_int_to_fixed(2));\n\t\t\t\tdata->src_width_after_surface_type = bw_div(data->src_width[i], bw_int_to_fixed(2));\n\t\t\t\tdata->src_height_after_surface_type = bw_div(data->src_height[i], bw_int_to_fixed(2));\n\t\t\t\tdata->hsr_after_surface_type = bw_div(data->h_scale_ratio[i], bw_int_to_fixed(2));\n\t\t\t\tdata->vsr_after_surface_type = bw_div(data->v_scale_ratio[i], bw_int_to_fixed(2));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->pitch_in_pixels_after_surface_type[i] = data->pitch_in_pixels[i];\n\t\t\t\tdata->src_width_after_surface_type = data->src_width[i];\n\t\t\t\tdata->src_height_after_surface_type = data->src_height[i];\n\t\t\t\tdata->hsr_after_surface_type = data->h_scale_ratio[i];\n\t\t\t\tdata->vsr_after_surface_type = data->v_scale_ratio[i];\n\t\t\t}\n\t\t\tif ((bw_equ(data->rotation_angle[i], bw_int_to_fixed(90)) || bw_equ(data->rotation_angle[i], bw_int_to_fixed(270))) && surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->src_width_after_rotation = data->src_height_after_surface_type;\n\t\t\t\tdata->src_height_after_rotation = data->src_width_after_surface_type;\n\t\t\t\tdata->hsr_after_rotation = data->vsr_after_surface_type;\n\t\t\t\tdata->vsr_after_rotation = data->hsr_after_surface_type;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->src_width_after_rotation = data->src_width_after_surface_type;\n\t\t\t\tdata->src_height_after_rotation = data->src_height_after_surface_type;\n\t\t\t\tdata->hsr_after_rotation = data->hsr_after_surface_type;\n\t\t\t\tdata->vsr_after_rotation = data->vsr_after_surface_type;\n\t\t\t}\n\t\t\tswitch (data->stereo_mode[i]) {\n\t\t\tcase bw_def_top_bottom:\n\t\t\t\tdata->source_width_pixels[i] = data->src_width_after_rotation;\n\t\t\t\tdata->source_height_pixels = bw_mul(bw_int_to_fixed(2), data->src_height_after_rotation);\n\t\t\t\tdata->hsr_after_stereo = data->hsr_after_rotation;\n\t\t\t\tdata->vsr_after_stereo = bw_mul(bw_int_to_fixed(1), data->vsr_after_rotation);\n\t\t\t\tbreak;\n\t\t\tcase bw_def_side_by_side:\n\t\t\t\tdata->source_width_pixels[i] = bw_mul(bw_int_to_fixed(2), data->src_width_after_rotation);\n\t\t\t\tdata->source_height_pixels = data->src_height_after_rotation;\n\t\t\t\tdata->hsr_after_stereo = bw_mul(bw_int_to_fixed(1), data->hsr_after_rotation);\n\t\t\t\tdata->vsr_after_stereo = data->vsr_after_rotation;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdata->source_width_pixels[i] = data->src_width_after_rotation;\n\t\t\t\tdata->source_height_pixels = data->src_height_after_rotation;\n\t\t\t\tdata->hsr_after_stereo = data->hsr_after_rotation;\n\t\t\t\tdata->vsr_after_stereo = data->vsr_after_rotation;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdata->hsr[i] = data->hsr_after_stereo;\n\t\t\tif (data->interlace_mode[i]) {\n\t\t\t\tdata->vsr[i] = bw_mul(data->vsr_after_stereo, bw_int_to_fixed(2));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->vsr[i] = data->vsr_after_stereo;\n\t\t\t}\n\t\t\tif (data->panning_and_bezel_adjustment != bw_def_none) {\n\t\t\t\tdata->source_width_rounded_up_to_chunks[i] = bw_add(bw_floor2(bw_sub(data->source_width_pixels[i], bw_int_to_fixed(1)), bw_int_to_fixed(128)), bw_int_to_fixed(256));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->source_width_rounded_up_to_chunks[i] = bw_ceil2(data->source_width_pixels[i], bw_int_to_fixed(128));\n\t\t\t}\n\t\t\tdata->source_height_rounded_up_to_chunks[i] = data->source_height_pixels;\n\t\t}\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tif (dceip->number_of_graphics_pipes >= data->number_of_displays && dceip->number_of_underlay_pipes >= data->number_of_underlay_surfaces && !(dceip->display_write_back_supported == 0 && data->d1_display_write_back_dwb_enable == 1)) {\n\t\tpipe_check = bw_def_ok;\n\t}\n\telse {\n\t\tpipe_check = bw_def_notok;\n\t}\n\thsr_check = bw_def_ok;\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (bw_neq(data->hsr[i], bw_int_to_fixed(1))) {\n\t\t\t\tif (bw_mtn(data->hsr[i], bw_int_to_fixed(4))) {\n\t\t\t\t\thsr_check = bw_def_hsr_mtn_4;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (bw_mtn(data->hsr[i], data->h_taps[i])) {\n\t\t\t\t\t\thsr_check = bw_def_hsr_mtn_h_taps;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tif (dceip->pre_downscaler_enabled == 1 && bw_mtn(data->hsr[i], bw_int_to_fixed(1)) && bw_leq(data->hsr[i], bw_ceil2(bw_div(data->h_taps[i], bw_int_to_fixed(4)), bw_int_to_fixed(1)))) {\n\t\t\t\t\t\t\thsr_check = bw_def_ceiling__h_taps_div_4___meq_hsr;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tvsr_check = bw_def_ok;\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (bw_neq(data->vsr[i], bw_int_to_fixed(1))) {\n\t\t\t\tif (bw_mtn(data->vsr[i], bw_int_to_fixed(4))) {\n\t\t\t\t\tvsr_check = bw_def_vsr_mtn_4;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (bw_mtn(data->vsr[i], data->v_taps[i])) {\n\t\t\t\t\t\tvsr_check = bw_def_vsr_mtn_v_taps;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tlb_size_check = bw_def_ok;\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif ((dceip->pre_downscaler_enabled && bw_mtn(data->hsr[i], bw_int_to_fixed(1)))) {\n\t\t\t\tdata->source_width_in_lb = bw_div(data->source_width_pixels[i], data->hsr[i]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->source_width_in_lb = data->source_width_pixels[i];\n\t\t\t}\n\t\t\tswitch (data->lb_bpc[i]) {\n\t\t\tcase 8:\n\t\t\t\tdata->lb_line_pitch = bw_ceil2(bw_mul(bw_div(bw_frc_to_fixed(2401171875ul, 100000000), bw_int_to_fixed(3)), bw_ceil2(data->source_width_in_lb, bw_int_to_fixed(8))), bw_int_to_fixed(48));\n\t\t\t\tbreak;\n\t\t\tcase 10:\n\t\t\t\tdata->lb_line_pitch = bw_ceil2(bw_mul(bw_div(bw_frc_to_fixed(300234375, 10000000), bw_int_to_fixed(3)), bw_ceil2(data->source_width_in_lb, bw_int_to_fixed(8))), bw_int_to_fixed(48));\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdata->lb_line_pitch = bw_ceil2(bw_mul(bw_int_to_fixed(data->lb_bpc[i]), data->source_width_in_lb), bw_int_to_fixed(48));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdata->lb_partitions[i] = bw_floor2(bw_div(data->lb_size_per_component[i], data->lb_line_pitch), bw_int_to_fixed(1));\n\t\t\t \n\t\t\tif ((surface_type[i] != bw_def_graphics || dceip->graphics_lb_nodownscaling_multi_line_prefetching == 1)) {\n\t\t\t\tdata->lb_partitions_max[i] = bw_int_to_fixed(10);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->lb_partitions_max[i] = bw_int_to_fixed(7);\n\t\t\t}\n\t\t\tdata->lb_partitions[i] = bw_min2(data->lb_partitions_max[i], data->lb_partitions[i]);\n\t\t\tif (bw_mtn(bw_add(data->v_taps[i], bw_int_to_fixed(1)), data->lb_partitions[i])) {\n\t\t\t\tlb_size_check = bw_def_notok;\n\t\t\t}\n\t\t}\n\t}\n\tfbc_check = bw_def_ok;\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i] && data->fbc_en[i] == 1 && (bw_equ(data->rotation_angle[i], bw_int_to_fixed(90)) || bw_equ(data->rotation_angle[i], bw_int_to_fixed(270)) || data->stereo_mode[i] != bw_def_mono || data->bytes_per_pixel[i] != 4)) {\n\t\t\tfbc_check = bw_def_invalid_rotation_or_bpp_or_stereo;\n\t\t}\n\t}\n\trotation_check = bw_def_ok;\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif ((bw_equ(data->rotation_angle[i], bw_int_to_fixed(90)) || bw_equ(data->rotation_angle[i], bw_int_to_fixed(270))) && (tiling_mode[i] == bw_def_linear || data->stereo_mode[i] != bw_def_mono)) {\n\t\t\t\trotation_check = bw_def_invalid_linear_or_stereo_mode;\n\t\t\t}\n\t\t}\n\t}\n\tif (pipe_check == bw_def_ok && hsr_check == bw_def_ok && vsr_check == bw_def_ok && lb_size_check == bw_def_ok && fbc_check == bw_def_ok && rotation_check == bw_def_ok) {\n\t\tmode_check = bw_def_ok;\n\t}\n\telse {\n\t\tmode_check = bw_def_notok;\n\t}\n\t \n\tdata->number_of_dram_wrchannels = vbios->number_of_dram_channels;\n\tdata->number_of_dram_channels = vbios->number_of_dram_channels;\n\t \n\t \n\t \n\t \n\t \n\tif ((fbc_enabled == 1 && lpt_enabled == 1)) {\n\t\tif (vbios->memory_type == bw_def_hbm)\n\t\t\tdata->dram_efficiency = bw_frc_to_fixed(5, 10);\n\t\telse\n\t\t\tdata->dram_efficiency = bw_int_to_fixed(1);\n\n\n\t\tif (dceip->low_power_tiling_mode == 0) {\n\t\t\tdata->number_of_dram_channels = 1;\n\t\t}\n\t\telse if (dceip->low_power_tiling_mode == 1) {\n\t\t\tdata->number_of_dram_channels = 2;\n\t\t}\n\t\telse if (dceip->low_power_tiling_mode == 2) {\n\t\t\tdata->number_of_dram_channels = 4;\n\t\t}\n\t\telse {\n\t\t\tdata->number_of_dram_channels = 1;\n\t\t}\n\t}\n\telse {\n\t\tif (vbios->memory_type == bw_def_hbm)\n\t\t\tdata->dram_efficiency = bw_frc_to_fixed(5, 10);\n\t\telse\n\t\t\tdata->dram_efficiency = bw_frc_to_fixed(8, 10);\n\t}\n\t \n\t \n\t \n\t \n\t \n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif ((bw_equ(data->rotation_angle[i], bw_int_to_fixed(90)) || bw_equ(data->rotation_angle[i], bw_int_to_fixed(270)))) {\n\t\t\t\tif ((i < 4)) {\n\t\t\t\t\t \n\t\t\t\t\tdata->orthogonal_rotation[i] = 1;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t \n\t\t\t\t\tif (data->graphics_micro_tile_mode == bw_def_rotated_micro_tiling) {\n\t\t\t\t\t\tdata->orthogonal_rotation[i] = 0;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdata->orthogonal_rotation[i] = 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif ((i < 4)) {\n\t\t\t\t\t \n\t\t\t\t\tif (data->underlay_micro_tile_mode == bw_def_display_micro_tiling) {\n\t\t\t\t\t\tdata->orthogonal_rotation[i] = 0;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdata->orthogonal_rotation[i] = 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t \n\t\t\t\t\tif (data->graphics_micro_tile_mode == bw_def_display_micro_tiling) {\n\t\t\t\t\t\tdata->orthogonal_rotation[i] = 0;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdata->orthogonal_rotation[i] = 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (bw_equ(data->rotation_angle[i], bw_int_to_fixed(90)) || bw_equ(data->rotation_angle[i], bw_int_to_fixed(270))) {\n\t\t\t\tdata->underlay_maximum_source_efficient_for_tiling = dceip->underlay_maximum_height_efficient_for_tiling;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->underlay_maximum_source_efficient_for_tiling = dceip->underlay_maximum_width_efficient_for_tiling;\n\t\t\t}\n\t\t\tif (surface_type[i] == bw_def_display_write_back420_luma || surface_type[i] == bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\tdata->useful_bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(1);\n\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(1);\n\t\t\t}\n\t\t\telse if (tiling_mode[i] == bw_def_linear) {\n\t\t\t\tdata->bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\tdata->useful_bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(2);\n\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(2);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (surface_type[i] == bw_def_graphics || (bw_mtn(data->source_width_rounded_up_to_chunks[i], bw_ceil2(data->underlay_maximum_source_efficient_for_tiling, bw_int_to_fixed(256))))) {\n\t\t\t\t\tswitch (data->bytes_per_pixel[i]) {\n\t\t\t\t\tcase 8:\n\t\t\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\tif (data->orthogonal_rotation[i]) {\n\t\t\t\t\t\t\tdata->bytes_per_request[i] = bw_int_to_fixed(32);\n\t\t\t\t\t\t\tdata->useful_bytes_per_request[i] = bw_int_to_fixed(32);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tdata->bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\t\t\t\tdata->useful_bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 4:\n\t\t\t\t\t\tif (data->orthogonal_rotation[i]) {\n\t\t\t\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\t\tdata->bytes_per_request[i] = bw_int_to_fixed(32);\n\t\t\t\t\t\t\tdata->useful_bytes_per_request[i] = bw_int_to_fixed(16);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\t\tdata->bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\t\t\t\tdata->useful_bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 2:\n\t\t\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\tdata->bytes_per_request[i] = bw_int_to_fixed(32);\n\t\t\t\t\t\tdata->useful_bytes_per_request[i] = bw_int_to_fixed(32);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\tdata->bytes_per_request[i] = bw_int_to_fixed(32);\n\t\t\t\t\t\tdata->useful_bytes_per_request[i] = bw_int_to_fixed(16);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tdata->bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\t\tdata->useful_bytes_per_request[i] = bw_int_to_fixed(64);\n\t\t\t\t\tif (data->orthogonal_rotation[i]) {\n\t\t\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(8);\n\t\t\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(4);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tswitch (data->bytes_per_pixel[i]) {\n\t\t\t\t\t\tcase 4:\n\t\t\t\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(2);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 2:\n\t\t\t\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(4);\n\t\t\t\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(4);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tdata->lines_interleaved_in_mem_access[i] = bw_int_to_fixed(8);\n\t\t\t\t\t\t\tdata->latency_hiding_lines[i] = bw_int_to_fixed(4);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tdata->v_filter_init[i] = bw_floor2(bw_div((bw_add(bw_add(bw_add(bw_int_to_fixed(1), data->v_taps[i]), data->vsr[i]), bw_mul(bw_mul(bw_int_to_fixed(data->interlace_mode[i]), bw_frc_to_fixed(5, 10)), data->vsr[i]))), bw_int_to_fixed(2)), bw_int_to_fixed(1));\n\t\t\tif (data->panning_and_bezel_adjustment == bw_def_any_lines) {\n\t\t\t\tdata->v_filter_init[i] = bw_add(data->v_filter_init[i], bw_int_to_fixed(1));\n\t\t\t}\n\t\t\tif (data->stereo_mode[i] == bw_def_top_bottom) {\n\t\t\t\tdata->v_filter_init[i] = bw_min2(data->v_filter_init[i], bw_int_to_fixed(4));\n\t\t\t}\n\t\t\tif (data->stereo_mode[i] == bw_def_top_bottom) {\n\t\t\t\tdata->num_lines_at_frame_start = bw_int_to_fixed(1);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->num_lines_at_frame_start = bw_int_to_fixed(3);\n\t\t\t}\n\t\t\tif ((bw_mtn(data->vsr[i], bw_int_to_fixed(1)) && surface_type[i] == bw_def_graphics) || data->panning_and_bezel_adjustment == bw_def_any_lines) {\n\t\t\t\tdata->line_buffer_prefetch[i] = 0;\n\t\t\t}\n\t\t\telse if ((((dceip->underlay_downscale_prefetch_enabled == 1 && surface_type[i] != bw_def_graphics) || surface_type[i] == bw_def_graphics) && (bw_mtn(data->lb_partitions[i], bw_add(data->v_taps[i], bw_ceil2(data->vsr[i], bw_int_to_fixed(1))))))) {\n\t\t\t\tdata->line_buffer_prefetch[i] = 1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->line_buffer_prefetch[i] = 0;\n\t\t\t}\n\t\t\tdata->lb_lines_in_per_line_out_in_beginning_of_frame[i] = bw_div(bw_ceil2(data->v_filter_init[i], bw_int_to_fixed(dceip->lines_interleaved_into_lb)), data->num_lines_at_frame_start);\n\t\t\tif (data->line_buffer_prefetch[i] == 1) {\n\t\t\t\tdata->lb_lines_in_per_line_out_in_middle_of_frame[i] = bw_max2(bw_int_to_fixed(1), data->vsr[i]);\n\t\t\t}\n\t\t\telse if (bw_leq(data->vsr[i], bw_int_to_fixed(1))) {\n\t\t\t\tdata->lb_lines_in_per_line_out_in_middle_of_frame[i] = bw_int_to_fixed(1);\n\t\t\t} else if (bw_leq(data->vsr[i],\n\t\t\t\t\tbw_frc_to_fixed(4, 3))) {\n\t\t\t\tdata->lb_lines_in_per_line_out_in_middle_of_frame[i] = bw_div(bw_int_to_fixed(4), bw_int_to_fixed(3));\n\t\t\t} else if (bw_leq(data->vsr[i],\n\t\t\t\t\tbw_frc_to_fixed(6, 4))) {\n\t\t\t\tdata->lb_lines_in_per_line_out_in_middle_of_frame[i] = bw_div(bw_int_to_fixed(6), bw_int_to_fixed(4));\n\t\t\t}\n\t\t\telse if (bw_leq(data->vsr[i], bw_int_to_fixed(2))) {\n\t\t\t\tdata->lb_lines_in_per_line_out_in_middle_of_frame[i] = bw_int_to_fixed(2);\n\t\t\t}\n\t\t\telse if (bw_leq(data->vsr[i], bw_int_to_fixed(3))) {\n\t\t\t\tdata->lb_lines_in_per_line_out_in_middle_of_frame[i] = bw_int_to_fixed(3);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->lb_lines_in_per_line_out_in_middle_of_frame[i] = bw_int_to_fixed(4);\n\t\t\t}\n\t\t\tif (data->line_buffer_prefetch[i] == 1 || bw_equ(data->lb_lines_in_per_line_out_in_middle_of_frame[i], bw_int_to_fixed(2)) || bw_equ(data->lb_lines_in_per_line_out_in_middle_of_frame[i], bw_int_to_fixed(4))) {\n\t\t\t\tdata->horizontal_blank_and_chunk_granularity_factor[i] = bw_int_to_fixed(1);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->horizontal_blank_and_chunk_granularity_factor[i] = bw_div(data->h_total[i], (bw_div((bw_add(data->h_total[i], bw_div((bw_sub(data->source_width_pixels[i], bw_int_to_fixed(dceip->chunk_width))), data->hsr[i]))), bw_int_to_fixed(2))));\n\t\t\t}\n\t\t\tdata->request_bandwidth[i] = bw_div(bw_mul(bw_div(bw_mul(bw_div(bw_mul(bw_max2(data->lb_lines_in_per_line_out_in_beginning_of_frame[i], data->lb_lines_in_per_line_out_in_middle_of_frame[i]), data->source_width_rounded_up_to_chunks[i]), (bw_div(data->h_total[i], data->pixel_rate[i]))), bw_int_to_fixed(data->bytes_per_pixel[i])), data->useful_bytes_per_request[i]), data->lines_interleaved_in_mem_access[i]), data->latency_hiding_lines[i]);\n\t\t\tdata->display_bandwidth[i] = bw_mul(data->request_bandwidth[i], data->bytes_per_request[i]);\n\t\t}\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif ((dceip->dmif_pipe_en_fbc_chunk_tracker + 3 == i && fbc_enabled == 0 && tiling_mode[i] != bw_def_linear)) {\n\t\t\t\tdata->max_chunks_non_fbc_mode[i] = 128 - dmif_chunk_buff_margin;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->max_chunks_non_fbc_mode[i] = 16 - dmif_chunk_buff_margin;\n\t\t\t}\n\t\t}\n\t\tif (data->fbc_en[i] == 1) {\n\t\t\tmax_chunks_fbc_mode = 128 - dmif_chunk_buff_margin;\n\t\t}\n\t}\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tswitch (surface_type[i]) {\n\t\t\tcase bw_def_display_write_back420_luma:\n\t\t\t\tdata->data_buffer_size[i] = bw_int_to_fixed(dceip->display_write_back420_luma_mcifwr_buffer_size);\n\t\t\t\tbreak;\n\t\t\tcase bw_def_display_write_back420_chroma:\n\t\t\t\tdata->data_buffer_size[i] = bw_int_to_fixed(dceip->display_write_back420_chroma_mcifwr_buffer_size);\n\t\t\t\tbreak;\n\t\t\tcase bw_def_underlay420_luma:\n\t\t\t\tdata->data_buffer_size[i] = bw_int_to_fixed(dceip->underlay_luma_dmif_size);\n\t\t\t\tbreak;\n\t\t\tcase bw_def_underlay420_chroma:\n\t\t\t\tdata->data_buffer_size[i] = bw_div(bw_int_to_fixed(dceip->underlay_chroma_dmif_size), bw_int_to_fixed(2));\n\t\t\t\tbreak;\n\t\t\tcase bw_def_underlay422:case bw_def_underlay444:\n\t\t\t\tif (data->orthogonal_rotation[i] == 0) {\n\t\t\t\t\tdata->data_buffer_size[i] = bw_int_to_fixed(dceip->underlay_luma_dmif_size);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tdata->data_buffer_size[i] = bw_add(bw_int_to_fixed(dceip->underlay_luma_dmif_size), bw_int_to_fixed(dceip->underlay_chroma_dmif_size));\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tif (data->fbc_en[i] == 1) {\n\t\t\t\t\t \n\t\t\t\t\tif (data->number_of_displays == 1) {\n\t\t\t\t\t\tdata->data_buffer_size[i] = bw_min2(bw_mul(bw_mul(bw_int_to_fixed(max_chunks_fbc_mode), bw_int_to_fixed(pixels_per_chunk)), bw_int_to_fixed(data->bytes_per_pixel[i])), bw_mul(bw_int_to_fixed(dceip->max_dmif_buffer_allocated), bw_int_to_fixed(dceip->graphics_dmif_size)));\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdata->data_buffer_size[i] = bw_min2(bw_mul(bw_mul(bw_int_to_fixed(max_chunks_fbc_mode), bw_int_to_fixed(pixels_per_chunk)), bw_int_to_fixed(data->bytes_per_pixel[i])), bw_int_to_fixed(dceip->graphics_dmif_size));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t \n\t\t\t\t\tif (data->number_of_displays == 1) {\n\t\t\t\t\t\tdata->data_buffer_size[i] = bw_min2(bw_mul(bw_mul(bw_int_to_fixed(data->max_chunks_non_fbc_mode[i]), bw_int_to_fixed(pixels_per_chunk)), bw_int_to_fixed(data->bytes_per_pixel[i])), bw_mul(bw_int_to_fixed(dceip->max_dmif_buffer_allocated), bw_int_to_fixed(dceip->graphics_dmif_size)));\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdata->data_buffer_size[i] = bw_min2(bw_mul(bw_mul(bw_int_to_fixed(data->max_chunks_non_fbc_mode[i]), bw_int_to_fixed(pixels_per_chunk)), bw_int_to_fixed(data->bytes_per_pixel[i])), bw_int_to_fixed(dceip->graphics_dmif_size));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (surface_type[i] == bw_def_display_write_back420_luma || surface_type[i] == bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->memory_chunk_size_in_bytes[i] = bw_int_to_fixed(1024);\n\t\t\t\tdata->pipe_chunk_size_in_bytes[i] = bw_int_to_fixed(1024);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->memory_chunk_size_in_bytes[i] = bw_mul(bw_mul(bw_int_to_fixed(dceip->chunk_width), data->lines_interleaved_in_mem_access[i]), bw_int_to_fixed(data->bytes_per_pixel[i]));\n\t\t\t\tdata->pipe_chunk_size_in_bytes[i] = bw_mul(bw_mul(bw_int_to_fixed(dceip->chunk_width), bw_int_to_fixed(dceip->lines_interleaved_into_lb)), bw_int_to_fixed(data->bytes_per_pixel[i]));\n\t\t\t}\n\t\t}\n\t}\n\tdata->min_dmif_size_in_time = bw_int_to_fixed(9999);\n\tdata->min_mcifwr_size_in_time = bw_int_to_fixed(9999);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma) {\n\t\t\t\tif (bw_ltn(bw_div(bw_div(bw_mul(data->data_buffer_size[i], data->bytes_per_request[i]), data->useful_bytes_per_request[i]), data->display_bandwidth[i]), data->min_dmif_size_in_time)) {\n\t\t\t\t\tdata->min_dmif_size_in_time = bw_div(bw_div(bw_mul(data->data_buffer_size[i], data->bytes_per_request[i]), data->useful_bytes_per_request[i]), data->display_bandwidth[i]);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (bw_ltn(bw_div(bw_div(bw_mul(data->data_buffer_size[i], data->bytes_per_request[i]), data->useful_bytes_per_request[i]), data->display_bandwidth[i]), data->min_mcifwr_size_in_time)) {\n\t\t\t\t\tdata->min_mcifwr_size_in_time = bw_div(bw_div(bw_mul(data->data_buffer_size[i], data->bytes_per_request[i]), data->useful_bytes_per_request[i]), data->display_bandwidth[i]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tdata->total_requests_for_dmif_size = bw_int_to_fixed(0);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i] && surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma) {\n\t\t\tdata->total_requests_for_dmif_size = bw_add(data->total_requests_for_dmif_size, bw_div(data->data_buffer_size[i], data->useful_bytes_per_request[i]));\n\t\t}\n\t}\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma && dceip->limit_excessive_outstanding_dmif_requests && (data->number_of_displays > 1 || bw_mtn(data->total_requests_for_dmif_size, dceip->dmif_request_buffer_size))) {\n\t\t\t\tdata->adjusted_data_buffer_size[i] = bw_min2(data->data_buffer_size[i], bw_ceil2(bw_mul(data->min_dmif_size_in_time, data->display_bandwidth[i]), data->memory_chunk_size_in_bytes[i]));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->adjusted_data_buffer_size[i] = data->data_buffer_size[i];\n\t\t\t}\n\t\t}\n\t}\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (data->number_of_displays == 1 && data->number_of_underlay_surfaces == 0) {\n\t\t\t\t \n\t\t\t\tdata->outstanding_chunk_request_limit[i] = bw_int_to_fixed(127);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->outstanding_chunk_request_limit[i] = bw_ceil2(bw_div(data->adjusted_data_buffer_size[i], data->pipe_chunk_size_in_bytes[i]), bw_int_to_fixed(1));\n\t\t\t\t \n\t\t\t\tif (i >= 4) {\n\t\t\t\t\tdata->outstanding_chunk_request_limit[i] = bw_max2(bw_int_to_fixed(127), data->outstanding_chunk_request_limit[i]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tif (data->number_of_displays > 1 || (bw_neq(data->rotation_angle[4], bw_int_to_fixed(0)) && bw_neq(data->rotation_angle[4], bw_int_to_fixed(180)))) {\n\t\tdata->peak_pte_request_to_eviction_ratio_limiting = dceip->peak_pte_request_to_eviction_ratio_limiting_multiple_displays_or_single_rotated_display;\n\t}\n\telse {\n\t\tdata->peak_pte_request_to_eviction_ratio_limiting = dceip->peak_pte_request_to_eviction_ratio_limiting_single_display_no_rotation;\n\t}\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i] && data->scatter_gather_enable_for_pipe[i] == 1) {\n\t\t\tif (tiling_mode[i] == bw_def_linear) {\n\t\t\t\tdata->useful_pte_per_pte_request = bw_int_to_fixed(8);\n\t\t\t\tdata->scatter_gather_page_width[i] = bw_div(bw_int_to_fixed(4096), bw_int_to_fixed(data->bytes_per_pixel[i]));\n\t\t\t\tdata->scatter_gather_page_height[i] = bw_int_to_fixed(1);\n\t\t\t\tdata->scatter_gather_pte_request_rows = bw_int_to_fixed(1);\n\t\t\t\tdata->scatter_gather_row_height = bw_int_to_fixed(dceip->scatter_gather_lines_of_pte_prefetching_in_linear_mode);\n\t\t\t}\n\t\t\telse if (bw_equ(data->rotation_angle[i], bw_int_to_fixed(0)) || bw_equ(data->rotation_angle[i], bw_int_to_fixed(180))) {\n\t\t\t\tdata->useful_pte_per_pte_request = bw_int_to_fixed(8);\n\t\t\t\tswitch (data->bytes_per_pixel[i]) {\n\t\t\t\tcase 4:\n\t\t\t\t\tdata->scatter_gather_page_width[i] = bw_int_to_fixed(32);\n\t\t\t\t\tdata->scatter_gather_page_height[i] = bw_int_to_fixed(32);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\tdata->scatter_gather_page_width[i] = bw_int_to_fixed(64);\n\t\t\t\t\tdata->scatter_gather_page_height[i] = bw_int_to_fixed(32);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tdata->scatter_gather_page_width[i] = bw_int_to_fixed(64);\n\t\t\t\t\tdata->scatter_gather_page_height[i] = bw_int_to_fixed(64);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdata->scatter_gather_pte_request_rows = bw_int_to_fixed(dceip->scatter_gather_pte_request_rows_in_tiling_mode);\n\t\t\t\tdata->scatter_gather_row_height = data->scatter_gather_page_height[i];\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->useful_pte_per_pte_request = bw_int_to_fixed(1);\n\t\t\t\tswitch (data->bytes_per_pixel[i]) {\n\t\t\t\tcase 4:\n\t\t\t\t\tdata->scatter_gather_page_width[i] = bw_int_to_fixed(32);\n\t\t\t\t\tdata->scatter_gather_page_height[i] = bw_int_to_fixed(32);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\tdata->scatter_gather_page_width[i] = bw_int_to_fixed(32);\n\t\t\t\t\tdata->scatter_gather_page_height[i] = bw_int_to_fixed(64);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tdata->scatter_gather_page_width[i] = bw_int_to_fixed(64);\n\t\t\t\t\tdata->scatter_gather_page_height[i] = bw_int_to_fixed(64);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdata->scatter_gather_pte_request_rows = bw_int_to_fixed(dceip->scatter_gather_pte_request_rows_in_tiling_mode);\n\t\t\t\tdata->scatter_gather_row_height = data->scatter_gather_page_height[i];\n\t\t\t}\n\t\t\tdata->pte_request_per_chunk[i] = bw_div(bw_div(bw_int_to_fixed(dceip->chunk_width), data->scatter_gather_page_width[i]), data->useful_pte_per_pte_request);\n\t\t\tdata->scatter_gather_pte_requests_in_row[i] = bw_div(bw_mul(bw_ceil2(bw_mul(bw_div(data->source_width_rounded_up_to_chunks[i], bw_int_to_fixed(dceip->chunk_width)), data->pte_request_per_chunk[i]), bw_int_to_fixed(1)), data->scatter_gather_row_height), data->scatter_gather_page_height[i]);\n\t\t\tdata->scatter_gather_pte_requests_in_vblank = bw_mul(data->scatter_gather_pte_request_rows, data->scatter_gather_pte_requests_in_row[i]);\n\t\t\tif (bw_equ(data->peak_pte_request_to_eviction_ratio_limiting, bw_int_to_fixed(0))) {\n\t\t\t\tdata->scatter_gather_pte_request_limit[i] = data->scatter_gather_pte_requests_in_vblank;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->scatter_gather_pte_request_limit[i] = bw_max2(dceip->minimum_outstanding_pte_request_limit, bw_min2(data->scatter_gather_pte_requests_in_vblank, bw_ceil2(bw_mul(bw_mul(bw_div(bw_ceil2(data->adjusted_data_buffer_size[i], data->memory_chunk_size_in_bytes[i]), data->memory_chunk_size_in_bytes[i]), data->pte_request_per_chunk[i]), data->peak_pte_request_to_eviction_ratio_limiting), bw_int_to_fixed(1))));\n\t\t\t}\n\t\t}\n\t}\n\t \n\t \n\t \n\tdata->inefficient_linear_pitch_in_bytes = bw_mul(bw_mul(bw_int_to_fixed(256), bw_int_to_fixed(vbios->number_of_dram_banks)), bw_int_to_fixed(data->number_of_dram_channels));\n\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tdata->cursor_total_data = bw_int_to_fixed(0);\n\tdata->cursor_total_request_groups = bw_int_to_fixed(0);\n\tdata->scatter_gather_total_pte_requests = bw_int_to_fixed(0);\n\tdata->scatter_gather_total_pte_request_groups = bw_int_to_fixed(0);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tdata->cursor_total_data = bw_add(data->cursor_total_data, bw_mul(bw_mul(bw_int_to_fixed(2), data->cursor_width_pixels[i]), bw_int_to_fixed(4)));\n\t\t\tif (dceip->large_cursor == 1) {\n\t\t\t\tdata->cursor_total_request_groups = bw_add(data->cursor_total_request_groups, bw_int_to_fixed((dceip->cursor_max_outstanding_group_num + 1)));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->cursor_total_request_groups = bw_add(data->cursor_total_request_groups, bw_ceil2(bw_div(data->cursor_width_pixels[i], dceip->cursor_chunk_width), bw_int_to_fixed(1)));\n\t\t\t}\n\t\t\tif (data->scatter_gather_enable_for_pipe[i]) {\n\t\t\t\tdata->scatter_gather_total_pte_requests = bw_add(data->scatter_gather_total_pte_requests, data->scatter_gather_pte_request_limit[i]);\n\t\t\t\tdata->scatter_gather_total_pte_request_groups = bw_add(data->scatter_gather_total_pte_request_groups, bw_ceil2(bw_div(data->scatter_gather_pte_request_limit[i], bw_ceil2(data->pte_request_per_chunk[i], bw_int_to_fixed(1))), bw_int_to_fixed(1)));\n\t\t\t}\n\t\t}\n\t}\n\tdata->tile_width_in_pixels = bw_int_to_fixed(8);\n\tdata->dmif_total_number_of_data_request_page_close_open = bw_int_to_fixed(0);\n\tdata->mcifwr_total_number_of_data_request_page_close_open = bw_int_to_fixed(0);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (data->scatter_gather_enable_for_pipe[i] == 1 && tiling_mode[i] != bw_def_linear) {\n\t\t\t\tdata->bytes_per_page_close_open = bw_mul(data->lines_interleaved_in_mem_access[i], bw_max2(bw_mul(bw_mul(bw_mul(bw_int_to_fixed(data->bytes_per_pixel[i]), data->tile_width_in_pixels), bw_int_to_fixed(vbios->number_of_dram_banks)), bw_int_to_fixed(data->number_of_dram_channels)), bw_mul(bw_int_to_fixed(data->bytes_per_pixel[i]), data->scatter_gather_page_width[i])));\n\t\t\t}\n\t\t\telse if (data->scatter_gather_enable_for_pipe[i] == 1 && tiling_mode[i] == bw_def_linear && bw_equ(bw_mod((bw_mul(data->pitch_in_pixels_after_surface_type[i], bw_int_to_fixed(data->bytes_per_pixel[i]))), data->inefficient_linear_pitch_in_bytes), bw_int_to_fixed(0))) {\n\t\t\t\tdata->bytes_per_page_close_open = dceip->linear_mode_line_request_alternation_slice;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->bytes_per_page_close_open = data->memory_chunk_size_in_bytes[i];\n\t\t\t}\n\t\t\tif (surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->dmif_total_number_of_data_request_page_close_open = bw_add(data->dmif_total_number_of_data_request_page_close_open, bw_div(bw_ceil2(data->adjusted_data_buffer_size[i], data->memory_chunk_size_in_bytes[i]), data->bytes_per_page_close_open));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->mcifwr_total_number_of_data_request_page_close_open = bw_add(data->mcifwr_total_number_of_data_request_page_close_open, bw_div(bw_ceil2(data->adjusted_data_buffer_size[i], data->memory_chunk_size_in_bytes[i]), data->bytes_per_page_close_open));\n\t\t\t}\n\t\t}\n\t}\n\tdata->dmif_total_page_close_open_time = bw_div(bw_mul((bw_add(bw_add(data->dmif_total_number_of_data_request_page_close_open, data->scatter_gather_total_pte_request_groups), data->cursor_total_request_groups)), vbios->trc), bw_int_to_fixed(1000));\n\tdata->mcifwr_total_page_close_open_time = bw_div(bw_mul(data->mcifwr_total_number_of_data_request_page_close_open, vbios->trc), bw_int_to_fixed(1000));\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tdata->adjusted_data_buffer_size_in_memory[i] = bw_div(bw_mul(data->adjusted_data_buffer_size[i], data->bytes_per_request[i]), data->useful_bytes_per_request[i]);\n\t\t}\n\t}\n\tdata->total_requests_for_adjusted_dmif_size = bw_int_to_fixed(0);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->total_requests_for_adjusted_dmif_size = bw_add(data->total_requests_for_adjusted_dmif_size, bw_div(data->adjusted_data_buffer_size[i], data->useful_bytes_per_request[i]));\n\t\t\t}\n\t\t}\n\t}\n\tdata->total_dmifmc_urgent_trips = bw_ceil2(bw_div(data->total_requests_for_adjusted_dmif_size, (bw_add(dceip->dmif_request_buffer_size, bw_int_to_fixed(vbios->number_of_request_slots_gmc_reserves_for_dmif_per_channel * data->number_of_dram_channels)))), bw_int_to_fixed(1));\n\tdata->total_dmifmc_urgent_latency = bw_mul(vbios->dmifmc_urgent_latency, data->total_dmifmc_urgent_trips);\n\tdata->total_display_reads_required_data = bw_int_to_fixed(0);\n\tdata->total_display_reads_required_dram_access_data = bw_int_to_fixed(0);\n\tdata->total_display_writes_required_data = bw_int_to_fixed(0);\n\tdata->total_display_writes_required_dram_access_data = bw_int_to_fixed(0);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->display_reads_required_data = data->adjusted_data_buffer_size_in_memory[i];\n\t\t\t\t \n\t\t\t\t \n\t\t\t\t \n\t\t\t\t \n\t\t\t\t \n\t\t\t\t \n\t\t\t\t \n\t\t\t\t \n\t\t\t\t \n\t\t\t\t \n\t\t\t\tif (vbios->memory_type == bw_def_hbm) {\n\t\t\t\t\tdata->display_reads_required_dram_access_data = data->adjusted_data_buffer_size_in_memory[i];\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tdata->display_reads_required_dram_access_data = bw_mul(data->adjusted_data_buffer_size_in_memory[i], bw_ceil2(bw_div(bw_int_to_fixed((8 * vbios->dram_channel_width_in_bits / 8)), data->bytes_per_request[i]), bw_int_to_fixed(1)));\n\t\t\t\t}\n\t\t\t\tdata->total_display_reads_required_data = bw_add(data->total_display_reads_required_data, data->display_reads_required_data);\n\t\t\t\tdata->total_display_reads_required_dram_access_data = bw_add(data->total_display_reads_required_dram_access_data, data->display_reads_required_dram_access_data);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->total_display_writes_required_data = bw_add(data->total_display_writes_required_data, data->adjusted_data_buffer_size_in_memory[i]);\n\t\t\t\tdata->total_display_writes_required_dram_access_data = bw_add(data->total_display_writes_required_dram_access_data, bw_mul(data->adjusted_data_buffer_size_in_memory[i], bw_ceil2(bw_div(bw_int_to_fixed(vbios->dram_channel_width_in_bits), data->bytes_per_request[i]), bw_int_to_fixed(1))));\n\t\t\t}\n\t\t}\n\t}\n\tdata->total_display_reads_required_data = bw_add(bw_add(data->total_display_reads_required_data, data->cursor_total_data), bw_mul(data->scatter_gather_total_pte_requests, bw_int_to_fixed(64)));\n\tdata->total_display_reads_required_dram_access_data = bw_add(bw_add(data->total_display_reads_required_dram_access_data, data->cursor_total_data), bw_mul(data->scatter_gather_total_pte_requests, bw_int_to_fixed(64)));\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (bw_mtn(data->v_filter_init[i], bw_int_to_fixed(4))) {\n\t\t\t\tdata->src_pixels_for_first_output_pixel[i] = bw_mul(bw_int_to_fixed(4), data->source_width_rounded_up_to_chunks[i]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (bw_mtn(data->v_filter_init[i], bw_int_to_fixed(2))) {\n\t\t\t\t\tdata->src_pixels_for_first_output_pixel[i] = bw_int_to_fixed(512);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tdata->src_pixels_for_first_output_pixel[i] = bw_int_to_fixed(0);\n\t\t\t\t}\n\t\t\t}\n\t\t\tdata->src_data_for_first_output_pixel[i] = bw_div(bw_mul(bw_mul(data->src_pixels_for_first_output_pixel[i], bw_int_to_fixed(data->bytes_per_pixel[i])), data->bytes_per_request[i]), data->useful_bytes_per_request[i]);\n\t\t\tdata->src_pixels_for_last_output_pixel[i] = bw_mul(data->source_width_rounded_up_to_chunks[i], bw_max2(bw_ceil2(data->v_filter_init[i], bw_int_to_fixed(dceip->lines_interleaved_into_lb)), bw_mul(bw_ceil2(data->vsr[i], bw_int_to_fixed(dceip->lines_interleaved_into_lb)), data->horizontal_blank_and_chunk_granularity_factor[i])));\n\t\t\tdata->src_data_for_last_output_pixel[i] = bw_div(bw_mul(bw_mul(bw_mul(data->source_width_rounded_up_to_chunks[i], bw_max2(bw_ceil2(data->v_filter_init[i], bw_int_to_fixed(dceip->lines_interleaved_into_lb)), data->lines_interleaved_in_mem_access[i])), bw_int_to_fixed(data->bytes_per_pixel[i])), data->bytes_per_request[i]), data->useful_bytes_per_request[i]);\n\t\t\tdata->active_time[i] = bw_div(bw_div(data->source_width_rounded_up_to_chunks[i], data->hsr[i]), data->pixel_rate[i]);\n\t\t}\n\t}\n\tfor (i = 0; i <= 2; i++) {\n\t\tfor (j = 0; j <= 7; j++) {\n\t\t\tdata->dmif_burst_time[i][j] = bw_max3(data->dmif_total_page_close_open_time, bw_div(data->total_display_reads_required_dram_access_data, (bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[i]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels)))), bw_div(data->total_display_reads_required_data, (bw_mul(bw_mul(sclk[j], vbios->data_return_bus_width), bw_frc_to_fixed(dceip->percent_of_ideal_port_bw_received_after_urgent_latency, 100)))));\n\t\t\tif (data->d1_display_write_back_dwb_enable == 1) {\n\t\t\t\tdata->mcifwr_burst_time[i][j] = bw_max3(data->mcifwr_total_page_close_open_time, bw_div(data->total_display_writes_required_dram_access_data, (bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[i]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_wrchannels)))), bw_div(data->total_display_writes_required_data, (bw_mul(sclk[j], vbios->data_return_bus_width))));\n\t\t\t}\n\t\t}\n\t}\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tfor (j = 0; j <= 2; j++) {\n\t\t\tfor (k = 0; k <= 7; k++) {\n\t\t\t\tif (data->enable[i]) {\n\t\t\t\t\tif (surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma) {\n\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\tdata->dmif_buffer_transfer_time[i] = bw_mul(data->source_width_rounded_up_to_chunks[i], (bw_div(dceip->lb_write_pixels_per_dispclk, (bw_div(vbios->low_voltage_max_dispclk, dceip->display_pipe_throughput_factor)))));\n\t\t\t\t\t\tdata->line_source_transfer_time[i][j][k] = bw_max2(bw_mul((bw_add(data->total_dmifmc_urgent_latency, data->dmif_burst_time[j][k])), bw_floor2(bw_div(data->src_data_for_first_output_pixel[i], data->adjusted_data_buffer_size_in_memory[i]), bw_int_to_fixed(1))), bw_sub(bw_add(bw_mul((bw_add(data->total_dmifmc_urgent_latency, data->dmif_burst_time[j][k])), bw_floor2(bw_div(data->src_data_for_last_output_pixel[i], data->adjusted_data_buffer_size_in_memory[i]), bw_int_to_fixed(1))), data->dmif_buffer_transfer_time[i]), data->active_time[i]));\n\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\tif (surface_type[i] == bw_def_graphics) {\n\t\t\t\t\t\t\tswitch (data->lb_bpc[i]) {\n\t\t\t\t\t\t\tcase 6:\n\t\t\t\t\t\t\t\tdata->v_scaler_efficiency = dceip->graphics_vscaler_efficiency6_bit_per_component;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 8:\n\t\t\t\t\t\t\t\tdata->v_scaler_efficiency = dceip->graphics_vscaler_efficiency8_bit_per_component;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 10:\n\t\t\t\t\t\t\t\tdata->v_scaler_efficiency = dceip->graphics_vscaler_efficiency10_bit_per_component;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tdata->v_scaler_efficiency = dceip->graphics_vscaler_efficiency12_bit_per_component;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (data->use_alpha[i] == 1) {\n\t\t\t\t\t\t\t\tdata->v_scaler_efficiency = bw_min2(data->v_scaler_efficiency, dceip->alpha_vscaler_efficiency);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tswitch (data->lb_bpc[i]) {\n\t\t\t\t\t\t\tcase 6:\n\t\t\t\t\t\t\t\tdata->v_scaler_efficiency = dceip->underlay_vscaler_efficiency6_bit_per_component;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 8:\n\t\t\t\t\t\t\t\tdata->v_scaler_efficiency = dceip->underlay_vscaler_efficiency8_bit_per_component;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 10:\n\t\t\t\t\t\t\t\tdata->v_scaler_efficiency = dceip->underlay_vscaler_efficiency10_bit_per_component;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tdata->v_scaler_efficiency = bw_int_to_fixed(3);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (dceip->pre_downscaler_enabled && bw_mtn(data->hsr[i], bw_int_to_fixed(1))) {\n\t\t\t\t\t\t\tdata->scaler_limits_factor = bw_max2(bw_div(data->v_taps[i], data->v_scaler_efficiency), bw_div(data->source_width_rounded_up_to_chunks[i], data->h_total[i]));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tdata->scaler_limits_factor = bw_max3(bw_int_to_fixed(1), bw_ceil2(bw_div(data->h_taps[i], bw_int_to_fixed(4)), bw_int_to_fixed(1)), bw_mul(data->hsr[i], bw_max2(bw_div(data->v_taps[i], data->v_scaler_efficiency), bw_int_to_fixed(1))));\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdata->dram_speed_change_line_source_transfer_time[i][j][k] = bw_mul(bw_int_to_fixed(2), bw_max2((bw_add((bw_div(data->src_data_for_first_output_pixel[i], bw_min2(bw_mul(data->bytes_per_request[i], sclk[k]), bw_div(bw_mul(bw_mul(data->bytes_per_request[i], data->pixel_rate[i]), data->scaler_limits_factor), bw_int_to_fixed(2))))), (bw_mul(data->dmif_burst_time[j][k], bw_floor2(bw_div(data->src_data_for_first_output_pixel[i], data->adjusted_data_buffer_size_in_memory[i]), bw_int_to_fixed(1)))))), (bw_add((bw_div(data->src_data_for_last_output_pixel[i], bw_min2(bw_mul(data->bytes_per_request[i], sclk[k]), bw_div(bw_mul(bw_mul(data->bytes_per_request[i], data->pixel_rate[i]), data->scaler_limits_factor), bw_int_to_fixed(2))))), (bw_sub(bw_mul(data->dmif_burst_time[j][k], bw_floor2(bw_div(data->src_data_for_last_output_pixel[i], data->adjusted_data_buffer_size_in_memory[i]), bw_int_to_fixed(1))), data->active_time[i]))))));\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdata->line_source_transfer_time[i][j][k] = bw_max2(bw_mul((bw_add(vbios->mcifwrmc_urgent_latency, data->mcifwr_burst_time[j][k])), bw_floor2(bw_div(data->src_data_for_first_output_pixel[i], data->adjusted_data_buffer_size_in_memory[i]), bw_int_to_fixed(1))), bw_sub(bw_mul((bw_add(vbios->mcifwrmc_urgent_latency, data->mcifwr_burst_time[j][k])), bw_floor2(bw_div(data->src_data_for_last_output_pixel[i], data->adjusted_data_buffer_size_in_memory[i]), bw_int_to_fixed(1))), data->active_time[i]));\n\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\tdata->dram_speed_change_line_source_transfer_time[i][j][k] = bw_max2((bw_add((bw_div(data->src_data_for_first_output_pixel[i], bw_min2(bw_mul(data->bytes_per_request[i], sclk[k]), bw_div(bw_mul(data->bytes_per_request[i], vbios->low_voltage_max_dispclk), bw_int_to_fixed(2))))), (bw_mul(data->mcifwr_burst_time[j][k], bw_floor2(bw_div(data->src_data_for_first_output_pixel[i], data->adjusted_data_buffer_size_in_memory[i]), bw_int_to_fixed(1)))))), (bw_add((bw_div(data->src_data_for_last_output_pixel[i], bw_min2(bw_mul(data->bytes_per_request[i], sclk[k]), bw_div(bw_mul(data->bytes_per_request[i], vbios->low_voltage_max_dispclk), bw_int_to_fixed(2))))), (bw_sub(bw_mul(data->mcifwr_burst_time[j][k], bw_floor2(bw_div(data->src_data_for_last_output_pixel[i], data->adjusted_data_buffer_size_in_memory[i]), bw_int_to_fixed(1))), data->active_time[i])))));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\n\t \n\tnumber_of_displays_enabled = 0;\n\tnumber_of_displays_enabled_with_margin = 0;\n\tfor (k = 0; k <= maximum_number_of_surfaces - 1; k++) {\n\t\tif (data->enable[k]) {\n\t\t\tnumber_of_displays_enabled = number_of_displays_enabled + 1;\n\t\t}\n\t\tdata->display_pstate_change_enable[k] = 0;\n\t}\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif ((bw_equ(dceip->stutter_and_dram_clock_state_change_gated_before_cursor, bw_int_to_fixed(0)) && bw_mtn(data->cursor_width_pixels[i], bw_int_to_fixed(0)))) {\n\t\t\t\tif (bw_ltn(data->vsr[i], bw_int_to_fixed(2))) {\n\t\t\t\t\tdata->cursor_latency_hiding[i] = bw_div(bw_div(bw_mul((bw_sub(dceip->cursor_dcp_buffer_lines, bw_int_to_fixed(1))), data->h_total[i]), data->vsr[i]), data->pixel_rate[i]);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tdata->cursor_latency_hiding[i] = bw_div(bw_div(bw_mul((bw_sub(dceip->cursor_dcp_buffer_lines, bw_int_to_fixed(3))), data->h_total[i]), data->vsr[i]), data->pixel_rate[i]);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->cursor_latency_hiding[i] = bw_int_to_fixed(9999);\n\t\t\t}\n\t\t}\n\t}\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (dceip->graphics_lb_nodownscaling_multi_line_prefetching == 1 && (bw_equ(data->vsr[i], bw_int_to_fixed(1)) || (bw_leq(data->vsr[i], bw_frc_to_fixed(8, 10)) && bw_leq(data->v_taps[i], bw_int_to_fixed(2)) && data->lb_bpc[i] == 8)) && surface_type[i] == bw_def_graphics) {\n\t\t\t\tif (number_of_displays_enabled > 2)\n\t\t\t\t\tdata->minimum_latency_hiding[i] = bw_sub(bw_div(bw_mul((bw_div((bw_add(bw_sub(data->lb_partitions[i], bw_int_to_fixed(2)), bw_div(bw_div(data->data_buffer_size[i], bw_int_to_fixed(data->bytes_per_pixel[i])), data->source_width_pixels[i]))), data->vsr[i])), data->h_total[i]), data->pixel_rate[i]), data->total_dmifmc_urgent_latency);\n\t\t\t\telse\n\t\t\t\t\tdata->minimum_latency_hiding[i] = bw_sub(bw_div(bw_mul((bw_div((bw_add(bw_sub(data->lb_partitions[i], bw_int_to_fixed(1)), bw_div(bw_div(data->data_buffer_size[i], bw_int_to_fixed(data->bytes_per_pixel[i])), data->source_width_pixels[i]))), data->vsr[i])), data->h_total[i]), data->pixel_rate[i]), data->total_dmifmc_urgent_latency);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->minimum_latency_hiding[i] = bw_sub(bw_div(bw_mul((bw_div((bw_add(bw_int_to_fixed(1 + data->line_buffer_prefetch[i]), bw_div(bw_div(data->data_buffer_size[i], bw_int_to_fixed(data->bytes_per_pixel[i])), data->source_width_pixels[i]))), data->vsr[i])), data->h_total[i]), data->pixel_rate[i]), data->total_dmifmc_urgent_latency);\n\t\t\t}\n\t\t\tdata->minimum_latency_hiding_with_cursor[i] = bw_min2(data->minimum_latency_hiding[i], data->cursor_latency_hiding[i]);\n\t\t}\n\t}\n\tfor (i = 0; i <= 2; i++) {\n\t\tfor (j = 0; j <= 7; j++) {\n\t\t\tdata->blackout_duration_margin[i][j] = bw_int_to_fixed(9999);\n\t\t\tdata->dispclk_required_for_blackout_duration[i][j] = bw_int_to_fixed(0);\n\t\t\tdata->dispclk_required_for_blackout_recovery[i][j] = bw_int_to_fixed(0);\n\t\t\tfor (k = 0; k <= maximum_number_of_surfaces - 1; k++) {\n\t\t\t\tif (data->enable[k] && bw_mtn(vbios->blackout_duration, bw_int_to_fixed(0))) {\n\t\t\t\t\tif (surface_type[k] != bw_def_display_write_back420_luma && surface_type[k] != bw_def_display_write_back420_chroma) {\n\t\t\t\t\t\tdata->blackout_duration_margin[i][j] = bw_min2(data->blackout_duration_margin[i][j], bw_sub(bw_sub(bw_sub(data->minimum_latency_hiding_with_cursor[k], vbios->blackout_duration), data->dmif_burst_time[i][j]), data->line_source_transfer_time[k][i][j]));\n\t\t\t\t\t\tdata->dispclk_required_for_blackout_duration[i][j] = bw_max3(data->dispclk_required_for_blackout_duration[i][j], bw_div(bw_div(bw_mul(data->src_pixels_for_first_output_pixel[k], dceip->display_pipe_throughput_factor), dceip->lb_write_pixels_per_dispclk), (bw_sub(bw_sub(data->minimum_latency_hiding_with_cursor[k], vbios->blackout_duration), data->dmif_burst_time[i][j]))), bw_div(bw_div(bw_mul(data->src_pixels_for_last_output_pixel[k], dceip->display_pipe_throughput_factor), dceip->lb_write_pixels_per_dispclk), (bw_add(bw_sub(bw_sub(data->minimum_latency_hiding_with_cursor[k], vbios->blackout_duration), data->dmif_burst_time[i][j]), data->active_time[k]))));\n\t\t\t\t\t\tif (bw_leq(vbios->maximum_blackout_recovery_time, bw_add(bw_mul(bw_int_to_fixed(2), data->total_dmifmc_urgent_latency), data->dmif_burst_time[i][j]))) {\n\t\t\t\t\t\t\tdata->dispclk_required_for_blackout_recovery[i][j] = bw_int_to_fixed(9999);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (bw_ltn(data->adjusted_data_buffer_size[k], bw_mul(bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k]), (bw_add(vbios->blackout_duration, bw_add(bw_mul(bw_int_to_fixed(2), data->total_dmifmc_urgent_latency), data->dmif_burst_time[i][j])))))) {\n\t\t\t\t\t\t\tdata->dispclk_required_for_blackout_recovery[i][j] = bw_max2(data->dispclk_required_for_blackout_recovery[i][j], bw_div(bw_mul(bw_div(bw_div((bw_sub(bw_mul(bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k]), (bw_add(vbios->blackout_duration, vbios->maximum_blackout_recovery_time))), data->adjusted_data_buffer_size[k])), bw_int_to_fixed(data->bytes_per_pixel[k])), (bw_sub(vbios->maximum_blackout_recovery_time, bw_sub(bw_mul(bw_int_to_fixed(2), data->total_dmifmc_urgent_latency), data->dmif_burst_time[i][j])))), data->latency_hiding_lines[k]), data->lines_interleaved_in_mem_access[k]));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdata->blackout_duration_margin[i][j] = bw_min2(data->blackout_duration_margin[i][j], bw_sub(bw_sub(bw_sub(bw_sub(data->minimum_latency_hiding_with_cursor[k], vbios->blackout_duration), data->dmif_burst_time[i][j]), data->mcifwr_burst_time[i][j]), data->line_source_transfer_time[k][i][j]));\n\t\t\t\t\t\tdata->dispclk_required_for_blackout_duration[i][j] = bw_max3(data->dispclk_required_for_blackout_duration[i][j], bw_div(bw_div(bw_mul(data->src_pixels_for_first_output_pixel[k], dceip->display_pipe_throughput_factor), dceip->lb_write_pixels_per_dispclk), (bw_sub(bw_sub(bw_sub(data->minimum_latency_hiding_with_cursor[k], vbios->blackout_duration), data->dmif_burst_time[i][j]), data->mcifwr_burst_time[i][j]))), bw_div(bw_div(bw_mul(data->src_pixels_for_last_output_pixel[k], dceip->display_pipe_throughput_factor), dceip->lb_write_pixels_per_dispclk), (bw_add(bw_sub(bw_sub(bw_sub(data->minimum_latency_hiding_with_cursor[k], vbios->blackout_duration), data->dmif_burst_time[i][j]), data->mcifwr_burst_time[i][j]), data->active_time[k]))));\n\t\t\t\t\t\tif (bw_ltn(vbios->maximum_blackout_recovery_time, bw_add(bw_add(bw_mul(bw_int_to_fixed(2), vbios->mcifwrmc_urgent_latency), data->dmif_burst_time[i][j]), data->mcifwr_burst_time[i][j]))) {\n\t\t\t\t\t\t\tdata->dispclk_required_for_blackout_recovery[i][j] = bw_int_to_fixed(9999);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (bw_ltn(data->adjusted_data_buffer_size[k], bw_mul(bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k]), (bw_add(vbios->blackout_duration, bw_add(bw_mul(bw_int_to_fixed(2), data->total_dmifmc_urgent_latency), data->dmif_burst_time[i][j])))))) {\n\t\t\t\t\t\t\tdata->dispclk_required_for_blackout_recovery[i][j] = bw_max2(data->dispclk_required_for_blackout_recovery[i][j], bw_div(bw_mul(bw_div(bw_div((bw_sub(bw_mul(bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k]), (bw_add(vbios->blackout_duration, vbios->maximum_blackout_recovery_time))), data->adjusted_data_buffer_size[k])), bw_int_to_fixed(data->bytes_per_pixel[k])), (bw_sub(vbios->maximum_blackout_recovery_time, (bw_add(bw_mul(bw_int_to_fixed(2), data->total_dmifmc_urgent_latency), data->dmif_burst_time[i][j]))))), data->latency_hiding_lines[k]), data->lines_interleaved_in_mem_access[k]));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tif (bw_mtn(data->blackout_duration_margin[high][s_high], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[high][s_high], vbios->high_voltage_max_dispclk)) {\n\t\tdata->cpup_state_change_enable = bw_def_yes;\n\t\tif (bw_ltn(data->dispclk_required_for_blackout_recovery[high][s_high], vbios->high_voltage_max_dispclk)) {\n\t\t\tdata->cpuc_state_change_enable = bw_def_yes;\n\t\t}\n\t\telse {\n\t\t\tdata->cpuc_state_change_enable = bw_def_no;\n\t\t}\n\t}\n\telse {\n\t\tdata->cpup_state_change_enable = bw_def_no;\n\t\tdata->cpuc_state_change_enable = bw_def_no;\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\t \n\t\t\t \n\t\t\tdata->maximum_latency_hiding[i] = bw_add(data->minimum_latency_hiding[i],\n\t\t\t\tbw_mul(bw_frc_to_fixed(5, 10), data->total_dmifmc_urgent_latency));\n\t\t\tdata->maximum_latency_hiding_with_cursor[i] = bw_min2(data->maximum_latency_hiding[i], data->cursor_latency_hiding[i]);\n\t\t}\n\t}\n\tfor (i = 0; i <= 2; i++) {\n\t\tfor (j = 0; j <= 7; j++) {\n\t\t\tdata->min_dram_speed_change_margin[i][j] = bw_int_to_fixed(9999);\n\t\t\tdata->dram_speed_change_margin = bw_int_to_fixed(9999);\n\t\t\tdata->dispclk_required_for_dram_speed_change[i][j] = bw_int_to_fixed(0);\n\t\t\tdata->num_displays_with_margin[i][j] = 0;\n\t\t\tfor (k = 0; k <= maximum_number_of_surfaces - 1; k++) {\n\t\t\t\tif (data->enable[k]) {\n\t\t\t\t\tif (surface_type[k] != bw_def_display_write_back420_luma && surface_type[k] != bw_def_display_write_back420_chroma) {\n\t\t\t\t\t\tdata->dram_speed_change_margin = bw_sub(bw_sub(bw_sub(data->maximum_latency_hiding_with_cursor[k], vbios->nbp_state_change_latency), data->dmif_burst_time[i][j]), data->dram_speed_change_line_source_transfer_time[k][i][j]);\n\t\t\t\t\t\tif ((bw_mtn(data->dram_speed_change_margin, bw_int_to_fixed(0)) && bw_ltn(data->dram_speed_change_margin, bw_int_to_fixed(9999)))) {\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\tdata->min_dram_speed_change_margin[i][j] = bw_min2(data->min_dram_speed_change_margin[i][j], data->dram_speed_change_margin);\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\tdata->dispclk_required_for_dram_speed_change_pipe[i][j] = bw_max2(bw_div(bw_div(bw_mul(data->src_pixels_for_first_output_pixel[k], dceip->display_pipe_throughput_factor), dceip->lb_write_pixels_per_dispclk), (bw_sub(bw_sub(bw_sub(data->maximum_latency_hiding_with_cursor[k], vbios->nbp_state_change_latency), data->dmif_burst_time[i][j]), data->dram_speed_change_line_source_transfer_time[k][i][j]))), bw_div(bw_div(bw_mul(data->src_pixels_for_last_output_pixel[k], dceip->display_pipe_throughput_factor), dceip->lb_write_pixels_per_dispclk), (bw_add(bw_sub(bw_sub(bw_sub(data->maximum_latency_hiding_with_cursor[k], vbios->nbp_state_change_latency), data->dmif_burst_time[i][j]), data->dram_speed_change_line_source_transfer_time[k][i][j]), data->active_time[k]))));\n\t\t\t\t\t\t\tif ((bw_ltn(data->dispclk_required_for_dram_speed_change_pipe[i][j], vbios->high_voltage_max_dispclk))) {\n\t\t\t\t\t\t\t\tdata->display_pstate_change_enable[k] = 1;\n\t\t\t\t\t\t\t\tdata->num_displays_with_margin[i][j] = data->num_displays_with_margin[i][j] + 1;\n\t\t\t\t\t\t\t\tdata->dispclk_required_for_dram_speed_change[i][j] = bw_max2(data->dispclk_required_for_dram_speed_change[i][j], data->dispclk_required_for_dram_speed_change_pipe[i][j]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdata->dram_speed_change_margin = bw_sub(bw_sub(bw_sub(bw_sub(data->maximum_latency_hiding_with_cursor[k], vbios->nbp_state_change_latency), data->dmif_burst_time[i][j]), data->mcifwr_burst_time[i][j]), data->dram_speed_change_line_source_transfer_time[k][i][j]);\n\t\t\t\t\t\tif ((bw_mtn(data->dram_speed_change_margin, bw_int_to_fixed(0)) && bw_ltn(data->dram_speed_change_margin, bw_int_to_fixed(9999)))) {\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\tdata->min_dram_speed_change_margin[i][j] = bw_min2(data->min_dram_speed_change_margin[i][j], data->dram_speed_change_margin);\n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\tdata->dispclk_required_for_dram_speed_change_pipe[i][j] = bw_max2(bw_div(bw_div(bw_mul(data->src_pixels_for_first_output_pixel[k], dceip->display_pipe_throughput_factor), dceip->lb_write_pixels_per_dispclk), (bw_sub(bw_sub(bw_sub(bw_sub(data->maximum_latency_hiding_with_cursor[k], vbios->nbp_state_change_latency), data->dmif_burst_time[i][j]), data->dram_speed_change_line_source_transfer_time[k][i][j]), data->mcifwr_burst_time[i][j]))), bw_div(bw_div(bw_mul(data->src_pixels_for_last_output_pixel[k], dceip->display_pipe_throughput_factor), dceip->lb_write_pixels_per_dispclk), (bw_add(bw_sub(bw_sub(bw_sub(bw_sub(data->maximum_latency_hiding_with_cursor[k], vbios->nbp_state_change_latency), data->dmif_burst_time[i][j]), data->dram_speed_change_line_source_transfer_time[k][i][j]), data->mcifwr_burst_time[i][j]), data->active_time[k]))));\n\t\t\t\t\t\t\tif ((bw_ltn(data->dispclk_required_for_dram_speed_change_pipe[i][j], vbios->high_voltage_max_dispclk))) {\n\t\t\t\t\t\t\t\tdata->display_pstate_change_enable[k] = 1;\n\t\t\t\t\t\t\t\tdata->num_displays_with_margin[i][j] = data->num_displays_with_margin[i][j] + 1;\n\t\t\t\t\t\t\t\tdata->dispclk_required_for_dram_speed_change[i][j] = bw_max2(data->dispclk_required_for_dram_speed_change[i][j], data->dispclk_required_for_dram_speed_change_pipe[i][j]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\tfor (k = 0; k <= maximum_number_of_surfaces - 1; k++) {\n\t\tif (data->enable[k] == 1 && data->display_pstate_change_enable[k] == 1) {\n\t\t\tnumber_of_displays_enabled_with_margin = number_of_displays_enabled_with_margin + 1;\n\t\t}\n\t}\n\t \n\t \n\t \n\tdata->min_vblank_dram_speed_change_margin = bw_int_to_fixed(9999);\n\tfor (k = 0; k <= maximum_number_of_surfaces - 1; k++) {\n\t\tif (data->enable[k]) {\n\t\t\tif (surface_type[k] != bw_def_display_write_back420_luma && surface_type[k] != bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->v_blank_dram_speed_change_margin[k] = bw_sub(bw_sub(bw_sub(bw_div(bw_mul((bw_sub(data->v_total[k], bw_sub(bw_div(data->src_height[k], data->v_scale_ratio[k]), bw_int_to_fixed(4)))), data->h_total[k]), data->pixel_rate[k]), vbios->nbp_state_change_latency), data->dmif_burst_time[low][s_low]), data->dram_speed_change_line_source_transfer_time[k][low][s_low]);\n\t\t\t\tdata->min_vblank_dram_speed_change_margin = bw_min2(data->min_vblank_dram_speed_change_margin, data->v_blank_dram_speed_change_margin[k]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->v_blank_dram_speed_change_margin[k] = bw_sub(bw_sub(bw_sub(bw_sub(bw_div(bw_mul((bw_sub(data->v_total[k], bw_sub(bw_div(data->src_height[k], data->v_scale_ratio[k]), bw_int_to_fixed(4)))), data->h_total[k]), data->pixel_rate[k]), vbios->nbp_state_change_latency), data->dmif_burst_time[low][s_low]), data->mcifwr_burst_time[low][s_low]), data->dram_speed_change_line_source_transfer_time[k][low][s_low]);\n\t\t\t\tdata->min_vblank_dram_speed_change_margin = bw_min2(data->min_vblank_dram_speed_change_margin, data->v_blank_dram_speed_change_margin[k]);\n\t\t\t}\n\t\t}\n\t}\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tdata->displays_with_same_mode[i] = bw_int_to_fixed(0);\n\t\tif (data->enable[i] == 1 && data->display_pstate_change_enable[i] == 0 && bw_mtn(data->v_blank_dram_speed_change_margin[i], bw_int_to_fixed(0))) {\n\t\t\tfor (j = 0; j <= maximum_number_of_surfaces - 1; j++) {\n\t\t\t\tif ((i == j || data->display_synchronization_enabled) && (data->enable[j] == 1 && bw_equ(data->source_width_rounded_up_to_chunks[i], data->source_width_rounded_up_to_chunks[j]) && bw_equ(data->source_height_rounded_up_to_chunks[i], data->source_height_rounded_up_to_chunks[j]) && bw_equ(data->vsr[i], data->vsr[j]) && bw_equ(data->hsr[i], data->hsr[j]) && bw_equ(data->pixel_rate[i], data->pixel_rate[j]))) {\n\t\t\t\t\tdata->displays_with_same_mode[i] = bw_add(data->displays_with_same_mode[i], bw_int_to_fixed(1));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\tnumber_of_aligned_displays_with_no_margin = 0;\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tnumber_of_aligned_displays_with_no_margin = bw_fixed_to_int(bw_max2(bw_int_to_fixed(number_of_aligned_displays_with_no_margin), data->displays_with_same_mode[i]));\n\t}\n\t \n\t \n\t \n\t \n\tif (number_of_displays_enabled_with_margin > 0 && (number_of_displays_enabled_with_margin + number_of_aligned_displays_with_no_margin) == number_of_displays_enabled && bw_mtn(data->min_dram_speed_change_margin[high][s_high], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[high][s_high], bw_int_to_fixed(9999)) && bw_ltn(data->dispclk_required_for_dram_speed_change[high][s_high], vbios->high_voltage_max_dispclk)) {\n\t\tdata->nbp_state_change_enable = bw_def_yes;\n\t}\n\telse {\n\t\tdata->nbp_state_change_enable = bw_def_no;\n\t}\n\t \n\tif (number_of_aligned_displays_with_no_margin == number_of_displays_enabled) {\n\t\tnbp_state_change_enable_blank = bw_def_yes;\n\t}\n\telse {\n\t\tnbp_state_change_enable_blank = bw_def_no;\n\t}\n\n\t \n\t \n\t \n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tdata->average_bandwidth_no_compression[i] = bw_div(bw_mul(bw_mul(bw_div(bw_mul(data->source_width_rounded_up_to_chunks[i], bw_int_to_fixed(data->bytes_per_pixel[i])), (bw_div(data->h_total[i], data->pixel_rate[i]))), data->vsr[i]), data->bytes_per_request[i]), data->useful_bytes_per_request[i]);\n\t\t\tdata->average_bandwidth[i] = bw_div(data->average_bandwidth_no_compression[i], data->compression_rate[i]);\n\t\t}\n\t}\n\tdata->total_average_bandwidth_no_compression = bw_int_to_fixed(0);\n\tdata->total_average_bandwidth = bw_int_to_fixed(0);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tdata->total_average_bandwidth_no_compression = bw_add(data->total_average_bandwidth_no_compression, data->average_bandwidth_no_compression[i]);\n\t\t\tdata->total_average_bandwidth = bw_add(data->total_average_bandwidth, data->average_bandwidth[i]);\n\t\t}\n\t}\n\n\t \n\t \n\t \n\t \n\tdata->min_cursor_memory_interface_buffer_size_in_time = bw_int_to_fixed(9999);\n\t \n\tnum_cursor_lines = 0;\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (bw_mtn(data->cursor_width_pixels[i], bw_int_to_fixed(0))) {\n\t\t\t\t \n\t\t\t\tif (bw_leq(data->cursor_width_pixels[i], bw_int_to_fixed(64)) && dceip->large_cursor == 1) {\n\t\t\t\t\tnum_cursor_lines = 4;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tnum_cursor_lines = 2;\n\t\t\t\t}\n\t\t\t\tdata->min_cursor_memory_interface_buffer_size_in_time = bw_min2(data->min_cursor_memory_interface_buffer_size_in_time, bw_div(bw_mul(bw_div(bw_int_to_fixed(num_cursor_lines), data->vsr[i]), data->h_total[i]), data->pixel_rate[i]));\n\t\t\t}\n\t\t}\n\t}\n\t \n\tif (number_of_displays_enabled > 2) {\n\t\tdata->chunk_request_delay = 0;\n\t}\n\telse {\n\t\tdata->chunk_request_delay = bw_fixed_to_int(bw_div(bw_int_to_fixed(512), vbios->high_voltage_max_dispclk));\n\t}\n\tdata->min_read_buffer_size_in_time = bw_min2(data->min_cursor_memory_interface_buffer_size_in_time, data->min_dmif_size_in_time);\n\tdata->display_reads_time_for_data_transfer = bw_sub(bw_sub(data->min_read_buffer_size_in_time, data->total_dmifmc_urgent_latency), bw_int_to_fixed(data->chunk_request_delay));\n\tdata->display_writes_time_for_data_transfer = bw_sub(data->min_mcifwr_size_in_time, vbios->mcifwrmc_urgent_latency);\n\tdata->dmif_required_dram_bandwidth = bw_div(data->total_display_reads_required_dram_access_data, data->display_reads_time_for_data_transfer);\n\tdata->mcifwr_required_dram_bandwidth = bw_div(data->total_display_writes_required_dram_access_data, data->display_writes_time_for_data_transfer);\n\tdata->required_dmifmc_urgent_latency_for_page_close_open = bw_div((bw_sub(data->min_read_buffer_size_in_time, data->dmif_total_page_close_open_time)), data->total_dmifmc_urgent_trips);\n\tdata->required_mcifmcwr_urgent_latency = bw_sub(data->min_mcifwr_size_in_time, data->mcifwr_total_page_close_open_time);\n\tif (bw_mtn(data->scatter_gather_total_pte_requests, dceip->maximum_total_outstanding_pte_requests_allowed_by_saw)) {\n\t\tdata->required_dram_bandwidth_gbyte_per_second = bw_int_to_fixed(9999);\n\t\tyclk_message = bw_def_exceeded_allowed_outstanding_pte_req_queue_size;\n\t\tdata->y_clk_level = high;\n\t\tdata->dram_bandwidth = bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[high]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels));\n\t}\n\telse if (bw_mtn(vbios->dmifmc_urgent_latency, data->required_dmifmc_urgent_latency_for_page_close_open) || bw_mtn(vbios->mcifwrmc_urgent_latency, data->required_mcifmcwr_urgent_latency)) {\n\t\tdata->required_dram_bandwidth_gbyte_per_second = bw_int_to_fixed(9999);\n\t\tyclk_message = bw_def_exceeded_allowed_page_close_open;\n\t\tdata->y_clk_level = high;\n\t\tdata->dram_bandwidth = bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[high]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels));\n\t}\n\telse {\n\t\tdata->required_dram_bandwidth_gbyte_per_second = bw_div(bw_max2(data->dmif_required_dram_bandwidth, data->mcifwr_required_dram_bandwidth), bw_int_to_fixed(1000));\n\t\tif (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_drambw_display_can_use_in_normal_system_operation, 100),yclk[low]),bw_div(bw_int_to_fixed(vbios->dram_channel_width_in_bits),bw_int_to_fixed(8))),bw_int_to_fixed(vbios->number_of_dram_channels)))\n\t\t\t\t&& bw_ltn(bw_mul(data->required_dram_bandwidth_gbyte_per_second, bw_int_to_fixed(1000)), bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[low]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels))) && (data->cpup_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[low][s_high], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[low][s_high], vbios->high_voltage_max_dispclk))) && (data->cpuc_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[low][s_high], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[low][s_high], vbios->high_voltage_max_dispclk) && bw_ltn(data->dispclk_required_for_blackout_recovery[low][s_high], vbios->high_voltage_max_dispclk))) && (!data->increase_voltage_to_support_mclk_switch || data->nbp_state_change_enable == bw_def_no || (bw_mtn(data->min_dram_speed_change_margin[low][s_high], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[low][s_high], bw_int_to_fixed(9999)) && bw_leq(data->dispclk_required_for_dram_speed_change[low][s_high], vbios->high_voltage_max_dispclk) && data->num_displays_with_margin[low][s_high] == number_of_displays_enabled_with_margin))) {\n\t\t\tyclk_message = bw_fixed_to_int(vbios->low_yclk);\n\t\t\tdata->y_clk_level = low;\n\t\t\tdata->dram_bandwidth = bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[low]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels));\n\t\t}\n\t\telse if (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_drambw_display_can_use_in_normal_system_operation, 100),yclk[mid]),bw_div(bw_int_to_fixed(vbios->dram_channel_width_in_bits),bw_int_to_fixed(8))),bw_int_to_fixed(vbios->number_of_dram_channels)))\n\t\t\t\t&& bw_ltn(bw_mul(data->required_dram_bandwidth_gbyte_per_second, bw_int_to_fixed(1000)), bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[mid]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels))) && (data->cpup_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[mid][s_high], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[mid][s_high], vbios->high_voltage_max_dispclk))) && (data->cpuc_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[mid][s_high], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[mid][s_high], vbios->high_voltage_max_dispclk) && bw_ltn(data->dispclk_required_for_blackout_recovery[mid][s_high], vbios->high_voltage_max_dispclk))) && (!data->increase_voltage_to_support_mclk_switch || data->nbp_state_change_enable == bw_def_no || (bw_mtn(data->min_dram_speed_change_margin[mid][s_high], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[mid][s_high], bw_int_to_fixed(9999)) && bw_leq(data->dispclk_required_for_dram_speed_change[mid][s_high], vbios->high_voltage_max_dispclk) && data->num_displays_with_margin[mid][s_high] == number_of_displays_enabled_with_margin))) {\n\t\t\tyclk_message = bw_fixed_to_int(vbios->mid_yclk);\n\t\t\tdata->y_clk_level = mid;\n\t\t\tdata->dram_bandwidth = bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[mid]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels));\n\t\t}\n\t\telse if (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_drambw_display_can_use_in_normal_system_operation, 100),yclk[high]),bw_div(bw_int_to_fixed(vbios->dram_channel_width_in_bits),bw_int_to_fixed(8))),bw_int_to_fixed(vbios->number_of_dram_channels)))\n\t\t\t\t&& bw_ltn(bw_mul(data->required_dram_bandwidth_gbyte_per_second, bw_int_to_fixed(1000)), bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[high]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels)))) {\n\t\t\tyclk_message = bw_fixed_to_int(vbios->high_yclk);\n\t\t\tdata->y_clk_level = high;\n\t\t\tdata->dram_bandwidth = bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[high]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels));\n\t\t}\n\t\telse {\n\t\t\tyclk_message = bw_def_exceeded_allowed_maximum_bw;\n\t\t\tdata->y_clk_level = high;\n\t\t\tdata->dram_bandwidth = bw_mul(bw_div(bw_mul(bw_mul(data->dram_efficiency, yclk[high]), bw_int_to_fixed(vbios->dram_channel_width_in_bits)), bw_int_to_fixed(8)), bw_int_to_fixed(data->number_of_dram_channels));\n\t\t}\n\t}\n\t \n\t \n\t \n\t \n\t \n\tdata->dmif_required_sclk = bw_div(bw_div(data->total_display_reads_required_data, data->display_reads_time_for_data_transfer), (bw_mul(vbios->data_return_bus_width, bw_frc_to_fixed(dceip->percent_of_ideal_port_bw_received_after_urgent_latency, 100))));\n\tdata->mcifwr_required_sclk = bw_div(bw_div(data->total_display_writes_required_data, data->display_writes_time_for_data_transfer), vbios->data_return_bus_width);\n\tif (bw_mtn(data->scatter_gather_total_pte_requests, dceip->maximum_total_outstanding_pte_requests_allowed_by_saw)) {\n\t\tdata->required_sclk = bw_int_to_fixed(9999);\n\t\tsclk_message = bw_def_exceeded_allowed_outstanding_pte_req_queue_size;\n\t\tdata->sclk_level = s_high;\n\t}\n\telse if (bw_mtn(vbios->dmifmc_urgent_latency, data->required_dmifmc_urgent_latency_for_page_close_open) || bw_mtn(vbios->mcifwrmc_urgent_latency, data->required_mcifmcwr_urgent_latency)) {\n\t\tdata->required_sclk = bw_int_to_fixed(9999);\n\t\tsclk_message = bw_def_exceeded_allowed_page_close_open;\n\t\tdata->sclk_level = s_high;\n\t}\n\telse {\n\t\tdata->required_sclk = bw_max2(data->dmif_required_sclk, data->mcifwr_required_sclk);\n\t\tif (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation, 100),sclk[low]),vbios->data_return_bus_width))\n\t\t\t\t&& bw_ltn(data->required_sclk, sclk[s_low]) && (data->cpup_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_low], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_low], vbios->high_voltage_max_dispclk))) && (data->cpuc_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_low], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_low], vbios->high_voltage_max_dispclk) && bw_ltn(data->dispclk_required_for_blackout_recovery[data->y_clk_level][s_low], vbios->high_voltage_max_dispclk))) && (!data->increase_voltage_to_support_mclk_switch || data->nbp_state_change_enable == bw_def_no || (bw_mtn(data->min_dram_speed_change_margin[data->y_clk_level][s_low], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[data->y_clk_level][s_low], bw_int_to_fixed(9999)) && bw_leq(data->dispclk_required_for_dram_speed_change[data->y_clk_level][s_low], vbios->low_voltage_max_dispclk) && data->num_displays_with_margin[data->y_clk_level][s_low] == number_of_displays_enabled_with_margin))) {\n\t\t\tsclk_message = bw_def_low;\n\t\t\tdata->sclk_level = s_low;\n\t\t\tdata->required_sclk = vbios->low_sclk;\n\t\t}\n\t\telse if (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation, 100),sclk[mid]),vbios->data_return_bus_width))\n\t\t\t\t&& bw_ltn(data->required_sclk, sclk[s_mid1]) && (data->cpup_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid1], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid1], vbios->high_voltage_max_dispclk))) && (data->cpuc_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid1], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid1], vbios->high_voltage_max_dispclk) && bw_ltn(data->dispclk_required_for_blackout_recovery[data->y_clk_level][s_mid1], vbios->high_voltage_max_dispclk))) && (!data->increase_voltage_to_support_mclk_switch || data->nbp_state_change_enable == bw_def_no || (bw_mtn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid1], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid1], bw_int_to_fixed(9999)) && bw_leq(data->dispclk_required_for_dram_speed_change[data->y_clk_level][s_mid1], vbios->mid_voltage_max_dispclk) && data->num_displays_with_margin[data->y_clk_level][s_mid1] == number_of_displays_enabled_with_margin))) {\n\t\t\tsclk_message = bw_def_mid;\n\t\t\tdata->sclk_level = s_mid1;\n\t\t\tdata->required_sclk = vbios->mid1_sclk;\n\t\t}\n\t\telse if (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation, 100),sclk[s_mid2]),vbios->data_return_bus_width))\n\t\t\t\t&& bw_ltn(data->required_sclk, sclk[s_mid2]) && (data->cpup_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid2], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid2], vbios->high_voltage_max_dispclk))) && (data->cpuc_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid2], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid2], vbios->high_voltage_max_dispclk) && bw_ltn(data->dispclk_required_for_blackout_recovery[data->y_clk_level][s_mid2], vbios->high_voltage_max_dispclk))) && (!data->increase_voltage_to_support_mclk_switch || data->nbp_state_change_enable == bw_def_no || (bw_mtn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid2], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid2], bw_int_to_fixed(9999)) && bw_leq(data->dispclk_required_for_dram_speed_change[data->y_clk_level][s_mid2], vbios->mid_voltage_max_dispclk) && data->num_displays_with_margin[data->y_clk_level][s_mid2] == number_of_displays_enabled_with_margin))) {\n\t\t\tsclk_message = bw_def_mid;\n\t\t\tdata->sclk_level = s_mid2;\n\t\t\tdata->required_sclk = vbios->mid2_sclk;\n\t\t}\n\t\telse if (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation, 100),sclk[s_mid3]),vbios->data_return_bus_width))\n\t\t\t\t&& bw_ltn(data->required_sclk, sclk[s_mid3]) && (data->cpup_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid3], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid3], vbios->high_voltage_max_dispclk))) && (data->cpuc_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid3], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid3], vbios->high_voltage_max_dispclk) && bw_ltn(data->dispclk_required_for_blackout_recovery[data->y_clk_level][s_mid3], vbios->high_voltage_max_dispclk))) && (!data->increase_voltage_to_support_mclk_switch || data->nbp_state_change_enable == bw_def_no || (bw_mtn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid3], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid3], bw_int_to_fixed(9999)) && bw_leq(data->dispclk_required_for_dram_speed_change[data->y_clk_level][s_mid3], vbios->mid_voltage_max_dispclk) && data->num_displays_with_margin[data->y_clk_level][s_mid3] == number_of_displays_enabled_with_margin))) {\n\t\t\tsclk_message = bw_def_mid;\n\t\t\tdata->sclk_level = s_mid3;\n\t\t\tdata->required_sclk = vbios->mid3_sclk;\n\t\t}\n\t\telse if (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation, 100),sclk[s_mid4]),vbios->data_return_bus_width))\n\t\t\t\t&& bw_ltn(data->required_sclk, sclk[s_mid4]) && (data->cpup_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid4], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid4], vbios->high_voltage_max_dispclk))) && (data->cpuc_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid4], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid4], vbios->high_voltage_max_dispclk) && bw_ltn(data->dispclk_required_for_blackout_recovery[data->y_clk_level][s_mid4], vbios->high_voltage_max_dispclk))) && (!data->increase_voltage_to_support_mclk_switch || data->nbp_state_change_enable == bw_def_no || (bw_mtn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid4], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid4], bw_int_to_fixed(9999)) && bw_leq(data->dispclk_required_for_dram_speed_change[data->y_clk_level][s_mid4], vbios->mid_voltage_max_dispclk) && data->num_displays_with_margin[data->y_clk_level][s_mid4] == number_of_displays_enabled_with_margin))) {\n\t\t\tsclk_message = bw_def_mid;\n\t\t\tdata->sclk_level = s_mid4;\n\t\t\tdata->required_sclk = vbios->mid4_sclk;\n\t\t}\n\t\telse if (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation, 100),sclk[s_mid5]),vbios->data_return_bus_width))\n\t\t\t\t&& bw_ltn(data->required_sclk, sclk[s_mid5]) && (data->cpup_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid5], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid5], vbios->high_voltage_max_dispclk))) && (data->cpuc_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid5], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid5], vbios->high_voltage_max_dispclk) && bw_ltn(data->dispclk_required_for_blackout_recovery[data->y_clk_level][s_mid5], vbios->high_voltage_max_dispclk))) && (!data->increase_voltage_to_support_mclk_switch || data->nbp_state_change_enable == bw_def_no || (bw_mtn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid5], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid5], bw_int_to_fixed(9999)) && bw_leq(data->dispclk_required_for_dram_speed_change[data->y_clk_level][s_mid5], vbios->mid_voltage_max_dispclk) && data->num_displays_with_margin[data->y_clk_level][s_mid5] == number_of_displays_enabled_with_margin))) {\n\t\t\tsclk_message = bw_def_mid;\n\t\t\tdata->sclk_level = s_mid5;\n\t\t\tdata->required_sclk = vbios->mid5_sclk;\n\t\t}\n\t\telse if (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation, 100),sclk[s_mid6]),vbios->data_return_bus_width))\n\t\t\t\t&& bw_ltn(data->required_sclk, sclk[s_mid6]) && (data->cpup_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid6], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid6], vbios->high_voltage_max_dispclk))) && (data->cpuc_state_change_enable == bw_def_no || (bw_mtn(data->blackout_duration_margin[data->y_clk_level][s_mid6], bw_int_to_fixed(0)) && bw_ltn(data->dispclk_required_for_blackout_duration[data->y_clk_level][s_mid6], vbios->high_voltage_max_dispclk) && bw_ltn(data->dispclk_required_for_blackout_recovery[data->y_clk_level][s_mid6], vbios->high_voltage_max_dispclk))) && (!data->increase_voltage_to_support_mclk_switch || data->nbp_state_change_enable == bw_def_no || (bw_mtn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid6], bw_int_to_fixed(0)) && bw_ltn(data->min_dram_speed_change_margin[data->y_clk_level][s_mid6], bw_int_to_fixed(9999)) && bw_leq(data->dispclk_required_for_dram_speed_change[data->y_clk_level][s_mid6], vbios->high_voltage_max_dispclk) && data->num_displays_with_margin[data->y_clk_level][s_mid6] == number_of_displays_enabled_with_margin))) {\n\t\t\tsclk_message = bw_def_mid;\n\t\t\tdata->sclk_level = s_mid6;\n\t\t\tdata->required_sclk = vbios->mid6_sclk;\n\t\t}\n\t\telse if (bw_ltn(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation, 100),sclk[s_high]),vbios->data_return_bus_width))\n\t\t\t\t&& bw_ltn(data->required_sclk, sclk[s_high])) {\n\t\t\tsclk_message = bw_def_high;\n\t\t\tdata->sclk_level = s_high;\n\t\t\tdata->required_sclk = vbios->high_sclk;\n\t\t}\n\t\telse if (bw_meq(data->total_average_bandwidth_no_compression, bw_mul(bw_mul(bw_frc_to_fixed(dceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation, 100),sclk[s_high]),vbios->data_return_bus_width))\n\t\t\t\t&& bw_ltn(data->required_sclk, sclk[s_high])) {\n\t\t\tsclk_message = bw_def_high;\n\t\t\tdata->sclk_level = s_high;\n\t\t\tdata->required_sclk = vbios->high_sclk;\n\t\t}\n\t\telse {\n\t\t\tsclk_message = bw_def_exceeded_allowed_maximum_sclk;\n\t\t\tdata->sclk_level = s_high;\n\t\t\t \n\t\t}\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tdata->downspread_factor = bw_add(bw_int_to_fixed(1), bw_div(vbios->down_spread_percentage, bw_int_to_fixed(100)));\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (surface_type[i] == bw_def_graphics) {\n\t\t\t\tswitch (data->lb_bpc[i]) {\n\t\t\t\tcase 6:\n\t\t\t\t\tdata->v_scaler_efficiency = dceip->graphics_vscaler_efficiency6_bit_per_component;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 8:\n\t\t\t\t\tdata->v_scaler_efficiency = dceip->graphics_vscaler_efficiency8_bit_per_component;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 10:\n\t\t\t\t\tdata->v_scaler_efficiency = dceip->graphics_vscaler_efficiency10_bit_per_component;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tdata->v_scaler_efficiency = dceip->graphics_vscaler_efficiency12_bit_per_component;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (data->use_alpha[i] == 1) {\n\t\t\t\t\tdata->v_scaler_efficiency = bw_min2(data->v_scaler_efficiency, dceip->alpha_vscaler_efficiency);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tswitch (data->lb_bpc[i]) {\n\t\t\t\tcase 6:\n\t\t\t\t\tdata->v_scaler_efficiency = dceip->underlay_vscaler_efficiency6_bit_per_component;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 8:\n\t\t\t\t\tdata->v_scaler_efficiency = dceip->underlay_vscaler_efficiency8_bit_per_component;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 10:\n\t\t\t\t\tdata->v_scaler_efficiency = dceip->underlay_vscaler_efficiency10_bit_per_component;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tdata->v_scaler_efficiency = dceip->underlay_vscaler_efficiency12_bit_per_component;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (dceip->pre_downscaler_enabled && bw_mtn(data->hsr[i], bw_int_to_fixed(1))) {\n\t\t\t\tdata->scaler_limits_factor = bw_max2(bw_div(data->v_taps[i], data->v_scaler_efficiency), bw_div(data->source_width_rounded_up_to_chunks[i], data->h_total[i]));\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->scaler_limits_factor = bw_max3(bw_int_to_fixed(1), bw_ceil2(bw_div(data->h_taps[i], bw_int_to_fixed(4)), bw_int_to_fixed(1)), bw_mul(data->hsr[i], bw_max2(bw_div(data->v_taps[i], data->v_scaler_efficiency), bw_int_to_fixed(1))));\n\t\t\t}\n\t\t\tdata->display_pipe_pixel_throughput = bw_div(bw_div(bw_mul(bw_max2(data->lb_lines_in_per_line_out_in_beginning_of_frame[i], bw_mul(data->lb_lines_in_per_line_out_in_middle_of_frame[i], data->horizontal_blank_and_chunk_granularity_factor[i])), data->source_width_rounded_up_to_chunks[i]), (bw_div(data->h_total[i], data->pixel_rate[i]))), dceip->lb_write_pixels_per_dispclk);\n\t\t\tdata->dispclk_required_without_ramping[i] = bw_mul(data->downspread_factor, bw_max2(bw_mul(data->pixel_rate[i], data->scaler_limits_factor), bw_mul(dceip->display_pipe_throughput_factor, data->display_pipe_pixel_throughput)));\n\t\t\tdata->dispclk_required_with_ramping[i] = bw_mul(dceip->dispclk_ramping_factor, bw_max2(bw_mul(data->pixel_rate[i], data->scaler_limits_factor), data->display_pipe_pixel_throughput));\n\t\t}\n\t}\n\tdata->total_dispclk_required_with_ramping = bw_int_to_fixed(0);\n\tdata->total_dispclk_required_without_ramping = bw_int_to_fixed(0);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (bw_ltn(data->total_dispclk_required_with_ramping, data->dispclk_required_with_ramping[i])) {\n\t\t\t\tdata->total_dispclk_required_with_ramping = data->dispclk_required_with_ramping[i];\n\t\t\t}\n\t\t\tif (bw_ltn(data->total_dispclk_required_without_ramping, data->dispclk_required_without_ramping[i])) {\n\t\t\t\tdata->total_dispclk_required_without_ramping = data->dispclk_required_without_ramping[i];\n\t\t\t}\n\t\t}\n\t}\n\tdata->total_read_request_bandwidth = bw_int_to_fixed(0);\n\tdata->total_write_request_bandwidth = bw_int_to_fixed(0);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->total_read_request_bandwidth = bw_add(data->total_read_request_bandwidth, data->request_bandwidth[i]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->total_write_request_bandwidth = bw_add(data->total_write_request_bandwidth, data->request_bandwidth[i]);\n\t\t\t}\n\t\t}\n\t}\n\tdata->dispclk_required_for_total_read_request_bandwidth = bw_div(bw_mul(data->total_read_request_bandwidth, dceip->dispclk_per_request), dceip->request_efficiency);\n\tdata->total_dispclk_required_with_ramping_with_request_bandwidth = bw_max2(data->total_dispclk_required_with_ramping, data->dispclk_required_for_total_read_request_bandwidth);\n\tdata->total_dispclk_required_without_ramping_with_request_bandwidth = bw_max2(data->total_dispclk_required_without_ramping, data->dispclk_required_for_total_read_request_bandwidth);\n\tif (data->cpuc_state_change_enable == bw_def_yes) {\n\t\tdata->total_dispclk_required_with_ramping_with_request_bandwidth = bw_max3(data->total_dispclk_required_with_ramping_with_request_bandwidth, data->dispclk_required_for_blackout_duration[data->y_clk_level][data->sclk_level], data->dispclk_required_for_blackout_recovery[data->y_clk_level][data->sclk_level]);\n\t\tdata->total_dispclk_required_without_ramping_with_request_bandwidth = bw_max3(data->total_dispclk_required_without_ramping_with_request_bandwidth, data->dispclk_required_for_blackout_duration[data->y_clk_level][data->sclk_level], data->dispclk_required_for_blackout_recovery[data->y_clk_level][data->sclk_level]);\n\t}\n\tif (data->cpup_state_change_enable == bw_def_yes) {\n\t\tdata->total_dispclk_required_with_ramping_with_request_bandwidth = bw_max2(data->total_dispclk_required_with_ramping_with_request_bandwidth, data->dispclk_required_for_blackout_duration[data->y_clk_level][data->sclk_level]);\n\t\tdata->total_dispclk_required_without_ramping_with_request_bandwidth = bw_max2(data->total_dispclk_required_without_ramping_with_request_bandwidth, data->dispclk_required_for_blackout_duration[data->y_clk_level][data->sclk_level]);\n\t}\n\tif (data->nbp_state_change_enable == bw_def_yes && data->increase_voltage_to_support_mclk_switch) {\n\t\tdata->total_dispclk_required_with_ramping_with_request_bandwidth = bw_max2(data->total_dispclk_required_with_ramping_with_request_bandwidth, data->dispclk_required_for_dram_speed_change[data->y_clk_level][data->sclk_level]);\n\t\tdata->total_dispclk_required_without_ramping_with_request_bandwidth = bw_max2(data->total_dispclk_required_without_ramping_with_request_bandwidth, data->dispclk_required_for_dram_speed_change[data->y_clk_level][data->sclk_level]);\n\t}\n\tif (bw_ltn(data->total_dispclk_required_with_ramping_with_request_bandwidth, vbios->high_voltage_max_dispclk)) {\n\t\tdata->dispclk = data->total_dispclk_required_with_ramping_with_request_bandwidth;\n\t}\n\telse if (bw_ltn(data->total_dispclk_required_without_ramping_with_request_bandwidth, vbios->high_voltage_max_dispclk)) {\n\t\tdata->dispclk = vbios->high_voltage_max_dispclk;\n\t}\n\telse {\n\t\tdata->dispclk = data->total_dispclk_required_without_ramping_with_request_bandwidth;\n\t}\n\t \n\t \n\t \n\t \n\t \n\tif (pipe_check == bw_def_notok) {\n\t\tvoltage = bw_def_na;\n\t}\n\telse if (mode_check == bw_def_notok) {\n\t\tvoltage = bw_def_notok;\n\t}\n\telse if (bw_equ(bw_int_to_fixed(yclk_message), vbios->low_yclk) && sclk_message == bw_def_low && bw_ltn(data->dispclk, vbios->low_voltage_max_dispclk)) {\n\t\tvoltage = bw_def_0_72;\n\t}\n\telse if ((bw_equ(bw_int_to_fixed(yclk_message), vbios->low_yclk) || bw_equ(bw_int_to_fixed(yclk_message), vbios->mid_yclk)) && (sclk_message == bw_def_low || sclk_message == bw_def_mid) && bw_ltn(data->dispclk, vbios->mid_voltage_max_dispclk)) {\n\t\tvoltage = bw_def_0_8;\n\t}\n\telse if ((bw_equ(bw_int_to_fixed(yclk_message), vbios->low_yclk) || bw_equ(bw_int_to_fixed(yclk_message), vbios->mid_yclk) || bw_equ(bw_int_to_fixed(yclk_message), vbios->high_yclk)) && (sclk_message == bw_def_low || sclk_message == bw_def_mid || sclk_message == bw_def_high) && bw_leq(data->dispclk, vbios->high_voltage_max_dispclk)) {\n\t\tif ((data->nbp_state_change_enable == bw_def_no && nbp_state_change_enable_blank == bw_def_no)) {\n\t\t\tvoltage = bw_def_high_no_nbp_state_change;\n\t\t}\n\t\telse {\n\t\t\tvoltage = bw_def_0_9;\n\t\t}\n\t}\n\telse {\n\t\tvoltage = bw_def_notok;\n\t}\n\tif (voltage == bw_def_0_72) {\n\t\tdata->max_phyclk = vbios->low_voltage_max_phyclk;\n\t}\n\telse if (voltage == bw_def_0_8) {\n\t\tdata->max_phyclk = vbios->mid_voltage_max_phyclk;\n\t}\n\telse {\n\t\tdata->max_phyclk = vbios->high_voltage_max_phyclk;\n\t}\n\t \n\tdata->blackout_recovery_time = bw_int_to_fixed(0);\n\tfor (k = 0; k <= maximum_number_of_surfaces - 1; k++) {\n\t\tif (data->enable[k] && bw_mtn(vbios->blackout_duration, bw_int_to_fixed(0)) && data->cpup_state_change_enable == bw_def_yes) {\n\t\t\tif (surface_type[k] != bw_def_display_write_back420_luma && surface_type[k] != bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->blackout_recovery_time = bw_max2(data->blackout_recovery_time, bw_add(bw_mul(bw_int_to_fixed(2), data->total_dmifmc_urgent_latency), data->dmif_burst_time[data->y_clk_level][data->sclk_level]));\n\t\t\t\tif (bw_ltn(data->adjusted_data_buffer_size[k], bw_mul(bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k]), (bw_add(vbios->blackout_duration, bw_add(bw_mul(bw_int_to_fixed(2), data->total_dmifmc_urgent_latency), data->dmif_burst_time[data->y_clk_level][data->sclk_level])))))) {\n\t\t\t\t\tdata->blackout_recovery_time = bw_max2(data->blackout_recovery_time, bw_div((bw_add(bw_mul(bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k]), vbios->blackout_duration), bw_sub(bw_div(bw_mul(bw_mul(bw_mul((bw_add(bw_mul(bw_int_to_fixed(2), data->total_dmifmc_urgent_latency), data->dmif_burst_time[data->y_clk_level][data->sclk_level])), data->dispclk), bw_int_to_fixed(data->bytes_per_pixel[k])), data->lines_interleaved_in_mem_access[k]), data->latency_hiding_lines[k]), data->adjusted_data_buffer_size[k]))), (bw_sub(bw_div(bw_mul(bw_mul(data->dispclk, bw_int_to_fixed(data->bytes_per_pixel[k])), data->lines_interleaved_in_mem_access[k]), data->latency_hiding_lines[k]), bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k])))));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->blackout_recovery_time = bw_max2(data->blackout_recovery_time, bw_add(bw_mul(bw_int_to_fixed(2), vbios->mcifwrmc_urgent_latency), data->mcifwr_burst_time[data->y_clk_level][data->sclk_level]));\n\t\t\t\tif (bw_ltn(data->adjusted_data_buffer_size[k], bw_mul(bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k]), (bw_add(vbios->blackout_duration, bw_add(bw_mul(bw_int_to_fixed(2), vbios->mcifwrmc_urgent_latency), data->mcifwr_burst_time[data->y_clk_level][data->sclk_level])))))) {\n\t\t\t\t\tdata->blackout_recovery_time = bw_max2(data->blackout_recovery_time, bw_div((bw_add(bw_mul(bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k]), vbios->blackout_duration), bw_sub(bw_div(bw_mul(bw_mul(bw_mul((bw_add(bw_add(bw_mul(bw_int_to_fixed(2), vbios->mcifwrmc_urgent_latency), data->dmif_burst_time[data->y_clk_level][data->sclk_level]), data->mcifwr_burst_time[data->y_clk_level][data->sclk_level])), data->dispclk), bw_int_to_fixed(data->bytes_per_pixel[k])), data->lines_interleaved_in_mem_access[k]), data->latency_hiding_lines[k]), data->adjusted_data_buffer_size[k]))), (bw_sub(bw_div(bw_mul(bw_mul(data->dispclk, bw_int_to_fixed(data->bytes_per_pixel[k])), data->lines_interleaved_in_mem_access[k]), data->latency_hiding_lines[k]), bw_div(bw_mul(data->display_bandwidth[k], data->useful_bytes_per_request[k]), data->bytes_per_request[k])))));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (surface_type[i] == bw_def_display_write_back420_luma || surface_type[i] == bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->pixels_per_data_fifo_entry[i] = bw_int_to_fixed(16);\n\t\t\t}\n\t\t\telse if (surface_type[i] == bw_def_graphics) {\n\t\t\t\tdata->pixels_per_data_fifo_entry[i] = bw_div(bw_int_to_fixed(64), bw_int_to_fixed(data->bytes_per_pixel[i]));\n\t\t\t}\n\t\t\telse if (data->orthogonal_rotation[i] == 0) {\n\t\t\t\tdata->pixels_per_data_fifo_entry[i] = bw_int_to_fixed(16);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->pixels_per_data_fifo_entry[i] = bw_div(bw_int_to_fixed(16), bw_int_to_fixed(data->bytes_per_pixel[i]));\n\t\t\t}\n\t\t}\n\t}\n\tdata->min_pixels_per_data_fifo_entry = bw_int_to_fixed(9999);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (bw_mtn(data->min_pixels_per_data_fifo_entry, data->pixels_per_data_fifo_entry[i])) {\n\t\t\t\tdata->min_pixels_per_data_fifo_entry = data->pixels_per_data_fifo_entry[i];\n\t\t\t}\n\t\t}\n\t}\n\tdata->sclk_deep_sleep = bw_max2(bw_div(bw_mul(data->dispclk, bw_frc_to_fixed(115, 100)), data->min_pixels_per_data_fifo_entry), data->total_read_request_bandwidth);\n\t \n\t \n\t \n\t \n\t \n\t \n\tdata->chunk_request_time = bw_int_to_fixed(0);\n\tdata->cursor_request_time = bw_int_to_fixed(0);\n\t \n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tdata->chunk_request_time = bw_add(data->chunk_request_time, (bw_div((bw_div(bw_int_to_fixed(pixels_per_chunk * data->bytes_per_pixel[i]), data->useful_bytes_per_request[i])), bw_min2(sclk[data->sclk_level], bw_div(data->dispclk, bw_int_to_fixed(2))))));\n\t\t}\n\t}\n\t \n\tdata->cursor_request_time = (bw_div(data->cursor_total_data, (bw_mul(bw_int_to_fixed(32), sclk[data->sclk_level]))));\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tdata->line_source_pixels_transfer_time = bw_max2(bw_div(bw_div(data->src_pixels_for_first_output_pixel[i], dceip->lb_write_pixels_per_dispclk), (bw_div(data->dispclk, dceip->display_pipe_throughput_factor))), bw_sub(bw_div(bw_div(data->src_pixels_for_last_output_pixel[i], dceip->lb_write_pixels_per_dispclk), (bw_div(data->dispclk, dceip->display_pipe_throughput_factor))), data->active_time[i]));\n\t\t\tif (surface_type[i] != bw_def_display_write_back420_luma && surface_type[i] != bw_def_display_write_back420_chroma) {\n\t\t\t\tdata->urgent_watermark[i] = bw_add(bw_add(bw_add(bw_add(bw_add(data->total_dmifmc_urgent_latency, data->dmif_burst_time[data->y_clk_level][data->sclk_level]), bw_max2(data->line_source_pixels_transfer_time, data->line_source_transfer_time[i][data->y_clk_level][data->sclk_level])), vbios->blackout_duration), data->chunk_request_time), data->cursor_request_time);\n\t\t\t\tdata->stutter_exit_watermark[i] = bw_add(bw_sub(vbios->stutter_self_refresh_exit_latency, data->total_dmifmc_urgent_latency), data->urgent_watermark[i]);\n\t\t\t\tdata->stutter_entry_watermark[i] = bw_add(bw_sub(bw_add(vbios->stutter_self_refresh_exit_latency, vbios->stutter_self_refresh_entry_latency), data->total_dmifmc_urgent_latency), data->urgent_watermark[i]);\n\t\t\t\t \n\t\t\t\tif (data->display_pstate_change_enable[i] == 1) {\n\t\t\t\t\tdata->nbp_state_change_watermark[i] = bw_add(bw_add(vbios->nbp_state_change_latency, data->dmif_burst_time[data->y_clk_level][data->sclk_level]), bw_max2(data->line_source_pixels_transfer_time, data->dram_speed_change_line_source_transfer_time[i][data->y_clk_level][data->sclk_level]));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t \n\t\t\t\t\tdata->nbp_state_change_watermark[i] = bw_int_to_fixed(131000);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tdata->urgent_watermark[i] = bw_add(bw_add(bw_add(bw_add(bw_add(vbios->mcifwrmc_urgent_latency, data->mcifwr_burst_time[data->y_clk_level][data->sclk_level]), bw_max2(data->line_source_pixels_transfer_time, data->line_source_transfer_time[i][data->y_clk_level][data->sclk_level])), vbios->blackout_duration), data->chunk_request_time), data->cursor_request_time);\n\t\t\t\tdata->stutter_exit_watermark[i] = bw_int_to_fixed(0);\n\t\t\t\tdata->stutter_entry_watermark[i] = bw_int_to_fixed(0);\n\t\t\t\tif (data->display_pstate_change_enable[i] == 1) {\n\t\t\t\t\tdata->nbp_state_change_watermark[i] = bw_add(bw_add(vbios->nbp_state_change_latency, data->mcifwr_burst_time[data->y_clk_level][data->sclk_level]), bw_max2(data->line_source_pixels_transfer_time, data->dram_speed_change_line_source_transfer_time[i][data->y_clk_level][data->sclk_level]));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t \n\t\t\t\t\tdata->nbp_state_change_watermark[i] = bw_int_to_fixed(131000);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\t \n\t \n\tdata->stutter_mode_enable = data->cpuc_state_change_enable;\n\tif (data->number_of_displays > 1) {\n\t\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\t\tif (data->enable[i]) {\n\t\t\t\tif ((bw_mtn(data->stutter_exit_watermark[i], data->minimum_latency_hiding[i]) || bw_mtn(data->stutter_entry_watermark[i], data->minimum_latency_hiding[i]))) {\n\t\t\t\t\tdata->stutter_mode_enable = bw_def_no;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tdata->dmifdram_access_efficiency = bw_min2(bw_div(bw_div(data->total_display_reads_required_dram_access_data, data->dram_bandwidth), data->dmif_total_page_close_open_time), bw_int_to_fixed(1));\n\tif (bw_mtn(data->total_display_writes_required_dram_access_data, bw_int_to_fixed(0))) {\n\t\tdata->mcifwrdram_access_efficiency = bw_min2(bw_div(bw_div(data->total_display_writes_required_dram_access_data, data->dram_bandwidth), data->mcifwr_total_page_close_open_time), bw_int_to_fixed(1));\n\t}\n\telse {\n\t\tdata->mcifwrdram_access_efficiency = bw_int_to_fixed(0);\n\t}\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tdata->stutter_refresh_duration[i] = bw_sub(bw_mul(bw_div(bw_div(bw_mul(bw_div(bw_div(data->adjusted_data_buffer_size[i], bw_int_to_fixed(data->bytes_per_pixel[i])), data->source_width_rounded_up_to_chunks[i]), data->h_total[i]), data->vsr[i]), data->pixel_rate[i]), data->compression_rate[i]), bw_max2(bw_int_to_fixed(0), bw_sub(data->stutter_exit_watermark[i], bw_div(bw_mul((bw_sub(data->lb_partitions[i], bw_int_to_fixed(1))), data->h_total[i]), data->pixel_rate[i]))));\n\t\t\tdata->stutter_dmif_buffer_size[i] = bw_div(bw_mul(bw_mul(bw_div(bw_mul(bw_mul(data->stutter_refresh_duration[i], bw_int_to_fixed(data->bytes_per_pixel[i])), data->source_width_rounded_up_to_chunks[i]), data->h_total[i]), data->vsr[i]), data->pixel_rate[i]), data->compression_rate[i]);\n\t\t}\n\t}\n\tdata->min_stutter_refresh_duration = bw_int_to_fixed(9999);\n\tdata->total_stutter_dmif_buffer_size = 0;\n\tdata->total_bytes_requested = 0;\n\tdata->min_stutter_dmif_buffer_size = 9999;\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tif (bw_mtn(data->min_stutter_refresh_duration, data->stutter_refresh_duration[i])) {\n\t\t\t\tdata->min_stutter_refresh_duration = data->stutter_refresh_duration[i];\n\t\t\t\tdata->total_bytes_requested = bw_fixed_to_int(bw_add(bw_int_to_fixed(data->total_bytes_requested), (bw_mul(bw_mul(data->source_height_rounded_up_to_chunks[i], data->source_width_rounded_up_to_chunks[i]), bw_int_to_fixed(data->bytes_per_pixel[i])))));\n\t\t\t\tdata->min_stutter_dmif_buffer_size = bw_fixed_to_int(data->stutter_dmif_buffer_size[i]);\n\t\t\t}\n\t\t\tdata->total_stutter_dmif_buffer_size = bw_fixed_to_int(bw_add(data->stutter_dmif_buffer_size[i], bw_int_to_fixed(data->total_stutter_dmif_buffer_size)));\n\t\t}\n\t}\n\tdata->stutter_burst_time = bw_div(bw_int_to_fixed(data->total_stutter_dmif_buffer_size), bw_mul(sclk[data->sclk_level], vbios->data_return_bus_width));\n\tdata->num_stutter_bursts = data->total_bytes_requested / data->min_stutter_dmif_buffer_size;\n\tdata->total_stutter_cycle_duration = bw_add(bw_add(data->min_stutter_refresh_duration, vbios->stutter_self_refresh_exit_latency), data->stutter_burst_time);\n\tdata->time_in_self_refresh = data->min_stutter_refresh_duration;\n\tif (data->d1_display_write_back_dwb_enable == 1) {\n\t\tdata->stutter_efficiency = bw_int_to_fixed(0);\n\t}\n\telse if (bw_ltn(data->time_in_self_refresh, bw_int_to_fixed(0))) {\n\t\tdata->stutter_efficiency = bw_int_to_fixed(0);\n\t}\n\telse {\n\t\t \n\t\tdata->stutter_efficiency = bw_max2(bw_int_to_fixed(0), bw_mul((bw_sub(bw_int_to_fixed(1), (bw_div(bw_mul((bw_add(vbios->stutter_self_refresh_exit_latency, data->stutter_burst_time)), bw_int_to_fixed(data->num_stutter_bursts)), bw_frc_to_fixed(166666667, 10000))))), bw_int_to_fixed(100)));\n\t}\n\t \n\t \n\t \n\tdata->worst_number_of_trips_to_memory = bw_int_to_fixed(1);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i] && data->scatter_gather_enable_for_pipe[i] == 1) {\n\t\t\tdata->number_of_trips_to_memory_for_getting_apte_row[i] = bw_ceil2(bw_div(data->scatter_gather_pte_requests_in_row[i], data->scatter_gather_pte_request_limit[i]), bw_int_to_fixed(1));\n\t\t\tif (bw_ltn(data->worst_number_of_trips_to_memory, data->number_of_trips_to_memory_for_getting_apte_row[i])) {\n\t\t\t\tdata->worst_number_of_trips_to_memory = data->number_of_trips_to_memory_for_getting_apte_row[i];\n\t\t\t}\n\t\t}\n\t}\n\tdata->immediate_flip_time = bw_mul(data->worst_number_of_trips_to_memory, data->total_dmifmc_urgent_latency);\n\t \n\t \n\tdata->latency_for_non_dmif_clients = bw_add(data->total_dmifmc_urgent_latency, data->dmif_burst_time[data->y_clk_level][data->sclk_level]);\n\tif (data->d1_display_write_back_dwb_enable == 1) {\n\t\tdata->latency_for_non_mcifwr_clients = bw_add(vbios->mcifwrmc_urgent_latency, dceip->mcifwr_all_surfaces_burst_time);\n\t}\n\telse {\n\t\tdata->latency_for_non_mcifwr_clients = bw_int_to_fixed(0);\n\t}\n\t \n\tdata->dmifmc_urgent_latency_supported_in_high_sclk_and_yclk = bw_div((bw_sub(data->min_read_buffer_size_in_time, data->dmif_burst_time[high][s_high])), data->total_dmifmc_urgent_trips);\n\t \n\t \n\tdata->v_blank_nbp_state_dram_speed_change_latency_supported = bw_int_to_fixed(99999);\n\tdata->nbp_state_dram_speed_change_latency_supported = bw_int_to_fixed(99999);\n\tfor (i = 0; i <= maximum_number_of_surfaces - 1; i++) {\n\t\tif (data->enable[i]) {\n\t\t\tdata->nbp_state_dram_speed_change_latency_supported = bw_min2(data->nbp_state_dram_speed_change_latency_supported, bw_add(bw_sub(data->maximum_latency_hiding_with_cursor[i], data->nbp_state_change_watermark[i]), vbios->nbp_state_change_latency));\n\t\t\tdata->v_blank_nbp_state_dram_speed_change_latency_supported = bw_min2(data->v_blank_nbp_state_dram_speed_change_latency_supported, bw_add(bw_sub(bw_div(bw_mul((bw_sub(data->v_total[i], bw_sub(bw_div(data->src_height[i], data->v_scale_ratio[i]), bw_int_to_fixed(4)))), data->h_total[i]), data->pixel_rate[i]), data->nbp_state_change_watermark[i]), vbios->nbp_state_change_latency));\n\t\t}\n\t}\n\t \n\tfor (i = 1; i <= 5; i++) {\n\t\tdata->display_reads_time_for_data_transfer_and_urgent_latency = bw_sub(data->min_read_buffer_size_in_time, bw_mul(data->total_dmifmc_urgent_trips, bw_int_to_fixed(i)));\n\t\tif (pipe_check == bw_def_ok && (bw_mtn(data->display_reads_time_for_data_transfer_and_urgent_latency, data->dmif_total_page_close_open_time))) {\n\t\t\tdata->dmif_required_sclk_for_urgent_latency[i] = bw_div(bw_div(data->total_display_reads_required_data, data->display_reads_time_for_data_transfer_and_urgent_latency), (bw_mul(vbios->data_return_bus_width, bw_frc_to_fixed(dceip->percent_of_ideal_port_bw_received_after_urgent_latency, 100))));\n\t\t}\n\t\telse {\n\t\t\tdata->dmif_required_sclk_for_urgent_latency[i] = bw_int_to_fixed(bw_def_na);\n\t\t}\n\t}\n\t \n\tfor (k = 0; k <= maximum_number_of_surfaces - 1; k++) {\n\t\tdata->output_bpphdmi[k] = bw_def_na;\n\t\tdata->output_bppdp4_lane_hbr[k] = bw_def_na;\n\t\tdata->output_bppdp4_lane_hbr2[k] = bw_def_na;\n\t\tdata->output_bppdp4_lane_hbr3[k] = bw_def_na;\n\t\tif (data->enable[k]) {\n\t\t\tdata->output_bpphdmi[k] = bw_fixed_to_int(bw_mul(bw_div(bw_min2(bw_int_to_fixed(600), data->max_phyclk), data->pixel_rate[k]), bw_int_to_fixed(24)));\n\t\t\tif (bw_meq(data->max_phyclk, bw_int_to_fixed(270))) {\n\t\t\t\tdata->output_bppdp4_lane_hbr[k] = bw_fixed_to_int(bw_mul(bw_div(bw_mul(bw_int_to_fixed(270), bw_int_to_fixed(4)), data->pixel_rate[k]), bw_int_to_fixed(8)));\n\t\t\t}\n\t\t\tif (bw_meq(data->max_phyclk, bw_int_to_fixed(540))) {\n\t\t\t\tdata->output_bppdp4_lane_hbr2[k] = bw_fixed_to_int(bw_mul(bw_div(bw_mul(bw_int_to_fixed(540), bw_int_to_fixed(4)), data->pixel_rate[k]), bw_int_to_fixed(8)));\n\t\t\t}\n\t\t\tif (bw_meq(data->max_phyclk, bw_int_to_fixed(810))) {\n\t\t\t\tdata->output_bppdp4_lane_hbr3[k] = bw_fixed_to_int(bw_mul(bw_div(bw_mul(bw_int_to_fixed(810), bw_int_to_fixed(4)), data->pixel_rate[k]), bw_int_to_fixed(8)));\n\t\t\t}\n\t\t}\n\t}\n\n\tkfree(surface_type);\nfree_tiling_mode:\n\tkfree(tiling_mode);\nfree_sclk:\n\tkfree(sclk);\nfree_yclk:\n\tkfree(yclk);\n}\n\n \nvoid bw_calcs_init(struct bw_calcs_dceip *bw_dceip,\n\tstruct bw_calcs_vbios *bw_vbios,\n\tstruct hw_asic_id asic_id)\n{\n\tstruct bw_calcs_dceip *dceip;\n\tstruct bw_calcs_vbios *vbios;\n\n\tenum bw_calcs_version version = bw_calcs_version_from_asic_id(asic_id);\n\n\tdceip = kzalloc(sizeof(*dceip), GFP_KERNEL);\n\tif (!dceip)\n\t\treturn;\n\n\tvbios = kzalloc(sizeof(*vbios), GFP_KERNEL);\n\tif (!vbios) {\n\t\tkfree(dceip);\n\t\treturn;\n\t}\n\n\tdceip->version = version;\n\n\tswitch (version) {\n\tcase BW_CALCS_VERSION_CARRIZO:\n\t\tvbios->memory_type = bw_def_gddr5;\n\t\tvbios->dram_channel_width_in_bits = 64;\n\t\tvbios->number_of_dram_channels = asic_id.vram_width / vbios->dram_channel_width_in_bits;\n\t\tvbios->number_of_dram_banks = 8;\n\t\tvbios->high_yclk = bw_int_to_fixed(1600);\n\t\tvbios->mid_yclk = bw_int_to_fixed(1600);\n\t\tvbios->low_yclk = bw_frc_to_fixed(66666, 100);\n\t\tvbios->low_sclk = bw_int_to_fixed(200);\n\t\tvbios->mid1_sclk = bw_int_to_fixed(300);\n\t\tvbios->mid2_sclk = bw_int_to_fixed(300);\n\t\tvbios->mid3_sclk = bw_int_to_fixed(300);\n\t\tvbios->mid4_sclk = bw_int_to_fixed(300);\n\t\tvbios->mid5_sclk = bw_int_to_fixed(300);\n\t\tvbios->mid6_sclk = bw_int_to_fixed(300);\n\t\tvbios->high_sclk = bw_frc_to_fixed(62609, 100);\n\t\tvbios->low_voltage_max_dispclk = bw_int_to_fixed(352);\n\t\tvbios->mid_voltage_max_dispclk = bw_int_to_fixed(467);\n\t\tvbios->high_voltage_max_dispclk = bw_int_to_fixed(643);\n\t\tvbios->low_voltage_max_phyclk = bw_int_to_fixed(540);\n\t\tvbios->mid_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->high_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->data_return_bus_width = bw_int_to_fixed(32);\n\t\tvbios->trc = bw_int_to_fixed(50);\n\t\tvbios->dmifmc_urgent_latency = bw_int_to_fixed(4);\n\t\tvbios->stutter_self_refresh_exit_latency = bw_frc_to_fixed(153, 10);\n\t\tvbios->stutter_self_refresh_entry_latency = bw_int_to_fixed(0);\n\t\tvbios->nbp_state_change_latency = bw_frc_to_fixed(19649, 1000);\n\t\tvbios->mcifwrmc_urgent_latency = bw_int_to_fixed(10);\n\t\tvbios->scatter_gather_enable = true;\n\t\tvbios->down_spread_percentage = bw_frc_to_fixed(5, 10);\n\t\tvbios->cursor_width = 32;\n\t\tvbios->average_compression_rate = 4;\n\t\tvbios->number_of_request_slots_gmc_reserves_for_dmif_per_channel = 256;\n\t\tvbios->blackout_duration = bw_int_to_fixed(0);  \n\t\tvbios->maximum_blackout_recovery_time = bw_int_to_fixed(0);\n\n\t\tdceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->max_average_percent_of_ideal_drambw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->percent_of_ideal_port_bw_received_after_urgent_latency = 100;\n\t\tdceip->large_cursor = false;\n\t\tdceip->dmif_request_buffer_size = bw_int_to_fixed(768);\n\t\tdceip->dmif_pipe_en_fbc_chunk_tracker = false;\n\t\tdceip->cursor_max_outstanding_group_num = 1;\n\t\tdceip->lines_interleaved_into_lb = 2;\n\t\tdceip->chunk_width = 256;\n\t\tdceip->number_of_graphics_pipes = 3;\n\t\tdceip->number_of_underlay_pipes = 1;\n\t\tdceip->low_power_tiling_mode = 0;\n\t\tdceip->display_write_back_supported = false;\n\t\tdceip->argb_compression_support = false;\n\t\tdceip->underlay_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35556, 10000);\n\t\tdceip->underlay_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->underlay_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->underlay_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->graphics_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35, 10);\n\t\tdceip->graphics_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->graphics_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->graphics_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->alpha_vscaler_efficiency = bw_int_to_fixed(3);\n\t\tdceip->max_dmif_buffer_allocated = 2;\n\t\tdceip->graphics_dmif_size = 12288;\n\t\tdceip->underlay_luma_dmif_size = 19456;\n\t\tdceip->underlay_chroma_dmif_size = 23552;\n\t\tdceip->pre_downscaler_enabled = true;\n\t\tdceip->underlay_downscale_prefetch_enabled = true;\n\t\tdceip->lb_write_pixels_per_dispclk = bw_int_to_fixed(1);\n\t\tdceip->lb_size_per_component444 = bw_int_to_fixed(82176);\n\t\tdceip->graphics_lb_nodownscaling_multi_line_prefetching = false;\n\t\tdceip->stutter_and_dram_clock_state_change_gated_before_cursor =\n\t\t\tbw_int_to_fixed(0);\n\t\tdceip->underlay420_luma_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->underlay420_chroma_lb_size_per_component =\n\t\t\tbw_int_to_fixed(164352);\n\t\tdceip->underlay422_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->cursor_chunk_width = bw_int_to_fixed(64);\n\t\tdceip->cursor_dcp_buffer_lines = bw_int_to_fixed(4);\n\t\tdceip->underlay_maximum_width_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1920);\n\t\tdceip->underlay_maximum_height_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1080);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_multiple_displays_or_single_rotated_display =\n\t\t\tbw_frc_to_fixed(3, 10);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_single_display_no_rotation =\n\t\t\tbw_int_to_fixed(25);\n\t\tdceip->minimum_outstanding_pte_request_limit = bw_int_to_fixed(\n\t\t\t2);\n\t\tdceip->maximum_total_outstanding_pte_requests_allowed_by_saw =\n\t\t\tbw_int_to_fixed(128);\n\t\tdceip->limit_excessive_outstanding_dmif_requests = true;\n\t\tdceip->linear_mode_line_request_alternation_slice =\n\t\t\tbw_int_to_fixed(64);\n\t\tdceip->scatter_gather_lines_of_pte_prefetching_in_linear_mode =\n\t\t\t32;\n\t\tdceip->display_write_back420_luma_mcifwr_buffer_size = 12288;\n\t\tdceip->display_write_back420_chroma_mcifwr_buffer_size = 8192;\n\t\tdceip->request_efficiency = bw_frc_to_fixed(8, 10);\n\t\tdceip->dispclk_per_request = bw_int_to_fixed(2);\n\t\tdceip->dispclk_ramping_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->display_pipe_throughput_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->scatter_gather_pte_request_rows_in_tiling_mode = 2;\n\t\tdceip->mcifwr_all_surfaces_burst_time = bw_int_to_fixed(0);  \n\t\tbreak;\n\tcase BW_CALCS_VERSION_POLARIS10:\n\t\t \n\tcase BW_CALCS_VERSION_VEGAM:\n\t\tvbios->memory_type = bw_def_gddr5;\n\t\tvbios->dram_channel_width_in_bits = 32;\n\t\tvbios->number_of_dram_channels = asic_id.vram_width / vbios->dram_channel_width_in_bits;\n\t\tvbios->number_of_dram_banks = 8;\n\t\tvbios->high_yclk = bw_int_to_fixed(6000);\n\t\tvbios->mid_yclk = bw_int_to_fixed(3200);\n\t\tvbios->low_yclk = bw_int_to_fixed(1000);\n\t\tvbios->low_sclk = bw_int_to_fixed(300);\n\t\tvbios->mid1_sclk = bw_int_to_fixed(400);\n\t\tvbios->mid2_sclk = bw_int_to_fixed(500);\n\t\tvbios->mid3_sclk = bw_int_to_fixed(600);\n\t\tvbios->mid4_sclk = bw_int_to_fixed(700);\n\t\tvbios->mid5_sclk = bw_int_to_fixed(800);\n\t\tvbios->mid6_sclk = bw_int_to_fixed(974);\n\t\tvbios->high_sclk = bw_int_to_fixed(1154);\n\t\tvbios->low_voltage_max_dispclk = bw_int_to_fixed(459);\n\t\tvbios->mid_voltage_max_dispclk = bw_int_to_fixed(654);\n\t\tvbios->high_voltage_max_dispclk = bw_int_to_fixed(1108);\n\t\tvbios->low_voltage_max_phyclk = bw_int_to_fixed(540);\n\t\tvbios->mid_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->high_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->data_return_bus_width = bw_int_to_fixed(32);\n\t\tvbios->trc = bw_int_to_fixed(48);\n\t\tvbios->dmifmc_urgent_latency = bw_int_to_fixed(3);\n\t\tvbios->stutter_self_refresh_exit_latency = bw_int_to_fixed(5);\n\t\tvbios->stutter_self_refresh_entry_latency = bw_int_to_fixed(0);\n\t\tvbios->nbp_state_change_latency = bw_int_to_fixed(45);\n\t\tvbios->mcifwrmc_urgent_latency = bw_int_to_fixed(10);\n\t\tvbios->scatter_gather_enable = true;\n\t\tvbios->down_spread_percentage = bw_frc_to_fixed(5, 10);\n\t\tvbios->cursor_width = 32;\n\t\tvbios->average_compression_rate = 4;\n\t\tvbios->number_of_request_slots_gmc_reserves_for_dmif_per_channel = 256;\n\t\tvbios->blackout_duration = bw_int_to_fixed(0);  \n\t\tvbios->maximum_blackout_recovery_time = bw_int_to_fixed(0);\n\n\t\tdceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->max_average_percent_of_ideal_drambw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->percent_of_ideal_port_bw_received_after_urgent_latency = 100;\n\t\tdceip->large_cursor = false;\n\t\tdceip->dmif_request_buffer_size = bw_int_to_fixed(768);\n\t\tdceip->dmif_pipe_en_fbc_chunk_tracker = false;\n\t\tdceip->cursor_max_outstanding_group_num = 1;\n\t\tdceip->lines_interleaved_into_lb = 2;\n\t\tdceip->chunk_width = 256;\n\t\tdceip->number_of_graphics_pipes = 6;\n\t\tdceip->number_of_underlay_pipes = 0;\n\t\tdceip->low_power_tiling_mode = 0;\n\t\tdceip->display_write_back_supported = false;\n\t\tdceip->argb_compression_support = true;\n\t\tdceip->underlay_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35556, 10000);\n\t\tdceip->underlay_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->underlay_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->underlay_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->graphics_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35, 10);\n\t\tdceip->graphics_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->graphics_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->graphics_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->alpha_vscaler_efficiency = bw_int_to_fixed(3);\n\t\tdceip->max_dmif_buffer_allocated = 4;\n\t\tdceip->graphics_dmif_size = 12288;\n\t\tdceip->underlay_luma_dmif_size = 19456;\n\t\tdceip->underlay_chroma_dmif_size = 23552;\n\t\tdceip->pre_downscaler_enabled = true;\n\t\tdceip->underlay_downscale_prefetch_enabled = true;\n\t\tdceip->lb_write_pixels_per_dispclk = bw_int_to_fixed(1);\n\t\tdceip->lb_size_per_component444 = bw_int_to_fixed(245952);\n\t\tdceip->graphics_lb_nodownscaling_multi_line_prefetching = true;\n\t\tdceip->stutter_and_dram_clock_state_change_gated_before_cursor =\n\t\t\tbw_int_to_fixed(1);\n\t\tdceip->underlay420_luma_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->underlay420_chroma_lb_size_per_component =\n\t\t\tbw_int_to_fixed(164352);\n\t\tdceip->underlay422_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->cursor_chunk_width = bw_int_to_fixed(64);\n\t\tdceip->cursor_dcp_buffer_lines = bw_int_to_fixed(4);\n\t\tdceip->underlay_maximum_width_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1920);\n\t\tdceip->underlay_maximum_height_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1080);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_multiple_displays_or_single_rotated_display =\n\t\t\tbw_frc_to_fixed(3, 10);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_single_display_no_rotation =\n\t\t\tbw_int_to_fixed(25);\n\t\tdceip->minimum_outstanding_pte_request_limit = bw_int_to_fixed(\n\t\t\t2);\n\t\tdceip->maximum_total_outstanding_pte_requests_allowed_by_saw =\n\t\t\tbw_int_to_fixed(128);\n\t\tdceip->limit_excessive_outstanding_dmif_requests = true;\n\t\tdceip->linear_mode_line_request_alternation_slice =\n\t\t\tbw_int_to_fixed(64);\n\t\tdceip->scatter_gather_lines_of_pte_prefetching_in_linear_mode =\n\t\t\t32;\n\t\tdceip->display_write_back420_luma_mcifwr_buffer_size = 12288;\n\t\tdceip->display_write_back420_chroma_mcifwr_buffer_size = 8192;\n\t\tdceip->request_efficiency = bw_frc_to_fixed(8, 10);\n\t\tdceip->dispclk_per_request = bw_int_to_fixed(2);\n\t\tdceip->dispclk_ramping_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->display_pipe_throughput_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->scatter_gather_pte_request_rows_in_tiling_mode = 2;\n\t\tdceip->mcifwr_all_surfaces_burst_time = bw_int_to_fixed(0);\n\t\tbreak;\n\tcase BW_CALCS_VERSION_POLARIS11:\n\t\tvbios->memory_type = bw_def_gddr5;\n\t\tvbios->dram_channel_width_in_bits = 32;\n\t\tvbios->number_of_dram_channels = asic_id.vram_width / vbios->dram_channel_width_in_bits;\n\t\tvbios->number_of_dram_banks = 8;\n\t\tvbios->high_yclk = bw_int_to_fixed(6000);\n\t\tvbios->mid_yclk = bw_int_to_fixed(3200);\n\t\tvbios->low_yclk = bw_int_to_fixed(1000);\n\t\tvbios->low_sclk = bw_int_to_fixed(300);\n\t\tvbios->mid1_sclk = bw_int_to_fixed(400);\n\t\tvbios->mid2_sclk = bw_int_to_fixed(500);\n\t\tvbios->mid3_sclk = bw_int_to_fixed(600);\n\t\tvbios->mid4_sclk = bw_int_to_fixed(700);\n\t\tvbios->mid5_sclk = bw_int_to_fixed(800);\n\t\tvbios->mid6_sclk = bw_int_to_fixed(974);\n\t\tvbios->high_sclk = bw_int_to_fixed(1154);\n\t\tvbios->low_voltage_max_dispclk = bw_int_to_fixed(459);\n\t\tvbios->mid_voltage_max_dispclk = bw_int_to_fixed(654);\n\t\tvbios->high_voltage_max_dispclk = bw_int_to_fixed(1108);\n\t\tvbios->low_voltage_max_phyclk = bw_int_to_fixed(540);\n\t\tvbios->mid_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->high_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->data_return_bus_width = bw_int_to_fixed(32);\n\t\tvbios->trc = bw_int_to_fixed(48);\n\t\tif (vbios->number_of_dram_channels == 2)  \n\t\t\tvbios->dmifmc_urgent_latency = bw_int_to_fixed(4);\n\t\telse\n\t\t\tvbios->dmifmc_urgent_latency = bw_int_to_fixed(3);\n\t\tvbios->stutter_self_refresh_exit_latency = bw_int_to_fixed(5);\n\t\tvbios->stutter_self_refresh_entry_latency = bw_int_to_fixed(0);\n\t\tvbios->nbp_state_change_latency = bw_int_to_fixed(45);\n\t\tvbios->mcifwrmc_urgent_latency = bw_int_to_fixed(10);\n\t\tvbios->scatter_gather_enable = true;\n\t\tvbios->down_spread_percentage = bw_frc_to_fixed(5, 10);\n\t\tvbios->cursor_width = 32;\n\t\tvbios->average_compression_rate = 4;\n\t\tvbios->number_of_request_slots_gmc_reserves_for_dmif_per_channel = 256;\n\t\tvbios->blackout_duration = bw_int_to_fixed(0);  \n\t\tvbios->maximum_blackout_recovery_time = bw_int_to_fixed(0);\n\n\t\tdceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->max_average_percent_of_ideal_drambw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->percent_of_ideal_port_bw_received_after_urgent_latency = 100;\n\t\tdceip->large_cursor = false;\n\t\tdceip->dmif_request_buffer_size = bw_int_to_fixed(768);\n\t\tdceip->dmif_pipe_en_fbc_chunk_tracker = false;\n\t\tdceip->cursor_max_outstanding_group_num = 1;\n\t\tdceip->lines_interleaved_into_lb = 2;\n\t\tdceip->chunk_width = 256;\n\t\tdceip->number_of_graphics_pipes = 5;\n\t\tdceip->number_of_underlay_pipes = 0;\n\t\tdceip->low_power_tiling_mode = 0;\n\t\tdceip->display_write_back_supported = false;\n\t\tdceip->argb_compression_support = true;\n\t\tdceip->underlay_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35556, 10000);\n\t\tdceip->underlay_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->underlay_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->underlay_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->graphics_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35, 10);\n\t\tdceip->graphics_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->graphics_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->graphics_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->alpha_vscaler_efficiency = bw_int_to_fixed(3);\n\t\tdceip->max_dmif_buffer_allocated = 4;\n\t\tdceip->graphics_dmif_size = 12288;\n\t\tdceip->underlay_luma_dmif_size = 19456;\n\t\tdceip->underlay_chroma_dmif_size = 23552;\n\t\tdceip->pre_downscaler_enabled = true;\n\t\tdceip->underlay_downscale_prefetch_enabled = true;\n\t\tdceip->lb_write_pixels_per_dispclk = bw_int_to_fixed(1);\n\t\tdceip->lb_size_per_component444 = bw_int_to_fixed(245952);\n\t\tdceip->graphics_lb_nodownscaling_multi_line_prefetching = true;\n\t\tdceip->stutter_and_dram_clock_state_change_gated_before_cursor =\n\t\t\tbw_int_to_fixed(1);\n\t\tdceip->underlay420_luma_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->underlay420_chroma_lb_size_per_component =\n\t\t\tbw_int_to_fixed(164352);\n\t\tdceip->underlay422_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->cursor_chunk_width = bw_int_to_fixed(64);\n\t\tdceip->cursor_dcp_buffer_lines = bw_int_to_fixed(4);\n\t\tdceip->underlay_maximum_width_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1920);\n\t\tdceip->underlay_maximum_height_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1080);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_multiple_displays_or_single_rotated_display =\n\t\t\tbw_frc_to_fixed(3, 10);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_single_display_no_rotation =\n\t\t\tbw_int_to_fixed(25);\n\t\tdceip->minimum_outstanding_pte_request_limit = bw_int_to_fixed(\n\t\t\t2);\n\t\tdceip->maximum_total_outstanding_pte_requests_allowed_by_saw =\n\t\t\tbw_int_to_fixed(128);\n\t\tdceip->limit_excessive_outstanding_dmif_requests = true;\n\t\tdceip->linear_mode_line_request_alternation_slice =\n\t\t\tbw_int_to_fixed(64);\n\t\tdceip->scatter_gather_lines_of_pte_prefetching_in_linear_mode =\n\t\t\t32;\n\t\tdceip->display_write_back420_luma_mcifwr_buffer_size = 12288;\n\t\tdceip->display_write_back420_chroma_mcifwr_buffer_size = 8192;\n\t\tdceip->request_efficiency = bw_frc_to_fixed(8, 10);\n\t\tdceip->dispclk_per_request = bw_int_to_fixed(2);\n\t\tdceip->dispclk_ramping_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->display_pipe_throughput_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->scatter_gather_pte_request_rows_in_tiling_mode = 2;\n\t\tdceip->mcifwr_all_surfaces_burst_time = bw_int_to_fixed(0);\n\t\tbreak;\n\tcase BW_CALCS_VERSION_POLARIS12:\n\t\tvbios->memory_type = bw_def_gddr5;\n\t\tvbios->dram_channel_width_in_bits = 32;\n\t\tvbios->number_of_dram_channels = asic_id.vram_width / vbios->dram_channel_width_in_bits;\n\t\tvbios->number_of_dram_banks = 8;\n\t\tvbios->high_yclk = bw_int_to_fixed(6000);\n\t\tvbios->mid_yclk = bw_int_to_fixed(3200);\n\t\tvbios->low_yclk = bw_int_to_fixed(1000);\n\t\tvbios->low_sclk = bw_int_to_fixed(678);\n\t\tvbios->mid1_sclk = bw_int_to_fixed(864);\n\t\tvbios->mid2_sclk = bw_int_to_fixed(900);\n\t\tvbios->mid3_sclk = bw_int_to_fixed(920);\n\t\tvbios->mid4_sclk = bw_int_to_fixed(940);\n\t\tvbios->mid5_sclk = bw_int_to_fixed(960);\n\t\tvbios->mid6_sclk = bw_int_to_fixed(980);\n\t\tvbios->high_sclk = bw_int_to_fixed(1049);\n\t\tvbios->low_voltage_max_dispclk = bw_int_to_fixed(459);\n\t\tvbios->mid_voltage_max_dispclk = bw_int_to_fixed(654);\n\t\tvbios->high_voltage_max_dispclk = bw_int_to_fixed(1108);\n\t\tvbios->low_voltage_max_phyclk = bw_int_to_fixed(540);\n\t\tvbios->mid_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->high_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->data_return_bus_width = bw_int_to_fixed(32);\n\t\tvbios->trc = bw_int_to_fixed(48);\n\t\tif (vbios->number_of_dram_channels == 2)  \n\t\t\tvbios->dmifmc_urgent_latency = bw_int_to_fixed(4);\n\t\telse\n\t\t\tvbios->dmifmc_urgent_latency = bw_int_to_fixed(3);\n\t\tvbios->stutter_self_refresh_exit_latency = bw_int_to_fixed(5);\n\t\tvbios->stutter_self_refresh_entry_latency = bw_int_to_fixed(0);\n\t\tvbios->nbp_state_change_latency = bw_int_to_fixed(250);\n\t\tvbios->mcifwrmc_urgent_latency = bw_int_to_fixed(10);\n\t\tvbios->scatter_gather_enable = false;\n\t\tvbios->down_spread_percentage = bw_frc_to_fixed(5, 10);\n\t\tvbios->cursor_width = 32;\n\t\tvbios->average_compression_rate = 4;\n\t\tvbios->number_of_request_slots_gmc_reserves_for_dmif_per_channel = 256;\n\t\tvbios->blackout_duration = bw_int_to_fixed(0);  \n\t\tvbios->maximum_blackout_recovery_time = bw_int_to_fixed(0);\n\n\t\tdceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->max_average_percent_of_ideal_drambw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->percent_of_ideal_port_bw_received_after_urgent_latency = 100;\n\t\tdceip->large_cursor = false;\n\t\tdceip->dmif_request_buffer_size = bw_int_to_fixed(768);\n\t\tdceip->dmif_pipe_en_fbc_chunk_tracker = false;\n\t\tdceip->cursor_max_outstanding_group_num = 1;\n\t\tdceip->lines_interleaved_into_lb = 2;\n\t\tdceip->chunk_width = 256;\n\t\tdceip->number_of_graphics_pipes = 5;\n\t\tdceip->number_of_underlay_pipes = 0;\n\t\tdceip->low_power_tiling_mode = 0;\n\t\tdceip->display_write_back_supported = true;\n\t\tdceip->argb_compression_support = true;\n\t\tdceip->underlay_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35556, 10000);\n\t\tdceip->underlay_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->underlay_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->underlay_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->graphics_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35, 10);\n\t\tdceip->graphics_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->graphics_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->graphics_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->alpha_vscaler_efficiency = bw_int_to_fixed(3);\n\t\tdceip->max_dmif_buffer_allocated = 4;\n\t\tdceip->graphics_dmif_size = 12288;\n\t\tdceip->underlay_luma_dmif_size = 19456;\n\t\tdceip->underlay_chroma_dmif_size = 23552;\n\t\tdceip->pre_downscaler_enabled = true;\n\t\tdceip->underlay_downscale_prefetch_enabled = true;\n\t\tdceip->lb_write_pixels_per_dispclk = bw_int_to_fixed(1);\n\t\tdceip->lb_size_per_component444 = bw_int_to_fixed(245952);\n\t\tdceip->graphics_lb_nodownscaling_multi_line_prefetching = true;\n\t\tdceip->stutter_and_dram_clock_state_change_gated_before_cursor =\n\t\t\tbw_int_to_fixed(1);\n\t\tdceip->underlay420_luma_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->underlay420_chroma_lb_size_per_component =\n\t\t\tbw_int_to_fixed(164352);\n\t\tdceip->underlay422_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->cursor_chunk_width = bw_int_to_fixed(64);\n\t\tdceip->cursor_dcp_buffer_lines = bw_int_to_fixed(4);\n\t\tdceip->underlay_maximum_width_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1920);\n\t\tdceip->underlay_maximum_height_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1080);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_multiple_displays_or_single_rotated_display =\n\t\t\tbw_frc_to_fixed(3, 10);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_single_display_no_rotation =\n\t\t\tbw_int_to_fixed(25);\n\t\tdceip->minimum_outstanding_pte_request_limit = bw_int_to_fixed(\n\t\t\t2);\n\t\tdceip->maximum_total_outstanding_pte_requests_allowed_by_saw =\n\t\t\tbw_int_to_fixed(128);\n\t\tdceip->limit_excessive_outstanding_dmif_requests = true;\n\t\tdceip->linear_mode_line_request_alternation_slice =\n\t\t\tbw_int_to_fixed(64);\n\t\tdceip->scatter_gather_lines_of_pte_prefetching_in_linear_mode =\n\t\t\t32;\n\t\tdceip->display_write_back420_luma_mcifwr_buffer_size = 12288;\n\t\tdceip->display_write_back420_chroma_mcifwr_buffer_size = 8192;\n\t\tdceip->request_efficiency = bw_frc_to_fixed(8, 10);\n\t\tdceip->dispclk_per_request = bw_int_to_fixed(2);\n\t\tdceip->dispclk_ramping_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->display_pipe_throughput_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->scatter_gather_pte_request_rows_in_tiling_mode = 2;\n\t\tdceip->mcifwr_all_surfaces_burst_time = bw_int_to_fixed(0);\n\t\tbreak;\n\tcase BW_CALCS_VERSION_STONEY:\n\t\tvbios->memory_type = bw_def_gddr5;\n\t\tvbios->dram_channel_width_in_bits = 64;\n\t\tvbios->number_of_dram_channels = asic_id.vram_width / vbios->dram_channel_width_in_bits;\n\t\tvbios->number_of_dram_banks = 8;\n\t\tvbios->high_yclk = bw_int_to_fixed(1866);\n\t\tvbios->mid_yclk = bw_int_to_fixed(1866);\n\t\tvbios->low_yclk = bw_int_to_fixed(1333);\n\t\tvbios->low_sclk = bw_int_to_fixed(200);\n\t\tvbios->mid1_sclk = bw_int_to_fixed(600);\n\t\tvbios->mid2_sclk = bw_int_to_fixed(600);\n\t\tvbios->mid3_sclk = bw_int_to_fixed(600);\n\t\tvbios->mid4_sclk = bw_int_to_fixed(600);\n\t\tvbios->mid5_sclk = bw_int_to_fixed(600);\n\t\tvbios->mid6_sclk = bw_int_to_fixed(600);\n\t\tvbios->high_sclk = bw_int_to_fixed(800);\n\t\tvbios->low_voltage_max_dispclk = bw_int_to_fixed(352);\n\t\tvbios->mid_voltage_max_dispclk = bw_int_to_fixed(467);\n\t\tvbios->high_voltage_max_dispclk = bw_int_to_fixed(643);\n\t\tvbios->low_voltage_max_phyclk = bw_int_to_fixed(540);\n\t\tvbios->mid_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->high_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->data_return_bus_width = bw_int_to_fixed(32);\n\t\tvbios->trc = bw_int_to_fixed(50);\n\t\tvbios->dmifmc_urgent_latency = bw_int_to_fixed(4);\n\t\tvbios->stutter_self_refresh_exit_latency = bw_frc_to_fixed(158, 10);\n\t\tvbios->stutter_self_refresh_entry_latency = bw_int_to_fixed(0);\n\t\tvbios->nbp_state_change_latency = bw_frc_to_fixed(2008, 100);\n\t\tvbios->mcifwrmc_urgent_latency = bw_int_to_fixed(10);\n\t\tvbios->scatter_gather_enable = true;\n\t\tvbios->down_spread_percentage = bw_frc_to_fixed(5, 10);\n\t\tvbios->cursor_width = 32;\n\t\tvbios->average_compression_rate = 4;\n\t\tvbios->number_of_request_slots_gmc_reserves_for_dmif_per_channel = 256;\n\t\tvbios->blackout_duration = bw_int_to_fixed(0);  \n\t\tvbios->maximum_blackout_recovery_time = bw_int_to_fixed(0);\n\n\t\tdceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->max_average_percent_of_ideal_drambw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->percent_of_ideal_port_bw_received_after_urgent_latency = 100;\n\t\tdceip->large_cursor = false;\n\t\tdceip->dmif_request_buffer_size = bw_int_to_fixed(768);\n\t\tdceip->dmif_pipe_en_fbc_chunk_tracker = false;\n\t\tdceip->cursor_max_outstanding_group_num = 1;\n\t\tdceip->lines_interleaved_into_lb = 2;\n\t\tdceip->chunk_width = 256;\n\t\tdceip->number_of_graphics_pipes = 2;\n\t\tdceip->number_of_underlay_pipes = 1;\n\t\tdceip->low_power_tiling_mode = 0;\n\t\tdceip->display_write_back_supported = false;\n\t\tdceip->argb_compression_support = true;\n\t\tdceip->underlay_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35556, 10000);\n\t\tdceip->underlay_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->underlay_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->underlay_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->graphics_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35, 10);\n\t\tdceip->graphics_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->graphics_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->graphics_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->alpha_vscaler_efficiency = bw_int_to_fixed(3);\n\t\tdceip->max_dmif_buffer_allocated = 2;\n\t\tdceip->graphics_dmif_size = 12288;\n\t\tdceip->underlay_luma_dmif_size = 19456;\n\t\tdceip->underlay_chroma_dmif_size = 23552;\n\t\tdceip->pre_downscaler_enabled = true;\n\t\tdceip->underlay_downscale_prefetch_enabled = true;\n\t\tdceip->lb_write_pixels_per_dispclk = bw_int_to_fixed(1);\n\t\tdceip->lb_size_per_component444 = bw_int_to_fixed(82176);\n\t\tdceip->graphics_lb_nodownscaling_multi_line_prefetching = false;\n\t\tdceip->stutter_and_dram_clock_state_change_gated_before_cursor =\n\t\t\tbw_int_to_fixed(0);\n\t\tdceip->underlay420_luma_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->underlay420_chroma_lb_size_per_component =\n\t\t\tbw_int_to_fixed(164352);\n\t\tdceip->underlay422_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->cursor_chunk_width = bw_int_to_fixed(64);\n\t\tdceip->cursor_dcp_buffer_lines = bw_int_to_fixed(4);\n\t\tdceip->underlay_maximum_width_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1920);\n\t\tdceip->underlay_maximum_height_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1080);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_multiple_displays_or_single_rotated_display =\n\t\t\tbw_frc_to_fixed(3, 10);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_single_display_no_rotation =\n\t\t\tbw_int_to_fixed(25);\n\t\tdceip->minimum_outstanding_pte_request_limit = bw_int_to_fixed(\n\t\t\t2);\n\t\tdceip->maximum_total_outstanding_pte_requests_allowed_by_saw =\n\t\t\tbw_int_to_fixed(128);\n\t\tdceip->limit_excessive_outstanding_dmif_requests = true;\n\t\tdceip->linear_mode_line_request_alternation_slice =\n\t\t\tbw_int_to_fixed(64);\n\t\tdceip->scatter_gather_lines_of_pte_prefetching_in_linear_mode =\n\t\t\t32;\n\t\tdceip->display_write_back420_luma_mcifwr_buffer_size = 12288;\n\t\tdceip->display_write_back420_chroma_mcifwr_buffer_size = 8192;\n\t\tdceip->request_efficiency = bw_frc_to_fixed(8, 10);\n\t\tdceip->dispclk_per_request = bw_int_to_fixed(2);\n\t\tdceip->dispclk_ramping_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->display_pipe_throughput_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->scatter_gather_pte_request_rows_in_tiling_mode = 2;\n\t\tdceip->mcifwr_all_surfaces_burst_time = bw_int_to_fixed(0);\n\t\tbreak;\n\tcase BW_CALCS_VERSION_VEGA10:\n\t\tvbios->memory_type = bw_def_hbm;\n\t\tvbios->dram_channel_width_in_bits = 128;\n\t\tvbios->number_of_dram_channels = asic_id.vram_width / vbios->dram_channel_width_in_bits;\n\t\tvbios->number_of_dram_banks = 16;\n\t\tvbios->high_yclk = bw_int_to_fixed(2400);\n\t\tvbios->mid_yclk = bw_int_to_fixed(1700);\n\t\tvbios->low_yclk = bw_int_to_fixed(1000);\n\t\tvbios->low_sclk = bw_int_to_fixed(300);\n\t\tvbios->mid1_sclk = bw_int_to_fixed(350);\n\t\tvbios->mid2_sclk = bw_int_to_fixed(400);\n\t\tvbios->mid3_sclk = bw_int_to_fixed(500);\n\t\tvbios->mid4_sclk = bw_int_to_fixed(600);\n\t\tvbios->mid5_sclk = bw_int_to_fixed(700);\n\t\tvbios->mid6_sclk = bw_int_to_fixed(760);\n\t\tvbios->high_sclk = bw_int_to_fixed(776);\n\t\tvbios->low_voltage_max_dispclk = bw_int_to_fixed(460);\n\t\tvbios->mid_voltage_max_dispclk = bw_int_to_fixed(670);\n\t\tvbios->high_voltage_max_dispclk = bw_int_to_fixed(1133);\n\t\tvbios->low_voltage_max_phyclk = bw_int_to_fixed(540);\n\t\tvbios->mid_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->high_voltage_max_phyclk = bw_int_to_fixed(810);\n\t\tvbios->data_return_bus_width = bw_int_to_fixed(32);\n\t\tvbios->trc = bw_int_to_fixed(48);\n\t\tvbios->dmifmc_urgent_latency = bw_int_to_fixed(3);\n\t\tvbios->stutter_self_refresh_exit_latency = bw_frc_to_fixed(75, 10);\n\t\tvbios->stutter_self_refresh_entry_latency = bw_frc_to_fixed(19, 10);\n\t\tvbios->nbp_state_change_latency = bw_int_to_fixed(39);\n\t\tvbios->mcifwrmc_urgent_latency = bw_int_to_fixed(10);\n\t\tvbios->scatter_gather_enable = false;\n\t\tvbios->down_spread_percentage = bw_frc_to_fixed(5, 10);\n\t\tvbios->cursor_width = 32;\n\t\tvbios->average_compression_rate = 4;\n\t\tvbios->number_of_request_slots_gmc_reserves_for_dmif_per_channel = 8;\n\t\tvbios->blackout_duration = bw_int_to_fixed(0);  \n\t\tvbios->maximum_blackout_recovery_time = bw_int_to_fixed(0);\n\n\t\tdceip->max_average_percent_of_ideal_port_bw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->max_average_percent_of_ideal_drambw_display_can_use_in_normal_system_operation = 100;\n\t\tdceip->percent_of_ideal_port_bw_received_after_urgent_latency = 100;\n\t\tdceip->large_cursor = false;\n\t\tdceip->dmif_request_buffer_size = bw_int_to_fixed(2304);\n\t\tdceip->dmif_pipe_en_fbc_chunk_tracker = true;\n\t\tdceip->cursor_max_outstanding_group_num = 1;\n\t\tdceip->lines_interleaved_into_lb = 2;\n\t\tdceip->chunk_width = 256;\n\t\tdceip->number_of_graphics_pipes = 6;\n\t\tdceip->number_of_underlay_pipes = 0;\n\t\tdceip->low_power_tiling_mode = 0;\n\t\tdceip->display_write_back_supported = true;\n\t\tdceip->argb_compression_support = true;\n\t\tdceip->underlay_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35556, 10000);\n\t\tdceip->underlay_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->underlay_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->underlay_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->graphics_vscaler_efficiency6_bit_per_component =\n\t\t\tbw_frc_to_fixed(35, 10);\n\t\tdceip->graphics_vscaler_efficiency8_bit_per_component =\n\t\t\tbw_frc_to_fixed(34286, 10000);\n\t\tdceip->graphics_vscaler_efficiency10_bit_per_component =\n\t\t\tbw_frc_to_fixed(32, 10);\n\t\tdceip->graphics_vscaler_efficiency12_bit_per_component =\n\t\t\tbw_int_to_fixed(3);\n\t\tdceip->alpha_vscaler_efficiency = bw_int_to_fixed(3);\n\t\tdceip->max_dmif_buffer_allocated = 4;\n\t\tdceip->graphics_dmif_size = 24576;\n\t\tdceip->underlay_luma_dmif_size = 19456;\n\t\tdceip->underlay_chroma_dmif_size = 23552;\n\t\tdceip->pre_downscaler_enabled = true;\n\t\tdceip->underlay_downscale_prefetch_enabled = false;\n\t\tdceip->lb_write_pixels_per_dispclk = bw_int_to_fixed(1);\n\t\tdceip->lb_size_per_component444 = bw_int_to_fixed(245952);\n\t\tdceip->graphics_lb_nodownscaling_multi_line_prefetching = true;\n\t\tdceip->stutter_and_dram_clock_state_change_gated_before_cursor =\n\t\t\tbw_int_to_fixed(1);\n\t\tdceip->underlay420_luma_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->underlay420_chroma_lb_size_per_component =\n\t\t\tbw_int_to_fixed(164352);\n\t\tdceip->underlay422_lb_size_per_component = bw_int_to_fixed(\n\t\t\t82176);\n\t\tdceip->cursor_chunk_width = bw_int_to_fixed(64);\n\t\tdceip->cursor_dcp_buffer_lines = bw_int_to_fixed(4);\n\t\tdceip->underlay_maximum_width_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1920);\n\t\tdceip->underlay_maximum_height_efficient_for_tiling =\n\t\t\tbw_int_to_fixed(1080);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_multiple_displays_or_single_rotated_display =\n\t\t\tbw_frc_to_fixed(3, 10);\n\t\tdceip->peak_pte_request_to_eviction_ratio_limiting_single_display_no_rotation =\n\t\t\tbw_int_to_fixed(25);\n\t\tdceip->minimum_outstanding_pte_request_limit = bw_int_to_fixed(\n\t\t\t2);\n\t\tdceip->maximum_total_outstanding_pte_requests_allowed_by_saw =\n\t\t\tbw_int_to_fixed(128);\n\t\tdceip->limit_excessive_outstanding_dmif_requests = true;\n\t\tdceip->linear_mode_line_request_alternation_slice =\n\t\t\tbw_int_to_fixed(64);\n\t\tdceip->scatter_gather_lines_of_pte_prefetching_in_linear_mode =\n\t\t\t32;\n\t\tdceip->display_write_back420_luma_mcifwr_buffer_size = 12288;\n\t\tdceip->display_write_back420_chroma_mcifwr_buffer_size = 8192;\n\t\tdceip->request_efficiency = bw_frc_to_fixed(8, 10);\n\t\tdceip->dispclk_per_request = bw_int_to_fixed(2);\n\t\tdceip->dispclk_ramping_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->display_pipe_throughput_factor = bw_frc_to_fixed(105, 100);\n\t\tdceip->scatter_gather_pte_request_rows_in_tiling_mode = 2;\n\t\tdceip->mcifwr_all_surfaces_burst_time = bw_int_to_fixed(0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\t*bw_dceip = *dceip;\n\t*bw_vbios = *vbios;\n\n\tkfree(dceip);\n\tkfree(vbios);\n}\n\n \nstatic bool is_display_configuration_supported(\n\tconst struct bw_calcs_vbios *vbios,\n\tconst struct dce_bw_output *calcs_output)\n{\n\tuint32_t int_max_clk;\n\n\tint_max_clk = bw_fixed_to_int(vbios->high_voltage_max_dispclk);\n\tint_max_clk *= 1000;  \n\tif (calcs_output->dispclk_khz > int_max_clk)\n\t\treturn false;\n\n\tint_max_clk = bw_fixed_to_int(vbios->high_sclk);\n\tint_max_clk *= 1000;  \n\tif (calcs_output->sclk_khz > int_max_clk)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic void populate_initial_data(\n\tconst struct pipe_ctx pipe[], int pipe_count, struct bw_calcs_data *data)\n{\n\tint i, j;\n\tint num_displays = 0;\n\n\tdata->underlay_surface_type = bw_def_420;\n\tdata->panning_and_bezel_adjustment = bw_def_none;\n\tdata->graphics_lb_bpc = 10;\n\tdata->underlay_lb_bpc = 8;\n\tdata->underlay_tiling_mode = bw_def_tiled;\n\tdata->graphics_tiling_mode = bw_def_tiled;\n\tdata->underlay_micro_tile_mode = bw_def_display_micro_tiling;\n\tdata->graphics_micro_tile_mode = bw_def_display_micro_tiling;\n\tdata->increase_voltage_to_support_mclk_switch = true;\n\n\t \n\tfor (i = 0; i < pipe_count; i++) {\n\t\tif (!pipe[i].stream || !pipe[i].bottom_pipe)\n\t\t\tcontinue;\n\n\t\tASSERT(pipe[i].plane_state);\n\n\t\tif (num_displays == 0) {\n\t\t\tif (!pipe[i].plane_state->visible)\n\t\t\t\tdata->d0_underlay_mode = bw_def_underlay_only;\n\t\t\telse\n\t\t\t\tdata->d0_underlay_mode = bw_def_blend;\n\t\t} else {\n\t\t\tif (!pipe[i].plane_state->visible)\n\t\t\t\tdata->d1_underlay_mode = bw_def_underlay_only;\n\t\t\telse\n\t\t\t\tdata->d1_underlay_mode = bw_def_blend;\n\t\t}\n\n\t\tdata->fbc_en[num_displays + 4] = false;\n\t\tdata->lpt_en[num_displays + 4] = false;\n\t\tdata->h_total[num_displays + 4] = bw_int_to_fixed(pipe[i].stream->timing.h_total);\n\t\tdata->v_total[num_displays + 4] = bw_int_to_fixed(pipe[i].stream->timing.v_total);\n\t\tdata->pixel_rate[num_displays + 4] = bw_frc_to_fixed(pipe[i].stream->timing.pix_clk_100hz, 10000);\n\t\tdata->src_width[num_displays + 4] = bw_int_to_fixed(pipe[i].plane_res.scl_data.viewport.width);\n\t\tdata->pitch_in_pixels[num_displays + 4] = data->src_width[num_displays + 4];\n\t\tdata->src_height[num_displays + 4] = bw_int_to_fixed(pipe[i].plane_res.scl_data.viewport.height);\n\t\tdata->h_taps[num_displays + 4] = bw_int_to_fixed(pipe[i].plane_res.scl_data.taps.h_taps);\n\t\tdata->v_taps[num_displays + 4] = bw_int_to_fixed(pipe[i].plane_res.scl_data.taps.v_taps);\n\t\tdata->h_scale_ratio[num_displays + 4] = fixed31_32_to_bw_fixed(pipe[i].plane_res.scl_data.ratios.horz.value);\n\t\tdata->v_scale_ratio[num_displays + 4] = fixed31_32_to_bw_fixed(pipe[i].plane_res.scl_data.ratios.vert.value);\n\t\tswitch (pipe[i].plane_state->rotation) {\n\t\tcase ROTATION_ANGLE_0:\n\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(0);\n\t\t\tbreak;\n\t\tcase ROTATION_ANGLE_90:\n\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(90);\n\t\t\tbreak;\n\t\tcase ROTATION_ANGLE_180:\n\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(180);\n\t\t\tbreak;\n\t\tcase ROTATION_ANGLE_270:\n\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(270);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tswitch (pipe[i].plane_state->format) {\n\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCbCr:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB1555:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB565:\n\t\t\tdata->bytes_per_pixel[num_displays + 4] = 2;\n\t\t\tbreak;\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB8888:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR8888:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB2101010:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR2101010:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR2101010_XR_BIAS:\n\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCbCr:\n\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCrCb:\n\t\t\tdata->bytes_per_pixel[num_displays + 4] = 4;\n\t\t\tbreak;\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616:\n\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616F:\n\t\t\tdata->bytes_per_pixel[num_displays + 4] = 8;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdata->bytes_per_pixel[num_displays + 4] = 4;\n\t\t\tbreak;\n\t\t}\n\t\tdata->interlace_mode[num_displays + 4] = false;\n\t\tdata->stereo_mode[num_displays + 4] = bw_def_mono;\n\n\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tdata->fbc_en[num_displays * 2 + j] = false;\n\t\t\tdata->lpt_en[num_displays * 2 + j] = false;\n\n\t\t\tdata->src_height[num_displays * 2 + j] = bw_int_to_fixed(pipe[i].bottom_pipe->plane_res.scl_data.viewport.height);\n\t\t\tdata->src_width[num_displays * 2 + j] = bw_int_to_fixed(pipe[i].bottom_pipe->plane_res.scl_data.viewport.width);\n\t\t\tdata->pitch_in_pixels[num_displays * 2 + j] = bw_int_to_fixed(\n\t\t\t\t\tpipe[i].bottom_pipe->plane_state->plane_size.surface_pitch);\n\t\t\tdata->h_taps[num_displays * 2 + j] = bw_int_to_fixed(pipe[i].bottom_pipe->plane_res.scl_data.taps.h_taps);\n\t\t\tdata->v_taps[num_displays * 2 + j] = bw_int_to_fixed(pipe[i].bottom_pipe->plane_res.scl_data.taps.v_taps);\n\t\t\tdata->h_scale_ratio[num_displays * 2 + j] = fixed31_32_to_bw_fixed(\n\t\t\t\t\tpipe[i].bottom_pipe->plane_res.scl_data.ratios.horz.value);\n\t\t\tdata->v_scale_ratio[num_displays * 2 + j] = fixed31_32_to_bw_fixed(\n\t\t\t\t\tpipe[i].bottom_pipe->plane_res.scl_data.ratios.vert.value);\n\t\t\tswitch (pipe[i].bottom_pipe->plane_state->rotation) {\n\t\t\tcase ROTATION_ANGLE_0:\n\t\t\t\tdata->rotation_angle[num_displays * 2 + j] = bw_int_to_fixed(0);\n\t\t\t\tbreak;\n\t\t\tcase ROTATION_ANGLE_90:\n\t\t\t\tdata->rotation_angle[num_displays * 2 + j] = bw_int_to_fixed(90);\n\t\t\t\tbreak;\n\t\t\tcase ROTATION_ANGLE_180:\n\t\t\t\tdata->rotation_angle[num_displays * 2 + j] = bw_int_to_fixed(180);\n\t\t\t\tbreak;\n\t\t\tcase ROTATION_ANGLE_270:\n\t\t\t\tdata->rotation_angle[num_displays * 2 + j] = bw_int_to_fixed(270);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdata->stereo_mode[num_displays * 2 + j] = bw_def_mono;\n\t\t}\n\n\t\tnum_displays++;\n\t}\n\n\t \n\tfor (i = 0; i < pipe_count; i++) {\n\t\tunsigned int pixel_clock_100hz;\n\t\tif (!pipe[i].stream || pipe[i].bottom_pipe)\n\t\t\tcontinue;\n\n\n\t\tdata->fbc_en[num_displays + 4] = false;\n\t\tdata->lpt_en[num_displays + 4] = false;\n\t\tdata->h_total[num_displays + 4] = bw_int_to_fixed(pipe[i].stream->timing.h_total);\n\t\tdata->v_total[num_displays + 4] = bw_int_to_fixed(pipe[i].stream->timing.v_total);\n\t\tpixel_clock_100hz = pipe[i].stream->timing.pix_clk_100hz;\n\t\tif (pipe[i].stream->timing.timing_3d_format == TIMING_3D_FORMAT_HW_FRAME_PACKING)\n\t\t\tpixel_clock_100hz *= 2;\n\t\tdata->pixel_rate[num_displays + 4] = bw_frc_to_fixed(pixel_clock_100hz, 10000);\n\t\tif (pipe[i].plane_state) {\n\t\t\tdata->src_width[num_displays + 4] = bw_int_to_fixed(pipe[i].plane_res.scl_data.viewport.width);\n\t\t\tdata->pitch_in_pixels[num_displays + 4] = data->src_width[num_displays + 4];\n\t\t\tdata->src_height[num_displays + 4] = bw_int_to_fixed(pipe[i].plane_res.scl_data.viewport.height);\n\t\t\tdata->h_taps[num_displays + 4] = bw_int_to_fixed(pipe[i].plane_res.scl_data.taps.h_taps);\n\t\t\tdata->v_taps[num_displays + 4] = bw_int_to_fixed(pipe[i].plane_res.scl_data.taps.v_taps);\n\t\t\tdata->h_scale_ratio[num_displays + 4] = fixed31_32_to_bw_fixed(pipe[i].plane_res.scl_data.ratios.horz.value);\n\t\t\tdata->v_scale_ratio[num_displays + 4] = fixed31_32_to_bw_fixed(pipe[i].plane_res.scl_data.ratios.vert.value);\n\t\t\tswitch (pipe[i].plane_state->rotation) {\n\t\t\tcase ROTATION_ANGLE_0:\n\t\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(0);\n\t\t\t\tbreak;\n\t\t\tcase ROTATION_ANGLE_90:\n\t\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(90);\n\t\t\t\tbreak;\n\t\t\tcase ROTATION_ANGLE_180:\n\t\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(180);\n\t\t\t\tbreak;\n\t\t\tcase ROTATION_ANGLE_270:\n\t\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(270);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tswitch (pipe[i].plane_state->format) {\n\t\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCbCr:\n\t\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_YCrCb:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB1555:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_RGB565:\n\t\t\t\tdata->bytes_per_pixel[num_displays + 4] = 2;\n\t\t\t\tbreak;\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB8888:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR8888:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB2101010:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR2101010:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR2101010_XR_BIAS:\n\t\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCbCr:\n\t\t\tcase SURFACE_PIXEL_FORMAT_VIDEO_420_10bpc_YCrCb:\n\t\t\t\tdata->bytes_per_pixel[num_displays + 4] = 4;\n\t\t\t\tbreak;\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ARGB16161616:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616:\n\t\t\tcase SURFACE_PIXEL_FORMAT_GRPH_ABGR16161616F:\n\t\t\t\tdata->bytes_per_pixel[num_displays + 4] = 8;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdata->bytes_per_pixel[num_displays + 4] = 4;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t} else if (pipe[i].stream->dst.width != 0 &&\n\t\t\t\t\tpipe[i].stream->dst.height != 0 &&\n\t\t\t\t\tpipe[i].stream->src.width != 0 &&\n\t\t\t\t\tpipe[i].stream->src.height != 0) {\n\t\t\tdata->src_width[num_displays + 4] = bw_int_to_fixed(pipe[i].stream->src.width);\n\t\t\tdata->pitch_in_pixels[num_displays + 4] = data->src_width[num_displays + 4];\n\t\t\tdata->src_height[num_displays + 4] = bw_int_to_fixed(pipe[i].stream->src.height);\n\t\t\tdata->h_taps[num_displays + 4] = pipe[i].stream->src.width == pipe[i].stream->dst.width ? bw_int_to_fixed(1) : bw_int_to_fixed(2);\n\t\t\tdata->v_taps[num_displays + 4] = pipe[i].stream->src.height == pipe[i].stream->dst.height ? bw_int_to_fixed(1) : bw_int_to_fixed(2);\n\t\t\tdata->h_scale_ratio[num_displays + 4] = bw_frc_to_fixed(pipe[i].stream->src.width, pipe[i].stream->dst.width);\n\t\t\tdata->v_scale_ratio[num_displays + 4] = bw_frc_to_fixed(pipe[i].stream->src.height, pipe[i].stream->dst.height);\n\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(0);\n\t\t\tdata->bytes_per_pixel[num_displays + 4] = 4;\n\t\t} else {\n\t\t\tdata->src_width[num_displays + 4] = bw_int_to_fixed(pipe[i].stream->timing.h_addressable);\n\t\t\tdata->pitch_in_pixels[num_displays + 4] = data->src_width[num_displays + 4];\n\t\t\tdata->src_height[num_displays + 4] = bw_int_to_fixed(pipe[i].stream->timing.v_addressable);\n\t\t\tdata->h_taps[num_displays + 4] = bw_int_to_fixed(1);\n\t\t\tdata->v_taps[num_displays + 4] = bw_int_to_fixed(1);\n\t\t\tdata->h_scale_ratio[num_displays + 4] = bw_int_to_fixed(1);\n\t\t\tdata->v_scale_ratio[num_displays + 4] = bw_int_to_fixed(1);\n\t\t\tdata->rotation_angle[num_displays + 4] = bw_int_to_fixed(0);\n\t\t\tdata->bytes_per_pixel[num_displays + 4] = 4;\n\t\t}\n\n\t\tdata->interlace_mode[num_displays + 4] = false;\n\t\tdata->stereo_mode[num_displays + 4] = bw_def_mono;\n\t\tnum_displays++;\n\t}\n\n\tdata->number_of_displays = num_displays;\n}\n\nstatic bool all_displays_in_sync(const struct pipe_ctx pipe[],\n\t\t\t\t int pipe_count)\n{\n\tconst struct pipe_ctx *active_pipes[MAX_PIPES];\n\tint i, num_active_pipes = 0;\n\n\tfor (i = 0; i < pipe_count; i++) {\n\t\tif (!resource_is_pipe_type(&pipe[i], OPP_HEAD))\n\t\t\tcontinue;\n\n\t\tactive_pipes[num_active_pipes++] = &pipe[i];\n\t}\n\n\tif (!num_active_pipes)\n\t\treturn false;\n\n\tfor (i = 1; i < num_active_pipes; ++i) {\n\t\tif (!resource_are_streams_timing_synchronizable(\n\t\t\t    active_pipes[0]->stream, active_pipes[i]->stream)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\n \nbool bw_calcs(struct dc_context *ctx,\n\tconst struct bw_calcs_dceip *dceip,\n\tconst struct bw_calcs_vbios *vbios,\n\tconst struct pipe_ctx pipe[],\n\tint pipe_count,\n\tstruct dce_bw_output *calcs_output)\n{\n\tstruct bw_calcs_data *data = kzalloc(sizeof(struct bw_calcs_data),\n\t\t\t\t\t     GFP_KERNEL);\n\tif (!data)\n\t\treturn false;\n\n\tpopulate_initial_data(pipe, pipe_count, data);\n\n\tif (ctx->dc->config.multi_mon_pp_mclk_switch)\n\t\tcalcs_output->all_displays_in_sync = all_displays_in_sync(pipe, pipe_count);\n\telse\n\t\tcalcs_output->all_displays_in_sync = false;\n\n\tif (data->number_of_displays != 0) {\n\t\tuint8_t yclk_lvl;\n\t\tstruct bw_fixed high_sclk = vbios->high_sclk;\n\t\tstruct bw_fixed mid1_sclk = vbios->mid1_sclk;\n\t\tstruct bw_fixed mid2_sclk = vbios->mid2_sclk;\n\t\tstruct bw_fixed mid3_sclk = vbios->mid3_sclk;\n\t\tstruct bw_fixed mid4_sclk = vbios->mid4_sclk;\n\t\tstruct bw_fixed mid5_sclk = vbios->mid5_sclk;\n\t\tstruct bw_fixed mid6_sclk = vbios->mid6_sclk;\n\t\tstruct bw_fixed low_sclk = vbios->low_sclk;\n\t\tstruct bw_fixed high_yclk = vbios->high_yclk;\n\t\tstruct bw_fixed mid_yclk = vbios->mid_yclk;\n\t\tstruct bw_fixed low_yclk = vbios->low_yclk;\n\n\t\tif (ctx->dc->debug.bandwidth_calcs_trace) {\n\t\t\tprint_bw_calcs_dceip(ctx, dceip);\n\t\t\tprint_bw_calcs_vbios(ctx, vbios);\n\t\t\tprint_bw_calcs_data(ctx, data);\n\t\t}\n\t\tcalculate_bandwidth(dceip, vbios, data);\n\n\t\tyclk_lvl = data->y_clk_level;\n\n\t\tcalcs_output->nbp_state_change_enable =\n\t\t\tdata->nbp_state_change_enable;\n\t\tcalcs_output->cpuc_state_change_enable =\n\t\t\t\tdata->cpuc_state_change_enable;\n\t\tcalcs_output->cpup_state_change_enable =\n\t\t\t\tdata->cpup_state_change_enable;\n\t\tcalcs_output->stutter_mode_enable =\n\t\t\t\tdata->stutter_mode_enable;\n\t\tcalcs_output->dispclk_khz =\n\t\t\tbw_fixed_to_int(bw_mul(data->dispclk,\n\t\t\t\t\tbw_int_to_fixed(1000)));\n\t\tcalcs_output->blackout_recovery_time_us =\n\t\t\tbw_fixed_to_int(data->blackout_recovery_time);\n\t\tcalcs_output->sclk_khz =\n\t\t\tbw_fixed_to_int(bw_mul(data->required_sclk,\n\t\t\t\t\tbw_int_to_fixed(1000)));\n\t\tcalcs_output->sclk_deep_sleep_khz =\n\t\t\tbw_fixed_to_int(bw_mul(data->sclk_deep_sleep,\n\t\t\t\t\tbw_int_to_fixed(1000)));\n\t\tif (yclk_lvl == 0)\n\t\t\tcalcs_output->yclk_khz = bw_fixed_to_int(\n\t\t\t\tbw_mul(low_yclk, bw_int_to_fixed(1000)));\n\t\telse if (yclk_lvl == 1)\n\t\t\tcalcs_output->yclk_khz = bw_fixed_to_int(\n\t\t\t\tbw_mul(mid_yclk, bw_int_to_fixed(1000)));\n\t\telse\n\t\t\tcalcs_output->yclk_khz = bw_fixed_to_int(\n\t\t\t\tbw_mul(high_yclk, bw_int_to_fixed(1000)));\n\n\t\t \n\n\t\tcalcs_output->nbp_state_change_wm_ns[0].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tnbp_state_change_watermark[4], bw_int_to_fixed(1000)));\n\t\tcalcs_output->nbp_state_change_wm_ns[1].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tnbp_state_change_watermark[5], bw_int_to_fixed(1000)));\n\t\tcalcs_output->nbp_state_change_wm_ns[2].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tnbp_state_change_watermark[6], bw_int_to_fixed(1000)));\n\n\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\tcalcs_output->nbp_state_change_wm_ns[3].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[0], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->nbp_state_change_wm_ns[4].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\t\tnbp_state_change_watermark[1], bw_int_to_fixed(1000)));\n\t\t} else {\n\t\t\tcalcs_output->nbp_state_change_wm_ns[3].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[7], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->nbp_state_change_wm_ns[4].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[8], bw_int_to_fixed(1000)));\n\t\t}\n\t\tcalcs_output->nbp_state_change_wm_ns[5].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tnbp_state_change_watermark[9], bw_int_to_fixed(1000)));\n\n\n\n\t\tcalcs_output->stutter_exit_wm_ns[0].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_exit_watermark[4], bw_int_to_fixed(1000)));\n\t\tcalcs_output->stutter_exit_wm_ns[1].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_exit_watermark[5], bw_int_to_fixed(1000)));\n\t\tcalcs_output->stutter_exit_wm_ns[2].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_exit_watermark[6], bw_int_to_fixed(1000)));\n\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\tcalcs_output->stutter_exit_wm_ns[3].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[0], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_exit_wm_ns[4].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[1], bw_int_to_fixed(1000)));\n\t\t} else {\n\t\t\tcalcs_output->stutter_exit_wm_ns[3].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[7], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_exit_wm_ns[4].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[8], bw_int_to_fixed(1000)));\n\t\t}\n\t\tcalcs_output->stutter_exit_wm_ns[5].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_exit_watermark[9], bw_int_to_fixed(1000)));\n\n\t\tcalcs_output->stutter_entry_wm_ns[0].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_entry_watermark[4], bw_int_to_fixed(1000)));\n\t\tcalcs_output->stutter_entry_wm_ns[1].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_entry_watermark[5], bw_int_to_fixed(1000)));\n\t\tcalcs_output->stutter_entry_wm_ns[2].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_entry_watermark[6], bw_int_to_fixed(1000)));\n\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\tcalcs_output->stutter_entry_wm_ns[3].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[0], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_entry_wm_ns[4].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[1], bw_int_to_fixed(1000)));\n\t\t} else {\n\t\t\tcalcs_output->stutter_entry_wm_ns[3].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[7], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_entry_wm_ns[4].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[8], bw_int_to_fixed(1000)));\n\t\t}\n\t\tcalcs_output->stutter_entry_wm_ns[5].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_entry_watermark[9], bw_int_to_fixed(1000)));\n\n\t\tcalcs_output->urgent_wm_ns[0].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\turgent_watermark[4], bw_int_to_fixed(1000)));\n\t\tcalcs_output->urgent_wm_ns[1].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\turgent_watermark[5], bw_int_to_fixed(1000)));\n\t\tcalcs_output->urgent_wm_ns[2].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\turgent_watermark[6], bw_int_to_fixed(1000)));\n\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\tcalcs_output->urgent_wm_ns[3].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[0], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->urgent_wm_ns[4].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[1], bw_int_to_fixed(1000)));\n\t\t} else {\n\t\t\tcalcs_output->urgent_wm_ns[3].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[7], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->urgent_wm_ns[4].a_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[8], bw_int_to_fixed(1000)));\n\t\t}\n\t\tcalcs_output->urgent_wm_ns[5].a_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\turgent_watermark[9], bw_int_to_fixed(1000)));\n\n\t\tif (dceip->version != BW_CALCS_VERSION_CARRIZO) {\n\t\t\t((struct bw_calcs_vbios *)vbios)->low_sclk = mid3_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid1_sclk = mid3_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid2_sclk = mid3_sclk;\n\t\t\tcalculate_bandwidth(dceip, vbios, data);\n\n\t\t\tcalcs_output->nbp_state_change_wm_ns[0].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[4],bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->nbp_state_change_wm_ns[1].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[5], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->nbp_state_change_wm_ns[2].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[6], bw_int_to_fixed(1000)));\n\n\t\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\t\tcalcs_output->nbp_state_change_wm_ns[3].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tnbp_state_change_watermark[0], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->nbp_state_change_wm_ns[4].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tnbp_state_change_watermark[1], bw_int_to_fixed(1000)));\n\t\t\t} else {\n\t\t\t\tcalcs_output->nbp_state_change_wm_ns[3].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tnbp_state_change_watermark[7], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->nbp_state_change_wm_ns[4].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tnbp_state_change_watermark[8], bw_int_to_fixed(1000)));\n\t\t\t}\n\t\t\tcalcs_output->nbp_state_change_wm_ns[5].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[9], bw_int_to_fixed(1000)));\n\n\n\n\t\t\tcalcs_output->stutter_exit_wm_ns[0].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[4], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_exit_wm_ns[1].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[5], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_exit_wm_ns[2].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[6], bw_int_to_fixed(1000)));\n\t\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\t\tcalcs_output->stutter_exit_wm_ns[3].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_exit_watermark[0], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->stutter_exit_wm_ns[4].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_exit_watermark[1], bw_int_to_fixed(1000)));\n\t\t\t} else {\n\t\t\t\tcalcs_output->stutter_exit_wm_ns[3].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_exit_watermark[7], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->stutter_exit_wm_ns[4].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_exit_watermark[8], bw_int_to_fixed(1000)));\n\t\t\t}\n\t\t\tcalcs_output->stutter_exit_wm_ns[5].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[9], bw_int_to_fixed(1000)));\n\n\t\t\tcalcs_output->stutter_entry_wm_ns[0].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[4], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_entry_wm_ns[1].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[5], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_entry_wm_ns[2].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[6], bw_int_to_fixed(1000)));\n\t\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\t\tcalcs_output->stutter_entry_wm_ns[3].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_entry_watermark[0], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->stutter_entry_wm_ns[4].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_entry_watermark[1], bw_int_to_fixed(1000)));\n\t\t\t} else {\n\t\t\t\tcalcs_output->stutter_entry_wm_ns[3].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_entry_watermark[7], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->stutter_entry_wm_ns[4].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_entry_watermark[8], bw_int_to_fixed(1000)));\n\t\t\t}\n\t\t\tcalcs_output->stutter_entry_wm_ns[5].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[9], bw_int_to_fixed(1000)));\n\n\t\t\tcalcs_output->urgent_wm_ns[0].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[4], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->urgent_wm_ns[1].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[5], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->urgent_wm_ns[2].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[6], bw_int_to_fixed(1000)));\n\t\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\t\tcalcs_output->urgent_wm_ns[3].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\turgent_watermark[0], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->urgent_wm_ns[4].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\turgent_watermark[1], bw_int_to_fixed(1000)));\n\t\t\t} else {\n\t\t\t\tcalcs_output->urgent_wm_ns[3].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\turgent_watermark[7], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->urgent_wm_ns[4].b_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\turgent_watermark[8], bw_int_to_fixed(1000)));\n\t\t\t}\n\t\t\tcalcs_output->urgent_wm_ns[5].b_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[9], bw_int_to_fixed(1000)));\n\n\t\t\t((struct bw_calcs_vbios *)vbios)->low_sclk = low_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid1_sclk = mid1_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid2_sclk = mid2_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->low_yclk = mid_yclk;\n\t\t\tcalculate_bandwidth(dceip, vbios, data);\n\n\t\t\tcalcs_output->nbp_state_change_wm_ns[0].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[4], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->nbp_state_change_wm_ns[1].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[5], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->nbp_state_change_wm_ns[2].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[6], bw_int_to_fixed(1000)));\n\t\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\t\tcalcs_output->nbp_state_change_wm_ns[3].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tnbp_state_change_watermark[0], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->nbp_state_change_wm_ns[4].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tnbp_state_change_watermark[1], bw_int_to_fixed(1000)));\n\t\t\t} else {\n\t\t\t\tcalcs_output->nbp_state_change_wm_ns[3].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tnbp_state_change_watermark[7], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->nbp_state_change_wm_ns[4].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tnbp_state_change_watermark[8], bw_int_to_fixed(1000)));\n\t\t\t}\n\t\t\tcalcs_output->nbp_state_change_wm_ns[5].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[9], bw_int_to_fixed(1000)));\n\n\n\t\t\tcalcs_output->stutter_exit_wm_ns[0].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[4], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_exit_wm_ns[1].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[5], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_exit_wm_ns[2].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[6], bw_int_to_fixed(1000)));\n\t\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\t\tcalcs_output->stutter_exit_wm_ns[3].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_exit_watermark[0], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->stutter_exit_wm_ns[4].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_exit_watermark[1], bw_int_to_fixed(1000)));\n\t\t\t} else {\n\t\t\t\tcalcs_output->stutter_exit_wm_ns[3].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_exit_watermark[7], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->stutter_exit_wm_ns[4].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\tstutter_exit_watermark[8], bw_int_to_fixed(1000)));\n\t\t\t}\n\t\t\tcalcs_output->stutter_exit_wm_ns[5].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[9], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_entry_wm_ns[0].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[4], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_entry_wm_ns[1].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[5], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_entry_wm_ns[2].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[6], bw_int_to_fixed(1000)));\n\t\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\t\tcalcs_output->stutter_entry_wm_ns[3].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->stutter_entry_watermark[0],\n\t\t\t\t\t\tbw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->stutter_entry_wm_ns[4].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->stutter_entry_watermark[1],\n\t\t\t\t\t\tbw_int_to_fixed(1000)));\n\t\t\t} else {\n\t\t\t\tcalcs_output->stutter_entry_wm_ns[3].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->stutter_entry_watermark[7],\n\t\t\t\t\t\tbw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->stutter_entry_wm_ns[4].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->stutter_entry_watermark[8],\n\t\t\t\t\t\tbw_int_to_fixed(1000)));\n\t\t\t}\n\t\t\tcalcs_output->stutter_entry_wm_ns[5].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[9], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->urgent_wm_ns[0].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[4], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->urgent_wm_ns[1].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[5], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->urgent_wm_ns[2].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[6], bw_int_to_fixed(1000)));\n\t\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\t\tcalcs_output->urgent_wm_ns[3].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\turgent_watermark[0], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->urgent_wm_ns[4].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\turgent_watermark[1], bw_int_to_fixed(1000)));\n\t\t\t} else {\n\t\t\t\tcalcs_output->urgent_wm_ns[3].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\turgent_watermark[7], bw_int_to_fixed(1000)));\n\t\t\t\tcalcs_output->urgent_wm_ns[4].c_mark =\n\t\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\t\turgent_watermark[8], bw_int_to_fixed(1000)));\n\t\t\t}\n\t\t\tcalcs_output->urgent_wm_ns[5].c_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[9], bw_int_to_fixed(1000)));\n\t\t}\n\n\t\tif (dceip->version == BW_CALCS_VERSION_CARRIZO) {\n\t\t\t((struct bw_calcs_vbios *)vbios)->low_yclk = high_yclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid_yclk = high_yclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->low_sclk = high_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid1_sclk = high_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid2_sclk = high_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid3_sclk = high_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid4_sclk = high_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid5_sclk = high_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid6_sclk = high_sclk;\n\t\t} else {\n\t\t\t((struct bw_calcs_vbios *)vbios)->low_yclk = mid_yclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->low_sclk = mid3_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid1_sclk = mid3_sclk;\n\t\t\t((struct bw_calcs_vbios *)vbios)->mid2_sclk = mid3_sclk;\n\t\t}\n\n\t\tcalculate_bandwidth(dceip, vbios, data);\n\n\t\tcalcs_output->nbp_state_change_wm_ns[0].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tnbp_state_change_watermark[4], bw_int_to_fixed(1000)));\n\t\tcalcs_output->nbp_state_change_wm_ns[1].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tnbp_state_change_watermark[5], bw_int_to_fixed(1000)));\n\t\tcalcs_output->nbp_state_change_wm_ns[2].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tnbp_state_change_watermark[6], bw_int_to_fixed(1000)));\n\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\tcalcs_output->nbp_state_change_wm_ns[3].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[0], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->nbp_state_change_wm_ns[4].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[1], bw_int_to_fixed(1000)));\n\t\t} else {\n\t\t\tcalcs_output->nbp_state_change_wm_ns[3].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[7], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->nbp_state_change_wm_ns[4].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tnbp_state_change_watermark[8], bw_int_to_fixed(1000)));\n\t\t}\n\t\tcalcs_output->nbp_state_change_wm_ns[5].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tnbp_state_change_watermark[9], bw_int_to_fixed(1000)));\n\n\t\tcalcs_output->stutter_exit_wm_ns[0].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_exit_watermark[4], bw_int_to_fixed(1000)));\n\t\tcalcs_output->stutter_exit_wm_ns[1].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_exit_watermark[5], bw_int_to_fixed(1000)));\n\t\tcalcs_output->stutter_exit_wm_ns[2].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_exit_watermark[6], bw_int_to_fixed(1000)));\n\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\tcalcs_output->stutter_exit_wm_ns[3].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[0], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_exit_wm_ns[4].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[1], bw_int_to_fixed(1000)));\n\t\t} else {\n\t\t\tcalcs_output->stutter_exit_wm_ns[3].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[7], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_exit_wm_ns[4].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_exit_watermark[8], bw_int_to_fixed(1000)));\n\t\t}\n\t\tcalcs_output->stutter_exit_wm_ns[5].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_exit_watermark[9], bw_int_to_fixed(1000)));\n\n\t\tcalcs_output->stutter_entry_wm_ns[0].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_entry_watermark[4], bw_int_to_fixed(1000)));\n\t\tcalcs_output->stutter_entry_wm_ns[1].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_entry_watermark[5], bw_int_to_fixed(1000)));\n\t\tcalcs_output->stutter_entry_wm_ns[2].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_entry_watermark[6], bw_int_to_fixed(1000)));\n\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\tcalcs_output->stutter_entry_wm_ns[3].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[0], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_entry_wm_ns[4].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[1], bw_int_to_fixed(1000)));\n\t\t} else {\n\t\t\tcalcs_output->stutter_entry_wm_ns[3].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[7], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->stutter_entry_wm_ns[4].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\tstutter_entry_watermark[8], bw_int_to_fixed(1000)));\n\t\t}\n\t\tcalcs_output->stutter_entry_wm_ns[5].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\tstutter_entry_watermark[9], bw_int_to_fixed(1000)));\n\n\t\tcalcs_output->urgent_wm_ns[0].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\turgent_watermark[4], bw_int_to_fixed(1000)));\n\t\tcalcs_output->urgent_wm_ns[1].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\turgent_watermark[5], bw_int_to_fixed(1000)));\n\t\tcalcs_output->urgent_wm_ns[2].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\turgent_watermark[6], bw_int_to_fixed(1000)));\n\t\tif (ctx->dc->caps.max_slave_planes) {\n\t\t\tcalcs_output->urgent_wm_ns[3].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[0], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->urgent_wm_ns[4].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[1], bw_int_to_fixed(1000)));\n\t\t} else {\n\t\t\tcalcs_output->urgent_wm_ns[3].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[7], bw_int_to_fixed(1000)));\n\t\t\tcalcs_output->urgent_wm_ns[4].d_mark =\n\t\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\t\turgent_watermark[8], bw_int_to_fixed(1000)));\n\t\t}\n\t\tcalcs_output->urgent_wm_ns[5].d_mark =\n\t\t\tbw_fixed_to_int(bw_mul(data->\n\t\t\t\turgent_watermark[9], bw_int_to_fixed(1000)));\n\n\t\t((struct bw_calcs_vbios *)vbios)->low_yclk = low_yclk;\n\t\t((struct bw_calcs_vbios *)vbios)->mid_yclk = mid_yclk;\n\t\t((struct bw_calcs_vbios *)vbios)->low_sclk = low_sclk;\n\t\t((struct bw_calcs_vbios *)vbios)->mid1_sclk = mid1_sclk;\n\t\t((struct bw_calcs_vbios *)vbios)->mid2_sclk = mid2_sclk;\n\t\t((struct bw_calcs_vbios *)vbios)->mid3_sclk = mid3_sclk;\n\t\t((struct bw_calcs_vbios *)vbios)->mid4_sclk = mid4_sclk;\n\t\t((struct bw_calcs_vbios *)vbios)->mid5_sclk = mid5_sclk;\n\t\t((struct bw_calcs_vbios *)vbios)->mid6_sclk = mid6_sclk;\n\t\t((struct bw_calcs_vbios *)vbios)->high_sclk = high_sclk;\n\t} else {\n\t\tcalcs_output->nbp_state_change_enable = true;\n\t\tcalcs_output->cpuc_state_change_enable = true;\n\t\tcalcs_output->cpup_state_change_enable = true;\n\t\tcalcs_output->stutter_mode_enable = true;\n\t\tcalcs_output->dispclk_khz = 0;\n\t\tcalcs_output->sclk_khz = 0;\n\t}\n\n\tkfree(data);\n\n\treturn is_display_configuration_supported(vbios, calcs_output);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}