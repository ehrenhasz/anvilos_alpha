{
  "module_name": "rc_calc_fpu.c",
  "hash_id": "d5a875bb8b8a0422d69f6f223dee61f903c8ff63de824d1d64a2043943b20aad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/dsc/rc_calc_fpu.c",
  "human_readable_source": " \n\n#include \"rc_calc_fpu.h\"\n\n#include \"qp_tables.h\"\n#include \"amdgpu_dm/dc_fpu.h\"\n\n#define table_hash(mode, bpc, max_min) ((mode << 16) | (bpc << 8) | max_min)\n\n#define MODE_SELECT(val444, val422, val420) \\\n\t(cm == CM_444 || cm == CM_RGB) ? (val444) : (cm == CM_422 ? (val422) : (val420))\n\n\n#define TABLE_CASE(mode, bpc, max)   case (table_hash(mode, BPC_##bpc, max)): \\\n\ttable = qp_table_##mode##_##bpc##bpc_##max; \\\n\ttable_size = sizeof(qp_table_##mode##_##bpc##bpc_##max)/sizeof(*qp_table_##mode##_##bpc##bpc_##max); \\\n\tbreak\n\nstatic int median3(int a, int b, int c)\n{\n\tif (a > b)\n\t\tswap(a, b);\n\tif (b > c)\n\t\tswap(b, c);\n\tif (a > b)\n\t\tswap(b, c);\n\n\treturn b;\n}\n\nstatic double dsc_roundf(double num)\n{\n\tif (num < 0.0)\n\t\tnum = num - 0.5;\n\telse\n\t\tnum = num + 0.5;\n\n\treturn (int)(num);\n}\n\nstatic void get_qp_set(qp_set qps, enum colour_mode cm, enum bits_per_comp bpc,\n\t\t       enum max_min max_min, float bpp)\n{\n\tint mode = MODE_SELECT(444, 422, 420);\n\tint sel = table_hash(mode, bpc, max_min);\n\tint table_size = 0;\n\tint index;\n\tconst struct qp_entry *table = NULL;\n\n\t\n\tenum { min = DAL_MM_MIN, max = DAL_MM_MAX };\n\tswitch (sel) {\n\t\tTABLE_CASE(444,  8, max);\n\t\tTABLE_CASE(444,  8, min);\n\t\tTABLE_CASE(444, 10, max);\n\t\tTABLE_CASE(444, 10, min);\n\t\tTABLE_CASE(444, 12, max);\n\t\tTABLE_CASE(444, 12, min);\n\t\tTABLE_CASE(422,  8, max);\n\t\tTABLE_CASE(422,  8, min);\n\t\tTABLE_CASE(422, 10, max);\n\t\tTABLE_CASE(422, 10, min);\n\t\tTABLE_CASE(422, 12, max);\n\t\tTABLE_CASE(422, 12, min);\n\t\tTABLE_CASE(420,  8, max);\n\t\tTABLE_CASE(420,  8, min);\n\t\tTABLE_CASE(420, 10, max);\n\t\tTABLE_CASE(420, 10, min);\n\t\tTABLE_CASE(420, 12, max);\n\t\tTABLE_CASE(420, 12, min);\n\t}\n\n\tif (!table)\n\t\treturn;\n\n\tindex = (bpp - table[0].bpp) * 2;\n\n\t \n\tif (index >= table_size) {\n\t\tdm_error(\"ERROR: Requested rc_calc to find a bpp entry that exceeds the table size\\n\");\n\t\treturn;\n\t}\n\n\tmemcpy(qps, table[index].qps, sizeof(qp_set));\n}\n\nstatic void get_ofs_set(qp_set ofs, enum colour_mode mode, float bpp)\n{\n\tint   *p = ofs;\n\n\tif (mode == CM_444 || mode == CM_RGB) {\n\t\t*p++ = (bpp <=  6) ? (0) : ((((bpp >=  8) && (bpp <= 12))) ? (2) : ((bpp >= 15) ? (10) : ((((bpp > 6) && (bpp < 8))) ? (0 + dsc_roundf((bpp -  6) * (2 / 2.0))) : (2 + dsc_roundf((bpp - 12) * (8 / 3.0))))));\n\t\t*p++ = (bpp <=  6) ? (-2) : ((((bpp >=  8) && (bpp <= 12))) ? (0) : ((bpp >= 15) ? (8) : ((((bpp > 6) && (bpp < 8))) ? (-2 + dsc_roundf((bpp -  6) * (2 / 2.0))) : (0 + dsc_roundf((bpp - 12) * (8 / 3.0))))));\n\t\t*p++ = (bpp <=  6) ? (-2) : ((((bpp >=  8) && (bpp <= 12))) ? (0) : ((bpp >= 15) ? (6) : ((((bpp > 6) && (bpp < 8))) ? (-2 + dsc_roundf((bpp -  6) * (2 / 2.0))) : (0 + dsc_roundf((bpp - 12) * (6 / 3.0))))));\n\t\t*p++ = (bpp <=  6) ? (-4) : ((((bpp >=  8) && (bpp <= 12))) ? (-2) : ((bpp >= 15) ? (4) : ((((bpp > 6) && (bpp < 8))) ? (-4 + dsc_roundf((bpp -  6) * (2 / 2.0))) : (-2 + dsc_roundf((bpp - 12) * (6 / 3.0))))));\n\t\t*p++ = (bpp <=  6) ? (-6) : ((((bpp >=  8) && (bpp <= 12))) ? (-4) : ((bpp >= 15) ? (2) : ((((bpp > 6) && (bpp < 8))) ? (-6 + dsc_roundf((bpp -  6) * (2 / 2.0))) : (-4 + dsc_roundf((bpp - 12) * (6 / 3.0))))));\n\t\t*p++ = (bpp <= 12) ? (-6) : ((bpp >= 15) ? (0) : (-6 + dsc_roundf((bpp - 12) * (6 / 3.0))));\n\t\t*p++ = (bpp <= 12) ? (-8) : ((bpp >= 15) ? (-2) : (-8 + dsc_roundf((bpp - 12) * (6 / 3.0))));\n\t\t*p++ = (bpp <= 12) ? (-8) : ((bpp >= 15) ? (-4) : (-8 + dsc_roundf((bpp - 12) * (4 / 3.0))));\n\t\t*p++ = (bpp <= 12) ? (-8) : ((bpp >= 15) ? (-6) : (-8 + dsc_roundf((bpp - 12) * (2 / 3.0))));\n\t\t*p++ = (bpp <= 12) ? (-10) : ((bpp >= 15) ? (-8) : (-10 + dsc_roundf((bpp - 12) * (2 / 3.0))));\n\t\t*p++ = -10;\n\t\t*p++ = (bpp <=  6) ? (-12) : ((bpp >=  8) ? (-10) : (-12 + dsc_roundf((bpp -  6) * (2 / 2.0))));\n\t\t*p++ = -12;\n\t\t*p++ = -12;\n\t\t*p++ = -12;\n\t} else if (mode == CM_422) {\n\t\t*p++ = (bpp <=  8) ? (2) : ((bpp >= 10) ? (10) : (2 + dsc_roundf((bpp -  8) * (8 / 2.0))));\n\t\t*p++ = (bpp <=  8) ? (0) : ((bpp >= 10) ? (8) : (0 + dsc_roundf((bpp -  8) * (8 / 2.0))));\n\t\t*p++ = (bpp <=  8) ? (0) : ((bpp >= 10) ? (6) : (0 + dsc_roundf((bpp -  8) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  8) ? (-2) : ((bpp >= 10) ? (4) : (-2 + dsc_roundf((bpp -  8) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  8) ? (-4) : ((bpp >= 10) ? (2) : (-4 + dsc_roundf((bpp -  8) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  8) ? (-6) : ((bpp >= 10) ? (0) : (-6 + dsc_roundf((bpp -  8) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  8) ? (-8) : ((bpp >= 10) ? (-2) : (-8 + dsc_roundf((bpp -  8) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  8) ? (-8) : ((bpp >= 10) ? (-4) : (-8 + dsc_roundf((bpp -  8) * (4 / 2.0))));\n\t\t*p++ = (bpp <=  8) ? (-8) : ((bpp >= 10) ? (-6) : (-8 + dsc_roundf((bpp -  8) * (2 / 2.0))));\n\t\t*p++ = (bpp <=  8) ? (-10) : ((bpp >= 10) ? (-8) : (-10 + dsc_roundf((bpp -  8) * (2 / 2.0))));\n\t\t*p++ = -10;\n\t\t*p++ = (bpp <=  6) ? (-12) : ((bpp >= 7) ? (-10) : (-12 + dsc_roundf((bpp -  6) * (2.0 / 1))));\n\t\t*p++ = -12;\n\t\t*p++ = -12;\n\t\t*p++ = -12;\n\t} else {\n\t\t*p++ = (bpp <=  6) ? (2) : ((bpp >=  8) ? (10) : (2 + dsc_roundf((bpp -  6) * (8 / 2.0))));\n\t\t*p++ = (bpp <=  6) ? (0) : ((bpp >=  8) ? (8) : (0 + dsc_roundf((bpp -  6) * (8 / 2.0))));\n\t\t*p++ = (bpp <=  6) ? (0) : ((bpp >=  8) ? (6) : (0 + dsc_roundf((bpp -  6) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  6) ? (-2) : ((bpp >=  8) ? (4) : (-2 + dsc_roundf((bpp -  6) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  6) ? (-4) : ((bpp >=  8) ? (2) : (-4 + dsc_roundf((bpp -  6) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  6) ? (-6) : ((bpp >=  8) ? (0) : (-6 + dsc_roundf((bpp -  6) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  6) ? (-8) : ((bpp >=  8) ? (-2) : (-8 + dsc_roundf((bpp -  6) * (6 / 2.0))));\n\t\t*p++ = (bpp <=  6) ? (-8) : ((bpp >=  8) ? (-4) : (-8 + dsc_roundf((bpp -  6) * (4 / 2.0))));\n\t\t*p++ = (bpp <=  6) ? (-8) : ((bpp >=  8) ? (-6) : (-8 + dsc_roundf((bpp -  6) * (2 / 2.0))));\n\t\t*p++ = (bpp <=  6) ? (-10) : ((bpp >=  8) ? (-8) : (-10 + dsc_roundf((bpp -  6) * (2 / 2.0))));\n\t\t*p++ = -10;\n\t\t*p++ = (bpp <=  4) ? (-12) : ((bpp >=  5) ? (-10) : (-12 + dsc_roundf((bpp -  4) * (2 / 1.0))));\n\t\t*p++ = -12;\n\t\t*p++ = -12;\n\t\t*p++ = -12;\n\t}\n}\n\nvoid _do_calc_rc_params(struct rc_params *rc,\n\t\tenum colour_mode cm,\n\t\tenum bits_per_comp bpc,\n\t\tu16 drm_bpp,\n\t\tbool is_navite_422_or_420,\n\t\tint slice_width,\n\t\tint slice_height,\n\t\tint minor_version)\n{\n\tfloat bpp;\n\tfloat bpp_group;\n\tfloat initial_xmit_delay_factor;\n\tint padding_pixels;\n\tint i;\n\n\tdc_assert_fp_enabled();\n\n\tbpp = ((float)drm_bpp / 16.0);\n\t \n\tif (is_navite_422_or_420)\n\t\tbpp /= 2.0;\n\n\trc->rc_quant_incr_limit0 = ((bpc == BPC_8) ? 11 : (bpc == BPC_10 ? 15 : 19)) - ((minor_version == 1 && cm == CM_444) ? 1 : 0);\n\trc->rc_quant_incr_limit1 = ((bpc == BPC_8) ? 11 : (bpc == BPC_10 ? 15 : 19)) - ((minor_version == 1 && cm == CM_444) ? 1 : 0);\n\n\tbpp_group = MODE_SELECT(bpp, bpp * 2.0, bpp * 2.0);\n\n\tswitch (cm) {\n\tcase CM_420:\n\t\trc->initial_fullness_offset = (bpp >=  6) ? (2048) : ((bpp <=  4) ? (6144) : ((((bpp >  4) && (bpp <=  5))) ? (6144 - dsc_roundf((bpp - 4) * (512))) : (5632 - dsc_roundf((bpp -  5) * (3584)))));\n\t\trc->first_line_bpg_offset   = median3(0, (12 + (int) (0.09 *  min(34, slice_height - 8))), (int)((3 * bpc * 3) - (3 * bpp_group)));\n\t\trc->second_line_bpg_offset  = median3(0, 12, (int)((3 * bpc * 3) - (3 * bpp_group)));\n\t\tbreak;\n\tcase CM_422:\n\t\trc->initial_fullness_offset = (bpp >=  8) ? (2048) : ((bpp <=  7) ? (5632) : (5632 - dsc_roundf((bpp - 7) * (3584))));\n\t\trc->first_line_bpg_offset   = median3(0, (12 + (int) (0.09 *  min(34, slice_height - 8))), (int)((3 * bpc * 4) - (3 * bpp_group)));\n\t\trc->second_line_bpg_offset  = 0;\n\t\tbreak;\n\tcase CM_444:\n\tcase CM_RGB:\n\t\trc->initial_fullness_offset = (bpp >= 12) ? (2048) : ((bpp <=  8) ? (6144) : ((((bpp >  8) && (bpp <= 10))) ? (6144 - dsc_roundf((bpp - 8) * (512 / 2))) : (5632 - dsc_roundf((bpp - 10) * (3584 / 2)))));\n\t\trc->first_line_bpg_offset   = median3(0, (12 + (int) (0.09 *  min(34, slice_height - 8))), (int)(((3 * bpc + (cm == CM_444 ? 0 : 2)) * 3) - (3 * bpp_group)));\n\t\trc->second_line_bpg_offset  = 0;\n\t\tbreak;\n\t}\n\n\tinitial_xmit_delay_factor = (cm == CM_444 || cm == CM_RGB) ? 1.0 : 2.0;\n\trc->initial_xmit_delay = dsc_roundf(8192.0/2.0/bpp/initial_xmit_delay_factor);\n\n\tif (cm == CM_422 || cm == CM_420)\n\t\tslice_width /= 2;\n\n\tpadding_pixels = ((slice_width % 3) != 0) ? (3 - (slice_width % 3)) * (rc->initial_xmit_delay / slice_width) : 0;\n\tif (3 * bpp_group >= (((rc->initial_xmit_delay + 2) / 3) * (3 + (cm == CM_422)))) {\n\t\tif ((rc->initial_xmit_delay + padding_pixels) % 3 == 1)\n\t\t\trc->initial_xmit_delay++;\n\t}\n\n\trc->flatness_min_qp     = ((bpc == BPC_8) ?  (3) : ((bpc == BPC_10) ? (7)  : (11))) - ((minor_version == 1 && cm == CM_444) ? 1 : 0);\n\trc->flatness_max_qp     = ((bpc == BPC_8) ? (12) : ((bpc == BPC_10) ? (16) : (20))) - ((minor_version == 1 && cm == CM_444) ? 1 : 0);\n\trc->flatness_det_thresh = 2 << (bpc - 8);\n\n\tget_qp_set(rc->qp_min, cm, bpc, DAL_MM_MIN, bpp);\n\tget_qp_set(rc->qp_max, cm, bpc, DAL_MM_MAX, bpp);\n\tif (cm == CM_444 && minor_version == 1) {\n\t\tfor (i = 0; i < QP_SET_SIZE; ++i) {\n\t\t\trc->qp_min[i] = rc->qp_min[i] > 0 ? rc->qp_min[i] - 1 : 0;\n\t\t\trc->qp_max[i] = rc->qp_max[i] > 0 ? rc->qp_max[i] - 1 : 0;\n\t\t}\n\t}\n\tget_ofs_set(rc->ofs, cm, bpp);\n\n\t \n\trc->rc_model_size    = 8192;\n\trc->rc_edge_factor   = 6;\n\trc->rc_tgt_offset_hi = 3;\n\trc->rc_tgt_offset_lo = 3;\n\n\trc->rc_buf_thresh[0] = 896;\n\trc->rc_buf_thresh[1] = 1792;\n\trc->rc_buf_thresh[2] = 2688;\n\trc->rc_buf_thresh[3] = 3584;\n\trc->rc_buf_thresh[4] = 4480;\n\trc->rc_buf_thresh[5] = 5376;\n\trc->rc_buf_thresh[6] = 6272;\n\trc->rc_buf_thresh[7] = 6720;\n\trc->rc_buf_thresh[8] = 7168;\n\trc->rc_buf_thresh[9] = 7616;\n\trc->rc_buf_thresh[10] = 7744;\n\trc->rc_buf_thresh[11] = 7872;\n\trc->rc_buf_thresh[12] = 8000;\n\trc->rc_buf_thresh[13] = 8064;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}