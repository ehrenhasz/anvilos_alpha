{
  "module_name": "dcn321_fpu.c",
  "hash_id": "0e738abddb554cd5f858320ccf22a5549bed2ea6791b06a21cf38a172beeb31a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/dcn321/dcn321_fpu.c",
  "human_readable_source": "\n \n\n#include \"clk_mgr.h\"\n#include \"resource.h\"\n#include \"dcn321_fpu.h\"\n#include \"dcn32/dcn32_resource.h\"\n#include \"dcn321/dcn321_resource.h\"\n#include \"dml/dcn32/display_mode_vba_util_32.h\"\n\n#define DCN3_2_DEFAULT_DET_SIZE 256\n\nstruct _vcs_dpi_ip_params_st dcn3_21_ip = {\n\t.gpuvm_enable = 0,\n\t.gpuvm_max_page_table_levels = 4,\n\t.hostvm_enable = 0,\n\t.rob_buffer_size_kbytes = 128,\n\t.det_buffer_size_kbytes = DCN3_2_DEFAULT_DET_SIZE,\n\t.config_return_buffer_size_in_kbytes = 1280,\n\t.compressed_buffer_segment_size_in_kbytes = 64,\n\t.meta_fifo_size_in_kentries = 22,\n\t.zero_size_buffer_entries = 512,\n\t.compbuf_reserved_space_64b = 256,\n\t.compbuf_reserved_space_zs = 64,\n\t.dpp_output_buffer_pixels = 2560,\n\t.opp_output_buffer_lines = 1,\n\t.pixel_chunk_size_kbytes = 8,\n\t.alpha_pixel_chunk_size_kbytes = 4,\n\t.min_pixel_chunk_size_bytes = 1024,\n\t.dcc_meta_buffer_size_bytes = 6272,\n\t.meta_chunk_size_kbytes = 2,\n\t.min_meta_chunk_size_bytes = 256,\n\t.writeback_chunk_size_kbytes = 8,\n\t.ptoi_supported = false,\n\t.num_dsc = 4,\n\t.maximum_dsc_bits_per_component = 12,\n\t.maximum_pixels_per_line_per_dsc_unit = 6016,\n\t.dsc422_native_support = true,\n\t.is_line_buffer_bpp_fixed = true,\n\t.line_buffer_fixed_bpp = 57,\n\t.line_buffer_size_bits = 1171920,\n\t.max_line_buffer_lines = 32,\n\t.writeback_interface_buffer_size_kbytes = 90,\n\t.max_num_dpp = 4,\n\t.max_num_otg = 4,\n\t.max_num_hdmi_frl_outputs = 1,\n\t.max_num_wb = 1,\n\t.max_dchub_pscl_bw_pix_per_clk = 4,\n\t.max_pscl_lb_bw_pix_per_clk = 2,\n\t.max_lb_vscl_bw_pix_per_clk = 4,\n\t.max_vscl_hscl_bw_pix_per_clk = 4,\n\t.max_hscl_ratio = 6,\n\t.max_vscl_ratio = 6,\n\t.max_hscl_taps = 8,\n\t.max_vscl_taps = 8,\n\t.dpte_buffer_size_in_pte_reqs_luma = 64,\n\t.dpte_buffer_size_in_pte_reqs_chroma = 34,\n\t.dispclk_ramp_margin_percent = 1,\n\t.max_inter_dcn_tile_repeaters = 8,\n\t.cursor_buffer_size = 16,\n\t.cursor_chunk_size = 2,\n\t.writeback_line_buffer_buffer_size = 0,\n\t.writeback_min_hscl_ratio = 1,\n\t.writeback_min_vscl_ratio = 1,\n\t.writeback_max_hscl_ratio = 1,\n\t.writeback_max_vscl_ratio = 1,\n\t.writeback_max_hscl_taps = 1,\n\t.writeback_max_vscl_taps = 1,\n\t.dppclk_delay_subtotal = 47,\n\t.dppclk_delay_scl = 50,\n\t.dppclk_delay_scl_lb_only = 16,\n\t.dppclk_delay_cnvc_formatter = 28,\n\t.dppclk_delay_cnvc_cursor = 6,\n\t.dispclk_delay_subtotal = 125,\n\t.dynamic_metadata_vm_enabled = false,\n\t.odm_combine_4to1_supported = false,\n\t.dcc_supported = true,\n\t.max_num_dp2p0_outputs = 2,\n\t.max_num_dp2p0_streams = 4,\n};\n\nstruct _vcs_dpi_soc_bounding_box_st dcn3_21_soc = {\n\t.clock_limits = {\n\t\t{\n\t\t\t.state = 0,\n\t\t\t.dcfclk_mhz = 1434.0,\n\t\t\t.fabricclk_mhz = 2250.0,\n\t\t\t.dispclk_mhz = 1720.0,\n\t\t\t.dppclk_mhz = 1720.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.phyclk_d32_mhz = 313.0,\n\t\t\t.socclk_mhz = 1200.0,\n\t\t\t.dscclk_mhz = 573.333,\n\t\t\t.dram_speed_mts = 16000.0,\n\t\t\t.dtbclk_mhz = 1564.0,\n\t\t},\n\t},\n\t.num_states = 1,\n\t.sr_exit_time_us = 19.95,\n\t.sr_enter_plus_exit_time_us = 24.36,\n\t.sr_exit_z8_time_us = 285.0,\n\t.sr_enter_plus_exit_z8_time_us = 320,\n\t.writeback_latency_us = 12.0,\n\t.round_trip_ping_latency_dcfclk_cycles = 207,\n\t.urgent_latency_pixel_data_only_us = 4,\n\t.urgent_latency_pixel_mixed_with_vm_data_us = 4,\n\t.urgent_latency_vm_data_only_us = 4,\n\t.fclk_change_latency_us = 7,\n\t.usr_retraining_latency_us = 0,\n\t.smn_latency_us = 0,\n\t.mall_allocated_for_dcn_mbytes = 32,\n\t.urgent_out_of_order_return_per_channel_pixel_only_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_pixel_and_vm_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_vm_only_bytes = 4096,\n\t.pct_ideal_sdp_bw_after_urgent = 90.0,\n\t.pct_ideal_fabric_bw_after_urgent = 67.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_only = 20.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm = 60.0, \n\t.pct_ideal_dram_sdp_bw_after_urgent_vm_only = 30.0, \n\t.pct_ideal_dram_bw_after_urgent_strobe = 67.0,\n\t.max_avg_sdp_bw_use_normal_percent = 80.0,\n\t.max_avg_fabric_bw_use_normal_percent = 60.0,\n\t.max_avg_dram_bw_use_normal_strobe_percent = 50.0,\n\t.max_avg_dram_bw_use_normal_percent = 15.0,\n\t.num_chans = 8,\n\t.dram_channel_width_bytes = 2,\n\t.fabric_datapath_to_dcn_data_return_bytes = 64,\n\t.return_bus_width_bytes = 64,\n\t.downspread_percent = 0.38,\n\t.dcn_downspread_percent = 0.5,\n\t.dram_clock_change_latency_us = 400,\n\t.dispclk_dppclk_vco_speed_mhz = 4300.0,\n\t.do_urgent_latency_adjustment = true,\n\t.urgent_latency_adjustment_fabric_clock_component_us = 1.0,\n\t.urgent_latency_adjustment_fabric_clock_reference_mhz = 3000,\n};\n\nstatic void get_optimal_ntuple(struct _vcs_dpi_voltage_scaling_st *entry)\n{\n\tif (entry->dcfclk_mhz > 0) {\n\t\tfloat bw_on_sdp = entry->dcfclk_mhz * dcn3_21_soc.return_bus_width_bytes * ((float)dcn3_21_soc.pct_ideal_sdp_bw_after_urgent / 100);\n\n\t\tentry->fabricclk_mhz = bw_on_sdp / (dcn3_21_soc.return_bus_width_bytes * ((float)dcn3_21_soc.pct_ideal_fabric_bw_after_urgent / 100));\n\t\tentry->dram_speed_mts = bw_on_sdp / (dcn3_21_soc.num_chans *\n\t\t\t\tdcn3_21_soc.dram_channel_width_bytes * ((float)dcn3_21_soc.pct_ideal_dram_sdp_bw_after_urgent_pixel_only / 100));\n\t} else if (entry->fabricclk_mhz > 0) {\n\t\tfloat bw_on_fabric = entry->fabricclk_mhz * dcn3_21_soc.return_bus_width_bytes * ((float)dcn3_21_soc.pct_ideal_fabric_bw_after_urgent / 100);\n\n\t\tentry->dcfclk_mhz = bw_on_fabric / (dcn3_21_soc.return_bus_width_bytes * ((float)dcn3_21_soc.pct_ideal_sdp_bw_after_urgent / 100));\n\t\tentry->dram_speed_mts = bw_on_fabric / (dcn3_21_soc.num_chans *\n\t\t\t\tdcn3_21_soc.dram_channel_width_bytes * ((float)dcn3_21_soc.pct_ideal_dram_sdp_bw_after_urgent_pixel_only / 100));\n\t} else if (entry->dram_speed_mts > 0) {\n\t\tfloat bw_on_dram = entry->dram_speed_mts * dcn3_21_soc.num_chans *\n\t\t\t\tdcn3_21_soc.dram_channel_width_bytes * ((float)dcn3_21_soc.pct_ideal_dram_sdp_bw_after_urgent_pixel_only / 100);\n\n\t\tentry->fabricclk_mhz = bw_on_dram / (dcn3_21_soc.return_bus_width_bytes * ((float)dcn3_21_soc.pct_ideal_fabric_bw_after_urgent / 100));\n\t\tentry->dcfclk_mhz = bw_on_dram / (dcn3_21_soc.return_bus_width_bytes * ((float)dcn3_21_soc.pct_ideal_sdp_bw_after_urgent / 100));\n\t}\n}\n\nstatic float calculate_net_bw_in_kbytes_sec(struct _vcs_dpi_voltage_scaling_st *entry)\n{\n\tfloat memory_bw_kbytes_sec;\n\tfloat fabric_bw_kbytes_sec;\n\tfloat sdp_bw_kbytes_sec;\n\tfloat limiting_bw_kbytes_sec;\n\n\tmemory_bw_kbytes_sec = entry->dram_speed_mts * dcn3_21_soc.num_chans *\n\t\t\tdcn3_21_soc.dram_channel_width_bytes * ((float)dcn3_21_soc.pct_ideal_dram_sdp_bw_after_urgent_pixel_only / 100);\n\n\tfabric_bw_kbytes_sec = entry->fabricclk_mhz * dcn3_21_soc.return_bus_width_bytes * ((float)dcn3_21_soc.pct_ideal_fabric_bw_after_urgent / 100);\n\n\tsdp_bw_kbytes_sec = entry->dcfclk_mhz * dcn3_21_soc.return_bus_width_bytes * ((float)dcn3_21_soc.pct_ideal_sdp_bw_after_urgent / 100);\n\n\tlimiting_bw_kbytes_sec = memory_bw_kbytes_sec;\n\n\tif (fabric_bw_kbytes_sec < limiting_bw_kbytes_sec)\n\t\tlimiting_bw_kbytes_sec = fabric_bw_kbytes_sec;\n\n\tif (sdp_bw_kbytes_sec < limiting_bw_kbytes_sec)\n\t\tlimiting_bw_kbytes_sec = sdp_bw_kbytes_sec;\n\n\treturn limiting_bw_kbytes_sec;\n}\n\nstatic void dcn321_insert_entry_into_table_sorted(struct _vcs_dpi_voltage_scaling_st *table,\n\t\t\t\t\t   unsigned int *num_entries,\n\t\t\t\t\t   struct _vcs_dpi_voltage_scaling_st *entry)\n{\n\tint i = 0;\n\tint index = 0;\n\n\tdc_assert_fp_enabled();\n\n\tif (*num_entries == 0) {\n\t\ttable[0] = *entry;\n\t\t(*num_entries)++;\n\t} else {\n\t\twhile (entry->net_bw_in_kbytes_sec > table[index].net_bw_in_kbytes_sec) {\n\t\t\tindex++;\n\t\t\tif (index >= *num_entries)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tfor (i = *num_entries; i > index; i--)\n\t\t\ttable[i] = table[i - 1];\n\n\t\ttable[index] = *entry;\n\t\t(*num_entries)++;\n\t}\n}\n\nstatic void remove_entry_from_table_at_index(struct _vcs_dpi_voltage_scaling_st *table, unsigned int *num_entries,\n\t\tunsigned int index)\n{\n\tint i;\n\n\tif (*num_entries == 0)\n\t\treturn;\n\n\tfor (i = index; i < *num_entries - 1; i++) {\n\t\ttable[i] = table[i + 1];\n\t}\n\tmemset(&table[--(*num_entries)], 0, sizeof(struct _vcs_dpi_voltage_scaling_st));\n}\n\nstatic void swap_table_entries(struct _vcs_dpi_voltage_scaling_st *first_entry,\n\t\tstruct _vcs_dpi_voltage_scaling_st *second_entry)\n{\n\tstruct _vcs_dpi_voltage_scaling_st temp_entry = *first_entry;\n\t*first_entry = *second_entry;\n\t*second_entry = temp_entry;\n}\n\n \nstatic void sort_entries_with_same_bw(struct _vcs_dpi_voltage_scaling_st *table, unsigned int *num_entries)\n{\n\tunsigned int start_index = 0;\n\tunsigned int end_index = 0;\n\tunsigned int current_bw = 0;\n\n\tfor (int i = 0; i < (*num_entries - 1); i++) {\n\t\tif (table[i].net_bw_in_kbytes_sec == table[i+1].net_bw_in_kbytes_sec) {\n\t\t\tcurrent_bw = table[i].net_bw_in_kbytes_sec;\n\t\t\tstart_index = i;\n\t\t\tend_index = ++i;\n\n\t\t\twhile ((i < (*num_entries - 1)) && (table[i+1].net_bw_in_kbytes_sec == current_bw))\n\t\t\t\tend_index = ++i;\n\t\t}\n\n\t\tif (start_index != end_index) {\n\t\t\tfor (int j = start_index; j < end_index; j++) {\n\t\t\t\tfor (int k = start_index; k < end_index; k++) {\n\t\t\t\t\tif (table[k].dcfclk_mhz > table[k+1].dcfclk_mhz)\n\t\t\t\t\t\tswap_table_entries(&table[k], &table[k+1]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tstart_index = 0;\n\t\tend_index = 0;\n\n\t}\n}\n\n \nstatic void remove_inconsistent_entries(struct _vcs_dpi_voltage_scaling_st *table, unsigned int *num_entries)\n{\n\tfor (int i = 0; i < (*num_entries - 1); i++) {\n\t\tif (table[i].net_bw_in_kbytes_sec == table[i+1].net_bw_in_kbytes_sec) {\n\t\t\tif ((table[i].dram_speed_mts > table[i+1].dram_speed_mts) ||\n\t\t\t\t(table[i].fabricclk_mhz > table[i+1].fabricclk_mhz))\n\t\t\t\tremove_entry_from_table_at_index(table, num_entries, i);\n\t\t}\n\t}\n}\n\n \nstatic int override_max_clk_values(struct clk_limit_table_entry *max_clk_limit,\n\t\tstruct clk_limit_table_entry *curr_clk_limit)\n{\n\tif (NULL == max_clk_limit || NULL == curr_clk_limit)\n\t\treturn -1; \n\n\t\n\tif (max_clk_limit->dcfclk_mhz != 0)\n\t\tcurr_clk_limit->dcfclk_mhz = max_clk_limit->dcfclk_mhz;\n\n\tif (max_clk_limit->fclk_mhz != 0)\n\t\tcurr_clk_limit->fclk_mhz = max_clk_limit->fclk_mhz;\n\n\tif (max_clk_limit->memclk_mhz != 0)\n\t\tcurr_clk_limit->memclk_mhz = max_clk_limit->memclk_mhz;\n\n\tif (max_clk_limit->socclk_mhz != 0)\n\t\tcurr_clk_limit->socclk_mhz = max_clk_limit->socclk_mhz;\n\n\tif (max_clk_limit->dtbclk_mhz != 0)\n\t\tcurr_clk_limit->dtbclk_mhz = max_clk_limit->dtbclk_mhz;\n\n\tif (max_clk_limit->dispclk_mhz != 0)\n\t\tcurr_clk_limit->dispclk_mhz = max_clk_limit->dispclk_mhz;\n\n\treturn 0;\n}\n\nstatic int build_synthetic_soc_states(bool disable_dc_mode_overwrite, struct clk_bw_params *bw_params,\n\t\tstruct _vcs_dpi_voltage_scaling_st *table, unsigned int *num_entries)\n{\n\tint i, j;\n\tstruct _vcs_dpi_voltage_scaling_st entry = {0};\n\tstruct clk_limit_table_entry max_clk_data = {0};\n\n\tunsigned int min_dcfclk_mhz = 199, min_fclk_mhz = 299;\n\n\tstatic const unsigned int num_dcfclk_stas = 5;\n\tunsigned int dcfclk_sta_targets[DC__VOLTAGE_STATES] = {199, 615, 906, 1324, 1564};\n\n\tunsigned int num_uclk_dpms = 0;\n\tunsigned int num_fclk_dpms = 0;\n\tunsigned int num_dcfclk_dpms = 0;\n\n\tunsigned int num_dc_uclk_dpms = 0;\n\tunsigned int num_dc_fclk_dpms = 0;\n\tunsigned int num_dc_dcfclk_dpms = 0;\n\n\tfor (i = 0; i < MAX_NUM_DPM_LVL; i++) {\n\t\tif (bw_params->clk_table.entries[i].dcfclk_mhz > max_clk_data.dcfclk_mhz)\n\t\t\tmax_clk_data.dcfclk_mhz = bw_params->clk_table.entries[i].dcfclk_mhz;\n\t\tif (bw_params->clk_table.entries[i].fclk_mhz > max_clk_data.fclk_mhz)\n\t\t\tmax_clk_data.fclk_mhz = bw_params->clk_table.entries[i].fclk_mhz;\n\t\tif (bw_params->clk_table.entries[i].memclk_mhz > max_clk_data.memclk_mhz)\n\t\t\tmax_clk_data.memclk_mhz = bw_params->clk_table.entries[i].memclk_mhz;\n\t\tif (bw_params->clk_table.entries[i].dispclk_mhz > max_clk_data.dispclk_mhz)\n\t\t\tmax_clk_data.dispclk_mhz = bw_params->clk_table.entries[i].dispclk_mhz;\n\t\tif (bw_params->clk_table.entries[i].dppclk_mhz > max_clk_data.dppclk_mhz)\n\t\t\tmax_clk_data.dppclk_mhz = bw_params->clk_table.entries[i].dppclk_mhz;\n\t\tif (bw_params->clk_table.entries[i].phyclk_mhz > max_clk_data.phyclk_mhz)\n\t\t\tmax_clk_data.phyclk_mhz = bw_params->clk_table.entries[i].phyclk_mhz;\n\t\tif (bw_params->clk_table.entries[i].dtbclk_mhz > max_clk_data.dtbclk_mhz)\n\t\t\tmax_clk_data.dtbclk_mhz = bw_params->clk_table.entries[i].dtbclk_mhz;\n\n\t\tif (bw_params->clk_table.entries[i].memclk_mhz > 0) {\n\t\t\tnum_uclk_dpms++;\n\t\t\tif (bw_params->clk_table.entries[i].memclk_mhz <= bw_params->dc_mode_limit.memclk_mhz)\n\t\t\t\tnum_dc_uclk_dpms++;\n\t\t}\n\t\tif (bw_params->clk_table.entries[i].fclk_mhz > 0) {\n\t\t\tnum_fclk_dpms++;\n\t\t\tif (bw_params->clk_table.entries[i].fclk_mhz <= bw_params->dc_mode_limit.fclk_mhz)\n\t\t\t\tnum_dc_fclk_dpms++;\n\t\t}\n\t\tif (bw_params->clk_table.entries[i].dcfclk_mhz > 0) {\n\t\t\tnum_dcfclk_dpms++;\n\t\t\tif (bw_params->clk_table.entries[i].dcfclk_mhz <= bw_params->dc_mode_limit.dcfclk_mhz)\n\t\t\t\tnum_dc_dcfclk_dpms++;\n\t\t}\n\t}\n\n\tif (!disable_dc_mode_overwrite) {\n\t\t\n\t\toverride_max_clk_values(&bw_params->dc_mode_limit, &max_clk_data);\n\t\tnum_uclk_dpms = num_dc_uclk_dpms;\n\t\tnum_fclk_dpms = num_dc_fclk_dpms;\n\t\tnum_dcfclk_dpms = num_dc_dcfclk_dpms;\n\t\tbw_params->clk_table.num_entries_per_clk.num_memclk_levels = num_uclk_dpms;\n\t\tbw_params->clk_table.num_entries_per_clk.num_fclk_levels = num_fclk_dpms;\n\t}\n\n\tif (num_dcfclk_dpms > 0 && bw_params->clk_table.entries[0].fclk_mhz > min_fclk_mhz)\n\t\tmin_fclk_mhz = bw_params->clk_table.entries[0].fclk_mhz;\n\n\tif (!max_clk_data.dcfclk_mhz || !max_clk_data.dispclk_mhz || !max_clk_data.dtbclk_mhz)\n\t\treturn -1;\n\n\tif (max_clk_data.dppclk_mhz == 0)\n\t\tmax_clk_data.dppclk_mhz = max_clk_data.dispclk_mhz;\n\n\tif (max_clk_data.fclk_mhz == 0)\n\t\tmax_clk_data.fclk_mhz = max_clk_data.dcfclk_mhz *\n\t\t\t\tdcn3_21_soc.pct_ideal_sdp_bw_after_urgent /\n\t\t\t\tdcn3_21_soc.pct_ideal_fabric_bw_after_urgent;\n\n\tif (max_clk_data.phyclk_mhz == 0)\n\t\tmax_clk_data.phyclk_mhz = dcn3_21_soc.clock_limits[0].phyclk_mhz;\n\n\t*num_entries = 0;\n\tentry.dispclk_mhz = max_clk_data.dispclk_mhz;\n\tentry.dscclk_mhz = max_clk_data.dispclk_mhz / 3;\n\tentry.dppclk_mhz = max_clk_data.dppclk_mhz;\n\tentry.dtbclk_mhz = max_clk_data.dtbclk_mhz;\n\tentry.phyclk_mhz = max_clk_data.phyclk_mhz;\n\tentry.phyclk_d18_mhz = dcn3_21_soc.clock_limits[0].phyclk_d18_mhz;\n\tentry.phyclk_d32_mhz = dcn3_21_soc.clock_limits[0].phyclk_d32_mhz;\n\n\t\n\tfor (i = 0; i < num_dcfclk_stas; i++) {\n\t\tentry.dcfclk_mhz = dcfclk_sta_targets[i];\n\t\tentry.fabricclk_mhz = 0;\n\t\tentry.dram_speed_mts = 0;\n\n\t\tget_optimal_ntuple(&entry);\n\t\tentry.net_bw_in_kbytes_sec = calculate_net_bw_in_kbytes_sec(&entry);\n\t\tdcn321_insert_entry_into_table_sorted(table, num_entries, &entry);\n\t}\n\n\t\n\tentry.dcfclk_mhz = max_clk_data.dcfclk_mhz;\n\tentry.fabricclk_mhz = 0;\n\tentry.dram_speed_mts = 0;\n\n\tget_optimal_ntuple(&entry);\n\tentry.net_bw_in_kbytes_sec = calculate_net_bw_in_kbytes_sec(&entry);\n\tdcn321_insert_entry_into_table_sorted(table, num_entries, &entry);\n\n\t\n\tfor (i = 0; i < num_uclk_dpms; i++) {\n\t\tentry.dcfclk_mhz = 0;\n\t\tentry.fabricclk_mhz = 0;\n\t\tentry.dram_speed_mts = bw_params->clk_table.entries[i].memclk_mhz * 16;\n\n\t\tget_optimal_ntuple(&entry);\n\t\tentry.net_bw_in_kbytes_sec = calculate_net_bw_in_kbytes_sec(&entry);\n\t\tdcn321_insert_entry_into_table_sorted(table, num_entries, &entry);\n\t}\n\n\t\n\tif (num_fclk_dpms > 2) {\n\t\tfor (i = 0; i < num_fclk_dpms; i++) {\n\t\t\tentry.dcfclk_mhz = 0;\n\t\t\tentry.fabricclk_mhz = bw_params->clk_table.entries[i].fclk_mhz;\n\t\t\tentry.dram_speed_mts = 0;\n\n\t\t\tget_optimal_ntuple(&entry);\n\t\t\tentry.net_bw_in_kbytes_sec = calculate_net_bw_in_kbytes_sec(&entry);\n\t\t\tdcn321_insert_entry_into_table_sorted(table, num_entries, &entry);\n\t\t}\n\t}\n\t\n\telse {\n\t\tentry.dcfclk_mhz = 0;\n\t\tentry.fabricclk_mhz = max_clk_data.fclk_mhz;\n\t\tentry.dram_speed_mts = 0;\n\n\t\tget_optimal_ntuple(&entry);\n\t\tentry.net_bw_in_kbytes_sec = calculate_net_bw_in_kbytes_sec(&entry);\n\t\tdcn321_insert_entry_into_table_sorted(table, num_entries, &entry);\n\t}\n\n\t\n\t\n\t\n\n\t\n\tfor (i = *num_entries - 1; i >= 0 ; i--) {\n\t\tif (table[i].dcfclk_mhz > max_clk_data.dcfclk_mhz ||\n\t\t\t\ttable[i].fabricclk_mhz > max_clk_data.fclk_mhz ||\n\t\t\t\ttable[i].dram_speed_mts > max_clk_data.memclk_mhz * 16)\n\t\t\tremove_entry_from_table_at_index(table, num_entries, i);\n\t}\n\n\t\n\tif (!disable_dc_mode_overwrite) {\n\t\tstruct _vcs_dpi_voltage_scaling_st max_dc_limits_entry = entry;\n\n\t\tmax_dc_limits_entry.dcfclk_mhz = max_clk_data.dcfclk_mhz;\n\t\tmax_dc_limits_entry.fabricclk_mhz = max_clk_data.fclk_mhz;\n\t\tmax_dc_limits_entry.dram_speed_mts = max_clk_data.memclk_mhz * 16;\n\n\t\tmax_dc_limits_entry.net_bw_in_kbytes_sec = calculate_net_bw_in_kbytes_sec(&max_dc_limits_entry);\n\t\tdcn321_insert_entry_into_table_sorted(table, num_entries, &max_dc_limits_entry);\n\n\t\tsort_entries_with_same_bw(table, num_entries);\n\t\tremove_inconsistent_entries(table, num_entries);\n\t}\n\n\n\n\t\n\t\n\t\n\t\n\n\t\n\tfor (i = *num_entries - 1; i >= 0 ; i--) {\n\t\tfor (j = 0; j < num_uclk_dpms; j++) {\n\t\t\tif (bw_params->clk_table.entries[j].memclk_mhz * 16 >= table[i].dram_speed_mts) {\n\t\t\t\ttable[i].dram_speed_mts = bw_params->clk_table.entries[j].memclk_mhz * 16;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t\n\tif (num_fclk_dpms > 2) {\n\t\tfor (i = *num_entries - 1; i >= 0 ; i--) {\n\t\t\tfor (j = 0; j < num_fclk_dpms; j++) {\n\t\t\t\tif (bw_params->clk_table.entries[j].fclk_mhz >= table[i].fabricclk_mhz) {\n\t\t\t\t\ttable[i].fabricclk_mhz = bw_params->clk_table.entries[j].fclk_mhz;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t\n\telse {\n\t\tfor (i = *num_entries - 1; i >= 0 ; i--) {\n\t\t\tif (table[i].fabricclk_mhz < min_fclk_mhz) {\n\t\t\t\ttable[i].fabricclk_mhz = min_fclk_mhz;\n\t\t\t}\n\t\t}\n\t}\n\n\t\n\tfor (i = *num_entries - 1; i >= 0 ; i--) {\n\t\tif (table[i].dcfclk_mhz < min_dcfclk_mhz) {\n\t\t\ttable[i].dcfclk_mhz = min_dcfclk_mhz;\n\t\t}\n\t}\n\n\t\n\ti = 0;\n\twhile (i < *num_entries - 1) {\n\t\tif (table[i].dcfclk_mhz == table[i + 1].dcfclk_mhz &&\n\t\t\t\ttable[i].fabricclk_mhz == table[i + 1].fabricclk_mhz &&\n\t\t\t\ttable[i].dram_speed_mts == table[i + 1].dram_speed_mts)\n\t\t\tremove_entry_from_table_at_index(table, num_entries, i + 1);\n\t\telse\n\t\t\ti++;\n\t}\n\n\t\n\tfor (i = *num_entries - 1; i >= 0 ; i--) {\n\t\ttable[i].state = i;\n\t}\n\n\treturn 0;\n}\n\nstatic void dcn321_get_optimal_dcfclk_fclk_for_uclk(unsigned int uclk_mts,\n\t\tunsigned int *optimal_dcfclk,\n\t\tunsigned int *optimal_fclk)\n{\n\tdouble bw_from_dram, bw_from_dram1, bw_from_dram2;\n\n\tbw_from_dram1 = uclk_mts * dcn3_21_soc.num_chans *\n\t\tdcn3_21_soc.dram_channel_width_bytes * (dcn3_21_soc.max_avg_dram_bw_use_normal_percent / 100);\n\tbw_from_dram2 = uclk_mts * dcn3_21_soc.num_chans *\n\t\tdcn3_21_soc.dram_channel_width_bytes * (dcn3_21_soc.max_avg_sdp_bw_use_normal_percent / 100);\n\n\tbw_from_dram = (bw_from_dram1 < bw_from_dram2) ? bw_from_dram1 : bw_from_dram2;\n\n\tif (optimal_fclk)\n\t\t*optimal_fclk = bw_from_dram /\n\t\t(dcn3_21_soc.fabric_datapath_to_dcn_data_return_bytes * (dcn3_21_soc.max_avg_sdp_bw_use_normal_percent / 100));\n\n\tif (optimal_dcfclk)\n\t\t*optimal_dcfclk =  bw_from_dram /\n\t\t(dcn3_21_soc.return_bus_width_bytes * (dcn3_21_soc.max_avg_sdp_bw_use_normal_percent / 100));\n}\n\n \nvoid dcn321_update_bw_bounding_box_fpu(struct dc *dc, struct clk_bw_params *bw_params)\n{\n\tdc_assert_fp_enabled();\n\t \n\tdcn3_21_ip.clamp_min_dcfclk = dc->config.clamp_min_dcfclk;\n\n\t \n\tif ((int)(dcn3_21_soc.sr_exit_time_us * 1000) != dc->bb_overrides.sr_exit_time_ns\n\t\t\t&& dc->bb_overrides.sr_exit_time_ns) {\n\t\tdcn3_21_soc.sr_exit_time_us = dc->bb_overrides.sr_exit_time_ns / 1000.0;\n\t}\n\n\tif ((int)(dcn3_21_soc.sr_enter_plus_exit_time_us * 1000)\n\t\t\t!= dc->bb_overrides.sr_enter_plus_exit_time_ns\n\t\t\t&& dc->bb_overrides.sr_enter_plus_exit_time_ns) {\n\t\tdcn3_21_soc.sr_enter_plus_exit_time_us =\n\t\t\tdc->bb_overrides.sr_enter_plus_exit_time_ns / 1000.0;\n\t}\n\n\tif ((int)(dcn3_21_soc.urgent_latency_us * 1000) != dc->bb_overrides.urgent_latency_ns\n\t\t&& dc->bb_overrides.urgent_latency_ns) {\n\t\tdcn3_21_soc.urgent_latency_us = dc->bb_overrides.urgent_latency_ns / 1000.0;\n\t\tdcn3_21_soc.urgent_latency_pixel_data_only_us = dc->bb_overrides.urgent_latency_ns / 1000.0;\n\t}\n\n\tif ((int)(dcn3_21_soc.dram_clock_change_latency_us * 1000)\n\t\t\t!= dc->bb_overrides.dram_clock_change_latency_ns\n\t\t\t&& dc->bb_overrides.dram_clock_change_latency_ns) {\n\t\tdcn3_21_soc.dram_clock_change_latency_us =\n\t\t\tdc->bb_overrides.dram_clock_change_latency_ns / 1000.0;\n\t}\n\n\tif ((int)(dcn3_21_soc.fclk_change_latency_us * 1000)\n\t\t\t!= dc->bb_overrides.fclk_clock_change_latency_ns\n\t\t\t&& dc->bb_overrides.fclk_clock_change_latency_ns) {\n\t\tdcn3_21_soc.fclk_change_latency_us =\n\t\t\tdc->bb_overrides.fclk_clock_change_latency_ns / 1000;\n\t}\n\n\tif ((int)(dcn3_21_soc.dummy_pstate_latency_us * 1000)\n\t\t\t!= dc->bb_overrides.dummy_clock_change_latency_ns\n\t\t\t&& dc->bb_overrides.dummy_clock_change_latency_ns) {\n\t\tdcn3_21_soc.dummy_pstate_latency_us =\n\t\t\tdc->bb_overrides.dummy_clock_change_latency_ns / 1000.0;\n\t}\n\n\t \n\tif (dc->ctx->dc_bios->funcs->get_soc_bb_info) {\n\t\tstruct bp_soc_bb_info bb_info = {0};\n\n\t\tif (dc->ctx->dc_bios->funcs->get_soc_bb_info(dc->ctx->dc_bios, &bb_info) == BP_RESULT_OK) {\n\t\t\tif (bb_info.dram_clock_change_latency_100ns > 0)\n\t\t\t\tdcn3_21_soc.dram_clock_change_latency_us =\n\t\t\t\t\tbb_info.dram_clock_change_latency_100ns * 10;\n\n\t\t\tif (bb_info.dram_sr_enter_exit_latency_100ns > 0)\n\t\t\t\tdcn3_21_soc.sr_enter_plus_exit_time_us =\n\t\t\t\t\tbb_info.dram_sr_enter_exit_latency_100ns * 10;\n\n\t\t\tif (bb_info.dram_sr_exit_latency_100ns > 0)\n\t\t\t\tdcn3_21_soc.sr_exit_time_us =\n\t\t\t\t\tbb_info.dram_sr_exit_latency_100ns * 10;\n\t\t}\n\t}\n\n\t \n\tif (dc->ctx->dc_bios->vram_info.num_chans) {\n\t\tdcn3_21_soc.num_chans = dc->ctx->dc_bios->vram_info.num_chans;\n\t\tdcn3_21_soc.mall_allocated_for_dcn_mbytes = (double)(dcn32_calc_num_avail_chans_for_mall(dc,\n\t\t\tdc->ctx->dc_bios->vram_info.num_chans) * dc->caps.mall_size_per_mem_channel);\n\t}\n\n\tif (dc->ctx->dc_bios->vram_info.dram_channel_width_bytes)\n\t\tdcn3_21_soc.dram_channel_width_bytes = dc->ctx->dc_bios->vram_info.dram_channel_width_bytes;\n\n\t \n\tdcn3_21_ip.dsc_delay_factor_wa = dc->debug.dsc_delay_factor_wa_x1000 / 1000.0;\n\n\tdcn3_21_ip.min_prefetch_in_strobe_us = dc->debug.min_prefetch_in_strobe_ns / 1000.0;\n\n\t \n\tdcn3_21_soc.dispclk_dppclk_vco_speed_mhz = dc->clk_mgr->dentist_vco_freq_khz / 1000.0;\n\tdc->dml.soc.dispclk_dppclk_vco_speed_mhz = dc->clk_mgr->dentist_vco_freq_khz / 1000.0;\n\n\t \n\tif (dc->debug.use_legacy_soc_bb_mechanism) {\n\t\tunsigned int i = 0, j = 0, num_states = 0;\n\n\t\tunsigned int dcfclk_mhz[DC__VOLTAGE_STATES] = {0};\n\t\tunsigned int dram_speed_mts[DC__VOLTAGE_STATES] = {0};\n\t\tunsigned int optimal_uclk_for_dcfclk_sta_targets[DC__VOLTAGE_STATES] = {0};\n\t\tunsigned int optimal_dcfclk_for_uclk[DC__VOLTAGE_STATES] = {0};\n\n\t\tunsigned int dcfclk_sta_targets[DC__VOLTAGE_STATES] = {615, 906, 1324, 1564};\n\t\tunsigned int num_dcfclk_sta_targets = 4, num_uclk_states = 0;\n\t\tunsigned int max_dcfclk_mhz = 0, max_dispclk_mhz = 0, max_dppclk_mhz = 0, max_phyclk_mhz = 0;\n\n\t\tfor (i = 0; i < MAX_NUM_DPM_LVL; i++) {\n\t\t\tif (bw_params->clk_table.entries[i].dcfclk_mhz > max_dcfclk_mhz)\n\t\t\t\tmax_dcfclk_mhz = bw_params->clk_table.entries[i].dcfclk_mhz;\n\t\t\tif (bw_params->clk_table.entries[i].dispclk_mhz > max_dispclk_mhz)\n\t\t\t\tmax_dispclk_mhz = bw_params->clk_table.entries[i].dispclk_mhz;\n\t\t\tif (bw_params->clk_table.entries[i].dppclk_mhz > max_dppclk_mhz)\n\t\t\t\tmax_dppclk_mhz = bw_params->clk_table.entries[i].dppclk_mhz;\n\t\t\tif (bw_params->clk_table.entries[i].phyclk_mhz > max_phyclk_mhz)\n\t\t\t\tmax_phyclk_mhz = bw_params->clk_table.entries[i].phyclk_mhz;\n\t\t}\n\t\tif (!max_dcfclk_mhz)\n\t\t\tmax_dcfclk_mhz = dcn3_21_soc.clock_limits[0].dcfclk_mhz;\n\t\tif (!max_dispclk_mhz)\n\t\t\tmax_dispclk_mhz = dcn3_21_soc.clock_limits[0].dispclk_mhz;\n\t\tif (!max_dppclk_mhz)\n\t\t\tmax_dppclk_mhz = dcn3_21_soc.clock_limits[0].dppclk_mhz;\n\t\tif (!max_phyclk_mhz)\n\t\t\tmax_phyclk_mhz = dcn3_21_soc.clock_limits[0].phyclk_mhz;\n\n\t\tif (max_dcfclk_mhz > dcfclk_sta_targets[num_dcfclk_sta_targets-1]) {\n\t\t\t\n\t\t\tdcfclk_sta_targets[num_dcfclk_sta_targets] = max_dcfclk_mhz;\n\t\t\tnum_dcfclk_sta_targets++;\n\t\t} else if (max_dcfclk_mhz < dcfclk_sta_targets[num_dcfclk_sta_targets-1]) {\n\t\t\t\n\t\t\tfor (i = 0; i < num_dcfclk_sta_targets; i++) {\n\t\t\t\tif (dcfclk_sta_targets[i] > max_dcfclk_mhz) {\n\t\t\t\t\tdcfclk_sta_targets[i] = max_dcfclk_mhz;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tnum_dcfclk_sta_targets = i + 1;\n\t\t}\n\n\t\tnum_uclk_states = bw_params->clk_table.num_entries;\n\n\t\t\n\t\tfor (i = 0; i < num_uclk_states; i++) {\n\t\t\tdcn321_get_optimal_dcfclk_fclk_for_uclk(bw_params->clk_table.entries[i].memclk_mhz * 16,\n\t\t\t\t\t&optimal_dcfclk_for_uclk[i], NULL);\n\t\t\tif (optimal_dcfclk_for_uclk[i] < bw_params->clk_table.entries[0].dcfclk_mhz) {\n\t\t\t\toptimal_dcfclk_for_uclk[i] = bw_params->clk_table.entries[0].dcfclk_mhz;\n\t\t\t}\n\t\t}\n\n\t\t\n\t\tfor (i = 0; i < num_dcfclk_sta_targets; i++) {\n\t\t\tfor (j = 0; j < num_uclk_states; j++) {\n\t\t\t\tif (dcfclk_sta_targets[i] < optimal_dcfclk_for_uclk[j]) {\n\t\t\t\t\toptimal_uclk_for_dcfclk_sta_targets[i] =\n\t\t\t\t\t\t\tbw_params->clk_table.entries[j].memclk_mhz * 16;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\ti = 0;\n\t\tj = 0;\n\t\t\n\t\twhile (i < num_dcfclk_sta_targets && j < num_uclk_states && num_states < DC__VOLTAGE_STATES) {\n\t\t\tif (dcfclk_sta_targets[i] < optimal_dcfclk_for_uclk[j] && i < num_dcfclk_sta_targets) {\n\t\t\t\tdcfclk_mhz[num_states] = dcfclk_sta_targets[i];\n\t\t\t\tdram_speed_mts[num_states++] = optimal_uclk_for_dcfclk_sta_targets[i++];\n\t\t\t} else {\n\t\t\t\tif (j < num_uclk_states && optimal_dcfclk_for_uclk[j] <= max_dcfclk_mhz) {\n\t\t\t\t\tdcfclk_mhz[num_states] = optimal_dcfclk_for_uclk[j];\n\t\t\t\t\tdram_speed_mts[num_states++] = bw_params->clk_table.entries[j++].memclk_mhz * 16;\n\t\t\t\t} else {\n\t\t\t\t\tj = num_uclk_states;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\twhile (i < num_dcfclk_sta_targets && num_states < DC__VOLTAGE_STATES) {\n\t\t\tdcfclk_mhz[num_states] = dcfclk_sta_targets[i];\n\t\t\tdram_speed_mts[num_states++] = optimal_uclk_for_dcfclk_sta_targets[i++];\n\t\t}\n\n\t\twhile (j < num_uclk_states && num_states < DC__VOLTAGE_STATES &&\n\t\t\t\toptimal_dcfclk_for_uclk[j] <= max_dcfclk_mhz) {\n\t\t\tdcfclk_mhz[num_states] = optimal_dcfclk_for_uclk[j];\n\t\t\tdram_speed_mts[num_states++] = bw_params->clk_table.entries[j++].memclk_mhz * 16;\n\t\t}\n\n\t\tdcn3_21_soc.num_states = num_states;\n\t\tfor (i = 0; i < dcn3_21_soc.num_states; i++) {\n\t\t\tdcn3_21_soc.clock_limits[i].state = i;\n\t\t\tdcn3_21_soc.clock_limits[i].dcfclk_mhz = dcfclk_mhz[i];\n\t\t\tdcn3_21_soc.clock_limits[i].fabricclk_mhz = dcfclk_mhz[i];\n\n\t\t\t \n\t\t\tdcn3_21_soc.clock_limits[i].dispclk_mhz = max_dispclk_mhz;\n\t\t\tdcn3_21_soc.clock_limits[i].dppclk_mhz  = max_dppclk_mhz;\n\t\t\tdcn3_21_soc.clock_limits[i].phyclk_mhz  = max_phyclk_mhz;\n\t\t\tdcn3_21_soc.clock_limits[i].dscclk_mhz  = max_dispclk_mhz / 3;\n\n\t\t\t \n\t\t\tif (i > 0) {\n\t\t\t\tif (!bw_params->clk_table.entries[i].dtbclk_mhz) {\n\t\t\t\t\tdcn3_21_soc.clock_limits[i].dtbclk_mhz  = dcn3_21_soc.clock_limits[i-1].dtbclk_mhz;\n\t\t\t\t} else {\n\t\t\t\t\tdcn3_21_soc.clock_limits[i].dtbclk_mhz  = bw_params->clk_table.entries[i].dtbclk_mhz;\n\t\t\t\t}\n\t\t\t} else if (bw_params->clk_table.entries[i].dtbclk_mhz) {\n\t\t\t\tdcn3_21_soc.clock_limits[i].dtbclk_mhz  = bw_params->clk_table.entries[i].dtbclk_mhz;\n\t\t\t}\n\n\t\t\tif (!bw_params->clk_table.entries[i].socclk_mhz && i > 0)\n\t\t\t\tdcn3_21_soc.clock_limits[i].socclk_mhz = dcn3_21_soc.clock_limits[i-1].socclk_mhz;\n\t\t\telse\n\t\t\t\tdcn3_21_soc.clock_limits[i].socclk_mhz = bw_params->clk_table.entries[i].socclk_mhz;\n\n\t\t\tif (!dram_speed_mts[i] && i > 0)\n\t\t\t\tdcn3_21_soc.clock_limits[i].dram_speed_mts = dcn3_21_soc.clock_limits[i-1].dram_speed_mts;\n\t\t\telse\n\t\t\t\tdcn3_21_soc.clock_limits[i].dram_speed_mts = dram_speed_mts[i];\n\n\t\t\t \n\t\t\t \n\t\t\tdcn3_21_soc.clock_limits[i].phyclk_d18_mhz = dcn3_21_soc.clock_limits[0].phyclk_d18_mhz;\n\t\t\tdcn3_21_soc.clock_limits[i].phyclk_d32_mhz = dcn3_21_soc.clock_limits[0].phyclk_d32_mhz;\n\t\t}\n\t} else {\n\t\tbuild_synthetic_soc_states(dc->debug.disable_dc_mode_overwrite, bw_params,\n\t\t\tdcn3_21_soc.clock_limits, &dcn3_21_soc.num_states);\n\t}\n\n\t \n\tdml_init_instance(&dc->dml, &dcn3_21_soc, &dcn3_21_ip, DML_PROJECT_DCN32);\n\tif (dc->current_state)\n\t\tdml_init_instance(&dc->current_state->bw_ctx.dml, &dcn3_21_soc, &dcn3_21_ip, DML_PROJECT_DCN32);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}