{
  "module_name": "dcn31_fpu.c",
  "hash_id": "b55355aff07ae35e601dd62a0da0283ed5da170e9d4115f35ba792a80a7af636",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/dcn31/dcn31_fpu.c",
  "human_readable_source": " \n\n#include \"resource.h\"\n#include \"clk_mgr.h\"\n#include \"dcn31/dcn31_resource.h\"\n#include \"dcn315/dcn315_resource.h\"\n#include \"dcn316/dcn316_resource.h\"\n\n#include \"dml/dcn20/dcn20_fpu.h\"\n#include \"dcn31_fpu.h\"\n\n \n\nstruct _vcs_dpi_ip_params_st dcn3_1_ip = {\n\t.gpuvm_enable = 1,\n\t.gpuvm_max_page_table_levels = 1,\n\t.hostvm_enable = 1,\n\t.hostvm_max_page_table_levels = 2,\n\t.rob_buffer_size_kbytes = 64,\n\t.det_buffer_size_kbytes = DCN3_1_DEFAULT_DET_SIZE,\n\t.config_return_buffer_size_in_kbytes = 1792,\n\t.compressed_buffer_segment_size_in_kbytes = 64,\n\t.meta_fifo_size_in_kentries = 32,\n\t.zero_size_buffer_entries = 512,\n\t.compbuf_reserved_space_64b = 256,\n\t.compbuf_reserved_space_zs = 64,\n\t.dpp_output_buffer_pixels = 2560,\n\t.opp_output_buffer_lines = 1,\n\t.pixel_chunk_size_kbytes = 8,\n\t.meta_chunk_size_kbytes = 2,\n\t.min_meta_chunk_size_bytes = 256,\n\t.writeback_chunk_size_kbytes = 8,\n\t.ptoi_supported = false,\n\t.num_dsc = 3,\n\t.maximum_dsc_bits_per_component = 10,\n\t.dsc422_native_support = false,\n\t.is_line_buffer_bpp_fixed = true,\n\t.line_buffer_fixed_bpp = 48,\n\t.line_buffer_size_bits = 789504,\n\t.max_line_buffer_lines = 12,\n\t.writeback_interface_buffer_size_kbytes = 90,\n\t.max_num_dpp = 4,\n\t.max_num_otg = 4,\n\t.max_num_hdmi_frl_outputs = 1,\n\t.max_num_wb = 1,\n\t.max_dchub_pscl_bw_pix_per_clk = 4,\n\t.max_pscl_lb_bw_pix_per_clk = 2,\n\t.max_lb_vscl_bw_pix_per_clk = 4,\n\t.max_vscl_hscl_bw_pix_per_clk = 4,\n\t.max_hscl_ratio = 6,\n\t.max_vscl_ratio = 6,\n\t.max_hscl_taps = 8,\n\t.max_vscl_taps = 8,\n\t.dpte_buffer_size_in_pte_reqs_luma = 64,\n\t.dpte_buffer_size_in_pte_reqs_chroma = 34,\n\t.dispclk_ramp_margin_percent = 1,\n\t.max_inter_dcn_tile_repeaters = 8,\n\t.cursor_buffer_size = 16,\n\t.cursor_chunk_size = 2,\n\t.writeback_line_buffer_buffer_size = 0,\n\t.writeback_min_hscl_ratio = 1,\n\t.writeback_min_vscl_ratio = 1,\n\t.writeback_max_hscl_ratio = 1,\n\t.writeback_max_vscl_ratio = 1,\n\t.writeback_max_hscl_taps = 1,\n\t.writeback_max_vscl_taps = 1,\n\t.dppclk_delay_subtotal = 46,\n\t.dppclk_delay_scl = 50,\n\t.dppclk_delay_scl_lb_only = 16,\n\t.dppclk_delay_cnvc_formatter = 27,\n\t.dppclk_delay_cnvc_cursor = 6,\n\t.dispclk_delay_subtotal = 119,\n\t.dynamic_metadata_vm_enabled = false,\n\t.odm_combine_4to1_supported = false,\n\t.dcc_supported = true,\n};\n\nstatic struct _vcs_dpi_soc_bounding_box_st dcn3_1_soc = {\n\t\t \n\t.clock_limits = {\n\t\t{\n\t\t\t.state = 0,\n\t\t\t.dispclk_mhz = 1200.0,\n\t\t\t.dppclk_mhz = 1200.0,\n\t\t\t.phyclk_mhz = 600.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.dscclk_mhz = 186.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t\t{\n\t\t\t.state = 1,\n\t\t\t.dispclk_mhz = 1200.0,\n\t\t\t.dppclk_mhz = 1200.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.dscclk_mhz = 209.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t\t{\n\t\t\t.state = 2,\n\t\t\t.dispclk_mhz = 1200.0,\n\t\t\t.dppclk_mhz = 1200.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.dscclk_mhz = 209.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t\t{\n\t\t\t.state = 3,\n\t\t\t.dispclk_mhz = 1200.0,\n\t\t\t.dppclk_mhz = 1200.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.dscclk_mhz = 371.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t\t{\n\t\t\t.state = 4,\n\t\t\t.dispclk_mhz = 1200.0,\n\t\t\t.dppclk_mhz = 1200.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.dscclk_mhz = 417.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t},\n\t.num_states = 5,\n\t.sr_exit_time_us = 9.0,\n\t.sr_enter_plus_exit_time_us = 11.0,\n\t.sr_exit_z8_time_us = 442.0,\n\t.sr_enter_plus_exit_z8_time_us = 560.0,\n\t.writeback_latency_us = 12.0,\n\t.dram_channel_width_bytes = 4,\n\t.round_trip_ping_latency_dcfclk_cycles = 106,\n\t.urgent_latency_pixel_data_only_us = 4.0,\n\t.urgent_latency_pixel_mixed_with_vm_data_us = 4.0,\n\t.urgent_latency_vm_data_only_us = 4.0,\n\t.urgent_out_of_order_return_per_channel_pixel_only_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_pixel_and_vm_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_vm_only_bytes = 4096,\n\t.pct_ideal_sdp_bw_after_urgent = 80.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_only = 65.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm = 60.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_vm_only = 30.0,\n\t.max_avg_sdp_bw_use_normal_percent = 60.0,\n\t.max_avg_dram_bw_use_normal_percent = 60.0,\n\t.fabric_datapath_to_dcn_data_return_bytes = 32,\n\t.return_bus_width_bytes = 64,\n\t.downspread_percent = 0.38,\n\t.dcn_downspread_percent = 0.5,\n\t.gpuvm_min_page_size_bytes = 4096,\n\t.hostvm_min_page_size_bytes = 4096,\n\t.do_urgent_latency_adjustment = false,\n\t.urgent_latency_adjustment_fabric_clock_component_us = 0,\n\t.urgent_latency_adjustment_fabric_clock_reference_mhz = 0,\n};\n\nstruct _vcs_dpi_ip_params_st dcn3_15_ip = {\n\t.gpuvm_enable = 1,\n\t.gpuvm_max_page_table_levels = 1,\n\t.hostvm_enable = 1,\n\t.hostvm_max_page_table_levels = 2,\n\t.rob_buffer_size_kbytes = 64,\n\t.det_buffer_size_kbytes = DCN3_15_DEFAULT_DET_SIZE,\n\t.min_comp_buffer_size_kbytes = 64,\n\t.config_return_buffer_size_in_kbytes = 1024,\n\t.compressed_buffer_segment_size_in_kbytes = 64,\n\t.meta_fifo_size_in_kentries = 32,\n\t.zero_size_buffer_entries = 512,\n\t.compbuf_reserved_space_64b = 256,\n\t.compbuf_reserved_space_zs = 64,\n\t.dpp_output_buffer_pixels = 2560,\n\t.opp_output_buffer_lines = 1,\n\t.pixel_chunk_size_kbytes = 8,\n\t.meta_chunk_size_kbytes = 2,\n\t.min_meta_chunk_size_bytes = 256,\n\t.writeback_chunk_size_kbytes = 8,\n\t.ptoi_supported = false,\n\t.num_dsc = 3,\n\t.maximum_dsc_bits_per_component = 10,\n\t.dsc422_native_support = false,\n\t.is_line_buffer_bpp_fixed = true,\n\t.line_buffer_fixed_bpp = 48,\n\t.line_buffer_size_bits = 789504,\n\t.max_line_buffer_lines = 12,\n\t.writeback_interface_buffer_size_kbytes = 90,\n\t.max_num_dpp = 4,\n\t.max_num_otg = 4,\n\t.max_num_hdmi_frl_outputs = 1,\n\t.max_num_wb = 1,\n\t.max_dchub_pscl_bw_pix_per_clk = 4,\n\t.max_pscl_lb_bw_pix_per_clk = 2,\n\t.max_lb_vscl_bw_pix_per_clk = 4,\n\t.max_vscl_hscl_bw_pix_per_clk = 4,\n\t.max_hscl_ratio = 6,\n\t.max_vscl_ratio = 6,\n\t.max_hscl_taps = 8,\n\t.max_vscl_taps = 8,\n\t.dpte_buffer_size_in_pte_reqs_luma = 64,\n\t.dpte_buffer_size_in_pte_reqs_chroma = 34,\n\t.dispclk_ramp_margin_percent = 1,\n\t.max_inter_dcn_tile_repeaters = 9,\n\t.cursor_buffer_size = 16,\n\t.cursor_chunk_size = 2,\n\t.writeback_line_buffer_buffer_size = 0,\n\t.writeback_min_hscl_ratio = 1,\n\t.writeback_min_vscl_ratio = 1,\n\t.writeback_max_hscl_ratio = 1,\n\t.writeback_max_vscl_ratio = 1,\n\t.writeback_max_hscl_taps = 1,\n\t.writeback_max_vscl_taps = 1,\n\t.dppclk_delay_subtotal = 46,\n\t.dppclk_delay_scl = 50,\n\t.dppclk_delay_scl_lb_only = 16,\n\t.dppclk_delay_cnvc_formatter = 27,\n\t.dppclk_delay_cnvc_cursor = 6,\n\t.dispclk_delay_subtotal = 119,\n\t.dynamic_metadata_vm_enabled = false,\n\t.odm_combine_4to1_supported = false,\n\t.dcc_supported = true,\n};\n\nstatic struct _vcs_dpi_soc_bounding_box_st dcn3_15_soc = {\n\t.sr_exit_time_us = 9.0,\n\t.sr_enter_plus_exit_time_us = 11.0,\n\t.sr_exit_z8_time_us = 50.0,\n\t.sr_enter_plus_exit_z8_time_us = 50.0,\n\t.writeback_latency_us = 12.0,\n\t.dram_channel_width_bytes = 4,\n\t.round_trip_ping_latency_dcfclk_cycles = 106,\n\t.urgent_latency_pixel_data_only_us = 4.0,\n\t.urgent_latency_pixel_mixed_with_vm_data_us = 4.0,\n\t.urgent_latency_vm_data_only_us = 4.0,\n\t.urgent_out_of_order_return_per_channel_pixel_only_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_pixel_and_vm_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_vm_only_bytes = 4096,\n\t.pct_ideal_sdp_bw_after_urgent = 80.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_only = 65.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm = 60.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_vm_only = 30.0,\n\t.max_avg_sdp_bw_use_normal_percent = 60.0,\n\t.max_avg_dram_bw_use_normal_percent = 60.0,\n\t.fabric_datapath_to_dcn_data_return_bytes = 32,\n\t.return_bus_width_bytes = 64,\n\t.downspread_percent = 0.38,\n\t.dcn_downspread_percent = 0.38,\n\t.gpuvm_min_page_size_bytes = 4096,\n\t.hostvm_min_page_size_bytes = 4096,\n\t.do_urgent_latency_adjustment = false,\n\t.urgent_latency_adjustment_fabric_clock_component_us = 0,\n\t.urgent_latency_adjustment_fabric_clock_reference_mhz = 0,\n\t.num_chans = 4,\n\t.dummy_pstate_latency_us = 10.0\n};\n\nstruct _vcs_dpi_ip_params_st dcn3_16_ip = {\n\t.gpuvm_enable = 1,\n\t.gpuvm_max_page_table_levels = 1,\n\t.hostvm_enable = 1,\n\t.hostvm_max_page_table_levels = 2,\n\t.rob_buffer_size_kbytes = 64,\n\t.det_buffer_size_kbytes = DCN3_16_DEFAULT_DET_SIZE,\n\t.min_comp_buffer_size_kbytes = 64,\n\t.config_return_buffer_size_in_kbytes = 1024,\n\t.compressed_buffer_segment_size_in_kbytes = 64,\n\t.meta_fifo_size_in_kentries = 32,\n\t.zero_size_buffer_entries = 512,\n\t.compbuf_reserved_space_64b = 256,\n\t.compbuf_reserved_space_zs = 64,\n\t.dpp_output_buffer_pixels = 2560,\n\t.opp_output_buffer_lines = 1,\n\t.pixel_chunk_size_kbytes = 8,\n\t.meta_chunk_size_kbytes = 2,\n\t.min_meta_chunk_size_bytes = 256,\n\t.writeback_chunk_size_kbytes = 8,\n\t.ptoi_supported = false,\n\t.num_dsc = 3,\n\t.maximum_dsc_bits_per_component = 10,\n\t.dsc422_native_support = false,\n\t.is_line_buffer_bpp_fixed = true,\n\t.line_buffer_fixed_bpp = 48,\n\t.line_buffer_size_bits = 789504,\n\t.max_line_buffer_lines = 12,\n\t.writeback_interface_buffer_size_kbytes = 90,\n\t.max_num_dpp = 4,\n\t.max_num_otg = 4,\n\t.max_num_hdmi_frl_outputs = 1,\n\t.max_num_wb = 1,\n\t.max_dchub_pscl_bw_pix_per_clk = 4,\n\t.max_pscl_lb_bw_pix_per_clk = 2,\n\t.max_lb_vscl_bw_pix_per_clk = 4,\n\t.max_vscl_hscl_bw_pix_per_clk = 4,\n\t.max_hscl_ratio = 6,\n\t.max_vscl_ratio = 6,\n\t.max_hscl_taps = 8,\n\t.max_vscl_taps = 8,\n\t.dpte_buffer_size_in_pte_reqs_luma = 64,\n\t.dpte_buffer_size_in_pte_reqs_chroma = 34,\n\t.dispclk_ramp_margin_percent = 1,\n\t.max_inter_dcn_tile_repeaters = 8,\n\t.cursor_buffer_size = 16,\n\t.cursor_chunk_size = 2,\n\t.writeback_line_buffer_buffer_size = 0,\n\t.writeback_min_hscl_ratio = 1,\n\t.writeback_min_vscl_ratio = 1,\n\t.writeback_max_hscl_ratio = 1,\n\t.writeback_max_vscl_ratio = 1,\n\t.writeback_max_hscl_taps = 1,\n\t.writeback_max_vscl_taps = 1,\n\t.dppclk_delay_subtotal = 46,\n\t.dppclk_delay_scl = 50,\n\t.dppclk_delay_scl_lb_only = 16,\n\t.dppclk_delay_cnvc_formatter = 27,\n\t.dppclk_delay_cnvc_cursor = 6,\n\t.dispclk_delay_subtotal = 119,\n\t.dynamic_metadata_vm_enabled = false,\n\t.odm_combine_4to1_supported = false,\n\t.dcc_supported = true,\n};\n\nstatic struct _vcs_dpi_soc_bounding_box_st dcn3_16_soc = {\n\t\t \n\t.clock_limits = {\n\t\t{\n\t\t\t.state = 0,\n\t\t\t.dispclk_mhz = 556.0,\n\t\t\t.dppclk_mhz = 556.0,\n\t\t\t.phyclk_mhz = 600.0,\n\t\t\t.phyclk_d18_mhz = 445.0,\n\t\t\t.dscclk_mhz = 186.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t\t{\n\t\t\t.state = 1,\n\t\t\t.dispclk_mhz = 625.0,\n\t\t\t.dppclk_mhz = 625.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.dscclk_mhz = 209.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t\t{\n\t\t\t.state = 2,\n\t\t\t.dispclk_mhz = 625.0,\n\t\t\t.dppclk_mhz = 625.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.dscclk_mhz = 209.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t\t{\n\t\t\t.state = 3,\n\t\t\t.dispclk_mhz = 1112.0,\n\t\t\t.dppclk_mhz = 1112.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.dscclk_mhz = 371.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t\t{\n\t\t\t.state = 4,\n\t\t\t.dispclk_mhz = 1250.0,\n\t\t\t.dppclk_mhz = 1250.0,\n\t\t\t.phyclk_mhz = 810.0,\n\t\t\t.phyclk_d18_mhz = 667.0,\n\t\t\t.dscclk_mhz = 417.0,\n\t\t\t.dtbclk_mhz = 625.0,\n\t\t},\n\t},\n\t.num_states = 5,\n\t.sr_exit_time_us = 9.0,\n\t.sr_enter_plus_exit_time_us = 11.0,\n\t.sr_exit_z8_time_us = 442.0,\n\t.sr_enter_plus_exit_z8_time_us = 560.0,\n\t.writeback_latency_us = 12.0,\n\t.dram_channel_width_bytes = 4,\n\t.round_trip_ping_latency_dcfclk_cycles = 106,\n\t.urgent_latency_pixel_data_only_us = 4.0,\n\t.urgent_latency_pixel_mixed_with_vm_data_us = 4.0,\n\t.urgent_latency_vm_data_only_us = 4.0,\n\t.urgent_out_of_order_return_per_channel_pixel_only_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_pixel_and_vm_bytes = 4096,\n\t.urgent_out_of_order_return_per_channel_vm_only_bytes = 4096,\n\t.pct_ideal_sdp_bw_after_urgent = 80.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_only = 65.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_pixel_and_vm = 60.0,\n\t.pct_ideal_dram_sdp_bw_after_urgent_vm_only = 30.0,\n\t.max_avg_sdp_bw_use_normal_percent = 60.0,\n\t.max_avg_dram_bw_use_normal_percent = 60.0,\n\t.fabric_datapath_to_dcn_data_return_bytes = 32,\n\t.return_bus_width_bytes = 64,\n\t.downspread_percent = 0.38,\n\t.dcn_downspread_percent = 0.5,\n\t.gpuvm_min_page_size_bytes = 4096,\n\t.hostvm_min_page_size_bytes = 4096,\n\t.do_urgent_latency_adjustment = false,\n\t.urgent_latency_adjustment_fabric_clock_component_us = 0,\n\t.urgent_latency_adjustment_fabric_clock_reference_mhz = 0,\n};\n\nvoid dcn31_zero_pipe_dcc_fraction(display_e2e_pipe_params_st *pipes,\n\t\t\t\t  int pipe_cnt)\n{\n\tdc_assert_fp_enabled();\n\n\tpipes[pipe_cnt].pipe.src.dcc_fraction_of_zs_req_luma = 0;\n\tpipes[pipe_cnt].pipe.src.dcc_fraction_of_zs_req_chroma = 0;\n}\n\nvoid dcn31_update_soc_for_wm_a(struct dc *dc, struct dc_state *context)\n{\n\tdc_assert_fp_enabled();\n\n\tif (dc->clk_mgr->bw_params->wm_table.entries[WM_A].valid) {\n\t\tcontext->bw_ctx.dml.soc.dram_clock_change_latency_us = dc->clk_mgr->bw_params->wm_table.entries[WM_A].pstate_latency_us;\n\t\tcontext->bw_ctx.dml.soc.sr_enter_plus_exit_time_us = dc->clk_mgr->bw_params->wm_table.entries[WM_A].sr_enter_plus_exit_time_us;\n\t\tcontext->bw_ctx.dml.soc.sr_exit_time_us = dc->clk_mgr->bw_params->wm_table.entries[WM_A].sr_exit_time_us;\n\t}\n}\n\nvoid dcn315_update_soc_for_wm_a(struct dc *dc, struct dc_state *context)\n{\n\tdc_assert_fp_enabled();\n\n\tif (dc->clk_mgr->bw_params->wm_table.entries[WM_A].valid) {\n\t\t \n\t\tif (context->bw_ctx.dml.vba.DRAMClockChangeSupport[context->bw_ctx.dml.vba.VoltageLevel][context->bw_ctx.dml.vba.maxMpcComb] != dm_dram_clock_change_vactive)\n\t\t\tcontext->bw_ctx.dml.soc.dram_clock_change_latency_us = context->bw_ctx.dml.soc.dummy_pstate_latency_us;\n\t\telse\n\t\t\tcontext->bw_ctx.dml.soc.dram_clock_change_latency_us = dc->clk_mgr->bw_params->wm_table.entries[WM_A].pstate_latency_us;\n\t\tcontext->bw_ctx.dml.soc.sr_enter_plus_exit_time_us =\n\t\t\t\tdc->clk_mgr->bw_params->wm_table.entries[WM_A].sr_enter_plus_exit_time_us;\n\t\tcontext->bw_ctx.dml.soc.sr_exit_time_us =\n\t\t\t\tdc->clk_mgr->bw_params->wm_table.entries[WM_A].sr_exit_time_us;\n\t}\n}\n\nvoid dcn31_calculate_wm_and_dlg_fp(\n\t\tstruct dc *dc, struct dc_state *context,\n\t\tdisplay_e2e_pipe_params_st *pipes,\n\t\tint pipe_cnt,\n\t\tint vlevel)\n{\n\tint i, pipe_idx, total_det = 0, active_hubp_count = 0;\n\tdouble dcfclk = context->bw_ctx.dml.vba.DCFCLKState[vlevel][context->bw_ctx.dml.vba.maxMpcComb];\n\n\tdc_assert_fp_enabled();\n\n\tif (context->bw_ctx.dml.soc.min_dcfclk > dcfclk)\n\t\tdcfclk = context->bw_ctx.dml.soc.min_dcfclk;\n\n\t \n\tif (pipe_cnt == 0) {\n\t\tcontext->bw_ctx.bw.dcn.clk.dcfclk_khz = dcfclk;  \n\t\treturn;\n\t}\n\n\tpipes[0].clks_cfg.voltage = vlevel;\n\tpipes[0].clks_cfg.dcfclk_mhz = dcfclk;\n\tpipes[0].clks_cfg.socclk_mhz = context->bw_ctx.dml.soc.clock_limits[vlevel].socclk_mhz;\n\n\t \n\tdc->res_pool->funcs->update_soc_for_wm_a(dc, context);\n\tcontext->bw_ctx.bw.dcn.watermarks.a.urgent_ns = get_wm_urgent(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.cstate_pstate.cstate_enter_plus_exit_ns = get_wm_stutter_enter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.cstate_pstate.cstate_exit_ns = get_wm_stutter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.cstate_pstate.pstate_change_ns = get_wm_dram_clock_change(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.cstate_pstate.cstate_enter_plus_exit_z8_ns = get_wm_z8_stutter_enter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.cstate_pstate.cstate_exit_z8_ns = get_wm_z8_stutter_exit(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.pte_meta_urgent_ns = get_wm_memory_trip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.frac_urg_bw_nom = get_fraction_of_urgent_bandwidth(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.frac_urg_bw_flip = get_fraction_of_urgent_bandwidth_imm_flip(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.a.urgent_latency_ns = get_urgent_latency(&context->bw_ctx.dml, pipes, pipe_cnt) * 1000;\n\tcontext->bw_ctx.bw.dcn.watermarks.b = context->bw_ctx.bw.dcn.watermarks.a;\n\tcontext->bw_ctx.bw.dcn.watermarks.c = context->bw_ctx.bw.dcn.watermarks.a;\n\tcontext->bw_ctx.bw.dcn.watermarks.d = context->bw_ctx.bw.dcn.watermarks.a;\n\n\tfor (i = 0, pipe_idx = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tif (!context->res_ctx.pipe_ctx[i].stream)\n\t\t\tcontinue;\n\n\t\tif (context->res_ctx.pipe_ctx[i].plane_state)\n\t\t\tactive_hubp_count++;\n\n\t\tpipes[pipe_idx].clks_cfg.dispclk_mhz = get_dispclk_calculated(&context->bw_ctx.dml, pipes, pipe_cnt);\n\t\tpipes[pipe_idx].clks_cfg.dppclk_mhz = get_dppclk_calculated(&context->bw_ctx.dml, pipes, pipe_cnt, pipe_idx);\n\n\t\tif (dc->config.forced_clocks || dc->debug.max_disp_clk) {\n\t\t\tpipes[pipe_idx].clks_cfg.dispclk_mhz = context->bw_ctx.dml.soc.clock_limits[0].dispclk_mhz;\n\t\t\tpipes[pipe_idx].clks_cfg.dppclk_mhz = context->bw_ctx.dml.soc.clock_limits[0].dppclk_mhz;\n\t\t}\n\t\tif (dc->debug.min_disp_clk_khz > pipes[pipe_idx].clks_cfg.dispclk_mhz * 1000)\n\t\t\tpipes[pipe_idx].clks_cfg.dispclk_mhz = dc->debug.min_disp_clk_khz / 1000.0;\n\t\tif (dc->debug.min_dpp_clk_khz > pipes[pipe_idx].clks_cfg.dppclk_mhz * 1000)\n\t\t\tpipes[pipe_idx].clks_cfg.dppclk_mhz = dc->debug.min_dpp_clk_khz / 1000.0;\n\n\t\tpipe_idx++;\n\t}\n\n\tdcn20_calculate_dlg_params(dc, context, pipes, pipe_cnt, vlevel);\n\t \n\tcontext->bw_ctx.bw.dcn.clk.p_state_change_support =\n\t\t\tcontext->bw_ctx.dml.vba.DRAMClockChangeSupport[vlevel][context->bw_ctx.dml.vba.maxMpcComb] == dm_dram_clock_change_vactive;\n\t \n\tif (!active_hubp_count) {\n\t\tcontext->bw_ctx.bw.dcn.clk.socclk_khz = 0;\n\t\tcontext->bw_ctx.bw.dcn.clk.dppclk_khz = 0;\n\t\tcontext->bw_ctx.bw.dcn.clk.dcfclk_khz = 0;\n\t\tcontext->bw_ctx.bw.dcn.clk.dcfclk_deep_sleep_khz = 0;\n\t\tcontext->bw_ctx.bw.dcn.clk.dramclk_khz = 0;\n\t\tcontext->bw_ctx.bw.dcn.clk.fclk_khz = 0;\n\t\tcontext->bw_ctx.bw.dcn.clk.p_state_change_support = true;\n\t\tfor (i = 0; i < dc->res_pool->pipe_count; i++)\n\t\t\tif (context->res_ctx.pipe_ctx[i].stream)\n\t\t\t\tcontext->res_ctx.pipe_ctx[i].plane_res.bw.dppclk_khz = 0;\n\t}\n\tfor (i = 0, pipe_idx = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tif (!context->res_ctx.pipe_ctx[i].stream)\n\t\t\tcontinue;\n\n\t\tcontext->res_ctx.pipe_ctx[i].det_buffer_size_kb =\n\t\t\t\tget_det_buffer_size_kbytes(&context->bw_ctx.dml, pipes, pipe_cnt, pipe_idx);\n\t\tif (context->res_ctx.pipe_ctx[i].det_buffer_size_kb > 384)\n\t\t\tcontext->res_ctx.pipe_ctx[i].det_buffer_size_kb /= 2;\n\t\ttotal_det += context->res_ctx.pipe_ctx[i].det_buffer_size_kb;\n\t\tpipe_idx++;\n\t}\n\tcontext->bw_ctx.bw.dcn.compbuf_size_kb = context->bw_ctx.dml.ip.config_return_buffer_size_in_kbytes - total_det;\n}\n\nvoid dcn31_update_bw_bounding_box(struct dc *dc, struct clk_bw_params *bw_params)\n{\n\tstruct _vcs_dpi_voltage_scaling_st *s = dc->scratch.update_bw_bounding_box.clock_limits;\n\tstruct clk_limit_table *clk_table = &bw_params->clk_table;\n\tunsigned int i, closest_clk_lvl;\n\tint max_dispclk_mhz = 0, max_dppclk_mhz = 0;\n\tint j;\n\n\tdc_assert_fp_enabled();\n\n\tmemcpy(s, dcn3_1_soc.clock_limits, sizeof(dcn3_1_soc.clock_limits));\n\n\t\n\tdcn3_1_ip.max_num_otg = dc->res_pool->res_cap->num_timing_generator;\n\tdcn3_1_ip.max_num_dpp = dc->res_pool->pipe_count;\n\tdcn3_1_soc.num_chans = bw_params->num_channels;\n\n\tASSERT(clk_table->num_entries);\n\n\t \n\tfor (i = 0; i < clk_table->num_entries; ++i) {\n\t\tif (clk_table->entries[i].dispclk_mhz > max_dispclk_mhz)\n\t\t\tmax_dispclk_mhz = clk_table->entries[i].dispclk_mhz;\n\t\tif (clk_table->entries[i].dppclk_mhz > max_dppclk_mhz)\n\t\t\tmax_dppclk_mhz = clk_table->entries[i].dppclk_mhz;\n\t}\n\n\tfor (i = 0; i < clk_table->num_entries; i++) {\n\t\t \n\t\tfor (closest_clk_lvl = 0, j = dcn3_1_soc.num_states - 1; j >= 0; j--) {\n\t\t\tif ((unsigned int) dcn3_1_soc.clock_limits[j].dcfclk_mhz <= clk_table->entries[i].dcfclk_mhz) {\n\t\t\t\tclosest_clk_lvl = j;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\ts[i].state = i;\n\n\t\t \n\t\ts[i].dcfclk_mhz = clk_table->entries[i].dcfclk_mhz;\n\t\ts[i].fabricclk_mhz = clk_table->entries[i].fclk_mhz;\n\t\ts[i].socclk_mhz = clk_table->entries[i].socclk_mhz;\n\t\ts[i].dram_speed_mts = clk_table->entries[i].memclk_mhz *\n\t\t\t2 * clk_table->entries[i].wck_ratio;\n\n\t\t \n\t\ts[i].dispclk_mhz = max_dispclk_mhz ? max_dispclk_mhz :\n\t\t\tdcn3_1_soc.clock_limits[closest_clk_lvl].dispclk_mhz;\n\n\t\ts[i].dppclk_mhz = max_dppclk_mhz ? max_dppclk_mhz :\n\t\t\tdcn3_1_soc.clock_limits[closest_clk_lvl].dppclk_mhz;\n\n\t\ts[i].dram_bw_per_chan_gbps =\n\t\t\tdcn3_1_soc.clock_limits[closest_clk_lvl].dram_bw_per_chan_gbps;\n\t\ts[i].dscclk_mhz = dcn3_1_soc.clock_limits[closest_clk_lvl].dscclk_mhz;\n\t\ts[i].dtbclk_mhz = dcn3_1_soc.clock_limits[closest_clk_lvl].dtbclk_mhz;\n\t\ts[i].phyclk_d18_mhz =\n\t\t\tdcn3_1_soc.clock_limits[closest_clk_lvl].phyclk_d18_mhz;\n\t\ts[i].phyclk_mhz = dcn3_1_soc.clock_limits[closest_clk_lvl].phyclk_mhz;\n\t}\n\tif (clk_table->num_entries) {\n\t\tdcn3_1_soc.num_states = clk_table->num_entries;\n\t}\n\n\tmemcpy(dcn3_1_soc.clock_limits, s, sizeof(dcn3_1_soc.clock_limits));\n\n\tdcn3_1_soc.dispclk_dppclk_vco_speed_mhz = dc->clk_mgr->dentist_vco_freq_khz / 1000.0;\n\tdc->dml.soc.dispclk_dppclk_vco_speed_mhz = dc->clk_mgr->dentist_vco_freq_khz / 1000.0;\n\n\tif ((int)(dcn3_1_soc.dram_clock_change_latency_us * 1000)\n\t\t\t\t!= dc->debug.dram_clock_change_latency_ns\n\t\t\t&& dc->debug.dram_clock_change_latency_ns) {\n\t\tdcn3_1_soc.dram_clock_change_latency_us = dc->debug.dram_clock_change_latency_ns / 1000;\n\t}\n\n\tdml_init_instance(&dc->dml, &dcn3_1_soc, &dcn3_1_ip, DML_PROJECT_DCN31);\n}\n\nvoid dcn315_update_bw_bounding_box(struct dc *dc, struct clk_bw_params *bw_params)\n{\n\tstruct clk_limit_table *clk_table = &bw_params->clk_table;\n\tint i, max_dispclk_mhz = 0, max_dppclk_mhz = 0;\n\n\tdc_assert_fp_enabled();\n\n\tdcn3_15_ip.max_num_otg = dc->res_pool->res_cap->num_timing_generator;\n\tdcn3_15_ip.max_num_dpp = dc->res_pool->pipe_count;\n\n\tif (bw_params->num_channels > 0)\n\t\tdcn3_15_soc.num_chans = bw_params->num_channels;\n\tif (bw_params->dram_channel_width_bytes > 0)\n\t\tdcn3_15_soc.dram_channel_width_bytes = bw_params->dram_channel_width_bytes;\n\n\tASSERT(clk_table->num_entries);\n\n\t \n\tfor (i = 0; i < clk_table->num_entries; ++i) {\n\t\tif (clk_table->entries[i].dispclk_mhz > max_dispclk_mhz)\n\t\t\tmax_dispclk_mhz = clk_table->entries[i].dispclk_mhz;\n\t\tif (clk_table->entries[i].dppclk_mhz > max_dppclk_mhz)\n\t\t\tmax_dppclk_mhz = clk_table->entries[i].dppclk_mhz;\n\t}\n\n\tfor (i = 0; i < clk_table->num_entries; i++) {\n\t\tdcn3_15_soc.clock_limits[i].state = i;\n\n\t\t \n\t\tdcn3_15_soc.clock_limits[i].dcfclk_mhz = clk_table->entries[i].dcfclk_mhz;\n\t\tdcn3_15_soc.clock_limits[i].fabricclk_mhz = clk_table->entries[i].fclk_mhz;\n\t\tdcn3_15_soc.clock_limits[i].socclk_mhz = clk_table->entries[i].socclk_mhz;\n\t\tdcn3_15_soc.clock_limits[i].dram_speed_mts = clk_table->entries[i].memclk_mhz * 2 * clk_table->entries[i].wck_ratio;\n\n\t\t \n\t\tdcn3_15_soc.clock_limits[i].dtbclk_mhz = clk_table->entries[i].dtbclk_mhz;\n\t\tdcn3_15_soc.clock_limits[i].phyclk_d18_mhz = clk_table->entries[i].phyclk_d18_mhz;\n\t\tdcn3_15_soc.clock_limits[i].phyclk_mhz = clk_table->entries[i].phyclk_mhz;\n\n\t\t \n\t\tdcn3_15_soc.clock_limits[i].dispclk_mhz = max_dispclk_mhz;\n\t\tdcn3_15_soc.clock_limits[i].dppclk_mhz = max_dppclk_mhz;\n\t\tdcn3_15_soc.clock_limits[i].dscclk_mhz = max_dispclk_mhz / 3.0;\n\t}\n\tdcn3_15_soc.num_states = clk_table->num_entries;\n\n\n\t \n\tdcn3_15_soc.dispclk_dppclk_vco_speed_mhz = max_dispclk_mhz * 2;\n\n\tif ((int)(dcn3_15_soc.dram_clock_change_latency_us * 1000)\n\t\t\t\t!= dc->debug.dram_clock_change_latency_ns\n\t\t\t&& dc->debug.dram_clock_change_latency_ns) {\n\t\tdcn3_15_soc.dram_clock_change_latency_us = dc->debug.dram_clock_change_latency_ns / 1000;\n\t}\n\n\tdml_init_instance(&dc->dml, &dcn3_15_soc, &dcn3_15_ip, DML_PROJECT_DCN315);\n}\n\nvoid dcn316_update_bw_bounding_box(struct dc *dc, struct clk_bw_params *bw_params)\n{\n\tstruct _vcs_dpi_voltage_scaling_st *s = dc->scratch.update_bw_bounding_box.clock_limits;\n\tstruct clk_limit_table *clk_table = &bw_params->clk_table;\n\tunsigned int i, closest_clk_lvl;\n\tint max_dispclk_mhz = 0, max_dppclk_mhz = 0;\n\tint j;\n\n\tdc_assert_fp_enabled();\n\n\tmemcpy(s, dcn3_16_soc.clock_limits, sizeof(dcn3_16_soc.clock_limits));\n\n\t \n\tdcn3_16_ip.max_num_otg = dc->res_pool->res_cap->num_timing_generator;\n\tdcn3_16_ip.max_num_dpp = dc->res_pool->pipe_count;\n\tdcn3_16_soc.num_chans = bw_params->num_channels;\n\n\tASSERT(clk_table->num_entries);\n\n\t \n\tfor (i = 0; i < clk_table->num_entries; ++i) {\n\t\tif (clk_table->entries[i].dispclk_mhz > max_dispclk_mhz)\n\t\t\tmax_dispclk_mhz = clk_table->entries[i].dispclk_mhz;\n\t\tif (clk_table->entries[i].dppclk_mhz > max_dppclk_mhz)\n\t\t\tmax_dppclk_mhz = clk_table->entries[i].dppclk_mhz;\n\t}\n\n\tfor (i = 0; i < clk_table->num_entries; i++) {\n\t\t \n\t\tfor (closest_clk_lvl = 0, j = dcn3_16_soc.num_states - 1; j >= 0; j--) {\n\t\t\tif ((unsigned int) dcn3_16_soc.clock_limits[j].dcfclk_mhz <=\n\t\t\t    clk_table->entries[i].dcfclk_mhz) {\n\t\t\t\tclosest_clk_lvl = j;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\t \n\t\tif (clk_table->num_entries == 1) {\n\t\t\t \n\t\t\tclosest_clk_lvl = dcn3_16_soc.num_states - 1;\n\t\t}\n\n\t\ts[i].state = i;\n\n\t\t \n\t\ts[i].dcfclk_mhz = clk_table->entries[i].dcfclk_mhz;\n\t\tif (clk_table->num_entries == 1 &&\n\t\t    s[i].dcfclk_mhz <\n\t\t    dcn3_16_soc.clock_limits[closest_clk_lvl].dcfclk_mhz) {\n\t\t\t \n\t\t\ts[i].dcfclk_mhz =\n\t\t\t\tdcn3_16_soc.clock_limits[closest_clk_lvl].dcfclk_mhz;\n\t\t}\n\t\ts[i].fabricclk_mhz = clk_table->entries[i].fclk_mhz;\n\t\ts[i].socclk_mhz = clk_table->entries[i].socclk_mhz;\n\t\ts[i].dram_speed_mts = clk_table->entries[i].memclk_mhz *\n\t\t\t2 * clk_table->entries[i].wck_ratio;\n\n\t\t \n\t\ts[i].dispclk_mhz = max_dispclk_mhz ? max_dispclk_mhz :\n\t\t\tdcn3_16_soc.clock_limits[closest_clk_lvl].dispclk_mhz;\n\n\t\ts[i].dppclk_mhz = max_dppclk_mhz ? max_dppclk_mhz :\n\t\t\tdcn3_16_soc.clock_limits[closest_clk_lvl].dppclk_mhz;\n\n\t\ts[i].dram_bw_per_chan_gbps =\n\t\t\tdcn3_16_soc.clock_limits[closest_clk_lvl].dram_bw_per_chan_gbps;\n\t\ts[i].dscclk_mhz = dcn3_16_soc.clock_limits[closest_clk_lvl].dscclk_mhz;\n\t\ts[i].dtbclk_mhz = dcn3_16_soc.clock_limits[closest_clk_lvl].dtbclk_mhz;\n\t\ts[i].phyclk_d18_mhz =\n\t\t\tdcn3_16_soc.clock_limits[closest_clk_lvl].phyclk_d18_mhz;\n\t\ts[i].phyclk_mhz = dcn3_16_soc.clock_limits[closest_clk_lvl].phyclk_mhz;\n\t}\n\tif (clk_table->num_entries) {\n\t\tdcn3_16_soc.num_states = clk_table->num_entries;\n\t}\n\n\tmemcpy(dcn3_16_soc.clock_limits, s, sizeof(dcn3_16_soc.clock_limits));\n\n\tif (max_dispclk_mhz) {\n\t\tdcn3_16_soc.dispclk_dppclk_vco_speed_mhz = max_dispclk_mhz * 2;\n\t\tdc->dml.soc.dispclk_dppclk_vco_speed_mhz = max_dispclk_mhz * 2;\n\t}\n\tif ((int)(dcn3_16_soc.dram_clock_change_latency_us * 1000)\n\t\t\t\t!= dc->debug.dram_clock_change_latency_ns\n\t\t\t&& dc->debug.dram_clock_change_latency_ns) {\n\t\tdcn3_16_soc.dram_clock_change_latency_us = dc->debug.dram_clock_change_latency_ns / 1000;\n\t}\n\n\tdml_init_instance(&dc->dml, &dcn3_16_soc, &dcn3_16_ip, DML_PROJECT_DCN31);\n}\n\nint dcn_get_max_non_odm_pix_rate_100hz(struct _vcs_dpi_soc_bounding_box_st *soc)\n{\n\treturn soc->clock_limits[0].dispclk_mhz * 10000.0 / (1.0 + soc->dcn_downspread_percent / 100.0);\n}\n\nint dcn_get_approx_det_segs_required_for_pstate(\n\t\tstruct _vcs_dpi_soc_bounding_box_st *soc,\n\t\tint pix_clk_100hz, int bpp, int seg_size_kb)\n{\n\t \n\treturn (int)(soc->dram_clock_change_latency_us * pix_clk_100hz * bpp\n\t\t\t\t\t/ 10240000 + seg_size_kb - 1) /\tseg_size_kb;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}