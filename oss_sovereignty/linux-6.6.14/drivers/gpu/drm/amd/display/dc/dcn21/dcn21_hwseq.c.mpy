{
  "module_name": "dcn21_hwseq.c",
  "hash_id": "2979972f7da9b6a8b7bb54d6632ab5126e3943b34f3dd978865d287c8863e545",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn21/dcn21_hwseq.c",
  "human_readable_source": " \n\n#include \"dm_services.h\"\n#include \"dm_helpers.h\"\n#include \"core_types.h\"\n#include \"resource.h\"\n#include \"dce/dce_hwseq.h\"\n#include \"dce110/dce110_hw_sequencer.h\"\n#include \"dcn21_hwseq.h\"\n#include \"vmid.h\"\n#include \"reg_helper.h\"\n#include \"hw/clk_mgr.h\"\n#include \"dc_dmub_srv.h\"\n#include \"abm.h\"\n#include \"link.h\"\n\n#define DC_LOGGER_INIT(logger)\n\n#define CTX \\\n\thws->ctx\n#define REG(reg)\\\n\thws->regs->reg\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\thws->shifts->field_name, hws->masks->field_name\n\n \nstatic void mmhub_update_page_table_config(struct dcn_hubbub_phys_addr_config *config,\n\t\tstruct dce_hwseq *hws)\n{\n\tuint32_t page_table_base_hi;\n\tuint32_t page_table_base_lo;\n\n\tREG_GET(VM_CONTEXT0_PAGE_TABLE_BASE_ADDR_HI32,\n\t\t\tPAGE_DIRECTORY_ENTRY_HI32, &page_table_base_hi);\n\tREG_GET(VM_CONTEXT0_PAGE_TABLE_BASE_ADDR_LO32,\n\t\t\tPAGE_DIRECTORY_ENTRY_LO32, &page_table_base_lo);\n\n\tconfig->gart_config.page_table_base_addr = ((uint64_t)page_table_base_hi << 32) | page_table_base_lo;\n\n}\n\nint dcn21_init_sys_ctx(struct dce_hwseq *hws, struct dc *dc, struct dc_phy_addr_space_config *pa_config)\n{\n\tstruct dcn_hubbub_phys_addr_config config;\n\n\tconfig.system_aperture.fb_top = pa_config->system_aperture.fb_top;\n\tconfig.system_aperture.fb_offset = pa_config->system_aperture.fb_offset;\n\tconfig.system_aperture.fb_base = pa_config->system_aperture.fb_base;\n\tconfig.system_aperture.agp_top = pa_config->system_aperture.agp_top;\n\tconfig.system_aperture.agp_bot = pa_config->system_aperture.agp_bot;\n\tconfig.system_aperture.agp_base = pa_config->system_aperture.agp_base;\n\tconfig.gart_config.page_table_start_addr = pa_config->gart_config.page_table_start_addr;\n\tconfig.gart_config.page_table_end_addr = pa_config->gart_config.page_table_end_addr;\n\tconfig.gart_config.page_table_base_addr = pa_config->gart_config.page_table_base_addr;\n\n\tmmhub_update_page_table_config(&config, hws);\n\n\treturn dc->res_pool->hubbub->funcs->init_dchub_sys_ctx(dc->res_pool->hubbub, &config);\n}\n\n\n\nbool dcn21_s0i3_golden_init_wa(struct dc *dc)\n{\n\tstruct dce_hwseq *hws = dc->hwseq;\n\tuint32_t value = 0;\n\n\tvalue = REG_READ(MICROSECOND_TIME_BASE_DIV);\n\n\treturn value != 0x00120464;\n}\n\nvoid dcn21_exit_optimized_pwr_state(\n\t\tconst struct dc *dc,\n\t\tstruct dc_state *context)\n{\n\tdc->clk_mgr->funcs->update_clocks(\n\t\t\tdc->clk_mgr,\n\t\t\tcontext,\n\t\t\tfalse);\n}\n\nvoid dcn21_optimize_pwr_state(\n\t\tconst struct dc *dc,\n\t\tstruct dc_state *context)\n{\n\tdc->clk_mgr->funcs->update_clocks(\n\t\t\tdc->clk_mgr,\n\t\t\tcontext,\n\t\t\ttrue);\n}\n\n \nvoid dcn21_PLAT_58856_wa(struct dc_state *context, struct pipe_ctx *pipe_ctx)\n{\n\tif (!pipe_ctx->stream->dpms_off)\n\t\treturn;\n\n\tpipe_ctx->stream->dpms_off = false;\n\tpipe_ctx->stream->ctx->dc->link_srv->set_dpms_on(context, pipe_ctx);\n\tpipe_ctx->stream->ctx->dc->link_srv->set_dpms_off(pipe_ctx);\n\tpipe_ctx->stream->dpms_off = true;\n}\n\nstatic bool dmub_abm_set_pipe(struct abm *abm, uint32_t otg_inst,\n\t\tuint32_t option, uint32_t panel_inst, uint32_t pwrseq_inst)\n{\n\tunion dmub_rb_cmd cmd;\n\tstruct dc_context *dc = abm->ctx;\n\tuint32_t ramping_boundary = 0xFFFF;\n\n\tmemset(&cmd, 0, sizeof(cmd));\n\tcmd.abm_set_pipe.header.type = DMUB_CMD__ABM;\n\tcmd.abm_set_pipe.header.sub_type = DMUB_CMD__ABM_SET_PIPE;\n\tcmd.abm_set_pipe.abm_set_pipe_data.otg_inst = otg_inst;\n\tcmd.abm_set_pipe.abm_set_pipe_data.pwrseq_inst = pwrseq_inst;\n\tcmd.abm_set_pipe.abm_set_pipe_data.set_pipe_option = option;\n\tcmd.abm_set_pipe.abm_set_pipe_data.panel_inst = panel_inst;\n\tcmd.abm_set_pipe.abm_set_pipe_data.ramping_boundary = ramping_boundary;\n\tcmd.abm_set_pipe.header.payload_bytes = sizeof(struct dmub_cmd_abm_set_pipe_data);\n\n\tdm_execute_dmub_cmd(dc, &cmd, DM_DMUB_WAIT_TYPE_WAIT);\n\n\treturn true;\n}\n\nstatic void dmub_abm_set_backlight(struct dc_context *dc, uint32_t backlight_pwm_u16_16,\n\t\t\t\t\t\t\t\t\tuint32_t frame_ramp, uint32_t panel_inst)\n{\n\tunion dmub_rb_cmd cmd;\n\n\tmemset(&cmd, 0, sizeof(cmd));\n\tcmd.abm_set_backlight.header.type = DMUB_CMD__ABM;\n\tcmd.abm_set_backlight.header.sub_type = DMUB_CMD__ABM_SET_BACKLIGHT;\n\tcmd.abm_set_backlight.abm_set_backlight_data.frame_ramp = frame_ramp;\n\tcmd.abm_set_backlight.abm_set_backlight_data.backlight_user_level = backlight_pwm_u16_16;\n\tcmd.abm_set_backlight.abm_set_backlight_data.version = DMUB_CMD_ABM_CONTROL_VERSION_1;\n\tcmd.abm_set_backlight.abm_set_backlight_data.panel_mask = (0x01 << panel_inst);\n\tcmd.abm_set_backlight.header.payload_bytes = sizeof(struct dmub_cmd_abm_set_backlight_data);\n\n\tdm_execute_dmub_cmd(dc, &cmd, DM_DMUB_WAIT_TYPE_WAIT);\n}\n\nvoid dcn21_set_abm_immediate_disable(struct pipe_ctx *pipe_ctx)\n{\n\tstruct abm *abm = pipe_ctx->stream_res.abm;\n\tuint32_t otg_inst = pipe_ctx->stream_res.tg->inst;\n\tstruct panel_cntl *panel_cntl = pipe_ctx->stream->link->panel_cntl;\n\tstruct dmcu *dmcu = pipe_ctx->stream->ctx->dc->res_pool->dmcu;\n\n\tif (dmcu) {\n\t\tdce110_set_abm_immediate_disable(pipe_ctx);\n\t\treturn;\n\t}\n\n\tif (abm && panel_cntl) {\n\t\tif (abm->funcs && abm->funcs->set_pipe_ex) {\n\t\t\tabm->funcs->set_pipe_ex(abm, otg_inst, SET_ABM_PIPE_IMMEDIATELY_DISABLE,\n\t\t\t\t\tpanel_cntl->inst, panel_cntl->pwrseq_inst);\n\t\t} else {\n\t\t\t\tdmub_abm_set_pipe(abm,\n\t\t\t\t\t\totg_inst,\n\t\t\t\t\t\tSET_ABM_PIPE_IMMEDIATELY_DISABLE,\n\t\t\t\t\t\tpanel_cntl->inst,\n\t\t\t\t\t\tpanel_cntl->pwrseq_inst);\n\t\t}\n\t\tpanel_cntl->funcs->store_backlight_level(panel_cntl);\n\t}\n}\n\nvoid dcn21_set_pipe(struct pipe_ctx *pipe_ctx)\n{\n\tstruct abm *abm = pipe_ctx->stream_res.abm;\n\tuint32_t otg_inst = pipe_ctx->stream_res.tg->inst;\n\tstruct panel_cntl *panel_cntl = pipe_ctx->stream->link->panel_cntl;\n\tstruct dmcu *dmcu = pipe_ctx->stream->ctx->dc->res_pool->dmcu;\n\n\tif (dmcu) {\n\t\tdce110_set_pipe(pipe_ctx);\n\t\treturn;\n\t}\n\n\tif (abm && panel_cntl) {\n\t\tif (abm->funcs && abm->funcs->set_pipe_ex) {\n\t\t\tabm->funcs->set_pipe_ex(abm,\n\t\t\t\t\totg_inst,\n\t\t\t\t\tSET_ABM_PIPE_NORMAL,\n\t\t\t\t\tpanel_cntl->inst,\n\t\t\t\t\tpanel_cntl->pwrseq_inst);\n\t\t} else {\n\t\t\t\tdmub_abm_set_pipe(abm, otg_inst,\n\t\t\t\t\t\tSET_ABM_PIPE_NORMAL,\n\t\t\t\t\t\tpanel_cntl->inst,\n\t\t\t\t\t\tpanel_cntl->pwrseq_inst);\n\t\t}\n\t}\n}\n\nbool dcn21_set_backlight_level(struct pipe_ctx *pipe_ctx,\n\t\tuint32_t backlight_pwm_u16_16,\n\t\tuint32_t frame_ramp)\n{\n\tstruct dc_context *dc = pipe_ctx->stream->ctx;\n\tstruct abm *abm = pipe_ctx->stream_res.abm;\n\tstruct panel_cntl *panel_cntl = pipe_ctx->stream->link->panel_cntl;\n\n\tif (dc->dc->res_pool->dmcu) {\n\t\tdce110_set_backlight_level(pipe_ctx, backlight_pwm_u16_16, frame_ramp);\n\t\treturn true;\n\t}\n\n\tif (abm != NULL) {\n\t\tuint32_t otg_inst = pipe_ctx->stream_res.tg->inst;\n\n\t\tif (abm && panel_cntl) {\n\t\t\tif (abm->funcs && abm->funcs->set_pipe_ex) {\n\t\t\t\tabm->funcs->set_pipe_ex(abm,\n\t\t\t\t\t\totg_inst,\n\t\t\t\t\t\tSET_ABM_PIPE_NORMAL,\n\t\t\t\t\t\tpanel_cntl->inst,\n\t\t\t\t\t\tpanel_cntl->pwrseq_inst);\n\t\t\t} else {\n\t\t\t\t\tdmub_abm_set_pipe(abm,\n\t\t\t\t\t\t\totg_inst,\n\t\t\t\t\t\t\tSET_ABM_PIPE_NORMAL,\n\t\t\t\t\t\t\tpanel_cntl->inst,\n\t\t\t\t\t\t\tpanel_cntl->pwrseq_inst);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (abm && abm->funcs && abm->funcs->set_backlight_level_pwm)\n\t\tabm->funcs->set_backlight_level_pwm(abm, backlight_pwm_u16_16,\n\t\t\tframe_ramp, 0, panel_cntl->inst);\n\telse\n\t\tdmub_abm_set_backlight(dc, backlight_pwm_u16_16, frame_ramp, panel_cntl->inst);\n\n\treturn true;\n}\n\nbool dcn21_is_abm_supported(struct dc *dc,\n\t\tstruct dc_state *context, struct dc_stream_state *stream)\n{\n\tint i;\n\n\tfor (i = 0; i < dc->res_pool->pipe_count; i++) {\n\t\tstruct pipe_ctx *pipe_ctx = &context->res_ctx.pipe_ctx[i];\n\n\t\tif (pipe_ctx->stream == stream &&\n\t\t\t\t(pipe_ctx->prev_odm_pipe == NULL && pipe_ctx->next_odm_pipe == NULL))\n\t\t\treturn true;\n\t}\n\treturn false;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}