{
  "module_name": "link_dp_dpia_bw.c",
  "hash_id": "013880f11bfe396234f75e29a6486ecff562804a8386dc1577b13d2ed00df234",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/link/protocols/link_dp_dpia_bw.c",
  "human_readable_source": "\n \n \n\n \n#include \"link_dp_dpia_bw.h\"\n#include \"link_dpcd.h\"\n#include \"dc_dmub_srv.h\"\n\n#define DC_LOGGER \\\n\tlink->ctx->logger\n\n#define Kbps_TO_Gbps (1000 * 1000)\n\n\n\n\n \nstatic bool get_bw_alloc_proceed_flag(struct dc_link *tmp)\n{\n\treturn (tmp && DISPLAY_ENDPOINT_USB4_DPIA == tmp->ep_type\n\t\t\t&& tmp->hpd_status\n\t\t\t&& tmp->dpia_bw_alloc_config.bw_alloc_enabled);\n}\nstatic void reset_bw_alloc_struct(struct dc_link *link)\n{\n\tlink->dpia_bw_alloc_config.bw_alloc_enabled = false;\n\tlink->dpia_bw_alloc_config.sink_verified_bw = 0;\n\tlink->dpia_bw_alloc_config.sink_max_bw = 0;\n\tlink->dpia_bw_alloc_config.estimated_bw = 0;\n\tlink->dpia_bw_alloc_config.bw_granularity = 0;\n\tlink->dpia_bw_alloc_config.response_ready = false;\n}\nstatic uint8_t get_bw_granularity(struct dc_link *link)\n{\n\tuint8_t bw_granularity = 0;\n\n\tcore_link_read_dpcd(\n\t\t\tlink,\n\t\t\tDP_BW_GRANULALITY,\n\t\t\t&bw_granularity,\n\t\t\tsizeof(uint8_t));\n\n\tswitch (bw_granularity & 0x3) {\n\tcase 0:\n\t\tbw_granularity = 4;\n\t\tbreak;\n\tcase 1:\n\tdefault:\n\t\tbw_granularity = 2;\n\t\tbreak;\n\t}\n\n\treturn bw_granularity;\n}\nstatic int get_estimated_bw(struct dc_link *link)\n{\n\tuint8_t bw_estimated_bw = 0;\n\n\tcore_link_read_dpcd(\n\t\t\tlink,\n\t\t\tESTIMATED_BW,\n\t\t\t&bw_estimated_bw,\n\t\t\tsizeof(uint8_t));\n\n\treturn bw_estimated_bw * (Kbps_TO_Gbps / link->dpia_bw_alloc_config.bw_granularity);\n}\nstatic bool allocate_usb4_bw(int *stream_allocated_bw, int bw_needed, struct dc_link *link)\n{\n\tif (bw_needed > 0)\n\t\t*stream_allocated_bw += bw_needed;\n\n\treturn true;\n}\nstatic bool deallocate_usb4_bw(int *stream_allocated_bw, int bw_to_dealloc, struct dc_link *link)\n{\n\tbool ret = false;\n\n\tif (*stream_allocated_bw > 0) {\n\t\t*stream_allocated_bw -= bw_to_dealloc;\n\t\tret = true;\n\t} else {\n\t\t\n\t\tret = true;\n\t}\n\n\t\n\tif (!link->hpd_status)\n\t\treset_bw_alloc_struct(link);\n\n\treturn ret;\n}\n \nstatic void init_usb4_bw_struct(struct dc_link *link)\n{\n\t\n\tlink->dpia_bw_alloc_config.bw_granularity = get_bw_granularity(link);\n\tlink->dpia_bw_alloc_config.estimated_bw = get_estimated_bw(link);\n}\nstatic uint8_t get_lowest_dpia_index(struct dc_link *link)\n{\n\tconst struct dc *dc_struct = link->dc;\n\tuint8_t idx = 0xFF;\n\tint i;\n\n\tfor (i = 0; i < MAX_PIPES * 2; ++i) {\n\n\t\tif (!dc_struct->links[i] ||\n\t\t\t\tdc_struct->links[i]->ep_type != DISPLAY_ENDPOINT_USB4_DPIA)\n\t\t\tcontinue;\n\n\t\tif (idx > dc_struct->links[i]->link_index)\n\t\t\tidx = dc_struct->links[i]->link_index;\n\t}\n\n\treturn idx;\n}\n \nstatic int get_host_router_total_bw(struct dc_link *link, uint8_t type)\n{\n\tconst struct dc *dc_struct = link->dc;\n\tuint8_t lowest_dpia_index = get_lowest_dpia_index(link);\n\tuint8_t idx = (link->link_index - lowest_dpia_index) / 2, idx_temp = 0;\n\tstruct dc_link *link_temp;\n\tint total_bw = 0;\n\tint i;\n\n\tfor (i = 0; i < MAX_PIPES * 2; ++i) {\n\n\t\tif (!dc_struct->links[i] || dc_struct->links[i]->ep_type != DISPLAY_ENDPOINT_USB4_DPIA)\n\t\t\tcontinue;\n\n\t\tlink_temp = dc_struct->links[i];\n\t\tif (!link_temp || !link_temp->hpd_status)\n\t\t\tcontinue;\n\n\t\tidx_temp = (link_temp->link_index - lowest_dpia_index) / 2;\n\n\t\tif (idx_temp == idx) {\n\n\t\t\tif (type == HOST_ROUTER_BW_ESTIMATED)\n\t\t\t\ttotal_bw += link_temp->dpia_bw_alloc_config.estimated_bw;\n\t\t\telse if (type == HOST_ROUTER_BW_ALLOCATED)\n\t\t\t\ttotal_bw += link_temp->dpia_bw_alloc_config.sink_allocated_bw;\n\t\t}\n\t}\n\n\treturn total_bw;\n}\n \nstatic bool dpia_bw_alloc_unplug(struct dc_link *link)\n{\n\tif (!link)\n\t\treturn true;\n\n\treturn deallocate_usb4_bw(&link->dpia_bw_alloc_config.sink_allocated_bw,\n\t\t\tlink->dpia_bw_alloc_config.sink_allocated_bw, link);\n}\nstatic void set_usb4_req_bw_req(struct dc_link *link, int req_bw)\n{\n\tuint8_t requested_bw;\n\tuint32_t temp;\n\n\t\n\tif (req_bw > link->dpia_bw_alloc_config.estimated_bw)\n\t\treq_bw = link->dpia_bw_alloc_config.estimated_bw;\n\n\ttemp = req_bw * link->dpia_bw_alloc_config.bw_granularity;\n\trequested_bw = temp / Kbps_TO_Gbps;\n\n\t\n\tif (temp % Kbps_TO_Gbps)\n\t\t++requested_bw;\n\n\t\n\treq_bw = requested_bw * (Kbps_TO_Gbps / link->dpia_bw_alloc_config.bw_granularity);\n\tif (req_bw == link->dpia_bw_alloc_config.sink_allocated_bw)\n\t\treturn;\n\n\tif (core_link_write_dpcd(\n\t\tlink,\n\t\tREQUESTED_BW,\n\t\t&requested_bw,\n\t\tsizeof(uint8_t)) == DC_OK)\n\t\tlink->dpia_bw_alloc_config.response_ready = false; \n}\n \nstatic bool get_cm_response_ready_flag(struct dc_link *link)\n{\n\treturn link->dpia_bw_alloc_config.response_ready;\n}\n\n\n\nbool link_dp_dpia_set_dptx_usb4_bw_alloc_support(struct dc_link *link)\n{\n\tbool ret = false;\n\tuint8_t response = 0,\n\t\t\tbw_support_dpia = 0,\n\t\t\tbw_support_cm = 0;\n\n\tif (!(link->ep_type == DISPLAY_ENDPOINT_USB4_DPIA && link->hpd_status))\n\t\tgoto out;\n\n\tif (core_link_read_dpcd(\n\t\t\tlink,\n\t\t\tDP_TUNNELING_CAPABILITIES,\n\t\t\t&response,\n\t\t\tsizeof(uint8_t)) == DC_OK)\n\t\tbw_support_dpia = (response >> 7) & 1;\n\n\tif (core_link_read_dpcd(\n\t\tlink,\n\t\tUSB4_DRIVER_BW_CAPABILITY,\n\t\t&response,\n\t\tsizeof(uint8_t)) == DC_OK)\n\t\tbw_support_cm = (response >> 7) & 1;\n\n\t \n\tif (bw_support_cm && bw_support_dpia) {\n\n\t\tresponse = 0x80;\n\t\tif (core_link_write_dpcd(\n\t\t\t\tlink,\n\t\t\t\tDPTX_BW_ALLOCATION_MODE_CONTROL,\n\t\t\t\t&response,\n\t\t\t\tsizeof(uint8_t)) != DC_OK) {\n\t\t\tDC_LOG_DEBUG(\"%s: **** FAILURE Enabling DPtx BW Allocation Mode Support ***\\n\",\n\t\t\t\t\t__func__);\n\t\t} else {\n\t\t\t\n\t\t\tlink->dpia_bw_alloc_config.bw_alloc_enabled = true;\n\t\t\tDC_LOG_DEBUG(\"%s: **** SUCCESS Enabling DPtx BW Allocation Mode Support ***\\n\",\n\t\t\t\t\t__func__);\n\n\t\t\tret = true;\n\t\t\tinit_usb4_bw_struct(link);\n\t\t}\n\t}\n\nout:\n\treturn ret;\n}\nvoid dpia_handle_bw_alloc_response(struct dc_link *link, uint8_t bw, uint8_t result)\n{\n\tint bw_needed = 0;\n\tint estimated = 0;\n\tint host_router_total_estimated_bw = 0;\n\n\tif (!get_bw_alloc_proceed_flag((link)))\n\t\treturn;\n\n\tswitch (result) {\n\n\tcase DPIA_BW_REQ_FAILED:\n\n\t\tDC_LOG_DEBUG(\"%s: *** *** BW REQ FAILURE for DP-TX Request *** ***\\n\", __func__);\n\n\t\t\n\t\tlink->dpia_bw_alloc_config.estimated_bw =\n\t\t\t\tbw * (Kbps_TO_Gbps / link->dpia_bw_alloc_config.bw_granularity);\n\n\t\tset_usb4_req_bw_req(link, link->dpia_bw_alloc_config.estimated_bw);\n\t\tlink->dpia_bw_alloc_config.response_ready = false;\n\n\t\t \n\t\tbreak;\n\n\tcase DPIA_BW_REQ_SUCCESS:\n\n\t\tDC_LOG_DEBUG(\"%s: *** BW REQ SUCCESS for DP-TX Request ***\\n\", __func__);\n\n\t\t\n\t\t\n\t\t\n\n\t\tbw_needed = bw * (Kbps_TO_Gbps / link->dpia_bw_alloc_config.bw_granularity);\n\n\t\t\n\t\tif (!link->dpia_bw_alloc_config.sink_allocated_bw) {\n\n\t\t\tallocate_usb4_bw(&link->dpia_bw_alloc_config.sink_allocated_bw, bw_needed, link);\n\t\t\tlink->dpia_bw_alloc_config.sink_verified_bw =\n\t\t\t\t\tlink->dpia_bw_alloc_config.sink_allocated_bw;\n\n\t\t\t\n\t\t\tif (link->dpia_bw_alloc_config.sink_allocated_bw >\n\t\t\tlink->dpia_bw_alloc_config.sink_max_bw)\n\t\t\t\tlink->dpia_bw_alloc_config.sink_verified_bw =\n\t\t\t\t\t\tlink->dpia_bw_alloc_config.sink_max_bw;\n\t\t}\n\t\t\n\t\telse if (link->dpia_bw_alloc_config.sink_allocated_bw) {\n\n\t\t\t\n\t\t\tif (link->dpia_bw_alloc_config.sink_allocated_bw > bw_needed)\n\t\t\t\tdeallocate_usb4_bw(&link->dpia_bw_alloc_config.sink_allocated_bw,\n\t\t\t\t\t\tlink->dpia_bw_alloc_config.sink_allocated_bw - bw_needed, link);\n\t\t\telse\n\t\t\t\tallocate_usb4_bw(&link->dpia_bw_alloc_config.sink_allocated_bw,\n\t\t\t\t\t\tbw_needed - link->dpia_bw_alloc_config.sink_allocated_bw, link);\n\t\t}\n\n\t\t\n\t\t\n\n\t\tlink->dpia_bw_alloc_config.response_ready = true;\n\t\tbreak;\n\n\tcase DPIA_EST_BW_CHANGED:\n\n\t\tDC_LOG_DEBUG(\"%s: *** ESTIMATED BW CHANGED for DP-TX Request ***\\n\", __func__);\n\n\t\testimated = bw * (Kbps_TO_Gbps / link->dpia_bw_alloc_config.bw_granularity);\n\t\thost_router_total_estimated_bw = get_host_router_total_bw(link, HOST_ROUTER_BW_ESTIMATED);\n\n\t\t\n\t\tif (estimated == host_router_total_estimated_bw) {\n\t\t\t\n\t\t\tif (link->dpia_bw_alloc_config.estimated_bw < estimated)\n\t\t\t\tlink->dpia_bw_alloc_config.estimated_bw = estimated;\n\t\t}\n\t\t\n\t\telse {\n\t\t\t\n\t\t\tlink->dpia_bw_alloc_config.estimated_bw = estimated;\n\t\t}\n\t\tbreak;\n\n\tcase DPIA_BW_ALLOC_CAPS_CHANGED:\n\n\t\tDC_LOG_DEBUG(\"%s: *** BW ALLOC CAPABILITY CHANGED for DP-TX Request ***\\n\", __func__);\n\t\tlink->dpia_bw_alloc_config.bw_alloc_enabled = false;\n\t\tbreak;\n\t}\n}\nint dpia_handle_usb4_bandwidth_allocation_for_link(struct dc_link *link, int peak_bw)\n{\n\tint ret = 0;\n\tuint8_t timeout = 10;\n\n\tif (!(link && DISPLAY_ENDPOINT_USB4_DPIA == link->ep_type\n\t\t\t&& link->dpia_bw_alloc_config.bw_alloc_enabled))\n\t\tgoto out;\n\n\t\n\tif (link->hpd_status && peak_bw > 0) {\n\n\t\t\n\t\tlink->dpia_bw_alloc_config.sink_max_bw = peak_bw;\n\t\tset_usb4_req_bw_req(link, link->dpia_bw_alloc_config.sink_max_bw);\n\n\t\tdo {\n\t\t\tif (!(timeout > 0))\n\t\t\t\ttimeout--;\n\t\t\telse\n\t\t\t\tbreak;\n\t\t\tfsleep(10 * 1000);\n\t\t} while (!get_cm_response_ready_flag(link));\n\n\t\tif (!timeout)\n\t\t\tret = 0;\n\t\telse if (link->dpia_bw_alloc_config.sink_allocated_bw > 0)\n\t\t\tret = get_host_router_total_bw(link, HOST_ROUTER_BW_ALLOCATED);\n\t}\n\t\n\telse if (!link->hpd_status)\n\t\tdpia_bw_alloc_unplug(link);\n\nout:\n\treturn ret;\n}\nint link_dp_dpia_allocate_usb4_bandwidth_for_stream(struct dc_link *link, int req_bw)\n{\n\tint ret = 0;\n\tuint8_t timeout = 10;\n\n\tif (!get_bw_alloc_proceed_flag(link))\n\t\tgoto out;\n\n\t \n\tif (req_bw != link->dpia_bw_alloc_config.sink_allocated_bw) {\n\t\tset_usb4_req_bw_req(link, req_bw);\n\t\tdo {\n\t\t\tif (!(timeout > 0))\n\t\t\t\ttimeout--;\n\t\t\telse\n\t\t\t\tbreak;\n\t\t\tudelay(10 * 1000);\n\t\t} while (!get_cm_response_ready_flag(link));\n\n\t\tif (!timeout)\n\t\t\tret = 0;\n\t\telse if (link->dpia_bw_alloc_config.sink_allocated_bw > 0)\n\t\t\tret = get_host_router_total_bw(link, HOST_ROUTER_BW_ALLOCATED);\n\t}\n\nout:\n\treturn ret;\n}\nbool dpia_validate_usb4_bw(struct dc_link **link, int *bw_needed_per_dpia, const unsigned int num_dpias)\n{\n\tbool ret = true;\n\tint bw_needed_per_hr[MAX_HR_NUM] = { 0, 0 };\n\tuint8_t lowest_dpia_index = 0, dpia_index = 0;\n\tuint8_t i;\n\n\tif (!num_dpias || num_dpias > MAX_DPIA_NUM)\n\t\treturn ret;\n\n\t\n\tfor (i = 0; i < num_dpias; ++i) {\n\n\t\tif (!link[i]->dpia_bw_alloc_config.bw_alloc_enabled)\n\t\t\tcontinue;\n\n\t\tlowest_dpia_index = get_lowest_dpia_index(link[i]);\n\t\tif (link[i]->link_index < lowest_dpia_index)\n\t\t\tcontinue;\n\n\t\tdpia_index = (link[i]->link_index - lowest_dpia_index) / 2;\n\t\tbw_needed_per_hr[dpia_index] += bw_needed_per_dpia[i];\n\t\tif (bw_needed_per_hr[dpia_index] > get_host_router_total_bw(link[i], HOST_ROUTER_BW_ALLOCATED)) {\n\n\t\t\tret = false;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}