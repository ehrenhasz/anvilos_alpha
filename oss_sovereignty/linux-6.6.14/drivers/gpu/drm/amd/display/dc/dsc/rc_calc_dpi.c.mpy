{
  "module_name": "rc_calc_dpi.c",
  "hash_id": "d2aba0a48142fcd74a204db0058f3c45e8d6348cff956e5da476c2c38b0ffc3c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dsc/rc_calc_dpi.c",
  "human_readable_source": " \n#include <drm/display/drm_dsc_helper.h>\n#include \"dscc_types.h\"\n#include \"rc_calc.h\"\n\nstatic void copy_pps_fields(struct drm_dsc_config *to, const struct drm_dsc_config *from)\n{\n\tto->line_buf_depth           = from->line_buf_depth;\n\tto->bits_per_component       = from->bits_per_component;\n\tto->convert_rgb              = from->convert_rgb;\n\tto->slice_width              = from->slice_width;\n\tto->slice_height             = from->slice_height;\n\tto->simple_422               = from->simple_422;\n\tto->native_422               = from->native_422;\n\tto->native_420               = from->native_420;\n\tto->pic_width                = from->pic_width;\n\tto->pic_height               = from->pic_height;\n\tto->rc_tgt_offset_high       = from->rc_tgt_offset_high;\n\tto->rc_tgt_offset_low        = from->rc_tgt_offset_low;\n\tto->bits_per_pixel           = from->bits_per_pixel;\n\tto->rc_edge_factor           = from->rc_edge_factor;\n\tto->rc_quant_incr_limit1     = from->rc_quant_incr_limit1;\n\tto->rc_quant_incr_limit0     = from->rc_quant_incr_limit0;\n\tto->initial_xmit_delay       = from->initial_xmit_delay;\n\tto->initial_dec_delay        = from->initial_dec_delay;\n\tto->block_pred_enable        = from->block_pred_enable;\n\tto->first_line_bpg_offset    = from->first_line_bpg_offset;\n\tto->second_line_bpg_offset   = from->second_line_bpg_offset;\n\tto->initial_offset           = from->initial_offset;\n\tmemcpy(&to->rc_buf_thresh, &from->rc_buf_thresh, sizeof(from->rc_buf_thresh));\n\tmemcpy(&to->rc_range_params, &from->rc_range_params, sizeof(from->rc_range_params));\n\tto->rc_model_size            = from->rc_model_size;\n\tto->flatness_min_qp          = from->flatness_min_qp;\n\tto->flatness_max_qp          = from->flatness_max_qp;\n\tto->initial_scale_value      = from->initial_scale_value;\n\tto->scale_decrement_interval = from->scale_decrement_interval;\n\tto->scale_increment_interval = from->scale_increment_interval;\n\tto->nfl_bpg_offset           = from->nfl_bpg_offset;\n\tto->nsl_bpg_offset           = from->nsl_bpg_offset;\n\tto->slice_bpg_offset         = from->slice_bpg_offset;\n\tto->final_offset             = from->final_offset;\n\tto->vbr_enable               = from->vbr_enable;\n\tto->slice_chunk_size         = from->slice_chunk_size;\n\tto->second_line_offset_adj   = from->second_line_offset_adj;\n\tto->dsc_version_minor        = from->dsc_version_minor;\n}\n\nstatic void copy_rc_to_cfg(struct drm_dsc_config *dsc_cfg, const struct rc_params *rc)\n{\n\tint i;\n\n\tdsc_cfg->rc_quant_incr_limit0   = rc->rc_quant_incr_limit0;\n\tdsc_cfg->rc_quant_incr_limit1   = rc->rc_quant_incr_limit1;\n\tdsc_cfg->initial_offset         = rc->initial_fullness_offset;\n\tdsc_cfg->initial_xmit_delay     = rc->initial_xmit_delay;\n\tdsc_cfg->first_line_bpg_offset  = rc->first_line_bpg_offset;\n\tdsc_cfg->second_line_bpg_offset = rc->second_line_bpg_offset;\n\tdsc_cfg->flatness_min_qp        = rc->flatness_min_qp;\n\tdsc_cfg->flatness_max_qp        = rc->flatness_max_qp;\n\tfor (i = 0; i < QP_SET_SIZE; ++i) {\n\t\tdsc_cfg->rc_range_params[i].range_min_qp     = rc->qp_min[i];\n\t\tdsc_cfg->rc_range_params[i].range_max_qp     = rc->qp_max[i];\n\t\t \n\t\tdsc_cfg->rc_range_params[i].range_bpg_offset = 0x3f & rc->ofs[i];\n\t}\n\tdsc_cfg->rc_model_size    = rc->rc_model_size;\n\tdsc_cfg->rc_edge_factor   = rc->rc_edge_factor;\n\tdsc_cfg->rc_tgt_offset_high = rc->rc_tgt_offset_hi;\n\tdsc_cfg->rc_tgt_offset_low = rc->rc_tgt_offset_lo;\n\n\tfor (i = 0; i < QP_SET_SIZE - 1; ++i)\n\t\tdsc_cfg->rc_buf_thresh[i] = rc->rc_buf_thresh[i];\n}\n\nint dscc_compute_dsc_parameters(const struct drm_dsc_config *pps,\n\t\tconst struct rc_params *rc,\n\t\tstruct dsc_parameters *dsc_params)\n{\n\tint              ret;\n\tstruct drm_dsc_config   dsc_cfg;\n\tunsigned long long tmp;\n\n\tdsc_params->pps = *pps;\n\tdsc_params->pps.initial_scale_value = 8 * rc->rc_model_size / (rc->rc_model_size - rc->initial_fullness_offset);\n\n\tcopy_pps_fields(&dsc_cfg, &dsc_params->pps);\n\tcopy_rc_to_cfg(&dsc_cfg, rc);\n\n\tdsc_cfg.mux_word_size = dsc_params->pps.bits_per_component <= 10 ? 48 : 64;\n\n\tret = drm_dsc_compute_rc_parameters(&dsc_cfg);\n\ttmp = (unsigned long long)dsc_cfg.slice_chunk_size * 0x10000000 + (dsc_cfg.slice_width - 1);\n\tdo_div(tmp, (uint32_t)dsc_cfg.slice_width);  \n\tdsc_params->bytes_per_pixel = (uint32_t)tmp;\n\n\tcopy_pps_fields(&dsc_params->pps, &dsc_cfg);\n\tdsc_params->rc_buffer_model_size = dsc_cfg.rc_bits;\n\treturn ret;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}