{
  "module_name": "dcn30_clk_mgr_smu_msg.c",
  "hash_id": "81b0447bc38afda36f8fdfc905081e24288aa0b02cd85128200b1cd128f6d1a9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn30/dcn30_clk_mgr_smu_msg.c",
  "human_readable_source": " \n\n#include <linux/delay.h>\n#include \"dcn30_clk_mgr_smu_msg.h\"\n\n#include \"clk_mgr_internal.h\"\n#include \"reg_helper.h\"\n#include \"dm_helpers.h\"\n\n#include \"dalsmc.h\"\n#include \"dcn30_smu11_driver_if.h\"\n\n#define mmDAL_MSG_REG  0x1628A\n#define mmDAL_ARG_REG  0x16273\n#define mmDAL_RESP_REG 0x16274\n\n#define REG(reg_name) \\\n\tmm ## reg_name\n\n#include \"logger_types.h\"\n#undef DC_LOGGER\n#define DC_LOGGER \\\n\tCTX->logger\n#define smu_print(str, ...) {DC_LOG_SMU(str, ##__VA_ARGS__); }\n\n\n \nstatic uint32_t dcn30_smu_wait_for_response(struct clk_mgr_internal *clk_mgr, unsigned int delay_us, unsigned int max_retries)\n{\n\tuint32_t reg = 0;\n\n\tdo {\n\t\treg = REG_READ(DAL_RESP_REG);\n\t\tif (reg)\n\t\t\tbreak;\n\n\t\tif (delay_us >= 1000)\n\t\t\tmsleep(delay_us/1000);\n\t\telse if (delay_us > 0)\n\t\t\tudelay(delay_us);\n\t} while (max_retries--);\n\n\t \n\n\t \n\n\treturn reg;\n}\n\nstatic bool dcn30_smu_send_msg_with_param(struct clk_mgr_internal *clk_mgr, uint32_t msg_id, uint32_t param_in, uint32_t *param_out)\n{\n\tuint32_t result;\n\t \n\tdcn30_smu_wait_for_response(clk_mgr, 10, 200000);\n\n\t \n\tREG_WRITE(DAL_RESP_REG, 0);\n\n\t \n\tREG_WRITE(DAL_ARG_REG, param_in);\n\n\t \n\tREG_WRITE(DAL_MSG_REG, msg_id);\n\n\tresult = dcn30_smu_wait_for_response(clk_mgr, 10, 200000);\n\n\tif (IS_SMU_TIMEOUT(result)) {\n\t\tdm_helpers_smu_timeout(CTX, msg_id, param_in, 10 * 200000);\n\t}\n\n\t \n\tif (result == DALSMC_Result_OK) {\n\t\tif (param_out)\n\t\t\t*param_out = REG_READ(DAL_ARG_REG);\n\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n \nbool dcn30_smu_test_message(struct clk_mgr_internal *clk_mgr, uint32_t input)\n{\n\tuint32_t response = 0;\n\n\tsmu_print(\"SMU Test message: %d\\n\", input);\n\n\tif (dcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_TestMessage, input, &response))\n\t\tif (response == input + 1)\n\t\t\treturn true;\n\n\treturn false;\n}\n\nbool dcn30_smu_get_smu_version(struct clk_mgr_internal *clk_mgr, unsigned int *version)\n{\n\tsmu_print(\"SMU Get SMU version\\n\");\n\n\tif (dcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_GetSmuVersion, 0, version)) {\n\n\t\tsmu_print(\"SMU version: %d\\n\", *version);\n\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n \nbool dcn30_smu_check_driver_if_version(struct clk_mgr_internal *clk_mgr)\n{\n\tuint32_t response = 0;\n\n\tsmu_print(\"SMU Check driver if version\\n\");\n\n\tif (dcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_GetDriverIfVersion, 0, &response)) {\n\n\t\tsmu_print(\"SMU driver if version: %d\\n\", response);\n\n\t\tif (response == SMU11_DRIVER_IF_VERSION)\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n \nbool dcn30_smu_check_msg_header_version(struct clk_mgr_internal *clk_mgr)\n{\n\tuint32_t response = 0;\n\n\tsmu_print(\"SMU Check msg header version\\n\");\n\n\tif (dcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_GetMsgHeaderVersion, 0, &response)) {\n\n\t\tsmu_print(\"SMU msg header version: %d\\n\", response);\n\n\t\tif (response == DALSMC_VERSION)\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nvoid dcn30_smu_set_dram_addr_high(struct clk_mgr_internal *clk_mgr, uint32_t addr_high)\n{\n\tsmu_print(\"SMU Set DRAM addr high: %d\\n\", addr_high);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_SetDalDramAddrHigh, addr_high, NULL);\n}\n\nvoid dcn30_smu_set_dram_addr_low(struct clk_mgr_internal *clk_mgr, uint32_t addr_low)\n{\n\tsmu_print(\"SMU Set DRAM addr low: %d\\n\", addr_low);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_SetDalDramAddrLow, addr_low, NULL);\n}\n\nvoid dcn30_smu_transfer_wm_table_smu_2_dram(struct clk_mgr_internal *clk_mgr)\n{\n\tsmu_print(\"SMU Transfer WM table SMU 2 DRAM\\n\");\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_TransferTableSmu2Dram, TABLE_WATERMARKS, NULL);\n}\n\nvoid dcn30_smu_transfer_wm_table_dram_2_smu(struct clk_mgr_internal *clk_mgr)\n{\n\tsmu_print(\"SMU Transfer WM table DRAM 2 SMU\\n\");\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_TransferTableDram2Smu, TABLE_WATERMARKS, NULL);\n}\n\n \nunsigned int dcn30_smu_set_hard_min_by_freq(struct clk_mgr_internal *clk_mgr, uint32_t clk, uint16_t freq_mhz)\n{\n\tuint32_t response = 0;\n\n\t \n\tuint32_t param = (clk << 16) | freq_mhz;\n\n\tsmu_print(\"SMU Set hard min by freq: clk = %d, freq_mhz = %d MHz\\n\", clk, freq_mhz);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_SetHardMinByFreq, param, &response);\n\n\tsmu_print(\"SMU Frequency set = %d MHz\\n\", response);\n\n\treturn response;\n}\n\n \nunsigned int dcn30_smu_set_hard_max_by_freq(struct clk_mgr_internal *clk_mgr, uint32_t clk, uint16_t freq_mhz)\n{\n\tuint32_t response = 0;\n\n\t \n\tuint32_t param = (clk << 16) | freq_mhz;\n\n\tsmu_print(\"SMU Set hard max by freq: clk = %d, freq_mhz = %d MHz\\n\", clk, freq_mhz);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_SetHardMaxByFreq, param, &response);\n\n\tsmu_print(\"SMU Frequency set = %d MHz\\n\", response);\n\n\treturn response;\n}\n\n \nunsigned int dcn30_smu_get_dpm_freq_by_index(struct clk_mgr_internal *clk_mgr, uint32_t clk, uint8_t dpm_level)\n{\n\tuint32_t response = 0;\n\n\t \n\tuint32_t param = (clk << 16) | dpm_level;\n\n\tsmu_print(\"SMU Get dpm freq by index: clk = %d, dpm_level = %d\\n\", clk, dpm_level);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_GetDpmFreqByIndex, param, &response);\n\n\tsmu_print(\"SMU dpm freq: %d MHz\\n\", response);\n\n\treturn response;\n}\n\n \nunsigned int dcn30_smu_get_dc_mode_max_dpm_freq(struct clk_mgr_internal *clk_mgr, uint32_t clk)\n{\n\tuint32_t response = 0;\n\n\t \n\tuint32_t param = clk << 16;\n\n\tsmu_print(\"SMU Get DC mode max DPM freq: clk = %d\\n\", clk);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_GetDcModeMaxDpmFreq, param, &response);\n\n\tsmu_print(\"SMU DC mode max DMP freq: %d MHz\\n\", response);\n\n\treturn response;\n}\n\nvoid dcn30_smu_set_min_deep_sleep_dcef_clk(struct clk_mgr_internal *clk_mgr, uint32_t freq_mhz)\n{\n\tsmu_print(\"SMU Set min deep sleep dcef clk: freq_mhz = %d MHz\\n\", freq_mhz);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_SetMinDeepSleepDcefclk, freq_mhz, NULL);\n}\n\nvoid dcn30_smu_set_num_of_displays(struct clk_mgr_internal *clk_mgr, uint32_t num_displays)\n{\n\tsmu_print(\"SMU Set num of displays: num_displays = %d\\n\", num_displays);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_NumOfDisplays, num_displays, NULL);\n}\n\nvoid dcn30_smu_set_display_refresh_from_mall(struct clk_mgr_internal *clk_mgr, bool enable, uint8_t cache_timer_delay, uint8_t cache_timer_scale)\n{\n\t \n\tuint32_t param = (cache_timer_scale << 7) | (cache_timer_delay << 1) | (enable ? 1 : 0);\n\n\tsmu_print(\"SMU Set display refresh from mall: enable = %d, cache_timer_delay = %d, cache_timer_scale = %d\\n\",\n\t\tenable, cache_timer_delay, cache_timer_scale);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_SetDisplayRefreshFromMall, param, NULL);\n}\n\nvoid dcn30_smu_set_external_client_df_cstate_allow(struct clk_mgr_internal *clk_mgr, bool enable)\n{\n\tsmu_print(\"SMU Set external client df cstate allow: enable = %d\\n\", enable);\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\t\t\tDALSMC_MSG_SetExternalClientDfCstateAllow, enable ? 1 : 0, NULL);\n}\n\nvoid dcn30_smu_set_pme_workaround(struct clk_mgr_internal *clk_mgr)\n{\n\tsmu_print(\"SMU Set PME workaround\\n\");\n\n\tdcn30_smu_send_msg_with_param(clk_mgr,\n\tDALSMC_MSG_BacoAudioD3PME, 0, NULL);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}