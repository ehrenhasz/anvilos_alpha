{
  "module_name": "dcn31_panel_cntl.c",
  "hash_id": "748dced693dd7cf33978cee1bae28543759004be7f45002d4f85c46694ba425a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn31/dcn31_panel_cntl.c",
  "human_readable_source": " \n\n#include \"reg_helper.h\"\n#include \"core_types.h\"\n#include \"dc_dmub_srv.h\"\n#include \"dcn31_panel_cntl.h\"\n#include \"atom.h\"\n\n#define TO_DCN31_PANEL_CNTL(panel_cntl)\\\n\tcontainer_of(panel_cntl, struct dcn31_panel_cntl, base)\n\n#define CTX \\\n\tdcn31_panel_cntl->base.ctx\n\n#define DC_LOGGER \\\n\tdcn31_panel_cntl->base.ctx->logger\n\nstatic bool dcn31_query_backlight_info(struct panel_cntl *panel_cntl, union dmub_rb_cmd *cmd)\n{\n\tstruct dcn31_panel_cntl *dcn31_panel_cntl = TO_DCN31_PANEL_CNTL(panel_cntl);\n\tstruct dc_dmub_srv *dc_dmub_srv = panel_cntl->ctx->dmub_srv;\n\n\tif (!dc_dmub_srv)\n\t\treturn false;\n\n\tmemset(cmd, 0, sizeof(*cmd));\n\tcmd->panel_cntl.header.type = DMUB_CMD__PANEL_CNTL;\n\tcmd->panel_cntl.header.sub_type = DMUB_CMD__PANEL_CNTL_QUERY_BACKLIGHT_INFO;\n\tcmd->panel_cntl.header.payload_bytes = sizeof(cmd->panel_cntl.data);\n\tcmd->panel_cntl.data.pwrseq_inst = dcn31_panel_cntl->base.pwrseq_inst;\n\n\treturn dm_execute_dmub_cmd(dc_dmub_srv->ctx, cmd, DM_DMUB_WAIT_TYPE_WAIT_WITH_REPLY);\n}\n\nstatic uint32_t dcn31_get_16_bit_backlight_from_pwm(struct panel_cntl *panel_cntl)\n{\n\tunion dmub_rb_cmd cmd;\n\n\tif (!dcn31_query_backlight_info(panel_cntl, &cmd))\n\t\treturn 0;\n\n\treturn cmd.panel_cntl.data.current_backlight;\n}\n\nstatic uint32_t dcn31_panel_cntl_hw_init(struct panel_cntl *panel_cntl)\n{\n\tstruct dcn31_panel_cntl *dcn31_panel_cntl = TO_DCN31_PANEL_CNTL(panel_cntl);\n\tstruct dc_dmub_srv *dc_dmub_srv = panel_cntl->ctx->dmub_srv;\n\tunion dmub_rb_cmd cmd;\n\n\tif (!dc_dmub_srv)\n\t\treturn 0;\n\n\tmemset(&cmd, 0, sizeof(cmd));\n\tcmd.panel_cntl.header.type = DMUB_CMD__PANEL_CNTL;\n\tcmd.panel_cntl.header.sub_type = DMUB_CMD__PANEL_CNTL_HW_INIT;\n\tcmd.panel_cntl.header.payload_bytes = sizeof(cmd.panel_cntl.data);\n\tcmd.panel_cntl.data.pwrseq_inst = dcn31_panel_cntl->base.pwrseq_inst;\n\tcmd.panel_cntl.data.bl_pwm_cntl = panel_cntl->stored_backlight_registers.BL_PWM_CNTL;\n\tcmd.panel_cntl.data.bl_pwm_period_cntl = panel_cntl->stored_backlight_registers.BL_PWM_PERIOD_CNTL;\n\tcmd.panel_cntl.data.bl_pwm_ref_div1 =\n\t\tpanel_cntl->stored_backlight_registers.LVTMA_PWRSEQ_REF_DIV_BL_PWM_REF_DIV;\n\tcmd.panel_cntl.data.bl_pwm_ref_div2 =\n\t\tpanel_cntl->stored_backlight_registers.PANEL_PWRSEQ_REF_DIV2;\n\tif (!dm_execute_dmub_cmd(dc_dmub_srv->ctx, &cmd, DM_DMUB_WAIT_TYPE_WAIT_WITH_REPLY))\n\t\treturn 0;\n\n\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL = cmd.panel_cntl.data.bl_pwm_cntl;\n\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL2 = 0;  \n\tpanel_cntl->stored_backlight_registers.BL_PWM_PERIOD_CNTL = cmd.panel_cntl.data.bl_pwm_period_cntl;\n\tpanel_cntl->stored_backlight_registers.LVTMA_PWRSEQ_REF_DIV_BL_PWM_REF_DIV =\n\t\tcmd.panel_cntl.data.bl_pwm_ref_div1;\n\tpanel_cntl->stored_backlight_registers.PANEL_PWRSEQ_REF_DIV2 =\n\t\tcmd.panel_cntl.data.bl_pwm_ref_div2;\n\n\treturn cmd.panel_cntl.data.current_backlight;\n}\n\nstatic void dcn31_panel_cntl_destroy(struct panel_cntl **panel_cntl)\n{\n\tstruct dcn31_panel_cntl *dcn31_panel_cntl = TO_DCN31_PANEL_CNTL(*panel_cntl);\n\n\tkfree(dcn31_panel_cntl);\n\t*panel_cntl = NULL;\n}\n\nstatic bool dcn31_is_panel_backlight_on(struct panel_cntl *panel_cntl)\n{\n\tunion dmub_rb_cmd cmd;\n\n\tif (!dcn31_query_backlight_info(panel_cntl, &cmd))\n\t\treturn false;\n\n\treturn cmd.panel_cntl.data.is_backlight_on;\n}\n\nstatic bool dcn31_is_panel_powered_on(struct panel_cntl *panel_cntl)\n{\n\tunion dmub_rb_cmd cmd;\n\n\tif (!dcn31_query_backlight_info(panel_cntl, &cmd))\n\t\treturn false;\n\n\treturn cmd.panel_cntl.data.is_powered_on;\n}\n\nstatic void dcn31_store_backlight_level(struct panel_cntl *panel_cntl)\n{\n\tunion dmub_rb_cmd cmd;\n\n\tif (!dcn31_query_backlight_info(panel_cntl, &cmd))\n\t\treturn;\n\n\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL = cmd.panel_cntl.data.bl_pwm_cntl;\n\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL2 = 0;  \n\tpanel_cntl->stored_backlight_registers.BL_PWM_PERIOD_CNTL = cmd.panel_cntl.data.bl_pwm_period_cntl;\n\tpanel_cntl->stored_backlight_registers.LVTMA_PWRSEQ_REF_DIV_BL_PWM_REF_DIV =\n\t\tcmd.panel_cntl.data.bl_pwm_ref_div1;\n}\n\nstatic const struct panel_cntl_funcs dcn31_link_panel_cntl_funcs = {\n\t.destroy = dcn31_panel_cntl_destroy,\n\t.hw_init = dcn31_panel_cntl_hw_init,\n\t.is_panel_backlight_on = dcn31_is_panel_backlight_on,\n\t.is_panel_powered_on = dcn31_is_panel_powered_on,\n\t.store_backlight_level = dcn31_store_backlight_level,\n\t.get_current_backlight = dcn31_get_16_bit_backlight_from_pwm,\n};\n\nvoid dcn31_panel_cntl_construct(\n\tstruct dcn31_panel_cntl *dcn31_panel_cntl,\n\tconst struct panel_cntl_init_data *init_data)\n{\n\tdcn31_panel_cntl->base.funcs = &dcn31_link_panel_cntl_funcs;\n\tdcn31_panel_cntl->base.ctx = init_data->ctx;\n\tdcn31_panel_cntl->base.inst = init_data->inst;\n\tdcn31_panel_cntl->base.pwrseq_inst = init_data->pwrseq_inst;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}