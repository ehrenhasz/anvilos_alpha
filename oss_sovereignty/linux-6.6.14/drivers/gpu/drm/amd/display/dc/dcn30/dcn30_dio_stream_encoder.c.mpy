{
  "module_name": "dcn30_dio_stream_encoder.c",
  "hash_id": "e9967fb37e5486e219f457c7b03fa988860b13e7a6345d64b5ddc67bc21ddbbd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn30/dcn30_dio_stream_encoder.c",
  "human_readable_source": " \n\n\n#include \"dc_bios_types.h\"\n#include \"dcn30_dio_stream_encoder.h\"\n#include \"reg_helper.h\"\n#include \"hw_shared.h\"\n#include \"dc.h\"\n#include \"core_types.h\"\n#include <linux/delay.h>\n\n\n#define DC_LOGGER \\\n\t\tenc1->base.ctx->logger\n\n#define REG(reg)\\\n\t(enc1->regs->reg)\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\tenc1->se_shift->field_name, enc1->se_mask->field_name\n\n#define VBI_LINE_0 0\n#define HDMI_CLOCK_CHANNEL_RATE_MORE_340M 340000\n\n#define CTX \\\n\tenc1->base.ctx\n\n\nstatic void enc3_update_hdmi_info_packet(\n\tstruct dcn10_stream_encoder *enc1,\n\tuint32_t packet_index,\n\tconst struct dc_info_packet *info_packet)\n{\n\tuint32_t cont, send, line;\n\n\tif (info_packet->valid) {\n\t\tenc1->base.vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc1->base.vpg,\n\t\t\t\tpacket_index,\n\t\t\t\tinfo_packet,\n\t\t\t\ttrue);\n\n\t\t \n\t\tcont = 1;\n\t\t \n\t\tsend = 1;\n\t\t \n\t\tline = 2;\n\t} else {\n\t\tcont = 0;\n\t\tsend = 0;\n\t\tline = 0;\n\t}\n\n\t \n\n\t \n\tswitch (packet_index) {\n\tcase 0:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL0,\n\t\t\t\tHDMI_GENERIC0_CONT, cont,\n\t\t\t\tHDMI_GENERIC0_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL1,\n\t\t\t\tHDMI_GENERIC0_LINE, line);\n\t\tbreak;\n\tcase 1:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL0,\n\t\t\t\tHDMI_GENERIC1_CONT, cont,\n\t\t\t\tHDMI_GENERIC1_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL1,\n\t\t\t\tHDMI_GENERIC1_LINE, line);\n\t\tbreak;\n\tcase 2:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL0,\n\t\t\t\tHDMI_GENERIC2_CONT, cont,\n\t\t\t\tHDMI_GENERIC2_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL2,\n\t\t\t\tHDMI_GENERIC2_LINE, line);\n\t\tbreak;\n\tcase 3:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL0,\n\t\t\t\tHDMI_GENERIC3_CONT, cont,\n\t\t\t\tHDMI_GENERIC3_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL2,\n\t\t\t\tHDMI_GENERIC3_LINE, line);\n\t\tbreak;\n\tcase 4:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL0,\n\t\t\t\tHDMI_GENERIC4_CONT, cont,\n\t\t\t\tHDMI_GENERIC4_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL3,\n\t\t\t\tHDMI_GENERIC4_LINE, line);\n\t\tbreak;\n\tcase 5:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL0,\n\t\t\t\tHDMI_GENERIC5_CONT, cont,\n\t\t\t\tHDMI_GENERIC5_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL3,\n\t\t\t\tHDMI_GENERIC5_LINE, line);\n\t\tbreak;\n\tcase 6:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL0,\n\t\t\t\tHDMI_GENERIC6_CONT, cont,\n\t\t\t\tHDMI_GENERIC6_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL4,\n\t\t\t\tHDMI_GENERIC6_LINE, line);\n\t\tbreak;\n\tcase 7:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL0,\n\t\t\t\tHDMI_GENERIC7_CONT, cont,\n\t\t\t\tHDMI_GENERIC7_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL4,\n\t\t\t\tHDMI_GENERIC7_LINE, line);\n\t\tbreak;\n\tcase 8:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL6,\n\t\t\t\tHDMI_GENERIC8_CONT, cont,\n\t\t\t\tHDMI_GENERIC8_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL7,\n\t\t\t\tHDMI_GENERIC8_LINE, line);\n\t\tbreak;\n\tcase 9:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL6,\n\t\t\t\tHDMI_GENERIC9_CONT, cont,\n\t\t\t\tHDMI_GENERIC9_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL7,\n\t\t\t\tHDMI_GENERIC9_LINE, line);\n\t\tbreak;\n\tcase 10:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL6,\n\t\t\t\tHDMI_GENERIC10_CONT, cont,\n\t\t\t\tHDMI_GENERIC10_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL8,\n\t\t\t\tHDMI_GENERIC10_LINE, line);\n\t\tbreak;\n\tcase 11:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL6,\n\t\t\t\tHDMI_GENERIC11_CONT, cont,\n\t\t\t\tHDMI_GENERIC11_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL8,\n\t\t\t\tHDMI_GENERIC11_LINE, line);\n\t\tbreak;\n\tcase 12:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL6,\n\t\t\t\tHDMI_GENERIC12_CONT, cont,\n\t\t\t\tHDMI_GENERIC12_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL9,\n\t\t\t\tHDMI_GENERIC12_LINE, line);\n\t\tbreak;\n\tcase 13:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL6,\n\t\t\t\tHDMI_GENERIC13_CONT, cont,\n\t\t\t\tHDMI_GENERIC13_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL9,\n\t\t\t\tHDMI_GENERIC13_LINE, line);\n\t\tbreak;\n\tcase 14:\n\t\tREG_UPDATE_2(HDMI_GENERIC_PACKET_CONTROL6,\n\t\t\t\tHDMI_GENERIC14_CONT, cont,\n\t\t\t\tHDMI_GENERIC14_SEND, send);\n\t\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL10,\n\t\t\t\tHDMI_GENERIC14_LINE, line);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tDC_LOG_WARNING(\n\t\t\t\"Invalid HW packet index: %s()\\n\",\n\t\t\t__func__);\n\t\treturn;\n\t}\n}\n\nvoid enc3_stream_encoder_update_hdmi_info_packets(\n\tstruct stream_encoder *enc,\n\tconst struct encoder_info_frame *info_frame)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\t \n\tREG_UPDATE(HDMI_DB_CONTROL, HDMI_DB_DISABLE, 1);\n\tREG_UPDATE(AFMT_CNTL, AFMT_AUDIO_CLOCK_EN, 1);\n\n\t \n\tenc3_update_hdmi_info_packet(enc1, 0, &info_frame->avi);\n\tenc3_update_hdmi_info_packet(enc1, 5, &info_frame->hfvsif);\n\tenc3_update_hdmi_info_packet(enc1, 2, &info_frame->gamut);\n\tenc3_update_hdmi_info_packet(enc1, 1, &info_frame->vendor);\n\tenc3_update_hdmi_info_packet(enc1, 3, &info_frame->spd);\n\tenc3_update_hdmi_info_packet(enc1, 4, &info_frame->hdrsmd);\n\tenc3_update_hdmi_info_packet(enc1, 6, &info_frame->vtem);\n}\n\nvoid enc3_stream_encoder_stop_hdmi_info_packets(\n\tstruct stream_encoder *enc)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\t \n\tREG_SET_4(HDMI_GENERIC_PACKET_CONTROL0, 0,\n\t\tHDMI_GENERIC0_CONT, 0,\n\t\tHDMI_GENERIC0_SEND, 0,\n\t\tHDMI_GENERIC1_CONT, 0,\n\t\tHDMI_GENERIC1_SEND, 0);\n\tREG_SET_2(HDMI_GENERIC_PACKET_CONTROL1, 0,\n\t\tHDMI_GENERIC0_LINE, 0,\n\t\tHDMI_GENERIC1_LINE, 0);\n\n\t \n\tREG_SET_4(HDMI_GENERIC_PACKET_CONTROL0, 0,\n\t\tHDMI_GENERIC2_CONT, 0,\n\t\tHDMI_GENERIC2_SEND, 0,\n\t\tHDMI_GENERIC3_CONT, 0,\n\t\tHDMI_GENERIC3_SEND, 0);\n\tREG_SET_2(HDMI_GENERIC_PACKET_CONTROL2, 0,\n\t\tHDMI_GENERIC2_LINE, 0,\n\t\tHDMI_GENERIC3_LINE, 0);\n\n\t \n\tREG_SET_4(HDMI_GENERIC_PACKET_CONTROL0, 0,\n\t\tHDMI_GENERIC4_CONT, 0,\n\t\tHDMI_GENERIC4_SEND, 0,\n\t\tHDMI_GENERIC5_CONT, 0,\n\t\tHDMI_GENERIC5_SEND, 0);\n\tREG_SET_2(HDMI_GENERIC_PACKET_CONTROL3, 0,\n\t\tHDMI_GENERIC4_LINE, 0,\n\t\tHDMI_GENERIC5_LINE, 0);\n\n\t \n\tREG_SET_4(HDMI_GENERIC_PACKET_CONTROL0, 0,\n\t\tHDMI_GENERIC6_CONT, 0,\n\t\tHDMI_GENERIC6_SEND, 0,\n\t\tHDMI_GENERIC7_CONT, 0,\n\t\tHDMI_GENERIC7_SEND, 0);\n\tREG_SET_2(HDMI_GENERIC_PACKET_CONTROL4, 0,\n\t\tHDMI_GENERIC6_LINE, 0,\n\t\tHDMI_GENERIC7_LINE, 0);\n\n\t \n\tREG_SET_4(HDMI_GENERIC_PACKET_CONTROL6, 0,\n\t\tHDMI_GENERIC8_CONT, 0,\n\t\tHDMI_GENERIC8_SEND, 0,\n\t\tHDMI_GENERIC9_CONT, 0,\n\t\tHDMI_GENERIC9_SEND, 0);\n\tREG_SET_2(HDMI_GENERIC_PACKET_CONTROL7, 0,\n\t\tHDMI_GENERIC8_LINE, 0,\n\t\tHDMI_GENERIC9_LINE, 0);\n\n\t \n\tREG_SET_4(HDMI_GENERIC_PACKET_CONTROL6, 0,\n\t\tHDMI_GENERIC10_CONT, 0,\n\t\tHDMI_GENERIC10_SEND, 0,\n\t\tHDMI_GENERIC11_CONT, 0,\n\t\tHDMI_GENERIC11_SEND, 0);\n\tREG_SET_2(HDMI_GENERIC_PACKET_CONTROL8, 0,\n\t\tHDMI_GENERIC10_LINE, 0,\n\t\tHDMI_GENERIC11_LINE, 0);\n\n\t \n\tREG_SET_4(HDMI_GENERIC_PACKET_CONTROL6, 0,\n\t\tHDMI_GENERIC12_CONT, 0,\n\t\tHDMI_GENERIC12_SEND, 0,\n\t\tHDMI_GENERIC13_CONT, 0,\n\t\tHDMI_GENERIC13_SEND, 0);\n\tREG_SET_2(HDMI_GENERIC_PACKET_CONTROL9, 0,\n\t\tHDMI_GENERIC12_LINE, 0,\n\t\tHDMI_GENERIC13_LINE, 0);\n\n\t \n\tREG_SET_2(HDMI_GENERIC_PACKET_CONTROL6, 0,\n\t\tHDMI_GENERIC14_CONT, 0,\n\t\tHDMI_GENERIC14_SEND, 0);\n\tREG_UPDATE(HDMI_GENERIC_PACKET_CONTROL10,\n\t\tHDMI_GENERIC14_LINE, 0);\n}\n\n \nstatic void enc3_dp_set_dsc_config(struct stream_encoder *enc,\n\t\t\t\t\tenum optc_dsc_mode dsc_mode,\n\t\t\t\t\tuint32_t dsc_bytes_per_pixel,\n\t\t\t\t\tuint32_t dsc_slice_width)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\tREG_UPDATE_2(DP_DSC_CNTL,\n\t\t\tDP_DSC_MODE, dsc_mode,\n\t\t\tDP_DSC_SLICE_WIDTH, dsc_slice_width);\n\n\tREG_SET(DP_DSC_BYTES_PER_PIXEL, 0,\n\t\tDP_DSC_BYTES_PER_PIXEL, dsc_bytes_per_pixel);\n}\n\n\nvoid enc3_dp_set_dsc_pps_info_packet(struct stream_encoder *enc,\n\t\t\t\t\tbool enable,\n\t\t\t\t\tuint8_t *dsc_packed_pps,\n\t\t\t\t\tbool immediate_update)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\tif (enable) {\n\t\tstruct dc_info_packet pps_sdp;\n\t\tint i;\n\n\t\t \n\t\tREG_UPDATE(DP_SEC_CNTL2, DP_SEC_GSP11_PPS, 1);\n\n\t\t \n\t\tREG_UPDATE(AFMT_CNTL, AFMT_AUDIO_CLOCK_EN, 1);\n\n\t\t \n\t\tpps_sdp.valid = true;\n\t\tpps_sdp.hb0 = 0;\n\t\tpps_sdp.hb1 = DC_DP_INFOFRAME_TYPE_PPS;\n\t\tpps_sdp.hb2 = 127;\n\t\tpps_sdp.hb3 = 0;\n\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tmemcpy(pps_sdp.sb, &dsc_packed_pps[i * 32], 32);\n\t\t\tenc1->base.vpg->funcs->update_generic_info_packet(\n\t\t\t\t\t\t\tenc1->base.vpg,\n\t\t\t\t\t\t\t11 + i,\n\t\t\t\t\t\t\t&pps_sdp,\n\t\t\t\t\t\t\timmediate_update);\n\t\t}\n\n\t\t \n\t\tREG_UPDATE(DP_GSP11_CNTL,\n\t\t\t\tDP_SEC_GSP11_LINE_NUM, 2);\n\t\tREG_UPDATE_2(DP_MSA_VBID_MISC,\n\t\t\t\tDP_VBID6_LINE_REFERENCE, 0,\n\t\t\t\tDP_VBID6_LINE_NUM, 3);\n\n\t\t \n\t\tREG_UPDATE(DP_GSP11_CNTL,\n\t\t\tDP_SEC_GSP11_ENABLE, 1);\n\t\tREG_UPDATE(DP_SEC_CNTL,\n\t\t\tDP_SEC_STREAM_ENABLE, 1);\n\t} else {\n\t\t \n\t\tREG_UPDATE(DP_GSP11_CNTL, DP_SEC_GSP11_ENABLE, 0);\n\t\tREG_UPDATE(DP_SEC_CNTL2, DP_SEC_GSP11_PPS, 0);\n\t}\n}\n\n\n \nstatic void enc3_read_state(struct stream_encoder *enc, struct enc_state *s)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\t\n\tREG_GET(DP_DSC_CNTL, DP_DSC_MODE, &s->dsc_mode);\n\tif (s->dsc_mode) {\n\t\tREG_GET(DP_DSC_CNTL, DP_DSC_SLICE_WIDTH, &s->dsc_slice_width);\n\t\tREG_GET(DP_GSP11_CNTL, DP_SEC_GSP11_LINE_NUM, &s->sec_gsp_pps_line_num);\n\n\t\tREG_GET(DP_MSA_VBID_MISC, DP_VBID6_LINE_REFERENCE, &s->vbid6_line_reference);\n\t\tREG_GET(DP_MSA_VBID_MISC, DP_VBID6_LINE_NUM, &s->vbid6_line_num);\n\n\t\tREG_GET(DP_GSP11_CNTL, DP_SEC_GSP11_ENABLE, &s->sec_gsp_pps_enable);\n\t\tREG_GET(DP_SEC_CNTL, DP_SEC_STREAM_ENABLE, &s->sec_stream_enable);\n\t}\n}\n\nvoid enc3_stream_encoder_update_dp_info_packets_sdp_line_num(\n\t\tstruct stream_encoder *enc,\n\t\tstruct encoder_info_frame *info_frame)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\tif (info_frame->adaptive_sync.valid == true &&\n\t\tinfo_frame->sdp_line_num.adaptive_sync_line_num_valid == true) {\n\t\t\n\t\tREG_UPDATE(DP_SEC_CNTL1, DP_SEC_GSP5_LINE_REFERENCE, 1);\n\n\t\tREG_UPDATE(DP_SEC_CNTL5, DP_SEC_GSP5_LINE_NUM,\n\t\t\t\t\tinfo_frame->sdp_line_num.adaptive_sync_line_num);\n\t}\n}\n\nvoid enc3_stream_encoder_update_dp_info_packets(\n\tstruct stream_encoder *enc,\n\tconst struct encoder_info_frame *info_frame)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\tuint32_t value = 0;\n\tuint32_t dmdata_packet_enabled = 0;\n\n\tif (info_frame->vsc.valid) {\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t0,   \n\t\t\t\t&info_frame->vsc,\n\t\t\t\ttrue);\n\t}\n\t \n\tif (info_frame->vsc.valid) {\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t1,   \n\t\t\t\t&info_frame->vsc,\n\t\t\t\ttrue);\n\t}\n\t \n\tif (info_frame->vsc.valid) {\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t1,   \n\t\t\t\t&info_frame->vsc,\n\t\t\t\ttrue);\n\t}\n\tif (info_frame->spd.valid) {\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t2,   \n\t\t\t\t&info_frame->spd,\n\t\t\t\ttrue);\n\t}\n\tif (info_frame->hdrsmd.valid) {\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t3,   \n\t\t\t\t&info_frame->hdrsmd,\n\t\t\t\ttrue);\n\t}\n\t \n\n\tif (info_frame->adaptive_sync.valid)\n\t\tenc->vpg->funcs->update_generic_info_packet(\n\t\t\t\tenc->vpg,\n\t\t\t\t5,   \n\t\t\t\t&info_frame->adaptive_sync,\n\t\t\t\ttrue);\n\n\t \n\tREG_UPDATE(DP_SEC_CNTL, DP_SEC_GSP0_ENABLE, info_frame->vsc.valid);\n\tREG_UPDATE(DP_SEC_CNTL, DP_SEC_GSP2_ENABLE, info_frame->spd.valid);\n\tREG_UPDATE(DP_SEC_CNTL, DP_SEC_GSP3_ENABLE, info_frame->hdrsmd.valid);\n\tREG_UPDATE(DP_SEC_CNTL, DP_SEC_GSP5_ENABLE, info_frame->adaptive_sync.valid);\n\n\t \n\tvalue = REG_READ(DP_SEC_CNTL);\n\tif (value)\n\t\tREG_UPDATE(DP_SEC_CNTL, DP_SEC_STREAM_ENABLE, 1);\n\n\t \n\tREG_GET(DP_SEC_METADATA_TRANSMISSION,\n\t\t\tDP_SEC_METADATA_PACKET_ENABLE, &dmdata_packet_enabled);\n\n\tif (dmdata_packet_enabled)\n\t\tREG_UPDATE(DP_SEC_CNTL, DP_SEC_STREAM_ENABLE, 1);\n}\n\nstatic void enc3_dp_set_odm_combine(\n\tstruct stream_encoder *enc,\n\tbool odm_combine)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\tREG_UPDATE(DP_PIXEL_FORMAT, DP_PIXEL_COMBINE, odm_combine);\n}\n\n \nstatic void enc3_stream_encoder_dvi_set_stream_attribute(\n\tstruct stream_encoder *enc,\n\tstruct dc_crtc_timing *crtc_timing,\n\tbool is_dual_link)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\tif (!enc->ctx->dc->debug.avoid_vbios_exec_table) {\n\t\tstruct bp_encoder_control cntl = {0};\n\n\t\tcntl.action = ENCODER_CONTROL_SETUP;\n\t\tcntl.engine_id = enc1->base.id;\n\t\tcntl.signal = is_dual_link ?\n\t\t\tSIGNAL_TYPE_DVI_DUAL_LINK : SIGNAL_TYPE_DVI_SINGLE_LINK;\n\t\tcntl.enable_dp_audio = false;\n\t\tcntl.pixel_clock = crtc_timing->pix_clk_100hz / 10;\n\t\tcntl.lanes_number = (is_dual_link) ? LANE_COUNT_EIGHT : LANE_COUNT_FOUR;\n\n\t\tif (enc1->base.bp->funcs->encoder_control(\n\t\t\t\tenc1->base.bp, &cntl) != BP_RESULT_OK)\n\t\t\treturn;\n\n\t} else {\n\n\t\t\n\t\tREG_UPDATE(DIG_CLOCK_PATTERN, DIG_CLOCK_PATTERN, 0x1F);\n\n\t\t\n\n\t\t\n\n\t\t \n\t\tREG_UPDATE(DIG_FE_CNTL, DIG_START, 1);\n\t\tudelay(1);\n\n\t\t \n\t\tREG_UPDATE(DIG_FE_CNTL, DIG_START, 0);\n\t\tudelay(1);\n\t}\n\n\tASSERT(crtc_timing->pixel_encoding == PIXEL_ENCODING_RGB);\n\tASSERT(crtc_timing->display_color_depth == COLOR_DEPTH_888);\n\tenc1_stream_encoder_set_stream_attribute_helper(enc1, crtc_timing);\n}\n\n \nstatic void enc3_stream_encoder_hdmi_set_stream_attribute(\n\tstruct stream_encoder *enc,\n\tstruct dc_crtc_timing *crtc_timing,\n\tint actual_pix_clk_khz,\n\tbool enable_audio)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\tif (!enc->ctx->dc->debug.avoid_vbios_exec_table) {\n\t\tstruct bp_encoder_control cntl = {0};\n\n\t\tcntl.action = ENCODER_CONTROL_SETUP;\n\t\tcntl.engine_id = enc1->base.id;\n\t\tcntl.signal = SIGNAL_TYPE_HDMI_TYPE_A;\n\t\tcntl.enable_dp_audio = enable_audio;\n\t\tcntl.pixel_clock = actual_pix_clk_khz;\n\t\tcntl.lanes_number = LANE_COUNT_FOUR;\n\n\t\tif (enc1->base.bp->funcs->encoder_control(\n\t\t\t\tenc1->base.bp, &cntl) != BP_RESULT_OK)\n\t\t\treturn;\n\n\t} else {\n\n\t\t\n\t\tREG_UPDATE(DIG_CLOCK_PATTERN, DIG_CLOCK_PATTERN, 0x1F);\n\n\t\t\n\n\t\t\n\n\t\t \n\t\tREG_UPDATE(DIG_FE_CNTL, DIG_START, 1);\n\t\tudelay(1);\n\n\t\t \n\t\tREG_UPDATE(DIG_FE_CNTL, DIG_START, 0);\n\t\tudelay(1);\n\t}\n\n\t \n\tenc1_stream_encoder_set_stream_attribute_helper(enc1, crtc_timing);\n\n\t \n\tREG_UPDATE_6(HDMI_CONTROL,\n\t\tHDMI_PACKET_GEN_VERSION, 1,\n\t\tHDMI_KEEPOUT_MODE, 1,\n\t\tHDMI_DEEP_COLOR_ENABLE, 0,\n\t\tHDMI_DATA_SCRAMBLE_EN, 0,\n\t\tHDMI_NO_EXTRA_NULL_PACKET_FILLED, 1,\n\t\tHDMI_CLOCK_CHANNEL_RATE, 0);\n\n\t \n\tswitch (crtc_timing->display_color_depth) {\n\tcase COLOR_DEPTH_888:\n\t\tREG_UPDATE(HDMI_CONTROL, HDMI_DEEP_COLOR_DEPTH, 0);\n\t\tbreak;\n\tcase COLOR_DEPTH_101010:\n\t\tif (crtc_timing->pixel_encoding == PIXEL_ENCODING_YCBCR422) {\n\t\t\tREG_UPDATE_2(HDMI_CONTROL,\n\t\t\t\t\tHDMI_DEEP_COLOR_DEPTH, 1,\n\t\t\t\t\tHDMI_DEEP_COLOR_ENABLE, 0);\n\t\t} else {\n\t\t\tREG_UPDATE_2(HDMI_CONTROL,\n\t\t\t\t\tHDMI_DEEP_COLOR_DEPTH, 1,\n\t\t\t\t\tHDMI_DEEP_COLOR_ENABLE, 1);\n\t\t\t}\n\t\tbreak;\n\tcase COLOR_DEPTH_121212:\n\t\tif (crtc_timing->pixel_encoding == PIXEL_ENCODING_YCBCR422) {\n\t\t\tREG_UPDATE_2(HDMI_CONTROL,\n\t\t\t\t\tHDMI_DEEP_COLOR_DEPTH, 2,\n\t\t\t\t\tHDMI_DEEP_COLOR_ENABLE, 0);\n\t\t} else {\n\t\t\tREG_UPDATE_2(HDMI_CONTROL,\n\t\t\t\t\tHDMI_DEEP_COLOR_DEPTH, 2,\n\t\t\t\t\tHDMI_DEEP_COLOR_ENABLE, 1);\n\t\t\t}\n\t\tbreak;\n\tcase COLOR_DEPTH_161616:\n\t\tREG_UPDATE_2(HDMI_CONTROL,\n\t\t\t\tHDMI_DEEP_COLOR_DEPTH, 3,\n\t\t\t\tHDMI_DEEP_COLOR_ENABLE, 1);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (actual_pix_clk_khz >= HDMI_CLOCK_CHANNEL_RATE_MORE_340M) {\n\t\t \n\t\tREG_UPDATE_2(HDMI_CONTROL,\n\t\t\tHDMI_DATA_SCRAMBLE_EN, 1,\n\t\t\tHDMI_CLOCK_CHANNEL_RATE, 1);\n\t} else if (crtc_timing->flags.LTE_340MCSC_SCRAMBLE) {\n\n\t\t \n\n\t\t \n\t\tREG_UPDATE_2(HDMI_CONTROL,\n\t\t\tHDMI_DATA_SCRAMBLE_EN, 1,\n\t\t\tHDMI_CLOCK_CHANNEL_RATE, 0);\n\t}\n\n\n\t \n\tREG_UPDATE_3(HDMI_VBI_PACKET_CONTROL,\n\t\tHDMI_GC_CONT, 1,\n\t\tHDMI_GC_SEND, 1,\n\t\tHDMI_NULL_SEND, 1);\n\n\t \n\tREG_UPDATE(HDMI_VBI_PACKET_CONTROL, HDMI_ACP_SEND, 0);\n\n\t \n\t \n\tREG_UPDATE(HDMI_INFOFRAME_CONTROL0, HDMI_AUDIO_INFO_SEND, 1);\n\n\t \n\tASSERT (enc->afmt);\n\tenc->afmt->funcs->audio_info_immediate_update(enc->afmt);\n\n\t \n\tREG_UPDATE(HDMI_INFOFRAME_CONTROL1, HDMI_AUDIO_INFO_LINE,\n\t\t\t\tVBI_LINE_0 + 2);\n\n\t \n\tREG_UPDATE(HDMI_GC, HDMI_GC_AVMUTE, 0);\n}\n\nvoid enc3_audio_mute_control(\n\tstruct stream_encoder *enc,\n\tbool mute)\n{\n\tASSERT (enc->afmt);\n\tenc->afmt->funcs->audio_mute_control(enc->afmt, mute);\n}\n\nvoid enc3_se_dp_audio_setup(\n\tstruct stream_encoder *enc,\n\tunsigned int az_inst,\n\tstruct audio_info *info)\n{\n\tASSERT (enc->afmt);\n\tenc->afmt->funcs->se_audio_setup(enc->afmt, az_inst, info);\n}\n\n#define DP_SEC_AUD_N__DP_SEC_AUD_N__DEFAULT 0x8000\n#define DP_SEC_TIMESTAMP__DP_SEC_TIMESTAMP_MODE__AUTO_CALC 1\n\nstatic void enc3_se_setup_dp_audio(\n\tstruct stream_encoder *enc)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\t \n\n\t \n\tREG_SET(DP_SEC_AUD_N, 0,\n\t\t\tDP_SEC_AUD_N, DP_SEC_AUD_N__DP_SEC_AUD_N__DEFAULT);\n\n\t \n\tREG_SET(DP_SEC_TIMESTAMP, 0, DP_SEC_TIMESTAMP_MODE,\n\t\t\tDP_SEC_TIMESTAMP__DP_SEC_TIMESTAMP_MODE__AUTO_CALC);\n\n\tASSERT (enc->afmt);\n\tenc->afmt->funcs->setup_dp_audio(enc->afmt);\n}\n\nvoid enc3_se_dp_audio_enable(\n\tstruct stream_encoder *enc)\n{\n\tenc1_se_enable_audio_clock(enc, true);\n\tenc3_se_setup_dp_audio(enc);\n\tenc1_se_enable_dp_audio(enc);\n}\n\nstatic void enc3_se_setup_hdmi_audio(\n\tstruct stream_encoder *enc,\n\tconst struct audio_crtc_info *crtc_info)\n{\n\tstruct dcn10_stream_encoder *enc1 = DCN10STRENC_FROM_STRENC(enc);\n\n\tstruct audio_clock_info audio_clock_info = {0};\n\n\t \n\tASSERT (enc->afmt);\n\tenc->afmt->funcs->setup_hdmi_audio(enc->afmt);\n\n\t \n\tREG_UPDATE(HDMI_AUDIO_PACKET_CONTROL,\n\t\t\tHDMI_AUDIO_DELAY_EN, 1);\n\n\t \n\tREG_UPDATE_3(HDMI_ACR_PACKET_CONTROL,\n\t\t\tHDMI_ACR_AUTO_SEND, 1,\n\t\t\tHDMI_ACR_SOURCE, 0,\n\t\t\tHDMI_ACR_AUDIO_PRIORITY, 0);\n\n\t \n\tget_audio_clock_info(crtc_info->color_depth,\n\t\t\t     crtc_info->requested_pixel_clock_100Hz,\n\t\t\t     crtc_info->calculated_pixel_clock_100Hz,\n\t\t\t     &audio_clock_info);\n\tDC_LOG_HW_AUDIO(\n\t\t\t\"\\n%s:Input::requested_pixel_clock_100Hz = %d\"\t\\\n\t\t\t\"calculated_pixel_clock_100Hz = %d \\n\", __func__,\t\\\n\t\t\tcrtc_info->requested_pixel_clock_100Hz,\t\t\\\n\t\t\tcrtc_info->calculated_pixel_clock_100Hz);\n\n\t \n\tREG_UPDATE(HDMI_ACR_32_0, HDMI_ACR_CTS_32, audio_clock_info.cts_32khz);\n\n\t \n\tREG_UPDATE(HDMI_ACR_32_1, HDMI_ACR_N_32, audio_clock_info.n_32khz);\n\n\t \n\tREG_UPDATE(HDMI_ACR_44_0, HDMI_ACR_CTS_44, audio_clock_info.cts_44khz);\n\n\t \n\tREG_UPDATE(HDMI_ACR_44_1, HDMI_ACR_N_44, audio_clock_info.n_44khz);\n\n\t \n\tREG_UPDATE(HDMI_ACR_48_0, HDMI_ACR_CTS_48, audio_clock_info.cts_48khz);\n\n\t \n\tREG_UPDATE(HDMI_ACR_48_1, HDMI_ACR_N_48, audio_clock_info.n_48khz);\n\n\t \n}\n\nvoid enc3_se_hdmi_audio_setup(\n\tstruct stream_encoder *enc,\n\tunsigned int az_inst,\n\tstruct audio_info *info,\n\tstruct audio_crtc_info *audio_crtc_info)\n{\n\tenc1_se_enable_audio_clock(enc, true);\n\tenc3_se_setup_hdmi_audio(enc, audio_crtc_info);\n\tASSERT (enc->afmt);\n\tenc->afmt->funcs->se_audio_setup(enc->afmt, az_inst, info);\n}\n\n\nstatic const struct stream_encoder_funcs dcn30_str_enc_funcs = {\n\t.dp_set_odm_combine =\n\t\tenc3_dp_set_odm_combine,\n\t.dp_set_stream_attribute =\n\t\tenc2_stream_encoder_dp_set_stream_attribute,\n\t.hdmi_set_stream_attribute =\n\t\tenc3_stream_encoder_hdmi_set_stream_attribute,\n\t.dvi_set_stream_attribute =\n\t\tenc3_stream_encoder_dvi_set_stream_attribute,\n\t.set_throttled_vcp_size =\n\t\tenc1_stream_encoder_set_throttled_vcp_size,\n\t.update_hdmi_info_packets =\n\t\tenc3_stream_encoder_update_hdmi_info_packets,\n\t.stop_hdmi_info_packets =\n\t\tenc3_stream_encoder_stop_hdmi_info_packets,\n\t.update_dp_info_packets_sdp_line_num =\n\t\tenc3_stream_encoder_update_dp_info_packets_sdp_line_num,\n\t.update_dp_info_packets =\n\t\tenc3_stream_encoder_update_dp_info_packets,\n\t.stop_dp_info_packets =\n\t\tenc1_stream_encoder_stop_dp_info_packets,\n\t.dp_blank =\n\t\tenc1_stream_encoder_dp_blank,\n\t.dp_unblank =\n\t\tenc2_stream_encoder_dp_unblank,\n\t.audio_mute_control = enc3_audio_mute_control,\n\n\t.dp_audio_setup = enc3_se_dp_audio_setup,\n\t.dp_audio_enable = enc3_se_dp_audio_enable,\n\t.dp_audio_disable = enc1_se_dp_audio_disable,\n\n\t.hdmi_audio_setup = enc3_se_hdmi_audio_setup,\n\t.hdmi_audio_disable = enc1_se_hdmi_audio_disable,\n\t.setup_stereo_sync  = enc1_setup_stereo_sync,\n\t.set_avmute = enc1_stream_encoder_set_avmute,\n\t.dig_connect_to_otg = enc1_dig_connect_to_otg,\n\t.dig_source_otg = enc1_dig_source_otg,\n\n\t.dp_get_pixel_format  = enc1_stream_encoder_dp_get_pixel_format,\n\n\t.enc_read_state = enc3_read_state,\n\t.dp_set_dsc_config = enc3_dp_set_dsc_config,\n\t.dp_set_dsc_pps_info_packet = enc3_dp_set_dsc_pps_info_packet,\n\t.set_dynamic_metadata = enc2_set_dynamic_metadata,\n\t.hdmi_reset_stream_attribute = enc1_reset_hdmi_stream_attribute,\n\n\t.get_fifo_cal_average_level = enc2_get_fifo_cal_average_level,\n};\n\nvoid dcn30_dio_stream_encoder_construct(\n\tstruct dcn10_stream_encoder *enc1,\n\tstruct dc_context *ctx,\n\tstruct dc_bios *bp,\n\tenum engine_id eng_id,\n\tstruct vpg *vpg,\n\tstruct afmt *afmt,\n\tconst struct dcn10_stream_enc_registers *regs,\n\tconst struct dcn10_stream_encoder_shift *se_shift,\n\tconst struct dcn10_stream_encoder_mask *se_mask)\n{\n\tenc1->base.funcs = &dcn30_str_enc_funcs;\n\tenc1->base.ctx = ctx;\n\tenc1->base.id = eng_id;\n\tenc1->base.bp = bp;\n\tenc1->base.vpg = vpg;\n\tenc1->base.afmt = afmt;\n\tenc1->regs = regs;\n\tenc1->se_shift = se_shift;\n\tenc1->se_mask = se_mask;\n\tenc1->base.stream_enc_inst = vpg->inst;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}