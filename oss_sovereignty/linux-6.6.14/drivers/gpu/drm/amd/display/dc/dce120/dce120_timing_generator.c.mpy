{
  "module_name": "dce120_timing_generator.c",
  "hash_id": "57c0824685b96629eadb06635a3a35a34455a1570210a773f1da9f981efbe311",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dce120/dce120_timing_generator.c",
  "human_readable_source": " \n\n#include \"dm_services.h\"\n\n#include \"dce/dce_12_0_offset.h\"\n#include \"dce/dce_12_0_sh_mask.h\"\n#include \"soc15_hw_ip.h\"\n#include \"vega10_ip_offset.h\"\n\n#include \"dc_types.h\"\n#include \"dc_bios_types.h\"\n\n#include \"include/grph_object_id.h\"\n#include \"include/logger_interface.h\"\n#include \"dce120_timing_generator.h\"\n\n#include \"timing_generator.h\"\n\n#define CRTC_REG_UPDATE_N(reg_name, n, ...)\t\\\n\t\tgeneric_reg_update_soc15(tg110->base.ctx, tg110->offsets.crtc, reg_name, n, __VA_ARGS__)\n\n#define CRTC_REG_SET_N(reg_name, n, ...)\t\\\n\t\tgeneric_reg_set_soc15(tg110->base.ctx, tg110->offsets.crtc, reg_name, n, __VA_ARGS__)\n\n#define CRTC_REG_UPDATE(reg, field, val)\t\\\n\t\tCRTC_REG_UPDATE_N(reg, 1, FD(reg##__##field), val)\n\n#define CRTC_REG_UPDATE_2(reg, field1, val1, field2, val2)\t\\\n\t\tCRTC_REG_UPDATE_N(reg, 2, FD(reg##__##field1), val1, FD(reg##__##field2), val2)\n\n#define CRTC_REG_UPDATE_3(reg, field1, val1, field2, val2, field3, val3)\t\\\n\t\tCRTC_REG_UPDATE_N(reg, 3, FD(reg##__##field1), val1, FD(reg##__##field2), val2, FD(reg##__##field3), val3)\n\n#define CRTC_REG_UPDATE_4(reg, field1, val1, field2, val2, field3, val3, field4, val4)\t\\\n\t\tCRTC_REG_UPDATE_N(reg, 3, FD(reg##__##field1), val1, FD(reg##__##field2), val2, FD(reg##__##field3), val3, FD(reg##__##field4), val4)\n\n#define CRTC_REG_UPDATE_5(reg, field1, val1, field2, val2, field3, val3, field4, val4, field5, val5)\t\\\n\t\tCRTC_REG_UPDATE_N(reg, 3, FD(reg##__##field1), val1, FD(reg##__##field2), val2, FD(reg##__##field3), val3, FD(reg##__##field4), val4, FD(reg##__##field5), val5)\n\n#define CRTC_REG_SET(reg, field, val)\t\\\n\t\tCRTC_REG_SET_N(reg, 1, FD(reg##__##field), val)\n\n#define CRTC_REG_SET_2(reg, field1, val1, field2, val2)\t\\\n\t\tCRTC_REG_SET_N(reg, 2, FD(reg##__##field1), val1, FD(reg##__##field2), val2)\n\n#define CRTC_REG_SET_3(reg, field1, val1, field2, val2, field3, val3)\t\\\n\t\tCRTC_REG_SET_N(reg, 3, FD(reg##__##field1), val1, FD(reg##__##field2), val2, FD(reg##__##field3), val3)\n\n \nstatic bool dce120_timing_generator_is_in_vertical_blank(\n\t\tstruct timing_generator *tg)\n{\n\tuint32_t field = 0;\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value = dm_read_reg_soc15(\n\t\t\t\t\ttg->ctx,\n\t\t\t\t\tmmCRTC0_CRTC_STATUS,\n\t\t\t\t\ttg110->offsets.crtc);\n\n\tfield = get_reg_field_value(value, CRTC0_CRTC_STATUS, CRTC_V_BLANK);\n\treturn field == 1;\n}\n\n\n \nstatic bool dce120_timing_generator_validate_timing(\n\tstruct timing_generator *tg,\n\tconst struct dc_crtc_timing *timing,\n\tenum signal_type signal)\n{\n\tuint32_t interlace_factor = timing->flags.INTERLACE ? 2 : 1;\n\tuint32_t v_blank =\n\t\t\t\t\t(timing->v_total - timing->v_addressable -\n\t\t\t\t\ttiming->v_border_top - timing->v_border_bottom) *\n\t\t\t\t\tinterlace_factor;\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\tif (!dce110_timing_generator_validate_timing(\n\t\t\t\t\ttg,\n\t\t\t\t\ttiming,\n\t\t\t\t\tsignal))\n\t\treturn false;\n\n\n\tif (v_blank < tg110->min_v_blank\t||\n\t\t timing->h_sync_width  < tg110->min_h_sync_width ||\n\t\t timing->v_sync_width  < tg110->min_v_sync_width)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic bool dce120_tg_validate_timing(struct timing_generator *tg,\n\tconst struct dc_crtc_timing *timing)\n{\n\treturn dce120_timing_generator_validate_timing(tg, timing, SIGNAL_TYPE_NONE);\n}\n\n \n \nstatic bool dce120_timing_generator_enable_crtc(struct timing_generator *tg)\n{\n\tenum bp_result result;\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\t \n\n\tCRTC_REG_UPDATE(CRTC0_CRTC_MASTER_UPDATE_MODE,\n\t\t\tMASTER_UPDATE_MODE, 0);\n\n\tCRTC_REG_UPDATE(CRTC0_CRTC_MASTER_UPDATE_LOCK,\n\t\t\tUNDERFLOW_UPDATE_LOCK, 0);\n\n\t \n\tresult = tg->bp->funcs->enable_crtc(tg->bp, tg110->controller_id, true);\n\n\treturn result == BP_RESULT_OK;\n}\n\nstatic void dce120_timing_generator_set_early_control(\n\t\tstruct timing_generator *tg,\n\t\tuint32_t early_cntl)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\tCRTC_REG_UPDATE(CRTC0_CRTC_CONTROL,\n\t\t\tCRTC_HBLANK_EARLY_CONTROL, early_cntl);\n}\n\n \n\n \nstatic uint32_t dce120_timing_generator_get_vblank_counter(\n\t\tstruct timing_generator *tg)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value = dm_read_reg_soc15(\n\t\t\t\ttg->ctx,\n\t\t\t\tmmCRTC0_CRTC_STATUS_FRAME_COUNT,\n\t\t\t\ttg110->offsets.crtc);\n\tuint32_t field = get_reg_field_value(\n\t\t\t\tvalue, CRTC0_CRTC_STATUS_FRAME_COUNT, CRTC_FRAME_COUNT);\n\n\treturn field;\n}\n\n \nstatic void dce120_timing_generator_get_crtc_position(\n\tstruct timing_generator *tg,\n\tstruct crtc_position *position)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value = dm_read_reg_soc15(\n\t\t\t\ttg->ctx,\n\t\t\t\tmmCRTC0_CRTC_STATUS_POSITION,\n\t\t\t\ttg110->offsets.crtc);\n\n\tposition->horizontal_count = get_reg_field_value(value,\n\t\t\tCRTC0_CRTC_STATUS_POSITION, CRTC_HORZ_COUNT);\n\n\tposition->vertical_count = get_reg_field_value(value,\n\t\t\tCRTC0_CRTC_STATUS_POSITION, CRTC_VERT_COUNT);\n\n\tvalue = dm_read_reg_soc15(\n\t\t\t\ttg->ctx,\n\t\t\t\tmmCRTC0_CRTC_NOM_VERT_POSITION,\n\t\t\t\ttg110->offsets.crtc);\n\n\tposition->nominal_vcount = get_reg_field_value(value,\n\t\t\tCRTC0_CRTC_NOM_VERT_POSITION, CRTC_VERT_COUNT_NOM);\n}\n\n \nstatic void dce120_timing_generator_wait_for_vblank(struct timing_generator *tg)\n{\n\t \n\twhile (dce120_timing_generator_is_in_vertical_blank(tg)) {\n\t\tif (!tg->funcs->is_counter_moving(tg)) {\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\t}\n\n\twhile (!dce120_timing_generator_is_in_vertical_blank(tg)) {\n\t\tif (!tg->funcs->is_counter_moving(tg)) {\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\t}\n}\n\n \nstatic void dce120_timing_generator_wait_for_vactive(struct timing_generator *tg)\n{\n\twhile (dce120_timing_generator_is_in_vertical_blank(tg)) {\n\t\tif (!tg->funcs->is_counter_moving(tg)) {\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\t}\n}\n\n \n\n \nstatic void dce120_timing_generator_setup_global_swap_lock(\n\tstruct timing_generator *tg,\n\tconst struct dcp_gsl_params *gsl_params)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value_crtc_vtotal =\n\t\t\t\t\t\t\tdm_read_reg_soc15(tg->ctx,\n\t\t\t\t\t\t\tmmCRTC0_CRTC_V_TOTAL,\n\t\t\t\t\t\t\ttg110->offsets.crtc);\n\t \n\tuint32_t check_point =\n\t\t\t\t\t\t\tget_reg_field_value(value_crtc_vtotal,\n\t\t\t\t\t\t\tCRTC0_CRTC_V_TOTAL,\n\t\t\t\t\t\t\tCRTC_V_TOTAL);\n\n\n\tdm_write_reg_soc15(tg->ctx, mmCRTC0_CRTC_GSL_WINDOW, tg110->offsets.crtc, 0);\n\n\tCRTC_REG_UPDATE_N(DCP0_DCP_GSL_CONTROL, 6,\n\t\t \n\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL0_EN), 1,\n\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_MASTER_EN), gsl_params->gsl_master == tg->inst,\n\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_HSYNC_FLIP_FORCE_DELAY), HFLIP_READY_DELAY,\n\t\t \n\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_HSYNC_FLIP_CHECK_DELAY), HFLIP_CHECK_DELAY,\n\t\t \n\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_SYNC_SOURCE), 0,\n\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_DELAY_SURFACE_UPDATE_PENDING), 1);\n\n\tCRTC_REG_SET_2(\n\t\t\tCRTC0_CRTC_GSL_CONTROL,\n\t\t\tCRTC_GSL_CHECK_LINE_NUM, check_point - FLIP_READY_BACK_LOOKUP,\n\t\t\tCRTC_GSL_FORCE_DELAY, VFLIP_READY_DELAY);\n}\n\n \nstatic void dce120_timing_generator_tear_down_global_swap_lock(\n\tstruct timing_generator *tg)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\t \n\tCRTC_REG_SET_N(DCP0_DCP_GSL_CONTROL, 6,\n\t\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL0_EN), 0,\n\t\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_MASTER_EN), 0,\n\t\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_HSYNC_FLIP_FORCE_DELAY), HFLIP_READY_DELAY,\n\t\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_HSYNC_FLIP_CHECK_DELAY), HFLIP_CHECK_DELAY,\n\t\t\t \n\t\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_SYNC_SOURCE), 0,\n\t\t\tFD(DCP0_DCP_GSL_CONTROL__DCP_GSL_DELAY_SURFACE_UPDATE_PENDING), 0);\n\n\tCRTC_REG_SET_2(CRTC0_CRTC_GSL_CONTROL,\n\t\t       CRTC_GSL_CHECK_LINE_NUM, 0,\n\t\t       CRTC_GSL_FORCE_DELAY, 0x2);  \n}\n\n \nstatic void dce120_timing_generator_enable_reset_trigger(\n\tstruct timing_generator *tg,\n\tint source)\n{\n\tenum trigger_source_select trig_src_select = TRIGGER_SOURCE_SELECT_LOGIC_ZERO;\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t rising_edge = 0;\n\tuint32_t falling_edge = 0;\n\t \n\tuint32_t pol_value = dm_read_reg_soc15(\n\t\t\t\t\t\t\t\t\ttg->ctx,\n\t\t\t\t\t\t\t\t\tmmCRTC0_CRTC_V_SYNC_A_CNTL,\n\t\t\t\t\t\t\t\t\ttg110->offsets.crtc);\n\n\t \n\tif (get_reg_field_value(pol_value,\n\t\t\tCRTC0_CRTC_V_SYNC_A_CNTL,\n\t\t\tCRTC_V_SYNC_A_POL) == 0) {\n\t\trising_edge = 1;\n\t} else {\n\t\tfalling_edge = 1;\n\t}\n\n\t \n\ttrig_src_select = TRIGGER_SOURCE_SELECT_GSL_GROUP0;\n\n\tCRTC_REG_UPDATE_N(CRTC0_CRTC_TRIGB_CNTL, 7,\n\t\tFD(CRTC0_CRTC_TRIGB_CNTL__CRTC_TRIGB_SOURCE_SELECT), trig_src_select,\n\t\tFD(CRTC0_CRTC_TRIGB_CNTL__CRTC_TRIGB_POLARITY_SELECT), TRIGGER_POLARITY_SELECT_LOGIC_ZERO,\n\t\tFD(CRTC0_CRTC_TRIGB_CNTL__CRTC_TRIGB_RISING_EDGE_DETECT_CNTL), rising_edge,\n\t\tFD(CRTC0_CRTC_TRIGB_CNTL__CRTC_TRIGB_FALLING_EDGE_DETECT_CNTL), falling_edge,\n\t\t \n\t\tFD(CRTC0_CRTC_TRIGB_CNTL__CRTC_TRIGB_FREQUENCY_SELECT), 0,\n\t\t \n\t\tFD(CRTC0_CRTC_TRIGB_CNTL__CRTC_TRIGB_DELAY), 0,\n\t\t \n\t\tFD(CRTC0_CRTC_TRIGB_CNTL__CRTC_TRIGB_CLEAR), 1);\n\n\tCRTC_REG_UPDATE_3(\n\t\t\tCRTC0_CRTC_FORCE_COUNT_NOW_CNTL,\n\t\t\tCRTC_FORCE_COUNT_NOW_MODE, 2,\n\t\t\tCRTC_FORCE_COUNT_NOW_TRIG_SEL, 1,\n\t\t\tCRTC_FORCE_COUNT_NOW_CLEAR, 1);\n}\n\n \nstatic void dce120_timing_generator_disable_reset_trigger(\n\tstruct timing_generator *tg)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\tCRTC_REG_UPDATE_2(\n\t\tCRTC0_CRTC_FORCE_COUNT_NOW_CNTL,\n\t\tCRTC_FORCE_COUNT_NOW_MODE, 0,\n\t\tCRTC_FORCE_COUNT_NOW_CLEAR, 1);\n\n\tCRTC_REG_UPDATE_3(\n\t\tCRTC0_CRTC_TRIGB_CNTL,\n\t\tCRTC_TRIGB_SOURCE_SELECT, TRIGGER_SOURCE_SELECT_LOGIC_ZERO,\n\t\tCRTC_TRIGB_POLARITY_SELECT, TRIGGER_POLARITY_SELECT_LOGIC_ZERO,\n\t\t \n\t\tCRTC_TRIGB_CLEAR, 1);\n\n}\n\n \nstatic bool dce120_timing_generator_did_triggered_reset_occur(\n\tstruct timing_generator *tg)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value = dm_read_reg_soc15(\n\t\t\ttg->ctx,\n\t\t\tmmCRTC0_CRTC_FORCE_COUNT_NOW_CNTL,\n\t\t\ttg110->offsets.crtc);\n\n\treturn get_reg_field_value(value,\n\t\t\tCRTC0_CRTC_FORCE_COUNT_NOW_CNTL,\n\t\t\tCRTC_FORCE_COUNT_NOW_OCCURRED) != 0;\n}\n\n\n \n \nstatic void dce120_timing_generator_disable_vga(struct timing_generator *tg)\n{\n\tuint32_t offset = 0;\n\tuint32_t value = 0;\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\tswitch (tg110->controller_id) {\n\tcase CONTROLLER_ID_D0:\n\t\toffset = 0;\n\t\tbreak;\n\tcase CONTROLLER_ID_D1:\n\t\toffset = mmD2VGA_CONTROL - mmD1VGA_CONTROL;\n\t\tbreak;\n\tcase CONTROLLER_ID_D2:\n\t\toffset = mmD3VGA_CONTROL - mmD1VGA_CONTROL;\n\t\tbreak;\n\tcase CONTROLLER_ID_D3:\n\t\toffset = mmD4VGA_CONTROL - mmD1VGA_CONTROL;\n\t\tbreak;\n\tcase CONTROLLER_ID_D4:\n\t\toffset = mmD5VGA_CONTROL - mmD1VGA_CONTROL;\n\t\tbreak;\n\tcase CONTROLLER_ID_D5:\n\t\toffset = mmD6VGA_CONTROL - mmD1VGA_CONTROL;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tvalue = dm_read_reg_soc15(tg->ctx, mmD1VGA_CONTROL, offset);\n\n\tset_reg_field_value(value, 0, D1VGA_CONTROL, D1VGA_MODE_ENABLE);\n\tset_reg_field_value(value, 0, D1VGA_CONTROL, D1VGA_TIMING_SELECT);\n\tset_reg_field_value(\n\t\t\tvalue, 0, D1VGA_CONTROL, D1VGA_SYNC_POLARITY_SELECT);\n\tset_reg_field_value(value, 0, D1VGA_CONTROL, D1VGA_OVERSCAN_COLOR_EN);\n\n\tdm_write_reg_soc15(tg->ctx, mmD1VGA_CONTROL, offset, value);\n}\n \n \nstatic void dce120_timing_generator_program_blanking(\n\tstruct timing_generator *tg,\n\tconst struct dc_crtc_timing *timing)\n{\n\tuint32_t tmp1 = 0;\n\tuint32_t tmp2 = 0;\n\tuint32_t vsync_offset = timing->v_border_bottom +\n\t\t\ttiming->v_front_porch;\n\tuint32_t v_sync_start = timing->v_addressable + vsync_offset;\n\n\tuint32_t hsync_offset = timing->h_border_right +\n\t\t\ttiming->h_front_porch;\n\tuint32_t h_sync_start = timing->h_addressable + hsync_offset;\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\tCRTC_REG_UPDATE(\n\t\tCRTC0_CRTC_H_TOTAL,\n\t\tCRTC_H_TOTAL,\n\t\ttiming->h_total - 1);\n\n\tCRTC_REG_UPDATE(\n\t\tCRTC0_CRTC_V_TOTAL,\n\t\tCRTC_V_TOTAL,\n\t\ttiming->v_total - 1);\n\n\t \n\tCRTC_REG_UPDATE(\n\t\tCRTC0_CRTC_V_TOTAL_MAX,\n\t\tCRTC_V_TOTAL_MAX,\n\t\ttiming->v_total - 1);\n\n\tCRTC_REG_UPDATE(\n\t\tCRTC0_CRTC_V_TOTAL_MIN,\n\t\tCRTC_V_TOTAL_MIN,\n\t\ttiming->v_total - 1);\n\n\ttmp1 = timing->h_total -\n\t\t\t(h_sync_start + timing->h_border_left);\n\ttmp2 = tmp1 + timing->h_addressable +\n\t\t\ttiming->h_border_left + timing->h_border_right;\n\n\tCRTC_REG_UPDATE_2(\n\t\t\tCRTC0_CRTC_H_BLANK_START_END,\n\t\t\tCRTC_H_BLANK_END, tmp1,\n\t\t\tCRTC_H_BLANK_START, tmp2);\n\n\ttmp1 = timing->v_total - (v_sync_start + timing->v_border_top);\n\ttmp2 = tmp1 + timing->v_addressable + timing->v_border_top +\n\t\t\ttiming->v_border_bottom;\n\n\tCRTC_REG_UPDATE_2(\n\t\tCRTC0_CRTC_V_BLANK_START_END,\n\t\tCRTC_V_BLANK_END, tmp1,\n\t\tCRTC_V_BLANK_START, tmp2);\n}\n\n \n \nstatic void dce120_timing_generator_program_blank_color(\n\tstruct timing_generator *tg,\n\tconst struct tg_color *black_color)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\tCRTC_REG_UPDATE_3(\n\t\tCRTC0_CRTC_BLACK_COLOR,\n\t\tCRTC_BLACK_COLOR_B_CB, black_color->color_b_cb,\n\t\tCRTC_BLACK_COLOR_G_Y, black_color->color_g_y,\n\t\tCRTC_BLACK_COLOR_R_CR, black_color->color_r_cr);\n}\n \nstatic void dce120_timing_generator_set_overscan_color_black(\n\tstruct timing_generator *tg,\n\tconst struct tg_color *color)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value = 0;\n\tCRTC_REG_SET_3(\n\t\tCRTC0_CRTC_OVERSCAN_COLOR,\n\t\tCRTC_OVERSCAN_COLOR_BLUE, color->color_b_cb,\n\t\tCRTC_OVERSCAN_COLOR_GREEN, color->color_g_y,\n\t\tCRTC_OVERSCAN_COLOR_RED, color->color_r_cr);\n\n\tvalue = dm_read_reg_soc15(\n\t\t\ttg->ctx,\n\t\t\tmmCRTC0_CRTC_OVERSCAN_COLOR,\n\t\t\ttg110->offsets.crtc);\n\n\tdm_write_reg_soc15(\n\t\t\ttg->ctx,\n\t\t\tmmCRTC0_CRTC_BLACK_COLOR,\n\t\t\ttg110->offsets.crtc,\n\t\t\tvalue);\n\n\t \n\tdm_write_reg_soc15(\n\t\ttg->ctx,\n\t\tmmCRTC0_CRTC_BLANK_DATA_COLOR,\n\t\ttg110->offsets.crtc,\n\t\tvalue);\n\n\t \n}\n\nstatic void dce120_timing_generator_set_drr(\n\tstruct timing_generator *tg,\n\tconst struct drr_params *params)\n{\n\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\tif (params != NULL &&\n\t\tparams->vertical_total_max > 0 &&\n\t\tparams->vertical_total_min > 0) {\n\n\t\tCRTC_REG_UPDATE(\n\t\t\t\tCRTC0_CRTC_V_TOTAL_MIN,\n\t\t\t\tCRTC_V_TOTAL_MIN, params->vertical_total_min - 1);\n\t\tCRTC_REG_UPDATE(\n\t\t\t\tCRTC0_CRTC_V_TOTAL_MAX,\n\t\t\t\tCRTC_V_TOTAL_MAX, params->vertical_total_max - 1);\n\t\tCRTC_REG_SET_N(CRTC0_CRTC_V_TOTAL_CONTROL, 6,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_V_TOTAL_MIN_SEL), 1,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_V_TOTAL_MAX_SEL), 1,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_FORCE_LOCK_ON_EVENT), 0,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_FORCE_LOCK_TO_MASTER_VSYNC), 0,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_SET_V_TOTAL_MIN_MASK_EN), 0,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_SET_V_TOTAL_MIN_MASK), 0);\n\t\tCRTC_REG_UPDATE(\n\t\t\t\tCRTC0_CRTC_STATIC_SCREEN_CONTROL,\n\t\t\t\tCRTC_STATIC_SCREEN_EVENT_MASK,\n\t\t\t\t0x180);\n\n\t} else {\n\t\tCRTC_REG_SET_N(CRTC0_CRTC_V_TOTAL_CONTROL, 5,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_V_TOTAL_MIN_SEL), 0,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_V_TOTAL_MAX_SEL), 0,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_FORCE_LOCK_ON_EVENT), 0,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_FORCE_LOCK_TO_MASTER_VSYNC), 0,\n\t\t\t\tFD(CRTC0_CRTC_V_TOTAL_CONTROL__CRTC_SET_V_TOTAL_MIN_MASK), 0);\n\t\tCRTC_REG_UPDATE(\n\t\t\t\tCRTC0_CRTC_V_TOTAL_MIN,\n\t\t\t\tCRTC_V_TOTAL_MIN, 0);\n\t\tCRTC_REG_UPDATE(\n\t\t\t\tCRTC0_CRTC_V_TOTAL_MAX,\n\t\t\t\tCRTC_V_TOTAL_MAX, 0);\n\t\tCRTC_REG_UPDATE(\n\t\t\t\tCRTC0_CRTC_STATIC_SCREEN_CONTROL,\n\t\t\t\tCRTC_STATIC_SCREEN_EVENT_MASK,\n\t\t\t\t0);\n\t}\n}\n\nstatic void dce120_timing_generator_get_crtc_scanoutpos(\n\tstruct timing_generator *tg,\n\tuint32_t *v_blank_start,\n\tuint32_t *v_blank_end,\n\tuint32_t *h_position,\n\tuint32_t *v_position)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tstruct crtc_position position;\n\n\tuint32_t v_blank_start_end = dm_read_reg_soc15(\n\t\t\ttg->ctx,\n\t\t\tmmCRTC0_CRTC_V_BLANK_START_END,\n\t\t\ttg110->offsets.crtc);\n\n\t*v_blank_start = get_reg_field_value(v_blank_start_end,\n\t\t\t\t\t     CRTC0_CRTC_V_BLANK_START_END,\n\t\t\t\t\t     CRTC_V_BLANK_START);\n\t*v_blank_end = get_reg_field_value(v_blank_start_end,\n\t\t\t\t\t   CRTC0_CRTC_V_BLANK_START_END,\n\t\t\t\t\t   CRTC_V_BLANK_END);\n\n\tdce120_timing_generator_get_crtc_position(\n\t\t\ttg, &position);\n\n\t*h_position = position.horizontal_count;\n\t*v_position = position.vertical_count;\n}\n\nstatic void dce120_timing_generator_enable_advanced_request(\n\tstruct timing_generator *tg,\n\tbool enable,\n\tconst struct dc_crtc_timing *timing)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t v_sync_width_and_b_porch =\n\t\t\t\ttiming->v_total - timing->v_addressable -\n\t\t\t\ttiming->v_border_bottom - timing->v_front_porch;\n\tuint32_t value = dm_read_reg_soc15(\n\t\t\t\ttg->ctx,\n\t\t\t\tmmCRTC0_CRTC_START_LINE_CONTROL,\n\t\t\t\ttg110->offsets.crtc);\n\n\tset_reg_field_value(\n\t\tvalue,\n\t\tenable ? 0 : 1,\n\t\tCRTC0_CRTC_START_LINE_CONTROL,\n\t\tCRTC_LEGACY_REQUESTOR_EN);\n\n\t \n\tif (v_sync_width_and_b_porch > 10)\n\t\tv_sync_width_and_b_porch = 10;\n\n\tset_reg_field_value(\n\t\tvalue,\n\t\tv_sync_width_and_b_porch,\n\t\tCRTC0_CRTC_START_LINE_CONTROL,\n\t\tCRTC_ADVANCED_START_LINE_POSITION);\n\n\tdm_write_reg_soc15(tg->ctx,\n\t\t\tmmCRTC0_CRTC_START_LINE_CONTROL,\n\t\t\ttg110->offsets.crtc,\n\t\t\tvalue);\n}\n\nstatic void dce120_tg_program_blank_color(struct timing_generator *tg,\n\tconst struct tg_color *black_color)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value = 0;\n\n\tCRTC_REG_UPDATE_3(\n\t\tCRTC0_CRTC_BLACK_COLOR,\n\t\tCRTC_BLACK_COLOR_B_CB, black_color->color_b_cb,\n\t\tCRTC_BLACK_COLOR_G_Y, black_color->color_g_y,\n\t\tCRTC_BLACK_COLOR_R_CR, black_color->color_r_cr);\n\n\tvalue = dm_read_reg_soc15(\n\t\t\t\ttg->ctx,\n\t\t\t\tmmCRTC0_CRTC_BLACK_COLOR,\n\t\t\t\ttg110->offsets.crtc);\n\tdm_write_reg_soc15(\n\t\ttg->ctx,\n\t\tmmCRTC0_CRTC_BLANK_DATA_COLOR,\n\t\ttg110->offsets.crtc,\n\t\tvalue);\n}\n\nstatic void dce120_tg_set_overscan_color(struct timing_generator *tg,\n\tconst struct tg_color *overscan_color)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\tCRTC_REG_SET_3(\n\t\tCRTC0_CRTC_OVERSCAN_COLOR,\n\t\tCRTC_OVERSCAN_COLOR_BLUE, overscan_color->color_b_cb,\n\t\tCRTC_OVERSCAN_COLOR_GREEN, overscan_color->color_g_y,\n\t\tCRTC_OVERSCAN_COLOR_RED, overscan_color->color_r_cr);\n}\n\nstatic void dce120_tg_program_timing(struct timing_generator *tg,\n\tconst struct dc_crtc_timing *timing,\n\tint vready_offset,\n\tint vstartup_start,\n\tint vupdate_offset,\n\tint vupdate_width,\n\tconst enum signal_type signal,\n\tbool use_vbios)\n{\n\tif (use_vbios)\n\t\tdce110_timing_generator_program_timing_generator(tg, timing);\n\telse\n\t\tdce120_timing_generator_program_blanking(tg, timing);\n}\n\nstatic bool dce120_tg_is_blanked(struct timing_generator *tg)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value = dm_read_reg_soc15(\n\t\t\ttg->ctx,\n\t\t\tmmCRTC0_CRTC_BLANK_CONTROL,\n\t\t\ttg110->offsets.crtc);\n\n\tif (get_reg_field_value(\n\t\tvalue,\n\t\tCRTC0_CRTC_BLANK_CONTROL,\n\t\tCRTC_BLANK_DATA_EN) == 1 &&\n\t    get_reg_field_value(\n\t\tvalue,\n\t\tCRTC0_CRTC_BLANK_CONTROL,\n\t\tCRTC_CURRENT_BLANK_STATE) == 1)\n\t\t\treturn true;\n\n\treturn false;\n}\n\nstatic void dce120_tg_set_blank(struct timing_generator *tg,\n\t\tbool enable_blanking)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\tCRTC_REG_SET(\n\t\tCRTC0_CRTC_DOUBLE_BUFFER_CONTROL,\n\t\tCRTC_BLANK_DATA_DOUBLE_BUFFER_EN, 1);\n\n\tif (enable_blanking)\n\t\tCRTC_REG_SET(CRTC0_CRTC_BLANK_CONTROL, CRTC_BLANK_DATA_EN, 1);\n\telse\n\t\tdm_write_reg_soc15(tg->ctx, mmCRTC0_CRTC_BLANK_CONTROL,\n\t\t\ttg110->offsets.crtc, 0);\n}\n\nbool dce120_tg_validate_timing(struct timing_generator *tg,\n\tconst struct dc_crtc_timing *timing);\n\nstatic void dce120_tg_wait_for_state(struct timing_generator *tg,\n\tenum crtc_state state)\n{\n\tswitch (state) {\n\tcase CRTC_STATE_VBLANK:\n\t\tdce120_timing_generator_wait_for_vblank(tg);\n\t\tbreak;\n\n\tcase CRTC_STATE_VACTIVE:\n\t\tdce120_timing_generator_wait_for_vactive(tg);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void dce120_tg_set_colors(struct timing_generator *tg,\n\tconst struct tg_color *blank_color,\n\tconst struct tg_color *overscan_color)\n{\n\tif (blank_color != NULL)\n\t\tdce120_tg_program_blank_color(tg, blank_color);\n\n\tif (overscan_color != NULL)\n\t\tdce120_tg_set_overscan_color(tg, overscan_color);\n}\n\nstatic void dce120_timing_generator_set_static_screen_control(\n\tstruct timing_generator *tg,\n\tuint32_t event_triggers,\n\tuint32_t num_frames)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\t \n\tif (num_frames > 0xFF)\n\t\tnum_frames = 0xFF;\n\n\tCRTC_REG_UPDATE_2(CRTC0_CRTC_STATIC_SCREEN_CONTROL,\n\t\t\tCRTC_STATIC_SCREEN_EVENT_MASK, event_triggers,\n\t\t\tCRTC_STATIC_SCREEN_FRAME_COUNT, num_frames);\n}\n\nstatic void dce120_timing_generator_set_test_pattern(\n\tstruct timing_generator *tg,\n\t \n\tenum controller_dp_test_pattern test_pattern,\n\tenum dc_color_depth color_depth)\n{\n\tstruct dc_context *ctx = tg->ctx;\n\tuint32_t value;\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tenum test_pattern_color_format bit_depth;\n\tenum test_pattern_dyn_range dyn_range;\n\tenum test_pattern_mode mode;\n\t \n\tuint32_t src_bpc = 16;\n\t \n\tuint32_t dst_bpc;\n\tuint32_t index;\n\t \n\tuint16_t src_color[6] = {0xFFFF, 0xFFFF, 0xFFFF, 0x0000,\n\t\t\t\t\t\t0x0000, 0x0000};\n\t \n\tuint16_t dst_color[6];\n\tuint32_t inc_base;\n\n\t \n\tswitch (color_depth) {\n\tcase COLOR_DEPTH_666:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_6;\n\tbreak;\n\tcase COLOR_DEPTH_888:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_8;\n\tbreak;\n\tcase COLOR_DEPTH_101010:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_10;\n\tbreak;\n\tcase COLOR_DEPTH_121212:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_12;\n\tbreak;\n\tdefault:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_8;\n\tbreak;\n\t}\n\n\tswitch (test_pattern) {\n\tcase CONTROLLER_DP_TEST_PATTERN_COLORSQUARES:\n\tcase CONTROLLER_DP_TEST_PATTERN_COLORSQUARES_CEA:\n\t{\n\t\tdyn_range = (test_pattern ==\n\t\t\t\tCONTROLLER_DP_TEST_PATTERN_COLORSQUARES_CEA ?\n\t\t\t\tTEST_PATTERN_DYN_RANGE_CEA :\n\t\t\t\tTEST_PATTERN_DYN_RANGE_VESA);\n\t\tmode = TEST_PATTERN_MODE_COLORSQUARES_RGB;\n\n\t\tCRTC_REG_UPDATE_2(CRTC0_CRTC_TEST_PATTERN_PARAMETERS,\n\t\t\t\tCRTC_TEST_PATTERN_VRES, 6,\n\t\t\t\tCRTC_TEST_PATTERN_HRES, 6);\n\n\t\tCRTC_REG_UPDATE_4(CRTC0_CRTC_TEST_PATTERN_CONTROL,\n\t\t\t\tCRTC_TEST_PATTERN_EN, 1,\n\t\t\t\tCRTC_TEST_PATTERN_MODE, mode,\n\t\t\t\tCRTC_TEST_PATTERN_DYNAMIC_RANGE, dyn_range,\n\t\t\t\tCRTC_TEST_PATTERN_COLOR_FORMAT, bit_depth);\n\t}\n\tbreak;\n\n\tcase CONTROLLER_DP_TEST_PATTERN_VERTICALBARS:\n\tcase CONTROLLER_DP_TEST_PATTERN_HORIZONTALBARS:\n\t{\n\t\tmode = (test_pattern ==\n\t\t\tCONTROLLER_DP_TEST_PATTERN_VERTICALBARS ?\n\t\t\tTEST_PATTERN_MODE_VERTICALBARS :\n\t\t\tTEST_PATTERN_MODE_HORIZONTALBARS);\n\n\t\tswitch (bit_depth) {\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_6:\n\t\t\tdst_bpc = 6;\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_8:\n\t\t\tdst_bpc = 8;\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_10:\n\t\t\tdst_bpc = 10;\n\t\tbreak;\n\t\tdefault:\n\t\t\tdst_bpc = 8;\n\t\tbreak;\n\t\t}\n\n\t\t \n\t\tfor (index = 0; index < 6; index++) {\n\t\t\t \n\t\t\tdst_color[index] =\n\t\t\t\tsrc_color[index] >> (src_bpc - dst_bpc);\n\t\t \n\t\t\tdst_color[index] <<= (16 - dst_bpc);\n\t\t}\n\n\t\tdm_write_reg_soc15(ctx, mmCRTC0_CRTC_TEST_PATTERN_PARAMETERS, tg110->offsets.crtc, 0);\n\n\t\t \n\n\t\t \n\t\tvalue = 0;\n\t\tfor (index = 0; index < 6; index++) {\n\t\t\t \n\t\t\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\t(1 << index),\n\t\t\t\tCRTC0_CRTC_TEST_PATTERN_COLOR,\n\t\t\t\tCRTC_TEST_PATTERN_MASK);\n\t\t\t \n\t\t\tdm_write_reg_soc15(ctx, mmCRTC0_CRTC_TEST_PATTERN_COLOR, tg110->offsets.crtc, value);\n\t\t\t \n\t\t\tset_reg_field_value(\n\t\t\t\tvalue,\n\t\t\t\tdst_color[index],\n\t\t\t\tCRTC0_CRTC_TEST_PATTERN_COLOR,\n\t\t\t\tCRTC_TEST_PATTERN_DATA);\n\t\t}\n\t\t \n\t\tdm_write_reg_soc15(ctx, mmCRTC0_CRTC_TEST_PATTERN_COLOR, tg110->offsets.crtc, value);\n\n\t\t \n\t\tCRTC_REG_UPDATE_4(CRTC0_CRTC_TEST_PATTERN_CONTROL,\n\t\t\t\tCRTC_TEST_PATTERN_EN, 1,\n\t\t\t\tCRTC_TEST_PATTERN_MODE, mode,\n\t\t\t\tCRTC_TEST_PATTERN_DYNAMIC_RANGE, 0,\n\t\t\t\tCRTC_TEST_PATTERN_COLOR_FORMAT, bit_depth);\n\t}\n\tbreak;\n\n\tcase CONTROLLER_DP_TEST_PATTERN_COLORRAMP:\n\t{\n\t\tmode = (bit_depth ==\n\t\t\tTEST_PATTERN_COLOR_FORMAT_BPC_10 ?\n\t\t\tTEST_PATTERN_MODE_DUALRAMP_RGB :\n\t\t\tTEST_PATTERN_MODE_SINGLERAMP_RGB);\n\n\t\tswitch (bit_depth) {\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_6:\n\t\t\tdst_bpc = 6;\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_8:\n\t\t\tdst_bpc = 8;\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_10:\n\t\t\tdst_bpc = 10;\n\t\tbreak;\n\t\tdefault:\n\t\t\tdst_bpc = 8;\n\t\tbreak;\n\t\t}\n\n\t\t \n\t\tinc_base = (src_bpc - dst_bpc);\n\n\t\tswitch (bit_depth) {\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_6:\n\t\t{\n\t\t\tCRTC_REG_UPDATE_5(CRTC0_CRTC_TEST_PATTERN_PARAMETERS,\n\t\t\t\t\tCRTC_TEST_PATTERN_INC0, inc_base,\n\t\t\t\t\tCRTC_TEST_PATTERN_INC1, 0,\n\t\t\t\t\tCRTC_TEST_PATTERN_HRES, 6,\n\t\t\t\t\tCRTC_TEST_PATTERN_VRES, 6,\n\t\t\t\t\tCRTC_TEST_PATTERN_RAMP0_OFFSET, 0);\n\t\t}\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_8:\n\t\t{\n\t\t\tCRTC_REG_UPDATE_5(CRTC0_CRTC_TEST_PATTERN_PARAMETERS,\n\t\t\t\t\tCRTC_TEST_PATTERN_INC0, inc_base,\n\t\t\t\t\tCRTC_TEST_PATTERN_INC1, 0,\n\t\t\t\t\tCRTC_TEST_PATTERN_HRES, 8,\n\t\t\t\t\tCRTC_TEST_PATTERN_VRES, 6,\n\t\t\t\t\tCRTC_TEST_PATTERN_RAMP0_OFFSET, 0);\n\t\t}\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_10:\n\t\t{\n\t\t\tCRTC_REG_UPDATE_5(CRTC0_CRTC_TEST_PATTERN_PARAMETERS,\n\t\t\t\t\tCRTC_TEST_PATTERN_INC0, inc_base,\n\t\t\t\t\tCRTC_TEST_PATTERN_INC1, inc_base + 2,\n\t\t\t\t\tCRTC_TEST_PATTERN_HRES, 8,\n\t\t\t\t\tCRTC_TEST_PATTERN_VRES, 5,\n\t\t\t\t\tCRTC_TEST_PATTERN_RAMP0_OFFSET, 384 << 6);\n\t\t}\n\t\tbreak;\n\t\tdefault:\n\t\tbreak;\n\t\t}\n\n\t\tdm_write_reg_soc15(ctx, mmCRTC0_CRTC_TEST_PATTERN_COLOR, tg110->offsets.crtc, 0);\n\n\t\t \n\t\tdm_write_reg_soc15(ctx, mmCRTC0_CRTC_TEST_PATTERN_CONTROL, tg110->offsets.crtc, 0);\n\n\t\tCRTC_REG_UPDATE_4(CRTC0_CRTC_TEST_PATTERN_CONTROL,\n\t\t\t\tCRTC_TEST_PATTERN_EN, 1,\n\t\t\t\tCRTC_TEST_PATTERN_MODE, mode,\n\t\t\t\tCRTC_TEST_PATTERN_DYNAMIC_RANGE, 0,\n\t\t\t\tCRTC_TEST_PATTERN_COLOR_FORMAT, bit_depth);\n\t}\n\tbreak;\n\tcase CONTROLLER_DP_TEST_PATTERN_VIDEOMODE:\n\t{\n\t\tvalue = 0;\n\t\tdm_write_reg_soc15(ctx, mmCRTC0_CRTC_TEST_PATTERN_CONTROL, tg110->offsets.crtc,  value);\n\t\tdm_write_reg_soc15(ctx, mmCRTC0_CRTC_TEST_PATTERN_COLOR, tg110->offsets.crtc, value);\n\t\tdm_write_reg_soc15(ctx, mmCRTC0_CRTC_TEST_PATTERN_PARAMETERS, tg110->offsets.crtc, value);\n\t}\n\tbreak;\n\tdefault:\n\tbreak;\n\t}\n}\n\nstatic bool dce120_arm_vert_intr(\n\t\tstruct timing_generator *tg,\n\t\tuint8_t width)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t v_blank_start, v_blank_end, h_position, v_position;\n\n\ttg->funcs->get_scanoutpos(\n\t\t\t\ttg,\n\t\t\t\t&v_blank_start,\n\t\t\t\t&v_blank_end,\n\t\t\t\t&h_position,\n\t\t\t\t&v_position);\n\n\tif (v_blank_start == 0 || v_blank_end == 0)\n\t\treturn false;\n\n\tCRTC_REG_SET_2(\n\t\t\tCRTC0_CRTC_VERTICAL_INTERRUPT0_POSITION,\n\t\t\tCRTC_VERTICAL_INTERRUPT0_LINE_START, v_blank_start,\n\t\t\tCRTC_VERTICAL_INTERRUPT0_LINE_END, v_blank_start + width);\n\n\treturn true;\n}\n\n\nstatic bool dce120_is_tg_enabled(struct timing_generator *tg)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value, field;\n\n\tvalue = dm_read_reg_soc15(tg->ctx, mmCRTC0_CRTC_CONTROL,\n\t\t\t\t  tg110->offsets.crtc);\n\tfield = get_reg_field_value(value, CRTC0_CRTC_CONTROL,\n\t\t\t\t    CRTC_CURRENT_MASTER_EN_STATE);\n\n\treturn field == 1;\n}\n\nstatic bool dce120_configure_crc(struct timing_generator *tg,\n\t\t\t\t const struct crc_params *params)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\n\t \n\tif (!dce120_is_tg_enabled(tg))\n\t\treturn false;\n\n\t \n\tdm_write_reg_soc15(tg->ctx, mmCRTC0_CRTC_CRC_CNTL,\n\t\t\t   tg110->offsets.crtc, 0);\n\n\tif (!params->enable)\n\t\treturn true;\n\n\t \n\t \n\tCRTC_REG_UPDATE_2(CRTC0_CRTC_CRC0_WINDOWA_X_CONTROL,\n\t\t\t  CRTC_CRC0_WINDOWA_X_START, params->windowa_x_start,\n\t\t\t  CRTC_CRC0_WINDOWA_X_END, params->windowa_x_end);\n\n\t \n\tCRTC_REG_UPDATE_2(CRTC0_CRTC_CRC0_WINDOWA_Y_CONTROL,\n\t\t\t  CRTC_CRC0_WINDOWA_Y_START, params->windowa_y_start,\n\t\t\t  CRTC_CRC0_WINDOWA_Y_END, params->windowa_y_end);\n\n\t \n\tCRTC_REG_UPDATE_2(CRTC0_CRTC_CRC0_WINDOWB_X_CONTROL,\n\t\t\t  CRTC_CRC0_WINDOWB_X_START, params->windowb_x_start,\n\t\t\t  CRTC_CRC0_WINDOWB_X_END, params->windowb_x_end);\n\n\t \n\tCRTC_REG_UPDATE_2(CRTC0_CRTC_CRC0_WINDOWB_Y_CONTROL,\n\t\t\t  CRTC_CRC0_WINDOWB_Y_START, params->windowb_y_start,\n\t\t\t  CRTC_CRC0_WINDOWB_Y_END, params->windowb_y_end);\n\n\t \n\tCRTC_REG_UPDATE_3(CRTC0_CRTC_CRC_CNTL,\n\t\t\t  CRTC_CRC_EN, params->continuous_mode ? 1 : 0,\n\t\t\t  CRTC_CRC0_SELECT, params->selection,\n\t\t\t  CRTC_CRC_EN, 1);\n\n\treturn true;\n}\n\nstatic bool dce120_get_crc(struct timing_generator *tg, uint32_t *r_cr,\n\t\t\t   uint32_t *g_y, uint32_t *b_cb)\n{\n\tstruct dce110_timing_generator *tg110 = DCE110TG_FROM_TG(tg);\n\tuint32_t value, field;\n\n\tvalue = dm_read_reg_soc15(tg->ctx, mmCRTC0_CRTC_CRC_CNTL,\n\t\t\t\t  tg110->offsets.crtc);\n\tfield = get_reg_field_value(value, CRTC0_CRTC_CRC_CNTL, CRTC_CRC_EN);\n\n\t \n\tif (!field)\n\t\treturn false;\n\n\tvalue = dm_read_reg_soc15(tg->ctx, mmCRTC0_CRTC_CRC0_DATA_RG,\n\t\t\t\t  tg110->offsets.crtc);\n\t*r_cr = get_reg_field_value(value, CRTC0_CRTC_CRC0_DATA_RG, CRC0_R_CR);\n\t*g_y = get_reg_field_value(value, CRTC0_CRTC_CRC0_DATA_RG, CRC0_G_Y);\n\n\tvalue = dm_read_reg_soc15(tg->ctx, mmCRTC0_CRTC_CRC0_DATA_B,\n\t\t\t\t  tg110->offsets.crtc);\n\t*b_cb = get_reg_field_value(value, CRTC0_CRTC_CRC0_DATA_B, CRC0_B_CB);\n\n\treturn true;\n}\n\nstatic const struct timing_generator_funcs dce120_tg_funcs = {\n\t\t.validate_timing = dce120_tg_validate_timing,\n\t\t.program_timing = dce120_tg_program_timing,\n\t\t.enable_crtc = dce120_timing_generator_enable_crtc,\n\t\t.disable_crtc = dce110_timing_generator_disable_crtc,\n\t\t \n\t\t.is_counter_moving = dce110_timing_generator_is_counter_moving,\n\t\t \n\t\t.get_position = dce120_timing_generator_get_crtc_position,\n\t\t.get_frame_count = dce120_timing_generator_get_vblank_counter,\n\t\t.get_scanoutpos = dce120_timing_generator_get_crtc_scanoutpos,\n\t\t.set_early_control = dce120_timing_generator_set_early_control,\n\t\t \n\t\t.wait_for_state = dce120_tg_wait_for_state,\n\t\t.set_blank = dce120_tg_set_blank,\n\t\t.is_blanked = dce120_tg_is_blanked,\n\t\t \n\t\t.set_colors = dce120_tg_set_colors,\n\t\t.set_overscan_blank_color = dce120_timing_generator_set_overscan_color_black,\n\t\t.set_blank_color = dce120_timing_generator_program_blank_color,\n\t\t.disable_vga = dce120_timing_generator_disable_vga,\n\t\t.did_triggered_reset_occur = dce120_timing_generator_did_triggered_reset_occur,\n\t\t.setup_global_swap_lock = dce120_timing_generator_setup_global_swap_lock,\n\t\t.enable_reset_trigger = dce120_timing_generator_enable_reset_trigger,\n\t\t.disable_reset_trigger = dce120_timing_generator_disable_reset_trigger,\n\t\t.tear_down_global_swap_lock = dce120_timing_generator_tear_down_global_swap_lock,\n\t\t.enable_advanced_request = dce120_timing_generator_enable_advanced_request,\n\t\t.set_drr = dce120_timing_generator_set_drr,\n\t\t.get_last_used_drr_vtotal = NULL,\n\t\t.set_static_screen_control = dce120_timing_generator_set_static_screen_control,\n\t\t.set_test_pattern = dce120_timing_generator_set_test_pattern,\n\t\t.arm_vert_intr = dce120_arm_vert_intr,\n\t\t.is_tg_enabled = dce120_is_tg_enabled,\n\t\t.configure_crc = dce120_configure_crc,\n\t\t.get_crc = dce120_get_crc,\n};\n\n\nvoid dce120_timing_generator_construct(\n\tstruct dce110_timing_generator *tg110,\n\tstruct dc_context *ctx,\n\tuint32_t instance,\n\tconst struct dce110_timing_generator_offsets *offsets)\n{\n\ttg110->controller_id = CONTROLLER_ID_D0 + instance;\n\ttg110->base.inst = instance;\n\n\ttg110->offsets = *offsets;\n\n\ttg110->base.funcs = &dce120_tg_funcs;\n\n\ttg110->base.ctx = ctx;\n\ttg110->base.bp = ctx->dc_bios;\n\n\ttg110->max_h_total = CRTC0_CRTC_H_TOTAL__CRTC_H_TOTAL_MASK + 1;\n\ttg110->max_v_total = CRTC0_CRTC_V_TOTAL__CRTC_V_TOTAL_MASK + 1;\n\n\t \n\ttg110->min_h_blank = 32;\n\t \n\ttg110->min_h_front_porch = 0;\n\ttg110->min_h_back_porch = 0;\n\n\ttg110->min_h_sync_width = 4;\n\ttg110->min_v_sync_width = 1;\n\ttg110->min_v_blank = 3;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}