{
  "module_name": "link_dp_cts.c",
  "hash_id": "2df32b214ea24548e1c8523d49fa55f54c1a3c9aa19e2d38705ecb31f9809e94",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/link/accessories/link_dp_cts.c",
  "human_readable_source": " \n#include \"link_dp_cts.h\"\n#include \"link/link_resource.h\"\n#include \"link/protocols/link_dpcd.h\"\n#include \"link/protocols/link_dp_training.h\"\n#include \"link/protocols/link_dp_phy.h\"\n#include \"link/protocols/link_dp_training_fixed_vs_pe_retimer.h\"\n#include \"link/protocols/link_dp_capability.h\"\n#include \"link/link_dpms.h\"\n#include \"resource.h\"\n#include \"dm_helpers.h\"\n#include \"dc_dmub_srv.h\"\n#include \"dce/dmub_hw_lock_mgr.h\"\n\n#define DC_LOGGER \\\n\tlink->ctx->logger\n\nstatic enum dc_link_rate get_link_rate_from_test_link_rate(uint8_t test_rate)\n{\n\tswitch (test_rate) {\n\tcase DP_TEST_LINK_RATE_RBR:\n\t\treturn LINK_RATE_LOW;\n\tcase DP_TEST_LINK_RATE_HBR:\n\t\treturn LINK_RATE_HIGH;\n\tcase DP_TEST_LINK_RATE_HBR2:\n\t\treturn LINK_RATE_HIGH2;\n\tcase DP_TEST_LINK_RATE_HBR3:\n\t\treturn LINK_RATE_HIGH3;\n\tcase DP_TEST_LINK_RATE_UHBR10:\n\t\treturn LINK_RATE_UHBR10;\n\tcase DP_TEST_LINK_RATE_UHBR20:\n\t\treturn LINK_RATE_UHBR20;\n\tcase DP_TEST_LINK_RATE_UHBR13_5:\n\t\treturn LINK_RATE_UHBR13_5;\n\tdefault:\n\t\treturn LINK_RATE_UNKNOWN;\n\t}\n}\n\nstatic bool is_dp_phy_sqaure_pattern(enum dp_test_pattern test_pattern)\n{\n\treturn (DP_TEST_PATTERN_SQUARE_BEGIN <= test_pattern &&\n\t\t\ttest_pattern <= DP_TEST_PATTERN_SQUARE_END);\n}\n\nstatic bool is_dp_phy_pattern(enum dp_test_pattern test_pattern)\n{\n\tif ((DP_TEST_PATTERN_PHY_PATTERN_BEGIN <= test_pattern &&\n\t\t\ttest_pattern <= DP_TEST_PATTERN_PHY_PATTERN_END) ||\n\t\t\ttest_pattern == DP_TEST_PATTERN_VIDEO_MODE)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nstatic void dp_retrain_link_dp_test(struct dc_link *link,\n\t\t\tstruct dc_link_settings *link_setting,\n\t\t\tbool skip_video_pattern)\n{\n\tstruct pipe_ctx *pipes[MAX_PIPES];\n\tstruct dc_state *state = link->dc->current_state;\n\tuint8_t count;\n\tint i;\n\n\tudelay(100);\n\n\tlink_get_master_pipes_with_dpms_on(link, state, &count, pipes);\n\n\tfor (i = 0; i < count; i++) {\n\t\tlink_set_dpms_off(pipes[i]);\n\t\tpipes[i]->link_config.dp_link_settings = *link_setting;\n\t\tupdate_dp_encoder_resources_for_test_harness(\n\t\t\t\tlink->dc,\n\t\t\t\tstate,\n\t\t\t\tpipes[i]);\n\t}\n\n\tfor (i = count-1; i >= 0; i--)\n\t\tlink_set_dpms_on(state, pipes[i]);\n}\n\nstatic void dp_test_send_link_training(struct dc_link *link)\n{\n\tstruct dc_link_settings link_settings = {0};\n\tuint8_t test_rate = 0;\n\n\tcore_link_read_dpcd(\n\t\t\tlink,\n\t\t\tDP_TEST_LANE_COUNT,\n\t\t\t(unsigned char *)(&link_settings.lane_count),\n\t\t\t1);\n\tcore_link_read_dpcd(\n\t\t\tlink,\n\t\t\tDP_TEST_LINK_RATE,\n\t\t\t&test_rate,\n\t\t\t1);\n\tlink_settings.link_rate = get_link_rate_from_test_link_rate(test_rate);\n\n\t \n\tlink->verified_link_cap.lane_count = link_settings.lane_count;\n\tlink->verified_link_cap.link_rate = link_settings.link_rate;\n\n\tdp_retrain_link_dp_test(link, &link_settings, false);\n}\n\nstatic void dp_test_get_audio_test_data(struct dc_link *link, bool disable_video)\n{\n\tunion audio_test_mode            dpcd_test_mode = {0};\n\tstruct audio_test_pattern_type   dpcd_pattern_type = {0};\n\tunion audio_test_pattern_period  dpcd_pattern_period[AUDIO_CHANNELS_COUNT] = {0};\n\tenum dp_test_pattern test_pattern = DP_TEST_PATTERN_AUDIO_OPERATOR_DEFINED;\n\n\tstruct pipe_ctx *pipes = link->dc->current_state->res_ctx.pipe_ctx;\n\tstruct pipe_ctx *pipe_ctx = &pipes[0];\n\tunsigned int channel_count;\n\tunsigned int channel = 0;\n\tunsigned int modes = 0;\n\tunsigned int sampling_rate_in_hz = 0;\n\n\t\n\tcore_link_read_dpcd(\n\t\tlink,\n\t\tDP_TEST_AUDIO_MODE,\n\t\t&dpcd_test_mode.raw,\n\t\tsizeof(dpcd_test_mode));\n\n\tcore_link_read_dpcd(\n\t\tlink,\n\t\tDP_TEST_AUDIO_PATTERN_TYPE,\n\t\t&dpcd_pattern_type.value,\n\t\tsizeof(dpcd_pattern_type));\n\n\tchannel_count = min(dpcd_test_mode.bits.channel_count + 1, AUDIO_CHANNELS_COUNT);\n\n\t\n\tif (dpcd_pattern_type.value == AUDIO_TEST_PATTERN_SAWTOOTH ||\n\t\t\tdpcd_pattern_type.value == AUDIO_TEST_PATTERN_OPERATOR_DEFINED) {\n\n\t\ttest_pattern = (dpcd_pattern_type.value == AUDIO_TEST_PATTERN_SAWTOOTH) ?\n\t\t\t\tDP_TEST_PATTERN_AUDIO_SAWTOOTH : DP_TEST_PATTERN_AUDIO_OPERATOR_DEFINED;\n\t\t\n\t\tfor (channel = 0; channel < channel_count; channel++) {\n\t\t\tcore_link_read_dpcd(\n\t\t\t\t\t\t\tlink,\n\t\t\t\t\t\t\tDP_TEST_AUDIO_PERIOD_CH1 + channel,\n\t\t\t\t\t\t\t&dpcd_pattern_period[channel].raw,\n\t\t\t\t\t\t\tsizeof(dpcd_pattern_period[channel]));\n\t\t}\n\t}\n\n\t\n\tswitch (dpcd_test_mode.bits.sampling_rate) {\n\tcase AUDIO_SAMPLING_RATE_32KHZ:\n\t\tsampling_rate_in_hz = 32000;\n\t\tbreak;\n\tcase AUDIO_SAMPLING_RATE_44_1KHZ:\n\t\tsampling_rate_in_hz = 44100;\n\t\tbreak;\n\tcase AUDIO_SAMPLING_RATE_48KHZ:\n\t\tsampling_rate_in_hz = 48000;\n\t\tbreak;\n\tcase AUDIO_SAMPLING_RATE_88_2KHZ:\n\t\tsampling_rate_in_hz = 88200;\n\t\tbreak;\n\tcase AUDIO_SAMPLING_RATE_96KHZ:\n\t\tsampling_rate_in_hz = 96000;\n\t\tbreak;\n\tcase AUDIO_SAMPLING_RATE_176_4KHZ:\n\t\tsampling_rate_in_hz = 176400;\n\t\tbreak;\n\tcase AUDIO_SAMPLING_RATE_192KHZ:\n\t\tsampling_rate_in_hz = 192000;\n\t\tbreak;\n\tdefault:\n\t\tsampling_rate_in_hz = 0;\n\t\tbreak;\n\t}\n\n\tlink->audio_test_data.flags.test_requested = 1;\n\tlink->audio_test_data.flags.disable_video = disable_video;\n\tlink->audio_test_data.sampling_rate = sampling_rate_in_hz;\n\tlink->audio_test_data.channel_count = channel_count;\n\tlink->audio_test_data.pattern_type = test_pattern;\n\n\tif (test_pattern == DP_TEST_PATTERN_AUDIO_SAWTOOTH) {\n\t\tfor (modes = 0; modes < pipe_ctx->stream->audio_info.mode_count; modes++) {\n\t\t\tlink->audio_test_data.pattern_period[modes] = dpcd_pattern_period[modes].bits.pattern_period;\n\t\t}\n\t}\n}\n\n \nstatic void dp_test_send_phy_test_pattern(struct dc_link *link)\n{\n\tunion phy_test_pattern dpcd_test_pattern;\n\tunion lane_adjust dpcd_lane_adjustment[2];\n\tunsigned char dpcd_post_cursor_2_adjustment = 0;\n\tunsigned char test_pattern_buffer[\n\t\t\t(DP_TEST_264BIT_CUSTOM_PATTERN_263_256 -\n\t\t\tDP_TEST_264BIT_CUSTOM_PATTERN_7_0)+1] = {0};\n\tunsigned int test_pattern_size = 0;\n\tenum dp_test_pattern test_pattern;\n\tunion lane_adjust dpcd_lane_adjust;\n\tunsigned int lane;\n\tstruct link_training_settings link_training_settings;\n\tunsigned char no_preshoot = 0;\n\tunsigned char no_deemphasis = 0;\n\n\tdpcd_test_pattern.raw = 0;\n\tmemset(dpcd_lane_adjustment, 0, sizeof(dpcd_lane_adjustment));\n\tmemset(&link_training_settings, 0, sizeof(link_training_settings));\n\n\t \n\tcore_link_read_dpcd(\n\t\t\tlink,\n\t\t\tDP_PHY_TEST_PATTERN,\n\t\t\t&dpcd_test_pattern.raw,\n\t\t\tsizeof(dpcd_test_pattern));\n\tcore_link_read_dpcd(\n\t\t\tlink,\n\t\t\tDP_ADJUST_REQUEST_LANE0_1,\n\t\t\t&dpcd_lane_adjustment[0].raw,\n\t\t\tsizeof(dpcd_lane_adjustment));\n\n\t \n\tlink_training_settings.link_settings = link->cur_link_settings;\n\n\tlink_training_settings.lttpr_mode = dp_decide_lttpr_mode(link, &link->cur_link_settings);\n\n\tif ((link->chip_caps & EXT_DISPLAY_PATH_CAPS__DP_FIXED_VS_EN) &&\n\t\t\tlink_training_settings.lttpr_mode == LTTPR_MODE_TRANSPARENT)\n\t\tdp_fixed_vs_pe_read_lane_adjust(\n\t\t\t\tlink,\n\t\t\t\tlink_training_settings.dpcd_lane_settings);\n\n\t \n\tcore_link_read_dpcd(\n\t\t\tlink,\n\t\t\tDP_ADJUST_REQUEST_POST_CURSOR2,\n\t\t\t&dpcd_post_cursor_2_adjustment,\n\t\t\tsizeof(dpcd_post_cursor_2_adjustment));\n\n\t \n\tswitch (dpcd_test_pattern.bits.PATTERN) {\n\tcase PHY_TEST_PATTERN_D10_2:\n\t\ttest_pattern = DP_TEST_PATTERN_D102;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_SYMBOL_ERROR:\n\t\ttest_pattern = DP_TEST_PATTERN_SYMBOL_ERROR;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_PRBS7:\n\t\ttest_pattern = DP_TEST_PATTERN_PRBS7;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_80BIT_CUSTOM:\n\t\ttest_pattern = DP_TEST_PATTERN_80BIT_CUSTOM;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_CP2520_1:\n\t\t \n\t\ttest_pattern = (link->dc->caps.force_dp_tps4_for_cp2520 == 1) ?\n\t\t\t\tDP_TEST_PATTERN_TRAINING_PATTERN4 :\n\t\t\t\tDP_TEST_PATTERN_HBR2_COMPLIANCE_EYE;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_CP2520_2:\n\t\t \n\t\ttest_pattern = (link->dc->caps.force_dp_tps4_for_cp2520 == 1) ?\n\t\t\t\tDP_TEST_PATTERN_TRAINING_PATTERN4 :\n\t\t\t\tDP_TEST_PATTERN_HBR2_COMPLIANCE_EYE;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_CP2520_3:\n\t\ttest_pattern = DP_TEST_PATTERN_TRAINING_PATTERN4;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_128b_132b_TPS1:\n\t\ttest_pattern = DP_TEST_PATTERN_128b_132b_TPS1;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_128b_132b_TPS2:\n\t\ttest_pattern = DP_TEST_PATTERN_128b_132b_TPS2;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_PRBS9:\n\t\ttest_pattern = DP_TEST_PATTERN_PRBS9;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_PRBS11:\n\t\ttest_pattern = DP_TEST_PATTERN_PRBS11;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_PRBS15:\n\t\ttest_pattern = DP_TEST_PATTERN_PRBS15;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_PRBS23:\n\t\ttest_pattern = DP_TEST_PATTERN_PRBS23;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_PRBS31:\n\t\ttest_pattern = DP_TEST_PATTERN_PRBS31;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_264BIT_CUSTOM:\n\t\ttest_pattern = DP_TEST_PATTERN_264BIT_CUSTOM;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_SQUARE:\n\t\ttest_pattern = DP_TEST_PATTERN_SQUARE;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_SQUARE_PRESHOOT_DISABLED:\n\t\ttest_pattern = DP_TEST_PATTERN_SQUARE_PRESHOOT_DISABLED;\n\t\tno_preshoot = 1;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_SQUARE_DEEMPHASIS_DISABLED:\n\t\ttest_pattern = DP_TEST_PATTERN_SQUARE_DEEMPHASIS_DISABLED;\n\t\tno_deemphasis = 1;\n\t\tbreak;\n\tcase PHY_TEST_PATTERN_SQUARE_PRESHOOT_DEEMPHASIS_DISABLED:\n\t\ttest_pattern = DP_TEST_PATTERN_SQUARE_PRESHOOT_DEEMPHASIS_DISABLED;\n\t\tno_preshoot = 1;\n\t\tno_deemphasis = 1;\n\t\tbreak;\n\tdefault:\n\t\ttest_pattern = DP_TEST_PATTERN_VIDEO_MODE;\n\tbreak;\n\t}\n\n\tif (test_pattern == DP_TEST_PATTERN_80BIT_CUSTOM) {\n\t\ttest_pattern_size = (DP_TEST_80BIT_CUSTOM_PATTERN_79_72 -\n\t\t\t\tDP_TEST_80BIT_CUSTOM_PATTERN_7_0) + 1;\n\t\tcore_link_read_dpcd(\n\t\t\t\tlink,\n\t\t\t\tDP_TEST_80BIT_CUSTOM_PATTERN_7_0,\n\t\t\t\ttest_pattern_buffer,\n\t\t\t\ttest_pattern_size);\n\t}\n\n\tif (is_dp_phy_sqaure_pattern(test_pattern)) {\n\t\ttest_pattern_size = 1;  \n\t\tcore_link_read_dpcd(\n\t\t\t\tlink,\n\t\t\t\tDP_PHY_SQUARE_PATTERN,\n\t\t\t\ttest_pattern_buffer,\n\t\t\t\ttest_pattern_size);\n\t}\n\n\tif (test_pattern == DP_TEST_PATTERN_264BIT_CUSTOM) {\n\t\ttest_pattern_size = (DP_TEST_264BIT_CUSTOM_PATTERN_263_256-\n\t\t\t\tDP_TEST_264BIT_CUSTOM_PATTERN_7_0) + 1;\n\t\tcore_link_read_dpcd(\n\t\t\t\tlink,\n\t\t\t\tDP_TEST_264BIT_CUSTOM_PATTERN_7_0,\n\t\t\t\ttest_pattern_buffer,\n\t\t\t\ttest_pattern_size);\n\t}\n\n\tfor (lane = 0; lane <\n\t\t(unsigned int)(link->cur_link_settings.lane_count);\n\t\tlane++) {\n\t\tdpcd_lane_adjust.raw =\n\t\t\tdp_get_nibble_at_index(&dpcd_lane_adjustment[0].raw, lane);\n\t\tif (link_dp_get_encoding_format(&link->cur_link_settings) ==\n\t\t\t\tDP_8b_10b_ENCODING) {\n\t\t\tlink_training_settings.hw_lane_settings[lane].VOLTAGE_SWING =\n\t\t\t\t(enum dc_voltage_swing)\n\t\t\t\t(dpcd_lane_adjust.bits.VOLTAGE_SWING_LANE);\n\t\t\tlink_training_settings.hw_lane_settings[lane].PRE_EMPHASIS =\n\t\t\t\t(enum dc_pre_emphasis)\n\t\t\t\t(dpcd_lane_adjust.bits.PRE_EMPHASIS_LANE);\n\t\t\tlink_training_settings.hw_lane_settings[lane].POST_CURSOR2 =\n\t\t\t\t(enum dc_post_cursor2)\n\t\t\t\t((dpcd_post_cursor_2_adjustment >> (lane * 2)) & 0x03);\n\t\t} else if (link_dp_get_encoding_format(&link->cur_link_settings) ==\n\t\t\t\tDP_128b_132b_ENCODING) {\n\t\t\tlink_training_settings.hw_lane_settings[lane].FFE_PRESET.settings.level =\n\t\t\t\t\tdpcd_lane_adjust.tx_ffe.PRESET_VALUE;\n\t\t\tlink_training_settings.hw_lane_settings[lane].FFE_PRESET.settings.no_preshoot = no_preshoot;\n\t\t\tlink_training_settings.hw_lane_settings[lane].FFE_PRESET.settings.no_deemphasis = no_deemphasis;\n\t\t}\n\t}\n\n\tdp_hw_to_dpcd_lane_settings(&link_training_settings,\n\t\t\tlink_training_settings.hw_lane_settings,\n\t\t\tlink_training_settings.dpcd_lane_settings);\n\t \n\tdp_set_test_pattern(\n\t\tlink,\n\t\ttest_pattern,\n\t\tDP_TEST_PATTERN_COLOR_SPACE_UNDEFINED,\n\t\t&link_training_settings,\n\t\ttest_pattern_buffer,\n\t\ttest_pattern_size);\n}\n\nstatic void set_crtc_test_pattern(struct dc_link *link,\n\t\t\t\tstruct pipe_ctx *pipe_ctx,\n\t\t\t\tenum dp_test_pattern test_pattern,\n\t\t\t\tenum dp_test_pattern_color_space test_pattern_color_space)\n{\n\tenum controller_dp_test_pattern controller_test_pattern;\n\tenum dc_color_depth color_depth = pipe_ctx->\n\t\tstream->timing.display_color_depth;\n\tstruct bit_depth_reduction_params params;\n\tstruct output_pixel_processor *opp = pipe_ctx->stream_res.opp;\n\tstruct pipe_ctx *odm_pipe;\n\tint odm_cnt = 1;\n\tint h_active = pipe_ctx->stream->timing.h_addressable +\n\t\tpipe_ctx->stream->timing.h_border_left +\n\t\tpipe_ctx->stream->timing.h_border_right;\n\tint v_active = pipe_ctx->stream->timing.v_addressable +\n\t\tpipe_ctx->stream->timing.v_border_bottom +\n\t\tpipe_ctx->stream->timing.v_border_top;\n\tint odm_slice_width, last_odm_slice_width, offset = 0;\n\n\tmemset(&params, 0, sizeof(params));\n\n\tfor (odm_pipe = pipe_ctx->next_odm_pipe; odm_pipe; odm_pipe = odm_pipe->next_odm_pipe)\n\t\todm_cnt++;\n\n\todm_slice_width = h_active / odm_cnt;\n\tlast_odm_slice_width = h_active - odm_slice_width * (odm_cnt - 1);\n\n\tswitch (test_pattern) {\n\tcase DP_TEST_PATTERN_COLOR_SQUARES:\n\t\tcontroller_test_pattern =\n\t\t\t\tCONTROLLER_DP_TEST_PATTERN_COLORSQUARES;\n\tbreak;\n\tcase DP_TEST_PATTERN_COLOR_SQUARES_CEA:\n\t\tcontroller_test_pattern =\n\t\t\t\tCONTROLLER_DP_TEST_PATTERN_COLORSQUARES_CEA;\n\tbreak;\n\tcase DP_TEST_PATTERN_VERTICAL_BARS:\n\t\tcontroller_test_pattern =\n\t\t\t\tCONTROLLER_DP_TEST_PATTERN_VERTICALBARS;\n\tbreak;\n\tcase DP_TEST_PATTERN_HORIZONTAL_BARS:\n\t\tcontroller_test_pattern =\n\t\t\t\tCONTROLLER_DP_TEST_PATTERN_HORIZONTALBARS;\n\tbreak;\n\tcase DP_TEST_PATTERN_COLOR_RAMP:\n\t\tcontroller_test_pattern =\n\t\t\t\tCONTROLLER_DP_TEST_PATTERN_COLORRAMP;\n\tbreak;\n\tdefault:\n\t\tcontroller_test_pattern =\n\t\t\t\tCONTROLLER_DP_TEST_PATTERN_VIDEOMODE;\n\tbreak;\n\t}\n\n\tswitch (test_pattern) {\n\tcase DP_TEST_PATTERN_COLOR_SQUARES:\n\tcase DP_TEST_PATTERN_COLOR_SQUARES_CEA:\n\tcase DP_TEST_PATTERN_VERTICAL_BARS:\n\tcase DP_TEST_PATTERN_HORIZONTAL_BARS:\n\tcase DP_TEST_PATTERN_COLOR_RAMP:\n\t{\n\t\t \n\t\tpipe_ctx->stream->bit_depth_params = params;\n\t\tif (pipe_ctx->stream_res.tg->funcs->set_test_pattern) {\n\t\t\topp->funcs->opp_program_bit_depth_reduction(opp, &params);\n\t\t\tpipe_ctx->stream_res.tg->funcs->set_test_pattern(pipe_ctx->stream_res.tg,\n\t\t\t\tcontroller_test_pattern, color_depth);\n\t\t} else if (link->dc->hwss.set_disp_pattern_generator) {\n\t\t\tenum controller_dp_color_space controller_color_space;\n\t\t\tstruct output_pixel_processor *odm_opp;\n\n\t\t\tswitch (test_pattern_color_space) {\n\t\t\tcase DP_TEST_PATTERN_COLOR_SPACE_RGB:\n\t\t\t\tcontroller_color_space = CONTROLLER_DP_COLOR_SPACE_RGB;\n\t\t\t\tbreak;\n\t\t\tcase DP_TEST_PATTERN_COLOR_SPACE_YCBCR601:\n\t\t\t\tcontroller_color_space = CONTROLLER_DP_COLOR_SPACE_YCBCR601;\n\t\t\t\tbreak;\n\t\t\tcase DP_TEST_PATTERN_COLOR_SPACE_YCBCR709:\n\t\t\t\tcontroller_color_space = CONTROLLER_DP_COLOR_SPACE_YCBCR709;\n\t\t\t\tbreak;\n\t\t\tcase DP_TEST_PATTERN_COLOR_SPACE_UNDEFINED:\n\t\t\tdefault:\n\t\t\t\tcontroller_color_space = CONTROLLER_DP_COLOR_SPACE_UDEFINED;\n\t\t\t\tDC_LOG_ERROR(\"%s: Color space must be defined for test pattern\", __func__);\n\t\t\t\tASSERT(0);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\todm_pipe = pipe_ctx;\n\t\t\twhile (odm_pipe->next_odm_pipe) {\n\t\t\t\todm_opp = odm_pipe->stream_res.opp;\n\t\t\t\todm_opp->funcs->opp_program_bit_depth_reduction(odm_opp, &params);\n\t\t\t\tlink->dc->hwss.set_disp_pattern_generator(link->dc,\n\t\t\t\t\t\todm_pipe,\n\t\t\t\t\t\tcontroller_test_pattern,\n\t\t\t\t\t\tcontroller_color_space,\n\t\t\t\t\t\tcolor_depth,\n\t\t\t\t\t\tNULL,\n\t\t\t\t\t\todm_slice_width,\n\t\t\t\t\t\tv_active,\n\t\t\t\t\t\toffset);\n\t\t\t\toffset += odm_slice_width;\n\t\t\t\todm_pipe = odm_pipe->next_odm_pipe;\n\t\t\t}\n\t\t\todm_opp = odm_pipe->stream_res.opp;\n\t\t\todm_opp->funcs->opp_program_bit_depth_reduction(odm_opp, &params);\n\t\t\tlink->dc->hwss.set_disp_pattern_generator(link->dc,\n\t\t\t\t\todm_pipe,\n\t\t\t\t\tcontroller_test_pattern,\n\t\t\t\t\tcontroller_color_space,\n\t\t\t\t\tcolor_depth,\n\t\t\t\t\tNULL,\n\t\t\t\t\tlast_odm_slice_width,\n\t\t\t\t\tv_active,\n\t\t\t\t\toffset);\n\t\t}\n\t}\n\tbreak;\n\tcase DP_TEST_PATTERN_VIDEO_MODE:\n\t{\n\t\t \n\t\tresource_build_bit_depth_reduction_params(pipe_ctx->stream, &params);\n\t\tpipe_ctx->stream->bit_depth_params = params;\n\t\tif (pipe_ctx->stream_res.tg->funcs->set_test_pattern) {\n\t\t\topp->funcs->opp_program_bit_depth_reduction(opp, &params);\n\t\t\tpipe_ctx->stream_res.tg->funcs->set_test_pattern(pipe_ctx->stream_res.tg,\n\t\t\t\t\tCONTROLLER_DP_TEST_PATTERN_VIDEOMODE,\n\t\t\t\t\tcolor_depth);\n\t\t} else if (link->dc->hwss.set_disp_pattern_generator) {\n\t\t\tstruct output_pixel_processor *odm_opp;\n\n\t\t\todm_pipe = pipe_ctx;\n\t\t\twhile (odm_pipe->next_odm_pipe) {\n\t\t\t\todm_opp = odm_pipe->stream_res.opp;\n\t\t\t\todm_opp->funcs->opp_program_bit_depth_reduction(odm_opp, &params);\n\t\t\t\tlink->dc->hwss.set_disp_pattern_generator(link->dc,\n\t\t\t\t\t\todm_pipe,\n\t\t\t\t\t\tCONTROLLER_DP_TEST_PATTERN_VIDEOMODE,\n\t\t\t\t\t\tCONTROLLER_DP_COLOR_SPACE_UDEFINED,\n\t\t\t\t\t\tcolor_depth,\n\t\t\t\t\t\tNULL,\n\t\t\t\t\t\todm_slice_width,\n\t\t\t\t\t\tv_active,\n\t\t\t\t\t\toffset);\n\t\t\t\toffset += odm_slice_width;\n\t\t\t\todm_pipe = odm_pipe->next_odm_pipe;\n\t\t\t}\n\t\t\todm_opp = odm_pipe->stream_res.opp;\n\t\t\todm_opp->funcs->opp_program_bit_depth_reduction(odm_opp, &params);\n\t\t\tlink->dc->hwss.set_disp_pattern_generator(link->dc,\n\t\t\t\t\todm_pipe,\n\t\t\t\t\tCONTROLLER_DP_TEST_PATTERN_VIDEOMODE,\n\t\t\t\t\tCONTROLLER_DP_COLOR_SPACE_UDEFINED,\n\t\t\t\t\tcolor_depth,\n\t\t\t\t\tNULL,\n\t\t\t\t\tlast_odm_slice_width,\n\t\t\t\t\tv_active,\n\t\t\t\t\toffset);\n\t\t}\n\t}\n\tbreak;\n\n\tdefault:\n\tbreak;\n\t}\n}\n\nvoid dp_handle_automated_test(struct dc_link *link)\n{\n\tunion test_request test_request;\n\tunion test_response test_response;\n\n\tmemset(&test_request, 0, sizeof(test_request));\n\tmemset(&test_response, 0, sizeof(test_response));\n\n\tcore_link_read_dpcd(\n\t\tlink,\n\t\tDP_TEST_REQUEST,\n\t\t&test_request.raw,\n\t\tsizeof(union test_request));\n\tif (test_request.bits.LINK_TRAINING) {\n\t\t \n\t\ttest_response.bits.ACK = 1;\n\t\tcore_link_write_dpcd(\n\t\t\tlink,\n\t\t\tDP_TEST_RESPONSE,\n\t\t\t&test_response.raw,\n\t\t\tsizeof(test_response));\n\t\tdp_test_send_link_training(link);\n\t\t \n\t\ttest_response.bits.ACK = 0;\n\t}\n\tif (test_request.bits.LINK_TEST_PATTRN) {\n\t\tunion test_misc dpcd_test_params;\n\t\tunion link_test_pattern dpcd_test_pattern;\n\n\t\tmemset(&dpcd_test_pattern, 0, sizeof(dpcd_test_pattern));\n\t\tmemset(&dpcd_test_params, 0, sizeof(dpcd_test_params));\n\n\t\t \n\t\tcore_link_read_dpcd(\n\t\t\t\tlink,\n\t\t\t\tDP_TEST_PATTERN,\n\t\t\t\t&dpcd_test_pattern.raw,\n\t\t\t\tsizeof(dpcd_test_pattern));\n\t\tcore_link_read_dpcd(\n\t\t\t\tlink,\n\t\t\t\tDP_TEST_MISC0,\n\t\t\t\t&dpcd_test_params.raw,\n\t\t\t\tsizeof(dpcd_test_params));\n\t\ttest_response.bits.ACK = dm_helpers_dp_handle_test_pattern_request(link->ctx, link,\n\t\t\t\tdpcd_test_pattern, dpcd_test_params) ? 1 : 0;\n\t}\n\n\tif (test_request.bits.AUDIO_TEST_PATTERN) {\n\t\tdp_test_get_audio_test_data(link, test_request.bits.TEST_AUDIO_DISABLED_VIDEO);\n\t\ttest_response.bits.ACK = 1;\n\t}\n\n\tif (test_request.bits.PHY_TEST_PATTERN) {\n\t\tdp_test_send_phy_test_pattern(link);\n\t\ttest_response.bits.ACK = 1;\n\t}\n\n\t \n\tif (test_response.bits.ACK)\n\t\tcore_link_write_dpcd(\n\t\t\tlink,\n\t\t\tDP_TEST_RESPONSE,\n\t\t\t&test_response.raw,\n\t\t\tsizeof(test_response));\n}\n\nbool dp_set_test_pattern(\n\tstruct dc_link *link,\n\tenum dp_test_pattern test_pattern,\n\tenum dp_test_pattern_color_space test_pattern_color_space,\n\tconst struct link_training_settings *p_link_settings,\n\tconst unsigned char *p_custom_pattern,\n\tunsigned int cust_pattern_size)\n{\n\tstruct pipe_ctx *pipes = link->dc->current_state->res_ctx.pipe_ctx;\n\tstruct pipe_ctx *pipe_ctx = NULL;\n\tunsigned int lane;\n\tunsigned int i;\n\tunsigned char link_qual_pattern[LANE_COUNT_DP_MAX] = {0};\n\tunion dpcd_training_pattern training_pattern;\n\tenum dpcd_phy_test_patterns pattern;\n\n\tmemset(&training_pattern, 0, sizeof(training_pattern));\n\n\tfor (i = 0; i < MAX_PIPES; i++) {\n\t\tif (pipes[i].stream == NULL)\n\t\t\tcontinue;\n\n\t\tif (resource_is_pipe_type(&pipes[i], OTG_MASTER) &&\n\t\t\t\tpipes[i].stream->link == link) {\n\t\t\tpipe_ctx = &pipes[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (pipe_ctx == NULL)\n\t\treturn false;\n\n\t \n\tif (link->test_pattern_enabled && test_pattern ==\n\t\t\tDP_TEST_PATTERN_VIDEO_MODE) {\n\t\t \n\t\tset_crtc_test_pattern(link, pipe_ctx, test_pattern, test_pattern_color_space);\n\t\tdp_set_hw_test_pattern(link, &pipe_ctx->link_res, test_pattern,\n\t\t\t\t(uint8_t *)p_custom_pattern,\n\t\t\t\t(uint32_t)cust_pattern_size);\n\n\t\t \n\t\tlink->dc->hwss.unblank_stream(\n\t\t\tpipe_ctx,\n\t\t\t&link->verified_link_cap);\n\t\t \n\n\t\t \n\t\tlink->test_pattern_enabled = false;\n\t\tlink->current_test_pattern = test_pattern;\n\n\t\treturn true;\n\t}\n\n\t \n\tif (is_dp_phy_pattern(test_pattern)) {\n\t\t \n\t\tif (p_link_settings != NULL) {\n\t\t\tif ((link->chip_caps & EXT_DISPLAY_PATH_CAPS__DP_FIXED_VS_EN) &&\n\t\t\t\t\tp_link_settings->lttpr_mode == LTTPR_MODE_TRANSPARENT) {\n\t\t\t\tdp_fixed_vs_pe_set_retimer_lane_settings(\n\t\t\t\t\t\tlink,\n\t\t\t\t\t\tp_link_settings->dpcd_lane_settings,\n\t\t\t\t\t\tp_link_settings->link_settings.lane_count);\n\t\t\t} else {\n\t\t\t\tdp_set_hw_lane_settings(link, &pipe_ctx->link_res, p_link_settings, DPRX);\n\t\t\t}\n\t\t\tdpcd_set_lane_settings(link, p_link_settings, DPRX);\n\t\t}\n\n\t\t \n\t\tif (test_pattern != DP_TEST_PATTERN_VIDEO_MODE) {\n\t\t\t \n\t\t\t \n\t\t\tlink->dc->hwss.blank_stream(pipe_ctx);\n\t\t}\n\n\t\tdp_set_hw_test_pattern(link, &pipe_ctx->link_res, test_pattern,\n\t\t\t\t(uint8_t *)p_custom_pattern,\n\t\t\t\t(uint32_t)cust_pattern_size);\n\n\t\tif (test_pattern != DP_TEST_PATTERN_VIDEO_MODE) {\n\t\t\t \n\t\t\tlink->test_pattern_enabled = true;\n\t\t\tlink->current_test_pattern = test_pattern;\n\t\t\tif (p_link_settings != NULL)\n\t\t\t\tdpcd_set_link_settings(link,\n\t\t\t\t\t\tp_link_settings);\n\t\t}\n\n\t\tswitch (test_pattern) {\n\t\tcase DP_TEST_PATTERN_VIDEO_MODE:\n\t\t\tpattern = PHY_TEST_PATTERN_NONE;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_D102:\n\t\t\tpattern = PHY_TEST_PATTERN_D10_2;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_SYMBOL_ERROR:\n\t\t\tpattern = PHY_TEST_PATTERN_SYMBOL_ERROR;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_PRBS7:\n\t\t\tpattern = PHY_TEST_PATTERN_PRBS7;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_80BIT_CUSTOM:\n\t\t\tpattern = PHY_TEST_PATTERN_80BIT_CUSTOM;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_CP2520_1:\n\t\t\tpattern = PHY_TEST_PATTERN_CP2520_1;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_CP2520_2:\n\t\t\tpattern = PHY_TEST_PATTERN_CP2520_2;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_CP2520_3:\n\t\t\tpattern = PHY_TEST_PATTERN_CP2520_3;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_128b_132b_TPS1:\n\t\t\tpattern = PHY_TEST_PATTERN_128b_132b_TPS1;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_128b_132b_TPS2:\n\t\t\tpattern = PHY_TEST_PATTERN_128b_132b_TPS2;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_PRBS9:\n\t\t\tpattern = PHY_TEST_PATTERN_PRBS9;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_PRBS11:\n\t\t\tpattern = PHY_TEST_PATTERN_PRBS11;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_PRBS15:\n\t\t\tpattern = PHY_TEST_PATTERN_PRBS15;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_PRBS23:\n\t\t\tpattern = PHY_TEST_PATTERN_PRBS23;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_PRBS31:\n\t\t\tpattern = PHY_TEST_PATTERN_PRBS31;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_264BIT_CUSTOM:\n\t\t\tpattern = PHY_TEST_PATTERN_264BIT_CUSTOM;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_SQUARE:\n\t\t\tpattern = PHY_TEST_PATTERN_SQUARE;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_SQUARE_PRESHOOT_DISABLED:\n\t\t\tpattern = PHY_TEST_PATTERN_SQUARE_PRESHOOT_DISABLED;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_SQUARE_DEEMPHASIS_DISABLED:\n\t\t\tpattern = PHY_TEST_PATTERN_SQUARE_DEEMPHASIS_DISABLED;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_SQUARE_PRESHOOT_DEEMPHASIS_DISABLED:\n\t\t\tpattern = PHY_TEST_PATTERN_SQUARE_PRESHOOT_DEEMPHASIS_DISABLED;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn false;\n\t\t}\n\n\t\tif (test_pattern == DP_TEST_PATTERN_VIDEO_MODE\n\t\t )\n\t\t\treturn false;\n\n\t\tif (link->dpcd_caps.dpcd_rev.raw >= DPCD_REV_12) {\n\t\t\tif (is_dp_phy_sqaure_pattern(test_pattern))\n\t\t\t\tcore_link_write_dpcd(link,\n\t\t\t\t\t\tDP_LINK_SQUARE_PATTERN,\n\t\t\t\t\t\tp_custom_pattern,\n\t\t\t\t\t\t1);\n\n\t\t\t \n\t\t\tfor (lane = 0; lane < LANE_COUNT_DP_MAX; lane++)\n\t\t\t\tlink_qual_pattern[lane] =\n\t\t\t\t\t\t(unsigned char)(pattern);\n\n\t\t\tcore_link_write_dpcd(link,\n\t\t\t\t\tDP_LINK_QUAL_LANE0_SET,\n\t\t\t\t\tlink_qual_pattern,\n\t\t\t\t\tsizeof(link_qual_pattern));\n\t\t} else if (link->dpcd_caps.dpcd_rev.raw >= DPCD_REV_10 ||\n\t\t\t   link->dpcd_caps.dpcd_rev.raw == 0) {\n\t\t\t \n\t\t\tcore_link_read_dpcd(link, DP_TRAINING_PATTERN_SET,\n\t\t\t\t\t    &training_pattern.raw,\n\t\t\t\t\t    sizeof(training_pattern));\n\t\t\ttraining_pattern.v1_3.LINK_QUAL_PATTERN_SET = pattern;\n\t\t\tcore_link_write_dpcd(link, DP_TRAINING_PATTERN_SET,\n\t\t\t\t\t     &training_pattern.raw,\n\t\t\t\t\t     sizeof(training_pattern));\n\t\t}\n\t} else {\n\t\tenum dc_color_space color_space = COLOR_SPACE_UNKNOWN;\n\n\t\tswitch (test_pattern_color_space) {\n\t\tcase DP_TEST_PATTERN_COLOR_SPACE_RGB:\n\t\t\tcolor_space = COLOR_SPACE_SRGB;\n\t\t\tif (test_pattern == DP_TEST_PATTERN_COLOR_SQUARES_CEA)\n\t\t\t\tcolor_space = COLOR_SPACE_SRGB_LIMITED;\n\t\t\tbreak;\n\n\t\tcase DP_TEST_PATTERN_COLOR_SPACE_YCBCR601:\n\t\t\tcolor_space = COLOR_SPACE_YCBCR601;\n\t\t\tif (test_pattern == DP_TEST_PATTERN_COLOR_SQUARES_CEA)\n\t\t\t\tcolor_space = COLOR_SPACE_YCBCR601_LIMITED;\n\t\t\tbreak;\n\t\tcase DP_TEST_PATTERN_COLOR_SPACE_YCBCR709:\n\t\t\tcolor_space = COLOR_SPACE_YCBCR709;\n\t\t\tif (test_pattern == DP_TEST_PATTERN_COLOR_SQUARES_CEA)\n\t\t\t\tcolor_space = COLOR_SPACE_YCBCR709_LIMITED;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tif (pipe_ctx->stream_res.tg->funcs->lock_doublebuffer_enable) {\n\t\t\tif (pipe_ctx->stream && should_use_dmub_lock(pipe_ctx->stream->link)) {\n\t\t\t\tunion dmub_hw_lock_flags hw_locks = { 0 };\n\t\t\t\tstruct dmub_hw_lock_inst_flags inst_flags = { 0 };\n\n\t\t\t\thw_locks.bits.lock_dig = 1;\n\t\t\t\tinst_flags.dig_inst = pipe_ctx->stream_res.tg->inst;\n\n\t\t\t\tdmub_hw_lock_mgr_cmd(link->ctx->dmub_srv,\n\t\t\t\t\t\t\ttrue,\n\t\t\t\t\t\t\t&hw_locks,\n\t\t\t\t\t\t\t&inst_flags);\n\t\t\t} else\n\t\t\t\tpipe_ctx->stream_res.tg->funcs->lock_doublebuffer_enable(\n\t\t\t\t\t\tpipe_ctx->stream_res.tg);\n\t\t}\n\n\t\tpipe_ctx->stream_res.tg->funcs->lock(pipe_ctx->stream_res.tg);\n\t\t \n\t\tpipe_ctx->stream_res.stream_enc->funcs->dp_set_stream_attribute(pipe_ctx->stream_res.stream_enc,\n\t\t\t\t&pipe_ctx->stream->timing,\n\t\t\t\tcolor_space,\n\t\t\t\tpipe_ctx->stream->use_vsc_sdp_for_colorimetry,\n\t\t\t\tlink->dpcd_caps.dprx_feature.bits.SST_SPLIT_SDP_CAP);\n\n\t\tif (pipe_ctx->stream->use_vsc_sdp_for_colorimetry) {\n\t\t\tif (test_pattern == DP_TEST_PATTERN_COLOR_SQUARES_CEA)\n\t\t\t\tpipe_ctx->stream->vsc_infopacket.sb[17] |= (1 << 7); \n\t\t\telse\n\t\t\t\tpipe_ctx->stream->vsc_infopacket.sb[17] &= ~(1 << 7);\n\t\t\tresource_build_info_frame(pipe_ctx);\n\t\t\tlink->dc->hwss.update_info_frame(pipe_ctx);\n\t\t}\n\n\t\t \n\t\tset_crtc_test_pattern(link, pipe_ctx, test_pattern, test_pattern_color_space);\n\t\tpipe_ctx->stream_res.tg->funcs->unlock(pipe_ctx->stream_res.tg);\n\t\tpipe_ctx->stream_res.tg->funcs->wait_for_state(pipe_ctx->stream_res.tg,\n\t\t\t\tCRTC_STATE_VACTIVE);\n\t\tpipe_ctx->stream_res.tg->funcs->wait_for_state(pipe_ctx->stream_res.tg,\n\t\t\t\tCRTC_STATE_VBLANK);\n\t\tpipe_ctx->stream_res.tg->funcs->wait_for_state(pipe_ctx->stream_res.tg,\n\t\t\t\tCRTC_STATE_VACTIVE);\n\n\t\tif (pipe_ctx->stream_res.tg->funcs->lock_doublebuffer_disable) {\n\t\t\tif (pipe_ctx->stream && should_use_dmub_lock(pipe_ctx->stream->link)) {\n\t\t\t\tunion dmub_hw_lock_flags hw_locks = { 0 };\n\t\t\t\tstruct dmub_hw_lock_inst_flags inst_flags = { 0 };\n\n\t\t\t\thw_locks.bits.lock_dig = 1;\n\t\t\t\tinst_flags.dig_inst = pipe_ctx->stream_res.tg->inst;\n\n\t\t\t\tdmub_hw_lock_mgr_cmd(link->ctx->dmub_srv,\n\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t&hw_locks,\n\t\t\t\t\t\t\t&inst_flags);\n\t\t\t} else\n\t\t\t\tpipe_ctx->stream_res.tg->funcs->lock_doublebuffer_disable(\n\t\t\t\t\t\tpipe_ctx->stream_res.tg);\n\t\t}\n\n\t\t \n\t\tlink->test_pattern_enabled = true;\n\t\tlink->current_test_pattern = test_pattern;\n\t}\n\n\treturn true;\n}\n\nvoid dp_set_preferred_link_settings(struct dc *dc,\n\t\tstruct dc_link_settings *link_setting,\n\t\tstruct dc_link *link)\n{\n\tint i;\n\tstruct pipe_ctx *pipe;\n\tstruct dc_stream_state *link_stream;\n\tstruct dc_link_settings store_settings = *link_setting;\n\n\tlink->preferred_link_setting = store_settings;\n\n\t \n\tif (!dc_is_dp_signal(link->connector_signal) ||\n\t\tlink->dongle_max_pix_clk > 0)\n\t\treturn;\n\n\tfor (i = 0; i < MAX_PIPES; i++) {\n\t\tpipe = &dc->current_state->res_ctx.pipe_ctx[i];\n\t\tif (pipe->stream && pipe->stream->link) {\n\t\t\tif (pipe->stream->link == link) {\n\t\t\t\tlink_stream = pipe->stream;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tif (i == MAX_PIPES)\n\t\treturn;\n\n\t \n\tif (link_stream->dpms_off)\n\t\treturn;\n\n\tif (link_decide_link_settings(link_stream, &store_settings))\n\t\tdp_retrain_link_dp_test(link, &store_settings, false);\n}\n\nvoid dp_set_preferred_training_settings(struct dc *dc,\n\t\tstruct dc_link_settings *link_setting,\n\t\tstruct dc_link_training_overrides *lt_overrides,\n\t\tstruct dc_link *link,\n\t\tbool skip_immediate_retrain)\n{\n\tif (lt_overrides != NULL)\n\t\tlink->preferred_training_settings = *lt_overrides;\n\telse\n\t\tmemset(&link->preferred_training_settings, 0, sizeof(link->preferred_training_settings));\n\n\tif (link_setting != NULL) {\n\t\tlink->preferred_link_setting = *link_setting;\n\t} else {\n\t\tlink->preferred_link_setting.lane_count = LANE_COUNT_UNKNOWN;\n\t\tlink->preferred_link_setting.link_rate = LINK_RATE_UNKNOWN;\n\t}\n\n\tif (link->connector_signal == SIGNAL_TYPE_DISPLAY_PORT &&\n\t\t\tlink->type == dc_connection_mst_branch)\n\t\tdm_helpers_dp_mst_update_branch_bandwidth(dc->ctx, link);\n\n\t \n\tif (skip_immediate_retrain == false)\n\t\tdp_set_preferred_link_settings(dc, &link->preferred_link_setting, link);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}