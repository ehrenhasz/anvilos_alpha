{
  "module_name": "display_mode_vba_20.c",
  "hash_id": "277309b87ecff169784944a2ae8974b2da4f2f0913b86a1093252742d1c482df",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dml/dcn20/display_mode_vba_20.c",
  "human_readable_source": " \n\n#include \"../display_mode_lib.h\"\n#include \"display_mode_vba_20.h\"\n#include \"../dml_inline_defs.h\"\n\n \n\n#define BPP_INVALID 0\n#define BPP_BLENDED_PIPE 0xffffffff\n#define DCN20_MAX_420_IMAGE_WIDTH 4096\n\nstatic double adjust_ReturnBW(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble ReturnBW,\n\t\tbool DCCEnabledAnyPlane,\n\t\tdouble ReturnBandwidthToDCN);\nstatic unsigned int dscceComputeDelay(\n\t\tunsigned int bpc,\n\t\tdouble bpp,\n\t\tunsigned int sliceWidth,\n\t\tunsigned int numSlices,\n\t\tenum output_format_class pixelFormat);\nstatic unsigned int dscComputeDelay(enum output_format_class pixelFormat);\n \nstatic bool CalculatePrefetchSchedule(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble DPPCLK,\n\t\tdouble DISPCLK,\n\t\tdouble PixelClock,\n\t\tdouble DCFCLKDeepSleep,\n\t\tunsigned int DSCDelay,\n\t\tunsigned int DPPPerPlane,\n\t\tbool ScalerEnabled,\n\t\tunsigned int NumberOfCursors,\n\t\tdouble DPPCLKDelaySubtotal,\n\t\tdouble DPPCLKDelaySCL,\n\t\tdouble DPPCLKDelaySCLLBOnly,\n\t\tdouble DPPCLKDelayCNVCFormater,\n\t\tdouble DPPCLKDelayCNVCCursor,\n\t\tdouble DISPCLKDelaySubtotal,\n\t\tunsigned int ScalerRecoutWidth,\n\t\tenum output_format_class OutputFormat,\n\t\tunsigned int VBlank,\n\t\tunsigned int HTotal,\n\t\tunsigned int MaxInterDCNTileRepeaters,\n\t\tunsigned int VStartup,\n\t\tunsigned int PageTableLevels,\n\t\tbool GPUVMEnable,\n\t\tbool DynamicMetadataEnable,\n\t\tunsigned int DynamicMetadataLinesBeforeActiveRequired,\n\t\tunsigned int DynamicMetadataTransmittedBytes,\n\t\tbool DCCEnable,\n\t\tdouble UrgentLatencyPixelDataOnly,\n\t\tdouble UrgentExtraLatency,\n\t\tdouble TCalc,\n\t\tunsigned int PDEAndMetaPTEBytesFrame,\n\t\tunsigned int MetaRowByte,\n\t\tunsigned int PixelPTEBytesPerRow,\n\t\tdouble PrefetchSourceLinesY,\n\t\tunsigned int SwathWidthY,\n\t\tdouble BytePerPixelDETY,\n\t\tdouble VInitPreFillY,\n\t\tunsigned int MaxNumSwathY,\n\t\tdouble PrefetchSourceLinesC,\n\t\tdouble BytePerPixelDETC,\n\t\tdouble VInitPreFillC,\n\t\tunsigned int MaxNumSwathC,\n\t\tunsigned int SwathHeightY,\n\t\tunsigned int SwathHeightC,\n\t\tdouble TWait,\n\t\tbool XFCEnabled,\n\t\tdouble XFCRemoteSurfaceFlipDelay,\n\t\tbool InterlaceEnable,\n\t\tbool ProgressiveToInterlaceUnitInOPP,\n\t\tdouble *DSTXAfterScaler,\n\t\tdouble *DSTYAfterScaler,\n\t\tdouble *DestinationLinesForPrefetch,\n\t\tdouble *PrefetchBandwidth,\n\t\tdouble *DestinationLinesToRequestVMInVBlank,\n\t\tdouble *DestinationLinesToRequestRowInVBlank,\n\t\tdouble *VRatioPrefetchY,\n\t\tdouble *VRatioPrefetchC,\n\t\tdouble *RequiredPrefetchPixDataBW,\n\t\tunsigned int *VStartupRequiredWhenNotEnoughTimeForDynamicMetadata,\n\t\tdouble *Tno_bw,\n\t\tunsigned int *VUpdateOffsetPix,\n\t\tdouble *VUpdateWidthPix,\n\t\tdouble *VReadyOffsetPix);\nstatic double RoundToDFSGranularityUp(double Clock, double VCOSpeed);\nstatic double RoundToDFSGranularityDown(double Clock, double VCOSpeed);\nstatic double CalculatePrefetchSourceLines(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble VRatio,\n\t\tdouble vtaps,\n\t\tbool Interlace,\n\t\tbool ProgressiveToInterlaceUnitInOPP,\n\t\tunsigned int SwathHeight,\n\t\tunsigned int ViewportYStart,\n\t\tdouble *VInitPreFill,\n\t\tunsigned int *MaxNumSwath);\nstatic unsigned int CalculateVMAndRowBytes(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tbool DCCEnable,\n\t\tunsigned int BlockHeight256Bytes,\n\t\tunsigned int BlockWidth256Bytes,\n\t\tenum source_format_class SourcePixelFormat,\n\t\tunsigned int SurfaceTiling,\n\t\tunsigned int BytePerPixel,\n\t\tenum scan_direction_class ScanDirection,\n\t\tunsigned int ViewportWidth,\n\t\tunsigned int ViewportHeight,\n\t\tunsigned int SwathWidthY,\n\t\tbool GPUVMEnable,\n\t\tunsigned int VMMPageSize,\n\t\tunsigned int PTEBufferSizeInRequestsLuma,\n\t\tunsigned int PDEProcessingBufIn64KBReqs,\n\t\tunsigned int Pitch,\n\t\tunsigned int DCCMetaPitch,\n\t\tunsigned int *MacroTileWidth,\n\t\tunsigned int *MetaRowByte,\n\t\tunsigned int *PixelPTEBytesPerRow,\n\t\tbool *PTEBufferSizeNotExceeded,\n\t\tunsigned int *dpte_row_height,\n\t\tunsigned int *meta_row_height);\nstatic double CalculateTWait(\n\t\tunsigned int PrefetchMode,\n\t\tdouble DRAMClockChangeLatency,\n\t\tdouble UrgentLatencyPixelDataOnly,\n\t\tdouble SREnterPlusExitTime);\nstatic double CalculateRemoteSurfaceFlipDelay(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble VRatio,\n\t\tdouble SwathWidth,\n\t\tdouble Bpp,\n\t\tdouble LineTime,\n\t\tdouble XFCTSlvVupdateOffset,\n\t\tdouble XFCTSlvVupdateWidth,\n\t\tdouble XFCTSlvVreadyOffset,\n\t\tdouble XFCXBUFLatencyTolerance,\n\t\tdouble XFCFillBWOverhead,\n\t\tdouble XFCSlvChunkSize,\n\t\tdouble XFCBusTransportTime,\n\t\tdouble TCalc,\n\t\tdouble TWait,\n\t\tdouble *SrcActiveDrainRate,\n\t\tdouble *TInitXFill,\n\t\tdouble *TslvChk);\nstatic void CalculateActiveRowBandwidth(\n\t\tbool GPUVMEnable,\n\t\tenum source_format_class SourcePixelFormat,\n\t\tdouble VRatio,\n\t\tbool DCCEnable,\n\t\tdouble LineTime,\n\t\tunsigned int MetaRowByteLuma,\n\t\tunsigned int MetaRowByteChroma,\n\t\tunsigned int meta_row_height_luma,\n\t\tunsigned int meta_row_height_chroma,\n\t\tunsigned int PixelPTEBytesPerRowLuma,\n\t\tunsigned int PixelPTEBytesPerRowChroma,\n\t\tunsigned int dpte_row_height_luma,\n\t\tunsigned int dpte_row_height_chroma,\n\t\tdouble *meta_row_bw,\n\t\tdouble *dpte_row_bw,\n\t\tdouble *qual_row_bw);\nstatic void CalculateFlipSchedule(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble UrgentExtraLatency,\n\t\tdouble UrgentLatencyPixelDataOnly,\n\t\tunsigned int GPUVMMaxPageTableLevels,\n\t\tbool GPUVMEnable,\n\t\tdouble BandwidthAvailableForImmediateFlip,\n\t\tunsigned int TotImmediateFlipBytes,\n\t\tenum source_format_class SourcePixelFormat,\n\t\tunsigned int ImmediateFlipBytes,\n\t\tdouble LineTime,\n\t\tdouble VRatio,\n\t\tdouble Tno_bw,\n\t\tdouble PDEAndMetaPTEBytesFrame,\n\t\tunsigned int MetaRowByte,\n\t\tunsigned int PixelPTEBytesPerRow,\n\t\tbool DCCEnable,\n\t\tunsigned int dpte_row_height,\n\t\tunsigned int meta_row_height,\n\t\tdouble qual_row_bw,\n\t\tdouble *DestinationLinesToRequestVMInImmediateFlip,\n\t\tdouble *DestinationLinesToRequestRowInImmediateFlip,\n\t\tdouble *final_flip_bw,\n\t\tbool *ImmediateFlipSupportedForPipe);\nstatic double CalculateWriteBackDelay(\n\t\tenum source_format_class WritebackPixelFormat,\n\t\tdouble WritebackHRatio,\n\t\tdouble WritebackVRatio,\n\t\tunsigned int WritebackLumaHTaps,\n\t\tunsigned int WritebackLumaVTaps,\n\t\tunsigned int WritebackChromaHTaps,\n\t\tunsigned int WritebackChromaVTaps,\n\t\tunsigned int WritebackDestinationWidth);\n\nstatic void dml20_DisplayPipeConfiguration(struct display_mode_lib *mode_lib);\nstatic void dml20_DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation(\n\t\tstruct display_mode_lib *mode_lib);\n\nvoid dml20_recalculate(struct display_mode_lib *mode_lib)\n{\n\tModeSupportAndSystemConfiguration(mode_lib);\n\tmode_lib->vba.FabricAndDRAMBandwidth = dml_min(\n\t\tmode_lib->vba.DRAMSpeed * mode_lib->vba.NumberOfChannels * mode_lib->vba.DRAMChannelWidth,\n\t\tmode_lib->vba.FabricClock * mode_lib->vba.FabricDatapathToDCNDataReturn) / 1000.0;\n\tPixelClockAdjustmentForProgressiveToInterlaceUnit(mode_lib);\n\tdml20_DisplayPipeConfiguration(mode_lib);\n\tdml20_DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation(mode_lib);\n}\n\nstatic double adjust_ReturnBW(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble ReturnBW,\n\t\tbool DCCEnabledAnyPlane,\n\t\tdouble ReturnBandwidthToDCN)\n{\n\tdouble CriticalCompression;\n\n\tif (DCCEnabledAnyPlane\n\t\t\t&& ReturnBandwidthToDCN\n\t\t\t\t\t> mode_lib->vba.DCFCLK * mode_lib->vba.ReturnBusWidth / 4.0)\n\t\tReturnBW =\n\t\t\t\tdml_min(\n\t\t\t\t\t\tReturnBW,\n\t\t\t\t\t\tReturnBandwidthToDCN * 4\n\t\t\t\t\t\t\t\t* (1.0\n\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.UrgentLatencyPixelDataOnly\n\t\t\t\t\t\t\t\t\t\t\t\t/ ((mode_lib->vba.ROBBufferSizeInKByte\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.PixelChunkSizeInKByte)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t* 1024\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ ReturnBandwidthToDCN\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.DCFCLK\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.ReturnBusWidth\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 4)\n\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.UrgentLatencyPixelDataOnly));\n\n\tCriticalCompression = 2.0 * mode_lib->vba.ReturnBusWidth * mode_lib->vba.DCFCLK\n\t\t\t* mode_lib->vba.UrgentLatencyPixelDataOnly\n\t\t\t/ (ReturnBandwidthToDCN * mode_lib->vba.UrgentLatencyPixelDataOnly\n\t\t\t\t\t+ (mode_lib->vba.ROBBufferSizeInKByte\n\t\t\t\t\t\t\t- mode_lib->vba.PixelChunkSizeInKByte)\n\t\t\t\t\t\t\t* 1024);\n\n\tif (DCCEnabledAnyPlane && CriticalCompression > 1.0 && CriticalCompression < 4.0)\n\t\tReturnBW =\n\t\t\t\tdml_min(\n\t\t\t\t\t\tReturnBW,\n\t\t\t\t\t\t4.0 * ReturnBandwidthToDCN\n\t\t\t\t\t\t\t\t* (mode_lib->vba.ROBBufferSizeInKByte\n\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.PixelChunkSizeInKByte)\n\t\t\t\t\t\t\t\t* 1024\n\t\t\t\t\t\t\t\t* mode_lib->vba.ReturnBusWidth\n\t\t\t\t\t\t\t\t* mode_lib->vba.DCFCLK\n\t\t\t\t\t\t\t\t* mode_lib->vba.UrgentLatencyPixelDataOnly\n\t\t\t\t\t\t\t\t/ dml_pow(\n\t\t\t\t\t\t\t\t\t\t(ReturnBandwidthToDCN\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.UrgentLatencyPixelDataOnly\n\t\t\t\t\t\t\t\t\t\t\t\t+ (mode_lib->vba.ROBBufferSizeInKByte\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.PixelChunkSizeInKByte)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t* 1024),\n\t\t\t\t\t\t\t\t\t\t2));\n\n\treturn ReturnBW;\n}\n\nstatic unsigned int dscceComputeDelay(\n\t\tunsigned int bpc,\n\t\tdouble bpp,\n\t\tunsigned int sliceWidth,\n\t\tunsigned int numSlices,\n\t\tenum output_format_class pixelFormat)\n{\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\n\t \n\tunsigned int rcModelSize = 8192;\n\n\t \n\tunsigned int pixelsPerClock, lstall, D, initalXmitDelay, w, s, ix, wx, p, l0, a, ax, l,\n\t\t\tDelay, pixels;\n\n\tif (pixelFormat == dm_n422 || pixelFormat == dm_420)\n\t\tpixelsPerClock = 2;\n\t \n\telse\n\t\tpixelsPerClock = 1;\n\n\t \n\tinitalXmitDelay = dml_round(rcModelSize / 2.0 / bpp / pixelsPerClock);\n\n\t \n\tif (bpc == 8)\n\t\tD = 81;\n\telse if (bpc == 10)\n\t\tD = 89;\n\telse\n\t\tD = 113;\n\n\t \n\tw = sliceWidth / pixelsPerClock;\n\n\t \n\tif (pixelFormat == dm_s422)\n\t\ts = 1;\n\telse\n\t\ts = 0;\n\n\t \n\tix = initalXmitDelay + 45;\n\twx = (w + 2) / 3;\n\tp = 3 * wx - w;\n\tl0 = ix / w;\n\ta = ix + p * l0;\n\tax = (a + 2) / 3 + D + 6 + 1;\n\tl = (ax + wx - 1) / wx;\n\tif ((ix % w) == 0 && p != 0)\n\t\tlstall = 1;\n\telse\n\t\tlstall = 0;\n\tDelay = l * wx * (numSlices - 1) + ax + s + lstall + 22;\n\n\t \n\tpixels = Delay * 3 * pixelsPerClock;\n\treturn pixels;\n}\n\nstatic unsigned int dscComputeDelay(enum output_format_class pixelFormat)\n{\n\tunsigned int Delay = 0;\n\n\tif (pixelFormat == dm_420) {\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 0;\n\t\t \n\t\tDelay = Delay + 3;\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 12;\n\t\t \n\t\tDelay = Delay + 13;\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 7;\n\t\t \n\t\tDelay = Delay + 3;\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 1;\n\t\t \n\t\tDelay = Delay + 1;\n\t} else if (pixelFormat == dm_n422) {\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 1;\n\t\t \n\t\tDelay = Delay + 5;\n\t\t \n\t\tDelay = Delay + 25;\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 10;\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 1;\n\t\t \n\t\tDelay = Delay + 1;\n\t} else {\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 0;\n\t\t \n\t\tDelay = Delay + 3;\n\t\t \n\t\tDelay = Delay + 12;\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 7;\n\t\t \n\t\tDelay = Delay + 1;\n\t\t \n\t\tDelay = Delay + 2;\n\t\t \n\t\tDelay = Delay + 1;\n\t}\n\n\treturn Delay;\n}\n\nstatic bool CalculatePrefetchSchedule(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble DPPCLK,\n\t\tdouble DISPCLK,\n\t\tdouble PixelClock,\n\t\tdouble DCFCLKDeepSleep,\n\t\tunsigned int DSCDelay,\n\t\tunsigned int DPPPerPlane,\n\t\tbool ScalerEnabled,\n\t\tunsigned int NumberOfCursors,\n\t\tdouble DPPCLKDelaySubtotal,\n\t\tdouble DPPCLKDelaySCL,\n\t\tdouble DPPCLKDelaySCLLBOnly,\n\t\tdouble DPPCLKDelayCNVCFormater,\n\t\tdouble DPPCLKDelayCNVCCursor,\n\t\tdouble DISPCLKDelaySubtotal,\n\t\tunsigned int ScalerRecoutWidth,\n\t\tenum output_format_class OutputFormat,\n\t\tunsigned int VBlank,\n\t\tunsigned int HTotal,\n\t\tunsigned int MaxInterDCNTileRepeaters,\n\t\tunsigned int VStartup,\n\t\tunsigned int PageTableLevels,\n\t\tbool GPUVMEnable,\n\t\tbool DynamicMetadataEnable,\n\t\tunsigned int DynamicMetadataLinesBeforeActiveRequired,\n\t\tunsigned int DynamicMetadataTransmittedBytes,\n\t\tbool DCCEnable,\n\t\tdouble UrgentLatencyPixelDataOnly,\n\t\tdouble UrgentExtraLatency,\n\t\tdouble TCalc,\n\t\tunsigned int PDEAndMetaPTEBytesFrame,\n\t\tunsigned int MetaRowByte,\n\t\tunsigned int PixelPTEBytesPerRow,\n\t\tdouble PrefetchSourceLinesY,\n\t\tunsigned int SwathWidthY,\n\t\tdouble BytePerPixelDETY,\n\t\tdouble VInitPreFillY,\n\t\tunsigned int MaxNumSwathY,\n\t\tdouble PrefetchSourceLinesC,\n\t\tdouble BytePerPixelDETC,\n\t\tdouble VInitPreFillC,\n\t\tunsigned int MaxNumSwathC,\n\t\tunsigned int SwathHeightY,\n\t\tunsigned int SwathHeightC,\n\t\tdouble TWait,\n\t\tbool XFCEnabled,\n\t\tdouble XFCRemoteSurfaceFlipDelay,\n\t\tbool InterlaceEnable,\n\t\tbool ProgressiveToInterlaceUnitInOPP,\n\t\tdouble *DSTXAfterScaler,\n\t\tdouble *DSTYAfterScaler,\n\t\tdouble *DestinationLinesForPrefetch,\n\t\tdouble *PrefetchBandwidth,\n\t\tdouble *DestinationLinesToRequestVMInVBlank,\n\t\tdouble *DestinationLinesToRequestRowInVBlank,\n\t\tdouble *VRatioPrefetchY,\n\t\tdouble *VRatioPrefetchC,\n\t\tdouble *RequiredPrefetchPixDataBW,\n\t\tunsigned int *VStartupRequiredWhenNotEnoughTimeForDynamicMetadata,\n\t\tdouble *Tno_bw,\n\t\tunsigned int *VUpdateOffsetPix,\n\t\tdouble *VUpdateWidthPix,\n\t\tdouble *VReadyOffsetPix)\n{\n\tbool MyError = false;\n\tunsigned int DPPCycles, DISPCLKCycles;\n\tdouble DSTTotalPixelsAfterScaler, TotalRepeaterDelayTime;\n\tdouble Tdm, LineTime, Tsetup;\n\tdouble dst_y_prefetch_equ;\n\tdouble Tsw_oto;\n\tdouble prefetch_bw_oto;\n\tdouble Tvm_oto;\n\tdouble Tr0_oto;\n\tdouble Tpre_oto;\n\tdouble dst_y_prefetch_oto;\n\tdouble TimeForFetchingMetaPTE = 0;\n\tdouble TimeForFetchingRowInVBlank = 0;\n\tdouble LinesToRequestPrefetchPixelData = 0;\n\n\tif (ScalerEnabled)\n\t\tDPPCycles = DPPCLKDelaySubtotal + DPPCLKDelaySCL;\n\telse\n\t\tDPPCycles = DPPCLKDelaySubtotal + DPPCLKDelaySCLLBOnly;\n\n\tDPPCycles = DPPCycles + DPPCLKDelayCNVCFormater + NumberOfCursors * DPPCLKDelayCNVCCursor;\n\n\tDISPCLKCycles = DISPCLKDelaySubtotal;\n\n\tif (DPPCLK == 0.0 || DISPCLK == 0.0)\n\t\treturn true;\n\n\t*DSTXAfterScaler = DPPCycles * PixelClock / DPPCLK + DISPCLKCycles * PixelClock / DISPCLK\n\t\t\t+ DSCDelay;\n\n\tif (DPPPerPlane > 1)\n\t\t*DSTXAfterScaler = *DSTXAfterScaler + ScalerRecoutWidth;\n\n\tif (OutputFormat == dm_420 || (InterlaceEnable && ProgressiveToInterlaceUnitInOPP))\n\t\t*DSTYAfterScaler = 1;\n\telse\n\t\t*DSTYAfterScaler = 0;\n\n\tDSTTotalPixelsAfterScaler = ((double) (*DSTYAfterScaler * HTotal)) + *DSTXAfterScaler;\n\t*DSTYAfterScaler = dml_floor(DSTTotalPixelsAfterScaler / HTotal, 1);\n\t*DSTXAfterScaler = DSTTotalPixelsAfterScaler - ((double) (*DSTYAfterScaler * HTotal));\n\n\t*VUpdateOffsetPix = dml_ceil(HTotal / 4.0, 1);\n\tTotalRepeaterDelayTime = MaxInterDCNTileRepeaters * (2.0 / DPPCLK + 3.0 / DISPCLK);\n\t*VUpdateWidthPix = (14.0 / DCFCLKDeepSleep + 12.0 / DPPCLK + TotalRepeaterDelayTime)\n\t\t\t* PixelClock;\n\n\t*VReadyOffsetPix = dml_max(\n\t\t\t150.0 / DPPCLK,\n\t\t\tTotalRepeaterDelayTime + 20.0 / DCFCLKDeepSleep + 10.0 / DPPCLK)\n\t\t\t* PixelClock;\n\n\tTsetup = (double) (*VUpdateOffsetPix + *VUpdateWidthPix + *VReadyOffsetPix) / PixelClock;\n\n\tLineTime = (double) HTotal / PixelClock;\n\n\tif (DynamicMetadataEnable) {\n\t\tdouble Tdmbf, Tdmec, Tdmsks;\n\n\t\tTdm = dml_max(0.0, UrgentExtraLatency - TCalc);\n\t\tTdmbf = DynamicMetadataTransmittedBytes / 4.0 / DISPCLK;\n\t\tTdmec = LineTime;\n\t\tif (DynamicMetadataLinesBeforeActiveRequired == 0)\n\t\t\tTdmsks = VBlank * LineTime / 2.0;\n\t\telse\n\t\t\tTdmsks = DynamicMetadataLinesBeforeActiveRequired * LineTime;\n\t\tif (InterlaceEnable && !ProgressiveToInterlaceUnitInOPP)\n\t\t\tTdmsks = Tdmsks / 2;\n\t\tif (VStartup * LineTime\n\t\t\t\t< Tsetup + TWait + UrgentExtraLatency + Tdmbf + Tdmec + Tdmsks) {\n\t\t\tMyError = true;\n\t\t\t*VStartupRequiredWhenNotEnoughTimeForDynamicMetadata = (Tsetup + TWait\n\t\t\t\t\t+ UrgentExtraLatency + Tdmbf + Tdmec + Tdmsks) / LineTime;\n\t\t} else\n\t\t\t*VStartupRequiredWhenNotEnoughTimeForDynamicMetadata = 0.0;\n\t} else\n\t\tTdm = 0;\n\n\tif (GPUVMEnable) {\n\t\tif (PageTableLevels == 4)\n\t\t\t*Tno_bw = UrgentExtraLatency + UrgentLatencyPixelDataOnly;\n\t\telse if (PageTableLevels == 3)\n\t\t\t*Tno_bw = UrgentExtraLatency;\n\t\telse\n\t\t\t*Tno_bw = 0;\n\t} else if (DCCEnable)\n\t\t*Tno_bw = LineTime;\n\telse\n\t\t*Tno_bw = LineTime / 4;\n\n\tdst_y_prefetch_equ = VStartup - dml_max(TCalc + TWait, XFCRemoteSurfaceFlipDelay) / LineTime\n\t\t\t- (Tsetup + Tdm) / LineTime\n\t\t\t- (*DSTYAfterScaler + *DSTXAfterScaler / HTotal);\n\n\tTsw_oto = dml_max(PrefetchSourceLinesY, PrefetchSourceLinesC) * LineTime;\n\n\tprefetch_bw_oto = (MetaRowByte + PixelPTEBytesPerRow\n\t\t\t+ PrefetchSourceLinesY * SwathWidthY * dml_ceil(BytePerPixelDETY, 1)\n\t\t\t+ PrefetchSourceLinesC * SwathWidthY / 2 * dml_ceil(BytePerPixelDETC, 2))\n\t\t\t/ Tsw_oto;\n\n\tif (GPUVMEnable == true) {\n\t\tTvm_oto =\n\t\t\t\tdml_max(\n\t\t\t\t\t\t*Tno_bw + PDEAndMetaPTEBytesFrame / prefetch_bw_oto,\n\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\tUrgentExtraLatency\n\t\t\t\t\t\t\t\t\t\t+ UrgentLatencyPixelDataOnly\n\t\t\t\t\t\t\t\t\t\t\t\t* (PageTableLevels\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 1),\n\t\t\t\t\t\t\t\tLineTime / 4.0));\n\t} else\n\t\tTvm_oto = LineTime / 4.0;\n\n\tif ((GPUVMEnable == true || DCCEnable == true)) {\n\t\tTr0_oto = dml_max(\n\t\t\t\t(MetaRowByte + PixelPTEBytesPerRow) / prefetch_bw_oto,\n\t\t\t\tdml_max(UrgentLatencyPixelDataOnly, dml_max(LineTime - Tvm_oto, LineTime / 4)));\n\t} else\n\t\tTr0_oto = LineTime - Tvm_oto;\n\n\tTpre_oto = Tvm_oto + Tr0_oto + Tsw_oto;\n\n\tdst_y_prefetch_oto = Tpre_oto / LineTime;\n\n\tif (dst_y_prefetch_oto < dst_y_prefetch_equ)\n\t\t*DestinationLinesForPrefetch = dst_y_prefetch_oto;\n\telse\n\t\t*DestinationLinesForPrefetch = dst_y_prefetch_equ;\n\n\t*DestinationLinesForPrefetch = dml_floor(4.0 * (*DestinationLinesForPrefetch + 0.125), 1)\n\t\t\t/ 4;\n\n\tdml_print(\"DML: VStartup: %d\\n\", VStartup);\n\tdml_print(\"DML: TCalc: %f\\n\", TCalc);\n\tdml_print(\"DML: TWait: %f\\n\", TWait);\n\tdml_print(\"DML: XFCRemoteSurfaceFlipDelay: %f\\n\", XFCRemoteSurfaceFlipDelay);\n\tdml_print(\"DML: LineTime: %f\\n\", LineTime);\n\tdml_print(\"DML: Tsetup: %f\\n\", Tsetup);\n\tdml_print(\"DML: Tdm: %f\\n\", Tdm);\n\tdml_print(\"DML: DSTYAfterScaler: %f\\n\", *DSTYAfterScaler);\n\tdml_print(\"DML: DSTXAfterScaler: %f\\n\", *DSTXAfterScaler);\n\tdml_print(\"DML: HTotal: %d\\n\", HTotal);\n\n\t*PrefetchBandwidth = 0;\n\t*DestinationLinesToRequestVMInVBlank = 0;\n\t*DestinationLinesToRequestRowInVBlank = 0;\n\t*VRatioPrefetchY = 0;\n\t*VRatioPrefetchC = 0;\n\t*RequiredPrefetchPixDataBW = 0;\n\tif (*DestinationLinesForPrefetch > 1) {\n\t\t*PrefetchBandwidth = (PDEAndMetaPTEBytesFrame + 2 * MetaRowByte\n\t\t\t\t+ 2 * PixelPTEBytesPerRow\n\t\t\t\t+ PrefetchSourceLinesY * SwathWidthY * dml_ceil(BytePerPixelDETY, 1)\n\t\t\t\t+ PrefetchSourceLinesC * SwathWidthY / 2\n\t\t\t\t\t\t* dml_ceil(BytePerPixelDETC, 2))\n\t\t\t\t/ (*DestinationLinesForPrefetch * LineTime - *Tno_bw);\n\t\tif (GPUVMEnable) {\n\t\t\tTimeForFetchingMetaPTE =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t*Tno_bw\n\t\t\t\t\t\t\t\t\t+ (double) PDEAndMetaPTEBytesFrame\n\t\t\t\t\t\t\t\t\t\t\t/ *PrefetchBandwidth,\n\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\tUrgentExtraLatency\n\t\t\t\t\t\t\t\t\t\t\t+ UrgentLatencyPixelDataOnly\n\t\t\t\t\t\t\t\t\t\t\t\t\t* (PageTableLevels\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 1),\n\t\t\t\t\t\t\t\t\tLineTime / 4));\n\t\t} else {\n\t\t\tif (NumberOfCursors > 0 || XFCEnabled)\n\t\t\t\tTimeForFetchingMetaPTE = LineTime / 4;\n\t\t\telse\n\t\t\t\tTimeForFetchingMetaPTE = 0.0;\n\t\t}\n\n\t\tif ((GPUVMEnable == true || DCCEnable == true)) {\n\t\t\tTimeForFetchingRowInVBlank =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t(MetaRowByte + PixelPTEBytesPerRow)\n\t\t\t\t\t\t\t\t\t/ *PrefetchBandwidth,\n\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\tUrgentLatencyPixelDataOnly,\n\t\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\t\tLineTime\n\t\t\t\t\t\t\t\t\t\t\t\t\t- TimeForFetchingMetaPTE,\n\t\t\t\t\t\t\t\t\t\t\tLineTime\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 4.0)));\n\t\t} else {\n\t\t\tif (NumberOfCursors > 0 || XFCEnabled)\n\t\t\t\tTimeForFetchingRowInVBlank = LineTime - TimeForFetchingMetaPTE;\n\t\t\telse\n\t\t\t\tTimeForFetchingRowInVBlank = 0.0;\n\t\t}\n\n\t\t*DestinationLinesToRequestVMInVBlank = dml_floor(\n\t\t\t\t4.0 * (TimeForFetchingMetaPTE / LineTime + 0.125),\n\t\t\t\t1) / 4.0;\n\n\t\t*DestinationLinesToRequestRowInVBlank = dml_floor(\n\t\t\t\t4.0 * (TimeForFetchingRowInVBlank / LineTime + 0.125),\n\t\t\t\t1) / 4.0;\n\n\t\tLinesToRequestPrefetchPixelData =\n\t\t\t\t*DestinationLinesForPrefetch\n\t\t\t\t\t\t- ((NumberOfCursors > 0 || GPUVMEnable\n\t\t\t\t\t\t\t\t|| DCCEnable) ?\n\t\t\t\t\t\t\t\t(*DestinationLinesToRequestVMInVBlank\n\t\t\t\t\t\t\t\t\t\t+ *DestinationLinesToRequestRowInVBlank) :\n\t\t\t\t\t\t\t\t0.0);\n\n\t\tif (LinesToRequestPrefetchPixelData > 0) {\n\n\t\t\t*VRatioPrefetchY = (double) PrefetchSourceLinesY\n\t\t\t\t\t/ LinesToRequestPrefetchPixelData;\n\t\t\t*VRatioPrefetchY = dml_max(*VRatioPrefetchY, 1.0);\n\t\t\tif ((SwathHeightY > 4) && (VInitPreFillY > 3)) {\n\t\t\t\tif (LinesToRequestPrefetchPixelData > (VInitPreFillY - 3.0) / 2.0) {\n\t\t\t\t\t*VRatioPrefetchY =\n\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t(double) PrefetchSourceLinesY\n\t\t\t\t\t\t\t\t\t\t\t/ LinesToRequestPrefetchPixelData,\n\t\t\t\t\t\t\t\t\t(double) MaxNumSwathY\n\t\t\t\t\t\t\t\t\t\t\t* SwathHeightY\n\t\t\t\t\t\t\t\t\t\t\t/ (LinesToRequestPrefetchPixelData\n\t\t\t\t\t\t\t\t\t\t\t\t\t- (VInitPreFillY\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 3.0)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0));\n\t\t\t\t\t*VRatioPrefetchY = dml_max(*VRatioPrefetchY, 1.0);\n\t\t\t\t} else {\n\t\t\t\t\tMyError = true;\n\t\t\t\t\t*VRatioPrefetchY = 0;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t*VRatioPrefetchC = (double) PrefetchSourceLinesC\n\t\t\t\t\t/ LinesToRequestPrefetchPixelData;\n\t\t\t*VRatioPrefetchC = dml_max(*VRatioPrefetchC, 1.0);\n\n\t\t\tif ((SwathHeightC > 4)) {\n\t\t\t\tif (LinesToRequestPrefetchPixelData > (VInitPreFillC - 3.0) / 2.0) {\n\t\t\t\t\t*VRatioPrefetchC =\n\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t*VRatioPrefetchC,\n\t\t\t\t\t\t\t\t\t(double) MaxNumSwathC\n\t\t\t\t\t\t\t\t\t\t\t* SwathHeightC\n\t\t\t\t\t\t\t\t\t\t\t/ (LinesToRequestPrefetchPixelData\n\t\t\t\t\t\t\t\t\t\t\t\t\t- (VInitPreFillC\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 3.0)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0));\n\t\t\t\t\t*VRatioPrefetchC = dml_max(*VRatioPrefetchC, 1.0);\n\t\t\t\t} else {\n\t\t\t\t\tMyError = true;\n\t\t\t\t\t*VRatioPrefetchC = 0;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t*RequiredPrefetchPixDataBW =\n\t\t\t\t\tDPPPerPlane\n\t\t\t\t\t\t\t* ((double) PrefetchSourceLinesY\n\t\t\t\t\t\t\t\t\t/ LinesToRequestPrefetchPixelData\n\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\tBytePerPixelDETY,\n\t\t\t\t\t\t\t\t\t\t\t1)\n\t\t\t\t\t\t\t\t\t+ (double) PrefetchSourceLinesC\n\t\t\t\t\t\t\t\t\t\t\t/ LinesToRequestPrefetchPixelData\n\t\t\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\tBytePerPixelDETC,\n\t\t\t\t\t\t\t\t\t\t\t\t\t2)\n\t\t\t\t\t\t\t\t\t\t\t/ 2)\n\t\t\t\t\t\t\t* SwathWidthY / LineTime;\n\t\t} else {\n\t\t\tMyError = true;\n\t\t\t*VRatioPrefetchY = 0;\n\t\t\t*VRatioPrefetchC = 0;\n\t\t\t*RequiredPrefetchPixDataBW = 0;\n\t\t}\n\n\t} else {\n\t\tMyError = true;\n\t}\n\n\tif (MyError) {\n\t\t*PrefetchBandwidth = 0;\n\t\tTimeForFetchingMetaPTE = 0;\n\t\tTimeForFetchingRowInVBlank = 0;\n\t\t*DestinationLinesToRequestVMInVBlank = 0;\n\t\t*DestinationLinesToRequestRowInVBlank = 0;\n\t\t*DestinationLinesForPrefetch = 0;\n\t\tLinesToRequestPrefetchPixelData = 0;\n\t\t*VRatioPrefetchY = 0;\n\t\t*VRatioPrefetchC = 0;\n\t\t*RequiredPrefetchPixDataBW = 0;\n\t}\n\n\treturn MyError;\n}\n\nstatic double RoundToDFSGranularityUp(double Clock, double VCOSpeed)\n{\n\treturn VCOSpeed * 4 / dml_floor(VCOSpeed * 4 / Clock, 1);\n}\n\nstatic double RoundToDFSGranularityDown(double Clock, double VCOSpeed)\n{\n\treturn VCOSpeed * 4 / dml_ceil(VCOSpeed * 4 / Clock, 1);\n}\n\nstatic double CalculatePrefetchSourceLines(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble VRatio,\n\t\tdouble vtaps,\n\t\tbool Interlace,\n\t\tbool ProgressiveToInterlaceUnitInOPP,\n\t\tunsigned int SwathHeight,\n\t\tunsigned int ViewportYStart,\n\t\tdouble *VInitPreFill,\n\t\tunsigned int *MaxNumSwath)\n{\n\tunsigned int MaxPartialSwath;\n\n\tif (ProgressiveToInterlaceUnitInOPP)\n\t\t*VInitPreFill = dml_floor((VRatio + vtaps + 1) / 2.0, 1);\n\telse\n\t\t*VInitPreFill = dml_floor((VRatio + vtaps + 1 + Interlace * 0.5 * VRatio) / 2.0, 1);\n\n\tif (!mode_lib->vba.IgnoreViewportPositioning) {\n\n\t\t*MaxNumSwath = dml_ceil((*VInitPreFill - 1.0) / SwathHeight, 1) + 1.0;\n\n\t\tif (*VInitPreFill > 1.0)\n\t\t\tMaxPartialSwath = (unsigned int) (*VInitPreFill - 2) % SwathHeight;\n\t\telse\n\t\t\tMaxPartialSwath = (unsigned int) (*VInitPreFill + SwathHeight - 2)\n\t\t\t\t\t% SwathHeight;\n\t\tMaxPartialSwath = dml_max(1U, MaxPartialSwath);\n\n\t} else {\n\n\t\tif (ViewportYStart != 0)\n\t\t\tdml_print(\n\t\t\t\t\t\"WARNING DML: using viewport y position of 0 even though actual viewport y position is non-zero in prefetch source lines calculation\\n\");\n\n\t\t*MaxNumSwath = dml_ceil(*VInitPreFill / SwathHeight, 1);\n\n\t\tif (*VInitPreFill > 1.0)\n\t\t\tMaxPartialSwath = (unsigned int) (*VInitPreFill - 1) % SwathHeight;\n\t\telse\n\t\t\tMaxPartialSwath = (unsigned int) (*VInitPreFill + SwathHeight - 1)\n\t\t\t\t\t% SwathHeight;\n\t}\n\n\treturn *MaxNumSwath * SwathHeight + MaxPartialSwath;\n}\n\nstatic unsigned int CalculateVMAndRowBytes(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tbool DCCEnable,\n\t\tunsigned int BlockHeight256Bytes,\n\t\tunsigned int BlockWidth256Bytes,\n\t\tenum source_format_class SourcePixelFormat,\n\t\tunsigned int SurfaceTiling,\n\t\tunsigned int BytePerPixel,\n\t\tenum scan_direction_class ScanDirection,\n\t\tunsigned int ViewportWidth,\n\t\tunsigned int ViewportHeight,\n\t\tunsigned int SwathWidth,\n\t\tbool GPUVMEnable,\n\t\tunsigned int VMMPageSize,\n\t\tunsigned int PTEBufferSizeInRequestsLuma,\n\t\tunsigned int PDEProcessingBufIn64KBReqs,\n\t\tunsigned int Pitch,\n\t\tunsigned int DCCMetaPitch,\n\t\tunsigned int *MacroTileWidth,\n\t\tunsigned int *MetaRowByte,\n\t\tunsigned int *PixelPTEBytesPerRow,\n\t\tbool *PTEBufferSizeNotExceeded,\n\t\tunsigned int *dpte_row_height,\n\t\tunsigned int *meta_row_height)\n{\n\tunsigned int MetaRequestHeight;\n\tunsigned int MetaRequestWidth;\n\tunsigned int MetaSurfWidth;\n\tunsigned int MetaSurfHeight;\n\tunsigned int MPDEBytesFrame;\n\tunsigned int MetaPTEBytesFrame;\n\tunsigned int DCCMetaSurfaceBytes;\n\n\tunsigned int MacroTileSizeBytes;\n\tunsigned int MacroTileHeight;\n\tunsigned int DPDE0BytesFrame;\n\tunsigned int ExtraDPDEBytesFrame;\n\tunsigned int PDEAndMetaPTEBytesFrame;\n\n\tif (DCCEnable == true) {\n\t\tMetaRequestHeight = 8 * BlockHeight256Bytes;\n\t\tMetaRequestWidth = 8 * BlockWidth256Bytes;\n\t\tif (ScanDirection == dm_horz) {\n\t\t\t*meta_row_height = MetaRequestHeight;\n\t\t\tMetaSurfWidth = dml_ceil((double) SwathWidth - 1, MetaRequestWidth)\n\t\t\t\t\t+ MetaRequestWidth;\n\t\t\t*MetaRowByte = MetaSurfWidth * MetaRequestHeight * BytePerPixel / 256.0;\n\t\t} else {\n\t\t\t*meta_row_height = MetaRequestWidth;\n\t\t\tMetaSurfHeight = dml_ceil((double) SwathWidth - 1, MetaRequestHeight)\n\t\t\t\t\t+ MetaRequestHeight;\n\t\t\t*MetaRowByte = MetaSurfHeight * MetaRequestWidth * BytePerPixel / 256.0;\n\t\t}\n\t\tif (ScanDirection == dm_horz) {\n\t\t\tDCCMetaSurfaceBytes = DCCMetaPitch\n\t\t\t\t\t* (dml_ceil(ViewportHeight - 1, 64 * BlockHeight256Bytes)\n\t\t\t\t\t\t\t+ 64 * BlockHeight256Bytes) * BytePerPixel\n\t\t\t\t\t/ 256;\n\t\t} else {\n\t\t\tDCCMetaSurfaceBytes = DCCMetaPitch\n\t\t\t\t\t* (dml_ceil(\n\t\t\t\t\t\t\t(double) ViewportHeight - 1,\n\t\t\t\t\t\t\t64 * BlockHeight256Bytes)\n\t\t\t\t\t\t\t+ 64 * BlockHeight256Bytes) * BytePerPixel\n\t\t\t\t\t/ 256;\n\t\t}\n\t\tif (GPUVMEnable == true) {\n\t\t\tMetaPTEBytesFrame = (dml_ceil(\n\t\t\t\t\t(double) (DCCMetaSurfaceBytes - VMMPageSize)\n\t\t\t\t\t\t\t/ (8 * VMMPageSize),\n\t\t\t\t\t1) + 1) * 64;\n\t\t\tMPDEBytesFrame = 128 * (mode_lib->vba.GPUVMMaxPageTableLevels - 1);\n\t\t} else {\n\t\t\tMetaPTEBytesFrame = 0;\n\t\t\tMPDEBytesFrame = 0;\n\t\t}\n\t} else {\n\t\tMetaPTEBytesFrame = 0;\n\t\tMPDEBytesFrame = 0;\n\t\t*MetaRowByte = 0;\n\t}\n\n\tif (SurfaceTiling == dm_sw_linear || SurfaceTiling == dm_sw_gfx7_2d_thin_gl || SurfaceTiling == dm_sw_gfx7_2d_thin_l_vp) {\n\t\tMacroTileSizeBytes = 256;\n\t\tMacroTileHeight = BlockHeight256Bytes;\n\t} else if (SurfaceTiling == dm_sw_4kb_s || SurfaceTiling == dm_sw_4kb_s_x\n\t\t\t|| SurfaceTiling == dm_sw_4kb_d || SurfaceTiling == dm_sw_4kb_d_x) {\n\t\tMacroTileSizeBytes = 4096;\n\t\tMacroTileHeight = 4 * BlockHeight256Bytes;\n\t} else if (SurfaceTiling == dm_sw_64kb_s || SurfaceTiling == dm_sw_64kb_s_t\n\t\t\t|| SurfaceTiling == dm_sw_64kb_s_x || SurfaceTiling == dm_sw_64kb_d\n\t\t\t|| SurfaceTiling == dm_sw_64kb_d_t || SurfaceTiling == dm_sw_64kb_d_x\n\t\t\t|| SurfaceTiling == dm_sw_64kb_r_x) {\n\t\tMacroTileSizeBytes = 65536;\n\t\tMacroTileHeight = 16 * BlockHeight256Bytes;\n\t} else {\n\t\tMacroTileSizeBytes = 262144;\n\t\tMacroTileHeight = 32 * BlockHeight256Bytes;\n\t}\n\t*MacroTileWidth = MacroTileSizeBytes / BytePerPixel / MacroTileHeight;\n\n\tif (GPUVMEnable == true && mode_lib->vba.GPUVMMaxPageTableLevels > 1) {\n\t\tif (ScanDirection == dm_horz) {\n\t\t\tDPDE0BytesFrame =\n\t\t\t\t\t64\n\t\t\t\t\t\t\t* (dml_ceil(\n\t\t\t\t\t\t\t\t\t((Pitch\n\t\t\t\t\t\t\t\t\t\t\t* (dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\tViewportHeight\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 1,\n\t\t\t\t\t\t\t\t\t\t\t\t\tMacroTileHeight)\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ MacroTileHeight)\n\t\t\t\t\t\t\t\t\t\t\t* BytePerPixel)\n\t\t\t\t\t\t\t\t\t\t\t- MacroTileSizeBytes)\n\t\t\t\t\t\t\t\t\t\t\t/ (8\n\t\t\t\t\t\t\t\t\t\t\t\t\t* 2097152),\n\t\t\t\t\t\t\t\t\t1) + 1);\n\t\t} else {\n\t\t\tDPDE0BytesFrame =\n\t\t\t\t\t64\n\t\t\t\t\t\t\t* (dml_ceil(\n\t\t\t\t\t\t\t\t\t((Pitch\n\t\t\t\t\t\t\t\t\t\t\t* (dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t(double) SwathWidth\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 1,\n\t\t\t\t\t\t\t\t\t\t\t\t\tMacroTileHeight)\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ MacroTileHeight)\n\t\t\t\t\t\t\t\t\t\t\t* BytePerPixel)\n\t\t\t\t\t\t\t\t\t\t\t- MacroTileSizeBytes)\n\t\t\t\t\t\t\t\t\t\t\t/ (8\n\t\t\t\t\t\t\t\t\t\t\t\t\t* 2097152),\n\t\t\t\t\t\t\t\t\t1) + 1);\n\t\t}\n\t\tExtraDPDEBytesFrame = 128 * (mode_lib->vba.GPUVMMaxPageTableLevels - 2);\n\t} else {\n\t\tDPDE0BytesFrame = 0;\n\t\tExtraDPDEBytesFrame = 0;\n\t}\n\n\tPDEAndMetaPTEBytesFrame = MetaPTEBytesFrame + MPDEBytesFrame + DPDE0BytesFrame\n\t\t\t+ ExtraDPDEBytesFrame;\n\n\tif (GPUVMEnable == true) {\n\t\tunsigned int PTERequestSize;\n\t\tunsigned int PixelPTEReqHeight;\n\t\tunsigned int PixelPTEReqWidth;\n\t\tdouble FractionOfPTEReturnDrop;\n\t\tunsigned int EffectivePDEProcessingBufIn64KBReqs;\n\n\t\tif (SurfaceTiling == dm_sw_linear) {\n\t\t\tPixelPTEReqHeight = 1;\n\t\t\tPixelPTEReqWidth = 8.0 * VMMPageSize / BytePerPixel;\n\t\t\tPTERequestSize = 64;\n\t\t\tFractionOfPTEReturnDrop = 0;\n\t\t} else if (MacroTileSizeBytes == 4096) {\n\t\t\tPixelPTEReqHeight = MacroTileHeight;\n\t\t\tPixelPTEReqWidth = 8 * *MacroTileWidth;\n\t\t\tPTERequestSize = 64;\n\t\t\tif (ScanDirection == dm_horz)\n\t\t\t\tFractionOfPTEReturnDrop = 0;\n\t\t\telse\n\t\t\t\tFractionOfPTEReturnDrop = 7 / 8;\n\t\t} else if (VMMPageSize == 4096 && MacroTileSizeBytes > 4096) {\n\t\t\tPixelPTEReqHeight = 16 * BlockHeight256Bytes;\n\t\t\tPixelPTEReqWidth = 16 * BlockWidth256Bytes;\n\t\t\tPTERequestSize = 128;\n\t\t\tFractionOfPTEReturnDrop = 0;\n\t\t} else {\n\t\t\tPixelPTEReqHeight = MacroTileHeight;\n\t\t\tPixelPTEReqWidth = 8 * *MacroTileWidth;\n\t\t\tPTERequestSize = 64;\n\t\t\tFractionOfPTEReturnDrop = 0;\n\t\t}\n\n\t\tif (SourcePixelFormat == dm_420_8 || SourcePixelFormat == dm_420_10)\n\t\t\tEffectivePDEProcessingBufIn64KBReqs = PDEProcessingBufIn64KBReqs / 2;\n\t\telse\n\t\t\tEffectivePDEProcessingBufIn64KBReqs = PDEProcessingBufIn64KBReqs;\n\n\t\tif (SurfaceTiling == dm_sw_linear) {\n\t\t\t*dpte_row_height =\n\t\t\t\t\tdml_min(\n\t\t\t\t\t\t\t128,\n\t\t\t\t\t\t\t1\n\t\t\t\t\t\t\t\t\t<< (unsigned int) dml_floor(\n\t\t\t\t\t\t\t\t\t\t\tdml_log2(\n\t\t\t\t\t\t\t\t\t\t\t\t\tdml_min(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(double) PTEBufferSizeInRequestsLuma\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* PixelPTEReqWidth,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEffectivePDEProcessingBufIn64KBReqs\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* 65536.0\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ BytePerPixel)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ Pitch),\n\t\t\t\t\t\t\t\t\t\t\t1));\n\t\t\t*PixelPTEBytesPerRow = PTERequestSize\n\t\t\t\t\t* (dml_ceil(\n\t\t\t\t\t\t\t(double) (Pitch * *dpte_row_height - 1)\n\t\t\t\t\t\t\t\t\t/ PixelPTEReqWidth,\n\t\t\t\t\t\t\t1) + 1);\n\t\t} else if (ScanDirection == dm_horz) {\n\t\t\t*dpte_row_height = PixelPTEReqHeight;\n\t\t\t*PixelPTEBytesPerRow = PTERequestSize\n\t\t\t\t\t* (dml_ceil(((double) SwathWidth - 1) / PixelPTEReqWidth, 1)\n\t\t\t\t\t\t\t+ 1);\n\t\t} else {\n\t\t\t*dpte_row_height = dml_min(PixelPTEReqWidth, *MacroTileWidth);\n\t\t\t*PixelPTEBytesPerRow = PTERequestSize\n\t\t\t\t\t* (dml_ceil(\n\t\t\t\t\t\t\t((double) SwathWidth - 1)\n\t\t\t\t\t\t\t\t\t/ PixelPTEReqHeight,\n\t\t\t\t\t\t\t1) + 1);\n\t\t}\n\t\tif (*PixelPTEBytesPerRow * (1 - FractionOfPTEReturnDrop)\n\t\t\t\t<= 64 * PTEBufferSizeInRequestsLuma) {\n\t\t\t*PTEBufferSizeNotExceeded = true;\n\t\t} else {\n\t\t\t*PTEBufferSizeNotExceeded = false;\n\t\t}\n\t} else {\n\t\t*PixelPTEBytesPerRow = 0;\n\t\t*PTEBufferSizeNotExceeded = true;\n\t}\n\n\treturn PDEAndMetaPTEBytesFrame;\n}\n\nstatic void dml20_DISPCLKDPPCLKDCFCLKDeepSleepPrefetchParametersWatermarksAndPerformanceCalculation(\n\t\tstruct display_mode_lib *mode_lib)\n{\n\tunsigned int j, k;\n\n\tmode_lib->vba.WritebackDISPCLK = 0.0;\n\tmode_lib->vba.DISPCLKWithRamping = 0;\n\tmode_lib->vba.DISPCLKWithoutRamping = 0;\n\tmode_lib->vba.GlobalDPPCLK = 0.0;\n\n\t \n\t \n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.WritebackEnable[k]) {\n\t\t\tmode_lib->vba.WritebackDISPCLK =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tmode_lib->vba.WritebackDISPCLK,\n\t\t\t\t\t\t\tCalculateWriteBackDISPCLK(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaHTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaVTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaHTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaVTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.HTotal[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaLineBufferWidth));\n\t\t}\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.HRatio[k] > 1) {\n\t\t\tmode_lib->vba.PSCL_THROUGHPUT_LUMA[k] = dml_min(\n\t\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput,\n\t\t\t\t\tmode_lib->vba.MaxPSCLToLBThroughput\n\t\t\t\t\t\t\t* mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t/ dml_ceil(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.htaps[k]\n\t\t\t\t\t\t\t\t\t\t\t/ 6.0,\n\t\t\t\t\t\t\t\t\t1));\n\t\t} else {\n\t\t\tmode_lib->vba.PSCL_THROUGHPUT_LUMA[k] = dml_min(\n\t\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput,\n\t\t\t\t\tmode_lib->vba.MaxPSCLToLBThroughput);\n\t\t}\n\n\t\tmode_lib->vba.DPPCLKUsingSingleDPPLuma =\n\t\t\t\tmode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t* dml_max(\n\t\t\t\t\t\t\t\tmode_lib->vba.vtaps[k] / 6.0\n\t\t\t\t\t\t\t\t\t\t* dml_min(\n\t\t\t\t\t\t\t\t\t\t\t\t1.0,\n\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]),\n\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.VRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PSCL_THROUGHPUT_LUMA[k],\n\t\t\t\t\t\t\t\t\t\t1.0));\n\n\t\tif ((mode_lib->vba.htaps[k] > 6 || mode_lib->vba.vtaps[k] > 6)\n\t\t\t\t&& mode_lib->vba.DPPCLKUsingSingleDPPLuma\n\t\t\t\t\t\t< 2 * mode_lib->vba.PixelClock[k]) {\n\t\t\tmode_lib->vba.DPPCLKUsingSingleDPPLuma = 2 * mode_lib->vba.PixelClock[k];\n\t\t}\n\n\t\tif ((mode_lib->vba.SourcePixelFormat[k] != dm_420_8\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_420_10)) {\n\t\t\tmode_lib->vba.PSCL_THROUGHPUT_CHROMA[k] = 0.0;\n\t\t\tmode_lib->vba.DPPCLKUsingSingleDPP[k] =\n\t\t\t\t\tmode_lib->vba.DPPCLKUsingSingleDPPLuma;\n\t\t} else {\n\t\t\tif (mode_lib->vba.HRatio[k] > 1) {\n\t\t\t\tmode_lib->vba.PSCL_THROUGHPUT_CHROMA[k] =\n\t\t\t\t\t\tdml_min(\n\t\t\t\t\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput,\n\t\t\t\t\t\t\t\tmode_lib->vba.MaxPSCLToLBThroughput\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t/ 2\n\t\t\t\t\t\t\t\t\t\t/ dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HTAPsChroma[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 6.0,\n\t\t\t\t\t\t\t\t\t\t\t\t1.0));\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.PSCL_THROUGHPUT_CHROMA[k] = dml_min(\n\t\t\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput,\n\t\t\t\t\t\tmode_lib->vba.MaxPSCLToLBThroughput);\n\t\t\t}\n\t\t\tmode_lib->vba.DPPCLKUsingSingleDPPChroma =\n\t\t\t\t\tmode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t* dml_max(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.VTAPsChroma[k]\n\t\t\t\t\t\t\t\t\t\t\t/ 6.0\n\t\t\t\t\t\t\t\t\t\t\t* dml_min(\n\t\t\t\t\t\t\t\t\t\t\t\t\t1.0,\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 2),\n\t\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.VRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 4\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PSCL_THROUGHPUT_CHROMA[k],\n\t\t\t\t\t\t\t\t\t\t\t1.0));\n\n\t\t\tif ((mode_lib->vba.HTAPsChroma[k] > 6 || mode_lib->vba.VTAPsChroma[k] > 6)\n\t\t\t\t\t&& mode_lib->vba.DPPCLKUsingSingleDPPChroma\n\t\t\t\t\t\t\t< 2 * mode_lib->vba.PixelClock[k]) {\n\t\t\t\tmode_lib->vba.DPPCLKUsingSingleDPPChroma = 2\n\t\t\t\t\t\t* mode_lib->vba.PixelClock[k];\n\t\t\t}\n\n\t\t\tmode_lib->vba.DPPCLKUsingSingleDPP[k] = dml_max(\n\t\t\t\t\tmode_lib->vba.DPPCLKUsingSingleDPPLuma,\n\t\t\t\t\tmode_lib->vba.DPPCLKUsingSingleDPPChroma);\n\t\t}\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.BlendingAndTiming[k] != k)\n\t\t\tcontinue;\n\t\tif (mode_lib->vba.ODMCombineEnabled[k]) {\n\t\t\tmode_lib->vba.DISPCLKWithRamping =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLKWithRamping,\n\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k] / 2\n\t\t\t\t\t\t\t\t\t* (1\n\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 100)\n\t\t\t\t\t\t\t\t\t* (1\n\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.DISPCLKRampingMargin\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 100));\n\t\t\tmode_lib->vba.DISPCLKWithoutRamping =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLKWithoutRamping,\n\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k] / 2\n\t\t\t\t\t\t\t\t\t* (1\n\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 100));\n\t\t} else if (!mode_lib->vba.ODMCombineEnabled[k]) {\n\t\t\tmode_lib->vba.DISPCLKWithRamping =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLKWithRamping,\n\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t\t\t* (1\n\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 100)\n\t\t\t\t\t\t\t\t\t* (1\n\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.DISPCLKRampingMargin\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 100));\n\t\t\tmode_lib->vba.DISPCLKWithoutRamping =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLKWithoutRamping,\n\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t\t\t* (1\n\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 100));\n\t\t}\n\t}\n\n\tmode_lib->vba.DISPCLKWithRamping = dml_max(\n\t\t\tmode_lib->vba.DISPCLKWithRamping,\n\t\t\tmode_lib->vba.WritebackDISPCLK);\n\tmode_lib->vba.DISPCLKWithoutRamping = dml_max(\n\t\t\tmode_lib->vba.DISPCLKWithoutRamping,\n\t\t\tmode_lib->vba.WritebackDISPCLK);\n\n\tASSERT(mode_lib->vba.DISPCLKDPPCLKVCOSpeed != 0);\n\tmode_lib->vba.DISPCLKWithRampingRoundedToDFSGranularity = RoundToDFSGranularityUp(\n\t\t\tmode_lib->vba.DISPCLKWithRamping,\n\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed);\n\tmode_lib->vba.DISPCLKWithoutRampingRoundedToDFSGranularity = RoundToDFSGranularityUp(\n\t\t\tmode_lib->vba.DISPCLKWithoutRamping,\n\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed);\n\tmode_lib->vba.MaxDispclkRoundedToDFSGranularity = RoundToDFSGranularityDown(\n\t\t\tmode_lib->vba.soc.clock_limits[mode_lib->vba.soc.num_states].dispclk_mhz,\n\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed);\n\tif (mode_lib->vba.DISPCLKWithoutRampingRoundedToDFSGranularity\n\t\t\t> mode_lib->vba.MaxDispclkRoundedToDFSGranularity) {\n\t\tmode_lib->vba.DISPCLK_calculated =\n\t\t\t\tmode_lib->vba.DISPCLKWithoutRampingRoundedToDFSGranularity;\n\t} else if (mode_lib->vba.DISPCLKWithRampingRoundedToDFSGranularity\n\t\t\t> mode_lib->vba.MaxDispclkRoundedToDFSGranularity) {\n\t\tmode_lib->vba.DISPCLK_calculated = mode_lib->vba.MaxDispclkRoundedToDFSGranularity;\n\t} else {\n\t\tmode_lib->vba.DISPCLK_calculated =\n\t\t\t\tmode_lib->vba.DISPCLKWithRampingRoundedToDFSGranularity;\n\t}\n\tDTRACE(\"   dispclk_mhz (calculated) = %f\", mode_lib->vba.DISPCLK_calculated);\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.DPPPerPlane[k] == 0) {\n\t\t\tmode_lib->vba.DPPCLK_calculated[k] = 0;\n\t\t} else {\n\t\t\tmode_lib->vba.DPPCLK_calculated[k] = mode_lib->vba.DPPCLKUsingSingleDPP[k]\n\t\t\t\t\t/ mode_lib->vba.DPPPerPlane[k]\n\t\t\t\t\t* (1 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100);\n\t\t}\n\t\tmode_lib->vba.GlobalDPPCLK = dml_max(\n\t\t\t\tmode_lib->vba.GlobalDPPCLK,\n\t\t\t\tmode_lib->vba.DPPCLK_calculated[k]);\n\t}\n\tmode_lib->vba.GlobalDPPCLK = RoundToDFSGranularityUp(\n\t\t\tmode_lib->vba.GlobalDPPCLK,\n\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed);\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.DPPCLK_calculated[k] = mode_lib->vba.GlobalDPPCLK / 255\n\t\t\t\t* dml_ceil(\n\t\t\t\t\t\tmode_lib->vba.DPPCLK_calculated[k] * 255\n\t\t\t\t\t\t\t\t/ mode_lib->vba.GlobalDPPCLK,\n\t\t\t\t\t\t1);\n\t\tDTRACE(\"   dppclk_mhz[%i] (calculated) = %f\", k, mode_lib->vba.DPPCLK_calculated[k]);\n\t}\n\n\t \n\tmode_lib->vba.DCCEnabledAnyPlane = false;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k)\n\t\tif (mode_lib->vba.DCCEnable[k])\n\t\t\tmode_lib->vba.DCCEnabledAnyPlane = true;\n\n\tmode_lib->vba.ReturnBandwidthToDCN = dml_min(\n\t\t\tmode_lib->vba.ReturnBusWidth * mode_lib->vba.DCFCLK,\n\t\t\tmode_lib->vba.FabricAndDRAMBandwidth * 1000)\n\t\t\t* mode_lib->vba.PercentOfIdealDRAMFabricAndSDPPortBWReceivedAfterUrgLatencyPixelDataOnly / 100;\n\n\tmode_lib->vba.ReturnBW = mode_lib->vba.ReturnBandwidthToDCN;\n\tmode_lib->vba.ReturnBW = adjust_ReturnBW(\n\t\t\tmode_lib,\n\t\t\tmode_lib->vba.ReturnBW,\n\t\t\tmode_lib->vba.DCCEnabledAnyPlane,\n\t\t\tmode_lib->vba.ReturnBandwidthToDCN);\n\n\t \n\tmode_lib->vba.ReturnBandwidthToDCN = dml_min(\n\t\t\tmode_lib->vba.ReturnBusWidth * mode_lib->vba.DCFCLK,\n\t\t\tmode_lib->vba.FabricAndDRAMBandwidth * 1000);\n\tmode_lib->vba.ReturnBW = adjust_ReturnBW(\n\t\t\tmode_lib,\n\t\t\tmode_lib->vba.ReturnBW,\n\t\t\tmode_lib->vba.DCCEnabledAnyPlane,\n\t\t\tmode_lib->vba.ReturnBandwidthToDCN);\n\n\tDTRACE(\"   dcfclk_mhz         = %f\", mode_lib->vba.DCFCLK);\n\tDTRACE(\"   return_bw_to_dcn   = %f\", mode_lib->vba.ReturnBandwidthToDCN);\n\tDTRACE(\"   return_bus_bw      = %f\", mode_lib->vba.ReturnBW);\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tbool MainPlaneDoesODMCombine = false;\n\n\t\tif (mode_lib->vba.SourceScan[k] == dm_horz)\n\t\t\tmode_lib->vba.SwathWidthSingleDPPY[k] = mode_lib->vba.ViewportWidth[k];\n\t\telse\n\t\t\tmode_lib->vba.SwathWidthSingleDPPY[k] = mode_lib->vba.ViewportHeight[k];\n\n\t\tif (mode_lib->vba.ODMCombineEnabled[k] == dm_odm_combine_mode_2to1)\n\t\t\tMainPlaneDoesODMCombine = true;\n\t\tfor (j = 0; j < mode_lib->vba.NumberOfActivePlanes; ++j)\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == j\n\t\t\t\t\t&& mode_lib->vba.ODMCombineEnabled[k] == dm_odm_combine_mode_2to1)\n\t\t\t\tMainPlaneDoesODMCombine = true;\n\n\t\tif (MainPlaneDoesODMCombine == true)\n\t\t\tmode_lib->vba.SwathWidthY[k] = dml_min(\n\t\t\t\t\t(double) mode_lib->vba.SwathWidthSingleDPPY[k],\n\t\t\t\t\tdml_round(\n\t\t\t\t\t\t\tmode_lib->vba.HActive[k] / 2.0\n\t\t\t\t\t\t\t\t\t* mode_lib->vba.HRatio[k]));\n\t\telse {\n\t\t\tif (mode_lib->vba.DPPPerPlane[k] == 0) {\n\t\t\t\tmode_lib->vba.SwathWidthY[k] = 0;\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.SwathWidthY[k] = mode_lib->vba.SwathWidthSingleDPPY[k]\n\t\t\t\t\t\t/ mode_lib->vba.DPPPerPlane[k];\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.SourcePixelFormat[k] == dm_444_64) {\n\t\t\tmode_lib->vba.BytePerPixelDETY[k] = 8;\n\t\t\tmode_lib->vba.BytePerPixelDETC[k] = 0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_32) {\n\t\t\tmode_lib->vba.BytePerPixelDETY[k] = 4;\n\t\t\tmode_lib->vba.BytePerPixelDETC[k] = 0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_16) {\n\t\t\tmode_lib->vba.BytePerPixelDETY[k] = 2;\n\t\t\tmode_lib->vba.BytePerPixelDETC[k] = 0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_8) {\n\t\t\tmode_lib->vba.BytePerPixelDETY[k] = 1;\n\t\t\tmode_lib->vba.BytePerPixelDETC[k] = 0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_420_8) {\n\t\t\tmode_lib->vba.BytePerPixelDETY[k] = 1;\n\t\t\tmode_lib->vba.BytePerPixelDETC[k] = 2;\n\t\t} else { \n\t\t\tmode_lib->vba.BytePerPixelDETY[k] = 4.0 / 3.0;\n\t\t\tmode_lib->vba.BytePerPixelDETC[k] = 8.0 / 3.0;\n\t\t}\n\t}\n\n\tmode_lib->vba.TotalDataReadBandwidth = 0.0;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.ReadBandwidthPlaneLuma[k] = mode_lib->vba.SwathWidthSingleDPPY[k]\n\t\t\t\t* dml_ceil(mode_lib->vba.BytePerPixelDETY[k], 1)\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k])\n\t\t\t\t* mode_lib->vba.VRatio[k];\n\t\tmode_lib->vba.ReadBandwidthPlaneChroma[k] = mode_lib->vba.SwathWidthSingleDPPY[k]\n\t\t\t\t/ 2 * dml_ceil(mode_lib->vba.BytePerPixelDETC[k], 2)\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k])\n\t\t\t\t* mode_lib->vba.VRatio[k] / 2;\n\t\tDTRACE(\n\t\t\t\t\"   read_bw[%i] = %fBps\",\n\t\t\t\tk,\n\t\t\t\tmode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneChroma[k]);\n\t\tmode_lib->vba.TotalDataReadBandwidth += mode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneChroma[k];\n\t}\n\n\tmode_lib->vba.TotalDCCActiveDPP = 0;\n\tmode_lib->vba.TotalActiveDPP = 0;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.TotalActiveDPP = mode_lib->vba.TotalActiveDPP\n\t\t\t\t+ mode_lib->vba.DPPPerPlane[k];\n\t\tif (mode_lib->vba.DCCEnable[k])\n\t\t\tmode_lib->vba.TotalDCCActiveDPP = mode_lib->vba.TotalDCCActiveDPP\n\t\t\t\t\t+ mode_lib->vba.DPPPerPlane[k];\n\t}\n\n\tmode_lib->vba.UrgentRoundTripAndOutOfOrderLatency =\n\t\t\t(mode_lib->vba.RoundTripPingLatencyCycles + 32) / mode_lib->vba.DCFCLK\n\t\t\t\t\t+ mode_lib->vba.UrgentOutOfOrderReturnPerChannelPixelDataOnly\n\t\t\t\t\t\t\t* mode_lib->vba.NumberOfChannels\n\t\t\t\t\t\t\t/ mode_lib->vba.ReturnBW;\n\n\tmode_lib->vba.LastPixelOfLineExtraWatermark = 0;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tdouble DataFabricLineDeliveryTimeLuma, DataFabricLineDeliveryTimeChroma;\n\n\t\tif (mode_lib->vba.VRatio[k] <= 1.0)\n\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeLuma[k] =\n\t\t\t\t\t(double) mode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t* mode_lib->vba.DPPPerPlane[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k];\n\t\telse\n\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeLuma[k] =\n\t\t\t\t\t(double) mode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PSCL_THROUGHPUT_LUMA[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.DPPCLK[k];\n\n\t\tDataFabricLineDeliveryTimeLuma = mode_lib->vba.SwathWidthSingleDPPY[k]\n\t\t\t\t* mode_lib->vba.SwathHeightY[k]\n\t\t\t\t* dml_ceil(mode_lib->vba.BytePerPixelDETY[k], 1)\n\t\t\t\t/ (mode_lib->vba.ReturnBW * mode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t\t\t/ mode_lib->vba.TotalDataReadBandwidth);\n\t\tmode_lib->vba.LastPixelOfLineExtraWatermark = dml_max(\n\t\t\t\tmode_lib->vba.LastPixelOfLineExtraWatermark,\n\t\t\t\tDataFabricLineDeliveryTimeLuma\n\t\t\t\t\t\t- mode_lib->vba.DisplayPipeLineDeliveryTimeLuma[k]);\n\n\t\tif (mode_lib->vba.BytePerPixelDETC[k] == 0)\n\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeChroma[k] = 0.0;\n\t\telse if (mode_lib->vba.VRatio[k] / 2.0 <= 1.0)\n\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeChroma[k] =\n\t\t\t\t\tmode_lib->vba.SwathWidthY[k] / 2.0\n\t\t\t\t\t\t\t* mode_lib->vba.DPPPerPlane[k]\n\t\t\t\t\t\t\t/ (mode_lib->vba.HRatio[k] / 2.0)\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k];\n\t\telse\n\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeChroma[k] =\n\t\t\t\t\tmode_lib->vba.SwathWidthY[k] / 2.0\n\t\t\t\t\t\t\t/ mode_lib->vba.PSCL_THROUGHPUT_CHROMA[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.DPPCLK[k];\n\n\t\tDataFabricLineDeliveryTimeChroma = mode_lib->vba.SwathWidthSingleDPPY[k] / 2.0\n\t\t\t\t* mode_lib->vba.SwathHeightC[k]\n\t\t\t\t* dml_ceil(mode_lib->vba.BytePerPixelDETC[k], 2)\n\t\t\t\t/ (mode_lib->vba.ReturnBW\n\t\t\t\t\t\t* mode_lib->vba.ReadBandwidthPlaneChroma[k]\n\t\t\t\t\t\t/ mode_lib->vba.TotalDataReadBandwidth);\n\t\tmode_lib->vba.LastPixelOfLineExtraWatermark =\n\t\t\t\tdml_max(\n\t\t\t\t\t\tmode_lib->vba.LastPixelOfLineExtraWatermark,\n\t\t\t\t\t\tDataFabricLineDeliveryTimeChroma\n\t\t\t\t\t\t\t\t- mode_lib->vba.DisplayPipeLineDeliveryTimeChroma[k]);\n\t}\n\n\tmode_lib->vba.UrgentExtraLatency = mode_lib->vba.UrgentRoundTripAndOutOfOrderLatency\n\t\t\t+ (mode_lib->vba.TotalActiveDPP * mode_lib->vba.PixelChunkSizeInKByte\n\t\t\t\t\t+ mode_lib->vba.TotalDCCActiveDPP\n\t\t\t\t\t\t\t* mode_lib->vba.MetaChunkSize) * 1024.0\n\t\t\t\t\t/ mode_lib->vba.ReturnBW;\n\n\tif (mode_lib->vba.GPUVMEnable)\n\t\tmode_lib->vba.UrgentExtraLatency += mode_lib->vba.TotalActiveDPP\n\t\t\t\t* mode_lib->vba.PTEGroupSize / mode_lib->vba.ReturnBW;\n\n\tmode_lib->vba.UrgentWatermark = mode_lib->vba.UrgentLatencyPixelDataOnly\n\t\t\t+ mode_lib->vba.LastPixelOfLineExtraWatermark\n\t\t\t+ mode_lib->vba.UrgentExtraLatency;\n\n\tDTRACE(\"   urgent_extra_latency = %fus\", mode_lib->vba.UrgentExtraLatency);\n\tDTRACE(\"   wm_urgent = %fus\", mode_lib->vba.UrgentWatermark);\n\n\tmode_lib->vba.UrgentLatency = mode_lib->vba.UrgentLatencyPixelDataOnly;\n\n\tmode_lib->vba.TotalActiveWriteback = 0;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.WritebackEnable[k])\n\t\t\tmode_lib->vba.TotalActiveWriteback = mode_lib->vba.TotalActiveWriteback + mode_lib->vba.ActiveWritebacksPerPlane[k];\n\t}\n\n\tif (mode_lib->vba.TotalActiveWriteback <= 1)\n\t\tmode_lib->vba.WritebackUrgentWatermark = mode_lib->vba.WritebackLatency;\n\telse\n\t\tmode_lib->vba.WritebackUrgentWatermark = mode_lib->vba.WritebackLatency\n\t\t\t\t+ mode_lib->vba.WritebackChunkSize * 1024.0 / 32\n\t\t\t\t\t\t/ mode_lib->vba.SOCCLK;\n\n\tDTRACE(\"   wm_wb_urgent = %fus\", mode_lib->vba.WritebackUrgentWatermark);\n\n\t\n\tmode_lib->vba.DRAMClockChangeWatermark = mode_lib->vba.DRAMClockChangeLatency\n\t\t\t+ mode_lib->vba.UrgentWatermark;\n\n\tDTRACE(\"   wm_pstate_change = %fus\", mode_lib->vba.DRAMClockChangeWatermark);\n\n\tDTRACE(\"   calculating wb pstate watermark\");\n\tDTRACE(\"      total wb outputs %d\", mode_lib->vba.TotalActiveWriteback);\n\tDTRACE(\"      socclk frequency %f Mhz\", mode_lib->vba.SOCCLK);\n\n\tif (mode_lib->vba.TotalActiveWriteback <= 1)\n\t\tmode_lib->vba.WritebackDRAMClockChangeWatermark =\n\t\t\t\tmode_lib->vba.DRAMClockChangeLatency\n\t\t\t\t\t\t+ mode_lib->vba.WritebackLatency;\n\telse\n\t\tmode_lib->vba.WritebackDRAMClockChangeWatermark =\n\t\t\t\tmode_lib->vba.DRAMClockChangeLatency\n\t\t\t\t\t\t+ mode_lib->vba.WritebackLatency\n\t\t\t\t\t\t+ mode_lib->vba.WritebackChunkSize * 1024.0 / 32\n\t\t\t\t\t\t\t\t/ mode_lib->vba.SOCCLK;\n\n\tDTRACE(\"   wm_wb_pstate %fus\", mode_lib->vba.WritebackDRAMClockChangeWatermark);\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.LinesInDETY[k] = mode_lib->vba.DETBufferSizeY[k]\n\t\t\t\t/ mode_lib->vba.BytePerPixelDETY[k] / mode_lib->vba.SwathWidthY[k];\n\t\tmode_lib->vba.LinesInDETYRoundedDownToSwath[k] = dml_floor(\n\t\t\t\tmode_lib->vba.LinesInDETY[k],\n\t\t\t\tmode_lib->vba.SwathHeightY[k]);\n\t\tmode_lib->vba.FullDETBufferingTimeY[k] =\n\t\t\t\tmode_lib->vba.LinesInDETYRoundedDownToSwath[k]\n\t\t\t\t\t\t* (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k])\n\t\t\t\t\t\t/ mode_lib->vba.VRatio[k];\n\t\tif (mode_lib->vba.BytePerPixelDETC[k] > 0) {\n\t\t\tmode_lib->vba.LinesInDETC[k] = mode_lib->vba.DETBufferSizeC[k]\n\t\t\t\t\t/ mode_lib->vba.BytePerPixelDETC[k]\n\t\t\t\t\t/ (mode_lib->vba.SwathWidthY[k] / 2);\n\t\t\tmode_lib->vba.LinesInDETCRoundedDownToSwath[k] = dml_floor(\n\t\t\t\t\tmode_lib->vba.LinesInDETC[k],\n\t\t\t\t\tmode_lib->vba.SwathHeightC[k]);\n\t\t\tmode_lib->vba.FullDETBufferingTimeC[k] =\n\t\t\t\t\tmode_lib->vba.LinesInDETCRoundedDownToSwath[k]\n\t\t\t\t\t\t\t* (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k])\n\t\t\t\t\t\t\t/ (mode_lib->vba.VRatio[k] / 2);\n\t\t} else {\n\t\t\tmode_lib->vba.LinesInDETC[k] = 0;\n\t\t\tmode_lib->vba.LinesInDETCRoundedDownToSwath[k] = 0;\n\t\t\tmode_lib->vba.FullDETBufferingTimeC[k] = 999999;\n\t\t}\n\t}\n\n\tmode_lib->vba.MinFullDETBufferingTime = 999999.0;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.FullDETBufferingTimeY[k]\n\t\t\t\t< mode_lib->vba.MinFullDETBufferingTime) {\n\t\t\tmode_lib->vba.MinFullDETBufferingTime =\n\t\t\t\t\tmode_lib->vba.FullDETBufferingTimeY[k];\n\t\t\tmode_lib->vba.FrameTimeForMinFullDETBufferingTime =\n\t\t\t\t\t(double) mode_lib->vba.VTotal[k] * mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k];\n\t\t}\n\t\tif (mode_lib->vba.FullDETBufferingTimeC[k]\n\t\t\t\t< mode_lib->vba.MinFullDETBufferingTime) {\n\t\t\tmode_lib->vba.MinFullDETBufferingTime =\n\t\t\t\t\tmode_lib->vba.FullDETBufferingTimeC[k];\n\t\t\tmode_lib->vba.FrameTimeForMinFullDETBufferingTime =\n\t\t\t\t\t(double) mode_lib->vba.VTotal[k] * mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k];\n\t\t}\n\t}\n\n\tmode_lib->vba.AverageReadBandwidthGBytePerSecond = 0.0;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.DCCEnable[k]) {\n\t\t\tmode_lib->vba.AverageReadBandwidthGBytePerSecond =\n\t\t\t\t\tmode_lib->vba.AverageReadBandwidthGBytePerSecond\n\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.DCCRate[k]\n\t\t\t\t\t\t\t\t\t/ 1000\n\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneChroma[k]\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.DCCRate[k]\n\t\t\t\t\t\t\t\t\t/ 1000;\n\t\t} else {\n\t\t\tmode_lib->vba.AverageReadBandwidthGBytePerSecond =\n\t\t\t\t\tmode_lib->vba.AverageReadBandwidthGBytePerSecond\n\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t\t\t\t\t\t/ 1000\n\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneChroma[k]\n\t\t\t\t\t\t\t\t\t/ 1000;\n\t\t}\n\t\tif (mode_lib->vba.DCCEnable[k]) {\n\t\t\tmode_lib->vba.AverageReadBandwidthGBytePerSecond =\n\t\t\t\t\tmode_lib->vba.AverageReadBandwidthGBytePerSecond\n\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t\t\t\t\t\t/ 1000 / 256\n\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneChroma[k]\n\t\t\t\t\t\t\t\t\t/ 1000 / 256;\n\t\t}\n\t\tif (mode_lib->vba.GPUVMEnable) {\n\t\t\tmode_lib->vba.AverageReadBandwidthGBytePerSecond =\n\t\t\t\t\tmode_lib->vba.AverageReadBandwidthGBytePerSecond\n\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t\t\t\t\t\t/ 1000 / 512\n\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneChroma[k]\n\t\t\t\t\t\t\t\t\t/ 1000 / 512;\n\t\t}\n\t}\n\n\tmode_lib->vba.PartOfBurstThatFitsInROB =\n\t\t\tdml_min(\n\t\t\t\t\tmode_lib->vba.MinFullDETBufferingTime\n\t\t\t\t\t\t\t* mode_lib->vba.TotalDataReadBandwidth,\n\t\t\t\t\tmode_lib->vba.ROBBufferSizeInKByte * 1024\n\t\t\t\t\t\t\t* mode_lib->vba.TotalDataReadBandwidth\n\t\t\t\t\t\t\t/ (mode_lib->vba.AverageReadBandwidthGBytePerSecond\n\t\t\t\t\t\t\t\t\t* 1000));\n\tmode_lib->vba.StutterBurstTime = mode_lib->vba.PartOfBurstThatFitsInROB\n\t\t\t* (mode_lib->vba.AverageReadBandwidthGBytePerSecond * 1000)\n\t\t\t/ mode_lib->vba.TotalDataReadBandwidth / mode_lib->vba.ReturnBW\n\t\t\t+ (mode_lib->vba.MinFullDETBufferingTime\n\t\t\t\t\t* mode_lib->vba.TotalDataReadBandwidth\n\t\t\t\t\t- mode_lib->vba.PartOfBurstThatFitsInROB)\n\t\t\t\t\t/ (mode_lib->vba.DCFCLK * 64);\n\tif (mode_lib->vba.TotalActiveWriteback == 0) {\n\t\tmode_lib->vba.StutterEfficiencyNotIncludingVBlank = (1\n\t\t\t\t- (mode_lib->vba.SRExitTime + mode_lib->vba.StutterBurstTime)\n\t\t\t\t\t\t/ mode_lib->vba.MinFullDETBufferingTime) * 100;\n\t} else {\n\t\tmode_lib->vba.StutterEfficiencyNotIncludingVBlank = 0;\n\t}\n\n\tmode_lib->vba.SmallestVBlank = 999999;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.SynchronizedVBlank || mode_lib->vba.NumberOfActivePlanes == 1) {\n\t\t\tmode_lib->vba.VBlankTime = (double) (mode_lib->vba.VTotal[k]\n\t\t\t\t\t- mode_lib->vba.VActive[k]) * mode_lib->vba.HTotal[k]\n\t\t\t\t\t/ mode_lib->vba.PixelClock[k];\n\t\t} else {\n\t\t\tmode_lib->vba.VBlankTime = 0;\n\t\t}\n\t\tmode_lib->vba.SmallestVBlank = dml_min(\n\t\t\t\tmode_lib->vba.SmallestVBlank,\n\t\t\t\tmode_lib->vba.VBlankTime);\n\t}\n\n\tmode_lib->vba.StutterEfficiency = (mode_lib->vba.StutterEfficiencyNotIncludingVBlank / 100\n\t\t\t* (mode_lib->vba.FrameTimeForMinFullDETBufferingTime\n\t\t\t\t\t- mode_lib->vba.SmallestVBlank)\n\t\t\t+ mode_lib->vba.SmallestVBlank)\n\t\t\t/ mode_lib->vba.FrameTimeForMinFullDETBufferingTime * 100;\n\n\t\n\tmode_lib->vba.DCFCLKDeepSleep = 8.0;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; k++) {\n\t\tif (mode_lib->vba.BytePerPixelDETC[k] > 0) {\n\t\t\tmode_lib->vba.DCFCLKDeepSleepPerPlane[k] =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t1.1 * mode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelDETY[k],\n\t\t\t\t\t\t\t\t\t\t\t1) / 32\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.DisplayPipeLineDeliveryTimeLuma[k],\n\t\t\t\t\t\t\t1.1 * mode_lib->vba.SwathWidthY[k] / 2.0\n\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelDETC[k],\n\t\t\t\t\t\t\t\t\t\t\t2) / 32\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.DisplayPipeLineDeliveryTimeChroma[k]);\n\t\t} else\n\t\t\tmode_lib->vba.DCFCLKDeepSleepPerPlane[k] = 1.1 * mode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t* dml_ceil(mode_lib->vba.BytePerPixelDETY[k], 1) / 64.0\n\t\t\t\t\t/ mode_lib->vba.DisplayPipeLineDeliveryTimeLuma[k];\n\t\tmode_lib->vba.DCFCLKDeepSleepPerPlane[k] = dml_max(\n\t\t\t\tmode_lib->vba.DCFCLKDeepSleepPerPlane[k],\n\t\t\t\tmode_lib->vba.PixelClock[k] / 16.0);\n\t\tmode_lib->vba.DCFCLKDeepSleep = dml_max(\n\t\t\t\tmode_lib->vba.DCFCLKDeepSleep,\n\t\t\t\tmode_lib->vba.DCFCLKDeepSleepPerPlane[k]);\n\n\t\tDTRACE(\n\t\t\t\t\"   dcfclk_deepsleep_per_plane[%i] = %fMHz\",\n\t\t\t\tk,\n\t\t\t\tmode_lib->vba.DCFCLKDeepSleepPerPlane[k]);\n\t}\n\n\tDTRACE(\"   dcfclk_deepsleep_mhz = %fMHz\", mode_lib->vba.DCFCLKDeepSleep);\n\n\t\n\tmode_lib->vba.StutterExitWatermark = mode_lib->vba.SRExitTime\n\t\t\t+ mode_lib->vba.LastPixelOfLineExtraWatermark\n\t\t\t+ mode_lib->vba.UrgentExtraLatency + 10 / mode_lib->vba.DCFCLKDeepSleep;\n\tmode_lib->vba.StutterEnterPlusExitWatermark = mode_lib->vba.SREnterPlusExitTime\n\t\t\t+ mode_lib->vba.LastPixelOfLineExtraWatermark\n\t\t\t+ mode_lib->vba.UrgentExtraLatency;\n\n\tDTRACE(\"   wm_cstate_exit       = %fus\", mode_lib->vba.StutterExitWatermark);\n\tDTRACE(\"   wm_cstate_enter_exit = %fus\", mode_lib->vba.StutterEnterPlusExitWatermark);\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.EffectiveDETPlusLBLinesLuma =\n\t\t\t\tdml_floor(\n\t\t\t\t\t\tmode_lib->vba.LinesInDETY[k]\n\t\t\t\t\t\t\t\t+ dml_min(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.LinesInDETY[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.DPPCLK[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.BytePerPixelDETY[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.PSCL_THROUGHPUT_LUMA[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.ReturnBW\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.DPPPerPlane[k]),\n\t\t\t\t\t\t\t\t\t\t(double) mode_lib->vba.EffectiveLBLatencyHidingSourceLinesLuma),\n\t\t\t\t\t\tmode_lib->vba.SwathHeightY[k]);\n\n\t\tmode_lib->vba.UrgentLatencySupportUsLuma = mode_lib->vba.EffectiveDETPlusLBLinesLuma\n\t\t\t\t* (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k])\n\t\t\t\t/ mode_lib->vba.VRatio[k]\n\t\t\t\t- mode_lib->vba.EffectiveDETPlusLBLinesLuma\n\t\t\t\t\t\t* mode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t* mode_lib->vba.BytePerPixelDETY[k]\n\t\t\t\t\t\t/ (mode_lib->vba.ReturnBW\n\t\t\t\t\t\t\t\t/ mode_lib->vba.DPPPerPlane[k]);\n\n\t\tif (mode_lib->vba.BytePerPixelDETC[k] > 0) {\n\t\t\tmode_lib->vba.EffectiveDETPlusLBLinesChroma =\n\t\t\t\t\tdml_floor(\n\t\t\t\t\t\t\tmode_lib->vba.LinesInDETC[k]\n\t\t\t\t\t\t\t\t\t+ dml_min(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.LinesInDETC[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.DPPCLK[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.BytePerPixelDETC[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.PSCL_THROUGHPUT_CHROMA[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.ReturnBW\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.DPPPerPlane[k]),\n\t\t\t\t\t\t\t\t\t\t\t(double) mode_lib->vba.EffectiveLBLatencyHidingSourceLinesChroma),\n\t\t\t\t\t\t\tmode_lib->vba.SwathHeightC[k]);\n\t\t\tmode_lib->vba.UrgentLatencySupportUsChroma =\n\t\t\t\t\tmode_lib->vba.EffectiveDETPlusLBLinesChroma\n\t\t\t\t\t\t\t* (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k])\n\t\t\t\t\t\t\t/ (mode_lib->vba.VRatio[k] / 2)\n\t\t\t\t\t\t\t- mode_lib->vba.EffectiveDETPlusLBLinesChroma\n\t\t\t\t\t\t\t\t\t* (mode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t\t\t\t\t/ 2)\n\t\t\t\t\t\t\t\t\t* mode_lib->vba.BytePerPixelDETC[k]\n\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.ReturnBW\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.DPPPerPlane[k]);\n\t\t\tmode_lib->vba.UrgentLatencySupportUs[k] = dml_min(\n\t\t\t\t\tmode_lib->vba.UrgentLatencySupportUsLuma,\n\t\t\t\t\tmode_lib->vba.UrgentLatencySupportUsChroma);\n\t\t} else {\n\t\t\tmode_lib->vba.UrgentLatencySupportUs[k] =\n\t\t\t\t\tmode_lib->vba.UrgentLatencySupportUsLuma;\n\t\t}\n\t}\n\n\tmode_lib->vba.MinUrgentLatencySupportUs = 999999;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.MinUrgentLatencySupportUs = dml_min(\n\t\t\t\tmode_lib->vba.MinUrgentLatencySupportUs,\n\t\t\t\tmode_lib->vba.UrgentLatencySupportUs[k]);\n\t}\n\n\t\n\tmode_lib->vba.NonUrgentLatencyTolerance = mode_lib->vba.MinUrgentLatencySupportUs\n\t\t\t- mode_lib->vba.UrgentWatermark;\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif ((mode_lib->vba.BlendingAndTiming[k] != k) || !mode_lib->vba.DSCEnabled[k]) {\n\t\t\tmode_lib->vba.DSCCLK_calculated[k] = 0.0;\n\t\t} else {\n\t\t\tif (mode_lib->vba.OutputFormat[k] == dm_420\n\t\t\t\t\t|| mode_lib->vba.OutputFormat[k] == dm_n422)\n\t\t\t\tmode_lib->vba.DSCFormatFactor = 2;\n\t\t\telse\n\t\t\t\tmode_lib->vba.DSCFormatFactor = 1;\n\t\t\tif (mode_lib->vba.ODMCombineEnabled[k])\n\t\t\t\tmode_lib->vba.DSCCLK_calculated[k] =\n\t\t\t\t\t\tmode_lib->vba.PixelClockBackEnd[k] / 6\n\t\t\t\t\t\t\t\t/ mode_lib->vba.DSCFormatFactor\n\t\t\t\t\t\t\t\t/ (1\n\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading\n\t\t\t\t\t\t\t\t\t\t\t\t/ 100);\n\t\t\telse\n\t\t\t\tmode_lib->vba.DSCCLK_calculated[k] =\n\t\t\t\t\t\tmode_lib->vba.PixelClockBackEnd[k] / 3\n\t\t\t\t\t\t\t\t/ mode_lib->vba.DSCFormatFactor\n\t\t\t\t\t\t\t\t/ (1\n\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading\n\t\t\t\t\t\t\t\t\t\t\t\t/ 100);\n\t\t}\n\t}\n\n\t\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tdouble bpp = mode_lib->vba.OutputBpp[k];\n\t\tunsigned int slices = mode_lib->vba.NumberOfDSCSlices[k];\n\n\t\tif (mode_lib->vba.DSCEnabled[k] && bpp != 0) {\n\t\t\tif (!mode_lib->vba.ODMCombineEnabled[k]) {\n\t\t\t\tmode_lib->vba.DSCDelay[k] =\n\t\t\t\t\t\tdscceComputeDelay(\n\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k],\n\t\t\t\t\t\t\t\tbpp,\n\t\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\t\t(double) mode_lib->vba.HActive[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.NumberOfDSCSlices[k],\n\t\t\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t\t\t\tslices,\n\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k])\n\t\t\t\t\t\t\t\t+ dscComputeDelay(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k]);\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.DSCDelay[k] =\n\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t* (dscceComputeDelay(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k],\n\t\t\t\t\t\t\t\t\t\tbpp,\n\t\t\t\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t(double) mode_lib->vba.HActive[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.NumberOfDSCSlices[k],\n\t\t\t\t\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t\t\t\t\t\tslices / 2.0,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k])\n\t\t\t\t\t\t\t\t\t\t+ dscComputeDelay(\n\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k]));\n\t\t\t}\n\t\t\tmode_lib->vba.DSCDelay[k] = mode_lib->vba.DSCDelay[k]\n\t\t\t\t\t* mode_lib->vba.PixelClock[k]\n\t\t\t\t\t/ mode_lib->vba.PixelClockBackEnd[k];\n\t\t} else {\n\t\t\tmode_lib->vba.DSCDelay[k] = 0;\n\t\t}\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k)\n\t\tfor (j = 0; j < mode_lib->vba.NumberOfActivePlanes; ++j) \n\t\t\tif (j != k && mode_lib->vba.BlendingAndTiming[k] == j\n\t\t\t\t\t&& mode_lib->vba.DSCEnabled[j])\n\t\t\t\tmode_lib->vba.DSCDelay[k] = mode_lib->vba.DSCDelay[j];\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tunsigned int PDEAndMetaPTEBytesFrameY;\n\t\tunsigned int PixelPTEBytesPerRowY;\n\t\tunsigned int MetaRowByteY;\n\t\tunsigned int MetaRowByteC;\n\t\tunsigned int PDEAndMetaPTEBytesFrameC;\n\t\tunsigned int PixelPTEBytesPerRowC;\n\n\t\tCalculate256BBlockSizes(\n\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\tmode_lib->vba.SurfaceTiling[k],\n\t\t\t\tdml_ceil(mode_lib->vba.BytePerPixelDETY[k], 1),\n\t\t\t\tdml_ceil(mode_lib->vba.BytePerPixelDETC[k], 2),\n\t\t\t\t&mode_lib->vba.BlockHeight256BytesY[k],\n\t\t\t\t&mode_lib->vba.BlockHeight256BytesC[k],\n\t\t\t\t&mode_lib->vba.BlockWidth256BytesY[k],\n\t\t\t\t&mode_lib->vba.BlockWidth256BytesC[k]);\n\t\tPDEAndMetaPTEBytesFrameY = CalculateVMAndRowBytes(\n\t\t\t\tmode_lib,\n\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\tmode_lib->vba.BlockHeight256BytesY[k],\n\t\t\t\tmode_lib->vba.BlockWidth256BytesY[k],\n\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\tmode_lib->vba.SurfaceTiling[k],\n\t\t\t\tdml_ceil(mode_lib->vba.BytePerPixelDETY[k], 1),\n\t\t\t\tmode_lib->vba.SourceScan[k],\n\t\t\t\tmode_lib->vba.ViewportWidth[k],\n\t\t\t\tmode_lib->vba.ViewportHeight[k],\n\t\t\t\tmode_lib->vba.SwathWidthY[k],\n\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\tmode_lib->vba.VMMPageSize,\n\t\t\t\tmode_lib->vba.PTEBufferSizeInRequestsLuma,\n\t\t\t\tmode_lib->vba.PDEProcessingBufIn64KBReqs,\n\t\t\t\tmode_lib->vba.PitchY[k],\n\t\t\t\tmode_lib->vba.DCCMetaPitchY[k],\n\t\t\t\t&mode_lib->vba.MacroTileWidthY[k],\n\t\t\t\t&MetaRowByteY,\n\t\t\t\t&PixelPTEBytesPerRowY,\n\t\t\t\t&mode_lib->vba.PTEBufferSizeNotExceeded[mode_lib->vba.VoltageLevel][0],\n\t\t\t\t&mode_lib->vba.dpte_row_height[k],\n\t\t\t\t&mode_lib->vba.meta_row_height[k]);\n\t\tmode_lib->vba.PrefetchSourceLinesY[k] = CalculatePrefetchSourceLines(\n\t\t\t\tmode_lib,\n\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\tmode_lib->vba.vtaps[k],\n\t\t\t\tmode_lib->vba.Interlace[k],\n\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP,\n\t\t\t\tmode_lib->vba.SwathHeightY[k],\n\t\t\t\tmode_lib->vba.ViewportYStartY[k],\n\t\t\t\t&mode_lib->vba.VInitPreFillY[k],\n\t\t\t\t&mode_lib->vba.MaxNumSwathY[k]);\n\n\t\tif ((mode_lib->vba.SourcePixelFormat[k] != dm_444_64\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_32\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_16\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_8)) {\n\t\t\tPDEAndMetaPTEBytesFrameC =\n\t\t\t\t\tCalculateVMAndRowBytes(\n\t\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\t\tmode_lib->vba.BlockHeight256BytesC[k],\n\t\t\t\t\t\t\tmode_lib->vba.BlockWidth256BytesC[k],\n\t\t\t\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\t\t\t\tmode_lib->vba.SurfaceTiling[k],\n\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelDETC[k],\n\t\t\t\t\t\t\t\t\t2),\n\t\t\t\t\t\t\tmode_lib->vba.SourceScan[k],\n\t\t\t\t\t\t\tmode_lib->vba.ViewportWidth[k] / 2,\n\t\t\t\t\t\t\tmode_lib->vba.ViewportHeight[k] / 2,\n\t\t\t\t\t\t\tmode_lib->vba.SwathWidthY[k] / 2,\n\t\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\t\tmode_lib->vba.VMMPageSize,\n\t\t\t\t\t\t\tmode_lib->vba.PTEBufferSizeInRequestsLuma,\n\t\t\t\t\t\t\tmode_lib->vba.PDEProcessingBufIn64KBReqs,\n\t\t\t\t\t\t\tmode_lib->vba.PitchC[k],\n\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t&mode_lib->vba.MacroTileWidthC[k],\n\t\t\t\t\t\t\t&MetaRowByteC,\n\t\t\t\t\t\t\t&PixelPTEBytesPerRowC,\n\t\t\t\t\t\t\t&mode_lib->vba.PTEBufferSizeNotExceeded[mode_lib->vba.VoltageLevel][0],\n\t\t\t\t\t\t\t&mode_lib->vba.dpte_row_height_chroma[k],\n\t\t\t\t\t\t\t&mode_lib->vba.meta_row_height_chroma[k]);\n\t\t\tmode_lib->vba.PrefetchSourceLinesC[k] = CalculatePrefetchSourceLines(\n\t\t\t\t\tmode_lib,\n\t\t\t\t\tmode_lib->vba.VRatio[k] / 2,\n\t\t\t\t\tmode_lib->vba.VTAPsChroma[k],\n\t\t\t\t\tmode_lib->vba.Interlace[k],\n\t\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP,\n\t\t\t\t\tmode_lib->vba.SwathHeightC[k],\n\t\t\t\t\tmode_lib->vba.ViewportYStartC[k],\n\t\t\t\t\t&mode_lib->vba.VInitPreFillC[k],\n\t\t\t\t\t&mode_lib->vba.MaxNumSwathC[k]);\n\t\t} else {\n\t\t\tPixelPTEBytesPerRowC = 0;\n\t\t\tPDEAndMetaPTEBytesFrameC = 0;\n\t\t\tMetaRowByteC = 0;\n\t\t\tmode_lib->vba.MaxNumSwathC[k] = 0;\n\t\t\tmode_lib->vba.PrefetchSourceLinesC[k] = 0;\n\t\t}\n\n\t\tmode_lib->vba.PixelPTEBytesPerRow[k] = PixelPTEBytesPerRowY + PixelPTEBytesPerRowC;\n\t\tmode_lib->vba.PDEAndMetaPTEBytesFrame[k] = PDEAndMetaPTEBytesFrameY\n\t\t\t\t+ PDEAndMetaPTEBytesFrameC;\n\t\tmode_lib->vba.MetaRowByte[k] = MetaRowByteY + MetaRowByteC;\n\n\t\tCalculateActiveRowBandwidth(\n\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\tmode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k],\n\t\t\t\tMetaRowByteY,\n\t\t\t\tMetaRowByteC,\n\t\t\t\tmode_lib->vba.meta_row_height[k],\n\t\t\t\tmode_lib->vba.meta_row_height_chroma[k],\n\t\t\t\tPixelPTEBytesPerRowY,\n\t\t\t\tPixelPTEBytesPerRowC,\n\t\t\t\tmode_lib->vba.dpte_row_height[k],\n\t\t\t\tmode_lib->vba.dpte_row_height_chroma[k],\n\t\t\t\t&mode_lib->vba.meta_row_bw[k],\n\t\t\t\t&mode_lib->vba.dpte_row_bw[k],\n\t\t\t\t&mode_lib->vba.qual_row_bw[k]);\n\t}\n\n\tmode_lib->vba.TCalc = 24.0 / mode_lib->vba.DCFCLKDeepSleep;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\t\tmode_lib->vba.WritebackDelay[mode_lib->vba.VoltageLevel][k] =\n\t\t\t\t\t\tmode_lib->vba.WritebackLatency\n\t\t\t\t\t\t\t\t+ CalculateWriteBackDelay(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaHTaps[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaVTaps[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaHTaps[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaVTaps[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[k])\n\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.DISPCLK;\n\t\t\t} else\n\t\t\t\tmode_lib->vba.WritebackDelay[mode_lib->vba.VoltageLevel][k] = 0;\n\t\t\tfor (j = 0; j < mode_lib->vba.NumberOfActivePlanes; ++j) {\n\t\t\t\tif (mode_lib->vba.BlendingAndTiming[j] == k\n\t\t\t\t\t\t&& mode_lib->vba.WritebackEnable[j] == true) {\n\t\t\t\t\tmode_lib->vba.WritebackDelay[mode_lib->vba.VoltageLevel][k] =\n\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDelay[mode_lib->vba.VoltageLevel][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLatency\n\t\t\t\t\t\t\t\t\t\t\t+ CalculateWriteBackDelay(\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[j],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[j],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[j],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaHTaps[j],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaVTaps[j],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaHTaps[j],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaVTaps[j],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[j])\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.DISPCLK);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k)\n\t\tfor (j = 0; j < mode_lib->vba.NumberOfActivePlanes; ++j)\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == j)\n\t\t\t\tmode_lib->vba.WritebackDelay[mode_lib->vba.VoltageLevel][k] =\n\t\t\t\t\t\tmode_lib->vba.WritebackDelay[mode_lib->vba.VoltageLevel][j];\n\n\tmode_lib->vba.VStartupLines = 13;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.MaxVStartupLines[k] =\n\t\t\t\tmode_lib->vba.VTotal[k] - mode_lib->vba.VActive[k]\n\t\t\t\t\t\t- dml_max(\n\t\t\t\t\t\t\t\t1.0,\n\t\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDelay[mode_lib->vba.VoltageLevel][k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]),\n\t\t\t\t\t\t\t\t\t\t1));\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k)\n\t\tmode_lib->vba.MaximumMaxVStartupLines = dml_max(\n\t\t\t\tmode_lib->vba.MaximumMaxVStartupLines,\n\t\t\t\tmode_lib->vba.MaxVStartupLines[k]);\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.cursor_bw[k] = 0.0;\n\t\tfor (j = 0; j < mode_lib->vba.NumberOfCursors[k]; ++j)\n\t\t\tmode_lib->vba.cursor_bw[k] += mode_lib->vba.CursorWidth[k][j]\n\t\t\t\t\t* mode_lib->vba.CursorBPP[k][j] / 8.0\n\t\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k])\n\t\t\t\t\t* mode_lib->vba.VRatio[k];\n\t}\n\n\tdo {\n\t\tdouble MaxTotalRDBandwidth = 0;\n\t\tbool DestinationLineTimesForPrefetchLessThan2 = false;\n\t\tbool VRatioPrefetchMoreThan4 = false;\n\t\tbool prefetch_vm_bw_valid = true;\n\t\tbool prefetch_row_bw_valid = true;\n\t\tdouble TWait = CalculateTWait(\n\t\t\t\tmode_lib->vba.PrefetchMode[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb],\n\t\t\t\tmode_lib->vba.DRAMClockChangeLatency,\n\t\t\t\tmode_lib->vba.UrgentLatencyPixelDataOnly,\n\t\t\t\tmode_lib->vba.SREnterPlusExitTime);\n\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\tif (mode_lib->vba.XFCEnabled[k] == true) {\n\t\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipDelay =\n\t\t\t\t\t\tCalculateRemoteSurfaceFlipDelay(\n\t\t\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.SwathWidthY[k],\n\t\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelDETY[k],\n\t\t\t\t\t\t\t\t\t\t1),\n\t\t\t\t\t\t\t\tmode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.XFCTSlvVupdateOffset,\n\t\t\t\t\t\t\t\tmode_lib->vba.XFCTSlvVupdateWidth,\n\t\t\t\t\t\t\t\tmode_lib->vba.XFCTSlvVreadyOffset,\n\t\t\t\t\t\t\t\tmode_lib->vba.XFCXBUFLatencyTolerance,\n\t\t\t\t\t\t\t\tmode_lib->vba.XFCFillBWOverhead,\n\t\t\t\t\t\t\t\tmode_lib->vba.XFCSlvChunkSize,\n\t\t\t\t\t\t\t\tmode_lib->vba.XFCBusTransportTime,\n\t\t\t\t\t\t\t\tmode_lib->vba.TCalc,\n\t\t\t\t\t\t\t\tTWait,\n\t\t\t\t\t\t\t\t&mode_lib->vba.SrcActiveDrainRate,\n\t\t\t\t\t\t\t\t&mode_lib->vba.TInitXFill,\n\t\t\t\t\t\t\t\t&mode_lib->vba.TslvChk);\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipDelay = 0;\n\t\t\t}\n\t\t\tmode_lib->vba.ErrorResult[k] =\n\t\t\t\t\tCalculatePrefetchSchedule(\n\t\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\t\tmode_lib->vba.DPPCLK[k],\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLK,\n\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\tmode_lib->vba.DCFCLKDeepSleep,\n\t\t\t\t\t\t\tmode_lib->vba.DSCDelay[k],\n\t\t\t\t\t\t\tmode_lib->vba.DPPPerPlane[k],\n\t\t\t\t\t\t\tmode_lib->vba.ScalerEnabled[k],\n\t\t\t\t\t\t\tmode_lib->vba.NumberOfCursors[k],\n\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelaySubtotal,\n\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelaySCL,\n\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelaySCLLBOnly,\n\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelayCNVCFormater,\n\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelayCNVCCursor,\n\t\t\t\t\t\t\tmode_lib->vba.DISPCLKDelaySubtotal,\n\t\t\t\t\t\t\t(unsigned int) (mode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.HRatio[k]),\n\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\tmode_lib->vba.VTotal[k]\n\t\t\t\t\t\t\t\t\t- mode_lib->vba.VActive[k],\n\t\t\t\t\t\t\tmode_lib->vba.HTotal[k],\n\t\t\t\t\t\t\tmode_lib->vba.MaxInterDCNTileRepeaters,\n\t\t\t\t\t\t\tdml_min(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.VStartupLines,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.MaxVStartupLines[k]),\n\t\t\t\t\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\t\tmode_lib->vba.DynamicMetadataEnable[k],\n\t\t\t\t\t\t\tmode_lib->vba.DynamicMetadataLinesBeforeActiveRequired[k],\n\t\t\t\t\t\t\tmode_lib->vba.DynamicMetadataTransmittedBytes[k],\n\t\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\t\tmode_lib->vba.UrgentLatencyPixelDataOnly,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentExtraLatency,\n\t\t\t\t\t\t\tmode_lib->vba.TCalc,\n\t\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesFrame[k],\n\t\t\t\t\t\t\tmode_lib->vba.MetaRowByte[k],\n\t\t\t\t\t\t\tmode_lib->vba.PixelPTEBytesPerRow[k],\n\t\t\t\t\t\t\tmode_lib->vba.PrefetchSourceLinesY[k],\n\t\t\t\t\t\t\tmode_lib->vba.SwathWidthY[k],\n\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelDETY[k],\n\t\t\t\t\t\t\tmode_lib->vba.VInitPreFillY[k],\n\t\t\t\t\t\t\tmode_lib->vba.MaxNumSwathY[k],\n\t\t\t\t\t\t\tmode_lib->vba.PrefetchSourceLinesC[k],\n\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelDETC[k],\n\t\t\t\t\t\t\tmode_lib->vba.VInitPreFillC[k],\n\t\t\t\t\t\t\tmode_lib->vba.MaxNumSwathC[k],\n\t\t\t\t\t\t\tmode_lib->vba.SwathHeightY[k],\n\t\t\t\t\t\t\tmode_lib->vba.SwathHeightC[k],\n\t\t\t\t\t\t\tTWait,\n\t\t\t\t\t\t\tmode_lib->vba.XFCEnabled[k],\n\t\t\t\t\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipDelay,\n\t\t\t\t\t\t\tmode_lib->vba.Interlace[k],\n\t\t\t\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP,\n\t\t\t\t\t\t\t&mode_lib->vba.DSTXAfterScaler[k],\n\t\t\t\t\t\t\t&mode_lib->vba.DSTYAfterScaler[k],\n\t\t\t\t\t\t\t&mode_lib->vba.DestinationLinesForPrefetch[k],\n\t\t\t\t\t\t\t&mode_lib->vba.PrefetchBandwidth[k],\n\t\t\t\t\t\t\t&mode_lib->vba.DestinationLinesToRequestVMInVBlank[k],\n\t\t\t\t\t\t\t&mode_lib->vba.DestinationLinesToRequestRowInVBlank[k],\n\t\t\t\t\t\t\t&mode_lib->vba.VRatioPrefetchY[k],\n\t\t\t\t\t\t\t&mode_lib->vba.VRatioPrefetchC[k],\n\t\t\t\t\t\t\t&mode_lib->vba.RequiredPrefetchPixDataBWLuma[k],\n\t\t\t\t\t\t\t&mode_lib->vba.VStartupRequiredWhenNotEnoughTimeForDynamicMetadata,\n\t\t\t\t\t\t\t&mode_lib->vba.Tno_bw[k],\n\t\t\t\t\t\t\t&mode_lib->vba.VUpdateOffsetPix[k],\n\t\t\t\t\t\t\t&mode_lib->vba.VUpdateWidthPix[k],\n\t\t\t\t\t\t\t&mode_lib->vba.VReadyOffsetPix[k]);\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\t\tmode_lib->vba.VStartup[k] = dml_min(\n\t\t\t\t\t\tmode_lib->vba.VStartupLines,\n\t\t\t\t\t\tmode_lib->vba.MaxVStartupLines[k]);\n\t\t\t\tif (mode_lib->vba.VStartupRequiredWhenNotEnoughTimeForDynamicMetadata\n\t\t\t\t\t\t!= 0) {\n\t\t\t\t\tmode_lib->vba.VStartup[k] =\n\t\t\t\t\t\t\tmode_lib->vba.VStartupRequiredWhenNotEnoughTimeForDynamicMetadata;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.VStartup[k] =\n\t\t\t\t\t\tdml_min(\n\t\t\t\t\t\t\t\tmode_lib->vba.VStartupLines,\n\t\t\t\t\t\t\t\tmode_lib->vba.MaxVStartupLines[mode_lib->vba.BlendingAndTiming[k]]);\n\t\t\t}\n\t\t}\n\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\n\t\t\tif (mode_lib->vba.PDEAndMetaPTEBytesFrame[k] == 0)\n\t\t\t\tmode_lib->vba.prefetch_vm_bw[k] = 0;\n\t\t\telse if (mode_lib->vba.DestinationLinesToRequestVMInVBlank[k] > 0) {\n\t\t\t\tmode_lib->vba.prefetch_vm_bw[k] =\n\t\t\t\t\t\t(double) mode_lib->vba.PDEAndMetaPTEBytesFrame[k]\n\t\t\t\t\t\t\t\t/ (mode_lib->vba.DestinationLinesToRequestVMInVBlank[k]\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]);\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.prefetch_vm_bw[k] = 0;\n\t\t\t\tprefetch_vm_bw_valid = false;\n\t\t\t}\n\t\t\tif (mode_lib->vba.MetaRowByte[k] + mode_lib->vba.PixelPTEBytesPerRow[k]\n\t\t\t\t\t== 0)\n\t\t\t\tmode_lib->vba.prefetch_row_bw[k] = 0;\n\t\t\telse if (mode_lib->vba.DestinationLinesToRequestRowInVBlank[k] > 0) {\n\t\t\t\tmode_lib->vba.prefetch_row_bw[k] =\n\t\t\t\t\t\t(double) (mode_lib->vba.MetaRowByte[k]\n\t\t\t\t\t\t\t\t+ mode_lib->vba.PixelPTEBytesPerRow[k])\n\t\t\t\t\t\t\t\t/ (mode_lib->vba.DestinationLinesToRequestRowInVBlank[k]\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]);\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.prefetch_row_bw[k] = 0;\n\t\t\t\tprefetch_row_bw_valid = false;\n\t\t\t}\n\n\t\t\tMaxTotalRDBandwidth =\n\t\t\t\t\tMaxTotalRDBandwidth + mode_lib->vba.cursor_bw[k]\n\t\t\t\t\t\t\t+ dml_max(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.prefetch_vm_bw[k],\n\t\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.prefetch_row_bw[k],\n\t\t\t\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneChroma[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixDataBWLuma[k])\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.meta_row_bw[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.dpte_row_bw[k]));\n\n\t\t\tif (mode_lib->vba.DestinationLinesForPrefetch[k] < 2)\n\t\t\t\tDestinationLineTimesForPrefetchLessThan2 = true;\n\t\t\tif (mode_lib->vba.VRatioPrefetchY[k] > 4\n\t\t\t\t\t|| mode_lib->vba.VRatioPrefetchC[k] > 4)\n\t\t\t\tVRatioPrefetchMoreThan4 = true;\n\t\t}\n\n\t\tif (MaxTotalRDBandwidth <= mode_lib->vba.ReturnBW && prefetch_vm_bw_valid\n\t\t\t\t&& prefetch_row_bw_valid && !VRatioPrefetchMoreThan4\n\t\t\t\t&& !DestinationLineTimesForPrefetchLessThan2)\n\t\t\tmode_lib->vba.PrefetchModeSupported = true;\n\t\telse {\n\t\t\tmode_lib->vba.PrefetchModeSupported = false;\n\t\t\tdml_print(\n\t\t\t\t\t\"DML: CalculatePrefetchSchedule ***failed***. Bandwidth violation. Results are NOT valid\\n\");\n\t\t}\n\n\t\tif (mode_lib->vba.PrefetchModeSupported == true) {\n\t\t\tdouble final_flip_bw[DC__NUM_DPP__MAX];\n\t\t\tunsigned int ImmediateFlipBytes[DC__NUM_DPP__MAX];\n\t\t\tdouble total_dcn_read_bw_with_flip = 0;\n\n\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip = mode_lib->vba.ReturnBW;\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip =\n\t\t\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip\n\t\t\t\t\t\t\t\t- mode_lib->vba.cursor_bw[k]\n\t\t\t\t\t\t\t\t- dml_max(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneChroma[k]\n\t\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.qual_row_bw[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.PrefetchBandwidth[k]);\n\t\t\t}\n\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\t\tImmediateFlipBytes[k] = 0;\n\t\t\t\tif ((mode_lib->vba.SourcePixelFormat[k] != dm_420_8\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_420_10)) {\n\t\t\t\t\tImmediateFlipBytes[k] =\n\t\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesFrame[k]\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.MetaRowByte[k]\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.PixelPTEBytesPerRow[k];\n\t\t\t\t}\n\t\t\t}\n\t\t\tmode_lib->vba.TotImmediateFlipBytes = 0;\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\t\tif ((mode_lib->vba.SourcePixelFormat[k] != dm_420_8\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_420_10)) {\n\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes =\n\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes\n\t\t\t\t\t\t\t\t\t+ ImmediateFlipBytes[k];\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\t\tCalculateFlipSchedule(\n\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\tmode_lib->vba.UrgentExtraLatency,\n\t\t\t\t\t\tmode_lib->vba.UrgentLatencyPixelDataOnly,\n\t\t\t\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip,\n\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes,\n\t\t\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\t\t\tImmediateFlipBytes[k],\n\t\t\t\t\t\tmode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k],\n\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\tmode_lib->vba.Tno_bw[k],\n\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesFrame[k],\n\t\t\t\t\t\tmode_lib->vba.MetaRowByte[k],\n\t\t\t\t\t\tmode_lib->vba.PixelPTEBytesPerRow[k],\n\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\tmode_lib->vba.dpte_row_height[k],\n\t\t\t\t\t\tmode_lib->vba.meta_row_height[k],\n\t\t\t\t\t\tmode_lib->vba.qual_row_bw[k],\n\t\t\t\t\t\t&mode_lib->vba.DestinationLinesToRequestVMInImmediateFlip[k],\n\t\t\t\t\t\t&mode_lib->vba.DestinationLinesToRequestRowInImmediateFlip[k],\n\t\t\t\t\t\t&final_flip_bw[k],\n\t\t\t\t\t\t&mode_lib->vba.ImmediateFlipSupportedForPipe[k]);\n\t\t\t}\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\t\ttotal_dcn_read_bw_with_flip =\n\t\t\t\t\t\ttotal_dcn_read_bw_with_flip\n\t\t\t\t\t\t\t\t+ mode_lib->vba.cursor_bw[k]\n\t\t\t\t\t\t\t\t+ dml_max(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.prefetch_vm_bw[k],\n\t\t\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.prefetch_row_bw[k],\n\t\t\t\t\t\t\t\t\t\t\t\tfinal_flip_bw[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t+ dml_max(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidthPlaneLuma[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.ReadBandwidthPlaneChroma[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixDataBWLuma[k])));\n\t\t\t}\n\t\t\tmode_lib->vba.ImmediateFlipSupported = true;\n\t\t\tif (total_dcn_read_bw_with_flip > mode_lib->vba.ReturnBW) {\n\t\t\t\tmode_lib->vba.ImmediateFlipSupported = false;\n\t\t\t}\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\t\tif (mode_lib->vba.ImmediateFlipSupportedForPipe[k] == false) {\n\t\t\t\t\tmode_lib->vba.ImmediateFlipSupported = false;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tmode_lib->vba.ImmediateFlipSupported = false;\n\t\t}\n\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\tif (mode_lib->vba.ErrorResult[k]) {\n\t\t\t\tmode_lib->vba.PrefetchModeSupported = false;\n\t\t\t\tdml_print(\n\t\t\t\t\t\t\"DML: CalculatePrefetchSchedule ***failed***. Prefetch schedule violation. Results are NOT valid\\n\");\n\t\t\t}\n\t\t}\n\n\t\tmode_lib->vba.VStartupLines = mode_lib->vba.VStartupLines + 1;\n\t} while (!((mode_lib->vba.PrefetchModeSupported\n\t\t\t&& (!mode_lib->vba.ImmediateFlipSupport\n\t\t\t\t\t|| mode_lib->vba.ImmediateFlipSupported))\n\t\t\t|| mode_lib->vba.MaximumMaxVStartupLines < mode_lib->vba.VStartupLines));\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.VRatioPrefetchY[k] <= 1) {\n\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeLumaPrefetch[k] =\n\t\t\t\t\tmode_lib->vba.SwathWidthY[k] * mode_lib->vba.DPPPerPlane[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k];\n\t\t} else {\n\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeLumaPrefetch[k] =\n\t\t\t\t\tmode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PSCL_THROUGHPUT_LUMA[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.DPPCLK[k];\n\t\t}\n\t\tif (mode_lib->vba.BytePerPixelDETC[k] == 0) {\n\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeChromaPrefetch[k] = 0;\n\t\t} else {\n\t\t\tif (mode_lib->vba.VRatioPrefetchC[k] <= 1) {\n\t\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeChromaPrefetch[k] =\n\t\t\t\t\t\tmode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t\t* mode_lib->vba.DPPPerPlane[k]\n\t\t\t\t\t\t\t\t/ mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k];\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.DisplayPipeLineDeliveryTimeChromaPrefetch[k] =\n\t\t\t\t\t\tmode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t\t/ mode_lib->vba.PSCL_THROUGHPUT_LUMA[k]\n\t\t\t\t\t\t\t\t/ mode_lib->vba.DPPCLK[k];\n\t\t\t}\n\t\t}\n\t}\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.PrefetchMode[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb] == 0) {\n\t\t\tmode_lib->vba.AllowDRAMClockChangeDuringVBlank[k] = true;\n\t\t\tmode_lib->vba.AllowDRAMSelfRefreshDuringVBlank[k] = true;\n\t\t\tmode_lib->vba.MinTTUVBlank[k] = dml_max(\n\t\t\t\t\tmode_lib->vba.DRAMClockChangeWatermark,\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tmode_lib->vba.StutterEnterPlusExitWatermark,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentWatermark));\n\t\t} else if (mode_lib->vba.PrefetchMode[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb] == 1) {\n\t\t\tmode_lib->vba.AllowDRAMClockChangeDuringVBlank[k] = false;\n\t\t\tmode_lib->vba.AllowDRAMSelfRefreshDuringVBlank[k] = true;\n\t\t\tmode_lib->vba.MinTTUVBlank[k] = dml_max(\n\t\t\t\t\tmode_lib->vba.StutterEnterPlusExitWatermark,\n\t\t\t\t\tmode_lib->vba.UrgentWatermark);\n\t\t} else {\n\t\t\tmode_lib->vba.AllowDRAMClockChangeDuringVBlank[k] = false;\n\t\t\tmode_lib->vba.AllowDRAMSelfRefreshDuringVBlank[k] = false;\n\t\t\tmode_lib->vba.MinTTUVBlank[k] = mode_lib->vba.UrgentWatermark;\n\t\t}\n\t\tif (!mode_lib->vba.DynamicMetadataEnable[k])\n\t\t\tmode_lib->vba.MinTTUVBlank[k] = mode_lib->vba.TCalc\n\t\t\t\t\t+ mode_lib->vba.MinTTUVBlank[k];\n\t}\n\n\t\n\tmode_lib->vba.ActiveDPPs = 0;\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tmode_lib->vba.ActiveDPPs = mode_lib->vba.ActiveDPPs + mode_lib->vba.DPPPerPlane[k];\n\t}\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tdouble EffectiveLBLatencyHidingY;\n\t\tdouble EffectiveLBLatencyHidingC;\n\t\tdouble DPPOutputBufferLinesY;\n\t\tdouble DPPOutputBufferLinesC;\n\t\tdouble DPPOPPBufferingY;\n\t\tdouble MaxDETBufferingTimeY;\n\t\tdouble ActiveDRAMClockChangeLatencyMarginY;\n\n\t\tmode_lib->vba.LBLatencyHidingSourceLinesY =\n\t\t\t\tdml_min(\n\t\t\t\t\t\tmode_lib->vba.MaxLineBufferLines,\n\t\t\t\t\t\t(unsigned int) dml_floor(\n\t\t\t\t\t\t\t\t(double) mode_lib->vba.LineBufferSize\n\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.LBBitPerPixel[k]\n\t\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ dml_max(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0)),\n\t\t\t\t\t\t\t\t1)) - (mode_lib->vba.vtaps[k] - 1);\n\n\t\tmode_lib->vba.LBLatencyHidingSourceLinesC =\n\t\t\t\tdml_min(\n\t\t\t\t\t\tmode_lib->vba.MaxLineBufferLines,\n\t\t\t\t\t\t(unsigned int) dml_floor(\n\t\t\t\t\t\t\t\t(double) mode_lib->vba.LineBufferSize\n\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.LBBitPerPixel[k]\n\t\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.SwathWidthY[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0\n\t\t\t\t\t\t\t\t\t\t\t\t/ dml_max(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 2,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0)),\n\t\t\t\t\t\t\t\t1))\n\t\t\t\t\t\t- (mode_lib->vba.VTAPsChroma[k] - 1);\n\n\t\tEffectiveLBLatencyHidingY = mode_lib->vba.LBLatencyHidingSourceLinesY\n\t\t\t\t/ mode_lib->vba.VRatio[k]\n\t\t\t\t* (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]);\n\n\t\tEffectiveLBLatencyHidingC = mode_lib->vba.LBLatencyHidingSourceLinesC\n\t\t\t\t/ (mode_lib->vba.VRatio[k] / 2)\n\t\t\t\t* (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]);\n\n\t\tif (mode_lib->vba.SwathWidthY[k] > 2 * mode_lib->vba.DPPOutputBufferPixels) {\n\t\t\tDPPOutputBufferLinesY = mode_lib->vba.DPPOutputBufferPixels\n\t\t\t\t\t/ mode_lib->vba.SwathWidthY[k];\n\t\t} else if (mode_lib->vba.SwathWidthY[k] > mode_lib->vba.DPPOutputBufferPixels) {\n\t\t\tDPPOutputBufferLinesY = 0.5;\n\t\t} else {\n\t\t\tDPPOutputBufferLinesY = 1;\n\t\t}\n\n\t\tif (mode_lib->vba.SwathWidthY[k] / 2 > 2 * mode_lib->vba.DPPOutputBufferPixels) {\n\t\t\tDPPOutputBufferLinesC = mode_lib->vba.DPPOutputBufferPixels\n\t\t\t\t\t/ (mode_lib->vba.SwathWidthY[k] / 2);\n\t\t} else if (mode_lib->vba.SwathWidthY[k] / 2 > mode_lib->vba.DPPOutputBufferPixels) {\n\t\t\tDPPOutputBufferLinesC = 0.5;\n\t\t} else {\n\t\t\tDPPOutputBufferLinesC = 1;\n\t\t}\n\n\t\tDPPOPPBufferingY = (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k])\n\t\t\t\t* (DPPOutputBufferLinesY + mode_lib->vba.OPPOutputBufferLines);\n\t\tMaxDETBufferingTimeY = mode_lib->vba.FullDETBufferingTimeY[k]\n\t\t\t\t+ (mode_lib->vba.LinesInDETY[k]\n\t\t\t\t\t\t- mode_lib->vba.LinesInDETYRoundedDownToSwath[k])\n\t\t\t\t\t\t/ mode_lib->vba.SwathHeightY[k]\n\t\t\t\t\t\t* (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]);\n\n\t\tActiveDRAMClockChangeLatencyMarginY = DPPOPPBufferingY + EffectiveLBLatencyHidingY\n\t\t\t\t+ MaxDETBufferingTimeY - mode_lib->vba.DRAMClockChangeWatermark;\n\n\t\tif (mode_lib->vba.ActiveDPPs > 1) {\n\t\t\tActiveDRAMClockChangeLatencyMarginY =\n\t\t\t\t\tActiveDRAMClockChangeLatencyMarginY\n\t\t\t\t\t\t\t- (1 - 1 / (mode_lib->vba.ActiveDPPs - 1))\n\t\t\t\t\t\t\t\t\t* mode_lib->vba.SwathHeightY[k]\n\t\t\t\t\t\t\t\t\t* (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]);\n\t\t}\n\n\t\tif (mode_lib->vba.BytePerPixelDETC[k] > 0) {\n\t\t\tdouble DPPOPPBufferingC = (mode_lib->vba.HTotal[k]\n\t\t\t\t\t/ mode_lib->vba.PixelClock[k])\n\t\t\t\t\t* (DPPOutputBufferLinesC\n\t\t\t\t\t\t\t+ mode_lib->vba.OPPOutputBufferLines);\n\t\t\tdouble MaxDETBufferingTimeC =\n\t\t\t\t\tmode_lib->vba.FullDETBufferingTimeC[k]\n\t\t\t\t\t\t\t+ (mode_lib->vba.LinesInDETC[k]\n\t\t\t\t\t\t\t\t\t- mode_lib->vba.LinesInDETCRoundedDownToSwath[k])\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.SwathHeightC[k]\n\t\t\t\t\t\t\t\t\t* (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]);\n\t\t\tdouble ActiveDRAMClockChangeLatencyMarginC = DPPOPPBufferingC\n\t\t\t\t\t+ EffectiveLBLatencyHidingC + MaxDETBufferingTimeC\n\t\t\t\t\t- mode_lib->vba.DRAMClockChangeWatermark;\n\n\t\t\tif (mode_lib->vba.ActiveDPPs > 1) {\n\t\t\t\tActiveDRAMClockChangeLatencyMarginC =\n\t\t\t\t\t\tActiveDRAMClockChangeLatencyMarginC\n\t\t\t\t\t\t\t\t- (1\n\t\t\t\t\t\t\t\t\t\t- 1\n\t\t\t\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.ActiveDPPs\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 1))\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.SwathHeightC[k]\n\t\t\t\t\t\t\t\t\t\t* (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]);\n\t\t\t}\n\t\t\tmode_lib->vba.ActiveDRAMClockChangeLatencyMargin[k] = dml_min(\n\t\t\t\t\tActiveDRAMClockChangeLatencyMarginY,\n\t\t\t\t\tActiveDRAMClockChangeLatencyMarginC);\n\t\t} else {\n\t\t\tmode_lib->vba.ActiveDRAMClockChangeLatencyMargin[k] =\n\t\t\t\t\tActiveDRAMClockChangeLatencyMarginY;\n\t\t}\n\n\t\tif (mode_lib->vba.WritebackEnable[k]) {\n\t\t\tdouble WritebackDRAMClockChangeLatencyMargin;\n\n\t\t\tif (mode_lib->vba.WritebackPixelFormat[k] == dm_444_32) {\n\t\t\t\tWritebackDRAMClockChangeLatencyMargin =\n\t\t\t\t\t\t(double) (mode_lib->vba.WritebackInterfaceLumaBufferSize\n\t\t\t\t\t\t\t\t+ mode_lib->vba.WritebackInterfaceChromaBufferSize)\n\t\t\t\t\t\t\t\t/ (mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.WritebackSourceHeight[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k])\n\t\t\t\t\t\t\t\t\t\t* 4)\n\t\t\t\t\t\t\t\t- mode_lib->vba.WritebackDRAMClockChangeWatermark;\n\t\t\t} else if (mode_lib->vba.WritebackPixelFormat[k] == dm_420_10) {\n\t\t\t\tWritebackDRAMClockChangeLatencyMargin =\n\t\t\t\t\t\tdml_min(\n\t\t\t\t\t\t\t\t(double) mode_lib->vba.WritebackInterfaceLumaBufferSize\n\t\t\t\t\t\t\t\t\t\t* 8.0 / 10,\n\t\t\t\t\t\t\t\t2.0\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.WritebackInterfaceChromaBufferSize\n\t\t\t\t\t\t\t\t\t\t* 8 / 10)\n\t\t\t\t\t\t\t\t/ (mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.WritebackSourceHeight[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]))\n\t\t\t\t\t\t\t\t- mode_lib->vba.WritebackDRAMClockChangeWatermark;\n\t\t\t} else {\n\t\t\t\tWritebackDRAMClockChangeLatencyMargin =\n\t\t\t\t\t\tdml_min(\n\t\t\t\t\t\t\t\t(double) mode_lib->vba.WritebackInterfaceLumaBufferSize,\n\t\t\t\t\t\t\t\t2.0\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.WritebackInterfaceChromaBufferSize)\n\t\t\t\t\t\t\t\t/ (mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.WritebackSourceHeight[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]))\n\t\t\t\t\t\t\t\t- mode_lib->vba.WritebackDRAMClockChangeWatermark;\n\t\t\t}\n\t\t\tmode_lib->vba.ActiveDRAMClockChangeLatencyMargin[k] = dml_min(\n\t\t\t\t\tmode_lib->vba.ActiveDRAMClockChangeLatencyMargin[k],\n\t\t\t\t\tWritebackDRAMClockChangeLatencyMargin);\n\t\t}\n\t}\n\n\tmode_lib->vba.MinActiveDRAMClockChangeMargin = 999999;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.ActiveDRAMClockChangeLatencyMargin[k]\n\t\t\t\t< mode_lib->vba.MinActiveDRAMClockChangeMargin) {\n\t\t\tmode_lib->vba.MinActiveDRAMClockChangeMargin =\n\t\t\t\t\tmode_lib->vba.ActiveDRAMClockChangeLatencyMargin[k];\n\t\t}\n\t}\n\n\tmode_lib->vba.MinActiveDRAMClockChangeLatencySupported =\n\t\t\tmode_lib->vba.MinActiveDRAMClockChangeMargin\n\t\t\t\t\t+ mode_lib->vba.DRAMClockChangeLatency;\n\n\tif (mode_lib->vba.DRAMClockChangeSupportsVActive &&\n\t\t\tmode_lib->vba.MinActiveDRAMClockChangeMargin > 60) {\n\t\tmode_lib->vba.DRAMClockChangeWatermark += 25;\n\t\tmode_lib->vba.DRAMClockChangeSupport[0][0] = dm_dram_clock_change_vactive;\n\t} else {\n\t\tif (mode_lib->vba.SynchronizedVBlank || mode_lib->vba.NumberOfActivePlanes == 1) {\n\t\t\tmode_lib->vba.DRAMClockChangeSupport[0][0] = dm_dram_clock_change_vblank;\n\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\t\tif (!mode_lib->vba.AllowDRAMClockChangeDuringVBlank[k]) {\n\t\t\t\t\tmode_lib->vba.DRAMClockChangeSupport[0][0] =\n\t\t\t\t\t\t\tdm_dram_clock_change_unsupported;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tmode_lib->vba.DRAMClockChangeSupport[0][0] = dm_dram_clock_change_unsupported;\n\t\t}\n\t}\n\tfor (k = 0; k <= mode_lib->vba.soc.num_states; k++)\n\t\tfor (j = 0; j < 2; j++)\n\t\t\tmode_lib->vba.DRAMClockChangeSupport[k][j] = mode_lib->vba.DRAMClockChangeSupport[0][0];\n\n\t\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tif (mode_lib->vba.XFCEnabled[k] == true) {\n\t\t\tdouble TWait;\n\n\t\t\tmode_lib->vba.XFCSlaveVUpdateOffset[k] = mode_lib->vba.XFCTSlvVupdateOffset;\n\t\t\tmode_lib->vba.XFCSlaveVupdateWidth[k] = mode_lib->vba.XFCTSlvVupdateWidth;\n\t\t\tmode_lib->vba.XFCSlaveVReadyOffset[k] = mode_lib->vba.XFCTSlvVreadyOffset;\n\t\t\tTWait = CalculateTWait(\n\t\t\t\t\tmode_lib->vba.PrefetchMode[mode_lib->vba.VoltageLevel][mode_lib->vba.maxMpcComb],\n\t\t\t\t\tmode_lib->vba.DRAMClockChangeLatency,\n\t\t\t\t\tmode_lib->vba.UrgentLatencyPixelDataOnly,\n\t\t\t\t\tmode_lib->vba.SREnterPlusExitTime);\n\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipDelay = CalculateRemoteSurfaceFlipDelay(\n\t\t\t\t\tmode_lib,\n\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\tmode_lib->vba.SwathWidthY[k],\n\t\t\t\t\tdml_ceil(mode_lib->vba.BytePerPixelDETY[k], 1),\n\t\t\t\t\tmode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k],\n\t\t\t\t\tmode_lib->vba.XFCTSlvVupdateOffset,\n\t\t\t\t\tmode_lib->vba.XFCTSlvVupdateWidth,\n\t\t\t\t\tmode_lib->vba.XFCTSlvVreadyOffset,\n\t\t\t\t\tmode_lib->vba.XFCXBUFLatencyTolerance,\n\t\t\t\t\tmode_lib->vba.XFCFillBWOverhead,\n\t\t\t\t\tmode_lib->vba.XFCSlvChunkSize,\n\t\t\t\t\tmode_lib->vba.XFCBusTransportTime,\n\t\t\t\t\tmode_lib->vba.TCalc,\n\t\t\t\t\tTWait,\n\t\t\t\t\t&mode_lib->vba.SrcActiveDrainRate,\n\t\t\t\t\t&mode_lib->vba.TInitXFill,\n\t\t\t\t\t&mode_lib->vba.TslvChk);\n\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipLatency[k] =\n\t\t\t\t\tdml_floor(\n\t\t\t\t\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipDelay\n\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]),\n\t\t\t\t\t\t\t1);\n\t\t\tmode_lib->vba.XFCTransferDelay[k] =\n\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\tmode_lib->vba.XFCBusTransportTime\n\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]),\n\t\t\t\t\t\t\t1);\n\t\t\tmode_lib->vba.XFCPrechargeDelay[k] =\n\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t(mode_lib->vba.XFCBusTransportTime\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.TInitXFill\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.TslvChk)\n\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]),\n\t\t\t\t\t\t\t1);\n\t\t\tmode_lib->vba.InitFillLevel = mode_lib->vba.XFCXBUFLatencyTolerance\n\t\t\t\t\t* mode_lib->vba.SrcActiveDrainRate;\n\t\t\tmode_lib->vba.FinalFillMargin =\n\t\t\t\t\t(mode_lib->vba.DestinationLinesToRequestVMInVBlank[k]\n\t\t\t\t\t\t\t+ mode_lib->vba.DestinationLinesToRequestRowInVBlank[k])\n\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t* mode_lib->vba.SrcActiveDrainRate\n\t\t\t\t\t\t\t+ mode_lib->vba.XFCFillConstant;\n\t\t\tmode_lib->vba.FinalFillLevel = mode_lib->vba.XFCRemoteSurfaceFlipDelay\n\t\t\t\t\t* mode_lib->vba.SrcActiveDrainRate\n\t\t\t\t\t+ mode_lib->vba.FinalFillMargin;\n\t\t\tmode_lib->vba.RemainingFillLevel = dml_max(\n\t\t\t\t\t0.0,\n\t\t\t\t\tmode_lib->vba.FinalFillLevel - mode_lib->vba.InitFillLevel);\n\t\t\tmode_lib->vba.TFinalxFill = mode_lib->vba.RemainingFillLevel\n\t\t\t\t\t/ (mode_lib->vba.SrcActiveDrainRate\n\t\t\t\t\t\t\t* mode_lib->vba.XFCFillBWOverhead / 100);\n\t\t\tmode_lib->vba.XFCPrefetchMargin[k] =\n\t\t\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipDelay\n\t\t\t\t\t\t\t+ mode_lib->vba.TFinalxFill\n\t\t\t\t\t\t\t+ (mode_lib->vba.DestinationLinesToRequestVMInVBlank[k]\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.DestinationLinesToRequestRowInVBlank[k])\n\t\t\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k];\n\t\t} else {\n\t\t\tmode_lib->vba.XFCSlaveVUpdateOffset[k] = 0;\n\t\t\tmode_lib->vba.XFCSlaveVupdateWidth[k] = 0;\n\t\t\tmode_lib->vba.XFCSlaveVReadyOffset[k] = 0;\n\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipLatency[k] = 0;\n\t\t\tmode_lib->vba.XFCPrechargeDelay[k] = 0;\n\t\t\tmode_lib->vba.XFCTransferDelay[k] = 0;\n\t\t\tmode_lib->vba.XFCPrefetchMargin[k] = 0;\n\t\t}\n\t}\n\t{\n\t\tunsigned int VStartupMargin = 0;\n\t\tbool FirstMainPlane = true;\n\n\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\t\tunsigned int Margin = (mode_lib->vba.MaxVStartupLines[k] - mode_lib->vba.VStartup[k])\n\t\t\t\t\t\t* mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k];\n\n\t\t\t\tif (FirstMainPlane) {\n\t\t\t\t\tVStartupMargin = Margin;\n\t\t\t\t\tFirstMainPlane = false;\n\t\t\t\t} else\n\t\t\t\t\tVStartupMargin = dml_min(VStartupMargin, Margin);\n\t\t}\n\n\t\tif (mode_lib->vba.UseMaximumVStartup) {\n\t\t\tif (mode_lib->vba.VTotal_Max[k] == mode_lib->vba.VTotal[k]) {\n\t\t\t\t\n\t\t\t\tmode_lib->vba.VStartup[k] = mode_lib->vba.MaxVStartupLines[mode_lib->vba.BlendingAndTiming[k]];\n\t\t\t}\n\t\t}\n\t}\n}\n}\n\nstatic void dml20_DisplayPipeConfiguration(struct display_mode_lib *mode_lib)\n{\n\tdouble BytePerPixDETY;\n\tdouble BytePerPixDETC;\n\tdouble Read256BytesBlockHeightY;\n\tdouble Read256BytesBlockHeightC;\n\tdouble Read256BytesBlockWidthY;\n\tdouble Read256BytesBlockWidthC;\n\tdouble MaximumSwathHeightY;\n\tdouble MaximumSwathHeightC;\n\tdouble MinimumSwathHeightY;\n\tdouble MinimumSwathHeightC;\n\tdouble SwathWidth;\n\tdouble SwathWidthGranularityY;\n\tdouble SwathWidthGranularityC;\n\tdouble RoundedUpMaxSwathSizeBytesY;\n\tdouble RoundedUpMaxSwathSizeBytesC;\n\tunsigned int j, k;\n\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\tbool MainPlaneDoesODMCombine = false;\n\n\t\tif (mode_lib->vba.SourcePixelFormat[k] == dm_444_64) {\n\t\t\tBytePerPixDETY = 8;\n\t\t\tBytePerPixDETC = 0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_32) {\n\t\t\tBytePerPixDETY = 4;\n\t\t\tBytePerPixDETC = 0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_16) {\n\t\t\tBytePerPixDETY = 2;\n\t\t\tBytePerPixDETC = 0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_8) {\n\t\t\tBytePerPixDETY = 1;\n\t\t\tBytePerPixDETC = 0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_420_8) {\n\t\t\tBytePerPixDETY = 1;\n\t\t\tBytePerPixDETC = 2;\n\t\t} else {\n\t\t\tBytePerPixDETY = 4.0 / 3.0;\n\t\t\tBytePerPixDETC = 8.0 / 3.0;\n\t\t}\n\n\t\tif ((mode_lib->vba.SourcePixelFormat[k] == dm_444_64\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_444_32\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_444_16\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_444_8)) {\n\t\t\tif (mode_lib->vba.SurfaceTiling[k] == dm_sw_linear) {\n\t\t\t\tRead256BytesBlockHeightY = 1;\n\t\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_64) {\n\t\t\t\tRead256BytesBlockHeightY = 4;\n\t\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_32\n\t\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_444_16) {\n\t\t\t\tRead256BytesBlockHeightY = 8;\n\t\t\t} else {\n\t\t\t\tRead256BytesBlockHeightY = 16;\n\t\t\t}\n\t\t\tRead256BytesBlockWidthY = 256 / dml_ceil(BytePerPixDETY, 1)\n\t\t\t\t\t/ Read256BytesBlockHeightY;\n\t\t\tRead256BytesBlockHeightC = 0;\n\t\t\tRead256BytesBlockWidthC = 0;\n\t\t} else {\n\t\t\tif (mode_lib->vba.SurfaceTiling[k] == dm_sw_linear) {\n\t\t\t\tRead256BytesBlockHeightY = 1;\n\t\t\t\tRead256BytesBlockHeightC = 1;\n\t\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_420_8) {\n\t\t\t\tRead256BytesBlockHeightY = 16;\n\t\t\t\tRead256BytesBlockHeightC = 8;\n\t\t\t} else {\n\t\t\t\tRead256BytesBlockHeightY = 8;\n\t\t\t\tRead256BytesBlockHeightC = 8;\n\t\t\t}\n\t\t\tRead256BytesBlockWidthY = 256 / dml_ceil(BytePerPixDETY, 1)\n\t\t\t\t\t/ Read256BytesBlockHeightY;\n\t\t\tRead256BytesBlockWidthC = 256 / dml_ceil(BytePerPixDETC, 2)\n\t\t\t\t\t/ Read256BytesBlockHeightC;\n\t\t}\n\n\t\tif (mode_lib->vba.SourceScan[k] == dm_horz) {\n\t\t\tMaximumSwathHeightY = Read256BytesBlockHeightY;\n\t\t\tMaximumSwathHeightC = Read256BytesBlockHeightC;\n\t\t} else {\n\t\t\tMaximumSwathHeightY = Read256BytesBlockWidthY;\n\t\t\tMaximumSwathHeightC = Read256BytesBlockWidthC;\n\t\t}\n\n\t\tif ((mode_lib->vba.SourcePixelFormat[k] == dm_444_64\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_444_32\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_444_16\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_444_8)) {\n\t\t\tif (mode_lib->vba.SurfaceTiling[k] == dm_sw_linear\n\t\t\t\t\t|| (mode_lib->vba.SourcePixelFormat[k] == dm_444_64\n\t\t\t\t\t\t\t&& (mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t== dm_sw_4kb_s\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_4kb_s_x\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_64kb_s\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_64kb_s_t\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_64kb_s_x\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_var_s\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_var_s_x)\n\t\t\t\t\t\t\t&& mode_lib->vba.SourceScan[k] == dm_horz)) {\n\t\t\t\tMinimumSwathHeightY = MaximumSwathHeightY;\n\t\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_8\n\t\t\t\t\t&& mode_lib->vba.SourceScan[k] != dm_horz) {\n\t\t\t\tMinimumSwathHeightY = MaximumSwathHeightY;\n\t\t\t} else {\n\t\t\t\tMinimumSwathHeightY = MaximumSwathHeightY / 2.0;\n\t\t\t}\n\t\t\tMinimumSwathHeightC = MaximumSwathHeightC;\n\t\t} else {\n\t\t\tif (mode_lib->vba.SurfaceTiling[k] == dm_sw_linear) {\n\t\t\t\tMinimumSwathHeightY = MaximumSwathHeightY;\n\t\t\t\tMinimumSwathHeightC = MaximumSwathHeightC;\n\t\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_420_8\n\t\t\t\t\t&& mode_lib->vba.SourceScan[k] == dm_horz) {\n\t\t\t\tMinimumSwathHeightY = MaximumSwathHeightY / 2.0;\n\t\t\t\tMinimumSwathHeightC = MaximumSwathHeightC;\n\t\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_420_10\n\t\t\t\t\t&& mode_lib->vba.SourceScan[k] == dm_horz) {\n\t\t\t\tMinimumSwathHeightC = MaximumSwathHeightC / 2.0;\n\t\t\t\tMinimumSwathHeightY = MaximumSwathHeightY;\n\t\t\t} else {\n\t\t\t\tMinimumSwathHeightY = MaximumSwathHeightY;\n\t\t\t\tMinimumSwathHeightC = MaximumSwathHeightC;\n\t\t\t}\n\t\t}\n\n\t\tif (mode_lib->vba.SourceScan[k] == dm_horz) {\n\t\t\tSwathWidth = mode_lib->vba.ViewportWidth[k];\n\t\t} else {\n\t\t\tSwathWidth = mode_lib->vba.ViewportHeight[k];\n\t\t}\n\n\t\tif (mode_lib->vba.ODMCombineEnabled[k] == dm_odm_combine_mode_2to1) {\n\t\t\tMainPlaneDoesODMCombine = true;\n\t\t}\n\t\tfor (j = 0; j < mode_lib->vba.NumberOfActivePlanes; ++j) {\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == j\n\t\t\t\t\t&& mode_lib->vba.ODMCombineEnabled[k] == dm_odm_combine_mode_2to1) {\n\t\t\t\tMainPlaneDoesODMCombine = true;\n\t\t\t}\n\t\t}\n\n\t\tif (MainPlaneDoesODMCombine == true) {\n\t\t\tSwathWidth = dml_min(\n\t\t\t\t\tSwathWidth,\n\t\t\t\t\tmode_lib->vba.HActive[k] / 2.0 * mode_lib->vba.HRatio[k]);\n\t\t} else {\n\t\t\tif (mode_lib->vba.DPPPerPlane[k] == 0)\n\t\t\t\tSwathWidth = 0;\n\t\t\telse\n\t\t\t\tSwathWidth = SwathWidth / mode_lib->vba.DPPPerPlane[k];\n\t\t}\n\n\t\tSwathWidthGranularityY = 256 / dml_ceil(BytePerPixDETY, 1) / MaximumSwathHeightY;\n\t\tRoundedUpMaxSwathSizeBytesY = (dml_ceil(\n\t\t\t\t(double) (SwathWidth - 1),\n\t\t\t\tSwathWidthGranularityY) + SwathWidthGranularityY) * BytePerPixDETY\n\t\t\t\t* MaximumSwathHeightY;\n\t\tif (mode_lib->vba.SourcePixelFormat[k] == dm_420_10) {\n\t\t\tRoundedUpMaxSwathSizeBytesY = dml_ceil(RoundedUpMaxSwathSizeBytesY, 256)\n\t\t\t\t\t+ 256;\n\t\t}\n\t\tif (MaximumSwathHeightC > 0) {\n\t\t\tSwathWidthGranularityC = 256.0 / dml_ceil(BytePerPixDETC, 2)\n\t\t\t\t\t/ MaximumSwathHeightC;\n\t\t\tRoundedUpMaxSwathSizeBytesC = (dml_ceil(\n\t\t\t\t\t(double) (SwathWidth / 2.0 - 1),\n\t\t\t\t\tSwathWidthGranularityC) + SwathWidthGranularityC)\n\t\t\t\t\t* BytePerPixDETC * MaximumSwathHeightC;\n\t\t\tif (mode_lib->vba.SourcePixelFormat[k] == dm_420_10) {\n\t\t\t\tRoundedUpMaxSwathSizeBytesC = dml_ceil(\n\t\t\t\t\t\tRoundedUpMaxSwathSizeBytesC,\n\t\t\t\t\t\t256) + 256;\n\t\t\t}\n\t\t} else\n\t\t\tRoundedUpMaxSwathSizeBytesC = 0.0;\n\n\t\tif (RoundedUpMaxSwathSizeBytesY + RoundedUpMaxSwathSizeBytesC\n\t\t\t\t<= mode_lib->vba.DETBufferSizeInKByte[0] * 1024.0 / 2.0) {\n\t\t\tmode_lib->vba.SwathHeightY[k] = MaximumSwathHeightY;\n\t\t\tmode_lib->vba.SwathHeightC[k] = MaximumSwathHeightC;\n\t\t} else {\n\t\t\tmode_lib->vba.SwathHeightY[k] = MinimumSwathHeightY;\n\t\t\tmode_lib->vba.SwathHeightC[k] = MinimumSwathHeightC;\n\t\t}\n\n\t\tif (mode_lib->vba.SwathHeightC[k] == 0) {\n\t\t\tmode_lib->vba.DETBufferSizeY[k] = mode_lib->vba.DETBufferSizeInKByte[0] * 1024;\n\t\t\tmode_lib->vba.DETBufferSizeC[k] = 0;\n\t\t} else if (mode_lib->vba.SwathHeightY[k] <= mode_lib->vba.SwathHeightC[k]) {\n\t\t\tmode_lib->vba.DETBufferSizeY[k] = mode_lib->vba.DETBufferSizeInKByte[0]\n\t\t\t\t\t* 1024.0 / 2;\n\t\t\tmode_lib->vba.DETBufferSizeC[k] = mode_lib->vba.DETBufferSizeInKByte[0]\n\t\t\t\t\t* 1024.0 / 2;\n\t\t} else {\n\t\t\tmode_lib->vba.DETBufferSizeY[k] = mode_lib->vba.DETBufferSizeInKByte[0]\n\t\t\t\t\t* 1024.0 * 2 / 3;\n\t\t\tmode_lib->vba.DETBufferSizeC[k] = mode_lib->vba.DETBufferSizeInKByte[0]\n\t\t\t\t\t* 1024.0 / 3;\n\t\t}\n\t}\n}\n\nstatic double CalculateTWait(\n\t\tunsigned int PrefetchMode,\n\t\tdouble DRAMClockChangeLatency,\n\t\tdouble UrgentLatencyPixelDataOnly,\n\t\tdouble SREnterPlusExitTime)\n{\n\tif (PrefetchMode == 0) {\n\t\treturn dml_max(\n\t\t\t\tDRAMClockChangeLatency + UrgentLatencyPixelDataOnly,\n\t\t\t\tdml_max(SREnterPlusExitTime, UrgentLatencyPixelDataOnly));\n\t} else if (PrefetchMode == 1) {\n\t\treturn dml_max(SREnterPlusExitTime, UrgentLatencyPixelDataOnly);\n\t} else {\n\t\treturn UrgentLatencyPixelDataOnly;\n\t}\n}\n\nstatic double CalculateRemoteSurfaceFlipDelay(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble VRatio,\n\t\tdouble SwathWidth,\n\t\tdouble Bpp,\n\t\tdouble LineTime,\n\t\tdouble XFCTSlvVupdateOffset,\n\t\tdouble XFCTSlvVupdateWidth,\n\t\tdouble XFCTSlvVreadyOffset,\n\t\tdouble XFCXBUFLatencyTolerance,\n\t\tdouble XFCFillBWOverhead,\n\t\tdouble XFCSlvChunkSize,\n\t\tdouble XFCBusTransportTime,\n\t\tdouble TCalc,\n\t\tdouble TWait,\n\t\tdouble *SrcActiveDrainRate,\n\t\tdouble *TInitXFill,\n\t\tdouble *TslvChk)\n{\n\tdouble TSlvSetup, AvgfillRate, result;\n\n\t*SrcActiveDrainRate = VRatio * SwathWidth * Bpp / LineTime;\n\tTSlvSetup = XFCTSlvVupdateOffset + XFCTSlvVupdateWidth + XFCTSlvVreadyOffset;\n\t*TInitXFill = XFCXBUFLatencyTolerance / (1 + XFCFillBWOverhead / 100);\n\tAvgfillRate = *SrcActiveDrainRate * (1 + XFCFillBWOverhead / 100);\n\t*TslvChk = XFCSlvChunkSize / AvgfillRate;\n\tdml_print(\n\t\t\t\"DML::CalculateRemoteSurfaceFlipDelay: SrcActiveDrainRate: %f\\n\",\n\t\t\t*SrcActiveDrainRate);\n\tdml_print(\"DML::CalculateRemoteSurfaceFlipDelay: TSlvSetup: %f\\n\", TSlvSetup);\n\tdml_print(\"DML::CalculateRemoteSurfaceFlipDelay: TInitXFill: %f\\n\", *TInitXFill);\n\tdml_print(\"DML::CalculateRemoteSurfaceFlipDelay: AvgfillRate: %f\\n\", AvgfillRate);\n\tdml_print(\"DML::CalculateRemoteSurfaceFlipDelay: TslvChk: %f\\n\", *TslvChk);\n\tresult = 2 * XFCBusTransportTime + TSlvSetup + TCalc + TWait + *TslvChk + *TInitXFill; \n\tdml_print(\"DML::CalculateRemoteSurfaceFlipDelay: RemoteSurfaceFlipDelay: %f\\n\", result);\n\treturn result;\n}\n\nstatic double CalculateWriteBackDelay(\n\t\tenum source_format_class WritebackPixelFormat,\n\t\tdouble WritebackHRatio,\n\t\tdouble WritebackVRatio,\n\t\tunsigned int WritebackLumaHTaps,\n\t\tunsigned int WritebackLumaVTaps,\n\t\tunsigned int WritebackChromaHTaps,\n\t\tunsigned int WritebackChromaVTaps,\n\t\tunsigned int WritebackDestinationWidth)\n{\n\tdouble CalculateWriteBackDelay =\n\t\t\tdml_max(\n\t\t\t\t\tdml_ceil(WritebackLumaHTaps / 4.0, 1) / WritebackHRatio,\n\t\t\t\t\tWritebackLumaVTaps * dml_ceil(1.0 / WritebackVRatio, 1)\n\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\tWritebackDestinationWidth\n\t\t\t\t\t\t\t\t\t\t\t/ 4.0,\n\t\t\t\t\t\t\t\t\t1)\n\t\t\t\t\t\t\t+ dml_ceil(1.0 / WritebackVRatio, 1)\n\t\t\t\t\t\t\t\t\t* (dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\tWritebackLumaVTaps\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 4.0,\n\t\t\t\t\t\t\t\t\t\t\t1) + 4));\n\n\tif (WritebackPixelFormat != dm_444_32) {\n\t\tCalculateWriteBackDelay =\n\t\t\t\tdml_max(\n\t\t\t\t\t\tCalculateWriteBackDelay,\n\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\t\tWritebackChromaHTaps\n\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0,\n\t\t\t\t\t\t\t\t\t\t1)\n\t\t\t\t\t\t\t\t\t\t/ (2\n\t\t\t\t\t\t\t\t\t\t\t\t* WritebackHRatio),\n\t\t\t\t\t\t\t\tWritebackChromaVTaps\n\t\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t1\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ (2\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* WritebackVRatio),\n\t\t\t\t\t\t\t\t\t\t\t\t1)\n\t\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\tWritebackDestinationWidth\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0,\n\t\t\t\t\t\t\t\t\t\t\t\t1)\n\t\t\t\t\t\t\t\t\t\t+ dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t1\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ (2\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* WritebackVRatio),\n\t\t\t\t\t\t\t\t\t\t\t\t1)\n\t\t\t\t\t\t\t\t\t\t\t\t* (dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWritebackChromaVTaps\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 4.0,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t+ 4)));\n\t}\n\treturn CalculateWriteBackDelay;\n}\n\nstatic void CalculateActiveRowBandwidth(\n\t\tbool GPUVMEnable,\n\t\tenum source_format_class SourcePixelFormat,\n\t\tdouble VRatio,\n\t\tbool DCCEnable,\n\t\tdouble LineTime,\n\t\tunsigned int MetaRowByteLuma,\n\t\tunsigned int MetaRowByteChroma,\n\t\tunsigned int meta_row_height_luma,\n\t\tunsigned int meta_row_height_chroma,\n\t\tunsigned int PixelPTEBytesPerRowLuma,\n\t\tunsigned int PixelPTEBytesPerRowChroma,\n\t\tunsigned int dpte_row_height_luma,\n\t\tunsigned int dpte_row_height_chroma,\n\t\tdouble *meta_row_bw,\n\t\tdouble *dpte_row_bw,\n\t\tdouble *qual_row_bw)\n{\n\tif (DCCEnable != true) {\n\t\t*meta_row_bw = 0;\n\t} else if (SourcePixelFormat == dm_420_8 || SourcePixelFormat == dm_420_10) {\n\t\t*meta_row_bw = VRatio * MetaRowByteLuma / (meta_row_height_luma * LineTime)\n\t\t\t\t+ VRatio / 2 * MetaRowByteChroma\n\t\t\t\t\t\t/ (meta_row_height_chroma * LineTime);\n\t} else {\n\t\t*meta_row_bw = VRatio * MetaRowByteLuma / (meta_row_height_luma * LineTime);\n\t}\n\n\tif (GPUVMEnable != true) {\n\t\t*dpte_row_bw = 0;\n\t} else if (SourcePixelFormat == dm_420_8 || SourcePixelFormat == dm_420_10) {\n\t\t*dpte_row_bw = VRatio * PixelPTEBytesPerRowLuma / (dpte_row_height_luma * LineTime)\n\t\t\t\t+ VRatio / 2 * PixelPTEBytesPerRowChroma\n\t\t\t\t\t\t/ (dpte_row_height_chroma * LineTime);\n\t} else {\n\t\t*dpte_row_bw = VRatio * PixelPTEBytesPerRowLuma / (dpte_row_height_luma * LineTime);\n\t}\n\n\tif ((SourcePixelFormat == dm_420_8 || SourcePixelFormat == dm_420_10)) {\n\t\t*qual_row_bw = *meta_row_bw + *dpte_row_bw;\n\t} else {\n\t\t*qual_row_bw = 0;\n\t}\n}\n\nstatic void CalculateFlipSchedule(\n\t\tstruct display_mode_lib *mode_lib,\n\t\tdouble UrgentExtraLatency,\n\t\tdouble UrgentLatencyPixelDataOnly,\n\t\tunsigned int GPUVMMaxPageTableLevels,\n\t\tbool GPUVMEnable,\n\t\tdouble BandwidthAvailableForImmediateFlip,\n\t\tunsigned int TotImmediateFlipBytes,\n\t\tenum source_format_class SourcePixelFormat,\n\t\tunsigned int ImmediateFlipBytes,\n\t\tdouble LineTime,\n\t\tdouble VRatio,\n\t\tdouble Tno_bw,\n\t\tdouble PDEAndMetaPTEBytesFrame,\n\t\tunsigned int MetaRowByte,\n\t\tunsigned int PixelPTEBytesPerRow,\n\t\tbool DCCEnable,\n\t\tunsigned int dpte_row_height,\n\t\tunsigned int meta_row_height,\n\t\tdouble qual_row_bw,\n\t\tdouble *DestinationLinesToRequestVMInImmediateFlip,\n\t\tdouble *DestinationLinesToRequestRowInImmediateFlip,\n\t\tdouble *final_flip_bw,\n\t\tbool *ImmediateFlipSupportedForPipe)\n{\n\tdouble min_row_time = 0.0;\n\n\tif (SourcePixelFormat == dm_420_8 || SourcePixelFormat == dm_420_10) {\n\t\t*DestinationLinesToRequestVMInImmediateFlip = 0.0;\n\t\t*DestinationLinesToRequestRowInImmediateFlip = 0.0;\n\t\t*final_flip_bw = qual_row_bw;\n\t\t*ImmediateFlipSupportedForPipe = true;\n\t} else {\n\t\tdouble TimeForFetchingMetaPTEImmediateFlip;\n\t\tdouble TimeForFetchingRowInVBlankImmediateFlip;\n\n\t\tif (GPUVMEnable == true) {\n\t\t\tmode_lib->vba.ImmediateFlipBW[0] = BandwidthAvailableForImmediateFlip\n\t\t\t\t\t* ImmediateFlipBytes / TotImmediateFlipBytes;\n\t\t\tTimeForFetchingMetaPTEImmediateFlip =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tTno_bw\n\t\t\t\t\t\t\t\t\t+ PDEAndMetaPTEBytesFrame\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.ImmediateFlipBW[0],\n\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\tUrgentExtraLatency\n\t\t\t\t\t\t\t\t\t\t\t+ UrgentLatencyPixelDataOnly\n\t\t\t\t\t\t\t\t\t\t\t\t\t* (GPUVMMaxPageTableLevels\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 1),\n\t\t\t\t\t\t\t\t\tLineTime / 4.0));\n\t\t} else {\n\t\t\tTimeForFetchingMetaPTEImmediateFlip = 0;\n\t\t}\n\n\t\t*DestinationLinesToRequestVMInImmediateFlip = dml_floor(\n\t\t\t\t4.0 * (TimeForFetchingMetaPTEImmediateFlip / LineTime + 0.125),\n\t\t\t\t1) / 4.0;\n\n\t\tif ((GPUVMEnable || DCCEnable)) {\n\t\t\tmode_lib->vba.ImmediateFlipBW[0] = BandwidthAvailableForImmediateFlip\n\t\t\t\t\t* ImmediateFlipBytes / TotImmediateFlipBytes;\n\t\t\tTimeForFetchingRowInVBlankImmediateFlip = dml_max(\n\t\t\t\t\t(MetaRowByte + PixelPTEBytesPerRow)\n\t\t\t\t\t\t\t/ mode_lib->vba.ImmediateFlipBW[0],\n\t\t\t\t\tdml_max(UrgentLatencyPixelDataOnly, LineTime / 4.0));\n\t\t} else {\n\t\t\tTimeForFetchingRowInVBlankImmediateFlip = 0;\n\t\t}\n\n\t\t*DestinationLinesToRequestRowInImmediateFlip = dml_floor(\n\t\t\t\t4.0 * (TimeForFetchingRowInVBlankImmediateFlip / LineTime + 0.125),\n\t\t\t\t1) / 4.0;\n\n\t\tif (GPUVMEnable == true) {\n\t\t\t*final_flip_bw =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tPDEAndMetaPTEBytesFrame\n\t\t\t\t\t\t\t\t\t/ (*DestinationLinesToRequestVMInImmediateFlip\n\t\t\t\t\t\t\t\t\t\t\t* LineTime),\n\t\t\t\t\t\t\t(MetaRowByte + PixelPTEBytesPerRow)\n\t\t\t\t\t\t\t\t\t/ (TimeForFetchingRowInVBlankImmediateFlip\n\t\t\t\t\t\t\t\t\t\t\t* LineTime));\n\t\t} else if (MetaRowByte + PixelPTEBytesPerRow > 0) {\n\t\t\t*final_flip_bw = (MetaRowByte + PixelPTEBytesPerRow)\n\t\t\t\t\t/ (TimeForFetchingRowInVBlankImmediateFlip * LineTime);\n\t\t} else {\n\t\t\t*final_flip_bw = 0;\n\t\t}\n\n\t\tif (GPUVMEnable && !DCCEnable)\n\t\t\tmin_row_time = dpte_row_height * LineTime / VRatio;\n\t\telse if (!GPUVMEnable && DCCEnable)\n\t\t\tmin_row_time = meta_row_height * LineTime / VRatio;\n\t\telse\n\t\t\tmin_row_time = dml_min(dpte_row_height, meta_row_height) * LineTime\n\t\t\t\t\t/ VRatio;\n\n\t\tif (*DestinationLinesToRequestVMInImmediateFlip >= 8\n\t\t\t\t|| *DestinationLinesToRequestRowInImmediateFlip >= 16\n\t\t\t\t|| TimeForFetchingMetaPTEImmediateFlip\n\t\t\t\t\t\t+ 2 * TimeForFetchingRowInVBlankImmediateFlip\n\t\t\t\t\t\t> min_row_time)\n\t\t\t*ImmediateFlipSupportedForPipe = false;\n\t\telse\n\t\t\t*ImmediateFlipSupportedForPipe = true;\n\t}\n}\n\nstatic unsigned int TruncToValidBPP(\n\t\tdouble DecimalBPP,\n\t\tbool DSCEnabled,\n\t\tenum output_encoder_class Output,\n\t\tenum output_format_class Format,\n\t\tunsigned int DSCInputBitPerComponent)\n{\n\tif (Output == dm_hdmi) {\n\t\tif (Format == dm_420) {\n\t\t\tif (DecimalBPP >= 18)\n\t\t\t\treturn 18;\n\t\t\telse if (DecimalBPP >= 15)\n\t\t\t\treturn 15;\n\t\t\telse if (DecimalBPP >= 12)\n\t\t\t\treturn 12;\n\t\t\telse\n\t\t\t\treturn BPP_INVALID;\n\t\t} else if (Format == dm_444) {\n\t\t\tif (DecimalBPP >= 36)\n\t\t\t\treturn 36;\n\t\t\telse if (DecimalBPP >= 30)\n\t\t\t\treturn 30;\n\t\t\telse if (DecimalBPP >= 24)\n\t\t\t\treturn 24;\n\t\t\telse if (DecimalBPP >= 18)\n\t\t\t\treturn 18;\n\t\t\telse\n\t\t\t\treturn BPP_INVALID;\n\t\t} else {\n\t\t\tif (DecimalBPP / 1.5 >= 24)\n\t\t\t\treturn 24;\n\t\t\telse if (DecimalBPP / 1.5 >= 20)\n\t\t\t\treturn 20;\n\t\t\telse if (DecimalBPP / 1.5 >= 16)\n\t\t\t\treturn 16;\n\t\t\telse\n\t\t\t\treturn BPP_INVALID;\n\t\t}\n\t} else {\n\t\tif (DSCEnabled) {\n\t\t\tif (Format == dm_420) {\n\t\t\t\tif (DecimalBPP < 6)\n\t\t\t\t\treturn BPP_INVALID;\n\t\t\t\telse if (DecimalBPP >= 1.5 * DSCInputBitPerComponent - 1 / 16)\n\t\t\t\t\treturn 1.5 * DSCInputBitPerComponent - 1 / 16;\n\t\t\t\telse\n\t\t\t\t\treturn dml_floor(16 * DecimalBPP, 1) / 16;\n\t\t\t} else if (Format == dm_n422) {\n\t\t\t\tif (DecimalBPP < 7)\n\t\t\t\t\treturn BPP_INVALID;\n\t\t\t\telse if (DecimalBPP >= 2 * DSCInputBitPerComponent - 1 / 16)\n\t\t\t\t\treturn 2 * DSCInputBitPerComponent - 1 / 16;\n\t\t\t\telse\n\t\t\t\t\treturn dml_floor(16 * DecimalBPP, 1) / 16;\n\t\t\t} else {\n\t\t\t\tif (DecimalBPP < 8)\n\t\t\t\t\treturn BPP_INVALID;\n\t\t\t\telse if (DecimalBPP >= 3 * DSCInputBitPerComponent - 1 / 16)\n\t\t\t\t\treturn 3 * DSCInputBitPerComponent - 1 / 16;\n\t\t\t\telse\n\t\t\t\t\treturn dml_floor(16 * DecimalBPP, 1) / 16;\n\t\t\t}\n\t\t} else if (Format == dm_420) {\n\t\t\tif (DecimalBPP >= 18)\n\t\t\t\treturn 18;\n\t\t\telse if (DecimalBPP >= 15)\n\t\t\t\treturn 15;\n\t\t\telse if (DecimalBPP >= 12)\n\t\t\t\treturn 12;\n\t\t\telse\n\t\t\t\treturn BPP_INVALID;\n\t\t} else if (Format == dm_s422 || Format == dm_n422) {\n\t\t\tif (DecimalBPP >= 24)\n\t\t\t\treturn 24;\n\t\t\telse if (DecimalBPP >= 20)\n\t\t\t\treturn 20;\n\t\t\telse if (DecimalBPP >= 16)\n\t\t\t\treturn 16;\n\t\t\telse\n\t\t\t\treturn BPP_INVALID;\n\t\t} else {\n\t\t\tif (DecimalBPP >= 36)\n\t\t\t\treturn 36;\n\t\t\telse if (DecimalBPP >= 30)\n\t\t\t\treturn 30;\n\t\t\telse if (DecimalBPP >= 24)\n\t\t\t\treturn 24;\n\t\t\telse if (DecimalBPP >= 18)\n\t\t\t\treturn 18;\n\t\t\telse\n\t\t\t\treturn BPP_INVALID;\n\t\t}\n\t}\n}\n\nvoid dml20_ModeSupportAndSystemConfigurationFull(struct display_mode_lib *mode_lib)\n{\n\tstruct vba_vars_st *locals = &mode_lib->vba;\n\n\tint i;\n\tunsigned int j, k, m;\n\n\t \n\n\t \n\n\tmode_lib->vba.ScaleRatioAndTapsSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.ScalerEnabled[k] == false\n\t\t\t\t&& ((mode_lib->vba.SourcePixelFormat[k] != dm_444_64\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_32\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_8)\n\t\t\t\t\t\t|| mode_lib->vba.HRatio[k] != 1.0\n\t\t\t\t\t\t|| mode_lib->vba.htaps[k] != 1.0\n\t\t\t\t\t\t|| mode_lib->vba.VRatio[k] != 1.0\n\t\t\t\t\t\t|| mode_lib->vba.vtaps[k] != 1.0)) {\n\t\t\tmode_lib->vba.ScaleRatioAndTapsSupport = false;\n\t\t} else if (mode_lib->vba.vtaps[k] < 1.0 || mode_lib->vba.vtaps[k] > 8.0\n\t\t\t\t|| mode_lib->vba.htaps[k] < 1.0 || mode_lib->vba.htaps[k] > 8.0\n\t\t\t\t|| (mode_lib->vba.htaps[k] > 1.0\n\t\t\t\t\t\t&& (mode_lib->vba.htaps[k] % 2) == 1)\n\t\t\t\t|| mode_lib->vba.HRatio[k] > mode_lib->vba.MaxHSCLRatio\n\t\t\t\t|| mode_lib->vba.VRatio[k] > mode_lib->vba.MaxVSCLRatio\n\t\t\t\t|| mode_lib->vba.HRatio[k] > mode_lib->vba.htaps[k]\n\t\t\t\t|| mode_lib->vba.VRatio[k] > mode_lib->vba.vtaps[k]\n\t\t\t\t|| (mode_lib->vba.SourcePixelFormat[k] != dm_444_64\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_32\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_8\n\t\t\t\t\t\t&& (mode_lib->vba.HRatio[k] / 2.0\n\t\t\t\t\t\t\t\t> mode_lib->vba.HTAPsChroma[k]\n\t\t\t\t\t\t\t\t|| mode_lib->vba.VRatio[k] / 2.0\n\t\t\t\t\t\t\t\t\t\t> mode_lib->vba.VTAPsChroma[k]))) {\n\t\t\tmode_lib->vba.ScaleRatioAndTapsSupport = false;\n\t\t}\n\t}\n\t \n\n\tmode_lib->vba.SourceFormatPixelAndScanSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif ((mode_lib->vba.SurfaceTiling[k] == dm_sw_linear\n\t\t\t\t&& mode_lib->vba.SourceScan[k] != dm_horz)\n\t\t\t\t|| ((mode_lib->vba.SurfaceTiling[k] == dm_sw_4kb_d\n\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k] == dm_sw_4kb_d_x\n\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k] == dm_sw_64kb_d\n\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k] == dm_sw_64kb_d_t\n\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k] == dm_sw_64kb_d_x\n\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k] == dm_sw_var_d\n\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k] == dm_sw_var_d_x)\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_64)\n\t\t\t\t|| (mode_lib->vba.SurfaceTiling[k] == dm_sw_64kb_r_x\n\t\t\t\t\t\t&& (mode_lib->vba.SourcePixelFormat[k] == dm_mono_8\n\t\t\t\t\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k]\n\t\t\t\t\t\t\t\t\t\t== dm_420_8\n\t\t\t\t\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k]\n\t\t\t\t\t\t\t\t\t\t== dm_420_10))\n\t\t\t\t|| (((mode_lib->vba.SurfaceTiling[k] == dm_sw_gfx7_2d_thin_gl\n\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t== dm_sw_gfx7_2d_thin_l_vp)\n\t\t\t\t\t\t&& !((mode_lib->vba.SourcePixelFormat[k]\n\t\t\t\t\t\t\t\t== dm_444_64\n\t\t\t\t\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k]\n\t\t\t\t\t\t\t\t\t\t== dm_444_32)\n\t\t\t\t\t\t\t\t&& mode_lib->vba.SourceScan[k]\n\t\t\t\t\t\t\t\t\t\t== dm_horz\n\t\t\t\t\t\t\t\t&& mode_lib->vba.SupportGFX7CompatibleTilingIn32bppAnd64bpp\n\t\t\t\t\t\t\t\t\t\t== true\n\t\t\t\t\t\t\t\t&& mode_lib->vba.DCCEnable[k]\n\t\t\t\t\t\t\t\t\t\t== false))\n\t\t\t\t\t\t|| (mode_lib->vba.DCCEnable[k] == true\n\t\t\t\t\t\t\t\t&& (mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t== dm_sw_linear\n\t\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k]\n\t\t\t\t\t\t\t\t\t\t\t\t== dm_420_8\n\t\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k]\n\t\t\t\t\t\t\t\t\t\t\t\t== dm_420_10)))) {\n\t\t\tmode_lib->vba.SourceFormatPixelAndScanSupport = false;\n\t\t}\n\t}\n\t \n\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.SourcePixelFormat[k] == dm_444_64) {\n\t\t\tlocals->BytePerPixelInDETY[k] = 8.0;\n\t\t\tlocals->BytePerPixelInDETC[k] = 0.0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_32) {\n\t\t\tlocals->BytePerPixelInDETY[k] = 4.0;\n\t\t\tlocals->BytePerPixelInDETC[k] = 0.0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_444_16\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_mono_16) {\n\t\t\tlocals->BytePerPixelInDETY[k] = 2.0;\n\t\t\tlocals->BytePerPixelInDETC[k] = 0.0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_mono_8) {\n\t\t\tlocals->BytePerPixelInDETY[k] = 1.0;\n\t\t\tlocals->BytePerPixelInDETC[k] = 0.0;\n\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_420_8) {\n\t\t\tlocals->BytePerPixelInDETY[k] = 1.0;\n\t\t\tlocals->BytePerPixelInDETC[k] = 2.0;\n\t\t} else {\n\t\t\tlocals->BytePerPixelInDETY[k] = 4.0 / 3;\n\t\t\tlocals->BytePerPixelInDETC[k] = 8.0 / 3;\n\t\t}\n\t\tif (mode_lib->vba.SourceScan[k] == dm_horz) {\n\t\t\tlocals->SwathWidthYSingleDPP[k] = mode_lib->vba.ViewportWidth[k];\n\t\t} else {\n\t\t\tlocals->SwathWidthYSingleDPP[k] = mode_lib->vba.ViewportHeight[k];\n\t\t}\n\t}\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tlocals->ReadBandwidthLuma[k] = locals->SwathWidthYSingleDPP[k] * dml_ceil(locals->BytePerPixelInDETY[k], 1.0)\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]) * mode_lib->vba.VRatio[k];\n\t\tlocals->ReadBandwidthChroma[k] = locals->SwathWidthYSingleDPP[k] / 2 * dml_ceil(locals->BytePerPixelInDETC[k], 2.0)\n\t\t\t\t/ (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]) * mode_lib->vba.VRatio[k] / 2.0;\n\t\tlocals->ReadBandwidth[k] = locals->ReadBandwidthLuma[k] + locals->ReadBandwidthChroma[k];\n\t}\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true\n\t\t\t\t&& mode_lib->vba.WritebackPixelFormat[k] == dm_444_32) {\n\t\t\tlocals->WriteBandwidth[k] = mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t/ (mode_lib->vba.WritebackSourceHeight[k]\n\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]) * 4.0;\n\t\t} else if (mode_lib->vba.WritebackEnable[k] == true\n\t\t\t\t&& mode_lib->vba.WritebackPixelFormat[k] == dm_420_10) {\n\t\t\tlocals->WriteBandwidth[k] = mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t/ (mode_lib->vba.WritebackSourceHeight[k]\n\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]) * 3.0;\n\t\t} else if (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\tlocals->WriteBandwidth[k] = mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t* mode_lib->vba.WritebackDestinationHeight[k]\n\t\t\t\t\t/ (mode_lib->vba.WritebackSourceHeight[k]\n\t\t\t\t\t\t\t* mode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k]) * 1.5;\n\t\t} else {\n\t\t\tlocals->WriteBandwidth[k] = 0.0;\n\t\t}\n\t}\n\tmode_lib->vba.DCCEnabledInAnyPlane = false;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.DCCEnable[k] == true) {\n\t\t\tmode_lib->vba.DCCEnabledInAnyPlane = true;\n\t\t}\n\t}\n\tmode_lib->vba.UrgentLatency = mode_lib->vba.UrgentLatencyPixelDataOnly;\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tlocals->FabricAndDRAMBandwidthPerState[i] = dml_min(\n\t\t\t\tmode_lib->vba.DRAMSpeedPerState[i] * mode_lib->vba.NumberOfChannels\n\t\t\t\t\t\t* mode_lib->vba.DRAMChannelWidth,\n\t\t\t\tmode_lib->vba.FabricClockPerState[i]\n\t\t\t\t\t\t* mode_lib->vba.FabricDatapathToDCNDataReturn) / 1000;\n\t\tlocals->ReturnBWToDCNPerState = dml_min(locals->ReturnBusWidth * locals->DCFCLKPerState[i],\n\t\t\t\tlocals->FabricAndDRAMBandwidthPerState[i] * 1000)\n\t\t\t\t* locals->PercentOfIdealDRAMFabricAndSDPPortBWReceivedAfterUrgLatencyPixelDataOnly / 100;\n\n\t\tlocals->ReturnBWPerState[i][0] = locals->ReturnBWToDCNPerState;\n\n\t\tif (locals->DCCEnabledInAnyPlane == true && locals->ReturnBWToDCNPerState > locals->DCFCLKPerState[i] * locals->ReturnBusWidth / 4) {\n\t\t\tlocals->ReturnBWPerState[i][0] = dml_min(locals->ReturnBWPerState[i][0],\n\t\t\t\t\tlocals->ReturnBWToDCNPerState * 4 * (1 - locals->UrgentLatency /\n\t\t\t\t\t((locals->ROBBufferSizeInKByte - locals->PixelChunkSizeInKByte) * 1024\n\t\t\t\t\t/ (locals->ReturnBWToDCNPerState - locals->DCFCLKPerState[i]\n\t\t\t\t\t* locals->ReturnBusWidth / 4) + locals->UrgentLatency)));\n\t\t}\n\t\tlocals->CriticalPoint = 2 * locals->ReturnBusWidth * locals->DCFCLKPerState[i] *\n\t\t\t\tlocals->UrgentLatency / (locals->ReturnBWToDCNPerState * locals->UrgentLatency\n\t\t\t\t+ (locals->ROBBufferSizeInKByte - locals->PixelChunkSizeInKByte) * 1024);\n\n\t\tif (locals->DCCEnabledInAnyPlane && locals->CriticalPoint > 1 && locals->CriticalPoint < 4) {\n\t\t\tlocals->ReturnBWPerState[i][0] = dml_min(locals->ReturnBWPerState[i][0],\n\t\t\t\t4 * locals->ReturnBWToDCNPerState *\n\t\t\t\t(locals->ROBBufferSizeInKByte - locals->PixelChunkSizeInKByte) * 1024\n\t\t\t\t* locals->ReturnBusWidth * locals->DCFCLKPerState[i] * locals->UrgentLatency /\n\t\t\t\tdml_pow((locals->ReturnBWToDCNPerState * locals->UrgentLatency\n\t\t\t\t+ (locals->ROBBufferSizeInKByte - locals->PixelChunkSizeInKByte) * 1024), 2));\n\t\t}\n\n\t\tlocals->ReturnBWToDCNPerState = dml_min(locals->ReturnBusWidth *\n\t\t\t\tlocals->DCFCLKPerState[i], locals->FabricAndDRAMBandwidthPerState[i] * 1000);\n\n\t\tif (locals->DCCEnabledInAnyPlane == true && locals->ReturnBWToDCNPerState > locals->DCFCLKPerState[i] * locals->ReturnBusWidth / 4) {\n\t\t\tlocals->ReturnBWPerState[i][0] = dml_min(locals->ReturnBWPerState[i][0],\n\t\t\t\t\tlocals->ReturnBWToDCNPerState * 4 * (1 - locals->UrgentLatency /\n\t\t\t\t\t((locals->ROBBufferSizeInKByte - locals->PixelChunkSizeInKByte) * 1024\n\t\t\t\t\t/ (locals->ReturnBWToDCNPerState - locals->DCFCLKPerState[i]\n\t\t\t\t\t* locals->ReturnBusWidth / 4) + locals->UrgentLatency)));\n\t\t}\n\t\tlocals->CriticalPoint = 2 * locals->ReturnBusWidth * locals->DCFCLKPerState[i] *\n\t\t\t\tlocals->UrgentLatency / (locals->ReturnBWToDCNPerState * locals->UrgentLatency\n\t\t\t\t+ (locals->ROBBufferSizeInKByte - locals->PixelChunkSizeInKByte) * 1024);\n\n\t\tif (locals->DCCEnabledInAnyPlane && locals->CriticalPoint > 1 && locals->CriticalPoint < 4) {\n\t\t\tlocals->ReturnBWPerState[i][0] = dml_min(locals->ReturnBWPerState[i][0],\n\t\t\t\t4 * locals->ReturnBWToDCNPerState *\n\t\t\t\t(locals->ROBBufferSizeInKByte - locals->PixelChunkSizeInKByte) * 1024\n\t\t\t\t* locals->ReturnBusWidth * locals->DCFCLKPerState[i] * locals->UrgentLatency /\n\t\t\t\tdml_pow((locals->ReturnBWToDCNPerState * locals->UrgentLatency\n\t\t\t\t+ (locals->ROBBufferSizeInKByte - locals->PixelChunkSizeInKByte) * 1024), 2));\n\t\t}\n\t}\n\t \n\n\tmode_lib->vba.WritebackLatencySupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\tif (mode_lib->vba.WritebackPixelFormat[k] == dm_444_32) {\n\t\t\t\tif (locals->WriteBandwidth[k]\n\t\t\t\t\t\t> (mode_lib->vba.WritebackInterfaceLumaBufferSize\n\t\t\t\t\t\t\t\t+ mode_lib->vba.WritebackInterfaceChromaBufferSize)\n\t\t\t\t\t\t\t\t/ mode_lib->vba.WritebackLatency) {\n\t\t\t\t\tmode_lib->vba.WritebackLatencySupport = false;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (locals->WriteBandwidth[k]\n\t\t\t\t\t\t> 1.5\n\t\t\t\t\t\t\t\t* dml_min(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackInterfaceLumaBufferSize,\n\t\t\t\t\t\t\t\t\t\t2.0\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.WritebackInterfaceChromaBufferSize)\n\t\t\t\t\t\t\t\t/ mode_lib->vba.WritebackLatency) {\n\t\t\t\t\tmode_lib->vba.WritebackLatencySupport = false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tlocals->UrgentRoundTripAndOutOfOrderLatencyPerState[i] =\n\t\t\t\t(mode_lib->vba.RoundTripPingLatencyCycles + 32.0) / mode_lib->vba.DCFCLKPerState[i]\n\t\t\t\t+ locals->UrgentOutOfOrderReturnPerChannel * mode_lib->vba.NumberOfChannels / locals->ReturnBWPerState[i][0];\n\t\tif ((mode_lib->vba.ROBBufferSizeInKByte - mode_lib->vba.PixelChunkSizeInKByte) * 1024.0 / locals->ReturnBWPerState[i][0]\n\t\t\t\t> locals->UrgentRoundTripAndOutOfOrderLatencyPerState[i]) {\n\t\t\tlocals->ROBSupport[i][0] = true;\n\t\t} else {\n\t\t\tlocals->ROBSupport[i][0] = false;\n\t\t}\n\t}\n\t \n\n\tmode_lib->vba.TotalNumberOfActiveWriteback = 0;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\tif (mode_lib->vba.ActiveWritebacksPerPlane[k] == 0)\n\t\t\t\tmode_lib->vba.ActiveWritebacksPerPlane[k] = 1;\n\t\t\tmode_lib->vba.TotalNumberOfActiveWriteback =\n\t\t\t\t\tmode_lib->vba.TotalNumberOfActiveWriteback\n\t\t\t\t\t\t\t+ mode_lib->vba.ActiveWritebacksPerPlane[k];\n\t\t}\n\t}\n\tmode_lib->vba.WritebackModeSupport = true;\n\tif (mode_lib->vba.TotalNumberOfActiveWriteback > mode_lib->vba.MaxNumWriteback) {\n\t\tmode_lib->vba.WritebackModeSupport = false;\n\t}\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true\n\t\t\t\t&& mode_lib->vba.Writeback10bpc420Supported != true\n\t\t\t\t&& mode_lib->vba.WritebackPixelFormat[k] == dm_420_10) {\n\t\t\tmode_lib->vba.WritebackModeSupport = false;\n\t\t}\n\t}\n\t \n\n\tmode_lib->vba.WritebackScaleRatioAndTapsSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\tif (mode_lib->vba.WritebackLumaAndChromaScalingSupported == false\n\t\t\t\t\t&& (mode_lib->vba.WritebackHRatio[k] != 1.0\n\t\t\t\t\t\t\t|| mode_lib->vba.WritebackVRatio[k] != 1.0)) {\n\t\t\t\tmode_lib->vba.WritebackScaleRatioAndTapsSupport = false;\n\t\t\t}\n\t\t\tif (mode_lib->vba.WritebackHRatio[k] > mode_lib->vba.WritebackMaxHSCLRatio\n\t\t\t\t\t|| mode_lib->vba.WritebackVRatio[k]\n\t\t\t\t\t\t\t> mode_lib->vba.WritebackMaxVSCLRatio\n\t\t\t\t\t|| mode_lib->vba.WritebackHRatio[k]\n\t\t\t\t\t\t\t< mode_lib->vba.WritebackMinHSCLRatio\n\t\t\t\t\t|| mode_lib->vba.WritebackVRatio[k]\n\t\t\t\t\t\t\t< mode_lib->vba.WritebackMinVSCLRatio\n\t\t\t\t\t|| mode_lib->vba.WritebackLumaHTaps[k]\n\t\t\t\t\t\t\t> mode_lib->vba.WritebackMaxHSCLTaps\n\t\t\t\t\t|| mode_lib->vba.WritebackLumaVTaps[k]\n\t\t\t\t\t\t\t> mode_lib->vba.WritebackMaxVSCLTaps\n\t\t\t\t\t|| mode_lib->vba.WritebackHRatio[k]\n\t\t\t\t\t\t\t> mode_lib->vba.WritebackLumaHTaps[k]\n\t\t\t\t\t|| mode_lib->vba.WritebackVRatio[k]\n\t\t\t\t\t\t\t> mode_lib->vba.WritebackLumaVTaps[k]\n\t\t\t\t\t|| (mode_lib->vba.WritebackLumaHTaps[k] > 2.0\n\t\t\t\t\t\t\t&& ((mode_lib->vba.WritebackLumaHTaps[k] % 2)\n\t\t\t\t\t\t\t\t\t== 1))\n\t\t\t\t\t|| (mode_lib->vba.WritebackPixelFormat[k] != dm_444_32\n\t\t\t\t\t\t\t&& (mode_lib->vba.WritebackChromaHTaps[k]\n\t\t\t\t\t\t\t\t\t> mode_lib->vba.WritebackMaxHSCLTaps\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.WritebackChromaVTaps[k]\n\t\t\t\t\t\t\t\t\t\t\t> mode_lib->vba.WritebackMaxVSCLTaps\n\t\t\t\t\t\t\t\t\t|| 2.0\n\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.WritebackHRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t> mode_lib->vba.WritebackChromaHTaps[k]\n\t\t\t\t\t\t\t\t\t|| 2.0\n\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.WritebackVRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t> mode_lib->vba.WritebackChromaVTaps[k]\n\t\t\t\t\t\t\t\t\t|| (mode_lib->vba.WritebackChromaHTaps[k] > 2.0\n\t\t\t\t\t\t\t\t\t\t&& ((mode_lib->vba.WritebackChromaHTaps[k] % 2) == 1))))) {\n\t\t\t\tmode_lib->vba.WritebackScaleRatioAndTapsSupport = false;\n\t\t\t}\n\t\t\tif (mode_lib->vba.WritebackVRatio[k] < 1.0) {\n\t\t\t\tmode_lib->vba.WritebackLumaVExtra =\n\t\t\t\t\t\tdml_max(1.0 - 2.0 / dml_ceil(1.0 / mode_lib->vba.WritebackVRatio[k], 1.0), 0.0);\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.WritebackLumaVExtra = -1;\n\t\t\t}\n\t\t\tif ((mode_lib->vba.WritebackPixelFormat[k] == dm_444_32\n\t\t\t\t\t&& mode_lib->vba.WritebackLumaVTaps[k]\n\t\t\t\t\t\t\t> (mode_lib->vba.WritebackLineBufferLumaBufferSize\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.WritebackLineBufferChromaBufferSize)\n\t\t\t\t\t\t\t\t\t/ 3.0\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t\t\t\t- mode_lib->vba.WritebackLumaVExtra)\n\t\t\t\t\t|| (mode_lib->vba.WritebackPixelFormat[k] == dm_420_8\n\t\t\t\t\t\t\t&& mode_lib->vba.WritebackLumaVTaps[k]\n\t\t\t\t\t\t\t\t\t> mode_lib->vba.WritebackLineBufferLumaBufferSize\n\t\t\t\t\t\t\t\t\t\t\t* 8.0 / 10.0 / mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.WritebackLumaVExtra)\n\t\t\t\t\t|| (mode_lib->vba.WritebackPixelFormat[k] == dm_420_10\n\t\t\t\t\t\t\t&& mode_lib->vba.WritebackLumaVTaps[k]\n\t\t\t\t\t\t\t\t\t> mode_lib->vba.WritebackLineBufferLumaBufferSize\n\t\t\t\t\t\t\t\t\t\t\t* 8.0 / 10.0\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.WritebackLumaVExtra)) {\n\t\t\t\tmode_lib->vba.WritebackScaleRatioAndTapsSupport = false;\n\t\t\t}\n\t\t\tif (2.0 * mode_lib->vba.WritebackVRatio[k] < 1) {\n\t\t\t\tmode_lib->vba.WritebackChromaVExtra = 0.0;\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.WritebackChromaVExtra = -1;\n\t\t\t}\n\t\t\tif ((mode_lib->vba.WritebackPixelFormat[k] == dm_420_8\n\t\t\t\t\t&& mode_lib->vba.WritebackChromaVTaps[k]\n\t\t\t\t\t\t\t> mode_lib->vba.WritebackLineBufferChromaBufferSize\n\t\t\t\t\t\t\t\t\t* 8.0 / 10.0 / mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t\t\t\t- mode_lib->vba.WritebackChromaVExtra)\n\t\t\t\t\t|| (mode_lib->vba.WritebackPixelFormat[k] == dm_420_10\n\t\t\t\t\t\t\t&& mode_lib->vba.WritebackChromaVTaps[k]\n\t\t\t\t\t\t\t\t\t> mode_lib->vba.WritebackLineBufferChromaBufferSize\n\t\t\t\t\t\t\t\t\t\t\t* 8.0 / 10.0\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.WritebackDestinationWidth[k]\n\t\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.WritebackChromaVExtra)) {\n\t\t\t\tmode_lib->vba.WritebackScaleRatioAndTapsSupport = false;\n\t\t\t}\n\t\t}\n\t}\n\t \n\n\tmode_lib->vba.WritebackRequiredDISPCLK = 0.0;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\tmode_lib->vba.WritebackRequiredDISPCLK =\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tmode_lib->vba.WritebackRequiredDISPCLK,\n\t\t\t\t\t\t\tCalculateWriteBackDISPCLK(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaHTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaVTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaHTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaVTaps[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.HTotal[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaLineBufferWidth));\n\t\t}\n\t}\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.HRatio[k] > 1.0) {\n\t\t\tlocals->PSCL_FACTOR[k] = dml_min(\n\t\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput,\n\t\t\t\t\tmode_lib->vba.MaxPSCLToLBThroughput\n\t\t\t\t\t\t\t* mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t/ dml_ceil(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.htaps[k]\n\t\t\t\t\t\t\t\t\t\t\t/ 6.0,\n\t\t\t\t\t\t\t\t\t1.0));\n\t\t} else {\n\t\t\tlocals->PSCL_FACTOR[k] = dml_min(\n\t\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput,\n\t\t\t\t\tmode_lib->vba.MaxPSCLToLBThroughput);\n\t\t}\n\t\tif (locals->BytePerPixelInDETC[k] == 0.0) {\n\t\t\tlocals->PSCL_FACTOR_CHROMA[k] = 0.0;\n\t\t\tlocals->MinDPPCLKUsingSingleDPP[k] =\n\t\t\t\t\tmode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t* dml_max3(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.vtaps[k] / 6.0\n\t\t\t\t\t\t\t\t\t\t\t* dml_min(\n\t\t\t\t\t\t\t\t\t\t\t\t\t1.0,\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]),\n\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.VRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t/ locals->PSCL_FACTOR[k],\n\t\t\t\t\t\t\t\t\t1.0);\n\t\t\tif ((mode_lib->vba.htaps[k] > 6.0 || mode_lib->vba.vtaps[k] > 6.0)\n\t\t\t\t\t&& locals->MinDPPCLKUsingSingleDPP[k]\n\t\t\t\t\t\t\t< 2.0 * mode_lib->vba.PixelClock[k]) {\n\t\t\t\tlocals->MinDPPCLKUsingSingleDPP[k] = 2.0\n\t\t\t\t\t\t* mode_lib->vba.PixelClock[k];\n\t\t\t}\n\t\t} else {\n\t\t\tif (mode_lib->vba.HRatio[k] / 2.0 > 1.0) {\n\t\t\t\tlocals->PSCL_FACTOR_CHROMA[k] =\n\t\t\t\t\t\tdml_min(\n\t\t\t\t\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput,\n\t\t\t\t\t\t\t\tmode_lib->vba.MaxPSCLToLBThroughput\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t/ 2.0\n\t\t\t\t\t\t\t\t\t\t/ dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HTAPsChroma[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 6.0,\n\t\t\t\t\t\t\t\t\t\t\t\t1.0));\n\t\t\t} else {\n\t\t\t\tlocals->PSCL_FACTOR_CHROMA[k] = dml_min(\n\t\t\t\t\t\tmode_lib->vba.MaxDCHUBToPSCLThroughput,\n\t\t\t\t\t\tmode_lib->vba.MaxPSCLToLBThroughput);\n\t\t\t}\n\t\t\tlocals->MinDPPCLKUsingSingleDPP[k] =\n\t\t\t\t\tmode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t* dml_max5(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.vtaps[k] / 6.0\n\t\t\t\t\t\t\t\t\t\t\t* dml_min(\n\t\t\t\t\t\t\t\t\t\t\t\t\t1.0,\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]),\n\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.VRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t/ locals->PSCL_FACTOR[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.VTAPsChroma[k]\n\t\t\t\t\t\t\t\t\t\t\t/ 6.0\n\t\t\t\t\t\t\t\t\t\t\t* dml_min(\n\t\t\t\t\t\t\t\t\t\t\t\t\t1.0,\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0),\n\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.VRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t/ 4.0\n\t\t\t\t\t\t\t\t\t\t\t/ locals->PSCL_FACTOR_CHROMA[k],\n\t\t\t\t\t\t\t\t\t1.0);\n\t\t\tif ((mode_lib->vba.htaps[k] > 6.0 || mode_lib->vba.vtaps[k] > 6.0\n\t\t\t\t\t|| mode_lib->vba.HTAPsChroma[k] > 6.0\n\t\t\t\t\t|| mode_lib->vba.VTAPsChroma[k] > 6.0)\n\t\t\t\t\t&& locals->MinDPPCLKUsingSingleDPP[k]\n\t\t\t\t\t\t\t< 2.0 * mode_lib->vba.PixelClock[k]) {\n\t\t\t\tlocals->MinDPPCLKUsingSingleDPP[k] = 2.0\n\t\t\t\t\t\t* mode_lib->vba.PixelClock[k];\n\t\t\t}\n\t\t}\n\t}\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tCalculate256BBlockSizes(\n\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\tmode_lib->vba.SurfaceTiling[k],\n\t\t\t\tdml_ceil(locals->BytePerPixelInDETY[k], 1.0),\n\t\t\t\tdml_ceil(locals->BytePerPixelInDETC[k], 2.0),\n\t\t\t\t&locals->Read256BlockHeightY[k],\n\t\t\t\t&locals->Read256BlockHeightC[k],\n\t\t\t\t&locals->Read256BlockWidthY[k],\n\t\t\t\t&locals->Read256BlockWidthC[k]);\n\t\tif (mode_lib->vba.SourceScan[k] == dm_horz) {\n\t\t\tlocals->MaxSwathHeightY[k] = locals->Read256BlockHeightY[k];\n\t\t\tlocals->MaxSwathHeightC[k] = locals->Read256BlockHeightC[k];\n\t\t} else {\n\t\t\tlocals->MaxSwathHeightY[k] = locals->Read256BlockWidthY[k];\n\t\t\tlocals->MaxSwathHeightC[k] = locals->Read256BlockWidthC[k];\n\t\t}\n\t\tif ((mode_lib->vba.SourcePixelFormat[k] == dm_444_64\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_444_32\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_444_16\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_mono_16\n\t\t\t\t|| mode_lib->vba.SourcePixelFormat[k] == dm_mono_8)) {\n\t\t\tif (mode_lib->vba.SurfaceTiling[k] == dm_sw_linear\n\t\t\t\t\t|| (mode_lib->vba.SourcePixelFormat[k] == dm_444_64\n\t\t\t\t\t\t\t&& (mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t== dm_sw_4kb_s\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_4kb_s_x\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_64kb_s\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_64kb_s_t\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_64kb_s_x\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_var_s\n\t\t\t\t\t\t\t\t\t|| mode_lib->vba.SurfaceTiling[k]\n\t\t\t\t\t\t\t\t\t\t\t== dm_sw_var_s_x)\n\t\t\t\t\t\t\t&& mode_lib->vba.SourceScan[k] == dm_horz)) {\n\t\t\t\tlocals->MinSwathHeightY[k] = locals->MaxSwathHeightY[k];\n\t\t\t} else {\n\t\t\t\tlocals->MinSwathHeightY[k] = locals->MaxSwathHeightY[k]\n\t\t\t\t\t\t/ 2.0;\n\t\t\t}\n\t\t\tlocals->MinSwathHeightC[k] = locals->MaxSwathHeightC[k];\n\t\t} else {\n\t\t\tif (mode_lib->vba.SurfaceTiling[k] == dm_sw_linear) {\n\t\t\t\tlocals->MinSwathHeightY[k] = locals->MaxSwathHeightY[k];\n\t\t\t\tlocals->MinSwathHeightC[k] = locals->MaxSwathHeightC[k];\n\t\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_420_8\n\t\t\t\t\t&& mode_lib->vba.SourceScan[k] == dm_horz) {\n\t\t\t\tlocals->MinSwathHeightY[k] = locals->MaxSwathHeightY[k]\n\t\t\t\t\t\t/ 2.0;\n\t\t\t\tlocals->MinSwathHeightC[k] = locals->MaxSwathHeightC[k];\n\t\t\t} else if (mode_lib->vba.SourcePixelFormat[k] == dm_420_10\n\t\t\t\t\t&& mode_lib->vba.SourceScan[k] == dm_horz) {\n\t\t\t\tlocals->MinSwathHeightC[k] = locals->MaxSwathHeightC[k]\n\t\t\t\t\t\t/ 2.0;\n\t\t\t\tlocals->MinSwathHeightY[k] = locals->MaxSwathHeightY[k];\n\t\t\t} else {\n\t\t\t\tlocals->MinSwathHeightY[k] = locals->MaxSwathHeightY[k];\n\t\t\t\tlocals->MinSwathHeightC[k] = locals->MaxSwathHeightC[k];\n\t\t\t}\n\t\t}\n\t\tif (mode_lib->vba.SurfaceTiling[k] == dm_sw_linear) {\n\t\t\tmode_lib->vba.MaximumSwathWidthSupport = 8192.0;\n\t\t} else {\n\t\t\tmode_lib->vba.MaximumSwathWidthSupport = 5120.0;\n\t\t}\n\t\tmode_lib->vba.MaximumSwathWidthInDETBuffer =\n\t\t\t\tdml_min(\n\t\t\t\t\t\tmode_lib->vba.MaximumSwathWidthSupport,\n\t\t\t\t\t\tmode_lib->vba.DETBufferSizeInKByte[0] * 1024.0 / 2.0\n\t\t\t\t\t\t\t\t/ (locals->BytePerPixelInDETY[k]\n\t\t\t\t\t\t\t\t\t\t* locals->MinSwathHeightY[k]\n\t\t\t\t\t\t\t\t\t\t+ locals->BytePerPixelInDETC[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0\n\t\t\t\t\t\t\t\t\t\t\t\t* locals->MinSwathHeightC[k]));\n\t\tif (locals->BytePerPixelInDETC[k] == 0.0) {\n\t\t\tmode_lib->vba.MaximumSwathWidthInLineBuffer =\n\t\t\t\t\tmode_lib->vba.LineBufferSize\n\t\t\t\t\t\t\t* dml_max(mode_lib->vba.HRatio[k], 1.0)\n\t\t\t\t\t\t\t/ mode_lib->vba.LBBitPerPixel[k]\n\t\t\t\t\t\t\t/ (mode_lib->vba.vtaps[k]\n\t\t\t\t\t\t\t\t\t+ dml_max(\n\t\t\t\t\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t\t\t\t\t\t\t\t- 2,\n\t\t\t\t\t\t\t\t\t\t\t0.0));\n\t\t} else {\n\t\t\tmode_lib->vba.MaximumSwathWidthInLineBuffer =\n\t\t\t\t\tdml_min(\n\t\t\t\t\t\t\tmode_lib->vba.LineBufferSize\n\t\t\t\t\t\t\t\t\t* dml_max(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k],\n\t\t\t\t\t\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.LBBitPerPixel[k]\n\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.vtaps[k]\n\t\t\t\t\t\t\t\t\t\t\t+ dml_max(\n\t\t\t\t\t\t\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 2,\n\t\t\t\t\t\t\t\t\t\t\t\t\t0.0)),\n\t\t\t\t\t\t\t2.0 * mode_lib->vba.LineBufferSize\n\t\t\t\t\t\t\t\t\t* dml_max(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0,\n\t\t\t\t\t\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.LBBitPerPixel[k]\n\t\t\t\t\t\t\t\t\t/ (mode_lib->vba.VTAPsChroma[k]\n\t\t\t\t\t\t\t\t\t\t\t+ dml_max(\n\t\t\t\t\t\t\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.VRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t- 2,\n\t\t\t\t\t\t\t\t\t\t\t\t\t0.0)));\n\t\t}\n\t\tlocals->MaximumSwathWidth[k] = dml_min(\n\t\t\t\tmode_lib->vba.MaximumSwathWidthInDETBuffer,\n\t\t\t\tmode_lib->vba.MaximumSwathWidthInLineBuffer);\n\t}\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tmode_lib->vba.MaxDispclkRoundedDownToDFSGranularity = RoundToDFSGranularityDown(\n\t\t\t\tmode_lib->vba.MaxDispclk[i],\n\t\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed);\n\t\t\tmode_lib->vba.MaxDppclkRoundedDownToDFSGranularity = RoundToDFSGranularityDown(\n\t\t\t\tmode_lib->vba.MaxDppclk[i],\n\t\t\t\tmode_lib->vba.DISPCLKDPPCLKVCOSpeed);\n\t\t\tlocals->RequiredDISPCLK[i][j] = 0.0;\n\t\t\tlocals->DISPCLK_DPPCLK_Support[i][j] = true;\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLKWithoutODMCombine =\n\t\t\t\t\t\tmode_lib->vba.PixelClock[k] * (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0)\n\t\t\t\t\t\t\t\t* (1.0 + mode_lib->vba.DISPCLKRampingMargin / 100.0);\n\t\t\t\tif (mode_lib->vba.PlaneRequiredDISPCLKWithoutODMCombine >= mode_lib->vba.MaxDispclk[i]\n\t\t\t\t\t\t&& i == mode_lib->vba.soc.num_states)\n\t\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLKWithoutODMCombine = mode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t* (1 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0);\n\n\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLKWithODMCombine = mode_lib->vba.PixelClock[k] / 2\n\t\t\t\t\t* (1 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0) * (1 + mode_lib->vba.DISPCLKRampingMargin / 100.0);\n\t\t\t\tif (mode_lib->vba.PlaneRequiredDISPCLKWithODMCombine >= mode_lib->vba.MaxDispclk[i]\n\t\t\t\t\t\t&& i == mode_lib->vba.soc.num_states)\n\t\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLKWithODMCombine = mode_lib->vba.PixelClock[k] / 2\n\t\t\t\t\t\t\t* (1 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0);\n\n\t\t\t\tlocals->ODMCombineEnablePerState[i][k] = dm_odm_combine_mode_disabled;\n\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLK = mode_lib->vba.PlaneRequiredDISPCLKWithoutODMCombine;\n\t\t\t\tif (mode_lib->vba.ODMCapability) {\n\t\t\t\t\tif (locals->PlaneRequiredDISPCLKWithoutODMCombine > mode_lib->vba.MaxDispclkRoundedDownToDFSGranularity) {\n\t\t\t\t\t\tlocals->ODMCombineEnablePerState[i][k] = dm_odm_combine_mode_2to1;\n\t\t\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLK = mode_lib->vba.PlaneRequiredDISPCLKWithODMCombine;\n\t\t\t\t\t} else if (locals->HActive[k] > DCN20_MAX_420_IMAGE_WIDTH && locals->OutputFormat[k] == dm_420) {\n\t\t\t\t\t\tlocals->ODMCombineEnablePerState[i][k] = dm_odm_combine_mode_2to1;\n\t\t\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLK = mode_lib->vba.PlaneRequiredDISPCLKWithODMCombine;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (locals->MinDPPCLKUsingSingleDPP[k] * (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0) <= mode_lib->vba.MaxDppclkRoundedDownToDFSGranularity\n\t\t\t\t\t\t&& locals->SwathWidthYSingleDPP[k] <= locals->MaximumSwathWidth[k]\n\t\t\t\t\t\t&& locals->ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_disabled) {\n\t\t\t\t\tlocals->NoOfDPP[i][j][k] = 1;\n\t\t\t\t\tlocals->RequiredDPPCLK[i][j][k] =\n\t\t\t\t\t\tlocals->MinDPPCLKUsingSingleDPP[k] * (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0);\n\t\t\t\t} else {\n\t\t\t\t\tlocals->NoOfDPP[i][j][k] = 2;\n\t\t\t\t\tlocals->RequiredDPPCLK[i][j][k] =\n\t\t\t\t\t\tlocals->MinDPPCLKUsingSingleDPP[k] * (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0) / 2.0;\n\t\t\t\t}\n\t\t\t\tlocals->RequiredDISPCLK[i][j] = dml_max(\n\t\t\t\t\t\tlocals->RequiredDISPCLK[i][j],\n\t\t\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLK);\n\t\t\t\tif ((locals->MinDPPCLKUsingSingleDPP[k] / locals->NoOfDPP[i][j][k] * (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0)\n\t\t\t\t\t\t> mode_lib->vba.MaxDppclkRoundedDownToDFSGranularity)\n\t\t\t\t\t\t|| (mode_lib->vba.PlaneRequiredDISPCLK > mode_lib->vba.MaxDispclkRoundedDownToDFSGranularity)) {\n\t\t\t\t\tlocals->DISPCLK_DPPCLK_Support[i][j] = false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tlocals->TotalNumberOfActiveDPP[i][j] = 0.0;\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++)\n\t\t\t\tlocals->TotalNumberOfActiveDPP[i][j] = locals->TotalNumberOfActiveDPP[i][j] + locals->NoOfDPP[i][j][k];\n\t\t\tif (j == 1) {\n\t\t\t\twhile (locals->TotalNumberOfActiveDPP[i][j] < mode_lib->vba.MaxNumDPP\n\t\t\t\t\t\t&& locals->TotalNumberOfActiveDPP[i][j] < 2 * mode_lib->vba.NumberOfActivePlanes) {\n\t\t\t\t\tdouble BWOfNonSplitPlaneOfMaximumBandwidth;\n\t\t\t\t\tunsigned int NumberOfNonSplitPlaneOfMaximumBandwidth;\n\n\t\t\t\t\tBWOfNonSplitPlaneOfMaximumBandwidth = 0;\n\t\t\t\t\tNumberOfNonSplitPlaneOfMaximumBandwidth = 0;\n\t\t\t\t\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; ++k) {\n\t\t\t\t\t\tif (locals->ReadBandwidth[k] > BWOfNonSplitPlaneOfMaximumBandwidth && locals->NoOfDPP[i][j][k] == 1) {\n\t\t\t\t\t\t\tBWOfNonSplitPlaneOfMaximumBandwidth = locals->ReadBandwidth[k];\n\t\t\t\t\t\t\tNumberOfNonSplitPlaneOfMaximumBandwidth = k;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tlocals->NoOfDPP[i][j][NumberOfNonSplitPlaneOfMaximumBandwidth] = 2;\n\t\t\t\t\tlocals->RequiredDPPCLK[i][j][NumberOfNonSplitPlaneOfMaximumBandwidth] =\n\t\t\t\t\t\tlocals->MinDPPCLKUsingSingleDPP[NumberOfNonSplitPlaneOfMaximumBandwidth]\n\t\t\t\t\t\t\t* (1 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100) / 2;\n\t\t\t\t\tlocals->TotalNumberOfActiveDPP[i][j] = locals->TotalNumberOfActiveDPP[i][j] + 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (locals->TotalNumberOfActiveDPP[i][j] > mode_lib->vba.MaxNumDPP) {\n\t\t\t\tlocals->RequiredDISPCLK[i][j] = 0.0;\n\t\t\t\tlocals->DISPCLK_DPPCLK_Support[i][j] = true;\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tlocals->ODMCombineEnablePerState[i][k] = dm_odm_combine_mode_disabled;\n\t\t\t\t\tif (locals->SwathWidthYSingleDPP[k] <= locals->MaximumSwathWidth[k]) {\n\t\t\t\t\t\tlocals->NoOfDPP[i][j][k] = 1;\n\t\t\t\t\t\tlocals->RequiredDPPCLK[i][j][k] = locals->MinDPPCLKUsingSingleDPP[k]\n\t\t\t\t\t\t\t* (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlocals->NoOfDPP[i][j][k] = 2;\n\t\t\t\t\t\tlocals->RequiredDPPCLK[i][j][k] = locals->MinDPPCLKUsingSingleDPP[k]\n\t\t\t\t\t\t\t\t\t\t* (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0) / 2.0;\n\t\t\t\t\t}\n\t\t\t\t\tif (i != mode_lib->vba.soc.num_states) {\n\t\t\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLK =\n\t\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t\t\t\t* (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0)\n\t\t\t\t\t\t\t\t\t\t* (1.0 + mode_lib->vba.DISPCLKRampingMargin / 100.0);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLK = mode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t* (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0);\n\t\t\t\t\t}\n\t\t\t\t\tlocals->RequiredDISPCLK[i][j] = dml_max(\n\t\t\t\t\t\t\tlocals->RequiredDISPCLK[i][j],\n\t\t\t\t\t\t\tmode_lib->vba.PlaneRequiredDISPCLK);\n\t\t\t\t\tif (locals->MinDPPCLKUsingSingleDPP[k] / locals->NoOfDPP[i][j][k] * (1.0 + mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0)\n\t\t\t\t\t\t\t> mode_lib->vba.MaxDppclkRoundedDownToDFSGranularity\n\t\t\t\t\t\t\t|| mode_lib->vba.PlaneRequiredDISPCLK > mode_lib->vba.MaxDispclkRoundedDownToDFSGranularity)\n\t\t\t\t\t\tlocals->DISPCLK_DPPCLK_Support[i][j] = false;\n\t\t\t\t}\n\t\t\t\tlocals->TotalNumberOfActiveDPP[i][j] = 0.0;\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++)\n\t\t\t\t\tlocals->TotalNumberOfActiveDPP[i][j] = locals->TotalNumberOfActiveDPP[i][j] + locals->NoOfDPP[i][j][k];\n\t\t\t}\n\t\t\tlocals->RequiredDISPCLK[i][j] = dml_max(\n\t\t\t\t\tlocals->RequiredDISPCLK[i][j],\n\t\t\t\t\tmode_lib->vba.WritebackRequiredDISPCLK);\n\t\t\tif (mode_lib->vba.MaxDispclkRoundedDownToDFSGranularity\n\t\t\t\t\t< mode_lib->vba.WritebackRequiredDISPCLK) {\n\t\t\t\tlocals->DISPCLK_DPPCLK_Support[i][j] = false;\n\t\t\t}\n\t\t}\n\t}\n\t \n\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tlocals->ViewportSizeSupport[i][0] = true;\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\tif (locals->ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_2to1) {\n\t\t\t\tif (dml_min(locals->SwathWidthYSingleDPP[k], dml_round(mode_lib->vba.HActive[k] / 2.0 * mode_lib->vba.HRatio[k]))\n\t\t\t\t\t\t> locals->MaximumSwathWidth[k]) {\n\t\t\t\t\tlocals->ViewportSizeSupport[i][0] = false;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (locals->SwathWidthYSingleDPP[k] / 2.0 > locals->MaximumSwathWidth[k]) {\n\t\t\t\t\tlocals->ViewportSizeSupport[i][0] = false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tif (locals->TotalNumberOfActiveDPP[i][j] <= mode_lib->vba.MaxNumDPP)\n\t\t\t\tlocals->TotalAvailablePipesSupport[i][j] = true;\n\t\t\telse\n\t\t\t\tlocals->TotalAvailablePipesSupport[i][j] = false;\n\t\t}\n\t}\n\t \n\n\tmode_lib->vba.TotalNumberOfActiveOTG = 0.0;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\tmode_lib->vba.TotalNumberOfActiveOTG = mode_lib->vba.TotalNumberOfActiveOTG\n\t\t\t\t\t+ 1.0;\n\t\t}\n\t}\n\tif (mode_lib->vba.TotalNumberOfActiveOTG <= mode_lib->vba.MaxNumOTG) {\n\t\tmode_lib->vba.NumberOfOTGSupport = true;\n\t} else {\n\t\tmode_lib->vba.NumberOfOTGSupport = false;\n\t}\n\t \n\n\tmode_lib->vba.NonsupportedDSCInputBPC = false;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (!(mode_lib->vba.DSCInputBitPerComponent[k] == 12.0\n\t\t\t\t|| mode_lib->vba.DSCInputBitPerComponent[k] == 10.0\n\t\t\t\t|| mode_lib->vba.DSCInputBitPerComponent[k] == 8.0)) {\n\t\t\tmode_lib->vba.NonsupportedDSCInputBPC = true;\n\t\t}\n\t}\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\tlocals->RequiresDSC[i][k] = 0;\n\t\t\tlocals->RequiresFEC[i][k] = 0;\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\t\tif (mode_lib->vba.Output[k] == dm_hdmi) {\n\t\t\t\t\tlocals->RequiresDSC[i][k] = 0;\n\t\t\t\t\tlocals->RequiresFEC[i][k] = 0;\n\t\t\t\t\tlocals->OutputBppPerState[i][k] = TruncToValidBPP(\n\t\t\t\t\t\t\tdml_min(600.0, mode_lib->vba.PHYCLKPerState[i]) / mode_lib->vba.PixelClockBackEnd[k] * 24,\n\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k]);\n\t\t\t\t} else if (mode_lib->vba.Output[k] == dm_dp\n\t\t\t\t\t\t|| mode_lib->vba.Output[k] == dm_edp) {\n\t\t\t\t\tif (mode_lib->vba.Output[k] == dm_edp) {\n\t\t\t\t\t\tmode_lib->vba.EffectiveFECOverhead = 0.0;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.EffectiveFECOverhead =\n\t\t\t\t\t\t\t\tmode_lib->vba.FECOverhead;\n\t\t\t\t\t}\n\t\t\t\t\tif (mode_lib->vba.PHYCLKPerState[i] >= 270.0) {\n\t\t\t\t\t\tmode_lib->vba.Outbpp = TruncToValidBPP(\n\t\t\t\t\t\t\t\t(1.0 - mode_lib->vba.Downspreading / 100.0) * 270.0\n\t\t\t\t\t\t\t\t* mode_lib->vba.OutputLinkDPLanes[k] / mode_lib->vba.PixelClockBackEnd[k] * 8.0,\n\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k]);\n\t\t\t\t\t\tmode_lib->vba.OutbppDSC = TruncToValidBPP(\n\t\t\t\t\t\t\t\t(1.0 - mode_lib->vba.Downspreading / 100.0) * (1.0 - mode_lib->vba.EffectiveFECOverhead / 100.0) * 270.0\n\t\t\t\t\t\t\t\t* mode_lib->vba.OutputLinkDPLanes[k] / mode_lib->vba.PixelClockBackEnd[k] * 8.0,\n\t\t\t\t\t\t\t\ttrue,\n\t\t\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k]);\n\t\t\t\t\t\tif (mode_lib->vba.DSCEnabled[k] == true) {\n\t\t\t\t\t\t\tlocals->RequiresDSC[i][k] = true;\n\t\t\t\t\t\t\tif (mode_lib->vba.Output[k] == dm_dp) {\n\t\t\t\t\t\t\t\tlocals->RequiresFEC[i][k] = true;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlocals->RequiresFEC[i][k] = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmode_lib->vba.Outbpp = mode_lib->vba.OutbppDSC;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlocals->RequiresDSC[i][k] = false;\n\t\t\t\t\t\t\tlocals->RequiresFEC[i][k] = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlocals->OutputBppPerState[i][k] = mode_lib->vba.Outbpp;\n\t\t\t\t\t}\n\t\t\t\t\tif (mode_lib->vba.Outbpp == BPP_INVALID && mode_lib->vba.PHYCLKPerState[i] >= 540.0) {\n\t\t\t\t\t\tmode_lib->vba.Outbpp = TruncToValidBPP(\n\t\t\t\t\t\t\t\t(1.0 - mode_lib->vba.Downspreading / 100.0) * 540.0\n\t\t\t\t\t\t\t\t* mode_lib->vba.OutputLinkDPLanes[k] / mode_lib->vba.PixelClockBackEnd[k] * 8.0,\n\t\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k]);\n\t\t\t\t\t\tmode_lib->vba.OutbppDSC = TruncToValidBPP(\n\t\t\t\t\t\t\t\t(1.0 - mode_lib->vba.Downspreading / 100.0) * (1.0 - mode_lib->vba.EffectiveFECOverhead / 100.0) * 540.0\n\t\t\t\t\t\t\t\t* mode_lib->vba.OutputLinkDPLanes[k] / mode_lib->vba.PixelClockBackEnd[k] * 8.0,\n\t\t\t\t\t\t\t\ttrue,\n\t\t\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k]);\n\t\t\t\t\t\tif (mode_lib->vba.DSCEnabled[k] == true) {\n\t\t\t\t\t\t\tlocals->RequiresDSC[i][k] = true;\n\t\t\t\t\t\t\tif (mode_lib->vba.Output[k] == dm_dp) {\n\t\t\t\t\t\t\t\tlocals->RequiresFEC[i][k] = true;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlocals->RequiresFEC[i][k] = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmode_lib->vba.Outbpp = mode_lib->vba.OutbppDSC;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlocals->RequiresDSC[i][k] = false;\n\t\t\t\t\t\t\tlocals->RequiresFEC[i][k] = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlocals->OutputBppPerState[i][k] = mode_lib->vba.Outbpp;\n\t\t\t\t\t}\n\t\t\t\t\tif (mode_lib->vba.Outbpp == BPP_INVALID\n\t\t\t\t\t\t\t&& mode_lib->vba.PHYCLKPerState[i]\n\t\t\t\t\t\t\t\t\t>= 810.0) {\n\t\t\t\t\t\tmode_lib->vba.Outbpp = TruncToValidBPP(\n\t\t\t\t\t\t\t\t(1.0 - mode_lib->vba.Downspreading / 100.0) * 810.0\n\t\t\t\t\t\t\t\t* mode_lib->vba.OutputLinkDPLanes[k] / mode_lib->vba.PixelClockBackEnd[k] * 8.0,\n\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k]);\n\t\t\t\t\t\tmode_lib->vba.OutbppDSC = TruncToValidBPP(\n\t\t\t\t\t\t\t\t(1.0 - mode_lib->vba.Downspreading / 100.0) * (1.0 - mode_lib->vba.EffectiveFECOverhead / 100.0) * 810.0\n\t\t\t\t\t\t\t\t* mode_lib->vba.OutputLinkDPLanes[k] / mode_lib->vba.PixelClockBackEnd[k] * 8.0,\n\t\t\t\t\t\t\t\ttrue,\n\t\t\t\t\t\t\t\tmode_lib->vba.Output[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k]);\n\t\t\t\t\t\tif (mode_lib->vba.DSCEnabled[k] == true || mode_lib->vba.Outbpp == BPP_INVALID) {\n\t\t\t\t\t\t\tlocals->RequiresDSC[i][k] = true;\n\t\t\t\t\t\t\tif (mode_lib->vba.Output[k] == dm_dp) {\n\t\t\t\t\t\t\t\tlocals->RequiresFEC[i][k] = true;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlocals->RequiresFEC[i][k] = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmode_lib->vba.Outbpp = mode_lib->vba.OutbppDSC;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlocals->RequiresDSC[i][k] = false;\n\t\t\t\t\t\t\tlocals->RequiresFEC[i][k] = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlocals->OutputBppPerState[i][k] =\n\t\t\t\t\t\t\t\tmode_lib->vba.Outbpp;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tlocals->OutputBppPerState[i][k] = BPP_BLENDED_PIPE;\n\t\t\t}\n\t\t}\n\t}\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tlocals->DIOSupport[i] = true;\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\tif (!mode_lib->vba.skip_dio_check[k]\n\t\t\t\t\t&& (locals->OutputBppPerState[i][k] == BPP_INVALID\n\t\t\t\t\t\t|| (mode_lib->vba.OutputFormat[k] == dm_420\n\t\t\t\t\t\t\t&& mode_lib->vba.Interlace[k] == true\n\t\t\t\t\t\t\t&& mode_lib->vba.ProgressiveToInterlaceUnitInOPP == true))) {\n\t\t\t\tlocals->DIOSupport[i] = false;\n\t\t\t}\n\t\t}\n\t}\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\tlocals->DSCCLKRequiredMoreThanSupported[i] = false;\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\t\tif ((mode_lib->vba.Output[k] == dm_dp\n\t\t\t\t\t\t|| mode_lib->vba.Output[k] == dm_edp)) {\n\t\t\t\t\tif (mode_lib->vba.OutputFormat[k] == dm_420\n\t\t\t\t\t\t\t|| mode_lib->vba.OutputFormat[k]\n\t\t\t\t\t\t\t\t\t== dm_n422) {\n\t\t\t\t\t\tmode_lib->vba.DSCFormatFactor = 2;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.DSCFormatFactor = 1;\n\t\t\t\t\t}\n\t\t\t\t\tif (locals->RequiresDSC[i][k] == true) {\n\t\t\t\t\t\tif (locals->ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_2to1) {\n\t\t\t\t\t\t\tif (mode_lib->vba.PixelClockBackEnd[k] / 6.0 / mode_lib->vba.DSCFormatFactor\n\t\t\t\t\t\t\t\t\t> (1.0 - mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0) * mode_lib->vba.MaxDSCCLK[i]) {\n\t\t\t\t\t\t\t\tlocals->DSCCLKRequiredMoreThanSupported[i] =\n\t\t\t\t\t\t\t\t\t\ttrue;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif (mode_lib->vba.PixelClockBackEnd[k] / 3.0 / mode_lib->vba.DSCFormatFactor\n\t\t\t\t\t\t\t\t\t> (1.0 - mode_lib->vba.DISPCLKDPPCLKDSCCLKDownSpreading / 100.0) * mode_lib->vba.MaxDSCCLK[i]) {\n\t\t\t\t\t\t\t\tlocals->DSCCLKRequiredMoreThanSupported[i] =\n\t\t\t\t\t\t\t\t\t\ttrue;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tlocals->NotEnoughDSCUnits[i] = false;\n\t\tmode_lib->vba.TotalDSCUnitsRequired = 0.0;\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\tif (locals->RequiresDSC[i][k] == true) {\n\t\t\t\tif (locals->ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_2to1) {\n\t\t\t\t\tmode_lib->vba.TotalDSCUnitsRequired =\n\t\t\t\t\t\t\tmode_lib->vba.TotalDSCUnitsRequired + 2.0;\n\t\t\t\t} else {\n\t\t\t\t\tmode_lib->vba.TotalDSCUnitsRequired =\n\t\t\t\t\t\t\tmode_lib->vba.TotalDSCUnitsRequired + 1.0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (mode_lib->vba.TotalDSCUnitsRequired > mode_lib->vba.NumberOfDSC) {\n\t\t\tlocals->NotEnoughDSCUnits[i] = true;\n\t\t}\n\t}\n\t \n\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\tif (mode_lib->vba.BlendingAndTiming[k] != k) {\n\t\t\t\tmode_lib->vba.slices = 0;\n\t\t\t} else if (locals->RequiresDSC[i][k] == 0\n\t\t\t\t\t|| locals->RequiresDSC[i][k] == false) {\n\t\t\t\tmode_lib->vba.slices = 0;\n\t\t\t} else if (mode_lib->vba.PixelClockBackEnd[k] > 3200.0) {\n\t\t\t\tmode_lib->vba.slices = dml_ceil(\n\t\t\t\t\t\tmode_lib->vba.PixelClockBackEnd[k] / 400.0,\n\t\t\t\t\t\t4.0);\n\t\t\t} else if (mode_lib->vba.PixelClockBackEnd[k] > 1360.0) {\n\t\t\t\tmode_lib->vba.slices = 8.0;\n\t\t\t} else if (mode_lib->vba.PixelClockBackEnd[k] > 680.0) {\n\t\t\t\tmode_lib->vba.slices = 4.0;\n\t\t\t} else if (mode_lib->vba.PixelClockBackEnd[k] > 340.0) {\n\t\t\t\tmode_lib->vba.slices = 2.0;\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.slices = 1.0;\n\t\t\t}\n\t\t\tif (locals->OutputBppPerState[i][k] == BPP_BLENDED_PIPE\n\t\t\t\t\t|| locals->OutputBppPerState[i][k] == BPP_INVALID) {\n\t\t\t\tmode_lib->vba.bpp = 0.0;\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.bpp = locals->OutputBppPerState[i][k];\n\t\t\t}\n\t\t\tif (locals->RequiresDSC[i][k] == true && mode_lib->vba.bpp != 0.0) {\n\t\t\t\tif (locals->ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_disabled) {\n\t\t\t\t\tlocals->DSCDelayPerState[i][k] =\n\t\t\t\t\t\t\tdscceComputeDelay(\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.bpp,\n\t\t\t\t\t\t\t\t\tdml_ceil(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HActive[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.slices,\n\t\t\t\t\t\t\t\t\t\t\t1.0),\n\t\t\t\t\t\t\t\t\tmode_lib->vba.slices,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k])\n\t\t\t\t\t\t\t\t\t+ dscComputeDelay(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k]);\n\t\t\t\t} else {\n\t\t\t\t\tlocals->DSCDelayPerState[i][k] =\n\t\t\t\t\t\t\t2.0 * (dscceComputeDelay(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.DSCInputBitPerComponent[k],\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.bpp,\n\t\t\t\t\t\t\t\t\t\t\tdml_ceil(mode_lib->vba.HActive[k] / mode_lib->vba.slices, 1.0),\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.slices / 2,\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k])\n\t\t\t\t\t\t\t\t\t+ dscComputeDelay(mode_lib->vba.OutputFormat[k]));\n\t\t\t\t}\n\t\t\t\tlocals->DSCDelayPerState[i][k] =\n\t\t\t\t\t\tlocals->DSCDelayPerState[i][k] * mode_lib->vba.PixelClock[k] / mode_lib->vba.PixelClockBackEnd[k];\n\t\t\t} else {\n\t\t\t\tlocals->DSCDelayPerState[i][k] = 0.0;\n\t\t\t}\n\t\t}\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\tfor (m = 0; m <= mode_lib->vba.NumberOfActivePlanes - 1; m++) {\n\t\t\t\tfor (j = 0; j <= mode_lib->vba.NumberOfActivePlanes - 1; j++) {\n\t\t\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == m && locals->RequiresDSC[i][m] == true)\n\t\t\t\t\t\tlocals->DSCDelayPerState[i][k] = locals->DSCDelayPerState[i][m];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\tif (locals->ODMCombineEnablePerState[i][k] == dm_odm_combine_mode_2to1)\n\t\t\t\t\tlocals->SwathWidthYPerState[i][j][k] = dml_min(locals->SwathWidthYSingleDPP[k], dml_round(locals->HActive[k] / 2 * locals->HRatio[k]));\n\t\t\t\telse\n\t\t\t\t\tlocals->SwathWidthYPerState[i][j][k] = locals->SwathWidthYSingleDPP[k] / locals->NoOfDPP[i][j][k];\n\t\t\t\tlocals->SwathWidthGranularityY = 256  / dml_ceil(locals->BytePerPixelInDETY[k], 1) / locals->MaxSwathHeightY[k];\n\t\t\t\tlocals->RoundedUpMaxSwathSizeBytesY = (dml_ceil(locals->SwathWidthYPerState[i][j][k] - 1, locals->SwathWidthGranularityY)\n\t\t\t\t\t\t+ locals->SwathWidthGranularityY) * locals->BytePerPixelInDETY[k] * locals->MaxSwathHeightY[k];\n\t\t\t\tif (locals->SourcePixelFormat[k] == dm_420_10) {\n\t\t\t\t\tlocals->RoundedUpMaxSwathSizeBytesY = dml_ceil(locals->RoundedUpMaxSwathSizeBytesY, 256) + 256;\n\t\t\t\t}\n\t\t\t\tif (locals->MaxSwathHeightC[k] > 0) {\n\t\t\t\t\tlocals->SwathWidthGranularityC = 256 / dml_ceil(locals->BytePerPixelInDETC[k], 2) / locals->MaxSwathHeightC[k];\n\n\t\t\t\t\tlocals->RoundedUpMaxSwathSizeBytesC = (dml_ceil(locals->SwathWidthYPerState[i][j][k] / 2 - 1, locals->SwathWidthGranularityC)\n\t\t\t\t\t+ locals->SwathWidthGranularityC) * locals->BytePerPixelInDETC[k] * locals->MaxSwathHeightC[k];\n\t\t\t\t}\n\t\t\t\tif (locals->SourcePixelFormat[k] == dm_420_10) {\n\t\t\t\t\tlocals->RoundedUpMaxSwathSizeBytesC = dml_ceil(locals->RoundedUpMaxSwathSizeBytesC, 256)  + 256;\n\t\t\t\t} else {\n\t\t\t\t\tlocals->RoundedUpMaxSwathSizeBytesC = 0;\n\t\t\t\t}\n\n\t\t\t\tif (locals->RoundedUpMaxSwathSizeBytesY + locals->RoundedUpMaxSwathSizeBytesC <= locals->DETBufferSizeInKByte[0] * 1024 / 2) {\n\t\t\t\t\tlocals->SwathHeightYPerState[i][j][k] = locals->MaxSwathHeightY[k];\n\t\t\t\t\tlocals->SwathHeightCPerState[i][j][k] = locals->MaxSwathHeightC[k];\n\t\t\t\t} else {\n\t\t\t\t\tlocals->SwathHeightYPerState[i][j][k] = locals->MinSwathHeightY[k];\n\t\t\t\t\tlocals->SwathHeightCPerState[i][j][k] = locals->MinSwathHeightC[k];\n\t\t\t\t}\n\n\t\t\t\tif (locals->BytePerPixelInDETC[k] == 0) {\n\t\t\t\t\tlocals->LinesInDETLuma = locals->DETBufferSizeInKByte[0] * 1024 / locals->BytePerPixelInDETY[k] / locals->SwathWidthYPerState[i][j][k];\n\t\t\t\t\tlocals->LinesInDETChroma = 0;\n\t\t\t\t} else if (locals->SwathHeightYPerState[i][j][k] <= locals->SwathHeightCPerState[i][j][k]) {\n\t\t\t\t\tlocals->LinesInDETLuma = locals->DETBufferSizeInKByte[0] * 1024 / 2 / locals->BytePerPixelInDETY[k] /\n\t\t\t\t\t\t\tlocals->SwathWidthYPerState[i][j][k];\n\t\t\t\t\tlocals->LinesInDETChroma = locals->DETBufferSizeInKByte[0] * 1024 / 2 / locals->BytePerPixelInDETC[k] / (locals->SwathWidthYPerState[i][j][k] / 2);\n\t\t\t\t} else {\n\t\t\t\t\tlocals->LinesInDETLuma = locals->DETBufferSizeInKByte[0] * 1024 * 2 / 3 / locals->BytePerPixelInDETY[k] / locals->SwathWidthYPerState[i][j][k];\n\t\t\t\t\tlocals->LinesInDETChroma = locals->DETBufferSizeInKByte[0] * 1024 / 3 / locals->BytePerPixelInDETY[k] / (locals->SwathWidthYPerState[i][j][k] / 2);\n\t\t\t\t}\n\n\t\t\t\tlocals->EffectiveLBLatencyHidingSourceLinesLuma = dml_min(locals->MaxLineBufferLines,\n\t\t\t\t\tdml_floor(locals->LineBufferSize / locals->LBBitPerPixel[k] / (locals->SwathWidthYPerState[i][j][k]\n\t\t\t\t\t/ dml_max(locals->HRatio[k], 1)), 1)) - (locals->vtaps[k] - 1);\n\n\t\t\t\tlocals->EffectiveLBLatencyHidingSourceLinesChroma =  dml_min(locals->MaxLineBufferLines,\n\t\t\t\t\t\tdml_floor(locals->LineBufferSize / locals->LBBitPerPixel[k]\n\t\t\t\t\t\t/ (locals->SwathWidthYPerState[i][j][k] / 2\n\t\t\t\t\t\t/ dml_max(locals->HRatio[k] / 2, 1)), 1)) - (locals->VTAPsChroma[k] - 1);\n\n\t\t\t\tlocals->EffectiveDETLBLinesLuma = dml_floor(locals->LinesInDETLuma +  dml_min(\n\t\t\t\t\t\tlocals->LinesInDETLuma * locals->RequiredDISPCLK[i][j] * locals->BytePerPixelInDETY[k] *\n\t\t\t\t\t\tlocals->PSCL_FACTOR[k] / locals->ReturnBWPerState[i][0],\n\t\t\t\t\t\tlocals->EffectiveLBLatencyHidingSourceLinesLuma),\n\t\t\t\t\t\tlocals->SwathHeightYPerState[i][j][k]);\n\t\t\t\tif (locals->LinesInDETChroma) {\n\t\t\t\t\tlocals->EffectiveDETLBLinesChroma = dml_floor(locals->LinesInDETChroma +\n\t\t\t\t\t\t    dml_min(locals->LinesInDETChroma * locals->RequiredDISPCLK[i][j] *\n\t\t\t\t\t\t    locals->BytePerPixelInDETC[k] *\n\t\t\t\t\t\t\tlocals->PSCL_FACTOR_CHROMA[k] / locals->ReturnBWPerState[i][0],\n\t\t\t\t\t\t\tlocals->EffectiveLBLatencyHidingSourceLinesChroma),\n\t\t\t\t\t\t\tlocals->SwathHeightCPerState[i][j][k]);\n\t\t\t\t} else {\n\t\t\t\t\tlocals->EffectiveDETLBLinesChroma = 0;\n\t\t\t\t}\n\n\t\t\t\tif (locals->BytePerPixelInDETC[k] == 0) {\n\t\t\t\t\tlocals->UrgentLatencySupportUsPerState[i][j][k] = locals->EffectiveDETLBLinesLuma * (locals->HTotal[k] / locals->PixelClock[k])\n\t\t\t\t\t\t\t/ locals->VRatio[k] - locals->EffectiveDETLBLinesLuma * locals->SwathWidthYPerState[i][j][k] *\n\t\t\t\t\t\t\t\tdml_ceil(locals->BytePerPixelInDETY[k], 1) / (locals->ReturnBWPerState[i][0] / locals->NoOfDPP[i][j][k]);\n\t\t\t\t} else {\n\t\t\t\t\tlocals->UrgentLatencySupportUsPerState[i][j][k] = dml_min(\n\t\t\t\t\t\tlocals->EffectiveDETLBLinesLuma * (locals->HTotal[k] / locals->PixelClock[k])\n\t\t\t\t\t\t/ locals->VRatio[k] - locals->EffectiveDETLBLinesLuma * locals->SwathWidthYPerState[i][j][k] *\n\t\t\t\t\t\tdml_ceil(locals->BytePerPixelInDETY[k], 1) / (locals->ReturnBWPerState[i][0] / locals->NoOfDPP[i][j][k]),\n\t\t\t\t\t\t\tlocals->EffectiveDETLBLinesChroma * (locals->HTotal[k] / locals->PixelClock[k]) / (locals->VRatio[k] / 2) -\n\t\t\t\t\t\t\tlocals->EffectiveDETLBLinesChroma * locals->SwathWidthYPerState[i][j][k] / 2 *\n\t\t\t\t\t\t\tdml_ceil(locals->BytePerPixelInDETC[k], 2) / (locals->ReturnBWPerState[i][0] / locals->NoOfDPP[i][j][k]));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (i = 0; i <= locals->soc.num_states; i++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tlocals->UrgentLatencySupport[i][j] = true;\n\t\t\tfor (k = 0; k < locals->NumberOfActivePlanes; k++) {\n\t\t\t\tif (locals->UrgentLatencySupportUsPerState[i][j][k] < locals->UrgentLatency)\n\t\t\t\t\tlocals->UrgentLatencySupport[i][j] = false;\n\t\t\t}\n\t\t}\n\t}\n\n\n\t \n\tfor (i = 0; i <= locals->soc.num_states; i++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tlocals->TotalNumberOfDCCActiveDPP[i][j] = 0;\n\t\t\tfor (k = 0; k < locals->NumberOfActivePlanes; k++) {\n\t\t\t\tif (locals->DCCEnable[k] == true) {\n\t\t\t\t\tlocals->TotalNumberOfDCCActiveDPP[i][j] =\n\t\t\t\t\t\tlocals->TotalNumberOfDCCActiveDPP[i][j] + locals->NoOfDPP[i][j][k];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tCalculateMinAndMaxPrefetchMode(locals->AllowDRAMSelfRefreshOrDRAMClockChangeInVblank, &locals->MinPrefetchMode, &locals->MaxPrefetchMode);\n\n\tfor (i = 0; i <= locals->soc.num_states; i++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tfor (k = 0; k < locals->NumberOfActivePlanes; k++) {\n\t\t\t\tlocals->NoOfDPPThisState[k] = locals->NoOfDPP[i][j][k];\n\t\t\t\tlocals->RequiredDPPCLKThisState[k] = locals->RequiredDPPCLK[i][j][k];\n\t\t\t\tlocals->SwathHeightYThisState[k] = locals->SwathHeightYPerState[i][j][k];\n\t\t\t\tlocals->SwathHeightCThisState[k] = locals->SwathHeightCPerState[i][j][k];\n\t\t\t\tlocals->SwathWidthYThisState[k] = locals->SwathWidthYPerState[i][j][k];\n\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0] = dml_max(\n\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0],\n\t\t\t\t\t\tmode_lib->vba.PixelClock[k] / 16.0);\n\t\t\t\tif (mode_lib->vba.BytePerPixelInDETC[k] == 0.0) {\n\t\t\t\t\tif (mode_lib->vba.VRatio[k] <= 1.0) {\n\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0] =\n\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0],\n\t\t\t\t\t\t\t\t\t\t1.1\n\t\t\t\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETY[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t\t\t\t\t\t\t/ 64.0\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.NoOfDPP[i][j][k]);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0] =\n\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0],\n\t\t\t\t\t\t\t\t\t\t1.1\n\t\t\t\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETY[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t\t\t\t\t\t\t/ 64.0\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.PSCL_FACTOR[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.RequiredDPPCLK[i][j][k]);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (mode_lib->vba.VRatio[k] <= 1.0) {\n\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0] =\n\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0],\n\t\t\t\t\t\t\t\t\t\t1.1\n\t\t\t\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETY[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t\t\t\t\t\t\t/ 32.0\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.NoOfDPP[i][j][k]);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0] =\n\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0],\n\t\t\t\t\t\t\t\t\t\t1.1\n\t\t\t\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETY[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t\t\t\t\t\t\t/ 32.0\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.PSCL_FACTOR[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.RequiredDPPCLK[i][j][k]);\n\t\t\t\t\t}\n\t\t\t\t\tif (mode_lib->vba.VRatio[k] / 2.0 <= 1.0) {\n\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0] =\n\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0],\n\t\t\t\t\t\t\t\t\t\t1.1\n\t\t\t\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETC[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t2.0)\n\t\t\t\t\t\t\t\t\t\t\t\t/ 32.0\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.HRatio[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ 2.0\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.PixelClock[k]\n\t\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.NoOfDPP[i][j][k]);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0] =\n\t\t\t\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0],\n\t\t\t\t\t\t\t\t\t\t1.1\n\t\t\t\t\t\t\t\t\t\t\t\t* dml_ceil(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETC[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t2.0)\n\t\t\t\t\t\t\t\t\t\t\t\t/ 32.0\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.PSCL_FACTOR_CHROMA[k]\n\t\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.RequiredDPPCLK[i][j][k]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrameY = CalculateVMAndRowBytes(\n\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\tmode_lib->vba.Read256BlockHeightY[k],\n\t\t\t\t\t\tmode_lib->vba.Read256BlockWidthY[k],\n\t\t\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\t\t\tmode_lib->vba.SurfaceTiling[k],\n\t\t\t\t\t\tdml_ceil(mode_lib->vba.BytePerPixelInDETY[k], 1.0),\n\t\t\t\t\t\tmode_lib->vba.SourceScan[k],\n\t\t\t\t\t\tmode_lib->vba.ViewportWidth[k],\n\t\t\t\t\t\tmode_lib->vba.ViewportHeight[k],\n\t\t\t\t\t\tmode_lib->vba.SwathWidthYPerState[i][j][k],\n\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\tmode_lib->vba.VMMPageSize,\n\t\t\t\t\t\tmode_lib->vba.PTEBufferSizeInRequestsLuma,\n\t\t\t\t\t\tmode_lib->vba.PDEProcessingBufIn64KBReqs,\n\t\t\t\t\t\tmode_lib->vba.PitchY[k],\n\t\t\t\t\t\tmode_lib->vba.DCCMetaPitchY[k],\n\t\t\t\t\t\t&mode_lib->vba.MacroTileWidthY[k],\n\t\t\t\t\t\t&mode_lib->vba.MetaRowBytesY,\n\t\t\t\t\t\t&mode_lib->vba.DPTEBytesPerRowY,\n\t\t\t\t\t\t&mode_lib->vba.PTEBufferSizeNotExceededY[i][j][k],\n\t\t\t\t\t\t&mode_lib->vba.dpte_row_height[k],\n\t\t\t\t\t\t&mode_lib->vba.meta_row_height[k]);\n\t\t\t\tmode_lib->vba.PrefetchLinesY[0][0][k] = CalculatePrefetchSourceLines(\n\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\tmode_lib->vba.vtaps[k],\n\t\t\t\t\t\tmode_lib->vba.Interlace[k],\n\t\t\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP,\n\t\t\t\t\t\tmode_lib->vba.SwathHeightYPerState[i][j][k],\n\t\t\t\t\t\tmode_lib->vba.ViewportYStartY[k],\n\t\t\t\t\t\t&mode_lib->vba.PrefillY[k],\n\t\t\t\t\t\t&mode_lib->vba.MaxNumSwY[k]);\n\t\t\t\tif ((mode_lib->vba.SourcePixelFormat[k] != dm_444_64\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_32\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_16\n\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_8)) {\n\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrameC = CalculateVMAndRowBytes(\n\t\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\t\tmode_lib->vba.Read256BlockHeightY[k],\n\t\t\t\t\t\t\tmode_lib->vba.Read256BlockWidthY[k],\n\t\t\t\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\t\t\t\tmode_lib->vba.SurfaceTiling[k],\n\t\t\t\t\t\t\tdml_ceil(mode_lib->vba.BytePerPixelInDETC[k], 2.0),\n\t\t\t\t\t\t\tmode_lib->vba.SourceScan[k],\n\t\t\t\t\t\t\tmode_lib->vba.ViewportWidth[k] / 2.0,\n\t\t\t\t\t\t\tmode_lib->vba.ViewportHeight[k] / 2.0,\n\t\t\t\t\t\t\tmode_lib->vba.SwathWidthYPerState[i][j][k] / 2.0,\n\t\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\t\tmode_lib->vba.VMMPageSize,\n\t\t\t\t\t\t\tmode_lib->vba.PTEBufferSizeInRequestsLuma,\n\t\t\t\t\t\t\tmode_lib->vba.PDEProcessingBufIn64KBReqs,\n\t\t\t\t\t\t\tmode_lib->vba.PitchC[k],\n\t\t\t\t\t\t\t0.0,\n\t\t\t\t\t\t\t&mode_lib->vba.MacroTileWidthC[k],\n\t\t\t\t\t\t\t&mode_lib->vba.MetaRowBytesC,\n\t\t\t\t\t\t\t&mode_lib->vba.DPTEBytesPerRowC,\n\t\t\t\t\t\t\t&mode_lib->vba.PTEBufferSizeNotExceededC[i][j][k],\n\t\t\t\t\t\t\t&mode_lib->vba.dpte_row_height_chroma[k],\n\t\t\t\t\t\t\t&mode_lib->vba.meta_row_height_chroma[k]);\n\t\t\t\t\tmode_lib->vba.PrefetchLinesC[0][0][k] = CalculatePrefetchSourceLines(\n\t\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\t\tmode_lib->vba.VRatio[k] / 2.0,\n\t\t\t\t\t\t\tmode_lib->vba.VTAPsChroma[k],\n\t\t\t\t\t\t\tmode_lib->vba.Interlace[k],\n\t\t\t\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP,\n\t\t\t\t\t\t\tmode_lib->vba.SwathHeightCPerState[i][j][k],\n\t\t\t\t\t\t\tmode_lib->vba.ViewportYStartC[k],\n\t\t\t\t\t\t\t&mode_lib->vba.PrefillC[k],\n\t\t\t\t\t\t\t&mode_lib->vba.MaxNumSwC[k]);\n\t\t\t\t} else {\n\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrameC = 0.0;\n\t\t\t\t\tmode_lib->vba.MetaRowBytesC = 0.0;\n\t\t\t\t\tmode_lib->vba.DPTEBytesPerRowC = 0.0;\n\t\t\t\t\tlocals->PrefetchLinesC[0][0][k] = 0.0;\n\t\t\t\t\tlocals->PTEBufferSizeNotExceededC[i][j][k] = true;\n\t\t\t\t\tlocals->PTEBufferSizeInRequestsForLuma = mode_lib->vba.PTEBufferSizeInRequestsLuma + mode_lib->vba.PTEBufferSizeInRequestsChroma;\n\t\t\t\t}\n\t\t\t\tlocals->PDEAndMetaPTEBytesPerFrame[0][0][k] =\n\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrameY + mode_lib->vba.PDEAndMetaPTEBytesPerFrameC;\n\t\t\t\tlocals->MetaRowBytes[0][0][k] = mode_lib->vba.MetaRowBytesY + mode_lib->vba.MetaRowBytesC;\n\t\t\t\tlocals->DPTEBytesPerRow[0][0][k] = mode_lib->vba.DPTEBytesPerRowY + mode_lib->vba.DPTEBytesPerRowC;\n\n\t\t\t\tCalculateActiveRowBandwidth(\n\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\tmode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k],\n\t\t\t\t\t\tmode_lib->vba.MetaRowBytesY,\n\t\t\t\t\t\tmode_lib->vba.MetaRowBytesC,\n\t\t\t\t\t\tmode_lib->vba.meta_row_height[k],\n\t\t\t\t\t\tmode_lib->vba.meta_row_height_chroma[k],\n\t\t\t\t\t\tmode_lib->vba.DPTEBytesPerRowY,\n\t\t\t\t\t\tmode_lib->vba.DPTEBytesPerRowC,\n\t\t\t\t\t\tmode_lib->vba.dpte_row_height[k],\n\t\t\t\t\t\tmode_lib->vba.dpte_row_height_chroma[k],\n\t\t\t\t\t\t&mode_lib->vba.meta_row_bw[k],\n\t\t\t\t\t\t&mode_lib->vba.dpte_row_bw[k],\n\t\t\t\t\t\t&mode_lib->vba.qual_row_bw[k]);\n\t\t\t}\n\t\t\tmode_lib->vba.ExtraLatency =\n\t\t\t\t\tmode_lib->vba.UrgentRoundTripAndOutOfOrderLatencyPerState[i]\n\t\t\t\t\t\t\t+ (mode_lib->vba.TotalNumberOfActiveDPP[i][j]\n\t\t\t\t\t\t\t\t\t* mode_lib->vba.PixelChunkSizeInKByte\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.TotalNumberOfDCCActiveDPP[i][j]\n\t\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.MetaChunkSize)\n\t\t\t\t\t\t\t\t\t* 1024.0\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.ReturnBWPerState[i][0];\n\t\t\tif (mode_lib->vba.GPUVMEnable == true) {\n\t\t\t\tmode_lib->vba.ExtraLatency = mode_lib->vba.ExtraLatency\n\t\t\t\t\t\t+ mode_lib->vba.TotalNumberOfActiveDPP[i][j]\n\t\t\t\t\t\t\t\t* mode_lib->vba.PTEGroupSize\n\t\t\t\t\t\t\t\t/ mode_lib->vba.ReturnBWPerState[i][0];\n\t\t\t}\n\t\t\tmode_lib->vba.TimeCalc = 24.0 / mode_lib->vba.ProjectedDCFCLKDeepSleep[0][0];\n\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\t\t\tif (mode_lib->vba.WritebackEnable[k] == true) {\n\t\t\t\t\t\tlocals->WritebackDelay[i][k] = mode_lib->vba.WritebackLatency\n\t\t\t\t\t\t\t\t+ CalculateWriteBackDelay(\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaHTaps[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaVTaps[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaHTaps[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaVTaps[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[k]) / locals->RequiredDISPCLK[i][j];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlocals->WritebackDelay[i][k] = 0.0;\n\t\t\t\t\t}\n\t\t\t\t\tfor (m = 0; m <= mode_lib->vba.NumberOfActivePlanes - 1; m++) {\n\t\t\t\t\t\tif (mode_lib->vba.BlendingAndTiming[m] == k\n\t\t\t\t\t\t\t\t&& mode_lib->vba.WritebackEnable[m]\n\t\t\t\t\t\t\t\t\t\t== true) {\n\t\t\t\t\t\t\tlocals->WritebackDelay[i][k] = dml_max(locals->WritebackDelay[i][k],\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLatency + CalculateWriteBackDelay(\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackPixelFormat[m],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackHRatio[m],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackVRatio[m],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaHTaps[m],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackLumaVTaps[m],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaHTaps[m],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackChromaVTaps[m],\n\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.WritebackDestinationWidth[m]) / locals->RequiredDISPCLK[i][j]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\tfor (m = 0; m <= mode_lib->vba.NumberOfActivePlanes - 1; m++) {\n\t\t\t\t\tif (mode_lib->vba.BlendingAndTiming[k] == m) {\n\t\t\t\t\t\tlocals->WritebackDelay[i][k] = locals->WritebackDelay[i][m];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\tfor (m = 0; m < locals->NumberOfCursors[k]; m++)\n\t\t\t\t\tlocals->cursor_bw[k] = locals->NumberOfCursors[k] * locals->CursorWidth[k][m] * locals->CursorBPP[k][m]\n\t\t\t\t\t\t/ 8 / (locals->HTotal[k] / locals->PixelClock[k]) * locals->VRatio[k];\n\t\t\t}\n\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\tlocals->MaximumVStartup[0][0][k] = mode_lib->vba.VTotal[k] - mode_lib->vba.VActive[k]\n\t\t\t\t\t- dml_max(1.0, dml_ceil(locals->WritebackDelay[i][k] / (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k]), 1.0));\n\t\t\t}\n\n\t\t\tmode_lib->vba.NextPrefetchMode = mode_lib->vba.MinPrefetchMode;\n\t\t\tdo {\n\t\t\t\tmode_lib->vba.PrefetchMode[i][j] = mode_lib->vba.NextPrefetchMode;\n\t\t\t\tmode_lib->vba.NextPrefetchMode = mode_lib->vba.NextPrefetchMode + 1;\n\n\t\t\t\tmode_lib->vba.TWait = CalculateTWait(\n\t\t\t\t\t\tmode_lib->vba.PrefetchMode[i][j],\n\t\t\t\t\t\tmode_lib->vba.DRAMClockChangeLatency,\n\t\t\t\t\t\tmode_lib->vba.UrgentLatency,\n\t\t\t\t\t\tmode_lib->vba.SREnterPlusExitTime);\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\n\t\t\t\t\tif (mode_lib->vba.XFCEnabled[k] == true) {\n\t\t\t\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipDelay =\n\t\t\t\t\t\t\t\tCalculateRemoteSurfaceFlipDelay(\n\t\t\t\t\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\t\t\t\t\tlocals->SwathWidthYPerState[i][j][k],\n\t\t\t\t\t\t\t\t\t\tdml_ceil(locals->BytePerPixelInDETY[k], 1.0),\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.XFCTSlvVupdateOffset,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.XFCTSlvVupdateWidth,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.XFCTSlvVreadyOffset,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.XFCXBUFLatencyTolerance,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.XFCFillBWOverhead,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.XFCSlvChunkSize,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.XFCBusTransportTime,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.TimeCalc,\n\t\t\t\t\t\t\t\t\t\tmode_lib->vba.TWait,\n\t\t\t\t\t\t\t\t\t\t&mode_lib->vba.SrcActiveDrainRate,\n\t\t\t\t\t\t\t\t\t\t&mode_lib->vba.TInitXFill,\n\t\t\t\t\t\t\t\t\t\t&mode_lib->vba.TslvChk);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipDelay = 0.0;\n\t\t\t\t\t}\n\t\t\t\t\tmode_lib->vba.IsErrorResult[i][j][k] =\n\t\t\t\t\t\t\tCalculatePrefetchSchedule(\n\t\t\t\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.RequiredDPPCLK[i][j][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.RequiredDISPCLK[i][j],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.ProjectedDCFCLKDeepSleep[0][0],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DSCDelayPerState[i][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.NoOfDPP[i][j][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.ScalerEnabled[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.NumberOfCursors[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelaySubtotal,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelaySCL,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelaySCLLBOnly,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelayCNVCFormater,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DPPCLKDelayCNVCCursor,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DISPCLKDelaySubtotal,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.SwathWidthYPerState[i][j][k]\n\t\t\t\t\t\t\t\t\t\t\t/ mode_lib->vba.HRatio[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.OutputFormat[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.VTotal[k]\n\t\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.VActive[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.HTotal[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.MaxInterDCNTileRepeaters,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.MaximumVStartup[0][0][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DynamicMetadataEnable[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DynamicMetadataLinesBeforeActiveRequired[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DynamicMetadataTransmittedBytes[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.UrgentLatencyPixelDataOnly,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.ExtraLatency,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.TimeCalc,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrame[0][0][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.MetaRowBytes[0][0][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DPTEBytesPerRow[0][0][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PrefetchLinesY[0][0][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.SwathWidthYPerState[i][j][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETY[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PrefillY[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.MaxNumSwY[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PrefetchLinesC[0][0][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.BytePerPixelInDETC[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.PrefillC[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.MaxNumSwC[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.SwathHeightYPerState[i][j][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.SwathHeightCPerState[i][j][k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.TWait,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.XFCEnabled[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.XFCRemoteSurfaceFlipDelay,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.Interlace[k],\n\t\t\t\t\t\t\t\t\tmode_lib->vba.ProgressiveToInterlaceUnitInOPP,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DSTXAfterScaler,\n\t\t\t\t\t\t\t\t\tmode_lib->vba.DSTYAfterScaler,\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.LineTimesForPrefetch[k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.PrefetchBW[k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.LinesForMetaPTE[k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.LinesForMetaAndDPTERow[k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.VRatioPreY[i][j][k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.VRatioPreC[i][j][k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.RequiredPrefetchPixelDataBWLuma[i][j][k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.VStartupRequiredWhenNotEnoughTimeForDynamicMetadata,\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.Tno_bw[k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.VUpdateOffsetPix[k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.VUpdateWidthPix[k],\n\t\t\t\t\t\t\t\t\t&mode_lib->vba.VReadyOffsetPix[k]);\n\t\t\t\t}\n\t\t\t\tmode_lib->vba.MaximumReadBandwidthWithoutPrefetch = 0.0;\n\t\t\t\tmode_lib->vba.MaximumReadBandwidthWithPrefetch = 0.0;\n\t\t\t\tlocals->prefetch_vm_bw_valid = true;\n\t\t\t\tlocals->prefetch_row_bw_valid = true;\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tif (locals->PDEAndMetaPTEBytesPerFrame[0][0][k] == 0)\n\t\t\t\t\t\tlocals->prefetch_vm_bw[k] = 0;\n\t\t\t\t\telse if (locals->LinesForMetaPTE[k] > 0)\n\t\t\t\t\t\tlocals->prefetch_vm_bw[k] = locals->PDEAndMetaPTEBytesPerFrame[0][0][k]\n\t\t\t\t\t\t\t/ (locals->LinesForMetaPTE[k] * locals->HTotal[k] / locals->PixelClock[k]);\n\t\t\t\t\telse {\n\t\t\t\t\t\tlocals->prefetch_vm_bw[k] = 0;\n\t\t\t\t\t\tlocals->prefetch_vm_bw_valid = false;\n\t\t\t\t\t}\n\t\t\t\t\tif (locals->MetaRowBytes[0][0][k] + locals->DPTEBytesPerRow[0][0][k] == 0)\n\t\t\t\t\t\tlocals->prefetch_row_bw[k] = 0;\n\t\t\t\t\telse if (locals->LinesForMetaAndDPTERow[k] > 0)\n\t\t\t\t\t\tlocals->prefetch_row_bw[k] = (locals->MetaRowBytes[0][0][k] + locals->DPTEBytesPerRow[0][0][k])\n\t\t\t\t\t\t\t/ (locals->LinesForMetaAndDPTERow[k] * locals->HTotal[k] / locals->PixelClock[k]);\n\t\t\t\t\telse {\n\t\t\t\t\t\tlocals->prefetch_row_bw[k] = 0;\n\t\t\t\t\t\tlocals->prefetch_row_bw_valid = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tmode_lib->vba.MaximumReadBandwidthWithoutPrefetch = mode_lib->vba.MaximumReadBandwidthWithPrefetch\n\t\t\t\t\t\t\t+ mode_lib->vba.cursor_bw[k] + mode_lib->vba.ReadBandwidth[k] + mode_lib->vba.meta_row_bw[k] + mode_lib->vba.dpte_row_bw[k];\n\t\t\t\t\tmode_lib->vba.MaximumReadBandwidthWithPrefetch =\n\t\t\t\t\t\t\tmode_lib->vba.MaximumReadBandwidthWithPrefetch\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.cursor_bw[k]\n\t\t\t\t\t\t\t\t\t+ dml_max3(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.prefetch_vm_bw[k],\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.prefetch_row_bw[k],\n\t\t\t\t\t\t\t\t\t\t\tdml_max(mode_lib->vba.ReadBandwidth[k],\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixelDataBWLuma[i][j][k])\n\t\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.meta_row_bw[k] + mode_lib->vba.dpte_row_bw[k]);\n\t\t\t\t}\n\t\t\t\tlocals->BandwidthWithoutPrefetchSupported[i][0] = true;\n\t\t\t\tif (mode_lib->vba.MaximumReadBandwidthWithoutPrefetch > locals->ReturnBWPerState[i][0]) {\n\t\t\t\t\tlocals->BandwidthWithoutPrefetchSupported[i][0] = false;\n\t\t\t\t}\n\n\t\t\t\tlocals->PrefetchSupported[i][j] = true;\n\t\t\t\tif (mode_lib->vba.MaximumReadBandwidthWithPrefetch > locals->ReturnBWPerState[i][0]) {\n\t\t\t\t\tlocals->PrefetchSupported[i][j] = false;\n\t\t\t\t}\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tif (locals->LineTimesForPrefetch[k] < 2.0\n\t\t\t\t\t\t\t|| locals->LinesForMetaPTE[k] >= 8.0\n\t\t\t\t\t\t\t|| locals->LinesForMetaAndDPTERow[k] >= 16.0\n\t\t\t\t\t\t\t|| mode_lib->vba.IsErrorResult[i][j][k] == true) {\n\t\t\t\t\t\tlocals->PrefetchSupported[i][j] = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlocals->VRatioInPrefetchSupported[i][j] = true;\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tif (locals->VRatioPreY[i][j][k] > 4.0\n\t\t\t\t\t\t\t|| locals->VRatioPreC[i][j][k] > 4.0\n\t\t\t\t\t\t\t|| mode_lib->vba.IsErrorResult[i][j][k] == true) {\n\t\t\t\t\t\tlocals->VRatioInPrefetchSupported[i][j] = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} while ((locals->PrefetchSupported[i][j] != true || locals->VRatioInPrefetchSupported[i][j] != true)\n\t\t\t\t\t&& mode_lib->vba.NextPrefetchMode < mode_lib->vba.MaxPrefetchMode);\n\n\t\t\tif (mode_lib->vba.PrefetchSupported[i][j] == true\n\t\t\t\t\t&& mode_lib->vba.VRatioInPrefetchSupported[i][j] == true) {\n\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip =\n\t\t\t\t\t\tmode_lib->vba.ReturnBWPerState[i][0];\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip =\n\t\t\t\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip\n\t\t\t\t\t\t\t\t\t- mode_lib->vba.cursor_bw[k]\n\t\t\t\t\t\t\t\t\t- dml_max(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidth[k] + mode_lib->vba.qual_row_bw[k],\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.PrefetchBW[k]);\n\t\t\t\t}\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tmode_lib->vba.ImmediateFlipBytes[k] = 0.0;\n\t\t\t\t\tif ((mode_lib->vba.SourcePixelFormat[k] != dm_420_8\n\t\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_420_10)) {\n\t\t\t\t\t\tmode_lib->vba.ImmediateFlipBytes[k] =\n\t\t\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrame[0][0][k]\n\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.MetaRowBytes[0][0][k]\n\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.DPTEBytesPerRow[0][0][k];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tmode_lib->vba.TotImmediateFlipBytes = 0.0;\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tif ((mode_lib->vba.SourcePixelFormat[k] != dm_420_8\n\t\t\t\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_420_10)) {\n\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes =\n\t\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes\n\t\t\t\t\t\t\t\t\t\t+ mode_lib->vba.ImmediateFlipBytes[k];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tCalculateFlipSchedule(\n\t\t\t\t\t\t\tmode_lib,\n\t\t\t\t\t\t\tmode_lib->vba.ExtraLatency,\n\t\t\t\t\t\t\tmode_lib->vba.UrgentLatencyPixelDataOnly,\n\t\t\t\t\t\t\tmode_lib->vba.GPUVMMaxPageTableLevels,\n\t\t\t\t\t\t\tmode_lib->vba.GPUVMEnable,\n\t\t\t\t\t\t\tmode_lib->vba.BandwidthAvailableForImmediateFlip,\n\t\t\t\t\t\t\tmode_lib->vba.TotImmediateFlipBytes,\n\t\t\t\t\t\t\tmode_lib->vba.SourcePixelFormat[k],\n\t\t\t\t\t\t\tmode_lib->vba.ImmediateFlipBytes[k],\n\t\t\t\t\t\t\tmode_lib->vba.HTotal[k]\n\t\t\t\t\t\t\t\t\t/ mode_lib->vba.PixelClock[k],\n\t\t\t\t\t\t\tmode_lib->vba.VRatio[k],\n\t\t\t\t\t\t\tmode_lib->vba.Tno_bw[k],\n\t\t\t\t\t\t\tmode_lib->vba.PDEAndMetaPTEBytesPerFrame[0][0][k],\n\t\t\t\t\t\t\tmode_lib->vba.MetaRowBytes[0][0][k],\n\t\t\t\t\t\t\tmode_lib->vba.DPTEBytesPerRow[0][0][k],\n\t\t\t\t\t\t\tmode_lib->vba.DCCEnable[k],\n\t\t\t\t\t\t\tmode_lib->vba.dpte_row_height[k],\n\t\t\t\t\t\t\tmode_lib->vba.meta_row_height[k],\n\t\t\t\t\t\t\tmode_lib->vba.qual_row_bw[k],\n\t\t\t\t\t\t\t&mode_lib->vba.DestinationLinesToRequestVMInImmediateFlip[k],\n\t\t\t\t\t\t\t&mode_lib->vba.DestinationLinesToRequestRowInImmediateFlip[k],\n\t\t\t\t\t\t\t&mode_lib->vba.final_flip_bw[k],\n\t\t\t\t\t\t\t&mode_lib->vba.ImmediateFlipSupportedForPipe[k]);\n\t\t\t\t}\n\t\t\t\tmode_lib->vba.total_dcn_read_bw_with_flip = 0.0;\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tmode_lib->vba.total_dcn_read_bw_with_flip =\n\t\t\t\t\t\t\tmode_lib->vba.total_dcn_read_bw_with_flip\n\t\t\t\t\t\t\t\t\t+ mode_lib->vba.cursor_bw[k]\n\t\t\t\t\t\t\t\t\t+ dml_max3(\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.prefetch_vm_bw[k],\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.prefetch_row_bw[k],\n\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.final_flip_bw[k]\n\t\t\t\t\t\t\t\t\t\t\t\t\t+ dml_max(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.ReadBandwidth[k],\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tmode_lib->vba.RequiredPrefetchPixelDataBWLuma[i][j][k]));\n\t\t\t\t}\n\t\t\t\tmode_lib->vba.ImmediateFlipSupportedForState[i][j] = true;\n\t\t\t\tif (mode_lib->vba.total_dcn_read_bw_with_flip\n\t\t\t\t\t\t> mode_lib->vba.ReturnBWPerState[i][0]) {\n\t\t\t\t\tmode_lib->vba.ImmediateFlipSupportedForState[i][j] = false;\n\t\t\t\t}\n\t\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\t\tif (mode_lib->vba.ImmediateFlipSupportedForPipe[k] == false) {\n\t\t\t\t\t\tmode_lib->vba.ImmediateFlipSupportedForState[i][j] = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tmode_lib->vba.ImmediateFlipSupportedForState[i][j] = false;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tmode_lib->vba.MaxTotalVActiveRDBandwidth = 0;\n\tfor (k = 0; k < mode_lib->vba.NumberOfActivePlanes; k++)\n\t\tmode_lib->vba.MaxTotalVActiveRDBandwidth = mode_lib->vba.MaxTotalVActiveRDBandwidth + mode_lib->vba.ReadBandwidth[k];\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tmode_lib->vba.MaxTotalVerticalActiveAvailableBandwidth[i][0] = dml_min(mode_lib->vba.ReturnBusWidth *\n\t\t\t\tmode_lib->vba.DCFCLKPerState[i], mode_lib->vba.FabricAndDRAMBandwidthPerState[i] * 1000) *\n\t\t\t\tmode_lib->vba.MaxAveragePercentOfIdealDRAMBWDisplayCanUseInNormalSystemOperation / 100;\n\t\tif (mode_lib->vba.MaxTotalVActiveRDBandwidth <= mode_lib->vba.MaxTotalVerticalActiveAvailableBandwidth[i][0])\n\t\t\tmode_lib->vba.TotalVerticalActiveBandwidthSupport[i][0] = true;\n\t\telse\n\t\t\tmode_lib->vba.TotalVerticalActiveBandwidthSupport[i][0] = false;\n\t}\n\n\t \n\n\tfor (i = 0; i <= mode_lib->vba.soc.num_states; i++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tlocals->PTEBufferSizeNotExceeded[i][j] = true;\n\t\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\t\tif (locals->PTEBufferSizeNotExceededY[i][j][k] == false\n\t\t\t\t\t\t|| locals->PTEBufferSizeNotExceededC[i][j][k] == false) {\n\t\t\t\t\tlocals->PTEBufferSizeNotExceeded[i][j] = false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\tmode_lib->vba.CursorSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tif (mode_lib->vba.CursorWidth[k][j] > 0.0) {\n\t\t\t\tif (dml_floor(\n\t\t\t\t\t\tdml_floor(\n\t\t\t\t\t\t\t\tmode_lib->vba.CursorBufferSize\n\t\t\t\t\t\t\t\t\t\t- mode_lib->vba.CursorChunkSize,\n\t\t\t\t\t\t\t\tmode_lib->vba.CursorChunkSize) * 1024.0\n\t\t\t\t\t\t\t\t/ (mode_lib->vba.CursorWidth[k][j]\n\t\t\t\t\t\t\t\t\t\t* mode_lib->vba.CursorBPP[k][j]\n\t\t\t\t\t\t\t\t\t\t/ 8.0),\n\t\t\t\t\t\t1.0)\n\t\t\t\t\t\t* (mode_lib->vba.HTotal[k] / mode_lib->vba.PixelClock[k])\n\t\t\t\t\t\t/ mode_lib->vba.VRatio[k] < mode_lib->vba.UrgentLatencyPixelDataOnly\n\t\t\t\t\t\t|| (mode_lib->vba.CursorBPP[k][j] == 64.0\n\t\t\t\t\t\t\t\t&& mode_lib->vba.Cursor64BppSupport == false)) {\n\t\t\t\t\tmode_lib->vba.CursorSupport = false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t \n\n\tmode_lib->vba.PitchSupport = true;\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tlocals->AlignedYPitch[k] = dml_ceil(\n\t\t\t\tdml_max(mode_lib->vba.PitchY[k], mode_lib->vba.ViewportWidth[k]),\n\t\t\t\tlocals->MacroTileWidthY[k]);\n\t\tif (locals->AlignedYPitch[k] > mode_lib->vba.PitchY[k]) {\n\t\t\tmode_lib->vba.PitchSupport = false;\n\t\t}\n\t\tif (mode_lib->vba.DCCEnable[k] == true) {\n\t\t\tlocals->AlignedDCCMetaPitch[k] = dml_ceil(\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tmode_lib->vba.DCCMetaPitchY[k],\n\t\t\t\t\t\t\tmode_lib->vba.ViewportWidth[k]),\n\t\t\t\t\t64.0 * locals->Read256BlockWidthY[k]);\n\t\t} else {\n\t\t\tlocals->AlignedDCCMetaPitch[k] = mode_lib->vba.DCCMetaPitchY[k];\n\t\t}\n\t\tif (locals->AlignedDCCMetaPitch[k] > mode_lib->vba.DCCMetaPitchY[k]) {\n\t\t\tmode_lib->vba.PitchSupport = false;\n\t\t}\n\t\tif (mode_lib->vba.SourcePixelFormat[k] != dm_444_64\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_32\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_444_16\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_16\n\t\t\t\t&& mode_lib->vba.SourcePixelFormat[k] != dm_mono_8) {\n\t\t\tlocals->AlignedCPitch[k] = dml_ceil(\n\t\t\t\t\tdml_max(\n\t\t\t\t\t\t\tmode_lib->vba.PitchC[k],\n\t\t\t\t\t\t\tmode_lib->vba.ViewportWidth[k] / 2.0),\n\t\t\t\t\tlocals->MacroTileWidthC[k]);\n\t\t} else {\n\t\t\tlocals->AlignedCPitch[k] = mode_lib->vba.PitchC[k];\n\t\t}\n\t\tif (locals->AlignedCPitch[k] > mode_lib->vba.PitchC[k]) {\n\t\t\tmode_lib->vba.PitchSupport = false;\n\t\t}\n\t}\n\t \n\n\tfor (i = mode_lib->vba.soc.num_states; i >= 0; i--) {\n\t\tfor (j = 0; j < 2; j++) {\n\t\t\tenum dm_validation_status status = DML_VALIDATION_OK;\n\n\t\t\tif (mode_lib->vba.ScaleRatioAndTapsSupport != true) {\n\t\t\t\tstatus = DML_FAIL_SCALE_RATIO_TAP;\n\t\t\t} else if (mode_lib->vba.SourceFormatPixelAndScanSupport != true) {\n\t\t\t\tstatus = DML_FAIL_SOURCE_PIXEL_FORMAT;\n\t\t\t} else if (locals->ViewportSizeSupport[i][0] != true) {\n\t\t\t\tstatus = DML_FAIL_VIEWPORT_SIZE;\n\t\t\t} else if (locals->DIOSupport[i] != true) {\n\t\t\t\tstatus = DML_FAIL_DIO_SUPPORT;\n\t\t\t} else if (locals->NotEnoughDSCUnits[i] != false) {\n\t\t\t\tstatus = DML_FAIL_NOT_ENOUGH_DSC;\n\t\t\t} else if (locals->DSCCLKRequiredMoreThanSupported[i] != false) {\n\t\t\t\tstatus = DML_FAIL_DSC_CLK_REQUIRED;\n\t\t\t} else if (locals->UrgentLatencySupport[i][j] != true) {\n\t\t\t\tstatus = DML_FAIL_URGENT_LATENCY;\n\t\t\t} else if (locals->ROBSupport[i][0] != true) {\n\t\t\t\tstatus = DML_FAIL_REORDERING_BUFFER;\n\t\t\t} else if (locals->DISPCLK_DPPCLK_Support[i][j] != true) {\n\t\t\t\tstatus = DML_FAIL_DISPCLK_DPPCLK;\n\t\t\t} else if (locals->TotalAvailablePipesSupport[i][j] != true) {\n\t\t\t\tstatus = DML_FAIL_TOTAL_AVAILABLE_PIPES;\n\t\t\t} else if (mode_lib->vba.NumberOfOTGSupport != true) {\n\t\t\t\tstatus = DML_FAIL_NUM_OTG;\n\t\t\t} else if (mode_lib->vba.WritebackModeSupport != true) {\n\t\t\t\tstatus = DML_FAIL_WRITEBACK_MODE;\n\t\t\t} else if (mode_lib->vba.WritebackLatencySupport != true) {\n\t\t\t\tstatus = DML_FAIL_WRITEBACK_LATENCY;\n\t\t\t} else if (mode_lib->vba.WritebackScaleRatioAndTapsSupport != true) {\n\t\t\t\tstatus = DML_FAIL_WRITEBACK_SCALE_RATIO_TAP;\n\t\t\t} else if (mode_lib->vba.CursorSupport != true) {\n\t\t\t\tstatus = DML_FAIL_CURSOR_SUPPORT;\n\t\t\t} else if (mode_lib->vba.PitchSupport != true) {\n\t\t\t\tstatus = DML_FAIL_PITCH_SUPPORT;\n\t\t\t} else if (locals->PrefetchSupported[i][j] != true) {\n\t\t\t\tstatus = DML_FAIL_PREFETCH_SUPPORT;\n\t\t\t} else if (locals->TotalVerticalActiveBandwidthSupport[i][0] != true) {\n\t\t\t\tstatus = DML_FAIL_TOTAL_V_ACTIVE_BW;\n\t\t\t} else if (locals->VRatioInPrefetchSupported[i][j] != true) {\n\t\t\t\tstatus = DML_FAIL_V_RATIO_PREFETCH;\n\t\t\t} else if (locals->PTEBufferSizeNotExceeded[i][j] != true) {\n\t\t\t\tstatus = DML_FAIL_PTE_BUFFER_SIZE;\n\t\t\t} else if (mode_lib->vba.NonsupportedDSCInputBPC != false) {\n\t\t\t\tstatus = DML_FAIL_DSC_INPUT_BPC;\n\t\t\t}\n\n\t\t\tif (status == DML_VALIDATION_OK) {\n\t\t\t\tlocals->ModeSupport[i][j] = true;\n\t\t\t} else {\n\t\t\t\tlocals->ModeSupport[i][j] = false;\n\t\t\t}\n\t\t\tlocals->ValidationStatus[i] = status;\n\t\t}\n\t}\n\t{\n\t\tunsigned int MaximumMPCCombine = 0;\n\t\tmode_lib->vba.VoltageLevel = mode_lib->vba.soc.num_states + 1;\n\t\tfor (i = mode_lib->vba.VoltageOverrideLevel; i <= mode_lib->vba.soc.num_states; i++) {\n\t\t\tif (locals->ModeSupport[i][0] == true || locals->ModeSupport[i][1] == true) {\n\t\t\t\tmode_lib->vba.VoltageLevel = i;\n\t\t\t\tif (locals->ModeSupport[i][1] == true && (locals->ModeSupport[i][0] == false\n\t\t\t\t\t\t|| mode_lib->vba.WhenToDoMPCCombine == dm_mpc_always_when_possible)) {\n\t\t\t\t\tMaximumMPCCombine = 1;\n\t\t\t\t} else {\n\t\t\t\t\tMaximumMPCCombine = 0;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tmode_lib->vba.ImmediateFlipSupport =\n\t\t\tlocals->ImmediateFlipSupportedForState[mode_lib->vba.VoltageLevel][MaximumMPCCombine];\n\t\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\t\tmode_lib->vba.DPPPerPlane[k] = locals->NoOfDPP[mode_lib->vba.VoltageLevel][MaximumMPCCombine][k];\n\t\t\tlocals->DPPCLK[k] = locals->RequiredDPPCLK[mode_lib->vba.VoltageLevel][MaximumMPCCombine][k];\n\t\t}\n\t\tmode_lib->vba.DISPCLK = locals->RequiredDISPCLK[mode_lib->vba.VoltageLevel][MaximumMPCCombine];\n\t\tmode_lib->vba.maxMpcComb = MaximumMPCCombine;\n\t}\n\tmode_lib->vba.DCFCLK = mode_lib->vba.DCFCLKPerState[mode_lib->vba.VoltageLevel];\n\tmode_lib->vba.DRAMSpeed = mode_lib->vba.DRAMSpeedPerState[mode_lib->vba.VoltageLevel];\n\tmode_lib->vba.FabricClock = mode_lib->vba.FabricClockPerState[mode_lib->vba.VoltageLevel];\n\tmode_lib->vba.SOCCLK = mode_lib->vba.SOCCLKPerState[mode_lib->vba.VoltageLevel];\n\tmode_lib->vba.ReturnBW = locals->ReturnBWPerState[mode_lib->vba.VoltageLevel][0];\n\tmode_lib->vba.FabricAndDRAMBandwidth = locals->FabricAndDRAMBandwidthPerState[mode_lib->vba.VoltageLevel];\n\tfor (k = 0; k <= mode_lib->vba.NumberOfActivePlanes - 1; k++) {\n\t\tif (mode_lib->vba.BlendingAndTiming[k] == k) {\n\t\t\tmode_lib->vba.ODMCombineEnabled[k] =\n\t\t\t\t\tlocals->ODMCombineEnablePerState[mode_lib->vba.VoltageLevel][k];\n\t\t} else {\n\t\t\tmode_lib->vba.ODMCombineEnabled[k] = 0;\n\t\t}\n\t\tmode_lib->vba.DSCEnabled[k] =\n\t\t\t\tlocals->RequiresDSC[mode_lib->vba.VoltageLevel][k];\n\t\tmode_lib->vba.OutputBpp[k] =\n\t\t\t\tlocals->OutputBppPerState[mode_lib->vba.VoltageLevel][k];\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}