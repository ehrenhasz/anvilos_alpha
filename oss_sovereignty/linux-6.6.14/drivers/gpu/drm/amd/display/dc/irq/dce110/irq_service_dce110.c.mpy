{
  "module_name": "irq_service_dce110.c",
  "hash_id": "5f546b752e4e134d513e198fcfe124696e1c030cf5cfc7ff6699f16de771fc7a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/irq/dce110/irq_service_dce110.c",
  "human_readable_source": " \n\n#include \"dm_services.h\"\n\n#include \"include/logger_interface.h\"\n\n#include \"irq_service_dce110.h\"\n\n#include \"dce/dce_11_0_d.h\"\n#include \"dce/dce_11_0_sh_mask.h\"\n\n#include \"ivsrcid/ivsrcid_vislands30.h\"\n\n#include \"dc.h\"\n#include \"core_types.h\"\n#define DC_LOGGER \\\n\tirq_service->ctx->logger\n\nstatic bool hpd_ack(struct irq_service *irq_service,\n\t\t    const struct irq_source_info *info)\n{\n\tuint32_t addr = info->status_reg;\n\tuint32_t value = dm_read_reg(irq_service->ctx, addr);\n\tuint32_t current_status = get_reg_field_value(value,\n\t\t\t\t\t\t      DC_HPD_INT_STATUS,\n\t\t\t\t\t\t      DC_HPD_SENSE_DELAYED);\n\n\tdal_irq_service_ack_generic(irq_service, info);\n\n\tvalue = dm_read_reg(irq_service->ctx, info->enable_reg);\n\n\tset_reg_field_value(value, current_status ? 0 : 1,\n\t\t\t    DC_HPD_INT_CONTROL,\n\t\t\t    DC_HPD_INT_POLARITY);\n\n\tdm_write_reg(irq_service->ctx, info->enable_reg, value);\n\n\treturn true;\n}\n\nstatic const struct irq_source_info_funcs hpd_irq_info_funcs = {\n\t.set = NULL,\n\t.ack = hpd_ack\n};\n\nstatic const struct irq_source_info_funcs hpd_rx_irq_info_funcs = {\n\t.set = NULL,\n\t.ack = NULL\n};\n\nstatic const struct irq_source_info_funcs pflip_irq_info_funcs = {\n\t.set = NULL,\n\t.ack = NULL\n};\n\nstatic const struct irq_source_info_funcs vblank_irq_info_funcs = {\n\t.set = dce110_vblank_set,\n\t.ack = NULL\n};\n\nstatic const struct irq_source_info_funcs vupdate_irq_info_funcs = {\n\t.set = NULL,\n\t.ack = NULL\n};\n\n#define hpd_int_entry(reg_num)\\\n\t[DC_IRQ_SOURCE_HPD1 + reg_num] = {\\\n\t\t.enable_reg = mmHPD ## reg_num ## _DC_HPD_INT_CONTROL,\\\n\t\t.enable_mask = DC_HPD_INT_CONTROL__DC_HPD_INT_EN_MASK,\\\n\t\t.enable_value = {\\\n\t\t\tDC_HPD_INT_CONTROL__DC_HPD_INT_EN_MASK,\\\n\t\t\t~DC_HPD_INT_CONTROL__DC_HPD_INT_EN_MASK\\\n\t\t},\\\n\t\t.ack_reg = mmHPD ## reg_num ## _DC_HPD_INT_CONTROL,\\\n\t\t.ack_mask = DC_HPD_INT_CONTROL__DC_HPD_INT_ACK_MASK,\\\n\t\t.ack_value = DC_HPD_INT_CONTROL__DC_HPD_INT_ACK_MASK,\\\n\t\t.status_reg = mmHPD ## reg_num ## _DC_HPD_INT_STATUS,\\\n\t\t.funcs = &hpd_irq_info_funcs\\\n\t}\n\n#define hpd_rx_int_entry(reg_num)\\\n\t[DC_IRQ_SOURCE_HPD1RX + reg_num] = {\\\n\t\t.enable_reg = mmHPD ## reg_num ## _DC_HPD_INT_CONTROL,\\\n\t\t.enable_mask = DC_HPD_INT_CONTROL__DC_HPD_RX_INT_EN_MASK,\\\n\t\t.enable_value = {\\\n\t\t\tDC_HPD_INT_CONTROL__DC_HPD_RX_INT_EN_MASK,\\\n\t\t\t~DC_HPD_INT_CONTROL__DC_HPD_RX_INT_EN_MASK },\\\n\t\t.ack_reg = mmHPD ## reg_num ## _DC_HPD_INT_CONTROL,\\\n\t\t.ack_mask = DC_HPD_INT_CONTROL__DC_HPD_RX_INT_ACK_MASK,\\\n\t\t.ack_value = DC_HPD_INT_CONTROL__DC_HPD_RX_INT_ACK_MASK,\\\n\t\t.status_reg = mmHPD ## reg_num ## _DC_HPD_INT_STATUS,\\\n\t\t.funcs = &hpd_rx_irq_info_funcs\\\n\t}\n#define pflip_int_entry(reg_num)\\\n\t[DC_IRQ_SOURCE_PFLIP1 + reg_num] = {\\\n\t\t.enable_reg = mmDCP ## reg_num ## _GRPH_INTERRUPT_CONTROL,\\\n\t\t.enable_mask =\\\n\t\tGRPH_INTERRUPT_CONTROL__GRPH_PFLIP_INT_MASK_MASK,\\\n\t\t.enable_value = {\\\n\t\t\tGRPH_INTERRUPT_CONTROL__GRPH_PFLIP_INT_MASK_MASK,\\\n\t\t\t~GRPH_INTERRUPT_CONTROL__GRPH_PFLIP_INT_MASK_MASK},\\\n\t\t.ack_reg = mmDCP ## reg_num ## _GRPH_INTERRUPT_STATUS,\\\n\t\t.ack_mask = GRPH_INTERRUPT_STATUS__GRPH_PFLIP_INT_CLEAR_MASK,\\\n\t\t.ack_value = GRPH_INTERRUPT_STATUS__GRPH_PFLIP_INT_CLEAR_MASK,\\\n\t\t.status_reg = mmDCP ## reg_num ##_GRPH_INTERRUPT_STATUS,\\\n\t\t.funcs = &pflip_irq_info_funcs\\\n\t}\n\n#define vupdate_int_entry(reg_num)\\\n\t[DC_IRQ_SOURCE_VUPDATE1 + reg_num] = {\\\n\t\t.enable_reg = mmCRTC ## reg_num ## _CRTC_INTERRUPT_CONTROL,\\\n\t\t.enable_mask =\\\n\t\tCRTC_INTERRUPT_CONTROL__CRTC_V_UPDATE_INT_MSK_MASK,\\\n\t\t.enable_value = {\\\n\t\t\tCRTC_INTERRUPT_CONTROL__CRTC_V_UPDATE_INT_MSK_MASK,\\\n\t\t\t~CRTC_INTERRUPT_CONTROL__CRTC_V_UPDATE_INT_MSK_MASK},\\\n\t\t.ack_reg = mmCRTC ## reg_num ## _CRTC_V_UPDATE_INT_STATUS,\\\n\t\t.ack_mask =\\\n\t\tCRTC_V_UPDATE_INT_STATUS__CRTC_V_UPDATE_INT_CLEAR_MASK,\\\n\t\t.ack_value =\\\n\t\tCRTC_V_UPDATE_INT_STATUS__CRTC_V_UPDATE_INT_CLEAR_MASK,\\\n\t\t.funcs = &vupdate_irq_info_funcs\\\n\t}\n\n#define vblank_int_entry(reg_num)\\\n\t[DC_IRQ_SOURCE_VBLANK1 + reg_num] = {\\\n\t\t.enable_reg = mmCRTC ## reg_num ## _CRTC_VERTICAL_INTERRUPT0_CONTROL,\\\n\t\t.enable_mask =\\\n\t\tCRTC_VERTICAL_INTERRUPT0_CONTROL__CRTC_VERTICAL_INTERRUPT0_INT_ENABLE_MASK,\\\n\t\t.enable_value = {\\\n\t\t\tCRTC_VERTICAL_INTERRUPT0_CONTROL__CRTC_VERTICAL_INTERRUPT0_INT_ENABLE_MASK,\\\n\t\t\t~CRTC_VERTICAL_INTERRUPT0_CONTROL__CRTC_VERTICAL_INTERRUPT0_INT_ENABLE_MASK},\\\n\t\t.ack_reg = mmCRTC ## reg_num ## _CRTC_VERTICAL_INTERRUPT0_CONTROL,\\\n\t\t.ack_mask =\\\n\t\tCRTC_VERTICAL_INTERRUPT0_CONTROL__CRTC_VERTICAL_INTERRUPT0_CLEAR_MASK,\\\n\t\t.ack_value =\\\n\t\tCRTC_VERTICAL_INTERRUPT0_CONTROL__CRTC_VERTICAL_INTERRUPT0_CLEAR_MASK,\\\n\t\t.funcs = &vblank_irq_info_funcs,\\\n\t\t.src_id = VISLANDS30_IV_SRCID_D1_VERTICAL_INTERRUPT0 + reg_num\\\n\t}\n\n#define dummy_irq_entry() \\\n\t{\\\n\t\t.funcs = &dummy_irq_info_funcs\\\n\t}\n\n#define i2c_int_entry(reg_num) \\\n\t[DC_IRQ_SOURCE_I2C_DDC ## reg_num] = dummy_irq_entry()\n\n#define dp_sink_int_entry(reg_num) \\\n\t[DC_IRQ_SOURCE_DPSINK ## reg_num] = dummy_irq_entry()\n\n#define gpio_pad_int_entry(reg_num) \\\n\t[DC_IRQ_SOURCE_GPIOPAD ## reg_num] = dummy_irq_entry()\n\n#define dc_underflow_int_entry(reg_num) \\\n\t[DC_IRQ_SOURCE_DC ## reg_num ## UNDERFLOW] = dummy_irq_entry()\n\nbool dal_irq_service_dummy_set(struct irq_service *irq_service,\n\t\t\t       const struct irq_source_info *info,\n\t\t\t       bool enable)\n{\n\tDC_LOG_ERROR(\"%s: called for non-implemented irq source, src_id=%u, ext_id=%u\\n\",\n\t\t     __func__, info->src_id, info->ext_id);\n\n\treturn false;\n}\n\nbool dal_irq_service_dummy_ack(struct irq_service *irq_service,\n\t\t\t       const struct irq_source_info *info)\n{\n\tDC_LOG_ERROR(\"%s: called for non-implemented irq source, src_id=%u, ext_id=%u\\n\",\n\t\t     __func__, info->src_id, info->ext_id);\n\n\treturn false;\n}\n\n\nbool dce110_vblank_set(struct irq_service *irq_service,\n\t\t       const struct irq_source_info *info,\n\t\t       bool enable)\n{\n\tstruct dc_context *dc_ctx = irq_service->ctx;\n\tstruct dc *dc = irq_service->ctx->dc;\n\tenum dc_irq_source dal_irq_src =\n\t\t\tdc_interrupt_to_irq_source(irq_service->ctx->dc,\n\t\t\t\t\t\t   info->src_id,\n\t\t\t\t\t\t   info->ext_id);\n\tuint8_t pipe_offset = dal_irq_src - IRQ_TYPE_VBLANK;\n\n\tstruct timing_generator *tg =\n\t\t\tdc->current_state->res_ctx.pipe_ctx[pipe_offset].stream_res.tg;\n\n\tif (enable) {\n\t\tif (!tg || !tg->funcs->arm_vert_intr(tg, 2)) {\n\t\t\tDC_ERROR(\"Failed to get VBLANK!\\n\");\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tdal_irq_service_set_generic(irq_service, info, enable);\n\treturn true;\n}\n\nstatic const struct irq_source_info_funcs dummy_irq_info_funcs = {\n\t.set = dal_irq_service_dummy_set,\n\t.ack = dal_irq_service_dummy_ack\n};\n\nstatic const struct irq_source_info\nirq_source_info_dce110[DAL_IRQ_SOURCES_NUMBER] = {\n\t[DC_IRQ_SOURCE_INVALID] = dummy_irq_entry(),\n\thpd_int_entry(0),\n\thpd_int_entry(1),\n\thpd_int_entry(2),\n\thpd_int_entry(3),\n\thpd_int_entry(4),\n\thpd_int_entry(5),\n\thpd_rx_int_entry(0),\n\thpd_rx_int_entry(1),\n\thpd_rx_int_entry(2),\n\thpd_rx_int_entry(3),\n\thpd_rx_int_entry(4),\n\thpd_rx_int_entry(5),\n\ti2c_int_entry(1),\n\ti2c_int_entry(2),\n\ti2c_int_entry(3),\n\ti2c_int_entry(4),\n\ti2c_int_entry(5),\n\ti2c_int_entry(6),\n\tdp_sink_int_entry(1),\n\tdp_sink_int_entry(2),\n\tdp_sink_int_entry(3),\n\tdp_sink_int_entry(4),\n\tdp_sink_int_entry(5),\n\tdp_sink_int_entry(6),\n\t[DC_IRQ_SOURCE_TIMER] = dummy_irq_entry(),\n\tpflip_int_entry(0),\n\tpflip_int_entry(1),\n\tpflip_int_entry(2),\n\tpflip_int_entry(3),\n\tpflip_int_entry(4),\n\tpflip_int_entry(5),\n\t[DC_IRQ_SOURCE_PFLIP_UNDERLAY0] = dummy_irq_entry(),\n\tgpio_pad_int_entry(0),\n\tgpio_pad_int_entry(1),\n\tgpio_pad_int_entry(2),\n\tgpio_pad_int_entry(3),\n\tgpio_pad_int_entry(4),\n\tgpio_pad_int_entry(5),\n\tgpio_pad_int_entry(6),\n\tgpio_pad_int_entry(7),\n\tgpio_pad_int_entry(8),\n\tgpio_pad_int_entry(9),\n\tgpio_pad_int_entry(10),\n\tgpio_pad_int_entry(11),\n\tgpio_pad_int_entry(12),\n\tgpio_pad_int_entry(13),\n\tgpio_pad_int_entry(14),\n\tgpio_pad_int_entry(15),\n\tgpio_pad_int_entry(16),\n\tgpio_pad_int_entry(17),\n\tgpio_pad_int_entry(18),\n\tgpio_pad_int_entry(19),\n\tgpio_pad_int_entry(20),\n\tgpio_pad_int_entry(21),\n\tgpio_pad_int_entry(22),\n\tgpio_pad_int_entry(23),\n\tgpio_pad_int_entry(24),\n\tgpio_pad_int_entry(25),\n\tgpio_pad_int_entry(26),\n\tgpio_pad_int_entry(27),\n\tgpio_pad_int_entry(28),\n\tgpio_pad_int_entry(29),\n\tgpio_pad_int_entry(30),\n\tdc_underflow_int_entry(1),\n\tdc_underflow_int_entry(2),\n\tdc_underflow_int_entry(3),\n\tdc_underflow_int_entry(4),\n\tdc_underflow_int_entry(5),\n\tdc_underflow_int_entry(6),\n\t[DC_IRQ_SOURCE_DMCU_SCP] = dummy_irq_entry(),\n\t[DC_IRQ_SOURCE_VBIOS_SW] = dummy_irq_entry(),\n\tvupdate_int_entry(0),\n\tvupdate_int_entry(1),\n\tvupdate_int_entry(2),\n\tvupdate_int_entry(3),\n\tvupdate_int_entry(4),\n\tvupdate_int_entry(5),\n\tvblank_int_entry(0),\n\tvblank_int_entry(1),\n\tvblank_int_entry(2),\n\tvblank_int_entry(3),\n\tvblank_int_entry(4),\n\tvblank_int_entry(5),\n\n};\n\nenum dc_irq_source to_dal_irq_source_dce110(\n\t\tstruct irq_service *irq_service,\n\t\tuint32_t src_id,\n\t\tuint32_t ext_id)\n{\n\tswitch (src_id) {\n\tcase VISLANDS30_IV_SRCID_D1_VERTICAL_INTERRUPT0:\n\t\treturn DC_IRQ_SOURCE_VBLANK1;\n\tcase VISLANDS30_IV_SRCID_D2_VERTICAL_INTERRUPT0:\n\t\treturn DC_IRQ_SOURCE_VBLANK2;\n\tcase VISLANDS30_IV_SRCID_D3_VERTICAL_INTERRUPT0:\n\t\treturn DC_IRQ_SOURCE_VBLANK3;\n\tcase VISLANDS30_IV_SRCID_D4_VERTICAL_INTERRUPT0:\n\t\treturn DC_IRQ_SOURCE_VBLANK4;\n\tcase VISLANDS30_IV_SRCID_D5_VERTICAL_INTERRUPT0:\n\t\treturn DC_IRQ_SOURCE_VBLANK5;\n\tcase VISLANDS30_IV_SRCID_D6_VERTICAL_INTERRUPT0:\n\t\treturn DC_IRQ_SOURCE_VBLANK6;\n\tcase VISLANDS30_IV_SRCID_D1_V_UPDATE_INT:\n\t\treturn DC_IRQ_SOURCE_VUPDATE1;\n\tcase VISLANDS30_IV_SRCID_D2_V_UPDATE_INT:\n\t\treturn DC_IRQ_SOURCE_VUPDATE2;\n\tcase VISLANDS30_IV_SRCID_D3_V_UPDATE_INT:\n\t\treturn DC_IRQ_SOURCE_VUPDATE3;\n\tcase VISLANDS30_IV_SRCID_D4_V_UPDATE_INT:\n\t\treturn DC_IRQ_SOURCE_VUPDATE4;\n\tcase VISLANDS30_IV_SRCID_D5_V_UPDATE_INT:\n\t\treturn DC_IRQ_SOURCE_VUPDATE5;\n\tcase VISLANDS30_IV_SRCID_D6_V_UPDATE_INT:\n\t\treturn DC_IRQ_SOURCE_VUPDATE6;\n\tcase VISLANDS30_IV_SRCID_D1_GRPH_PFLIP:\n\t\treturn DC_IRQ_SOURCE_PFLIP1;\n\tcase VISLANDS30_IV_SRCID_D2_GRPH_PFLIP:\n\t\treturn DC_IRQ_SOURCE_PFLIP2;\n\tcase VISLANDS30_IV_SRCID_D3_GRPH_PFLIP:\n\t\treturn DC_IRQ_SOURCE_PFLIP3;\n\tcase VISLANDS30_IV_SRCID_D4_GRPH_PFLIP:\n\t\treturn DC_IRQ_SOURCE_PFLIP4;\n\tcase VISLANDS30_IV_SRCID_D5_GRPH_PFLIP:\n\t\treturn DC_IRQ_SOURCE_PFLIP5;\n\tcase VISLANDS30_IV_SRCID_D6_GRPH_PFLIP:\n\t\treturn DC_IRQ_SOURCE_PFLIP6;\n\n\tcase VISLANDS30_IV_SRCID_HOTPLUG_DETECT_A:\n\t\t \n\t\tswitch (ext_id) {\n\t\tcase VISLANDS30_IV_EXTID_HOTPLUG_DETECT_A:\n\t\t\treturn DC_IRQ_SOURCE_HPD1;\n\t\tcase VISLANDS30_IV_EXTID_HOTPLUG_DETECT_B:\n\t\t\treturn DC_IRQ_SOURCE_HPD2;\n\t\tcase VISLANDS30_IV_EXTID_HOTPLUG_DETECT_C:\n\t\t\treturn DC_IRQ_SOURCE_HPD3;\n\t\tcase VISLANDS30_IV_EXTID_HOTPLUG_DETECT_D:\n\t\t\treturn DC_IRQ_SOURCE_HPD4;\n\t\tcase VISLANDS30_IV_EXTID_HOTPLUG_DETECT_E:\n\t\t\treturn DC_IRQ_SOURCE_HPD5;\n\t\tcase VISLANDS30_IV_EXTID_HOTPLUG_DETECT_F:\n\t\t\treturn DC_IRQ_SOURCE_HPD6;\n\t\tcase VISLANDS30_IV_EXTID_HPD_RX_A:\n\t\t\treturn DC_IRQ_SOURCE_HPD1RX;\n\t\tcase VISLANDS30_IV_EXTID_HPD_RX_B:\n\t\t\treturn DC_IRQ_SOURCE_HPD2RX;\n\t\tcase VISLANDS30_IV_EXTID_HPD_RX_C:\n\t\t\treturn DC_IRQ_SOURCE_HPD3RX;\n\t\tcase VISLANDS30_IV_EXTID_HPD_RX_D:\n\t\t\treturn DC_IRQ_SOURCE_HPD4RX;\n\t\tcase VISLANDS30_IV_EXTID_HPD_RX_E:\n\t\t\treturn DC_IRQ_SOURCE_HPD5RX;\n\t\tcase VISLANDS30_IV_EXTID_HPD_RX_F:\n\t\t\treturn DC_IRQ_SOURCE_HPD6RX;\n\t\tdefault:\n\t\t\treturn DC_IRQ_SOURCE_INVALID;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\treturn DC_IRQ_SOURCE_INVALID;\n\t}\n}\n\nstatic const struct irq_service_funcs irq_service_funcs_dce110 = {\n\t\t.to_dal_irq_source = to_dal_irq_source_dce110\n};\n\nstatic void dce110_irq_construct(struct irq_service *irq_service,\n\t\t      struct irq_service_init_data *init_data)\n{\n\tdal_irq_service_construct(irq_service, init_data);\n\n\tirq_service->info = irq_source_info_dce110;\n\tirq_service->funcs = &irq_service_funcs_dce110;\n}\n\nstruct irq_service *\ndal_irq_service_dce110_create(struct irq_service_init_data *init_data)\n{\n\tstruct irq_service *irq_service = kzalloc(sizeof(*irq_service),\n\t\t\t\t\t\t  GFP_KERNEL);\n\n\tif (!irq_service)\n\t\treturn NULL;\n\n\tdce110_irq_construct(irq_service, init_data);\n\treturn irq_service;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}