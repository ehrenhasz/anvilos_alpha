{
  "module_name": "link_hwss_hpo_fixed_vs_pe_retimer_dp.c",
  "hash_id": "12a99ac7f1a1bb572adce6732cac74d6544db5f1e8d19cae9fd2a160e85bc4c8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/link/hwss/link_hwss_hpo_fixed_vs_pe_retimer_dp.c",
  "human_readable_source": " \n#include \"link_hwss_hpo_dp.h\"\n#include \"link_hwss_hpo_fixed_vs_pe_retimer_dp.h\"\n#include \"link_hwss_dio_fixed_vs_pe_retimer.h\"\n\nstatic void dp_hpo_fixed_vs_pe_retimer_set_tx_ffe(struct dc_link *link,\n\t\tconst struct dc_lane_settings *hw_lane_settings)\n{\n\tconst uint8_t vendor_ffe_preset_table[16] = {\n\t\t\t\t\t\t\t\t\t\t\t0x01, 0x41, 0x61, 0x81,\n\t\t\t\t\t\t\t\t\t\t\t0xB1, 0x05, 0x35, 0x65,\n\t\t\t\t\t\t\t\t\t\t\t0x85, 0xA5, 0x09, 0x39,\n\t\t\t\t\t\t\t\t\t\t\t0x59, 0x89, 0x0F, 0x24};\n\n\tconst uint8_t ffe_mask[4] = {\n\t\t\t(hw_lane_settings[0].FFE_PRESET.settings.no_deemphasis != 0 ? 0x0F : 0xFF)\n\t\t\t\t& (hw_lane_settings[0].FFE_PRESET.settings.no_preshoot != 0 ? 0xF1 : 0xFF),\n\t\t\t(hw_lane_settings[1].FFE_PRESET.settings.no_deemphasis != 0 ? 0x0F : 0xFF)\n\t\t\t\t& (hw_lane_settings[1].FFE_PRESET.settings.no_preshoot != 0 ? 0xF1 : 0xFF),\n\t\t\t(hw_lane_settings[2].FFE_PRESET.settings.no_deemphasis != 0 ? 0x0F : 0xFF)\n\t\t\t\t& (hw_lane_settings[2].FFE_PRESET.settings.no_preshoot != 0 ? 0xF1 : 0xFF),\n\t\t\t(hw_lane_settings[3].FFE_PRESET.settings.no_deemphasis != 0 ? 0x0F : 0xFF)\n\t\t\t\t& (hw_lane_settings[3].FFE_PRESET.settings.no_preshoot != 0 ? 0xF1 : 0xFF)};\n\n\tconst uint8_t ffe_cfg[4] = {\n\t\t\tvendor_ffe_preset_table[hw_lane_settings[0].FFE_PRESET.settings.level] & ffe_mask[0],\n\t\t\tvendor_ffe_preset_table[hw_lane_settings[1].FFE_PRESET.settings.level] & ffe_mask[1],\n\t\t\tvendor_ffe_preset_table[hw_lane_settings[2].FFE_PRESET.settings.level] & ffe_mask[2],\n\t\t\tvendor_ffe_preset_table[hw_lane_settings[3].FFE_PRESET.settings.level] & ffe_mask[3]};\n\n\tconst uint8_t dp_type = dp_dio_fixed_vs_pe_retimer_lane_cfg_to_hw_cfg(link);\n\n\tconst uint8_t vendor_lttpr_write_data_ffe1[4] = {0x01, 0x50, dp_type, 0x0F};\n\tconst uint8_t vendor_lttpr_write_data_ffe2[4] = {0x01, 0x55, dp_type, ffe_cfg[0]};\n\tconst uint8_t vendor_lttpr_write_data_ffe3[4] = {0x01, 0x56, dp_type, ffe_cfg[1]};\n\tconst uint8_t vendor_lttpr_write_data_ffe4[4] = {0x01, 0x57, dp_type, ffe_cfg[2]};\n\tconst uint8_t vendor_lttpr_write_data_ffe5[4] = {0x01, 0x58, dp_type, ffe_cfg[3]};\n\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_ffe1[0], sizeof(vendor_lttpr_write_data_ffe1));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_ffe2[0], sizeof(vendor_lttpr_write_data_ffe2));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_ffe3[0], sizeof(vendor_lttpr_write_data_ffe3));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_ffe4[0], sizeof(vendor_lttpr_write_data_ffe4));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_ffe5[0], sizeof(vendor_lttpr_write_data_ffe5));\n}\n\nstatic void dp_hpo_fixed_vs_pe_retimer_program_override_test_pattern(struct dc_link *link,\n\t\tstruct encoder_set_dp_phy_pattern_param *tp_params)\n{\n\tconst uint8_t vendor_lttpr_write_data_pg0[4] = {0x1, 0x11, 0x0, 0x0};\n\tconst uint8_t vendor_lttpr_write_data_pg1[4] = {0x1, 0x50, 0x50, 0x0};\n\tconst uint8_t vendor_lttpr_write_data_pg2[4] = {0x1, 0x51, 0x50, 0x0};\n\tconst uint8_t vendor_lttpr_write_data_pg3[4]  = {0x1, 0x10, 0x58, 0x21};\n\tconst uint8_t vendor_lttpr_write_data_pg4[4]  = {0x1, 0x10, 0x59, 0x21};\n\tconst uint8_t vendor_lttpr_write_data_pg5[4] = {0x1, 0x1C, 0x58, 0x4F};\n\tconst uint8_t vendor_lttpr_write_data_pg6[4] = {0x1, 0x1C, 0x59, 0x4F};\n\tconst uint8_t vendor_lttpr_write_data_pg7[4]  = {0x1, 0x30, 0x51, 0x20};\n\tconst uint8_t vendor_lttpr_write_data_pg8[4]  = {0x1, 0x30, 0x52, 0x20};\n\tconst uint8_t vendor_lttpr_write_data_pg9[4]  = {0x1, 0x30, 0x54, 0x20};\n\tconst uint8_t vendor_lttpr_write_data_pg10[4] = {0x1, 0x30, 0x55, 0x20};\n\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pg0[0], sizeof(vendor_lttpr_write_data_pg0));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pg1[0], sizeof(vendor_lttpr_write_data_pg1));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pg2[0], sizeof(vendor_lttpr_write_data_pg2));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pg3[0], sizeof(vendor_lttpr_write_data_pg3));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pg4[0], sizeof(vendor_lttpr_write_data_pg4));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pg5[0], sizeof(vendor_lttpr_write_data_pg5));\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pg6[0], sizeof(vendor_lttpr_write_data_pg6));\n\n\tif (link->cur_link_settings.lane_count == LANE_COUNT_FOUR)\n\t\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_pg7[0], sizeof(vendor_lttpr_write_data_pg7));\n\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pg8[0], sizeof(vendor_lttpr_write_data_pg8));\n\n\tif (link->cur_link_settings.lane_count == LANE_COUNT_FOUR)\n\t\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t&vendor_lttpr_write_data_pg9[0], sizeof(vendor_lttpr_write_data_pg9));\n\n\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t&vendor_lttpr_write_data_pg10[0], sizeof(vendor_lttpr_write_data_pg10));\n}\n\nstatic bool dp_hpo_fixed_vs_pe_retimer_set_override_test_pattern(struct dc_link *link,\n\t\tconst struct link_resource *link_res, struct encoder_set_dp_phy_pattern_param *tp_params,\n\t\tconst struct link_hwss *link_hwss)\n{\n\tstruct encoder_set_dp_phy_pattern_param hw_tp_params = { 0 };\n\tconst uint8_t vendor_lttpr_exit_manual_automation_0[4] = {0x1, 0x11, 0x0, 0x06};\n\n\tif (tp_params == NULL)\n\t\treturn false;\n\n\tif (tp_params->dp_phy_pattern < DP_TEST_PATTERN_SQUARE_BEGIN ||\n\t\t\ttp_params->dp_phy_pattern > DP_TEST_PATTERN_SQUARE_END) {\n\t\t\n\t\tif (link->current_test_pattern == DP_TEST_PATTERN_80BIT_CUSTOM ||\n\t\t\t\tlink->current_test_pattern == DP_TEST_PATTERN_D102)\n\t\t\tlink->dc->link_srv->configure_fixed_vs_pe_retimer(link->ddc,\n\t\t\t\t\t&vendor_lttpr_exit_manual_automation_0[0],\n\t\t\t\t\tsizeof(vendor_lttpr_exit_manual_automation_0));\n\t\telse\n\t\t\tdp_dio_fixed_vs_pe_retimer_exit_manual_automation(link);\n\n\t\treturn false;\n\t}\n\n\thw_tp_params.dp_phy_pattern = DP_TEST_PATTERN_PRBS31;\n\thw_tp_params.dp_panel_mode = tp_params->dp_panel_mode;\n\n\tif (link_hwss->ext.set_dp_link_test_pattern)\n\t\tlink_hwss->ext.set_dp_link_test_pattern(link, link_res, &hw_tp_params);\n\n\tdp_hpo_fixed_vs_pe_retimer_program_override_test_pattern(link, tp_params);\n\n\tdp_hpo_fixed_vs_pe_retimer_set_tx_ffe(link, &link->cur_lane_setting[0]);\n\n\treturn true;\n}\n\nstatic void set_hpo_fixed_vs_pe_retimer_dp_link_test_pattern(struct dc_link *link,\n\t\tconst struct link_resource *link_res,\n\t\tstruct encoder_set_dp_phy_pattern_param *tp_params)\n{\n\tif (!dp_hpo_fixed_vs_pe_retimer_set_override_test_pattern(\n\t\t\tlink, link_res, tp_params, get_hpo_dp_link_hwss())) {\n\t\tlink_res->hpo_dp_link_enc->funcs->set_link_test_pattern(\n\t\t\t\tlink_res->hpo_dp_link_enc, tp_params);\n\t}\n\tlink->dc->link_srv->dp_trace_source_sequence(link, DPCD_SOURCE_SEQ_AFTER_SET_SOURCE_PATTERN);\n}\n\nstatic void set_hpo_fixed_vs_pe_retimer_dp_lane_settings(struct dc_link *link,\n\t\tconst struct link_resource *link_res,\n\t\tconst struct dc_link_settings *link_settings,\n\t\tconst struct dc_lane_settings lane_settings[LANE_COUNT_DP_MAX])\n{\n\tlink_res->hpo_dp_link_enc->funcs->set_ffe(\n\t\t\tlink_res->hpo_dp_link_enc,\n\t\t\tlink_settings,\n\t\t\tlane_settings[0].FFE_PRESET.raw);\n\n\t\n\t\n\tif (link->current_test_pattern >= DP_TEST_PATTERN_SQUARE_BEGIN &&\n\t\t\tlink->current_test_pattern <= DP_TEST_PATTERN_SQUARE_END)\n\t\tdp_hpo_fixed_vs_pe_retimer_set_tx_ffe(link, &lane_settings[0]);\n}\n\nstatic void enable_hpo_fixed_vs_pe_retimer_dp_link_output(struct dc_link *link,\n\t\tconst struct link_resource *link_res,\n\t\tenum signal_type signal,\n\t\tenum clock_source_id clock_source,\n\t\tconst struct dc_link_settings *link_settings)\n{\n\tif (link_settings->lane_count == LANE_COUNT_FOUR)\n\t\tenable_dio_fixed_vs_pe_retimer_program_4lane_output(link);\n\n\tenable_hpo_dp_link_output(link, link_res, signal, clock_source, link_settings);\n}\n\nstatic const struct link_hwss hpo_fixed_vs_pe_retimer_dp_link_hwss = {\n\t.setup_stream_encoder = setup_hpo_dp_stream_encoder,\n\t.reset_stream_encoder = reset_hpo_dp_stream_encoder,\n\t.setup_stream_attribute = setup_hpo_dp_stream_attribute,\n\t.disable_link_output = disable_hpo_dp_link_output,\n\t.setup_audio_output = setup_hpo_dp_audio_output,\n\t.enable_audio_packet = enable_hpo_dp_audio_packet,\n\t.disable_audio_packet = disable_hpo_dp_audio_packet,\n\t.ext = {\n\t\t.set_throttled_vcp_size = set_hpo_dp_throttled_vcp_size,\n\t\t.set_hblank_min_symbol_width = set_hpo_dp_hblank_min_symbol_width,\n\t\t.enable_dp_link_output = enable_hpo_fixed_vs_pe_retimer_dp_link_output,\n\t\t.set_dp_link_test_pattern  = set_hpo_fixed_vs_pe_retimer_dp_link_test_pattern,\n\t\t.set_dp_lane_settings = set_hpo_fixed_vs_pe_retimer_dp_lane_settings,\n\t\t.update_stream_allocation_table = update_hpo_dp_stream_allocation_table,\n\t},\n};\n\nbool requires_fixed_vs_pe_retimer_hpo_link_hwss(const struct dc_link *link)\n{\n\tif (!(link->chip_caps & EXT_DISPLAY_PATH_CAPS__DP_FIXED_VS_EN))\n\t\treturn false;\n\n\tif (!link->dpcd_caps.lttpr_caps.main_link_channel_coding.bits.DP_128b_132b_SUPPORTED)\n\t\treturn false;\n\n\treturn true;\n}\n\nconst struct link_hwss *get_hpo_fixed_vs_pe_retimer_dp_link_hwss(void)\n{\n\treturn &hpo_fixed_vs_pe_retimer_dp_link_hwss;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}