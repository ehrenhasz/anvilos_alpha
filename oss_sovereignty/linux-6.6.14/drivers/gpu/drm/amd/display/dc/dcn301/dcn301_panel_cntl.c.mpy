{
  "module_name": "dcn301_panel_cntl.c",
  "hash_id": "a359a6f788120c5c7eeafa5efbb184e09b27641fa262bfd8829c41e775366b39",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn301/dcn301_panel_cntl.c",
  "human_readable_source": " \n\n#include \"reg_helper.h\"\n#include \"core_types.h\"\n#include \"dc_dmub_srv.h\"\n#include \"dcn301_panel_cntl.h\"\n#include \"atom.h\"\n\n#define TO_DCN301_PANEL_CNTL(panel_cntl)\\\n\tcontainer_of(panel_cntl, struct dcn301_panel_cntl, base)\n\n#define CTX \\\n\tdcn301_panel_cntl->base.ctx\n\n#define DC_LOGGER \\\n\tdcn301_panel_cntl->base.ctx->logger\n\n#define REG(reg)\\\n\tdcn301_panel_cntl->regs->reg\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\tdcn301_panel_cntl->shift->field_name, dcn301_panel_cntl->mask->field_name\n\nstatic unsigned int dcn301_get_16_bit_backlight_from_pwm(struct panel_cntl *panel_cntl)\n{\n\tuint64_t current_backlight;\n\tuint32_t round_result;\n\tuint32_t bl_period, bl_int_count;\n\tuint32_t bl_pwm, fractional_duty_cycle_en;\n\tuint32_t bl_period_mask, bl_pwm_mask;\n\tstruct dcn301_panel_cntl *dcn301_panel_cntl = TO_DCN301_PANEL_CNTL(panel_cntl);\n\n\tREG_GET(BL_PWM_PERIOD_CNTL, BL_PWM_PERIOD, &bl_period);\n\tREG_GET(BL_PWM_PERIOD_CNTL, BL_PWM_PERIOD_BITCNT, &bl_int_count);\n\n\tREG_GET(BL_PWM_CNTL, BL_ACTIVE_INT_FRAC_CNT, &bl_pwm);\n\tREG_GET(BL_PWM_CNTL, BL_PWM_FRACTIONAL_EN, &fractional_duty_cycle_en);\n\n\tif (bl_int_count == 0)\n\t\tbl_int_count = 16;\n\n\tbl_period_mask = (1 << bl_int_count) - 1;\n\tbl_period &= bl_period_mask;\n\n\tbl_pwm_mask = bl_period_mask << (16 - bl_int_count);\n\n\tif (fractional_duty_cycle_en == 0)\n\t\tbl_pwm &= bl_pwm_mask;\n\telse\n\t\tbl_pwm &= 0xFFFF;\n\n\tcurrent_backlight = (uint64_t)bl_pwm << (1 + bl_int_count);\n\n\tif (bl_period == 0)\n\t\tbl_period = 0xFFFF;\n\n\tcurrent_backlight = div_u64(current_backlight, bl_period);\n\tcurrent_backlight = (current_backlight + 1) >> 1;\n\n\tcurrent_backlight = (uint64_t)(current_backlight) * bl_period;\n\n\tround_result = (uint32_t)(current_backlight & 0xFFFFFFFF);\n\n\tround_result = (round_result >> (bl_int_count-1)) & 1;\n\n\tcurrent_backlight >>= bl_int_count;\n\tcurrent_backlight += round_result;\n\n\treturn (uint32_t)(current_backlight);\n}\n\nstatic uint32_t dcn301_panel_cntl_hw_init(struct panel_cntl *panel_cntl)\n{\n\tstruct dcn301_panel_cntl *dcn301_panel_cntl = TO_DCN301_PANEL_CNTL(panel_cntl);\n\tuint32_t value;\n\tuint32_t current_backlight;\n\n\t \n\tREG_GET(BL_PWM_CNTL, BL_ACTIVE_INT_FRAC_CNT, &value);\n\n\tif (value == 0 || value == 1) {\n\t\tif (panel_cntl->stored_backlight_registers.BL_PWM_CNTL != 0) {\n\t\t\tREG_WRITE(BL_PWM_CNTL,\n\t\t\t\t\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL);\n\t\t\tREG_WRITE(BL_PWM_CNTL2,\n\t\t\t\t\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL2);\n\t\t\tREG_WRITE(BL_PWM_PERIOD_CNTL,\n\t\t\t\t\tpanel_cntl->stored_backlight_registers.BL_PWM_PERIOD_CNTL);\n\t\t\tREG_UPDATE(PWRSEQ_REF_DIV,\n\t\t\t\tBL_PWM_REF_DIV,\n\t\t\t\tpanel_cntl->stored_backlight_registers.LVTMA_PWRSEQ_REF_DIV_BL_PWM_REF_DIV);\n\t\t} else {\n\t\t\t \n\t\t\tREG_WRITE(BL_PWM_CNTL, 0xC000FA00);\n\t\t\tREG_WRITE(BL_PWM_PERIOD_CNTL, 0x000C0FA0);\n\t\t}\n\t} else {\n\t\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL =\n\t\t\t\tREG_READ(BL_PWM_CNTL);\n\t\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL2 =\n\t\t\t\tREG_READ(BL_PWM_CNTL2);\n\t\tpanel_cntl->stored_backlight_registers.BL_PWM_PERIOD_CNTL =\n\t\t\t\tREG_READ(BL_PWM_PERIOD_CNTL);\n\n\t\tREG_GET(PWRSEQ_REF_DIV, BL_PWM_REF_DIV,\n\t\t\t\t&panel_cntl->stored_backlight_registers.LVTMA_PWRSEQ_REF_DIV_BL_PWM_REF_DIV);\n\t}\n\n\t\n\tREG_UPDATE(BL_PWM_CNTL, BL_PWM_EN, 1);\n\n\t\n\tREG_UPDATE(BL_PWM_GRP1_REG_LOCK,\n\t\t\tBL_PWM_GRP1_REG_LOCK, 0);\n\n\tcurrent_backlight = dcn301_get_16_bit_backlight_from_pwm(panel_cntl);\n\n\treturn current_backlight;\n}\n\nstatic void dcn301_panel_cntl_destroy(struct panel_cntl **panel_cntl)\n{\n\tstruct dcn301_panel_cntl *dcn301_panel_cntl = TO_DCN301_PANEL_CNTL(*panel_cntl);\n\n\tkfree(dcn301_panel_cntl);\n\t*panel_cntl = NULL;\n}\n\nstatic bool dcn301_is_panel_backlight_on(struct panel_cntl *panel_cntl)\n{\n\tstruct dcn301_panel_cntl *dcn301_panel_cntl = TO_DCN301_PANEL_CNTL(panel_cntl);\n\tuint32_t value;\n\n\tREG_GET(PWRSEQ_CNTL, PANEL_BLON, &value);\n\n\treturn value;\n}\n\nstatic bool dcn301_is_panel_powered_on(struct panel_cntl *panel_cntl)\n{\n\tstruct dcn301_panel_cntl *dcn301_panel_cntl = TO_DCN301_PANEL_CNTL(panel_cntl);\n\tuint32_t pwr_seq_state, dig_on, dig_on_ovrd;\n\n\tREG_GET(PWRSEQ_STATE, PANEL_PWRSEQ_TARGET_STATE_R, &pwr_seq_state);\n\n\tREG_GET_2(PWRSEQ_CNTL, PANEL_DIGON, &dig_on, PANEL_DIGON_OVRD, &dig_on_ovrd);\n\n\treturn (pwr_seq_state == 1) || (dig_on == 1 && dig_on_ovrd == 1);\n}\n\nstatic void dcn301_store_backlight_level(struct panel_cntl *panel_cntl)\n{\n\tstruct dcn301_panel_cntl *dcn301_panel_cntl = TO_DCN301_PANEL_CNTL(panel_cntl);\n\n\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL =\n\t\tREG_READ(BL_PWM_CNTL);\n\tpanel_cntl->stored_backlight_registers.BL_PWM_CNTL2 =\n\t\tREG_READ(BL_PWM_CNTL2);\n\tpanel_cntl->stored_backlight_registers.BL_PWM_PERIOD_CNTL =\n\t\tREG_READ(BL_PWM_PERIOD_CNTL);\n\n\tREG_GET(PWRSEQ_REF_DIV, BL_PWM_REF_DIV,\n\t\t&panel_cntl->stored_backlight_registers.LVTMA_PWRSEQ_REF_DIV_BL_PWM_REF_DIV);\n}\n\nstatic const struct panel_cntl_funcs dcn301_link_panel_cntl_funcs = {\n\t.destroy = dcn301_panel_cntl_destroy,\n\t.hw_init = dcn301_panel_cntl_hw_init,\n\t.is_panel_backlight_on = dcn301_is_panel_backlight_on,\n\t.is_panel_powered_on = dcn301_is_panel_powered_on,\n\t.store_backlight_level = dcn301_store_backlight_level,\n\t.get_current_backlight = dcn301_get_16_bit_backlight_from_pwm,\n};\n\nvoid dcn301_panel_cntl_construct(\n\tstruct dcn301_panel_cntl *dcn301_panel_cntl,\n\tconst struct panel_cntl_init_data *init_data,\n\tconst struct dce_panel_cntl_registers *regs,\n\tconst struct dcn301_panel_cntl_shift *shift,\n\tconst struct dcn301_panel_cntl_mask *mask)\n{\n\tdcn301_panel_cntl->regs = regs;\n\tdcn301_panel_cntl->shift = shift;\n\tdcn301_panel_cntl->mask = mask;\n\n\tdcn301_panel_cntl->base.funcs = &dcn301_link_panel_cntl_funcs;\n\tdcn301_panel_cntl->base.ctx = init_data->ctx;\n\tdcn301_panel_cntl->base.inst = init_data->inst;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}