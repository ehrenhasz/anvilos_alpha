{
  "module_name": "dcn20_opp.c",
  "hash_id": "2eecf13a2ff82e04cd0c8a967e454155f1d2f2e28a0580af41c54805b7c4d5fc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/amd/display/dc/dcn20/dcn20_opp.c",
  "human_readable_source": " \n\n#include \"dm_services.h\"\n#include \"dcn20_opp.h\"\n#include \"reg_helper.h\"\n\n#define REG(reg) \\\n\t(oppn20->regs->reg)\n\n#undef FN\n#define FN(reg_name, field_name) \\\n\toppn20->opp_shift->field_name, oppn20->opp_mask->field_name\n\n#define CTX \\\n\toppn20->base.ctx\n\n\nvoid opp2_set_disp_pattern_generator(\n\t\tstruct output_pixel_processor *opp,\n\t\tenum controller_dp_test_pattern test_pattern,\n\t\tenum controller_dp_color_space color_space,\n\t\tenum dc_color_depth color_depth,\n\t\tconst struct tg_color *solid_color,\n\t\tint width,\n\t\tint height,\n\t\tint offset)\n{\n\tstruct dcn20_opp *oppn20 = TO_DCN20_OPP(opp);\n\tenum test_pattern_color_format bit_depth;\n\tenum test_pattern_dyn_range dyn_range;\n\tenum test_pattern_mode mode;\n\n\t \n\tuint32_t src_bpc = 16;\n\t \n\tuint32_t dst_bpc;\n\tuint32_t index;\n\t \n\tuint16_t src_color[6] = {0xFFFF, 0xFFFF, 0xFFFF, 0x0000,\n\t\t\t\t\t\t0x0000, 0x0000};\n\t \n\tuint16_t dst_color[6];\n\tuint32_t inc_base;\n\n\t \n\tswitch (color_depth) {\n\tcase COLOR_DEPTH_666:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_6;\n\tbreak;\n\tcase COLOR_DEPTH_888:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_8;\n\tbreak;\n\tcase COLOR_DEPTH_101010:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_10;\n\tbreak;\n\tcase COLOR_DEPTH_121212:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_12;\n\tbreak;\n\tdefault:\n\t\tbit_depth = TEST_PATTERN_COLOR_FORMAT_BPC_8;\n\tbreak;\n\t}\n\n\t \n\tREG_SET_2(DPG_DIMENSIONS, 0,\n\t\tDPG_ACTIVE_WIDTH, width,\n\t\tDPG_ACTIVE_HEIGHT, height);\n\n\t \n\tREG_SET_2(DPG_OFFSET_SEGMENT, 0,\n\t\tDPG_X_OFFSET, offset,\n\t\tDPG_SEGMENT_WIDTH, 0);\n\n\tswitch (test_pattern) {\n\tcase CONTROLLER_DP_TEST_PATTERN_COLORSQUARES:\n\tcase CONTROLLER_DP_TEST_PATTERN_COLORSQUARES_CEA:\n\t{\n\t\tdyn_range = (test_pattern ==\n\t\t\t\tCONTROLLER_DP_TEST_PATTERN_COLORSQUARES_CEA ?\n\t\t\t\tTEST_PATTERN_DYN_RANGE_CEA :\n\t\t\t\tTEST_PATTERN_DYN_RANGE_VESA);\n\n\t\tswitch (color_space) {\n\t\tcase CONTROLLER_DP_COLOR_SPACE_YCBCR601:\n\t\t\tmode = TEST_PATTERN_MODE_COLORSQUARES_YCBCR601;\n\t\tbreak;\n\t\tcase CONTROLLER_DP_COLOR_SPACE_YCBCR709:\n\t\t\tmode = TEST_PATTERN_MODE_COLORSQUARES_YCBCR709;\n\t\tbreak;\n\t\tcase CONTROLLER_DP_COLOR_SPACE_RGB:\n\t\tdefault:\n\t\t\tmode = TEST_PATTERN_MODE_COLORSQUARES_RGB;\n\t\tbreak;\n\t\t}\n\n\t\tREG_UPDATE_6(DPG_CONTROL,\n\t\t\tDPG_EN, 1,\n\t\t\tDPG_MODE, mode,\n\t\t\tDPG_DYNAMIC_RANGE, dyn_range,\n\t\t\tDPG_BIT_DEPTH, bit_depth,\n\t\t\tDPG_VRES, 6,\n\t\t\tDPG_HRES, 6);\n\t}\n\tbreak;\n\n\tcase CONTROLLER_DP_TEST_PATTERN_VERTICALBARS:\n\tcase CONTROLLER_DP_TEST_PATTERN_HORIZONTALBARS:\n\t{\n\t\tmode = (test_pattern ==\n\t\t\tCONTROLLER_DP_TEST_PATTERN_VERTICALBARS ?\n\t\t\tTEST_PATTERN_MODE_VERTICALBARS :\n\t\t\tTEST_PATTERN_MODE_HORIZONTALBARS);\n\n\t\tswitch (bit_depth) {\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_6:\n\t\t\tdst_bpc = 6;\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_8:\n\t\t\tdst_bpc = 8;\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_10:\n\t\t\tdst_bpc = 10;\n\t\tbreak;\n\t\tdefault:\n\t\t\tdst_bpc = 8;\n\t\tbreak;\n\t\t}\n\n\t\t \n\t\tfor (index = 0; index < 6; index++) {\n\t\t\t \n\t\t\tdst_color[index] =\n\t\t\t\tsrc_color[index] >> (src_bpc - dst_bpc);\n\t\t \n\t\t\tdst_color[index] <<= (16 - dst_bpc);\n\t\t}\n\n\t\tREG_SET_2(DPG_COLOUR_R_CR, 0,\n\t\t\t\tDPG_COLOUR1_R_CR, dst_color[0],\n\t\t\t\tDPG_COLOUR0_R_CR, dst_color[3]);\n\t\tREG_SET_2(DPG_COLOUR_G_Y, 0,\n\t\t\t\tDPG_COLOUR1_G_Y, dst_color[1],\n\t\t\t\tDPG_COLOUR0_G_Y, dst_color[4]);\n\t\tREG_SET_2(DPG_COLOUR_B_CB, 0,\n\t\t\t\tDPG_COLOUR1_B_CB, dst_color[2],\n\t\t\t\tDPG_COLOUR0_B_CB, dst_color[5]);\n\n\t\t \n\t\tREG_UPDATE_6(DPG_CONTROL,\n\t\t\tDPG_EN, 1,\n\t\t\tDPG_MODE, mode,\n\t\t\tDPG_DYNAMIC_RANGE, 0,\n\t\t\tDPG_BIT_DEPTH, bit_depth,\n\t\t\tDPG_VRES, 0,\n\t\t\tDPG_HRES, 0);\n\t}\n\tbreak;\n\n\tcase CONTROLLER_DP_TEST_PATTERN_COLORRAMP:\n\t{\n\t\tmode = (bit_depth ==\n\t\t\tTEST_PATTERN_COLOR_FORMAT_BPC_10 ?\n\t\t\tTEST_PATTERN_MODE_DUALRAMP_RGB :\n\t\t\tTEST_PATTERN_MODE_SINGLERAMP_RGB);\n\n\t\tswitch (bit_depth) {\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_6:\n\t\t\tdst_bpc = 6;\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_8:\n\t\t\tdst_bpc = 8;\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_10:\n\t\t\tdst_bpc = 10;\n\t\tbreak;\n\t\tdefault:\n\t\t\tdst_bpc = 8;\n\t\tbreak;\n\t\t}\n\n\t\t \n\t\tinc_base = (src_bpc - dst_bpc);\n\n\t\tswitch (bit_depth) {\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_6:\n\t\t{\n\t\t\tREG_SET_3(DPG_RAMP_CONTROL, 0,\n\t\t\t\tDPG_RAMP0_OFFSET, 0,\n\t\t\t\tDPG_INC0, inc_base,\n\t\t\t\tDPG_INC1, 0);\n\t\t\tREG_UPDATE_2(DPG_CONTROL,\n\t\t\t\tDPG_VRES, 6,\n\t\t\t\tDPG_HRES, 6);\n\t\t}\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_8:\n\t\t{\n\t\t\tREG_SET_3(DPG_RAMP_CONTROL, 0,\n\t\t\t\tDPG_RAMP0_OFFSET, 0,\n\t\t\t\tDPG_INC0, inc_base,\n\t\t\t\tDPG_INC1, 0);\n\t\t\tREG_UPDATE_2(DPG_CONTROL,\n\t\t\t\tDPG_VRES, 6,\n\t\t\t\tDPG_HRES, 8);\n\t\t}\n\t\tbreak;\n\t\tcase TEST_PATTERN_COLOR_FORMAT_BPC_10:\n\t\t{\n\t\t\tREG_SET_3(DPG_RAMP_CONTROL, 0,\n\t\t\t\tDPG_RAMP0_OFFSET, 384 << 6,\n\t\t\t\tDPG_INC0, inc_base,\n\t\t\t\tDPG_INC1, inc_base + 2);\n\t\t\tREG_UPDATE_2(DPG_CONTROL,\n\t\t\t\tDPG_VRES, 5,\n\t\t\t\tDPG_HRES, 8);\n\t\t}\n\t\tbreak;\n\t\tdefault:\n\t\tbreak;\n\t\t}\n\n\t\t \n\t\tREG_UPDATE_4(DPG_CONTROL,\n\t\t\tDPG_EN, 1,\n\t\t\tDPG_MODE, mode,\n\t\t\tDPG_DYNAMIC_RANGE, 0,\n\t\t\tDPG_BIT_DEPTH, bit_depth);\n\t}\n\tbreak;\n\tcase CONTROLLER_DP_TEST_PATTERN_VIDEOMODE:\n\t{\n\t\tREG_WRITE(DPG_CONTROL, 0);\n\t\tREG_WRITE(DPG_COLOUR_R_CR, 0);\n\t\tREG_WRITE(DPG_COLOUR_G_Y, 0);\n\t\tREG_WRITE(DPG_COLOUR_B_CB, 0);\n\t\tREG_WRITE(DPG_RAMP_CONTROL, 0);\n\t}\n\tbreak;\n\tcase CONTROLLER_DP_TEST_PATTERN_SOLID_COLOR:\n\t{\n\t\topp2_dpg_set_blank_color(opp, solid_color);\n\t\tREG_UPDATE_2(DPG_CONTROL,\n\t\t\t\tDPG_EN, 1,\n\t\t\t\tDPG_MODE, TEST_PATTERN_MODE_HORIZONTALBARS);\n\n\t\tREG_SET_2(DPG_DIMENSIONS, 0,\n\t\t\t\tDPG_ACTIVE_WIDTH, width,\n\t\t\t\tDPG_ACTIVE_HEIGHT, height);\n\t}\n\tbreak;\n\tdefault:\n\t\tbreak;\n\n\t}\n}\n\nvoid opp2_program_dpg_dimensions(\n\t\tstruct output_pixel_processor *opp,\n\t\tint width, int height)\n{\n\tstruct dcn20_opp *oppn20 = TO_DCN20_OPP(opp);\n\n\tREG_SET_2(DPG_DIMENSIONS, 0,\n\t\tDPG_ACTIVE_WIDTH, width,\n\t\tDPG_ACTIVE_HEIGHT, height);\n}\n\nvoid opp2_dpg_set_blank_color(\n\t\tstruct output_pixel_processor *opp,\n\t\tconst struct tg_color *color)\n{\n\tstruct dcn20_opp *oppn20 = TO_DCN20_OPP(opp);\n\n\t \n\tASSERT(color);\n\tREG_SET_2(DPG_COLOUR_B_CB, 0,\n\t\t\tDPG_COLOUR1_B_CB, color->color_b_cb << 6,\n\t\t\tDPG_COLOUR0_B_CB, color->color_b_cb << 6);\n\tREG_SET_2(DPG_COLOUR_G_Y, 0,\n\t\t\tDPG_COLOUR1_G_Y, color->color_g_y << 6,\n\t\t\tDPG_COLOUR0_G_Y, color->color_g_y << 6);\n\tREG_SET_2(DPG_COLOUR_R_CR, 0,\n\t\t\tDPG_COLOUR1_R_CR, color->color_r_cr << 6,\n\t\t\tDPG_COLOUR0_R_CR, color->color_r_cr << 6);\n}\n\nbool opp2_dpg_is_blanked(struct output_pixel_processor *opp)\n{\n\tstruct dcn20_opp *oppn20 = TO_DCN20_OPP(opp);\n\tuint32_t dpg_en, dpg_mode;\n\tuint32_t double_buffer_pending;\n\n\tREG_GET_2(DPG_CONTROL,\n\t\t\tDPG_EN, &dpg_en,\n\t\t\tDPG_MODE, &dpg_mode);\n\n\tREG_GET(DPG_STATUS,\n\t\t\tDPG_DOUBLE_BUFFER_PENDING, &double_buffer_pending);\n\n\treturn (dpg_en == 1) &&\n\t\t(double_buffer_pending == 0);\n}\n\nvoid opp2_program_left_edge_extra_pixel (\n\t\tstruct output_pixel_processor *opp,\n\t\tbool count)\n{\n\tstruct dcn20_opp *oppn20 = TO_DCN20_OPP(opp);\n\n\t \n\tREG_UPDATE(FMT_422_CONTROL, FMT_LEFT_EDGE_EXTRA_PIXEL_COUNT, count);\n}\n\n \n \n \n\nstatic struct opp_funcs dcn20_opp_funcs = {\n\t\t.opp_set_dyn_expansion = opp1_set_dyn_expansion,\n\t\t.opp_program_fmt = opp1_program_fmt,\n\t\t.opp_program_bit_depth_reduction = opp1_program_bit_depth_reduction,\n\t\t.opp_program_stereo = opp1_program_stereo,\n\t\t.opp_pipe_clock_control = opp1_pipe_clock_control,\n\t\t.opp_set_disp_pattern_generator = opp2_set_disp_pattern_generator,\n\t\t.opp_program_dpg_dimensions = opp2_program_dpg_dimensions,\n\t\t.dpg_is_blanked = opp2_dpg_is_blanked,\n\t\t.opp_dpg_set_blank_color = opp2_dpg_set_blank_color,\n\t\t.opp_destroy = opp1_destroy,\n\t\t.opp_program_left_edge_extra_pixel = opp2_program_left_edge_extra_pixel,\n};\n\nvoid dcn20_opp_construct(struct dcn20_opp *oppn20,\n\tstruct dc_context *ctx,\n\tuint32_t inst,\n\tconst struct dcn20_opp_registers *regs,\n\tconst struct dcn20_opp_shift *opp_shift,\n\tconst struct dcn20_opp_mask *opp_mask)\n{\n\toppn20->base.ctx = ctx;\n\toppn20->base.inst = inst;\n\toppn20->base.funcs = &dcn20_opp_funcs;\n\n\toppn20->regs = regs;\n\toppn20->opp_shift = opp_shift;\n\toppn20->opp_mask = opp_mask;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}