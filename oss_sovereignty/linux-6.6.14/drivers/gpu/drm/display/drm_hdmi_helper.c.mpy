{
  "module_name": "drm_hdmi_helper.c",
  "hash_id": "461b8e9742f5dd75bf1c76d0db82cef243c5edb5e4803201827fe92ac62b3aa5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/display/drm_hdmi_helper.c",
  "human_readable_source": "\n\n#include <linux/module.h>\n\n#include <drm/display/drm_hdmi_helper.h>\n#include <drm/drm_connector.h>\n#include <drm/drm_edid.h>\n#include <drm/drm_modes.h>\n#include <drm/drm_print.h>\n#include <drm/drm_property.h>\n\nstatic inline bool is_eotf_supported(u8 output_eotf, u8 sink_eotf)\n{\n\treturn sink_eotf & BIT(output_eotf);\n}\n\n \nint drm_hdmi_infoframe_set_hdr_metadata(struct hdmi_drm_infoframe *frame,\n\t\t\t\t\tconst struct drm_connector_state *conn_state)\n{\n\tstruct drm_connector *connector;\n\tstruct hdr_output_metadata *hdr_metadata;\n\tint err;\n\n\tif (!frame || !conn_state)\n\t\treturn -EINVAL;\n\n\tconnector = conn_state->connector;\n\n\tif (!conn_state->hdr_output_metadata)\n\t\treturn -EINVAL;\n\n\thdr_metadata = conn_state->hdr_output_metadata->data;\n\n\tif (!hdr_metadata || !connector)\n\t\treturn -EINVAL;\n\n\t \n\tif (!is_eotf_supported(hdr_metadata->hdmi_metadata_type1.eotf,\n\t    connector->hdr_sink_metadata.hdmi_type1.eotf))\n\t\tDRM_DEBUG_KMS(\"Unknown EOTF %d\\n\", hdr_metadata->hdmi_metadata_type1.eotf);\n\n\terr = hdmi_drm_infoframe_init(frame);\n\tif (err < 0)\n\t\treturn err;\n\n\tframe->eotf = hdr_metadata->hdmi_metadata_type1.eotf;\n\tframe->metadata_type = hdr_metadata->hdmi_metadata_type1.metadata_type;\n\n\tBUILD_BUG_ON(sizeof(frame->display_primaries) !=\n\t\t     sizeof(hdr_metadata->hdmi_metadata_type1.display_primaries));\n\tBUILD_BUG_ON(sizeof(frame->white_point) !=\n\t\t     sizeof(hdr_metadata->hdmi_metadata_type1.white_point));\n\n\tmemcpy(&frame->display_primaries,\n\t       &hdr_metadata->hdmi_metadata_type1.display_primaries,\n\t       sizeof(frame->display_primaries));\n\n\tmemcpy(&frame->white_point,\n\t       &hdr_metadata->hdmi_metadata_type1.white_point,\n\t       sizeof(frame->white_point));\n\n\tframe->max_display_mastering_luminance =\n\t\thdr_metadata->hdmi_metadata_type1.max_display_mastering_luminance;\n\tframe->min_display_mastering_luminance =\n\t\thdr_metadata->hdmi_metadata_type1.min_display_mastering_luminance;\n\tframe->max_fall = hdr_metadata->hdmi_metadata_type1.max_fall;\n\tframe->max_cll = hdr_metadata->hdmi_metadata_type1.max_cll;\n\n\treturn 0;\n}\nEXPORT_SYMBOL(drm_hdmi_infoframe_set_hdr_metadata);\n\n \n#define FULL_COLORIMETRY_MASK\t\t0x1FF\n#define NORMAL_COLORIMETRY_MASK\t\t0x3\n#define EXTENDED_COLORIMETRY_MASK\t0x7\n#define EXTENDED_ACE_COLORIMETRY_MASK\t0xF\n\n#define C(x) ((x) << 0)\n#define EC(x) ((x) << 2)\n#define ACE(x) ((x) << 5)\n\n#define HDMI_COLORIMETRY_NO_DATA\t\t0x0\n#define HDMI_COLORIMETRY_SMPTE_170M_YCC\t\t(C(1) | EC(0) | ACE(0))\n#define HDMI_COLORIMETRY_BT709_YCC\t\t(C(2) | EC(0) | ACE(0))\n#define HDMI_COLORIMETRY_XVYCC_601\t\t(C(3) | EC(0) | ACE(0))\n#define HDMI_COLORIMETRY_XVYCC_709\t\t(C(3) | EC(1) | ACE(0))\n#define HDMI_COLORIMETRY_SYCC_601\t\t(C(3) | EC(2) | ACE(0))\n#define HDMI_COLORIMETRY_OPYCC_601\t\t(C(3) | EC(3) | ACE(0))\n#define HDMI_COLORIMETRY_OPRGB\t\t\t(C(3) | EC(4) | ACE(0))\n#define HDMI_COLORIMETRY_BT2020_CYCC\t\t(C(3) | EC(5) | ACE(0))\n#define HDMI_COLORIMETRY_BT2020_RGB\t\t(C(3) | EC(6) | ACE(0))\n#define HDMI_COLORIMETRY_BT2020_YCC\t\t(C(3) | EC(6) | ACE(0))\n#define HDMI_COLORIMETRY_DCI_P3_RGB_D65\t\t(C(3) | EC(7) | ACE(0))\n#define HDMI_COLORIMETRY_DCI_P3_RGB_THEATER\t(C(3) | EC(7) | ACE(1))\n\nstatic const u32 hdmi_colorimetry_val[] = {\n\t[DRM_MODE_COLORIMETRY_NO_DATA] = HDMI_COLORIMETRY_NO_DATA,\n\t[DRM_MODE_COLORIMETRY_SMPTE_170M_YCC] = HDMI_COLORIMETRY_SMPTE_170M_YCC,\n\t[DRM_MODE_COLORIMETRY_BT709_YCC] = HDMI_COLORIMETRY_BT709_YCC,\n\t[DRM_MODE_COLORIMETRY_XVYCC_601] = HDMI_COLORIMETRY_XVYCC_601,\n\t[DRM_MODE_COLORIMETRY_XVYCC_709] = HDMI_COLORIMETRY_XVYCC_709,\n\t[DRM_MODE_COLORIMETRY_SYCC_601] = HDMI_COLORIMETRY_SYCC_601,\n\t[DRM_MODE_COLORIMETRY_OPYCC_601] = HDMI_COLORIMETRY_OPYCC_601,\n\t[DRM_MODE_COLORIMETRY_OPRGB] = HDMI_COLORIMETRY_OPRGB,\n\t[DRM_MODE_COLORIMETRY_BT2020_CYCC] = HDMI_COLORIMETRY_BT2020_CYCC,\n\t[DRM_MODE_COLORIMETRY_BT2020_RGB] = HDMI_COLORIMETRY_BT2020_RGB,\n\t[DRM_MODE_COLORIMETRY_BT2020_YCC] = HDMI_COLORIMETRY_BT2020_YCC,\n};\n\n#undef C\n#undef EC\n#undef ACE\n\n \nvoid drm_hdmi_avi_infoframe_colorimetry(struct hdmi_avi_infoframe *frame,\n\t\t\t\t\tconst struct drm_connector_state *conn_state)\n{\n\tu32 colorimetry_val;\n\tu32 colorimetry_index = conn_state->colorspace & FULL_COLORIMETRY_MASK;\n\n\tif (colorimetry_index >= ARRAY_SIZE(hdmi_colorimetry_val))\n\t\tcolorimetry_val = HDMI_COLORIMETRY_NO_DATA;\n\telse\n\t\tcolorimetry_val = hdmi_colorimetry_val[colorimetry_index];\n\n\tframe->colorimetry = colorimetry_val & NORMAL_COLORIMETRY_MASK;\n\t \n\tframe->extended_colorimetry = (colorimetry_val >> 2) &\n\t\t\t\t\tEXTENDED_COLORIMETRY_MASK;\n}\nEXPORT_SYMBOL(drm_hdmi_avi_infoframe_colorimetry);\n\n \nvoid drm_hdmi_avi_infoframe_bars(struct hdmi_avi_infoframe *frame,\n\t\t\t\t const struct drm_connector_state *conn_state)\n{\n\tframe->right_bar = conn_state->tv.margins.right;\n\tframe->left_bar = conn_state->tv.margins.left;\n\tframe->top_bar = conn_state->tv.margins.top;\n\tframe->bottom_bar = conn_state->tv.margins.bottom;\n}\nEXPORT_SYMBOL(drm_hdmi_avi_infoframe_bars);\n\n \nvoid drm_hdmi_avi_infoframe_content_type(struct hdmi_avi_infoframe *frame,\n\t\t\t\t\t const struct drm_connector_state *conn_state)\n{\n\tswitch (conn_state->content_type) {\n\tcase DRM_MODE_CONTENT_TYPE_GRAPHICS:\n\t\tframe->content_type = HDMI_CONTENT_TYPE_GRAPHICS;\n\t\tbreak;\n\tcase DRM_MODE_CONTENT_TYPE_CINEMA:\n\t\tframe->content_type = HDMI_CONTENT_TYPE_CINEMA;\n\t\tbreak;\n\tcase DRM_MODE_CONTENT_TYPE_GAME:\n\t\tframe->content_type = HDMI_CONTENT_TYPE_GAME;\n\t\tbreak;\n\tcase DRM_MODE_CONTENT_TYPE_PHOTO:\n\t\tframe->content_type = HDMI_CONTENT_TYPE_PHOTO;\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tframe->content_type = HDMI_CONTENT_TYPE_GRAPHICS;\n\t}\n\n\tframe->itc = conn_state->content_type != DRM_MODE_CONTENT_TYPE_NO_DATA;\n}\nEXPORT_SYMBOL(drm_hdmi_avi_infoframe_content_type);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}