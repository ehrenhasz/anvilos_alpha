{
  "module_name": "panfrost_gem_shrinker.c",
  "hash_id": "a6be9810ec3510497436aaef506547f4bc9cc37345835cd1629a2ca7e31ba1eb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/panfrost/panfrost_gem_shrinker.c",
  "human_readable_source": "\n \n\n#include <linux/list.h>\n\n#include <drm/drm_device.h>\n#include <drm/drm_gem_shmem_helper.h>\n\n#include \"panfrost_device.h\"\n#include \"panfrost_gem.h\"\n#include \"panfrost_mmu.h\"\n\nstatic unsigned long\npanfrost_gem_shrinker_count(struct shrinker *shrinker, struct shrink_control *sc)\n{\n\tstruct panfrost_device *pfdev =\n\t\tcontainer_of(shrinker, struct panfrost_device, shrinker);\n\tstruct drm_gem_shmem_object *shmem;\n\tunsigned long count = 0;\n\n\tif (!mutex_trylock(&pfdev->shrinker_lock))\n\t\treturn 0;\n\n\tlist_for_each_entry(shmem, &pfdev->shrinker_list, madv_list) {\n\t\tif (drm_gem_shmem_is_purgeable(shmem))\n\t\t\tcount += shmem->base.size >> PAGE_SHIFT;\n\t}\n\n\tmutex_unlock(&pfdev->shrinker_lock);\n\n\treturn count;\n}\n\nstatic bool panfrost_gem_purge(struct drm_gem_object *obj)\n{\n\tstruct drm_gem_shmem_object *shmem = to_drm_gem_shmem_obj(obj);\n\tstruct panfrost_gem_object *bo = to_panfrost_bo(obj);\n\tbool ret = false;\n\n\tif (atomic_read(&bo->gpu_usecount))\n\t\treturn false;\n\n\tif (!mutex_trylock(&bo->mappings.lock))\n\t\treturn false;\n\n\tif (!dma_resv_trylock(shmem->base.resv))\n\t\tgoto unlock_mappings;\n\n\tpanfrost_gem_teardown_mappings_locked(bo);\n\tdrm_gem_shmem_purge(&bo->base);\n\tret = true;\n\n\tdma_resv_unlock(shmem->base.resv);\n\nunlock_mappings:\n\tmutex_unlock(&bo->mappings.lock);\n\treturn ret;\n}\n\nstatic unsigned long\npanfrost_gem_shrinker_scan(struct shrinker *shrinker, struct shrink_control *sc)\n{\n\tstruct panfrost_device *pfdev =\n\t\tcontainer_of(shrinker, struct panfrost_device, shrinker);\n\tstruct drm_gem_shmem_object *shmem, *tmp;\n\tunsigned long freed = 0;\n\n\tif (!mutex_trylock(&pfdev->shrinker_lock))\n\t\treturn SHRINK_STOP;\n\n\tlist_for_each_entry_safe(shmem, tmp, &pfdev->shrinker_list, madv_list) {\n\t\tif (freed >= sc->nr_to_scan)\n\t\t\tbreak;\n\t\tif (drm_gem_shmem_is_purgeable(shmem) &&\n\t\t    panfrost_gem_purge(&shmem->base)) {\n\t\t\tfreed += shmem->base.size >> PAGE_SHIFT;\n\t\t\tlist_del_init(&shmem->madv_list);\n\t\t}\n\t}\n\n\tmutex_unlock(&pfdev->shrinker_lock);\n\n\tif (freed > 0)\n\t\tpr_info_ratelimited(\"Purging %lu bytes\\n\", freed << PAGE_SHIFT);\n\n\treturn freed;\n}\n\n \nvoid panfrost_gem_shrinker_init(struct drm_device *dev)\n{\n\tstruct panfrost_device *pfdev = dev->dev_private;\n\tpfdev->shrinker.count_objects = panfrost_gem_shrinker_count;\n\tpfdev->shrinker.scan_objects = panfrost_gem_shrinker_scan;\n\tpfdev->shrinker.seeks = DEFAULT_SEEKS;\n\tWARN_ON(register_shrinker(&pfdev->shrinker, \"drm-panfrost\"));\n}\n\n \nvoid panfrost_gem_shrinker_cleanup(struct drm_device *dev)\n{\n\tstruct panfrost_device *pfdev = dev->dev_private;\n\n\tif (pfdev->shrinker.nr_deferred) {\n\t\tunregister_shrinker(&pfdev->shrinker);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}