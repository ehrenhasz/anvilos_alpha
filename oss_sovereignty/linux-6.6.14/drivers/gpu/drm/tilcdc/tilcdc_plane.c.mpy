{
  "module_name": "tilcdc_plane.c",
  "hash_id": "9ea5d6dbcfa8ad38902a80b997d96f664637b00785a8aac255418a5c8af4c248",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/tilcdc/tilcdc_plane.c",
  "human_readable_source": "\n \n\n#include <drm/drm_atomic.h>\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n\n#include \"tilcdc_drv.h\"\n\nstatic const struct drm_plane_funcs tilcdc_plane_funcs = {\n\t.update_plane\t= drm_atomic_helper_update_plane,\n\t.disable_plane\t= drm_atomic_helper_disable_plane,\n\t.destroy\t= drm_plane_cleanup,\n\t.reset\t\t= drm_atomic_helper_plane_reset,\n\t.atomic_duplicate_state = drm_atomic_helper_plane_duplicate_state,\n\t.atomic_destroy_state = drm_atomic_helper_plane_destroy_state,\n};\n\nstatic int tilcdc_plane_atomic_check(struct drm_plane *plane,\n\t\t\t\t     struct drm_atomic_state *state)\n{\n\tstruct drm_plane_state *new_state = drm_atomic_get_new_plane_state(state,\n\t\t\t\t\t\t\t\t\t   plane);\n\tstruct drm_crtc_state *crtc_state;\n\tstruct drm_plane_state *old_state = drm_atomic_get_old_plane_state(state,\n\t\t\t\t\t\t\t\t\t   plane);\n\tunsigned int pitch;\n\n\tif (!new_state->crtc)\n\t\treturn 0;\n\n\tif (WARN_ON(!new_state->fb))\n\t\treturn -EINVAL;\n\n\tif (new_state->crtc_x || new_state->crtc_y) {\n\t\tdev_err(plane->dev->dev, \"%s: crtc position must be zero.\",\n\t\t\t__func__);\n\t\treturn -EINVAL;\n\t}\n\n\tcrtc_state = drm_atomic_get_existing_crtc_state(state,\n\t\t\t\t\t\t\tnew_state->crtc);\n\t \n\tif (WARN_ON(!crtc_state))\n\t\treturn 0;\n\n\tif (crtc_state->mode.hdisplay != new_state->crtc_w ||\n\t    crtc_state->mode.vdisplay != new_state->crtc_h) {\n\t\tdev_err(plane->dev->dev,\n\t\t\t\"%s: Size must match mode (%dx%d == %dx%d)\", __func__,\n\t\t\tcrtc_state->mode.hdisplay, crtc_state->mode.vdisplay,\n\t\t\tnew_state->crtc_w, new_state->crtc_h);\n\t\treturn -EINVAL;\n\t}\n\n\tpitch = crtc_state->mode.hdisplay *\n\t\tnew_state->fb->format->cpp[0];\n\tif (new_state->fb->pitches[0] != pitch) {\n\t\tdev_err(plane->dev->dev,\n\t\t\t\"Invalid pitch: fb and crtc widths must be the same\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (old_state->fb && new_state->fb->format != old_state->fb->format) {\n\t\tdev_dbg(plane->dev->dev,\n\t\t\t\"%s(): pixel format change requires mode_change\\n\",\n\t\t\t__func__);\n\t\tcrtc_state->mode_changed = true;\n\t}\n\n\treturn 0;\n}\n\nstatic void tilcdc_plane_atomic_update(struct drm_plane *plane,\n\t\t\t\t       struct drm_atomic_state *state)\n{\n\tstruct drm_plane_state *new_state = drm_atomic_get_new_plane_state(state,\n\t\t\t\t\t\t\t\t\t   plane);\n\n\tif (!new_state->crtc)\n\t\treturn;\n\n\tif (WARN_ON(!new_state->fb || !new_state->crtc->state))\n\t\treturn;\n\n\tif (tilcdc_crtc_update_fb(new_state->crtc,\n\t\t\t\t  new_state->fb,\n\t\t\t\t  new_state->crtc->state->event) == 0) {\n\t\tnew_state->crtc->state->event = NULL;\n\t}\n}\n\nstatic const struct drm_plane_helper_funcs plane_helper_funcs = {\n\t.atomic_check = tilcdc_plane_atomic_check,\n\t.atomic_update = tilcdc_plane_atomic_update,\n};\n\nint tilcdc_plane_init(struct drm_device *dev,\n\t\t      struct drm_plane *plane)\n{\n\tstruct tilcdc_drm_private *priv = dev->dev_private;\n\tint ret;\n\n\tret = drm_universal_plane_init(dev, plane, 1, &tilcdc_plane_funcs,\n\t\t\t\t       priv->pixelformats,\n\t\t\t\t       priv->num_pixelformats,\n\t\t\t\t       NULL, DRM_PLANE_TYPE_PRIMARY, NULL);\n\tif (ret) {\n\t\tdev_err(dev->dev, \"Failed to initialize plane: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tdrm_plane_helper_add(plane, &plane_helper_funcs);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}