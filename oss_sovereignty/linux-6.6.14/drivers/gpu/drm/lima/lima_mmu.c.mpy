{
  "module_name": "lima_mmu.c",
  "hash_id": "263d36982fe04f25bf3515b32b515b023d79fd5cc8b887f23151cdb1848081a8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/lima/lima_mmu.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/iopoll.h>\n#include <linux/device.h>\n\n#include \"lima_device.h\"\n#include \"lima_mmu.h\"\n#include \"lima_vm.h\"\n#include \"lima_regs.h\"\n\n#define mmu_write(reg, data) writel(data, ip->iomem + reg)\n#define mmu_read(reg) readl(ip->iomem + reg)\n\n#define lima_mmu_send_command(cmd, addr, val, cond)\t     \\\n({\t\t\t\t\t\t\t     \\\n\tint __ret;\t\t\t\t\t     \\\n\t\t\t\t\t\t\t     \\\n\tmmu_write(LIMA_MMU_COMMAND, cmd);\t\t     \\\n\t__ret = readl_poll_timeout(ip->iomem + (addr), val,  \\\n\t\t\t\t  cond, 0, 100);\t     \\\n\tif (__ret)\t\t\t\t\t     \\\n\t\tdev_err(dev->dev,\t\t\t     \\\n\t\t\t\"mmu command %x timeout\\n\", cmd);    \\\n\t__ret;\t\t\t\t\t\t     \\\n})\n\nstatic irqreturn_t lima_mmu_irq_handler(int irq, void *data)\n{\n\tstruct lima_ip *ip = data;\n\tstruct lima_device *dev = ip->dev;\n\tu32 status = mmu_read(LIMA_MMU_INT_STATUS);\n\tstruct lima_sched_pipe *pipe;\n\n\t \n\tif (!status)\n\t\treturn IRQ_NONE;\n\n\tif (status & LIMA_MMU_INT_PAGE_FAULT) {\n\t\tu32 fault = mmu_read(LIMA_MMU_PAGE_FAULT_ADDR);\n\n\t\tdev_err(dev->dev, \"mmu page fault at 0x%x from bus id %d of type %s on %s\\n\",\n\t\t\tfault, LIMA_MMU_STATUS_BUS_ID(status),\n\t\t\tstatus & LIMA_MMU_STATUS_PAGE_FAULT_IS_WRITE ? \"write\" : \"read\",\n\t\t\tlima_ip_name(ip));\n\t}\n\n\tif (status & LIMA_MMU_INT_READ_BUS_ERROR)\n\t\tdev_err(dev->dev, \"mmu %s irq bus error\\n\", lima_ip_name(ip));\n\n\t \n\tmmu_write(LIMA_MMU_INT_MASK, 0);\n\tmmu_write(LIMA_MMU_INT_CLEAR, status);\n\n\tpipe = dev->pipe + (ip->id == lima_ip_gpmmu ? lima_pipe_gp : lima_pipe_pp);\n\tlima_sched_pipe_mmu_error(pipe);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int lima_mmu_hw_init(struct lima_ip *ip)\n{\n\tstruct lima_device *dev = ip->dev;\n\tint err;\n\tu32 v;\n\n\tmmu_write(LIMA_MMU_COMMAND, LIMA_MMU_COMMAND_HARD_RESET);\n\terr = lima_mmu_send_command(LIMA_MMU_COMMAND_HARD_RESET,\n\t\t\t\t    LIMA_MMU_DTE_ADDR, v, v == 0);\n\tif (err)\n\t\treturn err;\n\n\tmmu_write(LIMA_MMU_INT_MASK,\n\t\t  LIMA_MMU_INT_PAGE_FAULT | LIMA_MMU_INT_READ_BUS_ERROR);\n\tmmu_write(LIMA_MMU_DTE_ADDR, dev->empty_vm->pd.dma);\n\treturn lima_mmu_send_command(LIMA_MMU_COMMAND_ENABLE_PAGING,\n\t\t\t\t     LIMA_MMU_STATUS, v,\n\t\t\t\t     v & LIMA_MMU_STATUS_PAGING_ENABLED);\n}\n\nint lima_mmu_resume(struct lima_ip *ip)\n{\n\tif (ip->id == lima_ip_ppmmu_bcast)\n\t\treturn 0;\n\n\treturn lima_mmu_hw_init(ip);\n}\n\nvoid lima_mmu_suspend(struct lima_ip *ip)\n{\n\n}\n\nint lima_mmu_init(struct lima_ip *ip)\n{\n\tstruct lima_device *dev = ip->dev;\n\tint err;\n\n\tif (ip->id == lima_ip_ppmmu_bcast)\n\t\treturn 0;\n\n\tmmu_write(LIMA_MMU_DTE_ADDR, 0xCAFEBABE);\n\tif (mmu_read(LIMA_MMU_DTE_ADDR) != 0xCAFEB000) {\n\t\tdev_err(dev->dev, \"mmu %s dte write test fail\\n\", lima_ip_name(ip));\n\t\treturn -EIO;\n\t}\n\n\terr = devm_request_irq(dev->dev, ip->irq, lima_mmu_irq_handler,\n\t\t\t       IRQF_SHARED, lima_ip_name(ip), ip);\n\tif (err) {\n\t\tdev_err(dev->dev, \"mmu %s fail to request irq\\n\", lima_ip_name(ip));\n\t\treturn err;\n\t}\n\n\treturn lima_mmu_hw_init(ip);\n}\n\nvoid lima_mmu_fini(struct lima_ip *ip)\n{\n\n}\n\nvoid lima_mmu_flush_tlb(struct lima_ip *ip)\n{\n\tmmu_write(LIMA_MMU_COMMAND, LIMA_MMU_COMMAND_ZAP_CACHE);\n}\n\nvoid lima_mmu_switch_vm(struct lima_ip *ip, struct lima_vm *vm)\n{\n\tstruct lima_device *dev = ip->dev;\n\tu32 v;\n\n\tlima_mmu_send_command(LIMA_MMU_COMMAND_ENABLE_STALL,\n\t\t\t      LIMA_MMU_STATUS, v,\n\t\t\t      v & LIMA_MMU_STATUS_STALL_ACTIVE);\n\n\tmmu_write(LIMA_MMU_DTE_ADDR, vm->pd.dma);\n\n\t \n\tmmu_write(LIMA_MMU_COMMAND, LIMA_MMU_COMMAND_ZAP_CACHE);\n\n\tlima_mmu_send_command(LIMA_MMU_COMMAND_DISABLE_STALL,\n\t\t\t      LIMA_MMU_STATUS, v,\n\t\t\t      !(v & LIMA_MMU_STATUS_STALL_ACTIVE));\n}\n\nvoid lima_mmu_page_fault_resume(struct lima_ip *ip)\n{\n\tstruct lima_device *dev = ip->dev;\n\tu32 status = mmu_read(LIMA_MMU_STATUS);\n\tu32 v;\n\n\tif (status & LIMA_MMU_STATUS_PAGE_FAULT_ACTIVE) {\n\t\tdev_info(dev->dev, \"mmu resume\\n\");\n\n\t\tmmu_write(LIMA_MMU_INT_MASK, 0);\n\t\tmmu_write(LIMA_MMU_DTE_ADDR, 0xCAFEBABE);\n\t\tlima_mmu_send_command(LIMA_MMU_COMMAND_HARD_RESET,\n\t\t\t\t      LIMA_MMU_DTE_ADDR, v, v == 0);\n\t\tmmu_write(LIMA_MMU_INT_MASK, LIMA_MMU_INT_PAGE_FAULT | LIMA_MMU_INT_READ_BUS_ERROR);\n\t\tmmu_write(LIMA_MMU_DTE_ADDR, dev->empty_vm->pd.dma);\n\t\tlima_mmu_send_command(LIMA_MMU_COMMAND_ENABLE_PAGING,\n\t\t\t\t      LIMA_MMU_STATUS, v,\n\t\t\t\t      v & LIMA_MMU_STATUS_PAGING_ENABLED);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}