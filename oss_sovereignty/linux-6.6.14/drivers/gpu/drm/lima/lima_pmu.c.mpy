{
  "module_name": "lima_pmu.c",
  "hash_id": "e978f1b0037adbfa848299626346e1151d8d22d468c0bdbc817d6c03951a8d2e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/lima/lima_pmu.c",
  "human_readable_source": "\n \n\n#include <linux/iopoll.h>\n#include <linux/device.h>\n\n#include \"lima_device.h\"\n#include \"lima_pmu.h\"\n#include \"lima_regs.h\"\n\n#define pmu_write(reg, data) writel(data, ip->iomem + reg)\n#define pmu_read(reg) readl(ip->iomem + reg)\n\nstatic int lima_pmu_wait_cmd(struct lima_ip *ip)\n{\n\tstruct lima_device *dev = ip->dev;\n\tint err;\n\tu32 v;\n\n\terr = readl_poll_timeout(ip->iomem + LIMA_PMU_INT_RAWSTAT,\n\t\t\t\t v, v & LIMA_PMU_INT_CMD_MASK,\n\t\t\t\t 100, 100000);\n\tif (err) {\n\t\tdev_err(dev->dev, \"timeout wait pmu cmd\\n\");\n\t\treturn err;\n\t}\n\n\tpmu_write(LIMA_PMU_INT_CLEAR, LIMA_PMU_INT_CMD_MASK);\n\treturn 0;\n}\n\nstatic u32 lima_pmu_get_ip_mask(struct lima_ip *ip)\n{\n\tstruct lima_device *dev = ip->dev;\n\tu32 ret = 0;\n\tint i;\n\n\tret |= LIMA_PMU_POWER_GP0_MASK;\n\n\tif (dev->id == lima_gpu_mali400) {\n\t\tret |= LIMA_PMU_POWER_L2_MASK;\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tif (dev->ip[lima_ip_pp0 + i].present)\n\t\t\t\tret |= LIMA_PMU_POWER_PP_MASK(i);\n\t\t}\n\t} else {\n\t\tif (dev->ip[lima_ip_pp0].present)\n\t\t\tret |= LIMA450_PMU_POWER_PP0_MASK;\n\t\tfor (i = lima_ip_pp1; i <= lima_ip_pp3; i++) {\n\t\t\tif (dev->ip[i].present) {\n\t\t\t\tret |= LIMA450_PMU_POWER_PP13_MASK;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tfor (i = lima_ip_pp4; i <= lima_ip_pp7; i++) {\n\t\t\tif (dev->ip[i].present) {\n\t\t\t\tret |= LIMA450_PMU_POWER_PP47_MASK;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic int lima_pmu_hw_init(struct lima_ip *ip)\n{\n\tint err;\n\tu32 stat;\n\n\tpmu_write(LIMA_PMU_INT_MASK, 0);\n\n\t \n\tpmu_write(LIMA_PMU_SW_DELAY, 0xffff);\n\n\t \n\tstat = pmu_read(LIMA_PMU_STATUS);\n\n\t \n\tif (stat) {\n\t\tpmu_write(LIMA_PMU_POWER_UP, stat);\n\t\terr = lima_pmu_wait_cmd(ip);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\treturn 0;\n}\n\nstatic void lima_pmu_hw_fini(struct lima_ip *ip)\n{\n\tu32 stat;\n\n\tif (!ip->data.mask)\n\t\tip->data.mask = lima_pmu_get_ip_mask(ip);\n\n\tstat = ~pmu_read(LIMA_PMU_STATUS) & ip->data.mask;\n\tif (stat) {\n\t\tpmu_write(LIMA_PMU_POWER_DOWN, stat);\n\n\t\t \n\t\tif (ip->dev->id == lima_gpu_mali400)\n\t\t\tpmu_write(LIMA_PMU_INT_CLEAR, LIMA_PMU_INT_CMD_MASK);\n\t\telse\n\t\t\tlima_pmu_wait_cmd(ip);\n\t}\n}\n\nint lima_pmu_resume(struct lima_ip *ip)\n{\n\treturn lima_pmu_hw_init(ip);\n}\n\nvoid lima_pmu_suspend(struct lima_ip *ip)\n{\n\tlima_pmu_hw_fini(ip);\n}\n\nint lima_pmu_init(struct lima_ip *ip)\n{\n\treturn lima_pmu_hw_init(ip);\n}\n\nvoid lima_pmu_fini(struct lima_ip *ip)\n{\n\tlima_pmu_hw_fini(ip);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}