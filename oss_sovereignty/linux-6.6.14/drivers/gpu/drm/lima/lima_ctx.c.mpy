{
  "module_name": "lima_ctx.c",
  "hash_id": "87cef1c4522a94b7c29f7bc7d9c2d5c726144cf684afb7a54832cabaa0f93afb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/lima/lima_ctx.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n\n#include \"lima_device.h\"\n#include \"lima_ctx.h\"\n\nint lima_ctx_create(struct lima_device *dev, struct lima_ctx_mgr *mgr, u32 *id)\n{\n\tstruct lima_ctx *ctx;\n\tint i, err;\n\n\tctx = kzalloc(sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\tctx->dev = dev;\n\tkref_init(&ctx->refcnt);\n\n\tfor (i = 0; i < lima_pipe_num; i++) {\n\t\terr = lima_sched_context_init(dev->pipe + i, ctx->context + i, &ctx->guilty);\n\t\tif (err)\n\t\t\tgoto err_out0;\n\t}\n\n\terr = xa_alloc(&mgr->handles, id, ctx, xa_limit_32b, GFP_KERNEL);\n\tif (err < 0)\n\t\tgoto err_out0;\n\n\tctx->pid = task_pid_nr(current);\n\tget_task_comm(ctx->pname, current);\n\n\treturn 0;\n\nerr_out0:\n\tfor (i--; i >= 0; i--)\n\t\tlima_sched_context_fini(dev->pipe + i, ctx->context + i);\n\tkfree(ctx);\n\treturn err;\n}\n\nstatic void lima_ctx_do_release(struct kref *ref)\n{\n\tstruct lima_ctx *ctx = container_of(ref, struct lima_ctx, refcnt);\n\tint i;\n\n\tfor (i = 0; i < lima_pipe_num; i++)\n\t\tlima_sched_context_fini(ctx->dev->pipe + i, ctx->context + i);\n\tkfree(ctx);\n}\n\nint lima_ctx_free(struct lima_ctx_mgr *mgr, u32 id)\n{\n\tstruct lima_ctx *ctx;\n\tint ret = 0;\n\n\tmutex_lock(&mgr->lock);\n\tctx = xa_erase(&mgr->handles, id);\n\tif (ctx)\n\t\tkref_put(&ctx->refcnt, lima_ctx_do_release);\n\telse\n\t\tret = -EINVAL;\n\tmutex_unlock(&mgr->lock);\n\treturn ret;\n}\n\nstruct lima_ctx *lima_ctx_get(struct lima_ctx_mgr *mgr, u32 id)\n{\n\tstruct lima_ctx *ctx;\n\n\tmutex_lock(&mgr->lock);\n\tctx = xa_load(&mgr->handles, id);\n\tif (ctx)\n\t\tkref_get(&ctx->refcnt);\n\tmutex_unlock(&mgr->lock);\n\treturn ctx;\n}\n\nvoid lima_ctx_put(struct lima_ctx *ctx)\n{\n\tkref_put(&ctx->refcnt, lima_ctx_do_release);\n}\n\nvoid lima_ctx_mgr_init(struct lima_ctx_mgr *mgr)\n{\n\tmutex_init(&mgr->lock);\n\txa_init_flags(&mgr->handles, XA_FLAGS_ALLOC);\n}\n\nvoid lima_ctx_mgr_fini(struct lima_ctx_mgr *mgr)\n{\n\tstruct lima_ctx *ctx;\n\tunsigned long id;\n\n\txa_for_each(&mgr->handles, id, ctx) {\n\t\tkref_put(&ctx->refcnt, lima_ctx_do_release);\n\t}\n\n\txa_destroy(&mgr->handles);\n\tmutex_destroy(&mgr->lock);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}