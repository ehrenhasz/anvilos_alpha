{
  "module_name": "tidss_drv.c",
  "hash_id": "3e60a7e9ed12e076befbca0f5ca3f495e3e034080ed3aed2762d7dd71567aee3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/tidss/tidss_drv.c",
  "human_readable_source": "\n \n\n#include <linux/console.h>\n#include <linux/of.h>\n#include <linux/module.h>\n#include <linux/pm_runtime.h>\n\n#include <drm/drm_atomic.h>\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_crtc.h>\n#include <drm/drm_drv.h>\n#include <drm/drm_fbdev_dma.h>\n#include <drm/drm_gem_dma_helper.h>\n#include <drm/drm_managed.h>\n#include <drm/drm_module.h>\n#include <drm/drm_probe_helper.h>\n\n#include \"tidss_dispc.h\"\n#include \"tidss_drv.h\"\n#include \"tidss_kms.h\"\n#include \"tidss_irq.h\"\n\n \n\nint tidss_runtime_get(struct tidss_device *tidss)\n{\n\tint r;\n\n\tdev_dbg(tidss->dev, \"%s\\n\", __func__);\n\n\tr = pm_runtime_get_sync(tidss->dev);\n\tWARN_ON(r < 0);\n\treturn r < 0 ? r : 0;\n}\n\nvoid tidss_runtime_put(struct tidss_device *tidss)\n{\n\tint r;\n\n\tdev_dbg(tidss->dev, \"%s\\n\", __func__);\n\n\tr = pm_runtime_put_sync(tidss->dev);\n\tWARN_ON(r < 0);\n}\n\nstatic int __maybe_unused tidss_pm_runtime_suspend(struct device *dev)\n{\n\tstruct tidss_device *tidss = dev_get_drvdata(dev);\n\n\tdev_dbg(dev, \"%s\\n\", __func__);\n\n\treturn dispc_runtime_suspend(tidss->dispc);\n}\n\nstatic int __maybe_unused tidss_pm_runtime_resume(struct device *dev)\n{\n\tstruct tidss_device *tidss = dev_get_drvdata(dev);\n\tint r;\n\n\tdev_dbg(dev, \"%s\\n\", __func__);\n\n\tr = dispc_runtime_resume(tidss->dispc);\n\tif (r)\n\t\treturn r;\n\n\treturn 0;\n}\n\nstatic int __maybe_unused tidss_suspend(struct device *dev)\n{\n\tstruct tidss_device *tidss = dev_get_drvdata(dev);\n\n\tdev_dbg(dev, \"%s\\n\", __func__);\n\n\treturn drm_mode_config_helper_suspend(&tidss->ddev);\n}\n\nstatic int __maybe_unused tidss_resume(struct device *dev)\n{\n\tstruct tidss_device *tidss = dev_get_drvdata(dev);\n\n\tdev_dbg(dev, \"%s\\n\", __func__);\n\n\treturn drm_mode_config_helper_resume(&tidss->ddev);\n}\n\nstatic __maybe_unused const struct dev_pm_ops tidss_pm_ops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(tidss_suspend, tidss_resume)\n\tSET_RUNTIME_PM_OPS(tidss_pm_runtime_suspend, tidss_pm_runtime_resume, NULL)\n};\n\n \n\nstatic void tidss_release(struct drm_device *ddev)\n{\n\tdrm_kms_helper_poll_fini(ddev);\n}\n\nDEFINE_DRM_GEM_DMA_FOPS(tidss_fops);\n\nstatic const struct drm_driver tidss_driver = {\n\t.driver_features\t= DRIVER_GEM | DRIVER_MODESET | DRIVER_ATOMIC,\n\t.fops\t\t\t= &tidss_fops,\n\t.release\t\t= tidss_release,\n\tDRM_GEM_DMA_DRIVER_OPS_VMAP,\n\t.name\t\t\t= \"tidss\",\n\t.desc\t\t\t= \"TI Keystone DSS\",\n\t.date\t\t\t= \"20180215\",\n\t.major\t\t\t= 1,\n\t.minor\t\t\t= 0,\n};\n\nstatic int tidss_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct tidss_device *tidss;\n\tstruct drm_device *ddev;\n\tint ret;\n\tint irq;\n\n\tdev_dbg(dev, \"%s\\n\", __func__);\n\n\ttidss = devm_drm_dev_alloc(&pdev->dev, &tidss_driver,\n\t\t\t\t   struct tidss_device, ddev);\n\tif (IS_ERR(tidss))\n\t\treturn PTR_ERR(tidss);\n\n\tddev = &tidss->ddev;\n\n\ttidss->dev = dev;\n\ttidss->feat = of_device_get_match_data(dev);\n\n\tplatform_set_drvdata(pdev, tidss);\n\n\tret = dispc_init(tidss);\n\tif (ret) {\n\t\tdev_err(dev, \"failed to initialize dispc: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tpm_runtime_enable(dev);\n\n#ifndef CONFIG_PM\n\t \n\tdispc_runtime_resume(tidss->dispc);\n#endif\n\n\tret = tidss_modeset_init(tidss);\n\tif (ret < 0) {\n\t\tif (ret != -EPROBE_DEFER)\n\t\t\tdev_err(dev, \"failed to init DRM/KMS (%d)\\n\", ret);\n\t\tgoto err_runtime_suspend;\n\t}\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0) {\n\t\tret = irq;\n\t\tgoto err_runtime_suspend;\n\t}\n\ttidss->irq = irq;\n\n\tret = tidss_irq_install(ddev, irq);\n\tif (ret) {\n\t\tdev_err(dev, \"tidss_irq_install failed: %d\\n\", ret);\n\t\tgoto err_runtime_suspend;\n\t}\n\n\tdrm_kms_helper_poll_init(ddev);\n\n\tdrm_mode_config_reset(ddev);\n\n\tret = drm_dev_register(ddev, 0);\n\tif (ret) {\n\t\tdev_err(dev, \"failed to register DRM device\\n\");\n\t\tgoto err_irq_uninstall;\n\t}\n\n\tdrm_fbdev_dma_setup(ddev, 32);\n\n\tdev_dbg(dev, \"%s done\\n\", __func__);\n\n\treturn 0;\n\nerr_irq_uninstall:\n\ttidss_irq_uninstall(ddev);\n\nerr_runtime_suspend:\n#ifndef CONFIG_PM\n\tdispc_runtime_suspend(tidss->dispc);\n#endif\n\tpm_runtime_disable(dev);\n\n\treturn ret;\n}\n\nstatic void tidss_remove(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct tidss_device *tidss = platform_get_drvdata(pdev);\n\tstruct drm_device *ddev = &tidss->ddev;\n\n\tdev_dbg(dev, \"%s\\n\", __func__);\n\n\tdrm_dev_unregister(ddev);\n\n\tdrm_atomic_helper_shutdown(ddev);\n\n\ttidss_irq_uninstall(ddev);\n\n#ifndef CONFIG_PM\n\t \n\tdispc_runtime_suspend(tidss->dispc);\n#endif\n\tpm_runtime_disable(dev);\n\n\t \n\tdispc_remove(tidss);\n\n\tdev_dbg(dev, \"%s done\\n\", __func__);\n}\n\nstatic void tidss_shutdown(struct platform_device *pdev)\n{\n\tdrm_atomic_helper_shutdown(platform_get_drvdata(pdev));\n}\n\nstatic const struct of_device_id tidss_of_table[] = {\n\t{ .compatible = \"ti,k2g-dss\", .data = &dispc_k2g_feats, },\n\t{ .compatible = \"ti,am625-dss\", .data = &dispc_am625_feats, },\n\t{ .compatible = \"ti,am65x-dss\", .data = &dispc_am65x_feats, },\n\t{ .compatible = \"ti,j721e-dss\", .data = &dispc_j721e_feats, },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(of, tidss_of_table);\n\nstatic struct platform_driver tidss_platform_driver = {\n\t.probe\t\t= tidss_probe,\n\t.remove_new\t= tidss_remove,\n\t.shutdown\t= tidss_shutdown,\n\t.driver\t\t= {\n\t\t.name\t= \"tidss\",\n\t\t.pm\t= pm_ptr(&tidss_pm_ops),\n\t\t.of_match_table = tidss_of_table,\n\t\t.suppress_bind_attrs = true,\n\t},\n};\n\ndrm_module_platform_driver(tidss_platform_driver);\n\nMODULE_AUTHOR(\"Tomi Valkeinen <tomi.valkeinen@ti.com>\");\nMODULE_DESCRIPTION(\"TI Keystone DSS Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}