{
  "module_name": "tidss_plane.c",
  "hash_id": "fc87d05f8035d0bc5588d672587e4f48262ff1bfe8f07a09c80f57c71cd1db15",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/tidss/tidss_plane.c",
  "human_readable_source": "\n \n\n#include <drm/drm_atomic.h>\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_blend.h>\n#include <drm/drm_crtc.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem_atomic_helper.h>\n\n#include \"tidss_crtc.h\"\n#include \"tidss_dispc.h\"\n#include \"tidss_drv.h\"\n#include \"tidss_plane.h\"\n\n \n\nstatic int tidss_plane_atomic_check(struct drm_plane *plane,\n\t\t\t\t    struct drm_atomic_state *state)\n{\n\tstruct drm_plane_state *new_plane_state = drm_atomic_get_new_plane_state(state,\n\t\t\t\t\t\t\t\t\t\t plane);\n\tstruct drm_device *ddev = plane->dev;\n\tstruct tidss_device *tidss = to_tidss(ddev);\n\tstruct tidss_plane *tplane = to_tidss_plane(plane);\n\tconst struct drm_format_info *finfo;\n\tstruct drm_crtc_state *crtc_state;\n\tu32 hw_plane = tplane->hw_plane_id;\n\tu32 hw_videoport;\n\tint ret;\n\n\tdev_dbg(ddev->dev, \"%s\\n\", __func__);\n\n\tif (!new_plane_state->crtc) {\n\t\t \n\t\tnew_plane_state->visible = false;\n\t\treturn 0;\n\t}\n\n\tcrtc_state = drm_atomic_get_crtc_state(state,\n\t\t\t\t\t       new_plane_state->crtc);\n\tif (IS_ERR(crtc_state))\n\t\treturn PTR_ERR(crtc_state);\n\n\tret = drm_atomic_helper_check_plane_state(new_plane_state, crtc_state,\n\t\t\t\t\t\t  0,\n\t\t\t\t\t\t  INT_MAX, true, true);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\n\tfinfo = drm_format_info(new_plane_state->fb->format->format);\n\n\tif ((new_plane_state->src_x >> 16) % finfo->hsub != 0) {\n\t\tdev_dbg(ddev->dev,\n\t\t\t\"%s: x-position %u not divisible subpixel size %u\\n\",\n\t\t\t__func__, (new_plane_state->src_x >> 16), finfo->hsub);\n\t\treturn -EINVAL;\n\t}\n\n\tif ((new_plane_state->src_y >> 16) % finfo->vsub != 0) {\n\t\tdev_dbg(ddev->dev,\n\t\t\t\"%s: y-position %u not divisible subpixel size %u\\n\",\n\t\t\t__func__, (new_plane_state->src_y >> 16), finfo->vsub);\n\t\treturn -EINVAL;\n\t}\n\n\tif ((new_plane_state->src_w >> 16) % finfo->hsub != 0) {\n\t\tdev_dbg(ddev->dev,\n\t\t\t\"%s: src width %u not divisible by subpixel size %u\\n\",\n\t\t\t __func__, (new_plane_state->src_w >> 16),\n\t\t\t finfo->hsub);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!new_plane_state->visible)\n\t\treturn 0;\n\n\thw_videoport = to_tidss_crtc(new_plane_state->crtc)->hw_videoport;\n\n\tret = dispc_plane_check(tidss->dispc, hw_plane, new_plane_state,\n\t\t\t\thw_videoport);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic void tidss_plane_atomic_update(struct drm_plane *plane,\n\t\t\t\t      struct drm_atomic_state *state)\n{\n\tstruct drm_device *ddev = plane->dev;\n\tstruct tidss_device *tidss = to_tidss(ddev);\n\tstruct tidss_plane *tplane = to_tidss_plane(plane);\n\tstruct drm_plane_state *new_state = drm_atomic_get_new_plane_state(state,\n\t\t\t\t\t\t\t\t\t   plane);\n\tu32 hw_videoport;\n\n\tdev_dbg(ddev->dev, \"%s\\n\", __func__);\n\n\tif (!new_state->visible) {\n\t\tdispc_plane_enable(tidss->dispc, tplane->hw_plane_id, false);\n\t\treturn;\n\t}\n\n\thw_videoport = to_tidss_crtc(new_state->crtc)->hw_videoport;\n\n\tdispc_plane_setup(tidss->dispc, tplane->hw_plane_id, new_state, hw_videoport);\n}\n\nstatic void tidss_plane_atomic_enable(struct drm_plane *plane,\n\t\t\t\t      struct drm_atomic_state *state)\n{\n\tstruct drm_device *ddev = plane->dev;\n\tstruct tidss_device *tidss = to_tidss(ddev);\n\tstruct tidss_plane *tplane = to_tidss_plane(plane);\n\n\tdev_dbg(ddev->dev, \"%s\\n\", __func__);\n\n\tdispc_plane_enable(tidss->dispc, tplane->hw_plane_id, true);\n}\n\nstatic void tidss_plane_atomic_disable(struct drm_plane *plane,\n\t\t\t\t       struct drm_atomic_state *state)\n{\n\tstruct drm_device *ddev = plane->dev;\n\tstruct tidss_device *tidss = to_tidss(ddev);\n\tstruct tidss_plane *tplane = to_tidss_plane(plane);\n\n\tdev_dbg(ddev->dev, \"%s\\n\", __func__);\n\n\tdispc_plane_enable(tidss->dispc, tplane->hw_plane_id, false);\n}\n\nstatic void drm_plane_destroy(struct drm_plane *plane)\n{\n\tstruct tidss_plane *tplane = to_tidss_plane(plane);\n\n\tdrm_plane_cleanup(plane);\n\tkfree(tplane);\n}\n\nstatic const struct drm_plane_helper_funcs tidss_plane_helper_funcs = {\n\t.atomic_check = tidss_plane_atomic_check,\n\t.atomic_update = tidss_plane_atomic_update,\n\t.atomic_enable = tidss_plane_atomic_enable,\n\t.atomic_disable = tidss_plane_atomic_disable,\n};\n\nstatic const struct drm_plane_funcs tidss_plane_funcs = {\n\t.update_plane = drm_atomic_helper_update_plane,\n\t.disable_plane = drm_atomic_helper_disable_plane,\n\t.reset = drm_atomic_helper_plane_reset,\n\t.destroy = drm_plane_destroy,\n\t.atomic_duplicate_state = drm_atomic_helper_plane_duplicate_state,\n\t.atomic_destroy_state = drm_atomic_helper_plane_destroy_state,\n};\n\nstruct tidss_plane *tidss_plane_create(struct tidss_device *tidss,\n\t\t\t\t       u32 hw_plane_id, u32 plane_type,\n\t\t\t\t       u32 crtc_mask, const u32 *formats,\n\t\t\t\t       u32 num_formats)\n{\n\tstruct tidss_plane *tplane;\n\tenum drm_plane_type type;\n\tu32 possible_crtcs;\n\tu32 num_planes = tidss->feat->num_planes;\n\tu32 color_encodings = (BIT(DRM_COLOR_YCBCR_BT601) |\n\t\t\t       BIT(DRM_COLOR_YCBCR_BT709));\n\tu32 color_ranges = (BIT(DRM_COLOR_YCBCR_FULL_RANGE) |\n\t\t\t    BIT(DRM_COLOR_YCBCR_LIMITED_RANGE));\n\tu32 default_encoding = DRM_COLOR_YCBCR_BT601;\n\tu32 default_range = DRM_COLOR_YCBCR_FULL_RANGE;\n\tu32 blend_modes = (BIT(DRM_MODE_BLEND_PREMULTI) |\n\t\t\t   BIT(DRM_MODE_BLEND_COVERAGE));\n\tint ret;\n\n\ttplane = kzalloc(sizeof(*tplane), GFP_KERNEL);\n\tif (!tplane)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\ttplane->hw_plane_id = hw_plane_id;\n\n\tpossible_crtcs = crtc_mask;\n\ttype = plane_type;\n\n\tret = drm_universal_plane_init(&tidss->ddev, &tplane->plane,\n\t\t\t\t       possible_crtcs,\n\t\t\t\t       &tidss_plane_funcs,\n\t\t\t\t       formats, num_formats,\n\t\t\t\t       NULL, type, NULL);\n\tif (ret < 0)\n\t\tgoto err;\n\n\tdrm_plane_helper_add(&tplane->plane, &tidss_plane_helper_funcs);\n\n\tdrm_plane_create_zpos_property(&tplane->plane, hw_plane_id, 0,\n\t\t\t\t       num_planes - 1);\n\n\tret = drm_plane_create_color_properties(&tplane->plane,\n\t\t\t\t\t\tcolor_encodings,\n\t\t\t\t\t\tcolor_ranges,\n\t\t\t\t\t\tdefault_encoding,\n\t\t\t\t\t\tdefault_range);\n\tif (ret)\n\t\tgoto err;\n\n\tret = drm_plane_create_alpha_property(&tplane->plane);\n\tif (ret)\n\t\tgoto err;\n\n\tret = drm_plane_create_blend_mode_property(&tplane->plane, blend_modes);\n\tif (ret)\n\t\tgoto err;\n\n\treturn tplane;\n\nerr:\n\tkfree(tplane);\n\treturn ERR_PTR(ret);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}