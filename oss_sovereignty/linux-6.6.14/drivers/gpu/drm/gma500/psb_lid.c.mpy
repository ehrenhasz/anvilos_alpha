{
  "module_name": "psb_lid.c",
  "hash_id": "0d7507e12ff76474a4d6bea39d23842c8c44c455f6553425ace0e5a270056707",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/gma500/psb_lid.c",
  "human_readable_source": "\n \n\n#include <linux/spinlock.h>\n\n#include \"psb_drv.h\"\n#include \"psb_intel_reg.h\"\n#include \"psb_reg.h\"\n\nstatic void psb_lid_timer_func(struct timer_list *t)\n{\n\tstruct drm_psb_private *dev_priv = from_timer(dev_priv, t, lid_timer);\n\tstruct drm_device *dev = (struct drm_device *)&dev_priv->dev;\n\tstruct timer_list *lid_timer = &dev_priv->lid_timer;\n\tunsigned long irq_flags;\n\tu32 __iomem *lid_state = dev_priv->opregion.lid_state;\n\tu32 pp_status;\n\n\tif (readl(lid_state) == dev_priv->lid_last_state)\n\t\tgoto lid_timer_schedule;\n\n\tif ((readl(lid_state)) & 0x01) {\n\t\t \n\t\tREG_WRITE(PP_CONTROL, REG_READ(PP_CONTROL) | POWER_TARGET_ON);\n\t\tdo {\n\t\t\tpp_status = REG_READ(PP_STATUS);\n\t\t} while ((pp_status & PP_ON) == 0 &&\n\t\t\t (pp_status & PP_SEQUENCE_MASK) != 0);\n\n\t\tif (REG_READ(PP_STATUS) & PP_ON) {\n\t\t\t \n\t\t\tpsb_intel_lvds_set_brightness(dev, 100);\n\t\t} else {\n\t\t\tDRM_DEBUG(\"LVDS panel never powered up\");\n\t\t\treturn;\n\t\t}\n\t} else {\n\t\tpsb_intel_lvds_set_brightness(dev, 0);\n\n\t\tREG_WRITE(PP_CONTROL, REG_READ(PP_CONTROL) & ~POWER_TARGET_ON);\n\t\tdo {\n\t\t\tpp_status = REG_READ(PP_STATUS);\n\t\t} while ((pp_status & PP_ON) == 0);\n\t}\n\tdev_priv->lid_last_state =  readl(lid_state);\n\nlid_timer_schedule:\n\tspin_lock_irqsave(&dev_priv->lid_lock, irq_flags);\n\tif (!timer_pending(lid_timer)) {\n\t\tlid_timer->expires = jiffies + PSB_LID_DELAY;\n\t\tadd_timer(lid_timer);\n\t}\n\tspin_unlock_irqrestore(&dev_priv->lid_lock, irq_flags);\n}\n\nvoid psb_lid_timer_init(struct drm_psb_private *dev_priv)\n{\n\tstruct timer_list *lid_timer = &dev_priv->lid_timer;\n\tunsigned long irq_flags;\n\n\tspin_lock_init(&dev_priv->lid_lock);\n\tspin_lock_irqsave(&dev_priv->lid_lock, irq_flags);\n\n\ttimer_setup(lid_timer, psb_lid_timer_func, 0);\n\n\tlid_timer->expires = jiffies + PSB_LID_DELAY;\n\n\tadd_timer(lid_timer);\n\tspin_unlock_irqrestore(&dev_priv->lid_lock, irq_flags);\n}\n\nvoid psb_lid_timer_takedown(struct drm_psb_private *dev_priv)\n{\n\tdel_timer_sync(&dev_priv->lid_timer);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}