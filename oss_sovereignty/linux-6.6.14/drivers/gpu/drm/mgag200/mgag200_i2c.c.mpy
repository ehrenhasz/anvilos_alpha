{
  "module_name": "mgag200_i2c.c",
  "hash_id": "f5a043739a31c3b924762d3fd13c823451496d5cf675d6679a2aa4a853c543e0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/mgag200/mgag200_i2c.c",
  "human_readable_source": " \n \n\n#include <linux/export.h>\n#include <linux/i2c-algo-bit.h>\n#include <linux/i2c.h>\n#include <linux/pci.h>\n\n#include \"mgag200_drv.h\"\n\nstatic int mga_i2c_read_gpio(struct mga_device *mdev)\n{\n\tWREG8(DAC_INDEX, MGA1064_GEN_IO_DATA);\n\treturn RREG8(DAC_DATA);\n}\n\nstatic void mga_i2c_set_gpio(struct mga_device *mdev, int mask, int val)\n{\n\tint tmp;\n\n\tWREG8(DAC_INDEX, MGA1064_GEN_IO_CTL);\n\ttmp = (RREG8(DAC_DATA) & mask) | val;\n\tWREG_DAC(MGA1064_GEN_IO_CTL, tmp);\n\tWREG_DAC(MGA1064_GEN_IO_DATA, 0);\n}\n\nstatic inline void mga_i2c_set(struct mga_device *mdev, int mask, int state)\n{\n\tif (state)\n\t\tstate = 0;\n\telse\n\t\tstate = mask;\n\tmga_i2c_set_gpio(mdev, ~mask, state);\n}\n\nstatic void mga_gpio_setsda(void *data, int state)\n{\n\tstruct mga_i2c_chan *i2c = data;\n\tstruct mga_device *mdev = to_mga_device(i2c->dev);\n\tmga_i2c_set(mdev, i2c->data, state);\n}\n\nstatic void mga_gpio_setscl(void *data, int state)\n{\n\tstruct mga_i2c_chan *i2c = data;\n\tstruct mga_device *mdev = to_mga_device(i2c->dev);\n\tmga_i2c_set(mdev, i2c->clock, state);\n}\n\nstatic int mga_gpio_getsda(void *data)\n{\n\tstruct mga_i2c_chan *i2c = data;\n\tstruct mga_device *mdev = to_mga_device(i2c->dev);\n\treturn (mga_i2c_read_gpio(mdev) & i2c->data) ? 1 : 0;\n}\n\nstatic int mga_gpio_getscl(void *data)\n{\n\tstruct mga_i2c_chan *i2c = data;\n\tstruct mga_device *mdev = to_mga_device(i2c->dev);\n\treturn (mga_i2c_read_gpio(mdev) & i2c->clock) ? 1 : 0;\n}\n\nstatic void mgag200_i2c_release(void *res)\n{\n\tstruct mga_i2c_chan *i2c = res;\n\n\ti2c_del_adapter(&i2c->adapter);\n}\n\nint mgag200_i2c_init(struct mga_device *mdev, struct mga_i2c_chan *i2c)\n{\n\tstruct drm_device *dev = &mdev->base;\n\tconst struct mgag200_device_info *info = mdev->info;\n\tint ret;\n\n\tWREG_DAC(MGA1064_GEN_IO_CTL2, 1);\n\tWREG_DAC(MGA1064_GEN_IO_DATA, 0xff);\n\tWREG_DAC(MGA1064_GEN_IO_CTL, 0);\n\n\ti2c->data = BIT(info->i2c.data_bit);\n\ti2c->clock = BIT(info->i2c.clock_bit);\n\ti2c->adapter.owner = THIS_MODULE;\n\ti2c->adapter.class = I2C_CLASS_DDC;\n\ti2c->adapter.dev.parent = dev->dev;\n\ti2c->dev = dev;\n\ti2c_set_adapdata(&i2c->adapter, i2c);\n\tsnprintf(i2c->adapter.name, sizeof(i2c->adapter.name), \"mga i2c\");\n\n\ti2c->adapter.algo_data = &i2c->bit;\n\n\ti2c->bit.udelay = 10;\n\ti2c->bit.timeout = 2;\n\ti2c->bit.data = i2c;\n\ti2c->bit.setsda\t\t= mga_gpio_setsda;\n\ti2c->bit.setscl\t\t= mga_gpio_setscl;\n\ti2c->bit.getsda\t\t= mga_gpio_getsda;\n\ti2c->bit.getscl\t\t= mga_gpio_getscl;\n\n\tret = i2c_bit_add_bus(&i2c->adapter);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_add_action_or_reset(dev->dev, mgag200_i2c_release, i2c);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}