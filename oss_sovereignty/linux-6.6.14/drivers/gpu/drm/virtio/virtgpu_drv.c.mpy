{
  "module_name": "virtgpu_drv.c",
  "hash_id": "0d8aa89c1d305f8e4830aefd51d3683116ecb948b052094cf5fc09352fb13a52",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/virtio/virtgpu_drv.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/poll.h>\n#include <linux/wait.h>\n\n#include <drm/drm.h>\n#include <drm/drm_aperture.h>\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_drv.h>\n#include <drm/drm_fbdev_generic.h>\n#include <drm/drm_file.h>\n\n#include \"virtgpu_drv.h\"\n\nstatic const struct drm_driver driver;\n\nstatic int virtio_gpu_modeset = -1;\n\nMODULE_PARM_DESC(modeset, \"Disable/Enable modesetting\");\nmodule_param_named(modeset, virtio_gpu_modeset, int, 0400);\n\nstatic int virtio_gpu_pci_quirk(struct drm_device *dev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev->dev);\n\tconst char *pname = dev_name(&pdev->dev);\n\tbool vga = (pdev->class >> 8) == PCI_CLASS_DISPLAY_VGA;\n\tint ret;\n\n\tDRM_INFO(\"pci: %s detected at %s\\n\",\n\t\t vga ? \"virtio-vga\" : \"virtio-gpu-pci\",\n\t\t pname);\n\tif (vga) {\n\t\tret = drm_aperture_remove_conflicting_pci_framebuffers(pdev, &driver);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int virtio_gpu_probe(struct virtio_device *vdev)\n{\n\tstruct drm_device *dev;\n\tint ret;\n\n\tif (drm_firmware_drivers_only() && virtio_gpu_modeset == -1)\n\t\treturn -EINVAL;\n\n\tif (virtio_gpu_modeset == 0)\n\t\treturn -EINVAL;\n\n\t \n\tdev = drm_dev_alloc(&driver, vdev->dev.parent);\n\tif (IS_ERR(dev))\n\t\treturn PTR_ERR(dev);\n\tvdev->priv = dev;\n\n\tif (dev_is_pci(vdev->dev.parent)) {\n\t\tret = virtio_gpu_pci_quirk(dev);\n\t\tif (ret)\n\t\t\tgoto err_free;\n\t}\n\n\tret = virtio_gpu_init(vdev, dev);\n\tif (ret)\n\t\tgoto err_free;\n\n\tret = drm_dev_register(dev, 0);\n\tif (ret)\n\t\tgoto err_deinit;\n\n\tdrm_fbdev_generic_setup(vdev->priv, 32);\n\treturn 0;\n\nerr_deinit:\n\tvirtio_gpu_deinit(dev);\nerr_free:\n\tdrm_dev_put(dev);\n\treturn ret;\n}\n\nstatic void virtio_gpu_remove(struct virtio_device *vdev)\n{\n\tstruct drm_device *dev = vdev->priv;\n\n\tdrm_dev_unplug(dev);\n\tdrm_atomic_helper_shutdown(dev);\n\tvirtio_gpu_deinit(dev);\n\tdrm_dev_put(dev);\n}\n\nstatic void virtio_gpu_config_changed(struct virtio_device *vdev)\n{\n\tstruct drm_device *dev = vdev->priv;\n\tstruct virtio_gpu_device *vgdev = dev->dev_private;\n\n\tschedule_work(&vgdev->config_changed_work);\n}\n\nstatic struct virtio_device_id id_table[] = {\n\t{ VIRTIO_ID_GPU, VIRTIO_DEV_ANY_ID },\n\t{ 0 },\n};\n\nstatic unsigned int features[] = {\n#ifdef __LITTLE_ENDIAN\n\t \n\tVIRTIO_GPU_F_VIRGL,\n#endif\n\tVIRTIO_GPU_F_EDID,\n\tVIRTIO_GPU_F_RESOURCE_UUID,\n\tVIRTIO_GPU_F_RESOURCE_BLOB,\n\tVIRTIO_GPU_F_CONTEXT_INIT,\n};\nstatic struct virtio_driver virtio_gpu_driver = {\n\t.feature_table = features,\n\t.feature_table_size = ARRAY_SIZE(features),\n\t.driver.name = KBUILD_MODNAME,\n\t.driver.owner = THIS_MODULE,\n\t.id_table = id_table,\n\t.probe = virtio_gpu_probe,\n\t.remove = virtio_gpu_remove,\n\t.config_changed = virtio_gpu_config_changed\n};\n\nmodule_virtio_driver(virtio_gpu_driver);\n\nMODULE_DEVICE_TABLE(virtio, id_table);\nMODULE_DESCRIPTION(\"Virtio GPU driver\");\nMODULE_LICENSE(\"GPL and additional rights\");\nMODULE_AUTHOR(\"Dave Airlie <airlied@redhat.com>\");\nMODULE_AUTHOR(\"Gerd Hoffmann <kraxel@redhat.com>\");\nMODULE_AUTHOR(\"Alon Levy\");\n\nDEFINE_DRM_GEM_FOPS(virtio_gpu_driver_fops);\n\nstatic const struct drm_driver driver = {\n\t \n\t.driver_features = DRIVER_MODESET | DRIVER_GEM | DRIVER_RENDER | DRIVER_ATOMIC |\n\t\t\t   DRIVER_SYNCOBJ | DRIVER_SYNCOBJ_TIMELINE,\n\t.open = virtio_gpu_driver_open,\n\t.postclose = virtio_gpu_driver_postclose,\n\n\t.dumb_create = virtio_gpu_mode_dumb_create,\n\t.dumb_map_offset = virtio_gpu_mode_dumb_mmap,\n\n#if defined(CONFIG_DEBUG_FS)\n\t.debugfs_init = virtio_gpu_debugfs_init,\n#endif\n\t.gem_prime_import = virtgpu_gem_prime_import,\n\t.gem_prime_import_sg_table = virtgpu_gem_prime_import_sg_table,\n\n\t.gem_create_object = virtio_gpu_create_object,\n\t.fops = &virtio_gpu_driver_fops,\n\n\t.ioctls = virtio_gpu_ioctls,\n\t.num_ioctls = DRM_VIRTIO_NUM_IOCTLS,\n\n\t.name = DRIVER_NAME,\n\t.desc = DRIVER_DESC,\n\t.date = DRIVER_DATE,\n\t.major = DRIVER_MAJOR,\n\t.minor = DRIVER_MINOR,\n\t.patchlevel = DRIVER_PATCHLEVEL,\n\n\t.release = virtio_gpu_release,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}