{
  "module_name": "virtgpu_prime.c",
  "hash_id": "75e0e119809df7a28f565e44e11de41103a432e9ca90aa20ff6d253bd8afe4b7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/virtio/virtgpu_prime.c",
  "human_readable_source": " \n\n#include <drm/drm_prime.h>\n#include <linux/virtio_dma_buf.h>\n\n#include \"virtgpu_drv.h\"\n\nstatic int virtgpu_virtio_get_uuid(struct dma_buf *buf,\n\t\t\t\t   uuid_t *uuid)\n{\n\tstruct drm_gem_object *obj = buf->priv;\n\tstruct virtio_gpu_object *bo = gem_to_virtio_gpu_obj(obj);\n\tstruct virtio_gpu_device *vgdev = obj->dev->dev_private;\n\n\twait_event(vgdev->resp_wq, bo->uuid_state != STATE_INITIALIZING);\n\tif (bo->uuid_state != STATE_OK)\n\t\treturn -ENODEV;\n\n\tuuid_copy(uuid, &bo->uuid);\n\n\treturn 0;\n}\n\nstatic struct sg_table *\nvirtgpu_gem_map_dma_buf(struct dma_buf_attachment *attach,\n\t\t\tenum dma_data_direction dir)\n{\n\tstruct drm_gem_object *obj = attach->dmabuf->priv;\n\tstruct virtio_gpu_object *bo = gem_to_virtio_gpu_obj(obj);\n\n\tif (virtio_gpu_is_vram(bo))\n\t\treturn virtio_gpu_vram_map_dma_buf(bo, attach->dev, dir);\n\n\treturn drm_gem_map_dma_buf(attach, dir);\n}\n\nstatic void virtgpu_gem_unmap_dma_buf(struct dma_buf_attachment *attach,\n\t\t\t\t      struct sg_table *sgt,\n\t\t\t\t      enum dma_data_direction dir)\n{\n\tstruct drm_gem_object *obj = attach->dmabuf->priv;\n\tstruct virtio_gpu_object *bo = gem_to_virtio_gpu_obj(obj);\n\n\tif (virtio_gpu_is_vram(bo)) {\n\t\tvirtio_gpu_vram_unmap_dma_buf(attach->dev, sgt, dir);\n\t\treturn;\n\t}\n\n\tdrm_gem_unmap_dma_buf(attach, sgt, dir);\n}\n\nstatic const struct virtio_dma_buf_ops virtgpu_dmabuf_ops =  {\n\t.ops = {\n\t\t.cache_sgt_mapping = true,\n\t\t.attach = virtio_dma_buf_attach,\n\t\t.detach = drm_gem_map_detach,\n\t\t.map_dma_buf = virtgpu_gem_map_dma_buf,\n\t\t.unmap_dma_buf = virtgpu_gem_unmap_dma_buf,\n\t\t.release = drm_gem_dmabuf_release,\n\t\t.mmap = drm_gem_dmabuf_mmap,\n\t\t.vmap = drm_gem_dmabuf_vmap,\n\t\t.vunmap = drm_gem_dmabuf_vunmap,\n\t},\n\t.device_attach = drm_gem_map_attach,\n\t.get_uuid = virtgpu_virtio_get_uuid,\n};\n\nint virtio_gpu_resource_assign_uuid(struct virtio_gpu_device *vgdev,\n\t\t\t\t    struct virtio_gpu_object *bo)\n{\n\tstruct virtio_gpu_object_array *objs;\n\n\tobjs = virtio_gpu_array_alloc(1);\n\tif (!objs)\n\t\treturn -ENOMEM;\n\n\tvirtio_gpu_array_add_obj(objs, &bo->base.base);\n\n\treturn virtio_gpu_cmd_resource_assign_uuid(vgdev, objs);\n}\n\nstruct dma_buf *virtgpu_gem_prime_export(struct drm_gem_object *obj,\n\t\t\t\t\t int flags)\n{\n\tstruct dma_buf *buf;\n\tstruct drm_device *dev = obj->dev;\n\tstruct virtio_gpu_device *vgdev = dev->dev_private;\n\tstruct virtio_gpu_object *bo = gem_to_virtio_gpu_obj(obj);\n\tint ret = 0;\n\tbool blob = bo->host3d_blob || bo->guest_blob;\n\tDEFINE_DMA_BUF_EXPORT_INFO(exp_info);\n\n\tif (!blob) {\n\t\tif (vgdev->has_resource_assign_uuid) {\n\t\t\tret = virtio_gpu_resource_assign_uuid(vgdev, bo);\n\t\t\tif (ret)\n\t\t\t\treturn ERR_PTR(ret);\n\n\t\t\tvirtio_gpu_notify(vgdev);\n\t\t} else {\n\t\t\tbo->uuid_state = STATE_ERR;\n\t\t}\n\t} else if (!(bo->blob_flags & VIRTGPU_BLOB_FLAG_USE_CROSS_DEVICE)) {\n\t\tbo->uuid_state = STATE_ERR;\n\t}\n\n\texp_info.ops = &virtgpu_dmabuf_ops.ops;\n\texp_info.size = obj->size;\n\texp_info.flags = flags;\n\texp_info.priv = obj;\n\texp_info.resv = obj->resv;\n\n\tbuf = virtio_dma_buf_export(&exp_info);\n\tif (IS_ERR(buf))\n\t\treturn buf;\n\n\tdrm_dev_get(dev);\n\tdrm_gem_object_get(obj);\n\n\treturn buf;\n}\n\nstruct drm_gem_object *virtgpu_gem_prime_import(struct drm_device *dev,\n\t\t\t\t\t\tstruct dma_buf *buf)\n{\n\tstruct drm_gem_object *obj;\n\n\tif (buf->ops == &virtgpu_dmabuf_ops.ops) {\n\t\tobj = buf->priv;\n\t\tif (obj->dev == dev) {\n\t\t\t \n\t\t\tdrm_gem_object_get(obj);\n\t\t\treturn obj;\n\t\t}\n\t}\n\n\treturn drm_gem_prime_import(dev, buf);\n}\n\nstruct drm_gem_object *virtgpu_gem_prime_import_sg_table(\n\tstruct drm_device *dev, struct dma_buf_attachment *attach,\n\tstruct sg_table *table)\n{\n\treturn ERR_PTR(-ENODEV);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}