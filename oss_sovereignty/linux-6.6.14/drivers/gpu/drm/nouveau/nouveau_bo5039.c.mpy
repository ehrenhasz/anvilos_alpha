{
  "module_name": "nouveau_bo5039.c",
  "hash_id": "796cc0eaf5a5d88efdaf742882ecce7235eece49ed5fa26cf38182d7b068664a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nouveau_bo5039.c",
  "human_readable_source": " \n \n#include \"nouveau_bo.h\"\n#include \"nouveau_dma.h\"\n#include \"nouveau_drv.h\"\n#include \"nouveau_mem.h\"\n\n#include <nvif/push206e.h>\n\n#include <nvhw/class/cl5039.h>\n\nint\nnv50_bo_move_m2mf(struct nouveau_channel *chan, struct ttm_buffer_object *bo,\n\t\t  struct ttm_resource *old_reg, struct ttm_resource *new_reg)\n{\n\tstruct nouveau_mem *mem = nouveau_mem(old_reg);\n\tstruct nvif_push *push = chan->chan.push;\n\tu64 length = new_reg->size;\n\tu64 src_offset = mem->vma[0].addr;\n\tu64 dst_offset = mem->vma[1].addr;\n\tint src_tiled = !!mem->kind;\n\tint dst_tiled = !!nouveau_mem(new_reg)->kind;\n\tint ret;\n\n\twhile (length) {\n\t\tu32 amount, stride, height;\n\n\t\tret = PUSH_WAIT(push, 18 + 6 * (src_tiled + dst_tiled));\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tamount  = min(length, (u64)(4 * 1024 * 1024));\n\t\tstride  = 16 * 4;\n\t\theight  = amount / stride;\n\n\t\tif (src_tiled) {\n\t\t\tPUSH_MTHD(push, NV5039, SET_SRC_MEMORY_LAYOUT,\n\t\t\t\t  NVDEF(NV5039, SET_SRC_MEMORY_LAYOUT, V, BLOCKLINEAR),\n\n\t\t\t\t\t\tSET_SRC_BLOCK_SIZE,\n\t\t\t\t  NVDEF(NV5039, SET_SRC_BLOCK_SIZE, WIDTH, ONE_GOB) |\n\t\t\t\t  NVDEF(NV5039, SET_SRC_BLOCK_SIZE, HEIGHT, ONE_GOB) |\n\t\t\t\t  NVDEF(NV5039, SET_SRC_BLOCK_SIZE, DEPTH, ONE_GOB),\n\n\t\t\t\t\t\tSET_SRC_WIDTH, stride,\n\t\t\t\t\t\tSET_SRC_HEIGHT, height,\n\t\t\t\t\t\tSET_SRC_DEPTH, 1,\n\t\t\t\t\t\tSET_SRC_LAYER, 0,\n\n\t\t\t\t\t\tSET_SRC_ORIGIN,\n\t\t\t\t  NVVAL(NV5039, SET_SRC_ORIGIN, X, 0) |\n\t\t\t\t  NVVAL(NV5039, SET_SRC_ORIGIN, Y, 0));\n\t\t} else {\n\t\t\tPUSH_MTHD(push, NV5039, SET_SRC_MEMORY_LAYOUT,\n\t\t\t\t  NVDEF(NV5039, SET_SRC_MEMORY_LAYOUT, V, PITCH));\n\t\t}\n\n\t\tif (dst_tiled) {\n\t\t\tPUSH_MTHD(push, NV5039, SET_DST_MEMORY_LAYOUT,\n\t\t\t\t  NVDEF(NV5039, SET_DST_MEMORY_LAYOUT, V, BLOCKLINEAR),\n\n\t\t\t\t\t\tSET_DST_BLOCK_SIZE,\n\t\t\t\t  NVDEF(NV5039, SET_DST_BLOCK_SIZE, WIDTH, ONE_GOB) |\n\t\t\t\t  NVDEF(NV5039, SET_DST_BLOCK_SIZE, HEIGHT, ONE_GOB) |\n\t\t\t\t  NVDEF(NV5039, SET_DST_BLOCK_SIZE, DEPTH, ONE_GOB),\n\n\t\t\t\t\t\tSET_DST_WIDTH, stride,\n\t\t\t\t\t\tSET_DST_HEIGHT, height,\n\t\t\t\t\t\tSET_DST_DEPTH, 1,\n\t\t\t\t\t\tSET_DST_LAYER, 0,\n\n\t\t\t\t\t\tSET_DST_ORIGIN,\n\t\t\t\t  NVVAL(NV5039, SET_DST_ORIGIN, X, 0) |\n\t\t\t\t  NVVAL(NV5039, SET_DST_ORIGIN, Y, 0));\n\t\t} else {\n\t\t\tPUSH_MTHD(push, NV5039, SET_DST_MEMORY_LAYOUT,\n\t\t\t\t  NVDEF(NV5039, SET_DST_MEMORY_LAYOUT, V, PITCH));\n\t\t}\n\n\t\tPUSH_MTHD(push, NV5039, OFFSET_IN_UPPER,\n\t\t\t  NVVAL(NV5039, OFFSET_IN_UPPER, VALUE, upper_32_bits(src_offset)),\n\n\t\t\t\t\tOFFSET_OUT_UPPER,\n\t\t\t  NVVAL(NV5039, OFFSET_OUT_UPPER, VALUE, upper_32_bits(dst_offset)));\n\n\t\tPUSH_MTHD(push, NV5039, OFFSET_IN, lower_32_bits(src_offset),\n\t\t\t\t\tOFFSET_OUT, lower_32_bits(dst_offset),\n\t\t\t\t\tPITCH_IN, stride,\n\t\t\t\t\tPITCH_OUT, stride,\n\t\t\t\t\tLINE_LENGTH_IN, stride,\n\t\t\t\t\tLINE_COUNT, height,\n\n\t\t\t\t\tFORMAT,\n\t\t\t  NVDEF(NV5039, FORMAT, IN, ONE) |\n\t\t\t  NVDEF(NV5039, FORMAT, OUT, ONE),\n\n\t\t\t\t\tBUFFER_NOTIFY,\n\t\t\t  NVDEF(NV5039, BUFFER_NOTIFY, TYPE, WRITE_ONLY));\n\n\t\tPUSH_MTHD(push, NV5039, NO_OPERATION, 0x00000000);\n\n\t\tlength -= amount;\n\t\tsrc_offset += amount;\n\t\tdst_offset += amount;\n\t}\n\n\treturn 0;\n}\n\nint\nnv50_bo_move_init(struct nouveau_channel *chan, u32 handle)\n{\n\tstruct nvif_push *push = chan->chan.push;\n\tint ret;\n\n\tret = PUSH_WAIT(push, 6);\n\tif (ret)\n\t\treturn ret;\n\n\tPUSH_MTHD(push, NV5039, SET_OBJECT, handle);\n\tPUSH_MTHD(push, NV5039, SET_CONTEXT_DMA_NOTIFY, chan->drm->ntfy.handle,\n\t\t\t\tSET_CONTEXT_DMA_BUFFER_IN, chan->vram.handle,\n\t\t\t\tSET_CONTEXT_DMA_BUFFER_OUT, chan->vram.handle);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}