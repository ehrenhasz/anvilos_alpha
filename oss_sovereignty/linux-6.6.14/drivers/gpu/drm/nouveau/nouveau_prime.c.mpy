{
  "module_name": "nouveau_prime.c",
  "hash_id": "0a2168e54e8468f0f7fafe441d8f1de083eaafeca59ec0ba38de06afe68ae105",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nouveau_prime.c",
  "human_readable_source": " \n\n#include <linux/dma-buf.h>\n#include <drm/ttm/ttm_tt.h>\n\n#include \"nouveau_drv.h\"\n#include \"nouveau_gem.h\"\n\nstruct sg_table *nouveau_gem_prime_get_sg_table(struct drm_gem_object *obj)\n{\n\tstruct nouveau_bo *nvbo = nouveau_gem_object(obj);\n\n\treturn drm_prime_pages_to_sg(obj->dev, nvbo->bo.ttm->pages,\n\t\t\t\t     nvbo->bo.ttm->num_pages);\n}\n\nstruct drm_gem_object *nouveau_gem_prime_import_sg_table(struct drm_device *dev,\n\t\t\t\t\t\t\t struct dma_buf_attachment *attach,\n\t\t\t\t\t\t\t struct sg_table *sg)\n{\n\tstruct nouveau_drm *drm = nouveau_drm(dev);\n\tstruct drm_gem_object *obj;\n\tstruct nouveau_bo *nvbo;\n\tstruct dma_resv *robj = attach->dmabuf->resv;\n\tu64 size = attach->dmabuf->size;\n\tint align = 0;\n\tint ret;\n\n\tdma_resv_lock(robj, NULL);\n\tnvbo = nouveau_bo_alloc(&drm->client, &size, &align,\n\t\t\t\tNOUVEAU_GEM_DOMAIN_GART, 0, 0, true);\n\tif (IS_ERR(nvbo)) {\n\t\tobj = ERR_CAST(nvbo);\n\t\tgoto unlock;\n\t}\n\n\tnvbo->valid_domains = NOUVEAU_GEM_DOMAIN_GART;\n\n\tnvbo->bo.base.funcs = &nouveau_gem_object_funcs;\n\n\t \n\tret = drm_gem_object_init(dev, &nvbo->bo.base, size);\n\tif (ret) {\n\t\tnouveau_bo_ref(NULL, &nvbo);\n\t\tobj = ERR_PTR(-ENOMEM);\n\t\tgoto unlock;\n\t}\n\n\tret = nouveau_bo_init(nvbo, size, align, NOUVEAU_GEM_DOMAIN_GART,\n\t\t\t      sg, robj);\n\tif (ret) {\n\t\tobj = ERR_PTR(ret);\n\t\tgoto unlock;\n\t}\n\n\tobj = &nvbo->bo.base;\n\nunlock:\n\tdma_resv_unlock(robj);\n\treturn obj;\n}\n\nint nouveau_gem_prime_pin(struct drm_gem_object *obj)\n{\n\tstruct nouveau_bo *nvbo = nouveau_gem_object(obj);\n\tint ret;\n\n\t \n\tret = nouveau_bo_pin(nvbo, NOUVEAU_GEM_DOMAIN_GART, false);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nvoid nouveau_gem_prime_unpin(struct drm_gem_object *obj)\n{\n\tstruct nouveau_bo *nvbo = nouveau_gem_object(obj);\n\n\tnouveau_bo_unpin(nvbo);\n}\n\nstruct dma_buf *nouveau_gem_prime_export(struct drm_gem_object *gobj,\n\t\t\t\t\t int flags)\n{\n\tstruct nouveau_bo *nvbo = nouveau_gem_object(gobj);\n\n\tif (nvbo->no_share)\n\t\treturn ERR_PTR(-EPERM);\n\n\treturn drm_gem_prime_export(gobj, flags);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}