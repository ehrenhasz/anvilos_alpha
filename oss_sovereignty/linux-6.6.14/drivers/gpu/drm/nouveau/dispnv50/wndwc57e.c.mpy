{
  "module_name": "wndwc57e.c",
  "hash_id": "863c656a999771fb42fd1e1fe3ba9abada1a4de59cd21b5a05a06e43519c6064",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/dispnv50/wndwc57e.c",
  "human_readable_source": " \n#include \"wndw.h\"\n#include \"atom.h\"\n\n#include <drm/drm_atomic_helper.h>\n#include <nouveau_bo.h>\n\n#include <nvif/pushc37b.h>\n\n#include <nvhw/class/clc57e.h>\n\nstatic int\nwndwc57e_image_set(struct nv50_wndw *wndw, struct nv50_wndw_atom *asyw)\n{\n\tstruct nvif_push *push = wndw->wndw.push;\n\tint ret;\n\n\tif ((ret = PUSH_WAIT(push, 17)))\n\t\treturn ret;\n\n\tPUSH_MTHD(push, NVC57E, SET_PRESENT_CONTROL,\n\t\t  NVVAL(NVC57E, SET_PRESENT_CONTROL, MIN_PRESENT_INTERVAL, asyw->image.interval) |\n\t\t  NVVAL(NVC57E, SET_PRESENT_CONTROL, BEGIN_MODE, asyw->image.mode) |\n\t\t  NVDEF(NVC57E, SET_PRESENT_CONTROL, TIMESTAMP_MODE, DISABLE));\n\n\tPUSH_MTHD(push, NVC57E, SET_SIZE,\n\t\t  NVVAL(NVC57E, SET_SIZE, WIDTH, asyw->image.w) |\n\t\t  NVVAL(NVC57E, SET_SIZE, HEIGHT, asyw->image.h),\n\n\t\t\t\tSET_STORAGE,\n\t\t  NVVAL(NVC57E, SET_STORAGE, BLOCK_HEIGHT, asyw->image.blockh) |\n\t\t  NVVAL(NVC57E, SET_STORAGE, MEMORY_LAYOUT, asyw->image.layout),\n\n\t\t\t\tSET_PARAMS,\n\t\t  NVVAL(NVC57E, SET_PARAMS, FORMAT, asyw->image.format) |\n\t\t  NVDEF(NVC57E, SET_PARAMS, CLAMP_BEFORE_BLEND, DISABLE) |\n\t\t  NVDEF(NVC57E, SET_PARAMS, SWAP_UV, DISABLE) |\n\t\t  NVDEF(NVC57E, SET_PARAMS, FMT_ROUNDING_MODE, ROUND_TO_NEAREST),\n\n\t\t\t\tSET_PLANAR_STORAGE(0),\n\t\t  NVVAL(NVC57E, SET_PLANAR_STORAGE, PITCH, asyw->image.blocks[0]) |\n\t\t  NVVAL(NVC57E, SET_PLANAR_STORAGE, PITCH, asyw->image.pitch[0] >> 6));\n\n\tPUSH_MTHD(push, NVC57E, SET_CONTEXT_DMA_ISO(0), asyw->image.handle, 1);\n\tPUSH_MTHD(push, NVC57E, SET_OFFSET(0), asyw->image.offset[0] >> 8);\n\n\tPUSH_MTHD(push, NVC57E, SET_POINT_IN(0),\n\t\t  NVVAL(NVC57E, SET_POINT_IN, X, asyw->state.src_x >> 16) |\n\t\t  NVVAL(NVC57E, SET_POINT_IN, Y, asyw->state.src_y >> 16));\n\n\tPUSH_MTHD(push, NVC57E, SET_SIZE_IN,\n\t\t  NVVAL(NVC57E, SET_SIZE_IN, WIDTH, asyw->state.src_w >> 16) |\n\t\t  NVVAL(NVC57E, SET_SIZE_IN, HEIGHT, asyw->state.src_h >> 16));\n\n\tPUSH_MTHD(push, NVC57E, SET_SIZE_OUT,\n\t\t  NVVAL(NVC57E, SET_SIZE_OUT, WIDTH, asyw->state.crtc_w) |\n\t\t  NVVAL(NVC57E, SET_SIZE_OUT, HEIGHT, asyw->state.crtc_h));\n\treturn 0;\n}\n\nint\nwndwc57e_csc_clr(struct nv50_wndw *wndw)\n{\n\tstruct nvif_push *push = wndw->wndw.push;\n\tconst u32 identity[12] = {\n\t\t0x00010000, 0x00000000, 0x00000000, 0x00000000,\n\t\t0x00000000, 0x00010000, 0x00000000, 0x00000000,\n\t\t0x00000000, 0x00000000, 0x00010000, 0x00000000,\n\t};\n\tint ret;\n\n\tif ((ret = PUSH_WAIT(push, 1 + ARRAY_SIZE(identity))))\n\t\treturn ret;\n\n\tPUSH_MTHD(push, NVC57E, SET_FMT_COEFFICIENT_C00, identity, ARRAY_SIZE(identity));\n\treturn 0;\n}\n\nint\nwndwc57e_csc_set(struct nv50_wndw *wndw, struct nv50_wndw_atom *asyw)\n{\n\tstruct nvif_push *push = wndw->wndw.push;\n\tint ret;\n\n\tif ((ret = PUSH_WAIT(push, 13)))\n\t\treturn ret;\n\n\tPUSH_MTHD(push, NVC57E, SET_FMT_COEFFICIENT_C00, asyw->csc.matrix, 12);\n\treturn 0;\n}\n\nint\nwndwc57e_ilut_clr(struct nv50_wndw *wndw)\n{\n\tstruct nvif_push *push = wndw->wndw.push;\n\tint ret;\n\n\tif ((ret = PUSH_WAIT(push, 2)))\n\t\treturn ret;\n\n\tPUSH_MTHD(push, NVC57E, SET_CONTEXT_DMA_ILUT, 0x00000000);\n\treturn 0;\n}\n\nint\nwndwc57e_ilut_set(struct nv50_wndw *wndw, struct nv50_wndw_atom *asyw)\n{\n\tstruct nvif_push *push = wndw->wndw.push;\n\tint ret;\n\n\tif ((ret = PUSH_WAIT(push, 4)))\n\t\treturn ret;\n\n\tPUSH_MTHD(push, NVC57E, SET_ILUT_CONTROL,\n\t\t  NVVAL(NVC57E, SET_ILUT_CONTROL, SIZE, asyw->xlut.i.size) |\n\t\t  NVVAL(NVC57E, SET_ILUT_CONTROL, MODE, asyw->xlut.i.mode) |\n\t\t  NVVAL(NVC57E, SET_ILUT_CONTROL, INTERPOLATE, asyw->xlut.i.output_mode),\n\n\t\t\t\tSET_CONTEXT_DMA_ILUT, asyw->xlut.handle,\n\t\t\t\tSET_OFFSET_ILUT, asyw->xlut.i.offset >> 8);\n\treturn 0;\n}\n\nstatic u16\nfixedU0_16_FP16(u16 fixed)\n{\n        int sign = 0, exp = 0, man = 0;\n        if (fixed) {\n                while (--exp && !(fixed & 0x8000))\n                        fixed <<= 1;\n                man = ((fixed << 1) & 0xffc0) >> 6;\n                exp += 15;\n        }\n        return (sign << 15) | (exp << 10) | man;\n}\n\nstatic void\nwndwc57e_ilut_load(struct drm_color_lut *in, int size, void __iomem *mem)\n{\n\tmemset_io(mem, 0x00, 0x20);  \n\tmem += 0x20;\n\n\tfor (; size--; in++, mem += 0x08) {\n\t\tu16 r = fixedU0_16_FP16(drm_color_lut_extract(in->  red, 16));\n\t\tu16 g = fixedU0_16_FP16(drm_color_lut_extract(in->green, 16));\n\t\tu16 b = fixedU0_16_FP16(drm_color_lut_extract(in-> blue, 16));\n\t\twritew(r, mem + 0);\n\t\twritew(g, mem + 2);\n\t\twritew(b, mem + 4);\n\t}\n\n\t \n\twritew(readw(mem - 8), mem + 0);\n\twritew(readw(mem - 6), mem + 2);\n\twritew(readw(mem - 4), mem + 4);\n}\n\nvoid\nwndwc57e_ilut(struct nv50_wndw *wndw, struct nv50_wndw_atom *asyw, int size)\n{\n\tif (!size)\n\t\tsize = 1024;\n\n\tif (size == 256)\n\t\tasyw->xlut.i.mode = NVC57E_SET_ILUT_CONTROL_MODE_DIRECT8;\n\telse\n\t\tasyw->xlut.i.mode = NVC57E_SET_ILUT_CONTROL_MODE_DIRECT10;\n\n\tasyw->xlut.i.size = 4   + size + 1  ;\n\tasyw->xlut.i.output_mode = NVC57E_SET_ILUT_CONTROL_INTERPOLATE_DISABLE;\n\tasyw->xlut.i.load = wndwc57e_ilut_load;\n}\n\n \nconst u64 wndwc57e_modifiers[] = {  \n\tDRM_FORMAT_MOD_NVIDIA_BLOCK_LINEAR_2D(0, 1, 2, 0x06, 0),\n\tDRM_FORMAT_MOD_NVIDIA_BLOCK_LINEAR_2D(0, 1, 2, 0x06, 1),\n\tDRM_FORMAT_MOD_NVIDIA_BLOCK_LINEAR_2D(0, 1, 2, 0x06, 2),\n\tDRM_FORMAT_MOD_NVIDIA_BLOCK_LINEAR_2D(0, 1, 2, 0x06, 3),\n\tDRM_FORMAT_MOD_NVIDIA_BLOCK_LINEAR_2D(0, 1, 2, 0x06, 4),\n\tDRM_FORMAT_MOD_NVIDIA_BLOCK_LINEAR_2D(0, 1, 2, 0x06, 5),\n\tDRM_FORMAT_MOD_LINEAR,\n\tDRM_FORMAT_MOD_INVALID\n};\n\nstatic const struct nv50_wndw_func\nwndwc57e = {\n\t.acquire = wndwc37e_acquire,\n\t.release = wndwc37e_release,\n\t.sema_set = wndwc37e_sema_set,\n\t.sema_clr = wndwc37e_sema_clr,\n\t.ntfy_set = wndwc37e_ntfy_set,\n\t.ntfy_clr = wndwc37e_ntfy_clr,\n\t.ntfy_reset = corec37d_ntfy_init,\n\t.ntfy_wait_begun = base507c_ntfy_wait_begun,\n\t.ilut = wndwc57e_ilut,\n\t.ilut_identity = true,\n\t.ilut_size = 1024,\n\t.xlut_set = wndwc57e_ilut_set,\n\t.xlut_clr = wndwc57e_ilut_clr,\n\t.csc = base907c_csc,\n\t.csc_set = wndwc57e_csc_set,\n\t.csc_clr = wndwc57e_csc_clr,\n\t.image_set = wndwc57e_image_set,\n\t.image_clr = wndwc37e_image_clr,\n\t.blend_set = wndwc37e_blend_set,\n\t.update = wndwc37e_update,\n};\n\nint\nwndwc57e_new(struct nouveau_drm *drm, enum drm_plane_type type, int index,\n\t     s32 oclass, struct nv50_wndw **pwndw)\n{\n\treturn wndwc37e_new_(&wndwc57e, drm, type, index, oclass,\n\t\t\t     BIT(index >> 1), pwndw);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}