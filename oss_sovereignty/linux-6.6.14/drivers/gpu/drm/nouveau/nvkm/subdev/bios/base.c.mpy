{
  "module_name": "base.c",
  "hash_id": "f35b1e0daf9af95896b037335ade22037d29b4ab77998b6736bd885b67a022a1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/bios/base.c",
  "human_readable_source": " \n#include \"priv.h\"\n\n#include <subdev/bios.h>\n#include <subdev/bios/bmp.h>\n#include <subdev/bios/bit.h>\n#include <subdev/bios/image.h>\n\nstatic bool\nnvbios_addr(struct nvkm_bios *bios, u32 *addr, u8 size)\n{\n\tu32 p = *addr;\n\n\tif (*addr >= bios->image0_size && bios->imaged_addr) {\n\t\t*addr -= bios->image0_size;\n\t\t*addr += bios->imaged_addr;\n\t}\n\n\tif (unlikely(*addr + size > bios->size)) {\n\t\tnvkm_error(&bios->subdev, \"OOB %d %08x %08x\\n\", size, p, *addr);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nu8\nnvbios_rd08(struct nvkm_bios *bios, u32 addr)\n{\n\tif (likely(nvbios_addr(bios, &addr, 1)))\n\t\treturn bios->data[addr];\n\treturn 0x00;\n}\n\nu16\nnvbios_rd16(struct nvkm_bios *bios, u32 addr)\n{\n\tif (likely(nvbios_addr(bios, &addr, 2)))\n\t\treturn get_unaligned_le16(&bios->data[addr]);\n\treturn 0x0000;\n}\n\nu32\nnvbios_rd32(struct nvkm_bios *bios, u32 addr)\n{\n\tif (likely(nvbios_addr(bios, &addr, 4)))\n\t\treturn get_unaligned_le32(&bios->data[addr]);\n\treturn 0x00000000;\n}\n\nu8\nnvbios_checksum(const u8 *data, int size)\n{\n\tu8 sum = 0;\n\twhile (size--)\n\t\tsum += *data++;\n\treturn sum;\n}\n\nu16\nnvbios_findstr(const u8 *data, int size, const char *str, int len)\n{\n\tint i, j;\n\n\tfor (i = 0; i <= (size - len); i++) {\n\t\tfor (j = 0; j < len; j++)\n\t\t\tif ((char)data[i + j] != str[j])\n\t\t\t\tbreak;\n\t\tif (j == len)\n\t\t\treturn i;\n\t}\n\n\treturn 0;\n}\n\nint\nnvbios_memcmp(struct nvkm_bios *bios, u32 addr, const char *str, u32 len)\n{\n\tunsigned char c1, c2;\n\n\twhile (len--) {\n\t\tc1 = nvbios_rd08(bios, addr++);\n\t\tc2 = *(str++);\n\t\tif (c1 != c2)\n\t\t\treturn c1 - c2;\n\t}\n\treturn 0;\n}\n\nint\nnvbios_extend(struct nvkm_bios *bios, u32 length)\n{\n\tif (bios->size < length) {\n\t\tu8 *prev = bios->data;\n\t\tif (!(bios->data = kmalloc(length, GFP_KERNEL))) {\n\t\t\tbios->data = prev;\n\t\t\treturn -ENOMEM;\n\t\t}\n\t\tmemcpy(bios->data, prev, bios->size);\n\t\tbios->size = length;\n\t\tkfree(prev);\n\t\treturn 1;\n\t}\n\treturn 0;\n}\n\nstatic void *\nnvkm_bios_dtor(struct nvkm_subdev *subdev)\n{\n\tstruct nvkm_bios *bios = nvkm_bios(subdev);\n\tkfree(bios->data);\n\treturn bios;\n}\n\nstatic const struct nvkm_subdev_func\nnvkm_bios = {\n\t.dtor = nvkm_bios_dtor,\n};\n\nint\nnvkm_bios_new(struct nvkm_device *device, enum nvkm_subdev_type type, int inst,\n\t      struct nvkm_bios **pbios)\n{\n\tstruct nvkm_bios *bios;\n\tstruct nvbios_image image;\n\tstruct bit_entry bit_i;\n\tint ret, idx = 0;\n\n\tif (!(bios = *pbios = kzalloc(sizeof(*bios), GFP_KERNEL)))\n\t\treturn -ENOMEM;\n\tnvkm_subdev_ctor(&nvkm_bios, device, type, inst, &bios->subdev);\n\n\tret = nvbios_shadow(bios);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (nvbios_image(bios, idx++, &image)) {\n\t\tbios->image0_size = image.size;\n\t\twhile (nvbios_image(bios, idx++, &image)) {\n\t\t\tif (image.type == 0xe0) {\n\t\t\t\tbios->imaged_addr = image.base;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tbios->bmp_offset = nvbios_findstr(bios->data, bios->size,\n\t\t\t\t\t  \"\\xff\\x7f\"\"NV\\0\", 5);\n\tif (bios->bmp_offset) {\n\t\tnvkm_debug(&bios->subdev, \"BMP version %x.%x\\n\",\n\t\t\t   bmp_version(bios) >> 8,\n\t\t\t   bmp_version(bios) & 0xff);\n\t}\n\n\tbios->bit_offset = nvbios_findstr(bios->data, bios->size,\n\t\t\t\t\t  \"\\xff\\xb8\"\"BIT\", 5);\n\tif (bios->bit_offset)\n\t\tnvkm_debug(&bios->subdev, \"BIT signature found\\n\");\n\n\t \n\tif (!bit_entry(bios, 'i', &bit_i) && bit_i.length >= 4) {\n\t\tbios->version.major = nvbios_rd08(bios, bit_i.offset + 3);\n\t\tbios->version.chip  = nvbios_rd08(bios, bit_i.offset + 2);\n\t\tbios->version.minor = nvbios_rd08(bios, bit_i.offset + 1);\n\t\tbios->version.micro = nvbios_rd08(bios, bit_i.offset + 0);\n\t\tbios->version.patch = nvbios_rd08(bios, bit_i.offset + 4);\n\t} else\n\tif (bmp_version(bios)) {\n\t\tbios->version.major = nvbios_rd08(bios, bios->bmp_offset + 13);\n\t\tbios->version.chip  = nvbios_rd08(bios, bios->bmp_offset + 12);\n\t\tbios->version.minor = nvbios_rd08(bios, bios->bmp_offset + 11);\n\t\tbios->version.micro = nvbios_rd08(bios, bios->bmp_offset + 10);\n\t}\n\n\tnvkm_info(&bios->subdev, \"version %02x.%02x.%02x.%02x.%02x\\n\",\n\t\t  bios->version.major, bios->version.chip,\n\t\t  bios->version.minor, bios->version.micro, bios->version.patch);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}