{
  "module_name": "gk104.c",
  "hash_id": "743eb1028d56fbef6a3069746bc0709cea2697469d98f43ed783d926f2da718f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/pci/gk104.c",
  "human_readable_source": " \n#include \"priv.h\"\n\nstatic int\ngk104_pcie_version_supported(struct nvkm_pci *pci)\n{\n\treturn (nvkm_rd32(pci->subdev.device, 0x8c1c0) & 0x4) == 0x4 ? 2 : 1;\n}\n\nstatic void\ngk104_pcie_set_cap_speed(struct nvkm_pci *pci, enum nvkm_pcie_speed speed)\n{\n\tstruct nvkm_device *device = pci->subdev.device;\n\n\tswitch (speed) {\n\tcase NVKM_PCIE_SPEED_2_5:\n\t\tgf100_pcie_set_cap_speed(pci, false);\n\t\tnvkm_mask(device, 0x8c1c0, 0x30000, 0x10000);\n\t\tbreak;\n\tcase NVKM_PCIE_SPEED_5_0:\n\t\tgf100_pcie_set_cap_speed(pci, true);\n\t\tnvkm_mask(device, 0x8c1c0, 0x30000, 0x20000);\n\t\tbreak;\n\tcase NVKM_PCIE_SPEED_8_0:\n\t\tgf100_pcie_set_cap_speed(pci, true);\n\t\tnvkm_mask(device, 0x8c1c0, 0x30000, 0x30000);\n\t\tbreak;\n\t}\n}\n\nstatic enum nvkm_pcie_speed\ngk104_pcie_cap_speed(struct nvkm_pci *pci)\n{\n\tint speed = gf100_pcie_cap_speed(pci);\n\n\tif (speed == 0)\n\t\treturn NVKM_PCIE_SPEED_2_5;\n\n\tif (speed >= 1) {\n\t\tint speed2 = nvkm_rd32(pci->subdev.device, 0x8c1c0) & 0x30000;\n\t\tswitch (speed2) {\n\t\tcase 0x00000:\n\t\tcase 0x10000:\n\t\t\treturn NVKM_PCIE_SPEED_2_5;\n\t\tcase 0x20000:\n\t\t\treturn NVKM_PCIE_SPEED_5_0;\n\t\tcase 0x30000:\n\t\t\treturn NVKM_PCIE_SPEED_8_0;\n\t\t}\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic void\ngk104_pcie_set_lnkctl_speed(struct nvkm_pci *pci, enum nvkm_pcie_speed speed)\n{\n\tu8 reg_v = 0;\n\tswitch (speed) {\n\tcase NVKM_PCIE_SPEED_2_5:\n\t\treg_v = 1;\n\t\tbreak;\n\tcase NVKM_PCIE_SPEED_5_0:\n\t\treg_v = 2;\n\t\tbreak;\n\tcase NVKM_PCIE_SPEED_8_0:\n\t\treg_v = 3;\n\t\tbreak;\n\t}\n\tnvkm_pci_mask(pci, 0xa8, 0x3, reg_v);\n}\n\nstatic enum nvkm_pcie_speed\ngk104_pcie_lnkctl_speed(struct nvkm_pci *pci)\n{\n\tu8 reg_v = nvkm_pci_rd32(pci, 0xa8) & 0x3;\n\tswitch (reg_v) {\n\tcase 0:\n\tcase 1:\n\t\treturn NVKM_PCIE_SPEED_2_5;\n\tcase 2:\n\t\treturn NVKM_PCIE_SPEED_5_0;\n\tcase 3:\n\t\treturn NVKM_PCIE_SPEED_8_0;\n\t}\n\treturn -1;\n}\n\nstatic enum nvkm_pcie_speed\ngk104_pcie_max_speed(struct nvkm_pci *pci)\n{\n\tu32 max_speed = nvkm_rd32(pci->subdev.device, 0x8c1c0) & 0x300000;\n\tswitch (max_speed) {\n\tcase 0x000000:\n\t\treturn NVKM_PCIE_SPEED_8_0;\n\tcase 0x100000:\n\t\treturn NVKM_PCIE_SPEED_5_0;\n\tcase 0x200000:\n\t\treturn NVKM_PCIE_SPEED_2_5;\n\t}\n\treturn NVKM_PCIE_SPEED_2_5;\n}\n\nstatic void\ngk104_pcie_set_link_speed(struct nvkm_pci *pci, enum nvkm_pcie_speed speed)\n{\n\tstruct nvkm_device *device = pci->subdev.device;\n\tu32 mask_value;\n\n\tswitch (speed) {\n\tcase NVKM_PCIE_SPEED_8_0:\n\t\tmask_value = 0x00000;\n\t\tbreak;\n\tcase NVKM_PCIE_SPEED_5_0:\n\t\tmask_value = 0x40000;\n\t\tbreak;\n\tcase NVKM_PCIE_SPEED_2_5:\n\tdefault:\n\t\tmask_value = 0x80000;\n\t\tbreak;\n\t}\n\n\tnvkm_mask(device, 0x8c040, 0xc0000, mask_value);\n\tnvkm_mask(device, 0x8c040, 0x1, 0x1);\n}\n\nstatic int\ngk104_pcie_init(struct nvkm_pci * pci)\n{\n\tenum nvkm_pcie_speed lnkctl_speed, max_speed, cap_speed;\n\tstruct nvkm_subdev *subdev = &pci->subdev;\n\n\tif (gf100_pcie_version(pci) < 2)\n\t\treturn 0;\n\n\tlnkctl_speed = gk104_pcie_lnkctl_speed(pci);\n\tmax_speed = gk104_pcie_max_speed(pci);\n\tcap_speed = gk104_pcie_cap_speed(pci);\n\n\tif (cap_speed != max_speed) {\n\t\tnvkm_trace(subdev, \"adjusting cap to max speed\\n\");\n\t\tgk104_pcie_set_cap_speed(pci, max_speed);\n\t\tcap_speed = gk104_pcie_cap_speed(pci);\n\t\tif (cap_speed != max_speed)\n\t\t\tnvkm_warn(subdev, \"failed to adjust cap speed\\n\");\n\t}\n\n\tif (lnkctl_speed != max_speed) {\n\t\tnvkm_debug(subdev, \"adjusting lnkctl to max speed\\n\");\n\t\tgk104_pcie_set_lnkctl_speed(pci, max_speed);\n\t\tlnkctl_speed = gk104_pcie_lnkctl_speed(pci);\n\t\tif (lnkctl_speed != max_speed)\n\t\t\tnvkm_error(subdev, \"failed to adjust lnkctl speed\\n\");\n\t}\n\n\treturn 0;\n}\n\nstatic int\ngk104_pcie_set_link(struct nvkm_pci *pci, enum nvkm_pcie_speed speed, u8 width)\n{\n\tstruct nvkm_subdev *subdev = &pci->subdev;\n\tenum nvkm_pcie_speed lnk_ctl_speed = gk104_pcie_lnkctl_speed(pci);\n\tenum nvkm_pcie_speed lnk_cap_speed = gk104_pcie_cap_speed(pci);\n\n\tif (speed > lnk_cap_speed) {\n\t\tspeed = lnk_cap_speed;\n\t\tnvkm_warn(subdev, \"dropping requested speed due too low cap\"\n\t\t\t  \" speed\\n\");\n\t}\n\n\tif (speed > lnk_ctl_speed) {\n\t\tspeed = lnk_ctl_speed;\n\t\tnvkm_warn(subdev, \"dropping requested speed due too low\"\n\t\t\t  \" lnkctl speed\\n\");\n\t}\n\n\tgk104_pcie_set_link_speed(pci, speed);\n\treturn 0;\n}\n\n\nstatic const struct nvkm_pci_func\ngk104_pci_func = {\n\t.init = g84_pci_init,\n\t.rd32 = nv40_pci_rd32,\n\t.wr08 = nv40_pci_wr08,\n\t.wr32 = nv40_pci_wr32,\n\t.msi_rearm = nv40_pci_msi_rearm,\n\n\t.pcie.init = gk104_pcie_init,\n\t.pcie.set_link = gk104_pcie_set_link,\n\n\t.pcie.max_speed = gk104_pcie_max_speed,\n\t.pcie.cur_speed = g84_pcie_cur_speed,\n\n\t.pcie.set_version = gf100_pcie_set_version,\n\t.pcie.version = gf100_pcie_version,\n\t.pcie.version_supported = gk104_pcie_version_supported,\n};\n\nint\ngk104_pci_new(struct nvkm_device *device, enum nvkm_subdev_type type, int inst,\n\t      struct nvkm_pci **ppci)\n{\n\treturn nvkm_pci_new_(&gk104_pci_func, device, type, inst, ppci);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}