{
  "module_name": "nv04.c",
  "hash_id": "d949c2048d69240d29269f6b7682d4793a117f397eb37d3694befde9bfa14699",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/timer/nv04.c",
  "human_readable_source": " \n#include \"priv.h\"\n#include \"regsnv04.h\"\n\nvoid\nnv04_timer_time(struct nvkm_timer *tmr, u64 time)\n{\n\tstruct nvkm_subdev *subdev = &tmr->subdev;\n\tstruct nvkm_device *device = subdev->device;\n\tu32 hi = upper_32_bits(time);\n\tu32 lo = lower_32_bits(time);\n\n\tnvkm_debug(subdev, \"time low        : %08x\\n\", lo);\n\tnvkm_debug(subdev, \"time high       : %08x\\n\", hi);\n\n\tnvkm_wr32(device, NV04_PTIMER_TIME_1, hi);\n\tnvkm_wr32(device, NV04_PTIMER_TIME_0, lo);\n}\n\nu64\nnv04_timer_read(struct nvkm_timer *tmr)\n{\n\tstruct nvkm_device *device = tmr->subdev.device;\n\tu32 hi, lo;\n\n\tdo {\n\t\thi = nvkm_rd32(device, NV04_PTIMER_TIME_1);\n\t\tlo = nvkm_rd32(device, NV04_PTIMER_TIME_0);\n\t} while (hi != nvkm_rd32(device, NV04_PTIMER_TIME_1));\n\n\treturn ((u64)hi << 32 | lo);\n}\n\nvoid\nnv04_timer_alarm_fini(struct nvkm_timer *tmr)\n{\n\tstruct nvkm_device *device = tmr->subdev.device;\n\tnvkm_wr32(device, NV04_PTIMER_INTR_EN_0, 0x00000000);\n}\n\nvoid\nnv04_timer_alarm_init(struct nvkm_timer *tmr, u32 time)\n{\n\tstruct nvkm_device *device = tmr->subdev.device;\n\tnvkm_wr32(device, NV04_PTIMER_ALARM_0, time);\n\tnvkm_wr32(device, NV04_PTIMER_INTR_EN_0, 0x00000001);\n}\n\nvoid\nnv04_timer_intr(struct nvkm_timer *tmr)\n{\n\tstruct nvkm_subdev *subdev = &tmr->subdev;\n\tstruct nvkm_device *device = subdev->device;\n\tu32 stat = nvkm_rd32(device, NV04_PTIMER_INTR_0);\n\n\tif (stat & 0x00000001) {\n\t\tnvkm_wr32(device, NV04_PTIMER_INTR_0, 0x00000001);\n\t\tnvkm_timer_alarm_trigger(tmr);\n\t\tstat &= ~0x00000001;\n\t}\n\n\tif (stat) {\n\t\tnvkm_error(subdev, \"intr %08x\\n\", stat);\n\t\tnvkm_wr32(device, NV04_PTIMER_INTR_0, stat);\n\t}\n}\n\nstatic void\nnv04_timer_init(struct nvkm_timer *tmr)\n{\n\tstruct nvkm_subdev *subdev = &tmr->subdev;\n\tstruct nvkm_device *device = subdev->device;\n\tu32 f = 0;  \n\tu32 n, d;\n\n\t \n\td = 1000000 / 32;\n\tn = f;\n\n\tif (!f) {\n\t\tn = nvkm_rd32(device, NV04_PTIMER_NUMERATOR);\n\t\td = nvkm_rd32(device, NV04_PTIMER_DENOMINATOR);\n\t\tif (!n || !d) {\n\t\t\tn = 1;\n\t\t\td = 1;\n\t\t}\n\t\tnvkm_warn(subdev, \"unknown input clock freq\\n\");\n\t}\n\n\t \n\twhile (((n % 5) == 0) && ((d % 5) == 0)) {\n\t\tn /= 5;\n\t\td /= 5;\n\t}\n\n\twhile (((n % 2) == 0) && ((d % 2) == 0)) {\n\t\tn /= 2;\n\t\td /= 2;\n\t}\n\n\twhile (n > 0xffff || d > 0xffff) {\n\t\tn >>= 1;\n\t\td >>= 1;\n\t}\n\n\tnvkm_debug(subdev, \"input frequency : %dHz\\n\", f);\n\tnvkm_debug(subdev, \"numerator       : %08x\\n\", n);\n\tnvkm_debug(subdev, \"denominator     : %08x\\n\", d);\n\tnvkm_debug(subdev, \"timer frequency : %dHz\\n\", f * d / n);\n\n\tnvkm_wr32(device, NV04_PTIMER_NUMERATOR, n);\n\tnvkm_wr32(device, NV04_PTIMER_DENOMINATOR, d);\n}\n\nstatic const struct nvkm_timer_func\nnv04_timer = {\n\t.init = nv04_timer_init,\n\t.intr = nv04_timer_intr,\n\t.read = nv04_timer_read,\n\t.time = nv04_timer_time,\n\t.alarm_init = nv04_timer_alarm_init,\n\t.alarm_fini = nv04_timer_alarm_fini,\n};\n\nint\nnv04_timer_new(struct nvkm_device *device, enum nvkm_subdev_type type, int inst,\n\t       struct nvkm_timer **ptmr)\n{\n\treturn nvkm_timer_new_(&nv04_timer, device, type, inst, ptmr);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}