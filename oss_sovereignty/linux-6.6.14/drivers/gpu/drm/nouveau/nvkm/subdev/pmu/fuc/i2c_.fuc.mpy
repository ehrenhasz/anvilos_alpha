{
  "module_name": "i2c_.fuc",
  "hash_id": "f0ffe507865a2e6d1caf998a1ed9a5affb2bd10b4f7be97c591721ea57bb2447",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/pmu/fuc/i2c_.fuc",
  "human_readable_source": "/*\n * Copyright 2013 Red Hat Inc.\n *\n * Permission is hereby granted, free of charge, to any person obtaining a\n * copy of this software and associated documentation files (the \"Software\"),\n * to deal in the Software without restriction, including without limitation\n * the rights to use, copy, modify, merge, publish, distribute, sublicense,\n * and/or sell copies of the Software, and to permit persons to whom the\n * Software is furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in\n * all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL\n * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR\n * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,\n * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\n * OTHER DEALINGS IN THE SOFTWARE.\n *\n * Authors: Ben Skeggs\n */\n\n#define T_TIMEOUT  2200000\n#define T_RISEFALL 1000\n#define T_HOLD     5000\n\n#ifdef INCLUDE_PROC\nprocess(PROC_I2C_, #i2c_init, #i2c_recv)\n#endif\n\n/******************************************************************************\n * I2C_ data segment\n *****************************************************************************/\n#ifdef INCLUDE_DATA\ni2c_scl_map:\n.b32 NV_PPWR_OUTPUT_I2C_0_SCL\n.b32 NV_PPWR_OUTPUT_I2C_1_SCL\n.b32 NV_PPWR_OUTPUT_I2C_2_SCL\n.b32 NV_PPWR_OUTPUT_I2C_3_SCL\n.b32 NV_PPWR_OUTPUT_I2C_4_SCL\n.b32 NV_PPWR_OUTPUT_I2C_5_SCL\n.b32 NV_PPWR_OUTPUT_I2C_6_SCL\n.b32 NV_PPWR_OUTPUT_I2C_7_SCL\n.b32 NV_PPWR_OUTPUT_I2C_8_SCL\n.b32 NV_PPWR_OUTPUT_I2C_9_SCL\ni2c_sda_map:\n.b32 NV_PPWR_OUTPUT_I2C_0_SDA\n.b32 NV_PPWR_OUTPUT_I2C_1_SDA\n.b32 NV_PPWR_OUTPUT_I2C_2_SDA\n.b32 NV_PPWR_OUTPUT_I2C_3_SDA\n.b32 NV_PPWR_OUTPUT_I2C_4_SDA\n.b32 NV_PPWR_OUTPUT_I2C_5_SDA\n.b32 NV_PPWR_OUTPUT_I2C_6_SDA\n.b32 NV_PPWR_OUTPUT_I2C_7_SDA\n.b32 NV_PPWR_OUTPUT_I2C_8_SDA\n.b32 NV_PPWR_OUTPUT_I2C_9_SDA\n#if NVKM_PPWR_CHIPSET < GF119\ni2c_ctrl:\n.b32 0x00e138\n.b32 0x00e150\n.b32 0x00e168\n.b32 0x00e180\n.b32 0x00e254\n.b32 0x00e274\n.b32 0x00e764\n.b32 0x00e780\n.b32 0x00e79c\n.b32 0x00e7b8\n#endif\n#endif\n\n/******************************************************************************\n * I2C_ code segment\n *****************************************************************************/\n#ifdef INCLUDE_CODE\n\n// $r3  - value\n// $r2  - sda line\n// $r1  - scl line\n// $r0  - zero\ni2c_drive_scl:\n\tcmp b32 $r3 0\n\tbra e #i2c_drive_scl_lo\n\tnv_iowr(NV_PPWR_OUTPUT_SET, $r1)\n\tret\n\ti2c_drive_scl_lo:\n\tnv_iowr(NV_PPWR_OUTPUT_CLR, $r1)\n\tret\n\ni2c_drive_sda:\n\tcmp b32 $r3 0\n\tbra e #i2c_drive_sda_lo\n\tnv_iowr(NV_PPWR_OUTPUT_SET, $r2)\n\tret\n\ti2c_drive_sda_lo:\n\tnv_iowr(NV_PPWR_OUTPUT_CLR, $r2)\n\tret\n\ni2c_sense_scl:\n\tbclr $flags $p1\n\tnv_iord($r3, NV_PPWR_INPUT)\n\tand $r3 $r1\n\tbra z #i2c_sense_scl_done\n\t\tbset $flags $p1\n\ti2c_sense_scl_done:\n\tret\n\ni2c_sense_sda:\n\tbclr $flags $p1\n\tnv_iord($r3, NV_PPWR_INPUT)\n\tand $r3 $r2\n\tbra z #i2c_sense_sda_done\n\t\tbset $flags $p1\n\ti2c_sense_sda_done:\n\tret\n\n#define i2c_drive_scl(v) /*\n*/\tmov $r3 (v) /*\n*/\tcall(i2c_drive_scl)\n#define i2c_drive_sda(v) /*\n*/\tmov $r3 (v) /*\n*/\tcall(i2c_drive_sda)\n#define i2c_sense_scl() /*\n*/\tcall(i2c_sense_scl)\n#define i2c_sense_sda() /*\n*/\tcall(i2c_sense_sda)\n#define i2c_delay(v) /*\n*/\tmov $r14 (v) /*\n*/\tcall(nsec)\n\n#define i2c_trace_init() /*\n*/\timm32($r6, 0x10000000) /*\n*/\tsub b32 $r7 $r6 1 /*\n*/\n#define i2c_trace_down() /*\n*/\tshr b32 $r6 4 /*\n*/\tpush $r5 /*\n*/\tshl b32 $r5 $r6 4 /*\n*/\tsub b32 $r5 $r6 /*\n*/\tnot b32 $r5 /*\n*/\tand $r7 $r5 /*\n*/\tpop $r5 /*\n*/\n#define i2c_trace_exit() /*\n*/\tshl b32 $r6 4 /*\n*/\n#define i2c_trace_next() /*\n*/\tadd b32 $r7 $r6 /*\n*/\n#define i2c_trace_call(func) /*\n*/\ti2c_trace_next() /*\n*/\ti2c_trace_down() /*\n*/\tcall(func) /*\n*/\ti2c_trace_exit() /*\n*/\n\ni2c_raise_scl:\n\tpush $r4\n\tmov $r4 (T_TIMEOUT / T_RISEFALL)\n\ti2c_drive_scl(1)\n\ti2c_raise_scl_wait:\n\t\ti2c_delay(T_RISEFALL)\n\t\ti2c_sense_scl()\n\t\tbra $p1 #i2c_raise_scl_done\n\t\tsub b32 $r4 1\n\t\tbra nz #i2c_raise_scl_wait\n\ti2c_raise_scl_done:\n\tpop $r4\n\tret\n\ni2c_start:\n\ti2c_sense_scl()\n\tbra not $p1 #i2c_start_rep\n\ti2c_sense_sda()\n\tbra not $p1 #i2c_start_rep\n\tbra #i2c_start_send\n\ti2c_start_rep:\n\t\ti2c_drive_scl(0)\n\t\ti2c_drive_sda(1)\n\t\ti2c_trace_call(i2c_raise_scl)\n\t\tbra not $p1 #i2c_start_out\n\ti2c_start_send:\n\ti2c_drive_sda(0)\n\ti2c_delay(T_HOLD)\n\ti2c_drive_scl(0)\n\ti2c_delay(T_HOLD)\n\ti2c_start_out:\n\tret\n\ni2c_stop:\n\ti2c_drive_scl(0)\n\ti2c_drive_sda(0)\n\ti2c_delay(T_RISEFALL)\n\ti2c_drive_scl(1)\n\ti2c_delay(T_HOLD)\n\ti2c_drive_sda(1)\n\ti2c_delay(T_HOLD)\n\tret\n\n// $r3  - value\n// $r2  - sda line\n// $r1  - scl line\n// $r0  - zero\ni2c_bitw:\n\tcall(i2c_drive_sda)\n\ti2c_delay(T_RISEFALL)\n\ti2c_trace_call(i2c_raise_scl)\n\tbra not $p1 #i2c_bitw_out\n\ti2c_delay(T_HOLD)\n\ti2c_drive_scl(0)\n\ti2c_delay(T_HOLD)\n\ti2c_bitw_out:\n\tret\n\n// $r3  - value (out)\n// $r2  - sda line\n// $r1  - scl line\n// $r0  - zero\ni2c_bitr:\n\ti2c_drive_sda(1)\n\ti2c_delay(T_RISEFALL)\n\ti2c_trace_call(i2c_raise_scl)\n\tbra not $p1 #i2c_bitr_done\n\ti2c_sense_sda()\n\ti2c_drive_scl(0)\n\ti2c_delay(T_HOLD)\n\txbit $r3 $flags $p1\n\tbset $flags $p1\n\ti2c_bitr_done:\n\tret\n\ni2c_get_byte:\n\tmov $r5 0\n\tmov $r4 8\n\ti2c_get_byte_next:\n\t\tshl b32 $r5 1\n\t\ti2c_trace_call(i2c_bitr)\n\t\tbra not $p1 #i2c_get_byte_done\n\t\tor $r5 $r3\n\t\tsub b32 $r4 1\n\t\tbra nz #i2c_get_byte_next\n\tmov $r3 1\n\ti2c_trace_call(i2c_bitw)\n\ti2c_get_byte_done:\n\tret\n\ni2c_put_byte:\n\tmov $r4 8\n\ti2c_put_byte_next:\n\t\tsub b32 $r4 1\n\t\txbit $r3 $r5 $r4\n\t\ti2c_trace_call(i2c_bitw)\n\t\tbra not $p1 #i2c_put_byte_done\n\t\tcmp b32 $r4 0\n\t\tbra ne #i2c_put_byte_next\n\ti2c_trace_call(i2c_bitr)\n\tbra not $p1 #i2c_put_byte_done\n\ti2c_trace_next()\n\tcmp b32 $r3 1\n\tbra ne #i2c_put_byte_done\n\tbclr $flags $p1\t// nack\n\ti2c_put_byte_done:\n\tret\n\ni2c_addr:\n\ti2c_trace_call(i2c_start)\n\tbra not $p1 #i2c_addr_done\n\textr $r3 $r12 I2C__MSG_DATA0_ADDR\n\tshl b32 $r3 1\n\tor $r5 $r3\n\ti2c_trace_call(i2c_put_byte)\n\ti2c_addr_done:\n\tret\n\ni2c_acquire_addr:\n\textr $r14 $r12 I2C__MSG_DATA0_PORT\n#if NVKM_PPWR_CHIPSET < GF119\n\tshl b32 $r14 2\n\tadd b32 $r14 #i2c_ctrl\n\tld b32 $r14 D[$r14]\n#else\n\tshl b32 $r14 5\n\tadd b32 $r14 0x00d014\n#endif\n\tret\n\ni2c_acquire:\n\tcall(i2c_acquire_addr)\n\tcall(rd32)\n\tbset $r13 3\n\tcall(wr32)\n\tret\n\ni2c_release:\n\tcall(i2c_acquire_addr)\n\tcall(rd32)\n\tbclr $r13 3\n\tcall(wr32)\n\tret\n\n// description\n//\n// $r15 - current (i2c)\n// $r14 - sender process name\n// $r13 - message\n// $r12 - data0\n// $r11 - data1\n// $r0  - zero\ni2c_recv:\n\tbclr $flags $p1\n\textr $r1 $r12 I2C__MSG_DATA0_PORT\n\tshl b32 $r1 2\n\tcmp b32 $r1 (#i2c_sda_map - #i2c_scl_map)\n\tbra ge #i2c_recv_done\n\tadd b32 $r3 $r1 #i2c_sda_map\n\tld b32 $r2 D[$r3]\n\tadd b32 $r3 $r1 #i2c_scl_map\n\tld b32 $r1 D[$r3]\n\n\tbset $flags $p2\n\tpush $r13\n\tpush $r14\n\n\tpush $r13\n\ti2c_trace_init()\n\ti2c_trace_call(i2c_acquire)\n\tpop $r13\n\n\tcmp b32 $r13 I2C__MSG_RD08\n\tbra ne #i2c_recv_not_rd08\n\t\tmov $r5 0\n\t\ti2c_trace_call(i2c_addr)\n\t\tbra not $p1 #i2c_recv_done\n\t\textr $r5 $r12 I2C__MSG_DATA0_RD08_REG\n\t\ti2c_trace_call(i2c_put_byte)\n\t\tbra not $p1 #i2c_recv_done\n\t\tmov $r5 1\n\t\ti2c_trace_call(i2c_addr)\n\t\tbra not $p1 #i2c_recv_done\n\t\ti2c_trace_call(i2c_get_byte)\n\t\tbra not $p1 #i2c_recv_done\n\t\tins $r11 $r5 I2C__MSG_DATA1_RD08_VAL\n\t\ti2c_trace_call(i2c_stop)\n\t\tmov b32 $r11 $r5\n\t\tclear b32 $r7\n\t\tbra #i2c_recv_done\n\n\ti2c_recv_not_rd08:\n\tcmp b32 $r13 I2C__MSG_WR08\n\tbra ne #i2c_recv_not_wr08\n\t\tmov $r5 0\n\t\tcall(i2c_addr)\n\t\tbra not $p1 #i2c_recv_done\n\t\textr $r5 $r12 I2C__MSG_DATA0_WR08_REG\n\t\tcall(i2c_put_byte)\n\t\tbra not $p1 #i2c_recv_done\n\t\tmov $r5 0\n\t\tcall(i2c_addr)\n\t\tbra not $p1 #i2c_recv_done\n\t\textr $r5 $r11 I2C__MSG_DATA1_WR08_VAL\n\t\tcall(i2c_put_byte)\n\t\tbra not $p1 #i2c_recv_done\n\t\tcall(i2c_stop)\n\t\tclear b32 $r7\n\t\textr $r5 $r12 I2C__MSG_DATA0_WR08_SYNC\n\t\tbra nz #i2c_recv_done\n\t\tbclr $flags $p2\n\t\tbra #i2c_recv_done\n\n\ti2c_recv_not_wr08:\n\n\ti2c_recv_done:\n\textr $r14 $r12 I2C__MSG_DATA0_PORT\n\tcall(i2c_release)\n\n\tpop $r14\n\tpop $r13\n\tbra not $p2 #i2c_recv_exit\n\tmov b32 $r12 $r7\n\tcall(send)\n\n\ti2c_recv_exit:\n\tret\n\n// description\n//\n// $r15 - current (i2c)\n// $r0  - zero\ni2c_init:\n\tret\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}