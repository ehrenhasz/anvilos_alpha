{
  "module_name": "ramgk104.c",
  "hash_id": "d0b63ef13c3c78671c00405291c0cc4162ecf504e7433ab6660ac244966ebbba",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/fb/ramgk104.c",
  "human_readable_source": " \n#define gk104_ram(p) container_of((p), struct gk104_ram, base)\n#include \"ram.h\"\n#include \"ramfuc.h\"\n\n#include <core/option.h>\n#include <subdev/bios.h>\n#include <subdev/bios/init.h>\n#include <subdev/bios/M0205.h>\n#include <subdev/bios/M0209.h>\n#include <subdev/bios/pll.h>\n#include <subdev/bios/rammap.h>\n#include <subdev/bios/timing.h>\n#include <subdev/clk.h>\n#include <subdev/clk/pll.h>\n#include <subdev/gpio.h>\n\nstruct gk104_ramfuc {\n\tstruct ramfuc base;\n\n\tstruct nvbios_pll refpll;\n\tstruct nvbios_pll mempll;\n\n\tstruct ramfuc_reg r_gpioMV;\n\tu32 r_funcMV[2];\n\tstruct ramfuc_reg r_gpio2E;\n\tu32 r_func2E[2];\n\tstruct ramfuc_reg r_gpiotrig;\n\n\tstruct ramfuc_reg r_0x132020;\n\tstruct ramfuc_reg r_0x132028;\n\tstruct ramfuc_reg r_0x132024;\n\tstruct ramfuc_reg r_0x132030;\n\tstruct ramfuc_reg r_0x132034;\n\tstruct ramfuc_reg r_0x132000;\n\tstruct ramfuc_reg r_0x132004;\n\tstruct ramfuc_reg r_0x132040;\n\n\tstruct ramfuc_reg r_0x10f248;\n\tstruct ramfuc_reg r_0x10f290;\n\tstruct ramfuc_reg r_0x10f294;\n\tstruct ramfuc_reg r_0x10f298;\n\tstruct ramfuc_reg r_0x10f29c;\n\tstruct ramfuc_reg r_0x10f2a0;\n\tstruct ramfuc_reg r_0x10f2a4;\n\tstruct ramfuc_reg r_0x10f2a8;\n\tstruct ramfuc_reg r_0x10f2ac;\n\tstruct ramfuc_reg r_0x10f2cc;\n\tstruct ramfuc_reg r_0x10f2e8;\n\tstruct ramfuc_reg r_0x10f250;\n\tstruct ramfuc_reg r_0x10f24c;\n\tstruct ramfuc_reg r_0x10fec4;\n\tstruct ramfuc_reg r_0x10fec8;\n\tstruct ramfuc_reg r_0x10f604;\n\tstruct ramfuc_reg r_0x10f614;\n\tstruct ramfuc_reg r_0x10f610;\n\tstruct ramfuc_reg r_0x100770;\n\tstruct ramfuc_reg r_0x100778;\n\tstruct ramfuc_reg r_0x10f224;\n\n\tstruct ramfuc_reg r_0x10f870;\n\tstruct ramfuc_reg r_0x10f698;\n\tstruct ramfuc_reg r_0x10f694;\n\tstruct ramfuc_reg r_0x10f6b8;\n\tstruct ramfuc_reg r_0x10f808;\n\tstruct ramfuc_reg r_0x10f670;\n\tstruct ramfuc_reg r_0x10f60c;\n\tstruct ramfuc_reg r_0x10f830;\n\tstruct ramfuc_reg r_0x1373ec;\n\tstruct ramfuc_reg r_0x10f800;\n\tstruct ramfuc_reg r_0x10f82c;\n\n\tstruct ramfuc_reg r_0x10f978;\n\tstruct ramfuc_reg r_0x10f910;\n\tstruct ramfuc_reg r_0x10f914;\n\n\tstruct ramfuc_reg r_mr[16];  \n\n\tstruct ramfuc_reg r_0x62c000;\n\n\tstruct ramfuc_reg r_0x10f200;\n\n\tstruct ramfuc_reg r_0x10f210;\n\tstruct ramfuc_reg r_0x10f310;\n\tstruct ramfuc_reg r_0x10f314;\n\tstruct ramfuc_reg r_0x10f318;\n\tstruct ramfuc_reg r_0x10f090;\n\tstruct ramfuc_reg r_0x10f69c;\n\tstruct ramfuc_reg r_0x10f824;\n\tstruct ramfuc_reg r_0x1373f0;\n\tstruct ramfuc_reg r_0x1373f4;\n\tstruct ramfuc_reg r_0x137320;\n\tstruct ramfuc_reg r_0x10f65c;\n\tstruct ramfuc_reg r_0x10f6bc;\n\tstruct ramfuc_reg r_0x100710;\n\tstruct ramfuc_reg r_0x100750;\n};\n\nstruct gk104_ram {\n\tstruct nvkm_ram base;\n\tstruct gk104_ramfuc fuc;\n\n\tstruct list_head cfg;\n\tu32 parts;\n\tu32 pmask;\n\tu32 pnuts;\n\n\tstruct nvbios_ramcfg diff;\n\tint from;\n\tint mode;\n\tint N1, fN1, M1, P1;\n\tint N2, M2, P2;\n};\n\n \nstatic void\ngk104_ram_train(struct gk104_ramfuc *fuc, u32 mask, u32 data)\n{\n\tstruct gk104_ram *ram = container_of(fuc, typeof(*ram), fuc);\n\tu32 addr = 0x110974, i;\n\n\tram_mask(fuc, 0x10f910, mask, data);\n\tram_mask(fuc, 0x10f914, mask, data);\n\n\tfor (i = 0; (data & 0x80000000) && i < ram->parts; addr += 0x1000, i++) {\n\t\tif (ram->pmask & (1 << i))\n\t\t\tcontinue;\n\t\tram_wait(fuc, addr, 0x0000000f, 0x00000000, 500000);\n\t}\n}\n\nstatic void\nr1373f4_init(struct gk104_ramfuc *fuc)\n{\n\tstruct gk104_ram *ram = container_of(fuc, typeof(*ram), fuc);\n\tconst u32 mcoef = ((--ram->P2 << 28) | (ram->N2 << 8) | ram->M2);\n\tconst u32 rcoef = ((  ram->P1 << 16) | (ram->N1 << 8) | ram->M1);\n\tconst u32 runk0 = ram->fN1 << 16;\n\tconst u32 runk1 = ram->fN1;\n\n\tif (ram->from == 2) {\n\t\tram_mask(fuc, 0x1373f4, 0x00000000, 0x00001100);\n\t\tram_mask(fuc, 0x1373f4, 0x00000000, 0x00000010);\n\t} else {\n\t\tram_mask(fuc, 0x1373f4, 0x00000000, 0x00010010);\n\t}\n\n\tram_mask(fuc, 0x1373f4, 0x00000003, 0x00000000);\n\tram_mask(fuc, 0x1373f4, 0x00000010, 0x00000000);\n\n\t \n\tif ((ram_rd32(fuc, 0x132024) & 0xffffffff) != rcoef ||\n\t    (ram_rd32(fuc, 0x132034) & 0x0000ffff) != runk1) {\n\t\tram_mask(fuc, 0x132000, 0x00000001, 0x00000000);\n\t\tram_mask(fuc, 0x132020, 0x00000001, 0x00000000);\n\t\tram_wr32(fuc, 0x137320, 0x00000000);\n\t\tram_mask(fuc, 0x132030, 0xffff0000, runk0);\n\t\tram_mask(fuc, 0x132034, 0x0000ffff, runk1);\n\t\tram_wr32(fuc, 0x132024, rcoef);\n\t\tram_mask(fuc, 0x132028, 0x00080000, 0x00080000);\n\t\tram_mask(fuc, 0x132020, 0x00000001, 0x00000001);\n\t\tram_wait(fuc, 0x137390, 0x00020000, 0x00020000, 64000);\n\t\tram_mask(fuc, 0x132028, 0x00080000, 0x00000000);\n\t}\n\n\t \n\tif (ram->mode == 2) {\n\t\tram_mask(fuc, 0x1373f4, 0x00010000, 0x00000000);\n\t\tram_mask(fuc, 0x132000, 0x80000000, 0x80000000);\n\t\tram_mask(fuc, 0x132000, 0x00000001, 0x00000000);\n\t\tram_mask(fuc, 0x132004, 0x103fffff, mcoef);\n\t\tram_mask(fuc, 0x132000, 0x00000001, 0x00000001);\n\t\tram_wait(fuc, 0x137390, 0x00000002, 0x00000002, 64000);\n\t\tram_mask(fuc, 0x1373f4, 0x00000000, 0x00001100);\n\t} else {\n\t\tram_mask(fuc, 0x1373f4, 0x00000000, 0x00010100);\n\t}\n\n\tram_mask(fuc, 0x1373f4, 0x00000000, 0x00000010);\n}\n\nstatic void\nr1373f4_fini(struct gk104_ramfuc *fuc)\n{\n\tstruct gk104_ram *ram = container_of(fuc, typeof(*ram), fuc);\n\tstruct nvkm_ram_data *next = ram->base.next;\n\tu8 v0 = next->bios.ramcfg_11_03_c0;\n\tu8 v1 = next->bios.ramcfg_11_03_30;\n\tu32 tmp;\n\n\ttmp = ram_rd32(fuc, 0x1373ec) & ~0x00030000;\n\tram_wr32(fuc, 0x1373ec, tmp | (v1 << 16));\n\tram_mask(fuc, 0x1373f0, (~ram->mode & 3), 0x00000000);\n\tif (ram->mode == 2) {\n\t\tram_mask(fuc, 0x1373f4, 0x00000003, 0x00000002);\n\t\tram_mask(fuc, 0x1373f4, 0x00001100, 0x00000000);\n\t} else {\n\t\tram_mask(fuc, 0x1373f4, 0x00000003, 0x00000001);\n\t\tram_mask(fuc, 0x1373f4, 0x00010000, 0x00000000);\n\t}\n\tram_mask(fuc, 0x10f800, 0x00000030, (v0 ^ v1) << 4);\n}\n\nstatic void\ngk104_ram_nuts(struct gk104_ram *ram, struct ramfuc_reg *reg,\n\t       u32 _mask, u32 _data, u32 _copy)\n{\n\tstruct nvkm_fb *fb = ram->base.fb;\n\tstruct ramfuc *fuc = &ram->fuc.base;\n\tstruct nvkm_device *device = fb->subdev.device;\n\tu32 addr = 0x110000 + (reg->addr & 0xfff);\n\tu32 mask = _mask | _copy;\n\tu32 data = (_data & _mask) | (reg->data & _copy);\n\tu32 i;\n\n\tfor (i = 0; i < 16; i++, addr += 0x1000) {\n\t\tif (ram->pnuts & (1 << i)) {\n\t\t\tu32 prev = nvkm_rd32(device, addr);\n\t\t\tu32 next = (prev & ~mask) | data;\n\t\t\tnvkm_memx_wr32(fuc->memx, addr, next);\n\t\t}\n\t}\n}\n#define ram_nuts(s,r,m,d,c)                                                    \\\n\tgk104_ram_nuts((s), &(s)->fuc.r_##r, (m), (d), (c))\n\nstatic int\ngk104_ram_calc_gddr5(struct gk104_ram *ram, u32 freq)\n{\n\tstruct gk104_ramfuc *fuc = &ram->fuc;\n\tstruct nvkm_ram_data *next = ram->base.next;\n\tint vc = !next->bios.ramcfg_11_02_08;\n\tint mv = !next->bios.ramcfg_11_02_04;\n\tu32 mask, data;\n\n\tram_mask(fuc, 0x10f808, 0x40000000, 0x40000000);\n\tram_block(fuc);\n\n\tif (ram->base.fb->subdev.device->disp)\n\t\tram_wr32(fuc, 0x62c000, 0x0f0f0000);\n\n\t \n\tif ((ram->base.mr[1] & 0x03c) != 0x030) {\n\t\tram_mask(fuc, mr[1], 0x03c, ram->base.mr[1] & 0x03c);\n\t\tram_nuts(ram, mr[1], 0x03c, ram->base.mr1_nuts & 0x03c, 0x000);\n\t}\n\n\tif (vc == 1 && ram_have(fuc, gpio2E)) {\n\t\tu32 temp  = ram_mask(fuc, gpio2E, 0x3000, fuc->r_func2E[1]);\n\t\tif (temp != ram_rd32(fuc, gpio2E)) {\n\t\t\tram_wr32(fuc, gpiotrig, 1);\n\t\t\tram_nsec(fuc, 20000);\n\t\t}\n\t}\n\n\tram_mask(fuc, 0x10f200, 0x00000800, 0x00000000);\n\n\tgk104_ram_train(fuc, 0x01020000, 0x000c0000);\n\n\tram_wr32(fuc, 0x10f210, 0x00000000);  \n\tram_nsec(fuc, 1000);\n\tram_wr32(fuc, 0x10f310, 0x00000001);  \n\tram_nsec(fuc, 1000);\n\n\tram_mask(fuc, 0x10f200, 0x80000000, 0x80000000);\n\tram_wr32(fuc, 0x10f314, 0x00000001);  \n\tram_mask(fuc, 0x10f200, 0x80000000, 0x00000000);\n\tram_wr32(fuc, 0x10f090, 0x00000061);\n\tram_wr32(fuc, 0x10f090, 0xc000007f);\n\tram_nsec(fuc, 1000);\n\n\tram_wr32(fuc, 0x10f698, 0x00000000);\n\tram_wr32(fuc, 0x10f69c, 0x00000000);\n\n\t \n\tmask = 0x800f07e0;\n\tdata = 0x00030000;\n\tif (ram_rd32(fuc, 0x10f978) & 0x00800000)\n\t\tdata |= 0x00040000;\n\n\tif (1) {\n\t\tdata |= 0x800807e0;\n\t\tswitch (next->bios.ramcfg_11_03_c0) {\n\t\tcase 3: data &= ~0x00000040; break;\n\t\tcase 2: data &= ~0x00000100; break;\n\t\tcase 1: data &= ~0x80000000; break;\n\t\tcase 0: data &= ~0x00000400; break;\n\t\t}\n\n\t\tswitch (next->bios.ramcfg_11_03_30) {\n\t\tcase 3: data &= ~0x00000020; break;\n\t\tcase 2: data &= ~0x00000080; break;\n\t\tcase 1: data &= ~0x00080000; break;\n\t\tcase 0: data &= ~0x00000200; break;\n\t\t}\n\t}\n\n\tif (next->bios.ramcfg_11_02_80)\n\t\tmask |= 0x03000000;\n\tif (next->bios.ramcfg_11_02_40)\n\t\tmask |= 0x00002000;\n\tif (next->bios.ramcfg_11_07_10)\n\t\tmask |= 0x00004000;\n\tif (next->bios.ramcfg_11_07_08)\n\t\tmask |= 0x00000003;\n\telse {\n\t\tmask |= 0x34000000;\n\t\tif (ram_rd32(fuc, 0x10f978) & 0x00800000)\n\t\t\tmask |= 0x40000000;\n\t}\n\tram_mask(fuc, 0x10f824, mask, data);\n\n\tram_mask(fuc, 0x132040, 0x00010000, 0x00000000);\n\n\tif (ram->from == 2 && ram->mode != 2) {\n\t\tram_mask(fuc, 0x10f808, 0x00080000, 0x00000000);\n\t\tram_mask(fuc, 0x10f200, 0x18008000, 0x00008000);\n\t\tram_mask(fuc, 0x10f800, 0x00000000, 0x00000004);\n\t\tram_mask(fuc, 0x10f830, 0x00008000, 0x01040010);\n\t\tram_mask(fuc, 0x10f830, 0x01000000, 0x00000000);\n\t\tr1373f4_init(fuc);\n\t\tram_mask(fuc, 0x1373f0, 0x00000002, 0x00000001);\n\t\tr1373f4_fini(fuc);\n\t\tram_mask(fuc, 0x10f830, 0x00c00000, 0x00240001);\n\t} else\n\tif (ram->from != 2 && ram->mode != 2) {\n\t\tr1373f4_init(fuc);\n\t\tr1373f4_fini(fuc);\n\t}\n\n\tif (ram_have(fuc, gpioMV)) {\n\t\tu32 temp  = ram_mask(fuc, gpioMV, 0x3000, fuc->r_funcMV[mv]);\n\t\tif (temp != ram_rd32(fuc, gpioMV)) {\n\t\t\tram_wr32(fuc, gpiotrig, 1);\n\t\t\tram_nsec(fuc, 64000);\n\t\t}\n\t}\n\n\tif (next->bios.ramcfg_11_02_40 ||\n\t    next->bios.ramcfg_11_07_10) {\n\t\tram_mask(fuc, 0x132040, 0x00010000, 0x00010000);\n\t\tram_nsec(fuc, 20000);\n\t}\n\n\tif (ram->from != 2 && ram->mode == 2) {\n\t\tif (0  )\n\t\t\tram_mask(fuc, 0x10f200, 0x18000000, 0x18000000);\n\t\tram_mask(fuc, 0x10f800, 0x00000004, 0x00000000);\n\t\tram_mask(fuc, 0x1373f0, 0x00000000, 0x00000002);\n\t\tram_mask(fuc, 0x10f830, 0x00800001, 0x00408010);\n\t\tr1373f4_init(fuc);\n\t\tr1373f4_fini(fuc);\n\t\tram_mask(fuc, 0x10f808, 0x00000000, 0x00080000);\n\t\tram_mask(fuc, 0x10f200, 0x00808000, 0x00800000);\n\t} else\n\tif (ram->from == 2 && ram->mode == 2) {\n\t\tram_mask(fuc, 0x10f800, 0x00000004, 0x00000000);\n\t\tr1373f4_init(fuc);\n\t\tr1373f4_fini(fuc);\n\t}\n\n\tif (ram->mode != 2)   {\n\t\tif (next->bios.ramcfg_11_07_40)\n\t\t\tram_mask(fuc, 0x10f670, 0x80000000, 0x80000000);\n\t}\n\n\tram_wr32(fuc, 0x10f65c, 0x00000011 * next->bios.rammap_11_11_0c);\n\tram_wr32(fuc, 0x10f6b8, 0x01010101 * next->bios.ramcfg_11_09);\n\tram_wr32(fuc, 0x10f6bc, 0x01010101 * next->bios.ramcfg_11_09);\n\n\tif (!next->bios.ramcfg_11_07_08 && !next->bios.ramcfg_11_07_04) {\n\t\tram_wr32(fuc, 0x10f698, 0x01010101 * next->bios.ramcfg_11_04);\n\t\tram_wr32(fuc, 0x10f69c, 0x01010101 * next->bios.ramcfg_11_04);\n\t} else\n\tif (!next->bios.ramcfg_11_07_08) {\n\t\tram_wr32(fuc, 0x10f698, 0x00000000);\n\t\tram_wr32(fuc, 0x10f69c, 0x00000000);\n\t}\n\n\tif (ram->mode != 2) {\n\t\tu32 data = 0x01000100 * next->bios.ramcfg_11_04;\n\t\tram_nuke(fuc, 0x10f694);\n\t\tram_mask(fuc, 0x10f694, 0xff00ff00, data);\n\t}\n\n\tif (ram->mode == 2 && next->bios.ramcfg_11_08_10)\n\t\tdata = 0x00000080;\n\telse\n\t\tdata = 0x00000000;\n\tram_mask(fuc, 0x10f60c, 0x00000080, data);\n\n\tmask = 0x00070000;\n\tdata = 0x00000000;\n\tif (!next->bios.ramcfg_11_02_80)\n\t\tdata |= 0x03000000;\n\tif (!next->bios.ramcfg_11_02_40)\n\t\tdata |= 0x00002000;\n\tif (!next->bios.ramcfg_11_07_10)\n\t\tdata |= 0x00004000;\n\tif (!next->bios.ramcfg_11_07_08)\n\t\tdata |= 0x00000003;\n\telse\n\t\tdata |= 0x74000000;\n\tram_mask(fuc, 0x10f824, mask, data);\n\n\tif (next->bios.ramcfg_11_01_08)\n\t\tdata = 0x00000000;\n\telse\n\t\tdata = 0x00001000;\n\tram_mask(fuc, 0x10f200, 0x00001000, data);\n\n\tif (ram_rd32(fuc, 0x10f670) & 0x80000000) {\n\t\tram_nsec(fuc, 10000);\n\t\tram_mask(fuc, 0x10f670, 0x80000000, 0x00000000);\n\t}\n\n\tif (next->bios.ramcfg_11_08_01)\n\t\tdata = 0x00100000;\n\telse\n\t\tdata = 0x00000000;\n\tram_mask(fuc, 0x10f82c, 0x00100000, data);\n\n\tdata = 0x00000000;\n\tif (next->bios.ramcfg_11_08_08)\n\t\tdata |= 0x00002000;\n\tif (next->bios.ramcfg_11_08_04)\n\t\tdata |= 0x00001000;\n\tif (next->bios.ramcfg_11_08_02)\n\t\tdata |= 0x00004000;\n\tram_mask(fuc, 0x10f830, 0x00007000, data);\n\n\t \n\tram_mask(fuc, 0x10f248, 0xffffffff, next->bios.timing[10]);\n\tram_mask(fuc, 0x10f290, 0xffffffff, next->bios.timing[0]);\n\tram_mask(fuc, 0x10f294, 0xffffffff, next->bios.timing[1]);\n\tram_mask(fuc, 0x10f298, 0xffffffff, next->bios.timing[2]);\n\tram_mask(fuc, 0x10f29c, 0xffffffff, next->bios.timing[3]);\n\tram_mask(fuc, 0x10f2a0, 0xffffffff, next->bios.timing[4]);\n\tram_mask(fuc, 0x10f2a4, 0xffffffff, next->bios.timing[5]);\n\tram_mask(fuc, 0x10f2a8, 0xffffffff, next->bios.timing[6]);\n\tram_mask(fuc, 0x10f2ac, 0xffffffff, next->bios.timing[7]);\n\tram_mask(fuc, 0x10f2cc, 0xffffffff, next->bios.timing[8]);\n\tram_mask(fuc, 0x10f2e8, 0xffffffff, next->bios.timing[9]);\n\n\tdata = mask = 0x00000000;\n\tif (ram->diff.ramcfg_11_08_20) {\n\t\tif (next->bios.ramcfg_11_08_20)\n\t\t\tdata |= 0x01000000;\n\t\tmask |= 0x01000000;\n\t}\n\tram_mask(fuc, 0x10f200, mask, data);\n\n\tdata = mask = 0x00000000;\n\tif (ram->diff.ramcfg_11_02_03) {\n\t\tdata |= next->bios.ramcfg_11_02_03 << 8;\n\t\tmask |= 0x00000300;\n\t}\n\tif (ram->diff.ramcfg_11_01_10) {\n\t\tif (next->bios.ramcfg_11_01_10)\n\t\t\tdata |= 0x70000000;\n\t\tmask |= 0x70000000;\n\t}\n\tram_mask(fuc, 0x10f604, mask, data);\n\n\tdata = mask = 0x00000000;\n\tif (ram->diff.timing_20_30_07) {\n\t\tdata |= next->bios.timing_20_30_07 << 28;\n\t\tmask |= 0x70000000;\n\t}\n\tif (ram->diff.ramcfg_11_01_01) {\n\t\tif (next->bios.ramcfg_11_01_01)\n\t\t\tdata |= 0x00000100;\n\t\tmask |= 0x00000100;\n\t}\n\tram_mask(fuc, 0x10f614, mask, data);\n\n\tdata = mask = 0x00000000;\n\tif (ram->diff.timing_20_30_07) {\n\t\tdata |= next->bios.timing_20_30_07 << 28;\n\t\tmask |= 0x70000000;\n\t}\n\tif (ram->diff.ramcfg_11_01_02) {\n\t\tif (next->bios.ramcfg_11_01_02)\n\t\t\tdata |= 0x00000100;\n\t\tmask |= 0x00000100;\n\t}\n\tram_mask(fuc, 0x10f610, mask, data);\n\n\tmask = 0x33f00000;\n\tdata = 0x00000000;\n\tif (!next->bios.ramcfg_11_01_04)\n\t\tdata |= 0x20200000;\n\tif (!next->bios.ramcfg_11_07_80)\n\t\tdata |= 0x12800000;\n\t \n\tif (next->bios.ramcfg_11_03_f0) {\n\t\tif (next->bios.rammap_11_08_0c) {\n\t\t\tif (!next->bios.ramcfg_11_07_80)\n\t\t\t\tmask |= 0x00000020;\n\t\t\telse\n\t\t\t\tdata |= 0x00000020;\n\t\t\tmask |= 0x00000004;\n\t\t}\n\t} else {\n\t\tmask |= 0x40000020;\n\t\tdata |= 0x00000004;\n\t}\n\n\tram_mask(fuc, 0x10f808, mask, data);\n\n\tram_wr32(fuc, 0x10f870, 0x11111111 * next->bios.ramcfg_11_03_0f);\n\n\tdata = mask = 0x00000000;\n\tif (ram->diff.ramcfg_11_02_03) {\n\t\tdata |= next->bios.ramcfg_11_02_03;\n\t\tmask |= 0x00000003;\n\t}\n\tif (ram->diff.ramcfg_11_01_10) {\n\t\tif (next->bios.ramcfg_11_01_10)\n\t\t\tdata |= 0x00000004;\n\t\tmask |= 0x00000004;\n\t}\n\n\tif ((ram_mask(fuc, 0x100770, mask, data) & mask & 4) != (data & 4)) {\n\t\tram_mask(fuc, 0x100750, 0x00000008, 0x00000008);\n\t\tram_wr32(fuc, 0x100710, 0x00000000);\n\t\tram_wait(fuc, 0x100710, 0x80000000, 0x80000000, 200000);\n\t}\n\n\tdata = next->bios.timing_20_30_07 << 8;\n\tif (next->bios.ramcfg_11_01_01)\n\t\tdata |= 0x80000000;\n\tram_mask(fuc, 0x100778, 0x00000700, data);\n\n\tram_mask(fuc, 0x10f250, 0x000003f0, next->bios.timing_20_2c_003f << 4);\n\tdata = (next->bios.timing[10] & 0x7f000000) >> 24;\n\tif (data < next->bios.timing_20_2c_1fc0)\n\t\tdata = next->bios.timing_20_2c_1fc0;\n\tram_mask(fuc, 0x10f24c, 0x7f000000, data << 24);\n\tram_mask(fuc, 0x10f224, 0x001f0000, next->bios.timing_20_30_f8 << 16);\n\n\tram_mask(fuc, 0x10fec4, 0x041e0f07, next->bios.timing_20_31_0800 << 26 |\n\t\t\t\t\t    next->bios.timing_20_31_0780 << 17 |\n\t\t\t\t\t    next->bios.timing_20_31_0078 << 8 |\n\t\t\t\t\t    next->bios.timing_20_31_0007);\n\tram_mask(fuc, 0x10fec8, 0x00000027, next->bios.timing_20_31_8000 << 5 |\n\t\t\t\t\t    next->bios.timing_20_31_7000);\n\n\tram_wr32(fuc, 0x10f090, 0x4000007e);\n\tram_nsec(fuc, 2000);\n\tram_wr32(fuc, 0x10f314, 0x00000001);  \n\tram_wr32(fuc, 0x10f310, 0x00000001);  \n\tram_wr32(fuc, 0x10f210, 0x80000000);  \n\n\tif (next->bios.ramcfg_11_08_10 && (ram->mode == 2)  ) {\n\t\tu32 temp = ram_mask(fuc, 0x10f294, 0xff000000, 0x24000000);\n\t\tgk104_ram_train(fuc, 0xbc0e0000, 0xa4010000);  \n\t\tram_nsec(fuc, 1000);\n\t\tram_wr32(fuc, 0x10f294, temp);\n\t}\n\n\tram_mask(fuc, mr[3], 0xfff, ram->base.mr[3]);\n\tram_wr32(fuc, mr[0], ram->base.mr[0]);\n\tram_mask(fuc, mr[8], 0xfff, ram->base.mr[8]);\n\tram_nsec(fuc, 1000);\n\tram_mask(fuc, mr[1], 0xfff, ram->base.mr[1]);\n\tram_mask(fuc, mr[5], 0xfff, ram->base.mr[5] & ~0x004);  \n\tram_mask(fuc, mr[6], 0xfff, ram->base.mr[6]);\n\tram_mask(fuc, mr[7], 0xfff, ram->base.mr[7]);\n\n\tif (vc == 0 && ram_have(fuc, gpio2E)) {\n\t\tu32 temp  = ram_mask(fuc, gpio2E, 0x3000, fuc->r_func2E[0]);\n\t\tif (temp != ram_rd32(fuc, gpio2E)) {\n\t\t\tram_wr32(fuc, gpiotrig, 1);\n\t\t\tram_nsec(fuc, 20000);\n\t\t}\n\t}\n\n\tram_mask(fuc, 0x10f200, 0x80000000, 0x80000000);\n\tram_wr32(fuc, 0x10f318, 0x00000001);  \n\tram_mask(fuc, 0x10f200, 0x80000000, 0x00000000);\n\tram_nsec(fuc, 1000);\n\tram_nuts(ram, 0x10f200, 0x18808800, 0x00000000, 0x18808800);\n\n\tdata  = ram_rd32(fuc, 0x10f978);\n\tdata &= ~0x00046144;\n\tdata |=  0x0000000b;\n\tif (!next->bios.ramcfg_11_07_08) {\n\t\tif (!next->bios.ramcfg_11_07_04)\n\t\t\tdata |= 0x0000200c;\n\t\telse\n\t\t\tdata |= 0x00000000;\n\t} else {\n\t\tdata |= 0x00040044;\n\t}\n\tram_wr32(fuc, 0x10f978, data);\n\n\tif (ram->mode == 1) {\n\t\tdata = ram_rd32(fuc, 0x10f830) | 0x00000001;\n\t\tram_wr32(fuc, 0x10f830, data);\n\t}\n\n\tif (!next->bios.ramcfg_11_07_08) {\n\t\tdata = 0x88020000;\n\t\tif ( next->bios.ramcfg_11_07_04)\n\t\t\tdata |= 0x10000000;\n\t\tif (!next->bios.rammap_11_08_10)\n\t\t\tdata |= 0x00080000;\n\t} else {\n\t\tdata = 0xa40e0000;\n\t}\n\tgk104_ram_train(fuc, 0xbc0f0000, data);\n\tif (1)  \n\t\tram_nsec(fuc, 1000);\n\n\tif (ram->mode == 2) {  \n\t\tram_mask(fuc, 0x10f800, 0x00000004, 0x00000004);\n\t}\n\n\t \n\tif (ram_mask(fuc, mr[5], 0x004, ram->base.mr[5]) != ram->base.mr[5])\n\t\tram_nsec(fuc, 1000);\n\n\tif (ram->mode != 2) {\n\t\tram_mask(fuc, 0x10f830, 0x01000000, 0x01000000);\n\t\tram_mask(fuc, 0x10f830, 0x01000000, 0x00000000);\n\t}\n\n\tif (next->bios.ramcfg_11_07_02)\n\t\tgk104_ram_train(fuc, 0x80020000, 0x01000000);\n\n\tram_unblock(fuc);\n\n\tif (ram->base.fb->subdev.device->disp)\n\t\tram_wr32(fuc, 0x62c000, 0x0f0f0f00);\n\n\tif (next->bios.rammap_11_08_01)\n\t\tdata = 0x00000800;\n\telse\n\t\tdata = 0x00000000;\n\tram_mask(fuc, 0x10f200, 0x00000800, data);\n\tram_nuts(ram, 0x10f200, 0x18808800, data, 0x18808800);\n\treturn 0;\n}\n\n \n\nstatic void\nnvkm_sddr3_dll_reset(struct gk104_ramfuc *fuc)\n{\n\tram_nuke(fuc, mr[0]);\n\tram_mask(fuc, mr[0], 0x100, 0x100);\n\tram_mask(fuc, mr[0], 0x100, 0x000);\n}\n\nstatic void\nnvkm_sddr3_dll_disable(struct gk104_ramfuc *fuc)\n{\n\tu32 mr1_old = ram_rd32(fuc, mr[1]);\n\n\tif (!(mr1_old & 0x1)) {\n\t\tram_mask(fuc, mr[1], 0x1, 0x1);\n\t\tram_nsec(fuc, 1000);\n\t}\n}\n\nstatic int\ngk104_ram_calc_sddr3(struct gk104_ram *ram, u32 freq)\n{\n\tstruct gk104_ramfuc *fuc = &ram->fuc;\n\tconst u32 rcoef = ((  ram->P1 << 16) | (ram->N1 << 8) | ram->M1);\n\tconst u32 runk0 = ram->fN1 << 16;\n\tconst u32 runk1 = ram->fN1;\n\tstruct nvkm_ram_data *next = ram->base.next;\n\tint vc = !next->bios.ramcfg_11_02_08;\n\tint mv = !next->bios.ramcfg_11_02_04;\n\tu32 mask, data;\n\n\tram_mask(fuc, 0x10f808, 0x40000000, 0x40000000);\n\tram_block(fuc);\n\n\tif (ram->base.fb->subdev.device->disp)\n\t\tram_wr32(fuc, 0x62c000, 0x0f0f0000);\n\n\tif (vc == 1 && ram_have(fuc, gpio2E)) {\n\t\tu32 temp  = ram_mask(fuc, gpio2E, 0x3000, fuc->r_func2E[1]);\n\t\tif (temp != ram_rd32(fuc, gpio2E)) {\n\t\t\tram_wr32(fuc, gpiotrig, 1);\n\t\t\tram_nsec(fuc, 20000);\n\t\t}\n\t}\n\n\tram_mask(fuc, 0x10f200, 0x00000800, 0x00000000);\n\tif (next->bios.ramcfg_11_03_f0)\n\t\tram_mask(fuc, 0x10f808, 0x04000000, 0x04000000);\n\n\tram_wr32(fuc, 0x10f314, 0x00000001);  \n\n\tif (next->bios.ramcfg_DLLoff)\n\t\tnvkm_sddr3_dll_disable(fuc);\n\n\tram_wr32(fuc, 0x10f210, 0x00000000);  \n\tram_wr32(fuc, 0x10f310, 0x00000001);  \n\tram_mask(fuc, 0x10f200, 0x80000000, 0x80000000);\n\tram_wr32(fuc, 0x10f310, 0x00000001);  \n\tram_mask(fuc, 0x10f200, 0x80000000, 0x00000000);\n\tram_nsec(fuc, 1000);\n\n\tram_wr32(fuc, 0x10f090, 0x00000060);\n\tram_wr32(fuc, 0x10f090, 0xc000007e);\n\n\t \n\tmask = 0x00010000;\n\tdata = 0x00010000;\n\n\tif (1) {\n\t\tmask |= 0x800807e0;\n\t\tdata |= 0x800807e0;\n\t\tswitch (next->bios.ramcfg_11_03_c0) {\n\t\tcase 3: data &= ~0x00000040; break;\n\t\tcase 2: data &= ~0x00000100; break;\n\t\tcase 1: data &= ~0x80000000; break;\n\t\tcase 0: data &= ~0x00000400; break;\n\t\t}\n\n\t\tswitch (next->bios.ramcfg_11_03_30) {\n\t\tcase 3: data &= ~0x00000020; break;\n\t\tcase 2: data &= ~0x00000080; break;\n\t\tcase 1: data &= ~0x00080000; break;\n\t\tcase 0: data &= ~0x00000200; break;\n\t\t}\n\t}\n\n\tif (next->bios.ramcfg_11_02_80)\n\t\tmask |= 0x03000000;\n\tif (next->bios.ramcfg_11_02_40)\n\t\tmask |= 0x00002000;\n\tif (next->bios.ramcfg_11_07_10)\n\t\tmask |= 0x00004000;\n\tif (next->bios.ramcfg_11_07_08)\n\t\tmask |= 0x00000003;\n\telse\n\t\tmask |= 0x14000000;\n\tram_mask(fuc, 0x10f824, mask, data);\n\n\tram_mask(fuc, 0x132040, 0x00010000, 0x00000000);\n\n\tram_mask(fuc, 0x1373f4, 0x00000000, 0x00010010);\n\tdata  = ram_rd32(fuc, 0x1373ec) & ~0x00030000;\n\tdata |= next->bios.ramcfg_11_03_30 << 16;\n\tram_wr32(fuc, 0x1373ec, data);\n\tram_mask(fuc, 0x1373f4, 0x00000003, 0x00000000);\n\tram_mask(fuc, 0x1373f4, 0x00000010, 0x00000000);\n\n\t \n\tif ((ram_rd32(fuc, 0x132024) & 0xffffffff) != rcoef ||\n\t    (ram_rd32(fuc, 0x132034) & 0x0000ffff) != runk1) {\n\t\tram_mask(fuc, 0x132000, 0x00000001, 0x00000000);\n\t\tram_mask(fuc, 0x132020, 0x00000001, 0x00000000);\n\t\tram_wr32(fuc, 0x137320, 0x00000000);\n\t\tram_mask(fuc, 0x132030, 0xffff0000, runk0);\n\t\tram_mask(fuc, 0x132034, 0x0000ffff, runk1);\n\t\tram_wr32(fuc, 0x132024, rcoef);\n\t\tram_mask(fuc, 0x132028, 0x00080000, 0x00080000);\n\t\tram_mask(fuc, 0x132020, 0x00000001, 0x00000001);\n\t\tram_wait(fuc, 0x137390, 0x00020000, 0x00020000, 64000);\n\t\tram_mask(fuc, 0x132028, 0x00080000, 0x00000000);\n\t}\n\n\tram_mask(fuc, 0x1373f4, 0x00000010, 0x00000010);\n\tram_mask(fuc, 0x1373f4, 0x00000003, 0x00000001);\n\tram_mask(fuc, 0x1373f4, 0x00010000, 0x00000000);\n\n\tif (ram_have(fuc, gpioMV)) {\n\t\tu32 temp  = ram_mask(fuc, gpioMV, 0x3000, fuc->r_funcMV[mv]);\n\t\tif (temp != ram_rd32(fuc, gpioMV)) {\n\t\t\tram_wr32(fuc, gpiotrig, 1);\n\t\t\tram_nsec(fuc, 64000);\n\t\t}\n\t}\n\n\tif (next->bios.ramcfg_11_02_40 ||\n\t    next->bios.ramcfg_11_07_10) {\n\t\tram_mask(fuc, 0x132040, 0x00010000, 0x00010000);\n\t\tram_nsec(fuc, 20000);\n\t}\n\n\tif (ram->mode != 2)   {\n\t\tif (next->bios.ramcfg_11_07_40)\n\t\t\tram_mask(fuc, 0x10f670, 0x80000000, 0x80000000);\n\t}\n\n\tram_wr32(fuc, 0x10f65c, 0x00000011 * next->bios.rammap_11_11_0c);\n\tram_wr32(fuc, 0x10f6b8, 0x01010101 * next->bios.ramcfg_11_09);\n\tram_wr32(fuc, 0x10f6bc, 0x01010101 * next->bios.ramcfg_11_09);\n\n\tmask = 0x00010000;\n\tdata = 0x00000000;\n\tif (!next->bios.ramcfg_11_02_80)\n\t\tdata |= 0x03000000;\n\tif (!next->bios.ramcfg_11_02_40)\n\t\tdata |= 0x00002000;\n\tif (!next->bios.ramcfg_11_07_10)\n\t\tdata |= 0x00004000;\n\tif (!next->bios.ramcfg_11_07_08)\n\t\tdata |= 0x00000003;\n\telse\n\t\tdata |= 0x14000000;\n\tram_mask(fuc, 0x10f824, mask, data);\n\tram_nsec(fuc, 1000);\n\n\tif (next->bios.ramcfg_11_08_01)\n\t\tdata = 0x00100000;\n\telse\n\t\tdata = 0x00000000;\n\tram_mask(fuc, 0x10f82c, 0x00100000, data);\n\n\t \n\tram_mask(fuc, 0x10f248, 0xffffffff, next->bios.timing[10]);\n\tram_mask(fuc, 0x10f290, 0xffffffff, next->bios.timing[0]);\n\tram_mask(fuc, 0x10f294, 0xffffffff, next->bios.timing[1]);\n\tram_mask(fuc, 0x10f298, 0xffffffff, next->bios.timing[2]);\n\tram_mask(fuc, 0x10f29c, 0xffffffff, next->bios.timing[3]);\n\tram_mask(fuc, 0x10f2a0, 0xffffffff, next->bios.timing[4]);\n\tram_mask(fuc, 0x10f2a4, 0xffffffff, next->bios.timing[5]);\n\tram_mask(fuc, 0x10f2a8, 0xffffffff, next->bios.timing[6]);\n\tram_mask(fuc, 0x10f2ac, 0xffffffff, next->bios.timing[7]);\n\tram_mask(fuc, 0x10f2cc, 0xffffffff, next->bios.timing[8]);\n\tram_mask(fuc, 0x10f2e8, 0xffffffff, next->bios.timing[9]);\n\n\tmask = 0x33f00000;\n\tdata = 0x00000000;\n\tif (!next->bios.ramcfg_11_01_04)\n\t\tdata |= 0x20200000;\n\tif (!next->bios.ramcfg_11_07_80)\n\t\tdata |= 0x12800000;\n\t \n\tif (next->bios.ramcfg_11_03_f0) {\n\t\tif (next->bios.rammap_11_08_0c) {\n\t\t\tif (!next->bios.ramcfg_11_07_80)\n\t\t\t\tmask |= 0x00000020;\n\t\t\telse\n\t\t\t\tdata |= 0x00000020;\n\t\t\tmask |= 0x08000004;\n\t\t}\n\t\tdata |= 0x04000000;\n\t} else {\n\t\tmask |= 0x44000020;\n\t\tdata |= 0x08000004;\n\t}\n\n\tram_mask(fuc, 0x10f808, mask, data);\n\n\tram_wr32(fuc, 0x10f870, 0x11111111 * next->bios.ramcfg_11_03_0f);\n\n\tram_mask(fuc, 0x10f250, 0x000003f0, next->bios.timing_20_2c_003f << 4);\n\n\tdata = (next->bios.timing[10] & 0x7f000000) >> 24;\n\tif (data < next->bios.timing_20_2c_1fc0)\n\t\tdata = next->bios.timing_20_2c_1fc0;\n\tram_mask(fuc, 0x10f24c, 0x7f000000, data << 24);\n\n\tram_mask(fuc, 0x10f224, 0x001f0000, next->bios.timing_20_30_f8 << 16);\n\n\tram_wr32(fuc, 0x10f090, 0x4000007f);\n\tram_nsec(fuc, 1000);\n\n\tram_wr32(fuc, 0x10f314, 0x00000001);  \n\tram_wr32(fuc, 0x10f310, 0x00000001);  \n\tram_wr32(fuc, 0x10f210, 0x80000000);  \n\tram_nsec(fuc, 1000);\n\n\tif (!next->bios.ramcfg_DLLoff) {\n\t\tram_mask(fuc, mr[1], 0x1, 0x0);\n\t\tnvkm_sddr3_dll_reset(fuc);\n\t}\n\n\tram_mask(fuc, mr[2], 0x00000fff, ram->base.mr[2]);\n\tram_mask(fuc, mr[1], 0xffffffff, ram->base.mr[1]);\n\tram_wr32(fuc, mr[0], ram->base.mr[0]);\n\tram_nsec(fuc, 1000);\n\n\tif (!next->bios.ramcfg_DLLoff) {\n\t\tnvkm_sddr3_dll_reset(fuc);\n\t\tram_nsec(fuc, 1000);\n\t}\n\n\tif (vc == 0 && ram_have(fuc, gpio2E)) {\n\t\tu32 temp  = ram_mask(fuc, gpio2E, 0x3000, fuc->r_func2E[0]);\n\t\tif (temp != ram_rd32(fuc, gpio2E)) {\n\t\t\tram_wr32(fuc, gpiotrig, 1);\n\t\t\tram_nsec(fuc, 20000);\n\t\t}\n\t}\n\n\tif (ram->mode != 2) {\n\t\tram_mask(fuc, 0x10f830, 0x01000000, 0x01000000);\n\t\tram_mask(fuc, 0x10f830, 0x01000000, 0x00000000);\n\t}\n\n\tram_mask(fuc, 0x10f200, 0x80000000, 0x80000000);\n\tram_wr32(fuc, 0x10f318, 0x00000001);  \n\tram_mask(fuc, 0x10f200, 0x80000000, 0x00000000);\n\tram_nsec(fuc, 1000);\n\n\tram_unblock(fuc);\n\n\tif (ram->base.fb->subdev.device->disp)\n\t\tram_wr32(fuc, 0x62c000, 0x0f0f0f00);\n\n\tif (next->bios.rammap_11_08_01)\n\t\tdata = 0x00000800;\n\telse\n\t\tdata = 0x00000000;\n\tram_mask(fuc, 0x10f200, 0x00000800, data);\n\treturn 0;\n}\n\n \n\nstatic int\ngk104_ram_calc_data(struct gk104_ram *ram, u32 khz, struct nvkm_ram_data *data)\n{\n\tstruct nvkm_subdev *subdev = &ram->base.fb->subdev;\n\tstruct nvkm_ram_data *cfg;\n\tu32 mhz = khz / 1000;\n\n\tlist_for_each_entry(cfg, &ram->cfg, head) {\n\t\tif (mhz >= cfg->bios.rammap_min &&\n\t\t    mhz <= cfg->bios.rammap_max) {\n\t\t\t*data = *cfg;\n\t\t\tdata->freq = khz;\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tnvkm_error(subdev, \"ramcfg data for %dMHz not found\\n\", mhz);\n\treturn -EINVAL;\n}\n\nstatic int\ngk104_calc_pll_output(int fN, int M, int N, int P, int clk)\n{\n\treturn ((clk * N) + (((u16)(fN + 4096) * clk) >> 13)) / (M * P);\n}\n\nstatic int\ngk104_pll_calc_hiclk(int target_khz, int crystal,\n\t\tint *N1, int *fN1, int *M1, int *P1,\n\t\tint *N2, int *M2, int *P2)\n{\n\tint best_err = target_khz, p_ref, n_ref;\n\tbool upper = false;\n\n\t*M1 = 1;\n\t \n\t*M2 = 1;\n\t \n\t*P2 = 1;\n\n\tfor (p_ref = 0x7; p_ref >= 0x5; --p_ref) {\n\t\tfor (n_ref = 0x25; n_ref <= 0x2b; ++n_ref) {\n\t\t\tint cur_N, cur_clk, cur_err;\n\n\t\t\tcur_clk = gk104_calc_pll_output(0, 1, n_ref, p_ref, crystal);\n\t\t\tcur_N = target_khz / cur_clk;\n\t\t\tcur_err = target_khz\n\t\t\t\t- gk104_calc_pll_output(0xf000, 1, cur_N, 1, cur_clk);\n\n\t\t\t \n\t\t\tif (cur_err < best_err) {\n\t\t\t\tbest_err = cur_err;\n\t\t\t\t*N2 = cur_N;\n\t\t\t\t*N1 = n_ref;\n\t\t\t\t*P1 = p_ref;\n\t\t\t\tupper = false;\n\t\t\t}\n\n\t\t\tcur_N += 1;\n\t\t\tcur_err = gk104_calc_pll_output(0xf000, 1, cur_N, 1, cur_clk)\n\t\t\t\t- target_khz;\n\t\t\tif (cur_err < best_err) {\n\t\t\t\tbest_err = cur_err;\n\t\t\t\t*N2 = cur_N;\n\t\t\t\t*N1 = n_ref;\n\t\t\t\t*P1 = p_ref;\n\t\t\t\tupper = true;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\t*fN1 = (u16)((((best_err / *N2 * *P2) * (*P1 * *M1)) << 13) / crystal);\n\tif (upper)\n\t\t*fN1 = (u16)(1 - *fN1);\n\n\treturn gk104_calc_pll_output(*fN1, 1, *N1, *P1, crystal);\n}\n\nstatic int\ngk104_ram_calc_xits(struct gk104_ram *ram, struct nvkm_ram_data *next)\n{\n\tstruct gk104_ramfuc *fuc = &ram->fuc;\n\tstruct nvkm_subdev *subdev = &ram->base.fb->subdev;\n\tint refclk, i;\n\tint ret;\n\n\tret = ram_init(fuc, ram->base.fb);\n\tif (ret)\n\t\treturn ret;\n\n\tram->mode = (next->freq > fuc->refpll.vco1.max_freq) ? 2 : 1;\n\tram->from = ram_rd32(fuc, 0x1373f4) & 0x0000000f;\n\n\t \n\trefclk = next->freq;\n\tif (ram->mode == 2) {\n\t\tret = gk104_pll_calc_hiclk(next->freq, subdev->device->crystal,\n\t\t\t\t&ram->N1, &ram->fN1, &ram->M1, &ram->P1,\n\t\t\t\t&ram->N2, &ram->M2, &ram->P2);\n\t\tfuc->mempll.refclk = ret;\n\t\tif (ret <= 0) {\n\t\t\tnvkm_error(subdev, \"unable to calc plls\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tnvkm_debug(subdev, \"successfully calced PLLs for clock %i kHz\"\n\t\t\t\t\" (refclock: %i kHz)\\n\", next->freq, ret);\n\t} else {\n\t\t \n\t\tret = gt215_pll_calc(subdev, &fuc->refpll, refclk, &ram->N1,\n\t\t\t\t     &ram->fN1, &ram->M1, &ram->P1);\n\t\tfuc->mempll.refclk = ret;\n\t\tif (ret <= 0) {\n\t\t\tnvkm_error(subdev, \"unable to calc refpll\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(fuc->r_mr); i++) {\n\t\tif (ram_have(fuc, mr[i]))\n\t\t\tram->base.mr[i] = ram_rd32(fuc, mr[i]);\n\t}\n\tram->base.freq = next->freq;\n\n\tswitch (ram->base.type) {\n\tcase NVKM_RAM_TYPE_DDR3:\n\t\tret = nvkm_sddr3_calc(&ram->base);\n\t\tif (ret == 0)\n\t\t\tret = gk104_ram_calc_sddr3(ram, next->freq);\n\t\tbreak;\n\tcase NVKM_RAM_TYPE_GDDR5:\n\t\tret = nvkm_gddr5_calc(&ram->base, ram->pnuts != 0);\n\t\tif (ret == 0)\n\t\t\tret = gk104_ram_calc_gddr5(ram, next->freq);\n\t\tbreak;\n\tdefault:\n\t\tret = -ENOSYS;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nint\ngk104_ram_calc(struct nvkm_ram *base, u32 freq)\n{\n\tstruct gk104_ram *ram = gk104_ram(base);\n\tstruct nvkm_clk *clk = ram->base.fb->subdev.device->clk;\n\tstruct nvkm_ram_data *xits = &ram->base.xition;\n\tstruct nvkm_ram_data *copy;\n\tint ret;\n\n\tif (ram->base.next == NULL) {\n\t\tret = gk104_ram_calc_data(ram,\n\t\t\t\t\t  nvkm_clk_read(clk, nv_clk_src_mem),\n\t\t\t\t\t  &ram->base.former);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = gk104_ram_calc_data(ram, freq, &ram->base.target);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (ram->base.target.freq < ram->base.former.freq) {\n\t\t\t*xits = ram->base.target;\n\t\t\tcopy = &ram->base.former;\n\t\t} else {\n\t\t\t*xits = ram->base.former;\n\t\t\tcopy = &ram->base.target;\n\t\t}\n\n\t\txits->bios.ramcfg_11_02_04 = copy->bios.ramcfg_11_02_04;\n\t\txits->bios.ramcfg_11_02_03 = copy->bios.ramcfg_11_02_03;\n\t\txits->bios.timing_20_30_07 = copy->bios.timing_20_30_07;\n\n\t\tram->base.next = &ram->base.target;\n\t\tif (memcmp(xits, &ram->base.former, sizeof(xits->bios)))\n\t\t\tram->base.next = &ram->base.xition;\n\t} else {\n\t\tBUG_ON(ram->base.next != &ram->base.xition);\n\t\tram->base.next = &ram->base.target;\n\t}\n\n\treturn gk104_ram_calc_xits(ram, ram->base.next);\n}\n\nstatic void\ngk104_ram_prog_0(struct gk104_ram *ram, u32 freq)\n{\n\tstruct nvkm_device *device = ram->base.fb->subdev.device;\n\tstruct nvkm_ram_data *cfg;\n\tu32 mhz = freq / 1000;\n\tu32 mask, data;\n\n\tlist_for_each_entry(cfg, &ram->cfg, head) {\n\t\tif (mhz >= cfg->bios.rammap_min &&\n\t\t    mhz <= cfg->bios.rammap_max)\n\t\t\tbreak;\n\t}\n\n\tif (&cfg->head == &ram->cfg)\n\t\treturn;\n\n\tif (mask = 0, data = 0, ram->diff.rammap_11_0a_03fe) {\n\t\tdata |= cfg->bios.rammap_11_0a_03fe << 12;\n\t\tmask |= 0x001ff000;\n\t}\n\tif (ram->diff.rammap_11_09_01ff) {\n\t\tdata |= cfg->bios.rammap_11_09_01ff;\n\t\tmask |= 0x000001ff;\n\t}\n\tnvkm_mask(device, 0x10f468, mask, data);\n\n\tif (mask = 0, data = 0, ram->diff.rammap_11_0a_0400) {\n\t\tdata |= cfg->bios.rammap_11_0a_0400;\n\t\tmask |= 0x00000001;\n\t}\n\tnvkm_mask(device, 0x10f420, mask, data);\n\n\tif (mask = 0, data = 0, ram->diff.rammap_11_0a_0800) {\n\t\tdata |= cfg->bios.rammap_11_0a_0800;\n\t\tmask |= 0x00000001;\n\t}\n\tnvkm_mask(device, 0x10f430, mask, data);\n\n\tif (mask = 0, data = 0, ram->diff.rammap_11_0b_01f0) {\n\t\tdata |= cfg->bios.rammap_11_0b_01f0;\n\t\tmask |= 0x0000001f;\n\t}\n\tnvkm_mask(device, 0x10f400, mask, data);\n\n\tif (mask = 0, data = 0, ram->diff.rammap_11_0b_0200) {\n\t\tdata |= cfg->bios.rammap_11_0b_0200 << 9;\n\t\tmask |= 0x00000200;\n\t}\n\tnvkm_mask(device, 0x10f410, mask, data);\n\n\tif (mask = 0, data = 0, ram->diff.rammap_11_0d) {\n\t\tdata |= cfg->bios.rammap_11_0d << 16;\n\t\tmask |= 0x00ff0000;\n\t}\n\tif (ram->diff.rammap_11_0f) {\n\t\tdata |= cfg->bios.rammap_11_0f << 8;\n\t\tmask |= 0x0000ff00;\n\t}\n\tnvkm_mask(device, 0x10f440, mask, data);\n\n\tif (mask = 0, data = 0, ram->diff.rammap_11_0e) {\n\t\tdata |= cfg->bios.rammap_11_0e << 8;\n\t\tmask |= 0x0000ff00;\n\t}\n\tif (ram->diff.rammap_11_0b_0800) {\n\t\tdata |= cfg->bios.rammap_11_0b_0800 << 7;\n\t\tmask |= 0x00000080;\n\t}\n\tif (ram->diff.rammap_11_0b_0400) {\n\t\tdata |= cfg->bios.rammap_11_0b_0400 << 5;\n\t\tmask |= 0x00000020;\n\t}\n\tnvkm_mask(device, 0x10f444, mask, data);\n}\n\nint\ngk104_ram_prog(struct nvkm_ram *base)\n{\n\tstruct gk104_ram *ram = gk104_ram(base);\n\tstruct gk104_ramfuc *fuc = &ram->fuc;\n\tstruct nvkm_device *device = ram->base.fb->subdev.device;\n\tstruct nvkm_ram_data *next = ram->base.next;\n\n\tif (!nvkm_boolopt(device->cfgopt, \"NvMemExec\", true)) {\n\t\tram_exec(fuc, false);\n\t\treturn (ram->base.next == &ram->base.xition);\n\t}\n\n\tgk104_ram_prog_0(ram, 1000);\n\tram_exec(fuc, true);\n\tgk104_ram_prog_0(ram, next->freq);\n\n\treturn (ram->base.next == &ram->base.xition);\n}\n\nvoid\ngk104_ram_tidy(struct nvkm_ram *base)\n{\n\tstruct gk104_ram *ram = gk104_ram(base);\n\tram->base.next = NULL;\n\tram_exec(&ram->fuc, false);\n}\n\nstruct gk104_ram_train {\n\tu16 mask;\n\tstruct nvbios_M0209S remap;\n\tstruct nvbios_M0209S type00;\n\tstruct nvbios_M0209S type01;\n\tstruct nvbios_M0209S type04;\n\tstruct nvbios_M0209S type06;\n\tstruct nvbios_M0209S type07;\n\tstruct nvbios_M0209S type08;\n\tstruct nvbios_M0209S type09;\n};\n\nstatic int\ngk104_ram_train_type(struct nvkm_ram *ram, int i, u8 ramcfg,\n\t\t     struct gk104_ram_train *train)\n{\n\tstruct nvkm_bios *bios = ram->fb->subdev.device->bios;\n\tstruct nvbios_M0205E M0205E;\n\tstruct nvbios_M0205S M0205S;\n\tstruct nvbios_M0209E M0209E;\n\tstruct nvbios_M0209S *remap = &train->remap;\n\tstruct nvbios_M0209S *value;\n\tu8  ver, hdr, cnt, len;\n\tu32 data;\n\n\t \n\tif (!(data = nvbios_M0205Ep(bios, i, &ver, &hdr, &cnt, &len, &M0205E)))\n\t\treturn -ENOENT;\n\n\tswitch (M0205E.type) {\n\tcase 0x00: value = &train->type00; break;\n\tcase 0x01: value = &train->type01; break;\n\tcase 0x04: value = &train->type04; break;\n\tcase 0x06: value = &train->type06; break;\n\tcase 0x07: value = &train->type07; break;\n\tcase 0x08: value = &train->type08; break;\n\tcase 0x09: value = &train->type09; break;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\t \n\tif (!(data = nvbios_M0205Sp(bios, i, ramcfg, &ver, &hdr, &M0205S)))\n\t\treturn -EINVAL;\n\ti = M0205S.data;\n\n\t \n\tif (!(data = nvbios_M0209Ep(bios, i, &ver, &hdr, &cnt, &len, &M0209E)))\n\t\treturn -EINVAL;\n\n\t \n\tif (!(data = nvbios_M0209Sp(bios, i, 0, &ver, &hdr, value)))\n\t\treturn -EINVAL;\n\n\tif (M0209E.v02_07 == 2) {\n\t\t \n\t\tif (!(data = nvbios_M0209Sp(bios, M0209E.v03, 0, &ver, &hdr,\n\t\t\t\t\t    remap)))\n\t\t\treturn -EINVAL;\n\n\t\tfor (i = 0; i < ARRAY_SIZE(value->data); i++)\n\t\t\tvalue->data[i] = remap->data[value->data[i]];\n\t} else\n\tif (M0209E.v02_07 != 1)\n\t\treturn -EINVAL;\n\n\ttrain->mask |= 1 << M0205E.type;\n\treturn 0;\n}\n\nstatic int\ngk104_ram_train_init_0(struct nvkm_ram *ram, struct gk104_ram_train *train)\n{\n\tstruct nvkm_subdev *subdev = &ram->fb->subdev;\n\tstruct nvkm_device *device = subdev->device;\n\tint i, j;\n\n\tif ((train->mask & 0x03d3) != 0x03d3) {\n\t\tnvkm_warn(subdev, \"missing link training data\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < 0x30; i++) {\n\t\tfor (j = 0; j < 8; j += 4) {\n\t\t\tnvkm_wr32(device, 0x10f968 + j, 0x00000000 | (i << 8));\n\t\t\tnvkm_wr32(device, 0x10f920 + j, 0x00000000 |\n\t\t\t\t\t\t   train->type08.data[i] << 4 |\n\t\t\t\t\t\t   train->type06.data[i]);\n\t\t\tnvkm_wr32(device, 0x10f918 + j, train->type00.data[i]);\n\t\t\tnvkm_wr32(device, 0x10f920 + j, 0x00000100 |\n\t\t\t\t\t\t   train->type09.data[i] << 4 |\n\t\t\t\t\t\t   train->type07.data[i]);\n\t\t\tnvkm_wr32(device, 0x10f918 + j, train->type01.data[i]);\n\t\t}\n\t}\n\n\tfor (j = 0; j < 8; j += 4) {\n\t\tfor (i = 0; i < 0x100; i++) {\n\t\t\tnvkm_wr32(device, 0x10f968 + j, i);\n\t\t\tnvkm_wr32(device, 0x10f900 + j, train->type04.data[i]);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int\ngk104_ram_train_init(struct nvkm_ram *ram)\n{\n\tu8 ramcfg = nvbios_ramcfg_index(&ram->fb->subdev);\n\tstruct gk104_ram_train *train;\n\tint ret, i;\n\n\tif (!(train = kzalloc(sizeof(*train), GFP_KERNEL)))\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < 0x100; i++) {\n\t\tret = gk104_ram_train_type(ram, i, ramcfg, train);\n\t\tif (ret && ret != -ENOENT)\n\t\t\tbreak;\n\t}\n\n\tswitch (ram->type) {\n\tcase NVKM_RAM_TYPE_GDDR5:\n\t\tret = gk104_ram_train_init_0(ram, train);\n\t\tbreak;\n\tdefault:\n\t\tret = 0;\n\t\tbreak;\n\t}\n\n\tkfree(train);\n\treturn ret;\n}\n\nint\ngk104_ram_init(struct nvkm_ram *ram)\n{\n\tstruct nvkm_subdev *subdev = &ram->fb->subdev;\n\tstruct nvkm_device *device = subdev->device;\n\tstruct nvkm_bios *bios = device->bios;\n\tu8  ver, hdr, cnt, len, snr, ssz;\n\tu32 data, save;\n\tint i;\n\n\t \n\tdata = nvbios_rammapTe(bios, &ver, &hdr, &cnt, &len, &snr, &ssz);\n\tif (!data || hdr < 0x15)\n\t\treturn -EINVAL;\n\n\tcnt  = nvbios_rd08(bios, data + 0x14);  \n\tdata = nvbios_rd32(bios, data + 0x10);  \n\tsave = nvkm_rd32(device, 0x10f65c) & 0x000000f0;\n\tfor (i = 0; i < cnt; i++, data += 4) {\n\t\tif (i != save >> 4) {\n\t\t\tnvkm_mask(device, 0x10f65c, 0x000000f0, i << 4);\n\t\t\tnvbios_init(subdev, nvbios_rd32(bios, data));\n\t\t}\n\t}\n\tnvkm_mask(device, 0x10f65c, 0x000000f0, save);\n\tnvkm_mask(device, 0x10f584, 0x11000000, 0x00000000);\n\tnvkm_wr32(device, 0x10ecc0, 0xffffffff);\n\tnvkm_mask(device, 0x10f160, 0x00000010, 0x00000010);\n\n\treturn gk104_ram_train_init(ram);\n}\n\nstatic int\ngk104_ram_ctor_data(struct gk104_ram *ram, u8 ramcfg, int i)\n{\n\tstruct nvkm_bios *bios = ram->base.fb->subdev.device->bios;\n\tstruct nvkm_ram_data *cfg;\n\tstruct nvbios_ramcfg *d = &ram->diff;\n\tstruct nvbios_ramcfg *p, *n;\n\tu8  ver, hdr, cnt, len;\n\tu32 data;\n\tint ret;\n\n\tif (!(cfg = kmalloc(sizeof(*cfg), GFP_KERNEL)))\n\t\treturn -ENOMEM;\n\tp = &list_last_entry(&ram->cfg, typeof(*cfg), head)->bios;\n\tn = &cfg->bios;\n\n\t \n\tdata = nvbios_rammapEp(bios, i, &ver, &hdr, &cnt, &len, &cfg->bios);\n\tif (ret = -ENOENT, !data)\n\t\tgoto done;\n\tif (ret = -ENOSYS, ver != 0x11 || hdr < 0x12)\n\t\tgoto done;\n\n\t \n\tdata = nvbios_rammapSp(bios, data, ver, hdr, cnt, len, ramcfg,\n\t\t\t       &ver, &hdr, &cfg->bios);\n\tif (ret = -EINVAL, !data)\n\t\tgoto done;\n\tif (ret = -ENOSYS, ver != 0x11 || hdr < 0x0a)\n\t\tgoto done;\n\n\t \n\tif (cfg->bios.ramcfg_timing != 0xff) {\n\t\tdata = nvbios_timingEp(bios, cfg->bios.ramcfg_timing,\n\t\t\t\t       &ver, &hdr, &cnt, &len,\n\t\t\t\t       &cfg->bios);\n\t\tif (ret = -EINVAL, !data)\n\t\t\tgoto done;\n\t\tif (ret = -ENOSYS, ver != 0x20 || hdr < 0x33)\n\t\t\tgoto done;\n\t}\n\n\tlist_add_tail(&cfg->head, &ram->cfg);\n\tif (ret = 0, i == 0)\n\t\tgoto done;\n\n\td->rammap_11_0a_03fe |= p->rammap_11_0a_03fe != n->rammap_11_0a_03fe;\n\td->rammap_11_09_01ff |= p->rammap_11_09_01ff != n->rammap_11_09_01ff;\n\td->rammap_11_0a_0400 |= p->rammap_11_0a_0400 != n->rammap_11_0a_0400;\n\td->rammap_11_0a_0800 |= p->rammap_11_0a_0800 != n->rammap_11_0a_0800;\n\td->rammap_11_0b_01f0 |= p->rammap_11_0b_01f0 != n->rammap_11_0b_01f0;\n\td->rammap_11_0b_0200 |= p->rammap_11_0b_0200 != n->rammap_11_0b_0200;\n\td->rammap_11_0d |= p->rammap_11_0d != n->rammap_11_0d;\n\td->rammap_11_0f |= p->rammap_11_0f != n->rammap_11_0f;\n\td->rammap_11_0e |= p->rammap_11_0e != n->rammap_11_0e;\n\td->rammap_11_0b_0800 |= p->rammap_11_0b_0800 != n->rammap_11_0b_0800;\n\td->rammap_11_0b_0400 |= p->rammap_11_0b_0400 != n->rammap_11_0b_0400;\n\td->ramcfg_11_01_01 |= p->ramcfg_11_01_01 != n->ramcfg_11_01_01;\n\td->ramcfg_11_01_02 |= p->ramcfg_11_01_02 != n->ramcfg_11_01_02;\n\td->ramcfg_11_01_10 |= p->ramcfg_11_01_10 != n->ramcfg_11_01_10;\n\td->ramcfg_11_02_03 |= p->ramcfg_11_02_03 != n->ramcfg_11_02_03;\n\td->ramcfg_11_08_20 |= p->ramcfg_11_08_20 != n->ramcfg_11_08_20;\n\td->timing_20_30_07 |= p->timing_20_30_07 != n->timing_20_30_07;\ndone:\n\tif (ret)\n\t\tkfree(cfg);\n\treturn ret;\n}\n\nvoid *\ngk104_ram_dtor(struct nvkm_ram *base)\n{\n\tstruct gk104_ram *ram = gk104_ram(base);\n\tstruct nvkm_ram_data *cfg, *tmp;\n\n\tlist_for_each_entry_safe(cfg, tmp, &ram->cfg, head) {\n\t\tkfree(cfg);\n\t}\n\n\treturn ram;\n}\n\nint\ngk104_ram_new_(const struct nvkm_ram_func *func, struct nvkm_fb *fb,\n\t       struct nvkm_ram **pram)\n{\n\tstruct nvkm_subdev *subdev = &fb->subdev;\n\tstruct nvkm_device *device = subdev->device;\n\tstruct nvkm_bios *bios = device->bios;\n\tstruct dcb_gpio_func gpio;\n\tstruct gk104_ram *ram;\n\tint ret, i;\n\tu8  ramcfg = nvbios_ramcfg_index(subdev);\n\tu32 tmp;\n\n\tif (!(ram = kzalloc(sizeof(*ram), GFP_KERNEL)))\n\t\treturn -ENOMEM;\n\t*pram = &ram->base;\n\n\tret = gf100_ram_ctor(func, fb, &ram->base);\n\tif (ret)\n\t\treturn ret;\n\n\tINIT_LIST_HEAD(&ram->cfg);\n\n\t \n\tram->parts = nvkm_rd32(device, 0x022438);\n\tram->pmask = nvkm_rd32(device, 0x022554);\n\tram->pnuts = 0;\n\tfor (i = 0, tmp = 0; i < ram->parts; i++) {\n\t\tif (!(ram->pmask & (1 << i))) {\n\t\t\tu32 cfg1 = nvkm_rd32(device, 0x110204 + (i * 0x1000));\n\t\t\tif (tmp && tmp != cfg1) {\n\t\t\t\tram->pnuts |= (1 << i);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\ttmp = cfg1;\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; !ret; i++) {\n\t\tret = gk104_ram_ctor_data(ram, ramcfg, i);\n\t\tif (ret && ret != -ENOENT) {\n\t\t\tnvkm_error(subdev, \"failed to parse ramcfg data\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tret = nvbios_pll_parse(bios, 0x0c, &ram->fuc.refpll);\n\tif (ret) {\n\t\tnvkm_error(subdev, \"mclk refpll data not found\\n\");\n\t\treturn ret;\n\t}\n\n\tret = nvbios_pll_parse(bios, 0x04, &ram->fuc.mempll);\n\tif (ret) {\n\t\tnvkm_error(subdev, \"mclk pll data not found\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = nvkm_gpio_find(device->gpio, 0, 0x18, DCB_GPIO_UNUSED, &gpio);\n\tif (ret == 0) {\n\t\tram->fuc.r_gpioMV = ramfuc_reg(0x00d610 + (gpio.line * 0x04));\n\t\tram->fuc.r_funcMV[0] = (gpio.log[0] ^ 2) << 12;\n\t\tram->fuc.r_funcMV[1] = (gpio.log[1] ^ 2) << 12;\n\t}\n\n\tret = nvkm_gpio_find(device->gpio, 0, 0x2e, DCB_GPIO_UNUSED, &gpio);\n\tif (ret == 0) {\n\t\tram->fuc.r_gpio2E = ramfuc_reg(0x00d610 + (gpio.line * 0x04));\n\t\tram->fuc.r_func2E[0] = (gpio.log[0] ^ 2) << 12;\n\t\tram->fuc.r_func2E[1] = (gpio.log[1] ^ 2) << 12;\n\t}\n\n\tram->fuc.r_gpiotrig = ramfuc_reg(0x00d604);\n\n\tram->fuc.r_0x132020 = ramfuc_reg(0x132020);\n\tram->fuc.r_0x132028 = ramfuc_reg(0x132028);\n\tram->fuc.r_0x132024 = ramfuc_reg(0x132024);\n\tram->fuc.r_0x132030 = ramfuc_reg(0x132030);\n\tram->fuc.r_0x132034 = ramfuc_reg(0x132034);\n\tram->fuc.r_0x132000 = ramfuc_reg(0x132000);\n\tram->fuc.r_0x132004 = ramfuc_reg(0x132004);\n\tram->fuc.r_0x132040 = ramfuc_reg(0x132040);\n\n\tram->fuc.r_0x10f248 = ramfuc_reg(0x10f248);\n\tram->fuc.r_0x10f290 = ramfuc_reg(0x10f290);\n\tram->fuc.r_0x10f294 = ramfuc_reg(0x10f294);\n\tram->fuc.r_0x10f298 = ramfuc_reg(0x10f298);\n\tram->fuc.r_0x10f29c = ramfuc_reg(0x10f29c);\n\tram->fuc.r_0x10f2a0 = ramfuc_reg(0x10f2a0);\n\tram->fuc.r_0x10f2a4 = ramfuc_reg(0x10f2a4);\n\tram->fuc.r_0x10f2a8 = ramfuc_reg(0x10f2a8);\n\tram->fuc.r_0x10f2ac = ramfuc_reg(0x10f2ac);\n\tram->fuc.r_0x10f2cc = ramfuc_reg(0x10f2cc);\n\tram->fuc.r_0x10f2e8 = ramfuc_reg(0x10f2e8);\n\tram->fuc.r_0x10f250 = ramfuc_reg(0x10f250);\n\tram->fuc.r_0x10f24c = ramfuc_reg(0x10f24c);\n\tram->fuc.r_0x10fec4 = ramfuc_reg(0x10fec4);\n\tram->fuc.r_0x10fec8 = ramfuc_reg(0x10fec8);\n\tram->fuc.r_0x10f604 = ramfuc_reg(0x10f604);\n\tram->fuc.r_0x10f614 = ramfuc_reg(0x10f614);\n\tram->fuc.r_0x10f610 = ramfuc_reg(0x10f610);\n\tram->fuc.r_0x100770 = ramfuc_reg(0x100770);\n\tram->fuc.r_0x100778 = ramfuc_reg(0x100778);\n\tram->fuc.r_0x10f224 = ramfuc_reg(0x10f224);\n\n\tram->fuc.r_0x10f870 = ramfuc_reg(0x10f870);\n\tram->fuc.r_0x10f698 = ramfuc_reg(0x10f698);\n\tram->fuc.r_0x10f694 = ramfuc_reg(0x10f694);\n\tram->fuc.r_0x10f6b8 = ramfuc_reg(0x10f6b8);\n\tram->fuc.r_0x10f808 = ramfuc_reg(0x10f808);\n\tram->fuc.r_0x10f670 = ramfuc_reg(0x10f670);\n\tram->fuc.r_0x10f60c = ramfuc_reg(0x10f60c);\n\tram->fuc.r_0x10f830 = ramfuc_reg(0x10f830);\n\tram->fuc.r_0x1373ec = ramfuc_reg(0x1373ec);\n\tram->fuc.r_0x10f800 = ramfuc_reg(0x10f800);\n\tram->fuc.r_0x10f82c = ramfuc_reg(0x10f82c);\n\n\tram->fuc.r_0x10f978 = ramfuc_reg(0x10f978);\n\tram->fuc.r_0x10f910 = ramfuc_reg(0x10f910);\n\tram->fuc.r_0x10f914 = ramfuc_reg(0x10f914);\n\n\tswitch (ram->base.type) {\n\tcase NVKM_RAM_TYPE_GDDR5:\n\t\tram->fuc.r_mr[0] = ramfuc_reg(0x10f300);\n\t\tram->fuc.r_mr[1] = ramfuc_reg(0x10f330);\n\t\tram->fuc.r_mr[2] = ramfuc_reg(0x10f334);\n\t\tram->fuc.r_mr[3] = ramfuc_reg(0x10f338);\n\t\tram->fuc.r_mr[4] = ramfuc_reg(0x10f33c);\n\t\tram->fuc.r_mr[5] = ramfuc_reg(0x10f340);\n\t\tram->fuc.r_mr[6] = ramfuc_reg(0x10f344);\n\t\tram->fuc.r_mr[7] = ramfuc_reg(0x10f348);\n\t\tram->fuc.r_mr[8] = ramfuc_reg(0x10f354);\n\t\tram->fuc.r_mr[15] = ramfuc_reg(0x10f34c);\n\t\tbreak;\n\tcase NVKM_RAM_TYPE_DDR3:\n\t\tram->fuc.r_mr[0] = ramfuc_reg(0x10f300);\n\t\tram->fuc.r_mr[1] = ramfuc_reg(0x10f304);\n\t\tram->fuc.r_mr[2] = ramfuc_reg(0x10f320);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tram->fuc.r_0x62c000 = ramfuc_reg(0x62c000);\n\tram->fuc.r_0x10f200 = ramfuc_reg(0x10f200);\n\tram->fuc.r_0x10f210 = ramfuc_reg(0x10f210);\n\tram->fuc.r_0x10f310 = ramfuc_reg(0x10f310);\n\tram->fuc.r_0x10f314 = ramfuc_reg(0x10f314);\n\tram->fuc.r_0x10f318 = ramfuc_reg(0x10f318);\n\tram->fuc.r_0x10f090 = ramfuc_reg(0x10f090);\n\tram->fuc.r_0x10f69c = ramfuc_reg(0x10f69c);\n\tram->fuc.r_0x10f824 = ramfuc_reg(0x10f824);\n\tram->fuc.r_0x1373f0 = ramfuc_reg(0x1373f0);\n\tram->fuc.r_0x1373f4 = ramfuc_reg(0x1373f4);\n\tram->fuc.r_0x137320 = ramfuc_reg(0x137320);\n\tram->fuc.r_0x10f65c = ramfuc_reg(0x10f65c);\n\tram->fuc.r_0x10f6bc = ramfuc_reg(0x10f6bc);\n\tram->fuc.r_0x100710 = ramfuc_reg(0x100710);\n\tram->fuc.r_0x100750 = ramfuc_reg(0x100750);\n\treturn 0;\n}\n\nstatic const struct nvkm_ram_func\ngk104_ram = {\n\t.upper = 0x0200000000ULL,\n\t.probe_fbp = gf100_ram_probe_fbp,\n\t.probe_fbp_amount = gf108_ram_probe_fbp_amount,\n\t.probe_fbpa_amount = gf100_ram_probe_fbpa_amount,\n\t.dtor = gk104_ram_dtor,\n\t.init = gk104_ram_init,\n\t.calc = gk104_ram_calc,\n\t.prog = gk104_ram_prog,\n\t.tidy = gk104_ram_tidy,\n};\n\nint\ngk104_ram_new(struct nvkm_fb *fb, struct nvkm_ram **pram)\n{\n\treturn gk104_ram_new_(&gk104_ram, fb, pram);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}