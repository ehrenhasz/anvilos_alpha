{
  "module_name": "perf.c",
  "hash_id": "9d588299747e238da3c25a17bb3e72c5c584da72978698ea9072efc0d07c97e9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/bios/perf.c",
  "human_readable_source": " \n#include <subdev/bios.h>\n#include <subdev/bios/bit.h>\n#include <subdev/bios/perf.h>\n#include <subdev/pci.h>\n\nu32\nnvbios_perf_table(struct nvkm_bios *bios, u8 *ver, u8 *hdr,\n\t\t  u8 *cnt, u8 *len, u8 *snr, u8 *ssz)\n{\n\tstruct bit_entry bit_P;\n\tu32 perf = 0;\n\n\tif (!bit_entry(bios, 'P', &bit_P)) {\n\t\tif (bit_P.version <= 2) {\n\t\t\tperf = nvbios_rd32(bios, bit_P.offset + 0);\n\t\t\tif (perf) {\n\t\t\t\t*ver = nvbios_rd08(bios, perf + 0);\n\t\t\t\t*hdr = nvbios_rd08(bios, perf + 1);\n\t\t\t\tif (*ver >= 0x40 && *ver < 0x41) {\n\t\t\t\t\t*cnt = nvbios_rd08(bios, perf + 5);\n\t\t\t\t\t*len = nvbios_rd08(bios, perf + 2);\n\t\t\t\t\t*snr = nvbios_rd08(bios, perf + 4);\n\t\t\t\t\t*ssz = nvbios_rd08(bios, perf + 3);\n\t\t\t\t\treturn perf;\n\t\t\t\t} else\n\t\t\t\tif (*ver >= 0x20 && *ver < 0x40) {\n\t\t\t\t\t*cnt = nvbios_rd08(bios, perf + 2);\n\t\t\t\t\t*len = nvbios_rd08(bios, perf + 3);\n\t\t\t\t\t*snr = nvbios_rd08(bios, perf + 4);\n\t\t\t\t\t*ssz = nvbios_rd08(bios, perf + 5);\n\t\t\t\t\treturn perf;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif (bios->bmp_offset) {\n\t\tif (nvbios_rd08(bios, bios->bmp_offset + 6) >= 0x25) {\n\t\t\tperf = nvbios_rd16(bios, bios->bmp_offset + 0x94);\n\t\t\tif (perf) {\n\t\t\t\t*hdr = nvbios_rd08(bios, perf + 0);\n\t\t\t\t*ver = nvbios_rd08(bios, perf + 1);\n\t\t\t\t*cnt = nvbios_rd08(bios, perf + 2);\n\t\t\t\t*len = nvbios_rd08(bios, perf + 3);\n\t\t\t\t*snr = 0;\n\t\t\t\t*ssz = 0;\n\t\t\t\treturn perf;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nu32\nnvbios_perf_entry(struct nvkm_bios *bios, int idx,\n\t\t  u8 *ver, u8 *hdr, u8 *cnt, u8 *len)\n{\n\tu8  snr, ssz;\n\tu32 perf = nvbios_perf_table(bios, ver, hdr, cnt, len, &snr, &ssz);\n\tif (perf && idx < *cnt) {\n\t\tperf = perf + *hdr + (idx * (*len + (snr * ssz)));\n\t\t*hdr = *len;\n\t\t*cnt = snr;\n\t\t*len = ssz;\n\t\treturn perf;\n\t}\n\treturn 0;\n}\n\nu32\nnvbios_perfEp(struct nvkm_bios *bios, int idx,\n\t      u8 *ver, u8 *hdr, u8 *cnt, u8 *len, struct nvbios_perfE *info)\n{\n\tu32 perf = nvbios_perf_entry(bios, idx, ver, hdr, cnt, len);\n\tmemset(info, 0x00, sizeof(*info));\n\tinfo->pstate = nvbios_rd08(bios, perf + 0x00);\n\tswitch (!!perf * *ver) {\n\tcase 0x12:\n\tcase 0x13:\n\tcase 0x14:\n\t\tinfo->core     = nvbios_rd32(bios, perf + 0x01) * 10;\n\t\tinfo->memory   = nvbios_rd32(bios, perf + 0x05) * 20;\n\t\tinfo->fanspeed = nvbios_rd08(bios, perf + 0x37);\n\t\tif (*hdr > 0x38)\n\t\t\tinfo->voltage = nvbios_rd08(bios, perf + 0x38);\n\t\tbreak;\n\tcase 0x21:\n\tcase 0x23:\n\tcase 0x24:\n\t\tinfo->fanspeed = nvbios_rd08(bios, perf + 0x04);\n\t\tinfo->voltage  = nvbios_rd08(bios, perf + 0x05);\n\t\tinfo->shader   = nvbios_rd16(bios, perf + 0x06) * 1000;\n\t\tinfo->core     = info->shader + (signed char)\n\t\t\t\t nvbios_rd08(bios, perf + 0x08) * 1000;\n\t\tswitch (bios->subdev.device->chipset) {\n\t\tcase 0x49:\n\t\tcase 0x4b:\n\t\t\tinfo->memory = nvbios_rd16(bios, perf + 0x0b) * 1000;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tinfo->memory = nvbios_rd16(bios, perf + 0x0b) * 2000;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 0x25:\n\t\tinfo->fanspeed = nvbios_rd08(bios, perf + 0x04);\n\t\tinfo->voltage  = nvbios_rd08(bios, perf + 0x05);\n\t\tinfo->core     = nvbios_rd16(bios, perf + 0x06) * 1000;\n\t\tinfo->shader   = nvbios_rd16(bios, perf + 0x0a) * 1000;\n\t\tinfo->memory   = nvbios_rd16(bios, perf + 0x0c) * 1000;\n\t\tbreak;\n\tcase 0x30:\n\t\tinfo->script   = nvbios_rd16(bios, perf + 0x02);\n\t\tfallthrough;\n\tcase 0x35:\n\t\tinfo->fanspeed = nvbios_rd08(bios, perf + 0x06);\n\t\tinfo->voltage  = nvbios_rd08(bios, perf + 0x07);\n\t\tinfo->core     = nvbios_rd16(bios, perf + 0x08) * 1000;\n\t\tinfo->shader   = nvbios_rd16(bios, perf + 0x0a) * 1000;\n\t\tinfo->memory   = nvbios_rd16(bios, perf + 0x0c) * 1000;\n\t\tinfo->vdec     = nvbios_rd16(bios, perf + 0x10) * 1000;\n\t\tinfo->disp     = nvbios_rd16(bios, perf + 0x14) * 1000;\n\t\tbreak;\n\tcase 0x40:\n\t\tinfo->voltage  = nvbios_rd08(bios, perf + 0x02);\n\t\tswitch (nvbios_rd08(bios, perf + 0xb) & 0x3) {\n\t\tcase 0:\n\t\t\tinfo->pcie_speed = NVKM_PCIE_SPEED_5_0;\n\t\t\tbreak;\n\t\tcase 3:\n\t\tcase 1:\n\t\t\tinfo->pcie_speed = NVKM_PCIE_SPEED_2_5;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tinfo->pcie_speed = NVKM_PCIE_SPEED_8_0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tinfo->pcie_width = 0xff;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\treturn perf;\n}\n\nu32\nnvbios_perfSe(struct nvkm_bios *bios, u32 perfE, int idx,\n\t      u8 *ver, u8 *hdr, u8 cnt, u8 len)\n{\n\tu32 data = 0x00000000;\n\tif (idx < cnt) {\n\t\tdata = perfE + *hdr + (idx * len);\n\t\t*hdr = len;\n\t}\n\treturn data;\n}\n\nu32\nnvbios_perfSp(struct nvkm_bios *bios, u32 perfE, int idx,\n\t      u8 *ver, u8 *hdr, u8 cnt, u8 len,\n\t      struct nvbios_perfS *info)\n{\n\tu32 data = nvbios_perfSe(bios, perfE, idx, ver, hdr, cnt, len);\n\tmemset(info, 0x00, sizeof(*info));\n\tswitch (!!data * *ver) {\n\tcase 0x40:\n\t\tinfo->v40.freq = (nvbios_rd16(bios, data + 0x00) & 0x3fff) * 1000;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn data;\n}\n\nint\nnvbios_perf_fan_parse(struct nvkm_bios *bios,\n\t\t      struct nvbios_perf_fan *fan)\n{\n\tu8  ver, hdr, cnt, len, snr, ssz;\n\tu32 perf = nvbios_perf_table(bios, &ver, &hdr, &cnt, &len, &snr, &ssz);\n\tif (!perf)\n\t\treturn -ENODEV;\n\n\tif (ver >= 0x20 && ver < 0x40 && hdr > 6)\n\t\tfan->pwm_divisor = nvbios_rd16(bios, perf + 6);\n\telse\n\t\tfan->pwm_divisor = 0;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}