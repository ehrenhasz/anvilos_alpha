{
  "module_name": "fanpwm.c",
  "hash_id": "0938ee2af573ddae51a0baacce44df8b295c6bb4620afa383e10194f90dd05fc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/therm/fanpwm.c",
  "human_readable_source": " \n#include \"priv.h\"\n\n#include <core/option.h>\n#include <subdev/bios.h>\n#include <subdev/bios/fan.h>\n#include <subdev/gpio.h>\n\nstruct nvkm_fanpwm {\n\tstruct nvkm_fan base;\n\tstruct dcb_gpio_func func;\n};\n\nstatic int\nnvkm_fanpwm_get(struct nvkm_therm *therm)\n{\n\tstruct nvkm_fanpwm *fan = (void *)therm->fan;\n\tstruct nvkm_device *device = therm->subdev.device;\n\tstruct nvkm_gpio *gpio = device->gpio;\n\tint card_type = device->card_type;\n\tu32 divs, duty;\n\tint ret;\n\n\tret = therm->func->pwm_get(therm, fan->func.line, &divs, &duty);\n\tif (ret == 0 && divs) {\n\t\tdivs = max(divs, duty);\n\t\tif (card_type <= NV_40 || (fan->func.log[0] & 1))\n\t\t\tduty = divs - duty;\n\t\treturn (duty * 100) / divs;\n\t}\n\n\treturn nvkm_gpio_get(gpio, 0, fan->func.func, fan->func.line) * 100;\n}\n\nstatic int\nnvkm_fanpwm_set(struct nvkm_therm *therm, int percent)\n{\n\tstruct nvkm_fanpwm *fan = (void *)therm->fan;\n\tint card_type = therm->subdev.device->card_type;\n\tu32 divs, duty;\n\tint ret;\n\n\tdivs = fan->base.perf.pwm_divisor;\n\tif (fan->base.bios.pwm_freq) {\n\t\tdivs = 1;\n\t\tif (therm->func->pwm_clock)\n\t\t\tdivs = therm->func->pwm_clock(therm, fan->func.line);\n\t\tdivs /= fan->base.bios.pwm_freq;\n\t}\n\n\tduty = ((divs * percent) + 99) / 100;\n\tif (card_type <= NV_40 || (fan->func.log[0] & 1))\n\t\tduty = divs - duty;\n\n\tret = therm->func->pwm_set(therm, fan->func.line, divs, duty);\n\tif (ret == 0)\n\t\tret = therm->func->pwm_ctrl(therm, fan->func.line, true);\n\treturn ret;\n}\n\nint\nnvkm_fanpwm_create(struct nvkm_therm *therm, struct dcb_gpio_func *func)\n{\n\tstruct nvkm_device *device = therm->subdev.device;\n\tstruct nvkm_bios *bios = device->bios;\n\tstruct nvkm_fanpwm *fan;\n\tstruct nvbios_therm_fan info = {};\n\tu32 divs, duty;\n\n\tnvbios_fan_parse(bios, &info);\n\n\tif (!nvkm_boolopt(device->cfgopt, \"NvFanPWM\", func->param) ||\n\t    !therm->func->pwm_ctrl || info.type == NVBIOS_THERM_FAN_TOGGLE ||\n\t     therm->func->pwm_get(therm, func->line, &divs, &duty) == -ENODEV)\n\t\treturn -ENODEV;\n\n\tfan = kzalloc(sizeof(*fan), GFP_KERNEL);\n\tif (!fan)\n\t\treturn -ENOMEM;\n\n\ttherm->fan = &fan->base;\n\tfan->base.type = \"PWM\";\n\tfan->base.get = nvkm_fanpwm_get;\n\tfan->base.set = nvkm_fanpwm_set;\n\tfan->func = *func;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}