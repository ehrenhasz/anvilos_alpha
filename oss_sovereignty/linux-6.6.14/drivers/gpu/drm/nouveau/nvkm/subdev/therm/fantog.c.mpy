{
  "module_name": "fantog.c",
  "hash_id": "00f1f1d17a452869ffaaf553d9f16beca530255884ce07ab29dda496809db9f1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/therm/fantog.c",
  "human_readable_source": " \n#include \"priv.h\"\n\n#include <subdev/gpio.h>\n#include <subdev/timer.h>\n\nstruct nvkm_fantog {\n\tstruct nvkm_fan base;\n\tstruct nvkm_alarm alarm;\n\tspinlock_t lock;\n\tu32 period_us;\n\tu32 percent;\n\tstruct dcb_gpio_func func;\n};\n\nstatic void\nnvkm_fantog_update(struct nvkm_fantog *fan, int percent)\n{\n\tstruct nvkm_therm *therm = fan->base.parent;\n\tstruct nvkm_device *device = therm->subdev.device;\n\tstruct nvkm_timer *tmr = device->timer;\n\tstruct nvkm_gpio *gpio = device->gpio;\n\tunsigned long flags;\n\tint duty;\n\n\tspin_lock_irqsave(&fan->lock, flags);\n\tif (percent < 0)\n\t\tpercent = fan->percent;\n\tfan->percent = percent;\n\n\tduty = !nvkm_gpio_get(gpio, 0, DCB_GPIO_FAN, 0xff);\n\tnvkm_gpio_set(gpio, 0, DCB_GPIO_FAN, 0xff, duty);\n\n\tif (percent != (duty * 100)) {\n\t\tu64 next_change = (percent * fan->period_us) / 100;\n\t\tif (!duty)\n\t\t\tnext_change = fan->period_us - next_change;\n\t\tnvkm_timer_alarm(tmr, next_change * 1000, &fan->alarm);\n\t}\n\tspin_unlock_irqrestore(&fan->lock, flags);\n}\n\nstatic void\nnvkm_fantog_alarm(struct nvkm_alarm *alarm)\n{\n\tstruct nvkm_fantog *fan =\n\t       container_of(alarm, struct nvkm_fantog, alarm);\n\tnvkm_fantog_update(fan, -1);\n}\n\nstatic int\nnvkm_fantog_get(struct nvkm_therm *therm)\n{\n\tstruct nvkm_fantog *fan = (void *)therm->fan;\n\treturn fan->percent;\n}\n\nstatic int\nnvkm_fantog_set(struct nvkm_therm *therm, int percent)\n{\n\tstruct nvkm_fantog *fan = (void *)therm->fan;\n\tif (therm->func->pwm_ctrl)\n\t\ttherm->func->pwm_ctrl(therm, fan->func.line, false);\n\tnvkm_fantog_update(fan, percent);\n\treturn 0;\n}\n\nint\nnvkm_fantog_create(struct nvkm_therm *therm, struct dcb_gpio_func *func)\n{\n\tstruct nvkm_fantog *fan;\n\tint ret;\n\n\tif (therm->func->pwm_ctrl) {\n\t\tret = therm->func->pwm_ctrl(therm, func->line, false);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tfan = kzalloc(sizeof(*fan), GFP_KERNEL);\n\tif (!fan)\n\t\treturn -ENOMEM;\n\n\ttherm->fan = &fan->base;\n\tfan->base.type = \"toggle\";\n\tfan->base.get = nvkm_fantog_get;\n\tfan->base.set = nvkm_fantog_set;\n\tnvkm_alarm_init(&fan->alarm, nvkm_fantog_alarm);\n\tfan->period_us = 100000;  \n\tfan->percent = 100;\n\tfan->func = *func;\n\tspin_lock_init(&fan->lock);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}