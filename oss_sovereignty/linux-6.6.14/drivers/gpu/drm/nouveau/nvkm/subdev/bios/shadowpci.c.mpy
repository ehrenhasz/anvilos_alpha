{
  "module_name": "shadowpci.c",
  "hash_id": "150b0c665237472708af46aea0c4c87a484c458e0d20ef7aaf103992bd27c962",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/bios/shadowpci.c",
  "human_readable_source": " \n#include \"priv.h\"\n\n#include <core/pci.h>\n\nstruct priv {\n\tstruct pci_dev *pdev;\n\tvoid __iomem *rom;\n\tsize_t size;\n};\n\nstatic u32\npcirom_read(void *data, u32 offset, u32 length, struct nvkm_bios *bios)\n{\n\tstruct priv *priv = data;\n\tif (offset + length <= priv->size) {\n\t\tmemcpy_fromio(bios->data + offset, priv->rom + offset, length);\n\t\treturn length;\n\t}\n\treturn 0;\n}\n\nstatic void\npcirom_fini(void *data)\n{\n\tstruct priv *priv = data;\n\tpci_unmap_rom(priv->pdev, priv->rom);\n\tpci_disable_rom(priv->pdev);\n\tkfree(priv);\n}\n\nstatic void *\npcirom_init(struct nvkm_bios *bios, const char *name)\n{\n\tstruct nvkm_device *device = bios->subdev.device;\n\tstruct priv *priv = NULL;\n\tstruct pci_dev *pdev;\n\tint ret;\n\n\tif (device->func->pci)\n\t\tpdev = device->func->pci(device)->pdev;\n\telse\n\t\treturn ERR_PTR(-ENODEV);\n\n\tif (!(ret = pci_enable_rom(pdev))) {\n\t\tif (ret = -ENOMEM,\n\t\t    (priv = kmalloc(sizeof(*priv), GFP_KERNEL))) {\n\t\t\tif (ret = -EFAULT,\n\t\t\t    (priv->rom = pci_map_rom(pdev, &priv->size))) {\n\t\t\t\tpriv->pdev = pdev;\n\t\t\t\treturn priv;\n\t\t\t}\n\t\t\tkfree(priv);\n\t\t}\n\t\tpci_disable_rom(pdev);\n\t}\n\n\treturn ERR_PTR(ret);\n}\n\nconst struct nvbios_source\nnvbios_pcirom = {\n\t.name = \"PCIROM\",\n\t.init = pcirom_init,\n\t.fini = pcirom_fini,\n\t.read = pcirom_read,\n\t.rw = true,\n};\n\nstatic void *\nplatform_init(struct nvkm_bios *bios, const char *name)\n{\n\tstruct nvkm_device *device = bios->subdev.device;\n\tstruct pci_dev *pdev;\n\tstruct priv *priv;\n\tint ret = -ENOMEM;\n\n\tif (device->func->pci)\n\t\tpdev = device->func->pci(device)->pdev;\n\telse\n\t\treturn ERR_PTR(-ENODEV);\n\n\tif (!pdev->rom || pdev->romlen == 0)\n\t\treturn ERR_PTR(-ENODEV);\n\n\tif ((priv = kmalloc(sizeof(*priv), GFP_KERNEL))) {\n\t\tpriv->size = pdev->romlen;\n\t\tif (ret = -ENODEV,\n\t\t    (priv->rom = ioremap(pdev->rom, pdev->romlen)))\n\t\t\treturn priv;\n\t\tkfree(priv);\n\t}\n\n\treturn ERR_PTR(ret);\n}\n\nstatic void\nplatform_fini(void *data)\n{\n\tstruct priv *priv = data;\n\n\tiounmap(priv->rom);\n\tkfree(priv);\n}\n\nconst struct nvbios_source\nnvbios_platform = {\n\t.name = \"PLATFORM\",\n\t.init = platform_init,\n\t.fini = platform_fini,\n\t.read = pcirom_read,\n\t.rw = true,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}