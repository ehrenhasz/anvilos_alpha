{
  "module_name": "pcie.c",
  "hash_id": "519afdf9b50df15cf74024facc0d07ce07d9fef9cdc73d6316a2d85a57065dd4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/pci/pcie.c",
  "human_readable_source": " \n#include \"priv.h\"\n\nstatic char *nvkm_pcie_speeds[] = {\n\t\"2.5GT/s\",\n\t\"5.0GT/s\",\n\t\"8.0GT/s\",\n};\n\nstatic enum nvkm_pcie_speed\nnvkm_pcie_speed(enum pci_bus_speed speed)\n{\n\tswitch (speed) {\n\tcase PCIE_SPEED_2_5GT:\n\t\treturn NVKM_PCIE_SPEED_2_5;\n\tcase PCIE_SPEED_5_0GT:\n\t\treturn NVKM_PCIE_SPEED_5_0;\n\tcase PCIE_SPEED_8_0GT:\n\t\treturn NVKM_PCIE_SPEED_8_0;\n\tdefault:\n\t\t \n\t\tif (speed == 0x17)\n\t\t\treturn NVKM_PCIE_SPEED_8_0;\n\t\treturn -1;\n\t}\n}\n\nstatic int\nnvkm_pcie_get_version(struct nvkm_pci *pci)\n{\n\tif (!pci->func->pcie.version)\n\t\treturn -ENOSYS;\n\n\treturn pci->func->pcie.version(pci);\n}\n\nstatic int\nnvkm_pcie_get_max_version(struct nvkm_pci *pci)\n{\n\tif (!pci->func->pcie.version_supported)\n\t\treturn -ENOSYS;\n\n\treturn pci->func->pcie.version_supported(pci);\n}\n\nstatic int\nnvkm_pcie_set_version(struct nvkm_pci *pci, int version)\n{\n\tif (!pci->func->pcie.set_version)\n\t\treturn -ENOSYS;\n\n\tnvkm_trace(&pci->subdev, \"set to version %i\\n\", version);\n\tpci->func->pcie.set_version(pci, version);\n\treturn nvkm_pcie_get_version(pci);\n}\n\nint\nnvkm_pcie_oneinit(struct nvkm_pci *pci)\n{\n\tif (pci->func->pcie.max_speed)\n\t\tnvkm_debug(&pci->subdev, \"pcie max speed: %s\\n\",\n\t\t\t   nvkm_pcie_speeds[pci->func->pcie.max_speed(pci)]);\n\treturn 0;\n}\n\nint\nnvkm_pcie_init(struct nvkm_pci *pci)\n{\n\tstruct nvkm_subdev *subdev = &pci->subdev;\n\tint ret;\n\n\t \n\tret = nvkm_pcie_get_version(pci);\n\tif (ret > 0) {\n\t\tint max_version = nvkm_pcie_get_max_version(pci);\n\t\tif (max_version > 0 && max_version > ret)\n\t\t\tret = nvkm_pcie_set_version(pci, max_version);\n\n\t\tif (ret < max_version)\n\t\t\tnvkm_error(subdev, \"couldn't raise version: %i\\n\", ret);\n\t}\n\n\tif (pci->func->pcie.init)\n\t\tpci->func->pcie.init(pci);\n\n\tif (pci->pcie.speed != -1)\n\t\tnvkm_pcie_set_link(pci, pci->pcie.speed, pci->pcie.width);\n\n\treturn 0;\n}\n\nint\nnvkm_pcie_set_link(struct nvkm_pci *pci, enum nvkm_pcie_speed speed, u8 width)\n{\n\tstruct nvkm_subdev *subdev;\n\tenum nvkm_pcie_speed cur_speed, max_speed;\n\tint ret;\n\n\tif (!pci || !pci_is_pcie(pci->pdev))\n\t\treturn 0;\n\n\tif (!pci->func->pcie.set_link)\n\t\treturn -ENOSYS;\n\n\tsubdev = &pci->subdev;\n\tnvkm_trace(subdev, \"requested %s\\n\", nvkm_pcie_speeds[speed]);\n\n\tif (pci->func->pcie.version(pci) < 2) {\n\t\tnvkm_error(subdev, \"setting link failed due to low version\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tcur_speed = pci->func->pcie.cur_speed(pci);\n\tmax_speed = min(nvkm_pcie_speed(pci->pdev->bus->max_bus_speed),\n\t\t\tpci->func->pcie.max_speed(pci));\n\n\tnvkm_trace(subdev, \"current speed: %s\\n\", nvkm_pcie_speeds[cur_speed]);\n\n\tif (speed > max_speed) {\n\t\tnvkm_debug(subdev, \"%s not supported by bus or card, dropping\"\n\t\t\t   \"requested speed to %s\", nvkm_pcie_speeds[speed],\n\t\t\t   nvkm_pcie_speeds[max_speed]);\n\t\tspeed = max_speed;\n\t}\n\n\tpci->pcie.speed = speed;\n\tpci->pcie.width = width;\n\n\tif (speed == cur_speed) {\n\t\tnvkm_debug(subdev, \"requested matches current speed\\n\");\n\t\treturn speed;\n\t}\n\n\tnvkm_debug(subdev, \"set link to %s x%i\\n\",\n\t\t   nvkm_pcie_speeds[speed], width);\n\n\tret = pci->func->pcie.set_link(pci, speed, width);\n\tif (ret < 0)\n\t\tnvkm_error(subdev, \"setting link failed: %i\\n\", ret);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}