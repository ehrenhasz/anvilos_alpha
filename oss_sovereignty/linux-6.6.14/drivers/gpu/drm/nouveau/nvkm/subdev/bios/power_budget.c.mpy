{
  "module_name": "power_budget.c",
  "hash_id": "639a567de499e0fcaab0f369b11a1e76eef7a2ad7d853b34e44a1d39c5d85e23",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/subdev/bios/power_budget.c",
  "human_readable_source": " \n#include <subdev/bios.h>\n#include <subdev/bios/bit.h>\n#include <subdev/bios/power_budget.h>\n\nstatic u32\nnvbios_power_budget_table(struct nvkm_bios *bios, u8 *ver, u8 *hdr, u8 *cnt,\n\t\t\t  u8 *len)\n{\n\tstruct bit_entry bit_P;\n\tu32 power_budget;\n\n\tif (bit_entry(bios, 'P', &bit_P) || bit_P.version != 2 ||\n\t    bit_P.length < 0x30)\n\t\treturn 0;\n\n\tpower_budget = nvbios_rd32(bios, bit_P.offset + 0x2c);\n\tif (!power_budget)\n\t\treturn 0;\n\n\t*ver = nvbios_rd08(bios, power_budget);\n\tswitch (*ver) {\n\tcase 0x20:\n\tcase 0x30:\n\t\t*hdr = nvbios_rd08(bios, power_budget + 0x1);\n\t\t*len = nvbios_rd08(bios, power_budget + 0x2);\n\t\t*cnt = nvbios_rd08(bios, power_budget + 0x3);\n\t\treturn power_budget;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nint\nnvbios_power_budget_header(struct nvkm_bios *bios,\n                           struct nvbios_power_budget *budget)\n{\n\tu8 ver, hdr, cnt, len, cap_entry;\n\tu32 header;\n\n\tif (!bios || !budget)\n\t\treturn -EINVAL;\n\n\theader = nvbios_power_budget_table(bios, &ver, &hdr, &cnt, &len);\n\tif (!header || !cnt)\n\t\treturn -ENODEV;\n\n\tswitch (ver) {\n\tcase 0x20:\n\t\tcap_entry = nvbios_rd08(bios, header + 0x9);\n\t\tbreak;\n\tcase 0x30:\n\t\tcap_entry = nvbios_rd08(bios, header + 0xa);\n\t\tbreak;\n\tdefault:\n\t\tcap_entry = 0xff;\n\t}\n\n\tif (cap_entry >= cnt && cap_entry != 0xff) {\n\t\tnvkm_warn(&bios->subdev,\n\t\t          \"invalid cap_entry in power budget table found\\n\");\n\t\tbudget->cap_entry = 0xff;\n\t\treturn -EINVAL;\n\t}\n\n\tbudget->offset = header;\n\tbudget->ver = ver;\n\tbudget->hlen = hdr;\n\tbudget->elen = len;\n\tbudget->ecount = cnt;\n\n\tbudget->cap_entry = cap_entry;\n\n\treturn 0;\n}\n\nint\nnvbios_power_budget_entry(struct nvkm_bios *bios,\n                          struct nvbios_power_budget *budget,\n                          u8 idx, struct nvbios_power_budget_entry *entry)\n{\n\tu32 entry_offset;\n\n\tif (!bios || !budget || !budget->offset || idx >= budget->ecount\n\t\t|| !entry)\n\t\treturn -EINVAL;\n\n\tentry_offset = budget->offset + budget->hlen + idx * budget->elen;\n\n\tif (budget->ver >= 0x20) {\n\t\tentry->min_w = nvbios_rd32(bios, entry_offset + 0x2);\n\t\tentry->avg_w = nvbios_rd32(bios, entry_offset + 0x6);\n\t\tentry->max_w = nvbios_rd32(bios, entry_offset + 0xa);\n\t} else {\n\t\tentry->min_w = 0;\n\t\tentry->max_w = nvbios_rd32(bios, entry_offset + 0x2);\n\t\tentry->avg_w = entry->max_w;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}