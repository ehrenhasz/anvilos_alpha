{
  "module_name": "nv04.c",
  "hash_id": "643886dfdec1155dca1a78a0f39899c034bcf53e4cc58039d4f3df43f9e54d93",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/engine/gr/nv04.c",
  "human_readable_source": " \n#include \"priv.h\"\n#include \"regs.h\"\n\n#include <core/client.h>\n#include <core/gpuobj.h>\n#include <engine/fifo.h>\n#include <engine/fifo/chan.h>\n#include <subdev/instmem.h>\n#include <subdev/timer.h>\n\nstatic u32\nnv04_gr_ctx_regs[] = {\n\t0x0040053c,\n\t0x00400544,\n\t0x00400540,\n\t0x00400548,\n\tNV04_PGRAPH_CTX_SWITCH1,\n\tNV04_PGRAPH_CTX_SWITCH2,\n\tNV04_PGRAPH_CTX_SWITCH3,\n\tNV04_PGRAPH_CTX_SWITCH4,\n\tNV04_PGRAPH_CTX_CACHE1,\n\tNV04_PGRAPH_CTX_CACHE2,\n\tNV04_PGRAPH_CTX_CACHE3,\n\tNV04_PGRAPH_CTX_CACHE4,\n\t0x00400184,\n\t0x004001a4,\n\t0x004001c4,\n\t0x004001e4,\n\t0x00400188,\n\t0x004001a8,\n\t0x004001c8,\n\t0x004001e8,\n\t0x0040018c,\n\t0x004001ac,\n\t0x004001cc,\n\t0x004001ec,\n\t0x00400190,\n\t0x004001b0,\n\t0x004001d0,\n\t0x004001f0,\n\t0x00400194,\n\t0x004001b4,\n\t0x004001d4,\n\t0x004001f4,\n\t0x00400198,\n\t0x004001b8,\n\t0x004001d8,\n\t0x004001f8,\n\t0x0040019c,\n\t0x004001bc,\n\t0x004001dc,\n\t0x004001fc,\n\t0x00400174,\n\tNV04_PGRAPH_DMA_START_0,\n\tNV04_PGRAPH_DMA_START_1,\n\tNV04_PGRAPH_DMA_LENGTH,\n\tNV04_PGRAPH_DMA_MISC,\n\tNV04_PGRAPH_DMA_PITCH,\n\tNV04_PGRAPH_BOFFSET0,\n\tNV04_PGRAPH_BBASE0,\n\tNV04_PGRAPH_BLIMIT0,\n\tNV04_PGRAPH_BOFFSET1,\n\tNV04_PGRAPH_BBASE1,\n\tNV04_PGRAPH_BLIMIT1,\n\tNV04_PGRAPH_BOFFSET2,\n\tNV04_PGRAPH_BBASE2,\n\tNV04_PGRAPH_BLIMIT2,\n\tNV04_PGRAPH_BOFFSET3,\n\tNV04_PGRAPH_BBASE3,\n\tNV04_PGRAPH_BLIMIT3,\n\tNV04_PGRAPH_BOFFSET4,\n\tNV04_PGRAPH_BBASE4,\n\tNV04_PGRAPH_BLIMIT4,\n\tNV04_PGRAPH_BOFFSET5,\n\tNV04_PGRAPH_BBASE5,\n\tNV04_PGRAPH_BLIMIT5,\n\tNV04_PGRAPH_BPITCH0,\n\tNV04_PGRAPH_BPITCH1,\n\tNV04_PGRAPH_BPITCH2,\n\tNV04_PGRAPH_BPITCH3,\n\tNV04_PGRAPH_BPITCH4,\n\tNV04_PGRAPH_SURFACE,\n\tNV04_PGRAPH_STATE,\n\tNV04_PGRAPH_BSWIZZLE2,\n\tNV04_PGRAPH_BSWIZZLE5,\n\tNV04_PGRAPH_BPIXEL,\n\tNV04_PGRAPH_NOTIFY,\n\tNV04_PGRAPH_PATT_COLOR0,\n\tNV04_PGRAPH_PATT_COLOR1,\n\tNV04_PGRAPH_PATT_COLORRAM+0x00,\n\tNV04_PGRAPH_PATT_COLORRAM+0x04,\n\tNV04_PGRAPH_PATT_COLORRAM+0x08,\n\tNV04_PGRAPH_PATT_COLORRAM+0x0c,\n\tNV04_PGRAPH_PATT_COLORRAM+0x10,\n\tNV04_PGRAPH_PATT_COLORRAM+0x14,\n\tNV04_PGRAPH_PATT_COLORRAM+0x18,\n\tNV04_PGRAPH_PATT_COLORRAM+0x1c,\n\tNV04_PGRAPH_PATT_COLORRAM+0x20,\n\tNV04_PGRAPH_PATT_COLORRAM+0x24,\n\tNV04_PGRAPH_PATT_COLORRAM+0x28,\n\tNV04_PGRAPH_PATT_COLORRAM+0x2c,\n\tNV04_PGRAPH_PATT_COLORRAM+0x30,\n\tNV04_PGRAPH_PATT_COLORRAM+0x34,\n\tNV04_PGRAPH_PATT_COLORRAM+0x38,\n\tNV04_PGRAPH_PATT_COLORRAM+0x3c,\n\tNV04_PGRAPH_PATT_COLORRAM+0x40,\n\tNV04_PGRAPH_PATT_COLORRAM+0x44,\n\tNV04_PGRAPH_PATT_COLORRAM+0x48,\n\tNV04_PGRAPH_PATT_COLORRAM+0x4c,\n\tNV04_PGRAPH_PATT_COLORRAM+0x50,\n\tNV04_PGRAPH_PATT_COLORRAM+0x54,\n\tNV04_PGRAPH_PATT_COLORRAM+0x58,\n\tNV04_PGRAPH_PATT_COLORRAM+0x5c,\n\tNV04_PGRAPH_PATT_COLORRAM+0x60,\n\tNV04_PGRAPH_PATT_COLORRAM+0x64,\n\tNV04_PGRAPH_PATT_COLORRAM+0x68,\n\tNV04_PGRAPH_PATT_COLORRAM+0x6c,\n\tNV04_PGRAPH_PATT_COLORRAM+0x70,\n\tNV04_PGRAPH_PATT_COLORRAM+0x74,\n\tNV04_PGRAPH_PATT_COLORRAM+0x78,\n\tNV04_PGRAPH_PATT_COLORRAM+0x7c,\n\tNV04_PGRAPH_PATT_COLORRAM+0x80,\n\tNV04_PGRAPH_PATT_COLORRAM+0x84,\n\tNV04_PGRAPH_PATT_COLORRAM+0x88,\n\tNV04_PGRAPH_PATT_COLORRAM+0x8c,\n\tNV04_PGRAPH_PATT_COLORRAM+0x90,\n\tNV04_PGRAPH_PATT_COLORRAM+0x94,\n\tNV04_PGRAPH_PATT_COLORRAM+0x98,\n\tNV04_PGRAPH_PATT_COLORRAM+0x9c,\n\tNV04_PGRAPH_PATT_COLORRAM+0xa0,\n\tNV04_PGRAPH_PATT_COLORRAM+0xa4,\n\tNV04_PGRAPH_PATT_COLORRAM+0xa8,\n\tNV04_PGRAPH_PATT_COLORRAM+0xac,\n\tNV04_PGRAPH_PATT_COLORRAM+0xb0,\n\tNV04_PGRAPH_PATT_COLORRAM+0xb4,\n\tNV04_PGRAPH_PATT_COLORRAM+0xb8,\n\tNV04_PGRAPH_PATT_COLORRAM+0xbc,\n\tNV04_PGRAPH_PATT_COLORRAM+0xc0,\n\tNV04_PGRAPH_PATT_COLORRAM+0xc4,\n\tNV04_PGRAPH_PATT_COLORRAM+0xc8,\n\tNV04_PGRAPH_PATT_COLORRAM+0xcc,\n\tNV04_PGRAPH_PATT_COLORRAM+0xd0,\n\tNV04_PGRAPH_PATT_COLORRAM+0xd4,\n\tNV04_PGRAPH_PATT_COLORRAM+0xd8,\n\tNV04_PGRAPH_PATT_COLORRAM+0xdc,\n\tNV04_PGRAPH_PATT_COLORRAM+0xe0,\n\tNV04_PGRAPH_PATT_COLORRAM+0xe4,\n\tNV04_PGRAPH_PATT_COLORRAM+0xe8,\n\tNV04_PGRAPH_PATT_COLORRAM+0xec,\n\tNV04_PGRAPH_PATT_COLORRAM+0xf0,\n\tNV04_PGRAPH_PATT_COLORRAM+0xf4,\n\tNV04_PGRAPH_PATT_COLORRAM+0xf8,\n\tNV04_PGRAPH_PATT_COLORRAM+0xfc,\n\tNV04_PGRAPH_PATTERN,\n\t0x0040080c,\n\tNV04_PGRAPH_PATTERN_SHAPE,\n\t0x00400600,\n\tNV04_PGRAPH_ROP3,\n\tNV04_PGRAPH_CHROMA,\n\tNV04_PGRAPH_BETA_AND,\n\tNV04_PGRAPH_BETA_PREMULT,\n\tNV04_PGRAPH_CONTROL0,\n\tNV04_PGRAPH_CONTROL1,\n\tNV04_PGRAPH_CONTROL2,\n\tNV04_PGRAPH_BLEND,\n\tNV04_PGRAPH_STORED_FMT,\n\tNV04_PGRAPH_SOURCE_COLOR,\n\t0x00400560,\n\t0x00400568,\n\t0x00400564,\n\t0x0040056c,\n\t0x00400400,\n\t0x00400480,\n\t0x00400404,\n\t0x00400484,\n\t0x00400408,\n\t0x00400488,\n\t0x0040040c,\n\t0x0040048c,\n\t0x00400410,\n\t0x00400490,\n\t0x00400414,\n\t0x00400494,\n\t0x00400418,\n\t0x00400498,\n\t0x0040041c,\n\t0x0040049c,\n\t0x00400420,\n\t0x004004a0,\n\t0x00400424,\n\t0x004004a4,\n\t0x00400428,\n\t0x004004a8,\n\t0x0040042c,\n\t0x004004ac,\n\t0x00400430,\n\t0x004004b0,\n\t0x00400434,\n\t0x004004b4,\n\t0x00400438,\n\t0x004004b8,\n\t0x0040043c,\n\t0x004004bc,\n\t0x00400440,\n\t0x004004c0,\n\t0x00400444,\n\t0x004004c4,\n\t0x00400448,\n\t0x004004c8,\n\t0x0040044c,\n\t0x004004cc,\n\t0x00400450,\n\t0x004004d0,\n\t0x00400454,\n\t0x004004d4,\n\t0x00400458,\n\t0x004004d8,\n\t0x0040045c,\n\t0x004004dc,\n\t0x00400460,\n\t0x004004e0,\n\t0x00400464,\n\t0x004004e4,\n\t0x00400468,\n\t0x004004e8,\n\t0x0040046c,\n\t0x004004ec,\n\t0x00400470,\n\t0x004004f0,\n\t0x00400474,\n\t0x004004f4,\n\t0x00400478,\n\t0x004004f8,\n\t0x0040047c,\n\t0x004004fc,\n\t0x00400534,\n\t0x00400538,\n\t0x00400514,\n\t0x00400518,\n\t0x0040051c,\n\t0x00400520,\n\t0x00400524,\n\t0x00400528,\n\t0x0040052c,\n\t0x00400530,\n\t0x00400d00,\n\t0x00400d40,\n\t0x00400d80,\n\t0x00400d04,\n\t0x00400d44,\n\t0x00400d84,\n\t0x00400d08,\n\t0x00400d48,\n\t0x00400d88,\n\t0x00400d0c,\n\t0x00400d4c,\n\t0x00400d8c,\n\t0x00400d10,\n\t0x00400d50,\n\t0x00400d90,\n\t0x00400d14,\n\t0x00400d54,\n\t0x00400d94,\n\t0x00400d18,\n\t0x00400d58,\n\t0x00400d98,\n\t0x00400d1c,\n\t0x00400d5c,\n\t0x00400d9c,\n\t0x00400d20,\n\t0x00400d60,\n\t0x00400da0,\n\t0x00400d24,\n\t0x00400d64,\n\t0x00400da4,\n\t0x00400d28,\n\t0x00400d68,\n\t0x00400da8,\n\t0x00400d2c,\n\t0x00400d6c,\n\t0x00400dac,\n\t0x00400d30,\n\t0x00400d70,\n\t0x00400db0,\n\t0x00400d34,\n\t0x00400d74,\n\t0x00400db4,\n\t0x00400d38,\n\t0x00400d78,\n\t0x00400db8,\n\t0x00400d3c,\n\t0x00400d7c,\n\t0x00400dbc,\n\t0x00400590,\n\t0x00400594,\n\t0x00400598,\n\t0x0040059c,\n\t0x004005a8,\n\t0x004005ac,\n\t0x004005b0,\n\t0x004005b4,\n\t0x004005c0,\n\t0x004005c4,\n\t0x004005c8,\n\t0x004005cc,\n\t0x004005d0,\n\t0x004005d4,\n\t0x004005d8,\n\t0x004005dc,\n\t0x004005e0,\n\tNV04_PGRAPH_PASSTHRU_0,\n\tNV04_PGRAPH_PASSTHRU_1,\n\tNV04_PGRAPH_PASSTHRU_2,\n\tNV04_PGRAPH_DVD_COLORFMT,\n\tNV04_PGRAPH_SCALED_FORMAT,\n\tNV04_PGRAPH_MISC24_0,\n\tNV04_PGRAPH_MISC24_1,\n\tNV04_PGRAPH_MISC24_2,\n\t0x00400500,\n\t0x00400504,\n\tNV04_PGRAPH_VALID1,\n\tNV04_PGRAPH_VALID2,\n\tNV04_PGRAPH_DEBUG_3\n};\n\n#define nv04_gr(p) container_of((p), struct nv04_gr, base)\n\nstruct nv04_gr {\n\tstruct nvkm_gr base;\n\tstruct nv04_gr_chan *chan[16];\n\tspinlock_t lock;\n};\n\n#define nv04_gr_chan(p) container_of((p), struct nv04_gr_chan, object)\n\nstruct nv04_gr_chan {\n\tstruct nvkm_object object;\n\tstruct nv04_gr *gr;\n\tint chid;\n\tu32 nv04[ARRAY_SIZE(nv04_gr_ctx_regs)];\n};\n\n \n\n \n\nstatic void\nnv04_gr_set_ctx1(struct nvkm_device *device, u32 inst, u32 mask, u32 value)\n{\n\tint subc = (nvkm_rd32(device, NV04_PGRAPH_TRAPPED_ADDR) >> 13) & 0x7;\n\tu32 tmp;\n\n\ttmp  = nvkm_rd32(device, 0x700000 + inst);\n\ttmp &= ~mask;\n\ttmp |= value;\n\tnvkm_wr32(device, 0x700000 + inst, tmp);\n\n\tnvkm_wr32(device, NV04_PGRAPH_CTX_SWITCH1, tmp);\n\tnvkm_wr32(device, NV04_PGRAPH_CTX_CACHE1 + (subc << 2), tmp);\n}\n\nstatic void\nnv04_gr_set_ctx_val(struct nvkm_device *device, u32 inst, u32 mask, u32 value)\n{\n\tint class, op, valid = 1;\n\tu32 tmp, ctx1;\n\n\tctx1 = nvkm_rd32(device, 0x700000 + inst);\n\tclass = ctx1 & 0xff;\n\top = (ctx1 >> 15) & 7;\n\n\ttmp = nvkm_rd32(device, 0x70000c + inst);\n\ttmp &= ~mask;\n\ttmp |= value;\n\tnvkm_wr32(device, 0x70000c + inst, tmp);\n\n\t \n\tif (!(tmp & 0x02000000))\n\t\tvalid = 0;\n\t \n\tif ((class == 0x1f || class == 0x48) && !(tmp & 0x04000000))\n\t\tvalid = 0;\n\n\tswitch (op) {\n\t \n\tcase 0:\n\tcase 3:\n\t\tbreak;\n\t \n\tcase 1:\n\t\tif (!(tmp & 0x18000000))\n\t\t\tvalid = 0;\n\t\tbreak;\n\t \n\tcase 2:\n\t\tif (!(tmp & 0x20000000))\n\t\t\tvalid = 0;\n\t\tbreak;\n\t \n\tcase 4:\n\tcase 5:\n\t\tif (!(tmp & 0x40000000))\n\t\t\tvalid = 0;\n\t\tbreak;\n\t}\n\n\tnv04_gr_set_ctx1(device, inst, 0x01000000, valid << 24);\n}\n\nstatic bool\nnv04_gr_mthd_set_operation(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tu8 class = nvkm_rd32(device, 0x700000) & 0x000000ff;\n\tif (data > 5)\n\t\treturn false;\n\t \n\tif (data > 2 && class < 0x40)\n\t\treturn false;\n\tnv04_gr_set_ctx1(device, inst, 0x00038000, data << 15);\n\t \n\tnv04_gr_set_ctx_val(device, inst, 0, 0);\n\treturn true;\n}\n\nstatic bool\nnv04_gr_mthd_surf3d_clip_h(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tu32 min = data & 0xffff, max;\n\tu32 w = data >> 16;\n\tif (min & 0x8000)\n\t\t \n\t\treturn false;\n\tif (w & 0x8000)\n\t\t \n\t\tw |= 0xffff0000;\n\tmax = min + w;\n\tmax &= 0x3ffff;\n\tnvkm_wr32(device, 0x40053c, min);\n\tnvkm_wr32(device, 0x400544, max);\n\treturn true;\n}\n\nstatic bool\nnv04_gr_mthd_surf3d_clip_v(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tu32 min = data & 0xffff, max;\n\tu32 w = data >> 16;\n\tif (min & 0x8000)\n\t\t \n\t\treturn false;\n\tif (w & 0x8000)\n\t\t \n\t\tw |= 0xffff0000;\n\tmax = min + w;\n\tmax &= 0x3ffff;\n\tnvkm_wr32(device, 0x400540, min);\n\tnvkm_wr32(device, 0x400548, max);\n\treturn true;\n}\n\nstatic u8\nnv04_gr_mthd_bind_class(struct nvkm_device *device, u32 inst)\n{\n\treturn nvkm_rd32(device, 0x700000 + (inst << 4));\n}\n\nstatic bool\nnv04_gr_mthd_bind_surf2d(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx1(device, inst, 0x00004000, 0);\n\t\tnv04_gr_set_ctx_val(device, inst, 0x02000000, 0);\n\t\treturn true;\n\tcase 0x42:\n\t\tnv04_gr_set_ctx1(device, inst, 0x00004000, 0);\n\t\tnv04_gr_set_ctx_val(device, inst, 0x02000000, 0x02000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv04_gr_mthd_bind_surf2d_swzsurf(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx1(device, inst, 0x00004000, 0);\n\t\tnv04_gr_set_ctx_val(device, inst, 0x02000000, 0);\n\t\treturn true;\n\tcase 0x42:\n\t\tnv04_gr_set_ctx1(device, inst, 0x00004000, 0);\n\t\tnv04_gr_set_ctx_val(device, inst, 0x02000000, 0x02000000);\n\t\treturn true;\n\tcase 0x52:\n\t\tnv04_gr_set_ctx1(device, inst, 0x00004000, 0x00004000);\n\t\tnv04_gr_set_ctx_val(device, inst, 0x02000000, 0x02000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv01_gr_mthd_bind_patt(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x08000000, 0);\n\t\treturn true;\n\tcase 0x18:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x08000000, 0x08000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv04_gr_mthd_bind_patt(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x08000000, 0);\n\t\treturn true;\n\tcase 0x44:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x08000000, 0x08000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv04_gr_mthd_bind_rop(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x10000000, 0);\n\t\treturn true;\n\tcase 0x43:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x10000000, 0x10000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv04_gr_mthd_bind_beta1(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x20000000, 0);\n\t\treturn true;\n\tcase 0x12:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x20000000, 0x20000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv04_gr_mthd_bind_beta4(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x40000000, 0);\n\t\treturn true;\n\tcase 0x72:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x40000000, 0x40000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv04_gr_mthd_bind_surf_dst(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x02000000, 0);\n\t\treturn true;\n\tcase 0x58:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x02000000, 0x02000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv04_gr_mthd_bind_surf_src(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x04000000, 0);\n\t\treturn true;\n\tcase 0x59:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x04000000, 0x04000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv04_gr_mthd_bind_surf_color(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x02000000, 0);\n\t\treturn true;\n\tcase 0x5a:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x02000000, 0x02000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv04_gr_mthd_bind_surf_zeta(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x04000000, 0);\n\t\treturn true;\n\tcase 0x5b:\n\t\tnv04_gr_set_ctx_val(device, inst, 0x04000000, 0x04000000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv01_gr_mthd_bind_clip(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx1(device, inst, 0x2000, 0);\n\t\treturn true;\n\tcase 0x19:\n\t\tnv04_gr_set_ctx1(device, inst, 0x2000, 0x2000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv01_gr_mthd_bind_chroma(struct nvkm_device *device, u32 inst, u32 data)\n{\n\tswitch (nv04_gr_mthd_bind_class(device, data)) {\n\tcase 0x30:\n\t\tnv04_gr_set_ctx1(device, inst, 0x1000, 0);\n\t\treturn true;\n\t \n\tcase 0x57:\n\t\tnv04_gr_set_ctx1(device, inst, 0x1000, 0x1000);\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nnv03_gr_mthd_gdi(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0184: func = nv01_gr_mthd_bind_patt; break;\n\tcase 0x0188: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_surf_dst; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv04_gr_mthd_gdi(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0188: func = nv04_gr_mthd_bind_patt; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_beta4; break;\n\tcase 0x0198: func = nv04_gr_mthd_bind_surf2d; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv01_gr_mthd_blit(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0184: func = nv01_gr_mthd_bind_chroma; break;\n\tcase 0x0188: func = nv01_gr_mthd_bind_clip; break;\n\tcase 0x018c: func = nv01_gr_mthd_bind_patt; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0198: func = nv04_gr_mthd_bind_surf_dst; break;\n\tcase 0x019c: func = nv04_gr_mthd_bind_surf_src; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv04_gr_mthd_blit(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0184: func = nv01_gr_mthd_bind_chroma; break;\n\tcase 0x0188: func = nv01_gr_mthd_bind_clip; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_patt; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0198: func = nv04_gr_mthd_bind_beta4; break;\n\tcase 0x019c: func = nv04_gr_mthd_bind_surf2d; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv04_gr_mthd_iifc(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0188: func = nv01_gr_mthd_bind_chroma; break;\n\tcase 0x018c: func = nv01_gr_mthd_bind_clip; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_patt; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0198: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x019c: func = nv04_gr_mthd_bind_beta4; break;\n\tcase 0x01a0: func = nv04_gr_mthd_bind_surf2d_swzsurf; break;\n\tcase 0x03e4: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv01_gr_mthd_ifc(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0184: func = nv01_gr_mthd_bind_chroma; break;\n\tcase 0x0188: func = nv01_gr_mthd_bind_clip; break;\n\tcase 0x018c: func = nv01_gr_mthd_bind_patt; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0198: func = nv04_gr_mthd_bind_surf_dst; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv04_gr_mthd_ifc(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0184: func = nv01_gr_mthd_bind_chroma; break;\n\tcase 0x0188: func = nv01_gr_mthd_bind_clip; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_patt; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0198: func = nv04_gr_mthd_bind_beta4; break;\n\tcase 0x019c: func = nv04_gr_mthd_bind_surf2d; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv03_gr_mthd_sifc(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0184: func = nv01_gr_mthd_bind_chroma; break;\n\tcase 0x0188: func = nv01_gr_mthd_bind_patt; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_surf_dst; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv04_gr_mthd_sifc(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0184: func = nv01_gr_mthd_bind_chroma; break;\n\tcase 0x0188: func = nv04_gr_mthd_bind_patt; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_beta4; break;\n\tcase 0x0198: func = nv04_gr_mthd_bind_surf2d; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv03_gr_mthd_sifm(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0188: func = nv01_gr_mthd_bind_patt; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_surf_dst; break;\n\tcase 0x0304: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv04_gr_mthd_sifm(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0188: func = nv04_gr_mthd_bind_patt; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_beta4; break;\n\tcase 0x0198: func = nv04_gr_mthd_bind_surf2d; break;\n\tcase 0x0304: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv04_gr_mthd_surf3d(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x02f8: func = nv04_gr_mthd_surf3d_clip_h; break;\n\tcase 0x02fc: func = nv04_gr_mthd_surf3d_clip_v; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv03_gr_mthd_ttri(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0188: func = nv01_gr_mthd_bind_clip; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_surf_color; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_surf_zeta; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv01_gr_mthd_prim(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0184: func = nv01_gr_mthd_bind_clip; break;\n\tcase 0x0188: func = nv01_gr_mthd_bind_patt; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_surf_dst; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv04_gr_mthd_prim(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32);\n\tswitch (mthd) {\n\tcase 0x0184: func = nv01_gr_mthd_bind_clip; break;\n\tcase 0x0188: func = nv04_gr_mthd_bind_patt; break;\n\tcase 0x018c: func = nv04_gr_mthd_bind_rop; break;\n\tcase 0x0190: func = nv04_gr_mthd_bind_beta1; break;\n\tcase 0x0194: func = nv04_gr_mthd_bind_beta4; break;\n\tcase 0x0198: func = nv04_gr_mthd_bind_surf2d; break;\n\tcase 0x02fc: func = nv04_gr_mthd_set_operation; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, data);\n}\n\nstatic bool\nnv04_gr_mthd(struct nvkm_device *device, u32 inst, u32 mthd, u32 data)\n{\n\tbool (*func)(struct nvkm_device *, u32, u32, u32);\n\tswitch (nvkm_rd32(device, 0x700000 + inst) & 0x000000ff) {\n\tcase 0x1c ... 0x1e:\n\t\t   func = nv01_gr_mthd_prim; break;\n\tcase 0x1f: func = nv01_gr_mthd_blit; break;\n\tcase 0x21: func = nv01_gr_mthd_ifc; break;\n\tcase 0x36: func = nv03_gr_mthd_sifc; break;\n\tcase 0x37: func = nv03_gr_mthd_sifm; break;\n\tcase 0x48: func = nv03_gr_mthd_ttri; break;\n\tcase 0x4a: func = nv04_gr_mthd_gdi; break;\n\tcase 0x4b: func = nv03_gr_mthd_gdi; break;\n\tcase 0x53: func = nv04_gr_mthd_surf3d; break;\n\tcase 0x5c ... 0x5e:\n\t\t   func = nv04_gr_mthd_prim; break;\n\tcase 0x5f: func = nv04_gr_mthd_blit; break;\n\tcase 0x60: func = nv04_gr_mthd_iifc; break;\n\tcase 0x61: func = nv04_gr_mthd_ifc; break;\n\tcase 0x76: func = nv04_gr_mthd_sifc; break;\n\tcase 0x77: func = nv04_gr_mthd_sifm; break;\n\tdefault:\n\t\treturn false;\n\t}\n\treturn func(device, inst, mthd, data);\n}\n\nstatic int\nnv04_gr_object_bind(struct nvkm_object *object, struct nvkm_gpuobj *parent,\n\t\t    int align, struct nvkm_gpuobj **pgpuobj)\n{\n\tint ret = nvkm_gpuobj_new(object->engine->subdev.device, 16, align,\n\t\t\t\t  false, parent, pgpuobj);\n\tif (ret == 0) {\n\t\tnvkm_kmap(*pgpuobj);\n\t\tnvkm_wo32(*pgpuobj, 0x00, object->oclass);\n#ifdef __BIG_ENDIAN\n\t\tnvkm_mo32(*pgpuobj, 0x00, 0x00080000, 0x00080000);\n#endif\n\t\tnvkm_wo32(*pgpuobj, 0x04, 0x00000000);\n\t\tnvkm_wo32(*pgpuobj, 0x08, 0x00000000);\n\t\tnvkm_wo32(*pgpuobj, 0x0c, 0x00000000);\n\t\tnvkm_done(*pgpuobj);\n\t}\n\treturn ret;\n}\n\nconst struct nvkm_object_func\nnv04_gr_object = {\n\t.bind = nv04_gr_object_bind,\n};\n\n \n\nstatic struct nv04_gr_chan *\nnv04_gr_channel(struct nv04_gr *gr)\n{\n\tstruct nvkm_device *device = gr->base.engine.subdev.device;\n\tstruct nv04_gr_chan *chan = NULL;\n\tif (nvkm_rd32(device, NV04_PGRAPH_CTX_CONTROL) & 0x00010000) {\n\t\tint chid = nvkm_rd32(device, NV04_PGRAPH_CTX_USER) >> 24;\n\t\tif (chid < ARRAY_SIZE(gr->chan))\n\t\t\tchan = gr->chan[chid];\n\t}\n\treturn chan;\n}\n\nstatic int\nnv04_gr_load_context(struct nv04_gr_chan *chan, int chid)\n{\n\tstruct nvkm_device *device = chan->gr->base.engine.subdev.device;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(nv04_gr_ctx_regs); i++)\n\t\tnvkm_wr32(device, nv04_gr_ctx_regs[i], chan->nv04[i]);\n\n\tnvkm_wr32(device, NV04_PGRAPH_CTX_CONTROL, 0x10010100);\n\tnvkm_mask(device, NV04_PGRAPH_CTX_USER, 0xff000000, chid << 24);\n\tnvkm_mask(device, NV04_PGRAPH_FFINTFC_ST2, 0xfff00000, 0x00000000);\n\treturn 0;\n}\n\nstatic int\nnv04_gr_unload_context(struct nv04_gr_chan *chan)\n{\n\tstruct nvkm_device *device = chan->gr->base.engine.subdev.device;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(nv04_gr_ctx_regs); i++)\n\t\tchan->nv04[i] = nvkm_rd32(device, nv04_gr_ctx_regs[i]);\n\n\tnvkm_wr32(device, NV04_PGRAPH_CTX_CONTROL, 0x10000000);\n\tnvkm_mask(device, NV04_PGRAPH_CTX_USER, 0xff000000, 0x0f000000);\n\treturn 0;\n}\n\nstatic void\nnv04_gr_context_switch(struct nv04_gr *gr)\n{\n\tstruct nvkm_device *device = gr->base.engine.subdev.device;\n\tstruct nv04_gr_chan *prev = NULL;\n\tstruct nv04_gr_chan *next = NULL;\n\tint chid;\n\n\tnv04_gr_idle(&gr->base);\n\n\t \n\tprev = nv04_gr_channel(gr);\n\tif (prev)\n\t\tnv04_gr_unload_context(prev);\n\n\t \n\tchid = (nvkm_rd32(device, NV04_PGRAPH_TRAPPED_ADDR) >> 24) & 0x0f;\n\tnext = gr->chan[chid];\n\tif (next)\n\t\tnv04_gr_load_context(next, chid);\n}\n\nstatic u32 *ctx_reg(struct nv04_gr_chan *chan, u32 reg)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(nv04_gr_ctx_regs); i++) {\n\t\tif (nv04_gr_ctx_regs[i] == reg)\n\t\t\treturn &chan->nv04[i];\n\t}\n\n\treturn NULL;\n}\n\nstatic void *\nnv04_gr_chan_dtor(struct nvkm_object *object)\n{\n\tstruct nv04_gr_chan *chan = nv04_gr_chan(object);\n\tstruct nv04_gr *gr = chan->gr;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gr->lock, flags);\n\tgr->chan[chan->chid] = NULL;\n\tspin_unlock_irqrestore(&gr->lock, flags);\n\treturn chan;\n}\n\nstatic int\nnv04_gr_chan_fini(struct nvkm_object *object, bool suspend)\n{\n\tstruct nv04_gr_chan *chan = nv04_gr_chan(object);\n\tstruct nv04_gr *gr = chan->gr;\n\tstruct nvkm_device *device = gr->base.engine.subdev.device;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gr->lock, flags);\n\tnvkm_mask(device, NV04_PGRAPH_FIFO, 0x00000001, 0x00000000);\n\tif (nv04_gr_channel(gr) == chan)\n\t\tnv04_gr_unload_context(chan);\n\tnvkm_mask(device, NV04_PGRAPH_FIFO, 0x00000001, 0x00000001);\n\tspin_unlock_irqrestore(&gr->lock, flags);\n\treturn 0;\n}\n\nstatic const struct nvkm_object_func\nnv04_gr_chan = {\n\t.dtor = nv04_gr_chan_dtor,\n\t.fini = nv04_gr_chan_fini,\n};\n\nstatic int\nnv04_gr_chan_new(struct nvkm_gr *base, struct nvkm_chan *fifoch,\n\t\t const struct nvkm_oclass *oclass, struct nvkm_object **pobject)\n{\n\tstruct nv04_gr *gr = nv04_gr(base);\n\tstruct nv04_gr_chan *chan;\n\tunsigned long flags;\n\n\tif (!(chan = kzalloc(sizeof(*chan), GFP_KERNEL)))\n\t\treturn -ENOMEM;\n\tnvkm_object_ctor(&nv04_gr_chan, oclass, &chan->object);\n\tchan->gr = gr;\n\tchan->chid = fifoch->id;\n\t*pobject = &chan->object;\n\n\t*ctx_reg(chan, NV04_PGRAPH_DEBUG_3) = 0xfad4ff31;\n\n\tspin_lock_irqsave(&gr->lock, flags);\n\tgr->chan[chan->chid] = chan;\n\tspin_unlock_irqrestore(&gr->lock, flags);\n\treturn 0;\n}\n\n \n\nbool\nnv04_gr_idle(struct nvkm_gr *gr)\n{\n\tstruct nvkm_subdev *subdev = &gr->engine.subdev;\n\tstruct nvkm_device *device = subdev->device;\n\tu32 mask = 0xffffffff;\n\n\tif (device->card_type == NV_40)\n\t\tmask &= ~NV40_PGRAPH_STATUS_SYNC_STALL;\n\n\tif (nvkm_msec(device, 2000,\n\t\tif (!(nvkm_rd32(device, NV04_PGRAPH_STATUS) & mask))\n\t\t\tbreak;\n\t) < 0) {\n\t\tnvkm_error(subdev, \"idle timed out with status %08x\\n\",\n\t\t\t   nvkm_rd32(device, NV04_PGRAPH_STATUS));\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic const struct nvkm_bitfield\nnv04_gr_intr_name[] = {\n\t{ NV_PGRAPH_INTR_NOTIFY, \"NOTIFY\" },\n\t{}\n};\n\nstatic const struct nvkm_bitfield\nnv04_gr_nstatus[] = {\n\t{ NV04_PGRAPH_NSTATUS_STATE_IN_USE,       \"STATE_IN_USE\" },\n\t{ NV04_PGRAPH_NSTATUS_INVALID_STATE,      \"INVALID_STATE\" },\n\t{ NV04_PGRAPH_NSTATUS_BAD_ARGUMENT,       \"BAD_ARGUMENT\" },\n\t{ NV04_PGRAPH_NSTATUS_PROTECTION_FAULT,   \"PROTECTION_FAULT\" },\n\t{}\n};\n\nconst struct nvkm_bitfield\nnv04_gr_nsource[] = {\n\t{ NV03_PGRAPH_NSOURCE_NOTIFICATION,       \"NOTIFICATION\" },\n\t{ NV03_PGRAPH_NSOURCE_DATA_ERROR,         \"DATA_ERROR\" },\n\t{ NV03_PGRAPH_NSOURCE_PROTECTION_ERROR,   \"PROTECTION_ERROR\" },\n\t{ NV03_PGRAPH_NSOURCE_RANGE_EXCEPTION,    \"RANGE_EXCEPTION\" },\n\t{ NV03_PGRAPH_NSOURCE_LIMIT_COLOR,        \"LIMIT_COLOR\" },\n\t{ NV03_PGRAPH_NSOURCE_LIMIT_ZETA,         \"LIMIT_ZETA\" },\n\t{ NV03_PGRAPH_NSOURCE_ILLEGAL_MTHD,       \"ILLEGAL_MTHD\" },\n\t{ NV03_PGRAPH_NSOURCE_DMA_R_PROTECTION,   \"DMA_R_PROTECTION\" },\n\t{ NV03_PGRAPH_NSOURCE_DMA_W_PROTECTION,   \"DMA_W_PROTECTION\" },\n\t{ NV03_PGRAPH_NSOURCE_FORMAT_EXCEPTION,   \"FORMAT_EXCEPTION\" },\n\t{ NV03_PGRAPH_NSOURCE_PATCH_EXCEPTION,    \"PATCH_EXCEPTION\" },\n\t{ NV03_PGRAPH_NSOURCE_STATE_INVALID,      \"STATE_INVALID\" },\n\t{ NV03_PGRAPH_NSOURCE_DOUBLE_NOTIFY,      \"DOUBLE_NOTIFY\" },\n\t{ NV03_PGRAPH_NSOURCE_NOTIFY_IN_USE,      \"NOTIFY_IN_USE\" },\n\t{ NV03_PGRAPH_NSOURCE_METHOD_CNT,         \"METHOD_CNT\" },\n\t{ NV03_PGRAPH_NSOURCE_BFR_NOTIFICATION,   \"BFR_NOTIFICATION\" },\n\t{ NV03_PGRAPH_NSOURCE_DMA_VTX_PROTECTION, \"DMA_VTX_PROTECTION\" },\n\t{ NV03_PGRAPH_NSOURCE_DMA_WIDTH_A,        \"DMA_WIDTH_A\" },\n\t{ NV03_PGRAPH_NSOURCE_DMA_WIDTH_B,        \"DMA_WIDTH_B\" },\n\t{}\n};\n\nstatic void\nnv04_gr_intr(struct nvkm_gr *base)\n{\n\tstruct nv04_gr *gr = nv04_gr(base);\n\tstruct nvkm_subdev *subdev = &gr->base.engine.subdev;\n\tstruct nvkm_device *device = subdev->device;\n\tu32 stat = nvkm_rd32(device, NV03_PGRAPH_INTR);\n\tu32 nsource = nvkm_rd32(device, NV03_PGRAPH_NSOURCE);\n\tu32 nstatus = nvkm_rd32(device, NV03_PGRAPH_NSTATUS);\n\tu32 addr = nvkm_rd32(device, NV04_PGRAPH_TRAPPED_ADDR);\n\tu32 chid = (addr & 0x0f000000) >> 24;\n\tu32 subc = (addr & 0x0000e000) >> 13;\n\tu32 mthd = (addr & 0x00001ffc);\n\tu32 data = nvkm_rd32(device, NV04_PGRAPH_TRAPPED_DATA);\n\tu32 class = nvkm_rd32(device, 0x400180 + subc * 4) & 0xff;\n\tu32 inst = (nvkm_rd32(device, 0x40016c) & 0xffff) << 4;\n\tu32 show = stat;\n\tchar msg[128], src[128], sta[128];\n\tstruct nv04_gr_chan *chan;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gr->lock, flags);\n\tchan = gr->chan[chid];\n\n\tif (stat & NV_PGRAPH_INTR_NOTIFY) {\n\t\tif (chan && (nsource & NV03_PGRAPH_NSOURCE_ILLEGAL_MTHD)) {\n\t\t\tif (!nv04_gr_mthd(device, inst, mthd, data))\n\t\t\t\tshow &= ~NV_PGRAPH_INTR_NOTIFY;\n\t\t}\n\t}\n\n\tif (stat & NV_PGRAPH_INTR_CONTEXT_SWITCH) {\n\t\tnvkm_wr32(device, NV03_PGRAPH_INTR, NV_PGRAPH_INTR_CONTEXT_SWITCH);\n\t\tstat &= ~NV_PGRAPH_INTR_CONTEXT_SWITCH;\n\t\tshow &= ~NV_PGRAPH_INTR_CONTEXT_SWITCH;\n\t\tnv04_gr_context_switch(gr);\n\t}\n\n\tnvkm_wr32(device, NV03_PGRAPH_INTR, stat);\n\tnvkm_wr32(device, NV04_PGRAPH_FIFO, 0x00000001);\n\n\tif (show) {\n\t\tnvkm_snprintbf(msg, sizeof(msg), nv04_gr_intr_name, show);\n\t\tnvkm_snprintbf(src, sizeof(src), nv04_gr_nsource, nsource);\n\t\tnvkm_snprintbf(sta, sizeof(sta), nv04_gr_nstatus, nstatus);\n\t\tnvkm_error(subdev, \"intr %08x [%s] nsource %08x [%s] \"\n\t\t\t\t   \"nstatus %08x [%s] ch %d [%s] subc %d \"\n\t\t\t\t   \"class %04x mthd %04x data %08x\\n\",\n\t\t\t   show, msg, nsource, src, nstatus, sta, chid,\n\t\t\t   chan ? chan->object.client->name : \"unknown\",\n\t\t\t   subc, class, mthd, data);\n\t}\n\n\tspin_unlock_irqrestore(&gr->lock, flags);\n}\n\nstatic int\nnv04_gr_init(struct nvkm_gr *base)\n{\n\tstruct nv04_gr *gr = nv04_gr(base);\n\tstruct nvkm_device *device = gr->base.engine.subdev.device;\n\n\t \n\tnvkm_wr32(device, NV03_PGRAPH_INTR, 0xFFFFFFFF);\n\tnvkm_wr32(device, NV03_PGRAPH_INTR_EN, 0xFFFFFFFF);\n\n\tnvkm_wr32(device, NV04_PGRAPH_VALID1, 0);\n\tnvkm_wr32(device, NV04_PGRAPH_VALID2, 0);\n\t \n\tnvkm_wr32(device, NV04_PGRAPH_DEBUG_0, 0x1231c000);\n\t \n\t \n\tnvkm_wr32(device, NV04_PGRAPH_DEBUG_1, 0x72111100);\n\t \n\t \n\tnvkm_wr32(device, NV04_PGRAPH_DEBUG_2, 0x11d5f071);\n\t \n\n\t \n\tnvkm_wr32(device, NV04_PGRAPH_DEBUG_3, 0xf0d4ff31);\n\t \n\n\tnvkm_wr32(device, NV04_PGRAPH_STATE        , 0xFFFFFFFF);\n\tnvkm_wr32(device, NV04_PGRAPH_CTX_CONTROL  , 0x10000100);\n\tnvkm_mask(device, NV04_PGRAPH_CTX_USER, 0xff000000, 0x0f000000);\n\n\t \n\tnvkm_wr32(device, NV04_PGRAPH_PATTERN_SHAPE, 0x00000000);\n\tnvkm_wr32(device, NV04_PGRAPH_BETA_AND     , 0xFFFFFFFF);\n\treturn 0;\n}\n\nstatic const struct nvkm_gr_func\nnv04_gr = {\n\t.init = nv04_gr_init,\n\t.intr = nv04_gr_intr,\n\t.chan_new = nv04_gr_chan_new,\n\t.sclass = {\n\t\t{ -1, -1, 0x0012, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0017, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0018, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0019, &nv04_gr_object },  \n\t\t{ -1, -1, 0x001c, &nv04_gr_object },  \n\t\t{ -1, -1, 0x001d, &nv04_gr_object },  \n\t\t{ -1, -1, 0x001e, &nv04_gr_object },  \n\t\t{ -1, -1, 0x001f, &nv04_gr_object },\n\t\t{ -1, -1, 0x0021, &nv04_gr_object },\n\t\t{ -1, -1, 0x0030, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0036, &nv04_gr_object },\n\t\t{ -1, -1, 0x0037, &nv04_gr_object },\n\t\t{ -1, -1, 0x0038, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0039, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0042, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0043, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0044, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0048, &nv04_gr_object },\n\t\t{ -1, -1, 0x004a, &nv04_gr_object },\n\t\t{ -1, -1, 0x004b, &nv04_gr_object },\n\t\t{ -1, -1, 0x0052, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0053, &nv04_gr_object },\n\t\t{ -1, -1, 0x0054, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0055, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0057, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0058, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0059, &nv04_gr_object },  \n\t\t{ -1, -1, 0x005a, &nv04_gr_object },  \n\t\t{ -1, -1, 0x005b, &nv04_gr_object },  \n\t\t{ -1, -1, 0x005c, &nv04_gr_object },  \n\t\t{ -1, -1, 0x005d, &nv04_gr_object },  \n\t\t{ -1, -1, 0x005e, &nv04_gr_object },  \n\t\t{ -1, -1, 0x005f, &nv04_gr_object },\n\t\t{ -1, -1, 0x0060, &nv04_gr_object },\n\t\t{ -1, -1, 0x0061, &nv04_gr_object },\n\t\t{ -1, -1, 0x0064, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0065, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0066, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0072, &nv04_gr_object },  \n\t\t{ -1, -1, 0x0076, &nv04_gr_object },\n\t\t{ -1, -1, 0x0077, &nv04_gr_object },\n\t\t{}\n\t}\n};\n\nint\nnv04_gr_new(struct nvkm_device *device, enum nvkm_subdev_type type, int inst, struct nvkm_gr **pgr)\n{\n\tstruct nv04_gr *gr;\n\n\tif (!(gr = kzalloc(sizeof(*gr), GFP_KERNEL)))\n\t\treturn -ENOMEM;\n\tspin_lock_init(&gr->lock);\n\t*pgr = &gr->base;\n\n\treturn nvkm_gr_ctor(&nv04_gr, device, type, inst, true, &gr->base);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}