{
  "module_name": "ctxgf117.c",
  "hash_id": "d2258bf9fc97a39da51c0c08146a179c016813d6f597157771c4d3842f9aa4bd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf117.c",
  "human_readable_source": " \n#include \"ctxgf100.h\"\n\n#include <subdev/fb.h>\n#include <subdev/mc.h>\n\n \n\nstatic const struct gf100_gr_init\ngf117_grctx_init_ds_0[] = {\n\t{ 0x405800,   1, 0x04, 0x0f8000bf },\n\t{ 0x405830,   1, 0x04, 0x02180324 },\n\t{ 0x405834,   1, 0x04, 0x08000000 },\n\t{ 0x405838,   1, 0x04, 0x00000000 },\n\t{ 0x405854,   1, 0x04, 0x00000000 },\n\t{ 0x405870,   4, 0x04, 0x00000001 },\n\t{ 0x405a00,   2, 0x04, 0x00000000 },\n\t{ 0x405a18,   1, 0x04, 0x00000000 },\n\t{}\n};\n\nstatic const struct gf100_gr_init\ngf117_grctx_init_pd_0[] = {\n\t{ 0x406020,   1, 0x04, 0x000103c1 },\n\t{ 0x406028,   4, 0x04, 0x00000001 },\n\t{ 0x4064a8,   1, 0x04, 0x00000000 },\n\t{ 0x4064ac,   1, 0x04, 0x00003fff },\n\t{ 0x4064b4,   3, 0x04, 0x00000000 },\n\t{ 0x4064c0,   1, 0x04, 0x801a0078 },\n\t{ 0x4064c4,   1, 0x04, 0x00c9ffff },\n\t{ 0x4064d0,   8, 0x04, 0x00000000 },\n\t{}\n};\n\nstatic const struct gf100_gr_pack\ngf117_grctx_pack_hub[] = {\n\t{ gf100_grctx_init_main_0 },\n\t{ gf119_grctx_init_fe_0 },\n\t{ gf100_grctx_init_pri_0 },\n\t{ gf100_grctx_init_memfmt_0 },\n\t{ gf117_grctx_init_ds_0 },\n\t{ gf117_grctx_init_pd_0 },\n\t{ gf100_grctx_init_rstr2d_0 },\n\t{ gf100_grctx_init_scc_0 },\n\t{ gf119_grctx_init_be_0 },\n\t{}\n};\n\nstatic const struct gf100_gr_init\ngf117_grctx_init_setup_0[] = {\n\t{ 0x418800,   1, 0x04, 0x7006860a },\n\t{ 0x418808,   3, 0x04, 0x00000000 },\n\t{ 0x418828,   1, 0x04, 0x00008442 },\n\t{ 0x418830,   1, 0x04, 0x10000001 },\n\t{ 0x4188d8,   1, 0x04, 0x00000008 },\n\t{ 0x4188e0,   1, 0x04, 0x01000000 },\n\t{ 0x4188e8,   5, 0x04, 0x00000000 },\n\t{ 0x4188fc,   1, 0x04, 0x20100018 },\n\t{}\n};\n\nstatic const struct gf100_gr_pack\ngf117_grctx_pack_gpc_0[] = {\n\t{ gf100_grctx_init_gpc_unk_0 },\n\t{ gf119_grctx_init_prop_0 },\n\t{ gf119_grctx_init_gpc_unk_1 },\n\t{ gf117_grctx_init_setup_0 },\n\t{ gf100_grctx_init_zcull_0 },\n\t{}\n};\n\nconst struct gf100_gr_pack\ngf117_grctx_pack_gpc_1[] = {\n\t{ gf119_grctx_init_crstr_0 },\n\t{ gf108_grctx_init_gpm_0 },\n\t{ gf100_grctx_init_gcc_0 },\n\t{}\n};\n\nconst struct gf100_gr_init\ngf117_grctx_init_pe_0[] = {\n\t{ 0x419848,   1, 0x04, 0x00000000 },\n\t{ 0x419864,   1, 0x04, 0x00000129 },\n\t{ 0x419888,   1, 0x04, 0x00000000 },\n\t{}\n};\n\nstatic const struct gf100_gr_init\ngf117_grctx_init_tex_0[] = {\n\t{ 0x419a00,   1, 0x04, 0x000001f0 },\n\t{ 0x419a04,   1, 0x04, 0x00000001 },\n\t{ 0x419a08,   1, 0x04, 0x00000023 },\n\t{ 0x419a0c,   1, 0x04, 0x00020000 },\n\t{ 0x419a10,   1, 0x04, 0x00000000 },\n\t{ 0x419a14,   1, 0x04, 0x00000200 },\n\t{ 0x419a1c,   1, 0x04, 0x00008000 },\n\t{ 0x419a20,   1, 0x04, 0x00000800 },\n\t{ 0x419ac4,   1, 0x04, 0x0017f440 },\n\t{}\n};\n\nstatic const struct gf100_gr_init\ngf117_grctx_init_mpc_0[] = {\n\t{ 0x419c00,   1, 0x04, 0x0000000a },\n\t{ 0x419c04,   1, 0x04, 0x00000006 },\n\t{ 0x419c08,   1, 0x04, 0x00000002 },\n\t{ 0x419c20,   1, 0x04, 0x00000000 },\n\t{ 0x419c24,   1, 0x04, 0x00084210 },\n\t{ 0x419c28,   1, 0x04, 0x3efbefbe },\n\t{}\n};\n\nstatic const struct gf100_gr_pack\ngf117_grctx_pack_tpc[] = {\n\t{ gf117_grctx_init_pe_0 },\n\t{ gf117_grctx_init_tex_0 },\n\t{ gf117_grctx_init_mpc_0 },\n\t{ gf104_grctx_init_l1c_0 },\n\t{ gf119_grctx_init_sm_0 },\n\t{}\n};\n\nstatic const struct gf100_gr_init\ngf117_grctx_init_pes_0[] = {\n\t{ 0x41be24,   1, 0x04, 0x00000002 },\n\t{}\n};\n\nstatic const struct gf100_gr_init\ngf117_grctx_init_cbm_0[] = {\n\t{ 0x41bec0,   1, 0x04, 0x12180000 },\n\t{ 0x41bec4,   1, 0x04, 0x00003fff },\n\t{ 0x41bee4,   1, 0x04, 0x03240218 },\n\t{}\n};\n\nconst struct gf100_gr_init\ngf117_grctx_init_wwdx_0[] = {\n\t{ 0x41bf00,   1, 0x04, 0x0a418820 },\n\t{ 0x41bf04,   1, 0x04, 0x062080e6 },\n\t{ 0x41bf08,   1, 0x04, 0x020398a4 },\n\t{ 0x41bf0c,   1, 0x04, 0x0e629062 },\n\t{ 0x41bf10,   1, 0x04, 0x0a418820 },\n\t{ 0x41bf14,   1, 0x04, 0x000000e6 },\n\t{ 0x41bfd0,   1, 0x04, 0x00900103 },\n\t{ 0x41bfe0,   1, 0x04, 0x00400001 },\n\t{ 0x41bfe4,   1, 0x04, 0x00000000 },\n\t{}\n};\n\nstatic const struct gf100_gr_pack\ngf117_grctx_pack_ppc[] = {\n\t{ gf117_grctx_init_pes_0 },\n\t{ gf117_grctx_init_cbm_0 },\n\t{ gf117_grctx_init_wwdx_0 },\n\t{}\n};\n\n \n\nvoid\ngf117_grctx_generate_dist_skip_table(struct gf100_gr *gr)\n{\n\tstruct nvkm_device *device = gr->base.engine.subdev.device;\n\tint i;\n\n\tfor (i = 0; i < 8; i++)\n\t\tnvkm_wr32(device, 0x4064d0 + (i * 0x04), 0x00000000);\n}\n\nvoid\ngf117_grctx_generate_rop_mapping(struct gf100_gr *gr)\n{\n\tstruct nvkm_device *device = gr->base.engine.subdev.device;\n\tu32 data[6] = {}, data2[2] = {};\n\tu8  shift, ntpcv;\n\tint i;\n\n\t \n\tfor (i = 0; i < 32; i++)\n\t\tdata[i / 6] |= (gr->tile[i] & 0x07) << ((i % 6) * 5);\n\n\t \n\tshift = 0;\n\tntpcv = gr->tpc_total;\n\twhile (!(ntpcv & (1 << 4))) {\n\t\tntpcv <<= 1;\n\t\tshift++;\n\t}\n\n\tdata2[0]  = (ntpcv << 16);\n\tdata2[0] |= (shift << 21);\n\tdata2[0] |= (((1 << (0 + 5)) % ntpcv) << 24);\n\tfor (i = 1; i < 7; i++)\n\t\tdata2[1] |= ((1 << (i + 5)) % ntpcv) << ((i - 1) * 5);\n\n\t \n\tnvkm_wr32(device, 0x418bb8, (gr->tpc_total << 8) |\n\t\t\t\t     gr->screen_tile_row_offset);\n\tfor (i = 0; i < 6; i++)\n\t\tnvkm_wr32(device, 0x418b08 + (i * 4), data[i]);\n\n\t \n\tnvkm_wr32(device, 0x41bfd0, (gr->tpc_total << 8) |\n\t\t\t\t     gr->screen_tile_row_offset | data2[0]);\n\tnvkm_wr32(device, 0x41bfe4, data2[1]);\n\tfor (i = 0; i < 6; i++)\n\t\tnvkm_wr32(device, 0x41bf00 + (i * 4), data[i]);\n\n\t \n\tnvkm_wr32(device, 0x4078bc, (gr->tpc_total << 8) |\n\t\t\t\t     gr->screen_tile_row_offset);\n\tfor (i = 0; i < 6; i++)\n\t\tnvkm_wr32(device, 0x40780c + (i * 4), data[i]);\n}\n\nvoid\ngf117_grctx_generate_attrib(struct gf100_gr_chan *chan)\n{\n\tstruct gf100_gr *gr = chan->gr;\n\tconst struct gf100_grctx_func *grctx = gr->func->grctx;\n\tconst u32  alpha = grctx->alpha_nr;\n\tconst u32   beta = grctx->attrib_nr;\n\tconst int timeslice_mode = 1;\n\tconst int max_batches = 0xffff;\n\tu32 bo = 0;\n\tu32 ao = bo + grctx->attrib_nr_max * gr->tpc_total;\n\tint gpc, ppc;\n\n\tgf100_grctx_patch_wr32(chan, 0x405830, (beta << 16) | alpha);\n\tgf100_grctx_patch_wr32(chan, 0x4064c4, ((alpha / 4) << 16) | max_batches);\n\n\tfor (gpc = 0; gpc < gr->gpc_nr; gpc++) {\n\t\tfor (ppc = 0; ppc < gr->func->ppc_nr; ppc++) {\n\t\t\tconst u32 a = alpha * gr->ppc_tpc_nr[gpc][ppc];\n\t\t\tconst u32 b =  beta * gr->ppc_tpc_nr[gpc][ppc];\n\t\t\tconst u32 t = timeslice_mode;\n\t\t\tconst u32 o = PPC_UNIT(gpc, ppc, 0);\n\n\t\t\tif (!(gr->ppc_mask[gpc] & (1 << ppc)))\n\t\t\t\tcontinue;\n\n\t\t\tgf100_grctx_patch_wr32(chan, o + 0xc0, (t << 28) | (b << 16) | bo);\n\t\t\tbo += grctx->attrib_nr_max * gr->ppc_tpc_nr[gpc][ppc];\n\t\t\tgf100_grctx_patch_wr32(chan, o + 0xe4, (a << 16) | ao);\n\t\t\tao += grctx->alpha_nr_max * gr->ppc_tpc_nr[gpc][ppc];\n\t\t}\n\t}\n}\n\nconst struct gf100_grctx_func\ngf117_grctx = {\n\t.main  = gf100_grctx_generate_main,\n\t.unkn  = gk104_grctx_generate_unkn,\n\t.hub   = gf117_grctx_pack_hub,\n\t.gpc_0 = gf117_grctx_pack_gpc_0,\n\t.gpc_1 = gf117_grctx_pack_gpc_1,\n\t.zcull = gf100_grctx_pack_zcull,\n\t.tpc   = gf117_grctx_pack_tpc,\n\t.ppc   = gf117_grctx_pack_ppc,\n\t.icmd  = gf119_grctx_pack_icmd,\n\t.mthd  = gf119_grctx_pack_mthd,\n\t.bundle = gf100_grctx_generate_bundle,\n\t.bundle_size = 0x1800,\n\t.pagepool = gf100_grctx_generate_pagepool,\n\t.pagepool_size = 0x8000,\n\t.attrib_cb_size = gf100_grctx_generate_attrib_cb_size,\n\t.attrib_cb = gf100_grctx_generate_attrib_cb,\n\t.attrib = gf117_grctx_generate_attrib,\n\t.attrib_nr_max = 0x324,\n\t.attrib_nr = 0x218,\n\t.alpha_nr_max = 0x7ff,\n\t.alpha_nr = 0x324,\n\t.sm_id = gf100_grctx_generate_sm_id,\n\t.tpc_nr = gf100_grctx_generate_tpc_nr,\n\t.r4060a8 = gf100_grctx_generate_r4060a8,\n\t.rop_mapping = gf117_grctx_generate_rop_mapping,\n\t.alpha_beta_tables = gf100_grctx_generate_alpha_beta_tables,\n\t.max_ways_evict = gf100_grctx_generate_max_ways_evict,\n\t.dist_skip_table = gf117_grctx_generate_dist_skip_table,\n\t.r419cb8 = gf100_grctx_generate_r419cb8,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}