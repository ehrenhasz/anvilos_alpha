{
  "module_name": "chid.c",
  "hash_id": "87f6281aa6a1de730ed09cdebc0cc2b32202c5a859b6bed206baa5edd3daa5aa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/nvkm/engine/fifo/chid.c",
  "human_readable_source": " \n#include \"chid.h\"\n\nvoid\nnvkm_chid_put(struct nvkm_chid *chid, int id, spinlock_t *data_lock)\n{\n\tif (id >= 0) {\n\t\tspin_lock_irq(&chid->lock);\n\t\tspin_lock(data_lock);\n\t\tchid->data[id] = NULL;\n\t\tspin_unlock(data_lock);\n\t\tclear_bit(id, chid->used);\n\t\tspin_unlock_irq(&chid->lock);\n\t}\n}\n\nint\nnvkm_chid_get(struct nvkm_chid *chid, void *data)\n{\n\tint id = -1, cid;\n\n\tspin_lock_irq(&chid->lock);\n\tcid = find_first_zero_bit(chid->used, chid->nr);\n\tif (cid < chid->nr) {\n\t\tset_bit(cid, chid->used);\n\t\tchid->data[cid] = data;\n\t\tid = cid;\n\t}\n\tspin_unlock_irq(&chid->lock);\n\treturn id;\n}\n\nstatic void\nnvkm_chid_del(struct kref *kref)\n{\n\tstruct nvkm_chid *chid = container_of(kref, typeof(*chid), kref);\n\n\tnvkm_event_fini(&chid->event);\n\n\tkvfree(chid->data);\n\tkfree(chid);\n}\n\nvoid\nnvkm_chid_unref(struct nvkm_chid **pchid)\n{\n\tstruct nvkm_chid *chid = *pchid;\n\n\tif (!chid)\n\t\treturn;\n\n\tkref_put(&chid->kref, nvkm_chid_del);\n\t*pchid = NULL;\n}\n\nstruct nvkm_chid *\nnvkm_chid_ref(struct nvkm_chid *chid)\n{\n\tif (chid)\n\t\tkref_get(&chid->kref);\n\n\treturn chid;\n}\n\nint\nnvkm_chid_new(const struct nvkm_event_func *func, struct nvkm_subdev *subdev,\n\t      int nr, int first, int count, struct nvkm_chid **pchid)\n{\n\tstruct nvkm_chid *chid;\n\tint id;\n\n\tif (!(chid = *pchid = kzalloc(struct_size(chid, used, nr), GFP_KERNEL)))\n\t\treturn -ENOMEM;\n\n\tkref_init(&chid->kref);\n\tchid->nr = nr;\n\tchid->mask = chid->nr - 1;\n\tspin_lock_init(&chid->lock);\n\n\tif (!(chid->data = kvzalloc(sizeof(*chid->data) * nr, GFP_KERNEL))) {\n\t\tnvkm_chid_unref(pchid);\n\t\treturn -ENOMEM;\n\t}\n\n\tfor (id = 0; id < first; id++)\n\t\t__set_bit(id, chid->used);\n\tfor (id = first + count; id < nr; id++)\n\t\t__set_bit(id, chid->used);\n\n\treturn nvkm_event_init(func, subdev, 1, nr, &chid->event);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}