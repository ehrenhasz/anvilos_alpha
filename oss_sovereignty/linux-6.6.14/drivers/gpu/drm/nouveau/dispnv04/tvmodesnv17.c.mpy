{
  "module_name": "tvmodesnv17.c",
  "hash_id": "7fa11d80a761dfbcf145982792a3ad6c7aeabc872516ea6b4060ccb2fb746d05",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/nouveau/dispnv04/tvmodesnv17.c",
  "human_readable_source": " \n\n#include \"nouveau_drv.h\"\n#include \"nouveau_encoder.h\"\n#include \"nouveau_crtc.h\"\n#include \"hw.h\"\n#include \"tvnv17.h\"\n\nconst char * const nv17_tv_norm_names[NUM_TV_NORMS] = {\n\t[TV_NORM_PAL] = \"PAL\",\n\t[TV_NORM_PAL_M] = \"PAL-M\",\n\t[TV_NORM_PAL_N] = \"PAL-N\",\n\t[TV_NORM_PAL_NC] = \"PAL-Nc\",\n\t[TV_NORM_NTSC_M] = \"NTSC-M\",\n\t[TV_NORM_NTSC_J] = \"NTSC-J\",\n\t[TV_NORM_HD480I] = \"hd480i\",\n\t[TV_NORM_HD480P] = \"hd480p\",\n\t[TV_NORM_HD576I] = \"hd576i\",\n\t[TV_NORM_HD576P] = \"hd576p\",\n\t[TV_NORM_HD720P] = \"hd720p\",\n\t[TV_NORM_HD1080I] = \"hd1080i\"\n};\n\n \n\nstruct nv17_tv_norm_params nv17_tv_norms[NUM_TV_NORMS] = {\n\t[TV_NORM_PAL] = { TV_ENC_MODE, {\n\t\t\t.tv_enc_mode = { 720, 576, 50000, {\n\t\t\t\t\t0x2a, 0x9, 0x8a, 0xcb, 0x0, 0x0, 0xb, 0x18,\n\t\t\t\t\t0x7e, 0x40, 0x8a, 0x35, 0x27, 0x0, 0x34, 0x3,\n\t\t\t\t\t0x3e, 0x3, 0x17, 0x21, 0x1b, 0x1b, 0x24, 0x9c,\n\t\t\t\t\t0x1, 0x0, 0xf, 0xf, 0x60, 0x5, 0xd3, 0x3,\n\t\t\t\t\t0xd3, 0x4, 0xd4, 0x1, 0x2, 0x0, 0xa, 0x5,\n\t\t\t\t\t0x0, 0x1a, 0xff, 0x3, 0x18, 0xf, 0x78, 0x0,\n\t\t\t\t\t0x0, 0xb4, 0x0, 0x15, 0x49, 0x10, 0x0, 0x9b,\n\t\t\t\t\t0xbd, 0x15, 0x5, 0x15, 0x3e, 0x3, 0x0, 0x0\n\t\t\t\t} } } },\n\n\t[TV_NORM_PAL_M] = { TV_ENC_MODE, {\n\t\t\t.tv_enc_mode = { 720, 480, 59940, {\n\t\t\t\t\t0x21, 0xe6, 0xef, 0xe3, 0x0, 0x0, 0xb, 0x18,\n\t\t\t\t\t0x7e, 0x44, 0x76, 0x32, 0x25, 0x0, 0x3c, 0x0,\n\t\t\t\t\t0x3c, 0x0, 0x17, 0x21, 0x1b, 0x1b, 0x24, 0x83,\n\t\t\t\t\t0x1, 0x0, 0xf, 0xf, 0x60, 0x5, 0xd3, 0x1,\n\t\t\t\t\t0xc5, 0x4, 0xc5, 0x1, 0x2, 0x0, 0xa, 0x5,\n\t\t\t\t\t0x0, 0x18, 0xff, 0x3, 0x20, 0xf, 0x78, 0x0,\n\t\t\t\t\t0x0, 0xb4, 0x0, 0x15, 0x40, 0x10, 0x0, 0x9c,\n\t\t\t\t\t0xc8, 0x15, 0x5, 0x15, 0x3c, 0x0, 0x0, 0x0\n\t\t\t\t} } } },\n\n\t[TV_NORM_PAL_N] = { TV_ENC_MODE, {\n\t\t\t.tv_enc_mode = { 720, 576, 50000, {\n\t\t\t\t\t0x2a, 0x9, 0x8a, 0xcb, 0x0, 0x0, 0xb, 0x18,\n\t\t\t\t\t0x7e, 0x40, 0x8a, 0x32, 0x25, 0x0, 0x3c, 0x0,\n\t\t\t\t\t0x3c, 0x0, 0x17, 0x21, 0x1b, 0x1b, 0x24, 0x9c,\n\t\t\t\t\t0x1, 0x0, 0xf, 0xf, 0x60, 0x5, 0xd3, 0x1,\n\t\t\t\t\t0xc5, 0x4, 0xc5, 0x1, 0x2, 0x0, 0xa, 0x5,\n\t\t\t\t\t0x0, 0x1a, 0xff, 0x3, 0x18, 0xf, 0x78, 0x0,\n\t\t\t\t\t0x0, 0xb4, 0x0, 0x15, 0x49, 0x10, 0x0, 0x9b,\n\t\t\t\t\t0xbd, 0x15, 0x5, 0x15, 0x3c, 0x0, 0x0, 0x0\n\t\t\t\t} } } },\n\n\t[TV_NORM_PAL_NC] = { TV_ENC_MODE, {\n\t\t\t.tv_enc_mode = { 720, 576, 50000, {\n\t\t\t\t\t0x21, 0xf6, 0x94, 0x46, 0x0, 0x0, 0xb, 0x18,\n\t\t\t\t\t0x7e, 0x44, 0x8a, 0x35, 0x27, 0x0, 0x34, 0x3,\n\t\t\t\t\t0x3e, 0x3, 0x17, 0x21, 0x1b, 0x1b, 0x24, 0x9c,\n\t\t\t\t\t0x1, 0x0, 0xf, 0xf, 0x60, 0x5, 0xd3, 0x3,\n\t\t\t\t\t0xd3, 0x4, 0xd4, 0x1, 0x2, 0x0, 0xa, 0x5,\n\t\t\t\t\t0x0, 0x1a, 0xff, 0x3, 0x18, 0xf, 0x78, 0x0,\n\t\t\t\t\t0x0, 0xb4, 0x0, 0x15, 0x49, 0x10, 0x0, 0x9b,\n\t\t\t\t\t0xbd, 0x15, 0x5, 0x15, 0x3e, 0x3, 0x0, 0x0\n\t\t\t\t} } } },\n\n\t[TV_NORM_NTSC_M] = { TV_ENC_MODE, {\n\t\t\t.tv_enc_mode = { 720, 480, 59940, {\n\t\t\t\t\t0x21, 0xf0, 0x7c, 0x1f, 0x0, 0x0, 0xb, 0x18,\n\t\t\t\t\t0x7e, 0x44, 0x76, 0x48, 0x0, 0x0, 0x3c, 0x0,\n\t\t\t\t\t0x3c, 0x0, 0x17, 0x21, 0x1b, 0x1b, 0x24, 0x83,\n\t\t\t\t\t0x1, 0x0, 0xf, 0xf, 0x60, 0x5, 0xd3, 0x1,\n\t\t\t\t\t0xc5, 0x4, 0xc5, 0x1, 0x2, 0x0, 0xa, 0x5,\n\t\t\t\t\t0x0, 0x16, 0xff, 0x3, 0x20, 0xf, 0x78, 0x0,\n\t\t\t\t\t0x0, 0xb4, 0x0, 0x15, 0x4, 0x10, 0x0, 0x9c,\n\t\t\t\t\t0xc8, 0x15, 0x5, 0x15, 0x3c, 0x0, 0x0, 0x0\n\t\t\t\t} } } },\n\n\t[TV_NORM_NTSC_J] = { TV_ENC_MODE, {\n\t\t\t.tv_enc_mode = { 720, 480, 59940, {\n\t\t\t\t\t0x21, 0xf0, 0x7c, 0x1f, 0x0, 0x0, 0xb, 0x18,\n\t\t\t\t\t0x7e, 0x44, 0x76, 0x48, 0x0, 0x0, 0x32, 0x0,\n\t\t\t\t\t0x3c, 0x0, 0x17, 0x21, 0x1b, 0x1b, 0x24, 0x83,\n\t\t\t\t\t0x1, 0x0, 0xf, 0xf, 0x60, 0x5, 0xd3, 0x1,\n\t\t\t\t\t0xcf, 0x4, 0xcf, 0x1, 0x2, 0x0, 0xa, 0x5,\n\t\t\t\t\t0x0, 0x16, 0xff, 0x3, 0x20, 0xf, 0x78, 0x0,\n\t\t\t\t\t0x0, 0xb4, 0x0, 0x15, 0x4, 0x10, 0x0, 0xa4,\n\t\t\t\t\t0xc8, 0x15, 0x5, 0x15, 0x3c, 0x0, 0x0, 0x0\n\t\t\t\t} } } },\n\n\t[TV_NORM_HD480I] = { TV_ENC_MODE, {\n\t\t\t.tv_enc_mode = { 720, 480, 59940, {\n\t\t\t\t\t0x21, 0xf0, 0x7c, 0x1f, 0x0, 0x0, 0xb, 0x18,\n\t\t\t\t\t0x7e, 0x44, 0x76, 0x48, 0x0, 0x0, 0x32, 0x0,\n\t\t\t\t\t0x3c, 0x0, 0x17, 0x21, 0x1b, 0x1b, 0x24, 0x83,\n\t\t\t\t\t0x1, 0x0, 0xf, 0xf, 0x60, 0x5, 0xd3, 0x1,\n\t\t\t\t\t0xcf, 0x4, 0xcf, 0x1, 0x2, 0x0, 0xa, 0x5,\n\t\t\t\t\t0x0, 0x16, 0xff, 0x3, 0x20, 0xf, 0x78, 0x0,\n\t\t\t\t\t0x0, 0xb4, 0x0, 0x15, 0x4, 0x10, 0x0, 0xa4,\n\t\t\t\t\t0xc8, 0x15, 0x5, 0x15, 0x3c, 0x0, 0x0, 0x0\n\t\t\t\t} } } },\n\n\t[TV_NORM_HD576I] = { TV_ENC_MODE, {\n\t\t\t.tv_enc_mode = { 720, 576, 50000, {\n\t\t\t\t\t0x2a, 0x9, 0x8a, 0xcb, 0x0, 0x0, 0xb, 0x18,\n\t\t\t\t\t0x7e, 0x40, 0x8a, 0x35, 0x27, 0x0, 0x34, 0x3,\n\t\t\t\t\t0x3e, 0x3, 0x17, 0x21, 0x1b, 0x1b, 0x24, 0x9c,\n\t\t\t\t\t0x1, 0x0, 0xf, 0xf, 0x60, 0x5, 0xd3, 0x3,\n\t\t\t\t\t0xd3, 0x4, 0xd4, 0x1, 0x2, 0x0, 0xa, 0x5,\n\t\t\t\t\t0x0, 0x1a, 0xff, 0x3, 0x18, 0xf, 0x78, 0x0,\n\t\t\t\t\t0x0, 0xb4, 0x0, 0x15, 0x49, 0x10, 0x0, 0x9b,\n\t\t\t\t\t0xbd, 0x15, 0x5, 0x15, 0x3e, 0x3, 0x0, 0x0\n\t\t\t\t} } } },\n\n\n\t[TV_NORM_HD480P] = { CTV_ENC_MODE, {\n\t\t\t.ctv_enc_mode = {\n\t\t\t\t.mode = { DRM_MODE(\"720x480\", DRM_MODE_TYPE_DRIVER, 27000,\n\t\t\t\t\t\t   720, 735, 743, 858, 0, 480, 490, 494, 525, 0,\n\t\t\t\t\t\t   DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_PVSYNC) },\n\t\t\t\t.ctv_regs = { 0x3540000, 0x0, 0x0, 0x314,\n\t\t\t\t\t      0x354003a, 0x40000, 0x6f0344, 0x18100000,\n\t\t\t\t\t      0x10160004, 0x10060005, 0x1006000c, 0x10060020,\n\t\t\t\t\t      0x10060021, 0x140e0022, 0x10060202, 0x1802020a,\n\t\t\t\t\t      0x1810020b, 0x10000fff, 0x10000fff, 0x10000fff,\n\t\t\t\t\t      0x10000fff, 0x10000fff, 0x10000fff, 0x70,\n\t\t\t\t\t      0x3ff0000, 0x57, 0x2e001e, 0x258012c,\n\t\t\t\t\t      0xa0aa04ec, 0x30, 0x80960019, 0x12c0300,\n\t\t\t\t\t      0x2019, 0x600, 0x32060019, 0x0, 0x0, 0x400\n\t\t\t\t} } } },\n\n\t[TV_NORM_HD576P] = { CTV_ENC_MODE, {\n\t\t\t.ctv_enc_mode = {\n\t\t\t\t.mode = { DRM_MODE(\"720x576\", DRM_MODE_TYPE_DRIVER, 27000,\n\t\t\t\t\t\t   720, 730, 738, 864, 0, 576, 581, 585, 625, 0,\n\t\t\t\t\t\t   DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_PVSYNC) },\n\t\t\t\t.ctv_regs = { 0x3540000, 0x0, 0x0, 0x314,\n\t\t\t\t\t      0x354003a, 0x40000, 0x6f0344, 0x18100000,\n\t\t\t\t\t      0x10060001, 0x10060009, 0x10060026, 0x10060027,\n\t\t\t\t\t      0x140e0028, 0x10060268, 0x1810026d, 0x10000fff,\n\t\t\t\t\t      0x10000fff, 0x10000fff, 0x10000fff, 0x10000fff,\n\t\t\t\t\t      0x10000fff, 0x10000fff, 0x10000fff, 0x69,\n\t\t\t\t\t      0x3ff0000, 0x57, 0x2e001e, 0x258012c,\n\t\t\t\t\t      0xa0aa04ec, 0x30, 0x80960019, 0x12c0300,\n\t\t\t\t\t      0x2019, 0x600, 0x32060019, 0x0, 0x0, 0x400\n\t\t\t\t} } } },\n\n\t[TV_NORM_HD720P] = { CTV_ENC_MODE, {\n\t\t\t.ctv_enc_mode = {\n\t\t\t\t.mode = { DRM_MODE(\"1280x720\", DRM_MODE_TYPE_DRIVER, 74250,\n\t\t\t\t\t\t   1280, 1349, 1357, 1650, 0, 720, 725, 730, 750, 0,\n\t\t\t\t\t\t   DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_PVSYNC) },\n\t\t\t\t.ctv_regs = { 0x1260394, 0x0, 0x0, 0x622,\n\t\t\t\t\t      0x66b0021, 0x6004a, 0x1210626, 0x8170000,\n\t\t\t\t\t      0x70004, 0x70016, 0x70017, 0x40f0018,\n\t\t\t\t\t      0x702e8, 0x81702ed, 0xfff, 0xfff,\n\t\t\t\t\t      0xfff, 0xfff, 0xfff, 0xfff,\n\t\t\t\t\t      0xfff, 0xfff, 0xfff, 0x0,\n\t\t\t\t\t      0x2e40001, 0x58, 0x2e001e, 0x258012c,\n\t\t\t\t\t      0xa0aa04ec, 0x30, 0x810c0039, 0x12c0300,\n\t\t\t\t\t      0xc0002039, 0x600, 0x32060039, 0x0, 0x0, 0x0\n\t\t\t\t} } } },\n\n\t[TV_NORM_HD1080I] = { CTV_ENC_MODE, {\n\t\t\t.ctv_enc_mode = {\n\t\t\t\t.mode = { DRM_MODE(\"1920x1080\", DRM_MODE_TYPE_DRIVER, 74250,\n\t\t\t\t\t\t   1920, 1961, 2049, 2200, 0, 1080, 1084, 1088, 1125, 0,\n\t\t\t\t\t\t   DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_PVSYNC\n\t\t\t\t\t\t   | DRM_MODE_FLAG_INTERLACE) },\n\t\t\t\t.ctv_regs = { 0xac0420, 0x44c0478, 0x4a4, 0x4fc0868,\n\t\t\t\t\t      0x8940028, 0x60054, 0xe80870, 0xbf70000,\n\t\t\t\t\t      0xbc70004, 0x70005, 0x70012, 0x70013,\n\t\t\t\t\t      0x40f0014, 0x70230, 0xbf70232, 0xbf70233,\n\t\t\t\t\t      0x1c70237, 0x70238, 0x70244, 0x70245,\n\t\t\t\t\t      0x40f0246, 0x70462, 0x1f70464, 0x0,\n\t\t\t\t\t      0x2e40001, 0x58, 0x2e001e, 0x258012c,\n\t\t\t\t\t      0xa0aa04ec, 0x30, 0x815f004c, 0x12c0300,\n\t\t\t\t\t      0xc000204c, 0x600, 0x3206004c, 0x0, 0x0, 0x0\n\t\t\t\t} } } }\n};\n\n \n\n#define calc_overscan(o) interpolate(0x100, 0xe1, 0xc1, o)\n\n#define id1 (1LL << 8)\n#define id2 (1LL << 16)\n#define id3 (1LL << 24)\n#define id4 (1LL << 32)\n#define id5 (1LL << 48)\n\nstatic struct filter_params{\n\tint64_t k1;\n\tint64_t ki;\n\tint64_t ki2;\n\tint64_t ki3;\n\tint64_t kr;\n\tint64_t kir;\n\tint64_t ki2r;\n\tint64_t ki3r;\n\tint64_t kf;\n\tint64_t kif;\n\tint64_t ki2f;\n\tint64_t ki3f;\n\tint64_t krf;\n\tint64_t kirf;\n\tint64_t ki2rf;\n\tint64_t ki3rf;\n} fparams[2][4] = {\n\t \n\t{\n\t\t{64.311690 * id5, -39.516924 * id5, 6.586143 * id5, 0.000002 * id5,\n\t\t 0.051285 * id4, 26.168746 * id4, -4.361449 * id4, -0.000001 * id4,\n\t\t 9.308169 * id3, 78.180965 * id3, -13.030158 * id3, -0.000001 * id3,\n\t\t -8.801540 * id1, -46.572890 * id1, 7.762145 * id1, -0.000000 * id1},\n\t\t{-44.565569 * id5, -68.081246 * id5, 39.812074 * id5, -4.009316 * id5,\n\t\t 29.832207 * id4, 50.047322 * id4, -25.380017 * id4, 2.546422 * id4,\n\t\t 104.605622 * id3, 141.908641 * id3, -74.322319 * id3, 7.484316 * id3,\n\t\t -37.081621 * id1, -90.397510 * id1, 42.784229 * id1, -4.289952 * id1},\n\t\t{-56.793244 * id5, 31.153584 * id5, -5.192247 * id5, -0.000003 * id5,\n\t\t 33.541131 * id4, -34.149302 * id4, 5.691537 * id4, 0.000002 * id4,\n\t\t 87.196610 * id3, -88.995169 * id3, 14.832456 * id3, 0.000012 * id3,\n\t\t 17.288138 * id1, 71.864786 * id1, -11.977408 * id1, -0.000009 * id1},\n\t\t{51.787796 * id5, 21.211771 * id5, -18.993730 * id5, 1.853310 * id5,\n\t\t -41.470726 * id4, -17.775823 * id4, 13.057821 * id4, -1.15823 * id4,\n\t\t -154.235673 * id3, -44.878641 * id3, 40.656077 * id3, -3.695595 * id3,\n\t\t 112.201065 * id1, 39.992155 * id1, -25.155714 * id1, 2.113984 * id1},\n\t},\n\n\t \n\t{\n\t\t{67.601979 * id5, 0.428319 * id5, -0.071318 * id5, -0.000012 * id5,\n\t\t -3.402339 * id4, 0.000209 * id4, -0.000092 * id4, 0.000010 * id4,\n\t\t -9.180996 * id3, 6.111270 * id3, -1.024457 * id3, 0.001043 * id3,\n\t\t 6.060315 * id1, -0.017425 * id1, 0.007830 * id1, -0.000869 * id1},\n\t\t{6.755647 * id5, 5.841348 * id5, 1.469734 * id5, -0.149656 * id5,\n\t\t 8.293120 * id4, -1.192888 * id4, -0.947652 * id4, 0.094507 * id4,\n\t\t 37.526655 * id3, 10.257875 * id3, -10.823275 * id3, 1.081497 * id3,\n\t\t -2.361928 * id1, -2.059432 * id1, 1.840671 * id1, -0.168100 * id1},\n\t\t{-14.780391 * id5, -16.042148 * id5, 2.673692 * id5, -0.000000 * id5,\n\t\t 39.541978 * id4, 5.680053 * id4, -0.946676 * id4, 0.000000 * id4,\n\t\t 152.994486 * id3, 12.625439 * id3, -2.119579 * id3, 0.002708 * id3,\n\t\t -38.125089 * id1, -0.855880 * id1, 0.155359 * id1, -0.002245 * id1},\n\t\t{-27.476193 * id5, -1.454976 * id5, 1.286557 * id5, 0.025346 * id5,\n\t\t 20.687300 * id4, 3.014003 * id4, -0.557786 * id4, -0.01311 * id4,\n\t\t 60.008737 * id3, -0.738273 * id3, 5.408217 * id3, -0.796798 * id3,\n\t\t -17.296835 * id1, 4.438577 * id1, -2.809420 * id1, 0.385491 * id1},\n\t}\n};\n\nstatic void tv_setup_filter(struct drm_encoder *encoder)\n{\n\tstruct nv17_tv_encoder *tv_enc = to_tv_enc(encoder);\n\tstruct nv17_tv_norm_params *tv_norm = get_tv_norm(encoder);\n\tstruct drm_display_mode *mode = &encoder->crtc->mode;\n\tuint32_t (*filters[])[4][7] = {&tv_enc->state.hfilter,\n\t\t\t\t       &tv_enc->state.vfilter};\n\tint i, j, k;\n\tint32_t overscan = calc_overscan(tv_enc->overscan);\n\tint64_t flicker = (tv_enc->flicker - 50) * (id3 / 100);\n\tuint64_t rs[] = {mode->hdisplay * id3,\n\t\t\t mode->vdisplay * id3};\n\n\tdo_div(rs[0], overscan * tv_norm->tv_enc_mode.hdisplay);\n\tdo_div(rs[1], overscan * tv_norm->tv_enc_mode.vdisplay);\n\n\tfor (k = 0; k < 2; k++) {\n\t\trs[k] = max((int64_t)rs[k], id2);\n\n\t\tfor (j = 0; j < 4; j++) {\n\t\t\tstruct filter_params *p = &fparams[k][j];\n\n\t\t\tfor (i = 0; i < 7; i++) {\n\t\t\t\tint64_t c = (p->k1 + p->ki*i + p->ki2*i*i +\n\t\t\t\t\t     p->ki3*i*i*i)\n\t\t\t\t\t+ (p->kr + p->kir*i + p->ki2r*i*i +\n\t\t\t\t\t   p->ki3r*i*i*i) * rs[k]\n\t\t\t\t\t+ (p->kf + p->kif*i + p->ki2f*i*i +\n\t\t\t\t\t   p->ki3f*i*i*i) * flicker\n\t\t\t\t\t+ (p->krf + p->kirf*i + p->ki2rf*i*i +\n\t\t\t\t\t   p->ki3rf*i*i*i) * flicker * rs[k];\n\n\t\t\t\t(*filters[k])[j][i] = (c + id5/2) >> 39\n\t\t\t\t\t& (0x1 << 31 | 0x7f << 9);\n\t\t\t}\n\t\t}\n\t}\n}\n\n \n\nstatic void tv_save_filter(struct drm_device *dev, uint32_t base,\n\t\t\t   uint32_t regs[4][7])\n{\n\tint i, j;\n\tuint32_t offsets[] = { base, base + 0x1c, base + 0x40, base + 0x5c };\n\n\tfor (i = 0; i < 4; i++) {\n\t\tfor (j = 0; j < 7; j++)\n\t\t\tregs[i][j] = nv_read_ptv(dev, offsets[i]+4*j);\n\t}\n}\n\nstatic void tv_load_filter(struct drm_device *dev, uint32_t base,\n\t\t\t   uint32_t regs[4][7])\n{\n\tint i, j;\n\tuint32_t offsets[] = { base, base + 0x1c, base + 0x40, base + 0x5c };\n\n\tfor (i = 0; i < 4; i++) {\n\t\tfor (j = 0; j < 7; j++)\n\t\t\tnv_write_ptv(dev, offsets[i]+4*j, regs[i][j]);\n\t}\n}\n\nvoid nv17_tv_state_save(struct drm_device *dev, struct nv17_tv_state *state)\n{\n\tint i;\n\n\tfor (i = 0; i < 0x40; i++)\n\t\tstate->tv_enc[i] = nv_read_tv_enc(dev, i);\n\n\ttv_save_filter(dev, NV_PTV_HFILTER, state->hfilter);\n\ttv_save_filter(dev, NV_PTV_HFILTER2, state->hfilter2);\n\ttv_save_filter(dev, NV_PTV_VFILTER, state->vfilter);\n\n\tnv_save_ptv(dev, state, 200);\n\tnv_save_ptv(dev, state, 204);\n\tnv_save_ptv(dev, state, 208);\n\tnv_save_ptv(dev, state, 20c);\n\tnv_save_ptv(dev, state, 304);\n\tnv_save_ptv(dev, state, 500);\n\tnv_save_ptv(dev, state, 504);\n\tnv_save_ptv(dev, state, 508);\n\tnv_save_ptv(dev, state, 600);\n\tnv_save_ptv(dev, state, 604);\n\tnv_save_ptv(dev, state, 608);\n\tnv_save_ptv(dev, state, 60c);\n\tnv_save_ptv(dev, state, 610);\n\tnv_save_ptv(dev, state, 614);\n}\n\nvoid nv17_tv_state_load(struct drm_device *dev, struct nv17_tv_state *state)\n{\n\tint i;\n\n\tfor (i = 0; i < 0x40; i++)\n\t\tnv_write_tv_enc(dev, i, state->tv_enc[i]);\n\n\ttv_load_filter(dev, NV_PTV_HFILTER, state->hfilter);\n\ttv_load_filter(dev, NV_PTV_HFILTER2, state->hfilter2);\n\ttv_load_filter(dev, NV_PTV_VFILTER, state->vfilter);\n\n\tnv_load_ptv(dev, state, 200);\n\tnv_load_ptv(dev, state, 204);\n\tnv_load_ptv(dev, state, 208);\n\tnv_load_ptv(dev, state, 20c);\n\tnv_load_ptv(dev, state, 304);\n\tnv_load_ptv(dev, state, 500);\n\tnv_load_ptv(dev, state, 504);\n\tnv_load_ptv(dev, state, 508);\n\tnv_load_ptv(dev, state, 600);\n\tnv_load_ptv(dev, state, 604);\n\tnv_load_ptv(dev, state, 608);\n\tnv_load_ptv(dev, state, 60c);\n\tnv_load_ptv(dev, state, 610);\n\tnv_load_ptv(dev, state, 614);\n\n\t \n\tnv_write_tv_enc(dev, 0x3e, 1);\n\tnv_write_tv_enc(dev, 0x3e, 0);\n}\n\n \n\nconst struct drm_display_mode nv17_tv_modes[] = {\n\t{ DRM_MODE(\"320x200\", DRM_MODE_TYPE_DRIVER, 0,\n\t\t   320, 344, 392, 560, 0, 200, 200, 202, 220, 0,\n\t\t   DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC\n\t\t   | DRM_MODE_FLAG_DBLSCAN | DRM_MODE_FLAG_CLKDIV2) },\n\t{ DRM_MODE(\"320x240\", DRM_MODE_TYPE_DRIVER, 0,\n\t\t   320, 344, 392, 560, 0, 240, 240, 246, 263, 0,\n\t\t   DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC\n\t\t   | DRM_MODE_FLAG_DBLSCAN | DRM_MODE_FLAG_CLKDIV2) },\n\t{ DRM_MODE(\"400x300\", DRM_MODE_TYPE_DRIVER, 0,\n\t\t   400, 432, 496, 640, 0, 300, 300, 303, 314, 0,\n\t\t   DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_PVSYNC\n\t\t   | DRM_MODE_FLAG_DBLSCAN | DRM_MODE_FLAG_CLKDIV2) },\n\t{ DRM_MODE(\"640x480\", DRM_MODE_TYPE_DRIVER, 0,\n\t\t   640, 672, 768, 880, 0, 480, 480, 492, 525, 0,\n\t\t   DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC) },\n\t{ DRM_MODE(\"720x480\", DRM_MODE_TYPE_DRIVER, 0,\n\t\t   720, 752, 872, 960, 0, 480, 480, 493, 525, 0,\n\t\t   DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC) },\n\t{ DRM_MODE(\"720x576\", DRM_MODE_TYPE_DRIVER, 0,\n\t\t   720, 776, 856, 960, 0, 576, 576, 588, 597, 0,\n\t\t   DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC) },\n\t{ DRM_MODE(\"800x600\", DRM_MODE_TYPE_DRIVER, 0,\n\t\t   800, 840, 920, 1040, 0, 600, 600, 604, 618, 0,\n\t\t   DRM_MODE_FLAG_PHSYNC | DRM_MODE_FLAG_PVSYNC) },\n\t{ DRM_MODE(\"1024x768\", DRM_MODE_TYPE_DRIVER, 0,\n\t\t   1024, 1064, 1200, 1344, 0, 768, 768, 777, 806, 0,\n\t\t   DRM_MODE_FLAG_NHSYNC | DRM_MODE_FLAG_NVSYNC) },\n\t{}\n};\n\nvoid nv17_tv_update_properties(struct drm_encoder *encoder)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct nv17_tv_encoder *tv_enc = to_tv_enc(encoder);\n\tstruct nv17_tv_state *regs = &tv_enc->state;\n\tstruct nv17_tv_norm_params *tv_norm = get_tv_norm(encoder);\n\tint subconnector = tv_enc->select_subconnector ?\n\t\t\t\t\t\ttv_enc->select_subconnector :\n\t\t\t\t\t\ttv_enc->subconnector;\n\n\tswitch (subconnector) {\n\tcase DRM_MODE_SUBCONNECTOR_Composite:\n\t{\n\t\tregs->ptv_204 = 0x2;\n\n\t\t \n\t\tif (tv_enc->pin_mask & 0x4)\n\t\t\tregs->ptv_204 |= 0x010000;\n\t\telse if (tv_enc->pin_mask & 0x2)\n\t\t\tregs->ptv_204 |= 0x100000;\n\t\telse\n\t\t\tregs->ptv_204 |= 0x110000;\n\n\t\tregs->tv_enc[0x7] = 0x10;\n\t\tbreak;\n\t}\n\tcase DRM_MODE_SUBCONNECTOR_SVIDEO:\n\t\tregs->ptv_204 = 0x11012;\n\t\tregs->tv_enc[0x7] = 0x18;\n\t\tbreak;\n\n\tcase DRM_MODE_SUBCONNECTOR_Component:\n\t\tregs->ptv_204 = 0x111333;\n\t\tregs->tv_enc[0x7] = 0x14;\n\t\tbreak;\n\n\tcase DRM_MODE_SUBCONNECTOR_SCART:\n\t\tregs->ptv_204 = 0x111012;\n\t\tregs->tv_enc[0x7] = 0x18;\n\t\tbreak;\n\t}\n\n\tregs->tv_enc[0x20] = interpolate(0, tv_norm->tv_enc_mode.tv_enc[0x20],\n\t\t\t\t\t 255, tv_enc->saturation);\n\tregs->tv_enc[0x22] = interpolate(0, tv_norm->tv_enc_mode.tv_enc[0x22],\n\t\t\t\t\t 255, tv_enc->saturation);\n\tregs->tv_enc[0x25] = tv_enc->hue * 255 / 100;\n\n\tnv_load_ptv(dev, regs, 204);\n\tnv_load_tv_enc(dev, regs, 7);\n\tnv_load_tv_enc(dev, regs, 20);\n\tnv_load_tv_enc(dev, regs, 22);\n\tnv_load_tv_enc(dev, regs, 25);\n}\n\nvoid nv17_tv_update_rescaler(struct drm_encoder *encoder)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct nv17_tv_encoder *tv_enc = to_tv_enc(encoder);\n\tstruct nv17_tv_state *regs = &tv_enc->state;\n\n\tregs->ptv_208 = 0x40 | (calc_overscan(tv_enc->overscan) << 8);\n\n\ttv_setup_filter(encoder);\n\n\tnv_load_ptv(dev, regs, 208);\n\ttv_load_filter(dev, NV_PTV_HFILTER, regs->hfilter);\n\ttv_load_filter(dev, NV_PTV_HFILTER2, regs->hfilter2);\n\ttv_load_filter(dev, NV_PTV_VFILTER, regs->vfilter);\n}\n\nvoid nv17_ctv_update_rescaler(struct drm_encoder *encoder)\n{\n\tstruct drm_device *dev = encoder->dev;\n\tstruct nv17_tv_encoder *tv_enc = to_tv_enc(encoder);\n\tint head = nouveau_crtc(encoder->crtc)->index;\n\tstruct nv04_crtc_reg *regs = &nv04_display(dev)->mode_reg.crtc_reg[head];\n\tstruct drm_display_mode *crtc_mode = &encoder->crtc->mode;\n\tstruct drm_display_mode *output_mode =\n\t\t&get_tv_norm(encoder)->ctv_enc_mode.mode;\n\tint overscan, hmargin, vmargin, hratio, vratio;\n\n\t \n\tif (output_mode->flags & DRM_MODE_FLAG_INTERLACE)\n\t\toverscan = 100;\n\telse\n\t\toverscan = tv_enc->overscan;\n\n\thmargin = (output_mode->hdisplay - crtc_mode->hdisplay) / 2;\n\tvmargin = (output_mode->vdisplay - crtc_mode->vdisplay) / 2;\n\n\thmargin = interpolate(0, min(hmargin, output_mode->hdisplay/20),\n\t\t\t      hmargin, overscan);\n\tvmargin = interpolate(0, min(vmargin, output_mode->vdisplay/20),\n\t\t\t      vmargin, overscan);\n\n\thratio = crtc_mode->hdisplay * 0x800 /\n\t\t(output_mode->hdisplay - 2*hmargin);\n\tvratio = crtc_mode->vdisplay * 0x800 /\n\t\t(output_mode->vdisplay - 2*vmargin) & ~3;\n\n\tregs->fp_horiz_regs[FP_VALID_START] = hmargin;\n\tregs->fp_horiz_regs[FP_VALID_END] = output_mode->hdisplay - hmargin - 1;\n\tregs->fp_vert_regs[FP_VALID_START] = vmargin;\n\tregs->fp_vert_regs[FP_VALID_END] = output_mode->vdisplay - vmargin - 1;\n\n\tregs->fp_debug_1 = NV_PRAMDAC_FP_DEBUG_1_YSCALE_TESTMODE_ENABLE |\n\t\tXLATE(vratio, 0, NV_PRAMDAC_FP_DEBUG_1_YSCALE_VALUE) |\n\t\tNV_PRAMDAC_FP_DEBUG_1_XSCALE_TESTMODE_ENABLE |\n\t\tXLATE(hratio, 0, NV_PRAMDAC_FP_DEBUG_1_XSCALE_VALUE);\n\n\tNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_HVALID_START,\n\t\t      regs->fp_horiz_regs[FP_VALID_START]);\n\tNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_HVALID_END,\n\t\t      regs->fp_horiz_regs[FP_VALID_END]);\n\tNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_VVALID_START,\n\t\t      regs->fp_vert_regs[FP_VALID_START]);\n\tNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_VVALID_END,\n\t\t      regs->fp_vert_regs[FP_VALID_END]);\n\tNVWriteRAMDAC(dev, head, NV_PRAMDAC_FP_DEBUG_1, regs->fp_debug_1);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}