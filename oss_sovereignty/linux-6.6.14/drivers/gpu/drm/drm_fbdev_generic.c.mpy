{
  "module_name": "drm_fbdev_generic.c",
  "hash_id": "ac539411eb297ef5bb47f0d516489ef9002f266f019c2717db626aa864937806",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/drm_fbdev_generic.c",
  "human_readable_source": "\n\n#include <linux/moduleparam.h>\n#include <linux/vmalloc.h>\n\n#include <drm/drm_crtc_helper.h>\n#include <drm/drm_drv.h>\n#include <drm/drm_fb_helper.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem.h>\n#include <drm/drm_print.h>\n\n#include <drm/drm_fbdev_generic.h>\n\n \nstatic int drm_fbdev_generic_fb_open(struct fb_info *info, int user)\n{\n\tstruct drm_fb_helper *fb_helper = info->par;\n\n\t \n\tif (user && !try_module_get(fb_helper->dev->driver->fops->owner))\n\t\treturn -ENODEV;\n\n\treturn 0;\n}\n\nstatic int drm_fbdev_generic_fb_release(struct fb_info *info, int user)\n{\n\tstruct drm_fb_helper *fb_helper = info->par;\n\n\tif (user)\n\t\tmodule_put(fb_helper->dev->driver->fops->owner);\n\n\treturn 0;\n}\n\nFB_GEN_DEFAULT_DEFERRED_SYSMEM_OPS(drm_fbdev_generic,\n\t\t\t\t   drm_fb_helper_damage_range,\n\t\t\t\t   drm_fb_helper_damage_area);\n\nstatic void drm_fbdev_generic_fb_destroy(struct fb_info *info)\n{\n\tstruct drm_fb_helper *fb_helper = info->par;\n\tvoid *shadow = info->screen_buffer;\n\n\tif (!fb_helper->dev)\n\t\treturn;\n\n\tfb_deferred_io_cleanup(info);\n\tdrm_fb_helper_fini(fb_helper);\n\tvfree(shadow);\n\tdrm_client_framebuffer_delete(fb_helper->buffer);\n\n\tdrm_client_release(&fb_helper->client);\n\tdrm_fb_helper_unprepare(fb_helper);\n\tkfree(fb_helper);\n}\n\nstatic const struct fb_ops drm_fbdev_generic_fb_ops = {\n\t.owner\t\t= THIS_MODULE,\n\t.fb_open\t= drm_fbdev_generic_fb_open,\n\t.fb_release\t= drm_fbdev_generic_fb_release,\n\tFB_DEFAULT_DEFERRED_OPS(drm_fbdev_generic),\n\tDRM_FB_HELPER_DEFAULT_OPS,\n\t.fb_destroy\t= drm_fbdev_generic_fb_destroy,\n};\n\n \nstatic int drm_fbdev_generic_helper_fb_probe(struct drm_fb_helper *fb_helper,\n\t\t\t\t\t     struct drm_fb_helper_surface_size *sizes)\n{\n\tstruct drm_client_dev *client = &fb_helper->client;\n\tstruct drm_device *dev = fb_helper->dev;\n\tstruct drm_client_buffer *buffer;\n\tstruct fb_info *info;\n\tsize_t screen_size;\n\tvoid *screen_buffer;\n\tu32 format;\n\tint ret;\n\n\tdrm_dbg_kms(dev, \"surface width(%d), height(%d) and bpp(%d)\\n\",\n\t\t    sizes->surface_width, sizes->surface_height,\n\t\t    sizes->surface_bpp);\n\n\tformat = drm_mode_legacy_fb_format(sizes->surface_bpp, sizes->surface_depth);\n\tbuffer = drm_client_framebuffer_create(client, sizes->surface_width,\n\t\t\t\t\t       sizes->surface_height, format);\n\tif (IS_ERR(buffer))\n\t\treturn PTR_ERR(buffer);\n\n\tfb_helper->buffer = buffer;\n\tfb_helper->fb = buffer->fb;\n\n\tscreen_size = buffer->gem->size;\n\tscreen_buffer = vzalloc(screen_size);\n\tif (!screen_buffer) {\n\t\tret = -ENOMEM;\n\t\tgoto err_drm_client_framebuffer_delete;\n\t}\n\n\tinfo = drm_fb_helper_alloc_info(fb_helper);\n\tif (IS_ERR(info)) {\n\t\tret = PTR_ERR(info);\n\t\tgoto err_vfree;\n\t}\n\n\tdrm_fb_helper_fill_info(info, fb_helper, sizes);\n\n\tinfo->fbops = &drm_fbdev_generic_fb_ops;\n\n\t \n\tinfo->flags |= FBINFO_VIRTFB | FBINFO_READS_FAST;\n\tinfo->screen_buffer = screen_buffer;\n\tinfo->fix.smem_start = page_to_phys(vmalloc_to_page(info->screen_buffer));\n\tinfo->fix.smem_len = screen_size;\n\n\t \n\tfb_helper->fbdefio.delay = HZ / 20;\n\tfb_helper->fbdefio.deferred_io = drm_fb_helper_deferred_io;\n\n\tinfo->fbdefio = &fb_helper->fbdefio;\n\tret = fb_deferred_io_init(info);\n\tif (ret)\n\t\tgoto err_drm_fb_helper_release_info;\n\n\treturn 0;\n\nerr_drm_fb_helper_release_info:\n\tdrm_fb_helper_release_info(fb_helper);\nerr_vfree:\n\tvfree(screen_buffer);\nerr_drm_client_framebuffer_delete:\n\tfb_helper->fb = NULL;\n\tfb_helper->buffer = NULL;\n\tdrm_client_framebuffer_delete(buffer);\n\treturn ret;\n}\n\nstatic void drm_fbdev_generic_damage_blit_real(struct drm_fb_helper *fb_helper,\n\t\t\t\t\t       struct drm_clip_rect *clip,\n\t\t\t\t\t       struct iosys_map *dst)\n{\n\tstruct drm_framebuffer *fb = fb_helper->fb;\n\tsize_t offset = clip->y1 * fb->pitches[0];\n\tsize_t len = clip->x2 - clip->x1;\n\tunsigned int y;\n\tvoid *src;\n\n\tswitch (drm_format_info_bpp(fb->format, 0)) {\n\tcase 1:\n\t\toffset += clip->x1 / 8;\n\t\tlen = DIV_ROUND_UP(len + clip->x1 % 8, 8);\n\t\tbreak;\n\tcase 2:\n\t\toffset += clip->x1 / 4;\n\t\tlen = DIV_ROUND_UP(len + clip->x1 % 4, 4);\n\t\tbreak;\n\tcase 4:\n\t\toffset += clip->x1 / 2;\n\t\tlen = DIV_ROUND_UP(len + clip->x1 % 2, 2);\n\t\tbreak;\n\tdefault:\n\t\toffset += clip->x1 * fb->format->cpp[0];\n\t\tlen *= fb->format->cpp[0];\n\t\tbreak;\n\t}\n\n\tsrc = fb_helper->info->screen_buffer + offset;\n\tiosys_map_incr(dst, offset);  \n\n\tfor (y = clip->y1; y < clip->y2; y++) {\n\t\tiosys_map_memcpy_to(dst, 0, src, len);\n\t\tiosys_map_incr(dst, fb->pitches[0]);\n\t\tsrc += fb->pitches[0];\n\t}\n}\n\nstatic int drm_fbdev_generic_damage_blit(struct drm_fb_helper *fb_helper,\n\t\t\t\t\t struct drm_clip_rect *clip)\n{\n\tstruct drm_client_buffer *buffer = fb_helper->buffer;\n\tstruct iosys_map map, dst;\n\tint ret;\n\n\t \n\tmutex_lock(&fb_helper->lock);\n\n\tret = drm_client_buffer_vmap(buffer, &map);\n\tif (ret)\n\t\tgoto out;\n\n\tdst = map;\n\tdrm_fbdev_generic_damage_blit_real(fb_helper, clip, &dst);\n\n\tdrm_client_buffer_vunmap(buffer);\n\nout:\n\tmutex_unlock(&fb_helper->lock);\n\n\treturn ret;\n}\n\nstatic int drm_fbdev_generic_helper_fb_dirty(struct drm_fb_helper *helper,\n\t\t\t\t\t     struct drm_clip_rect *clip)\n{\n\tstruct drm_device *dev = helper->dev;\n\tint ret;\n\n\t \n\tif (!(clip->x1 < clip->x2 && clip->y1 < clip->y2))\n\t\treturn 0;\n\n\tret = drm_fbdev_generic_damage_blit(helper, clip);\n\tif (drm_WARN_ONCE(dev, ret, \"Damage blitter failed: ret=%d\\n\", ret))\n\t\treturn ret;\n\n\tif (helper->fb->funcs->dirty) {\n\t\tret = helper->fb->funcs->dirty(helper->fb, NULL, 0, 0, clip, 1);\n\t\tif (drm_WARN_ONCE(dev, ret, \"Dirty helper failed: ret=%d\\n\", ret))\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct drm_fb_helper_funcs drm_fbdev_generic_helper_funcs = {\n\t.fb_probe = drm_fbdev_generic_helper_fb_probe,\n\t.fb_dirty = drm_fbdev_generic_helper_fb_dirty,\n};\n\nstatic void drm_fbdev_generic_client_unregister(struct drm_client_dev *client)\n{\n\tstruct drm_fb_helper *fb_helper = drm_fb_helper_from_client(client);\n\n\tif (fb_helper->info) {\n\t\tdrm_fb_helper_unregister_info(fb_helper);\n\t} else {\n\t\tdrm_client_release(&fb_helper->client);\n\t\tdrm_fb_helper_unprepare(fb_helper);\n\t\tkfree(fb_helper);\n\t}\n}\n\nstatic int drm_fbdev_generic_client_restore(struct drm_client_dev *client)\n{\n\tdrm_fb_helper_lastclose(client->dev);\n\n\treturn 0;\n}\n\nstatic int drm_fbdev_generic_client_hotplug(struct drm_client_dev *client)\n{\n\tstruct drm_fb_helper *fb_helper = drm_fb_helper_from_client(client);\n\tstruct drm_device *dev = client->dev;\n\tint ret;\n\n\tif (dev->fb_helper)\n\t\treturn drm_fb_helper_hotplug_event(dev->fb_helper);\n\n\tret = drm_fb_helper_init(dev, fb_helper);\n\tif (ret)\n\t\tgoto err_drm_err;\n\n\tif (!drm_drv_uses_atomic_modeset(dev))\n\t\tdrm_helper_disable_unused_functions(dev);\n\n\tret = drm_fb_helper_initial_config(fb_helper);\n\tif (ret)\n\t\tgoto err_drm_fb_helper_fini;\n\n\treturn 0;\n\nerr_drm_fb_helper_fini:\n\tdrm_fb_helper_fini(fb_helper);\nerr_drm_err:\n\tdrm_err(dev, \"fbdev: Failed to setup generic emulation (ret=%d)\\n\", ret);\n\treturn ret;\n}\n\nstatic const struct drm_client_funcs drm_fbdev_generic_client_funcs = {\n\t.owner\t\t= THIS_MODULE,\n\t.unregister\t= drm_fbdev_generic_client_unregister,\n\t.restore\t= drm_fbdev_generic_client_restore,\n\t.hotplug\t= drm_fbdev_generic_client_hotplug,\n};\n\n \nvoid drm_fbdev_generic_setup(struct drm_device *dev, unsigned int preferred_bpp)\n{\n\tstruct drm_fb_helper *fb_helper;\n\tint ret;\n\n\tdrm_WARN(dev, !dev->registered, \"Device has not been registered.\\n\");\n\tdrm_WARN(dev, dev->fb_helper, \"fb_helper is already set!\\n\");\n\n\tfb_helper = kzalloc(sizeof(*fb_helper), GFP_KERNEL);\n\tif (!fb_helper)\n\t\treturn;\n\tdrm_fb_helper_prepare(dev, fb_helper, preferred_bpp, &drm_fbdev_generic_helper_funcs);\n\n\tret = drm_client_init(dev, &fb_helper->client, \"fbdev\", &drm_fbdev_generic_client_funcs);\n\tif (ret) {\n\t\tdrm_err(dev, \"Failed to register client: %d\\n\", ret);\n\t\tgoto err_drm_client_init;\n\t}\n\n\tdrm_client_register(&fb_helper->client);\n\n\treturn;\n\nerr_drm_client_init:\n\tdrm_fb_helper_unprepare(fb_helper);\n\tkfree(fb_helper);\n\treturn;\n}\nEXPORT_SYMBOL(drm_fbdev_generic_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}