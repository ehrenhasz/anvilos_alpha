{
  "module_name": "zynqmp_disp.c",
  "hash_id": "7c72881a51b7f9961bec37ba7189513f0952c328d0485c2f03e505e6386ddd6e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/xlnx/zynqmp_disp.c",
  "human_readable_source": "\n \n\n#include <drm/drm_fb_dma_helper.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_plane.h>\n\n#include <linux/clk.h>\n#include <linux/dma/xilinx_dpdma.h>\n#include <linux/dma-mapping.h>\n#include <linux/dmaengine.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\n#include \"zynqmp_disp.h\"\n#include \"zynqmp_disp_regs.h\"\n#include \"zynqmp_dp.h\"\n#include \"zynqmp_dpsub.h\"\n\n \n\n#define ZYNQMP_DISP_AV_BUF_NUM_VID_GFX_BUFFERS\t\t4\n#define ZYNQMP_DISP_AV_BUF_NUM_BUFFERS\t\t\t6\n\n#define ZYNQMP_DISP_MAX_NUM_SUB_PLANES\t\t\t3\n\n \nstruct zynqmp_disp_format {\n\tu32 drm_fmt;\n\tu32 buf_fmt;\n\tbool swap;\n\tconst u32 *sf;\n};\n\n \nstruct zynqmp_disp_layer_dma {\n\tstruct dma_chan *chan;\n\tstruct dma_interleaved_template xt;\n\tstruct data_chunk sgl;\n};\n\n \nstruct zynqmp_disp_layer_info {\n\tconst struct zynqmp_disp_format *formats;\n\tunsigned int num_formats;\n\tunsigned int num_channels;\n};\n\n \nstruct zynqmp_disp_layer {\n\tenum zynqmp_dpsub_layer_id id;\n\tstruct zynqmp_disp *disp;\n\tconst struct zynqmp_disp_layer_info *info;\n\n\tstruct zynqmp_disp_layer_dma dmas[ZYNQMP_DISP_MAX_NUM_SUB_PLANES];\n\n\tconst struct zynqmp_disp_format *disp_fmt;\n\tconst struct drm_format_info *drm_fmt;\n\tenum zynqmp_dpsub_layer_mode mode;\n};\n\n \nstruct zynqmp_disp {\n\tstruct device *dev;\n\tstruct zynqmp_dpsub *dpsub;\n\n\tstruct {\n\t\tvoid __iomem *base;\n\t} blend;\n\tstruct {\n\t\tvoid __iomem *base;\n\t} avbuf;\n\tstruct {\n\t\tvoid __iomem *base;\n\t} audio;\n\n\tstruct zynqmp_disp_layer layers[ZYNQMP_DPSUB_NUM_LAYERS];\n};\n\n \n\nstatic const u32 scaling_factors_444[] = {\n\tZYNQMP_DISP_AV_BUF_4BIT_SF,\n\tZYNQMP_DISP_AV_BUF_4BIT_SF,\n\tZYNQMP_DISP_AV_BUF_4BIT_SF,\n};\n\nstatic const u32 scaling_factors_555[] = {\n\tZYNQMP_DISP_AV_BUF_5BIT_SF,\n\tZYNQMP_DISP_AV_BUF_5BIT_SF,\n\tZYNQMP_DISP_AV_BUF_5BIT_SF,\n};\n\nstatic const u32 scaling_factors_565[] = {\n\tZYNQMP_DISP_AV_BUF_5BIT_SF,\n\tZYNQMP_DISP_AV_BUF_6BIT_SF,\n\tZYNQMP_DISP_AV_BUF_5BIT_SF,\n};\n\nstatic const u32 scaling_factors_888[] = {\n\tZYNQMP_DISP_AV_BUF_8BIT_SF,\n\tZYNQMP_DISP_AV_BUF_8BIT_SF,\n\tZYNQMP_DISP_AV_BUF_8BIT_SF,\n};\n\nstatic const u32 scaling_factors_101010[] = {\n\tZYNQMP_DISP_AV_BUF_10BIT_SF,\n\tZYNQMP_DISP_AV_BUF_10BIT_SF,\n\tZYNQMP_DISP_AV_BUF_10BIT_SF,\n};\n\n \nstatic const struct zynqmp_disp_format avbuf_vid_fmts[] = {\n\t{\n\t\t.drm_fmt\t= DRM_FORMAT_VYUY,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_VYUY,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_UYVY,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_VYUY,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_YUYV,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YUYV,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_YVYU,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YUYV,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_YUV422,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV16,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_YVU422,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV16,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_YUV444,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV24,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_YVU444,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV24,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_NV16,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV16CI,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_NV61,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV16CI,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_BGR888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_RGB888,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_RGB888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_RGB888,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_XBGR8888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_RGBA8880,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_XRGB8888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_RGBA8880,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_XBGR2101010,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_RGB888_10,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_101010,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_XRGB2101010,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_RGB888_10,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_101010,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_YUV420,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV16_420,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_YVU420,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV16_420,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_NV12,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV16CI_420,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_NV21,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_VID_YV16CI_420,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t},\n};\n\n \nstatic const struct zynqmp_disp_format avbuf_gfx_fmts[] = {\n\t{\n\t\t.drm_fmt\t= DRM_FORMAT_ABGR8888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_RGBA8888,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_ARGB8888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_RGBA8888,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_RGBA8888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_ABGR8888,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_BGRA8888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_ABGR8888,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_BGR888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_RGB888,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_RGB888,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_BGR888,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_888,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_RGBA5551,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_RGBA5551,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_555,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_BGRA5551,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_RGBA5551,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_555,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_RGBA4444,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_RGBA4444,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_444,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_BGRA4444,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_RGBA4444,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_444,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_RGB565,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_RGB565,\n\t\t.swap\t\t= false,\n\t\t.sf\t\t= scaling_factors_565,\n\t}, {\n\t\t.drm_fmt\t= DRM_FORMAT_BGR565,\n\t\t.buf_fmt\t= ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_RGB565,\n\t\t.swap\t\t= true,\n\t\t.sf\t\t= scaling_factors_565,\n\t},\n};\n\nstatic u32 zynqmp_disp_avbuf_read(struct zynqmp_disp *disp, int reg)\n{\n\treturn readl(disp->avbuf.base + reg);\n}\n\nstatic void zynqmp_disp_avbuf_write(struct zynqmp_disp *disp, int reg, u32 val)\n{\n\twritel(val, disp->avbuf.base + reg);\n}\n\nstatic bool zynqmp_disp_layer_is_video(const struct zynqmp_disp_layer *layer)\n{\n\treturn layer->id == ZYNQMP_DPSUB_LAYER_VID;\n}\n\n \nstatic void zynqmp_disp_avbuf_set_format(struct zynqmp_disp *disp,\n\t\t\t\t\t struct zynqmp_disp_layer *layer,\n\t\t\t\t\t const struct zynqmp_disp_format *fmt)\n{\n\tunsigned int i;\n\tu32 val;\n\n\tval = zynqmp_disp_avbuf_read(disp, ZYNQMP_DISP_AV_BUF_FMT);\n\tval &= zynqmp_disp_layer_is_video(layer)\n\t    ? ~ZYNQMP_DISP_AV_BUF_FMT_NL_VID_MASK\n\t    : ~ZYNQMP_DISP_AV_BUF_FMT_NL_GFX_MASK;\n\tval |= fmt->buf_fmt;\n\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_FMT, val);\n\n\tfor (i = 0; i < ZYNQMP_DISP_AV_BUF_NUM_SF; i++) {\n\t\tunsigned int reg = zynqmp_disp_layer_is_video(layer)\n\t\t\t\t ? ZYNQMP_DISP_AV_BUF_VID_COMP_SF(i)\n\t\t\t\t : ZYNQMP_DISP_AV_BUF_GFX_COMP_SF(i);\n\n\t\tzynqmp_disp_avbuf_write(disp, reg, fmt->sf[i]);\n\t}\n}\n\n \nstatic void\nzynqmp_disp_avbuf_set_clocks_sources(struct zynqmp_disp *disp,\n\t\t\t\t     bool video_from_ps, bool audio_from_ps,\n\t\t\t\t     bool timings_internal)\n{\n\tu32 val = 0;\n\n\tif (video_from_ps)\n\t\tval |= ZYNQMP_DISP_AV_BUF_CLK_SRC_VID_FROM_PS;\n\tif (audio_from_ps)\n\t\tval |= ZYNQMP_DISP_AV_BUF_CLK_SRC_AUD_FROM_PS;\n\tif (timings_internal)\n\t\tval |= ZYNQMP_DISP_AV_BUF_CLK_SRC_VID_INTERNAL_TIMING;\n\n\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_CLK_SRC, val);\n}\n\n \nstatic void zynqmp_disp_avbuf_enable_channels(struct zynqmp_disp *disp)\n{\n\tunsigned int i;\n\tu32 val;\n\n\tval = ZYNQMP_DISP_AV_BUF_CHBUF_EN |\n\t      (ZYNQMP_DISP_AV_BUF_CHBUF_BURST_LEN_MAX <<\n\t       ZYNQMP_DISP_AV_BUF_CHBUF_BURST_LEN_SHIFT);\n\n\tfor (i = 0; i < ZYNQMP_DISP_AV_BUF_NUM_VID_GFX_BUFFERS; i++)\n\t\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_CHBUF(i),\n\t\t\t\t\tval);\n\n\tval = ZYNQMP_DISP_AV_BUF_CHBUF_EN |\n\t      (ZYNQMP_DISP_AV_BUF_CHBUF_BURST_LEN_AUD_MAX <<\n\t       ZYNQMP_DISP_AV_BUF_CHBUF_BURST_LEN_SHIFT);\n\n\tfor (; i < ZYNQMP_DISP_AV_BUF_NUM_BUFFERS; i++)\n\t\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_CHBUF(i),\n\t\t\t\t\tval);\n}\n\n \nstatic void zynqmp_disp_avbuf_disable_channels(struct zynqmp_disp *disp)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < ZYNQMP_DISP_AV_BUF_NUM_BUFFERS; i++)\n\t\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_CHBUF(i),\n\t\t\t\t\tZYNQMP_DISP_AV_BUF_CHBUF_FLUSH);\n}\n\n \nstatic void zynqmp_disp_avbuf_enable_audio(struct zynqmp_disp *disp)\n{\n\tu32 val;\n\n\tval = zynqmp_disp_avbuf_read(disp, ZYNQMP_DISP_AV_BUF_OUTPUT);\n\tval &= ~ZYNQMP_DISP_AV_BUF_OUTPUT_AUD1_MASK;\n\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_AUD1_MEM;\n\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_AUD2_EN;\n\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_OUTPUT, val);\n}\n\n \nstatic void zynqmp_disp_avbuf_disable_audio(struct zynqmp_disp *disp)\n{\n\tu32 val;\n\n\tval = zynqmp_disp_avbuf_read(disp, ZYNQMP_DISP_AV_BUF_OUTPUT);\n\tval &= ~ZYNQMP_DISP_AV_BUF_OUTPUT_AUD1_MASK;\n\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_AUD1_DISABLE;\n\tval &= ~ZYNQMP_DISP_AV_BUF_OUTPUT_AUD2_EN;\n\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_OUTPUT, val);\n}\n\n \nstatic void zynqmp_disp_avbuf_enable_video(struct zynqmp_disp *disp,\n\t\t\t\t\t   struct zynqmp_disp_layer *layer)\n{\n\tu32 val;\n\n\tval = zynqmp_disp_avbuf_read(disp, ZYNQMP_DISP_AV_BUF_OUTPUT);\n\tif (zynqmp_disp_layer_is_video(layer)) {\n\t\tval &= ~ZYNQMP_DISP_AV_BUF_OUTPUT_VID1_MASK;\n\t\tif (layer->mode == ZYNQMP_DPSUB_LAYER_NONLIVE)\n\t\t\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_VID1_MEM;\n\t\telse\n\t\t\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_VID1_LIVE;\n\t} else {\n\t\tval &= ~ZYNQMP_DISP_AV_BUF_OUTPUT_VID2_MASK;\n\t\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_VID2_MEM;\n\t\tif (layer->mode == ZYNQMP_DPSUB_LAYER_NONLIVE)\n\t\t\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_VID2_MEM;\n\t\telse\n\t\t\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_VID2_LIVE;\n\t}\n\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_OUTPUT, val);\n}\n\n \nstatic void zynqmp_disp_avbuf_disable_video(struct zynqmp_disp *disp,\n\t\t\t\t\t    struct zynqmp_disp_layer *layer)\n{\n\tu32 val;\n\n\tval = zynqmp_disp_avbuf_read(disp, ZYNQMP_DISP_AV_BUF_OUTPUT);\n\tif (zynqmp_disp_layer_is_video(layer)) {\n\t\tval &= ~ZYNQMP_DISP_AV_BUF_OUTPUT_VID1_MASK;\n\t\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_VID1_NONE;\n\t} else {\n\t\tval &= ~ZYNQMP_DISP_AV_BUF_OUTPUT_VID2_MASK;\n\t\tval |= ZYNQMP_DISP_AV_BUF_OUTPUT_VID2_DISABLE;\n\t}\n\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_OUTPUT, val);\n}\n\n \nstatic void zynqmp_disp_avbuf_enable(struct zynqmp_disp *disp)\n{\n\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_SRST_REG, 0);\n}\n\n \nstatic void zynqmp_disp_avbuf_disable(struct zynqmp_disp *disp)\n{\n\tzynqmp_disp_avbuf_write(disp, ZYNQMP_DISP_AV_BUF_SRST_REG,\n\t\t\t\tZYNQMP_DISP_AV_BUF_SRST_REG_VID_RST);\n}\n\n \n\nstatic void zynqmp_disp_blend_write(struct zynqmp_disp *disp, int reg, u32 val)\n{\n\twritel(val, disp->blend.base + reg);\n}\n\n \nstatic const u16 csc_zero_matrix[] = {\n\t0x0,    0x0,    0x0,\n\t0x0,    0x0,    0x0,\n\t0x0,    0x0,    0x0\n};\n\nstatic const u16 csc_identity_matrix[] = {\n\t0x1000, 0x0,    0x0,\n\t0x0,    0x1000, 0x0,\n\t0x0,    0x0,    0x1000\n};\n\nstatic const u32 csc_zero_offsets[] = {\n\t0, 0, 0\n};\n\nstatic const u16 csc_rgb_to_sdtv_matrix[] = {\n\t0x4c9,  0x864,  0x1d3,\n\t0x7d4d, 0x7ab3, 0x800,\n\t0x800,  0x794d, 0x7eb3\n};\n\nstatic const u32 csc_rgb_to_sdtv_offsets[] = {\n\t0x0, 0x8000000, 0x8000000\n};\n\nstatic const u16 csc_sdtv_to_rgb_matrix[] = {\n\t0x1000, 0x166f, 0x0,\n\t0x1000, 0x7483, 0x7a7f,\n\t0x1000, 0x0,    0x1c5a\n};\n\nstatic const u32 csc_sdtv_to_rgb_offsets[] = {\n\t0x0, 0x1800, 0x1800\n};\n\n \nstatic void zynqmp_disp_blend_set_output_format(struct zynqmp_disp *disp,\n\t\t\t\t\t\tenum zynqmp_dpsub_format format)\n{\n\tstatic const unsigned int blend_output_fmts[] = {\n\t\t[ZYNQMP_DPSUB_FORMAT_RGB] = ZYNQMP_DISP_V_BLEND_OUTPUT_VID_FMT_RGB,\n\t\t[ZYNQMP_DPSUB_FORMAT_YCRCB444] = ZYNQMP_DISP_V_BLEND_OUTPUT_VID_FMT_YCBCR444,\n\t\t[ZYNQMP_DPSUB_FORMAT_YCRCB422] = ZYNQMP_DISP_V_BLEND_OUTPUT_VID_FMT_YCBCR422\n\t\t\t\t\t       | ZYNQMP_DISP_V_BLEND_OUTPUT_VID_FMT_EN_DOWNSAMPLE,\n\t\t[ZYNQMP_DPSUB_FORMAT_YONLY] = ZYNQMP_DISP_V_BLEND_OUTPUT_VID_FMT_YONLY,\n\t};\n\n\tu32 fmt = blend_output_fmts[format];\n\tconst u16 *coeffs;\n\tconst u32 *offsets;\n\tunsigned int i;\n\n\tzynqmp_disp_blend_write(disp, ZYNQMP_DISP_V_BLEND_OUTPUT_VID_FMT, fmt);\n\tif (fmt == ZYNQMP_DISP_V_BLEND_OUTPUT_VID_FMT_RGB) {\n\t\tcoeffs = csc_identity_matrix;\n\t\toffsets = csc_zero_offsets;\n\t} else {\n\t\tcoeffs = csc_rgb_to_sdtv_matrix;\n\t\toffsets = csc_rgb_to_sdtv_offsets;\n\t}\n\n\tfor (i = 0; i < ZYNQMP_DISP_V_BLEND_NUM_COEFF; i++)\n\t\tzynqmp_disp_blend_write(disp,\n\t\t\t\t\tZYNQMP_DISP_V_BLEND_RGB2YCBCR_COEFF(i),\n\t\t\t\t\tcoeffs[i]);\n\n\tfor (i = 0; i < ZYNQMP_DISP_V_BLEND_NUM_OFFSET; i++)\n\t\tzynqmp_disp_blend_write(disp,\n\t\t\t\t\tZYNQMP_DISP_V_BLEND_OUTCSC_OFFSET(i),\n\t\t\t\t\toffsets[i]);\n}\n\n \nstatic void zynqmp_disp_blend_set_bg_color(struct zynqmp_disp *disp,\n\t\t\t\t\t   u32 rcr, u32 gy, u32 bcb)\n{\n\tzynqmp_disp_blend_write(disp, ZYNQMP_DISP_V_BLEND_BG_CLR_0, rcr);\n\tzynqmp_disp_blend_write(disp, ZYNQMP_DISP_V_BLEND_BG_CLR_1, gy);\n\tzynqmp_disp_blend_write(disp, ZYNQMP_DISP_V_BLEND_BG_CLR_2, bcb);\n}\n\n \nvoid zynqmp_disp_blend_set_global_alpha(struct zynqmp_disp *disp,\n\t\t\t\t\tbool enable, u32 alpha)\n{\n\tzynqmp_disp_blend_write(disp, ZYNQMP_DISP_V_BLEND_SET_GLOBAL_ALPHA,\n\t\t\t\tZYNQMP_DISP_V_BLEND_SET_GLOBAL_ALPHA_VALUE(alpha) |\n\t\t\t\t(enable ? ZYNQMP_DISP_V_BLEND_SET_GLOBAL_ALPHA_EN : 0));\n}\n\n \nstatic void zynqmp_disp_blend_layer_set_csc(struct zynqmp_disp *disp,\n\t\t\t\t\t    struct zynqmp_disp_layer *layer,\n\t\t\t\t\t    const u16 *coeffs,\n\t\t\t\t\t    const u32 *offsets)\n{\n\tunsigned int swap[3] = { 0, 1, 2 };\n\tunsigned int reg;\n\tunsigned int i;\n\n\tif (layer->disp_fmt->swap) {\n\t\tif (layer->drm_fmt->is_yuv) {\n\t\t\t \n\t\t\tswap[1] = 2;\n\t\t\tswap[2] = 1;\n\t\t} else {\n\t\t\t \n\t\t\tswap[0] = 2;\n\t\t\tswap[2] = 0;\n\t\t}\n\t}\n\n\tif (zynqmp_disp_layer_is_video(layer))\n\t\treg = ZYNQMP_DISP_V_BLEND_IN1CSC_COEFF(0);\n\telse\n\t\treg = ZYNQMP_DISP_V_BLEND_IN2CSC_COEFF(0);\n\n\tfor (i = 0; i < ZYNQMP_DISP_V_BLEND_NUM_COEFF; i += 3, reg += 12) {\n\t\tzynqmp_disp_blend_write(disp, reg + 0, coeffs[i + swap[0]]);\n\t\tzynqmp_disp_blend_write(disp, reg + 4, coeffs[i + swap[1]]);\n\t\tzynqmp_disp_blend_write(disp, reg + 8, coeffs[i + swap[2]]);\n\t}\n\n\tif (zynqmp_disp_layer_is_video(layer))\n\t\treg = ZYNQMP_DISP_V_BLEND_IN1CSC_OFFSET(0);\n\telse\n\t\treg = ZYNQMP_DISP_V_BLEND_IN2CSC_OFFSET(0);\n\n\tfor (i = 0; i < ZYNQMP_DISP_V_BLEND_NUM_OFFSET; i++)\n\t\tzynqmp_disp_blend_write(disp, reg + i * 4, offsets[i]);\n}\n\n \nstatic void zynqmp_disp_blend_layer_enable(struct zynqmp_disp *disp,\n\t\t\t\t\t   struct zynqmp_disp_layer *layer)\n{\n\tconst u16 *coeffs;\n\tconst u32 *offsets;\n\tu32 val;\n\n\tval = (layer->drm_fmt->is_yuv ?\n\t       0 : ZYNQMP_DISP_V_BLEND_LAYER_CONTROL_RGB) |\n\t      (layer->drm_fmt->hsub > 1 ?\n\t       ZYNQMP_DISP_V_BLEND_LAYER_CONTROL_EN_US : 0);\n\n\tzynqmp_disp_blend_write(disp,\n\t\t\t\tZYNQMP_DISP_V_BLEND_LAYER_CONTROL(layer->id),\n\t\t\t\tval);\n\n\tif (layer->drm_fmt->is_yuv) {\n\t\tcoeffs = csc_sdtv_to_rgb_matrix;\n\t\toffsets = csc_sdtv_to_rgb_offsets;\n\t} else {\n\t\tcoeffs = csc_identity_matrix;\n\t\toffsets = csc_zero_offsets;\n\t}\n\n\tzynqmp_disp_blend_layer_set_csc(disp, layer, coeffs, offsets);\n}\n\n \nstatic void zynqmp_disp_blend_layer_disable(struct zynqmp_disp *disp,\n\t\t\t\t\t    struct zynqmp_disp_layer *layer)\n{\n\tzynqmp_disp_blend_write(disp,\n\t\t\t\tZYNQMP_DISP_V_BLEND_LAYER_CONTROL(layer->id),\n\t\t\t\t0);\n\n\tzynqmp_disp_blend_layer_set_csc(disp, layer, csc_zero_matrix,\n\t\t\t\t\tcsc_zero_offsets);\n}\n\n \n\nstatic void zynqmp_disp_audio_write(struct zynqmp_disp *disp, int reg, u32 val)\n{\n\twritel(val, disp->audio.base + reg);\n}\n\n \nstatic void zynqmp_disp_audio_enable(struct zynqmp_disp *disp)\n{\n\t \n\tzynqmp_disp_audio_write(disp, ZYNQMP_DISP_AUD_SOFT_RESET, 0);\n\tzynqmp_disp_audio_write(disp, ZYNQMP_DISP_AUD_MIXER_VOLUME,\n\t\t\t\tZYNQMP_DISP_AUD_MIXER_VOLUME_NO_SCALE);\n}\n\n \nstatic void zynqmp_disp_audio_disable(struct zynqmp_disp *disp)\n{\n\tzynqmp_disp_audio_write(disp, ZYNQMP_DISP_AUD_SOFT_RESET,\n\t\t\t\tZYNQMP_DISP_AUD_SOFT_RESET_AUD_SRST);\n}\n\n \n\n \nstatic const struct zynqmp_disp_format *\nzynqmp_disp_layer_find_format(struct zynqmp_disp_layer *layer,\n\t\t\t      u32 drm_fmt)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < layer->info->num_formats; i++) {\n\t\tif (layer->info->formats[i].drm_fmt == drm_fmt)\n\t\t\treturn &layer->info->formats[i];\n\t}\n\n\treturn NULL;\n}\n\n \nu32 *zynqmp_disp_layer_drm_formats(struct zynqmp_disp_layer *layer,\n\t\t\t\t   unsigned int *num_formats)\n{\n\tunsigned int i;\n\tu32 *formats;\n\n\tformats = kcalloc(layer->info->num_formats, sizeof(*formats),\n\t\t\t  GFP_KERNEL);\n\tif (!formats)\n\t\treturn NULL;\n\n\tfor (i = 0; i < layer->info->num_formats; ++i)\n\t\tformats[i] = layer->info->formats[i].drm_fmt;\n\n\t*num_formats = layer->info->num_formats;\n\treturn formats;\n}\n\n \nvoid zynqmp_disp_layer_enable(struct zynqmp_disp_layer *layer,\n\t\t\t      enum zynqmp_dpsub_layer_mode mode)\n{\n\tlayer->mode = mode;\n\tzynqmp_disp_avbuf_enable_video(layer->disp, layer);\n\tzynqmp_disp_blend_layer_enable(layer->disp, layer);\n}\n\n \nvoid zynqmp_disp_layer_disable(struct zynqmp_disp_layer *layer)\n{\n\tunsigned int i;\n\n\tif (layer->disp->dpsub->dma_enabled) {\n\t\tfor (i = 0; i < layer->drm_fmt->num_planes; i++)\n\t\t\tdmaengine_terminate_sync(layer->dmas[i].chan);\n\t}\n\n\tzynqmp_disp_avbuf_disable_video(layer->disp, layer);\n\tzynqmp_disp_blend_layer_disable(layer->disp, layer);\n}\n\n \nvoid zynqmp_disp_layer_set_format(struct zynqmp_disp_layer *layer,\n\t\t\t\t  const struct drm_format_info *info)\n{\n\tunsigned int i;\n\n\tlayer->disp_fmt = zynqmp_disp_layer_find_format(layer, info->format);\n\tlayer->drm_fmt = info;\n\n\tzynqmp_disp_avbuf_set_format(layer->disp, layer, layer->disp_fmt);\n\n\tif (!layer->disp->dpsub->dma_enabled)\n\t\treturn;\n\n\t \n\tfor (i = 0; i < info->num_planes; i++) {\n\t\tstruct zynqmp_disp_layer_dma *dma = &layer->dmas[i];\n\t\tstruct xilinx_dpdma_peripheral_config pconfig = {\n\t\t\t.video_group = true,\n\t\t};\n\t\tstruct dma_slave_config config = {\n\t\t\t.direction = DMA_MEM_TO_DEV,\n\t\t\t.peripheral_config = &pconfig,\n\t\t\t.peripheral_size = sizeof(pconfig),\n\t\t};\n\n\t\tdmaengine_slave_config(dma->chan, &config);\n\t}\n}\n\n \nint zynqmp_disp_layer_update(struct zynqmp_disp_layer *layer,\n\t\t\t     struct drm_plane_state *state)\n{\n\tconst struct drm_format_info *info = layer->drm_fmt;\n\tunsigned int i;\n\n\tif (!layer->disp->dpsub->dma_enabled)\n\t\treturn 0;\n\n\tfor (i = 0; i < info->num_planes; i++) {\n\t\tunsigned int width = state->crtc_w / (i ? info->hsub : 1);\n\t\tunsigned int height = state->crtc_h / (i ? info->vsub : 1);\n\t\tstruct zynqmp_disp_layer_dma *dma = &layer->dmas[i];\n\t\tstruct dma_async_tx_descriptor *desc;\n\t\tdma_addr_t dma_addr;\n\n\t\tdma_addr = drm_fb_dma_get_gem_addr(state->fb, state, i);\n\n\t\tdma->xt.numf = height;\n\t\tdma->sgl.size = width * info->cpp[i];\n\t\tdma->sgl.icg = state->fb->pitches[i] - dma->sgl.size;\n\t\tdma->xt.src_start = dma_addr;\n\t\tdma->xt.frame_size = 1;\n\t\tdma->xt.dir = DMA_MEM_TO_DEV;\n\t\tdma->xt.src_sgl = true;\n\t\tdma->xt.dst_sgl = false;\n\n\t\tdesc = dmaengine_prep_interleaved_dma(dma->chan, &dma->xt,\n\t\t\t\t\t\t      DMA_CTRL_ACK |\n\t\t\t\t\t\t      DMA_PREP_REPEAT |\n\t\t\t\t\t\t      DMA_PREP_LOAD_EOT);\n\t\tif (!desc) {\n\t\t\tdev_err(layer->disp->dev,\n\t\t\t\t\"failed to prepare DMA descriptor\\n\");\n\t\t\treturn -ENOMEM;\n\t\t}\n\n\t\tdmaengine_submit(desc);\n\t\tdma_async_issue_pending(dma->chan);\n\t}\n\n\treturn 0;\n}\n\n \nstatic void zynqmp_disp_layer_release_dma(struct zynqmp_disp *disp,\n\t\t\t\t\t  struct zynqmp_disp_layer *layer)\n{\n\tunsigned int i;\n\n\tif (!layer->info || !disp->dpsub->dma_enabled)\n\t\treturn;\n\n\tfor (i = 0; i < layer->info->num_channels; i++) {\n\t\tstruct zynqmp_disp_layer_dma *dma = &layer->dmas[i];\n\n\t\tif (!dma->chan)\n\t\t\tcontinue;\n\n\t\t \n\t\tdmaengine_terminate_sync(dma->chan);\n\t\tdma_release_channel(dma->chan);\n\t}\n}\n\n \nstatic void zynqmp_disp_destroy_layers(struct zynqmp_disp *disp)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < ARRAY_SIZE(disp->layers); i++)\n\t\tzynqmp_disp_layer_release_dma(disp, &disp->layers[i]);\n}\n\n \nstatic int zynqmp_disp_layer_request_dma(struct zynqmp_disp *disp,\n\t\t\t\t\t struct zynqmp_disp_layer *layer)\n{\n\tstatic const char * const dma_names[] = { \"vid\", \"gfx\" };\n\tunsigned int i;\n\tint ret;\n\n\tif (!disp->dpsub->dma_enabled)\n\t\treturn 0;\n\n\tfor (i = 0; i < layer->info->num_channels; i++) {\n\t\tstruct zynqmp_disp_layer_dma *dma = &layer->dmas[i];\n\t\tchar dma_channel_name[16];\n\n\t\tsnprintf(dma_channel_name, sizeof(dma_channel_name),\n\t\t\t \"%s%u\", dma_names[layer->id], i);\n\t\tdma->chan = dma_request_chan(disp->dev, dma_channel_name);\n\t\tif (IS_ERR(dma->chan)) {\n\t\t\tret = dev_err_probe(disp->dev, PTR_ERR(dma->chan),\n\t\t\t\t\t    \"failed to request dma channel\\n\");\n\t\t\tdma->chan = NULL;\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n \nstatic int zynqmp_disp_create_layers(struct zynqmp_disp *disp)\n{\n\tstatic const struct zynqmp_disp_layer_info layer_info[] = {\n\t\t[ZYNQMP_DPSUB_LAYER_VID] = {\n\t\t\t.formats = avbuf_vid_fmts,\n\t\t\t.num_formats = ARRAY_SIZE(avbuf_vid_fmts),\n\t\t\t.num_channels = 3,\n\t\t},\n\t\t[ZYNQMP_DPSUB_LAYER_GFX] = {\n\t\t\t.formats = avbuf_gfx_fmts,\n\t\t\t.num_formats = ARRAY_SIZE(avbuf_gfx_fmts),\n\t\t\t.num_channels = 1,\n\t\t},\n\t};\n\n\tunsigned int i;\n\tint ret;\n\n\tfor (i = 0; i < ARRAY_SIZE(disp->layers); i++) {\n\t\tstruct zynqmp_disp_layer *layer = &disp->layers[i];\n\n\t\tlayer->id = i;\n\t\tlayer->disp = disp;\n\t\tlayer->info = &layer_info[i];\n\n\t\tret = zynqmp_disp_layer_request_dma(disp, layer);\n\t\tif (ret)\n\t\t\tgoto err;\n\n\t\tdisp->dpsub->layers[i] = layer;\n\t}\n\n\treturn 0;\n\nerr:\n\tzynqmp_disp_destroy_layers(disp);\n\treturn ret;\n}\n\n \n\n \nvoid zynqmp_disp_enable(struct zynqmp_disp *disp)\n{\n\tzynqmp_disp_blend_set_output_format(disp, ZYNQMP_DPSUB_FORMAT_RGB);\n\tzynqmp_disp_blend_set_bg_color(disp, 0, 0, 0);\n\n\tzynqmp_disp_avbuf_enable(disp);\n\t \n\tzynqmp_disp_avbuf_set_clocks_sources(disp, disp->dpsub->vid_clk_from_ps,\n\t\t\t\t\t     disp->dpsub->aud_clk_from_ps,\n\t\t\t\t\t     true);\n\tzynqmp_disp_avbuf_enable_channels(disp);\n\tzynqmp_disp_avbuf_enable_audio(disp);\n\n\tzynqmp_disp_audio_enable(disp);\n}\n\n \nvoid zynqmp_disp_disable(struct zynqmp_disp *disp)\n{\n\tzynqmp_disp_audio_disable(disp);\n\n\tzynqmp_disp_avbuf_disable_audio(disp);\n\tzynqmp_disp_avbuf_disable_channels(disp);\n\tzynqmp_disp_avbuf_disable(disp);\n}\n\n \nint zynqmp_disp_setup_clock(struct zynqmp_disp *disp,\n\t\t\t    unsigned long mode_clock)\n{\n\tunsigned long rate;\n\tlong diff;\n\tint ret;\n\n\tret = clk_set_rate(disp->dpsub->vid_clk, mode_clock);\n\tif (ret) {\n\t\tdev_err(disp->dev, \"failed to set the video clock\\n\");\n\t\treturn ret;\n\t}\n\n\trate = clk_get_rate(disp->dpsub->vid_clk);\n\tdiff = rate - mode_clock;\n\tif (abs(diff) > mode_clock / 20)\n\t\tdev_info(disp->dev,\n\t\t\t \"requested pixel rate: %lu actual rate: %lu\\n\",\n\t\t\t mode_clock, rate);\n\telse\n\t\tdev_dbg(disp->dev,\n\t\t\t\"requested pixel rate: %lu actual rate: %lu\\n\",\n\t\t\tmode_clock, rate);\n\n\treturn 0;\n}\n\n \n\nint zynqmp_disp_probe(struct zynqmp_dpsub *dpsub)\n{\n\tstruct platform_device *pdev = to_platform_device(dpsub->dev);\n\tstruct zynqmp_disp *disp;\n\tint ret;\n\n\tdisp = kzalloc(sizeof(*disp), GFP_KERNEL);\n\tif (!disp)\n\t\treturn -ENOMEM;\n\n\tdisp->dev = &pdev->dev;\n\tdisp->dpsub = dpsub;\n\n\tdisp->blend.base = devm_platform_ioremap_resource_byname(pdev, \"blend\");\n\tif (IS_ERR(disp->blend.base)) {\n\t\tret = PTR_ERR(disp->blend.base);\n\t\tgoto error;\n\t}\n\n\tdisp->avbuf.base = devm_platform_ioremap_resource_byname(pdev, \"av_buf\");\n\tif (IS_ERR(disp->avbuf.base)) {\n\t\tret = PTR_ERR(disp->avbuf.base);\n\t\tgoto error;\n\t}\n\n\tdisp->audio.base = devm_platform_ioremap_resource_byname(pdev, \"aud\");\n\tif (IS_ERR(disp->audio.base)) {\n\t\tret = PTR_ERR(disp->audio.base);\n\t\tgoto error;\n\t}\n\n\tret = zynqmp_disp_create_layers(disp);\n\tif (ret)\n\t\tgoto error;\n\n\tif (disp->dpsub->dma_enabled) {\n\t\tstruct zynqmp_disp_layer *layer;\n\n\t\tlayer = &disp->layers[ZYNQMP_DPSUB_LAYER_VID];\n\t\tdpsub->dma_align = 1 << layer->dmas[0].chan->device->copy_align;\n\t}\n\n\tdpsub->disp = disp;\n\n\treturn 0;\n\nerror:\n\tkfree(disp);\n\treturn ret;\n}\n\nvoid zynqmp_disp_remove(struct zynqmp_dpsub *dpsub)\n{\n\tstruct zynqmp_disp *disp = dpsub->disp;\n\n\tzynqmp_disp_destroy_layers(disp);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}