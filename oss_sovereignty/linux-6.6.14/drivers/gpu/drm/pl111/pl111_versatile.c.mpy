{
  "module_name": "pl111_versatile.c",
  "hash_id": "f40afaa09e1d13e617af708347c1b92a5093ad331dec0e0f1cb9beda28ba0989",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/pl111/pl111_versatile.c",
  "human_readable_source": "\n\n \n\n#include <linux/bitops.h>\n#include <linux/device.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/vexpress.h>\n\n#include <drm/drm_fourcc.h>\n\n#include \"pl111_versatile.h\"\n#include \"pl111_drm.h\"\n\nstatic struct regmap *versatile_syscon_map;\n\n \nenum versatile_clcd {\n\tINTEGRATOR_IMPD1,\n\tINTEGRATOR_CLCD_CM,\n\tVERSATILE_CLCD,\n\tREALVIEW_CLCD_EB,\n\tREALVIEW_CLCD_PB1176,\n\tREALVIEW_CLCD_PB11MP,\n\tREALVIEW_CLCD_PBA8,\n\tREALVIEW_CLCD_PBX,\n\tVEXPRESS_CLCD_V2M,\n};\n\nstatic const struct of_device_id versatile_clcd_of_match[] = {\n\t{\n\t\t.compatible = \"arm,core-module-integrator\",\n\t\t.data = (void *)INTEGRATOR_CLCD_CM,\n\t},\n\t{\n\t\t.compatible = \"arm,versatile-sysreg\",\n\t\t.data = (void *)VERSATILE_CLCD,\n\t},\n\t{\n\t\t.compatible = \"arm,realview-eb-syscon\",\n\t\t.data = (void *)REALVIEW_CLCD_EB,\n\t},\n\t{\n\t\t.compatible = \"arm,realview-pb1176-syscon\",\n\t\t.data = (void *)REALVIEW_CLCD_PB1176,\n\t},\n\t{\n\t\t.compatible = \"arm,realview-pb11mp-syscon\",\n\t\t.data = (void *)REALVIEW_CLCD_PB11MP,\n\t},\n\t{\n\t\t.compatible = \"arm,realview-pba8-syscon\",\n\t\t.data = (void *)REALVIEW_CLCD_PBA8,\n\t},\n\t{\n\t\t.compatible = \"arm,realview-pbx-syscon\",\n\t\t.data = (void *)REALVIEW_CLCD_PBX,\n\t},\n\t{\n\t\t.compatible = \"arm,vexpress-muxfpga\",\n\t\t.data = (void *)VEXPRESS_CLCD_V2M,\n\t},\n\t{},\n};\n\nstatic const struct of_device_id impd1_clcd_of_match[] = {\n\t{\n\t\t.compatible = \"arm,im-pd1-syscon\",\n\t\t.data = (void *)INTEGRATOR_IMPD1,\n\t},\n\t{},\n};\n\n \n#define INTEGRATOR_HDR_CTRL_OFFSET\t0x0C\n#define INTEGRATOR_CLCD_LCDBIASEN\tBIT(8)\n#define INTEGRATOR_CLCD_LCDBIASUP\tBIT(9)\n#define INTEGRATOR_CLCD_LCDBIASDN\tBIT(10)\n \n#define INTEGRATOR_CLCD_LCDMUX_LCD24\tBIT(11)\n#define INTEGRATOR_CLCD_LCDMUX_SHARP\t(BIT(11)|BIT(12))\n#define INTEGRATOR_CLCD_LCDMUX_VGA555\tBIT(13)\n#define INTEGRATOR_CLCD_LCDMUX_VGA24\t(BIT(11)|BIT(12)|BIT(13))\n#define INTEGRATOR_CLCD_LCD0_EN\t\tBIT(14)\n#define INTEGRATOR_CLCD_LCD1_EN\t\tBIT(15)\n \n#define INTEGRATOR_CLCD_LCD_STATIC1\tBIT(16)\n \n#define INTEGRATOR_CLCD_LCD_STATIC2\tBIT(17)\n \n#define INTEGRATOR_CLCD_LCD_STATIC\tBIT(18)\n \n#define INTEGRATOR_CLCD_LCD_N24BITEN\tBIT(19)\n\n#define INTEGRATOR_CLCD_MASK\t\tGENMASK(19, 8)\n\nstatic void pl111_integrator_enable(struct drm_device *drm, u32 format)\n{\n\tu32 val;\n\n\tdev_info(drm->dev, \"enable Integrator CLCD connectors\\n\");\n\n\t \n\tval = INTEGRATOR_CLCD_LCD_STATIC1 | INTEGRATOR_CLCD_LCD_STATIC2 |\n\t\tINTEGRATOR_CLCD_LCD0_EN | INTEGRATOR_CLCD_LCD1_EN;\n\n\tswitch (format) {\n\tcase DRM_FORMAT_XBGR8888:\n\tcase DRM_FORMAT_XRGB8888:\n\t\t \n\t\tval |= INTEGRATOR_CLCD_LCDMUX_VGA24;\n\t\tbreak;\n\tcase DRM_FORMAT_XBGR1555:\n\tcase DRM_FORMAT_XRGB1555:\n\t\t \n\t\tval |= INTEGRATOR_CLCD_LCDMUX_VGA555;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(drm->dev, \"unhandled format on Integrator 0x%08x\\n\",\n\t\t\tformat);\n\t\tbreak;\n\t}\n\n\tregmap_update_bits(versatile_syscon_map,\n\t\t\t   INTEGRATOR_HDR_CTRL_OFFSET,\n\t\t\t   INTEGRATOR_CLCD_MASK,\n\t\t\t   val);\n}\n\n#define IMPD1_CTRL_OFFSET\t0x18\n#define IMPD1_CTRL_DISP_LCD\t(0 << 0)\n#define IMPD1_CTRL_DISP_VGA\t(1 << 0)\n#define IMPD1_CTRL_DISP_LCD1\t(2 << 0)\n#define IMPD1_CTRL_DISP_ENABLE\t(1 << 2)\n#define IMPD1_CTRL_DISP_MASK\t(7 << 0)\n\nstatic void pl111_impd1_enable(struct drm_device *drm, u32 format)\n{\n\tu32 val;\n\n\tdev_info(drm->dev, \"enable IM-PD1 CLCD connectors\\n\");\n\tval = IMPD1_CTRL_DISP_VGA | IMPD1_CTRL_DISP_ENABLE;\n\n\tregmap_update_bits(versatile_syscon_map,\n\t\t\t   IMPD1_CTRL_OFFSET,\n\t\t\t   IMPD1_CTRL_DISP_MASK,\n\t\t\t   val);\n}\n\nstatic void pl111_impd1_disable(struct drm_device *drm)\n{\n\tdev_info(drm->dev, \"disable IM-PD1 CLCD connectors\\n\");\n\n\tregmap_update_bits(versatile_syscon_map,\n\t\t\t   IMPD1_CTRL_OFFSET,\n\t\t\t   IMPD1_CTRL_DISP_MASK,\n\t\t\t   0);\n}\n\n \n#define SYS_CLCD\t\t\t0x50\n#define SYS_CLCD_MODE_MASK\t\t(BIT(0)|BIT(1))\n#define SYS_CLCD_MODE_888\t\t0\n#define SYS_CLCD_MODE_5551\t\tBIT(0)\n#define SYS_CLCD_MODE_565_R_LSB\t\tBIT(1)\n#define SYS_CLCD_MODE_565_B_LSB\t\t(BIT(0)|BIT(1))\n#define SYS_CLCD_CONNECTOR_MASK\t\t(BIT(2)|BIT(3)|BIT(4)|BIT(5))\n#define SYS_CLCD_NLCDIOON\t\tBIT(2)\n#define SYS_CLCD_VDDPOSSWITCH\t\tBIT(3)\n#define SYS_CLCD_PWR3V5SWITCH\t\tBIT(4)\n#define SYS_CLCD_VDDNEGSWITCH\t\tBIT(5)\n\nstatic void pl111_versatile_disable(struct drm_device *drm)\n{\n\tdev_info(drm->dev, \"disable Versatile CLCD connectors\\n\");\n\tregmap_update_bits(versatile_syscon_map,\n\t\t\t   SYS_CLCD,\n\t\t\t   SYS_CLCD_CONNECTOR_MASK,\n\t\t\t   0);\n}\n\nstatic void pl111_versatile_enable(struct drm_device *drm, u32 format)\n{\n\tu32 val = 0;\n\n\tdev_info(drm->dev, \"enable Versatile CLCD connectors\\n\");\n\n\tswitch (format) {\n\tcase DRM_FORMAT_ABGR8888:\n\tcase DRM_FORMAT_XBGR8888:\n\tcase DRM_FORMAT_ARGB8888:\n\tcase DRM_FORMAT_XRGB8888:\n\t\tval |= SYS_CLCD_MODE_888;\n\t\tbreak;\n\tcase DRM_FORMAT_BGR565:\n\t\tval |= SYS_CLCD_MODE_565_R_LSB;\n\t\tbreak;\n\tcase DRM_FORMAT_RGB565:\n\t\tval |= SYS_CLCD_MODE_565_B_LSB;\n\t\tbreak;\n\tcase DRM_FORMAT_ABGR1555:\n\tcase DRM_FORMAT_XBGR1555:\n\tcase DRM_FORMAT_ARGB1555:\n\tcase DRM_FORMAT_XRGB1555:\n\t\tval |= SYS_CLCD_MODE_5551;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(drm->dev, \"unhandled format on Versatile 0x%08x\\n\",\n\t\t\tformat);\n\t\tbreak;\n\t}\n\n\t \n\tregmap_update_bits(versatile_syscon_map,\n\t\t\t   SYS_CLCD,\n\t\t\t   SYS_CLCD_MODE_MASK,\n\t\t\t   val);\n\n\t \n\tregmap_update_bits(versatile_syscon_map,\n\t\t\t   SYS_CLCD,\n\t\t\t   SYS_CLCD_CONNECTOR_MASK,\n\t\t\t   SYS_CLCD_NLCDIOON | SYS_CLCD_PWR3V5SWITCH);\n}\n\nstatic void pl111_realview_clcd_disable(struct drm_device *drm)\n{\n\tdev_info(drm->dev, \"disable RealView CLCD connectors\\n\");\n\tregmap_update_bits(versatile_syscon_map,\n\t\t\t   SYS_CLCD,\n\t\t\t   SYS_CLCD_CONNECTOR_MASK,\n\t\t\t   0);\n}\n\nstatic void pl111_realview_clcd_enable(struct drm_device *drm, u32 format)\n{\n\tdev_info(drm->dev, \"enable RealView CLCD connectors\\n\");\n\tregmap_update_bits(versatile_syscon_map,\n\t\t\t   SYS_CLCD,\n\t\t\t   SYS_CLCD_CONNECTOR_MASK,\n\t\t\t   SYS_CLCD_NLCDIOON | SYS_CLCD_PWR3V5SWITCH);\n}\n\n \nstatic const u32 pl110_integrator_pixel_formats[] = {\n\tDRM_FORMAT_ABGR8888,\n\tDRM_FORMAT_XBGR8888,\n\tDRM_FORMAT_ARGB8888,\n\tDRM_FORMAT_XRGB8888,\n\tDRM_FORMAT_ABGR1555,\n\tDRM_FORMAT_XBGR1555,\n\tDRM_FORMAT_ARGB1555,\n\tDRM_FORMAT_XRGB1555,\n};\n\n \nstatic const u32 pl110_versatile_pixel_formats[] = {\n\tDRM_FORMAT_ABGR8888,\n\tDRM_FORMAT_XBGR8888,\n\tDRM_FORMAT_ARGB8888,\n\tDRM_FORMAT_XRGB8888,\n\tDRM_FORMAT_BGR565,  \n\tDRM_FORMAT_RGB565,  \n\tDRM_FORMAT_ABGR1555,\n\tDRM_FORMAT_XBGR1555,\n\tDRM_FORMAT_ARGB1555,\n\tDRM_FORMAT_XRGB1555,\n};\n\nstatic const u32 pl111_realview_pixel_formats[] = {\n\tDRM_FORMAT_ABGR8888,\n\tDRM_FORMAT_XBGR8888,\n\tDRM_FORMAT_ARGB8888,\n\tDRM_FORMAT_XRGB8888,\n\tDRM_FORMAT_BGR565,\n\tDRM_FORMAT_RGB565,\n\tDRM_FORMAT_ABGR1555,\n\tDRM_FORMAT_XBGR1555,\n\tDRM_FORMAT_ARGB1555,\n\tDRM_FORMAT_XRGB1555,\n\tDRM_FORMAT_ABGR4444,\n\tDRM_FORMAT_XBGR4444,\n\tDRM_FORMAT_ARGB4444,\n\tDRM_FORMAT_XRGB4444,\n};\n\n \nstatic const struct pl111_variant_data pl110_integrator = {\n\t.name = \"PL110 Integrator\",\n\t.is_pl110 = true,\n\t.broken_clockdivider = true,\n\t.broken_vblank = true,\n\t.formats = pl110_integrator_pixel_formats,\n\t.nformats = ARRAY_SIZE(pl110_integrator_pixel_formats),\n\t.fb_depth = 16,\n};\n\n \nstatic const struct pl111_variant_data pl110_impd1 = {\n\t.name = \"PL110 IM-PD1\",\n\t.is_pl110 = true,\n\t.broken_clockdivider = true,\n\t.broken_vblank = true,\n\t.formats = pl110_integrator_pixel_formats,\n\t.nformats = ARRAY_SIZE(pl110_integrator_pixel_formats),\n\t.fb_depth = 15,\n};\n\n \nstatic const struct pl111_variant_data pl110_versatile = {\n\t.name = \"PL110 Versatile\",\n\t.is_pl110 = true,\n\t.external_bgr = true,\n\t.formats = pl110_versatile_pixel_formats,\n\t.nformats = ARRAY_SIZE(pl110_versatile_pixel_formats),\n\t.fb_depth = 16,\n};\n\n \nstatic const struct pl111_variant_data pl111_realview = {\n\t.name = \"PL111 RealView\",\n\t.formats = pl111_realview_pixel_formats,\n\t.nformats = ARRAY_SIZE(pl111_realview_pixel_formats),\n\t.fb_depth = 16,\n};\n\n \nstatic const struct pl111_variant_data pl111_vexpress = {\n\t.name = \"PL111 Versatile Express\",\n\t.formats = pl111_realview_pixel_formats,\n\t.nformats = ARRAY_SIZE(pl111_realview_pixel_formats),\n\t.fb_depth = 16,\n\t.broken_clockdivider = true,\n};\n\n#define VEXPRESS_FPGAMUX_MOTHERBOARD\t\t0x00\n#define VEXPRESS_FPGAMUX_DAUGHTERBOARD_1\t0x01\n#define VEXPRESS_FPGAMUX_DAUGHTERBOARD_2\t0x02\n\nstatic int pl111_vexpress_clcd_init(struct device *dev, struct device_node *np,\n\t\t\t\t    struct pl111_drm_dev_private *priv)\n{\n\tstruct platform_device *pdev;\n\tstruct device_node *root;\n\tstruct device_node *child;\n\tstruct device_node *ct_clcd = NULL;\n\tstruct regmap *map;\n\tbool has_coretile_clcd = false;\n\tbool has_coretile_hdlcd = false;\n\tbool mux_motherboard = true;\n\tu32 val;\n\tint ret;\n\n\tif (!IS_ENABLED(CONFIG_VEXPRESS_CONFIG))\n\t\treturn -ENODEV;\n\n\t \n\troot = of_find_node_by_path(\"/\");\n\tif (!root)\n\t\treturn -EINVAL;\n\n\tfor_each_available_child_of_node(root, child) {\n\t\tif (of_device_is_compatible(child, \"arm,pl111\")) {\n\t\t\thas_coretile_clcd = true;\n\t\t\tct_clcd = child;\n\t\t\tof_node_put(child);\n\t\t\tbreak;\n\t\t}\n\t\tif (of_device_is_compatible(child, \"arm,hdlcd\")) {\n\t\t\thas_coretile_hdlcd = true;\n\t\t\tof_node_put(child);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tof_node_put(root);\n\n\t \n\tif (has_coretile_hdlcd && IS_ENABLED(CONFIG_DRM_HDLCD))\n\t\tmux_motherboard = false;\n\n\t \n\tif (has_coretile_clcd)\n\t\tmux_motherboard = false;\n\n\tif (mux_motherboard) {\n\t\tdev_info(dev, \"DVI muxed to motherboard CLCD\\n\");\n\t\tval = VEXPRESS_FPGAMUX_MOTHERBOARD;\n\t} else if (ct_clcd == dev->of_node) {\n\t\tdev_info(dev,\n\t\t\t \"DVI muxed to daughterboard 1 (core tile) CLCD\\n\");\n\t\tval = VEXPRESS_FPGAMUX_DAUGHTERBOARD_1;\n\t} else {\n\t\tdev_info(dev, \"core tile graphics present\\n\");\n\t\tdev_info(dev, \"this device will be deactivated\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tpdev = of_find_device_by_node(np);\n\tif (!pdev) {\n\t\tdev_err(dev, \"can't find the sysreg device, deferring\\n\");\n\t\treturn -EPROBE_DEFER;\n\t}\n\n\tmap = devm_regmap_init_vexpress_config(&pdev->dev);\n\tif (IS_ERR(map)) {\n\t\tplatform_device_put(pdev);\n\t\treturn PTR_ERR(map);\n\t}\n\n\tret = regmap_write(map, 0, val);\n\tplatform_device_put(pdev);\n\tif (ret) {\n\t\tdev_err(dev, \"error setting DVI muxmode\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tpriv->variant = &pl111_vexpress;\n\tdev_info(dev, \"initializing Versatile Express PL111\\n\");\n\n\treturn 0;\n}\n\nint pl111_versatile_init(struct device *dev, struct pl111_drm_dev_private *priv)\n{\n\tconst struct of_device_id *clcd_id;\n\tenum versatile_clcd versatile_clcd_type;\n\tstruct device_node *np;\n\tstruct regmap *map;\n\n\tnp = of_find_matching_node_and_match(NULL, versatile_clcd_of_match,\n\t\t\t\t\t     &clcd_id);\n\tif (!np) {\n\t\t \n\t\treturn 0;\n\t}\n\n\tversatile_clcd_type = (enum versatile_clcd)clcd_id->data;\n\n\t \n\tif (versatile_clcd_type == VEXPRESS_CLCD_V2M) {\n\t\tint ret = pl111_vexpress_clcd_init(dev, np, priv);\n\t\tof_node_put(np);\n\t\tif (ret)\n\t\t\tdev_err(dev, \"Versatile Express init failed - %d\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\t if (versatile_clcd_type == INTEGRATOR_CLCD_CM) {\n\t\tnp = of_find_matching_node_and_match(NULL, impd1_clcd_of_match,\n\t\t\t\t\t\t     &clcd_id);\n\t\tif (np)\n\t\t\tversatile_clcd_type = (enum versatile_clcd)clcd_id->data;\n\t}\n\n\tmap = syscon_node_to_regmap(np);\n\tof_node_put(np);\n\tif (IS_ERR(map)) {\n\t\tdev_err(dev, \"no Versatile syscon regmap\\n\");\n\t\treturn PTR_ERR(map);\n\t}\n\n\tswitch (versatile_clcd_type) {\n\tcase INTEGRATOR_CLCD_CM:\n\t\tversatile_syscon_map = map;\n\t\tpriv->variant = &pl110_integrator;\n\t\tpriv->variant_display_enable = pl111_integrator_enable;\n\t\tdev_info(dev, \"set up callbacks for Integrator PL110\\n\");\n\t\tbreak;\n\tcase INTEGRATOR_IMPD1:\n\t\tversatile_syscon_map = map;\n\t\tpriv->variant = &pl110_impd1;\n\t\tpriv->variant_display_enable = pl111_impd1_enable;\n\t\tpriv->variant_display_disable = pl111_impd1_disable;\n\t\tdev_info(dev, \"set up callbacks for IM-PD1 PL110\\n\");\n\t\tbreak;\n\tcase VERSATILE_CLCD:\n\t\tversatile_syscon_map = map;\n\t\t \n\t\tpriv->variant = &pl110_versatile;\n\t\tpriv->variant_display_enable = pl111_versatile_enable;\n\t\tpriv->variant_display_disable = pl111_versatile_disable;\n\t\t \n\t\tpriv->ienb = CLCD_PL111_IENB;\n\t\tpriv->ctrl = CLCD_PL111_CNTL;\n\t\tdev_info(dev, \"set up callbacks for Versatile PL110\\n\");\n\t\tbreak;\n\tcase REALVIEW_CLCD_EB:\n\tcase REALVIEW_CLCD_PB1176:\n\tcase REALVIEW_CLCD_PB11MP:\n\tcase REALVIEW_CLCD_PBA8:\n\tcase REALVIEW_CLCD_PBX:\n\t\tversatile_syscon_map = map;\n\t\tpriv->variant = &pl111_realview;\n\t\tpriv->variant_display_enable = pl111_realview_clcd_enable;\n\t\tpriv->variant_display_disable = pl111_realview_clcd_disable;\n\t\tdev_info(dev, \"set up callbacks for RealView PL111\\n\");\n\t\tbreak;\n\tdefault:\n\t\tdev_info(dev, \"unknown Versatile system controller\\n\");\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(pl111_versatile_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}