{
  "module_name": "rcar_cmm.c",
  "hash_id": "63fc134d55e770c2a223045cc41ff6fbbeefc9aa07ceea7b143796b964fa7530",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/renesas/rcar-du/rcar_cmm.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n\n#include <drm/drm_color_mgmt.h>\n\n#include \"rcar_cmm.h\"\n\n#define CM2_LUT_CTRL\t\t0x0000\n#define CM2_LUT_CTRL_LUT_EN\tBIT(0)\n#define CM2_LUT_TBL_BASE\t0x0600\n#define CM2_LUT_TBL(__i)\t(CM2_LUT_TBL_BASE + (__i) * 4)\n\nstruct rcar_cmm {\n\tvoid __iomem *base;\n\n\t \n\tstruct {\n\t\tbool enabled;\n\t} lut;\n};\n\nstatic inline int rcar_cmm_read(struct rcar_cmm *rcmm, u32 reg)\n{\n\treturn ioread32(rcmm->base + reg);\n}\n\nstatic inline void rcar_cmm_write(struct rcar_cmm *rcmm, u32 reg, u32 data)\n{\n\tiowrite32(data, rcmm->base + reg);\n}\n\n \nstatic void rcar_cmm_lut_write(struct rcar_cmm *rcmm,\n\t\t\t       const struct drm_color_lut *drm_lut)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < CM2_LUT_SIZE; ++i) {\n\t\tu32 entry = drm_color_lut_extract(drm_lut[i].red, 8) << 16\n\t\t\t  | drm_color_lut_extract(drm_lut[i].green, 8) << 8\n\t\t\t  | drm_color_lut_extract(drm_lut[i].blue, 8);\n\n\t\trcar_cmm_write(rcmm, CM2_LUT_TBL(i), entry);\n\t}\n}\n\n \nint rcar_cmm_setup(struct platform_device *pdev,\n\t\t   const struct rcar_cmm_config *config)\n{\n\tstruct rcar_cmm *rcmm = platform_get_drvdata(pdev);\n\n\t \n\tif (!config->lut.table) {\n\t\tif (rcmm->lut.enabled) {\n\t\t\trcar_cmm_write(rcmm, CM2_LUT_CTRL, 0);\n\t\t\trcmm->lut.enabled = false;\n\t\t}\n\n\t\treturn 0;\n\t}\n\n\t \n\tif (!rcmm->lut.enabled) {\n\t\trcar_cmm_write(rcmm, CM2_LUT_CTRL, CM2_LUT_CTRL_LUT_EN);\n\t\trcmm->lut.enabled = true;\n\t}\n\n\trcar_cmm_lut_write(rcmm, config->lut.table);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rcar_cmm_setup);\n\n \nint rcar_cmm_enable(struct platform_device *pdev)\n{\n\tint ret;\n\n\tret = pm_runtime_resume_and_get(&pdev->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rcar_cmm_enable);\n\n \nvoid rcar_cmm_disable(struct platform_device *pdev)\n{\n\tstruct rcar_cmm *rcmm = platform_get_drvdata(pdev);\n\n\trcar_cmm_write(rcmm, CM2_LUT_CTRL, 0);\n\trcmm->lut.enabled = false;\n\n\tpm_runtime_put(&pdev->dev);\n}\nEXPORT_SYMBOL_GPL(rcar_cmm_disable);\n\n \nint rcar_cmm_init(struct platform_device *pdev)\n{\n\tstruct rcar_cmm *rcmm = platform_get_drvdata(pdev);\n\n\tif (!rcmm)\n\t\treturn -EPROBE_DEFER;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rcar_cmm_init);\n\nstatic int rcar_cmm_probe(struct platform_device *pdev)\n{\n\tstruct rcar_cmm *rcmm;\n\n\trcmm = devm_kzalloc(&pdev->dev, sizeof(*rcmm), GFP_KERNEL);\n\tif (!rcmm)\n\t\treturn -ENOMEM;\n\tplatform_set_drvdata(pdev, rcmm);\n\n\trcmm->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(rcmm->base))\n\t\treturn PTR_ERR(rcmm->base);\n\n\tpm_runtime_enable(&pdev->dev);\n\n\treturn 0;\n}\n\nstatic void rcar_cmm_remove(struct platform_device *pdev)\n{\n\tpm_runtime_disable(&pdev->dev);\n}\n\nstatic const struct of_device_id rcar_cmm_of_table[] = {\n\t{ .compatible = \"renesas,rcar-gen3-cmm\", },\n\t{ .compatible = \"renesas,rcar-gen2-cmm\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, rcar_cmm_of_table);\n\nstatic struct platform_driver rcar_cmm_platform_driver = {\n\t.probe\t\t= rcar_cmm_probe,\n\t.remove_new\t= rcar_cmm_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"rcar-cmm\",\n\t\t.of_match_table = rcar_cmm_of_table,\n\t},\n};\n\nmodule_platform_driver(rcar_cmm_platform_driver);\n\nMODULE_AUTHOR(\"Jacopo Mondi <jacopo+renesas@jmondi.org>\");\nMODULE_DESCRIPTION(\"Renesas R-Car CMM Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}