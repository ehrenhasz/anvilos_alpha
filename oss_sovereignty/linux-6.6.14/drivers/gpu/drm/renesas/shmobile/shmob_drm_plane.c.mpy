{
  "module_name": "shmob_drm_plane.c",
  "hash_id": "5810460b0fdf2554b7d1256178ec2174b84ebb38b4d6fc2b0c44142f980ef386",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/renesas/shmobile/shmob_drm_plane.c",
  "human_readable_source": "\n \n\n#include <drm/drm_crtc.h>\n#include <drm/drm_fb_dma_helper.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem_dma_helper.h>\n\n#include \"shmob_drm_drv.h\"\n#include \"shmob_drm_kms.h\"\n#include \"shmob_drm_plane.h\"\n#include \"shmob_drm_regs.h\"\n\nstruct shmob_drm_plane {\n\tstruct drm_plane plane;\n\tunsigned int index;\n\tunsigned int alpha;\n\n\tconst struct shmob_drm_format_info *format;\n\tunsigned long dma[2];\n\n\tunsigned int src_x;\n\tunsigned int src_y;\n\tunsigned int crtc_x;\n\tunsigned int crtc_y;\n\tunsigned int crtc_w;\n\tunsigned int crtc_h;\n};\n\n#define to_shmob_plane(p)\tcontainer_of(p, struct shmob_drm_plane, plane)\n\nstatic void shmob_drm_plane_compute_base(struct shmob_drm_plane *splane,\n\t\t\t\t\t struct drm_framebuffer *fb,\n\t\t\t\t\t int x, int y)\n{\n\tstruct drm_gem_dma_object *gem;\n\tunsigned int bpp;\n\n\tbpp = splane->format->yuv ? 8 : splane->format->bpp;\n\tgem = drm_fb_dma_get_gem_obj(fb, 0);\n\tsplane->dma[0] = gem->dma_addr + fb->offsets[0]\n\t\t       + y * fb->pitches[0] + x * bpp / 8;\n\n\tif (splane->format->yuv) {\n\t\tbpp = splane->format->bpp - 8;\n\t\tgem = drm_fb_dma_get_gem_obj(fb, 1);\n\t\tsplane->dma[1] = gem->dma_addr + fb->offsets[1]\n\t\t\t       + y / (bpp == 4 ? 2 : 1) * fb->pitches[1]\n\t\t\t       + x * (bpp == 16 ? 2 : 1);\n\t}\n}\n\nstatic void __shmob_drm_plane_setup(struct shmob_drm_plane *splane,\n\t\t\t\t    struct drm_framebuffer *fb)\n{\n\tstruct shmob_drm_device *sdev = splane->plane.dev->dev_private;\n\tu32 format;\n\n\t \n\tformat = LDBBSIFR_EN | (splane->alpha << LDBBSIFR_LAY_SHIFT);\n\n\tswitch (splane->format->fourcc) {\n\tcase DRM_FORMAT_RGB565:\n\tcase DRM_FORMAT_NV21:\n\tcase DRM_FORMAT_NV61:\n\tcase DRM_FORMAT_NV42:\n\t\tformat |= LDBBSIFR_SWPL | LDBBSIFR_SWPW;\n\t\tbreak;\n\tcase DRM_FORMAT_RGB888:\n\tcase DRM_FORMAT_NV12:\n\tcase DRM_FORMAT_NV16:\n\tcase DRM_FORMAT_NV24:\n\t\tformat |= LDBBSIFR_SWPL | LDBBSIFR_SWPW | LDBBSIFR_SWPB;\n\t\tbreak;\n\tcase DRM_FORMAT_ARGB8888:\n\tcase DRM_FORMAT_XRGB8888:\n\tdefault:\n\t\tformat |= LDBBSIFR_SWPL;\n\t\tbreak;\n\t}\n\n\tswitch (splane->format->fourcc) {\n\tcase DRM_FORMAT_RGB565:\n\t\tformat |= LDBBSIFR_AL_1 | LDBBSIFR_RY | LDBBSIFR_RPKF_RGB16;\n\t\tbreak;\n\tcase DRM_FORMAT_RGB888:\n\t\tformat |= LDBBSIFR_AL_1 | LDBBSIFR_RY | LDBBSIFR_RPKF_RGB24;\n\t\tbreak;\n\tcase DRM_FORMAT_ARGB8888:\n\t\tformat |= LDBBSIFR_AL_PK | LDBBSIFR_RY | LDDFR_PKF_ARGB32;\n\t\tbreak;\n\tcase DRM_FORMAT_XRGB8888:\n\t\tformat |= LDBBSIFR_AL_1 | LDBBSIFR_RY | LDDFR_PKF_ARGB32;\n\t\tbreak;\n\tcase DRM_FORMAT_NV12:\n\tcase DRM_FORMAT_NV21:\n\t\tformat |= LDBBSIFR_AL_1 | LDBBSIFR_CHRR_420;\n\t\tbreak;\n\tcase DRM_FORMAT_NV16:\n\tcase DRM_FORMAT_NV61:\n\t\tformat |= LDBBSIFR_AL_1 | LDBBSIFR_CHRR_422;\n\t\tbreak;\n\tcase DRM_FORMAT_NV24:\n\tcase DRM_FORMAT_NV42:\n\t\tformat |= LDBBSIFR_AL_1 | LDBBSIFR_CHRR_444;\n\t\tbreak;\n\t}\n\n#define plane_reg_dump(sdev, splane, reg) \\\n\tdev_dbg(sdev->ddev->dev, \"%s(%u): %s 0x%08x 0x%08x\\n\", __func__, \\\n\t\tsplane->index, #reg, \\\n\t\tlcdc_read(sdev, reg(splane->index)), \\\n\t\tlcdc_read(sdev, reg(splane->index) + LCDC_SIDE_B_OFFSET))\n\n\tplane_reg_dump(sdev, splane, LDBnBSIFR);\n\tplane_reg_dump(sdev, splane, LDBnBSSZR);\n\tplane_reg_dump(sdev, splane, LDBnBLOCR);\n\tplane_reg_dump(sdev, splane, LDBnBSMWR);\n\tplane_reg_dump(sdev, splane, LDBnBSAYR);\n\tplane_reg_dump(sdev, splane, LDBnBSACR);\n\n\tlcdc_write(sdev, LDBCR, LDBCR_UPC(splane->index));\n\tdev_dbg(sdev->ddev->dev, \"%s(%u): %s 0x%08x\\n\", __func__, splane->index,\n\t\t\"LDBCR\", lcdc_read(sdev, LDBCR));\n\n\tlcdc_write(sdev, LDBnBSIFR(splane->index), format);\n\n\tlcdc_write(sdev, LDBnBSSZR(splane->index),\n\t\t   (splane->crtc_h << LDBBSSZR_BVSS_SHIFT) |\n\t\t   (splane->crtc_w << LDBBSSZR_BHSS_SHIFT));\n\tlcdc_write(sdev, LDBnBLOCR(splane->index),\n\t\t   (splane->crtc_y << LDBBLOCR_CVLC_SHIFT) |\n\t\t   (splane->crtc_x << LDBBLOCR_CHLC_SHIFT));\n\tlcdc_write(sdev, LDBnBSMWR(splane->index),\n\t\t   fb->pitches[0] << LDBBSMWR_BSMW_SHIFT);\n\n\tshmob_drm_plane_compute_base(splane, fb, splane->src_x, splane->src_y);\n\n\tlcdc_write(sdev, LDBnBSAYR(splane->index), splane->dma[0]);\n\tif (splane->format->yuv)\n\t\tlcdc_write(sdev, LDBnBSACR(splane->index), splane->dma[1]);\n\n\tlcdc_write(sdev, LDBCR,\n\t\t   LDBCR_UPF(splane->index) | LDBCR_UPD(splane->index));\n\tdev_dbg(sdev->ddev->dev, \"%s(%u): %s 0x%08x\\n\", __func__, splane->index,\n\t\t\"LDBCR\", lcdc_read(sdev, LDBCR));\n\n\tplane_reg_dump(sdev, splane, LDBnBSIFR);\n\tplane_reg_dump(sdev, splane, LDBnBSSZR);\n\tplane_reg_dump(sdev, splane, LDBnBLOCR);\n\tplane_reg_dump(sdev, splane, LDBnBSMWR);\n\tplane_reg_dump(sdev, splane, LDBnBSAYR);\n\tplane_reg_dump(sdev, splane, LDBnBSACR);\n}\n\nvoid shmob_drm_plane_setup(struct drm_plane *plane)\n{\n\tstruct shmob_drm_plane *splane = to_shmob_plane(plane);\n\n\tif (plane->fb == NULL)\n\t\treturn;\n\n\t__shmob_drm_plane_setup(splane, plane->fb);\n}\n\nstatic int\nshmob_drm_plane_update(struct drm_plane *plane, struct drm_crtc *crtc,\n\t\t       struct drm_framebuffer *fb, int crtc_x, int crtc_y,\n\t\t       unsigned int crtc_w, unsigned int crtc_h,\n\t\t       uint32_t src_x, uint32_t src_y,\n\t\t       uint32_t src_w, uint32_t src_h,\n\t\t       struct drm_modeset_acquire_ctx *ctx)\n{\n\tstruct shmob_drm_plane *splane = to_shmob_plane(plane);\n\tstruct shmob_drm_device *sdev = plane->dev->dev_private;\n\tconst struct shmob_drm_format_info *format;\n\n\tformat = shmob_drm_format_info(fb->format->format);\n\tif (format == NULL) {\n\t\tdev_dbg(sdev->dev, \"update_plane: unsupported format %08x\\n\",\n\t\t\tfb->format->format);\n\t\treturn -EINVAL;\n\t}\n\n\tif (src_w >> 16 != crtc_w || src_h >> 16 != crtc_h) {\n\t\tdev_dbg(sdev->dev, \"%s: scaling not supported\\n\", __func__);\n\t\treturn -EINVAL;\n\t}\n\n\tsplane->format = format;\n\n\tsplane->src_x = src_x >> 16;\n\tsplane->src_y = src_y >> 16;\n\tsplane->crtc_x = crtc_x;\n\tsplane->crtc_y = crtc_y;\n\tsplane->crtc_w = crtc_w;\n\tsplane->crtc_h = crtc_h;\n\n\t__shmob_drm_plane_setup(splane, fb);\n\treturn 0;\n}\n\nstatic int shmob_drm_plane_disable(struct drm_plane *plane,\n\t\t\t\t   struct drm_modeset_acquire_ctx *ctx)\n{\n\tstruct shmob_drm_plane *splane = to_shmob_plane(plane);\n\tstruct shmob_drm_device *sdev = plane->dev->dev_private;\n\n\tsplane->format = NULL;\n\n\tlcdc_write(sdev, LDBnBSIFR(splane->index), 0);\n\treturn 0;\n}\n\nstatic void shmob_drm_plane_destroy(struct drm_plane *plane)\n{\n\tdrm_plane_force_disable(plane);\n\tdrm_plane_cleanup(plane);\n}\n\nstatic const struct drm_plane_funcs shmob_drm_plane_funcs = {\n\t.update_plane = shmob_drm_plane_update,\n\t.disable_plane = shmob_drm_plane_disable,\n\t.destroy = shmob_drm_plane_destroy,\n};\n\nstatic const uint32_t formats[] = {\n\tDRM_FORMAT_RGB565,\n\tDRM_FORMAT_RGB888,\n\tDRM_FORMAT_ARGB8888,\n\tDRM_FORMAT_XRGB8888,\n\tDRM_FORMAT_NV12,\n\tDRM_FORMAT_NV21,\n\tDRM_FORMAT_NV16,\n\tDRM_FORMAT_NV61,\n\tDRM_FORMAT_NV24,\n\tDRM_FORMAT_NV42,\n};\n\nint shmob_drm_plane_create(struct shmob_drm_device *sdev, unsigned int index)\n{\n\tstruct shmob_drm_plane *splane;\n\tint ret;\n\n\tsplane = devm_kzalloc(sdev->dev, sizeof(*splane), GFP_KERNEL);\n\tif (splane == NULL)\n\t\treturn -ENOMEM;\n\n\tsplane->index = index;\n\tsplane->alpha = 255;\n\n\tret = drm_universal_plane_init(sdev->ddev, &splane->plane, 1,\n\t\t\t\t       &shmob_drm_plane_funcs,\n\t\t\t\t       formats, ARRAY_SIZE(formats), NULL,\n\t\t\t\t       DRM_PLANE_TYPE_OVERLAY, NULL);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}