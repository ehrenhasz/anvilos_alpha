{
  "module_name": "shmob_drm_kms.c",
  "hash_id": "b88f14439ce9d192c8715ce912eb1244f5305c6a3c05f89a2e8a07db426732d7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/renesas/shmobile/shmob_drm_kms.c",
  "human_readable_source": "\n \n\n#include <drm/drm_crtc.h>\n#include <drm/drm_crtc_helper.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_gem_dma_helper.h>\n#include <drm/drm_gem_framebuffer_helper.h>\n#include <drm/drm_probe_helper.h>\n\n#include \"shmob_drm_crtc.h\"\n#include \"shmob_drm_drv.h\"\n#include \"shmob_drm_kms.h\"\n#include \"shmob_drm_regs.h\"\n\n \n\nstatic const struct shmob_drm_format_info shmob_drm_format_infos[] = {\n\t{\n\t\t.fourcc = DRM_FORMAT_RGB565,\n\t\t.bpp = 16,\n\t\t.yuv = false,\n\t\t.lddfr = LDDFR_PKF_RGB16,\n\t}, {\n\t\t.fourcc = DRM_FORMAT_RGB888,\n\t\t.bpp = 24,\n\t\t.yuv = false,\n\t\t.lddfr = LDDFR_PKF_RGB24,\n\t}, {\n\t\t.fourcc = DRM_FORMAT_ARGB8888,\n\t\t.bpp = 32,\n\t\t.yuv = false,\n\t\t.lddfr = LDDFR_PKF_ARGB32,\n\t}, {\n\t\t.fourcc = DRM_FORMAT_XRGB8888,\n\t\t.bpp = 32,\n\t\t.yuv = false,\n\t\t.lddfr = LDDFR_PKF_ARGB32,\n\t}, {\n\t\t.fourcc = DRM_FORMAT_NV12,\n\t\t.bpp = 12,\n\t\t.yuv = true,\n\t\t.lddfr = LDDFR_CC | LDDFR_YF_420,\n\t}, {\n\t\t.fourcc = DRM_FORMAT_NV21,\n\t\t.bpp = 12,\n\t\t.yuv = true,\n\t\t.lddfr = LDDFR_CC | LDDFR_YF_420,\n\t}, {\n\t\t.fourcc = DRM_FORMAT_NV16,\n\t\t.bpp = 16,\n\t\t.yuv = true,\n\t\t.lddfr = LDDFR_CC | LDDFR_YF_422,\n\t}, {\n\t\t.fourcc = DRM_FORMAT_NV61,\n\t\t.bpp = 16,\n\t\t.yuv = true,\n\t\t.lddfr = LDDFR_CC | LDDFR_YF_422,\n\t}, {\n\t\t.fourcc = DRM_FORMAT_NV24,\n\t\t.bpp = 24,\n\t\t.yuv = true,\n\t\t.lddfr = LDDFR_CC | LDDFR_YF_444,\n\t}, {\n\t\t.fourcc = DRM_FORMAT_NV42,\n\t\t.bpp = 24,\n\t\t.yuv = true,\n\t\t.lddfr = LDDFR_CC | LDDFR_YF_444,\n\t},\n};\n\nconst struct shmob_drm_format_info *shmob_drm_format_info(u32 fourcc)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < ARRAY_SIZE(shmob_drm_format_infos); ++i) {\n\t\tif (shmob_drm_format_infos[i].fourcc == fourcc)\n\t\t\treturn &shmob_drm_format_infos[i];\n\t}\n\n\treturn NULL;\n}\n\n \n\nstatic struct drm_framebuffer *\nshmob_drm_fb_create(struct drm_device *dev, struct drm_file *file_priv,\n\t\t    const struct drm_mode_fb_cmd2 *mode_cmd)\n{\n\tconst struct shmob_drm_format_info *format;\n\n\tformat = shmob_drm_format_info(mode_cmd->pixel_format);\n\tif (format == NULL) {\n\t\tdev_dbg(dev->dev, \"unsupported pixel format %p4cc\\n\",\n\t\t\t&mode_cmd->pixel_format);\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tif (mode_cmd->pitches[0] & 7 || mode_cmd->pitches[0] >= 65536) {\n\t\tdev_dbg(dev->dev, \"invalid pitch value %u\\n\",\n\t\t\tmode_cmd->pitches[0]);\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tif (format->yuv) {\n\t\tunsigned int chroma_cpp = format->bpp == 24 ? 2 : 1;\n\n\t\tif (mode_cmd->pitches[1] != mode_cmd->pitches[0] * chroma_cpp) {\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"luma and chroma pitches do not match\\n\");\n\t\t\treturn ERR_PTR(-EINVAL);\n\t\t}\n\t}\n\n\treturn drm_gem_fb_create(dev, file_priv, mode_cmd);\n}\n\nstatic const struct drm_mode_config_funcs shmob_drm_mode_config_funcs = {\n\t.fb_create = shmob_drm_fb_create,\n};\n\nint shmob_drm_modeset_init(struct shmob_drm_device *sdev)\n{\n\tint ret;\n\n\tret = drmm_mode_config_init(sdev->ddev);\n\tif (ret)\n\t\treturn ret;\n\n\tshmob_drm_crtc_create(sdev);\n\tshmob_drm_encoder_create(sdev);\n\tshmob_drm_connector_create(sdev, &sdev->encoder.encoder);\n\n\tdrm_kms_helper_poll_init(sdev->ddev);\n\n\tsdev->ddev->mode_config.min_width = 0;\n\tsdev->ddev->mode_config.min_height = 0;\n\tsdev->ddev->mode_config.max_width = 4095;\n\tsdev->ddev->mode_config.max_height = 4095;\n\tsdev->ddev->mode_config.funcs = &shmob_drm_mode_config_funcs;\n\n\tdrm_helper_disable_unused_functions(sdev->ddev);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}