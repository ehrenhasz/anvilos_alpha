{
  "module_name": "lsdc_benchmark.c",
  "hash_id": "10ef8692e1c4a3a414cf4c8309434e5fcea99c3e28ea48ef882578be889aefe9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/loongson/lsdc_benchmark.c",
  "human_readable_source": "\n \n\n#include <drm/drm_debugfs.h>\n\n#include \"lsdc_benchmark.h\"\n#include \"lsdc_drv.h\"\n#include \"lsdc_gem.h\"\n#include \"lsdc_ttm.h\"\n\ntypedef void (*lsdc_copy_proc_t)(struct lsdc_bo *src_bo,\n\t\t\t\t struct lsdc_bo *dst_bo,\n\t\t\t\t unsigned int size,\n\t\t\t\t int n);\n\nstatic void lsdc_copy_gtt_to_vram_cpu(struct lsdc_bo *src_bo,\n\t\t\t\t      struct lsdc_bo *dst_bo,\n\t\t\t\t      unsigned int size,\n\t\t\t\t      int n)\n{\n\tlsdc_bo_kmap(src_bo);\n\tlsdc_bo_kmap(dst_bo);\n\n\twhile (n--)\n\t\tmemcpy_toio(dst_bo->kptr, src_bo->kptr, size);\n\n\tlsdc_bo_kunmap(src_bo);\n\tlsdc_bo_kunmap(dst_bo);\n}\n\nstatic void lsdc_copy_vram_to_gtt_cpu(struct lsdc_bo *src_bo,\n\t\t\t\t      struct lsdc_bo *dst_bo,\n\t\t\t\t      unsigned int size,\n\t\t\t\t      int n)\n{\n\tlsdc_bo_kmap(src_bo);\n\tlsdc_bo_kmap(dst_bo);\n\n\twhile (n--)\n\t\tmemcpy_fromio(dst_bo->kptr, src_bo->kptr, size);\n\n\tlsdc_bo_kunmap(src_bo);\n\tlsdc_bo_kunmap(dst_bo);\n}\n\nstatic void lsdc_copy_gtt_to_gtt_cpu(struct lsdc_bo *src_bo,\n\t\t\t\t     struct lsdc_bo *dst_bo,\n\t\t\t\t     unsigned int size,\n\t\t\t\t     int n)\n{\n\tlsdc_bo_kmap(src_bo);\n\tlsdc_bo_kmap(dst_bo);\n\n\twhile (n--)\n\t\tmemcpy(dst_bo->kptr, src_bo->kptr, size);\n\n\tlsdc_bo_kunmap(src_bo);\n\tlsdc_bo_kunmap(dst_bo);\n}\n\nstatic void lsdc_benchmark_copy(struct lsdc_device *ldev,\n\t\t\t\tunsigned int size,\n\t\t\t\tunsigned int n,\n\t\t\t\tu32 src_domain,\n\t\t\t\tu32 dst_domain,\n\t\t\t\tlsdc_copy_proc_t copy_proc,\n\t\t\t\tstruct drm_printer *p)\n{\n\tstruct drm_device *ddev = &ldev->base;\n\tstruct lsdc_bo *src_bo;\n\tstruct lsdc_bo *dst_bo;\n\tunsigned long start_jiffies;\n\tunsigned long end_jiffies;\n\tunsigned int throughput;\n\tunsigned int time;\n\n\tsrc_bo = lsdc_bo_create_kernel_pinned(ddev, src_domain, size);\n\tdst_bo = lsdc_bo_create_kernel_pinned(ddev, dst_domain, size);\n\n\tstart_jiffies = jiffies;\n\n\tcopy_proc(src_bo, dst_bo, size, n);\n\n\tend_jiffies = jiffies;\n\n\tlsdc_bo_free_kernel_pinned(src_bo);\n\tlsdc_bo_free_kernel_pinned(dst_bo);\n\n\ttime = jiffies_to_msecs(end_jiffies - start_jiffies);\n\n\tthroughput = (n * (size >> 10)) / time;\n\n\tdrm_printf(p,\n\t\t   \"Copy bo of %uKiB %u times from %s to %s in %ums: %uMB/s\\n\",\n\t\t   size >> 10, n,\n\t\t   lsdc_domain_to_str(src_domain),\n\t\t   lsdc_domain_to_str(dst_domain),\n\t\t   time, throughput);\n}\n\nint lsdc_show_benchmark_copy(struct lsdc_device *ldev, struct drm_printer *p)\n{\n\tunsigned int buffer_size = 1920 * 1080 * 4;\n\tunsigned int iteration = 60;\n\n\tlsdc_benchmark_copy(ldev,\n\t\t\t    buffer_size,\n\t\t\t    iteration,\n\t\t\t    LSDC_GEM_DOMAIN_GTT,\n\t\t\t    LSDC_GEM_DOMAIN_GTT,\n\t\t\t    lsdc_copy_gtt_to_gtt_cpu,\n\t\t\t    p);\n\n\tlsdc_benchmark_copy(ldev,\n\t\t\t    buffer_size,\n\t\t\t    iteration,\n\t\t\t    LSDC_GEM_DOMAIN_GTT,\n\t\t\t    LSDC_GEM_DOMAIN_VRAM,\n\t\t\t    lsdc_copy_gtt_to_vram_cpu,\n\t\t\t    p);\n\n\tlsdc_benchmark_copy(ldev,\n\t\t\t    buffer_size,\n\t\t\t    iteration,\n\t\t\t    LSDC_GEM_DOMAIN_VRAM,\n\t\t\t    LSDC_GEM_DOMAIN_GTT,\n\t\t\t    lsdc_copy_vram_to_gtt_cpu,\n\t\t\t    p);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}