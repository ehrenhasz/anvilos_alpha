{
  "module_name": "dcss-drv.c",
  "hash_id": "1cebee61cab7de308310992f4e766f6baf29d4136003ffe6311c5f85904d7dbb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/imx/dcss/dcss-drv.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <drm/drm_module.h>\n#include <drm/drm_of.h>\n\n#include \"dcss-dev.h\"\n#include \"dcss-kms.h\"\n\nstruct dcss_drv {\n\tstruct dcss_dev *dcss;\n\tstruct dcss_kms_dev *kms;\n};\n\nstruct dcss_dev *dcss_drv_dev_to_dcss(struct device *dev)\n{\n\tstruct dcss_drv *mdrv = dev_get_drvdata(dev);\n\n\treturn mdrv ? mdrv->dcss : NULL;\n}\n\nstruct drm_device *dcss_drv_dev_to_drm(struct device *dev)\n{\n\tstruct dcss_drv *mdrv = dev_get_drvdata(dev);\n\n\treturn mdrv ? &mdrv->kms->base : NULL;\n}\n\nstatic int dcss_drv_platform_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *remote;\n\tstruct dcss_drv *mdrv;\n\tint err = 0;\n\tbool hdmi_output = true;\n\n\tif (!dev->of_node)\n\t\treturn -ENODEV;\n\n\tremote = of_graph_get_remote_node(dev->of_node, 0, 0);\n\tif (!remote)\n\t\treturn -ENODEV;\n\n\thdmi_output = !of_device_is_compatible(remote, \"fsl,imx8mq-nwl-dsi\");\n\n\tof_node_put(remote);\n\n\tmdrv = kzalloc(sizeof(*mdrv), GFP_KERNEL);\n\tif (!mdrv)\n\t\treturn -ENOMEM;\n\n\tmdrv->dcss = dcss_dev_create(dev, hdmi_output);\n\tif (IS_ERR(mdrv->dcss)) {\n\t\terr = PTR_ERR(mdrv->dcss);\n\t\tgoto err;\n\t}\n\n\tdev_set_drvdata(dev, mdrv);\n\n\tmdrv->kms = dcss_kms_attach(mdrv->dcss);\n\tif (IS_ERR(mdrv->kms)) {\n\t\terr = PTR_ERR(mdrv->kms);\n\t\tdev_err_probe(dev, err, \"Failed to initialize KMS\\n\");\n\t\tgoto dcss_shutoff;\n\t}\n\n\treturn 0;\n\ndcss_shutoff:\n\tdcss_dev_destroy(mdrv->dcss);\n\nerr:\n\tkfree(mdrv);\n\treturn err;\n}\n\nstatic int dcss_drv_platform_remove(struct platform_device *pdev)\n{\n\tstruct dcss_drv *mdrv = dev_get_drvdata(&pdev->dev);\n\n\tdcss_kms_detach(mdrv->kms);\n\tdcss_dev_destroy(mdrv->dcss);\n\n\tkfree(mdrv);\n\n\treturn 0;\n}\n\nstatic struct dcss_type_data dcss_types[] = {\n\t[DCSS_IMX8MQ] = {\n\t\t.name = \"DCSS_IMX8MQ\",\n\t\t.blkctl_ofs = 0x2F000,\n\t\t.ctxld_ofs = 0x23000,\n\t\t.dtg_ofs = 0x20000,\n\t\t.scaler_ofs = 0x1C000,\n\t\t.ss_ofs = 0x1B000,\n\t\t.dpr_ofs = 0x18000,\n\t},\n};\n\nstatic const struct of_device_id dcss_of_match[] = {\n\t{ .compatible = \"nxp,imx8mq-dcss\", .data = &dcss_types[DCSS_IMX8MQ], },\n\t{},\n};\n\nMODULE_DEVICE_TABLE(of, dcss_of_match);\n\nstatic struct platform_driver dcss_platform_driver = {\n\t.probe\t= dcss_drv_platform_probe,\n\t.remove\t= dcss_drv_platform_remove,\n\t.driver\t= {\n\t\t.name = \"imx-dcss\",\n\t\t.of_match_table\t= dcss_of_match,\n\t\t.pm = pm_ptr(&dcss_dev_pm_ops),\n\t},\n};\n\ndrm_module_platform_driver(dcss_platform_driver);\n\nMODULE_AUTHOR(\"Laurentiu Palcu <laurentiu.palcu@nxp.com>\");\nMODULE_DESCRIPTION(\"DCSS driver for i.MX8MQ\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}