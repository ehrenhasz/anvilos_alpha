{
  "module_name": "dcss-ss.c",
  "hash_id": "1271baee60e000ecec15830b7bb612688a5b595e57d46e33d4000acb2b2e07ad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/imx/dcss/dcss-ss.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/slab.h>\n\n#include \"dcss-dev.h\"\n\n#define DCSS_SS_SYS_CTRL\t\t\t0x00\n#define   RUN_EN\t\t\t\tBIT(0)\n#define DCSS_SS_DISPLAY\t\t\t\t0x10\n#define   LRC_X_POS\t\t\t\t0\n#define   LRC_X_MASK\t\t\t\tGENMASK(12, 0)\n#define   LRC_Y_POS\t\t\t\t16\n#define   LRC_Y_MASK\t\t\t\tGENMASK(28, 16)\n#define DCSS_SS_HSYNC\t\t\t\t0x20\n#define DCSS_SS_VSYNC\t\t\t\t0x30\n#define   SYNC_START_POS\t\t\t0\n#define   SYNC_START_MASK\t\t\tGENMASK(12, 0)\n#define   SYNC_END_POS\t\t\t\t16\n#define   SYNC_END_MASK\t\t\t\tGENMASK(28, 16)\n#define   SYNC_POL\t\t\t\tBIT(31)\n#define DCSS_SS_DE_ULC\t\t\t\t0x40\n#define   ULC_X_POS\t\t\t\t0\n#define   ULC_X_MASK\t\t\t\tGENMASK(12, 0)\n#define   ULC_Y_POS\t\t\t\t16\n#define   ULC_Y_MASK\t\t\t\tGENMASK(28, 16)\n#define   ULC_POL\t\t\t\tBIT(31)\n#define DCSS_SS_DE_LRC\t\t\t\t0x50\n#define DCSS_SS_MODE\t\t\t\t0x60\n#define   PIPE_MODE_POS\t\t\t\t0\n#define   PIPE_MODE_MASK\t\t\tGENMASK(1, 0)\n#define DCSS_SS_COEFF\t\t\t\t0x70\n#define   HORIZ_A_POS\t\t\t\t0\n#define   HORIZ_A_MASK\t\t\t\tGENMASK(3, 0)\n#define   HORIZ_B_POS\t\t\t\t4\n#define   HORIZ_B_MASK\t\t\t\tGENMASK(7, 4)\n#define   HORIZ_C_POS\t\t\t\t8\n#define   HORIZ_C_MASK\t\t\t\tGENMASK(11, 8)\n#define   HORIZ_H_NORM_POS\t\t\t12\n#define   HORIZ_H_NORM_MASK\t\t\tGENMASK(14, 12)\n#define   VERT_A_POS\t\t\t\t16\n#define   VERT_A_MASK\t\t\t\tGENMASK(19, 16)\n#define   VERT_B_POS\t\t\t\t20\n#define   VERT_B_MASK\t\t\t\tGENMASK(23, 20)\n#define   VERT_C_POS\t\t\t\t24\n#define   VERT_C_MASK\t\t\t\tGENMASK(27, 24)\n#define   VERT_H_NORM_POS\t\t\t28\n#define   VERT_H_NORM_MASK\t\t\tGENMASK(30, 28)\n#define DCSS_SS_CLIP_CB\t\t\t\t0x80\n#define DCSS_SS_CLIP_CR\t\t\t\t0x90\n#define   CLIP_MIN_POS\t\t\t\t0\n#define   CLIP_MIN_MASK\t\t\t\tGENMASK(9, 0)\n#define   CLIP_MAX_POS\t\t\t\t0\n#define   CLIP_MAX_MASK\t\t\t\tGENMASK(23, 16)\n#define DCSS_SS_INTER_MODE\t\t\t0xA0\n#define   INT_EN\t\t\t\tBIT(0)\n#define   VSYNC_SHIFT\t\t\t\tBIT(1)\n\nstruct dcss_ss {\n\tstruct device *dev;\n\tvoid __iomem *base_reg;\n\tu32 base_ofs;\n\n\tstruct dcss_ctxld *ctxld;\n\tu32 ctx_id;\n\n\tbool in_use;\n};\n\nstatic void dcss_ss_write(struct dcss_ss *ss, u32 val, u32 ofs)\n{\n\tif (!ss->in_use)\n\t\tdcss_writel(val, ss->base_reg + ofs);\n\n\tdcss_ctxld_write(ss->ctxld, ss->ctx_id, val,\n\t\t\t ss->base_ofs + ofs);\n}\n\nint dcss_ss_init(struct dcss_dev *dcss, unsigned long ss_base)\n{\n\tstruct dcss_ss *ss;\n\n\tss = kzalloc(sizeof(*ss), GFP_KERNEL);\n\tif (!ss)\n\t\treturn -ENOMEM;\n\n\tdcss->ss = ss;\n\tss->dev = dcss->dev;\n\tss->ctxld = dcss->ctxld;\n\n\tss->base_reg = ioremap(ss_base, SZ_4K);\n\tif (!ss->base_reg) {\n\t\tdev_err(dcss->dev, \"ss: unable to remap ss base\\n\");\n\t\tkfree(ss);\n\t\treturn -ENOMEM;\n\t}\n\n\tss->base_ofs = ss_base;\n\tss->ctx_id = CTX_SB_HP;\n\n\treturn 0;\n}\n\nvoid dcss_ss_exit(struct dcss_ss *ss)\n{\n\t \n\tdcss_writel(0, ss->base_reg + DCSS_SS_SYS_CTRL);\n\n\tif (ss->base_reg)\n\t\tiounmap(ss->base_reg);\n\n\tkfree(ss);\n}\n\nvoid dcss_ss_subsam_set(struct dcss_ss *ss)\n{\n\tdcss_ss_write(ss, 0x41614161, DCSS_SS_COEFF);\n\tdcss_ss_write(ss, 0, DCSS_SS_MODE);\n\tdcss_ss_write(ss, 0x03ff0000, DCSS_SS_CLIP_CB);\n\tdcss_ss_write(ss, 0x03ff0000, DCSS_SS_CLIP_CR);\n}\n\nvoid dcss_ss_sync_set(struct dcss_ss *ss, struct videomode *vm,\n\t\t      bool phsync, bool pvsync)\n{\n\tu16 lrc_x, lrc_y;\n\tu16 hsync_start, hsync_end;\n\tu16 vsync_start, vsync_end;\n\tu16 de_ulc_x, de_ulc_y;\n\tu16 de_lrc_x, de_lrc_y;\n\n\tlrc_x = vm->hfront_porch + vm->hback_porch + vm->hsync_len +\n\t\tvm->hactive - 1;\n\tlrc_y = vm->vfront_porch + vm->vback_porch + vm->vsync_len +\n\t\tvm->vactive - 1;\n\n\tdcss_ss_write(ss, (lrc_y << LRC_Y_POS) | lrc_x, DCSS_SS_DISPLAY);\n\n\thsync_start = vm->hfront_porch + vm->hback_porch + vm->hsync_len +\n\t\t      vm->hactive - 1;\n\thsync_end = vm->hsync_len - 1;\n\n\tdcss_ss_write(ss, (phsync ? SYNC_POL : 0) |\n\t\t      ((u32)hsync_end << SYNC_END_POS) | hsync_start,\n\t\t      DCSS_SS_HSYNC);\n\n\tvsync_start = vm->vfront_porch - 1;\n\tvsync_end = vm->vfront_porch + vm->vsync_len - 1;\n\n\tdcss_ss_write(ss, (pvsync ? SYNC_POL : 0) |\n\t\t      ((u32)vsync_end << SYNC_END_POS) | vsync_start,\n\t\t      DCSS_SS_VSYNC);\n\n\tde_ulc_x = vm->hsync_len + vm->hback_porch - 1;\n\tde_ulc_y = vm->vsync_len + vm->vfront_porch + vm->vback_porch;\n\n\tdcss_ss_write(ss, SYNC_POL | ((u32)de_ulc_y << ULC_Y_POS) | de_ulc_x,\n\t\t      DCSS_SS_DE_ULC);\n\n\tde_lrc_x = vm->hsync_len + vm->hback_porch + vm->hactive - 1;\n\tde_lrc_y = vm->vsync_len + vm->vfront_porch + vm->vback_porch +\n\t\t   vm->vactive - 1;\n\n\tdcss_ss_write(ss, (de_lrc_y << LRC_Y_POS) | de_lrc_x, DCSS_SS_DE_LRC);\n}\n\nvoid dcss_ss_enable(struct dcss_ss *ss)\n{\n\tdcss_ss_write(ss, RUN_EN, DCSS_SS_SYS_CTRL);\n\tss->in_use = true;\n}\n\nvoid dcss_ss_shutoff(struct dcss_ss *ss)\n{\n\tdcss_writel(0, ss->base_reg + DCSS_SS_SYS_CTRL);\n\tss->in_use = false;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}