{
  "module_name": "etnaviv_gem_prime.c",
  "hash_id": "a866ec713eb51238768dcb5b270b131e4c93826feef3c6bc01fed154adabaf66",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/etnaviv/etnaviv_gem_prime.c",
  "human_readable_source": "\n \n\n#include <drm/drm_prime.h>\n#include <linux/dma-buf.h>\n#include <linux/module.h>\n\n#include \"etnaviv_drv.h\"\n#include \"etnaviv_gem.h\"\n\nMODULE_IMPORT_NS(DMA_BUF);\n\nstatic struct lock_class_key etnaviv_prime_lock_class;\n\nstruct sg_table *etnaviv_gem_prime_get_sg_table(struct drm_gem_object *obj)\n{\n\tstruct etnaviv_gem_object *etnaviv_obj = to_etnaviv_bo(obj);\n\tint npages = obj->size >> PAGE_SHIFT;\n\n\tif (WARN_ON(!etnaviv_obj->pages))   \n\t\treturn ERR_PTR(-EINVAL);\n\n\treturn drm_prime_pages_to_sg(obj->dev, etnaviv_obj->pages, npages);\n}\n\nint etnaviv_gem_prime_vmap(struct drm_gem_object *obj, struct iosys_map *map)\n{\n\tvoid *vaddr;\n\n\tvaddr = etnaviv_gem_vmap(obj);\n\tif (!vaddr)\n\t\treturn -ENOMEM;\n\tiosys_map_set_vaddr(map, vaddr);\n\n\treturn 0;\n}\n\nint etnaviv_gem_prime_pin(struct drm_gem_object *obj)\n{\n\tif (!obj->import_attach) {\n\t\tstruct etnaviv_gem_object *etnaviv_obj = to_etnaviv_bo(obj);\n\n\t\tmutex_lock(&etnaviv_obj->lock);\n\t\tetnaviv_gem_get_pages(etnaviv_obj);\n\t\tmutex_unlock(&etnaviv_obj->lock);\n\t}\n\treturn 0;\n}\n\nvoid etnaviv_gem_prime_unpin(struct drm_gem_object *obj)\n{\n\tif (!obj->import_attach) {\n\t\tstruct etnaviv_gem_object *etnaviv_obj = to_etnaviv_bo(obj);\n\n\t\tmutex_lock(&etnaviv_obj->lock);\n\t\tetnaviv_gem_put_pages(to_etnaviv_bo(obj));\n\t\tmutex_unlock(&etnaviv_obj->lock);\n\t}\n}\n\nstatic void etnaviv_gem_prime_release(struct etnaviv_gem_object *etnaviv_obj)\n{\n\tstruct iosys_map map = IOSYS_MAP_INIT_VADDR(etnaviv_obj->vaddr);\n\n\tif (etnaviv_obj->vaddr)\n\t\tdma_buf_vunmap_unlocked(etnaviv_obj->base.import_attach->dmabuf, &map);\n\n\t \n\tkvfree(etnaviv_obj->pages);\n\n\tdrm_prime_gem_destroy(&etnaviv_obj->base, etnaviv_obj->sgt);\n}\n\nstatic void *etnaviv_gem_prime_vmap_impl(struct etnaviv_gem_object *etnaviv_obj)\n{\n\tstruct iosys_map map;\n\tint ret;\n\n\tlockdep_assert_held(&etnaviv_obj->lock);\n\n\tret = dma_buf_vmap(etnaviv_obj->base.import_attach->dmabuf, &map);\n\tif (ret)\n\t\treturn NULL;\n\treturn map.vaddr;\n}\n\nstatic int etnaviv_gem_prime_mmap_obj(struct etnaviv_gem_object *etnaviv_obj,\n\t\tstruct vm_area_struct *vma)\n{\n\tint ret;\n\n\tret = dma_buf_mmap(etnaviv_obj->base.dma_buf, vma, 0);\n\tif (!ret) {\n\t\t \n\t\tdrm_gem_object_put(&etnaviv_obj->base);\n\t}\n\n\treturn ret;\n}\n\nstatic const struct etnaviv_gem_ops etnaviv_gem_prime_ops = {\n\t \n\t.release = etnaviv_gem_prime_release,\n\t.vmap = etnaviv_gem_prime_vmap_impl,\n\t.mmap = etnaviv_gem_prime_mmap_obj,\n};\n\nstruct drm_gem_object *etnaviv_gem_prime_import_sg_table(struct drm_device *dev,\n\tstruct dma_buf_attachment *attach, struct sg_table *sgt)\n{\n\tstruct etnaviv_gem_object *etnaviv_obj;\n\tsize_t size = PAGE_ALIGN(attach->dmabuf->size);\n\tint ret, npages;\n\n\tret = etnaviv_gem_new_private(dev, size, ETNA_BO_WC,\n\t\t\t\t      &etnaviv_gem_prime_ops, &etnaviv_obj);\n\tif (ret < 0)\n\t\treturn ERR_PTR(ret);\n\n\tlockdep_set_class(&etnaviv_obj->lock, &etnaviv_prime_lock_class);\n\n\tnpages = size / PAGE_SIZE;\n\n\tetnaviv_obj->sgt = sgt;\n\tetnaviv_obj->pages = kvmalloc_array(npages, sizeof(struct page *), GFP_KERNEL);\n\tif (!etnaviv_obj->pages) {\n\t\tret = -ENOMEM;\n\t\tgoto fail;\n\t}\n\n\tret = drm_prime_sg_to_page_array(sgt, etnaviv_obj->pages, npages);\n\tif (ret)\n\t\tgoto fail;\n\n\tetnaviv_gem_obj_add(dev, &etnaviv_obj->base);\n\n\treturn &etnaviv_obj->base;\n\nfail:\n\tdrm_gem_object_put(&etnaviv_obj->base);\n\n\treturn ERR_PTR(ret);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}