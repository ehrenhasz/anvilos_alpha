{
  "module_name": "mtk_drm_ddp_comp.c",
  "hash_id": "c6c36ffdf976235bcc7e493a2a56c9e80e5fb50398d6c34593a0370980b1a66d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/mediatek/mtk_drm_ddp_comp.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n#include <linux/soc/mediatek/mtk-cmdq.h>\n#include <drm/drm_print.h>\n\n#include \"mtk_disp_drv.h\"\n#include \"mtk_drm_drv.h\"\n#include \"mtk_drm_plane.h\"\n#include \"mtk_drm_ddp_comp.h\"\n#include \"mtk_drm_crtc.h\"\n\n\n#define DISP_REG_DITHER_EN\t\t\t0x0000\n#define DITHER_EN\t\t\t\tBIT(0)\n#define DISP_REG_DITHER_CFG\t\t\t0x0020\n#define DITHER_RELAY_MODE\t\t\tBIT(0)\n#define DITHER_ENGINE_EN\t\t\tBIT(1)\n#define DISP_DITHERING\t\t\t\tBIT(2)\n#define DISP_REG_DITHER_SIZE\t\t\t0x0030\n#define DISP_REG_DITHER_5\t\t\t0x0114\n#define DISP_REG_DITHER_7\t\t\t0x011c\n#define DISP_REG_DITHER_15\t\t\t0x013c\n#define DITHER_LSB_ERR_SHIFT_R(x)\t\t(((x) & 0x7) << 28)\n#define DITHER_ADD_LSHIFT_R(x)\t\t\t(((x) & 0x7) << 20)\n#define DITHER_NEW_BIT_MODE\t\t\tBIT(0)\n#define DISP_REG_DITHER_16\t\t\t0x0140\n#define DITHER_LSB_ERR_SHIFT_B(x)\t\t(((x) & 0x7) << 28)\n#define DITHER_ADD_LSHIFT_B(x)\t\t\t(((x) & 0x7) << 20)\n#define DITHER_LSB_ERR_SHIFT_G(x)\t\t(((x) & 0x7) << 12)\n#define DITHER_ADD_LSHIFT_G(x)\t\t\t(((x) & 0x7) << 4)\n\n#define DISP_REG_DSC_CON\t\t\t0x0000\n#define DSC_EN\t\t\t\t\tBIT(0)\n#define DSC_DUAL_INOUT\t\t\t\tBIT(2)\n#define DSC_BYPASS\t\t\t\tBIT(4)\n#define DSC_UFOE_SEL\t\t\t\tBIT(16)\n\n#define DISP_REG_OD_EN\t\t\t\t0x0000\n#define DISP_REG_OD_CFG\t\t\t\t0x0020\n#define OD_RELAYMODE\t\t\t\tBIT(0)\n#define DISP_REG_OD_SIZE\t\t\t0x0030\n\n#define DISP_REG_POSTMASK_EN\t\t\t0x0000\n#define POSTMASK_EN\t\t\t\t\tBIT(0)\n#define DISP_REG_POSTMASK_CFG\t\t\t0x0020\n#define POSTMASK_RELAY_MODE\t\t\t\tBIT(0)\n#define DISP_REG_POSTMASK_SIZE\t\t\t0x0030\n\n#define DISP_REG_UFO_START\t\t\t0x0000\n#define UFO_BYPASS\t\t\t\tBIT(2)\n\nstruct mtk_ddp_comp_dev {\n\tstruct clk *clk;\n\tvoid __iomem *regs;\n\tstruct cmdq_client_reg cmdq_reg;\n};\n\nvoid mtk_ddp_write(struct cmdq_pkt *cmdq_pkt, unsigned int value,\n\t\t   struct cmdq_client_reg *cmdq_reg, void __iomem *regs,\n\t\t   unsigned int offset)\n{\n#if IS_REACHABLE(CONFIG_MTK_CMDQ)\n\tif (cmdq_pkt)\n\t\tcmdq_pkt_write(cmdq_pkt, cmdq_reg->subsys,\n\t\t\t       cmdq_reg->offset + offset, value);\n\telse\n#endif\n\t\twritel(value, regs + offset);\n}\n\nvoid mtk_ddp_write_relaxed(struct cmdq_pkt *cmdq_pkt, unsigned int value,\n\t\t\t   struct cmdq_client_reg *cmdq_reg, void __iomem *regs,\n\t\t\t   unsigned int offset)\n{\n#if IS_REACHABLE(CONFIG_MTK_CMDQ)\n\tif (cmdq_pkt)\n\t\tcmdq_pkt_write(cmdq_pkt, cmdq_reg->subsys,\n\t\t\t       cmdq_reg->offset + offset, value);\n\telse\n#endif\n\t\twritel_relaxed(value, regs + offset);\n}\n\nvoid mtk_ddp_write_mask(struct cmdq_pkt *cmdq_pkt, unsigned int value,\n\t\t\tstruct cmdq_client_reg *cmdq_reg, void __iomem *regs,\n\t\t\tunsigned int offset, unsigned int mask)\n{\n#if IS_REACHABLE(CONFIG_MTK_CMDQ)\n\tif (cmdq_pkt) {\n\t\tcmdq_pkt_write_mask(cmdq_pkt, cmdq_reg->subsys,\n\t\t\t\t    cmdq_reg->offset + offset, value, mask);\n\t} else {\n#endif\n\t\tu32 tmp = readl(regs + offset);\n\n\t\ttmp = (tmp & ~mask) | (value & mask);\n\t\twritel(tmp, regs + offset);\n#if IS_REACHABLE(CONFIG_MTK_CMDQ)\n\t}\n#endif\n}\n\nstatic int mtk_ddp_clk_enable(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\treturn clk_prepare_enable(priv->clk);\n}\n\nstatic void mtk_ddp_clk_disable(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\tclk_disable_unprepare(priv->clk);\n}\n\nvoid mtk_dither_set_common(void __iomem *regs, struct cmdq_client_reg *cmdq_reg,\n\t\t\t   unsigned int bpc, unsigned int cfg,\n\t\t\t   unsigned int dither_en, struct cmdq_pkt *cmdq_pkt)\n{\n\t \n\tif (bpc == 0)\n\t\treturn;\n\n\tif (bpc >= MTK_MIN_BPC) {\n\t\tmtk_ddp_write(cmdq_pkt, 0, cmdq_reg, regs, DISP_REG_DITHER_5);\n\t\tmtk_ddp_write(cmdq_pkt, 0, cmdq_reg, regs, DISP_REG_DITHER_7);\n\t\tmtk_ddp_write(cmdq_pkt,\n\t\t\t      DITHER_LSB_ERR_SHIFT_R(MTK_MAX_BPC - bpc) |\n\t\t\t      DITHER_ADD_LSHIFT_R(MTK_MAX_BPC - bpc) |\n\t\t\t      DITHER_NEW_BIT_MODE,\n\t\t\t      cmdq_reg, regs, DISP_REG_DITHER_15);\n\t\tmtk_ddp_write(cmdq_pkt,\n\t\t\t      DITHER_LSB_ERR_SHIFT_B(MTK_MAX_BPC - bpc) |\n\t\t\t      DITHER_ADD_LSHIFT_B(MTK_MAX_BPC - bpc) |\n\t\t\t      DITHER_LSB_ERR_SHIFT_G(MTK_MAX_BPC - bpc) |\n\t\t\t      DITHER_ADD_LSHIFT_G(MTK_MAX_BPC - bpc),\n\t\t\t      cmdq_reg, regs, DISP_REG_DITHER_16);\n\t\tmtk_ddp_write(cmdq_pkt, dither_en, cmdq_reg, regs, cfg);\n\t}\n}\n\nstatic void mtk_dither_config(struct device *dev, unsigned int w,\n\t\t\t      unsigned int h, unsigned int vrefresh,\n\t\t\t      unsigned int bpc, struct cmdq_pkt *cmdq_pkt)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\tmtk_ddp_write(cmdq_pkt, w << 16 | h, &priv->cmdq_reg, priv->regs, DISP_REG_DITHER_SIZE);\n\tmtk_ddp_write(cmdq_pkt, DITHER_RELAY_MODE, &priv->cmdq_reg, priv->regs,\n\t\t      DISP_REG_DITHER_CFG);\n\tmtk_dither_set_common(priv->regs, &priv->cmdq_reg, bpc, DISP_REG_DITHER_CFG,\n\t\t\t      DITHER_ENGINE_EN, cmdq_pkt);\n}\n\nstatic void mtk_dither_start(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\twritel(DITHER_EN, priv->regs + DISP_REG_DITHER_EN);\n}\n\nstatic void mtk_dither_stop(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\twritel_relaxed(0x0, priv->regs + DISP_REG_DITHER_EN);\n}\n\nstatic void mtk_dither_set(struct device *dev, unsigned int bpc,\n\t\t\t   unsigned int cfg, struct cmdq_pkt *cmdq_pkt)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\tmtk_dither_set_common(priv->regs, &priv->cmdq_reg, bpc, cfg,\n\t\t\t      DISP_DITHERING, cmdq_pkt);\n}\n\nstatic void mtk_dsc_config(struct device *dev, unsigned int w,\n\t\t\t   unsigned int h, unsigned int vrefresh,\n\t\t\t   unsigned int bpc, struct cmdq_pkt *cmdq_pkt)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\t \n\tmtk_ddp_write_mask(cmdq_pkt, DSC_BYPASS, &priv->cmdq_reg, priv->regs,\n\t\t\t   DISP_REG_DSC_CON, DSC_BYPASS);\n\tmtk_ddp_write_mask(cmdq_pkt, DSC_UFOE_SEL, &priv->cmdq_reg, priv->regs,\n\t\t\t   DISP_REG_DSC_CON, DSC_UFOE_SEL);\n\tmtk_ddp_write_mask(cmdq_pkt, DSC_DUAL_INOUT, &priv->cmdq_reg, priv->regs,\n\t\t\t   DISP_REG_DSC_CON, DSC_DUAL_INOUT);\n}\n\nstatic void mtk_dsc_start(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\t \n\tmtk_ddp_write_mask(NULL, DSC_EN, &priv->cmdq_reg, priv->regs, DISP_REG_DSC_CON, DSC_EN);\n}\n\nstatic void mtk_dsc_stop(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\twritel_relaxed(0x0, priv->regs + DISP_REG_DSC_CON);\n}\n\nstatic void mtk_od_config(struct device *dev, unsigned int w,\n\t\t\t  unsigned int h, unsigned int vrefresh,\n\t\t\t  unsigned int bpc, struct cmdq_pkt *cmdq_pkt)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\tmtk_ddp_write(cmdq_pkt, w << 16 | h, &priv->cmdq_reg, priv->regs, DISP_REG_OD_SIZE);\n\tmtk_ddp_write(cmdq_pkt, OD_RELAYMODE, &priv->cmdq_reg, priv->regs, DISP_REG_OD_CFG);\n\tmtk_dither_set(dev, bpc, DISP_REG_OD_CFG, cmdq_pkt);\n}\n\nstatic void mtk_od_start(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\twritel(1, priv->regs + DISP_REG_OD_EN);\n}\n\nstatic void mtk_postmask_config(struct device *dev, unsigned int w,\n\t\t\t\tunsigned int h, unsigned int vrefresh,\n\t\t\t\tunsigned int bpc, struct cmdq_pkt *cmdq_pkt)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\tmtk_ddp_write(cmdq_pkt, w << 16 | h, &priv->cmdq_reg, priv->regs,\n\t\t      DISP_REG_POSTMASK_SIZE);\n\tmtk_ddp_write(cmdq_pkt, POSTMASK_RELAY_MODE, &priv->cmdq_reg,\n\t\t      priv->regs, DISP_REG_POSTMASK_CFG);\n}\n\nstatic void mtk_postmask_start(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\twritel(POSTMASK_EN, priv->regs + DISP_REG_POSTMASK_EN);\n}\n\nstatic void mtk_postmask_stop(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\twritel_relaxed(0x0, priv->regs + DISP_REG_POSTMASK_EN);\n}\n\nstatic void mtk_ufoe_start(struct device *dev)\n{\n\tstruct mtk_ddp_comp_dev *priv = dev_get_drvdata(dev);\n\n\twritel(UFO_BYPASS, priv->regs + DISP_REG_UFO_START);\n}\n\nstatic const struct mtk_ddp_comp_funcs ddp_aal = {\n\t.clk_enable = mtk_aal_clk_enable,\n\t.clk_disable = mtk_aal_clk_disable,\n\t.gamma_set = mtk_aal_gamma_set,\n\t.config = mtk_aal_config,\n\t.start = mtk_aal_start,\n\t.stop = mtk_aal_stop,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_ccorr = {\n\t.clk_enable = mtk_ccorr_clk_enable,\n\t.clk_disable = mtk_ccorr_clk_disable,\n\t.config = mtk_ccorr_config,\n\t.start = mtk_ccorr_start,\n\t.stop = mtk_ccorr_stop,\n\t.ctm_set = mtk_ccorr_ctm_set,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_color = {\n\t.clk_enable = mtk_color_clk_enable,\n\t.clk_disable = mtk_color_clk_disable,\n\t.config = mtk_color_config,\n\t.start = mtk_color_start,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_dither = {\n\t.clk_enable = mtk_ddp_clk_enable,\n\t.clk_disable = mtk_ddp_clk_disable,\n\t.config = mtk_dither_config,\n\t.start = mtk_dither_start,\n\t.stop = mtk_dither_stop,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_dpi = {\n\t.start = mtk_dpi_start,\n\t.stop = mtk_dpi_stop,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_dsc = {\n\t.clk_enable = mtk_ddp_clk_enable,\n\t.clk_disable = mtk_ddp_clk_disable,\n\t.config = mtk_dsc_config,\n\t.start = mtk_dsc_start,\n\t.stop = mtk_dsc_stop,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_dsi = {\n\t.start = mtk_dsi_ddp_start,\n\t.stop = mtk_dsi_ddp_stop,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_gamma = {\n\t.clk_enable = mtk_gamma_clk_enable,\n\t.clk_disable = mtk_gamma_clk_disable,\n\t.gamma_set = mtk_gamma_set,\n\t.config = mtk_gamma_config,\n\t.start = mtk_gamma_start,\n\t.stop = mtk_gamma_stop,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_merge = {\n\t.clk_enable = mtk_merge_clk_enable,\n\t.clk_disable = mtk_merge_clk_disable,\n\t.start = mtk_merge_start,\n\t.stop = mtk_merge_stop,\n\t.config = mtk_merge_config,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_od = {\n\t.clk_enable = mtk_ddp_clk_enable,\n\t.clk_disable = mtk_ddp_clk_disable,\n\t.config = mtk_od_config,\n\t.start = mtk_od_start,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_ovl = {\n\t.clk_enable = mtk_ovl_clk_enable,\n\t.clk_disable = mtk_ovl_clk_disable,\n\t.config = mtk_ovl_config,\n\t.start = mtk_ovl_start,\n\t.stop = mtk_ovl_stop,\n\t.register_vblank_cb = mtk_ovl_register_vblank_cb,\n\t.unregister_vblank_cb = mtk_ovl_unregister_vblank_cb,\n\t.enable_vblank = mtk_ovl_enable_vblank,\n\t.disable_vblank = mtk_ovl_disable_vblank,\n\t.supported_rotations = mtk_ovl_supported_rotations,\n\t.layer_nr = mtk_ovl_layer_nr,\n\t.layer_check = mtk_ovl_layer_check,\n\t.layer_config = mtk_ovl_layer_config,\n\t.bgclr_in_on = mtk_ovl_bgclr_in_on,\n\t.bgclr_in_off = mtk_ovl_bgclr_in_off,\n\t.get_formats = mtk_ovl_get_formats,\n\t.get_num_formats = mtk_ovl_get_num_formats,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_postmask = {\n\t.clk_enable = mtk_ddp_clk_enable,\n\t.clk_disable = mtk_ddp_clk_disable,\n\t.config = mtk_postmask_config,\n\t.start = mtk_postmask_start,\n\t.stop = mtk_postmask_stop,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_rdma = {\n\t.clk_enable = mtk_rdma_clk_enable,\n\t.clk_disable = mtk_rdma_clk_disable,\n\t.config = mtk_rdma_config,\n\t.start = mtk_rdma_start,\n\t.stop = mtk_rdma_stop,\n\t.register_vblank_cb = mtk_rdma_register_vblank_cb,\n\t.unregister_vblank_cb = mtk_rdma_unregister_vblank_cb,\n\t.enable_vblank = mtk_rdma_enable_vblank,\n\t.disable_vblank = mtk_rdma_disable_vblank,\n\t.layer_nr = mtk_rdma_layer_nr,\n\t.layer_config = mtk_rdma_layer_config,\n\t.get_formats = mtk_rdma_get_formats,\n\t.get_num_formats = mtk_rdma_get_num_formats,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_ufoe = {\n\t.clk_enable = mtk_ddp_clk_enable,\n\t.clk_disable = mtk_ddp_clk_disable,\n\t.start = mtk_ufoe_start,\n};\n\nstatic const struct mtk_ddp_comp_funcs ddp_ovl_adaptor = {\n\t.clk_enable = mtk_ovl_adaptor_clk_enable,\n\t.clk_disable = mtk_ovl_adaptor_clk_disable,\n\t.config = mtk_ovl_adaptor_config,\n\t.start = mtk_ovl_adaptor_start,\n\t.stop = mtk_ovl_adaptor_stop,\n\t.layer_nr = mtk_ovl_adaptor_layer_nr,\n\t.layer_config = mtk_ovl_adaptor_layer_config,\n\t.register_vblank_cb = mtk_ovl_adaptor_register_vblank_cb,\n\t.unregister_vblank_cb = mtk_ovl_adaptor_unregister_vblank_cb,\n\t.enable_vblank = mtk_ovl_adaptor_enable_vblank,\n\t.disable_vblank = mtk_ovl_adaptor_disable_vblank,\n\t.dma_dev_get = mtk_ovl_adaptor_dma_dev_get,\n\t.connect = mtk_ovl_adaptor_connect,\n\t.disconnect = mtk_ovl_adaptor_disconnect,\n\t.add = mtk_ovl_adaptor_add_comp,\n\t.remove = mtk_ovl_adaptor_remove_comp,\n\t.get_formats = mtk_ovl_adaptor_get_formats,\n\t.get_num_formats = mtk_ovl_adaptor_get_num_formats,\n};\n\nstatic const char * const mtk_ddp_comp_stem[MTK_DDP_COMP_TYPE_MAX] = {\n\t[MTK_DISP_AAL] = \"aal\",\n\t[MTK_DISP_BLS] = \"bls\",\n\t[MTK_DISP_CCORR] = \"ccorr\",\n\t[MTK_DISP_COLOR] = \"color\",\n\t[MTK_DISP_DITHER] = \"dither\",\n\t[MTK_DISP_DSC] = \"dsc\",\n\t[MTK_DISP_GAMMA] = \"gamma\",\n\t[MTK_DISP_MERGE] = \"merge\",\n\t[MTK_DISP_MUTEX] = \"mutex\",\n\t[MTK_DISP_OD] = \"od\",\n\t[MTK_DISP_OVL] = \"ovl\",\n\t[MTK_DISP_OVL_2L] = \"ovl-2l\",\n\t[MTK_DISP_OVL_ADAPTOR] = \"ovl_adaptor\",\n\t[MTK_DISP_POSTMASK] = \"postmask\",\n\t[MTK_DISP_PWM] = \"pwm\",\n\t[MTK_DISP_RDMA] = \"rdma\",\n\t[MTK_DISP_UFOE] = \"ufoe\",\n\t[MTK_DISP_WDMA] = \"wdma\",\n\t[MTK_DP_INTF] = \"dp-intf\",\n\t[MTK_DPI] = \"dpi\",\n\t[MTK_DSI] = \"dsi\",\n};\n\nstruct mtk_ddp_comp_match {\n\tenum mtk_ddp_comp_type type;\n\tint alias_id;\n\tconst struct mtk_ddp_comp_funcs *funcs;\n};\n\nstatic const struct mtk_ddp_comp_match mtk_ddp_matches[DDP_COMPONENT_DRM_ID_MAX] = {\n\t[DDP_COMPONENT_AAL0]\t\t= { MTK_DISP_AAL,\t\t0, &ddp_aal },\n\t[DDP_COMPONENT_AAL1]\t\t= { MTK_DISP_AAL,\t\t1, &ddp_aal },\n\t[DDP_COMPONENT_BLS]\t\t= { MTK_DISP_BLS,\t\t0, NULL },\n\t[DDP_COMPONENT_CCORR]\t\t= { MTK_DISP_CCORR,\t\t0, &ddp_ccorr },\n\t[DDP_COMPONENT_COLOR0]\t\t= { MTK_DISP_COLOR,\t\t0, &ddp_color },\n\t[DDP_COMPONENT_COLOR1]\t\t= { MTK_DISP_COLOR,\t\t1, &ddp_color },\n\t[DDP_COMPONENT_DITHER0]\t\t= { MTK_DISP_DITHER,\t\t0, &ddp_dither },\n\t[DDP_COMPONENT_DP_INTF0]\t= { MTK_DP_INTF,\t\t0, &ddp_dpi },\n\t[DDP_COMPONENT_DP_INTF1]\t= { MTK_DP_INTF,\t\t1, &ddp_dpi },\n\t[DDP_COMPONENT_DPI0]\t\t= { MTK_DPI,\t\t\t0, &ddp_dpi },\n\t[DDP_COMPONENT_DPI1]\t\t= { MTK_DPI,\t\t\t1, &ddp_dpi },\n\t[DDP_COMPONENT_DRM_OVL_ADAPTOR]\t= { MTK_DISP_OVL_ADAPTOR,\t0, &ddp_ovl_adaptor },\n\t[DDP_COMPONENT_DSC0]\t\t= { MTK_DISP_DSC,\t\t0, &ddp_dsc },\n\t[DDP_COMPONENT_DSC1]\t\t= { MTK_DISP_DSC,\t\t1, &ddp_dsc },\n\t[DDP_COMPONENT_DSI0]\t\t= { MTK_DSI,\t\t\t0, &ddp_dsi },\n\t[DDP_COMPONENT_DSI1]\t\t= { MTK_DSI,\t\t\t1, &ddp_dsi },\n\t[DDP_COMPONENT_DSI2]\t\t= { MTK_DSI,\t\t\t2, &ddp_dsi },\n\t[DDP_COMPONENT_DSI3]\t\t= { MTK_DSI,\t\t\t3, &ddp_dsi },\n\t[DDP_COMPONENT_GAMMA]\t\t= { MTK_DISP_GAMMA,\t\t0, &ddp_gamma },\n\t[DDP_COMPONENT_MERGE0]\t\t= { MTK_DISP_MERGE,\t\t0, &ddp_merge },\n\t[DDP_COMPONENT_MERGE1]\t\t= { MTK_DISP_MERGE,\t\t1, &ddp_merge },\n\t[DDP_COMPONENT_MERGE2]\t\t= { MTK_DISP_MERGE,\t\t2, &ddp_merge },\n\t[DDP_COMPONENT_MERGE3]\t\t= { MTK_DISP_MERGE,\t\t3, &ddp_merge },\n\t[DDP_COMPONENT_MERGE4]\t\t= { MTK_DISP_MERGE,\t\t4, &ddp_merge },\n\t[DDP_COMPONENT_MERGE5]\t\t= { MTK_DISP_MERGE,\t\t5, &ddp_merge },\n\t[DDP_COMPONENT_OD0]\t\t= { MTK_DISP_OD,\t\t0, &ddp_od },\n\t[DDP_COMPONENT_OD1]\t\t= { MTK_DISP_OD,\t\t1, &ddp_od },\n\t[DDP_COMPONENT_OVL0]\t\t= { MTK_DISP_OVL,\t\t0, &ddp_ovl },\n\t[DDP_COMPONENT_OVL1]\t\t= { MTK_DISP_OVL,\t\t1, &ddp_ovl },\n\t[DDP_COMPONENT_OVL_2L0]\t\t= { MTK_DISP_OVL_2L,\t\t0, &ddp_ovl },\n\t[DDP_COMPONENT_OVL_2L1]\t\t= { MTK_DISP_OVL_2L,\t\t1, &ddp_ovl },\n\t[DDP_COMPONENT_OVL_2L2]\t\t= { MTK_DISP_OVL_2L,\t\t2, &ddp_ovl },\n\t[DDP_COMPONENT_POSTMASK0]\t= { MTK_DISP_POSTMASK,\t\t0, &ddp_postmask },\n\t[DDP_COMPONENT_PWM0]\t\t= { MTK_DISP_PWM,\t\t0, NULL },\n\t[DDP_COMPONENT_PWM1]\t\t= { MTK_DISP_PWM,\t\t1, NULL },\n\t[DDP_COMPONENT_PWM2]\t\t= { MTK_DISP_PWM,\t\t2, NULL },\n\t[DDP_COMPONENT_RDMA0]\t\t= { MTK_DISP_RDMA,\t\t0, &ddp_rdma },\n\t[DDP_COMPONENT_RDMA1]\t\t= { MTK_DISP_RDMA,\t\t1, &ddp_rdma },\n\t[DDP_COMPONENT_RDMA2]\t\t= { MTK_DISP_RDMA,\t\t2, &ddp_rdma },\n\t[DDP_COMPONENT_RDMA4]\t\t= { MTK_DISP_RDMA,\t\t4, &ddp_rdma },\n\t[DDP_COMPONENT_UFOE]\t\t= { MTK_DISP_UFOE,\t\t0, &ddp_ufoe },\n\t[DDP_COMPONENT_WDMA0]\t\t= { MTK_DISP_WDMA,\t\t0, NULL },\n\t[DDP_COMPONENT_WDMA1]\t\t= { MTK_DISP_WDMA,\t\t1, NULL },\n};\n\nstatic bool mtk_drm_find_comp_in_ddp(struct device *dev,\n\t\t\t\t     const unsigned int *path,\n\t\t\t\t     unsigned int path_len,\n\t\t\t\t     struct mtk_ddp_comp *ddp_comp)\n{\n\tunsigned int i;\n\n\tif (path == NULL)\n\t\treturn false;\n\n\tfor (i = 0U; i < path_len; i++)\n\t\tif (dev == ddp_comp[path[i]].dev)\n\t\t\treturn true;\n\n\treturn false;\n}\n\nint mtk_ddp_comp_get_id(struct device_node *node,\n\t\t\tenum mtk_ddp_comp_type comp_type)\n{\n\tint id = of_alias_get_id(node, mtk_ddp_comp_stem[comp_type]);\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(mtk_ddp_matches); i++) {\n\t\tif (comp_type == mtk_ddp_matches[i].type &&\n\t\t    (id < 0 || id == mtk_ddp_matches[i].alias_id))\n\t\t\treturn i;\n\t}\n\n\treturn -EINVAL;\n}\n\nunsigned int mtk_drm_find_possible_crtc_by_comp(struct drm_device *drm,\n\t\t\t\t\t\tstruct device *dev)\n{\n\tstruct mtk_drm_private *private = drm->dev_private;\n\tunsigned int ret = 0;\n\n\tif (mtk_drm_find_comp_in_ddp(dev, private->data->main_path, private->data->main_len,\n\t\t\t\t     private->ddp_comp))\n\t\tret = BIT(0);\n\telse if (mtk_drm_find_comp_in_ddp(dev, private->data->ext_path,\n\t\t\t\t\t  private->data->ext_len, private->ddp_comp))\n\t\tret = BIT(1);\n\telse if (mtk_drm_find_comp_in_ddp(dev, private->data->third_path,\n\t\t\t\t\t  private->data->third_len, private->ddp_comp))\n\t\tret = BIT(2);\n\telse\n\t\tDRM_INFO(\"Failed to find comp in ddp table\\n\");\n\n\treturn ret;\n}\n\nint mtk_ddp_comp_init(struct device_node *node, struct mtk_ddp_comp *comp,\n\t\t      unsigned int comp_id)\n{\n\tstruct platform_device *comp_pdev;\n\tenum mtk_ddp_comp_type type;\n\tstruct mtk_ddp_comp_dev *priv;\n#if IS_REACHABLE(CONFIG_MTK_CMDQ)\n\tint ret;\n#endif\n\n\tif (comp_id < 0 || comp_id >= DDP_COMPONENT_DRM_ID_MAX)\n\t\treturn -EINVAL;\n\n\ttype = mtk_ddp_matches[comp_id].type;\n\n\tcomp->id = comp_id;\n\tcomp->funcs = mtk_ddp_matches[comp_id].funcs;\n\t \n\tif (!node)\n\t\treturn 0;\n\n\tcomp_pdev = of_find_device_by_node(node);\n\tif (!comp_pdev) {\n\t\tDRM_INFO(\"Waiting for device %s\\n\", node->full_name);\n\t\treturn -EPROBE_DEFER;\n\t}\n\tcomp->dev = &comp_pdev->dev;\n\n\tif (type == MTK_DISP_AAL ||\n\t    type == MTK_DISP_BLS ||\n\t    type == MTK_DISP_CCORR ||\n\t    type == MTK_DISP_COLOR ||\n\t    type == MTK_DISP_GAMMA ||\n\t    type == MTK_DISP_MERGE ||\n\t    type == MTK_DISP_OVL ||\n\t    type == MTK_DISP_OVL_2L ||\n\t    type == MTK_DISP_PWM ||\n\t    type == MTK_DISP_RDMA ||\n\t    type == MTK_DPI ||\n\t    type == MTK_DP_INTF ||\n\t    type == MTK_DSI)\n\t\treturn 0;\n\n\tpriv = devm_kzalloc(comp->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->regs = of_iomap(node, 0);\n\tpriv->clk = of_clk_get(node, 0);\n\tif (IS_ERR(priv->clk))\n\t\treturn PTR_ERR(priv->clk);\n\n#if IS_REACHABLE(CONFIG_MTK_CMDQ)\n\tret = cmdq_dev_get_client_reg(comp->dev, &priv->cmdq_reg, 0);\n\tif (ret)\n\t\tdev_dbg(comp->dev, \"get mediatek,gce-client-reg fail!\\n\");\n#endif\n\n\tplatform_set_drvdata(comp_pdev, priv);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}