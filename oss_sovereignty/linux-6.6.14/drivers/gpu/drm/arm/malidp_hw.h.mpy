{
  "module_name": "malidp_hw.h",
  "hash_id": "bf9cd5ea76c40d526288f53b64873f67bf8914a5aa2606bfa98793d01b5fa8fb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/arm/malidp_hw.h",
  "human_readable_source": " \n \n\n#ifndef __MALIDP_HW_H__\n#define __MALIDP_HW_H__\n\n#include <linux/bitops.h>\n#include \"malidp_regs.h\"\n\nstruct videomode;\nstruct clk;\n\n \nenum {\n\tMALIDP_DE_BLOCK = 0,\n\tMALIDP_SE_BLOCK,\n\tMALIDP_DC_BLOCK\n};\n\n \nenum {\n\tDE_VIDEO1 = BIT(0),\n\tDE_GRAPHICS1 = BIT(1),\n\tDE_GRAPHICS2 = BIT(2),  \n\tDE_VIDEO2 = BIT(3),\n\tDE_SMART = BIT(4),\n\tSE_MEMWRITE = BIT(5),\n};\n\nenum rotation_features {\n\tROTATE_NONE,\t\t \n\tROTATE_ANY,\t\t \n\tROTATE_COMPRESSED,\t \n};\n\nstruct malidp_format_id {\n\tu32 format;\t\t \n\tu8 layer;\t\t \n\tu8 id;\t\t\t \n};\n\n#define MALIDP_INVALID_FORMAT_ID\t0xff\n\n \n\nstruct malidp_irq_map {\n\tu32 irq_mask;\t\t \n\tu32 vsync_irq;\t\t \n\tu32 err_mask;\t\t \n};\n\nstruct malidp_layer {\n\tu16 id;\t\t\t \n\tu16 base;\t\t \n\tu16 ptr;\t\t \n\tu16 stride_offset;\t \n\ts16 yuv2rgb_offset;\t \n\tu16 mmu_ctrl_offset;     \n\tenum rotation_features rot;\t \n\t \n\tu16 afbc_decoder_offset;\n};\n\nenum malidp_scaling_coeff_set {\n\tMALIDP_UPSCALING_COEFFS = 1,\n\tMALIDP_DOWNSCALING_1_5_COEFFS = 2,\n\tMALIDP_DOWNSCALING_2_COEFFS = 3,\n\tMALIDP_DOWNSCALING_2_75_COEFFS = 4,\n\tMALIDP_DOWNSCALING_4_COEFFS = 5,\n};\n\nstruct malidp_se_config {\n\tu8 scale_enable : 1;\n\tu8 enhancer_enable : 1;\n\tu8 hcoeff : 3;\n\tu8 vcoeff : 3;\n\tu8 plane_src_id;\n\tu16 input_w, input_h;\n\tu16 output_w, output_h;\n\tu32 h_init_phase, h_delta_phase;\n\tu32 v_init_phase, v_delta_phase;\n};\n\n \n#define MALIDP_REGMAP_HAS_CLEARIRQ\t\t\t\tBIT(0)\n#define MALIDP_DEVICE_AFBC_SUPPORT_SPLIT\t\t\tBIT(1)\n#define MALIDP_DEVICE_AFBC_YUV_420_10_SUPPORT_SPLIT\t\tBIT(2)\n#define MALIDP_DEVICE_AFBC_YUYV_USE_422_P2\t\t\tBIT(3)\n\nstruct malidp_hw_regmap {\n\t \n\t \n\t \n\tconst u16 coeffs_base;\n\t \n\tconst u16 se_base;\n\t \n\tconst u16 dc_base;\n\n\t \n\tconst u16 out_depth_base;\n\n\t \n\tconst u8 features;\n\n\t \n\tconst u8 n_layers;\n\tconst struct malidp_layer *layers;\n\n\tconst struct malidp_irq_map de_irq_map;\n\tconst struct malidp_irq_map se_irq_map;\n\tconst struct malidp_irq_map dc_irq_map;\n\n\t \n\tconst struct malidp_format_id *pixel_formats;\n\tconst u8 n_pixel_formats;\n\n\t \n\tconst u8 bus_align_bytes;\n};\n\n \n \n#define MALIDP_DEVICE_LV_HAS_3_STRIDES\tBIT(0)\n\nstruct malidp_hw_device;\n\n \nstruct malidp_hw {\n\tconst struct malidp_hw_regmap map;\n\n\t \n\tint (*query_hw)(struct malidp_hw_device *hwdev);\n\n\t \n\tvoid (*enter_config_mode)(struct malidp_hw_device *hwdev);\n\n\t \n\tvoid (*leave_config_mode)(struct malidp_hw_device *hwdev);\n\n\t \n\tbool (*in_config_mode)(struct malidp_hw_device *hwdev);\n\n\t \n\tvoid (*set_config_valid)(struct malidp_hw_device *hwdev, u8 value);\n\n\t \n\tvoid (*modeset)(struct malidp_hw_device *hwdev, struct videomode *m);\n\n\t \n\tint (*rotmem_required)(struct malidp_hw_device *hwdev, u16 w, u16 h,\n\t\t\t       u32 fmt, bool has_modifier);\n\n\tint (*se_set_scaling_coeffs)(struct malidp_hw_device *hwdev,\n\t\t\t\t     struct malidp_se_config *se_config,\n\t\t\t\t     struct malidp_se_config *old_config);\n\n\tlong (*se_calc_mclk)(struct malidp_hw_device *hwdev,\n\t\t\t     struct malidp_se_config *se_config,\n\t\t\t     struct videomode *vm);\n\t \n\tint (*enable_memwrite)(struct malidp_hw_device *hwdev, dma_addr_t *addrs,\n\t\t\t       s32 *pitches, int num_planes, u16 w, u16 h, u32 fmt_id,\n\t\t\t       const s16 *rgb2yuv_coeffs);\n\n\t \n\tvoid (*disable_memwrite)(struct malidp_hw_device *hwdev);\n\n\tu8 features;\n};\n\n \nenum {\n\tMALIDP_500 = 0,\n\tMALIDP_550,\n\tMALIDP_650,\n\t \n\tMALIDP_MAX_DEVICES\n};\n\nextern const struct malidp_hw malidp_device[MALIDP_MAX_DEVICES];\n\n \nstruct malidp_hw_device {\n\tstruct malidp_hw *hw;\n\tvoid __iomem *regs;\n\n\t \n\tstruct clk *pclk;\n\t \n\tstruct clk *aclk;\n\t \n\tstruct clk *mclk;\n\t \n\tstruct clk *pxlclk;\n\n\tu8 min_line_size;\n\tu16 max_line_size;\n\tu32 output_color_depth;\n\n\t \n\tbool pm_suspended;\n\n\t \n\tu8 mw_state;\n\n\t \n\tu32 rotation_memory[2];\n\n\t \n\tu32 arqos_value;\n};\n\nstatic inline u32 malidp_hw_read(struct malidp_hw_device *hwdev, u32 reg)\n{\n\tWARN_ON(hwdev->pm_suspended);\n\treturn readl(hwdev->regs + reg);\n}\n\nstatic inline void malidp_hw_write(struct malidp_hw_device *hwdev,\n\t\t\t\t   u32 value, u32 reg)\n{\n\tWARN_ON(hwdev->pm_suspended);\n\twritel(value, hwdev->regs + reg);\n}\n\nstatic inline void malidp_hw_setbits(struct malidp_hw_device *hwdev,\n\t\t\t\t     u32 mask, u32 reg)\n{\n\tu32 data = malidp_hw_read(hwdev, reg);\n\n\tdata |= mask;\n\tmalidp_hw_write(hwdev, data, reg);\n}\n\nstatic inline void malidp_hw_clearbits(struct malidp_hw_device *hwdev,\n\t\t\t\t       u32 mask, u32 reg)\n{\n\tu32 data = malidp_hw_read(hwdev, reg);\n\n\tdata &= ~mask;\n\tmalidp_hw_write(hwdev, data, reg);\n}\n\nstatic inline u32 malidp_get_block_base(struct malidp_hw_device *hwdev,\n\t\t\t\t\tu8 block)\n{\n\tswitch (block) {\n\tcase MALIDP_SE_BLOCK:\n\t\treturn hwdev->hw->map.se_base;\n\tcase MALIDP_DC_BLOCK:\n\t\treturn hwdev->hw->map.dc_base;\n\t}\n\n\treturn 0;\n}\n\nstatic inline void malidp_hw_disable_irq(struct malidp_hw_device *hwdev,\n\t\t\t\t\t u8 block, u32 irq)\n{\n\tu32 base = malidp_get_block_base(hwdev, block);\n\n\tmalidp_hw_clearbits(hwdev, irq, base + MALIDP_REG_MASKIRQ);\n}\n\nstatic inline void malidp_hw_enable_irq(struct malidp_hw_device *hwdev,\n\t\t\t\t\tu8 block, u32 irq)\n{\n\tu32 base = malidp_get_block_base(hwdev, block);\n\n\tmalidp_hw_setbits(hwdev, irq, base + MALIDP_REG_MASKIRQ);\n}\n\nint malidp_de_irq_init(struct drm_device *drm, int irq);\nvoid malidp_se_irq_hw_init(struct malidp_hw_device *hwdev);\nvoid malidp_de_irq_hw_init(struct malidp_hw_device *hwdev);\nvoid malidp_de_irq_fini(struct malidp_hw_device *hwdev);\nint malidp_se_irq_init(struct drm_device *drm, int irq);\nvoid malidp_se_irq_fini(struct malidp_hw_device *hwdev);\n\nu8 malidp_hw_get_format_id(const struct malidp_hw_regmap *map,\n\t\t\t   u8 layer_id, u32 format, bool has_modifier);\n\nint malidp_format_get_bpp(u32 fmt);\n\nstatic inline u8 malidp_hw_get_pitch_align(struct malidp_hw_device *hwdev, bool rotated)\n{\n\t \n\tif (hwdev->hw->map.bus_align_bytes == 8)\n\t\treturn 8;\n\telse\n\t\treturn hwdev->hw->map.bus_align_bytes << (rotated ? 2 : 0);\n}\n\n \n#define FP_1_00000\t0x00010000\t \n#define FP_0_66667\t0x0000AAAA\t \n#define FP_0_50000\t0x00008000\t \n#define FP_0_36363\t0x00005D17\t \n#define FP_0_25000\t0x00004000\t \n\nstatic inline enum malidp_scaling_coeff_set\nmalidp_se_select_coeffs(u32 upscale_factor)\n{\n\treturn (upscale_factor >= FP_1_00000) ? MALIDP_UPSCALING_COEFFS :\n\t       (upscale_factor >= FP_0_66667) ? MALIDP_DOWNSCALING_1_5_COEFFS :\n\t       (upscale_factor >= FP_0_50000) ? MALIDP_DOWNSCALING_2_COEFFS :\n\t       (upscale_factor >= FP_0_36363) ? MALIDP_DOWNSCALING_2_75_COEFFS :\n\t       MALIDP_DOWNSCALING_4_COEFFS;\n}\n\n#undef FP_0_25000\n#undef FP_0_36363\n#undef FP_0_50000\n#undef FP_0_66667\n#undef FP_1_00000\n\nstatic inline void malidp_se_set_enh_coeffs(struct malidp_hw_device *hwdev)\n{\n\tstatic const s32 enhancer_coeffs[] = {\n\t\t-8, -8, -8, -8, 128, -8, -8, -8, -8\n\t};\n\tu32 val = MALIDP_SE_SET_ENH_LIMIT_LOW(MALIDP_SE_ENH_LOW_LEVEL) |\n\t\t  MALIDP_SE_SET_ENH_LIMIT_HIGH(MALIDP_SE_ENH_HIGH_LEVEL);\n\tu32 image_enh = hwdev->hw->map.se_base +\n\t\t\t((hwdev->hw->map.features & MALIDP_REGMAP_HAS_CLEARIRQ) ?\n\t\t\t 0x10 : 0xC) + MALIDP_SE_IMAGE_ENH;\n\tu32 enh_coeffs = image_enh + MALIDP_SE_ENH_COEFF0;\n\tint i;\n\n\tmalidp_hw_write(hwdev, val, image_enh);\n\tfor (i = 0; i < ARRAY_SIZE(enhancer_coeffs); ++i)\n\t\tmalidp_hw_write(hwdev, enhancer_coeffs[i], enh_coeffs + i * 4);\n}\n\n \n#define MALIDP_BGND_COLOR_R\t\t0x000\n#define MALIDP_BGND_COLOR_G\t\t0x000\n#define MALIDP_BGND_COLOR_B\t\t0x000\n\n#define MALIDP_COLORADJ_NUM_COEFFS\t12\n#define MALIDP_COEFFTAB_NUM_COEFFS\t64\n\n#define MALIDP_GAMMA_LUT_SIZE\t\t4096\n\n#define AFBC_SIZE_MASK\t\tAFBC_FORMAT_MOD_BLOCK_SIZE_MASK\n#define AFBC_SIZE_16X16\t\tAFBC_FORMAT_MOD_BLOCK_SIZE_16x16\n#define AFBC_YTR\t\tAFBC_FORMAT_MOD_YTR\n#define AFBC_SPARSE\t\tAFBC_FORMAT_MOD_SPARSE\n#define AFBC_CBR\t\tAFBC_FORMAT_MOD_CBR\n#define AFBC_SPLIT\t\tAFBC_FORMAT_MOD_SPLIT\n#define AFBC_TILED\t\tAFBC_FORMAT_MOD_TILED\n#define AFBC_SC\t\t\tAFBC_FORMAT_MOD_SC\n\n#define AFBC_MOD_VALID_BITS\t(AFBC_SIZE_MASK | AFBC_YTR | AFBC_SPLIT | \\\n\t\t\t\t AFBC_SPARSE | AFBC_CBR | AFBC_TILED | AFBC_SC)\n\nextern const u64 malidp_format_modifiers[];\n\n#endif   \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}