{
  "module_name": "malidp_hw.c",
  "hash_id": "faec5ce497ce6056d0c40aab2ad060614cb65370427ec6db3b8005454fc92794",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/arm/malidp_hw.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/types.h>\n#include <linux/io.h>\n\n#include <video/videomode.h>\n#include <video/display_timing.h>\n\n#include <drm/drm_fourcc.h>\n#include <drm/drm_vblank.h>\n#include <drm/drm_print.h>\n\n#include \"malidp_drv.h\"\n#include \"malidp_hw.h\"\n#include \"malidp_mw.h\"\n\nenum {\n\tMW_NOT_ENABLED = 0,\t \n\tMW_ONESHOT,\t\t \n\tMW_START,\t\t \n\tMW_RESTART,\t\t \n\tMW_STOP,\t\t \n};\n\nstatic const struct malidp_format_id malidp500_de_formats[] = {\n\t \n\t{ DRM_FORMAT_ARGB2101010, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2 | SE_MEMWRITE,  0 },\n\t{ DRM_FORMAT_ABGR2101010, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2 | SE_MEMWRITE,  1 },\n\t{ DRM_FORMAT_ARGB8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2,  2 },\n\t{ DRM_FORMAT_ABGR8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2,  3 },\n\t{ DRM_FORMAT_XRGB8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2 | SE_MEMWRITE,  4 },\n\t{ DRM_FORMAT_XBGR8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2 | SE_MEMWRITE,  5 },\n\t{ DRM_FORMAT_RGB888, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2,  6 },\n\t{ DRM_FORMAT_BGR888, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2,  7 },\n\t{ DRM_FORMAT_RGBA5551, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2,  8 },\n\t{ DRM_FORMAT_ABGR1555, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2,  9 },\n\t{ DRM_FORMAT_RGB565, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2, 10 },\n\t{ DRM_FORMAT_BGR565, DE_VIDEO1 | DE_GRAPHICS1 | DE_GRAPHICS2, 11 },\n\t{ DRM_FORMAT_UYVY, DE_VIDEO1, 12 },\n\t{ DRM_FORMAT_YUYV, DE_VIDEO1, 13 },\n\t{ DRM_FORMAT_NV12, DE_VIDEO1 | SE_MEMWRITE, 14 },\n\t{ DRM_FORMAT_YUV420, DE_VIDEO1, 15 },\n\t{ DRM_FORMAT_XYUV8888, DE_VIDEO1, 16 },\n\t \n\t{ DRM_FORMAT_YUV420_8BIT, DE_VIDEO1, 14 },\n\t{ DRM_FORMAT_VUY888, DE_VIDEO1, 16 },\n\t{ DRM_FORMAT_VUY101010, DE_VIDEO1, 17 },\n\t{ DRM_FORMAT_YUV420_10BIT, DE_VIDEO1, 18 }\n};\n\n#define MALIDP_ID(__group, __format) \\\n\t((((__group) & 0x7) << 3) | ((__format) & 0x7))\n\n#define AFBC_YUV_422_FORMAT_ID\tMALIDP_ID(5, 1)\n\n#define MALIDP_COMMON_FORMATS \\\n\t  \\\n\t{ DRM_FORMAT_ARGB2101010, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | SE_MEMWRITE, MALIDP_ID(0, 0) }, \\\n\t{ DRM_FORMAT_ABGR2101010, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | SE_MEMWRITE, MALIDP_ID(0, 1) }, \\\n\t{ DRM_FORMAT_RGBA1010102, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | SE_MEMWRITE, MALIDP_ID(0, 2) }, \\\n\t{ DRM_FORMAT_BGRA1010102, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | SE_MEMWRITE, MALIDP_ID(0, 3) }, \\\n\t{ DRM_FORMAT_ARGB8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | DE_SMART, MALIDP_ID(1, 0) }, \\\n\t{ DRM_FORMAT_ABGR8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | DE_SMART, MALIDP_ID(1, 1) }, \\\n\t{ DRM_FORMAT_RGBA8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | DE_SMART, MALIDP_ID(1, 2) }, \\\n\t{ DRM_FORMAT_BGRA8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | DE_SMART, MALIDP_ID(1, 3) }, \\\n\t{ DRM_FORMAT_XRGB8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | DE_SMART | SE_MEMWRITE, MALIDP_ID(2, 0) }, \\\n\t{ DRM_FORMAT_XBGR8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | DE_SMART | SE_MEMWRITE, MALIDP_ID(2, 1) }, \\\n\t{ DRM_FORMAT_RGBX8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | DE_SMART | SE_MEMWRITE, MALIDP_ID(2, 2) }, \\\n\t{ DRM_FORMAT_BGRX8888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | DE_SMART | SE_MEMWRITE, MALIDP_ID(2, 3) }, \\\n\t{ DRM_FORMAT_RGB888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | SE_MEMWRITE, MALIDP_ID(3, 0) }, \\\n\t{ DRM_FORMAT_BGR888, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2 | SE_MEMWRITE, MALIDP_ID(3, 1) }, \\\n\t{ DRM_FORMAT_RGBA5551, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2, MALIDP_ID(4, 0) }, \\\n\t{ DRM_FORMAT_ABGR1555, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2, MALIDP_ID(4, 1) }, \\\n\t{ DRM_FORMAT_RGB565, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2, MALIDP_ID(4, 2) }, \\\n\t{ DRM_FORMAT_BGR565, DE_VIDEO1 | DE_GRAPHICS1 | DE_VIDEO2, MALIDP_ID(4, 3) }, \\\n\t \t\\\n\t{ DRM_FORMAT_XYUV8888, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(5, 0) },\\\n\t \t\t\\\n\t{ DRM_FORMAT_VUY888, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(5, 0) }, \\\n\t{ DRM_FORMAT_YUYV, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(5, 2) },\t\\\n\t  \\\n\t{ DRM_FORMAT_UYVY, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(5, 3) },\t\\\n\t{ DRM_FORMAT_NV12, DE_VIDEO1 | DE_VIDEO2 | SE_MEMWRITE, MALIDP_ID(5, 6) },\t\\\n\t  \\\n\t{ DRM_FORMAT_YUV420_8BIT, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(5, 6) }, \\\n\t{ DRM_FORMAT_YUV420, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(5, 7) }, \\\n\t  \\\n\t{ DRM_FORMAT_XVYU2101010, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(6, 0)}, \\\n\t  \\\n\t{ DRM_FORMAT_VUY101010, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(6, 0)}, \\\n\t{ DRM_FORMAT_X0L2, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(6, 6)}, \\\n\t  \\\n\t{ DRM_FORMAT_YUV420_10BIT, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(6, 7)}, \\\n\t{ DRM_FORMAT_P010, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(6, 7)}\n\nstatic const struct malidp_format_id malidp550_de_formats[] = {\n\tMALIDP_COMMON_FORMATS,\n};\n\nstatic const struct malidp_format_id malidp650_de_formats[] = {\n\tMALIDP_COMMON_FORMATS,\n\t{ DRM_FORMAT_X0L0, DE_VIDEO1 | DE_VIDEO2, MALIDP_ID(5, 4)},\n};\n\nstatic const struct malidp_layer malidp500_layers[] = {\n\t \n\t{ DE_VIDEO1, MALIDP500_DE_LV_BASE, MALIDP500_DE_LV_PTR_BASE,\n\t\tMALIDP_DE_LV_STRIDE0, MALIDP500_LV_YUV2RGB, 0, ROTATE_ANY,\n\t\tMALIDP500_DE_LV_AD_CTRL },\n\t{ DE_GRAPHICS1, MALIDP500_DE_LG1_BASE, MALIDP500_DE_LG1_PTR_BASE,\n\t\tMALIDP_DE_LG_STRIDE, 0, 0, ROTATE_ANY,\n\t\tMALIDP500_DE_LG1_AD_CTRL },\n\t{ DE_GRAPHICS2, MALIDP500_DE_LG2_BASE, MALIDP500_DE_LG2_PTR_BASE,\n\t\tMALIDP_DE_LG_STRIDE, 0, 0, ROTATE_ANY,\n\t\tMALIDP500_DE_LG2_AD_CTRL },\n};\n\nstatic const struct malidp_layer malidp550_layers[] = {\n\t \n\t{ DE_VIDEO1, MALIDP550_DE_LV1_BASE, MALIDP550_DE_LV1_PTR_BASE,\n\t\tMALIDP_DE_LV_STRIDE0, MALIDP550_LV_YUV2RGB, 0, ROTATE_ANY,\n\t\tMALIDP550_DE_LV1_AD_CTRL },\n\t{ DE_GRAPHICS1, MALIDP550_DE_LG_BASE, MALIDP550_DE_LG_PTR_BASE,\n\t\tMALIDP_DE_LG_STRIDE, 0, 0, ROTATE_ANY,\n\t\tMALIDP550_DE_LG_AD_CTRL },\n\t{ DE_VIDEO2, MALIDP550_DE_LV2_BASE, MALIDP550_DE_LV2_PTR_BASE,\n\t\tMALIDP_DE_LV_STRIDE0, MALIDP550_LV_YUV2RGB, 0, ROTATE_ANY,\n\t\tMALIDP550_DE_LV2_AD_CTRL },\n\t{ DE_SMART, MALIDP550_DE_LS_BASE, MALIDP550_DE_LS_PTR_BASE,\n\t\tMALIDP550_DE_LS_R1_STRIDE, 0, 0, ROTATE_NONE, 0 },\n};\n\nstatic const struct malidp_layer malidp650_layers[] = {\n\t \n\t{ DE_VIDEO1, MALIDP550_DE_LV1_BASE, MALIDP550_DE_LV1_PTR_BASE,\n\t\tMALIDP_DE_LV_STRIDE0, MALIDP550_LV_YUV2RGB,\n\t\tMALIDP650_DE_LV_MMU_CTRL, ROTATE_ANY,\n\t\tMALIDP550_DE_LV1_AD_CTRL },\n\t{ DE_GRAPHICS1, MALIDP550_DE_LG_BASE, MALIDP550_DE_LG_PTR_BASE,\n\t\tMALIDP_DE_LG_STRIDE, 0, MALIDP650_DE_LG_MMU_CTRL,\n\t\tROTATE_COMPRESSED, MALIDP550_DE_LG_AD_CTRL },\n\t{ DE_VIDEO2, MALIDP550_DE_LV2_BASE, MALIDP550_DE_LV2_PTR_BASE,\n\t\tMALIDP_DE_LV_STRIDE0, MALIDP550_LV_YUV2RGB,\n\t\tMALIDP650_DE_LV_MMU_CTRL, ROTATE_ANY,\n\t\tMALIDP550_DE_LV2_AD_CTRL },\n\t{ DE_SMART, MALIDP550_DE_LS_BASE, MALIDP550_DE_LS_PTR_BASE,\n\t\tMALIDP550_DE_LS_R1_STRIDE, 0, MALIDP650_DE_LS_MMU_CTRL,\n\t\tROTATE_NONE, 0 },\n};\n\nconst u64 malidp_format_modifiers[] = {\n\t \n\tDRM_FORMAT_MOD_ARM_AFBC(AFBC_SIZE_16X16 | AFBC_YTR | AFBC_SPARSE),\n\tDRM_FORMAT_MOD_ARM_AFBC(AFBC_SIZE_16X16 | AFBC_YTR),\n\n\t \n\tDRM_FORMAT_MOD_ARM_AFBC(AFBC_SIZE_16X16 | AFBC_YTR | AFBC_SPARSE | AFBC_SPLIT),\n\n\t \n\t \n\tDRM_FORMAT_MOD_ARM_AFBC(AFBC_SIZE_16X16 | AFBC_SPARSE | AFBC_SPLIT),\n\n\t \n\tDRM_FORMAT_MOD_ARM_AFBC(AFBC_SIZE_16X16 | AFBC_SPARSE),\n\tDRM_FORMAT_MOD_ARM_AFBC(AFBC_SIZE_16X16),\n\n\t \n\tDRM_FORMAT_MOD_ARM_AFBC(AFBC_SIZE_16X16 | AFBC_CBR | AFBC_SPARSE),\n\tDRM_FORMAT_MOD_ARM_AFBC(AFBC_SIZE_16X16 | AFBC_CBR),\n\n\t \n\tDRM_FORMAT_MOD_LINEAR,\n\n\tDRM_FORMAT_MOD_INVALID\n};\n\n#define SE_N_SCALING_COEFFS\t96\nstatic const u16 dp500_se_scaling_coeffs[][SE_N_SCALING_COEFFS] = {\n\t[MALIDP_UPSCALING_COEFFS - 1] = {\n\t\t0x0000, 0x0001, 0x0007, 0x0011, 0x001e, 0x002e, 0x003f, 0x0052,\n\t\t0x0064, 0x0073, 0x007d, 0x0080, 0x007a, 0x006c, 0x0053, 0x002f,\n\t\t0x0000, 0x3fc6, 0x3f83, 0x3f39, 0x3eea, 0x3e9b, 0x3e4f, 0x3e0a,\n\t\t0x3dd4, 0x3db0, 0x3da2, 0x3db1, 0x3dde, 0x3e2f, 0x3ea5, 0x3f40,\n\t\t0x0000, 0x00e5, 0x01ee, 0x0315, 0x0456, 0x05aa, 0x0709, 0x086c,\n\t\t0x09c9, 0x0b15, 0x0c4a, 0x0d5d, 0x0e4a, 0x0f06, 0x0f91, 0x0fe5,\n\t\t0x1000, 0x0fe5, 0x0f91, 0x0f06, 0x0e4a, 0x0d5d, 0x0c4a, 0x0b15,\n\t\t0x09c9, 0x086c, 0x0709, 0x05aa, 0x0456, 0x0315, 0x01ee, 0x00e5,\n\t\t0x0000, 0x3f40, 0x3ea5, 0x3e2f, 0x3dde, 0x3db1, 0x3da2, 0x3db0,\n\t\t0x3dd4, 0x3e0a, 0x3e4f, 0x3e9b, 0x3eea, 0x3f39, 0x3f83, 0x3fc6,\n\t\t0x0000, 0x002f, 0x0053, 0x006c, 0x007a, 0x0080, 0x007d, 0x0073,\n\t\t0x0064, 0x0052, 0x003f, 0x002e, 0x001e, 0x0011, 0x0007, 0x0001\n\t},\n\t[MALIDP_DOWNSCALING_1_5_COEFFS - 1] = {\n\t\t0x0059, 0x004f, 0x0041, 0x002e, 0x0016, 0x3ffb, 0x3fd9, 0x3fb4,\n\t\t0x3f8c, 0x3f62, 0x3f36, 0x3f09, 0x3edd, 0x3eb3, 0x3e8d, 0x3e6c,\n\t\t0x3e52, 0x3e3f, 0x3e35, 0x3e37, 0x3e46, 0x3e61, 0x3e8c, 0x3ec5,\n\t\t0x3f0f, 0x3f68, 0x3fd1, 0x004a, 0x00d3, 0x0169, 0x020b, 0x02b8,\n\t\t0x036e, 0x042d, 0x04f2, 0x05b9, 0x0681, 0x0745, 0x0803, 0x08ba,\n\t\t0x0965, 0x0a03, 0x0a91, 0x0b0d, 0x0b75, 0x0bc6, 0x0c00, 0x0c20,\n\t\t0x0c28, 0x0c20, 0x0c00, 0x0bc6, 0x0b75, 0x0b0d, 0x0a91, 0x0a03,\n\t\t0x0965, 0x08ba, 0x0803, 0x0745, 0x0681, 0x05b9, 0x04f2, 0x042d,\n\t\t0x036e, 0x02b8, 0x020b, 0x0169, 0x00d3, 0x004a, 0x3fd1, 0x3f68,\n\t\t0x3f0f, 0x3ec5, 0x3e8c, 0x3e61, 0x3e46, 0x3e37, 0x3e35, 0x3e3f,\n\t\t0x3e52, 0x3e6c, 0x3e8d, 0x3eb3, 0x3edd, 0x3f09, 0x3f36, 0x3f62,\n\t\t0x3f8c, 0x3fb4, 0x3fd9, 0x3ffb, 0x0016, 0x002e, 0x0041, 0x004f\n\t},\n\t[MALIDP_DOWNSCALING_2_COEFFS - 1] = {\n\t\t0x3f19, 0x3f03, 0x3ef0, 0x3edf, 0x3ed0, 0x3ec5, 0x3ebd, 0x3eb9,\n\t\t0x3eb9, 0x3ebf, 0x3eca, 0x3ed9, 0x3eef, 0x3f0a, 0x3f2c, 0x3f52,\n\t\t0x3f7f, 0x3fb0, 0x3fe8, 0x0026, 0x006a, 0x00b4, 0x0103, 0x0158,\n\t\t0x01b1, 0x020d, 0x026c, 0x02cd, 0x032f, 0x0392, 0x03f4, 0x0455,\n\t\t0x04b4, 0x051e, 0x0585, 0x05eb, 0x064c, 0x06a8, 0x06fe, 0x074e,\n\t\t0x0796, 0x07d5, 0x080c, 0x0839, 0x085c, 0x0875, 0x0882, 0x0887,\n\t\t0x0881, 0x0887, 0x0882, 0x0875, 0x085c, 0x0839, 0x080c, 0x07d5,\n\t\t0x0796, 0x074e, 0x06fe, 0x06a8, 0x064c, 0x05eb, 0x0585, 0x051e,\n\t\t0x04b4, 0x0455, 0x03f4, 0x0392, 0x032f, 0x02cd, 0x026c, 0x020d,\n\t\t0x01b1, 0x0158, 0x0103, 0x00b4, 0x006a, 0x0026, 0x3fe8, 0x3fb0,\n\t\t0x3f7f, 0x3f52, 0x3f2c, 0x3f0a, 0x3eef, 0x3ed9, 0x3eca, 0x3ebf,\n\t\t0x3eb9, 0x3eb9, 0x3ebd, 0x3ec5, 0x3ed0, 0x3edf, 0x3ef0, 0x3f03\n\t},\n\t[MALIDP_DOWNSCALING_2_75_COEFFS - 1] = {\n\t\t0x3f51, 0x3f60, 0x3f71, 0x3f84, 0x3f98, 0x3faf, 0x3fc8, 0x3fe3,\n\t\t0x0000, 0x001f, 0x0040, 0x0064, 0x008a, 0x00b1, 0x00da, 0x0106,\n\t\t0x0133, 0x0160, 0x018e, 0x01bd, 0x01ec, 0x021d, 0x024e, 0x0280,\n\t\t0x02b2, 0x02e4, 0x0317, 0x0349, 0x037c, 0x03ad, 0x03df, 0x0410,\n\t\t0x0440, 0x0468, 0x048f, 0x04b3, 0x04d6, 0x04f8, 0x0516, 0x0533,\n\t\t0x054e, 0x0566, 0x057c, 0x0590, 0x05a0, 0x05ae, 0x05ba, 0x05c3,\n\t\t0x05c9, 0x05c3, 0x05ba, 0x05ae, 0x05a0, 0x0590, 0x057c, 0x0566,\n\t\t0x054e, 0x0533, 0x0516, 0x04f8, 0x04d6, 0x04b3, 0x048f, 0x0468,\n\t\t0x0440, 0x0410, 0x03df, 0x03ad, 0x037c, 0x0349, 0x0317, 0x02e4,\n\t\t0x02b2, 0x0280, 0x024e, 0x021d, 0x01ec, 0x01bd, 0x018e, 0x0160,\n\t\t0x0133, 0x0106, 0x00da, 0x00b1, 0x008a, 0x0064, 0x0040, 0x001f,\n\t\t0x0000, 0x3fe3, 0x3fc8, 0x3faf, 0x3f98, 0x3f84, 0x3f71, 0x3f60\n\t},\n\t[MALIDP_DOWNSCALING_4_COEFFS - 1] = {\n\t\t0x0094, 0x00a9, 0x00be, 0x00d4, 0x00ea, 0x0101, 0x0118, 0x012f,\n\t\t0x0148, 0x0160, 0x017a, 0x0193, 0x01ae, 0x01c8, 0x01e4, 0x01ff,\n\t\t0x021c, 0x0233, 0x024a, 0x0261, 0x0278, 0x028f, 0x02a6, 0x02bd,\n\t\t0x02d4, 0x02eb, 0x0302, 0x0319, 0x032f, 0x0346, 0x035d, 0x0374,\n\t\t0x038a, 0x0397, 0x03a3, 0x03af, 0x03bb, 0x03c6, 0x03d1, 0x03db,\n\t\t0x03e4, 0x03ed, 0x03f6, 0x03fe, 0x0406, 0x040d, 0x0414, 0x041a,\n\t\t0x0420, 0x041a, 0x0414, 0x040d, 0x0406, 0x03fe, 0x03f6, 0x03ed,\n\t\t0x03e4, 0x03db, 0x03d1, 0x03c6, 0x03bb, 0x03af, 0x03a3, 0x0397,\n\t\t0x038a, 0x0374, 0x035d, 0x0346, 0x032f, 0x0319, 0x0302, 0x02eb,\n\t\t0x02d4, 0x02bd, 0x02a6, 0x028f, 0x0278, 0x0261, 0x024a, 0x0233,\n\t\t0x021c, 0x01ff, 0x01e4, 0x01c8, 0x01ae, 0x0193, 0x017a, 0x0160,\n\t\t0x0148, 0x012f, 0x0118, 0x0101, 0x00ea, 0x00d4, 0x00be, 0x00a9\n\t},\n};\n\n#define MALIDP_DE_DEFAULT_PREFETCH_START\t5\n\nstatic int malidp500_query_hw(struct malidp_hw_device *hwdev)\n{\n\tu32 conf = malidp_hw_read(hwdev, MALIDP500_CONFIG_ID);\n\t \n\tu8 ln_size_mult = conf & 0x10 ? 2 : 1;\n\n\thwdev->min_line_size = 2;\n\thwdev->max_line_size = SZ_2K * ln_size_mult;\n\thwdev->rotation_memory[0] = SZ_1K * 64 * ln_size_mult;\n\thwdev->rotation_memory[1] = 0;  \n\n\treturn 0;\n}\n\nstatic void malidp500_enter_config_mode(struct malidp_hw_device *hwdev)\n{\n\tu32 status, count = 100;\n\n\tmalidp_hw_setbits(hwdev, MALIDP500_DC_CONFIG_REQ, MALIDP500_DC_CONTROL);\n\twhile (count) {\n\t\tstatus = malidp_hw_read(hwdev, hwdev->hw->map.dc_base + MALIDP_REG_STATUS);\n\t\tif ((status & MALIDP500_DC_CONFIG_REQ) == MALIDP500_DC_CONFIG_REQ)\n\t\t\tbreak;\n\t\t \n\t\tusleep_range(1000, 10000);\n\t\tcount--;\n\t}\n\tWARN(count == 0, \"timeout while entering config mode\");\n}\n\nstatic void malidp500_leave_config_mode(struct malidp_hw_device *hwdev)\n{\n\tu32 status, count = 100;\n\n\tmalidp_hw_clearbits(hwdev, MALIDP_CFG_VALID, MALIDP500_CONFIG_VALID);\n\tmalidp_hw_clearbits(hwdev, MALIDP500_DC_CONFIG_REQ, MALIDP500_DC_CONTROL);\n\twhile (count) {\n\t\tstatus = malidp_hw_read(hwdev, hwdev->hw->map.dc_base + MALIDP_REG_STATUS);\n\t\tif ((status & MALIDP500_DC_CONFIG_REQ) == 0)\n\t\t\tbreak;\n\t\tusleep_range(100, 1000);\n\t\tcount--;\n\t}\n\tWARN(count == 0, \"timeout while leaving config mode\");\n}\n\nstatic bool malidp500_in_config_mode(struct malidp_hw_device *hwdev)\n{\n\tu32 status;\n\n\tstatus = malidp_hw_read(hwdev, hwdev->hw->map.dc_base + MALIDP_REG_STATUS);\n\tif ((status & MALIDP500_DC_CONFIG_REQ) == MALIDP500_DC_CONFIG_REQ)\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic void malidp500_set_config_valid(struct malidp_hw_device *hwdev, u8 value)\n{\n\tif (value)\n\t\tmalidp_hw_setbits(hwdev, MALIDP_CFG_VALID, MALIDP500_CONFIG_VALID);\n\telse\n\t\tmalidp_hw_clearbits(hwdev, MALIDP_CFG_VALID, MALIDP500_CONFIG_VALID);\n}\n\nstatic void malidp500_modeset(struct malidp_hw_device *hwdev, struct videomode *mode)\n{\n\tu32 val = 0;\n\n\tmalidp_hw_write(hwdev, hwdev->output_color_depth,\n\t\thwdev->hw->map.out_depth_base);\n\tmalidp_hw_clearbits(hwdev, MALIDP500_DC_CLEAR_MASK, MALIDP500_DC_CONTROL);\n\tif (mode->flags & DISPLAY_FLAGS_HSYNC_HIGH)\n\t\tval |= MALIDP500_HSYNCPOL;\n\tif (mode->flags & DISPLAY_FLAGS_VSYNC_HIGH)\n\t\tval |= MALIDP500_VSYNCPOL;\n\tval |= MALIDP_DE_DEFAULT_PREFETCH_START;\n\tmalidp_hw_setbits(hwdev, val, MALIDP500_DC_CONTROL);\n\n\t \n\tval = ((MALIDP_BGND_COLOR_G & 0xfff) << 16) |\n\t      (MALIDP_BGND_COLOR_R & 0xfff);\n\tmalidp_hw_write(hwdev, val, MALIDP500_BGND_COLOR);\n\tmalidp_hw_write(hwdev, MALIDP_BGND_COLOR_B, MALIDP500_BGND_COLOR + 4);\n\n\tval = MALIDP_DE_H_FRONTPORCH(mode->hfront_porch) |\n\t\tMALIDP_DE_H_BACKPORCH(mode->hback_porch);\n\tmalidp_hw_write(hwdev, val, MALIDP500_TIMINGS_BASE + MALIDP_DE_H_TIMINGS);\n\n\tval = MALIDP500_DE_V_FRONTPORCH(mode->vfront_porch) |\n\t\tMALIDP_DE_V_BACKPORCH(mode->vback_porch);\n\tmalidp_hw_write(hwdev, val, MALIDP500_TIMINGS_BASE + MALIDP_DE_V_TIMINGS);\n\n\tval = MALIDP_DE_H_SYNCWIDTH(mode->hsync_len) |\n\t\tMALIDP_DE_V_SYNCWIDTH(mode->vsync_len);\n\tmalidp_hw_write(hwdev, val, MALIDP500_TIMINGS_BASE + MALIDP_DE_SYNC_WIDTH);\n\n\tval = MALIDP_DE_H_ACTIVE(mode->hactive) | MALIDP_DE_V_ACTIVE(mode->vactive);\n\tmalidp_hw_write(hwdev, val, MALIDP500_TIMINGS_BASE + MALIDP_DE_HV_ACTIVE);\n\n\tif (mode->flags & DISPLAY_FLAGS_INTERLACED)\n\t\tmalidp_hw_setbits(hwdev, MALIDP_DISP_FUNC_ILACED, MALIDP_DE_DISPLAY_FUNC);\n\telse\n\t\tmalidp_hw_clearbits(hwdev, MALIDP_DISP_FUNC_ILACED, MALIDP_DE_DISPLAY_FUNC);\n\n\t \n\tif (hwdev->arqos_value) {\n\t\tval = hwdev->arqos_value;\n\t\tmalidp_hw_setbits(hwdev, val, MALIDP500_RQOS_QUALITY);\n\t}\n}\n\nint malidp_format_get_bpp(u32 fmt)\n{\n\tconst struct drm_format_info *info = drm_format_info(fmt);\n\tint bpp = info->cpp[0] * 8;\n\n\tif (bpp == 0) {\n\t\tswitch (fmt) {\n\t\tcase DRM_FORMAT_VUY101010:\n\t\t\tbpp = 30;\n\t\t\tbreak;\n\t\tcase DRM_FORMAT_YUV420_10BIT:\n\t\t\tbpp = 15;\n\t\t\tbreak;\n\t\tcase DRM_FORMAT_YUV420_8BIT:\n\t\t\tbpp = 12;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbpp = 0;\n\t\t}\n\t}\n\n\treturn bpp;\n}\n\nstatic int malidp500_rotmem_required(struct malidp_hw_device *hwdev, u16 w,\n\t\t\t\t     u16 h, u32 fmt, bool has_modifier)\n{\n\t \n\tint bpp = malidp_format_get_bpp(fmt);\n\n\treturn w * bpp;\n}\n\nstatic void malidp500_se_write_pp_coefftab(struct malidp_hw_device *hwdev,\n\t\t\t\t\t   u32 direction,\n\t\t\t\t\t   u16 addr,\n\t\t\t\t\t   u8 coeffs_id)\n{\n\tint i;\n\tu16 scaling_control = MALIDP500_SE_CONTROL + MALIDP_SE_SCALING_CONTROL;\n\n\tmalidp_hw_write(hwdev,\n\t\t\tdirection | (addr & MALIDP_SE_COEFFTAB_ADDR_MASK),\n\t\t\tscaling_control + MALIDP_SE_COEFFTAB_ADDR);\n\tfor (i = 0; i < ARRAY_SIZE(dp500_se_scaling_coeffs); ++i)\n\t\tmalidp_hw_write(hwdev, MALIDP_SE_SET_COEFFTAB_DATA(\n\t\t\t\tdp500_se_scaling_coeffs[coeffs_id][i]),\n\t\t\t\tscaling_control + MALIDP_SE_COEFFTAB_DATA);\n}\n\nstatic int malidp500_se_set_scaling_coeffs(struct malidp_hw_device *hwdev,\n\t\t\t\t\t   struct malidp_se_config *se_config,\n\t\t\t\t\t   struct malidp_se_config *old_config)\n{\n\t \n\tu8 h = (u8)se_config->hcoeff - 1;\n\tu8 v = (u8)se_config->vcoeff - 1;\n\n\tif (WARN_ON(h >= ARRAY_SIZE(dp500_se_scaling_coeffs) ||\n\t\t    v >= ARRAY_SIZE(dp500_se_scaling_coeffs)))\n\t\treturn -EINVAL;\n\n\tif ((h == v) && (se_config->hcoeff != old_config->hcoeff ||\n\t\t\t se_config->vcoeff != old_config->vcoeff)) {\n\t\tmalidp500_se_write_pp_coefftab(hwdev,\n\t\t\t\t\t       (MALIDP_SE_V_COEFFTAB |\n\t\t\t\t\t\tMALIDP_SE_H_COEFFTAB),\n\t\t\t\t\t       0, v);\n\t} else {\n\t\tif (se_config->vcoeff != old_config->vcoeff)\n\t\t\tmalidp500_se_write_pp_coefftab(hwdev,\n\t\t\t\t\t\t       MALIDP_SE_V_COEFFTAB,\n\t\t\t\t\t\t       0, v);\n\t\tif (se_config->hcoeff != old_config->hcoeff)\n\t\t\tmalidp500_se_write_pp_coefftab(hwdev,\n\t\t\t\t\t\t       MALIDP_SE_H_COEFFTAB,\n\t\t\t\t\t\t       0, h);\n\t}\n\n\treturn 0;\n}\n\nstatic long malidp500_se_calc_mclk(struct malidp_hw_device *hwdev,\n\t\t\t\t   struct malidp_se_config *se_config,\n\t\t\t\t   struct videomode *vm)\n{\n\tunsigned long mclk;\n\tunsigned long pxlclk = vm->pixelclock;  \n\tunsigned long htotal = vm->hactive + vm->hfront_porch +\n\t\t\t       vm->hback_porch + vm->hsync_len;\n\tunsigned long input_size = se_config->input_w * se_config->input_h;\n\tunsigned long a = 10;\n\tlong ret;\n\n\t \n\tif (se_config->scale_enable) {\n\t\ta = 15 * input_size / (htotal * se_config->output_h);\n\t\tif (a < 15)\n\t\t\ta = 15;\n\t}\n\tmclk = a * pxlclk / 10;\n\tret = clk_get_rate(hwdev->mclk);\n\tif (ret < mclk) {\n\t\tDRM_DEBUG_DRIVER(\"mclk requirement of %lu kHz can't be met.\\n\",\n\t\t\t\t mclk / 1000);\n\t\treturn -EINVAL;\n\t}\n\treturn ret;\n}\n\nstatic int malidp500_enable_memwrite(struct malidp_hw_device *hwdev,\n\t\t\t\t     dma_addr_t *addrs, s32 *pitches,\n\t\t\t\t     int num_planes, u16 w, u16 h, u32 fmt_id,\n\t\t\t\t     const s16 *rgb2yuv_coeffs)\n{\n\tu32 base = MALIDP500_SE_MEMWRITE_BASE;\n\tu32 de_base = malidp_get_block_base(hwdev, MALIDP_DE_BLOCK);\n\n\t \n\tmalidp_hw_setbits(hwdev, MALIDP_SCALE_ENGINE_EN, de_base + MALIDP_DE_DISPLAY_FUNC);\n\n\t \n\tif (hwdev->mw_state != MW_NOT_ENABLED)\n\t\thwdev->mw_state = MW_RESTART;\n\telse\n\t\thwdev->mw_state = MW_START;\n\n\tmalidp_hw_write(hwdev, fmt_id, base + MALIDP_MW_FORMAT);\n\tswitch (num_planes) {\n\tcase 2:\n\t\tmalidp_hw_write(hwdev, lower_32_bits(addrs[1]), base + MALIDP_MW_P2_PTR_LOW);\n\t\tmalidp_hw_write(hwdev, upper_32_bits(addrs[1]), base + MALIDP_MW_P2_PTR_HIGH);\n\t\tmalidp_hw_write(hwdev, pitches[1], base + MALIDP_MW_P2_STRIDE);\n\t\tfallthrough;\n\tcase 1:\n\t\tmalidp_hw_write(hwdev, lower_32_bits(addrs[0]), base + MALIDP_MW_P1_PTR_LOW);\n\t\tmalidp_hw_write(hwdev, upper_32_bits(addrs[0]), base + MALIDP_MW_P1_PTR_HIGH);\n\t\tmalidp_hw_write(hwdev, pitches[0], base + MALIDP_MW_P1_STRIDE);\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"Invalid number of planes\");\n\t}\n\n\tmalidp_hw_write(hwdev, MALIDP_DE_H_ACTIVE(w) | MALIDP_DE_V_ACTIVE(h),\n\t\t\tMALIDP500_SE_MEMWRITE_OUT_SIZE);\n\n\tif (rgb2yuv_coeffs) {\n\t\tint i;\n\n\t\tfor (i = 0; i < MALIDP_COLORADJ_NUM_COEFFS; i++) {\n\t\t\tmalidp_hw_write(hwdev, rgb2yuv_coeffs[i],\n\t\t\t\t\tMALIDP500_SE_RGB_YUV_COEFFS + i * 4);\n\t\t}\n\t}\n\n\tmalidp_hw_setbits(hwdev, MALIDP_SE_MEMWRITE_EN, MALIDP500_SE_CONTROL);\n\n\treturn 0;\n}\n\nstatic void malidp500_disable_memwrite(struct malidp_hw_device *hwdev)\n{\n\tu32 base = malidp_get_block_base(hwdev, MALIDP_DE_BLOCK);\n\n\tif (hwdev->mw_state == MW_START || hwdev->mw_state == MW_RESTART)\n\t\thwdev->mw_state = MW_STOP;\n\tmalidp_hw_clearbits(hwdev, MALIDP_SE_MEMWRITE_EN, MALIDP500_SE_CONTROL);\n\tmalidp_hw_clearbits(hwdev, MALIDP_SCALE_ENGINE_EN, base + MALIDP_DE_DISPLAY_FUNC);\n}\n\nstatic int malidp550_query_hw(struct malidp_hw_device *hwdev)\n{\n\tu32 conf = malidp_hw_read(hwdev, MALIDP550_CONFIG_ID);\n\tu8 ln_size = (conf >> 4) & 0x3, rsize;\n\n\thwdev->min_line_size = 2;\n\n\tswitch (ln_size) {\n\tcase 0:\n\t\thwdev->max_line_size = SZ_2K;\n\t\t \n\t\trsize = 64;\n\t\tbreak;\n\tcase 1:\n\t\thwdev->max_line_size = SZ_4K;\n\t\t \n\t\trsize = 128;\n\t\tbreak;\n\tcase 2:\n\t\thwdev->max_line_size = 1280;\n\t\t \n\t\trsize = 40;\n\t\tbreak;\n\tcase 3:\n\t\t \n\t\thwdev->max_line_size = 0;\n\t\treturn -EINVAL;\n\t}\n\n\thwdev->rotation_memory[0] = hwdev->rotation_memory[1] = rsize * SZ_1K;\n\treturn 0;\n}\n\nstatic void malidp550_enter_config_mode(struct malidp_hw_device *hwdev)\n{\n\tu32 status, count = 100;\n\n\tmalidp_hw_setbits(hwdev, MALIDP550_DC_CONFIG_REQ, MALIDP550_DC_CONTROL);\n\twhile (count) {\n\t\tstatus = malidp_hw_read(hwdev, hwdev->hw->map.dc_base + MALIDP_REG_STATUS);\n\t\tif ((status & MALIDP550_DC_CONFIG_REQ) == MALIDP550_DC_CONFIG_REQ)\n\t\t\tbreak;\n\t\t \n\t\tusleep_range(1000, 10000);\n\t\tcount--;\n\t}\n\tWARN(count == 0, \"timeout while entering config mode\");\n}\n\nstatic void malidp550_leave_config_mode(struct malidp_hw_device *hwdev)\n{\n\tu32 status, count = 100;\n\n\tmalidp_hw_clearbits(hwdev, MALIDP_CFG_VALID, MALIDP550_CONFIG_VALID);\n\tmalidp_hw_clearbits(hwdev, MALIDP550_DC_CONFIG_REQ, MALIDP550_DC_CONTROL);\n\twhile (count) {\n\t\tstatus = malidp_hw_read(hwdev, hwdev->hw->map.dc_base + MALIDP_REG_STATUS);\n\t\tif ((status & MALIDP550_DC_CONFIG_REQ) == 0)\n\t\t\tbreak;\n\t\tusleep_range(100, 1000);\n\t\tcount--;\n\t}\n\tWARN(count == 0, \"timeout while leaving config mode\");\n}\n\nstatic bool malidp550_in_config_mode(struct malidp_hw_device *hwdev)\n{\n\tu32 status;\n\n\tstatus = malidp_hw_read(hwdev, hwdev->hw->map.dc_base + MALIDP_REG_STATUS);\n\tif ((status & MALIDP550_DC_CONFIG_REQ) == MALIDP550_DC_CONFIG_REQ)\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic void malidp550_set_config_valid(struct malidp_hw_device *hwdev, u8 value)\n{\n\tif (value)\n\t\tmalidp_hw_setbits(hwdev, MALIDP_CFG_VALID, MALIDP550_CONFIG_VALID);\n\telse\n\t\tmalidp_hw_clearbits(hwdev, MALIDP_CFG_VALID, MALIDP550_CONFIG_VALID);\n}\n\nstatic void malidp550_modeset(struct malidp_hw_device *hwdev, struct videomode *mode)\n{\n\tu32 val = MALIDP_DE_DEFAULT_PREFETCH_START;\n\n\tmalidp_hw_write(hwdev, hwdev->output_color_depth,\n\t\thwdev->hw->map.out_depth_base);\n\tmalidp_hw_write(hwdev, val, MALIDP550_DE_CONTROL);\n\t \n\tval = (((MALIDP_BGND_COLOR_R >> 4) & 0xff) << 16) |\n\t      (((MALIDP_BGND_COLOR_G >> 4) & 0xff) << 8) |\n\t      ((MALIDP_BGND_COLOR_B >> 4) & 0xff);\n\tmalidp_hw_write(hwdev, val, MALIDP550_DE_BGND_COLOR);\n\n\tval = MALIDP_DE_H_FRONTPORCH(mode->hfront_porch) |\n\t\tMALIDP_DE_H_BACKPORCH(mode->hback_porch);\n\tmalidp_hw_write(hwdev, val, MALIDP550_TIMINGS_BASE + MALIDP_DE_H_TIMINGS);\n\n\tval = MALIDP550_DE_V_FRONTPORCH(mode->vfront_porch) |\n\t\tMALIDP_DE_V_BACKPORCH(mode->vback_porch);\n\tmalidp_hw_write(hwdev, val, MALIDP550_TIMINGS_BASE + MALIDP_DE_V_TIMINGS);\n\n\tval = MALIDP_DE_H_SYNCWIDTH(mode->hsync_len) |\n\t\tMALIDP_DE_V_SYNCWIDTH(mode->vsync_len);\n\tif (mode->flags & DISPLAY_FLAGS_HSYNC_HIGH)\n\t\tval |= MALIDP550_HSYNCPOL;\n\tif (mode->flags & DISPLAY_FLAGS_VSYNC_HIGH)\n\t\tval |= MALIDP550_VSYNCPOL;\n\tmalidp_hw_write(hwdev, val, MALIDP550_TIMINGS_BASE + MALIDP_DE_SYNC_WIDTH);\n\n\tval = MALIDP_DE_H_ACTIVE(mode->hactive) | MALIDP_DE_V_ACTIVE(mode->vactive);\n\tmalidp_hw_write(hwdev, val, MALIDP550_TIMINGS_BASE + MALIDP_DE_HV_ACTIVE);\n\n\tif (mode->flags & DISPLAY_FLAGS_INTERLACED)\n\t\tmalidp_hw_setbits(hwdev, MALIDP_DISP_FUNC_ILACED, MALIDP_DE_DISPLAY_FUNC);\n\telse\n\t\tmalidp_hw_clearbits(hwdev, MALIDP_DISP_FUNC_ILACED, MALIDP_DE_DISPLAY_FUNC);\n}\n\nstatic int malidpx50_get_bytes_per_column(u32 fmt)\n{\n\tu32 bytes_per_column;\n\n\tswitch (fmt) {\n\t \n\tcase DRM_FORMAT_ARGB2101010:\n\tcase DRM_FORMAT_ABGR2101010:\n\tcase DRM_FORMAT_RGBA1010102:\n\tcase DRM_FORMAT_BGRA1010102:\n\tcase DRM_FORMAT_ARGB8888:\n\tcase DRM_FORMAT_ABGR8888:\n\tcase DRM_FORMAT_RGBA8888:\n\tcase DRM_FORMAT_BGRA8888:\n\tcase DRM_FORMAT_XRGB8888:\n\tcase DRM_FORMAT_XBGR8888:\n\tcase DRM_FORMAT_RGBX8888:\n\tcase DRM_FORMAT_BGRX8888:\n\tcase DRM_FORMAT_RGB888:\n\tcase DRM_FORMAT_BGR888:\n\t \n\tcase DRM_FORMAT_RGBA5551:\n\tcase DRM_FORMAT_ABGR1555:\n\tcase DRM_FORMAT_RGB565:\n\tcase DRM_FORMAT_BGR565:\n\tcase DRM_FORMAT_UYVY:\n\tcase DRM_FORMAT_YUYV:\n\tcase DRM_FORMAT_X0L0:\n\t\tbytes_per_column = 32;\n\t\tbreak;\n\t \n\tcase DRM_FORMAT_NV12:\n\tcase DRM_FORMAT_YUV420:\n\t \n\tcase DRM_FORMAT_VUY888:\n\t \n\tcase DRM_FORMAT_YUV420_8BIT:\n\t \n\tcase DRM_FORMAT_P010:\n\t\tbytes_per_column = 24;\n\t\tbreak;\n\t \n\tcase DRM_FORMAT_VUY101010:\n\t \n\tcase DRM_FORMAT_YUV420_10BIT:\n\t\tbytes_per_column = 30;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn bytes_per_column;\n}\n\nstatic int malidp550_rotmem_required(struct malidp_hw_device *hwdev, u16 w,\n\t\t\t\t     u16 h, u32 fmt, bool has_modifier)\n{\n\tint bytes_per_column = 0;\n\n\tswitch (fmt) {\n\t \n\tcase DRM_FORMAT_YUV420_10BIT:\n\t\tbytes_per_column = 15;\n\t\tbreak;\n\t \n\tcase DRM_FORMAT_X0L2:\n\t\tif (has_modifier)\n\t\t\tbytes_per_column = 8;\n\t\telse\n\t\t\treturn -EINVAL;\n\t\tbreak;\n\tdefault:\n\t\tbytes_per_column = malidpx50_get_bytes_per_column(fmt);\n\t}\n\n\tif (bytes_per_column == -EINVAL)\n\t\treturn bytes_per_column;\n\n\treturn w * bytes_per_column;\n}\n\nstatic int malidp650_rotmem_required(struct malidp_hw_device *hwdev, u16 w,\n\t\t\t\t     u16 h, u32 fmt, bool has_modifier)\n{\n\tint bytes_per_column = 0;\n\n\tswitch (fmt) {\n\t \n\tcase DRM_FORMAT_X0L2:\n\t\tbytes_per_column = 32;\n\t\tbreak;\n\tdefault:\n\t\tbytes_per_column = malidpx50_get_bytes_per_column(fmt);\n\t}\n\n\tif (bytes_per_column == -EINVAL)\n\t\treturn bytes_per_column;\n\n\treturn w * bytes_per_column;\n}\n\nstatic int malidp550_se_set_scaling_coeffs(struct malidp_hw_device *hwdev,\n\t\t\t\t\t   struct malidp_se_config *se_config,\n\t\t\t\t\t   struct malidp_se_config *old_config)\n{\n\tu32 mask = MALIDP550_SE_CTL_VCSEL(MALIDP550_SE_CTL_SEL_MASK) |\n\t\t   MALIDP550_SE_CTL_HCSEL(MALIDP550_SE_CTL_SEL_MASK);\n\tu32 new_value = MALIDP550_SE_CTL_VCSEL(se_config->vcoeff) |\n\t\t\tMALIDP550_SE_CTL_HCSEL(se_config->hcoeff);\n\n\tmalidp_hw_clearbits(hwdev, mask, MALIDP550_SE_CONTROL);\n\tmalidp_hw_setbits(hwdev, new_value, MALIDP550_SE_CONTROL);\n\treturn 0;\n}\n\nstatic long malidp550_se_calc_mclk(struct malidp_hw_device *hwdev,\n\t\t\t\t   struct malidp_se_config *se_config,\n\t\t\t\t   struct videomode *vm)\n{\n\tunsigned long mclk;\n\tunsigned long pxlclk = vm->pixelclock;\n\tunsigned long htotal = vm->hactive + vm->hfront_porch +\n\t\t\t       vm->hback_porch + vm->hsync_len;\n\tunsigned long numerator = 1, denominator = 1;\n\tlong ret;\n\n\tif (se_config->scale_enable) {\n\t\tnumerator = max(se_config->input_w, se_config->output_w) *\n\t\t\t    se_config->input_h;\n\t\tnumerator += se_config->output_w *\n\t\t\t     (se_config->output_h -\n\t\t\t      min(se_config->input_h, se_config->output_h));\n\t\tdenominator = (htotal - 2) * se_config->output_h;\n\t}\n\n\t \n\tif (numerator < denominator)\n\t\tnumerator = denominator = 1;\n\tmclk = (pxlclk * numerator) / denominator;\n\tret = clk_get_rate(hwdev->mclk);\n\tif (ret < mclk) {\n\t\tDRM_DEBUG_DRIVER(\"mclk requirement of %lu kHz can't be met.\\n\",\n\t\t\t\t mclk / 1000);\n\t\treturn -EINVAL;\n\t}\n\treturn ret;\n}\n\nstatic int malidp550_enable_memwrite(struct malidp_hw_device *hwdev,\n\t\t\t\t     dma_addr_t *addrs, s32 *pitches,\n\t\t\t\t     int num_planes, u16 w, u16 h, u32 fmt_id,\n\t\t\t\t     const s16 *rgb2yuv_coeffs)\n{\n\tu32 base = MALIDP550_SE_MEMWRITE_BASE;\n\tu32 de_base = malidp_get_block_base(hwdev, MALIDP_DE_BLOCK);\n\n\t \n\tmalidp_hw_setbits(hwdev, MALIDP_SCALE_ENGINE_EN, de_base + MALIDP_DE_DISPLAY_FUNC);\n\n\thwdev->mw_state = MW_ONESHOT;\n\n\tmalidp_hw_write(hwdev, fmt_id, base + MALIDP_MW_FORMAT);\n\tswitch (num_planes) {\n\tcase 2:\n\t\tmalidp_hw_write(hwdev, lower_32_bits(addrs[1]), base + MALIDP_MW_P2_PTR_LOW);\n\t\tmalidp_hw_write(hwdev, upper_32_bits(addrs[1]), base + MALIDP_MW_P2_PTR_HIGH);\n\t\tmalidp_hw_write(hwdev, pitches[1], base + MALIDP_MW_P2_STRIDE);\n\t\tfallthrough;\n\tcase 1:\n\t\tmalidp_hw_write(hwdev, lower_32_bits(addrs[0]), base + MALIDP_MW_P1_PTR_LOW);\n\t\tmalidp_hw_write(hwdev, upper_32_bits(addrs[0]), base + MALIDP_MW_P1_PTR_HIGH);\n\t\tmalidp_hw_write(hwdev, pitches[0], base + MALIDP_MW_P1_STRIDE);\n\t\tbreak;\n\tdefault:\n\t\tWARN(1, \"Invalid number of planes\");\n\t}\n\n\tmalidp_hw_write(hwdev, MALIDP_DE_H_ACTIVE(w) | MALIDP_DE_V_ACTIVE(h),\n\t\t\tMALIDP550_SE_MEMWRITE_OUT_SIZE);\n\tmalidp_hw_setbits(hwdev, MALIDP550_SE_MEMWRITE_ONESHOT | MALIDP_SE_MEMWRITE_EN,\n\t\t\t  MALIDP550_SE_CONTROL);\n\n\tif (rgb2yuv_coeffs) {\n\t\tint i;\n\n\t\tfor (i = 0; i < MALIDP_COLORADJ_NUM_COEFFS; i++) {\n\t\t\tmalidp_hw_write(hwdev, rgb2yuv_coeffs[i],\n\t\t\t\t\tMALIDP550_SE_RGB_YUV_COEFFS + i * 4);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic void malidp550_disable_memwrite(struct malidp_hw_device *hwdev)\n{\n\tu32 base = malidp_get_block_base(hwdev, MALIDP_DE_BLOCK);\n\n\tmalidp_hw_clearbits(hwdev, MALIDP550_SE_MEMWRITE_ONESHOT | MALIDP_SE_MEMWRITE_EN,\n\t\t\t    MALIDP550_SE_CONTROL);\n\tmalidp_hw_clearbits(hwdev, MALIDP_SCALE_ENGINE_EN, base + MALIDP_DE_DISPLAY_FUNC);\n}\n\nstatic int malidp650_query_hw(struct malidp_hw_device *hwdev)\n{\n\tu32 conf = malidp_hw_read(hwdev, MALIDP550_CONFIG_ID);\n\tu8 ln_size = (conf >> 4) & 0x3, rsize;\n\n\thwdev->min_line_size = 4;\n\n\tswitch (ln_size) {\n\tcase 0:\n\tcase 2:\n\t\t \n\t\thwdev->max_line_size = 0;\n\t\treturn -EINVAL;\n\tcase 1:\n\t\thwdev->max_line_size = SZ_4K;\n\t\t \n\t\trsize = 128;\n\t\tbreak;\n\tcase 3:\n\t\thwdev->max_line_size = 2560;\n\t\t \n\t\trsize = 80;\n\t}\n\n\thwdev->rotation_memory[0] = hwdev->rotation_memory[1] = rsize * SZ_1K;\n\treturn 0;\n}\n\nconst struct malidp_hw malidp_device[MALIDP_MAX_DEVICES] = {\n\t[MALIDP_500] = {\n\t\t.map = {\n\t\t\t.coeffs_base = MALIDP500_COEFFS_BASE,\n\t\t\t.se_base = MALIDP500_SE_BASE,\n\t\t\t.dc_base = MALIDP500_DC_BASE,\n\t\t\t.out_depth_base = MALIDP500_OUTPUT_DEPTH,\n\t\t\t.features = 0,\t \n\t\t\t.n_layers = ARRAY_SIZE(malidp500_layers),\n\t\t\t.layers = malidp500_layers,\n\t\t\t.de_irq_map = {\n\t\t\t\t.irq_mask = MALIDP_DE_IRQ_UNDERRUN |\n\t\t\t\t\t    MALIDP500_DE_IRQ_AXI_ERR |\n\t\t\t\t\t    MALIDP500_DE_IRQ_VSYNC |\n\t\t\t\t\t    MALIDP500_DE_IRQ_GLOBAL,\n\t\t\t\t.vsync_irq = MALIDP500_DE_IRQ_VSYNC,\n\t\t\t\t.err_mask = MALIDP_DE_IRQ_UNDERRUN |\n\t\t\t\t\t    MALIDP500_DE_IRQ_AXI_ERR |\n\t\t\t\t\t    MALIDP500_DE_IRQ_SATURATION,\n\t\t\t},\n\t\t\t.se_irq_map = {\n\t\t\t\t.irq_mask = MALIDP500_SE_IRQ_CONF_MODE |\n\t\t\t\t\t    MALIDP500_SE_IRQ_CONF_VALID |\n\t\t\t\t\t    MALIDP500_SE_IRQ_GLOBAL,\n\t\t\t\t.vsync_irq = MALIDP500_SE_IRQ_CONF_VALID,\n\t\t\t\t.err_mask = MALIDP500_SE_IRQ_INIT_BUSY |\n\t\t\t\t\t    MALIDP500_SE_IRQ_AXI_ERROR |\n\t\t\t\t\t    MALIDP500_SE_IRQ_OVERRUN,\n\t\t\t},\n\t\t\t.dc_irq_map = {\n\t\t\t\t.irq_mask = MALIDP500_DE_IRQ_CONF_VALID,\n\t\t\t\t.vsync_irq = MALIDP500_DE_IRQ_CONF_VALID,\n\t\t\t},\n\t\t\t.pixel_formats = malidp500_de_formats,\n\t\t\t.n_pixel_formats = ARRAY_SIZE(malidp500_de_formats),\n\t\t\t.bus_align_bytes = 8,\n\t\t},\n\t\t.query_hw = malidp500_query_hw,\n\t\t.enter_config_mode = malidp500_enter_config_mode,\n\t\t.leave_config_mode = malidp500_leave_config_mode,\n\t\t.in_config_mode = malidp500_in_config_mode,\n\t\t.set_config_valid = malidp500_set_config_valid,\n\t\t.modeset = malidp500_modeset,\n\t\t.rotmem_required = malidp500_rotmem_required,\n\t\t.se_set_scaling_coeffs = malidp500_se_set_scaling_coeffs,\n\t\t.se_calc_mclk = malidp500_se_calc_mclk,\n\t\t.enable_memwrite = malidp500_enable_memwrite,\n\t\t.disable_memwrite = malidp500_disable_memwrite,\n\t\t.features = MALIDP_DEVICE_LV_HAS_3_STRIDES,\n\t},\n\t[MALIDP_550] = {\n\t\t.map = {\n\t\t\t.coeffs_base = MALIDP550_COEFFS_BASE,\n\t\t\t.se_base = MALIDP550_SE_BASE,\n\t\t\t.dc_base = MALIDP550_DC_BASE,\n\t\t\t.out_depth_base = MALIDP550_DE_OUTPUT_DEPTH,\n\t\t\t.features = MALIDP_REGMAP_HAS_CLEARIRQ |\n\t\t\t\t    MALIDP_DEVICE_AFBC_SUPPORT_SPLIT |\n\t\t\t\t    MALIDP_DEVICE_AFBC_YUV_420_10_SUPPORT_SPLIT |\n\t\t\t\t    MALIDP_DEVICE_AFBC_YUYV_USE_422_P2,\n\t\t\t.n_layers = ARRAY_SIZE(malidp550_layers),\n\t\t\t.layers = malidp550_layers,\n\t\t\t.de_irq_map = {\n\t\t\t\t.irq_mask = MALIDP_DE_IRQ_UNDERRUN |\n\t\t\t\t\t    MALIDP550_DE_IRQ_VSYNC,\n\t\t\t\t.vsync_irq = MALIDP550_DE_IRQ_VSYNC,\n\t\t\t\t.err_mask = MALIDP_DE_IRQ_UNDERRUN |\n\t\t\t\t\t    MALIDP550_DE_IRQ_SATURATION |\n\t\t\t\t\t    MALIDP550_DE_IRQ_AXI_ERR,\n\t\t\t},\n\t\t\t.se_irq_map = {\n\t\t\t\t.irq_mask = MALIDP550_SE_IRQ_EOW,\n\t\t\t\t.vsync_irq = MALIDP550_SE_IRQ_EOW,\n\t\t\t\t.err_mask  = MALIDP550_SE_IRQ_AXI_ERR |\n\t\t\t\t\t     MALIDP550_SE_IRQ_OVR |\n\t\t\t\t\t     MALIDP550_SE_IRQ_IBSY,\n\t\t\t},\n\t\t\t.dc_irq_map = {\n\t\t\t\t.irq_mask = MALIDP550_DC_IRQ_CONF_VALID |\n\t\t\t\t\t    MALIDP550_DC_IRQ_SE,\n\t\t\t\t.vsync_irq = MALIDP550_DC_IRQ_CONF_VALID,\n\t\t\t},\n\t\t\t.pixel_formats = malidp550_de_formats,\n\t\t\t.n_pixel_formats = ARRAY_SIZE(malidp550_de_formats),\n\t\t\t.bus_align_bytes = 8,\n\t\t},\n\t\t.query_hw = malidp550_query_hw,\n\t\t.enter_config_mode = malidp550_enter_config_mode,\n\t\t.leave_config_mode = malidp550_leave_config_mode,\n\t\t.in_config_mode = malidp550_in_config_mode,\n\t\t.set_config_valid = malidp550_set_config_valid,\n\t\t.modeset = malidp550_modeset,\n\t\t.rotmem_required = malidp550_rotmem_required,\n\t\t.se_set_scaling_coeffs = malidp550_se_set_scaling_coeffs,\n\t\t.se_calc_mclk = malidp550_se_calc_mclk,\n\t\t.enable_memwrite = malidp550_enable_memwrite,\n\t\t.disable_memwrite = malidp550_disable_memwrite,\n\t\t.features = 0,\n\t},\n\t[MALIDP_650] = {\n\t\t.map = {\n\t\t\t.coeffs_base = MALIDP550_COEFFS_BASE,\n\t\t\t.se_base = MALIDP550_SE_BASE,\n\t\t\t.dc_base = MALIDP550_DC_BASE,\n\t\t\t.out_depth_base = MALIDP550_DE_OUTPUT_DEPTH,\n\t\t\t.features = MALIDP_REGMAP_HAS_CLEARIRQ |\n\t\t\t\t    MALIDP_DEVICE_AFBC_SUPPORT_SPLIT |\n\t\t\t\t    MALIDP_DEVICE_AFBC_YUYV_USE_422_P2,\n\t\t\t.n_layers = ARRAY_SIZE(malidp650_layers),\n\t\t\t.layers = malidp650_layers,\n\t\t\t.de_irq_map = {\n\t\t\t\t.irq_mask = MALIDP_DE_IRQ_UNDERRUN |\n\t\t\t\t\t    MALIDP650_DE_IRQ_DRIFT |\n\t\t\t\t\t    MALIDP550_DE_IRQ_VSYNC,\n\t\t\t\t.vsync_irq = MALIDP550_DE_IRQ_VSYNC,\n\t\t\t\t.err_mask = MALIDP_DE_IRQ_UNDERRUN |\n\t\t\t\t\t    MALIDP650_DE_IRQ_DRIFT |\n\t\t\t\t\t    MALIDP550_DE_IRQ_SATURATION |\n\t\t\t\t\t    MALIDP550_DE_IRQ_AXI_ERR |\n\t\t\t\t\t    MALIDP650_DE_IRQ_ACEV1 |\n\t\t\t\t\t    MALIDP650_DE_IRQ_ACEV2 |\n\t\t\t\t\t    MALIDP650_DE_IRQ_ACEG |\n\t\t\t\t\t    MALIDP650_DE_IRQ_AXIEP,\n\t\t\t},\n\t\t\t.se_irq_map = {\n\t\t\t\t.irq_mask = MALIDP550_SE_IRQ_EOW,\n\t\t\t\t.vsync_irq = MALIDP550_SE_IRQ_EOW,\n\t\t\t\t.err_mask = MALIDP550_SE_IRQ_AXI_ERR |\n\t\t\t\t\t    MALIDP550_SE_IRQ_OVR |\n\t\t\t\t\t    MALIDP550_SE_IRQ_IBSY,\n\t\t\t},\n\t\t\t.dc_irq_map = {\n\t\t\t\t.irq_mask = MALIDP550_DC_IRQ_CONF_VALID |\n\t\t\t\t\t    MALIDP550_DC_IRQ_SE,\n\t\t\t\t.vsync_irq = MALIDP550_DC_IRQ_CONF_VALID,\n\t\t\t},\n\t\t\t.pixel_formats = malidp650_de_formats,\n\t\t\t.n_pixel_formats = ARRAY_SIZE(malidp650_de_formats),\n\t\t\t.bus_align_bytes = 16,\n\t\t},\n\t\t.query_hw = malidp650_query_hw,\n\t\t.enter_config_mode = malidp550_enter_config_mode,\n\t\t.leave_config_mode = malidp550_leave_config_mode,\n\t\t.in_config_mode = malidp550_in_config_mode,\n\t\t.set_config_valid = malidp550_set_config_valid,\n\t\t.modeset = malidp550_modeset,\n\t\t.rotmem_required = malidp650_rotmem_required,\n\t\t.se_set_scaling_coeffs = malidp550_se_set_scaling_coeffs,\n\t\t.se_calc_mclk = malidp550_se_calc_mclk,\n\t\t.enable_memwrite = malidp550_enable_memwrite,\n\t\t.disable_memwrite = malidp550_disable_memwrite,\n\t\t.features = 0,\n\t},\n};\n\nu8 malidp_hw_get_format_id(const struct malidp_hw_regmap *map,\n\t\t\t   u8 layer_id, u32 format, bool has_modifier)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < map->n_pixel_formats; i++) {\n\t\tif (((map->pixel_formats[i].layer & layer_id) == layer_id) &&\n\t\t    (map->pixel_formats[i].format == format)) {\n\t\t\t \n\t\t\tif (format == DRM_FORMAT_YUYV &&\n\t\t\t    (has_modifier) &&\n\t\t\t    (map->features & MALIDP_DEVICE_AFBC_YUYV_USE_422_P2))\n\t\t\t\treturn AFBC_YUV_422_FORMAT_ID;\n\t\t\telse\n\t\t\t\treturn map->pixel_formats[i].id;\n\t\t}\n\t}\n\n\treturn MALIDP_INVALID_FORMAT_ID;\n}\n\nbool malidp_hw_format_is_linear_only(u32 format)\n{\n\tswitch (format) {\n\tcase DRM_FORMAT_ARGB2101010:\n\tcase DRM_FORMAT_RGBA1010102:\n\tcase DRM_FORMAT_BGRA1010102:\n\tcase DRM_FORMAT_ARGB8888:\n\tcase DRM_FORMAT_RGBA8888:\n\tcase DRM_FORMAT_BGRA8888:\n\tcase DRM_FORMAT_XBGR8888:\n\tcase DRM_FORMAT_XRGB8888:\n\tcase DRM_FORMAT_RGBX8888:\n\tcase DRM_FORMAT_BGRX8888:\n\tcase DRM_FORMAT_RGB888:\n\tcase DRM_FORMAT_RGB565:\n\tcase DRM_FORMAT_ARGB1555:\n\tcase DRM_FORMAT_RGBA5551:\n\tcase DRM_FORMAT_BGRA5551:\n\tcase DRM_FORMAT_UYVY:\n\tcase DRM_FORMAT_XYUV8888:\n\tcase DRM_FORMAT_XVYU2101010:\n\tcase DRM_FORMAT_X0L2:\n\tcase DRM_FORMAT_X0L0:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nbool malidp_hw_format_is_afbc_only(u32 format)\n{\n\tswitch (format) {\n\tcase DRM_FORMAT_VUY888:\n\tcase DRM_FORMAT_VUY101010:\n\tcase DRM_FORMAT_YUV420_8BIT:\n\tcase DRM_FORMAT_YUV420_10BIT:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic void malidp_hw_clear_irq(struct malidp_hw_device *hwdev, u8 block, u32 irq)\n{\n\tu32 base = malidp_get_block_base(hwdev, block);\n\n\tif (hwdev->hw->map.features & MALIDP_REGMAP_HAS_CLEARIRQ)\n\t\tmalidp_hw_write(hwdev, irq, base + MALIDP_REG_CLEARIRQ);\n\telse\n\t\tmalidp_hw_write(hwdev, irq, base + MALIDP_REG_STATUS);\n}\n\nstatic irqreturn_t malidp_de_irq(int irq, void *arg)\n{\n\tstruct drm_device *drm = arg;\n\tstruct malidp_drm *malidp = drm_to_malidp(drm);\n\tstruct malidp_hw_device *hwdev;\n\tstruct malidp_hw *hw;\n\tconst struct malidp_irq_map *de;\n\tu32 status, mask, dc_status;\n\tirqreturn_t ret = IRQ_NONE;\n\n\thwdev = malidp->dev;\n\thw = hwdev->hw;\n\tde = &hw->map.de_irq_map;\n\n\t \n\tif (hwdev->pm_suspended)\n\t\treturn IRQ_NONE;\n\n\t \n\tdc_status = malidp_hw_read(hwdev, hw->map.dc_base + MALIDP_REG_STATUS);\n\tif (dc_status & hw->map.dc_irq_map.vsync_irq) {\n\t\tmalidp_hw_clear_irq(hwdev, MALIDP_DC_BLOCK, dc_status);\n\t\t \n\t\tif (malidp->event != NULL) {\n\t\t\tspin_lock(&drm->event_lock);\n\t\t\tdrm_crtc_send_vblank_event(&malidp->crtc, malidp->event);\n\t\t\tmalidp->event = NULL;\n\t\t\tspin_unlock(&drm->event_lock);\n\t\t}\n\t\tatomic_set(&malidp->config_valid, MALIDP_CONFIG_VALID_DONE);\n\t\tret = IRQ_WAKE_THREAD;\n\t}\n\n\tstatus = malidp_hw_read(hwdev, MALIDP_REG_STATUS);\n\tif (!(status & de->irq_mask))\n\t\treturn ret;\n\n\tmask = malidp_hw_read(hwdev, MALIDP_REG_MASKIRQ);\n\t \n\tstatus &= (mask | de->err_mask);\n\tif ((status & de->vsync_irq) && malidp->crtc.enabled)\n\t\tdrm_crtc_handle_vblank(&malidp->crtc);\n\n#ifdef CONFIG_DEBUG_FS\n\tif (status & de->err_mask) {\n\t\tmalidp_error(malidp, &malidp->de_errors, status,\n\t\t\t     drm_crtc_vblank_count(&malidp->crtc));\n\t}\n#endif\n\tmalidp_hw_clear_irq(hwdev, MALIDP_DE_BLOCK, status);\n\n\treturn (ret == IRQ_NONE) ? IRQ_HANDLED : ret;\n}\n\nstatic irqreturn_t malidp_de_irq_thread_handler(int irq, void *arg)\n{\n\tstruct drm_device *drm = arg;\n\tstruct malidp_drm *malidp = drm_to_malidp(drm);\n\n\twake_up(&malidp->wq);\n\n\treturn IRQ_HANDLED;\n}\n\nvoid malidp_de_irq_hw_init(struct malidp_hw_device *hwdev)\n{\n\t \n\tmalidp_hw_disable_irq(hwdev, MALIDP_DE_BLOCK, 0xffffffff);\n\tmalidp_hw_clear_irq(hwdev, MALIDP_DE_BLOCK, 0xffffffff);\n\tmalidp_hw_disable_irq(hwdev, MALIDP_DC_BLOCK, 0xffffffff);\n\tmalidp_hw_clear_irq(hwdev, MALIDP_DC_BLOCK, 0xffffffff);\n\n\t \n\tmalidp_hw_enable_irq(hwdev, MALIDP_DC_BLOCK,\n\t\t\t     hwdev->hw->map.dc_irq_map.irq_mask);\n\n\t \n\tmalidp_hw_enable_irq(hwdev, MALIDP_DE_BLOCK,\n\t\t\t     hwdev->hw->map.de_irq_map.irq_mask);\n}\n\nint malidp_de_irq_init(struct drm_device *drm, int irq)\n{\n\tstruct malidp_drm *malidp = drm_to_malidp(drm);\n\tstruct malidp_hw_device *hwdev = malidp->dev;\n\tint ret;\n\n\t \n\tmalidp_hw_disable_irq(hwdev, MALIDP_DE_BLOCK, 0xffffffff);\n\tmalidp_hw_clear_irq(hwdev, MALIDP_DE_BLOCK, 0xffffffff);\n\tmalidp_hw_disable_irq(hwdev, MALIDP_DC_BLOCK, 0xffffffff);\n\tmalidp_hw_clear_irq(hwdev, MALIDP_DC_BLOCK, 0xffffffff);\n\n\tret = devm_request_threaded_irq(drm->dev, irq, malidp_de_irq,\n\t\t\t\t\tmalidp_de_irq_thread_handler,\n\t\t\t\t\tIRQF_SHARED, \"malidp-de\", drm);\n\tif (ret < 0) {\n\t\tDRM_ERROR(\"failed to install DE IRQ handler\\n\");\n\t\treturn ret;\n\t}\n\n\tmalidp_de_irq_hw_init(hwdev);\n\n\treturn 0;\n}\n\nvoid malidp_de_irq_fini(struct malidp_hw_device *hwdev)\n{\n\tmalidp_hw_disable_irq(hwdev, MALIDP_DE_BLOCK,\n\t\t\t      hwdev->hw->map.de_irq_map.irq_mask);\n\tmalidp_hw_disable_irq(hwdev, MALIDP_DC_BLOCK,\n\t\t\t      hwdev->hw->map.dc_irq_map.irq_mask);\n}\n\nstatic irqreturn_t malidp_se_irq(int irq, void *arg)\n{\n\tstruct drm_device *drm = arg;\n\tstruct malidp_drm *malidp = drm_to_malidp(drm);\n\tstruct malidp_hw_device *hwdev = malidp->dev;\n\tstruct malidp_hw *hw = hwdev->hw;\n\tconst struct malidp_irq_map *se = &hw->map.se_irq_map;\n\tu32 status, mask;\n\n\t \n\tif (hwdev->pm_suspended)\n\t\treturn IRQ_NONE;\n\n\tstatus = malidp_hw_read(hwdev, hw->map.se_base + MALIDP_REG_STATUS);\n\tif (!(status & (se->irq_mask | se->err_mask)))\n\t\treturn IRQ_NONE;\n\n#ifdef CONFIG_DEBUG_FS\n\tif (status & se->err_mask)\n\t\tmalidp_error(malidp, &malidp->se_errors, status,\n\t\t\t     drm_crtc_vblank_count(&malidp->crtc));\n#endif\n\tmask = malidp_hw_read(hwdev, hw->map.se_base + MALIDP_REG_MASKIRQ);\n\tstatus &= mask;\n\n\tif (status & se->vsync_irq) {\n\t\tswitch (hwdev->mw_state) {\n\t\tcase MW_ONESHOT:\n\t\t\tdrm_writeback_signal_completion(&malidp->mw_connector, 0);\n\t\t\tbreak;\n\t\tcase MW_STOP:\n\t\t\tdrm_writeback_signal_completion(&malidp->mw_connector, 0);\n\t\t\t \n\t\t\thwdev->mw_state = MW_NOT_ENABLED;\n\t\t\tbreak;\n\t\tcase MW_RESTART:\n\t\t\tdrm_writeback_signal_completion(&malidp->mw_connector, 0);\n\t\t\tfallthrough;\t \n\t\tcase MW_START:\n\t\t\t \n\t\t\thw->disable_memwrite(hwdev);\n\t\t\t \n\t\t\tstatus = malidp_hw_read(hwdev, hw->map.dc_base + MALIDP_REG_STATUS);\n\t\t\tif ((atomic_read(&malidp->config_valid) != MALIDP_CONFIG_START) ||\n\t\t\t    (status & hw->map.dc_irq_map.vsync_irq))\n\t\t\t\thw->set_config_valid(hwdev, 1);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tmalidp_hw_clear_irq(hwdev, MALIDP_SE_BLOCK, status);\n\n\treturn IRQ_HANDLED;\n}\n\nvoid malidp_se_irq_hw_init(struct malidp_hw_device *hwdev)\n{\n\t \n\tmalidp_hw_disable_irq(hwdev, MALIDP_SE_BLOCK, 0xffffffff);\n\tmalidp_hw_clear_irq(hwdev, MALIDP_SE_BLOCK, 0xffffffff);\n\n\tmalidp_hw_enable_irq(hwdev, MALIDP_SE_BLOCK,\n\t\t\t     hwdev->hw->map.se_irq_map.irq_mask);\n}\n\nstatic irqreturn_t malidp_se_irq_thread_handler(int irq, void *arg)\n{\n\treturn IRQ_HANDLED;\n}\n\nint malidp_se_irq_init(struct drm_device *drm, int irq)\n{\n\tstruct malidp_drm *malidp = drm_to_malidp(drm);\n\tstruct malidp_hw_device *hwdev = malidp->dev;\n\tint ret;\n\n\t \n\tmalidp_hw_disable_irq(hwdev, MALIDP_SE_BLOCK, 0xffffffff);\n\tmalidp_hw_clear_irq(hwdev, MALIDP_SE_BLOCK, 0xffffffff);\n\n\tret = devm_request_threaded_irq(drm->dev, irq, malidp_se_irq,\n\t\t\t\t\tmalidp_se_irq_thread_handler,\n\t\t\t\t\tIRQF_SHARED, \"malidp-se\", drm);\n\tif (ret < 0) {\n\t\tDRM_ERROR(\"failed to install SE IRQ handler\\n\");\n\t\treturn ret;\n\t}\n\n\thwdev->mw_state = MW_NOT_ENABLED;\n\tmalidp_se_irq_hw_init(hwdev);\n\n\treturn 0;\n}\n\nvoid malidp_se_irq_fini(struct malidp_hw_device *hwdev)\n{\n\tmalidp_hw_disable_irq(hwdev, MALIDP_SE_BLOCK,\n\t\t\t      hwdev->hw->map.se_irq_map.irq_mask);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}