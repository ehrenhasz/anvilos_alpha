{
  "module_name": "komeda_event.c",
  "hash_id": "8f9b55a110e6cc8c2fab1799301b3bfa708fbdcb4285f60b531d0702a59d169e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/arm/display/komeda/komeda_event.c",
  "human_readable_source": "\n \n#include <drm/drm_atomic.h>\n#include <drm/drm_print.h>\n\n#include \"komeda_dev.h\"\n\nstruct komeda_str {\n\tchar *str;\n\tu32 sz;\n\tu32 len;\n};\n\n \n__printf(2, 3)\nstatic int komeda_sprintf(struct komeda_str *str, const char *fmt, ...)\n{\n\tva_list args;\n\tint num, free_sz;\n\tint err;\n\n\tfree_sz = str->sz - str->len - 1;\n\tif (free_sz <= 0)\n\t\treturn -ENOSPC;\n\n\tva_start(args, fmt);\n\n\tnum = vsnprintf(str->str + str->len, free_sz, fmt, args);\n\n\tva_end(args);\n\n\tif (num < free_sz) {\n\t\tstr->len += num;\n\t\terr = 0;\n\t} else {\n\t\tstr->len = str->sz - 1;\n\t\terr = -ENOSPC;\n\t}\n\n\treturn err;\n}\n\nstatic void evt_sprintf(struct komeda_str *str, u64 evt, const char *msg)\n{\n\tif (evt)\n\t\tkomeda_sprintf(str, msg);\n}\n\nstatic void evt_str(struct komeda_str *str, u64 events)\n{\n\tif (events == 0ULL) {\n\t\tkomeda_sprintf(str, \"None\");\n\t\treturn;\n\t}\n\n\tevt_sprintf(str, events & KOMEDA_EVENT_VSYNC, \"VSYNC|\");\n\tevt_sprintf(str, events & KOMEDA_EVENT_FLIP, \"FLIP|\");\n\tevt_sprintf(str, events & KOMEDA_EVENT_EOW, \"EOW|\");\n\tevt_sprintf(str, events & KOMEDA_EVENT_MODE, \"OP-MODE|\");\n\n\tevt_sprintf(str, events & KOMEDA_EVENT_URUN, \"UNDERRUN|\");\n\tevt_sprintf(str, events & KOMEDA_EVENT_OVR, \"OVERRUN|\");\n\n\t \n\tevt_sprintf(str, events & KOMEDA_ERR_MERR, \"MERR|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_FRAMETO, \"FRAMETO|\");\n\n\t \n\tevt_sprintf(str, events & KOMEDA_ERR_DRIFTTO, \"DRIFTTO|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_FRAMETO, \"FRAMETO|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_TETO, \"TETO|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_CSCE, \"CSCE|\");\n\n\t \n\tevt_sprintf(str, events & KOMEDA_EVENT_IBSY, \"IBSY|\");\n\tevt_sprintf(str, events & KOMEDA_EVENT_EMPTY, \"EMPTY|\");\n\tevt_sprintf(str, events & KOMEDA_EVENT_FULL, \"FULL|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_AXIE, \"AXIE|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_ACE0, \"ACE0|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_ACE1, \"ACE1|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_ACE2, \"ACE2|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_ACE3, \"ACE3|\");\n\n\t \n\tevt_sprintf(str, events & KOMEDA_ERR_TCF, \"TCF|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_TTNG, \"TTNG|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_TITR, \"TITR|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_TEMR, \"TEMR|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_TTF, \"TTF|\");\n\n\t \n\tevt_sprintf(str, events & KOMEDA_ERR_CPE, \"COPROC|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_ZME, \"ZME|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_CFGE, \"CFGE|\");\n\tevt_sprintf(str, events & KOMEDA_ERR_TEMR, \"TEMR|\");\n\n\tif (str->len > 0 && (str->str[str->len - 1] == '|')) {\n\t\tstr->str[str->len - 1] = 0;\n\t\tstr->len--;\n\t}\n}\n\nstatic bool is_new_frame(struct komeda_events *a)\n{\n\treturn (a->pipes[0] | a->pipes[1]) &\n\t       (KOMEDA_EVENT_FLIP | KOMEDA_EVENT_EOW);\n}\n\nvoid komeda_print_events(struct komeda_events *evts, struct drm_device *dev)\n{\n\tu64 print_evts = 0;\n\tstatic bool en_print = true;\n\tstruct komeda_dev *mdev = dev->dev_private;\n\tu16 const err_verbosity = mdev->err_verbosity;\n\tu64 evts_mask = evts->global | evts->pipes[0] | evts->pipes[1];\n\n\t \n\tif (evts->global || is_new_frame(evts))\n\t\ten_print = true;\n\tif (!(err_verbosity & KOMEDA_DEV_PRINT_DISABLE_RATELIMIT) && !en_print)\n\t\treturn;\n\n\tif (err_verbosity & KOMEDA_DEV_PRINT_ERR_EVENTS)\n\t\tprint_evts |= KOMEDA_ERR_EVENTS;\n\tif (err_verbosity & KOMEDA_DEV_PRINT_WARN_EVENTS)\n\t\tprint_evts |= KOMEDA_WARN_EVENTS;\n\tif (err_verbosity & KOMEDA_DEV_PRINT_INFO_EVENTS)\n\t\tprint_evts |= KOMEDA_INFO_EVENTS;\n\n\tif (evts_mask & print_evts) {\n\t\tchar msg[256];\n\t\tstruct komeda_str str;\n\t\tstruct drm_printer p = drm_info_printer(dev->dev);\n\n\t\tstr.str = msg;\n\t\tstr.sz  = sizeof(msg);\n\t\tstr.len = 0;\n\n\t\tkomeda_sprintf(&str, \"gcu: \");\n\t\tevt_str(&str, evts->global);\n\t\tkomeda_sprintf(&str, \", pipes[0]: \");\n\t\tevt_str(&str, evts->pipes[0]);\n\t\tkomeda_sprintf(&str, \", pipes[1]: \");\n\t\tevt_str(&str, evts->pipes[1]);\n\n\t\tDRM_ERROR(\"err detect: %s\\n\", msg);\n\t\tif ((err_verbosity & KOMEDA_DEV_PRINT_DUMP_STATE_ON_EVENT) &&\n\t\t    (evts_mask & (KOMEDA_ERR_EVENTS | KOMEDA_WARN_EVENTS)))\n\t\t\tdrm_state_dump(dev, &p);\n\n\t\ten_print = false;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}