{
  "module_name": "komeda_drv.c",
  "hash_id": "d1ea7a8b7fe7a2395bbc45e6101cb3842a61f27ece0800c345377848fd4b2e6e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/arm/display/komeda/komeda_drv.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <drm/drm_fbdev_generic.h>\n#include <drm/drm_module.h>\n#include <drm/drm_of.h>\n#include \"komeda_dev.h\"\n#include \"komeda_kms.h\"\n\nstruct komeda_drv {\n\tstruct komeda_dev *mdev;\n\tstruct komeda_kms_dev *kms;\n};\n\nstruct komeda_dev *dev_to_mdev(struct device *dev)\n{\n\tstruct komeda_drv *mdrv = dev_get_drvdata(dev);\n\n\treturn mdrv ? mdrv->mdev : NULL;\n}\n\nstatic void komeda_platform_remove(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct komeda_drv *mdrv = dev_get_drvdata(dev);\n\n\tkomeda_kms_detach(mdrv->kms);\n\n\tif (pm_runtime_enabled(dev))\n\t\tpm_runtime_disable(dev);\n\telse\n\t\tkomeda_dev_suspend(mdrv->mdev);\n\n\tkomeda_dev_destroy(mdrv->mdev);\n\n\tdev_set_drvdata(dev, NULL);\n\tdevm_kfree(dev, mdrv);\n}\n\nstatic int komeda_platform_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct komeda_drv *mdrv;\n\tint err;\n\n\tmdrv = devm_kzalloc(dev, sizeof(*mdrv), GFP_KERNEL);\n\tif (!mdrv)\n\t\treturn -ENOMEM;\n\n\tmdrv->mdev = komeda_dev_create(dev);\n\tif (IS_ERR(mdrv->mdev)) {\n\t\terr = PTR_ERR(mdrv->mdev);\n\t\tgoto free_mdrv;\n\t}\n\n\tpm_runtime_enable(dev);\n\tif (!pm_runtime_enabled(dev))\n\t\tkomeda_dev_resume(mdrv->mdev);\n\n\tmdrv->kms = komeda_kms_attach(mdrv->mdev);\n\tif (IS_ERR(mdrv->kms)) {\n\t\terr = PTR_ERR(mdrv->kms);\n\t\tgoto destroy_mdev;\n\t}\n\n\tdev_set_drvdata(dev, mdrv);\n\tdrm_fbdev_generic_setup(&mdrv->kms->base, 32);\n\n\treturn 0;\n\ndestroy_mdev:\n\tif (pm_runtime_enabled(dev))\n\t\tpm_runtime_disable(dev);\n\telse\n\t\tkomeda_dev_suspend(mdrv->mdev);\n\n\tkomeda_dev_destroy(mdrv->mdev);\n\nfree_mdrv:\n\tdevm_kfree(dev, mdrv);\n\treturn err;\n}\n\nstatic const struct of_device_id komeda_of_match[] = {\n\t{ .compatible = \"arm,mali-d71\", .data = d71_identify, },\n\t{ .compatible = \"arm,mali-d32\", .data = d71_identify, },\n\t{},\n};\n\nMODULE_DEVICE_TABLE(of, komeda_of_match);\n\nstatic int __maybe_unused komeda_rt_pm_suspend(struct device *dev)\n{\n\tstruct komeda_drv *mdrv = dev_get_drvdata(dev);\n\n\treturn komeda_dev_suspend(mdrv->mdev);\n}\n\nstatic int __maybe_unused komeda_rt_pm_resume(struct device *dev)\n{\n\tstruct komeda_drv *mdrv = dev_get_drvdata(dev);\n\n\treturn komeda_dev_resume(mdrv->mdev);\n}\n\nstatic int __maybe_unused komeda_pm_suspend(struct device *dev)\n{\n\tstruct komeda_drv *mdrv = dev_get_drvdata(dev);\n\tint res;\n\n\tres = drm_mode_config_helper_suspend(&mdrv->kms->base);\n\n\tif (!pm_runtime_status_suspended(dev))\n\t\tkomeda_dev_suspend(mdrv->mdev);\n\n\treturn res;\n}\n\nstatic int __maybe_unused komeda_pm_resume(struct device *dev)\n{\n\tstruct komeda_drv *mdrv = dev_get_drvdata(dev);\n\n\tif (!pm_runtime_status_suspended(dev))\n\t\tkomeda_dev_resume(mdrv->mdev);\n\n\treturn drm_mode_config_helper_resume(&mdrv->kms->base);\n}\n\nstatic const struct dev_pm_ops komeda_pm_ops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(komeda_pm_suspend, komeda_pm_resume)\n\tSET_RUNTIME_PM_OPS(komeda_rt_pm_suspend, komeda_rt_pm_resume, NULL)\n};\n\nstatic struct platform_driver komeda_platform_driver = {\n\t.probe\t= komeda_platform_probe,\n\t.remove_new = komeda_platform_remove,\n\t.driver\t= {\n\t\t.name = \"komeda\",\n\t\t.of_match_table\t= komeda_of_match,\n\t\t.pm = &komeda_pm_ops,\n\t},\n};\n\ndrm_module_platform_driver(komeda_platform_driver);\n\nMODULE_AUTHOR(\"James.Qian.Wang <james.qian.wang@arm.com>\");\nMODULE_DESCRIPTION(\"Komeda KMS driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}