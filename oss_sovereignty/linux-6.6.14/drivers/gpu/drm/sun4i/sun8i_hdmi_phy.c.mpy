{
  "module_name": "sun8i_hdmi_phy.c",
  "hash_id": "e6450271dbb79285fdb32662eb0b1f5fea9bd39127dd4e61fe11fc748dec81b8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/sun4i/sun8i_hdmi_phy.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n\n#include \"sun8i_dw_hdmi.h\"\n\n \n#define I2C_ADDR\t0x69\n\nstatic const struct dw_hdmi_mpll_config sun50i_h6_mpll_cfg[] = {\n\t{\n\t\t30666000, {\n\t\t\t{ 0x00b3, 0x0000 },\n\t\t\t{ 0x2153, 0x0000 },\n\t\t\t{ 0x40f3, 0x0000 },\n\t\t},\n\t},  {\n\t\t36800000, {\n\t\t\t{ 0x00b3, 0x0000 },\n\t\t\t{ 0x2153, 0x0000 },\n\t\t\t{ 0x40a2, 0x0001 },\n\t\t},\n\t},  {\n\t\t46000000, {\n\t\t\t{ 0x00b3, 0x0000 },\n\t\t\t{ 0x2142, 0x0001 },\n\t\t\t{ 0x40a2, 0x0001 },\n\t\t},\n\t},  {\n\t\t61333000, {\n\t\t\t{ 0x0072, 0x0001 },\n\t\t\t{ 0x2142, 0x0001 },\n\t\t\t{ 0x40a2, 0x0001 },\n\t\t},\n\t},  {\n\t\t73600000, {\n\t\t\t{ 0x0072, 0x0001 },\n\t\t\t{ 0x2142, 0x0001 },\n\t\t\t{ 0x4061, 0x0002 },\n\t\t},\n\t},  {\n\t\t92000000, {\n\t\t\t{ 0x0072, 0x0001 },\n\t\t\t{ 0x2145, 0x0002 },\n\t\t\t{ 0x4061, 0x0002 },\n\t\t},\n\t},  {\n\t\t122666000, {\n\t\t\t{ 0x0051, 0x0002 },\n\t\t\t{ 0x2145, 0x0002 },\n\t\t\t{ 0x4061, 0x0002 },\n\t\t},\n\t},  {\n\t\t147200000, {\n\t\t\t{ 0x0051, 0x0002 },\n\t\t\t{ 0x2145, 0x0002 },\n\t\t\t{ 0x4064, 0x0003 },\n\t\t},\n\t},  {\n\t\t184000000, {\n\t\t\t{ 0x0051, 0x0002 },\n\t\t\t{ 0x214c, 0x0003 },\n\t\t\t{ 0x4064, 0x0003 },\n\t\t},\n\t},  {\n\t\t226666000, {\n\t\t\t{ 0x0040, 0x0003 },\n\t\t\t{ 0x214c, 0x0003 },\n\t\t\t{ 0x4064, 0x0003 },\n\t\t},\n\t},  {\n\t\t272000000, {\n\t\t\t{ 0x0040, 0x0003 },\n\t\t\t{ 0x214c, 0x0003 },\n\t\t\t{ 0x5a64, 0x0003 },\n\t\t},\n\t},  {\n\t\t340000000, {\n\t\t\t{ 0x0040, 0x0003 },\n\t\t\t{ 0x3b4c, 0x0003 },\n\t\t\t{ 0x5a64, 0x0003 },\n\t\t},\n\t},  {\n\t\t594000000, {\n\t\t\t{ 0x1a40, 0x0003 },\n\t\t\t{ 0x3b4c, 0x0003 },\n\t\t\t{ 0x5a64, 0x0003 },\n\t\t},\n\t}, {\n\t\t~0UL, {\n\t\t\t{ 0x0000, 0x0000 },\n\t\t\t{ 0x0000, 0x0000 },\n\t\t\t{ 0x0000, 0x0000 },\n\t\t},\n\t}\n};\n\nstatic const struct dw_hdmi_curr_ctrl sun50i_h6_cur_ctr[] = {\n\t \n\t{ 27000000,  { 0x0012, 0x0000, 0x0000 }, },\n\t{ 74250000,  { 0x0013, 0x001a, 0x001b }, },\n\t{ 148500000, { 0x0019, 0x0033, 0x0034 }, },\n\t{ 297000000, { 0x0019, 0x001b, 0x001b }, },\n\t{ 594000000, { 0x0010, 0x001b, 0x001b }, },\n\t{ ~0UL,      { 0x0000, 0x0000, 0x0000 }, }\n};\n\nstatic const struct dw_hdmi_phy_config sun50i_h6_phy_config[] = {\n\t \n\t{ 27000000,  0x8009, 0x0007, 0x02b0 },\n\t{ 74250000,  0x8009, 0x0006, 0x022d },\n\t{ 148500000, 0x8029, 0x0006, 0x0270 },\n\t{ 297000000, 0x8039, 0x0005, 0x01ab },\n\t{ 594000000, 0x8029, 0x0000, 0x008a },\n\t{ ~0UL,\t     0x0000, 0x0000, 0x0000}\n};\n\nstatic void sun8i_hdmi_phy_set_polarity(struct sun8i_hdmi_phy *phy,\n\t\t\t\t\tconst struct drm_display_mode *mode)\n{\n\tu32 val = 0;\n\n\tif (mode->flags & DRM_MODE_FLAG_NHSYNC)\n\t\tval |= SUN8I_HDMI_PHY_DBG_CTRL_POL_NHSYNC;\n\n\tif (mode->flags & DRM_MODE_FLAG_NVSYNC)\n\t\tval |= SUN8I_HDMI_PHY_DBG_CTRL_POL_NVSYNC;\n\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_DBG_CTRL_REG,\n\t\t\t   SUN8I_HDMI_PHY_DBG_CTRL_POL_MASK, val);\n};\n\nstatic int sun8i_a83t_hdmi_phy_config(struct dw_hdmi *hdmi, void *data,\n\t\t\t\t      const struct drm_display_info *display,\n\t\t\t\t      const struct drm_display_mode *mode)\n{\n\tunsigned int clk_rate = mode->crtc_clock * 1000;\n\tstruct sun8i_hdmi_phy *phy = data;\n\n\tsun8i_hdmi_phy_set_polarity(phy, mode);\n\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_REXT_CTRL_REG,\n\t\t\t   SUN8I_HDMI_PHY_REXT_CTRL_REXT_EN,\n\t\t\t   SUN8I_HDMI_PHY_REXT_CTRL_REXT_EN);\n\n\t \n\tdw_hdmi_phy_gen2_txpwron(hdmi, 0);\n\tdw_hdmi_phy_gen2_pddq(hdmi, 1);\n\n\tdw_hdmi_phy_gen2_reset(hdmi);\n\n\tdw_hdmi_phy_gen2_pddq(hdmi, 0);\n\n\tdw_hdmi_phy_i2c_set_addr(hdmi, I2C_ADDR);\n\n\t \n\tif (clk_rate <= 27000000) {\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x01e0, 0x06);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0000, 0x15);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x08da, 0x10);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0007, 0x19);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0318, 0x0e);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x8009, 0x09);\n\t} else if (clk_rate <= 74250000) {\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0540, 0x06);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0005, 0x15);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0000, 0x10);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0007, 0x19);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x02b5, 0x0e);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x8009, 0x09);\n\t} else if (clk_rate <= 148500000) {\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x04a0, 0x06);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x000a, 0x15);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0000, 0x10);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0002, 0x19);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0021, 0x0e);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x8029, 0x09);\n\t} else {\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0000, 0x06);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x000f, 0x15);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0000, 0x10);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0002, 0x19);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x0000, 0x0e);\n\t\tdw_hdmi_phy_i2c_write(hdmi, 0x802b, 0x09);\n\t}\n\n\tdw_hdmi_phy_i2c_write(hdmi, 0x0000, 0x1e);\n\tdw_hdmi_phy_i2c_write(hdmi, 0x0000, 0x13);\n\tdw_hdmi_phy_i2c_write(hdmi, 0x0000, 0x17);\n\n\tdw_hdmi_phy_gen2_txpwron(hdmi, 1);\n\n\treturn 0;\n}\n\nstatic void sun8i_a83t_hdmi_phy_disable(struct dw_hdmi *hdmi, void *data)\n{\n\tstruct sun8i_hdmi_phy *phy = data;\n\n\tdw_hdmi_phy_gen2_txpwron(hdmi, 0);\n\tdw_hdmi_phy_gen2_pddq(hdmi, 1);\n\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_REXT_CTRL_REG,\n\t\t\t   SUN8I_HDMI_PHY_REXT_CTRL_REXT_EN, 0);\n}\n\nstatic const struct dw_hdmi_phy_ops sun8i_a83t_hdmi_phy_ops = {\n\t.init\t\t= sun8i_a83t_hdmi_phy_config,\n\t.disable\t= sun8i_a83t_hdmi_phy_disable,\n\t.read_hpd\t= dw_hdmi_phy_read_hpd,\n\t.update_hpd\t= dw_hdmi_phy_update_hpd,\n\t.setup_hpd\t= dw_hdmi_phy_setup_hpd,\n};\n\nstatic int sun8i_h3_hdmi_phy_config(struct dw_hdmi *hdmi, void *data,\n\t\t\t\t    const struct drm_display_info *display,\n\t\t\t\t    const struct drm_display_mode *mode)\n{\n\tunsigned int clk_rate = mode->crtc_clock * 1000;\n\tstruct sun8i_hdmi_phy *phy = data;\n\tu32 pll_cfg1_init;\n\tu32 pll_cfg2_init;\n\tu32 ana_cfg1_end;\n\tu32 ana_cfg2_init;\n\tu32 ana_cfg3_init;\n\tu32 b_offset = 0;\n\tu32 val;\n\n\tif (phy->variant->has_phy_clk)\n\t\tclk_set_rate(phy->clk_phy, clk_rate);\n\n\tsun8i_hdmi_phy_set_polarity(phy, mode);\n\n\t \n\n\tpll_cfg1_init = SUN8I_HDMI_PHY_PLL_CFG1_LDO2_EN |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG1_LDO1_EN |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG1_LDO_VSET(7) |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG1_UNKNOWN(1) |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG1_PLLDBEN |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG1_CS |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG1_CP_S(2) |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG1_CNT_INT(63) |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG1_BWS;\n\n\tpll_cfg2_init = SUN8I_HDMI_PHY_PLL_CFG2_SV_H |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG2_VCOGAIN_EN |\n\t\t\tSUN8I_HDMI_PHY_PLL_CFG2_SDIV2;\n\n\tana_cfg1_end = SUN8I_HDMI_PHY_ANA_CFG1_REG_SVBH(1) |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_AMP_OPT |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_EMP_OPT |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_AMPCK_OPT |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_EMPCK_OPT |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_ENRCAL |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_ENCALOG |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_REG_SCKTMDS |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_TMDSCLK_EN |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_TXEN_MASK |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_TXEN_ALL |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDSCLK |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDS2 |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDS1 |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDS0 |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDS2 |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDS1 |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDS0 |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_CKEN |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_LDOEN |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_ENVBS |\n\t\t       SUN8I_HDMI_PHY_ANA_CFG1_ENBI;\n\n\tana_cfg2_init = SUN8I_HDMI_PHY_ANA_CFG2_M_EN |\n\t\t\tSUN8I_HDMI_PHY_ANA_CFG2_REG_DENCK |\n\t\t\tSUN8I_HDMI_PHY_ANA_CFG2_REG_DEN |\n\t\t\tSUN8I_HDMI_PHY_ANA_CFG2_REG_CKSS(1) |\n\t\t\tSUN8I_HDMI_PHY_ANA_CFG2_REG_CSMPS(1);\n\n\tana_cfg3_init = SUN8I_HDMI_PHY_ANA_CFG3_REG_WIRE(0x3e0) |\n\t\t\tSUN8I_HDMI_PHY_ANA_CFG3_SDAEN |\n\t\t\tSUN8I_HDMI_PHY_ANA_CFG3_SCLEN;\n\n\t \n\tif (clk_rate <= 27000000) {\n\t\tpll_cfg1_init |= SUN8I_HDMI_PHY_PLL_CFG1_HV_IS_33 |\n\t\t\t\t SUN8I_HDMI_PHY_PLL_CFG1_CNT_INT(32);\n\t\tpll_cfg2_init |= SUN8I_HDMI_PHY_PLL_CFG2_VCO_S(4) |\n\t\t\t\t SUN8I_HDMI_PHY_PLL_CFG2_S(4);\n\t\tana_cfg1_end |= SUN8I_HDMI_PHY_ANA_CFG1_REG_CALSW;\n\t\tana_cfg2_init |= SUN8I_HDMI_PHY_ANA_CFG2_REG_SLV(4) |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG2_REG_RESDI(phy->rcal);\n\t\tana_cfg3_init |= SUN8I_HDMI_PHY_ANA_CFG3_REG_AMPCK(3) |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG3_REG_AMP(5);\n\t} else if (clk_rate <= 74250000) {\n\t\tpll_cfg1_init |= SUN8I_HDMI_PHY_PLL_CFG1_HV_IS_33 |\n\t\t\t\t SUN8I_HDMI_PHY_PLL_CFG1_CNT_INT(32);\n\t\tpll_cfg2_init |= SUN8I_HDMI_PHY_PLL_CFG2_VCO_S(4) |\n\t\t\t\t SUN8I_HDMI_PHY_PLL_CFG2_S(5);\n\t\tana_cfg1_end |= SUN8I_HDMI_PHY_ANA_CFG1_REG_CALSW;\n\t\tana_cfg2_init |= SUN8I_HDMI_PHY_ANA_CFG2_REG_SLV(4) |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG2_REG_RESDI(phy->rcal);\n\t\tana_cfg3_init |= SUN8I_HDMI_PHY_ANA_CFG3_REG_AMPCK(5) |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG3_REG_AMP(7);\n\t} else if (clk_rate <= 148500000) {\n\t\tpll_cfg1_init |= SUN8I_HDMI_PHY_PLL_CFG1_HV_IS_33 |\n\t\t\t\t SUN8I_HDMI_PHY_PLL_CFG1_CNT_INT(32);\n\t\tpll_cfg2_init |= SUN8I_HDMI_PHY_PLL_CFG2_VCO_S(4) |\n\t\t\t\t SUN8I_HDMI_PHY_PLL_CFG2_S(6);\n\t\tana_cfg2_init |= SUN8I_HDMI_PHY_ANA_CFG2_REG_BIGSWCK |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG2_REG_BIGSW |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG2_REG_SLV(2);\n\t\tana_cfg3_init |= SUN8I_HDMI_PHY_ANA_CFG3_REG_AMPCK(7) |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG3_REG_AMP(9);\n\t} else {\n\t\tb_offset = 2;\n\t\tpll_cfg1_init |= SUN8I_HDMI_PHY_PLL_CFG1_CNT_INT(63);\n\t\tpll_cfg2_init |= SUN8I_HDMI_PHY_PLL_CFG2_VCO_S(6) |\n\t\t\t\t SUN8I_HDMI_PHY_PLL_CFG2_S(7);\n\t\tana_cfg2_init |= SUN8I_HDMI_PHY_ANA_CFG2_REG_BIGSWCK |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG2_REG_BIGSW |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG2_REG_SLV(4);\n\t\tana_cfg3_init |= SUN8I_HDMI_PHY_ANA_CFG3_REG_AMPCK(9) |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG3_REG_AMP(13) |\n\t\t\t\t SUN8I_HDMI_PHY_ANA_CFG3_REG_EMP(3);\n\t}\n\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_TXEN_MASK, 0);\n\n\t \n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_PLL_CFG1_REG,\n\t\t\t   (u32)~SUN8I_HDMI_PHY_PLL_CFG1_CKIN_SEL_MSK,\n\t\t\t   pll_cfg1_init);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_PLL_CFG2_REG,\n\t\t\t   (u32)~SUN8I_HDMI_PHY_PLL_CFG2_PREDIV_MSK,\n\t\t\t   pll_cfg2_init);\n\tusleep_range(10000, 15000);\n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_PLL_CFG3_REG,\n\t\t     SUN8I_HDMI_PHY_PLL_CFG3_SOUT_DIV2);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_PLL_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG1_PLLEN,\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG1_PLLEN);\n\tmsleep(100);\n\n\t \n\tregmap_read(phy->regs, SUN8I_HDMI_PHY_ANA_STS_REG, &val);\n\tval = (val & SUN8I_HDMI_PHY_ANA_STS_B_OUT_MSK) >>\n\t\tSUN8I_HDMI_PHY_ANA_STS_B_OUT_SHIFT;\n\tval = min(val + b_offset, (u32)0x3f);\n\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_PLL_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG1_REG_OD1 |\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG1_REG_OD,\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG1_REG_OD1 |\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG1_REG_OD);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_PLL_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG1_B_IN_MSK,\n\t\t\t   val << SUN8I_HDMI_PHY_PLL_CFG1_B_IN_SHIFT);\n\tmsleep(100);\n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG, ana_cfg1_end);\n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_ANA_CFG2_REG, ana_cfg2_init);\n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_ANA_CFG3_REG, ana_cfg3_init);\n\n\treturn 0;\n}\n\nstatic void sun8i_h3_hdmi_phy_disable(struct dw_hdmi *hdmi, void *data)\n{\n\tstruct sun8i_hdmi_phy *phy = data;\n\n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t     SUN8I_HDMI_PHY_ANA_CFG1_LDOEN |\n\t\t     SUN8I_HDMI_PHY_ANA_CFG1_ENVBS |\n\t\t     SUN8I_HDMI_PHY_ANA_CFG1_ENBI);\n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_PLL_CFG1_REG, 0);\n}\n\nstatic const struct dw_hdmi_phy_ops sun8i_h3_hdmi_phy_ops = {\n\t.init\t\t= sun8i_h3_hdmi_phy_config,\n\t.disable\t= sun8i_h3_hdmi_phy_disable,\n\t.read_hpd\t= dw_hdmi_phy_read_hpd,\n\t.update_hpd\t= dw_hdmi_phy_update_hpd,\n\t.setup_hpd\t= dw_hdmi_phy_setup_hpd,\n};\n\nstatic void sun8i_hdmi_phy_unlock(struct sun8i_hdmi_phy *phy)\n{\n\t \n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_READ_EN_REG,\n\t\t     SUN8I_HDMI_PHY_READ_EN_MAGIC);\n\n\t \n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_UNSCRAMBLE_REG,\n\t\t     SUN8I_HDMI_PHY_UNSCRAMBLE_MAGIC);\n}\n\nstatic void sun50i_hdmi_phy_init_h6(struct sun8i_hdmi_phy *phy)\n{\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_REXT_CTRL_REG,\n\t\t\t   SUN8I_HDMI_PHY_REXT_CTRL_REXT_EN,\n\t\t\t   SUN8I_HDMI_PHY_REXT_CTRL_REXT_EN);\n\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_REXT_CTRL_REG,\n\t\t\t   0xffff0000, 0x80c00000);\n}\n\nstatic void sun8i_hdmi_phy_init_a83t(struct sun8i_hdmi_phy *phy)\n{\n\tsun8i_hdmi_phy_unlock(phy);\n\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_DBG_CTRL_REG,\n\t\t\t   SUN8I_HDMI_PHY_DBG_CTRL_PX_LOCK,\n\t\t\t   SUN8I_HDMI_PHY_DBG_CTRL_PX_LOCK);\n\n\t \n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_DBG_CTRL_REG,\n\t\t\t   SUN8I_HDMI_PHY_DBG_CTRL_ADDR_MASK,\n\t\t\t   SUN8I_HDMI_PHY_DBG_CTRL_ADDR(I2C_ADDR));\n}\n\nstatic void sun8i_hdmi_phy_init_h3(struct sun8i_hdmi_phy *phy)\n{\n\tunsigned int val;\n\n\tsun8i_hdmi_phy_unlock(phy);\n\n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG, 0);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENBI,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENBI);\n\tudelay(5);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_TMDSCLK_EN,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_TMDSCLK_EN);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENVBS,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENVBS);\n\tusleep_range(10, 20);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_LDOEN,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_LDOEN);\n\tudelay(5);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_CKEN,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_CKEN);\n\tusleep_range(40, 100);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENRCAL,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENRCAL);\n\tusleep_range(100, 200);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENCALOG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENCALOG);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDS0 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDS1 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDS2,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDS0 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDS1 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDS2);\n\n\t \n\tregmap_read_poll_timeout(phy->regs, SUN8I_HDMI_PHY_ANA_STS_REG, val,\n\t\t\t\t (val & SUN8I_HDMI_PHY_ANA_STS_RCALEND2D),\n\t\t\t\t 100, 2000);\n\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDSCLK,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_ENP2S_TMDSCLK);\n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDS0 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDS1 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDS2 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDSCLK,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDS0 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDS1 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDS2 |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG1_BIASEN_TMDSCLK);\n\n\t \n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_ANA_CFG3_REG,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG3_SCLEN |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG3_SDAEN,\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG3_SCLEN |\n\t\t\t   SUN8I_HDMI_PHY_ANA_CFG3_SDAEN);\n\n\t \n\tregmap_update_bits(phy->regs, SUN8I_HDMI_PHY_PLL_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG1_CKIN_SEL_MSK, 0);\n\n\t \n\tregmap_write(phy->regs, SUN8I_HDMI_PHY_CEC_REG, 0);\n\n\t \n\tregmap_read(phy->regs, SUN8I_HDMI_PHY_ANA_STS_REG, &val);\n\tphy->rcal = (val & SUN8I_HDMI_PHY_ANA_STS_RCAL_MASK) >> 2;\n}\n\nint sun8i_hdmi_phy_init(struct sun8i_hdmi_phy *phy)\n{\n\tint ret;\n\n\tret = reset_control_deassert(phy->rst_phy);\n\tif (ret) {\n\t\tdev_err(phy->dev, \"Cannot deassert phy reset control: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = clk_prepare_enable(phy->clk_bus);\n\tif (ret) {\n\t\tdev_err(phy->dev, \"Cannot enable bus clock: %d\\n\", ret);\n\t\tgoto err_assert_rst_phy;\n\t}\n\n\tret = clk_prepare_enable(phy->clk_mod);\n\tif (ret) {\n\t\tdev_err(phy->dev, \"Cannot enable mod clock: %d\\n\", ret);\n\t\tgoto err_disable_clk_bus;\n\t}\n\n\tif (phy->variant->has_phy_clk) {\n\t\tret = sun8i_phy_clk_create(phy, phy->dev,\n\t\t\t\t\t   phy->variant->has_second_pll);\n\t\tif (ret) {\n\t\t\tdev_err(phy->dev, \"Couldn't create the PHY clock\\n\");\n\t\t\tgoto err_disable_clk_mod;\n\t\t}\n\n\t\tclk_prepare_enable(phy->clk_phy);\n\t}\n\n\tphy->variant->phy_init(phy);\n\n\treturn 0;\n\nerr_disable_clk_mod:\n\tclk_disable_unprepare(phy->clk_mod);\nerr_disable_clk_bus:\n\tclk_disable_unprepare(phy->clk_bus);\nerr_assert_rst_phy:\n\treset_control_assert(phy->rst_phy);\n\n\treturn ret;\n}\n\nvoid sun8i_hdmi_phy_deinit(struct sun8i_hdmi_phy *phy)\n{\n\tclk_disable_unprepare(phy->clk_mod);\n\tclk_disable_unprepare(phy->clk_bus);\n\tclk_disable_unprepare(phy->clk_phy);\n\n\treset_control_assert(phy->rst_phy);\n}\n\nvoid sun8i_hdmi_phy_set_ops(struct sun8i_hdmi_phy *phy,\n\t\t\t    struct dw_hdmi_plat_data *plat_data)\n{\n\tconst struct sun8i_hdmi_phy_variant *variant = phy->variant;\n\n\tif (variant->phy_ops) {\n\t\tplat_data->phy_ops = variant->phy_ops;\n\t\tplat_data->phy_name = \"sun8i_dw_hdmi_phy\";\n\t\tplat_data->phy_data = phy;\n\t} else {\n\t\tplat_data->mpll_cfg = variant->mpll_cfg;\n\t\tplat_data->cur_ctr = variant->cur_ctr;\n\t\tplat_data->phy_config = variant->phy_cfg;\n\t}\n}\n\nstatic const struct regmap_config sun8i_hdmi_phy_regmap_config = {\n\t.reg_bits\t= 32,\n\t.val_bits\t= 32,\n\t.reg_stride\t= 4,\n\t.max_register\t= SUN8I_HDMI_PHY_CEC_REG,\n\t.name\t\t= \"phy\"\n};\n\nstatic const struct sun8i_hdmi_phy_variant sun8i_a83t_hdmi_phy = {\n\t.phy_ops = &sun8i_a83t_hdmi_phy_ops,\n\t.phy_init = &sun8i_hdmi_phy_init_a83t,\n};\n\nstatic const struct sun8i_hdmi_phy_variant sun8i_h3_hdmi_phy = {\n\t.has_phy_clk = true,\n\t.phy_ops = &sun8i_h3_hdmi_phy_ops,\n\t.phy_init = &sun8i_hdmi_phy_init_h3,\n};\n\nstatic const struct sun8i_hdmi_phy_variant sun8i_r40_hdmi_phy = {\n\t.has_phy_clk = true,\n\t.has_second_pll = true,\n\t.phy_ops = &sun8i_h3_hdmi_phy_ops,\n\t.phy_init = &sun8i_hdmi_phy_init_h3,\n};\n\nstatic const struct sun8i_hdmi_phy_variant sun50i_a64_hdmi_phy = {\n\t.has_phy_clk = true,\n\t.phy_ops = &sun8i_h3_hdmi_phy_ops,\n\t.phy_init = &sun8i_hdmi_phy_init_h3,\n};\n\nstatic const struct sun8i_hdmi_phy_variant sun50i_h6_hdmi_phy = {\n\t.cur_ctr  = sun50i_h6_cur_ctr,\n\t.mpll_cfg = sun50i_h6_mpll_cfg,\n\t.phy_cfg  = sun50i_h6_phy_config,\n\t.phy_init = &sun50i_hdmi_phy_init_h6,\n};\n\nstatic const struct of_device_id sun8i_hdmi_phy_of_table[] = {\n\t{\n\t\t.compatible = \"allwinner,sun8i-a83t-hdmi-phy\",\n\t\t.data = &sun8i_a83t_hdmi_phy,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun8i-h3-hdmi-phy\",\n\t\t.data = &sun8i_h3_hdmi_phy,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun8i-r40-hdmi-phy\",\n\t\t.data = &sun8i_r40_hdmi_phy,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun50i-a64-hdmi-phy\",\n\t\t.data = &sun50i_a64_hdmi_phy,\n\t},\n\t{\n\t\t.compatible = \"allwinner,sun50i-h6-hdmi-phy\",\n\t\t.data = &sun50i_h6_hdmi_phy,\n\t},\n\t{   }\n};\n\nint sun8i_hdmi_phy_get(struct sun8i_dw_hdmi *hdmi, struct device_node *node)\n{\n\tstruct platform_device *pdev = of_find_device_by_node(node);\n\tstruct sun8i_hdmi_phy *phy;\n\n\tif (!pdev)\n\t\treturn -EPROBE_DEFER;\n\n\tphy = platform_get_drvdata(pdev);\n\tif (!phy) {\n\t\tput_device(&pdev->dev);\n\t\treturn -EPROBE_DEFER;\n\t}\n\n\thdmi->phy = phy;\n\n\tput_device(&pdev->dev);\n\n\treturn 0;\n}\n\nstatic int sun8i_hdmi_phy_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct sun8i_hdmi_phy *phy;\n\tvoid __iomem *regs;\n\n\tphy = devm_kzalloc(dev, sizeof(*phy), GFP_KERNEL);\n\tif (!phy)\n\t\treturn -ENOMEM;\n\n\tphy->variant = of_device_get_match_data(dev);\n\tphy->dev = dev;\n\n\tregs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(regs))\n\t\treturn dev_err_probe(dev, PTR_ERR(regs),\n\t\t\t\t     \"Couldn't map the HDMI PHY registers\\n\");\n\n\tphy->regs = devm_regmap_init_mmio(dev, regs,\n\t\t\t\t\t  &sun8i_hdmi_phy_regmap_config);\n\tif (IS_ERR(phy->regs))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy->regs),\n\t\t\t\t     \"Couldn't create the HDMI PHY regmap\\n\");\n\n\tphy->clk_bus = devm_clk_get(dev, \"bus\");\n\tif (IS_ERR(phy->clk_bus))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy->clk_bus),\n\t\t\t\t     \"Could not get bus clock\\n\");\n\n\tphy->clk_mod = devm_clk_get(dev, \"mod\");\n\tif (IS_ERR(phy->clk_mod))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy->clk_mod),\n\t\t\t\t     \"Could not get mod clock\\n\");\n\n\tif (phy->variant->has_phy_clk) {\n\t\tphy->clk_pll0 = devm_clk_get(dev, \"pll-0\");\n\t\tif (IS_ERR(phy->clk_pll0))\n\t\t\treturn dev_err_probe(dev, PTR_ERR(phy->clk_pll0),\n\t\t\t\t\t     \"Could not get pll-0 clock\\n\");\n\n\t\tif (phy->variant->has_second_pll) {\n\t\t\tphy->clk_pll1 = devm_clk_get(dev, \"pll-1\");\n\t\t\tif (IS_ERR(phy->clk_pll1))\n\t\t\t\treturn dev_err_probe(dev, PTR_ERR(phy->clk_pll1),\n\t\t\t\t\t\t     \"Could not get pll-1 clock\\n\");\n\t\t}\n\t}\n\n\tphy->rst_phy = devm_reset_control_get_shared(dev, \"phy\");\n\tif (IS_ERR(phy->rst_phy))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy->rst_phy),\n\t\t\t\t     \"Could not get phy reset control\\n\");\n\n\tplatform_set_drvdata(pdev, phy);\n\n\treturn 0;\n}\n\nstruct platform_driver sun8i_hdmi_phy_driver = {\n\t.probe  = sun8i_hdmi_phy_probe,\n\t.driver = {\n\t\t.name = \"sun8i-hdmi-phy\",\n\t\t.of_match_table = sun8i_hdmi_phy_of_table,\n\t},\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}