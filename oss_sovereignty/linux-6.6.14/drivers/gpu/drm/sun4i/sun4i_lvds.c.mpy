{
  "module_name": "sun4i_lvds.c",
  "hash_id": "cbf1fbe9177a231d061d720e68df82b52949c64245b087ace7272947386bc2e0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/sun4i/sun4i_lvds.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_bridge.h>\n#include <drm/drm_of.h>\n#include <drm/drm_panel.h>\n#include <drm/drm_print.h>\n#include <drm/drm_probe_helper.h>\n#include <drm/drm_simple_kms_helper.h>\n\n#include \"sun4i_crtc.h\"\n#include \"sun4i_tcon.h\"\n#include \"sun4i_lvds.h\"\n\nstruct sun4i_lvds {\n\tstruct drm_connector\tconnector;\n\tstruct drm_encoder\tencoder;\n\n\tstruct drm_panel\t*panel;\n};\n\nstatic inline struct sun4i_lvds *\ndrm_connector_to_sun4i_lvds(struct drm_connector *connector)\n{\n\treturn container_of(connector, struct sun4i_lvds,\n\t\t\t    connector);\n}\n\nstatic inline struct sun4i_lvds *\ndrm_encoder_to_sun4i_lvds(struct drm_encoder *encoder)\n{\n\treturn container_of(encoder, struct sun4i_lvds,\n\t\t\t    encoder);\n}\n\nstatic int sun4i_lvds_get_modes(struct drm_connector *connector)\n{\n\tstruct sun4i_lvds *lvds =\n\t\tdrm_connector_to_sun4i_lvds(connector);\n\n\treturn drm_panel_get_modes(lvds->panel, connector);\n}\n\nstatic const struct drm_connector_helper_funcs sun4i_lvds_con_helper_funcs = {\n\t.get_modes\t= sun4i_lvds_get_modes,\n};\n\nstatic void\nsun4i_lvds_connector_destroy(struct drm_connector *connector)\n{\n\tdrm_connector_cleanup(connector);\n}\n\nstatic const struct drm_connector_funcs sun4i_lvds_con_funcs = {\n\t.fill_modes\t\t= drm_helper_probe_single_connector_modes,\n\t.destroy\t\t= sun4i_lvds_connector_destroy,\n\t.reset\t\t\t= drm_atomic_helper_connector_reset,\n\t.atomic_duplicate_state\t= drm_atomic_helper_connector_duplicate_state,\n\t.atomic_destroy_state\t= drm_atomic_helper_connector_destroy_state,\n};\n\nstatic void sun4i_lvds_encoder_enable(struct drm_encoder *encoder)\n{\n\tstruct sun4i_lvds *lvds = drm_encoder_to_sun4i_lvds(encoder);\n\n\tDRM_DEBUG_DRIVER(\"Enabling LVDS output\\n\");\n\n\tif (lvds->panel) {\n\t\tdrm_panel_prepare(lvds->panel);\n\t\tdrm_panel_enable(lvds->panel);\n\t}\n}\n\nstatic void sun4i_lvds_encoder_disable(struct drm_encoder *encoder)\n{\n\tstruct sun4i_lvds *lvds = drm_encoder_to_sun4i_lvds(encoder);\n\n\tDRM_DEBUG_DRIVER(\"Disabling LVDS output\\n\");\n\n\tif (lvds->panel) {\n\t\tdrm_panel_disable(lvds->panel);\n\t\tdrm_panel_unprepare(lvds->panel);\n\t}\n}\n\nstatic const struct drm_encoder_helper_funcs sun4i_lvds_enc_helper_funcs = {\n\t.disable\t= sun4i_lvds_encoder_disable,\n\t.enable\t\t= sun4i_lvds_encoder_enable,\n};\n\nint sun4i_lvds_init(struct drm_device *drm, struct sun4i_tcon *tcon)\n{\n\tstruct drm_encoder *encoder;\n\tstruct drm_bridge *bridge;\n\tstruct sun4i_lvds *lvds;\n\tint ret;\n\n\tlvds = devm_kzalloc(drm->dev, sizeof(*lvds), GFP_KERNEL);\n\tif (!lvds)\n\t\treturn -ENOMEM;\n\tencoder = &lvds->encoder;\n\n\tret = drm_of_find_panel_or_bridge(tcon->dev->of_node, 1, 0,\n\t\t\t\t\t  &lvds->panel, &bridge);\n\tif (ret) {\n\t\tdev_info(drm->dev, \"No panel or bridge found... LVDS output disabled\\n\");\n\t\treturn 0;\n\t}\n\n\tdrm_encoder_helper_add(&lvds->encoder,\n\t\t\t       &sun4i_lvds_enc_helper_funcs);\n\tret = drm_simple_encoder_init(drm, &lvds->encoder,\n\t\t\t\t      DRM_MODE_ENCODER_LVDS);\n\tif (ret) {\n\t\tdev_err(drm->dev, \"Couldn't initialise the lvds encoder\\n\");\n\t\tgoto err_out;\n\t}\n\n\t \n\tlvds->encoder.possible_crtcs = drm_crtc_mask(&tcon->crtc->crtc);\n\n\tif (lvds->panel) {\n\t\tdrm_connector_helper_add(&lvds->connector,\n\t\t\t\t\t &sun4i_lvds_con_helper_funcs);\n\t\tret = drm_connector_init(drm, &lvds->connector,\n\t\t\t\t\t &sun4i_lvds_con_funcs,\n\t\t\t\t\t DRM_MODE_CONNECTOR_LVDS);\n\t\tif (ret) {\n\t\t\tdev_err(drm->dev, \"Couldn't initialise the lvds connector\\n\");\n\t\t\tgoto err_cleanup_connector;\n\t\t}\n\n\t\tdrm_connector_attach_encoder(&lvds->connector,\n\t\t\t\t\t\t  &lvds->encoder);\n\t}\n\n\tif (bridge) {\n\t\tret = drm_bridge_attach(encoder, bridge, NULL, 0);\n\t\tif (ret)\n\t\t\tgoto err_cleanup_connector;\n\t}\n\n\treturn 0;\n\nerr_cleanup_connector:\n\tdrm_encoder_cleanup(&lvds->encoder);\nerr_out:\n\treturn ret;\n}\nEXPORT_SYMBOL(sun4i_lvds_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}