{
  "module_name": "sun8i_hdmi_phy_clk.c",
  "hash_id": "71f9c8bf3c66bd13b15702f74487b6484fbbec63ae79c37aeca12ae5a3314898",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/sun4i/sun8i_hdmi_phy_clk.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n\n#include \"sun8i_dw_hdmi.h\"\n\nstruct sun8i_phy_clk {\n\tstruct clk_hw\t\thw;\n\tstruct sun8i_hdmi_phy\t*phy;\n};\n\nstatic inline struct sun8i_phy_clk *hw_to_phy_clk(struct clk_hw *hw)\n{\n\treturn container_of(hw, struct sun8i_phy_clk, hw);\n}\n\nstatic int sun8i_phy_clk_determine_rate(struct clk_hw *hw,\n\t\t\t\t\tstruct clk_rate_request *req)\n{\n\tunsigned long rate = req->rate;\n\tunsigned long best_rate = 0;\n\tstruct clk_hw *best_parent = NULL;\n\tstruct clk_hw *parent;\n\tint best_div = 1;\n\tint i, p;\n\n\tfor (p = 0; p < clk_hw_get_num_parents(hw); p++) {\n\t\tparent = clk_hw_get_parent_by_index(hw, p);\n\t\tif (!parent)\n\t\t\tcontinue;\n\n\t\tfor (i = 1; i <= 16; i++) {\n\t\t\tunsigned long ideal = rate * i;\n\t\t\tunsigned long rounded;\n\n\t\t\trounded = clk_hw_round_rate(parent, ideal);\n\n\t\t\tif (rounded == ideal) {\n\t\t\t\tbest_rate = rounded;\n\t\t\t\tbest_div = i;\n\t\t\t\tbest_parent = parent;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!best_rate ||\n\t\t\t    abs(rate - rounded / i) <\n\t\t\t    abs(rate - best_rate / best_div)) {\n\t\t\t\tbest_rate = rounded;\n\t\t\t\tbest_div = i;\n\t\t\t\tbest_parent = parent;\n\t\t\t}\n\t\t}\n\n\t\tif (best_rate / best_div == rate)\n\t\t\tbreak;\n\t}\n\n\treq->rate = best_rate / best_div;\n\treq->best_parent_rate = best_rate;\n\treq->best_parent_hw = best_parent;\n\n\treturn 0;\n}\n\nstatic unsigned long sun8i_phy_clk_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t       unsigned long parent_rate)\n{\n\tstruct sun8i_phy_clk *priv = hw_to_phy_clk(hw);\n\tu32 reg;\n\n\tregmap_read(priv->phy->regs, SUN8I_HDMI_PHY_PLL_CFG2_REG, &reg);\n\treg = ((reg >> SUN8I_HDMI_PHY_PLL_CFG2_PREDIV_SHIFT) &\n\t\tSUN8I_HDMI_PHY_PLL_CFG2_PREDIV_MSK) + 1;\n\n\treturn parent_rate / reg;\n}\n\nstatic int sun8i_phy_clk_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t  unsigned long parent_rate)\n{\n\tstruct sun8i_phy_clk *priv = hw_to_phy_clk(hw);\n\tunsigned long best_rate = 0;\n\tu8 best_m = 0, m;\n\n\tfor (m = 1; m <= 16; m++) {\n\t\tunsigned long tmp_rate = parent_rate / m;\n\n\t\tif (tmp_rate > rate)\n\t\t\tcontinue;\n\n\t\tif (!best_rate ||\n\t\t    (rate - tmp_rate) < (rate - best_rate)) {\n\t\t\tbest_rate = tmp_rate;\n\t\t\tbest_m = m;\n\t\t}\n\t}\n\n\tregmap_update_bits(priv->phy->regs, SUN8I_HDMI_PHY_PLL_CFG2_REG,\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG2_PREDIV_MSK,\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG2_PREDIV(best_m));\n\n\treturn 0;\n}\n\nstatic u8 sun8i_phy_clk_get_parent(struct clk_hw *hw)\n{\n\tstruct sun8i_phy_clk *priv = hw_to_phy_clk(hw);\n\tu32 reg;\n\n\tregmap_read(priv->phy->regs, SUN8I_HDMI_PHY_PLL_CFG1_REG, &reg);\n\treg = (reg & SUN8I_HDMI_PHY_PLL_CFG1_CKIN_SEL_MSK) >>\n\t      SUN8I_HDMI_PHY_PLL_CFG1_CKIN_SEL_SHIFT;\n\n\treturn reg;\n}\n\nstatic int sun8i_phy_clk_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct sun8i_phy_clk *priv = hw_to_phy_clk(hw);\n\n\tif (index > 1)\n\t\treturn -EINVAL;\n\n\tregmap_update_bits(priv->phy->regs, SUN8I_HDMI_PHY_PLL_CFG1_REG,\n\t\t\t   SUN8I_HDMI_PHY_PLL_CFG1_CKIN_SEL_MSK,\n\t\t\t   index << SUN8I_HDMI_PHY_PLL_CFG1_CKIN_SEL_SHIFT);\n\n\treturn 0;\n}\n\nstatic const struct clk_ops sun8i_phy_clk_ops = {\n\t.determine_rate\t= sun8i_phy_clk_determine_rate,\n\t.recalc_rate\t= sun8i_phy_clk_recalc_rate,\n\t.set_rate\t= sun8i_phy_clk_set_rate,\n\n\t.get_parent\t= sun8i_phy_clk_get_parent,\n\t.set_parent\t= sun8i_phy_clk_set_parent,\n};\n\nint sun8i_phy_clk_create(struct sun8i_hdmi_phy *phy, struct device *dev,\n\t\t\t bool second_parent)\n{\n\tstruct clk_init_data init;\n\tstruct sun8i_phy_clk *priv;\n\tconst char *parents[2];\n\n\tparents[0] = __clk_get_name(phy->clk_pll0);\n\tif (!parents[0])\n\t\treturn -ENODEV;\n\n\tif (second_parent) {\n\t\tparents[1] = __clk_get_name(phy->clk_pll1);\n\t\tif (!parents[1])\n\t\t\treturn -ENODEV;\n\t}\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tinit.name = \"hdmi-phy-clk\";\n\tinit.ops = &sun8i_phy_clk_ops;\n\tinit.parent_names = parents;\n\tinit.num_parents = second_parent ? 2 : 1;\n\tinit.flags = CLK_SET_RATE_PARENT;\n\n\tpriv->phy = phy;\n\tpriv->hw.init = &init;\n\n\tphy->clk_phy = devm_clk_register(dev, &priv->hw);\n\tif (IS_ERR(phy->clk_phy))\n\t\treturn PTR_ERR(phy->clk_phy);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}