{
  "module_name": "sun4i_tcon_dclk.c",
  "hash_id": "bb1a03e2f5fa5f78d8b3fff1b350b187bbe205ed8835c1995cd28750f23bd44a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/sun4i/sun4i_tcon_dclk.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/regmap.h>\n\n#include \"sun4i_tcon.h\"\n#include \"sun4i_tcon_dclk.h\"\n\nstruct sun4i_dclk {\n\tstruct clk_hw\t\thw;\n\tstruct regmap\t\t*regmap;\n\tstruct sun4i_tcon\t*tcon;\n};\n\nstatic inline struct sun4i_dclk *hw_to_dclk(struct clk_hw *hw)\n{\n\treturn container_of(hw, struct sun4i_dclk, hw);\n}\n\nstatic void sun4i_dclk_disable(struct clk_hw *hw)\n{\n\tstruct sun4i_dclk *dclk = hw_to_dclk(hw);\n\n\tregmap_update_bits(dclk->regmap, SUN4I_TCON0_DCLK_REG,\n\t\t\t   BIT(SUN4I_TCON0_DCLK_GATE_BIT), 0);\n}\n\nstatic int sun4i_dclk_enable(struct clk_hw *hw)\n{\n\tstruct sun4i_dclk *dclk = hw_to_dclk(hw);\n\n\treturn regmap_update_bits(dclk->regmap, SUN4I_TCON0_DCLK_REG,\n\t\t\t\t  BIT(SUN4I_TCON0_DCLK_GATE_BIT),\n\t\t\t\t  BIT(SUN4I_TCON0_DCLK_GATE_BIT));\n}\n\nstatic int sun4i_dclk_is_enabled(struct clk_hw *hw)\n{\n\tstruct sun4i_dclk *dclk = hw_to_dclk(hw);\n\tu32 val;\n\n\tregmap_read(dclk->regmap, SUN4I_TCON0_DCLK_REG, &val);\n\n\treturn val & BIT(SUN4I_TCON0_DCLK_GATE_BIT);\n}\n\nstatic unsigned long sun4i_dclk_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t    unsigned long parent_rate)\n{\n\tstruct sun4i_dclk *dclk = hw_to_dclk(hw);\n\tu32 val;\n\n\tregmap_read(dclk->regmap, SUN4I_TCON0_DCLK_REG, &val);\n\n\tval >>= SUN4I_TCON0_DCLK_DIV_SHIFT;\n\tval &= (1 << SUN4I_TCON0_DCLK_DIV_WIDTH) - 1;\n\n\tif (!val)\n\t\tval = 1;\n\n\treturn parent_rate / val;\n}\n\nstatic long sun4i_dclk_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t  unsigned long *parent_rate)\n{\n\tstruct sun4i_dclk *dclk = hw_to_dclk(hw);\n\tstruct sun4i_tcon *tcon = dclk->tcon;\n\tunsigned long best_parent = 0;\n\tu8 best_div = 1;\n\tint i;\n\n\tfor (i = tcon->dclk_min_div; i <= tcon->dclk_max_div; i++) {\n\t\tu64 ideal = (u64)rate * i;\n\t\tunsigned long rounded;\n\n\t\t \n\t\tif (ideal > ULONG_MAX)\n\t\t\tgoto out;\n\n\t\trounded = clk_hw_round_rate(clk_hw_get_parent(hw),\n\t\t\t\t\t    ideal);\n\n\t\tif (rounded == ideal) {\n\t\t\tbest_parent = rounded;\n\t\t\tbest_div = i;\n\t\t\tgoto out;\n\t\t}\n\n\t\tif (abs(rate - rounded / i) <\n\t\t    abs(rate - best_parent / best_div)) {\n\t\t\tbest_parent = rounded;\n\t\t\tbest_div = i;\n\t\t}\n\t}\n\nout:\n\t*parent_rate = best_parent;\n\n\treturn best_parent / best_div;\n}\n\nstatic int sun4i_dclk_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t       unsigned long parent_rate)\n{\n\tstruct sun4i_dclk *dclk = hw_to_dclk(hw);\n\tu8 div = parent_rate / rate;\n\n\treturn regmap_update_bits(dclk->regmap, SUN4I_TCON0_DCLK_REG,\n\t\t\t\t  GENMASK(6, 0), div);\n}\n\nstatic int sun4i_dclk_get_phase(struct clk_hw *hw)\n{\n\tstruct sun4i_dclk *dclk = hw_to_dclk(hw);\n\tu32 val;\n\n\tregmap_read(dclk->regmap, SUN4I_TCON0_IO_POL_REG, &val);\n\n\tval >>= 28;\n\tval &= 3;\n\n\treturn val * 120;\n}\n\nstatic int sun4i_dclk_set_phase(struct clk_hw *hw, int degrees)\n{\n\tstruct sun4i_dclk *dclk = hw_to_dclk(hw);\n\tu32 val = degrees / 120;\n\n\tval <<= 28;\n\n\tregmap_update_bits(dclk->regmap, SUN4I_TCON0_IO_POL_REG,\n\t\t\t   GENMASK(29, 28),\n\t\t\t   val);\n\n\treturn 0;\n}\n\nstatic const struct clk_ops sun4i_dclk_ops = {\n\t.disable\t= sun4i_dclk_disable,\n\t.enable\t\t= sun4i_dclk_enable,\n\t.is_enabled\t= sun4i_dclk_is_enabled,\n\n\t.recalc_rate\t= sun4i_dclk_recalc_rate,\n\t.round_rate\t= sun4i_dclk_round_rate,\n\t.set_rate\t= sun4i_dclk_set_rate,\n\n\t.get_phase\t= sun4i_dclk_get_phase,\n\t.set_phase\t= sun4i_dclk_set_phase,\n};\n\nint sun4i_dclk_create(struct device *dev, struct sun4i_tcon *tcon)\n{\n\tconst char *clk_name, *parent_name;\n\tstruct clk_init_data init;\n\tstruct sun4i_dclk *dclk;\n\tint ret;\n\n\tparent_name = __clk_get_name(tcon->sclk0);\n\tret = of_property_read_string_index(dev->of_node,\n\t\t\t\t\t    \"clock-output-names\", 0,\n\t\t\t\t\t    &clk_name);\n\tif (ret)\n\t\treturn ret;\n\n\tdclk = devm_kzalloc(dev, sizeof(*dclk), GFP_KERNEL);\n\tif (!dclk)\n\t\treturn -ENOMEM;\n\tdclk->tcon = tcon;\n\n\tinit.name = clk_name;\n\tinit.ops = &sun4i_dclk_ops;\n\tinit.parent_names = &parent_name;\n\tinit.num_parents = 1;\n\tinit.flags = CLK_SET_RATE_PARENT;\n\n\tdclk->regmap = tcon->regs;\n\tdclk->hw.init = &init;\n\n\ttcon->dclk = clk_register(dev, &dclk->hw);\n\tif (IS_ERR(tcon->dclk))\n\t\treturn PTR_ERR(tcon->dclk);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(sun4i_dclk_create);\n\nint sun4i_dclk_free(struct sun4i_tcon *tcon)\n{\n\tclk_unregister(tcon->dclk);\n\treturn 0;\n}\nEXPORT_SYMBOL(sun4i_dclk_free);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}