{
  "module_name": "drm_fbdev_dma.c",
  "hash_id": "1dba7a77abc404e286ac98c08ed7b42bd05ecf9d86703b62cbc400bb6efea932",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/drm_fbdev_dma.c",
  "human_readable_source": "\n\n#include <linux/fb.h>\n\n#include <drm/drm_crtc_helper.h>\n#include <drm/drm_drv.h>\n#include <drm/drm_fb_helper.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem_dma_helper.h>\n\n#include <drm/drm_fbdev_dma.h>\n\n \n\nstatic int drm_fbdev_dma_fb_open(struct fb_info *info, int user)\n{\n\tstruct drm_fb_helper *fb_helper = info->par;\n\n\t \n\tif (user && !try_module_get(fb_helper->dev->driver->fops->owner))\n\t\treturn -ENODEV;\n\n\treturn 0;\n}\n\nstatic int drm_fbdev_dma_fb_release(struct fb_info *info, int user)\n{\n\tstruct drm_fb_helper *fb_helper = info->par;\n\n\tif (user)\n\t\tmodule_put(fb_helper->dev->driver->fops->owner);\n\n\treturn 0;\n}\n\nstatic void drm_fbdev_dma_fb_destroy(struct fb_info *info)\n{\n\tstruct drm_fb_helper *fb_helper = info->par;\n\n\tif (!fb_helper->dev)\n\t\treturn;\n\n\tdrm_fb_helper_fini(fb_helper);\n\n\tdrm_client_buffer_vunmap(fb_helper->buffer);\n\tdrm_client_framebuffer_delete(fb_helper->buffer);\n\tdrm_client_release(&fb_helper->client);\n\tdrm_fb_helper_unprepare(fb_helper);\n\tkfree(fb_helper);\n}\n\nstatic int drm_fbdev_dma_fb_mmap(struct fb_info *info, struct vm_area_struct *vma)\n{\n\tstruct drm_fb_helper *fb_helper = info->par;\n\n\treturn drm_gem_prime_mmap(fb_helper->buffer->gem, vma);\n}\n\nstatic const struct fb_ops drm_fbdev_dma_fb_ops = {\n\t.owner = THIS_MODULE,\n\t.fb_open = drm_fbdev_dma_fb_open,\n\t.fb_release = drm_fbdev_dma_fb_release,\n\t__FB_DEFAULT_DMAMEM_OPS_RDWR,\n\tDRM_FB_HELPER_DEFAULT_OPS,\n\t__FB_DEFAULT_DMAMEM_OPS_DRAW,\n\t.fb_mmap = drm_fbdev_dma_fb_mmap,\n\t.fb_destroy = drm_fbdev_dma_fb_destroy,\n};\n\n \n\nstatic int drm_fbdev_dma_helper_fb_probe(struct drm_fb_helper *fb_helper,\n\t\t\t\t\t struct drm_fb_helper_surface_size *sizes)\n{\n\tstruct drm_client_dev *client = &fb_helper->client;\n\tstruct drm_device *dev = fb_helper->dev;\n\tstruct drm_client_buffer *buffer;\n\tstruct drm_gem_dma_object *dma_obj;\n\tstruct drm_framebuffer *fb;\n\tstruct fb_info *info;\n\tu32 format;\n\tstruct iosys_map map;\n\tint ret;\n\n\tdrm_dbg_kms(dev, \"surface width(%d), height(%d) and bpp(%d)\\n\",\n\t\t    sizes->surface_width, sizes->surface_height,\n\t\t    sizes->surface_bpp);\n\n\tformat = drm_mode_legacy_fb_format(sizes->surface_bpp, sizes->surface_depth);\n\tbuffer = drm_client_framebuffer_create(client, sizes->surface_width,\n\t\t\t\t\t       sizes->surface_height, format);\n\tif (IS_ERR(buffer))\n\t\treturn PTR_ERR(buffer);\n\tdma_obj = to_drm_gem_dma_obj(buffer->gem);\n\n\tfb = buffer->fb;\n\tif (drm_WARN_ON(dev, fb->funcs->dirty)) {\n\t\tret = -ENODEV;  \n\t\tgoto err_drm_client_buffer_delete;\n\t}\n\n\tret = drm_client_buffer_vmap(buffer, &map);\n\tif (ret) {\n\t\tgoto err_drm_client_buffer_delete;\n\t} else if (drm_WARN_ON(dev, map.is_iomem)) {\n\t\tret = -ENODEV;  \n\t\tgoto err_drm_client_buffer_delete;\n\t}\n\n\tfb_helper->buffer = buffer;\n\tfb_helper->fb = buffer->fb;\n\n\tinfo = drm_fb_helper_alloc_info(fb_helper);\n\tif (IS_ERR(info)) {\n\t\tret = PTR_ERR(info);\n\t\tgoto err_drm_client_buffer_vunmap;\n\t}\n\n\tdrm_fb_helper_fill_info(info, fb_helper, sizes);\n\n\tinfo->fbops = &drm_fbdev_dma_fb_ops;\n\n\t \n\tinfo->flags |= FBINFO_VIRTFB;  \n\tif (dma_obj->map_noncoherent)\n\t\tinfo->flags |= FBINFO_READS_FAST;  \n\tinfo->screen_size = sizes->surface_height * fb->pitches[0];\n\tinfo->screen_buffer = map.vaddr;\n\tinfo->fix.smem_start = page_to_phys(virt_to_page(info->screen_buffer));\n\tinfo->fix.smem_len = info->screen_size;\n\n\treturn 0;\n\nerr_drm_client_buffer_vunmap:\n\tfb_helper->fb = NULL;\n\tfb_helper->buffer = NULL;\n\tdrm_client_buffer_vunmap(buffer);\nerr_drm_client_buffer_delete:\n\tdrm_client_framebuffer_delete(buffer);\n\treturn ret;\n}\n\nstatic const struct drm_fb_helper_funcs drm_fbdev_dma_helper_funcs = {\n\t.fb_probe = drm_fbdev_dma_helper_fb_probe,\n};\n\n \n\nstatic void drm_fbdev_dma_client_unregister(struct drm_client_dev *client)\n{\n\tstruct drm_fb_helper *fb_helper = drm_fb_helper_from_client(client);\n\n\tif (fb_helper->info) {\n\t\tdrm_fb_helper_unregister_info(fb_helper);\n\t} else {\n\t\tdrm_client_release(&fb_helper->client);\n\t\tdrm_fb_helper_unprepare(fb_helper);\n\t\tkfree(fb_helper);\n\t}\n}\n\nstatic int drm_fbdev_dma_client_restore(struct drm_client_dev *client)\n{\n\tdrm_fb_helper_lastclose(client->dev);\n\n\treturn 0;\n}\n\nstatic int drm_fbdev_dma_client_hotplug(struct drm_client_dev *client)\n{\n\tstruct drm_fb_helper *fb_helper = drm_fb_helper_from_client(client);\n\tstruct drm_device *dev = client->dev;\n\tint ret;\n\n\tif (dev->fb_helper)\n\t\treturn drm_fb_helper_hotplug_event(dev->fb_helper);\n\n\tret = drm_fb_helper_init(dev, fb_helper);\n\tif (ret)\n\t\tgoto err_drm_err;\n\n\tif (!drm_drv_uses_atomic_modeset(dev))\n\t\tdrm_helper_disable_unused_functions(dev);\n\n\tret = drm_fb_helper_initial_config(fb_helper);\n\tif (ret)\n\t\tgoto err_drm_fb_helper_fini;\n\n\treturn 0;\n\nerr_drm_fb_helper_fini:\n\tdrm_fb_helper_fini(fb_helper);\nerr_drm_err:\n\tdrm_err(dev, \"fbdev-dma: Failed to setup generic emulation (ret=%d)\\n\", ret);\n\treturn ret;\n}\n\nstatic const struct drm_client_funcs drm_fbdev_dma_client_funcs = {\n\t.owner\t\t= THIS_MODULE,\n\t.unregister\t= drm_fbdev_dma_client_unregister,\n\t.restore\t= drm_fbdev_dma_client_restore,\n\t.hotplug\t= drm_fbdev_dma_client_hotplug,\n};\n\n \nvoid drm_fbdev_dma_setup(struct drm_device *dev, unsigned int preferred_bpp)\n{\n\tstruct drm_fb_helper *fb_helper;\n\tint ret;\n\n\tdrm_WARN(dev, !dev->registered, \"Device has not been registered.\\n\");\n\tdrm_WARN(dev, dev->fb_helper, \"fb_helper is already set!\\n\");\n\n\tfb_helper = kzalloc(sizeof(*fb_helper), GFP_KERNEL);\n\tif (!fb_helper)\n\t\treturn;\n\tdrm_fb_helper_prepare(dev, fb_helper, preferred_bpp, &drm_fbdev_dma_helper_funcs);\n\n\tret = drm_client_init(dev, &fb_helper->client, \"fbdev\", &drm_fbdev_dma_client_funcs);\n\tif (ret) {\n\t\tdrm_err(dev, \"Failed to register client: %d\\n\", ret);\n\t\tgoto err_drm_client_init;\n\t}\n\n\tdrm_client_register(&fb_helper->client);\n\n\treturn;\n\nerr_drm_client_init:\n\tdrm_fb_helper_unprepare(fb_helper);\n\tkfree(fb_helper);\n}\nEXPORT_SYMBOL(drm_fbdev_dma_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}