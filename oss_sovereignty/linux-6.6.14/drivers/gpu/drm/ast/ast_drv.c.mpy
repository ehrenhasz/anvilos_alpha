{
  "module_name": "ast_drv.c",
  "hash_id": "0af62353de9699b8dd368b4a2d3d4f46082f514bd2d7d507aa2a37edc57e5c7e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/ast/ast_drv.c",
  "human_readable_source": " \n \n\n#include <linux/module.h>\n#include <linux/pci.h>\n\n#include <drm/drm_aperture.h>\n#include <drm/drm_atomic_helper.h>\n#include <drm/drm_drv.h>\n#include <drm/drm_fbdev_generic.h>\n#include <drm/drm_gem_shmem_helper.h>\n#include <drm/drm_module.h>\n#include <drm/drm_probe_helper.h>\n\n#include \"ast_drv.h\"\n\nstatic int ast_modeset = -1;\n\nMODULE_PARM_DESC(modeset, \"Disable/Enable modesetting\");\nmodule_param_named(modeset, ast_modeset, int, 0400);\n\n \n\nDEFINE_DRM_GEM_FOPS(ast_fops);\n\nstatic const struct drm_driver ast_driver = {\n\t.driver_features = DRIVER_ATOMIC |\n\t\t\t   DRIVER_GEM |\n\t\t\t   DRIVER_MODESET,\n\n\t.fops = &ast_fops,\n\t.name = DRIVER_NAME,\n\t.desc = DRIVER_DESC,\n\t.date = DRIVER_DATE,\n\t.major = DRIVER_MAJOR,\n\t.minor = DRIVER_MINOR,\n\t.patchlevel = DRIVER_PATCHLEVEL,\n\n\tDRM_GEM_SHMEM_DRIVER_OPS\n};\n\n \n\n#define PCI_VENDOR_ASPEED 0x1a03\n\n#define AST_VGA_DEVICE(id, info) {\t\t\\\n\t.class = PCI_BASE_CLASS_DISPLAY << 16,\t\\\n\t.class_mask = 0xff0000,\t\t\t\\\n\t.vendor = PCI_VENDOR_ASPEED,\t\t\t\\\n\t.device = id,\t\t\t\t\\\n\t.subvendor = PCI_ANY_ID,\t\t\\\n\t.subdevice = PCI_ANY_ID,\t\t\\\n\t.driver_data = (unsigned long) info }\n\nstatic const struct pci_device_id ast_pciidlist[] = {\n\tAST_VGA_DEVICE(PCI_CHIP_AST2000, NULL),\n\tAST_VGA_DEVICE(PCI_CHIP_AST2100, NULL),\n\t{0, 0, 0},\n};\n\nMODULE_DEVICE_TABLE(pci, ast_pciidlist);\n\nstatic int ast_pci_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\n{\n\tstruct ast_device *ast;\n\tstruct drm_device *dev;\n\tint ret;\n\n\tret = drm_aperture_remove_conflicting_pci_framebuffers(pdev, &ast_driver);\n\tif (ret)\n\t\treturn ret;\n\n\tret = pcim_enable_device(pdev);\n\tif (ret)\n\t\treturn ret;\n\n\tast = ast_device_create(&ast_driver, pdev, ent->driver_data);\n\tif (IS_ERR(ast))\n\t\treturn PTR_ERR(ast);\n\tdev = &ast->base;\n\n\tret = drm_dev_register(dev, ent->driver_data);\n\tif (ret)\n\t\treturn ret;\n\n\tdrm_fbdev_generic_setup(dev, 32);\n\n\treturn 0;\n}\n\nstatic void ast_pci_remove(struct pci_dev *pdev)\n{\n\tstruct drm_device *dev = pci_get_drvdata(pdev);\n\n\tdrm_dev_unregister(dev);\n\tdrm_atomic_helper_shutdown(dev);\n}\n\nstatic int ast_drm_freeze(struct drm_device *dev)\n{\n\tint error;\n\n\terror = drm_mode_config_helper_suspend(dev);\n\tif (error)\n\t\treturn error;\n\tpci_save_state(to_pci_dev(dev->dev));\n\treturn 0;\n}\n\nstatic int ast_drm_thaw(struct drm_device *dev)\n{\n\tast_post_gpu(dev);\n\n\treturn drm_mode_config_helper_resume(dev);\n}\n\nstatic int ast_drm_resume(struct drm_device *dev)\n{\n\tif (pci_enable_device(to_pci_dev(dev->dev)))\n\t\treturn -EIO;\n\n\treturn ast_drm_thaw(dev);\n}\n\nstatic int ast_pm_suspend(struct device *dev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n\tstruct drm_device *ddev = pci_get_drvdata(pdev);\n\tint error;\n\n\terror = ast_drm_freeze(ddev);\n\tif (error)\n\t\treturn error;\n\n\tpci_disable_device(pdev);\n\tpci_set_power_state(pdev, PCI_D3hot);\n\treturn 0;\n}\n\nstatic int ast_pm_resume(struct device *dev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n\tstruct drm_device *ddev = pci_get_drvdata(pdev);\n\treturn ast_drm_resume(ddev);\n}\n\nstatic int ast_pm_freeze(struct device *dev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n\tstruct drm_device *ddev = pci_get_drvdata(pdev);\n\treturn ast_drm_freeze(ddev);\n}\n\nstatic int ast_pm_thaw(struct device *dev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n\tstruct drm_device *ddev = pci_get_drvdata(pdev);\n\treturn ast_drm_thaw(ddev);\n}\n\nstatic int ast_pm_poweroff(struct device *dev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n\tstruct drm_device *ddev = pci_get_drvdata(pdev);\n\n\treturn ast_drm_freeze(ddev);\n}\n\nstatic const struct dev_pm_ops ast_pm_ops = {\n\t.suspend = ast_pm_suspend,\n\t.resume = ast_pm_resume,\n\t.freeze = ast_pm_freeze,\n\t.thaw = ast_pm_thaw,\n\t.poweroff = ast_pm_poweroff,\n\t.restore = ast_pm_resume,\n};\n\nstatic struct pci_driver ast_pci_driver = {\n\t.name = DRIVER_NAME,\n\t.id_table = ast_pciidlist,\n\t.probe = ast_pci_probe,\n\t.remove = ast_pci_remove,\n\t.driver.pm = &ast_pm_ops,\n};\n\ndrm_module_pci_driver_if_modeset(ast_pci_driver, ast_modeset);\n\nMODULE_AUTHOR(DRIVER_AUTHOR);\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL and additional rights\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}