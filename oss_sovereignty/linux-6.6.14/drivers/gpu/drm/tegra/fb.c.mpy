{
  "module_name": "fb.c",
  "hash_id": "76db2ad392955e3740a402104fbc13981ac97f20d9afeb258da7fb660cb97e1b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/tegra/fb.c",
  "human_readable_source": "\n \n\n#include <linux/console.h>\n\n#include <drm/drm_fourcc.h>\n#include <drm/drm_framebuffer.h>\n#include <drm/drm_gem_framebuffer_helper.h>\n#include <drm/drm_modeset_helper.h>\n\n#include \"drm.h\"\n#include \"gem.h\"\n\nstruct tegra_bo *tegra_fb_get_plane(struct drm_framebuffer *framebuffer,\n\t\t\t\t    unsigned int index)\n{\n\treturn to_tegra_bo(drm_gem_fb_get_obj(framebuffer, index));\n}\n\nbool tegra_fb_is_bottom_up(struct drm_framebuffer *framebuffer)\n{\n\tstruct tegra_bo *bo = tegra_fb_get_plane(framebuffer, 0);\n\n\tif (bo->flags & TEGRA_BO_BOTTOM_UP)\n\t\treturn true;\n\n\treturn false;\n}\n\nint tegra_fb_get_tiling(struct drm_framebuffer *framebuffer,\n\t\t\tstruct tegra_bo_tiling *tiling)\n{\n\tuint64_t modifier = framebuffer->modifier;\n\n\tif (fourcc_mod_is_vendor(modifier, NVIDIA)) {\n\t\tif ((modifier & DRM_FORMAT_MOD_NVIDIA_SECTOR_LAYOUT) == 0)\n\t\t\ttiling->sector_layout = TEGRA_BO_SECTOR_LAYOUT_TEGRA;\n\t\telse\n\t\t\ttiling->sector_layout = TEGRA_BO_SECTOR_LAYOUT_GPU;\n\n\t\tmodifier &= ~DRM_FORMAT_MOD_NVIDIA_SECTOR_LAYOUT;\n\t}\n\n\tswitch (modifier) {\n\tcase DRM_FORMAT_MOD_LINEAR:\n\t\ttiling->mode = TEGRA_BO_TILING_MODE_PITCH;\n\t\ttiling->value = 0;\n\t\tbreak;\n\n\tcase DRM_FORMAT_MOD_NVIDIA_TEGRA_TILED:\n\t\ttiling->mode = TEGRA_BO_TILING_MODE_TILED;\n\t\ttiling->value = 0;\n\t\tbreak;\n\n\tcase DRM_FORMAT_MOD_NVIDIA_16BX2_BLOCK(0):\n\t\ttiling->mode = TEGRA_BO_TILING_MODE_BLOCK;\n\t\ttiling->value = 0;\n\t\tbreak;\n\n\tcase DRM_FORMAT_MOD_NVIDIA_16BX2_BLOCK(1):\n\t\ttiling->mode = TEGRA_BO_TILING_MODE_BLOCK;\n\t\ttiling->value = 1;\n\t\tbreak;\n\n\tcase DRM_FORMAT_MOD_NVIDIA_16BX2_BLOCK(2):\n\t\ttiling->mode = TEGRA_BO_TILING_MODE_BLOCK;\n\t\ttiling->value = 2;\n\t\tbreak;\n\n\tcase DRM_FORMAT_MOD_NVIDIA_16BX2_BLOCK(3):\n\t\ttiling->mode = TEGRA_BO_TILING_MODE_BLOCK;\n\t\ttiling->value = 3;\n\t\tbreak;\n\n\tcase DRM_FORMAT_MOD_NVIDIA_16BX2_BLOCK(4):\n\t\ttiling->mode = TEGRA_BO_TILING_MODE_BLOCK;\n\t\ttiling->value = 4;\n\t\tbreak;\n\n\tcase DRM_FORMAT_MOD_NVIDIA_16BX2_BLOCK(5):\n\t\ttiling->mode = TEGRA_BO_TILING_MODE_BLOCK;\n\t\ttiling->value = 5;\n\t\tbreak;\n\n\tdefault:\n\t\tDRM_DEBUG_KMS(\"unknown format modifier: %llx\\n\", modifier);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct drm_framebuffer_funcs tegra_fb_funcs = {\n\t.destroy = drm_gem_fb_destroy,\n\t.create_handle = drm_gem_fb_create_handle,\n};\n\nstruct drm_framebuffer *tegra_fb_alloc(struct drm_device *drm,\n\t\t\t\t       const struct drm_mode_fb_cmd2 *mode_cmd,\n\t\t\t\t       struct tegra_bo **planes,\n\t\t\t\t       unsigned int num_planes)\n{\n\tstruct drm_framebuffer *fb;\n\tunsigned int i;\n\tint err;\n\n\tfb = kzalloc(sizeof(*fb), GFP_KERNEL);\n\tif (!fb)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tdrm_helper_mode_fill_fb_struct(drm, fb, mode_cmd);\n\n\tfor (i = 0; i < fb->format->num_planes; i++)\n\t\tfb->obj[i] = &planes[i]->gem;\n\n\terr = drm_framebuffer_init(drm, fb, &tegra_fb_funcs);\n\tif (err < 0) {\n\t\tdev_err(drm->dev, \"failed to initialize framebuffer: %d\\n\",\n\t\t\terr);\n\t\tkfree(fb);\n\t\treturn ERR_PTR(err);\n\t}\n\n\treturn fb;\n}\n\nstruct drm_framebuffer *tegra_fb_create(struct drm_device *drm,\n\t\t\t\t\tstruct drm_file *file,\n\t\t\t\t\tconst struct drm_mode_fb_cmd2 *cmd)\n{\n\tconst struct drm_format_info *info = drm_get_format_info(drm, cmd);\n\tstruct tegra_bo *planes[4];\n\tstruct drm_gem_object *gem;\n\tstruct drm_framebuffer *fb;\n\tunsigned int i;\n\tint err;\n\n\tfor (i = 0; i < info->num_planes; i++) {\n\t\tunsigned int width = cmd->width / (i ? info->hsub : 1);\n\t\tunsigned int height = cmd->height / (i ? info->vsub : 1);\n\t\tunsigned int size, bpp;\n\n\t\tgem = drm_gem_object_lookup(file, cmd->handles[i]);\n\t\tif (!gem) {\n\t\t\terr = -ENXIO;\n\t\t\tgoto unreference;\n\t\t}\n\n\t\tbpp = info->cpp[i];\n\n\t\tsize = (height - 1) * cmd->pitches[i] +\n\t\t       width * bpp + cmd->offsets[i];\n\n\t\tif (gem->size < size) {\n\t\t\terr = -EINVAL;\n\t\t\tgoto unreference;\n\t\t}\n\n\t\tplanes[i] = to_tegra_bo(gem);\n\t}\n\n\tfb = tegra_fb_alloc(drm, cmd, planes, i);\n\tif (IS_ERR(fb)) {\n\t\terr = PTR_ERR(fb);\n\t\tgoto unreference;\n\t}\n\n\treturn fb;\n\nunreference:\n\twhile (i--)\n\t\tdrm_gem_object_put(&planes[i]->gem);\n\n\treturn ERR_PTR(err);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}