{
  "module_name": "armada_fb.c",
  "hash_id": "802c38241014f99d9ab534fea7366cf7daeba1624e8e16dc31ea5669f6e2f9cf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpu/drm/armada/armada_fb.c",
  "human_readable_source": "\n \n\n#include <drm/drm_modeset_helper.h>\n#include <drm/drm_fourcc.h>\n#include <drm/drm_gem_framebuffer_helper.h>\n\n#include \"armada_drm.h\"\n#include \"armada_fb.h\"\n#include \"armada_gem.h\"\n#include \"armada_hw.h\"\n\nstatic const struct drm_framebuffer_funcs armada_fb_funcs = {\n\t.destroy\t= drm_gem_fb_destroy,\n\t.create_handle\t= drm_gem_fb_create_handle,\n};\n\nstruct armada_framebuffer *armada_framebuffer_create(struct drm_device *dev,\n\tconst struct drm_mode_fb_cmd2 *mode, struct armada_gem_object *obj)\n{\n\tstruct armada_framebuffer *dfb;\n\tuint8_t format, config;\n\tint ret;\n\n\tswitch (mode->pixel_format) {\n#define FMT(drm, fmt, mod)\t\t\\\n\tcase DRM_FORMAT_##drm:\t\t\\\n\t\tformat = CFG_##fmt;\t\\\n\t\tconfig = mod;\t\t\\\n\t\tbreak\n\tFMT(RGB565,\t565,\t\tCFG_SWAPRB);\n\tFMT(BGR565,\t565,\t\t0);\n\tFMT(ARGB1555,\t1555,\t\tCFG_SWAPRB);\n\tFMT(ABGR1555,\t1555,\t\t0);\n\tFMT(RGB888,\t888PACK,\tCFG_SWAPRB);\n\tFMT(BGR888,\t888PACK,\t0);\n\tFMT(XRGB8888,\tX888,\t\tCFG_SWAPRB);\n\tFMT(XBGR8888,\tX888,\t\t0);\n\tFMT(ARGB8888,\t8888,\t\tCFG_SWAPRB);\n\tFMT(ABGR8888,\t8888,\t\t0);\n\tFMT(YUYV,\t422PACK,\tCFG_YUV2RGB | CFG_SWAPYU | CFG_SWAPUV);\n\tFMT(UYVY,\t422PACK,\tCFG_YUV2RGB);\n\tFMT(VYUY,\t422PACK,\tCFG_YUV2RGB | CFG_SWAPUV);\n\tFMT(YVYU,\t422PACK,\tCFG_YUV2RGB | CFG_SWAPYU);\n\tFMT(YUV422,\t422,\t\tCFG_YUV2RGB);\n\tFMT(YVU422,\t422,\t\tCFG_YUV2RGB | CFG_SWAPUV);\n\tFMT(YUV420,\t420,\t\tCFG_YUV2RGB);\n\tFMT(YVU420,\t420,\t\tCFG_YUV2RGB | CFG_SWAPUV);\n\tFMT(C8,\t\tPSEUDO8,\t0);\n#undef FMT\n\tdefault:\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tdfb = kzalloc(sizeof(*dfb), GFP_KERNEL);\n\tif (!dfb) {\n\t\tDRM_ERROR(\"failed to allocate Armada fb object\\n\");\n\t\treturn ERR_PTR(-ENOMEM);\n\t}\n\n\tdfb->fmt = format;\n\tdfb->mod = config;\n\tdfb->fb.obj[0] = &obj->obj;\n\n\tdrm_helper_mode_fill_fb_struct(dev, &dfb->fb, mode);\n\n\tret = drm_framebuffer_init(dev, &dfb->fb, &armada_fb_funcs);\n\tif (ret) {\n\t\tkfree(dfb);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\t \n\tdrm_gem_object_get(&obj->obj);\n\n\treturn dfb;\n}\n\nstruct drm_framebuffer *armada_fb_create(struct drm_device *dev,\n\tstruct drm_file *dfile, const struct drm_mode_fb_cmd2 *mode)\n{\n\tconst struct drm_format_info *info = drm_get_format_info(dev, mode);\n\tstruct armada_gem_object *obj;\n\tstruct armada_framebuffer *dfb;\n\tint ret;\n\n\tDRM_DEBUG_DRIVER(\"w%u h%u pf%08x f%u p%u,%u,%u\\n\",\n\t\tmode->width, mode->height, mode->pixel_format,\n\t\tmode->flags, mode->pitches[0], mode->pitches[1],\n\t\tmode->pitches[2]);\n\n\t \n\tif (info->num_planes > 1 &&\n\t    (mode->handles[0] != mode->handles[1] ||\n\t     mode->handles[0] != mode->handles[2])) {\n\t\tret = -EINVAL;\n\t\tgoto err;\n\t}\n\n\tobj = armada_gem_object_lookup(dfile, mode->handles[0]);\n\tif (!obj) {\n\t\tret = -ENOENT;\n\t\tgoto err;\n\t}\n\n\tif (obj->obj.import_attach && !obj->sgt) {\n\t\tret = armada_gem_map_import(obj);\n\t\tif (ret)\n\t\t\tgoto err_unref;\n\t}\n\n\t \n\tif (!obj->mapped) {\n\t\tret = -EINVAL;\n\t\tgoto err_unref;\n\t}\n\n\tdfb = armada_framebuffer_create(dev, mode, obj);\n\tif (IS_ERR(dfb)) {\n\t\tret = PTR_ERR(dfb);\n\t\tgoto err;\n\t}\n\n\tdrm_gem_object_put(&obj->obj);\n\n\treturn &dfb->fb;\n\n err_unref:\n\tdrm_gem_object_put(&obj->obj);\n err:\n\tDRM_ERROR(\"failed to initialize framebuffer: %d\\n\", ret);\n\treturn ERR_PTR(ret);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}