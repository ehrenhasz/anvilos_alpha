{
  "module_name": "nsprepkg.c",
  "hash_id": "45f896cad2e1374f2f519e174b77348a83e772b21569924c72bfcec3b83b6314",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/acpica/nsprepkg.c",
  "human_readable_source": "\n \n\n#include <acpi/acpi.h>\n#include \"accommon.h\"\n#include \"acnamesp.h\"\n#include \"acpredef.h\"\n\n#define _COMPONENT          ACPI_NAMESPACE\nACPI_MODULE_NAME(\"nsprepkg\")\n\n \nstatic acpi_status\nacpi_ns_check_package_list(struct acpi_evaluate_info *info,\n\t\t\t   const union acpi_predefined_info *package,\n\t\t\t   union acpi_operand_object **elements, u32 count);\n\nstatic acpi_status\nacpi_ns_check_package_elements(struct acpi_evaluate_info *info,\n\t\t\t       union acpi_operand_object **elements,\n\t\t\t       u8 type1,\n\t\t\t       u32 count1,\n\t\t\t       u8 type2, u32 count2, u32 start_index);\n\nstatic acpi_status\nacpi_ns_custom_package(struct acpi_evaluate_info *info,\n\t\t       union acpi_operand_object **elements, u32 count);\n\n \n\nacpi_status\nacpi_ns_check_package(struct acpi_evaluate_info *info,\n\t\t      union acpi_operand_object **return_object_ptr)\n{\n\tunion acpi_operand_object *return_object = *return_object_ptr;\n\tconst union acpi_predefined_info *package;\n\tunion acpi_operand_object **elements;\n\tacpi_status status = AE_OK;\n\tu32 expected_count;\n\tu32 count;\n\tu32 i;\n\n\tACPI_FUNCTION_TRACE(ns_check_package);\n\n\t \n\n\tpackage = info->predefined + 1;\n\n\tACPI_DEBUG_PRINT((ACPI_DB_NAMES,\n\t\t\t  \"%s Validating return Package of Type %X, Count %X\\n\",\n\t\t\t  info->full_pathname, package->ret_info.type,\n\t\t\t  return_object->package.count));\n\n\t \n\tacpi_ns_remove_null_elements(info, package->ret_info.type,\n\t\t\t\t     return_object);\n\n\t \n\n\telements = return_object->package.elements;\n\tcount = return_object->package.count;\n\n\t \n\tif (!count) {\n\t\tif (package->ret_info.type == ACPI_PTYPE1_VAR) {\n\t\t\treturn_ACPI_STATUS(AE_OK);\n\t\t}\n\n\t\tACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\n\t\t\t\t      info->node_flags,\n\t\t\t\t      \"Return Package has no elements (empty)\"));\n\n\t\treturn_ACPI_STATUS(AE_AML_OPERAND_VALUE);\n\t}\n\n\t \n\tswitch (package->ret_info.type) {\n\tcase ACPI_PTYPE_CUSTOM:\n\n\t\tstatus = acpi_ns_custom_package(info, elements, count);\n\t\tbreak;\n\n\tcase ACPI_PTYPE1_FIXED:\n\t\t \n\t\texpected_count =\n\t\t    package->ret_info.count1 + package->ret_info.count2;\n\t\tif (count < expected_count) {\n\t\t\tgoto package_too_small;\n\t\t} else if (count > expected_count) {\n\t\t\tACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\n\t\t\t\t\t  \"%s: Return Package is larger than needed - \"\n\t\t\t\t\t  \"found %u, expected %u\\n\",\n\t\t\t\t\t  info->full_pathname, count,\n\t\t\t\t\t  expected_count));\n\t\t}\n\n\t\t \n\n\t\tstatus = acpi_ns_check_package_elements(info, elements,\n\t\t\t\t\t\t\tpackage->ret_info.\n\t\t\t\t\t\t\tobject_type1,\n\t\t\t\t\t\t\tpackage->ret_info.\n\t\t\t\t\t\t\tcount1,\n\t\t\t\t\t\t\tpackage->ret_info.\n\t\t\t\t\t\t\tobject_type2,\n\t\t\t\t\t\t\tpackage->ret_info.\n\t\t\t\t\t\t\tcount2, 0);\n\t\tbreak;\n\n\tcase ACPI_PTYPE1_VAR:\n\t\t \n\t\tfor (i = 0; i < count; i++) {\n\t\t\tstatus = acpi_ns_check_object_type(info, elements,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   object_type1, i);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t}\n\n\t\t\telements++;\n\t\t}\n\t\tbreak;\n\n\tcase ACPI_PTYPE1_OPTION:\n\t\t \n\t\texpected_count = package->ret_info3.count;\n\t\tif (count < expected_count) {\n\t\t\tgoto package_too_small;\n\t\t}\n\n\t\t \n\n\t\tfor (i = 0; i < count; i++) {\n\t\t\tif (i < package->ret_info3.count) {\n\n\t\t\t\t \n\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ns_check_object_type(info, elements,\n\t\t\t\t\t\t\t      package->\n\t\t\t\t\t\t\t      ret_info3.\n\t\t\t\t\t\t\t      object_type[i],\n\t\t\t\t\t\t\t      i);\n\t\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t \n\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ns_check_object_type(info, elements,\n\t\t\t\t\t\t\t      package->\n\t\t\t\t\t\t\t      ret_info3.\n\t\t\t\t\t\t\t      tail_object_type,\n\t\t\t\t\t\t\t      i);\n\t\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\telements++;\n\t\t}\n\t\tbreak;\n\n\tcase ACPI_PTYPE2_REV_FIXED:\n\n\t\t \n\n\t\tstatus =\n\t\t    acpi_ns_check_object_type(info, elements,\n\t\t\t\t\t      ACPI_RTYPE_INTEGER, 0);\n\t\tif (ACPI_FAILURE(status)) {\n\t\t\treturn_ACPI_STATUS(status);\n\t\t}\n\n\t\telements++;\n\t\tcount--;\n\n\t\t \n\n\t\tstatus =\n\t\t    acpi_ns_check_package_list(info, package, elements, count);\n\t\tbreak;\n\n\tcase ACPI_PTYPE2_PKG_COUNT:\n\n\t\t \n\n\t\tstatus =\n\t\t    acpi_ns_check_object_type(info, elements,\n\t\t\t\t\t      ACPI_RTYPE_INTEGER, 0);\n\t\tif (ACPI_FAILURE(status)) {\n\t\t\treturn_ACPI_STATUS(status);\n\t\t}\n\n\t\t \n\t\texpected_count = (u32)(*elements)->integer.value;\n\t\tif (expected_count >= count) {\n\t\t\tgoto package_too_small;\n\t\t}\n\n\t\tcount = expected_count;\n\t\telements++;\n\n\t\t \n\n\t\tstatus =\n\t\t    acpi_ns_check_package_list(info, package, elements, count);\n\t\tbreak;\n\n\tcase ACPI_PTYPE2:\n\tcase ACPI_PTYPE2_FIXED:\n\tcase ACPI_PTYPE2_MIN:\n\tcase ACPI_PTYPE2_COUNT:\n\tcase ACPI_PTYPE2_FIX_VAR:\n\t\t \n\t\tif (*elements\n\t\t    && ((*elements)->common.type != ACPI_TYPE_PACKAGE)) {\n\n\t\t\t \n\n\t\t\tstatus =\n\t\t\t    acpi_ns_wrap_with_package(info, return_object,\n\t\t\t\t\t\t      return_object_ptr);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t}\n\n\t\t\t \n\n\t\t\treturn_object = *return_object_ptr;\n\t\t\telements = return_object->package.elements;\n\t\t\tcount = 1;\n\t\t}\n\n\t\t \n\n\t\tstatus =\n\t\t    acpi_ns_check_package_list(info, package, elements, count);\n\t\tbreak;\n\n\tcase ACPI_PTYPE2_VAR_VAR:\n\t\t \n\t\tbreak;\n\n\tcase ACPI_PTYPE2_UUID_PAIR:\n\n\t\t \n\n\t\tif (count & 1) {\n\t\t\texpected_count = count + 1;\n\t\t\tgoto package_too_small;\n\t\t}\n\n\t\twhile (count > 0) {\n\t\t\tstatus = acpi_ns_check_object_type(info, elements,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   object_type1, 0);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t}\n\n\t\t\t \n\n\t\t\tif ((*elements)->buffer.length != 16) {\n\t\t\t\tACPI_WARN_PREDEFINED((AE_INFO,\n\t\t\t\t\t\t      info->full_pathname,\n\t\t\t\t\t\t      info->node_flags,\n\t\t\t\t\t\t      \"Invalid length for UUID Buffer\"));\n\t\t\t\treturn_ACPI_STATUS(AE_AML_OPERAND_VALUE);\n\t\t\t}\n\n\t\t\tstatus = acpi_ns_check_object_type(info, elements + 1,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   object_type2, 0);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t}\n\n\t\t\telements += 2;\n\t\t\tcount -= 2;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\n\t\t \n\n\t\tACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\n\t\t\t\t      info->node_flags,\n\t\t\t\t      \"Invalid internal return type in table entry: %X\",\n\t\t\t\t      package->ret_info.type));\n\n\t\treturn_ACPI_STATUS(AE_AML_INTERNAL);\n\t}\n\n\treturn_ACPI_STATUS(status);\n\npackage_too_small:\n\n\t \n\n\tACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname, info->node_flags,\n\t\t\t      \"Return Package is too small - found %u elements, expected %u\",\n\t\t\t      count, expected_count));\n\n\treturn_ACPI_STATUS(AE_AML_OPERAND_VALUE);\n}\n\n \n\nstatic acpi_status\nacpi_ns_check_package_list(struct acpi_evaluate_info *info,\n\t\t\t   const union acpi_predefined_info *package,\n\t\t\t   union acpi_operand_object **elements, u32 count)\n{\n\tunion acpi_operand_object *sub_package;\n\tunion acpi_operand_object **sub_elements;\n\tacpi_status status;\n\tu32 expected_count;\n\tu32 i;\n\tu32 j;\n\n\t \n\tfor (i = 0; i < count; i++) {\n\t\tsub_package = *elements;\n\t\tsub_elements = sub_package->package.elements;\n\t\tinfo->parent_package = sub_package;\n\n\t\t \n\n\t\tstatus = acpi_ns_check_object_type(info, &sub_package,\n\t\t\t\t\t\t   ACPI_RTYPE_PACKAGE, i);\n\t\tif (ACPI_FAILURE(status)) {\n\t\t\treturn (status);\n\t\t}\n\n\t\t \n\n\t\tinfo->parent_package = sub_package;\n\t\tswitch (package->ret_info.type) {\n\t\tcase ACPI_PTYPE2:\n\t\tcase ACPI_PTYPE2_PKG_COUNT:\n\t\tcase ACPI_PTYPE2_REV_FIXED:\n\n\t\t\t \n\n\t\t\texpected_count =\n\t\t\t    package->ret_info.count1 + package->ret_info.count2;\n\t\t\tif (sub_package->package.count < expected_count) {\n\t\t\t\tgoto package_too_small;\n\t\t\t}\n\n\t\t\tstatus =\n\t\t\t    acpi_ns_check_package_elements(info, sub_elements,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   object_type1,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   count1,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   object_type2,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   count2, 0);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn (status);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase ACPI_PTYPE2_FIX_VAR:\n\t\t\t \n\t\t\texpected_count =\n\t\t\t    package->ret_info.count1 + package->ret_info.count2;\n\t\t\tif (sub_package->package.count < expected_count) {\n\t\t\t\tgoto package_too_small;\n\t\t\t}\n\n\t\t\tstatus =\n\t\t\t    acpi_ns_check_package_elements(info, sub_elements,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   object_type1,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   count1,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   object_type2,\n\t\t\t\t\t\t\t   sub_package->package.\n\t\t\t\t\t\t\t   count -\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   count1, 0);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn (status);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase ACPI_PTYPE2_VAR_VAR:\n\t\t\t \n\t\t\tbreak;\n\n\t\tcase ACPI_PTYPE2_FIXED:\n\n\t\t\t \n\n\t\t\texpected_count = package->ret_info2.count;\n\t\t\tif (sub_package->package.count < expected_count) {\n\t\t\t\tgoto package_too_small;\n\t\t\t}\n\n\t\t\t \n\n\t\t\tfor (j = 0; j < expected_count; j++) {\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ns_check_object_type(info,\n\t\t\t\t\t\t\t      &sub_elements[j],\n\t\t\t\t\t\t\t      package->\n\t\t\t\t\t\t\t      ret_info2.\n\t\t\t\t\t\t\t      object_type[j],\n\t\t\t\t\t\t\t      j);\n\t\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\t\treturn (status);\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase ACPI_PTYPE2_MIN:\n\n\t\t\t \n\n\t\t\texpected_count = package->ret_info.count1;\n\t\t\tif (sub_package->package.count < expected_count) {\n\t\t\t\tgoto package_too_small;\n\t\t\t}\n\n\t\t\t \n\n\t\t\tstatus =\n\t\t\t    acpi_ns_check_package_elements(info, sub_elements,\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   object_type1,\n\t\t\t\t\t\t\t   sub_package->package.\n\t\t\t\t\t\t\t   count, 0, 0, 0);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn (status);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase ACPI_PTYPE2_COUNT:\n\t\t\t \n\t\t\tstatus = acpi_ns_check_object_type(info, sub_elements,\n\t\t\t\t\t\t\t   ACPI_RTYPE_INTEGER,\n\t\t\t\t\t\t\t   0);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn (status);\n\t\t\t}\n\n\t\t\t \n\t\t\texpected_count = (u32)(*sub_elements)->integer.value;\n\t\t\tif (sub_package->package.count < expected_count) {\n\t\t\t\tgoto package_too_small;\n\t\t\t}\n\n\t\t\tif (sub_package->package.count <\n\t\t\t    package->ret_info.count1) {\n\t\t\t\texpected_count = package->ret_info.count1;\n\t\t\t\tgoto package_too_small;\n\t\t\t}\n\n\t\t\tif (expected_count == 0) {\n\t\t\t\t \n\t\t\t\texpected_count = sub_package->package.count;\n\t\t\t\t(*sub_elements)->integer.value = expected_count;\n\t\t\t}\n\n\t\t\t \n\n\t\t\tstatus =\n\t\t\t    acpi_ns_check_package_elements(info,\n\t\t\t\t\t\t\t   (sub_elements + 1),\n\t\t\t\t\t\t\t   package->ret_info.\n\t\t\t\t\t\t\t   object_type1,\n\t\t\t\t\t\t\t   (expected_count - 1),\n\t\t\t\t\t\t\t   0, 0, 1);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn (status);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\t \n\n\t\t\tACPI_ERROR((AE_INFO, \"Invalid Package type: %X\",\n\t\t\t\t    package->ret_info.type));\n\t\t\treturn (AE_AML_INTERNAL);\n\t\t}\n\n\t\telements++;\n\t}\n\n\treturn (AE_OK);\n\npackage_too_small:\n\n\t \n\n\tACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname, info->node_flags,\n\t\t\t      \"Return SubPackage[%u] is too small - found %u elements, expected %u\",\n\t\t\t      i, sub_package->package.count, expected_count));\n\n\treturn (AE_AML_OPERAND_VALUE);\n}\n\n \n\nstatic acpi_status\nacpi_ns_custom_package(struct acpi_evaluate_info *info,\n\t\t       union acpi_operand_object **elements, u32 count)\n{\n\tu32 expected_count;\n\tu32 version;\n\tacpi_status status = AE_OK;\n\n\tACPI_FUNCTION_NAME(ns_custom_package);\n\n\t \n\n\tif ((*elements)->common.type != ACPI_TYPE_INTEGER) {\n\t\tACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\n\t\t\t\t      info->node_flags,\n\t\t\t\t      \"Return Package has invalid object type for version number\"));\n\t\treturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\n\t}\n\n\tversion = (u32)(*elements)->integer.value;\n\texpected_count = 21;\t \n\n\tif (version == 0) {\n\t\texpected_count = 20;\t \n\t}\n\n\tif (count < expected_count) {\n\t\tACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\n\t\t\t\t      info->node_flags,\n\t\t\t\t      \"Return Package is too small - found %u elements, expected %u\",\n\t\t\t\t      count, expected_count));\n\t\treturn_ACPI_STATUS(AE_AML_OPERAND_VALUE);\n\t} else if (count > expected_count) {\n\t\tACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\n\t\t\t\t  \"%s: Return Package is larger than needed - \"\n\t\t\t\t  \"found %u, expected %u\\n\",\n\t\t\t\t  info->full_pathname, count, expected_count));\n\t}\n\n\t \n\n\tstatus = acpi_ns_check_package_elements(info, elements,\n\t\t\t\t\t\tACPI_RTYPE_INTEGER, 16,\n\t\t\t\t\t\tACPI_RTYPE_STRING, 4, 0);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\t \n\n\tif (version > 0) {\n\t\tstatus = acpi_ns_check_package_elements(info, elements + 20,\n\t\t\t\t\t\t\tACPI_RTYPE_INTEGER, 1,\n\t\t\t\t\t\t\t0, 0, 20);\n\t}\n\n\treturn_ACPI_STATUS(status);\n}\n\n \n\nstatic acpi_status\nacpi_ns_check_package_elements(struct acpi_evaluate_info *info,\n\t\t\t       union acpi_operand_object **elements,\n\t\t\t       u8 type1,\n\t\t\t       u32 count1,\n\t\t\t       u8 type2, u32 count2, u32 start_index)\n{\n\tunion acpi_operand_object **this_element = elements;\n\tacpi_status status;\n\tu32 i;\n\n\tACPI_FUNCTION_TRACE(ns_check_package_elements);\n\n\t \n\tfor (i = 0; i < count1; i++) {\n\t\tstatus = acpi_ns_check_object_type(info, this_element,\n\t\t\t\t\t\t   type1, i + start_index);\n\t\tif (ACPI_FAILURE(status)) {\n\t\t\treturn_ACPI_STATUS(status);\n\t\t}\n\n\t\tthis_element++;\n\t}\n\n\tfor (i = 0; i < count2; i++) {\n\t\tstatus = acpi_ns_check_object_type(info, this_element,\n\t\t\t\t\t\t   type2,\n\t\t\t\t\t\t   (i + count1 + start_index));\n\t\tif (ACPI_FAILURE(status)) {\n\t\t\treturn_ACPI_STATUS(status);\n\t\t}\n\n\t\tthis_element++;\n\t}\n\n\treturn_ACPI_STATUS(AE_OK);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}