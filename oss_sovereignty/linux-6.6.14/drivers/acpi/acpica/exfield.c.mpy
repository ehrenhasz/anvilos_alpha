{
  "module_name": "exfield.c",
  "hash_id": "4054f1d31d62c17bf8b757c50803801043a8b6f6b31cefc8e1410f390573e753",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/acpica/exfield.c",
  "human_readable_source": "\n \n\n#include <acpi/acpi.h>\n#include \"accommon.h\"\n#include \"acdispat.h\"\n#include \"acinterp.h\"\n#include \"amlcode.h\"\n\n#define _COMPONENT          ACPI_EXECUTER\nACPI_MODULE_NAME(\"exfield\")\n\n \n#define ACPI_INVALID_PROTOCOL_ID        0x80\n#define ACPI_MAX_PROTOCOL_ID            0x0F\nstatic const u8 acpi_protocol_lengths[] = {\n\tACPI_INVALID_PROTOCOL_ID,\t \n\tACPI_INVALID_PROTOCOL_ID,\t \n\t0x00,\t\t\t \n\tACPI_INVALID_PROTOCOL_ID,\t \n\t0x01,\t\t\t \n\tACPI_INVALID_PROTOCOL_ID,\t \n\t0x01,\t\t\t \n\tACPI_INVALID_PROTOCOL_ID,\t \n\t0x02,\t\t\t \n\tACPI_INVALID_PROTOCOL_ID,\t \n\t0xFF,\t\t\t \n\t0xFF,\t\t\t \n\t0x02,\t\t\t \n\t0xFF,\t\t\t \n\t0xFF,\t\t\t \n\t0xFF\t\t\t \n};\n\n#define PCC_MASTER_SUBSPACE     3\n\n \n#define GENERIC_SUBSPACE_COMMAND(a)     (4 == a || a == 5)\n#define MASTER_SUBSPACE_COMMAND(a)      (12 <= a && a <= 15)\n\n \n\nacpi_status\nacpi_ex_get_protocol_buffer_length(u32 protocol_id, u32 *return_length)\n{\n\n\tif ((protocol_id > ACPI_MAX_PROTOCOL_ID) ||\n\t    (acpi_protocol_lengths[protocol_id] == ACPI_INVALID_PROTOCOL_ID)) {\n\t\tACPI_ERROR((AE_INFO,\n\t\t\t    \"Invalid Field/AccessAs protocol ID: 0x%4.4X\",\n\t\t\t    protocol_id));\n\n\t\treturn (AE_AML_PROTOCOL);\n\t}\n\n\t*return_length = acpi_protocol_lengths[protocol_id];\n\treturn (AE_OK);\n}\n\n \n\nacpi_status\nacpi_ex_read_data_from_field(struct acpi_walk_state *walk_state,\n\t\t\t     union acpi_operand_object *obj_desc,\n\t\t\t     union acpi_operand_object **ret_buffer_desc)\n{\n\tacpi_status status;\n\tunion acpi_operand_object *buffer_desc;\n\tvoid *buffer;\n\tu32 buffer_length;\n\n\tACPI_FUNCTION_TRACE_PTR(ex_read_data_from_field, obj_desc);\n\n\t \n\n\tif (!obj_desc) {\n\t\treturn_ACPI_STATUS(AE_AML_NO_OPERAND);\n\t}\n\tif (!ret_buffer_desc) {\n\t\treturn_ACPI_STATUS(AE_BAD_PARAMETER);\n\t}\n\n\tif (obj_desc->common.type == ACPI_TYPE_BUFFER_FIELD) {\n\t\t \n\t\tif (!(obj_desc->common.flags & AOPOBJ_DATA_VALID)) {\n\t\t\tstatus = acpi_ds_get_buffer_field_arguments(obj_desc);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t}\n\t\t}\n\t} else if ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\n\t\t   (obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_SMBUS\n\t\t    || obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_GSBUS\n\t\t    || obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_IPMI\n\t\t    || obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_PLATFORM_RT\n\t\t    || obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_FIXED_HARDWARE)) {\n\n\t\t \n\n\t\tstatus = acpi_ex_read_serial_bus(obj_desc, ret_buffer_desc);\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\t \n\tbuffer_length =\n\t    (acpi_size)ACPI_ROUND_BITS_UP_TO_BYTES(obj_desc->field.bit_length);\n\n\tif (buffer_length > acpi_gbl_integer_byte_width ||\n\t    (obj_desc->common.type == ACPI_TYPE_BUFFER_FIELD &&\n\t     obj_desc->buffer_field.is_create_field)) {\n\n\t\t \n\n\t\tbuffer_desc = acpi_ut_create_buffer_object(buffer_length);\n\t\tif (!buffer_desc) {\n\t\t\treturn_ACPI_STATUS(AE_NO_MEMORY);\n\t\t}\n\t\tbuffer = buffer_desc->buffer.pointer;\n\t} else {\n\t\t \n\n\t\tbuffer_desc = acpi_ut_create_integer_object((u64) 0);\n\t\tif (!buffer_desc) {\n\t\t\treturn_ACPI_STATUS(AE_NO_MEMORY);\n\t\t}\n\n\t\tbuffer_length = acpi_gbl_integer_byte_width;\n\t\tbuffer = &buffer_desc->integer.value;\n\t}\n\n\tif ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\n\t    (obj_desc->field.region_obj->region.space_id ==\n\t     ACPI_ADR_SPACE_GPIO)) {\n\n\t\t \n\n\t\tstatus = acpi_ex_read_gpio(obj_desc, buffer);\n\t\tgoto exit;\n\t} else if ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\n\t\t   (obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_PLATFORM_COMM)) {\n\t\t \n\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t  \"PCC FieldRead bits %u\\n\",\n\t\t\t\t  obj_desc->field.bit_length));\n\n\t\tmemcpy(buffer,\n\t\t       obj_desc->field.region_obj->field.internal_pcc_buffer +\n\t\t       obj_desc->field.base_byte_offset,\n\t\t       (acpi_size)ACPI_ROUND_BITS_UP_TO_BYTES(obj_desc->field.\n\t\t\t\t\t\t\t      bit_length));\n\n\t\t*ret_buffer_desc = buffer_desc;\n\t\treturn AE_OK;\n\t}\n\n\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t  \"FieldRead [TO]:   Obj %p, Type %X, Buf %p, ByteLen %X\\n\",\n\t\t\t  obj_desc, obj_desc->common.type, buffer,\n\t\t\t  buffer_length));\n\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t  \"FieldRead [FROM]: BitLen %X, BitOff %X, ByteOff %X\\n\",\n\t\t\t  obj_desc->common_field.bit_length,\n\t\t\t  obj_desc->common_field.start_field_bit_offset,\n\t\t\t  obj_desc->common_field.base_byte_offset));\n\n\t \n\n\tacpi_ex_acquire_global_lock(obj_desc->common_field.field_flags);\n\n\t \n\n\tstatus = acpi_ex_extract_from_field(obj_desc, buffer, buffer_length);\n\tacpi_ex_release_global_lock(obj_desc->common_field.field_flags);\n\nexit:\n\tif (ACPI_FAILURE(status)) {\n\t\tacpi_ut_remove_reference(buffer_desc);\n\t} else {\n\t\t*ret_buffer_desc = buffer_desc;\n\t}\n\n\treturn_ACPI_STATUS(status);\n}\n\n \n\nacpi_status\nacpi_ex_write_data_to_field(union acpi_operand_object *source_desc,\n\t\t\t    union acpi_operand_object *obj_desc,\n\t\t\t    union acpi_operand_object **result_desc)\n{\n\tacpi_status status;\n\tu32 buffer_length;\n\tu32 data_length;\n\tvoid *buffer;\n\n\tACPI_FUNCTION_TRACE_PTR(ex_write_data_to_field, obj_desc);\n\n\t \n\n\tif (!source_desc || !obj_desc) {\n\t\treturn_ACPI_STATUS(AE_AML_NO_OPERAND);\n\t}\n\n\tif (obj_desc->common.type == ACPI_TYPE_BUFFER_FIELD) {\n\t\t \n\t\tif (!(obj_desc->common.flags & AOPOBJ_DATA_VALID)) {\n\t\t\tstatus = acpi_ds_get_buffer_field_arguments(obj_desc);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t}\n\t\t}\n\t} else if ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\n\t\t   (obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_GPIO)) {\n\n\t\t \n\n\t\tstatus = acpi_ex_write_gpio(source_desc, obj_desc, result_desc);\n\t\treturn_ACPI_STATUS(status);\n\t} else if ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\n\t\t   (obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_SMBUS\n\t\t    || obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_GSBUS\n\t\t    || obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_IPMI\n\t\t    || obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_PLATFORM_RT\n\t\t    || obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_FIXED_HARDWARE)) {\n\n\t\t \n\n\t\tstatus =\n\t\t    acpi_ex_write_serial_bus(source_desc, obj_desc,\n\t\t\t\t\t     result_desc);\n\t\treturn_ACPI_STATUS(status);\n\t} else if ((obj_desc->common.type == ACPI_TYPE_LOCAL_REGION_FIELD) &&\n\t\t   (obj_desc->field.region_obj->region.space_id ==\n\t\t    ACPI_ADR_SPACE_PLATFORM_COMM)) {\n\t\t \n\t\tdata_length =\n\t\t    (acpi_size)ACPI_ROUND_BITS_UP_TO_BYTES(obj_desc->field.\n\t\t\t\t\t\t\t   bit_length);\n\t\tmemcpy(obj_desc->field.region_obj->field.internal_pcc_buffer +\n\t\t       obj_desc->field.base_byte_offset,\n\t\t       source_desc->buffer.pointer, data_length);\n\n\t\tif (MASTER_SUBSPACE_COMMAND(obj_desc->field.base_byte_offset)) {\n\n\t\t\t \n\n\t\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t\t  \"PCC COMD field has been written. Invoking PCC handler now.\\n\"));\n\n\t\t\tstatus =\n\t\t\t    acpi_ex_access_region(obj_desc, 0,\n\t\t\t\t\t\t  (u64 *)obj_desc->field.\n\t\t\t\t\t\t  region_obj->field.\n\t\t\t\t\t\t  internal_pcc_buffer,\n\t\t\t\t\t\t  ACPI_WRITE);\n\t\t\treturn_ACPI_STATUS(status);\n\t\t}\n\t\treturn (AE_OK);\n\t}\n\n\t \n\n\tswitch (source_desc->common.type) {\n\tcase ACPI_TYPE_INTEGER:\n\n\t\tbuffer = &source_desc->integer.value;\n\t\tbuffer_length = sizeof(source_desc->integer.value);\n\t\tbreak;\n\n\tcase ACPI_TYPE_BUFFER:\n\n\t\tbuffer = source_desc->buffer.pointer;\n\t\tbuffer_length = source_desc->buffer.length;\n\t\tbreak;\n\n\tcase ACPI_TYPE_STRING:\n\n\t\tbuffer = source_desc->string.pointer;\n\t\tbuffer_length = source_desc->string.length;\n\t\tbreak;\n\n\tdefault:\n\t\treturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\n\t}\n\n\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t  \"FieldWrite [FROM]: Obj %p (%s:%X), Buf %p, ByteLen %X\\n\",\n\t\t\t  source_desc,\n\t\t\t  acpi_ut_get_type_name(source_desc->common.type),\n\t\t\t  source_desc->common.type, buffer, buffer_length));\n\n\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t  \"FieldWrite [TO]:   Obj %p (%s:%X), BitLen %X, BitOff %X, ByteOff %X\\n\",\n\t\t\t  obj_desc,\n\t\t\t  acpi_ut_get_type_name(obj_desc->common.type),\n\t\t\t  obj_desc->common.type,\n\t\t\t  obj_desc->common_field.bit_length,\n\t\t\t  obj_desc->common_field.start_field_bit_offset,\n\t\t\t  obj_desc->common_field.base_byte_offset));\n\n\t \n\n\tacpi_ex_acquire_global_lock(obj_desc->common_field.field_flags);\n\n\t \n\n\tstatus = acpi_ex_insert_into_field(obj_desc, buffer, buffer_length);\n\tacpi_ex_release_global_lock(obj_desc->common_field.field_flags);\n\treturn_ACPI_STATUS(status);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}