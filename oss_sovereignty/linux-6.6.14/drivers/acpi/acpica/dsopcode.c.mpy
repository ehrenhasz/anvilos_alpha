{
  "module_name": "dsopcode.c",
  "hash_id": "e9e650044010efea609967e031014b6e767f2da137b63f8a63873f357da38597",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/acpica/dsopcode.c",
  "human_readable_source": "\n \n\n#include <acpi/acpi.h>\n#include \"accommon.h\"\n#include \"acparser.h\"\n#include \"amlcode.h\"\n#include \"acdispat.h\"\n#include \"acinterp.h\"\n#include \"acnamesp.h\"\n#include \"acevents.h\"\n#include \"actables.h\"\n\n#define _COMPONENT          ACPI_DISPATCHER\nACPI_MODULE_NAME(\"dsopcode\")\n\n \nstatic acpi_status\nacpi_ds_init_buffer_field(u16 aml_opcode,\n\t\t\t  union acpi_operand_object *obj_desc,\n\t\t\t  union acpi_operand_object *buffer_desc,\n\t\t\t  union acpi_operand_object *offset_desc,\n\t\t\t  union acpi_operand_object *length_desc,\n\t\t\t  union acpi_operand_object *result_desc);\n\n \n\nacpi_status acpi_ds_initialize_region(acpi_handle obj_handle)\n{\n\tunion acpi_operand_object *obj_desc;\n\tacpi_status status;\n\n\tobj_desc = acpi_ns_get_attached_object(obj_handle);\n\n\t \n\n\tstatus = acpi_ev_initialize_region(obj_desc);\n\treturn (status);\n}\n\n \n\nstatic acpi_status\nacpi_ds_init_buffer_field(u16 aml_opcode,\n\t\t\t  union acpi_operand_object *obj_desc,\n\t\t\t  union acpi_operand_object *buffer_desc,\n\t\t\t  union acpi_operand_object *offset_desc,\n\t\t\t  union acpi_operand_object *length_desc,\n\t\t\t  union acpi_operand_object *result_desc)\n{\n\tu32 offset;\n\tu32 bit_offset;\n\tu32 bit_count;\n\tu8 field_flags;\n\tacpi_status status;\n\n\tACPI_FUNCTION_TRACE_PTR(ds_init_buffer_field, obj_desc);\n\n\t \n\n\tif (buffer_desc->common.type != ACPI_TYPE_BUFFER) {\n\t\tACPI_ERROR((AE_INFO,\n\t\t\t    \"Target of Create Field is not a Buffer object - %s\",\n\t\t\t    acpi_ut_get_object_type_name(buffer_desc)));\n\n\t\tstatus = AE_AML_OPERAND_TYPE;\n\t\tgoto cleanup;\n\t}\n\n\t \n\tif (ACPI_GET_DESCRIPTOR_TYPE(result_desc) != ACPI_DESC_TYPE_NAMED) {\n\t\tACPI_ERROR((AE_INFO,\n\t\t\t    \"(%s) destination not a NS Node [%s]\",\n\t\t\t    acpi_ps_get_opcode_name(aml_opcode),\n\t\t\t    acpi_ut_get_descriptor_name(result_desc)));\n\n\t\tstatus = AE_AML_OPERAND_TYPE;\n\t\tgoto cleanup;\n\t}\n\n\toffset = (u32) offset_desc->integer.value;\n\n\t \n\tswitch (aml_opcode) {\n\tcase AML_CREATE_FIELD_OP:\n\n\t\t \n\n\t\tfield_flags = AML_FIELD_ACCESS_BYTE;\n\t\tbit_offset = offset;\n\t\tbit_count = (u32) length_desc->integer.value;\n\n\t\t \n\n\t\tif (bit_count == 0) {\n\t\t\tACPI_BIOS_ERROR((AE_INFO,\n\t\t\t\t\t \"Attempt to CreateField of length zero\"));\n\t\t\tstatus = AE_AML_OPERAND_VALUE;\n\t\t\tgoto cleanup;\n\t\t}\n\t\tbreak;\n\n\tcase AML_CREATE_BIT_FIELD_OP:\n\n\t\t \n\n\t\tbit_offset = offset;\n\t\tbit_count = 1;\n\t\tfield_flags = AML_FIELD_ACCESS_BYTE;\n\t\tbreak;\n\n\tcase AML_CREATE_BYTE_FIELD_OP:\n\n\t\t \n\n\t\tbit_offset = 8 * offset;\n\t\tbit_count = 8;\n\t\tfield_flags = AML_FIELD_ACCESS_BYTE;\n\t\tbreak;\n\n\tcase AML_CREATE_WORD_FIELD_OP:\n\n\t\t \n\n\t\tbit_offset = 8 * offset;\n\t\tbit_count = 16;\n\t\tfield_flags = AML_FIELD_ACCESS_WORD;\n\t\tbreak;\n\n\tcase AML_CREATE_DWORD_FIELD_OP:\n\n\t\t \n\n\t\tbit_offset = 8 * offset;\n\t\tbit_count = 32;\n\t\tfield_flags = AML_FIELD_ACCESS_DWORD;\n\t\tbreak;\n\n\tcase AML_CREATE_QWORD_FIELD_OP:\n\n\t\t \n\n\t\tbit_offset = 8 * offset;\n\t\tbit_count = 64;\n\t\tfield_flags = AML_FIELD_ACCESS_QWORD;\n\t\tbreak;\n\n\tdefault:\n\n\t\tACPI_ERROR((AE_INFO,\n\t\t\t    \"Unknown field creation opcode 0x%02X\",\n\t\t\t    aml_opcode));\n\t\tstatus = AE_AML_BAD_OPCODE;\n\t\tgoto cleanup;\n\t}\n\n\t \n\n\tif ((bit_offset + bit_count) > (8 * (u32)buffer_desc->buffer.length)) {\n\t\tstatus = AE_AML_BUFFER_LIMIT;\n\t\tACPI_BIOS_EXCEPTION((AE_INFO, status,\n\t\t\t\t     \"Field [%4.4s] at bit offset/length %u/%u \"\n\t\t\t\t     \"exceeds size of target Buffer (%u bits)\",\n\t\t\t\t     acpi_ut_get_node_name(result_desc),\n\t\t\t\t     bit_offset, bit_count,\n\t\t\t\t     8 * (u32)buffer_desc->buffer.length));\n\t\tgoto cleanup;\n\t}\n\n\t \n\tstatus =\n\t    acpi_ex_prep_common_field_object(obj_desc, field_flags, 0,\n\t\t\t\t\t     bit_offset, bit_count);\n\tif (ACPI_FAILURE(status)) {\n\t\tgoto cleanup;\n\t}\n\n\tobj_desc->buffer_field.buffer_obj = buffer_desc;\n\tobj_desc->buffer_field.is_create_field =\n\t    aml_opcode == AML_CREATE_FIELD_OP;\n\n\t \n\n\tbuffer_desc->common.reference_count = (u16)\n\t    (buffer_desc->common.reference_count +\n\t     obj_desc->common.reference_count);\n\ncleanup:\n\n\t \n\n\tacpi_ut_remove_reference(offset_desc);\n\tacpi_ut_remove_reference(buffer_desc);\n\n\tif (aml_opcode == AML_CREATE_FIELD_OP) {\n\t\tacpi_ut_remove_reference(length_desc);\n\t}\n\n\t \n\n\tif (ACPI_FAILURE(status)) {\n\t\tacpi_ut_remove_reference(result_desc);\t \n\t} else {\n\t\t \n\n\t\tobj_desc->buffer_field.flags |= AOPOBJ_DATA_VALID;\n\t}\n\n\treturn_ACPI_STATUS(status);\n}\n\n \n\nacpi_status\nacpi_ds_eval_buffer_field_operands(struct acpi_walk_state *walk_state,\n\t\t\t\t   union acpi_parse_object *op)\n{\n\tacpi_status status;\n\tunion acpi_operand_object *obj_desc;\n\tstruct acpi_namespace_node *node;\n\tunion acpi_parse_object *next_op;\n\n\tACPI_FUNCTION_TRACE_PTR(ds_eval_buffer_field_operands, op);\n\n\t \n\tnode = op->common.node;\n\n\t \n\n\tnext_op = op->common.value.arg;\n\n\t \n\n\tstatus = acpi_ds_create_operands(walk_state, next_op);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\tobj_desc = acpi_ns_get_attached_object(node);\n\tif (!obj_desc) {\n\t\treturn_ACPI_STATUS(AE_NOT_EXIST);\n\t}\n\n\t \n\n\tstatus =\n\t    acpi_ex_resolve_operands(op->common.aml_opcode, ACPI_WALK_OPERANDS,\n\t\t\t\t     walk_state);\n\tif (ACPI_FAILURE(status)) {\n\t\tACPI_ERROR((AE_INFO, \"(%s) bad operand(s), status 0x%X\",\n\t\t\t    acpi_ps_get_opcode_name(op->common.aml_opcode),\n\t\t\t    status));\n\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\t \n\n\tif (op->common.aml_opcode == AML_CREATE_FIELD_OP) {\n\n\t\t \n\n\t\tstatus =\n\t\t    acpi_ds_init_buffer_field(op->common.aml_opcode, obj_desc,\n\t\t\t\t\t      walk_state->operands[0],\n\t\t\t\t\t      walk_state->operands[1],\n\t\t\t\t\t      walk_state->operands[2],\n\t\t\t\t\t      walk_state->operands[3]);\n\t} else {\n\t\t \n\n\t\tstatus =\n\t\t    acpi_ds_init_buffer_field(op->common.aml_opcode, obj_desc,\n\t\t\t\t\t      walk_state->operands[0],\n\t\t\t\t\t      walk_state->operands[1], NULL,\n\t\t\t\t\t      walk_state->operands[2]);\n\t}\n\n\treturn_ACPI_STATUS(status);\n}\n\n \n\nacpi_status\nacpi_ds_eval_region_operands(struct acpi_walk_state *walk_state,\n\t\t\t     union acpi_parse_object *op)\n{\n\tacpi_status status;\n\tunion acpi_operand_object *obj_desc;\n\tunion acpi_operand_object *operand_desc;\n\tstruct acpi_namespace_node *node;\n\tunion acpi_parse_object *next_op;\n\tacpi_adr_space_type space_id;\n\n\tACPI_FUNCTION_TRACE_PTR(ds_eval_region_operands, op);\n\n\t \n\tnode = op->common.node;\n\n\t \n\n\tnext_op = op->common.value.arg;\n\tspace_id = (acpi_adr_space_type)next_op->common.value.integer;\n\n\t \n\n\tnext_op = next_op->common.next;\n\n\t \n\n\tstatus = acpi_ds_create_operands(walk_state, next_op);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\t \n\n\tstatus =\n\t    acpi_ex_resolve_operands(op->common.aml_opcode, ACPI_WALK_OPERANDS,\n\t\t\t\t     walk_state);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\tobj_desc = acpi_ns_get_attached_object(node);\n\tif (!obj_desc) {\n\t\treturn_ACPI_STATUS(AE_NOT_EXIST);\n\t}\n\n\t \n\toperand_desc = walk_state->operands[walk_state->num_operands - 1];\n\n\tobj_desc->region.length = (u32) operand_desc->integer.value;\n\tacpi_ut_remove_reference(operand_desc);\n\n\t \n\n\tif (!obj_desc->region.length\n\t    && (space_id < ACPI_NUM_PREDEFINED_REGIONS)) {\n\t\tACPI_WARNING((AE_INFO,\n\t\t\t      \"Operation Region [%4.4s] has zero length (SpaceId %X)\",\n\t\t\t      node->name.ascii, space_id));\n\t}\n\n\t \n\toperand_desc = walk_state->operands[walk_state->num_operands - 2];\n\n\tobj_desc->region.address = (acpi_physical_address)\n\t    operand_desc->integer.value;\n\tacpi_ut_remove_reference(operand_desc);\n\n\tACPI_DEBUG_PRINT((ACPI_DB_EXEC, \"RgnObj %p Addr %8.8X%8.8X Len %X\\n\",\n\t\t\t  obj_desc,\n\t\t\t  ACPI_FORMAT_UINT64(obj_desc->region.address),\n\t\t\t  obj_desc->region.length));\n\n\tstatus = acpi_ut_add_address_range(obj_desc->region.space_id,\n\t\t\t\t\t   obj_desc->region.address,\n\t\t\t\t\t   obj_desc->region.length, node);\n\n\t \n\n\tobj_desc->region.flags |= AOPOBJ_DATA_VALID;\n\treturn_ACPI_STATUS(status);\n}\n\n \n\nacpi_status\nacpi_ds_eval_table_region_operands(struct acpi_walk_state *walk_state,\n\t\t\t\t   union acpi_parse_object *op)\n{\n\tacpi_status status;\n\tunion acpi_operand_object *obj_desc;\n\tunion acpi_operand_object **operand;\n\tstruct acpi_namespace_node *node;\n\tunion acpi_parse_object *next_op;\n\tstruct acpi_table_header *table;\n\tu32 table_index;\n\n\tACPI_FUNCTION_TRACE_PTR(ds_eval_table_region_operands, op);\n\n\t \n\tnode = op->common.node;\n\n\t \n\n\tnext_op = op->common.value.arg;\n\n\t \n\tstatus = acpi_ds_create_operands(walk_state, next_op);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\toperand = &walk_state->operands[0];\n\n\t \n\tstatus =\n\t    acpi_ex_resolve_operands(op->common.aml_opcode, ACPI_WALK_OPERANDS,\n\t\t\t\t     walk_state);\n\tif (ACPI_FAILURE(status)) {\n\t\tgoto cleanup;\n\t}\n\n\t \n\n\tstatus = acpi_tb_find_table(operand[0]->string.pointer,\n\t\t\t\t    operand[1]->string.pointer,\n\t\t\t\t    operand[2]->string.pointer, &table_index);\n\tif (ACPI_FAILURE(status)) {\n\t\tif (status == AE_NOT_FOUND) {\n\t\t\tACPI_ERROR((AE_INFO,\n\t\t\t\t    \"ACPI Table [%4.4s] OEM:(%s, %s) not found in RSDT/XSDT\",\n\t\t\t\t    operand[0]->string.pointer,\n\t\t\t\t    operand[1]->string.pointer,\n\t\t\t\t    operand[2]->string.pointer));\n\t\t}\n\t\tgoto cleanup;\n\t}\n\n\tstatus = acpi_get_table_by_index(table_index, &table);\n\tif (ACPI_FAILURE(status)) {\n\t\tgoto cleanup;\n\t}\n\n\tobj_desc = acpi_ns_get_attached_object(node);\n\tif (!obj_desc) {\n\t\tstatus = AE_NOT_EXIST;\n\t\tgoto cleanup;\n\t}\n\n\tobj_desc->region.address = ACPI_PTR_TO_PHYSADDR(table);\n\tobj_desc->region.length = table->length;\n\tobj_desc->region.pointer = table;\n\n\tACPI_DEBUG_PRINT((ACPI_DB_EXEC, \"RgnObj %p Addr %8.8X%8.8X Len %X\\n\",\n\t\t\t  obj_desc,\n\t\t\t  ACPI_FORMAT_UINT64(obj_desc->region.address),\n\t\t\t  obj_desc->region.length));\n\n\t \n\n\tobj_desc->region.flags |= AOPOBJ_DATA_VALID;\n\ncleanup:\n\tacpi_ut_remove_reference(operand[0]);\n\tacpi_ut_remove_reference(operand[1]);\n\tacpi_ut_remove_reference(operand[2]);\n\n\treturn_ACPI_STATUS(status);\n}\n\n \n\nacpi_status\nacpi_ds_eval_data_object_operands(struct acpi_walk_state *walk_state,\n\t\t\t\t  union acpi_parse_object *op,\n\t\t\t\t  union acpi_operand_object *obj_desc)\n{\n\tacpi_status status;\n\tunion acpi_operand_object *arg_desc;\n\tu32 length;\n\n\tACPI_FUNCTION_TRACE(ds_eval_data_object_operands);\n\n\t \n\n\t \n\twalk_state->operand_index = walk_state->num_operands;\n\n\t \n\n\tif (!op->common.value.arg) {\n\t\tACPI_ERROR((AE_INFO,\n\t\t\t    \"Missing child while evaluating opcode %4.4X, Op %p\",\n\t\t\t    op->common.aml_opcode, op));\n\t\treturn_ACPI_STATUS(AE_OK);\n\t}\n\n\tstatus = acpi_ds_create_operand(walk_state, op->common.value.arg, 1);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\tstatus = acpi_ex_resolve_operands(walk_state->opcode,\n\t\t\t\t\t  &(walk_state->\n\t\t\t\t\t    operands[walk_state->num_operands -\n\t\t\t\t\t\t     1]), walk_state);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\t \n\n\targ_desc = walk_state->operands[walk_state->num_operands - 1];\n\tlength = (u32) arg_desc->integer.value;\n\n\t \n\n\tstatus = acpi_ds_obj_stack_pop(1, walk_state);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\tacpi_ut_remove_reference(arg_desc);\n\n\t \n\tswitch (op->common.aml_opcode) {\n\tcase AML_BUFFER_OP:\n\n\t\tstatus =\n\t\t    acpi_ds_build_internal_buffer_obj(walk_state, op, length,\n\t\t\t\t\t\t      &obj_desc);\n\t\tbreak;\n\n\tcase AML_PACKAGE_OP:\n\tcase AML_VARIABLE_PACKAGE_OP:\n\n\t\tstatus =\n\t\t    acpi_ds_build_internal_package_obj(walk_state, op, length,\n\t\t\t\t\t\t       &obj_desc);\n\t\tbreak;\n\n\tdefault:\n\n\t\treturn_ACPI_STATUS(AE_AML_BAD_OPCODE);\n\t}\n\n\tif (ACPI_SUCCESS(status)) {\n\t\t \n\t\tif ((!op->common.parent) ||\n\t\t    ((op->common.parent->common.aml_opcode != AML_PACKAGE_OP) &&\n\t\t     (op->common.parent->common.aml_opcode !=\n\t\t      AML_VARIABLE_PACKAGE_OP)\n\t\t     && (op->common.parent->common.aml_opcode !=\n\t\t\t AML_NAME_OP))) {\n\t\t\twalk_state->result_obj = obj_desc;\n\t\t}\n\t}\n\n\treturn_ACPI_STATUS(status);\n}\n\n \n\nacpi_status\nacpi_ds_eval_bank_field_operands(struct acpi_walk_state *walk_state,\n\t\t\t\t union acpi_parse_object *op)\n{\n\tacpi_status status;\n\tunion acpi_operand_object *obj_desc;\n\tunion acpi_operand_object *operand_desc;\n\tstruct acpi_namespace_node *node;\n\tunion acpi_parse_object *next_op;\n\tunion acpi_parse_object *arg;\n\n\tACPI_FUNCTION_TRACE_PTR(ds_eval_bank_field_operands, op);\n\n\t \n\n\t \n\n\tnext_op = op->common.value.arg;\n\n\t \n\n\tnext_op = next_op->common.next;\n\n\t \n\n\tnext_op = next_op->common.next;\n\n\t \n\twalk_state->operand_index = 0;\n\n\tstatus = acpi_ds_create_operand(walk_state, next_op, 0);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\tstatus = acpi_ex_resolve_to_value(&walk_state->operands[0], walk_state);\n\tif (ACPI_FAILURE(status)) {\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\tACPI_DUMP_OPERANDS(ACPI_WALK_OPERANDS,\n\t\t\t   acpi_ps_get_opcode_name(op->common.aml_opcode), 1);\n\t \n\toperand_desc = walk_state->operands[0];\n\n\t \n\n\targ = acpi_ps_get_arg(op, 4);\n\twhile (arg) {\n\n\t\t \n\n\t\tif (arg->common.aml_opcode == AML_INT_NAMEDFIELD_OP) {\n\t\t\tnode = arg->common.node;\n\n\t\t\tobj_desc = acpi_ns_get_attached_object(node);\n\t\t\tif (!obj_desc) {\n\t\t\t\treturn_ACPI_STATUS(AE_NOT_EXIST);\n\t\t\t}\n\n\t\t\tobj_desc->bank_field.value =\n\t\t\t    (u32) operand_desc->integer.value;\n\t\t}\n\n\t\t \n\n\t\targ = arg->common.next;\n\t}\n\n\tacpi_ut_remove_reference(operand_desc);\n\treturn_ACPI_STATUS(status);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}