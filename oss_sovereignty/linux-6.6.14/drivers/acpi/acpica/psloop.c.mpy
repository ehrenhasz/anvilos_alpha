{
  "module_name": "psloop.c",
  "hash_id": "ff758d917ffc0941ca09a01360a8b279241dc3c47bfff60aee840af4c406af6f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/acpica/psloop.c",
  "human_readable_source": "\n \n\n \n\n#include <acpi/acpi.h>\n#include \"accommon.h\"\n#include \"acinterp.h\"\n#include \"acparser.h\"\n#include \"acdispat.h\"\n#include \"amlcode.h\"\n#include \"acconvert.h\"\n#include \"acnamesp.h\"\n\n#define _COMPONENT          ACPI_PARSER\nACPI_MODULE_NAME(\"psloop\")\n\n \nstatic acpi_status\nacpi_ps_get_arguments(struct acpi_walk_state *walk_state,\n\t\t      u8 * aml_op_start, union acpi_parse_object *op);\n\n \n\nstatic acpi_status\nacpi_ps_get_arguments(struct acpi_walk_state *walk_state,\n\t\t      u8 * aml_op_start, union acpi_parse_object *op)\n{\n\tacpi_status status = AE_OK;\n\tunion acpi_parse_object *arg = NULL;\n\n\tACPI_FUNCTION_TRACE_PTR(ps_get_arguments, walk_state);\n\n\tACPI_DEBUG_PRINT((ACPI_DB_PARSE,\n\t\t\t  \"Get arguments for opcode [%s]\\n\",\n\t\t\t  op->common.aml_op_name));\n\n\tswitch (op->common.aml_opcode) {\n\tcase AML_BYTE_OP:\t \n\tcase AML_WORD_OP:\t \n\tcase AML_DWORD_OP:\t \n\tcase AML_QWORD_OP:\t \n\tcase AML_STRING_OP:\t \n\n\t\t \n\n\t\tacpi_ps_get_next_simple_arg(&(walk_state->parser_state),\n\t\t\t\t\t    GET_CURRENT_ARG_TYPE(walk_state->\n\t\t\t\t\t\t\t\t arg_types),\n\t\t\t\t\t    op);\n\t\tbreak;\n\n\tcase AML_INT_NAMEPATH_OP:\t \n\n\t\tstatus = acpi_ps_get_next_namepath(walk_state,\n\t\t\t\t\t\t   &(walk_state->parser_state),\n\t\t\t\t\t\t   op,\n\t\t\t\t\t\t   ACPI_POSSIBLE_METHOD_CALL);\n\t\tif (ACPI_FAILURE(status)) {\n\t\t\treturn_ACPI_STATUS(status);\n\t\t}\n\n\t\twalk_state->arg_types = 0;\n\t\tbreak;\n\n\tdefault:\n\t\t \n\t\twhile (GET_CURRENT_ARG_TYPE(walk_state->arg_types) &&\n\t\t       !walk_state->arg_count) {\n\t\t\twalk_state->aml = walk_state->parser_state.aml;\n\n\t\t\tswitch (op->common.aml_opcode) {\n\t\t\tcase AML_METHOD_OP:\n\t\t\tcase AML_BUFFER_OP:\n\t\t\tcase AML_PACKAGE_OP:\n\t\t\tcase AML_VARIABLE_PACKAGE_OP:\n\t\t\tcase AML_WHILE_OP:\n\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\n\t\t\t\tASL_CV_CAPTURE_COMMENTS(walk_state);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tstatus =\n\t\t\t    acpi_ps_get_next_arg(walk_state,\n\t\t\t\t\t\t &(walk_state->parser_state),\n\t\t\t\t\t\t GET_CURRENT_ARG_TYPE\n\t\t\t\t\t\t (walk_state->arg_types), &arg);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t}\n\n\t\t\tif (arg) {\n\t\t\t\tacpi_ps_append_arg(op, arg);\n\t\t\t}\n\n\t\t\tINCREMENT_ARG_LIST(walk_state->arg_types);\n\t\t}\n\n\t\tACPI_DEBUG_PRINT((ACPI_DB_PARSE,\n\t\t\t\t  \"Final argument count: %8.8X pass %u\\n\",\n\t\t\t\t  walk_state->arg_count,\n\t\t\t\t  walk_state->pass_number));\n\n\t\t \n\n\t\tswitch (op->common.aml_opcode) {\n\t\tcase AML_METHOD_OP:\n\t\t\t \n\t\t\top->named.data = walk_state->parser_state.aml;\n\t\t\top->named.length = (u32)\n\t\t\t    (walk_state->parser_state.pkg_end -\n\t\t\t     walk_state->parser_state.aml);\n\n\t\t\t \n\n\t\t\twalk_state->parser_state.aml =\n\t\t\t    walk_state->parser_state.pkg_end;\n\t\t\twalk_state->arg_count = 0;\n\t\t\tbreak;\n\n\t\tcase AML_BUFFER_OP:\n\t\tcase AML_PACKAGE_OP:\n\t\tcase AML_VARIABLE_PACKAGE_OP:\n\n\t\t\tif ((op->common.parent) &&\n\t\t\t    (op->common.parent->common.aml_opcode ==\n\t\t\t     AML_NAME_OP)\n\t\t\t    && (walk_state->pass_number <=\n\t\t\t\tACPI_IMODE_LOAD_PASS2)) {\n\t\t\t\tACPI_DEBUG_PRINT((ACPI_DB_PARSE,\n\t\t\t\t\t\t  \"Setup Package/Buffer: Pass %u, AML Ptr: %p\\n\",\n\t\t\t\t\t\t  walk_state->pass_number,\n\t\t\t\t\t\t  aml_op_start));\n\n\t\t\t\t \n\t\t\t\top->named.data = aml_op_start;\n\t\t\t\top->named.length = (u32)\n\t\t\t\t    (walk_state->parser_state.pkg_end -\n\t\t\t\t     aml_op_start);\n\n\t\t\t\t \n\n\t\t\t\twalk_state->parser_state.aml =\n\t\t\t\t    walk_state->parser_state.pkg_end;\n\t\t\t\twalk_state->arg_count = 0;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase AML_WHILE_OP:\n\n\t\t\tif (walk_state->control_state) {\n\t\t\t\twalk_state->control_state->control.package_end =\n\t\t\t\t    walk_state->parser_state.pkg_end;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\n\t\t\t \n\n\t\t\tbreak;\n\t\t}\n\n\t\tbreak;\n\t}\n\n\treturn_ACPI_STATUS(AE_OK);\n}\n\n \n\nacpi_status acpi_ps_parse_loop(struct acpi_walk_state *walk_state)\n{\n\tacpi_status status = AE_OK;\n\tunion acpi_parse_object *op = NULL;\t \n\tstruct acpi_parse_state *parser_state;\n\tu8 *aml_op_start = NULL;\n\tu8 opcode_length;\n\n\tACPI_FUNCTION_TRACE_PTR(ps_parse_loop, walk_state);\n\n\tif (walk_state->descending_callback == NULL) {\n\t\treturn_ACPI_STATUS(AE_BAD_PARAMETER);\n\t}\n\n\tparser_state = &walk_state->parser_state;\n\twalk_state->arg_types = 0;\n\n#ifndef ACPI_CONSTANT_EVAL_ONLY\n\n\tif (walk_state->walk_type & ACPI_WALK_METHOD_RESTART) {\n\n\t\t \n\n\t\tif (acpi_ps_has_completed_scope(parser_state)) {\n\t\t\t \n\t\t\tif ((parser_state->scope->parse_scope.op) &&\n\t\t\t    ((parser_state->scope->parse_scope.op->common.\n\t\t\t      aml_opcode == AML_IF_OP)\n\t\t\t     || (parser_state->scope->parse_scope.op->common.\n\t\t\t\t aml_opcode == AML_WHILE_OP))\n\t\t\t    && (walk_state->control_state)\n\t\t\t    && (walk_state->control_state->common.state ==\n\t\t\t\tACPI_CONTROL_PREDICATE_EXECUTING)) {\n\t\t\t\t \n\t\t\t\twalk_state->op = NULL;\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ds_get_predicate_value(walk_state,\n\t\t\t\t\t\t\t\tACPI_TO_POINTER\n\t\t\t\t\t\t\t\t(TRUE));\n\t\t\t\tif (ACPI_FAILURE(status)\n\t\t\t\t    && !ACPI_CNTL_EXCEPTION(status)) {\n\t\t\t\t\tif (status == AE_AML_NO_RETURN_VALUE) {\n\t\t\t\t\t\tACPI_EXCEPTION((AE_INFO, status,\n\t\t\t\t\t\t\t\t\"Invoked method did not return a value\"));\n\t\t\t\t\t}\n\n\t\t\t\t\tACPI_EXCEPTION((AE_INFO, status,\n\t\t\t\t\t\t\t\"GetPredicate Failed\"));\n\t\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t\t}\n\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ps_next_parse_state(walk_state, op,\n\t\t\t\t\t\t\t     status);\n\t\t\t}\n\n\t\t\tacpi_ps_pop_scope(parser_state, &op,\n\t\t\t\t\t  &walk_state->arg_types,\n\t\t\t\t\t  &walk_state->arg_count);\n\t\t\tACPI_DEBUG_PRINT((ACPI_DB_PARSE,\n\t\t\t\t\t  \"Popped scope, Op=%p\\n\", op));\n\t\t} else if (walk_state->prev_op) {\n\n\t\t\t \n\n\t\t\top = walk_state->prev_op;\n\t\t\twalk_state->arg_types = walk_state->prev_arg_types;\n\t\t}\n\t}\n#endif\n\n\t \n\n\twhile ((parser_state->aml < parser_state->aml_end) || (op)) {\n\t\tASL_CV_CAPTURE_COMMENTS(walk_state);\n\n\t\taml_op_start = parser_state->aml;\n\t\tif (!op) {\n\t\t\tstatus =\n\t\t\t    acpi_ps_create_op(walk_state, aml_op_start, &op);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\t \n\t\t\t\tif ((walk_state->\n\t\t\t\t     parse_flags & ACPI_PARSE_MODULE_LEVEL)\n\t\t\t\t    && ((status == AE_ALREADY_EXISTS)\n\t\t\t\t\t|| (status == AE_NOT_FOUND))) {\n\t\t\t\t\tstatus = AE_OK;\n\t\t\t\t}\n\t\t\t\tif (status == AE_CTRL_PARSE_CONTINUE) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif (status == AE_CTRL_PARSE_PENDING) {\n\t\t\t\t\tstatus = AE_OK;\n\t\t\t\t}\n\n\t\t\t\tif (status == AE_CTRL_TERMINATE) {\n\t\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t\t}\n\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ps_complete_op(walk_state, &op,\n\t\t\t\t\t\t\tstatus);\n\t\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t\t}\n\t\t\t\tif (acpi_ns_opens_scope\n\t\t\t\t    (acpi_ps_get_opcode_info\n\t\t\t\t     (walk_state->opcode)->object_type)) {\n\t\t\t\t\t \n\t\t\t\t\tACPI_INFO((\"Skipping parse of AML opcode: %s (0x%4.4X)\", acpi_ps_get_opcode_name(walk_state->opcode), walk_state->opcode));\n\n\t\t\t\t\t \n\t\t\t\t\topcode_length = 1;\n\t\t\t\t\tif ((walk_state->opcode & 0xFF00) ==\n\t\t\t\t\t    AML_EXTENDED_OPCODE) {\n\t\t\t\t\t\topcode_length = 2;\n\t\t\t\t\t}\n\t\t\t\t\twalk_state->parser_state.aml =\n\t\t\t\t\t    walk_state->aml + opcode_length;\n\n\t\t\t\t\twalk_state->parser_state.aml =\n\t\t\t\t\t    acpi_ps_get_next_package_end\n\t\t\t\t\t    (&walk_state->parser_state);\n\t\t\t\t\twalk_state->aml =\n\t\t\t\t\t    walk_state->parser_state.aml;\n\t\t\t\t}\n\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tacpi_ex_start_trace_opcode(op, walk_state);\n\t\t}\n\n\t\t \n\t\twalk_state->arg_count = 0;\n\n\t\tswitch (op->common.aml_opcode) {\n\t\tcase AML_BYTE_OP:\n\t\tcase AML_WORD_OP:\n\t\tcase AML_DWORD_OP:\n\t\tcase AML_QWORD_OP:\n\n\t\t\tbreak;\n\n\t\tdefault:\n\n\t\t\tASL_CV_CAPTURE_COMMENTS(walk_state);\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\n\t\tif (walk_state->arg_types) {\n\n\t\t\t \n\n\t\t\tstatus =\n\t\t\t    acpi_ps_get_arguments(walk_state, aml_op_start, op);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ps_complete_op(walk_state, &op,\n\t\t\t\t\t\t\tstatus);\n\t\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t\t}\n\t\t\t\tif ((walk_state->control_state) &&\n\t\t\t\t    ((walk_state->control_state->control.\n\t\t\t\t      opcode == AML_IF_OP)\n\t\t\t\t     || (walk_state->control_state->control.\n\t\t\t\t\t opcode == AML_WHILE_OP))) {\n\t\t\t\t\t \n\t\t\t\t\tparser_state->aml =\n\t\t\t\t\t    walk_state->control_state->control.\n\t\t\t\t\t    aml_predicate_start + 1;\n\t\t\t\t\tparser_state->aml =\n\t\t\t\t\t    acpi_ps_get_next_package_end\n\t\t\t\t\t    (parser_state);\n\t\t\t\t\twalk_state->aml = parser_state->aml;\n\n\t\t\t\t\tACPI_ERROR((AE_INFO,\n\t\t\t\t\t\t    \"Skipping While/If block\"));\n\t\t\t\t\tif (*walk_state->aml == AML_ELSE_OP) {\n\t\t\t\t\t\tACPI_ERROR((AE_INFO,\n\t\t\t\t\t\t\t    \"Skipping Else block\"));\n\t\t\t\t\t\twalk_state->parser_state.aml =\n\t\t\t\t\t\t    walk_state->aml + 1;\n\t\t\t\t\t\twalk_state->parser_state.aml =\n\t\t\t\t\t\t    acpi_ps_get_next_package_end\n\t\t\t\t\t\t    (parser_state);\n\t\t\t\t\t\twalk_state->aml =\n\t\t\t\t\t\t    parser_state->aml;\n\t\t\t\t\t}\n\t\t\t\t\tACPI_FREE(acpi_ut_pop_generic_state\n\t\t\t\t\t\t  (&walk_state->control_state));\n\t\t\t\t}\n\t\t\t\top = NULL;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\t \n\n\t\tACPI_DEBUG_PRINT((ACPI_DB_PARSE,\n\t\t\t\t  \"Parseloop: argument count: %8.8X\\n\",\n\t\t\t\t  walk_state->arg_count));\n\n\t\tif (walk_state->arg_count) {\n\t\t\t \n\t\t\tstatus = acpi_ps_push_scope(parser_state, op,\n\t\t\t\t\t\t    walk_state->arg_types,\n\t\t\t\t\t\t    walk_state->arg_count);\n\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ps_complete_op(walk_state, &op,\n\t\t\t\t\t\t\tstatus);\n\t\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t\t}\n\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\top = NULL;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\twalk_state->op_info =\n\t\t    acpi_ps_get_opcode_info(op->common.aml_opcode);\n\t\tif (walk_state->op_info->flags & AML_NAMED) {\n\t\t\tif (op->common.aml_opcode == AML_REGION_OP ||\n\t\t\t    op->common.aml_opcode == AML_DATA_REGION_OP) {\n\t\t\t\t \n\t\t\t\top->named.length =\n\t\t\t\t    (u32) (parser_state->aml - op->named.data);\n\t\t\t}\n\t\t}\n\n\t\tif (walk_state->op_info->flags & AML_CREATE) {\n\t\t\t \n\t\t\top->named.length =\n\t\t\t    (u32) (parser_state->aml - op->named.data);\n\t\t}\n\n\t\tif (op->common.aml_opcode == AML_BANK_FIELD_OP) {\n\t\t\t \n\t\t\top->named.length =\n\t\t\t    (u32) (parser_state->aml - op->named.data);\n\t\t}\n\n\t\t \n\n\t\tif (walk_state->ascending_callback != NULL) {\n\t\t\twalk_state->op = op;\n\t\t\twalk_state->opcode = op->common.aml_opcode;\n\n\t\t\tstatus = walk_state->ascending_callback(walk_state);\n\t\t\tstatus =\n\t\t\t    acpi_ps_next_parse_state(walk_state, op, status);\n\t\t\tif (status == AE_CTRL_PENDING) {\n\t\t\t\tstatus = AE_OK;\n\t\t\t} else\n\t\t\t    if ((walk_state->\n\t\t\t\t parse_flags & ACPI_PARSE_MODULE_LEVEL)\n\t\t\t\t&& (ACPI_AML_EXCEPTION(status)\n\t\t\t\t    || status == AE_ALREADY_EXISTS\n\t\t\t\t    || status == AE_NOT_FOUND)) {\n\t\t\t\t \n\t\t\t\tstatus = AE_OK;\n\t\t\t}\n\t\t}\n\n\t\tstatus = acpi_ps_complete_op(walk_state, &op, status);\n\t\tif (ACPI_FAILURE(status)) {\n\t\t\treturn_ACPI_STATUS(status);\n\t\t}\n\n\t}\t\t\t \n\n\tstatus = acpi_ps_complete_final_op(walk_state, op, status);\n\treturn_ACPI_STATUS(status);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}