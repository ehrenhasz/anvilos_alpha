{
  "module_name": "exprep.c",
  "hash_id": "ec54837e0622fc6ad61576c28cea230bce4bc869cdf3a6b7004f0c6c0f72a2ef",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/acpica/exprep.c",
  "human_readable_source": "\n \n\n#include <acpi/acpi.h>\n#include \"accommon.h\"\n#include \"acinterp.h\"\n#include \"amlcode.h\"\n#include \"acnamesp.h\"\n#include \"acdispat.h\"\n\n#define _COMPONENT          ACPI_EXECUTER\nACPI_MODULE_NAME(\"exprep\")\n\n \nstatic u32\nacpi_ex_decode_field_access(union acpi_operand_object *obj_desc,\n\t\t\t    u8 field_flags, u32 * return_byte_alignment);\n\n#ifdef ACPI_UNDER_DEVELOPMENT\n\nstatic u32\nacpi_ex_generate_access(u32 field_bit_offset,\n\t\t\tu32 field_bit_length, u32 region_length);\n\n \n\nstatic u32\nacpi_ex_generate_access(u32 field_bit_offset,\n\t\t\tu32 field_bit_length, u32 region_length)\n{\n\tu32 field_byte_length;\n\tu32 field_byte_offset;\n\tu32 field_byte_end_offset;\n\tu32 access_byte_width;\n\tu32 field_start_offset;\n\tu32 field_end_offset;\n\tu32 minimum_access_width = 0xFFFFFFFF;\n\tu32 minimum_accesses = 0xFFFFFFFF;\n\tu32 accesses;\n\n\tACPI_FUNCTION_TRACE(ex_generate_access);\n\n\t \n\n\tfield_byte_offset = ACPI_DIV_8(ACPI_ROUND_DOWN(field_bit_offset, 8));\n\n\tfield_byte_end_offset =\n\t    ACPI_DIV_8(ACPI_ROUND_UP(field_bit_length + field_bit_offset, 8));\n\n\tfield_byte_length = field_byte_end_offset - field_byte_offset;\n\n\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t  \"Bit length %u, Bit offset %u\\n\",\n\t\t\t  field_bit_length, field_bit_offset));\n\n\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t  \"Byte Length %u, Byte Offset %u, End Offset %u\\n\",\n\t\t\t  field_byte_length, field_byte_offset,\n\t\t\t  field_byte_end_offset));\n\n\t \n\tfor (access_byte_width = 1; access_byte_width <= 8;\n\t     access_byte_width <<= 1) {\n\t\t \n\t\tif (ACPI_ROUND_UP(field_byte_end_offset, access_byte_width) <=\n\t\t    region_length) {\n\t\t\tfield_start_offset =\n\t\t\t    ACPI_ROUND_DOWN(field_byte_offset,\n\t\t\t\t\t    access_byte_width) /\n\t\t\t    access_byte_width;\n\n\t\t\tfield_end_offset =\n\t\t\t    ACPI_ROUND_UP((field_byte_length +\n\t\t\t\t\t   field_byte_offset),\n\t\t\t\t\t  access_byte_width) /\n\t\t\t    access_byte_width;\n\n\t\t\taccesses = field_end_offset - field_start_offset;\n\n\t\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t\t  \"AccessWidth %u end is within region\\n\",\n\t\t\t\t\t  access_byte_width));\n\n\t\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t\t  \"Field Start %u, Field End %u -- requires %u accesses\\n\",\n\t\t\t\t\t  field_start_offset, field_end_offset,\n\t\t\t\t\t  accesses));\n\n\t\t\t \n\n\t\t\tif (accesses <= 1) {\n\t\t\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t\t\t  \"Entire field can be accessed \"\n\t\t\t\t\t\t  \"with one operation of size %u\\n\",\n\t\t\t\t\t\t  access_byte_width));\n\t\t\t\treturn_VALUE(access_byte_width);\n\t\t\t}\n\n\t\t\t \n\t\t\tif (accesses < minimum_accesses) {\n\t\t\t\tminimum_accesses = accesses;\n\t\t\t\tminimum_access_width = access_byte_width;\n\t\t\t}\n\t\t} else {\n\t\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t\t  \"AccessWidth %u end is NOT within region\\n\",\n\t\t\t\t\t  access_byte_width));\n\t\t\tif (access_byte_width == 1) {\n\t\t\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t\t\t  \"Field goes beyond end-of-region!\\n\"));\n\n\t\t\t\t \n\n\t\t\t\treturn_VALUE(0);\n\t\t\t}\n\n\t\t\t \n\t\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t\t  \"Backing off to previous optimal access width of %u\\n\",\n\t\t\t\t\t  minimum_access_width));\n\t\t\treturn_VALUE(minimum_access_width);\n\t\t}\n\t}\n\n\t \n\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t  \"Cannot access field in one operation, using width 8\\n\"));\n\n\treturn_VALUE(8);\n}\n#endif\t\t\t\t \n\n \n\nstatic u32\nacpi_ex_decode_field_access(union acpi_operand_object *obj_desc,\n\t\t\t    u8 field_flags, u32 * return_byte_alignment)\n{\n\tu32 access;\n\tu32 byte_alignment;\n\tu32 bit_length;\n\n\tACPI_FUNCTION_TRACE(ex_decode_field_access);\n\n\taccess = (field_flags & AML_FIELD_ACCESS_TYPE_MASK);\n\n\tswitch (access) {\n\tcase AML_FIELD_ACCESS_ANY:\n\n#ifdef ACPI_UNDER_DEVELOPMENT\n\t\tbyte_alignment =\n\t\t    acpi_ex_generate_access(obj_desc->common_field.\n\t\t\t\t\t    start_field_bit_offset,\n\t\t\t\t\t    obj_desc->common_field.bit_length,\n\t\t\t\t\t    0xFFFFFFFF\n\t\t\t\t\t     \n\t\t    );\n\t\tbit_length = byte_alignment * 8;\n#endif\n\n\t\tbyte_alignment = 1;\n\t\tbit_length = 8;\n\t\tbreak;\n\n\tcase AML_FIELD_ACCESS_BYTE:\n\tcase AML_FIELD_ACCESS_BUFFER:\t \n\n\t\tbyte_alignment = 1;\n\t\tbit_length = 8;\n\t\tbreak;\n\n\tcase AML_FIELD_ACCESS_WORD:\n\n\t\tbyte_alignment = 2;\n\t\tbit_length = 16;\n\t\tbreak;\n\n\tcase AML_FIELD_ACCESS_DWORD:\n\n\t\tbyte_alignment = 4;\n\t\tbit_length = 32;\n\t\tbreak;\n\n\tcase AML_FIELD_ACCESS_QWORD:\t \n\n\t\tbyte_alignment = 8;\n\t\tbit_length = 64;\n\t\tbreak;\n\n\tdefault:\n\n\t\t \n\n\t\tACPI_ERROR((AE_INFO, \"Unknown field access type 0x%X\", access));\n\n\t\treturn_UINT32(0);\n\t}\n\n\tif (obj_desc->common.type == ACPI_TYPE_BUFFER_FIELD) {\n\t\t \n\t\tbyte_alignment = 1;\n\t}\n\n\t*return_byte_alignment = byte_alignment;\n\treturn_UINT32(bit_length);\n}\n\n \n\nacpi_status\nacpi_ex_prep_common_field_object(union acpi_operand_object *obj_desc,\n\t\t\t\t u8 field_flags,\n\t\t\t\t u8 field_attribute,\n\t\t\t\t u32 field_bit_position, u32 field_bit_length)\n{\n\tu32 access_bit_width;\n\tu32 byte_alignment;\n\tu32 nearest_byte_address;\n\n\tACPI_FUNCTION_TRACE(ex_prep_common_field_object);\n\n\t \n\tobj_desc->common_field.field_flags = field_flags;\n\tobj_desc->common_field.attribute = field_attribute;\n\tobj_desc->common_field.bit_length = field_bit_length;\n\n\t \n\taccess_bit_width =\n\t    acpi_ex_decode_field_access(obj_desc, field_flags, &byte_alignment);\n\tif (!access_bit_width) {\n\t\treturn_ACPI_STATUS(AE_AML_OPERAND_VALUE);\n\t}\n\n\t \n\n\tobj_desc->common_field.access_byte_width = (u8)\n\t    ACPI_DIV_8(access_bit_width);\n\n\t \n\tnearest_byte_address =\n\t    ACPI_ROUND_BITS_DOWN_TO_BYTES(field_bit_position);\n\tobj_desc->common_field.base_byte_offset = (u32)\n\t    ACPI_ROUND_DOWN(nearest_byte_address, byte_alignment);\n\n\t \n\tobj_desc->common_field.start_field_bit_offset = (u8)\n\t    (field_bit_position -\n\t     ACPI_MUL_8(obj_desc->common_field.base_byte_offset));\n\n\treturn_ACPI_STATUS(AE_OK);\n}\n\n \n\nacpi_status acpi_ex_prep_field_value(struct acpi_create_field_info *info)\n{\n\tunion acpi_operand_object *obj_desc;\n\tunion acpi_operand_object *second_desc = NULL;\n\tacpi_status status;\n\tu32 access_byte_width;\n\tu32 type;\n\n\tACPI_FUNCTION_TRACE(ex_prep_field_value);\n\n\t \n\n\tif (info->field_type != ACPI_TYPE_LOCAL_INDEX_FIELD) {\n\t\tif (!info->region_node) {\n\t\t\tACPI_ERROR((AE_INFO, \"Null RegionNode\"));\n\t\t\treturn_ACPI_STATUS(AE_AML_NO_OPERAND);\n\t\t}\n\n\t\ttype = acpi_ns_get_type(info->region_node);\n\t\tif (type != ACPI_TYPE_REGION) {\n\t\t\tACPI_ERROR((AE_INFO,\n\t\t\t\t    \"Needed Region, found type 0x%X (%s)\", type,\n\t\t\t\t    acpi_ut_get_type_name(type)));\n\n\t\t\treturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\n\t\t}\n\t}\n\n\t \n\n\tobj_desc = acpi_ut_create_internal_object(info->field_type);\n\tif (!obj_desc) {\n\t\treturn_ACPI_STATUS(AE_NO_MEMORY);\n\t}\n\n\t \n\n\tobj_desc->common_field.node = info->field_node;\n\tstatus = acpi_ex_prep_common_field_object(obj_desc,\n\t\t\t\t\t\t  info->field_flags,\n\t\t\t\t\t\t  info->attribute,\n\t\t\t\t\t\t  info->field_bit_position,\n\t\t\t\t\t\t  info->field_bit_length);\n\tif (ACPI_FAILURE(status)) {\n\t\tacpi_ut_delete_object_desc(obj_desc);\n\t\treturn_ACPI_STATUS(status);\n\t}\n\n\t \n\n\tswitch (info->field_type) {\n\tcase ACPI_TYPE_LOCAL_REGION_FIELD:\n\n\t\tobj_desc->field.region_obj =\n\t\t    acpi_ns_get_attached_object(info->region_node);\n\n\t\t \n\n\t\tobj_desc->field.access_length = info->access_length;\n\n\t\tif (info->connection_node) {\n\t\t\tsecond_desc = info->connection_node->object;\n\t\t\tif (!(second_desc->common.flags & AOPOBJ_DATA_VALID)) {\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ds_get_buffer_arguments(second_desc);\n\t\t\t\tif (ACPI_FAILURE(status)) {\n\t\t\t\t\tacpi_ut_delete_object_desc(obj_desc);\n\t\t\t\t\treturn_ACPI_STATUS(status);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tobj_desc->field.resource_buffer =\n\t\t\t    second_desc->buffer.pointer;\n\t\t\tobj_desc->field.resource_length =\n\t\t\t    (u16)second_desc->buffer.length;\n\t\t} else if (info->resource_buffer) {\n\t\t\tobj_desc->field.resource_buffer = info->resource_buffer;\n\t\t\tobj_desc->field.resource_length = info->resource_length;\n\t\t}\n\n\t\tobj_desc->field.pin_number_index = info->pin_number_index;\n\n\t\t \n\n\t\tif ((obj_desc->field.region_obj->region.space_id ==\n\t\t     ACPI_ADR_SPACE_EC)\n\t\t    && (obj_desc->common_field.bit_length > 8)) {\n\t\t\taccess_byte_width =\n\t\t\t    ACPI_ROUND_BITS_UP_TO_BYTES(obj_desc->common_field.\n\t\t\t\t\t\t\tbit_length);\n\n\t\t\t \n\n\t\t\tif (access_byte_width < 256) {\n\t\t\t\tobj_desc->common_field.access_byte_width =\n\t\t\t\t    (u8)access_byte_width;\n\t\t\t}\n\t\t}\n\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t  \"RegionField: BitOff %X, Off %X, Gran %X, Region %p\\n\",\n\t\t\t\t  obj_desc->field.start_field_bit_offset,\n\t\t\t\t  obj_desc->field.base_byte_offset,\n\t\t\t\t  obj_desc->field.access_byte_width,\n\t\t\t\t  obj_desc->field.region_obj));\n\t\tbreak;\n\n\tcase ACPI_TYPE_LOCAL_BANK_FIELD:\n\n\t\tobj_desc->bank_field.value = info->bank_value;\n\t\tobj_desc->bank_field.region_obj =\n\t\t    acpi_ns_get_attached_object(info->region_node);\n\t\tobj_desc->bank_field.bank_obj =\n\t\t    acpi_ns_get_attached_object(info->register_node);\n\n\t\t \n\n\t\tacpi_ut_add_reference(obj_desc->bank_field.region_obj);\n\t\tacpi_ut_add_reference(obj_desc->bank_field.bank_obj);\n\n\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t  \"Bank Field: BitOff %X, Off %X, Gran %X, Region %p, BankReg %p\\n\",\n\t\t\t\t  obj_desc->bank_field.start_field_bit_offset,\n\t\t\t\t  obj_desc->bank_field.base_byte_offset,\n\t\t\t\t  obj_desc->field.access_byte_width,\n\t\t\t\t  obj_desc->bank_field.region_obj,\n\t\t\t\t  obj_desc->bank_field.bank_obj));\n\n\t\t \n\t\tsecond_desc = obj_desc->common.next_object;\n\t\tsecond_desc->extra.aml_start =\n\t\t    ACPI_CAST_PTR(union acpi_parse_object,\n\t\t\t\t  info->data_register_node)->named.data;\n\t\tsecond_desc->extra.aml_length =\n\t\t    ACPI_CAST_PTR(union acpi_parse_object,\n\t\t\t\t  info->data_register_node)->named.length;\n\n\t\tbreak;\n\n\tcase ACPI_TYPE_LOCAL_INDEX_FIELD:\n\n\t\t \n\n\t\tobj_desc->index_field.index_obj =\n\t\t    acpi_ns_get_attached_object(info->register_node);\n\t\tobj_desc->index_field.data_obj =\n\t\t    acpi_ns_get_attached_object(info->data_register_node);\n\n\t\tif (!obj_desc->index_field.data_obj\n\t\t    || !obj_desc->index_field.index_obj) {\n\t\t\tACPI_ERROR((AE_INFO,\n\t\t\t\t    \"Null Index Object during field prep\"));\n\t\t\tacpi_ut_delete_object_desc(obj_desc);\n\t\t\treturn_ACPI_STATUS(AE_AML_INTERNAL);\n\t\t}\n\n\t\t \n\n\t\tacpi_ut_add_reference(obj_desc->index_field.data_obj);\n\t\tacpi_ut_add_reference(obj_desc->index_field.index_obj);\n\n\t\t \n\t\tobj_desc->index_field.value =\n\t\t    (u32) ACPI_ROUND_DOWN(ACPI_DIV_8(info->field_bit_position),\n\t\t\t\t\t  obj_desc->index_field.\n\t\t\t\t\t  access_byte_width);\n\n\t\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t\t  \"IndexField: BitOff %X, Off %X, Value %X, \"\n\t\t\t\t  \"Gran %X, Index %p, Data %p\\n\",\n\t\t\t\t  obj_desc->index_field.start_field_bit_offset,\n\t\t\t\t  obj_desc->index_field.base_byte_offset,\n\t\t\t\t  obj_desc->index_field.value,\n\t\t\t\t  obj_desc->field.access_byte_width,\n\t\t\t\t  obj_desc->index_field.index_obj,\n\t\t\t\t  obj_desc->index_field.data_obj));\n\t\tbreak;\n\n\tdefault:\n\n\t\t \n\n\t\tbreak;\n\t}\n\n\t \n\tstatus =\n\t    acpi_ns_attach_object(info->field_node, obj_desc,\n\t\t\t\t  acpi_ns_get_type(info->field_node));\n\n\tACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\n\t\t\t  \"Set NamedObj %p [%4.4s], ObjDesc %p\\n\",\n\t\t\t  info->field_node,\n\t\t\t  acpi_ut_get_node_name(info->field_node), obj_desc));\n\n\t \n\n\tacpi_ut_remove_reference(obj_desc);\n\treturn_ACPI_STATUS(status);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}