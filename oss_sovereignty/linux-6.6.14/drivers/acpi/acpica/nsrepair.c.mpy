{
  "module_name": "nsrepair.c",
  "hash_id": "c4631be576a817cc34dba62b78994e9ddac41a1d7c1042dc4f4baf66c403bb94",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/acpica/nsrepair.c",
  "human_readable_source": "\n \n\n#include <acpi/acpi.h>\n#include \"accommon.h\"\n#include \"acnamesp.h\"\n#include \"acinterp.h\"\n#include \"acpredef.h\"\n#include \"amlresrc.h\"\n\n#define _COMPONENT          ACPI_NAMESPACE\nACPI_MODULE_NAME(\"nsrepair\")\n\n \n \nstatic const struct acpi_simple_repair_info *acpi_ns_match_simple_repair(struct\n\t\t\t\t\t\t\t\t\t acpi_namespace_node\n\t\t\t\t\t\t\t\t\t *node,\n\t\t\t\t\t\t\t\t\t u32\n\t\t\t\t\t\t\t\t\t return_btype,\n\t\t\t\t\t\t\t\t\t u32\n\t\t\t\t\t\t\t\t\t package_index);\n\n \nstatic const struct acpi_simple_repair_info acpi_object_repair_info[] = {\n\t \n\n\t{\"_CRS\",\n\t ACPI_RTYPE_INTEGER | ACPI_RTYPE_STRING | ACPI_RTYPE_BUFFER |\n\t ACPI_RTYPE_NONE,\n\t ACPI_NOT_PACKAGE_ELEMENT,\n\t acpi_ns_convert_to_resource},\n\t{\"_DMA\",\n\t ACPI_RTYPE_INTEGER | ACPI_RTYPE_STRING | ACPI_RTYPE_BUFFER |\n\t ACPI_RTYPE_NONE,\n\t ACPI_NOT_PACKAGE_ELEMENT,\n\t acpi_ns_convert_to_resource},\n\t{\"_PRS\",\n\t ACPI_RTYPE_INTEGER | ACPI_RTYPE_STRING | ACPI_RTYPE_BUFFER |\n\t ACPI_RTYPE_NONE,\n\t ACPI_NOT_PACKAGE_ELEMENT,\n\t acpi_ns_convert_to_resource},\n\n\t \n\n\t{\"_DEP\", ACPI_RTYPE_STRING, ACPI_ALL_PACKAGE_ELEMENTS,\n\t acpi_ns_convert_to_reference},\n\n\t \n\n\t{\"_MLS\", ACPI_RTYPE_STRING, 1,\n\t acpi_ns_convert_to_unicode},\n\t{\"_STR\", ACPI_RTYPE_STRING | ACPI_RTYPE_BUFFER,\n\t ACPI_NOT_PACKAGE_ELEMENT,\n\t acpi_ns_convert_to_unicode},\n\t{{0, 0, 0, 0}, 0, 0, NULL}\t \n};\n\n \n\nacpi_status\nacpi_ns_simple_repair(struct acpi_evaluate_info *info,\n\t\t      u32 expected_btypes,\n\t\t      u32 package_index,\n\t\t      union acpi_operand_object **return_object_ptr)\n{\n\tunion acpi_operand_object *return_object = *return_object_ptr;\n\tunion acpi_operand_object *new_object = NULL;\n\tacpi_status status;\n\tconst struct acpi_simple_repair_info *predefined;\n\n\tACPI_FUNCTION_NAME(ns_simple_repair);\n\n\t \n\tpredefined = acpi_ns_match_simple_repair(info->node,\n\t\t\t\t\t\t info->return_btype,\n\t\t\t\t\t\t package_index);\n\tif (predefined) {\n\t\tif (!return_object) {\n\t\t\tACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\n\t\t\t\t\t      ACPI_WARN_ALWAYS,\n\t\t\t\t\t      \"Missing expected return value\"));\n\t\t}\n\n\t\tstatus = predefined->object_converter(info->node, return_object,\n\t\t\t\t\t\t      &new_object);\n\t\tif (ACPI_FAILURE(status)) {\n\n\t\t\t \n\n\t\t\tACPI_EXCEPTION((AE_INFO, status,\n\t\t\t\t\t\"During return object analysis\"));\n\t\t\treturn (status);\n\t\t}\n\t\tif (new_object) {\n\t\t\tgoto object_repaired;\n\t\t}\n\t}\n\n\t \n\tif (info->return_btype & expected_btypes) {\n\t\treturn (AE_OK);\n\t}\n\n\t \n\n\t \n\tif (!return_object) {\n\t\tif (expected_btypes) {\n\t\t\tif (!(expected_btypes & ACPI_RTYPE_NONE) &&\n\t\t\t    package_index != ACPI_NOT_PACKAGE_ELEMENT) {\n\t\t\t\tACPI_WARN_PREDEFINED((AE_INFO,\n\t\t\t\t\t\t      info->full_pathname,\n\t\t\t\t\t\t      ACPI_WARN_ALWAYS,\n\t\t\t\t\t\t      \"Found unexpected NULL package element\"));\n\n\t\t\t\tstatus =\n\t\t\t\t    acpi_ns_repair_null_element(info,\n\t\t\t\t\t\t\t\texpected_btypes,\n\t\t\t\t\t\t\t\tpackage_index,\n\t\t\t\t\t\t\t\treturn_object_ptr);\n\t\t\t\tif (ACPI_SUCCESS(status)) {\n\t\t\t\t\treturn (AE_OK);\t \n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (expected_btypes != ACPI_RTYPE_NONE) {\n\t\t\t\tACPI_WARN_PREDEFINED((AE_INFO,\n\t\t\t\t\t\t      info->full_pathname,\n\t\t\t\t\t\t      ACPI_WARN_ALWAYS,\n\t\t\t\t\t\t      \"Missing expected return value\"));\n\t\t\t\treturn (AE_AML_NO_RETURN_VALUE);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (expected_btypes & ACPI_RTYPE_INTEGER) {\n\t\tstatus = acpi_ns_convert_to_integer(return_object, &new_object);\n\t\tif (ACPI_SUCCESS(status)) {\n\t\t\tgoto object_repaired;\n\t\t}\n\t}\n\tif (expected_btypes & ACPI_RTYPE_STRING) {\n\t\tstatus = acpi_ns_convert_to_string(return_object, &new_object);\n\t\tif (ACPI_SUCCESS(status)) {\n\t\t\tgoto object_repaired;\n\t\t}\n\t}\n\tif (expected_btypes & ACPI_RTYPE_BUFFER) {\n\t\tstatus = acpi_ns_convert_to_buffer(return_object, &new_object);\n\t\tif (ACPI_SUCCESS(status)) {\n\t\t\tgoto object_repaired;\n\t\t}\n\t}\n\tif (expected_btypes & ACPI_RTYPE_PACKAGE) {\n\t\t \n\t\tstatus =\n\t\t    acpi_ns_wrap_with_package(info, return_object, &new_object);\n\t\tif (ACPI_SUCCESS(status)) {\n\t\t\t \n\t\t\t*return_object_ptr = new_object;\t \n\t\t\tinfo->return_flags |= ACPI_OBJECT_REPAIRED;\n\t\t\treturn (AE_OK);\n\t\t}\n\t}\n\n\t \n\n\treturn (AE_AML_OPERAND_TYPE);\n\nobject_repaired:\n\n\t \n\n\tif (package_index != ACPI_NOT_PACKAGE_ELEMENT) {\n\n\t\t \n\n\t\tif (!(info->return_flags & ACPI_OBJECT_WRAPPED)) {\n\t\t\tnew_object->common.reference_count =\n\t\t\t    return_object->common.reference_count;\n\t\t}\n\n\t\tACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\n\t\t\t\t  \"%s: Converted %s to expected %s at Package index %u\\n\",\n\t\t\t\t  info->full_pathname,\n\t\t\t\t  acpi_ut_get_object_type_name(return_object),\n\t\t\t\t  acpi_ut_get_object_type_name(new_object),\n\t\t\t\t  package_index));\n\t} else {\n\t\tACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\n\t\t\t\t  \"%s: Converted %s to expected %s\\n\",\n\t\t\t\t  info->full_pathname,\n\t\t\t\t  acpi_ut_get_object_type_name(return_object),\n\t\t\t\t  acpi_ut_get_object_type_name(new_object)));\n\t}\n\n\t \n\n\tacpi_ut_remove_reference(return_object);\n\t*return_object_ptr = new_object;\n\tinfo->return_flags |= ACPI_OBJECT_REPAIRED;\n\treturn (AE_OK);\n}\n\n \n\nstatic const struct acpi_simple_repair_info *acpi_ns_match_simple_repair(struct\n\t\t\t\t\t\t\t\t\t acpi_namespace_node\n\t\t\t\t\t\t\t\t\t *node,\n\t\t\t\t\t\t\t\t\t u32\n\t\t\t\t\t\t\t\t\t return_btype,\n\t\t\t\t\t\t\t\t\t u32\n\t\t\t\t\t\t\t\t\t package_index)\n{\n\tconst struct acpi_simple_repair_info *this_name;\n\n\t \n\n\tthis_name = acpi_object_repair_info;\n\twhile (this_name->object_converter) {\n\t\tif (ACPI_COMPARE_NAMESEG(node->name.ascii, this_name->name)) {\n\n\t\t\t \n\n\t\t\tif ((return_btype & this_name->unexpected_btypes) &&\n\t\t\t    (this_name->package_index ==\n\t\t\t     ACPI_ALL_PACKAGE_ELEMENTS\n\t\t\t     || package_index == this_name->package_index)) {\n\t\t\t\treturn (this_name);\n\t\t\t}\n\n\t\t\treturn (NULL);\n\t\t}\n\n\t\tthis_name++;\n\t}\n\n\treturn (NULL);\t\t \n}\n\n \n\nacpi_status\nacpi_ns_repair_null_element(struct acpi_evaluate_info *info,\n\t\t\t    u32 expected_btypes,\n\t\t\t    u32 package_index,\n\t\t\t    union acpi_operand_object **return_object_ptr)\n{\n\tunion acpi_operand_object *return_object = *return_object_ptr;\n\tunion acpi_operand_object *new_object;\n\n\tACPI_FUNCTION_NAME(ns_repair_null_element);\n\n\t \n\n\tif (return_object) {\n\t\treturn (AE_OK);\n\t}\n\n\t \n\tif (expected_btypes & ACPI_RTYPE_INTEGER) {\n\n\t\t \n\n\t\tnew_object = acpi_ut_create_integer_object((u64)0);\n\t} else if (expected_btypes & ACPI_RTYPE_STRING) {\n\n\t\t \n\n\t\tnew_object = acpi_ut_create_string_object(0);\n\t} else if (expected_btypes & ACPI_RTYPE_BUFFER) {\n\n\t\t \n\n\t\tnew_object = acpi_ut_create_buffer_object(0);\n\t} else {\n\t\t \n\n\t\treturn (AE_AML_OPERAND_TYPE);\n\t}\n\n\tif (!new_object) {\n\t\treturn (AE_NO_MEMORY);\n\t}\n\n\t \n\n\tnew_object->common.reference_count =\n\t    info->parent_package->common.reference_count;\n\n\tACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\n\t\t\t  \"%s: Converted NULL package element to expected %s at index %u\\n\",\n\t\t\t  info->full_pathname,\n\t\t\t  acpi_ut_get_object_type_name(new_object),\n\t\t\t  package_index));\n\n\t*return_object_ptr = new_object;\n\tinfo->return_flags |= ACPI_OBJECT_REPAIRED;\n\treturn (AE_OK);\n}\n\n \n\nvoid\nacpi_ns_remove_null_elements(struct acpi_evaluate_info *info,\n\t\t\t     u8 package_type,\n\t\t\t     union acpi_operand_object *obj_desc)\n{\n\tunion acpi_operand_object **source;\n\tunion acpi_operand_object **dest;\n\tu32 count;\n\tu32 new_count;\n\tu32 i;\n\n\tACPI_FUNCTION_NAME(ns_remove_null_elements);\n\n\t \n\tswitch (package_type) {\n\tcase ACPI_PTYPE1_VAR:\n\tcase ACPI_PTYPE2:\n\tcase ACPI_PTYPE2_COUNT:\n\tcase ACPI_PTYPE2_PKG_COUNT:\n\tcase ACPI_PTYPE2_FIXED:\n\tcase ACPI_PTYPE2_MIN:\n\tcase ACPI_PTYPE2_REV_FIXED:\n\tcase ACPI_PTYPE2_FIX_VAR:\n\t\tbreak;\n\n\tdefault:\n\tcase ACPI_PTYPE2_VAR_VAR:\n\tcase ACPI_PTYPE1_FIXED:\n\tcase ACPI_PTYPE1_OPTION:\n\t\treturn;\n\t}\n\n\tcount = obj_desc->package.count;\n\tnew_count = count;\n\n\tsource = obj_desc->package.elements;\n\tdest = source;\n\n\t \n\n\tfor (i = 0; i < count; i++) {\n\t\tif (!*source) {\n\t\t\tnew_count--;\n\t\t} else {\n\t\t\t*dest = *source;\n\t\t\tdest++;\n\t\t}\n\n\t\tsource++;\n\t}\n\n\t \n\n\tif (new_count < count) {\n\t\tACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\n\t\t\t\t  \"%s: Found and removed %u NULL elements\\n\",\n\t\t\t\t  info->full_pathname, (count - new_count)));\n\n\t\t \n\n\t\t*dest = NULL;\n\t\tobj_desc->package.count = new_count;\n\t}\n}\n\n \n\nacpi_status\nacpi_ns_wrap_with_package(struct acpi_evaluate_info *info,\n\t\t\t  union acpi_operand_object *original_object,\n\t\t\t  union acpi_operand_object **obj_desc_ptr)\n{\n\tunion acpi_operand_object *pkg_obj_desc;\n\n\tACPI_FUNCTION_NAME(ns_wrap_with_package);\n\n\t \n\tpkg_obj_desc = acpi_ut_create_package_object(1);\n\tif (!pkg_obj_desc) {\n\t\treturn (AE_NO_MEMORY);\n\t}\n\n\tpkg_obj_desc->package.elements[0] = original_object;\n\n\tACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\n\t\t\t  \"%s: Wrapped %s with expected Package object\\n\",\n\t\t\t  info->full_pathname,\n\t\t\t  acpi_ut_get_object_type_name(original_object)));\n\n\t \n\n\t*obj_desc_ptr = pkg_obj_desc;\n\tinfo->return_flags |= ACPI_OBJECT_REPAIRED | ACPI_OBJECT_WRAPPED;\n\treturn (AE_OK);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}