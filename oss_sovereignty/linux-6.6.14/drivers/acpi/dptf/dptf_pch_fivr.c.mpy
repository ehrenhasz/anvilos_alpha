{
  "module_name": "dptf_pch_fivr.c",
  "hash_id": "c0dc1befbc1d781d86d4f9e68b2fcc1f9d2c78f260cfa31fc82da6240c58fd98",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/dptf/dptf_pch_fivr.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\nstruct pch_fivr_resp {\n\tu64 status;\n\tu64 result;\n};\n\nstatic int pch_fivr_read(acpi_handle handle, char *method, struct pch_fivr_resp *fivr_resp)\n{\n\tstruct acpi_buffer resp = { sizeof(struct pch_fivr_resp), fivr_resp};\n\tstruct acpi_buffer buffer = { ACPI_ALLOCATE_BUFFER, NULL };\n\tstruct acpi_buffer format = { sizeof(\"NN\"), \"NN\" };\n\tunion acpi_object *obj;\n\tacpi_status status;\n\tint ret = -EFAULT;\n\n\tstatus = acpi_evaluate_object(handle, method, NULL, &buffer);\n\tif (ACPI_FAILURE(status))\n\t\treturn ret;\n\n\tobj = buffer.pointer;\n\tif (!obj || obj->type != ACPI_TYPE_PACKAGE)\n\t\tgoto release_buffer;\n\n\tstatus = acpi_extract_package(obj, &format, &resp);\n\tif (ACPI_FAILURE(status))\n\t\tgoto release_buffer;\n\n\tif (fivr_resp->status)\n\t\tgoto release_buffer;\n\n\tret = 0;\n\nrelease_buffer:\n\tkfree(buffer.pointer);\n\treturn ret;\n}\n\n \n#define PCH_FIVR_SHOW(name, method) \\\nstatic ssize_t name##_show(struct device *dev,\\\n\t\t\t   struct device_attribute *attr,\\\n\t\t\t   char *buf)\\\n{\\\n\tstruct acpi_device *acpi_dev = dev_get_drvdata(dev);\\\n\tstruct pch_fivr_resp fivr_resp;\\\n\tint status;\\\n\\\n\tstatus = pch_fivr_read(acpi_dev->handle, #method, &fivr_resp);\\\n\tif (status)\\\n\t\treturn status;\\\n\\\n\treturn sprintf(buf, \"%llu\\n\", fivr_resp.result);\\\n}\n\n#define PCH_FIVR_STORE(name, method) \\\nstatic ssize_t name##_store(struct device *dev,\\\n\t\t\t    struct device_attribute *attr,\\\n\t\t\t    const char *buf, size_t count)\\\n{\\\n\tstruct acpi_device *acpi_dev = dev_get_drvdata(dev);\\\n\tacpi_status status;\\\n\tu32 val;\\\n\\\n\tif (kstrtouint(buf, 0, &val) < 0)\\\n\t\treturn -EINVAL;\\\n\\\n\tstatus = acpi_execute_simple_method(acpi_dev->handle, #method, val);\\\n\tif (ACPI_SUCCESS(status))\\\n\t\treturn count;\\\n\\\n\treturn -EINVAL;\\\n}\n\nPCH_FIVR_SHOW(freq_mhz_low_clock, GFC0)\nPCH_FIVR_SHOW(freq_mhz_high_clock, GFC1)\nPCH_FIVR_SHOW(ssc_clock_info, GEMI)\nPCH_FIVR_SHOW(fivr_switching_freq_mhz, GFCS)\nPCH_FIVR_SHOW(fivr_switching_fault_status, GFFS)\nPCH_FIVR_STORE(freq_mhz_low_clock, RFC0)\nPCH_FIVR_STORE(freq_mhz_high_clock, RFC1)\n\nstatic DEVICE_ATTR_RW(freq_mhz_low_clock);\nstatic DEVICE_ATTR_RW(freq_mhz_high_clock);\nstatic DEVICE_ATTR_RO(ssc_clock_info);\nstatic DEVICE_ATTR_RO(fivr_switching_freq_mhz);\nstatic DEVICE_ATTR_RO(fivr_switching_fault_status);\n\nstatic struct attribute *fivr_attrs[] = {\n\t&dev_attr_freq_mhz_low_clock.attr,\n\t&dev_attr_freq_mhz_high_clock.attr,\n\t&dev_attr_ssc_clock_info.attr,\n\t&dev_attr_fivr_switching_freq_mhz.attr,\n\t&dev_attr_fivr_switching_fault_status.attr,\n\tNULL\n};\n\nstatic const struct attribute_group pch_fivr_attribute_group = {\n\t.attrs = fivr_attrs,\n\t.name = \"pch_fivr_switch_frequency\"\n};\n\nstatic int pch_fivr_add(struct platform_device *pdev)\n{\n\tstruct acpi_device *acpi_dev;\n\tunsigned long long ptype;\n\tacpi_status status;\n\tint result;\n\n\tacpi_dev = ACPI_COMPANION(&(pdev->dev));\n\tif (!acpi_dev)\n\t\treturn -ENODEV;\n\n\tstatus = acpi_evaluate_integer(acpi_dev->handle, \"PTYP\", NULL, &ptype);\n\tif (ACPI_FAILURE(status) || ptype != 0x05)\n\t\treturn -ENODEV;\n\n\tresult = sysfs_create_group(&pdev->dev.kobj,\n\t\t\t\t    &pch_fivr_attribute_group);\n\tif (result)\n\t\treturn result;\n\n\tplatform_set_drvdata(pdev, acpi_dev);\n\n\treturn 0;\n}\n\nstatic int pch_fivr_remove(struct platform_device *pdev)\n{\n\tsysfs_remove_group(&pdev->dev.kobj, &pch_fivr_attribute_group);\n\n\treturn 0;\n}\n\nstatic const struct acpi_device_id pch_fivr_device_ids[] = {\n\t{\"INTC1045\", 0},\n\t{\"INTC1049\", 0},\n\t{\"INTC1064\", 0},\n\t{\"INTC10A3\", 0},\n\t{\"\", 0},\n};\nMODULE_DEVICE_TABLE(acpi, pch_fivr_device_ids);\n\nstatic struct platform_driver pch_fivr_driver = {\n\t.probe = pch_fivr_add,\n\t.remove = pch_fivr_remove,\n\t.driver = {\n\t\t.name = \"dptf_pch_fivr\",\n\t\t.acpi_match_table = pch_fivr_device_ids,\n\t},\n};\n\nmodule_platform_driver(pch_fivr_driver);\n\nMODULE_AUTHOR(\"Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"ACPI DPTF PCH FIVR driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}