{
  "module_name": "dptf_power.c",
  "hash_id": "8c316fbc8e1d40a54fb339ec8648b67efe3ecf0e83900cd91c7d525045c9c138",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/dptf/dptf_power.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/acpi.h>\n#include <linux/platform_device.h>\n\n \n#define DPTF_POWER_SHOW(name, object) \\\nstatic ssize_t name##_show(struct device *dev,\\\n\t\t\t   struct device_attribute *attr,\\\n\t\t\t   char *buf)\\\n{\\\n\tstruct acpi_device *acpi_dev = dev_get_drvdata(dev);\\\n\tunsigned long long val;\\\n\tacpi_status status;\\\n\\\n\tstatus = acpi_evaluate_integer(acpi_dev->handle, #object,\\\n\t\t\t\t       NULL, &val);\\\n\tif (ACPI_SUCCESS(status))\\\n\t\treturn sprintf(buf, \"%d\\n\", (int)val);\\\n\telse \\\n\t\treturn -EINVAL;\\\n}\n\nDPTF_POWER_SHOW(max_platform_power_mw, PMAX)\nDPTF_POWER_SHOW(platform_power_source, PSRC)\nDPTF_POWER_SHOW(adapter_rating_mw, ARTG)\nDPTF_POWER_SHOW(battery_steady_power_mw, PBSS)\nDPTF_POWER_SHOW(charger_type, CTYP)\nDPTF_POWER_SHOW(rest_of_platform_power_mw, PROP)\nDPTF_POWER_SHOW(max_steady_state_power_mw, PBSS)\nDPTF_POWER_SHOW(high_freq_impedance_mohm, RBHF)\nDPTF_POWER_SHOW(no_load_voltage_mv, VBNL)\nDPTF_POWER_SHOW(current_discharge_capbility_ma, CMPP);\n\nstatic DEVICE_ATTR_RO(max_platform_power_mw);\nstatic DEVICE_ATTR_RO(platform_power_source);\nstatic DEVICE_ATTR_RO(adapter_rating_mw);\nstatic DEVICE_ATTR_RO(battery_steady_power_mw);\nstatic DEVICE_ATTR_RO(charger_type);\nstatic DEVICE_ATTR_RO(rest_of_platform_power_mw);\nstatic DEVICE_ATTR_RO(max_steady_state_power_mw);\nstatic DEVICE_ATTR_RO(high_freq_impedance_mohm);\nstatic DEVICE_ATTR_RO(no_load_voltage_mv);\nstatic DEVICE_ATTR_RO(current_discharge_capbility_ma);\n\nstatic ssize_t prochot_confirm_store(struct device *dev,\n\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t     const char *buf, size_t count)\n{\n\tstruct acpi_device *acpi_dev = dev_get_drvdata(dev);\n\tacpi_status status;\n\tint seq_no;\n\n\tif (kstrtouint(buf, 0, &seq_no) < 0)\n\t\treturn -EINVAL;\n\n\tstatus = acpi_execute_simple_method(acpi_dev->handle, \"PBOK\", seq_no);\n\tif (ACPI_SUCCESS(status))\n\t\treturn count;\n\n\treturn -EINVAL;\n}\n\nstatic DEVICE_ATTR_WO(prochot_confirm);\n\nstatic struct attribute *dptf_power_attrs[] = {\n\t&dev_attr_max_platform_power_mw.attr,\n\t&dev_attr_platform_power_source.attr,\n\t&dev_attr_adapter_rating_mw.attr,\n\t&dev_attr_battery_steady_power_mw.attr,\n\t&dev_attr_charger_type.attr,\n\t&dev_attr_rest_of_platform_power_mw.attr,\n\t&dev_attr_prochot_confirm.attr,\n\tNULL\n};\n\nstatic const struct attribute_group dptf_power_attribute_group = {\n\t.attrs = dptf_power_attrs,\n\t.name = \"dptf_power\"\n};\n\nstatic struct attribute *dptf_battery_attrs[] = {\n\t&dev_attr_max_platform_power_mw.attr,\n\t&dev_attr_max_steady_state_power_mw.attr,\n\t&dev_attr_high_freq_impedance_mohm.attr,\n\t&dev_attr_no_load_voltage_mv.attr,\n\t&dev_attr_current_discharge_capbility_ma.attr,\n\tNULL\n};\n\nstatic const struct attribute_group dptf_battery_attribute_group = {\n\t.attrs = dptf_battery_attrs,\n\t.name = \"dptf_battery\"\n};\n\n#define MAX_POWER_CHANGED\t\t0x80\n#define POWER_STATE_CHANGED\t\t0x81\n#define STEADY_STATE_POWER_CHANGED\t0x83\n#define POWER_PROP_CHANGE_EVENT\t0x84\n#define IMPEDANCE_CHANGED\t\t0x85\n#define VOLTAGE_CURRENT_CHANGED\t0x86\n\nstatic long long dptf_participant_type(acpi_handle handle)\n{\n\tunsigned long long ptype;\n\tacpi_status status;\n\n\tstatus = acpi_evaluate_integer(handle, \"PTYP\", NULL, &ptype);\n\tif (ACPI_FAILURE(status))\n\t\treturn -ENODEV;\n\n\treturn ptype;\n}\n\nstatic void dptf_power_notify(acpi_handle handle, u32 event, void *data)\n{\n\tstruct platform_device *pdev = data;\n\tchar *attr;\n\n\tswitch (event) {\n\tcase POWER_STATE_CHANGED:\n\t\tattr = \"platform_power_source\";\n\t\tbreak;\n\tcase POWER_PROP_CHANGE_EVENT:\n\t\tattr = \"rest_of_platform_power_mw\";\n\t\tbreak;\n\tcase MAX_POWER_CHANGED:\n\t\tattr = \"max_platform_power_mw\";\n\t\tbreak;\n\tcase STEADY_STATE_POWER_CHANGED:\n\t\tattr = \"max_steady_state_power_mw\";\n\t\tbreak;\n\tcase IMPEDANCE_CHANGED:\n\t\tattr = \"high_freq_impedance_mohm\";\n\t\tbreak;\n\tcase VOLTAGE_CURRENT_CHANGED:\n\t\tattr = \"no_load_voltage_mv\";\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&pdev->dev, \"Unsupported event [0x%x]\\n\", event);\n\t\treturn;\n\t}\n\n\t \n\tif (dptf_participant_type(handle) == 0x0CULL)\n\t\tsysfs_notify(&pdev->dev.kobj, \"dptf_battery\", attr);\n\telse\n\t\tsysfs_notify(&pdev->dev.kobj, \"dptf_power\", attr);\n}\n\nstatic int dptf_power_add(struct platform_device *pdev)\n{\n\tconst struct attribute_group *attr_group;\n\tstruct acpi_device *acpi_dev;\n\tunsigned long long ptype;\n\tint result;\n\n\tacpi_dev = ACPI_COMPANION(&(pdev->dev));\n\tif (!acpi_dev)\n\t\treturn -ENODEV;\n\n\tptype = dptf_participant_type(acpi_dev->handle);\n\tif (ptype == 0x11)\n\t\tattr_group = &dptf_power_attribute_group;\n\telse if (ptype == 0x0C)\n\t\tattr_group = &dptf_battery_attribute_group;\n\telse\n\t\treturn -ENODEV;\n\n\tresult = acpi_install_notify_handler(acpi_dev->handle,\n\t\t\t\t\t     ACPI_DEVICE_NOTIFY,\n\t\t\t\t\t     dptf_power_notify,\n\t\t\t\t\t     (void *)pdev);\n\tif (result)\n\t\treturn result;\n\n\tresult = sysfs_create_group(&pdev->dev.kobj,\n\t\t\t\t    attr_group);\n\tif (result) {\n\t\tacpi_remove_notify_handler(acpi_dev->handle,\n\t\t\t\t\t   ACPI_DEVICE_NOTIFY,\n\t\t\t\t\t   dptf_power_notify);\n\t\treturn result;\n\t}\n\n\tplatform_set_drvdata(pdev, acpi_dev);\n\n\treturn 0;\n}\n\nstatic int dptf_power_remove(struct platform_device *pdev)\n{\n\tstruct acpi_device *acpi_dev = platform_get_drvdata(pdev);\n\n\tacpi_remove_notify_handler(acpi_dev->handle,\n\t\t\t\t   ACPI_DEVICE_NOTIFY,\n\t\t\t\t   dptf_power_notify);\n\n\tif (dptf_participant_type(acpi_dev->handle) == 0x0CULL)\n\t\tsysfs_remove_group(&pdev->dev.kobj, &dptf_battery_attribute_group);\n\telse\n\t\tsysfs_remove_group(&pdev->dev.kobj, &dptf_power_attribute_group);\n\n\treturn 0;\n}\n\nstatic const struct acpi_device_id int3407_device_ids[] = {\n\t{\"INT3407\", 0},\n\t{\"INT3532\", 0},\n\t{\"INTC1047\", 0},\n\t{\"INTC1050\", 0},\n\t{\"INTC1060\", 0},\n\t{\"INTC1061\", 0},\n\t{\"INTC1065\", 0},\n\t{\"INTC1066\", 0},\n\t{\"INTC10A4\", 0},\n\t{\"INTC10A5\", 0},\n\t{\"\", 0},\n};\nMODULE_DEVICE_TABLE(acpi, int3407_device_ids);\n\nstatic struct platform_driver dptf_power_driver = {\n\t.probe = dptf_power_add,\n\t.remove = dptf_power_remove,\n\t.driver = {\n\t\t.name = \"dptf_power\",\n\t\t.acpi_match_table = int3407_device_ids,\n\t},\n};\n\nmodule_platform_driver(dptf_power_driver);\n\nMODULE_AUTHOR(\"Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"ACPI DPTF platform power driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}