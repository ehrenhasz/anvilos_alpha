{
  "module_name": "bert.c",
  "hash_id": "bef1eef85f1a2722f736710387beb0289607f4f3973b9424606327c004b43148",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/apei/bert.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/acpi.h>\n#include <linux/cper.h>\n#include <linux/io.h>\n\n#include \"apei-internal.h\"\n\n#undef pr_fmt\n#define pr_fmt(fmt) \"BERT: \" fmt\n\n#define ACPI_BERT_PRINT_MAX_RECORDS 5\n#define ACPI_BERT_PRINT_MAX_LEN 1024\n\nstatic int bert_disable __initdata;\n\n \nstatic void __init bert_print_all(struct acpi_bert_region *region,\n\t\t\t\t  unsigned int region_len)\n{\n\tstruct acpi_hest_generic_status *estatus =\n\t\t(struct acpi_hest_generic_status *)region;\n\tint remain = region_len;\n\tint printed = 0, skipped = 0;\n\tu32 estatus_len;\n\n\twhile (remain >= sizeof(struct acpi_bert_region)) {\n\t\testatus_len = cper_estatus_len(estatus);\n\t\tif (remain < estatus_len) {\n\t\t\tpr_err(FW_BUG \"Truncated status block (length: %u).\\n\",\n\t\t\t       estatus_len);\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tif (!estatus->block_status)\n\t\t\tbreak;\n\n\t\tif (cper_estatus_check(estatus)) {\n\t\t\tpr_err(FW_BUG \"Invalid error record.\\n\");\n\t\t\tbreak;\n\t\t}\n\n\t\tif (estatus_len < ACPI_BERT_PRINT_MAX_LEN &&\n\t\t    printed < ACPI_BERT_PRINT_MAX_RECORDS) {\n\t\t\tpr_info_once(\"Error records from previous boot:\\n\");\n\t\t\tcper_estatus_print(KERN_INFO HW_ERR, estatus);\n\t\t\tprinted++;\n\t\t} else {\n\t\t\tskipped++;\n\t\t}\n\n\t\t \n\t\testatus->block_status = 0;\n\n\t\testatus = (void *)estatus + estatus_len;\n\t\tremain -= estatus_len;\n\t}\n\n\tif (skipped)\n\t\tpr_info(HW_ERR \"Skipped %d error records\\n\", skipped);\n\n\tif (printed + skipped)\n\t\tpr_info(\"Total records found: %d\\n\", printed + skipped);\n}\n\nstatic int __init setup_bert_disable(char *str)\n{\n\tbert_disable = 1;\n\n\treturn 1;\n}\n__setup(\"bert_disable\", setup_bert_disable);\n\nstatic int __init bert_check_table(struct acpi_table_bert *bert_tab)\n{\n\tif (bert_tab->header.length < sizeof(struct acpi_table_bert) ||\n\t    bert_tab->region_length < sizeof(struct acpi_bert_region))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int __init bert_init(void)\n{\n\tstruct apei_resources bert_resources;\n\tstruct acpi_bert_region *boot_error_region;\n\tstruct acpi_table_bert *bert_tab;\n\tunsigned int region_len;\n\tacpi_status status;\n\tint rc = 0;\n\n\tif (acpi_disabled)\n\t\treturn 0;\n\n\tif (bert_disable) {\n\t\tpr_info(\"Boot Error Record Table support is disabled.\\n\");\n\t\treturn 0;\n\t}\n\n\tstatus = acpi_get_table(ACPI_SIG_BERT, 0, (struct acpi_table_header **)&bert_tab);\n\tif (status == AE_NOT_FOUND)\n\t\treturn 0;\n\n\tif (ACPI_FAILURE(status)) {\n\t\tpr_err(\"get table failed, %s.\\n\", acpi_format_exception(status));\n\t\treturn -EINVAL;\n\t}\n\n\trc = bert_check_table(bert_tab);\n\tif (rc) {\n\t\tpr_err(FW_BUG \"table invalid.\\n\");\n\t\tgoto out_put_bert_tab;\n\t}\n\n\tregion_len = bert_tab->region_length;\n\tapei_resources_init(&bert_resources);\n\trc = apei_resources_add(&bert_resources, bert_tab->address,\n\t\t\t\tregion_len, true);\n\tif (rc)\n\t\tgoto out_put_bert_tab;\n\trc = apei_resources_request(&bert_resources, \"APEI BERT\");\n\tif (rc)\n\t\tgoto out_fini;\n\tboot_error_region = ioremap_cache(bert_tab->address, region_len);\n\tif (boot_error_region) {\n\t\tbert_print_all(boot_error_region, region_len);\n\t\tiounmap(boot_error_region);\n\t} else {\n\t\trc = -ENOMEM;\n\t}\n\n\tapei_resources_release(&bert_resources);\nout_fini:\n\tapei_resources_fini(&bert_resources);\nout_put_bert_tab:\n\tacpi_put_table((struct acpi_table_header *)bert_tab);\n\n\treturn rc;\n}\n\nlate_initcall(bert_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}