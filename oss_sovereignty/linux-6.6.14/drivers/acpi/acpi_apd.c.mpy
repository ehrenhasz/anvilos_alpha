{
  "module_name": "acpi_apd.c",
  "hash_id": "67b7e33b58cb2bb50db20e952082fddb1c36f0e951519d98c98c9219b2ba986e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/acpi_apd.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/clkdev.h>\n#include <linux/clk-provider.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/platform_data/clk-fch.h>\n#include <linux/platform_device.h>\n\n#include \"internal.h\"\n\nstruct apd_private_data;\n\n \nstruct apd_device_desc {\n\tunsigned int fixed_clk_rate;\n\tstruct property_entry *properties;\n\tint (*setup)(struct apd_private_data *pdata);\n};\n\nstruct apd_private_data {\n\tstruct clk *clk;\n\tstruct acpi_device *adev;\n\tconst struct apd_device_desc *dev_desc;\n};\n\n#if defined(CONFIG_X86_AMD_PLATFORM_DEVICE) || defined(CONFIG_ARM64)\n#define APD_ADDR(desc)\t((unsigned long)&desc)\n\nstatic int acpi_apd_setup(struct apd_private_data *pdata)\n{\n\tconst struct apd_device_desc *dev_desc = pdata->dev_desc;\n\tstruct clk *clk;\n\n\tif (dev_desc->fixed_clk_rate) {\n\t\tclk = clk_register_fixed_rate(&pdata->adev->dev,\n\t\t\t\t\tdev_name(&pdata->adev->dev),\n\t\t\t\t\tNULL, 0, dev_desc->fixed_clk_rate);\n\t\tclk_register_clkdev(clk, NULL, dev_name(&pdata->adev->dev));\n\t\tpdata->clk = clk;\n\t}\n\n\treturn 0;\n}\n\n#ifdef CONFIG_X86_AMD_PLATFORM_DEVICE\n\nstatic int fch_misc_setup(struct apd_private_data *pdata)\n{\n\tstruct acpi_device *adev = pdata->adev;\n\tconst union acpi_object *obj;\n\tstruct platform_device *clkdev;\n\tstruct fch_clk_data *clk_data;\n\tstruct resource_entry *rentry;\n\tstruct list_head resource_list;\n\tint ret;\n\n\tclk_data = devm_kzalloc(&adev->dev, sizeof(*clk_data), GFP_KERNEL);\n\tif (!clk_data)\n\t\treturn -ENOMEM;\n\n\tINIT_LIST_HEAD(&resource_list);\n\tret = acpi_dev_get_memory_resources(adev, &resource_list);\n\tif (ret < 0)\n\t\treturn -ENOENT;\n\n\tif (!acpi_dev_get_property(adev, \"clk-name\", ACPI_TYPE_STRING, &obj)) {\n\t\tclk_data->name = devm_kzalloc(&adev->dev, obj->string.length,\n\t\t\t\t\t      GFP_KERNEL);\n\t\tif (!clk_data->name)\n\t\t\treturn -ENOMEM;\n\n\t\tstrcpy(clk_data->name, obj->string.pointer);\n\t} else {\n\t\t \n\t\tclk_data->name = \"mclk\";\n\t}\n\n\tlist_for_each_entry(rentry, &resource_list, node) {\n\t\tclk_data->base = devm_ioremap(&adev->dev, rentry->res->start,\n\t\t\t\t\t      resource_size(rentry->res));\n\t\tbreak;\n\t}\n\tif (!clk_data->base)\n\t\treturn -ENOMEM;\n\n\tacpi_dev_free_resource_list(&resource_list);\n\n\tclkdev = platform_device_register_data(&adev->dev, \"clk-fch\",\n\t\t\t\t\t       PLATFORM_DEVID_NONE, clk_data,\n\t\t\t\t\t       sizeof(*clk_data));\n\treturn PTR_ERR_OR_ZERO(clkdev);\n}\n\nstatic const struct apd_device_desc cz_i2c_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 133000000,\n};\n\nstatic const struct apd_device_desc wt_i2c_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 150000000,\n};\n\nstatic struct property_entry uart_properties[] = {\n\tPROPERTY_ENTRY_U32(\"reg-io-width\", 4),\n\tPROPERTY_ENTRY_U32(\"reg-shift\", 2),\n\tPROPERTY_ENTRY_BOOL(\"snps,uart-16550-compatible\"),\n\t{ },\n};\n\nstatic const struct apd_device_desc cz_uart_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 48000000,\n\t.properties = uart_properties,\n};\n\nstatic const struct apd_device_desc fch_misc_desc = {\n\t.setup = fch_misc_setup,\n};\n#endif  \n\n#ifdef CONFIG_ARM64\nstatic const struct apd_device_desc xgene_i2c_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 100000000,\n};\n\nstatic const struct apd_device_desc vulcan_spi_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 133000000,\n};\n\nstatic const struct apd_device_desc hip07_i2c_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 200000000,\n};\n\nstatic const struct apd_device_desc hip08_i2c_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 250000000,\n};\n\nstatic const struct apd_device_desc hip08_lite_i2c_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 125000000,\n};\n\nstatic const struct apd_device_desc thunderx2_i2c_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 125000000,\n};\n\nstatic const struct apd_device_desc nxp_i2c_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 350000000,\n};\n\nstatic const struct apd_device_desc hip08_spi_desc = {\n\t.setup = acpi_apd_setup,\n\t.fixed_clk_rate = 250000000,\n};\n#endif  \n\n#endif\n\n \nstatic int acpi_apd_create_device(struct acpi_device *adev,\n\t\t\t\t   const struct acpi_device_id *id)\n{\n\tconst struct apd_device_desc *dev_desc = (void *)id->driver_data;\n\tstruct apd_private_data *pdata;\n\tstruct platform_device *pdev;\n\tint ret;\n\n\tif (!dev_desc) {\n\t\tpdev = acpi_create_platform_device(adev, NULL);\n\t\treturn IS_ERR_OR_NULL(pdev) ? PTR_ERR(pdev) : 1;\n\t}\n\n\tpdata = kzalloc(sizeof(*pdata), GFP_KERNEL);\n\tif (!pdata)\n\t\treturn -ENOMEM;\n\n\tpdata->adev = adev;\n\tpdata->dev_desc = dev_desc;\n\n\tif (dev_desc->setup) {\n\t\tret = dev_desc->setup(pdata);\n\t\tif (ret)\n\t\t\tgoto err_out;\n\t}\n\n\tadev->driver_data = pdata;\n\tpdev = acpi_create_platform_device(adev, dev_desc->properties);\n\tif (!IS_ERR_OR_NULL(pdev))\n\t\treturn 1;\n\n\tret = PTR_ERR(pdev);\n\tadev->driver_data = NULL;\n\n err_out:\n\tkfree(pdata);\n\treturn ret;\n}\n\nstatic const struct acpi_device_id acpi_apd_device_ids[] = {\n\t \n#ifdef CONFIG_X86_AMD_PLATFORM_DEVICE\n\t{ \"AMD0010\", APD_ADDR(cz_i2c_desc) },\n\t{ \"AMD0020\", APD_ADDR(cz_uart_desc) },\n\t{ \"AMD0030\", },\n\t{ \"AMD0040\", APD_ADDR(fch_misc_desc)},\n\t{ \"AMDI0010\", APD_ADDR(wt_i2c_desc) },\n\t{ \"AMDI0019\", APD_ADDR(wt_i2c_desc) },\n\t{ \"AMDI0020\", APD_ADDR(cz_uart_desc) },\n\t{ \"AMDI0022\", APD_ADDR(cz_uart_desc) },\n\t{ \"HYGO0010\", APD_ADDR(wt_i2c_desc) },\n#endif\n#ifdef CONFIG_ARM64\n\t{ \"APMC0D0F\", APD_ADDR(xgene_i2c_desc) },\n\t{ \"BRCM900D\", APD_ADDR(vulcan_spi_desc) },\n\t{ \"CAV900D\",  APD_ADDR(vulcan_spi_desc) },\n\t{ \"CAV9007\",  APD_ADDR(thunderx2_i2c_desc) },\n\t{ \"HISI02A1\", APD_ADDR(hip07_i2c_desc) },\n\t{ \"HISI02A2\", APD_ADDR(hip08_i2c_desc) },\n\t{ \"HISI02A3\", APD_ADDR(hip08_lite_i2c_desc) },\n\t{ \"HISI0173\", APD_ADDR(hip08_spi_desc) },\n\t{ \"NXP0001\", APD_ADDR(nxp_i2c_desc) },\n#endif\n\t{ }\n};\n\nstatic struct acpi_scan_handler apd_handler = {\n\t.ids = acpi_apd_device_ids,\n\t.attach = acpi_apd_create_device,\n};\n\nvoid __init acpi_apd_init(void)\n{\n\tacpi_scan_add_handler(&apd_handler);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}