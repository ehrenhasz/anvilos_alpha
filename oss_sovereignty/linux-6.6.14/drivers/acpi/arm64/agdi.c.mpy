{
  "module_name": "agdi.c",
  "hash_id": "f381665a5d39d2089a22bc2af95be99c5ef9128036682eacb4e2d160ee65ee15",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/arm64/agdi.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) \"ACPI: AGDI: \" fmt\n\n#include <linux/acpi.h>\n#include <linux/arm_sdei.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include \"init.h\"\n\nstruct agdi_data {\n\tint sdei_event;\n};\n\nstatic int agdi_sdei_handler(u32 sdei_event, struct pt_regs *regs, void *arg)\n{\n\tnmi_panic(regs, \"Arm Generic Diagnostic Dump and Reset SDEI event issued\");\n\treturn 0;\n}\n\nstatic int agdi_sdei_probe(struct platform_device *pdev,\n\t\t\t   struct agdi_data *adata)\n{\n\tint err;\n\n\terr = sdei_event_register(adata->sdei_event, agdi_sdei_handler, pdev);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to register for SDEI event %d\",\n\t\t\tadata->sdei_event);\n\t\treturn err;\n\t}\n\n\terr = sdei_event_enable(adata->sdei_event);\n\tif (err)  {\n\t\tsdei_event_unregister(adata->sdei_event);\n\t\tdev_err(&pdev->dev, \"Failed to enable event %d\\n\",\n\t\t\tadata->sdei_event);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int agdi_probe(struct platform_device *pdev)\n{\n\tstruct agdi_data *adata = dev_get_platdata(&pdev->dev);\n\n\tif (!adata)\n\t\treturn -EINVAL;\n\n\treturn agdi_sdei_probe(pdev, adata);\n}\n\nstatic int agdi_remove(struct platform_device *pdev)\n{\n\tstruct agdi_data *adata = dev_get_platdata(&pdev->dev);\n\tint err, i;\n\n\terr = sdei_event_disable(adata->sdei_event);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to disable sdei-event #%d (%pe)\\n\",\n\t\t\tadata->sdei_event, ERR_PTR(err));\n\t\treturn 0;\n\t}\n\n\tfor (i = 0; i < 3; i++) {\n\t\terr = sdei_event_unregister(adata->sdei_event);\n\t\tif (err != -EINPROGRESS)\n\t\t\tbreak;\n\n\t\tschedule();\n\t}\n\n\tif (err)\n\t\tdev_err(&pdev->dev, \"Failed to unregister sdei-event #%d (%pe)\\n\",\n\t\t\tadata->sdei_event, ERR_PTR(err));\n\n\treturn 0;\n}\n\nstatic struct platform_driver agdi_driver = {\n\t.driver = {\n\t\t.name = \"agdi\",\n\t},\n\t.probe = agdi_probe,\n\t.remove = agdi_remove,\n};\n\nvoid __init acpi_agdi_init(void)\n{\n\tstruct acpi_table_agdi *agdi_table;\n\tstruct agdi_data pdata;\n\tstruct platform_device *pdev;\n\tacpi_status status;\n\n\tstatus = acpi_get_table(ACPI_SIG_AGDI, 0,\n\t\t\t\t(struct acpi_table_header **) &agdi_table);\n\tif (ACPI_FAILURE(status))\n\t\treturn;\n\n\tif (agdi_table->flags & ACPI_AGDI_SIGNALING_MODE) {\n\t\tpr_warn(\"Interrupt signaling is not supported\");\n\t\tgoto err_put_table;\n\t}\n\n\tpdata.sdei_event = agdi_table->sdei_event;\n\n\tpdev = platform_device_register_data(NULL, \"agdi\", 0, &pdata, sizeof(pdata));\n\tif (IS_ERR(pdev))\n\t\tgoto err_put_table;\n\n\tif (platform_driver_register(&agdi_driver))\n\t\tplatform_device_unregister(pdev);\n\nerr_put_table:\n\tacpi_put_table((struct acpi_table_header *)agdi_table);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}