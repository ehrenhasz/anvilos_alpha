{
  "module_name": "fan_attr.c",
  "hash_id": "5ca4473e2128fb683adf100e3af9e0c9a34f56c81344b217b38b0bef1c47027a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/acpi/fan_attr.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/acpi.h>\n\n#include \"fan.h\"\n\nMODULE_LICENSE(\"GPL\");\n\nstatic ssize_t show_state(struct device *dev, struct device_attribute *attr, char *buf)\n{\n\tstruct acpi_fan_fps *fps = container_of(attr, struct acpi_fan_fps, dev_attr);\n\tint count;\n\n\tif (fps->control == 0xFFFFFFFF || fps->control > 100)\n\t\tcount = scnprintf(buf, PAGE_SIZE, \"not-defined:\");\n\telse\n\t\tcount = scnprintf(buf, PAGE_SIZE, \"%lld:\", fps->control);\n\n\tif (fps->trip_point == 0xFFFFFFFF || fps->trip_point > 9)\n\t\tcount += sysfs_emit_at(buf, count, \"not-defined:\");\n\telse\n\t\tcount += sysfs_emit_at(buf, count, \"%lld:\", fps->trip_point);\n\n\tif (fps->speed == 0xFFFFFFFF)\n\t\tcount += sysfs_emit_at(buf, count, \"not-defined:\");\n\telse\n\t\tcount += sysfs_emit_at(buf, count, \"%lld:\", fps->speed);\n\n\tif (fps->noise_level == 0xFFFFFFFF)\n\t\tcount += sysfs_emit_at(buf, count, \"not-defined:\");\n\telse\n\t\tcount += sysfs_emit_at(buf, count, \"%lld:\", fps->noise_level * 100);\n\n\tif (fps->power == 0xFFFFFFFF)\n\t\tcount += sysfs_emit_at(buf, count, \"not-defined\\n\");\n\telse\n\t\tcount += sysfs_emit_at(buf, count, \"%lld\\n\", fps->power);\n\n\treturn count;\n}\n\nstatic ssize_t show_fan_speed(struct device *dev, struct device_attribute *attr, char *buf)\n{\n\tstruct acpi_device *acpi_dev = container_of(dev, struct acpi_device, dev);\n\tstruct acpi_fan_fst fst;\n\tint status;\n\n\tstatus = acpi_fan_get_fst(acpi_dev, &fst);\n\tif (status)\n\t\treturn status;\n\n\treturn sprintf(buf, \"%lld\\n\", fst.speed);\n}\n\nstatic ssize_t show_fine_grain_control(struct device *dev, struct device_attribute *attr, char *buf)\n{\n\tstruct acpi_device *acpi_dev = container_of(dev, struct acpi_device, dev);\n\tstruct acpi_fan *fan = acpi_driver_data(acpi_dev);\n\n\treturn sprintf(buf, \"%d\\n\", fan->fif.fine_grain_ctrl);\n}\n\nint acpi_fan_create_attributes(struct acpi_device *device)\n{\n\tstruct acpi_fan *fan = acpi_driver_data(device);\n\tint i, status;\n\n\tsysfs_attr_init(&fan->fine_grain_control.attr);\n\tfan->fine_grain_control.show = show_fine_grain_control;\n\tfan->fine_grain_control.store = NULL;\n\tfan->fine_grain_control.attr.name = \"fine_grain_control\";\n\tfan->fine_grain_control.attr.mode = 0444;\n\tstatus = sysfs_create_file(&device->dev.kobj, &fan->fine_grain_control.attr);\n\tif (status)\n\t\treturn status;\n\n\t \n\tsysfs_attr_init(&fan->fst_speed.attr);\n\tfan->fst_speed.show = show_fan_speed;\n\tfan->fst_speed.store = NULL;\n\tfan->fst_speed.attr.name = \"fan_speed_rpm\";\n\tfan->fst_speed.attr.mode = 0444;\n\tstatus = sysfs_create_file(&device->dev.kobj, &fan->fst_speed.attr);\n\tif (status)\n\t\tgoto rem_fine_grain_attr;\n\n\tfor (i = 0; i < fan->fps_count; ++i) {\n\t\tstruct acpi_fan_fps *fps = &fan->fps[i];\n\n\t\tsnprintf(fps->name, ACPI_FPS_NAME_LEN, \"state%d\", i);\n\t\tsysfs_attr_init(&fps->dev_attr.attr);\n\t\tfps->dev_attr.show = show_state;\n\t\tfps->dev_attr.store = NULL;\n\t\tfps->dev_attr.attr.name = fps->name;\n\t\tfps->dev_attr.attr.mode = 0444;\n\t\tstatus = sysfs_create_file(&device->dev.kobj, &fps->dev_attr.attr);\n\t\tif (status) {\n\t\t\tint j;\n\n\t\t\tfor (j = 0; j < i; ++j)\n\t\t\t\tsysfs_remove_file(&device->dev.kobj, &fan->fps[j].dev_attr.attr);\n\t\t\tgoto rem_fst_attr;\n\t\t}\n\t}\n\n\treturn 0;\n\nrem_fst_attr:\n\tsysfs_remove_file(&device->dev.kobj, &fan->fst_speed.attr);\n\nrem_fine_grain_attr:\n\tsysfs_remove_file(&device->dev.kobj, &fan->fine_grain_control.attr);\n\n\treturn status;\n}\n\nvoid acpi_fan_delete_attributes(struct acpi_device *device)\n{\n\tstruct acpi_fan *fan = acpi_driver_data(device);\n\tint i;\n\n\tfor (i = 0; i < fan->fps_count; ++i)\n\t\tsysfs_remove_file(&device->dev.kobj, &fan->fps[i].dev_attr.attr);\n\n\tsysfs_remove_file(&device->dev.kobj, &fan->fst_speed.attr);\n\tsysfs_remove_file(&device->dev.kobj, &fan->fine_grain_control.attr);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}