{
  "module_name": "rpmpd.c",
  "hash_id": "1504dd2d680370e6f0c94a2991211e47f01c131ef75e2d41b9b0a1b9e1f5d2bc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pmdomain/qcom/rpmpd.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/pm_domain.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/pm_opp.h>\n#include <linux/soc/qcom/smd-rpm.h>\n\n#include <dt-bindings/power/qcom-rpmpd.h>\n\n#define domain_to_rpmpd(domain) container_of(domain, struct rpmpd, pd)\n\n \n#define RPMPD_SMPA 0x61706d73\n#define RPMPD_LDOA 0x616f646c\n#define RPMPD_SMPB 0x62706d73\n#define RPMPD_LDOB 0x626f646c\n#define RPMPD_RWCX 0x78637772\n#define RPMPD_RWMX 0x786d7772\n#define RPMPD_RWLC 0x636c7772\n#define RPMPD_RWLM 0x6d6c7772\n#define RPMPD_RWSC 0x63737772\n#define RPMPD_RWSM 0x6d737772\n#define RPMPD_RWGX 0x78677772\n\n \n#define KEY_CORNER\t\t0x6e726f63  \n#define KEY_ENABLE\t\t0x6e657773  \n#define KEY_FLOOR_CORNER\t0x636676    \n#define KEY_FLOOR_LEVEL\t\t0x6c6676    \n#define KEY_LEVEL\t\t0x6c766c76  \n\n#define MAX_CORNER_RPMPD_STATE\t6\n\nstruct rpmpd_req {\n\t__le32 key;\n\t__le32 nbytes;\n\t__le32 value;\n};\n\nstruct rpmpd {\n\tstruct generic_pm_domain pd;\n\tstruct generic_pm_domain *parent;\n\tstruct rpmpd *peer;\n\tconst bool active_only;\n\tunsigned int corner;\n\tbool enabled;\n\tconst int res_type;\n\tconst int res_id;\n\tstruct qcom_smd_rpm *rpm;\n\tunsigned int max_state;\n\t__le32 key;\n\tbool state_synced;\n};\n\nstruct rpmpd_desc {\n\tstruct rpmpd **rpmpds;\n\tsize_t num_pds;\n\tunsigned int max_state;\n};\n\nstatic DEFINE_MUTEX(rpmpd_lock);\n\n \nstatic struct rpmpd cx_rwcx0_lvl_ao;\nstatic struct rpmpd cx_rwcx0_lvl = {\n\t.pd = { .name = \"cx\", },\n\t.peer = &cx_rwcx0_lvl_ao,\n\t.res_type = RPMPD_RWCX,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd cx_rwcx0_lvl_ao = {\n\t.pd = { .name = \"cx_ao\", },\n\t.peer = &cx_rwcx0_lvl,\n\t.active_only = true,\n\t.res_type = RPMPD_RWCX,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd cx_s1a_corner_ao;\nstatic struct rpmpd cx_s1a_corner = {\n\t.pd = { .name = \"cx\", },\n\t.peer = &cx_s1a_corner_ao,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 1,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd cx_s1a_corner_ao = {\n\t.pd = { .name = \"cx_ao\", },\n\t.peer = &cx_s1a_corner,\n\t.active_only = true,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 1,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd cx_s2a_corner_ao;\nstatic struct rpmpd cx_s2a_corner = {\n\t.pd = { .name = \"cx\", },\n\t.peer = &cx_s2a_corner_ao,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 2,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd cx_s2a_corner_ao = {\n\t.pd = { .name = \"cx_ao\", },\n\t.peer = &cx_s2a_corner,\n\t.active_only = true,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 2,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd cx_s2a_lvl_ao;\nstatic struct rpmpd cx_s2a_lvl = {\n\t.pd = { .name = \"cx\", },\n\t.peer = &cx_s2a_lvl_ao,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 2,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd cx_s2a_lvl_ao = {\n\t.pd = { .name = \"cx_ao\", },\n\t.peer = &cx_s2a_lvl,\n\t.active_only = true,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 2,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd cx_s3a_lvl_ao;\nstatic struct rpmpd cx_s3a_lvl = {\n\t.pd = { .name = \"cx\", },\n\t.peer = &cx_s3a_lvl_ao,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 3,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd cx_s3a_lvl_ao = {\n\t.pd = { .name = \"cx_ao\", },\n\t.peer = &cx_s3a_lvl,\n\t.active_only = true,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 3,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd cx_rwcx0_vfl = {\n\t.pd = { .name = \"cx_vfl\", },\n\t.res_type = RPMPD_RWCX,\n\t.res_id = 0,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\nstatic struct rpmpd cx_rwsc2_vfl = {\n\t.pd = { .name = \"cx_vfl\", },\n\t.res_type = RPMPD_RWSC,\n\t.res_id = 2,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\nstatic struct rpmpd cx_s1a_vfc = {\n\t.pd = { .name = \"cx_vfc\", },\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 1,\n\t.key = KEY_FLOOR_CORNER,\n};\n\nstatic struct rpmpd cx_s2a_vfc = {\n\t.pd = { .name = \"cx_vfc\", },\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 2,\n\t.key = KEY_FLOOR_CORNER,\n};\n\nstatic struct rpmpd cx_s2a_vfl = {\n\t.pd = { .name = \"cx_vfl\", },\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 2,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\nstatic struct rpmpd cx_s3a_vfl = {\n\t.pd = { .name = \"cx_vfl\", },\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 3,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\n \nstatic struct rpmpd gfx_s2b_corner = {\n\t.pd = { .name = \"gfx\", },\n\t.res_type = RPMPD_SMPB,\n\t.res_id = 2,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd gfx_s2b_vfc = {\n\t.pd = { .name = \"gfx_vfc\", },\n\t.res_type = RPMPD_SMPB,\n\t.res_id = 2,\n\t.key = KEY_FLOOR_CORNER,\n};\n\nstatic struct rpmpd mx_rwmx0_lvl;\nstatic struct rpmpd gx_rwgx0_lvl_ao;\nstatic struct rpmpd gx_rwgx0_lvl = {\n\t.pd = { .name = \"gx\", },\n\t.peer = &gx_rwgx0_lvl_ao,\n\t.res_type = RPMPD_RWGX,\n\t.parent = &mx_rwmx0_lvl.pd,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd mx_rwmx0_lvl_ao;\nstatic struct rpmpd gx_rwgx0_lvl_ao = {\n\t.pd = { .name = \"gx_ao\", },\n\t.peer = &gx_rwgx0_lvl,\n\t.parent = &mx_rwmx0_lvl_ao.pd,\n\t.active_only = true,\n\t.res_type = RPMPD_RWGX,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\n \nstatic struct rpmpd mx_l3a_corner_ao;\nstatic struct rpmpd mx_l3a_corner = {\n\t.pd = { .name = \"mx\", },\n\t.peer = &mx_l3a_corner_ao,\n\t.res_type = RPMPD_LDOA,\n\t.res_id = 3,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd mx_l3a_corner_ao = {\n\t.pd = { .name = \"mx_ao\", },\n\t.peer = &mx_l3a_corner,\n\t.active_only = true,\n\t.res_type = RPMPD_LDOA,\n\t.res_id = 3,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd mx_l12a_lvl_ao;\nstatic struct rpmpd mx_l12a_lvl = {\n\t.pd = { .name = \"mx\", },\n\t.peer = &mx_l12a_lvl_ao,\n\t.res_type = RPMPD_LDOA,\n\t.res_id = 12,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd mx_l12a_lvl_ao = {\n\t.pd = { .name = \"mx_ao\", },\n\t.peer = &mx_l12a_lvl,\n\t.active_only = true,\n\t.res_type = RPMPD_LDOA,\n\t.res_id = 12,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd mx_s2a_corner_ao;\nstatic struct rpmpd mx_s2a_corner = {\n\t.pd = { .name = \"mx\", },\n\t.peer = &mx_s2a_corner_ao,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 2,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd mx_s2a_corner_ao = {\n\t.pd = { .name = \"mx_ao\", },\n\t.peer = &mx_s2a_corner,\n\t.active_only = true,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 2,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd mx_rwmx0_lvl_ao;\nstatic struct rpmpd mx_rwmx0_lvl = {\n\t.pd = { .name = \"mx\", },\n\t.peer = &mx_rwmx0_lvl_ao,\n\t.res_type = RPMPD_RWMX,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd mx_rwmx0_lvl_ao = {\n\t.pd = { .name = \"mx_ao\", },\n\t.peer = &mx_rwmx0_lvl,\n\t.active_only = true,\n\t.res_type = RPMPD_RWMX,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd mx_s6a_lvl_ao;\nstatic struct rpmpd mx_s6a_lvl = {\n\t.pd = { .name = \"mx\", },\n\t.peer = &mx_s6a_lvl_ao,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 6,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd mx_s6a_lvl_ao = {\n\t.pd = { .name = \"mx_ao\", },\n\t.peer = &mx_s6a_lvl,\n\t.active_only = true,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 6,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd mx_s7a_lvl_ao;\nstatic struct rpmpd mx_s7a_lvl = {\n\t.pd = { .name = \"mx\", },\n\t.peer = &mx_s7a_lvl_ao,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 7,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd mx_s7a_lvl_ao = {\n\t.pd = { .name = \"mx_ao\", },\n\t.peer = &mx_s7a_lvl,\n\t.active_only = true,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 7,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd mx_l12a_vfl = {\n\t.pd = { .name = \"mx_vfl\", },\n\t.res_type = RPMPD_LDOA,\n\t.res_id = 12,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\nstatic struct rpmpd mx_rwmx0_vfl = {\n\t.pd = { .name = \"mx_vfl\", },\n\t.res_type = RPMPD_RWMX,\n\t.res_id = 0,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\nstatic struct rpmpd mx_rwsm6_vfl = {\n\t.pd = { .name = \"mx_vfl\", },\n\t.res_type = RPMPD_RWSM,\n\t.res_id = 6,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\n \nstatic struct rpmpd md_s1a_corner_ao;\nstatic struct rpmpd md_s1a_corner = {\n\t.pd = { .name = \"md\", },\n\t.peer = &md_s1a_corner_ao,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 1,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd md_s1a_corner_ao = {\n\t.pd = { .name = \"md_ao\", },\n\t.peer = &md_s1a_corner,\n\t.active_only = true,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 1,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd md_s1a_lvl_ao;\nstatic struct rpmpd md_s1a_lvl = {\n\t.pd = { .name = \"md\", },\n\t.peer = &md_s1a_lvl_ao,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 1,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd md_s1a_lvl_ao = {\n\t.pd = { .name = \"md_ao\", },\n\t.peer = &md_s1a_lvl,\n\t.active_only = true,\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 1,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd md_s1a_vfc = {\n\t.pd = { .name = \"md_vfc\", },\n\t.res_type = RPMPD_SMPA,\n\t.res_id = 1,\n\t.key = KEY_FLOOR_CORNER,\n};\n\n \nstatic struct rpmpd lpi_cx_rwlc0_lvl = {\n\t.pd = { .name = \"lpi_cx\", },\n\t.res_type = RPMPD_RWLC,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd lpi_cx_rwlc0_vfl = {\n\t.pd = { .name = \"lpi_cx_vfl\", },\n\t.res_type = RPMPD_RWLC,\n\t.res_id = 0,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\n \nstatic struct rpmpd lpi_mx_rwlm0_lvl = {\n\t.pd = { .name = \"lpi_mx\", },\n\t.res_type = RPMPD_RWLM,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd lpi_mx_rwlm0_vfl = {\n\t.pd = { .name = \"lpi_mx_vfl\", },\n\t.res_type = RPMPD_RWLM,\n\t.res_id = 0,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\n \nstatic struct rpmpd ssc_cx_l26a_corner = {\n\t.pd = { .name = \"ssc_cx\", },\n\t.res_type = RPMPD_LDOA,\n\t.res_id = 26,\n\t.key = KEY_CORNER,\n};\n\nstatic struct rpmpd ssc_cx_rwlc0_lvl = {\n\t.pd = { .name = \"ssc_cx\", },\n\t.res_type = RPMPD_RWLC,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd ssc_cx_rwsc0_lvl = {\n\t.pd = { .name = \"ssc_cx\", },\n\t.res_type = RPMPD_RWSC,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd ssc_cx_l26a_vfc = {\n\t.pd = { .name = \"ssc_cx_vfc\", },\n\t.res_type = RPMPD_LDOA,\n\t.res_id = 26,\n\t.key = KEY_FLOOR_CORNER,\n};\n\nstatic struct rpmpd ssc_cx_rwlc0_vfl = {\n\t.pd = { .name = \"ssc_cx_vfl\", },\n\t.res_type = RPMPD_RWLC,\n\t.res_id = 0,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\nstatic struct rpmpd ssc_cx_rwsc0_vfl = {\n\t.pd = { .name = \"ssc_cx_vfl\", },\n\t.res_type = RPMPD_RWSC,\n\t.res_id = 0,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\n \nstatic struct rpmpd ssc_mx_rwlm0_lvl = {\n\t.pd = { .name = \"ssc_mx\", },\n\t.res_type = RPMPD_RWLM,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd ssc_mx_rwsm0_lvl = {\n\t.pd = { .name = \"ssc_mx\", },\n\t.res_type = RPMPD_RWSM,\n\t.res_id = 0,\n\t.key = KEY_LEVEL,\n};\n\nstatic struct rpmpd ssc_mx_rwlm0_vfl = {\n\t.pd = { .name = \"ssc_mx_vfl\", },\n\t.res_type = RPMPD_RWLM,\n\t.res_id = 0,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\nstatic struct rpmpd ssc_mx_rwsm0_vfl = {\n\t.pd = { .name = \"ssc_mx_vfl\", },\n\t.res_type = RPMPD_RWSM,\n\t.res_id = 0,\n\t.key = KEY_FLOOR_LEVEL,\n};\n\nstatic struct rpmpd *mdm9607_rpmpds[] = {\n\t[MDM9607_VDDCX] =\t&cx_s3a_lvl,\n\t[MDM9607_VDDCX_AO] =\t&cx_s3a_lvl_ao,\n\t[MDM9607_VDDCX_VFL] =\t&cx_s3a_vfl,\n\t[MDM9607_VDDMX] =\t&mx_l12a_lvl,\n\t[MDM9607_VDDMX_AO] =\t&mx_l12a_lvl_ao,\n\t[MDM9607_VDDMX_VFL] =\t&mx_l12a_vfl,\n};\n\nstatic const struct rpmpd_desc mdm9607_desc = {\n\t.rpmpds = mdm9607_rpmpds,\n\t.num_pds = ARRAY_SIZE(mdm9607_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_TURBO,\n};\n\nstatic struct rpmpd *msm8226_rpmpds[] = {\n\t[MSM8226_VDDCX] =\t&cx_s1a_corner,\n\t[MSM8226_VDDCX_AO] =\t&cx_s1a_corner_ao,\n\t[MSM8226_VDDCX_VFC] =\t&cx_s1a_vfc,\n};\n\nstatic const struct rpmpd_desc msm8226_desc = {\n\t.rpmpds = msm8226_rpmpds,\n\t.num_pds = ARRAY_SIZE(msm8226_rpmpds),\n\t.max_state = MAX_CORNER_RPMPD_STATE,\n};\n\nstatic struct rpmpd *msm8939_rpmpds[] = {\n\t[MSM8939_VDDMDCX] =\t&md_s1a_corner,\n\t[MSM8939_VDDMDCX_AO] =\t&md_s1a_corner_ao,\n\t[MSM8939_VDDMDCX_VFC] =\t&md_s1a_vfc,\n\t[MSM8939_VDDCX] =\t&cx_s2a_corner,\n\t[MSM8939_VDDCX_AO] =\t&cx_s2a_corner_ao,\n\t[MSM8939_VDDCX_VFC] =\t&cx_s2a_vfc,\n\t[MSM8939_VDDMX] =\t&mx_l3a_corner,\n\t[MSM8939_VDDMX_AO] =\t&mx_l3a_corner_ao,\n};\n\nstatic const struct rpmpd_desc msm8939_desc = {\n\t.rpmpds = msm8939_rpmpds,\n\t.num_pds = ARRAY_SIZE(msm8939_rpmpds),\n\t.max_state = MAX_CORNER_RPMPD_STATE,\n};\n\nstatic struct rpmpd *msm8916_rpmpds[] = {\n\t[MSM8916_VDDCX] =\t&cx_s1a_corner,\n\t[MSM8916_VDDCX_AO] =\t&cx_s1a_corner_ao,\n\t[MSM8916_VDDCX_VFC] =\t&cx_s1a_vfc,\n\t[MSM8916_VDDMX] =\t&mx_l3a_corner,\n\t[MSM8916_VDDMX_AO] =\t&mx_l3a_corner_ao,\n};\n\nstatic const struct rpmpd_desc msm8916_desc = {\n\t.rpmpds = msm8916_rpmpds,\n\t.num_pds = ARRAY_SIZE(msm8916_rpmpds),\n\t.max_state = MAX_CORNER_RPMPD_STATE,\n};\n\nstatic struct rpmpd *msm8953_rpmpds[] = {\n\t[MSM8953_VDDMD] =\t&md_s1a_lvl,\n\t[MSM8953_VDDMD_AO] =\t&md_s1a_lvl_ao,\n\t[MSM8953_VDDCX] =\t&cx_s2a_lvl,\n\t[MSM8953_VDDCX_AO] =\t&cx_s2a_lvl_ao,\n\t[MSM8953_VDDCX_VFL] =\t&cx_s2a_vfl,\n\t[MSM8953_VDDMX] =\t&mx_s7a_lvl,\n\t[MSM8953_VDDMX_AO] =\t&mx_s7a_lvl_ao,\n};\n\nstatic const struct rpmpd_desc msm8953_desc = {\n\t.rpmpds = msm8953_rpmpds,\n\t.num_pds = ARRAY_SIZE(msm8953_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_TURBO,\n};\n\nstatic struct rpmpd *msm8976_rpmpds[] = {\n\t[MSM8976_VDDCX] =\t&cx_s2a_lvl,\n\t[MSM8976_VDDCX_AO] =\t&cx_s2a_lvl_ao,\n\t[MSM8976_VDDCX_VFL] =\t&cx_rwsc2_vfl,\n\t[MSM8976_VDDMX] =\t&mx_s6a_lvl,\n\t[MSM8976_VDDMX_AO] =\t&mx_s6a_lvl_ao,\n\t[MSM8976_VDDMX_VFL] =\t&mx_rwsm6_vfl,\n};\n\nstatic const struct rpmpd_desc msm8976_desc = {\n\t.rpmpds = msm8976_rpmpds,\n\t.num_pds = ARRAY_SIZE(msm8976_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_TURBO_HIGH,\n};\n\nstatic struct rpmpd *msm8994_rpmpds[] = {\n\t[MSM8994_VDDCX] =\t&cx_s1a_corner,\n\t[MSM8994_VDDCX_AO] =\t&cx_s1a_corner_ao,\n\t[MSM8994_VDDCX_VFC] =\t&cx_s1a_vfc,\n\t[MSM8994_VDDMX] =\t&mx_s2a_corner,\n\t[MSM8994_VDDMX_AO] =\t&mx_s2a_corner_ao,\n\n\t \n\t[MSM8994_VDDGFX] =\t&gfx_s2b_corner,\n\t[MSM8994_VDDGFX_VFC] =\t&gfx_s2b_vfc,\n};\n\nstatic const struct rpmpd_desc msm8994_desc = {\n\t.rpmpds = msm8994_rpmpds,\n\t.num_pds = ARRAY_SIZE(msm8994_rpmpds),\n\t.max_state = MAX_CORNER_RPMPD_STATE,\n};\n\nstatic struct rpmpd *msm8996_rpmpds[] = {\n\t[MSM8996_VDDCX] =\t&cx_s1a_corner,\n\t[MSM8996_VDDCX_AO] =\t&cx_s1a_corner_ao,\n\t[MSM8996_VDDCX_VFC] =\t&cx_s1a_vfc,\n\t[MSM8996_VDDMX] =\t&mx_s2a_corner,\n\t[MSM8996_VDDMX_AO] =\t&mx_s2a_corner_ao,\n\t[MSM8996_VDDSSCX] =\t&ssc_cx_l26a_corner,\n\t[MSM8996_VDDSSCX_VFC] =\t&ssc_cx_l26a_vfc,\n};\n\nstatic const struct rpmpd_desc msm8996_desc = {\n\t.rpmpds = msm8996_rpmpds,\n\t.num_pds = ARRAY_SIZE(msm8996_rpmpds),\n\t.max_state = MAX_CORNER_RPMPD_STATE,\n};\n\nstatic struct rpmpd *msm8998_rpmpds[] = {\n\t[MSM8998_VDDCX] =\t&cx_rwcx0_lvl,\n\t[MSM8998_VDDCX_AO] =\t&cx_rwcx0_lvl_ao,\n\t[MSM8998_VDDCX_VFL] =\t&cx_rwcx0_vfl,\n\t[MSM8998_VDDMX] =\t&mx_rwmx0_lvl,\n\t[MSM8998_VDDMX_AO] =\t&mx_rwmx0_lvl_ao,\n\t[MSM8998_VDDMX_VFL] =\t&mx_rwmx0_vfl,\n\t[MSM8998_SSCCX] =\t&ssc_cx_rwsc0_lvl,\n\t[MSM8998_SSCCX_VFL] =\t&ssc_cx_rwsc0_vfl,\n\t[MSM8998_SSCMX] =\t&ssc_mx_rwsm0_lvl,\n\t[MSM8998_SSCMX_VFL] =\t&ssc_mx_rwsm0_vfl,\n};\n\nstatic const struct rpmpd_desc msm8998_desc = {\n\t.rpmpds = msm8998_rpmpds,\n\t.num_pds = ARRAY_SIZE(msm8998_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_BINNING,\n};\n\nstatic struct rpmpd *qcs404_rpmpds[] = {\n\t[QCS404_VDDMX] =\t&mx_rwmx0_lvl,\n\t[QCS404_VDDMX_AO] =\t&mx_rwmx0_lvl_ao,\n\t[QCS404_VDDMX_VFL] =\t&mx_rwmx0_vfl,\n\t[QCS404_LPICX] =\t&lpi_cx_rwlc0_lvl,\n\t[QCS404_LPICX_VFL] =\t&lpi_cx_rwlc0_vfl,\n\t[QCS404_LPIMX] =\t&lpi_mx_rwlm0_lvl,\n\t[QCS404_LPIMX_VFL] =\t&lpi_mx_rwlm0_vfl,\n};\n\nstatic const struct rpmpd_desc qcs404_desc = {\n\t.rpmpds = qcs404_rpmpds,\n\t.num_pds = ARRAY_SIZE(qcs404_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_BINNING,\n};\n\nstatic struct rpmpd *sdm660_rpmpds[] = {\n\t[SDM660_VDDCX] =\t&cx_rwcx0_lvl,\n\t[SDM660_VDDCX_AO] =\t&cx_rwcx0_lvl_ao,\n\t[SDM660_VDDCX_VFL] =\t&cx_rwcx0_vfl,\n\t[SDM660_VDDMX] =\t&mx_rwmx0_lvl,\n\t[SDM660_VDDMX_AO] =\t&mx_rwmx0_lvl_ao,\n\t[SDM660_VDDMX_VFL] =\t&mx_rwmx0_vfl,\n\t[SDM660_SSCCX] =\t&ssc_cx_rwlc0_lvl,\n\t[SDM660_SSCCX_VFL] =\t&ssc_cx_rwlc0_vfl,\n\t[SDM660_SSCMX] =\t&ssc_mx_rwlm0_lvl,\n\t[SDM660_SSCMX_VFL] =\t&ssc_mx_rwlm0_vfl,\n};\n\nstatic const struct rpmpd_desc sdm660_desc = {\n\t.rpmpds = sdm660_rpmpds,\n\t.num_pds = ARRAY_SIZE(sdm660_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_TURBO,\n};\n\nstatic struct rpmpd *sm6115_rpmpds[] = {\n\t[SM6115_VDDCX] =\t&cx_rwcx0_lvl,\n\t[SM6115_VDDCX_AO] =\t&cx_rwcx0_lvl_ao,\n\t[SM6115_VDDCX_VFL] =\t&cx_rwcx0_vfl,\n\t[SM6115_VDDMX] =\t&mx_rwmx0_lvl,\n\t[SM6115_VDDMX_AO] =\t&mx_rwmx0_lvl_ao,\n\t[SM6115_VDDMX_VFL] =\t&mx_rwmx0_vfl,\n\t[SM6115_VDD_LPI_CX] =\t&lpi_cx_rwlc0_lvl,\n\t[SM6115_VDD_LPI_MX] =\t&lpi_mx_rwlm0_lvl,\n};\n\nstatic const struct rpmpd_desc sm6115_desc = {\n\t.rpmpds = sm6115_rpmpds,\n\t.num_pds = ARRAY_SIZE(sm6115_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_TURBO_NO_CPR,\n};\n\nstatic struct rpmpd *sm6125_rpmpds[] = {\n\t[SM6125_VDDCX] =\t&cx_rwcx0_lvl,\n\t[SM6125_VDDCX_AO] =\t&cx_rwcx0_lvl_ao,\n\t[SM6125_VDDCX_VFL] =\t&cx_rwcx0_vfl,\n\t[SM6125_VDDMX] =\t&mx_rwmx0_lvl,\n\t[SM6125_VDDMX_AO] =\t&mx_rwmx0_lvl_ao,\n\t[SM6125_VDDMX_VFL] =\t&mx_rwmx0_vfl,\n};\n\nstatic const struct rpmpd_desc sm6125_desc = {\n\t.rpmpds = sm6125_rpmpds,\n\t.num_pds = ARRAY_SIZE(sm6125_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_BINNING,\n};\n\nstatic struct rpmpd *sm6375_rpmpds[] = {\n\t[SM6375_VDDCX] =\t&cx_rwcx0_lvl,\n\t[SM6375_VDDCX_AO] =\t&cx_rwcx0_lvl_ao,\n\t[SM6375_VDDCX_VFL] =\t&cx_rwcx0_vfl,\n\t[SM6375_VDDMX] =\t&mx_rwmx0_lvl,\n\t[SM6375_VDDMX_AO] =\t&mx_rwmx0_lvl_ao,\n\t[SM6375_VDDMX_VFL] =\t&mx_rwmx0_vfl,\n\t[SM6375_VDDGX] =\t&gx_rwgx0_lvl,\n\t[SM6375_VDDGX_AO] =\t&gx_rwgx0_lvl_ao,\n\t[SM6375_VDD_LPI_CX] =\t&lpi_cx_rwlc0_lvl,\n\t[SM6375_VDD_LPI_MX] =\t&lpi_mx_rwlm0_lvl,\n};\n\nstatic const struct rpmpd_desc sm6375_desc = {\n\t.rpmpds = sm6375_rpmpds,\n\t.num_pds = ARRAY_SIZE(sm6375_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_TURBO_NO_CPR,\n};\n\nstatic struct rpmpd *qcm2290_rpmpds[] = {\n\t[QCM2290_VDDCX] =\t&cx_rwcx0_lvl,\n\t[QCM2290_VDDCX_AO] =\t&cx_rwcx0_lvl_ao,\n\t[QCM2290_VDDCX_VFL] =\t&cx_rwcx0_vfl,\n\t[QCM2290_VDDMX] =\t&mx_rwmx0_lvl,\n\t[QCM2290_VDDMX_AO] =\t&mx_rwmx0_lvl_ao,\n\t[QCM2290_VDDMX_VFL] =\t&mx_rwmx0_vfl,\n\t[QCM2290_VDD_LPI_CX] =\t&lpi_cx_rwlc0_lvl,\n\t[QCM2290_VDD_LPI_MX] =\t&lpi_mx_rwlm0_lvl,\n};\n\nstatic const struct rpmpd_desc qcm2290_desc = {\n\t.rpmpds = qcm2290_rpmpds,\n\t.num_pds = ARRAY_SIZE(qcm2290_rpmpds),\n\t.max_state = RPM_SMD_LEVEL_TURBO_NO_CPR,\n};\n\nstatic const struct of_device_id rpmpd_match_table[] = {\n\t{ .compatible = \"qcom,mdm9607-rpmpd\", .data = &mdm9607_desc },\n\t{ .compatible = \"qcom,msm8226-rpmpd\", .data = &msm8226_desc },\n\t{ .compatible = \"qcom,msm8909-rpmpd\", .data = &msm8916_desc },\n\t{ .compatible = \"qcom,msm8916-rpmpd\", .data = &msm8916_desc },\n\t{ .compatible = \"qcom,msm8939-rpmpd\", .data = &msm8939_desc },\n\t{ .compatible = \"qcom,msm8953-rpmpd\", .data = &msm8953_desc },\n\t{ .compatible = \"qcom,msm8976-rpmpd\", .data = &msm8976_desc },\n\t{ .compatible = \"qcom,msm8994-rpmpd\", .data = &msm8994_desc },\n\t{ .compatible = \"qcom,msm8996-rpmpd\", .data = &msm8996_desc },\n\t{ .compatible = \"qcom,msm8998-rpmpd\", .data = &msm8998_desc },\n\t{ .compatible = \"qcom,qcm2290-rpmpd\", .data = &qcm2290_desc },\n\t{ .compatible = \"qcom,qcs404-rpmpd\", .data = &qcs404_desc },\n\t{ .compatible = \"qcom,sdm660-rpmpd\", .data = &sdm660_desc },\n\t{ .compatible = \"qcom,sm6115-rpmpd\", .data = &sm6115_desc },\n\t{ .compatible = \"qcom,sm6125-rpmpd\", .data = &sm6125_desc },\n\t{ .compatible = \"qcom,sm6375-rpmpd\", .data = &sm6375_desc },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, rpmpd_match_table);\n\nstatic int rpmpd_send_enable(struct rpmpd *pd, bool enable)\n{\n\tstruct rpmpd_req req = {\n\t\t.key = KEY_ENABLE,\n\t\t.nbytes = cpu_to_le32(sizeof(u32)),\n\t\t.value = cpu_to_le32(enable),\n\t};\n\n\treturn qcom_rpm_smd_write(pd->rpm, QCOM_SMD_RPM_ACTIVE_STATE,\n\t\t\t\t  pd->res_type, pd->res_id, &req, sizeof(req));\n}\n\nstatic int rpmpd_send_corner(struct rpmpd *pd, int state, unsigned int corner)\n{\n\tstruct rpmpd_req req = {\n\t\t.key = pd->key,\n\t\t.nbytes = cpu_to_le32(sizeof(u32)),\n\t\t.value = cpu_to_le32(corner),\n\t};\n\n\treturn qcom_rpm_smd_write(pd->rpm, state, pd->res_type, pd->res_id,\n\t\t\t\t  &req, sizeof(req));\n};\n\nstatic void to_active_sleep(struct rpmpd *pd, unsigned int corner,\n\t\t\t    unsigned int *active, unsigned int *sleep)\n{\n\t*active = corner;\n\n\tif (pd->active_only)\n\t\t*sleep = 0;\n\telse\n\t\t*sleep = *active;\n}\n\nstatic int rpmpd_aggregate_corner(struct rpmpd *pd)\n{\n\tint ret;\n\tstruct rpmpd *peer = pd->peer;\n\tunsigned int active_corner, sleep_corner;\n\tunsigned int this_active_corner = 0, this_sleep_corner = 0;\n\tunsigned int peer_active_corner = 0, peer_sleep_corner = 0;\n\n\t \n\tif (!pd->state_synced)\n\t\tthis_active_corner = this_sleep_corner = pd->max_state - 1;\n\telse\n\t\tto_active_sleep(pd, pd->corner, &this_active_corner, &this_sleep_corner);\n\n\tif (peer && peer->enabled)\n\t\tto_active_sleep(peer, peer->corner, &peer_active_corner,\n\t\t\t\t&peer_sleep_corner);\n\n\tactive_corner = max(this_active_corner, peer_active_corner);\n\n\tret = rpmpd_send_corner(pd, QCOM_SMD_RPM_ACTIVE_STATE, active_corner);\n\tif (ret)\n\t\treturn ret;\n\n\tsleep_corner = max(this_sleep_corner, peer_sleep_corner);\n\n\treturn rpmpd_send_corner(pd, QCOM_SMD_RPM_SLEEP_STATE, sleep_corner);\n}\n\nstatic int rpmpd_power_on(struct generic_pm_domain *domain)\n{\n\tint ret;\n\tstruct rpmpd *pd = domain_to_rpmpd(domain);\n\n\tmutex_lock(&rpmpd_lock);\n\n\tret = rpmpd_send_enable(pd, true);\n\tif (ret)\n\t\tgoto out;\n\n\tpd->enabled = true;\n\n\tif (pd->corner)\n\t\tret = rpmpd_aggregate_corner(pd);\n\nout:\n\tmutex_unlock(&rpmpd_lock);\n\n\treturn ret;\n}\n\nstatic int rpmpd_power_off(struct generic_pm_domain *domain)\n{\n\tint ret;\n\tstruct rpmpd *pd = domain_to_rpmpd(domain);\n\n\tmutex_lock(&rpmpd_lock);\n\n\tret = rpmpd_send_enable(pd, false);\n\tif (!ret)\n\t\tpd->enabled = false;\n\n\tmutex_unlock(&rpmpd_lock);\n\n\treturn ret;\n}\n\nstatic int rpmpd_set_performance(struct generic_pm_domain *domain,\n\t\t\t\t unsigned int state)\n{\n\tint ret = 0;\n\tstruct rpmpd *pd = domain_to_rpmpd(domain);\n\n\tif (state > pd->max_state)\n\t\tstate = pd->max_state;\n\n\tmutex_lock(&rpmpd_lock);\n\n\tpd->corner = state;\n\n\t \n\tif (!pd->enabled && pd->key != cpu_to_le32(KEY_FLOOR_CORNER) &&\n\t    pd->key != cpu_to_le32(KEY_FLOOR_LEVEL))\n\t\tgoto out;\n\n\tret = rpmpd_aggregate_corner(pd);\n\nout:\n\tmutex_unlock(&rpmpd_lock);\n\n\treturn ret;\n}\n\nstatic unsigned int rpmpd_get_performance(struct generic_pm_domain *genpd,\n\t\t\t\t\t  struct dev_pm_opp *opp)\n{\n\treturn dev_pm_opp_get_level(opp);\n}\n\nstatic int rpmpd_probe(struct platform_device *pdev)\n{\n\tint i;\n\tsize_t num;\n\tstruct genpd_onecell_data *data;\n\tstruct qcom_smd_rpm *rpm;\n\tstruct rpmpd **rpmpds;\n\tconst struct rpmpd_desc *desc;\n\n\trpm = dev_get_drvdata(pdev->dev.parent);\n\tif (!rpm) {\n\t\tdev_err(&pdev->dev, \"Unable to retrieve handle to RPM\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tdesc = of_device_get_match_data(&pdev->dev);\n\tif (!desc)\n\t\treturn -EINVAL;\n\n\trpmpds = desc->rpmpds;\n\tnum = desc->num_pds;\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdata->domains = devm_kcalloc(&pdev->dev, num, sizeof(*data->domains),\n\t\t\t\t     GFP_KERNEL);\n\tif (!data->domains)\n\t\treturn -ENOMEM;\n\n\tdata->num_domains = num;\n\n\tfor (i = 0; i < num; i++) {\n\t\tif (!rpmpds[i]) {\n\t\t\tdev_warn(&pdev->dev, \"rpmpds[] with empty entry at index=%d\\n\",\n\t\t\t\t i);\n\t\t\tcontinue;\n\t\t}\n\n\t\trpmpds[i]->rpm = rpm;\n\t\trpmpds[i]->max_state = desc->max_state;\n\t\trpmpds[i]->pd.power_off = rpmpd_power_off;\n\t\trpmpds[i]->pd.power_on = rpmpd_power_on;\n\t\trpmpds[i]->pd.set_performance_state = rpmpd_set_performance;\n\t\trpmpds[i]->pd.opp_to_performance_state = rpmpd_get_performance;\n\t\tpm_genpd_init(&rpmpds[i]->pd, NULL, true);\n\n\t\tdata->domains[i] = &rpmpds[i]->pd;\n\t}\n\n\t \n\tfor (i = 0; i < num; i++) {\n\t\tif (!rpmpds[i])\n\t\t\tcontinue;\n\n\t\tif (rpmpds[i]->parent)\n\t\t\tpm_genpd_add_subdomain(rpmpds[i]->parent, &rpmpds[i]->pd);\n\t}\n\n\treturn of_genpd_add_provider_onecell(pdev->dev.of_node, data);\n}\n\nstatic void rpmpd_sync_state(struct device *dev)\n{\n\tconst struct rpmpd_desc *desc = of_device_get_match_data(dev);\n\tstruct rpmpd **rpmpds = desc->rpmpds;\n\tstruct rpmpd *pd;\n\tunsigned int i;\n\tint ret;\n\n\tmutex_lock(&rpmpd_lock);\n\tfor (i = 0; i < desc->num_pds; i++) {\n\t\tpd = rpmpds[i];\n\t\tif (!pd)\n\t\t\tcontinue;\n\n\t\tpd->state_synced = true;\n\n\t\tif (!pd->enabled)\n\t\t\tpd->corner = 0;\n\n\t\tret = rpmpd_aggregate_corner(pd);\n\t\tif (ret)\n\t\t\tdev_err(dev, \"failed to sync %s: %d\\n\", pd->pd.name, ret);\n\t}\n\tmutex_unlock(&rpmpd_lock);\n}\n\nstatic struct platform_driver rpmpd_driver = {\n\t.driver = {\n\t\t.name = \"qcom-rpmpd\",\n\t\t.of_match_table = rpmpd_match_table,\n\t\t.suppress_bind_attrs = true,\n\t\t.sync_state = rpmpd_sync_state,\n\t},\n\t.probe = rpmpd_probe,\n};\n\nstatic int __init rpmpd_init(void)\n{\n\treturn platform_driver_register(&rpmpd_driver);\n}\ncore_initcall(rpmpd_init);\n\nMODULE_DESCRIPTION(\"Qualcomm Technologies, Inc. RPM Power Domain Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}