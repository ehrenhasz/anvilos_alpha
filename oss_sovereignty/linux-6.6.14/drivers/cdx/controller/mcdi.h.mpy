{
  "module_name": "mcdi.h",
  "hash_id": "b810b4bbfad78c85681298ccee8eba86433efb68d922982f6fd5e175f7ecd17e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cdx/controller/mcdi.h",
  "human_readable_source": " \n\n#ifndef CDX_MCDI_H\n#define CDX_MCDI_H\n\n#include <linux/mutex.h>\n#include <linux/kref.h>\n#include <linux/rpmsg.h>\n\n#include \"bitfield.h\"\n#include \"mc_cdx_pcol.h\"\n\n#ifdef DEBUG\n#define CDX_WARN_ON_ONCE_PARANOID(x) WARN_ON_ONCE(x)\n#define CDX_WARN_ON_PARANOID(x) WARN_ON(x)\n#else\n#define CDX_WARN_ON_ONCE_PARANOID(x) do {} while (0)\n#define CDX_WARN_ON_PARANOID(x) do {} while (0)\n#endif\n\n \nenum cdx_mcdi_mode {\n\tMCDI_MODE_EVENTS,\n\tMCDI_MODE_FAIL,\n};\n\n#define MCDI_RPC_TIMEOUT\t(10 * HZ)\n#define MCDI_RPC_LONG_TIMEOU\t(60 * HZ)\n#define MCDI_RPC_POST_RST_TIME\t(10 * HZ)\n\n#define MCDI_BUF_LEN (8 + MCDI_CTL_SDU_LEN_MAX)\n\n \n\nenum cdx_mcdi_cmd_state {\n\tMCDI_STATE_QUEUED,\n\tMCDI_STATE_RETRY,\n\tMCDI_STATE_RUNNING,\n\tMCDI_STATE_RUNNING_CANCELLED,\n\tMCDI_STATE_FINISHED,\n};\n\n \nstruct cdx_mcdi {\n\t \n\tstruct cdx_mcdi_data *mcdi;\n\tconst struct cdx_mcdi_ops *mcdi_ops;\n\n\tstruct rproc *r5_rproc;\n\tstruct rpmsg_device *rpdev;\n\tstruct rpmsg_endpoint *ept;\n\tstruct work_struct work;\n};\n\nstruct cdx_mcdi_ops {\n\tvoid (*mcdi_request)(struct cdx_mcdi *cdx,\n\t\t\t     const struct cdx_dword *hdr, size_t hdr_len,\n\t\t\t     const struct cdx_dword *sdu, size_t sdu_len);\n\tunsigned int (*mcdi_rpc_timeout)(struct cdx_mcdi *cdx, unsigned int cmd);\n};\n\ntypedef void cdx_mcdi_async_completer(struct cdx_mcdi *cdx,\n\t\t\t\t      unsigned long cookie, int rc,\n\t\t\t\t      struct cdx_dword *outbuf,\n\t\t\t\t      size_t outlen_actual);\n\n \nstruct cdx_mcdi_cmd {\n\tstruct kref ref;\n\tstruct list_head list;\n\tstruct list_head cleanup_list;\n\tstruct work_struct work;\n\tstruct cdx_mcdi_iface *mcdi;\n\tenum cdx_mcdi_cmd_state state;\n\tsize_t inlen;\n\tconst struct cdx_dword *inbuf;\n\tbool quiet;\n\tbool reboot_seen;\n\tu8 seq;\n\tunsigned long started;\n\tunsigned long cookie;\n\tcdx_mcdi_async_completer *completer;\n\tunsigned int handle;\n\tunsigned int cmd;\n\tint rc;\n\tsize_t outlen;\n\tstruct cdx_dword *outbuf;\n\t \n};\n\n \nstruct cdx_mcdi_iface {\n\tstruct cdx_mcdi *cdx;\n\t \n\tstruct mutex iface_lock;\n\tunsigned int outstanding_cleanups;\n\tstruct list_head cmd_list;\n\tstruct workqueue_struct *workqueue;\n\twait_queue_head_t cmd_complete_wq;\n\tstruct cdx_mcdi_cmd *db_held_by;\n\tstruct cdx_mcdi_cmd *seq_held_by[16];\n\tunsigned int prev_handle;\n\tenum cdx_mcdi_mode mode;\n\tu8 prev_seq;\n\tbool new_epoch;\n};\n\n \nstruct cdx_mcdi_data {\n\tstruct cdx_mcdi_iface iface;\n\tu32 fn_flags;\n};\n\nstatic inline struct cdx_mcdi_iface *cdx_mcdi_if(struct cdx_mcdi *cdx)\n{\n\treturn cdx->mcdi ? &cdx->mcdi->iface : NULL;\n}\n\nint cdx_mcdi_init(struct cdx_mcdi *cdx);\nvoid cdx_mcdi_finish(struct cdx_mcdi *cdx);\n\nvoid cdx_mcdi_process_cmd(struct cdx_mcdi *cdx, struct cdx_dword *outbuf, int len);\nint cdx_mcdi_rpc(struct cdx_mcdi *cdx, unsigned int cmd,\n\t\t const struct cdx_dword *inbuf, size_t inlen,\n\t\t struct cdx_dword *outbuf, size_t outlen, size_t *outlen_actual);\nint cdx_mcdi_rpc_async(struct cdx_mcdi *cdx, unsigned int cmd,\n\t\t       const struct cdx_dword *inbuf, size_t inlen,\n\t\t       cdx_mcdi_async_completer *complete,\n\t\t       unsigned long cookie);\nint cdx_mcdi_wait_for_quiescence(struct cdx_mcdi *cdx,\n\t\t\t\t unsigned int timeout_jiffies);\n\n \n#define MCDI_DECLARE_BUF(_name, _len) struct cdx_dword _name[DIV_ROUND_UP(_len, 4)] = {{0}}\n#define _MCDI_PTR(_buf, _offset)\t\t\t\t\t\\\n\t((u8 *)(_buf) + (_offset))\n#define MCDI_PTR(_buf, _field)\t\t\t\t\t\t\\\n\t_MCDI_PTR(_buf, MC_CMD_ ## _field ## _OFST)\n#define _MCDI_CHECK_ALIGN(_ofst, _align)\t\t\t\t\\\n\t((void)BUILD_BUG_ON_ZERO((_ofst) & ((_align) - 1)),\t\t\\\n\t (_ofst))\n#define _MCDI_DWORD(_buf, _field)\t\t\t\t\t\\\n\t((_buf) + (_MCDI_CHECK_ALIGN(MC_CMD_ ## _field ## _OFST, 4) >> 2))\n\n#define MCDI_BYTE(_buf, _field)\t\t\t\t\t\t\\\n\t((void)BUILD_BUG_ON_ZERO(MC_CMD_ ## _field ## _LEN != 1),\t\\\n\t *MCDI_PTR(_buf, _field))\n#define MCDI_WORD(_buf, _field)\t\t\t\t\t\t\\\n\t((void)BUILD_BUG_ON_ZERO(MC_CMD_ ## _field ## _LEN != 2),\t\\\n\t le16_to_cpu(*(__force const __le16 *)MCDI_PTR(_buf, _field)))\n#define MCDI_SET_DWORD(_buf, _field, _value)\t\t\t\t\\\n\tCDX_POPULATE_DWORD_1(*_MCDI_DWORD(_buf, _field), CDX_DWORD, _value)\n#define MCDI_DWORD(_buf, _field)\t\t\t\t\t\\\n\tCDX_DWORD_FIELD(*_MCDI_DWORD(_buf, _field), CDX_DWORD)\n#define MCDI_POPULATE_DWORD_1(_buf, _field, _name1, _value1)\t\t\\\n\tCDX_POPULATE_DWORD_1(*_MCDI_DWORD(_buf, _field),\t\t\\\n\t\t\t     MC_CMD_ ## _name1, _value1)\n#define MCDI_SET_QWORD(_buf, _field, _value)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tCDX_POPULATE_DWORD_1(_MCDI_DWORD(_buf, _field)[0],\t\\\n\t\t\t\t     CDX_DWORD, (u32)(_value));\t\\\n\t\tCDX_POPULATE_DWORD_1(_MCDI_DWORD(_buf, _field)[1],\t\\\n\t\t\t\t     CDX_DWORD, (u64)(_value) >> 32);\t\\\n\t} while (0)\n#define MCDI_QWORD(_buf, _field)\t\t\t\t\t\\\n\t(CDX_DWORD_FIELD(_MCDI_DWORD(_buf, _field)[0], CDX_DWORD) |\t\\\n\t(u64)CDX_DWORD_FIELD(_MCDI_DWORD(_buf, _field)[1], CDX_DWORD) << 32)\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}