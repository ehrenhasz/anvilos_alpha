{
  "module_name": "ntb_hw_gen3.c",
  "hash_id": "0b09c16940eba84d7c7969982bf57db69aa4abbff5e3e2455d5b0365f83e580f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ntb/hw/intel/ntb_hw_gen3.c",
  "human_readable_source": " \n\n#include <linux/debugfs.h>\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/random.h>\n#include <linux/slab.h>\n#include <linux/ntb.h>\n\n#include \"ntb_hw_intel.h\"\n#include \"ntb_hw_gen1.h\"\n#include \"ntb_hw_gen3.h\"\n\nstatic int gen3_poll_link(struct intel_ntb_dev *ndev);\n\nstatic const struct intel_ntb_reg gen3_reg = {\n\t.poll_link\t\t= gen3_poll_link,\n\t.link_is_up\t\t= xeon_link_is_up,\n\t.db_ioread\t\t= gen3_db_ioread,\n\t.db_iowrite\t\t= gen3_db_iowrite,\n\t.db_size\t\t= sizeof(u32),\n\t.ntb_ctl\t\t= GEN3_NTBCNTL_OFFSET,\n\t.mw_bar\t\t\t= {2, 4},\n};\n\nstatic const struct intel_ntb_alt_reg gen3_pri_reg = {\n\t.db_bell\t\t= GEN3_EM_DOORBELL_OFFSET,\n\t.db_clear\t\t= GEN3_IM_INT_STATUS_OFFSET,\n\t.db_mask\t\t= GEN3_IM_INT_DISABLE_OFFSET,\n\t.spad\t\t\t= GEN3_IM_SPAD_OFFSET,\n};\n\nstatic const struct intel_ntb_alt_reg gen3_b2b_reg = {\n\t.db_bell\t\t= GEN3_IM_DOORBELL_OFFSET,\n\t.db_clear\t\t= GEN3_EM_INT_STATUS_OFFSET,\n\t.db_mask\t\t= GEN3_EM_INT_DISABLE_OFFSET,\n\t.spad\t\t\t= GEN3_B2B_SPAD_OFFSET,\n};\n\nstatic const struct intel_ntb_xlat_reg gen3_sec_xlat = {\n \n\t.bar2_limit\t\t= GEN3_IMBAR1XLMT_OFFSET,\n\t.bar2_xlat\t\t= GEN3_IMBAR1XBASE_OFFSET,\n};\n\nstatic int gen3_poll_link(struct intel_ntb_dev *ndev)\n{\n\tu16 reg_val;\n\tint rc;\n\n\tndev->reg->db_iowrite(ndev->db_link_mask,\n\t\t\t      ndev->self_mmio +\n\t\t\t      ndev->self_reg->db_clear);\n\n\trc = pci_read_config_word(ndev->ntb.pdev,\n\t\t\t\t  GEN3_LINK_STATUS_OFFSET, &reg_val);\n\tif (rc)\n\t\treturn 0;\n\n\tif (reg_val == ndev->lnk_sta)\n\t\treturn 0;\n\n\tndev->lnk_sta = reg_val;\n\n\treturn 1;\n}\n\nstatic int gen3_init_isr(struct intel_ntb_dev *ndev)\n{\n\tint i;\n\n\t \n\n\tfor (i = 0; i < GEN3_DB_MSIX_VECTOR_COUNT; i++)\n\t\tiowrite8(i, ndev->self_mmio + GEN3_INTVEC_OFFSET + i);\n\n\t \n\tif (ndev->hwerr_flags & NTB_HWERR_MSIX_VECTOR32_BAD) {\n\t\tiowrite8(GEN3_DB_MSIX_VECTOR_COUNT - 2,\n\t\t\t ndev->self_mmio + GEN3_INTVEC_OFFSET +\n\t\t\t (GEN3_DB_MSIX_VECTOR_COUNT - 1));\n\t}\n\n\treturn ndev_init_isr(ndev, GEN3_DB_MSIX_VECTOR_COUNT,\n\t\t\t     GEN3_DB_MSIX_VECTOR_COUNT,\n\t\t\t     GEN3_DB_MSIX_VECTOR_SHIFT,\n\t\t\t     GEN3_DB_TOTAL_SHIFT);\n}\n\nstatic int gen3_setup_b2b_mw(struct intel_ntb_dev *ndev,\n\t\t\t    const struct intel_b2b_addr *addr,\n\t\t\t    const struct intel_b2b_addr *peer_addr)\n{\n\tstruct pci_dev *pdev;\n\tvoid __iomem *mmio;\n\tphys_addr_t bar_addr;\n\n\tpdev = ndev->ntb.pdev;\n\tmmio = ndev->self_mmio;\n\n\t \n\tbar_addr = addr->bar2_addr64;\n\tiowrite64(bar_addr, mmio + GEN3_IMBAR1XLMT_OFFSET);\n\tbar_addr = ioread64(mmio + GEN3_IMBAR1XLMT_OFFSET);\n\tdev_dbg(&pdev->dev, \"IMBAR1XLMT %#018llx\\n\", bar_addr);\n\n\tbar_addr = addr->bar4_addr64;\n\tiowrite64(bar_addr, mmio + GEN3_IMBAR2XLMT_OFFSET);\n\tbar_addr = ioread64(mmio + GEN3_IMBAR2XLMT_OFFSET);\n\tdev_dbg(&pdev->dev, \"IMBAR2XLMT %#018llx\\n\", bar_addr);\n\n\t \n\tiowrite64(0, mmio + GEN3_IMBAR1XBASE_OFFSET);\n\tiowrite64(0, mmio + GEN3_IMBAR2XBASE_OFFSET);\n\n\tndev->peer_mmio = ndev->self_mmio;\n\n\treturn 0;\n}\n\nstatic int gen3_init_ntb(struct intel_ntb_dev *ndev)\n{\n\tint rc;\n\n\n\tndev->mw_count = XEON_MW_COUNT;\n\tndev->spad_count = GEN3_SPAD_COUNT;\n\tndev->db_count = GEN3_DB_COUNT;\n\tndev->db_link_mask = GEN3_DB_LINK_BIT;\n\n\t \n\tif (ndev->hwerr_flags & NTB_HWERR_MSIX_VECTOR32_BAD)\n\t\tndev->db_link_mask |= BIT_ULL(31);\n\n\tswitch (ndev->ntb.topo) {\n\tcase NTB_TOPO_B2B_USD:\n\tcase NTB_TOPO_B2B_DSD:\n\t\tndev->self_reg = &gen3_pri_reg;\n\t\tndev->peer_reg = &gen3_b2b_reg;\n\t\tndev->xlat_reg = &gen3_sec_xlat;\n\n\t\tif (ndev->ntb.topo == NTB_TOPO_B2B_USD) {\n\t\t\trc = gen3_setup_b2b_mw(ndev,\n\t\t\t\t\t      &xeon_b2b_dsd_addr,\n\t\t\t\t\t      &xeon_b2b_usd_addr);\n\t\t} else {\n\t\t\trc = gen3_setup_b2b_mw(ndev,\n\t\t\t\t\t      &xeon_b2b_usd_addr,\n\t\t\t\t\t      &xeon_b2b_dsd_addr);\n\t\t}\n\n\t\tif (rc)\n\t\t\treturn rc;\n\n\t\t \n\t\tiowrite16(PCI_COMMAND_MEMORY | PCI_COMMAND_MASTER,\n\t\t\t  ndev->self_mmio + GEN3_SPCICMD_OFFSET);\n\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tndev->db_valid_mask = BIT_ULL(ndev->db_count) - 1;\n\n\tndev->reg->db_iowrite(ndev->db_valid_mask,\n\t\t\t      ndev->self_mmio +\n\t\t\t      ndev->self_reg->db_mask);\n\n\treturn 0;\n}\n\nint gen3_init_dev(struct intel_ntb_dev *ndev)\n{\n\tstruct pci_dev *pdev;\n\tu8 ppd;\n\tint rc;\n\n\tpdev = ndev->ntb.pdev;\n\n\tndev->reg = &gen3_reg;\n\n\trc = pci_read_config_byte(pdev, XEON_PPD_OFFSET, &ppd);\n\tif (rc)\n\t\treturn -EIO;\n\n\tndev->ntb.topo = xeon_ppd_topo(ndev, ppd);\n\tdev_dbg(&pdev->dev, \"ppd %#x topo %s\\n\", ppd,\n\t\tntb_topo_string(ndev->ntb.topo));\n\tif (ndev->ntb.topo == NTB_TOPO_NONE)\n\t\treturn -EINVAL;\n\n\tndev->hwerr_flags |= NTB_HWERR_MSIX_VECTOR32_BAD;\n\n\trc = gen3_init_ntb(ndev);\n\tif (rc)\n\t\treturn rc;\n\n\treturn gen3_init_isr(ndev);\n}\n\nssize_t ndev_ntb3_debugfs_read(struct file *filp, char __user *ubuf,\n\t\t\t\t      size_t count, loff_t *offp)\n{\n\tstruct intel_ntb_dev *ndev;\n\tvoid __iomem *mmio;\n\tchar *buf;\n\tsize_t buf_size;\n\tssize_t ret, off;\n\tunion { u64 v64; u32 v32; u16 v16; } u;\n\n\tndev = filp->private_data;\n\tmmio = ndev->self_mmio;\n\n\tbuf_size = min(count, 0x800ul);\n\n\tbuf = kmalloc(buf_size, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\toff = 0;\n\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"NTB Device Information:\\n\");\n\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Connection Topology -\\t%s\\n\",\n\t\t\t ntb_topo_string(ndev->ntb.topo));\n\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"NTB CTL -\\t\\t%#06x\\n\", ndev->ntb_ctl);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"LNK STA -\\t\\t%#06x\\n\", ndev->lnk_sta);\n\n\tif (!ndev->reg->link_is_up(ndev))\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"Link Status -\\t\\tDown\\n\");\n\telse {\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"Link Status -\\t\\tUp\\n\");\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"Link Speed -\\t\\tPCI-E Gen %u\\n\",\n\t\t\t\t NTB_LNK_STA_SPEED(ndev->lnk_sta));\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"Link Width -\\t\\tx%u\\n\",\n\t\t\t\t NTB_LNK_STA_WIDTH(ndev->lnk_sta));\n\t}\n\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Memory Window Count -\\t%u\\n\", ndev->mw_count);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Scratchpad Count -\\t%u\\n\", ndev->spad_count);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Doorbell Count -\\t%u\\n\", ndev->db_count);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Doorbell Vector Count -\\t%u\\n\", ndev->db_vec_count);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Doorbell Vector Shift -\\t%u\\n\", ndev->db_vec_shift);\n\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Doorbell Valid Mask -\\t%#llx\\n\", ndev->db_valid_mask);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Doorbell Link Mask -\\t%#llx\\n\", ndev->db_link_mask);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Doorbell Mask Cached -\\t%#llx\\n\", ndev->db_mask);\n\n\tu.v64 = ndev_db_read(ndev, mmio + ndev->self_reg->db_mask);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Doorbell Mask -\\t\\t%#llx\\n\", u.v64);\n\n\tu.v64 = ndev_db_read(ndev, mmio + ndev->self_reg->db_bell);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Doorbell Bell -\\t\\t%#llx\\n\", u.v64);\n\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"\\nNTB Incoming XLAT:\\n\");\n\n\tu.v64 = ioread64(mmio + GEN3_IMBAR1XBASE_OFFSET);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"IMBAR1XBASE -\\t\\t%#018llx\\n\", u.v64);\n\n\tu.v64 = ioread64(mmio + GEN3_IMBAR2XBASE_OFFSET);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"IMBAR2XBASE -\\t\\t%#018llx\\n\", u.v64);\n\n\tu.v64 = ioread64(mmio + GEN3_IMBAR1XLMT_OFFSET);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"IMBAR1XLMT -\\t\\t\\t%#018llx\\n\", u.v64);\n\n\tu.v64 = ioread64(mmio + GEN3_IMBAR2XLMT_OFFSET);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"IMBAR2XLMT -\\t\\t\\t%#018llx\\n\", u.v64);\n\n\tif (ntb_topo_is_b2b(ndev->ntb.topo)) {\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"\\nNTB Outgoing B2B XLAT:\\n\");\n\n\t\tu.v64 = ioread64(mmio + GEN3_EMBAR1XBASE_OFFSET);\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"EMBAR1XBASE -\\t\\t%#018llx\\n\", u.v64);\n\n\t\tu.v64 = ioread64(mmio + GEN3_EMBAR2XBASE_OFFSET);\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"EMBAR2XBASE -\\t\\t%#018llx\\n\", u.v64);\n\n\t\tu.v64 = ioread64(mmio + GEN3_EMBAR1XLMT_OFFSET);\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"EMBAR1XLMT -\\t\\t%#018llx\\n\", u.v64);\n\n\t\tu.v64 = ioread64(mmio + GEN3_EMBAR2XLMT_OFFSET);\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"EMBAR2XLMT -\\t\\t%#018llx\\n\", u.v64);\n\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"\\nNTB Secondary BAR:\\n\");\n\n\t\tu.v64 = ioread64(mmio + GEN3_EMBAR0_OFFSET);\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"EMBAR0 -\\t\\t%#018llx\\n\", u.v64);\n\n\t\tu.v64 = ioread64(mmio + GEN3_EMBAR1_OFFSET);\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"EMBAR1 -\\t\\t%#018llx\\n\", u.v64);\n\n\t\tu.v64 = ioread64(mmio + GEN3_EMBAR2_OFFSET);\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"EMBAR2 -\\t\\t%#018llx\\n\", u.v64);\n\t}\n\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"\\nNTB Statistics:\\n\");\n\n\tu.v16 = ioread16(mmio + GEN3_USMEMMISS_OFFSET);\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"Upstream Memory Miss -\\t%u\\n\", u.v16);\n\n\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t \"\\nNTB Hardware Errors:\\n\");\n\n\tif (!pci_read_config_word(ndev->ntb.pdev,\n\t\t\t\t  GEN3_DEVSTS_OFFSET, &u.v16))\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"DEVSTS -\\t\\t%#06x\\n\", u.v16);\n\n\tif (!pci_read_config_word(ndev->ntb.pdev,\n\t\t\t\t  GEN3_LINK_STATUS_OFFSET, &u.v16))\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"LNKSTS -\\t\\t%#06x\\n\", u.v16);\n\n\tif (!pci_read_config_dword(ndev->ntb.pdev,\n\t\t\t\t   GEN3_UNCERRSTS_OFFSET, &u.v32))\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"UNCERRSTS -\\t\\t%#06x\\n\", u.v32);\n\n\tif (!pci_read_config_dword(ndev->ntb.pdev,\n\t\t\t\t   GEN3_CORERRSTS_OFFSET, &u.v32))\n\t\toff += scnprintf(buf + off, buf_size - off,\n\t\t\t\t \"CORERRSTS -\\t\\t%#06x\\n\", u.v32);\n\n\tret = simple_read_from_buffer(ubuf, count, offp, buf, off);\n\tkfree(buf);\n\treturn ret;\n}\n\nint intel_ntb3_link_enable(struct ntb_dev *ntb, enum ntb_speed max_speed,\n\t\tenum ntb_width max_width)\n{\n\tstruct intel_ntb_dev *ndev;\n\tu32 ntb_ctl;\n\n\tndev = container_of(ntb, struct intel_ntb_dev, ntb);\n\n\tdev_dbg(&ntb->pdev->dev,\n\t\t\"Enabling link with max_speed %d max_width %d\\n\",\n\t\tmax_speed, max_width);\n\n\tif (max_speed != NTB_SPEED_AUTO)\n\t\tdev_dbg(&ntb->pdev->dev, \"ignoring max_speed %d\\n\", max_speed);\n\tif (max_width != NTB_WIDTH_AUTO)\n\t\tdev_dbg(&ntb->pdev->dev, \"ignoring max_width %d\\n\", max_width);\n\n\tntb_ctl = ioread32(ndev->self_mmio + ndev->reg->ntb_ctl);\n\tntb_ctl &= ~(NTB_CTL_DISABLE | NTB_CTL_CFG_LOCK);\n\tntb_ctl |= NTB_CTL_P2S_BAR2_SNOOP | NTB_CTL_S2P_BAR2_SNOOP;\n\tntb_ctl |= NTB_CTL_P2S_BAR4_SNOOP | NTB_CTL_S2P_BAR4_SNOOP;\n\tiowrite32(ntb_ctl, ndev->self_mmio + ndev->reg->ntb_ctl);\n\n\treturn 0;\n}\nstatic int intel_ntb3_mw_set_trans(struct ntb_dev *ntb, int pidx, int idx,\n\t\t\t\t   dma_addr_t addr, resource_size_t size)\n{\n\tstruct intel_ntb_dev *ndev = ntb_ndev(ntb);\n\tunsigned long xlat_reg, limit_reg;\n\tresource_size_t bar_size, mw_size;\n\tvoid __iomem *mmio;\n\tu64 base, limit, reg_val;\n\tint bar;\n\n\tif (pidx != NTB_DEF_PEER_IDX)\n\t\treturn -EINVAL;\n\n\tif (idx >= ndev->b2b_idx && !ndev->b2b_off)\n\t\tidx += 1;\n\n\tbar = ndev_mw_to_bar(ndev, idx);\n\tif (bar < 0)\n\t\treturn bar;\n\n\tbar_size = pci_resource_len(ndev->ntb.pdev, bar);\n\n\tif (idx == ndev->b2b_idx)\n\t\tmw_size = bar_size - ndev->b2b_off;\n\telse\n\t\tmw_size = bar_size;\n\n\t \n\tif (addr & (bar_size - 1))\n\t\treturn -EINVAL;\n\n\t \n\tif (size > mw_size)\n\t\treturn -EINVAL;\n\n\tmmio = ndev->self_mmio;\n\txlat_reg = ndev->xlat_reg->bar2_xlat + (idx * 0x10);\n\tlimit_reg = ndev->xlat_reg->bar2_limit + (idx * 0x10);\n\tbase = pci_resource_start(ndev->ntb.pdev, bar);\n\n\t \n\tif (limit_reg && size != mw_size)\n\t\tlimit = base + size;\n\telse\n\t\tlimit = base + mw_size;\n\n\t \n\tiowrite64(addr, mmio + xlat_reg);\n\treg_val = ioread64(mmio + xlat_reg);\n\tif (reg_val != addr) {\n\t\tiowrite64(0, mmio + xlat_reg);\n\t\treturn -EIO;\n\t}\n\n\tdev_dbg(&ntb->pdev->dev, \"BAR %d IMBARXBASE: %#Lx\\n\", bar, reg_val);\n\n\t \n\tiowrite64(limit, mmio + limit_reg);\n\treg_val = ioread64(mmio + limit_reg);\n\tif (reg_val != limit) {\n\t\tiowrite64(base, mmio + limit_reg);\n\t\tiowrite64(0, mmio + xlat_reg);\n\t\treturn -EIO;\n\t}\n\n\tdev_dbg(&ntb->pdev->dev, \"BAR %d IMBARXLMT: %#Lx\\n\", bar, reg_val);\n\n\t \n\tlimit_reg = ndev->xlat_reg->bar2_limit + (idx * 0x10) + 0x4000;\n\tbase = ioread64(mmio + GEN3_EMBAR1_OFFSET + (8 * idx));\n\tbase &= ~0xf;\n\n\tif (limit_reg && size != mw_size)\n\t\tlimit = base + size;\n\telse\n\t\tlimit = base + mw_size;\n\n\t \n\tiowrite64(limit, mmio + limit_reg);\n\treg_val = ioread64(mmio + limit_reg);\n\tif (reg_val != limit) {\n\t\tiowrite64(base, mmio + limit_reg);\n\t\tiowrite64(0, mmio + xlat_reg);\n\t\treturn -EIO;\n\t}\n\n\tdev_dbg(&ntb->pdev->dev, \"BAR %d EMBARXLMT: %#Lx\\n\", bar, reg_val);\n\n\treturn 0;\n}\n\nint intel_ntb3_peer_db_addr(struct ntb_dev *ntb, phys_addr_t *db_addr,\n\t\t\t\t   resource_size_t *db_size,\n\t\t\t\t   u64 *db_data, int db_bit)\n{\n\tphys_addr_t db_addr_base;\n\tstruct intel_ntb_dev *ndev = ntb_ndev(ntb);\n\n\tif (unlikely(db_bit >= BITS_PER_LONG_LONG))\n\t\treturn -EINVAL;\n\n\tif (unlikely(BIT_ULL(db_bit) & ~ntb_ndev(ntb)->db_valid_mask))\n\t\treturn -EINVAL;\n\n\tndev_db_addr(ndev, &db_addr_base, db_size, ndev->peer_addr,\n\t\t\t\tndev->peer_reg->db_bell);\n\n\tif (db_addr) {\n\t\t*db_addr = db_addr_base + (db_bit * 4);\n\t\tdev_dbg(&ndev->ntb.pdev->dev, \"Peer db addr %llx db bit %d\\n\",\n\t\t\t\t*db_addr, db_bit);\n\t}\n\n\tif (db_data) {\n\t\t*db_data = 1;\n\t\tdev_dbg(&ndev->ntb.pdev->dev, \"Peer db data %llx db bit %d\\n\",\n\t\t\t\t*db_data, db_bit);\n\t}\n\n\treturn 0;\n}\n\nint intel_ntb3_peer_db_set(struct ntb_dev *ntb, u64 db_bits)\n{\n\tstruct intel_ntb_dev *ndev = ntb_ndev(ntb);\n\tint bit;\n\n\tif (db_bits & ~ndev->db_valid_mask)\n\t\treturn -EINVAL;\n\n\twhile (db_bits) {\n\t\tbit = __ffs(db_bits);\n\t\tiowrite32(1, ndev->peer_mmio +\n\t\t\t\tndev->peer_reg->db_bell + (bit * 4));\n\t\tdb_bits &= db_bits - 1;\n\t}\n\n\treturn 0;\n}\n\nu64 intel_ntb3_db_read(struct ntb_dev *ntb)\n{\n\tstruct intel_ntb_dev *ndev = ntb_ndev(ntb);\n\n\treturn ndev_db_read(ndev,\n\t\t\t    ndev->self_mmio +\n\t\t\t    ndev->self_reg->db_clear);\n}\n\nint intel_ntb3_db_clear(struct ntb_dev *ntb, u64 db_bits)\n{\n\tstruct intel_ntb_dev *ndev = ntb_ndev(ntb);\n\n\treturn ndev_db_write(ndev, db_bits,\n\t\t\t     ndev->self_mmio +\n\t\t\t     ndev->self_reg->db_clear);\n}\n\nconst struct ntb_dev_ops intel_ntb3_ops = {\n\t.mw_count\t\t= intel_ntb_mw_count,\n\t.mw_get_align\t\t= intel_ntb_mw_get_align,\n\t.mw_set_trans\t\t= intel_ntb3_mw_set_trans,\n\t.peer_mw_count\t\t= intel_ntb_peer_mw_count,\n\t.peer_mw_get_addr\t= intel_ntb_peer_mw_get_addr,\n\t.link_is_up\t\t= intel_ntb_link_is_up,\n\t.link_enable\t\t= intel_ntb3_link_enable,\n\t.link_disable\t\t= intel_ntb_link_disable,\n\t.db_valid_mask\t\t= intel_ntb_db_valid_mask,\n\t.db_vector_count\t= intel_ntb_db_vector_count,\n\t.db_vector_mask\t\t= intel_ntb_db_vector_mask,\n\t.db_read\t\t= intel_ntb3_db_read,\n\t.db_clear\t\t= intel_ntb3_db_clear,\n\t.db_set_mask\t\t= intel_ntb_db_set_mask,\n\t.db_clear_mask\t\t= intel_ntb_db_clear_mask,\n\t.peer_db_addr\t\t= intel_ntb3_peer_db_addr,\n\t.peer_db_set\t\t= intel_ntb3_peer_db_set,\n\t.spad_is_unsafe\t\t= intel_ntb_spad_is_unsafe,\n\t.spad_count\t\t= intel_ntb_spad_count,\n\t.spad_read\t\t= intel_ntb_spad_read,\n\t.spad_write\t\t= intel_ntb_spad_write,\n\t.peer_spad_addr\t\t= intel_ntb_peer_spad_addr,\n\t.peer_spad_read\t\t= intel_ntb_peer_spad_read,\n\t.peer_spad_write\t= intel_ntb_peer_spad_write,\n};\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}