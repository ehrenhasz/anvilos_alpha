{
  "module_name": "max77541-adc.c",
  "hash_id": "04ec46872914c751804dc004b13f548658ae13e6626b30273d0297687bf02190",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/adc/max77541-adc.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/iio/iio.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/units.h>\n\n#include <linux/mfd/max77541.h>\n\nenum max77541_adc_range {\n\tLOW_RANGE,\n\tMID_RANGE,\n\tHIGH_RANGE,\n};\n\nenum max77541_adc_channel {\n\tMAX77541_ADC_VSYS_V,\n\tMAX77541_ADC_VOUT1_V,\n\tMAX77541_ADC_VOUT2_V,\n\tMAX77541_ADC_TEMP,\n};\n\nstatic int max77541_adc_offset(struct iio_dev *indio_dev,\n\t\t\t       struct iio_chan_spec const *chan,\n\t\t\t       int *val, int *val2)\n{\n\tswitch (chan->channel) {\n\tcase MAX77541_ADC_TEMP:\n\t\t*val = DIV_ROUND_CLOSEST(ABSOLUTE_ZERO_MILLICELSIUS, 1725);\n\t\treturn IIO_VAL_INT;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int max77541_adc_scale(struct iio_dev *indio_dev,\n\t\t\t      struct iio_chan_spec const *chan,\n\t\t\t      int *val, int *val2)\n{\n\tstruct regmap **regmap = iio_priv(indio_dev);\n\tunsigned int reg_val;\n\tint ret;\n\n\tswitch (chan->channel) {\n\tcase MAX77541_ADC_VSYS_V:\n\t\t*val = 25;\n\t\treturn IIO_VAL_INT;\n\tcase MAX77541_ADC_VOUT1_V:\n\tcase MAX77541_ADC_VOUT2_V:\n\t\tret = regmap_read(*regmap, MAX77541_REG_M2_CFG1, &reg_val);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\treg_val = FIELD_GET(MAX77541_BITS_MX_CFG1_RNG, reg_val);\n\t\tswitch (reg_val) {\n\t\tcase LOW_RANGE:\n\t\t\t*val = 6;\n\t\t\t*val2 = 250000;\n\t\t\tbreak;\n\t\tcase MID_RANGE:\n\t\t\t*val = 12;\n\t\t\t*val2 = 500000;\n\t\t\tbreak;\n\t\tcase HIGH_RANGE:\n\t\t\t*val = 25;\n\t\t\treturn IIO_VAL_INT;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\treturn IIO_VAL_INT_PLUS_MICRO;\n\tcase MAX77541_ADC_TEMP:\n\t\t*val = 1725;\n\t\treturn IIO_VAL_INT;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int max77541_adc_raw(struct iio_dev *indio_dev,\n\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t    int *val)\n{\n\tstruct regmap **regmap = iio_priv(indio_dev);\n\tint ret;\n\n\tret = regmap_read(*regmap, chan->address, val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn IIO_VAL_INT;\n}\n\n#define MAX77541_ADC_CHANNEL_V(_channel, _name, _type, _reg) \\\n\t{\t\t\t\t\t\t\t\\\n\t\t.type = _type,\t\t\t\t\t\\\n\t\t.indexed = 1,\t\t\t\t\t\\\n\t\t.channel = _channel,\t\t\t\t\\\n\t\t.address = _reg,\t\t\t\t\\\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW) |\t\\\n\t\t\t\t      BIT(IIO_CHAN_INFO_SCALE), \\\n\t\t.datasheet_name = _name,\t\t\t\\\n\t}\n\n#define MAX77541_ADC_CHANNEL_TEMP(_channel, _name, _type, _reg) \\\n\t{\t\t\t\t\t\t\t\\\n\t\t.type = _type,\t\t\t\t\t\\\n\t\t.indexed = 1,\t\t\t\t\t\\\n\t\t.channel = _channel,\t\t\t\t\\\n\t\t.address = _reg,\t\t\t\t\\\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW) |\t\\\n\t\t\t\t      BIT(IIO_CHAN_INFO_SCALE) |\\\n\t\t\t\t      BIT(IIO_CHAN_INFO_OFFSET),\\\n\t\t.datasheet_name = _name,\t\t\t\\\n\t}\n\nstatic const struct iio_chan_spec max77541_adc_channels[] = {\n\tMAX77541_ADC_CHANNEL_V(MAX77541_ADC_VSYS_V, \"vsys_v\", IIO_VOLTAGE,\n\t\t\t       MAX77541_REG_ADC_DATA_CH1),\n\tMAX77541_ADC_CHANNEL_V(MAX77541_ADC_VOUT1_V, \"vout1_v\", IIO_VOLTAGE,\n\t\t\t       MAX77541_REG_ADC_DATA_CH2),\n\tMAX77541_ADC_CHANNEL_V(MAX77541_ADC_VOUT2_V, \"vout2_v\", IIO_VOLTAGE,\n\t\t\t       MAX77541_REG_ADC_DATA_CH3),\n\tMAX77541_ADC_CHANNEL_TEMP(MAX77541_ADC_TEMP, \"temp\", IIO_TEMP,\n\t\t\t\t  MAX77541_REG_ADC_DATA_CH6),\n};\n\nstatic int max77541_adc_read_raw(struct iio_dev *indio_dev,\n\t\t\t\t struct iio_chan_spec const *chan,\n\t\t\t\t int *val, int *val2, long mask)\n{\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_OFFSET:\n\t\treturn max77541_adc_offset(indio_dev, chan, val, val2);\n\tcase IIO_CHAN_INFO_SCALE:\n\t\treturn max77541_adc_scale(indio_dev, chan, val, val2);\n\tcase IIO_CHAN_INFO_RAW:\n\t\treturn max77541_adc_raw(indio_dev, chan, val);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic const struct iio_info max77541_adc_info = {\n\t.read_raw = max77541_adc_read_raw,\n};\n\nstatic int max77541_adc_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct iio_dev *indio_dev;\n\tstruct regmap **regmap;\n\n\tindio_dev = devm_iio_device_alloc(dev, sizeof(*regmap));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\tregmap = iio_priv(indio_dev);\n\n\t*regmap = dev_get_regmap(dev->parent, NULL);\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\n\tindio_dev->name = \"max77541\";\n\tindio_dev->info = &max77541_adc_info;\n\tindio_dev->channels = max77541_adc_channels;\n\tindio_dev->num_channels = ARRAY_SIZE(max77541_adc_channels);\n\n\treturn devm_iio_device_register(dev, indio_dev);\n}\n\nstatic const struct platform_device_id max77541_adc_platform_id[] = {\n\t{ \"max77541-adc\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(platform, max77541_adc_platform_id);\n\nstatic struct platform_driver max77541_adc_driver = {\n\t.driver = {\n\t\t.name = \"max77541-adc\",\n\t},\n\t.probe = max77541_adc_probe,\n\t.id_table = max77541_adc_platform_id,\n};\nmodule_platform_driver(max77541_adc_driver);\n\nMODULE_AUTHOR(\"Okan Sahin <Okan.Sahin@analog.com>\");\nMODULE_DESCRIPTION(\"MAX77541 ADC driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}