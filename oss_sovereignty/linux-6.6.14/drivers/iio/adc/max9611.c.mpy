{
  "module_name": "max9611.c",
  "hash_id": "a87d1a6b21d503745f8cd1f7000b3c2f6550db58ce3217d52d9892f6d274f7b9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/adc/max9611.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/delay.h>\n#include <linux/i2c.h>\n#include <linux/iio/iio.h>\n#include <linux/iio/sysfs.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/property.h>\n\n#define DRIVER_NAME\t\t\t\"max9611\"\n\n \n#define MAX9611_REG_CSA_DATA\t\t0x00\n#define MAX9611_REG_RS_DATA\t\t0x02\n#define MAX9611_REG_TEMP_DATA\t\t0x08\n#define MAX9611_REG_CTRL1\t\t0x0a\n#define MAX9611_REG_CTRL2\t\t0x0b\n\n \n#define MAX9611_MUX_MASK\t\tGENMASK(3, 0)\n#define MAX9611_MUX_SENSE_1x\t\t0x00\n#define MAX9611_MUX_SENSE_4x\t\t0x01\n#define MAX9611_MUX_SENSE_8x\t\t0x02\n#define MAX9611_INPUT_VOLT\t\t0x03\n#define MAX9611_MUX_TEMP\t\t0x06\n\n \n#define MAX9611_VOLTAGE_SHIFT\t\t0x04\n#define MAX9611_VOLTAGE_RAW(_r)\t\t((_r) >> MAX9611_VOLTAGE_SHIFT)\n\n \n#define MAX9611_CSA_1X_LSB_nV\t\t107500\n#define MAX9611_CSA_4X_LSB_nV\t\t26880\n#define MAX9611_CSA_8X_LSB_nV\t\t13440\n\n#define MAX9611_CSA_1X_OFFS_RAW\t\t1\n#define MAX9611_CSA_4X_OFFS_RAW\t\t1\n#define MAX9611_CSA_8X_OFFS_RAW\t\t3\n\n \n#define MAX9611_CIM_LSB_mV\t\t14\n#define MAX9611_CIM_OFFSET_RAW\t\t1\n\n \n#define MAX9611_TEMP_MAX_POS\t\t0x7f80\n#define MAX9611_TEMP_MAX_NEG\t\t0xff80\n#define MAX9611_TEMP_MIN_NEG\t\t0xd980\n#define MAX9611_TEMP_MASK\t\tGENMASK(15, 7)\n#define MAX9611_TEMP_SHIFT\t\t0x07\n#define MAX9611_TEMP_RAW(_r)\t\t((_r) >> MAX9611_TEMP_SHIFT)\n#define MAX9611_TEMP_SCALE_NUM\t\t1000000\n#define MAX9611_TEMP_SCALE_DIV\t\t2083\n\n \n#define MAX9611_CONV_TIME_US_RANGE\t3000, 3300\n\nstruct max9611_dev {\n\tstruct device *dev;\n\tstruct i2c_client *i2c_client;\n\tstruct mutex lock;\n\tunsigned int shunt_resistor_uohm;\n};\n\nenum max9611_conf_ids {\n\tCONF_SENSE_1x,\n\tCONF_SENSE_4x,\n\tCONF_SENSE_8x,\n\tCONF_IN_VOLT,\n\tCONF_TEMP,\n};\n\n \nstatic const unsigned int max9611_mux_conf[][2] = {\n\t[CONF_SENSE_1x]\t= { MAX9611_MUX_SENSE_1x, MAX9611_REG_CSA_DATA },\n\t[CONF_SENSE_4x]\t= { MAX9611_MUX_SENSE_4x, MAX9611_REG_CSA_DATA },\n\t[CONF_SENSE_8x]\t= { MAX9611_MUX_SENSE_8x, MAX9611_REG_CSA_DATA },\n\t[CONF_IN_VOLT]\t= { MAX9611_INPUT_VOLT, MAX9611_REG_RS_DATA },\n\t[CONF_TEMP]\t= { MAX9611_MUX_TEMP, MAX9611_REG_TEMP_DATA },\n};\n\nenum max9611_csa_gain {\n\tCSA_GAIN_1x = CONF_SENSE_1x,\n\tCSA_GAIN_4x = CONF_SENSE_4x,\n\tCSA_GAIN_8x = CONF_SENSE_8x,\n};\n\nenum max9611_csa_gain_params {\n\tCSA_GAIN_LSB_nV,\n\tCSA_GAIN_OFFS_RAW,\n};\n\n \nstatic const unsigned int max9611_gain_conf[][2] = {\n\t[CSA_GAIN_1x] = { MAX9611_CSA_1X_LSB_nV, MAX9611_CSA_1X_OFFS_RAW, },\n\t[CSA_GAIN_4x] = { MAX9611_CSA_4X_LSB_nV, MAX9611_CSA_4X_OFFS_RAW, },\n\t[CSA_GAIN_8x] = { MAX9611_CSA_8X_LSB_nV, MAX9611_CSA_8X_OFFS_RAW, },\n};\n\nenum max9611_chan_addrs {\n\tMAX9611_CHAN_VOLTAGE_INPUT,\n\tMAX9611_CHAN_VOLTAGE_SENSE,\n\tMAX9611_CHAN_TEMPERATURE,\n\tMAX9611_CHAN_CURRENT_LOAD,\n\tMAX9611_CHAN_POWER_LOAD,\n};\n\nstatic const struct iio_chan_spec max9611_channels[] = {\n\t{\n\t  .type\t\t\t= IIO_TEMP,\n\t  .info_mask_separate\t= BIT(IIO_CHAN_INFO_RAW) |\n\t\t\t\t  BIT(IIO_CHAN_INFO_SCALE),\n\t  .address\t\t= MAX9611_CHAN_TEMPERATURE,\n\t},\n\t{\n\t  .type\t\t\t= IIO_VOLTAGE,\n\t  .info_mask_separate\t= BIT(IIO_CHAN_INFO_PROCESSED),\n\t  .address\t\t= MAX9611_CHAN_VOLTAGE_SENSE,\n\t  .indexed\t\t= 1,\n\t  .channel\t\t= 0,\n\t},\n\t{\n\t  .type\t\t\t= IIO_VOLTAGE,\n\t  .info_mask_separate\t= BIT(IIO_CHAN_INFO_RAW)   |\n\t\t\t\t  BIT(IIO_CHAN_INFO_SCALE) |\n\t\t\t\t  BIT(IIO_CHAN_INFO_OFFSET),\n\t  .address\t\t= MAX9611_CHAN_VOLTAGE_INPUT,\n\t  .indexed\t\t= 1,\n\t  .channel\t\t= 1,\n\t},\n\t{\n\t  .type\t\t\t= IIO_CURRENT,\n\t  .info_mask_separate\t= BIT(IIO_CHAN_INFO_PROCESSED),\n\t  .address\t\t= MAX9611_CHAN_CURRENT_LOAD,\n\t},\n\t{\n\t  .type\t\t\t= IIO_POWER,\n\t  .info_mask_separate\t= BIT(IIO_CHAN_INFO_PROCESSED),\n\t  .address\t\t= MAX9611_CHAN_POWER_LOAD\n\t},\n};\n\n \nstatic int max9611_read_single(struct max9611_dev *max9611,\n\t\t\t       enum max9611_conf_ids selector,\n\t\t\t       u16 *raw_val)\n{\n\tint ret;\n\n\tu8 mux_conf = max9611_mux_conf[selector][0] & MAX9611_MUX_MASK;\n\tu8 reg_addr = max9611_mux_conf[selector][1];\n\n\t \n\tmutex_lock(&max9611->lock);\n\tret = i2c_smbus_write_byte_data(max9611->i2c_client,\n\t\t\t\t\tMAX9611_REG_CTRL1, mux_conf);\n\tif (ret) {\n\t\tdev_err(max9611->dev, \"i2c write byte failed: 0x%2x - 0x%2x\\n\",\n\t\t\tMAX9611_REG_CTRL1, mux_conf);\n\t\tmutex_unlock(&max9611->lock);\n\t\treturn ret;\n\t}\n\n\t \n\n\tusleep_range(MAX9611_CONV_TIME_US_RANGE);\n\n\tret = i2c_smbus_read_word_swapped(max9611->i2c_client, reg_addr);\n\tif (ret < 0) {\n\t\tdev_err(max9611->dev, \"i2c read word from 0x%2x failed\\n\",\n\t\t\treg_addr);\n\t\tmutex_unlock(&max9611->lock);\n\t\treturn ret;\n\t}\n\n\t*raw_val = ret;\n\tmutex_unlock(&max9611->lock);\n\n\treturn 0;\n}\n\n \nstatic int max9611_read_csa_voltage(struct max9611_dev *max9611,\n\t\t\t\t    u16 *adc_raw,\n\t\t\t\t    enum max9611_csa_gain *csa_gain)\n{\n\tenum max9611_conf_ids gain_selectors[] = {\n\t\tCONF_SENSE_1x,\n\t\tCONF_SENSE_4x,\n\t\tCONF_SENSE_8x\n\t};\n\tunsigned int i;\n\tint ret;\n\n\tfor (i = 0; i < ARRAY_SIZE(gain_selectors); ++i) {\n\t\tret = max9611_read_single(max9611, gain_selectors[i], adc_raw);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (*adc_raw > 0) {\n\t\t\t*csa_gain = (enum max9611_csa_gain)gain_selectors[i];\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\treturn -EIO;\n}\n\nstatic int max9611_read_raw(struct iio_dev *indio_dev,\n\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t    int *val, int *val2, long mask)\n{\n\tstruct max9611_dev *dev = iio_priv(indio_dev);\n\tenum max9611_csa_gain gain_selector;\n\tconst unsigned int *csa_gain;\n\tu16 adc_data;\n\tint ret;\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\n\t\tswitch (chan->address) {\n\t\tcase MAX9611_CHAN_TEMPERATURE:\n\t\t\tret = max9611_read_single(dev, CONF_TEMP,\n\t\t\t\t\t\t  &adc_data);\n\t\t\tif (ret)\n\t\t\t\treturn -EINVAL;\n\n\t\t\t*val = MAX9611_TEMP_RAW(adc_data);\n\t\t\treturn IIO_VAL_INT;\n\n\t\tcase MAX9611_CHAN_VOLTAGE_INPUT:\n\t\t\tret = max9611_read_single(dev, CONF_IN_VOLT,\n\t\t\t\t\t\t  &adc_data);\n\t\t\tif (ret)\n\t\t\t\treturn -EINVAL;\n\n\t\t\t*val = MAX9611_VOLTAGE_RAW(adc_data);\n\t\t\treturn IIO_VAL_INT;\n\t\t}\n\n\t\tbreak;\n\n\tcase IIO_CHAN_INFO_OFFSET:\n\t\t \n\t\t*val = MAX9611_CIM_OFFSET_RAW;\n\n\t\treturn IIO_VAL_INT;\n\n\tcase IIO_CHAN_INFO_SCALE:\n\n\t\tswitch (chan->address) {\n\t\tcase MAX9611_CHAN_TEMPERATURE:\n\t\t\t*val = MAX9611_TEMP_SCALE_NUM;\n\t\t\t*val2 = MAX9611_TEMP_SCALE_DIV;\n\n\t\t\treturn IIO_VAL_FRACTIONAL;\n\n\t\tcase MAX9611_CHAN_VOLTAGE_INPUT:\n\t\t\t*val = MAX9611_CIM_LSB_mV;\n\n\t\t\treturn IIO_VAL_INT;\n\t\t}\n\n\t\tbreak;\n\n\tcase IIO_CHAN_INFO_PROCESSED:\n\n\t\tswitch (chan->address) {\n\t\tcase MAX9611_CHAN_VOLTAGE_SENSE:\n\t\t\t \n\t\t\tret = max9611_read_csa_voltage(dev, &adc_data,\n\t\t\t\t\t\t       &gain_selector);\n\t\t\tif (ret)\n\t\t\t\treturn -EINVAL;\n\n\t\t\tcsa_gain = max9611_gain_conf[gain_selector];\n\n\t\t\tadc_data -= csa_gain[CSA_GAIN_OFFS_RAW];\n\t\t\t*val = MAX9611_VOLTAGE_RAW(adc_data) *\n\t\t\t       csa_gain[CSA_GAIN_LSB_nV];\n\t\t\t*val2 = 1000000;\n\n\t\t\treturn IIO_VAL_FRACTIONAL;\n\n\t\tcase MAX9611_CHAN_CURRENT_LOAD:\n\t\t\t \n\t\t\tret = max9611_read_csa_voltage(dev, &adc_data,\n\t\t\t\t\t\t       &gain_selector);\n\t\t\tif (ret)\n\t\t\t\treturn -EINVAL;\n\n\t\t\tcsa_gain = max9611_gain_conf[gain_selector];\n\n\t\t\tadc_data -= csa_gain[CSA_GAIN_OFFS_RAW];\n\t\t\t*val = MAX9611_VOLTAGE_RAW(adc_data) *\n\t\t\t       csa_gain[CSA_GAIN_LSB_nV];\n\t\t\t*val2 = dev->shunt_resistor_uohm;\n\n\t\t\treturn IIO_VAL_FRACTIONAL;\n\n\t\tcase MAX9611_CHAN_POWER_LOAD:\n\t\t\t \n\t\t\tret = max9611_read_single(dev, CONF_IN_VOLT,\n\t\t\t\t\t\t  &adc_data);\n\t\t\tif (ret)\n\t\t\t\treturn -EINVAL;\n\n\t\t\tadc_data -= MAX9611_CIM_OFFSET_RAW;\n\t\t\t*val = MAX9611_VOLTAGE_RAW(adc_data) *\n\t\t\t       MAX9611_CIM_LSB_mV;\n\n\t\t\tret = max9611_read_csa_voltage(dev, &adc_data,\n\t\t\t\t\t\t       &gain_selector);\n\t\t\tif (ret)\n\t\t\t\treturn -EINVAL;\n\n\t\t\tcsa_gain = max9611_gain_conf[gain_selector];\n\n\t\t\t \n\t\t\tadc_data -= csa_gain[CSA_GAIN_OFFS_RAW];\n\t\t\t*val *= MAX9611_VOLTAGE_RAW(adc_data) *\n\t\t\t\tcsa_gain[CSA_GAIN_LSB_nV] / 1000;\n\t\t\t*val2 = dev->shunt_resistor_uohm;\n\n\t\t\treturn IIO_VAL_FRACTIONAL;\n\t\t}\n\n\t\tbreak;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic ssize_t max9611_shunt_resistor_show(struct device *dev,\n\t\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t\t   char *buf)\n{\n\tstruct max9611_dev *max9611 = iio_priv(dev_to_iio_dev(dev));\n\tunsigned int i, r;\n\n\ti = max9611->shunt_resistor_uohm / 1000000;\n\tr = max9611->shunt_resistor_uohm % 1000000;\n\n\treturn sysfs_emit(buf, \"%u.%06u\\n\", i, r);\n}\n\nstatic IIO_DEVICE_ATTR(in_power_shunt_resistor, 0444,\n\t\t       max9611_shunt_resistor_show, NULL, 0);\nstatic IIO_DEVICE_ATTR(in_current_shunt_resistor, 0444,\n\t\t       max9611_shunt_resistor_show, NULL, 0);\n\nstatic struct attribute *max9611_attributes[] = {\n\t&iio_dev_attr_in_power_shunt_resistor.dev_attr.attr,\n\t&iio_dev_attr_in_current_shunt_resistor.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group max9611_attribute_group = {\n\t.attrs = max9611_attributes,\n};\n\nstatic const struct iio_info indio_info = {\n\t.read_raw\t= max9611_read_raw,\n\t.attrs\t\t= &max9611_attribute_group,\n};\n\nstatic int max9611_init(struct max9611_dev *max9611)\n{\n\tstruct i2c_client *client = max9611->i2c_client;\n\tu16 regval;\n\tint ret;\n\n\tif (!i2c_check_functionality(client->adapter,\n\t\t\t\t     I2C_FUNC_SMBUS_WRITE_BYTE\t|\n\t\t\t\t     I2C_FUNC_SMBUS_READ_WORD_DATA)) {\n\t\tdev_err(max9611->dev,\n\t\t\t\"I2c adapter does not support smbus write_byte or read_word functionalities: aborting probe.\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tret = max9611_read_single(max9611, CONF_TEMP, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\tregval &= MAX9611_TEMP_MASK;\n\n\tif ((regval > MAX9611_TEMP_MAX_POS &&\n\t     regval < MAX9611_TEMP_MIN_NEG) ||\n\t     regval > MAX9611_TEMP_MAX_NEG) {\n\t\tdev_err(max9611->dev,\n\t\t\t\"Invalid value received from ADC 0x%4x: aborting\\n\",\n\t\t\tregval);\n\t\treturn -EIO;\n\t}\n\n\t \n\tret = i2c_smbus_write_byte_data(max9611->i2c_client,\n\t\t\t\t\tMAX9611_REG_CTRL1, 0);\n\tif (ret) {\n\t\tdev_err(max9611->dev, \"i2c write byte failed: 0x%2x - 0x%2x\\n\",\n\t\t\tMAX9611_REG_CTRL1, 0);\n\t\treturn ret;\n\t}\n\n\tret = i2c_smbus_write_byte_data(max9611->i2c_client,\n\t\t\t\t\tMAX9611_REG_CTRL2, 0);\n\tif (ret) {\n\t\tdev_err(max9611->dev, \"i2c write byte failed: 0x%2x - 0x%2x\\n\",\n\t\t\tMAX9611_REG_CTRL2, 0);\n\t\treturn ret;\n\t}\n\tusleep_range(MAX9611_CONV_TIME_US_RANGE);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id max9611_of_table[] = {\n\t{.compatible = \"maxim,max9611\", .data = \"max9611\"},\n\t{.compatible = \"maxim,max9612\", .data = \"max9612\"},\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(of, max9611_of_table);\nstatic int max9611_probe(struct i2c_client *client)\n{\n\tconst char * const shunt_res_prop = \"shunt-resistor-micro-ohms\";\n\tstruct max9611_dev *max9611;\n\tstruct iio_dev *indio_dev;\n\tstruct device *dev = &client->dev;\n\tunsigned int of_shunt;\n\tint ret;\n\n\tindio_dev = devm_iio_device_alloc(&client->dev, sizeof(*max9611));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\ti2c_set_clientdata(client, indio_dev);\n\n\tmax9611\t\t\t= iio_priv(indio_dev);\n\tmax9611->dev\t\t= dev;\n\tmax9611->i2c_client\t= client;\n\tmutex_init(&max9611->lock);\n\n\tret = device_property_read_u32(dev, shunt_res_prop, &of_shunt);\n\tif (ret) {\n\t\tdev_err(dev, \"Missing %s property for %pfw node\\n\",\n\t\t\tshunt_res_prop, dev_fwnode(dev));\n\t\treturn ret;\n\t}\n\tmax9611->shunt_resistor_uohm = of_shunt;\n\n\tret = max9611_init(max9611);\n\tif (ret)\n\t\treturn ret;\n\n\tindio_dev->name\t\t= device_get_match_data(dev);\n\tindio_dev->modes\t= INDIO_DIRECT_MODE;\n\tindio_dev->info\t\t= &indio_info;\n\tindio_dev->channels\t= max9611_channels;\n\tindio_dev->num_channels\t= ARRAY_SIZE(max9611_channels);\n\n\treturn devm_iio_device_register(dev, indio_dev);\n}\n\nstatic struct i2c_driver max9611_driver = {\n\t.driver = {\n\t\t   .name = DRIVER_NAME,\n\t\t   .of_match_table = max9611_of_table,\n\t},\n\t.probe = max9611_probe,\n};\nmodule_i2c_driver(max9611_driver);\n\nMODULE_AUTHOR(\"Jacopo Mondi <jacopo+renesas@jmondi.org>\");\nMODULE_DESCRIPTION(\"Maxim max9611/12 current sense amplifier with 12bit ADC\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}