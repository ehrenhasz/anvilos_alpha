{
  "module_name": "ltc2497.c",
  "hash_id": "0395d8475eb936d9f0880317f99cbd739d1e874c4e46b1c55bc12ac04331accb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/adc/ltc2497.c",
  "human_readable_source": "\n \n\n#include <linux/i2c.h>\n#include <linux/iio/iio.h>\n#include <linux/iio/driver.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/property.h>\n\n#include <asm/unaligned.h>\n\n#include \"ltc2497.h\"\n\nenum ltc2497_chip_type {\n\tTYPE_LTC2497,\n\tTYPE_LTC2499,\n};\n\nstruct ltc2497_driverdata {\n\t \n\tstruct ltc2497core_driverdata common_ddata;\n\tstruct i2c_client *client;\n\tu32 recv_size;\n\t \n\tunion {\n\t\t__be32 d32;\n\t\tu8 d8[3];\n\t} data __aligned(IIO_DMA_MINALIGN);\n};\n\nstatic int ltc2497_result_and_measure(struct ltc2497core_driverdata *ddata,\n\t\t\t\t      u8 address, int *val)\n{\n\tstruct ltc2497_driverdata *st =\n\t\tcontainer_of(ddata, struct ltc2497_driverdata, common_ddata);\n\tint ret;\n\n\tif (val) {\n\t\tif (st->recv_size == 3)\n\t\t\tret = i2c_master_recv(st->client, (char *)&st->data.d8,\n\t\t\t\t\t      st->recv_size);\n\t\telse\n\t\t\tret = i2c_master_recv(st->client, (char *)&st->data.d32,\n\t\t\t\t\t      st->recv_size);\n\t\tif (ret < 0) {\n\t\t\tdev_err(&st->client->dev, \"i2c_master_recv failed\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\t \n\t\tif (st->recv_size == 3) {\n\t\t\t*val = (get_unaligned_be24(st->data.d8) >> 6)\n\t\t\t\t- BIT(ddata->chip_info->resolution + 1);\n\t\t} else {\n\t\t\t*val = (be32_to_cpu(st->data.d32) >> 6)\n\t\t\t\t- BIT(ddata->chip_info->resolution + 1);\n\t\t}\n\n\t\t \n\t\tif (ddata->addr_prev == address)\n\t\t\treturn 0;\n\t}\n\n\tret = i2c_smbus_write_byte(st->client,\n\t\t\t\t   LTC2497_ENABLE | address);\n\tif (ret)\n\t\tdev_err(&st->client->dev, \"i2c transfer failed: %pe\\n\",\n\t\t\tERR_PTR(ret));\n\treturn ret;\n}\n\nstatic int ltc2497_probe(struct i2c_client *client)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(client);\n\tconst struct ltc2497_chip_info *chip_info;\n\tstruct iio_dev *indio_dev;\n\tstruct ltc2497_driverdata *st;\n\tstruct device *dev = &client->dev;\n\tu32 resolution;\n\n\tif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C |\n\t\t\t\t     I2C_FUNC_SMBUS_WRITE_BYTE))\n\t\treturn -EOPNOTSUPP;\n\n\tindio_dev = devm_iio_device_alloc(dev, sizeof(*st));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\tst = iio_priv(indio_dev);\n\ti2c_set_clientdata(client, indio_dev);\n\tst->client = client;\n\tst->common_ddata.result_and_measure = ltc2497_result_and_measure;\n\n\tchip_info = device_get_match_data(dev);\n\tif (!chip_info)\n\t\tchip_info = (const struct ltc2497_chip_info *)id->driver_data;\n\tst->common_ddata.chip_info = chip_info;\n\n\tresolution = chip_info->resolution;\n\tst->recv_size = BITS_TO_BYTES(resolution) + 1;\n\n\treturn ltc2497core_probe(dev, indio_dev);\n}\n\nstatic void ltc2497_remove(struct i2c_client *client)\n{\n\tstruct iio_dev *indio_dev = i2c_get_clientdata(client);\n\n\tltc2497core_remove(indio_dev);\n}\n\nstatic const struct ltc2497_chip_info ltc2497_info[] = {\n\t[TYPE_LTC2497] = {\n\t\t.resolution = 16,\n\t\t.name = NULL,\n\t},\n\t[TYPE_LTC2499] = {\n\t\t.resolution = 24,\n\t\t.name = \"ltc2499\",\n\t},\n};\n\nstatic const struct i2c_device_id ltc2497_id[] = {\n\t{ \"ltc2497\", (kernel_ulong_t)&ltc2497_info[TYPE_LTC2497] },\n\t{ \"ltc2499\", (kernel_ulong_t)&ltc2497_info[TYPE_LTC2499] },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, ltc2497_id);\n\nstatic const struct of_device_id ltc2497_of_match[] = {\n\t{ .compatible = \"lltc,ltc2497\", .data = &ltc2497_info[TYPE_LTC2497] },\n\t{ .compatible = \"lltc,ltc2499\", .data = &ltc2497_info[TYPE_LTC2499] },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, ltc2497_of_match);\n\nstatic struct i2c_driver ltc2497_driver = {\n\t.driver = {\n\t\t.name = \"ltc2497\",\n\t\t.of_match_table = ltc2497_of_match,\n\t},\n\t.probe = ltc2497_probe,\n\t.remove = ltc2497_remove,\n\t.id_table = ltc2497_id,\n};\nmodule_i2c_driver(ltc2497_driver);\n\nMODULE_AUTHOR(\"Michael Hennerich <michael.hennerich@analog.com>\");\nMODULE_DESCRIPTION(\"Linear Technology LTC2497 ADC driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}