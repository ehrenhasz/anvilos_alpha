{
  "module_name": "qcom-vadc-common.c",
  "hash_id": "5688f687ee5836f717594be8ef72b78510242c30f99478cec7cc899bd87f29f1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/adc/qcom-vadc-common.c",
  "human_readable_source": "\n#include <linux/bug.h>\n#include <linux/kernel.h>\n#include <linux/bitops.h>\n#include <linux/fixp-arith.h>\n#include <linux/iio/adc/qcom-vadc-common.h>\n#include <linux/math64.h>\n#include <linux/log2.h>\n#include <linux/err.h>\n#include <linux/module.h>\n#include <linux/units.h>\n\n \nstruct vadc_map_pt {\n\ts32 x;\n\ts32 y;\n};\n\n \nstatic const struct vadc_map_pt adcmap_100k_104ef_104fb[] = {\n\t{1758,\t-40000 },\n\t{1742,\t-35000 },\n\t{1719,\t-30000 },\n\t{1691,\t-25000 },\n\t{1654,\t-20000 },\n\t{1608,\t-15000 },\n\t{1551,\t-10000 },\n\t{1483,\t-5000 },\n\t{1404,\t0 },\n\t{1315,\t5000 },\n\t{1218,\t10000 },\n\t{1114,\t15000 },\n\t{1007,\t20000 },\n\t{900,\t25000 },\n\t{795,\t30000 },\n\t{696,\t35000 },\n\t{605,\t40000 },\n\t{522,\t45000 },\n\t{448,\t50000 },\n\t{383,\t55000 },\n\t{327,\t60000 },\n\t{278,\t65000 },\n\t{237,\t70000 },\n\t{202,\t75000 },\n\t{172,\t80000 },\n\t{146,\t85000 },\n\t{125,\t90000 },\n\t{107,\t95000 },\n\t{92,\t100000 },\n\t{79,\t105000 },\n\t{68,\t110000 },\n\t{59,\t115000 },\n\t{51,\t120000 },\n\t{44,\t125000 }\n};\n\n \nstatic const struct vadc_map_pt adcmap_100k_104ef_104fb_1875_vref[] = {\n\t{ 1831,\t-40000 },\n\t{ 1814,\t-35000 },\n\t{ 1791,\t-30000 },\n\t{ 1761,\t-25000 },\n\t{ 1723,\t-20000 },\n\t{ 1675,\t-15000 },\n\t{ 1616,\t-10000 },\n\t{ 1545,\t-5000 },\n\t{ 1463,\t0 },\n\t{ 1370,\t5000 },\n\t{ 1268,\t10000 },\n\t{ 1160,\t15000 },\n\t{ 1049,\t20000 },\n\t{ 937,\t25000 },\n\t{ 828,\t30000 },\n\t{ 726,\t35000 },\n\t{ 630,\t40000 },\n\t{ 544,\t45000 },\n\t{ 467,\t50000 },\n\t{ 399,\t55000 },\n\t{ 340,\t60000 },\n\t{ 290,\t65000 },\n\t{ 247,\t70000 },\n\t{ 209,\t75000 },\n\t{ 179,\t80000 },\n\t{ 153,\t85000 },\n\t{ 130,\t90000 },\n\t{ 112,\t95000 },\n\t{ 96,\t100000 },\n\t{ 82,\t105000 },\n\t{ 71,\t110000 },\n\t{ 62,\t115000 },\n\t{ 53,\t120000 },\n\t{ 46,\t125000 },\n};\n\nstatic const struct vadc_map_pt adcmap7_die_temp[] = {\n\t{ 857300, 160000 },\n\t{ 820100, 140000 },\n\t{ 782500, 120000 },\n\t{ 744600, 100000 },\n\t{ 706400, 80000 },\n\t{ 667900, 60000 },\n\t{ 629300, 40000 },\n\t{ 590500, 20000 },\n\t{ 551500, 0 },\n\t{ 512400, -20000 },\n\t{ 473100, -40000 },\n\t{ 433700, -60000 },\n};\n\n \nstatic const struct vadc_map_pt adcmap7_100k[] = {\n\t{ 4250657, -40960 },\n\t{ 3962085, -39936 },\n\t{ 3694875, -38912 },\n\t{ 3447322, -37888 },\n\t{ 3217867, -36864 },\n\t{ 3005082, -35840 },\n\t{ 2807660, -34816 },\n\t{ 2624405, -33792 },\n\t{ 2454218, -32768 },\n\t{ 2296094, -31744 },\n\t{ 2149108, -30720 },\n\t{ 2012414, -29696 },\n\t{ 1885232, -28672 },\n\t{ 1766846, -27648 },\n\t{ 1656598, -26624 },\n\t{ 1553884, -25600 },\n\t{ 1458147, -24576 },\n\t{ 1368873, -23552 },\n\t{ 1285590, -22528 },\n\t{ 1207863, -21504 },\n\t{ 1135290, -20480 },\n\t{ 1067501, -19456 },\n\t{ 1004155, -18432 },\n\t{ 944935, -17408 },\n\t{ 889550, -16384 },\n\t{ 837731, -15360 },\n\t{ 789229, -14336 },\n\t{ 743813, -13312 },\n\t{ 701271, -12288 },\n\t{ 661405, -11264 },\n\t{ 624032, -10240 },\n\t{ 588982, -9216 },\n\t{ 556100, -8192 },\n\t{ 525239, -7168 },\n\t{ 496264, -6144 },\n\t{ 469050, -5120 },\n\t{ 443480, -4096 },\n\t{ 419448, -3072 },\n\t{ 396851, -2048 },\n\t{ 375597, -1024 },\n\t{ 355598, 0 },\n\t{ 336775, 1024 },\n\t{ 319052, 2048 },\n\t{ 302359, 3072 },\n\t{ 286630, 4096 },\n\t{ 271806, 5120 },\n\t{ 257829, 6144 },\n\t{ 244646, 7168 },\n\t{ 232209, 8192 },\n\t{ 220471, 9216 },\n\t{ 209390, 10240 },\n\t{ 198926, 11264 },\n\t{ 189040, 12288 },\n\t{ 179698, 13312 },\n\t{ 170868, 14336 },\n\t{ 162519, 15360 },\n\t{ 154622, 16384 },\n\t{ 147150, 17408 },\n\t{ 140079, 18432 },\n\t{ 133385, 19456 },\n\t{ 127046, 20480 },\n\t{ 121042, 21504 },\n\t{ 115352, 22528 },\n\t{ 109960, 23552 },\n\t{ 104848, 24576 },\n\t{ 100000, 25600 },\n\t{ 95402, 26624 },\n\t{ 91038, 27648 },\n\t{ 86897, 28672 },\n\t{ 82965, 29696 },\n\t{ 79232, 30720 },\n\t{ 75686, 31744 },\n\t{ 72316, 32768 },\n\t{ 69114, 33792 },\n\t{ 66070, 34816 },\n\t{ 63176, 35840 },\n\t{ 60423, 36864 },\n\t{ 57804, 37888 },\n\t{ 55312, 38912 },\n\t{ 52940, 39936 },\n\t{ 50681, 40960 },\n\t{ 48531, 41984 },\n\t{ 46482, 43008 },\n\t{ 44530, 44032 },\n\t{ 42670, 45056 },\n\t{ 40897, 46080 },\n\t{ 39207, 47104 },\n\t{ 37595, 48128 },\n\t{ 36057, 49152 },\n\t{ 34590, 50176 },\n\t{ 33190, 51200 },\n\t{ 31853, 52224 },\n\t{ 30577, 53248 },\n\t{ 29358, 54272 },\n\t{ 28194, 55296 },\n\t{ 27082, 56320 },\n\t{ 26020, 57344 },\n\t{ 25004, 58368 },\n\t{ 24033, 59392 },\n\t{ 23104, 60416 },\n\t{ 22216, 61440 },\n\t{ 21367, 62464 },\n\t{ 20554, 63488 },\n\t{ 19776, 64512 },\n\t{ 19031, 65536 },\n\t{ 18318, 66560 },\n\t{ 17636, 67584 },\n\t{ 16982, 68608 },\n\t{ 16355, 69632 },\n\t{ 15755, 70656 },\n\t{ 15180, 71680 },\n\t{ 14628, 72704 },\n\t{ 14099, 73728 },\n\t{ 13592, 74752 },\n\t{ 13106, 75776 },\n\t{ 12640, 76800 },\n\t{ 12192, 77824 },\n\t{ 11762, 78848 },\n\t{ 11350, 79872 },\n\t{ 10954, 80896 },\n\t{ 10574, 81920 },\n\t{ 10209, 82944 },\n\t{ 9858, 83968 },\n\t{ 9521, 84992 },\n\t{ 9197, 86016 },\n\t{ 8886, 87040 },\n\t{ 8587, 88064 },\n\t{ 8299, 89088 },\n\t{ 8023, 90112 },\n\t{ 7757, 91136 },\n\t{ 7501, 92160 },\n\t{ 7254, 93184 },\n\t{ 7017, 94208 },\n\t{ 6789, 95232 },\n\t{ 6570, 96256 },\n\t{ 6358, 97280 },\n\t{ 6155, 98304 },\n\t{ 5959, 99328 },\n\t{ 5770, 100352 },\n\t{ 5588, 101376 },\n\t{ 5412, 102400 },\n\t{ 5243, 103424 },\n\t{ 5080, 104448 },\n\t{ 4923, 105472 },\n\t{ 4771, 106496 },\n\t{ 4625, 107520 },\n\t{ 4484, 108544 },\n\t{ 4348, 109568 },\n\t{ 4217, 110592 },\n\t{ 4090, 111616 },\n\t{ 3968, 112640 },\n\t{ 3850, 113664 },\n\t{ 3736, 114688 },\n\t{ 3626, 115712 },\n\t{ 3519, 116736 },\n\t{ 3417, 117760 },\n\t{ 3317, 118784 },\n\t{ 3221, 119808 },\n\t{ 3129, 120832 },\n\t{ 3039, 121856 },\n\t{ 2952, 122880 },\n\t{ 2868, 123904 },\n\t{ 2787, 124928 },\n\t{ 2709, 125952 },\n\t{ 2633, 126976 },\n\t{ 2560, 128000 },\n\t{ 2489, 129024 },\n\t{ 2420, 130048 }\n};\n\nstatic const struct u32_fract adc5_prescale_ratios[] = {\n\t{ .numerator =  1, .denominator =  1 },\n\t{ .numerator =  1, .denominator =  3 },\n\t{ .numerator =  1, .denominator =  4 },\n\t{ .numerator =  1, .denominator =  6 },\n\t{ .numerator =  1, .denominator = 20 },\n\t{ .numerator =  1, .denominator =  8 },\n\t{ .numerator = 10, .denominator = 81 },\n\t{ .numerator =  1, .denominator = 10 },\n\t{ .numerator =  1, .denominator = 16 },\n};\n\nstatic int qcom_vadc_scale_hw_calib_volt(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_uv);\nstatic int qcom_vadc_scale_hw_calib_therm(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec);\nstatic int qcom_vadc7_scale_hw_calib_therm(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec);\nstatic int qcom_vadc_scale_hw_smb_temp(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec);\nstatic int qcom_vadc_scale_hw_chg5_temp(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec);\nstatic int qcom_vadc_scale_hw_calib_die_temp(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec);\nstatic int qcom_vadc7_scale_hw_calib_die_temp(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec);\n\nstatic struct qcom_adc5_scale_type scale_adc5_fn[] = {\n\t[SCALE_HW_CALIB_DEFAULT] = {qcom_vadc_scale_hw_calib_volt},\n\t[SCALE_HW_CALIB_THERM_100K_PULLUP] = {qcom_vadc_scale_hw_calib_therm},\n\t[SCALE_HW_CALIB_XOTHERM] = {qcom_vadc_scale_hw_calib_therm},\n\t[SCALE_HW_CALIB_THERM_100K_PU_PM7] = {\n\t\t\t\t\tqcom_vadc7_scale_hw_calib_therm},\n\t[SCALE_HW_CALIB_PMIC_THERM] = {qcom_vadc_scale_hw_calib_die_temp},\n\t[SCALE_HW_CALIB_PMIC_THERM_PM7] = {\n\t\t\t\t\tqcom_vadc7_scale_hw_calib_die_temp},\n\t[SCALE_HW_CALIB_PM5_CHG_TEMP] = {qcom_vadc_scale_hw_chg5_temp},\n\t[SCALE_HW_CALIB_PM5_SMB_TEMP] = {qcom_vadc_scale_hw_smb_temp},\n};\n\nstatic int qcom_vadc_map_voltage_temp(const struct vadc_map_pt *pts,\n\t\t\t\t      u32 tablesize, s32 input, int *output)\n{\n\tu32 i = 0;\n\n\tif (!pts)\n\t\treturn -EINVAL;\n\n\twhile (i < tablesize && pts[i].x > input)\n\t\ti++;\n\n\tif (i == 0) {\n\t\t*output = pts[0].y;\n\t} else if (i == tablesize) {\n\t\t*output = pts[tablesize - 1].y;\n\t} else {\n\t\t \n\t\t*output = fixp_linear_interpolate(pts[i - 1].x, pts[i - 1].y,\n\t\t\t\t\t\t  pts[i].x, pts[i].y,\n\t\t\t\t\t\t  input);\n\t}\n\n\treturn 0;\n}\n\nstatic s32 qcom_vadc_map_temp_voltage(const struct vadc_map_pt *pts,\n\t\t\t\t      u32 tablesize, int input)\n{\n\tu32 i = 0;\n\n\t \n\twhile (i < tablesize && pts[i].y < input)\n\t\ti++;\n\n\tif (i == 0)\n\t\treturn pts[0].x;\n\tif (i == tablesize)\n\t\treturn pts[tablesize - 1].x;\n\n\t \n\treturn fixp_linear_interpolate(pts[i - 1].y, pts[i - 1].x,\n\t\t\tpts[i].y, pts[i].x, input);\n}\n\nstatic void qcom_vadc_scale_calib(const struct vadc_linear_graph *calib_graph,\n\t\t\t\t  u16 adc_code,\n\t\t\t\t  bool absolute,\n\t\t\t\t  s64 *scale_voltage)\n{\n\t*scale_voltage = (adc_code - calib_graph->gnd);\n\t*scale_voltage *= calib_graph->dx;\n\t*scale_voltage = div64_s64(*scale_voltage, calib_graph->dy);\n\tif (absolute)\n\t\t*scale_voltage += calib_graph->dx;\n\n\tif (*scale_voltage < 0)\n\t\t*scale_voltage = 0;\n}\n\nstatic int qcom_vadc_scale_volt(const struct vadc_linear_graph *calib_graph,\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tbool absolute, u16 adc_code,\n\t\t\t\tint *result_uv)\n{\n\ts64 voltage = 0, result = 0;\n\n\tqcom_vadc_scale_calib(calib_graph, adc_code, absolute, &voltage);\n\n\tvoltage *= prescale->denominator;\n\tresult = div64_s64(voltage, prescale->numerator);\n\t*result_uv = result;\n\n\treturn 0;\n}\n\nstatic int qcom_vadc_scale_therm(const struct vadc_linear_graph *calib_graph,\n\t\t\t\t const struct u32_fract *prescale,\n\t\t\t\t bool absolute, u16 adc_code,\n\t\t\t\t int *result_mdec)\n{\n\ts64 voltage = 0;\n\tint ret;\n\n\tqcom_vadc_scale_calib(calib_graph, adc_code, absolute, &voltage);\n\n\tif (absolute)\n\t\tvoltage = div64_s64(voltage, 1000);\n\n\tret = qcom_vadc_map_voltage_temp(adcmap_100k_104ef_104fb,\n\t\t\t\t\t ARRAY_SIZE(adcmap_100k_104ef_104fb),\n\t\t\t\t\t voltage, result_mdec);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int qcom_vadc_scale_die_temp(const struct vadc_linear_graph *calib_graph,\n\t\t\t\t    const struct u32_fract *prescale,\n\t\t\t\t    bool absolute,\n\t\t\t\t    u16 adc_code, int *result_mdec)\n{\n\ts64 voltage = 0;\n\tu64 temp;  \n\n\tqcom_vadc_scale_calib(calib_graph, adc_code, absolute, &voltage);\n\n\tif (voltage > 0) {\n\t\ttemp = voltage * prescale->denominator;\n\t\tdo_div(temp, prescale->numerator * 2);\n\t\tvoltage = temp;\n\t} else {\n\t\tvoltage = 0;\n\t}\n\n\t*result_mdec = milli_kelvin_to_millicelsius(voltage);\n\n\treturn 0;\n}\n\nstatic int qcom_vadc_scale_chg_temp(const struct vadc_linear_graph *calib_graph,\n\t\t\t\t    const struct u32_fract *prescale,\n\t\t\t\t    bool absolute,\n\t\t\t\t    u16 adc_code, int *result_mdec)\n{\n\ts64 voltage = 0, result = 0;\n\n\tqcom_vadc_scale_calib(calib_graph, adc_code, absolute, &voltage);\n\n\tvoltage *= prescale->denominator;\n\tvoltage = div64_s64(voltage, prescale->numerator);\n\tvoltage = ((PMI_CHG_SCALE_1) * (voltage * 2));\n\tvoltage = (voltage + PMI_CHG_SCALE_2);\n\tresult =  div64_s64(voltage, 1000000);\n\t*result_mdec = result;\n\n\treturn 0;\n}\n\n \nstatic u16 qcom_vadc_scale_voltage_code(s32 voltage,\n\t\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\t\tconst u32 full_scale_code_volt,\n\t\t\t\t\tunsigned int factor)\n{\n\ts64 volt = voltage;\n\ts64 adc_vdd_ref_mv = 1875;  \n\n\tvolt *= prescale->numerator * factor * full_scale_code_volt;\n\tvolt = div64_s64(volt, (s64)prescale->denominator * adc_vdd_ref_mv * 1000);\n\n\treturn volt;\n}\n\nstatic int qcom_vadc_scale_code_voltage_factor(u16 adc_code,\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tunsigned int factor)\n{\n\ts64 voltage, temp, adc_vdd_ref_mv = 1875;\n\n\t \n\tif (adc_code > VADC5_MAX_CODE)\n\t\tadc_code = 0;\n\n\t \n\tvoltage = (s64) adc_code * adc_vdd_ref_mv * 1000;\n\tvoltage = div64_s64(voltage, data->full_scale_code_volt);\n\tif (voltage > 0) {\n\t\tvoltage *= prescale->denominator;\n\t\ttemp = prescale->numerator * factor;\n\t\tvoltage = div64_s64(voltage, temp);\n\t} else {\n\t\tvoltage = 0;\n\t}\n\n\treturn (int) voltage;\n}\n\nstatic int qcom_vadc7_scale_hw_calib_therm(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec)\n{\n\ts64 resistance = adc_code;\n\tint ret, result;\n\n\tif (adc_code >= RATIO_MAX_ADC7)\n\t\treturn -EINVAL;\n\n\t \n\tresistance *= R_PU_100K;\n\tresistance = div64_s64(resistance, RATIO_MAX_ADC7 - adc_code);\n\n\tret = qcom_vadc_map_voltage_temp(adcmap7_100k,\n\t\t\t\t ARRAY_SIZE(adcmap7_100k),\n\t\t\t\t resistance, &result);\n\tif (ret)\n\t\treturn ret;\n\n\t*result_mdec = result;\n\n\treturn 0;\n}\n\nstatic int qcom_vadc_scale_hw_calib_volt(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_uv)\n{\n\t*result_uv = qcom_vadc_scale_code_voltage_factor(adc_code,\n\t\t\t\tprescale, data, 1);\n\n\treturn 0;\n}\n\nstatic int qcom_vadc_scale_hw_calib_therm(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec)\n{\n\tint voltage;\n\n\tvoltage = qcom_vadc_scale_code_voltage_factor(adc_code,\n\t\t\t\tprescale, data, 1000);\n\n\t \n\treturn qcom_vadc_map_voltage_temp(adcmap_100k_104ef_104fb_1875_vref,\n\t\t\t\t ARRAY_SIZE(adcmap_100k_104ef_104fb_1875_vref),\n\t\t\t\t voltage, result_mdec);\n}\n\nstatic int qcom_vadc_scale_hw_calib_die_temp(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec)\n{\n\t*result_mdec = qcom_vadc_scale_code_voltage_factor(adc_code,\n\t\t\t\tprescale, data, 2);\n\t*result_mdec = milli_kelvin_to_millicelsius(*result_mdec);\n\n\treturn 0;\n}\n\nstatic int qcom_vadc7_scale_hw_calib_die_temp(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec)\n{\n\n\tint voltage;\n\n\tvoltage = qcom_vadc_scale_code_voltage_factor(adc_code,\n\t\t\t\tprescale, data, 1);\n\n\treturn qcom_vadc_map_voltage_temp(adcmap7_die_temp, ARRAY_SIZE(adcmap7_die_temp),\n\t\t\tvoltage, result_mdec);\n}\n\nstatic int qcom_vadc_scale_hw_smb_temp(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec)\n{\n\t*result_mdec = qcom_vadc_scale_code_voltage_factor(adc_code * 100,\n\t\t\t\tprescale, data, PMIC5_SMB_TEMP_SCALE_FACTOR);\n\t*result_mdec = PMIC5_SMB_TEMP_CONSTANT - *result_mdec;\n\n\treturn 0;\n}\n\nstatic int qcom_vadc_scale_hw_chg5_temp(\n\t\t\t\tconst struct u32_fract *prescale,\n\t\t\t\tconst struct adc5_data *data,\n\t\t\t\tu16 adc_code, int *result_mdec)\n{\n\t*result_mdec = qcom_vadc_scale_code_voltage_factor(adc_code,\n\t\t\t\tprescale, data, 4);\n\t*result_mdec = PMIC5_CHG_TEMP_SCALE_FACTOR - *result_mdec;\n\n\treturn 0;\n}\n\nint qcom_vadc_scale(enum vadc_scale_fn_type scaletype,\n\t\t    const struct vadc_linear_graph *calib_graph,\n\t\t    const struct u32_fract *prescale,\n\t\t    bool absolute,\n\t\t    u16 adc_code, int *result)\n{\n\tswitch (scaletype) {\n\tcase SCALE_DEFAULT:\n\t\treturn qcom_vadc_scale_volt(calib_graph, prescale,\n\t\t\t\t\t    absolute, adc_code,\n\t\t\t\t\t    result);\n\tcase SCALE_THERM_100K_PULLUP:\n\tcase SCALE_XOTHERM:\n\t\treturn qcom_vadc_scale_therm(calib_graph, prescale,\n\t\t\t\t\t     absolute, adc_code,\n\t\t\t\t\t     result);\n\tcase SCALE_PMIC_THERM:\n\t\treturn qcom_vadc_scale_die_temp(calib_graph, prescale,\n\t\t\t\t\t\tabsolute, adc_code,\n\t\t\t\t\t\tresult);\n\tcase SCALE_PMI_CHG_TEMP:\n\t\treturn qcom_vadc_scale_chg_temp(calib_graph, prescale,\n\t\t\t\t\t\tabsolute, adc_code,\n\t\t\t\t\t\tresult);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\nEXPORT_SYMBOL(qcom_vadc_scale);\n\nu16 qcom_adc_tm5_temp_volt_scale(unsigned int prescale_ratio,\n\t\t\t\t u32 full_scale_code_volt, int temp)\n{\n\tconst struct u32_fract *prescale = &adc5_prescale_ratios[prescale_ratio];\n\ts32 voltage;\n\n\tvoltage = qcom_vadc_map_temp_voltage(adcmap_100k_104ef_104fb_1875_vref,\n\t\t\t\t\t     ARRAY_SIZE(adcmap_100k_104ef_104fb_1875_vref),\n\t\t\t\t\t     temp);\n\treturn qcom_vadc_scale_voltage_code(voltage, prescale, full_scale_code_volt, 1000);\n}\nEXPORT_SYMBOL(qcom_adc_tm5_temp_volt_scale);\n\nu16 qcom_adc_tm5_gen2_temp_res_scale(int temp)\n{\n\tint64_t resistance;\n\n\tresistance = qcom_vadc_map_temp_voltage(adcmap7_100k,\n\t\tARRAY_SIZE(adcmap7_100k), temp);\n\n\treturn div64_s64(resistance * RATIO_MAX_ADC7, resistance + R_PU_100K);\n}\nEXPORT_SYMBOL(qcom_adc_tm5_gen2_temp_res_scale);\n\nint qcom_adc5_hw_scale(enum vadc_scale_fn_type scaletype,\n\t\t    unsigned int prescale_ratio,\n\t\t    const struct adc5_data *data,\n\t\t    u16 adc_code, int *result)\n{\n\tconst struct u32_fract *prescale = &adc5_prescale_ratios[prescale_ratio];\n\n\tif (!(scaletype >= SCALE_HW_CALIB_DEFAULT &&\n\t\tscaletype < SCALE_HW_CALIB_INVALID)) {\n\t\tpr_err(\"Invalid scale type %d\\n\", scaletype);\n\t\treturn -EINVAL;\n\t}\n\n\treturn scale_adc5_fn[scaletype].scale_fn(prescale, data,\n\t\t\t\t\tadc_code, result);\n}\nEXPORT_SYMBOL(qcom_adc5_hw_scale);\n\nint qcom_adc5_prescaling_from_dt(u32 numerator, u32 denominator)\n{\n\tunsigned int pre;\n\n\tfor (pre = 0; pre < ARRAY_SIZE(adc5_prescale_ratios); pre++)\n\t\tif (adc5_prescale_ratios[pre].numerator == numerator &&\n\t\t    adc5_prescale_ratios[pre].denominator == denominator)\n\t\t\tbreak;\n\n\tif (pre == ARRAY_SIZE(adc5_prescale_ratios))\n\t\treturn -EINVAL;\n\n\treturn pre;\n}\nEXPORT_SYMBOL(qcom_adc5_prescaling_from_dt);\n\nint qcom_adc5_hw_settle_time_from_dt(u32 value,\n\t\t\t\t     const unsigned int *hw_settle)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < VADC_HW_SETTLE_SAMPLES_MAX; i++) {\n\t\tif (value == hw_settle[i])\n\t\t\treturn i;\n\t}\n\n\treturn -EINVAL;\n}\nEXPORT_SYMBOL(qcom_adc5_hw_settle_time_from_dt);\n\nint qcom_adc5_avg_samples_from_dt(u32 value)\n{\n\tif (!is_power_of_2(value) || value > ADC5_AVG_SAMPLES_MAX)\n\t\treturn -EINVAL;\n\n\treturn __ffs(value);\n}\nEXPORT_SYMBOL(qcom_adc5_avg_samples_from_dt);\n\nint qcom_adc5_decimation_from_dt(u32 value, const unsigned int *decimation)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < ADC5_DECIMATION_SAMPLES_MAX; i++) {\n\t\tif (value == decimation[i])\n\t\t\treturn i;\n\t}\n\n\treturn -EINVAL;\n}\nEXPORT_SYMBOL(qcom_adc5_decimation_from_dt);\n\nint qcom_vadc_decimation_from_dt(u32 value)\n{\n\tif (!is_power_of_2(value) || value < VADC_DECIMATION_MIN ||\n\t    value > VADC_DECIMATION_MAX)\n\t\treturn -EINVAL;\n\n\treturn __ffs64(value / VADC_DECIMATION_MIN);\n}\nEXPORT_SYMBOL(qcom_vadc_decimation_from_dt);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Qualcomm ADC common functionality\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}