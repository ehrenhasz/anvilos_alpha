{
  "module_name": "max1027.c",
  "hash_id": "6578cd7fcc8bf42ff08f7a904189f4b36869d03118d7d0da0dba3b3841655ff7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/adc/max1027.c",
  "human_readable_source": "\n  \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/spi/spi.h>\n#include <linux/delay.h>\n\n#include <linux/iio/iio.h>\n#include <linux/iio/buffer.h>\n#include <linux/iio/trigger.h>\n#include <linux/iio/trigger_consumer.h>\n#include <linux/iio/triggered_buffer.h>\n\n#define MAX1027_CONV_REG  BIT(7)\n#define MAX1027_SETUP_REG BIT(6)\n#define MAX1027_AVG_REG   BIT(5)\n#define MAX1027_RST_REG   BIT(4)\n\n \n#define MAX1027_TEMP      BIT(0)\n#define MAX1027_SCAN_0_N  (0x00 << 1)\n#define MAX1027_SCAN_N_M  (0x01 << 1)\n#define MAX1027_SCAN_N    (0x02 << 1)\n#define MAX1027_NOSCAN    (0x03 << 1)\n#define MAX1027_CHAN(n)   ((n) << 3)\n\n \n#define MAX1027_UNIPOLAR  0x02\n#define MAX1027_BIPOLAR   0x03\n#define MAX1027_REF_MODE0 (0x00 << 2)\n#define MAX1027_REF_MODE1 (0x01 << 2)\n#define MAX1027_REF_MODE2 (0x02 << 2)\n#define MAX1027_REF_MODE3 (0x03 << 2)\n#define MAX1027_CKS_MODE0 (0x00 << 4)\n#define MAX1027_CKS_MODE1 (0x01 << 4)\n#define MAX1027_CKS_MODE2 (0x02 << 4)\n#define MAX1027_CKS_MODE3 (0x03 << 4)\n\n \n#define MAX1027_NSCAN_4   0x00\n#define MAX1027_NSCAN_8   0x01\n#define MAX1027_NSCAN_12  0x02\n#define MAX1027_NSCAN_16  0x03\n#define MAX1027_NAVG_4    (0x00 << 2)\n#define MAX1027_NAVG_8    (0x01 << 2)\n#define MAX1027_NAVG_16   (0x02 << 2)\n#define MAX1027_NAVG_32   (0x03 << 2)\n#define MAX1027_AVG_EN    BIT(4)\n\n \n#define MAX1027_CONVERSION_UDELAY 4\n\nenum max1027_id {\n\tmax1027,\n\tmax1029,\n\tmax1031,\n\tmax1227,\n\tmax1229,\n\tmax1231,\n};\n\nstatic const struct spi_device_id max1027_id[] = {\n\t{\"max1027\", max1027},\n\t{\"max1029\", max1029},\n\t{\"max1031\", max1031},\n\t{\"max1227\", max1227},\n\t{\"max1229\", max1229},\n\t{\"max1231\", max1231},\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, max1027_id);\n\nstatic const struct of_device_id max1027_adc_dt_ids[] = {\n\t{ .compatible = \"maxim,max1027\" },\n\t{ .compatible = \"maxim,max1029\" },\n\t{ .compatible = \"maxim,max1031\" },\n\t{ .compatible = \"maxim,max1227\" },\n\t{ .compatible = \"maxim,max1229\" },\n\t{ .compatible = \"maxim,max1231\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, max1027_adc_dt_ids);\n\n#define MAX1027_V_CHAN(index, depth)\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.type = IIO_VOLTAGE,\t\t\t\t\t\\\n\t\t.indexed = 1,\t\t\t\t\t\t\\\n\t\t.channel = index,\t\t\t\t\t\\\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW),\t\t\\\n\t\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE),\t\\\n\t\t.scan_index = index + 1,\t\t\t\t\\\n\t\t.scan_type = {\t\t\t\t\t\t\\\n\t\t\t.sign = 'u',\t\t\t\t\t\\\n\t\t\t.realbits = depth,\t\t\t\t\\\n\t\t\t.storagebits = 16,\t\t\t\t\\\n\t\t\t.shift = (depth == 10) ? 2 : 0,\t\t\t\\\n\t\t\t.endianness = IIO_BE,\t\t\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t}\n\n#define MAX1027_T_CHAN\t\t\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.type = IIO_TEMP,\t\t\t\t\t\\\n\t\t.channel = 0,\t\t\t\t\t\t\\\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW),\t\t\\\n\t\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE),\t\\\n\t\t.scan_index = 0,\t\t\t\t\t\\\n\t\t.scan_type = {\t\t\t\t\t\t\\\n\t\t\t.sign = 'u',\t\t\t\t\t\\\n\t\t\t.realbits = 12,\t\t\t\t\t\\\n\t\t\t.storagebits = 16,\t\t\t\t\\\n\t\t\t.endianness = IIO_BE,\t\t\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t}\n\n#define MAX1X27_CHANNELS(depth)\t\t\t\\\n\tMAX1027_T_CHAN,\t\t\t\t\\\n\tMAX1027_V_CHAN(0, depth),\t\t\\\n\tMAX1027_V_CHAN(1, depth),\t\t\\\n\tMAX1027_V_CHAN(2, depth),\t\t\\\n\tMAX1027_V_CHAN(3, depth),\t\t\\\n\tMAX1027_V_CHAN(4, depth),\t\t\\\n\tMAX1027_V_CHAN(5, depth),\t\t\\\n\tMAX1027_V_CHAN(6, depth),\t\t\\\n\tMAX1027_V_CHAN(7, depth)\n\n#define MAX1X29_CHANNELS(depth)\t\t\t\\\n\tMAX1X27_CHANNELS(depth),\t\t\\\n\tMAX1027_V_CHAN(8, depth),\t\t\\\n\tMAX1027_V_CHAN(9, depth),\t\t\\\n\tMAX1027_V_CHAN(10, depth),\t\t\\\n\tMAX1027_V_CHAN(11, depth)\n\n#define MAX1X31_CHANNELS(depth)\t\t\t\\\n\tMAX1X29_CHANNELS(depth),\t\t\\\n\tMAX1027_V_CHAN(12, depth),\t\t\\\n\tMAX1027_V_CHAN(13, depth),\t\t\\\n\tMAX1027_V_CHAN(14, depth),\t\t\\\n\tMAX1027_V_CHAN(15, depth)\n\nstatic const struct iio_chan_spec max1027_channels[] = {\n\tMAX1X27_CHANNELS(10),\n};\n\nstatic const struct iio_chan_spec max1029_channels[] = {\n\tMAX1X29_CHANNELS(10),\n};\n\nstatic const struct iio_chan_spec max1031_channels[] = {\n\tMAX1X31_CHANNELS(10),\n};\n\nstatic const struct iio_chan_spec max1227_channels[] = {\n\tMAX1X27_CHANNELS(12),\n};\n\nstatic const struct iio_chan_spec max1229_channels[] = {\n\tMAX1X29_CHANNELS(12),\n};\n\nstatic const struct iio_chan_spec max1231_channels[] = {\n\tMAX1X31_CHANNELS(12),\n};\n\n \n#define MAX1X27_SCAN_MASK_TEMP BIT(0)\n\n#define MAX1X27_SCAN_MASKS(temp)\t\t\t\t\t\\\n\tGENMASK(1, 1 - (temp)), GENMASK(2, 1 - (temp)),\t\t\t\\\n\tGENMASK(3, 1 - (temp)), GENMASK(4, 1 - (temp)),\t\t\t\\\n\tGENMASK(5, 1 - (temp)), GENMASK(6, 1 - (temp)),\t\t\t\\\n\tGENMASK(7, 1 - (temp)), GENMASK(8, 1 - (temp))\n\n#define MAX1X29_SCAN_MASKS(temp)\t\t\t\t\t\\\n\tMAX1X27_SCAN_MASKS(temp),\t\t\t\t\t\\\n\tGENMASK(9, 1 - (temp)), GENMASK(10, 1 - (temp)),\t\t\\\n\tGENMASK(11, 1 - (temp)), GENMASK(12, 1 - (temp))\n\n#define MAX1X31_SCAN_MASKS(temp)\t\t\t\t\t\\\n\tMAX1X29_SCAN_MASKS(temp),\t\t\t\t\t\\\n\tGENMASK(13, 1 - (temp)), GENMASK(14, 1 - (temp)),\t\t\\\n\tGENMASK(15, 1 - (temp)), GENMASK(16, 1 - (temp))\n\nstatic const unsigned long max1027_available_scan_masks[] = {\n\tMAX1X27_SCAN_MASKS(0),\n\tMAX1X27_SCAN_MASKS(1),\n\t0x00000000,\n};\n\nstatic const unsigned long max1029_available_scan_masks[] = {\n\tMAX1X29_SCAN_MASKS(0),\n\tMAX1X29_SCAN_MASKS(1),\n\t0x00000000,\n};\n\nstatic const unsigned long max1031_available_scan_masks[] = {\n\tMAX1X31_SCAN_MASKS(0),\n\tMAX1X31_SCAN_MASKS(1),\n\t0x00000000,\n};\n\nstruct max1027_chip_info {\n\tconst struct iio_chan_spec *channels;\n\tunsigned int num_channels;\n\tconst unsigned long *available_scan_masks;\n};\n\nstatic const struct max1027_chip_info max1027_chip_info_tbl[] = {\n\t[max1027] = {\n\t\t.channels = max1027_channels,\n\t\t.num_channels = ARRAY_SIZE(max1027_channels),\n\t\t.available_scan_masks = max1027_available_scan_masks,\n\t},\n\t[max1029] = {\n\t\t.channels = max1029_channels,\n\t\t.num_channels = ARRAY_SIZE(max1029_channels),\n\t\t.available_scan_masks = max1029_available_scan_masks,\n\t},\n\t[max1031] = {\n\t\t.channels = max1031_channels,\n\t\t.num_channels = ARRAY_SIZE(max1031_channels),\n\t\t.available_scan_masks = max1031_available_scan_masks,\n\t},\n\t[max1227] = {\n\t\t.channels = max1227_channels,\n\t\t.num_channels = ARRAY_SIZE(max1227_channels),\n\t\t.available_scan_masks = max1027_available_scan_masks,\n\t},\n\t[max1229] = {\n\t\t.channels = max1229_channels,\n\t\t.num_channels = ARRAY_SIZE(max1229_channels),\n\t\t.available_scan_masks = max1029_available_scan_masks,\n\t},\n\t[max1231] = {\n\t\t.channels = max1231_channels,\n\t\t.num_channels = ARRAY_SIZE(max1231_channels),\n\t\t.available_scan_masks = max1031_available_scan_masks,\n\t},\n};\n\nstruct max1027_state {\n\tconst struct max1027_chip_info\t*info;\n\tstruct spi_device\t\t*spi;\n\tstruct iio_trigger\t\t*trig;\n\t__be16\t\t\t\t*buffer;\n\tstruct mutex\t\t\tlock;\n\tstruct completion\t\tcomplete;\n\n\tu8\t\t\t\treg __aligned(IIO_DMA_MINALIGN);\n};\n\nstatic int max1027_wait_eoc(struct iio_dev *indio_dev)\n{\n\tstruct max1027_state *st = iio_priv(indio_dev);\n\tunsigned int conversion_time = MAX1027_CONVERSION_UDELAY;\n\tint ret;\n\n\tif (st->spi->irq) {\n\t\tret = wait_for_completion_timeout(&st->complete,\n\t\t\t\t\t\t  msecs_to_jiffies(1000));\n\t\treinit_completion(&st->complete);\n\t\tif (!ret)\n\t\t\treturn -ETIMEDOUT;\n\t} else {\n\t\tif (indio_dev->active_scan_mask)\n\t\t\tconversion_time *= hweight32(*indio_dev->active_scan_mask);\n\n\t\tusleep_range(conversion_time, conversion_time * 2);\n\t}\n\n\treturn 0;\n}\n\n \nstatic int max1027_configure_chans_and_start(struct iio_dev *indio_dev)\n{\n\tstruct max1027_state *st = iio_priv(indio_dev);\n\n\tst->reg = MAX1027_CONV_REG | MAX1027_SCAN_0_N;\n\tst->reg |= MAX1027_CHAN(fls(*indio_dev->active_scan_mask) - 2);\n\tif (*indio_dev->active_scan_mask & MAX1X27_SCAN_MASK_TEMP)\n\t\tst->reg |= MAX1027_TEMP;\n\n\treturn spi_write(st->spi, &st->reg, 1);\n}\n\nstatic int max1027_enable_trigger(struct iio_dev *indio_dev, bool enable)\n{\n\tstruct max1027_state *st = iio_priv(indio_dev);\n\n\tst->reg = MAX1027_SETUP_REG | MAX1027_REF_MODE2;\n\n\t \n\tif (enable)\n\t\tst->reg |= MAX1027_CKS_MODE0;\n\telse\n\t\tst->reg |= MAX1027_CKS_MODE2;\n\n\treturn spi_write(st->spi, &st->reg, 1);\n}\n\nstatic int max1027_read_single_value(struct iio_dev *indio_dev,\n\t\t\t\t     struct iio_chan_spec const *chan,\n\t\t\t\t     int *val)\n{\n\tint ret;\n\tstruct max1027_state *st = iio_priv(indio_dev);\n\n\tret = iio_device_claim_direct_mode(indio_dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tst->reg = MAX1027_CONV_REG | MAX1027_CHAN(chan->channel) |\n\t\t  MAX1027_NOSCAN;\n\tif (chan->type == IIO_TEMP)\n\t\tst->reg |= MAX1027_TEMP;\n\tret = spi_write(st->spi, &st->reg, 1);\n\tif (ret < 0) {\n\t\tdev_err(&indio_dev->dev,\n\t\t\t\"Failed to configure conversion register\\n\");\n\t\tgoto release;\n\t}\n\n\t \n\tret = max1027_wait_eoc(indio_dev);\n\tif (ret)\n\t\tgoto release;\n\n\t \n\tret = spi_read(st->spi, st->buffer, (chan->type == IIO_TEMP) ? 4 : 2);\n\nrelease:\n\tiio_device_release_direct_mode(indio_dev);\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*val = be16_to_cpu(st->buffer[0]);\n\n\treturn IIO_VAL_INT;\n}\n\nstatic int max1027_read_raw(struct iio_dev *indio_dev,\n\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t    int *val, int *val2, long mask)\n{\n\tint ret = 0;\n\tstruct max1027_state *st = iio_priv(indio_dev);\n\n\tmutex_lock(&st->lock);\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tret = max1027_read_single_value(indio_dev, chan, val);\n\t\tbreak;\n\tcase IIO_CHAN_INFO_SCALE:\n\t\tswitch (chan->type) {\n\t\tcase IIO_TEMP:\n\t\t\t*val = 1;\n\t\t\t*val2 = 8;\n\t\t\tret = IIO_VAL_FRACTIONAL;\n\t\t\tbreak;\n\t\tcase IIO_VOLTAGE:\n\t\t\t*val = 2500;\n\t\t\t*val2 = chan->scan_type.realbits;\n\t\t\tret = IIO_VAL_FRACTIONAL_LOG2;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret = -EINVAL;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&st->lock);\n\n\treturn ret;\n}\n\nstatic int max1027_debugfs_reg_access(struct iio_dev *indio_dev,\n\t\t\t\t      unsigned int reg, unsigned int writeval,\n\t\t\t\t      unsigned int *readval)\n{\n\tstruct max1027_state *st = iio_priv(indio_dev);\n\tu8 *val = (u8 *)st->buffer;\n\n\tif (readval) {\n\t\tint ret = spi_read(st->spi, val, 2);\n\t\t*readval = be16_to_cpu(st->buffer[0]);\n\t\treturn ret;\n\t}\n\n\t*val = (u8)writeval;\n\treturn spi_write(st->spi, val, 1);\n}\n\nstatic int max1027_set_cnvst_trigger_state(struct iio_trigger *trig, bool state)\n{\n\tstruct iio_dev *indio_dev = iio_trigger_get_drvdata(trig);\n\tint ret;\n\n\t \n\tret = max1027_enable_trigger(indio_dev, state);\n\tif (ret)\n\t\treturn ret;\n\n\tif (state) {\n\t\tret = max1027_configure_chans_and_start(indio_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int max1027_read_scan(struct iio_dev *indio_dev)\n{\n\tstruct max1027_state *st = iio_priv(indio_dev);\n\tunsigned int scanned_chans;\n\tint ret;\n\n\tscanned_chans = fls(*indio_dev->active_scan_mask) - 1;\n\tif (*indio_dev->active_scan_mask & MAX1X27_SCAN_MASK_TEMP)\n\t\tscanned_chans++;\n\n\t \n\tret = spi_read(st->spi, st->buffer, scanned_chans * 2);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tiio_push_to_buffers(indio_dev, st->buffer);\n\n\treturn 0;\n}\n\nstatic irqreturn_t max1027_handler(int irq, void *private)\n{\n\tstruct iio_dev *indio_dev = private;\n\tstruct max1027_state *st = iio_priv(indio_dev);\n\n\t \n\tif (!iio_buffer_enabled(indio_dev))\n\t\tcomplete(&st->complete);\n\telse\n\t\tiio_trigger_poll(indio_dev->trig);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t max1027_trigger_handler(int irq, void *private)\n{\n\tstruct iio_poll_func *pf = private;\n\tstruct iio_dev *indio_dev = pf->indio_dev;\n\tint ret;\n\n\tif (!iio_trigger_using_own(indio_dev)) {\n\t\tret = max1027_configure_chans_and_start(indio_dev);\n\t\tif (ret)\n\t\t\tgoto out;\n\n\t\t \n\t\tret = max1027_wait_eoc(indio_dev);\n\t\tif (ret)\n\t\t\tgoto out;\n\t}\n\n\tret = max1027_read_scan(indio_dev);\nout:\n\tif (ret)\n\t\tdev_err(&indio_dev->dev,\n\t\t\t\"Cannot read scanned values (%d)\\n\", ret);\n\n\tiio_trigger_notify_done(indio_dev->trig);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic const struct iio_trigger_ops max1027_trigger_ops = {\n\t.validate_device = &iio_trigger_validate_own_device,\n\t.set_trigger_state = &max1027_set_cnvst_trigger_state,\n};\n\nstatic const struct iio_info max1027_info = {\n\t.read_raw = &max1027_read_raw,\n\t.debugfs_reg_access = &max1027_debugfs_reg_access,\n};\n\nstatic int max1027_probe(struct spi_device *spi)\n{\n\tint ret;\n\tstruct iio_dev *indio_dev;\n\tstruct max1027_state *st;\n\n\tindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\n\tif (!indio_dev) {\n\t\tpr_err(\"Can't allocate iio device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tst = iio_priv(indio_dev);\n\tst->spi = spi;\n\tst->info = &max1027_chip_info_tbl[spi_get_device_id(spi)->driver_data];\n\n\tmutex_init(&st->lock);\n\tinit_completion(&st->complete);\n\n\tindio_dev->name = spi_get_device_id(spi)->name;\n\tindio_dev->info = &max1027_info;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->channels = st->info->channels;\n\tindio_dev->num_channels = st->info->num_channels;\n\tindio_dev->available_scan_masks = st->info->available_scan_masks;\n\n\tst->buffer = devm_kmalloc_array(&indio_dev->dev,\n\t\t\t\t\tindio_dev->num_channels, 2,\n\t\t\t\t\tGFP_KERNEL);\n\tif (!st->buffer)\n\t\treturn -ENOMEM;\n\n\t \n\tret = devm_iio_triggered_buffer_setup(&spi->dev, indio_dev,\n\t\t\t\t\t      &iio_pollfunc_store_time,\n\t\t\t\t\t      &max1027_trigger_handler,\n\t\t\t\t\t      NULL);\n\tif (ret < 0) {\n\t\tdev_err(&indio_dev->dev, \"Failed to setup buffer\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (spi->irq) {\n\t\tst->trig = devm_iio_trigger_alloc(&spi->dev, \"%s-trigger\",\n\t\t\t\t\t\t  indio_dev->name);\n\t\tif (!st->trig) {\n\t\t\tret = -ENOMEM;\n\t\t\tdev_err(&indio_dev->dev,\n\t\t\t\t\"Failed to allocate iio trigger\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tst->trig->ops = &max1027_trigger_ops;\n\t\tiio_trigger_set_drvdata(st->trig, indio_dev);\n\t\tret = devm_iio_trigger_register(&indio_dev->dev,\n\t\t\t\t\t\tst->trig);\n\t\tif (ret < 0) {\n\t\t\tdev_err(&indio_dev->dev,\n\t\t\t\t\"Failed to register iio trigger\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = devm_request_irq(&spi->dev, spi->irq, max1027_handler,\n\t\t\t\t       IRQF_TRIGGER_FALLING,\n\t\t\t\t       spi->dev.driver->name, indio_dev);\n\t\tif (ret < 0) {\n\t\t\tdev_err(&indio_dev->dev, \"Failed to allocate IRQ.\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tst->reg = MAX1027_RST_REG;\n\tret = spi_write(st->spi, &st->reg, 1);\n\tif (ret < 0) {\n\t\tdev_err(&indio_dev->dev, \"Failed to reset the ADC\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tst->reg = MAX1027_AVG_REG;\n\tret = spi_write(st->spi, &st->reg, 1);\n\tif (ret < 0) {\n\t\tdev_err(&indio_dev->dev, \"Failed to configure averaging register\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = max1027_enable_trigger(indio_dev, false);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_iio_device_register(&spi->dev, indio_dev);\n}\n\nstatic struct spi_driver max1027_driver = {\n\t.driver = {\n\t\t.name\t= \"max1027\",\n\t\t.of_match_table = max1027_adc_dt_ids,\n\t},\n\t.probe\t\t= max1027_probe,\n\t.id_table\t= max1027_id,\n};\nmodule_spi_driver(max1027_driver);\n\nMODULE_AUTHOR(\"Philippe Reynes <tremyfr@yahoo.fr>\");\nMODULE_DESCRIPTION(\"MAX1X27/MAX1X29/MAX1X31 ADC\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}