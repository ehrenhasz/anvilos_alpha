{
  "module_name": "ltc2497-core.c",
  "hash_id": "91c1dc94097f43a4badabf2a02bba2182b72d80e0a13c25b67bb5082b9cf0c99",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/adc/ltc2497-core.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/iio/iio.h>\n#include <linux/iio/driver.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/regulator/consumer.h>\n\n#include \"ltc2497.h\"\n\n#define LTC2497_SGL\t\t\tBIT(4)\n#define LTC2497_DIFF\t\t\t0\n#define LTC2497_SIGN\t\t\tBIT(3)\n\nstatic int ltc2497core_wait_conv(struct ltc2497core_driverdata *ddata)\n{\n\ts64 time_elapsed;\n\n\ttime_elapsed = ktime_ms_delta(ktime_get(), ddata->time_prev);\n\n\tif (time_elapsed < LTC2497_CONVERSION_TIME_MS) {\n\t\t \n\t\tif (msleep_interruptible(\n\t\t    LTC2497_CONVERSION_TIME_MS - time_elapsed))\n\t\t\treturn -ERESTARTSYS;\n\n\t\treturn 0;\n\t}\n\n\tif (time_elapsed - LTC2497_CONVERSION_TIME_MS <= 0) {\n\t\t \n\t\treturn 0;\n\t}\n\n\treturn 1;\n}\n\nstatic int ltc2497core_read(struct ltc2497core_driverdata *ddata, u8 address, int *val)\n{\n\tint ret;\n\n\tret = ltc2497core_wait_conv(ddata);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (ret || ddata->addr_prev != address) {\n\t\tret = ddata->result_and_measure(ddata, address, NULL);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tddata->addr_prev = address;\n\n\t\tif (msleep_interruptible(LTC2497_CONVERSION_TIME_MS))\n\t\t\treturn -ERESTARTSYS;\n\t}\n\n\tret = ddata->result_and_measure(ddata, address, val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tddata->time_prev = ktime_get();\n\n\treturn ret;\n}\n\nstatic int ltc2497core_read_raw(struct iio_dev *indio_dev,\n\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t    int *val, int *val2, long mask)\n{\n\tstruct ltc2497core_driverdata *ddata = iio_priv(indio_dev);\n\tint ret;\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tmutex_lock(&ddata->lock);\n\t\tret = ltc2497core_read(ddata, chan->address, val);\n\t\tmutex_unlock(&ddata->lock);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\treturn IIO_VAL_INT;\n\n\tcase IIO_CHAN_INFO_SCALE:\n\t\tret = regulator_get_voltage(ddata->ref);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\t*val = ret / 1000;\n\t\t*val2 = ddata->chip_info->resolution + 1;\n\n\t\treturn IIO_VAL_FRACTIONAL_LOG2;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\n#define LTC2497_CHAN(_chan, _addr, _ds_name) { \\\n\t.type = IIO_VOLTAGE, \\\n\t.indexed = 1, \\\n\t.channel = (_chan), \\\n\t.address = (_addr | (_chan / 2) | ((_chan & 1) ? LTC2497_SIGN : 0)), \\\n\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW), \\\n\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE), \\\n\t.datasheet_name = (_ds_name), \\\n}\n\n#define LTC2497_CHAN_DIFF(_chan, _addr) { \\\n\t.type = IIO_VOLTAGE, \\\n\t.indexed = 1, \\\n\t.channel = (_chan) * 2 + ((_addr) & LTC2497_SIGN ? 1 : 0), \\\n\t.channel2 = (_chan) * 2 + ((_addr) & LTC2497_SIGN ? 0 : 1),\\\n\t.address = (_addr | _chan), \\\n\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW), \\\n\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE), \\\n\t.differential = 1, \\\n}\n\nstatic const struct iio_chan_spec ltc2497core_channel[] = {\n\tLTC2497_CHAN(0, LTC2497_SGL, \"CH0\"),\n\tLTC2497_CHAN(1, LTC2497_SGL, \"CH1\"),\n\tLTC2497_CHAN(2, LTC2497_SGL, \"CH2\"),\n\tLTC2497_CHAN(3, LTC2497_SGL, \"CH3\"),\n\tLTC2497_CHAN(4, LTC2497_SGL, \"CH4\"),\n\tLTC2497_CHAN(5, LTC2497_SGL, \"CH5\"),\n\tLTC2497_CHAN(6, LTC2497_SGL, \"CH6\"),\n\tLTC2497_CHAN(7, LTC2497_SGL, \"CH7\"),\n\tLTC2497_CHAN(8, LTC2497_SGL, \"CH8\"),\n\tLTC2497_CHAN(9, LTC2497_SGL, \"CH9\"),\n\tLTC2497_CHAN(10, LTC2497_SGL, \"CH10\"),\n\tLTC2497_CHAN(11, LTC2497_SGL, \"CH11\"),\n\tLTC2497_CHAN(12, LTC2497_SGL, \"CH12\"),\n\tLTC2497_CHAN(13, LTC2497_SGL, \"CH13\"),\n\tLTC2497_CHAN(14, LTC2497_SGL, \"CH14\"),\n\tLTC2497_CHAN(15, LTC2497_SGL, \"CH15\"),\n\tLTC2497_CHAN_DIFF(0, LTC2497_DIFF),\n\tLTC2497_CHAN_DIFF(1, LTC2497_DIFF),\n\tLTC2497_CHAN_DIFF(2, LTC2497_DIFF),\n\tLTC2497_CHAN_DIFF(3, LTC2497_DIFF),\n\tLTC2497_CHAN_DIFF(4, LTC2497_DIFF),\n\tLTC2497_CHAN_DIFF(5, LTC2497_DIFF),\n\tLTC2497_CHAN_DIFF(6, LTC2497_DIFF),\n\tLTC2497_CHAN_DIFF(7, LTC2497_DIFF),\n\tLTC2497_CHAN_DIFF(0, LTC2497_DIFF | LTC2497_SIGN),\n\tLTC2497_CHAN_DIFF(1, LTC2497_DIFF | LTC2497_SIGN),\n\tLTC2497_CHAN_DIFF(2, LTC2497_DIFF | LTC2497_SIGN),\n\tLTC2497_CHAN_DIFF(3, LTC2497_DIFF | LTC2497_SIGN),\n\tLTC2497_CHAN_DIFF(4, LTC2497_DIFF | LTC2497_SIGN),\n\tLTC2497_CHAN_DIFF(5, LTC2497_DIFF | LTC2497_SIGN),\n\tLTC2497_CHAN_DIFF(6, LTC2497_DIFF | LTC2497_SIGN),\n\tLTC2497_CHAN_DIFF(7, LTC2497_DIFF | LTC2497_SIGN),\n};\n\nstatic const struct iio_info ltc2497core_info = {\n\t.read_raw = ltc2497core_read_raw,\n};\n\nint ltc2497core_probe(struct device *dev, struct iio_dev *indio_dev)\n{\n\tstruct ltc2497core_driverdata *ddata = iio_priv(indio_dev);\n\tint ret;\n\n\t \n\tif (ddata->chip_info->name)\n\t\tindio_dev->name = ddata->chip_info->name;\n\telse\n\t\tindio_dev->name = dev_name(dev);\n\n\tindio_dev->info = &ltc2497core_info;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->channels = ltc2497core_channel;\n\tindio_dev->num_channels = ARRAY_SIZE(ltc2497core_channel);\n\n\tret = ddata->result_and_measure(ddata, LTC2497_CONFIG_DEFAULT, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tddata->ref = devm_regulator_get(dev, \"vref\");\n\tif (IS_ERR(ddata->ref))\n\t\treturn dev_err_probe(dev, PTR_ERR(ddata->ref),\n\t\t\t\t     \"Failed to get vref regulator\\n\");\n\n\tret = regulator_enable(ddata->ref);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Failed to enable vref regulator: %pe\\n\",\n\t\t\tERR_PTR(ret));\n\t\treturn ret;\n\t}\n\n\tif (dev->platform_data) {\n\t\tstruct iio_map *plat_data;\n\n\t\tplat_data = (struct iio_map *)dev->platform_data;\n\n\t\tret = iio_map_array_register(indio_dev, plat_data);\n\t\tif (ret) {\n\t\t\tdev_err(&indio_dev->dev, \"iio map err: %d\\n\", ret);\n\t\t\tgoto err_regulator_disable;\n\t\t}\n\t}\n\n\tddata->addr_prev = LTC2497_CONFIG_DEFAULT;\n\tddata->time_prev = ktime_get();\n\n\tmutex_init(&ddata->lock);\n\n\tret = iio_device_register(indio_dev);\n\tif (ret < 0)\n\t\tgoto err_array_unregister;\n\n\treturn 0;\n\nerr_array_unregister:\n\tiio_map_array_unregister(indio_dev);\n\nerr_regulator_disable:\n\tregulator_disable(ddata->ref);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_NS(ltc2497core_probe, LTC2497);\n\nvoid ltc2497core_remove(struct iio_dev *indio_dev)\n{\n\tstruct ltc2497core_driverdata *ddata = iio_priv(indio_dev);\n\n\tiio_device_unregister(indio_dev);\n\n\tiio_map_array_unregister(indio_dev);\n\n\tregulator_disable(ddata->ref);\n}\nEXPORT_SYMBOL_NS(ltc2497core_remove, LTC2497);\n\nMODULE_DESCRIPTION(\"common code for LTC2496/LTC2497 drivers\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}