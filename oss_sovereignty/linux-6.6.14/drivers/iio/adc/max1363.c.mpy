{
  "module_name": "max1363.c",
  "hash_id": "89c81e5f007bc2d8738c551d834364c13f552eae9d4de8ff10104ac00ae8801b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/adc/max1363.c",
  "human_readable_source": "\n  \n\n#include <linux/interrupt.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/sysfs.h>\n#include <linux/list.h>\n#include <linux/i2c.h>\n#include <linux/regulator/consumer.h>\n#include <linux/slab.h>\n#include <linux/err.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/property.h>\n\n#include <linux/iio/iio.h>\n#include <linux/iio/sysfs.h>\n#include <linux/iio/events.h>\n#include <linux/iio/buffer.h>\n#include <linux/iio/kfifo_buf.h>\n#include <linux/iio/trigger_consumer.h>\n#include <linux/iio/triggered_buffer.h>\n\n#define MAX1363_SETUP_BYTE(a) ((a) | 0x80)\n\n \n\n \n \n#define MAX1363_SETUP_AIN3_IS_AIN3_REF_IS_VDD\t0x00\n#define MAX1363_SETUP_AIN3_IS_REF_EXT_TO_REF\t0x20\n#define MAX1363_SETUP_AIN3_IS_AIN3_REF_IS_INT\t0x40\n#define MAX1363_SETUP_AIN3_IS_REF_REF_IS_INT\t0x60\n#define MAX1363_SETUP_POWER_UP_INT_REF\t\t0x10\n#define MAX1363_SETUP_POWER_DOWN_INT_REF\t0x00\n\n \n#define MAX1363_SETUP_EXT_CLOCK\t\t\t0x08\n#define MAX1363_SETUP_INT_CLOCK\t\t\t0x00\n#define MAX1363_SETUP_UNIPOLAR\t\t\t0x00\n#define MAX1363_SETUP_BIPOLAR\t\t\t0x04\n#define MAX1363_SETUP_RESET\t\t\t0x00\n#define MAX1363_SETUP_NORESET\t\t\t0x02\n \n#define MAX1363_SETUP_MONITOR_SETUP\t\t0x01\n\n \n#define MAX1363_MON_RESET_CHAN(a) (1 << ((a) + 4))\n#define MAX1363_MON_INT_ENABLE\t\t\t0x01\n\n \n \n#define MAX1363_CONFIG_BYTE(a) ((a))\n\n#define MAX1363_CONFIG_SE\t\t\t0x01\n#define MAX1363_CONFIG_DE\t\t\t0x00\n#define MAX1363_CONFIG_SCAN_TO_CS\t\t0x00\n#define MAX1363_CONFIG_SCAN_SINGLE_8\t\t0x20\n#define MAX1363_CONFIG_SCAN_MONITOR_MODE\t0x40\n#define MAX1363_CONFIG_SCAN_SINGLE_1\t\t0x60\n \n#define MAX1236_SCAN_MID_TO_CHANNEL\t\t0x40\n\n \n#define MAX1363_CONFIG_EN_MON_MODE_READ 0x18\n\n#define MAX1363_CHANNEL_SEL(a) ((a) << 1)\n\n \n#define MAX1363_CHANNEL_SEL_MASK\t\t0x1E\n#define MAX1363_SCAN_MASK\t\t\t0x60\n#define MAX1363_SE_DE_MASK\t\t\t0x01\n\n#define MAX1363_MAX_CHANNELS 25\n \nstruct max1363_mode {\n\tint8_t\t\tconf;\n\tDECLARE_BITMAP(modemask, MAX1363_MAX_CHANNELS);\n};\n\n \nenum max1363_modes {\n\t \n\t_s0, _s1, _s2, _s3, _s4, _s5, _s6, _s7, _s8, _s9, _s10, _s11,\n\t \n\td0m1, d2m3, d4m5, d6m7, d8m9, d10m11,\n\td1m0, d3m2, d5m4, d7m6, d9m8, d11m10,\n\t \n\ts0to1, s0to2, s2to3, s0to3, s0to4, s0to5, s0to6,\n\ts6to7, s0to7, s6to8, s0to8, s6to9,\n\ts0to9, s6to10, s0to10, s6to11, s0to11,\n\t \n\td0m1to2m3, d0m1to4m5, d0m1to6m7, d6m7to8m9,\n\td0m1to8m9, d6m7to10m11, d0m1to10m11, d1m0to3m2,\n\td1m0to5m4, d1m0to7m6, d7m6to9m8, d1m0to9m8,\n\td7m6to11m10, d1m0to11m10,\n};\n\n \nstruct max1363_chip_info {\n\tconst struct iio_info\t\t*info;\n\tconst struct iio_chan_spec\t*channels;\n\tint\t\t\t\tnum_channels;\n\tconst enum max1363_modes\t*mode_list;\n\tenum max1363_modes\t\tdefault_mode;\n\tu16\t\t\t\tint_vref_mv;\n\tu8\t\t\t\tnum_modes;\n\tu8\t\t\t\tbits;\n};\n\n \nstruct max1363_state {\n\tstruct i2c_client\t\t*client;\n\tu8\t\t\t\tsetupbyte;\n\tu8\t\t\t\tconfigbyte;\n\tconst struct max1363_chip_info\t*chip_info;\n\tconst struct max1363_mode\t*current_mode;\n\tu32\t\t\t\trequestedmask;\n\tstruct mutex\t\t\tlock;\n\n\t \n\tbool\t\t\t\tmonitor_on;\n\tunsigned int\t\t\tmonitor_speed:3;\n\tu8\t\t\t\tmask_high;\n\tu8\t\t\t\tmask_low;\n\t \n\ts16\t\t\t\tthresh_high[8];\n\ts16\t\t\t\tthresh_low[8];\n\tstruct regulator\t\t*vref;\n\tu32\t\t\t\tvref_uv;\n\tint\t\t\t\t(*send)(const struct i2c_client *client,\n\t\t\t\t\t\tconst char *buf, int count);\n\tint\t\t\t\t(*recv)(const struct i2c_client *client,\n\t\t\t\t\t\tchar *buf, int count);\n};\n\n#define MAX1363_MODE_SINGLE(_num, _mask) {\t\t\t\t\\\n\t\t.conf = MAX1363_CHANNEL_SEL(_num)\t\t\t\\\n\t\t\t| MAX1363_CONFIG_SCAN_SINGLE_1\t\t\t\\\n\t\t\t| MAX1363_CONFIG_SE,\t\t\t\t\\\n\t\t\t.modemask[0] = _mask,\t\t\t\t\\\n\t\t\t}\n\n#define MAX1363_MODE_SCAN_TO_CHANNEL(_num, _mask) {\t\t\t\\\n\t\t.conf = MAX1363_CHANNEL_SEL(_num)\t\t\t\\\n\t\t\t| MAX1363_CONFIG_SCAN_TO_CS\t\t\t\\\n\t\t\t| MAX1363_CONFIG_SE,\t\t\t\t\\\n\t\t\t.modemask[0] = _mask,\t\t\t\t\\\n\t\t\t}\n\n \n#define MAX1236_MODE_SCAN_MID_TO_CHANNEL(_mid, _num, _mask) {\t\t\\\n\t\t.conf = MAX1363_CHANNEL_SEL(_num)\t\t\t\\\n\t\t\t| MAX1236_SCAN_MID_TO_CHANNEL\t\t\t\\\n\t\t\t| MAX1363_CONFIG_SE,\t\t\t\t\\\n\t\t\t.modemask[0] = _mask\t\t\t\t\\\n}\n\n#define MAX1363_MODE_DIFF_SINGLE(_nump, _numm, _mask) {\t\t\t\\\n\t\t.conf = MAX1363_CHANNEL_SEL(_nump)\t\t\t\\\n\t\t\t| MAX1363_CONFIG_SCAN_SINGLE_1\t\t\t\\\n\t\t\t| MAX1363_CONFIG_DE,\t\t\t\t\\\n\t\t\t.modemask[0] = _mask\t\t\t\t\\\n\t\t\t}\n\n \n#define MAX1363_MODE_DIFF_SCAN_TO_CHANNEL(_num, _numvals, _mask) {\t\\\n\t\t.conf = MAX1363_CHANNEL_SEL(_num)\t\t\t\\\n\t\t\t| MAX1363_CONFIG_SCAN_TO_CS\t\t\t\\\n\t\t\t| MAX1363_CONFIG_DE,\t\t\t\t\\\n\t\t\t.modemask[0] = _mask\t\t\t\t\\\n\t\t\t}\n\n \n#define MAX1236_MODE_DIFF_SCAN_MID_TO_CHANNEL(_num, _numvals, _mask) {\t\\\n\t\t.conf = MAX1363_CHANNEL_SEL(_num)\t\t\t\\\n\t\t\t| MAX1236_SCAN_MID_TO_CHANNEL\t\t\t\\\n\t\t\t| MAX1363_CONFIG_SE,\t\t\t\t\\\n\t\t\t.modemask[0] = _mask\t\t\t\t\\\n}\n\nstatic const struct max1363_mode max1363_mode_table[] = {\n\t \n\tMAX1363_MODE_SINGLE(0, 1 << 0),\n\tMAX1363_MODE_SINGLE(1, 1 << 1),\n\tMAX1363_MODE_SINGLE(2, 1 << 2),\n\tMAX1363_MODE_SINGLE(3, 1 << 3),\n\tMAX1363_MODE_SINGLE(4, 1 << 4),\n\tMAX1363_MODE_SINGLE(5, 1 << 5),\n\tMAX1363_MODE_SINGLE(6, 1 << 6),\n\tMAX1363_MODE_SINGLE(7, 1 << 7),\n\tMAX1363_MODE_SINGLE(8, 1 << 8),\n\tMAX1363_MODE_SINGLE(9, 1 << 9),\n\tMAX1363_MODE_SINGLE(10, 1 << 10),\n\tMAX1363_MODE_SINGLE(11, 1 << 11),\n\n\tMAX1363_MODE_DIFF_SINGLE(0, 1, 1 << 12),\n\tMAX1363_MODE_DIFF_SINGLE(2, 3, 1 << 13),\n\tMAX1363_MODE_DIFF_SINGLE(4, 5, 1 << 14),\n\tMAX1363_MODE_DIFF_SINGLE(6, 7, 1 << 15),\n\tMAX1363_MODE_DIFF_SINGLE(8, 9, 1 << 16),\n\tMAX1363_MODE_DIFF_SINGLE(10, 11, 1 << 17),\n\tMAX1363_MODE_DIFF_SINGLE(1, 0, 1 << 18),\n\tMAX1363_MODE_DIFF_SINGLE(3, 2, 1 << 19),\n\tMAX1363_MODE_DIFF_SINGLE(5, 4, 1 << 20),\n\tMAX1363_MODE_DIFF_SINGLE(7, 6, 1 << 21),\n\tMAX1363_MODE_DIFF_SINGLE(9, 8, 1 << 22),\n\tMAX1363_MODE_DIFF_SINGLE(11, 10, 1 << 23),\n\n\t \n\tMAX1363_MODE_SCAN_TO_CHANNEL(1, 0x003),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(2, 0x007),\n\tMAX1236_MODE_SCAN_MID_TO_CHANNEL(2, 3, 0x00C),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(3, 0x00F),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(4, 0x01F),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(5, 0x03F),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(6, 0x07F),\n\tMAX1236_MODE_SCAN_MID_TO_CHANNEL(6, 7, 0x0C0),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(7, 0x0FF),\n\tMAX1236_MODE_SCAN_MID_TO_CHANNEL(6, 8, 0x1C0),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(8, 0x1FF),\n\tMAX1236_MODE_SCAN_MID_TO_CHANNEL(6, 9, 0x3C0),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(9, 0x3FF),\n\tMAX1236_MODE_SCAN_MID_TO_CHANNEL(6, 10, 0x7C0),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(10, 0x7FF),\n\tMAX1236_MODE_SCAN_MID_TO_CHANNEL(6, 11, 0xFC0),\n\tMAX1363_MODE_SCAN_TO_CHANNEL(11, 0xFFF),\n\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(2, 2, 0x003000),\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(4, 3, 0x007000),\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(6, 4, 0x00F000),\n\tMAX1236_MODE_DIFF_SCAN_MID_TO_CHANNEL(8, 2, 0x018000),\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(8, 5, 0x01F000),\n\tMAX1236_MODE_DIFF_SCAN_MID_TO_CHANNEL(10, 3, 0x038000),\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(10, 6, 0x3F000),\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(3, 2, 0x0C0000),\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(5, 3, 0x1C0000),\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(7, 4, 0x3C0000),\n\tMAX1236_MODE_DIFF_SCAN_MID_TO_CHANNEL(9, 2, 0x600000),\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(9, 5, 0x7C0000),\n\tMAX1236_MODE_DIFF_SCAN_MID_TO_CHANNEL(11, 3, 0xE00000),\n\tMAX1363_MODE_DIFF_SCAN_TO_CHANNEL(11, 6, 0xFC0000),\n};\n\nstatic const struct max1363_mode\n*max1363_match_mode(const unsigned long *mask,\n\tconst struct max1363_chip_info *ci)\n{\n\tint i;\n\tif (mask)\n\t\tfor (i = 0; i < ci->num_modes; i++)\n\t\t\tif (bitmap_subset(mask,\n\t\t\t\t\t  max1363_mode_table[ci->mode_list[i]].\n\t\t\t\t\t  modemask,\n\t\t\t\t\t  MAX1363_MAX_CHANNELS))\n\t\t\t\treturn &max1363_mode_table[ci->mode_list[i]];\n\treturn NULL;\n}\n\nstatic int max1363_smbus_send(const struct i2c_client *client, const char *buf,\n\t\tint count)\n{\n\tint i, err;\n\n\tfor (i = err = 0; err == 0 && i < count; ++i)\n\t\terr = i2c_smbus_write_byte(client, buf[i]);\n\n\treturn err ? err : count;\n}\n\nstatic int max1363_smbus_recv(const struct i2c_client *client, char *buf,\n\t\tint count)\n{\n\tint i, ret;\n\n\tfor (i = 0; i < count; ++i) {\n\t\tret = i2c_smbus_read_byte(client);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbuf[i] = ret;\n\t}\n\n\treturn count;\n}\n\nstatic int max1363_write_basic_config(struct max1363_state *st)\n{\n\tu8 tx_buf[2] = { st->setupbyte, st->configbyte };\n\n\treturn st->send(st->client, tx_buf, 2);\n}\n\nstatic int max1363_set_scan_mode(struct max1363_state *st)\n{\n\tst->configbyte &= ~(MAX1363_CHANNEL_SEL_MASK\n\t\t\t    | MAX1363_SCAN_MASK\n\t\t\t    | MAX1363_SE_DE_MASK);\n\tst->configbyte |= st->current_mode->conf;\n\n\treturn max1363_write_basic_config(st);\n}\n\nstatic int max1363_read_single_chan(struct iio_dev *indio_dev,\n\t\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t\t    int *val,\n\t\t\t\t    long m)\n{\n\tint ret = 0;\n\ts32 data;\n\tu8 rxbuf[2];\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\tstruct i2c_client *client = st->client;\n\n\tret = iio_device_claim_direct_mode(indio_dev);\n\tif (ret)\n\t\treturn ret;\n\tmutex_lock(&st->lock);\n\n\t \n\tif (st->monitor_on) {\n\t\tret = -EBUSY;\n\t\tgoto error_ret;\n\t}\n\n\t \n\tif (st->current_mode != &max1363_mode_table[chan->address]) {\n\t\t \n\t\tst->current_mode = &max1363_mode_table[chan->address];\n\t\tret = max1363_set_scan_mode(st);\n\t\tif (ret < 0)\n\t\t\tgoto error_ret;\n\t}\n\tif (st->chip_info->bits != 8) {\n\t\t \n\t\tdata = st->recv(client, rxbuf, 2);\n\t\tif (data < 0) {\n\t\t\tret = data;\n\t\t\tgoto error_ret;\n\t\t}\n\t\tdata = (rxbuf[1] | rxbuf[0] << 8) &\n\t\t  ((1 << st->chip_info->bits) - 1);\n\t} else {\n\t\t \n\t\tdata = st->recv(client, rxbuf, 1);\n\t\tif (data < 0) {\n\t\t\tret = data;\n\t\t\tgoto error_ret;\n\t\t}\n\t\tdata = rxbuf[0];\n\t}\n\t*val = data;\n\nerror_ret:\n\tmutex_unlock(&st->lock);\n\tiio_device_release_direct_mode(indio_dev);\n\treturn ret;\n\n}\n\nstatic int max1363_read_raw(struct iio_dev *indio_dev,\n\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t    int *val,\n\t\t\t    int *val2,\n\t\t\t    long m)\n{\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\tint ret;\n\n\tswitch (m) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tret = max1363_read_single_chan(indio_dev, chan, val, m);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\treturn IIO_VAL_INT;\n\tcase IIO_CHAN_INFO_SCALE:\n\t\t*val = st->vref_uv / 1000;\n\t\t*val2 = st->chip_info->bits;\n\t\treturn IIO_VAL_FRACTIONAL_LOG2;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\n \nstatic const enum max1363_modes max1363_mode_list[] = {\n\t_s0, _s1, _s2, _s3,\n\ts0to1, s0to2, s0to3,\n\td0m1, d2m3, d1m0, d3m2,\n\td0m1to2m3, d1m0to3m2,\n};\n\nstatic const struct iio_event_spec max1363_events[] = {\n\t{\n\t\t.type = IIO_EV_TYPE_THRESH,\n\t\t.dir = IIO_EV_DIR_RISING,\n\t\t.mask_separate = BIT(IIO_EV_INFO_VALUE) |\n\t\t\tBIT(IIO_EV_INFO_ENABLE),\n\t}, {\n\t\t.type = IIO_EV_TYPE_THRESH,\n\t\t.dir = IIO_EV_DIR_FALLING,\n\t\t.mask_separate = BIT(IIO_EV_INFO_VALUE) |\n\t\t\tBIT(IIO_EV_INFO_ENABLE),\n\t},\n};\n\n#define MAX1363_CHAN_U(num, addr, si, bits, ev_spec, num_ev_spec)\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.type = IIO_VOLTAGE,\t\t\t\t\t\\\n\t\t.indexed = 1,\t\t\t\t\t\t\\\n\t\t.channel = num,\t\t\t\t\t\t\\\n\t\t.address = addr,\t\t\t\t\t\\\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW),\t\t\\\n\t\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE),\t\\\n\t\t.datasheet_name = \"AIN\"#num,\t\t\t\t\\\n\t\t.scan_type = {\t\t\t\t\t\t\\\n\t\t\t.sign = 'u',\t\t\t\t\t\\\n\t\t\t.realbits = bits,\t\t\t\t\\\n\t\t\t.storagebits = (bits > 8) ? 16 : 8,\t\t\\\n\t\t\t.endianness = IIO_BE,\t\t\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.scan_index = si,\t\t\t\t\t\\\n\t\t.event_spec = ev_spec,\t\t\t\t\t\\\n\t\t.num_event_specs = num_ev_spec,\t\t\t\t\\\n\t}\n\n \n#define MAX1363_CHAN_B(num, num2, addr, si, bits, ev_spec, num_ev_spec)\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.type = IIO_VOLTAGE,\t\t\t\t\t\\\n\t\t.differential = 1,\t\t\t\t\t\\\n\t\t.indexed = 1,\t\t\t\t\t\t\\\n\t\t.channel = num,\t\t\t\t\t\t\\\n\t\t.channel2 = num2,\t\t\t\t\t\\\n\t\t.address = addr,\t\t\t\t\t\\\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW),\t\t\\\n\t\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE),\t\\\n\t\t.datasheet_name = \"AIN\"#num\"-AIN\"#num2,\t\t\t\\\n\t\t.scan_type = {\t\t\t\t\t\t\\\n\t\t\t.sign = 's',\t\t\t\t\t\\\n\t\t\t.realbits = bits,\t\t\t\t\\\n\t\t\t.storagebits = (bits > 8) ? 16 : 8,\t\t\\\n\t\t\t.endianness = IIO_BE,\t\t\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.scan_index = si,\t\t\t\t\t\\\n\t\t.event_spec = ev_spec,\t\t\t\t\t\\\n\t\t.num_event_specs = num_ev_spec,\t\t\t\t\\\n\t}\n\n#define MAX1363_4X_CHANS(bits, ev_spec, num_ev_spec) {\t\t\t\\\n\tMAX1363_CHAN_U(0, _s0, 0, bits, ev_spec, num_ev_spec),\t\t\\\n\tMAX1363_CHAN_U(1, _s1, 1, bits, ev_spec, num_ev_spec),\t\t\\\n\tMAX1363_CHAN_U(2, _s2, 2, bits, ev_spec, num_ev_spec),\t\t\\\n\tMAX1363_CHAN_U(3, _s3, 3, bits, ev_spec, num_ev_spec),\t\t\\\n\tMAX1363_CHAN_B(0, 1, d0m1, 4, bits, ev_spec, num_ev_spec),\t\\\n\tMAX1363_CHAN_B(2, 3, d2m3, 5, bits, ev_spec, num_ev_spec),\t\\\n\tMAX1363_CHAN_B(1, 0, d1m0, 6, bits, ev_spec, num_ev_spec),\t\\\n\tMAX1363_CHAN_B(3, 2, d3m2, 7, bits, ev_spec, num_ev_spec),\t\\\n\tIIO_CHAN_SOFT_TIMESTAMP(8)\t\t\t\t\t\\\n\t}\n\nstatic const struct iio_chan_spec max1036_channels[] =\n\tMAX1363_4X_CHANS(8, NULL, 0);\nstatic const struct iio_chan_spec max1136_channels[] =\n\tMAX1363_4X_CHANS(10, NULL, 0);\nstatic const struct iio_chan_spec max1236_channels[] =\n\tMAX1363_4X_CHANS(12, NULL, 0);\nstatic const struct iio_chan_spec max1361_channels[] =\n\tMAX1363_4X_CHANS(10, max1363_events, ARRAY_SIZE(max1363_events));\nstatic const struct iio_chan_spec max1363_channels[] =\n\tMAX1363_4X_CHANS(12, max1363_events, ARRAY_SIZE(max1363_events));\n\n \nstatic const enum max1363_modes max1236_mode_list[] = {\n\t_s0, _s1, _s2, _s3,\n\ts0to1, s0to2, s0to3,\n\td0m1, d2m3, d1m0, d3m2,\n\td0m1to2m3, d1m0to3m2,\n\ts2to3,\n};\n\n \nstatic const enum max1363_modes max1238_mode_list[] = {\n\t_s0, _s1, _s2, _s3, _s4, _s5, _s6, _s7, _s8, _s9, _s10, _s11,\n\ts0to1, s0to2, s0to3, s0to4, s0to5, s0to6,\n\ts0to7, s0to8, s0to9, s0to10, s0to11,\n\td0m1, d2m3, d4m5, d6m7, d8m9, d10m11,\n\td1m0, d3m2, d5m4, d7m6, d9m8, d11m10,\n\td0m1to2m3, d0m1to4m5, d0m1to6m7, d0m1to8m9, d0m1to10m11,\n\td1m0to3m2, d1m0to5m4, d1m0to7m6, d1m0to9m8, d1m0to11m10,\n\ts6to7, s6to8, s6to9, s6to10, s6to11,\n\td6m7to8m9, d6m7to10m11, d7m6to9m8, d7m6to11m10,\n};\n\n#define MAX1363_12X_CHANS(bits) {\t\t\t\t\\\n\tMAX1363_CHAN_U(0, _s0, 0, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(1, _s1, 1, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(2, _s2, 2, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(3, _s3, 3, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(4, _s4, 4, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(5, _s5, 5, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(6, _s6, 6, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(7, _s7, 7, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(8, _s8, 8, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(9, _s9, 9, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(10, _s10, 10, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_U(11, _s11, 11, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(0, 1, d0m1, 12, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(2, 3, d2m3, 13, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(4, 5, d4m5, 14, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(6, 7, d6m7, 15, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(8, 9, d8m9, 16, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(10, 11, d10m11, 17, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(1, 0, d1m0, 18, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(3, 2, d3m2, 19, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(5, 4, d5m4, 20, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(7, 6, d7m6, 21, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(9, 8, d9m8, 22, bits, NULL, 0),\t\t\\\n\tMAX1363_CHAN_B(11, 10, d11m10, 23, bits, NULL, 0),\t\\\n\tIIO_CHAN_SOFT_TIMESTAMP(24)\t\t\t\t\\\n\t}\nstatic const struct iio_chan_spec max1038_channels[] = MAX1363_12X_CHANS(8);\nstatic const struct iio_chan_spec max1138_channels[] = MAX1363_12X_CHANS(10);\nstatic const struct iio_chan_spec max1238_channels[] = MAX1363_12X_CHANS(12);\n\nstatic const enum max1363_modes max11607_mode_list[] = {\n\t_s0, _s1, _s2, _s3,\n\ts0to1, s0to2, s0to3,\n\ts2to3,\n\td0m1, d2m3, d1m0, d3m2,\n\td0m1to2m3, d1m0to3m2,\n};\n\nstatic const enum max1363_modes max11608_mode_list[] = {\n\t_s0, _s1, _s2, _s3, _s4, _s5, _s6, _s7,\n\ts0to1, s0to2, s0to3, s0to4, s0to5, s0to6, s0to7,\n\ts6to7,\n\td0m1, d2m3, d4m5, d6m7,\n\td1m0, d3m2, d5m4, d7m6,\n\td0m1to2m3, d0m1to4m5, d0m1to6m7,\n\td1m0to3m2, d1m0to5m4, d1m0to7m6,\n};\n\n#define MAX1363_8X_CHANS(bits) {\t\t\t\\\n\tMAX1363_CHAN_U(0, _s0, 0, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_U(1, _s1, 1, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_U(2, _s2, 2, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_U(3, _s3, 3, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_U(4, _s4, 4, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_U(5, _s5, 5, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_U(6, _s6, 6, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_U(7, _s7, 7, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(0, 1, d0m1, 8, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(2, 3, d2m3, 9, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(4, 5, d4m5, 10, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(6, 7, d6m7, 11, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(1, 0, d1m0, 12, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(3, 2, d3m2, 13, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(5, 4, d5m4, 14, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(7, 6, d7m6, 15, bits, NULL, 0),\t\\\n\tIIO_CHAN_SOFT_TIMESTAMP(16)\t\t\t\\\n}\nstatic const struct iio_chan_spec max11602_channels[] = MAX1363_8X_CHANS(8);\nstatic const struct iio_chan_spec max11608_channels[] = MAX1363_8X_CHANS(10);\nstatic const struct iio_chan_spec max11614_channels[] = MAX1363_8X_CHANS(12);\n\nstatic const enum max1363_modes max11644_mode_list[] = {\n\t_s0, _s1, s0to1, d0m1, d1m0,\n};\n\n#define MAX1363_2X_CHANS(bits) {\t\t\t\\\n\tMAX1363_CHAN_U(0, _s0, 0, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_U(1, _s1, 1, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(0, 1, d0m1, 2, bits, NULL, 0),\t\\\n\tMAX1363_CHAN_B(1, 0, d1m0, 3, bits, NULL, 0),\t\\\n\tIIO_CHAN_SOFT_TIMESTAMP(4)\t\t\t\\\n\t}\n\nstatic const struct iio_chan_spec max11646_channels[] = MAX1363_2X_CHANS(10);\nstatic const struct iio_chan_spec max11644_channels[] = MAX1363_2X_CHANS(12);\n\nenum { max1361,\n       max1362,\n       max1363,\n       max1364,\n       max1036,\n       max1037,\n       max1038,\n       max1039,\n       max1136,\n       max1137,\n       max1138,\n       max1139,\n       max1236,\n       max1237,\n       max1238,\n       max1239,\n       max11600,\n       max11601,\n       max11602,\n       max11603,\n       max11604,\n       max11605,\n       max11606,\n       max11607,\n       max11608,\n       max11609,\n       max11610,\n       max11611,\n       max11612,\n       max11613,\n       max11614,\n       max11615,\n       max11616,\n       max11617,\n       max11644,\n       max11645,\n       max11646,\n       max11647\n};\n\nstatic const int max1363_monitor_speeds[] = { 133000, 665000, 33300, 16600,\n\t\t\t\t\t      8300, 4200, 2000, 1000 };\n\nstatic ssize_t max1363_monitor_show_freq(struct device *dev,\n\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\tchar *buf)\n{\n\tstruct max1363_state *st = iio_priv(dev_to_iio_dev(dev));\n\treturn sprintf(buf, \"%d\\n\", max1363_monitor_speeds[st->monitor_speed]);\n}\n\nstatic ssize_t max1363_monitor_store_freq(struct device *dev,\n\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\tconst char *buf,\n\t\t\t\t\tsize_t len)\n{\n\tstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\tint i, ret;\n\tunsigned long val;\n\tbool found = false;\n\n\tret = kstrtoul(buf, 10, &val);\n\tif (ret)\n\t\treturn -EINVAL;\n\tfor (i = 0; i < ARRAY_SIZE(max1363_monitor_speeds); i++)\n\t\tif (val == max1363_monitor_speeds[i]) {\n\t\t\tfound = true;\n\t\t\tbreak;\n\t\t}\n\tif (!found)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&st->lock);\n\tst->monitor_speed = i;\n\tmutex_unlock(&st->lock);\n\n\treturn 0;\n}\n\nstatic IIO_DEV_ATTR_SAMP_FREQ(S_IRUGO | S_IWUSR,\n\t\t\tmax1363_monitor_show_freq,\n\t\t\tmax1363_monitor_store_freq);\n\nstatic IIO_CONST_ATTR(sampling_frequency_available,\n\t\t\"133000 665000 33300 16600 8300 4200 2000 1000\");\n\nstatic int max1363_read_thresh(struct iio_dev *indio_dev,\n\tconst struct iio_chan_spec *chan, enum iio_event_type type,\n\tenum iio_event_direction dir, enum iio_event_info info, int *val,\n\tint *val2)\n{\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\tif (dir == IIO_EV_DIR_FALLING)\n\t\t*val = st->thresh_low[chan->channel];\n\telse\n\t\t*val = st->thresh_high[chan->channel];\n\treturn IIO_VAL_INT;\n}\n\nstatic int max1363_write_thresh(struct iio_dev *indio_dev,\n\tconst struct iio_chan_spec *chan, enum iio_event_type type,\n\tenum iio_event_direction dir, enum iio_event_info info, int val,\n\tint val2)\n{\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\t \n\tswitch (st->chip_info->bits) {\n\tcase 10:\n\t\tif (val > 0x3FF)\n\t\t\treturn -EINVAL;\n\t\tbreak;\n\tcase 12:\n\t\tif (val > 0xFFF)\n\t\t\treturn -EINVAL;\n\t\tbreak;\n\t}\n\n\tswitch (dir) {\n\tcase IIO_EV_DIR_FALLING:\n\t\tst->thresh_low[chan->channel] = val;\n\t\tbreak;\n\tcase IIO_EV_DIR_RISING:\n\t\tst->thresh_high[chan->channel] = val;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const u64 max1363_event_codes[] = {\n\tIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 0,\n\t\t\t     IIO_EV_TYPE_THRESH, IIO_EV_DIR_FALLING),\n\tIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 1,\n\t\t\t     IIO_EV_TYPE_THRESH, IIO_EV_DIR_FALLING),\n\tIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 2,\n\t\t\t     IIO_EV_TYPE_THRESH, IIO_EV_DIR_FALLING),\n\tIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 3,\n\t\t\t     IIO_EV_TYPE_THRESH, IIO_EV_DIR_FALLING),\n\tIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 0,\n\t\t\t     IIO_EV_TYPE_THRESH, IIO_EV_DIR_RISING),\n\tIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 1,\n\t\t\t     IIO_EV_TYPE_THRESH, IIO_EV_DIR_RISING),\n\tIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 2,\n\t\t\t     IIO_EV_TYPE_THRESH, IIO_EV_DIR_RISING),\n\tIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 3,\n\t\t\t     IIO_EV_TYPE_THRESH, IIO_EV_DIR_RISING),\n};\n\nstatic irqreturn_t max1363_event_handler(int irq, void *private)\n{\n\tstruct iio_dev *indio_dev = private;\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\ts64 timestamp = iio_get_time_ns(indio_dev);\n\tunsigned long mask, loc;\n\tu8 rx;\n\tu8 tx[2] = { st->setupbyte,\n\t\t     MAX1363_MON_INT_ENABLE | (st->monitor_speed << 1) | 0xF0 };\n\n\tst->recv(st->client, &rx, 1);\n\tmask = rx;\n\tfor_each_set_bit(loc, &mask, 8)\n\t\tiio_push_event(indio_dev, max1363_event_codes[loc], timestamp);\n\tst->send(st->client, tx, 2);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int max1363_read_event_config(struct iio_dev *indio_dev,\n\tconst struct iio_chan_spec *chan, enum iio_event_type type,\n\tenum iio_event_direction dir)\n{\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\tint val;\n\tint number = chan->channel;\n\n\tmutex_lock(&st->lock);\n\tif (dir == IIO_EV_DIR_FALLING)\n\t\tval = (1 << number) & st->mask_low;\n\telse\n\t\tval = (1 << number) & st->mask_high;\n\tmutex_unlock(&st->lock);\n\n\treturn val;\n}\n\nstatic int max1363_monitor_mode_update(struct max1363_state *st, int enabled)\n{\n\tu8 *tx_buf;\n\tint ret, i = 3, j;\n\tunsigned long numelements;\n\tint len;\n\tconst long *modemask;\n\n\tif (!enabled) {\n\t\t \n\t\tst->setupbyte &= ~MAX1363_SETUP_MONITOR_SETUP;\n\t\tst->configbyte &= ~MAX1363_SCAN_MASK;\n\t\tst->monitor_on = false;\n\t\treturn max1363_write_basic_config(st);\n\t}\n\n\t \n\tst->setupbyte |= MAX1363_SETUP_MONITOR_SETUP;\n\tst->configbyte &= ~(MAX1363_CHANNEL_SEL_MASK\n\t\t\t    | MAX1363_SCAN_MASK\n\t\t\t| MAX1363_SE_DE_MASK);\n\tst->configbyte |= MAX1363_CONFIG_SCAN_MONITOR_MODE;\n\tif ((st->mask_low | st->mask_high) & 0x0F) {\n\t\tst->configbyte |= max1363_mode_table[s0to3].conf;\n\t\tmodemask = max1363_mode_table[s0to3].modemask;\n\t} else if ((st->mask_low | st->mask_high) & 0x30) {\n\t\tst->configbyte |= max1363_mode_table[d0m1to2m3].conf;\n\t\tmodemask = max1363_mode_table[d0m1to2m3].modemask;\n\t} else {\n\t\tst->configbyte |= max1363_mode_table[d1m0to3m2].conf;\n\t\tmodemask = max1363_mode_table[d1m0to3m2].modemask;\n\t}\n\tnumelements = bitmap_weight(modemask, MAX1363_MAX_CHANNELS);\n\tlen = 3 * numelements + 3;\n\ttx_buf = kmalloc(len, GFP_KERNEL);\n\tif (!tx_buf) {\n\t\tret = -ENOMEM;\n\t\tgoto error_ret;\n\t}\n\ttx_buf[0] = st->configbyte;\n\ttx_buf[1] = st->setupbyte;\n\ttx_buf[2] = (st->monitor_speed << 1);\n\n\t \n\tfor (j = 0; j < 8; j++)\n\t\tif (test_bit(j, modemask)) {\n\t\t\t \n\t\t\tif (st->mask_low & (1 << j)) {\n\t\t\t\ttx_buf[i] = (st->thresh_low[j] >> 4) & 0xFF;\n\t\t\t\ttx_buf[i + 1] = (st->thresh_low[j] << 4) & 0xF0;\n\t\t\t} else if (j < 4) {\n\t\t\t\ttx_buf[i] = 0;\n\t\t\t\ttx_buf[i + 1] = 0;\n\t\t\t} else {\n\t\t\t\ttx_buf[i] = 0x80;\n\t\t\t\ttx_buf[i + 1] = 0;\n\t\t\t}\n\t\t\tif (st->mask_high & (1 << j)) {\n\t\t\t\ttx_buf[i + 1] |=\n\t\t\t\t\t(st->thresh_high[j] >> 8) & 0x0F;\n\t\t\t\ttx_buf[i + 2] = st->thresh_high[j] & 0xFF;\n\t\t\t} else if (j < 4) {\n\t\t\t\ttx_buf[i + 1] |= 0x0F;\n\t\t\t\ttx_buf[i + 2] = 0xFF;\n\t\t\t} else {\n\t\t\t\ttx_buf[i + 1] |= 0x07;\n\t\t\t\ttx_buf[i + 2] = 0xFF;\n\t\t\t}\n\t\t\ti += 3;\n\t\t}\n\n\n\tret = st->send(st->client, tx_buf, len);\n\tif (ret < 0)\n\t\tgoto error_ret;\n\tif (ret != len) {\n\t\tret = -EIO;\n\t\tgoto error_ret;\n\t}\n\n\t \n\ttx_buf[0] = st->setupbyte;\n\ttx_buf[1] = MAX1363_MON_INT_ENABLE | (st->monitor_speed << 1) | 0xF0;\n\tret = st->send(st->client, tx_buf, 2);\n\tif (ret < 0)\n\t\tgoto error_ret;\n\tif (ret != 2) {\n\t\tret = -EIO;\n\t\tgoto error_ret;\n\t}\n\tret = 0;\n\tst->monitor_on = true;\nerror_ret:\n\n\tkfree(tx_buf);\n\n\treturn ret;\n}\n\n \n\nstatic inline int __max1363_check_event_mask(int thismask, int checkmask)\n{\n\tint ret = 0;\n\t \n\tif (thismask < 4) {\n\t\tif (checkmask & ~0x0F) {\n\t\t\tret = -EBUSY;\n\t\t\tgoto error_ret;\n\t\t}\n\t} else if (thismask < 6) {\n\t\tif (checkmask & ~0x30) {\n\t\t\tret = -EBUSY;\n\t\t\tgoto error_ret;\n\t\t}\n\t} else if (checkmask & ~0xC0)\n\t\tret = -EBUSY;\nerror_ret:\n\treturn ret;\n}\n\nstatic int max1363_write_event_config(struct iio_dev *indio_dev,\n\tconst struct iio_chan_spec *chan, enum iio_event_type type,\n\tenum iio_event_direction dir, int state)\n{\n\tint ret = 0;\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\tu16 unifiedmask;\n\tint number = chan->channel;\n\n\tret = iio_device_claim_direct_mode(indio_dev);\n\tif (ret)\n\t\treturn ret;\n\tmutex_lock(&st->lock);\n\n\tunifiedmask = st->mask_low | st->mask_high;\n\tif (dir == IIO_EV_DIR_FALLING) {\n\n\t\tif (state == 0)\n\t\t\tst->mask_low &= ~(1 << number);\n\t\telse {\n\t\t\tret = __max1363_check_event_mask((1 << number),\n\t\t\t\t\t\t\t unifiedmask);\n\t\t\tif (ret)\n\t\t\t\tgoto error_ret;\n\t\t\tst->mask_low |= (1 << number);\n\t\t}\n\t} else {\n\t\tif (state == 0)\n\t\t\tst->mask_high &= ~(1 << number);\n\t\telse {\n\t\t\tret = __max1363_check_event_mask((1 << number),\n\t\t\t\t\t\t\t unifiedmask);\n\t\t\tif (ret)\n\t\t\t\tgoto error_ret;\n\t\t\tst->mask_high |= (1 << number);\n\t\t}\n\t}\n\n\tmax1363_monitor_mode_update(st, !!(st->mask_high | st->mask_low));\nerror_ret:\n\tmutex_unlock(&st->lock);\n\tiio_device_release_direct_mode(indio_dev);\n\n\treturn ret;\n}\n\n \nstatic struct attribute *max1363_event_attributes[] = {\n\t&iio_dev_attr_sampling_frequency.dev_attr.attr,\n\t&iio_const_attr_sampling_frequency_available.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group max1363_event_attribute_group = {\n\t.attrs = max1363_event_attributes,\n};\n\nstatic int max1363_update_scan_mode(struct iio_dev *indio_dev,\n\t\t\t\t    const unsigned long *scan_mask)\n{\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\n\t \n\tst->current_mode = max1363_match_mode(scan_mask, st->chip_info);\n\tif (!st->current_mode)\n\t\treturn -EINVAL;\n\tmax1363_set_scan_mode(st);\n\treturn 0;\n}\n\nstatic const struct iio_info max1238_info = {\n\t.read_raw = &max1363_read_raw,\n\t.update_scan_mode = &max1363_update_scan_mode,\n};\n\nstatic const struct iio_info max1363_info = {\n\t.read_event_value = &max1363_read_thresh,\n\t.write_event_value = &max1363_write_thresh,\n\t.read_event_config = &max1363_read_event_config,\n\t.write_event_config = &max1363_write_event_config,\n\t.read_raw = &max1363_read_raw,\n\t.update_scan_mode = &max1363_update_scan_mode,\n\t.event_attrs = &max1363_event_attribute_group,\n};\n\n \nstatic const struct max1363_chip_info max1363_chip_info_tbl[] = {\n\t[max1361] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1363_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1363_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.channels = max1361_channels,\n\t\t.num_channels = ARRAY_SIZE(max1361_channels),\n\t\t.info = &max1363_info,\n\t},\n\t[max1362] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1363_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1363_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.channels = max1361_channels,\n\t\t.num_channels = ARRAY_SIZE(max1361_channels),\n\t\t.info = &max1363_info,\n\t},\n\t[max1363] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1363_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1363_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.channels = max1363_channels,\n\t\t.num_channels = ARRAY_SIZE(max1363_channels),\n\t\t.info = &max1363_info,\n\t},\n\t[max1364] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1363_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1363_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.channels = max1363_channels,\n\t\t.num_channels = ARRAY_SIZE(max1363_channels),\n\t\t.info = &max1363_info,\n\t},\n\t[max1036] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1236_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1236_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1036_channels,\n\t\t.num_channels = ARRAY_SIZE(max1036_channels),\n\t},\n\t[max1037] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1236_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1236_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1036_channels,\n\t\t.num_channels = ARRAY_SIZE(max1036_channels),\n\t},\n\t[max1038] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1038_channels,\n\t\t.num_channels = ARRAY_SIZE(max1038_channels),\n\t},\n\t[max1039] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1038_channels,\n\t\t.num_channels = ARRAY_SIZE(max1038_channels),\n\t},\n\t[max1136] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1236_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1236_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1136_channels,\n\t\t.num_channels = ARRAY_SIZE(max1136_channels),\n\t},\n\t[max1137] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1236_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1236_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1136_channels,\n\t\t.num_channels = ARRAY_SIZE(max1136_channels),\n\t},\n\t[max1138] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1138_channels,\n\t\t.num_channels = ARRAY_SIZE(max1138_channels),\n\t},\n\t[max1139] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1138_channels,\n\t\t.num_channels = ARRAY_SIZE(max1138_channels),\n\t},\n\t[max1236] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1236_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1236_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1236_channels,\n\t\t.num_channels = ARRAY_SIZE(max1236_channels),\n\t},\n\t[max1237] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1236_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1236_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1236_channels,\n\t\t.num_channels = ARRAY_SIZE(max1236_channels),\n\t},\n\t[max1238] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1238_channels,\n\t\t.num_channels = ARRAY_SIZE(max1238_channels),\n\t},\n\t[max1239] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1238_channels,\n\t\t.num_channels = ARRAY_SIZE(max1238_channels),\n\t},\n\t[max11600] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max11607_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11607_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1036_channels,\n\t\t.num_channels = ARRAY_SIZE(max1036_channels),\n\t},\n\t[max11601] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max11607_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11607_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1036_channels,\n\t\t.num_channels = ARRAY_SIZE(max1036_channels),\n\t},\n\t[max11602] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max11608_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11608_mode_list),\n\t\t.default_mode = s0to7,\n\t\t.info = &max1238_info,\n\t\t.channels = max11602_channels,\n\t\t.num_channels = ARRAY_SIZE(max11602_channels),\n\t},\n\t[max11603] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max11608_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11608_mode_list),\n\t\t.default_mode = s0to7,\n\t\t.info = &max1238_info,\n\t\t.channels = max11602_channels,\n\t\t.num_channels = ARRAY_SIZE(max11602_channels),\n\t},\n\t[max11604] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1038_channels,\n\t\t.num_channels = ARRAY_SIZE(max1038_channels),\n\t},\n\t[max11605] = {\n\t\t.bits = 8,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1038_channels,\n\t\t.num_channels = ARRAY_SIZE(max1038_channels),\n\t},\n\t[max11606] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max11607_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11607_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1136_channels,\n\t\t.num_channels = ARRAY_SIZE(max1136_channels),\n\t},\n\t[max11607] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max11607_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11607_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1136_channels,\n\t\t.num_channels = ARRAY_SIZE(max1136_channels),\n\t},\n\t[max11608] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max11608_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11608_mode_list),\n\t\t.default_mode = s0to7,\n\t\t.info = &max1238_info,\n\t\t.channels = max11608_channels,\n\t\t.num_channels = ARRAY_SIZE(max11608_channels),\n\t},\n\t[max11609] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max11608_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11608_mode_list),\n\t\t.default_mode = s0to7,\n\t\t.info = &max1238_info,\n\t\t.channels = max11608_channels,\n\t\t.num_channels = ARRAY_SIZE(max11608_channels),\n\t},\n\t[max11610] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1138_channels,\n\t\t.num_channels = ARRAY_SIZE(max1138_channels),\n\t},\n\t[max11611] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1138_channels,\n\t\t.num_channels = ARRAY_SIZE(max1138_channels),\n\t},\n\t[max11612] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max11607_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11607_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1363_channels,\n\t\t.num_channels = ARRAY_SIZE(max1363_channels),\n\t},\n\t[max11613] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max11607_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11607_mode_list),\n\t\t.default_mode = s0to3,\n\t\t.info = &max1238_info,\n\t\t.channels = max1363_channels,\n\t\t.num_channels = ARRAY_SIZE(max1363_channels),\n\t},\n\t[max11614] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max11608_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11608_mode_list),\n\t\t.default_mode = s0to7,\n\t\t.info = &max1238_info,\n\t\t.channels = max11614_channels,\n\t\t.num_channels = ARRAY_SIZE(max11614_channels),\n\t},\n\t[max11615] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max11608_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11608_mode_list),\n\t\t.default_mode = s0to7,\n\t\t.info = &max1238_info,\n\t\t.channels = max11614_channels,\n\t\t.num_channels = ARRAY_SIZE(max11614_channels),\n\t},\n\t[max11616] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1238_channels,\n\t\t.num_channels = ARRAY_SIZE(max1238_channels),\n\t},\n\t[max11617] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max1238_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max1238_mode_list),\n\t\t.default_mode = s0to11,\n\t\t.info = &max1238_info,\n\t\t.channels = max1238_channels,\n\t\t.num_channels = ARRAY_SIZE(max1238_channels),\n\t},\n\t[max11644] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max11644_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11644_mode_list),\n\t\t.default_mode = s0to1,\n\t\t.info = &max1238_info,\n\t\t.channels = max11644_channels,\n\t\t.num_channels = ARRAY_SIZE(max11644_channels),\n\t},\n\t[max11645] = {\n\t\t.bits = 12,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max11644_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11644_mode_list),\n\t\t.default_mode = s0to1,\n\t\t.info = &max1238_info,\n\t\t.channels = max11644_channels,\n\t\t.num_channels = ARRAY_SIZE(max11644_channels),\n\t},\n\t[max11646] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 4096,\n\t\t.mode_list = max11644_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11644_mode_list),\n\t\t.default_mode = s0to1,\n\t\t.info = &max1238_info,\n\t\t.channels = max11646_channels,\n\t\t.num_channels = ARRAY_SIZE(max11646_channels),\n\t},\n\t[max11647] = {\n\t\t.bits = 10,\n\t\t.int_vref_mv = 2048,\n\t\t.mode_list = max11644_mode_list,\n\t\t.num_modes = ARRAY_SIZE(max11644_mode_list),\n\t\t.default_mode = s0to1,\n\t\t.info = &max1238_info,\n\t\t.channels = max11646_channels,\n\t\t.num_channels = ARRAY_SIZE(max11646_channels),\n\t},\n};\n\nstatic int max1363_initial_setup(struct max1363_state *st)\n{\n\tst->setupbyte = MAX1363_SETUP_INT_CLOCK\n\t\t| MAX1363_SETUP_UNIPOLAR\n\t\t| MAX1363_SETUP_NORESET;\n\n\tif (st->vref)\n\t\tst->setupbyte |= MAX1363_SETUP_AIN3_IS_REF_EXT_TO_REF;\n\telse\n\t\tst->setupbyte |= MAX1363_SETUP_POWER_UP_INT_REF\n\t\t  | MAX1363_SETUP_AIN3_IS_AIN3_REF_IS_INT;\n\n\t \n\tst->setupbyte = MAX1363_SETUP_BYTE(st->setupbyte);\n\tst->current_mode = &max1363_mode_table[st->chip_info->default_mode];\n\tst->configbyte = MAX1363_CONFIG_BYTE(st->configbyte);\n\n\treturn max1363_set_scan_mode(st);\n}\n\nstatic int max1363_alloc_scan_masks(struct iio_dev *indio_dev)\n{\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\tunsigned long *masks;\n\tint i;\n\n\tmasks = devm_kzalloc(&indio_dev->dev,\n\t\t\tarray3_size(BITS_TO_LONGS(MAX1363_MAX_CHANNELS),\n\t\t\t\t    sizeof(long),\n\t\t\t\t    st->chip_info->num_modes + 1),\n\t\t\tGFP_KERNEL);\n\tif (!masks)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < st->chip_info->num_modes; i++)\n\t\tbitmap_copy(masks + BITS_TO_LONGS(MAX1363_MAX_CHANNELS)*i,\n\t\t\t    max1363_mode_table[st->chip_info->mode_list[i]]\n\t\t\t    .modemask, MAX1363_MAX_CHANNELS);\n\n\tindio_dev->available_scan_masks = masks;\n\n\treturn 0;\n}\n\nstatic irqreturn_t max1363_trigger_handler(int irq, void *p)\n{\n\tstruct iio_poll_func *pf = p;\n\tstruct iio_dev *indio_dev = pf->indio_dev;\n\tstruct max1363_state *st = iio_priv(indio_dev);\n\t__u8 *rxbuf;\n\tint b_sent;\n\tsize_t d_size;\n\tunsigned long numvals = bitmap_weight(st->current_mode->modemask,\n\t\t\t\t\t      MAX1363_MAX_CHANNELS);\n\n\t \n\tif (st->chip_info->bits != 8)\n\t\td_size = numvals*2;\n\telse\n\t\td_size = numvals;\n\tif (indio_dev->scan_timestamp) {\n\t\td_size += sizeof(s64);\n\t\tif (d_size % sizeof(s64))\n\t\t\td_size += sizeof(s64) - (d_size % sizeof(s64));\n\t}\n\t \n\tif (numvals == 0)\n\t\tgoto done;\n\n\trxbuf = kmalloc(d_size,\tGFP_KERNEL);\n\tif (rxbuf == NULL)\n\t\tgoto done;\n\tif (st->chip_info->bits != 8)\n\t\tb_sent = st->recv(st->client, rxbuf, numvals * 2);\n\telse\n\t\tb_sent = st->recv(st->client, rxbuf, numvals);\n\tif (b_sent < 0)\n\t\tgoto done_free;\n\n\tiio_push_to_buffers_with_timestamp(indio_dev, rxbuf,\n\t\t\t\t\t   iio_get_time_ns(indio_dev));\n\ndone_free:\n\tkfree(rxbuf);\ndone:\n\tiio_trigger_notify_done(indio_dev->trig);\n\n\treturn IRQ_HANDLED;\n}\n\n#define MAX1363_COMPATIBLE(of_compatible, cfg) {\t\t\\\n\t\t\t.compatible = of_compatible,\t\t\\\n\t\t\t.data = &max1363_chip_info_tbl[cfg],\t\\\n}\n\nstatic const struct of_device_id max1363_of_match[] = {\n\tMAX1363_COMPATIBLE(\"maxim,max1361\", max1361),\n\tMAX1363_COMPATIBLE(\"maxim,max1362\", max1362),\n\tMAX1363_COMPATIBLE(\"maxim,max1363\", max1363),\n\tMAX1363_COMPATIBLE(\"maxim,max1364\", max1364),\n\tMAX1363_COMPATIBLE(\"maxim,max1036\", max1036),\n\tMAX1363_COMPATIBLE(\"maxim,max1037\", max1037),\n\tMAX1363_COMPATIBLE(\"maxim,max1038\", max1038),\n\tMAX1363_COMPATIBLE(\"maxim,max1039\", max1039),\n\tMAX1363_COMPATIBLE(\"maxim,max1136\", max1136),\n\tMAX1363_COMPATIBLE(\"maxim,max1137\", max1137),\n\tMAX1363_COMPATIBLE(\"maxim,max1138\", max1138),\n\tMAX1363_COMPATIBLE(\"maxim,max1139\", max1139),\n\tMAX1363_COMPATIBLE(\"maxim,max1236\", max1236),\n\tMAX1363_COMPATIBLE(\"maxim,max1237\", max1237),\n\tMAX1363_COMPATIBLE(\"maxim,max1238\", max1238),\n\tMAX1363_COMPATIBLE(\"maxim,max1239\", max1239),\n\tMAX1363_COMPATIBLE(\"maxim,max11600\", max11600),\n\tMAX1363_COMPATIBLE(\"maxim,max11601\", max11601),\n\tMAX1363_COMPATIBLE(\"maxim,max11602\", max11602),\n\tMAX1363_COMPATIBLE(\"maxim,max11603\", max11603),\n\tMAX1363_COMPATIBLE(\"maxim,max11604\", max11604),\n\tMAX1363_COMPATIBLE(\"maxim,max11605\", max11605),\n\tMAX1363_COMPATIBLE(\"maxim,max11606\", max11606),\n\tMAX1363_COMPATIBLE(\"maxim,max11607\", max11607),\n\tMAX1363_COMPATIBLE(\"maxim,max11608\", max11608),\n\tMAX1363_COMPATIBLE(\"maxim,max11609\", max11609),\n\tMAX1363_COMPATIBLE(\"maxim,max11610\", max11610),\n\tMAX1363_COMPATIBLE(\"maxim,max11611\", max11611),\n\tMAX1363_COMPATIBLE(\"maxim,max11612\", max11612),\n\tMAX1363_COMPATIBLE(\"maxim,max11613\", max11613),\n\tMAX1363_COMPATIBLE(\"maxim,max11614\", max11614),\n\tMAX1363_COMPATIBLE(\"maxim,max11615\", max11615),\n\tMAX1363_COMPATIBLE(\"maxim,max11616\", max11616),\n\tMAX1363_COMPATIBLE(\"maxim,max11617\", max11617),\n\tMAX1363_COMPATIBLE(\"maxim,max11644\", max11644),\n\tMAX1363_COMPATIBLE(\"maxim,max11645\", max11645),\n\tMAX1363_COMPATIBLE(\"maxim,max11646\", max11646),\n\tMAX1363_COMPATIBLE(\"maxim,max11647\", max11647),\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, max1363_of_match);\n\nstatic void max1363_reg_disable(void *reg)\n{\n\tregulator_disable(reg);\n}\n\nstatic int max1363_probe(struct i2c_client *client)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(client);\n\tint ret;\n\tstruct max1363_state *st;\n\tstruct iio_dev *indio_dev;\n\tstruct regulator *vref;\n\n\tindio_dev = devm_iio_device_alloc(&client->dev,\n\t\t\t\t\t  sizeof(struct max1363_state));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\tst = iio_priv(indio_dev);\n\n\tmutex_init(&st->lock);\n\tret = devm_regulator_get_enable(&client->dev, \"vcc\");\n\tif (ret)\n\t\treturn ret;\n\n\tst->chip_info = device_get_match_data(&client->dev);\n\tif (!st->chip_info)\n\t\tst->chip_info = &max1363_chip_info_tbl[id->driver_data];\n\tst->client = client;\n\n\tst->vref_uv = st->chip_info->int_vref_mv * 1000;\n\tvref = devm_regulator_get_optional(&client->dev, \"vref\");\n\tif (!IS_ERR(vref)) {\n\t\tint vref_uv;\n\n\t\tret = regulator_enable(vref);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = devm_add_action_or_reset(&client->dev, max1363_reg_disable, vref);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tst->vref = vref;\n\t\tvref_uv = regulator_get_voltage(vref);\n\t\tif (vref_uv <= 0)\n\t\t\treturn -EINVAL;\n\n\t\tst->vref_uv = vref_uv;\n\t}\n\n\tif (i2c_check_functionality(client->adapter, I2C_FUNC_I2C)) {\n\t\tst->send = i2c_master_send;\n\t\tst->recv = i2c_master_recv;\n\t} else if (i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE)\n\t\t\t&& st->chip_info->bits == 8) {\n\t\tst->send = max1363_smbus_send;\n\t\tst->recv = max1363_smbus_recv;\n\t} else {\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tret = max1363_alloc_scan_masks(indio_dev);\n\tif (ret)\n\t\treturn ret;\n\n\tindio_dev->name = id->name;\n\tindio_dev->channels = st->chip_info->channels;\n\tindio_dev->num_channels = st->chip_info->num_channels;\n\tindio_dev->info = st->chip_info->info;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tret = max1363_initial_setup(st);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = devm_iio_triggered_buffer_setup(&client->dev, indio_dev, NULL,\n\t\t\t\t\t      &max1363_trigger_handler, NULL);\n\tif (ret)\n\t\treturn ret;\n\n\tif (client->irq) {\n\t\tret = devm_request_threaded_irq(&client->dev, st->client->irq,\n\t\t\t\t\t   NULL,\n\t\t\t\t\t   &max1363_event_handler,\n\t\t\t\t\t   IRQF_TRIGGER_RISING | IRQF_ONESHOT,\n\t\t\t\t\t   \"max1363_event\",\n\t\t\t\t\t   indio_dev);\n\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn devm_iio_device_register(&client->dev, indio_dev);\n}\n\nstatic const struct i2c_device_id max1363_id[] = {\n\t{ \"max1361\", max1361 },\n\t{ \"max1362\", max1362 },\n\t{ \"max1363\", max1363 },\n\t{ \"max1364\", max1364 },\n\t{ \"max1036\", max1036 },\n\t{ \"max1037\", max1037 },\n\t{ \"max1038\", max1038 },\n\t{ \"max1039\", max1039 },\n\t{ \"max1136\", max1136 },\n\t{ \"max1137\", max1137 },\n\t{ \"max1138\", max1138 },\n\t{ \"max1139\", max1139 },\n\t{ \"max1236\", max1236 },\n\t{ \"max1237\", max1237 },\n\t{ \"max1238\", max1238 },\n\t{ \"max1239\", max1239 },\n\t{ \"max11600\", max11600 },\n\t{ \"max11601\", max11601 },\n\t{ \"max11602\", max11602 },\n\t{ \"max11603\", max11603 },\n\t{ \"max11604\", max11604 },\n\t{ \"max11605\", max11605 },\n\t{ \"max11606\", max11606 },\n\t{ \"max11607\", max11607 },\n\t{ \"max11608\", max11608 },\n\t{ \"max11609\", max11609 },\n\t{ \"max11610\", max11610 },\n\t{ \"max11611\", max11611 },\n\t{ \"max11612\", max11612 },\n\t{ \"max11613\", max11613 },\n\t{ \"max11614\", max11614 },\n\t{ \"max11615\", max11615 },\n\t{ \"max11616\", max11616 },\n\t{ \"max11617\", max11617 },\n\t{ \"max11644\", max11644 },\n\t{ \"max11645\", max11645 },\n\t{ \"max11646\", max11646 },\n\t{ \"max11647\", max11647 },\n\t{}\n};\n\nMODULE_DEVICE_TABLE(i2c, max1363_id);\n\nstatic struct i2c_driver max1363_driver = {\n\t.driver = {\n\t\t.name = \"max1363\",\n\t\t.of_match_table = max1363_of_match,\n\t},\n\t.probe = max1363_probe,\n\t.id_table = max1363_id,\n};\nmodule_i2c_driver(max1363_driver);\n\nMODULE_AUTHOR(\"Jonathan Cameron <jic23@kernel.org>\");\nMODULE_DESCRIPTION(\"Maxim 1363 ADC\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}