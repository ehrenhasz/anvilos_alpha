{
  "module_name": "ti-tlc4541.c",
  "hash_id": "11f1c4315a17faafa033324e74de3d46f9b62ab4d1349899f2e54a78c2888f34",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/adc/ti-tlc4541.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/interrupt.h>\n#include <linux/iio/iio.h>\n#include <linux/iio/sysfs.h>\n#include <linux/iio/buffer.h>\n#include <linux/iio/trigger_consumer.h>\n#include <linux/iio/triggered_buffer.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/regulator/consumer.h>\n#include <linux/slab.h>\n#include <linux/spi/spi.h>\n#include <linux/sysfs.h>\n\nstruct tlc4541_state {\n\tstruct spi_device               *spi;\n\tstruct regulator                *reg;\n\tstruct spi_transfer             scan_single_xfer[3];\n\tstruct spi_message              scan_single_msg;\n\n\t \n\t__be16                          rx_buf[8] __aligned(IIO_DMA_MINALIGN);\n};\n\nstruct tlc4541_chip_info {\n\tconst struct iio_chan_spec *channels;\n\tunsigned int num_channels;\n};\n\nenum tlc4541_id {\n\tTLC3541,\n\tTLC4541,\n};\n\n#define TLC4541_V_CHAN(bits, bitshift) {                              \\\n\t\t.type = IIO_VOLTAGE,                                  \\\n\t\t.info_mask_separate       = BIT(IIO_CHAN_INFO_RAW),   \\\n\t\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE), \\\n\t\t.scan_type = {                                        \\\n\t\t\t.sign = 'u',                                  \\\n\t\t\t.realbits = (bits),                           \\\n\t\t\t.storagebits = 16,                            \\\n\t\t\t.shift = (bitshift),                          \\\n\t\t\t.endianness = IIO_BE,                         \\\n\t\t},                                                    \\\n\t}\n\n#define DECLARE_TLC4541_CHANNELS(name, bits, bitshift) \\\nconst struct iio_chan_spec name ## _channels[] = { \\\n\tTLC4541_V_CHAN(bits, bitshift), \\\n\tIIO_CHAN_SOFT_TIMESTAMP(1), \\\n}\n\nstatic DECLARE_TLC4541_CHANNELS(tlc3541, 14, 2);\nstatic DECLARE_TLC4541_CHANNELS(tlc4541, 16, 0);\n\nstatic const struct tlc4541_chip_info tlc4541_chip_info[] = {\n\t[TLC3541] = {\n\t\t.channels = tlc3541_channels,\n\t\t.num_channels = ARRAY_SIZE(tlc3541_channels),\n\t},\n\t[TLC4541] = {\n\t\t.channels = tlc4541_channels,\n\t\t.num_channels = ARRAY_SIZE(tlc4541_channels),\n\t},\n};\n\nstatic irqreturn_t tlc4541_trigger_handler(int irq, void *p)\n{\n\tstruct iio_poll_func *pf = p;\n\tstruct iio_dev *indio_dev = pf->indio_dev;\n\tstruct tlc4541_state *st = iio_priv(indio_dev);\n\tint ret;\n\n\tret = spi_sync(st->spi, &st->scan_single_msg);\n\tif (ret < 0)\n\t\tgoto done;\n\n\tiio_push_to_buffers_with_timestamp(indio_dev, st->rx_buf,\n\t\t\t\t\t   iio_get_time_ns(indio_dev));\n\ndone:\n\tiio_trigger_notify_done(indio_dev->trig);\n\treturn IRQ_HANDLED;\n}\n\nstatic int tlc4541_get_range(struct tlc4541_state *st)\n{\n\tint vref;\n\n\tvref = regulator_get_voltage(st->reg);\n\tif (vref < 0)\n\t\treturn vref;\n\n\tvref /= 1000;\n\n\treturn vref;\n}\n\nstatic int tlc4541_read_raw(struct iio_dev *indio_dev,\n\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t    int *val,\n\t\t\t    int *val2,\n\t\t\t    long m)\n{\n\tint ret = 0;\n\tstruct tlc4541_state *st = iio_priv(indio_dev);\n\n\tswitch (m) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tret = iio_device_claim_direct_mode(indio_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tret = spi_sync(st->spi, &st->scan_single_msg);\n\t\tiio_device_release_direct_mode(indio_dev);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\t*val = be16_to_cpu(st->rx_buf[0]);\n\t\t*val = *val >> chan->scan_type.shift;\n\t\t*val &= GENMASK(chan->scan_type.realbits - 1, 0);\n\t\treturn IIO_VAL_INT;\n\tcase IIO_CHAN_INFO_SCALE:\n\t\tret = tlc4541_get_range(st);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\t*val = ret;\n\t\t*val2 = chan->scan_type.realbits;\n\t\treturn IIO_VAL_FRACTIONAL_LOG2;\n\t}\n\treturn -EINVAL;\n}\n\nstatic const struct iio_info tlc4541_info = {\n\t.read_raw = &tlc4541_read_raw,\n};\n\nstatic int tlc4541_probe(struct spi_device *spi)\n{\n\tstruct tlc4541_state *st;\n\tstruct iio_dev *indio_dev;\n\tconst struct tlc4541_chip_info *info;\n\tint ret;\n\tint8_t device_init = 0;\n\n\tindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\n\tif (indio_dev == NULL)\n\t\treturn -ENOMEM;\n\n\tst = iio_priv(indio_dev);\n\n\tspi_set_drvdata(spi, indio_dev);\n\n\tst->spi = spi;\n\n\tinfo = &tlc4541_chip_info[spi_get_device_id(spi)->driver_data];\n\n\tindio_dev->name = spi_get_device_id(spi)->name;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->channels = info->channels;\n\tindio_dev->num_channels = info->num_channels;\n\tindio_dev->info = &tlc4541_info;\n\n\t \n\tspi_write(spi, &device_init, 1);\n\n\t \n\tst->scan_single_xfer[0].rx_buf = &st->rx_buf[0];\n\tst->scan_single_xfer[0].len = 3;\n\tst->scan_single_xfer[1].delay.value = 3;\n\tst->scan_single_xfer[1].delay.unit = SPI_DELAY_UNIT_NSECS;\n\tst->scan_single_xfer[2].rx_buf = &st->rx_buf[0];\n\tst->scan_single_xfer[2].len = 2;\n\n\tspi_message_init_with_transfers(&st->scan_single_msg,\n\t\t\t\t\tst->scan_single_xfer, 3);\n\n\tst->reg = devm_regulator_get(&spi->dev, \"vref\");\n\tif (IS_ERR(st->reg))\n\t\treturn PTR_ERR(st->reg);\n\n\tret = regulator_enable(st->reg);\n\tif (ret)\n\t\treturn ret;\n\n\tret = iio_triggered_buffer_setup(indio_dev, NULL,\n\t\t\t&tlc4541_trigger_handler, NULL);\n\tif (ret)\n\t\tgoto error_disable_reg;\n\n\tret = iio_device_register(indio_dev);\n\tif (ret)\n\t\tgoto error_cleanup_buffer;\n\n\treturn 0;\n\nerror_cleanup_buffer:\n\tiio_triggered_buffer_cleanup(indio_dev);\nerror_disable_reg:\n\tregulator_disable(st->reg);\n\n\treturn ret;\n}\n\nstatic void tlc4541_remove(struct spi_device *spi)\n{\n\tstruct iio_dev *indio_dev = spi_get_drvdata(spi);\n\tstruct tlc4541_state *st = iio_priv(indio_dev);\n\n\tiio_device_unregister(indio_dev);\n\tiio_triggered_buffer_cleanup(indio_dev);\n\tregulator_disable(st->reg);\n}\n\nstatic const struct of_device_id tlc4541_dt_ids[] = {\n\t{ .compatible = \"ti,tlc3541\", },\n\t{ .compatible = \"ti,tlc4541\", },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, tlc4541_dt_ids);\n\nstatic const struct spi_device_id tlc4541_id[] = {\n\t{\"tlc3541\", TLC3541},\n\t{\"tlc4541\", TLC4541},\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, tlc4541_id);\n\nstatic struct spi_driver tlc4541_driver = {\n\t.driver = {\n\t\t.name   = \"tlc4541\",\n\t\t.of_match_table = tlc4541_dt_ids,\n\t},\n\t.probe          = tlc4541_probe,\n\t.remove         = tlc4541_remove,\n\t.id_table       = tlc4541_id,\n};\nmodule_spi_driver(tlc4541_driver);\n\nMODULE_AUTHOR(\"Phil Reid <preid@electromag.com.au>\");\nMODULE_DESCRIPTION(\"Texas Instruments TLC4541 ADC\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}