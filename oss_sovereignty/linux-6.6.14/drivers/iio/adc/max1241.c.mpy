{
  "module_name": "max1241.c",
  "hash_id": "41a401081806f65a74eff2a2fed3c98234ac0d41a60f2bf7491761baf903b2bb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/adc/max1241.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/gpio/consumer.h>\n#include <linux/iio/iio.h>\n#include <linux/module.h>\n#include <linux/regulator/consumer.h>\n#include <linux/spi/spi.h>\n\n#define MAX1241_VAL_MASK GENMASK(11, 0)\n#define MAX1241_SHUTDOWN_DELAY_USEC 4\n\nenum max1241_id {\n\tmax1241,\n};\n\nstruct max1241 {\n\tstruct spi_device *spi;\n\tstruct mutex lock;\n\tstruct regulator *vref;\n\tstruct gpio_desc *shutdown;\n\n\t__be16 data __aligned(IIO_DMA_MINALIGN);\n};\n\nstatic const struct iio_chan_spec max1241_channels[] = {\n\t{\n\t\t.type = IIO_VOLTAGE,\n\t\t.indexed = 1,\n\t\t.channel = 0,\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW) |\n\t\t\t\tBIT(IIO_CHAN_INFO_SCALE),\n\t},\n};\n\nstatic int max1241_read(struct max1241 *adc)\n{\n\tstruct spi_transfer xfers[] = {\n\t\t \n\t\t{\n\t\t\t.len = 0,\n\t\t\t.delay.value = 8,\n\t\t\t.delay.unit = SPI_DELAY_UNIT_USECS,\n\t\t},\n\t\t \n\t\t{\n\t\t\t.rx_buf = &adc->data,\n\t\t\t.len = 2,\n\t\t},\n\t};\n\n\treturn spi_sync_transfer(adc->spi, xfers, ARRAY_SIZE(xfers));\n}\n\nstatic int max1241_read_raw(struct iio_dev *indio_dev,\n\t\t\tstruct iio_chan_spec const *chan,\n\t\t\tint *val, int *val2, long mask)\n{\n\tint ret, vref_uV;\n\tstruct max1241 *adc = iio_priv(indio_dev);\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tmutex_lock(&adc->lock);\n\n\t\tif (adc->shutdown) {\n\t\t\tgpiod_set_value(adc->shutdown, 0);\n\t\t\tudelay(MAX1241_SHUTDOWN_DELAY_USEC);\n\t\t\tret = max1241_read(adc);\n\t\t\tgpiod_set_value(adc->shutdown, 1);\n\t\t} else\n\t\t\tret = max1241_read(adc);\n\n\t\tif (ret) {\n\t\t\tmutex_unlock(&adc->lock);\n\t\t\treturn ret;\n\t\t}\n\n\t\t*val = (be16_to_cpu(adc->data) >> 3) & MAX1241_VAL_MASK;\n\n\t\tmutex_unlock(&adc->lock);\n\t\treturn IIO_VAL_INT;\n\tcase IIO_CHAN_INFO_SCALE:\n\t\tvref_uV = regulator_get_voltage(adc->vref);\n\n\t\tif (vref_uV < 0)\n\t\t\treturn vref_uV;\n\n\t\t*val = vref_uV / 1000;\n\t\t*val2 = 12;\n\n\t\treturn IIO_VAL_FRACTIONAL_LOG2;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic const struct iio_info max1241_info = {\n\t.read_raw = max1241_read_raw,\n};\n\nstatic void max1241_disable_vref_action(void *data)\n{\n\tstruct max1241 *adc = data;\n\tstruct device *dev = &adc->spi->dev;\n\tint err;\n\n\terr = regulator_disable(adc->vref);\n\tif (err)\n\t\tdev_err(dev, \"could not disable vref regulator.\\n\");\n}\n\nstatic int max1241_probe(struct spi_device *spi)\n{\n\tstruct device *dev = &spi->dev;\n\tstruct iio_dev *indio_dev;\n\tstruct max1241 *adc;\n\tint ret;\n\n\tindio_dev = devm_iio_device_alloc(dev, sizeof(*adc));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\tadc = iio_priv(indio_dev);\n\tadc->spi = spi;\n\tmutex_init(&adc->lock);\n\n\tret = devm_regulator_get_enable(dev, \"vdd\");\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret,\n\t\t\t\t     \"failed to get/enable vdd regulator\\n\");\n\n\tadc->vref = devm_regulator_get(dev, \"vref\");\n\tif (IS_ERR(adc->vref))\n\t\treturn dev_err_probe(dev, PTR_ERR(adc->vref),\n\t\t\t\t     \"failed to get vref regulator\\n\");\n\n\tret = regulator_enable(adc->vref);\n\tif (ret)\n\t\treturn ret;\n\n\tret = devm_add_action_or_reset(dev, max1241_disable_vref_action, adc);\n\tif (ret) {\n\t\tdev_err(dev, \"could not set up vref regulator cleanup action\\n\");\n\t\treturn ret;\n\t}\n\n\tadc->shutdown = devm_gpiod_get_optional(dev, \"shutdown\",\n\t\t\t\t\t\tGPIOD_OUT_HIGH);\n\tif (IS_ERR(adc->shutdown))\n\t\treturn dev_err_probe(dev, PTR_ERR(adc->shutdown),\n\t\t\t\t     \"cannot get shutdown gpio\\n\");\n\n\tif (adc->shutdown)\n\t\tdev_dbg(dev, \"shutdown pin passed, low-power mode enabled\");\n\telse\n\t\tdev_dbg(dev, \"no shutdown pin passed, low-power mode disabled\");\n\n\tindio_dev->name = spi_get_device_id(spi)->name;\n\tindio_dev->info = &max1241_info;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->channels = max1241_channels;\n\tindio_dev->num_channels = ARRAY_SIZE(max1241_channels);\n\n\treturn devm_iio_device_register(dev, indio_dev);\n}\n\nstatic const struct spi_device_id max1241_id[] = {\n\t{ \"max1241\", max1241 },\n\t{}\n};\n\nstatic const struct of_device_id max1241_dt_ids[] = {\n\t{ .compatible = \"maxim,max1241\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, max1241_dt_ids);\n\nstatic struct spi_driver max1241_spi_driver = {\n\t.driver = {\n\t\t.name = \"max1241\",\n\t\t.of_match_table = max1241_dt_ids,\n\t},\n\t.probe = max1241_probe,\n\t.id_table = max1241_id,\n};\nmodule_spi_driver(max1241_spi_driver);\n\nMODULE_AUTHOR(\"Alexandru Lazar <alazar@startmail.com>\");\nMODULE_DESCRIPTION(\"MAX1241 ADC driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}