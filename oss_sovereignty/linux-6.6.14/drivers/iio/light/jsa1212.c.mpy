{
  "module_name": "jsa1212.c",
  "hash_id": "58bb67fdb57cafbd6c6f436227f721b1198f6683a46f2a4698f3c2605fbc9bdd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/light/jsa1212.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/i2c.h>\n#include <linux/mutex.h>\n#include <linux/acpi.h>\n#include <linux/regmap.h>\n#include <linux/iio/iio.h>\n#include <linux/iio/sysfs.h>\n\n \n#define JSA1212_CONF_REG\t\t0x01\n#define JSA1212_INT_REG\t\t\t0x02\n#define JSA1212_PXS_LT_REG\t\t0x03\n#define JSA1212_PXS_HT_REG\t\t0x04\n#define JSA1212_ALS_TH1_REG\t\t0x05\n#define JSA1212_ALS_TH2_REG\t\t0x06\n#define JSA1212_ALS_TH3_REG\t\t0x07\n#define JSA1212_PXS_DATA_REG\t\t0x08\n#define JSA1212_ALS_DT1_REG\t\t0x09\n#define JSA1212_ALS_DT2_REG\t\t0x0A\n#define JSA1212_ALS_RNG_REG\t\t0x0B\n#define JSA1212_MAX_REG\t\t\t0x0C\n\n \n#define JSA1212_CONF_MASK\t\t0xFF\n#define JSA1212_INT_MASK\t\t0xFF\n#define JSA1212_PXS_LT_MASK\t\t0xFF\n#define JSA1212_PXS_HT_MASK\t\t0xFF\n#define JSA1212_ALS_TH1_MASK\t\t0xFF\n#define JSA1212_ALS_TH2_LT_MASK\t\t0x0F\n#define JSA1212_ALS_TH2_HT_MASK\t\t0xF0\n#define JSA1212_ALS_TH3_MASK\t\t0xFF\n#define JSA1212_PXS_DATA_MASK\t\t0xFF\n#define JSA1212_ALS_DATA_MASK\t\t0x0FFF\n#define JSA1212_ALS_DT1_MASK\t\t0xFF\n#define JSA1212_ALS_DT2_MASK\t\t0x0F\n#define JSA1212_ALS_RNG_MASK\t\t0x07\n\n \n#define JSA1212_CONF_PXS_MASK\t\t0x80\n#define JSA1212_CONF_PXS_ENABLE\t\t0x80\n#define JSA1212_CONF_PXS_DISABLE\t0x00\n#define JSA1212_CONF_ALS_MASK\t\t0x04\n#define JSA1212_CONF_ALS_ENABLE\t\t0x04\n#define JSA1212_CONF_ALS_DISABLE\t0x00\n#define JSA1212_CONF_IRDR_MASK\t\t0x08\n \n#define JSA1212_CONF_IRDR_200MA\t\t0x08\n#define JSA1212_CONF_IRDR_100MA\t\t0x00\n#define JSA1212_CONF_PXS_SLP_MASK\t0x70\n#define JSA1212_CONF_PXS_SLP_0MS\t0x70\n#define JSA1212_CONF_PXS_SLP_12MS\t0x60\n#define JSA1212_CONF_PXS_SLP_50MS\t0x50\n#define JSA1212_CONF_PXS_SLP_75MS\t0x40\n#define JSA1212_CONF_PXS_SLP_100MS\t0x30\n#define JSA1212_CONF_PXS_SLP_200MS\t0x20\n#define JSA1212_CONF_PXS_SLP_400MS\t0x10\n#define JSA1212_CONF_PXS_SLP_800MS\t0x00\n\n \n#define JSA1212_INT_CTRL_MASK\t\t0x01\n#define JSA1212_INT_CTRL_EITHER\t\t0x00\n#define JSA1212_INT_CTRL_BOTH\t\t0x01\n#define JSA1212_INT_ALS_PRST_MASK\t0x06\n#define JSA1212_INT_ALS_PRST_1CONV\t0x00\n#define JSA1212_INT_ALS_PRST_4CONV\t0x02\n#define JSA1212_INT_ALS_PRST_8CONV\t0x04\n#define JSA1212_INT_ALS_PRST_16CONV\t0x06\n#define JSA1212_INT_ALS_FLAG_MASK\t0x08\n#define JSA1212_INT_ALS_FLAG_CLR\t0x00\n#define JSA1212_INT_PXS_PRST_MASK\t0x60\n#define JSA1212_INT_PXS_PRST_1CONV\t0x00\n#define JSA1212_INT_PXS_PRST_4CONV\t0x20\n#define JSA1212_INT_PXS_PRST_8CONV\t0x40\n#define JSA1212_INT_PXS_PRST_16CONV\t0x60\n#define JSA1212_INT_PXS_FLAG_MASK\t0x80\n#define JSA1212_INT_PXS_FLAG_CLR\t0x00\n\n \n#define JSA1212_ALS_RNG_0_2048\t\t0x00\n#define JSA1212_ALS_RNG_0_1024\t\t0x01\n#define JSA1212_ALS_RNG_0_512\t\t0x02\n#define JSA1212_ALS_RNG_0_256\t\t0x03\n#define JSA1212_ALS_RNG_0_128\t\t0x04\n\n \n#define JSA1212_ALS_TH_MIN\t0x0000\n#define JSA1212_ALS_TH_MAX\t0x0FFF\n#define JSA1212_PXS_TH_MIN\t0x00\n#define JSA1212_PXS_TH_MAX\t0xFF\n\n#define JSA1212_ALS_DELAY_MS\t200\n#define JSA1212_PXS_DELAY_MS\t100\n\n#define JSA1212_DRIVER_NAME\t\"jsa1212\"\n#define JSA1212_REGMAP_NAME\t\"jsa1212_regmap\"\n\nenum jsa1212_op_mode {\n\tJSA1212_OPMODE_ALS_EN,\n\tJSA1212_OPMODE_PXS_EN,\n};\n\nstruct jsa1212_data {\n\tstruct i2c_client *client;\n\tstruct mutex lock;\n\tu8 als_rng_idx;\n\tbool als_en;  \n\tbool pxs_en;  \n\tstruct regmap *regmap;\n};\n\n \nstatic const int jsa1212_als_range_val[] = {2048, 1024, 512, 256, 128,\n\t\t\t\t\t\t128, 128, 128};\n\n \nstatic int jsa1212_als_enable(struct jsa1212_data *data, u8 status)\n{\n\tint ret;\n\n\tret = regmap_update_bits(data->regmap, JSA1212_CONF_REG,\n\t\t\t\tJSA1212_CONF_ALS_MASK,\n\t\t\t\tstatus);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata->als_en = !!status;\n\n\treturn 0;\n}\n\n \nstatic int jsa1212_pxs_enable(struct jsa1212_data *data, u8 status)\n{\n\tint ret;\n\n\tret = regmap_update_bits(data->regmap, JSA1212_CONF_REG,\n\t\t\t\tJSA1212_CONF_PXS_MASK,\n\t\t\t\tstatus);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata->pxs_en = !!status;\n\n\treturn 0;\n}\n\nstatic int jsa1212_read_als_data(struct jsa1212_data *data,\n\t\t\t\tunsigned int *val)\n{\n\tint ret;\n\t__le16 als_data;\n\n\tret = jsa1212_als_enable(data, JSA1212_CONF_ALS_ENABLE);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tmsleep(JSA1212_ALS_DELAY_MS);\n\n\t \n\tret = regmap_bulk_read(data->regmap, JSA1212_ALS_DT1_REG, &als_data, 2);\n\tif (ret < 0) {\n\t\tdev_err(&data->client->dev, \"als data read err\\n\");\n\t\tgoto als_data_read_err;\n\t}\n\n\t*val = le16_to_cpu(als_data);\n\nals_data_read_err:\n\treturn jsa1212_als_enable(data, JSA1212_CONF_ALS_DISABLE);\n}\n\nstatic int jsa1212_read_pxs_data(struct jsa1212_data *data,\n\t\t\t\tunsigned int *val)\n{\n\tint ret;\n\tunsigned int pxs_data;\n\n\tret = jsa1212_pxs_enable(data, JSA1212_CONF_PXS_ENABLE);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tmsleep(JSA1212_PXS_DELAY_MS);\n\n\t \n\tret = regmap_read(data->regmap, JSA1212_PXS_DATA_REG, &pxs_data);\n\tif (ret < 0) {\n\t\tdev_err(&data->client->dev, \"pxs data read err\\n\");\n\t\tgoto pxs_data_read_err;\n\t}\n\n\t*val = pxs_data & JSA1212_PXS_DATA_MASK;\n\npxs_data_read_err:\n\treturn jsa1212_pxs_enable(data, JSA1212_CONF_PXS_DISABLE);\n}\n\nstatic int jsa1212_read_raw(struct iio_dev *indio_dev,\n\t\t\t\tstruct iio_chan_spec const *chan,\n\t\t\t\tint *val, int *val2, long mask)\n{\n\tint ret;\n\tstruct jsa1212_data *data = iio_priv(indio_dev);\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tmutex_lock(&data->lock);\n\t\tswitch (chan->type) {\n\t\tcase IIO_LIGHT:\n\t\t\tret = jsa1212_read_als_data(data, val);\n\t\t\tbreak;\n\t\tcase IIO_PROXIMITY:\n\t\t\tret = jsa1212_read_pxs_data(data, val);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret = -EINVAL;\n\t\t\tbreak;\n\t\t}\n\t\tmutex_unlock(&data->lock);\n\t\treturn ret < 0 ? ret : IIO_VAL_INT;\n\tcase IIO_CHAN_INFO_SCALE:\n\t\tswitch (chan->type) {\n\t\tcase IIO_LIGHT:\n\t\t\t*val = jsa1212_als_range_val[data->als_rng_idx];\n\t\t\t*val2 = BIT(12);  \n\t\t\treturn IIO_VAL_FRACTIONAL;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic const struct iio_chan_spec jsa1212_channels[] = {\n\t{\n\t\t.type = IIO_LIGHT,\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW) |\n\t\t\tBIT(IIO_CHAN_INFO_SCALE),\n\t},\n\t{\n\t\t.type = IIO_PROXIMITY,\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW),\n\t}\n};\n\nstatic const struct iio_info jsa1212_info = {\n\t.read_raw\t\t= &jsa1212_read_raw,\n};\n\nstatic int jsa1212_chip_init(struct jsa1212_data *data)\n{\n\tint ret;\n\n\tret = regmap_write(data->regmap, JSA1212_CONF_REG,\n\t\t\t\t(JSA1212_CONF_PXS_SLP_50MS |\n\t\t\t\tJSA1212_CONF_IRDR_200MA));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_write(data->regmap, JSA1212_INT_REG,\n\t\t\t\tJSA1212_INT_ALS_PRST_4CONV);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata->als_rng_idx = JSA1212_ALS_RNG_0_2048;\n\n\treturn 0;\n}\n\nstatic bool jsa1212_is_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase JSA1212_PXS_DATA_REG:\n\tcase JSA1212_ALS_DT1_REG:\n\tcase JSA1212_ALS_DT2_REG:\n\tcase JSA1212_INT_REG:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const struct regmap_config jsa1212_regmap_config = {\n\t.name =  JSA1212_REGMAP_NAME,\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.max_register = JSA1212_MAX_REG,\n\t.cache_type = REGCACHE_RBTREE,\n\t.volatile_reg = jsa1212_is_volatile_reg,\n};\n\nstatic int jsa1212_probe(struct i2c_client *client)\n{\n\tstruct jsa1212_data *data;\n\tstruct iio_dev *indio_dev;\n\tstruct regmap *regmap;\n\tint ret;\n\n\tindio_dev = devm_iio_device_alloc(&client->dev, sizeof(*data));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\tregmap = devm_regmap_init_i2c(client, &jsa1212_regmap_config);\n\tif (IS_ERR(regmap)) {\n\t\tdev_err(&client->dev, \"Regmap initialization failed.\\n\");\n\t\treturn PTR_ERR(regmap);\n\t}\n\n\tdata = iio_priv(indio_dev);\n\n\ti2c_set_clientdata(client, indio_dev);\n\tdata->client = client;\n\tdata->regmap = regmap;\n\n\tmutex_init(&data->lock);\n\n\tret = jsa1212_chip_init(data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tindio_dev->channels = jsa1212_channels;\n\tindio_dev->num_channels = ARRAY_SIZE(jsa1212_channels);\n\tindio_dev->name = JSA1212_DRIVER_NAME;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\n\tindio_dev->info = &jsa1212_info;\n\n\tret = iio_device_register(indio_dev);\n\tif (ret < 0)\n\t\tdev_err(&client->dev, \"%s: register device failed\\n\", __func__);\n\n\treturn ret;\n}\n\n  \nstatic int jsa1212_power_off(struct jsa1212_data *data)\n{\n\tint ret;\n\n\tmutex_lock(&data->lock);\n\n\tret = regmap_update_bits(data->regmap, JSA1212_CONF_REG,\n\t\t\t\tJSA1212_CONF_ALS_MASK |\n\t\t\t\tJSA1212_CONF_PXS_MASK,\n\t\t\t\tJSA1212_CONF_ALS_DISABLE |\n\t\t\t\tJSA1212_CONF_PXS_DISABLE);\n\n\tif (ret < 0)\n\t\tdev_err(&data->client->dev, \"power off cmd failed\\n\");\n\n\tmutex_unlock(&data->lock);\n\n\treturn ret;\n}\n\nstatic void jsa1212_remove(struct i2c_client *client)\n{\n\tstruct iio_dev *indio_dev = i2c_get_clientdata(client);\n\tstruct jsa1212_data *data = iio_priv(indio_dev);\n\n\tiio_device_unregister(indio_dev);\n\n\tjsa1212_power_off(data);\n}\n\nstatic int jsa1212_suspend(struct device *dev)\n{\n\tstruct jsa1212_data *data;\n\n\tdata = iio_priv(i2c_get_clientdata(to_i2c_client(dev)));\n\n\treturn jsa1212_power_off(data);\n}\n\nstatic int jsa1212_resume(struct device *dev)\n{\n\tint ret = 0;\n\tstruct jsa1212_data *data;\n\n\tdata = iio_priv(i2c_get_clientdata(to_i2c_client(dev)));\n\n\tmutex_lock(&data->lock);\n\n\tif (data->als_en) {\n\t\tret = jsa1212_als_enable(data, JSA1212_CONF_ALS_ENABLE);\n\t\tif (ret < 0) {\n\t\t\tdev_err(dev, \"als resume failed\\n\");\n\t\t\tgoto unlock_and_ret;\n\t\t}\n\t}\n\n\tif (data->pxs_en) {\n\t\tret = jsa1212_pxs_enable(data, JSA1212_CONF_PXS_ENABLE);\n\t\tif (ret < 0)\n\t\t\tdev_err(dev, \"pxs resume failed\\n\");\n\t}\n\nunlock_and_ret:\n\tmutex_unlock(&data->lock);\n\treturn ret;\n}\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(jsa1212_pm_ops, jsa1212_suspend,\n\t\t\t\tjsa1212_resume);\n\nstatic const struct acpi_device_id jsa1212_acpi_match[] = {\n\t{\"JSA1212\", 0},\n\t{ },\n};\nMODULE_DEVICE_TABLE(acpi, jsa1212_acpi_match);\n\nstatic const struct i2c_device_id jsa1212_id[] = {\n\t{ JSA1212_DRIVER_NAME, 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, jsa1212_id);\n\nstatic struct i2c_driver jsa1212_driver = {\n\t.driver = {\n\t\t.name\t= JSA1212_DRIVER_NAME,\n\t\t.pm\t= pm_sleep_ptr(&jsa1212_pm_ops),\n\t\t.acpi_match_table = ACPI_PTR(jsa1212_acpi_match),\n\t},\n\t.probe\t\t= jsa1212_probe,\n\t.remove\t\t= jsa1212_remove,\n\t.id_table\t= jsa1212_id,\n};\nmodule_i2c_driver(jsa1212_driver);\n\nMODULE_AUTHOR(\"Sathya Kuppuswamy <sathyanarayanan.kuppuswamy@linux.intel.com>\");\nMODULE_DESCRIPTION(\"JSA1212 proximity/ambient light sensor driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}