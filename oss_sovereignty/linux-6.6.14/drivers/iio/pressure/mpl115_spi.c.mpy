{
  "module_name": "mpl115_spi.c",
  "hash_id": "b2deb8c715e41593965404758342e7d800640877f511ef22200e195bbb69f385",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/pressure/mpl115_spi.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/spi/spi.h>\n\n#include \"mpl115.h\"\n\n#define MPL115_SPI_WRITE(address)\t((address) << 1)\n#define MPL115_SPI_READ(address)\t(0x80 | (address) << 1)\n\nstruct mpl115_spi_buf {\n\tu8 tx[4];\n\tu8 rx[4];\n};\n\nstatic int mpl115_spi_init(struct device *dev)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tstruct mpl115_spi_buf *buf;\n\n\tbuf = devm_kzalloc(dev, sizeof(*buf), GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\tspi_set_drvdata(spi, buf);\n\n\treturn 0;\n}\n\nstatic int mpl115_spi_read(struct device *dev, u8 address)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tstruct mpl115_spi_buf *buf = spi_get_drvdata(spi);\n\tstruct spi_transfer xfer = {\n\t\t.tx_buf = buf->tx,\n\t\t.rx_buf = buf->rx,\n\t\t.len = 4,\n\t};\n\tint ret;\n\n\tbuf->tx[0] = MPL115_SPI_READ(address);\n\tbuf->tx[2] = MPL115_SPI_READ(address + 1);\n\n\tret = spi_sync_transfer(spi, &xfer, 1);\n\tif (ret)\n\t\treturn ret;\n\n\treturn (buf->rx[1] << 8) | buf->rx[3];\n}\n\nstatic int mpl115_spi_write(struct device *dev, u8 address, u8 value)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tstruct mpl115_spi_buf *buf = spi_get_drvdata(spi);\n\tstruct spi_transfer xfer = {\n\t\t.tx_buf = buf->tx,\n\t\t.len = 2,\n\t};\n\n\tbuf->tx[0] = MPL115_SPI_WRITE(address);\n\tbuf->tx[1] = value;\n\n\treturn spi_sync_transfer(spi, &xfer, 1);\n}\n\nstatic const struct mpl115_ops mpl115_spi_ops = {\n\t.init = mpl115_spi_init,\n\t.read = mpl115_spi_read,\n\t.write = mpl115_spi_write,\n};\n\nstatic int mpl115_spi_probe(struct spi_device *spi)\n{\n\tconst struct spi_device_id *id = spi_get_device_id(spi);\n\n\treturn mpl115_probe(&spi->dev, id->name, &mpl115_spi_ops);\n}\n\nstatic const struct spi_device_id mpl115_spi_ids[] = {\n\t{ \"mpl115\", 0 },\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, mpl115_spi_ids);\n\nstatic struct spi_driver mpl115_spi_driver = {\n\t.driver = {\n\t\t.name   = \"mpl115\",\n\t\t.pm = pm_ptr(&mpl115_dev_pm_ops),\n\t},\n\t.probe = mpl115_spi_probe,\n\t.id_table = mpl115_spi_ids,\n};\nmodule_spi_driver(mpl115_spi_driver);\n\nMODULE_AUTHOR(\"Akinobu Mita <akinobu.mita@gmail.com>\");\nMODULE_DESCRIPTION(\"Freescale MPL115A1 pressure/temperature driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_IMPORT_NS(IIO_MPL115);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}