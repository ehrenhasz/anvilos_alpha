{
  "module_name": "mcp4131.c",
  "hash_id": "0c5b7ba181eff539853d63b101ebf75cea5da977d1c7ca83c1c1fafb5f2cbfc9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/potentiometer/mcp4131.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/cache.h>\n#include <linux/err.h>\n#include <linux/export.h>\n#include <linux/iio/iio.h>\n#include <linux/iio/types.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/mutex.h>\n#include <linux/property.h>\n#include <linux/spi/spi.h>\n\n#define MCP4131_WRITE\t\t(0x00 << 2)\n#define MCP4131_READ\t\t(0x03 << 2)\n\n#define MCP4131_WIPER_SHIFT\t4\n#define MCP4131_CMDERR(r)\t((r[0]) & 0x02)\n#define MCP4131_RAW(r)\t\t((r[0]) == 0xff ? 0x100 : (r[1]))\n\nstruct mcp4131_cfg {\n\tint wipers;\n\tint max_pos;\n\tint kohms;\n};\n\nenum mcp4131_type {\n\tMCP413x_502 = 0,\n\tMCP413x_103,\n\tMCP413x_503,\n\tMCP413x_104,\n\tMCP414x_502,\n\tMCP414x_103,\n\tMCP414x_503,\n\tMCP414x_104,\n\tMCP415x_502,\n\tMCP415x_103,\n\tMCP415x_503,\n\tMCP415x_104,\n\tMCP416x_502,\n\tMCP416x_103,\n\tMCP416x_503,\n\tMCP416x_104,\n\tMCP423x_502,\n\tMCP423x_103,\n\tMCP423x_503,\n\tMCP423x_104,\n\tMCP424x_502,\n\tMCP424x_103,\n\tMCP424x_503,\n\tMCP424x_104,\n\tMCP425x_502,\n\tMCP425x_103,\n\tMCP425x_503,\n\tMCP425x_104,\n\tMCP426x_502,\n\tMCP426x_103,\n\tMCP426x_503,\n\tMCP426x_104,\n};\n\nstatic const struct mcp4131_cfg mcp4131_cfg[] = {\n\t[MCP413x_502] = { .wipers = 1, .max_pos = 128, .kohms =   5, },\n\t[MCP413x_103] = { .wipers = 1, .max_pos = 128, .kohms =  10, },\n\t[MCP413x_503] = { .wipers = 1, .max_pos = 128, .kohms =  50, },\n\t[MCP413x_104] = { .wipers = 1, .max_pos = 128, .kohms = 100, },\n\t[MCP414x_502] = { .wipers = 1, .max_pos = 128, .kohms =   5, },\n\t[MCP414x_103] = { .wipers = 1, .max_pos = 128, .kohms =  10, },\n\t[MCP414x_503] = { .wipers = 1, .max_pos = 128, .kohms =  50, },\n\t[MCP414x_104] = { .wipers = 1, .max_pos = 128, .kohms = 100, },\n\t[MCP415x_502] = { .wipers = 1, .max_pos = 256, .kohms =   5, },\n\t[MCP415x_103] = { .wipers = 1, .max_pos = 256, .kohms =  10, },\n\t[MCP415x_503] = { .wipers = 1, .max_pos = 256, .kohms =  50, },\n\t[MCP415x_104] = { .wipers = 1, .max_pos = 256, .kohms = 100, },\n\t[MCP416x_502] = { .wipers = 1, .max_pos = 256, .kohms =   5, },\n\t[MCP416x_103] = { .wipers = 1, .max_pos = 256, .kohms =  10, },\n\t[MCP416x_503] = { .wipers = 1, .max_pos = 256, .kohms =  50, },\n\t[MCP416x_104] = { .wipers = 1, .max_pos = 256, .kohms = 100, },\n\t[MCP423x_502] = { .wipers = 2, .max_pos = 128, .kohms =   5, },\n\t[MCP423x_103] = { .wipers = 2, .max_pos = 128, .kohms =  10, },\n\t[MCP423x_503] = { .wipers = 2, .max_pos = 128, .kohms =  50, },\n\t[MCP423x_104] = { .wipers = 2, .max_pos = 128, .kohms = 100, },\n\t[MCP424x_502] = { .wipers = 2, .max_pos = 128, .kohms =   5, },\n\t[MCP424x_103] = { .wipers = 2, .max_pos = 128, .kohms =  10, },\n\t[MCP424x_503] = { .wipers = 2, .max_pos = 128, .kohms =  50, },\n\t[MCP424x_104] = { .wipers = 2, .max_pos = 128, .kohms = 100, },\n\t[MCP425x_502] = { .wipers = 2, .max_pos = 256, .kohms =   5, },\n\t[MCP425x_103] = { .wipers = 2, .max_pos = 256, .kohms =  10, },\n\t[MCP425x_503] = { .wipers = 2, .max_pos = 256, .kohms =  50, },\n\t[MCP425x_104] = { .wipers = 2, .max_pos = 256, .kohms = 100, },\n\t[MCP426x_502] = { .wipers = 2, .max_pos = 256, .kohms =   5, },\n\t[MCP426x_103] = { .wipers = 2, .max_pos = 256, .kohms =  10, },\n\t[MCP426x_503] = { .wipers = 2, .max_pos = 256, .kohms =  50, },\n\t[MCP426x_104] = { .wipers = 2, .max_pos = 256, .kohms = 100, },\n};\n\nstruct mcp4131_data {\n\tstruct spi_device *spi;\n\tconst struct mcp4131_cfg *cfg;\n\tstruct mutex lock;\n\tu8 buf[2] __aligned(IIO_DMA_MINALIGN);\n};\n\n#define MCP4131_CHANNEL(ch) {\t\t\t\t\t\\\n\t.type = IIO_RESISTANCE,\t\t\t\t\t\\\n\t.indexed = 1,\t\t\t\t\t\t\\\n\t.output = 1,\t\t\t\t\t\t\\\n\t.channel = (ch),\t\t\t\t\t\\\n\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW),\t\t\\\n\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE),\t\\\n}\n\nstatic const struct iio_chan_spec mcp4131_channels[] = {\n\tMCP4131_CHANNEL(0),\n\tMCP4131_CHANNEL(1),\n};\n\nstatic int mcp4131_read(struct spi_device *spi, void *buf, size_t len)\n{\n\tstruct spi_transfer t = {\n\t\t.tx_buf = buf,  \n\t\t.rx_buf\t= buf,\n\t\t.len = len,\n\t};\n\tstruct spi_message m;\n\n\tspi_message_init(&m);\n\tspi_message_add_tail(&t, &m);\n\n\treturn spi_sync(spi, &m);\n}\n\nstatic int mcp4131_read_raw(struct iio_dev *indio_dev,\n\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t    int *val, int *val2, long mask)\n{\n\tint err;\n\tstruct mcp4131_data *data = iio_priv(indio_dev);\n\tint address = chan->channel;\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tmutex_lock(&data->lock);\n\n\t\tdata->buf[0] = (address << MCP4131_WIPER_SHIFT) | MCP4131_READ;\n\t\tdata->buf[1] = 0;\n\n\t\terr = mcp4131_read(data->spi, data->buf, 2);\n\t\tif (err) {\n\t\t\tmutex_unlock(&data->lock);\n\t\t\treturn err;\n\t\t}\n\n\t\t \n\t\tif (!MCP4131_CMDERR(data->buf)) {\n\t\t\tmutex_unlock(&data->lock);\n\t\t\treturn -EIO;\n\t\t}\n\n\t\t*val = MCP4131_RAW(data->buf);\n\t\tmutex_unlock(&data->lock);\n\n\t\treturn IIO_VAL_INT;\n\n\tcase IIO_CHAN_INFO_SCALE:\n\t\t*val = 1000 * data->cfg->kohms;\n\t\t*val2 = data->cfg->max_pos;\n\t\treturn IIO_VAL_FRACTIONAL;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int mcp4131_write_raw(struct iio_dev *indio_dev,\n\t\t\t     struct iio_chan_spec const *chan,\n\t\t\t     int val, int val2, long mask)\n{\n\tint err;\n\tstruct mcp4131_data *data = iio_priv(indio_dev);\n\tint address = chan->channel << MCP4131_WIPER_SHIFT;\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tif (val > data->cfg->max_pos || val < 0)\n\t\t\treturn -EINVAL;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tmutex_lock(&data->lock);\n\n\tdata->buf[0] = address << MCP4131_WIPER_SHIFT;\n\tdata->buf[0] |= MCP4131_WRITE | (val >> 8);\n\tdata->buf[1] = val & 0xFF;  \n\n\terr = spi_write(data->spi, data->buf, 2);\n\tmutex_unlock(&data->lock);\n\n\treturn err;\n}\n\nstatic const struct iio_info mcp4131_info = {\n\t.read_raw = mcp4131_read_raw,\n\t.write_raw = mcp4131_write_raw,\n};\n\nstatic int mcp4131_probe(struct spi_device *spi)\n{\n\tint err;\n\tstruct device *dev = &spi->dev;\n\tunsigned long devid;\n\tstruct mcp4131_data *data;\n\tstruct iio_dev *indio_dev;\n\n\tindio_dev = devm_iio_device_alloc(dev, sizeof(*data));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\tdata = iio_priv(indio_dev);\n\tspi_set_drvdata(spi, indio_dev);\n\tdata->spi = spi;\n\tdata->cfg = device_get_match_data(&spi->dev);\n\tif (!data->cfg) {\n\t\tdevid = spi_get_device_id(spi)->driver_data;\n\t\tdata->cfg = &mcp4131_cfg[devid];\n\t}\n\n\tmutex_init(&data->lock);\n\n\tindio_dev->info = &mcp4131_info;\n\tindio_dev->channels = mcp4131_channels;\n\tindio_dev->num_channels = data->cfg->wipers;\n\tindio_dev->name = spi_get_device_id(spi)->name;\n\n\terr = devm_iio_device_register(dev, indio_dev);\n\tif (err) {\n\t\tdev_info(&spi->dev, \"Unable to register %s\\n\", indio_dev->name);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id mcp4131_dt_ids[] = {\n\t{ .compatible = \"microchip,mcp4131-502\",\n\t\t.data = &mcp4131_cfg[MCP413x_502] },\n\t{ .compatible = \"microchip,mcp4131-103\",\n\t\t.data = &mcp4131_cfg[MCP413x_103] },\n\t{ .compatible = \"microchip,mcp4131-503\",\n\t\t.data = &mcp4131_cfg[MCP413x_503] },\n\t{ .compatible = \"microchip,mcp4131-104\",\n\t\t.data = &mcp4131_cfg[MCP413x_104] },\n\t{ .compatible = \"microchip,mcp4132-502\",\n\t\t.data = &mcp4131_cfg[MCP413x_502] },\n\t{ .compatible = \"microchip,mcp4132-103\",\n\t\t.data = &mcp4131_cfg[MCP413x_103] },\n\t{ .compatible = \"microchip,mcp4132-503\",\n\t\t.data = &mcp4131_cfg[MCP413x_503] },\n\t{ .compatible = \"microchip,mcp4132-104\",\n\t\t.data = &mcp4131_cfg[MCP413x_104] },\n\t{ .compatible = \"microchip,mcp4141-502\",\n\t\t.data = &mcp4131_cfg[MCP414x_502] },\n\t{ .compatible = \"microchip,mcp4141-103\",\n\t\t.data = &mcp4131_cfg[MCP414x_103] },\n\t{ .compatible = \"microchip,mcp4141-503\",\n\t\t.data = &mcp4131_cfg[MCP414x_503] },\n\t{ .compatible = \"microchip,mcp4141-104\",\n\t\t.data = &mcp4131_cfg[MCP414x_104] },\n\t{ .compatible = \"microchip,mcp4142-502\",\n\t\t.data = &mcp4131_cfg[MCP414x_502] },\n\t{ .compatible = \"microchip,mcp4142-103\",\n\t\t.data = &mcp4131_cfg[MCP414x_103] },\n\t{ .compatible = \"microchip,mcp4142-503\",\n\t\t.data = &mcp4131_cfg[MCP414x_503] },\n\t{ .compatible = \"microchip,mcp4142-104\",\n\t\t.data = &mcp4131_cfg[MCP414x_104] },\n\t{ .compatible = \"microchip,mcp4151-502\",\n\t\t.data = &mcp4131_cfg[MCP415x_502] },\n\t{ .compatible = \"microchip,mcp4151-103\",\n\t\t.data = &mcp4131_cfg[MCP415x_103] },\n\t{ .compatible = \"microchip,mcp4151-503\",\n\t\t.data = &mcp4131_cfg[MCP415x_503] },\n\t{ .compatible = \"microchip,mcp4151-104\",\n\t\t.data = &mcp4131_cfg[MCP415x_104] },\n\t{ .compatible = \"microchip,mcp4152-502\",\n\t\t.data = &mcp4131_cfg[MCP415x_502] },\n\t{ .compatible = \"microchip,mcp4152-103\",\n\t\t.data = &mcp4131_cfg[MCP415x_103] },\n\t{ .compatible = \"microchip,mcp4152-503\",\n\t\t.data = &mcp4131_cfg[MCP415x_503] },\n\t{ .compatible = \"microchip,mcp4152-104\",\n\t\t.data = &mcp4131_cfg[MCP415x_104] },\n\t{ .compatible = \"microchip,mcp4161-502\",\n\t\t.data = &mcp4131_cfg[MCP416x_502] },\n\t{ .compatible = \"microchip,mcp4161-103\",\n\t\t.data = &mcp4131_cfg[MCP416x_103] },\n\t{ .compatible = \"microchip,mcp4161-503\",\n\t\t.data = &mcp4131_cfg[MCP416x_503] },\n\t{ .compatible = \"microchip,mcp4161-104\",\n\t\t.data = &mcp4131_cfg[MCP416x_104] },\n\t{ .compatible = \"microchip,mcp4162-502\",\n\t\t.data = &mcp4131_cfg[MCP416x_502] },\n\t{ .compatible = \"microchip,mcp4162-103\",\n\t\t.data = &mcp4131_cfg[MCP416x_103] },\n\t{ .compatible = \"microchip,mcp4162-503\",\n\t\t.data = &mcp4131_cfg[MCP416x_503] },\n\t{ .compatible = \"microchip,mcp4162-104\",\n\t\t.data = &mcp4131_cfg[MCP416x_104] },\n\t{ .compatible = \"microchip,mcp4231-502\",\n\t\t.data = &mcp4131_cfg[MCP423x_502] },\n\t{ .compatible = \"microchip,mcp4231-103\",\n\t\t.data = &mcp4131_cfg[MCP423x_103] },\n\t{ .compatible = \"microchip,mcp4231-503\",\n\t\t.data = &mcp4131_cfg[MCP423x_503] },\n\t{ .compatible = \"microchip,mcp4231-104\",\n\t\t.data = &mcp4131_cfg[MCP423x_104] },\n\t{ .compatible = \"microchip,mcp4232-502\",\n\t\t.data = &mcp4131_cfg[MCP423x_502] },\n\t{ .compatible = \"microchip,mcp4232-103\",\n\t\t.data = &mcp4131_cfg[MCP423x_103] },\n\t{ .compatible = \"microchip,mcp4232-503\",\n\t\t.data = &mcp4131_cfg[MCP423x_503] },\n\t{ .compatible = \"microchip,mcp4232-104\",\n\t\t.data = &mcp4131_cfg[MCP423x_104] },\n\t{ .compatible = \"microchip,mcp4241-502\",\n\t\t.data = &mcp4131_cfg[MCP424x_502] },\n\t{ .compatible = \"microchip,mcp4241-103\",\n\t\t.data = &mcp4131_cfg[MCP424x_103] },\n\t{ .compatible = \"microchip,mcp4241-503\",\n\t\t.data = &mcp4131_cfg[MCP424x_503] },\n\t{ .compatible = \"microchip,mcp4241-104\",\n\t\t.data = &mcp4131_cfg[MCP424x_104] },\n\t{ .compatible = \"microchip,mcp4242-502\",\n\t\t.data = &mcp4131_cfg[MCP424x_502] },\n\t{ .compatible = \"microchip,mcp4242-103\",\n\t\t.data = &mcp4131_cfg[MCP424x_103] },\n\t{ .compatible = \"microchip,mcp4242-503\",\n\t\t.data = &mcp4131_cfg[MCP424x_503] },\n\t{ .compatible = \"microchip,mcp4242-104\",\n\t\t.data = &mcp4131_cfg[MCP424x_104] },\n\t{ .compatible = \"microchip,mcp4251-502\",\n\t\t.data = &mcp4131_cfg[MCP425x_502] },\n\t{ .compatible = \"microchip,mcp4251-103\",\n\t\t.data = &mcp4131_cfg[MCP425x_103] },\n\t{ .compatible = \"microchip,mcp4251-503\",\n\t\t.data = &mcp4131_cfg[MCP425x_503] },\n\t{ .compatible = \"microchip,mcp4251-104\",\n\t\t.data = &mcp4131_cfg[MCP425x_104] },\n\t{ .compatible = \"microchip,mcp4252-502\",\n\t\t.data = &mcp4131_cfg[MCP425x_502] },\n\t{ .compatible = \"microchip,mcp4252-103\",\n\t\t.data = &mcp4131_cfg[MCP425x_103] },\n\t{ .compatible = \"microchip,mcp4252-503\",\n\t\t.data = &mcp4131_cfg[MCP425x_503] },\n\t{ .compatible = \"microchip,mcp4252-104\",\n\t\t.data = &mcp4131_cfg[MCP425x_104] },\n\t{ .compatible = \"microchip,mcp4261-502\",\n\t\t.data = &mcp4131_cfg[MCP426x_502] },\n\t{ .compatible = \"microchip,mcp4261-103\",\n\t\t.data = &mcp4131_cfg[MCP426x_103] },\n\t{ .compatible = \"microchip,mcp4261-503\",\n\t\t.data = &mcp4131_cfg[MCP426x_503] },\n\t{ .compatible = \"microchip,mcp4261-104\",\n\t\t.data = &mcp4131_cfg[MCP426x_104] },\n\t{ .compatible = \"microchip,mcp4262-502\",\n\t\t.data = &mcp4131_cfg[MCP426x_502] },\n\t{ .compatible = \"microchip,mcp4262-103\",\n\t\t.data = &mcp4131_cfg[MCP426x_103] },\n\t{ .compatible = \"microchip,mcp4262-503\",\n\t\t.data = &mcp4131_cfg[MCP426x_503] },\n\t{ .compatible = \"microchip,mcp4262-104\",\n\t\t.data = &mcp4131_cfg[MCP426x_104] },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, mcp4131_dt_ids);\n\nstatic const struct spi_device_id mcp4131_id[] = {\n\t{ \"mcp4131-502\", MCP413x_502 },\n\t{ \"mcp4131-103\", MCP413x_103 },\n\t{ \"mcp4131-503\", MCP413x_503 },\n\t{ \"mcp4131-104\", MCP413x_104 },\n\t{ \"mcp4132-502\", MCP413x_502 },\n\t{ \"mcp4132-103\", MCP413x_103 },\n\t{ \"mcp4132-503\", MCP413x_503 },\n\t{ \"mcp4132-104\", MCP413x_104 },\n\t{ \"mcp4141-502\", MCP414x_502 },\n\t{ \"mcp4141-103\", MCP414x_103 },\n\t{ \"mcp4141-503\", MCP414x_503 },\n\t{ \"mcp4141-104\", MCP414x_104 },\n\t{ \"mcp4142-502\", MCP414x_502 },\n\t{ \"mcp4142-103\", MCP414x_103 },\n\t{ \"mcp4142-503\", MCP414x_503 },\n\t{ \"mcp4142-104\", MCP414x_104 },\n\t{ \"mcp4151-502\", MCP415x_502 },\n\t{ \"mcp4151-103\", MCP415x_103 },\n\t{ \"mcp4151-503\", MCP415x_503 },\n\t{ \"mcp4151-104\", MCP415x_104 },\n\t{ \"mcp4152-502\", MCP415x_502 },\n\t{ \"mcp4152-103\", MCP415x_103 },\n\t{ \"mcp4152-503\", MCP415x_503 },\n\t{ \"mcp4152-104\", MCP415x_104 },\n\t{ \"mcp4161-502\", MCP416x_502 },\n\t{ \"mcp4161-103\", MCP416x_103 },\n\t{ \"mcp4161-503\", MCP416x_503 },\n\t{ \"mcp4161-104\", MCP416x_104 },\n\t{ \"mcp4162-502\", MCP416x_502 },\n\t{ \"mcp4162-103\", MCP416x_103 },\n\t{ \"mcp4162-503\", MCP416x_503 },\n\t{ \"mcp4162-104\", MCP416x_104 },\n\t{ \"mcp4231-502\", MCP423x_502 },\n\t{ \"mcp4231-103\", MCP423x_103 },\n\t{ \"mcp4231-503\", MCP423x_503 },\n\t{ \"mcp4231-104\", MCP423x_104 },\n\t{ \"mcp4232-502\", MCP423x_502 },\n\t{ \"mcp4232-103\", MCP423x_103 },\n\t{ \"mcp4232-503\", MCP423x_503 },\n\t{ \"mcp4232-104\", MCP423x_104 },\n\t{ \"mcp4241-502\", MCP424x_502 },\n\t{ \"mcp4241-103\", MCP424x_103 },\n\t{ \"mcp4241-503\", MCP424x_503 },\n\t{ \"mcp4241-104\", MCP424x_104 },\n\t{ \"mcp4242-502\", MCP424x_502 },\n\t{ \"mcp4242-103\", MCP424x_103 },\n\t{ \"mcp4242-503\", MCP424x_503 },\n\t{ \"mcp4242-104\", MCP424x_104 },\n\t{ \"mcp4251-502\", MCP425x_502 },\n\t{ \"mcp4251-103\", MCP425x_103 },\n\t{ \"mcp4251-503\", MCP425x_503 },\n\t{ \"mcp4251-104\", MCP425x_104 },\n\t{ \"mcp4252-502\", MCP425x_502 },\n\t{ \"mcp4252-103\", MCP425x_103 },\n\t{ \"mcp4252-503\", MCP425x_503 },\n\t{ \"mcp4252-104\", MCP425x_104 },\n\t{ \"mcp4261-502\", MCP426x_502 },\n\t{ \"mcp4261-103\", MCP426x_103 },\n\t{ \"mcp4261-503\", MCP426x_503 },\n\t{ \"mcp4261-104\", MCP426x_104 },\n\t{ \"mcp4262-502\", MCP426x_502 },\n\t{ \"mcp4262-103\", MCP426x_103 },\n\t{ \"mcp4262-503\", MCP426x_503 },\n\t{ \"mcp4262-104\", MCP426x_104 },\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, mcp4131_id);\n\nstatic struct spi_driver mcp4131_driver = {\n\t.driver = {\n\t\t.name\t= \"mcp4131\",\n\t\t.of_match_table = mcp4131_dt_ids,\n\t},\n\t.probe\t\t= mcp4131_probe,\n\t.id_table\t= mcp4131_id,\n};\n\nmodule_spi_driver(mcp4131_driver);\n\nMODULE_AUTHOR(\"Slawomir Stepien <sst@poczta.fm>\");\nMODULE_DESCRIPTION(\"MCP4131 digital potentiometer\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}