{
  "module_name": "max5487.c",
  "hash_id": "bfc53360eed66f4ec7061d15b97a0f5004b9fb74de63e4930153cd86da5d9488",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/potentiometer/max5487.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/spi/spi.h>\n#include <linux/acpi.h>\n\n#include <linux/iio/sysfs.h>\n#include <linux/iio/iio.h>\n\n#define MAX5487_WRITE_WIPER_A\t(0x01 << 8)\n#define MAX5487_WRITE_WIPER_B\t(0x02 << 8)\n\n \n#define MAX5487_COPY_AB_TO_NV\t(0x23 << 8)\n \n#define MAX5487_COPY_NV_TO_AB\t(0x33 << 8)\n\n#define MAX5487_MAX_POS\t\t255\n\nstruct max5487_data {\n\tstruct spi_device *spi;\n\tint kohms;\n};\n\n#define MAX5487_CHANNEL(ch, addr) {\t\t\t\t\\\n\t.type = IIO_RESISTANCE,\t\t\t\t\t\\\n\t.indexed = 1,\t\t\t\t\t\t\\\n\t.output = 1,\t\t\t\t\t\t\\\n\t.channel = ch,\t\t\t\t\t\t\\\n\t.address = addr,\t\t\t\t\t\\\n\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW),\t\t\\\n\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE),\t\\\n}\n\nstatic const struct iio_chan_spec max5487_channels[] = {\n\tMAX5487_CHANNEL(0, MAX5487_WRITE_WIPER_A),\n\tMAX5487_CHANNEL(1, MAX5487_WRITE_WIPER_B),\n};\n\nstatic int max5487_write_cmd(struct spi_device *spi, u16 cmd)\n{\n\treturn spi_write(spi, (const void *) &cmd, sizeof(u16));\n}\n\nstatic int max5487_read_raw(struct iio_dev *indio_dev,\n\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t    int *val, int *val2, long mask)\n{\n\tstruct max5487_data *data = iio_priv(indio_dev);\n\n\tif (mask != IIO_CHAN_INFO_SCALE)\n\t\treturn -EINVAL;\n\n\t*val = 1000 * data->kohms;\n\t*val2 = MAX5487_MAX_POS;\n\n\treturn IIO_VAL_FRACTIONAL;\n}\n\nstatic int max5487_write_raw(struct iio_dev *indio_dev,\n\t\t\t     struct iio_chan_spec const *chan,\n\t\t\t     int val, int val2, long mask)\n{\n\tstruct max5487_data *data = iio_priv(indio_dev);\n\n\tif (mask != IIO_CHAN_INFO_RAW)\n\t\treturn -EINVAL;\n\n\tif (val < 0 || val > MAX5487_MAX_POS)\n\t\treturn -EINVAL;\n\n\treturn max5487_write_cmd(data->spi, chan->address | val);\n}\n\nstatic const struct iio_info max5487_info = {\n\t.read_raw = max5487_read_raw,\n\t.write_raw = max5487_write_raw,\n};\n\nstatic int max5487_spi_probe(struct spi_device *spi)\n{\n\tstruct iio_dev *indio_dev;\n\tstruct max5487_data *data;\n\tconst struct spi_device_id *id = spi_get_device_id(spi);\n\tint ret;\n\n\tindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*data));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\tspi_set_drvdata(spi, indio_dev);\n\tdata = iio_priv(indio_dev);\n\n\tdata->spi = spi;\n\tdata->kohms = id->driver_data;\n\n\tindio_dev->info = &max5487_info;\n\tindio_dev->name = id->name;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->channels = max5487_channels;\n\tindio_dev->num_channels = ARRAY_SIZE(max5487_channels);\n\n\t \n\tret = max5487_write_cmd(data->spi, MAX5487_COPY_NV_TO_AB);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn iio_device_register(indio_dev);\n}\n\nstatic void max5487_spi_remove(struct spi_device *spi)\n{\n\tstruct iio_dev *indio_dev = spi_get_drvdata(spi);\n\tint ret;\n\n\tiio_device_unregister(indio_dev);\n\n\t \n\tret = max5487_write_cmd(spi, MAX5487_COPY_AB_TO_NV);\n\tif (ret)\n\t\tdev_warn(&spi->dev, \"Failed to save wiper regs to NV regs\\n\");\n}\n\nstatic const struct spi_device_id max5487_id[] = {\n\t{ \"MAX5487\", 10 },\n\t{ \"MAX5488\", 50 },\n\t{ \"MAX5489\", 100 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(spi, max5487_id);\n\nstatic const struct acpi_device_id max5487_acpi_match[] = {\n\t{ \"MAX5487\", 10 },\n\t{ \"MAX5488\", 50 },\n\t{ \"MAX5489\", 100 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(acpi, max5487_acpi_match);\n\nstatic struct spi_driver max5487_driver = {\n\t.driver = {\n\t\t.name = \"max5487\",\n\t\t.acpi_match_table = ACPI_PTR(max5487_acpi_match),\n\t},\n\t.id_table = max5487_id,\n\t.probe = max5487_spi_probe,\n\t.remove = max5487_spi_remove\n};\nmodule_spi_driver(max5487_driver);\n\nMODULE_AUTHOR(\"Cristina-Gabriela Moraru <cristina.moraru09@gmail.com>\");\nMODULE_DESCRIPTION(\"max5487 SPI driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}