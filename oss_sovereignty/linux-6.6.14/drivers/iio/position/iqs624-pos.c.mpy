{
  "module_name": "iqs624-pos.c",
  "hash_id": "7717b74b007c9bfbd9ee82dc0af4d4c020454a6bb81f3dae9954ff1e166cb446",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/position/iqs624-pos.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/iio/events.h>\n#include <linux/iio/iio.h>\n#include <linux/kernel.h>\n#include <linux/mfd/iqs62x.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/notifier.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define IQS624_POS_DEG_OUT\t\t\t0x16\n\n#define IQS624_POS_SCALE1\t\t\t(314159 / 180)\n#define IQS624_POS_SCALE2\t\t\t100000\n\nstruct iqs624_pos_private {\n\tstruct iqs62x_core *iqs62x;\n\tstruct iio_dev *indio_dev;\n\tstruct notifier_block notifier;\n\tstruct mutex lock;\n\tbool angle_en;\n\tu16 angle;\n};\n\nstatic int iqs624_pos_angle_en(struct iqs62x_core *iqs62x, bool angle_en)\n{\n\tunsigned int event_mask = IQS624_HALL_UI_WHL_EVENT;\n\n\t \n\tif (iqs62x->dev_desc->prod_num == IQS625_PROD_NUM)\n\t\tevent_mask = IQS624_HALL_UI_INT_EVENT;\n\n\treturn regmap_update_bits(iqs62x->regmap, IQS624_HALL_UI, event_mask,\n\t\t\t\t  angle_en ? 0 : 0xFF);\n}\n\nstatic int iqs624_pos_notifier(struct notifier_block *notifier,\n\t\t\t       unsigned long event_flags, void *context)\n{\n\tstruct iqs62x_event_data *event_data = context;\n\tstruct iqs624_pos_private *iqs624_pos;\n\tstruct iqs62x_core *iqs62x;\n\tstruct iio_dev *indio_dev;\n\tu16 angle = event_data->ui_data;\n\ts64 timestamp;\n\tint ret;\n\n\tiqs624_pos = container_of(notifier, struct iqs624_pos_private,\n\t\t\t\t  notifier);\n\tindio_dev = iqs624_pos->indio_dev;\n\ttimestamp = iio_get_time_ns(indio_dev);\n\n\tiqs62x = iqs624_pos->iqs62x;\n\tif (iqs62x->dev_desc->prod_num == IQS625_PROD_NUM)\n\t\tangle = event_data->interval;\n\n\tmutex_lock(&iqs624_pos->lock);\n\n\tif (event_flags & BIT(IQS62X_EVENT_SYS_RESET)) {\n\t\tret = iqs624_pos_angle_en(iqs62x, iqs624_pos->angle_en);\n\t\tif (ret) {\n\t\t\tdev_err(indio_dev->dev.parent,\n\t\t\t\t\"Failed to re-initialize device: %d\\n\", ret);\n\t\t\tret = NOTIFY_BAD;\n\t\t} else {\n\t\t\tret = NOTIFY_OK;\n\t\t}\n\t} else if (iqs624_pos->angle_en && (angle != iqs624_pos->angle)) {\n\t\tiio_push_event(indio_dev,\n\t\t\t       IIO_UNMOD_EVENT_CODE(IIO_ANGL, 0,\n\t\t\t\t\t\t    IIO_EV_TYPE_CHANGE,\n\t\t\t\t\t\t    IIO_EV_DIR_NONE),\n\t\t\t       timestamp);\n\n\t\tiqs624_pos->angle = angle;\n\t\tret = NOTIFY_OK;\n\t} else {\n\t\tret = NOTIFY_DONE;\n\t}\n\n\tmutex_unlock(&iqs624_pos->lock);\n\n\treturn ret;\n}\n\nstatic void iqs624_pos_notifier_unregister(void *context)\n{\n\tstruct iqs624_pos_private *iqs624_pos = context;\n\tstruct iio_dev *indio_dev = iqs624_pos->indio_dev;\n\tint ret;\n\n\tret = blocking_notifier_chain_unregister(&iqs624_pos->iqs62x->nh,\n\t\t\t\t\t\t &iqs624_pos->notifier);\n\tif (ret)\n\t\tdev_err(indio_dev->dev.parent,\n\t\t\t\"Failed to unregister notifier: %d\\n\", ret);\n}\n\nstatic int iqs624_pos_angle_get(struct iqs62x_core *iqs62x, unsigned int *val)\n{\n\tint ret;\n\t__le16 val_buf;\n\n\tif (iqs62x->dev_desc->prod_num == IQS625_PROD_NUM)\n\t\treturn regmap_read(iqs62x->regmap, iqs62x->dev_desc->interval,\n\t\t\t\t   val);\n\n\tret = regmap_raw_read(iqs62x->regmap, IQS624_POS_DEG_OUT, &val_buf,\n\t\t\t      sizeof(val_buf));\n\tif (ret)\n\t\treturn ret;\n\n\t*val = le16_to_cpu(val_buf);\n\n\treturn 0;\n}\n\nstatic int iqs624_pos_read_raw(struct iio_dev *indio_dev,\n\t\t\t       struct iio_chan_spec const *chan,\n\t\t\t       int *val, int *val2, long mask)\n{\n\tstruct iqs624_pos_private *iqs624_pos = iio_priv(indio_dev);\n\tstruct iqs62x_core *iqs62x = iqs624_pos->iqs62x;\n\tunsigned int scale = 1;\n\tint ret;\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tret = iqs624_pos_angle_get(iqs62x, val);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\treturn IIO_VAL_INT;\n\n\tcase IIO_CHAN_INFO_SCALE:\n\t\tif (iqs62x->dev_desc->prod_num == IQS625_PROD_NUM) {\n\t\t\tret = regmap_read(iqs62x->regmap, IQS624_INTERVAL_DIV,\n\t\t\t\t\t  &scale);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t}\n\n\t\t*val = scale * IQS624_POS_SCALE1;\n\t\t*val2 = IQS624_POS_SCALE2;\n\t\treturn IIO_VAL_FRACTIONAL;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int iqs624_pos_read_event_config(struct iio_dev *indio_dev,\n\t\t\t\t\tconst struct iio_chan_spec *chan,\n\t\t\t\t\tenum iio_event_type type,\n\t\t\t\t\tenum iio_event_direction dir)\n{\n\tstruct iqs624_pos_private *iqs624_pos = iio_priv(indio_dev);\n\tint ret;\n\n\tmutex_lock(&iqs624_pos->lock);\n\tret = iqs624_pos->angle_en;\n\tmutex_unlock(&iqs624_pos->lock);\n\n\treturn ret;\n}\n\nstatic int iqs624_pos_write_event_config(struct iio_dev *indio_dev,\n\t\t\t\t\t const struct iio_chan_spec *chan,\n\t\t\t\t\t enum iio_event_type type,\n\t\t\t\t\t enum iio_event_direction dir,\n\t\t\t\t\t int state)\n{\n\tstruct iqs624_pos_private *iqs624_pos = iio_priv(indio_dev);\n\tstruct iqs62x_core *iqs62x = iqs624_pos->iqs62x;\n\tunsigned int val;\n\tint ret;\n\n\tmutex_lock(&iqs624_pos->lock);\n\n\tret = iqs624_pos_angle_get(iqs62x, &val);\n\tif (ret)\n\t\tgoto err_mutex;\n\n\tret = iqs624_pos_angle_en(iqs62x, state);\n\tif (ret)\n\t\tgoto err_mutex;\n\n\tiqs624_pos->angle = val;\n\tiqs624_pos->angle_en = state;\n\nerr_mutex:\n\tmutex_unlock(&iqs624_pos->lock);\n\n\treturn ret;\n}\n\nstatic const struct iio_info iqs624_pos_info = {\n\t.read_raw = &iqs624_pos_read_raw,\n\t.read_event_config = iqs624_pos_read_event_config,\n\t.write_event_config = iqs624_pos_write_event_config,\n};\n\nstatic const struct iio_event_spec iqs624_pos_events[] = {\n\t{\n\t\t.type = IIO_EV_TYPE_CHANGE,\n\t\t.dir = IIO_EV_DIR_NONE,\n\t\t.mask_separate = BIT(IIO_EV_INFO_ENABLE),\n\t},\n};\n\nstatic const struct iio_chan_spec iqs624_pos_channels[] = {\n\t{\n\t\t.type = IIO_ANGL,\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW) |\n\t\t\t\t      BIT(IIO_CHAN_INFO_SCALE),\n\t\t.event_spec = iqs624_pos_events,\n\t\t.num_event_specs = ARRAY_SIZE(iqs624_pos_events),\n\t},\n};\n\nstatic int iqs624_pos_probe(struct platform_device *pdev)\n{\n\tstruct iqs62x_core *iqs62x = dev_get_drvdata(pdev->dev.parent);\n\tstruct iqs624_pos_private *iqs624_pos;\n\tstruct iio_dev *indio_dev;\n\tint ret;\n\n\tindio_dev = devm_iio_device_alloc(&pdev->dev, sizeof(*iqs624_pos));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\tiqs624_pos = iio_priv(indio_dev);\n\tiqs624_pos->iqs62x = iqs62x;\n\tiqs624_pos->indio_dev = indio_dev;\n\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->channels = iqs624_pos_channels;\n\tindio_dev->num_channels = ARRAY_SIZE(iqs624_pos_channels);\n\tindio_dev->name = iqs62x->dev_desc->dev_name;\n\tindio_dev->info = &iqs624_pos_info;\n\n\tmutex_init(&iqs624_pos->lock);\n\n\tiqs624_pos->notifier.notifier_call = iqs624_pos_notifier;\n\tret = blocking_notifier_chain_register(&iqs624_pos->iqs62x->nh,\n\t\t\t\t\t       &iqs624_pos->notifier);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to register notifier: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_add_action_or_reset(&pdev->dev,\n\t\t\t\t       iqs624_pos_notifier_unregister,\n\t\t\t\t       iqs624_pos);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_iio_device_register(&pdev->dev, indio_dev);\n}\n\nstatic struct platform_driver iqs624_pos_platform_driver = {\n\t.driver = {\n\t\t.name = \"iqs624-pos\",\n\t},\n\t.probe = iqs624_pos_probe,\n};\nmodule_platform_driver(iqs624_pos_platform_driver);\n\nMODULE_AUTHOR(\"Jeff LaBundy <jeff@labundy.com>\");\nMODULE_DESCRIPTION(\"Azoteq IQS624/625 Angular Position Sensors\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:iqs624-pos\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}