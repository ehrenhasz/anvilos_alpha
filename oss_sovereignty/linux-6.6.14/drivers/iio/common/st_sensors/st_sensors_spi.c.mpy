{
  "module_name": "st_sensors_spi.c",
  "hash_id": "e8b615d4e412ec5f64671e28cd49d53e4462032bb6c0abb3475f11f424729ba4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/common/st_sensors/st_sensors_spi.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/iio/iio.h>\n#include <linux/property.h>\n#include <linux/regmap.h>\n#include <linux/spi/spi.h>\n\n#include <linux/iio/common/st_sensors_spi.h>\n\n#define ST_SENSORS_SPI_MULTIREAD\t0xc0\n\nstatic const struct regmap_config st_sensors_spi_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n};\n\nstatic const struct regmap_config st_sensors_spi_regmap_multiread_bit_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.read_flag_mask = ST_SENSORS_SPI_MULTIREAD,\n};\n\n \nstatic bool st_sensors_is_spi_3_wire(struct spi_device *spi)\n{\n\tstruct st_sensors_platform_data *pdata;\n\tstruct device *dev = &spi->dev;\n\n\tif (device_property_read_bool(dev, \"spi-3wire\"))\n\t\treturn true;\n\n\tpdata = dev_get_platdata(dev);\n\tif (pdata && pdata->spi_3wire)\n\t\treturn true;\n\n\treturn false;\n}\n\n \nstatic int st_sensors_configure_spi_3_wire(struct spi_device *spi,\n\t\t\t\t\t   struct st_sensor_settings *settings)\n{\n\tif (settings->sim.addr) {\n\t\tu8 buffer[] = {\n\t\t\tsettings->sim.addr,\n\t\t\tsettings->sim.value\n\t\t};\n\n\t\treturn spi_write(spi, buffer, 2);\n\t}\n\n\treturn 0;\n}\n\n \nint st_sensors_spi_configure(struct iio_dev *indio_dev,\n\t\t\t     struct spi_device *spi)\n{\n\tstruct st_sensor_data *sdata = iio_priv(indio_dev);\n\tconst struct regmap_config *config;\n\tint err;\n\n\tif (st_sensors_is_spi_3_wire(spi)) {\n\t\terr = st_sensors_configure_spi_3_wire(spi,\n\t\t\t\t\t\t      sdata->sensor_settings);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\tif (sdata->sensor_settings->multi_read_bit)\n\t\tconfig = &st_sensors_spi_regmap_multiread_bit_config;\n\telse\n\t\tconfig = &st_sensors_spi_regmap_config;\n\n\tsdata->regmap = devm_regmap_init_spi(spi, config);\n\tif (IS_ERR(sdata->regmap)) {\n\t\tdev_err(&spi->dev, \"Failed to register spi regmap (%ld)\\n\",\n\t\t\tPTR_ERR(sdata->regmap));\n\t\treturn PTR_ERR(sdata->regmap);\n\t}\n\n\tspi_set_drvdata(spi, indio_dev);\n\n\tindio_dev->name = spi->modalias;\n\n\tsdata->irq = spi->irq;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_NS(st_sensors_spi_configure, IIO_ST_SENSORS);\n\nMODULE_AUTHOR(\"Denis Ciocca <denis.ciocca@st.com>\");\nMODULE_DESCRIPTION(\"STMicroelectronics ST-sensors spi driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}