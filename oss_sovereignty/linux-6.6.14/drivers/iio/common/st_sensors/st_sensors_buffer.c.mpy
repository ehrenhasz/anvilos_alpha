{
  "module_name": "st_sensors_buffer.c",
  "hash_id": "9bf5dafce135754b5cb180fb5ee26ec2e0805a874ae1635d0a856a9367f9acdd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/common/st_sensors/st_sensors_buffer.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/iio/iio.h>\n#include <linux/iio/trigger.h>\n#include <linux/interrupt.h>\n#include <linux/iio/buffer.h>\n#include <linux/iio/trigger_consumer.h>\n#include <linux/irqreturn.h>\n#include <linux/regmap.h>\n\n#include <linux/iio/common/st_sensors.h>\n\n\nstatic int st_sensors_get_buffer_element(struct iio_dev *indio_dev, u8 *buf)\n{\n\tstruct st_sensor_data *sdata = iio_priv(indio_dev);\n\tunsigned int num_data_channels = sdata->num_data_channels;\n\tint i;\n\n\tfor_each_set_bit(i, indio_dev->active_scan_mask, num_data_channels) {\n\t\tconst struct iio_chan_spec *channel = &indio_dev->channels[i];\n\t\tunsigned int bytes_to_read =\n\t\t\tDIV_ROUND_UP(channel->scan_type.realbits +\n\t\t\t\t     channel->scan_type.shift, 8);\n\t\tunsigned int storage_bytes =\n\t\t\tchannel->scan_type.storagebits >> 3;\n\n\t\tbuf = PTR_ALIGN(buf, storage_bytes);\n\t\tif (regmap_bulk_read(sdata->regmap, channel->address,\n\t\t\t\t     buf, bytes_to_read) < 0)\n\t\t\treturn -EIO;\n\n\t\t \n\t\tbuf += storage_bytes;\n\t}\n\n\treturn 0;\n}\n\nirqreturn_t st_sensors_trigger_handler(int irq, void *p)\n{\n\tint len;\n\tstruct iio_poll_func *pf = p;\n\tstruct iio_dev *indio_dev = pf->indio_dev;\n\tstruct st_sensor_data *sdata = iio_priv(indio_dev);\n\ts64 timestamp;\n\n\t \n\tif (iio_trigger_using_own(indio_dev))\n\t\ttimestamp = sdata->hw_timestamp;\n\telse\n\t\ttimestamp = iio_get_time_ns(indio_dev);\n\n\tlen = st_sensors_get_buffer_element(indio_dev, sdata->buffer_data);\n\tif (len < 0)\n\t\tgoto st_sensors_get_buffer_element_error;\n\n\tiio_push_to_buffers_with_timestamp(indio_dev, sdata->buffer_data,\n\t\t\t\t\t   timestamp);\n\nst_sensors_get_buffer_element_error:\n\tiio_trigger_notify_done(indio_dev->trig);\n\n\treturn IRQ_HANDLED;\n}\nEXPORT_SYMBOL_NS(st_sensors_trigger_handler, IIO_ST_SENSORS);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}