{
  "module_name": "industrialio-triggered-buffer.c",
  "hash_id": "c91adb1ef01add08bebe41d8c7f9c01f442a02c25ba5eb5633faa01e9ac50e80",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/buffer/industrialio-triggered-buffer.c",
  "human_readable_source": "\n  \n\n#include <linux/kernel.h>\n#include <linux/export.h>\n#include <linux/module.h>\n#include <linux/iio/iio.h>\n#include <linux/iio/buffer.h>\n#include <linux/iio/buffer_impl.h>\n#include <linux/iio/kfifo_buf.h>\n#include <linux/iio/triggered_buffer.h>\n#include <linux/iio/trigger_consumer.h>\n\n \nint iio_triggered_buffer_setup_ext(struct iio_dev *indio_dev,\n\tirqreturn_t (*h)(int irq, void *p),\n\tirqreturn_t (*thread)(int irq, void *p),\n\tenum iio_buffer_direction direction,\n\tconst struct iio_buffer_setup_ops *setup_ops,\n\tconst struct iio_dev_attr **buffer_attrs)\n{\n\tstruct iio_buffer *buffer;\n\tint ret;\n\n\t \n\tif (indio_dev->buffer)\n\t\treturn -EADDRINUSE;\n\n\tbuffer = iio_kfifo_allocate();\n\tif (!buffer) {\n\t\tret = -ENOMEM;\n\t\tgoto error_ret;\n\t}\n\n\tindio_dev->pollfunc = iio_alloc_pollfunc(h,\n\t\t\t\t\t\t thread,\n\t\t\t\t\t\t IRQF_ONESHOT,\n\t\t\t\t\t\t indio_dev,\n\t\t\t\t\t\t \"%s_consumer%d\",\n\t\t\t\t\t\t indio_dev->name,\n\t\t\t\t\t\t iio_device_id(indio_dev));\n\tif (indio_dev->pollfunc == NULL) {\n\t\tret = -ENOMEM;\n\t\tgoto error_kfifo_free;\n\t}\n\n\t \n\tindio_dev->setup_ops = setup_ops;\n\n\t \n\tindio_dev->modes |= INDIO_BUFFER_TRIGGERED;\n\n\tbuffer->direction = direction;\n\tbuffer->attrs = buffer_attrs;\n\n\tret = iio_device_attach_buffer(indio_dev, buffer);\n\tif (ret < 0)\n\t\tgoto error_dealloc_pollfunc;\n\n\treturn 0;\n\nerror_dealloc_pollfunc:\n\tiio_dealloc_pollfunc(indio_dev->pollfunc);\nerror_kfifo_free:\n\tiio_kfifo_free(buffer);\nerror_ret:\n\treturn ret;\n}\nEXPORT_SYMBOL(iio_triggered_buffer_setup_ext);\n\n \nvoid iio_triggered_buffer_cleanup(struct iio_dev *indio_dev)\n{\n\tiio_dealloc_pollfunc(indio_dev->pollfunc);\n\tiio_kfifo_free(indio_dev->buffer);\n}\nEXPORT_SYMBOL(iio_triggered_buffer_cleanup);\n\nstatic void devm_iio_triggered_buffer_clean(void *indio_dev)\n{\n\tiio_triggered_buffer_cleanup(indio_dev);\n}\n\nint devm_iio_triggered_buffer_setup_ext(struct device *dev,\n\t\t\t\t\tstruct iio_dev *indio_dev,\n\t\t\t\t\tirqreturn_t (*h)(int irq, void *p),\n\t\t\t\t\tirqreturn_t (*thread)(int irq, void *p),\n\t\t\t\t\tenum iio_buffer_direction direction,\n\t\t\t\t\tconst struct iio_buffer_setup_ops *ops,\n\t\t\t\t\tconst struct iio_dev_attr **buffer_attrs)\n{\n\tint ret;\n\n\tret = iio_triggered_buffer_setup_ext(indio_dev, h, thread, direction,\n\t\t\t\t\t     ops, buffer_attrs);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_add_action_or_reset(dev, devm_iio_triggered_buffer_clean,\n\t\t\t\t\tindio_dev);\n}\nEXPORT_SYMBOL_GPL(devm_iio_triggered_buffer_setup_ext);\n\nMODULE_AUTHOR(\"Lars-Peter Clausen <lars@metafoo.de>\");\nMODULE_DESCRIPTION(\"IIO helper functions for setting up triggered buffers\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}