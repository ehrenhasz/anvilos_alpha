{
  "module_name": "iio-trig-loop.c",
  "hash_id": "93ee47ed6382533fd8189f7181e9bd63b17d689b9d5cef605929df4e4cb3ae9f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/trigger/iio-trig-loop.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/irq_work.h>\n#include <linux/kthread.h>\n#include <linux/freezer.h>\n\n#include <linux/iio/iio.h>\n#include <linux/iio/trigger.h>\n#include <linux/iio/sw_trigger.h>\n\nstruct iio_loop_info {\n\tstruct iio_sw_trigger swt;\n\tstruct task_struct *task;\n};\n\nstatic const struct config_item_type iio_loop_type = {\n\t.ct_owner = THIS_MODULE,\n};\n\nstatic int iio_loop_thread(void *data)\n{\n\tstruct iio_trigger *trig = data;\n\n\tset_freezable();\n\n\tdo {\n\t\tiio_trigger_poll_nested(trig);\n\t} while (likely(!kthread_freezable_should_stop(NULL)));\n\n\treturn 0;\n}\n\nstatic int iio_loop_trigger_set_state(struct iio_trigger *trig, bool state)\n{\n\tstruct iio_loop_info *loop_trig = iio_trigger_get_drvdata(trig);\n\n\tif (state) {\n\t\tloop_trig->task = kthread_run(iio_loop_thread,\n\t\t\t\t\t      trig, trig->name);\n\t\tif (IS_ERR(loop_trig->task)) {\n\t\t\tdev_err(&trig->dev,\n\t\t\t\t\"failed to create trigger loop thread\\n\");\n\t\t\treturn PTR_ERR(loop_trig->task);\n\t\t}\n\t} else {\n\t\tkthread_stop(loop_trig->task);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct iio_trigger_ops iio_loop_trigger_ops = {\n\t.set_trigger_state = iio_loop_trigger_set_state,\n};\n\nstatic struct iio_sw_trigger *iio_trig_loop_probe(const char *name)\n{\n\tstruct iio_loop_info *trig_info;\n\tint ret;\n\n\ttrig_info = kzalloc(sizeof(*trig_info), GFP_KERNEL);\n\tif (!trig_info)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\ttrig_info->swt.trigger = iio_trigger_alloc(NULL, \"%s\", name);\n\tif (!trig_info->swt.trigger) {\n\t\tret = -ENOMEM;\n\t\tgoto err_free_trig_info;\n\t}\n\n\tiio_trigger_set_drvdata(trig_info->swt.trigger, trig_info);\n\ttrig_info->swt.trigger->ops = &iio_loop_trigger_ops;\n\n\tret = iio_trigger_register(trig_info->swt.trigger);\n\tif (ret)\n\t\tgoto err_free_trigger;\n\n\tiio_swt_group_init_type_name(&trig_info->swt, name, &iio_loop_type);\n\n\treturn &trig_info->swt;\n\nerr_free_trigger:\n\tiio_trigger_free(trig_info->swt.trigger);\nerr_free_trig_info:\n\tkfree(trig_info);\n\n\treturn ERR_PTR(ret);\n}\n\nstatic int iio_trig_loop_remove(struct iio_sw_trigger *swt)\n{\n\tstruct iio_loop_info *trig_info;\n\n\ttrig_info = iio_trigger_get_drvdata(swt->trigger);\n\n\tiio_trigger_unregister(swt->trigger);\n\tiio_trigger_free(swt->trigger);\n\tkfree(trig_info);\n\n\treturn 0;\n}\n\nstatic const struct iio_sw_trigger_ops iio_trig_loop_ops = {\n\t.probe = iio_trig_loop_probe,\n\t.remove = iio_trig_loop_remove,\n};\n\nstatic struct iio_sw_trigger_type iio_trig_loop = {\n\t.name = \"loop\",\n\t.owner = THIS_MODULE,\n\t.ops = &iio_trig_loop_ops,\n};\n\nmodule_iio_sw_trigger_driver(iio_trig_loop);\n\nMODULE_AUTHOR(\"Jonathan Cameron <jic23@kernel.org>\");\nMODULE_DESCRIPTION(\"Loop based trigger for the iio subsystem\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:iio-trig-loop\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}