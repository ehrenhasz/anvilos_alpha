{
  "module_name": "adf4377.c",
  "hash_id": "d869635f34ce8e56eb01c01c2d271306ce86e67b461512ff8faf09b642a594e1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/frequency/adf4377.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/bits.h>\n#include <linux/clk.h>\n#include <linux/clkdev.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/notifier.h>\n#include <linux/property.h>\n#include <linux/spi/spi.h>\n#include <linux/iio/iio.h>\n#include <linux/regmap.h>\n#include <linux/units.h>\n\n#include <asm/unaligned.h>\n\n \n#define ADF4377_0000_SOFT_RESET_R_MSK\t\tBIT(7)\n#define ADF4377_0000_LSB_FIRST_R_MSK\t\tBIT(6)\n#define ADF4377_0000_ADDRESS_ASC_R_MSK\t\tBIT(5)\n#define ADF4377_0000_SDO_ACTIVE_R_MSK\t\tBIT(4)\n#define ADF4377_0000_SDO_ACTIVE_MSK\t\tBIT(3)\n#define ADF4377_0000_ADDRESS_ASC_MSK\t\tBIT(2)\n#define ADF4377_0000_LSB_FIRST_MSK\t\tBIT(1)\n#define ADF4377_0000_SOFT_RESET_MSK\t\tBIT(0)\n\n \n#define ADF4377_0000_SDO_ACTIVE_SPI_3W\t\t0x0\n#define ADF4377_0000_SDO_ACTIVE_SPI_4W\t\t0x1\n\n#define ADF4377_0000_ADDR_ASC_AUTO_DECR\t\t0x0\n#define ADF4377_0000_ADDR_ASC_AUTO_INCR\t\t0x1\n\n#define ADF4377_0000_LSB_FIRST_MSB\t\t0x0\n#define ADF4377_0000_LSB_FIRST_LSB\t\t0x1\n\n#define ADF4377_0000_SOFT_RESET_N_OP\t\t0x0\n#define ADF4377_0000_SOFT_RESET_EN\t\t0x1\n\n \n#define ADF4377_0001_SINGLE_INSTR_MSK\t\tBIT(7)\n#define ADF4377_0001_MASTER_RB_CTRL_MSK\t\tBIT(5)\n\n \n#define ADF4377_0003_CHIP_TYPE\t\t\t0x06\n\n \n#define ADF4377_0004_PRODUCT_ID_LSB\t\t0x0005\n\n \n#define ADF4377_0005_PRODUCT_ID_MSB\t\t0x0005\n\n \n#define ADF4377_000A_SCRATCHPAD_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_000C_VENDOR_ID_LSB\t\t0x56\n\n \n#define ADF4377_000D_VENDOR_ID_MSB\t\t0x04\n\n \n#define ADF4377_000F_R00F_RSV1_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_0010_N_INT_LSB_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_0011_EN_AUTOCAL_MSK\t\tBIT(7)\n#define ADF4377_0011_EN_RDBLR_MSK\t\tBIT(6)\n#define ADF4377_0011_DCLK_DIV2_MSK\t\tGENMASK(5, 4)\n#define ADF4377_0011_N_INT_MSB_MSK\t\tGENMASK(3, 0)\n\n \n#define ADF4377_0011_DCLK_DIV2_1\t\t0x0\n#define ADF4377_0011_DCLK_DIV2_2\t\t0x1\n#define ADF4377_0011_DCLK_DIV2_4\t\t0x2\n#define ADF4377_0011_DCLK_DIV2_8\t\t0x3\n\n \n#define ADF4377_0012_CLKOUT_DIV_MSK\t\tGENMASK(7, 6)\n#define ADF4377_0012_R_DIV_MSK\t\t\tGENMASK(5, 0)\n\n \n#define ADF4377_0012_CLKOUT_DIV_1\t\t0x0\n#define ADF4377_0012_CLKOUT_DIV_2\t\t0x1\n#define ADF4377_0012_CLKOUT_DIV_4\t\t0x2\n#define ADF4377_0012_CLKOUT_DIV_8\t\t0x3\n\n \n#define ADF4377_0013_M_VCO_CORE_MSK\t\tGENMASK(5, 4)\n#define ADF4377_0013_VCO_BIAS_MSK\t\tGENMASK(3, 0)\n\n \n#define ADF4377_0013_M_VCO_0\t\t\t0x0\n#define ADF4377_0013_M_VCO_1\t\t\t0x1\n#define ADF4377_0013_M_VCO_2\t\t\t0x2\n#define ADF4377_0013_M_VCO_3\t\t\t0x3\n\n \n#define ADF4377_0014_M_VCO_BAND_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_0015_BLEED_I_LSB_MSK\t\tGENMASK(7, 6)\n#define ADF4377_0015_BLEED_POL_MSK\t\tBIT(5)\n#define ADF4377_0015_EN_BLEED_MSK\t\tBIT(4)\n#define ADF4377_0015_CP_I_MSK\t\t\tGENMASK(3, 0)\n\n \n#define ADF4377_CURRENT_SINK\t\t\t0x0\n#define ADF4377_CURRENT_SOURCE\t\t\t0x1\n\n#define ADF4377_0015_CP_0MA7\t\t\t0x0\n#define ADF4377_0015_CP_0MA9\t\t\t0x1\n#define ADF4377_0015_CP_1MA1\t\t\t0x2\n#define ADF4377_0015_CP_1MA3\t\t\t0x3\n#define ADF4377_0015_CP_1MA4\t\t\t0x4\n#define ADF4377_0015_CP_1MA8\t\t\t0x5\n#define ADF4377_0015_CP_2MA2\t\t\t0x6\n#define ADF4377_0015_CP_2MA5\t\t\t0x7\n#define ADF4377_0015_CP_2MA9\t\t\t0x8\n#define ADF4377_0015_CP_3MA6\t\t\t0x9\n#define ADF4377_0015_CP_4MA3\t\t\t0xA\n#define ADF4377_0015_CP_5MA0\t\t\t0xB\n#define ADF4377_0015_CP_5MA7\t\t\t0xC\n#define ADF4377_0015_CP_7MA2\t\t\t0xD\n#define ADF4377_0015_CP_8MA6\t\t\t0xE\n#define ADF4377_0015_CP_10MA1\t\t\t0xF\n\n \n#define ADF4377_0016_BLEED_I_MSB_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_0016_INV_CLKOUT_MSK\t\tBIT(7)\n#define ADF4377_0016_N_DEL_MSK\t\t\tGENMASK(6, 0)\n\n \n#define ADF4377_0018_CMOS_OV_MSK\t\tBIT(7)\n#define ADF4377_0018_R_DEL_MSK\t\t\tGENMASK(6, 0)\n\n \n#define ADF4377_0018_1V8_LOGIC\t\t\t0x0\n#define ADF4377_0018_3V3_LOGIC\t\t\t0x1\n\n \n#define ADF4377_0019_CLKOUT2_OP_MSK\t\tGENMASK(7, 6)\n#define ADF4377_0019_CLKOUT1_OP_MSK\t\tGENMASK(5, 4)\n#define ADF4377_0019_PD_CLK_MSK\t\t\tBIT(3)\n#define ADF4377_0019_PD_RDET_MSK\t\tBIT(2)\n#define ADF4377_0019_PD_ADC_MSK\t\t\tBIT(1)\n#define ADF4377_0019_PD_CALADC_MSK\t\tBIT(0)\n\n \n#define ADF4377_0019_CLKOUT_320MV\t\t0x0\n#define ADF4377_0019_CLKOUT_420MV\t\t0x1\n#define ADF4377_0019_CLKOUT_530MV\t\t0x2\n#define ADF4377_0019_CLKOUT_640MV\t\t0x3\n\n \n#define ADF4377_001A_PD_ALL_MSK\t\t\tBIT(7)\n#define ADF4377_001A_PD_RDIV_MSK\t\tBIT(6)\n#define ADF4377_001A_PD_NDIV_MSK\t\tBIT(5)\n#define ADF4377_001A_PD_VCO_MSK\t\t\tBIT(4)\n#define ADF4377_001A_PD_LD_MSK\t\t\tBIT(3)\n#define ADF4377_001A_PD_PFDCP_MSK\t\tBIT(2)\n#define ADF4377_001A_PD_CLKOUT1_MSK\t\tBIT(1)\n#define ADF4377_001A_PD_CLKOUT2_MSK\t\tBIT(0)\n\n \n#define ADF4377_001B_EN_LOL_MSK\t\t\tBIT(7)\n#define ADF4377_001B_LDWIN_PW_MSK\t\tBIT(6)\n#define ADF4377_001B_EN_LDWIN_MSK\t\tBIT(5)\n#define ADF4377_001B_LD_COUNT_MSK\t\tGENMASK(4, 0)\n\n \n#define ADF4377_001B_LDWIN_PW_NARROW\t\t0x0\n#define ADF4377_001B_LDWIN_PW_WIDE\t\t0x1\n\n \n#define ADF4377_001C_EN_DNCLK_MSK\t\tBIT(7)\n#define ADF4377_001C_EN_DRCLK_MSK\t\tBIT(6)\n#define ADF4377_001C_RST_LD_MSK\t\t\tBIT(2)\n#define ADF4377_001C_R01C_RSV1_MSK\t\tBIT(0)\n\n \n#define ADF4377_001C_RST_LD_INACTIVE\t\t0x0\n#define ADF4377_001C_RST_LD_ACTIVE\t\t0x1\n\n#define ADF4377_001C_R01C_RSV1\t\t\t0x1\n\n \n#define ADF4377_001D_MUXOUT_MSK\t\t\tGENMASK(7, 4)\n#define ADF4377_001D_EN_CPTEST_MSK\t\tBIT(2)\n#define ADF4377_001D_CP_DOWN_MSK\t\tBIT(1)\n#define ADF4377_001D_CP_UP_MSK\t\t\tBIT(0)\n\n#define ADF4377_001D_EN_CPTEST_OFF\t\t0x0\n#define ADF4377_001D_EN_CPTEST_ON\t\t0x1\n\n#define ADF4377_001D_CP_DOWN_OFF\t\t0x0\n#define ADF4377_001D_CP_DOWN_ON\t\t\t0x1\n\n#define ADF4377_001D_CP_UP_OFF\t\t\t0x0\n#define ADF4377_001D_CP_UP_ON\t\t\t0x1\n\n \n#define ADF4377_001F_BST_REF_MSK\t\tBIT(7)\n#define ADF4377_001F_FILT_REF_MSK\t\tBIT(6)\n#define ADF4377_001F_REF_SEL_MSK\t\tBIT(5)\n#define ADF4377_001F_R01F_RSV1_MSK\t\tGENMASK(4, 0)\n\n \n#define ADF4377_001F_BST_LARGE_REF_IN\t\t0x0\n#define ADF4377_001F_BST_SMALL_REF_IN\t\t0x1\n\n#define ADF4377_001F_FILT_REF_OFF\t\t0x0\n#define ADF4377_001F_FILT_REF_ON\t\t0x1\n\n#define ADF4377_001F_REF_SEL_DMA\t\t0x0\n#define ADF4377_001F_REF_SEL_LNA\t\t0x1\n\n#define ADF4377_001F_R01F_RSV1\t\t\t0x7\n\n \n#define ADF4377_0020_RST_SYS_MSK\t\tBIT(4)\n#define ADF4377_0020_EN_ADC_CLK_MSK\t\tBIT(3)\n#define ADF4377_0020_R020_RSV1_MSK\t\tBIT(0)\n\n \n#define ADF4377_0021_R021_RSV1\t\t\t0xD3\n\n \n#define ADF4377_0022_R022_RSV1\t\t\t0x32\n\n \n#define ADF4377_0023_CAT_CT_SEL\t\t\tBIT(7)\n#define ADF4377_0023_R023_RSV1_MSK\t\tGENMASK(6, 0)\n\n \n#define ADF4377_0023_R023_RSV1\t\t\t0x18\n\n \n#define ADF4377_0024_DCLK_MODE_MSK\t\tBIT(2)\n\n \n#define ADF4377_0025_CLKODIV_DB_MSK\t\tBIT(7)\n#define ADF4377_0025_DCLK_DB_MSK\t\tBIT(6)\n#define ADF4377_0025_R025_RSV1_MSK\t\tGENMASK(5, 0)\n\n \n#define ADF4377_0025_R025_RSV1\t\t\t0x16\n\n \n#define ADF4377_0026_VCO_BAND_DIV_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_0027_SYNTH_LOCK_TO_LSB_MSK\tGENMASK(7, 0)\n\n \n#define ADF4377_0028_O_VCO_DB_MSK\t\tBIT(7)\n#define ADF4377_0028_SYNTH_LOCK_TO_MSB_MSK\tGENMASK(6, 0)\n\n \n#define ADF4377_0029_VCO_ALC_TO_LSB_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_002A_DEL_CTRL_DB_MSK\t\tBIT(7)\n#define ADF4377_002A_VCO_ALC_TO_MSB_MSK\t\tGENMASK(6, 0)\n\n \n#define ADF4377_002C_R02C_RSV1\t\t\t0xC0\n\n \n#define ADF4377_002D_ADC_CLK_DIV_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_002E_EN_ADC_CNV_MSK\t\tBIT(7)\n#define ADF4377_002E_EN_ADC_MSK\t\t\tBIT(1)\n#define ADF4377_002E_ADC_A_CONV_MSK\t\tBIT(0)\n\n \n#define ADF4377_002E_ADC_A_CONV_ADC_ST_CNV\t0x0\n#define ADF4377_002E_ADC_A_CONV_VCO_CALIB\t0x1\n\n \n#define ADF4377_002F_DCLK_DIV1_MSK\t\tGENMASK(1, 0)\n\n \n#define ADF4377_002F_DCLK_DIV1_1\t\t0x0\n#define ADF4377_002F_DCLK_DIV1_2\t\t0x1\n#define ADF4377_002F_DCLK_DIV1_8\t\t0x2\n#define ADF4377_002F_DCLK_DIV1_32\t\t0x3\n\n \n#define ADF4377_0031_R031_RSV1\t\t\t0x09\n\n \n#define ADF4377_0032_ADC_CLK_SEL_MSK\t\tBIT(6)\n#define ADF4377_0032_R032_RSV1_MSK\t\tGENMASK(5, 0)\n\n \n#define ADF4377_0032_ADC_CLK_SEL_N_OP\t\t0x0\n#define ADF4377_0032_ADC_CLK_SEL_SPI_CLK\t0x1\n\n#define ADF4377_0032_R032_RSV1\t\t\t0x9\n\n \n#define ADF4377_0033_R033_RSV1\t\t\t0x18\n\n \n#define ADF4377_0034_R034_RSV1\t\t\t0x08\n\n \n#define ADF4377_003A_R03A_RSV1\t\t\t0x5D\n\n \n#define ADF4377_003B_R03B_RSV1\t\t\t0x2B\n\n \n#define ADF4377_003D_O_VCO_BAND_MSK\t\tBIT(3)\n#define ADF4377_003D_O_VCO_CORE_MSK\t\tBIT(2)\n#define ADF4377_003D_O_VCO_BIAS_MSK\t\tBIT(1)\n\n \n#define ADF4377_003D_O_VCO_BAND_VCO_CALIB\t0x0\n#define ADF4377_003D_O_VCO_BAND_M_VCO\t\t0x1\n\n#define ADF4377_003D_O_VCO_CORE_VCO_CALIB\t0x0\n#define ADF4377_003D_O_VCO_CORE_M_VCO\t\t0x1\n\n#define ADF4377_003D_O_VCO_BIAS_VCO_CALIB\t0x0\n#define ADF4377_003D_O_VCO_BIAS_M_VCO\t\t0x1\n\n \n#define ADF4377_0042_R042_RSV1\t\t\t0x05\n\n \n#define ADF4377_0045_ADC_ST_CNV_MSK\t\tBIT(0)\n\n \n#define ADF4377_0049_EN_CLK2_MSK\t\tBIT(7)\n#define ADF4377_0049_EN_CLK1_MSK\t\tBIT(6)\n#define ADF4377_0049_REF_OK_MSK\t\t\tBIT(3)\n#define ADF4377_0049_ADC_BUSY_MSK\t\tBIT(2)\n#define ADF4377_0049_FSM_BUSY_MSK\t\tBIT(1)\n#define ADF4377_0049_LOCKED_MSK\t\t\tBIT(0)\n\n \n#define ADF4377_004B_VCO_CORE_MSK\t\tGENMASK(1, 0)\n\n \n#define ADF4377_004C_CHIP_TEMP_LSB_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_004D_CHIP_TEMP_MSB_MSK\t\tBIT(0)\n\n \n#define ADF4377_004F_VCO_BAND_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_0051_VCO_BIAS_MSK\t\tGENMASK(3, 0)\n\n \n#define ADF4377_0054_CHIP_VERSION_MSK\t\tGENMASK(7, 0)\n\n \n#define ADF4377_SPI_READ_CMD\t\t\tBIT(7)\n#define ADF4377_MAX_VCO_FREQ\t\t\t(12800ULL * HZ_PER_MHZ)\n#define ADF4377_MIN_VCO_FREQ\t\t\t(6400ULL * HZ_PER_MHZ)\n#define ADF4377_MAX_REFIN_FREQ\t\t\t(1000 * HZ_PER_MHZ)\n#define ADF4377_MIN_REFIN_FREQ\t\t\t(10 * HZ_PER_MHZ)\n#define ADF4377_MAX_FREQ_PFD\t\t\t(500 * HZ_PER_MHZ)\n#define ADF4377_MIN_FREQ_PFD\t\t\t(3 * HZ_PER_MHZ)\n#define ADF4377_MAX_CLKPN_FREQ\t\t\tADF4377_MAX_VCO_FREQ\n#define ADF4377_MIN_CLKPN_FREQ\t\t\t(ADF4377_MIN_VCO_FREQ / 8)\n#define ADF4377_FREQ_PFD_80MHZ\t\t\t(80 * HZ_PER_MHZ)\n#define ADF4377_FREQ_PFD_125MHZ\t\t\t(125 * HZ_PER_MHZ)\n#define ADF4377_FREQ_PFD_160MHZ\t\t\t(160 * HZ_PER_MHZ)\n#define ADF4377_FREQ_PFD_250MHZ\t\t\t(250 * HZ_PER_MHZ)\n#define ADF4377_FREQ_PFD_320MHZ\t\t\t(320 * HZ_PER_MHZ)\n\nenum {\n\tADF4377_FREQ,\n};\n\nenum muxout_select_mode {\n\tADF4377_MUXOUT_HIGH_Z = 0x0,\n\tADF4377_MUXOUT_LKDET = 0x1,\n\tADF4377_MUXOUT_LOW = 0x2,\n\tADF4377_MUXOUT_DIV_RCLK_2 = 0x4,\n\tADF4377_MUXOUT_DIV_NCLK_2 = 0x5,\n\tADF4377_MUXOUT_HIGH = 0x8,\n};\n\nstruct adf4377_state {\n\tstruct spi_device\t*spi;\n\tstruct regmap\t\t*regmap;\n\tstruct clk\t\t*clkin;\n\t \n\tstruct mutex\t\tlock;\n\tstruct notifier_block\tnb;\n\t \n\tunsigned int\t\tref_div_factor;\n\t \n\tunsigned int\t\tf_pfd;\n\t \n\tunsigned int\t\tclkin_freq;\n\t \n\tu8\t\t\tclkout_div_sel;\n\t \n\tu16\t\t\tn_int;\n\tu16\t\t\tsynth_lock_timeout;\n\tu16\t\t\tvco_alc_timeout;\n\tu16\t\t\tadc_clk_div;\n\tu16\t\t\tvco_band_div;\n\tu8\t\t\tdclk_div1;\n\tu8\t\t\tdclk_div2;\n\tu8\t\t\tdclk_mode;\n\tunsigned int\t\tf_div_rclk;\n\tenum muxout_select_mode\tmuxout_select;\n\tstruct gpio_desc\t*gpio_ce;\n\tstruct gpio_desc\t*gpio_enclk1;\n\tstruct gpio_desc\t*gpio_enclk2;\n\tu8\t\t\tbuf[2] __aligned(IIO_DMA_MINALIGN);\n};\n\nstatic const char * const adf4377_muxout_modes[] = {\n\t[ADF4377_MUXOUT_HIGH_Z] = \"high_z\",\n\t[ADF4377_MUXOUT_LKDET] = \"lock_detect\",\n\t[ADF4377_MUXOUT_LOW] = \"muxout_low\",\n\t[ADF4377_MUXOUT_DIV_RCLK_2] = \"f_div_rclk_2\",\n\t[ADF4377_MUXOUT_DIV_NCLK_2] = \"f_div_nclk_2\",\n\t[ADF4377_MUXOUT_HIGH] = \"muxout_high\",\n};\n\nstatic const struct reg_sequence adf4377_reg_defaults[] = {\n\t{ 0x42,  ADF4377_0042_R042_RSV1 },\n\t{ 0x3B,  ADF4377_003B_R03B_RSV1 },\n\t{ 0x3A,  ADF4377_003A_R03A_RSV1 },\n\t{ 0x34,  ADF4377_0034_R034_RSV1 },\n\t{ 0x33,  ADF4377_0033_R033_RSV1 },\n\t{ 0x32,  ADF4377_0032_R032_RSV1 },\n\t{ 0x31,  ADF4377_0031_R031_RSV1 },\n\t{ 0x2C,  ADF4377_002C_R02C_RSV1 },\n\t{ 0x25,  ADF4377_0025_R025_RSV1 },\n\t{ 0x23,  ADF4377_0023_R023_RSV1 },\n\t{ 0x22,  ADF4377_0022_R022_RSV1 },\n\t{ 0x21,  ADF4377_0021_R021_RSV1 },\n\t{ 0x1f,  ADF4377_001F_R01F_RSV1 },\n\t{ 0x1c,  ADF4377_001C_R01C_RSV1 },\n};\n\nstatic const struct regmap_config adf4377_regmap_config = {\n\t.reg_bits = 16,\n\t.val_bits = 8,\n\t.read_flag_mask = BIT(7),\n\t.max_register = 0x54,\n};\n\nstatic int adf4377_reg_access(struct iio_dev *indio_dev,\n\t\t\t      unsigned int reg,\n\t\t\t      unsigned int write_val,\n\t\t\t      unsigned int *read_val)\n{\n\tstruct adf4377_state *st = iio_priv(indio_dev);\n\n\tif (read_val)\n\t\treturn regmap_read(st->regmap, reg, read_val);\n\n\treturn regmap_write(st->regmap, reg, write_val);\n}\n\nstatic const struct iio_info adf4377_info = {\n\t.debugfs_reg_access = &adf4377_reg_access,\n};\n\nstatic int adf4377_soft_reset(struct adf4377_state *st)\n{\n\tunsigned int read_val;\n\tint ret;\n\n\tret = regmap_update_bits(st->regmap, 0x0, ADF4377_0000_SOFT_RESET_MSK |\n\t\t\t\t ADF4377_0000_SOFT_RESET_R_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0000_SOFT_RESET_MSK, 1) |\n\t\t\t\t FIELD_PREP(ADF4377_0000_SOFT_RESET_R_MSK, 1));\n\tif (ret)\n\t\treturn ret;\n\n\treturn regmap_read_poll_timeout(st->regmap, 0x0, read_val,\n\t\t\t\t\t!(read_val & (ADF4377_0000_SOFT_RESET_R_MSK |\n\t\t\t\t\tADF4377_0000_SOFT_RESET_R_MSK)), 200, 200 * 100);\n}\n\nstatic int adf4377_get_freq(struct adf4377_state *st, u64 *freq)\n{\n\tunsigned int ref_div_factor, n_int;\n\tu64 clkin_freq;\n\tint ret;\n\n\tmutex_lock(&st->lock);\n\tret = regmap_read(st->regmap, 0x12, &ref_div_factor);\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_bulk_read(st->regmap, 0x10, st->buf, sizeof(st->buf));\n\tif (ret)\n\t\tgoto exit;\n\n\tclkin_freq = clk_get_rate(st->clkin);\n\tref_div_factor = FIELD_GET(ADF4377_0012_R_DIV_MSK, ref_div_factor);\n\tn_int = FIELD_GET(ADF4377_0010_N_INT_LSB_MSK | ADF4377_0011_N_INT_MSB_MSK,\n\t\t\t  get_unaligned_le16(&st->buf));\n\n\t*freq = div_u64(clkin_freq, ref_div_factor) * n_int;\nexit:\n\tmutex_unlock(&st->lock);\n\n\treturn ret;\n}\n\nstatic int adf4377_set_freq(struct adf4377_state *st, u64 freq)\n{\n\tunsigned int read_val;\n\tu64 f_vco;\n\tint ret;\n\n\tmutex_lock(&st->lock);\n\n\tif (freq > ADF4377_MAX_CLKPN_FREQ || freq < ADF4377_MIN_CLKPN_FREQ) {\n\t\tret = -EINVAL;\n\t\tgoto exit;\n\t}\n\n\tret = regmap_update_bits(st->regmap, 0x1C, ADF4377_001C_EN_DNCLK_MSK |\n\t\t\t\t ADF4377_001C_EN_DRCLK_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_001C_EN_DNCLK_MSK, 1) |\n\t\t\t\t FIELD_PREP(ADF4377_001C_EN_DRCLK_MSK, 1));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_update_bits(st->regmap, 0x11, ADF4377_0011_EN_AUTOCAL_MSK |\n\t\t\t\t ADF4377_0011_DCLK_DIV2_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0011_EN_AUTOCAL_MSK, 1) |\n\t\t\t\t FIELD_PREP(ADF4377_0011_DCLK_DIV2_MSK, st->dclk_div2));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_update_bits(st->regmap, 0x2E, ADF4377_002E_EN_ADC_CNV_MSK |\n\t\t\t\t ADF4377_002E_EN_ADC_MSK |\n\t\t\t\t ADF4377_002E_ADC_A_CONV_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_002E_EN_ADC_CNV_MSK, 1) |\n\t\t\t\t FIELD_PREP(ADF4377_002E_EN_ADC_MSK, 1) |\n\t\t\t\t FIELD_PREP(ADF4377_002E_ADC_A_CONV_MSK,\n\t\t\t\t\t    ADF4377_002E_ADC_A_CONV_VCO_CALIB));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_update_bits(st->regmap, 0x20, ADF4377_0020_EN_ADC_CLK_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0020_EN_ADC_CLK_MSK, 1));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_update_bits(st->regmap, 0x2F, ADF4377_002F_DCLK_DIV1_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_002F_DCLK_DIV1_MSK, st->dclk_div1));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_update_bits(st->regmap, 0x24, ADF4377_0024_DCLK_MODE_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0024_DCLK_MODE_MSK, st->dclk_mode));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_write(st->regmap, 0x27,\n\t\t\t   FIELD_PREP(ADF4377_0027_SYNTH_LOCK_TO_LSB_MSK,\n\t\t\t\t      st->synth_lock_timeout));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_update_bits(st->regmap, 0x28, ADF4377_0028_SYNTH_LOCK_TO_MSB_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0028_SYNTH_LOCK_TO_MSB_MSK,\n\t\t\t\t\t    st->synth_lock_timeout >> 8));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_write(st->regmap, 0x29,\n\t\t\t   FIELD_PREP(ADF4377_0029_VCO_ALC_TO_LSB_MSK,\n\t\t\t\t      st->vco_alc_timeout));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_update_bits(st->regmap, 0x2A, ADF4377_002A_VCO_ALC_TO_MSB_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_002A_VCO_ALC_TO_MSB_MSK,\n\t\t\t\t\t    st->vco_alc_timeout >> 8));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_write(st->regmap, 0x26,\n\t\t\t   FIELD_PREP(ADF4377_0026_VCO_BAND_DIV_MSK, st->vco_band_div));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_write(st->regmap, 0x2D,\n\t\t\t   FIELD_PREP(ADF4377_002D_ADC_CLK_DIV_MSK, st->adc_clk_div));\n\tif (ret)\n\t\tgoto exit;\n\n\tst->clkout_div_sel = 0;\n\n\tf_vco = freq;\n\n\twhile (f_vco < ADF4377_MIN_VCO_FREQ) {\n\t\tf_vco <<= 1;\n\t\tst->clkout_div_sel++;\n\t}\n\n\tst->n_int = div_u64(freq, st->f_pfd);\n\n\tret = regmap_update_bits(st->regmap, 0x11, ADF4377_0011_EN_RDBLR_MSK |\n\t\t\t\t ADF4377_0011_N_INT_MSB_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0011_EN_RDBLR_MSK, 0) |\n\t\t\t\t FIELD_PREP(ADF4377_0011_N_INT_MSB_MSK, st->n_int >> 8));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_update_bits(st->regmap, 0x12, ADF4377_0012_R_DIV_MSK |\n\t\t\t\t ADF4377_0012_CLKOUT_DIV_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0012_CLKOUT_DIV_MSK, st->clkout_div_sel) |\n\t\t\t\t FIELD_PREP(ADF4377_0012_R_DIV_MSK, st->ref_div_factor));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_write(st->regmap, 0x10,\n\t\t\t   FIELD_PREP(ADF4377_0010_N_INT_LSB_MSK, st->n_int));\n\tif (ret)\n\t\tgoto exit;\n\n\tret = regmap_read_poll_timeout(st->regmap, 0x49, read_val,\n\t\t\t\t       !(read_val & (ADF4377_0049_FSM_BUSY_MSK)), 200, 200 * 100);\n\tif (ret)\n\t\tgoto exit;\n\n\t \n\tret = regmap_update_bits(st->regmap, 0x1C, ADF4377_001C_EN_DNCLK_MSK |\n\t\t\t\t ADF4377_001C_EN_DRCLK_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_001C_EN_DNCLK_MSK, 0) |\n\t\t\t\t FIELD_PREP(ADF4377_001C_EN_DRCLK_MSK, 0));\n\tif (ret)\n\t\tgoto exit;\n\n\t \n\tret = regmap_update_bits(st->regmap, 0x20, ADF4377_0020_EN_ADC_CLK_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0020_EN_ADC_CLK_MSK, 0));\n\tif (ret)\n\t\tgoto exit;\n\n\t \n\tret = regmap_update_bits(st->regmap, 0x19, ADF4377_0019_CLKOUT2_OP_MSK |\n\t\t\t\t ADF4377_0019_CLKOUT1_OP_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0019_CLKOUT1_OP_MSK,\n\t\t\t\t\t    ADF4377_0019_CLKOUT_420MV) |\n\t\t\t\t FIELD_PREP(ADF4377_0019_CLKOUT2_OP_MSK,\n\t\t\t\t\t    ADF4377_0019_CLKOUT_420MV));\n\nexit:\n\tmutex_unlock(&st->lock);\n\n\treturn ret;\n}\n\nstatic void adf4377_gpio_init(struct adf4377_state *st)\n{\n\tif (st->gpio_ce) {\n\t\tgpiod_set_value(st->gpio_ce, 1);\n\n\t\t \n\t\tfsleep(200);\n\t}\n\n\tif (st->gpio_enclk1)\n\t\tgpiod_set_value(st->gpio_enclk1, 1);\n\n\tif (st->gpio_enclk2)\n\t\tgpiod_set_value(st->gpio_enclk2, 1);\n}\n\nstatic int adf4377_init(struct adf4377_state *st)\n{\n\tstruct spi_device *spi = st->spi;\n\tint ret;\n\n\tadf4377_gpio_init(st);\n\n\tret = adf4377_soft_reset(st);\n\tif (ret) {\n\t\tdev_err(&spi->dev, \"Failed to soft reset.\\n\");\n\t\treturn ret;\n\t}\n\n\tret = regmap_multi_reg_write(st->regmap, adf4377_reg_defaults,\n\t\t\t\t     ARRAY_SIZE(adf4377_reg_defaults));\n\tif (ret) {\n\t\tdev_err(&spi->dev, \"Failed to set default registers.\\n\");\n\t\treturn ret;\n\t}\n\n\tret = regmap_update_bits(st->regmap, 0x00,\n\t\t\t\t ADF4377_0000_SDO_ACTIVE_MSK | ADF4377_0000_SDO_ACTIVE_R_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_0000_SDO_ACTIVE_MSK,\n\t\t\t\t\t    ADF4377_0000_SDO_ACTIVE_SPI_4W) |\n\t\t\t\t FIELD_PREP(ADF4377_0000_SDO_ACTIVE_R_MSK,\n\t\t\t\t\t    ADF4377_0000_SDO_ACTIVE_SPI_4W));\n\tif (ret) {\n\t\tdev_err(&spi->dev, \"Failed to set 4-Wire Operation.\\n\");\n\t\treturn ret;\n\t}\n\n\tst->clkin_freq = clk_get_rate(st->clkin);\n\n\t \n\tret = regmap_write(st->regmap, 0x1a,\n\t\t\t   FIELD_PREP(ADF4377_001A_PD_ALL_MSK, 0) |\n\t\t\t   FIELD_PREP(ADF4377_001A_PD_RDIV_MSK, 0) |\n\t\t\t   FIELD_PREP(ADF4377_001A_PD_NDIV_MSK, 0) |\n\t\t\t   FIELD_PREP(ADF4377_001A_PD_VCO_MSK, 0) |\n\t\t\t   FIELD_PREP(ADF4377_001A_PD_LD_MSK, 0) |\n\t\t\t   FIELD_PREP(ADF4377_001A_PD_PFDCP_MSK, 0) |\n\t\t\t   FIELD_PREP(ADF4377_001A_PD_CLKOUT1_MSK, 0) |\n\t\t\t   FIELD_PREP(ADF4377_001A_PD_CLKOUT2_MSK, 0));\n\tif (ret) {\n\t\tdev_err(&spi->dev, \"Failed to set power down registers.\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_update_bits(st->regmap, 0x1D,\n\t\t\t\t ADF4377_001D_MUXOUT_MSK,\n\t\t\t\t FIELD_PREP(ADF4377_001D_MUXOUT_MSK, st->muxout_select));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tst->ref_div_factor = 0;\n\tdo {\n\t\tst->ref_div_factor++;\n\t\tst->f_pfd = st->clkin_freq / st->ref_div_factor;\n\t} while (st->f_pfd > ADF4377_MAX_FREQ_PFD);\n\n\tif (st->f_pfd > ADF4377_MAX_FREQ_PFD || st->f_pfd < ADF4377_MIN_FREQ_PFD)\n\t\treturn -EINVAL;\n\n\tst->f_div_rclk = st->f_pfd;\n\n\tif (st->f_pfd <= ADF4377_FREQ_PFD_80MHZ) {\n\t\tst->dclk_div1 = ADF4377_002F_DCLK_DIV1_1;\n\t\tst->dclk_div2 = ADF4377_0011_DCLK_DIV2_1;\n\t\tst->dclk_mode = 0;\n\t} else if (st->f_pfd <= ADF4377_FREQ_PFD_125MHZ) {\n\t\tst->dclk_div1 = ADF4377_002F_DCLK_DIV1_1;\n\t\tst->dclk_div2 = ADF4377_0011_DCLK_DIV2_1;\n\t\tst->dclk_mode = 1;\n\t} else if (st->f_pfd <= ADF4377_FREQ_PFD_160MHZ) {\n\t\tst->dclk_div1 = ADF4377_002F_DCLK_DIV1_2;\n\t\tst->dclk_div2 = ADF4377_0011_DCLK_DIV2_1;\n\t\tst->dclk_mode = 0;\n\t\tst->f_div_rclk /= 2;\n\t} else if (st->f_pfd <= ADF4377_FREQ_PFD_250MHZ) {\n\t\tst->dclk_div1 = ADF4377_002F_DCLK_DIV1_2;\n\t\tst->dclk_div2 = ADF4377_0011_DCLK_DIV2_1;\n\t\tst->dclk_mode = 1;\n\t\tst->f_div_rclk /= 2;\n\t} else if (st->f_pfd <= ADF4377_FREQ_PFD_320MHZ) {\n\t\tst->dclk_div1 = ADF4377_002F_DCLK_DIV1_2;\n\t\tst->dclk_div2 = ADF4377_0011_DCLK_DIV2_2;\n\t\tst->dclk_mode = 0;\n\t\tst->f_div_rclk /= 4;\n\t} else {\n\t\tst->dclk_div1 = ADF4377_002F_DCLK_DIV1_2;\n\t\tst->dclk_div2 = ADF4377_0011_DCLK_DIV2_2;\n\t\tst->dclk_mode = 1;\n\t\tst->f_div_rclk /= 4;\n\t}\n\n\tst->synth_lock_timeout = DIV_ROUND_UP(st->f_div_rclk, 50000);\n\tst->vco_alc_timeout = DIV_ROUND_UP(st->f_div_rclk, 20000);\n\tst->vco_band_div = DIV_ROUND_UP(st->f_div_rclk, 150000 * 16 * (1 << st->dclk_mode));\n\tst->adc_clk_div = DIV_ROUND_UP((st->f_div_rclk / 400000 - 2), 4);\n\n\treturn 0;\n}\n\nstatic ssize_t adf4377_read(struct iio_dev *indio_dev, uintptr_t private,\n\t\t\t    const struct iio_chan_spec *chan, char *buf)\n{\n\tstruct adf4377_state *st = iio_priv(indio_dev);\n\tu64 val = 0;\n\tint ret;\n\n\tswitch ((u32)private) {\n\tcase ADF4377_FREQ:\n\t\tret = adf4377_get_freq(st, &val);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\treturn sysfs_emit(buf, \"%llu\\n\", val);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic ssize_t adf4377_write(struct iio_dev *indio_dev, uintptr_t private,\n\t\t\t     const struct iio_chan_spec *chan, const char *buf,\n\t\t\t     size_t len)\n{\n\tstruct adf4377_state *st = iio_priv(indio_dev);\n\tunsigned long long freq;\n\tint ret;\n\n\tswitch ((u32)private) {\n\tcase ADF4377_FREQ:\n\t\tret = kstrtoull(buf, 10, &freq);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = adf4377_set_freq(st, freq);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\treturn len;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\n#define _ADF4377_EXT_INFO(_name, _shared, _ident) { \\\n\t\t.name = _name, \\\n\t\t.read = adf4377_read, \\\n\t\t.write = adf4377_write, \\\n\t\t.private = _ident, \\\n\t\t.shared = _shared, \\\n\t}\n\nstatic const struct iio_chan_spec_ext_info adf4377_ext_info[] = {\n\t \n\t_ADF4377_EXT_INFO(\"frequency\", IIO_SEPARATE, ADF4377_FREQ),\n\t{ }\n};\n\nstatic const struct iio_chan_spec adf4377_channels[] = {\n\t{\n\t\t.type = IIO_ALTVOLTAGE,\n\t\t.indexed = 1,\n\t\t.output = 1,\n\t\t.channel = 0,\n\t\t.ext_info = adf4377_ext_info,\n\t},\n};\n\nstatic int adf4377_properties_parse(struct adf4377_state *st)\n{\n\tstruct spi_device *spi = st->spi;\n\tconst char *str;\n\tint ret;\n\n\tst->clkin = devm_clk_get_enabled(&spi->dev, \"ref_in\");\n\tif (IS_ERR(st->clkin))\n\t\treturn dev_err_probe(&spi->dev, PTR_ERR(st->clkin),\n\t\t\t\t     \"failed to get the reference input clock\\n\");\n\n\tst->gpio_ce = devm_gpiod_get_optional(&st->spi->dev, \"chip-enable\",\n\t\t\t\t\t      GPIOD_OUT_LOW);\n\tif (IS_ERR(st->gpio_ce))\n\t\treturn dev_err_probe(&spi->dev, PTR_ERR(st->gpio_ce),\n\t\t\t\t     \"failed to get the CE GPIO\\n\");\n\n\tst->gpio_enclk1 = devm_gpiod_get_optional(&st->spi->dev, \"clk1-enable\",\n\t\t\t\t\t\t  GPIOD_OUT_LOW);\n\tif (IS_ERR(st->gpio_enclk1))\n\t\treturn dev_err_probe(&spi->dev, PTR_ERR(st->gpio_enclk1),\n\t\t\t\t     \"failed to get the CE GPIO\\n\");\n\n\tst->gpio_enclk2 = devm_gpiod_get_optional(&st->spi->dev, \"clk2-enable\",\n\t\t\t\t\t\t  GPIOD_OUT_LOW);\n\tif (IS_ERR(st->gpio_enclk2))\n\t\treturn dev_err_probe(&spi->dev, PTR_ERR(st->gpio_enclk2),\n\t\t\t\t     \"failed to get the CE GPIO\\n\");\n\n\tret = device_property_read_string(&spi->dev, \"adi,muxout-select\", &str);\n\tif (ret) {\n\t\tst->muxout_select = ADF4377_MUXOUT_HIGH_Z;\n\t} else {\n\t\tret = match_string(adf4377_muxout_modes, ARRAY_SIZE(adf4377_muxout_modes), str);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tst->muxout_select = ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int adf4377_freq_change(struct notifier_block *nb, unsigned long action, void *data)\n{\n\tstruct adf4377_state *st = container_of(nb, struct adf4377_state, nb);\n\tint ret;\n\n\tif (action == POST_RATE_CHANGE) {\n\t\tmutex_lock(&st->lock);\n\t\tret = notifier_from_errno(adf4377_init(st));\n\t\tmutex_unlock(&st->lock);\n\t\treturn ret;\n\t}\n\n\treturn NOTIFY_OK;\n}\n\nstatic int adf4377_probe(struct spi_device *spi)\n{\n\tstruct iio_dev *indio_dev;\n\tstruct regmap *regmap;\n\tstruct adf4377_state *st;\n\tint ret;\n\n\tindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\n\tregmap = devm_regmap_init_spi(spi, &adf4377_regmap_config);\n\tif (IS_ERR(regmap))\n\t\treturn PTR_ERR(regmap);\n\n\tst = iio_priv(indio_dev);\n\n\tindio_dev->info = &adf4377_info;\n\tindio_dev->name = \"adf4377\";\n\tindio_dev->channels = adf4377_channels;\n\tindio_dev->num_channels = ARRAY_SIZE(adf4377_channels);\n\n\tst->regmap = regmap;\n\tst->spi = spi;\n\tmutex_init(&st->lock);\n\n\tret = adf4377_properties_parse(st);\n\tif (ret)\n\t\treturn ret;\n\n\tst->nb.notifier_call = adf4377_freq_change;\n\tret = devm_clk_notifier_register(&spi->dev, st->clkin, &st->nb);\n\tif (ret)\n\t\treturn ret;\n\n\tret = adf4377_init(st);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_iio_device_register(&spi->dev, indio_dev);\n}\n\nstatic const struct spi_device_id adf4377_id[] = {\n\t{ \"adf4377\", 0 },\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, adf4377_id);\n\nstatic const struct of_device_id adf4377_of_match[] = {\n\t{ .compatible = \"adi,adf4377\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, adf4377_of_match);\n\nstatic struct spi_driver adf4377_driver = {\n\t.driver = {\n\t\t.name = \"adf4377\",\n\t\t.of_match_table = adf4377_of_match,\n\t},\n\t.probe = adf4377_probe,\n\t.id_table = adf4377_id,\n};\nmodule_spi_driver(adf4377_driver);\n\nMODULE_AUTHOR(\"Antoniu Miclaus <antoniu.miclaus@analog.com>\");\nMODULE_DESCRIPTION(\"Analog Devices ADF4377\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}