{
  "module_name": "ad5446.c",
  "hash_id": "587474b52bc1fd70228fca94b744522be50de1b9d219e66f3cbeb0fe7afcb1cf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/dac/ad5446.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/workqueue.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/sysfs.h>\n#include <linux/list.h>\n#include <linux/spi/spi.h>\n#include <linux/i2c.h>\n#include <linux/regulator/consumer.h>\n#include <linux/err.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n\n#include <linux/iio/iio.h>\n#include <linux/iio/sysfs.h>\n\n#include <asm/unaligned.h>\n\n#define MODE_PWRDWN_1k\t\t0x1\n#define MODE_PWRDWN_100k\t0x2\n#define MODE_PWRDWN_TRISTATE\t0x3\n\n \n\nstruct ad5446_state {\n\tstruct device\t\t*dev;\n\tconst struct ad5446_chip_info\t*chip_info;\n\tstruct regulator\t\t*reg;\n\tunsigned short\t\t\tvref_mv;\n\tunsigned\t\t\tcached_val;\n\tunsigned\t\t\tpwr_down_mode;\n\tunsigned\t\t\tpwr_down;\n\tstruct mutex\t\t\tlock;\n};\n\n \n\nstruct ad5446_chip_info {\n\tstruct iio_chan_spec\tchannel;\n\tu16\t\t\tint_vref_mv;\n\tint\t\t\t(*write)(struct ad5446_state *st, unsigned val);\n};\n\nstatic const char * const ad5446_powerdown_modes[] = {\n\t\"1kohm_to_gnd\", \"100kohm_to_gnd\", \"three_state\"\n};\n\nstatic int ad5446_set_powerdown_mode(struct iio_dev *indio_dev,\n\tconst struct iio_chan_spec *chan, unsigned int mode)\n{\n\tstruct ad5446_state *st = iio_priv(indio_dev);\n\n\tst->pwr_down_mode = mode + 1;\n\n\treturn 0;\n}\n\nstatic int ad5446_get_powerdown_mode(struct iio_dev *indio_dev,\n\tconst struct iio_chan_spec *chan)\n{\n\tstruct ad5446_state *st = iio_priv(indio_dev);\n\n\treturn st->pwr_down_mode - 1;\n}\n\nstatic const struct iio_enum ad5446_powerdown_mode_enum = {\n\t.items = ad5446_powerdown_modes,\n\t.num_items = ARRAY_SIZE(ad5446_powerdown_modes),\n\t.get = ad5446_get_powerdown_mode,\n\t.set = ad5446_set_powerdown_mode,\n};\n\nstatic ssize_t ad5446_read_dac_powerdown(struct iio_dev *indio_dev,\n\t\t\t\t\t   uintptr_t private,\n\t\t\t\t\t   const struct iio_chan_spec *chan,\n\t\t\t\t\t   char *buf)\n{\n\tstruct ad5446_state *st = iio_priv(indio_dev);\n\n\treturn sysfs_emit(buf, \"%d\\n\", st->pwr_down);\n}\n\nstatic ssize_t ad5446_write_dac_powerdown(struct iio_dev *indio_dev,\n\t\t\t\t\t    uintptr_t private,\n\t\t\t\t\t    const struct iio_chan_spec *chan,\n\t\t\t\t\t    const char *buf, size_t len)\n{\n\tstruct ad5446_state *st = iio_priv(indio_dev);\n\tunsigned int shift;\n\tunsigned int val;\n\tbool powerdown;\n\tint ret;\n\n\tret = kstrtobool(buf, &powerdown);\n\tif (ret)\n\t\treturn ret;\n\n\tmutex_lock(&st->lock);\n\tst->pwr_down = powerdown;\n\n\tif (st->pwr_down) {\n\t\tshift = chan->scan_type.realbits + chan->scan_type.shift;\n\t\tval = st->pwr_down_mode << shift;\n\t} else {\n\t\tval = st->cached_val;\n\t}\n\n\tret = st->chip_info->write(st, val);\n\tmutex_unlock(&st->lock);\n\n\treturn ret ? ret : len;\n}\n\nstatic const struct iio_chan_spec_ext_info ad5446_ext_info_powerdown[] = {\n\t{\n\t\t.name = \"powerdown\",\n\t\t.read = ad5446_read_dac_powerdown,\n\t\t.write = ad5446_write_dac_powerdown,\n\t\t.shared = IIO_SEPARATE,\n\t},\n\tIIO_ENUM(\"powerdown_mode\", IIO_SEPARATE, &ad5446_powerdown_mode_enum),\n\tIIO_ENUM_AVAILABLE(\"powerdown_mode\", IIO_SHARED_BY_TYPE, &ad5446_powerdown_mode_enum),\n\t{ },\n};\n\n#define _AD5446_CHANNEL(bits, storage, _shift, ext) { \\\n\t.type = IIO_VOLTAGE, \\\n\t.indexed = 1, \\\n\t.output = 1, \\\n\t.channel = 0, \\\n\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW), \\\n\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE), \\\n\t.scan_type = { \\\n\t\t.sign = 'u', \\\n\t\t.realbits = (bits), \\\n\t\t.storagebits = (storage), \\\n\t\t.shift = (_shift), \\\n\t\t}, \\\n\t.ext_info = (ext), \\\n}\n\n#define AD5446_CHANNEL(bits, storage, shift) \\\n\t_AD5446_CHANNEL(bits, storage, shift, NULL)\n\n#define AD5446_CHANNEL_POWERDOWN(bits, storage, shift) \\\n\t_AD5446_CHANNEL(bits, storage, shift, ad5446_ext_info_powerdown)\n\nstatic int ad5446_read_raw(struct iio_dev *indio_dev,\n\t\t\t   struct iio_chan_spec const *chan,\n\t\t\t   int *val,\n\t\t\t   int *val2,\n\t\t\t   long m)\n{\n\tstruct ad5446_state *st = iio_priv(indio_dev);\n\n\tswitch (m) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\t*val = st->cached_val >> chan->scan_type.shift;\n\t\treturn IIO_VAL_INT;\n\tcase IIO_CHAN_INFO_SCALE:\n\t\t*val = st->vref_mv;\n\t\t*val2 = chan->scan_type.realbits;\n\t\treturn IIO_VAL_FRACTIONAL_LOG2;\n\t}\n\treturn -EINVAL;\n}\n\nstatic int ad5446_write_raw(struct iio_dev *indio_dev,\n\t\t\t       struct iio_chan_spec const *chan,\n\t\t\t       int val,\n\t\t\t       int val2,\n\t\t\t       long mask)\n{\n\tstruct ad5446_state *st = iio_priv(indio_dev);\n\tint ret = 0;\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tif (val >= (1 << chan->scan_type.realbits) || val < 0)\n\t\t\treturn -EINVAL;\n\n\t\tval <<= chan->scan_type.shift;\n\t\tmutex_lock(&st->lock);\n\t\tst->cached_val = val;\n\t\tif (!st->pwr_down)\n\t\t\tret = st->chip_info->write(st, val);\n\t\tmutex_unlock(&st->lock);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct iio_info ad5446_info = {\n\t.read_raw = ad5446_read_raw,\n\t.write_raw = ad5446_write_raw,\n};\n\nstatic int ad5446_probe(struct device *dev, const char *name,\n\t\t\tconst struct ad5446_chip_info *chip_info)\n{\n\tstruct ad5446_state *st;\n\tstruct iio_dev *indio_dev;\n\tstruct regulator *reg;\n\tint ret, voltage_uv = 0;\n\n\treg = devm_regulator_get(dev, \"vcc\");\n\tif (!IS_ERR(reg)) {\n\t\tret = regulator_enable(reg);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = regulator_get_voltage(reg);\n\t\tif (ret < 0)\n\t\t\tgoto error_disable_reg;\n\n\t\tvoltage_uv = ret;\n\t}\n\n\tindio_dev = devm_iio_device_alloc(dev, sizeof(*st));\n\tif (indio_dev == NULL) {\n\t\tret = -ENOMEM;\n\t\tgoto error_disable_reg;\n\t}\n\tst = iio_priv(indio_dev);\n\tst->chip_info = chip_info;\n\n\tdev_set_drvdata(dev, indio_dev);\n\tst->reg = reg;\n\tst->dev = dev;\n\n\tindio_dev->name = name;\n\tindio_dev->info = &ad5446_info;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->channels = &st->chip_info->channel;\n\tindio_dev->num_channels = 1;\n\n\tmutex_init(&st->lock);\n\n\tst->pwr_down_mode = MODE_PWRDWN_1k;\n\n\tif (st->chip_info->int_vref_mv)\n\t\tst->vref_mv = st->chip_info->int_vref_mv;\n\telse if (voltage_uv)\n\t\tst->vref_mv = voltage_uv / 1000;\n\telse\n\t\tdev_warn(dev, \"reference voltage unspecified\\n\");\n\n\tret = iio_device_register(indio_dev);\n\tif (ret)\n\t\tgoto error_disable_reg;\n\n\treturn 0;\n\nerror_disable_reg:\n\tif (!IS_ERR(reg))\n\t\tregulator_disable(reg);\n\treturn ret;\n}\n\nstatic void ad5446_remove(struct device *dev)\n{\n\tstruct iio_dev *indio_dev = dev_get_drvdata(dev);\n\tstruct ad5446_state *st = iio_priv(indio_dev);\n\n\tiio_device_unregister(indio_dev);\n\tif (!IS_ERR(st->reg))\n\t\tregulator_disable(st->reg);\n}\n\n#if IS_ENABLED(CONFIG_SPI_MASTER)\n\nstatic int ad5446_write(struct ad5446_state *st, unsigned val)\n{\n\tstruct spi_device *spi = to_spi_device(st->dev);\n\t__be16 data = cpu_to_be16(val);\n\n\treturn spi_write(spi, &data, sizeof(data));\n}\n\nstatic int ad5660_write(struct ad5446_state *st, unsigned val)\n{\n\tstruct spi_device *spi = to_spi_device(st->dev);\n\tuint8_t data[3];\n\n\tput_unaligned_be24(val, &data[0]);\n\n\treturn spi_write(spi, data, sizeof(data));\n}\n\n \nenum ad5446_supported_spi_device_ids {\n\tID_AD5300,\n\tID_AD5310,\n\tID_AD5320,\n\tID_AD5444,\n\tID_AD5446,\n\tID_AD5450,\n\tID_AD5451,\n\tID_AD5541A,\n\tID_AD5512A,\n\tID_AD5553,\n\tID_AD5600,\n\tID_AD5601,\n\tID_AD5611,\n\tID_AD5621,\n\tID_AD5641,\n\tID_AD5620_2500,\n\tID_AD5620_1250,\n\tID_AD5640_2500,\n\tID_AD5640_1250,\n\tID_AD5660_2500,\n\tID_AD5660_1250,\n\tID_AD5662,\n};\n\nstatic const struct ad5446_chip_info ad5446_spi_chip_info[] = {\n\t[ID_AD5300] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(8, 16, 4),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5310] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(10, 16, 2),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5320] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(12, 16, 0),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5444] = {\n\t\t.channel = AD5446_CHANNEL(12, 16, 2),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5446] = {\n\t\t.channel = AD5446_CHANNEL(14, 16, 0),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5450] = {\n\t\t.channel = AD5446_CHANNEL(8, 16, 6),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5451] = {\n\t\t.channel = AD5446_CHANNEL(10, 16, 4),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5541A] = {\n\t\t.channel = AD5446_CHANNEL(16, 16, 0),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5512A] = {\n\t\t.channel = AD5446_CHANNEL(12, 16, 4),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5553] = {\n\t\t.channel = AD5446_CHANNEL(14, 16, 0),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5600] = {\n\t\t.channel = AD5446_CHANNEL(16, 16, 0),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5601] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(8, 16, 6),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5611] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(10, 16, 4),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5621] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(12, 16, 2),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5641] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(14, 16, 0),\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5620_2500] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(12, 16, 2),\n\t\t.int_vref_mv = 2500,\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5620_1250] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(12, 16, 2),\n\t\t.int_vref_mv = 1250,\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5640_2500] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(14, 16, 0),\n\t\t.int_vref_mv = 2500,\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5640_1250] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(14, 16, 0),\n\t\t.int_vref_mv = 1250,\n\t\t.write = ad5446_write,\n\t},\n\t[ID_AD5660_2500] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(16, 16, 0),\n\t\t.int_vref_mv = 2500,\n\t\t.write = ad5660_write,\n\t},\n\t[ID_AD5660_1250] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(16, 16, 0),\n\t\t.int_vref_mv = 1250,\n\t\t.write = ad5660_write,\n\t},\n\t[ID_AD5662] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(16, 16, 0),\n\t\t.write = ad5660_write,\n\t},\n};\n\nstatic const struct spi_device_id ad5446_spi_ids[] = {\n\t{\"ad5300\", ID_AD5300},\n\t{\"ad5310\", ID_AD5310},\n\t{\"ad5320\", ID_AD5320},\n\t{\"ad5444\", ID_AD5444},\n\t{\"ad5446\", ID_AD5446},\n\t{\"ad5450\", ID_AD5450},\n\t{\"ad5451\", ID_AD5451},\n\t{\"ad5452\", ID_AD5444},  \n\t{\"ad5453\", ID_AD5446},  \n\t{\"ad5512a\", ID_AD5512A},\n\t{\"ad5541a\", ID_AD5541A},\n\t{\"ad5542a\", ID_AD5541A},  \n\t{\"ad5543\", ID_AD5541A},  \n\t{\"ad5553\", ID_AD5553},\n\t{\"ad5600\", ID_AD5600},\n\t{\"ad5601\", ID_AD5601},\n\t{\"ad5611\", ID_AD5611},\n\t{\"ad5621\", ID_AD5621},\n\t{\"ad5641\", ID_AD5641},\n\t{\"ad5620-2500\", ID_AD5620_2500},  \n\t{\"ad5620-1250\", ID_AD5620_1250},  \n\t{\"ad5640-2500\", ID_AD5640_2500},\n\t{\"ad5640-1250\", ID_AD5640_1250},\n\t{\"ad5660-2500\", ID_AD5660_2500},\n\t{\"ad5660-1250\", ID_AD5660_1250},\n\t{\"ad5662\", ID_AD5662},\n\t{\"dac081s101\", ID_AD5300},  \n\t{\"dac101s101\", ID_AD5310},\n\t{\"dac121s101\", ID_AD5320},\n\t{\"dac7512\", ID_AD5320},\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, ad5446_spi_ids);\n\nstatic const struct of_device_id ad5446_of_ids[] = {\n\t{ .compatible = \"ti,dac7512\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, ad5446_of_ids);\n\nstatic int ad5446_spi_probe(struct spi_device *spi)\n{\n\tconst struct spi_device_id *id = spi_get_device_id(spi);\n\n\treturn ad5446_probe(&spi->dev, id->name,\n\t\t&ad5446_spi_chip_info[id->driver_data]);\n}\n\nstatic void ad5446_spi_remove(struct spi_device *spi)\n{\n\tad5446_remove(&spi->dev);\n}\n\nstatic struct spi_driver ad5446_spi_driver = {\n\t.driver = {\n\t\t.name\t= \"ad5446\",\n\t\t.of_match_table = ad5446_of_ids,\n\t},\n\t.probe\t\t= ad5446_spi_probe,\n\t.remove\t\t= ad5446_spi_remove,\n\t.id_table\t= ad5446_spi_ids,\n};\n\nstatic int __init ad5446_spi_register_driver(void)\n{\n\treturn spi_register_driver(&ad5446_spi_driver);\n}\n\nstatic void ad5446_spi_unregister_driver(void)\n{\n\tspi_unregister_driver(&ad5446_spi_driver);\n}\n\n#else\n\nstatic inline int ad5446_spi_register_driver(void) { return 0; }\nstatic inline void ad5446_spi_unregister_driver(void) { }\n\n#endif\n\n#if IS_ENABLED(CONFIG_I2C)\n\nstatic int ad5622_write(struct ad5446_state *st, unsigned val)\n{\n\tstruct i2c_client *client = to_i2c_client(st->dev);\n\t__be16 data = cpu_to_be16(val);\n\tint ret;\n\n\tret = i2c_master_send(client, (char *)&data, sizeof(data));\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret != sizeof(data))\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\n \nenum ad5446_supported_i2c_device_ids {\n\tID_AD5602,\n\tID_AD5612,\n\tID_AD5622,\n};\n\nstatic const struct ad5446_chip_info ad5446_i2c_chip_info[] = {\n\t[ID_AD5602] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(8, 16, 4),\n\t\t.write = ad5622_write,\n\t},\n\t[ID_AD5612] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(10, 16, 2),\n\t\t.write = ad5622_write,\n\t},\n\t[ID_AD5622] = {\n\t\t.channel = AD5446_CHANNEL_POWERDOWN(12, 16, 0),\n\t\t.write = ad5622_write,\n\t},\n};\n\nstatic int ad5446_i2c_probe(struct i2c_client *i2c)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(i2c);\n\treturn ad5446_probe(&i2c->dev, id->name,\n\t\t&ad5446_i2c_chip_info[id->driver_data]);\n}\n\nstatic void ad5446_i2c_remove(struct i2c_client *i2c)\n{\n\tad5446_remove(&i2c->dev);\n}\n\nstatic const struct i2c_device_id ad5446_i2c_ids[] = {\n\t{\"ad5301\", ID_AD5602},\n\t{\"ad5311\", ID_AD5612},\n\t{\"ad5321\", ID_AD5622},\n\t{\"ad5602\", ID_AD5602},\n\t{\"ad5612\", ID_AD5612},\n\t{\"ad5622\", ID_AD5622},\n\t{}\n};\nMODULE_DEVICE_TABLE(i2c, ad5446_i2c_ids);\n\nstatic struct i2c_driver ad5446_i2c_driver = {\n\t.driver = {\n\t\t   .name = \"ad5446\",\n\t},\n\t.probe = ad5446_i2c_probe,\n\t.remove = ad5446_i2c_remove,\n\t.id_table = ad5446_i2c_ids,\n};\n\nstatic int __init ad5446_i2c_register_driver(void)\n{\n\treturn i2c_add_driver(&ad5446_i2c_driver);\n}\n\nstatic void __exit ad5446_i2c_unregister_driver(void)\n{\n\ti2c_del_driver(&ad5446_i2c_driver);\n}\n\n#else\n\nstatic inline int ad5446_i2c_register_driver(void) { return 0; }\nstatic inline void ad5446_i2c_unregister_driver(void) { }\n\n#endif\n\nstatic int __init ad5446_init(void)\n{\n\tint ret;\n\n\tret = ad5446_spi_register_driver();\n\tif (ret)\n\t\treturn ret;\n\n\tret = ad5446_i2c_register_driver();\n\tif (ret) {\n\t\tad5446_spi_unregister_driver();\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\nmodule_init(ad5446_init);\n\nstatic void __exit ad5446_exit(void)\n{\n\tad5446_i2c_unregister_driver();\n\tad5446_spi_unregister_driver();\n}\nmodule_exit(ad5446_exit);\n\nMODULE_AUTHOR(\"Michael Hennerich <michael.hennerich@analog.com>\");\nMODULE_DESCRIPTION(\"Analog Devices AD5444/AD5446 DAC\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}