{
  "module_name": "ad5686.c",
  "hash_id": "85c20cc61111ba47120126f6e13b305543ff7c561a896be5b0e7991c6fa1cbb7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/dac/ad5686.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/fs.h>\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/sysfs.h>\n#include <linux/regulator/consumer.h>\n\n#include <linux/iio/iio.h>\n#include <linux/iio/sysfs.h>\n\n#include \"ad5686.h\"\n\nstatic const char * const ad5686_powerdown_modes[] = {\n\t\"1kohm_to_gnd\",\n\t\"100kohm_to_gnd\",\n\t\"three_state\"\n};\n\nstatic int ad5686_get_powerdown_mode(struct iio_dev *indio_dev,\n\t\t\t\t     const struct iio_chan_spec *chan)\n{\n\tstruct ad5686_state *st = iio_priv(indio_dev);\n\n\treturn ((st->pwr_down_mode >> (chan->channel * 2)) & 0x3) - 1;\n}\n\nstatic int ad5686_set_powerdown_mode(struct iio_dev *indio_dev,\n\t\t\t\t     const struct iio_chan_spec *chan,\n\t\t\t\t     unsigned int mode)\n{\n\tstruct ad5686_state *st = iio_priv(indio_dev);\n\n\tst->pwr_down_mode &= ~(0x3 << (chan->channel * 2));\n\tst->pwr_down_mode |= ((mode + 1) << (chan->channel * 2));\n\n\treturn 0;\n}\n\nstatic const struct iio_enum ad5686_powerdown_mode_enum = {\n\t.items = ad5686_powerdown_modes,\n\t.num_items = ARRAY_SIZE(ad5686_powerdown_modes),\n\t.get = ad5686_get_powerdown_mode,\n\t.set = ad5686_set_powerdown_mode,\n};\n\nstatic ssize_t ad5686_read_dac_powerdown(struct iio_dev *indio_dev,\n\t\tuintptr_t private, const struct iio_chan_spec *chan, char *buf)\n{\n\tstruct ad5686_state *st = iio_priv(indio_dev);\n\n\treturn sysfs_emit(buf, \"%d\\n\", !!(st->pwr_down_mask &\n\t\t\t\t       (0x3 << (chan->channel * 2))));\n}\n\nstatic ssize_t ad5686_write_dac_powerdown(struct iio_dev *indio_dev,\n\t\t\t\t\t  uintptr_t private,\n\t\t\t\t\t  const struct iio_chan_spec *chan,\n\t\t\t\t\t  const char *buf,\n\t\t\t\t\t  size_t len)\n{\n\tbool readin;\n\tint ret;\n\tstruct ad5686_state *st = iio_priv(indio_dev);\n\tunsigned int val, ref_bit_msk;\n\tu8 shift, address = 0;\n\n\tret = kstrtobool(buf, &readin);\n\tif (ret)\n\t\treturn ret;\n\n\tif (readin)\n\t\tst->pwr_down_mask |= (0x3 << (chan->channel * 2));\n\telse\n\t\tst->pwr_down_mask &= ~(0x3 << (chan->channel * 2));\n\n\tswitch (st->chip_info->regmap_type) {\n\tcase AD5310_REGMAP:\n\t\tshift = 9;\n\t\tref_bit_msk = AD5310_REF_BIT_MSK;\n\t\tbreak;\n\tcase AD5683_REGMAP:\n\t\tshift = 13;\n\t\tref_bit_msk = AD5683_REF_BIT_MSK;\n\t\tbreak;\n\tcase AD5686_REGMAP:\n\t\tshift = 0;\n\t\tref_bit_msk = 0;\n\t\t \n\t\tif (chan->channel > 0x7)\n\t\t\taddress = 0x8;\n\t\tbreak;\n\tcase AD5693_REGMAP:\n\t\tshift = 13;\n\t\tref_bit_msk = AD5693_REF_BIT_MSK;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tval = ((st->pwr_down_mask & st->pwr_down_mode) << shift);\n\tif (!st->use_internal_vref)\n\t\tval |= ref_bit_msk;\n\n\tret = st->write(st, AD5686_CMD_POWERDOWN_DAC,\n\t\t\taddress, val >> (address * 2));\n\n\treturn ret ? ret : len;\n}\n\nstatic int ad5686_read_raw(struct iio_dev *indio_dev,\n\t\t\t   struct iio_chan_spec const *chan,\n\t\t\t   int *val,\n\t\t\t   int *val2,\n\t\t\t   long m)\n{\n\tstruct ad5686_state *st = iio_priv(indio_dev);\n\tint ret;\n\n\tswitch (m) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tmutex_lock(&st->lock);\n\t\tret = st->read(st, chan->address);\n\t\tmutex_unlock(&st->lock);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\t*val = (ret >> chan->scan_type.shift) &\n\t\t\tGENMASK(chan->scan_type.realbits - 1, 0);\n\t\treturn IIO_VAL_INT;\n\tcase IIO_CHAN_INFO_SCALE:\n\t\t*val = st->vref_mv;\n\t\t*val2 = chan->scan_type.realbits;\n\t\treturn IIO_VAL_FRACTIONAL_LOG2;\n\t}\n\treturn -EINVAL;\n}\n\nstatic int ad5686_write_raw(struct iio_dev *indio_dev,\n\t\t\t    struct iio_chan_spec const *chan,\n\t\t\t    int val,\n\t\t\t    int val2,\n\t\t\t    long mask)\n{\n\tstruct ad5686_state *st = iio_priv(indio_dev);\n\tint ret;\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tif (val > (1 << chan->scan_type.realbits) || val < 0)\n\t\t\treturn -EINVAL;\n\n\t\tmutex_lock(&st->lock);\n\t\tret = st->write(st,\n\t\t\t\tAD5686_CMD_WRITE_INPUT_N_UPDATE_N,\n\t\t\t\tchan->address,\n\t\t\t\tval << chan->scan_type.shift);\n\t\tmutex_unlock(&st->lock);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct iio_info ad5686_info = {\n\t.read_raw = ad5686_read_raw,\n\t.write_raw = ad5686_write_raw,\n};\n\nstatic const struct iio_chan_spec_ext_info ad5686_ext_info[] = {\n\t{\n\t\t.name = \"powerdown\",\n\t\t.read = ad5686_read_dac_powerdown,\n\t\t.write = ad5686_write_dac_powerdown,\n\t\t.shared = IIO_SEPARATE,\n\t},\n\tIIO_ENUM(\"powerdown_mode\", IIO_SEPARATE, &ad5686_powerdown_mode_enum),\n\tIIO_ENUM_AVAILABLE(\"powerdown_mode\", IIO_SHARED_BY_TYPE, &ad5686_powerdown_mode_enum),\n\t{ },\n};\n\n#define AD5868_CHANNEL(chan, addr, bits, _shift) {\t\t\\\n\t\t.type = IIO_VOLTAGE,\t\t\t\t\\\n\t\t.indexed = 1,\t\t\t\t\t\\\n\t\t.output = 1,\t\t\t\t\t\\\n\t\t.channel = chan,\t\t\t\t\\\n\t\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW),\t\\\n\t\t.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE),\\\n\t\t.address = addr,\t\t\t\t\\\n\t\t.scan_type = {\t\t\t\t\t\\\n\t\t\t.sign = 'u',\t\t\t\t\\\n\t\t\t.realbits = (bits),\t\t\t\\\n\t\t\t.storagebits = 16,\t\t\t\\\n\t\t\t.shift = (_shift),\t\t\t\\\n\t\t},\t\t\t\t\t\t\\\n\t\t.ext_info = ad5686_ext_info,\t\t\t\\\n}\n\n#define DECLARE_AD5693_CHANNELS(name, bits, _shift)\t\t\\\nstatic const struct iio_chan_spec name[] = {\t\t\t\\\n\t\tAD5868_CHANNEL(0, 0, bits, _shift),\t\t\\\n}\n\n#define DECLARE_AD5338_CHANNELS(name, bits, _shift)\t\t\\\nstatic const struct iio_chan_spec name[] = {\t\t\t\\\n\t\tAD5868_CHANNEL(0, 1, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(1, 8, bits, _shift),\t\t\\\n}\n\n#define DECLARE_AD5686_CHANNELS(name, bits, _shift)\t\t\\\nstatic const struct iio_chan_spec name[] = {\t\t\t\\\n\t\tAD5868_CHANNEL(0, 1, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(1, 2, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(2, 4, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(3, 8, bits, _shift),\t\t\\\n}\n\n#define DECLARE_AD5676_CHANNELS(name, bits, _shift)\t\t\\\nstatic const struct iio_chan_spec name[] = {\t\t\t\\\n\t\tAD5868_CHANNEL(0, 0, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(1, 1, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(2, 2, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(3, 3, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(4, 4, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(5, 5, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(6, 6, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(7, 7, bits, _shift),\t\t\\\n}\n\n#define DECLARE_AD5679_CHANNELS(name, bits, _shift)\t\t\\\nstatic const struct iio_chan_spec name[] = {\t\t\t\\\n\t\tAD5868_CHANNEL(0, 0, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(1, 1, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(2, 2, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(3, 3, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(4, 4, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(5, 5, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(6, 6, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(7, 7, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(8, 8, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(9, 9, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(10, 10, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(11, 11, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(12, 12, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(13, 13, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(14, 14, bits, _shift),\t\t\\\n\t\tAD5868_CHANNEL(15, 15, bits, _shift),\t\t\\\n}\n\nDECLARE_AD5693_CHANNELS(ad5310r_channels, 10, 2);\nDECLARE_AD5693_CHANNELS(ad5311r_channels, 10, 6);\nDECLARE_AD5338_CHANNELS(ad5337r_channels, 8, 8);\nDECLARE_AD5338_CHANNELS(ad5338r_channels, 10, 6);\nDECLARE_AD5676_CHANNELS(ad5672_channels, 12, 4);\nDECLARE_AD5679_CHANNELS(ad5674r_channels, 12, 4);\nDECLARE_AD5676_CHANNELS(ad5676_channels, 16, 0);\nDECLARE_AD5679_CHANNELS(ad5679r_channels, 16, 0);\nDECLARE_AD5686_CHANNELS(ad5684_channels, 12, 4);\nDECLARE_AD5686_CHANNELS(ad5685r_channels, 14, 2);\nDECLARE_AD5686_CHANNELS(ad5686_channels, 16, 0);\nDECLARE_AD5693_CHANNELS(ad5693_channels, 16, 0);\nDECLARE_AD5693_CHANNELS(ad5692r_channels, 14, 2);\nDECLARE_AD5693_CHANNELS(ad5691r_channels, 12, 4);\n\nstatic const struct ad5686_chip_info ad5686_chip_info_tbl[] = {\n\t[ID_AD5310R] = {\n\t\t.channels = ad5310r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5310_REGMAP,\n\t},\n\t[ID_AD5311R] = {\n\t\t.channels = ad5311r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5693_REGMAP,\n\t},\n\t[ID_AD5337R] = {\n\t\t.channels = ad5337r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5338R] = {\n\t\t.channels = ad5338r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5671R] = {\n\t\t.channels = ad5672_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5672R] = {\n\t\t.channels = ad5672_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5673R] = {\n\t\t.channels = ad5674r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 16,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5674R] = {\n\t\t.channels = ad5674r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 16,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5675R] = {\n\t\t.channels = ad5676_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5676] = {\n\t\t.channels = ad5676_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5676R] = {\n\t\t.channels = ad5676_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5677R] = {\n\t\t.channels = ad5679r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 16,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5679R] = {\n\t\t.channels = ad5679r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 16,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5681R] = {\n\t\t.channels = ad5691r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5683_REGMAP,\n\t},\n\t[ID_AD5682R] = {\n\t\t.channels = ad5692r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5683_REGMAP,\n\t},\n\t[ID_AD5683] = {\n\t\t.channels = ad5693_channels,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5683_REGMAP,\n\t},\n\t[ID_AD5683R] = {\n\t\t.channels = ad5693_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5683_REGMAP,\n\t},\n\t[ID_AD5684] = {\n\t\t.channels = ad5684_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5684R] = {\n\t\t.channels = ad5684_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5685R] = {\n\t\t.channels = ad5685r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5686] = {\n\t\t.channels = ad5686_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5686R] = {\n\t\t.channels = ad5686_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5691R] = {\n\t\t.channels = ad5691r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5693_REGMAP,\n\t},\n\t[ID_AD5692R] = {\n\t\t.channels = ad5692r_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5693_REGMAP,\n\t},\n\t[ID_AD5693] = {\n\t\t.channels = ad5693_channels,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5693_REGMAP,\n\t},\n\t[ID_AD5693R] = {\n\t\t.channels = ad5693_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5693_REGMAP,\n\t},\n\t[ID_AD5694] = {\n\t\t.channels = ad5684_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5694R] = {\n\t\t.channels = ad5684_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5696] = {\n\t\t.channels = ad5686_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n\t[ID_AD5696R] = {\n\t\t.channels = ad5686_channels,\n\t\t.int_vref_mv = 2500,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5686_REGMAP,\n\t},\n};\n\nint ad5686_probe(struct device *dev,\n\t\t enum ad5686_supported_device_ids chip_type,\n\t\t const char *name, ad5686_write_func write,\n\t\t ad5686_read_func read)\n{\n\tstruct ad5686_state *st;\n\tstruct iio_dev *indio_dev;\n\tunsigned int val, ref_bit_msk;\n\tu8 cmd;\n\tint ret, i, voltage_uv = 0;\n\n\tindio_dev = devm_iio_device_alloc(dev, sizeof(*st));\n\tif (indio_dev == NULL)\n\t\treturn  -ENOMEM;\n\n\tst = iio_priv(indio_dev);\n\tdev_set_drvdata(dev, indio_dev);\n\n\tst->dev = dev;\n\tst->write = write;\n\tst->read = read;\n\n\tst->reg = devm_regulator_get_optional(dev, \"vcc\");\n\tif (!IS_ERR(st->reg)) {\n\t\tret = regulator_enable(st->reg);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = regulator_get_voltage(st->reg);\n\t\tif (ret < 0)\n\t\t\tgoto error_disable_reg;\n\n\t\tvoltage_uv = ret;\n\t}\n\n\tst->chip_info = &ad5686_chip_info_tbl[chip_type];\n\n\tif (voltage_uv)\n\t\tst->vref_mv = voltage_uv / 1000;\n\telse\n\t\tst->vref_mv = st->chip_info->int_vref_mv;\n\n\t \n\tfor (i = 0; i < st->chip_info->num_channels; i++)\n\t\tst->pwr_down_mode |= (0x01 << (i * 2));\n\n\tindio_dev->name = name;\n\tindio_dev->info = &ad5686_info;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->channels = st->chip_info->channels;\n\tindio_dev->num_channels = st->chip_info->num_channels;\n\n\tmutex_init(&st->lock);\n\n\tswitch (st->chip_info->regmap_type) {\n\tcase AD5310_REGMAP:\n\t\tcmd = AD5686_CMD_CONTROL_REG;\n\t\tref_bit_msk = AD5310_REF_BIT_MSK;\n\t\tst->use_internal_vref = !voltage_uv;\n\t\tbreak;\n\tcase AD5683_REGMAP:\n\t\tcmd = AD5686_CMD_CONTROL_REG;\n\t\tref_bit_msk = AD5683_REF_BIT_MSK;\n\t\tst->use_internal_vref = !voltage_uv;\n\t\tbreak;\n\tcase AD5686_REGMAP:\n\t\tcmd = AD5686_CMD_INTERNAL_REFER_SETUP;\n\t\tref_bit_msk = 0;\n\t\tbreak;\n\tcase AD5693_REGMAP:\n\t\tcmd = AD5686_CMD_CONTROL_REG;\n\t\tref_bit_msk = AD5693_REF_BIT_MSK;\n\t\tst->use_internal_vref = !voltage_uv;\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tgoto error_disable_reg;\n\t}\n\n\tval = (voltage_uv | ref_bit_msk);\n\n\tret = st->write(st, cmd, 0, !!val);\n\tif (ret)\n\t\tgoto error_disable_reg;\n\n\tret = iio_device_register(indio_dev);\n\tif (ret)\n\t\tgoto error_disable_reg;\n\n\treturn 0;\n\nerror_disable_reg:\n\tif (!IS_ERR(st->reg))\n\t\tregulator_disable(st->reg);\n\treturn ret;\n}\nEXPORT_SYMBOL_NS_GPL(ad5686_probe, IIO_AD5686);\n\nvoid ad5686_remove(struct device *dev)\n{\n\tstruct iio_dev *indio_dev = dev_get_drvdata(dev);\n\tstruct ad5686_state *st = iio_priv(indio_dev);\n\n\tiio_device_unregister(indio_dev);\n\tif (!IS_ERR(st->reg))\n\t\tregulator_disable(st->reg);\n}\nEXPORT_SYMBOL_NS_GPL(ad5686_remove, IIO_AD5686);\n\nMODULE_AUTHOR(\"Michael Hennerich <michael.hennerich@analog.com>\");\nMODULE_DESCRIPTION(\"Analog Devices AD5686/85/84 DAC\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}