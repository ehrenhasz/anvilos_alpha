{
  "module_name": "ad5686-spi.c",
  "hash_id": "614080957622fb69ff8a1fd1c861fa2f9a36a4ef7a4b3d8c170ef18f5984a30e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/dac/ad5686-spi.c",
  "human_readable_source": "\n \n\n#include \"ad5686.h\"\n\n#include <linux/module.h>\n#include <linux/spi/spi.h>\n\nstatic int ad5686_spi_write(struct ad5686_state *st,\n\t\t\t    u8 cmd, u8 addr, u16 val)\n{\n\tstruct spi_device *spi = to_spi_device(st->dev);\n\tu8 tx_len, *buf;\n\n\tswitch (st->chip_info->regmap_type) {\n\tcase AD5310_REGMAP:\n\t\tst->data[0].d16 = cpu_to_be16(AD5310_CMD(cmd) |\n\t\t\t\t\t      val);\n\t\tbuf = &st->data[0].d8[0];\n\t\ttx_len = 2;\n\t\tbreak;\n\tcase AD5683_REGMAP:\n\t\tst->data[0].d32 = cpu_to_be32(AD5686_CMD(cmd) |\n\t\t\t\t\t      AD5683_DATA(val));\n\t\tbuf = &st->data[0].d8[1];\n\t\ttx_len = 3;\n\t\tbreak;\n\tcase AD5686_REGMAP:\n\t\tst->data[0].d32 = cpu_to_be32(AD5686_CMD(cmd) |\n\t\t\t\t\t      AD5686_ADDR(addr) |\n\t\t\t\t\t      val);\n\t\tbuf = &st->data[0].d8[1];\n\t\ttx_len = 3;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn spi_write(spi, buf, tx_len);\n}\n\nstatic int ad5686_spi_read(struct ad5686_state *st, u8 addr)\n{\n\tstruct spi_transfer t[] = {\n\t\t{\n\t\t\t.tx_buf = &st->data[0].d8[1],\n\t\t\t.len = 3,\n\t\t\t.cs_change = 1,\n\t\t}, {\n\t\t\t.tx_buf = &st->data[1].d8[1],\n\t\t\t.rx_buf = &st->data[2].d8[1],\n\t\t\t.len = 3,\n\t\t},\n\t};\n\tstruct spi_device *spi = to_spi_device(st->dev);\n\tu8 cmd = 0;\n\tint ret;\n\n\tswitch (st->chip_info->regmap_type) {\n\tcase AD5310_REGMAP:\n\t\treturn -ENOTSUPP;\n\tcase AD5683_REGMAP:\n\t\tcmd = AD5686_CMD_READBACK_ENABLE_V2;\n\t\tbreak;\n\tcase AD5686_REGMAP:\n\t\tcmd = AD5686_CMD_READBACK_ENABLE;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tst->data[0].d32 = cpu_to_be32(AD5686_CMD(cmd) |\n\t\t\t\t      AD5686_ADDR(addr));\n\tst->data[1].d32 = cpu_to_be32(AD5686_CMD(AD5686_CMD_NOOP));\n\n\tret = spi_sync_transfer(spi, t, ARRAY_SIZE(t));\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn be32_to_cpu(st->data[2].d32);\n}\n\nstatic int ad5686_spi_probe(struct spi_device *spi)\n{\n\tconst struct spi_device_id *id = spi_get_device_id(spi);\n\n\treturn ad5686_probe(&spi->dev, id->driver_data, id->name,\n\t\t\t    ad5686_spi_write, ad5686_spi_read);\n}\n\nstatic void ad5686_spi_remove(struct spi_device *spi)\n{\n\tad5686_remove(&spi->dev);\n}\n\nstatic const struct spi_device_id ad5686_spi_id[] = {\n\t{\"ad5310r\", ID_AD5310R},\n\t{\"ad5672r\", ID_AD5672R},\n\t{\"ad5674r\", ID_AD5674R},\n\t{\"ad5676\", ID_AD5676},\n\t{\"ad5676r\", ID_AD5676R},\n\t{\"ad5679r\", ID_AD5679R},\n\t{\"ad5681r\", ID_AD5681R},\n\t{\"ad5682r\", ID_AD5682R},\n\t{\"ad5683\", ID_AD5683},\n\t{\"ad5683r\", ID_AD5683R},\n\t{\"ad5684\", ID_AD5684},\n\t{\"ad5684r\", ID_AD5684R},\n\t{\"ad5685\", ID_AD5685R},  \n\t{\"ad5685r\", ID_AD5685R},\n\t{\"ad5686\", ID_AD5686},\n\t{\"ad5686r\", ID_AD5686R},\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, ad5686_spi_id);\n\nstatic struct spi_driver ad5686_spi_driver = {\n\t.driver = {\n\t\t.name = \"ad5686\",\n\t},\n\t.probe = ad5686_spi_probe,\n\t.remove = ad5686_spi_remove,\n\t.id_table = ad5686_spi_id,\n};\n\nmodule_spi_driver(ad5686_spi_driver);\n\nMODULE_AUTHOR(\"Stefan Popa <stefan.popa@analog.com>\");\nMODULE_DESCRIPTION(\"Analog Devices AD5686 and similar multi-channel DACs\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_IMPORT_NS(IIO_AD5686);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}