{
  "module_name": "ad5064.c",
  "hash_id": "f30a096affa37772387733005546d4046acaa1e7c34954f31e175c43430846ed",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/dac/ad5064.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/spi/spi.h>\n#include <linux/i2c.h>\n#include <linux/slab.h>\n#include <linux/sysfs.h>\n#include <linux/regulator/consumer.h>\n#include <asm/unaligned.h>\n\n#include <linux/iio/iio.h>\n#include <linux/iio/sysfs.h>\n\n#define AD5064_MAX_DAC_CHANNELS\t\t\t8\n#define AD5064_MAX_VREFS\t\t\t4\n\n#define AD5064_ADDR(x)\t\t\t\t((x) << 20)\n#define AD5064_CMD(x)\t\t\t\t((x) << 24)\n\n#define AD5064_ADDR_ALL_DAC\t\t\t0xF\n\n#define AD5064_CMD_WRITE_INPUT_N\t\t0x0\n#define AD5064_CMD_UPDATE_DAC_N\t\t\t0x1\n#define AD5064_CMD_WRITE_INPUT_N_UPDATE_ALL\t0x2\n#define AD5064_CMD_WRITE_INPUT_N_UPDATE_N\t0x3\n#define AD5064_CMD_POWERDOWN_DAC\t\t0x4\n#define AD5064_CMD_CLEAR\t\t\t0x5\n#define AD5064_CMD_LDAC_MASK\t\t\t0x6\n#define AD5064_CMD_RESET\t\t\t0x7\n#define AD5064_CMD_CONFIG\t\t\t0x8\n\n#define AD5064_CMD_RESET_V2\t\t\t0x5\n#define AD5064_CMD_CONFIG_V2\t\t\t0x7\n\n#define AD5064_CONFIG_DAISY_CHAIN_ENABLE\tBIT(1)\n#define AD5064_CONFIG_INT_VREF_ENABLE\t\tBIT(0)\n\n#define AD5064_LDAC_PWRDN_NONE\t\t\t0x0\n#define AD5064_LDAC_PWRDN_1K\t\t\t0x1\n#define AD5064_LDAC_PWRDN_100K\t\t\t0x2\n#define AD5064_LDAC_PWRDN_3STATE\t\t0x3\n\n \nenum ad5064_regmap_type {\n\tAD5064_REGMAP_ADI,\n\tAD5064_REGMAP_ADI2,\n\tAD5064_REGMAP_LTC,\n};\n\n \n\nstruct ad5064_chip_info {\n\tbool shared_vref;\n\tunsigned long internal_vref;\n\tconst struct iio_chan_spec *channels;\n\tunsigned int num_channels;\n\tenum ad5064_regmap_type regmap_type;\n};\n\nstruct ad5064_state;\n\ntypedef int (*ad5064_write_func)(struct ad5064_state *st, unsigned int cmd,\n\t\tunsigned int addr, unsigned int val);\n\n \n\nstruct ad5064_state {\n\tstruct device\t\t\t*dev;\n\tconst struct ad5064_chip_info\t*chip_info;\n\tstruct regulator_bulk_data\tvref_reg[AD5064_MAX_VREFS];\n\tbool\t\t\t\tpwr_down[AD5064_MAX_DAC_CHANNELS];\n\tu8\t\t\t\tpwr_down_mode[AD5064_MAX_DAC_CHANNELS];\n\tunsigned int\t\t\tdac_cache[AD5064_MAX_DAC_CHANNELS];\n\tbool\t\t\t\tuse_internal_vref;\n\n\tad5064_write_func\t\twrite;\n\tstruct mutex lock;\n\n\t \n\tunion {\n\t\tu8 i2c[3];\n\t\t__be32 spi;\n\t} data __aligned(IIO_DMA_MINALIGN);\n};\n\nenum ad5064_type {\n\tID_AD5024,\n\tID_AD5025,\n\tID_AD5044,\n\tID_AD5045,\n\tID_AD5064,\n\tID_AD5064_1,\n\tID_AD5065,\n\tID_AD5625,\n\tID_AD5625R_1V25,\n\tID_AD5625R_2V5,\n\tID_AD5627,\n\tID_AD5627R_1V25,\n\tID_AD5627R_2V5,\n\tID_AD5628_1,\n\tID_AD5628_2,\n\tID_AD5629_1,\n\tID_AD5629_2,\n\tID_AD5645R_1V25,\n\tID_AD5645R_2V5,\n\tID_AD5647R_1V25,\n\tID_AD5647R_2V5,\n\tID_AD5648_1,\n\tID_AD5648_2,\n\tID_AD5665,\n\tID_AD5665R_1V25,\n\tID_AD5665R_2V5,\n\tID_AD5666_1,\n\tID_AD5666_2,\n\tID_AD5667,\n\tID_AD5667R_1V25,\n\tID_AD5667R_2V5,\n\tID_AD5668_1,\n\tID_AD5668_2,\n\tID_AD5669_1,\n\tID_AD5669_2,\n\tID_LTC2606,\n\tID_LTC2607,\n\tID_LTC2609,\n\tID_LTC2616,\n\tID_LTC2617,\n\tID_LTC2619,\n\tID_LTC2626,\n\tID_LTC2627,\n\tID_LTC2629,\n\tID_LTC2631_L12,\n\tID_LTC2631_H12,\n\tID_LTC2631_L10,\n\tID_LTC2631_H10,\n\tID_LTC2631_L8,\n\tID_LTC2631_H8,\n\tID_LTC2633_L12,\n\tID_LTC2633_H12,\n\tID_LTC2633_L10,\n\tID_LTC2633_H10,\n\tID_LTC2633_L8,\n\tID_LTC2633_H8,\n\tID_LTC2635_L12,\n\tID_LTC2635_H12,\n\tID_LTC2635_L10,\n\tID_LTC2635_H10,\n\tID_LTC2635_L8,\n\tID_LTC2635_H8,\n};\n\nstatic int ad5064_write(struct ad5064_state *st, unsigned int cmd,\n\tunsigned int addr, unsigned int val, unsigned int shift)\n{\n\tval <<= shift;\n\n\treturn st->write(st, cmd, addr, val);\n}\n\nstatic int ad5064_sync_powerdown_mode(struct ad5064_state *st,\n\tconst struct iio_chan_spec *chan)\n{\n\tunsigned int val, address;\n\tunsigned int shift;\n\tint ret;\n\n\tif (st->chip_info->regmap_type == AD5064_REGMAP_LTC) {\n\t\tval = 0;\n\t\taddress = chan->address;\n\t} else {\n\t\tif (st->chip_info->regmap_type == AD5064_REGMAP_ADI2)\n\t\t\tshift = 4;\n\t\telse\n\t\t\tshift = 8;\n\n\t\tval = (0x1 << chan->address);\n\t\taddress = 0;\n\n\t\tif (st->pwr_down[chan->channel])\n\t\t\tval |= st->pwr_down_mode[chan->channel] << shift;\n\t}\n\n\tret = ad5064_write(st, AD5064_CMD_POWERDOWN_DAC, address, val, 0);\n\n\treturn ret;\n}\n\nstatic const char * const ad5064_powerdown_modes[] = {\n\t\"1kohm_to_gnd\",\n\t\"100kohm_to_gnd\",\n\t\"three_state\",\n};\n\nstatic const char * const ltc2617_powerdown_modes[] = {\n\t\"90kohm_to_gnd\",\n};\n\nstatic int ad5064_get_powerdown_mode(struct iio_dev *indio_dev,\n\tconst struct iio_chan_spec *chan)\n{\n\tstruct ad5064_state *st = iio_priv(indio_dev);\n\n\treturn st->pwr_down_mode[chan->channel] - 1;\n}\n\nstatic int ad5064_set_powerdown_mode(struct iio_dev *indio_dev,\n\tconst struct iio_chan_spec *chan, unsigned int mode)\n{\n\tstruct ad5064_state *st = iio_priv(indio_dev);\n\tint ret;\n\n\tmutex_lock(&st->lock);\n\tst->pwr_down_mode[chan->channel] = mode + 1;\n\n\tret = ad5064_sync_powerdown_mode(st, chan);\n\tmutex_unlock(&st->lock);\n\n\treturn ret;\n}\n\nstatic const struct iio_enum ad5064_powerdown_mode_enum = {\n\t.items = ad5064_powerdown_modes,\n\t.num_items = ARRAY_SIZE(ad5064_powerdown_modes),\n\t.get = ad5064_get_powerdown_mode,\n\t.set = ad5064_set_powerdown_mode,\n};\n\nstatic const struct iio_enum ltc2617_powerdown_mode_enum = {\n\t.items = ltc2617_powerdown_modes,\n\t.num_items = ARRAY_SIZE(ltc2617_powerdown_modes),\n\t.get = ad5064_get_powerdown_mode,\n\t.set = ad5064_set_powerdown_mode,\n};\n\nstatic ssize_t ad5064_read_dac_powerdown(struct iio_dev *indio_dev,\n\tuintptr_t private, const struct iio_chan_spec *chan, char *buf)\n{\n\tstruct ad5064_state *st = iio_priv(indio_dev);\n\n\treturn sysfs_emit(buf, \"%d\\n\", st->pwr_down[chan->channel]);\n}\n\nstatic ssize_t ad5064_write_dac_powerdown(struct iio_dev *indio_dev,\n\t uintptr_t private, const struct iio_chan_spec *chan, const char *buf,\n\t size_t len)\n{\n\tstruct ad5064_state *st = iio_priv(indio_dev);\n\tbool pwr_down;\n\tint ret;\n\n\tret = kstrtobool(buf, &pwr_down);\n\tif (ret)\n\t\treturn ret;\n\n\tmutex_lock(&st->lock);\n\tst->pwr_down[chan->channel] = pwr_down;\n\n\tret = ad5064_sync_powerdown_mode(st, chan);\n\tmutex_unlock(&st->lock);\n\treturn ret ? ret : len;\n}\n\nstatic int ad5064_get_vref(struct ad5064_state *st,\n\tstruct iio_chan_spec const *chan)\n{\n\tunsigned int i;\n\n\tif (st->use_internal_vref)\n\t\treturn st->chip_info->internal_vref;\n\n\ti = st->chip_info->shared_vref ? 0 : chan->channel;\n\treturn regulator_get_voltage(st->vref_reg[i].consumer);\n}\n\nstatic int ad5064_read_raw(struct iio_dev *indio_dev,\n\t\t\t   struct iio_chan_spec const *chan,\n\t\t\t   int *val,\n\t\t\t   int *val2,\n\t\t\t   long m)\n{\n\tstruct ad5064_state *st = iio_priv(indio_dev);\n\tint scale_uv;\n\n\tswitch (m) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\t*val = st->dac_cache[chan->channel];\n\t\treturn IIO_VAL_INT;\n\tcase IIO_CHAN_INFO_SCALE:\n\t\tscale_uv = ad5064_get_vref(st, chan);\n\t\tif (scale_uv < 0)\n\t\t\treturn scale_uv;\n\n\t\t*val = scale_uv / 1000;\n\t\t*val2 = chan->scan_type.realbits;\n\t\treturn IIO_VAL_FRACTIONAL_LOG2;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn -EINVAL;\n}\n\nstatic int ad5064_write_raw(struct iio_dev *indio_dev,\n\tstruct iio_chan_spec const *chan, int val, int val2, long mask)\n{\n\tstruct ad5064_state *st = iio_priv(indio_dev);\n\tint ret;\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tif (val >= (1 << chan->scan_type.realbits) || val < 0)\n\t\t\treturn -EINVAL;\n\n\t\tmutex_lock(&st->lock);\n\t\tret = ad5064_write(st, AD5064_CMD_WRITE_INPUT_N_UPDATE_N,\n\t\t\t\tchan->address, val, chan->scan_type.shift);\n\t\tif (ret == 0)\n\t\t\tst->dac_cache[chan->channel] = val;\n\t\tmutex_unlock(&st->lock);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct iio_info ad5064_info = {\n\t.read_raw = ad5064_read_raw,\n\t.write_raw = ad5064_write_raw,\n};\n\nstatic const struct iio_chan_spec_ext_info ad5064_ext_info[] = {\n\t{\n\t\t.name = \"powerdown\",\n\t\t.read = ad5064_read_dac_powerdown,\n\t\t.write = ad5064_write_dac_powerdown,\n\t\t.shared = IIO_SEPARATE,\n\t},\n\tIIO_ENUM(\"powerdown_mode\", IIO_SEPARATE, &ad5064_powerdown_mode_enum),\n\tIIO_ENUM_AVAILABLE(\"powerdown_mode\", IIO_SHARED_BY_TYPE, &ad5064_powerdown_mode_enum),\n\t{ },\n};\n\nstatic const struct iio_chan_spec_ext_info ltc2617_ext_info[] = {\n\t{\n\t\t.name = \"powerdown\",\n\t\t.read = ad5064_read_dac_powerdown,\n\t\t.write = ad5064_write_dac_powerdown,\n\t\t.shared = IIO_SEPARATE,\n\t},\n\tIIO_ENUM(\"powerdown_mode\", IIO_SEPARATE, &ltc2617_powerdown_mode_enum),\n\tIIO_ENUM_AVAILABLE(\"powerdown_mode\", IIO_SHARED_BY_TYPE, &ltc2617_powerdown_mode_enum),\n\t{ },\n};\n\n#define AD5064_CHANNEL(chan, addr, bits, _shift, _ext_info) {\t\t\\\n\t.type = IIO_VOLTAGE,\t\t\t\t\t\\\n\t.indexed = 1,\t\t\t\t\t\t\\\n\t.output = 1,\t\t\t\t\t\t\\\n\t.channel = (chan),\t\t\t\t\t\\\n\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW) |\t\t\\\n\tBIT(IIO_CHAN_INFO_SCALE),\t\t\t\t\t\\\n\t.address = addr,\t\t\t\t\t\\\n\t.scan_type = {\t\t\t\t\t\t\\\n\t\t.sign = 'u',\t\t\t\t\t\\\n\t\t.realbits = (bits),\t\t\t\t\\\n\t\t.storagebits = 16,\t\t\t\t\\\n\t\t.shift = (_shift),\t\t\t\t\\\n\t},\t\t\t\t\t\t\t\\\n\t.ext_info = (_ext_info),\t\t\t\t\\\n}\n\n#define DECLARE_AD5064_CHANNELS(name, bits, shift, ext_info) \\\nconst struct iio_chan_spec name[] = { \\\n\tAD5064_CHANNEL(0, 0, bits, shift, ext_info), \\\n\tAD5064_CHANNEL(1, 1, bits, shift, ext_info), \\\n\tAD5064_CHANNEL(2, 2, bits, shift, ext_info), \\\n\tAD5064_CHANNEL(3, 3, bits, shift, ext_info), \\\n\tAD5064_CHANNEL(4, 4, bits, shift, ext_info), \\\n\tAD5064_CHANNEL(5, 5, bits, shift, ext_info), \\\n\tAD5064_CHANNEL(6, 6, bits, shift, ext_info), \\\n\tAD5064_CHANNEL(7, 7, bits, shift, ext_info), \\\n}\n\n#define DECLARE_AD5065_CHANNELS(name, bits, shift, ext_info) \\\nconst struct iio_chan_spec name[] = { \\\n\tAD5064_CHANNEL(0, 0, bits, shift, ext_info), \\\n\tAD5064_CHANNEL(1, 3, bits, shift, ext_info), \\\n}\n\nstatic DECLARE_AD5064_CHANNELS(ad5024_channels, 12, 8, ad5064_ext_info);\nstatic DECLARE_AD5064_CHANNELS(ad5044_channels, 14, 6, ad5064_ext_info);\nstatic DECLARE_AD5064_CHANNELS(ad5064_channels, 16, 4, ad5064_ext_info);\n\nstatic DECLARE_AD5065_CHANNELS(ad5025_channels, 12, 8, ad5064_ext_info);\nstatic DECLARE_AD5065_CHANNELS(ad5045_channels, 14, 6, ad5064_ext_info);\nstatic DECLARE_AD5065_CHANNELS(ad5065_channels, 16, 4, ad5064_ext_info);\n\nstatic DECLARE_AD5064_CHANNELS(ad5629_channels, 12, 4, ad5064_ext_info);\nstatic DECLARE_AD5064_CHANNELS(ad5645_channels, 14, 2, ad5064_ext_info);\nstatic DECLARE_AD5064_CHANNELS(ad5669_channels, 16, 0, ad5064_ext_info);\n\nstatic DECLARE_AD5064_CHANNELS(ltc2607_channels, 16, 0, ltc2617_ext_info);\nstatic DECLARE_AD5064_CHANNELS(ltc2617_channels, 14, 2, ltc2617_ext_info);\nstatic DECLARE_AD5064_CHANNELS(ltc2627_channels, 12, 4, ltc2617_ext_info);\n#define ltc2631_12_channels ltc2627_channels\nstatic DECLARE_AD5064_CHANNELS(ltc2631_10_channels, 10, 6, ltc2617_ext_info);\nstatic DECLARE_AD5064_CHANNELS(ltc2631_8_channels, 8, 8, ltc2617_ext_info);\n\n#define LTC2631_INFO(vref, pchannels, nchannels)\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.shared_vref = true,\t\t\t\\\n\t\t.internal_vref = vref,\t\t\t\\\n\t\t.channels = pchannels,\t\t\t\\\n\t\t.num_channels = nchannels,\t\t\\\n\t\t.regmap_type = AD5064_REGMAP_LTC,\t\\\n\t}\n\n\nstatic const struct ad5064_chip_info ad5064_chip_info_tbl[] = {\n\t[ID_AD5024] = {\n\t\t.shared_vref = false,\n\t\t.channels = ad5024_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5025] = {\n\t\t.shared_vref = false,\n\t\t.channels = ad5025_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5044] = {\n\t\t.shared_vref = false,\n\t\t.channels = ad5044_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5045] = {\n\t\t.shared_vref = false,\n\t\t.channels = ad5045_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5064] = {\n\t\t.shared_vref = false,\n\t\t.channels = ad5064_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5064_1] = {\n\t\t.shared_vref = true,\n\t\t.channels = ad5064_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5065] = {\n\t\t.shared_vref = false,\n\t\t.channels = ad5065_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5625] = {\n\t\t.shared_vref = true,\n\t\t.channels = ad5629_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5625R_1V25] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 1250000,\n\t\t.channels = ad5629_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5625R_2V5] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5629_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5627] = {\n\t\t.shared_vref = true,\n\t\t.channels = ad5629_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5627R_1V25] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 1250000,\n\t\t.channels = ad5629_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5627R_2V5] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5629_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5628_1] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5024_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5628_2] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 5000000,\n\t\t.channels = ad5024_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5629_1] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5629_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5629_2] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 5000000,\n\t\t.channels = ad5629_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5645R_1V25] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 1250000,\n\t\t.channels = ad5645_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5645R_2V5] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5645_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5647R_1V25] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 1250000,\n\t\t.channels = ad5645_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5647R_2V5] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5645_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5648_1] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5044_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5648_2] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 5000000,\n\t\t.channels = ad5044_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5665] = {\n\t\t.shared_vref = true,\n\t\t.channels = ad5669_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5665R_1V25] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 1250000,\n\t\t.channels = ad5669_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5665R_2V5] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5669_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5666_1] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5064_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5666_2] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 5000000,\n\t\t.channels = ad5064_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5667] = {\n\t\t.shared_vref = true,\n\t\t.channels = ad5669_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5667R_1V25] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 1250000,\n\t\t.channels = ad5669_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5667R_2V5] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5669_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_ADI2\n\t},\n\t[ID_AD5668_1] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5064_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5668_2] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 5000000,\n\t\t.channels = ad5064_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5669_1] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 2500000,\n\t\t.channels = ad5669_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_AD5669_2] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 5000000,\n\t\t.channels = ad5669_channels,\n\t\t.num_channels = 8,\n\t\t.regmap_type = AD5064_REGMAP_ADI,\n\t},\n\t[ID_LTC2606] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 0,\n\t\t.channels = ltc2607_channels,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5064_REGMAP_LTC,\n\t},\n\t[ID_LTC2607] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 0,\n\t\t.channels = ltc2607_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_LTC,\n\t},\n\t[ID_LTC2609] = {\n\t\t.shared_vref = false,\n\t\t.internal_vref = 0,\n\t\t.channels = ltc2607_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_LTC,\n\t},\n\t[ID_LTC2616] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 0,\n\t\t.channels = ltc2617_channels,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5064_REGMAP_LTC,\n\t},\n\t[ID_LTC2617] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 0,\n\t\t.channels = ltc2617_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_LTC,\n\t},\n\t[ID_LTC2619] = {\n\t\t.shared_vref = false,\n\t\t.internal_vref = 0,\n\t\t.channels = ltc2617_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_LTC,\n\t},\n\t[ID_LTC2626] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 0,\n\t\t.channels = ltc2627_channels,\n\t\t.num_channels = 1,\n\t\t.regmap_type = AD5064_REGMAP_LTC,\n\t},\n\t[ID_LTC2627] = {\n\t\t.shared_vref = true,\n\t\t.internal_vref = 0,\n\t\t.channels = ltc2627_channels,\n\t\t.num_channels = 2,\n\t\t.regmap_type = AD5064_REGMAP_LTC,\n\t},\n\t[ID_LTC2629] = {\n\t\t.shared_vref = false,\n\t\t.internal_vref = 0,\n\t\t.channels = ltc2627_channels,\n\t\t.num_channels = 4,\n\t\t.regmap_type = AD5064_REGMAP_LTC,\n\t},\n\t[ID_LTC2631_L12] = LTC2631_INFO(2500000, ltc2631_12_channels, 1),\n\t[ID_LTC2631_H12] = LTC2631_INFO(4096000, ltc2631_12_channels, 1),\n\t[ID_LTC2631_L10] = LTC2631_INFO(2500000, ltc2631_10_channels, 1),\n\t[ID_LTC2631_H10] = LTC2631_INFO(4096000, ltc2631_10_channels, 1),\n\t[ID_LTC2631_L8] = LTC2631_INFO(2500000, ltc2631_8_channels, 1),\n\t[ID_LTC2631_H8] = LTC2631_INFO(4096000, ltc2631_8_channels, 1),\n\t[ID_LTC2633_L12] = LTC2631_INFO(2500000, ltc2631_12_channels, 2),\n\t[ID_LTC2633_H12] = LTC2631_INFO(4096000, ltc2631_12_channels, 2),\n\t[ID_LTC2633_L10] = LTC2631_INFO(2500000, ltc2631_10_channels, 2),\n\t[ID_LTC2633_H10] = LTC2631_INFO(4096000, ltc2631_10_channels, 2),\n\t[ID_LTC2633_L8] = LTC2631_INFO(2500000, ltc2631_8_channels, 2),\n\t[ID_LTC2633_H8] = LTC2631_INFO(4096000, ltc2631_8_channels, 2),\n\t[ID_LTC2635_L12] = LTC2631_INFO(2500000, ltc2631_12_channels, 4),\n\t[ID_LTC2635_H12] = LTC2631_INFO(4096000, ltc2631_12_channels, 4),\n\t[ID_LTC2635_L10] = LTC2631_INFO(2500000, ltc2631_10_channels, 4),\n\t[ID_LTC2635_H10] = LTC2631_INFO(4096000, ltc2631_10_channels, 4),\n\t[ID_LTC2635_L8] = LTC2631_INFO(2500000, ltc2631_8_channels, 4),\n\t[ID_LTC2635_H8] = LTC2631_INFO(4096000, ltc2631_8_channels, 4),\n};\n\nstatic inline unsigned int ad5064_num_vref(struct ad5064_state *st)\n{\n\treturn st->chip_info->shared_vref ? 1 : st->chip_info->num_channels;\n}\n\nstatic const char * const ad5064_vref_names[] = {\n\t\"vrefA\",\n\t\"vrefB\",\n\t\"vrefC\",\n\t\"vrefD\",\n};\n\nstatic const char *ad5064_vref_name(struct ad5064_state *st,\n\tunsigned int vref)\n{\n\treturn st->chip_info->shared_vref ? \"vref\" : ad5064_vref_names[vref];\n}\n\nstatic int ad5064_set_config(struct ad5064_state *st, unsigned int val)\n{\n\tunsigned int cmd;\n\n\tswitch (st->chip_info->regmap_type) {\n\tcase AD5064_REGMAP_ADI2:\n\t\tcmd = AD5064_CMD_CONFIG_V2;\n\t\tbreak;\n\tdefault:\n\t\tcmd = AD5064_CMD_CONFIG;\n\t\tbreak;\n\t}\n\n\treturn ad5064_write(st, cmd, 0, val, 0);\n}\n\nstatic int ad5064_request_vref(struct ad5064_state *st, struct device *dev)\n{\n\tunsigned int i;\n\tint ret;\n\n\tfor (i = 0; i < ad5064_num_vref(st); ++i)\n\t\tst->vref_reg[i].supply = ad5064_vref_name(st, i);\n\n\tif (!st->chip_info->internal_vref)\n\t\treturn devm_regulator_bulk_get(dev, ad5064_num_vref(st),\n\t\t\t\t\t       st->vref_reg);\n\n\t \n\tst->vref_reg[0].consumer = devm_regulator_get_optional(dev, \"vref\");\n\tif (!IS_ERR(st->vref_reg[0].consumer))\n\t\treturn 0;\n\n\tret = PTR_ERR(st->vref_reg[0].consumer);\n\tif (ret != -ENODEV)\n\t\treturn ret;\n\n\t \n\tst->use_internal_vref = true;\n\tret = ad5064_set_config(st, AD5064_CONFIG_INT_VREF_ENABLE);\n\tif (ret)\n\t\tdev_err(dev, \"Failed to enable internal vref: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic void ad5064_bulk_reg_disable(void *data)\n{\n\tstruct ad5064_state *st = data;\n\n\tregulator_bulk_disable(ad5064_num_vref(st), st->vref_reg);\n}\n\nstatic int ad5064_probe(struct device *dev, enum ad5064_type type,\n\t\t\tconst char *name, ad5064_write_func write)\n{\n\tstruct iio_dev *indio_dev;\n\tstruct ad5064_state *st;\n\tunsigned int midscale;\n\tunsigned int i;\n\tint ret;\n\n\tindio_dev = devm_iio_device_alloc(dev, sizeof(*st));\n\tif (indio_dev == NULL)\n\t\treturn  -ENOMEM;\n\n\tst = iio_priv(indio_dev);\n\tmutex_init(&st->lock);\n\n\tst->chip_info = &ad5064_chip_info_tbl[type];\n\tst->dev = dev;\n\tst->write = write;\n\n\tret = ad5064_request_vref(st, dev);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!st->use_internal_vref) {\n\t\tret = regulator_bulk_enable(ad5064_num_vref(st), st->vref_reg);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = devm_add_action_or_reset(dev, ad5064_bulk_reg_disable, st);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tindio_dev->name = name;\n\tindio_dev->info = &ad5064_info;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->channels = st->chip_info->channels;\n\tindio_dev->num_channels = st->chip_info->num_channels;\n\n\tmidscale = (1 << indio_dev->channels[0].scan_type.realbits) /  2;\n\n\tfor (i = 0; i < st->chip_info->num_channels; ++i) {\n\t\tst->pwr_down_mode[i] = AD5064_LDAC_PWRDN_1K;\n\t\tst->dac_cache[i] = midscale;\n\t}\n\n\treturn devm_iio_device_register(dev, indio_dev);\n}\n\n#if IS_ENABLED(CONFIG_SPI_MASTER)\n\nstatic int ad5064_spi_write(struct ad5064_state *st, unsigned int cmd,\n\tunsigned int addr, unsigned int val)\n{\n\tstruct spi_device *spi = to_spi_device(st->dev);\n\n\tst->data.spi = cpu_to_be32(AD5064_CMD(cmd) | AD5064_ADDR(addr) | val);\n\treturn spi_write(spi, &st->data.spi, sizeof(st->data.spi));\n}\n\nstatic int ad5064_spi_probe(struct spi_device *spi)\n{\n\tconst struct spi_device_id *id = spi_get_device_id(spi);\n\n\treturn ad5064_probe(&spi->dev, id->driver_data, id->name,\n\t\t\t\tad5064_spi_write);\n}\n\nstatic const struct spi_device_id ad5064_spi_ids[] = {\n\t{\"ad5024\", ID_AD5024},\n\t{\"ad5025\", ID_AD5025},\n\t{\"ad5044\", ID_AD5044},\n\t{\"ad5045\", ID_AD5045},\n\t{\"ad5064\", ID_AD5064},\n\t{\"ad5064-1\", ID_AD5064_1},\n\t{\"ad5065\", ID_AD5065},\n\t{\"ad5628-1\", ID_AD5628_1},\n\t{\"ad5628-2\", ID_AD5628_2},\n\t{\"ad5648-1\", ID_AD5648_1},\n\t{\"ad5648-2\", ID_AD5648_2},\n\t{\"ad5666-1\", ID_AD5666_1},\n\t{\"ad5666-2\", ID_AD5666_2},\n\t{\"ad5668-1\", ID_AD5668_1},\n\t{\"ad5668-2\", ID_AD5668_2},\n\t{\"ad5668-3\", ID_AD5668_2},  \n\t{}\n};\nMODULE_DEVICE_TABLE(spi, ad5064_spi_ids);\n\nstatic struct spi_driver ad5064_spi_driver = {\n\t.driver = {\n\t\t   .name = \"ad5064\",\n\t},\n\t.probe = ad5064_spi_probe,\n\t.id_table = ad5064_spi_ids,\n};\n\nstatic int __init ad5064_spi_register_driver(void)\n{\n\treturn spi_register_driver(&ad5064_spi_driver);\n}\n\nstatic void ad5064_spi_unregister_driver(void)\n{\n\tspi_unregister_driver(&ad5064_spi_driver);\n}\n\n#else\n\nstatic inline int ad5064_spi_register_driver(void) { return 0; }\nstatic inline void ad5064_spi_unregister_driver(void) { }\n\n#endif\n\n#if IS_ENABLED(CONFIG_I2C)\n\nstatic int ad5064_i2c_write(struct ad5064_state *st, unsigned int cmd,\n\tunsigned int addr, unsigned int val)\n{\n\tstruct i2c_client *i2c = to_i2c_client(st->dev);\n\tunsigned int cmd_shift;\n\tint ret;\n\n\tswitch (st->chip_info->regmap_type) {\n\tcase AD5064_REGMAP_ADI2:\n\t\tcmd_shift = 3;\n\t\tbreak;\n\tdefault:\n\t\tcmd_shift = 4;\n\t\tbreak;\n\t}\n\n\tst->data.i2c[0] = (cmd << cmd_shift) | addr;\n\tput_unaligned_be16(val, &st->data.i2c[1]);\n\n\tret = i2c_master_send(i2c, st->data.i2c, 3);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int ad5064_i2c_probe(struct i2c_client *i2c)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(i2c);\n\treturn ad5064_probe(&i2c->dev, id->driver_data, id->name,\n\t\t\t\t\t\tad5064_i2c_write);\n}\n\nstatic const struct i2c_device_id ad5064_i2c_ids[] = {\n\t{\"ad5625\", ID_AD5625 },\n\t{\"ad5625r-1v25\", ID_AD5625R_1V25 },\n\t{\"ad5625r-2v5\", ID_AD5625R_2V5 },\n\t{\"ad5627\", ID_AD5627 },\n\t{\"ad5627r-1v25\", ID_AD5627R_1V25 },\n\t{\"ad5627r-2v5\", ID_AD5627R_2V5 },\n\t{\"ad5629-1\", ID_AD5629_1},\n\t{\"ad5629-2\", ID_AD5629_2},\n\t{\"ad5629-3\", ID_AD5629_2},  \n\t{\"ad5645r-1v25\", ID_AD5645R_1V25 },\n\t{\"ad5645r-2v5\", ID_AD5645R_2V5 },\n\t{\"ad5665\", ID_AD5665 },\n\t{\"ad5665r-1v25\", ID_AD5665R_1V25 },\n\t{\"ad5665r-2v5\", ID_AD5665R_2V5 },\n\t{\"ad5667\", ID_AD5667 },\n\t{\"ad5667r-1v25\", ID_AD5667R_1V25 },\n\t{\"ad5667r-2v5\", ID_AD5667R_2V5 },\n\t{\"ad5669-1\", ID_AD5669_1},\n\t{\"ad5669-2\", ID_AD5669_2},\n\t{\"ad5669-3\", ID_AD5669_2},  \n\t{\"ltc2606\", ID_LTC2606},\n\t{\"ltc2607\", ID_LTC2607},\n\t{\"ltc2609\", ID_LTC2609},\n\t{\"ltc2616\", ID_LTC2616},\n\t{\"ltc2617\", ID_LTC2617},\n\t{\"ltc2619\", ID_LTC2619},\n\t{\"ltc2626\", ID_LTC2626},\n\t{\"ltc2627\", ID_LTC2627},\n\t{\"ltc2629\", ID_LTC2629},\n\t{\"ltc2631-l12\", ID_LTC2631_L12},\n\t{\"ltc2631-h12\", ID_LTC2631_H12},\n\t{\"ltc2631-l10\", ID_LTC2631_L10},\n\t{\"ltc2631-h10\", ID_LTC2631_H10},\n\t{\"ltc2631-l8\", ID_LTC2631_L8},\n\t{\"ltc2631-h8\", ID_LTC2631_H8},\n\t{\"ltc2633-l12\", ID_LTC2633_L12},\n\t{\"ltc2633-h12\", ID_LTC2633_H12},\n\t{\"ltc2633-l10\", ID_LTC2633_L10},\n\t{\"ltc2633-h10\", ID_LTC2633_H10},\n\t{\"ltc2633-l8\", ID_LTC2633_L8},\n\t{\"ltc2633-h8\", ID_LTC2633_H8},\n\t{\"ltc2635-l12\", ID_LTC2635_L12},\n\t{\"ltc2635-h12\", ID_LTC2635_H12},\n\t{\"ltc2635-l10\", ID_LTC2635_L10},\n\t{\"ltc2635-h10\", ID_LTC2635_H10},\n\t{\"ltc2635-l8\", ID_LTC2635_L8},\n\t{\"ltc2635-h8\", ID_LTC2635_H8},\n\t{}\n};\nMODULE_DEVICE_TABLE(i2c, ad5064_i2c_ids);\n\nstatic struct i2c_driver ad5064_i2c_driver = {\n\t.driver = {\n\t\t   .name = \"ad5064\",\n\t},\n\t.probe = ad5064_i2c_probe,\n\t.id_table = ad5064_i2c_ids,\n};\n\nstatic int __init ad5064_i2c_register_driver(void)\n{\n\treturn i2c_add_driver(&ad5064_i2c_driver);\n}\n\nstatic void __exit ad5064_i2c_unregister_driver(void)\n{\n\ti2c_del_driver(&ad5064_i2c_driver);\n}\n\n#else\n\nstatic inline int ad5064_i2c_register_driver(void) { return 0; }\nstatic inline void ad5064_i2c_unregister_driver(void) { }\n\n#endif\n\nstatic int __init ad5064_init(void)\n{\n\tint ret;\n\n\tret = ad5064_spi_register_driver();\n\tif (ret)\n\t\treturn ret;\n\n\tret = ad5064_i2c_register_driver();\n\tif (ret) {\n\t\tad5064_spi_unregister_driver();\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\nmodule_init(ad5064_init);\n\nstatic void __exit ad5064_exit(void)\n{\n\tad5064_i2c_unregister_driver();\n\tad5064_spi_unregister_driver();\n}\nmodule_exit(ad5064_exit);\n\nMODULE_AUTHOR(\"Lars-Peter Clausen <lars@metafoo.de>\");\nMODULE_DESCRIPTION(\"Analog Devices AD5024 and similar multi-channel DACs\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}