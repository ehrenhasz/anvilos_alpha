{
  "module_name": "max517.c",
  "hash_id": "768c97746b11c4f1751bdc381b4e2a60fa87fc18428ae668aa60c708b7779a57",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/dac/max517.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/jiffies.h>\n#include <linux/i2c.h>\n#include <linux/err.h>\n\n#include <linux/iio/iio.h>\n#include <linux/iio/sysfs.h>\n#include <linux/iio/dac/max517.h>\n\n#define MAX517_DRV_NAME\t\"max517\"\n\n \n#define COMMAND_CHANNEL0\t0x00\n#define COMMAND_CHANNEL1\t0x01  \n#define COMMAND_PD\t\t0x08  \n\nenum max517_device_ids {\n\tID_MAX517,\n\tID_MAX518,\n\tID_MAX519,\n\tID_MAX520,\n\tID_MAX521,\n};\n\nstruct max517_data {\n\tstruct i2c_client\t*client;\n\tunsigned short\t\tvref_mv[8];\n};\n\n \nstatic int max517_set_value(struct iio_dev *indio_dev,\n\tlong val, int channel)\n{\n\tstruct max517_data *data = iio_priv(indio_dev);\n\tstruct i2c_client *client = data->client;\n\tu8 outbuf[2];\n\tint res;\n\n\tif (val < 0 || val > 255)\n\t\treturn -EINVAL;\n\n\toutbuf[0] = channel;\n\toutbuf[1] = val;\n\n\tres = i2c_master_send(client, outbuf, 2);\n\tif (res < 0)\n\t\treturn res;\n\telse if (res != 2)\n\t\treturn -EIO;\n\telse\n\t\treturn 0;\n}\n\nstatic int max517_read_raw(struct iio_dev *indio_dev,\n\t\t\t   struct iio_chan_spec const *chan,\n\t\t\t   int *val,\n\t\t\t   int *val2,\n\t\t\t   long m)\n{\n\tstruct max517_data *data = iio_priv(indio_dev);\n\n\tswitch (m) {\n\tcase IIO_CHAN_INFO_SCALE:\n\t\t \n\t\t*val = data->vref_mv[chan->channel];\n\t\t*val2 = 8;\n\t\treturn IIO_VAL_FRACTIONAL_LOG2;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn -EINVAL;\n}\n\nstatic int max517_write_raw(struct iio_dev *indio_dev,\n\tstruct iio_chan_spec const *chan, int val, int val2, long mask)\n{\n\tint ret;\n\n\tswitch (mask) {\n\tcase IIO_CHAN_INFO_RAW:\n\t\tret = max517_set_value(indio_dev, val, chan->channel);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic int max517_suspend(struct device *dev)\n{\n\tu8 outbuf = COMMAND_PD;\n\n\treturn i2c_master_send(to_i2c_client(dev), &outbuf, 1);\n}\n\nstatic int max517_resume(struct device *dev)\n{\n\tu8 outbuf = 0;\n\n\treturn i2c_master_send(to_i2c_client(dev), &outbuf, 1);\n}\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(max517_pm_ops, max517_suspend, max517_resume);\n\nstatic const struct iio_info max517_info = {\n\t.read_raw = max517_read_raw,\n\t.write_raw = max517_write_raw,\n};\n\n#define MAX517_CHANNEL(chan) {\t\t\t\t\\\n\t.type = IIO_VOLTAGE,\t\t\t\t\\\n\t.indexed = 1,\t\t\t\t\t\\\n\t.output = 1,\t\t\t\t\t\\\n\t.channel = (chan),\t\t\t\t\\\n\t.info_mask_separate = BIT(IIO_CHAN_INFO_RAW) |\t\\\n\tBIT(IIO_CHAN_INFO_SCALE),\t\t\t\\\n}\n\nstatic const struct iio_chan_spec max517_channels[] = {\n\tMAX517_CHANNEL(0),\n\tMAX517_CHANNEL(1),\n\tMAX517_CHANNEL(2),\n\tMAX517_CHANNEL(3),\n\tMAX517_CHANNEL(4),\n\tMAX517_CHANNEL(5),\n\tMAX517_CHANNEL(6),\n\tMAX517_CHANNEL(7),\n};\n\nstatic int max517_probe(struct i2c_client *client)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(client);\n\tstruct max517_data *data;\n\tstruct iio_dev *indio_dev;\n\tstruct max517_platform_data *platform_data = client->dev.platform_data;\n\tint chan;\n\n\tindio_dev = devm_iio_device_alloc(&client->dev, sizeof(*data));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\tdata = iio_priv(indio_dev);\n\tdata->client = client;\n\n\tswitch (id->driver_data) {\n\tcase ID_MAX521:\n\t\tindio_dev->num_channels = 8;\n\t\tbreak;\n\tcase ID_MAX520:\n\t\tindio_dev->num_channels = 4;\n\t\tbreak;\n\tcase ID_MAX519:\n\tcase ID_MAX518:\n\t\tindio_dev->num_channels = 2;\n\t\tbreak;\n\tdefault:   \n\t\tindio_dev->num_channels = 1;\n\t\tbreak;\n\t}\n\tindio_dev->channels = max517_channels;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\tindio_dev->info = &max517_info;\n\n\t \n\tfor (chan = 0; chan < indio_dev->num_channels; chan++) {\n\t\tif (id->driver_data == ID_MAX518 || !platform_data)\n\t\t\tdata->vref_mv[chan] = 5000;  \n\t\telse\n\t\t\tdata->vref_mv[chan] = platform_data->vref_mv[chan];\n\t}\n\n\treturn devm_iio_device_register(&client->dev, indio_dev);\n}\n\nstatic const struct i2c_device_id max517_id[] = {\n\t{ \"max517\", ID_MAX517 },\n\t{ \"max518\", ID_MAX518 },\n\t{ \"max519\", ID_MAX519 },\n\t{ \"max520\", ID_MAX520 },\n\t{ \"max521\", ID_MAX521 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, max517_id);\n\nstatic struct i2c_driver max517_driver = {\n\t.driver = {\n\t\t.name\t= MAX517_DRV_NAME,\n\t\t.pm\t= pm_sleep_ptr(&max517_pm_ops),\n\t},\n\t.probe\t\t= max517_probe,\n\t.id_table\t= max517_id,\n};\nmodule_i2c_driver(max517_driver);\n\nMODULE_AUTHOR(\"Roland Stigge <stigge@antcom.de>\");\nMODULE_DESCRIPTION(\"MAX517/518/519/520/521 8-bit DAC\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}