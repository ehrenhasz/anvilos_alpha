{
  "module_name": "iio_simple_dummy_events.c",
  "hash_id": "58ba5901a7da6c5e78e8c624617aa9a707ef31afc9f2828e64879e21b7a34b87",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/dummy/iio_simple_dummy_events.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n\n#include <linux/iio/iio.h>\n#include <linux/iio/sysfs.h>\n#include <linux/iio/events.h>\n#include \"iio_simple_dummy.h\"\n\n \n#include \"iio_dummy_evgen.h\"\n\n \nint iio_simple_dummy_read_event_config(struct iio_dev *indio_dev,\n\t\t\t\t       const struct iio_chan_spec *chan,\n\t\t\t\t       enum iio_event_type type,\n\t\t\t\t       enum iio_event_direction dir)\n{\n\tstruct iio_dummy_state *st = iio_priv(indio_dev);\n\n\treturn st->event_en;\n}\n\n \nint iio_simple_dummy_write_event_config(struct iio_dev *indio_dev,\n\t\t\t\t\tconst struct iio_chan_spec *chan,\n\t\t\t\t\tenum iio_event_type type,\n\t\t\t\t\tenum iio_event_direction dir,\n\t\t\t\t\tint state)\n{\n\tstruct iio_dummy_state *st = iio_priv(indio_dev);\n\n\t \n\tswitch (chan->type) {\n\tcase IIO_VOLTAGE:\n\t\tswitch (type) {\n\t\tcase IIO_EV_TYPE_THRESH:\n\t\t\tif (dir == IIO_EV_DIR_RISING)\n\t\t\t\tst->event_en = state;\n\t\t\telse\n\t\t\t\treturn -EINVAL;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase IIO_ACTIVITY:\n\t\tswitch (type) {\n\t\tcase IIO_EV_TYPE_THRESH:\n\t\t\tst->event_en = state;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase IIO_STEPS:\n\t\tswitch (type) {\n\t\tcase IIO_EV_TYPE_CHANGE:\n\t\t\tst->event_en = state;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\n \nint iio_simple_dummy_read_event_value(struct iio_dev *indio_dev,\n\t\t\t\t      const struct iio_chan_spec *chan,\n\t\t\t\t      enum iio_event_type type,\n\t\t\t\t      enum iio_event_direction dir,\n\t\t\t\t      enum iio_event_info info,\n\t\t\t\t      int *val, int *val2)\n{\n\tstruct iio_dummy_state *st = iio_priv(indio_dev);\n\n\t*val = st->event_val;\n\n\treturn IIO_VAL_INT;\n}\n\n \nint iio_simple_dummy_write_event_value(struct iio_dev *indio_dev,\n\t\t\t\t       const struct iio_chan_spec *chan,\n\t\t\t\t       enum iio_event_type type,\n\t\t\t\t       enum iio_event_direction dir,\n\t\t\t\t       enum iio_event_info info,\n\t\t\t\t       int val, int val2)\n{\n\tstruct iio_dummy_state *st = iio_priv(indio_dev);\n\n\tst->event_val = val;\n\n\treturn 0;\n}\n\nstatic irqreturn_t iio_simple_dummy_get_timestamp(int irq, void *private)\n{\n\tstruct iio_dev *indio_dev = private;\n\tstruct iio_dummy_state *st = iio_priv(indio_dev);\n\n\tst->event_timestamp = iio_get_time_ns(indio_dev);\n\treturn IRQ_WAKE_THREAD;\n}\n\n \nstatic irqreturn_t iio_simple_dummy_event_handler(int irq, void *private)\n{\n\tstruct iio_dev *indio_dev = private;\n\tstruct iio_dummy_state *st = iio_priv(indio_dev);\n\n\tdev_dbg(&indio_dev->dev, \"id %x event %x\\n\",\n\t\tst->regs->reg_id, st->regs->reg_data);\n\n\tswitch (st->regs->reg_data) {\n\tcase 0:\n\t\tiio_push_event(indio_dev,\n\t\t\t       IIO_EVENT_CODE(IIO_VOLTAGE, 0, 0,\n\t\t\t\t\t      IIO_EV_DIR_RISING,\n\t\t\t\t\t      IIO_EV_TYPE_THRESH, 0, 0, 0),\n\t\t\t       st->event_timestamp);\n\t\tbreak;\n\tcase 1:\n\t\tif (st->activity_running > st->event_val)\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_EVENT_CODE(IIO_ACTIVITY, 0,\n\t\t\t\t\t\t      IIO_MOD_RUNNING,\n\t\t\t\t\t\t      IIO_EV_DIR_RISING,\n\t\t\t\t\t\t      IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t      0, 0, 0),\n\t\t\t\t       st->event_timestamp);\n\t\tbreak;\n\tcase 2:\n\t\tif (st->activity_walking < st->event_val)\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_EVENT_CODE(IIO_ACTIVITY, 0,\n\t\t\t\t\t\t      IIO_MOD_WALKING,\n\t\t\t\t\t\t      IIO_EV_DIR_FALLING,\n\t\t\t\t\t\t      IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t      0, 0, 0),\n\t\t\t\t       st->event_timestamp);\n\t\tbreak;\n\tcase 3:\n\t\tiio_push_event(indio_dev,\n\t\t\t       IIO_EVENT_CODE(IIO_STEPS, 0, IIO_NO_MOD,\n\t\t\t\t\t      IIO_EV_DIR_NONE,\n\t\t\t\t\t      IIO_EV_TYPE_CHANGE, 0, 0, 0),\n\t\t\t       st->event_timestamp);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\n \nint iio_simple_dummy_events_register(struct iio_dev *indio_dev)\n{\n\tstruct iio_dummy_state *st = iio_priv(indio_dev);\n\tint ret;\n\n\t \n\tst->event_irq = iio_dummy_evgen_get_irq();\n\tif (st->event_irq < 0) {\n\t\tret = st->event_irq;\n\t\tgoto error_ret;\n\t}\n\tst->regs = iio_dummy_evgen_get_regs(st->event_irq);\n\n\tret = request_threaded_irq(st->event_irq,\n\t\t\t\t   &iio_simple_dummy_get_timestamp,\n\t\t\t\t   &iio_simple_dummy_event_handler,\n\t\t\t\t   IRQF_ONESHOT,\n\t\t\t\t   \"iio_simple_event\",\n\t\t\t\t   indio_dev);\n\tif (ret < 0)\n\t\tgoto error_free_evgen;\n\treturn 0;\n\nerror_free_evgen:\n\tiio_dummy_evgen_release_irq(st->event_irq);\nerror_ret:\n\treturn ret;\n}\n\n \nvoid iio_simple_dummy_events_unregister(struct iio_dev *indio_dev)\n{\n\tstruct iio_dummy_state *st = iio_priv(indio_dev);\n\n\tfree_irq(st->event_irq, indio_dev);\n\t \n\tiio_dummy_evgen_release_irq(st->event_irq);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}