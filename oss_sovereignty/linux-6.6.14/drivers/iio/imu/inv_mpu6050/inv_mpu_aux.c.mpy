{
  "module_name": "inv_mpu_aux.c",
  "hash_id": "bae072e5328c67e7e748ea44cc557ec12e31f98623c0512512c8260a9faadc80",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iio/imu/inv_mpu6050/inv_mpu_aux.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/device.h>\n#include <linux/regmap.h>\n#include <linux/delay.h>\n\n#include \"inv_mpu_aux.h\"\n#include \"inv_mpu_iio.h\"\n\n \nstatic int inv_mpu_i2c_master_xfer(const struct inv_mpu6050_state *st)\n{\n\t \n\tconst unsigned int freq = 50;\n\tconst unsigned int period_ms = 1000 / freq;\n\tuint8_t d;\n\tunsigned int user_ctrl;\n\tint ret;\n\n\t \n\td = INV_MPU6050_FIFO_RATE_TO_DIVIDER(freq);\n\tret = regmap_write(st->map, st->reg->sample_rate_div, d);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tuser_ctrl = st->chip_config.user_ctrl | INV_MPU6050_BIT_I2C_MST_EN;\n\tret = regmap_write(st->map, st->reg->user_ctrl, user_ctrl);\n\tif (ret)\n\t\tgoto error_restore_rate;\n\n\t \n\tmsleep(period_ms + period_ms / 2);\n\n\t \n\tuser_ctrl = st->chip_config.user_ctrl;\n\tret = regmap_write(st->map, st->reg->user_ctrl, user_ctrl);\n\tif (ret)\n\t\tgoto error_stop_i2c;\n\n\t \n\td = st->chip_config.divider;\n\tret = regmap_write(st->map, st->reg->sample_rate_div, d);\n\tif (ret)\n\t\tgoto error_restore_rate;\n\n\treturn 0;\n\nerror_stop_i2c:\n\tregmap_write(st->map, st->reg->user_ctrl, st->chip_config.user_ctrl);\nerror_restore_rate:\n\tregmap_write(st->map, st->reg->sample_rate_div, st->chip_config.divider);\n\treturn ret;\n}\n\n \nint inv_mpu_aux_init(const struct inv_mpu6050_state *st)\n{\n\tunsigned int val;\n\tint ret;\n\n\t \n\tval = INV_MPU6050_BITS_I2C_MST_CLK_400KHZ |\n\t\t\tINV_MPU6050_BIT_WAIT_FOR_ES;\n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_MST_CTRL, val);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV4_CTRL, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tval = INV_MPU6050_BIT_I2C_SLV0_DLY_EN |\n\t\t\tINV_MPU6050_BIT_I2C_SLV1_DLY_EN |\n\t\t\tINV_MPU6050_BIT_I2C_SLV2_DLY_EN |\n\t\t\tINV_MPU6050_BIT_I2C_SLV3_DLY_EN |\n\t\t\tINV_MPU6050_BIT_DELAY_ES_SHADOW;\n\treturn regmap_write(st->map, INV_MPU6050_REG_I2C_MST_DELAY_CTRL, val);\n}\n\n \nint inv_mpu_aux_read(const struct inv_mpu6050_state *st, uint8_t addr,\n\t\t     uint8_t reg, uint8_t *val, size_t size)\n{\n\tunsigned int status;\n\tint ret;\n\n\tif (size > 0x0F)\n\t\treturn -EINVAL;\n\n\t \n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV_ADDR(0),\n\t\t\t   INV_MPU6050_BIT_I2C_SLV_RNW | addr);\n\tif (ret)\n\t\treturn ret;\n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV_REG(0), reg);\n\tif (ret)\n\t\treturn ret;\n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV_CTRL(0),\n\t\t\t   INV_MPU6050_BIT_SLV_EN | size);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = inv_mpu_i2c_master_xfer(st);\n\tif (ret)\n\t\tgoto error_disable_i2c;\n\n\t \n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV_CTRL(0), 0);\n\tif (ret)\n\t\tgoto error_disable_i2c;\n\n\t \n\tret = regmap_read(st->map, INV_MPU6050_REG_I2C_MST_STATUS, &status);\n\tif (ret)\n\t\treturn ret;\n\tif (status & INV_MPU6050_BIT_I2C_SLV0_NACK)\n\t\treturn -EIO;\n\n\t \n\treturn regmap_bulk_read(st->map, INV_MPU6050_REG_EXT_SENS_DATA,\n\t\t\t\tval, size);\n\nerror_disable_i2c:\n\tregmap_write(st->map, INV_MPU6050_REG_I2C_SLV_CTRL(0), 0);\n\treturn ret;\n}\n\n \nint inv_mpu_aux_write(const struct inv_mpu6050_state *st, uint8_t addr,\n\t\t      uint8_t reg, uint8_t val)\n{\n\tunsigned int status;\n\tint ret;\n\n\t \n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV_ADDR(0), addr);\n\tif (ret)\n\t\treturn ret;\n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV_REG(0), reg);\n\tif (ret)\n\t\treturn ret;\n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV_DO(0), val);\n\tif (ret)\n\t\treturn ret;\n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV_CTRL(0),\n\t\t\t   INV_MPU6050_BIT_SLV_EN | 1);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = inv_mpu_i2c_master_xfer(st);\n\tif (ret)\n\t\tgoto error_disable_i2c;\n\n\t \n\tret = regmap_write(st->map, INV_MPU6050_REG_I2C_SLV_CTRL(0), 0);\n\tif (ret)\n\t\tgoto error_disable_i2c;\n\n\t \n\tret = regmap_read(st->map, INV_MPU6050_REG_I2C_MST_STATUS, &status);\n\tif (ret)\n\t\treturn ret;\n\tif (status & INV_MPU6050_BIT_I2C_SLV0_NACK)\n\t\treturn -EIO;\n\n\treturn 0;\n\nerror_disable_i2c:\n\tregmap_write(st->map, INV_MPU6050_REG_I2C_SLV_CTRL(0), 0);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}