{
  "module_name": "s3c-pm-check.c",
  "hash_id": "3c5c186c08939ae824948056bcf981f8cc84ac4cc19569ce17f97eb65d2b1cb1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/samsung/s3c-pm-check.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n#include <linux/kernel.h>\n#include <linux/suspend.h>\n#include <linux/init.h>\n#include <linux/crc32.h>\n#include <linux/ioport.h>\n#include <linux/slab.h>\n\n#include <linux/soc/samsung/s3c-pm.h>\n\n#if CONFIG_SAMSUNG_PM_CHECK_CHUNKSIZE < 1\n#error CONFIG_SAMSUNG_PM_CHECK_CHUNKSIZE must be a positive non-zero value\n#endif\n\n \n\n#define CHECK_CHUNKSIZE (CONFIG_SAMSUNG_PM_CHECK_CHUNKSIZE * 1024)\n\nstatic u32 crc_size;\t \nstatic u32 *crcs;\t \n\ntypedef u32 *(run_fn_t)(struct resource *ptr, u32 *arg);\n\n \n\nstatic void s3c_pm_run_res(struct resource *ptr, run_fn_t fn, u32 *arg)\n{\n\twhile (ptr != NULL) {\n\t\tif (ptr->child != NULL)\n\t\t\ts3c_pm_run_res(ptr->child, fn, arg);\n\n\t\tif ((ptr->flags & IORESOURCE_SYSTEM_RAM)\n\t\t\t\t== IORESOURCE_SYSTEM_RAM) {\n\t\t\tS3C_PMDBG(\"Found system RAM at %08lx..%08lx\\n\",\n\t\t\t\t  (unsigned long)ptr->start,\n\t\t\t\t  (unsigned long)ptr->end);\n\t\t\targ = (fn)(ptr, arg);\n\t\t}\n\n\t\tptr = ptr->sibling;\n\t}\n}\n\nstatic void s3c_pm_run_sysram(run_fn_t fn, u32 *arg)\n{\n\ts3c_pm_run_res(&iomem_resource, fn, arg);\n}\n\nstatic u32 *s3c_pm_countram(struct resource *res, u32 *val)\n{\n\tu32 size = (u32)resource_size(res);\n\n\tsize += CHECK_CHUNKSIZE-1;\n\tsize /= CHECK_CHUNKSIZE;\n\n\tS3C_PMDBG(\"Area %08lx..%08lx, %d blocks\\n\",\n\t\t  (unsigned long)res->start, (unsigned long)res->end, size);\n\n\t*val += size * sizeof(u32);\n\treturn val;\n}\n\n \n\nvoid s3c_pm_check_prepare(void)\n{\n\tcrc_size = 0;\n\n\ts3c_pm_run_sysram(s3c_pm_countram, &crc_size);\n\n\tS3C_PMDBG(\"s3c_pm_prepare_check: %u checks needed\\n\", crc_size);\n\n\tcrcs = kmalloc(crc_size+4, GFP_KERNEL);\n\tif (crcs == NULL)\n\t\tprintk(KERN_ERR \"Cannot allocated CRC save area\\n\");\n}\n\nstatic u32 *s3c_pm_makecheck(struct resource *res, u32 *val)\n{\n\tunsigned long addr, left;\n\n\tfor (addr = res->start; addr < res->end;\n\t     addr += CHECK_CHUNKSIZE) {\n\t\tleft = res->end - addr;\n\n\t\tif (left > CHECK_CHUNKSIZE)\n\t\t\tleft = CHECK_CHUNKSIZE;\n\n\t\t*val = crc32_le(~0, phys_to_virt(addr), left);\n\t\tval++;\n\t}\n\n\treturn val;\n}\n\n \n\nvoid s3c_pm_check_store(void)\n{\n\tif (crcs != NULL)\n\t\ts3c_pm_run_sysram(s3c_pm_makecheck, crcs);\n}\n\n \n\nstatic inline int in_region(void *ptr, int size, void *what, size_t whatsz)\n{\n\tif ((what+whatsz) < ptr)\n\t\treturn 0;\n\n\tif (what > (ptr+size))\n\t\treturn 0;\n\n\treturn 1;\n}\n\n \nstatic u32 *s3c_pm_runcheck(struct resource *res, u32 *val)\n{\n\tunsigned long addr;\n\tunsigned long left;\n\tvoid *stkpage;\n\tvoid *ptr;\n\tu32 calc;\n\n\tstkpage = (void *)((u32)&calc & ~PAGE_MASK);\n\n\tfor (addr = res->start; addr < res->end;\n\t     addr += CHECK_CHUNKSIZE) {\n\t\tleft = res->end - addr;\n\n\t\tif (left > CHECK_CHUNKSIZE)\n\t\t\tleft = CHECK_CHUNKSIZE;\n\n\t\tptr = phys_to_virt(addr);\n\n\t\tif (in_region(ptr, left, stkpage, 4096)) {\n\t\t\tS3C_PMDBG(\"skipping %08lx, has stack in\\n\", addr);\n\t\t\tgoto skip_check;\n\t\t}\n\n\t\tif (in_region(ptr, left, crcs, crc_size)) {\n\t\t\tS3C_PMDBG(\"skipping %08lx, has crc block in\\n\", addr);\n\t\t\tgoto skip_check;\n\t\t}\n\n\t\t \n\n\t\tcalc = crc32_le(~0, ptr, left);\n\t\tif (calc != *val) {\n\t\t\tprintk(KERN_ERR \"Restore CRC error at \"\n\t\t\t       \"%08lx (%08x vs %08x)\\n\", addr, calc, *val);\n\n\t\t\tS3C_PMDBG(\"Restore CRC error at %08lx (%08x vs %08x)\\n\",\n\t\t\t    addr, calc, *val);\n\t\t}\n\n\tskip_check:\n\t\tval++;\n\t}\n\n\treturn val;\n}\n\n \nvoid s3c_pm_check_restore(void)\n{\n\tif (crcs != NULL)\n\t\ts3c_pm_run_sysram(s3c_pm_runcheck, crcs);\n}\n\n \nvoid s3c_pm_check_cleanup(void)\n{\n\tkfree(crcs);\n\tcrcs = NULL;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}