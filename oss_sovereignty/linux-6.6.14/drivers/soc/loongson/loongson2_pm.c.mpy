{
  "module_name": "loongson2_pm.c",
  "hash_id": "47e6e6d790f03aaa6b9ba0e76cf3f2bf4916b41ba6a325da19b28379289b36f8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/loongson/loongson2_pm.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/init.h>\n#include <linux/input.h>\n#include <linux/suspend.h>\n#include <linux/interrupt.h>\n#include <linux/of_platform.h>\n#include <linux/pm_wakeirq.h>\n#include <linux/platform_device.h>\n#include <asm/bootinfo.h>\n#include <asm/suspend.h>\n\n#define LOONGSON2_PM1_CNT_REG\t\t0x14\n#define LOONGSON2_PM1_STS_REG\t\t0x0c\n#define LOONGSON2_PM1_ENA_REG\t\t0x10\n#define LOONGSON2_GPE0_STS_REG\t\t0x28\n#define LOONGSON2_GPE0_ENA_REG\t\t0x2c\n\n#define LOONGSON2_PM1_PWRBTN_STS\tBIT(8)\n#define LOONGSON2_PM1_PCIEXP_WAKE_STS\tBIT(14)\n#define LOONGSON2_PM1_WAKE_STS\t\tBIT(15)\n#define LOONGSON2_PM1_CNT_INT_EN\tBIT(0)\n#define LOONGSON2_PM1_PWRBTN_EN\t\tLOONGSON2_PM1_PWRBTN_STS\n\nstatic struct loongson2_pm {\n\tvoid __iomem\t\t\t*base;\n\tstruct input_dev\t\t*dev;\n\tbool\t\t\t\tsuspended;\n} loongson2_pm;\n\n#define loongson2_pm_readw(reg)\t\treadw(loongson2_pm.base + reg)\n#define loongson2_pm_readl(reg)\t\treadl(loongson2_pm.base + reg)\n#define loongson2_pm_writew(val, reg)\twritew(val, loongson2_pm.base + reg)\n#define loongson2_pm_writel(val, reg)\twritel(val, loongson2_pm.base + reg)\n\nstatic void loongson2_pm_status_clear(void)\n{\n\tu16 value;\n\n\tvalue = loongson2_pm_readw(LOONGSON2_PM1_STS_REG);\n\tvalue |= (LOONGSON2_PM1_PWRBTN_STS | LOONGSON2_PM1_PCIEXP_WAKE_STS |\n\t\t  LOONGSON2_PM1_WAKE_STS);\n\tloongson2_pm_writew(value, LOONGSON2_PM1_STS_REG);\n\tloongson2_pm_writel(loongson2_pm_readl(LOONGSON2_GPE0_STS_REG), LOONGSON2_GPE0_STS_REG);\n}\n\nstatic void loongson2_pm_irq_enable(void)\n{\n\tu16 value;\n\n\tvalue = loongson2_pm_readw(LOONGSON2_PM1_CNT_REG);\n\tvalue |= LOONGSON2_PM1_CNT_INT_EN;\n\tloongson2_pm_writew(value, LOONGSON2_PM1_CNT_REG);\n\n\tvalue = loongson2_pm_readw(LOONGSON2_PM1_ENA_REG);\n\tvalue |= LOONGSON2_PM1_PWRBTN_EN;\n\tloongson2_pm_writew(value, LOONGSON2_PM1_ENA_REG);\n}\n\nstatic int loongson2_suspend_enter(suspend_state_t state)\n{\n\tloongson2_pm_status_clear();\n\tloongarch_common_suspend();\n\tloongarch_suspend_enter();\n\tloongarch_common_resume();\n\tloongson2_pm_irq_enable();\n\tpm_set_resume_via_firmware();\n\n\treturn 0;\n}\n\nstatic int loongson2_suspend_begin(suspend_state_t state)\n{\n\tpm_set_suspend_via_firmware();\n\n\treturn 0;\n}\n\nstatic int loongson2_suspend_valid_state(suspend_state_t state)\n{\n\treturn (state == PM_SUSPEND_MEM);\n}\n\nstatic const struct platform_suspend_ops loongson2_suspend_ops = {\n\t.valid\t= loongson2_suspend_valid_state,\n\t.begin\t= loongson2_suspend_begin,\n\t.enter\t= loongson2_suspend_enter,\n};\n\nstatic int loongson2_power_button_init(struct device *dev, int irq)\n{\n\tint ret;\n\tstruct input_dev *button;\n\n\tbutton = input_allocate_device();\n\tif (!dev)\n\t\treturn -ENOMEM;\n\n\tbutton->name = \"Power Button\";\n\tbutton->phys = \"pm/button/input0\";\n\tbutton->id.bustype = BUS_HOST;\n\tbutton->dev.parent = NULL;\n\tinput_set_capability(button, EV_KEY, KEY_POWER);\n\n\tret = input_register_device(button);\n\tif (ret)\n\t\tgoto free_dev;\n\n\tdev_pm_set_wake_irq(&button->dev, irq);\n\tdevice_set_wakeup_capable(&button->dev, true);\n\tdevice_set_wakeup_enable(&button->dev, true);\n\n\tloongson2_pm.dev = button;\n\tdev_info(dev, \"Power Button: Init successful!\\n\");\n\n\treturn 0;\n\nfree_dev:\n\tinput_free_device(button);\n\n\treturn ret;\n}\n\nstatic irqreturn_t loongson2_pm_irq_handler(int irq, void *dev_id)\n{\n\tu16 status = loongson2_pm_readw(LOONGSON2_PM1_STS_REG);\n\n\tif (!loongson2_pm.suspended && (status & LOONGSON2_PM1_PWRBTN_STS)) {\n\t\tpr_info(\"Power Button pressed...\\n\");\n\t\tinput_report_key(loongson2_pm.dev, KEY_POWER, 1);\n\t\tinput_sync(loongson2_pm.dev);\n\t\tinput_report_key(loongson2_pm.dev, KEY_POWER, 0);\n\t\tinput_sync(loongson2_pm.dev);\n\t}\n\n\tloongson2_pm_status_clear();\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int __maybe_unused loongson2_pm_suspend(struct device *dev)\n{\n\tloongson2_pm.suspended = true;\n\n\treturn 0;\n}\n\nstatic int __maybe_unused loongson2_pm_resume(struct device *dev)\n{\n\tloongson2_pm.suspended = false;\n\n\treturn 0;\n}\nstatic SIMPLE_DEV_PM_OPS(loongson2_pm_ops, loongson2_pm_suspend, loongson2_pm_resume);\n\nstatic int loongson2_pm_probe(struct platform_device *pdev)\n{\n\tint irq, retval;\n\tu64 suspend_addr;\n\tstruct device *dev = &pdev->dev;\n\n\tloongson2_pm.base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(loongson2_pm.base))\n\t\treturn PTR_ERR(loongson2_pm.base);\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\tif (!device_property_read_u64(dev, \"loongson,suspend-address\", &suspend_addr))\n\t\tloongson_sysconf.suspend_addr = (u64)phys_to_virt(suspend_addr);\n\telse\n\t\tdev_err(dev, \"No loongson,suspend-address, could not support S3!\\n\");\n\n\tif (loongson2_power_button_init(dev, irq))\n\t\treturn -EINVAL;\n\n\tretval = devm_request_irq(&pdev->dev, irq, loongson2_pm_irq_handler,\n\t\t\t\t  IRQF_SHARED, \"pm_irq\", &loongson2_pm);\n\tif (retval)\n\t\treturn retval;\n\n\tloongson2_pm_irq_enable();\n\tloongson2_pm_status_clear();\n\n\tif (loongson_sysconf.suspend_addr)\n\t\tsuspend_set_ops(&loongson2_suspend_ops);\n\n\t \n\tretval = devm_of_platform_populate(dev);\n\tif (retval)\n\t\tdev_err(dev, \"Error populating children, reboot and poweroff might not work properly\\n\");\n\n\treturn 0;\n}\n\nstatic const struct of_device_id loongson2_pm_match[] = {\n\t{ .compatible = \"loongson,ls2k0500-pmc\", },\n\t{},\n};\n\nstatic struct platform_driver loongson2_pm_driver = {\n\t.driver = {\n\t\t.name = \"ls2k-pm\",\n\t\t.pm = &loongson2_pm_ops,\n\t\t.of_match_table = loongson2_pm_match,\n\t},\n\t.probe = loongson2_pm_probe,\n};\nmodule_platform_driver(loongson2_pm_driver);\n\nMODULE_DESCRIPTION(\"Loongson-2 PM driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}