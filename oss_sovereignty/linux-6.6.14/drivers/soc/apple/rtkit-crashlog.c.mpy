{
  "module_name": "rtkit-crashlog.c",
  "hash_id": "47ce17b15df1b8b3ddc520e9369487939bd4e63814091c427d73372c1442586e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/apple/rtkit-crashlog.c",
  "human_readable_source": "\n \n#include \"rtkit-internal.h\"\n\n#define FOURCC(a, b, c, d) \\\n\t(((u32)(a) << 24) | ((u32)(b) << 16) | ((u32)(c) << 8) | ((u32)(d)))\n\n#define APPLE_RTKIT_CRASHLOG_HEADER FOURCC('C', 'L', 'H', 'E')\n#define APPLE_RTKIT_CRASHLOG_STR FOURCC('C', 's', 't', 'r')\n#define APPLE_RTKIT_CRASHLOG_VERSION FOURCC('C', 'v', 'e', 'r')\n#define APPLE_RTKIT_CRASHLOG_MBOX FOURCC('C', 'm', 'b', 'x')\n#define APPLE_RTKIT_CRASHLOG_TIME FOURCC('C', 't', 'i', 'm')\n#define APPLE_RTKIT_CRASHLOG_REGS FOURCC('C', 'r', 'g', '8')\n\n \n#ifndef PSR_MODE_EL0t\n#define PSR_MODE_EL0t\t0x00000000\n#define PSR_MODE_EL1t\t0x00000004\n#define PSR_MODE_EL1h\t0x00000005\n#define PSR_MODE_EL2t\t0x00000008\n#define PSR_MODE_EL2h\t0x00000009\n#define PSR_MODE_MASK\t0x0000000f\n#endif\n\nstruct apple_rtkit_crashlog_header {\n\tu32 fourcc;\n\tu32 version;\n\tu32 size;\n\tu32 flags;\n\tu8 _unk[16];\n};\nstatic_assert(sizeof(struct apple_rtkit_crashlog_header) == 0x20);\n\nstruct apple_rtkit_crashlog_mbox_entry {\n\tu64 msg0;\n\tu64 msg1;\n\tu32 timestamp;\n\tu8 _unk[4];\n};\nstatic_assert(sizeof(struct apple_rtkit_crashlog_mbox_entry) == 0x18);\n\nstruct apple_rtkit_crashlog_regs {\n\tu32 unk_0;\n\tu32 unk_4;\n\tu64 regs[31];\n\tu64 sp;\n\tu64 pc;\n\tu64 psr;\n\tu64 cpacr;\n\tu64 fpsr;\n\tu64 fpcr;\n\tu64 unk[64];\n\tu64 far;\n\tu64 unk_X;\n\tu64 esr;\n\tu64 unk_Z;\n} __packed;\nstatic_assert(sizeof(struct apple_rtkit_crashlog_regs) == 0x350);\n\nstatic void apple_rtkit_crashlog_dump_str(struct apple_rtkit *rtk, u8 *bfr,\n\t\t\t\t\t  size_t size)\n{\n\tu32 idx;\n\tu8 *ptr, *end;\n\n\tmemcpy(&idx, bfr, 4);\n\n\tptr = bfr + 4;\n\tend = bfr + size;\n\twhile (ptr < end) {\n\t\tu8 *newline = memchr(ptr, '\\n', end - ptr);\n\n\t\tif (newline) {\n\t\t\tu8 tmp = *newline;\n\t\t\t*newline = '\\0';\n\t\t\tdev_warn(rtk->dev, \"RTKit: Message (id=%x): %s\\n\", idx,\n\t\t\t\t ptr);\n\t\t\t*newline = tmp;\n\t\t\tptr = newline + 1;\n\t\t} else {\n\t\t\tdev_warn(rtk->dev, \"RTKit: Message (id=%x): %s\", idx,\n\t\t\t\t ptr);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic void apple_rtkit_crashlog_dump_version(struct apple_rtkit *rtk, u8 *bfr,\n\t\t\t\t\t      size_t size)\n{\n\tdev_warn(rtk->dev, \"RTKit: Version: %s\", bfr + 16);\n}\n\nstatic void apple_rtkit_crashlog_dump_time(struct apple_rtkit *rtk, u8 *bfr,\n\t\t\t\t\t   size_t size)\n{\n\tu64 crash_time;\n\n\tmemcpy(&crash_time, bfr, 8);\n\tdev_warn(rtk->dev, \"RTKit: Crash time: %lld\", crash_time);\n}\n\nstatic void apple_rtkit_crashlog_dump_mailbox(struct apple_rtkit *rtk, u8 *bfr,\n\t\t\t\t\t      size_t size)\n{\n\tu32 type, index, i;\n\tsize_t n_messages;\n\tstruct apple_rtkit_crashlog_mbox_entry entry;\n\n\tmemcpy(&type, bfr + 16, 4);\n\tmemcpy(&index, bfr + 24, 4);\n\tn_messages = (size - 28) / sizeof(entry);\n\n\tdev_warn(rtk->dev, \"RTKit: Mailbox history (type = %d, index = %d)\",\n\t\t type, index);\n\tfor (i = 0; i < n_messages; ++i) {\n\t\tmemcpy(&entry, bfr + 28 + i * sizeof(entry), sizeof(entry));\n\t\tdev_warn(rtk->dev, \"RTKit:  #%03d@%08x: %016llx %016llx\", i,\n\t\t\t entry.timestamp, entry.msg0, entry.msg1);\n\t}\n}\n\nstatic void apple_rtkit_crashlog_dump_regs(struct apple_rtkit *rtk, u8 *bfr,\n\t\t\t\t\t   size_t size)\n{\n\tstruct apple_rtkit_crashlog_regs *regs;\n\tconst char *el;\n\tint i;\n\n\tif (size < sizeof(*regs)) {\n\t\tdev_warn(rtk->dev, \"RTKit: Regs section too small: 0x%zx\", size);\n\t\treturn;\n\t}\n\n\tregs = (struct apple_rtkit_crashlog_regs *)bfr;\n\n\tswitch (regs->psr & PSR_MODE_MASK) {\n\tcase PSR_MODE_EL0t:\n\t\tel = \"EL0t\";\n\t\tbreak;\n\tcase PSR_MODE_EL1t:\n\t\tel = \"EL1t\";\n\t\tbreak;\n\tcase PSR_MODE_EL1h:\n\t\tel = \"EL1h\";\n\t\tbreak;\n\tcase PSR_MODE_EL2t:\n\t\tel = \"EL2t\";\n\t\tbreak;\n\tcase PSR_MODE_EL2h:\n\t\tel = \"EL2h\";\n\t\tbreak;\n\tdefault:\n\t\tel = \"unknown\";\n\t\tbreak;\n\t}\n\n\tdev_warn(rtk->dev, \"RTKit: Exception dump:\");\n\tdev_warn(rtk->dev, \"  == Exception taken from %s ==\", el);\n\tdev_warn(rtk->dev, \"  PSR    = 0x%llx\", regs->psr);\n\tdev_warn(rtk->dev, \"  PC     = 0x%llx\\n\", regs->pc);\n\tdev_warn(rtk->dev, \"  ESR    = 0x%llx\\n\", regs->esr);\n\tdev_warn(rtk->dev, \"  FAR    = 0x%llx\\n\", regs->far);\n\tdev_warn(rtk->dev, \"  SP     = 0x%llx\\n\", regs->sp);\n\tdev_warn(rtk->dev, \"\\n\");\n\n\tfor (i = 0; i < 31; i += 4) {\n\t\tif (i < 28)\n\t\t\tdev_warn(rtk->dev,\n\t\t\t\t\t \"  x%02d-x%02d = %016llx %016llx %016llx %016llx\\n\",\n\t\t\t\t\t i, i + 3,\n\t\t\t\t\t regs->regs[i], regs->regs[i + 1],\n\t\t\t\t\t regs->regs[i + 2], regs->regs[i + 3]);\n\t\telse\n\t\t\tdev_warn(rtk->dev,\n\t\t\t\t\t \"  x%02d-x%02d = %016llx %016llx %016llx\\n\", i, i + 3,\n\t\t\t\t\t regs->regs[i], regs->regs[i + 1], regs->regs[i + 2]);\n\t}\n\n\tdev_warn(rtk->dev, \"\\n\");\n}\n\nvoid apple_rtkit_crashlog_dump(struct apple_rtkit *rtk, u8 *bfr, size_t size)\n{\n\tsize_t offset;\n\tu32 section_fourcc, section_size;\n\tstruct apple_rtkit_crashlog_header header;\n\n\tmemcpy(&header, bfr, sizeof(header));\n\tif (header.fourcc != APPLE_RTKIT_CRASHLOG_HEADER) {\n\t\tdev_warn(rtk->dev, \"RTKit: Expected crashlog header but got %x\",\n\t\t\t header.fourcc);\n\t\treturn;\n\t}\n\n\tif (header.size > size) {\n\t\tdev_warn(rtk->dev, \"RTKit: Crashlog size (%x) is too large\",\n\t\t\t header.size);\n\t\treturn;\n\t}\n\n\tsize = header.size;\n\toffset = sizeof(header);\n\n\twhile (offset < size) {\n\t\tmemcpy(&section_fourcc, bfr + offset, 4);\n\t\tmemcpy(&section_size, bfr + offset + 12, 4);\n\n\t\tswitch (section_fourcc) {\n\t\tcase APPLE_RTKIT_CRASHLOG_HEADER:\n\t\t\tdev_dbg(rtk->dev, \"RTKit: End of crashlog reached\");\n\t\t\treturn;\n\t\tcase APPLE_RTKIT_CRASHLOG_STR:\n\t\t\tapple_rtkit_crashlog_dump_str(rtk, bfr + offset + 16,\n\t\t\t\t\t\t      section_size);\n\t\t\tbreak;\n\t\tcase APPLE_RTKIT_CRASHLOG_VERSION:\n\t\t\tapple_rtkit_crashlog_dump_version(\n\t\t\t\trtk, bfr + offset + 16, section_size);\n\t\t\tbreak;\n\t\tcase APPLE_RTKIT_CRASHLOG_MBOX:\n\t\t\tapple_rtkit_crashlog_dump_mailbox(\n\t\t\t\trtk, bfr + offset + 16, section_size);\n\t\t\tbreak;\n\t\tcase APPLE_RTKIT_CRASHLOG_TIME:\n\t\t\tapple_rtkit_crashlog_dump_time(rtk, bfr + offset + 16,\n\t\t\t\t\t\t       section_size);\n\t\t\tbreak;\n\t\tcase APPLE_RTKIT_CRASHLOG_REGS:\n\t\t\tapple_rtkit_crashlog_dump_regs(rtk, bfr + offset + 16,\n\t\t\t\t\t\t       section_size);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_warn(rtk->dev,\n\t\t\t\t \"RTKit: Unknown crashlog section: %x\",\n\t\t\t\t section_fourcc);\n\t\t}\n\n\t\toffset += section_size;\n\t}\n\n\tdev_warn(rtk->dev,\n\t\t \"RTKit: End of crashlog reached but no footer present\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}