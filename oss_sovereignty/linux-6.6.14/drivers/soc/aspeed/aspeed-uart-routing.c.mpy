{
  "module_name": "aspeed-uart-routing.c",
  "hash_id": "edbf148f3883e4544d6643d556a54a0b3acf51426f5b7708f0f141093691ff6a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/aspeed/aspeed-uart-routing.c",
  "human_readable_source": "\n \n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/mfd/syscon.h>\n#include <linux/regmap.h>\n#include <linux/platform_device.h>\n\n \n#define HICR9\t0x98\n#define HICRA\t0x9c\n\n \n#define UART_ROUTING_IO1\t\"io1\"\n#define UART_ROUTING_IO2\t\"io2\"\n#define UART_ROUTING_IO3\t\"io3\"\n#define UART_ROUTING_IO4\t\"io4\"\n#define UART_ROUTING_IO5\t\"io5\"\n#define UART_ROUTING_IO6\t\"io6\"\n#define UART_ROUTING_IO10\t\"io10\"\n#define UART_ROUTING_UART1\t\"uart1\"\n#define UART_ROUTING_UART2\t\"uart2\"\n#define UART_ROUTING_UART3\t\"uart3\"\n#define UART_ROUTING_UART4\t\"uart4\"\n#define UART_ROUTING_UART5\t\"uart5\"\n#define UART_ROUTING_UART6\t\"uart6\"\n#define UART_ROUTING_UART10\t\"uart10\"\n#define UART_ROUTING_RES\t\"reserved\"\n\nstruct aspeed_uart_routing {\n\tstruct regmap *map;\n\tstruct attribute_group const *attr_grp;\n};\n\nstruct aspeed_uart_routing_selector {\n\tstruct device_attribute\tdev_attr;\n\tuint8_t reg;\n\tuint8_t mask;\n\tuint8_t shift;\n\tconst char *const options[];\n};\n\n#define to_routing_selector(_dev_attr)\t\t\t\t\t\\\n\tcontainer_of(_dev_attr, struct aspeed_uart_routing_selector, dev_attr)\n\nstatic ssize_t aspeed_uart_routing_show(struct device *dev,\n\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\tchar *buf);\n\nstatic ssize_t aspeed_uart_routing_store(struct device *dev,\n\t\t\t\t\t struct device_attribute *attr,\n\t\t\t\t\t const char *buf, size_t count);\n\n#define ROUTING_ATTR(_name) {\t\t\t\t\t\\\n\t.attr = {.name = _name,\t\t\t\t\t\\\n\t\t .mode = VERIFY_OCTAL_PERMISSIONS(0644) },\t\\\n\t.show = aspeed_uart_routing_show,\t\t\t\\\n\t.store = aspeed_uart_routing_store,\t\t\t\\\n}\n\n \nstatic struct aspeed_uart_routing_selector ast2500_io6_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO6),\n\t.reg = HICR9,\n\t.shift = 8,\n\t.mask = 0xf,\n\t.options = {\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART5,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO5,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_uart5_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART5),\n\t.reg = HICRA,\n\t.shift = 28,\n\t.mask = 0xf,\n\t.options = {\n\t\t    UART_ROUTING_IO5,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_uart4_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART4),\n\t.reg = HICRA,\n\t.shift = 25,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t},\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_uart3_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART3),\n\t.reg = HICRA,\n\t.shift = 22,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_uart2_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART2),\n\t.reg = HICRA,\n\t.shift = 19,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_uart1_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART1),\n\t.reg = HICRA,\n\t.shift = 16,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_io5_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO5),\n\t.reg = HICRA,\n\t.shift = 12,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_UART5,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_io4_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO4),\n\t.reg = HICRA,\n\t.shift = 9,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART5,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_io3_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO3),\n\t.reg = HICRA,\n\t.shift = 6,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART5,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_io2_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO2),\n\t.reg = HICRA,\n\t.shift = 3,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART5,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2500_io1_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO1),\n\t.reg = HICRA,\n\t.shift = 0,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART5,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO6,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct attribute *ast2500_uart_routing_attrs[] = {\n\t&ast2500_io6_sel.dev_attr.attr,\n\t&ast2500_uart5_sel.dev_attr.attr,\n\t&ast2500_uart4_sel.dev_attr.attr,\n\t&ast2500_uart3_sel.dev_attr.attr,\n\t&ast2500_uart2_sel.dev_attr.attr,\n\t&ast2500_uart1_sel.dev_attr.attr,\n\t&ast2500_io5_sel.dev_attr.attr,\n\t&ast2500_io4_sel.dev_attr.attr,\n\t&ast2500_io3_sel.dev_attr.attr,\n\t&ast2500_io2_sel.dev_attr.attr,\n\t&ast2500_io1_sel.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group ast2500_uart_routing_attr_group = {\n\t.attrs = ast2500_uart_routing_attrs,\n};\n\n \nstatic struct aspeed_uart_routing_selector ast2600_uart10_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART10),\n\t.reg = HICR9,\n\t.shift = 12,\n\t.mask = 0xf,\n\t.options = {\n\t\t    UART_ROUTING_IO10,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t\tUART_ROUTING_RES,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2600_io10_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO10),\n\t.reg = HICR9,\n\t.shift = 8,\n\t.mask = 0xf,\n\t.options = {\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t\tUART_ROUTING_RES,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t\tUART_ROUTING_RES,\n\t\t    UART_ROUTING_UART10,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2600_uart4_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART4),\n\t.reg = HICRA,\n\t.shift = 25,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_IO10,\n\t\t    NULL,\n\t},\n};\n\nstatic struct aspeed_uart_routing_selector ast2600_uart3_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART3),\n\t.reg = HICRA,\n\t.shift = 22,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_IO10,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2600_uart2_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART2),\n\t.reg = HICRA,\n\t.shift = 19,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_IO10,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2600_uart1_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_UART1),\n\t.reg = HICRA,\n\t.shift = 16,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_IO10,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2600_io4_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO4),\n\t.reg = HICRA,\n\t.shift = 9,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART10,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO10,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2600_io3_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO3),\n\t.reg = HICRA,\n\t.shift = 6,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART10,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_IO1,\n\t\t    UART_ROUTING_IO2,\n\t\t    UART_ROUTING_IO10,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2600_io2_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO2),\n\t.reg = HICRA,\n\t.shift = 3,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART10,\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO10,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct aspeed_uart_routing_selector ast2600_io1_sel = {\n\t.dev_attr = ROUTING_ATTR(UART_ROUTING_IO1),\n\t.reg = HICRA,\n\t.shift = 0,\n\t.mask = 0x7,\n\t.options = {\n\t\t    UART_ROUTING_UART1,\n\t\t    UART_ROUTING_UART2,\n\t\t    UART_ROUTING_UART3,\n\t\t    UART_ROUTING_UART4,\n\t\t    UART_ROUTING_UART10,\n\t\t    UART_ROUTING_IO3,\n\t\t    UART_ROUTING_IO4,\n\t\t    UART_ROUTING_IO10,\n\t\t    NULL,\n\t\t    },\n};\n\nstatic struct attribute *ast2600_uart_routing_attrs[] = {\n\t&ast2600_uart10_sel.dev_attr.attr,\n\t&ast2600_io10_sel.dev_attr.attr,\n\t&ast2600_uart4_sel.dev_attr.attr,\n\t&ast2600_uart3_sel.dev_attr.attr,\n\t&ast2600_uart2_sel.dev_attr.attr,\n\t&ast2600_uart1_sel.dev_attr.attr,\n\t&ast2600_io4_sel.dev_attr.attr,\n\t&ast2600_io3_sel.dev_attr.attr,\n\t&ast2600_io2_sel.dev_attr.attr,\n\t&ast2600_io1_sel.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group ast2600_uart_routing_attr_group = {\n\t.attrs = ast2600_uart_routing_attrs,\n};\n\nstatic ssize_t aspeed_uart_routing_show(struct device *dev,\n\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\tchar *buf)\n{\n\tstruct aspeed_uart_routing *uart_routing = dev_get_drvdata(dev);\n\tstruct aspeed_uart_routing_selector *sel = to_routing_selector(attr);\n\tint val, pos, len;\n\n\tregmap_read(uart_routing->map, sel->reg, &val);\n\tval = (val >> sel->shift) & sel->mask;\n\n\tlen = 0;\n\tfor (pos = 0; sel->options[pos] != NULL; ++pos) {\n\t\tif (pos == val)\n\t\t\tlen += sysfs_emit_at(buf, len, \"[%s] \", sel->options[pos]);\n\t\telse\n\t\t\tlen += sysfs_emit_at(buf, len, \"%s \", sel->options[pos]);\n\t}\n\n\tif (val >= pos)\n\t\tlen += sysfs_emit_at(buf, len, \"[unknown(%d)]\", val);\n\n\tlen += sysfs_emit_at(buf, len, \"\\n\");\n\n\treturn len;\n}\n\nstatic ssize_t aspeed_uart_routing_store(struct device *dev,\n\t\t\t\t\t struct device_attribute *attr,\n\t\t\t\t\t const char *buf, size_t count)\n{\n\tstruct aspeed_uart_routing *uart_routing = dev_get_drvdata(dev);\n\tstruct aspeed_uart_routing_selector *sel = to_routing_selector(attr);\n\tint val;\n\n\tval = __sysfs_match_string(sel->options, -1, buf);\n\tif (val < 0) {\n\t\tdev_err(dev, \"invalid value \\\"%s\\\"\\n\", buf);\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(uart_routing->map, sel->reg,\n\t\t\t(sel->mask << sel->shift),\n\t\t\t(val & sel->mask) << sel->shift);\n\n\treturn count;\n}\n\nstatic int aspeed_uart_routing_probe(struct platform_device *pdev)\n{\n\tint rc;\n\tstruct device *dev = &pdev->dev;\n\tstruct aspeed_uart_routing *uart_routing;\n\n\tuart_routing = devm_kzalloc(&pdev->dev, sizeof(*uart_routing), GFP_KERNEL);\n\tif (!uart_routing)\n\t\treturn -ENOMEM;\n\n\tuart_routing->map = syscon_node_to_regmap(dev->parent->of_node);\n\tif (IS_ERR(uart_routing->map)) {\n\t\tdev_err(dev, \"cannot get regmap\\n\");\n\t\treturn PTR_ERR(uart_routing->map);\n\t}\n\n\tuart_routing->attr_grp = of_device_get_match_data(dev);\n\n\trc = sysfs_create_group(&dev->kobj, uart_routing->attr_grp);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tdev_set_drvdata(dev, uart_routing);\n\n\tdev_info(dev, \"module loaded\\n\");\n\n\treturn 0;\n}\n\nstatic int aspeed_uart_routing_remove(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct aspeed_uart_routing *uart_routing = platform_get_drvdata(pdev);\n\n\tsysfs_remove_group(&dev->kobj, uart_routing->attr_grp);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id aspeed_uart_routing_table[] = {\n\t{ .compatible = \"aspeed,ast2400-uart-routing\",\n\t  .data = &ast2500_uart_routing_attr_group },\n\t{ .compatible = \"aspeed,ast2500-uart-routing\",\n\t  .data = &ast2500_uart_routing_attr_group },\n\t{ .compatible = \"aspeed,ast2600-uart-routing\",\n\t  .data = &ast2600_uart_routing_attr_group },\n\t{ },\n};\n\nstatic struct platform_driver aspeed_uart_routing_driver = {\n\t.driver = {\n\t\t.name = \"aspeed-uart-routing\",\n\t\t.of_match_table = aspeed_uart_routing_table,\n\t},\n\t.probe = aspeed_uart_routing_probe,\n\t.remove = aspeed_uart_routing_remove,\n};\n\nmodule_platform_driver(aspeed_uart_routing_driver);\n\nMODULE_AUTHOR(\"Oskar Senft <osk@google.com>\");\nMODULE_AUTHOR(\"Chia-Wei Wang <chiawei_wang@aspeedtech.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Driver to configure Aspeed UART routing\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}