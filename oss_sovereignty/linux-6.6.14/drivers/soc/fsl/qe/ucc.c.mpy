{
  "module_name": "ucc.c",
  "hash_id": "47b6d631edd3a14f20be5023f10951389a6b89b9d67a56c756994a8cd7bebc98",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/fsl/qe/ucc.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/stddef.h>\n#include <linux/spinlock.h>\n#include <linux/export.h>\n\n#include <asm/io.h>\n#include <soc/fsl/qe/immap_qe.h>\n#include <soc/fsl/qe/qe.h>\n#include <soc/fsl/qe/ucc.h>\n\n#define UCC_TDM_NUM 8\n#define RX_SYNC_SHIFT_BASE 30\n#define TX_SYNC_SHIFT_BASE 14\n#define RX_CLK_SHIFT_BASE 28\n#define TX_CLK_SHIFT_BASE 12\n\nint ucc_set_qe_mux_mii_mng(unsigned int ucc_num)\n{\n\tunsigned long flags;\n\n\tif (ucc_num > UCC_MAX_NUM - 1)\n\t\treturn -EINVAL;\n\n\tspin_lock_irqsave(&cmxgcr_lock, flags);\n\tqe_clrsetbits_be32(&qe_immr->qmx.cmxgcr, QE_CMXGCR_MII_ENET_MNG,\n\t\t\t   ucc_num << QE_CMXGCR_MII_ENET_MNG_SHIFT);\n\tspin_unlock_irqrestore(&cmxgcr_lock, flags);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(ucc_set_qe_mux_mii_mng);\n\n \nint ucc_set_type(unsigned int ucc_num, enum ucc_speed_type speed)\n{\n\tu8 __iomem *guemr;\n\n\t \n\tswitch (ucc_num) {\n\tcase 0: guemr = &qe_immr->ucc1.slow.guemr;\n\t\tbreak;\n\tcase 1: guemr = &qe_immr->ucc2.slow.guemr;\n\t\tbreak;\n\tcase 2: guemr = &qe_immr->ucc3.slow.guemr;\n\t\tbreak;\n\tcase 3: guemr = &qe_immr->ucc4.slow.guemr;\n\t\tbreak;\n\tcase 4: guemr = &qe_immr->ucc5.slow.guemr;\n\t\tbreak;\n\tcase 5: guemr = &qe_immr->ucc6.slow.guemr;\n\t\tbreak;\n\tcase 6: guemr = &qe_immr->ucc7.slow.guemr;\n\t\tbreak;\n\tcase 7: guemr = &qe_immr->ucc8.slow.guemr;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tqe_clrsetbits_8(guemr, UCC_GUEMR_MODE_MASK,\n\t\t\tUCC_GUEMR_SET_RESERVED3 | speed);\n\n\treturn 0;\n}\n\nstatic void get_cmxucr_reg(unsigned int ucc_num, __be32 __iomem **cmxucr,\n\tunsigned int *reg_num, unsigned int *shift)\n{\n\tunsigned int cmx = ((ucc_num & 1) << 1) + (ucc_num > 3);\n\n\t*reg_num = cmx + 1;\n\t*cmxucr = &qe_immr->qmx.cmxucr[cmx];\n\t*shift = 16 - 8 * (ucc_num & 2);\n}\n\nint ucc_mux_set_grant_tsa_bkpt(unsigned int ucc_num, int set, u32 mask)\n{\n\t__be32 __iomem *cmxucr;\n\tunsigned int reg_num;\n\tunsigned int shift;\n\n\t \n\tif (ucc_num > UCC_MAX_NUM - 1)\n\t\treturn -EINVAL;\n\n\tget_cmxucr_reg(ucc_num, &cmxucr, &reg_num, &shift);\n\n\tif (set)\n\t\tqe_setbits_be32(cmxucr, mask << shift);\n\telse\n\t\tqe_clrbits_be32(cmxucr, mask << shift);\n\n\treturn 0;\n}\n\nint ucc_set_qe_mux_rxtx(unsigned int ucc_num, enum qe_clock clock,\n\tenum comm_dir mode)\n{\n\t__be32 __iomem *cmxucr;\n\tunsigned int reg_num;\n\tunsigned int shift;\n\tu32 clock_bits = 0;\n\n\t \n\tif (ucc_num > UCC_MAX_NUM - 1)\n\t\treturn -EINVAL;\n\n\t \n\tif (!((mode == COMM_DIR_RX) || (mode == COMM_DIR_TX)))\n\t\treturn -EINVAL;\n\n\tget_cmxucr_reg(ucc_num, &cmxucr, &reg_num, &shift);\n\n\tswitch (reg_num) {\n\tcase 1:\n\t\tswitch (clock) {\n\t\tcase QE_BRG1:\tclock_bits = 1; break;\n\t\tcase QE_BRG2:\tclock_bits = 2; break;\n\t\tcase QE_BRG7:\tclock_bits = 3; break;\n\t\tcase QE_BRG8:\tclock_bits = 4; break;\n\t\tcase QE_CLK9:\tclock_bits = 5; break;\n\t\tcase QE_CLK10:\tclock_bits = 6; break;\n\t\tcase QE_CLK11:\tclock_bits = 7; break;\n\t\tcase QE_CLK12:\tclock_bits = 8; break;\n\t\tcase QE_CLK15:\tclock_bits = 9; break;\n\t\tcase QE_CLK16:\tclock_bits = 10; break;\n\t\tdefault: break;\n\t\t}\n\t\tbreak;\n\tcase 2:\n\t\tswitch (clock) {\n\t\tcase QE_BRG5:\tclock_bits = 1; break;\n\t\tcase QE_BRG6:\tclock_bits = 2; break;\n\t\tcase QE_BRG7:\tclock_bits = 3; break;\n\t\tcase QE_BRG8:\tclock_bits = 4; break;\n\t\tcase QE_CLK13:\tclock_bits = 5; break;\n\t\tcase QE_CLK14:\tclock_bits = 6; break;\n\t\tcase QE_CLK19:\tclock_bits = 7; break;\n\t\tcase QE_CLK20:\tclock_bits = 8; break;\n\t\tcase QE_CLK15:\tclock_bits = 9; break;\n\t\tcase QE_CLK16:\tclock_bits = 10; break;\n\t\tdefault: break;\n\t\t}\n\t\tbreak;\n\tcase 3:\n\t\tswitch (clock) {\n\t\tcase QE_BRG9:\tclock_bits = 1; break;\n\t\tcase QE_BRG10:\tclock_bits = 2; break;\n\t\tcase QE_BRG15:\tclock_bits = 3; break;\n\t\tcase QE_BRG16:\tclock_bits = 4; break;\n\t\tcase QE_CLK3:\tclock_bits = 5; break;\n\t\tcase QE_CLK4:\tclock_bits = 6; break;\n\t\tcase QE_CLK17:\tclock_bits = 7; break;\n\t\tcase QE_CLK18:\tclock_bits = 8; break;\n\t\tcase QE_CLK7:\tclock_bits = 9; break;\n\t\tcase QE_CLK8:\tclock_bits = 10; break;\n\t\tcase QE_CLK16:\tclock_bits = 11; break;\n\t\tdefault: break;\n\t\t}\n\t\tbreak;\n\tcase 4:\n\t\tswitch (clock) {\n\t\tcase QE_BRG13:\tclock_bits = 1; break;\n\t\tcase QE_BRG14:\tclock_bits = 2; break;\n\t\tcase QE_BRG15:\tclock_bits = 3; break;\n\t\tcase QE_BRG16:\tclock_bits = 4; break;\n\t\tcase QE_CLK5:\tclock_bits = 5; break;\n\t\tcase QE_CLK6:\tclock_bits = 6; break;\n\t\tcase QE_CLK21:\tclock_bits = 7; break;\n\t\tcase QE_CLK22:\tclock_bits = 8; break;\n\t\tcase QE_CLK7:\tclock_bits = 9; break;\n\t\tcase QE_CLK8:\tclock_bits = 10; break;\n\t\tcase QE_CLK16:\tclock_bits = 11; break;\n\t\tdefault: break;\n\t\t}\n\t\tbreak;\n\tdefault: break;\n\t}\n\n\t \n\tif (!clock_bits)\n\t\treturn -ENOENT;\n\n\tif (mode == COMM_DIR_RX)\n\t\tshift += 4;\n\n\tqe_clrsetbits_be32(cmxucr, QE_CMXUCR_TX_CLK_SRC_MASK << shift,\n\t\t\t   clock_bits << shift);\n\n\treturn 0;\n}\n\nstatic int ucc_get_tdm_common_clk(u32 tdm_num, enum qe_clock clock)\n{\n\tint clock_bits = -EINVAL;\n\n\t \n\tswitch (tdm_num) {\n\tcase 0:\n\tcase 1:\n\tcase 2:\n\tcase 3:\n\t\tswitch (clock) {\n\t\tcase QE_BRG3:\n\t\t\tclock_bits = 1;\n\t\t\tbreak;\n\t\tcase QE_BRG4:\n\t\t\tclock_bits = 2;\n\t\t\tbreak;\n\t\tcase QE_CLK1:\n\t\t\tclock_bits = 4;\n\t\t\tbreak;\n\t\tcase QE_CLK2:\n\t\t\tclock_bits = 5;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 4:\n\tcase 5:\n\tcase 6:\n\tcase 7:\n\t\tswitch (clock) {\n\t\tcase QE_BRG12:\n\t\t\tclock_bits = 1;\n\t\t\tbreak;\n\t\tcase QE_BRG13:\n\t\t\tclock_bits = 2;\n\t\t\tbreak;\n\t\tcase QE_CLK23:\n\t\t\tclock_bits = 4;\n\t\t\tbreak;\n\t\tcase QE_CLK24:\n\t\t\tclock_bits = 5;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn clock_bits;\n}\n\nstatic int ucc_get_tdm_rx_clk(u32 tdm_num, enum qe_clock clock)\n{\n\tint clock_bits = -EINVAL;\n\n\tswitch (tdm_num) {\n\tcase 0:\n\t\tswitch (clock) {\n\t\tcase QE_CLK3:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK8:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 1:\n\t\tswitch (clock) {\n\t\tcase QE_CLK5:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK10:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 2:\n\t\tswitch (clock) {\n\t\tcase QE_CLK7:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK12:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 3:\n\t\tswitch (clock) {\n\t\tcase QE_CLK9:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK14:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 4:\n\t\tswitch (clock) {\n\t\tcase QE_CLK11:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK16:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 5:\n\t\tswitch (clock) {\n\t\tcase QE_CLK13:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK18:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 6:\n\t\tswitch (clock) {\n\t\tcase QE_CLK15:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK20:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 7:\n\t\tswitch (clock) {\n\t\tcase QE_CLK17:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK22:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\t}\n\n\treturn clock_bits;\n}\n\nstatic int ucc_get_tdm_tx_clk(u32 tdm_num, enum qe_clock clock)\n{\n\tint clock_bits = -EINVAL;\n\n\tswitch (tdm_num) {\n\tcase 0:\n\t\tswitch (clock) {\n\t\tcase QE_CLK4:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK9:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 1:\n\t\tswitch (clock) {\n\t\tcase QE_CLK6:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK11:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 2:\n\t\tswitch (clock) {\n\t\tcase QE_CLK8:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK13:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 3:\n\t\tswitch (clock) {\n\t\tcase QE_CLK10:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK15:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 4:\n\t\tswitch (clock) {\n\t\tcase QE_CLK12:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK17:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 5:\n\t\tswitch (clock) {\n\t\tcase QE_CLK14:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK19:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 6:\n\t\tswitch (clock) {\n\t\tcase QE_CLK16:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK21:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 7:\n\t\tswitch (clock) {\n\t\tcase QE_CLK18:\n\t\t\tclock_bits = 6;\n\t\t\tbreak;\n\t\tcase QE_CLK3:\n\t\t\tclock_bits = 7;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\t}\n\n\treturn clock_bits;\n}\n\n \nstatic int ucc_get_tdm_rxtx_clk(enum comm_dir mode, u32 tdm_num,\n\t\t\t\tenum qe_clock clock)\n{\n\tint clock_bits;\n\n\tclock_bits = ucc_get_tdm_common_clk(tdm_num, clock);\n\tif (clock_bits > 0)\n\t\treturn clock_bits;\n\tif (mode == COMM_DIR_RX)\n\t\tclock_bits = ucc_get_tdm_rx_clk(tdm_num, clock);\n\tif (mode == COMM_DIR_TX)\n\t\tclock_bits = ucc_get_tdm_tx_clk(tdm_num, clock);\n\treturn clock_bits;\n}\n\nstatic u32 ucc_get_tdm_clk_shift(enum comm_dir mode, u32 tdm_num)\n{\n\tu32 shift;\n\n\tshift = (mode == COMM_DIR_RX) ? RX_CLK_SHIFT_BASE : TX_CLK_SHIFT_BASE;\n\tif (tdm_num < 4)\n\t\tshift -= tdm_num * 4;\n\telse\n\t\tshift -= (tdm_num - 4) * 4;\n\n\treturn shift;\n}\n\nint ucc_set_tdm_rxtx_clk(u32 tdm_num, enum qe_clock clock,\n\t\t\t enum comm_dir mode)\n{\n\tint clock_bits;\n\tu32 shift;\n\tstruct qe_mux __iomem *qe_mux_reg;\n\t__be32 __iomem *cmxs1cr;\n\n\tqe_mux_reg = &qe_immr->qmx;\n\n\tif (tdm_num > 7)\n\t\treturn -EINVAL;\n\n\t \n\tif (mode != COMM_DIR_RX && mode != COMM_DIR_TX)\n\t\treturn -EINVAL;\n\n\tclock_bits = ucc_get_tdm_rxtx_clk(mode, tdm_num, clock);\n\tif (clock_bits < 0)\n\t\treturn -EINVAL;\n\n\tshift = ucc_get_tdm_clk_shift(mode, tdm_num);\n\n\tcmxs1cr = (tdm_num < 4) ? &qe_mux_reg->cmxsi1cr_l :\n\t\t\t\t  &qe_mux_reg->cmxsi1cr_h;\n\n\tqe_clrsetbits_be32(cmxs1cr, QE_CMXUCR_TX_CLK_SRC_MASK << shift,\n\t\t\t   clock_bits << shift);\n\n\treturn 0;\n}\n\nstatic int ucc_get_tdm_sync_source(u32 tdm_num, enum qe_clock clock,\n\t\t\t\t   enum comm_dir mode)\n{\n\tint source = -EINVAL;\n\n\tif (mode == COMM_DIR_RX && clock == QE_RSYNC_PIN) {\n\t\tsource = 0;\n\t\treturn source;\n\t}\n\tif (mode == COMM_DIR_TX && clock == QE_TSYNC_PIN) {\n\t\tsource = 0;\n\t\treturn source;\n\t}\n\n\tswitch (tdm_num) {\n\tcase 0:\n\tcase 1:\n\t\tswitch (clock) {\n\t\tcase QE_BRG9:\n\t\t\tsource = 1;\n\t\t\tbreak;\n\t\tcase QE_BRG10:\n\t\t\tsource = 2;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 2:\n\tcase 3:\n\t\tswitch (clock) {\n\t\tcase QE_BRG9:\n\t\t\tsource = 1;\n\t\t\tbreak;\n\t\tcase QE_BRG11:\n\t\t\tsource = 2;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 4:\n\tcase 5:\n\t\tswitch (clock) {\n\t\tcase QE_BRG13:\n\t\t\tsource = 1;\n\t\t\tbreak;\n\t\tcase QE_BRG14:\n\t\t\tsource = 2;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 6:\n\tcase 7:\n\t\tswitch (clock) {\n\t\tcase QE_BRG13:\n\t\t\tsource = 1;\n\t\t\tbreak;\n\t\tcase QE_BRG15:\n\t\t\tsource = 2;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\t}\n\n\treturn source;\n}\n\nstatic u32 ucc_get_tdm_sync_shift(enum comm_dir mode, u32 tdm_num)\n{\n\tu32 shift;\n\n\tshift = (mode == COMM_DIR_RX) ? RX_SYNC_SHIFT_BASE : TX_SYNC_SHIFT_BASE;\n\tshift -= tdm_num * 2;\n\n\treturn shift;\n}\n\nint ucc_set_tdm_rxtx_sync(u32 tdm_num, enum qe_clock clock,\n\t\t\t  enum comm_dir mode)\n{\n\tint source;\n\tu32 shift;\n\tstruct qe_mux __iomem *qe_mux_reg;\n\n\tqe_mux_reg = &qe_immr->qmx;\n\n\tif (tdm_num >= UCC_TDM_NUM)\n\t\treturn -EINVAL;\n\n\t \n\tif (mode != COMM_DIR_RX && mode != COMM_DIR_TX)\n\t\treturn -EINVAL;\n\n\tsource = ucc_get_tdm_sync_source(tdm_num, clock, mode);\n\tif (source < 0)\n\t\treturn -EINVAL;\n\n\tshift = ucc_get_tdm_sync_shift(mode, tdm_num);\n\n\tqe_clrsetbits_be32(&qe_mux_reg->cmxsi1syr,\n\t\t\t   QE_CMXUCR_TX_CLK_SRC_MASK << shift,\n\t\t\t   source << shift);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}