{
  "module_name": "regulators-tegra20.c",
  "hash_id": "808c56bcd8456dbf76283864815bc2911886d002ac760e35f39d1363f600dc0f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/tegra/regulators-tegra20.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt)\t\"tegra voltage-coupler: \" fmt\n\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/reboot.h>\n#include <linux/regulator/coupler.h>\n#include <linux/regulator/driver.h>\n#include <linux/regulator/machine.h>\n#include <linux/suspend.h>\n\n#include <soc/tegra/fuse.h>\n#include <soc/tegra/pmc.h>\n\nstruct tegra_regulator_coupler {\n\tstruct regulator_coupler coupler;\n\tstruct regulator_dev *core_rdev;\n\tstruct regulator_dev *cpu_rdev;\n\tstruct regulator_dev *rtc_rdev;\n\tstruct notifier_block reboot_notifier;\n\tstruct notifier_block suspend_notifier;\n\tint core_min_uV, cpu_min_uV;\n\tbool sys_reboot_mode_req;\n\tbool sys_reboot_mode;\n\tbool sys_suspend_mode_req;\n\tbool sys_suspend_mode;\n};\n\nstatic inline struct tegra_regulator_coupler *\nto_tegra_coupler(struct regulator_coupler *coupler)\n{\n\treturn container_of(coupler, struct tegra_regulator_coupler, coupler);\n}\n\nstatic int tegra20_core_limit(struct tegra_regulator_coupler *tegra,\n\t\t\t      struct regulator_dev *core_rdev)\n{\n\tint core_min_uV = 0;\n\tint core_max_uV;\n\tint core_cur_uV;\n\tint err;\n\n\t \n\tif (tegra_pmc_core_domain_state_synced() && !tegra->sys_reboot_mode) {\n\t\tpr_info_once(\"voltage state synced\\n\");\n\t\treturn 0;\n\t}\n\n\tif (tegra->core_min_uV > 0)\n\t\treturn tegra->core_min_uV;\n\n\tcore_cur_uV = regulator_get_voltage_rdev(core_rdev);\n\tif (core_cur_uV < 0)\n\t\treturn core_cur_uV;\n\n\tcore_max_uV = max(core_cur_uV, 1200000);\n\n\terr = regulator_check_voltage(core_rdev, &core_min_uV, &core_max_uV);\n\tif (err)\n\t\treturn err;\n\n\t \n\ttegra->core_min_uV = core_max_uV;\n\n\tpr_info(\"core voltage initialized to %duV\\n\", tegra->core_min_uV);\n\n\treturn tegra->core_min_uV;\n}\n\nstatic int tegra20_core_rtc_max_spread(struct regulator_dev *core_rdev,\n\t\t\t\t       struct regulator_dev *rtc_rdev)\n{\n\tstruct coupling_desc *c_desc = &core_rdev->coupling_desc;\n\tstruct regulator_dev *rdev;\n\tint max_spread;\n\tunsigned int i;\n\n\tfor (i = 1; i < c_desc->n_coupled; i++) {\n\t\tmax_spread = core_rdev->constraints->max_spread[i - 1];\n\t\trdev = c_desc->coupled_rdevs[i];\n\n\t\tif (rdev == rtc_rdev && max_spread)\n\t\t\treturn max_spread;\n\t}\n\n\tpr_err_once(\"rtc-core max-spread is undefined in device-tree\\n\");\n\n\treturn 150000;\n}\n\nstatic int tegra20_cpu_nominal_uV(void)\n{\n\tswitch (tegra_sku_info.soc_speedo_id) {\n\tcase 0:\n\t\treturn 1100000;\n\tcase 1:\n\t\treturn 1025000;\n\tdefault:\n\t\treturn 1125000;\n\t}\n}\n\nstatic int tegra20_core_nominal_uV(void)\n{\n\tswitch (tegra_sku_info.soc_speedo_id) {\n\tdefault:\n\t\treturn 1225000;\n\tcase 2:\n\t\treturn 1300000;\n\t}\n}\n\nstatic int tegra20_core_rtc_update(struct tegra_regulator_coupler *tegra,\n\t\t\t\t   struct regulator_dev *core_rdev,\n\t\t\t\t   struct regulator_dev *rtc_rdev,\n\t\t\t\t   int cpu_uV, int cpu_min_uV)\n{\n\tint core_min_uV, core_max_uV = INT_MAX;\n\tint rtc_min_uV, rtc_max_uV = INT_MAX;\n\tint core_target_uV;\n\tint rtc_target_uV;\n\tint max_spread;\n\tint core_uV;\n\tint rtc_uV;\n\tint err;\n\n\t \n\tmax_spread = tegra20_core_rtc_max_spread(core_rdev, rtc_rdev);\n\n\t \n\tcore_min_uV = tegra20_core_limit(tegra, core_rdev);\n\tif (core_min_uV < 0)\n\t\treturn core_min_uV;\n\n\terr = regulator_check_voltage(core_rdev, &core_min_uV, &core_max_uV);\n\tif (err)\n\t\treturn err;\n\n\terr = regulator_check_consumers(core_rdev, &core_min_uV, &core_max_uV,\n\t\t\t\t\tPM_SUSPEND_ON);\n\tif (err)\n\t\treturn err;\n\n\t \n\tif (tegra->sys_suspend_mode)\n\t\tcore_min_uV = clamp(tegra20_core_nominal_uV(),\n\t\t\t\t    core_min_uV, core_max_uV);\n\n\tcore_uV = regulator_get_voltage_rdev(core_rdev);\n\tif (core_uV < 0)\n\t\treturn core_uV;\n\n\tcore_min_uV = max(cpu_min_uV + 125000, core_min_uV);\n\tif (core_min_uV > core_max_uV)\n\t\treturn -EINVAL;\n\n\tif (cpu_uV + 120000 > core_uV)\n\t\tpr_err(\"core-cpu voltage constraint violated: %d %d\\n\",\n\t\t       core_uV, cpu_uV + 120000);\n\n\trtc_uV = regulator_get_voltage_rdev(rtc_rdev);\n\tif (rtc_uV < 0)\n\t\treturn rtc_uV;\n\n\tif (cpu_uV + 120000 > rtc_uV)\n\t\tpr_err(\"rtc-cpu voltage constraint violated: %d %d\\n\",\n\t\t       rtc_uV, cpu_uV + 120000);\n\n\tif (abs(core_uV - rtc_uV) > 170000)\n\t\tpr_err(\"core-rtc voltage constraint violated: %d %d\\n\",\n\t\t       core_uV, rtc_uV);\n\n\trtc_min_uV = max(cpu_min_uV + 125000, core_min_uV - max_spread);\n\n\terr = regulator_check_voltage(rtc_rdev, &rtc_min_uV, &rtc_max_uV);\n\tif (err)\n\t\treturn err;\n\n\twhile (core_uV != core_min_uV || rtc_uV != rtc_min_uV) {\n\t\tif (core_uV < core_min_uV) {\n\t\t\tcore_target_uV = min(core_uV + max_spread, core_min_uV);\n\t\t\tcore_target_uV = min(rtc_uV + max_spread, core_target_uV);\n\t\t} else {\n\t\t\tcore_target_uV = max(core_uV - max_spread, core_min_uV);\n\t\t\tcore_target_uV = max(rtc_uV - max_spread, core_target_uV);\n\t\t}\n\n\t\tif (core_uV == core_target_uV)\n\t\t\tgoto update_rtc;\n\n\t\terr = regulator_set_voltage_rdev(core_rdev,\n\t\t\t\t\t\t core_target_uV,\n\t\t\t\t\t\t core_max_uV,\n\t\t\t\t\t\t PM_SUSPEND_ON);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tcore_uV = core_target_uV;\nupdate_rtc:\n\t\tif (rtc_uV < rtc_min_uV) {\n\t\t\trtc_target_uV = min(rtc_uV + max_spread, rtc_min_uV);\n\t\t\trtc_target_uV = min(core_uV + max_spread, rtc_target_uV);\n\t\t} else {\n\t\t\trtc_target_uV = max(rtc_uV - max_spread, rtc_min_uV);\n\t\t\trtc_target_uV = max(core_uV - max_spread, rtc_target_uV);\n\t\t}\n\n\t\tif (rtc_uV == rtc_target_uV)\n\t\t\tcontinue;\n\n\t\terr = regulator_set_voltage_rdev(rtc_rdev,\n\t\t\t\t\t\t rtc_target_uV,\n\t\t\t\t\t\t rtc_max_uV,\n\t\t\t\t\t\t PM_SUSPEND_ON);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\trtc_uV = rtc_target_uV;\n\t}\n\n\treturn 0;\n}\n\nstatic int tegra20_core_voltage_update(struct tegra_regulator_coupler *tegra,\n\t\t\t\t       struct regulator_dev *cpu_rdev,\n\t\t\t\t       struct regulator_dev *core_rdev,\n\t\t\t\t       struct regulator_dev *rtc_rdev)\n{\n\tint cpu_uV;\n\n\tcpu_uV = regulator_get_voltage_rdev(cpu_rdev);\n\tif (cpu_uV < 0)\n\t\treturn cpu_uV;\n\n\treturn tegra20_core_rtc_update(tegra, core_rdev, rtc_rdev,\n\t\t\t\t       cpu_uV, cpu_uV);\n}\n\nstatic int tegra20_cpu_voltage_update(struct tegra_regulator_coupler *tegra,\n\t\t\t\t      struct regulator_dev *cpu_rdev,\n\t\t\t\t      struct regulator_dev *core_rdev,\n\t\t\t\t      struct regulator_dev *rtc_rdev)\n{\n\tint cpu_min_uV_consumers = 0;\n\tint cpu_max_uV = INT_MAX;\n\tint cpu_min_uV = 0;\n\tint cpu_uV;\n\tint err;\n\n\terr = regulator_check_voltage(cpu_rdev, &cpu_min_uV, &cpu_max_uV);\n\tif (err)\n\t\treturn err;\n\n\terr = regulator_check_consumers(cpu_rdev, &cpu_min_uV, &cpu_max_uV,\n\t\t\t\t\tPM_SUSPEND_ON);\n\tif (err)\n\t\treturn err;\n\n\terr = regulator_check_consumers(cpu_rdev, &cpu_min_uV_consumers,\n\t\t\t\t\t&cpu_max_uV, PM_SUSPEND_ON);\n\tif (err)\n\t\treturn err;\n\n\tcpu_uV = regulator_get_voltage_rdev(cpu_rdev);\n\tif (cpu_uV < 0)\n\t\treturn cpu_uV;\n\n\t \n\tif (!tegra->cpu_min_uV)\n\t\ttegra->cpu_min_uV = cpu_uV;\n\n\t \n\tif (!cpu_min_uV_consumers)\n\t\tcpu_min_uV = cpu_uV;\n\n\t \n\tif (tegra->sys_reboot_mode)\n\t\tcpu_min_uV = max(cpu_min_uV, tegra->cpu_min_uV);\n\n\t \n\tif (tegra->sys_suspend_mode)\n\t\tcpu_min_uV = clamp(tegra20_cpu_nominal_uV(),\n\t\t\t\t   cpu_min_uV, cpu_max_uV);\n\n\tif (cpu_min_uV > cpu_uV) {\n\t\terr = tegra20_core_rtc_update(tegra, core_rdev, rtc_rdev,\n\t\t\t\t\t      cpu_uV, cpu_min_uV);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = regulator_set_voltage_rdev(cpu_rdev, cpu_min_uV,\n\t\t\t\t\t\t cpu_max_uV, PM_SUSPEND_ON);\n\t\tif (err)\n\t\t\treturn err;\n\t} else if (cpu_min_uV < cpu_uV)  {\n\t\terr = regulator_set_voltage_rdev(cpu_rdev, cpu_min_uV,\n\t\t\t\t\t\t cpu_max_uV, PM_SUSPEND_ON);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = tegra20_core_rtc_update(tegra, core_rdev, rtc_rdev,\n\t\t\t\t\t      cpu_uV, cpu_min_uV);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int tegra20_regulator_balance_voltage(struct regulator_coupler *coupler,\n\t\t\t\t\t     struct regulator_dev *rdev,\n\t\t\t\t\t     suspend_state_t state)\n{\n\tstruct tegra_regulator_coupler *tegra = to_tegra_coupler(coupler);\n\tstruct regulator_dev *core_rdev = tegra->core_rdev;\n\tstruct regulator_dev *cpu_rdev = tegra->cpu_rdev;\n\tstruct regulator_dev *rtc_rdev = tegra->rtc_rdev;\n\n\tif ((core_rdev != rdev && cpu_rdev != rdev && rtc_rdev != rdev) ||\n\t    state != PM_SUSPEND_ON) {\n\t\tpr_err(\"regulators are not coupled properly\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\ttegra->sys_reboot_mode = READ_ONCE(tegra->sys_reboot_mode_req);\n\ttegra->sys_suspend_mode = READ_ONCE(tegra->sys_suspend_mode_req);\n\n\tif (rdev == cpu_rdev)\n\t\treturn tegra20_cpu_voltage_update(tegra, cpu_rdev,\n\t\t\t\t\t\t  core_rdev, rtc_rdev);\n\n\tif (rdev == core_rdev)\n\t\treturn tegra20_core_voltage_update(tegra, cpu_rdev,\n\t\t\t\t\t\t   core_rdev, rtc_rdev);\n\n\tpr_err(\"changing %s voltage not permitted\\n\", rdev_get_name(rtc_rdev));\n\n\treturn -EPERM;\n}\n\nstatic int tegra20_regulator_prepare_suspend(struct tegra_regulator_coupler *tegra,\n\t\t\t\t\t     bool sys_suspend_mode)\n{\n\tint err;\n\n\tif (!tegra->core_rdev || !tegra->rtc_rdev || !tegra->cpu_rdev)\n\t\treturn 0;\n\n\t \n\n\tWRITE_ONCE(tegra->sys_suspend_mode_req, sys_suspend_mode);\n\n\terr = regulator_sync_voltage_rdev(tegra->cpu_rdev);\n\tif (err)\n\t\treturn err;\n\n\terr = regulator_sync_voltage_rdev(tegra->core_rdev);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic int tegra20_regulator_suspend(struct notifier_block *notifier,\n\t\t\t\t     unsigned long mode, void *arg)\n{\n\tstruct tegra_regulator_coupler *tegra;\n\tint ret = 0;\n\n\ttegra = container_of(notifier, struct tegra_regulator_coupler,\n\t\t\t     suspend_notifier);\n\n\tswitch (mode) {\n\tcase PM_HIBERNATION_PREPARE:\n\tcase PM_RESTORE_PREPARE:\n\tcase PM_SUSPEND_PREPARE:\n\t\tret = tegra20_regulator_prepare_suspend(tegra, true);\n\t\tbreak;\n\n\tcase PM_POST_HIBERNATION:\n\tcase PM_POST_RESTORE:\n\tcase PM_POST_SUSPEND:\n\t\tret = tegra20_regulator_prepare_suspend(tegra, false);\n\t\tbreak;\n\t}\n\n\tif (ret)\n\t\tpr_err(\"failed to prepare regulators: %d\\n\", ret);\n\n\treturn notifier_from_errno(ret);\n}\n\nstatic int tegra20_regulator_prepare_reboot(struct tegra_regulator_coupler *tegra,\n\t\t\t\t\t    bool sys_reboot_mode)\n{\n\tint err;\n\n\tif (!tegra->core_rdev || !tegra->rtc_rdev || !tegra->cpu_rdev)\n\t\treturn 0;\n\n\tWRITE_ONCE(tegra->sys_reboot_mode_req, true);\n\n\t \n\terr = regulator_sync_voltage_rdev(tegra->cpu_rdev);\n\tif (err)\n\t\treturn err;\n\n\terr = regulator_sync_voltage_rdev(tegra->core_rdev);\n\tif (err)\n\t\treturn err;\n\n\tWRITE_ONCE(tegra->sys_reboot_mode_req, sys_reboot_mode);\n\n\treturn 0;\n}\n\nstatic int tegra20_regulator_reboot(struct notifier_block *notifier,\n\t\t\t\t    unsigned long event, void *cmd)\n{\n\tstruct tegra_regulator_coupler *tegra;\n\tint ret;\n\n\tif (event != SYS_RESTART)\n\t\treturn NOTIFY_DONE;\n\n\ttegra = container_of(notifier, struct tegra_regulator_coupler,\n\t\t\t     reboot_notifier);\n\n\tret = tegra20_regulator_prepare_reboot(tegra, true);\n\n\treturn notifier_from_errno(ret);\n}\n\nstatic int tegra20_regulator_attach(struct regulator_coupler *coupler,\n\t\t\t\t    struct regulator_dev *rdev)\n{\n\tstruct tegra_regulator_coupler *tegra = to_tegra_coupler(coupler);\n\tstruct device_node *np = rdev->dev.of_node;\n\n\tif (of_property_read_bool(np, \"nvidia,tegra-core-regulator\") &&\n\t    !tegra->core_rdev) {\n\t\ttegra->core_rdev = rdev;\n\t\treturn 0;\n\t}\n\n\tif (of_property_read_bool(np, \"nvidia,tegra-rtc-regulator\") &&\n\t    !tegra->rtc_rdev) {\n\t\ttegra->rtc_rdev = rdev;\n\t\treturn 0;\n\t}\n\n\tif (of_property_read_bool(np, \"nvidia,tegra-cpu-regulator\") &&\n\t    !tegra->cpu_rdev) {\n\t\ttegra->cpu_rdev = rdev;\n\t\treturn 0;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int tegra20_regulator_detach(struct regulator_coupler *coupler,\n\t\t\t\t    struct regulator_dev *rdev)\n{\n\tstruct tegra_regulator_coupler *tegra = to_tegra_coupler(coupler);\n\n\t \n\tif (WARN_ON_ONCE(system_state > SYSTEM_RUNNING))\n\t\treturn -EPERM;\n\n\tif (tegra->core_rdev == rdev) {\n\t\ttegra->core_rdev = NULL;\n\t\treturn 0;\n\t}\n\n\tif (tegra->rtc_rdev == rdev) {\n\t\ttegra->rtc_rdev = NULL;\n\t\treturn 0;\n\t}\n\n\tif (tegra->cpu_rdev == rdev) {\n\t\ttegra->cpu_rdev = NULL;\n\t\treturn 0;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic struct tegra_regulator_coupler tegra20_coupler = {\n\t.coupler = {\n\t\t.attach_regulator = tegra20_regulator_attach,\n\t\t.detach_regulator = tegra20_regulator_detach,\n\t\t.balance_voltage = tegra20_regulator_balance_voltage,\n\t},\n\t.reboot_notifier.notifier_call = tegra20_regulator_reboot,\n\t.suspend_notifier.notifier_call = tegra20_regulator_suspend,\n};\n\nstatic int __init tegra_regulator_coupler_init(void)\n{\n\tint err;\n\n\tif (!of_machine_is_compatible(\"nvidia,tegra20\"))\n\t\treturn 0;\n\n\terr = register_reboot_notifier(&tegra20_coupler.reboot_notifier);\n\tWARN_ON(err);\n\n\terr = register_pm_notifier(&tegra20_coupler.suspend_notifier);\n\tWARN_ON(err);\n\n\treturn regulator_coupler_register(&tegra20_coupler.coupler);\n}\narch_initcall(tegra_regulator_coupler_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}