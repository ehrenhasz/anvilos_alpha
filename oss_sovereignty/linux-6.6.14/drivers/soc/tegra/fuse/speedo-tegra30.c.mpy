{
  "module_name": "speedo-tegra30.c",
  "hash_id": "94c0b46c1b0594ae9cf131166968ed2aa4cabfcc1cc861246abdf7eb09705306",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/tegra/fuse/speedo-tegra30.c",
  "human_readable_source": "\n \n\n#include <linux/bug.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n\n#include <soc/tegra/fuse.h>\n\n#include \"fuse.h\"\n\n#define SOC_PROCESS_CORNERS\t1\n#define CPU_PROCESS_CORNERS\t6\n\n#define FUSE_SPEEDO_CALIB_0\t0x14\n#define FUSE_PACKAGE_INFO\t0XFC\n#define FUSE_TEST_PROG_VER\t0X28\n\n#define G_SPEEDO_BIT_MINUS1\t58\n#define G_SPEEDO_BIT_MINUS1_R\t59\n#define G_SPEEDO_BIT_MINUS2\t60\n#define G_SPEEDO_BIT_MINUS2_R\t61\n#define LP_SPEEDO_BIT_MINUS1\t62\n#define LP_SPEEDO_BIT_MINUS1_R\t63\n#define LP_SPEEDO_BIT_MINUS2\t64\n#define LP_SPEEDO_BIT_MINUS2_R\t65\n\nenum {\n\tTHRESHOLD_INDEX_0,\n\tTHRESHOLD_INDEX_1,\n\tTHRESHOLD_INDEX_2,\n\tTHRESHOLD_INDEX_3,\n\tTHRESHOLD_INDEX_4,\n\tTHRESHOLD_INDEX_5,\n\tTHRESHOLD_INDEX_6,\n\tTHRESHOLD_INDEX_7,\n\tTHRESHOLD_INDEX_8,\n\tTHRESHOLD_INDEX_9,\n\tTHRESHOLD_INDEX_10,\n\tTHRESHOLD_INDEX_11,\n\tTHRESHOLD_INDEX_COUNT,\n};\n\nstatic const u32 __initconst soc_process_speedos[][SOC_PROCESS_CORNERS] = {\n\t{180},\n\t{170},\n\t{195},\n\t{180},\n\t{168},\n\t{192},\n\t{180},\n\t{170},\n\t{195},\n\t{180},\n\t{180},\n\t{180},\n};\n\nstatic const u32 __initconst cpu_process_speedos[][CPU_PROCESS_CORNERS] = {\n\t{306, 338, 360, 376, UINT_MAX},\n\t{295, 336, 358, 375, UINT_MAX},\n\t{325, 325, 358, 375, UINT_MAX},\n\t{325, 325, 358, 375, UINT_MAX},\n\t{292, 324, 348, 364, UINT_MAX},\n\t{324, 324, 348, 364, UINT_MAX},\n\t{324, 324, 348, 364, UINT_MAX},\n\t{295, 336, 358, 375, UINT_MAX},\n\t{358, 358, 358, 358, 397, UINT_MAX},\n\t{364, 364, 364, 364, 397, UINT_MAX},\n\t{295, 336, 358, 375, 391, UINT_MAX},\n\t{295, 336, 358, 375, 391, UINT_MAX},\n};\n\nstatic int threshold_index __initdata;\n\nstatic void __init fuse_speedo_calib(u32 *speedo_g, u32 *speedo_lp)\n{\n\tu32 reg;\n\tint ate_ver;\n\tint bit_minus1;\n\tint bit_minus2;\n\n\treg = tegra_fuse_read_early(FUSE_SPEEDO_CALIB_0);\n\n\t*speedo_lp = (reg & 0xFFFF) * 4;\n\t*speedo_g = ((reg >> 16) & 0xFFFF) * 4;\n\n\tate_ver = tegra_fuse_read_early(FUSE_TEST_PROG_VER);\n\tpr_debug(\"Tegra ATE prog ver %d.%d\\n\", ate_ver/10, ate_ver%10);\n\n\tif (ate_ver >= 26) {\n\t\tbit_minus1 = tegra_fuse_read_spare(LP_SPEEDO_BIT_MINUS1);\n\t\tbit_minus1 |= tegra_fuse_read_spare(LP_SPEEDO_BIT_MINUS1_R);\n\t\tbit_minus2 = tegra_fuse_read_spare(LP_SPEEDO_BIT_MINUS2);\n\t\tbit_minus2 |= tegra_fuse_read_spare(LP_SPEEDO_BIT_MINUS2_R);\n\t\t*speedo_lp |= (bit_minus1 << 1) | bit_minus2;\n\n\t\tbit_minus1 = tegra_fuse_read_spare(G_SPEEDO_BIT_MINUS1);\n\t\tbit_minus1 |= tegra_fuse_read_spare(G_SPEEDO_BIT_MINUS1_R);\n\t\tbit_minus2 = tegra_fuse_read_spare(G_SPEEDO_BIT_MINUS2);\n\t\tbit_minus2 |= tegra_fuse_read_spare(G_SPEEDO_BIT_MINUS2_R);\n\t\t*speedo_g |= (bit_minus1 << 1) | bit_minus2;\n\t} else {\n\t\t*speedo_lp |= 0x3;\n\t\t*speedo_g |= 0x3;\n\t}\n}\n\nstatic void __init rev_sku_to_speedo_ids(struct tegra_sku_info *sku_info)\n{\n\tint package_id = tegra_fuse_read_early(FUSE_PACKAGE_INFO) & 0x0F;\n\n\tswitch (sku_info->revision) {\n\tcase TEGRA_REVISION_A01:\n\t\tsku_info->cpu_speedo_id = 0;\n\t\tsku_info->soc_speedo_id = 0;\n\t\tthreshold_index = THRESHOLD_INDEX_0;\n\t\tbreak;\n\tcase TEGRA_REVISION_A02:\n\tcase TEGRA_REVISION_A03:\n\t\tswitch (sku_info->sku_id) {\n\t\tcase 0x87:\n\t\tcase 0x82:\n\t\t\tsku_info->cpu_speedo_id = 1;\n\t\t\tsku_info->soc_speedo_id = 1;\n\t\t\tthreshold_index = THRESHOLD_INDEX_1;\n\t\t\tbreak;\n\t\tcase 0x81:\n\t\t\tswitch (package_id) {\n\t\t\tcase 1:\n\t\t\t\tsku_info->cpu_speedo_id = 2;\n\t\t\t\tsku_info->soc_speedo_id = 2;\n\t\t\t\tthreshold_index = THRESHOLD_INDEX_2;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tsku_info->cpu_speedo_id = 4;\n\t\t\t\tsku_info->soc_speedo_id = 1;\n\t\t\t\tthreshold_index = THRESHOLD_INDEX_7;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tpr_err(\"Tegra Unknown pkg %d\\n\", package_id);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 0x80:\n\t\t\tswitch (package_id) {\n\t\t\tcase 1:\n\t\t\t\tsku_info->cpu_speedo_id = 5;\n\t\t\t\tsku_info->soc_speedo_id = 2;\n\t\t\t\tthreshold_index = THRESHOLD_INDEX_8;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tsku_info->cpu_speedo_id = 6;\n\t\t\t\tsku_info->soc_speedo_id = 2;\n\t\t\t\tthreshold_index = THRESHOLD_INDEX_9;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tpr_err(\"Tegra Unknown pkg %d\\n\", package_id);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 0x83:\n\t\t\tswitch (package_id) {\n\t\t\tcase 1:\n\t\t\t\tsku_info->cpu_speedo_id = 7;\n\t\t\t\tsku_info->soc_speedo_id = 1;\n\t\t\t\tthreshold_index = THRESHOLD_INDEX_10;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tsku_info->cpu_speedo_id = 3;\n\t\t\t\tsku_info->soc_speedo_id = 2;\n\t\t\t\tthreshold_index = THRESHOLD_INDEX_3;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tpr_err(\"Tegra Unknown pkg %d\\n\", package_id);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 0x8F:\n\t\t\tsku_info->cpu_speedo_id = 8;\n\t\t\tsku_info->soc_speedo_id = 1;\n\t\t\tthreshold_index = THRESHOLD_INDEX_11;\n\t\t\tbreak;\n\t\tcase 0x08:\n\t\t\tsku_info->cpu_speedo_id = 1;\n\t\t\tsku_info->soc_speedo_id = 1;\n\t\t\tthreshold_index = THRESHOLD_INDEX_4;\n\t\t\tbreak;\n\t\tcase 0x02:\n\t\t\tsku_info->cpu_speedo_id = 2;\n\t\t\tsku_info->soc_speedo_id = 2;\n\t\t\tthreshold_index = THRESHOLD_INDEX_5;\n\t\t\tbreak;\n\t\tcase 0x04:\n\t\t\tsku_info->cpu_speedo_id = 3;\n\t\t\tsku_info->soc_speedo_id = 2;\n\t\t\tthreshold_index = THRESHOLD_INDEX_6;\n\t\t\tbreak;\n\t\tcase 0:\n\t\t\tswitch (package_id) {\n\t\t\tcase 1:\n\t\t\t\tsku_info->cpu_speedo_id = 2;\n\t\t\t\tsku_info->soc_speedo_id = 2;\n\t\t\t\tthreshold_index = THRESHOLD_INDEX_2;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tsku_info->cpu_speedo_id = 3;\n\t\t\t\tsku_info->soc_speedo_id = 2;\n\t\t\t\tthreshold_index = THRESHOLD_INDEX_3;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tpr_err(\"Tegra Unknown pkg %d\\n\", package_id);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpr_warn(\"Tegra Unknown SKU %d\\n\", sku_info->sku_id);\n\t\t\tsku_info->cpu_speedo_id = 0;\n\t\t\tsku_info->soc_speedo_id = 0;\n\t\t\tthreshold_index = THRESHOLD_INDEX_0;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tpr_warn(\"Tegra Unknown chip rev %d\\n\", sku_info->revision);\n\t\tsku_info->cpu_speedo_id = 0;\n\t\tsku_info->soc_speedo_id = 0;\n\t\tthreshold_index = THRESHOLD_INDEX_0;\n\t\tbreak;\n\t}\n}\n\nvoid __init tegra30_init_speedo_data(struct tegra_sku_info *sku_info)\n{\n\tu32 cpu_speedo_val;\n\tu32 soc_speedo_val;\n\tint i;\n\n\tBUILD_BUG_ON(ARRAY_SIZE(cpu_process_speedos) !=\n\t\t\tTHRESHOLD_INDEX_COUNT);\n\tBUILD_BUG_ON(ARRAY_SIZE(soc_process_speedos) !=\n\t\t\tTHRESHOLD_INDEX_COUNT);\n\n\n\trev_sku_to_speedo_ids(sku_info);\n\tfuse_speedo_calib(&cpu_speedo_val, &soc_speedo_val);\n\tpr_debug(\"Tegra CPU speedo value %u\\n\", cpu_speedo_val);\n\tpr_debug(\"Tegra Core speedo value %u\\n\", soc_speedo_val);\n\n\tfor (i = 0; i < CPU_PROCESS_CORNERS; i++) {\n\t\tif (cpu_speedo_val < cpu_process_speedos[threshold_index][i])\n\t\t\tbreak;\n\t}\n\tsku_info->cpu_process_id = i - 1;\n\n\tif (sku_info->cpu_process_id == -1) {\n\t\tpr_warn(\"Tegra CPU speedo value %3d out of range\",\n\t\t\t cpu_speedo_val);\n\t\tsku_info->cpu_process_id = 0;\n\t\tsku_info->cpu_speedo_id = 1;\n\t}\n\n\tfor (i = 0; i < SOC_PROCESS_CORNERS; i++) {\n\t\tif (soc_speedo_val < soc_process_speedos[threshold_index][i])\n\t\t\tbreak;\n\t}\n\tsku_info->soc_process_id = i - 1;\n\n\tif (sku_info->soc_process_id == -1) {\n\t\tpr_warn(\"Tegra SoC speedo value %3d out of range\",\n\t\t\tsoc_speedo_val);\n\t\tsku_info->soc_process_id = 0;\n\t\tsku_info->soc_speedo_id = 1;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}