{
  "module_name": "speedo-tegra210.c",
  "hash_id": "9a78ec68a1f47269cf9fc716dedf09a2e6e87c7afdd2e707b8e27931329d313b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/tegra/fuse/speedo-tegra210.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/bug.h>\n\n#include <soc/tegra/fuse.h>\n\n#include \"fuse.h\"\n\n#define CPU_PROCESS_CORNERS\t2\n#define GPU_PROCESS_CORNERS\t2\n#define SOC_PROCESS_CORNERS\t3\n\n#define FUSE_CPU_SPEEDO_0\t0x014\n#define FUSE_CPU_SPEEDO_1\t0x02c\n#define FUSE_CPU_SPEEDO_2\t0x030\n#define FUSE_SOC_SPEEDO_0\t0x034\n#define FUSE_SOC_SPEEDO_1\t0x038\n#define FUSE_SOC_SPEEDO_2\t0x03c\n#define FUSE_CPU_IDDQ\t\t0x018\n#define FUSE_SOC_IDDQ\t\t0x040\n#define FUSE_GPU_IDDQ\t\t0x128\n#define FUSE_FT_REV\t\t0x028\n\nenum {\n\tTHRESHOLD_INDEX_0,\n\tTHRESHOLD_INDEX_1,\n\tTHRESHOLD_INDEX_COUNT,\n};\n\nstatic const u32 __initconst cpu_process_speedos[][CPU_PROCESS_CORNERS] = {\n\t{ 2119, UINT_MAX },\n\t{ 2119, UINT_MAX },\n};\n\nstatic const u32 __initconst gpu_process_speedos[][GPU_PROCESS_CORNERS] = {\n\t{ UINT_MAX, UINT_MAX },\n\t{ UINT_MAX, UINT_MAX },\n};\n\nstatic const u32 __initconst soc_process_speedos[][SOC_PROCESS_CORNERS] = {\n\t{ 1950, 2100, UINT_MAX },\n\t{ 1950, 2100, UINT_MAX },\n};\n\nstatic u8 __init get_speedo_revision(void)\n{\n\treturn tegra_fuse_read_spare(4) << 2 |\n\t       tegra_fuse_read_spare(3) << 1 |\n\t       tegra_fuse_read_spare(2) << 0;\n}\n\nstatic void __init rev_sku_to_speedo_ids(struct tegra_sku_info *sku_info,\n\t\t\t\t\t u8 speedo_rev, int *threshold)\n{\n\tint sku = sku_info->sku_id;\n\n\t \n\tsku_info->cpu_speedo_id = 0;\n\tsku_info->soc_speedo_id = 0;\n\tsku_info->gpu_speedo_id = 0;\n\t*threshold = THRESHOLD_INDEX_0;\n\n\tswitch (sku) {\n\tcase 0x00:  \n\tcase 0x01:  \n\tcase 0x07:\n\tcase 0x17:\n\tcase 0x27:\n\t\tif (speedo_rev >= 2)\n\t\t\tsku_info->gpu_speedo_id = 1;\n\t\tbreak;\n\n\tcase 0x13:\n\t\tif (speedo_rev >= 2)\n\t\t\tsku_info->gpu_speedo_id = 1;\n\n\t\tsku_info->cpu_speedo_id = 1;\n\t\tbreak;\n\n\tdefault:\n\t\tpr_err(\"Tegra210: unknown SKU %#04x\\n\", sku);\n\t\t \n\t\tbreak;\n\t}\n}\n\nstatic int get_process_id(int value, const u32 *speedos, unsigned int num)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < num; i++)\n\t\tif (value < speedos[i])\n\t\t\treturn i;\n\n\treturn -EINVAL;\n}\n\nvoid __init tegra210_init_speedo_data(struct tegra_sku_info *sku_info)\n{\n\tint cpu_speedo[3], soc_speedo[3];\n\tunsigned int index;\n\tu8 speedo_revision;\n\n\tBUILD_BUG_ON(ARRAY_SIZE(cpu_process_speedos) !=\n\t\t\tTHRESHOLD_INDEX_COUNT);\n\tBUILD_BUG_ON(ARRAY_SIZE(gpu_process_speedos) !=\n\t\t\tTHRESHOLD_INDEX_COUNT);\n\tBUILD_BUG_ON(ARRAY_SIZE(soc_process_speedos) !=\n\t\t\tTHRESHOLD_INDEX_COUNT);\n\n\t \n\tcpu_speedo[0] = tegra_fuse_read_early(FUSE_CPU_SPEEDO_0);\n\tcpu_speedo[1] = tegra_fuse_read_early(FUSE_CPU_SPEEDO_1);\n\tcpu_speedo[2] = tegra_fuse_read_early(FUSE_CPU_SPEEDO_2);\n\n\tsoc_speedo[0] = tegra_fuse_read_early(FUSE_SOC_SPEEDO_0);\n\tsoc_speedo[1] = tegra_fuse_read_early(FUSE_SOC_SPEEDO_1);\n\tsoc_speedo[2] = tegra_fuse_read_early(FUSE_SOC_SPEEDO_2);\n\n\t \n\tspeedo_revision = get_speedo_revision();\n\tpr_info(\"Speedo Revision %u\\n\", speedo_revision);\n\n\tif (speedo_revision >= 3) {\n\t\tsku_info->cpu_speedo_value = cpu_speedo[0];\n\t\tsku_info->gpu_speedo_value = cpu_speedo[2];\n\t\tsku_info->soc_speedo_value = soc_speedo[0];\n\t} else if (speedo_revision == 2) {\n\t\tsku_info->cpu_speedo_value = (-1938 + (1095 * cpu_speedo[0] / 100)) / 10;\n\t\tsku_info->gpu_speedo_value = (-1662 + (1082 * cpu_speedo[2] / 100)) / 10;\n\t\tsku_info->soc_speedo_value = ( -705 + (1037 * soc_speedo[0] / 100)) / 10;\n\t} else {\n\t\tsku_info->cpu_speedo_value = 2100;\n\t\tsku_info->gpu_speedo_value = cpu_speedo[2] - 75;\n\t\tsku_info->soc_speedo_value = 1900;\n\t}\n\n\tif ((sku_info->cpu_speedo_value <= 0) ||\n\t    (sku_info->gpu_speedo_value <= 0) ||\n\t    (sku_info->soc_speedo_value <= 0)) {\n\t\tWARN(1, \"speedo value not fused\\n\");\n\t\treturn;\n\t}\n\n\trev_sku_to_speedo_ids(sku_info, speedo_revision, &index);\n\n\tsku_info->gpu_process_id = get_process_id(sku_info->gpu_speedo_value,\n\t\t\t\t\t\t  gpu_process_speedos[index],\n\t\t\t\t\t\t  GPU_PROCESS_CORNERS);\n\n\tsku_info->cpu_process_id = get_process_id(sku_info->cpu_speedo_value,\n\t\t\t\t\t\t  cpu_process_speedos[index],\n\t\t\t\t\t\t  CPU_PROCESS_CORNERS);\n\n\tsku_info->soc_process_id = get_process_id(sku_info->soc_speedo_value,\n\t\t\t\t\t\t  soc_process_speedos[index],\n\t\t\t\t\t\t  SOC_PROCESS_CORNERS);\n\n\tpr_debug(\"Tegra GPU Speedo ID=%d, Speedo Value=%d\\n\",\n\t\t sku_info->gpu_speedo_id, sku_info->gpu_speedo_value);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}