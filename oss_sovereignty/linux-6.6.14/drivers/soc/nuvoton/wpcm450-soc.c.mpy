{
  "module_name": "wpcm450-soc.c",
  "hash_id": "2a281b5aa7eefd525cc667a576e20c00ac61ad4983615511e4222cb6461eac60",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/nuvoton/wpcm450-soc.c",
  "human_readable_source": "\n \n\n#include <linux/mfd/syscon.h>\n#include <linux/of.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n#include <linux/sys_soc.h>\n\n#define GCR_PDID\t0\n#define PDID_CHIP(x)\t((x) & 0x00ffffff)\n#define CHIP_WPCM450\t0x926450\n#define PDID_REV(x)\t((x) >> 24)\n\nstruct revision {\n\tu8 number;\n\tconst char *name;\n};\n\nstatic const struct revision revisions[] __initconst = {\n\t{ 0x00, \"Z1\" },\n\t{ 0x03, \"Z2\" },\n\t{ 0x04, \"Z21\" },\n\t{ 0x08, \"A1\" },\n\t{ 0x09, \"A2\" },\n\t{ 0x0a, \"A3\" },\n\t{}\n};\n\nstatic const char * __init get_revision(unsigned int rev)\n{\n\tint i;\n\n\tfor (i = 0; revisions[i].name; i++)\n\t\tif (revisions[i].number == rev)\n\t\t\treturn revisions[i].name;\n\treturn NULL;\n}\n\nstatic struct soc_device_attribute *wpcm450_attr;\nstatic struct soc_device *wpcm450_soc;\n\nstatic int __init wpcm450_soc_init(void)\n{\n\tstruct soc_device_attribute *attr;\n\tstruct soc_device *soc;\n\tconst char *revision;\n\tstruct regmap *gcr;\n\tu32 pdid;\n\tint ret;\n\n\tif (!of_machine_is_compatible(\"nuvoton,wpcm450\"))\n\t\treturn 0;\n\n\tgcr = syscon_regmap_lookup_by_compatible(\"nuvoton,wpcm450-gcr\");\n\tif (IS_ERR(gcr))\n\t\treturn PTR_ERR(gcr);\n\tret = regmap_read(gcr, GCR_PDID, &pdid);\n\tif (ret)\n\t\treturn ret;\n\n\tif (PDID_CHIP(pdid) != CHIP_WPCM450) {\n\t\tpr_warn(\"Unknown chip ID in GCR.PDID: 0x%06x\\n\", PDID_CHIP(pdid));\n\t\treturn -ENODEV;\n\t}\n\n\trevision = get_revision(PDID_REV(pdid));\n\tif (!revision) {\n\t\tpr_warn(\"Unknown chip revision in GCR.PDID: 0x%02x\\n\", PDID_REV(pdid));\n\t\treturn -ENODEV;\n\t}\n\n\tattr = kzalloc(sizeof(*attr), GFP_KERNEL);\n\tif (!attr)\n\t\treturn -ENOMEM;\n\n\tattr->family = \"Nuvoton NPCM\";\n\tattr->soc_id = \"WPCM450\";\n\tattr->revision = revision;\n\tsoc = soc_device_register(attr);\n\tif (IS_ERR(soc)) {\n\t\tkfree(attr);\n\t\tpr_warn(\"Could not register SoC device\\n\");\n\t\treturn PTR_ERR(soc);\n\t}\n\n\twpcm450_soc = soc;\n\twpcm450_attr = attr;\n\treturn 0;\n}\nmodule_init(wpcm450_soc_init);\n\nstatic void __exit wpcm450_soc_exit(void)\n{\n\tif (wpcm450_soc) {\n\t\tsoc_device_unregister(wpcm450_soc);\n\t\twpcm450_soc = NULL;\n\t\tkfree(wpcm450_attr);\n\t}\n}\nmodule_exit(wpcm450_soc_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Jonathan Neusch\u00e4fer\");\nMODULE_DESCRIPTION(\"Nuvoton WPCM450 SoC Identification driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}