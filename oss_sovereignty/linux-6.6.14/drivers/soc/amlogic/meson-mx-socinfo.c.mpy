{
  "module_name": "meson-mx-socinfo.c",
  "hash_id": "3f796762aa469c5c5e0aa80cf41df7800e35c9391d68404efd710ba428b517da",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/amlogic/meson-mx-socinfo.c",
  "human_readable_source": " \n\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/sys_soc.h>\n#include <linux/bitfield.h>\n#include <linux/regmap.h>\n#include <linux/mfd/syscon.h>\n\n#define MESON_SOCINFO_MAJOR_VER_MESON6\t\t0x16\n#define MESON_SOCINFO_MAJOR_VER_MESON8\t\t0x19\n#define MESON_SOCINFO_MAJOR_VER_MESON8B\t\t0x1b\n\n#define MESON_MX_ASSIST_HW_REV\t\t\t0x14c\n\n#define MESON_MX_ANALOG_TOP_METAL_REVISION\t0x0\n\n#define MESON_MX_BOOTROM_MISC_VER\t\t0x4\n\nstatic const char *meson_mx_socinfo_revision(unsigned int major_ver,\n\t\t\t\t\t     unsigned int misc_ver,\n\t\t\t\t\t     unsigned int metal_rev)\n{\n\tunsigned int minor_ver;\n\n\tswitch (major_ver) {\n\tcase MESON_SOCINFO_MAJOR_VER_MESON6:\n\t\tminor_ver = 0xa;\n\t\tbreak;\n\n\tcase MESON_SOCINFO_MAJOR_VER_MESON8:\n\t\tif (metal_rev == 0x11111112)\n\t\t\tmajor_ver = 0x1d;\n\n\t\tif (metal_rev == 0x11111111 || metal_rev == 0x11111112)\n\t\t\tminor_ver = 0xa;\n\t\telse if (metal_rev == 0x11111113)\n\t\t\tminor_ver = 0xb;\n\t\telse if (metal_rev == 0x11111133)\n\t\t\tminor_ver = 0xc;\n\t\telse\n\t\t\tminor_ver = 0xd;\n\n\t\tbreak;\n\n\tcase MESON_SOCINFO_MAJOR_VER_MESON8B:\n\t\tif (metal_rev == 0x11111111)\n\t\t\tminor_ver = 0xa;\n\t\telse\n\t\t\tminor_ver = 0xb;\n\n\t\tbreak;\n\n\tdefault:\n\t\tminor_ver = 0x0;\n\t\tbreak;\n\t}\n\n\treturn kasprintf(GFP_KERNEL, \"Rev%X (%x - 0:%X)\", minor_ver, major_ver,\n\t\t\t misc_ver);\n}\n\nstatic const char *meson_mx_socinfo_soc_id(unsigned int major_ver,\n\t\t\t\t\t   unsigned int metal_rev)\n{\n\tconst char *soc_id;\n\n\tswitch (major_ver) {\n\tcase MESON_SOCINFO_MAJOR_VER_MESON6:\n\t\tsoc_id = \"Meson6 (AML8726-MX)\";\n\t\tbreak;\n\n\tcase MESON_SOCINFO_MAJOR_VER_MESON8:\n\t\tif (metal_rev == 0x11111112)\n\t\t\tsoc_id = \"Meson8m2 (S812)\";\n\t\telse\n\t\t\tsoc_id = \"Meson8 (S802)\";\n\n\t\tbreak;\n\n\tcase MESON_SOCINFO_MAJOR_VER_MESON8B:\n\t\tsoc_id = \"Meson8b (S805)\";\n\t\tbreak;\n\n\tdefault:\n\t\tsoc_id = \"Unknown\";\n\t\tbreak;\n\t}\n\n\treturn kstrdup_const(soc_id, GFP_KERNEL);\n}\n\nstatic const struct of_device_id meson_mx_socinfo_analog_top_ids[] = {\n\t{ .compatible = \"amlogic,meson8-analog-top\", },\n\t{ .compatible = \"amlogic,meson8b-analog-top\", },\n\t{   }\n};\n\nstatic int __init meson_mx_socinfo_init(void)\n{\n\tstruct soc_device_attribute *soc_dev_attr;\n\tstruct soc_device *soc_dev;\n\tstruct device_node *np;\n\tstruct regmap *assist_regmap, *bootrom_regmap, *analog_top_regmap;\n\tunsigned int major_ver, misc_ver, metal_rev = 0;\n\tint ret;\n\n\tassist_regmap =\n\t\tsyscon_regmap_lookup_by_compatible(\"amlogic,meson-mx-assist\");\n\tif (IS_ERR(assist_regmap))\n\t\treturn PTR_ERR(assist_regmap);\n\n\tbootrom_regmap =\n\t\tsyscon_regmap_lookup_by_compatible(\"amlogic,meson-mx-bootrom\");\n\tif (IS_ERR(bootrom_regmap))\n\t\treturn PTR_ERR(bootrom_regmap);\n\n\tnp = of_find_matching_node(NULL, meson_mx_socinfo_analog_top_ids);\n\tif (np) {\n\t\tanalog_top_regmap = syscon_node_to_regmap(np);\n\t\tof_node_put(np);\n\t\tif (IS_ERR(analog_top_regmap))\n\t\t\treturn PTR_ERR(analog_top_regmap);\n\n\t\tret = regmap_read(analog_top_regmap,\n\t\t\t\t  MESON_MX_ANALOG_TOP_METAL_REVISION,\n\t\t\t\t  &metal_rev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = regmap_read(assist_regmap, MESON_MX_ASSIST_HW_REV, &major_ver);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(bootrom_regmap, MESON_MX_BOOTROM_MISC_VER,\n\t\t\t  &misc_ver);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tsoc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);\n\tif (!soc_dev_attr)\n\t\treturn -ENODEV;\n\n\tsoc_dev_attr->family = \"Amlogic Meson\";\n\n\tnp = of_find_node_by_path(\"/\");\n\tof_property_read_string(np, \"model\", &soc_dev_attr->machine);\n\tof_node_put(np);\n\n\tsoc_dev_attr->revision = meson_mx_socinfo_revision(major_ver, misc_ver,\n\t\t\t\t\t\t\t   metal_rev);\n\tsoc_dev_attr->soc_id = meson_mx_socinfo_soc_id(major_ver, metal_rev);\n\n\tsoc_dev = soc_device_register(soc_dev_attr);\n\tif (IS_ERR(soc_dev)) {\n\t\tkfree_const(soc_dev_attr->revision);\n\t\tkfree_const(soc_dev_attr->soc_id);\n\t\tkfree(soc_dev_attr);\n\t\treturn PTR_ERR(soc_dev);\n\t}\n\n\tdev_info(soc_device_to_device(soc_dev), \"Amlogic %s %s detected\\n\",\n\t\t soc_dev_attr->soc_id, soc_dev_attr->revision);\n\n\treturn 0;\n}\ndevice_initcall(meson_mx_socinfo_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}