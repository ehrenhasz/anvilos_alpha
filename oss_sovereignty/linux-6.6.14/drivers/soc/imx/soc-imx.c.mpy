{
  "module_name": "soc-imx.c",
  "hash_id": "40a0e2e00c919459a96ffbf49ec31950fa6c356bad531eb1afa804d4f500f3f1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soc/imx/soc-imx.c",
  "human_readable_source": "\n \n\n#include <linux/mfd/syscon.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n#include <linux/sys_soc.h>\n\n#include <soc/imx/cpu.h>\n#include <soc/imx/revision.h>\n\n#define IIM_UID\t\t0x820\n\n#define OCOTP_UID_H\t0x420\n#define OCOTP_UID_L\t0x410\n\n#define OCOTP_ULP_UID_1\t\t0x4b0\n#define OCOTP_ULP_UID_2\t\t0x4c0\n#define OCOTP_ULP_UID_3\t\t0x4d0\n#define OCOTP_ULP_UID_4\t\t0x4e0\n\nstatic int __init imx_soc_device_init(void)\n{\n\tstruct soc_device_attribute *soc_dev_attr;\n\tconst char *ocotp_compat = NULL;\n\tstruct soc_device *soc_dev;\n\tstruct device_node *root;\n\tstruct regmap *ocotp = NULL;\n\tconst char *soc_id;\n\tu64 soc_uid = 0;\n\tu32 val;\n\tint ret;\n\tint i;\n\n\t \n\tif (!__mxc_cpu_type)\n\t\treturn 0;\n\n\tsoc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);\n\tif (!soc_dev_attr)\n\t\treturn -ENOMEM;\n\n\tsoc_dev_attr->family = \"Freescale i.MX\";\n\n\troot = of_find_node_by_path(\"/\");\n\tret = of_property_read_string(root, \"model\", &soc_dev_attr->machine);\n\tof_node_put(root);\n\tif (ret)\n\t\tgoto free_soc;\n\n\tswitch (__mxc_cpu_type) {\n\tcase MXC_CPU_MX1:\n\t\tsoc_id = \"i.MX1\";\n\t\tbreak;\n\tcase MXC_CPU_MX21:\n\t\tsoc_id = \"i.MX21\";\n\t\tbreak;\n\tcase MXC_CPU_MX25:\n\t\tsoc_id = \"i.MX25\";\n\t\tbreak;\n\tcase MXC_CPU_MX27:\n\t\tsoc_id = \"i.MX27\";\n\t\tbreak;\n\tcase MXC_CPU_MX31:\n\t\tsoc_id = \"i.MX31\";\n\t\tbreak;\n\tcase MXC_CPU_MX35:\n\t\tsoc_id = \"i.MX35\";\n\t\tbreak;\n\tcase MXC_CPU_MX50:\n\t\tsoc_id = \"i.MX50\";\n\t\tbreak;\n\tcase MXC_CPU_MX51:\n\t\tocotp_compat = \"fsl,imx51-iim\";\n\t\tsoc_id = \"i.MX51\";\n\t\tbreak;\n\tcase MXC_CPU_MX53:\n\t\tocotp_compat = \"fsl,imx53-iim\";\n\t\tsoc_id = \"i.MX53\";\n\t\tbreak;\n\tcase MXC_CPU_IMX6SL:\n\t\tocotp_compat = \"fsl,imx6sl-ocotp\";\n\t\tsoc_id = \"i.MX6SL\";\n\t\tbreak;\n\tcase MXC_CPU_IMX6DL:\n\t\tocotp_compat = \"fsl,imx6q-ocotp\";\n\t\tsoc_id = \"i.MX6DL\";\n\t\tbreak;\n\tcase MXC_CPU_IMX6SX:\n\t\tocotp_compat = \"fsl,imx6sx-ocotp\";\n\t\tsoc_id = \"i.MX6SX\";\n\t\tbreak;\n\tcase MXC_CPU_IMX6Q:\n\t\tocotp_compat = \"fsl,imx6q-ocotp\";\n\t\tsoc_id = \"i.MX6Q\";\n\t\tbreak;\n\tcase MXC_CPU_IMX6UL:\n\t\tocotp_compat = \"fsl,imx6ul-ocotp\";\n\t\tsoc_id = \"i.MX6UL\";\n\t\tbreak;\n\tcase MXC_CPU_IMX6ULL:\n\t\tocotp_compat = \"fsl,imx6ull-ocotp\";\n\t\tsoc_id = \"i.MX6ULL\";\n\t\tbreak;\n\tcase MXC_CPU_IMX6ULZ:\n\t\tocotp_compat = \"fsl,imx6ull-ocotp\";\n\t\tsoc_id = \"i.MX6ULZ\";\n\t\tbreak;\n\tcase MXC_CPU_IMX6SLL:\n\t\tocotp_compat = \"fsl,imx6sll-ocotp\";\n\t\tsoc_id = \"i.MX6SLL\";\n\t\tbreak;\n\tcase MXC_CPU_IMX7D:\n\t\tocotp_compat = \"fsl,imx7d-ocotp\";\n\t\tsoc_id = \"i.MX7D\";\n\t\tbreak;\n\tcase MXC_CPU_IMX7ULP:\n\t\tocotp_compat = \"fsl,imx7ulp-ocotp\";\n\t\tsoc_id = \"i.MX7ULP\";\n\t\tbreak;\n\tcase MXC_CPU_VF500:\n\t\tocotp_compat = \"fsl,vf610-ocotp\";\n\t\tsoc_id = \"VF500\";\n\t\tbreak;\n\tcase MXC_CPU_VF510:\n\t\tocotp_compat = \"fsl,vf610-ocotp\";\n\t\tsoc_id = \"VF510\";\n\t\tbreak;\n\tcase MXC_CPU_VF600:\n\t\tocotp_compat = \"fsl,vf610-ocotp\";\n\t\tsoc_id = \"VF600\";\n\t\tbreak;\n\tcase MXC_CPU_VF610:\n\t\tocotp_compat = \"fsl,vf610-ocotp\";\n\t\tsoc_id = \"VF610\";\n\t\tbreak;\n\tdefault:\n\t\tsoc_id = \"Unknown\";\n\t}\n\tsoc_dev_attr->soc_id = soc_id;\n\n\tif (ocotp_compat) {\n\t\tocotp = syscon_regmap_lookup_by_compatible(ocotp_compat);\n\t\tif (IS_ERR(ocotp))\n\t\t\tpr_err(\"%s: failed to find %s regmap!\\n\", __func__, ocotp_compat);\n\t}\n\n\tif (!IS_ERR_OR_NULL(ocotp)) {\n\t\tif (__mxc_cpu_type == MXC_CPU_IMX7ULP) {\n\t\t\tregmap_read(ocotp, OCOTP_ULP_UID_4, &val);\n\t\t\tsoc_uid = val & 0xffff;\n\t\t\tregmap_read(ocotp, OCOTP_ULP_UID_3, &val);\n\t\t\tsoc_uid <<= 16;\n\t\t\tsoc_uid |= val & 0xffff;\n\t\t\tregmap_read(ocotp, OCOTP_ULP_UID_2, &val);\n\t\t\tsoc_uid <<= 16;\n\t\t\tsoc_uid |= val & 0xffff;\n\t\t\tregmap_read(ocotp, OCOTP_ULP_UID_1, &val);\n\t\t\tsoc_uid <<= 16;\n\t\t\tsoc_uid |= val & 0xffff;\n\t\t} else if (__mxc_cpu_type == MXC_CPU_MX51 ||\n\t\t\t   __mxc_cpu_type == MXC_CPU_MX53) {\n\t\t\tfor (i=0; i < 8; i++) {\n\t\t\t\tregmap_read(ocotp, IIM_UID + i*4, &val);\n\t\t\t\tsoc_uid <<= 8;\n\t\t\t\tsoc_uid |= (val & 0xff);\n\t\t\t}\n\t\t} else {\n\t\t\tregmap_read(ocotp, OCOTP_UID_H, &val);\n\t\t\tsoc_uid = val;\n\t\t\tregmap_read(ocotp, OCOTP_UID_L, &val);\n\t\t\tsoc_uid <<= 32;\n\t\t\tsoc_uid |= val;\n\t\t}\n\t}\n\n\tsoc_dev_attr->revision = kasprintf(GFP_KERNEL, \"%d.%d\",\n\t\t\t\t\t   (imx_get_soc_revision() >> 4) & 0xf,\n\t\t\t\t\t   imx_get_soc_revision() & 0xf);\n\tif (!soc_dev_attr->revision) {\n\t\tret = -ENOMEM;\n\t\tgoto free_soc;\n\t}\n\n\tsoc_dev_attr->serial_number = kasprintf(GFP_KERNEL, \"%016llX\", soc_uid);\n\tif (!soc_dev_attr->serial_number) {\n\t\tret = -ENOMEM;\n\t\tgoto free_rev;\n\t}\n\n\tsoc_dev = soc_device_register(soc_dev_attr);\n\tif (IS_ERR(soc_dev)) {\n\t\tret = PTR_ERR(soc_dev);\n\t\tgoto free_serial_number;\n\t}\n\n\treturn 0;\n\nfree_serial_number:\n\tkfree(soc_dev_attr->serial_number);\nfree_rev:\n\tkfree(soc_dev_attr->revision);\nfree_soc:\n\tkfree(soc_dev_attr);\n\treturn ret;\n}\ndevice_initcall(imx_soc_device_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}