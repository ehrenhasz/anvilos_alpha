{
  "module_name": "iotlb.c",
  "hash_id": "d73ee8d234a3fdacd1672944017b94a1991b6a10aa6d52da33e40743d3c283d1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vhost/iotlb.c",
  "human_readable_source": "\n \n#include <linux/slab.h>\n#include <linux/vhost_iotlb.h>\n#include <linux/module.h>\n\n#define MOD_VERSION  \"0.1\"\n#define MOD_DESC     \"VHOST IOTLB\"\n#define MOD_AUTHOR   \"Jason Wang <jasowang@redhat.com>\"\n#define MOD_LICENSE  \"GPL v2\"\n\n#define START(map) ((map)->start)\n#define LAST(map) ((map)->last)\n\nINTERVAL_TREE_DEFINE(struct vhost_iotlb_map,\n\t\t     rb, __u64, __subtree_last,\n\t\t     START, LAST, static inline, vhost_iotlb_itree);\n\n \nvoid vhost_iotlb_map_free(struct vhost_iotlb *iotlb,\n\t\t\t  struct vhost_iotlb_map *map)\n{\n\tvhost_iotlb_itree_remove(map, &iotlb->root);\n\tlist_del(&map->link);\n\tkfree(map);\n\tiotlb->nmaps--;\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_map_free);\n\n \nint vhost_iotlb_add_range_ctx(struct vhost_iotlb *iotlb,\n\t\t\t      u64 start, u64 last,\n\t\t\t      u64 addr, unsigned int perm,\n\t\t\t      void *opaque)\n{\n\tstruct vhost_iotlb_map *map;\n\n\tif (last < start)\n\t\treturn -EFAULT;\n\n\t \n\tif (start == 0 && last == ULONG_MAX) {\n\t\tu64 mid = last / 2;\n\t\tint err = vhost_iotlb_add_range_ctx(iotlb, start, mid, addr,\n\t\t\t\tperm, opaque);\n\n\t\tif (err)\n\t\t\treturn err;\n\n\t\taddr += mid + 1;\n\t\tstart = mid + 1;\n\t}\n\n\tif (iotlb->limit &&\n\t    iotlb->nmaps == iotlb->limit &&\n\t    iotlb->flags & VHOST_IOTLB_FLAG_RETIRE) {\n\t\tmap = list_first_entry(&iotlb->list, typeof(*map), link);\n\t\tvhost_iotlb_map_free(iotlb, map);\n\t}\n\n\tmap = kmalloc(sizeof(*map), GFP_ATOMIC);\n\tif (!map)\n\t\treturn -ENOMEM;\n\n\tmap->start = start;\n\tmap->size = last - start + 1;\n\tmap->last = last;\n\tmap->addr = addr;\n\tmap->perm = perm;\n\tmap->opaque = opaque;\n\n\tiotlb->nmaps++;\n\tvhost_iotlb_itree_insert(map, &iotlb->root);\n\n\tINIT_LIST_HEAD(&map->link);\n\tlist_add_tail(&map->link, &iotlb->list);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_add_range_ctx);\n\nint vhost_iotlb_add_range(struct vhost_iotlb *iotlb,\n\t\t\t  u64 start, u64 last,\n\t\t\t  u64 addr, unsigned int perm)\n{\n\treturn vhost_iotlb_add_range_ctx(iotlb, start, last,\n\t\t\t\t\t addr, perm, NULL);\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_add_range);\n\n \nvoid vhost_iotlb_del_range(struct vhost_iotlb *iotlb, u64 start, u64 last)\n{\n\tstruct vhost_iotlb_map *map;\n\n\twhile ((map = vhost_iotlb_itree_iter_first(&iotlb->root,\n\t\t\t\t\t\t   start, last)))\n\t\tvhost_iotlb_map_free(iotlb, map);\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_del_range);\n\n \nvoid vhost_iotlb_init(struct vhost_iotlb *iotlb, unsigned int limit,\n\t\t      unsigned int flags)\n{\n\tiotlb->root = RB_ROOT_CACHED;\n\tiotlb->limit = limit;\n\tiotlb->nmaps = 0;\n\tiotlb->flags = flags;\n\tINIT_LIST_HEAD(&iotlb->list);\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_init);\n\n \nstruct vhost_iotlb *vhost_iotlb_alloc(unsigned int limit, unsigned int flags)\n{\n\tstruct vhost_iotlb *iotlb = kzalloc(sizeof(*iotlb), GFP_KERNEL);\n\n\tif (!iotlb)\n\t\treturn NULL;\n\n\tvhost_iotlb_init(iotlb, limit, flags);\n\n\treturn iotlb;\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_alloc);\n\n \nvoid vhost_iotlb_reset(struct vhost_iotlb *iotlb)\n{\n\tvhost_iotlb_del_range(iotlb, 0ULL, 0ULL - 1);\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_reset);\n\n \nvoid vhost_iotlb_free(struct vhost_iotlb *iotlb)\n{\n\tif (iotlb) {\n\t\tvhost_iotlb_reset(iotlb);\n\t\tkfree(iotlb);\n\t}\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_free);\n\n \nstruct vhost_iotlb_map *\nvhost_iotlb_itree_first(struct vhost_iotlb *iotlb, u64 start, u64 last)\n{\n\treturn vhost_iotlb_itree_iter_first(&iotlb->root, start, last);\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_itree_first);\n\n \nstruct vhost_iotlb_map *\nvhost_iotlb_itree_next(struct vhost_iotlb_map *map, u64 start, u64 last)\n{\n\treturn vhost_iotlb_itree_iter_next(map, start, last);\n}\nEXPORT_SYMBOL_GPL(vhost_iotlb_itree_next);\n\nMODULE_VERSION(MOD_VERSION);\nMODULE_DESCRIPTION(MOD_DESC);\nMODULE_AUTHOR(MOD_AUTHOR);\nMODULE_LICENSE(MOD_LICENSE);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}