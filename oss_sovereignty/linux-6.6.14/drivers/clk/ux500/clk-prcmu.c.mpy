{
  "module_name": "clk-prcmu.c",
  "hash_id": "9ea11d746247bfb159430f387d99aa1c7031df0ca7a514ccdc2cdd2ab58cb9f8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/ux500/clk-prcmu.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/mfd/dbx500-prcmu.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n#include <linux/err.h>\n#include \"clk.h\"\n\n#define to_clk_prcmu(_hw) container_of(_hw, struct clk_prcmu, hw)\n#define to_clk_prcmu_clkout(_hw) container_of(_hw, struct clk_prcmu_clkout, hw)\n\nstruct clk_prcmu {\n\tstruct clk_hw hw;\n\tu8 cg_sel;\n\tint opp_requested;\n};\n\nstruct clk_prcmu_clkout {\n\tstruct clk_hw hw;\n\tu8 clkout_id;\n\tu8 source;\n\tu8 divider;\n};\n\n \n\nstatic int clk_prcmu_prepare(struct clk_hw *hw)\n{\n\tstruct clk_prcmu *clk = to_clk_prcmu(hw);\n\n\treturn prcmu_request_clock(clk->cg_sel, true);\n}\n\nstatic void clk_prcmu_unprepare(struct clk_hw *hw)\n{\n\tstruct clk_prcmu *clk = to_clk_prcmu(hw);\n\tif (prcmu_request_clock(clk->cg_sel, false))\n\t\tpr_err(\"clk_prcmu: %s failed to disable %s.\\n\", __func__,\n\t\t       clk_hw_get_name(hw));\n}\n\nstatic unsigned long clk_prcmu_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t   unsigned long parent_rate)\n{\n\tstruct clk_prcmu *clk = to_clk_prcmu(hw);\n\treturn prcmu_clock_rate(clk->cg_sel);\n}\n\nstatic long clk_prcmu_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t unsigned long *parent_rate)\n{\n\tstruct clk_prcmu *clk = to_clk_prcmu(hw);\n\treturn prcmu_round_clock_rate(clk->cg_sel, rate);\n}\n\nstatic int clk_prcmu_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t      unsigned long parent_rate)\n{\n\tstruct clk_prcmu *clk = to_clk_prcmu(hw);\n\treturn prcmu_set_clock_rate(clk->cg_sel, rate);\n}\n\nstatic int clk_prcmu_opp_prepare(struct clk_hw *hw)\n{\n\tint err;\n\tstruct clk_prcmu *clk = to_clk_prcmu(hw);\n\n\tif (!clk->opp_requested) {\n\t\terr = prcmu_qos_add_requirement(PRCMU_QOS_APE_OPP,\n\t\t\t\t\t\t(char *)clk_hw_get_name(hw),\n\t\t\t\t\t\t100);\n\t\tif (err) {\n\t\t\tpr_err(\"clk_prcmu: %s fail req APE OPP for %s.\\n\",\n\t\t\t\t__func__, clk_hw_get_name(hw));\n\t\t\treturn err;\n\t\t}\n\t\tclk->opp_requested = 1;\n\t}\n\n\terr = prcmu_request_clock(clk->cg_sel, true);\n\tif (err) {\n\t\tprcmu_qos_remove_requirement(PRCMU_QOS_APE_OPP,\n\t\t\t\t\t(char *)clk_hw_get_name(hw));\n\t\tclk->opp_requested = 0;\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic void clk_prcmu_opp_unprepare(struct clk_hw *hw)\n{\n\tstruct clk_prcmu *clk = to_clk_prcmu(hw);\n\n\tif (prcmu_request_clock(clk->cg_sel, false)) {\n\t\tpr_err(\"clk_prcmu: %s failed to disable %s.\\n\", __func__,\n\t\t\tclk_hw_get_name(hw));\n\t\treturn;\n\t}\n\n\tif (clk->opp_requested) {\n\t\tprcmu_qos_remove_requirement(PRCMU_QOS_APE_OPP,\n\t\t\t\t\t(char *)clk_hw_get_name(hw));\n\t\tclk->opp_requested = 0;\n\t}\n}\n\nstatic int clk_prcmu_opp_volt_prepare(struct clk_hw *hw)\n{\n\tint err;\n\tstruct clk_prcmu *clk = to_clk_prcmu(hw);\n\n\tif (!clk->opp_requested) {\n\t\terr = prcmu_request_ape_opp_100_voltage(true);\n\t\tif (err) {\n\t\t\tpr_err(\"clk_prcmu: %s fail req APE OPP VOLT for %s.\\n\",\n\t\t\t\t__func__, clk_hw_get_name(hw));\n\t\t\treturn err;\n\t\t}\n\t\tclk->opp_requested = 1;\n\t}\n\n\terr = prcmu_request_clock(clk->cg_sel, true);\n\tif (err) {\n\t\tprcmu_request_ape_opp_100_voltage(false);\n\t\tclk->opp_requested = 0;\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic void clk_prcmu_opp_volt_unprepare(struct clk_hw *hw)\n{\n\tstruct clk_prcmu *clk = to_clk_prcmu(hw);\n\n\tif (prcmu_request_clock(clk->cg_sel, false)) {\n\t\tpr_err(\"clk_prcmu: %s failed to disable %s.\\n\", __func__,\n\t\t\tclk_hw_get_name(hw));\n\t\treturn;\n\t}\n\n\tif (clk->opp_requested) {\n\t\tprcmu_request_ape_opp_100_voltage(false);\n\t\tclk->opp_requested = 0;\n\t}\n}\n\nstatic const struct clk_ops clk_prcmu_scalable_ops = {\n\t.prepare = clk_prcmu_prepare,\n\t.unprepare = clk_prcmu_unprepare,\n\t.recalc_rate = clk_prcmu_recalc_rate,\n\t.round_rate = clk_prcmu_round_rate,\n\t.set_rate = clk_prcmu_set_rate,\n};\n\nstatic const struct clk_ops clk_prcmu_gate_ops = {\n\t.prepare = clk_prcmu_prepare,\n\t.unprepare = clk_prcmu_unprepare,\n\t.recalc_rate = clk_prcmu_recalc_rate,\n};\n\nstatic const struct clk_ops clk_prcmu_scalable_rate_ops = {\n\t.recalc_rate = clk_prcmu_recalc_rate,\n\t.round_rate = clk_prcmu_round_rate,\n\t.set_rate = clk_prcmu_set_rate,\n};\n\nstatic const struct clk_ops clk_prcmu_rate_ops = {\n\t.recalc_rate = clk_prcmu_recalc_rate,\n};\n\nstatic const struct clk_ops clk_prcmu_opp_gate_ops = {\n\t.prepare = clk_prcmu_opp_prepare,\n\t.unprepare = clk_prcmu_opp_unprepare,\n\t.recalc_rate = clk_prcmu_recalc_rate,\n};\n\nstatic const struct clk_ops clk_prcmu_opp_volt_scalable_ops = {\n\t.prepare = clk_prcmu_opp_volt_prepare,\n\t.unprepare = clk_prcmu_opp_volt_unprepare,\n\t.recalc_rate = clk_prcmu_recalc_rate,\n\t.round_rate = clk_prcmu_round_rate,\n\t.set_rate = clk_prcmu_set_rate,\n};\n\nstatic struct clk_hw *clk_reg_prcmu(const char *name,\n\t\t\t\t    const char *parent_name,\n\t\t\t\t    u8 cg_sel,\n\t\t\t\t    unsigned long rate,\n\t\t\t\t    unsigned long flags,\n\t\t\t\t    const struct clk_ops *clk_prcmu_ops)\n{\n\tstruct clk_prcmu *clk;\n\tstruct clk_init_data clk_prcmu_init;\n\tint ret;\n\n\tif (!name) {\n\t\tpr_err(\"clk_prcmu: %s invalid arguments passed\\n\", __func__);\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tclk = kzalloc(sizeof(*clk), GFP_KERNEL);\n\tif (!clk)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tclk->cg_sel = cg_sel;\n\tclk->opp_requested = 0;\n\t \n\tif (rate)\n\t\tprcmu_set_clock_rate(cg_sel, rate);\n\n\tclk_prcmu_init.name = name;\n\tclk_prcmu_init.ops = clk_prcmu_ops;\n\tclk_prcmu_init.flags = flags;\n\tclk_prcmu_init.parent_names = (parent_name ? &parent_name : NULL);\n\tclk_prcmu_init.num_parents = (parent_name ? 1 : 0);\n\tclk->hw.init = &clk_prcmu_init;\n\n\tret = clk_hw_register(NULL, &clk->hw);\n\tif (ret)\n\t\tgoto free_clk;\n\n\treturn &clk->hw;\n\nfree_clk:\n\tkfree(clk);\n\tpr_err(\"clk_prcmu: %s failed to register clk\\n\", __func__);\n\treturn ERR_PTR(-ENOMEM);\n}\n\nstruct clk_hw *clk_reg_prcmu_scalable(const char *name,\n\t\t\t\t      const char *parent_name,\n\t\t\t\t      u8 cg_sel,\n\t\t\t\t      unsigned long rate,\n\t\t\t\t      unsigned long flags)\n{\n\treturn clk_reg_prcmu(name, parent_name, cg_sel, rate, flags,\n\t\t\t&clk_prcmu_scalable_ops);\n}\n\nstruct clk_hw *clk_reg_prcmu_gate(const char *name,\n\t\t\t\t  const char *parent_name,\n\t\t\t\t  u8 cg_sel,\n\t\t\t\t  unsigned long flags)\n{\n\treturn clk_reg_prcmu(name, parent_name, cg_sel, 0, flags,\n\t\t\t&clk_prcmu_gate_ops);\n}\n\nstruct clk_hw *clk_reg_prcmu_scalable_rate(const char *name,\n\t\t\t\t\t   const char *parent_name,\n\t\t\t\t\t   u8 cg_sel,\n\t\t\t\t\t   unsigned long rate,\n\t\t\t\t\t   unsigned long flags)\n{\n\treturn clk_reg_prcmu(name, parent_name, cg_sel, rate, flags,\n\t\t\t&clk_prcmu_scalable_rate_ops);\n}\n\nstruct clk_hw *clk_reg_prcmu_rate(const char *name,\n\t\t\t\t  const char *parent_name,\n\t\t\t\t  u8 cg_sel,\n\t\t\t\t  unsigned long flags)\n{\n\treturn clk_reg_prcmu(name, parent_name, cg_sel, 0, flags,\n\t\t\t&clk_prcmu_rate_ops);\n}\n\nstruct clk_hw *clk_reg_prcmu_opp_gate(const char *name,\n\t\t\t\t      const char *parent_name,\n\t\t\t\t      u8 cg_sel,\n\t\t\t\t      unsigned long flags)\n{\n\treturn clk_reg_prcmu(name, parent_name, cg_sel, 0, flags,\n\t\t\t&clk_prcmu_opp_gate_ops);\n}\n\nstruct clk_hw *clk_reg_prcmu_opp_volt_scalable(const char *name,\n\t\t\t\t\t       const char *parent_name,\n\t\t\t\t\t       u8 cg_sel,\n\t\t\t\t\t       unsigned long rate,\n\t\t\t\t\t       unsigned long flags)\n{\n\treturn clk_reg_prcmu(name, parent_name, cg_sel, rate, flags,\n\t\t\t&clk_prcmu_opp_volt_scalable_ops);\n}\n\n \n\nstatic int clk_prcmu_clkout_prepare(struct clk_hw *hw)\n{\n\tstruct clk_prcmu_clkout *clk = to_clk_prcmu_clkout(hw);\n\n\treturn prcmu_config_clkout(clk->clkout_id, clk->source, clk->divider);\n}\n\nstatic void clk_prcmu_clkout_unprepare(struct clk_hw *hw)\n{\n\tstruct clk_prcmu_clkout *clk = to_clk_prcmu_clkout(hw);\n\tint ret;\n\n\t \n\tret = prcmu_config_clkout(clk->clkout_id, clk->source, 0);\n\tif (ret)\n\t\tpr_err(\"clk_prcmu: %s failed to disable %s\\n\", __func__,\n\t\t       clk_hw_get_name(hw));\n}\n\nstatic unsigned long clk_prcmu_clkout_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t\t  unsigned long parent_rate)\n{\n\tstruct clk_prcmu_clkout *clk = to_clk_prcmu_clkout(hw);\n\n\treturn (parent_rate / clk->divider);\n}\n\nstatic u8 clk_prcmu_clkout_get_parent(struct clk_hw *hw)\n{\n\tstruct clk_prcmu_clkout *clk = to_clk_prcmu_clkout(hw);\n\n\treturn clk->source;\n}\n\nstatic int clk_prcmu_clkout_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct clk_prcmu_clkout *clk = to_clk_prcmu_clkout(hw);\n\n\tclk->source = index;\n\t \n\tif (clk_hw_is_prepared(hw))\n\t\treturn clk_prcmu_clkout_prepare(hw);\n\treturn 0;\n}\n\nstatic const struct clk_ops clk_prcmu_clkout_ops = {\n\t.prepare = clk_prcmu_clkout_prepare,\n\t.unprepare = clk_prcmu_clkout_unprepare,\n\t.recalc_rate = clk_prcmu_clkout_recalc_rate,\n\t.determine_rate = clk_hw_determine_rate_no_reparent,\n\t.get_parent = clk_prcmu_clkout_get_parent,\n\t.set_parent = clk_prcmu_clkout_set_parent,\n};\n\nstruct clk_hw *clk_reg_prcmu_clkout(const char *name,\n\t\t\t\t    const char * const *parent_names,\n\t\t\t\t    int num_parents,\n\t\t\t\t    u8 source, u8 divider)\n\n{\n\tstruct clk_prcmu_clkout *clk;\n\tstruct clk_init_data clk_prcmu_clkout_init;\n\tu8 clkout_id;\n\tint ret;\n\n\tif (!name) {\n\t\tpr_err(\"clk_prcmu_clkout: %s invalid arguments passed\\n\", __func__);\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tif (!strcmp(name, \"clkout1\"))\n\t\tclkout_id = 0;\n\telse if (!strcmp(name, \"clkout2\"))\n\t\tclkout_id = 1;\n\telse {\n\t\tpr_err(\"clk_prcmu_clkout: %s bad clock name\\n\", __func__);\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tclk = kzalloc(sizeof(*clk), GFP_KERNEL);\n\tif (!clk)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tclk->clkout_id = clkout_id;\n\tclk->source = source;\n\tclk->divider = divider;\n\n\tclk_prcmu_clkout_init.name = name;\n\tclk_prcmu_clkout_init.ops = &clk_prcmu_clkout_ops;\n\tclk_prcmu_clkout_init.flags = CLK_GET_RATE_NOCACHE;\n\tclk_prcmu_clkout_init.parent_names = parent_names;\n\tclk_prcmu_clkout_init.num_parents = num_parents;\n\tclk->hw.init = &clk_prcmu_clkout_init;\n\n\tret = clk_hw_register(NULL, &clk->hw);\n\tif (ret)\n\t\tgoto free_clkout;\n\n\treturn &clk->hw;\nfree_clkout:\n\tkfree(clk);\n\tpr_err(\"clk_prcmu_clkout: %s failed to register clk\\n\", __func__);\n\treturn ERR_PTR(-ENOMEM);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}