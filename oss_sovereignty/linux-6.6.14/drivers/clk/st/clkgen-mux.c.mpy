{
  "module_name": "clkgen-mux.c",
  "hash_id": "9fc1f7d6da97d81dedc19afa06250cead197bd7076e95b5633d95c9919927d42",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/st/clkgen-mux.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n#include <linux/io.h>\n#include <linux/of_address.h>\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include \"clkgen.h\"\n\nstatic const char ** __init clkgen_mux_get_parents(struct device_node *np,\n\t\t\t\t\t\t       int *num_parents)\n{\n\tconst char **parents;\n\tunsigned int nparents;\n\n\tnparents = of_clk_get_parent_count(np);\n\tif (WARN_ON(!nparents))\n\t\treturn ERR_PTR(-EINVAL);\n\n\tparents = kcalloc(nparents, sizeof(const char *), GFP_KERNEL);\n\tif (!parents)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\t*num_parents = of_clk_parent_fill(np, parents, nparents);\n\treturn parents;\n}\n\nstruct clkgen_mux_data {\n\tu32 offset;\n\tu8 shift;\n\tu8 width;\n\tspinlock_t *lock;\n\tunsigned long clk_flags;\n\tu8 mux_flags;\n};\n\nstatic struct clkgen_mux_data stih407_a9_mux_data = {\n\t.offset = 0x1a4,\n\t.shift = 0,\n\t.width = 2,\n\t.lock = &clkgen_a9_lock,\n};\n\nstatic void __init st_of_clkgen_mux_setup(struct device_node *np,\n\t\tstruct clkgen_mux_data *data)\n{\n\tstruct clk *clk;\n\tvoid __iomem *reg;\n\tconst char **parents;\n\tint num_parents = 0;\n\tstruct device_node *parent_np;\n\n\t \n\treg = of_iomap(np, 0);\n\tif (!reg) {\n\t\tparent_np = of_get_parent(np);\n\t\treg = of_iomap(parent_np, 0);\n\t\tof_node_put(parent_np);\n\t\tif (!reg) {\n\t\t\tpr_err(\"%s: Failed to get base address\\n\", __func__);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tparents = clkgen_mux_get_parents(np, &num_parents);\n\tif (IS_ERR(parents)) {\n\t\tpr_err(\"%s: Failed to get parents (%ld)\\n\",\n\t\t\t\t__func__, PTR_ERR(parents));\n\t\tgoto err_parents;\n\t}\n\n\tclk = clk_register_mux(NULL, np->name, parents, num_parents,\n\t\t\t\tdata->clk_flags | CLK_SET_RATE_PARENT,\n\t\t\t\treg + data->offset,\n\t\t\t\tdata->shift, data->width, data->mux_flags,\n\t\t\t\tdata->lock);\n\tif (IS_ERR(clk))\n\t\tgoto err;\n\n\tpr_debug(\"%s: parent %s rate %u\\n\",\n\t\t\t__clk_get_name(clk),\n\t\t\t__clk_get_name(clk_get_parent(clk)),\n\t\t\t(unsigned int)clk_get_rate(clk));\n\n\tkfree(parents);\n\tof_clk_add_provider(np, of_clk_src_simple_get, clk);\n\treturn;\n\nerr:\n\tkfree(parents);\nerr_parents:\n\tiounmap(reg);\n}\n\nstatic void __init st_of_clkgen_a9_mux_setup(struct device_node *np)\n{\n\tst_of_clkgen_mux_setup(np, &stih407_a9_mux_data);\n}\nCLK_OF_DECLARE(clkgen_a9mux, \"st,stih407-clkgen-a9-mux\",\n\t\tst_of_clkgen_a9_mux_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}