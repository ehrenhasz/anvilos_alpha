{
  "module_name": "clk-flexgen.c",
  "hash_id": "59c74c368c576100aef23c4193584dbf47c8af8c0653771595ea9ea7b7293409",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/st/clk-flexgen.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n#include <linux/err.h>\n#include <linux/string.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n\nstruct clkgen_clk_out {\n\tconst char *name;\n\tunsigned long flags;\n};\n\nstruct clkgen_data {\n\tunsigned long flags;\n\tbool mode;\n\tconst struct clkgen_clk_out *outputs;\n\tconst unsigned int outputs_nb;\n};\n\nstruct flexgen {\n\tstruct clk_hw hw;\n\n\t \n\tstruct clk_mux mux;\n\t \n\tstruct clk_gate pgate;\n\t \n\tstruct clk_divider pdiv;\n\t \n\tstruct clk_gate fgate;\n\t \n\tstruct clk_divider fdiv;\n\t \n\tstruct clk_gate sync;\n\t \n\tbool control_mode;\n};\n\n#define to_flexgen(_hw) container_of(_hw, struct flexgen, hw)\n#define to_clk_gate(_hw) container_of(_hw, struct clk_gate, hw)\n\nstatic int flexgen_enable(struct clk_hw *hw)\n{\n\tstruct flexgen *flexgen = to_flexgen(hw);\n\tstruct clk_hw *pgate_hw = &flexgen->pgate.hw;\n\tstruct clk_hw *fgate_hw = &flexgen->fgate.hw;\n\n\t__clk_hw_set_clk(pgate_hw, hw);\n\t__clk_hw_set_clk(fgate_hw, hw);\n\n\tclk_gate_ops.enable(pgate_hw);\n\n\tclk_gate_ops.enable(fgate_hw);\n\n\tpr_debug(\"%s: flexgen output enabled\\n\", clk_hw_get_name(hw));\n\treturn 0;\n}\n\nstatic void flexgen_disable(struct clk_hw *hw)\n{\n\tstruct flexgen *flexgen = to_flexgen(hw);\n\tstruct clk_hw *fgate_hw = &flexgen->fgate.hw;\n\n\t \n\t__clk_hw_set_clk(fgate_hw, hw);\n\n\tclk_gate_ops.disable(fgate_hw);\n\n\tpr_debug(\"%s: flexgen output disabled\\n\", clk_hw_get_name(hw));\n}\n\nstatic int flexgen_is_enabled(struct clk_hw *hw)\n{\n\tstruct flexgen *flexgen = to_flexgen(hw);\n\tstruct clk_hw *fgate_hw = &flexgen->fgate.hw;\n\n\t__clk_hw_set_clk(fgate_hw, hw);\n\n\tif (!clk_gate_ops.is_enabled(fgate_hw))\n\t\treturn 0;\n\n\treturn 1;\n}\n\nstatic u8 flexgen_get_parent(struct clk_hw *hw)\n{\n\tstruct flexgen *flexgen = to_flexgen(hw);\n\tstruct clk_hw *mux_hw = &flexgen->mux.hw;\n\n\t__clk_hw_set_clk(mux_hw, hw);\n\n\treturn clk_mux_ops.get_parent(mux_hw);\n}\n\nstatic int flexgen_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct flexgen *flexgen = to_flexgen(hw);\n\tstruct clk_hw *mux_hw = &flexgen->mux.hw;\n\n\t__clk_hw_set_clk(mux_hw, hw);\n\n\treturn clk_mux_ops.set_parent(mux_hw, index);\n}\n\nstatic inline unsigned long\nclk_best_div(unsigned long parent_rate, unsigned long rate)\n{\n\treturn parent_rate / rate + ((rate > (2*(parent_rate % rate))) ? 0 : 1);\n}\n\nstatic int flexgen_determine_rate(struct clk_hw *hw,\n\t\t\t\t  struct clk_rate_request *req)\n{\n\tunsigned long div;\n\n\t \n\tdiv = clk_best_div(req->best_parent_rate, req->rate);\n\n\tif (clk_hw_get_flags(hw) & CLK_SET_RATE_PARENT) {\n\t\treq->best_parent_rate = req->rate * div;\n\t\treturn 0;\n\t}\n\n\treq->rate = req->best_parent_rate / div;\n\treturn 0;\n}\n\nstatic unsigned long flexgen_recalc_rate(struct clk_hw *hw,\n\t\tunsigned long parent_rate)\n{\n\tstruct flexgen *flexgen = to_flexgen(hw);\n\tstruct clk_hw *pdiv_hw = &flexgen->pdiv.hw;\n\tstruct clk_hw *fdiv_hw = &flexgen->fdiv.hw;\n\tunsigned long mid_rate;\n\n\t__clk_hw_set_clk(pdiv_hw, hw);\n\t__clk_hw_set_clk(fdiv_hw, hw);\n\n\tmid_rate = clk_divider_ops.recalc_rate(pdiv_hw, parent_rate);\n\n\treturn clk_divider_ops.recalc_rate(fdiv_hw, mid_rate);\n}\n\nstatic int flexgen_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\tunsigned long parent_rate)\n{\n\tstruct flexgen *flexgen = to_flexgen(hw);\n\tstruct clk_hw *pdiv_hw = &flexgen->pdiv.hw;\n\tstruct clk_hw *fdiv_hw = &flexgen->fdiv.hw;\n\tstruct clk_hw *sync_hw = &flexgen->sync.hw;\n\tstruct clk_gate *config = to_clk_gate(sync_hw);\n\tunsigned long div = 0;\n\tint ret = 0;\n\tu32 reg;\n\n\t__clk_hw_set_clk(pdiv_hw, hw);\n\t__clk_hw_set_clk(fdiv_hw, hw);\n\n\tif (flexgen->control_mode) {\n\t\treg = readl(config->reg);\n\t\treg &= ~BIT(config->bit_idx);\n\t\twritel(reg, config->reg);\n\t}\n\n\tdiv = clk_best_div(parent_rate, rate);\n\n\t \n\n\tif (div <= 64) {\n\t\tclk_divider_ops.set_rate(pdiv_hw, parent_rate, parent_rate);\n\t\tret = clk_divider_ops.set_rate(fdiv_hw, rate, rate * div);\n\t} else {\n\t\tclk_divider_ops.set_rate(fdiv_hw, parent_rate, parent_rate);\n\t\tret = clk_divider_ops.set_rate(pdiv_hw, rate, rate * div);\n\t}\n\n\treturn ret;\n}\n\nstatic const struct clk_ops flexgen_ops = {\n\t.enable = flexgen_enable,\n\t.disable = flexgen_disable,\n\t.is_enabled = flexgen_is_enabled,\n\t.get_parent = flexgen_get_parent,\n\t.set_parent = flexgen_set_parent,\n\t.determine_rate = flexgen_determine_rate,\n\t.recalc_rate = flexgen_recalc_rate,\n\t.set_rate = flexgen_set_rate,\n};\n\nstatic struct clk *clk_register_flexgen(const char *name,\n\t\t\t\tconst char **parent_names, u8 num_parents,\n\t\t\t\tvoid __iomem *reg, spinlock_t *lock, u32 idx,\n\t\t\t\tunsigned long flexgen_flags, bool mode) {\n\tstruct flexgen *fgxbar;\n\tstruct clk *clk;\n\tstruct clk_init_data init;\n\tu32  xbar_shift;\n\tvoid __iomem *xbar_reg, *fdiv_reg;\n\n\tfgxbar = kzalloc(sizeof(struct flexgen), GFP_KERNEL);\n\tif (!fgxbar)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit.name = name;\n\tinit.ops = &flexgen_ops;\n\tinit.flags = CLK_GET_RATE_NOCACHE | flexgen_flags;\n\tinit.parent_names = parent_names;\n\tinit.num_parents = num_parents;\n\n\txbar_reg = reg + 0x18 + (idx & ~0x3);\n\txbar_shift = (idx % 4) * 0x8;\n\tfdiv_reg = reg + 0x164 + idx * 4;\n\n\t \n\tfgxbar->mux.lock = lock;\n\tfgxbar->mux.mask = BIT(6) - 1;\n\tfgxbar->mux.reg = xbar_reg;\n\tfgxbar->mux.shift = xbar_shift;\n\tfgxbar->mux.table = NULL;\n\n\n\t \n\tfgxbar->pgate.lock = lock;\n\tfgxbar->pgate.reg = xbar_reg;\n\tfgxbar->pgate.bit_idx = xbar_shift + 6;\n\n\t \n\tfgxbar->pdiv.lock = lock;\n\tfgxbar->pdiv.reg = reg + 0x58 + idx * 4;\n\tfgxbar->pdiv.width = 10;\n\n\t \n\tfgxbar->fgate.lock = lock;\n\tfgxbar->fgate.reg = fdiv_reg;\n\tfgxbar->fgate.bit_idx = 6;\n\n\t \n\tfgxbar->fdiv.lock = lock;\n\tfgxbar->fdiv.reg = fdiv_reg;\n\tfgxbar->fdiv.width = 6;\n\n\t \n\tfgxbar->sync.lock = lock;\n\tfgxbar->sync.reg = fdiv_reg;\n\tfgxbar->sync.bit_idx = 7;\n\n\tfgxbar->control_mode = mode;\n\n\tfgxbar->hw.init = &init;\n\n\tclk = clk_register(NULL, &fgxbar->hw);\n\tif (IS_ERR(clk))\n\t\tkfree(fgxbar);\n\telse\n\t\tpr_debug(\"%s: parent %s rate %u\\n\",\n\t\t\t__clk_get_name(clk),\n\t\t\t__clk_get_name(clk_get_parent(clk)),\n\t\t\t(unsigned int)clk_get_rate(clk));\n\treturn clk;\n}\n\nstatic const char ** __init flexgen_get_parents(struct device_node *np,\n\t\t\t\t\t\t       int *num_parents)\n{\n\tconst char **parents;\n\tunsigned int nparents;\n\n\tnparents = of_clk_get_parent_count(np);\n\tif (WARN_ON(!nparents))\n\t\treturn NULL;\n\n\tparents = kcalloc(nparents, sizeof(const char *), GFP_KERNEL);\n\tif (!parents)\n\t\treturn NULL;\n\n\t*num_parents = of_clk_parent_fill(np, parents, nparents);\n\n\treturn parents;\n}\n\nstatic const struct clkgen_data clkgen_audio = {\n\t.flags = CLK_SET_RATE_PARENT,\n};\n\nstatic const struct clkgen_data clkgen_video = {\n\t.flags = CLK_SET_RATE_PARENT,\n\t.mode = 1,\n};\n\nstatic const struct clkgen_clk_out clkgen_stih407_a0_clk_out[] = {\n\t \n\t{ .name = \"clk-ic-lmi0\", .flags = CLK_IS_CRITICAL },\n};\n\nstatic const struct clkgen_data clkgen_stih407_a0 = {\n\t.outputs = clkgen_stih407_a0_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih407_a0_clk_out),\n};\n\nstatic const struct clkgen_clk_out clkgen_stih410_a0_clk_out[] = {\n\t \n\t{ .name = \"clk-ic-lmi0\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-ic-lmi1\", .flags = CLK_IS_CRITICAL },\n};\n\nstatic const struct clkgen_data clkgen_stih410_a0 = {\n\t.outputs = clkgen_stih410_a0_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih410_a0_clk_out),\n};\n\nstatic const struct clkgen_clk_out clkgen_stih407_c0_clk_out[] = {\n\t{ .name = \"clk-icn-gpu\", },\n\t{ .name = \"clk-fdma\", },\n\t{ .name = \"clk-nand\", },\n\t{ .name = \"clk-hva\", },\n\t{ .name = \"clk-proc-stfe\", },\n\t{ .name = \"clk-proc-tp\", },\n\t{ .name = \"clk-rx-icn-dmu\", },\n\t{ .name = \"clk-rx-icn-hva\", },\n\t \n\t{ .name = \"clk-icn-cpu\", .flags = CLK_IS_CRITICAL },\n\t \n\t{ .name = \"clk-tx-icn-dmu\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-mmc-0\", },\n\t{ .name = \"clk-mmc-1\", },\n\t{ .name = \"clk-jpegdec\", },\n\t \n\t{ .name = \"clk-ext2fa9\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-ic-bdisp-0\", },\n\t{ .name = \"clk-ic-bdisp-1\", },\n\t{ .name = \"clk-pp-dmu\", },\n\t{ .name = \"clk-vid-dmu\", },\n\t{ .name = \"clk-dss-lpc\", },\n\t{ .name = \"clk-st231-aud-0\", },\n\t{ .name = \"clk-st231-gp-1\", },\n\t{ .name = \"clk-st231-dmu\", },\n\t \n\t{ .name = \"clk-icn-lmi\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-tx-icn-disp-1\", },\n\t \n\t{ .name = \"clk-icn-sbc\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-stfe-frc2\", },\n\t{ .name = \"clk-eth-phy\", },\n\t{ .name = \"clk-eth-ref-phyclk\", },\n\t{ .name = \"clk-flash-promip\", },\n\t{ .name = \"clk-main-disp\", },\n\t{ .name = \"clk-aux-disp\", },\n\t{ .name = \"clk-compo-dvp\", },\n};\n\nstatic const struct clkgen_data clkgen_stih407_c0 = {\n\t.outputs = clkgen_stih407_c0_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih407_c0_clk_out),\n};\n\nstatic const struct clkgen_clk_out clkgen_stih410_c0_clk_out[] = {\n\t{ .name = \"clk-icn-gpu\", },\n\t{ .name = \"clk-fdma\", },\n\t{ .name = \"clk-nand\", },\n\t{ .name = \"clk-hva\", },\n\t{ .name = \"clk-proc-stfe\", },\n\t{ .name = \"clk-proc-tp\", },\n\t{ .name = \"clk-rx-icn-dmu\", },\n\t{ .name = \"clk-rx-icn-hva\", },\n\t \n\t{ .name = \"clk-icn-cpu\", .flags = CLK_IS_CRITICAL },\n\t \n\t{ .name = \"clk-tx-icn-dmu\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-mmc-0\", },\n\t{ .name = \"clk-mmc-1\", },\n\t{ .name = \"clk-jpegdec\", },\n\t \n\t{ .name = \"clk-ext2fa9\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-ic-bdisp-0\", },\n\t{ .name = \"clk-ic-bdisp-1\", },\n\t{ .name = \"clk-pp-dmu\", },\n\t{ .name = \"clk-vid-dmu\", },\n\t{ .name = \"clk-dss-lpc\", },\n\t{ .name = \"clk-st231-aud-0\", },\n\t{ .name = \"clk-st231-gp-1\", },\n\t{ .name = \"clk-st231-dmu\", },\n\t \n\t{ .name = \"clk-icn-lmi\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-tx-icn-disp-1\", },\n\t \n\t{ .name = \"clk-icn-sbc\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-stfe-frc2\", },\n\t{ .name = \"clk-eth-phy\", },\n\t{ .name = \"clk-eth-ref-phyclk\", },\n\t{ .name = \"clk-flash-promip\", },\n\t{ .name = \"clk-main-disp\", },\n\t{ .name = \"clk-aux-disp\", },\n\t{ .name = \"clk-compo-dvp\", },\n\t{ .name = \"clk-tx-icn-hades\", },\n\t{ .name = \"clk-rx-icn-hades\", },\n\t \n\t{ .name = \"clk-icn-reg-16\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-pp-hades\", },\n\t{ .name = \"clk-clust-hades\", },\n\t{ .name = \"clk-hwpe-hades\", },\n\t{ .name = \"clk-fc-hades\", },\n};\n\nstatic const struct clkgen_data clkgen_stih410_c0 = {\n\t.outputs = clkgen_stih410_c0_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih410_c0_clk_out),\n};\n\nstatic const struct clkgen_clk_out clkgen_stih418_c0_clk_out[] = {\n\t{ .name = \"clk-icn-gpu\", },\n\t{ .name = \"clk-fdma\", },\n\t{ .name = \"clk-nand\", },\n\t{ .name = \"clk-hva\", },\n\t{ .name = \"clk-proc-stfe\", },\n\t{ .name = \"clk-tp\", },\n\t \n\t{ .name = \"clk-rx-icn-dmu\", .flags = CLK_IS_CRITICAL },\n\t \n\t{ .name = \"clk-rx-icn-hva\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-icn-cpu\", .flags = CLK_IS_CRITICAL },\n\t \n\t{ .name = \"clk-tx-icn-dmu\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-mmc-0\", },\n\t{ .name = \"clk-mmc-1\", },\n\t{ .name = \"clk-jpegdec\", },\n\t \n\t{ .name = \"clk-icn-reg\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-proc-bdisp-0\", },\n\t{ .name = \"clk-proc-bdisp-1\", },\n\t{ .name = \"clk-pp-dmu\", },\n\t{ .name = \"clk-vid-dmu\", },\n\t{ .name = \"clk-dss-lpc\", },\n\t{ .name = \"clk-st231-aud-0\", },\n\t{ .name = \"clk-st231-gp-1\", },\n\t{ .name = \"clk-st231-dmu\", },\n\t \n\t{ .name = \"clk-icn-lmi\", .flags = CLK_IS_CRITICAL },\n\t \n\t{ .name = \"clk-tx-icn-1\", .flags = CLK_IS_CRITICAL },\n\t \n\t{ .name = \"clk-icn-sbc\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-stfe-frc2\", },\n\t{ .name = \"clk-eth-phyref\", },\n\t{ .name = \"clk-eth-ref-phyclk\", },\n\t{ .name = \"clk-flash-promip\", },\n\t{ .name = \"clk-main-disp\", },\n\t{ .name = \"clk-aux-disp\", },\n\t{ .name = \"clk-compo-dvp\", },\n\t \n\t{ .name = \"clk-tx-icn-hades\", .flags = CLK_IS_CRITICAL },\n\t \n\t{ .name = \"clk-rx-icn-hades\", .flags = CLK_IS_CRITICAL },\n\t \n\t{ .name = \"clk-icn-reg-16\", .flags = CLK_IS_CRITICAL },\n\t{ .name = \"clk-pp-hevc\", },\n\t{ .name = \"clk-clust-hevc\", },\n\t{ .name = \"clk-hwpe-hevc\", },\n\t{ .name = \"clk-fc-hevc\", },\n\t{ .name = \"clk-proc-mixer\", },\n\t{ .name = \"clk-proc-sc\", },\n\t{ .name = \"clk-avsp-hevc\", },\n};\n\nstatic const struct clkgen_data clkgen_stih418_c0 = {\n\t.outputs = clkgen_stih418_c0_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih418_c0_clk_out),\n};\n\nstatic const struct clkgen_clk_out clkgen_stih407_d0_clk_out[] = {\n\t{ .name = \"clk-pcm-0\", },\n\t{ .name = \"clk-pcm-1\", },\n\t{ .name = \"clk-pcm-2\", },\n\t{ .name = \"clk-spdiff\", },\n};\n\nstatic const struct clkgen_data clkgen_stih407_d0 = {\n\t.flags = CLK_SET_RATE_PARENT,\n\t.outputs = clkgen_stih407_d0_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih407_d0_clk_out),\n};\n\nstatic const struct clkgen_clk_out clkgen_stih410_d0_clk_out[] = {\n\t{ .name = \"clk-pcm-0\", },\n\t{ .name = \"clk-pcm-1\", },\n\t{ .name = \"clk-pcm-2\", },\n\t{ .name = \"clk-spdiff\", },\n\t{ .name = \"clk-pcmr10-master\", },\n\t{ .name = \"clk-usb2-phy\", },\n};\n\nstatic const struct clkgen_data clkgen_stih410_d0 = {\n\t.flags = CLK_SET_RATE_PARENT,\n\t.outputs = clkgen_stih410_d0_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih410_d0_clk_out),\n};\n\nstatic const struct clkgen_clk_out clkgen_stih407_d2_clk_out[] = {\n\t{ .name = \"clk-pix-main-disp\", },\n\t{ .name = \"clk-pix-pip\", },\n\t{ .name = \"clk-pix-gdp1\", },\n\t{ .name = \"clk-pix-gdp2\", },\n\t{ .name = \"clk-pix-gdp3\", },\n\t{ .name = \"clk-pix-gdp4\", },\n\t{ .name = \"clk-pix-aux-disp\", },\n\t{ .name = \"clk-denc\", },\n\t{ .name = \"clk-pix-hddac\", },\n\t{ .name = \"clk-hddac\", },\n\t{ .name = \"clk-sddac\", },\n\t{ .name = \"clk-pix-dvo\", },\n\t{ .name = \"clk-dvo\", },\n\t{ .name = \"clk-pix-hdmi\", },\n\t{ .name = \"clk-tmds-hdmi\", },\n\t{ .name = \"clk-ref-hdmiphy\", },\n};\n\nstatic const struct clkgen_data clkgen_stih407_d2 = {\n\t.outputs = clkgen_stih407_d2_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih407_d2_clk_out),\n\t.flags = CLK_SET_RATE_PARENT,\n\t.mode = 1,\n};\n\nstatic const struct clkgen_clk_out clkgen_stih418_d2_clk_out[] = {\n\t{ .name = \"clk-pix-main-disp\", },\n\t{ .name = \"\", },\n\t{ .name = \"\", },\n\t{ .name = \"\", },\n\t{ .name = \"\", },\n\t{ .name = \"clk-tmds-hdmi-div2\", },\n\t{ .name = \"clk-pix-aux-disp\", },\n\t{ .name = \"clk-denc\", },\n\t{ .name = \"clk-pix-hddac\", },\n\t{ .name = \"clk-hddac\", },\n\t{ .name = \"clk-sddac\", },\n\t{ .name = \"clk-pix-dvo\", },\n\t{ .name = \"clk-dvo\", },\n\t{ .name = \"clk-pix-hdmi\", },\n\t{ .name = \"clk-tmds-hdmi\", },\n\t{ .name = \"clk-ref-hdmiphy\", },\n\t{ .name = \"\", }, { .name = \"\", }, { .name = \"\", }, { .name = \"\", },\n\t{ .name = \"\", }, { .name = \"\", }, { .name = \"\", }, { .name = \"\", },\n\t{ .name = \"\", }, { .name = \"\", }, { .name = \"\", }, { .name = \"\", },\n\t{ .name = \"\", }, { .name = \"\", }, { .name = \"\", }, { .name = \"\", },\n\t{ .name = \"\", }, { .name = \"\", }, { .name = \"\", }, { .name = \"\", },\n\t{ .name = \"\", }, { .name = \"\", }, { .name = \"\", }, { .name = \"\", },\n\t{ .name = \"\", }, { .name = \"\", }, { .name = \"\", }, { .name = \"\", },\n\t{ .name = \"\", }, { .name = \"\", }, { .name = \"\", },\n\t{ .name = \"clk-vp9\", },\n};\n\nstatic const struct clkgen_data clkgen_stih418_d2 = {\n\t.outputs = clkgen_stih418_d2_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih418_d2_clk_out),\n\t.flags = CLK_SET_RATE_PARENT,\n\t.mode = 1,\n};\n\nstatic const struct clkgen_clk_out clkgen_stih407_d3_clk_out[] = {\n\t{ .name = \"clk-stfe-frc1\", },\n\t{ .name = \"clk-tsout-0\", },\n\t{ .name = \"clk-tsout-1\", },\n\t{ .name = \"clk-mchi\", },\n\t{ .name = \"clk-vsens-compo\", },\n\t{ .name = \"clk-frc1-remote\", },\n\t{ .name = \"clk-lpc-0\", },\n\t{ .name = \"clk-lpc-1\", },\n};\n\nstatic const struct clkgen_data clkgen_stih407_d3 = {\n\t.outputs = clkgen_stih407_d3_clk_out,\n\t.outputs_nb = ARRAY_SIZE(clkgen_stih407_d3_clk_out),\n};\n\nstatic const struct of_device_id flexgen_of_match[] = {\n\t{\n\t\t.compatible = \"st,flexgen-audio\",\n\t\t.data = &clkgen_audio,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-video\",\n\t\t.data = &clkgen_video,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih407-a0\",\n\t\t.data = &clkgen_stih407_a0,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih410-a0\",\n\t\t.data = &clkgen_stih410_a0,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih407-c0\",\n\t\t.data = &clkgen_stih407_c0,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih410-c0\",\n\t\t.data = &clkgen_stih410_c0,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih418-c0\",\n\t\t.data = &clkgen_stih418_c0,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih407-d0\",\n\t\t.data = &clkgen_stih407_d0,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih410-d0\",\n\t\t.data = &clkgen_stih410_d0,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih407-d2\",\n\t\t.data = &clkgen_stih407_d2,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih418-d2\",\n\t\t.data = &clkgen_stih418_d2,\n\t},\n\t{\n\t\t.compatible = \"st,flexgen-stih407-d3\",\n\t\t.data = &clkgen_stih407_d3,\n\t},\n\t{}\n};\n\nstatic void __init st_of_flexgen_setup(struct device_node *np)\n{\n\tstruct device_node *pnode;\n\tvoid __iomem *reg;\n\tstruct clk_onecell_data *clk_data;\n\tconst char **parents;\n\tint num_parents, i;\n\tspinlock_t *rlock = NULL;\n\tconst struct of_device_id *match;\n\tstruct clkgen_data *data = NULL;\n\tunsigned long flex_flags = 0;\n\tint ret;\n\tbool clk_mode = 0;\n\tconst char *clk_name;\n\n\tpnode = of_get_parent(np);\n\tif (!pnode)\n\t\treturn;\n\n\treg = of_iomap(pnode, 0);\n\tof_node_put(pnode);\n\tif (!reg)\n\t\treturn;\n\n\tparents = flexgen_get_parents(np, &num_parents);\n\tif (!parents) {\n\t\tiounmap(reg);\n\t\treturn;\n\t}\n\n\tmatch = of_match_node(flexgen_of_match, np);\n\tif (match) {\n\t\tdata = (struct clkgen_data *)match->data;\n\t\tflex_flags = data->flags;\n\t\tclk_mode = data->mode;\n\t}\n\n\tclk_data = kzalloc(sizeof(*clk_data), GFP_KERNEL);\n\tif (!clk_data)\n\t\tgoto err;\n\n\t \n\tif (!data || !data->outputs_nb || !data->outputs) {\n\t\tret = of_property_count_strings(np, \"clock-output-names\");\n\t\tif (ret <= 0) {\n\t\t\tpr_err(\"%s: Failed to get number of output clocks (%d)\",\n\t\t\t\t\t__func__, clk_data->clk_num);\n\t\t\tgoto err;\n\t\t}\n\t\tclk_data->clk_num = ret;\n\t} else\n\t\tclk_data->clk_num = data->outputs_nb;\n\n\tclk_data->clks = kcalloc(clk_data->clk_num, sizeof(struct clk *),\n\t\t\tGFP_KERNEL);\n\tif (!clk_data->clks)\n\t\tgoto err;\n\n\trlock = kzalloc(sizeof(spinlock_t), GFP_KERNEL);\n\tif (!rlock)\n\t\tgoto err;\n\n\tspin_lock_init(rlock);\n\n\tfor (i = 0; i < clk_data->clk_num; i++) {\n\t\tstruct clk *clk;\n\n\t\tif (!data || !data->outputs_nb || !data->outputs) {\n\t\t\tif (of_property_read_string_index(np,\n\t\t\t\t\t\t\t  \"clock-output-names\",\n\t\t\t\t\t\t\t  i, &clk_name))\n\t\t\t\tbreak;\n\t\t\tflex_flags &= ~CLK_IS_CRITICAL;\n\t\t\tof_clk_detect_critical(np, i, &flex_flags);\n\t\t} else {\n\t\t\tclk_name = data->outputs[i].name;\n\t\t\tflex_flags = data->flags | data->outputs[i].flags;\n\t\t}\n\n\t\t \n\t\tif (*clk_name == '\\0')\n\t\t\tcontinue;\n\n\t\tclk = clk_register_flexgen(clk_name, parents, num_parents,\n\t\t\t\t\t   reg, rlock, i, flex_flags, clk_mode);\n\n\t\tif (IS_ERR(clk))\n\t\t\tgoto err;\n\n\t\tclk_data->clks[i] = clk;\n\t}\n\n\tkfree(parents);\n\tof_clk_add_provider(np, of_clk_src_onecell_get, clk_data);\n\n\treturn;\n\nerr:\n\tiounmap(reg);\n\tif (clk_data)\n\t\tkfree(clk_data->clks);\n\tkfree(clk_data);\n\tkfree(parents);\n\tkfree(rlock);\n}\nCLK_OF_DECLARE(flexgen, \"st,flexgen\", st_of_flexgen_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}