{
  "module_name": "clk-imx27.c",
  "hash_id": "dab2784cc5a988744c023036c5465650831b3aa239dfb3b72c9156d53a488a7e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/imx/clk-imx27.c",
  "human_readable_source": "\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/clkdev.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <dt-bindings/clock/imx27-clock.h>\n#include <soc/imx/revision.h>\n#include <asm/irq.h>\n\n#include \"clk.h\"\n\n#define MX27_CCM_BASE_ADDR\t0x10027000\n#define MX27_GPT1_BASE_ADDR\t0x10003000\n#define MX27_INT_GPT1\t\t(NR_IRQS_LEGACY + 26)\n\nstatic void __iomem *ccm __initdata;\n\n \n#define CCM_CSCR\t\t(ccm + 0x00)\n#define CCM_MPCTL0\t\t(ccm + 0x04)\n#define CCM_MPCTL1\t\t(ccm + 0x08)\n#define CCM_SPCTL0\t\t(ccm + 0x0c)\n#define CCM_SPCTL1\t\t(ccm + 0x10)\n#define CCM_PCDR0\t\t(ccm + 0x18)\n#define CCM_PCDR1\t\t(ccm + 0x1c)\n#define CCM_PCCR0\t\t(ccm + 0x20)\n#define CCM_PCCR1\t\t(ccm + 0x24)\n#define CCM_CCSR\t\t(ccm + 0x28)\n\nstatic const char *vpu_sel_clks[] = { \"spll\", \"mpll_main2\", };\nstatic const char *cpu_sel_clks[] = { \"mpll_main2\", \"mpll\", };\nstatic const char *mpll_sel_clks[] = { \"fpm\", \"mpll_osc_sel\", };\nstatic const char *mpll_osc_sel_clks[] = { \"ckih_gate\", \"ckih_div1p5\", };\nstatic const char *clko_sel_clks[] = {\n\t\"ckil\", \"fpm\", \"ckih_gate\", \"ckih_gate\",\n\t\"ckih_gate\", \"mpll\", \"spll\", \"cpu_div\",\n\t\"ahb\", \"ipg\", \"per1_div\", \"per2_div\",\n\t\"per3_div\", \"per4_div\", \"ssi1_div\", \"ssi2_div\",\n\t\"nfc_div\", \"mshc_div\", \"vpu_div\", \"60m\",\n\t\"32k\", \"usb_div\", \"dptc\",\n};\n\nstatic const char *ssi_sel_clks[] = { \"spll_gate\", \"mpll\", };\n\nstatic struct clk *clk[IMX27_CLK_MAX];\nstatic struct clk_onecell_data clk_data;\n\nstatic void __init _mx27_clocks_init(unsigned long fref)\n{\n\tBUG_ON(!ccm);\n\n\tclk[IMX27_CLK_DUMMY] = imx_clk_fixed(\"dummy\", 0);\n\tclk[IMX27_CLK_CKIH] = imx_clk_fixed(\"ckih\", fref);\n\tclk[IMX27_CLK_CKIL] = imx_clk_fixed(\"ckil\", 32768);\n\tclk[IMX27_CLK_FPM] = imx_clk_fixed_factor(\"fpm\", \"ckil\", 1024, 1);\n\tclk[IMX27_CLK_CKIH_DIV1P5] = imx_clk_fixed_factor(\"ckih_div1p5\", \"ckih_gate\", 2, 3);\n\tclk[IMX27_CLK_CKIH_GATE] = imx_clk_gate_dis(\"ckih_gate\", \"ckih\", CCM_CSCR, 3);\n\tclk[IMX27_CLK_MPLL_OSC_SEL] = imx_clk_mux(\"mpll_osc_sel\", CCM_CSCR, 4, 1, mpll_osc_sel_clks, ARRAY_SIZE(mpll_osc_sel_clks));\n\tclk[IMX27_CLK_MPLL_SEL] = imx_clk_mux(\"mpll_sel\", CCM_CSCR, 16, 1, mpll_sel_clks, ARRAY_SIZE(mpll_sel_clks));\n\tclk[IMX27_CLK_MPLL] = imx_clk_pllv1(IMX_PLLV1_IMX27, \"mpll\", \"mpll_sel\", CCM_MPCTL0);\n\tclk[IMX27_CLK_SPLL] = imx_clk_pllv1(IMX_PLLV1_IMX27, \"spll\", \"ckih_gate\", CCM_SPCTL0);\n\tclk[IMX27_CLK_SPLL_GATE] = imx_clk_gate(\"spll_gate\", \"spll\", CCM_CSCR, 1);\n\tclk[IMX27_CLK_MPLL_MAIN2] = imx_clk_fixed_factor(\"mpll_main2\", \"mpll\", 2, 3);\n\n\tif (mx27_revision() >= IMX_CHIP_REVISION_2_0) {\n\t\tclk[IMX27_CLK_AHB] = imx_clk_divider(\"ahb\", \"mpll_main2\", CCM_CSCR, 8, 2);\n\t\tclk[IMX27_CLK_IPG] = imx_clk_fixed_factor(\"ipg\", \"ahb\", 1, 2);\n\t} else {\n\t\tclk[IMX27_CLK_AHB] = imx_clk_divider(\"ahb\", \"mpll_main2\", CCM_CSCR, 9, 4);\n\t\tclk[IMX27_CLK_IPG] = imx_clk_divider(\"ipg\", \"ahb\", CCM_CSCR, 8, 1);\n\t}\n\n\tclk[IMX27_CLK_MSHC_DIV] = imx_clk_divider(\"mshc_div\", \"ahb\", CCM_PCDR0, 0, 6);\n\tclk[IMX27_CLK_NFC_DIV] = imx_clk_divider(\"nfc_div\", \"ahb\", CCM_PCDR0, 6, 4);\n\tclk[IMX27_CLK_PER1_DIV] = imx_clk_divider(\"per1_div\", \"mpll_main2\", CCM_PCDR1, 0, 6);\n\tclk[IMX27_CLK_PER2_DIV] = imx_clk_divider(\"per2_div\", \"mpll_main2\", CCM_PCDR1, 8, 6);\n\tclk[IMX27_CLK_PER3_DIV] = imx_clk_divider(\"per3_div\", \"mpll_main2\", CCM_PCDR1, 16, 6);\n\tclk[IMX27_CLK_PER4_DIV] = imx_clk_divider(\"per4_div\", \"mpll_main2\", CCM_PCDR1, 24, 6);\n\tclk[IMX27_CLK_VPU_SEL] = imx_clk_mux(\"vpu_sel\", CCM_CSCR, 21, 1, vpu_sel_clks, ARRAY_SIZE(vpu_sel_clks));\n\tclk[IMX27_CLK_VPU_DIV] = imx_clk_divider(\"vpu_div\", \"vpu_sel\", CCM_PCDR0, 10, 6);\n\tclk[IMX27_CLK_USB_DIV] = imx_clk_divider(\"usb_div\", \"spll_gate\", CCM_CSCR, 28, 3);\n\tclk[IMX27_CLK_CPU_SEL] = imx_clk_mux(\"cpu_sel\", CCM_CSCR, 15, 1, cpu_sel_clks, ARRAY_SIZE(cpu_sel_clks));\n\tclk[IMX27_CLK_CLKO_SEL] = imx_clk_mux(\"clko_sel\", CCM_CCSR, 0, 5, clko_sel_clks, ARRAY_SIZE(clko_sel_clks));\n\n\tif (mx27_revision() >= IMX_CHIP_REVISION_2_0)\n\t\tclk[IMX27_CLK_CPU_DIV] = imx_clk_divider(\"cpu_div\", \"cpu_sel\", CCM_CSCR, 12, 2);\n\telse\n\t\tclk[IMX27_CLK_CPU_DIV] = imx_clk_divider(\"cpu_div\", \"cpu_sel\", CCM_CSCR, 13, 3);\n\n\tclk[IMX27_CLK_CLKO_DIV] = imx_clk_divider(\"clko_div\", \"clko_sel\", CCM_PCDR0, 22, 3);\n\tclk[IMX27_CLK_SSI1_SEL] = imx_clk_mux(\"ssi1_sel\", CCM_CSCR, 22, 1, ssi_sel_clks, ARRAY_SIZE(ssi_sel_clks));\n\tclk[IMX27_CLK_SSI2_SEL] = imx_clk_mux(\"ssi2_sel\", CCM_CSCR, 23, 1, ssi_sel_clks, ARRAY_SIZE(ssi_sel_clks));\n\tclk[IMX27_CLK_SSI1_DIV] = imx_clk_divider(\"ssi1_div\", \"ssi1_sel\", CCM_PCDR0, 16, 6);\n\tclk[IMX27_CLK_SSI2_DIV] = imx_clk_divider(\"ssi2_div\", \"ssi2_sel\", CCM_PCDR0, 26, 6);\n\tclk[IMX27_CLK_CLKO_EN] = imx_clk_gate(\"clko_en\", \"clko_div\", CCM_PCCR0, 0);\n\tclk[IMX27_CLK_SSI2_IPG_GATE] = imx_clk_gate(\"ssi2_ipg_gate\", \"ipg\", CCM_PCCR0, 0);\n\tclk[IMX27_CLK_SSI1_IPG_GATE] = imx_clk_gate(\"ssi1_ipg_gate\", \"ipg\", CCM_PCCR0, 1);\n\tclk[IMX27_CLK_SLCDC_IPG_GATE] = imx_clk_gate(\"slcdc_ipg_gate\", \"ipg\", CCM_PCCR0, 2);\n\tclk[IMX27_CLK_SDHC3_IPG_GATE] = imx_clk_gate(\"sdhc3_ipg_gate\", \"ipg\", CCM_PCCR0, 3);\n\tclk[IMX27_CLK_SDHC2_IPG_GATE] = imx_clk_gate(\"sdhc2_ipg_gate\", \"ipg\", CCM_PCCR0, 4);\n\tclk[IMX27_CLK_SDHC1_IPG_GATE] = imx_clk_gate(\"sdhc1_ipg_gate\", \"ipg\", CCM_PCCR0, 5);\n\tclk[IMX27_CLK_SCC_IPG_GATE] = imx_clk_gate(\"scc_ipg_gate\", \"ipg\", CCM_PCCR0, 6);\n\tclk[IMX27_CLK_SAHARA_IPG_GATE] = imx_clk_gate(\"sahara_ipg_gate\", \"ipg\", CCM_PCCR0, 7);\n\tclk[IMX27_CLK_RTIC_IPG_GATE] = imx_clk_gate(\"rtic_ipg_gate\", \"ipg\", CCM_PCCR0, 8);\n\tclk[IMX27_CLK_RTC_IPG_GATE] = imx_clk_gate(\"rtc_ipg_gate\", \"ipg\", CCM_PCCR0, 9);\n\tclk[IMX27_CLK_PWM_IPG_GATE] = imx_clk_gate(\"pwm_ipg_gate\", \"ipg\", CCM_PCCR0, 11);\n\tclk[IMX27_CLK_OWIRE_IPG_GATE] = imx_clk_gate(\"owire_ipg_gate\", \"ipg\", CCM_PCCR0, 12);\n\tclk[IMX27_CLK_MSHC_IPG_GATE] = imx_clk_gate(\"mshc_ipg_gate\", \"ipg\", CCM_PCCR0, 13);\n\tclk[IMX27_CLK_LCDC_IPG_GATE] = imx_clk_gate(\"lcdc_ipg_gate\", \"ipg\", CCM_PCCR0, 14);\n\tclk[IMX27_CLK_KPP_IPG_GATE] = imx_clk_gate(\"kpp_ipg_gate\", \"ipg\", CCM_PCCR0, 15);\n\tclk[IMX27_CLK_IIM_IPG_GATE] = imx_clk_gate(\"iim_ipg_gate\", \"ipg\", CCM_PCCR0, 16);\n\tclk[IMX27_CLK_I2C2_IPG_GATE] = imx_clk_gate(\"i2c2_ipg_gate\", \"ipg\", CCM_PCCR0, 17);\n\tclk[IMX27_CLK_I2C1_IPG_GATE] = imx_clk_gate(\"i2c1_ipg_gate\", \"ipg\", CCM_PCCR0, 18);\n\tclk[IMX27_CLK_GPT6_IPG_GATE] = imx_clk_gate(\"gpt6_ipg_gate\", \"ipg\", CCM_PCCR0, 19);\n\tclk[IMX27_CLK_GPT5_IPG_GATE] = imx_clk_gate(\"gpt5_ipg_gate\", \"ipg\", CCM_PCCR0, 20);\n\tclk[IMX27_CLK_GPT4_IPG_GATE] = imx_clk_gate(\"gpt4_ipg_gate\", \"ipg\", CCM_PCCR0, 21);\n\tclk[IMX27_CLK_GPT3_IPG_GATE] = imx_clk_gate(\"gpt3_ipg_gate\", \"ipg\", CCM_PCCR0, 22);\n\tclk[IMX27_CLK_GPT2_IPG_GATE] = imx_clk_gate(\"gpt2_ipg_gate\", \"ipg\", CCM_PCCR0, 23);\n\tclk[IMX27_CLK_GPT1_IPG_GATE] = imx_clk_gate(\"gpt1_ipg_gate\", \"ipg\", CCM_PCCR0, 24);\n\tclk[IMX27_CLK_GPIO_IPG_GATE] = imx_clk_gate(\"gpio_ipg_gate\", \"ipg\", CCM_PCCR0, 25);\n\tclk[IMX27_CLK_FEC_IPG_GATE] = imx_clk_gate(\"fec_ipg_gate\", \"ipg\", CCM_PCCR0, 26);\n\tclk[IMX27_CLK_EMMA_IPG_GATE] = imx_clk_gate(\"emma_ipg_gate\", \"ipg\", CCM_PCCR0, 27);\n\tclk[IMX27_CLK_DMA_IPG_GATE] = imx_clk_gate(\"dma_ipg_gate\", \"ipg\", CCM_PCCR0, 28);\n\tclk[IMX27_CLK_CSPI3_IPG_GATE] = imx_clk_gate(\"cspi3_ipg_gate\", \"ipg\", CCM_PCCR0, 29);\n\tclk[IMX27_CLK_CSPI2_IPG_GATE] = imx_clk_gate(\"cspi2_ipg_gate\", \"ipg\", CCM_PCCR0, 30);\n\tclk[IMX27_CLK_CSPI1_IPG_GATE] = imx_clk_gate(\"cspi1_ipg_gate\", \"ipg\", CCM_PCCR0, 31);\n\tclk[IMX27_CLK_MSHC_BAUD_GATE] = imx_clk_gate(\"mshc_baud_gate\", \"mshc_div\", CCM_PCCR1, 2);\n\tclk[IMX27_CLK_NFC_BAUD_GATE] = imx_clk_gate(\"nfc_baud_gate\", \"nfc_div\", CCM_PCCR1,  3);\n\tclk[IMX27_CLK_SSI2_BAUD_GATE] = imx_clk_gate(\"ssi2_baud_gate\", \"ssi2_div\", CCM_PCCR1,  4);\n\tclk[IMX27_CLK_SSI1_BAUD_GATE] = imx_clk_gate(\"ssi1_baud_gate\", \"ssi1_div\", CCM_PCCR1,  5);\n\tclk[IMX27_CLK_VPU_BAUD_GATE] = imx_clk_gate(\"vpu_baud_gate\", \"vpu_div\", CCM_PCCR1,  6);\n\tclk[IMX27_CLK_PER4_GATE] = imx_clk_gate(\"per4_gate\", \"per4_div\", CCM_PCCR1,  7);\n\tclk[IMX27_CLK_PER3_GATE] = imx_clk_gate(\"per3_gate\", \"per3_div\", CCM_PCCR1,  8);\n\tclk[IMX27_CLK_PER2_GATE] = imx_clk_gate(\"per2_gate\", \"per2_div\", CCM_PCCR1,  9);\n\tclk[IMX27_CLK_PER1_GATE] = imx_clk_gate(\"per1_gate\", \"per1_div\", CCM_PCCR1, 10);\n\tclk[IMX27_CLK_USB_AHB_GATE] = imx_clk_gate(\"usb_ahb_gate\", \"ahb\", CCM_PCCR1, 11);\n\tclk[IMX27_CLK_SLCDC_AHB_GATE] = imx_clk_gate(\"slcdc_ahb_gate\", \"ahb\", CCM_PCCR1, 12);\n\tclk[IMX27_CLK_SAHARA_AHB_GATE] = imx_clk_gate(\"sahara_ahb_gate\", \"ahb\", CCM_PCCR1, 13);\n\tclk[IMX27_CLK_RTIC_AHB_GATE] = imx_clk_gate(\"rtic_ahb_gate\", \"ahb\", CCM_PCCR1, 14);\n\tclk[IMX27_CLK_LCDC_AHB_GATE] = imx_clk_gate(\"lcdc_ahb_gate\", \"ahb\", CCM_PCCR1, 15);\n\tclk[IMX27_CLK_VPU_AHB_GATE] = imx_clk_gate(\"vpu_ahb_gate\", \"ahb\", CCM_PCCR1, 16);\n\tclk[IMX27_CLK_FEC_AHB_GATE] = imx_clk_gate(\"fec_ahb_gate\", \"ahb\", CCM_PCCR1, 17);\n\tclk[IMX27_CLK_EMMA_AHB_GATE] = imx_clk_gate(\"emma_ahb_gate\", \"ahb\", CCM_PCCR1, 18);\n\tclk[IMX27_CLK_EMI_AHB_GATE] = imx_clk_gate(\"emi_ahb_gate\", \"ahb\", CCM_PCCR1, 19);\n\tclk[IMX27_CLK_DMA_AHB_GATE] = imx_clk_gate(\"dma_ahb_gate\", \"ahb\", CCM_PCCR1, 20);\n\tclk[IMX27_CLK_CSI_AHB_GATE] = imx_clk_gate(\"csi_ahb_gate\", \"ahb\", CCM_PCCR1, 21);\n\tclk[IMX27_CLK_BROM_AHB_GATE] = imx_clk_gate(\"brom_ahb_gate\", \"ahb\", CCM_PCCR1, 22);\n\tclk[IMX27_CLK_ATA_AHB_GATE] = imx_clk_gate(\"ata_ahb_gate\", \"ahb\", CCM_PCCR1, 23);\n\tclk[IMX27_CLK_WDOG_IPG_GATE] = imx_clk_gate(\"wdog_ipg_gate\", \"ipg\", CCM_PCCR1, 24);\n\tclk[IMX27_CLK_USB_IPG_GATE] = imx_clk_gate(\"usb_ipg_gate\", \"ipg\", CCM_PCCR1, 25);\n\tclk[IMX27_CLK_UART6_IPG_GATE] = imx_clk_gate(\"uart6_ipg_gate\", \"ipg\", CCM_PCCR1, 26);\n\tclk[IMX27_CLK_UART5_IPG_GATE] = imx_clk_gate(\"uart5_ipg_gate\", \"ipg\", CCM_PCCR1, 27);\n\tclk[IMX27_CLK_UART4_IPG_GATE] = imx_clk_gate(\"uart4_ipg_gate\", \"ipg\", CCM_PCCR1, 28);\n\tclk[IMX27_CLK_UART3_IPG_GATE] = imx_clk_gate(\"uart3_ipg_gate\", \"ipg\", CCM_PCCR1, 29);\n\tclk[IMX27_CLK_UART2_IPG_GATE] = imx_clk_gate(\"uart2_ipg_gate\", \"ipg\", CCM_PCCR1, 30);\n\tclk[IMX27_CLK_UART1_IPG_GATE] = imx_clk_gate(\"uart1_ipg_gate\", \"ipg\", CCM_PCCR1, 31);\n\n\timx_check_clocks(clk, ARRAY_SIZE(clk));\n\n\tclk_register_clkdev(clk[IMX27_CLK_CPU_DIV], NULL, \"cpu0\");\n\n\tclk_prepare_enable(clk[IMX27_CLK_EMI_AHB_GATE]);\n\n\timx_register_uart_clocks();\n\n\timx_print_silicon_rev(\"i.MX27\", mx27_revision());\n}\n\nstatic void __init mx27_clocks_init_dt(struct device_node *np)\n{\n\tstruct device_node *refnp;\n\tu32 fref = 26000000;  \n\n\tfor_each_compatible_node(refnp, NULL, \"fixed-clock\") {\n\t\tif (!of_device_is_compatible(refnp, \"fsl,imx-osc26m\"))\n\t\t\tcontinue;\n\n\t\tif (!of_property_read_u32(refnp, \"clock-frequency\", &fref)) {\n\t\t\tof_node_put(refnp);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tccm = of_iomap(np, 0);\n\n\t_mx27_clocks_init(fref);\n\n\tclk_data.clks = clk;\n\tclk_data.clk_num = ARRAY_SIZE(clk);\n\tof_clk_add_provider(np, of_clk_src_onecell_get, &clk_data);\n}\nCLK_OF_DECLARE(imx27_ccm, \"fsl,imx27-ccm\", mx27_clocks_init_dt);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}