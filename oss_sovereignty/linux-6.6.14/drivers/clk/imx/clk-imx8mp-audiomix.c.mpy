{
  "module_name": "clk-imx8mp-audiomix.c",
  "hash_id": "84ab49ce3a3aa3786d4300be834d5dc6781cd802b37b84cdd0eb71d785ca25cc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/imx/clk-imx8mp-audiomix.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/device.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n\n#include <dt-bindings/clock/imx8mp-clock.h>\n\n#include \"clk.h\"\n\n#define CLKEN0\t\t\t0x000\n#define CLKEN1\t\t\t0x004\n#define SAI_MCLK_SEL(n)\t\t(0x300 + 4 * (n))\t \n#define PDM_SEL\t\t\t0x318\n#define SAI_PLL_GNRL_CTL\t0x400\n\n#define SAIn_MCLK1_PARENT(n)\t\t\t\t\t\t\\\nstatic const struct clk_parent_data\t\t\t\t\t\\\nclk_imx8mp_audiomix_sai##n##_mclk1_parents[] = {\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.fw_name = \"sai\"__stringify(n),\t\t\t\t\\\n\t\t.name = \"sai\"__stringify(n)\t\t\t\t\\\n\t}, {\t\t\t\t\t\t\t\t\\\n\t\t.fw_name = \"sai\"__stringify(n)\"_mclk\",\t\t\t\\\n\t\t.name = \"sai\"__stringify(n)\"_mclk\"\t\t\t\\\n\t},\t\t\t\t\t\t\t\t\\\n}\n\nSAIn_MCLK1_PARENT(1);\nSAIn_MCLK1_PARENT(2);\nSAIn_MCLK1_PARENT(3);\nSAIn_MCLK1_PARENT(5);\nSAIn_MCLK1_PARENT(6);\nSAIn_MCLK1_PARENT(7);\n\nstatic const struct clk_parent_data clk_imx8mp_audiomix_sai_mclk2_parents[] = {\n\t{ .fw_name = \"sai1\", .name = \"sai1\" },\n\t{ .fw_name = \"sai2\", .name = \"sai2\" },\n\t{ .fw_name = \"sai3\", .name = \"sai3\" },\n\t{ .name = \"dummy\" },\n\t{ .fw_name = \"sai5\", .name = \"sai5\" },\n\t{ .fw_name = \"sai6\", .name = \"sai6\" },\n\t{ .fw_name = \"sai7\", .name = \"sai7\" },\n\t{ .fw_name = \"sai1_mclk\", .name = \"sai1_mclk\" },\n\t{ .fw_name = \"sai2_mclk\", .name = \"sai2_mclk\" },\n\t{ .fw_name = \"sai3_mclk\", .name = \"sai3_mclk\" },\n\t{ .name = \"dummy\" },\n\t{ .fw_name = \"sai5_mclk\", .name = \"sai5_mclk\" },\n\t{ .fw_name = \"sai6_mclk\", .name = \"sai6_mclk\" },\n\t{ .fw_name = \"sai7_mclk\", .name = \"sai7_mclk\" },\n\t{ .fw_name = \"spdif_extclk\", .name = \"spdif_extclk\" },\n\t{ .name = \"dummy\" },\n};\n\nstatic const struct clk_parent_data clk_imx8mp_audiomix_pdm_parents[] = {\n\t{ .fw_name = \"pdm\", .name = \"pdm\" },\n\t{ .name = \"sai_pll_out_div2\" },\n\t{ .fw_name = \"sai1_mclk\", .name = \"sai1_mclk\" },\n\t{ .name = \"dummy\" },\n};\n\n\nstatic const struct clk_parent_data clk_imx8mp_audiomix_pll_parents[] = {\n\t{ .fw_name = \"osc_24m\", .name = \"osc_24m\" },\n\t{ .name = \"dummy\" },\n\t{ .name = \"dummy\" },\n\t{ .name = \"dummy\" },\n};\n\nstatic const struct clk_parent_data clk_imx8mp_audiomix_pll_bypass_sels[] = {\n\t{ .fw_name = \"sai_pll\", .name = \"sai_pll\" },\n\t{ .fw_name = \"sai_pll_ref_sel\", .name = \"sai_pll_ref_sel\" },\n};\n\n#define CLK_GATE(gname, cname)\t\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\tgname\"_cg\",\t\t\t\t\t\t\\\n\t\tIMX8MP_CLK_AUDIOMIX_##cname,\t\t\t\t\\\n\t\t{ .fw_name = \"ahb\", .name = \"ahb\" }, NULL, 1,\t\t\\\n\t\tCLKEN0 + 4 * !!(IMX8MP_CLK_AUDIOMIX_##cname / 32),\t\\\n\t\t1, IMX8MP_CLK_AUDIOMIX_##cname % 32\t\t\t\\\n\t}\n\n#define CLK_SAIn(n)\t\t\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t\"sai\"__stringify(n)\"_mclk1_sel\",\t\t\t\\\n\t\tIMX8MP_CLK_AUDIOMIX_SAI##n##_MCLK1_SEL, {},\t\t\\\n\t\tclk_imx8mp_audiomix_sai##n##_mclk1_parents,\t\t\\\n\t\tARRAY_SIZE(clk_imx8mp_audiomix_sai##n##_mclk1_parents), \\\n\t\tSAI_MCLK_SEL(n), 1, 0\t\t\t\t\t\\\n\t}, {\t\t\t\t\t\t\t\t\\\n\t\t\"sai\"__stringify(n)\"_mclk2_sel\",\t\t\t\\\n\t\tIMX8MP_CLK_AUDIOMIX_SAI##n##_MCLK2_SEL, {},\t\t\\\n\t\tclk_imx8mp_audiomix_sai_mclk2_parents,\t\t\t\\\n\t\tARRAY_SIZE(clk_imx8mp_audiomix_sai_mclk2_parents),\t\\\n\t\tSAI_MCLK_SEL(n), 4, 1\t\t\t\t\t\\\n\t}, {\t\t\t\t\t\t\t\t\\\n\t\t\"sai\"__stringify(n)\"_ipg_cg\",\t\t\t\t\\\n\t\tIMX8MP_CLK_AUDIOMIX_SAI##n##_IPG,\t\t\t\\\n\t\t{ .fw_name = \"ahb\", .name = \"ahb\" }, NULL, 1,\t\t\\\n\t\tCLKEN0, 1, IMX8MP_CLK_AUDIOMIX_SAI##n##_IPG\t\t\\\n\t}, {\t\t\t\t\t\t\t\t\\\n\t\t\"sai\"__stringify(n)\"_mclk1_cg\",\t\t\t\t\\\n\t\tIMX8MP_CLK_AUDIOMIX_SAI##n##_MCLK1,\t\t\t\\\n\t\t{\t\t\t\t\t\t\t\\\n\t\t\t.fw_name = \"sai\"__stringify(n)\"_mclk1_sel\",\t\\\n\t\t\t.name = \"sai\"__stringify(n)\"_mclk1_sel\"\t\t\\\n\t\t}, NULL, 1,\t\t\t\t\t\t\\\n\t\tCLKEN0, 1, IMX8MP_CLK_AUDIOMIX_SAI##n##_MCLK1\t\t\\\n\t}, {\t\t\t\t\t\t\t\t\\\n\t\t\"sai\"__stringify(n)\"_mclk2_cg\",\t\t\t\t\\\n\t\tIMX8MP_CLK_AUDIOMIX_SAI##n##_MCLK2,\t\t\t\\\n\t\t{\t\t\t\t\t\t\t\\\n\t\t\t.fw_name = \"sai\"__stringify(n)\"_mclk2_sel\",\t\\\n\t\t\t.name = \"sai\"__stringify(n)\"_mclk2_sel\"\t\t\\\n\t\t}, NULL, 1,\t\t\t\t\t\t\\\n\t\tCLKEN0, 1, IMX8MP_CLK_AUDIOMIX_SAI##n##_MCLK2\t\t\\\n\t}, {\t\t\t\t\t\t\t\t\\\n\t\t\"sai\"__stringify(n)\"_mclk3_cg\",\t\t\t\t\\\n\t\tIMX8MP_CLK_AUDIOMIX_SAI##n##_MCLK3,\t\t\t\\\n\t\t{\t\t\t\t\t\t\t\\\n\t\t\t.fw_name = \"sai_pll_out_div2\",\t\t\t\\\n\t\t\t.name = \"sai_pll_out_div2\"\t\t\t\\\n\t\t}, NULL, 1,\t\t\t\t\t\t\\\n\t\tCLKEN0, 1, IMX8MP_CLK_AUDIOMIX_SAI##n##_MCLK3\t\t\\\n\t}\n\n#define CLK_PDM\t\t\t\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t\"pdm_sel\", IMX8MP_CLK_AUDIOMIX_PDM_SEL, {},\t\t\\\n\t\tclk_imx8mp_audiomix_pdm_parents,\t\t\t\\\n\t\tARRAY_SIZE(clk_imx8mp_audiomix_pdm_parents),\t\t\\\n\t\tPDM_SEL, 2, 0\t\t\t\t\t\t\\\n\t}\n\nstruct clk_imx8mp_audiomix_sel {\n\tconst char\t\t\t*name;\n\tint\t\t\t\tclkid;\n\tconst struct clk_parent_data\tparent;\t\t \n\tconst struct clk_parent_data\t*parents;\t \n\tint\t\t\t\tnum_parents;\n\tu16\t\t\t\treg;\n\tu8\t\t\t\twidth;\n\tu8\t\t\t\tshift;\n};\n\nstatic struct clk_imx8mp_audiomix_sel sels[] = {\n\tCLK_GATE(\"asrc\", ASRC_IPG),\n\tCLK_GATE(\"pdm\", PDM_IPG),\n\tCLK_GATE(\"earc\", EARC_IPG),\n\tCLK_GATE(\"ocrama\", OCRAMA_IPG),\n\tCLK_GATE(\"aud2htx\", AUD2HTX_IPG),\n\tCLK_GATE(\"earc_phy\", EARC_PHY),\n\tCLK_GATE(\"sdma2\", SDMA2_ROOT),\n\tCLK_GATE(\"sdma3\", SDMA3_ROOT),\n\tCLK_GATE(\"spba2\", SPBA2_ROOT),\n\tCLK_GATE(\"dsp\", DSP_ROOT),\n\tCLK_GATE(\"dspdbg\", DSPDBG_ROOT),\n\tCLK_GATE(\"edma\", EDMA_ROOT),\n\tCLK_GATE(\"audpll\", AUDPLL_ROOT),\n\tCLK_GATE(\"mu2\", MU2_ROOT),\n\tCLK_GATE(\"mu3\", MU3_ROOT),\n\tCLK_PDM,\n\tCLK_SAIn(1),\n\tCLK_SAIn(2),\n\tCLK_SAIn(3),\n\tCLK_SAIn(5),\n\tCLK_SAIn(6),\n\tCLK_SAIn(7)\n};\n\nstatic int clk_imx8mp_audiomix_probe(struct platform_device *pdev)\n{\n\tstruct clk_hw_onecell_data *priv;\n\tstruct device *dev = &pdev->dev;\n\tvoid __iomem *base;\n\tstruct clk_hw *hw;\n\tint i;\n\n\tpriv = devm_kzalloc(dev,\n\t\t\t    struct_size(priv, hws, IMX8MP_CLK_AUDIOMIX_END),\n\t\t\t    GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->num = IMX8MP_CLK_AUDIOMIX_END;\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tfor (i = 0; i < ARRAY_SIZE(sels); i++) {\n\t\tif (sels[i].num_parents == 1) {\n\t\t\thw = devm_clk_hw_register_gate_parent_data(dev,\n\t\t\t\tsels[i].name, &sels[i].parent, 0,\n\t\t\t\tbase + sels[i].reg, sels[i].shift, 0, NULL);\n\t\t} else {\n\t\t\thw = devm_clk_hw_register_mux_parent_data_table(dev,\n\t\t\t\tsels[i].name, sels[i].parents,\n\t\t\t\tsels[i].num_parents, 0,\n\t\t\t\tbase + sels[i].reg,\n\t\t\t\tsels[i].shift, sels[i].width,\n\t\t\t\t0, NULL, NULL);\n\t\t}\n\n\t\tif (IS_ERR(hw))\n\t\t\treturn PTR_ERR(hw);\n\n\t\tpriv->hws[sels[i].clkid] = hw;\n\t}\n\n\t \n\thw = devm_clk_hw_register_mux_parent_data_table(dev,\n\t\t\"sai_pll_ref_sel\", clk_imx8mp_audiomix_pll_parents,\n\t\tARRAY_SIZE(clk_imx8mp_audiomix_pll_parents),\n\t\tCLK_SET_RATE_NO_REPARENT, base + SAI_PLL_GNRL_CTL,\n\t\t0, 2, 0, NULL, NULL);\n\tpriv->hws[IMX8MP_CLK_AUDIOMIX_SAI_PLL_REF_SEL] = hw;\n\n\thw = imx_dev_clk_hw_pll14xx(dev, \"sai_pll\", \"sai_pll_ref_sel\",\n\t\t\t\t    base + 0x400, &imx_1443x_pll);\n\tif (IS_ERR(hw))\n\t\treturn PTR_ERR(hw);\n\tpriv->hws[IMX8MP_CLK_AUDIOMIX_SAI_PLL] = hw;\n\n\thw = devm_clk_hw_register_mux_parent_data_table(dev,\n\t\t\"sai_pll_bypass\", clk_imx8mp_audiomix_pll_bypass_sels,\n\t\tARRAY_SIZE(clk_imx8mp_audiomix_pll_bypass_sels),\n\t\tCLK_SET_RATE_NO_REPARENT | CLK_SET_RATE_PARENT,\n\t\tbase + SAI_PLL_GNRL_CTL, 16, 1, 0, NULL, NULL);\n\tif (IS_ERR(hw))\n\t\treturn PTR_ERR(hw);\n\tpriv->hws[IMX8MP_CLK_AUDIOMIX_SAI_PLL_BYPASS] = hw;\n\n\thw = devm_clk_hw_register_gate(dev, \"sai_pll_out\", \"sai_pll_bypass\",\n\t\t\t\t       0, base + SAI_PLL_GNRL_CTL, 13,\n\t\t\t\t       0, NULL);\n\tif (IS_ERR(hw))\n\t\treturn PTR_ERR(hw);\n\tpriv->hws[IMX8MP_CLK_AUDIOMIX_SAI_PLL_OUT] = hw;\n\n\thw = devm_clk_hw_register_fixed_factor(dev, \"sai_pll_out_div2\",\n\t\t\t\t\t       \"sai_pll_out\", 0, 1, 2);\n\tif (IS_ERR(hw))\n\t\treturn PTR_ERR(hw);\n\n\treturn devm_of_clk_add_hw_provider(&pdev->dev, of_clk_hw_onecell_get,\n\t\t\t\t\t   priv);\n}\n\nstatic const struct of_device_id clk_imx8mp_audiomix_of_match[] = {\n\t{ .compatible = \"fsl,imx8mp-audio-blk-ctrl\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, clk_imx8mp_audiomix_of_match);\n\nstatic struct platform_driver clk_imx8mp_audiomix_driver = {\n\t.probe\t= clk_imx8mp_audiomix_probe,\n\t.driver = {\n\t\t.name = \"imx8mp-audio-blk-ctrl\",\n\t\t.of_match_table = clk_imx8mp_audiomix_of_match,\n\t},\n};\n\nmodule_platform_driver(clk_imx8mp_audiomix_driver);\n\nMODULE_AUTHOR(\"Marek Vasut <marex@denx.de>\");\nMODULE_DESCRIPTION(\"Freescale i.MX8MP Audio Block Controller driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}