{
  "module_name": "clk-cpu.c",
  "hash_id": "7b7fc0882f8f5812e55dc06927103e400da9297648947ae29c83343fee0da236",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/imx/clk-cpu.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/export.h>\n#include <linux/slab.h>\n#include \"clk.h\"\n\nstruct clk_cpu {\n\tstruct clk_hw\thw;\n\tstruct clk\t*div;\n\tstruct clk\t*mux;\n\tstruct clk\t*pll;\n\tstruct clk\t*step;\n};\n\nstatic inline struct clk_cpu *to_clk_cpu(struct clk_hw *hw)\n{\n\treturn container_of(hw, struct clk_cpu, hw);\n}\n\nstatic unsigned long clk_cpu_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t unsigned long parent_rate)\n{\n\tstruct clk_cpu *cpu = to_clk_cpu(hw);\n\n\treturn clk_get_rate(cpu->div);\n}\n\nstatic long clk_cpu_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t       unsigned long *prate)\n{\n\tstruct clk_cpu *cpu = to_clk_cpu(hw);\n\n\treturn clk_round_rate(cpu->pll, rate);\n}\n\nstatic int clk_cpu_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t    unsigned long parent_rate)\n{\n\tstruct clk_cpu *cpu = to_clk_cpu(hw);\n\tint ret;\n\n\t \n\tret = clk_set_parent(cpu->mux, cpu->step);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = clk_set_rate(cpu->pll, rate);\n\tif (ret) {\n\t\tclk_set_parent(cpu->mux, cpu->pll);\n\t\treturn ret;\n\t}\n\t \n\tclk_set_parent(cpu->mux, cpu->pll);\n\n\t \n\tclk_set_rate(cpu->div, rate);\n\n\treturn 0;\n}\n\nstatic const struct clk_ops clk_cpu_ops = {\n\t.recalc_rate\t= clk_cpu_recalc_rate,\n\t.round_rate\t= clk_cpu_round_rate,\n\t.set_rate\t= clk_cpu_set_rate,\n};\n\nstruct clk_hw *imx_clk_hw_cpu(const char *name, const char *parent_name,\n\t\tstruct clk *div, struct clk *mux, struct clk *pll,\n\t\tstruct clk *step)\n{\n\tstruct clk_cpu *cpu;\n\tstruct clk_hw *hw;\n\tstruct clk_init_data init;\n\tint ret;\n\n\tcpu = kzalloc(sizeof(*cpu), GFP_KERNEL);\n\tif (!cpu)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tcpu->div = div;\n\tcpu->mux = mux;\n\tcpu->pll = pll;\n\tcpu->step = step;\n\n\tinit.name = name;\n\tinit.ops = &clk_cpu_ops;\n\tinit.flags = CLK_IS_CRITICAL;\n\tinit.parent_names = &parent_name;\n\tinit.num_parents = 1;\n\n\tcpu->hw.init = &init;\n\thw = &cpu->hw;\n\n\tret = clk_hw_register(NULL, hw);\n\tif (ret) {\n\t\tkfree(cpu);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn hw;\n}\nEXPORT_SYMBOL_GPL(imx_clk_hw_cpu);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}