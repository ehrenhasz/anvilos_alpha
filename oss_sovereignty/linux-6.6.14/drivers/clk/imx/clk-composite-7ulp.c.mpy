{
  "module_name": "clk-composite-7ulp.c",
  "hash_id": "26837d6acb6ad171566632649a4467ca30132aacf7f133198f615b80ea464036",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/imx/clk-composite-7ulp.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/clk-provider.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/slab.h>\n\n#include \"../clk-fractional-divider.h\"\n#include \"clk.h\"\n\n#define PCG_PCS_SHIFT\t24\n#define PCG_PCS_MASK\t0x7\n#define PCG_CGC_SHIFT\t30\n#define PCG_FRAC_SHIFT\t3\n#define PCG_FRAC_WIDTH\t1\n#define PCG_PCD_SHIFT\t0\n#define PCG_PCD_WIDTH\t3\n\n#define SW_RST\t\tBIT(28)\n\nstatic int pcc_gate_enable(struct clk_hw *hw)\n{\n\tstruct clk_gate *gate = to_clk_gate(hw);\n\tunsigned long flags;\n\tu32 val;\n\tint ret;\n\n\tret = clk_gate_ops.enable(hw);\n\tif (ret)\n\t\treturn ret;\n\n\tspin_lock_irqsave(gate->lock, flags);\n\t \n\tval = readl(gate->reg);\n\tval |= SW_RST;\n\twritel(val, gate->reg);\n\n\tspin_unlock_irqrestore(gate->lock, flags);\n\n\treturn 0;\n}\n\nstatic void pcc_gate_disable(struct clk_hw *hw)\n{\n\tclk_gate_ops.disable(hw);\n}\n\nstatic int pcc_gate_is_enabled(struct clk_hw *hw)\n{\n\treturn clk_gate_ops.is_enabled(hw);\n}\n\nstatic const struct clk_ops pcc_gate_ops = {\n\t.enable = pcc_gate_enable,\n\t.disable = pcc_gate_disable,\n\t.is_enabled = pcc_gate_is_enabled,\n};\n\nstatic struct clk_hw *imx_ulp_clk_hw_composite(const char *name,\n\t\t\t\t     const char * const *parent_names,\n\t\t\t\t     int num_parents, bool mux_present,\n\t\t\t\t     bool rate_present, bool gate_present,\n\t\t\t\t     void __iomem *reg, bool has_swrst)\n{\n\tstruct clk_hw *mux_hw = NULL, *fd_hw = NULL, *gate_hw = NULL;\n\tstruct clk_fractional_divider *fd = NULL;\n\tstruct clk_gate *gate = NULL;\n\tstruct clk_mux *mux = NULL;\n\tstruct clk_hw *hw;\n\tu32 val;\n\n\tif (mux_present) {\n\t\tmux = kzalloc(sizeof(*mux), GFP_KERNEL);\n\t\tif (!mux)\n\t\t\treturn ERR_PTR(-ENOMEM);\n\t\tmux_hw = &mux->hw;\n\t\tmux->reg = reg;\n\t\tmux->shift = PCG_PCS_SHIFT;\n\t\tmux->mask = PCG_PCS_MASK;\n\t\tif (has_swrst)\n\t\t\tmux->lock = &imx_ccm_lock;\n\t}\n\n\tif (rate_present) {\n\t\tfd = kzalloc(sizeof(*fd), GFP_KERNEL);\n\t\tif (!fd) {\n\t\t\tkfree(mux);\n\t\t\treturn ERR_PTR(-ENOMEM);\n\t\t}\n\t\tfd_hw = &fd->hw;\n\t\tfd->reg = reg;\n\t\tfd->mshift = PCG_FRAC_SHIFT;\n\t\tfd->mwidth = PCG_FRAC_WIDTH;\n\t\tfd->nshift = PCG_PCD_SHIFT;\n\t\tfd->nwidth = PCG_PCD_WIDTH;\n\t\tfd->flags = CLK_FRAC_DIVIDER_ZERO_BASED;\n\t\tif (has_swrst)\n\t\t\tfd->lock = &imx_ccm_lock;\n\t}\n\n\tif (gate_present) {\n\t\tgate = kzalloc(sizeof(*gate), GFP_KERNEL);\n\t\tif (!gate) {\n\t\t\tkfree(mux);\n\t\t\tkfree(fd);\n\t\t\treturn ERR_PTR(-ENOMEM);\n\t\t}\n\t\tgate_hw = &gate->hw;\n\t\tgate->reg = reg;\n\t\tgate->bit_idx = PCG_CGC_SHIFT;\n\t\tif (has_swrst)\n\t\t\tgate->lock = &imx_ccm_lock;\n\t\t \n\t\tval = readl_relaxed(reg);\n\t\tval &= ~(1 << PCG_CGC_SHIFT);\n\t\twritel_relaxed(val, reg);\n\t}\n\n\thw = clk_hw_register_composite(NULL, name, parent_names, num_parents,\n\t\t\t\t       mux_hw, &clk_mux_ops, fd_hw,\n\t\t\t\t       &clk_fractional_divider_ops, gate_hw,\n\t\t\t\t       has_swrst ? &pcc_gate_ops : &clk_gate_ops, CLK_SET_RATE_GATE |\n\t\t\t\t       CLK_SET_PARENT_GATE | CLK_SET_RATE_NO_REPARENT);\n\tif (IS_ERR(hw)) {\n\t\tkfree(mux);\n\t\tkfree(fd);\n\t\tkfree(gate);\n\t}\n\n\treturn hw;\n}\n\nstruct clk_hw *imx7ulp_clk_hw_composite(const char *name, const char * const *parent_names,\n\t\t\t\tint num_parents, bool mux_present, bool rate_present,\n\t\t\t\tbool gate_present, void __iomem *reg)\n{\n\treturn imx_ulp_clk_hw_composite(name, parent_names, num_parents, mux_present, rate_present,\n\t\t\t\t\tgate_present, reg, false);\n}\n\nstruct clk_hw *imx8ulp_clk_hw_composite(const char *name, const char * const *parent_names,\n\t\t\t\tint num_parents, bool mux_present, bool rate_present,\n\t\t\t\tbool gate_present, void __iomem *reg, bool has_swrst)\n{\n\treturn imx_ulp_clk_hw_composite(name, parent_names, num_parents, mux_present, rate_present,\n\t\t\t\t\tgate_present, reg, has_swrst);\n}\nEXPORT_SYMBOL_GPL(imx8ulp_clk_hw_composite);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}