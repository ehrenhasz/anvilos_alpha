{
  "module_name": "clk-pllv1.c",
  "hash_id": "1dfb84f6c4943801614630f3c85612d30b1a31901191efa3f274078b17c2d0e0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/imx/clk-pllv1.c",
  "human_readable_source": "\n#include <linux/bits.h>\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <linux/slab.h>\n#include <linux/kernel.h>\n#include <linux/err.h>\n\n#include \"clk.h\"\n\n#define MFN_BITS\t(10)\n#define MFN_SIGN\t(BIT(MFN_BITS - 1))\n#define MFN_MASK\t(MFN_SIGN - 1)\n\n \nstruct clk_pllv1 {\n\tstruct clk_hw\thw;\n\tvoid __iomem\t*base;\n\tenum imx_pllv1_type type;\n};\n\n#define to_clk_pllv1(clk) (container_of(clk, struct clk_pllv1, clk))\n\nstatic inline bool is_imx1_pllv1(struct clk_pllv1 *pll)\n{\n\treturn pll->type == IMX_PLLV1_IMX1;\n}\n\nstatic inline bool is_imx21_pllv1(struct clk_pllv1 *pll)\n{\n\treturn pll->type == IMX_PLLV1_IMX21;\n}\n\nstatic inline bool is_imx27_pllv1(struct clk_pllv1 *pll)\n{\n\treturn pll->type == IMX_PLLV1_IMX27;\n}\n\nstatic inline bool mfn_is_negative(struct clk_pllv1 *pll, unsigned int mfn)\n{\n\treturn !is_imx1_pllv1(pll) && !is_imx21_pllv1(pll) && (mfn & MFN_SIGN);\n}\n\nstatic unsigned long clk_pllv1_recalc_rate(struct clk_hw *hw,\n\t\tunsigned long parent_rate)\n{\n\tstruct clk_pllv1 *pll = to_clk_pllv1(hw);\n\tunsigned long long ull;\n\tint mfn_abs;\n\tunsigned int mfi, mfn, mfd, pd;\n\tu32 reg;\n\tunsigned long rate;\n\n\treg = readl(pll->base);\n\n\t \n\n\tmfi = (reg >> 10) & 0xf;\n\tmfn = reg & 0x3ff;\n\tmfd = (reg >> 16) & 0x3ff;\n\tpd =  (reg >> 26) & 0xf;\n\n\tmfi = mfi <= 5 ? 5 : mfi;\n\n\tmfn_abs = mfn;\n\n\t \n\tif (mfn_is_negative(pll, mfn)) {\n\t\tif (is_imx27_pllv1(pll))\n\t\t\tmfn_abs = mfn & MFN_MASK;\n\t\telse\n\t\t\tmfn_abs = BIT(MFN_BITS) - mfn;\n\t}\n\n\trate = parent_rate * 2;\n\trate /= pd + 1;\n\n\tull = (unsigned long long)rate * mfn_abs;\n\n\tdo_div(ull, mfd + 1);\n\n\tif (mfn_is_negative(pll, mfn))\n\t\tull = (rate * mfi) - ull;\n\telse\n\t\tull = (rate * mfi) + ull;\n\n\treturn ull;\n}\n\nstatic const struct clk_ops clk_pllv1_ops = {\n\t.recalc_rate = clk_pllv1_recalc_rate,\n};\n\nstruct clk_hw *imx_clk_hw_pllv1(enum imx_pllv1_type type, const char *name,\n\t\tconst char *parent, void __iomem *base)\n{\n\tstruct clk_pllv1 *pll;\n\tstruct clk_hw *hw;\n\tstruct clk_init_data init;\n\tint ret;\n\n\tpll = kmalloc(sizeof(*pll), GFP_KERNEL);\n\tif (!pll)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tpll->base = base;\n\tpll->type = type;\n\n\tinit.name = name;\n\tinit.ops = &clk_pllv1_ops;\n\tinit.flags = 0;\n\tinit.parent_names = &parent;\n\tinit.num_parents = 1;\n\n\tpll->hw.init = &init;\n\thw = &pll->hw;\n\n\tret = clk_hw_register(NULL, hw);\n\tif (ret) {\n\t\tkfree(pll);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn hw;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}