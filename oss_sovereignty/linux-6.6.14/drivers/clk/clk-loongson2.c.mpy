{
  "module_name": "clk-loongson2.c",
  "hash_id": "f87d607831f362f2e942f0309eeb08341d66f7020a1b3afbc9ce4a2fc2a0e05f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/clk-loongson2.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/clk-provider.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/io-64-nonatomic-lo-hi.h>\n#include <dt-bindings/clock/loongson,ls2k-clk.h>\n\n#define LOONGSON2_PLL_MULT_SHIFT\t\t32\n#define LOONGSON2_PLL_MULT_WIDTH\t\t10\n#define LOONGSON2_PLL_DIV_SHIFT\t\t\t26\n#define LOONGSON2_PLL_DIV_WIDTH\t\t\t6\n#define LOONGSON2_APB_FREQSCALE_SHIFT\t\t20\n#define LOONGSON2_APB_FREQSCALE_WIDTH\t\t3\n#define LOONGSON2_USB_FREQSCALE_SHIFT\t\t16\n#define LOONGSON2_USB_FREQSCALE_WIDTH\t\t3\n#define LOONGSON2_SATA_FREQSCALE_SHIFT\t\t12\n#define LOONGSON2_SATA_FREQSCALE_WIDTH\t\t3\n#define LOONGSON2_BOOT_FREQSCALE_SHIFT\t\t8\n#define LOONGSON2_BOOT_FREQSCALE_WIDTH\t\t3\n\nstatic void __iomem *loongson2_pll_base;\n\nstatic const struct clk_parent_data pdata[] = {\n\t{ .fw_name = \"ref_100m\",},\n};\n\nstatic struct clk_hw *loongson2_clk_register(struct device *dev,\n\t\t\t\t\t  const char *name,\n\t\t\t\t\t  const char *parent_name,\n\t\t\t\t\t  const struct clk_ops *ops,\n\t\t\t\t\t  unsigned long flags)\n{\n\tint ret;\n\tstruct clk_hw *hw;\n\tstruct clk_init_data init = { };\n\n\thw = devm_kzalloc(dev, sizeof(*hw), GFP_KERNEL);\n\tif (!hw)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit.name = name;\n\tinit.ops = ops;\n\tinit.flags = flags;\n\tinit.num_parents = 1;\n\n\tif (!parent_name)\n\t\tinit.parent_data = pdata;\n\telse\n\t\tinit.parent_names = &parent_name;\n\n\thw->init = &init;\n\n\tret = devm_clk_hw_register(dev, hw);\n\tif (ret)\n\t\thw = ERR_PTR(ret);\n\n\treturn hw;\n}\n\nstatic unsigned long loongson2_calc_pll_rate(int offset, unsigned long rate)\n{\n\tu64 val;\n\tu32 mult, div;\n\n\tval = readq(loongson2_pll_base + offset);\n\n\tmult = (val >> LOONGSON2_PLL_MULT_SHIFT) &\n\t\t\tclk_div_mask(LOONGSON2_PLL_MULT_WIDTH);\n\tdiv = (val >> LOONGSON2_PLL_DIV_SHIFT) &\n\t\t\tclk_div_mask(LOONGSON2_PLL_DIV_WIDTH);\n\n\treturn div_u64((u64)rate * mult, div);\n}\n\nstatic unsigned long loongson2_node_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t  unsigned long parent_rate)\n{\n\treturn loongson2_calc_pll_rate(0x0, parent_rate);\n}\n\nstatic const struct clk_ops loongson2_node_clk_ops = {\n\t.recalc_rate = loongson2_node_recalc_rate,\n};\n\nstatic unsigned long loongson2_ddr_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t  unsigned long parent_rate)\n{\n\treturn loongson2_calc_pll_rate(0x10, parent_rate);\n}\n\nstatic const struct clk_ops loongson2_ddr_clk_ops = {\n\t.recalc_rate = loongson2_ddr_recalc_rate,\n};\n\nstatic unsigned long loongson2_dc_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t  unsigned long parent_rate)\n{\n\treturn loongson2_calc_pll_rate(0x20, parent_rate);\n}\n\nstatic const struct clk_ops loongson2_dc_clk_ops = {\n\t.recalc_rate = loongson2_dc_recalc_rate,\n};\n\nstatic unsigned long loongson2_pix0_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t  unsigned long parent_rate)\n{\n\treturn loongson2_calc_pll_rate(0x30, parent_rate);\n}\n\nstatic const struct clk_ops loongson2_pix0_clk_ops = {\n\t.recalc_rate = loongson2_pix0_recalc_rate,\n};\n\nstatic unsigned long loongson2_pix1_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t  unsigned long parent_rate)\n{\n\treturn loongson2_calc_pll_rate(0x40, parent_rate);\n}\n\nstatic const struct clk_ops loongson2_pix1_clk_ops = {\n\t.recalc_rate = loongson2_pix1_recalc_rate,\n};\n\nstatic unsigned long loongson2_calc_rate(unsigned long rate,\n\t\t\t\t\t int shift, int width)\n{\n\tu64 val;\n\tu32 mult;\n\n\tval = readq(loongson2_pll_base + 0x50);\n\n\tmult = (val >> shift) & clk_div_mask(width);\n\n\treturn div_u64((u64)rate * (mult + 1), 8);\n}\n\nstatic unsigned long loongson2_boot_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t  unsigned long parent_rate)\n{\n\treturn loongson2_calc_rate(parent_rate,\n\t\t\t\t   LOONGSON2_BOOT_FREQSCALE_SHIFT,\n\t\t\t\t   LOONGSON2_BOOT_FREQSCALE_WIDTH);\n}\n\nstatic const struct clk_ops loongson2_boot_clk_ops = {\n\t.recalc_rate = loongson2_boot_recalc_rate,\n};\n\nstatic unsigned long loongson2_apb_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t  unsigned long parent_rate)\n{\n\treturn loongson2_calc_rate(parent_rate,\n\t\t\t\t   LOONGSON2_APB_FREQSCALE_SHIFT,\n\t\t\t\t   LOONGSON2_APB_FREQSCALE_WIDTH);\n}\n\nstatic const struct clk_ops loongson2_apb_clk_ops = {\n\t.recalc_rate = loongson2_apb_recalc_rate,\n};\n\nstatic unsigned long loongson2_usb_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t  unsigned long parent_rate)\n{\n\treturn loongson2_calc_rate(parent_rate,\n\t\t\t\t   LOONGSON2_USB_FREQSCALE_SHIFT,\n\t\t\t\t   LOONGSON2_USB_FREQSCALE_WIDTH);\n}\n\nstatic const struct clk_ops loongson2_usb_clk_ops = {\n\t.recalc_rate = loongson2_usb_recalc_rate,\n};\n\nstatic unsigned long loongson2_sata_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t  unsigned long parent_rate)\n{\n\treturn loongson2_calc_rate(parent_rate,\n\t\t\t\t   LOONGSON2_SATA_FREQSCALE_SHIFT,\n\t\t\t\t   LOONGSON2_SATA_FREQSCALE_WIDTH);\n}\n\nstatic const struct clk_ops loongson2_sata_clk_ops = {\n\t.recalc_rate = loongson2_sata_recalc_rate,\n};\n\nstatic inline int loongson2_check_clk_hws(struct clk_hw *clks[], unsigned int count)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < count; i++)\n\t\tif (IS_ERR(clks[i])) {\n\t\t\tpr_err(\"Loongson2 clk %u: register failed with %ld\\n\",\n\t\t\t\ti, PTR_ERR(clks[i]));\n\t\t\treturn PTR_ERR(clks[i]);\n\t\t}\n\n\treturn 0;\n}\n\nstatic int loongson2_clk_probe(struct platform_device *pdev)\n{\n\tint ret;\n\tstruct clk_hw **hws;\n\tstruct clk_hw_onecell_data *clk_hw_data;\n\tspinlock_t loongson2_clk_lock;\n\tstruct device *dev = &pdev->dev;\n\n\tloongson2_pll_base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(loongson2_pll_base))\n\t\treturn PTR_ERR(loongson2_pll_base);\n\n\tclk_hw_data = devm_kzalloc(dev, struct_size(clk_hw_data, hws, LOONGSON2_CLK_END),\n\t\t\t\t\tGFP_KERNEL);\n\tif (WARN_ON(!clk_hw_data))\n\t\treturn -ENOMEM;\n\n\tclk_hw_data->num = LOONGSON2_CLK_END;\n\thws = clk_hw_data->hws;\n\n\thws[LOONGSON2_NODE_PLL] = loongson2_clk_register(dev, \"node_pll\",\n\t\t\t\t\t\tNULL,\n\t\t\t\t\t\t&loongson2_node_clk_ops, 0);\n\n\thws[LOONGSON2_DDR_PLL] = loongson2_clk_register(dev, \"ddr_pll\",\n\t\t\t\t\t\tNULL,\n\t\t\t\t\t\t&loongson2_ddr_clk_ops, 0);\n\n\thws[LOONGSON2_DC_PLL] = loongson2_clk_register(dev, \"dc_pll\",\n\t\t\t\t\t\tNULL,\n\t\t\t\t\t\t&loongson2_dc_clk_ops, 0);\n\n\thws[LOONGSON2_PIX0_PLL] = loongson2_clk_register(dev, \"pix0_pll\",\n\t\t\t\t\t\tNULL,\n\t\t\t\t\t\t&loongson2_pix0_clk_ops, 0);\n\n\thws[LOONGSON2_PIX1_PLL] = loongson2_clk_register(dev, \"pix1_pll\",\n\t\t\t\t\t\tNULL,\n\t\t\t\t\t\t&loongson2_pix1_clk_ops, 0);\n\n\thws[LOONGSON2_BOOT_CLK] = loongson2_clk_register(dev, \"boot\",\n\t\t\t\t\t\tNULL,\n\t\t\t\t\t\t&loongson2_boot_clk_ops, 0);\n\n\thws[LOONGSON2_NODE_CLK] = devm_clk_hw_register_divider(dev, \"node\",\n\t\t\t\t\t\t\"node_pll\", 0,\n\t\t\t\t\t\tloongson2_pll_base + 0x8, 0,\n\t\t\t\t\t\t6, CLK_DIVIDER_ONE_BASED,\n\t\t\t\t\t\t&loongson2_clk_lock);\n\n\t \n\thws[LOONGSON2_HDA_CLK] = devm_clk_hw_register_divider(dev, \"hda\",\n\t\t\t\t\t\t\"ddr_pll\", 0,\n\t\t\t\t\t\tloongson2_pll_base + 0x22, 12,\n\t\t\t\t\t\t7, CLK_DIVIDER_ONE_BASED,\n\t\t\t\t\t\t&loongson2_clk_lock);\n\n\thws[LOONGSON2_GPU_CLK] = devm_clk_hw_register_divider(dev, \"gpu\",\n\t\t\t\t\t\t\"ddr_pll\", 0,\n\t\t\t\t\t\tloongson2_pll_base + 0x18, 22,\n\t\t\t\t\t\t6, CLK_DIVIDER_ONE_BASED,\n\t\t\t\t\t\t&loongson2_clk_lock);\n\n\thws[LOONGSON2_DDR_CLK] = devm_clk_hw_register_divider(dev, \"ddr\",\n\t\t\t\t\t\t\"ddr_pll\", 0,\n\t\t\t\t\t\tloongson2_pll_base + 0x18, 0,\n\t\t\t\t\t\t6, CLK_DIVIDER_ONE_BASED,\n\t\t\t\t\t\t&loongson2_clk_lock);\n\n\thws[LOONGSON2_GMAC_CLK] = devm_clk_hw_register_divider(dev, \"gmac\",\n\t\t\t\t\t\t\"dc_pll\", 0,\n\t\t\t\t\t\tloongson2_pll_base + 0x28, 22,\n\t\t\t\t\t\t6, CLK_DIVIDER_ONE_BASED,\n\t\t\t\t\t\t&loongson2_clk_lock);\n\n\thws[LOONGSON2_DC_CLK] = devm_clk_hw_register_divider(dev, \"dc\",\n\t\t\t\t\t\t\"dc_pll\", 0,\n\t\t\t\t\t\tloongson2_pll_base + 0x28, 0,\n\t\t\t\t\t\t6, CLK_DIVIDER_ONE_BASED,\n\t\t\t\t\t\t&loongson2_clk_lock);\n\n\thws[LOONGSON2_APB_CLK] = loongson2_clk_register(dev, \"apb\",\n\t\t\t\t\t\t\"gmac\",\n\t\t\t\t\t\t&loongson2_apb_clk_ops, 0);\n\n\thws[LOONGSON2_USB_CLK] = loongson2_clk_register(dev, \"usb\",\n\t\t\t\t\t\t\"gmac\",\n\t\t\t\t\t\t&loongson2_usb_clk_ops, 0);\n\n\thws[LOONGSON2_SATA_CLK] = loongson2_clk_register(dev, \"sata\",\n\t\t\t\t\t\t\"gmac\",\n\t\t\t\t\t\t&loongson2_sata_clk_ops, 0);\n\n\thws[LOONGSON2_PIX0_CLK] = clk_hw_register_divider(NULL, \"pix0\",\n\t\t\t\t\t\t\"pix0_pll\", 0,\n\t\t\t\t\t\tloongson2_pll_base + 0x38, 0, 6,\n\t\t\t\t\t\tCLK_DIVIDER_ONE_BASED,\n\t\t\t\t\t\t&loongson2_clk_lock);\n\n\thws[LOONGSON2_PIX1_CLK] = clk_hw_register_divider(NULL, \"pix1\",\n\t\t\t\t\t\t\"pix1_pll\", 0,\n\t\t\t\t\t\tloongson2_pll_base + 0x48, 0, 6,\n\t\t\t\t\t\tCLK_DIVIDER_ONE_BASED,\n\t\t\t\t\t\t&loongson2_clk_lock);\n\n\tret = loongson2_check_clk_hws(hws, LOONGSON2_CLK_END);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_of_clk_add_hw_provider(dev, of_clk_hw_onecell_get, clk_hw_data);\n}\n\nstatic const struct of_device_id loongson2_clk_match_table[] = {\n\t{ .compatible = \"loongson,ls2k-clk\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, loongson2_clk_match_table);\n\nstatic struct platform_driver loongson2_clk_driver = {\n\t.probe\t= loongson2_clk_probe,\n\t.driver\t= {\n\t\t.name\t= \"loongson2-clk\",\n\t\t.of_match_table\t= loongson2_clk_match_table,\n\t},\n};\nmodule_platform_driver(loongson2_clk_driver);\n\nMODULE_DESCRIPTION(\"Loongson2 clock driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}