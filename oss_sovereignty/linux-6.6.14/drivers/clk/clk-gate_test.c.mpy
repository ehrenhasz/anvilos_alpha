{
  "module_name": "clk-gate_test.c",
  "hash_id": "8c675af901b0a821125ba8faa2daea7c64e933a4a14da722757b7db44bb3544b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/clk-gate_test.c",
  "human_readable_source": "\n \n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/platform_device.h>\n\n#include <kunit/test.h>\n\nstatic void clk_gate_register_test_dev(struct kunit *test)\n{\n\tstruct clk_hw *ret;\n\tstruct platform_device *pdev;\n\n\tpdev = platform_device_register_simple(\"test_gate_device\", -1, NULL, 0);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, pdev);\n\n\tret = clk_hw_register_gate(&pdev->dev, \"test_gate\", NULL, 0, NULL,\n\t\t\t\t   0, 0, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, ret);\n\tKUNIT_EXPECT_STREQ(test, \"test_gate\", clk_hw_get_name(ret));\n\tKUNIT_EXPECT_EQ(test, 0UL, clk_hw_get_flags(ret));\n\n\tclk_hw_unregister_gate(ret);\n\tplatform_device_put(pdev);\n}\n\nstatic void clk_gate_register_test_parent_names(struct kunit *test)\n{\n\tstruct clk_hw *parent;\n\tstruct clk_hw *ret;\n\n\tparent = clk_hw_register_fixed_rate(NULL, \"test_parent\", NULL, 0,\n\t\t\t\t\t    1000000);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, parent);\n\n\tret = clk_hw_register_gate(NULL, \"test_gate\", \"test_parent\", 0, NULL,\n\t\t\t\t   0, 0, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, ret);\n\tKUNIT_EXPECT_PTR_EQ(test, parent, clk_hw_get_parent(ret));\n\n\tclk_hw_unregister_gate(ret);\n\tclk_hw_unregister_fixed_rate(parent);\n}\n\nstatic void clk_gate_register_test_parent_data(struct kunit *test)\n{\n\tstruct clk_hw *parent;\n\tstruct clk_hw *ret;\n\tstruct clk_parent_data pdata = { };\n\n\tparent = clk_hw_register_fixed_rate(NULL, \"test_parent\", NULL, 0,\n\t\t\t\t\t    1000000);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, parent);\n\tpdata.hw = parent;\n\n\tret = clk_hw_register_gate_parent_data(NULL, \"test_gate\", &pdata, 0,\n\t\t\t\t\t       NULL, 0, 0, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, ret);\n\tKUNIT_EXPECT_PTR_EQ(test, parent, clk_hw_get_parent(ret));\n\n\tclk_hw_unregister_gate(ret);\n\tclk_hw_unregister_fixed_rate(parent);\n}\n\nstatic void clk_gate_register_test_parent_data_legacy(struct kunit *test)\n{\n\tstruct clk_hw *parent;\n\tstruct clk_hw *ret;\n\tstruct clk_parent_data pdata = { };\n\n\tparent = clk_hw_register_fixed_rate(NULL, \"test_parent\", NULL, 0,\n\t\t\t\t\t    1000000);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, parent);\n\tpdata.name = \"test_parent\";\n\n\tret = clk_hw_register_gate_parent_data(NULL, \"test_gate\", &pdata, 0,\n\t\t\t\t\t       NULL, 0, 0, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, ret);\n\tKUNIT_EXPECT_PTR_EQ(test, parent, clk_hw_get_parent(ret));\n\n\tclk_hw_unregister_gate(ret);\n\tclk_hw_unregister_fixed_rate(parent);\n}\n\nstatic void clk_gate_register_test_parent_hw(struct kunit *test)\n{\n\tstruct clk_hw *parent;\n\tstruct clk_hw *ret;\n\n\tparent = clk_hw_register_fixed_rate(NULL, \"test_parent\", NULL, 0,\n\t\t\t\t\t    1000000);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, parent);\n\n\tret = clk_hw_register_gate_parent_hw(NULL, \"test_gate\", parent, 0, NULL,\n\t\t\t\t\t     0, 0, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, ret);\n\tKUNIT_EXPECT_PTR_EQ(test, parent, clk_hw_get_parent(ret));\n\n\tclk_hw_unregister_gate(ret);\n\tclk_hw_unregister_fixed_rate(parent);\n}\n\nstatic void clk_gate_register_test_hiword_invalid(struct kunit *test)\n{\n\tstruct clk_hw *ret;\n\n\tret = clk_hw_register_gate(NULL, \"test_gate\", NULL, 0, NULL,\n\t\t\t\t   20, CLK_GATE_HIWORD_MASK, NULL);\n\n\tKUNIT_EXPECT_TRUE(test, IS_ERR(ret));\n}\n\nstatic struct kunit_case clk_gate_register_test_cases[] = {\n\tKUNIT_CASE(clk_gate_register_test_dev),\n\tKUNIT_CASE(clk_gate_register_test_parent_names),\n\tKUNIT_CASE(clk_gate_register_test_parent_data),\n\tKUNIT_CASE(clk_gate_register_test_parent_data_legacy),\n\tKUNIT_CASE(clk_gate_register_test_parent_hw),\n\tKUNIT_CASE(clk_gate_register_test_hiword_invalid),\n\t{}\n};\n\nstatic struct kunit_suite clk_gate_register_test_suite = {\n\t.name = \"clk-gate-register-test\",\n\t.test_cases = clk_gate_register_test_cases,\n};\n\nstruct clk_gate_test_context {\n\tvoid __iomem *fake_mem;\n\tstruct clk_hw *hw;\n\tstruct clk_hw *parent;\n\tu32 fake_reg;  \n};\n\nstatic struct clk_gate_test_context *clk_gate_test_alloc_ctx(struct kunit *test)\n{\n\tstruct clk_gate_test_context *ctx;\n\n\ttest->priv = ctx = kunit_kzalloc(test, sizeof(*ctx), GFP_KERNEL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, ctx);\n\tctx->fake_mem = (void __force __iomem *)&ctx->fake_reg;\n\n\treturn ctx;\n}\n\nstatic void clk_gate_test_parent_rate(struct kunit *test)\n{\n\tstruct clk_gate_test_context *ctx = test->priv;\n\tstruct clk_hw *parent = ctx->parent;\n\tstruct clk_hw *hw = ctx->hw;\n\tunsigned long prate = clk_hw_get_rate(parent);\n\tunsigned long rate = clk_hw_get_rate(hw);\n\n\tKUNIT_EXPECT_EQ(test, prate, rate);\n}\n\nstatic void clk_gate_test_enable(struct kunit *test)\n{\n\tstruct clk_gate_test_context *ctx = test->priv;\n\tstruct clk_hw *parent = ctx->parent;\n\tstruct clk_hw *hw = ctx->hw;\n\tstruct clk *clk = hw->clk;\n\tu32 enable_val = BIT(5);\n\n\tKUNIT_ASSERT_EQ(test, clk_prepare_enable(clk), 0);\n\n\tKUNIT_EXPECT_EQ(test, enable_val, ctx->fake_reg);\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_enabled(hw));\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_prepared(hw));\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_enabled(parent));\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_prepared(parent));\n}\n\nstatic void clk_gate_test_disable(struct kunit *test)\n{\n\tstruct clk_gate_test_context *ctx = test->priv;\n\tstruct clk_hw *parent = ctx->parent;\n\tstruct clk_hw *hw = ctx->hw;\n\tstruct clk *clk = hw->clk;\n\tu32 enable_val = BIT(5);\n\tu32 disable_val = 0;\n\n\tKUNIT_ASSERT_EQ(test, clk_prepare_enable(clk), 0);\n\tKUNIT_ASSERT_EQ(test, enable_val, ctx->fake_reg);\n\n\tclk_disable_unprepare(clk);\n\tKUNIT_EXPECT_EQ(test, disable_val, ctx->fake_reg);\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_enabled(hw));\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_prepared(hw));\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_enabled(parent));\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_prepared(parent));\n}\n\nstatic struct kunit_case clk_gate_test_cases[] = {\n\tKUNIT_CASE(clk_gate_test_parent_rate),\n\tKUNIT_CASE(clk_gate_test_enable),\n\tKUNIT_CASE(clk_gate_test_disable),\n\t{}\n};\n\nstatic int clk_gate_test_init(struct kunit *test)\n{\n\tstruct clk_hw *parent;\n\tstruct clk_hw *hw;\n\tstruct clk_gate_test_context *ctx;\n\n\tctx = clk_gate_test_alloc_ctx(test);\n\tparent = clk_hw_register_fixed_rate(NULL, \"test_parent\", NULL, 0,\n\t\t\t\t\t    2000000);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, parent);\n\n\thw = clk_hw_register_gate_parent_hw(NULL, \"test_gate\", parent, 0,\n\t\t\t\t\t    ctx->fake_mem, 5, 0, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, hw);\n\n\tctx->hw = hw;\n\tctx->parent = parent;\n\n\treturn 0;\n}\n\nstatic void clk_gate_test_exit(struct kunit *test)\n{\n\tstruct clk_gate_test_context *ctx = test->priv;\n\n\tclk_hw_unregister_gate(ctx->hw);\n\tclk_hw_unregister_fixed_rate(ctx->parent);\n}\n\nstatic struct kunit_suite clk_gate_test_suite = {\n\t.name = \"clk-gate-test\",\n\t.init = clk_gate_test_init,\n\t.exit = clk_gate_test_exit,\n\t.test_cases = clk_gate_test_cases,\n};\n\nstatic void clk_gate_test_invert_enable(struct kunit *test)\n{\n\tstruct clk_gate_test_context *ctx = test->priv;\n\tstruct clk_hw *parent = ctx->parent;\n\tstruct clk_hw *hw = ctx->hw;\n\tstruct clk *clk = hw->clk;\n\tu32 enable_val = 0;\n\n\tKUNIT_ASSERT_EQ(test, clk_prepare_enable(clk), 0);\n\n\tKUNIT_EXPECT_EQ(test, enable_val, ctx->fake_reg);\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_enabled(hw));\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_prepared(hw));\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_enabled(parent));\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_prepared(parent));\n}\n\nstatic void clk_gate_test_invert_disable(struct kunit *test)\n{\n\tstruct clk_gate_test_context *ctx = test->priv;\n\tstruct clk_hw *parent = ctx->parent;\n\tstruct clk_hw *hw = ctx->hw;\n\tstruct clk *clk = hw->clk;\n\tu32 enable_val = 0;\n\tu32 disable_val = BIT(15);\n\n\tKUNIT_ASSERT_EQ(test, clk_prepare_enable(clk), 0);\n\tKUNIT_ASSERT_EQ(test, enable_val, ctx->fake_reg);\n\n\tclk_disable_unprepare(clk);\n\tKUNIT_EXPECT_EQ(test, disable_val, ctx->fake_reg);\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_enabled(hw));\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_prepared(hw));\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_enabled(parent));\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_prepared(parent));\n}\n\nstatic struct kunit_case clk_gate_test_invert_cases[] = {\n\tKUNIT_CASE(clk_gate_test_invert_enable),\n\tKUNIT_CASE(clk_gate_test_invert_disable),\n\t{}\n};\n\nstatic int clk_gate_test_invert_init(struct kunit *test)\n{\n\tstruct clk_hw *parent;\n\tstruct clk_hw *hw;\n\tstruct clk_gate_test_context *ctx;\n\n\tctx = clk_gate_test_alloc_ctx(test);\n\tparent = clk_hw_register_fixed_rate(NULL, \"test_parent\", NULL, 0,\n\t\t\t\t\t    2000000);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, parent);\n\n\tctx->fake_reg = BIT(15);  \n\thw = clk_hw_register_gate_parent_hw(NULL, \"test_gate\", parent, 0,\n\t\t\t\t\t    ctx->fake_mem, 15,\n\t\t\t\t\t    CLK_GATE_SET_TO_DISABLE, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, hw);\n\n\tctx->hw = hw;\n\tctx->parent = parent;\n\n\treturn 0;\n}\n\nstatic struct kunit_suite clk_gate_test_invert_suite = {\n\t.name = \"clk-gate-invert-test\",\n\t.init = clk_gate_test_invert_init,\n\t.exit = clk_gate_test_exit,\n\t.test_cases = clk_gate_test_invert_cases,\n};\n\nstatic void clk_gate_test_hiword_enable(struct kunit *test)\n{\n\tstruct clk_gate_test_context *ctx = test->priv;\n\tstruct clk_hw *parent = ctx->parent;\n\tstruct clk_hw *hw = ctx->hw;\n\tstruct clk *clk = hw->clk;\n\tu32 enable_val = BIT(9) | BIT(9 + 16);\n\n\tKUNIT_ASSERT_EQ(test, clk_prepare_enable(clk), 0);\n\n\tKUNIT_EXPECT_EQ(test, enable_val, ctx->fake_reg);\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_enabled(hw));\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_prepared(hw));\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_enabled(parent));\n\tKUNIT_EXPECT_TRUE(test, clk_hw_is_prepared(parent));\n}\n\nstatic void clk_gate_test_hiword_disable(struct kunit *test)\n{\n\tstruct clk_gate_test_context *ctx = test->priv;\n\tstruct clk_hw *parent = ctx->parent;\n\tstruct clk_hw *hw = ctx->hw;\n\tstruct clk *clk = hw->clk;\n\tu32 enable_val = BIT(9) | BIT(9 + 16);\n\tu32 disable_val = BIT(9 + 16);\n\n\tKUNIT_ASSERT_EQ(test, clk_prepare_enable(clk), 0);\n\tKUNIT_ASSERT_EQ(test, enable_val, ctx->fake_reg);\n\n\tclk_disable_unprepare(clk);\n\tKUNIT_EXPECT_EQ(test, disable_val, ctx->fake_reg);\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_enabled(hw));\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_prepared(hw));\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_enabled(parent));\n\tKUNIT_EXPECT_FALSE(test, clk_hw_is_prepared(parent));\n}\n\nstatic struct kunit_case clk_gate_test_hiword_cases[] = {\n\tKUNIT_CASE(clk_gate_test_hiword_enable),\n\tKUNIT_CASE(clk_gate_test_hiword_disable),\n\t{}\n};\n\nstatic int clk_gate_test_hiword_init(struct kunit *test)\n{\n\tstruct clk_hw *parent;\n\tstruct clk_hw *hw;\n\tstruct clk_gate_test_context *ctx;\n\n\tctx = clk_gate_test_alloc_ctx(test);\n\tparent = clk_hw_register_fixed_rate(NULL, \"test_parent\", NULL, 0,\n\t\t\t\t\t    2000000);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, parent);\n\n\thw = clk_hw_register_gate_parent_hw(NULL, \"test_gate\", parent, 0,\n\t\t\t\t\t    ctx->fake_mem, 9,\n\t\t\t\t\t    CLK_GATE_HIWORD_MASK, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, hw);\n\n\tctx->hw = hw;\n\tctx->parent = parent;\n\n\treturn 0;\n}\n\nstatic struct kunit_suite clk_gate_test_hiword_suite = {\n\t.name = \"clk-gate-hiword-test\",\n\t.init = clk_gate_test_hiword_init,\n\t.exit = clk_gate_test_exit,\n\t.test_cases = clk_gate_test_hiword_cases,\n};\n\nstatic void clk_gate_test_is_enabled(struct kunit *test)\n{\n\tstruct clk_hw *hw;\n\tstruct clk_gate_test_context *ctx;\n\n\tctx = clk_gate_test_alloc_ctx(test);\n\tctx->fake_reg = BIT(7);\n\thw = clk_hw_register_gate(NULL, \"test_gate\", NULL, 0, ctx->fake_mem, 7,\n\t\t\t\t  0, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, hw);\n\tKUNIT_ASSERT_TRUE(test, clk_hw_is_enabled(hw));\n\n\tclk_hw_unregister_gate(hw);\n}\n\nstatic void clk_gate_test_is_disabled(struct kunit *test)\n{\n\tstruct clk_hw *hw;\n\tstruct clk_gate_test_context *ctx;\n\n\tctx = clk_gate_test_alloc_ctx(test);\n\tctx->fake_reg = BIT(4);\n\thw = clk_hw_register_gate(NULL, \"test_gate\", NULL, 0, ctx->fake_mem, 7,\n\t\t\t\t  0, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, hw);\n\tKUNIT_ASSERT_FALSE(test, clk_hw_is_enabled(hw));\n\n\tclk_hw_unregister_gate(hw);\n}\n\nstatic void clk_gate_test_is_enabled_inverted(struct kunit *test)\n{\n\tstruct clk_hw *hw;\n\tstruct clk_gate_test_context *ctx;\n\n\tctx = clk_gate_test_alloc_ctx(test);\n\tctx->fake_reg = BIT(31);\n\thw = clk_hw_register_gate(NULL, \"test_gate\", NULL, 0, ctx->fake_mem, 2,\n\t\t\t\t  CLK_GATE_SET_TO_DISABLE, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, hw);\n\tKUNIT_ASSERT_TRUE(test, clk_hw_is_enabled(hw));\n\n\tclk_hw_unregister_gate(hw);\n}\n\nstatic void clk_gate_test_is_disabled_inverted(struct kunit *test)\n{\n\tstruct clk_hw *hw;\n\tstruct clk_gate_test_context *ctx;\n\n\tctx = clk_gate_test_alloc_ctx(test);\n\tctx->fake_reg = BIT(29);\n\thw = clk_hw_register_gate(NULL, \"test_gate\", NULL, 0, ctx->fake_mem, 29,\n\t\t\t\t  CLK_GATE_SET_TO_DISABLE, NULL);\n\tKUNIT_ASSERT_NOT_ERR_OR_NULL(test, hw);\n\tKUNIT_ASSERT_FALSE(test, clk_hw_is_enabled(hw));\n\n\tclk_hw_unregister_gate(hw);\n}\n\nstatic struct kunit_case clk_gate_test_enabled_cases[] = {\n\tKUNIT_CASE(clk_gate_test_is_enabled),\n\tKUNIT_CASE(clk_gate_test_is_disabled),\n\tKUNIT_CASE(clk_gate_test_is_enabled_inverted),\n\tKUNIT_CASE(clk_gate_test_is_disabled_inverted),\n\t{}\n};\n\nstatic struct kunit_suite clk_gate_test_enabled_suite = {\n\t.name = \"clk-gate-is_enabled-test\",\n\t.test_cases = clk_gate_test_enabled_cases,\n};\n\nkunit_test_suites(\n\t&clk_gate_register_test_suite,\n\t&clk_gate_test_suite,\n\t&clk_gate_test_invert_suite,\n\t&clk_gate_test_hiword_suite,\n\t&clk_gate_test_enabled_suite\n);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}