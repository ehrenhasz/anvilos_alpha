{
  "module_name": "jz4770-cgu.c",
  "hash_id": "a69000373730d021847de40cee710d11dc3163ca1165353c28becabe1e2d4eff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/ingenic/jz4770-cgu.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/clk-provider.h>\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/of.h>\n\n#include <dt-bindings/clock/ingenic,jz4770-cgu.h>\n\n#include \"cgu.h\"\n#include \"pm.h\"\n\n \n#define CGU_REG_CPCCR\t\t0x00\n#define CGU_REG_LCR\t\t0x04\n#define CGU_REG_CPPCR0\t\t0x10\n#define CGU_REG_CLKGR0\t\t0x20\n#define CGU_REG_OPCR\t\t0x24\n#define CGU_REG_CLKGR1\t\t0x28\n#define CGU_REG_CPPCR1\t\t0x30\n#define CGU_REG_USBPCR1\t\t0x48\n#define CGU_REG_USBCDR\t\t0x50\n#define CGU_REG_I2SCDR\t\t0x60\n#define CGU_REG_LPCDR\t\t0x64\n#define CGU_REG_MSC0CDR\t\t0x68\n#define CGU_REG_UHCCDR\t\t0x6c\n#define CGU_REG_SSICDR\t\t0x74\n#define CGU_REG_CIMCDR\t\t0x7c\n#define CGU_REG_GPSCDR\t\t0x80\n#define CGU_REG_PCMCDR\t\t0x84\n#define CGU_REG_GPUCDR\t\t0x88\n#define CGU_REG_MSC1CDR\t\t0xA4\n#define CGU_REG_MSC2CDR\t\t0xA8\n#define CGU_REG_BCHCDR\t\t0xAC\n\n \n#define OPCR_SPENDH\t\tBIT(5)\t\t \n\n \n#define USBPCR1_UHC_POWER\tBIT(5)\t\t \n\nstatic struct ingenic_cgu *cgu;\n\nstatic int jz4770_uhc_phy_enable(struct clk_hw *hw)\n{\n\tvoid __iomem *reg_opcr\t\t= cgu->base + CGU_REG_OPCR;\n\tvoid __iomem *reg_usbpcr1\t= cgu->base + CGU_REG_USBPCR1;\n\n\twritel(readl(reg_opcr) & ~OPCR_SPENDH, reg_opcr);\n\twritel(readl(reg_usbpcr1) | USBPCR1_UHC_POWER, reg_usbpcr1);\n\treturn 0;\n}\n\nstatic void jz4770_uhc_phy_disable(struct clk_hw *hw)\n{\n\tvoid __iomem *reg_opcr\t\t= cgu->base + CGU_REG_OPCR;\n\tvoid __iomem *reg_usbpcr1\t= cgu->base + CGU_REG_USBPCR1;\n\n\twritel(readl(reg_usbpcr1) & ~USBPCR1_UHC_POWER, reg_usbpcr1);\n\twritel(readl(reg_opcr) | OPCR_SPENDH, reg_opcr);\n}\n\nstatic int jz4770_uhc_phy_is_enabled(struct clk_hw *hw)\n{\n\tvoid __iomem *reg_opcr\t\t= cgu->base + CGU_REG_OPCR;\n\tvoid __iomem *reg_usbpcr1\t= cgu->base + CGU_REG_USBPCR1;\n\n\treturn !(readl(reg_opcr) & OPCR_SPENDH) &&\n\t\t(readl(reg_usbpcr1) & USBPCR1_UHC_POWER);\n}\n\nstatic const struct clk_ops jz4770_uhc_phy_ops = {\n\t.enable = jz4770_uhc_phy_enable,\n\t.disable = jz4770_uhc_phy_disable,\n\t.is_enabled = jz4770_uhc_phy_is_enabled,\n};\n\nstatic const s8 pll_od_encoding[8] = {\n\t0x0, 0x1, -1, 0x2, -1, -1, -1, 0x3,\n};\n\nstatic const u8 jz4770_cgu_cpccr_div_table[] = {\n\t1, 2, 3, 4, 6, 8, 12,\n};\n\nstatic const struct ingenic_cgu_clk_info jz4770_cgu_clocks[] = {\n\n\t \n\n\t[JZ4770_CLK_EXT] = { \"ext\", CGU_CLK_EXT },\n\t[JZ4770_CLK_OSC32K] = { \"osc32k\", CGU_CLK_EXT },\n\n\t \n\n\t[JZ4770_CLK_PLL0] = {\n\t\t\"pll0\", CGU_CLK_PLL,\n\t\t.parents = { JZ4770_CLK_EXT },\n\t\t.pll = {\n\t\t\t.reg = CGU_REG_CPPCR0,\n\t\t\t.rate_multiplier = 1,\n\t\t\t.m_shift = 24,\n\t\t\t.m_bits = 7,\n\t\t\t.m_offset = 1,\n\t\t\t.n_shift = 18,\n\t\t\t.n_bits = 5,\n\t\t\t.n_offset = 1,\n\t\t\t.od_shift = 16,\n\t\t\t.od_bits = 2,\n\t\t\t.od_max = 8,\n\t\t\t.od_encoding = pll_od_encoding,\n\t\t\t.bypass_reg = CGU_REG_CPPCR0,\n\t\t\t.bypass_bit = 9,\n\t\t\t.enable_bit = 8,\n\t\t\t.stable_bit = 10,\n\t\t},\n\t},\n\n\t[JZ4770_CLK_PLL1] = {\n\t\t \n\t\t\"pll1\", CGU_CLK_PLL,\n\t\t.parents = { JZ4770_CLK_EXT },\n\t\t.pll = {\n\t\t\t.reg = CGU_REG_CPPCR1,\n\t\t\t.rate_multiplier = 1,\n\t\t\t.m_shift = 24,\n\t\t\t.m_bits = 7,\n\t\t\t.m_offset = 1,\n\t\t\t.n_shift = 18,\n\t\t\t.n_bits = 5,\n\t\t\t.n_offset = 1,\n\t\t\t.od_shift = 16,\n\t\t\t.od_bits = 2,\n\t\t\t.od_max = 8,\n\t\t\t.od_encoding = pll_od_encoding,\n\t\t\t.bypass_bit = -1,\n\t\t\t.enable_bit = 7,\n\t\t\t.stable_bit = 6,\n\t\t},\n\t},\n\n\t \n\n\t[JZ4770_CLK_CCLK] = {\n\t\t\"cclk\", CGU_CLK_DIV,\n\t\t \n\t\t.flags = CLK_IS_CRITICAL,\n\t\t.parents = { JZ4770_CLK_PLL0, },\n\t\t.div = {\n\t\t\tCGU_REG_CPCCR, 0, 1, 4, 22, -1, -1, 0,\n\t\t\tjz4770_cgu_cpccr_div_table,\n\t\t},\n\t},\n\t[JZ4770_CLK_H0CLK] = {\n\t\t\"h0clk\", CGU_CLK_DIV,\n\t\t.parents = { JZ4770_CLK_PLL0, },\n\t\t.div = {\n\t\t\tCGU_REG_CPCCR, 4, 1, 4, 22, -1, -1, 0,\n\t\t\tjz4770_cgu_cpccr_div_table,\n\t\t},\n\t},\n\t[JZ4770_CLK_H1CLK] = {\n\t\t\"h1clk\", CGU_CLK_DIV | CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_PLL0, },\n\t\t.div = {\n\t\t\tCGU_REG_CPCCR, 24, 1, 4, 22, -1, -1, 0,\n\t\t\tjz4770_cgu_cpccr_div_table,\n\t\t},\n\t\t.gate = { CGU_REG_CLKGR1, 7 },\n\t},\n\t[JZ4770_CLK_H2CLK] = {\n\t\t\"h2clk\", CGU_CLK_DIV,\n\t\t.parents = { JZ4770_CLK_PLL0, },\n\t\t.div = {\n\t\t\tCGU_REG_CPCCR, 16, 1, 4, 22, -1, -1, 0,\n\t\t\tjz4770_cgu_cpccr_div_table,\n\t\t},\n\t},\n\t[JZ4770_CLK_C1CLK] = {\n\t\t\"c1clk\", CGU_CLK_DIV | CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_PLL0, },\n\t\t.div = {\n\t\t\tCGU_REG_CPCCR, 12, 1, 4, 22, -1, -1, 0,\n\t\t\tjz4770_cgu_cpccr_div_table,\n\t\t},\n\t\t.gate = { CGU_REG_OPCR, 31, true }, \n\t},\n\t[JZ4770_CLK_PCLK] = {\n\t\t\"pclk\", CGU_CLK_DIV,\n\t\t.parents = { JZ4770_CLK_PLL0, },\n\t\t.div = {\n\t\t\tCGU_REG_CPCCR, 8, 1, 4, 22, -1, -1, 0,\n\t\t\tjz4770_cgu_cpccr_div_table,\n\t\t},\n\t},\n\n\t \n\n\t[JZ4770_CLK_MMC0_MUX] = {\n\t\t\"mmc0_mux\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_PLL0, JZ4770_CLK_PLL1, },\n\t\t.mux = { CGU_REG_MSC0CDR, 30, 1 },\n\t\t.div = { CGU_REG_MSC0CDR, 0, 1, 7, -1, -1, 31 },\n\t\t.gate = { CGU_REG_MSC0CDR, 31 },\n\t},\n\t[JZ4770_CLK_MMC1_MUX] = {\n\t\t\"mmc1_mux\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_PLL0, JZ4770_CLK_PLL1, },\n\t\t.mux = { CGU_REG_MSC1CDR, 30, 1 },\n\t\t.div = { CGU_REG_MSC1CDR, 0, 1, 7, -1, -1, 31 },\n\t\t.gate = { CGU_REG_MSC1CDR, 31 },\n\t},\n\t[JZ4770_CLK_MMC2_MUX] = {\n\t\t\"mmc2_mux\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_PLL0, JZ4770_CLK_PLL1, },\n\t\t.mux = { CGU_REG_MSC2CDR, 30, 1 },\n\t\t.div = { CGU_REG_MSC2CDR, 0, 1, 7, -1, -1, 31 },\n\t\t.gate = { CGU_REG_MSC2CDR, 31 },\n\t},\n\t[JZ4770_CLK_CIM] = {\n\t\t\"cim\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_PLL0, JZ4770_CLK_PLL1, },\n\t\t.mux = { CGU_REG_CIMCDR, 31, 1 },\n\t\t.div = { CGU_REG_CIMCDR, 0, 1, 8, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 26 },\n\t},\n\t[JZ4770_CLK_UHC] = {\n\t\t\"uhc\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_PLL0, JZ4770_CLK_PLL1, },\n\t\t.mux = { CGU_REG_UHCCDR, 29, 1 },\n\t\t.div = { CGU_REG_UHCCDR, 0, 1, 4, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 24 },\n\t},\n\t[JZ4770_CLK_GPU] = {\n\t\t\"gpu\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_PLL0, JZ4770_CLK_PLL1, -1 },\n\t\t.mux = { CGU_REG_GPUCDR, 31, 1 },\n\t\t.div = { CGU_REG_GPUCDR, 0, 1, 3, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR1, 9 },\n\t},\n\t[JZ4770_CLK_BCH] = {\n\t\t\"bch\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_PLL0, JZ4770_CLK_PLL1, },\n\t\t.mux = { CGU_REG_BCHCDR, 31, 1 },\n\t\t.div = { CGU_REG_BCHCDR, 0, 1, 3, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 1 },\n\t},\n\t[JZ4770_CLK_LPCLK_MUX] = {\n\t\t\"lpclk\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_PLL0, JZ4770_CLK_PLL1, },\n\t\t.mux = { CGU_REG_LPCDR, 29, 1 },\n\t\t.div = { CGU_REG_LPCDR, 0, 1, 11, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 28 },\n\t},\n\t[JZ4770_CLK_GPS] = {\n\t\t\"gps\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_PLL0, JZ4770_CLK_PLL1, },\n\t\t.mux = { CGU_REG_GPSCDR, 31, 1 },\n\t\t.div = { CGU_REG_GPSCDR, 0, 1, 4, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 22 },\n\t},\n\n\t \n\n\t[JZ4770_CLK_SSI_MUX] = {\n\t\t\"ssi_mux\", CGU_CLK_DIV | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_EXT, -1,\n\t\t\tJZ4770_CLK_PLL0, JZ4770_CLK_PLL1 },\n\t\t.mux = { CGU_REG_SSICDR, 30, 2 },\n\t\t.div = { CGU_REG_SSICDR, 0, 1, 6, -1, -1, -1 },\n\t},\n\t[JZ4770_CLK_PCM_MUX] = {\n\t\t\"pcm_mux\", CGU_CLK_DIV | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_EXT, -1,\n\t\t\tJZ4770_CLK_PLL0, JZ4770_CLK_PLL1 },\n\t\t.mux = { CGU_REG_PCMCDR, 30, 2 },\n\t\t.div = { CGU_REG_PCMCDR, 0, 1, 9, -1, -1, -1 },\n\t},\n\t[JZ4770_CLK_I2S] = {\n\t\t\"i2s\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_EXT, -1,\n\t\t\tJZ4770_CLK_PLL0, JZ4770_CLK_PLL1 },\n\t\t.mux = { CGU_REG_I2SCDR, 30, 2 },\n\t\t.div = { CGU_REG_I2SCDR, 0, 1, 9, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR1, 13 },\n\t},\n\t[JZ4770_CLK_OTG] = {\n\t\t\"usb\", CGU_CLK_DIV | CGU_CLK_GATE | CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_EXT, -1,\n\t\t\tJZ4770_CLK_PLL0, JZ4770_CLK_PLL1 },\n\t\t.mux = { CGU_REG_USBCDR, 30, 2 },\n\t\t.div = { CGU_REG_USBCDR, 0, 1, 8, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 2 },\n\t},\n\n\t \n\n\t[JZ4770_CLK_SSI0] = {\n\t\t\"ssi0\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_SSI_MUX, },\n\t\t.gate = { CGU_REG_CLKGR0, 4 },\n\t},\n\t[JZ4770_CLK_SSI1] = {\n\t\t\"ssi1\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_SSI_MUX, },\n\t\t.gate = { CGU_REG_CLKGR0, 19 },\n\t},\n\t[JZ4770_CLK_SSI2] = {\n\t\t\"ssi2\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_SSI_MUX, },\n\t\t.gate = { CGU_REG_CLKGR0, 20 },\n\t},\n\t[JZ4770_CLK_PCM0] = {\n\t\t\"pcm0\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_PCM_MUX, },\n\t\t.gate = { CGU_REG_CLKGR1, 8 },\n\t},\n\t[JZ4770_CLK_PCM1] = {\n\t\t\"pcm1\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_PCM_MUX, },\n\t\t.gate = { CGU_REG_CLKGR1, 10 },\n\t},\n\t[JZ4770_CLK_DMA] = {\n\t\t\"dma\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_H2CLK, },\n\t\t.gate = { CGU_REG_CLKGR0, 21 },\n\t},\n\t[JZ4770_CLK_BDMA] = {\n\t\t\"bdma\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_H2CLK, },\n\t\t.gate = { CGU_REG_CLKGR1, 0 },\n\t},\n\t[JZ4770_CLK_I2C0] = {\n\t\t\"i2c0\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_EXT, },\n\t\t.gate = { CGU_REG_CLKGR0, 5 },\n\t},\n\t[JZ4770_CLK_I2C1] = {\n\t\t\"i2c1\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_EXT, },\n\t\t.gate = { CGU_REG_CLKGR0, 6 },\n\t},\n\t[JZ4770_CLK_I2C2] = {\n\t\t\"i2c2\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_EXT, },\n\t\t.gate = { CGU_REG_CLKGR1, 15 },\n\t},\n\t[JZ4770_CLK_UART0] = {\n\t\t\"uart0\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_EXT, },\n\t\t.gate = { CGU_REG_CLKGR0, 15 },\n\t},\n\t[JZ4770_CLK_UART1] = {\n\t\t\"uart1\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_EXT, },\n\t\t.gate = { CGU_REG_CLKGR0, 16 },\n\t},\n\t[JZ4770_CLK_UART2] = {\n\t\t\"uart2\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_EXT, },\n\t\t.gate = { CGU_REG_CLKGR0, 17 },\n\t},\n\t[JZ4770_CLK_UART3] = {\n\t\t\"uart3\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_EXT, },\n\t\t.gate = { CGU_REG_CLKGR0, 18 },\n\t},\n\t[JZ4770_CLK_IPU] = {\n\t\t\"ipu\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_H0CLK, },\n\t\t.gate = { CGU_REG_CLKGR0, 29 },\n\t},\n\t[JZ4770_CLK_ADC] = {\n\t\t\"adc\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_EXT, },\n\t\t.gate = { CGU_REG_CLKGR0, 14 },\n\t},\n\t[JZ4770_CLK_AIC] = {\n\t\t\"aic\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_EXT, },\n\t\t.gate = { CGU_REG_CLKGR0, 8 },\n\t},\n\t[JZ4770_CLK_AUX] = {\n\t\t\"aux\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_C1CLK, },\n\t\t.gate = { CGU_REG_CLKGR1, 14 },\n\t},\n\t[JZ4770_CLK_VPU] = {\n\t\t\"vpu\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_H1CLK, },\n\t\t.gate = { CGU_REG_LCR, 30, false, 150 },\n\t},\n\t[JZ4770_CLK_MMC0] = {\n\t\t\"mmc0\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_MMC0_MUX, },\n\t\t.gate = { CGU_REG_CLKGR0, 3 },\n\t},\n\t[JZ4770_CLK_MMC1] = {\n\t\t\"mmc1\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_MMC1_MUX, },\n\t\t.gate = { CGU_REG_CLKGR0, 11 },\n\t},\n\t[JZ4770_CLK_MMC2] = {\n\t\t\"mmc2\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_MMC2_MUX, },\n\t\t.gate = { CGU_REG_CLKGR0, 12 },\n\t},\n\t[JZ4770_CLK_OTG_PHY] = {\n\t\t\"usb_phy\", CGU_CLK_GATE,\n\t\t.parents = { JZ4770_CLK_OTG },\n\t\t.gate = { CGU_REG_OPCR, 7, true, 50 },\n\t},\n\n\t \n\n\t[JZ4770_CLK_UHC_PHY] = {\n\t\t\"uhc_phy\", CGU_CLK_CUSTOM,\n\t\t.parents = { JZ4770_CLK_UHC, -1, -1, -1 },\n\t\t.custom = { &jz4770_uhc_phy_ops },\n\t},\n\n\t[JZ4770_CLK_EXT512] = {\n\t\t\"ext/512\", CGU_CLK_FIXDIV,\n\t\t.parents = { JZ4770_CLK_EXT },\n\t\t.fixdiv = { 512 },\n\t},\n\n\t[JZ4770_CLK_RTC] = {\n\t\t\"rtc\", CGU_CLK_MUX,\n\t\t.parents = { JZ4770_CLK_EXT512, JZ4770_CLK_OSC32K, },\n\t\t.mux = { CGU_REG_OPCR, 2, 1},\n\t},\n};\n\nstatic void __init jz4770_cgu_init(struct device_node *np)\n{\n\tint retval;\n\n\tcgu = ingenic_cgu_new(jz4770_cgu_clocks,\n\t\t\t      ARRAY_SIZE(jz4770_cgu_clocks), np);\n\tif (!cgu) {\n\t\tpr_err(\"%s: failed to initialise CGU\\n\", __func__);\n\t\treturn;\n\t}\n\n\tretval = ingenic_cgu_register_clocks(cgu);\n\tif (retval)\n\t\tpr_err(\"%s: failed to register CGU Clocks\\n\", __func__);\n\n\tingenic_cgu_register_syscore_ops(cgu);\n}\n\n \nCLK_OF_DECLARE_DRIVER(jz4770_cgu, \"ingenic,jz4770-cgu\", jz4770_cgu_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}