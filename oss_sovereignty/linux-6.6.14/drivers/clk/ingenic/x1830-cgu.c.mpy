{
  "module_name": "x1830-cgu.c",
  "hash_id": "3f017cc7ad51b74234b1706f966c3b0836b3ee665dc5d95d4f6669cfa9cc92b7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/ingenic/x1830-cgu.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/of.h>\n\n#include <dt-bindings/clock/ingenic,x1830-cgu.h>\n\n#include \"cgu.h\"\n#include \"pm.h\"\n\n \n#define CGU_REG_CPCCR\t\t0x00\n#define CGU_REG_CPPCR\t\t0x0c\n#define CGU_REG_APLL\t\t0x10\n#define CGU_REG_MPLL\t\t0x14\n#define CGU_REG_CLKGR0\t\t0x20\n#define CGU_REG_OPCR\t\t0x24\n#define CGU_REG_CLKGR1\t\t0x28\n#define CGU_REG_DDRCDR\t\t0x2c\n#define CGU_REG_USBPCR\t\t0x3c\n#define CGU_REG_USBRDT\t\t0x40\n#define CGU_REG_USBVBFIL\t0x44\n#define CGU_REG_USBPCR1\t\t0x48\n#define CGU_REG_MACCDR\t\t0x54\n#define CGU_REG_EPLL\t\t0x58\n#define CGU_REG_I2SCDR\t\t0x60\n#define CGU_REG_LPCDR\t\t0x64\n#define CGU_REG_MSC0CDR\t\t0x68\n#define CGU_REG_I2SCDR1\t\t0x70\n#define CGU_REG_SSICDR\t\t0x74\n#define CGU_REG_CIMCDR\t\t0x7c\n#define CGU_REG_MSC1CDR\t\t0xa4\n#define CGU_REG_CMP_INTR\t0xb0\n#define CGU_REG_CMP_INTRE\t0xb4\n#define CGU_REG_DRCG\t\t0xd0\n#define CGU_REG_CPCSR\t\t0xd4\n#define CGU_REG_VPLL\t\t0xe0\n#define CGU_REG_MACPHYC\t\t0xe8\n\n \n#define OPCR_GATE_USBPHYCLK\tBIT(23)\n#define OPCR_SPENDN0\t\tBIT(7)\n#define OPCR_SPENDN1\t\tBIT(6)\n\n \n#define USBPCR_SIDDQ\t\tBIT(21)\n#define USBPCR_OTG_DISABLE\tBIT(20)\n\nstatic struct ingenic_cgu *cgu;\n\nstatic int x1830_usb_phy_enable(struct clk_hw *hw)\n{\n\tvoid __iomem *reg_opcr\t\t= cgu->base + CGU_REG_OPCR;\n\tvoid __iomem *reg_usbpcr\t= cgu->base + CGU_REG_USBPCR;\n\n\twritel((readl(reg_opcr) | OPCR_SPENDN0) & ~OPCR_GATE_USBPHYCLK, reg_opcr);\n\twritel(readl(reg_usbpcr) & ~USBPCR_OTG_DISABLE & ~USBPCR_SIDDQ, reg_usbpcr);\n\treturn 0;\n}\n\nstatic void x1830_usb_phy_disable(struct clk_hw *hw)\n{\n\tvoid __iomem *reg_opcr\t\t= cgu->base + CGU_REG_OPCR;\n\tvoid __iomem *reg_usbpcr\t= cgu->base + CGU_REG_USBPCR;\n\n\twritel((readl(reg_opcr) & ~OPCR_SPENDN0) | OPCR_GATE_USBPHYCLK, reg_opcr);\n\twritel(readl(reg_usbpcr) | USBPCR_OTG_DISABLE | USBPCR_SIDDQ, reg_usbpcr);\n}\n\nstatic int x1830_usb_phy_is_enabled(struct clk_hw *hw)\n{\n\tvoid __iomem *reg_opcr\t\t= cgu->base + CGU_REG_OPCR;\n\tvoid __iomem *reg_usbpcr\t= cgu->base + CGU_REG_USBPCR;\n\n\treturn (readl(reg_opcr) & OPCR_SPENDN0) &&\n\t\t!(readl(reg_usbpcr) & USBPCR_SIDDQ) &&\n\t\t!(readl(reg_usbpcr) & USBPCR_OTG_DISABLE);\n}\n\nstatic const struct clk_ops x1830_otg_phy_ops = {\n\t.enable\t\t= x1830_usb_phy_enable,\n\t.disable\t= x1830_usb_phy_disable,\n\t.is_enabled\t= x1830_usb_phy_is_enabled,\n};\n\nstatic const s8 pll_od_encoding[64] = {\n\t0x0, 0x1,  -1, 0x2,  -1,  -1,  -1, 0x3,\n\t -1,  -1,  -1,  -1,  -1,  -1,  -1, 0x4,\n\t -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,\n\t -1,  -1,  -1,  -1,  -1,  -1,  -1, 0x5,\n\t -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,\n\t -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,\n\t -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,\n\t -1,  -1,  -1,  -1,  -1,  -1,  -1, 0x6,\n};\n\nstatic const struct ingenic_cgu_clk_info x1830_cgu_clocks[] = {\n\n\t \n\n\t[X1830_CLK_EXCLK] = { \"ext\", CGU_CLK_EXT },\n\t[X1830_CLK_RTCLK] = { \"rtc\", CGU_CLK_EXT },\n\n\t \n\n\t[X1830_CLK_APLL] = {\n\t\t\"apll\", CGU_CLK_PLL,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.pll = {\n\t\t\t.reg = CGU_REG_APLL,\n\t\t\t.rate_multiplier = 2,\n\t\t\t.m_shift = 20,\n\t\t\t.m_bits = 9,\n\t\t\t.m_offset = 1,\n\t\t\t.n_shift = 14,\n\t\t\t.n_bits = 6,\n\t\t\t.n_offset = 1,\n\t\t\t.od_shift = 11,\n\t\t\t.od_bits = 3,\n\t\t\t.od_max = 64,\n\t\t\t.od_encoding = pll_od_encoding,\n\t\t\t.bypass_reg = CGU_REG_CPPCR,\n\t\t\t.bypass_bit = 30,\n\t\t\t.enable_bit = 0,\n\t\t\t.stable_bit = 3,\n\t\t},\n\t},\n\n\t[X1830_CLK_MPLL] = {\n\t\t\"mpll\", CGU_CLK_PLL,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.pll = {\n\t\t\t.reg = CGU_REG_MPLL,\n\t\t\t.rate_multiplier = 2,\n\t\t\t.m_shift = 20,\n\t\t\t.m_bits = 9,\n\t\t\t.m_offset = 1,\n\t\t\t.n_shift = 14,\n\t\t\t.n_bits = 6,\n\t\t\t.n_offset = 1,\n\t\t\t.od_shift = 11,\n\t\t\t.od_bits = 3,\n\t\t\t.od_max = 64,\n\t\t\t.od_encoding = pll_od_encoding,\n\t\t\t.bypass_reg = CGU_REG_CPPCR,\n\t\t\t.bypass_bit = 28,\n\t\t\t.enable_bit = 0,\n\t\t\t.stable_bit = 3,\n\t\t},\n\t},\n\n\t[X1830_CLK_EPLL] = {\n\t\t\"epll\", CGU_CLK_PLL,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.pll = {\n\t\t\t.reg = CGU_REG_EPLL,\n\t\t\t.rate_multiplier = 2,\n\t\t\t.m_shift = 20,\n\t\t\t.m_bits = 9,\n\t\t\t.m_offset = 1,\n\t\t\t.n_shift = 14,\n\t\t\t.n_bits = 6,\n\t\t\t.n_offset = 1,\n\t\t\t.od_shift = 11,\n\t\t\t.od_bits = 3,\n\t\t\t.od_max = 64,\n\t\t\t.od_encoding = pll_od_encoding,\n\t\t\t.bypass_reg = CGU_REG_CPPCR,\n\t\t\t.bypass_bit = 24,\n\t\t\t.enable_bit = 0,\n\t\t\t.stable_bit = 3,\n\t\t},\n\t},\n\n\t[X1830_CLK_VPLL] = {\n\t\t\"vpll\", CGU_CLK_PLL,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.pll = {\n\t\t\t.reg = CGU_REG_VPLL,\n\t\t\t.rate_multiplier = 2,\n\t\t\t.m_shift = 20,\n\t\t\t.m_bits = 9,\n\t\t\t.m_offset = 1,\n\t\t\t.n_shift = 14,\n\t\t\t.n_bits = 6,\n\t\t\t.n_offset = 1,\n\t\t\t.od_shift = 11,\n\t\t\t.od_bits = 3,\n\t\t\t.od_max = 64,\n\t\t\t.od_encoding = pll_od_encoding,\n\t\t\t.bypass_reg = CGU_REG_CPPCR,\n\t\t\t.bypass_bit = 26,\n\t\t\t.enable_bit = 0,\n\t\t\t.stable_bit = 3,\n\t\t},\n\t},\n\n\t \n\n\t[X1830_CLK_OTGPHY] = {\n\t\t\"otg_phy\", CGU_CLK_CUSTOM,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.custom = { &x1830_otg_phy_ops },\n\t},\n\n\t \n\n\t[X1830_CLK_SCLKA] = {\n\t\t\"sclk_a\", CGU_CLK_MUX,\n\t\t.parents = { -1, X1830_CLK_EXCLK, X1830_CLK_APLL, -1 },\n\t\t.mux = { CGU_REG_CPCCR, 30, 2 },\n\t},\n\n\t[X1830_CLK_CPUMUX] = {\n\t\t\"cpu_mux\", CGU_CLK_MUX,\n\t\t.parents = { -1, X1830_CLK_SCLKA, X1830_CLK_MPLL, -1 },\n\t\t.mux = { CGU_REG_CPCCR, 28, 2 },\n\t},\n\n\t[X1830_CLK_CPU] = {\n\t\t\"cpu\", CGU_CLK_DIV | CGU_CLK_GATE,\n\t\t.flags = CLK_IS_CRITICAL,\n\t\t.parents = { X1830_CLK_CPUMUX, -1, -1, -1 },\n\t\t.div = { CGU_REG_CPCCR, 0, 1, 4, 22, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR1, 15 },\n\t},\n\n\t[X1830_CLK_L2CACHE] = {\n\t\t\"l2cache\", CGU_CLK_DIV,\n\t\t \n\t\t.flags = CLK_IS_CRITICAL,\n\t\t.parents = { X1830_CLK_CPUMUX, -1, -1, -1 },\n\t\t.div = { CGU_REG_CPCCR, 4, 1, 4, 22, -1, -1 },\n\t},\n\n\t[X1830_CLK_AHB0] = {\n\t\t\"ahb0\", CGU_CLK_MUX | CGU_CLK_DIV,\n\t\t.parents = { -1, X1830_CLK_SCLKA, X1830_CLK_MPLL, -1 },\n\t\t.mux = { CGU_REG_CPCCR, 26, 2 },\n\t\t.div = { CGU_REG_CPCCR, 8, 1, 4, 21, -1, -1 },\n\t},\n\n\t[X1830_CLK_AHB2PMUX] = {\n\t\t\"ahb2_apb_mux\", CGU_CLK_MUX,\n\t\t.parents = { -1, X1830_CLK_SCLKA, X1830_CLK_MPLL, -1 },\n\t\t.mux = { CGU_REG_CPCCR, 24, 2 },\n\t},\n\n\t[X1830_CLK_AHB2] = {\n\t\t\"ahb2\", CGU_CLK_DIV,\n\t\t.parents = { X1830_CLK_AHB2PMUX, -1, -1, -1 },\n\t\t.div = { CGU_REG_CPCCR, 12, 1, 4, 20, -1, -1 },\n\t},\n\n\t[X1830_CLK_PCLK] = {\n\t\t\"pclk\", CGU_CLK_DIV | CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_AHB2PMUX, -1, -1, -1 },\n\t\t.div = { CGU_REG_CPCCR, 16, 1, 4, 20, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR1, 14 },\n\t},\n\n\t[X1830_CLK_DDR] = {\n\t\t\"ddr\", CGU_CLK_MUX | CGU_CLK_DIV | CGU_CLK_GATE,\n\t\t \n\t\t.flags = CLK_IS_CRITICAL,\n\t\t.parents = { -1, X1830_CLK_SCLKA, X1830_CLK_MPLL, -1 },\n\t\t.mux = { CGU_REG_DDRCDR, 30, 2 },\n\t\t.div = { CGU_REG_DDRCDR, 0, 1, 4, 29, 28, 27 },\n\t\t.gate = { CGU_REG_CLKGR0, 31 },\n\t},\n\n\t[X1830_CLK_MAC] = {\n\t\t\"mac\", CGU_CLK_MUX | CGU_CLK_DIV | CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_SCLKA, X1830_CLK_MPLL,\n\t\t\t\t\t X1830_CLK_VPLL, X1830_CLK_EPLL },\n\t\t.mux = { CGU_REG_MACCDR, 30, 2 },\n\t\t.div = { CGU_REG_MACCDR, 0, 1, 8, 29, 28, 27 },\n\t\t.gate = { CGU_REG_CLKGR1, 4 },\n\t},\n\n\t[X1830_CLK_LCD] = {\n\t\t\"lcd\", CGU_CLK_MUX | CGU_CLK_DIV | CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_SCLKA, X1830_CLK_MPLL,\n\t\t\t\t\t X1830_CLK_VPLL, X1830_CLK_EPLL },\n\t\t.mux = { CGU_REG_LPCDR, 30, 2 },\n\t\t.div = { CGU_REG_LPCDR, 0, 1, 8, 28, 27, 26 },\n\t\t.gate = { CGU_REG_CLKGR1, 9 },\n\t},\n\n\t[X1830_CLK_MSCMUX] = {\n\t\t\"msc_mux\", CGU_CLK_MUX,\n\t\t.parents = { X1830_CLK_SCLKA, X1830_CLK_MPLL,\n\t\t\t\t\t X1830_CLK_VPLL, X1830_CLK_EPLL },\n\t\t.mux = { CGU_REG_MSC0CDR, 30, 2 },\n\t},\n\n\t[X1830_CLK_MSC0] = {\n\t\t\"msc0\", CGU_CLK_DIV | CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_MSCMUX, -1, -1, -1 },\n\t\t.div = { CGU_REG_MSC0CDR, 0, 2, 8, 29, 28, 27 },\n\t\t.gate = { CGU_REG_CLKGR0, 4 },\n\t},\n\n\t[X1830_CLK_MSC1] = {\n\t\t\"msc1\", CGU_CLK_DIV | CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_MSCMUX, -1, -1, -1 },\n\t\t.div = { CGU_REG_MSC1CDR, 0, 2, 8, 29, 28, 27 },\n\t\t.gate = { CGU_REG_CLKGR0, 5 },\n\t},\n\n\t[X1830_CLK_SSIPLL] = {\n\t\t\"ssi_pll\", CGU_CLK_MUX | CGU_CLK_DIV,\n\t\t.parents = { X1830_CLK_SCLKA, X1830_CLK_MPLL,\n\t\t\t\t\t X1830_CLK_VPLL, X1830_CLK_EPLL },\n\t\t.mux = { CGU_REG_SSICDR, 30, 2 },\n\t\t.div = { CGU_REG_SSICDR, 0, 1, 8, 28, 27, 26 },\n\t},\n\n\t[X1830_CLK_SSIPLL_DIV2] = {\n\t\t\"ssi_pll_div2\", CGU_CLK_FIXDIV,\n\t\t.parents = { X1830_CLK_SSIPLL },\n\t\t.fixdiv = { 2 },\n\t},\n\n\t[X1830_CLK_SSIMUX] = {\n\t\t\"ssi_mux\", CGU_CLK_MUX,\n\t\t.parents = { X1830_CLK_EXCLK, X1830_CLK_SSIPLL_DIV2, -1, -1 },\n\t\t.mux = { CGU_REG_SSICDR, 29, 1 },\n\t},\n\n\t[X1830_CLK_EXCLK_DIV512] = {\n\t\t\"exclk_div512\", CGU_CLK_FIXDIV,\n\t\t.parents = { X1830_CLK_EXCLK },\n\t\t.fixdiv = { 512 },\n\t},\n\n\t[X1830_CLK_RTC] = {\n\t\t\"rtc_ercs\", CGU_CLK_MUX | CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_EXCLK_DIV512, X1830_CLK_RTCLK },\n\t\t.mux = { CGU_REG_OPCR, 2, 1},\n\t\t.gate = { CGU_REG_CLKGR0, 29 },\n\t},\n\n\t \n\n\t[X1830_CLK_EMC] = {\n\t\t\"emc\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_AHB2, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 0 },\n\t},\n\n\t[X1830_CLK_EFUSE] = {\n\t\t\"efuse\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_AHB2, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 1 },\n\t},\n\n\t[X1830_CLK_OTG] = {\n\t\t\"otg\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 3 },\n\t},\n\n\t[X1830_CLK_SSI0] = {\n\t\t\"ssi0\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_SSIMUX, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 6 },\n\t},\n\n\t[X1830_CLK_SMB0] = {\n\t\t\"smb0\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_PCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 7 },\n\t},\n\n\t[X1830_CLK_SMB1] = {\n\t\t\"smb1\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_PCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 8 },\n\t},\n\n\t[X1830_CLK_SMB2] = {\n\t\t\"smb2\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_PCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 9 },\n\t},\n\n\t[X1830_CLK_UART0] = {\n\t\t\"uart0\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 14 },\n\t},\n\n\t[X1830_CLK_UART1] = {\n\t\t\"uart1\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 15 },\n\t},\n\n\t[X1830_CLK_SSI1] = {\n\t\t\"ssi1\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_SSIMUX, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 19 },\n\t},\n\n\t[X1830_CLK_SFC] = {\n\t\t\"sfc\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_SSIPLL, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 20 },\n\t},\n\n\t[X1830_CLK_PDMA] = {\n\t\t\"pdma\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 21 },\n\t},\n\n\t[X1830_CLK_TCU] = {\n\t\t\"tcu\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR0, 30 },\n\t},\n\n\t[X1830_CLK_DTRNG] = {\n\t\t\"dtrng\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_PCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR1, 1 },\n\t},\n\n\t[X1830_CLK_OST] = {\n\t\t\"ost\", CGU_CLK_GATE,\n\t\t.parents = { X1830_CLK_EXCLK, -1, -1, -1 },\n\t\t.gate = { CGU_REG_CLKGR1, 11 },\n\t},\n};\n\nstatic void __init x1830_cgu_init(struct device_node *np)\n{\n\tint retval;\n\n\tcgu = ingenic_cgu_new(x1830_cgu_clocks,\n\t\t\t      ARRAY_SIZE(x1830_cgu_clocks), np);\n\tif (!cgu) {\n\t\tpr_err(\"%s: failed to initialise CGU\\n\", __func__);\n\t\treturn;\n\t}\n\n\tretval = ingenic_cgu_register_clocks(cgu);\n\tif (retval) {\n\t\tpr_err(\"%s: failed to register CGU Clocks\\n\", __func__);\n\t\treturn;\n\t}\n\n\tingenic_cgu_register_syscore_ops(cgu);\n}\n \nCLK_OF_DECLARE_DRIVER(x1830_cgu, \"ingenic,x1830-cgu\", x1830_cgu_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}