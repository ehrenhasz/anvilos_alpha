{
  "module_name": "armada-37xx-xtal.c",
  "hash_id": "68353a9529f11ce81f6f0a506e9ff86ef300ebd19395d91a95986814c91d4345",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/mvebu/armada-37xx-xtal.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/mfd/syscon.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define NB_GPIO1_LATCH\t0x8\n#define XTAL_MODE\t    BIT(9)\n\nstatic int armada_3700_xtal_clock_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tconst char *xtal_name = \"xtal\";\n\tstruct device_node *parent;\n\tstruct regmap *regmap;\n\tstruct clk_hw *xtal_hw;\n\tunsigned int rate;\n\tu32 reg;\n\tint ret;\n\n\txtal_hw = devm_kzalloc(&pdev->dev, sizeof(*xtal_hw), GFP_KERNEL);\n\tif (!xtal_hw)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, xtal_hw);\n\n\tparent = np->parent;\n\tif (!parent) {\n\t\tdev_err(&pdev->dev, \"no parent\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tregmap = syscon_node_to_regmap(parent);\n\tif (IS_ERR(regmap)) {\n\t\tdev_err(&pdev->dev, \"cannot get regmap\\n\");\n\t\treturn PTR_ERR(regmap);\n\t}\n\n\tret = regmap_read(regmap, NB_GPIO1_LATCH, &reg);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"cannot read from regmap\\n\");\n\t\treturn ret;\n\t}\n\n\tif (reg & XTAL_MODE)\n\t\trate = 40000000;\n\telse\n\t\trate = 25000000;\n\n\tof_property_read_string_index(np, \"clock-output-names\", 0, &xtal_name);\n\txtal_hw = clk_hw_register_fixed_rate(NULL, xtal_name, NULL, 0, rate);\n\tif (IS_ERR(xtal_hw))\n\t\treturn PTR_ERR(xtal_hw);\n\tret = of_clk_add_hw_provider(np, of_clk_hw_simple_get, xtal_hw);\n\n\treturn ret;\n}\n\nstatic void armada_3700_xtal_clock_remove(struct platform_device *pdev)\n{\n\tof_clk_del_provider(pdev->dev.of_node);\n}\n\nstatic const struct of_device_id armada_3700_xtal_clock_of_match[] = {\n\t{ .compatible = \"marvell,armada-3700-xtal-clock\", },\n\t{ }\n};\n\nstatic struct platform_driver armada_3700_xtal_clock_driver = {\n\t.probe = armada_3700_xtal_clock_probe,\n\t.remove_new = armada_3700_xtal_clock_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"marvell-armada-3700-xtal-clock\",\n\t\t.of_match_table = armada_3700_xtal_clock_of_match,\n\t},\n};\n\nbuiltin_platform_driver(armada_3700_xtal_clock_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}