{
  "module_name": "owl-pll.c",
  "hash_id": "66e25a44fd852586115e0a0c5993c7f9287a4600e0f87878c77e1035f0b5b442",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/actions/owl-pll.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n#include <linux/clk-provider.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n#include <linux/delay.h>\n\n#include \"owl-pll.h\"\n\nstatic u32 owl_pll_calculate_mul(struct owl_pll_hw *pll_hw, unsigned long rate)\n{\n\tu32 mul;\n\n\tmul = DIV_ROUND_CLOSEST(rate, pll_hw->bfreq);\n\tif (mul < pll_hw->min_mul)\n\t\tmul = pll_hw->min_mul;\n\telse if (mul > pll_hw->max_mul)\n\t\tmul = pll_hw->max_mul;\n\n\treturn mul & mul_mask(pll_hw);\n}\n\nstatic unsigned long _get_table_rate(const struct clk_pll_table *table,\n\t\tunsigned int val)\n{\n\tconst struct clk_pll_table *clkt;\n\n\tfor (clkt = table; clkt->rate; clkt++)\n\t\tif (clkt->val == val)\n\t\t\treturn clkt->rate;\n\n\treturn 0;\n}\n\nstatic const struct clk_pll_table *_get_pll_table(\n\t\tconst struct clk_pll_table *table, unsigned long rate)\n{\n\tconst struct clk_pll_table *clkt;\n\n\tfor (clkt = table; clkt->rate; clkt++) {\n\t\tif (clkt->rate == rate) {\n\t\t\ttable = clkt;\n\t\t\tbreak;\n\t\t} else if (clkt->rate < rate)\n\t\t\ttable = clkt;\n\t}\n\n\treturn table;\n}\n\nstatic long owl_pll_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\tunsigned long *parent_rate)\n{\n\tstruct owl_pll *pll = hw_to_owl_pll(hw);\n\tstruct owl_pll_hw *pll_hw = &pll->pll_hw;\n\tconst struct clk_pll_table *clkt;\n\tu32 mul;\n\n\tif (pll_hw->table) {\n\t\tclkt = _get_pll_table(pll_hw->table, rate);\n\t\treturn clkt->rate;\n\t}\n\n\t \n\tif (pll_hw->width == 0)\n\t\treturn pll_hw->bfreq;\n\n\tmul = owl_pll_calculate_mul(pll_hw, rate);\n\n\treturn pll_hw->bfreq * mul;\n}\n\nstatic unsigned long owl_pll_recalc_rate(struct clk_hw *hw,\n\t\tunsigned long parent_rate)\n{\n\tstruct owl_pll *pll = hw_to_owl_pll(hw);\n\tstruct owl_pll_hw *pll_hw = &pll->pll_hw;\n\tconst struct owl_clk_common *common = &pll->common;\n\tu32 val;\n\n\tif (pll_hw->table) {\n\t\tregmap_read(common->regmap, pll_hw->reg, &val);\n\n\t\tval = val >> pll_hw->shift;\n\t\tval &= mul_mask(pll_hw);\n\n\t\treturn _get_table_rate(pll_hw->table, val);\n\t}\n\n\t \n\tif (pll_hw->width == 0)\n\t\treturn pll_hw->bfreq;\n\n\tregmap_read(common->regmap, pll_hw->reg, &val);\n\n\tval = val >> pll_hw->shift;\n\tval &= mul_mask(pll_hw);\n\n\treturn pll_hw->bfreq * val;\n}\n\nstatic int owl_pll_is_enabled(struct clk_hw *hw)\n{\n\tstruct owl_pll *pll = hw_to_owl_pll(hw);\n\tstruct owl_pll_hw *pll_hw = &pll->pll_hw;\n\tconst struct owl_clk_common *common = &pll->common;\n\tu32 reg;\n\n\tregmap_read(common->regmap, pll_hw->reg, &reg);\n\n\treturn !!(reg & BIT(pll_hw->bit_idx));\n}\n\nstatic void owl_pll_set(const struct owl_clk_common *common,\n\t\t       const struct owl_pll_hw *pll_hw, bool enable)\n{\n\tu32 reg;\n\n\tregmap_read(common->regmap, pll_hw->reg, &reg);\n\n\tif (enable)\n\t\treg |= BIT(pll_hw->bit_idx);\n\telse\n\t\treg &= ~BIT(pll_hw->bit_idx);\n\n\tregmap_write(common->regmap, pll_hw->reg, reg);\n}\n\nstatic int owl_pll_enable(struct clk_hw *hw)\n{\n\tstruct owl_pll *pll = hw_to_owl_pll(hw);\n\tconst struct owl_clk_common *common = &pll->common;\n\n\towl_pll_set(common, &pll->pll_hw, true);\n\n\treturn 0;\n}\n\nstatic void owl_pll_disable(struct clk_hw *hw)\n{\n\tstruct owl_pll *pll = hw_to_owl_pll(hw);\n\tconst struct owl_clk_common *common = &pll->common;\n\n\towl_pll_set(common, &pll->pll_hw, false);\n}\n\nstatic int owl_pll_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\tunsigned long parent_rate)\n{\n\tstruct owl_pll *pll = hw_to_owl_pll(hw);\n\tstruct owl_pll_hw *pll_hw = &pll->pll_hw;\n\tconst struct owl_clk_common *common = &pll->common;\n\tconst struct clk_pll_table *clkt;\n\tu32 val, reg;\n\n\t \n\tif (pll_hw->width == 0)\n\t\treturn 0;\n\n\tif (pll_hw->table) {\n\t\tclkt = _get_pll_table(pll_hw->table, rate);\n\t\tval = clkt->val;\n\t} else {\n\t\tval = owl_pll_calculate_mul(pll_hw, rate);\n\t}\n\n\tregmap_read(common->regmap, pll_hw->reg, &reg);\n\n\treg &= ~mul_mask(pll_hw);\n\treg |= val << pll_hw->shift;\n\n\tregmap_write(common->regmap, pll_hw->reg, reg);\n\n\tudelay(pll_hw->delay);\n\n\treturn 0;\n}\n\nconst struct clk_ops owl_pll_ops = {\n\t.enable = owl_pll_enable,\n\t.disable = owl_pll_disable,\n\t.is_enabled = owl_pll_is_enabled,\n\t.round_rate = owl_pll_round_rate,\n\t.recalc_rate = owl_pll_recalc_rate,\n\t.set_rate = owl_pll_set_rate,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}