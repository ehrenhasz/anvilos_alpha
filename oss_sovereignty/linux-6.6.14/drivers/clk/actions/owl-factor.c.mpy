{
  "module_name": "owl-factor.c",
  "hash_id": "3777334fbc6773170ac10c3b328f3337cbc524dab996bd9afde520f1332600f5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/actions/owl-factor.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n#include <linux/clk-provider.h>\n#include <linux/regmap.h>\n\n#include \"owl-factor.h\"\n\nstatic unsigned int _get_table_maxval(const struct clk_factor_table *table)\n{\n\tunsigned int maxval = 0;\n\tconst struct clk_factor_table *clkt;\n\n\tfor (clkt = table; clkt->div; clkt++)\n\t\tif (clkt->val > maxval)\n\t\t\tmaxval = clkt->val;\n\treturn maxval;\n}\n\nstatic int _get_table_div_mul(const struct clk_factor_table *table,\n\t\t\tunsigned int val, unsigned int *mul, unsigned int *div)\n{\n\tconst struct clk_factor_table *clkt;\n\n\tfor (clkt = table; clkt->div; clkt++) {\n\t\tif (clkt->val == val) {\n\t\t\t*mul = clkt->mul;\n\t\t\t*div = clkt->div;\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic unsigned int _get_table_val(const struct clk_factor_table *table,\n\t\t\tunsigned long rate, unsigned long parent_rate)\n{\n\tconst struct clk_factor_table *clkt;\n\tint val = -1;\n\tu64 calc_rate;\n\n\tfor (clkt = table; clkt->div; clkt++) {\n\t\tcalc_rate = parent_rate * clkt->mul;\n\t\tdo_div(calc_rate, clkt->div);\n\n\t\tif ((unsigned long)calc_rate <= rate) {\n\t\t\tval = clkt->val;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (val == -1)\n\t\tval = _get_table_maxval(table);\n\n\treturn val;\n}\n\nstatic int owl_clk_val_best(const struct owl_factor_hw *factor_hw,\n\t\t\tstruct clk_hw *hw, unsigned long rate,\n\t\t\tunsigned long *best_parent_rate)\n{\n\tconst struct clk_factor_table *clkt = factor_hw->table;\n\tunsigned long parent_rate, try_parent_rate, best = 0, cur_rate;\n\tunsigned long parent_rate_saved = *best_parent_rate;\n\tint bestval = 0;\n\n\tif (!rate)\n\t\trate = 1;\n\n\tif (!(clk_hw_get_flags(hw) & CLK_SET_RATE_PARENT)) {\n\t\tparent_rate = *best_parent_rate;\n\t\tbestval = _get_table_val(clkt, rate, parent_rate);\n\t\treturn bestval;\n\t}\n\n\tfor (clkt = factor_hw->table; clkt->div; clkt++) {\n\t\ttry_parent_rate = rate * clkt->div / clkt->mul;\n\n\t\tif (try_parent_rate == parent_rate_saved) {\n\t\t\tpr_debug(\"%s: [%d %d %d] found try_parent_rate %ld\\n\",\n\t\t\t\t__func__, clkt->val, clkt->mul, clkt->div,\n\t\t\t\ttry_parent_rate);\n\t\t\t \n\t\t\t*best_parent_rate = parent_rate_saved;\n\t\t\treturn clkt->val;\n\t\t}\n\n\t\tparent_rate = clk_hw_round_rate(clk_hw_get_parent(hw),\n\t\t\t\ttry_parent_rate);\n\t\tcur_rate = DIV_ROUND_UP(parent_rate, clkt->div) * clkt->mul;\n\t\tif (cur_rate <= rate && cur_rate > best) {\n\t\t\tbestval = clkt->val;\n\t\t\tbest = cur_rate;\n\t\t\t*best_parent_rate = parent_rate;\n\t\t}\n\t}\n\n\tif (!bestval) {\n\t\tbestval = _get_table_maxval(clkt);\n\t\t*best_parent_rate = clk_hw_round_rate(\n\t\t\t\tclk_hw_get_parent(hw), 1);\n\t}\n\n\treturn bestval;\n}\n\nlong owl_factor_helper_round_rate(struct owl_clk_common *common,\n\t\t\t\tconst struct owl_factor_hw *factor_hw,\n\t\t\t\tunsigned long rate,\n\t\t\t\tunsigned long *parent_rate)\n{\n\tconst struct clk_factor_table *clkt = factor_hw->table;\n\tunsigned int val, mul = 0, div = 1;\n\n\tval = owl_clk_val_best(factor_hw, &common->hw, rate, parent_rate);\n\t_get_table_div_mul(clkt, val, &mul, &div);\n\n\treturn *parent_rate * mul / div;\n}\n\nstatic long owl_factor_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\tunsigned long *parent_rate)\n{\n\tstruct owl_factor *factor = hw_to_owl_factor(hw);\n\tstruct owl_factor_hw *factor_hw = &factor->factor_hw;\n\n\treturn owl_factor_helper_round_rate(&factor->common, factor_hw,\n\t\t\t\t\trate, parent_rate);\n}\n\nunsigned long owl_factor_helper_recalc_rate(struct owl_clk_common *common,\n\t\t\t\t\t const struct owl_factor_hw *factor_hw,\n\t\t\t\t\t unsigned long parent_rate)\n{\n\tconst struct clk_factor_table *clkt = factor_hw->table;\n\tunsigned long long int rate;\n\tu32 reg, val, mul, div;\n\n\tdiv = 0;\n\tmul = 0;\n\n\tregmap_read(common->regmap, factor_hw->reg, &reg);\n\n\tval = reg >> factor_hw->shift;\n\tval &= div_mask(factor_hw);\n\n\t_get_table_div_mul(clkt, val, &mul, &div);\n\tif (!div) {\n\t\tWARN(!(factor_hw->fct_flags & CLK_DIVIDER_ALLOW_ZERO),\n\t\t\t\"%s: Zero divisor and CLK_DIVIDER_ALLOW_ZERO not set\\n\",\n\t\t\t__clk_get_name(common->hw.clk));\n\t\treturn parent_rate;\n\t}\n\n\trate = (unsigned long long int)parent_rate * mul;\n\tdo_div(rate, div);\n\n\treturn rate;\n}\n\nstatic unsigned long owl_factor_recalc_rate(struct clk_hw *hw,\n\t\t\tunsigned long parent_rate)\n{\n\tstruct owl_factor *factor = hw_to_owl_factor(hw);\n\tstruct owl_factor_hw *factor_hw = &factor->factor_hw;\n\tstruct owl_clk_common *common = &factor->common;\n\n\treturn owl_factor_helper_recalc_rate(common, factor_hw, parent_rate);\n}\n\nint owl_factor_helper_set_rate(const struct owl_clk_common *common,\n\t\t\t\tconst struct owl_factor_hw *factor_hw,\n\t\t\t\tunsigned long rate,\n\t\t\t\tunsigned long parent_rate)\n{\n\tu32 val, reg;\n\n\tval = _get_table_val(factor_hw->table, rate, parent_rate);\n\n\tif (val > div_mask(factor_hw))\n\t\tval = div_mask(factor_hw);\n\n\tregmap_read(common->regmap, factor_hw->reg, &reg);\n\n\treg &= ~(div_mask(factor_hw) << factor_hw->shift);\n\treg |= val << factor_hw->shift;\n\n\tregmap_write(common->regmap, factor_hw->reg, reg);\n\n\treturn 0;\n}\n\nstatic int owl_factor_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t       unsigned long parent_rate)\n{\n\tstruct owl_factor *factor = hw_to_owl_factor(hw);\n\tstruct owl_factor_hw *factor_hw = &factor->factor_hw;\n\tstruct owl_clk_common *common = &factor->common;\n\n\treturn owl_factor_helper_set_rate(common, factor_hw,\n\t\t\t\t\trate, parent_rate);\n}\n\nconst struct clk_ops owl_factor_ops = {\n\t.round_rate\t= owl_factor_round_rate,\n\t.recalc_rate\t= owl_factor_recalc_rate,\n\t.set_rate\t= owl_factor_set_rate,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}