{
  "module_name": "clk-sun8i-mbus.c",
  "hash_id": "b64ef5d6ffe8223efc8fd0a483e9e18c5840c969f672ddab4645a784104aa1dc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/sunxi/clk-sun8i-mbus.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <linux/slab.h>\n#include <linux/spinlock.h>\n#include <linux/of_address.h>\n\n#define SUN8I_MBUS_ENABLE\t31\n#define SUN8I_MBUS_MUX_SHIFT\t24\n#define SUN8I_MBUS_MUX_MASK\t0x3\n#define SUN8I_MBUS_DIV_SHIFT\t0\n#define SUN8I_MBUS_DIV_WIDTH\t3\n#define SUN8I_MBUS_MAX_PARENTS\t4\n\nstatic DEFINE_SPINLOCK(sun8i_a23_mbus_lock);\n\nstatic void __init sun8i_a23_mbus_setup(struct device_node *node)\n{\n\tint num_parents = of_clk_get_parent_count(node);\n\tconst char **parents;\n\tconst char *clk_name = node->name;\n\tstruct resource res;\n\tstruct clk_divider *div;\n\tstruct clk_gate *gate;\n\tstruct clk_mux *mux;\n\tstruct clk *clk;\n\tvoid __iomem *reg;\n\tint err;\n\n\tparents = kcalloc(num_parents, sizeof(*parents), GFP_KERNEL);\n\tif (!parents)\n\t\treturn;\n\n\treg = of_io_request_and_map(node, 0, of_node_full_name(node));\n\tif (IS_ERR(reg)) {\n\t\tpr_err(\"Could not get registers for sun8i-mbus-clk\\n\");\n\t\tgoto err_free_parents;\n\t}\n\n\tdiv = kzalloc(sizeof(*div), GFP_KERNEL);\n\tif (!div)\n\t\tgoto err_unmap;\n\n\tmux = kzalloc(sizeof(*mux), GFP_KERNEL);\n\tif (!mux)\n\t\tgoto err_free_div;\n\n\tgate = kzalloc(sizeof(*gate), GFP_KERNEL);\n\tif (!gate)\n\t\tgoto err_free_mux;\n\n\tof_property_read_string(node, \"clock-output-names\", &clk_name);\n\tof_clk_parent_fill(node, parents, num_parents);\n\n\tgate->reg = reg;\n\tgate->bit_idx = SUN8I_MBUS_ENABLE;\n\tgate->lock = &sun8i_a23_mbus_lock;\n\n\tdiv->reg = reg;\n\tdiv->shift = SUN8I_MBUS_DIV_SHIFT;\n\tdiv->width = SUN8I_MBUS_DIV_WIDTH;\n\tdiv->lock = &sun8i_a23_mbus_lock;\n\n\tmux->reg = reg;\n\tmux->shift = SUN8I_MBUS_MUX_SHIFT;\n\tmux->mask = SUN8I_MBUS_MUX_MASK;\n\tmux->lock = &sun8i_a23_mbus_lock;\n\n\t \n\tclk = clk_register_composite(NULL, clk_name, parents, num_parents,\n\t\t\t\t     &mux->hw, &clk_mux_ops,\n\t\t\t\t     &div->hw, &clk_divider_ops,\n\t\t\t\t     &gate->hw, &clk_gate_ops,\n\t\t\t\t     CLK_IS_CRITICAL);\n\tif (IS_ERR(clk))\n\t\tgoto err_free_gate;\n\n\terr = of_clk_add_provider(node, of_clk_src_simple_get, clk);\n\tif (err)\n\t\tgoto err_unregister_clk;\n\n\tkfree(parents);  \n\n\treturn;\n\nerr_unregister_clk:\n\t \n\tclk_unregister(clk);\nerr_free_gate:\n\tkfree(gate);\nerr_free_mux:\n\tkfree(mux);\nerr_free_div:\n\tkfree(div);\nerr_unmap:\n\tiounmap(reg);\n\tof_address_to_resource(node, 0, &res);\n\trelease_mem_region(res.start, resource_size(&res));\nerr_free_parents:\n\tkfree(parents);\n}\nCLK_OF_DECLARE(sun8i_a23_mbus, \"allwinner,sun8i-a23-mbus-clk\", sun8i_a23_mbus_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}