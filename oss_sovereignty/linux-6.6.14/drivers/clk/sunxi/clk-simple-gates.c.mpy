{
  "module_name": "clk-simple-gates.c",
  "hash_id": "f28ee2907212b1f96502e474974618ad39da2e3eca9959db956cc0a7e0e6525f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/sunxi/clk-simple-gates.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/slab.h>\n#include <linux/spinlock.h>\n\nstatic DEFINE_SPINLOCK(gates_lock);\n\nstatic void __init sunxi_simple_gates_setup(struct device_node *node,\n\t\t\t\t\t    const int protected[],\n\t\t\t\t\t    int nprotected)\n{\n\tstruct clk_onecell_data *clk_data;\n\tconst char *clk_parent, *clk_name;\n\tstruct property *prop;\n\tstruct resource res;\n\tvoid __iomem *clk_reg;\n\tvoid __iomem *reg;\n\tconst __be32 *p;\n\tint number, i = 0, j;\n\tu8 clk_bit;\n\tu32 index;\n\n\treg = of_io_request_and_map(node, 0, of_node_full_name(node));\n\tif (IS_ERR(reg))\n\t\treturn;\n\n\tclk_parent = of_clk_get_parent_name(node, 0);\n\n\tclk_data = kmalloc(sizeof(struct clk_onecell_data), GFP_KERNEL);\n\tif (!clk_data)\n\t\tgoto err_unmap;\n\n\tnumber = of_property_count_u32_elems(node, \"clock-indices\");\n\tof_property_read_u32_index(node, \"clock-indices\", number - 1, &number);\n\n\tclk_data->clks = kcalloc(number + 1, sizeof(struct clk *), GFP_KERNEL);\n\tif (!clk_data->clks)\n\t\tgoto err_free_data;\n\n\tof_property_for_each_u32(node, \"clock-indices\", prop, p, index) {\n\t\tof_property_read_string_index(node, \"clock-output-names\",\n\t\t\t\t\t      i, &clk_name);\n\n\t\tclk_reg = reg + 4 * (index / 32);\n\t\tclk_bit = index % 32;\n\n\t\tclk_data->clks[index] = clk_register_gate(NULL, clk_name,\n\t\t\t\t\t\t\t  clk_parent, 0,\n\t\t\t\t\t\t\t  clk_reg,\n\t\t\t\t\t\t\t  clk_bit,\n\t\t\t\t\t\t\t  0, &gates_lock);\n\t\ti++;\n\n\t\tif (IS_ERR(clk_data->clks[index])) {\n\t\t\tWARN_ON(true);\n\t\t\tcontinue;\n\t\t}\n\n\t\tfor (j = 0; j < nprotected; j++)\n\t\t\tif (protected[j] == index)\n\t\t\t\tclk_prepare_enable(clk_data->clks[index]);\n\n\t}\n\n\tclk_data->clk_num = number + 1;\n\tof_clk_add_provider(node, of_clk_src_onecell_get, clk_data);\n\n\treturn;\n\nerr_free_data:\n\tkfree(clk_data);\nerr_unmap:\n\tiounmap(reg);\n\tof_address_to_resource(node, 0, &res);\n\trelease_mem_region(res.start, resource_size(&res));\n}\n\nstatic void __init sunxi_simple_gates_init(struct device_node *node)\n{\n\tsunxi_simple_gates_setup(node, NULL, 0);\n}\n\nCLK_OF_DECLARE(sun4i_a10_gates, \"allwinner,sun4i-a10-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun4i_a10_apb0, \"allwinner,sun4i-a10-apb0-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun4i_a10_apb1, \"allwinner,sun4i-a10-apb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun4i_a10_axi, \"allwinner,sun4i-a10-axi-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun5i_a10s_apb0, \"allwinner,sun5i-a10s-apb0-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun5i_a10s_apb1, \"allwinner,sun5i-a10s-apb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun5i_a13_apb0, \"allwinner,sun5i-a13-apb0-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun5i_a13_apb1, \"allwinner,sun5i-a13-apb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun6i_a31_ahb1, \"allwinner,sun6i-a31-ahb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun6i_a31_apb1, \"allwinner,sun6i-a31-apb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun6i_a31_apb2, \"allwinner,sun6i-a31-apb2-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun7i_a20_apb0, \"allwinner,sun7i-a20-apb0-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun7i_a20_apb1, \"allwinner,sun7i-a20-apb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun8i_a23_ahb1, \"allwinner,sun8i-a23-ahb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun8i_a23_apb1, \"allwinner,sun8i-a23-apb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun8i_a23_apb2, \"allwinner,sun8i-a23-apb2-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun8i_a33_ahb1, \"allwinner,sun8i-a33-ahb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun8i_a83t_apb0, \"allwinner,sun8i-a83t-apb0-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun9i_a80_ahb0, \"allwinner,sun9i-a80-ahb0-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun9i_a80_ahb1, \"allwinner,sun9i-a80-ahb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun9i_a80_ahb2, \"allwinner,sun9i-a80-ahb2-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun9i_a80_apb0, \"allwinner,sun9i-a80-apb0-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun9i_a80_apb1, \"allwinner,sun9i-a80-apb1-gates-clk\",\n\t       sunxi_simple_gates_init);\nCLK_OF_DECLARE(sun9i_a80_apbs, \"allwinner,sun9i-a80-apbs-gates-clk\",\n\t       sunxi_simple_gates_init);\n\nstatic const int sun4i_a10_ahb_critical_clocks[] __initconst = {\n\t14,\t \n};\n\nstatic void __init sun4i_a10_ahb_init(struct device_node *node)\n{\n\tsunxi_simple_gates_setup(node, sun4i_a10_ahb_critical_clocks,\n\t\t\t\t ARRAY_SIZE(sun4i_a10_ahb_critical_clocks));\n}\nCLK_OF_DECLARE(sun4i_a10_ahb, \"allwinner,sun4i-a10-ahb-gates-clk\",\n\t       sun4i_a10_ahb_init);\nCLK_OF_DECLARE(sun5i_a10s_ahb, \"allwinner,sun5i-a10s-ahb-gates-clk\",\n\t       sun4i_a10_ahb_init);\nCLK_OF_DECLARE(sun5i_a13_ahb, \"allwinner,sun5i-a13-ahb-gates-clk\",\n\t       sun4i_a10_ahb_init);\nCLK_OF_DECLARE(sun7i_a20_ahb, \"allwinner,sun7i-a20-ahb-gates-clk\",\n\t       sun4i_a10_ahb_init);\n\nstatic const int sun4i_a10_dram_critical_clocks[] __initconst = {\n\t15,\t \n};\n\nstatic void __init sun4i_a10_dram_init(struct device_node *node)\n{\n\tsunxi_simple_gates_setup(node, sun4i_a10_dram_critical_clocks,\n\t\t\t\t ARRAY_SIZE(sun4i_a10_dram_critical_clocks));\n}\nCLK_OF_DECLARE(sun4i_a10_dram, \"allwinner,sun4i-a10-dram-gates-clk\",\n\t       sun4i_a10_dram_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}