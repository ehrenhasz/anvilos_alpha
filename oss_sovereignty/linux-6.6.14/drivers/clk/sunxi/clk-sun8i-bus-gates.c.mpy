{
  "module_name": "clk-sun8i-bus-gates.c",
  "hash_id": "36a580702c59d01e05c2549c59efe20f912d339e95438db83936873d9880c323",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/sunxi/clk-sun8i-bus-gates.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/slab.h>\n#include <linux/spinlock.h>\n\nstatic DEFINE_SPINLOCK(gates_lock);\n\nstatic void __init sun8i_h3_bus_gates_init(struct device_node *node)\n{\n\tstatic const char * const names[] = { \"ahb1\", \"ahb2\", \"apb1\", \"apb2\" };\n\tenum { AHB1, AHB2, APB1, APB2, PARENT_MAX } clk_parent;\n\tconst char *parents[PARENT_MAX];\n\tstruct clk_onecell_data *clk_data;\n\tconst char *clk_name;\n\tstruct property *prop;\n\tstruct resource res;\n\tvoid __iomem *clk_reg;\n\tvoid __iomem *reg;\n\tconst __be32 *p;\n\tint number, i;\n\tu8 clk_bit;\n\tint index;\n\n\treg = of_io_request_and_map(node, 0, of_node_full_name(node));\n\tif (IS_ERR(reg))\n\t\treturn;\n\n\tfor (i = 0; i < ARRAY_SIZE(names); i++) {\n\t\tint idx = of_property_match_string(node, \"clock-names\",\n\t\t\t\t\t\t   names[i]);\n\t\tif (idx < 0)\n\t\t\treturn;\n\n\t\tparents[i] = of_clk_get_parent_name(node, idx);\n\t}\n\n\tclk_data = kmalloc(sizeof(struct clk_onecell_data), GFP_KERNEL);\n\tif (!clk_data)\n\t\tgoto err_unmap;\n\n\tnumber = of_property_count_u32_elems(node, \"clock-indices\");\n\tof_property_read_u32_index(node, \"clock-indices\", number - 1, &number);\n\n\tclk_data->clks = kcalloc(number + 1, sizeof(struct clk *), GFP_KERNEL);\n\tif (!clk_data->clks)\n\t\tgoto err_free_data;\n\n\ti = 0;\n\tof_property_for_each_u32(node, \"clock-indices\", prop, p, index) {\n\t\tof_property_read_string_index(node, \"clock-output-names\",\n\t\t\t\t\t      i, &clk_name);\n\n\t\tif (index == 17 || (index >= 29 && index <= 31))\n\t\t\tclk_parent = AHB2;\n\t\telse if (index <= 63 || index >= 128)\n\t\t\tclk_parent = AHB1;\n\t\telse if (index >= 64 && index <= 95)\n\t\t\tclk_parent = APB1;\n\t\telse if (index >= 96 && index <= 127)\n\t\t\tclk_parent = APB2;\n\t\telse {\n\t\t\tWARN_ON(true);\n\t\t\tcontinue;\n\t\t}\n\n\t\tclk_reg = reg + 4 * (index / 32);\n\t\tclk_bit = index % 32;\n\n\t\tclk_data->clks[index] = clk_register_gate(NULL, clk_name,\n\t\t\t\t\t\t\t  parents[clk_parent],\n\t\t\t\t\t\t\t  0, clk_reg, clk_bit,\n\t\t\t\t\t\t\t  0, &gates_lock);\n\t\ti++;\n\n\t\tif (IS_ERR(clk_data->clks[index])) {\n\t\t\tWARN_ON(true);\n\t\t\tcontinue;\n\t\t}\n\t}\n\n\tclk_data->clk_num = number + 1;\n\tof_clk_add_provider(node, of_clk_src_onecell_get, clk_data);\n\n\treturn;\n\nerr_free_data:\n\tkfree(clk_data);\nerr_unmap:\n\tiounmap(reg);\n\tof_address_to_resource(node, 0, &res);\n\trelease_mem_region(res.start, resource_size(&res));\n}\n\nCLK_OF_DECLARE(sun8i_h3_bus_gates, \"allwinner,sun8i-h3-bus-gates-clk\",\n\t       sun8i_h3_bus_gates_init);\nCLK_OF_DECLARE(sun8i_a83t_bus_gates, \"allwinner,sun8i-a83t-bus-gates-clk\",\n\t       sun8i_h3_bus_gates_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}