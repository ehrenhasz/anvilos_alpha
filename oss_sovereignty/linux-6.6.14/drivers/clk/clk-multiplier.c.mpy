{
  "module_name": "clk-multiplier.c",
  "hash_id": "6df61d96eb330b6b892c75e722880b8aaedab6d24b5f10ed7de364a205e8eaa8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/clk-multiplier.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/clk-provider.h>\n#include <linux/err.h>\n#include <linux/export.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/slab.h>\n\nstatic inline u32 clk_mult_readl(struct clk_multiplier *mult)\n{\n\tif (mult->flags & CLK_MULTIPLIER_BIG_ENDIAN)\n\t\treturn ioread32be(mult->reg);\n\n\treturn readl(mult->reg);\n}\n\nstatic inline void clk_mult_writel(struct clk_multiplier *mult, u32 val)\n{\n\tif (mult->flags & CLK_MULTIPLIER_BIG_ENDIAN)\n\t\tiowrite32be(val, mult->reg);\n\telse\n\t\twritel(val, mult->reg);\n}\n\nstatic unsigned long __get_mult(struct clk_multiplier *mult,\n\t\t\t\tunsigned long rate,\n\t\t\t\tunsigned long parent_rate)\n{\n\tif (mult->flags & CLK_MULTIPLIER_ROUND_CLOSEST)\n\t\treturn DIV_ROUND_CLOSEST(rate, parent_rate);\n\n\treturn rate / parent_rate;\n}\n\nstatic unsigned long clk_multiplier_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t\tunsigned long parent_rate)\n{\n\tstruct clk_multiplier *mult = to_clk_multiplier(hw);\n\tunsigned long val;\n\n\tval = clk_mult_readl(mult) >> mult->shift;\n\tval &= GENMASK(mult->width - 1, 0);\n\n\tif (!val && mult->flags & CLK_MULTIPLIER_ZERO_BYPASS)\n\t\tval = 1;\n\n\treturn parent_rate * val;\n}\n\nstatic bool __is_best_rate(unsigned long rate, unsigned long new,\n\t\t\t   unsigned long best, unsigned long flags)\n{\n\tif (flags & CLK_MULTIPLIER_ROUND_CLOSEST)\n\t\treturn abs(rate - new) < abs(rate - best);\n\n\treturn new >= rate && new < best;\n}\n\nstatic unsigned long __bestmult(struct clk_hw *hw, unsigned long rate,\n\t\t\t\tunsigned long *best_parent_rate,\n\t\t\t\tu8 width, unsigned long flags)\n{\n\tstruct clk_multiplier *mult = to_clk_multiplier(hw);\n\tunsigned long orig_parent_rate = *best_parent_rate;\n\tunsigned long parent_rate, current_rate, best_rate = ~0;\n\tunsigned int i, bestmult = 0;\n\tunsigned int maxmult = (1 << width) - 1;\n\n\tif (!(clk_hw_get_flags(hw) & CLK_SET_RATE_PARENT)) {\n\t\tbestmult = rate / orig_parent_rate;\n\n\t\t \n\t\tif ((bestmult == 0) &&\n\t\t    !(mult->flags & CLK_MULTIPLIER_ZERO_BYPASS))\n\t\t\tbestmult = 1;\n\n\t\t \n\t\tif (bestmult > maxmult)\n\t\t\tbestmult = maxmult;\n\n\t\treturn bestmult;\n\t}\n\n\tfor (i = 1; i < maxmult; i++) {\n\t\tif (rate == orig_parent_rate * i) {\n\t\t\t \n\t\t\t*best_parent_rate = orig_parent_rate;\n\t\t\treturn i;\n\t\t}\n\n\t\tparent_rate = clk_hw_round_rate(clk_hw_get_parent(hw),\n\t\t\t\t\t\trate / i);\n\t\tcurrent_rate = parent_rate * i;\n\n\t\tif (__is_best_rate(rate, current_rate, best_rate, flags)) {\n\t\t\tbestmult = i;\n\t\t\tbest_rate = current_rate;\n\t\t\t*best_parent_rate = parent_rate;\n\t\t}\n\t}\n\n\treturn bestmult;\n}\n\nstatic long clk_multiplier_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t  unsigned long *parent_rate)\n{\n\tstruct clk_multiplier *mult = to_clk_multiplier(hw);\n\tunsigned long factor = __bestmult(hw, rate, parent_rate,\n\t\t\t\t\t  mult->width, mult->flags);\n\n\treturn *parent_rate * factor;\n}\n\nstatic int clk_multiplier_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t       unsigned long parent_rate)\n{\n\tstruct clk_multiplier *mult = to_clk_multiplier(hw);\n\tunsigned long factor = __get_mult(mult, rate, parent_rate);\n\tunsigned long flags = 0;\n\tunsigned long val;\n\n\tif (mult->lock)\n\t\tspin_lock_irqsave(mult->lock, flags);\n\telse\n\t\t__acquire(mult->lock);\n\n\tval = clk_mult_readl(mult);\n\tval &= ~GENMASK(mult->width + mult->shift - 1, mult->shift);\n\tval |= factor << mult->shift;\n\tclk_mult_writel(mult, val);\n\n\tif (mult->lock)\n\t\tspin_unlock_irqrestore(mult->lock, flags);\n\telse\n\t\t__release(mult->lock);\n\n\treturn 0;\n}\n\nconst struct clk_ops clk_multiplier_ops = {\n\t.recalc_rate\t= clk_multiplier_recalc_rate,\n\t.round_rate\t= clk_multiplier_round_rate,\n\t.set_rate\t= clk_multiplier_set_rate,\n};\nEXPORT_SYMBOL_GPL(clk_multiplier_ops);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}