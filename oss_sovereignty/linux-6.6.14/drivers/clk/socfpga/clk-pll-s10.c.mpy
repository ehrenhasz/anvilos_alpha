{
  "module_name": "clk-pll-s10.c",
  "hash_id": "7b7fdb39c4eab31289c46aa8615bd40f25f33c831373294d2ac75841f3c5a761",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/socfpga/clk-pll-s10.c",
  "human_readable_source": "\n \n#include <linux/slab.h>\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n\n#include \"stratix10-clk.h\"\n#include \"clk.h\"\n\n \n#define CLK_MGR_PLL_CLK_SRC_SHIFT\t16\n#define CLK_MGR_PLL_CLK_SRC_MASK\t0x3\n\n \n#define SOCFPGA_PLL_POWER\t\t0\n#define SOCFPGA_PLL_RESET_MASK\t\t0x2\n#define SOCFPGA_PLL_REFDIV_MASK\t\t0x00003F00\n#define SOCFPGA_PLL_REFDIV_SHIFT\t8\n#define SOCFPGA_PLL_AREFDIV_MASK\t0x00000F00\n#define SOCFPGA_PLL_DREFDIV_MASK\t0x00003000\n#define SOCFPGA_PLL_DREFDIV_SHIFT\t12\n#define SOCFPGA_PLL_MDIV_MASK\t\t0xFF000000\n#define SOCFPGA_PLL_MDIV_SHIFT\t\t24\n#define SOCFPGA_AGILEX_PLL_MDIV_MASK\t0x000003FF\n#define SWCTRLBTCLKSEL_MASK\t\t0x200\n#define SWCTRLBTCLKSEL_SHIFT\t\t9\n\n#define SOCFPGA_N5X_PLLDIV_FDIV_MASK\tGENMASK(16, 8)\n#define SOCFPGA_N5X_PLLDIV_FDIV_SHIFT\t8\n#define SOCFPGA_N5X_PLLDIV_RDIV_MASK\tGENMASK(5, 0)\n#define SOCFPGA_N5X_PLLDIV_QDIV_MASK\tGENMASK(26, 24)\n#define SOCFPGA_N5X_PLLDIV_QDIV_SHIFT\t24\n\n#define SOCFPGA_BOOT_CLK\t\t\"boot_clk\"\n\n#define to_socfpga_clk(p) container_of(p, struct socfpga_pll, hw.hw)\n\nstatic unsigned long n5x_clk_pll_recalc_rate(struct clk_hw *hwclk,\n\t\t\t\t\t\tunsigned long parent_rate)\n{\n\tstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\n\tunsigned long fdiv, reg, rdiv, qdiv;\n\tu32 power = 1;\n\n\t \n\treg = readl(socfpgaclk->hw.reg + 0x8);\n\tfdiv = (reg & SOCFPGA_N5X_PLLDIV_FDIV_MASK) >> SOCFPGA_N5X_PLLDIV_FDIV_SHIFT;\n\trdiv = (reg & SOCFPGA_N5X_PLLDIV_RDIV_MASK);\n\tqdiv = (reg & SOCFPGA_N5X_PLLDIV_QDIV_MASK) >> SOCFPGA_N5X_PLLDIV_QDIV_SHIFT;\n\n\twhile (qdiv) {\n\t\tpower *= 2;\n\t\tqdiv--;\n\t}\n\n\treturn ((parent_rate * 2 * (fdiv + 1)) / ((rdiv + 1) * power));\n}\n\nstatic unsigned long agilex_clk_pll_recalc_rate(struct clk_hw *hwclk,\n\t\t\t\t\t\tunsigned long parent_rate)\n{\n\tstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\n\tunsigned long arefdiv, reg, mdiv;\n\tunsigned long long vco_freq;\n\n\t \n\treg = readl(socfpgaclk->hw.reg);\n\tarefdiv = (reg & SOCFPGA_PLL_AREFDIV_MASK) >> SOCFPGA_PLL_REFDIV_SHIFT;\n\n\tvco_freq = (unsigned long long)parent_rate / arefdiv;\n\n\t \n\treg = readl(socfpgaclk->hw.reg + 0x24);\n\tmdiv = reg & SOCFPGA_AGILEX_PLL_MDIV_MASK;\n\n\tvco_freq = (unsigned long long)vco_freq * mdiv;\n\treturn (unsigned long)vco_freq;\n}\n\nstatic unsigned long clk_pll_recalc_rate(struct clk_hw *hwclk,\n\t\t\t\t\t unsigned long parent_rate)\n{\n\tstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\n\tunsigned long mdiv;\n\tunsigned long refdiv;\n\tunsigned long reg;\n\tunsigned long long vco_freq;\n\n\t \n\treg = readl(socfpgaclk->hw.reg);\n\trefdiv = (reg & SOCFPGA_PLL_REFDIV_MASK) >> SOCFPGA_PLL_REFDIV_SHIFT;\n\n\tvco_freq = parent_rate;\n\tdo_div(vco_freq, refdiv);\n\n\t \n\treg = readl(socfpgaclk->hw.reg + 0x4);\n\tmdiv = (reg & SOCFPGA_PLL_MDIV_MASK) >> SOCFPGA_PLL_MDIV_SHIFT;\n\tvco_freq = (unsigned long long)vco_freq * (mdiv + 6);\n\n\treturn (unsigned long)vco_freq;\n}\n\nstatic unsigned long clk_boot_clk_recalc_rate(struct clk_hw *hwclk,\n\t\t\t\t\t unsigned long parent_rate)\n{\n\tstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\n\tu32 div;\n\n\tdiv = ((readl(socfpgaclk->hw.reg) &\n\t\tSWCTRLBTCLKSEL_MASK) >>\n\t\tSWCTRLBTCLKSEL_SHIFT);\n\tdiv += 1;\n\treturn parent_rate / div;\n}\n\n\nstatic u8 clk_pll_get_parent(struct clk_hw *hwclk)\n{\n\tstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\n\tu32 pll_src;\n\n\tpll_src = readl(socfpgaclk->hw.reg);\n\treturn (pll_src >> CLK_MGR_PLL_CLK_SRC_SHIFT) &\n\t\tCLK_MGR_PLL_CLK_SRC_MASK;\n}\n\nstatic u8 clk_boot_get_parent(struct clk_hw *hwclk)\n{\n\tstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\n\tu32 pll_src;\n\n\tpll_src = readl(socfpgaclk->hw.reg);\n\treturn (pll_src >> SWCTRLBTCLKSEL_SHIFT) &\n\t\tSWCTRLBTCLKSEL_MASK;\n}\n\nstatic int clk_pll_prepare(struct clk_hw *hwclk)\n{\n\tstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\n\tu32 reg;\n\n\t \n\treg = readl(socfpgaclk->hw.reg);\n\treg |= SOCFPGA_PLL_RESET_MASK;\n\twritel(reg, socfpgaclk->hw.reg);\n\n\treturn 0;\n}\n\nstatic int n5x_clk_pll_prepare(struct clk_hw *hwclk)\n{\n\tstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\n\tu32 reg;\n\n\t \n\treg = readl(socfpgaclk->hw.reg + 0x4);\n\treg |= SOCFPGA_PLL_RESET_MASK;\n\twritel(reg, socfpgaclk->hw.reg + 0x4);\n\n\treturn 0;\n}\n\nstatic const struct clk_ops n5x_clk_pll_ops = {\n\t.recalc_rate = n5x_clk_pll_recalc_rate,\n\t.get_parent = clk_pll_get_parent,\n\t.prepare = n5x_clk_pll_prepare,\n};\n\nstatic const struct clk_ops agilex_clk_pll_ops = {\n\t.recalc_rate = agilex_clk_pll_recalc_rate,\n\t.get_parent = clk_pll_get_parent,\n\t.prepare = clk_pll_prepare,\n};\n\nstatic const struct clk_ops clk_pll_ops = {\n\t.recalc_rate = clk_pll_recalc_rate,\n\t.get_parent = clk_pll_get_parent,\n\t.prepare = clk_pll_prepare,\n};\n\nstatic const struct clk_ops clk_boot_ops = {\n\t.recalc_rate = clk_boot_clk_recalc_rate,\n\t.get_parent = clk_boot_get_parent,\n\t.prepare = clk_pll_prepare,\n};\n\nstruct clk_hw *s10_register_pll(const struct stratix10_pll_clock *clks,\n\t\t\t     void __iomem *reg)\n{\n\tstruct clk_hw *hw_clk;\n\tstruct socfpga_pll *pll_clk;\n\tstruct clk_init_data init;\n\tconst char *name = clks->name;\n\tint ret;\n\n\tpll_clk = kzalloc(sizeof(*pll_clk), GFP_KERNEL);\n\tif (WARN_ON(!pll_clk))\n\t\treturn NULL;\n\n\tpll_clk->hw.reg = reg + clks->offset;\n\n\tif (streq(name, SOCFPGA_BOOT_CLK))\n\t\tinit.ops = &clk_boot_ops;\n\telse\n\t\tinit.ops = &clk_pll_ops;\n\n\tinit.name = name;\n\tinit.flags = clks->flags;\n\n\tinit.num_parents = clks->num_parents;\n\tinit.parent_names = NULL;\n\tinit.parent_data = clks->parent_data;\n\tpll_clk->hw.hw.init = &init;\n\n\tpll_clk->hw.bit_idx = SOCFPGA_PLL_POWER;\n\n\thw_clk = &pll_clk->hw.hw;\n\n\tret = clk_hw_register(NULL, hw_clk);\n\tif (ret) {\n\t\tkfree(pll_clk);\n\t\treturn ERR_PTR(ret);\n\t}\n\treturn hw_clk;\n}\n\nstruct clk_hw *agilex_register_pll(const struct stratix10_pll_clock *clks,\n\t\t\t\tvoid __iomem *reg)\n{\n\tstruct clk_hw *hw_clk;\n\tstruct socfpga_pll *pll_clk;\n\tstruct clk_init_data init;\n\tconst char *name = clks->name;\n\tint ret;\n\n\tpll_clk = kzalloc(sizeof(*pll_clk), GFP_KERNEL);\n\tif (WARN_ON(!pll_clk))\n\t\treturn NULL;\n\n\tpll_clk->hw.reg = reg + clks->offset;\n\n\tif (streq(name, SOCFPGA_BOOT_CLK))\n\t\tinit.ops = &clk_boot_ops;\n\telse\n\t\tinit.ops = &agilex_clk_pll_ops;\n\n\tinit.name = name;\n\tinit.flags = clks->flags;\n\n\tinit.num_parents = clks->num_parents;\n\tinit.parent_names = NULL;\n\tinit.parent_data = clks->parent_data;\n\tpll_clk->hw.hw.init = &init;\n\n\tpll_clk->hw.bit_idx = SOCFPGA_PLL_POWER;\n\thw_clk = &pll_clk->hw.hw;\n\n\tret = clk_hw_register(NULL, hw_clk);\n\tif (ret) {\n\t\tkfree(pll_clk);\n\t\treturn ERR_PTR(ret);\n\t}\n\treturn hw_clk;\n}\n\nstruct clk_hw *n5x_register_pll(const struct stratix10_pll_clock *clks,\n\t\t\t     void __iomem *reg)\n{\n\tstruct clk_hw *hw_clk;\n\tstruct socfpga_pll *pll_clk;\n\tstruct clk_init_data init;\n\tconst char *name = clks->name;\n\tint ret;\n\n\tpll_clk = kzalloc(sizeof(*pll_clk), GFP_KERNEL);\n\tif (WARN_ON(!pll_clk))\n\t\treturn NULL;\n\n\tpll_clk->hw.reg = reg + clks->offset;\n\n\tif (streq(name, SOCFPGA_BOOT_CLK))\n\t\tinit.ops = &clk_boot_ops;\n\telse\n\t\tinit.ops = &n5x_clk_pll_ops;\n\n\tinit.name = name;\n\tinit.flags = clks->flags;\n\n\tinit.num_parents = clks->num_parents;\n\tinit.parent_names = NULL;\n\tinit.parent_data = clks->parent_data;\n\tpll_clk->hw.hw.init = &init;\n\n\tpll_clk->hw.bit_idx = SOCFPGA_PLL_POWER;\n\thw_clk = &pll_clk->hw.hw;\n\n\tret = clk_hw_register(NULL, hw_clk);\n\tif (ret) {\n\t\tkfree(pll_clk);\n\t\treturn ERR_PTR(ret);\n\t}\n\treturn hw_clk;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}