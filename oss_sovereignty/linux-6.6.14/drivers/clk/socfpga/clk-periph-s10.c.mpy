{
  "module_name": "clk-periph-s10.c",
  "hash_id": "80d2a50d4ad628cef21175eef1668e2988866b0a867241d5b8ca346a6055a23f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/socfpga/clk-periph-s10.c",
  "human_readable_source": "\n \n#include <linux/slab.h>\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n\n#include \"stratix10-clk.h\"\n#include \"clk.h\"\n\n#define CLK_MGR_FREE_SHIFT\t\t16\n#define CLK_MGR_FREE_MASK\t\t0x7\n#define SWCTRLBTCLKSEN_SHIFT\t\t8\n\n#define to_periph_clk(p) container_of(p, struct socfpga_periph_clk, hw.hw)\n\nstatic unsigned long n5x_clk_peri_c_clk_recalc_rate(struct clk_hw *hwclk,\n\t\t\t\t\t     unsigned long parent_rate)\n{\n\tstruct socfpga_periph_clk *socfpgaclk = to_periph_clk(hwclk);\n\tunsigned long div;\n\tunsigned long shift = socfpgaclk->shift;\n\tu32 val;\n\n\tval = readl(socfpgaclk->hw.reg);\n\tval &= (0x1f << shift);\n\tdiv = (val >> shift) + 1;\n\n\treturn parent_rate / div;\n}\n\nstatic unsigned long clk_peri_c_clk_recalc_rate(struct clk_hw *hwclk,\n\t\t\t\t\t     unsigned long parent_rate)\n{\n\tstruct socfpga_periph_clk *socfpgaclk = to_periph_clk(hwclk);\n\tunsigned long div = 1;\n\tu32 val;\n\n\tval = readl(socfpgaclk->hw.reg);\n\tval &= GENMASK(SWCTRLBTCLKSEN_SHIFT - 1, 0);\n\tparent_rate /= val;\n\n\treturn parent_rate / div;\n}\n\nstatic unsigned long clk_peri_cnt_clk_recalc_rate(struct clk_hw *hwclk,\n\t\t\t\t\t     unsigned long parent_rate)\n{\n\tstruct socfpga_periph_clk *socfpgaclk = to_periph_clk(hwclk);\n\tunsigned long div = 1;\n\n\tif (socfpgaclk->fixed_div) {\n\t\tdiv = socfpgaclk->fixed_div;\n\t} else {\n\t\tif (socfpgaclk->hw.reg)\n\t\t\tdiv = ((readl(socfpgaclk->hw.reg) & 0x7ff) + 1);\n\t}\n\n\treturn parent_rate / div;\n}\n\nstatic u8 clk_periclk_get_parent(struct clk_hw *hwclk)\n{\n\tstruct socfpga_periph_clk *socfpgaclk = to_periph_clk(hwclk);\n\tu32 clk_src, mask;\n\tu8 parent = 0;\n\n\t \n\tif (socfpgaclk->bypass_reg) {\n\t\tmask = (0x1 << socfpgaclk->bypass_shift);\n\t\tparent = ((readl(socfpgaclk->bypass_reg) & mask) >>\n\t\t\t   socfpgaclk->bypass_shift);\n\t\tif (parent)\n\t\t\treturn parent;\n\t}\n\n\tif (socfpgaclk->hw.reg) {\n\t\tclk_src = readl(socfpgaclk->hw.reg);\n\t\tparent = (clk_src >> CLK_MGR_FREE_SHIFT) &\n\t\t\t  CLK_MGR_FREE_MASK;\n\t}\n\treturn parent;\n}\n\nstatic const struct clk_ops n5x_peri_c_clk_ops = {\n\t.recalc_rate = n5x_clk_peri_c_clk_recalc_rate,\n\t.get_parent = clk_periclk_get_parent,\n};\n\nstatic const struct clk_ops peri_c_clk_ops = {\n\t.recalc_rate = clk_peri_c_clk_recalc_rate,\n\t.get_parent = clk_periclk_get_parent,\n};\n\nstatic const struct clk_ops peri_cnt_clk_ops = {\n\t.recalc_rate = clk_peri_cnt_clk_recalc_rate,\n\t.get_parent = clk_periclk_get_parent,\n};\n\nstruct clk_hw *s10_register_periph(const struct stratix10_perip_c_clock *clks,\n\t\t\t\tvoid __iomem *reg)\n{\n\tstruct clk_hw *hw_clk;\n\tstruct socfpga_periph_clk *periph_clk;\n\tstruct clk_init_data init;\n\tconst char *name = clks->name;\n\tconst char *parent_name = clks->parent_name;\n\tint ret;\n\n\tperiph_clk = kzalloc(sizeof(*periph_clk), GFP_KERNEL);\n\tif (WARN_ON(!periph_clk))\n\t\treturn NULL;\n\n\tperiph_clk->hw.reg = reg + clks->offset;\n\n\tinit.name = name;\n\tinit.ops = &peri_c_clk_ops;\n\tinit.flags = clks->flags;\n\n\tinit.num_parents = clks->num_parents;\n\tinit.parent_names = parent_name ? &parent_name : NULL;\n\tif (init.parent_names == NULL)\n\t\tinit.parent_data = clks->parent_data;\n\n\tperiph_clk->hw.hw.init = &init;\n\thw_clk = &periph_clk->hw.hw;\n\n\tret = clk_hw_register(NULL, hw_clk);\n\tif (ret) {\n\t\tkfree(periph_clk);\n\t\treturn ERR_PTR(ret);\n\t}\n\treturn hw_clk;\n}\n\nstruct clk_hw *n5x_register_periph(const struct n5x_perip_c_clock *clks,\n\t\t\t\tvoid __iomem *regbase)\n{\n\tstruct clk_hw *hw_clk;\n\tstruct socfpga_periph_clk *periph_clk;\n\tstruct clk_init_data init;\n\tconst char *name = clks->name;\n\tconst char *parent_name = clks->parent_name;\n\tint ret;\n\n\tperiph_clk = kzalloc(sizeof(*periph_clk), GFP_KERNEL);\n\tif (WARN_ON(!periph_clk))\n\t\treturn NULL;\n\n\tperiph_clk->hw.reg = regbase + clks->offset;\n\tperiph_clk->shift = clks->shift;\n\n\tinit.name = name;\n\tinit.ops = &n5x_peri_c_clk_ops;\n\tinit.flags = clks->flags;\n\n\tinit.num_parents = clks->num_parents;\n\tinit.parent_names = parent_name ? &parent_name : NULL;\n\n\tperiph_clk->hw.hw.init = &init;\n\thw_clk = &periph_clk->hw.hw;\n\n\tret = clk_hw_register(NULL, hw_clk);\n\tif (ret) {\n\t\tkfree(periph_clk);\n\t\treturn ERR_PTR(ret);\n\t}\n\treturn hw_clk;\n}\n\nstruct clk_hw *s10_register_cnt_periph(const struct stratix10_perip_cnt_clock *clks,\n\t\t\t\t    void __iomem *regbase)\n{\n\tstruct clk_hw *hw_clk;\n\tstruct socfpga_periph_clk *periph_clk;\n\tstruct clk_init_data init;\n\tconst char *name = clks->name;\n\tconst char *parent_name = clks->parent_name;\n\tint ret;\n\n\tperiph_clk = kzalloc(sizeof(*periph_clk), GFP_KERNEL);\n\tif (WARN_ON(!periph_clk))\n\t\treturn NULL;\n\n\tif (clks->offset)\n\t\tperiph_clk->hw.reg = regbase + clks->offset;\n\telse\n\t\tperiph_clk->hw.reg = NULL;\n\n\tif (clks->bypass_reg)\n\t\tperiph_clk->bypass_reg = regbase + clks->bypass_reg;\n\telse\n\t\tperiph_clk->bypass_reg = NULL;\n\tperiph_clk->bypass_shift = clks->bypass_shift;\n\tperiph_clk->fixed_div = clks->fixed_divider;\n\n\tinit.name = name;\n\tinit.ops = &peri_cnt_clk_ops;\n\tinit.flags = clks->flags;\n\n\tinit.num_parents = clks->num_parents;\n\tinit.parent_names = parent_name ? &parent_name : NULL;\n\tif (init.parent_names == NULL)\n\t\tinit.parent_data = clks->parent_data;\n\n\tperiph_clk->hw.hw.init = &init;\n\thw_clk = &periph_clk->hw.hw;\n\n\tret = clk_hw_register(NULL, hw_clk);\n\tif (ret) {\n\t\tkfree(periph_clk);\n\t\treturn ERR_PTR(ret);\n\t}\n\treturn hw_clk;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}