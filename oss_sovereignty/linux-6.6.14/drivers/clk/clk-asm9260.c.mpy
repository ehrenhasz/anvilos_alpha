{
  "module_name": "clk-asm9260.c",
  "hash_id": "ffe556ab3dc5c9a4d1040b1311c4c1ee39148c16316ece52db956ba4524f025f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/clk-asm9260.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clkdev.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/clk-provider.h>\n#include <linux/spinlock.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <dt-bindings/clock/alphascale,asm9260.h>\n\n#define HW_AHBCLKCTRL0\t\t0x0020\n#define HW_AHBCLKCTRL1\t\t0x0030\n#define HW_SYSPLLCTRL\t\t0x0100\n#define HW_MAINCLKSEL\t\t0x0120\n#define HW_MAINCLKUEN\t\t0x0124\n#define HW_UARTCLKSEL\t\t0x0128\n#define HW_UARTCLKUEN\t\t0x012c\n#define HW_I2S0CLKSEL\t\t0x0130\n#define HW_I2S0CLKUEN\t\t0x0134\n#define HW_I2S1CLKSEL\t\t0x0138\n#define HW_I2S1CLKUEN\t\t0x013c\n#define HW_WDTCLKSEL\t\t0x0160\n#define HW_WDTCLKUEN\t\t0x0164\n#define HW_CLKOUTCLKSEL\t\t0x0170\n#define HW_CLKOUTCLKUEN\t\t0x0174\n#define HW_CPUCLKDIV\t\t0x017c\n#define HW_SYSAHBCLKDIV\t\t0x0180\n#define HW_I2S0MCLKDIV\t\t0x0190\n#define HW_I2S0SCLKDIV\t\t0x0194\n#define HW_I2S1MCLKDIV\t\t0x0188\n#define HW_I2S1SCLKDIV\t\t0x018c\n#define HW_UART0CLKDIV\t\t0x0198\n#define HW_UART1CLKDIV\t\t0x019c\n#define HW_UART2CLKDIV\t\t0x01a0\n#define HW_UART3CLKDIV\t\t0x01a4\n#define HW_UART4CLKDIV\t\t0x01a8\n#define HW_UART5CLKDIV\t\t0x01ac\n#define HW_UART6CLKDIV\t\t0x01b0\n#define HW_UART7CLKDIV\t\t0x01b4\n#define HW_UART8CLKDIV\t\t0x01b8\n#define HW_UART9CLKDIV\t\t0x01bc\n#define HW_SPI0CLKDIV\t\t0x01c0\n#define HW_SPI1CLKDIV\t\t0x01c4\n#define HW_QUADSPICLKDIV\t0x01c8\n#define HW_SSP0CLKDIV\t\t0x01d0\n#define HW_NANDCLKDIV\t\t0x01d4\n#define HW_TRACECLKDIV\t\t0x01e0\n#define HW_CAMMCLKDIV\t\t0x01e8\n#define HW_WDTCLKDIV\t\t0x01ec\n#define HW_CLKOUTCLKDIV\t\t0x01f4\n#define HW_MACCLKDIV\t\t0x01f8\n#define HW_LCDCLKDIV\t\t0x01fc\n#define HW_ADCANACLKDIV\t\t0x0200\n\nstatic struct clk_hw_onecell_data *clk_data;\nstatic DEFINE_SPINLOCK(asm9260_clk_lock);\n\nstruct asm9260_div_clk {\n\tunsigned int idx;\n\tconst char *name;\n\tconst char *parent_name;\n\tu32 reg;\n};\n\nstruct asm9260_gate_data {\n\tunsigned int idx;\n\tconst char *name;\n\tconst char *parent_name;\n\tu32 reg;\n\tu8 bit_idx;\n\tunsigned long flags;\n};\n\nstruct asm9260_mux_clock {\n\tu8\t\t\tmask;\n\tu32\t\t\t*table;\n\tconst char\t\t*name;\n\tconst struct clk_parent_data *parent_data;\n\tu8\t\t\tnum_parents;\n\tunsigned long\t\toffset;\n\tunsigned long\t\tflags;\n};\n\nstatic void __iomem *base;\n\nstatic const struct asm9260_div_clk asm9260_div_clks[] __initconst = {\n\t{ CLKID_SYS_CPU,\t\"cpu_div\", \"main_gate\", HW_CPUCLKDIV },\n\t{ CLKID_SYS_AHB,\t\"ahb_div\", \"cpu_div\", HW_SYSAHBCLKDIV },\n\n\t \n\t{ CLKID_SYS_I2S0M,\t\"i2s0m_div\", \"i2s0_mclk\",  HW_I2S0MCLKDIV },\n\t{ CLKID_SYS_I2S1M,\t\"i2s1m_div\", \"i2s1_mclk\",  HW_I2S1MCLKDIV },\n\t{ CLKID_SYS_I2S0S,\t\"i2s0s_div\", \"i2s0_gate\",  HW_I2S0SCLKDIV },\n\t{ CLKID_SYS_I2S1S,\t\"i2s1s_div\", \"i2s0_gate\",  HW_I2S1SCLKDIV },\n\n\t{ CLKID_SYS_UART0,\t\"uart0_div\", \"uart_gate\", HW_UART0CLKDIV },\n\t{ CLKID_SYS_UART1,\t\"uart1_div\", \"uart_gate\", HW_UART1CLKDIV },\n\t{ CLKID_SYS_UART2,\t\"uart2_div\", \"uart_gate\", HW_UART2CLKDIV },\n\t{ CLKID_SYS_UART3,\t\"uart3_div\", \"uart_gate\", HW_UART3CLKDIV },\n\t{ CLKID_SYS_UART4,\t\"uart4_div\", \"uart_gate\", HW_UART4CLKDIV },\n\t{ CLKID_SYS_UART5,\t\"uart5_div\", \"uart_gate\", HW_UART5CLKDIV },\n\t{ CLKID_SYS_UART6,\t\"uart6_div\", \"uart_gate\", HW_UART6CLKDIV },\n\t{ CLKID_SYS_UART7,\t\"uart7_div\", \"uart_gate\", HW_UART7CLKDIV },\n\t{ CLKID_SYS_UART8,\t\"uart8_div\", \"uart_gate\", HW_UART8CLKDIV },\n\t{ CLKID_SYS_UART9,\t\"uart9_div\", \"uart_gate\", HW_UART9CLKDIV },\n\n\t{ CLKID_SYS_SPI0,\t\"spi0_div\",\t\"main_gate\", HW_SPI0CLKDIV },\n\t{ CLKID_SYS_SPI1,\t\"spi1_div\",\t\"main_gate\", HW_SPI1CLKDIV },\n\t{ CLKID_SYS_QUADSPI,\t\"quadspi_div\",\t\"main_gate\", HW_QUADSPICLKDIV },\n\t{ CLKID_SYS_SSP0,\t\"ssp0_div\",\t\"main_gate\", HW_SSP0CLKDIV },\n\t{ CLKID_SYS_NAND,\t\"nand_div\",\t\"main_gate\", HW_NANDCLKDIV },\n\t{ CLKID_SYS_TRACE,\t\"trace_div\",\t\"main_gate\", HW_TRACECLKDIV },\n\t{ CLKID_SYS_CAMM,\t\"camm_div\",\t\"main_gate\", HW_CAMMCLKDIV },\n\t{ CLKID_SYS_MAC,\t\"mac_div\",\t\"main_gate\", HW_MACCLKDIV },\n\t{ CLKID_SYS_LCD,\t\"lcd_div\",\t\"main_gate\", HW_LCDCLKDIV },\n\t{ CLKID_SYS_ADCANA,\t\"adcana_div\",\t\"main_gate\", HW_ADCANACLKDIV },\n\n\t{ CLKID_SYS_WDT,\t\"wdt_div\",\t\"wdt_gate\",    HW_WDTCLKDIV },\n\t{ CLKID_SYS_CLKOUT,\t\"clkout_div\",\t\"clkout_gate\", HW_CLKOUTCLKDIV },\n};\n\nstatic const struct asm9260_gate_data asm9260_mux_gates[] __initconst = {\n\t{ 0, \"main_gate\",\t\"main_mux\",\tHW_MAINCLKUEN,\t0 },\n\t{ 0, \"uart_gate\",\t\"uart_mux\",\tHW_UARTCLKUEN,\t0 },\n\t{ 0, \"i2s0_gate\",\t\"i2s0_mux\",\tHW_I2S0CLKUEN,\t0 },\n\t{ 0, \"i2s1_gate\",\t\"i2s1_mux\",\tHW_I2S1CLKUEN,\t0 },\n\t{ 0, \"wdt_gate\",\t\"wdt_mux\",\tHW_WDTCLKUEN,\t0 },\n\t{ 0, \"clkout_gate\",\t\"clkout_mux\",\tHW_CLKOUTCLKUEN, 0 },\n};\nstatic const struct asm9260_gate_data asm9260_ahb_gates[] __initconst = {\n\t \n\t{ CLKID_AHB_ROM,\t\"rom\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t1, CLK_IGNORE_UNUSED},\n\t{ CLKID_AHB_RAM,\t\"ram\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t2, CLK_IGNORE_UNUSED},\n\t{ CLKID_AHB_GPIO,\t\"gpio\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t4 },\n\t{ CLKID_AHB_MAC,\t\"mac\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t5 },\n\t{ CLKID_AHB_EMI,\t\"emi\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t6, CLK_IGNORE_UNUSED},\n\t{ CLKID_AHB_USB0,\t\"usb0\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t7 },\n\t{ CLKID_AHB_USB1,\t\"usb1\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t8 },\n\t{ CLKID_AHB_DMA0,\t\"dma0\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t9 },\n\t{ CLKID_AHB_DMA1,\t\"dma1\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t10 },\n\t{ CLKID_AHB_UART0,\t\"uart0\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t11 },\n\t{ CLKID_AHB_UART1,\t\"uart1\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t12 },\n\t{ CLKID_AHB_UART2,\t\"uart2\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t13 },\n\t{ CLKID_AHB_UART3,\t\"uart3\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t14 },\n\t{ CLKID_AHB_UART4,\t\"uart4\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t15 },\n\t{ CLKID_AHB_UART5,\t\"uart5\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t16 },\n\t{ CLKID_AHB_UART6,\t\"uart6\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t17 },\n\t{ CLKID_AHB_UART7,\t\"uart7\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t18 },\n\t{ CLKID_AHB_UART8,\t\"uart8\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t19 },\n\t{ CLKID_AHB_UART9,\t\"uart9\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t20 },\n\t{ CLKID_AHB_I2S0,\t\"i2s0\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t21 },\n\t{ CLKID_AHB_I2C0,\t\"i2c0\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t22 },\n\t{ CLKID_AHB_I2C1,\t\"i2c1\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t23 },\n\t{ CLKID_AHB_SSP0,\t\"ssp0\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t24 },\n\t{ CLKID_AHB_IOCONFIG,\t\"ioconf\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t25 },\n\t{ CLKID_AHB_WDT,\t\"wdt\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t26 },\n\t{ CLKID_AHB_CAN0,\t\"can0\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t27 },\n\t{ CLKID_AHB_CAN1,\t\"can1\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t28 },\n\t{ CLKID_AHB_MPWM,\t\"mpwm\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t29 },\n\t{ CLKID_AHB_SPI0,\t\"spi0\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t30 },\n\t{ CLKID_AHB_SPI1,\t\"spi1\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL0,\t31 },\n\n\t{ CLKID_AHB_QEI,\t\"qei\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t0 },\n\t{ CLKID_AHB_QUADSPI0,\t\"quadspi0\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t1 },\n\t{ CLKID_AHB_CAMIF,\t\"capmif\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t2 },\n\t{ CLKID_AHB_LCDIF,\t\"lcdif\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t3 },\n\t{ CLKID_AHB_TIMER0,\t\"timer0\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t4 },\n\t{ CLKID_AHB_TIMER1,\t\"timer1\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t5 },\n\t{ CLKID_AHB_TIMER2,\t\"timer2\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t6 },\n\t{ CLKID_AHB_TIMER3,\t\"timer3\",\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t7 },\n\t{ CLKID_AHB_IRQ,\t\"irq\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t8, CLK_IGNORE_UNUSED},\n\t{ CLKID_AHB_RTC,\t\"rtc\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t9 },\n\t{ CLKID_AHB_NAND,\t\"nand\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t10 },\n\t{ CLKID_AHB_ADC0,\t\"adc0\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t11 },\n\t{ CLKID_AHB_LED,\t\"led\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t12 },\n\t{ CLKID_AHB_DAC0,\t\"dac0\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t13 },\n\t{ CLKID_AHB_LCD,\t\"lcd\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t14 },\n\t{ CLKID_AHB_I2S1,\t\"i2s1\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t15 },\n\t{ CLKID_AHB_MAC1,\t\"mac1\",\t\t\"ahb_div\",\n\t\tHW_AHBCLKCTRL1,\t16 },\n};\n\nstatic struct clk_parent_data __initdata main_mux_p[] =   { { .index = 0, }, { .name = \"pll\" } };\nstatic struct clk_parent_data __initdata i2s0_mux_p[] =   { { .index = 0, }, { .name = \"pll\" }, { .name = \"i2s0m_div\"} };\nstatic struct clk_parent_data __initdata i2s1_mux_p[] =   { { .index = 0, }, { .name = \"pll\" }, { .name = \"i2s1m_div\"} };\nstatic struct clk_parent_data __initdata clkout_mux_p[] = { { .index = 0, }, { .name = \"pll\" }, { .name = \"rtc\"} };\nstatic u32 three_mux_table[] = {0, 1, 3};\n\nstatic struct asm9260_mux_clock asm9260_mux_clks[] __initdata = {\n\t{ 1, three_mux_table, \"main_mux\",\tmain_mux_p,\n\t\tARRAY_SIZE(main_mux_p), HW_MAINCLKSEL, },\n\t{ 1, three_mux_table, \"uart_mux\",\tmain_mux_p,\n\t\tARRAY_SIZE(main_mux_p), HW_UARTCLKSEL, },\n\t{ 1, three_mux_table, \"wdt_mux\",\tmain_mux_p,\n\t\tARRAY_SIZE(main_mux_p), HW_WDTCLKSEL, },\n\t{ 3, three_mux_table, \"i2s0_mux\",\ti2s0_mux_p,\n\t\tARRAY_SIZE(i2s0_mux_p), HW_I2S0CLKSEL, },\n\t{ 3, three_mux_table, \"i2s1_mux\",\ti2s1_mux_p,\n\t\tARRAY_SIZE(i2s1_mux_p), HW_I2S1CLKSEL, },\n\t{ 3, three_mux_table, \"clkout_mux\",\tclkout_mux_p,\n\t\tARRAY_SIZE(clkout_mux_p), HW_CLKOUTCLKSEL, },\n};\n\nstatic void __init asm9260_acc_init(struct device_node *np)\n{\n\tstruct clk_hw *hw, *pll_hw;\n\tstruct clk_hw **hws;\n\tconst char *pll_clk = \"pll\";\n\tstruct clk_parent_data pll_parent_data = { .index = 0 };\n\tu32 rate;\n\tint n;\n\n\tclk_data = kzalloc(struct_size(clk_data, hws, MAX_CLKS), GFP_KERNEL);\n\tif (!clk_data)\n\t\treturn;\n\tclk_data->num = MAX_CLKS;\n\thws = clk_data->hws;\n\n\tbase = of_io_request_and_map(np, 0, np->name);\n\tif (IS_ERR(base))\n\t\tpanic(\"%pOFn: unable to map resource\", np);\n\n\t \n\trate = (ioread32(base + HW_SYSPLLCTRL) & 0xffff) * 1000000;\n\n\tpll_hw = clk_hw_register_fixed_rate_parent_accuracy(NULL, pll_clk, &pll_parent_data,\n\t\t\t\t\t\t\t0, rate);\n\tif (IS_ERR(pll_hw))\n\t\tpanic(\"%pOFn: can't register REFCLK. Check DT!\", np);\n\n\tfor (n = 0; n < ARRAY_SIZE(asm9260_mux_clks); n++) {\n\t\tconst struct asm9260_mux_clock *mc = &asm9260_mux_clks[n];\n\n\t\thw = clk_hw_register_mux_table_parent_data(NULL, mc->name, mc->parent_data,\n\t\t\t\tmc->num_parents, mc->flags, base + mc->offset,\n\t\t\t\t0, mc->mask, 0, mc->table, &asm9260_clk_lock);\n\t}\n\n\t \n\tfor (n = 0; n < ARRAY_SIZE(asm9260_mux_gates); n++) {\n\t\tconst struct asm9260_gate_data *gd = &asm9260_mux_gates[n];\n\n\t\thw = clk_hw_register_gate(NULL, gd->name,\n\t\t\tgd->parent_name, gd->flags | CLK_SET_RATE_PARENT,\n\t\t\tbase + gd->reg, gd->bit_idx, 0, &asm9260_clk_lock);\n\t}\n\n\t \n\tfor (n = 0; n < ARRAY_SIZE(asm9260_div_clks); n++) {\n\t\tconst struct asm9260_div_clk *dc = &asm9260_div_clks[n];\n\n\t\thws[dc->idx] = clk_hw_register_divider(NULL, dc->name,\n\t\t\t\tdc->parent_name, CLK_SET_RATE_PARENT,\n\t\t\t\tbase + dc->reg, 0, 8, CLK_DIVIDER_ONE_BASED,\n\t\t\t\t&asm9260_clk_lock);\n\t}\n\n\t \n\tfor (n = 0; n < ARRAY_SIZE(asm9260_ahb_gates); n++) {\n\t\tconst struct asm9260_gate_data *gd = &asm9260_ahb_gates[n];\n\n\t\thws[gd->idx] = clk_hw_register_gate(NULL, gd->name,\n\t\t\t\tgd->parent_name, gd->flags, base + gd->reg,\n\t\t\t\tgd->bit_idx, 0, &asm9260_clk_lock);\n\t}\n\n\t \n\tfor (n = 0; n < MAX_CLKS; n++) {\n\t\tif (!IS_ERR(hws[n]))\n\t\t\tcontinue;\n\n\t\tpr_err(\"%pOF: Unable to register leaf clock %d\\n\",\n\t\t\t\tnp, n);\n\t\tgoto fail;\n\t}\n\n\t \n\tof_clk_add_hw_provider(np, of_clk_hw_onecell_get, clk_data);\n\treturn;\nfail:\n\tiounmap(base);\n}\nCLK_OF_DECLARE(asm9260_acc, \"alphascale,asm9260-clock-controller\",\n\t\tasm9260_acc_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}