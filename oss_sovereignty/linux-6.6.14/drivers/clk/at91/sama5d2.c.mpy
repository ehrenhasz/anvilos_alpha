{
  "module_name": "sama5d2.c",
  "hash_id": "4f9b6e7d41677d666638c28856e780b9c1f093810bd8a24b20c9ca48cfbdff1e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/at91/sama5d2.c",
  "human_readable_source": "\n#include <linux/clk-provider.h>\n#include <linux/mfd/syscon.h>\n#include <linux/slab.h>\n\n#include <dt-bindings/clock/at91.h>\n\n#include \"pmc.h\"\n\nstatic DEFINE_SPINLOCK(mck_lock);\n\nstatic const struct clk_master_characteristics mck_characteristics = {\n\t.output = { .min = 124000000, .max = 166000000 },\n\t.divisors = { 1, 2, 4, 3 },\n};\n\nstatic u8 plla_out[] = { 0 };\n\nstatic u16 plla_icpll[] = { 0 };\n\nstatic const struct clk_range plla_outputs[] = {\n\t{ .min = 600000000, .max = 1200000000 },\n};\n\nstatic const struct clk_pll_characteristics plla_characteristics = {\n\t.input = { .min = 12000000, .max = 24000000 },\n\t.num_output = ARRAY_SIZE(plla_outputs),\n\t.output = plla_outputs,\n\t.icpll = plla_icpll,\n\t.out = plla_out,\n};\n\nstatic const struct clk_pcr_layout sama5d2_pcr_layout = {\n\t.offset = 0x10c,\n\t.cmd = BIT(12),\n\t.gckcss_mask = GENMASK(10, 8),\n\t.pid_mask = GENMASK(6, 0),\n};\n\nstatic const struct {\n\tchar *n;\n\tchar *p;\n\tunsigned long flags;\n\tu8 id;\n} sama5d2_systemck[] = {\n\t \n\t{ .n = \"ddrck\", .p = \"masterck_div\", .id = 2, .flags = CLK_IS_CRITICAL },\n\t{ .n = \"lcdck\", .p = \"masterck_div\", .id = 3 },\n\t{ .n = \"uhpck\", .p = \"usbck\",        .id = 6 },\n\t{ .n = \"udpck\", .p = \"usbck\",        .id = 7 },\n\t{ .n = \"pck0\",  .p = \"prog0\",        .id = 8 },\n\t{ .n = \"pck1\",  .p = \"prog1\",        .id = 9 },\n\t{ .n = \"pck2\",  .p = \"prog2\",        .id = 10 },\n\t{ .n = \"iscck\", .p = \"masterck_div\", .id = 18 },\n};\n\nstatic const struct {\n\tchar *n;\n\tu8 id;\n\tstruct clk_range r;\n} sama5d2_periph32ck[] = {\n\t{ .n = \"macb0_clk\",   .id = 5,  .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"tdes_clk\",    .id = 11, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"matrix1_clk\", .id = 14, },\n\t{ .n = \"hsmc_clk\",    .id = 17, },\n\t{ .n = \"pioA_clk\",    .id = 18, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"flx0_clk\",    .id = 19, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"flx1_clk\",    .id = 20, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"flx2_clk\",    .id = 21, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"flx3_clk\",    .id = 22, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"flx4_clk\",    .id = 23, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"uart0_clk\",   .id = 24, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"uart1_clk\",   .id = 25, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"uart2_clk\",   .id = 26, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"uart3_clk\",   .id = 27, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"uart4_clk\",   .id = 28, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"twi0_clk\",    .id = 29, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"twi1_clk\",    .id = 30, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"spi0_clk\",    .id = 33, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"spi1_clk\",    .id = 34, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"tcb0_clk\",    .id = 35, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"tcb1_clk\",    .id = 36, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"pwm_clk\",     .id = 38, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"adc_clk\",     .id = 40, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"uhphs_clk\",   .id = 41, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"udphs_clk\",   .id = 42, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"ssc0_clk\",    .id = 43, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"ssc1_clk\",    .id = 44, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"trng_clk\",    .id = 47, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"pdmic_clk\",   .id = 48, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"securam_clk\", .id = 51, },\n\t{ .n = \"i2s0_clk\",    .id = 54, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"i2s1_clk\",    .id = 55, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"can0_clk\",    .id = 56, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"can1_clk\",    .id = 57, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"ptc_clk\",     .id = 58, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"classd_clk\",  .id = 59, .r = { .min = 0, .max = 83000000 }, },\n};\n\nstatic const struct {\n\tchar *n;\n\tunsigned long flags;\n\tu8 id;\n} sama5d2_periphck[] = {\n\t{ .n = \"dma0_clk\",    .id = 6, },\n\t{ .n = \"dma1_clk\",    .id = 7, },\n\t{ .n = \"aes_clk\",     .id = 9, },\n\t{ .n = \"aesb_clk\",    .id = 10, },\n\t{ .n = \"sha_clk\",     .id = 12, },\n\t \n\t{ .n = \"mpddr_clk\",   .id = 13, .flags = CLK_IS_CRITICAL },\n\t{ .n = \"matrix0_clk\", .id = 15, },\n\t{ .n = \"sdmmc0_hclk\", .id = 31, },\n\t{ .n = \"sdmmc1_hclk\", .id = 32, },\n\t{ .n = \"lcdc_clk\",    .id = 45, },\n\t{ .n = \"isc_clk\",     .id = 46, },\n\t{ .n = \"qspi0_clk\",   .id = 52, },\n\t{ .n = \"qspi1_clk\",   .id = 53, },\n};\n\nstatic const struct {\n\tchar *n;\n\tu8 id;\n\tstruct clk_range r;\n\tint chg_pid;\n} sama5d2_gck[] = {\n\t{ .n = \"flx0_gclk\",   .id = 19, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"flx1_gclk\",   .id = 20, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"flx2_gclk\",   .id = 21, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"flx3_gclk\",   .id = 22, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"flx4_gclk\",   .id = 23, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"uart0_gclk\",  .id = 24, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"uart1_gclk\",  .id = 25, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"uart2_gclk\",  .id = 26, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"uart3_gclk\",  .id = 27, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"uart4_gclk\",  .id = 28, .chg_pid = INT_MIN, .r = { .min = 0, .max = 27666666 }, },\n\t{ .n = \"sdmmc0_gclk\", .id = 31, .chg_pid = INT_MIN, },\n\t{ .n = \"sdmmc1_gclk\", .id = 32, .chg_pid = INT_MIN, },\n\t{ .n = \"tcb0_gclk\",   .id = 35, .chg_pid = INT_MIN, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"tcb1_gclk\",   .id = 36, .chg_pid = INT_MIN, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"pwm_gclk\",    .id = 38, .chg_pid = INT_MIN, .r = { .min = 0, .max = 83000000 }, },\n\t{ .n = \"isc_gclk\",    .id = 46, .chg_pid = INT_MIN, },\n\t{ .n = \"pdmic_gclk\",  .id = 48, .chg_pid = INT_MIN, },\n\t{ .n = \"i2s0_gclk\",   .id = 54, .chg_pid = 5, },\n\t{ .n = \"i2s1_gclk\",   .id = 55, .chg_pid = 5, },\n\t{ .n = \"can0_gclk\",   .id = 56, .chg_pid = INT_MIN, .r = { .min = 0, .max = 80000000 }, },\n\t{ .n = \"can1_gclk\",   .id = 57, .chg_pid = INT_MIN, .r = { .min = 0, .max = 80000000 }, },\n\t{ .n = \"classd_gclk\", .id = 59, .chg_pid = 5, .r = { .min = 0, .max = 100000000 }, },\n};\n\nstatic const struct clk_programmable_layout sama5d2_programmable_layout = {\n\t.pres_mask = 0xff,\n\t.pres_shift = 4,\n\t.css_mask = 0x7,\n\t.have_slck_mck = 0,\n\t.is_pres_direct = 1,\n};\n\nstatic void __init sama5d2_pmc_setup(struct device_node *np)\n{\n\tstruct clk_range range = CLK_RANGE(0, 0);\n\tconst char *slck_name, *mainxtal_name;\n\tstruct pmc_data *sama5d2_pmc;\n\tconst char *parent_names[6];\n\tstruct regmap *regmap, *regmap_sfr;\n\tstruct clk_hw *hw;\n\tint i;\n\tbool bypass;\n\n\ti = of_property_match_string(np, \"clock-names\", \"slow_clk\");\n\tif (i < 0)\n\t\treturn;\n\n\tslck_name = of_clk_get_parent_name(np, i);\n\n\ti = of_property_match_string(np, \"clock-names\", \"main_xtal\");\n\tif (i < 0)\n\t\treturn;\n\tmainxtal_name = of_clk_get_parent_name(np, i);\n\n\tregmap = device_node_to_regmap(np);\n\tif (IS_ERR(regmap))\n\t\treturn;\n\n\tsama5d2_pmc = pmc_data_allocate(PMC_AUDIOPINCK + 1,\n\t\t\t\t\tnck(sama5d2_systemck),\n\t\t\t\t\tnck(sama5d2_periph32ck),\n\t\t\t\t\tnck(sama5d2_gck), 3);\n\tif (!sama5d2_pmc)\n\t\treturn;\n\n\thw = at91_clk_register_main_rc_osc(regmap, \"main_rc_osc\", 12000000,\n\t\t\t\t\t   100000000);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tbypass = of_property_read_bool(np, \"atmel,osc-bypass\");\n\n\thw = at91_clk_register_main_osc(regmap, \"main_osc\", mainxtal_name, NULL,\n\t\t\t\t\tbypass);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tparent_names[0] = \"main_rc_osc\";\n\tparent_names[1] = \"main_osc\";\n\thw = at91_clk_register_sam9x5_main(regmap, \"mainck\", parent_names, NULL, 2);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d2_pmc->chws[PMC_MAIN] = hw;\n\n\thw = at91_clk_register_pll(regmap, \"pllack\", \"mainck\", 0,\n\t\t\t\t   &sama5d3_pll_layout, &plla_characteristics);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\thw = at91_clk_register_plldiv(regmap, \"plladivck\", \"pllack\");\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d2_pmc->chws[PMC_PLLACK] = hw;\n\n\thw = at91_clk_register_audio_pll_frac(regmap, \"audiopll_fracck\",\n\t\t\t\t\t      \"mainck\");\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\thw = at91_clk_register_audio_pll_pad(regmap, \"audiopll_padck\",\n\t\t\t\t\t     \"audiopll_fracck\");\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d2_pmc->chws[PMC_AUDIOPINCK] = hw;\n\n\thw = at91_clk_register_audio_pll_pmc(regmap, \"audiopll_pmcck\",\n\t\t\t\t\t     \"audiopll_fracck\");\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d2_pmc->chws[PMC_AUDIOPLLCK] = hw;\n\n\tregmap_sfr = syscon_regmap_lookup_by_compatible(\"atmel,sama5d2-sfr\");\n\tif (IS_ERR(regmap_sfr))\n\t\tregmap_sfr = NULL;\n\n\thw = at91_clk_register_utmi(regmap, regmap_sfr, \"utmick\", \"mainck\", NULL);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d2_pmc->chws[PMC_UTMI] = hw;\n\n\tparent_names[0] = slck_name;\n\tparent_names[1] = \"mainck\";\n\tparent_names[2] = \"plladivck\";\n\tparent_names[3] = \"utmick\";\n\thw = at91_clk_register_master_pres(regmap, \"masterck_pres\", 4,\n\t\t\t\t\t   parent_names, NULL,\n\t\t\t\t\t   &at91sam9x5_master_layout,\n\t\t\t\t\t   &mck_characteristics, &mck_lock);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\thw = at91_clk_register_master_div(regmap, \"masterck_div\",\n\t\t\t\t\t  \"masterck_pres\", NULL,\n\t\t\t\t\t  &at91sam9x5_master_layout,\n\t\t\t\t\t  &mck_characteristics, &mck_lock,\n\t\t\t\t\t  CLK_SET_RATE_GATE, 0);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d2_pmc->chws[PMC_MCK] = hw;\n\n\thw = at91_clk_register_h32mx(regmap, \"h32mxck\", \"masterck_div\");\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d2_pmc->chws[PMC_MCK2] = hw;\n\n\tparent_names[0] = \"plladivck\";\n\tparent_names[1] = \"utmick\";\n\thw = at91sam9x5_clk_register_usb(regmap, \"usbck\", parent_names, 2);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tparent_names[0] = slck_name;\n\tparent_names[1] = \"mainck\";\n\tparent_names[2] = \"plladivck\";\n\tparent_names[3] = \"utmick\";\n\tparent_names[4] = \"masterck_div\";\n\tparent_names[5] = \"audiopll_pmcck\";\n\tfor (i = 0; i < 3; i++) {\n\t\tchar name[6];\n\n\t\tsnprintf(name, sizeof(name), \"prog%d\", i);\n\n\t\thw = at91_clk_register_programmable(regmap, name,\n\t\t\t\t\t\t    parent_names, NULL, 6, i,\n\t\t\t\t\t\t    &sama5d2_programmable_layout,\n\t\t\t\t\t\t    NULL);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d2_pmc->pchws[i] = hw;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(sama5d2_systemck); i++) {\n\t\thw = at91_clk_register_system(regmap, sama5d2_systemck[i].n,\n\t\t\t\t\t      sama5d2_systemck[i].p, NULL,\n\t\t\t\t\t      sama5d2_systemck[i].id,\n\t\t\t\t\t      sama5d2_systemck[i].flags);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d2_pmc->shws[sama5d2_systemck[i].id] = hw;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(sama5d2_periphck); i++) {\n\t\thw = at91_clk_register_sam9x5_peripheral(regmap, &pmc_pcr_lock,\n\t\t\t\t\t\t\t &sama5d2_pcr_layout,\n\t\t\t\t\t\t\t sama5d2_periphck[i].n,\n\t\t\t\t\t\t\t \"masterck_div\", NULL,\n\t\t\t\t\t\t\t sama5d2_periphck[i].id,\n\t\t\t\t\t\t\t &range, INT_MIN,\n\t\t\t\t\t\t\t sama5d2_periphck[i].flags);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d2_pmc->phws[sama5d2_periphck[i].id] = hw;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(sama5d2_periph32ck); i++) {\n\t\thw = at91_clk_register_sam9x5_peripheral(regmap, &pmc_pcr_lock,\n\t\t\t\t\t\t\t &sama5d2_pcr_layout,\n\t\t\t\t\t\t\t sama5d2_periph32ck[i].n,\n\t\t\t\t\t\t\t \"h32mxck\", NULL,\n\t\t\t\t\t\t\t sama5d2_periph32ck[i].id,\n\t\t\t\t\t\t\t &sama5d2_periph32ck[i].r,\n\t\t\t\t\t\t\t INT_MIN, 0);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d2_pmc->phws[sama5d2_periph32ck[i].id] = hw;\n\t}\n\n\tparent_names[0] = slck_name;\n\tparent_names[1] = \"mainck\";\n\tparent_names[2] = \"plladivck\";\n\tparent_names[3] = \"utmick\";\n\tparent_names[4] = \"masterck_div\";\n\tparent_names[5] = \"audiopll_pmcck\";\n\tfor (i = 0; i < ARRAY_SIZE(sama5d2_gck); i++) {\n\t\thw = at91_clk_register_generated(regmap, &pmc_pcr_lock,\n\t\t\t\t\t\t &sama5d2_pcr_layout,\n\t\t\t\t\t\t sama5d2_gck[i].n,\n\t\t\t\t\t\t parent_names, NULL, NULL, 6,\n\t\t\t\t\t\t sama5d2_gck[i].id,\n\t\t\t\t\t\t &sama5d2_gck[i].r,\n\t\t\t\t\t\t sama5d2_gck[i].chg_pid);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d2_pmc->ghws[sama5d2_gck[i].id] = hw;\n\t}\n\n\tif (regmap_sfr) {\n\t\tparent_names[0] = \"i2s0_clk\";\n\t\tparent_names[1] = \"i2s0_gclk\";\n\t\thw = at91_clk_i2s_mux_register(regmap_sfr, \"i2s0_muxclk\",\n\t\t\t\t\t       parent_names, 2, 0);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d2_pmc->chws[PMC_I2S0_MUX] = hw;\n\n\t\tparent_names[0] = \"i2s1_clk\";\n\t\tparent_names[1] = \"i2s1_gclk\";\n\t\thw = at91_clk_i2s_mux_register(regmap_sfr, \"i2s1_muxclk\",\n\t\t\t\t\t       parent_names, 2, 1);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d2_pmc->chws[PMC_I2S1_MUX] = hw;\n\t}\n\n\tof_clk_add_hw_provider(np, of_clk_hw_pmc_get, sama5d2_pmc);\n\n\treturn;\n\nerr_free:\n\tkfree(sama5d2_pmc);\n}\n\nCLK_OF_DECLARE(sama5d2_pmc, \"atmel,sama5d2-pmc\", sama5d2_pmc_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}