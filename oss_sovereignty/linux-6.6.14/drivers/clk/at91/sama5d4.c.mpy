{
  "module_name": "sama5d4.c",
  "hash_id": "a73faef707e0de30feb3621fe2854a86abc3bd3420e9d05be460adbd9faeed88",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/at91/sama5d4.c",
  "human_readable_source": "\n#include <linux/clk-provider.h>\n#include <linux/mfd/syscon.h>\n#include <linux/slab.h>\n\n#include <dt-bindings/clock/at91.h>\n\n#include \"pmc.h\"\n\nstatic DEFINE_SPINLOCK(mck_lock);\n\nstatic const struct clk_master_characteristics mck_characteristics = {\n\t.output = { .min = 125000000, .max = 200000000 },\n\t.divisors = { 1, 2, 4, 3 },\n};\n\nstatic u8 plla_out[] = { 0 };\n\nstatic u16 plla_icpll[] = { 0 };\n\nstatic const struct clk_range plla_outputs[] = {\n\t{ .min = 600000000, .max = 1200000000 },\n};\n\nstatic const struct clk_pll_characteristics plla_characteristics = {\n\t.input = { .min = 12000000, .max = 12000000 },\n\t.num_output = ARRAY_SIZE(plla_outputs),\n\t.output = plla_outputs,\n\t.icpll = plla_icpll,\n\t.out = plla_out,\n};\n\nstatic const struct clk_pcr_layout sama5d4_pcr_layout = {\n\t.offset = 0x10c,\n\t.cmd = BIT(12),\n\t.pid_mask = GENMASK(6, 0),\n};\n\nstatic const struct {\n\tchar *n;\n\tchar *p;\n\tunsigned long flags;\n\tu8 id;\n} sama5d4_systemck[] = {\n\t \n\t{ .n = \"ddrck\", .p = \"masterck_div\", .id = 2, .flags = CLK_IS_CRITICAL },\n\t{ .n = \"lcdck\", .p = \"masterck_div\", .id = 3 },\n\t{ .n = \"smdck\", .p = \"smdclk\",       .id = 4 },\n\t{ .n = \"uhpck\", .p = \"usbck\",        .id = 6 },\n\t{ .n = \"udpck\", .p = \"usbck\",        .id = 7 },\n\t{ .n = \"pck0\",  .p = \"prog0\",        .id = 8 },\n\t{ .n = \"pck1\",  .p = \"prog1\",        .id = 9 },\n\t{ .n = \"pck2\",  .p = \"prog2\",        .id = 10 },\n};\n\nstatic const struct {\n\tchar *n;\n\tu8 id;\n} sama5d4_periph32ck[] = {\n\t{ .n = \"pioD_clk\", .id = 5 },\n\t{ .n = \"usart0_clk\", .id = 6 },\n\t{ .n = \"usart1_clk\", .id = 7 },\n\t{ .n = \"icm_clk\", .id = 9 },\n\t{ .n = \"aes_clk\", .id = 12 },\n\t{ .n = \"tdes_clk\", .id = 14 },\n\t{ .n = \"sha_clk\", .id = 15 },\n\t{ .n = \"matrix1_clk\", .id = 17 },\n\t{ .n = \"hsmc_clk\", .id = 22 },\n\t{ .n = \"pioA_clk\", .id = 23 },\n\t{ .n = \"pioB_clk\", .id = 24 },\n\t{ .n = \"pioC_clk\", .id = 25 },\n\t{ .n = \"pioE_clk\", .id = 26 },\n\t{ .n = \"uart0_clk\", .id = 27 },\n\t{ .n = \"uart1_clk\", .id = 28 },\n\t{ .n = \"usart2_clk\", .id = 29 },\n\t{ .n = \"usart3_clk\", .id = 30 },\n\t{ .n = \"usart4_clk\", .id = 31 },\n\t{ .n = \"twi0_clk\", .id = 32 },\n\t{ .n = \"twi1_clk\", .id = 33 },\n\t{ .n = \"twi2_clk\", .id = 34 },\n\t{ .n = \"mci0_clk\", .id = 35 },\n\t{ .n = \"mci1_clk\", .id = 36 },\n\t{ .n = \"spi0_clk\", .id = 37 },\n\t{ .n = \"spi1_clk\", .id = 38 },\n\t{ .n = \"spi2_clk\", .id = 39 },\n\t{ .n = \"tcb0_clk\", .id = 40 },\n\t{ .n = \"tcb1_clk\", .id = 41 },\n\t{ .n = \"tcb2_clk\", .id = 42 },\n\t{ .n = \"pwm_clk\", .id = 43 },\n\t{ .n = \"adc_clk\", .id = 44 },\n\t{ .n = \"dbgu_clk\", .id = 45 },\n\t{ .n = \"uhphs_clk\", .id = 46 },\n\t{ .n = \"udphs_clk\", .id = 47 },\n\t{ .n = \"ssc0_clk\", .id = 48 },\n\t{ .n = \"ssc1_clk\", .id = 49 },\n\t{ .n = \"trng_clk\", .id = 53 },\n\t{ .n = \"macb0_clk\", .id = 54 },\n\t{ .n = \"macb1_clk\", .id = 55 },\n\t{ .n = \"fuse_clk\", .id = 57 },\n\t{ .n = \"securam_clk\", .id = 59 },\n\t{ .n = \"smd_clk\", .id = 61 },\n\t{ .n = \"twi3_clk\", .id = 62 },\n\t{ .n = \"catb_clk\", .id = 63 },\n};\n\nstatic const struct {\n\tchar *n;\n\tunsigned long flags;\n\tu8 id;\n} sama5d4_periphck[] = {\n\t{ .n = \"dma0_clk\", .id = 8 },\n\t{ .n = \"cpkcc_clk\", .id = 10 },\n\t{ .n = \"aesb_clk\", .id = 13 },\n\t \n\t{ .n = \"mpddr_clk\", .id = 16, .flags = CLK_IS_CRITICAL },\n\t{ .n = \"matrix0_clk\", .id = 18 },\n\t{ .n = \"vdec_clk\", .id = 19 },\n\t{ .n = \"dma1_clk\", .id = 50 },\n\t{ .n = \"lcdc_clk\", .id = 51 },\n\t{ .n = \"isi_clk\", .id = 52 },\n};\n\nstatic void __init sama5d4_pmc_setup(struct device_node *np)\n{\n\tstruct clk_range range = CLK_RANGE(0, 0);\n\tconst char *slck_name, *mainxtal_name;\n\tstruct pmc_data *sama5d4_pmc;\n\tconst char *parent_names[5];\n\tstruct regmap *regmap;\n\tstruct clk_hw *hw;\n\tint i;\n\tbool bypass;\n\n\ti = of_property_match_string(np, \"clock-names\", \"slow_clk\");\n\tif (i < 0)\n\t\treturn;\n\n\tslck_name = of_clk_get_parent_name(np, i);\n\n\ti = of_property_match_string(np, \"clock-names\", \"main_xtal\");\n\tif (i < 0)\n\t\treturn;\n\tmainxtal_name = of_clk_get_parent_name(np, i);\n\n\tregmap = device_node_to_regmap(np);\n\tif (IS_ERR(regmap))\n\t\treturn;\n\n\tsama5d4_pmc = pmc_data_allocate(PMC_PLLACK + 1,\n\t\t\t\t\tnck(sama5d4_systemck),\n\t\t\t\t\tnck(sama5d4_periph32ck), 0, 3);\n\tif (!sama5d4_pmc)\n\t\treturn;\n\n\thw = at91_clk_register_main_rc_osc(regmap, \"main_rc_osc\", 12000000,\n\t\t\t\t\t   100000000);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tbypass = of_property_read_bool(np, \"atmel,osc-bypass\");\n\n\thw = at91_clk_register_main_osc(regmap, \"main_osc\", mainxtal_name, NULL,\n\t\t\t\t\tbypass);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tparent_names[0] = \"main_rc_osc\";\n\tparent_names[1] = \"main_osc\";\n\thw = at91_clk_register_sam9x5_main(regmap, \"mainck\", parent_names, NULL, 2);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\thw = at91_clk_register_pll(regmap, \"pllack\", \"mainck\", 0,\n\t\t\t\t   &sama5d3_pll_layout, &plla_characteristics);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\thw = at91_clk_register_plldiv(regmap, \"plladivck\", \"pllack\");\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d4_pmc->chws[PMC_PLLACK] = hw;\n\n\thw = at91_clk_register_utmi(regmap, NULL, \"utmick\", \"mainck\", NULL);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d4_pmc->chws[PMC_UTMI] = hw;\n\n\tparent_names[0] = slck_name;\n\tparent_names[1] = \"mainck\";\n\tparent_names[2] = \"plladivck\";\n\tparent_names[3] = \"utmick\";\n\thw = at91_clk_register_master_pres(regmap, \"masterck_pres\", 4,\n\t\t\t\t\t   parent_names, NULL,\n\t\t\t\t\t   &at91sam9x5_master_layout,\n\t\t\t\t\t   &mck_characteristics, &mck_lock);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\thw = at91_clk_register_master_div(regmap, \"masterck_div\",\n\t\t\t\t\t  \"masterck_pres\", NULL,\n\t\t\t\t\t  &at91sam9x5_master_layout,\n\t\t\t\t\t  &mck_characteristics, &mck_lock,\n\t\t\t\t\t  CLK_SET_RATE_GATE, 0);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d4_pmc->chws[PMC_MCK] = hw;\n\n\thw = at91_clk_register_h32mx(regmap, \"h32mxck\", \"masterck_div\");\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tsama5d4_pmc->chws[PMC_MCK2] = hw;\n\n\tparent_names[0] = \"plladivck\";\n\tparent_names[1] = \"utmick\";\n\thw = at91sam9x5_clk_register_usb(regmap, \"usbck\", parent_names, 2);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tparent_names[0] = \"plladivck\";\n\tparent_names[1] = \"utmick\";\n\thw = at91sam9x5_clk_register_smd(regmap, \"smdclk\", parent_names, 2);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tparent_names[0] = slck_name;\n\tparent_names[1] = \"mainck\";\n\tparent_names[2] = \"plladivck\";\n\tparent_names[3] = \"utmick\";\n\tparent_names[4] = \"masterck_div\";\n\tfor (i = 0; i < 3; i++) {\n\t\tchar name[6];\n\n\t\tsnprintf(name, sizeof(name), \"prog%d\", i);\n\n\t\thw = at91_clk_register_programmable(regmap, name,\n\t\t\t\t\t\t    parent_names, NULL, 5, i,\n\t\t\t\t\t\t    &at91sam9x5_programmable_layout,\n\t\t\t\t\t\t    NULL);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d4_pmc->pchws[i] = hw;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(sama5d4_systemck); i++) {\n\t\thw = at91_clk_register_system(regmap, sama5d4_systemck[i].n,\n\t\t\t\t\t      sama5d4_systemck[i].p, NULL,\n\t\t\t\t\t      sama5d4_systemck[i].id,\n\t\t\t\t\t      sama5d4_systemck[i].flags);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d4_pmc->shws[sama5d4_systemck[i].id] = hw;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(sama5d4_periphck); i++) {\n\t\thw = at91_clk_register_sam9x5_peripheral(regmap, &pmc_pcr_lock,\n\t\t\t\t\t\t\t &sama5d4_pcr_layout,\n\t\t\t\t\t\t\t sama5d4_periphck[i].n,\n\t\t\t\t\t\t\t \"masterck_div\", NULL,\n\t\t\t\t\t\t\t sama5d4_periphck[i].id,\n\t\t\t\t\t\t\t &range, INT_MIN,\n\t\t\t\t\t\t\t sama5d4_periphck[i].flags);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d4_pmc->phws[sama5d4_periphck[i].id] = hw;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(sama5d4_periph32ck); i++) {\n\t\thw = at91_clk_register_sam9x5_peripheral(regmap, &pmc_pcr_lock,\n\t\t\t\t\t\t\t &sama5d4_pcr_layout,\n\t\t\t\t\t\t\t sama5d4_periph32ck[i].n,\n\t\t\t\t\t\t\t \"h32mxck\", NULL,\n\t\t\t\t\t\t\t sama5d4_periph32ck[i].id,\n\t\t\t\t\t\t\t &range, INT_MIN, 0);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tsama5d4_pmc->phws[sama5d4_periph32ck[i].id] = hw;\n\t}\n\n\tof_clk_add_hw_provider(np, of_clk_hw_pmc_get, sama5d4_pmc);\n\n\treturn;\n\nerr_free:\n\tkfree(sama5d4_pmc);\n}\n\nCLK_OF_DECLARE(sama5d4_pmc, \"atmel,sama5d4-pmc\", sama5d4_pmc_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}