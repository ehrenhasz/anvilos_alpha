{
  "module_name": "at91sam9260.c",
  "hash_id": "9a98f3f03ae929fe4aaaf298a33adf659db9b9b3549869b10271dc95d52a2e80",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/at91/at91sam9260.c",
  "human_readable_source": "\n#include <linux/clk-provider.h>\n#include <linux/mfd/syscon.h>\n#include <linux/slab.h>\n\n#include <dt-bindings/clock/at91.h>\n\n#include \"pmc.h\"\n\nstruct sck {\n\tchar *n;\n\tchar *p;\n\tu8 id;\n};\n\nstruct pck {\n\tchar *n;\n\tu8 id;\n};\n\nstruct at91sam926x_data {\n\tconst struct clk_pll_layout *plla_layout;\n\tconst struct clk_pll_characteristics *plla_characteristics;\n\tconst struct clk_pll_layout *pllb_layout;\n\tconst struct clk_pll_characteristics *pllb_characteristics;\n\tconst struct clk_master_characteristics *mck_characteristics;\n\tconst struct sck *sck;\n\tconst struct pck *pck;\n\tu8 num_sck;\n\tu8 num_pck;\n\tu8 num_progck;\n\tbool has_slck;\n};\n\nstatic DEFINE_SPINLOCK(at91sam9260_mck_lock);\n\nstatic const struct clk_master_characteristics sam9260_mck_characteristics = {\n\t.output = { .min = 0, .max = 105000000 },\n\t.divisors = { 1, 2, 4, 0 },\n};\n\nstatic u8 sam9260_plla_out[] = { 0, 2 };\n\nstatic u16 sam9260_plla_icpll[] = { 1, 1 };\n\nstatic const struct clk_range sam9260_plla_outputs[] = {\n\t{ .min = 80000000, .max = 160000000 },\n\t{ .min = 150000000, .max = 240000000 },\n};\n\nstatic const struct clk_pll_characteristics sam9260_plla_characteristics = {\n\t.input = { .min = 1000000, .max = 32000000 },\n\t.num_output = ARRAY_SIZE(sam9260_plla_outputs),\n\t.output = sam9260_plla_outputs,\n\t.icpll = sam9260_plla_icpll,\n\t.out = sam9260_plla_out,\n};\n\nstatic u8 sam9260_pllb_out[] = { 1 };\n\nstatic u16 sam9260_pllb_icpll[] = { 1 };\n\nstatic const struct clk_range sam9260_pllb_outputs[] = {\n\t{ .min = 70000000, .max = 130000000 },\n};\n\nstatic const struct clk_pll_characteristics sam9260_pllb_characteristics = {\n\t.input = { .min = 1000000, .max = 5000000 },\n\t.num_output = ARRAY_SIZE(sam9260_pllb_outputs),\n\t.output = sam9260_pllb_outputs,\n\t.icpll = sam9260_pllb_icpll,\n\t.out = sam9260_pllb_out,\n};\n\nstatic const struct sck at91sam9260_systemck[] = {\n\t{ .n = \"uhpck\", .p = \"usbck\",    .id = 6 },\n\t{ .n = \"udpck\", .p = \"usbck\",    .id = 7 },\n\t{ .n = \"pck0\",  .p = \"prog0\",    .id = 8 },\n\t{ .n = \"pck1\",  .p = \"prog1\",    .id = 9 },\n};\n\nstatic const struct pck at91sam9260_periphck[] = {\n\t{ .n = \"pioA_clk\",   .id = 2 },\n\t{ .n = \"pioB_clk\",   .id = 3 },\n\t{ .n = \"pioC_clk\",   .id = 4 },\n\t{ .n = \"adc_clk\",    .id = 5 },\n\t{ .n = \"usart0_clk\", .id = 6 },\n\t{ .n = \"usart1_clk\", .id = 7 },\n\t{ .n = \"usart2_clk\", .id = 8 },\n\t{ .n = \"mci0_clk\",   .id = 9 },\n\t{ .n = \"udc_clk\",    .id = 10 },\n\t{ .n = \"twi0_clk\",   .id = 11 },\n\t{ .n = \"spi0_clk\",   .id = 12 },\n\t{ .n = \"spi1_clk\",   .id = 13 },\n\t{ .n = \"ssc0_clk\",   .id = 14 },\n\t{ .n = \"tc0_clk\",    .id = 17 },\n\t{ .n = \"tc1_clk\",    .id = 18 },\n\t{ .n = \"tc2_clk\",    .id = 19 },\n\t{ .n = \"ohci_clk\",   .id = 20 },\n\t{ .n = \"macb0_clk\",  .id = 21 },\n\t{ .n = \"isi_clk\",    .id = 22 },\n\t{ .n = \"usart3_clk\", .id = 23 },\n\t{ .n = \"uart0_clk\",  .id = 24 },\n\t{ .n = \"uart1_clk\",  .id = 25 },\n\t{ .n = \"tc3_clk\",    .id = 26 },\n\t{ .n = \"tc4_clk\",    .id = 27 },\n\t{ .n = \"tc5_clk\",    .id = 28 },\n};\n\nstatic struct at91sam926x_data at91sam9260_data = {\n\t.plla_layout = &at91rm9200_pll_layout,\n\t.plla_characteristics = &sam9260_plla_characteristics,\n\t.pllb_layout = &at91rm9200_pll_layout,\n\t.pllb_characteristics = &sam9260_pllb_characteristics,\n\t.mck_characteristics = &sam9260_mck_characteristics,\n\t.sck = at91sam9260_systemck,\n\t.num_sck = ARRAY_SIZE(at91sam9260_systemck),\n\t.pck = at91sam9260_periphck,\n\t.num_pck = ARRAY_SIZE(at91sam9260_periphck),\n\t.num_progck = 2,\n\t.has_slck = true,\n};\n\nstatic const struct clk_master_characteristics sam9g20_mck_characteristics = {\n\t.output = { .min = 0, .max = 133000000 },\n\t.divisors = { 1, 2, 4, 6 },\n};\n\nstatic u8 sam9g20_plla_out[] = { 0, 1, 2, 3, 0, 1, 2, 3 };\n\nstatic u16 sam9g20_plla_icpll[] = { 0, 0, 0, 0, 1, 1, 1, 1 };\n\nstatic const struct clk_range sam9g20_plla_outputs[] = {\n\t{ .min = 745000000, .max = 800000000 },\n\t{ .min = 695000000, .max = 750000000 },\n\t{ .min = 645000000, .max = 700000000 },\n\t{ .min = 595000000, .max = 650000000 },\n\t{ .min = 545000000, .max = 600000000 },\n\t{ .min = 495000000, .max = 550000000 },\n\t{ .min = 445000000, .max = 500000000 },\n\t{ .min = 400000000, .max = 450000000 },\n};\n\nstatic const struct clk_pll_characteristics sam9g20_plla_characteristics = {\n\t.input = { .min = 2000000, .max = 32000000 },\n\t.num_output = ARRAY_SIZE(sam9g20_plla_outputs),\n\t.output = sam9g20_plla_outputs,\n\t.icpll = sam9g20_plla_icpll,\n\t.out = sam9g20_plla_out,\n};\n\nstatic u8 sam9g20_pllb_out[] = { 0 };\n\nstatic u16 sam9g20_pllb_icpll[] = { 0 };\n\nstatic const struct clk_range sam9g20_pllb_outputs[] = {\n\t{ .min = 30000000, .max = 100000000 },\n};\n\nstatic const struct clk_pll_characteristics sam9g20_pllb_characteristics = {\n\t.input = { .min = 2000000, .max = 32000000 },\n\t.num_output = ARRAY_SIZE(sam9g20_pllb_outputs),\n\t.output = sam9g20_pllb_outputs,\n\t.icpll = sam9g20_pllb_icpll,\n\t.out = sam9g20_pllb_out,\n};\n\nstatic struct at91sam926x_data at91sam9g20_data = {\n\t.plla_layout = &at91sam9g45_pll_layout,\n\t.plla_characteristics = &sam9g20_plla_characteristics,\n\t.pllb_layout = &at91sam9g20_pllb_layout,\n\t.pllb_characteristics = &sam9g20_pllb_characteristics,\n\t.mck_characteristics = &sam9g20_mck_characteristics,\n\t.sck = at91sam9260_systemck,\n\t.num_sck = ARRAY_SIZE(at91sam9260_systemck),\n\t.pck = at91sam9260_periphck,\n\t.num_pck = ARRAY_SIZE(at91sam9260_periphck),\n\t.num_progck = 2,\n\t.has_slck = true,\n};\n\nstatic const struct clk_master_characteristics sam9261_mck_characteristics = {\n\t.output = { .min = 0, .max = 94000000 },\n\t.divisors = { 1, 2, 4, 0 },\n};\n\nstatic const struct clk_range sam9261_plla_outputs[] = {\n\t{ .min = 80000000, .max = 200000000 },\n\t{ .min = 190000000, .max = 240000000 },\n};\n\nstatic const struct clk_pll_characteristics sam9261_plla_characteristics = {\n\t.input = { .min = 1000000, .max = 32000000 },\n\t.num_output = ARRAY_SIZE(sam9261_plla_outputs),\n\t.output = sam9261_plla_outputs,\n\t.icpll = sam9260_plla_icpll,\n\t.out = sam9260_plla_out,\n};\n\nstatic u8 sam9261_pllb_out[] = { 1 };\n\nstatic u16 sam9261_pllb_icpll[] = { 1 };\n\nstatic const struct clk_range sam9261_pllb_outputs[] = {\n\t{ .min = 70000000, .max = 130000000 },\n};\n\nstatic const struct clk_pll_characteristics sam9261_pllb_characteristics = {\n\t.input = { .min = 1000000, .max = 5000000 },\n\t.num_output = ARRAY_SIZE(sam9261_pllb_outputs),\n\t.output = sam9261_pllb_outputs,\n\t.icpll = sam9261_pllb_icpll,\n\t.out = sam9261_pllb_out,\n};\n\nstatic const struct sck at91sam9261_systemck[] = {\n\t{ .n = \"uhpck\", .p = \"usbck\",    .id = 6 },\n\t{ .n = \"udpck\", .p = \"usbck\",    .id = 7 },\n\t{ .n = \"pck0\",  .p = \"prog0\",    .id = 8 },\n\t{ .n = \"pck1\",  .p = \"prog1\",    .id = 9 },\n\t{ .n = \"pck2\",  .p = \"prog2\",    .id = 10 },\n\t{ .n = \"pck3\",  .p = \"prog3\",    .id = 11 },\n\t{ .n = \"hclk0\", .p = \"masterck_div\", .id = 16 },\n\t{ .n = \"hclk1\", .p = \"masterck_div\", .id = 17 },\n};\n\nstatic const struct pck at91sam9261_periphck[] = {\n\t{ .n = \"pioA_clk\",   .id = 2, },\n\t{ .n = \"pioB_clk\",   .id = 3, },\n\t{ .n = \"pioC_clk\",   .id = 4, },\n\t{ .n = \"usart0_clk\", .id = 6, },\n\t{ .n = \"usart1_clk\", .id = 7, },\n\t{ .n = \"usart2_clk\", .id = 8, },\n\t{ .n = \"mci0_clk\",   .id = 9, },\n\t{ .n = \"udc_clk\",    .id = 10, },\n\t{ .n = \"twi0_clk\",   .id = 11, },\n\t{ .n = \"spi0_clk\",   .id = 12, },\n\t{ .n = \"spi1_clk\",   .id = 13, },\n\t{ .n = \"ssc0_clk\",   .id = 14, },\n\t{ .n = \"ssc1_clk\",   .id = 15, },\n\t{ .n = \"ssc2_clk\",   .id = 16, },\n\t{ .n = \"tc0_clk\",    .id = 17, },\n\t{ .n = \"tc1_clk\",    .id = 18, },\n\t{ .n = \"tc2_clk\",    .id = 19, },\n\t{ .n = \"ohci_clk\",   .id = 20, },\n\t{ .n = \"lcd_clk\",    .id = 21, },\n};\n\nstatic struct at91sam926x_data at91sam9261_data = {\n\t.plla_layout = &at91rm9200_pll_layout,\n\t.plla_characteristics = &sam9261_plla_characteristics,\n\t.pllb_layout = &at91rm9200_pll_layout,\n\t.pllb_characteristics = &sam9261_pllb_characteristics,\n\t.mck_characteristics = &sam9261_mck_characteristics,\n\t.sck = at91sam9261_systemck,\n\t.num_sck = ARRAY_SIZE(at91sam9261_systemck),\n\t.pck = at91sam9261_periphck,\n\t.num_pck = ARRAY_SIZE(at91sam9261_periphck),\n\t.num_progck = 4,\n};\n\nstatic const struct clk_master_characteristics sam9263_mck_characteristics = {\n\t.output = { .min = 0, .max = 120000000 },\n\t.divisors = { 1, 2, 4, 0 },\n};\n\nstatic const struct clk_range sam9263_pll_outputs[] = {\n\t{ .min = 80000000, .max = 200000000 },\n\t{ .min = 190000000, .max = 240000000 },\n};\n\nstatic const struct clk_pll_characteristics sam9263_pll_characteristics = {\n\t.input = { .min = 1000000, .max = 32000000 },\n\t.num_output = ARRAY_SIZE(sam9263_pll_outputs),\n\t.output = sam9263_pll_outputs,\n\t.icpll = sam9260_plla_icpll,\n\t.out = sam9260_plla_out,\n};\n\nstatic const struct sck at91sam9263_systemck[] = {\n\t{ .n = \"uhpck\", .p = \"usbck\",    .id = 6 },\n\t{ .n = \"udpck\", .p = \"usbck\",    .id = 7 },\n\t{ .n = \"pck0\",  .p = \"prog0\",    .id = 8 },\n\t{ .n = \"pck1\",  .p = \"prog1\",    .id = 9 },\n\t{ .n = \"pck2\",  .p = \"prog2\",    .id = 10 },\n\t{ .n = \"pck3\",  .p = \"prog3\",    .id = 11 },\n};\n\nstatic const struct pck at91sam9263_periphck[] = {\n\t{ .n = \"pioA_clk\",   .id = 2, },\n\t{ .n = \"pioB_clk\",   .id = 3, },\n\t{ .n = \"pioCDE_clk\", .id = 4, },\n\t{ .n = \"usart0_clk\", .id = 7, },\n\t{ .n = \"usart1_clk\", .id = 8, },\n\t{ .n = \"usart2_clk\", .id = 9, },\n\t{ .n = \"mci0_clk\",   .id = 10, },\n\t{ .n = \"mci1_clk\",   .id = 11, },\n\t{ .n = \"can_clk\",    .id = 12, },\n\t{ .n = \"twi0_clk\",   .id = 13, },\n\t{ .n = \"spi0_clk\",   .id = 14, },\n\t{ .n = \"spi1_clk\",   .id = 15, },\n\t{ .n = \"ssc0_clk\",   .id = 16, },\n\t{ .n = \"ssc1_clk\",   .id = 17, },\n\t{ .n = \"ac97_clk\",   .id = 18, },\n\t{ .n = \"tcb_clk\",    .id = 19, },\n\t{ .n = \"pwm_clk\",    .id = 20, },\n\t{ .n = \"macb0_clk\",  .id = 21, },\n\t{ .n = \"g2de_clk\",   .id = 23, },\n\t{ .n = \"udc_clk\",    .id = 24, },\n\t{ .n = \"isi_clk\",    .id = 25, },\n\t{ .n = \"lcd_clk\",    .id = 26, },\n\t{ .n = \"dma_clk\",    .id = 27, },\n\t{ .n = \"ohci_clk\",   .id = 29, },\n};\n\nstatic struct at91sam926x_data at91sam9263_data = {\n\t.plla_layout = &at91rm9200_pll_layout,\n\t.plla_characteristics = &sam9263_pll_characteristics,\n\t.pllb_layout = &at91rm9200_pll_layout,\n\t.pllb_characteristics = &sam9263_pll_characteristics,\n\t.mck_characteristics = &sam9263_mck_characteristics,\n\t.sck = at91sam9263_systemck,\n\t.num_sck = ARRAY_SIZE(at91sam9263_systemck),\n\t.pck = at91sam9263_periphck,\n\t.num_pck = ARRAY_SIZE(at91sam9263_periphck),\n\t.num_progck = 4,\n};\n\nstatic void __init at91sam926x_pmc_setup(struct device_node *np,\n\t\t\t\t\t struct at91sam926x_data *data)\n{\n\tconst char *slowxtal_name, *mainxtal_name;\n\tstruct pmc_data *at91sam9260_pmc;\n\tu32 usb_div[] = { 1, 2, 4, 0 };\n\tconst char *parent_names[6];\n\tconst char *slck_name;\n\tstruct regmap *regmap;\n\tstruct clk_hw *hw;\n\tint i;\n\tbool bypass;\n\n\ti = of_property_match_string(np, \"clock-names\", \"slow_xtal\");\n\tif (i < 0)\n\t\treturn;\n\n\tslowxtal_name = of_clk_get_parent_name(np, i);\n\n\ti = of_property_match_string(np, \"clock-names\", \"main_xtal\");\n\tif (i < 0)\n\t\treturn;\n\tmainxtal_name = of_clk_get_parent_name(np, i);\n\n\tregmap = device_node_to_regmap(np);\n\tif (IS_ERR(regmap))\n\t\treturn;\n\n\tat91sam9260_pmc = pmc_data_allocate(PMC_PLLBCK + 1,\n\t\t\t\t\t    ndck(data->sck, data->num_sck),\n\t\t\t\t\t    ndck(data->pck, data->num_pck),\n\t\t\t\t\t    0, data->num_progck);\n\tif (!at91sam9260_pmc)\n\t\treturn;\n\n\tbypass = of_property_read_bool(np, \"atmel,osc-bypass\");\n\n\thw = at91_clk_register_main_osc(regmap, \"main_osc\", mainxtal_name, NULL,\n\t\t\t\t\tbypass);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\thw = at91_clk_register_rm9200_main(regmap, \"mainck\", \"main_osc\", NULL);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tat91sam9260_pmc->chws[PMC_MAIN] = hw;\n\n\tif (data->has_slck) {\n\t\thw = clk_hw_register_fixed_rate_with_accuracy(NULL,\n\t\t\t\t\t\t\t      \"slow_rc_osc\",\n\t\t\t\t\t\t\t      NULL, 0, 32768,\n\t\t\t\t\t\t\t      50000000);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tparent_names[0] = \"slow_rc_osc\";\n\t\tparent_names[1] = \"slow_xtal\";\n\t\thw = at91_clk_register_sam9260_slow(regmap, \"slck\",\n\t\t\t\t\t\t    parent_names, 2);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tat91sam9260_pmc->chws[PMC_SLOW] = hw;\n\t\tslck_name = \"slck\";\n\t} else {\n\t\tslck_name = slowxtal_name;\n\t}\n\n\thw = at91_clk_register_pll(regmap, \"pllack\", \"mainck\", 0,\n\t\t\t\t   data->plla_layout,\n\t\t\t\t   data->plla_characteristics);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tat91sam9260_pmc->chws[PMC_PLLACK] = hw;\n\n\thw = at91_clk_register_pll(regmap, \"pllbck\", \"mainck\", 1,\n\t\t\t\t   data->pllb_layout,\n\t\t\t\t   data->pllb_characteristics);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tat91sam9260_pmc->chws[PMC_PLLBCK] = hw;\n\n\tparent_names[0] = slck_name;\n\tparent_names[1] = \"mainck\";\n\tparent_names[2] = \"pllack\";\n\tparent_names[3] = \"pllbck\";\n\thw = at91_clk_register_master_pres(regmap, \"masterck_pres\", 4,\n\t\t\t\t\t   parent_names, NULL,\n\t\t\t\t\t   &at91rm9200_master_layout,\n\t\t\t\t\t   data->mck_characteristics,\n\t\t\t\t\t   &at91sam9260_mck_lock);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\thw = at91_clk_register_master_div(regmap, \"masterck_div\",\n\t\t\t\t\t  \"masterck_pres\", NULL,\n\t\t\t\t\t  &at91rm9200_master_layout,\n\t\t\t\t\t  data->mck_characteristics,\n\t\t\t\t\t  &at91sam9260_mck_lock,\n\t\t\t\t\t  CLK_SET_RATE_GATE, 0);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tat91sam9260_pmc->chws[PMC_MCK] = hw;\n\n\thw = at91rm9200_clk_register_usb(regmap, \"usbck\", \"pllbck\", usb_div);\n\tif (IS_ERR(hw))\n\t\tgoto err_free;\n\n\tparent_names[0] = slck_name;\n\tparent_names[1] = \"mainck\";\n\tparent_names[2] = \"pllack\";\n\tparent_names[3] = \"pllbck\";\n\tfor (i = 0; i < data->num_progck; i++) {\n\t\tchar name[6];\n\n\t\tsnprintf(name, sizeof(name), \"prog%d\", i);\n\n\t\thw = at91_clk_register_programmable(regmap, name,\n\t\t\t\t\t\t    parent_names, NULL, 4, i,\n\t\t\t\t\t\t    &at91rm9200_programmable_layout,\n\t\t\t\t\t\t    NULL);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tat91sam9260_pmc->pchws[i] = hw;\n\t}\n\n\tfor (i = 0; i < data->num_sck; i++) {\n\t\thw = at91_clk_register_system(regmap, data->sck[i].n,\n\t\t\t\t\t      data->sck[i].p, NULL,\n\t\t\t\t\t      data->sck[i].id, 0);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tat91sam9260_pmc->shws[data->sck[i].id] = hw;\n\t}\n\n\tfor (i = 0; i < data->num_pck; i++) {\n\t\thw = at91_clk_register_peripheral(regmap,\n\t\t\t\t\t\t  data->pck[i].n,\n\t\t\t\t\t\t  \"masterck_div\", NULL,\n\t\t\t\t\t\t  data->pck[i].id);\n\t\tif (IS_ERR(hw))\n\t\t\tgoto err_free;\n\n\t\tat91sam9260_pmc->phws[data->pck[i].id] = hw;\n\t}\n\n\tof_clk_add_hw_provider(np, of_clk_hw_pmc_get, at91sam9260_pmc);\n\n\treturn;\n\nerr_free:\n\tkfree(at91sam9260_pmc);\n}\n\nstatic void __init at91sam9260_pmc_setup(struct device_node *np)\n{\n\tat91sam926x_pmc_setup(np, &at91sam9260_data);\n}\n\nCLK_OF_DECLARE(at91sam9260_pmc, \"atmel,at91sam9260-pmc\", at91sam9260_pmc_setup);\n\nstatic void __init at91sam9261_pmc_setup(struct device_node *np)\n{\n\tat91sam926x_pmc_setup(np, &at91sam9261_data);\n}\n\nCLK_OF_DECLARE(at91sam9261_pmc, \"atmel,at91sam9261-pmc\", at91sam9261_pmc_setup);\n\nstatic void __init at91sam9263_pmc_setup(struct device_node *np)\n{\n\tat91sam926x_pmc_setup(np, &at91sam9263_data);\n}\n\nCLK_OF_DECLARE(at91sam9263_pmc, \"atmel,at91sam9263-pmc\", at91sam9263_pmc_setup);\n\nstatic void __init at91sam9g20_pmc_setup(struct device_node *np)\n{\n\tat91sam926x_pmc_setup(np, &at91sam9g20_data);\n}\n\nCLK_OF_DECLARE(at91sam9g20_pmc, \"atmel,at91sam9g20-pmc\", at91sam9g20_pmc_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}