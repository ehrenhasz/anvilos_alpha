{
  "module_name": "clk-plldiv.c",
  "hash_id": "2c0e784aef6876a950e73ece16cddd6b6ceef762e76d115c6f9bf3e472b74407",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/at91/clk-plldiv.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/clkdev.h>\n#include <linux/clk/at91_pmc.h>\n#include <linux/of.h>\n#include <linux/mfd/syscon.h>\n#include <linux/regmap.h>\n\n#include \"pmc.h\"\n\n#define to_clk_plldiv(hw) container_of(hw, struct clk_plldiv, hw)\n\nstruct clk_plldiv {\n\tstruct clk_hw hw;\n\tstruct regmap *regmap;\n};\n\nstatic unsigned long clk_plldiv_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t    unsigned long parent_rate)\n{\n\tstruct clk_plldiv *plldiv = to_clk_plldiv(hw);\n\tunsigned int mckr;\n\n\tregmap_read(plldiv->regmap, AT91_PMC_MCKR, &mckr);\n\n\tif (mckr & AT91_PMC_PLLADIV2)\n\t\treturn parent_rate / 2;\n\n\treturn parent_rate;\n}\n\nstatic long clk_plldiv_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t\tunsigned long *parent_rate)\n{\n\tunsigned long div;\n\n\tif (rate > *parent_rate)\n\t\treturn *parent_rate;\n\tdiv = *parent_rate / 2;\n\tif (rate < div)\n\t\treturn div;\n\n\tif (rate - div < *parent_rate - rate)\n\t\treturn div;\n\n\treturn *parent_rate;\n}\n\nstatic int clk_plldiv_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t       unsigned long parent_rate)\n{\n\tstruct clk_plldiv *plldiv = to_clk_plldiv(hw);\n\n\tif ((parent_rate != rate) && (parent_rate / 2 != rate))\n\t\treturn -EINVAL;\n\n\tregmap_update_bits(plldiv->regmap, AT91_PMC_MCKR, AT91_PMC_PLLADIV2,\n\t\t\t   parent_rate != rate ? AT91_PMC_PLLADIV2 : 0);\n\n\treturn 0;\n}\n\nstatic const struct clk_ops plldiv_ops = {\n\t.recalc_rate = clk_plldiv_recalc_rate,\n\t.round_rate = clk_plldiv_round_rate,\n\t.set_rate = clk_plldiv_set_rate,\n};\n\nstruct clk_hw * __init\nat91_clk_register_plldiv(struct regmap *regmap, const char *name,\n\t\t\t const char *parent_name)\n{\n\tstruct clk_plldiv *plldiv;\n\tstruct clk_hw *hw;\n\tstruct clk_init_data init;\n\tint ret;\n\n\tplldiv = kzalloc(sizeof(*plldiv), GFP_KERNEL);\n\tif (!plldiv)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit.name = name;\n\tinit.ops = &plldiv_ops;\n\tinit.parent_names = parent_name ? &parent_name : NULL;\n\tinit.num_parents = parent_name ? 1 : 0;\n\tinit.flags = CLK_SET_RATE_GATE;\n\n\tplldiv->hw.init = &init;\n\tplldiv->regmap = regmap;\n\n\thw = &plldiv->hw;\n\tret = clk_hw_register(NULL, &plldiv->hw);\n\tif (ret) {\n\t\tkfree(plldiv);\n\t\thw = ERR_PTR(ret);\n\t}\n\n\treturn hw;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}