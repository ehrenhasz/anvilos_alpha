{
  "module_name": "clk-i2s-mux.c",
  "hash_id": "a1fbca5dec8d3d1c15f3694ca361f207d4ce5f24882a9d9455f02933a6cbad70",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/at91/clk-i2s-mux.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/of.h>\n#include <linux/mfd/syscon.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\n#include <soc/at91/atmel-sfr.h>\n\n#include \"pmc.h\"\n\nstruct clk_i2s_mux {\n\tstruct clk_hw hw;\n\tstruct regmap *regmap;\n\tu8 bus_id;\n};\n\n#define to_clk_i2s_mux(hw) container_of(hw, struct clk_i2s_mux, hw)\n\nstatic u8 clk_i2s_mux_get_parent(struct clk_hw *hw)\n{\n\tstruct clk_i2s_mux *mux = to_clk_i2s_mux(hw);\n\tu32 val;\n\n\tregmap_read(mux->regmap, AT91_SFR_I2SCLKSEL, &val);\n\n\treturn (val & BIT(mux->bus_id)) >> mux->bus_id;\n}\n\nstatic int clk_i2s_mux_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct clk_i2s_mux *mux = to_clk_i2s_mux(hw);\n\n\treturn regmap_update_bits(mux->regmap, AT91_SFR_I2SCLKSEL,\n\t\t\t\t  BIT(mux->bus_id), index << mux->bus_id);\n}\n\nstatic const struct clk_ops clk_i2s_mux_ops = {\n\t.get_parent = clk_i2s_mux_get_parent,\n\t.set_parent = clk_i2s_mux_set_parent,\n\t.determine_rate = __clk_mux_determine_rate,\n};\n\nstruct clk_hw * __init\nat91_clk_i2s_mux_register(struct regmap *regmap, const char *name,\n\t\t\t  const char * const *parent_names,\n\t\t\t  unsigned int num_parents, u8 bus_id)\n{\n\tstruct clk_init_data init = {};\n\tstruct clk_i2s_mux *i2s_ck;\n\tint ret;\n\n\ti2s_ck = kzalloc(sizeof(*i2s_ck), GFP_KERNEL);\n\tif (!i2s_ck)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit.name = name;\n\tinit.ops = &clk_i2s_mux_ops;\n\tinit.parent_names = parent_names;\n\tinit.num_parents = num_parents;\n\n\ti2s_ck->hw.init = &init;\n\ti2s_ck->bus_id = bus_id;\n\ti2s_ck->regmap = regmap;\n\n\tret = clk_hw_register(NULL, &i2s_ck->hw);\n\tif (ret) {\n\t\tkfree(i2s_ck);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn &i2s_ck->hw;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}