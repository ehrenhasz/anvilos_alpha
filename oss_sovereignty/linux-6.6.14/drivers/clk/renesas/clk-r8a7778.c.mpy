{
  "module_name": "clk-r8a7778.c",
  "hash_id": "f9e55fe46fcfa58f31e5a21a503f08552978cc67cc3d12c9b334f584852c0d00",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/renesas/clk-r8a7778.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/clk/renesas.h>\n#include <linux/of_address.h>\n#include <linux/slab.h>\n#include <linux/soc/renesas/rcar-rst.h>\n\n \nstatic const struct {\n\tunsigned long plla_mult;\n\tunsigned long pllb_mult;\n} r8a7778_rates[] __initconst = {\n\t[0] = { 21, 21 },\n\t[1] = { 24, 24 },\n\t[2] = { 28, 28 },\n\t[3] = { 32, 32 },\n\t[5] = { 24, 21 },\n\t[6] = { 28, 21 },\n\t[7] = { 32, 24 },\n};\n\n \nstatic const struct {\n\tconst char *name;\n\tunsigned int div[4];\n} r8a7778_divs[6] __initconst = {\n\t{ \"b\",   { 12, 12, 16, 18 } },\n\t{ \"out\", { 12, 12, 16, 18 } },\n\t{ \"p\",   { 16, 12, 16, 12 } },\n\t{ \"s\",   { 4,  3,  4,  3  } },\n\t{ \"s1\",  { 8,  6,  8,  6  } },\n};\n\nstatic u32 cpg_mode_rates __initdata;\nstatic u32 cpg_mode_divs __initdata;\n\nstatic struct clk * __init\nr8a7778_cpg_register_clock(struct device_node *np, const char *name)\n{\n\tif (!strcmp(name, \"plla\")) {\n\t\treturn clk_register_fixed_factor(NULL, \"plla\",\n\t\t\tof_clk_get_parent_name(np, 0), 0,\n\t\t\tr8a7778_rates[cpg_mode_rates].plla_mult, 1);\n\t} else if (!strcmp(name, \"pllb\")) {\n\t\treturn clk_register_fixed_factor(NULL, \"pllb\",\n\t\t\tof_clk_get_parent_name(np, 0), 0,\n\t\t\tr8a7778_rates[cpg_mode_rates].pllb_mult, 1);\n\t} else {\n\t\tunsigned int i;\n\n\t\tfor (i = 0; i < ARRAY_SIZE(r8a7778_divs); i++) {\n\t\t\tif (!strcmp(name, r8a7778_divs[i].name)) {\n\t\t\t\treturn clk_register_fixed_factor(NULL,\n\t\t\t\t\tr8a7778_divs[i].name,\n\t\t\t\t\t\"plla\", 0, 1,\n\t\t\t\t\tr8a7778_divs[i].div[cpg_mode_divs]);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn ERR_PTR(-EINVAL);\n}\n\n\nstatic void __init r8a7778_cpg_clocks_init(struct device_node *np)\n{\n\tstruct clk_onecell_data *data;\n\tstruct clk **clks;\n\tunsigned int i;\n\tint num_clks;\n\tu32 mode;\n\n\tif (rcar_rst_read_mode_pins(&mode))\n\t\treturn;\n\n\tBUG_ON(!(mode & BIT(19)));\n\n\tcpg_mode_rates = (!!(mode & BIT(18)) << 2) |\n\t\t\t (!!(mode & BIT(12)) << 1) |\n\t\t\t (!!(mode & BIT(11)));\n\tcpg_mode_divs = (!!(mode & BIT(2)) << 1) |\n\t\t\t(!!(mode & BIT(1)));\n\n\tnum_clks = of_property_count_strings(np, \"clock-output-names\");\n\tif (num_clks < 0) {\n\t\tpr_err(\"%s: failed to count clocks\\n\", __func__);\n\t\treturn;\n\t}\n\n\tdata = kzalloc(sizeof(*data), GFP_KERNEL);\n\tclks = kcalloc(num_clks, sizeof(*clks), GFP_KERNEL);\n\tif (data == NULL || clks == NULL) {\n\t\t \n\t\treturn;\n\t}\n\n\tdata->clks = clks;\n\tdata->clk_num = num_clks;\n\n\tfor (i = 0; i < num_clks; ++i) {\n\t\tconst char *name;\n\t\tstruct clk *clk;\n\n\t\tof_property_read_string_index(np, \"clock-output-names\", i,\n\t\t\t\t\t      &name);\n\n\t\tclk = r8a7778_cpg_register_clock(np, name);\n\t\tif (IS_ERR(clk))\n\t\t\tpr_err(\"%s: failed to register %pOFn %s clock (%ld)\\n\",\n\t\t\t       __func__, np, name, PTR_ERR(clk));\n\t\telse\n\t\t\tdata->clks[i] = clk;\n\t}\n\n\tof_clk_add_provider(np, of_clk_src_onecell_get, data);\n\n\tcpg_mstp_add_clk_domain(np);\n}\n\nCLK_OF_DECLARE(r8a7778_cpg_clks, \"renesas,r8a7778-cpg-clocks\",\n\t       r8a7778_cpg_clocks_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}