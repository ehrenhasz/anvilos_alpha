{
  "module_name": "rcar-cpg-lib.c",
  "hash_id": "a7c3d52cd795338b91ebb22d8ef0860d5a955b236227d54d7b9ade3853bf02cd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/renesas/rcar-cpg-lib.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/pm.h>\n#include <linux/slab.h>\n#include <linux/sys_soc.h>\n\n#include \"rcar-cpg-lib.h\"\n\nspinlock_t cpg_lock;\n\nvoid cpg_reg_modify(void __iomem *reg, u32 clear, u32 set)\n{\n\tunsigned long flags;\n\tu32 val;\n\n\tspin_lock_irqsave(&cpg_lock, flags);\n\tval = readl(reg);\n\tval &= ~clear;\n\tval |= set;\n\twritel(val, reg);\n\tspin_unlock_irqrestore(&cpg_lock, flags);\n};\n\nstatic int cpg_simple_notifier_call(struct notifier_block *nb,\n\t\t\t\t    unsigned long action, void *data)\n{\n\tstruct cpg_simple_notifier *csn =\n\t\tcontainer_of(nb, struct cpg_simple_notifier, nb);\n\n\tswitch (action) {\n\tcase PM_EVENT_SUSPEND:\n\t\tcsn->saved = readl(csn->reg);\n\t\treturn NOTIFY_OK;\n\n\tcase PM_EVENT_RESUME:\n\t\twritel(csn->saved, csn->reg);\n\t\treturn NOTIFY_OK;\n\t}\n\treturn NOTIFY_DONE;\n}\n\nvoid cpg_simple_notifier_register(struct raw_notifier_head *notifiers,\n\t\t\t\t  struct cpg_simple_notifier *csn)\n{\n\tcsn->nb.notifier_call = cpg_simple_notifier_call;\n\traw_notifier_chain_register(notifiers, &csn->nb);\n}\n\n \n\n#define SDnSRCFC_SHIFT 2\n#define STPnHCK\tBIT(9 - SDnSRCFC_SHIFT)\n\nstatic const struct clk_div_table cpg_sdh_div_table[] = {\n\t \n\t{ 0, 1 }, { 1, 2 }, { STPnHCK | 2, 4 }, { STPnHCK | 3, 8 },\n\t{ STPnHCK | 4, 16 },\n\t \n\t{ STPnHCK | 0, 1 }, { STPnHCK | 1, 2 },  { 2, 4 }, { 3, 8 }, { 4, 16 },\n\t \n\t{ 0, 0 }\n};\n\nstruct clk * __init cpg_sdh_clk_register(const char *name,\n\tvoid __iomem *sdnckcr, const char *parent_name,\n\tstruct raw_notifier_head *notifiers)\n{\n\tstruct cpg_simple_notifier *csn;\n\tstruct clk *clk;\n\n\tcsn = kzalloc(sizeof(*csn), GFP_KERNEL);\n\tif (!csn)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tcsn->reg = sdnckcr;\n\n\tclk = clk_register_divider_table(NULL, name, parent_name, 0, sdnckcr,\n\t\t\t\t\t SDnSRCFC_SHIFT, 8, 0, cpg_sdh_div_table,\n\t\t\t\t\t &cpg_lock);\n\tif (IS_ERR(clk)) {\n\t\tkfree(csn);\n\t\treturn clk;\n\t}\n\n\tcpg_simple_notifier_register(notifiers, csn);\n\treturn clk;\n}\n\nstatic const struct clk_div_table cpg_sd_div_table[] = {\n\t{ 0, 2 }, { 1, 4 }, { 0, 0 },\n};\n\nstruct clk * __init cpg_sd_clk_register(const char *name,\n\tvoid __iomem *sdnckcr, const char *parent_name)\n{\n\treturn clk_register_divider_table(NULL, name, parent_name, 0, sdnckcr,\n\t\t\t\t\t  0, 2, 0, cpg_sd_div_table, &cpg_lock);\n}\n\nstruct rpc_clock {\n\tstruct clk_divider div;\n\tstruct clk_gate gate;\n\t \n\tstruct cpg_simple_notifier csn;\n};\n\nstatic const struct clk_div_table cpg_rpc_div_table[] = {\n\t{ 1, 2 }, { 3, 4 }, { 5, 6 }, { 7, 8 }, { 0, 0 },\n};\n\nstruct clk * __init cpg_rpc_clk_register(const char *name,\n\tvoid __iomem *rpcckcr, const char *parent_name,\n\tstruct raw_notifier_head *notifiers)\n{\n\tstruct rpc_clock *rpc;\n\tstruct clk *clk;\n\n\trpc = kzalloc(sizeof(*rpc), GFP_KERNEL);\n\tif (!rpc)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\trpc->div.reg = rpcckcr;\n\trpc->div.width = 3;\n\trpc->div.table = cpg_rpc_div_table;\n\trpc->div.lock = &cpg_lock;\n\n\trpc->gate.reg = rpcckcr;\n\trpc->gate.bit_idx = 8;\n\trpc->gate.flags = CLK_GATE_SET_TO_DISABLE;\n\trpc->gate.lock = &cpg_lock;\n\n\trpc->csn.reg = rpcckcr;\n\n\tclk = clk_register_composite(NULL, name, &parent_name, 1, NULL, NULL,\n\t\t\t\t     &rpc->div.hw,  &clk_divider_ops,\n\t\t\t\t     &rpc->gate.hw, &clk_gate_ops,\n\t\t\t\t     CLK_SET_RATE_PARENT);\n\tif (IS_ERR(clk)) {\n\t\tkfree(rpc);\n\t\treturn clk;\n\t}\n\n\tcpg_simple_notifier_register(notifiers, &rpc->csn);\n\treturn clk;\n}\n\nstruct rpcd2_clock {\n\tstruct clk_fixed_factor fixed;\n\tstruct clk_gate gate;\n};\n\nstruct clk * __init cpg_rpcd2_clk_register(const char *name,\n\t\t\t\t\t   void __iomem *rpcckcr,\n\t\t\t\t\t   const char *parent_name)\n{\n\tstruct rpcd2_clock *rpcd2;\n\tstruct clk *clk;\n\n\trpcd2 = kzalloc(sizeof(*rpcd2), GFP_KERNEL);\n\tif (!rpcd2)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\trpcd2->fixed.mult = 1;\n\trpcd2->fixed.div = 2;\n\n\trpcd2->gate.reg = rpcckcr;\n\trpcd2->gate.bit_idx = 9;\n\trpcd2->gate.flags = CLK_GATE_SET_TO_DISABLE;\n\trpcd2->gate.lock = &cpg_lock;\n\n\tclk = clk_register_composite(NULL, name, &parent_name, 1, NULL, NULL,\n\t\t\t\t     &rpcd2->fixed.hw, &clk_fixed_factor_ops,\n\t\t\t\t     &rpcd2->gate.hw, &clk_gate_ops,\n\t\t\t\t     CLK_SET_RATE_PARENT);\n\tif (IS_ERR(clk))\n\t\tkfree(rpcd2);\n\n\treturn clk;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}