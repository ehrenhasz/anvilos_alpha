{
  "module_name": "r8a77970-cpg-mssr.c",
  "hash_id": "82e573ddd954c628f3bb72a2564cf37649b060a5f3186fc026051bb7ccd17102",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/renesas/r8a77970-cpg-mssr.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/device.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/soc/renesas/rcar-rst.h>\n\n#include <dt-bindings/clock/r8a77970-cpg-mssr.h>\n\n#include \"renesas-cpg-mssr.h\"\n#include \"rcar-gen3-cpg.h\"\n\n#define CPG_SD0CKCR\t\t0x0074\n\nenum r8a77970_clk_types {\n\tCLK_TYPE_R8A77970_SD0H = CLK_TYPE_GEN3_SOC_BASE,\n\tCLK_TYPE_R8A77970_SD0,\n};\n\nenum clk_ids {\n\t \n\tLAST_DT_CORE_CLK = R8A77970_CLK_OSC,\n\n\t \n\tCLK_EXTAL,\n\tCLK_EXTALR,\n\n\t \n\tCLK_MAIN,\n\tCLK_PLL0,\n\tCLK_PLL1,\n\tCLK_PLL3,\n\tCLK_PLL1_DIV2,\n\tCLK_PLL1_DIV4,\n\n\t \n\tMOD_CLK_BASE\n};\n\nstatic spinlock_t cpg_lock;\n\nstatic const struct clk_div_table cpg_sd0h_div_table[] = {\n\t{  0,  2 }, {  1,  3 }, {  2,  4 }, {  3,  6 },\n\t{  4,  8 }, {  5, 12 }, {  6, 16 }, {  7, 18 },\n\t{  8, 24 }, { 10, 36 }, { 11, 48 }, {  0,  0 },\n};\n\nstatic const struct clk_div_table cpg_sd0_div_table[] = {\n\t{  4,  8 }, {  5, 12 }, {  6, 16 }, {  7, 18 },\n\t{  8, 24 }, { 10, 36 }, { 11, 48 }, { 12, 10 },\n\t{  0,  0 },\n};\n\nstatic const struct cpg_core_clk r8a77970_core_clks[] __initconst = {\n\t \n\tDEF_INPUT(\"extal\",\tCLK_EXTAL),\n\tDEF_INPUT(\"extalr\",\tCLK_EXTALR),\n\n\t \n\tDEF_BASE(\".main\",\tCLK_MAIN, CLK_TYPE_GEN3_MAIN, CLK_EXTAL),\n\tDEF_BASE(\".pll0\",\tCLK_PLL0, CLK_TYPE_GEN3_PLL0, CLK_MAIN),\n\tDEF_BASE(\".pll1\",\tCLK_PLL1, CLK_TYPE_GEN3_PLL1, CLK_MAIN),\n\tDEF_BASE(\".pll3\",\tCLK_PLL3, CLK_TYPE_GEN3_PLL3, CLK_MAIN),\n\n\tDEF_FIXED(\".pll1_div2\",\tCLK_PLL1_DIV2,\tCLK_PLL1,\t2, 1),\n\tDEF_FIXED(\".pll1_div4\",\tCLK_PLL1_DIV4,\tCLK_PLL1_DIV2,\t2, 1),\n\n\t \n\tDEF_FIXED(\"z2\",\t\tR8A77970_CLK_Z2,    CLK_PLL1_DIV4,  1, 1),\n\tDEF_FIXED(\"ztr\",\tR8A77970_CLK_ZTR,   CLK_PLL1_DIV2,  6, 1),\n\tDEF_FIXED(\"ztrd2\",\tR8A77970_CLK_ZTRD2, CLK_PLL1_DIV2, 12, 1),\n\tDEF_FIXED(\"zt\",\t\tR8A77970_CLK_ZT,    CLK_PLL1_DIV2,  4, 1),\n\tDEF_FIXED(\"zx\",\t\tR8A77970_CLK_ZX,    CLK_PLL1_DIV2,  3, 1),\n\tDEF_FIXED(\"s1d1\",\tR8A77970_CLK_S1D1,  CLK_PLL1_DIV2,  4, 1),\n\tDEF_FIXED(\"s1d2\",\tR8A77970_CLK_S1D2,  CLK_PLL1_DIV2,  8, 1),\n\tDEF_FIXED(\"s1d4\",\tR8A77970_CLK_S1D4,  CLK_PLL1_DIV2, 16, 1),\n\tDEF_FIXED(\"s2d1\",\tR8A77970_CLK_S2D1,  CLK_PLL1_DIV2,  6, 1),\n\tDEF_FIXED(\"s2d2\",\tR8A77970_CLK_S2D2,  CLK_PLL1_DIV2, 12, 1),\n\tDEF_FIXED(\"s2d4\",\tR8A77970_CLK_S2D4,  CLK_PLL1_DIV2, 24, 1),\n\n\tDEF_BASE(\"sd0h\", R8A77970_CLK_SD0H, CLK_TYPE_R8A77970_SD0H,\n\t\t CLK_PLL1_DIV2),\n\tDEF_BASE(\"sd0\",\tR8A77970_CLK_SD0, CLK_TYPE_R8A77970_SD0, CLK_PLL1_DIV2),\n\n\tDEF_FIXED(\"rpc\",\tR8A77970_CLK_RPC,   CLK_PLL1_DIV2,  5, 1),\n\tDEF_FIXED(\"rpcd2\",\tR8A77970_CLK_RPCD2, CLK_PLL1_DIV2, 10, 1),\n\n\tDEF_FIXED(\"cl\",\t\tR8A77970_CLK_CL,    CLK_PLL1_DIV2, 48, 1),\n\tDEF_FIXED(\"cp\",\t\tR8A77970_CLK_CP,    CLK_EXTAL,\t    2, 1),\n\tDEF_FIXED(\"cpex\",\tR8A77970_CLK_CPEX,  CLK_EXTAL,\t    2, 1),\n\n\tDEF_DIV6P1(\"canfd\",\tR8A77970_CLK_CANFD, CLK_PLL1_DIV4, 0x244),\n\tDEF_DIV6P1(\"mso\",\tR8A77970_CLK_MSO,   CLK_PLL1_DIV4, 0x014),\n\tDEF_DIV6P1(\"csi0\",\tR8A77970_CLK_CSI0,  CLK_PLL1_DIV4, 0x00c),\n\n\tDEF_FIXED(\"osc\",\tR8A77970_CLK_OSC,   CLK_PLL1_DIV2, 12*1024, 1),\n\tDEF_FIXED(\"r\",\t\tR8A77970_CLK_R,\t    CLK_EXTALR,\t   1, 1),\n};\n\nstatic const struct mssr_mod_clk r8a77970_mod_clks[] __initconst = {\n\tDEF_MOD(\"tmu4\",\t\t\t 121,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"tmu3\",\t\t\t 122,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"tmu2\",\t\t\t 123,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"tmu1\",\t\t\t 124,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"tmu0\",\t\t\t 125,\tR8A77970_CLK_CP),\n\tDEF_MOD(\"ivcp1e\",\t\t 127,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"scif4\",\t\t 203,\tR8A77970_CLK_S2D4),\n\tDEF_MOD(\"scif3\",\t\t 204,\tR8A77970_CLK_S2D4),\n\tDEF_MOD(\"scif1\",\t\t 206,\tR8A77970_CLK_S2D4),\n\tDEF_MOD(\"scif0\",\t\t 207,\tR8A77970_CLK_S2D4),\n\tDEF_MOD(\"msiof3\",\t\t 208,\tR8A77970_CLK_MSO),\n\tDEF_MOD(\"msiof2\",\t\t 209,\tR8A77970_CLK_MSO),\n\tDEF_MOD(\"msiof1\",\t\t 210,\tR8A77970_CLK_MSO),\n\tDEF_MOD(\"msiof0\",\t\t 211,\tR8A77970_CLK_MSO),\n\tDEF_MOD(\"mfis\",\t\t\t 213,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"sys-dmac2\",\t\t 217,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"sys-dmac1\",\t\t 218,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"cmt3\",\t\t\t 300,\tR8A77970_CLK_R),\n\tDEF_MOD(\"cmt2\",\t\t\t 301,\tR8A77970_CLK_R),\n\tDEF_MOD(\"cmt1\",\t\t\t 302,\tR8A77970_CLK_R),\n\tDEF_MOD(\"cmt0\",\t\t\t 303,\tR8A77970_CLK_R),\n\tDEF_MOD(\"tpu0\",\t\t\t 304,\tR8A77970_CLK_S2D4),\n\tDEF_MOD(\"sd-if\",\t\t 314,\tR8A77970_CLK_SD0),\n\tDEF_MOD(\"rwdt\",\t\t\t 402,\tR8A77970_CLK_R),\n\tDEF_MOD(\"intc-ex\",\t\t 407,\tR8A77970_CLK_CP),\n\tDEF_MOD(\"intc-ap\",\t\t 408,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"hscif3\",\t\t 517,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"hscif2\",\t\t 518,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"hscif1\",\t\t 519,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"hscif0\",\t\t 520,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"thermal\",\t\t 522,\tR8A77970_CLK_CP),\n\tDEF_MOD(\"pwm\",\t\t\t 523,\tR8A77970_CLK_S2D4),\n\tDEF_MOD(\"fcpvd0\",\t\t 603,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"vspd0\",\t\t 623,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"csi40\",\t\t 716,\tR8A77970_CLK_CSI0),\n\tDEF_MOD(\"du0\",\t\t\t 724,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"lvds\",\t\t\t 727,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"vin3\",\t\t\t 808,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"vin2\",\t\t\t 809,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"vin1\",\t\t\t 810,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"vin0\",\t\t\t 811,\tR8A77970_CLK_S2D1),\n\tDEF_MOD(\"etheravb\",\t\t 812,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"gpio5\",\t\t 907,\tR8A77970_CLK_CP),\n\tDEF_MOD(\"gpio4\",\t\t 908,\tR8A77970_CLK_CP),\n\tDEF_MOD(\"gpio3\",\t\t 909,\tR8A77970_CLK_CP),\n\tDEF_MOD(\"gpio2\",\t\t 910,\tR8A77970_CLK_CP),\n\tDEF_MOD(\"gpio1\",\t\t 911,\tR8A77970_CLK_CP),\n\tDEF_MOD(\"gpio0\",\t\t 912,\tR8A77970_CLK_CP),\n\tDEF_MOD(\"can-fd\",\t\t 914,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"rpc-if\",\t\t 917,\tR8A77970_CLK_RPC),\n\tDEF_MOD(\"i2c4\",\t\t\t 927,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"i2c3\",\t\t\t 928,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"i2c2\",\t\t\t 929,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"i2c1\",\t\t\t 930,\tR8A77970_CLK_S2D2),\n\tDEF_MOD(\"i2c0\",\t\t\t 931,\tR8A77970_CLK_S2D2),\n};\n\nstatic const unsigned int r8a77970_crit_mod_clks[] __initconst = {\n\tMOD_CLK_ID(402),\t \n\tMOD_CLK_ID(408),\t \n};\n\n \n\n \n#define CPG_PLL_CONFIG_INDEX(md)\t((((md) & BIT(14)) >> 12) | \\\n\t\t\t\t\t (((md) & BIT(13)) >> 12) | \\\n\t\t\t\t\t (((md) & BIT(19)) >> 19))\n\nstatic const struct rcar_gen3_cpg_pll_config cpg_pll_configs[8] __initconst = {\n\t \n\t{ 1,\t\t192,\t1,\t96,\t1,\t},\n\t{ 1,\t\t192,\t1,\t80,\t1,\t},\n\t{ 1,\t\t160,\t1,\t80,\t1,\t},\n\t{ 1,\t\t160,\t1,\t66,\t1,\t},\n\t{ 2,\t\t236,\t1,\t118,\t1,\t},\n\t{ 2,\t\t236,\t1,\t98,\t1,\t},\n\t{ 2,\t\t192,\t1,\t96,\t1,\t},\n\t{ 2,\t\t192,\t1,\t80,\t1,\t},\n};\n\nstatic int __init r8a77970_cpg_mssr_init(struct device *dev)\n{\n\tconst struct rcar_gen3_cpg_pll_config *cpg_pll_config;\n\tu32 cpg_mode;\n\tint error;\n\n\terror = rcar_rst_read_mode_pins(&cpg_mode);\n\tif (error)\n\t\treturn error;\n\n\tspin_lock_init(&cpg_lock);\n\n\tcpg_pll_config = &cpg_pll_configs[CPG_PLL_CONFIG_INDEX(cpg_mode)];\n\n\treturn rcar_gen3_cpg_init(cpg_pll_config, CLK_EXTALR, cpg_mode);\n}\n\nstatic struct clk * __init r8a77970_cpg_clk_register(struct device *dev,\n\tconst struct cpg_core_clk *core, const struct cpg_mssr_info *info,\n\tstruct clk **clks, void __iomem *base,\n\tstruct raw_notifier_head *notifiers)\n{\n\tconst struct clk_div_table *table;\n\tconst struct clk *parent;\n\tunsigned int shift;\n\n\tswitch (core->type) {\n\tcase CLK_TYPE_R8A77970_SD0H:\n\t\ttable = cpg_sd0h_div_table;\n\t\tshift = 8;\n\t\tbreak;\n\tcase CLK_TYPE_R8A77970_SD0:\n\t\ttable = cpg_sd0_div_table;\n\t\tshift = 4;\n\t\tbreak;\n\tdefault:\n\t\treturn rcar_gen3_cpg_clk_register(dev, core, info, clks, base,\n\t\t\t\t\t\t  notifiers);\n\t}\n\n\tparent = clks[core->parent];\n\tif (IS_ERR(parent))\n\t\treturn ERR_CAST(parent);\n\n\treturn clk_register_divider_table(NULL, core->name,\n\t\t\t\t\t  __clk_get_name(parent), 0,\n\t\t\t\t\t  base + CPG_SD0CKCR,\n\t\t\t\t\t  shift, 4, 0, table, &cpg_lock);\n}\n\nconst struct cpg_mssr_info r8a77970_cpg_mssr_info __initconst = {\n\t \n\t.core_clks = r8a77970_core_clks,\n\t.num_core_clks = ARRAY_SIZE(r8a77970_core_clks),\n\t.last_dt_core_clk = LAST_DT_CORE_CLK,\n\t.num_total_core_clks = MOD_CLK_BASE,\n\n\t \n\t.mod_clks = r8a77970_mod_clks,\n\t.num_mod_clks = ARRAY_SIZE(r8a77970_mod_clks),\n\t.num_hw_mod_clks = 12 * 32,\n\n\t \n\t.crit_mod_clks = r8a77970_crit_mod_clks,\n\t.num_crit_mod_clks = ARRAY_SIZE(r8a77970_crit_mod_clks),\n\n\t \n\t.init = r8a77970_cpg_mssr_init,\n\t.cpg_clk_register = r8a77970_cpg_clk_register,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}