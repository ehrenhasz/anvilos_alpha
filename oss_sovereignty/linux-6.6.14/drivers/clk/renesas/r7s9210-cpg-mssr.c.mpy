{
  "module_name": "r7s9210-cpg-mssr.c",
  "hash_id": "fb550c384876fa48c460a980b3b76a8ca3a2b717efd27562b6e50b1f000d7d59",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/renesas/r7s9210-cpg-mssr.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <dt-bindings/clock/r7s9210-cpg-mssr.h>\n#include \"renesas-cpg-mssr.h\"\n\n#define CPG_FRQCR\t0x00\n\nstatic u8 cpg_mode;\n\n \nstatic const struct {\n\tunsigned int i;\n\tunsigned int g;\n\tunsigned int b;\n\tunsigned int p1;\n\t ;\n} ratio_tab[5] = {\t \n\t\t\t{  2,  4,  8, 16},\t \n\t\t\t{  4,  4,  8, 16},\t \n\t\t\t{  8,  4,  8, 16},\t \n\t\t\t{ 16,  8, 16, 16},\t \n\t\t\t{ 16, 16, 32, 32},\t \n\t\t\t};\n\nenum rz_clk_types {\n\tCLK_TYPE_RZA_MAIN = CLK_TYPE_CUSTOM,\n\tCLK_TYPE_RZA_PLL,\n};\n\nenum clk_ids {\n\t \n\tLAST_DT_CORE_CLK = R7S9210_CLK_P0,\n\n\t \n\tCLK_EXTAL,\n\n\t \n\tCLK_MAIN,\n\tCLK_PLL,\n\n\t \n\tMOD_CLK_BASE\n};\n\nstatic struct cpg_core_clk r7s9210_early_core_clks[] = {\n\t \n\tDEF_INPUT(\"extal\",     CLK_EXTAL),\n\n\t \n\tDEF_BASE(\".main\",       CLK_MAIN, CLK_TYPE_RZA_MAIN, CLK_EXTAL),\n\tDEF_BASE(\".pll\",       CLK_PLL, CLK_TYPE_RZA_PLL, CLK_MAIN),\n\n\t \n\tDEF_FIXED(\"p1c\",    R7S9210_CLK_P1C,   CLK_PLL,         16, 1),\n};\n\nstatic const struct mssr_mod_clk r7s9210_early_mod_clks[] __initconst = {\n\tDEF_MOD_STB(\"ostm2\",\t 34,\tR7S9210_CLK_P1C),\n\tDEF_MOD_STB(\"ostm1\",\t 35,\tR7S9210_CLK_P1C),\n\tDEF_MOD_STB(\"ostm0\",\t 36,\tR7S9210_CLK_P1C),\n};\n\nstatic struct cpg_core_clk r7s9210_core_clks[] = {\n\t \n\tDEF_FIXED(\"i\",      R7S9210_CLK_I,     CLK_PLL,          2, 1),\n\tDEF_FIXED(\"g\",      R7S9210_CLK_G,     CLK_PLL,          4, 1),\n\tDEF_FIXED(\"b\",      R7S9210_CLK_B,     CLK_PLL,          8, 1),\n\tDEF_FIXED(\"p1\",     R7S9210_CLK_P1,    CLK_PLL,         16, 1),\n\tDEF_FIXED(\"p0\",     R7S9210_CLK_P0,    CLK_PLL,         32, 1),\n};\n\nstatic const struct mssr_mod_clk r7s9210_mod_clks[] __initconst = {\n\tDEF_MOD_STB(\"scif4\",\t 43,\tR7S9210_CLK_P1C),\n\tDEF_MOD_STB(\"scif3\",\t 44,\tR7S9210_CLK_P1C),\n\tDEF_MOD_STB(\"scif2\",\t 45,\tR7S9210_CLK_P1C),\n\tDEF_MOD_STB(\"scif1\",\t 46,\tR7S9210_CLK_P1C),\n\tDEF_MOD_STB(\"scif0\",\t 47,\tR7S9210_CLK_P1C),\n\n\tDEF_MOD_STB(\"usb1\",\t 60,\tR7S9210_CLK_B),\n\tDEF_MOD_STB(\"usb0\",\t 61,\tR7S9210_CLK_B),\n\tDEF_MOD_STB(\"ether1\",\t 64,\tR7S9210_CLK_B),\n\tDEF_MOD_STB(\"ether0\",\t 65,\tR7S9210_CLK_B),\n\n\tDEF_MOD_STB(\"spibsc\",\t 83,\tR7S9210_CLK_P1),\n\tDEF_MOD_STB(\"i2c3\",\t 84,\tR7S9210_CLK_P1),\n\tDEF_MOD_STB(\"i2c2\",\t 85,\tR7S9210_CLK_P1),\n\tDEF_MOD_STB(\"i2c1\",\t 86,\tR7S9210_CLK_P1),\n\tDEF_MOD_STB(\"i2c0\",\t 87,\tR7S9210_CLK_P1),\n\n\tDEF_MOD_STB(\"spi2\",\t 95,\tR7S9210_CLK_P1),\n\tDEF_MOD_STB(\"spi1\",\t 96,\tR7S9210_CLK_P1),\n\tDEF_MOD_STB(\"spi0\",\t 97,\tR7S9210_CLK_P1),\n\n\tDEF_MOD_STB(\"sdhi11\",\t100,\tR7S9210_CLK_B),\n\tDEF_MOD_STB(\"sdhi10\",\t101,\tR7S9210_CLK_B),\n\tDEF_MOD_STB(\"sdhi01\",\t102,\tR7S9210_CLK_B),\n\tDEF_MOD_STB(\"sdhi00\",\t103,\tR7S9210_CLK_B),\n};\n\n \nstatic void __init r7s9210_update_clk_table(struct clk *extal_clk,\n\t\t\t\t\t    void __iomem *base)\n{\n\tint i;\n\tu16 frqcr;\n\tu8 index;\n\n\t \n\tif (clk_get_rate(extal_clk) > 12000000)\n\t\tcpg_mode = 1;\n\n\tfrqcr = readl(base + CPG_FRQCR) & 0xFFF;\n\tif (frqcr == 0x012)\n\t\tindex = 0;\n\telse if (frqcr == 0x112)\n\t\tindex = 1;\n\telse if (frqcr == 0x212)\n\t\tindex = 2;\n\telse if (frqcr == 0x322)\n\t\tindex = 3;\n\telse if (frqcr == 0x333)\n\t\tindex = 4;\n\telse\n\t\tBUG_ON(1);\t \n\n\tfor (i = 0; i < ARRAY_SIZE(r7s9210_core_clks); i++) {\n\t\tswitch (r7s9210_core_clks[i].id) {\n\t\tcase R7S9210_CLK_I:\n\t\t\tr7s9210_core_clks[i].div = ratio_tab[index].i;\n\t\t\tbreak;\n\t\tcase R7S9210_CLK_G:\n\t\t\tr7s9210_core_clks[i].div = ratio_tab[index].g;\n\t\t\tbreak;\n\t\tcase R7S9210_CLK_B:\n\t\t\tr7s9210_core_clks[i].div = ratio_tab[index].b;\n\t\t\tbreak;\n\t\tcase R7S9210_CLK_P1:\n\t\tcase R7S9210_CLK_P1C:\n\t\t\tr7s9210_core_clks[i].div = ratio_tab[index].p1;\n\t\t\tbreak;\n\t\tcase R7S9210_CLK_P0:\n\t\t\tr7s9210_core_clks[i].div = 32;\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic struct clk * __init rza2_cpg_clk_register(struct device *dev,\n\tconst struct cpg_core_clk *core, const struct cpg_mssr_info *info,\n\tstruct clk **clks, void __iomem *base,\n\tstruct raw_notifier_head *notifiers)\n{\n\tstruct clk *parent;\n\tunsigned int mult = 1;\n\tunsigned int div = 1;\n\n\tparent = clks[core->parent];\n\tif (IS_ERR(parent))\n\t\treturn ERR_CAST(parent);\n\n\tswitch (core->id) {\n\tcase CLK_MAIN:\n\t\tbreak;\n\n\tcase CLK_PLL:\n\t\tif (cpg_mode)\n\t\t\tmult = 44;\t \n\t\telse\n\t\t\tmult = 88;\t \n\t\tbreak;\n\n\tdefault:\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\tif (core->id == CLK_MAIN)\n\t\tr7s9210_update_clk_table(parent, base);\n\n\treturn clk_register_fixed_factor(NULL, core->name,\n\t\t\t\t\t __clk_get_name(parent), 0, mult, div);\n}\n\nconst struct cpg_mssr_info r7s9210_cpg_mssr_info __initconst = {\n\t \n\t.early_core_clks = r7s9210_early_core_clks,\n\t.num_early_core_clks = ARRAY_SIZE(r7s9210_early_core_clks),\n\t.early_mod_clks = r7s9210_early_mod_clks,\n\t.num_early_mod_clks = ARRAY_SIZE(r7s9210_early_mod_clks),\n\n\t \n\t.core_clks = r7s9210_core_clks,\n\t.num_core_clks = ARRAY_SIZE(r7s9210_core_clks),\n\t.last_dt_core_clk = LAST_DT_CORE_CLK,\n\t.num_total_core_clks = MOD_CLK_BASE,\n\n\t \n\t.mod_clks = r7s9210_mod_clks,\n\t.num_mod_clks = ARRAY_SIZE(r7s9210_mod_clks),\n\t.num_hw_mod_clks = 11 * 32,  \n\n\t \n\t.cpg_clk_register = rza2_cpg_clk_register,\n\n\t \n\t.reg_layout = CLK_REG_LAYOUT_RZ_A,\n};\n\nstatic void __init r7s9210_cpg_mssr_early_init(struct device_node *np)\n{\n\tcpg_mssr_early_init(np, &r7s9210_cpg_mssr_info);\n}\n\nCLK_OF_DECLARE_DRIVER(cpg_mstp_clks, \"renesas,r7s9210-cpg-mssr\",\n\t\t      r7s9210_cpg_mssr_early_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}