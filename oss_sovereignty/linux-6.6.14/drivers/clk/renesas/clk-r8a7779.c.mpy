{
  "module_name": "clk-r8a7779.c",
  "hash_id": "f076caa335d15d9360137db7a38d833703d8ae062d9a674b67ccf2a8a2c08c65",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/renesas/clk-r8a7779.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/clk/renesas.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/slab.h>\n#include <linux/spinlock.h>\n#include <linux/soc/renesas/rcar-rst.h>\n\n#include <dt-bindings/clock/r8a7779-clock.h>\n\n#define CPG_NUM_CLOCKS\t\t\t(R8A7779_CLK_OUT + 1)\n\n \n\n \n\n#define CPG_CLK_CONFIG_INDEX(md)\t(((md) & (BIT(2)|BIT(1))) >> 1)\n\nstruct cpg_clk_config {\n\tunsigned int z_mult;\n\tunsigned int z_div;\n\tunsigned int zs_and_s_div;\n\tunsigned int s1_div;\n\tunsigned int p_div;\n\tunsigned int b_and_out_div;\n};\n\nstatic const struct cpg_clk_config cpg_clk_configs[4] __initconst = {\n\t{ 1, 2, 8, 16, 32, 24 },\n\t{ 2, 3, 6, 12, 24, 24 },\n\t{ 1, 2, 8, 16, 32, 32 },\n\t{ 2, 3, 6, 12, 24, 36 },\n};\n\n \n\n#define CPG_PLLA_MULT_INDEX(md)\t(((md) & (BIT(12)|BIT(11))) >> 11)\n\nstatic const unsigned int cpg_plla_mult[4] __initconst = { 42, 48, 56, 64 };\n\n \n\nstatic struct clk * __init\nr8a7779_cpg_register_clock(struct device_node *np,\n\t\t\t   const struct cpg_clk_config *config,\n\t\t\t   unsigned int plla_mult, const char *name)\n{\n\tconst char *parent_name = \"plla\";\n\tunsigned int mult = 1;\n\tunsigned int div = 1;\n\n\tif (!strcmp(name, \"plla\")) {\n\t\tparent_name = of_clk_get_parent_name(np, 0);\n\t\tmult = plla_mult;\n\t} else if (!strcmp(name, \"z\")) {\n\t\tdiv = config->z_div;\n\t\tmult = config->z_mult;\n\t} else if (!strcmp(name, \"zs\") || !strcmp(name, \"s\")) {\n\t\tdiv = config->zs_and_s_div;\n\t} else if (!strcmp(name, \"s1\")) {\n\t\tdiv = config->s1_div;\n\t} else if (!strcmp(name, \"p\")) {\n\t\tdiv = config->p_div;\n\t} else if (!strcmp(name, \"b\") || !strcmp(name, \"out\")) {\n\t\tdiv = config->b_and_out_div;\n\t} else {\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\treturn clk_register_fixed_factor(NULL, name, parent_name, 0, mult, div);\n}\n\nstatic void __init r8a7779_cpg_clocks_init(struct device_node *np)\n{\n\tconst struct cpg_clk_config *config;\n\tstruct clk_onecell_data *data;\n\tstruct clk **clks;\n\tunsigned int i, plla_mult;\n\tint num_clks;\n\tu32 mode;\n\n\tif (rcar_rst_read_mode_pins(&mode))\n\t\treturn;\n\n\tnum_clks = of_property_count_strings(np, \"clock-output-names\");\n\tif (num_clks < 0) {\n\t\tpr_err(\"%s: failed to count clocks\\n\", __func__);\n\t\treturn;\n\t}\n\n\tdata = kzalloc(sizeof(*data), GFP_KERNEL);\n\tclks = kcalloc(CPG_NUM_CLOCKS, sizeof(*clks), GFP_KERNEL);\n\tif (data == NULL || clks == NULL) {\n\t\t \n\t\treturn;\n\t}\n\n\tdata->clks = clks;\n\tdata->clk_num = num_clks;\n\n\tconfig = &cpg_clk_configs[CPG_CLK_CONFIG_INDEX(mode)];\n\tplla_mult = cpg_plla_mult[CPG_PLLA_MULT_INDEX(mode)];\n\n\tfor (i = 0; i < num_clks; ++i) {\n\t\tconst char *name;\n\t\tstruct clk *clk;\n\n\t\tof_property_read_string_index(np, \"clock-output-names\", i,\n\t\t\t\t\t      &name);\n\n\t\tclk = r8a7779_cpg_register_clock(np, config, plla_mult, name);\n\t\tif (IS_ERR(clk))\n\t\t\tpr_err(\"%s: failed to register %pOFn %s clock (%ld)\\n\",\n\t\t\t       __func__, np, name, PTR_ERR(clk));\n\t\telse\n\t\t\tdata->clks[i] = clk;\n\t}\n\n\tof_clk_add_provider(np, of_clk_src_onecell_get, data);\n\n\tcpg_mstp_add_clk_domain(np);\n}\nCLK_OF_DECLARE(r8a7779_cpg_clks, \"renesas,r8a7779-cpg-clocks\",\n\t       r8a7779_cpg_clocks_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}