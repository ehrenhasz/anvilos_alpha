{
  "module_name": "clk-gate.c",
  "hash_id": "3f4cf9004585cbd09277ab65ea96c86c742b211b26724f6d8f1dadab56c1de32",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/mmp/clk-gate.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n#include <linux/err.h>\n#include <linux/delay.h>\n\n#include \"clk.h\"\n\n \n\n#define to_clk_mmp_gate(hw)\tcontainer_of(hw, struct mmp_clk_gate, hw)\n\nstatic int mmp_clk_gate_enable(struct clk_hw *hw)\n{\n\tstruct mmp_clk_gate *gate = to_clk_mmp_gate(hw);\n\tunsigned long flags = 0;\n\tunsigned long rate;\n\tu32 tmp;\n\n\tif (gate->lock)\n\t\tspin_lock_irqsave(gate->lock, flags);\n\n\ttmp = readl(gate->reg);\n\ttmp &= ~gate->mask;\n\ttmp |= gate->val_enable;\n\twritel(tmp, gate->reg);\n\n\tif (gate->lock)\n\t\tspin_unlock_irqrestore(gate->lock, flags);\n\n\tif (gate->flags & MMP_CLK_GATE_NEED_DELAY) {\n\t\trate = clk_hw_get_rate(hw);\n\t\t \n\t\tudelay(2000000/rate);\n\t}\n\n\treturn 0;\n}\n\nstatic void mmp_clk_gate_disable(struct clk_hw *hw)\n{\n\tstruct mmp_clk_gate *gate = to_clk_mmp_gate(hw);\n\tunsigned long flags = 0;\n\tu32 tmp;\n\n\tif (gate->lock)\n\t\tspin_lock_irqsave(gate->lock, flags);\n\n\ttmp = readl(gate->reg);\n\ttmp &= ~gate->mask;\n\ttmp |= gate->val_disable;\n\twritel(tmp, gate->reg);\n\n\tif (gate->lock)\n\t\tspin_unlock_irqrestore(gate->lock, flags);\n}\n\nstatic int mmp_clk_gate_is_enabled(struct clk_hw *hw)\n{\n\tstruct mmp_clk_gate *gate = to_clk_mmp_gate(hw);\n\tunsigned long flags = 0;\n\tu32 tmp;\n\n\tif (gate->lock)\n\t\tspin_lock_irqsave(gate->lock, flags);\n\n\ttmp = readl(gate->reg);\n\n\tif (gate->lock)\n\t\tspin_unlock_irqrestore(gate->lock, flags);\n\n\treturn (tmp & gate->mask) == gate->val_enable;\n}\n\nconst struct clk_ops mmp_clk_gate_ops = {\n\t.enable = mmp_clk_gate_enable,\n\t.disable = mmp_clk_gate_disable,\n\t.is_enabled = mmp_clk_gate_is_enabled,\n};\n\nstruct clk *mmp_clk_register_gate(struct device *dev, const char *name,\n\t\tconst char *parent_name, unsigned long flags,\n\t\tvoid __iomem *reg, u32 mask, u32 val_enable, u32 val_disable,\n\t\tunsigned int gate_flags, spinlock_t *lock)\n{\n\tstruct mmp_clk_gate *gate;\n\tstruct clk *clk;\n\tstruct clk_init_data init;\n\n\t \n\tgate = kzalloc(sizeof(*gate), GFP_KERNEL);\n\tif (!gate)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit.name = name;\n\tinit.ops = &mmp_clk_gate_ops;\n\tinit.flags = flags;\n\tinit.parent_names = (parent_name ? &parent_name : NULL);\n\tinit.num_parents = (parent_name ? 1 : 0);\n\n\t \n\tgate->reg = reg;\n\tgate->mask = mask;\n\tgate->val_enable = val_enable;\n\tgate->val_disable = val_disable;\n\tgate->flags = gate_flags;\n\tgate->lock = lock;\n\tgate->hw.init = &init;\n\n\tclk = clk_register(dev, &gate->hw);\n\n\tif (IS_ERR(clk))\n\t\tkfree(gate);\n\n\treturn clk;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}