{
  "module_name": "clk-nspire.c",
  "hash_id": "6715e9e3f9caf8cf87cef2cf67a7150978a8c7020d650fb00537109d31894423",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/clk-nspire.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n\n#define MHZ (1000 * 1000)\n\n#define BASE_CPU_SHIFT\t\t1\n#define BASE_CPU_MASK\t\t0x7F\n\n#define CPU_AHB_SHIFT\t\t12\n#define CPU_AHB_MASK\t\t0x07\n\n#define FIXED_BASE_SHIFT\t8\n#define FIXED_BASE_MASK\t\t0x01\n\n#define CLASSIC_BASE_SHIFT\t16\n#define CLASSIC_BASE_MASK\t0x1F\n\n#define CX_BASE_SHIFT\t\t15\n#define CX_BASE_MASK\t\t0x3F\n\n#define CX_UNKNOWN_SHIFT\t21\n#define CX_UNKNOWN_MASK\t\t0x03\n\nstruct nspire_clk_info {\n\tu32 base_clock;\n\tu16 base_cpu_ratio;\n\tu16 base_ahb_ratio;\n};\n\n\n#define EXTRACT(var, prop) (((var)>>prop##_SHIFT) & prop##_MASK)\nstatic void nspire_clkinfo_cx(u32 val, struct nspire_clk_info *clk)\n{\n\tif (EXTRACT(val, FIXED_BASE))\n\t\tclk->base_clock = 48 * MHZ;\n\telse\n\t\tclk->base_clock = 6 * EXTRACT(val, CX_BASE) * MHZ;\n\n\tclk->base_cpu_ratio = EXTRACT(val, BASE_CPU) * EXTRACT(val, CX_UNKNOWN);\n\tclk->base_ahb_ratio = clk->base_cpu_ratio * (EXTRACT(val, CPU_AHB) + 1);\n}\n\nstatic void nspire_clkinfo_classic(u32 val, struct nspire_clk_info *clk)\n{\n\tif (EXTRACT(val, FIXED_BASE))\n\t\tclk->base_clock = 27 * MHZ;\n\telse\n\t\tclk->base_clock = (300 - 6 * EXTRACT(val, CLASSIC_BASE)) * MHZ;\n\n\tclk->base_cpu_ratio = EXTRACT(val, BASE_CPU) * 2;\n\tclk->base_ahb_ratio = clk->base_cpu_ratio * (EXTRACT(val, CPU_AHB) + 1);\n}\n\nstatic void __init nspire_ahbdiv_setup(struct device_node *node,\n\t\tvoid (*get_clkinfo)(u32, struct nspire_clk_info *))\n{\n\tu32 val;\n\tvoid __iomem *io;\n\tstruct clk_hw *hw;\n\tconst char *clk_name = node->name;\n\tconst char *parent_name;\n\tstruct nspire_clk_info info;\n\n\tio = of_iomap(node, 0);\n\tif (!io)\n\t\treturn;\n\tval = readl(io);\n\tiounmap(io);\n\n\tget_clkinfo(val, &info);\n\n\tof_property_read_string(node, \"clock-output-names\", &clk_name);\n\tparent_name = of_clk_get_parent_name(node, 0);\n\n\thw = clk_hw_register_fixed_factor(NULL, clk_name, parent_name, 0,\n\t\t\t\t\t  1, info.base_ahb_ratio);\n\tif (!IS_ERR(hw))\n\t\tof_clk_add_hw_provider(node, of_clk_hw_simple_get, hw);\n}\n\nstatic void __init nspire_ahbdiv_setup_cx(struct device_node *node)\n{\n\tnspire_ahbdiv_setup(node, nspire_clkinfo_cx);\n}\n\nstatic void __init nspire_ahbdiv_setup_classic(struct device_node *node)\n{\n\tnspire_ahbdiv_setup(node, nspire_clkinfo_classic);\n}\n\nCLK_OF_DECLARE(nspire_ahbdiv_cx, \"lsi,nspire-cx-ahb-divider\",\n\t\tnspire_ahbdiv_setup_cx);\nCLK_OF_DECLARE(nspire_ahbdiv_classic, \"lsi,nspire-classic-ahb-divider\",\n\t\tnspire_ahbdiv_setup_classic);\n\nstatic void __init nspire_clk_setup(struct device_node *node,\n\t\tvoid (*get_clkinfo)(u32, struct nspire_clk_info *))\n{\n\tu32 val;\n\tvoid __iomem *io;\n\tstruct clk_hw *hw;\n\tconst char *clk_name = node->name;\n\tstruct nspire_clk_info info;\n\n\tio = of_iomap(node, 0);\n\tif (!io)\n\t\treturn;\n\tval = readl(io);\n\tiounmap(io);\n\n\tget_clkinfo(val, &info);\n\n\tof_property_read_string(node, \"clock-output-names\", &clk_name);\n\n\thw = clk_hw_register_fixed_rate(NULL, clk_name, NULL, 0,\n\t\t\t\t\tinfo.base_clock);\n\tif (!IS_ERR(hw))\n\t\tof_clk_add_hw_provider(node, of_clk_hw_simple_get, hw);\n\telse\n\t\treturn;\n\n\tpr_info(\"TI-NSPIRE Base: %uMHz CPU: %uMHz AHB: %uMHz\\n\",\n\t\tinfo.base_clock / MHZ,\n\t\tinfo.base_clock / info.base_cpu_ratio / MHZ,\n\t\tinfo.base_clock / info.base_ahb_ratio / MHZ);\n}\n\nstatic void __init nspire_clk_setup_cx(struct device_node *node)\n{\n\tnspire_clk_setup(node, nspire_clkinfo_cx);\n}\n\nstatic void __init nspire_clk_setup_classic(struct device_node *node)\n{\n\tnspire_clk_setup(node, nspire_clkinfo_classic);\n}\n\nCLK_OF_DECLARE(nspire_clk_cx, \"lsi,nspire-cx-clock\", nspire_clk_setup_cx);\nCLK_OF_DECLARE(nspire_clk_classic, \"lsi,nspire-classic-clock\",\n\t\tnspire_clk_setup_classic);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}