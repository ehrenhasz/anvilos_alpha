{
  "module_name": "clk-dualdiv.c",
  "hash_id": "2a99eda57eb49dd0aea61977885f8c073752fa9d9844248be2cb3ffed33d8dea",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/meson/clk-dualdiv.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/clk-provider.h>\n#include <linux/module.h>\n\n#include \"clk-regmap.h\"\n#include \"clk-dualdiv.h\"\n\nstatic inline struct meson_clk_dualdiv_data *\nmeson_clk_dualdiv_data(struct clk_regmap *clk)\n{\n\treturn (struct meson_clk_dualdiv_data *)clk->data;\n}\n\nstatic unsigned long\n__dualdiv_param_to_rate(unsigned long parent_rate,\n\t\t\tconst struct meson_clk_dualdiv_param *p)\n{\n\tif (!p->dual)\n\t\treturn DIV_ROUND_CLOSEST(parent_rate, p->n1);\n\n\treturn DIV_ROUND_CLOSEST(parent_rate * (p->m1 + p->m2),\n\t\t\t\t p->n1 * p->m1 + p->n2 * p->m2);\n}\n\nstatic unsigned long meson_clk_dualdiv_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t\t   unsigned long parent_rate)\n{\n\tstruct clk_regmap *clk = to_clk_regmap(hw);\n\tstruct meson_clk_dualdiv_data *dualdiv = meson_clk_dualdiv_data(clk);\n\tstruct meson_clk_dualdiv_param setting;\n\n\tsetting.dual = meson_parm_read(clk->map, &dualdiv->dual);\n\tsetting.n1 = meson_parm_read(clk->map, &dualdiv->n1) + 1;\n\tsetting.m1 = meson_parm_read(clk->map, &dualdiv->m1) + 1;\n\tsetting.n2 = meson_parm_read(clk->map, &dualdiv->n2) + 1;\n\tsetting.m2 = meson_parm_read(clk->map, &dualdiv->m2) + 1;\n\n\treturn __dualdiv_param_to_rate(parent_rate, &setting);\n}\n\nstatic const struct meson_clk_dualdiv_param *\n__dualdiv_get_setting(unsigned long rate, unsigned long parent_rate,\n\t\t      struct meson_clk_dualdiv_data *dualdiv)\n{\n\tconst struct meson_clk_dualdiv_param *table = dualdiv->table;\n\tunsigned long best = 0, now = 0;\n\tunsigned int i, best_i = 0;\n\n\tif (!table)\n\t\treturn NULL;\n\n\tfor (i = 0; table[i].n1; i++) {\n\t\tnow = __dualdiv_param_to_rate(parent_rate, &table[i]);\n\n\t\t \n\t\tif (now == rate) {\n\t\t\treturn &table[i];\n\t\t} else if (abs(now - rate) < abs(best - rate)) {\n\t\t\tbest = now;\n\t\t\tbest_i = i;\n\t\t}\n\t}\n\n\treturn (struct meson_clk_dualdiv_param *)&table[best_i];\n}\n\nstatic int meson_clk_dualdiv_determine_rate(struct clk_hw *hw,\n\t\t\t\t\t    struct clk_rate_request *req)\n{\n\tstruct clk_regmap *clk = to_clk_regmap(hw);\n\tstruct meson_clk_dualdiv_data *dualdiv = meson_clk_dualdiv_data(clk);\n\tconst struct meson_clk_dualdiv_param *setting;\n\n\tsetting = __dualdiv_get_setting(req->rate, req->best_parent_rate,\n\t\t\t\t\tdualdiv);\n\tif (setting)\n\t\treq->rate = __dualdiv_param_to_rate(req->best_parent_rate,\n\t\t\t\t\t\t    setting);\n\telse\n\t\treq->rate = meson_clk_dualdiv_recalc_rate(hw,\n\t\t\t\t\t\t\t  req->best_parent_rate);\n\n\treturn 0;\n}\n\nstatic int meson_clk_dualdiv_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t      unsigned long parent_rate)\n{\n\tstruct clk_regmap *clk = to_clk_regmap(hw);\n\tstruct meson_clk_dualdiv_data *dualdiv = meson_clk_dualdiv_data(clk);\n\tconst struct meson_clk_dualdiv_param *setting =\n\t\t__dualdiv_get_setting(rate, parent_rate, dualdiv);\n\n\tif (!setting)\n\t\treturn -EINVAL;\n\n\tmeson_parm_write(clk->map, &dualdiv->dual, setting->dual);\n\tmeson_parm_write(clk->map, &dualdiv->n1, setting->n1 - 1);\n\tmeson_parm_write(clk->map, &dualdiv->m1, setting->m1 - 1);\n\tmeson_parm_write(clk->map, &dualdiv->n2, setting->n2 - 1);\n\tmeson_parm_write(clk->map, &dualdiv->m2, setting->m2 - 1);\n\n\treturn 0;\n}\n\nconst struct clk_ops meson_clk_dualdiv_ops = {\n\t.recalc_rate\t= meson_clk_dualdiv_recalc_rate,\n\t.determine_rate\t= meson_clk_dualdiv_determine_rate,\n\t.set_rate\t= meson_clk_dualdiv_set_rate,\n};\nEXPORT_SYMBOL_GPL(meson_clk_dualdiv_ops);\n\nconst struct clk_ops meson_clk_dualdiv_ro_ops = {\n\t.recalc_rate\t= meson_clk_dualdiv_recalc_rate,\n};\nEXPORT_SYMBOL_GPL(meson_clk_dualdiv_ro_ops);\n\nMODULE_DESCRIPTION(\"Amlogic dual divider driver\");\nMODULE_AUTHOR(\"Neil Armstrong <narmstrong@baylibre.com>\");\nMODULE_AUTHOR(\"Jerome Brunet <jbrunet@baylibre.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}