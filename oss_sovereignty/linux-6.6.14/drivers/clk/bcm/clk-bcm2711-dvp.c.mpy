{
  "module_name": "clk-bcm2711-dvp.c",
  "hash_id": "6f6a1a980ff349b9c45a4e436e38c75bdcba12d6f6859710e1de957fd76043e2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/bcm/clk-bcm2711-dvp.c",
  "human_readable_source": "\n\n\n#include <linux/clk-provider.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/reset-controller.h>\n#include <linux/reset/reset-simple.h>\n\n#define DVP_HT_RPI_SW_INIT\t0x04\n#define DVP_HT_RPI_MISC_CONFIG\t0x08\n\n#define NR_CLOCKS\t2\n#define NR_RESETS\t6\n\nstruct clk_dvp {\n\tstruct clk_hw_onecell_data\t*data;\n\tstruct reset_simple_data\treset;\n};\n\nstatic const struct clk_parent_data clk_dvp_parent = {\n\t.index\t= 0,\n};\n\nstatic int clk_dvp_probe(struct platform_device *pdev)\n{\n\tstruct clk_hw_onecell_data *data;\n\tstruct clk_dvp *dvp;\n\tvoid __iomem *base;\n\tint ret;\n\n\tdvp = devm_kzalloc(&pdev->dev, sizeof(*dvp), GFP_KERNEL);\n\tif (!dvp)\n\t\treturn -ENOMEM;\n\tplatform_set_drvdata(pdev, dvp);\n\n\tdvp->data = devm_kzalloc(&pdev->dev,\n\t\t\t\t struct_size(dvp->data, hws, NR_CLOCKS),\n\t\t\t\t GFP_KERNEL);\n\tif (!dvp->data)\n\t\treturn -ENOMEM;\n\tdata = dvp->data;\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tdvp->reset.rcdev.owner = THIS_MODULE;\n\tdvp->reset.rcdev.nr_resets = NR_RESETS;\n\tdvp->reset.rcdev.ops = &reset_simple_ops;\n\tdvp->reset.rcdev.of_node = pdev->dev.of_node;\n\tdvp->reset.membase = base + DVP_HT_RPI_SW_INIT;\n\tspin_lock_init(&dvp->reset.lock);\n\n\tret = devm_reset_controller_register(&pdev->dev, &dvp->reset.rcdev);\n\tif (ret)\n\t\treturn ret;\n\n\tdata->hws[0] = clk_hw_register_gate_parent_data(&pdev->dev,\n\t\t\t\t\t\t\t\"hdmi0-108MHz\",\n\t\t\t\t\t\t\t&clk_dvp_parent, 0,\n\t\t\t\t\t\t\tbase + DVP_HT_RPI_MISC_CONFIG, 3,\n\t\t\t\t\t\t\tCLK_GATE_SET_TO_DISABLE,\n\t\t\t\t\t\t\t&dvp->reset.lock);\n\tif (IS_ERR(data->hws[0]))\n\t\treturn PTR_ERR(data->hws[0]);\n\n\tdata->hws[1] = clk_hw_register_gate_parent_data(&pdev->dev,\n\t\t\t\t\t\t\t\"hdmi1-108MHz\",\n\t\t\t\t\t\t\t&clk_dvp_parent, 0,\n\t\t\t\t\t\t\tbase + DVP_HT_RPI_MISC_CONFIG, 4,\n\t\t\t\t\t\t\tCLK_GATE_SET_TO_DISABLE,\n\t\t\t\t\t\t\t&dvp->reset.lock);\n\tif (IS_ERR(data->hws[1])) {\n\t\tret = PTR_ERR(data->hws[1]);\n\t\tgoto unregister_clk0;\n\t}\n\n\tdata->num = NR_CLOCKS;\n\tret = of_clk_add_hw_provider(pdev->dev.of_node, of_clk_hw_onecell_get,\n\t\t\t\t     data);\n\tif (ret)\n\t\tgoto unregister_clk1;\n\n\treturn 0;\n\nunregister_clk1:\n\tclk_hw_unregister_gate(data->hws[1]);\n\nunregister_clk0:\n\tclk_hw_unregister_gate(data->hws[0]);\n\treturn ret;\n};\n\nstatic void clk_dvp_remove(struct platform_device *pdev)\n{\n\tstruct clk_dvp *dvp = platform_get_drvdata(pdev);\n\tstruct clk_hw_onecell_data *data = dvp->data;\n\n\tclk_hw_unregister_gate(data->hws[1]);\n\tclk_hw_unregister_gate(data->hws[0]);\n}\n\nstatic const struct of_device_id clk_dvp_dt_ids[] = {\n\t{ .compatible = \"brcm,brcm2711-dvp\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, clk_dvp_dt_ids);\n\nstatic struct platform_driver clk_dvp_driver = {\n\t.probe\t= clk_dvp_probe,\n\t.remove_new = clk_dvp_remove,\n\t.driver\t= {\n\t\t.name\t\t= \"brcm2711-dvp\",\n\t\t.of_match_table\t= clk_dvp_dt_ids,\n\t},\n};\nmodule_platform_driver(clk_dvp_driver);\n\nMODULE_AUTHOR(\"Maxime Ripard <maxime@cerno.tech>\");\nMODULE_DESCRIPTION(\"BCM2711 DVP clock driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}