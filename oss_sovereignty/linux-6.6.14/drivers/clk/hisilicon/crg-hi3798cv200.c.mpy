{
  "module_name": "crg-hi3798cv200.c",
  "hash_id": "642ab16cbf25ecd59e542675b49c205cc52a46a193ad6f475b906298e7b011b1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/hisilicon/crg-hi3798cv200.c",
  "human_readable_source": "\n \n\n#include <dt-bindings/clock/histb-clock.h>\n#include <linux/clk-provider.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include \"clk.h\"\n#include \"crg.h\"\n#include \"reset.h\"\n\n \n#define HI3798CV200_INNER_CLK_OFFSET\t\t64\n#define HI3798CV200_FIXED_24M\t\t\t65\n#define HI3798CV200_FIXED_25M\t\t\t66\n#define HI3798CV200_FIXED_50M\t\t\t67\n#define HI3798CV200_FIXED_75M\t\t\t68\n#define HI3798CV200_FIXED_100M\t\t\t69\n#define HI3798CV200_FIXED_150M\t\t\t70\n#define HI3798CV200_FIXED_200M\t\t\t71\n#define HI3798CV200_FIXED_250M\t\t\t72\n#define HI3798CV200_FIXED_300M\t\t\t73\n#define HI3798CV200_FIXED_400M\t\t\t74\n#define HI3798CV200_MMC_MUX\t\t\t75\n#define HI3798CV200_ETH_PUB_CLK\t\t\t76\n#define HI3798CV200_ETH_BUS_CLK\t\t\t77\n#define HI3798CV200_ETH_BUS0_CLK\t\t78\n#define HI3798CV200_ETH_BUS1_CLK\t\t79\n#define HI3798CV200_COMBPHY1_MUX\t\t80\n#define HI3798CV200_FIXED_12M\t\t\t81\n#define HI3798CV200_FIXED_48M\t\t\t82\n#define HI3798CV200_FIXED_60M\t\t\t83\n#define HI3798CV200_FIXED_166P5M\t\t84\n#define HI3798CV200_SDIO0_MUX\t\t\t85\n#define HI3798CV200_COMBPHY0_MUX\t\t86\n\n#define HI3798CV200_CRG_NR_CLKS\t\t\t128\n\nstatic const struct hisi_fixed_rate_clock hi3798cv200_fixed_rate_clks[] = {\n\t{ HISTB_OSC_CLK, \"clk_osc\", NULL, 0, 24000000, },\n\t{ HISTB_APB_CLK, \"clk_apb\", NULL, 0, 100000000, },\n\t{ HISTB_AHB_CLK, \"clk_ahb\", NULL, 0, 200000000, },\n\t{ HI3798CV200_FIXED_12M, \"12m\", NULL, 0, 12000000, },\n\t{ HI3798CV200_FIXED_24M, \"24m\", NULL, 0, 24000000, },\n\t{ HI3798CV200_FIXED_25M, \"25m\", NULL, 0, 25000000, },\n\t{ HI3798CV200_FIXED_48M, \"48m\", NULL, 0, 48000000, },\n\t{ HI3798CV200_FIXED_50M, \"50m\", NULL, 0, 50000000, },\n\t{ HI3798CV200_FIXED_60M, \"60m\", NULL, 0, 60000000, },\n\t{ HI3798CV200_FIXED_75M, \"75m\", NULL, 0, 75000000, },\n\t{ HI3798CV200_FIXED_100M, \"100m\", NULL, 0, 100000000, },\n\t{ HI3798CV200_FIXED_150M, \"150m\", NULL, 0, 150000000, },\n\t{ HI3798CV200_FIXED_166P5M, \"166p5m\", NULL, 0, 165000000, },\n\t{ HI3798CV200_FIXED_200M, \"200m\", NULL, 0, 200000000, },\n\t{ HI3798CV200_FIXED_250M, \"250m\", NULL, 0, 250000000, },\n};\n\nstatic const char *const mmc_mux_p[] = {\n\t\t\"100m\", \"50m\", \"25m\", \"200m\", \"150m\" };\nstatic u32 mmc_mux_table[] = {0, 1, 2, 3, 6};\n\nstatic const char *const comphy_mux_p[] = {\n\t\t\"100m\", \"25m\"};\nstatic u32 comphy_mux_table[] = {2, 3};\n\nstatic const char *const sdio_mux_p[] = {\n\t\t\"100m\", \"50m\", \"150m\", \"166p5m\" };\nstatic u32 sdio_mux_table[] = {0, 1, 2, 3};\n\nstatic struct hisi_mux_clock hi3798cv200_mux_clks[] = {\n\t{ HI3798CV200_MMC_MUX, \"mmc_mux\", mmc_mux_p, ARRAY_SIZE(mmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xa0, 8, 3, 0, mmc_mux_table, },\n\t{ HI3798CV200_COMBPHY0_MUX, \"combphy0_mux\",\n\t\tcomphy_mux_p, ARRAY_SIZE(comphy_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x188, 2, 2, 0, comphy_mux_table, },\n\t{ HI3798CV200_COMBPHY1_MUX, \"combphy1_mux\",\n\t\tcomphy_mux_p, ARRAY_SIZE(comphy_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x188, 10, 2, 0, comphy_mux_table, },\n\t{ HI3798CV200_SDIO0_MUX, \"sdio0_mux\", sdio_mux_p,\n\t\tARRAY_SIZE(sdio_mux_p), CLK_SET_RATE_PARENT,\n\t\t0x9c, 8, 2, 0, sdio_mux_table, },\n};\n\nstatic u32 mmc_phase_regvals[] = {0, 1, 2, 3, 4, 5, 6, 7};\nstatic u32 mmc_phase_degrees[] = {0, 45, 90, 135, 180, 225, 270, 315};\n\nstatic struct hisi_phase_clock hi3798cv200_phase_clks[] = {\n\t{ HISTB_MMC_SAMPLE_CLK, \"mmc_sample\", \"clk_mmc_ciu\",\n\t\tCLK_SET_RATE_PARENT, 0xa0, 12, 3, mmc_phase_degrees,\n\t\tmmc_phase_regvals, ARRAY_SIZE(mmc_phase_regvals) },\n\t{ HISTB_MMC_DRV_CLK, \"mmc_drive\", \"clk_mmc_ciu\",\n\t\tCLK_SET_RATE_PARENT, 0xa0, 16, 3, mmc_phase_degrees,\n\t\tmmc_phase_regvals, ARRAY_SIZE(mmc_phase_regvals) },\n};\n\nstatic const struct hisi_gate_clock hi3798cv200_gate_clks[] = {\n\t \n\t{ HISTB_UART2_CLK, \"clk_uart2\", \"75m\",\n\t\tCLK_SET_RATE_PARENT, 0x68, 4, 0, },\n\t \n\t{ HISTB_I2C0_CLK, \"clk_i2c0\", \"clk_apb\",\n\t\tCLK_SET_RATE_PARENT, 0x6C, 4, 0, },\n\t{ HISTB_I2C1_CLK, \"clk_i2c1\", \"clk_apb\",\n\t\tCLK_SET_RATE_PARENT, 0x6C, 8, 0, },\n\t{ HISTB_I2C2_CLK, \"clk_i2c2\", \"clk_apb\",\n\t\tCLK_SET_RATE_PARENT, 0x6C, 12, 0, },\n\t{ HISTB_I2C3_CLK, \"clk_i2c3\", \"clk_apb\",\n\t\tCLK_SET_RATE_PARENT, 0x6C, 16, 0, },\n\t{ HISTB_I2C4_CLK, \"clk_i2c4\", \"clk_apb\",\n\t\tCLK_SET_RATE_PARENT, 0x6C, 20, 0, },\n\t \n\t{ HISTB_SPI0_CLK, \"clk_spi0\", \"clk_apb\",\n\t\tCLK_SET_RATE_PARENT, 0x70, 0, 0, },\n\t \n\t{ HISTB_SDIO0_BIU_CLK, \"clk_sdio0_biu\", \"200m\",\n\t\t\tCLK_SET_RATE_PARENT, 0x9c, 0, 0, },\n\t{ HISTB_SDIO0_CIU_CLK, \"clk_sdio0_ciu\", \"sdio0_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x9c, 1, 0, },\n\t \n\t{ HISTB_MMC_BIU_CLK, \"clk_mmc_biu\", \"200m\",\n\t\tCLK_SET_RATE_PARENT, 0xa0, 0, 0, },\n\t{ HISTB_MMC_CIU_CLK, \"clk_mmc_ciu\", \"mmc_mux\",\n\t\tCLK_SET_RATE_PARENT, 0xa0, 1, 0, },\n\t \n\t{ HISTB_PCIE_BUS_CLK, \"clk_pcie_bus\", \"200m\",\n\t\tCLK_SET_RATE_PARENT, 0x18c, 0, 0, },\n\t{ HISTB_PCIE_SYS_CLK, \"clk_pcie_sys\", \"100m\",\n\t\tCLK_SET_RATE_PARENT, 0x18c, 1, 0, },\n\t{ HISTB_PCIE_PIPE_CLK, \"clk_pcie_pipe\", \"250m\",\n\t\tCLK_SET_RATE_PARENT, 0x18c, 2, 0, },\n\t{ HISTB_PCIE_AUX_CLK, \"clk_pcie_aux\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0x18c, 3, 0, },\n\t \n\t{ HI3798CV200_ETH_PUB_CLK, \"clk_pub\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0xcc, 5, 0, },\n\t{ HI3798CV200_ETH_BUS_CLK, \"clk_bus\", \"clk_pub\",\n\t\tCLK_SET_RATE_PARENT, 0xcc, 0, 0, },\n\t{ HI3798CV200_ETH_BUS0_CLK, \"clk_bus_m0\", \"clk_bus\",\n\t\tCLK_SET_RATE_PARENT, 0xcc, 1, 0, },\n\t{ HI3798CV200_ETH_BUS1_CLK, \"clk_bus_m1\", \"clk_bus\",\n\t\tCLK_SET_RATE_PARENT, 0xcc, 2, 0, },\n\t{ HISTB_ETH0_MAC_CLK, \"clk_mac0\", \"clk_bus_m0\",\n\t\tCLK_SET_RATE_PARENT, 0xcc, 3, 0, },\n\t{ HISTB_ETH0_MACIF_CLK, \"clk_macif0\", \"clk_bus_m0\",\n\t\tCLK_SET_RATE_PARENT, 0xcc, 24, 0, },\n\t{ HISTB_ETH1_MAC_CLK, \"clk_mac1\", \"clk_bus_m1\",\n\t\tCLK_SET_RATE_PARENT, 0xcc, 4, 0, },\n\t{ HISTB_ETH1_MACIF_CLK, \"clk_macif1\", \"clk_bus_m1\",\n\t\tCLK_SET_RATE_PARENT, 0xcc, 25, 0, },\n\t \n\t{ HISTB_COMBPHY0_CLK, \"clk_combphy0\", \"combphy0_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x188, 0, 0, },\n\t \n\t{ HISTB_COMBPHY1_CLK, \"clk_combphy1\", \"combphy1_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x188, 8, 0, },\n\t \n\t{ HISTB_USB2_BUS_CLK, \"clk_u2_bus\", \"clk_ahb\",\n\t\tCLK_SET_RATE_PARENT, 0xb8, 0, 0, },\n\t{ HISTB_USB2_PHY_CLK, \"clk_u2_phy\", \"60m\",\n\t\tCLK_SET_RATE_PARENT, 0xb8, 4, 0, },\n\t{ HISTB_USB2_12M_CLK, \"clk_u2_12m\", \"12m\",\n\t\tCLK_SET_RATE_PARENT, 0xb8, 2, 0 },\n\t{ HISTB_USB2_48M_CLK, \"clk_u2_48m\", \"48m\",\n\t\tCLK_SET_RATE_PARENT, 0xb8, 1, 0 },\n\t{ HISTB_USB2_UTMI_CLK, \"clk_u2_utmi\", \"60m\",\n\t\tCLK_SET_RATE_PARENT, 0xb8, 5, 0 },\n\t{ HISTB_USB2_OTG_UTMI_CLK, \"clk_u2_otg_utmi\", \"60m\",\n\t\tCLK_SET_RATE_PARENT, 0xb8, 3, 0 },\n\t{ HISTB_USB2_PHY1_REF_CLK, \"clk_u2_phy1_ref\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0xbc, 0, 0 },\n\t{ HISTB_USB2_PHY2_REF_CLK, \"clk_u2_phy2_ref\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0xbc, 2, 0 },\n\t \n\t{ HISTB_USB3_BUS_CLK, \"clk_u3_bus\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0xb0, 0, 0 },\n\t{ HISTB_USB3_UTMI_CLK, \"clk_u3_utmi\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0xb0, 4, 0 },\n\t{ HISTB_USB3_PIPE_CLK, \"clk_u3_pipe\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0xb0, 3, 0 },\n\t{ HISTB_USB3_SUSPEND_CLK, \"clk_u3_suspend\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0xb0, 2, 0 },\n\t{ HISTB_USB3_BUS_CLK1, \"clk_u3_bus1\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0xb0, 16, 0 },\n\t{ HISTB_USB3_UTMI_CLK1, \"clk_u3_utmi1\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0xb0, 20, 0 },\n\t{ HISTB_USB3_PIPE_CLK1, \"clk_u3_pipe1\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0xb0, 19, 0 },\n\t{ HISTB_USB3_SUSPEND_CLK1, \"clk_u3_suspend1\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0xb0, 18, 0 },\n};\n\nstatic struct hisi_clock_data *hi3798cv200_clk_register(\n\t\t\t\tstruct platform_device *pdev)\n{\n\tstruct hisi_clock_data *clk_data;\n\tint ret;\n\n\tclk_data = hisi_clk_alloc(pdev, HI3798CV200_CRG_NR_CLKS);\n\tif (!clk_data)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\t \n\tret = hisi_clk_register_phase(&pdev->dev,\n\t\t\t\thi3798cv200_phase_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_phase_clks),\n\t\t\t\tclk_data);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\tret = hisi_clk_register_fixed_rate(hi3798cv200_fixed_rate_clks,\n\t\t\t\t     ARRAY_SIZE(hi3798cv200_fixed_rate_clks),\n\t\t\t\t     clk_data);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\tret = hisi_clk_register_mux(hi3798cv200_mux_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_mux_clks),\n\t\t\t\tclk_data);\n\tif (ret)\n\t\tgoto unregister_fixed_rate;\n\n\tret = hisi_clk_register_gate(hi3798cv200_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_gate_clks),\n\t\t\t\tclk_data);\n\tif (ret)\n\t\tgoto unregister_mux;\n\n\tret = of_clk_add_provider(pdev->dev.of_node,\n\t\t\tof_clk_src_onecell_get, &clk_data->clk_data);\n\tif (ret)\n\t\tgoto unregister_gate;\n\n\treturn clk_data;\n\nunregister_gate:\n\thisi_clk_unregister_gate(hi3798cv200_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_gate_clks),\n\t\t\t\tclk_data);\nunregister_mux:\n\thisi_clk_unregister_mux(hi3798cv200_mux_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_mux_clks),\n\t\t\t\tclk_data);\nunregister_fixed_rate:\n\thisi_clk_unregister_fixed_rate(hi3798cv200_fixed_rate_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_fixed_rate_clks),\n\t\t\t\tclk_data);\n\treturn ERR_PTR(ret);\n}\n\nstatic void hi3798cv200_clk_unregister(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(pdev->dev.of_node);\n\n\thisi_clk_unregister_gate(hi3798cv200_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_gate_clks),\n\t\t\t\tcrg->clk_data);\n\thisi_clk_unregister_mux(hi3798cv200_mux_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_mux_clks),\n\t\t\t\tcrg->clk_data);\n\thisi_clk_unregister_fixed_rate(hi3798cv200_fixed_rate_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_fixed_rate_clks),\n\t\t\t\tcrg->clk_data);\n}\n\nstatic const struct hisi_crg_funcs hi3798cv200_crg_funcs = {\n\t.register_clks = hi3798cv200_clk_register,\n\t.unregister_clks = hi3798cv200_clk_unregister,\n};\n\n \n\n#define HI3798CV200_SYSCTRL_NR_CLKS 16\n\nstatic const struct hisi_gate_clock hi3798cv200_sysctrl_gate_clks[] = {\n\t{ HISTB_IR_CLK, \"clk_ir\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0x48, 4, 0, },\n\t{ HISTB_TIMER01_CLK, \"clk_timer01\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0x48, 6, 0, },\n\t{ HISTB_UART0_CLK, \"clk_uart0\", \"75m\",\n\t\tCLK_SET_RATE_PARENT, 0x48, 10, 0, },\n};\n\nstatic struct hisi_clock_data *hi3798cv200_sysctrl_clk_register(\n\t\t\t\t\tstruct platform_device *pdev)\n{\n\tstruct hisi_clock_data *clk_data;\n\tint ret;\n\n\tclk_data = hisi_clk_alloc(pdev, HI3798CV200_SYSCTRL_NR_CLKS);\n\tif (!clk_data)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tret = hisi_clk_register_gate(hi3798cv200_sysctrl_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_sysctrl_gate_clks),\n\t\t\t\tclk_data);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\tret = of_clk_add_provider(pdev->dev.of_node,\n\t\t\tof_clk_src_onecell_get, &clk_data->clk_data);\n\tif (ret)\n\t\tgoto unregister_gate;\n\n\treturn clk_data;\n\nunregister_gate:\n\thisi_clk_unregister_gate(hi3798cv200_sysctrl_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_sysctrl_gate_clks),\n\t\t\t\tclk_data);\n\treturn ERR_PTR(ret);\n}\n\nstatic void hi3798cv200_sysctrl_clk_unregister(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(pdev->dev.of_node);\n\n\thisi_clk_unregister_gate(hi3798cv200_sysctrl_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3798cv200_sysctrl_gate_clks),\n\t\t\t\tcrg->clk_data);\n}\n\nstatic const struct hisi_crg_funcs hi3798cv200_sysctrl_funcs = {\n\t.register_clks = hi3798cv200_sysctrl_clk_register,\n\t.unregister_clks = hi3798cv200_sysctrl_clk_unregister,\n};\n\nstatic const struct of_device_id hi3798cv200_crg_match_table[] = {\n\t{ .compatible = \"hisilicon,hi3798cv200-crg\",\n\t\t.data = &hi3798cv200_crg_funcs },\n\t{ .compatible = \"hisilicon,hi3798cv200-sysctrl\",\n\t\t.data = &hi3798cv200_sysctrl_funcs },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, hi3798cv200_crg_match_table);\n\nstatic int hi3798cv200_crg_probe(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg;\n\n\tcrg = devm_kmalloc(&pdev->dev, sizeof(*crg), GFP_KERNEL);\n\tif (!crg)\n\t\treturn -ENOMEM;\n\n\tcrg->funcs = of_device_get_match_data(&pdev->dev);\n\tif (!crg->funcs)\n\t\treturn -ENOENT;\n\n\tcrg->rstc = hisi_reset_init(pdev);\n\tif (!crg->rstc)\n\t\treturn -ENOMEM;\n\n\tcrg->clk_data = crg->funcs->register_clks(pdev);\n\tif (IS_ERR(crg->clk_data)) {\n\t\thisi_reset_exit(crg->rstc);\n\t\treturn PTR_ERR(crg->clk_data);\n\t}\n\n\tplatform_set_drvdata(pdev, crg);\n\treturn 0;\n}\n\nstatic void hi3798cv200_crg_remove(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\n\n\thisi_reset_exit(crg->rstc);\n\tcrg->funcs->unregister_clks(pdev);\n}\n\nstatic struct platform_driver hi3798cv200_crg_driver = {\n\t.probe          = hi3798cv200_crg_probe,\n\t.remove_new\t= hi3798cv200_crg_remove,\n\t.driver         = {\n\t\t.name   = \"hi3798cv200-crg\",\n\t\t.of_match_table = hi3798cv200_crg_match_table,\n\t},\n};\n\nstatic int __init hi3798cv200_crg_init(void)\n{\n\treturn platform_driver_register(&hi3798cv200_crg_driver);\n}\ncore_initcall(hi3798cv200_crg_init);\n\nstatic void __exit hi3798cv200_crg_exit(void)\n{\n\tplatform_driver_unregister(&hi3798cv200_crg_driver);\n}\nmodule_exit(hi3798cv200_crg_exit);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"HiSilicon Hi3798CV200 CRG Driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}