{
  "module_name": "clk-hi3519.c",
  "hash_id": "44f2251075468b49560fd6629a5a1a7fb1cc6ff3e0cf80b823a70df91306c959",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/hisilicon/clk-hi3519.c",
  "human_readable_source": "\n \n\n#include <dt-bindings/clock/hi3519-clock.h>\n#include <linux/clk-provider.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include \"clk.h\"\n#include \"reset.h\"\n\n#define HI3519_INNER_CLK_OFFSET\t64\n#define HI3519_FIXED_24M\t65\n#define HI3519_FIXED_50M\t66\n#define HI3519_FIXED_75M\t67\n#define HI3519_FIXED_125M\t68\n#define HI3519_FIXED_150M\t69\n#define HI3519_FIXED_200M\t70\n#define HI3519_FIXED_250M\t71\n#define HI3519_FIXED_300M\t72\n#define HI3519_FIXED_400M\t73\n#define HI3519_FMC_MUX\t\t74\n\n#define HI3519_NR_CLKS\t\t128\n\nstruct hi3519_crg_data {\n\tstruct hisi_clock_data *clk_data;\n\tstruct hisi_reset_controller *rstc;\n};\n\nstatic const struct hisi_fixed_rate_clock hi3519_fixed_rate_clks[] = {\n\t{ HI3519_FIXED_24M, \"24m\", NULL, 0, 24000000, },\n\t{ HI3519_FIXED_50M, \"50m\", NULL, 0, 50000000, },\n\t{ HI3519_FIXED_75M, \"75m\", NULL, 0, 75000000, },\n\t{ HI3519_FIXED_125M, \"125m\", NULL, 0, 125000000, },\n\t{ HI3519_FIXED_150M, \"150m\", NULL, 0, 150000000, },\n\t{ HI3519_FIXED_200M, \"200m\", NULL, 0, 200000000, },\n\t{ HI3519_FIXED_250M, \"250m\", NULL, 0, 250000000, },\n\t{ HI3519_FIXED_300M, \"300m\", NULL, 0, 300000000, },\n\t{ HI3519_FIXED_400M, \"400m\", NULL, 0, 400000000, },\n};\n\nstatic const char *const fmc_mux_p[] = {\n\t\t\"24m\", \"75m\", \"125m\", \"150m\", \"200m\", \"250m\", \"300m\", \"400m\", };\nstatic u32 fmc_mux_table[] = {0, 1, 2, 3, 4, 5, 6, 7};\n\nstatic const struct hisi_mux_clock hi3519_mux_clks[] = {\n\t{ HI3519_FMC_MUX, \"fmc_mux\", fmc_mux_p, ARRAY_SIZE(fmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xc0, 2, 3, 0, fmc_mux_table, },\n};\n\nstatic const struct hisi_gate_clock hi3519_gate_clks[] = {\n\t{ HI3519_FMC_CLK, \"clk_fmc\", \"fmc_mux\",\n\t\tCLK_SET_RATE_PARENT, 0xc0, 1, 0, },\n\t{ HI3519_UART0_CLK, \"clk_uart0\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0xe4, 20, 0, },\n\t{ HI3519_UART1_CLK, \"clk_uart1\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0xe4, 21, 0, },\n\t{ HI3519_UART2_CLK, \"clk_uart2\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0xe4, 22, 0, },\n\t{ HI3519_UART3_CLK, \"clk_uart3\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0xe4, 23, 0, },\n\t{ HI3519_UART4_CLK, \"clk_uart4\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0xe4, 24, 0, },\n\t{ HI3519_SPI0_CLK, \"clk_spi0\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0xe4, 16, 0, },\n\t{ HI3519_SPI1_CLK, \"clk_spi1\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0xe4, 17, 0, },\n\t{ HI3519_SPI2_CLK, \"clk_spi2\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0xe4, 18, 0, },\n};\n\nstatic struct hisi_clock_data *hi3519_clk_register(struct platform_device *pdev)\n{\n\tstruct hisi_clock_data *clk_data;\n\tint ret;\n\n\tclk_data = hisi_clk_alloc(pdev, HI3519_NR_CLKS);\n\tif (!clk_data)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tret = hisi_clk_register_fixed_rate(hi3519_fixed_rate_clks,\n\t\t\t\t     ARRAY_SIZE(hi3519_fixed_rate_clks),\n\t\t\t\t     clk_data);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\tret = hisi_clk_register_mux(hi3519_mux_clks,\n\t\t\t\tARRAY_SIZE(hi3519_mux_clks),\n\t\t\t\tclk_data);\n\tif (ret)\n\t\tgoto unregister_fixed_rate;\n\n\tret = hisi_clk_register_gate(hi3519_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3519_gate_clks),\n\t\t\t\tclk_data);\n\tif (ret)\n\t\tgoto unregister_mux;\n\n\tret = of_clk_add_provider(pdev->dev.of_node,\n\t\t\tof_clk_src_onecell_get, &clk_data->clk_data);\n\tif (ret)\n\t\tgoto unregister_gate;\n\n\treturn clk_data;\n\nunregister_fixed_rate:\n\thisi_clk_unregister_fixed_rate(hi3519_fixed_rate_clks,\n\t\t\t\tARRAY_SIZE(hi3519_fixed_rate_clks),\n\t\t\t\tclk_data);\n\nunregister_mux:\n\thisi_clk_unregister_mux(hi3519_mux_clks,\n\t\t\t\tARRAY_SIZE(hi3519_mux_clks),\n\t\t\t\tclk_data);\nunregister_gate:\n\thisi_clk_unregister_gate(hi3519_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3519_gate_clks),\n\t\t\t\tclk_data);\n\treturn ERR_PTR(ret);\n}\n\nstatic void hi3519_clk_unregister(struct platform_device *pdev)\n{\n\tstruct hi3519_crg_data *crg = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(pdev->dev.of_node);\n\n\thisi_clk_unregister_gate(hi3519_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3519_mux_clks),\n\t\t\t\tcrg->clk_data);\n\thisi_clk_unregister_mux(hi3519_mux_clks,\n\t\t\t\tARRAY_SIZE(hi3519_mux_clks),\n\t\t\t\tcrg->clk_data);\n\thisi_clk_unregister_fixed_rate(hi3519_fixed_rate_clks,\n\t\t\t\tARRAY_SIZE(hi3519_fixed_rate_clks),\n\t\t\t\tcrg->clk_data);\n}\n\nstatic int hi3519_clk_probe(struct platform_device *pdev)\n{\n\tstruct hi3519_crg_data *crg;\n\n\tcrg = devm_kmalloc(&pdev->dev, sizeof(*crg), GFP_KERNEL);\n\tif (!crg)\n\t\treturn -ENOMEM;\n\n\tcrg->rstc = hisi_reset_init(pdev);\n\tif (!crg->rstc)\n\t\treturn -ENOMEM;\n\n\tcrg->clk_data = hi3519_clk_register(pdev);\n\tif (IS_ERR(crg->clk_data)) {\n\t\thisi_reset_exit(crg->rstc);\n\t\treturn PTR_ERR(crg->clk_data);\n\t}\n\n\tplatform_set_drvdata(pdev, crg);\n\treturn 0;\n}\n\nstatic void hi3519_clk_remove(struct platform_device *pdev)\n{\n\tstruct hi3519_crg_data *crg = platform_get_drvdata(pdev);\n\n\thisi_reset_exit(crg->rstc);\n\thi3519_clk_unregister(pdev);\n}\n\n\nstatic const struct of_device_id hi3519_clk_match_table[] = {\n\t{ .compatible = \"hisilicon,hi3519-crg\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, hi3519_clk_match_table);\n\nstatic struct platform_driver hi3519_clk_driver = {\n\t.probe          = hi3519_clk_probe,\n\t.remove_new\t= hi3519_clk_remove,\n\t.driver         = {\n\t\t.name   = \"hi3519-clk\",\n\t\t.of_match_table = hi3519_clk_match_table,\n\t},\n};\n\nstatic int __init hi3519_clk_init(void)\n{\n\treturn platform_driver_register(&hi3519_clk_driver);\n}\ncore_initcall(hi3519_clk_init);\n\nstatic void __exit hi3519_clk_exit(void)\n{\n\tplatform_driver_unregister(&hi3519_clk_driver);\n}\nmodule_exit(hi3519_clk_exit);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"HiSilicon Hi3519 Clock Driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}