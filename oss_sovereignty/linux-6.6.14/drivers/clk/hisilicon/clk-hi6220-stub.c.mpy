{
  "module_name": "clk-hi6220-stub.c",
  "hash_id": "94e0c941f388a3bf63cfd5d3c218aac14ff97ca89e831acdfdb4da283d956f32",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/hisilicon/clk-hi6220-stub.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/mfd/syscon.h>\n#include <linux/mailbox_client.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n \n#define HI6220_STUB_ACPU0\t\t0\n#define HI6220_STUB_ACPU1\t\t1\n#define HI6220_STUB_GPU\t\t\t2\n#define HI6220_STUB_DDR\t\t\t5\n\n \n#define HI6220_MBOX_MSG_LEN\t\t8\n\n#define HI6220_MBOX_FREQ\t\t0xA\n#define HI6220_MBOX_CMD_SET\t\t0x3\n#define HI6220_MBOX_OBJ_AP\t\t0x0\n\n \n#define ACPU_DFS_FREQ_MAX\t\t0x1724\n#define ACPU_DFS_CUR_FREQ\t\t0x17CC\n#define ACPU_DFS_FLAG\t\t\t0x1B30\n#define ACPU_DFS_FREQ_REQ\t\t0x1B34\n#define ACPU_DFS_FREQ_LMT\t\t0x1B38\n#define ACPU_DFS_LOCK_FLAG\t\t0xAEAEAEAE\n\n#define to_stub_clk(hw) container_of(hw, struct hi6220_stub_clk, hw)\n\nstruct hi6220_stub_clk {\n\tu32 id;\n\n\tstruct device *dev;\n\tstruct clk_hw hw;\n\n\tstruct regmap *dfs_map;\n\tstruct mbox_client cl;\n\tstruct mbox_chan *mbox;\n};\n\nstruct hi6220_mbox_msg {\n\tunsigned char type;\n\tunsigned char cmd;\n\tunsigned char obj;\n\tunsigned char src;\n\tunsigned char para[4];\n};\n\nunion hi6220_mbox_data {\n\tunsigned int data[HI6220_MBOX_MSG_LEN];\n\tstruct hi6220_mbox_msg msg;\n};\n\nstatic unsigned int hi6220_acpu_get_freq(struct hi6220_stub_clk *stub_clk)\n{\n\tunsigned int freq;\n\n\tregmap_read(stub_clk->dfs_map, ACPU_DFS_CUR_FREQ, &freq);\n\treturn freq;\n}\n\nstatic int hi6220_acpu_set_freq(struct hi6220_stub_clk *stub_clk,\n\t\t\t\tunsigned int freq)\n{\n\tunion hi6220_mbox_data data;\n\n\t \n\tregmap_write(stub_clk->dfs_map, ACPU_DFS_FREQ_REQ, freq);\n\n\t \n\tdata.msg.type = HI6220_MBOX_FREQ;\n\tdata.msg.cmd  = HI6220_MBOX_CMD_SET;\n\tdata.msg.obj  = HI6220_MBOX_OBJ_AP;\n\tdata.msg.src  = HI6220_MBOX_OBJ_AP;\n\n\tmbox_send_message(stub_clk->mbox, &data);\n\treturn 0;\n}\n\nstatic int hi6220_acpu_round_freq(struct hi6220_stub_clk *stub_clk,\n\t\t\t\t  unsigned int freq)\n{\n\tunsigned int limit_flag, limit_freq = UINT_MAX;\n\tunsigned int max_freq;\n\n\t \n\tregmap_read(stub_clk->dfs_map, ACPU_DFS_FLAG, &limit_flag);\n\tif (limit_flag == ACPU_DFS_LOCK_FLAG)\n\t\tregmap_read(stub_clk->dfs_map, ACPU_DFS_FREQ_LMT, &limit_freq);\n\n\t \n\tregmap_read(stub_clk->dfs_map, ACPU_DFS_FREQ_MAX, &max_freq);\n\n\t \n\tmax_freq = min(max_freq, limit_freq);\n\n\tif (WARN_ON(freq > max_freq))\n\t\tfreq = max_freq;\n\n\treturn freq;\n}\n\nstatic unsigned long hi6220_stub_clk_recalc_rate(struct clk_hw *hw,\n\t\tunsigned long parent_rate)\n{\n\tu32 rate = 0;\n\tstruct hi6220_stub_clk *stub_clk = to_stub_clk(hw);\n\n\tswitch (stub_clk->id) {\n\tcase HI6220_STUB_ACPU0:\n\t\trate = hi6220_acpu_get_freq(stub_clk);\n\n\t\t \n\t\trate *= 1000;\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(stub_clk->dev, \"%s: un-supported clock id %d\\n\",\n\t\t\t__func__, stub_clk->id);\n\t\tbreak;\n\t}\n\n\treturn rate;\n}\n\nstatic int hi6220_stub_clk_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\tunsigned long parent_rate)\n{\n\tstruct hi6220_stub_clk *stub_clk = to_stub_clk(hw);\n\tunsigned long new_rate = rate / 1000;   \n\tint ret = 0;\n\n\tswitch (stub_clk->id) {\n\tcase HI6220_STUB_ACPU0:\n\t\tret = hi6220_acpu_set_freq(stub_clk, new_rate);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(stub_clk->dev, \"%s: un-supported clock id %d\\n\",\n\t\t\t__func__, stub_clk->id);\n\t\tbreak;\n\t}\n\n\tpr_debug(\"%s: set rate=%ldkHz\\n\", __func__, new_rate);\n\treturn ret;\n}\n\nstatic long hi6220_stub_clk_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\tunsigned long *parent_rate)\n{\n\tstruct hi6220_stub_clk *stub_clk = to_stub_clk(hw);\n\tunsigned long new_rate = rate / 1000;   \n\n\tswitch (stub_clk->id) {\n\tcase HI6220_STUB_ACPU0:\n\t\tnew_rate = hi6220_acpu_round_freq(stub_clk, new_rate);\n\n\t\t \n\t\tnew_rate *= 1000;\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(stub_clk->dev, \"%s: un-supported clock id %d\\n\",\n\t\t\t__func__, stub_clk->id);\n\t\tbreak;\n\t}\n\n\treturn new_rate;\n}\n\nstatic const struct clk_ops hi6220_stub_clk_ops = {\n\t.recalc_rate\t= hi6220_stub_clk_recalc_rate,\n\t.round_rate\t= hi6220_stub_clk_round_rate,\n\t.set_rate\t= hi6220_stub_clk_set_rate,\n};\n\nstatic int hi6220_stub_clk_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct clk_init_data init;\n\tstruct hi6220_stub_clk *stub_clk;\n\tstruct clk *clk;\n\tstruct device_node *np = pdev->dev.of_node;\n\tint ret;\n\n\tstub_clk = devm_kzalloc(dev, sizeof(*stub_clk), GFP_KERNEL);\n\tif (!stub_clk)\n\t\treturn -ENOMEM;\n\n\tstub_clk->dfs_map = syscon_regmap_lookup_by_phandle(np,\n\t\t\t\t\"hisilicon,hi6220-clk-sram\");\n\tif (IS_ERR(stub_clk->dfs_map)) {\n\t\tdev_err(dev, \"failed to get sram regmap\\n\");\n\t\treturn PTR_ERR(stub_clk->dfs_map);\n\t}\n\n\tstub_clk->hw.init = &init;\n\tstub_clk->dev = dev;\n\tstub_clk->id = HI6220_STUB_ACPU0;\n\n\t \n\tstub_clk->cl.dev = dev;\n\tstub_clk->cl.tx_done = NULL;\n\tstub_clk->cl.tx_block = true;\n\tstub_clk->cl.tx_tout = 500;\n\tstub_clk->cl.knows_txdone = false;\n\n\t \n\tstub_clk->mbox = mbox_request_channel(&stub_clk->cl, 0);\n\tif (IS_ERR(stub_clk->mbox)) {\n\t\tdev_err(dev, \"failed get mailbox channel\\n\");\n\t\treturn PTR_ERR(stub_clk->mbox);\n\t}\n\n\tinit.name = \"acpu0\";\n\tinit.ops = &hi6220_stub_clk_ops;\n\tinit.num_parents = 0;\n\tinit.flags = 0;\n\n\tclk = devm_clk_register(dev, &stub_clk->hw);\n\tif (IS_ERR(clk))\n\t\treturn PTR_ERR(clk);\n\n\tret = of_clk_add_provider(np, of_clk_src_simple_get, clk);\n\tif (ret) {\n\t\tdev_err(dev, \"failed to register OF clock provider\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tregmap_write(stub_clk->dfs_map, ACPU_DFS_FLAG, 0x0);\n\tregmap_write(stub_clk->dfs_map, ACPU_DFS_FREQ_REQ, 0x0);\n\tregmap_write(stub_clk->dfs_map, ACPU_DFS_FREQ_LMT, 0x0);\n\n\tdev_dbg(dev, \"Registered clock '%s'\\n\", init.name);\n\treturn 0;\n}\n\nstatic const struct of_device_id hi6220_stub_clk_of_match[] = {\n\t{ .compatible = \"hisilicon,hi6220-stub-clk\", },\n\t{}\n};\n\nstatic struct platform_driver hi6220_stub_clk_driver = {\n\t.driver\t= {\n\t\t.name = \"hi6220-stub-clk\",\n\t\t.of_match_table = hi6220_stub_clk_of_match,\n\t},\n\t.probe = hi6220_stub_clk_probe,\n};\n\nstatic int __init hi6220_stub_clk_init(void)\n{\n\treturn platform_driver_register(&hi6220_stub_clk_driver);\n}\nsubsys_initcall(hi6220_stub_clk_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}