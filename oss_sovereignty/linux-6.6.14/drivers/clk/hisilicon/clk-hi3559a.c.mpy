{
  "module_name": "clk-hi3559a.c",
  "hash_id": "3bfd55cc63a978e76ab65debd1e92cfac19f04e1994aefdfbb7059a7b725c2a3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/hisilicon/clk-hi3559a.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\n#include <dt-bindings/clock/hi3559av100-clock.h>\n\n#include \"clk.h\"\n#include \"crg.h\"\n#include \"reset.h\"\n\n#define CRG_BASE_ADDR  0x18020000\n#define PLL_MASK_WIDTH 24\n\nstruct hi3559av100_pll_clock {\n\tu32\tid;\n\tconst char\t*name;\n\tconst char\t*parent_name;\n\tconst u32\tctrl_reg1;\n\tconst u8\tfrac_shift;\n\tconst u8\tfrac_width;\n\tconst u8\tpostdiv1_shift;\n\tconst u8\tpostdiv1_width;\n\tconst u8\tpostdiv2_shift;\n\tconst u8\tpostdiv2_width;\n\tconst u32\tctrl_reg2;\n\tconst u8\tfbdiv_shift;\n\tconst u8\tfbdiv_width;\n\tconst u8\trefdiv_shift;\n\tconst u8\trefdiv_width;\n};\n\nstruct hi3559av100_clk_pll {\n\tstruct clk_hw\thw;\n\tu32\tid;\n\tvoid __iomem\t*ctrl_reg1;\n\tu8\tfrac_shift;\n\tu8\tfrac_width;\n\tu8\tpostdiv1_shift;\n\tu8\tpostdiv1_width;\n\tu8\tpostdiv2_shift;\n\tu8\tpostdiv2_width;\n\tvoid __iomem\t*ctrl_reg2;\n\tu8\tfbdiv_shift;\n\tu8\tfbdiv_width;\n\tu8\trefdiv_shift;\n\tu8\trefdiv_width;\n};\n\n \nstatic const struct hisi_fixed_rate_clock hi3559av100_fixed_rate_clks_crg[] = {\n\t{ HI3559AV100_FIXED_1188M, \"1188m\", NULL, 0, 1188000000, },\n\t{ HI3559AV100_FIXED_1000M, \"1000m\", NULL, 0, 1000000000, },\n\t{ HI3559AV100_FIXED_842M, \"842m\", NULL, 0, 842000000, },\n\t{ HI3559AV100_FIXED_792M, \"792m\", NULL, 0, 792000000, },\n\t{ HI3559AV100_FIXED_750M, \"750m\", NULL, 0, 750000000, },\n\t{ HI3559AV100_FIXED_710M, \"710m\", NULL, 0, 710000000, },\n\t{ HI3559AV100_FIXED_680M, \"680m\", NULL, 0, 680000000, },\n\t{ HI3559AV100_FIXED_667M, \"667m\", NULL, 0, 667000000, },\n\t{ HI3559AV100_FIXED_631M, \"631m\", NULL, 0, 631000000, },\n\t{ HI3559AV100_FIXED_600M, \"600m\", NULL, 0, 600000000, },\n\t{ HI3559AV100_FIXED_568M, \"568m\", NULL, 0, 568000000, },\n\t{ HI3559AV100_FIXED_500M, \"500m\", NULL, 0, 500000000, },\n\t{ HI3559AV100_FIXED_475M, \"475m\", NULL, 0, 475000000, },\n\t{ HI3559AV100_FIXED_428M, \"428m\", NULL, 0, 428000000, },\n\t{ HI3559AV100_FIXED_400M, \"400m\", NULL, 0, 400000000, },\n\t{ HI3559AV100_FIXED_396M, \"396m\", NULL, 0, 396000000, },\n\t{ HI3559AV100_FIXED_300M, \"300m\", NULL, 0, 300000000, },\n\t{ HI3559AV100_FIXED_250M, \"250m\", NULL, 0, 250000000, },\n\t{ HI3559AV100_FIXED_200M, \"200m\", NULL, 0, 200000000, },\n\t{ HI3559AV100_FIXED_198M, \"198m\", NULL, 0, 198000000, },\n\t{ HI3559AV100_FIXED_187p5M, \"187p5m\", NULL, 0, 187500000, },\n\t{ HI3559AV100_FIXED_150M, \"150m\", NULL, 0, 150000000, },\n\t{ HI3559AV100_FIXED_148p5M, \"148p5m\", NULL, 0, 1485000000, },\n\t{ HI3559AV100_FIXED_125M, \"125m\", NULL, 0, 125000000, },\n\t{ HI3559AV100_FIXED_107M, \"107m\", NULL, 0, 107000000, },\n\t{ HI3559AV100_FIXED_100M, \"100m\", NULL, 0, 100000000, },\n\t{ HI3559AV100_FIXED_99M, \"99m\",\tNULL, 0, 99000000, },\n\t{ HI3559AV100_FIXED_75M, \"75m\", NULL, 0, 75000000, },\n\t{ HI3559AV100_FIXED_74p25M, \"74p25m\", NULL, 0, 74250000, },\n\t{ HI3559AV100_FIXED_72M, \"72m\",\tNULL, 0, 72000000, },\n\t{ HI3559AV100_FIXED_60M, \"60m\",\tNULL, 0, 60000000, },\n\t{ HI3559AV100_FIXED_54M, \"54m\",\tNULL, 0, 54000000, },\n\t{ HI3559AV100_FIXED_50M, \"50m\",\tNULL, 0, 50000000, },\n\t{ HI3559AV100_FIXED_49p5M, \"49p5m\", NULL, 0, 49500000, },\n\t{ HI3559AV100_FIXED_37p125M, \"37p125m\", NULL, 0, 37125000, },\n\t{ HI3559AV100_FIXED_36M, \"36m\",\tNULL, 0, 36000000, },\n\t{ HI3559AV100_FIXED_32p4M, \"32p4m\", NULL, 0, 32400000, },\n\t{ HI3559AV100_FIXED_27M, \"27m\",\tNULL, 0, 27000000, },\n\t{ HI3559AV100_FIXED_25M, \"25m\",\tNULL, 0, 25000000, },\n\t{ HI3559AV100_FIXED_24M, \"24m\",\tNULL, 0, 24000000, },\n\t{ HI3559AV100_FIXED_12M, \"12m\",\tNULL, 0, 12000000, },\n\t{ HI3559AV100_FIXED_3M,\t \"3m\", NULL, 0, 3000000, },\n\t{ HI3559AV100_FIXED_1p6M, \"1p6m\", NULL, 0, 1600000, },\n\t{ HI3559AV100_FIXED_400K, \"400k\", NULL, 0, 400000, },\n\t{ HI3559AV100_FIXED_100K, \"100k\", NULL, 0, 100000, },\n};\n\n\nstatic const char *fmc_mux_p[] = {\n\t\"24m\", \"75m\", \"125m\", \"150m\", \"200m\", \"250m\", \"300m\", \"400m\"\n};\n\nstatic const char *mmc_mux_p[] = {\n\t\"100k\", \"25m\", \"49p5m\", \"99m\", \"187p5m\", \"150m\", \"198m\", \"400k\"\n};\n\nstatic const char *sysapb_mux_p[] = {\n\t\"24m\", \"50m\",\n};\n\nstatic const char *sysbus_mux_p[] = {\n\t\"24m\", \"300m\"\n};\n\nstatic const char *uart_mux_p[] = { \"50m\", \"24m\", \"3m\" };\n\nstatic const char *a73_clksel_mux_p[] = {\n\t\"24m\", \"apll\", \"1000m\"\n};\n\nstatic const u32 fmc_mux_table[]\t= { 0, 1, 2, 3, 4, 5, 6, 7 };\nstatic const u32 mmc_mux_table[]\t= { 0, 1, 2, 3, 4, 5, 6, 7 };\nstatic const u32 sysapb_mux_table[]\t= { 0, 1 };\nstatic const u32 sysbus_mux_table[]\t= { 0, 1 };\nstatic const u32 uart_mux_table[]\t= { 0, 1, 2 };\nstatic const u32 a73_clksel_mux_table[] = { 0, 1, 2 };\n\nstatic struct hisi_mux_clock hi3559av100_mux_clks_crg[] = {\n\t{\n\t\tHI3559AV100_FMC_MUX, \"fmc_mux\", fmc_mux_p, ARRAY_SIZE(fmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x170, 2, 3, 0, fmc_mux_table,\n\t},\n\t{\n\t\tHI3559AV100_MMC0_MUX, \"mmc0_mux\", mmc_mux_p, ARRAY_SIZE(mmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x1a8, 24, 3, 0, mmc_mux_table,\n\t},\n\t{\n\t\tHI3559AV100_MMC1_MUX, \"mmc1_mux\", mmc_mux_p, ARRAY_SIZE(mmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x1ec, 24, 3, 0, mmc_mux_table,\n\t},\n\n\t{\n\t\tHI3559AV100_MMC2_MUX, \"mmc2_mux\", mmc_mux_p, ARRAY_SIZE(mmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x214, 24, 3, 0, mmc_mux_table,\n\t},\n\n\t{\n\t\tHI3559AV100_MMC3_MUX, \"mmc3_mux\", mmc_mux_p, ARRAY_SIZE(mmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x23c, 24, 3, 0, mmc_mux_table,\n\t},\n\n\t{\n\t\tHI3559AV100_SYSAPB_MUX, \"sysapb_mux\", sysapb_mux_p, ARRAY_SIZE(sysapb_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xe8, 3, 1, 0, sysapb_mux_table\n\t},\n\n\t{\n\t\tHI3559AV100_SYSBUS_MUX, \"sysbus_mux\", sysbus_mux_p, ARRAY_SIZE(sysbus_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xe8, 0, 1, 0, sysbus_mux_table\n\t},\n\n\t{\n\t\tHI3559AV100_UART_MUX, \"uart_mux\", uart_mux_p, ARRAY_SIZE(uart_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x198, 28, 2, 0, uart_mux_table\n\t},\n\n\t{\n\t\tHI3559AV100_A73_MUX, \"a73_mux\", a73_clksel_mux_p, ARRAY_SIZE(a73_clksel_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xe4, 0, 2, 0, a73_clksel_mux_table\n\t},\n};\n\nstatic struct hisi_gate_clock hi3559av100_gate_clks[] = {\n\t{\n\t\tHI3559AV100_FMC_CLK, \"clk_fmc\", \"fmc_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x170, 1, 0,\n\t},\n\t{\n\t\tHI3559AV100_MMC0_CLK, \"clk_mmc0\", \"mmc0_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x1a8, 28, 0,\n\t},\n\t{\n\t\tHI3559AV100_MMC1_CLK, \"clk_mmc1\", \"mmc1_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x1ec, 28, 0,\n\t},\n\t{\n\t\tHI3559AV100_MMC2_CLK, \"clk_mmc2\", \"mmc2_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x214, 28, 0,\n\t},\n\t{\n\t\tHI3559AV100_MMC3_CLK, \"clk_mmc3\", \"mmc3_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x23c, 28, 0,\n\t},\n\t{\n\t\tHI3559AV100_UART0_CLK, \"clk_uart0\", \"uart_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x198, 23, 0,\n\t},\n\t{\n\t\tHI3559AV100_UART1_CLK, \"clk_uart1\", \"uart_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x198, 24, 0,\n\t},\n\t{\n\t\tHI3559AV100_UART2_CLK, \"clk_uart2\", \"uart_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x198, 25, 0,\n\t},\n\t{\n\t\tHI3559AV100_UART3_CLK, \"clk_uart3\", \"uart_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x198, 26, 0,\n\t},\n\t{\n\t\tHI3559AV100_UART4_CLK, \"clk_uart4\", \"uart_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x198, 27, 0,\n\t},\n\t{\n\t\tHI3559AV100_ETH_CLK, \"clk_eth\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0x0174, 1, 0,\n\t},\n\t{\n\t\tHI3559AV100_ETH_MACIF_CLK, \"clk_eth_macif\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0x0174, 5, 0,\n\t},\n\t{\n\t\tHI3559AV100_ETH1_CLK, \"clk_eth1\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0x0174, 3, 0,\n\t},\n\t{\n\t\tHI3559AV100_ETH1_MACIF_CLK, \"clk_eth1_macif\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0x0174, 7, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C0_CLK, \"clk_i2c0\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 16, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C1_CLK, \"clk_i2c1\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 17, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C2_CLK, \"clk_i2c2\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 18, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C3_CLK, \"clk_i2c3\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 19, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C4_CLK, \"clk_i2c4\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 20, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C5_CLK, \"clk_i2c5\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 21, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C6_CLK, \"clk_i2c6\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 22, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C7_CLK, \"clk_i2c7\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 23, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C8_CLK, \"clk_i2c8\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 24, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C9_CLK, \"clk_i2c9\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 25, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C10_CLK, \"clk_i2c10\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 26, 0,\n\t},\n\t{\n\t\tHI3559AV100_I2C11_CLK, \"clk_i2c11\", \"50m\",\n\t\tCLK_SET_RATE_PARENT, 0x01a0, 27, 0,\n\t},\n\t{\n\t\tHI3559AV100_SPI0_CLK, \"clk_spi0\", \"100m\",\n\t\tCLK_SET_RATE_PARENT, 0x0198, 16, 0,\n\t},\n\t{\n\t\tHI3559AV100_SPI1_CLK, \"clk_spi1\", \"100m\",\n\t\tCLK_SET_RATE_PARENT, 0x0198, 17, 0,\n\t},\n\t{\n\t\tHI3559AV100_SPI2_CLK, \"clk_spi2\", \"100m\",\n\t\tCLK_SET_RATE_PARENT, 0x0198, 18, 0,\n\t},\n\t{\n\t\tHI3559AV100_SPI3_CLK, \"clk_spi3\", \"100m\",\n\t\tCLK_SET_RATE_PARENT, 0x0198, 19, 0,\n\t},\n\t{\n\t\tHI3559AV100_SPI4_CLK, \"clk_spi4\", \"100m\",\n\t\tCLK_SET_RATE_PARENT, 0x0198, 20, 0,\n\t},\n\t{\n\t\tHI3559AV100_SPI5_CLK, \"clk_spi5\", \"100m\",\n\t\tCLK_SET_RATE_PARENT, 0x0198, 21, 0,\n\t},\n\t{\n\t\tHI3559AV100_SPI6_CLK, \"clk_spi6\", \"100m\",\n\t\tCLK_SET_RATE_PARENT, 0x0198, 22, 0,\n\t},\n\t{\n\t\tHI3559AV100_EDMAC_AXICLK, \"axi_clk_edmac\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0x16c, 6, 0,\n\t},\n\t{\n\t\tHI3559AV100_EDMAC_CLK, \"clk_edmac\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0x16c, 5, 0,\n\t},\n\t{\n\t\tHI3559AV100_EDMAC1_AXICLK, \"axi_clk_edmac1\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0x16c, 9, 0,\n\t},\n\t{\n\t\tHI3559AV100_EDMAC1_CLK, \"clk_edmac1\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0x16c, 8, 0,\n\t},\n\t{\n\t\tHI3559AV100_VDMAC_CLK, \"clk_vdmac\", NULL,\n\t\tCLK_SET_RATE_PARENT, 0x14c, 5, 0,\n\t},\n};\n\nstatic struct hi3559av100_pll_clock hi3559av100_pll_clks[] = {\n\t{\n\t\tHI3559AV100_APLL_CLK, \"apll\", NULL, 0x0, 0, 24, 24, 3, 28, 3,\n\t\t0x4, 0, 12, 12, 6\n\t},\n\t{\n\t\tHI3559AV100_GPLL_CLK, \"gpll\", NULL, 0x20, 0, 24, 24, 3, 28, 3,\n\t\t0x24, 0, 12, 12, 6\n\t},\n};\n\n#define to_pll_clk(_hw) container_of(_hw, struct hi3559av100_clk_pll, hw)\nstatic void hi3559av100_calc_pll(u32 *frac_val, u32 *postdiv1_val,\n\t\t\t\t u32 *postdiv2_val,\n\t\t\t\t u32 *fbdiv_val, u32 *refdiv_val, u64 rate)\n{\n\tu64 rem;\n\n\t*postdiv1_val = 2;\n\t*postdiv2_val = 1;\n\n\trate = rate * ((*postdiv1_val) * (*postdiv2_val));\n\n\t*frac_val = 0;\n\trem = do_div(rate, 1000000);\n\trem = do_div(rate, PLL_MASK_WIDTH);\n\t*fbdiv_val = rate;\n\t*refdiv_val = 1;\n\trem = rem * (1 << PLL_MASK_WIDTH);\n\tdo_div(rem, PLL_MASK_WIDTH);\n\t*frac_val = rem;\n}\n\nstatic int clk_pll_set_rate(struct clk_hw *hw,\n\t\t\t    unsigned long rate,\n\t\t\t    unsigned long parent_rate)\n{\n\tstruct hi3559av100_clk_pll *clk = to_pll_clk(hw);\n\tu32 frac_val, postdiv1_val, postdiv2_val, fbdiv_val, refdiv_val;\n\tu32 val;\n\n\tpostdiv1_val = postdiv2_val = 0;\n\n\thi3559av100_calc_pll(&frac_val, &postdiv1_val, &postdiv2_val,\n\t\t\t     &fbdiv_val, &refdiv_val, (u64)rate);\n\n\tval = readl_relaxed(clk->ctrl_reg1);\n\tval &= ~(((1 << clk->frac_width) - 1) << clk->frac_shift);\n\tval &= ~(((1 << clk->postdiv1_width) - 1) << clk->postdiv1_shift);\n\tval &= ~(((1 << clk->postdiv2_width) - 1) << clk->postdiv2_shift);\n\n\tval |= frac_val << clk->frac_shift;\n\tval |= postdiv1_val << clk->postdiv1_shift;\n\tval |= postdiv2_val << clk->postdiv2_shift;\n\twritel_relaxed(val, clk->ctrl_reg1);\n\n\tval = readl_relaxed(clk->ctrl_reg2);\n\tval &= ~(((1 << clk->fbdiv_width) - 1) << clk->fbdiv_shift);\n\tval &= ~(((1 << clk->refdiv_width) - 1) << clk->refdiv_shift);\n\n\tval |= fbdiv_val << clk->fbdiv_shift;\n\tval |= refdiv_val << clk->refdiv_shift;\n\twritel_relaxed(val, clk->ctrl_reg2);\n\n\treturn 0;\n}\n\nstatic unsigned long clk_pll_recalc_rate(struct clk_hw *hw,\n\t\tunsigned long parent_rate)\n{\n\tstruct hi3559av100_clk_pll *clk = to_pll_clk(hw);\n\tu64 frac_val, fbdiv_val, refdiv_val;\n\tu32 postdiv1_val, postdiv2_val;\n\tu32 val;\n\tu64 tmp, rate;\n\n\tval = readl_relaxed(clk->ctrl_reg1);\n\tval = val >> clk->frac_shift;\n\tval &= ((1 << clk->frac_width) - 1);\n\tfrac_val = val;\n\n\tval = readl_relaxed(clk->ctrl_reg1);\n\tval = val >> clk->postdiv1_shift;\n\tval &= ((1 << clk->postdiv1_width) - 1);\n\tpostdiv1_val = val;\n\n\tval = readl_relaxed(clk->ctrl_reg1);\n\tval = val >> clk->postdiv2_shift;\n\tval &= ((1 << clk->postdiv2_width) - 1);\n\tpostdiv2_val = val;\n\n\tval = readl_relaxed(clk->ctrl_reg2);\n\tval = val >> clk->fbdiv_shift;\n\tval &= ((1 << clk->fbdiv_width) - 1);\n\tfbdiv_val = val;\n\n\tval = readl_relaxed(clk->ctrl_reg2);\n\tval = val >> clk->refdiv_shift;\n\tval &= ((1 << clk->refdiv_width) - 1);\n\trefdiv_val = val;\n\n\t \n\trate = 0;\n\ttmp = 24000000 * fbdiv_val + (24000000 * frac_val) / (1 << 24);\n\trate += tmp;\n\tdo_div(rate, refdiv_val);\n\tdo_div(rate, postdiv1_val * postdiv2_val);\n\n\treturn rate;\n}\n\nstatic const struct clk_ops hisi_clk_pll_ops = {\n\t.set_rate = clk_pll_set_rate,\n\t.recalc_rate = clk_pll_recalc_rate,\n};\n\nstatic void hisi_clk_register_pll(struct hi3559av100_pll_clock *clks,\n\t\t\t   int nums, struct hisi_clock_data *data, struct device *dev)\n{\n\tvoid __iomem *base = data->base;\n\tstruct hi3559av100_clk_pll *p_clk = NULL;\n\tstruct clk *clk = NULL;\n\tstruct clk_init_data init;\n\tint i;\n\n\tp_clk = devm_kzalloc(dev, sizeof(*p_clk) * nums, GFP_KERNEL);\n\n\tif (!p_clk)\n\t\treturn;\n\n\tfor (i = 0; i < nums; i++) {\n\t\tinit.name = clks[i].name;\n\t\tinit.flags = 0;\n\t\tinit.parent_names =\n\t\t\t(clks[i].parent_name ? &clks[i].parent_name : NULL);\n\t\tinit.num_parents = (clks[i].parent_name ? 1 : 0);\n\t\tinit.ops = &hisi_clk_pll_ops;\n\n\t\tp_clk->ctrl_reg1 = base + clks[i].ctrl_reg1;\n\t\tp_clk->frac_shift = clks[i].frac_shift;\n\t\tp_clk->frac_width = clks[i].frac_width;\n\t\tp_clk->postdiv1_shift = clks[i].postdiv1_shift;\n\t\tp_clk->postdiv1_width = clks[i].postdiv1_width;\n\t\tp_clk->postdiv2_shift = clks[i].postdiv2_shift;\n\t\tp_clk->postdiv2_width = clks[i].postdiv2_width;\n\n\t\tp_clk->ctrl_reg2 = base + clks[i].ctrl_reg2;\n\t\tp_clk->fbdiv_shift = clks[i].fbdiv_shift;\n\t\tp_clk->fbdiv_width = clks[i].fbdiv_width;\n\t\tp_clk->refdiv_shift = clks[i].refdiv_shift;\n\t\tp_clk->refdiv_width = clks[i].refdiv_width;\n\t\tp_clk->hw.init = &init;\n\n\t\tclk = clk_register(NULL, &p_clk->hw);\n\t\tif (IS_ERR(clk)) {\n\t\t\tdevm_kfree(dev, p_clk);\n\t\t\tdev_err(dev, \"%s: failed to register clock %s\\n\",\n\t\t\t       __func__, clks[i].name);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdata->clk_data.clks[clks[i].id] = clk;\n\t\tp_clk++;\n\t}\n}\n\nstatic struct hisi_clock_data *hi3559av100_clk_register(\n\tstruct platform_device *pdev)\n{\n\tstruct hisi_clock_data *clk_data;\n\tint ret;\n\n\tclk_data = hisi_clk_alloc(pdev, HI3559AV100_CRG_NR_CLKS);\n\tif (!clk_data)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tret = hisi_clk_register_fixed_rate(hi3559av100_fixed_rate_clks_crg,\n\t\t\t\t\t   ARRAY_SIZE(hi3559av100_fixed_rate_clks_crg), clk_data);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\thisi_clk_register_pll(hi3559av100_pll_clks,\n\t\t\t      ARRAY_SIZE(hi3559av100_pll_clks), clk_data, &pdev->dev);\n\n\tret = hisi_clk_register_mux(hi3559av100_mux_clks_crg,\n\t\t\t\t    ARRAY_SIZE(hi3559av100_mux_clks_crg), clk_data);\n\tif (ret)\n\t\tgoto unregister_fixed_rate;\n\n\tret = hisi_clk_register_gate(hi3559av100_gate_clks,\n\t\t\t\t     ARRAY_SIZE(hi3559av100_gate_clks), clk_data);\n\tif (ret)\n\t\tgoto unregister_mux;\n\n\tret = of_clk_add_provider(pdev->dev.of_node,\n\t\t\t\t  of_clk_src_onecell_get, &clk_data->clk_data);\n\tif (ret)\n\t\tgoto unregister_gate;\n\n\treturn clk_data;\n\nunregister_gate:\n\thisi_clk_unregister_gate(hi3559av100_gate_clks,\n\t\t\t\t ARRAY_SIZE(hi3559av100_gate_clks), clk_data);\nunregister_mux:\n\thisi_clk_unregister_mux(hi3559av100_mux_clks_crg,\n\t\t\t\tARRAY_SIZE(hi3559av100_mux_clks_crg), clk_data);\nunregister_fixed_rate:\n\thisi_clk_unregister_fixed_rate(hi3559av100_fixed_rate_clks_crg,\n\t\t\t\t       ARRAY_SIZE(hi3559av100_fixed_rate_clks_crg), clk_data);\n\treturn ERR_PTR(ret);\n}\n\nstatic void hi3559av100_clk_unregister(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(pdev->dev.of_node);\n\n\thisi_clk_unregister_gate(hi3559av100_gate_clks,\n\t\t\t\t ARRAY_SIZE(hi3559av100_gate_clks), crg->clk_data);\n\thisi_clk_unregister_mux(hi3559av100_mux_clks_crg,\n\t\t\t\tARRAY_SIZE(hi3559av100_mux_clks_crg), crg->clk_data);\n\thisi_clk_unregister_fixed_rate(hi3559av100_fixed_rate_clks_crg,\n\t\t\t\t       ARRAY_SIZE(hi3559av100_fixed_rate_clks_crg), crg->clk_data);\n}\n\nstatic const struct hisi_crg_funcs hi3559av100_crg_funcs = {\n\t.register_clks = hi3559av100_clk_register,\n\t.unregister_clks = hi3559av100_clk_unregister,\n};\n\nstatic struct hisi_fixed_rate_clock hi3559av100_shub_fixed_rate_clks[] = {\n\t{ HI3559AV100_SHUB_SOURCE_SOC_24M, \"clk_source_24M\", NULL, 0, 24000000UL, },\n\t{ HI3559AV100_SHUB_SOURCE_SOC_200M, \"clk_source_200M\", NULL, 0, 200000000UL, },\n\t{ HI3559AV100_SHUB_SOURCE_SOC_300M, \"clk_source_300M\", NULL, 0, 300000000UL, },\n\t{ HI3559AV100_SHUB_SOURCE_PLL, \"clk_source_PLL\", NULL, 0, 192000000UL, },\n\t{ HI3559AV100_SHUB_I2C0_CLK, \"clk_shub_i2c0\", NULL, 0, 48000000UL, },\n\t{ HI3559AV100_SHUB_I2C1_CLK, \"clk_shub_i2c1\", NULL, 0, 48000000UL, },\n\t{ HI3559AV100_SHUB_I2C2_CLK, \"clk_shub_i2c2\", NULL, 0, 48000000UL, },\n\t{ HI3559AV100_SHUB_I2C3_CLK, \"clk_shub_i2c3\", NULL, 0, 48000000UL, },\n\t{ HI3559AV100_SHUB_I2C4_CLK, \"clk_shub_i2c4\", NULL, 0, 48000000UL, },\n\t{ HI3559AV100_SHUB_I2C5_CLK, \"clk_shub_i2c5\", NULL, 0, 48000000UL, },\n\t{ HI3559AV100_SHUB_I2C6_CLK, \"clk_shub_i2c6\", NULL, 0, 48000000UL, },\n\t{ HI3559AV100_SHUB_I2C7_CLK, \"clk_shub_i2c7\", NULL, 0, 48000000UL, },\n\t{ HI3559AV100_SHUB_UART_CLK_32K, \"clk_uart_32K\", NULL, 0, 32000UL, },\n};\n\n \nstatic u32 shub_source_clk_mux_table[] = {0, 1, 2, 3};\nstatic const char *shub_source_clk_mux_p[] = {\n\t\"clk_source_24M\", \"clk_source_200M\", \"clk_source_300M\", \"clk_source_PLL\"\n};\n\nstatic u32 shub_uart_source_clk_mux_table[] = {0, 1, 2, 3};\nstatic const char *shub_uart_source_clk_mux_p[] = {\n\t\"clk_uart_32K\", \"clk_uart_div_clk\", \"clk_uart_div_clk\", \"clk_source_24M\"\n};\n\nstatic struct hisi_mux_clock hi3559av100_shub_mux_clks[] = {\n\t{\n\t\tHI3559AV100_SHUB_SOURCE_CLK, \"shub_clk\", shub_source_clk_mux_p,\n\t\tARRAY_SIZE(shub_source_clk_mux_p),\n\t\t0, 0x0, 0, 2, 0, shub_source_clk_mux_table,\n\t},\n\n\t{\n\t\tHI3559AV100_SHUB_UART_SOURCE_CLK, \"shub_uart_source_clk\",\n\t\tshub_uart_source_clk_mux_p, ARRAY_SIZE(shub_uart_source_clk_mux_p),\n\t\t0, 0x1c, 28, 2, 0, shub_uart_source_clk_mux_table,\n\t},\n};\n\n\n \nstatic struct clk_div_table shub_spi_clk_table[] = {{0, 8}, {1, 4}, {2, 2}, { }};\nstatic struct clk_div_table shub_uart_div_clk_table[] = {{1, 8}, {2, 4}, { }};\n\nstatic struct hisi_divider_clock hi3559av100_shub_div_clks[] = {\n\t{ HI3559AV100_SHUB_SPI_SOURCE_CLK, \"clk_spi_clk\", \"shub_clk\", 0, 0x20, 24, 2,\n\t  CLK_DIVIDER_ALLOW_ZERO, shub_spi_clk_table,\n\t},\n\t{ HI3559AV100_SHUB_UART_DIV_CLK, \"clk_uart_div_clk\", \"shub_clk\", 0, 0x1c, 28, 2,\n\t  CLK_DIVIDER_ALLOW_ZERO, shub_uart_div_clk_table,\n\t},\n};\n\n \nstatic struct hisi_gate_clock hi3559av100_shub_gate_clks[] = {\n\t{\n\t\tHI3559AV100_SHUB_SPI0_CLK, \"clk_shub_spi0\", \"clk_spi_clk\",\n\t\t0, 0x20, 1, 0,\n\t},\n\t{\n\t\tHI3559AV100_SHUB_SPI1_CLK, \"clk_shub_spi1\", \"clk_spi_clk\",\n\t\t0, 0x20, 5, 0,\n\t},\n\t{\n\t\tHI3559AV100_SHUB_SPI2_CLK, \"clk_shub_spi2\", \"clk_spi_clk\",\n\t\t0, 0x20, 9, 0,\n\t},\n\n\t{\n\t\tHI3559AV100_SHUB_UART0_CLK, \"clk_shub_uart0\", \"shub_uart_source_clk\",\n\t\t0, 0x1c, 1, 0,\n\t},\n\t{\n\t\tHI3559AV100_SHUB_UART1_CLK, \"clk_shub_uart1\", \"shub_uart_source_clk\",\n\t\t0, 0x1c, 5, 0,\n\t},\n\t{\n\t\tHI3559AV100_SHUB_UART2_CLK, \"clk_shub_uart2\", \"shub_uart_source_clk\",\n\t\t0, 0x1c, 9, 0,\n\t},\n\t{\n\t\tHI3559AV100_SHUB_UART3_CLK, \"clk_shub_uart3\", \"shub_uart_source_clk\",\n\t\t0, 0x1c, 13, 0,\n\t},\n\t{\n\t\tHI3559AV100_SHUB_UART4_CLK, \"clk_shub_uart4\", \"shub_uart_source_clk\",\n\t\t0, 0x1c, 17, 0,\n\t},\n\t{\n\t\tHI3559AV100_SHUB_UART5_CLK, \"clk_shub_uart5\", \"shub_uart_source_clk\",\n\t\t0, 0x1c, 21, 0,\n\t},\n\t{\n\t\tHI3559AV100_SHUB_UART6_CLK, \"clk_shub_uart6\", \"shub_uart_source_clk\",\n\t\t0, 0x1c, 25, 0,\n\t},\n\n\t{\n\t\tHI3559AV100_SHUB_EDMAC_CLK, \"clk_shub_dmac\", \"shub_clk\",\n\t\t0, 0x24, 4, 0,\n\t},\n};\n\nstatic int hi3559av100_shub_default_clk_set(void)\n{\n\tvoid __iomem *crg_base;\n\tunsigned int val;\n\n\tcrg_base = ioremap(CRG_BASE_ADDR, SZ_4K);\n\n\t \n\tval = readl_relaxed(crg_base + 0x20);\n\tval |= (0x2 << 24);\n\twritel_relaxed(val, crg_base + 0x20);\n\n\t \n\tval = readl_relaxed(crg_base + 0x1C);\n\tval |= (0x1 << 28);\n\twritel_relaxed(val, crg_base + 0x1C);\n\n\tiounmap(crg_base);\n\tcrg_base = NULL;\n\n\treturn 0;\n}\n\nstatic struct hisi_clock_data *hi3559av100_shub_clk_register(\n\tstruct platform_device *pdev)\n{\n\tstruct hisi_clock_data *clk_data = NULL;\n\tint ret;\n\n\thi3559av100_shub_default_clk_set();\n\n\tclk_data = hisi_clk_alloc(pdev, HI3559AV100_SHUB_NR_CLKS);\n\tif (!clk_data)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tret = hisi_clk_register_fixed_rate(hi3559av100_shub_fixed_rate_clks,\n\t\t\t\t\t   ARRAY_SIZE(hi3559av100_shub_fixed_rate_clks), clk_data);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\tret = hisi_clk_register_mux(hi3559av100_shub_mux_clks,\n\t\t\t\t    ARRAY_SIZE(hi3559av100_shub_mux_clks), clk_data);\n\tif (ret)\n\t\tgoto unregister_fixed_rate;\n\n\tret = hisi_clk_register_divider(hi3559av100_shub_div_clks,\n\t\t\t\t\tARRAY_SIZE(hi3559av100_shub_div_clks), clk_data);\n\tif (ret)\n\t\tgoto unregister_mux;\n\n\tret = hisi_clk_register_gate(hi3559av100_shub_gate_clks,\n\t\t\t\t     ARRAY_SIZE(hi3559av100_shub_gate_clks), clk_data);\n\tif (ret)\n\t\tgoto unregister_factor;\n\n\tret = of_clk_add_provider(pdev->dev.of_node,\n\t\t\t\t  of_clk_src_onecell_get, &clk_data->clk_data);\n\tif (ret)\n\t\tgoto unregister_gate;\n\n\treturn clk_data;\n\nunregister_gate:\n\thisi_clk_unregister_gate(hi3559av100_shub_gate_clks,\n\t\t\t\t ARRAY_SIZE(hi3559av100_shub_gate_clks), clk_data);\nunregister_factor:\n\thisi_clk_unregister_divider(hi3559av100_shub_div_clks,\n\t\t\t\t    ARRAY_SIZE(hi3559av100_shub_div_clks), clk_data);\nunregister_mux:\n\thisi_clk_unregister_mux(hi3559av100_shub_mux_clks,\n\t\t\t\tARRAY_SIZE(hi3559av100_shub_mux_clks), clk_data);\nunregister_fixed_rate:\n\thisi_clk_unregister_fixed_rate(hi3559av100_shub_fixed_rate_clks,\n\t\t\t\t       ARRAY_SIZE(hi3559av100_shub_fixed_rate_clks), clk_data);\n\treturn ERR_PTR(ret);\n}\n\nstatic void hi3559av100_shub_clk_unregister(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(pdev->dev.of_node);\n\n\thisi_clk_unregister_gate(hi3559av100_shub_gate_clks,\n\t\t\t\t ARRAY_SIZE(hi3559av100_shub_gate_clks), crg->clk_data);\n\thisi_clk_unregister_divider(hi3559av100_shub_div_clks,\n\t\t\t\t    ARRAY_SIZE(hi3559av100_shub_div_clks), crg->clk_data);\n\thisi_clk_unregister_mux(hi3559av100_shub_mux_clks,\n\t\t\t\tARRAY_SIZE(hi3559av100_shub_mux_clks), crg->clk_data);\n\thisi_clk_unregister_fixed_rate(hi3559av100_shub_fixed_rate_clks,\n\t\t\t\t       ARRAY_SIZE(hi3559av100_shub_fixed_rate_clks), crg->clk_data);\n}\n\nstatic const struct hisi_crg_funcs hi3559av100_shub_crg_funcs = {\n\t.register_clks = hi3559av100_shub_clk_register,\n\t.unregister_clks = hi3559av100_shub_clk_unregister,\n};\n\nstatic const struct of_device_id hi3559av100_crg_match_table[] = {\n\t{\n\t\t.compatible = \"hisilicon,hi3559av100-clock\",\n\t\t.data = &hi3559av100_crg_funcs\n\t},\n\t{\n\t\t.compatible = \"hisilicon,hi3559av100-shub-clock\",\n\t\t.data = &hi3559av100_shub_crg_funcs\n\t},\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, hi3559av100_crg_match_table);\n\nstatic int hi3559av100_crg_probe(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg;\n\n\tcrg = devm_kmalloc(&pdev->dev, sizeof(*crg), GFP_KERNEL);\n\tif (!crg)\n\t\treturn -ENOMEM;\n\n\tcrg->funcs = of_device_get_match_data(&pdev->dev);\n\tif (!crg->funcs)\n\t\treturn -ENOENT;\n\n\tcrg->rstc = hisi_reset_init(pdev);\n\tif (!crg->rstc)\n\t\treturn -ENOMEM;\n\n\tcrg->clk_data = crg->funcs->register_clks(pdev);\n\tif (IS_ERR(crg->clk_data)) {\n\t\thisi_reset_exit(crg->rstc);\n\t\treturn PTR_ERR(crg->clk_data);\n\t}\n\n\tplatform_set_drvdata(pdev, crg);\n\treturn 0;\n}\n\nstatic void hi3559av100_crg_remove(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\n\n\thisi_reset_exit(crg->rstc);\n\tcrg->funcs->unregister_clks(pdev);\n}\n\nstatic struct platform_driver hi3559av100_crg_driver = {\n\t.probe\t\t= hi3559av100_crg_probe,\n\t.remove_new\t= hi3559av100_crg_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"hi3559av100-clock\",\n\t\t.of_match_table = hi3559av100_crg_match_table,\n\t},\n};\n\nstatic int __init hi3559av100_crg_init(void)\n{\n\treturn platform_driver_register(&hi3559av100_crg_driver);\n}\ncore_initcall(hi3559av100_crg_init);\n\nstatic void __exit hi3559av100_crg_exit(void)\n{\n\tplatform_driver_unregister(&hi3559av100_crg_driver);\n}\nmodule_exit(hi3559av100_crg_exit);\n\n\nMODULE_DESCRIPTION(\"HiSilicon Hi3559AV100 CRG Driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}