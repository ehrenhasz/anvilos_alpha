{
  "module_name": "clk-hi3660-stub.c",
  "hash_id": "269b35bad2a060d50d8e58b8d9898cfc5d28ea896c2ea74867b2e3fe1fe30f41",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/hisilicon/clk-hi3660-stub.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/mailbox_client.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <dt-bindings/clock/hi3660-clock.h>\n\n#define HI3660_STUB_CLOCK_DATA\t\t(0x70)\n#define MHZ\t\t\t\t(1000 * 1000)\n\n#define DEFINE_CLK_STUB(_id, _cmd, _name)\t\t\t\\\n\t{\t\t\t\t\t\t\t\\\n\t\t.id = (_id),\t\t\t\t\t\\\n\t\t.cmd = (_cmd),\t\t\t\t\t\\\n\t\t.hw.init = &(struct clk_init_data) {\t\t\\\n\t\t\t.name = #_name,\t\t\t\t\\\n\t\t\t.ops = &hi3660_stub_clk_ops,\t\t\\\n\t\t\t.num_parents = 0,\t\t\t\\\n\t\t\t.flags = CLK_GET_RATE_NOCACHE,\t\t\\\n\t\t},\t\t\t\t\t\t\\\n\t},\n\n#define to_stub_clk(_hw) container_of(_hw, struct hi3660_stub_clk, hw)\n\nstruct hi3660_stub_clk_chan {\n\tstruct mbox_client cl;\n\tstruct mbox_chan *mbox;\n};\n\nstruct hi3660_stub_clk {\n\tunsigned int id;\n\tstruct clk_hw hw;\n\tunsigned int cmd;\n\tunsigned int msg[8];\n\tunsigned int rate;\n};\n\nstatic void __iomem *freq_reg;\nstatic struct hi3660_stub_clk_chan stub_clk_chan;\n\nstatic unsigned long hi3660_stub_clk_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t\t unsigned long parent_rate)\n{\n\tstruct hi3660_stub_clk *stub_clk = to_stub_clk(hw);\n\n\t \n\tstub_clk->rate = readl(freq_reg + (stub_clk->id << 2)) * MHZ;\n\treturn stub_clk->rate;\n}\n\nstatic long hi3660_stub_clk_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t       unsigned long *prate)\n{\n\t \n\treturn rate;\n}\n\nstatic int hi3660_stub_clk_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t    unsigned long parent_rate)\n{\n\tstruct hi3660_stub_clk *stub_clk = to_stub_clk(hw);\n\n\tstub_clk->msg[0] = stub_clk->cmd;\n\tstub_clk->msg[1] = rate / MHZ;\n\n\tdev_dbg(stub_clk_chan.cl.dev, \"set rate msg[0]=0x%x msg[1]=0x%x\\n\",\n\t\tstub_clk->msg[0], stub_clk->msg[1]);\n\n\tmbox_send_message(stub_clk_chan.mbox, stub_clk->msg);\n\tmbox_client_txdone(stub_clk_chan.mbox, 0);\n\n\tstub_clk->rate = rate;\n\treturn 0;\n}\n\nstatic const struct clk_ops hi3660_stub_clk_ops = {\n\t.recalc_rate    = hi3660_stub_clk_recalc_rate,\n\t.round_rate     = hi3660_stub_clk_round_rate,\n\t.set_rate       = hi3660_stub_clk_set_rate,\n};\n\nstatic struct hi3660_stub_clk hi3660_stub_clks[HI3660_CLK_STUB_NUM] = {\n\tDEFINE_CLK_STUB(HI3660_CLK_STUB_CLUSTER0, 0x0001030A, \"cpu-cluster.0\")\n\tDEFINE_CLK_STUB(HI3660_CLK_STUB_CLUSTER1, 0x0002030A, \"cpu-cluster.1\")\n\tDEFINE_CLK_STUB(HI3660_CLK_STUB_GPU, 0x0003030A, \"clk-g3d\")\n\tDEFINE_CLK_STUB(HI3660_CLK_STUB_DDR, 0x00040309, \"clk-ddrc\")\n};\n\nstatic struct clk_hw *hi3660_stub_clk_hw_get(struct of_phandle_args *clkspec,\n\t\t\t\t\t     void *data)\n{\n\tunsigned int idx = clkspec->args[0];\n\n\tif (idx >= HI3660_CLK_STUB_NUM) {\n\t\tpr_err(\"%s: invalid index %u\\n\", __func__, idx);\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\treturn &hi3660_stub_clks[idx].hw;\n}\n\nstatic int hi3660_stub_clk_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct resource *res;\n\tunsigned int i;\n\tint ret;\n\n\t \n\tstub_clk_chan.cl.dev = dev;\n\tstub_clk_chan.cl.tx_done = NULL;\n\tstub_clk_chan.cl.tx_block = false;\n\tstub_clk_chan.cl.knows_txdone = false;\n\n\t \n\tstub_clk_chan.mbox = mbox_request_channel(&stub_clk_chan.cl, 0);\n\tif (IS_ERR(stub_clk_chan.mbox))\n\t\treturn PTR_ERR(stub_clk_chan.mbox);\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!res)\n\t\treturn -EINVAL;\n\tfreq_reg = devm_ioremap(dev, res->start, resource_size(res));\n\tif (!freq_reg)\n\t\treturn -ENOMEM;\n\n\tfreq_reg += HI3660_STUB_CLOCK_DATA;\n\n\tfor (i = 0; i < HI3660_CLK_STUB_NUM; i++) {\n\t\tret = devm_clk_hw_register(&pdev->dev, &hi3660_stub_clks[i].hw);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn devm_of_clk_add_hw_provider(&pdev->dev, hi3660_stub_clk_hw_get,\n\t\t\t\t\t   hi3660_stub_clks);\n}\n\nstatic const struct of_device_id hi3660_stub_clk_of_match[] = {\n\t{ .compatible = \"hisilicon,hi3660-stub-clk\", },\n\t{}\n};\n\nstatic struct platform_driver hi3660_stub_clk_driver = {\n\t.probe\t= hi3660_stub_clk_probe,\n\t.driver = {\n\t\t.name = \"hi3660-stub-clk\",\n\t\t.of_match_table = hi3660_stub_clk_of_match,\n\t},\n};\n\nstatic int __init hi3660_stub_clk_init(void)\n{\n\treturn platform_driver_register(&hi3660_stub_clk_driver);\n}\nsubsys_initcall(hi3660_stub_clk_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}