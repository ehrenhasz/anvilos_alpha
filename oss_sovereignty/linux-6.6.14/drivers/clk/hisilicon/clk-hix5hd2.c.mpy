{
  "module_name": "clk-hix5hd2.c",
  "hash_id": "d888c3b6e6f105af294e7aa66a24a5041409b7d971d018fc878582a01ed36125",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/hisilicon/clk-hix5hd2.c",
  "human_readable_source": "\n \n\n#include <linux/of_address.h>\n#include <dt-bindings/clock/hix5hd2-clock.h>\n#include <linux/slab.h>\n#include <linux/delay.h>\n#include \"clk.h\"\n\nstatic struct hisi_fixed_rate_clock hix5hd2_fixed_rate_clks[] __initdata = {\n\t{ HIX5HD2_FIXED_1200M, \"1200m\", NULL, 0, 1200000000, },\n\t{ HIX5HD2_FIXED_400M, \"400m\", NULL, 0, 400000000, },\n\t{ HIX5HD2_FIXED_48M, \"48m\", NULL, 0, 48000000, },\n\t{ HIX5HD2_FIXED_24M, \"24m\", NULL, 0, 24000000, },\n\t{ HIX5HD2_FIXED_600M, \"600m\", NULL, 0, 600000000, },\n\t{ HIX5HD2_FIXED_300M, \"300m\", NULL, 0, 300000000, },\n\t{ HIX5HD2_FIXED_75M, \"75m\", NULL, 0, 75000000, },\n\t{ HIX5HD2_FIXED_200M, \"200m\", NULL, 0, 200000000, },\n\t{ HIX5HD2_FIXED_100M, \"100m\", NULL, 0, 100000000, },\n\t{ HIX5HD2_FIXED_40M, \"40m\", NULL, 0, 40000000, },\n\t{ HIX5HD2_FIXED_150M, \"150m\", NULL, 0, 150000000, },\n\t{ HIX5HD2_FIXED_1728M, \"1728m\", NULL, 0, 1728000000, },\n\t{ HIX5HD2_FIXED_28P8M, \"28p8m\", NULL, 0, 28000000, },\n\t{ HIX5HD2_FIXED_432M, \"432m\", NULL, 0, 432000000, },\n\t{ HIX5HD2_FIXED_345P6M, \"345p6m\", NULL, 0, 345000000, },\n\t{ HIX5HD2_FIXED_288M, \"288m\", NULL, 0, 288000000, },\n\t{ HIX5HD2_FIXED_60M,\t\"60m\", NULL, 0, 60000000, },\n\t{ HIX5HD2_FIXED_750M, \"750m\", NULL, 0, 750000000, },\n\t{ HIX5HD2_FIXED_500M, \"500m\", NULL, 0, 500000000, },\n\t{ HIX5HD2_FIXED_54M,\t\"54m\", NULL, 0, 54000000, },\n\t{ HIX5HD2_FIXED_27M, \"27m\", NULL, 0, 27000000, },\n\t{ HIX5HD2_FIXED_1500M, \"1500m\", NULL, 0, 1500000000, },\n\t{ HIX5HD2_FIXED_375M, \"375m\", NULL, 0, 375000000, },\n\t{ HIX5HD2_FIXED_187M, \"187m\", NULL, 0, 187000000, },\n\t{ HIX5HD2_FIXED_250M, \"250m\", NULL, 0, 250000000, },\n\t{ HIX5HD2_FIXED_125M, \"125m\", NULL, 0, 125000000, },\n\t{ HIX5HD2_FIXED_2P02M, \"2m\", NULL, 0, 2000000, },\n\t{ HIX5HD2_FIXED_50M, \"50m\", NULL, 0, 50000000, },\n\t{ HIX5HD2_FIXED_25M, \"25m\", NULL, 0, 25000000, },\n\t{ HIX5HD2_FIXED_83M, \"83m\", NULL, 0, 83333333, },\n};\n\nstatic const char *const sfc_mux_p[] __initconst = {\n\t\t\"24m\", \"150m\", \"200m\", \"100m\", \"75m\", };\nstatic u32 sfc_mux_table[] = {0, 4, 5, 6, 7};\n\nstatic const char *const sdio_mux_p[] __initconst = {\n\t\t\"75m\", \"100m\", \"50m\", \"15m\", };\nstatic u32 sdio_mux_table[] = {0, 1, 2, 3};\n\nstatic const char *const fephy_mux_p[] __initconst = { \"25m\", \"125m\"};\nstatic u32 fephy_mux_table[] = {0, 1};\n\n\nstatic struct hisi_mux_clock hix5hd2_mux_clks[] __initdata = {\n\t{ HIX5HD2_SFC_MUX, \"sfc_mux\", sfc_mux_p, ARRAY_SIZE(sfc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x5c, 8, 3, 0, sfc_mux_table, },\n\t{ HIX5HD2_MMC_MUX, \"mmc_mux\", sdio_mux_p, ARRAY_SIZE(sdio_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xa0, 8, 2, 0, sdio_mux_table, },\n\t{ HIX5HD2_SD_MUX, \"sd_mux\", sdio_mux_p, ARRAY_SIZE(sdio_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x9c, 8, 2, 0, sdio_mux_table, },\n\t{ HIX5HD2_FEPHY_MUX, \"fephy_mux\",\n\t\tfephy_mux_p, ARRAY_SIZE(fephy_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x120, 8, 2, 0, fephy_mux_table, },\n};\n\nstatic struct hisi_gate_clock hix5hd2_gate_clks[] __initdata = {\n\t \n\t{ HIX5HD2_SFC_CLK, \"clk_sfc\", \"sfc_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x5c, 0, 0, },\n\t{ HIX5HD2_SFC_RST, \"rst_sfc\", \"clk_sfc\",\n\t\tCLK_SET_RATE_PARENT, 0x5c, 4, CLK_GATE_SET_TO_DISABLE, },\n\t \n\t{ HIX5HD2_SD_BIU_CLK, \"clk_sd_biu\", \"200m\",\n\t\tCLK_SET_RATE_PARENT, 0x9c, 0, 0, },\n\t{ HIX5HD2_SD_CIU_CLK, \"clk_sd_ciu\", \"sd_mux\",\n\t\tCLK_SET_RATE_PARENT, 0x9c, 1, 0, },\n\t{ HIX5HD2_SD_CIU_RST, \"rst_sd_ciu\", \"clk_sd_ciu\",\n\t\tCLK_SET_RATE_PARENT, 0x9c, 4, CLK_GATE_SET_TO_DISABLE, },\n\t \n\t{ HIX5HD2_MMC_BIU_CLK, \"clk_mmc_biu\", \"200m\",\n\t\tCLK_SET_RATE_PARENT, 0xa0, 0, 0, },\n\t{ HIX5HD2_MMC_CIU_CLK, \"clk_mmc_ciu\", \"mmc_mux\",\n\t\tCLK_SET_RATE_PARENT, 0xa0, 1, 0, },\n\t{ HIX5HD2_MMC_CIU_RST, \"rst_mmc_ciu\", \"clk_mmc_ciu\",\n\t\tCLK_SET_RATE_PARENT, 0xa0, 4, CLK_GATE_SET_TO_DISABLE, },\n\t \n\t{ HIX5HD2_FWD_BUS_CLK, \"clk_fwd_bus\", NULL, 0, 0xcc, 0, 0, },\n\t{ HIX5HD2_FWD_SYS_CLK, \"clk_fwd_sys\", \"clk_fwd_bus\", 0, 0xcc, 5, 0, },\n\t{ HIX5HD2_MAC0_PHY_CLK, \"clk_fephy\", \"clk_fwd_sys\",\n\t\t CLK_SET_RATE_PARENT, 0x120, 0, 0, },\n\t \n\t{ HIX5HD2_WDG0_CLK, \"clk_wdg0\", \"24m\",\n\t\tCLK_SET_RATE_PARENT, 0x178, 0, 0, },\n\t{ HIX5HD2_WDG0_RST, \"rst_wdg0\", \"clk_wdg0\",\n\t\tCLK_SET_RATE_PARENT, 0x178, 4, CLK_GATE_SET_TO_DISABLE, },\n\t \n\t{HIX5HD2_I2C0_CLK, \"clk_i2c0\", \"100m\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 4, 0, },\n\t{HIX5HD2_I2C0_RST, \"rst_i2c0\", \"clk_i2c0\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 5, CLK_GATE_SET_TO_DISABLE, },\n\t{HIX5HD2_I2C1_CLK, \"clk_i2c1\", \"100m\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 8, 0, },\n\t{HIX5HD2_I2C1_RST, \"rst_i2c1\", \"clk_i2c1\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 9, CLK_GATE_SET_TO_DISABLE, },\n\t{HIX5HD2_I2C2_CLK, \"clk_i2c2\", \"100m\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 12, 0, },\n\t{HIX5HD2_I2C2_RST, \"rst_i2c2\", \"clk_i2c2\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 13, CLK_GATE_SET_TO_DISABLE, },\n\t{HIX5HD2_I2C3_CLK, \"clk_i2c3\", \"100m\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 16, 0, },\n\t{HIX5HD2_I2C3_RST, \"rst_i2c3\", \"clk_i2c3\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 17, CLK_GATE_SET_TO_DISABLE, },\n\t{HIX5HD2_I2C4_CLK, \"clk_i2c4\", \"100m\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 20, 0, },\n\t{HIX5HD2_I2C4_RST, \"rst_i2c4\", \"clk_i2c4\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 21, CLK_GATE_SET_TO_DISABLE, },\n\t{HIX5HD2_I2C5_CLK, \"clk_i2c5\", \"100m\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 0, 0, },\n\t{HIX5HD2_I2C5_RST, \"rst_i2c5\", \"clk_i2c5\",\n\t\t CLK_SET_RATE_PARENT, 0x06c, 1, CLK_GATE_SET_TO_DISABLE, },\n};\n\nenum hix5hd2_clk_type {\n\tTYPE_COMPLEX,\n\tTYPE_ETHER,\n};\n\nstruct hix5hd2_complex_clock {\n\tconst char\t*name;\n\tconst char\t*parent_name;\n\tu32\t\tid;\n\tu32\t\tctrl_reg;\n\tu32\t\tctrl_clk_mask;\n\tu32\t\tctrl_rst_mask;\n\tu32\t\tphy_reg;\n\tu32\t\tphy_clk_mask;\n\tu32\t\tphy_rst_mask;\n\tenum hix5hd2_clk_type type;\n};\n\nstruct hix5hd2_clk_complex {\n\tstruct clk_hw\thw;\n\tu32\t\tid;\n\tvoid __iomem\t*ctrl_reg;\n\tu32\t\tctrl_clk_mask;\n\tu32\t\tctrl_rst_mask;\n\tvoid __iomem\t*phy_reg;\n\tu32\t\tphy_clk_mask;\n\tu32\t\tphy_rst_mask;\n};\n\nstatic struct hix5hd2_complex_clock hix5hd2_complex_clks[] __initdata = {\n\t{\"clk_mac0\", \"clk_fephy\", HIX5HD2_MAC0_CLK,\n\t\t0xcc, 0xa, 0x500, 0x120, 0, 0x10, TYPE_ETHER},\n\t{\"clk_mac1\", \"clk_fwd_sys\", HIX5HD2_MAC1_CLK,\n\t\t0xcc, 0x14, 0xa00, 0x168, 0x2, 0, TYPE_ETHER},\n\t{\"clk_sata\", NULL, HIX5HD2_SATA_CLK,\n\t\t0xa8, 0x1f, 0x300, 0xac, 0x1, 0x0, TYPE_COMPLEX},\n\t{\"clk_usb\", NULL, HIX5HD2_USB_CLK,\n\t\t0xb8, 0xff, 0x3f000, 0xbc, 0x7, 0x3f00, TYPE_COMPLEX},\n};\n\n#define to_complex_clk(_hw) container_of(_hw, struct hix5hd2_clk_complex, hw)\n\nstatic int clk_ether_prepare(struct clk_hw *hw)\n{\n\tstruct hix5hd2_clk_complex *clk = to_complex_clk(hw);\n\tu32 val;\n\n\tval = readl_relaxed(clk->ctrl_reg);\n\tval |= clk->ctrl_clk_mask | clk->ctrl_rst_mask;\n\twritel_relaxed(val, clk->ctrl_reg);\n\tval &= ~(clk->ctrl_rst_mask);\n\twritel_relaxed(val, clk->ctrl_reg);\n\n\tval = readl_relaxed(clk->phy_reg);\n\tval |= clk->phy_clk_mask;\n\tval &= ~(clk->phy_rst_mask);\n\twritel_relaxed(val, clk->phy_reg);\n\tmdelay(10);\n\n\tval &= ~(clk->phy_clk_mask);\n\tval |= clk->phy_rst_mask;\n\twritel_relaxed(val, clk->phy_reg);\n\tmdelay(10);\n\n\tval |= clk->phy_clk_mask;\n\tval &= ~(clk->phy_rst_mask);\n\twritel_relaxed(val, clk->phy_reg);\n\tmdelay(30);\n\treturn 0;\n}\n\nstatic void clk_ether_unprepare(struct clk_hw *hw)\n{\n\tstruct hix5hd2_clk_complex *clk = to_complex_clk(hw);\n\tu32 val;\n\n\tval = readl_relaxed(clk->ctrl_reg);\n\tval &= ~(clk->ctrl_clk_mask);\n\twritel_relaxed(val, clk->ctrl_reg);\n}\n\nstatic const struct clk_ops clk_ether_ops = {\n\t.prepare = clk_ether_prepare,\n\t.unprepare = clk_ether_unprepare,\n};\n\nstatic int clk_complex_enable(struct clk_hw *hw)\n{\n\tstruct hix5hd2_clk_complex *clk = to_complex_clk(hw);\n\tu32 val;\n\n\tval = readl_relaxed(clk->ctrl_reg);\n\tval |= clk->ctrl_clk_mask;\n\tval &= ~(clk->ctrl_rst_mask);\n\twritel_relaxed(val, clk->ctrl_reg);\n\n\tval = readl_relaxed(clk->phy_reg);\n\tval |= clk->phy_clk_mask;\n\tval &= ~(clk->phy_rst_mask);\n\twritel_relaxed(val, clk->phy_reg);\n\n\treturn 0;\n}\n\nstatic void clk_complex_disable(struct clk_hw *hw)\n{\n\tstruct hix5hd2_clk_complex *clk = to_complex_clk(hw);\n\tu32 val;\n\n\tval = readl_relaxed(clk->ctrl_reg);\n\tval |= clk->ctrl_rst_mask;\n\tval &= ~(clk->ctrl_clk_mask);\n\twritel_relaxed(val, clk->ctrl_reg);\n\n\tval = readl_relaxed(clk->phy_reg);\n\tval |= clk->phy_rst_mask;\n\tval &= ~(clk->phy_clk_mask);\n\twritel_relaxed(val, clk->phy_reg);\n}\n\nstatic const struct clk_ops clk_complex_ops = {\n\t.enable = clk_complex_enable,\n\t.disable = clk_complex_disable,\n};\n\nstatic void __init\nhix5hd2_clk_register_complex(struct hix5hd2_complex_clock *clks, int nums,\n\t\t\t     struct hisi_clock_data *data)\n{\n\tvoid __iomem *base = data->base;\n\tint i;\n\n\tfor (i = 0; i < nums; i++) {\n\t\tstruct hix5hd2_clk_complex *p_clk;\n\t\tstruct clk *clk;\n\t\tstruct clk_init_data init;\n\n\t\tp_clk = kzalloc(sizeof(*p_clk), GFP_KERNEL);\n\t\tif (!p_clk)\n\t\t\treturn;\n\n\t\tinit.name = clks[i].name;\n\t\tif (clks[i].type == TYPE_ETHER)\n\t\t\tinit.ops = &clk_ether_ops;\n\t\telse\n\t\t\tinit.ops = &clk_complex_ops;\n\n\t\tinit.flags = 0;\n\t\tinit.parent_names =\n\t\t\t(clks[i].parent_name ? &clks[i].parent_name : NULL);\n\t\tinit.num_parents = (clks[i].parent_name ? 1 : 0);\n\n\t\tp_clk->ctrl_reg = base + clks[i].ctrl_reg;\n\t\tp_clk->ctrl_clk_mask = clks[i].ctrl_clk_mask;\n\t\tp_clk->ctrl_rst_mask = clks[i].ctrl_rst_mask;\n\t\tp_clk->phy_reg = base + clks[i].phy_reg;\n\t\tp_clk->phy_clk_mask = clks[i].phy_clk_mask;\n\t\tp_clk->phy_rst_mask = clks[i].phy_rst_mask;\n\t\tp_clk->hw.init = &init;\n\n\t\tclk = clk_register(NULL, &p_clk->hw);\n\t\tif (IS_ERR(clk)) {\n\t\t\tkfree(p_clk);\n\t\t\tpr_err(\"%s: failed to register clock %s\\n\",\n\t\t\t       __func__, clks[i].name);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdata->clk_data.clks[clks[i].id] = clk;\n\t}\n}\n\nstatic void __init hix5hd2_clk_init(struct device_node *np)\n{\n\tstruct hisi_clock_data *clk_data;\n\n\tclk_data = hisi_clk_init(np, HIX5HD2_NR_CLKS);\n\tif (!clk_data)\n\t\treturn;\n\n\thisi_clk_register_fixed_rate(hix5hd2_fixed_rate_clks,\n\t\t\t\t     ARRAY_SIZE(hix5hd2_fixed_rate_clks),\n\t\t\t\t     clk_data);\n\thisi_clk_register_mux(hix5hd2_mux_clks, ARRAY_SIZE(hix5hd2_mux_clks),\n\t\t\t\t\tclk_data);\n\thisi_clk_register_gate(hix5hd2_gate_clks,\n\t\t\tARRAY_SIZE(hix5hd2_gate_clks), clk_data);\n\thix5hd2_clk_register_complex(hix5hd2_complex_clks,\n\t\t\t\t     ARRAY_SIZE(hix5hd2_complex_clks),\n\t\t\t\t     clk_data);\n}\n\nCLK_OF_DECLARE(hix5hd2_clk, \"hisilicon,hix5hd2-clock\", hix5hd2_clk_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}