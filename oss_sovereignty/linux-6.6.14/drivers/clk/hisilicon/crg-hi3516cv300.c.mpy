{
  "module_name": "crg-hi3516cv300.c",
  "hash_id": "e2252809670d8ab6d9ec545045784b57a209a25a8648d75dd73742fb62e49750",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/hisilicon/crg-hi3516cv300.c",
  "human_readable_source": "\n \n\n#include <dt-bindings/clock/hi3516cv300-clock.h>\n#include <linux/clk-provider.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include \"clk.h\"\n#include \"crg.h\"\n#include \"reset.h\"\n\n \n#define HI3516CV300_INNER_CLK_OFFSET\t64\n#define HI3516CV300_FIXED_3M\t\t65\n#define HI3516CV300_FIXED_6M\t\t66\n#define HI3516CV300_FIXED_24M\t\t67\n#define HI3516CV300_FIXED_49P5\t\t68\n#define HI3516CV300_FIXED_50M\t\t69\n#define HI3516CV300_FIXED_83P3M\t\t70\n#define HI3516CV300_FIXED_99M\t\t71\n#define HI3516CV300_FIXED_100M\t\t72\n#define HI3516CV300_FIXED_148P5M\t73\n#define HI3516CV300_FIXED_198M\t\t74\n#define HI3516CV300_FIXED_297M\t\t75\n#define HI3516CV300_UART_MUX\t\t76\n#define HI3516CV300_FMC_MUX\t\t77\n#define HI3516CV300_MMC0_MUX\t\t78\n#define HI3516CV300_MMC1_MUX\t\t79\n#define HI3516CV300_MMC2_MUX\t\t80\n#define HI3516CV300_MMC3_MUX\t\t81\n#define HI3516CV300_PWM_MUX\t\t82\n#define HI3516CV300_CRG_NR_CLKS\t\t128\n\nstatic const struct hisi_fixed_rate_clock hi3516cv300_fixed_rate_clks[] = {\n\t{ HI3516CV300_FIXED_3M, \"3m\", NULL, 0, 3000000, },\n\t{ HI3516CV300_FIXED_6M, \"6m\", NULL, 0, 6000000, },\n\t{ HI3516CV300_FIXED_24M, \"24m\", NULL, 0, 24000000, },\n\t{ HI3516CV300_FIXED_49P5, \"49.5m\", NULL, 0, 49500000, },\n\t{ HI3516CV300_FIXED_50M, \"50m\", NULL, 0, 50000000, },\n\t{ HI3516CV300_FIXED_83P3M, \"83.3m\", NULL, 0, 83300000, },\n\t{ HI3516CV300_FIXED_99M, \"99m\", NULL, 0, 99000000, },\n\t{ HI3516CV300_FIXED_100M, \"100m\", NULL, 0, 100000000, },\n\t{ HI3516CV300_FIXED_148P5M, \"148.5m\", NULL, 0, 148500000, },\n\t{ HI3516CV300_FIXED_198M, \"198m\", NULL, 0, 198000000, },\n\t{ HI3516CV300_FIXED_297M, \"297m\", NULL, 0, 297000000, },\n\t{ HI3516CV300_APB_CLK, \"apb\", NULL, 0, 50000000, },\n};\n\nstatic const char *const uart_mux_p[] = {\"24m\", \"6m\"};\nstatic const char *const fmc_mux_p[] = {\n\t\"24m\", \"83.3m\", \"148.5m\", \"198m\", \"297m\"\n};\nstatic const char *const mmc_mux_p[] = {\"49.5m\"};\nstatic const char *const mmc2_mux_p[] = {\"99m\", \"49.5m\"};\nstatic const char *const pwm_mux_p[] = {\"3m\", \"50m\", \"24m\", \"24m\"};\n\nstatic u32 uart_mux_table[] = {0, 1};\nstatic u32 fmc_mux_table[] = {0, 1, 2, 3, 4};\nstatic u32 mmc_mux_table[] = {0};\nstatic u32 mmc2_mux_table[] = {0, 2};\nstatic u32 pwm_mux_table[] = {0, 1, 2, 3};\n\nstatic const struct hisi_mux_clock hi3516cv300_mux_clks[] = {\n\t{ HI3516CV300_UART_MUX, \"uart_mux\", uart_mux_p, ARRAY_SIZE(uart_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xe4, 19, 1, 0, uart_mux_table, },\n\t{ HI3516CV300_FMC_MUX, \"fmc_mux\", fmc_mux_p, ARRAY_SIZE(fmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xc0, 2, 3, 0, fmc_mux_table, },\n\t{ HI3516CV300_MMC0_MUX, \"mmc0_mux\", mmc_mux_p, ARRAY_SIZE(mmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xc4, 4, 2, 0, mmc_mux_table, },\n\t{ HI3516CV300_MMC1_MUX, \"mmc1_mux\", mmc_mux_p, ARRAY_SIZE(mmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xc4, 12, 2, 0, mmc_mux_table, },\n\t{ HI3516CV300_MMC2_MUX, \"mmc2_mux\", mmc2_mux_p, ARRAY_SIZE(mmc2_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xc4, 20, 2, 0, mmc2_mux_table, },\n\t{ HI3516CV300_MMC3_MUX, \"mmc3_mux\", mmc_mux_p, ARRAY_SIZE(mmc_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0xc8, 4, 2, 0, mmc_mux_table, },\n\t{ HI3516CV300_PWM_MUX, \"pwm_mux\", pwm_mux_p, ARRAY_SIZE(pwm_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x38, 2, 2, 0, pwm_mux_table, },\n};\n\nstatic const struct hisi_gate_clock hi3516cv300_gate_clks[] = {\n\n\t{ HI3516CV300_UART0_CLK, \"clk_uart0\", \"uart_mux\", CLK_SET_RATE_PARENT,\n\t\t0xe4, 15, 0, },\n\t{ HI3516CV300_UART1_CLK, \"clk_uart1\", \"uart_mux\", CLK_SET_RATE_PARENT,\n\t\t0xe4, 16, 0, },\n\t{ HI3516CV300_UART2_CLK, \"clk_uart2\", \"uart_mux\", CLK_SET_RATE_PARENT,\n\t\t0xe4, 17, 0, },\n\n\t{ HI3516CV300_SPI0_CLK, \"clk_spi0\", \"100m\", CLK_SET_RATE_PARENT,\n\t\t0xe4, 13, 0, },\n\t{ HI3516CV300_SPI1_CLK, \"clk_spi1\", \"100m\", CLK_SET_RATE_PARENT,\n\t\t0xe4, 14, 0, },\n\n\t{ HI3516CV300_FMC_CLK, \"clk_fmc\", \"fmc_mux\", CLK_SET_RATE_PARENT,\n\t\t0xc0, 1, 0, },\n\t{ HI3516CV300_MMC0_CLK, \"clk_mmc0\", \"mmc0_mux\", CLK_SET_RATE_PARENT,\n\t\t0xc4, 1, 0, },\n\t{ HI3516CV300_MMC1_CLK, \"clk_mmc1\", \"mmc1_mux\", CLK_SET_RATE_PARENT,\n\t\t0xc4, 9, 0, },\n\t{ HI3516CV300_MMC2_CLK, \"clk_mmc2\", \"mmc2_mux\", CLK_SET_RATE_PARENT,\n\t\t0xc4, 17, 0, },\n\t{ HI3516CV300_MMC3_CLK, \"clk_mmc3\", \"mmc3_mux\", CLK_SET_RATE_PARENT,\n\t\t0xc8, 1, 0, },\n\n\t{ HI3516CV300_ETH_CLK, \"clk_eth\", NULL, 0, 0xec, 1, 0, },\n\n\t{ HI3516CV300_DMAC_CLK, \"clk_dmac\", NULL, 0, 0xd8, 5, 0, },\n\t{ HI3516CV300_PWM_CLK, \"clk_pwm\", \"pwm_mux\", CLK_SET_RATE_PARENT,\n\t\t0x38, 1, 0, },\n\n\t{ HI3516CV300_USB2_BUS_CLK, \"clk_usb2_bus\", NULL, 0, 0xb8, 0, 0, },\n\t{ HI3516CV300_USB2_OHCI48M_CLK, \"clk_usb2_ohci48m\", NULL, 0,\n\t\t0xb8, 1, 0, },\n\t{ HI3516CV300_USB2_OHCI12M_CLK, \"clk_usb2_ohci12m\", NULL, 0,\n\t\t0xb8, 2, 0, },\n\t{ HI3516CV300_USB2_OTG_UTMI_CLK, \"clk_usb2_otg_utmi\", NULL, 0,\n\t\t0xb8, 3, 0, },\n\t{ HI3516CV300_USB2_HST_PHY_CLK, \"clk_usb2_hst_phy\", NULL, 0,\n\t\t0xb8, 4, 0, },\n\t{ HI3516CV300_USB2_UTMI0_CLK, \"clk_usb2_utmi0\", NULL, 0, 0xb8, 5, 0, },\n\t{ HI3516CV300_USB2_PHY_CLK, \"clk_usb2_phy\", NULL, 0, 0xb8, 7, 0, },\n};\n\nstatic struct hisi_clock_data *hi3516cv300_clk_register(\n\t\tstruct platform_device *pdev)\n{\n\tstruct hisi_clock_data *clk_data;\n\tint ret;\n\n\tclk_data = hisi_clk_alloc(pdev, HI3516CV300_CRG_NR_CLKS);\n\tif (!clk_data)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tret = hisi_clk_register_fixed_rate(hi3516cv300_fixed_rate_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_fixed_rate_clks), clk_data);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\tret = hisi_clk_register_mux(hi3516cv300_mux_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_mux_clks), clk_data);\n\tif (ret)\n\t\tgoto unregister_fixed_rate;\n\n\tret = hisi_clk_register_gate(hi3516cv300_gate_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_gate_clks), clk_data);\n\tif (ret)\n\t\tgoto unregister_mux;\n\n\tret = of_clk_add_provider(pdev->dev.of_node,\n\t\t\tof_clk_src_onecell_get, &clk_data->clk_data);\n\tif (ret)\n\t\tgoto unregister_gate;\n\n\treturn clk_data;\n\nunregister_gate:\n\thisi_clk_unregister_gate(hi3516cv300_gate_clks,\n\t\t\t\tARRAY_SIZE(hi3516cv300_gate_clks), clk_data);\nunregister_mux:\n\thisi_clk_unregister_mux(hi3516cv300_mux_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_mux_clks), clk_data);\nunregister_fixed_rate:\n\thisi_clk_unregister_fixed_rate(hi3516cv300_fixed_rate_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_fixed_rate_clks), clk_data);\n\treturn ERR_PTR(ret);\n}\n\nstatic void hi3516cv300_clk_unregister(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(pdev->dev.of_node);\n\n\thisi_clk_unregister_gate(hi3516cv300_gate_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_gate_clks), crg->clk_data);\n\thisi_clk_unregister_mux(hi3516cv300_mux_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_mux_clks), crg->clk_data);\n\thisi_clk_unregister_fixed_rate(hi3516cv300_fixed_rate_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_fixed_rate_clks), crg->clk_data);\n}\n\nstatic const struct hisi_crg_funcs hi3516cv300_crg_funcs = {\n\t.register_clks = hi3516cv300_clk_register,\n\t.unregister_clks = hi3516cv300_clk_unregister,\n};\n\n \n#define HI3516CV300_SYSCTRL_NR_CLKS 16\n\nstatic const char *const wdt_mux_p[] __initconst = { \"3m\", \"apb\" };\nstatic u32 wdt_mux_table[] = {0, 1};\n\nstatic const struct hisi_mux_clock hi3516cv300_sysctrl_mux_clks[] = {\n\t{ HI3516CV300_WDT_CLK, \"wdt\", wdt_mux_p, ARRAY_SIZE(wdt_mux_p),\n\t\tCLK_SET_RATE_PARENT, 0x0, 23, 1, 0, wdt_mux_table, },\n};\n\nstatic struct hisi_clock_data *hi3516cv300_sysctrl_clk_register(\n\t\tstruct platform_device *pdev)\n{\n\tstruct hisi_clock_data *clk_data;\n\tint ret;\n\n\tclk_data = hisi_clk_alloc(pdev, HI3516CV300_SYSCTRL_NR_CLKS);\n\tif (!clk_data)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tret = hisi_clk_register_mux(hi3516cv300_sysctrl_mux_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_sysctrl_mux_clks), clk_data);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\n\tret = of_clk_add_provider(pdev->dev.of_node,\n\t\t\tof_clk_src_onecell_get, &clk_data->clk_data);\n\tif (ret)\n\t\tgoto unregister_mux;\n\n\treturn clk_data;\n\nunregister_mux:\n\thisi_clk_unregister_mux(hi3516cv300_sysctrl_mux_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_sysctrl_mux_clks), clk_data);\n\treturn ERR_PTR(ret);\n}\n\nstatic void hi3516cv300_sysctrl_clk_unregister(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(pdev->dev.of_node);\n\n\thisi_clk_unregister_mux(hi3516cv300_sysctrl_mux_clks,\n\t\t\tARRAY_SIZE(hi3516cv300_sysctrl_mux_clks),\n\t\t\tcrg->clk_data);\n}\n\nstatic const struct hisi_crg_funcs hi3516cv300_sysctrl_funcs = {\n\t.register_clks = hi3516cv300_sysctrl_clk_register,\n\t.unregister_clks = hi3516cv300_sysctrl_clk_unregister,\n};\n\nstatic const struct of_device_id hi3516cv300_crg_match_table[] = {\n\t{\n\t\t.compatible = \"hisilicon,hi3516cv300-crg\",\n\t\t.data = &hi3516cv300_crg_funcs\n\t},\n\t{\n\t\t.compatible = \"hisilicon,hi3516cv300-sysctrl\",\n\t\t.data = &hi3516cv300_sysctrl_funcs\n\t},\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, hi3516cv300_crg_match_table);\n\nstatic int hi3516cv300_crg_probe(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg;\n\n\tcrg = devm_kmalloc(&pdev->dev, sizeof(*crg), GFP_KERNEL);\n\tif (!crg)\n\t\treturn -ENOMEM;\n\n\tcrg->funcs = of_device_get_match_data(&pdev->dev);\n\tif (!crg->funcs)\n\t\treturn -ENOENT;\n\n\tcrg->rstc = hisi_reset_init(pdev);\n\tif (!crg->rstc)\n\t\treturn -ENOMEM;\n\n\tcrg->clk_data = crg->funcs->register_clks(pdev);\n\tif (IS_ERR(crg->clk_data)) {\n\t\thisi_reset_exit(crg->rstc);\n\t\treturn PTR_ERR(crg->clk_data);\n\t}\n\n\tplatform_set_drvdata(pdev, crg);\n\treturn 0;\n}\n\nstatic void hi3516cv300_crg_remove(struct platform_device *pdev)\n{\n\tstruct hisi_crg_dev *crg = platform_get_drvdata(pdev);\n\n\thisi_reset_exit(crg->rstc);\n\tcrg->funcs->unregister_clks(pdev);\n}\n\nstatic struct platform_driver hi3516cv300_crg_driver = {\n\t.probe          = hi3516cv300_crg_probe,\n\t.remove_new\t= hi3516cv300_crg_remove,\n\t.driver         = {\n\t\t.name   = \"hi3516cv300-crg\",\n\t\t.of_match_table = hi3516cv300_crg_match_table,\n\t},\n};\n\nstatic int __init hi3516cv300_crg_init(void)\n{\n\treturn platform_driver_register(&hi3516cv300_crg_driver);\n}\ncore_initcall(hi3516cv300_crg_init);\n\nstatic void __exit hi3516cv300_crg_exit(void)\n{\n\tplatform_driver_unregister(&hi3516cv300_crg_driver);\n}\nmodule_exit(hi3516cv300_crg_exit);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"HiSilicon Hi3516CV300 CRG Driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}