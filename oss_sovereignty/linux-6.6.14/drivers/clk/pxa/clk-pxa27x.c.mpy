{
  "module_name": "clk-pxa27x.c",
  "hash_id": "f2ec969712815f9a7678f41bb9c6694a19a188c44caec0c5e646024f8201d9b4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/pxa/clk-pxa27x.c",
  "human_readable_source": "\n \n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <linux/clk.h>\n#include <linux/clkdev.h>\n#include <linux/of.h>\n#include <linux/soc/pxa/smemc.h>\n#include <linux/clk/pxa.h>\n\n#include <dt-bindings/clock/pxa-clock.h>\n#include \"clk-pxa.h\"\n#include \"clk-pxa2xx.h\"\n\n#define KHz 1000\n#define MHz (1000 * 1000)\n\nenum {\n\tPXA_CORE_13Mhz = 0,\n\tPXA_CORE_RUN,\n\tPXA_CORE_TURBO,\n};\n\nenum {\n\tPXA_BUS_13Mhz = 0,\n\tPXA_BUS_RUN,\n};\n\nenum {\n\tPXA_LCD_13Mhz = 0,\n\tPXA_LCD_RUN,\n};\n\nenum {\n\tPXA_MEM_13Mhz = 0,\n\tPXA_MEM_SYSTEM_BUS,\n\tPXA_MEM_RUN,\n};\n\n#define PXA27x_CLKCFG(B, HT, T)\t\t\t\\\n\t(CLKCFG_FCS |\t\t\t\t\\\n\t ((B)  ? CLKCFG_FASTBUS : 0) |\t\t\\\n\t ((HT) ? CLKCFG_HALFTURBO : 0) |\t\\\n\t ((T)  ? CLKCFG_TURBO : 0))\n#define PXA27x_CCCR(A, L, N2) (A << 25 | N2 << 7 | L)\n\n \n#define SDRAM_TREF\t64\t \n\nstatic void __iomem *clk_regs;\n\nstatic const char * const get_freq_khz[] = {\n\t\"core\", \"run\", \"cpll\", \"memory\",\n\t\"system_bus\"\n};\n\nstatic u32 mdrefr_dri(unsigned int freq_khz)\n{\n\tu32 interval = freq_khz * SDRAM_TREF / pxa2xx_smemc_get_sdram_rows();\n\n\treturn (interval - 31) / 32;\n}\n\n \nunsigned int pxa27x_get_clk_frequency_khz(int info)\n{\n\tstruct clk *clk;\n\tunsigned long clks[5];\n\tint i;\n\n\tfor (i = 0; i < 5; i++) {\n\t\tclk = clk_get(NULL, get_freq_khz[i]);\n\t\tif (IS_ERR(clk)) {\n\t\t\tclks[i] = 0;\n\t\t} else {\n\t\t\tclks[i] = clk_get_rate(clk);\n\t\t\tclk_put(clk);\n\t\t}\n\t}\n\tif (info) {\n\t\tpr_info(\"Run Mode clock: %ld.%02ldMHz\\n\",\n\t\t\tclks[1] / 1000000, (clks[1] % 1000000) / 10000);\n\t\tpr_info(\"Turbo Mode clock: %ld.%02ldMHz\\n\",\n\t\t\tclks[2] / 1000000, (clks[2] % 1000000) / 10000);\n\t\tpr_info(\"Memory clock: %ld.%02ldMHz\\n\",\n\t\t\tclks[3] / 1000000, (clks[3] % 1000000) / 10000);\n\t\tpr_info(\"System bus clock: %ld.%02ldMHz\\n\",\n\t\t\tclks[4] / 1000000, (clks[4] % 1000000) / 10000);\n\t}\n\treturn (unsigned int)clks[0] / KHz;\n}\n\nstatic bool pxa27x_is_ppll_disabled(void)\n{\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\n\treturn ccsr & (1 << CCCR_PPDIS_BIT);\n}\n\n#define PXA27X_CKEN(dev_id, con_id, parents, mult_hp, div_hp,\t\t\\\n\t\t    bit, is_lp, flags)\t\t\t\t\t\\\n\tPXA_CKEN(dev_id, con_id, bit, parents, 1, 1, mult_hp, div_hp,\t\\\n\t\t is_lp,  CKEN, CKEN_ ## bit, flags)\n#define PXA27X_PBUS_CKEN(dev_id, con_id, bit, mult_hp, div_hp, delay)\t\\\n\tPXA27X_CKEN(dev_id, con_id, pxa27x_pbus_parents, mult_hp,\t\\\n\t\t    div_hp, bit, pxa27x_is_ppll_disabled, 0)\n\nPARENTS(pxa27x_pbus) = { \"osc_13mhz\", \"ppll_312mhz\" };\nPARENTS(pxa27x_sbus) = { \"system_bus\", \"system_bus\" };\nPARENTS(pxa27x_32Mhz_bus) = { \"osc_32_768khz\", \"osc_32_768khz\" };\nPARENTS(pxa27x_lcd_bus) = { \"lcd_base\", \"lcd_base\" };\nPARENTS(pxa27x_membus) = { \"lcd_base\", \"lcd_base\" };\n\n#define PXA27X_CKEN_1RATE(dev_id, con_id, bit, parents, delay)\t\t\\\n\tPXA_CKEN_1RATE(dev_id, con_id, bit, parents,\t\t\t\\\n\t\t       CKEN, CKEN_ ## bit, 0)\n#define PXA27X_CKEN_1RATE_AO(dev_id, con_id, bit, parents, delay)\t\\\n\tPXA_CKEN_1RATE(dev_id, con_id, bit, parents,\t\t\t\\\n\t\t       CKEN, CKEN_ ## bit, CLK_IGNORE_UNUSED)\n\nstatic struct desc_clk_cken pxa27x_clocks[] __initdata = {\n\tPXA27X_PBUS_CKEN(\"pxa2xx-uart.0\", NULL, FFUART, 2, 42, 1),\n\tPXA27X_PBUS_CKEN(\"pxa2xx-uart.1\", NULL, BTUART, 2, 42, 1),\n\tPXA27X_PBUS_CKEN(\"pxa2xx-uart.2\", NULL, STUART, 2, 42, 1),\n\tPXA27X_PBUS_CKEN(\"pxa2xx-i2s\", NULL, I2S, 2, 51, 0),\n\tPXA27X_PBUS_CKEN(\"pxa2xx-i2c.0\", NULL, I2C, 2, 19, 0),\n\tPXA27X_PBUS_CKEN(\"pxa27x-udc\", NULL, USB, 2, 13, 5),\n\tPXA27X_PBUS_CKEN(\"pxa2xx-mci.0\", NULL, MMC, 2, 32, 0),\n\tPXA27X_PBUS_CKEN(\"pxa2xx-ir\", \"FICPCLK\", FICP, 2, 13, 0),\n\tPXA27X_PBUS_CKEN(\"pxa27x-ohci\", NULL, USBHOST, 2, 13, 0),\n\tPXA27X_PBUS_CKEN(\"pxa2xx-i2c.1\", NULL, PWRI2C, 1, 24, 0),\n\tPXA27X_PBUS_CKEN(\"pxa27x-ssp.0\", NULL, SSP1, 1, 24, 0),\n\tPXA27X_PBUS_CKEN(\"pxa27x-ssp.1\", NULL, SSP2, 1, 24, 0),\n\tPXA27X_PBUS_CKEN(\"pxa27x-ssp.2\", NULL, SSP3, 1, 24, 0),\n\tPXA27X_PBUS_CKEN(\"pxa27x-pwm.0\", NULL, PWM0, 1, 24, 0),\n\tPXA27X_PBUS_CKEN(\"pxa27x-pwm.1\", NULL, PWM1, 1, 24, 0),\n\tPXA27X_PBUS_CKEN(NULL, \"MSLCLK\", MSL, 2, 13, 0),\n\tPXA27X_PBUS_CKEN(NULL, \"USIMCLK\", USIM, 2, 13, 0),\n\tPXA27X_PBUS_CKEN(NULL, \"MSTKCLK\", MEMSTK, 2, 32, 0),\n\tPXA27X_PBUS_CKEN(NULL, \"AC97CLK\", AC97, 1, 1, 0),\n\tPXA27X_PBUS_CKEN(NULL, \"AC97CONFCLK\", AC97CONF, 1, 1, 0),\n\tPXA27X_PBUS_CKEN(NULL, \"OSTIMER0\", OSTIMER, 1, 96, 0),\n\n\tPXA27X_CKEN_1RATE(\"pxa27x-keypad\", NULL, KEYPAD,\n\t\t\t  pxa27x_32Mhz_bus_parents, 0),\n\tPXA27X_CKEN_1RATE(NULL, \"IMCLK\", IM, pxa27x_sbus_parents, 0),\n\tPXA27X_CKEN_1RATE(\"pxa2xx-fb\", NULL, LCD, pxa27x_lcd_bus_parents, 0),\n\tPXA27X_CKEN_1RATE(\"pxa27x-camera.0\", NULL, CAMERA,\n\t\t\t  pxa27x_lcd_bus_parents, 0),\n\tPXA27X_CKEN_1RATE_AO(\"pxa2xx-pcmcia\", NULL, MEMC,\n\t\t\t     pxa27x_membus_parents, 0),\n\n};\n\n \nstatic struct pxa2xx_freq pxa27x_freqs[] = {\n\t{104000000, 104000, PXA27x_CCCR(1,  8, 2), 0, PXA27x_CLKCFG(1, 0, 1) },\n\t{156000000, 104000, PXA27x_CCCR(1,  8, 3), 0, PXA27x_CLKCFG(1, 0, 1) },\n\t{208000000, 208000, PXA27x_CCCR(0, 16, 2), 1, PXA27x_CLKCFG(0, 0, 1) },\n\t{312000000, 208000, PXA27x_CCCR(1, 16, 3), 1, PXA27x_CLKCFG(1, 0, 1) },\n\t{416000000, 208000, PXA27x_CCCR(1, 16, 4), 1, PXA27x_CLKCFG(1, 0, 1) },\n\t{520000000, 208000, PXA27x_CCCR(1, 16, 5), 1, PXA27x_CLKCFG(1, 0, 1) },\n\t{624000000, 208000, PXA27x_CCCR(1, 16, 6), 1, PXA27x_CLKCFG(1, 0, 1) },\n};\n\nstatic unsigned long clk_pxa27x_cpll_get_rate(struct clk_hw *hw,\n\tunsigned long parent_rate)\n{\n\tunsigned long clkcfg;\n\tunsigned int t, ht;\n\tunsigned int l, L, n2, N;\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\n\tasm(\"mrc\\tp14, 0, %0, c6, c0, 0\" : \"=r\" (clkcfg));\n\tt  = clkcfg & (1 << 0);\n\tht = clkcfg & (1 << 2);\n\n\tl  = ccsr & CCSR_L_MASK;\n\tn2 = (ccsr & CCSR_N2_MASK) >> CCSR_N2_SHIFT;\n\tL  = l * parent_rate;\n\tN  = (L * n2) / 2;\n\n\treturn N;\n}\n\nstatic int clk_pxa27x_cpll_determine_rate(struct clk_hw *hw,\n\t\t\t\t\t  struct clk_rate_request *req)\n{\n\treturn pxa2xx_determine_rate(req, pxa27x_freqs,\n\t\t\t\t     ARRAY_SIZE(pxa27x_freqs));\n}\n\nstatic int clk_pxa27x_cpll_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t    unsigned long parent_rate)\n{\n\tint i;\n\n\tpr_debug(\"%s(rate=%lu parent_rate=%lu)\\n\", __func__, rate, parent_rate);\n\tfor (i = 0; i < ARRAY_SIZE(pxa27x_freqs); i++)\n\t\tif (pxa27x_freqs[i].cpll == rate)\n\t\t\tbreak;\n\n\tif (i >= ARRAY_SIZE(pxa27x_freqs))\n\t\treturn -EINVAL;\n\n\tpxa2xx_cpll_change(&pxa27x_freqs[i], mdrefr_dri, clk_regs + CCCR);\n\treturn 0;\n}\n\nPARENTS(clk_pxa27x_cpll) = { \"osc_13mhz\" };\nRATE_OPS(clk_pxa27x_cpll, \"cpll\");\n\nstatic unsigned long clk_pxa27x_lcd_base_get_rate(struct clk_hw *hw,\n\t\t\t\t\t\t  unsigned long parent_rate)\n{\n\tunsigned int l, osc_forced;\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\tunsigned long cccr = readl(clk_regs + CCCR);\n\n\tl  = ccsr & CCSR_L_MASK;\n\tosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\n\tif (osc_forced) {\n\t\tif (cccr & (1 << CCCR_LCD_26_BIT))\n\t\t\treturn parent_rate * 2;\n\t\telse\n\t\t\treturn parent_rate;\n\t}\n\n\tif (l <= 7)\n\t\treturn parent_rate;\n\tif (l <= 16)\n\t\treturn parent_rate / 2;\n\treturn parent_rate / 4;\n}\n\nstatic u8 clk_pxa27x_lcd_base_get_parent(struct clk_hw *hw)\n{\n\tunsigned int osc_forced;\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\n\tosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\n\tif (osc_forced)\n\t\treturn PXA_LCD_13Mhz;\n\telse\n\t\treturn PXA_LCD_RUN;\n}\n\nPARENTS(clk_pxa27x_lcd_base) = { \"osc_13mhz\", \"run\" };\nMUX_RO_RATE_RO_OPS(clk_pxa27x_lcd_base, \"lcd_base\");\n\nstatic void __init pxa27x_register_plls(void)\n{\n\tclk_register_fixed_rate(NULL, \"osc_13mhz\", NULL,\n\t\t\t\tCLK_GET_RATE_NOCACHE,\n\t\t\t\t13 * MHz);\n\tclkdev_pxa_register(CLK_OSC32k768, \"osc_32_768khz\", NULL,\n\t\t\t    clk_register_fixed_rate(NULL, \"osc_32_768khz\", NULL,\n\t\t\t\t\t\t    CLK_GET_RATE_NOCACHE,\n\t\t\t\t\t\t    32768 * KHz));\n\tclk_register_fixed_rate(NULL, \"clk_dummy\", NULL, 0, 0);\n\tclk_register_fixed_factor(NULL, \"ppll_312mhz\", \"osc_13mhz\", 0, 24, 1);\n}\n\nstatic u8 clk_pxa27x_core_get_parent(struct clk_hw *hw)\n{\n\tunsigned long clkcfg;\n\tunsigned int t, ht, osc_forced;\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\n\tosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\n\tif (osc_forced)\n\t\treturn PXA_CORE_13Mhz;\n\n\tasm(\"mrc\\tp14, 0, %0, c6, c0, 0\" : \"=r\" (clkcfg));\n\tt  = clkcfg & (1 << 0);\n\tht = clkcfg & (1 << 2);\n\n\tif (ht || t)\n\t\treturn PXA_CORE_TURBO;\n\treturn PXA_CORE_RUN;\n}\n\nstatic int clk_pxa27x_core_set_parent(struct clk_hw *hw, u8 index)\n{\n\tif (index > PXA_CORE_TURBO)\n\t\treturn -EINVAL;\n\n\tpxa2xx_core_turbo_switch(index == PXA_CORE_TURBO);\n\n\treturn 0;\n}\n\nstatic int clk_pxa27x_core_determine_rate(struct clk_hw *hw,\n\t\t\t\t\t  struct clk_rate_request *req)\n{\n\treturn __clk_mux_determine_rate(hw, req);\n}\n\nPARENTS(clk_pxa27x_core) = { \"osc_13mhz\", \"run\", \"cpll\" };\nMUX_OPS(clk_pxa27x_core, \"core\", CLK_SET_RATE_PARENT);\n\nstatic unsigned long clk_pxa27x_run_get_rate(struct clk_hw *hw,\n\t\t\t\t\t     unsigned long parent_rate)\n{\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\tunsigned int n2 = (ccsr & CCSR_N2_MASK) >> CCSR_N2_SHIFT;\n\n\treturn (parent_rate / n2) * 2;\n}\nPARENTS(clk_pxa27x_run) = { \"cpll\" };\nRATE_RO_OPS(clk_pxa27x_run, \"run\");\n\nstatic void __init pxa27x_register_core(void)\n{\n\tclkdev_pxa_register(CLK_NONE, \"cpll\", NULL,\n\t\t\t    clk_register_clk_pxa27x_cpll());\n\tclkdev_pxa_register(CLK_NONE, \"run\", NULL,\n\t\t\t    clk_register_clk_pxa27x_run());\n\tclkdev_pxa_register(CLK_CORE, \"core\", NULL,\n\t\t\t    clk_register_clk_pxa27x_core());\n}\n\nstatic unsigned long clk_pxa27x_system_bus_get_rate(struct clk_hw *hw,\n\t\t\t\t\t\t    unsigned long parent_rate)\n{\n\tunsigned long clkcfg;\n\tunsigned int b, osc_forced;\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\n\tosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\n\tasm(\"mrc\\tp14, 0, %0, c6, c0, 0\" : \"=r\" (clkcfg));\n\tb  = clkcfg & (1 << 3);\n\n\tif (osc_forced)\n\t\treturn parent_rate;\n\tif (b)\n\t\treturn parent_rate;\n\telse\n\t\treturn parent_rate / 2;\n}\n\nstatic u8 clk_pxa27x_system_bus_get_parent(struct clk_hw *hw)\n{\n\tunsigned int osc_forced;\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\n\tosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\n\tif (osc_forced)\n\t\treturn PXA_BUS_13Mhz;\n\telse\n\t\treturn PXA_BUS_RUN;\n}\n\nPARENTS(clk_pxa27x_system_bus) = { \"osc_13mhz\", \"run\" };\nMUX_RO_RATE_RO_OPS(clk_pxa27x_system_bus, \"system_bus\");\n\nstatic unsigned long clk_pxa27x_memory_get_rate(struct clk_hw *hw,\n\t\t\t\t\t\tunsigned long parent_rate)\n{\n\tunsigned int a, l, osc_forced;\n\tunsigned long cccr = readl(clk_regs + CCCR);\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\n\tosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\n\ta = cccr & (1 << CCCR_A_BIT);\n\tl  = ccsr & CCSR_L_MASK;\n\n\tif (osc_forced || a)\n\t\treturn parent_rate;\n\tif (l <= 10)\n\t\treturn parent_rate;\n\tif (l <= 20)\n\t\treturn parent_rate / 2;\n\treturn parent_rate / 4;\n}\n\nstatic u8 clk_pxa27x_memory_get_parent(struct clk_hw *hw)\n{\n\tunsigned int osc_forced, a;\n\tunsigned long cccr = readl(clk_regs + CCCR);\n\tunsigned long ccsr = readl(clk_regs + CCSR);\n\n\tosc_forced = ccsr & (1 << CCCR_CPDIS_BIT);\n\ta = cccr & (1 << CCCR_A_BIT);\n\tif (osc_forced)\n\t\treturn PXA_MEM_13Mhz;\n\tif (a)\n\t\treturn PXA_MEM_SYSTEM_BUS;\n\telse\n\t\treturn PXA_MEM_RUN;\n}\n\nPARENTS(clk_pxa27x_memory) = { \"osc_13mhz\", \"system_bus\", \"run\" };\nMUX_RO_RATE_RO_OPS(clk_pxa27x_memory, \"memory\");\n\n#define DUMMY_CLK(_con_id, _dev_id, _parent) \\\n\t{ .con_id = _con_id, .dev_id = _dev_id, .parent = _parent }\nstruct dummy_clk {\n\tconst char *con_id;\n\tconst char *dev_id;\n\tconst char *parent;\n};\nstatic struct dummy_clk dummy_clks[] __initdata = {\n\tDUMMY_CLK(NULL, \"pxa27x-gpio\", \"osc_32_768khz\"),\n\tDUMMY_CLK(NULL, \"pxa-rtc\", \"osc_32_768khz\"),\n\tDUMMY_CLK(NULL, \"sa1100-rtc\", \"osc_32_768khz\"),\n\tDUMMY_CLK(\"UARTCLK\", \"pxa2xx-ir\", \"STUART\"),\n};\n\nstatic void __init pxa27x_dummy_clocks_init(void)\n{\n\tstruct clk *clk;\n\tstruct dummy_clk *d;\n\tconst char *name;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(dummy_clks); i++) {\n\t\td = &dummy_clks[i];\n\t\tname = d->dev_id ? d->dev_id : d->con_id;\n\t\tclk = clk_register_fixed_factor(NULL, name, d->parent, 0, 1, 1);\n\t\tclk_register_clkdev(clk, d->con_id, d->dev_id);\n\t}\n}\n\nstatic void __init pxa27x_base_clocks_init(void)\n{\n\tpxa27x_register_plls();\n\tpxa27x_register_core();\n\tclkdev_pxa_register(CLK_NONE, \"system_bus\", NULL,\n\t\t\t    clk_register_clk_pxa27x_system_bus());\n\tclkdev_pxa_register(CLK_NONE, \"memory\", NULL,\n\t\t\t    clk_register_clk_pxa27x_memory());\n\tclk_register_clk_pxa27x_lcd_base();\n}\n\nint __init pxa27x_clocks_init(void __iomem *regs)\n{\n\tclk_regs = regs;\n\tpxa27x_base_clocks_init();\n\tpxa27x_dummy_clocks_init();\n\treturn clk_pxa_cken_init(pxa27x_clocks, ARRAY_SIZE(pxa27x_clocks), regs);\n}\n\nstatic void __init pxa27x_dt_clocks_init(struct device_node *np)\n{\n\tpxa27x_clocks_init(ioremap(0x41300000ul, 0x10));\n\tclk_pxa_dt_common_init(np);\n}\nCLK_OF_DECLARE(pxa_clks, \"marvell,pxa270-clocks\", pxa27x_dt_clocks_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}