{
  "module_name": "clk-bd718x7.c",
  "hash_id": "be1e72f2db64a3adc2be85fe099be7f35eaba77e0c52fb0322ab28152520a905",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/clk-bd718x7.c",
  "human_readable_source": "\n\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/mfd/rohm-generic.h>\n#include <linux/clk-provider.h>\n#include <linux/clkdev.h>\n#include <linux/regmap.h>\n\n \n \n#define BD71815_REG_OUT32K\t0x1d\n \n#define BD71828_REG_OUT32K\t0x4B\n \n#define BD718XX_REG_OUT32K\t0x2E\n\n \n#define CLK_OUT_EN_MASK\t\tBIT(0)\n\n\nstruct bd718xx_clk {\n\tstruct clk_hw hw;\n\tu8 reg;\n\tu8 mask;\n\tstruct platform_device *pdev;\n\tstruct regmap *regmap;\n};\n\nstatic int bd71837_clk_set(struct bd718xx_clk *c, unsigned int status)\n{\n\treturn regmap_update_bits(c->regmap, c->reg, c->mask, status);\n}\n\nstatic void bd71837_clk_disable(struct clk_hw *hw)\n{\n\tint rv;\n\tstruct bd718xx_clk *c = container_of(hw, struct bd718xx_clk, hw);\n\n\trv = bd71837_clk_set(c, 0);\n\tif (rv)\n\t\tdev_dbg(&c->pdev->dev, \"Failed to disable 32K clk (%d)\\n\", rv);\n}\n\nstatic int bd71837_clk_enable(struct clk_hw *hw)\n{\n\tstruct bd718xx_clk *c = container_of(hw, struct bd718xx_clk, hw);\n\n\treturn bd71837_clk_set(c, 0xffffffff);\n}\n\nstatic int bd71837_clk_is_enabled(struct clk_hw *hw)\n{\n\tint enabled;\n\tint rval;\n\tstruct bd718xx_clk *c = container_of(hw, struct bd718xx_clk, hw);\n\n\trval = regmap_read(c->regmap, c->reg, &enabled);\n\n\tif (rval)\n\t\treturn rval;\n\n\treturn enabled & c->mask;\n}\n\nstatic const struct clk_ops bd71837_clk_ops = {\n\t.prepare = &bd71837_clk_enable,\n\t.unprepare = &bd71837_clk_disable,\n\t.is_prepared = &bd71837_clk_is_enabled,\n};\n\nstatic int bd71837_clk_probe(struct platform_device *pdev)\n{\n\tstruct bd718xx_clk *c;\n\tint rval = -ENOMEM;\n\tconst char *parent_clk;\n\tstruct device *parent = pdev->dev.parent;\n\tstruct clk_init_data init = {\n\t\t.name = \"bd718xx-32k-out\",\n\t\t.ops = &bd71837_clk_ops,\n\t};\n\tenum rohm_chip_type chip = platform_get_device_id(pdev)->driver_data;\n\n\tc = devm_kzalloc(&pdev->dev, sizeof(*c), GFP_KERNEL);\n\tif (!c)\n\t\treturn -ENOMEM;\n\n\tc->regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!c->regmap)\n\t\treturn -ENODEV;\n\n\tinit.num_parents = 1;\n\tparent_clk = of_clk_get_parent_name(parent->of_node, 0);\n\n\tinit.parent_names = &parent_clk;\n\tif (!parent_clk) {\n\t\tdev_err(&pdev->dev, \"No parent clk found\\n\");\n\t\treturn -EINVAL;\n\t}\n\tswitch (chip) {\n\tcase ROHM_CHIP_TYPE_BD71837:\n\tcase ROHM_CHIP_TYPE_BD71847:\n\t\tc->reg = BD718XX_REG_OUT32K;\n\t\tc->mask = CLK_OUT_EN_MASK;\n\t\tbreak;\n\tcase ROHM_CHIP_TYPE_BD71828:\n\t\tc->reg = BD71828_REG_OUT32K;\n\t\tc->mask = CLK_OUT_EN_MASK;\n\t\tbreak;\n\tcase ROHM_CHIP_TYPE_BD71815:\n\t\tc->reg = BD71815_REG_OUT32K;\n\t\tc->mask = CLK_OUT_EN_MASK;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&pdev->dev, \"Unknown clk chip\\n\");\n\t\treturn -EINVAL;\n\t}\n\tc->pdev = pdev;\n\tc->hw.init = &init;\n\n\tof_property_read_string_index(parent->of_node,\n\t\t\t\t      \"clock-output-names\", 0, &init.name);\n\n\trval = devm_clk_hw_register(&pdev->dev, &c->hw);\n\tif (rval) {\n\t\tdev_err(&pdev->dev, \"failed to register 32K clk\");\n\t\treturn rval;\n\t}\n\trval = devm_of_clk_add_hw_provider(&pdev->dev, of_clk_hw_simple_get,\n\t\t\t\t\t   &c->hw);\n\tif (rval)\n\t\tdev_err(&pdev->dev, \"adding clk provider failed\\n\");\n\n\treturn rval;\n}\n\nstatic const struct platform_device_id bd718x7_clk_id[] = {\n\t{ \"bd71837-clk\", ROHM_CHIP_TYPE_BD71837 },\n\t{ \"bd71847-clk\", ROHM_CHIP_TYPE_BD71847 },\n\t{ \"bd71828-clk\", ROHM_CHIP_TYPE_BD71828 },\n\t{ \"bd71815-clk\", ROHM_CHIP_TYPE_BD71815 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(platform, bd718x7_clk_id);\n\nstatic struct platform_driver bd71837_clk = {\n\t.driver = {\n\t\t.name = \"bd718xx-clk\",\n\t},\n\t.probe = bd71837_clk_probe,\n\t.id_table = bd718x7_clk_id,\n};\n\nmodule_platform_driver(bd71837_clk);\n\nMODULE_AUTHOR(\"Matti Vaittinen <matti.vaittinen@fi.rohmeurope.com>\");\nMODULE_DESCRIPTION(\"BD718(15/18/28/37/47/50) and chip clk driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:bd718xx-clk\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}