{
  "module_name": "ccu_div.c",
  "hash_id": "2f35e205c77afa84af1d07adc1dd2fe1f4ac04bdf3bf6b0cdaac3b9d0541218b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/sunxi-ng/ccu_div.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n\n#include \"ccu_gate.h\"\n#include \"ccu_div.h\"\n\nstatic unsigned long ccu_div_round_rate(struct ccu_mux_internal *mux,\n\t\t\t\t\tstruct clk_hw *parent,\n\t\t\t\t\tunsigned long *parent_rate,\n\t\t\t\t\tunsigned long rate,\n\t\t\t\t\tvoid *data)\n{\n\tstruct ccu_div *cd = data;\n\n\tif (cd->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate *= cd->fixed_post_div;\n\n\trate = divider_round_rate_parent(&cd->common.hw, parent,\n\t\t\t\t\t rate, parent_rate,\n\t\t\t\t\t cd->div.table, cd->div.width,\n\t\t\t\t\t cd->div.flags);\n\n\tif (cd->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate /= cd->fixed_post_div;\n\n\treturn rate;\n}\n\nstatic void ccu_div_disable(struct clk_hw *hw)\n{\n\tstruct ccu_div *cd = hw_to_ccu_div(hw);\n\n\treturn ccu_gate_helper_disable(&cd->common, cd->enable);\n}\n\nstatic int ccu_div_enable(struct clk_hw *hw)\n{\n\tstruct ccu_div *cd = hw_to_ccu_div(hw);\n\n\treturn ccu_gate_helper_enable(&cd->common, cd->enable);\n}\n\nstatic int ccu_div_is_enabled(struct clk_hw *hw)\n{\n\tstruct ccu_div *cd = hw_to_ccu_div(hw);\n\n\treturn ccu_gate_helper_is_enabled(&cd->common, cd->enable);\n}\n\nstatic unsigned long ccu_div_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\tunsigned long parent_rate)\n{\n\tstruct ccu_div *cd = hw_to_ccu_div(hw);\n\tunsigned long val;\n\tu32 reg;\n\n\treg = readl(cd->common.base + cd->common.reg);\n\tval = reg >> cd->div.shift;\n\tval &= (1 << cd->div.width) - 1;\n\n\tparent_rate = ccu_mux_helper_apply_prediv(&cd->common, &cd->mux, -1,\n\t\t\t\t\t\t  parent_rate);\n\n\tval = divider_recalc_rate(hw, parent_rate, val, cd->div.table,\n\t\t\t\t  cd->div.flags, cd->div.width);\n\n\tif (cd->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\tval /= cd->fixed_post_div;\n\n\treturn val;\n}\n\nstatic int ccu_div_determine_rate(struct clk_hw *hw,\n\t\t\t\tstruct clk_rate_request *req)\n{\n\tstruct ccu_div *cd = hw_to_ccu_div(hw);\n\n\treturn ccu_mux_helper_determine_rate(&cd->common, &cd->mux,\n\t\t\t\t\t     req, ccu_div_round_rate, cd);\n}\n\nstatic int ccu_div_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t   unsigned long parent_rate)\n{\n\tstruct ccu_div *cd = hw_to_ccu_div(hw);\n\tunsigned long flags;\n\tunsigned long val;\n\tu32 reg;\n\n\tparent_rate = ccu_mux_helper_apply_prediv(&cd->common, &cd->mux, -1,\n\t\t\t\t\t\t  parent_rate);\n\n\tif (cd->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate *= cd->fixed_post_div;\n\n\tval = divider_get_val(rate, parent_rate, cd->div.table, cd->div.width,\n\t\t\t      cd->div.flags);\n\n\tspin_lock_irqsave(cd->common.lock, flags);\n\n\treg = readl(cd->common.base + cd->common.reg);\n\treg &= ~GENMASK(cd->div.width + cd->div.shift - 1, cd->div.shift);\n\n\twritel(reg | (val << cd->div.shift),\n\t       cd->common.base + cd->common.reg);\n\n\tspin_unlock_irqrestore(cd->common.lock, flags);\n\n\treturn 0;\n}\n\nstatic u8 ccu_div_get_parent(struct clk_hw *hw)\n{\n\tstruct ccu_div *cd = hw_to_ccu_div(hw);\n\n\treturn ccu_mux_helper_get_parent(&cd->common, &cd->mux);\n}\n\nstatic int ccu_div_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct ccu_div *cd = hw_to_ccu_div(hw);\n\n\treturn ccu_mux_helper_set_parent(&cd->common, &cd->mux, index);\n}\n\nconst struct clk_ops ccu_div_ops = {\n\t.disable\t= ccu_div_disable,\n\t.enable\t\t= ccu_div_enable,\n\t.is_enabled\t= ccu_div_is_enabled,\n\n\t.get_parent\t= ccu_div_get_parent,\n\t.set_parent\t= ccu_div_set_parent,\n\n\t.determine_rate\t= ccu_div_determine_rate,\n\t.recalc_rate\t= ccu_div_recalc_rate,\n\t.set_rate\t= ccu_div_set_rate,\n};\nEXPORT_SYMBOL_NS_GPL(ccu_div_ops, SUNXI_CCU);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}