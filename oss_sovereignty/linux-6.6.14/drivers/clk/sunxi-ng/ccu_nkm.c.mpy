{
  "module_name": "ccu_nkm.c",
  "hash_id": "0a89274434dc2dd8e20375c4fb6ae1e36b763a2c02a345930fcb0bbbc28ceed4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/sunxi-ng/ccu_nkm.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n\n#include \"ccu_gate.h\"\n#include \"ccu_nkm.h\"\n\nstruct _ccu_nkm {\n\tunsigned long\tn, min_n, max_n;\n\tunsigned long\tk, min_k, max_k;\n\tunsigned long\tm, min_m, max_m;\n};\n\nstatic unsigned long ccu_nkm_find_best_with_parent_adj(struct ccu_common *common,\n\t\t\t\t\t\t       struct clk_hw *parent_hw,\n\t\t\t\t\t\t       unsigned long *parent, unsigned long rate,\n\t\t\t\t\t\t       struct _ccu_nkm *nkm)\n{\n\tunsigned long best_rate = 0, best_parent_rate = *parent, tmp_parent = *parent;\n\tunsigned long best_n = 0, best_k = 0, best_m = 0;\n\tunsigned long _n, _k, _m;\n\n\tfor (_k = nkm->min_k; _k <= nkm->max_k; _k++) {\n\t\tfor (_n = nkm->min_n; _n <= nkm->max_n; _n++) {\n\t\t\tfor (_m = nkm->min_m; _m <= nkm->max_m; _m++) {\n\t\t\t\tunsigned long tmp_rate;\n\n\t\t\t\ttmp_parent = clk_hw_round_rate(parent_hw, rate * _m / (_n * _k));\n\n\t\t\t\ttmp_rate = tmp_parent * _n * _k / _m;\n\n\t\t\t\tif (ccu_is_better_rate(common, rate, tmp_rate, best_rate) ||\n\t\t\t\t    (tmp_parent == *parent && tmp_rate == best_rate)) {\n\t\t\t\t\tbest_rate = tmp_rate;\n\t\t\t\t\tbest_parent_rate = tmp_parent;\n\t\t\t\t\tbest_n = _n;\n\t\t\t\t\tbest_k = _k;\n\t\t\t\t\tbest_m = _m;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tnkm->n = best_n;\n\tnkm->k = best_k;\n\tnkm->m = best_m;\n\n\t*parent = best_parent_rate;\n\n\treturn best_rate;\n}\n\nstatic unsigned long ccu_nkm_find_best(unsigned long parent, unsigned long rate,\n\t\t\t\t       struct _ccu_nkm *nkm, struct ccu_common *common)\n{\n\tunsigned long best_rate = 0;\n\tunsigned long best_n = 0, best_k = 0, best_m = 0;\n\tunsigned long _n, _k, _m;\n\n\tfor (_k = nkm->min_k; _k <= nkm->max_k; _k++) {\n\t\tfor (_n = nkm->min_n; _n <= nkm->max_n; _n++) {\n\t\t\tfor (_m = nkm->min_m; _m <= nkm->max_m; _m++) {\n\t\t\t\tunsigned long tmp_rate;\n\n\t\t\t\ttmp_rate = parent * _n * _k / _m;\n\n\t\t\t\tif (ccu_is_better_rate(common, rate, tmp_rate, best_rate)) {\n\t\t\t\t\tbest_rate = tmp_rate;\n\t\t\t\t\tbest_n = _n;\n\t\t\t\t\tbest_k = _k;\n\t\t\t\t\tbest_m = _m;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tnkm->n = best_n;\n\tnkm->k = best_k;\n\tnkm->m = best_m;\n\n\treturn best_rate;\n}\n\nstatic void ccu_nkm_disable(struct clk_hw *hw)\n{\n\tstruct ccu_nkm *nkm = hw_to_ccu_nkm(hw);\n\n\treturn ccu_gate_helper_disable(&nkm->common, nkm->enable);\n}\n\nstatic int ccu_nkm_enable(struct clk_hw *hw)\n{\n\tstruct ccu_nkm *nkm = hw_to_ccu_nkm(hw);\n\n\treturn ccu_gate_helper_enable(&nkm->common, nkm->enable);\n}\n\nstatic int ccu_nkm_is_enabled(struct clk_hw *hw)\n{\n\tstruct ccu_nkm *nkm = hw_to_ccu_nkm(hw);\n\n\treturn ccu_gate_helper_is_enabled(&nkm->common, nkm->enable);\n}\n\nstatic unsigned long ccu_nkm_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\tunsigned long parent_rate)\n{\n\tstruct ccu_nkm *nkm = hw_to_ccu_nkm(hw);\n\tunsigned long n, m, k, rate;\n\tu32 reg;\n\n\treg = readl(nkm->common.base + nkm->common.reg);\n\n\tn = reg >> nkm->n.shift;\n\tn &= (1 << nkm->n.width) - 1;\n\tn += nkm->n.offset;\n\tif (!n)\n\t\tn++;\n\n\tk = reg >> nkm->k.shift;\n\tk &= (1 << nkm->k.width) - 1;\n\tk += nkm->k.offset;\n\tif (!k)\n\t\tk++;\n\n\tm = reg >> nkm->m.shift;\n\tm &= (1 << nkm->m.width) - 1;\n\tm += nkm->m.offset;\n\tif (!m)\n\t\tm++;\n\n\trate = parent_rate * n  * k / m;\n\n\tif (nkm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate /= nkm->fixed_post_div;\n\n\treturn rate;\n}\n\nstatic unsigned long ccu_nkm_round_rate(struct ccu_mux_internal *mux,\n\t\t\t\t\tstruct clk_hw *parent_hw,\n\t\t\t\t\tunsigned long *parent_rate,\n\t\t\t\t\tunsigned long rate,\n\t\t\t\t\tvoid *data)\n{\n\tstruct ccu_nkm *nkm = data;\n\tstruct _ccu_nkm _nkm;\n\n\t_nkm.min_n = nkm->n.min ?: 1;\n\t_nkm.max_n = nkm->n.max ?: 1 << nkm->n.width;\n\t_nkm.min_k = nkm->k.min ?: 1;\n\t_nkm.max_k = nkm->k.max ?: 1 << nkm->k.width;\n\t_nkm.min_m = 1;\n\t_nkm.max_m = nkm->m.max ?: 1 << nkm->m.width;\n\n\tif (nkm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate *= nkm->fixed_post_div;\n\n\tif (!clk_hw_can_set_rate_parent(&nkm->common.hw))\n\t\trate = ccu_nkm_find_best(*parent_rate, rate, &_nkm, &nkm->common);\n\telse\n\t\trate = ccu_nkm_find_best_with_parent_adj(&nkm->common, parent_hw, parent_rate, rate,\n\t\t\t\t\t\t\t &_nkm);\n\n\tif (nkm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate /= nkm->fixed_post_div;\n\n\treturn rate;\n}\n\nstatic int ccu_nkm_determine_rate(struct clk_hw *hw,\n\t\t\t\t  struct clk_rate_request *req)\n{\n\tstruct ccu_nkm *nkm = hw_to_ccu_nkm(hw);\n\n\treturn ccu_mux_helper_determine_rate(&nkm->common, &nkm->mux,\n\t\t\t\t\t     req, ccu_nkm_round_rate, nkm);\n}\n\nstatic int ccu_nkm_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t   unsigned long parent_rate)\n{\n\tstruct ccu_nkm *nkm = hw_to_ccu_nkm(hw);\n\tstruct _ccu_nkm _nkm;\n\tunsigned long flags;\n\tu32 reg;\n\n\tif (nkm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate *= nkm->fixed_post_div;\n\n\t_nkm.min_n = nkm->n.min ?: 1;\n\t_nkm.max_n = nkm->n.max ?: 1 << nkm->n.width;\n\t_nkm.min_k = nkm->k.min ?: 1;\n\t_nkm.max_k = nkm->k.max ?: 1 << nkm->k.width;\n\t_nkm.min_m = 1;\n\t_nkm.max_m = nkm->m.max ?: 1 << nkm->m.width;\n\n\tccu_nkm_find_best(parent_rate, rate, &_nkm, &nkm->common);\n\n\tspin_lock_irqsave(nkm->common.lock, flags);\n\n\treg = readl(nkm->common.base + nkm->common.reg);\n\treg &= ~GENMASK(nkm->n.width + nkm->n.shift - 1, nkm->n.shift);\n\treg &= ~GENMASK(nkm->k.width + nkm->k.shift - 1, nkm->k.shift);\n\treg &= ~GENMASK(nkm->m.width + nkm->m.shift - 1, nkm->m.shift);\n\n\treg |= (_nkm.n - nkm->n.offset) << nkm->n.shift;\n\treg |= (_nkm.k - nkm->k.offset) << nkm->k.shift;\n\treg |= (_nkm.m - nkm->m.offset) << nkm->m.shift;\n\twritel(reg, nkm->common.base + nkm->common.reg);\n\n\tspin_unlock_irqrestore(nkm->common.lock, flags);\n\n\tccu_helper_wait_for_lock(&nkm->common, nkm->lock);\n\n\treturn 0;\n}\n\nstatic u8 ccu_nkm_get_parent(struct clk_hw *hw)\n{\n\tstruct ccu_nkm *nkm = hw_to_ccu_nkm(hw);\n\n\treturn ccu_mux_helper_get_parent(&nkm->common, &nkm->mux);\n}\n\nstatic int ccu_nkm_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct ccu_nkm *nkm = hw_to_ccu_nkm(hw);\n\n\treturn ccu_mux_helper_set_parent(&nkm->common, &nkm->mux, index);\n}\n\nconst struct clk_ops ccu_nkm_ops = {\n\t.disable\t= ccu_nkm_disable,\n\t.enable\t\t= ccu_nkm_enable,\n\t.is_enabled\t= ccu_nkm_is_enabled,\n\n\t.get_parent\t= ccu_nkm_get_parent,\n\t.set_parent\t= ccu_nkm_set_parent,\n\n\t.determine_rate\t= ccu_nkm_determine_rate,\n\t.recalc_rate\t= ccu_nkm_recalc_rate,\n\t.set_rate\t= ccu_nkm_set_rate,\n};\nEXPORT_SYMBOL_NS_GPL(ccu_nkm_ops, SUNXI_CCU);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}