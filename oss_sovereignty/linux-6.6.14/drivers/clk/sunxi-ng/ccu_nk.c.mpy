{
  "module_name": "ccu_nk.c",
  "hash_id": "6af4c73cc2194cbea02992418fa061fb66a7b4a55bb5af78d3babe2381a49c4f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/sunxi-ng/ccu_nk.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n\n#include \"ccu_gate.h\"\n#include \"ccu_nk.h\"\n\nstruct _ccu_nk {\n\tunsigned long\tn, min_n, max_n;\n\tunsigned long\tk, min_k, max_k;\n};\n\nstatic unsigned long ccu_nk_find_best(unsigned long parent, unsigned long rate,\n\t\t\t\t      struct _ccu_nk *nk)\n{\n\tunsigned long best_rate = 0;\n\tunsigned int best_k = 0, best_n = 0;\n\tunsigned int _k, _n;\n\n\tfor (_k = nk->min_k; _k <= nk->max_k; _k++) {\n\t\tfor (_n = nk->min_n; _n <= nk->max_n; _n++) {\n\t\t\tunsigned long tmp_rate = parent * _n * _k;\n\n\t\t\tif (tmp_rate > rate)\n\t\t\t\tcontinue;\n\n\t\t\tif ((rate - tmp_rate) < (rate - best_rate)) {\n\t\t\t\tbest_rate = tmp_rate;\n\t\t\t\tbest_k = _k;\n\t\t\t\tbest_n = _n;\n\t\t\t}\n\t\t}\n\t}\n\n\tnk->k = best_k;\n\tnk->n = best_n;\n\n\treturn best_rate;\n}\n\nstatic void ccu_nk_disable(struct clk_hw *hw)\n{\n\tstruct ccu_nk *nk = hw_to_ccu_nk(hw);\n\n\treturn ccu_gate_helper_disable(&nk->common, nk->enable);\n}\n\nstatic int ccu_nk_enable(struct clk_hw *hw)\n{\n\tstruct ccu_nk *nk = hw_to_ccu_nk(hw);\n\n\treturn ccu_gate_helper_enable(&nk->common, nk->enable);\n}\n\nstatic int ccu_nk_is_enabled(struct clk_hw *hw)\n{\n\tstruct ccu_nk *nk = hw_to_ccu_nk(hw);\n\n\treturn ccu_gate_helper_is_enabled(&nk->common, nk->enable);\n}\n\nstatic unsigned long ccu_nk_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\tunsigned long parent_rate)\n{\n\tstruct ccu_nk *nk = hw_to_ccu_nk(hw);\n\tunsigned long rate, n, k;\n\tu32 reg;\n\n\treg = readl(nk->common.base + nk->common.reg);\n\n\tn = reg >> nk->n.shift;\n\tn &= (1 << nk->n.width) - 1;\n\tn += nk->n.offset;\n\tif (!n)\n\t\tn++;\n\n\tk = reg >> nk->k.shift;\n\tk &= (1 << nk->k.width) - 1;\n\tk += nk->k.offset;\n\tif (!k)\n\t\tk++;\n\n\trate = parent_rate * n * k;\n\tif (nk->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate /= nk->fixed_post_div;\n\n\treturn rate;\n}\n\nstatic long ccu_nk_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t      unsigned long *parent_rate)\n{\n\tstruct ccu_nk *nk = hw_to_ccu_nk(hw);\n\tstruct _ccu_nk _nk;\n\n\tif (nk->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate *= nk->fixed_post_div;\n\n\t_nk.min_n = nk->n.min ?: 1;\n\t_nk.max_n = nk->n.max ?: 1 << nk->n.width;\n\t_nk.min_k = nk->k.min ?: 1;\n\t_nk.max_k = nk->k.max ?: 1 << nk->k.width;\n\n\trate = ccu_nk_find_best(*parent_rate, rate, &_nk);\n\n\tif (nk->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate = rate / nk->fixed_post_div;\n\n\treturn rate;\n}\n\nstatic int ccu_nk_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t   unsigned long parent_rate)\n{\n\tstruct ccu_nk *nk = hw_to_ccu_nk(hw);\n\tunsigned long flags;\n\tstruct _ccu_nk _nk;\n\tu32 reg;\n\n\tif (nk->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate = rate * nk->fixed_post_div;\n\n\t_nk.min_n = nk->n.min ?: 1;\n\t_nk.max_n = nk->n.max ?: 1 << nk->n.width;\n\t_nk.min_k = nk->k.min ?: 1;\n\t_nk.max_k = nk->k.max ?: 1 << nk->k.width;\n\n\tccu_nk_find_best(parent_rate, rate, &_nk);\n\n\tspin_lock_irqsave(nk->common.lock, flags);\n\n\treg = readl(nk->common.base + nk->common.reg);\n\treg &= ~GENMASK(nk->n.width + nk->n.shift - 1, nk->n.shift);\n\treg &= ~GENMASK(nk->k.width + nk->k.shift - 1, nk->k.shift);\n\n\treg |= (_nk.k - nk->k.offset) << nk->k.shift;\n\treg |= (_nk.n - nk->n.offset) << nk->n.shift;\n\twritel(reg, nk->common.base + nk->common.reg);\n\n\tspin_unlock_irqrestore(nk->common.lock, flags);\n\n\tccu_helper_wait_for_lock(&nk->common, nk->lock);\n\n\treturn 0;\n}\n\nconst struct clk_ops ccu_nk_ops = {\n\t.disable\t= ccu_nk_disable,\n\t.enable\t\t= ccu_nk_enable,\n\t.is_enabled\t= ccu_nk_is_enabled,\n\n\t.recalc_rate\t= ccu_nk_recalc_rate,\n\t.round_rate\t= ccu_nk_round_rate,\n\t.set_rate\t= ccu_nk_set_rate,\n};\nEXPORT_SYMBOL_NS_GPL(ccu_nk_ops, SUNXI_CCU);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}