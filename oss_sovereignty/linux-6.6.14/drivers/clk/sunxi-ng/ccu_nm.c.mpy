{
  "module_name": "ccu_nm.c",
  "hash_id": "2f6b85e6476b8ce40dbafa193dcfc6fd7ee8b0f498657afaf78e5304b571e1fb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/sunxi-ng/ccu_nm.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n\n#include \"ccu_frac.h\"\n#include \"ccu_gate.h\"\n#include \"ccu_nm.h\"\n\nstruct _ccu_nm {\n\tunsigned long\tn, min_n, max_n;\n\tunsigned long\tm, min_m, max_m;\n};\n\nstatic unsigned long ccu_nm_calc_rate(unsigned long parent,\n\t\t\t\t      unsigned long n, unsigned long m)\n{\n\tu64 rate = parent;\n\n\trate *= n;\n\tdo_div(rate, m);\n\n\treturn rate;\n}\n\nstatic unsigned long ccu_nm_find_best(struct ccu_common *common, unsigned long parent,\n\t\t\t\t      unsigned long rate, struct _ccu_nm *nm)\n{\n\tunsigned long best_rate = 0;\n\tunsigned long best_n = 0, best_m = 0;\n\tunsigned long _n, _m;\n\n\tfor (_n = nm->min_n; _n <= nm->max_n; _n++) {\n\t\tfor (_m = nm->min_m; _m <= nm->max_m; _m++) {\n\t\t\tunsigned long tmp_rate = ccu_nm_calc_rate(parent,\n\t\t\t\t\t\t\t\t  _n, _m);\n\n\t\t\tif (ccu_is_better_rate(common, rate, tmp_rate, best_rate)) {\n\t\t\t\tbest_rate = tmp_rate;\n\t\t\t\tbest_n = _n;\n\t\t\t\tbest_m = _m;\n\t\t\t}\n\t\t}\n\t}\n\n\tnm->n = best_n;\n\tnm->m = best_m;\n\n\treturn best_rate;\n}\n\nstatic void ccu_nm_disable(struct clk_hw *hw)\n{\n\tstruct ccu_nm *nm = hw_to_ccu_nm(hw);\n\n\treturn ccu_gate_helper_disable(&nm->common, nm->enable);\n}\n\nstatic int ccu_nm_enable(struct clk_hw *hw)\n{\n\tstruct ccu_nm *nm = hw_to_ccu_nm(hw);\n\n\treturn ccu_gate_helper_enable(&nm->common, nm->enable);\n}\n\nstatic int ccu_nm_is_enabled(struct clk_hw *hw)\n{\n\tstruct ccu_nm *nm = hw_to_ccu_nm(hw);\n\n\treturn ccu_gate_helper_is_enabled(&nm->common, nm->enable);\n}\n\nstatic unsigned long ccu_nm_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\tunsigned long parent_rate)\n{\n\tstruct ccu_nm *nm = hw_to_ccu_nm(hw);\n\tunsigned long rate;\n\tunsigned long n, m;\n\tu32 reg;\n\n\tif (ccu_frac_helper_is_enabled(&nm->common, &nm->frac)) {\n\t\trate = ccu_frac_helper_read_rate(&nm->common, &nm->frac);\n\n\t\tif (nm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\t\trate /= nm->fixed_post_div;\n\n\t\treturn rate;\n\t}\n\n\treg = readl(nm->common.base + nm->common.reg);\n\n\tn = reg >> nm->n.shift;\n\tn &= (1 << nm->n.width) - 1;\n\tn += nm->n.offset;\n\tif (!n)\n\t\tn++;\n\n\tm = reg >> nm->m.shift;\n\tm &= (1 << nm->m.width) - 1;\n\tm += nm->m.offset;\n\tif (!m)\n\t\tm++;\n\n\tif (ccu_sdm_helper_is_enabled(&nm->common, &nm->sdm))\n\t\trate = ccu_sdm_helper_read_rate(&nm->common, &nm->sdm, m, n);\n\telse\n\t\trate = ccu_nm_calc_rate(parent_rate, n, m);\n\n\tif (nm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate /= nm->fixed_post_div;\n\n\treturn rate;\n}\n\nstatic long ccu_nm_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t      unsigned long *parent_rate)\n{\n\tstruct ccu_nm *nm = hw_to_ccu_nm(hw);\n\tstruct _ccu_nm _nm;\n\n\tif (nm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate *= nm->fixed_post_div;\n\n\tif (rate < nm->min_rate) {\n\t\trate = nm->min_rate;\n\t\tif (nm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\t\trate /= nm->fixed_post_div;\n\t\treturn rate;\n\t}\n\n\tif (nm->max_rate && rate > nm->max_rate) {\n\t\trate = nm->max_rate;\n\t\tif (nm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\t\trate /= nm->fixed_post_div;\n\t\treturn rate;\n\t}\n\n\tif (ccu_frac_helper_has_rate(&nm->common, &nm->frac, rate)) {\n\t\tif (nm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\t\trate /= nm->fixed_post_div;\n\t\treturn rate;\n\t}\n\n\tif (ccu_sdm_helper_has_rate(&nm->common, &nm->sdm, rate)) {\n\t\tif (nm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\t\trate /= nm->fixed_post_div;\n\t\treturn rate;\n\t}\n\n\t_nm.min_n = nm->n.min ?: 1;\n\t_nm.max_n = nm->n.max ?: 1 << nm->n.width;\n\t_nm.min_m = 1;\n\t_nm.max_m = nm->m.max ?: 1 << nm->m.width;\n\n\trate = ccu_nm_find_best(&nm->common, *parent_rate, rate, &_nm);\n\n\tif (nm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate /= nm->fixed_post_div;\n\n\treturn rate;\n}\n\nstatic int ccu_nm_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t   unsigned long parent_rate)\n{\n\tstruct ccu_nm *nm = hw_to_ccu_nm(hw);\n\tstruct _ccu_nm _nm;\n\tunsigned long flags;\n\tu32 reg;\n\n\t \n\tif (nm->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate = rate * nm->fixed_post_div;\n\n\tif (ccu_frac_helper_has_rate(&nm->common, &nm->frac, rate)) {\n\t\tspin_lock_irqsave(nm->common.lock, flags);\n\n\t\t \n\t\treg = readl(nm->common.base + nm->common.reg);\n\t\treg &= ~GENMASK(nm->m.width + nm->m.shift - 1, nm->m.shift);\n\t\twritel(reg, nm->common.base + nm->common.reg);\n\n\t\tspin_unlock_irqrestore(nm->common.lock, flags);\n\n\t\tccu_frac_helper_enable(&nm->common, &nm->frac);\n\n\t\treturn ccu_frac_helper_set_rate(&nm->common, &nm->frac,\n\t\t\t\t\t\trate, nm->lock);\n\t} else {\n\t\tccu_frac_helper_disable(&nm->common, &nm->frac);\n\t}\n\n\t_nm.min_n = nm->n.min ?: 1;\n\t_nm.max_n = nm->n.max ?: 1 << nm->n.width;\n\t_nm.min_m = 1;\n\t_nm.max_m = nm->m.max ?: 1 << nm->m.width;\n\n\tif (ccu_sdm_helper_has_rate(&nm->common, &nm->sdm, rate)) {\n\t\tccu_sdm_helper_enable(&nm->common, &nm->sdm, rate);\n\n\t\t \n\t\tccu_sdm_helper_get_factors(&nm->common, &nm->sdm, rate,\n\t\t\t\t\t   &_nm.m, &_nm.n);\n\t} else {\n\t\tccu_sdm_helper_disable(&nm->common, &nm->sdm);\n\t\tccu_nm_find_best(&nm->common, parent_rate, rate, &_nm);\n\t}\n\n\tspin_lock_irqsave(nm->common.lock, flags);\n\n\treg = readl(nm->common.base + nm->common.reg);\n\treg &= ~GENMASK(nm->n.width + nm->n.shift - 1, nm->n.shift);\n\treg &= ~GENMASK(nm->m.width + nm->m.shift - 1, nm->m.shift);\n\n\treg |= (_nm.n - nm->n.offset) << nm->n.shift;\n\treg |= (_nm.m - nm->m.offset) << nm->m.shift;\n\twritel(reg, nm->common.base + nm->common.reg);\n\n\tspin_unlock_irqrestore(nm->common.lock, flags);\n\n\tccu_helper_wait_for_lock(&nm->common, nm->lock);\n\n\treturn 0;\n}\n\nconst struct clk_ops ccu_nm_ops = {\n\t.disable\t= ccu_nm_disable,\n\t.enable\t\t= ccu_nm_enable,\n\t.is_enabled\t= ccu_nm_is_enabled,\n\n\t.recalc_rate\t= ccu_nm_recalc_rate,\n\t.round_rate\t= ccu_nm_round_rate,\n\t.set_rate\t= ccu_nm_set_rate,\n};\nEXPORT_SYMBOL_NS_GPL(ccu_nm_ops, SUNXI_CCU);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}