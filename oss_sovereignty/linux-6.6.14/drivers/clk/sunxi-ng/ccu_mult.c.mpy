{
  "module_name": "ccu_mult.c",
  "hash_id": "5bfc8e5179dbb644943f2c28541aa175b515d2c5be57ece1b2da030e2d56f9c8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/sunxi-ng/ccu_mult.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n\n#include \"ccu_gate.h\"\n#include \"ccu_mult.h\"\n\nstruct _ccu_mult {\n\tunsigned long\tmult, min, max;\n};\n\nstatic void ccu_mult_find_best(unsigned long parent, unsigned long rate,\n\t\t\t       struct _ccu_mult *mult)\n{\n\tint _mult;\n\n\t_mult = rate / parent;\n\tif (_mult < mult->min)\n\t\t_mult = mult->min;\n\n\tif (_mult > mult->max)\n\t\t_mult = mult->max;\n\n\tmult->mult = _mult;\n}\n\nstatic unsigned long ccu_mult_round_rate(struct ccu_mux_internal *mux,\n\t\t\t\t\t struct clk_hw *parent,\n\t\t\t\t\t unsigned long *parent_rate,\n\t\t\t\t\t unsigned long rate,\n\t\t\t\t\t void *data)\n{\n\tstruct ccu_mult *cm = data;\n\tstruct _ccu_mult _cm;\n\n\t_cm.min = cm->mult.min;\n\n\tif (cm->mult.max)\n\t\t_cm.max = cm->mult.max;\n\telse\n\t\t_cm.max = (1 << cm->mult.width) + cm->mult.offset - 1;\n\n\tccu_mult_find_best(*parent_rate, rate, &_cm);\n\n\treturn *parent_rate * _cm.mult;\n}\n\nstatic void ccu_mult_disable(struct clk_hw *hw)\n{\n\tstruct ccu_mult *cm = hw_to_ccu_mult(hw);\n\n\treturn ccu_gate_helper_disable(&cm->common, cm->enable);\n}\n\nstatic int ccu_mult_enable(struct clk_hw *hw)\n{\n\tstruct ccu_mult *cm = hw_to_ccu_mult(hw);\n\n\treturn ccu_gate_helper_enable(&cm->common, cm->enable);\n}\n\nstatic int ccu_mult_is_enabled(struct clk_hw *hw)\n{\n\tstruct ccu_mult *cm = hw_to_ccu_mult(hw);\n\n\treturn ccu_gate_helper_is_enabled(&cm->common, cm->enable);\n}\n\nstatic unsigned long ccu_mult_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\tunsigned long parent_rate)\n{\n\tstruct ccu_mult *cm = hw_to_ccu_mult(hw);\n\tunsigned long val;\n\tu32 reg;\n\n\tif (ccu_frac_helper_is_enabled(&cm->common, &cm->frac))\n\t\treturn ccu_frac_helper_read_rate(&cm->common, &cm->frac);\n\n\treg = readl(cm->common.base + cm->common.reg);\n\tval = reg >> cm->mult.shift;\n\tval &= (1 << cm->mult.width) - 1;\n\n\tparent_rate = ccu_mux_helper_apply_prediv(&cm->common, &cm->mux, -1,\n\t\t\t\t\t\t  parent_rate);\n\n\treturn parent_rate * (val + cm->mult.offset);\n}\n\nstatic int ccu_mult_determine_rate(struct clk_hw *hw,\n\t\t\t\tstruct clk_rate_request *req)\n{\n\tstruct ccu_mult *cm = hw_to_ccu_mult(hw);\n\n\treturn ccu_mux_helper_determine_rate(&cm->common, &cm->mux,\n\t\t\t\t\t     req, ccu_mult_round_rate, cm);\n}\n\nstatic int ccu_mult_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t   unsigned long parent_rate)\n{\n\tstruct ccu_mult *cm = hw_to_ccu_mult(hw);\n\tstruct _ccu_mult _cm;\n\tunsigned long flags;\n\tu32 reg;\n\n\tif (ccu_frac_helper_has_rate(&cm->common, &cm->frac, rate)) {\n\t\tccu_frac_helper_enable(&cm->common, &cm->frac);\n\n\t\treturn ccu_frac_helper_set_rate(&cm->common, &cm->frac,\n\t\t\t\t\t\trate, cm->lock);\n\t} else {\n\t\tccu_frac_helper_disable(&cm->common, &cm->frac);\n\t}\n\n\tparent_rate = ccu_mux_helper_apply_prediv(&cm->common, &cm->mux, -1,\n\t\t\t\t\t\t  parent_rate);\n\n\t_cm.min = cm->mult.min;\n\n\tif (cm->mult.max)\n\t\t_cm.max = cm->mult.max;\n\telse\n\t\t_cm.max = (1 << cm->mult.width) + cm->mult.offset - 1;\n\n\tccu_mult_find_best(parent_rate, rate, &_cm);\n\n\tspin_lock_irqsave(cm->common.lock, flags);\n\n\treg = readl(cm->common.base + cm->common.reg);\n\treg &= ~GENMASK(cm->mult.width + cm->mult.shift - 1, cm->mult.shift);\n\treg |= ((_cm.mult - cm->mult.offset) << cm->mult.shift);\n\n\twritel(reg, cm->common.base + cm->common.reg);\n\n\tspin_unlock_irqrestore(cm->common.lock, flags);\n\n\tccu_helper_wait_for_lock(&cm->common, cm->lock);\n\n\treturn 0;\n}\n\nstatic u8 ccu_mult_get_parent(struct clk_hw *hw)\n{\n\tstruct ccu_mult *cm = hw_to_ccu_mult(hw);\n\n\treturn ccu_mux_helper_get_parent(&cm->common, &cm->mux);\n}\n\nstatic int ccu_mult_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct ccu_mult *cm = hw_to_ccu_mult(hw);\n\n\treturn ccu_mux_helper_set_parent(&cm->common, &cm->mux, index);\n}\n\nconst struct clk_ops ccu_mult_ops = {\n\t.disable\t= ccu_mult_disable,\n\t.enable\t\t= ccu_mult_enable,\n\t.is_enabled\t= ccu_mult_is_enabled,\n\n\t.get_parent\t= ccu_mult_get_parent,\n\t.set_parent\t= ccu_mult_set_parent,\n\n\t.determine_rate\t= ccu_mult_determine_rate,\n\t.recalc_rate\t= ccu_mult_recalc_rate,\n\t.set_rate\t= ccu_mult_set_rate,\n};\nEXPORT_SYMBOL_NS_GPL(ccu_mult_ops, SUNXI_CCU);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}