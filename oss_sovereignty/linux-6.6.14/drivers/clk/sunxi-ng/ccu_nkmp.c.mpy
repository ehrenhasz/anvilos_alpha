{
  "module_name": "ccu_nkmp.c",
  "hash_id": "e409fe47bd78fd5a08b801c40958440d5187ff1e534acb4adffb789c25dcaa4d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/sunxi-ng/ccu_nkmp.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n\n#include \"ccu_gate.h\"\n#include \"ccu_nkmp.h\"\n\nstruct _ccu_nkmp {\n\tunsigned long\tn, min_n, max_n;\n\tunsigned long\tk, min_k, max_k;\n\tunsigned long\tm, min_m, max_m;\n\tunsigned long\tp, min_p, max_p;\n};\n\nstatic unsigned long ccu_nkmp_calc_rate(unsigned long parent,\n\t\t\t\t\tunsigned long n, unsigned long k,\n\t\t\t\t\tunsigned long m, unsigned long p)\n{\n\tu64 rate = parent;\n\n\trate *= n * k;\n\tdo_div(rate, m * p);\n\n\treturn rate;\n}\n\nstatic unsigned long ccu_nkmp_find_best(unsigned long parent, unsigned long rate,\n\t\t\t\t\tstruct _ccu_nkmp *nkmp)\n{\n\tunsigned long best_rate = 0;\n\tunsigned long best_n = 0, best_k = 0, best_m = 0, best_p = 0;\n\tunsigned long _n, _k, _m, _p;\n\n\tfor (_k = nkmp->min_k; _k <= nkmp->max_k; _k++) {\n\t\tfor (_n = nkmp->min_n; _n <= nkmp->max_n; _n++) {\n\t\t\tfor (_m = nkmp->min_m; _m <= nkmp->max_m; _m++) {\n\t\t\t\tfor (_p = nkmp->min_p; _p <= nkmp->max_p; _p <<= 1) {\n\t\t\t\t\tunsigned long tmp_rate;\n\n\t\t\t\t\ttmp_rate = ccu_nkmp_calc_rate(parent,\n\t\t\t\t\t\t\t\t      _n, _k,\n\t\t\t\t\t\t\t\t      _m, _p);\n\n\t\t\t\t\tif (tmp_rate > rate)\n\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\tif ((rate - tmp_rate) < (rate - best_rate)) {\n\t\t\t\t\t\tbest_rate = tmp_rate;\n\t\t\t\t\t\tbest_n = _n;\n\t\t\t\t\t\tbest_k = _k;\n\t\t\t\t\t\tbest_m = _m;\n\t\t\t\t\t\tbest_p = _p;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tnkmp->n = best_n;\n\tnkmp->k = best_k;\n\tnkmp->m = best_m;\n\tnkmp->p = best_p;\n\n\treturn best_rate;\n}\n\nstatic void ccu_nkmp_disable(struct clk_hw *hw)\n{\n\tstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\n\n\treturn ccu_gate_helper_disable(&nkmp->common, nkmp->enable);\n}\n\nstatic int ccu_nkmp_enable(struct clk_hw *hw)\n{\n\tstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\n\n\treturn ccu_gate_helper_enable(&nkmp->common, nkmp->enable);\n}\n\nstatic int ccu_nkmp_is_enabled(struct clk_hw *hw)\n{\n\tstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\n\n\treturn ccu_gate_helper_is_enabled(&nkmp->common, nkmp->enable);\n}\n\nstatic unsigned long ccu_nkmp_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\tunsigned long parent_rate)\n{\n\tstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\n\tunsigned long n, m, k, p, rate;\n\tu32 reg;\n\n\treg = readl(nkmp->common.base + nkmp->common.reg);\n\n\tn = reg >> nkmp->n.shift;\n\tn &= (1 << nkmp->n.width) - 1;\n\tn += nkmp->n.offset;\n\tif (!n)\n\t\tn++;\n\n\tk = reg >> nkmp->k.shift;\n\tk &= (1 << nkmp->k.width) - 1;\n\tk += nkmp->k.offset;\n\tif (!k)\n\t\tk++;\n\n\tm = reg >> nkmp->m.shift;\n\tm &= (1 << nkmp->m.width) - 1;\n\tm += nkmp->m.offset;\n\tif (!m)\n\t\tm++;\n\n\tp = reg >> nkmp->p.shift;\n\tp &= (1 << nkmp->p.width) - 1;\n\n\trate = ccu_nkmp_calc_rate(parent_rate, n, k, m, 1 << p);\n\tif (nkmp->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate /= nkmp->fixed_post_div;\n\n\treturn rate;\n}\n\nstatic long ccu_nkmp_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t      unsigned long *parent_rate)\n{\n\tstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\n\tstruct _ccu_nkmp _nkmp;\n\n\tif (nkmp->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate *= nkmp->fixed_post_div;\n\n\tif (nkmp->max_rate && rate > nkmp->max_rate) {\n\t\trate = nkmp->max_rate;\n\t\tif (nkmp->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\t\trate /= nkmp->fixed_post_div;\n\t\treturn rate;\n\t}\n\n\t_nkmp.min_n = nkmp->n.min ?: 1;\n\t_nkmp.max_n = nkmp->n.max ?: 1 << nkmp->n.width;\n\t_nkmp.min_k = nkmp->k.min ?: 1;\n\t_nkmp.max_k = nkmp->k.max ?: 1 << nkmp->k.width;\n\t_nkmp.min_m = 1;\n\t_nkmp.max_m = nkmp->m.max ?: 1 << nkmp->m.width;\n\t_nkmp.min_p = 1;\n\t_nkmp.max_p = nkmp->p.max ?: 1 << ((1 << nkmp->p.width) - 1);\n\n\trate = ccu_nkmp_find_best(*parent_rate, rate, &_nkmp);\n\n\tif (nkmp->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate = rate / nkmp->fixed_post_div;\n\n\treturn rate;\n}\n\nstatic int ccu_nkmp_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t   unsigned long parent_rate)\n{\n\tstruct ccu_nkmp *nkmp = hw_to_ccu_nkmp(hw);\n\tu32 n_mask = 0, k_mask = 0, m_mask = 0, p_mask = 0;\n\tstruct _ccu_nkmp _nkmp;\n\tunsigned long flags;\n\tu32 reg;\n\n\tif (nkmp->common.features & CCU_FEATURE_FIXED_POSTDIV)\n\t\trate = rate * nkmp->fixed_post_div;\n\n\t_nkmp.min_n = nkmp->n.min ?: 1;\n\t_nkmp.max_n = nkmp->n.max ?: 1 << nkmp->n.width;\n\t_nkmp.min_k = nkmp->k.min ?: 1;\n\t_nkmp.max_k = nkmp->k.max ?: 1 << nkmp->k.width;\n\t_nkmp.min_m = 1;\n\t_nkmp.max_m = nkmp->m.max ?: 1 << nkmp->m.width;\n\t_nkmp.min_p = 1;\n\t_nkmp.max_p = nkmp->p.max ?: 1 << ((1 << nkmp->p.width) - 1);\n\n\tccu_nkmp_find_best(parent_rate, rate, &_nkmp);\n\n\t \n\tif (nkmp->n.width)\n\t\tn_mask = GENMASK(nkmp->n.width + nkmp->n.shift - 1,\n\t\t\t\t nkmp->n.shift);\n\tif (nkmp->k.width)\n\t\tk_mask = GENMASK(nkmp->k.width + nkmp->k.shift - 1,\n\t\t\t\t nkmp->k.shift);\n\tif (nkmp->m.width)\n\t\tm_mask = GENMASK(nkmp->m.width + nkmp->m.shift - 1,\n\t\t\t\t nkmp->m.shift);\n\tif (nkmp->p.width)\n\t\tp_mask = GENMASK(nkmp->p.width + nkmp->p.shift - 1,\n\t\t\t\t nkmp->p.shift);\n\n\tspin_lock_irqsave(nkmp->common.lock, flags);\n\n\treg = readl(nkmp->common.base + nkmp->common.reg);\n\treg &= ~(n_mask | k_mask | m_mask | p_mask);\n\n\treg |= ((_nkmp.n - nkmp->n.offset) << nkmp->n.shift) & n_mask;\n\treg |= ((_nkmp.k - nkmp->k.offset) << nkmp->k.shift) & k_mask;\n\treg |= ((_nkmp.m - nkmp->m.offset) << nkmp->m.shift) & m_mask;\n\treg |= (ilog2(_nkmp.p) << nkmp->p.shift) & p_mask;\n\n\twritel(reg, nkmp->common.base + nkmp->common.reg);\n\n\tspin_unlock_irqrestore(nkmp->common.lock, flags);\n\n\tccu_helper_wait_for_lock(&nkmp->common, nkmp->lock);\n\n\treturn 0;\n}\n\nconst struct clk_ops ccu_nkmp_ops = {\n\t.disable\t= ccu_nkmp_disable,\n\t.enable\t\t= ccu_nkmp_enable,\n\t.is_enabled\t= ccu_nkmp_is_enabled,\n\n\t.recalc_rate\t= ccu_nkmp_recalc_rate,\n\t.round_rate\t= ccu_nkmp_round_rate,\n\t.set_rate\t= ccu_nkmp_set_rate,\n};\nEXPORT_SYMBOL_NS_GPL(ccu_nkmp_ops, SUNXI_CCU);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}