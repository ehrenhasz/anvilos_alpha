{
  "module_name": "clk-starfive-jh7110-stg.c",
  "hash_id": "fa60a4736d4cb829a5b1993922acb33a76011ee9fadc338de5bf1a92f3c042ee",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/starfive/clk-starfive-jh7110-stg.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <linux/platform_device.h>\n\n#include <dt-bindings/clock/starfive,jh7110-crg.h>\n\n#include \"clk-starfive-jh7110.h\"\n\n \n#define JH7110_STGCLK_OSC\t\t\t(JH7110_STGCLK_END + 0)\n#define JH7110_STGCLK_HIFI4_CORE\t\t(JH7110_STGCLK_END + 1)\n#define JH7110_STGCLK_STG_AXIAHB\t\t(JH7110_STGCLK_END + 2)\n#define JH7110_STGCLK_USB_125M\t\t\t(JH7110_STGCLK_END + 3)\n#define JH7110_STGCLK_CPU_BUS\t\t\t(JH7110_STGCLK_END + 4)\n#define JH7110_STGCLK_HIFI4_AXI\t\t\t(JH7110_STGCLK_END + 5)\n#define JH7110_STGCLK_NOCSTG_BUS\t\t(JH7110_STGCLK_END + 6)\n#define JH7110_STGCLK_APB_BUS\t\t\t(JH7110_STGCLK_END + 7)\n#define JH7110_STGCLK_EXT_END\t\t\t(JH7110_STGCLK_END + 8)\n\nstatic const struct jh71x0_clk_data jh7110_stgclk_data[] = {\n\t \n\tJH71X0_GATE(JH7110_STGCLK_HIFI4_CLK_CORE, \"hifi4_clk_core\", 0,\n\t\t    JH7110_STGCLK_HIFI4_CORE),\n\t \n\tJH71X0_GATE(JH7110_STGCLK_USB0_APB, \"usb0_apb\", 0, JH7110_STGCLK_APB_BUS),\n\tJH71X0_GATE(JH7110_STGCLK_USB0_UTMI_APB, \"usb0_utmi_apb\", 0, JH7110_STGCLK_APB_BUS),\n\tJH71X0_GATE(JH7110_STGCLK_USB0_AXI, \"usb0_axi\", 0, JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GDIV(JH7110_STGCLK_USB0_LPM, \"usb0_lpm\", 0, 2, JH7110_STGCLK_OSC),\n\tJH71X0_GDIV(JH7110_STGCLK_USB0_STB, \"usb0_stb\", 0, 4, JH7110_STGCLK_OSC),\n\tJH71X0_GATE(JH7110_STGCLK_USB0_APP_125, \"usb0_app_125\", 0, JH7110_STGCLK_USB_125M),\n\tJH71X0__DIV(JH7110_STGCLK_USB0_REFCLK, \"usb0_refclk\", 2, JH7110_STGCLK_OSC),\n\t \n\tJH71X0_GATE(JH7110_STGCLK_PCIE0_AXI_MST0, \"pcie0_axi_mst0\", 0,\n\t\t    JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GATE(JH7110_STGCLK_PCIE0_APB, \"pcie0_apb\", 0, JH7110_STGCLK_APB_BUS),\n\tJH71X0_GATE(JH7110_STGCLK_PCIE0_TL, \"pcie0_tl\", 0, JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GATE(JH7110_STGCLK_PCIE1_AXI_MST0, \"pcie1_axi_mst0\", 0,\n\t\t    JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GATE(JH7110_STGCLK_PCIE1_APB, \"pcie1_apb\", 0, JH7110_STGCLK_APB_BUS),\n\tJH71X0_GATE(JH7110_STGCLK_PCIE1_TL, \"pcie1_tl\", 0, JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GATE(JH7110_STGCLK_PCIE_SLV_MAIN, \"pcie_slv_main\", CLK_IS_CRITICAL,\n\t\t    JH7110_STGCLK_STG_AXIAHB),\n\t \n\tJH71X0_GATE(JH7110_STGCLK_SEC_AHB, \"sec_ahb\", 0, JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GATE(JH7110_STGCLK_SEC_MISC_AHB, \"sec_misc_ahb\", 0, JH7110_STGCLK_STG_AXIAHB),\n\t \n\tJH71X0_GATE(JH7110_STGCLK_GRP0_MAIN, \"mtrx_grp0_main\", CLK_IS_CRITICAL,\n\t\t    JH7110_STGCLK_CPU_BUS),\n\tJH71X0_GATE(JH7110_STGCLK_GRP0_BUS, \"mtrx_grp0_bus\", CLK_IS_CRITICAL,\n\t\t    JH7110_STGCLK_NOCSTG_BUS),\n\tJH71X0_GATE(JH7110_STGCLK_GRP0_STG, \"mtrx_grp0_stg\", CLK_IS_CRITICAL,\n\t\t    JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GATE(JH7110_STGCLK_GRP1_MAIN, \"mtrx_grp1_main\", CLK_IS_CRITICAL,\n\t\t    JH7110_STGCLK_CPU_BUS),\n\tJH71X0_GATE(JH7110_STGCLK_GRP1_BUS, \"mtrx_grp1_bus\", CLK_IS_CRITICAL,\n\t\t    JH7110_STGCLK_NOCSTG_BUS),\n\tJH71X0_GATE(JH7110_STGCLK_GRP1_STG, \"mtrx_grp1_stg\", CLK_IS_CRITICAL,\n\t\t    JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GATE(JH7110_STGCLK_GRP1_HIFI, \"mtrx_grp1_hifi\", CLK_IS_CRITICAL,\n\t\t    JH7110_STGCLK_HIFI4_AXI),\n\t \n\tJH71X0_GDIV(JH7110_STGCLK_E2_RTC, \"e2_rtc\", 0, 24, JH7110_STGCLK_OSC),\n\tJH71X0_GATE(JH7110_STGCLK_E2_CORE, \"e2_core\", 0, JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GATE(JH7110_STGCLK_E2_DBG, \"e2_dbg\", 0, JH7110_STGCLK_STG_AXIAHB),\n\t \n\tJH71X0_GATE(JH7110_STGCLK_DMA1P_AXI, \"dma1p_axi\", 0, JH7110_STGCLK_STG_AXIAHB),\n\tJH71X0_GATE(JH7110_STGCLK_DMA1P_AHB, \"dma1p_ahb\", 0, JH7110_STGCLK_STG_AXIAHB),\n};\n\nstatic struct clk_hw *jh7110_stgclk_get(struct of_phandle_args *clkspec, void *data)\n{\n\tstruct jh71x0_clk_priv *priv = data;\n\tunsigned int idx = clkspec->args[0];\n\n\tif (idx < JH7110_STGCLK_END)\n\t\treturn &priv->reg[idx].hw;\n\n\treturn ERR_PTR(-EINVAL);\n}\n\nstatic int jh7110_stgcrg_probe(struct platform_device *pdev)\n{\n\tstruct jh71x0_clk_priv *priv;\n\tunsigned int idx;\n\tint ret;\n\n\tpriv = devm_kzalloc(&pdev->dev, struct_size(priv, reg, JH7110_STGCLK_END),\n\t\t\t    GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tspin_lock_init(&priv->rmw_lock);\n\tpriv->dev = &pdev->dev;\n\tpriv->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(priv->base))\n\t\treturn PTR_ERR(priv->base);\n\n\tfor (idx = 0; idx < JH7110_STGCLK_END; idx++) {\n\t\tu32 max = jh7110_stgclk_data[idx].max;\n\t\tstruct clk_parent_data parents[4] = {};\n\t\tstruct clk_init_data init = {\n\t\t\t.name = jh7110_stgclk_data[idx].name,\n\t\t\t.ops = starfive_jh71x0_clk_ops(max),\n\t\t\t.parent_data = parents,\n\t\t\t.num_parents =\n\t\t\t\t((max & JH71X0_CLK_MUX_MASK) >> JH71X0_CLK_MUX_SHIFT) + 1,\n\t\t\t.flags = jh7110_stgclk_data[idx].flags,\n\t\t};\n\t\tstruct jh71x0_clk *clk = &priv->reg[idx];\n\t\tconst char *fw_name[JH7110_STGCLK_EXT_END - JH7110_STGCLK_END] = {\n\t\t\t\"osc\",\n\t\t\t\"hifi4_core\",\n\t\t\t\"stg_axiahb\",\n\t\t\t\"usb_125m\",\n\t\t\t\"cpu_bus\",\n\t\t\t\"hifi4_axi\",\n\t\t\t\"nocstg_bus\",\n\t\t\t\"apb_bus\"\n\t\t};\n\t\tunsigned int i;\n\n\t\tfor (i = 0; i < init.num_parents; i++) {\n\t\t\tunsigned int pidx = jh7110_stgclk_data[idx].parents[i];\n\n\t\t\tif (pidx < JH7110_STGCLK_END)\n\t\t\t\tparents[i].hw = &priv->reg[pidx].hw;\n\t\t\telse if (pidx < JH7110_STGCLK_EXT_END)\n\t\t\t\tparents[i].fw_name = fw_name[pidx - JH7110_STGCLK_END];\n\t\t}\n\n\t\tclk->hw.init = &init;\n\t\tclk->idx = idx;\n\t\tclk->max_div = max & JH71X0_CLK_DIV_MASK;\n\n\t\tret = devm_clk_hw_register(&pdev->dev, &clk->hw);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = devm_of_clk_add_hw_provider(&pdev->dev, jh7110_stgclk_get, priv);\n\tif (ret)\n\t\treturn ret;\n\n\treturn jh7110_reset_controller_register(priv, \"rst-stg\", 2);\n}\n\nstatic const struct of_device_id jh7110_stgcrg_match[] = {\n\t{ .compatible = \"starfive,jh7110-stgcrg\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, jh7110_stgcrg_match);\n\nstatic struct platform_driver jh7110_stgcrg_driver = {\n\t.probe = jh7110_stgcrg_probe,\n\t.driver = {\n\t\t.name = \"clk-starfive-jh7110-stg\",\n\t\t.of_match_table = jh7110_stgcrg_match,\n\t},\n};\nmodule_platform_driver(jh7110_stgcrg_driver);\n\nMODULE_AUTHOR(\"Xingyu Wu <xingyu.wu@starfivetech.com>\");\nMODULE_AUTHOR(\"Emil Renner Berthing <kernel@esmil.dk>\");\nMODULE_DESCRIPTION(\"StarFive JH7110 System-Top-Group clock driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}