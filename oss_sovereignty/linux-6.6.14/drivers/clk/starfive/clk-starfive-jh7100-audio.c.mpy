{
  "module_name": "clk-starfive-jh7100-audio.c",
  "hash_id": "0fdfe03eb0ae5f59e707544f3f114b1962ded81b083dffd66db3934133bccacc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/starfive/clk-starfive-jh7100-audio.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/clk-provider.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\n#include <dt-bindings/clock/starfive-jh7100-audio.h>\n\n#include \"clk-starfive-jh71x0.h\"\n\n \n#define JH7100_AUDCLK_AUDIO_SRC\t\t\t(JH7100_AUDCLK_END + 0)\n#define JH7100_AUDCLK_AUDIO_12288\t\t(JH7100_AUDCLK_END + 1)\n#define JH7100_AUDCLK_DOM7AHB_BUS\t\t(JH7100_AUDCLK_END + 2)\n#define JH7100_AUDCLK_I2SADC_BCLK_IOPAD\t\t(JH7100_AUDCLK_END + 3)\n#define JH7100_AUDCLK_I2SADC_LRCLK_IOPAD\t(JH7100_AUDCLK_END + 4)\n#define JH7100_AUDCLK_I2SDAC_BCLK_IOPAD\t\t(JH7100_AUDCLK_END + 5)\n#define JH7100_AUDCLK_I2SDAC_LRCLK_IOPAD\t(JH7100_AUDCLK_END + 6)\n#define JH7100_AUDCLK_VAD_INTMEM                (JH7100_AUDCLK_END + 7)\n\nstatic const struct jh71x0_clk_data jh7100_audclk_data[] = {\n\tJH71X0__GMD(JH7100_AUDCLK_ADC_MCLK, \"adc_mclk\", 0, 15, 2,\n\t\t    JH7100_AUDCLK_AUDIO_SRC,\n\t\t    JH7100_AUDCLK_AUDIO_12288),\n\tJH71X0__GMD(JH7100_AUDCLK_I2S1_MCLK, \"i2s1_mclk\", 0, 15, 2,\n\t\t    JH7100_AUDCLK_AUDIO_SRC,\n\t\t    JH7100_AUDCLK_AUDIO_12288),\n\tJH71X0_GATE(JH7100_AUDCLK_I2SADC_APB, \"i2sadc_apb\", 0, JH7100_AUDCLK_APB0_BUS),\n\tJH71X0_MDIV(JH7100_AUDCLK_I2SADC_BCLK, \"i2sadc_bclk\", 31, 2,\n\t\t    JH7100_AUDCLK_ADC_MCLK,\n\t\t    JH7100_AUDCLK_I2SADC_BCLK_IOPAD),\n\tJH71X0__INV(JH7100_AUDCLK_I2SADC_BCLK_N, \"i2sadc_bclk_n\", JH7100_AUDCLK_I2SADC_BCLK),\n\tJH71X0_MDIV(JH7100_AUDCLK_I2SADC_LRCLK, \"i2sadc_lrclk\", 63, 3,\n\t\t    JH7100_AUDCLK_I2SADC_BCLK_N,\n\t\t    JH7100_AUDCLK_I2SADC_LRCLK_IOPAD,\n\t\t    JH7100_AUDCLK_I2SADC_BCLK),\n\tJH71X0_GATE(JH7100_AUDCLK_PDM_APB, \"pdm_apb\", 0, JH7100_AUDCLK_APB0_BUS),\n\tJH71X0__GMD(JH7100_AUDCLK_PDM_MCLK, \"pdm_mclk\", 0, 15, 2,\n\t\t    JH7100_AUDCLK_AUDIO_SRC,\n\t\t    JH7100_AUDCLK_AUDIO_12288),\n\tJH71X0_GATE(JH7100_AUDCLK_I2SVAD_APB, \"i2svad_apb\", 0, JH7100_AUDCLK_APB0_BUS),\n\tJH71X0__GMD(JH7100_AUDCLK_SPDIF, \"spdif\", 0, 15, 2,\n\t\t    JH7100_AUDCLK_AUDIO_SRC,\n\t\t    JH7100_AUDCLK_AUDIO_12288),\n\tJH71X0_GATE(JH7100_AUDCLK_SPDIF_APB, \"spdif_apb\", 0, JH7100_AUDCLK_APB0_BUS),\n\tJH71X0_GATE(JH7100_AUDCLK_PWMDAC_APB, \"pwmdac_apb\", 0, JH7100_AUDCLK_APB0_BUS),\n\tJH71X0__GMD(JH7100_AUDCLK_DAC_MCLK, \"dac_mclk\", 0, 15, 2,\n\t\t    JH7100_AUDCLK_AUDIO_SRC,\n\t\t    JH7100_AUDCLK_AUDIO_12288),\n\tJH71X0_GATE(JH7100_AUDCLK_I2SDAC_APB, \"i2sdac_apb\", 0, JH7100_AUDCLK_APB0_BUS),\n\tJH71X0_MDIV(JH7100_AUDCLK_I2SDAC_BCLK, \"i2sdac_bclk\", 31, 2,\n\t\t    JH7100_AUDCLK_DAC_MCLK,\n\t\t    JH7100_AUDCLK_I2SDAC_BCLK_IOPAD),\n\tJH71X0__INV(JH7100_AUDCLK_I2SDAC_BCLK_N, \"i2sdac_bclk_n\", JH7100_AUDCLK_I2SDAC_BCLK),\n\tJH71X0_MDIV(JH7100_AUDCLK_I2SDAC_LRCLK, \"i2sdac_lrclk\", 31, 2,\n\t\t    JH7100_AUDCLK_I2S1_MCLK,\n\t\t    JH7100_AUDCLK_I2SDAC_BCLK_IOPAD),\n\tJH71X0_GATE(JH7100_AUDCLK_I2S1_APB, \"i2s1_apb\", 0, JH7100_AUDCLK_APB0_BUS),\n\tJH71X0_MDIV(JH7100_AUDCLK_I2S1_BCLK, \"i2s1_bclk\", 31, 2,\n\t\t    JH7100_AUDCLK_I2S1_MCLK,\n\t\t    JH7100_AUDCLK_I2SDAC_BCLK_IOPAD),\n\tJH71X0__INV(JH7100_AUDCLK_I2S1_BCLK_N, \"i2s1_bclk_n\", JH7100_AUDCLK_I2S1_BCLK),\n\tJH71X0_MDIV(JH7100_AUDCLK_I2S1_LRCLK, \"i2s1_lrclk\", 63, 3,\n\t\t    JH7100_AUDCLK_I2S1_BCLK_N,\n\t\t    JH7100_AUDCLK_I2SDAC_LRCLK_IOPAD),\n\tJH71X0_GATE(JH7100_AUDCLK_I2SDAC16K_APB, \"i2s1dac16k_apb\", 0, JH7100_AUDCLK_APB0_BUS),\n\tJH71X0__DIV(JH7100_AUDCLK_APB0_BUS, \"apb0_bus\", 8, JH7100_AUDCLK_DOM7AHB_BUS),\n\tJH71X0_GATE(JH7100_AUDCLK_DMA1P_AHB, \"dma1p_ahb\", 0, JH7100_AUDCLK_DOM7AHB_BUS),\n\tJH71X0_GATE(JH7100_AUDCLK_USB_APB, \"usb_apb\", CLK_IGNORE_UNUSED, JH7100_AUDCLK_APB_EN),\n\tJH71X0_GDIV(JH7100_AUDCLK_USB_LPM, \"usb_lpm\", CLK_IGNORE_UNUSED, 4, JH7100_AUDCLK_USB_APB),\n\tJH71X0_GDIV(JH7100_AUDCLK_USB_STB, \"usb_stb\", CLK_IGNORE_UNUSED, 3, JH7100_AUDCLK_USB_APB),\n\tJH71X0__DIV(JH7100_AUDCLK_APB_EN, \"apb_en\", 8, JH7100_AUDCLK_DOM7AHB_BUS),\n\tJH71X0__MUX(JH7100_AUDCLK_VAD_MEM, \"vad_mem\", 2,\n\t\t    JH7100_AUDCLK_VAD_INTMEM,\n\t\t    JH7100_AUDCLK_AUDIO_12288),\n};\n\nstatic struct clk_hw *jh7100_audclk_get(struct of_phandle_args *clkspec, void *data)\n{\n\tstruct jh71x0_clk_priv *priv = data;\n\tunsigned int idx = clkspec->args[0];\n\n\tif (idx < JH7100_AUDCLK_END)\n\t\treturn &priv->reg[idx].hw;\n\n\treturn ERR_PTR(-EINVAL);\n}\n\nstatic int jh7100_audclk_probe(struct platform_device *pdev)\n{\n\tstruct jh71x0_clk_priv *priv;\n\tunsigned int idx;\n\tint ret;\n\n\tpriv = devm_kzalloc(&pdev->dev, struct_size(priv, reg, JH7100_AUDCLK_END), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tspin_lock_init(&priv->rmw_lock);\n\tpriv->dev = &pdev->dev;\n\tpriv->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(priv->base))\n\t\treturn PTR_ERR(priv->base);\n\n\tfor (idx = 0; idx < JH7100_AUDCLK_END; idx++) {\n\t\tu32 max = jh7100_audclk_data[idx].max;\n\t\tstruct clk_parent_data parents[4] = {};\n\t\tstruct clk_init_data init = {\n\t\t\t.name = jh7100_audclk_data[idx].name,\n\t\t\t.ops = starfive_jh71x0_clk_ops(max),\n\t\t\t.parent_data = parents,\n\t\t\t.num_parents = ((max & JH71X0_CLK_MUX_MASK) >> JH71X0_CLK_MUX_SHIFT) + 1,\n\t\t\t.flags = jh7100_audclk_data[idx].flags,\n\t\t};\n\t\tstruct jh71x0_clk *clk = &priv->reg[idx];\n\t\tunsigned int i;\n\n\t\tfor (i = 0; i < init.num_parents; i++) {\n\t\t\tunsigned int pidx = jh7100_audclk_data[idx].parents[i];\n\n\t\t\tif (pidx < JH7100_AUDCLK_END)\n\t\t\t\tparents[i].hw = &priv->reg[pidx].hw;\n\t\t\telse if (pidx == JH7100_AUDCLK_AUDIO_SRC)\n\t\t\t\tparents[i].fw_name = \"audio_src\";\n\t\t\telse if (pidx == JH7100_AUDCLK_AUDIO_12288)\n\t\t\t\tparents[i].fw_name = \"audio_12288\";\n\t\t\telse if (pidx == JH7100_AUDCLK_DOM7AHB_BUS)\n\t\t\t\tparents[i].fw_name = \"dom7ahb_bus\";\n\t\t}\n\n\t\tclk->hw.init = &init;\n\t\tclk->idx = idx;\n\t\tclk->max_div = max & JH71X0_CLK_DIV_MASK;\n\n\t\tret = devm_clk_hw_register(priv->dev, &clk->hw);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn devm_of_clk_add_hw_provider(priv->dev, jh7100_audclk_get, priv);\n}\n\nstatic const struct of_device_id jh7100_audclk_match[] = {\n\t{ .compatible = \"starfive,jh7100-audclk\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, jh7100_audclk_match);\n\nstatic struct platform_driver jh7100_audclk_driver = {\n\t.probe = jh7100_audclk_probe,\n\t.driver = {\n\t\t.name = \"clk-starfive-jh7100-audio\",\n\t\t.of_match_table = jh7100_audclk_match,\n\t},\n};\nmodule_platform_driver(jh7100_audclk_driver);\n\nMODULE_AUTHOR(\"Emil Renner Berthing\");\nMODULE_DESCRIPTION(\"StarFive JH7100 audio clock driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}