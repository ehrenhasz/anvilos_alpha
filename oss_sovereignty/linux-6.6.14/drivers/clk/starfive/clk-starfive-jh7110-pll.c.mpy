{
  "module_name": "clk-starfive-jh7110-pll.c",
  "hash_id": "659f9e3b26d9986ac29ed375f9df9efdff8622ff799ed01a2932e9ba8cf2db3f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/starfive/clk-starfive-jh7110-pll.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/clk-provider.h>\n#include <linux/debugfs.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/mfd/syscon.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include <dt-bindings/clock/starfive,jh7110-crg.h>\n\n \n#define JH7110_PLL_OSC_RATE\t\t24000000UL\n\n#define JH7110_PLL0_PD_OFFSET\t\t0x18\n#define JH7110_PLL0_DACPD_SHIFT\t\t24\n#define JH7110_PLL0_DACPD_MASK\t\tBIT(24)\n#define JH7110_PLL0_DSMPD_SHIFT\t\t25\n#define JH7110_PLL0_DSMPD_MASK\t\tBIT(25)\n#define JH7110_PLL0_FBDIV_OFFSET\t0x1c\n#define JH7110_PLL0_FBDIV_SHIFT\t\t0\n#define JH7110_PLL0_FBDIV_MASK\t\tGENMASK(11, 0)\n#define JH7110_PLL0_FRAC_OFFSET\t\t0x20\n#define JH7110_PLL0_PREDIV_OFFSET\t0x24\n\n#define JH7110_PLL1_PD_OFFSET\t\t0x24\n#define JH7110_PLL1_DACPD_SHIFT\t\t15\n#define JH7110_PLL1_DACPD_MASK\t\tBIT(15)\n#define JH7110_PLL1_DSMPD_SHIFT\t\t16\n#define JH7110_PLL1_DSMPD_MASK\t\tBIT(16)\n#define JH7110_PLL1_FBDIV_OFFSET\t0x24\n#define JH7110_PLL1_FBDIV_SHIFT\t\t17\n#define JH7110_PLL1_FBDIV_MASK\t\tGENMASK(28, 17)\n#define JH7110_PLL1_FRAC_OFFSET\t\t0x28\n#define JH7110_PLL1_PREDIV_OFFSET\t0x2c\n\n#define JH7110_PLL2_PD_OFFSET\t\t0x2c\n#define JH7110_PLL2_DACPD_SHIFT\t\t15\n#define JH7110_PLL2_DACPD_MASK\t\tBIT(15)\n#define JH7110_PLL2_DSMPD_SHIFT\t\t16\n#define JH7110_PLL2_DSMPD_MASK\t\tBIT(16)\n#define JH7110_PLL2_FBDIV_OFFSET\t0x2c\n#define JH7110_PLL2_FBDIV_SHIFT\t\t17\n#define JH7110_PLL2_FBDIV_MASK\t\tGENMASK(28, 17)\n#define JH7110_PLL2_FRAC_OFFSET\t\t0x30\n#define JH7110_PLL2_PREDIV_OFFSET\t0x34\n\n#define JH7110_PLL_FRAC_SHIFT\t\t0\n#define JH7110_PLL_FRAC_MASK\t\tGENMASK(23, 0)\n#define JH7110_PLL_POSTDIV1_SHIFT\t28\n#define JH7110_PLL_POSTDIV1_MASK\tGENMASK(29, 28)\n#define JH7110_PLL_PREDIV_SHIFT\t\t0\n#define JH7110_PLL_PREDIV_MASK\t\tGENMASK(5, 0)\n\nenum jh7110_pll_mode {\n\tJH7110_PLL_MODE_FRACTION,\n\tJH7110_PLL_MODE_INTEGER,\n};\n\nstruct jh7110_pll_preset {\n\tunsigned long freq;\n\tu32 frac;\t\t \n\tunsigned fbdiv    : 12;\t \n\tunsigned prediv   :  6;\n\tunsigned postdiv1 :  2;\n\tunsigned mode     :  1;\n};\n\nstruct jh7110_pll_info {\n\tchar *name;\n\tconst struct jh7110_pll_preset *presets;\n\tunsigned int npresets;\n\tstruct {\n\t\tunsigned int pd;\n\t\tunsigned int fbdiv;\n\t\tunsigned int frac;\n\t\tunsigned int prediv;\n\t} offsets;\n\tstruct {\n\t\tu32 dacpd;\n\t\tu32 dsmpd;\n\t\tu32 fbdiv;\n\t} masks;\n\tstruct {\n\t\tchar dacpd;\n\t\tchar dsmpd;\n\t\tchar fbdiv;\n\t} shifts;\n};\n\n#define _JH7110_PLL(_idx, _name, _presets)\t\t\t\t\\\n\t[_idx] = {\t\t\t\t\t\t\t\\\n\t\t.name = _name,\t\t\t\t\t\t\\\n\t\t.presets = _presets,\t\t\t\t\t\\\n\t\t.npresets = ARRAY_SIZE(_presets),\t\t\t\\\n\t\t.offsets = {\t\t\t\t\t\t\\\n\t\t\t.pd = JH7110_PLL##_idx##_PD_OFFSET,\t\t\\\n\t\t\t.fbdiv = JH7110_PLL##_idx##_FBDIV_OFFSET,\t\\\n\t\t\t.frac = JH7110_PLL##_idx##_FRAC_OFFSET,\t\t\\\n\t\t\t.prediv = JH7110_PLL##_idx##_PREDIV_OFFSET,\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.masks = {\t\t\t\t\t\t\\\n\t\t\t.dacpd = JH7110_PLL##_idx##_DACPD_MASK,\t\t\\\n\t\t\t.dsmpd = JH7110_PLL##_idx##_DSMPD_MASK,\t\t\\\n\t\t\t.fbdiv = JH7110_PLL##_idx##_FBDIV_MASK,\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.shifts = {\t\t\t\t\t\t\\\n\t\t\t.dacpd = JH7110_PLL##_idx##_DACPD_SHIFT,\t\\\n\t\t\t.dsmpd = JH7110_PLL##_idx##_DSMPD_SHIFT,\t\\\n\t\t\t.fbdiv = JH7110_PLL##_idx##_FBDIV_SHIFT,\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t}\n#define JH7110_PLL(idx, name, presets) _JH7110_PLL(idx, name, presets)\n\nstruct jh7110_pll_data {\n\tstruct clk_hw hw;\n\tunsigned int idx;\n};\n\nstruct jh7110_pll_priv {\n\tstruct device *dev;\n\tstruct regmap *regmap;\n\tstruct jh7110_pll_data pll[JH7110_PLLCLK_END];\n};\n\nstruct jh7110_pll_regvals {\n\tu32 dacpd;\n\tu32 dsmpd;\n\tu32 fbdiv;\n\tu32 frac;\n\tu32 postdiv1;\n\tu32 prediv;\n};\n\n \nstatic const struct jh7110_pll_preset jh7110_pll0_presets[] = {\n\t{\n\t\t.freq = 375000000,\n\t\t.fbdiv = 125,\n\t\t.prediv = 8,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 500000000,\n\t\t.fbdiv = 125,\n\t\t.prediv = 6,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 625000000,\n\t\t.fbdiv = 625,\n\t\t.prediv = 24,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 750000000,\n\t\t.fbdiv = 125,\n\t\t.prediv = 4,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 875000000,\n\t\t.fbdiv = 875,\n\t\t.prediv = 24,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 1000000000,\n\t\t.fbdiv = 125,\n\t\t.prediv = 3,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 1250000000,\n\t\t.fbdiv = 625,\n\t\t.prediv = 12,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 1375000000,\n\t\t.fbdiv = 1375,\n\t\t.prediv = 24,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 1500000000,\n\t\t.fbdiv = 125,\n\t\t.prediv = 2,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t},\n};\n\nstatic const struct jh7110_pll_preset jh7110_pll1_presets[] = {\n\t{\n\t\t.freq = 1066000000,\n\t\t.fbdiv = 533,\n\t\t.prediv = 12,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 1200000000,\n\t\t.fbdiv = 50,\n\t\t.prediv = 1,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 1400000000,\n\t\t.fbdiv = 350,\n\t\t.prediv = 6,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 1600000000,\n\t\t.fbdiv = 200,\n\t\t.prediv = 3,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t},\n};\n\nstatic const struct jh7110_pll_preset jh7110_pll2_presets[] = {\n\t{\n\t\t.freq = 1188000000,\n\t\t.fbdiv = 99,\n\t\t.prediv = 2,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t}, {\n\t\t.freq = 1228800000,\n\t\t.fbdiv = 256,\n\t\t.prediv = 5,\n\t\t.postdiv1 = 0,\n\t\t.mode = JH7110_PLL_MODE_INTEGER,\n\t},\n};\n\nstatic const struct jh7110_pll_info jh7110_plls[JH7110_PLLCLK_END] = {\n\tJH7110_PLL(JH7110_PLLCLK_PLL0_OUT, \"pll0_out\", jh7110_pll0_presets),\n\tJH7110_PLL(JH7110_PLLCLK_PLL1_OUT, \"pll1_out\", jh7110_pll1_presets),\n\tJH7110_PLL(JH7110_PLLCLK_PLL2_OUT, \"pll2_out\", jh7110_pll2_presets),\n};\n\nstatic struct jh7110_pll_data *jh7110_pll_data_from(struct clk_hw *hw)\n{\n\treturn container_of(hw, struct jh7110_pll_data, hw);\n}\n\nstatic struct jh7110_pll_priv *jh7110_pll_priv_from(struct jh7110_pll_data *pll)\n{\n\treturn container_of(pll, struct jh7110_pll_priv, pll[pll->idx]);\n}\n\nstatic void jh7110_pll_regvals_get(struct regmap *regmap,\n\t\t\t\t   const struct jh7110_pll_info *info,\n\t\t\t\t   struct jh7110_pll_regvals *ret)\n{\n\tu32 val;\n\n\tregmap_read(regmap, info->offsets.pd, &val);\n\tret->dacpd = (val & info->masks.dacpd) >> info->shifts.dacpd;\n\tret->dsmpd = (val & info->masks.dsmpd) >> info->shifts.dsmpd;\n\n\tregmap_read(regmap, info->offsets.fbdiv, &val);\n\tret->fbdiv = (val & info->masks.fbdiv) >> info->shifts.fbdiv;\n\n\tregmap_read(regmap, info->offsets.frac, &val);\n\tret->frac = (val & JH7110_PLL_FRAC_MASK) >> JH7110_PLL_FRAC_SHIFT;\n\tret->postdiv1 = (val & JH7110_PLL_POSTDIV1_MASK) >> JH7110_PLL_POSTDIV1_SHIFT;\n\n\tregmap_read(regmap, info->offsets.prediv, &val);\n\tret->prediv = (val & JH7110_PLL_PREDIV_MASK) >> JH7110_PLL_PREDIV_SHIFT;\n}\n\nstatic unsigned long jh7110_pll_recalc_rate(struct clk_hw *hw, unsigned long parent_rate)\n{\n\tstruct jh7110_pll_data *pll = jh7110_pll_data_from(hw);\n\tstruct jh7110_pll_priv *priv = jh7110_pll_priv_from(pll);\n\tstruct jh7110_pll_regvals val;\n\tunsigned long rate;\n\n\tjh7110_pll_regvals_get(priv->regmap, &jh7110_plls[pll->idx], &val);\n\n\t \n\tif (val.dacpd == 0 && val.dsmpd == 0)\n\t\trate = parent_rate * val.frac / (1UL << 24);\n\telse if (val.dacpd == 1 && val.dsmpd == 1)\n\t\trate = 0;\n\telse\n\t\treturn 0;\n\n\trate += parent_rate * val.fbdiv;\n\trate /= val.prediv << val.postdiv1;\n\n\treturn rate;\n}\n\nstatic int jh7110_pll_determine_rate(struct clk_hw *hw, struct clk_rate_request *req)\n{\n\tstruct jh7110_pll_data *pll = jh7110_pll_data_from(hw);\n\tconst struct jh7110_pll_info *info = &jh7110_plls[pll->idx];\n\tconst struct jh7110_pll_preset *selected = &info->presets[0];\n\tunsigned int idx;\n\n\t \n\tif (req->best_parent_rate != JH7110_PLL_OSC_RATE) {\n\t\treq->rate = jh7110_pll_recalc_rate(hw, req->best_parent_rate);\n\t\treturn 0;\n\t}\n\n\t \n\tfor (idx = 1; idx < info->npresets; idx++) {\n\t\tconst struct jh7110_pll_preset *val = &info->presets[idx];\n\n\t\tif (req->rate < val->freq)\n\t\t\tbreak;\n\n\t\tselected = val;\n\t}\n\n\treq->rate = selected->freq;\n\treturn 0;\n}\n\nstatic int jh7110_pll_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t       unsigned long parent_rate)\n{\n\tstruct jh7110_pll_data *pll = jh7110_pll_data_from(hw);\n\tstruct jh7110_pll_priv *priv = jh7110_pll_priv_from(pll);\n\tconst struct jh7110_pll_info *info = &jh7110_plls[pll->idx];\n\tconst struct jh7110_pll_preset *val;\n\tunsigned int idx;\n\n\t \n\tif (parent_rate != JH7110_PLL_OSC_RATE)\n\t\treturn -EINVAL;\n\n\tfor (idx = 0, val = &info->presets[0]; idx < info->npresets; idx++, val++) {\n\t\tif (val->freq == rate)\n\t\t\tgoto found;\n\t}\n\treturn -EINVAL;\n\nfound:\n\tif (val->mode == JH7110_PLL_MODE_FRACTION)\n\t\tregmap_update_bits(priv->regmap, info->offsets.frac, JH7110_PLL_FRAC_MASK,\n\t\t\t\t   val->frac << JH7110_PLL_FRAC_SHIFT);\n\n\tregmap_update_bits(priv->regmap, info->offsets.pd, info->masks.dacpd,\n\t\t\t   (u32)val->mode << info->shifts.dacpd);\n\tregmap_update_bits(priv->regmap, info->offsets.pd, info->masks.dsmpd,\n\t\t\t   (u32)val->mode << info->shifts.dsmpd);\n\tregmap_update_bits(priv->regmap, info->offsets.prediv, JH7110_PLL_PREDIV_MASK,\n\t\t\t   (u32)val->prediv << JH7110_PLL_PREDIV_SHIFT);\n\tregmap_update_bits(priv->regmap, info->offsets.fbdiv, info->masks.fbdiv,\n\t\t\t   val->fbdiv << info->shifts.fbdiv);\n\tregmap_update_bits(priv->regmap, info->offsets.frac, JH7110_PLL_POSTDIV1_MASK,\n\t\t\t   (u32)val->postdiv1 << JH7110_PLL_POSTDIV1_SHIFT);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_DEBUG_FS\nstatic int jh7110_pll_registers_read(struct seq_file *s, void *unused)\n{\n\tstruct jh7110_pll_data *pll = s->private;\n\tstruct jh7110_pll_priv *priv = jh7110_pll_priv_from(pll);\n\tstruct jh7110_pll_regvals val;\n\n\tjh7110_pll_regvals_get(priv->regmap, &jh7110_plls[pll->idx], &val);\n\n\tseq_printf(s, \"fbdiv=%u\\n\"\n\t\t      \"frac=%u\\n\"\n\t\t      \"prediv=%u\\n\"\n\t\t      \"postdiv1=%u\\n\"\n\t\t      \"dacpd=%u\\n\"\n\t\t      \"dsmpd=%u\\n\",\n\t\t      val.fbdiv, val.frac, val.prediv, val.postdiv1,\n\t\t      val.dacpd, val.dsmpd);\n\n\treturn 0;\n}\n\nstatic int jh7110_pll_registers_open(struct inode *inode, struct file *f)\n{\n\treturn single_open(f, jh7110_pll_registers_read, inode->i_private);\n}\n\nstatic const struct file_operations jh7110_pll_registers_ops = {\n\t.owner = THIS_MODULE,\n\t.open = jh7110_pll_registers_open,\n\t.release = single_release,\n\t.read = seq_read,\n\t.llseek = seq_lseek\n};\n\nstatic void jh7110_pll_debug_init(struct clk_hw *hw, struct dentry *dentry)\n{\n\tstruct jh7110_pll_data *pll = jh7110_pll_data_from(hw);\n\n\tdebugfs_create_file(\"registers\", 0400, dentry, pll,\n\t\t\t    &jh7110_pll_registers_ops);\n}\n#else\n#define jh7110_pll_debug_init NULL\n#endif\n\nstatic const struct clk_ops jh7110_pll_ops = {\n\t.recalc_rate = jh7110_pll_recalc_rate,\n\t.determine_rate = jh7110_pll_determine_rate,\n\t.set_rate = jh7110_pll_set_rate,\n\t.debug_init = jh7110_pll_debug_init,\n};\n\nstatic struct clk_hw *jh7110_pll_get(struct of_phandle_args *clkspec, void *data)\n{\n\tstruct jh7110_pll_priv *priv = data;\n\tunsigned int idx = clkspec->args[0];\n\n\tif (idx < JH7110_PLLCLK_END)\n\t\treturn &priv->pll[idx].hw;\n\n\treturn ERR_PTR(-EINVAL);\n}\n\nstatic int jh7110_pll_probe(struct platform_device *pdev)\n{\n\tstruct jh7110_pll_priv *priv;\n\tunsigned int idx;\n\tint ret;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = &pdev->dev;\n\tpriv->regmap = syscon_node_to_regmap(priv->dev->of_node->parent);\n\tif (IS_ERR(priv->regmap))\n\t\treturn PTR_ERR(priv->regmap);\n\n\tfor (idx = 0; idx < JH7110_PLLCLK_END; idx++) {\n\t\tstruct clk_parent_data parents = {\n\t\t\t.index = 0,\n\t\t};\n\t\tstruct clk_init_data init = {\n\t\t\t.name = jh7110_plls[idx].name,\n\t\t\t.ops = &jh7110_pll_ops,\n\t\t\t.parent_data = &parents,\n\t\t\t.num_parents = 1,\n\t\t\t.flags = 0,\n\t\t};\n\t\tstruct jh7110_pll_data *pll = &priv->pll[idx];\n\n\t\tpll->hw.init = &init;\n\t\tpll->idx = idx;\n\n\t\tret = devm_clk_hw_register(&pdev->dev, &pll->hw);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn devm_of_clk_add_hw_provider(&pdev->dev, jh7110_pll_get, priv);\n}\n\nstatic const struct of_device_id jh7110_pll_match[] = {\n\t{ .compatible = \"starfive,jh7110-pll\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, jh7110_pll_match);\n\nstatic struct platform_driver jh7110_pll_driver = {\n\t.driver = {\n\t\t.name = \"clk-starfive-jh7110-pll\",\n\t\t.of_match_table = jh7110_pll_match,\n\t},\n};\nbuiltin_platform_driver_probe(jh7110_pll_driver, jh7110_pll_probe);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}