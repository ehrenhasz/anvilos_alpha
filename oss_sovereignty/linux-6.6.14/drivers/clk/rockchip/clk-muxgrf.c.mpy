{
  "module_name": "clk-muxgrf.c",
  "hash_id": "f6b8a76d34fee688d930e31186730586ecc0f197c0b1f641a7c6bc26e0d5970d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/rockchip/clk-muxgrf.c",
  "human_readable_source": "\n\n#include <linux/slab.h>\n#include <linux/bitops.h>\n#include <linux/regmap.h>\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include \"clk.h\"\n\nstruct rockchip_muxgrf_clock {\n\tstruct clk_hw\t\thw;\n\tstruct regmap\t\t*regmap;\n\tu32\t\t\treg;\n\tu32\t\t\tshift;\n\tu32\t\t\twidth;\n\tint\t\t\tflags;\n};\n\n#define to_muxgrf_clock(_hw) container_of(_hw, struct rockchip_muxgrf_clock, hw)\n\nstatic u8 rockchip_muxgrf_get_parent(struct clk_hw *hw)\n{\n\tstruct rockchip_muxgrf_clock *mux = to_muxgrf_clock(hw);\n\tunsigned int mask = GENMASK(mux->width - 1, 0);\n\tunsigned int val;\n\n\tregmap_read(mux->regmap, mux->reg, &val);\n\n\tval >>= mux->shift;\n\tval &= mask;\n\n\treturn val;\n}\n\nstatic int rockchip_muxgrf_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct rockchip_muxgrf_clock *mux = to_muxgrf_clock(hw);\n\tunsigned int mask = GENMASK(mux->width + mux->shift - 1, mux->shift);\n\tunsigned int val;\n\n\tval = index;\n\tval <<= mux->shift;\n\n\tif (mux->flags & CLK_MUX_HIWORD_MASK)\n\t\treturn regmap_write(mux->regmap, mux->reg, val | (mask << 16));\n\telse\n\t\treturn regmap_update_bits(mux->regmap, mux->reg, mask, val);\n}\n\nstatic const struct clk_ops rockchip_muxgrf_clk_ops = {\n\t.get_parent = rockchip_muxgrf_get_parent,\n\t.set_parent = rockchip_muxgrf_set_parent,\n\t.determine_rate = __clk_mux_determine_rate,\n};\n\nstruct clk *rockchip_clk_register_muxgrf(const char *name,\n\t\t\t\tconst char *const *parent_names, u8 num_parents,\n\t\t\t\tint flags, struct regmap *regmap, int reg,\n\t\t\t\tint shift, int width, int mux_flags)\n{\n\tstruct rockchip_muxgrf_clock *muxgrf_clock;\n\tstruct clk_init_data init;\n\tstruct clk *clk;\n\n\tif (IS_ERR(regmap)) {\n\t\tpr_err(\"%s: regmap not available\\n\", __func__);\n\t\treturn ERR_PTR(-ENOTSUPP);\n\t}\n\n\tmuxgrf_clock = kmalloc(sizeof(*muxgrf_clock), GFP_KERNEL);\n\tif (!muxgrf_clock)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit.name = name;\n\tinit.flags = flags;\n\tinit.num_parents = num_parents;\n\tinit.parent_names = parent_names;\n\tinit.ops = &rockchip_muxgrf_clk_ops;\n\n\tmuxgrf_clock->hw.init = &init;\n\tmuxgrf_clock->regmap = regmap;\n\tmuxgrf_clock->reg = reg;\n\tmuxgrf_clock->shift = shift;\n\tmuxgrf_clock->width = width;\n\tmuxgrf_clock->flags = mux_flags;\n\n\tclk = clk_register(NULL, &muxgrf_clock->hw);\n\tif (IS_ERR(clk))\n\t\tkfree(muxgrf_clock);\n\n\treturn clk;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}