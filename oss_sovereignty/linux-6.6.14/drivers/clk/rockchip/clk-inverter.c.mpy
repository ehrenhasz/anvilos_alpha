{
  "module_name": "clk-inverter.c",
  "hash_id": "84c25c01b7d2f26ae228d97d105670e431915329f61dcb8f8696741513b648c4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/rockchip/clk-inverter.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <linux/spinlock.h>\n#include <linux/kernel.h>\n#include \"clk.h\"\n\nstruct rockchip_inv_clock {\n\tstruct clk_hw\thw;\n\tvoid __iomem\t*reg;\n\tint\t\tshift;\n\tint\t\tflags;\n\tspinlock_t\t*lock;\n};\n\n#define to_inv_clock(_hw) container_of(_hw, struct rockchip_inv_clock, hw)\n\n#define INVERTER_MASK 0x1\n\nstatic int rockchip_inv_get_phase(struct clk_hw *hw)\n{\n\tstruct rockchip_inv_clock *inv_clock = to_inv_clock(hw);\n\tu32 val;\n\n\tval = readl(inv_clock->reg) >> inv_clock->shift;\n\tval &= INVERTER_MASK;\n\treturn val ? 180 : 0;\n}\n\nstatic int rockchip_inv_set_phase(struct clk_hw *hw, int degrees)\n{\n\tstruct rockchip_inv_clock *inv_clock = to_inv_clock(hw);\n\tu32 val;\n\n\tif (degrees % 180 == 0) {\n\t\tval = !!degrees;\n\t} else {\n\t\tpr_err(\"%s: unsupported phase %d for %s\\n\",\n\t\t       __func__, degrees, clk_hw_get_name(hw));\n\t\treturn -EINVAL;\n\t}\n\n\tif (inv_clock->flags & ROCKCHIP_INVERTER_HIWORD_MASK) {\n\t\twritel(HIWORD_UPDATE(val, INVERTER_MASK, inv_clock->shift),\n\t\t       inv_clock->reg);\n\t} else {\n\t\tunsigned long flags;\n\t\tu32 reg;\n\n\t\tspin_lock_irqsave(inv_clock->lock, flags);\n\n\t\treg = readl(inv_clock->reg);\n\t\treg &= ~BIT(inv_clock->shift);\n\t\treg |= val;\n\t\twritel(reg, inv_clock->reg);\n\n\t\tspin_unlock_irqrestore(inv_clock->lock, flags);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct clk_ops rockchip_inv_clk_ops = {\n\t.get_phase\t= rockchip_inv_get_phase,\n\t.set_phase\t= rockchip_inv_set_phase,\n};\n\nstruct clk *rockchip_clk_register_inverter(const char *name,\n\t\t\t\tconst char *const *parent_names, u8 num_parents,\n\t\t\t\tvoid __iomem *reg, int shift, int flags,\n\t\t\t\tspinlock_t *lock)\n{\n\tstruct clk_init_data init;\n\tstruct rockchip_inv_clock *inv_clock;\n\tstruct clk *clk;\n\n\tinv_clock = kmalloc(sizeof(*inv_clock), GFP_KERNEL);\n\tif (!inv_clock)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit.name = name;\n\tinit.num_parents = num_parents;\n\tinit.flags = CLK_SET_RATE_PARENT;\n\tinit.parent_names = parent_names;\n\tinit.ops = &rockchip_inv_clk_ops;\n\n\tinv_clock->hw.init = &init;\n\tinv_clock->reg = reg;\n\tinv_clock->shift = shift;\n\tinv_clock->flags = flags;\n\tinv_clock->lock = lock;\n\n\tclk = clk_register(NULL, &inv_clock->hw);\n\tif (IS_ERR(clk))\n\t\tkfree(inv_clock);\n\n\treturn clk;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}