{
  "module_name": "clk-uniphier-mux.c",
  "hash_id": "4f770213028a721bad68e6bd1f64c00c804212065f9efff39551759326ba9bfe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/uniphier/clk-uniphier-mux.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/device.h>\n#include <linux/regmap.h>\n\n#include \"clk-uniphier.h\"\n\nstruct uniphier_clk_mux {\n\tstruct clk_hw hw;\n\tstruct regmap *regmap;\n\tunsigned int reg;\n\tconst unsigned int *masks;\n\tconst unsigned int *vals;\n};\n\n#define to_uniphier_clk_mux(_hw) container_of(_hw, struct uniphier_clk_mux, hw)\n\nstatic int uniphier_clk_mux_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct uniphier_clk_mux *mux = to_uniphier_clk_mux(hw);\n\n\treturn regmap_write_bits(mux->regmap, mux->reg, mux->masks[index],\n\t\t\t\t mux->vals[index]);\n}\n\nstatic u8 uniphier_clk_mux_get_parent(struct clk_hw *hw)\n{\n\tstruct uniphier_clk_mux *mux = to_uniphier_clk_mux(hw);\n\tunsigned int num_parents = clk_hw_get_num_parents(hw);\n\tint ret;\n\tunsigned int val;\n\tunsigned int i;\n\n\tret = regmap_read(mux->regmap, mux->reg, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < num_parents; i++)\n\t\tif ((mux->masks[i] & val) == mux->vals[i])\n\t\t\treturn i;\n\n\treturn -EINVAL;\n}\n\nstatic const struct clk_ops uniphier_clk_mux_ops = {\n\t.determine_rate = __clk_mux_determine_rate,\n\t.set_parent = uniphier_clk_mux_set_parent,\n\t.get_parent = uniphier_clk_mux_get_parent,\n};\n\nstruct clk_hw *uniphier_clk_register_mux(struct device *dev,\n\t\t\t\t\t struct regmap *regmap,\n\t\t\t\t\t const char *name,\n\t\t\t\tconst struct uniphier_clk_mux_data *data)\n{\n\tstruct uniphier_clk_mux *mux;\n\tstruct clk_init_data init;\n\tint ret;\n\n\tmux = devm_kzalloc(dev, sizeof(*mux), GFP_KERNEL);\n\tif (!mux)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit.name = name;\n\tinit.ops = &uniphier_clk_mux_ops;\n\tinit.flags = CLK_SET_RATE_PARENT;\n\tinit.parent_names = data->parent_names;\n\tinit.num_parents = data->num_parents;\n\n\tmux->regmap = regmap;\n\tmux->reg = data->reg;\n\tmux->masks = data->masks;\n\tmux->vals = data->vals;\n\tmux->hw.init = &init;\n\n\tret = devm_clk_hw_register(dev, &mux->hw);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\treturn &mux->hw;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}