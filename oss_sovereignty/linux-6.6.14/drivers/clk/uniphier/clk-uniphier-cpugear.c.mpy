{
  "module_name": "clk-uniphier-cpugear.c",
  "hash_id": "900602e95bc8672433cbbaca9dd441ecc4d2a1ee43d94d648c94871b19395cf9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/uniphier/clk-uniphier-cpugear.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/device.h>\n#include <linux/regmap.h>\n\n#include \"clk-uniphier.h\"\n\n#define UNIPHIER_CLK_CPUGEAR_STAT\t0\t \n#define UNIPHIER_CLK_CPUGEAR_SET\t4\t \n#define UNIPHIER_CLK_CPUGEAR_UPD\t8\t \n#define   UNIPHIER_CLK_CPUGEAR_UPD_BIT\tBIT(0)\n\nstruct uniphier_clk_cpugear {\n\tstruct clk_hw hw;\n\tstruct regmap *regmap;\n\tunsigned int regbase;\n\tunsigned int mask;\n};\n\n#define to_uniphier_clk_cpugear(_hw) \\\n\t\t\tcontainer_of(_hw, struct uniphier_clk_cpugear, hw)\n\nstatic int uniphier_clk_cpugear_set_parent(struct clk_hw *hw, u8 index)\n{\n\tstruct uniphier_clk_cpugear *gear = to_uniphier_clk_cpugear(hw);\n\tint ret;\n\tunsigned int val;\n\n\tret = regmap_write_bits(gear->regmap,\n\t\t\t\tgear->regbase + UNIPHIER_CLK_CPUGEAR_SET,\n\t\t\t\tgear->mask, index);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_write_bits(gear->regmap,\n\t\t\t\tgear->regbase + UNIPHIER_CLK_CPUGEAR_UPD,\n\t\t\t\tUNIPHIER_CLK_CPUGEAR_UPD_BIT,\n\t\t\t\tUNIPHIER_CLK_CPUGEAR_UPD_BIT);\n\tif (ret)\n\t\treturn ret;\n\n\treturn regmap_read_poll_timeout(gear->regmap,\n\t\t\t\tgear->regbase + UNIPHIER_CLK_CPUGEAR_UPD,\n\t\t\t\tval, !(val & UNIPHIER_CLK_CPUGEAR_UPD_BIT),\n\t\t\t\t0, 1);\n}\n\nstatic u8 uniphier_clk_cpugear_get_parent(struct clk_hw *hw)\n{\n\tstruct uniphier_clk_cpugear *gear = to_uniphier_clk_cpugear(hw);\n\tint num_parents = clk_hw_get_num_parents(hw);\n\tint ret;\n\tunsigned int val;\n\n\tret = regmap_read(gear->regmap,\n\t\t\t  gear->regbase + UNIPHIER_CLK_CPUGEAR_STAT, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tval &= gear->mask;\n\n\treturn val < num_parents ? val : -EINVAL;\n}\n\nstatic const struct clk_ops uniphier_clk_cpugear_ops = {\n\t.determine_rate = __clk_mux_determine_rate,\n\t.set_parent = uniphier_clk_cpugear_set_parent,\n\t.get_parent = uniphier_clk_cpugear_get_parent,\n};\n\nstruct clk_hw *uniphier_clk_register_cpugear(struct device *dev,\n\t\t\t\t\t struct regmap *regmap,\n\t\t\t\t\t const char *name,\n\t\t\t\tconst struct uniphier_clk_cpugear_data *data)\n{\n\tstruct uniphier_clk_cpugear *gear;\n\tstruct clk_init_data init;\n\tint ret;\n\n\tgear = devm_kzalloc(dev, sizeof(*gear), GFP_KERNEL);\n\tif (!gear)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tinit.name = name;\n\tinit.ops = &uniphier_clk_cpugear_ops;\n\tinit.flags = CLK_SET_RATE_PARENT;\n\tinit.parent_names = data->parent_names;\n\tinit.num_parents = data->num_parents;\n\n\tgear->regmap = regmap;\n\tgear->regbase = data->regbase;\n\tgear->mask = data->mask;\n\tgear->hw.init = &init;\n\n\tret = devm_clk_hw_register(dev, &gear->hw);\n\tif (ret)\n\t\treturn ERR_PTR(ret);\n\n\treturn &gear->hw;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}