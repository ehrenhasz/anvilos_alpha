{
  "module_name": "clk-mt6795-infracfg.c",
  "hash_id": "9ecd44c9dd5873806fd3feba1b206089953ce47867cdb5fa39492cf0d278b06e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/mediatek/clk-mt6795-infracfg.c",
  "human_readable_source": "\n \n\n#include <dt-bindings/clock/mediatek,mt6795-clk.h>\n#include <dt-bindings/reset/mediatek,mt6795-resets.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include \"clk-cpumux.h\"\n#include \"clk-gate.h\"\n#include \"clk-mtk.h\"\n#include \"reset.h\"\n\n#define GATE_ICG(_id, _name, _parent, _shift)\t\t\t\\\n\t\tGATE_MTK(_id, _name, _parent, &infra_cg_regs,\t\\\n\t\t\t _shift, &mtk_clk_gate_ops_no_setclr)\n\nstatic const struct mtk_gate_regs infra_cg_regs = {\n\t.set_ofs = 0x0040,\n\t.clr_ofs = 0x0044,\n\t.sta_ofs = 0x0048,\n};\n\nstatic const char * const ca53_c0_parents[] = {\n\t\"clk26m\",\n\t\"armca53pll\",\n\t\"mainpll\",\n\t\"univpll\"\n};\n\nstatic const char * const ca53_c1_parents[] = {\n\t\"clk26m\",\n\t\"armca53pll\",\n\t\"mainpll\",\n\t\"univpll\"\n};\n\nstatic const struct mtk_composite cpu_muxes[] = {\n\tMUX(CLK_INFRA_CA53_C0_SEL, \"infra_ca53_c0_sel\", ca53_c0_parents, 0x00, 0, 2),\n\tMUX(CLK_INFRA_CA53_C1_SEL, \"infra_ca53_c1_sel\", ca53_c1_parents, 0x00, 2, 2),\n};\n\nstatic const struct mtk_gate infra_gates[] = {\n\tGATE_ICG(CLK_INFRA_DBGCLK, \"infra_dbgclk\", \"axi_sel\", 0),\n\tGATE_ICG(CLK_INFRA_SMI, \"infra_smi\", \"mm_sel\", 1),\n\tGATE_ICG(CLK_INFRA_AUDIO, \"infra_audio\", \"aud_intbus_sel\", 5),\n\tGATE_ICG(CLK_INFRA_GCE, \"infra_gce\", \"axi_sel\", 6),\n\tGATE_ICG(CLK_INFRA_L2C_SRAM, \"infra_l2c_sram\", \"axi_sel\", 7),\n\tGATE_ICG(CLK_INFRA_M4U, \"infra_m4u\", \"mem_sel\", 8),\n\tGATE_ICG(CLK_INFRA_MD1MCU, \"infra_md1mcu\", \"clk26m\", 9),\n\tGATE_ICG(CLK_INFRA_MD1BUS, \"infra_md1bus\", \"axi_sel\", 10),\n\tGATE_ICG(CLK_INFRA_MD1DBB, \"infra_dbb\", \"axi_sel\", 11),\n\tGATE_ICG(CLK_INFRA_DEVICE_APC, \"infra_devapc\", \"clk26m\", 12),\n\tGATE_ICG(CLK_INFRA_TRNG, \"infra_trng\", \"axi_sel\", 13),\n\tGATE_ICG(CLK_INFRA_MD1LTE, \"infra_md1lte\", \"axi_sel\", 14),\n\tGATE_ICG(CLK_INFRA_CPUM, \"infra_cpum\", \"cpum_ck\", 15),\n\tGATE_ICG(CLK_INFRA_KP, \"infra_kp\", \"axi_sel\", 16),\n};\n\nstatic u16 infra_ao_rst_ofs[] = { 0x30, 0x34 };\n\nstatic u16 infra_ao_idx_map[] = {\n\t[MT6795_INFRA_RST0_SCPSYS_RST]    = 0 * RST_NR_PER_BANK + 5,\n\t[MT6795_INFRA_RST0_PMIC_WRAP_RST] = 0 * RST_NR_PER_BANK + 7,\n\t[MT6795_INFRA_RST1_MIPI_DSI_RST]  = 1 * RST_NR_PER_BANK + 4,\n\t[MT6795_INFRA_RST1_MIPI_CSI_RST]  = 1 * RST_NR_PER_BANK + 7,\n\t[MT6795_INFRA_RST1_MM_IOMMU_RST]  = 1 * RST_NR_PER_BANK + 15,\n};\n\nstatic const struct mtk_clk_rst_desc clk_rst_desc = {\n\t.version = MTK_RST_SET_CLR,\n\t.rst_bank_ofs = infra_ao_rst_ofs,\n\t.rst_bank_nr = ARRAY_SIZE(infra_ao_rst_ofs),\n\t.rst_idx_map = infra_ao_idx_map,\n\t.rst_idx_map_nr = ARRAY_SIZE(infra_ao_idx_map),\n};\n\nstatic const struct of_device_id of_match_clk_mt6795_infracfg[] = {\n\t{ .compatible = \"mediatek,mt6795-infracfg\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, of_match_clk_mt6795_infracfg);\n\nstatic int clk_mt6795_infracfg_probe(struct platform_device *pdev)\n{\n\tstruct clk_hw_onecell_data *clk_data;\n\tstruct device_node *node = pdev->dev.of_node;\n\tvoid __iomem *base;\n\tint ret;\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tclk_data = mtk_alloc_clk_data(CLK_INFRA_NR_CLK);\n\tif (!clk_data)\n\t\treturn -ENOMEM;\n\n\tret = mtk_register_reset_controller_with_dev(&pdev->dev, &clk_rst_desc);\n\tif (ret)\n\t\tgoto free_clk_data;\n\n\tret = mtk_clk_register_gates(&pdev->dev, node, infra_gates,\n\t\t\t\t     ARRAY_SIZE(infra_gates), clk_data);\n\tif (ret)\n\t\tgoto free_clk_data;\n\n\tret = mtk_clk_register_cpumuxes(&pdev->dev, node, cpu_muxes,\n\t\t\t\t\tARRAY_SIZE(cpu_muxes), clk_data);\n\tif (ret)\n\t\tgoto unregister_gates;\n\n\tret = of_clk_add_hw_provider(node, of_clk_hw_onecell_get, clk_data);\n\tif (ret)\n\t\tgoto unregister_cpumuxes;\n\n\treturn 0;\n\nunregister_cpumuxes:\n\tmtk_clk_unregister_cpumuxes(cpu_muxes, ARRAY_SIZE(cpu_muxes), clk_data);\nunregister_gates:\n\tmtk_clk_unregister_gates(infra_gates, ARRAY_SIZE(infra_gates), clk_data);\nfree_clk_data:\n\tmtk_free_clk_data(clk_data);\n\treturn ret;\n}\n\nstatic void clk_mt6795_infracfg_remove(struct platform_device *pdev)\n{\n\tstruct device_node *node = pdev->dev.of_node;\n\tstruct clk_hw_onecell_data *clk_data = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(node);\n\tmtk_clk_unregister_cpumuxes(cpu_muxes, ARRAY_SIZE(cpu_muxes), clk_data);\n\tmtk_clk_unregister_gates(infra_gates, ARRAY_SIZE(infra_gates), clk_data);\n\tmtk_free_clk_data(clk_data);\n}\n\nstatic struct platform_driver clk_mt6795_infracfg_drv = {\n\t.driver = {\n\t\t.name = \"clk-mt6795-infracfg\",\n\t\t.of_match_table = of_match_clk_mt6795_infracfg,\n\t},\n\t.probe = clk_mt6795_infracfg_probe,\n\t.remove_new = clk_mt6795_infracfg_remove,\n};\nmodule_platform_driver(clk_mt6795_infracfg_drv);\n\nMODULE_DESCRIPTION(\"MediaTek MT6795 infracfg clocks driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}