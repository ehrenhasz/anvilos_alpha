{
  "module_name": "clk-mt7629-eth.c",
  "hash_id": "e2b2ffe658e2b332d4d6589b2149b9d5483796fdf79436ea54c51a2bf1a5bf8b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/mediatek/clk-mt7629-eth.c",
  "human_readable_source": "\n \n\n#include <linux/clk-provider.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n\n#include \"clk-mtk.h\"\n#include \"clk-gate.h\"\n\n#include <dt-bindings/clock/mt7629-clk.h>\n\n#define GATE_ETH(_id, _name, _parent, _shift)\t\t\t\\\n\tGATE_MTK(_id, _name, _parent, &eth_cg_regs, _shift, &mtk_clk_gate_ops_no_setclr_inv)\n\nstatic const struct mtk_gate_regs eth_cg_regs = {\n\t.set_ofs = 0x30,\n\t.clr_ofs = 0x30,\n\t.sta_ofs = 0x30,\n};\n\nstatic const struct mtk_gate eth_clks[] = {\n\tGATE_ETH(CLK_ETH_FE_EN, \"eth_fe_en\", \"eth2pll\", 6),\n\tGATE_ETH(CLK_ETH_GP2_EN, \"eth_gp2_en\", \"txclk_src_pre\", 7),\n\tGATE_ETH(CLK_ETH_GP1_EN, \"eth_gp1_en\", \"txclk_src_pre\", 8),\n\tGATE_ETH(CLK_ETH_GP0_EN, \"eth_gp0_en\", \"txclk_src_pre\", 9),\n\tGATE_ETH(CLK_ETH_ESW_EN, \"eth_esw_en\", \"eth_500m\", 16),\n};\n\nstatic const struct mtk_gate_regs sgmii_cg_regs = {\n\t.set_ofs = 0xE4,\n\t.clr_ofs = 0xE4,\n\t.sta_ofs = 0xE4,\n};\n\n#define GATE_SGMII(_id, _name, _parent, _shift)\t\t\t\\\n\tGATE_MTK(_id, _name, _parent, &sgmii_cg_regs, _shift, &mtk_clk_gate_ops_no_setclr_inv)\n\nstatic const struct mtk_gate sgmii_clks[2][4] = {\n\t{\n\t\tGATE_SGMII(CLK_SGMII_TX_EN, \"sgmii_tx_en\",\n\t\t\t   \"ssusb_tx250m\", 2),\n\t\tGATE_SGMII(CLK_SGMII_RX_EN, \"sgmii_rx_en\",\n\t\t\t   \"ssusb_eq_rx250m\", 3),\n\t\tGATE_SGMII(CLK_SGMII_CDR_REF, \"sgmii_cdr_ref\",\n\t\t\t   \"ssusb_cdr_ref\", 4),\n\t\tGATE_SGMII(CLK_SGMII_CDR_FB, \"sgmii_cdr_fb\",\n\t\t\t   \"ssusb_cdr_fb\", 5),\n\t}, {\n\t\tGATE_SGMII(CLK_SGMII_TX_EN, \"sgmii_tx_en1\",\n\t\t\t   \"ssusb_tx250m\", 2),\n\t\tGATE_SGMII(CLK_SGMII_RX_EN, \"sgmii_rx_en1\",\n\t\t\t   \"ssusb_eq_rx250m\", 3),\n\t\tGATE_SGMII(CLK_SGMII_CDR_REF, \"sgmii_cdr_ref1\",\n\t\t\t   \"ssusb_cdr_ref\", 4),\n\t\tGATE_SGMII(CLK_SGMII_CDR_FB, \"sgmii_cdr_fb1\",\n\t\t\t   \"ssusb_cdr_fb\", 5),\n\t}\n};\n\nstatic u16 rst_ofs[] = { 0x34, };\n\nstatic const struct mtk_clk_rst_desc clk_rst_desc = {\n\t.version = MTK_RST_SIMPLE,\n\t.rst_bank_ofs = rst_ofs,\n\t.rst_bank_nr = ARRAY_SIZE(rst_ofs),\n};\n\nstatic int clk_mt7629_ethsys_init(struct platform_device *pdev)\n{\n\tstruct clk_hw_onecell_data *clk_data;\n\tstruct device_node *node = pdev->dev.of_node;\n\tint r;\n\n\tclk_data = mtk_alloc_clk_data(CLK_ETH_NR_CLK);\n\tif (!clk_data)\n\t\treturn -ENOMEM;\n\n\tmtk_clk_register_gates(&pdev->dev, node, eth_clks,\n\t\t\t       CLK_ETH_NR_CLK, clk_data);\n\n\tr = of_clk_add_hw_provider(node, of_clk_hw_onecell_get, clk_data);\n\tif (r)\n\t\tdev_err(&pdev->dev,\n\t\t\t\"could not register clock provider: %s: %d\\n\",\n\t\t\tpdev->name, r);\n\n\tmtk_register_reset_controller_with_dev(&pdev->dev, &clk_rst_desc);\n\n\treturn r;\n}\n\nstatic int clk_mt7629_sgmiisys_init(struct platform_device *pdev)\n{\n\tstruct clk_hw_onecell_data *clk_data;\n\tstruct device_node *node = pdev->dev.of_node;\n\tstatic int id;\n\tint r;\n\n\tclk_data = mtk_alloc_clk_data(CLK_SGMII_NR_CLK);\n\tif (!clk_data)\n\t\treturn -ENOMEM;\n\n\tmtk_clk_register_gates(&pdev->dev, node, sgmii_clks[id++],\n\t\t\t       CLK_SGMII_NR_CLK, clk_data);\n\n\tr = of_clk_add_hw_provider(node, of_clk_hw_onecell_get, clk_data);\n\tif (r)\n\t\tdev_err(&pdev->dev,\n\t\t\t\"could not register clock provider: %s: %d\\n\",\n\t\t\tpdev->name, r);\n\n\treturn r;\n}\n\nstatic const struct of_device_id of_match_clk_mt7629_eth[] = {\n\t{\n\t\t.compatible = \"mediatek,mt7629-ethsys\",\n\t\t.data = clk_mt7629_ethsys_init,\n\t}, {\n\t\t.compatible = \"mediatek,mt7629-sgmiisys\",\n\t\t.data = clk_mt7629_sgmiisys_init,\n\t}, {\n\t\t \n\t}\n};\nMODULE_DEVICE_TABLE(of, of_match_clk_mt7629_eth);\n\nstatic int clk_mt7629_eth_probe(struct platform_device *pdev)\n{\n\tint (*clk_init)(struct platform_device *);\n\tint r;\n\n\tclk_init = of_device_get_match_data(&pdev->dev);\n\tif (!clk_init)\n\t\treturn -EINVAL;\n\n\tr = clk_init(pdev);\n\tif (r)\n\t\tdev_err(&pdev->dev,\n\t\t\t\"could not register clock provider: %s: %d\\n\",\n\t\t\tpdev->name, r);\n\n\treturn r;\n}\n\nstatic struct platform_driver clk_mt7629_eth_drv = {\n\t.probe = clk_mt7629_eth_probe,\n\t.driver = {\n\t\t.name = \"clk-mt7629-eth\",\n\t\t.of_match_table = of_match_clk_mt7629_eth,\n\t},\n};\n\nbuiltin_platform_driver(clk_mt7629_eth_drv);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}