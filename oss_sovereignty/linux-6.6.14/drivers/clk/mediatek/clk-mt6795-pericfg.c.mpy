{
  "module_name": "clk-mt6795-pericfg.c",
  "hash_id": "a99de5d938a7b07aaf5ae936e6e3dd77ae0cbf25693a901879a3b901a90c6e1e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/mediatek/clk-mt6795-pericfg.c",
  "human_readable_source": "\n \n\n#include <dt-bindings/clock/mediatek,mt6795-clk.h>\n#include <dt-bindings/reset/mediatek,mt6795-resets.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include \"clk-gate.h\"\n#include \"clk-mtk.h\"\n#include \"reset.h\"\n\n#define GATE_PERI(_id, _name, _parent, _shift)\t\t\t\\\n\t\tGATE_MTK(_id, _name, _parent, &peri_cg_regs,\t\\\n\t\t\t _shift, &mtk_clk_gate_ops_setclr)\n\nstatic DEFINE_SPINLOCK(mt6795_peri_clk_lock);\n\nstatic const struct mtk_gate_regs peri_cg_regs = {\n\t.set_ofs = 0x0008,\n\t.clr_ofs = 0x0010,\n\t.sta_ofs = 0x0018,\n};\n\nstatic const char * const uart_ck_sel_parents[] = {\n\t\"clk26m\",\n\t\"uart_sel\",\n};\n\nstatic const struct mtk_composite peri_clks[] = {\n\tMUX(CLK_PERI_UART0_SEL, \"uart0_ck_sel\", uart_ck_sel_parents, 0x40c, 0, 1),\n\tMUX(CLK_PERI_UART1_SEL, \"uart1_ck_sel\", uart_ck_sel_parents, 0x40c, 1, 1),\n\tMUX(CLK_PERI_UART2_SEL, \"uart2_ck_sel\", uart_ck_sel_parents, 0x40c, 2, 1),\n\tMUX(CLK_PERI_UART3_SEL, \"uart3_ck_sel\", uart_ck_sel_parents, 0x40c, 3, 1),\n};\n\nstatic const struct mtk_gate peri_gates[] = {\n\tGATE_PERI(CLK_PERI_NFI, \"peri_nfi\", \"axi_sel\", 0),\n\tGATE_PERI(CLK_PERI_THERM, \"peri_therm\", \"axi_sel\", 1),\n\tGATE_PERI(CLK_PERI_PWM1, \"peri_pwm1\", \"axi_sel\", 2),\n\tGATE_PERI(CLK_PERI_PWM2, \"peri_pwm2\", \"axi_sel\", 3),\n\tGATE_PERI(CLK_PERI_PWM3, \"peri_pwm3\", \"axi_sel\", 4),\n\tGATE_PERI(CLK_PERI_PWM4, \"peri_pwm4\", \"axi_sel\", 5),\n\tGATE_PERI(CLK_PERI_PWM5, \"peri_pwm5\", \"axi_sel\", 6),\n\tGATE_PERI(CLK_PERI_PWM6, \"peri_pwm6\", \"axi_sel\", 7),\n\tGATE_PERI(CLK_PERI_PWM7, \"peri_pwm7\", \"axi_sel\", 8),\n\tGATE_PERI(CLK_PERI_PWM, \"peri_pwm\", \"axi_sel\", 9),\n\tGATE_PERI(CLK_PERI_USB0, \"peri_usb0\", \"usb30_sel\", 10),\n\tGATE_PERI(CLK_PERI_USB1, \"peri_usb1\", \"usb20_sel\", 11),\n\tGATE_PERI(CLK_PERI_AP_DMA, \"peri_ap_dma\", \"axi_sel\", 12),\n\tGATE_PERI(CLK_PERI_MSDC30_0, \"peri_msdc30_0\", \"msdc50_0_sel\", 13),\n\tGATE_PERI(CLK_PERI_MSDC30_1, \"peri_msdc30_1\", \"msdc30_1_sel\", 14),\n\tGATE_PERI(CLK_PERI_MSDC30_2, \"peri_msdc30_2\", \"msdc30_2_sel\", 15),\n\tGATE_PERI(CLK_PERI_MSDC30_3, \"peri_msdc30_3\", \"msdc30_3_sel\", 16),\n\tGATE_PERI(CLK_PERI_NLI_ARB, \"peri_nli_arb\", \"axi_sel\", 17),\n\tGATE_PERI(CLK_PERI_IRDA, \"peri_irda\", \"irda_sel\", 18),\n\tGATE_PERI(CLK_PERI_UART0, \"peri_uart0\", \"axi_sel\", 19),\n\tGATE_PERI(CLK_PERI_UART1, \"peri_uart1\", \"axi_sel\", 20),\n\tGATE_PERI(CLK_PERI_UART2, \"peri_uart2\", \"axi_sel\", 21),\n\tGATE_PERI(CLK_PERI_UART3, \"peri_uart3\", \"axi_sel\", 22),\n\tGATE_PERI(CLK_PERI_I2C0, \"peri_i2c0\", \"axi_sel\", 23),\n\tGATE_PERI(CLK_PERI_I2C1, \"peri_i2c1\", \"axi_sel\", 24),\n\tGATE_PERI(CLK_PERI_I2C2, \"peri_i2c2\", \"axi_sel\", 25),\n\tGATE_PERI(CLK_PERI_I2C3, \"peri_i2c3\", \"axi_sel\", 26),\n\tGATE_PERI(CLK_PERI_I2C4, \"peri_i2c4\", \"axi_sel\", 27),\n\tGATE_PERI(CLK_PERI_AUXADC, \"peri_auxadc\", \"clk26m\", 28),\n\tGATE_PERI(CLK_PERI_SPI0, \"peri_spi0\", \"spi_sel\", 29),\n};\n\nstatic u16 peri_rst_ofs[] = { 0x0 };\n\nstatic u16 peri_idx_map[] = {\n\t[MT6795_PERI_NFI_SW_RST]   = 14,\n\t[MT6795_PERI_THERM_SW_RST] = 16,\n\t[MT6795_PERI_MSDC1_SW_RST] = 20,\n};\n\nstatic const struct mtk_clk_rst_desc clk_rst_desc = {\n\t.version = MTK_RST_SIMPLE,\n\t.rst_bank_ofs = peri_rst_ofs,\n\t.rst_bank_nr = ARRAY_SIZE(peri_rst_ofs),\n\t.rst_idx_map = peri_idx_map,\n\t.rst_idx_map_nr = ARRAY_SIZE(peri_idx_map),\n};\n\nstatic const struct of_device_id of_match_clk_mt6795_pericfg[] = {\n\t{ .compatible = \"mediatek,mt6795-pericfg\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, of_match_clk_mt6795_pericfg);\n\nstatic int clk_mt6795_pericfg_probe(struct platform_device *pdev)\n{\n\tstruct clk_hw_onecell_data *clk_data;\n\tstruct device_node *node = pdev->dev.of_node;\n\tvoid __iomem *base;\n\tint ret;\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tclk_data = mtk_alloc_clk_data(CLK_PERI_NR_CLK);\n\tif (!clk_data)\n\t\treturn -ENOMEM;\n\n\tret = mtk_register_reset_controller_with_dev(&pdev->dev, &clk_rst_desc);\n\tif (ret)\n\t\tgoto free_clk_data;\n\n\tret = mtk_clk_register_gates(&pdev->dev, node, peri_gates,\n\t\t\t\t     ARRAY_SIZE(peri_gates), clk_data);\n\tif (ret)\n\t\tgoto free_clk_data;\n\n\tret = mtk_clk_register_composites(&pdev->dev, peri_clks,\n\t\t\t\t\t  ARRAY_SIZE(peri_clks), base,\n\t\t\t\t\t  &mt6795_peri_clk_lock, clk_data);\n\tif (ret)\n\t\tgoto unregister_gates;\n\n\tret = of_clk_add_hw_provider(node, of_clk_hw_onecell_get, clk_data);\n\tif (ret)\n\t\tgoto unregister_composites;\n\n\treturn 0;\n\nunregister_composites:\n\tmtk_clk_unregister_composites(peri_clks, ARRAY_SIZE(peri_clks), clk_data);\nunregister_gates:\n\tmtk_clk_unregister_gates(peri_gates, ARRAY_SIZE(peri_gates), clk_data);\nfree_clk_data:\n\tmtk_free_clk_data(clk_data);\n\treturn ret;\n}\n\nstatic void clk_mt6795_pericfg_remove(struct platform_device *pdev)\n{\n\tstruct device_node *node = pdev->dev.of_node;\n\tstruct clk_hw_onecell_data *clk_data = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(node);\n\tmtk_clk_unregister_composites(peri_clks, ARRAY_SIZE(peri_clks), clk_data);\n\tmtk_clk_unregister_gates(peri_gates, ARRAY_SIZE(peri_gates), clk_data);\n\tmtk_free_clk_data(clk_data);\n}\n\nstatic struct platform_driver clk_mt6795_pericfg_drv = {\n\t.driver = {\n\t\t.name = \"clk-mt6795-pericfg\",\n\t\t.of_match_table = of_match_clk_mt6795_pericfg,\n\t},\n\t.probe = clk_mt6795_pericfg_probe,\n\t.remove_new = clk_mt6795_pericfg_remove,\n};\nmodule_platform_driver(clk_mt6795_pericfg_drv);\n\nMODULE_DESCRIPTION(\"MediaTek MT6795 pericfg clocks driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}