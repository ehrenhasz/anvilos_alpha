{
  "module_name": "clk-mt8173-infracfg.c",
  "hash_id": "2dcbbc1347f1a85428cd77517dadbe7f6ce5300578845a4db9c0e238fff63f55",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/mediatek/clk-mt8173-infracfg.c",
  "human_readable_source": "\n \n\n#include <dt-bindings/clock/mt8173-clk.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include \"clk-cpumux.h\"\n#include \"clk-gate.h\"\n#include \"clk-mtk.h\"\n#include \"reset.h\"\n\n#define GATE_ICG(_id, _name, _parent, _shift)\t\t\t\\\n\t\tGATE_MTK(_id, _name, _parent, &infra_cg_regs,\t\\\n\t\t\t _shift, &mtk_clk_gate_ops_setclr)\n\nstatic struct clk_hw_onecell_data *infra_clk_data;\n\nstatic const struct mtk_gate_regs infra_cg_regs = {\n\t.set_ofs = 0x0040,\n\t.clr_ofs = 0x0044,\n\t.sta_ofs = 0x0048,\n};\n\nstatic const char * const ca53_parents[] __initconst = {\n\t\"clk26m\",\n\t\"armca7pll\",\n\t\"mainpll\",\n\t\"univpll\"\n};\n\nstatic const char * const ca72_parents[] __initconst = {\n\t\"clk26m\",\n\t\"armca15pll\",\n\t\"mainpll\",\n\t\"univpll\"\n};\n\nstatic const struct mtk_composite cpu_muxes[] = {\n\tMUX(CLK_INFRA_CA53SEL, \"infra_ca53_sel\", ca53_parents, 0x0000, 0, 2),\n\tMUX(CLK_INFRA_CA72SEL, \"infra_ca72_sel\", ca72_parents, 0x0000, 2, 2),\n};\n\nstatic const struct mtk_fixed_factor infra_early_divs[] = {\n\tFACTOR(CLK_INFRA_CLK_13M, \"clk13m\", \"clk26m\", 1, 2),\n};\n\nstatic const struct mtk_gate infra_gates[] = {\n\tGATE_ICG(CLK_INFRA_DBGCLK, \"infra_dbgclk\", \"axi_sel\", 0),\n\tGATE_ICG(CLK_INFRA_SMI, \"infra_smi\", \"mm_sel\", 1),\n\tGATE_ICG(CLK_INFRA_AUDIO, \"infra_audio\", \"aud_intbus_sel\", 5),\n\tGATE_ICG(CLK_INFRA_GCE, \"infra_gce\", \"axi_sel\", 6),\n\tGATE_ICG(CLK_INFRA_L2C_SRAM, \"infra_l2c_sram\", \"axi_sel\", 7),\n\tGATE_ICG(CLK_INFRA_M4U, \"infra_m4u\", \"mem_sel\", 8),\n\tGATE_ICG(CLK_INFRA_CPUM, \"infra_cpum\", \"cpum_ck\", 15),\n\tGATE_ICG(CLK_INFRA_KP, \"infra_kp\", \"axi_sel\", 16),\n\tGATE_ICG(CLK_INFRA_CEC, \"infra_cec\", \"clk26m\", 18),\n\tGATE_ICG(CLK_INFRA_PMICSPI, \"infra_pmicspi\", \"pmicspi_sel\", 22),\n\tGATE_ICG(CLK_INFRA_PMICWRAP, \"infra_pmicwrap\", \"axi_sel\", 23),\n};\n\nstatic u16 infrasys_rst_ofs[] = { 0x30, 0x34 };\n\nstatic const struct mtk_clk_rst_desc clk_rst_desc = {\n\t.version = MTK_RST_SIMPLE,\n\t.rst_bank_ofs = infrasys_rst_ofs,\n\t.rst_bank_nr = ARRAY_SIZE(infrasys_rst_ofs),\n};\n\nstatic const struct of_device_id of_match_clk_mt8173_infracfg[] = {\n\t{ .compatible = \"mediatek,mt8173-infracfg\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, of_match_clk_mt8173_infracfg);\n\nstatic void clk_mt8173_infra_init_early(struct device_node *node)\n{\n\tint i;\n\n\tinfra_clk_data = mtk_alloc_clk_data(CLK_INFRA_NR_CLK);\n\tif (!infra_clk_data)\n\t\treturn;\n\n\tfor (i = 0; i < CLK_INFRA_NR_CLK; i++)\n\t\tinfra_clk_data->hws[i] = ERR_PTR(-EPROBE_DEFER);\n\n\tmtk_clk_register_factors(infra_early_divs,\n\t\t\t\t ARRAY_SIZE(infra_early_divs), infra_clk_data);\n\n\tof_clk_add_hw_provider(node, of_clk_hw_onecell_get, infra_clk_data);\n}\nCLK_OF_DECLARE_DRIVER(mtk_infrasys, \"mediatek,mt8173-infracfg\",\n\t\t      clk_mt8173_infra_init_early);\n\nstatic int clk_mt8173_infracfg_probe(struct platform_device *pdev)\n{\n\tstruct device_node *node = pdev->dev.of_node;\n\tint r;\n\n\tr = mtk_clk_register_gates(&pdev->dev, node, infra_gates,\n\t\t\t\t   ARRAY_SIZE(infra_gates), infra_clk_data);\n\tif (r)\n\t\treturn r;\n\n\tr = mtk_clk_register_cpumuxes(&pdev->dev, node, cpu_muxes,\n\t\t\t\t      ARRAY_SIZE(cpu_muxes), infra_clk_data);\n\tif (r)\n\t\tgoto unregister_gates;\n\n\tr = of_clk_add_hw_provider(node, of_clk_hw_onecell_get, infra_clk_data);\n\tif (r)\n\t\tgoto unregister_cpumuxes;\n\n\tr = mtk_register_reset_controller_with_dev(&pdev->dev, &clk_rst_desc);\n\tif (r)\n\t\tgoto unregister_clk_hw;\n\n\treturn 0;\n\nunregister_clk_hw:\n\tof_clk_del_provider(node);\nunregister_cpumuxes:\n\tmtk_clk_unregister_cpumuxes(cpu_muxes, ARRAY_SIZE(cpu_muxes), infra_clk_data);\nunregister_gates:\n\tmtk_clk_unregister_gates(infra_gates, ARRAY_SIZE(infra_gates), infra_clk_data);\n\treturn r;\n}\n\nstatic void clk_mt8173_infracfg_remove(struct platform_device *pdev)\n{\n\tstruct device_node *node = pdev->dev.of_node;\n\tstruct clk_hw_onecell_data *clk_data = platform_get_drvdata(pdev);\n\n\tof_clk_del_provider(node);\n\tmtk_clk_unregister_cpumuxes(cpu_muxes, ARRAY_SIZE(cpu_muxes), clk_data);\n\tmtk_clk_unregister_gates(infra_gates, ARRAY_SIZE(infra_gates), clk_data);\n\tmtk_free_clk_data(clk_data);\n}\n\nstatic struct platform_driver clk_mt8173_infracfg_drv = {\n\t.driver = {\n\t\t.name = \"clk-mt8173-infracfg\",\n\t\t.of_match_table = of_match_clk_mt8173_infracfg,\n\t},\n\t.probe = clk_mt8173_infracfg_probe,\n\t.remove_new = clk_mt8173_infracfg_remove,\n};\nmodule_platform_driver(clk_mt8173_infracfg_drv);\n\nMODULE_DESCRIPTION(\"MediaTek MT8173 infracfg clocks driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}