{
  "module_name": "bg2.c",
  "hash_id": "6dc1f4a5d4c7c83b8a9025e33b491e7040f299ca2782c5e0cf9b56b14cc496df",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/berlin/bg2.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/slab.h>\n\n#include <dt-bindings/clock/berlin2.h>\n\n#include \"berlin2-avpll.h\"\n#include \"berlin2-div.h\"\n#include \"berlin2-pll.h\"\n#include \"common.h\"\n\n#define REG_PINMUX0\t\t0x0000\n#define REG_PINMUX1\t\t0x0004\n#define REG_SYSPLLCTL0\t\t0x0014\n#define REG_SYSPLLCTL4\t\t0x0024\n#define REG_MEMPLLCTL0\t\t0x0028\n#define REG_MEMPLLCTL4\t\t0x0038\n#define REG_CPUPLLCTL0\t\t0x003c\n#define REG_CPUPLLCTL4\t\t0x004c\n#define REG_AVPLLCTL0\t\t0x0050\n#define REG_AVPLLCTL31\t\t0x00cc\n#define REG_AVPLLCTL62\t\t0x0148\n#define REG_PLLSTATUS\t\t0x014c\n#define REG_CLKENABLE\t\t0x0150\n#define REG_CLKSELECT0\t\t0x0154\n#define REG_CLKSELECT1\t\t0x0158\n#define REG_CLKSELECT2\t\t0x015c\n#define REG_CLKSELECT3\t\t0x0160\n#define REG_CLKSWITCH0\t\t0x0164\n#define REG_CLKSWITCH1\t\t0x0168\n#define REG_RESET_TRIGGER\t0x0178\n#define REG_RESET_STATUS0\t0x017c\n#define REG_RESET_STATUS1\t0x0180\n#define REG_SW_GENERIC0\t\t0x0184\n#define REG_SW_GENERIC3\t\t0x0190\n#define REG_PRODUCTID\t\t0x01cc\n#define REG_PRODUCTID_EXT\t0x01d0\n#define REG_GFX3DCORE_CLKCTL\t0x022c\n#define REG_GFX3DSYS_CLKCTL\t0x0230\n#define REG_ARC_CLKCTL\t\t0x0234\n#define REG_VIP_CLKCTL\t\t0x0238\n#define REG_SDIO0XIN_CLKCTL\t0x023c\n#define REG_SDIO1XIN_CLKCTL\t0x0240\n#define REG_GFX3DEXTRA_CLKCTL\t0x0244\n#define REG_GFX3D_RESET\t\t0x0248\n#define REG_GC360_CLKCTL\t0x024c\n#define REG_SDIO_DLLMST_CLKCTL\t0x0250\n\n \n\n#define\tMAX_CLKS 41\nstatic struct clk_hw_onecell_data *clk_data;\nstatic DEFINE_SPINLOCK(lock);\nstatic void __iomem *gbase;\n\nenum {\n\tREFCLK, VIDEO_EXT0,\n\tSYSPLL, MEMPLL, CPUPLL,\n\tAVPLL_A1, AVPLL_A2, AVPLL_A3, AVPLL_A4,\n\tAVPLL_A5, AVPLL_A6, AVPLL_A7, AVPLL_A8,\n\tAVPLL_B1, AVPLL_B2, AVPLL_B3, AVPLL_B4,\n\tAVPLL_B5, AVPLL_B6, AVPLL_B7, AVPLL_B8,\n\tAUDIO1_PLL, AUDIO_FAST_PLL,\n\tVIDEO0_PLL, VIDEO0_IN,\n\tVIDEO1_PLL, VIDEO1_IN,\n\tVIDEO2_PLL, VIDEO2_IN,\n};\n\nstatic const char *clk_names[] = {\n\t[REFCLK]\t\t= \"refclk\",\n\t[VIDEO_EXT0]\t\t= \"video_ext0\",\n\t[SYSPLL]\t\t= \"syspll\",\n\t[MEMPLL]\t\t= \"mempll\",\n\t[CPUPLL]\t\t= \"cpupll\",\n\t[AVPLL_A1]\t\t= \"avpll_a1\",\n\t[AVPLL_A2]\t\t= \"avpll_a2\",\n\t[AVPLL_A3]\t\t= \"avpll_a3\",\n\t[AVPLL_A4]\t\t= \"avpll_a4\",\n\t[AVPLL_A5]\t\t= \"avpll_a5\",\n\t[AVPLL_A6]\t\t= \"avpll_a6\",\n\t[AVPLL_A7]\t\t= \"avpll_a7\",\n\t[AVPLL_A8]\t\t= \"avpll_a8\",\n\t[AVPLL_B1]\t\t= \"avpll_b1\",\n\t[AVPLL_B2]\t\t= \"avpll_b2\",\n\t[AVPLL_B3]\t\t= \"avpll_b3\",\n\t[AVPLL_B4]\t\t= \"avpll_b4\",\n\t[AVPLL_B5]\t\t= \"avpll_b5\",\n\t[AVPLL_B6]\t\t= \"avpll_b6\",\n\t[AVPLL_B7]\t\t= \"avpll_b7\",\n\t[AVPLL_B8]\t\t= \"avpll_b8\",\n\t[AUDIO1_PLL]\t\t= \"audio1_pll\",\n\t[AUDIO_FAST_PLL]\t= \"audio_fast_pll\",\n\t[VIDEO0_PLL]\t\t= \"video0_pll\",\n\t[VIDEO0_IN]\t\t= \"video0_in\",\n\t[VIDEO1_PLL]\t\t= \"video1_pll\",\n\t[VIDEO1_IN]\t\t= \"video1_in\",\n\t[VIDEO2_PLL]\t\t= \"video2_pll\",\n\t[VIDEO2_IN]\t\t= \"video2_in\",\n};\n\nstatic const struct berlin2_pll_map bg2_pll_map __initconst = {\n\t.vcodiv\t\t= {10, 15, 20, 25, 30, 40, 50, 60, 80},\n\t.mult\t\t= 10,\n\t.fbdiv_shift\t= 6,\n\t.rfdiv_shift\t= 1,\n\t.divsel_shift\t= 7,\n};\n\nstatic const u8 default_parent_ids[] = {\n\tSYSPLL, AVPLL_B4, AVPLL_A5, AVPLL_B6, AVPLL_B7, SYSPLL\n};\n\nstatic const struct berlin2_div_data bg2_divs[] __initconst = {\n\t{\n\t\t.name = \"sys\",\n\t\t.parent_ids = (const u8 []){\n\t\t\tSYSPLL, AVPLL_B4, AVPLL_B5, AVPLL_B6, AVPLL_B7, SYSPLL\n\t\t},\n\t\t.num_parents = 6,\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 0),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT0, 0),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT0, 3),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH0, 3),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH0, 4),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH0, 5),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = CLK_IGNORE_UNUSED,\n\t},\n\t{\n\t\t.name = \"cpu\",\n\t\t.parent_ids = (const u8 []){\n\t\t\tCPUPLL, MEMPLL, MEMPLL, MEMPLL, MEMPLL\n\t\t},\n\t\t.num_parents = 5,\n\t\t.map = {\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT0, 6),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT0, 9),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH0, 6),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH0, 7),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH0, 8),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"drmfigo\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 16),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT0, 17),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT0, 20),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH0, 12),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH0, 13),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH0, 14),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"cfg\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 1),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT0, 23),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT0, 26),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH0, 15),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH0, 16),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH0, 17),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"gfx\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 4),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT0, 29),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT1, 0),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH0, 18),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH0, 19),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH0, 20),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"zsp\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 5),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT1, 3),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT1, 6),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH0, 21),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH0, 22),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH0, 23),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"perif\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 6),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT1, 9),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT1, 12),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH0, 24),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH0, 25),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH0, 26),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = CLK_IGNORE_UNUSED,\n\t},\n\t{\n\t\t.name = \"pcube\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 2),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT1, 15),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT1, 18),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH0, 27),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH0, 28),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH0, 29),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"vscope\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 3),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT1, 21),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT1, 24),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH0, 30),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH0, 31),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH1, 0),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"nfc_ecc\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 18),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT1, 27),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT2, 0),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH1, 1),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH1, 2),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH1, 3),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"vpp\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 21),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT2, 3),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT2, 6),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH1, 4),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH1, 5),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH1, 6),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"app\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 20),\n\t\t\tBERLIN2_PLL_SELECT(REG_CLKSELECT2, 9),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT2, 12),\n\t\t\tBERLIN2_PLL_SWITCH(REG_CLKSWITCH1, 7),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH1, 8),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH1, 9),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"audio0\",\n\t\t.parent_ids = (const u8 []){ AUDIO_FAST_PLL },\n\t\t.num_parents = 1,\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 22),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT2, 17),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH1, 10),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH1, 11),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"audio2\",\n\t\t.parent_ids = (const u8 []){ AUDIO_FAST_PLL },\n\t\t.num_parents = 1,\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 24),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT2, 20),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH1, 14),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH1, 15),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"audio3\",\n\t\t.parent_ids = (const u8 []){ AUDIO_FAST_PLL },\n\t\t.num_parents = 1,\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 25),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT2, 23),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH1, 16),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH1, 17),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"audio1\",\n\t\t.parent_ids = (const u8 []){ AUDIO1_PLL },\n\t\t.num_parents = 1,\n\t\t.map = {\n\t\t\tBERLIN2_DIV_GATE(REG_CLKENABLE, 23),\n\t\t\tBERLIN2_DIV_SELECT(REG_CLKSELECT3, 0),\n\t\t\tBERLIN2_DIV_SWITCH(REG_CLKSWITCH1, 12),\n\t\t\tBERLIN2_DIV_D3SWITCH(REG_CLKSWITCH1, 13),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"gfx3d_core\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_SINGLE_DIV(REG_GFX3DCORE_CLKCTL),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"gfx3d_sys\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_SINGLE_DIV(REG_GFX3DSYS_CLKCTL),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"arc\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_SINGLE_DIV(REG_ARC_CLKCTL),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"vip\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_SINGLE_DIV(REG_VIP_CLKCTL),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"sdio0xin\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_SINGLE_DIV(REG_SDIO0XIN_CLKCTL),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"sdio1xin\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_SINGLE_DIV(REG_SDIO1XIN_CLKCTL),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"gfx3d_extra\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_SINGLE_DIV(REG_GFX3DEXTRA_CLKCTL),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"gc360\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_SINGLE_DIV(REG_GC360_CLKCTL),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n\t{\n\t\t.name = \"sdio_dllmst\",\n\t\t.parent_ids = default_parent_ids,\n\t\t.num_parents = ARRAY_SIZE(default_parent_ids),\n\t\t.map = {\n\t\t\tBERLIN2_SINGLE_DIV(REG_SDIO_DLLMST_CLKCTL),\n\t\t},\n\t\t.div_flags = BERLIN2_DIV_HAS_GATE | BERLIN2_DIV_HAS_MUX,\n\t\t.flags = 0,\n\t},\n};\n\nstatic const struct berlin2_gate_data bg2_gates[] __initconst = {\n\t{ \"geth0\",\t\"perif\",\t7 },\n\t{ \"geth1\",\t\"perif\",\t8 },\n\t{ \"sata\",\t\"perif\",\t9 },\n\t{ \"ahbapb\",\t\"perif\",\t10, CLK_IGNORE_UNUSED },\n\t{ \"usb0\",\t\"perif\",\t11 },\n\t{ \"usb1\",\t\"perif\",\t12 },\n\t{ \"pbridge\",\t\"perif\",\t13, CLK_IGNORE_UNUSED },\n\t{ \"sdio0\",\t\"perif\",\t14 },\n\t{ \"sdio1\",\t\"perif\",\t15 },\n\t{ \"nfc\",\t\"perif\",\t17 },\n\t{ \"smemc\",\t\"perif\",\t19 },\n\t{ \"audiohd\",\t\"audiohd_pll\",\t26 },\n\t{ \"video0\",\t\"video0_in\",\t27 },\n\t{ \"video1\",\t\"video1_in\",\t28 },\n\t{ \"video2\",\t\"video2_in\",\t29 },\n};\n\nstatic void __init berlin2_clock_setup(struct device_node *np)\n{\n\tstruct device_node *parent_np = of_get_parent(np);\n\tconst char *parent_names[9];\n\tstruct clk *clk;\n\tstruct clk_hw *hw;\n\tstruct clk_hw **hws;\n\tu8 avpll_flags = 0;\n\tint n, ret;\n\n\tclk_data = kzalloc(struct_size(clk_data, hws, MAX_CLKS), GFP_KERNEL);\n\tif (!clk_data) {\n\t\tof_node_put(parent_np);\n\t\treturn;\n\t}\n\tclk_data->num = MAX_CLKS;\n\thws = clk_data->hws;\n\n\tgbase = of_iomap(parent_np, 0);\n\tof_node_put(parent_np);\n\tif (!gbase)\n\t\treturn;\n\n\t \n\tclk = of_clk_get_by_name(np, clk_names[REFCLK]);\n\tif (!IS_ERR(clk)) {\n\t\tclk_names[REFCLK] = __clk_get_name(clk);\n\t\tclk_put(clk);\n\t}\n\n\tclk = of_clk_get_by_name(np, clk_names[VIDEO_EXT0]);\n\tif (!IS_ERR(clk)) {\n\t\tclk_names[VIDEO_EXT0] = __clk_get_name(clk);\n\t\tclk_put(clk);\n\t}\n\n\t \n\tret = berlin2_pll_register(&bg2_pll_map, gbase + REG_SYSPLLCTL0,\n\t\t\t\t   clk_names[SYSPLL], clk_names[REFCLK], 0);\n\tif (ret)\n\t\tgoto bg2_fail;\n\n\tret = berlin2_pll_register(&bg2_pll_map, gbase + REG_MEMPLLCTL0,\n\t\t\t\t   clk_names[MEMPLL], clk_names[REFCLK], 0);\n\tif (ret)\n\t\tgoto bg2_fail;\n\n\tret = berlin2_pll_register(&bg2_pll_map, gbase + REG_CPUPLLCTL0,\n\t\t\t\t   clk_names[CPUPLL], clk_names[REFCLK], 0);\n\tif (ret)\n\t\tgoto bg2_fail;\n\n\tif (of_device_is_compatible(np, \"marvell,berlin2-global-register\"))\n\t\tavpll_flags |= BERLIN2_AVPLL_SCRAMBLE_QUIRK;\n\n\t \n\tret = berlin2_avpll_vco_register(gbase + REG_AVPLLCTL0, \"avpll_vcoA\",\n\t\t\t clk_names[REFCLK], avpll_flags, 0);\n\tif (ret)\n\t\tgoto bg2_fail;\n\n\tfor (n = 0; n < 8; n++) {\n\t\tret = berlin2_avpll_channel_register(gbase + REG_AVPLLCTL0,\n\t\t\t     clk_names[AVPLL_A1 + n], n, \"avpll_vcoA\",\n\t\t\t     avpll_flags, 0);\n\t\tif (ret)\n\t\t\tgoto bg2_fail;\n\t}\n\n\tret = berlin2_avpll_vco_register(gbase + REG_AVPLLCTL31, \"avpll_vcoB\",\n\t\t\t\t clk_names[REFCLK], BERLIN2_AVPLL_BIT_QUIRK |\n\t\t\t\t avpll_flags, 0);\n\tif (ret)\n\t\tgoto bg2_fail;\n\n\tfor (n = 0; n < 8; n++) {\n\t\tret = berlin2_avpll_channel_register(gbase + REG_AVPLLCTL31,\n\t\t\t     clk_names[AVPLL_B1 + n], n, \"avpll_vcoB\",\n\t\t\t     BERLIN2_AVPLL_BIT_QUIRK | avpll_flags, 0);\n\t\tif (ret)\n\t\t\tgoto bg2_fail;\n\t}\n\n\t \n\tparent_names[0] = clk_names[SYSPLL];\n\tparent_names[1] = clk_names[REFCLK];\n\thw = clk_hw_register_mux(NULL, \"syspll_byp\", parent_names, 2,\n\t\t\t       0, gbase + REG_CLKSWITCH0, 0, 1, 0, &lock);\n\tif (IS_ERR(hw))\n\t\tgoto bg2_fail;\n\tclk_names[SYSPLL] = clk_hw_get_name(hw);\n\n\tparent_names[0] = clk_names[MEMPLL];\n\tparent_names[1] = clk_names[REFCLK];\n\thw = clk_hw_register_mux(NULL, \"mempll_byp\", parent_names, 2,\n\t\t\t       0, gbase + REG_CLKSWITCH0, 1, 1, 0, &lock);\n\tif (IS_ERR(hw))\n\t\tgoto bg2_fail;\n\tclk_names[MEMPLL] = clk_hw_get_name(hw);\n\n\tparent_names[0] = clk_names[CPUPLL];\n\tparent_names[1] = clk_names[REFCLK];\n\thw = clk_hw_register_mux(NULL, \"cpupll_byp\", parent_names, 2,\n\t\t\t       0, gbase + REG_CLKSWITCH0, 2, 1, 0, &lock);\n\tif (IS_ERR(hw))\n\t\tgoto bg2_fail;\n\tclk_names[CPUPLL] = clk_hw_get_name(hw);\n\n\t \n\tparent_names[0] = clk_names[AVPLL_B3];\n\tparent_names[1] = clk_names[AVPLL_A3];\n\thw = clk_hw_register_mux(NULL, clk_names[AUDIO1_PLL], parent_names, 2,\n\t\t\t       0, gbase + REG_CLKSELECT2, 29, 1, 0, &lock);\n\tif (IS_ERR(hw))\n\t\tgoto bg2_fail;\n\n\tparent_names[0] = clk_names[VIDEO0_PLL];\n\tparent_names[1] = clk_names[VIDEO_EXT0];\n\thw = clk_hw_register_mux(NULL, clk_names[VIDEO0_IN], parent_names, 2,\n\t\t\t       0, gbase + REG_CLKSELECT3, 4, 1, 0, &lock);\n\tif (IS_ERR(hw))\n\t\tgoto bg2_fail;\n\n\tparent_names[0] = clk_names[VIDEO1_PLL];\n\tparent_names[1] = clk_names[VIDEO_EXT0];\n\thw = clk_hw_register_mux(NULL, clk_names[VIDEO1_IN], parent_names, 2,\n\t\t\t       0, gbase + REG_CLKSELECT3, 6, 1, 0, &lock);\n\tif (IS_ERR(hw))\n\t\tgoto bg2_fail;\n\n\tparent_names[0] = clk_names[AVPLL_A2];\n\tparent_names[1] = clk_names[AVPLL_B2];\n\thw = clk_hw_register_mux(NULL, clk_names[VIDEO1_PLL], parent_names, 2,\n\t\t\t       0, gbase + REG_CLKSELECT3, 7, 1, 0, &lock);\n\tif (IS_ERR(hw))\n\t\tgoto bg2_fail;\n\n\tparent_names[0] = clk_names[VIDEO2_PLL];\n\tparent_names[1] = clk_names[VIDEO_EXT0];\n\thw = clk_hw_register_mux(NULL, clk_names[VIDEO2_IN], parent_names, 2,\n\t\t\t       0, gbase + REG_CLKSELECT3, 9, 1, 0, &lock);\n\tif (IS_ERR(hw))\n\t\tgoto bg2_fail;\n\n\tparent_names[0] = clk_names[AVPLL_B1];\n\tparent_names[1] = clk_names[AVPLL_A5];\n\thw = clk_hw_register_mux(NULL, clk_names[VIDEO2_PLL], parent_names, 2,\n\t\t\t       0, gbase + REG_CLKSELECT3, 10, 1, 0, &lock);\n\tif (IS_ERR(hw))\n\t\tgoto bg2_fail;\n\n\t \n\tfor (n = 0; n < ARRAY_SIZE(bg2_divs); n++) {\n\t\tconst struct berlin2_div_data *dd = &bg2_divs[n];\n\t\tint k;\n\n\t\tfor (k = 0; k < dd->num_parents; k++)\n\t\t\tparent_names[k] = clk_names[dd->parent_ids[k]];\n\n\t\thws[CLKID_SYS + n] = berlin2_div_register(&dd->map, gbase,\n\t\t\t\tdd->name, dd->div_flags, parent_names,\n\t\t\t\tdd->num_parents, dd->flags, &lock);\n\t}\n\n\t \n\tfor (n = 0; n < ARRAY_SIZE(bg2_gates); n++) {\n\t\tconst struct berlin2_gate_data *gd = &bg2_gates[n];\n\n\t\thws[CLKID_GETH0 + n] = clk_hw_register_gate(NULL, gd->name,\n\t\t\t    gd->parent_name, gd->flags, gbase + REG_CLKENABLE,\n\t\t\t    gd->bit_idx, 0, &lock);\n\t}\n\n\t \n\thws[CLKID_TWD] =\n\t\tclk_hw_register_fixed_factor(NULL, \"twd\", \"cpu\", 0, 1, 3);\n\n\t \n\tfor (n = 0; n < MAX_CLKS; n++) {\n\t\tif (!IS_ERR(hws[n]))\n\t\t\tcontinue;\n\n\t\tpr_err(\"%pOF: Unable to register leaf clock %d\\n\", np, n);\n\t\tgoto bg2_fail;\n\t}\n\n\t \n\tof_clk_add_hw_provider(np, of_clk_hw_onecell_get, clk_data);\n\n\treturn;\n\nbg2_fail:\n\tiounmap(gbase);\n}\nCLK_OF_DECLARE(berlin2_clk, \"marvell,berlin2-clk\",\n\t       berlin2_clock_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}