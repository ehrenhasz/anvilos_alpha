{
  "module_name": "berlin2-pll.c",
  "hash_id": "9e8b428d05704feec8cc3274bc63da8e3f46f697af82b0c6a2a3339ae6898840",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/berlin/berlin2-pll.c",
  "human_readable_source": "\n \n#include <linux/clk-provider.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/slab.h>\n#include <asm/div64.h>\n\n#include \"berlin2-div.h\"\n#include \"berlin2-pll.h\"\n\nstruct berlin2_pll {\n\tstruct clk_hw hw;\n\tvoid __iomem *base;\n\tstruct berlin2_pll_map map;\n};\n\n#define to_berlin2_pll(hw) container_of(hw, struct berlin2_pll, hw)\n\n#define SPLL_CTRL0\t0x00\n#define SPLL_CTRL1\t0x04\n#define SPLL_CTRL2\t0x08\n#define SPLL_CTRL3\t0x0c\n#define SPLL_CTRL4\t0x10\n\n#define FBDIV_MASK\t0x1ff\n#define RFDIV_MASK\t0x1f\n#define DIVSEL_MASK\t0xf\n\n \nstatic unsigned long\nberlin2_pll_recalc_rate(struct clk_hw *hw, unsigned long parent_rate)\n{\n\tstruct berlin2_pll *pll = to_berlin2_pll(hw);\n\tstruct berlin2_pll_map *map = &pll->map;\n\tu32 val, fbdiv, rfdiv, vcodivsel, vcodiv;\n\tu64 rate = parent_rate;\n\n\tval = readl_relaxed(pll->base + SPLL_CTRL0);\n\tfbdiv = (val >> map->fbdiv_shift) & FBDIV_MASK;\n\trfdiv = (val >> map->rfdiv_shift) & RFDIV_MASK;\n\tif (rfdiv == 0) {\n\t\tpr_warn(\"%s has zero rfdiv\\n\", clk_hw_get_name(hw));\n\t\trfdiv = 1;\n\t}\n\n\tval = readl_relaxed(pll->base + SPLL_CTRL1);\n\tvcodivsel = (val >> map->divsel_shift) & DIVSEL_MASK;\n\tvcodiv = map->vcodiv[vcodivsel];\n\tif (vcodiv == 0) {\n\t\tpr_warn(\"%s has zero vcodiv (index %d)\\n\",\n\t\t\tclk_hw_get_name(hw), vcodivsel);\n\t\tvcodiv = 1;\n\t}\n\n\trate *= fbdiv * map->mult;\n\tdo_div(rate, rfdiv * vcodiv);\n\n\treturn (unsigned long)rate;\n}\n\nstatic const struct clk_ops berlin2_pll_ops = {\n\t.recalc_rate\t= berlin2_pll_recalc_rate,\n};\n\nint __init\nberlin2_pll_register(const struct berlin2_pll_map *map,\n\t\t     void __iomem *base, const char *name,\n\t\t     const char *parent_name, unsigned long flags)\n{\n\tstruct clk_init_data init;\n\tstruct berlin2_pll *pll;\n\n\tpll = kzalloc(sizeof(*pll), GFP_KERNEL);\n\tif (!pll)\n\t\treturn -ENOMEM;\n\n\t \n\tmemcpy(&pll->map, map, sizeof(*map));\n\tpll->base = base;\n\tpll->hw.init = &init;\n\tinit.name = name;\n\tinit.ops = &berlin2_pll_ops;\n\tinit.parent_names = &parent_name;\n\tinit.num_parents = 1;\n\tinit.flags = flags;\n\n\treturn clk_hw_register(NULL, &pll->hw);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}