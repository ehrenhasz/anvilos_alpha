{
  "module_name": "clk-tegra-super-gen4.c",
  "hash_id": "a735d31b5ef42157d5282e4e4c17966e0a204e69b10bb17977d35c3470fb4c83",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/tegra/clk-tegra-super-gen4.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/clk-provider.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/delay.h>\n#include <linux/export.h>\n#include <linux/clk/tegra.h>\n\n#include \"clk.h\"\n#include \"clk-id.h\"\n\n#define PLLX_BASE 0xe0\n#define PLLX_MISC 0xe4\n#define PLLX_MISC2 0x514\n#define PLLX_MISC3 0x518\n\n#define CCLKG_BURST_POLICY 0x368\n#define CCLKLP_BURST_POLICY 0x370\n#define SCLK_BURST_POLICY 0x028\n#define SYSTEM_CLK_RATE 0x030\n#define SCLK_DIVIDER 0x2c\n\nstatic DEFINE_SPINLOCK(sysrate_lock);\n\nenum tegra_super_gen {\n\tgen4 = 4,\n\tgen5,\n};\n\nstruct tegra_super_gen_info {\n\tenum tegra_super_gen gen;\n\tconst char **sclk_parents;\n\tconst char **cclk_g_parents;\n\tconst char **cclk_lp_parents;\n\tint num_sclk_parents;\n\tint num_cclk_g_parents;\n\tint num_cclk_lp_parents;\n};\n\nstatic const char *sclk_parents[] = { \"clk_m\", \"pll_c_out1\", \"pll_p_out4\",\n\t\t\t       \"pll_p\", \"pll_p_out2\", \"unused\",\n\t\t\t       \"clk_32k\", \"pll_m_out1\" };\n\nstatic const char *cclk_g_parents[] = { \"clk_m\", \"pll_c\", \"clk_32k\", \"pll_m\",\n\t\t\t\t\t\"pll_p\", \"pll_p_out4\", \"unused\",\n\t\t\t\t\t\"unused\", \"pll_x\", \"unused\", \"unused\",\n\t\t\t\t\t\"unused\", \"unused\", \"unused\", \"unused\",\n\t\t\t\t\t\"dfllCPU_out\" };\n\nstatic const char *cclk_lp_parents[] = { \"clk_m\", \"pll_c\", \"clk_32k\", \"pll_m\",\n\t\t\t\t\t \"pll_p\", \"pll_p_out4\", \"unused\",\n\t\t\t\t\t \"unused\", \"pll_x\", \"pll_x_out0\" };\n\nstatic const struct tegra_super_gen_info tegra_super_gen_info_gen4 = {\n\t.gen = gen4,\n\t.sclk_parents = sclk_parents,\n\t.cclk_g_parents = cclk_g_parents,\n\t.cclk_lp_parents = cclk_lp_parents,\n\t.num_sclk_parents = ARRAY_SIZE(sclk_parents),\n\t.num_cclk_g_parents = ARRAY_SIZE(cclk_g_parents),\n\t.num_cclk_lp_parents = ARRAY_SIZE(cclk_lp_parents),\n};\n\nstatic const char *sclk_parents_gen5[] = { \"clk_m\", \"pll_c_out1\", \"pll_c4_out3\",\n\t\t\t       \"pll_p\", \"pll_p_out2\", \"pll_c4_out1\",\n\t\t\t       \"clk_32k\", \"pll_c4_out2\" };\n\nstatic const char *cclk_g_parents_gen5[] = { \"clk_m\", \"unused\", \"clk_32k\", \"unused\",\n\t\t\t\t\t\"pll_p\", \"pll_p_out4\", \"unused\",\n\t\t\t\t\t\"unused\", \"pll_x\", \"unused\", \"unused\",\n\t\t\t\t\t\"unused\", \"unused\", \"unused\", \"unused\",\n\t\t\t\t\t\"dfllCPU_out\" };\n\nstatic const char *cclk_lp_parents_gen5[] = { \"clk_m\", \"unused\", \"clk_32k\", \"unused\",\n\t\t\t\t\t\"pll_p\", \"pll_p_out4\", \"unused\",\n\t\t\t\t\t\"unused\", \"pll_x\", \"unused\", \"unused\",\n\t\t\t\t\t\"unused\", \"unused\", \"unused\", \"unused\",\n\t\t\t\t\t\"dfllCPU_out\" };\n\nstatic const struct tegra_super_gen_info tegra_super_gen_info_gen5 = {\n\t.gen = gen5,\n\t.sclk_parents = sclk_parents_gen5,\n\t.cclk_g_parents = cclk_g_parents_gen5,\n\t.cclk_lp_parents = cclk_lp_parents_gen5,\n\t.num_sclk_parents = ARRAY_SIZE(sclk_parents_gen5),\n\t.num_cclk_g_parents = ARRAY_SIZE(cclk_g_parents_gen5),\n\t.num_cclk_lp_parents = ARRAY_SIZE(cclk_lp_parents_gen5),\n};\n\nstatic void __init tegra_sclk_init(void __iomem *clk_base,\n\t\t\t\tstruct tegra_clk *tegra_clks,\n\t\t\t\tconst struct tegra_super_gen_info *gen_info)\n{\n\tstruct clk *clk;\n\tstruct clk **dt_clk;\n\n\t \n\tdt_clk = tegra_lookup_dt_id(tegra_clk_sclk_mux, tegra_clks);\n\tif (dt_clk) {\n\t\tclk = tegra_clk_register_super_mux(\"sclk_mux\",\n\t\t\t\t\t\tgen_info->sclk_parents,\n\t\t\t\t\t\tgen_info->num_sclk_parents,\n\t\t\t\t\t\tCLK_SET_RATE_PARENT,\n\t\t\t\t\t\tclk_base + SCLK_BURST_POLICY,\n\t\t\t\t\t\t0, 4, 0, 0, NULL);\n\t\t*dt_clk = clk;\n\n\n\t\t \n\t\tdt_clk = tegra_lookup_dt_id(tegra_clk_sclk, tegra_clks);\n\t\tif (dt_clk) {\n\t\t\tclk = clk_register_divider(NULL, \"sclk\", \"sclk_mux\",\n\t\t\t\t\t\tCLK_IS_CRITICAL,\n\t\t\t\t\t\tclk_base + SCLK_DIVIDER, 0, 8,\n\t\t\t\t\t\t0, &sysrate_lock);\n\t\t\t*dt_clk = clk;\n\t\t}\n\t} else {\n\t\t \n\t\tdt_clk = tegra_lookup_dt_id(tegra_clk_sclk, tegra_clks);\n\t\tif (dt_clk) {\n\t\t\tclk = tegra_clk_register_super_mux(\"sclk\",\n\t\t\t\t\t\tgen_info->sclk_parents,\n\t\t\t\t\t\tgen_info->num_sclk_parents,\n\t\t\t\t\t\tCLK_SET_RATE_PARENT |\n\t\t\t\t\t\tCLK_IS_CRITICAL,\n\t\t\t\t\t\tclk_base + SCLK_BURST_POLICY,\n\t\t\t\t\t\t0, 4, 0, 0, NULL);\n\t\t\t*dt_clk = clk;\n\t\t}\n\t}\n\n\t \n\tdt_clk = tegra_lookup_dt_id(tegra_clk_hclk, tegra_clks);\n\tif (dt_clk) {\n\t\tclk = clk_register_divider(NULL, \"hclk_div\", \"sclk\", 0,\n\t\t\t\t   clk_base + SYSTEM_CLK_RATE, 4, 2, 0,\n\t\t\t\t   &sysrate_lock);\n\t\tclk = clk_register_gate(NULL, \"hclk\", \"hclk_div\",\n\t\t\t\tCLK_SET_RATE_PARENT | CLK_IS_CRITICAL,\n\t\t\t\tclk_base + SYSTEM_CLK_RATE,\n\t\t\t\t7, CLK_GATE_SET_TO_DISABLE, &sysrate_lock);\n\t\t*dt_clk = clk;\n\t}\n\n\t \n\tdt_clk = tegra_lookup_dt_id(tegra_clk_pclk, tegra_clks);\n\tif (!dt_clk)\n\t\treturn;\n\n\tclk = clk_register_divider(NULL, \"pclk_div\", \"hclk\", 0,\n\t\t\t\t   clk_base + SYSTEM_CLK_RATE, 0, 2, 0,\n\t\t\t\t   &sysrate_lock);\n\tclk = clk_register_gate(NULL, \"pclk\", \"pclk_div\", CLK_SET_RATE_PARENT |\n\t\t\t\tCLK_IS_CRITICAL, clk_base + SYSTEM_CLK_RATE,\n\t\t\t\t3, CLK_GATE_SET_TO_DISABLE, &sysrate_lock);\n\t*dt_clk = clk;\n}\n\nstatic void __init tegra_super_clk_init(void __iomem *clk_base,\n\t\t\t\tvoid __iomem *pmc_base,\n\t\t\t\tstruct tegra_clk *tegra_clks,\n\t\t\t\tstruct tegra_clk_pll_params *params,\n\t\t\t\tconst struct tegra_super_gen_info *gen_info)\n{\n\tstruct clk *clk;\n\tstruct clk **dt_clk;\n\n\t \n\tdt_clk = tegra_lookup_dt_id(tegra_clk_cclk_g, tegra_clks);\n\tif (dt_clk) {\n\t\tif (gen_info->gen == gen5) {\n\t\t\tclk = tegra_clk_register_super_mux(\"cclk_g\",\n\t\t\t\t\tgen_info->cclk_g_parents,\n\t\t\t\t\tgen_info->num_cclk_g_parents,\n\t\t\t\t\tCLK_SET_RATE_PARENT,\n\t\t\t\t\tclk_base + CCLKG_BURST_POLICY,\n\t\t\t\t\tTEGRA210_CPU_CLK, 4, 8, 0, NULL);\n\t\t} else {\n\t\t\tclk = tegra_clk_register_super_mux(\"cclk_g\",\n\t\t\t\t\tgen_info->cclk_g_parents,\n\t\t\t\t\tgen_info->num_cclk_g_parents,\n\t\t\t\t\tCLK_SET_RATE_PARENT,\n\t\t\t\t\tclk_base + CCLKG_BURST_POLICY,\n\t\t\t\t\t0, 4, 0, 0, NULL);\n\t\t}\n\t\t*dt_clk = clk;\n\t}\n\n\t \n\tdt_clk = tegra_lookup_dt_id(tegra_clk_cclk_lp, tegra_clks);\n\tif (dt_clk) {\n\t\tif (gen_info->gen == gen5) {\n\t\t\t \n\t\t\tclk = tegra_clk_register_super_mux(\"cclk_lp\",\n\t\t\t\t\tgen_info->cclk_lp_parents,\n\t\t\t\t\tgen_info->num_cclk_lp_parents,\n\t\t\t\t\tCLK_SET_RATE_PARENT,\n\t\t\t\t\tclk_base + CCLKLP_BURST_POLICY,\n\t\t\t\t\t0, 4, 8, 0, NULL);\n\t\t} else {\n\t\t\tclk = tegra_clk_register_super_mux(\"cclk_lp\",\n\t\t\t\t\tgen_info->cclk_lp_parents,\n\t\t\t\t\tgen_info->num_cclk_lp_parents,\n\t\t\t\t\tCLK_SET_RATE_PARENT,\n\t\t\t\t\tclk_base + CCLKLP_BURST_POLICY,\n\t\t\t\t\tTEGRA_DIVIDER_2, 4, 8, 9, NULL);\n\t\t}\n\t\t*dt_clk = clk;\n\t}\n\n\ttegra_sclk_init(clk_base, tegra_clks, gen_info);\n\n#if defined(CONFIG_ARCH_TEGRA_114_SOC) || \\\n    defined(CONFIG_ARCH_TEGRA_124_SOC) || \\\n    defined(CONFIG_ARCH_TEGRA_210_SOC)\n\t \n\tdt_clk = tegra_lookup_dt_id(tegra_clk_pll_x, tegra_clks);\n\tif (!dt_clk)\n\t\treturn;\n\n#if defined(CONFIG_ARCH_TEGRA_210_SOC)\n\tif (gen_info->gen == gen5)\n\t\tclk = tegra_clk_register_pllc_tegra210(\"pll_x\", \"pll_ref\",\n\t\t\tclk_base, pmc_base, CLK_IGNORE_UNUSED, params, NULL);\n\telse\n#endif\n\t\tclk = tegra_clk_register_pllxc(\"pll_x\", \"pll_ref\", clk_base,\n\t\t\t\tpmc_base, CLK_IGNORE_UNUSED, params, NULL);\n\n\t*dt_clk = clk;\n\n\t \n\n\tdt_clk = tegra_lookup_dt_id(tegra_clk_pll_x_out0, tegra_clks);\n\tif (!dt_clk)\n\t\treturn;\n\tclk = clk_register_fixed_factor(NULL, \"pll_x_out0\", \"pll_x\",\n\t\t\t\t\tCLK_SET_RATE_PARENT, 1, 2);\n\t*dt_clk = clk;\n#endif\n}\n\nvoid __init tegra_super_clk_gen4_init(void __iomem *clk_base,\n\t\t\t\tvoid __iomem *pmc_base,\n\t\t\t\tstruct tegra_clk *tegra_clks,\n\t\t\t\tstruct tegra_clk_pll_params *params)\n{\n\ttegra_super_clk_init(clk_base, pmc_base, tegra_clks, params,\n\t\t\t     &tegra_super_gen_info_gen4);\n}\n\nvoid __init tegra_super_clk_gen5_init(void __iomem *clk_base,\n\t\t\t\tvoid __iomem *pmc_base,\n\t\t\t\tstruct tegra_clk *tegra_clks,\n\t\t\t\tstruct tegra_clk_pll_params *params)\n{\n\ttegra_super_clk_init(clk_base, pmc_base, tegra_clks, params,\n\t\t\t     &tegra_super_gen_info_gen5);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}