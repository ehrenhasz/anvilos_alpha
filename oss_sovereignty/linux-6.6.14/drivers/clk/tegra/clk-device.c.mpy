{
  "module_name": "clk-device.c",
  "hash_id": "0c3f28acb4a2c4ca0e2580d8e229aea9bc2dec4aa024306350536ed17d2b9ed7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/tegra/clk-device.c",
  "human_readable_source": "\n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/mod_devicetable.h>\n#include <linux/mutex.h>\n#include <linux/platform_device.h>\n#include <linux/pm_domain.h>\n#include <linux/pm_opp.h>\n#include <linux/pm_runtime.h>\n#include <linux/slab.h>\n\n#include <soc/tegra/common.h>\n\n#include \"clk.h\"\n\n \n\nstruct tegra_clk_device {\n\tstruct notifier_block clk_nb;\n\tstruct device *dev;\n\tstruct clk_hw *hw;\n\tstruct mutex lock;\n};\n\nstatic int tegra_clock_set_pd_state(struct tegra_clk_device *clk_dev,\n\t\t\t\t    unsigned long rate)\n{\n\tstruct device *dev = clk_dev->dev;\n\tstruct dev_pm_opp *opp;\n\tunsigned int pstate;\n\n\topp = dev_pm_opp_find_freq_ceil(dev, &rate);\n\tif (opp == ERR_PTR(-ERANGE)) {\n\t\t \n\t\tdev_dbg(dev, \"failed to find ceil OPP for %luHz\\n\", rate);\n\t\topp = dev_pm_opp_find_freq_floor(dev, &rate);\n\t}\n\n\tif (IS_ERR(opp)) {\n\t\tdev_err(dev, \"failed to find OPP for %luHz: %pe\\n\", rate, opp);\n\t\treturn PTR_ERR(opp);\n\t}\n\n\tpstate = dev_pm_opp_get_required_pstate(opp, 0);\n\tdev_pm_opp_put(opp);\n\n\treturn dev_pm_genpd_set_performance_state(dev, pstate);\n}\n\nstatic int tegra_clock_change_notify(struct notifier_block *nb,\n\t\t\t\t     unsigned long msg, void *data)\n{\n\tstruct clk_notifier_data *cnd = data;\n\tstruct tegra_clk_device *clk_dev;\n\tint err = 0;\n\n\tclk_dev = container_of(nb, struct tegra_clk_device, clk_nb);\n\n\tmutex_lock(&clk_dev->lock);\n\tswitch (msg) {\n\tcase PRE_RATE_CHANGE:\n\t\tif (cnd->new_rate > cnd->old_rate)\n\t\t\terr = tegra_clock_set_pd_state(clk_dev, cnd->new_rate);\n\t\tbreak;\n\n\tcase ABORT_RATE_CHANGE:\n\t\terr = tegra_clock_set_pd_state(clk_dev, cnd->old_rate);\n\t\tbreak;\n\n\tcase POST_RATE_CHANGE:\n\t\tif (cnd->new_rate < cnd->old_rate)\n\t\t\terr = tegra_clock_set_pd_state(clk_dev, cnd->new_rate);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\tmutex_unlock(&clk_dev->lock);\n\n\treturn notifier_from_errno(err);\n}\n\nstatic int tegra_clock_sync_pd_state(struct tegra_clk_device *clk_dev)\n{\n\tunsigned long rate;\n\tint ret;\n\n\tmutex_lock(&clk_dev->lock);\n\n\trate = clk_hw_get_rate(clk_dev->hw);\n\tret = tegra_clock_set_pd_state(clk_dev, rate);\n\n\tmutex_unlock(&clk_dev->lock);\n\n\treturn ret;\n}\n\nstatic int tegra_clock_probe(struct platform_device *pdev)\n{\n\tstruct tegra_core_opp_params opp_params = {};\n\tstruct tegra_clk_device *clk_dev;\n\tstruct device *dev = &pdev->dev;\n\tstruct clk *clk;\n\tint err;\n\n\tif (!dev->pm_domain)\n\t\treturn -EINVAL;\n\n\tclk_dev = devm_kzalloc(dev, sizeof(*clk_dev), GFP_KERNEL);\n\tif (!clk_dev)\n\t\treturn -ENOMEM;\n\n\tclk = devm_clk_get(dev, NULL);\n\tif (IS_ERR(clk))\n\t\treturn PTR_ERR(clk);\n\n\tclk_dev->dev = dev;\n\tclk_dev->hw = __clk_get_hw(clk);\n\tclk_dev->clk_nb.notifier_call = tegra_clock_change_notify;\n\tmutex_init(&clk_dev->lock);\n\n\tplatform_set_drvdata(pdev, clk_dev);\n\n\t \n\terr = devm_tegra_core_dev_init_opp_table(dev, &opp_params);\n\tif (err)\n\t\treturn err;\n\n\terr = clk_notifier_register(clk, &clk_dev->clk_nb);\n\tif (err) {\n\t\tdev_err(dev, \"failed to register clk notifier: %d\\n\", err);\n\t\treturn err;\n\t}\n\n\t \n\terr = tegra_clock_sync_pd_state(clk_dev);\n\tif (err)\n\t\tgoto unreg_clk;\n\n\treturn 0;\n\nunreg_clk:\n\tclk_notifier_unregister(clk, &clk_dev->clk_nb);\n\n\treturn err;\n}\n\n \nstatic const struct dev_pm_ops tegra_clock_pm = {\n\tSET_SYSTEM_SLEEP_PM_OPS(pm_runtime_resume_and_get, pm_runtime_put)\n};\n\nstatic const struct of_device_id tegra_clock_match[] = {\n\t{ .compatible = \"nvidia,tegra20-sclk\" },\n\t{ .compatible = \"nvidia,tegra30-sclk\" },\n\t{ .compatible = \"nvidia,tegra30-pllc\" },\n\t{ .compatible = \"nvidia,tegra30-plle\" },\n\t{ .compatible = \"nvidia,tegra30-pllm\" },\n\t{ }\n};\n\nstatic struct platform_driver tegra_clock_driver = {\n\t.driver = {\n\t\t.name = \"tegra-clock\",\n\t\t.of_match_table = tegra_clock_match,\n\t\t.pm = &tegra_clock_pm,\n\t\t.suppress_bind_attrs = true,\n\t},\n\t.probe = tegra_clock_probe,\n};\nbuiltin_platform_driver(tegra_clock_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}