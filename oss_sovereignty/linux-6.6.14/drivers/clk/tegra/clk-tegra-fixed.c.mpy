{
  "module_name": "clk-tegra-fixed.c",
  "hash_id": "fdba53592f0045d94d017ae57e62908b4220d15de0b6fe04503956d12e60062b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clk/tegra/clk-tegra-fixed.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/clk-provider.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/delay.h>\n#include <linux/export.h>\n#include <linux/clk/tegra.h>\n\n#include \"clk.h\"\n#include \"clk-id.h\"\n\n#define OSC_CTRL\t\t\t0x50\n#define OSC_CTRL_OSC_FREQ_SHIFT\t\t28\n#define OSC_CTRL_PLL_REF_DIV_SHIFT\t26\n#define OSC_CTRL_MASK\t\t\t(0x3f2 |\t\\\n\t\t\t\t\t(0xf << OSC_CTRL_OSC_FREQ_SHIFT))\n\nstatic u32 osc_ctrl_ctx;\n\nint __init tegra_osc_clk_init(void __iomem *clk_base, struct tegra_clk *clks,\n\t\t\t      unsigned long *input_freqs, unsigned int num,\n\t\t\t      unsigned int clk_m_div, unsigned long *osc_freq,\n\t\t\t      unsigned long *pll_ref_freq)\n{\n\tstruct clk *clk, *osc;\n\tstruct clk **dt_clk;\n\tu32 val, pll_ref_div;\n\tunsigned osc_idx;\n\n\tval = readl_relaxed(clk_base + OSC_CTRL);\n\tosc_ctrl_ctx = val & OSC_CTRL_MASK;\n\tosc_idx = val >> OSC_CTRL_OSC_FREQ_SHIFT;\n\n\tif (osc_idx < num)\n\t\t*osc_freq = input_freqs[osc_idx];\n\telse\n\t\t*osc_freq = 0;\n\n\tif (!*osc_freq) {\n\t\tWARN_ON(1);\n\t\treturn -EINVAL;\n\t}\n\n\tdt_clk = tegra_lookup_dt_id(tegra_clk_osc, clks);\n\tif (!dt_clk)\n\t\treturn 0;\n\n\tosc = clk_register_fixed_rate(NULL, \"osc\", NULL, 0, *osc_freq);\n\t*dt_clk = osc;\n\n\t \n\tdt_clk = tegra_lookup_dt_id(tegra_clk_osc_div2, clks);\n\tif (dt_clk) {\n\t\tclk = clk_register_fixed_factor(NULL, \"osc_div2\", \"osc\",\n\t\t\t\t\t\t0, 1, 2);\n\t\t*dt_clk = clk;\n\t}\n\n\t \n\tdt_clk = tegra_lookup_dt_id(tegra_clk_osc_div4, clks);\n\tif (dt_clk) {\n\t\tclk = clk_register_fixed_factor(NULL, \"osc_div4\", \"osc\",\n\t\t\t\t\t\t0, 1, 4);\n\t\t*dt_clk = clk;\n\t}\n\n\tdt_clk = tegra_lookup_dt_id(tegra_clk_clk_m, clks);\n\tif (!dt_clk)\n\t\treturn 0;\n\n\tclk = clk_register_fixed_factor(NULL, \"clk_m\", \"osc\",\n\t\t\t\t\t0, 1, clk_m_div);\n\t*dt_clk = clk;\n\n\t \n\tval = (val >> OSC_CTRL_PLL_REF_DIV_SHIFT) & 3;\n\tpll_ref_div = 1 << val;\n\tdt_clk = tegra_lookup_dt_id(tegra_clk_pll_ref, clks);\n\tif (!dt_clk)\n\t\treturn 0;\n\n\tclk = clk_register_fixed_factor(NULL, \"pll_ref\", \"osc\",\n\t\t\t\t\t0, 1, pll_ref_div);\n\t*dt_clk = clk;\n\n\tif (pll_ref_freq)\n\t\t*pll_ref_freq = *osc_freq / pll_ref_div;\n\n\treturn 0;\n}\n\nvoid __init tegra_fixed_clk_init(struct tegra_clk *tegra_clks)\n{\n\tstruct clk *clk;\n\tstruct clk **dt_clk;\n\n\t \n\tdt_clk = tegra_lookup_dt_id(tegra_clk_clk_32k, tegra_clks);\n\tif (dt_clk) {\n\t\tclk = clk_register_fixed_rate(NULL, \"clk_32k\", NULL, 0, 32768);\n\t\t*dt_clk = clk;\n\t}\n}\n\nvoid tegra_clk_osc_resume(void __iomem *clk_base)\n{\n\tu32 val;\n\n\tval = readl_relaxed(clk_base + OSC_CTRL) & ~OSC_CTRL_MASK;\n\tval |= osc_ctrl_ctx;\n\twritel_relaxed(val, clk_base + OSC_CTRL);\n\tfence_udelay(2, clk_base);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}