{
  "module_name": "nitrox_sriov.c",
  "hash_id": "af18e77a7b8bc6102bf8a8026002d887feebc1756088870fd7eefe0fad78baaa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/crypto/cavium/nitrox/nitrox_sriov.c",
  "human_readable_source": "\n#include <linux/pci.h>\n#include <linux/delay.h>\n\n#include \"nitrox_dev.h\"\n#include \"nitrox_hal.h\"\n#include \"nitrox_common.h\"\n#include \"nitrox_isr.h\"\n#include \"nitrox_mbx.h\"\n\n \nstatic inline bool num_vfs_valid(int num_vfs)\n{\n\tbool valid = false;\n\n\tswitch (num_vfs) {\n\tcase 16:\n\tcase 32:\n\tcase 64:\n\tcase 128:\n\t\tvalid = true;\n\t\tbreak;\n\t}\n\n\treturn valid;\n}\n\nstatic inline enum vf_mode num_vfs_to_mode(int num_vfs)\n{\n\tenum vf_mode mode = 0;\n\n\tswitch (num_vfs) {\n\tcase 0:\n\t\tmode = __NDEV_MODE_PF;\n\t\tbreak;\n\tcase 16:\n\t\tmode = __NDEV_MODE_VF16;\n\t\tbreak;\n\tcase 32:\n\t\tmode = __NDEV_MODE_VF32;\n\t\tbreak;\n\tcase 64:\n\t\tmode = __NDEV_MODE_VF64;\n\t\tbreak;\n\tcase 128:\n\t\tmode = __NDEV_MODE_VF128;\n\t\tbreak;\n\t}\n\n\treturn mode;\n}\n\nstatic inline int vf_mode_to_nr_queues(enum vf_mode mode)\n{\n\tint nr_queues = 0;\n\n\tswitch (mode) {\n\tcase __NDEV_MODE_PF:\n\t\tnr_queues = MAX_PF_QUEUES;\n\t\tbreak;\n\tcase __NDEV_MODE_VF16:\n\t\tnr_queues = 8;\n\t\tbreak;\n\tcase __NDEV_MODE_VF32:\n\t\tnr_queues = 4;\n\t\tbreak;\n\tcase __NDEV_MODE_VF64:\n\t\tnr_queues = 2;\n\t\tbreak;\n\tcase __NDEV_MODE_VF128:\n\t\tnr_queues = 1;\n\t\tbreak;\n\t}\n\n\treturn nr_queues;\n}\n\nstatic void nitrox_pf_cleanup(struct nitrox_device *ndev)\n{\n\t  \n\tatomic_set(&ndev->state, __NDEV_NOT_READY);\n\t \n\tnitrox_crypto_unregister();\n\n\t \n\tnitrox_unregister_interrupts(ndev);\n\tnitrox_common_sw_cleanup(ndev);\n}\n\n \nstatic int nitrox_pf_reinit(struct nitrox_device *ndev)\n{\n\tint err;\n\n\t \n\terr = nitrox_common_sw_init(ndev);\n\tif (err)\n\t\treturn err;\n\n\terr = nitrox_register_interrupts(ndev);\n\tif (err) {\n\t\tnitrox_common_sw_cleanup(ndev);\n\t\treturn err;\n\t}\n\n\t \n\tnitrox_config_aqm_rings(ndev);\n\n\t \n\tnitrox_config_pkt_input_rings(ndev);\n\tnitrox_config_pkt_solicit_ports(ndev);\n\n\t \n\tatomic_set(&ndev->state, __NDEV_READY);\n\n\t \n\treturn nitrox_crypto_register();\n}\n\nstatic void nitrox_sriov_cleanup(struct nitrox_device *ndev)\n{\n\t \n\tnitrox_sriov_unregister_interrupts(ndev);\n\tnitrox_mbox_cleanup(ndev);\n}\n\nstatic int nitrox_sriov_init(struct nitrox_device *ndev)\n{\n\tint ret;\n\n\t \n\tret = nitrox_sriov_register_interupts(ndev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = nitrox_mbox_init(ndev);\n\tif (ret)\n\t\tgoto sriov_init_fail;\n\n\treturn 0;\n\nsriov_init_fail:\n\tnitrox_sriov_cleanup(ndev);\n\treturn ret;\n}\n\nstatic int nitrox_sriov_enable(struct pci_dev *pdev, int num_vfs)\n{\n\tstruct nitrox_device *ndev = pci_get_drvdata(pdev);\n\tint err;\n\n\tif (!num_vfs_valid(num_vfs)) {\n\t\tdev_err(DEV(ndev), \"Invalid num_vfs %d\\n\", num_vfs);\n\t\treturn -EINVAL;\n\t}\n\n\tif (pci_num_vf(pdev) == num_vfs)\n\t\treturn num_vfs;\n\n\terr = pci_enable_sriov(pdev, num_vfs);\n\tif (err) {\n\t\tdev_err(DEV(ndev), \"failed to enable PCI sriov %d\\n\", err);\n\t\treturn err;\n\t}\n\tdev_info(DEV(ndev), \"Enabled VF(s) %d\\n\", num_vfs);\n\n\tndev->mode = num_vfs_to_mode(num_vfs);\n\tndev->iov.num_vfs = num_vfs;\n\tndev->iov.max_vf_queues = vf_mode_to_nr_queues(ndev->mode);\n\t \n\tset_bit(__NDEV_SRIOV_BIT, &ndev->flags);\n\n\t \n\tnitrox_pf_cleanup(ndev);\n\n\t \n\terr = nitrox_sriov_init(ndev);\n\tif (err)\n\t\tgoto iov_fail;\n\n\tconfig_nps_core_vfcfg_mode(ndev, ndev->mode);\n\treturn num_vfs;\n\niov_fail:\n\tpci_disable_sriov(pdev);\n\t \n\tclear_bit(__NDEV_SRIOV_BIT, &ndev->flags);\n\tndev->iov.num_vfs = 0;\n\tndev->mode = __NDEV_MODE_PF;\n\t \n\tnitrox_pf_reinit(ndev);\n\treturn err;\n}\n\nstatic int nitrox_sriov_disable(struct pci_dev *pdev)\n{\n\tstruct nitrox_device *ndev = pci_get_drvdata(pdev);\n\n\tif (!test_bit(__NDEV_SRIOV_BIT, &ndev->flags))\n\t\treturn 0;\n\n\tif (pci_vfs_assigned(pdev)) {\n\t\tdev_warn(DEV(ndev), \"VFs are attached to VM. Can't disable SR-IOV\\n\");\n\t\treturn -EPERM;\n\t}\n\tpci_disable_sriov(pdev);\n\t \n\tclear_bit(__NDEV_SRIOV_BIT, &ndev->flags);\n\n\tndev->iov.num_vfs = 0;\n\tndev->iov.max_vf_queues = 0;\n\tndev->mode = __NDEV_MODE_PF;\n\n\t \n\tnitrox_sriov_cleanup(ndev);\n\n\tconfig_nps_core_vfcfg_mode(ndev, ndev->mode);\n\n\treturn nitrox_pf_reinit(ndev);\n}\n\nint nitrox_sriov_configure(struct pci_dev *pdev, int num_vfs)\n{\n\tif (!num_vfs)\n\t\treturn nitrox_sriov_disable(pdev);\n\n\treturn nitrox_sriov_enable(pdev, num_vfs);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}