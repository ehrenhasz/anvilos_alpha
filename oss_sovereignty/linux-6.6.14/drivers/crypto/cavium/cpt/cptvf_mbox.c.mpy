{
  "module_name": "cptvf_mbox.c",
  "hash_id": "7924e5d019bd2b4c38caff51f2aba695535d3afbeb04cef1e5b35672c6fd580f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/crypto/cavium/cpt/cptvf_mbox.c",
  "human_readable_source": "\n \n\n#include \"cptvf.h\"\n\nstatic void cptvf_send_msg_to_pf(struct cpt_vf *cptvf, struct cpt_mbox *mbx)\n{\n\t \n\tcpt_write_csr64(cptvf->reg_base, CPTX_VFX_PF_MBOXX(0, 0, 0),\n\t\t\tmbx->msg);\n\tcpt_write_csr64(cptvf->reg_base, CPTX_VFX_PF_MBOXX(0, 0, 1),\n\t\t\tmbx->data);\n}\n\n \nvoid cptvf_handle_mbox_intr(struct cpt_vf *cptvf)\n{\n\tstruct cpt_mbox mbx = {};\n\n\t \n\tmbx.msg  = cpt_read_csr64(cptvf->reg_base, CPTX_VFX_PF_MBOXX(0, 0, 0));\n\tmbx.data = cpt_read_csr64(cptvf->reg_base, CPTX_VFX_PF_MBOXX(0, 0, 1));\n\tdev_dbg(&cptvf->pdev->dev, \"%s: Mailbox msg 0x%llx from PF\\n\",\n\t\t__func__, mbx.msg);\n\tswitch (mbx.msg) {\n\tcase CPT_MSG_READY:\n\t{\n\t\tcptvf->pf_acked = true;\n\t\tcptvf->vfid = mbx.data;\n\t\tdev_dbg(&cptvf->pdev->dev, \"Received VFID %d\\n\", cptvf->vfid);\n\t\tbreak;\n\t}\n\tcase CPT_MSG_QBIND_GRP:\n\t\tcptvf->pf_acked = true;\n\t\tcptvf->vftype = mbx.data;\n\t\tdev_dbg(&cptvf->pdev->dev, \"VF %d type %s group %d\\n\",\n\t\t\tcptvf->vfid, ((mbx.data == SE_TYPES) ? \"SE\" : \"AE\"),\n\t\t\tcptvf->vfgrp);\n\t\tbreak;\n\tcase CPT_MBOX_MSG_TYPE_ACK:\n\t\tcptvf->pf_acked = true;\n\t\tbreak;\n\tcase CPT_MBOX_MSG_TYPE_NACK:\n\t\tcptvf->pf_nacked = true;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&cptvf->pdev->dev, \"Invalid msg from PF, msg 0x%llx\\n\",\n\t\t\tmbx.msg);\n\t\tbreak;\n\t}\n}\n\nstatic int cptvf_send_msg_to_pf_timeout(struct cpt_vf *cptvf,\n\t\t\t\t\tstruct cpt_mbox *mbx)\n{\n\tint timeout = CPT_MBOX_MSG_TIMEOUT;\n\tint sleep = 10;\n\n\tcptvf->pf_acked = false;\n\tcptvf->pf_nacked = false;\n\tcptvf_send_msg_to_pf(cptvf, mbx);\n\t \n\twhile (!cptvf->pf_acked) {\n\t\tif (cptvf->pf_nacked)\n\t\t\treturn -EINVAL;\n\t\tmsleep(sleep);\n\t\tif (cptvf->pf_acked)\n\t\t\tbreak;\n\t\ttimeout -= sleep;\n\t\tif (!timeout) {\n\t\t\tdev_err(&cptvf->pdev->dev, \"PF didn't ack to mbox msg %llx from VF%u\\n\",\n\t\t\t\t(mbx->msg & 0xFF), cptvf->vfid);\n\t\t\treturn -EBUSY;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n \nint cptvf_check_pf_ready(struct cpt_vf *cptvf)\n{\n\tstruct pci_dev *pdev = cptvf->pdev;\n\tstruct cpt_mbox mbx = {};\n\n\tmbx.msg = CPT_MSG_READY;\n\tif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\n\t\tdev_err(&pdev->dev, \"PF didn't respond to READY msg\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\treturn 0;\n}\n\n \nint cptvf_send_vq_size_msg(struct cpt_vf *cptvf)\n{\n\tstruct pci_dev *pdev = cptvf->pdev;\n\tstruct cpt_mbox mbx = {};\n\n\tmbx.msg = CPT_MSG_QLEN;\n\tmbx.data = cptvf->qsize;\n\tif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\n\t\tdev_err(&pdev->dev, \"PF didn't respond to vq_size msg\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\treturn 0;\n}\n\n \nint cptvf_send_vf_to_grp_msg(struct cpt_vf *cptvf)\n{\n\tstruct pci_dev *pdev = cptvf->pdev;\n\tstruct cpt_mbox mbx = {};\n\n\tmbx.msg = CPT_MSG_QBIND_GRP;\n\t \n\tmbx.data = cptvf->vfgrp;\n\tif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\n\t\tdev_err(&pdev->dev, \"PF didn't respond to vf_type msg\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\treturn 0;\n}\n\n \nint cptvf_send_vf_priority_msg(struct cpt_vf *cptvf)\n{\n\tstruct pci_dev *pdev = cptvf->pdev;\n\tstruct cpt_mbox mbx = {};\n\n\tmbx.msg = CPT_MSG_VQ_PRIORITY;\n\t \n\tmbx.data = cptvf->priority;\n\tif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\n\t\tdev_err(&pdev->dev, \"PF didn't respond to vf_type msg\\n\");\n\t\treturn -EBUSY;\n\t}\n\treturn 0;\n}\n\n \nint cptvf_send_vf_up(struct cpt_vf *cptvf)\n{\n\tstruct pci_dev *pdev = cptvf->pdev;\n\tstruct cpt_mbox mbx = {};\n\n\tmbx.msg = CPT_MSG_VF_UP;\n\tif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\n\t\tdev_err(&pdev->dev, \"PF didn't respond to UP msg\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\treturn 0;\n}\n\n \nint cptvf_send_vf_down(struct cpt_vf *cptvf)\n{\n\tstruct pci_dev *pdev = cptvf->pdev;\n\tstruct cpt_mbox mbx = {};\n\n\tmbx.msg = CPT_MSG_VF_DOWN;\n\tif (cptvf_send_msg_to_pf_timeout(cptvf, &mbx)) {\n\t\tdev_err(&pdev->dev, \"PF didn't respond to DOWN msg\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}