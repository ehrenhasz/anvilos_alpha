{
  "module_name": "adf_pfvf_vf_msg.c",
  "hash_id": "486caf4072d39c3350235719257883c9eb847caa9a036490c0e822d913617734",
  "original_prompt": "Ingested from linux-6.6.14/drivers/crypto/intel/qat/qat_common/adf_pfvf_vf_msg.c",
  "human_readable_source": "\n \n#include <linux/bitfield.h>\n#include \"adf_accel_devices.h\"\n#include \"adf_common_drv.h\"\n#include \"adf_pfvf_msg.h\"\n#include \"adf_pfvf_vf_msg.h\"\n#include \"adf_pfvf_vf_proto.h\"\n\n \nint adf_vf2pf_notify_init(struct adf_accel_dev *accel_dev)\n{\n\tstruct pfvf_message msg = { .type = ADF_VF2PF_MSGTYPE_INIT };\n\n\tif (adf_send_vf2pf_msg(accel_dev, msg)) {\n\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\"Failed to send Init event to PF\\n\");\n\t\treturn -EFAULT;\n\t}\n\tset_bit(ADF_STATUS_PF_RUNNING, &accel_dev->status);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(adf_vf2pf_notify_init);\n\n \nvoid adf_vf2pf_notify_shutdown(struct adf_accel_dev *accel_dev)\n{\n\tstruct pfvf_message msg = { .type = ADF_VF2PF_MSGTYPE_SHUTDOWN };\n\n\tif (test_bit(ADF_STATUS_PF_RUNNING, &accel_dev->status))\n\t\tif (adf_send_vf2pf_msg(accel_dev, msg))\n\t\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\t\"Failed to send Shutdown event to PF\\n\");\n}\nEXPORT_SYMBOL_GPL(adf_vf2pf_notify_shutdown);\n\nint adf_vf2pf_request_version(struct adf_accel_dev *accel_dev)\n{\n\tu8 pf_version;\n\tint compat;\n\tint ret;\n\tstruct pfvf_message resp;\n\tstruct pfvf_message msg = {\n\t\t.type = ADF_VF2PF_MSGTYPE_COMPAT_VER_REQ,\n\t\t.data = ADF_PFVF_COMPAT_THIS_VERSION,\n\t};\n\n\tBUILD_BUG_ON(ADF_PFVF_COMPAT_THIS_VERSION > 255);\n\n\tret = adf_send_vf2pf_req(accel_dev, msg, &resp);\n\tif (ret) {\n\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\"Failed to send Compatibility Version Request.\\n\");\n\t\treturn ret;\n\t}\n\n\tpf_version = FIELD_GET(ADF_PF2VF_VERSION_RESP_VERS_MASK, resp.data);\n\tcompat = FIELD_GET(ADF_PF2VF_VERSION_RESP_RESULT_MASK, resp.data);\n\n\t \n\tswitch (compat) {\n\tcase ADF_PF2VF_VF_COMPATIBLE:\n\t\tbreak;\n\tcase ADF_PF2VF_VF_COMPAT_UNKNOWN:\n\t\t \n\t\tbreak;\n\tcase ADF_PF2VF_VF_INCOMPATIBLE:\n\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\"PF (vers %d) and VF (vers %d) are not compatible\\n\",\n\t\t\tpf_version, ADF_PFVF_COMPAT_THIS_VERSION);\n\t\treturn -EINVAL;\n\tdefault:\n\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\"Invalid response from PF; assume not compatible\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\taccel_dev->vf.pf_compat_ver = pf_version;\n\treturn 0;\n}\n\nint adf_vf2pf_get_capabilities(struct adf_accel_dev *accel_dev)\n{\n\tstruct adf_hw_device_data *hw_data = accel_dev->hw_device;\n\tstruct capabilities_v3 cap_msg = { 0 };\n\tunsigned int len = sizeof(cap_msg);\n\n\tif (accel_dev->vf.pf_compat_ver < ADF_PFVF_COMPAT_CAPABILITIES)\n\t\t \n\t\treturn 0;\n\n\tif (adf_send_vf2pf_blkmsg_req(accel_dev, ADF_VF2PF_BLKMSG_REQ_CAP_SUMMARY,\n\t\t\t\t      (u8 *)&cap_msg, &len)) {\n\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\"QAT: Failed to get block message response\\n\");\n\t\treturn -EFAULT;\n\t}\n\n\tswitch (cap_msg.hdr.version) {\n\tdefault:\n\t\t \n\t\tfallthrough;\n\tcase ADF_PFVF_CAPABILITIES_V3_VERSION:\n\t\tif (likely(len >= sizeof(struct capabilities_v3)))\n\t\t\thw_data->clock_frequency = cap_msg.frequency;\n\t\telse\n\t\t\tdev_info(&GET_DEV(accel_dev), \"Could not get frequency\");\n\t\tfallthrough;\n\tcase ADF_PFVF_CAPABILITIES_V2_VERSION:\n\t\tif (likely(len >= sizeof(struct capabilities_v2)))\n\t\t\thw_data->accel_capabilities_mask = cap_msg.capabilities;\n\t\telse\n\t\t\tdev_info(&GET_DEV(accel_dev), \"Could not get capabilities\");\n\t\tfallthrough;\n\tcase ADF_PFVF_CAPABILITIES_V1_VERSION:\n\t\tif (likely(len >= sizeof(struct capabilities_v1))) {\n\t\t\thw_data->extended_dc_capabilities = cap_msg.ext_dc_caps;\n\t\t} else {\n\t\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\t\"Capabilities message truncated to %d bytes\\n\", len);\n\t\t\treturn -EFAULT;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint adf_vf2pf_get_ring_to_svc(struct adf_accel_dev *accel_dev)\n{\n\tstruct ring_to_svc_map_v1 rts_map_msg = { 0 };\n\tunsigned int len = sizeof(rts_map_msg);\n\n\tif (accel_dev->vf.pf_compat_ver < ADF_PFVF_COMPAT_RING_TO_SVC_MAP)\n\t\t \n\t\treturn 0;\n\n\tif (adf_send_vf2pf_blkmsg_req(accel_dev, ADF_VF2PF_BLKMSG_REQ_RING_SVC_MAP,\n\t\t\t\t      (u8 *)&rts_map_msg, &len)) {\n\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\"QAT: Failed to get block message response\\n\");\n\t\treturn -EFAULT;\n\t}\n\n\tif (unlikely(len < sizeof(struct ring_to_svc_map_v1))) {\n\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\"RING_TO_SVC message truncated to %d bytes\\n\", len);\n\t\treturn -EFAULT;\n\t}\n\n\t \n\taccel_dev->hw_device->ring_to_svc_map = rts_map_msg.map;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}