{
  "module_name": "adf_gen4_pfvf.c",
  "hash_id": "069cb1f27643573a348ad6eb0a6a1ae26151fa7015283330a3f9b03130f1e4b1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/crypto/intel/qat/qat_common/adf_gen4_pfvf.c",
  "human_readable_source": "\n \n#include <linux/iopoll.h>\n#include <linux/mutex.h>\n#include <linux/types.h>\n#include \"adf_accel_devices.h\"\n#include \"adf_common_drv.h\"\n#include \"adf_gen4_pfvf.h\"\n#include \"adf_pfvf_pf_proto.h\"\n#include \"adf_pfvf_utils.h\"\n\n#define ADF_4XXX_PF2VM_OFFSET(i)\t(0x40B010 + ((i) * 0x20))\n#define ADF_4XXX_VM2PF_OFFSET(i)\t(0x40B014 + ((i) * 0x20))\n\n \n#define ADF_4XXX_VM2PF_SOU\t\t0x41A180\n#define ADF_4XXX_VM2PF_MSK\t\t0x41A1C0\n#define ADF_GEN4_VF_MSK\t\t\t0xFFFF\n\n#define ADF_PFVF_GEN4_MSGTYPE_SHIFT\t2\n#define ADF_PFVF_GEN4_MSGTYPE_MASK\t0x3F\n#define ADF_PFVF_GEN4_MSGDATA_SHIFT\t8\n#define ADF_PFVF_GEN4_MSGDATA_MASK\t0xFFFFFF\n\nstatic const struct pfvf_csr_format csr_gen4_fmt = {\n\t{ ADF_PFVF_GEN4_MSGTYPE_SHIFT, ADF_PFVF_GEN4_MSGTYPE_MASK },\n\t{ ADF_PFVF_GEN4_MSGDATA_SHIFT, ADF_PFVF_GEN4_MSGDATA_MASK },\n};\n\nstatic u32 adf_gen4_pf_get_pf2vf_offset(u32 i)\n{\n\treturn ADF_4XXX_PF2VM_OFFSET(i);\n}\n\nstatic u32 adf_gen4_pf_get_vf2pf_offset(u32 i)\n{\n\treturn ADF_4XXX_VM2PF_OFFSET(i);\n}\n\nstatic void adf_gen4_enable_vf2pf_interrupts(void __iomem *pmisc_addr, u32 vf_mask)\n{\n\tu32 val;\n\n\tval = ADF_CSR_RD(pmisc_addr, ADF_4XXX_VM2PF_MSK) & ~vf_mask;\n\tADF_CSR_WR(pmisc_addr, ADF_4XXX_VM2PF_MSK, val);\n}\n\nstatic void adf_gen4_disable_all_vf2pf_interrupts(void __iomem *pmisc_addr)\n{\n\tADF_CSR_WR(pmisc_addr, ADF_4XXX_VM2PF_MSK, ADF_GEN4_VF_MSK);\n}\n\nstatic u32 adf_gen4_disable_pending_vf2pf_interrupts(void __iomem *pmisc_addr)\n{\n\tu32 sources, disabled, pending;\n\n\t \n\tsources = ADF_CSR_RD(pmisc_addr, ADF_4XXX_VM2PF_SOU);\n\tif (!sources)\n\t\treturn 0;\n\n\t \n\tdisabled = ADF_CSR_RD(pmisc_addr, ADF_4XXX_VM2PF_MSK);\n\n\tpending = sources & ~disabled;\n\tif (!pending)\n\t\treturn 0;\n\n\t \n\tADF_CSR_WR(pmisc_addr, ADF_4XXX_VM2PF_MSK, ADF_GEN4_VF_MSK);\n\tADF_CSR_WR(pmisc_addr, ADF_4XXX_VM2PF_MSK, disabled | sources);\n\n\t \n\treturn pending;\n}\n\nstatic int adf_gen4_pfvf_send(struct adf_accel_dev *accel_dev,\n\t\t\t      struct pfvf_message msg, u32 pfvf_offset,\n\t\t\t      struct mutex *csr_lock)\n{\n\tvoid __iomem *pmisc_addr = adf_get_pmisc_base(accel_dev);\n\tu32 csr_val;\n\tint ret;\n\n\tcsr_val = adf_pfvf_csr_msg_of(accel_dev, msg, &csr_gen4_fmt);\n\tif (unlikely(!csr_val))\n\t\treturn -EINVAL;\n\n\tmutex_lock(csr_lock);\n\n\tADF_CSR_WR(pmisc_addr, pfvf_offset, csr_val | ADF_PFVF_INT);\n\n\t \n\tret = read_poll_timeout(ADF_CSR_RD, csr_val, !(csr_val & ADF_PFVF_INT),\n\t\t\t\tADF_PFVF_MSG_ACK_DELAY_US,\n\t\t\t\tADF_PFVF_MSG_ACK_MAX_DELAY_US,\n\t\t\t\ttrue, pmisc_addr, pfvf_offset);\n\tif (ret < 0)\n\t\tdev_dbg(&GET_DEV(accel_dev), \"ACK not received from remote\\n\");\n\n\tmutex_unlock(csr_lock);\n\treturn ret;\n}\n\nstatic struct pfvf_message adf_gen4_pfvf_recv(struct adf_accel_dev *accel_dev,\n\t\t\t\t\t      u32 pfvf_offset, u8 compat_ver)\n{\n\tvoid __iomem *pmisc_addr = adf_get_pmisc_base(accel_dev);\n\tstruct pfvf_message msg = { 0 };\n\tu32 csr_val;\n\n\t \n\tcsr_val = ADF_CSR_RD(pmisc_addr, pfvf_offset);\n\tif (!(csr_val & ADF_PFVF_INT)) {\n\t\tdev_info(&GET_DEV(accel_dev),\n\t\t\t \"Spurious PFVF interrupt, msg 0x%.8x. Ignored\\n\", csr_val);\n\t\treturn msg;\n\t}\n\n\t \n\tADF_CSR_WR(pmisc_addr, pfvf_offset, csr_val & ~ADF_PFVF_INT);\n\n\t \n\treturn adf_pfvf_message_of(accel_dev, csr_val, &csr_gen4_fmt);\n}\n\nvoid adf_gen4_init_pf_pfvf_ops(struct adf_pfvf_ops *pfvf_ops)\n{\n\tpfvf_ops->enable_comms = adf_enable_pf2vf_comms;\n\tpfvf_ops->get_pf2vf_offset = adf_gen4_pf_get_pf2vf_offset;\n\tpfvf_ops->get_vf2pf_offset = adf_gen4_pf_get_vf2pf_offset;\n\tpfvf_ops->enable_vf2pf_interrupts = adf_gen4_enable_vf2pf_interrupts;\n\tpfvf_ops->disable_all_vf2pf_interrupts = adf_gen4_disable_all_vf2pf_interrupts;\n\tpfvf_ops->disable_pending_vf2pf_interrupts = adf_gen4_disable_pending_vf2pf_interrupts;\n\tpfvf_ops->send_msg = adf_gen4_pfvf_send;\n\tpfvf_ops->recv_msg = adf_gen4_pfvf_recv;\n}\nEXPORT_SYMBOL_GPL(adf_gen4_init_pf_pfvf_ops);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}