{
  "module_name": "adf_accel_engine.c",
  "hash_id": "346c75a658a7c571531798a4b331d136ef11ccf9ef5c6a7939055325ce14c53c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/crypto/intel/qat/qat_common/adf_accel_engine.c",
  "human_readable_source": "\n \n#include <linux/firmware.h>\n#include <linux/pci.h>\n#include \"adf_cfg.h\"\n#include \"adf_accel_devices.h\"\n#include \"adf_common_drv.h\"\n#include \"icp_qat_uclo.h\"\n\nstatic int adf_ae_fw_load_images(struct adf_accel_dev *accel_dev, void *fw_addr,\n\t\t\t\t u32 fw_size)\n{\n\tstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\n\tstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\n\tstruct icp_qat_fw_loader_handle *loader;\n\tconst char *obj_name;\n\tu32 num_objs;\n\tu32 ae_mask;\n\tint i;\n\n\tloader = loader_data->fw_loader;\n\tnum_objs = hw_device->uof_get_num_objs();\n\n\tfor (i = 0; i < num_objs; i++) {\n\t\tobj_name = hw_device->uof_get_name(accel_dev, i);\n\t\tae_mask = hw_device->uof_get_ae_mask(accel_dev, i);\n\t\tif (!obj_name || !ae_mask) {\n\t\t\tdev_err(&GET_DEV(accel_dev), \"Invalid UOF image\\n\");\n\t\t\tgoto out_err;\n\t\t}\n\n\t\tif (qat_uclo_set_cfg_ae_mask(loader, ae_mask)) {\n\t\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\t\"Invalid mask for UOF image\\n\");\n\t\t\tgoto out_err;\n\t\t}\n\t\tif (qat_uclo_map_obj(loader, fw_addr, fw_size, obj_name)) {\n\t\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\t\"Failed to map UOF firmware\\n\");\n\t\t\tgoto out_err;\n\t\t}\n\t\tif (qat_uclo_wr_all_uimage(loader)) {\n\t\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\t\"Failed to load UOF firmware\\n\");\n\t\t\tgoto out_err;\n\t\t}\n\t\tqat_uclo_del_obj(loader);\n\t}\n\n\treturn 0;\n\nout_err:\n\tadf_ae_fw_release(accel_dev);\n\treturn -EFAULT;\n}\n\nint adf_ae_fw_load(struct adf_accel_dev *accel_dev)\n{\n\tstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\n\tstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\n\tvoid *fw_addr, *mmp_addr;\n\tu32 fw_size, mmp_size;\n\n\tif (!hw_device->fw_name)\n\t\treturn 0;\n\n\tif (request_firmware(&loader_data->mmp_fw, hw_device->fw_mmp_name,\n\t\t\t     &accel_dev->accel_pci_dev.pci_dev->dev)) {\n\t\tdev_err(&GET_DEV(accel_dev), \"Failed to load MMP firmware %s\\n\",\n\t\t\thw_device->fw_mmp_name);\n\t\treturn -EFAULT;\n\t}\n\tif (request_firmware(&loader_data->uof_fw, hw_device->fw_name,\n\t\t\t     &accel_dev->accel_pci_dev.pci_dev->dev)) {\n\t\tdev_err(&GET_DEV(accel_dev), \"Failed to load UOF firmware %s\\n\",\n\t\t\thw_device->fw_name);\n\t\tgoto out_err;\n\t}\n\n\tfw_size = loader_data->uof_fw->size;\n\tfw_addr = (void *)loader_data->uof_fw->data;\n\tmmp_size = loader_data->mmp_fw->size;\n\tmmp_addr = (void *)loader_data->mmp_fw->data;\n\n\tif (qat_uclo_wr_mimage(loader_data->fw_loader, mmp_addr, mmp_size)) {\n\t\tdev_err(&GET_DEV(accel_dev), \"Failed to load MMP\\n\");\n\t\tgoto out_err;\n\t}\n\n\tif (hw_device->uof_get_num_objs)\n\t\treturn adf_ae_fw_load_images(accel_dev, fw_addr, fw_size);\n\n\tif (qat_uclo_map_obj(loader_data->fw_loader, fw_addr, fw_size, NULL)) {\n\t\tdev_err(&GET_DEV(accel_dev), \"Failed to map FW\\n\");\n\t\tgoto out_err;\n\t}\n\tif (qat_uclo_wr_all_uimage(loader_data->fw_loader)) {\n\t\tdev_err(&GET_DEV(accel_dev), \"Failed to load UOF\\n\");\n\t\tgoto out_err;\n\t}\n\treturn 0;\n\nout_err:\n\tadf_ae_fw_release(accel_dev);\n\treturn -EFAULT;\n}\n\nvoid adf_ae_fw_release(struct adf_accel_dev *accel_dev)\n{\n\tstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\n\tstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\n\n\tif (!hw_device->fw_name)\n\t\treturn;\n\n\tqat_uclo_del_obj(loader_data->fw_loader);\n\tqat_hal_deinit(loader_data->fw_loader);\n\trelease_firmware(loader_data->uof_fw);\n\trelease_firmware(loader_data->mmp_fw);\n\tloader_data->uof_fw = NULL;\n\tloader_data->mmp_fw = NULL;\n\tloader_data->fw_loader = NULL;\n}\n\nint adf_ae_start(struct adf_accel_dev *accel_dev)\n{\n\tstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\n\tstruct adf_hw_device_data *hw_data = accel_dev->hw_device;\n\tu32 ae_ctr;\n\n\tif (!hw_data->fw_name)\n\t\treturn 0;\n\n\tae_ctr = qat_hal_start(loader_data->fw_loader);\n\tdev_info(&GET_DEV(accel_dev),\n\t\t \"qat_dev%d started %d acceleration engines\\n\",\n\t\t accel_dev->accel_id, ae_ctr);\n\treturn 0;\n}\n\nint adf_ae_stop(struct adf_accel_dev *accel_dev)\n{\n\tstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\n\tstruct adf_hw_device_data *hw_data = accel_dev->hw_device;\n\tu32 ae_ctr, ae, max_aes = GET_MAX_ACCELENGINES(accel_dev);\n\n\tif (!hw_data->fw_name)\n\t\treturn 0;\n\n\tfor (ae = 0, ae_ctr = 0; ae < max_aes; ae++) {\n\t\tif (hw_data->ae_mask & (1 << ae)) {\n\t\t\tqat_hal_stop(loader_data->fw_loader, ae, 0xFF);\n\t\t\tae_ctr++;\n\t\t}\n\t}\n\tdev_info(&GET_DEV(accel_dev),\n\t\t \"qat_dev%d stopped %d acceleration engines\\n\",\n\t\t accel_dev->accel_id, ae_ctr);\n\treturn 0;\n}\n\nstatic int adf_ae_reset(struct adf_accel_dev *accel_dev, int ae)\n{\n\tstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\n\n\tqat_hal_reset(loader_data->fw_loader);\n\tif (qat_hal_clr_reset(loader_data->fw_loader))\n\t\treturn -EFAULT;\n\n\treturn 0;\n}\n\nint adf_ae_init(struct adf_accel_dev *accel_dev)\n{\n\tstruct adf_fw_loader_data *loader_data;\n\tstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\n\n\tif (!hw_device->fw_name)\n\t\treturn 0;\n\n\tloader_data = kzalloc(sizeof(*loader_data), GFP_KERNEL);\n\tif (!loader_data)\n\t\treturn -ENOMEM;\n\n\taccel_dev->fw_loader = loader_data;\n\tif (qat_hal_init(accel_dev)) {\n\t\tdev_err(&GET_DEV(accel_dev), \"Failed to init the AEs\\n\");\n\t\tkfree(loader_data);\n\t\treturn -EFAULT;\n\t}\n\tif (adf_ae_reset(accel_dev, 0)) {\n\t\tdev_err(&GET_DEV(accel_dev), \"Failed to reset the AEs\\n\");\n\t\tqat_hal_deinit(loader_data->fw_loader);\n\t\tkfree(loader_data);\n\t\treturn -EFAULT;\n\t}\n\treturn 0;\n}\n\nint adf_ae_shutdown(struct adf_accel_dev *accel_dev)\n{\n\tstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\n\tstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\n\n\tif (!hw_device->fw_name)\n\t\treturn 0;\n\n\tqat_hal_deinit(loader_data->fw_loader);\n\tkfree(accel_dev->fw_loader);\n\taccel_dev->fw_loader = NULL;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}