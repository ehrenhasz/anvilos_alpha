{
  "module_name": "adf_heartbeat_dbgfs.c",
  "hash_id": "41a61bd7f805cd41a3b5e16e5b422daa47e63148fd34dd699ed4554b7ba4e65e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/crypto/intel/qat/qat_common/adf_heartbeat_dbgfs.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/errno.h>\n#include <linux/export.h>\n#include <linux/fs.h>\n#include <linux/kernel.h>\n#include <linux/kstrtox.h>\n#include <linux/types.h>\n#include \"adf_cfg.h\"\n#include \"adf_common_drv.h\"\n#include \"adf_heartbeat.h\"\n#include \"adf_heartbeat_dbgfs.h\"\n\n#define HB_OK 0\n#define HB_ERROR -1\n#define HB_STATUS_MAX_STRLEN 4\n#define HB_STATS_MAX_STRLEN 16\n\nstatic ssize_t adf_hb_stats_read(struct file *file, char __user *user_buffer,\n\t\t\t\t size_t count, loff_t *ppos)\n{\n\tchar buf[HB_STATS_MAX_STRLEN];\n\tunsigned int *value;\n\tint len;\n\n\tif (*ppos > 0)\n\t\treturn 0;\n\n\tvalue = file->private_data;\n\tlen = scnprintf(buf, sizeof(buf), \"%u\\n\", *value);\n\n\treturn simple_read_from_buffer(user_buffer, count, ppos, buf, len + 1);\n}\n\nstatic const struct file_operations adf_hb_stats_fops = {\n\t.owner = THIS_MODULE,\n\t.open = simple_open,\n\t.read = adf_hb_stats_read,\n};\n\nstatic ssize_t adf_hb_status_read(struct file *file, char __user *user_buf,\n\t\t\t\t  size_t count, loff_t *ppos)\n{\n\tenum adf_device_heartbeat_status hb_status;\n\tchar ret_str[HB_STATUS_MAX_STRLEN];\n\tstruct adf_accel_dev *accel_dev;\n\tint ret_code;\n\tsize_t len;\n\n\tif (*ppos > 0)\n\t\treturn 0;\n\n\taccel_dev = file->private_data;\n\tret_code = HB_OK;\n\n\tadf_heartbeat_status(accel_dev, &hb_status);\n\n\tif (hb_status != HB_DEV_ALIVE)\n\t\tret_code = HB_ERROR;\n\n\tlen = scnprintf(ret_str, sizeof(ret_str), \"%d\\n\", ret_code);\n\n\treturn simple_read_from_buffer(user_buf, count, ppos, ret_str, len + 1);\n}\n\nstatic const struct file_operations adf_hb_status_fops = {\n\t.owner = THIS_MODULE,\n\t.open = simple_open,\n\t.read = adf_hb_status_read,\n};\n\nstatic ssize_t adf_hb_cfg_read(struct file *file, char __user *user_buf,\n\t\t\t       size_t count, loff_t *ppos)\n{\n\tchar timer_str[ADF_CFG_MAX_VAL_LEN_IN_BYTES];\n\tstruct adf_accel_dev *accel_dev;\n\tunsigned int timer_ms;\n\tint len;\n\n\tif (*ppos > 0)\n\t\treturn 0;\n\n\taccel_dev = file->private_data;\n\ttimer_ms = accel_dev->heartbeat->hb_timer;\n\tlen = scnprintf(timer_str, sizeof(timer_str), \"%u\\n\", timer_ms);\n\n\treturn simple_read_from_buffer(user_buf, count, ppos, timer_str,\n\t\t\t\t       len + 1);\n}\n\nstatic ssize_t adf_hb_cfg_write(struct file *file, const char __user *user_buf,\n\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tchar input_str[ADF_CFG_MAX_VAL_LEN_IN_BYTES] = { };\n\tstruct adf_accel_dev *accel_dev;\n\tint ret, written_chars;\n\tunsigned int timer_ms;\n\tu32 ticks;\n\n\taccel_dev = file->private_data;\n\ttimer_ms = ADF_CFG_HB_TIMER_DEFAULT_MS;\n\n\t \n\tif (count > sizeof(input_str) - 1)\n\t\treturn -EINVAL;\n\n\twritten_chars = simple_write_to_buffer(input_str, sizeof(input_str) - 1,\n\t\t\t\t\t       ppos, user_buf, count);\n\tif (written_chars > 0) {\n\t\tret = kstrtouint(input_str, 10, &timer_ms);\n\t\tif (ret) {\n\t\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\t\"heartbeat_cfg: Invalid value\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (timer_ms < ADF_CFG_HB_TIMER_MIN_MS) {\n\t\t\tdev_err(&GET_DEV(accel_dev),\n\t\t\t\t\"heartbeat_cfg: Invalid value\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tif (accel_dev->timer)\n\t\t\ttimer_ms = ADF_CFG_HB_TIMER_MIN_MS;\n\n\t\tret = adf_heartbeat_save_cfg_param(accel_dev, timer_ms);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = adf_heartbeat_ms_to_ticks(accel_dev, timer_ms, &ticks);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = adf_send_admin_hb_timer(accel_dev, ticks);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\taccel_dev->heartbeat->hb_timer = timer_ms;\n\t}\n\n\treturn written_chars;\n}\n\nstatic const struct file_operations adf_hb_cfg_fops = {\n\t.owner = THIS_MODULE,\n\t.open = simple_open,\n\t.read = adf_hb_cfg_read,\n\t.write = adf_hb_cfg_write,\n};\n\nvoid adf_heartbeat_dbgfs_add(struct adf_accel_dev *accel_dev)\n{\n\tstruct adf_heartbeat *hb = accel_dev->heartbeat;\n\n\tif (!hb)\n\t\treturn;\n\n\thb->dbgfs.base_dir = debugfs_create_dir(\"heartbeat\", accel_dev->debugfs_dir);\n\thb->dbgfs.status = debugfs_create_file(\"status\", 0400, hb->dbgfs.base_dir,\n\t\t\t\t\t       accel_dev, &adf_hb_status_fops);\n\thb->dbgfs.sent = debugfs_create_file(\"queries_sent\", 0400, hb->dbgfs.base_dir,\n\t\t\t\t\t     &hb->hb_sent_counter, &adf_hb_stats_fops);\n\thb->dbgfs.failed = debugfs_create_file(\"queries_failed\", 0400, hb->dbgfs.base_dir,\n\t\t\t\t\t       &hb->hb_failed_counter, &adf_hb_stats_fops);\n\thb->dbgfs.cfg = debugfs_create_file(\"config\", 0600, hb->dbgfs.base_dir,\n\t\t\t\t\t    accel_dev, &adf_hb_cfg_fops);\n}\nEXPORT_SYMBOL_GPL(adf_heartbeat_dbgfs_add);\n\nvoid adf_heartbeat_dbgfs_rm(struct adf_accel_dev *accel_dev)\n{\n\tstruct adf_heartbeat *hb = accel_dev->heartbeat;\n\n\tif (!hb)\n\t\treturn;\n\n\tdebugfs_remove(hb->dbgfs.status);\n\thb->dbgfs.status = NULL;\n\tdebugfs_remove(hb->dbgfs.sent);\n\thb->dbgfs.sent = NULL;\n\tdebugfs_remove(hb->dbgfs.failed);\n\thb->dbgfs.failed = NULL;\n\tdebugfs_remove(hb->dbgfs.cfg);\n\thb->dbgfs.cfg = NULL;\n\tdebugfs_remove(hb->dbgfs.base_dir);\n\thb->dbgfs.base_dir = NULL;\n}\nEXPORT_SYMBOL_GPL(adf_heartbeat_dbgfs_rm);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}