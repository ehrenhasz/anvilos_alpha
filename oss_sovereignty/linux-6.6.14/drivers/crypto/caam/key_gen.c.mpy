{
  "module_name": "key_gen.c",
  "hash_id": "c839a8f46acd0add676f9c7ecb17c492680c68527e3d173b42c72f6af8c393b6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/crypto/caam/key_gen.c",
  "human_readable_source": "\n \n#include \"compat.h\"\n#include \"jr.h\"\n#include \"error.h\"\n#include \"desc_constr.h\"\n#include \"key_gen.h\"\n\nvoid split_key_done(struct device *dev, u32 *desc, u32 err,\n\t\t\t   void *context)\n{\n\tstruct split_key_result *res = context;\n\tint ecode = 0;\n\n\tdev_dbg(dev, \"%s %d: err 0x%x\\n\", __func__, __LINE__, err);\n\n\tif (err)\n\t\tecode = caam_jr_strstatus(dev, err);\n\n\tres->err = ecode;\n\n\tcomplete(&res->completion);\n}\nEXPORT_SYMBOL(split_key_done);\n \nint gen_split_key(struct device *jrdev, u8 *key_out,\n\t\t  struct alginfo * const adata, const u8 *key_in, u32 keylen,\n\t\t  int max_keylen)\n{\n\tu32 *desc;\n\tstruct split_key_result result;\n\tdma_addr_t dma_addr;\n\tunsigned int local_max;\n\tint ret = -ENOMEM;\n\n\tadata->keylen = split_key_len(adata->algtype & OP_ALG_ALGSEL_MASK);\n\tadata->keylen_pad = split_key_pad_len(adata->algtype &\n\t\t\t\t\t      OP_ALG_ALGSEL_MASK);\n\tlocal_max = max(keylen, adata->keylen_pad);\n\n\tdev_dbg(jrdev, \"split keylen %d split keylen padded %d\\n\",\n\t\tadata->keylen, adata->keylen_pad);\n\tprint_hex_dump_debug(\"ctx.key@\" __stringify(__LINE__)\": \",\n\t\t\t     DUMP_PREFIX_ADDRESS, 16, 4, key_in, keylen, 1);\n\n\tif (local_max > max_keylen)\n\t\treturn -EINVAL;\n\n\tdesc = kmalloc(CAAM_CMD_SZ * 6 + CAAM_PTR_SZ * 2, GFP_KERNEL);\n\tif (!desc) {\n\t\tdev_err(jrdev, \"unable to allocate key input memory\\n\");\n\t\treturn ret;\n\t}\n\n\tmemcpy(key_out, key_in, keylen);\n\n\tdma_addr = dma_map_single(jrdev, key_out, local_max, DMA_BIDIRECTIONAL);\n\tif (dma_mapping_error(jrdev, dma_addr)) {\n\t\tdev_err(jrdev, \"unable to map key memory\\n\");\n\t\tgoto out_free;\n\t}\n\n\tinit_job_desc(desc, 0);\n\tappend_key(desc, dma_addr, keylen, CLASS_2 | KEY_DEST_CLASS_REG);\n\n\t \n\tappend_operation(desc, (adata->algtype & OP_ALG_ALGSEL_MASK) |\n\t\t\t OP_ALG_AAI_HMAC | OP_TYPE_CLASS2_ALG | OP_ALG_DECRYPT |\n\t\t\t OP_ALG_AS_INIT);\n\n\t \n\tappend_fifo_load_as_imm(desc, NULL, 0, LDST_CLASS_2_CCB |\n\t\t\t\tFIFOLD_TYPE_MSG | FIFOLD_TYPE_LAST2);\n\n\t \n\tappend_fifo_store(desc, dma_addr, adata->keylen,\n\t\t\t  LDST_CLASS_2_CCB | FIFOST_TYPE_SPLIT_KEK);\n\n\tprint_hex_dump_debug(\"jobdesc@\"__stringify(__LINE__)\": \",\n\t\t\t     DUMP_PREFIX_ADDRESS, 16, 4, desc, desc_bytes(desc),\n\t\t\t     1);\n\n\tresult.err = 0;\n\tinit_completion(&result.completion);\n\n\tret = caam_jr_enqueue(jrdev, desc, split_key_done, &result);\n\tif (ret == -EINPROGRESS) {\n\t\t \n\t\twait_for_completion(&result.completion);\n\t\tret = result.err;\n\n\t\tprint_hex_dump_debug(\"ctx.key@\"__stringify(__LINE__)\": \",\n\t\t\t\t     DUMP_PREFIX_ADDRESS, 16, 4, key_out,\n\t\t\t\t     adata->keylen_pad, 1);\n\t}\n\n\tdma_unmap_single(jrdev, dma_addr, local_max, DMA_BIDIRECTIONAL);\nout_free:\n\tkfree(desc);\n\treturn ret;\n}\nEXPORT_SYMBOL(gen_split_key);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}