{
  "module_name": "cc_fips.c",
  "hash_id": "7ad20a5be17ca94977b8b165a39b1c6f5c6ba3a4da11b2d82a14337cbcaf9fb7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/crypto/ccree/cc_fips.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/fips.h>\n#include <linux/notifier.h>\n\n#include \"cc_driver.h\"\n#include \"cc_fips.h\"\n\nstatic void fips_dsr(unsigned long devarg);\n\nstruct cc_fips_handle {\n\tstruct tasklet_struct tasklet;\n\tstruct notifier_block nb;\n\tstruct cc_drvdata *drvdata;\n};\n\n \nstatic bool cc_get_tee_fips_status(struct cc_drvdata *drvdata)\n{\n\tu32 reg;\n\n\treg = cc_ioread(drvdata, CC_REG(GPR_HOST));\n\t \n\tif (reg & CC_FIPS_SYNC_TEE_STATUS)\n\t\t \n\t\treturn (reg & CC_FIPS_SYNC_MODULE_OK);\n\n\t \n\treturn true;\n}\n\n \nvoid cc_set_ree_fips_status(struct cc_drvdata *drvdata, bool status)\n{\n\tint val = CC_FIPS_SYNC_REE_STATUS;\n\n\tif (drvdata->hw_rev < CC_HW_REV_712)\n\t\treturn;\n\n\tval |= (status ? CC_FIPS_SYNC_MODULE_OK : CC_FIPS_SYNC_MODULE_ERROR);\n\n\tcc_iowrite(drvdata, CC_REG(HOST_GPR0), val);\n}\n\n \nstatic int cc_ree_fips_failure(struct notifier_block *nb, unsigned long unused1,\n\t\t\t       void *unused2)\n{\n\tstruct cc_fips_handle *fips_h =\n\t\t\t\tcontainer_of(nb, struct cc_fips_handle, nb);\n\tstruct cc_drvdata *drvdata = fips_h->drvdata;\n\tstruct device *dev = drvdata_to_dev(drvdata);\n\n\tcc_set_ree_fips_status(drvdata, false);\n\tdev_info(dev, \"Notifying TEE of FIPS test failure...\\n\");\n\n\treturn NOTIFY_OK;\n}\n\nvoid cc_fips_fini(struct cc_drvdata *drvdata)\n{\n\tstruct cc_fips_handle *fips_h = drvdata->fips_handle;\n\n\tif (drvdata->hw_rev < CC_HW_REV_712 || !fips_h)\n\t\treturn;\n\n\tatomic_notifier_chain_unregister(&fips_fail_notif_chain, &fips_h->nb);\n\n\t \n\ttasklet_kill(&fips_h->tasklet);\n\tdrvdata->fips_handle = NULL;\n}\n\nvoid fips_handler(struct cc_drvdata *drvdata)\n{\n\tstruct cc_fips_handle *fips_handle_ptr = drvdata->fips_handle;\n\n\tif (drvdata->hw_rev < CC_HW_REV_712)\n\t\treturn;\n\n\ttasklet_schedule(&fips_handle_ptr->tasklet);\n}\n\nstatic inline void tee_fips_error(struct device *dev)\n{\n\tif (fips_enabled)\n\t\tpanic(\"ccree: TEE reported cryptographic error in fips mode!\\n\");\n\telse\n\t\tdev_err(dev, \"TEE reported error!\\n\");\n}\n\n \nvoid cc_tee_handle_fips_error(struct cc_drvdata *p_drvdata)\n{\n\tstruct device *dev = drvdata_to_dev(p_drvdata);\n\n\tif (!cc_get_tee_fips_status(p_drvdata))\n\t\ttee_fips_error(dev);\n}\n\n \nstatic void fips_dsr(unsigned long devarg)\n{\n\tstruct cc_drvdata *drvdata = (struct cc_drvdata *)devarg;\n\tu32 irq, val;\n\n\tirq = (drvdata->irq & (CC_GPR0_IRQ_MASK));\n\n\tif (irq) {\n\t\tcc_tee_handle_fips_error(drvdata);\n\t}\n\n\t \n\tval = (CC_REG(HOST_IMR) & ~irq);\n\tcc_iowrite(drvdata, CC_REG(HOST_IMR), val);\n}\n\n \nint cc_fips_init(struct cc_drvdata *p_drvdata)\n{\n\tstruct cc_fips_handle *fips_h;\n\tstruct device *dev = drvdata_to_dev(p_drvdata);\n\n\tif (p_drvdata->hw_rev < CC_HW_REV_712)\n\t\treturn 0;\n\n\tfips_h = devm_kzalloc(dev, sizeof(*fips_h), GFP_KERNEL);\n\tif (!fips_h)\n\t\treturn -ENOMEM;\n\n\tp_drvdata->fips_handle = fips_h;\n\n\tdev_dbg(dev, \"Initializing fips tasklet\\n\");\n\ttasklet_init(&fips_h->tasklet, fips_dsr, (unsigned long)p_drvdata);\n\tfips_h->drvdata = p_drvdata;\n\tfips_h->nb.notifier_call = cc_ree_fips_failure;\n\tatomic_notifier_chain_register(&fips_fail_notif_chain, &fips_h->nb);\n\n\tcc_tee_handle_fips_error(p_drvdata);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}