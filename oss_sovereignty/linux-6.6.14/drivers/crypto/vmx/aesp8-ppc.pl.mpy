{
  "module_name": "aesp8-ppc.pl",
  "hash_id": "b4b78bf6d0d5c416060f0d9bb2be7a6a64dc182fa8410d5ea9caf4c79c325147",
  "original_prompt": "Ingested from linux-6.6.14/drivers/crypto/vmx/aesp8-ppc.pl",
  "human_readable_source": "#! /usr/bin/env perl\n# SPDX-License-Identifier: GPL-2.0\n\n# This code is taken from CRYPTOGAMs[1] and is included here using the option\n# in the license to distribute the code under the GPL. Therefore this program\n# is free software; you can redistribute it and/or modify it under the terms of\n# the GNU General Public License version 2 as published by the Free Software\n# Foundation.\n#\n# [1] https://www.openssl.org/~appro/cryptogams/\n\n# Copyright (c) 2006-2017, CRYPTOGAMS by <appro@openssl.org>\n# All rights reserved.\n#\n# Redistribution and use in source and binary forms, with or without\n# modification, are permitted provided that the following conditions\n# are met:\n#\n#       * Redistributions of source code must retain copyright notices,\n#         this list of conditions and the following disclaimer.\n#\n#       * Redistributions in binary form must reproduce the above\n#         copyright notice, this list of conditions and the following\n#         disclaimer in the documentation and/or other materials\n#         provided with the distribution.\n#\n#       * Neither the name of the CRYPTOGAMS nor the names of its\n#         copyright holder and contributors may be used to endorse or\n#         promote products derived from this software without specific\n#         prior written permission.\n#\n# ALTERNATIVELY, provided that this notice is retained in full, this\n# product may be distributed under the terms of the GNU General Public\n# License (GPL), in which case the provisions of the GPL apply INSTEAD OF\n# those given above.\n#\n# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER AND CONTRIBUTORS\n# \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n# OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n# LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n\n# ====================================================================\n# Written by Andy Polyakov <appro@openssl.org> for the OpenSSL\n# project. The module is, however, dual licensed under OpenSSL and\n# CRYPTOGAMS licenses depending on where you obtain it. For further\n# details see https://www.openssl.org/~appro/cryptogams/.\n# ====================================================================\n#\n# This module implements support for AES instructions as per PowerISA\n# specification version 2.07, first implemented by POWER8 processor.\n# The module is endian-agnostic in sense that it supports both big-\n# and little-endian cases. Data alignment in parallelizable modes is\n# handled with VSX loads and stores, which implies MSR.VSX flag being\n# set. It should also be noted that ISA specification doesn't prohibit\n# alignment exceptions for these instructions on page boundaries.\n# Initially alignment was handled in pure AltiVec/VMX way [when data\n# is aligned programmatically, which in turn guarantees exception-\n# free execution], but it turned to hamper performance when vcipher\n# instructions are interleaved. It's reckoned that eventual\n# misalignment penalties at page boundaries are in average lower\n# than additional overhead in pure AltiVec approach.\n#\n# May 2016\n#\n# Add XTS subroutine, 9x on little- and 12x improvement on big-endian\n# systems were measured.\n#\n######################################################################\n# Current large-block performance in cycles per byte processed with\n# 128-bit key (less is better).\n#\n#\t\tCBC en-/decrypt\tCTR\tXTS\n# POWER8[le]\t3.96/0.72\t0.74\t1.1\n# POWER8[be]\t3.75/0.65\t0.66\t1.0\n\n$flavour = shift;\n\nif ($flavour =~ /64/) {\n\t$SIZE_T\t=8;\n\t$LRSAVE\t=2*$SIZE_T;\n\t$STU\t=\"stdu\";\n\t$POP\t=\"ld\";\n\t$PUSH\t=\"std\";\n\t$UCMP\t=\"cmpld\";\n\t$SHL\t=\"sldi\";\n} elsif ($flavour =~ /32/) {\n\t$SIZE_T\t=4;\n\t$LRSAVE\t=$SIZE_T;\n\t$STU\t=\"stwu\";\n\t$POP\t=\"lwz\";\n\t$PUSH\t=\"stw\";\n\t$UCMP\t=\"cmplw\";\n\t$SHL\t=\"slwi\";\n} else { die \"nonsense $flavour\"; }\n\n$LITTLE_ENDIAN = ($flavour=~/le$/) ? $SIZE_T : 0;\n\n$0 =~ m/(.*[\\/\\\\])[^\\/\\\\]+$/; $dir=$1;\n( $xlate=\"${dir}ppc-xlate.pl\" and -f $xlate ) or\n( $xlate=\"${dir}../../perlasm/ppc-xlate.pl\" and -f $xlate) or\ndie \"can't locate ppc-xlate.pl\";\n\nopen STDOUT,\"| $^X $xlate $flavour \".shift || die \"can't call $xlate: $!\";\n\n$FRAME=8*$SIZE_T;\n$prefix=\"aes_p8\";\n\n$sp=\"r1\";\n$vrsave=\"r12\";\n\n#########################################################################\n{{{\t# Key setup procedures\t\t\t\t\t\t#\nmy ($inp,$bits,$out,$ptr,$cnt,$rounds)=map(\"r$_\",(3..8));\nmy ($zero,$in0,$in1,$key,$rcon,$mask,$tmp)=map(\"v$_\",(0..6));\nmy ($stage,$outperm,$outmask,$outhead,$outtail)=map(\"v$_\",(7..11));\n\n$code.=<<___;\n.machine\t\"any\"\n\n.text\n\n.align\t7\nrcon:\n.long\t0x01000000, 0x01000000, 0x01000000, 0x01000000\t?rev\n.long\t0x1b000000, 0x1b000000, 0x1b000000, 0x1b000000\t?rev\n.long\t0x0d0e0f0c, 0x0d0e0f0c, 0x0d0e0f0c, 0x0d0e0f0c\t?rev\n.long\t0,0,0,0\t\t\t\t\t\t?asis\nLconsts:\n\tmflr\tr0\n\tbcl\t20,31,\\$+4\n\tmflr\t$ptr\t #vvvvv \"distance between . and rcon\n\taddi\t$ptr,$ptr,-0x48\n\tmtlr\tr0\n\tblr\n\t.long\t0\n\t.byte\t0,12,0x14,0,0,0,0,0\n.asciz\t\"AES for PowerISA 2.07, CRYPTOGAMS by <appro\\@openssl.org>\"\n\n.globl\t.${prefix}_set_encrypt_key\nLset_encrypt_key:\n\tmflr\t\tr11\n\t$PUSH\t\tr11,$LRSAVE($sp)\n\n\tli\t\t$ptr,-1\n\t${UCMP}i\t$inp,0\n\tbeq-\t\tLenc_key_abort\t\t# if ($inp==0) return -1;\n\t${UCMP}i\t$out,0\n\tbeq-\t\tLenc_key_abort\t\t# if ($out==0) return -1;\n\tli\t\t$ptr,-2\n\tcmpwi\t\t$bits,128\n\tblt-\t\tLenc_key_abort\n\tcmpwi\t\t$bits,256\n\tbgt-\t\tLenc_key_abort\n\tandi.\t\tr0,$bits,0x3f\n\tbne-\t\tLenc_key_abort\n\n\tlis\t\tr0,0xfff0\n\tmfspr\t\t$vrsave,256\n\tmtspr\t\t256,r0\n\n\tbl\t\tLconsts\n\tmtlr\t\tr11\n\n\tneg\t\tr9,$inp\n\tlvx\t\t$in0,0,$inp\n\taddi\t\t$inp,$inp,15\t\t# 15 is not typo\n\tlvsr\t\t$key,0,r9\t\t# borrow $key\n\tli\t\tr8,0x20\n\tcmpwi\t\t$bits,192\n\tlvx\t\t$in1,0,$inp\n\tle?vspltisb\t$mask,0x0f\t\t# borrow $mask\n\tlvx\t\t$rcon,0,$ptr\n\tle?vxor\t\t$key,$key,$mask\t\t# adjust for byte swap\n\tlvx\t\t$mask,r8,$ptr\n\taddi\t\t$ptr,$ptr,0x10\n\tvperm\t\t$in0,$in0,$in1,$key\t# align [and byte swap in LE]\n\tli\t\t$cnt,8\n\tvxor\t\t$zero,$zero,$zero\n\tmtctr\t\t$cnt\n\n\t?lvsr\t\t$outperm,0,$out\n\tvspltisb\t$outmask,-1\n\tlvx\t\t$outhead,0,$out\n\t?vperm\t\t$outmask,$zero,$outmask,$outperm\n\n\tblt\t\tLoop128\n\taddi\t\t$inp,$inp,8\n\tbeq\t\tL192\n\taddi\t\t$inp,$inp,8\n\tb\t\tL256\n\n.align\t4\nLoop128:\n\tvperm\t\t$key,$in0,$in0,$mask\t# rotate-n-splat\n\tvsldoi\t\t$tmp,$zero,$in0,12\t# >>32\n\t vperm\t\t$outtail,$in0,$in0,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\tvcipherlast\t$key,$key,$rcon\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$out,$out,16\n\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\t vadduwm\t$rcon,$rcon,$rcon\n\tvxor\t\t$in0,$in0,$key\n\tbdnz\t\tLoop128\n\n\tlvx\t\t$rcon,0,$ptr\t\t# last two round keys\n\n\tvperm\t\t$key,$in0,$in0,$mask\t# rotate-n-splat\n\tvsldoi\t\t$tmp,$zero,$in0,12\t# >>32\n\t vperm\t\t$outtail,$in0,$in0,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\tvcipherlast\t$key,$key,$rcon\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$out,$out,16\n\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\t vadduwm\t$rcon,$rcon,$rcon\n\tvxor\t\t$in0,$in0,$key\n\n\tvperm\t\t$key,$in0,$in0,$mask\t# rotate-n-splat\n\tvsldoi\t\t$tmp,$zero,$in0,12\t# >>32\n\t vperm\t\t$outtail,$in0,$in0,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\tvcipherlast\t$key,$key,$rcon\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$out,$out,16\n\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\tvxor\t\t$in0,$in0,$key\n\t vperm\t\t$outtail,$in0,$in0,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\t stvx\t\t$stage,0,$out\n\n\taddi\t\t$inp,$out,15\t\t# 15 is not typo\n\taddi\t\t$out,$out,0x50\n\n\tli\t\t$rounds,10\n\tb\t\tLdone\n\n.align\t4\nL192:\n\tlvx\t\t$tmp,0,$inp\n\tli\t\t$cnt,4\n\t vperm\t\t$outtail,$in0,$in0,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$out,$out,16\n\tvperm\t\t$in1,$in1,$tmp,$key\t# align [and byte swap in LE]\n\tvspltisb\t$key,8\t\t\t# borrow $key\n\tmtctr\t\t$cnt\n\tvsububm\t\t$mask,$mask,$key\t# adjust the mask\n\nLoop192:\n\tvperm\t\t$key,$in1,$in1,$mask\t# roate-n-splat\n\tvsldoi\t\t$tmp,$zero,$in0,12\t# >>32\n\tvcipherlast\t$key,$key,$rcon\n\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\n\t vsldoi\t\t$stage,$zero,$in1,8\n\tvspltw\t\t$tmp,$in0,3\n\tvxor\t\t$tmp,$tmp,$in1\n\tvsldoi\t\t$in1,$zero,$in1,12\t# >>32\n\t vadduwm\t$rcon,$rcon,$rcon\n\tvxor\t\t$in1,$in1,$tmp\n\tvxor\t\t$in0,$in0,$key\n\tvxor\t\t$in1,$in1,$key\n\t vsldoi\t\t$stage,$stage,$in0,8\n\n\tvperm\t\t$key,$in1,$in1,$mask\t# rotate-n-splat\n\tvsldoi\t\t$tmp,$zero,$in0,12\t# >>32\n\t vperm\t\t$outtail,$stage,$stage,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\tvcipherlast\t$key,$key,$rcon\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$out,$out,16\n\n\t vsldoi\t\t$stage,$in0,$in1,8\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\t vperm\t\t$outtail,$stage,$stage,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$out,$out,16\n\n\tvspltw\t\t$tmp,$in0,3\n\tvxor\t\t$tmp,$tmp,$in1\n\tvsldoi\t\t$in1,$zero,$in1,12\t# >>32\n\t vadduwm\t$rcon,$rcon,$rcon\n\tvxor\t\t$in1,$in1,$tmp\n\tvxor\t\t$in0,$in0,$key\n\tvxor\t\t$in1,$in1,$key\n\t vperm\t\t$outtail,$in0,$in0,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$inp,$out,15\t\t# 15 is not typo\n\t addi\t\t$out,$out,16\n\tbdnz\t\tLoop192\n\n\tli\t\t$rounds,12\n\taddi\t\t$out,$out,0x20\n\tb\t\tLdone\n\n.align\t4\nL256:\n\tlvx\t\t$tmp,0,$inp\n\tli\t\t$cnt,7\n\tli\t\t$rounds,14\n\t vperm\t\t$outtail,$in0,$in0,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$out,$out,16\n\tvperm\t\t$in1,$in1,$tmp,$key\t# align [and byte swap in LE]\n\tmtctr\t\t$cnt\n\nLoop256:\n\tvperm\t\t$key,$in1,$in1,$mask\t# rotate-n-splat\n\tvsldoi\t\t$tmp,$zero,$in0,12\t# >>32\n\t vperm\t\t$outtail,$in1,$in1,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\tvcipherlast\t$key,$key,$rcon\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$out,$out,16\n\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in0,$in0,$tmp\n\t vadduwm\t$rcon,$rcon,$rcon\n\tvxor\t\t$in0,$in0,$key\n\t vperm\t\t$outtail,$in0,$in0,$outperm\t# rotate\n\t vsel\t\t$stage,$outhead,$outtail,$outmask\n\t vmr\t\t$outhead,$outtail\n\t stvx\t\t$stage,0,$out\n\t addi\t\t$inp,$out,15\t\t# 15 is not typo\n\t addi\t\t$out,$out,16\n\tbdz\t\tLdone\n\n\tvspltw\t\t$key,$in0,3\t\t# just splat\n\tvsldoi\t\t$tmp,$zero,$in1,12\t# >>32\n\tvsbox\t\t$key,$key\n\n\tvxor\t\t$in1,$in1,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in1,$in1,$tmp\n\tvsldoi\t\t$tmp,$zero,$tmp,12\t# >>32\n\tvxor\t\t$in1,$in1,$tmp\n\n\tvxor\t\t$in1,$in1,$key\n\tb\t\tLoop256\n\n.align\t4\nLdone:\n\tlvx\t\t$in1,0,$inp\t\t# redundant in aligned case\n\tvsel\t\t$in1,$outhead,$in1,$outmask\n\tstvx\t\t$in1,0,$inp\n\tli\t\t$ptr,0\n\tmtspr\t\t256,$vrsave\n\tstw\t\t$rounds,0($out)\n\nLenc_key_abort:\n\tmr\t\tr3,$ptr\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x14,1,0,0,3,0\n\t.long\t\t0\n.size\t.${prefix}_set_encrypt_key,.-.${prefix}_set_encrypt_key\n\n.globl\t.${prefix}_set_decrypt_key\n\t$STU\t\t$sp,-$FRAME($sp)\n\tmflr\t\tr10\n\t$PUSH\t\tr10,$FRAME+$LRSAVE($sp)\n\tbl\t\tLset_encrypt_key\n\tmtlr\t\tr10\n\n\tcmpwi\t\tr3,0\n\tbne-\t\tLdec_key_abort\n\n\tslwi\t\t$cnt,$rounds,4\n\tsubi\t\t$inp,$out,240\t\t# first round key\n\tsrwi\t\t$rounds,$rounds,1\n\tadd\t\t$out,$inp,$cnt\t\t# last round key\n\tmtctr\t\t$rounds\n\nLdeckey:\n\tlwz\t\tr0, 0($inp)\n\tlwz\t\tr6, 4($inp)\n\tlwz\t\tr7, 8($inp)\n\tlwz\t\tr8, 12($inp)\n\taddi\t\t$inp,$inp,16\n\tlwz\t\tr9, 0($out)\n\tlwz\t\tr10,4($out)\n\tlwz\t\tr11,8($out)\n\tlwz\t\tr12,12($out)\n\tstw\t\tr0, 0($out)\n\tstw\t\tr6, 4($out)\n\tstw\t\tr7, 8($out)\n\tstw\t\tr8, 12($out)\n\tsubi\t\t$out,$out,16\n\tstw\t\tr9, -16($inp)\n\tstw\t\tr10,-12($inp)\n\tstw\t\tr11,-8($inp)\n\tstw\t\tr12,-4($inp)\n\tbdnz\t\tLdeckey\n\n\txor\t\tr3,r3,r3\t\t# return value\nLdec_key_abort:\n\taddi\t\t$sp,$sp,$FRAME\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,4,1,0x80,0,3,0\n\t.long\t\t0\n.size\t.${prefix}_set_decrypt_key,.-.${prefix}_set_decrypt_key\n___\n}}}\n#########################################################################\n{{{\t# Single block en- and decrypt procedures\t\t\t#\nsub gen_block () {\nmy $dir = shift;\nmy $n   = $dir eq \"de\" ? \"n\" : \"\";\nmy ($inp,$out,$key,$rounds,$idx)=map(\"r$_\",(3..7));\n\n$code.=<<___;\n.globl\t.${prefix}_${dir}crypt\n\tlwz\t\t$rounds,240($key)\n\tlis\t\tr0,0xfc00\n\tmfspr\t\t$vrsave,256\n\tli\t\t$idx,15\t\t\t# 15 is not typo\n\tmtspr\t\t256,r0\n\n\tlvx\t\tv0,0,$inp\n\tneg\t\tr11,$out\n\tlvx\t\tv1,$idx,$inp\n\tlvsl\t\tv2,0,$inp\t\t# inpperm\n\tle?vspltisb\tv4,0x0f\n\t?lvsl\t\tv3,0,r11\t\t# outperm\n\tle?vxor\t\tv2,v2,v4\n\tli\t\t$idx,16\n\tvperm\t\tv0,v0,v1,v2\t\t# align [and byte swap in LE]\n\tlvx\t\tv1,0,$key\n\t?lvsl\t\tv5,0,$key\t\t# keyperm\n\tsrwi\t\t$rounds,$rounds,1\n\tlvx\t\tv2,$idx,$key\n\taddi\t\t$idx,$idx,16\n\tsubi\t\t$rounds,$rounds,1\n\t?vperm\t\tv1,v1,v2,v5\t\t# align round key\n\n\tvxor\t\tv0,v0,v1\n\tlvx\t\tv1,$idx,$key\n\taddi\t\t$idx,$idx,16\n\tmtctr\t\t$rounds\n\nLoop_${dir}c:\n\t?vperm\t\tv2,v2,v1,v5\n\tv${n}cipher\tv0,v0,v2\n\tlvx\t\tv2,$idx,$key\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\tv1,v1,v2,v5\n\tv${n}cipher\tv0,v0,v1\n\tlvx\t\tv1,$idx,$key\n\taddi\t\t$idx,$idx,16\n\tbdnz\t\tLoop_${dir}c\n\n\t?vperm\t\tv2,v2,v1,v5\n\tv${n}cipher\tv0,v0,v2\n\tlvx\t\tv2,$idx,$key\n\t?vperm\t\tv1,v1,v2,v5\n\tv${n}cipherlast\tv0,v0,v1\n\n\tvspltisb\tv2,-1\n\tvxor\t\tv1,v1,v1\n\tli\t\t$idx,15\t\t\t# 15 is not typo\n\t?vperm\t\tv2,v1,v2,v3\t\t# outmask\n\tle?vxor\t\tv3,v3,v4\n\tlvx\t\tv1,0,$out\t\t# outhead\n\tvperm\t\tv0,v0,v0,v3\t\t# rotate [and byte swap in LE]\n\tvsel\t\tv1,v1,v0,v2\n\tlvx\t\tv4,$idx,$out\n\tstvx\t\tv1,0,$out\n\tvsel\t\tv0,v0,v4,v2\n\tstvx\t\tv0,$idx,$out\n\n\tmtspr\t\t256,$vrsave\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x14,0,0,0,3,0\n\t.long\t\t0\n.size\t.${prefix}_${dir}crypt,.-.${prefix}_${dir}crypt\n___\n}\n&gen_block(\"en\");\n&gen_block(\"de\");\n}}}\n#########################################################################\n{{{\t# CBC en- and decrypt procedures\t\t\t\t#\nmy ($inp,$out,$len,$key,$ivp,$enc,$rounds,$idx)=map(\"r$_\",(3..10));\nmy ($rndkey0,$rndkey1,$inout,$tmp)=\t\tmap(\"v$_\",(0..3));\nmy ($ivec,$inptail,$inpperm,$outhead,$outperm,$outmask,$keyperm)=\n\t\t\t\t\t\tmap(\"v$_\",(4..10));\n$code.=<<___;\n.globl\t.${prefix}_cbc_encrypt\n\t${UCMP}i\t$len,16\n\tbltlr-\n\n\tcmpwi\t\t$enc,0\t\t\t# test direction\n\tlis\t\tr0,0xffe0\n\tmfspr\t\t$vrsave,256\n\tmtspr\t\t256,r0\n\n\tli\t\t$idx,15\n\tvxor\t\t$rndkey0,$rndkey0,$rndkey0\n\tle?vspltisb\t$tmp,0x0f\n\n\tlvx\t\t$ivec,0,$ivp\t\t# load [unaligned] iv\n\tlvsl\t\t$inpperm,0,$ivp\n\tlvx\t\t$inptail,$idx,$ivp\n\tle?vxor\t\t$inpperm,$inpperm,$tmp\n\tvperm\t\t$ivec,$ivec,$inptail,$inpperm\n\n\tneg\t\tr11,$inp\n\t?lvsl\t\t$keyperm,0,$key\t\t# prepare for unaligned key\n\tlwz\t\t$rounds,240($key)\n\n\tlvsr\t\t$inpperm,0,r11\t\t# prepare for unaligned load\n\tlvx\t\t$inptail,0,$inp\n\taddi\t\t$inp,$inp,15\t\t# 15 is not typo\n\tle?vxor\t\t$inpperm,$inpperm,$tmp\n\n\t?lvsr\t\t$outperm,0,$out\t\t# prepare for unaligned store\n\tvspltisb\t$outmask,-1\n\tlvx\t\t$outhead,0,$out\n\t?vperm\t\t$outmask,$rndkey0,$outmask,$outperm\n\tle?vxor\t\t$outperm,$outperm,$tmp\n\n\tsrwi\t\t$rounds,$rounds,1\n\tli\t\t$idx,16\n\tsubi\t\t$rounds,$rounds,1\n\tbeq\t\tLcbc_dec\n\nLcbc_enc:\n\tvmr\t\t$inout,$inptail\n\tlvx\t\t$inptail,0,$inp\n\taddi\t\t$inp,$inp,16\n\tmtctr\t\t$rounds\n\tsubi\t\t$len,$len,16\t\t# len-=16\n\n\tlvx\t\t$rndkey0,0,$key\n\t vperm\t\t$inout,$inout,$inptail,$inpperm\n\tlvx\t\t$rndkey1,$idx,$key\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key\n\taddi\t\t$idx,$idx,16\n\tvxor\t\t$inout,$inout,$ivec\n\nLoop_cbc_enc:\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvcipher\t\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key\n\taddi\t\t$idx,$idx,16\n\tbdnz\t\tLoop_cbc_enc\n\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key\n\tli\t\t$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvcipherlast\t$ivec,$inout,$rndkey0\n\t${UCMP}i\t$len,16\n\n\tvperm\t\t$tmp,$ivec,$ivec,$outperm\n\tvsel\t\t$inout,$outhead,$tmp,$outmask\n\tvmr\t\t$outhead,$tmp\n\tstvx\t\t$inout,0,$out\n\taddi\t\t$out,$out,16\n\tbge\t\tLcbc_enc\n\n\tb\t\tLcbc_done\n\n.align\t4\nLcbc_dec:\n\t${UCMP}i\t$len,128\n\tbge\t\t_aesp8_cbc_decrypt8x\n\tvmr\t\t$tmp,$inptail\n\tlvx\t\t$inptail,0,$inp\n\taddi\t\t$inp,$inp,16\n\tmtctr\t\t$rounds\n\tsubi\t\t$len,$len,16\t\t# len-=16\n\n\tlvx\t\t$rndkey0,0,$key\n\t vperm\t\t$tmp,$tmp,$inptail,$inpperm\n\tlvx\t\t$rndkey1,$idx,$key\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$inout,$tmp,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key\n\taddi\t\t$idx,$idx,16\n\nLoop_cbc_dec:\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvncipher\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvncipher\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key\n\taddi\t\t$idx,$idx,16\n\tbdnz\t\tLoop_cbc_dec\n\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvncipher\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key\n\tli\t\t$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvncipherlast\t$inout,$inout,$rndkey0\n\t${UCMP}i\t$len,16\n\n\tvxor\t\t$inout,$inout,$ivec\n\tvmr\t\t$ivec,$tmp\n\tvperm\t\t$tmp,$inout,$inout,$outperm\n\tvsel\t\t$inout,$outhead,$tmp,$outmask\n\tvmr\t\t$outhead,$tmp\n\tstvx\t\t$inout,0,$out\n\taddi\t\t$out,$out,16\n\tbge\t\tLcbc_dec\n\nLcbc_done:\n\taddi\t\t$out,$out,-1\n\tlvx\t\t$inout,0,$out\t\t# redundant in aligned case\n\tvsel\t\t$inout,$outhead,$inout,$outmask\n\tstvx\t\t$inout,0,$out\n\n\tneg\t\t$enc,$ivp\t\t# write [unaligned] iv\n\tli\t\t$idx,15\t\t\t# 15 is not typo\n\tvxor\t\t$rndkey0,$rndkey0,$rndkey0\n\tvspltisb\t$outmask,-1\n\tle?vspltisb\t$tmp,0x0f\n\t?lvsl\t\t$outperm,0,$enc\n\t?vperm\t\t$outmask,$rndkey0,$outmask,$outperm\n\tle?vxor\t\t$outperm,$outperm,$tmp\n\tlvx\t\t$outhead,0,$ivp\n\tvperm\t\t$ivec,$ivec,$ivec,$outperm\n\tvsel\t\t$inout,$outhead,$ivec,$outmask\n\tlvx\t\t$inptail,$idx,$ivp\n\tstvx\t\t$inout,0,$ivp\n\tvsel\t\t$inout,$ivec,$inptail,$outmask\n\tstvx\t\t$inout,$idx,$ivp\n\n\tmtspr\t\t256,$vrsave\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x14,0,0,0,6,0\n\t.long\t\t0\n___\n#########################################################################\n{{\t# Optimized CBC decrypt procedure\t\t\t\t#\nmy $key_=\"r11\";\nmy ($x00,$x10,$x20,$x30,$x40,$x50,$x60,$x70)=map(\"r$_\",(0,8,26..31));\nmy ($in0, $in1, $in2, $in3, $in4, $in5, $in6, $in7 )=map(\"v$_\",(0..3,10..13));\nmy ($out0,$out1,$out2,$out3,$out4,$out5,$out6,$out7)=map(\"v$_\",(14..21));\nmy $rndkey0=\"v23\";\t# v24-v25 rotating buffer for first found keys\n\t\t\t# v26-v31 last 6 round keys\nmy ($tmp,$keyperm)=($in3,$in4);\t# aliases with \"caller\", redundant assignment\n\n$code.=<<___;\n.align\t5\n_aesp8_cbc_decrypt8x:\n\t$STU\t\t$sp,-`($FRAME+21*16+6*$SIZE_T)`($sp)\n\tli\t\tr10,`$FRAME+8*16+15`\n\tli\t\tr11,`$FRAME+8*16+31`\n\tstvx\t\tv20,r10,$sp\t\t# ABI says so\n\taddi\t\tr10,r10,32\n\tstvx\t\tv21,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv22,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\tv23,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv24,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\tv25,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv26,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\tv27,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv28,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\tv29,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv30,r10,$sp\n\tstvx\t\tv31,r11,$sp\n\tli\t\tr0,-1\n\tstw\t\t$vrsave,`$FRAME+21*16-4`($sp)\t# save vrsave\n\tli\t\t$x10,0x10\n\t$PUSH\t\tr26,`$FRAME+21*16+0*$SIZE_T`($sp)\n\tli\t\t$x20,0x20\n\t$PUSH\t\tr27,`$FRAME+21*16+1*$SIZE_T`($sp)\n\tli\t\t$x30,0x30\n\t$PUSH\t\tr28,`$FRAME+21*16+2*$SIZE_T`($sp)\n\tli\t\t$x40,0x40\n\t$PUSH\t\tr29,`$FRAME+21*16+3*$SIZE_T`($sp)\n\tli\t\t$x50,0x50\n\t$PUSH\t\tr30,`$FRAME+21*16+4*$SIZE_T`($sp)\n\tli\t\t$x60,0x60\n\t$PUSH\t\tr31,`$FRAME+21*16+5*$SIZE_T`($sp)\n\tli\t\t$x70,0x70\n\tmtspr\t\t256,r0\n\n\tsubi\t\t$rounds,$rounds,3\t# -4 in total\n\tsubi\t\t$len,$len,128\t\t# bias\n\n\tlvx\t\t$rndkey0,$x00,$key\t# load key schedule\n\tlvx\t\tv30,$x10,$key\n\taddi\t\t$key,$key,0x20\n\tlvx\t\tv31,$x00,$key\n\t?vperm\t\t$rndkey0,$rndkey0,v30,$keyperm\n\taddi\t\t$key_,$sp,$FRAME+15\n\tmtctr\t\t$rounds\n\nLoad_cbc_dec_key:\n\t?vperm\t\tv24,v30,v31,$keyperm\n\tlvx\t\tv30,$x10,$key\n\taddi\t\t$key,$key,0x20\n\tstvx\t\tv24,$x00,$key_\t\t# off-load round[1]\n\t?vperm\t\tv25,v31,v30,$keyperm\n\tlvx\t\tv31,$x00,$key\n\tstvx\t\tv25,$x10,$key_\t\t# off-load round[2]\n\taddi\t\t$key_,$key_,0x20\n\tbdnz\t\tLoad_cbc_dec_key\n\n\tlvx\t\tv26,$x10,$key\n\t?vperm\t\tv24,v30,v31,$keyperm\n\tlvx\t\tv27,$x20,$key\n\tstvx\t\tv24,$x00,$key_\t\t# off-load round[3]\n\t?vperm\t\tv25,v31,v26,$keyperm\n\tlvx\t\tv28,$x30,$key\n\tstvx\t\tv25,$x10,$key_\t\t# off-load round[4]\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\t?vperm\t\tv26,v26,v27,$keyperm\n\tlvx\t\tv29,$x40,$key\n\t?vperm\t\tv27,v27,v28,$keyperm\n\tlvx\t\tv30,$x50,$key\n\t?vperm\t\tv28,v28,v29,$keyperm\n\tlvx\t\tv31,$x60,$key\n\t?vperm\t\tv29,v29,v30,$keyperm\n\tlvx\t\t$out0,$x70,$key\t\t# borrow $out0\n\t?vperm\t\tv30,v30,v31,$keyperm\n\tlvx\t\tv24,$x00,$key_\t\t# pre-load round[1]\n\t?vperm\t\tv31,v31,$out0,$keyperm\n\tlvx\t\tv25,$x10,$key_\t\t# pre-load round[2]\n\n\t#lvx\t\t$inptail,0,$inp\t\t# \"caller\" already did this\n\t#addi\t\t$inp,$inp,15\t\t# 15 is not typo\n\tsubi\t\t$inp,$inp,15\t\t# undo \"caller\"\n\n\t le?li\t\t$idx,8\n\tlvx_u\t\t$in0,$x00,$inp\t\t# load first 8 \"words\"\n\t le?lvsl\t$inpperm,0,$idx\n\t le?vspltisb\t$tmp,0x0f\n\tlvx_u\t\t$in1,$x10,$inp\n\t le?vxor\t$inpperm,$inpperm,$tmp\t# transform for lvx_u/stvx_u\n\tlvx_u\t\t$in2,$x20,$inp\n\t le?vperm\t$in0,$in0,$in0,$inpperm\n\tlvx_u\t\t$in3,$x30,$inp\n\t le?vperm\t$in1,$in1,$in1,$inpperm\n\tlvx_u\t\t$in4,$x40,$inp\n\t le?vperm\t$in2,$in2,$in2,$inpperm\n\tvxor\t\t$out0,$in0,$rndkey0\n\tlvx_u\t\t$in5,$x50,$inp\n\t le?vperm\t$in3,$in3,$in3,$inpperm\n\tvxor\t\t$out1,$in1,$rndkey0\n\tlvx_u\t\t$in6,$x60,$inp\n\t le?vperm\t$in4,$in4,$in4,$inpperm\n\tvxor\t\t$out2,$in2,$rndkey0\n\tlvx_u\t\t$in7,$x70,$inp\n\taddi\t\t$inp,$inp,0x80\n\t le?vperm\t$in5,$in5,$in5,$inpperm\n\tvxor\t\t$out3,$in3,$rndkey0\n\t le?vperm\t$in6,$in6,$in6,$inpperm\n\tvxor\t\t$out4,$in4,$rndkey0\n\t le?vperm\t$in7,$in7,$in7,$inpperm\n\tvxor\t\t$out5,$in5,$rndkey0\n\tvxor\t\t$out6,$in6,$rndkey0\n\tvxor\t\t$out7,$in7,$rndkey0\n\n\tmtctr\t\t$rounds\n\tb\t\tLoop_cbc_dec8x\n.align\t5\nLoop_cbc_dec8x:\n\tvncipher\t$out0,$out0,v24\n\tvncipher\t$out1,$out1,v24\n\tvncipher\t$out2,$out2,v24\n\tvncipher\t$out3,$out3,v24\n\tvncipher\t$out4,$out4,v24\n\tvncipher\t$out5,$out5,v24\n\tvncipher\t$out6,$out6,v24\n\tvncipher\t$out7,$out7,v24\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvncipher\t$out0,$out0,v25\n\tvncipher\t$out1,$out1,v25\n\tvncipher\t$out2,$out2,v25\n\tvncipher\t$out3,$out3,v25\n\tvncipher\t$out4,$out4,v25\n\tvncipher\t$out5,$out5,v25\n\tvncipher\t$out6,$out6,v25\n\tvncipher\t$out7,$out7,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\tLoop_cbc_dec8x\n\n\tsubic\t\t$len,$len,128\t\t# $len-=128\n\tvncipher\t$out0,$out0,v24\n\tvncipher\t$out1,$out1,v24\n\tvncipher\t$out2,$out2,v24\n\tvncipher\t$out3,$out3,v24\n\tvncipher\t$out4,$out4,v24\n\tvncipher\t$out5,$out5,v24\n\tvncipher\t$out6,$out6,v24\n\tvncipher\t$out7,$out7,v24\n\n\tsubfe.\t\tr0,r0,r0\t\t# borrow?-1:0\n\tvncipher\t$out0,$out0,v25\n\tvncipher\t$out1,$out1,v25\n\tvncipher\t$out2,$out2,v25\n\tvncipher\t$out3,$out3,v25\n\tvncipher\t$out4,$out4,v25\n\tvncipher\t$out5,$out5,v25\n\tvncipher\t$out6,$out6,v25\n\tvncipher\t$out7,$out7,v25\n\n\tand\t\tr0,r0,$len\n\tvncipher\t$out0,$out0,v26\n\tvncipher\t$out1,$out1,v26\n\tvncipher\t$out2,$out2,v26\n\tvncipher\t$out3,$out3,v26\n\tvncipher\t$out4,$out4,v26\n\tvncipher\t$out5,$out5,v26\n\tvncipher\t$out6,$out6,v26\n\tvncipher\t$out7,$out7,v26\n\n\tadd\t\t$inp,$inp,r0\t\t# $inp is adjusted in such\n\t\t\t\t\t\t# way that at exit from the\n\t\t\t\t\t\t# loop inX-in7 are loaded\n\t\t\t\t\t\t# with last \"words\"\n\tvncipher\t$out0,$out0,v27\n\tvncipher\t$out1,$out1,v27\n\tvncipher\t$out2,$out2,v27\n\tvncipher\t$out3,$out3,v27\n\tvncipher\t$out4,$out4,v27\n\tvncipher\t$out5,$out5,v27\n\tvncipher\t$out6,$out6,v27\n\tvncipher\t$out7,$out7,v27\n\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\tvncipher\t$out0,$out0,v28\n\tvncipher\t$out1,$out1,v28\n\tvncipher\t$out2,$out2,v28\n\tvncipher\t$out3,$out3,v28\n\tvncipher\t$out4,$out4,v28\n\tvncipher\t$out5,$out5,v28\n\tvncipher\t$out6,$out6,v28\n\tvncipher\t$out7,$out7,v28\n\tlvx\t\tv24,$x00,$key_\t\t# re-pre-load round[1]\n\n\tvncipher\t$out0,$out0,v29\n\tvncipher\t$out1,$out1,v29\n\tvncipher\t$out2,$out2,v29\n\tvncipher\t$out3,$out3,v29\n\tvncipher\t$out4,$out4,v29\n\tvncipher\t$out5,$out5,v29\n\tvncipher\t$out6,$out6,v29\n\tvncipher\t$out7,$out7,v29\n\tlvx\t\tv25,$x10,$key_\t\t# re-pre-load round[2]\n\n\tvncipher\t$out0,$out0,v30\n\t vxor\t\t$ivec,$ivec,v31\t\t# xor with last round key\n\tvncipher\t$out1,$out1,v30\n\t vxor\t\t$in0,$in0,v31\n\tvncipher\t$out2,$out2,v30\n\t vxor\t\t$in1,$in1,v31\n\tvncipher\t$out3,$out3,v30\n\t vxor\t\t$in2,$in2,v31\n\tvncipher\t$out4,$out4,v30\n\t vxor\t\t$in3,$in3,v31\n\tvncipher\t$out5,$out5,v30\n\t vxor\t\t$in4,$in4,v31\n\tvncipher\t$out6,$out6,v30\n\t vxor\t\t$in5,$in5,v31\n\tvncipher\t$out7,$out7,v30\n\t vxor\t\t$in6,$in6,v31\n\n\tvncipherlast\t$out0,$out0,$ivec\n\tvncipherlast\t$out1,$out1,$in0\n\t lvx_u\t\t$in0,$x00,$inp\t\t# load next input block\n\tvncipherlast\t$out2,$out2,$in1\n\t lvx_u\t\t$in1,$x10,$inp\n\tvncipherlast\t$out3,$out3,$in2\n\t le?vperm\t$in0,$in0,$in0,$inpperm\n\t lvx_u\t\t$in2,$x20,$inp\n\tvncipherlast\t$out4,$out4,$in3\n\t le?vperm\t$in1,$in1,$in1,$inpperm\n\t lvx_u\t\t$in3,$x30,$inp\n\tvncipherlast\t$out5,$out5,$in4\n\t le?vperm\t$in2,$in2,$in2,$inpperm\n\t lvx_u\t\t$in4,$x40,$inp\n\tvncipherlast\t$out6,$out6,$in5\n\t le?vperm\t$in3,$in3,$in3,$inpperm\n\t lvx_u\t\t$in5,$x50,$inp\n\tvncipherlast\t$out7,$out7,$in6\n\t le?vperm\t$in4,$in4,$in4,$inpperm\n\t lvx_u\t\t$in6,$x60,$inp\n\tvmr\t\t$ivec,$in7\n\t le?vperm\t$in5,$in5,$in5,$inpperm\n\t lvx_u\t\t$in7,$x70,$inp\n\t addi\t\t$inp,$inp,0x80\n\n\tle?vperm\t$out0,$out0,$out0,$inpperm\n\tle?vperm\t$out1,$out1,$out1,$inpperm\n\tstvx_u\t\t$out0,$x00,$out\n\t le?vperm\t$in6,$in6,$in6,$inpperm\n\t vxor\t\t$out0,$in0,$rndkey0\n\tle?vperm\t$out2,$out2,$out2,$inpperm\n\tstvx_u\t\t$out1,$x10,$out\n\t le?vperm\t$in7,$in7,$in7,$inpperm\n\t vxor\t\t$out1,$in1,$rndkey0\n\tle?vperm\t$out3,$out3,$out3,$inpperm\n\tstvx_u\t\t$out2,$x20,$out\n\t vxor\t\t$out2,$in2,$rndkey0\n\tle?vperm\t$out4,$out4,$out4,$inpperm\n\tstvx_u\t\t$out3,$x30,$out\n\t vxor\t\t$out3,$in3,$rndkey0\n\tle?vperm\t$out5,$out5,$out5,$inpperm\n\tstvx_u\t\t$out4,$x40,$out\n\t vxor\t\t$out4,$in4,$rndkey0\n\tle?vperm\t$out6,$out6,$out6,$inpperm\n\tstvx_u\t\t$out5,$x50,$out\n\t vxor\t\t$out5,$in5,$rndkey0\n\tle?vperm\t$out7,$out7,$out7,$inpperm\n\tstvx_u\t\t$out6,$x60,$out\n\t vxor\t\t$out6,$in6,$rndkey0\n\tstvx_u\t\t$out7,$x70,$out\n\taddi\t\t$out,$out,0x80\n\t vxor\t\t$out7,$in7,$rndkey0\n\n\tmtctr\t\t$rounds\n\tbeq\t\tLoop_cbc_dec8x\t\t# did $len-=128 borrow?\n\n\taddic.\t\t$len,$len,128\n\tbeq\t\tLcbc_dec8x_done\n\tnop\n\tnop\n\nLoop_cbc_dec8x_tail:\t\t\t\t# up to 7 \"words\" tail...\n\tvncipher\t$out1,$out1,v24\n\tvncipher\t$out2,$out2,v24\n\tvncipher\t$out3,$out3,v24\n\tvncipher\t$out4,$out4,v24\n\tvncipher\t$out5,$out5,v24\n\tvncipher\t$out6,$out6,v24\n\tvncipher\t$out7,$out7,v24\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvncipher\t$out1,$out1,v25\n\tvncipher\t$out2,$out2,v25\n\tvncipher\t$out3,$out3,v25\n\tvncipher\t$out4,$out4,v25\n\tvncipher\t$out5,$out5,v25\n\tvncipher\t$out6,$out6,v25\n\tvncipher\t$out7,$out7,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\tLoop_cbc_dec8x_tail\n\n\tvncipher\t$out1,$out1,v24\n\tvncipher\t$out2,$out2,v24\n\tvncipher\t$out3,$out3,v24\n\tvncipher\t$out4,$out4,v24\n\tvncipher\t$out5,$out5,v24\n\tvncipher\t$out6,$out6,v24\n\tvncipher\t$out7,$out7,v24\n\n\tvncipher\t$out1,$out1,v25\n\tvncipher\t$out2,$out2,v25\n\tvncipher\t$out3,$out3,v25\n\tvncipher\t$out4,$out4,v25\n\tvncipher\t$out5,$out5,v25\n\tvncipher\t$out6,$out6,v25\n\tvncipher\t$out7,$out7,v25\n\n\tvncipher\t$out1,$out1,v26\n\tvncipher\t$out2,$out2,v26\n\tvncipher\t$out3,$out3,v26\n\tvncipher\t$out4,$out4,v26\n\tvncipher\t$out5,$out5,v26\n\tvncipher\t$out6,$out6,v26\n\tvncipher\t$out7,$out7,v26\n\n\tvncipher\t$out1,$out1,v27\n\tvncipher\t$out2,$out2,v27\n\tvncipher\t$out3,$out3,v27\n\tvncipher\t$out4,$out4,v27\n\tvncipher\t$out5,$out5,v27\n\tvncipher\t$out6,$out6,v27\n\tvncipher\t$out7,$out7,v27\n\n\tvncipher\t$out1,$out1,v28\n\tvncipher\t$out2,$out2,v28\n\tvncipher\t$out3,$out3,v28\n\tvncipher\t$out4,$out4,v28\n\tvncipher\t$out5,$out5,v28\n\tvncipher\t$out6,$out6,v28\n\tvncipher\t$out7,$out7,v28\n\n\tvncipher\t$out1,$out1,v29\n\tvncipher\t$out2,$out2,v29\n\tvncipher\t$out3,$out3,v29\n\tvncipher\t$out4,$out4,v29\n\tvncipher\t$out5,$out5,v29\n\tvncipher\t$out6,$out6,v29\n\tvncipher\t$out7,$out7,v29\n\n\tvncipher\t$out1,$out1,v30\n\t vxor\t\t$ivec,$ivec,v31\t\t# last round key\n\tvncipher\t$out2,$out2,v30\n\t vxor\t\t$in1,$in1,v31\n\tvncipher\t$out3,$out3,v30\n\t vxor\t\t$in2,$in2,v31\n\tvncipher\t$out4,$out4,v30\n\t vxor\t\t$in3,$in3,v31\n\tvncipher\t$out5,$out5,v30\n\t vxor\t\t$in4,$in4,v31\n\tvncipher\t$out6,$out6,v30\n\t vxor\t\t$in5,$in5,v31\n\tvncipher\t$out7,$out7,v30\n\t vxor\t\t$in6,$in6,v31\n\n\tcmplwi\t\t$len,32\t\t\t# switch($len)\n\tblt\t\tLcbc_dec8x_one\n\tnop\n\tbeq\t\tLcbc_dec8x_two\n\tcmplwi\t\t$len,64\n\tblt\t\tLcbc_dec8x_three\n\tnop\n\tbeq\t\tLcbc_dec8x_four\n\tcmplwi\t\t$len,96\n\tblt\t\tLcbc_dec8x_five\n\tnop\n\tbeq\t\tLcbc_dec8x_six\n\nLcbc_dec8x_seven:\n\tvncipherlast\t$out1,$out1,$ivec\n\tvncipherlast\t$out2,$out2,$in1\n\tvncipherlast\t$out3,$out3,$in2\n\tvncipherlast\t$out4,$out4,$in3\n\tvncipherlast\t$out5,$out5,$in4\n\tvncipherlast\t$out6,$out6,$in5\n\tvncipherlast\t$out7,$out7,$in6\n\tvmr\t\t$ivec,$in7\n\n\tle?vperm\t$out1,$out1,$out1,$inpperm\n\tle?vperm\t$out2,$out2,$out2,$inpperm\n\tstvx_u\t\t$out1,$x00,$out\n\tle?vperm\t$out3,$out3,$out3,$inpperm\n\tstvx_u\t\t$out2,$x10,$out\n\tle?vperm\t$out4,$out4,$out4,$inpperm\n\tstvx_u\t\t$out3,$x20,$out\n\tle?vperm\t$out5,$out5,$out5,$inpperm\n\tstvx_u\t\t$out4,$x30,$out\n\tle?vperm\t$out6,$out6,$out6,$inpperm\n\tstvx_u\t\t$out5,$x40,$out\n\tle?vperm\t$out7,$out7,$out7,$inpperm\n\tstvx_u\t\t$out6,$x50,$out\n\tstvx_u\t\t$out7,$x60,$out\n\taddi\t\t$out,$out,0x70\n\tb\t\tLcbc_dec8x_done\n\n.align\t5\nLcbc_dec8x_six:\n\tvncipherlast\t$out2,$out2,$ivec\n\tvncipherlast\t$out3,$out3,$in2\n\tvncipherlast\t$out4,$out4,$in3\n\tvncipherlast\t$out5,$out5,$in4\n\tvncipherlast\t$out6,$out6,$in5\n\tvncipherlast\t$out7,$out7,$in6\n\tvmr\t\t$ivec,$in7\n\n\tle?vperm\t$out2,$out2,$out2,$inpperm\n\tle?vperm\t$out3,$out3,$out3,$inpperm\n\tstvx_u\t\t$out2,$x00,$out\n\tle?vperm\t$out4,$out4,$out4,$inpperm\n\tstvx_u\t\t$out3,$x10,$out\n\tle?vperm\t$out5,$out5,$out5,$inpperm\n\tstvx_u\t\t$out4,$x20,$out\n\tle?vperm\t$out6,$out6,$out6,$inpperm\n\tstvx_u\t\t$out5,$x30,$out\n\tle?vperm\t$out7,$out7,$out7,$inpperm\n\tstvx_u\t\t$out6,$x40,$out\n\tstvx_u\t\t$out7,$x50,$out\n\taddi\t\t$out,$out,0x60\n\tb\t\tLcbc_dec8x_done\n\n.align\t5\nLcbc_dec8x_five:\n\tvncipherlast\t$out3,$out3,$ivec\n\tvncipherlast\t$out4,$out4,$in3\n\tvncipherlast\t$out5,$out5,$in4\n\tvncipherlast\t$out6,$out6,$in5\n\tvncipherlast\t$out7,$out7,$in6\n\tvmr\t\t$ivec,$in7\n\n\tle?vperm\t$out3,$out3,$out3,$inpperm\n\tle?vperm\t$out4,$out4,$out4,$inpperm\n\tstvx_u\t\t$out3,$x00,$out\n\tle?vperm\t$out5,$out5,$out5,$inpperm\n\tstvx_u\t\t$out4,$x10,$out\n\tle?vperm\t$out6,$out6,$out6,$inpperm\n\tstvx_u\t\t$out5,$x20,$out\n\tle?vperm\t$out7,$out7,$out7,$inpperm\n\tstvx_u\t\t$out6,$x30,$out\n\tstvx_u\t\t$out7,$x40,$out\n\taddi\t\t$out,$out,0x50\n\tb\t\tLcbc_dec8x_done\n\n.align\t5\nLcbc_dec8x_four:\n\tvncipherlast\t$out4,$out4,$ivec\n\tvncipherlast\t$out5,$out5,$in4\n\tvncipherlast\t$out6,$out6,$in5\n\tvncipherlast\t$out7,$out7,$in6\n\tvmr\t\t$ivec,$in7\n\n\tle?vperm\t$out4,$out4,$out4,$inpperm\n\tle?vperm\t$out5,$out5,$out5,$inpperm\n\tstvx_u\t\t$out4,$x00,$out\n\tle?vperm\t$out6,$out6,$out6,$inpperm\n\tstvx_u\t\t$out5,$x10,$out\n\tle?vperm\t$out7,$out7,$out7,$inpperm\n\tstvx_u\t\t$out6,$x20,$out\n\tstvx_u\t\t$out7,$x30,$out\n\taddi\t\t$out,$out,0x40\n\tb\t\tLcbc_dec8x_done\n\n.align\t5\nLcbc_dec8x_three:\n\tvncipherlast\t$out5,$out5,$ivec\n\tvncipherlast\t$out6,$out6,$in5\n\tvncipherlast\t$out7,$out7,$in6\n\tvmr\t\t$ivec,$in7\n\n\tle?vperm\t$out5,$out5,$out5,$inpperm\n\tle?vperm\t$out6,$out6,$out6,$inpperm\n\tstvx_u\t\t$out5,$x00,$out\n\tle?vperm\t$out7,$out7,$out7,$inpperm\n\tstvx_u\t\t$out6,$x10,$out\n\tstvx_u\t\t$out7,$x20,$out\n\taddi\t\t$out,$out,0x30\n\tb\t\tLcbc_dec8x_done\n\n.align\t5\nLcbc_dec8x_two:\n\tvncipherlast\t$out6,$out6,$ivec\n\tvncipherlast\t$out7,$out7,$in6\n\tvmr\t\t$ivec,$in7\n\n\tle?vperm\t$out6,$out6,$out6,$inpperm\n\tle?vperm\t$out7,$out7,$out7,$inpperm\n\tstvx_u\t\t$out6,$x00,$out\n\tstvx_u\t\t$out7,$x10,$out\n\taddi\t\t$out,$out,0x20\n\tb\t\tLcbc_dec8x_done\n\n.align\t5\nLcbc_dec8x_one:\n\tvncipherlast\t$out7,$out7,$ivec\n\tvmr\t\t$ivec,$in7\n\n\tle?vperm\t$out7,$out7,$out7,$inpperm\n\tstvx_u\t\t$out7,0,$out\n\taddi\t\t$out,$out,0x10\n\nLcbc_dec8x_done:\n\tle?vperm\t$ivec,$ivec,$ivec,$inpperm\n\tstvx_u\t\t$ivec,0,$ivp\t\t# write [unaligned] iv\n\n\tli\t\tr10,`$FRAME+15`\n\tli\t\tr11,`$FRAME+31`\n\tstvx\t\t$inpperm,r10,$sp\t# wipe copies of round keys\n\taddi\t\tr10,r10,32\n\tstvx\t\t$inpperm,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$inpperm,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$inpperm,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$inpperm,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$inpperm,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$inpperm,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$inpperm,r11,$sp\n\taddi\t\tr11,r11,32\n\n\tmtspr\t\t256,$vrsave\n\tlvx\t\tv20,r10,$sp\t\t# ABI says so\n\taddi\t\tr10,r10,32\n\tlvx\t\tv21,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv22,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv23,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv24,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv25,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv26,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv27,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv28,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv29,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv30,r10,$sp\n\tlvx\t\tv31,r11,$sp\n\t$POP\t\tr26,`$FRAME+21*16+0*$SIZE_T`($sp)\n\t$POP\t\tr27,`$FRAME+21*16+1*$SIZE_T`($sp)\n\t$POP\t\tr28,`$FRAME+21*16+2*$SIZE_T`($sp)\n\t$POP\t\tr29,`$FRAME+21*16+3*$SIZE_T`($sp)\n\t$POP\t\tr30,`$FRAME+21*16+4*$SIZE_T`($sp)\n\t$POP\t\tr31,`$FRAME+21*16+5*$SIZE_T`($sp)\n\taddi\t\t$sp,$sp,`$FRAME+21*16+6*$SIZE_T`\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x14,0,0x80,6,6,0\n\t.long\t\t0\n.size\t.${prefix}_cbc_encrypt,.-.${prefix}_cbc_encrypt\n___\n}}\t}}}\n\n#########################################################################\n{{{\t# CTR procedure[s]\t\t\t\t\t\t#\n\n####################### WARNING: Here be dragons! #######################\n#\n# This code is written as 'ctr32', based on a 32-bit counter used\n# upstream. The kernel does *not* use a 32-bit counter. The kernel uses\n# a 128-bit counter.\n#\n# This leads to subtle changes from the upstream code: the counter\n# is incremented with vaddu_q_m rather than vaddu_w_m. This occurs in\n# both the bulk (8 blocks at a time) path, and in the individual block\n# path. Be aware of this when doing updates.\n#\n# See:\n# 1d4aa0b4c181 (\"crypto: vmx - Fixing AES-CTR counter bug\")\n# 009b30ac7444 (\"crypto: vmx - CTR: always increment IV as quadword\")\n# https://github.com/openssl/openssl/pull/8942\n#\n#########################################################################\nmy ($inp,$out,$len,$key,$ivp,$x10,$rounds,$idx)=map(\"r$_\",(3..10));\nmy ($rndkey0,$rndkey1,$inout,$tmp)=\t\tmap(\"v$_\",(0..3));\nmy ($ivec,$inptail,$inpperm,$outhead,$outperm,$outmask,$keyperm,$one)=\n\t\t\t\t\t\tmap(\"v$_\",(4..11));\nmy $dat=$tmp;\n\n$code.=<<___;\n.globl\t.${prefix}_ctr32_encrypt_blocks\n\t${UCMP}i\t$len,1\n\tbltlr-\n\n\tlis\t\tr0,0xfff0\n\tmfspr\t\t$vrsave,256\n\tmtspr\t\t256,r0\n\n\tli\t\t$idx,15\n\tvxor\t\t$rndkey0,$rndkey0,$rndkey0\n\tle?vspltisb\t$tmp,0x0f\n\n\tlvx\t\t$ivec,0,$ivp\t\t# load [unaligned] iv\n\tlvsl\t\t$inpperm,0,$ivp\n\tlvx\t\t$inptail,$idx,$ivp\n\t vspltisb\t$one,1\n\tle?vxor\t\t$inpperm,$inpperm,$tmp\n\tvperm\t\t$ivec,$ivec,$inptail,$inpperm\n\t vsldoi\t\t$one,$rndkey0,$one,1\n\n\tneg\t\tr11,$inp\n\t?lvsl\t\t$keyperm,0,$key\t\t# prepare for unaligned key\n\tlwz\t\t$rounds,240($key)\n\n\tlvsr\t\t$inpperm,0,r11\t\t# prepare for unaligned load\n\tlvx\t\t$inptail,0,$inp\n\taddi\t\t$inp,$inp,15\t\t# 15 is not typo\n\tle?vxor\t\t$inpperm,$inpperm,$tmp\n\n\tsrwi\t\t$rounds,$rounds,1\n\tli\t\t$idx,16\n\tsubi\t\t$rounds,$rounds,1\n\n\t${UCMP}i\t$len,8\n\tbge\t\t_aesp8_ctr32_encrypt8x\n\n\t?lvsr\t\t$outperm,0,$out\t\t# prepare for unaligned store\n\tvspltisb\t$outmask,-1\n\tlvx\t\t$outhead,0,$out\n\t?vperm\t\t$outmask,$rndkey0,$outmask,$outperm\n\tle?vxor\t\t$outperm,$outperm,$tmp\n\n\tlvx\t\t$rndkey0,0,$key\n\tmtctr\t\t$rounds\n\tlvx\t\t$rndkey1,$idx,$key\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$inout,$ivec,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key\n\taddi\t\t$idx,$idx,16\n\tb\t\tLoop_ctr32_enc\n\n.align\t5\nLoop_ctr32_enc:\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvcipher\t\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key\n\taddi\t\t$idx,$idx,16\n\tbdnz\t\tLoop_ctr32_enc\n\n\tvadduqm\t\t$ivec,$ivec,$one\t# Kernel change for 128-bit\n\t vmr\t\t$dat,$inptail\n\t lvx\t\t$inptail,0,$inp\n\t addi\t\t$inp,$inp,16\n\t subic.\t\t$len,$len,1\t\t# blocks--\n\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key\n\t vperm\t\t$dat,$dat,$inptail,$inpperm\n\t li\t\t$idx,16\n\t?vperm\t\t$rndkey1,$rndkey0,$rndkey1,$keyperm\n\t lvx\t\t$rndkey0,0,$key\n\tvxor\t\t$dat,$dat,$rndkey1\t# last round key\n\tvcipherlast\t$inout,$inout,$dat\n\n\t lvx\t\t$rndkey1,$idx,$key\n\t addi\t\t$idx,$idx,16\n\tvperm\t\t$inout,$inout,$inout,$outperm\n\tvsel\t\t$dat,$outhead,$inout,$outmask\n\t mtctr\t\t$rounds\n\t ?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvmr\t\t$outhead,$inout\n\t vxor\t\t$inout,$ivec,$rndkey0\n\t lvx\t\t$rndkey0,$idx,$key\n\t addi\t\t$idx,$idx,16\n\tstvx\t\t$dat,0,$out\n\taddi\t\t$out,$out,16\n\tbne\t\tLoop_ctr32_enc\n\n\taddi\t\t$out,$out,-1\n\tlvx\t\t$inout,0,$out\t\t# redundant in aligned case\n\tvsel\t\t$inout,$outhead,$inout,$outmask\n\tstvx\t\t$inout,0,$out\n\n\tmtspr\t\t256,$vrsave\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x14,0,0,0,6,0\n\t.long\t\t0\n___\n#########################################################################\n{{\t# Optimized CTR procedure\t\t\t\t\t#\nmy $key_=\"r11\";\nmy ($x00,$x10,$x20,$x30,$x40,$x50,$x60,$x70)=map(\"r$_\",(0,8,26..31));\nmy ($in0, $in1, $in2, $in3, $in4, $in5, $in6, $in7 )=map(\"v$_\",(0..3,10,12..14));\nmy ($out0,$out1,$out2,$out3,$out4,$out5,$out6,$out7)=map(\"v$_\",(15..22));\nmy $rndkey0=\"v23\";\t# v24-v25 rotating buffer for first found keys\n\t\t\t# v26-v31 last 6 round keys\nmy ($tmp,$keyperm)=($in3,$in4);\t# aliases with \"caller\", redundant assignment\nmy ($two,$three,$four)=($outhead,$outperm,$outmask);\n\n$code.=<<___;\n.align\t5\n_aesp8_ctr32_encrypt8x:\n\t$STU\t\t$sp,-`($FRAME+21*16+6*$SIZE_T)`($sp)\n\tli\t\tr10,`$FRAME+8*16+15`\n\tli\t\tr11,`$FRAME+8*16+31`\n\tstvx\t\tv20,r10,$sp\t\t# ABI says so\n\taddi\t\tr10,r10,32\n\tstvx\t\tv21,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv22,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\tv23,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv24,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\tv25,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv26,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\tv27,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv28,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\tv29,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\tv30,r10,$sp\n\tstvx\t\tv31,r11,$sp\n\tli\t\tr0,-1\n\tstw\t\t$vrsave,`$FRAME+21*16-4`($sp)\t# save vrsave\n\tli\t\t$x10,0x10\n\t$PUSH\t\tr26,`$FRAME+21*16+0*$SIZE_T`($sp)\n\tli\t\t$x20,0x20\n\t$PUSH\t\tr27,`$FRAME+21*16+1*$SIZE_T`($sp)\n\tli\t\t$x30,0x30\n\t$PUSH\t\tr28,`$FRAME+21*16+2*$SIZE_T`($sp)\n\tli\t\t$x40,0x40\n\t$PUSH\t\tr29,`$FRAME+21*16+3*$SIZE_T`($sp)\n\tli\t\t$x50,0x50\n\t$PUSH\t\tr30,`$FRAME+21*16+4*$SIZE_T`($sp)\n\tli\t\t$x60,0x60\n\t$PUSH\t\tr31,`$FRAME+21*16+5*$SIZE_T`($sp)\n\tli\t\t$x70,0x70\n\tmtspr\t\t256,r0\n\n\tsubi\t\t$rounds,$rounds,3\t# -4 in total\n\n\tlvx\t\t$rndkey0,$x00,$key\t# load key schedule\n\tlvx\t\tv30,$x10,$key\n\taddi\t\t$key,$key,0x20\n\tlvx\t\tv31,$x00,$key\n\t?vperm\t\t$rndkey0,$rndkey0,v30,$keyperm\n\taddi\t\t$key_,$sp,$FRAME+15\n\tmtctr\t\t$rounds\n\nLoad_ctr32_enc_key:\n\t?vperm\t\tv24,v30,v31,$keyperm\n\tlvx\t\tv30,$x10,$key\n\taddi\t\t$key,$key,0x20\n\tstvx\t\tv24,$x00,$key_\t\t# off-load round[1]\n\t?vperm\t\tv25,v31,v30,$keyperm\n\tlvx\t\tv31,$x00,$key\n\tstvx\t\tv25,$x10,$key_\t\t# off-load round[2]\n\taddi\t\t$key_,$key_,0x20\n\tbdnz\t\tLoad_ctr32_enc_key\n\n\tlvx\t\tv26,$x10,$key\n\t?vperm\t\tv24,v30,v31,$keyperm\n\tlvx\t\tv27,$x20,$key\n\tstvx\t\tv24,$x00,$key_\t\t# off-load round[3]\n\t?vperm\t\tv25,v31,v26,$keyperm\n\tlvx\t\tv28,$x30,$key\n\tstvx\t\tv25,$x10,$key_\t\t# off-load round[4]\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\t?vperm\t\tv26,v26,v27,$keyperm\n\tlvx\t\tv29,$x40,$key\n\t?vperm\t\tv27,v27,v28,$keyperm\n\tlvx\t\tv30,$x50,$key\n\t?vperm\t\tv28,v28,v29,$keyperm\n\tlvx\t\tv31,$x60,$key\n\t?vperm\t\tv29,v29,v30,$keyperm\n\tlvx\t\t$out0,$x70,$key\t\t# borrow $out0\n\t?vperm\t\tv30,v30,v31,$keyperm\n\tlvx\t\tv24,$x00,$key_\t\t# pre-load round[1]\n\t?vperm\t\tv31,v31,$out0,$keyperm\n\tlvx\t\tv25,$x10,$key_\t\t# pre-load round[2]\n\n\tvadduqm\t\t$two,$one,$one\n\tsubi\t\t$inp,$inp,15\t\t# undo \"caller\"\n\t$SHL\t\t$len,$len,4\n\n\tvadduqm\t\t$out1,$ivec,$one\t# counter values ...\n\tvadduqm\t\t$out2,$ivec,$two\t# (do all ctr adds as 128-bit)\n\tvxor\t\t$out0,$ivec,$rndkey0\t# ... xored with rndkey[0]\n\t le?li\t\t$idx,8\n\tvadduqm\t\t$out3,$out1,$two\n\tvxor\t\t$out1,$out1,$rndkey0\n\t le?lvsl\t$inpperm,0,$idx\n\tvadduqm\t\t$out4,$out2,$two\n\tvxor\t\t$out2,$out2,$rndkey0\n\t le?vspltisb\t$tmp,0x0f\n\tvadduqm\t\t$out5,$out3,$two\n\tvxor\t\t$out3,$out3,$rndkey0\n\t le?vxor\t$inpperm,$inpperm,$tmp\t# transform for lvx_u/stvx_u\n\tvadduqm\t\t$out6,$out4,$two\n\tvxor\t\t$out4,$out4,$rndkey0\n\tvadduqm\t\t$out7,$out5,$two\n\tvxor\t\t$out5,$out5,$rndkey0\n\tvadduqm\t\t$ivec,$out6,$two\t# next counter value\n\tvxor\t\t$out6,$out6,$rndkey0\n\tvxor\t\t$out7,$out7,$rndkey0\n\n\tmtctr\t\t$rounds\n\tb\t\tLoop_ctr32_enc8x\n.align\t5\nLoop_ctr32_enc8x:\n\tvcipher \t$out0,$out0,v24\n\tvcipher \t$out1,$out1,v24\n\tvcipher \t$out2,$out2,v24\n\tvcipher \t$out3,$out3,v24\n\tvcipher \t$out4,$out4,v24\n\tvcipher \t$out5,$out5,v24\n\tvcipher \t$out6,$out6,v24\n\tvcipher \t$out7,$out7,v24\nLoop_ctr32_enc8x_middle:\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvcipher \t$out0,$out0,v25\n\tvcipher \t$out1,$out1,v25\n\tvcipher \t$out2,$out2,v25\n\tvcipher \t$out3,$out3,v25\n\tvcipher \t$out4,$out4,v25\n\tvcipher \t$out5,$out5,v25\n\tvcipher \t$out6,$out6,v25\n\tvcipher \t$out7,$out7,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\tLoop_ctr32_enc8x\n\n\tsubic\t\tr11,$len,256\t\t# $len-256, borrow $key_\n\tvcipher \t$out0,$out0,v24\n\tvcipher \t$out1,$out1,v24\n\tvcipher \t$out2,$out2,v24\n\tvcipher \t$out3,$out3,v24\n\tvcipher \t$out4,$out4,v24\n\tvcipher \t$out5,$out5,v24\n\tvcipher \t$out6,$out6,v24\n\tvcipher \t$out7,$out7,v24\n\n\tsubfe\t\tr0,r0,r0\t\t# borrow?-1:0\n\tvcipher \t$out0,$out0,v25\n\tvcipher \t$out1,$out1,v25\n\tvcipher \t$out2,$out2,v25\n\tvcipher \t$out3,$out3,v25\n\tvcipher \t$out4,$out4,v25\n\tvcipher\t\t$out5,$out5,v25\n\tvcipher\t\t$out6,$out6,v25\n\tvcipher\t\t$out7,$out7,v25\n\n\tand\t\tr0,r0,r11\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\tvcipher\t\t$out0,$out0,v26\n\tvcipher\t\t$out1,$out1,v26\n\tvcipher\t\t$out2,$out2,v26\n\tvcipher\t\t$out3,$out3,v26\n\tvcipher\t\t$out4,$out4,v26\n\tvcipher\t\t$out5,$out5,v26\n\tvcipher\t\t$out6,$out6,v26\n\tvcipher\t\t$out7,$out7,v26\n\tlvx\t\tv24,$x00,$key_\t\t# re-pre-load round[1]\n\n\tsubic\t\t$len,$len,129\t\t# $len-=129\n\tvcipher\t\t$out0,$out0,v27\n\taddi\t\t$len,$len,1\t\t# $len-=128 really\n\tvcipher\t\t$out1,$out1,v27\n\tvcipher\t\t$out2,$out2,v27\n\tvcipher\t\t$out3,$out3,v27\n\tvcipher\t\t$out4,$out4,v27\n\tvcipher\t\t$out5,$out5,v27\n\tvcipher\t\t$out6,$out6,v27\n\tvcipher\t\t$out7,$out7,v27\n\tlvx\t\tv25,$x10,$key_\t\t# re-pre-load round[2]\n\n\tvcipher\t\t$out0,$out0,v28\n\t lvx_u\t\t$in0,$x00,$inp\t\t# load input\n\tvcipher\t\t$out1,$out1,v28\n\t lvx_u\t\t$in1,$x10,$inp\n\tvcipher\t\t$out2,$out2,v28\n\t lvx_u\t\t$in2,$x20,$inp\n\tvcipher\t\t$out3,$out3,v28\n\t lvx_u\t\t$in3,$x30,$inp\n\tvcipher\t\t$out4,$out4,v28\n\t lvx_u\t\t$in4,$x40,$inp\n\tvcipher\t\t$out5,$out5,v28\n\t lvx_u\t\t$in5,$x50,$inp\n\tvcipher\t\t$out6,$out6,v28\n\t lvx_u\t\t$in6,$x60,$inp\n\tvcipher\t\t$out7,$out7,v28\n\t lvx_u\t\t$in7,$x70,$inp\n\t addi\t\t$inp,$inp,0x80\n\n\tvcipher\t\t$out0,$out0,v29\n\t le?vperm\t$in0,$in0,$in0,$inpperm\n\tvcipher\t\t$out1,$out1,v29\n\t le?vperm\t$in1,$in1,$in1,$inpperm\n\tvcipher\t\t$out2,$out2,v29\n\t le?vperm\t$in2,$in2,$in2,$inpperm\n\tvcipher\t\t$out3,$out3,v29\n\t le?vperm\t$in3,$in3,$in3,$inpperm\n\tvcipher\t\t$out4,$out4,v29\n\t le?vperm\t$in4,$in4,$in4,$inpperm\n\tvcipher\t\t$out5,$out5,v29\n\t le?vperm\t$in5,$in5,$in5,$inpperm\n\tvcipher\t\t$out6,$out6,v29\n\t le?vperm\t$in6,$in6,$in6,$inpperm\n\tvcipher\t\t$out7,$out7,v29\n\t le?vperm\t$in7,$in7,$in7,$inpperm\n\n\tadd\t\t$inp,$inp,r0\t\t# $inp is adjusted in such\n\t\t\t\t\t\t# way that at exit from the\n\t\t\t\t\t\t# loop inX-in7 are loaded\n\t\t\t\t\t\t# with last \"words\"\n\tsubfe.\t\tr0,r0,r0\t\t# borrow?-1:0\n\tvcipher\t\t$out0,$out0,v30\n\t vxor\t\t$in0,$in0,v31\t\t# xor with last round key\n\tvcipher\t\t$out1,$out1,v30\n\t vxor\t\t$in1,$in1,v31\n\tvcipher\t\t$out2,$out2,v30\n\t vxor\t\t$in2,$in2,v31\n\tvcipher\t\t$out3,$out3,v30\n\t vxor\t\t$in3,$in3,v31\n\tvcipher\t\t$out4,$out4,v30\n\t vxor\t\t$in4,$in4,v31\n\tvcipher\t\t$out5,$out5,v30\n\t vxor\t\t$in5,$in5,v31\n\tvcipher\t\t$out6,$out6,v30\n\t vxor\t\t$in6,$in6,v31\n\tvcipher\t\t$out7,$out7,v30\n\t vxor\t\t$in7,$in7,v31\n\n\tbne\t\tLctr32_enc8x_break\t# did $len-129 borrow?\n\n\tvcipherlast\t$in0,$out0,$in0\n\tvcipherlast\t$in1,$out1,$in1\n\t vadduqm\t$out1,$ivec,$one\t# counter values ...\n\tvcipherlast\t$in2,$out2,$in2\n\t vadduqm\t$out2,$ivec,$two\n\t vxor\t\t$out0,$ivec,$rndkey0\t# ... xored with rndkey[0]\n\tvcipherlast\t$in3,$out3,$in3\n\t vadduqm\t$out3,$out1,$two\n\t vxor\t\t$out1,$out1,$rndkey0\n\tvcipherlast\t$in4,$out4,$in4\n\t vadduqm\t$out4,$out2,$two\n\t vxor\t\t$out2,$out2,$rndkey0\n\tvcipherlast\t$in5,$out5,$in5\n\t vadduqm\t$out5,$out3,$two\n\t vxor\t\t$out3,$out3,$rndkey0\n\tvcipherlast\t$in6,$out6,$in6\n\t vadduqm\t$out6,$out4,$two\n\t vxor\t\t$out4,$out4,$rndkey0\n\tvcipherlast\t$in7,$out7,$in7\n\t vadduqm\t$out7,$out5,$two\n\t vxor\t\t$out5,$out5,$rndkey0\n\tle?vperm\t$in0,$in0,$in0,$inpperm\n\t vadduqm\t$ivec,$out6,$two\t# next counter value\n\t vxor\t\t$out6,$out6,$rndkey0\n\tle?vperm\t$in1,$in1,$in1,$inpperm\n\t vxor\t\t$out7,$out7,$rndkey0\n\tmtctr\t\t$rounds\n\n\t vcipher\t$out0,$out0,v24\n\tstvx_u\t\t$in0,$x00,$out\n\tle?vperm\t$in2,$in2,$in2,$inpperm\n\t vcipher\t$out1,$out1,v24\n\tstvx_u\t\t$in1,$x10,$out\n\tle?vperm\t$in3,$in3,$in3,$inpperm\n\t vcipher\t$out2,$out2,v24\n\tstvx_u\t\t$in2,$x20,$out\n\tle?vperm\t$in4,$in4,$in4,$inpperm\n\t vcipher\t$out3,$out3,v24\n\tstvx_u\t\t$in3,$x30,$out\n\tle?vperm\t$in5,$in5,$in5,$inpperm\n\t vcipher\t$out4,$out4,v24\n\tstvx_u\t\t$in4,$x40,$out\n\tle?vperm\t$in6,$in6,$in6,$inpperm\n\t vcipher\t$out5,$out5,v24\n\tstvx_u\t\t$in5,$x50,$out\n\tle?vperm\t$in7,$in7,$in7,$inpperm\n\t vcipher\t$out6,$out6,v24\n\tstvx_u\t\t$in6,$x60,$out\n\t vcipher\t$out7,$out7,v24\n\tstvx_u\t\t$in7,$x70,$out\n\taddi\t\t$out,$out,0x80\n\n\tb\t\tLoop_ctr32_enc8x_middle\n\n.align\t5\nLctr32_enc8x_break:\n\tcmpwi\t\t$len,-0x60\n\tblt\t\tLctr32_enc8x_one\n\tnop\n\tbeq\t\tLctr32_enc8x_two\n\tcmpwi\t\t$len,-0x40\n\tblt\t\tLctr32_enc8x_three\n\tnop\n\tbeq\t\tLctr32_enc8x_four\n\tcmpwi\t\t$len,-0x20\n\tblt\t\tLctr32_enc8x_five\n\tnop\n\tbeq\t\tLctr32_enc8x_six\n\tcmpwi\t\t$len,0x00\n\tblt\t\tLctr32_enc8x_seven\n\nLctr32_enc8x_eight:\n\tvcipherlast\t$out0,$out0,$in0\n\tvcipherlast\t$out1,$out1,$in1\n\tvcipherlast\t$out2,$out2,$in2\n\tvcipherlast\t$out3,$out3,$in3\n\tvcipherlast\t$out4,$out4,$in4\n\tvcipherlast\t$out5,$out5,$in5\n\tvcipherlast\t$out6,$out6,$in6\n\tvcipherlast\t$out7,$out7,$in7\n\n\tle?vperm\t$out0,$out0,$out0,$inpperm\n\tle?vperm\t$out1,$out1,$out1,$inpperm\n\tstvx_u\t\t$out0,$x00,$out\n\tle?vperm\t$out2,$out2,$out2,$inpperm\n\tstvx_u\t\t$out1,$x10,$out\n\tle?vperm\t$out3,$out3,$out3,$inpperm\n\tstvx_u\t\t$out2,$x20,$out\n\tle?vperm\t$out4,$out4,$out4,$inpperm\n\tstvx_u\t\t$out3,$x30,$out\n\tle?vperm\t$out5,$out5,$out5,$inpperm\n\tstvx_u\t\t$out4,$x40,$out\n\tle?vperm\t$out6,$out6,$out6,$inpperm\n\tstvx_u\t\t$out5,$x50,$out\n\tle?vperm\t$out7,$out7,$out7,$inpperm\n\tstvx_u\t\t$out6,$x60,$out\n\tstvx_u\t\t$out7,$x70,$out\n\taddi\t\t$out,$out,0x80\n\tb\t\tLctr32_enc8x_done\n\n.align\t5\nLctr32_enc8x_seven:\n\tvcipherlast\t$out0,$out0,$in1\n\tvcipherlast\t$out1,$out1,$in2\n\tvcipherlast\t$out2,$out2,$in3\n\tvcipherlast\t$out3,$out3,$in4\n\tvcipherlast\t$out4,$out4,$in5\n\tvcipherlast\t$out5,$out5,$in6\n\tvcipherlast\t$out6,$out6,$in7\n\n\tle?vperm\t$out0,$out0,$out0,$inpperm\n\tle?vperm\t$out1,$out1,$out1,$inpperm\n\tstvx_u\t\t$out0,$x00,$out\n\tle?vperm\t$out2,$out2,$out2,$inpperm\n\tstvx_u\t\t$out1,$x10,$out\n\tle?vperm\t$out3,$out3,$out3,$inpperm\n\tstvx_u\t\t$out2,$x20,$out\n\tle?vperm\t$out4,$out4,$out4,$inpperm\n\tstvx_u\t\t$out3,$x30,$out\n\tle?vperm\t$out5,$out5,$out5,$inpperm\n\tstvx_u\t\t$out4,$x40,$out\n\tle?vperm\t$out6,$out6,$out6,$inpperm\n\tstvx_u\t\t$out5,$x50,$out\n\tstvx_u\t\t$out6,$x60,$out\n\taddi\t\t$out,$out,0x70\n\tb\t\tLctr32_enc8x_done\n\n.align\t5\nLctr32_enc8x_six:\n\tvcipherlast\t$out0,$out0,$in2\n\tvcipherlast\t$out1,$out1,$in3\n\tvcipherlast\t$out2,$out2,$in4\n\tvcipherlast\t$out3,$out3,$in5\n\tvcipherlast\t$out4,$out4,$in6\n\tvcipherlast\t$out5,$out5,$in7\n\n\tle?vperm\t$out0,$out0,$out0,$inpperm\n\tle?vperm\t$out1,$out1,$out1,$inpperm\n\tstvx_u\t\t$out0,$x00,$out\n\tle?vperm\t$out2,$out2,$out2,$inpperm\n\tstvx_u\t\t$out1,$x10,$out\n\tle?vperm\t$out3,$out3,$out3,$inpperm\n\tstvx_u\t\t$out2,$x20,$out\n\tle?vperm\t$out4,$out4,$out4,$inpperm\n\tstvx_u\t\t$out3,$x30,$out\n\tle?vperm\t$out5,$out5,$out5,$inpperm\n\tstvx_u\t\t$out4,$x40,$out\n\tstvx_u\t\t$out5,$x50,$out\n\taddi\t\t$out,$out,0x60\n\tb\t\tLctr32_enc8x_done\n\n.align\t5\nLctr32_enc8x_five:\n\tvcipherlast\t$out0,$out0,$in3\n\tvcipherlast\t$out1,$out1,$in4\n\tvcipherlast\t$out2,$out2,$in5\n\tvcipherlast\t$out3,$out3,$in6\n\tvcipherlast\t$out4,$out4,$in7\n\n\tle?vperm\t$out0,$out0,$out0,$inpperm\n\tle?vperm\t$out1,$out1,$out1,$inpperm\n\tstvx_u\t\t$out0,$x00,$out\n\tle?vperm\t$out2,$out2,$out2,$inpperm\n\tstvx_u\t\t$out1,$x10,$out\n\tle?vperm\t$out3,$out3,$out3,$inpperm\n\tstvx_u\t\t$out2,$x20,$out\n\tle?vperm\t$out4,$out4,$out4,$inpperm\n\tstvx_u\t\t$out3,$x30,$out\n\tstvx_u\t\t$out4,$x40,$out\n\taddi\t\t$out,$out,0x50\n\tb\t\tLctr32_enc8x_done\n\n.align\t5\nLctr32_enc8x_four:\n\tvcipherlast\t$out0,$out0,$in4\n\tvcipherlast\t$out1,$out1,$in5\n\tvcipherlast\t$out2,$out2,$in6\n\tvcipherlast\t$out3,$out3,$in7\n\n\tle?vperm\t$out0,$out0,$out0,$inpperm\n\tle?vperm\t$out1,$out1,$out1,$inpperm\n\tstvx_u\t\t$out0,$x00,$out\n\tle?vperm\t$out2,$out2,$out2,$inpperm\n\tstvx_u\t\t$out1,$x10,$out\n\tle?vperm\t$out3,$out3,$out3,$inpperm\n\tstvx_u\t\t$out2,$x20,$out\n\tstvx_u\t\t$out3,$x30,$out\n\taddi\t\t$out,$out,0x40\n\tb\t\tLctr32_enc8x_done\n\n.align\t5\nLctr32_enc8x_three:\n\tvcipherlast\t$out0,$out0,$in5\n\tvcipherlast\t$out1,$out1,$in6\n\tvcipherlast\t$out2,$out2,$in7\n\n\tle?vperm\t$out0,$out0,$out0,$inpperm\n\tle?vperm\t$out1,$out1,$out1,$inpperm\n\tstvx_u\t\t$out0,$x00,$out\n\tle?vperm\t$out2,$out2,$out2,$inpperm\n\tstvx_u\t\t$out1,$x10,$out\n\tstvx_u\t\t$out2,$x20,$out\n\taddi\t\t$out,$out,0x30\n\tb\t\tLctr32_enc8x_done\n\n.align\t5\nLctr32_enc8x_two:\n\tvcipherlast\t$out0,$out0,$in6\n\tvcipherlast\t$out1,$out1,$in7\n\n\tle?vperm\t$out0,$out0,$out0,$inpperm\n\tle?vperm\t$out1,$out1,$out1,$inpperm\n\tstvx_u\t\t$out0,$x00,$out\n\tstvx_u\t\t$out1,$x10,$out\n\taddi\t\t$out,$out,0x20\n\tb\t\tLctr32_enc8x_done\n\n.align\t5\nLctr32_enc8x_one:\n\tvcipherlast\t$out0,$out0,$in7\n\n\tle?vperm\t$out0,$out0,$out0,$inpperm\n\tstvx_u\t\t$out0,0,$out\n\taddi\t\t$out,$out,0x10\n\nLctr32_enc8x_done:\n\tli\t\tr10,`$FRAME+15`\n\tli\t\tr11,`$FRAME+31`\n\tstvx\t\t$inpperm,r10,$sp\t# wipe copies of round keys\n\taddi\t\tr10,r10,32\n\tstvx\t\t$inpperm,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$inpperm,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$inpperm,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$inpperm,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$inpperm,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$inpperm,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$inpperm,r11,$sp\n\taddi\t\tr11,r11,32\n\n\tmtspr\t\t256,$vrsave\n\tlvx\t\tv20,r10,$sp\t\t# ABI says so\n\taddi\t\tr10,r10,32\n\tlvx\t\tv21,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv22,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv23,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv24,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv25,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv26,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv27,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv28,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv29,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv30,r10,$sp\n\tlvx\t\tv31,r11,$sp\n\t$POP\t\tr26,`$FRAME+21*16+0*$SIZE_T`($sp)\n\t$POP\t\tr27,`$FRAME+21*16+1*$SIZE_T`($sp)\n\t$POP\t\tr28,`$FRAME+21*16+2*$SIZE_T`($sp)\n\t$POP\t\tr29,`$FRAME+21*16+3*$SIZE_T`($sp)\n\t$POP\t\tr30,`$FRAME+21*16+4*$SIZE_T`($sp)\n\t$POP\t\tr31,`$FRAME+21*16+5*$SIZE_T`($sp)\n\taddi\t\t$sp,$sp,`$FRAME+21*16+6*$SIZE_T`\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x14,0,0x80,6,6,0\n\t.long\t\t0\n.size\t.${prefix}_ctr32_encrypt_blocks,.-.${prefix}_ctr32_encrypt_blocks\n___\n}}\t}}}\n\n#########################################################################\n{{{\t# XTS procedures\t\t\t\t\t\t#\n# int aes_p8_xts_[en|de]crypt(const char *inp, char *out, size_t len,\t#\n#                             const AES_KEY *key1, const AES_KEY *key2,\t#\n#                             [const] unsigned char iv[16]);\t\t#\n# If $key2 is NULL, then a \"tweak chaining\" mode is engaged, in which\t#\n# input tweak value is assumed to be encrypted already, and last tweak\t#\n# value, one suitable for consecutive call on same chunk of data, is\t#\n# written back to original buffer. In addition, in \"tweak chaining\"\t#\n# mode only complete input blocks are processed.\t\t\t#\n\nmy ($inp,$out,$len,$key1,$key2,$ivp,$rounds,$idx) =\tmap(\"r$_\",(3..10));\nmy ($rndkey0,$rndkey1,$inout) =\t\t\t\tmap(\"v$_\",(0..2));\nmy ($output,$inptail,$inpperm,$leperm,$keyperm) =\tmap(\"v$_\",(3..7));\nmy ($tweak,$seven,$eighty7,$tmp,$tweak1) =\t\tmap(\"v$_\",(8..12));\nmy $taillen = $key2;\n\n   ($inp,$idx) = ($idx,$inp);\t\t\t\t# reassign\n\n$code.=<<___;\n.globl\t.${prefix}_xts_encrypt\n\tmr\t\t$inp,r3\t\t\t\t# reassign\n\tli\t\tr3,-1\n\t${UCMP}i\t$len,16\n\tbltlr-\n\n\tlis\t\tr0,0xfff0\n\tmfspr\t\tr12,256\t\t\t\t# save vrsave\n\tli\t\tr11,0\n\tmtspr\t\t256,r0\n\n\tvspltisb\t$seven,0x07\t\t\t# 0x070707..07\n\tle?lvsl\t\t$leperm,r11,r11\n\tle?vspltisb\t$tmp,0x0f\n\tle?vxor\t\t$leperm,$leperm,$seven\n\n\tli\t\t$idx,15\n\tlvx\t\t$tweak,0,$ivp\t\t\t# load [unaligned] iv\n\tlvsl\t\t$inpperm,0,$ivp\n\tlvx\t\t$inptail,$idx,$ivp\n\tle?vxor\t\t$inpperm,$inpperm,$tmp\n\tvperm\t\t$tweak,$tweak,$inptail,$inpperm\n\n\tneg\t\tr11,$inp\n\tlvsr\t\t$inpperm,0,r11\t\t\t# prepare for unaligned load\n\tlvx\t\t$inout,0,$inp\n\taddi\t\t$inp,$inp,15\t\t\t# 15 is not typo\n\tle?vxor\t\t$inpperm,$inpperm,$tmp\n\n\t${UCMP}i\t$key2,0\t\t\t\t# key2==NULL?\n\tbeq\t\tLxts_enc_no_key2\n\n\t?lvsl\t\t$keyperm,0,$key2\t\t# prepare for unaligned key\n\tlwz\t\t$rounds,240($key2)\n\tsrwi\t\t$rounds,$rounds,1\n\tsubi\t\t$rounds,$rounds,1\n\tli\t\t$idx,16\n\n\tlvx\t\t$rndkey0,0,$key2\n\tlvx\t\t$rndkey1,$idx,$key2\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$tweak,$tweak,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key2\n\taddi\t\t$idx,$idx,16\n\tmtctr\t\t$rounds\n\nLtweak_xts_enc:\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$tweak,$tweak,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key2\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvcipher\t\t$tweak,$tweak,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key2\n\taddi\t\t$idx,$idx,16\n\tbdnz\t\tLtweak_xts_enc\n\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$tweak,$tweak,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key2\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvcipherlast\t$tweak,$tweak,$rndkey0\n\n\tli\t\t$ivp,0\t\t\t\t# don't chain the tweak\n\tb\t\tLxts_enc\n\nLxts_enc_no_key2:\n\tli\t\t$idx,-16\n\tand\t\t$len,$len,$idx\t\t\t# in \"tweak chaining\"\n\t\t\t\t\t\t\t# mode only complete\n\t\t\t\t\t\t\t# blocks are processed\nLxts_enc:\n\tlvx\t\t$inptail,0,$inp\n\taddi\t\t$inp,$inp,16\n\n\t?lvsl\t\t$keyperm,0,$key1\t\t# prepare for unaligned key\n\tlwz\t\t$rounds,240($key1)\n\tsrwi\t\t$rounds,$rounds,1\n\tsubi\t\t$rounds,$rounds,1\n\tli\t\t$idx,16\n\n\tvslb\t\t$eighty7,$seven,$seven\t\t# 0x808080..80\n\tvor\t\t$eighty7,$eighty7,$seven\t# 0x878787..87\n\tvspltisb\t$tmp,1\t\t\t\t# 0x010101..01\n\tvsldoi\t\t$eighty7,$eighty7,$tmp,15\t# 0x870101..01\n\n\t${UCMP}i\t$len,96\n\tbge\t\t_aesp8_xts_encrypt6x\n\n\tandi.\t\t$taillen,$len,15\n\tsubic\t\tr0,$len,32\n\tsubi\t\t$taillen,$taillen,16\n\tsubfe\t\tr0,r0,r0\n\tand\t\tr0,r0,$taillen\n\tadd\t\t$inp,$inp,r0\n\n\tlvx\t\t$rndkey0,0,$key1\n\tlvx\t\t$rndkey1,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\tvperm\t\t$inout,$inout,$inptail,$inpperm\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$inout,$inout,$tweak\n\tvxor\t\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\tmtctr\t\t$rounds\n\tb\t\tLoop_xts_enc\n\n.align\t5\nLoop_xts_enc:\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvcipher\t\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\tbdnz\t\tLoop_xts_enc\n\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key1\n\tli\t\t$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$rndkey0,$rndkey0,$tweak\n\tvcipherlast\t$output,$inout,$rndkey0\n\n\tle?vperm\t$tmp,$output,$output,$leperm\n\tbe?nop\n\tle?stvx_u\t$tmp,0,$out\n\tbe?stvx_u\t$output,0,$out\n\taddi\t\t$out,$out,16\n\n\tsubic.\t\t$len,$len,16\n\tbeq\t\tLxts_enc_done\n\n\tvmr\t\t$inout,$inptail\n\tlvx\t\t$inptail,0,$inp\n\taddi\t\t$inp,$inp,16\n\tlvx\t\t$rndkey0,0,$key1\n\tlvx\t\t$rndkey1,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\n\tsubic\t\tr0,$len,32\n\tsubfe\t\tr0,r0,r0\n\tand\t\tr0,r0,$taillen\n\tadd\t\t$inp,$inp,r0\n\n\tvsrab\t\t$tmp,$tweak,$seven\t\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\tvand\t\t$tmp,$tmp,$eighty7\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\tvperm\t\t$inout,$inout,$inptail,$inpperm\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$inout,$inout,$tweak\n\tvxor\t\t$output,$output,$rndkey0\t# just in case $len<16\n\tvxor\t\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\n\tmtctr\t\t$rounds\n\t${UCMP}i\t$len,16\n\tbge\t\tLoop_xts_enc\n\n\tvxor\t\t$output,$output,$tweak\n\tlvsr\t\t$inpperm,0,$len\t\t\t# $inpperm is no longer needed\n\tvxor\t\t$inptail,$inptail,$inptail\t# $inptail is no longer needed\n\tvspltisb\t$tmp,-1\n\tvperm\t\t$inptail,$inptail,$tmp,$inpperm\n\tvsel\t\t$inout,$inout,$output,$inptail\n\n\tsubi\t\tr11,$out,17\n\tsubi\t\t$out,$out,16\n\tmtctr\t\t$len\n\tli\t\t$len,16\nLoop_xts_enc_steal:\n\tlbzu\t\tr0,1(r11)\n\tstb\t\tr0,16(r11)\n\tbdnz\t\tLoop_xts_enc_steal\n\n\tmtctr\t\t$rounds\n\tb\t\tLoop_xts_enc\t\t\t# one more time...\n\nLxts_enc_done:\n\t${UCMP}i\t$ivp,0\n\tbeq\t\tLxts_enc_ret\n\n\tvsrab\t\t$tmp,$tweak,$seven\t\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\tvand\t\t$tmp,$tmp,$eighty7\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\tle?vperm\t$tweak,$tweak,$tweak,$leperm\n\tstvx_u\t\t$tweak,0,$ivp\n\nLxts_enc_ret:\n\tmtspr\t\t256,r12\t\t\t\t# restore vrsave\n\tli\t\tr3,0\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x04,0,0x80,6,6,0\n\t.long\t\t0\n.size\t.${prefix}_xts_encrypt,.-.${prefix}_xts_encrypt\n\n.globl\t.${prefix}_xts_decrypt\n\tmr\t\t$inp,r3\t\t\t\t# reassign\n\tli\t\tr3,-1\n\t${UCMP}i\t$len,16\n\tbltlr-\n\n\tlis\t\tr0,0xfff8\n\tmfspr\t\tr12,256\t\t\t\t# save vrsave\n\tli\t\tr11,0\n\tmtspr\t\t256,r0\n\n\tandi.\t\tr0,$len,15\n\tneg\t\tr0,r0\n\tandi.\t\tr0,r0,16\n\tsub\t\t$len,$len,r0\n\n\tvspltisb\t$seven,0x07\t\t\t# 0x070707..07\n\tle?lvsl\t\t$leperm,r11,r11\n\tle?vspltisb\t$tmp,0x0f\n\tle?vxor\t\t$leperm,$leperm,$seven\n\n\tli\t\t$idx,15\n\tlvx\t\t$tweak,0,$ivp\t\t\t# load [unaligned] iv\n\tlvsl\t\t$inpperm,0,$ivp\n\tlvx\t\t$inptail,$idx,$ivp\n\tle?vxor\t\t$inpperm,$inpperm,$tmp\n\tvperm\t\t$tweak,$tweak,$inptail,$inpperm\n\n\tneg\t\tr11,$inp\n\tlvsr\t\t$inpperm,0,r11\t\t\t# prepare for unaligned load\n\tlvx\t\t$inout,0,$inp\n\taddi\t\t$inp,$inp,15\t\t\t# 15 is not typo\n\tle?vxor\t\t$inpperm,$inpperm,$tmp\n\n\t${UCMP}i\t$key2,0\t\t\t\t# key2==NULL?\n\tbeq\t\tLxts_dec_no_key2\n\n\t?lvsl\t\t$keyperm,0,$key2\t\t# prepare for unaligned key\n\tlwz\t\t$rounds,240($key2)\n\tsrwi\t\t$rounds,$rounds,1\n\tsubi\t\t$rounds,$rounds,1\n\tli\t\t$idx,16\n\n\tlvx\t\t$rndkey0,0,$key2\n\tlvx\t\t$rndkey1,$idx,$key2\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$tweak,$tweak,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key2\n\taddi\t\t$idx,$idx,16\n\tmtctr\t\t$rounds\n\nLtweak_xts_dec:\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$tweak,$tweak,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key2\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvcipher\t\t$tweak,$tweak,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key2\n\taddi\t\t$idx,$idx,16\n\tbdnz\t\tLtweak_xts_dec\n\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvcipher\t\t$tweak,$tweak,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key2\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvcipherlast\t$tweak,$tweak,$rndkey0\n\n\tli\t\t$ivp,0\t\t\t\t# don't chain the tweak\n\tb\t\tLxts_dec\n\nLxts_dec_no_key2:\n\tneg\t\t$idx,$len\n\tandi.\t\t$idx,$idx,15\n\tadd\t\t$len,$len,$idx\t\t\t# in \"tweak chaining\"\n\t\t\t\t\t\t\t# mode only complete\n\t\t\t\t\t\t\t# blocks are processed\nLxts_dec:\n\tlvx\t\t$inptail,0,$inp\n\taddi\t\t$inp,$inp,16\n\n\t?lvsl\t\t$keyperm,0,$key1\t\t# prepare for unaligned key\n\tlwz\t\t$rounds,240($key1)\n\tsrwi\t\t$rounds,$rounds,1\n\tsubi\t\t$rounds,$rounds,1\n\tli\t\t$idx,16\n\n\tvslb\t\t$eighty7,$seven,$seven\t\t# 0x808080..80\n\tvor\t\t$eighty7,$eighty7,$seven\t# 0x878787..87\n\tvspltisb\t$tmp,1\t\t\t\t# 0x010101..01\n\tvsldoi\t\t$eighty7,$eighty7,$tmp,15\t# 0x870101..01\n\n\t${UCMP}i\t$len,96\n\tbge\t\t_aesp8_xts_decrypt6x\n\n\tlvx\t\t$rndkey0,0,$key1\n\tlvx\t\t$rndkey1,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\tvperm\t\t$inout,$inout,$inptail,$inpperm\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$inout,$inout,$tweak\n\tvxor\t\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\tmtctr\t\t$rounds\n\n\t${UCMP}i\t$len,16\n\tblt\t\tLtail_xts_dec\n\tbe?b\t\tLoop_xts_dec\n\n.align\t5\nLoop_xts_dec:\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvncipher\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvncipher\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\tbdnz\t\tLoop_xts_dec\n\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvncipher\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key1\n\tli\t\t$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$rndkey0,$rndkey0,$tweak\n\tvncipherlast\t$output,$inout,$rndkey0\n\n\tle?vperm\t$tmp,$output,$output,$leperm\n\tbe?nop\n\tle?stvx_u\t$tmp,0,$out\n\tbe?stvx_u\t$output,0,$out\n\taddi\t\t$out,$out,16\n\n\tsubic.\t\t$len,$len,16\n\tbeq\t\tLxts_dec_done\n\n\tvmr\t\t$inout,$inptail\n\tlvx\t\t$inptail,0,$inp\n\taddi\t\t$inp,$inp,16\n\tlvx\t\t$rndkey0,0,$key1\n\tlvx\t\t$rndkey1,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\n\tvsrab\t\t$tmp,$tweak,$seven\t\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\tvand\t\t$tmp,$tmp,$eighty7\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\tvperm\t\t$inout,$inout,$inptail,$inpperm\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$inout,$inout,$tweak\n\tvxor\t\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\n\tmtctr\t\t$rounds\n\t${UCMP}i\t$len,16\n\tbge\t\tLoop_xts_dec\n\nLtail_xts_dec:\n\tvsrab\t\t$tmp,$tweak,$seven\t\t# next tweak value\n\tvaddubm\t\t$tweak1,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\tvand\t\t$tmp,$tmp,$eighty7\n\tvxor\t\t$tweak1,$tweak1,$tmp\n\n\tsubi\t\t$inp,$inp,16\n\tadd\t\t$inp,$inp,$len\n\n\tvxor\t\t$inout,$inout,$tweak\t\t# :-(\n\tvxor\t\t$inout,$inout,$tweak1\t\t# :-)\n\nLoop_xts_dec_short:\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvncipher\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvncipher\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\tbdnz\t\tLoop_xts_dec_short\n\n\t?vperm\t\t$rndkey1,$rndkey1,$rndkey0,$keyperm\n\tvncipher\t$inout,$inout,$rndkey1\n\tlvx\t\t$rndkey1,$idx,$key1\n\tli\t\t$idx,16\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\tvxor\t\t$rndkey0,$rndkey0,$tweak1\n\tvncipherlast\t$output,$inout,$rndkey0\n\n\tle?vperm\t$tmp,$output,$output,$leperm\n\tbe?nop\n\tle?stvx_u\t$tmp,0,$out\n\tbe?stvx_u\t$output,0,$out\n\n\tvmr\t\t$inout,$inptail\n\tlvx\t\t$inptail,0,$inp\n\t#addi\t\t$inp,$inp,16\n\tlvx\t\t$rndkey0,0,$key1\n\tlvx\t\t$rndkey1,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\tvperm\t\t$inout,$inout,$inptail,$inpperm\n\t?vperm\t\t$rndkey0,$rndkey0,$rndkey1,$keyperm\n\n\tlvsr\t\t$inpperm,0,$len\t\t\t# $inpperm is no longer needed\n\tvxor\t\t$inptail,$inptail,$inptail\t# $inptail is no longer needed\n\tvspltisb\t$tmp,-1\n\tvperm\t\t$inptail,$inptail,$tmp,$inpperm\n\tvsel\t\t$inout,$inout,$output,$inptail\n\n\tvxor\t\t$rndkey0,$rndkey0,$tweak\n\tvxor\t\t$inout,$inout,$rndkey0\n\tlvx\t\t$rndkey0,$idx,$key1\n\taddi\t\t$idx,$idx,16\n\n\tsubi\t\tr11,$out,1\n\tmtctr\t\t$len\n\tli\t\t$len,16\nLoop_xts_dec_steal:\n\tlbzu\t\tr0,1(r11)\n\tstb\t\tr0,16(r11)\n\tbdnz\t\tLoop_xts_dec_steal\n\n\tmtctr\t\t$rounds\n\tb\t\tLoop_xts_dec\t\t\t# one more time...\n\nLxts_dec_done:\n\t${UCMP}i\t$ivp,0\n\tbeq\t\tLxts_dec_ret\n\n\tvsrab\t\t$tmp,$tweak,$seven\t\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\tvand\t\t$tmp,$tmp,$eighty7\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\tle?vperm\t$tweak,$tweak,$tweak,$leperm\n\tstvx_u\t\t$tweak,0,$ivp\n\nLxts_dec_ret:\n\tmtspr\t\t256,r12\t\t\t\t# restore vrsave\n\tli\t\tr3,0\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x04,0,0x80,6,6,0\n\t.long\t\t0\n.size\t.${prefix}_xts_decrypt,.-.${prefix}_xts_decrypt\n___\n#########################################################################\n{{\t# Optimized XTS procedures\t\t\t\t\t#\nmy $key_=$key2;\nmy ($x00,$x10,$x20,$x30,$x40,$x50,$x60,$x70)=map(\"r$_\",(0,3,26..31));\n    $x00=0 if ($flavour =~ /osx/);\nmy ($in0,  $in1,  $in2,  $in3,  $in4,  $in5 )=map(\"v$_\",(0..5));\nmy ($out0, $out1, $out2, $out3, $out4, $out5)=map(\"v$_\",(7,12..16));\nmy ($twk0, $twk1, $twk2, $twk3, $twk4, $twk5)=map(\"v$_\",(17..22));\nmy $rndkey0=\"v23\";\t# v24-v25 rotating buffer for first found keys\n\t\t\t# v26-v31 last 6 round keys\nmy ($keyperm)=($out0);\t# aliases with \"caller\", redundant assignment\nmy $taillen=$x70;\n\n$code.=<<___;\n.align\t5\n_aesp8_xts_encrypt6x:\n\t$STU\t\t$sp,-`($FRAME+21*16+6*$SIZE_T)`($sp)\n\tmflr\t\tr11\n\tli\t\tr7,`$FRAME+8*16+15`\n\tli\t\tr3,`$FRAME+8*16+31`\n\t$PUSH\t\tr11,`$FRAME+21*16+6*$SIZE_T+$LRSAVE`($sp)\n\tstvx\t\tv20,r7,$sp\t\t# ABI says so\n\taddi\t\tr7,r7,32\n\tstvx\t\tv21,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv22,r7,$sp\n\taddi\t\tr7,r7,32\n\tstvx\t\tv23,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv24,r7,$sp\n\taddi\t\tr7,r7,32\n\tstvx\t\tv25,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv26,r7,$sp\n\taddi\t\tr7,r7,32\n\tstvx\t\tv27,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv28,r7,$sp\n\taddi\t\tr7,r7,32\n\tstvx\t\tv29,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv30,r7,$sp\n\tstvx\t\tv31,r3,$sp\n\tli\t\tr0,-1\n\tstw\t\t$vrsave,`$FRAME+21*16-4`($sp)\t# save vrsave\n\tli\t\t$x10,0x10\n\t$PUSH\t\tr26,`$FRAME+21*16+0*$SIZE_T`($sp)\n\tli\t\t$x20,0x20\n\t$PUSH\t\tr27,`$FRAME+21*16+1*$SIZE_T`($sp)\n\tli\t\t$x30,0x30\n\t$PUSH\t\tr28,`$FRAME+21*16+2*$SIZE_T`($sp)\n\tli\t\t$x40,0x40\n\t$PUSH\t\tr29,`$FRAME+21*16+3*$SIZE_T`($sp)\n\tli\t\t$x50,0x50\n\t$PUSH\t\tr30,`$FRAME+21*16+4*$SIZE_T`($sp)\n\tli\t\t$x60,0x60\n\t$PUSH\t\tr31,`$FRAME+21*16+5*$SIZE_T`($sp)\n\tli\t\t$x70,0x70\n\tmtspr\t\t256,r0\n\n\tsubi\t\t$rounds,$rounds,3\t# -4 in total\n\n\tlvx\t\t$rndkey0,$x00,$key1\t# load key schedule\n\tlvx\t\tv30,$x10,$key1\n\taddi\t\t$key1,$key1,0x20\n\tlvx\t\tv31,$x00,$key1\n\t?vperm\t\t$rndkey0,$rndkey0,v30,$keyperm\n\taddi\t\t$key_,$sp,$FRAME+15\n\tmtctr\t\t$rounds\n\nLoad_xts_enc_key:\n\t?vperm\t\tv24,v30,v31,$keyperm\n\tlvx\t\tv30,$x10,$key1\n\taddi\t\t$key1,$key1,0x20\n\tstvx\t\tv24,$x00,$key_\t\t# off-load round[1]\n\t?vperm\t\tv25,v31,v30,$keyperm\n\tlvx\t\tv31,$x00,$key1\n\tstvx\t\tv25,$x10,$key_\t\t# off-load round[2]\n\taddi\t\t$key_,$key_,0x20\n\tbdnz\t\tLoad_xts_enc_key\n\n\tlvx\t\tv26,$x10,$key1\n\t?vperm\t\tv24,v30,v31,$keyperm\n\tlvx\t\tv27,$x20,$key1\n\tstvx\t\tv24,$x00,$key_\t\t# off-load round[3]\n\t?vperm\t\tv25,v31,v26,$keyperm\n\tlvx\t\tv28,$x30,$key1\n\tstvx\t\tv25,$x10,$key_\t\t# off-load round[4]\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\t?vperm\t\tv26,v26,v27,$keyperm\n\tlvx\t\tv29,$x40,$key1\n\t?vperm\t\tv27,v27,v28,$keyperm\n\tlvx\t\tv30,$x50,$key1\n\t?vperm\t\tv28,v28,v29,$keyperm\n\tlvx\t\tv31,$x60,$key1\n\t?vperm\t\tv29,v29,v30,$keyperm\n\tlvx\t\t$twk5,$x70,$key1\t# borrow $twk5\n\t?vperm\t\tv30,v30,v31,$keyperm\n\tlvx\t\tv24,$x00,$key_\t\t# pre-load round[1]\n\t?vperm\t\tv31,v31,$twk5,$keyperm\n\tlvx\t\tv25,$x10,$key_\t\t# pre-load round[2]\n\n\t vperm\t\t$in0,$inout,$inptail,$inpperm\n\t subi\t\t$inp,$inp,31\t\t# undo \"caller\"\n\tvxor\t\t$twk0,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out0,$in0,$twk0\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in1,$x10,$inp\n\tvxor\t\t$twk1,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in1,$in1,$in1,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out1,$in1,$twk1\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in2,$x20,$inp\n\t andi.\t\t$taillen,$len,15\n\tvxor\t\t$twk2,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in2,$in2,$in2,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out2,$in2,$twk2\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in3,$x30,$inp\n\t sub\t\t$len,$len,$taillen\n\tvxor\t\t$twk3,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in3,$in3,$in3,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out3,$in3,$twk3\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in4,$x40,$inp\n\t subi\t\t$len,$len,0x60\n\tvxor\t\t$twk4,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in4,$in4,$in4,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out4,$in4,$twk4\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in5,$x50,$inp\n\t addi\t\t$inp,$inp,0x60\n\tvxor\t\t$twk5,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in5,$in5,$in5,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out5,$in5,$twk5\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\tvxor\t\tv31,v31,$rndkey0\n\tmtctr\t\t$rounds\n\tb\t\tLoop_xts_enc6x\n\n.align\t5\nLoop_xts_enc6x:\n\tvcipher\t\t$out0,$out0,v24\n\tvcipher\t\t$out1,$out1,v24\n\tvcipher\t\t$out2,$out2,v24\n\tvcipher\t\t$out3,$out3,v24\n\tvcipher\t\t$out4,$out4,v24\n\tvcipher\t\t$out5,$out5,v24\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvcipher\t\t$out0,$out0,v25\n\tvcipher\t\t$out1,$out1,v25\n\tvcipher\t\t$out2,$out2,v25\n\tvcipher\t\t$out3,$out3,v25\n\tvcipher\t\t$out4,$out4,v25\n\tvcipher\t\t$out5,$out5,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\tLoop_xts_enc6x\n\n\tsubic\t\t$len,$len,96\t\t# $len-=96\n\t vxor\t\t$in0,$twk0,v31\t\t# xor with last round key\n\tvcipher\t\t$out0,$out0,v24\n\tvcipher\t\t$out1,$out1,v24\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk0,$tweak,$rndkey0\n\t vaddubm\t$tweak,$tweak,$tweak\n\tvcipher\t\t$out2,$out2,v24\n\tvcipher\t\t$out3,$out3,v24\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvcipher\t\t$out4,$out4,v24\n\tvcipher\t\t$out5,$out5,v24\n\n\tsubfe.\t\tr0,r0,r0\t\t# borrow?-1:0\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvcipher\t\t$out0,$out0,v25\n\tvcipher\t\t$out1,$out1,v25\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvcipher\t\t$out2,$out2,v25\n\tvcipher\t\t$out3,$out3,v25\n\t vxor\t\t$in1,$twk1,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk1,$tweak,$rndkey0\n\tvcipher\t\t$out4,$out4,v25\n\tvcipher\t\t$out5,$out5,v25\n\n\tand\t\tr0,r0,$len\n\t vaddubm\t$tweak,$tweak,$tweak\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvcipher\t\t$out0,$out0,v26\n\tvcipher\t\t$out1,$out1,v26\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvcipher\t\t$out2,$out2,v26\n\tvcipher\t\t$out3,$out3,v26\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvcipher\t\t$out4,$out4,v26\n\tvcipher\t\t$out5,$out5,v26\n\n\tadd\t\t$inp,$inp,r0\t\t# $inp is adjusted in such\n\t\t\t\t\t\t# way that at exit from the\n\t\t\t\t\t\t# loop inX-in5 are loaded\n\t\t\t\t\t\t# with last \"words\"\n\t vxor\t\t$in2,$twk2,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk2,$tweak,$rndkey0\n\t vaddubm\t$tweak,$tweak,$tweak\n\tvcipher\t\t$out0,$out0,v27\n\tvcipher\t\t$out1,$out1,v27\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvcipher\t\t$out2,$out2,v27\n\tvcipher\t\t$out3,$out3,v27\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvcipher\t\t$out4,$out4,v27\n\tvcipher\t\t$out5,$out5,v27\n\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvcipher\t\t$out0,$out0,v28\n\tvcipher\t\t$out1,$out1,v28\n\t vxor\t\t$in3,$twk3,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk3,$tweak,$rndkey0\n\tvcipher\t\t$out2,$out2,v28\n\tvcipher\t\t$out3,$out3,v28\n\t vaddubm\t$tweak,$tweak,$tweak\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvcipher\t\t$out4,$out4,v28\n\tvcipher\t\t$out5,$out5,v28\n\tlvx\t\tv24,$x00,$key_\t\t# re-pre-load round[1]\n\t vand\t\t$tmp,$tmp,$eighty7\n\n\tvcipher\t\t$out0,$out0,v29\n\tvcipher\t\t$out1,$out1,v29\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvcipher\t\t$out2,$out2,v29\n\tvcipher\t\t$out3,$out3,v29\n\t vxor\t\t$in4,$twk4,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk4,$tweak,$rndkey0\n\tvcipher\t\t$out4,$out4,v29\n\tvcipher\t\t$out5,$out5,v29\n\tlvx\t\tv25,$x10,$key_\t\t# re-pre-load round[2]\n\t vaddubm\t$tweak,$tweak,$tweak\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\n\tvcipher\t\t$out0,$out0,v30\n\tvcipher\t\t$out1,$out1,v30\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvcipher\t\t$out2,$out2,v30\n\tvcipher\t\t$out3,$out3,v30\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvcipher\t\t$out4,$out4,v30\n\tvcipher\t\t$out5,$out5,v30\n\t vxor\t\t$in5,$twk5,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk5,$tweak,$rndkey0\n\n\tvcipherlast\t$out0,$out0,$in0\n\t lvx_u\t\t$in0,$x00,$inp\t\t# load next input block\n\t vaddubm\t$tweak,$tweak,$tweak\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvcipherlast\t$out1,$out1,$in1\n\t lvx_u\t\t$in1,$x10,$inp\n\tvcipherlast\t$out2,$out2,$in2\n\t le?vperm\t$in0,$in0,$in0,$leperm\n\t lvx_u\t\t$in2,$x20,$inp\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvcipherlast\t$out3,$out3,$in3\n\t le?vperm\t$in1,$in1,$in1,$leperm\n\t lvx_u\t\t$in3,$x30,$inp\n\tvcipherlast\t$out4,$out4,$in4\n\t le?vperm\t$in2,$in2,$in2,$leperm\n\t lvx_u\t\t$in4,$x40,$inp\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvcipherlast\t$tmp,$out5,$in5\t\t# last block might be needed\n\t\t\t\t\t\t# in stealing mode\n\t le?vperm\t$in3,$in3,$in3,$leperm\n\t lvx_u\t\t$in5,$x50,$inp\n\t addi\t\t$inp,$inp,0x60\n\t le?vperm\t$in4,$in4,$in4,$leperm\n\t le?vperm\t$in5,$in5,$in5,$leperm\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\t vxor\t\t$out0,$in0,$twk0\n\tle?vperm\t$out2,$out2,$out2,$leperm\n\tstvx_u\t\t$out1,$x10,$out\n\t vxor\t\t$out1,$in1,$twk1\n\tle?vperm\t$out3,$out3,$out3,$leperm\n\tstvx_u\t\t$out2,$x20,$out\n\t vxor\t\t$out2,$in2,$twk2\n\tle?vperm\t$out4,$out4,$out4,$leperm\n\tstvx_u\t\t$out3,$x30,$out\n\t vxor\t\t$out3,$in3,$twk3\n\tle?vperm\t$out5,$tmp,$tmp,$leperm\n\tstvx_u\t\t$out4,$x40,$out\n\t vxor\t\t$out4,$in4,$twk4\n\tle?stvx_u\t$out5,$x50,$out\n\tbe?stvx_u\t$tmp, $x50,$out\n\t vxor\t\t$out5,$in5,$twk5\n\taddi\t\t$out,$out,0x60\n\n\tmtctr\t\t$rounds\n\tbeq\t\tLoop_xts_enc6x\t\t# did $len-=96 borrow?\n\n\taddic.\t\t$len,$len,0x60\n\tbeq\t\tLxts_enc6x_zero\n\tcmpwi\t\t$len,0x20\n\tblt\t\tLxts_enc6x_one\n\tnop\n\tbeq\t\tLxts_enc6x_two\n\tcmpwi\t\t$len,0x40\n\tblt\t\tLxts_enc6x_three\n\tnop\n\tbeq\t\tLxts_enc6x_four\n\nLxts_enc6x_five:\n\tvxor\t\t$out0,$in1,$twk0\n\tvxor\t\t$out1,$in2,$twk1\n\tvxor\t\t$out2,$in3,$twk2\n\tvxor\t\t$out3,$in4,$twk3\n\tvxor\t\t$out4,$in5,$twk4\n\n\tbl\t\t_aesp8_xts_enc5x\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tvmr\t\t$twk0,$twk5\t\t# unused tweak\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\tle?vperm\t$out2,$out2,$out2,$leperm\n\tstvx_u\t\t$out1,$x10,$out\n\tle?vperm\t$out3,$out3,$out3,$leperm\n\tstvx_u\t\t$out2,$x20,$out\n\tvxor\t\t$tmp,$out4,$twk5\t# last block prep for stealing\n\tle?vperm\t$out4,$out4,$out4,$leperm\n\tstvx_u\t\t$out3,$x30,$out\n\tstvx_u\t\t$out4,$x40,$out\n\taddi\t\t$out,$out,0x50\n\tbne\t\tLxts_enc6x_steal\n\tb\t\tLxts_enc6x_done\n\n.align\t4\nLxts_enc6x_four:\n\tvxor\t\t$out0,$in2,$twk0\n\tvxor\t\t$out1,$in3,$twk1\n\tvxor\t\t$out2,$in4,$twk2\n\tvxor\t\t$out3,$in5,$twk3\n\tvxor\t\t$out4,$out4,$out4\n\n\tbl\t\t_aesp8_xts_enc5x\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tvmr\t\t$twk0,$twk4\t\t# unused tweak\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\tle?vperm\t$out2,$out2,$out2,$leperm\n\tstvx_u\t\t$out1,$x10,$out\n\tvxor\t\t$tmp,$out3,$twk4\t# last block prep for stealing\n\tle?vperm\t$out3,$out3,$out3,$leperm\n\tstvx_u\t\t$out2,$x20,$out\n\tstvx_u\t\t$out3,$x30,$out\n\taddi\t\t$out,$out,0x40\n\tbne\t\tLxts_enc6x_steal\n\tb\t\tLxts_enc6x_done\n\n.align\t4\nLxts_enc6x_three:\n\tvxor\t\t$out0,$in3,$twk0\n\tvxor\t\t$out1,$in4,$twk1\n\tvxor\t\t$out2,$in5,$twk2\n\tvxor\t\t$out3,$out3,$out3\n\tvxor\t\t$out4,$out4,$out4\n\n\tbl\t\t_aesp8_xts_enc5x\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tvmr\t\t$twk0,$twk3\t\t# unused tweak\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\tvxor\t\t$tmp,$out2,$twk3\t# last block prep for stealing\n\tle?vperm\t$out2,$out2,$out2,$leperm\n\tstvx_u\t\t$out1,$x10,$out\n\tstvx_u\t\t$out2,$x20,$out\n\taddi\t\t$out,$out,0x30\n\tbne\t\tLxts_enc6x_steal\n\tb\t\tLxts_enc6x_done\n\n.align\t4\nLxts_enc6x_two:\n\tvxor\t\t$out0,$in4,$twk0\n\tvxor\t\t$out1,$in5,$twk1\n\tvxor\t\t$out2,$out2,$out2\n\tvxor\t\t$out3,$out3,$out3\n\tvxor\t\t$out4,$out4,$out4\n\n\tbl\t\t_aesp8_xts_enc5x\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tvmr\t\t$twk0,$twk2\t\t# unused tweak\n\tvxor\t\t$tmp,$out1,$twk2\t# last block prep for stealing\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\tstvx_u\t\t$out1,$x10,$out\n\taddi\t\t$out,$out,0x20\n\tbne\t\tLxts_enc6x_steal\n\tb\t\tLxts_enc6x_done\n\n.align\t4\nLxts_enc6x_one:\n\tvxor\t\t$out0,$in5,$twk0\n\tnop\nLoop_xts_enc1x:\n\tvcipher\t\t$out0,$out0,v24\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvcipher\t\t$out0,$out0,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\tLoop_xts_enc1x\n\n\tadd\t\t$inp,$inp,$taillen\n\tcmpwi\t\t$taillen,0\n\tvcipher\t\t$out0,$out0,v24\n\n\tsubi\t\t$inp,$inp,16\n\tvcipher\t\t$out0,$out0,v25\n\n\tlvsr\t\t$inpperm,0,$taillen\n\tvcipher\t\t$out0,$out0,v26\n\n\tlvx_u\t\t$in0,0,$inp\n\tvcipher\t\t$out0,$out0,v27\n\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\tvcipher\t\t$out0,$out0,v28\n\tlvx\t\tv24,$x00,$key_\t\t# re-pre-load round[1]\n\n\tvcipher\t\t$out0,$out0,v29\n\tlvx\t\tv25,$x10,$key_\t\t# re-pre-load round[2]\n\t vxor\t\t$twk0,$twk0,v31\n\n\tle?vperm\t$in0,$in0,$in0,$leperm\n\tvcipher\t\t$out0,$out0,v30\n\n\tvperm\t\t$in0,$in0,$in0,$inpperm\n\tvcipherlast\t$out0,$out0,$twk0\n\n\tvmr\t\t$twk0,$twk1\t\t# unused tweak\n\tvxor\t\t$tmp,$out0,$twk1\t# last block prep for stealing\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\taddi\t\t$out,$out,0x10\n\tbne\t\tLxts_enc6x_steal\n\tb\t\tLxts_enc6x_done\n\n.align\t4\nLxts_enc6x_zero:\n\tcmpwi\t\t$taillen,0\n\tbeq\t\tLxts_enc6x_done\n\n\tadd\t\t$inp,$inp,$taillen\n\tsubi\t\t$inp,$inp,16\n\tlvx_u\t\t$in0,0,$inp\n\tlvsr\t\t$inpperm,0,$taillen\t# $in5 is no more\n\tle?vperm\t$in0,$in0,$in0,$leperm\n\tvperm\t\t$in0,$in0,$in0,$inpperm\n\tvxor\t\t$tmp,$tmp,$twk0\nLxts_enc6x_steal:\n\tvxor\t\t$in0,$in0,$twk0\n\tvxor\t\t$out0,$out0,$out0\n\tvspltisb\t$out1,-1\n\tvperm\t\t$out0,$out0,$out1,$inpperm\n\tvsel\t\t$out0,$in0,$tmp,$out0\t# $tmp is last block, remember?\n\n\tsubi\t\tr30,$out,17\n\tsubi\t\t$out,$out,16\n\tmtctr\t\t$taillen\nLoop_xts_enc6x_steal:\n\tlbzu\t\tr0,1(r30)\n\tstb\t\tr0,16(r30)\n\tbdnz\t\tLoop_xts_enc6x_steal\n\n\tli\t\t$taillen,0\n\tmtctr\t\t$rounds\n\tb\t\tLoop_xts_enc1x\t\t# one more time...\n\n.align\t4\nLxts_enc6x_done:\n\t${UCMP}i\t$ivp,0\n\tbeq\t\tLxts_enc6x_ret\n\n\tvxor\t\t$tweak,$twk0,$rndkey0\n\tle?vperm\t$tweak,$tweak,$tweak,$leperm\n\tstvx_u\t\t$tweak,0,$ivp\n\nLxts_enc6x_ret:\n\tmtlr\t\tr11\n\tli\t\tr10,`$FRAME+15`\n\tli\t\tr11,`$FRAME+31`\n\tstvx\t\t$seven,r10,$sp\t\t# wipe copies of round keys\n\taddi\t\tr10,r10,32\n\tstvx\t\t$seven,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$seven,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$seven,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$seven,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$seven,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$seven,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$seven,r11,$sp\n\taddi\t\tr11,r11,32\n\n\tmtspr\t\t256,$vrsave\n\tlvx\t\tv20,r10,$sp\t\t# ABI says so\n\taddi\t\tr10,r10,32\n\tlvx\t\tv21,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv22,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv23,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv24,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv25,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv26,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv27,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv28,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv29,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv30,r10,$sp\n\tlvx\t\tv31,r11,$sp\n\t$POP\t\tr26,`$FRAME+21*16+0*$SIZE_T`($sp)\n\t$POP\t\tr27,`$FRAME+21*16+1*$SIZE_T`($sp)\n\t$POP\t\tr28,`$FRAME+21*16+2*$SIZE_T`($sp)\n\t$POP\t\tr29,`$FRAME+21*16+3*$SIZE_T`($sp)\n\t$POP\t\tr30,`$FRAME+21*16+4*$SIZE_T`($sp)\n\t$POP\t\tr31,`$FRAME+21*16+5*$SIZE_T`($sp)\n\taddi\t\t$sp,$sp,`$FRAME+21*16+6*$SIZE_T`\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x04,1,0x80,6,6,0\n\t.long\t\t0\n\n.align\t5\n_aesp8_xts_enc5x:\n\tvcipher\t\t$out0,$out0,v24\n\tvcipher\t\t$out1,$out1,v24\n\tvcipher\t\t$out2,$out2,v24\n\tvcipher\t\t$out3,$out3,v24\n\tvcipher\t\t$out4,$out4,v24\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvcipher\t\t$out0,$out0,v25\n\tvcipher\t\t$out1,$out1,v25\n\tvcipher\t\t$out2,$out2,v25\n\tvcipher\t\t$out3,$out3,v25\n\tvcipher\t\t$out4,$out4,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\t_aesp8_xts_enc5x\n\n\tadd\t\t$inp,$inp,$taillen\n\tcmpwi\t\t$taillen,0\n\tvcipher\t\t$out0,$out0,v24\n\tvcipher\t\t$out1,$out1,v24\n\tvcipher\t\t$out2,$out2,v24\n\tvcipher\t\t$out3,$out3,v24\n\tvcipher\t\t$out4,$out4,v24\n\n\tsubi\t\t$inp,$inp,16\n\tvcipher\t\t$out0,$out0,v25\n\tvcipher\t\t$out1,$out1,v25\n\tvcipher\t\t$out2,$out2,v25\n\tvcipher\t\t$out3,$out3,v25\n\tvcipher\t\t$out4,$out4,v25\n\t vxor\t\t$twk0,$twk0,v31\n\n\tvcipher\t\t$out0,$out0,v26\n\tlvsr\t\t$inpperm,r0,$taillen\t# $in5 is no more\n\tvcipher\t\t$out1,$out1,v26\n\tvcipher\t\t$out2,$out2,v26\n\tvcipher\t\t$out3,$out3,v26\n\tvcipher\t\t$out4,$out4,v26\n\t vxor\t\t$in1,$twk1,v31\n\n\tvcipher\t\t$out0,$out0,v27\n\tlvx_u\t\t$in0,0,$inp\n\tvcipher\t\t$out1,$out1,v27\n\tvcipher\t\t$out2,$out2,v27\n\tvcipher\t\t$out3,$out3,v27\n\tvcipher\t\t$out4,$out4,v27\n\t vxor\t\t$in2,$twk2,v31\n\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\tvcipher\t\t$out0,$out0,v28\n\tvcipher\t\t$out1,$out1,v28\n\tvcipher\t\t$out2,$out2,v28\n\tvcipher\t\t$out3,$out3,v28\n\tvcipher\t\t$out4,$out4,v28\n\tlvx\t\tv24,$x00,$key_\t\t# re-pre-load round[1]\n\t vxor\t\t$in3,$twk3,v31\n\n\tvcipher\t\t$out0,$out0,v29\n\tle?vperm\t$in0,$in0,$in0,$leperm\n\tvcipher\t\t$out1,$out1,v29\n\tvcipher\t\t$out2,$out2,v29\n\tvcipher\t\t$out3,$out3,v29\n\tvcipher\t\t$out4,$out4,v29\n\tlvx\t\tv25,$x10,$key_\t\t# re-pre-load round[2]\n\t vxor\t\t$in4,$twk4,v31\n\n\tvcipher\t\t$out0,$out0,v30\n\tvperm\t\t$in0,$in0,$in0,$inpperm\n\tvcipher\t\t$out1,$out1,v30\n\tvcipher\t\t$out2,$out2,v30\n\tvcipher\t\t$out3,$out3,v30\n\tvcipher\t\t$out4,$out4,v30\n\n\tvcipherlast\t$out0,$out0,$twk0\n\tvcipherlast\t$out1,$out1,$in1\n\tvcipherlast\t$out2,$out2,$in2\n\tvcipherlast\t$out3,$out3,$in3\n\tvcipherlast\t$out4,$out4,$in4\n\tblr\n        .long   \t0\n        .byte   \t0,12,0x14,0,0,0,0,0\n\n.align\t5\n_aesp8_xts_decrypt6x:\n\t$STU\t\t$sp,-`($FRAME+21*16+6*$SIZE_T)`($sp)\n\tmflr\t\tr11\n\tli\t\tr7,`$FRAME+8*16+15`\n\tli\t\tr3,`$FRAME+8*16+31`\n\t$PUSH\t\tr11,`$FRAME+21*16+6*$SIZE_T+$LRSAVE`($sp)\n\tstvx\t\tv20,r7,$sp\t\t# ABI says so\n\taddi\t\tr7,r7,32\n\tstvx\t\tv21,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv22,r7,$sp\n\taddi\t\tr7,r7,32\n\tstvx\t\tv23,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv24,r7,$sp\n\taddi\t\tr7,r7,32\n\tstvx\t\tv25,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv26,r7,$sp\n\taddi\t\tr7,r7,32\n\tstvx\t\tv27,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv28,r7,$sp\n\taddi\t\tr7,r7,32\n\tstvx\t\tv29,r3,$sp\n\taddi\t\tr3,r3,32\n\tstvx\t\tv30,r7,$sp\n\tstvx\t\tv31,r3,$sp\n\tli\t\tr0,-1\n\tstw\t\t$vrsave,`$FRAME+21*16-4`($sp)\t# save vrsave\n\tli\t\t$x10,0x10\n\t$PUSH\t\tr26,`$FRAME+21*16+0*$SIZE_T`($sp)\n\tli\t\t$x20,0x20\n\t$PUSH\t\tr27,`$FRAME+21*16+1*$SIZE_T`($sp)\n\tli\t\t$x30,0x30\n\t$PUSH\t\tr28,`$FRAME+21*16+2*$SIZE_T`($sp)\n\tli\t\t$x40,0x40\n\t$PUSH\t\tr29,`$FRAME+21*16+3*$SIZE_T`($sp)\n\tli\t\t$x50,0x50\n\t$PUSH\t\tr30,`$FRAME+21*16+4*$SIZE_T`($sp)\n\tli\t\t$x60,0x60\n\t$PUSH\t\tr31,`$FRAME+21*16+5*$SIZE_T`($sp)\n\tli\t\t$x70,0x70\n\tmtspr\t\t256,r0\n\n\tsubi\t\t$rounds,$rounds,3\t# -4 in total\n\n\tlvx\t\t$rndkey0,$x00,$key1\t# load key schedule\n\tlvx\t\tv30,$x10,$key1\n\taddi\t\t$key1,$key1,0x20\n\tlvx\t\tv31,$x00,$key1\n\t?vperm\t\t$rndkey0,$rndkey0,v30,$keyperm\n\taddi\t\t$key_,$sp,$FRAME+15\n\tmtctr\t\t$rounds\n\nLoad_xts_dec_key:\n\t?vperm\t\tv24,v30,v31,$keyperm\n\tlvx\t\tv30,$x10,$key1\n\taddi\t\t$key1,$key1,0x20\n\tstvx\t\tv24,$x00,$key_\t\t# off-load round[1]\n\t?vperm\t\tv25,v31,v30,$keyperm\n\tlvx\t\tv31,$x00,$key1\n\tstvx\t\tv25,$x10,$key_\t\t# off-load round[2]\n\taddi\t\t$key_,$key_,0x20\n\tbdnz\t\tLoad_xts_dec_key\n\n\tlvx\t\tv26,$x10,$key1\n\t?vperm\t\tv24,v30,v31,$keyperm\n\tlvx\t\tv27,$x20,$key1\n\tstvx\t\tv24,$x00,$key_\t\t# off-load round[3]\n\t?vperm\t\tv25,v31,v26,$keyperm\n\tlvx\t\tv28,$x30,$key1\n\tstvx\t\tv25,$x10,$key_\t\t# off-load round[4]\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\t?vperm\t\tv26,v26,v27,$keyperm\n\tlvx\t\tv29,$x40,$key1\n\t?vperm\t\tv27,v27,v28,$keyperm\n\tlvx\t\tv30,$x50,$key1\n\t?vperm\t\tv28,v28,v29,$keyperm\n\tlvx\t\tv31,$x60,$key1\n\t?vperm\t\tv29,v29,v30,$keyperm\n\tlvx\t\t$twk5,$x70,$key1\t# borrow $twk5\n\t?vperm\t\tv30,v30,v31,$keyperm\n\tlvx\t\tv24,$x00,$key_\t\t# pre-load round[1]\n\t?vperm\t\tv31,v31,$twk5,$keyperm\n\tlvx\t\tv25,$x10,$key_\t\t# pre-load round[2]\n\n\t vperm\t\t$in0,$inout,$inptail,$inpperm\n\t subi\t\t$inp,$inp,31\t\t# undo \"caller\"\n\tvxor\t\t$twk0,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out0,$in0,$twk0\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in1,$x10,$inp\n\tvxor\t\t$twk1,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in1,$in1,$in1,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out1,$in1,$twk1\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in2,$x20,$inp\n\t andi.\t\t$taillen,$len,15\n\tvxor\t\t$twk2,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in2,$in2,$in2,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out2,$in2,$twk2\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in3,$x30,$inp\n\t sub\t\t$len,$len,$taillen\n\tvxor\t\t$twk3,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in3,$in3,$in3,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out3,$in3,$twk3\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in4,$x40,$inp\n\t subi\t\t$len,$len,0x60\n\tvxor\t\t$twk4,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in4,$in4,$in4,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out4,$in4,$twk4\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\t lvx_u\t\t$in5,$x50,$inp\n\t addi\t\t$inp,$inp,0x60\n\tvxor\t\t$twk5,$tweak,$rndkey0\n\tvsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\tvaddubm\t\t$tweak,$tweak,$tweak\n\tvsldoi\t\t$tmp,$tmp,$tmp,15\n\t le?vperm\t$in5,$in5,$in5,$leperm\n\tvand\t\t$tmp,$tmp,$eighty7\n\t vxor\t\t$out5,$in5,$twk5\n\tvxor\t\t$tweak,$tweak,$tmp\n\n\tvxor\t\tv31,v31,$rndkey0\n\tmtctr\t\t$rounds\n\tb\t\tLoop_xts_dec6x\n\n.align\t5\nLoop_xts_dec6x:\n\tvncipher\t$out0,$out0,v24\n\tvncipher\t$out1,$out1,v24\n\tvncipher\t$out2,$out2,v24\n\tvncipher\t$out3,$out3,v24\n\tvncipher\t$out4,$out4,v24\n\tvncipher\t$out5,$out5,v24\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvncipher\t$out0,$out0,v25\n\tvncipher\t$out1,$out1,v25\n\tvncipher\t$out2,$out2,v25\n\tvncipher\t$out3,$out3,v25\n\tvncipher\t$out4,$out4,v25\n\tvncipher\t$out5,$out5,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\tLoop_xts_dec6x\n\n\tsubic\t\t$len,$len,96\t\t# $len-=96\n\t vxor\t\t$in0,$twk0,v31\t\t# xor with last round key\n\tvncipher\t$out0,$out0,v24\n\tvncipher\t$out1,$out1,v24\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk0,$tweak,$rndkey0\n\t vaddubm\t$tweak,$tweak,$tweak\n\tvncipher\t$out2,$out2,v24\n\tvncipher\t$out3,$out3,v24\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvncipher\t$out4,$out4,v24\n\tvncipher\t$out5,$out5,v24\n\n\tsubfe.\t\tr0,r0,r0\t\t# borrow?-1:0\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvncipher\t$out0,$out0,v25\n\tvncipher\t$out1,$out1,v25\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvncipher\t$out2,$out2,v25\n\tvncipher\t$out3,$out3,v25\n\t vxor\t\t$in1,$twk1,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk1,$tweak,$rndkey0\n\tvncipher\t$out4,$out4,v25\n\tvncipher\t$out5,$out5,v25\n\n\tand\t\tr0,r0,$len\n\t vaddubm\t$tweak,$tweak,$tweak\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvncipher\t$out0,$out0,v26\n\tvncipher\t$out1,$out1,v26\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvncipher\t$out2,$out2,v26\n\tvncipher\t$out3,$out3,v26\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvncipher\t$out4,$out4,v26\n\tvncipher\t$out5,$out5,v26\n\n\tadd\t\t$inp,$inp,r0\t\t# $inp is adjusted in such\n\t\t\t\t\t\t# way that at exit from the\n\t\t\t\t\t\t# loop inX-in5 are loaded\n\t\t\t\t\t\t# with last \"words\"\n\t vxor\t\t$in2,$twk2,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk2,$tweak,$rndkey0\n\t vaddubm\t$tweak,$tweak,$tweak\n\tvncipher\t$out0,$out0,v27\n\tvncipher\t$out1,$out1,v27\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvncipher\t$out2,$out2,v27\n\tvncipher\t$out3,$out3,v27\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvncipher\t$out4,$out4,v27\n\tvncipher\t$out5,$out5,v27\n\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvncipher\t$out0,$out0,v28\n\tvncipher\t$out1,$out1,v28\n\t vxor\t\t$in3,$twk3,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk3,$tweak,$rndkey0\n\tvncipher\t$out2,$out2,v28\n\tvncipher\t$out3,$out3,v28\n\t vaddubm\t$tweak,$tweak,$tweak\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvncipher\t$out4,$out4,v28\n\tvncipher\t$out5,$out5,v28\n\tlvx\t\tv24,$x00,$key_\t\t# re-pre-load round[1]\n\t vand\t\t$tmp,$tmp,$eighty7\n\n\tvncipher\t$out0,$out0,v29\n\tvncipher\t$out1,$out1,v29\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvncipher\t$out2,$out2,v29\n\tvncipher\t$out3,$out3,v29\n\t vxor\t\t$in4,$twk4,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk4,$tweak,$rndkey0\n\tvncipher\t$out4,$out4,v29\n\tvncipher\t$out5,$out5,v29\n\tlvx\t\tv25,$x10,$key_\t\t# re-pre-load round[2]\n\t vaddubm\t$tweak,$tweak,$tweak\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\n\tvncipher\t$out0,$out0,v30\n\tvncipher\t$out1,$out1,v30\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvncipher\t$out2,$out2,v30\n\tvncipher\t$out3,$out3,v30\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvncipher\t$out4,$out4,v30\n\tvncipher\t$out5,$out5,v30\n\t vxor\t\t$in5,$twk5,v31\n\t vsrab\t\t$tmp,$tweak,$seven\t# next tweak value\n\t vxor\t\t$twk5,$tweak,$rndkey0\n\n\tvncipherlast\t$out0,$out0,$in0\n\t lvx_u\t\t$in0,$x00,$inp\t\t# load next input block\n\t vaddubm\t$tweak,$tweak,$tweak\n\t vsldoi\t\t$tmp,$tmp,$tmp,15\n\tvncipherlast\t$out1,$out1,$in1\n\t lvx_u\t\t$in1,$x10,$inp\n\tvncipherlast\t$out2,$out2,$in2\n\t le?vperm\t$in0,$in0,$in0,$leperm\n\t lvx_u\t\t$in2,$x20,$inp\n\t vand\t\t$tmp,$tmp,$eighty7\n\tvncipherlast\t$out3,$out3,$in3\n\t le?vperm\t$in1,$in1,$in1,$leperm\n\t lvx_u\t\t$in3,$x30,$inp\n\tvncipherlast\t$out4,$out4,$in4\n\t le?vperm\t$in2,$in2,$in2,$leperm\n\t lvx_u\t\t$in4,$x40,$inp\n\t vxor\t\t$tweak,$tweak,$tmp\n\tvncipherlast\t$out5,$out5,$in5\n\t le?vperm\t$in3,$in3,$in3,$leperm\n\t lvx_u\t\t$in5,$x50,$inp\n\t addi\t\t$inp,$inp,0x60\n\t le?vperm\t$in4,$in4,$in4,$leperm\n\t le?vperm\t$in5,$in5,$in5,$leperm\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\t vxor\t\t$out0,$in0,$twk0\n\tle?vperm\t$out2,$out2,$out2,$leperm\n\tstvx_u\t\t$out1,$x10,$out\n\t vxor\t\t$out1,$in1,$twk1\n\tle?vperm\t$out3,$out3,$out3,$leperm\n\tstvx_u\t\t$out2,$x20,$out\n\t vxor\t\t$out2,$in2,$twk2\n\tle?vperm\t$out4,$out4,$out4,$leperm\n\tstvx_u\t\t$out3,$x30,$out\n\t vxor\t\t$out3,$in3,$twk3\n\tle?vperm\t$out5,$out5,$out5,$leperm\n\tstvx_u\t\t$out4,$x40,$out\n\t vxor\t\t$out4,$in4,$twk4\n\tstvx_u\t\t$out5,$x50,$out\n\t vxor\t\t$out5,$in5,$twk5\n\taddi\t\t$out,$out,0x60\n\n\tmtctr\t\t$rounds\n\tbeq\t\tLoop_xts_dec6x\t\t# did $len-=96 borrow?\n\n\taddic.\t\t$len,$len,0x60\n\tbeq\t\tLxts_dec6x_zero\n\tcmpwi\t\t$len,0x20\n\tblt\t\tLxts_dec6x_one\n\tnop\n\tbeq\t\tLxts_dec6x_two\n\tcmpwi\t\t$len,0x40\n\tblt\t\tLxts_dec6x_three\n\tnop\n\tbeq\t\tLxts_dec6x_four\n\nLxts_dec6x_five:\n\tvxor\t\t$out0,$in1,$twk0\n\tvxor\t\t$out1,$in2,$twk1\n\tvxor\t\t$out2,$in3,$twk2\n\tvxor\t\t$out3,$in4,$twk3\n\tvxor\t\t$out4,$in5,$twk4\n\n\tbl\t\t_aesp8_xts_dec5x\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tvmr\t\t$twk0,$twk5\t\t# unused tweak\n\tvxor\t\t$twk1,$tweak,$rndkey0\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\tvxor\t\t$out0,$in0,$twk1\n\tle?vperm\t$out2,$out2,$out2,$leperm\n\tstvx_u\t\t$out1,$x10,$out\n\tle?vperm\t$out3,$out3,$out3,$leperm\n\tstvx_u\t\t$out2,$x20,$out\n\tle?vperm\t$out4,$out4,$out4,$leperm\n\tstvx_u\t\t$out3,$x30,$out\n\tstvx_u\t\t$out4,$x40,$out\n\taddi\t\t$out,$out,0x50\n\tbne\t\tLxts_dec6x_steal\n\tb\t\tLxts_dec6x_done\n\n.align\t4\nLxts_dec6x_four:\n\tvxor\t\t$out0,$in2,$twk0\n\tvxor\t\t$out1,$in3,$twk1\n\tvxor\t\t$out2,$in4,$twk2\n\tvxor\t\t$out3,$in5,$twk3\n\tvxor\t\t$out4,$out4,$out4\n\n\tbl\t\t_aesp8_xts_dec5x\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tvmr\t\t$twk0,$twk4\t\t# unused tweak\n\tvmr\t\t$twk1,$twk5\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\tvxor\t\t$out0,$in0,$twk5\n\tle?vperm\t$out2,$out2,$out2,$leperm\n\tstvx_u\t\t$out1,$x10,$out\n\tle?vperm\t$out3,$out3,$out3,$leperm\n\tstvx_u\t\t$out2,$x20,$out\n\tstvx_u\t\t$out3,$x30,$out\n\taddi\t\t$out,$out,0x40\n\tbne\t\tLxts_dec6x_steal\n\tb\t\tLxts_dec6x_done\n\n.align\t4\nLxts_dec6x_three:\n\tvxor\t\t$out0,$in3,$twk0\n\tvxor\t\t$out1,$in4,$twk1\n\tvxor\t\t$out2,$in5,$twk2\n\tvxor\t\t$out3,$out3,$out3\n\tvxor\t\t$out4,$out4,$out4\n\n\tbl\t\t_aesp8_xts_dec5x\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tvmr\t\t$twk0,$twk3\t\t# unused tweak\n\tvmr\t\t$twk1,$twk4\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\tvxor\t\t$out0,$in0,$twk4\n\tle?vperm\t$out2,$out2,$out2,$leperm\n\tstvx_u\t\t$out1,$x10,$out\n\tstvx_u\t\t$out2,$x20,$out\n\taddi\t\t$out,$out,0x30\n\tbne\t\tLxts_dec6x_steal\n\tb\t\tLxts_dec6x_done\n\n.align\t4\nLxts_dec6x_two:\n\tvxor\t\t$out0,$in4,$twk0\n\tvxor\t\t$out1,$in5,$twk1\n\tvxor\t\t$out2,$out2,$out2\n\tvxor\t\t$out3,$out3,$out3\n\tvxor\t\t$out4,$out4,$out4\n\n\tbl\t\t_aesp8_xts_dec5x\n\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tvmr\t\t$twk0,$twk2\t\t# unused tweak\n\tvmr\t\t$twk1,$twk3\n\tle?vperm\t$out1,$out1,$out1,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\tvxor\t\t$out0,$in0,$twk3\n\tstvx_u\t\t$out1,$x10,$out\n\taddi\t\t$out,$out,0x20\n\tbne\t\tLxts_dec6x_steal\n\tb\t\tLxts_dec6x_done\n\n.align\t4\nLxts_dec6x_one:\n\tvxor\t\t$out0,$in5,$twk0\n\tnop\nLoop_xts_dec1x:\n\tvncipher\t$out0,$out0,v24\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvncipher\t$out0,$out0,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\tLoop_xts_dec1x\n\n\tsubi\t\tr0,$taillen,1\n\tvncipher\t$out0,$out0,v24\n\n\tandi.\t\tr0,r0,16\n\tcmpwi\t\t$taillen,0\n\tvncipher\t$out0,$out0,v25\n\n\tsub\t\t$inp,$inp,r0\n\tvncipher\t$out0,$out0,v26\n\n\tlvx_u\t\t$in0,0,$inp\n\tvncipher\t$out0,$out0,v27\n\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\tvncipher\t$out0,$out0,v28\n\tlvx\t\tv24,$x00,$key_\t\t# re-pre-load round[1]\n\n\tvncipher\t$out0,$out0,v29\n\tlvx\t\tv25,$x10,$key_\t\t# re-pre-load round[2]\n\t vxor\t\t$twk0,$twk0,v31\n\n\tle?vperm\t$in0,$in0,$in0,$leperm\n\tvncipher\t$out0,$out0,v30\n\n\tmtctr\t\t$rounds\n\tvncipherlast\t$out0,$out0,$twk0\n\n\tvmr\t\t$twk0,$twk1\t\t# unused tweak\n\tvmr\t\t$twk1,$twk2\n\tle?vperm\t$out0,$out0,$out0,$leperm\n\tstvx_u\t\t$out0,$x00,$out\t\t# store output\n\taddi\t\t$out,$out,0x10\n\tvxor\t\t$out0,$in0,$twk2\n\tbne\t\tLxts_dec6x_steal\n\tb\t\tLxts_dec6x_done\n\n.align\t4\nLxts_dec6x_zero:\n\tcmpwi\t\t$taillen,0\n\tbeq\t\tLxts_dec6x_done\n\n\tlvx_u\t\t$in0,0,$inp\n\tle?vperm\t$in0,$in0,$in0,$leperm\n\tvxor\t\t$out0,$in0,$twk1\nLxts_dec6x_steal:\n\tvncipher\t$out0,$out0,v24\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvncipher\t$out0,$out0,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\tLxts_dec6x_steal\n\n\tadd\t\t$inp,$inp,$taillen\n\tvncipher\t$out0,$out0,v24\n\n\tcmpwi\t\t$taillen,0\n\tvncipher\t$out0,$out0,v25\n\n\tlvx_u\t\t$in0,0,$inp\n\tvncipher\t$out0,$out0,v26\n\n\tlvsr\t\t$inpperm,0,$taillen\t# $in5 is no more\n\tvncipher\t$out0,$out0,v27\n\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\tvncipher\t$out0,$out0,v28\n\tlvx\t\tv24,$x00,$key_\t\t# re-pre-load round[1]\n\n\tvncipher\t$out0,$out0,v29\n\tlvx\t\tv25,$x10,$key_\t\t# re-pre-load round[2]\n\t vxor\t\t$twk1,$twk1,v31\n\n\tle?vperm\t$in0,$in0,$in0,$leperm\n\tvncipher\t$out0,$out0,v30\n\n\tvperm\t\t$in0,$in0,$in0,$inpperm\n\tvncipherlast\t$tmp,$out0,$twk1\n\n\tle?vperm\t$out0,$tmp,$tmp,$leperm\n\tle?stvx_u\t$out0,0,$out\n\tbe?stvx_u\t$tmp,0,$out\n\n\tvxor\t\t$out0,$out0,$out0\n\tvspltisb\t$out1,-1\n\tvperm\t\t$out0,$out0,$out1,$inpperm\n\tvsel\t\t$out0,$in0,$tmp,$out0\n\tvxor\t\t$out0,$out0,$twk0\n\n\tsubi\t\tr30,$out,1\n\tmtctr\t\t$taillen\nLoop_xts_dec6x_steal:\n\tlbzu\t\tr0,1(r30)\n\tstb\t\tr0,16(r30)\n\tbdnz\t\tLoop_xts_dec6x_steal\n\n\tli\t\t$taillen,0\n\tmtctr\t\t$rounds\n\tb\t\tLoop_xts_dec1x\t\t# one more time...\n\n.align\t4\nLxts_dec6x_done:\n\t${UCMP}i\t$ivp,0\n\tbeq\t\tLxts_dec6x_ret\n\n\tvxor\t\t$tweak,$twk0,$rndkey0\n\tle?vperm\t$tweak,$tweak,$tweak,$leperm\n\tstvx_u\t\t$tweak,0,$ivp\n\nLxts_dec6x_ret:\n\tmtlr\t\tr11\n\tli\t\tr10,`$FRAME+15`\n\tli\t\tr11,`$FRAME+31`\n\tstvx\t\t$seven,r10,$sp\t\t# wipe copies of round keys\n\taddi\t\tr10,r10,32\n\tstvx\t\t$seven,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$seven,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$seven,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$seven,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$seven,r11,$sp\n\taddi\t\tr11,r11,32\n\tstvx\t\t$seven,r10,$sp\n\taddi\t\tr10,r10,32\n\tstvx\t\t$seven,r11,$sp\n\taddi\t\tr11,r11,32\n\n\tmtspr\t\t256,$vrsave\n\tlvx\t\tv20,r10,$sp\t\t# ABI says so\n\taddi\t\tr10,r10,32\n\tlvx\t\tv21,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv22,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv23,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv24,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv25,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv26,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv27,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv28,r10,$sp\n\taddi\t\tr10,r10,32\n\tlvx\t\tv29,r11,$sp\n\taddi\t\tr11,r11,32\n\tlvx\t\tv30,r10,$sp\n\tlvx\t\tv31,r11,$sp\n\t$POP\t\tr26,`$FRAME+21*16+0*$SIZE_T`($sp)\n\t$POP\t\tr27,`$FRAME+21*16+1*$SIZE_T`($sp)\n\t$POP\t\tr28,`$FRAME+21*16+2*$SIZE_T`($sp)\n\t$POP\t\tr29,`$FRAME+21*16+3*$SIZE_T`($sp)\n\t$POP\t\tr30,`$FRAME+21*16+4*$SIZE_T`($sp)\n\t$POP\t\tr31,`$FRAME+21*16+5*$SIZE_T`($sp)\n\taddi\t\t$sp,$sp,`$FRAME+21*16+6*$SIZE_T`\n\tblr\n\t.long\t\t0\n\t.byte\t\t0,12,0x04,1,0x80,6,6,0\n\t.long\t\t0\n\n.align\t5\n_aesp8_xts_dec5x:\n\tvncipher\t$out0,$out0,v24\n\tvncipher\t$out1,$out1,v24\n\tvncipher\t$out2,$out2,v24\n\tvncipher\t$out3,$out3,v24\n\tvncipher\t$out4,$out4,v24\n\tlvx\t\tv24,$x20,$key_\t\t# round[3]\n\taddi\t\t$key_,$key_,0x20\n\n\tvncipher\t$out0,$out0,v25\n\tvncipher\t$out1,$out1,v25\n\tvncipher\t$out2,$out2,v25\n\tvncipher\t$out3,$out3,v25\n\tvncipher\t$out4,$out4,v25\n\tlvx\t\tv25,$x10,$key_\t\t# round[4]\n\tbdnz\t\t_aesp8_xts_dec5x\n\n\tsubi\t\tr0,$taillen,1\n\tvncipher\t$out0,$out0,v24\n\tvncipher\t$out1,$out1,v24\n\tvncipher\t$out2,$out2,v24\n\tvncipher\t$out3,$out3,v24\n\tvncipher\t$out4,$out4,v24\n\n\tandi.\t\tr0,r0,16\n\tcmpwi\t\t$taillen,0\n\tvncipher\t$out0,$out0,v25\n\tvncipher\t$out1,$out1,v25\n\tvncipher\t$out2,$out2,v25\n\tvncipher\t$out3,$out3,v25\n\tvncipher\t$out4,$out4,v25\n\t vxor\t\t$twk0,$twk0,v31\n\n\tsub\t\t$inp,$inp,r0\n\tvncipher\t$out0,$out0,v26\n\tvncipher\t$out1,$out1,v26\n\tvncipher\t$out2,$out2,v26\n\tvncipher\t$out3,$out3,v26\n\tvncipher\t$out4,$out4,v26\n\t vxor\t\t$in1,$twk1,v31\n\n\tvncipher\t$out0,$out0,v27\n\tlvx_u\t\t$in0,0,$inp\n\tvncipher\t$out1,$out1,v27\n\tvncipher\t$out2,$out2,v27\n\tvncipher\t$out3,$out3,v27\n\tvncipher\t$out4,$out4,v27\n\t vxor\t\t$in2,$twk2,v31\n\n\taddi\t\t$key_,$sp,$FRAME+15\t# rewind $key_\n\tvncipher\t$out0,$out0,v28\n\tvncipher\t$out1,$out1,v28\n\tvncipher\t$out2,$out2,v28\n\tvncipher\t$out3,$out3,v28\n\tvncipher\t$out4,$out4,v28\n\tlvx\t\tv24,$x00,$key_\t\t# re-pre-load round[1]\n\t vxor\t\t$in3,$twk3,v31\n\n\tvncipher\t$out0,$out0,v29\n\tle?vperm\t$in0,$in0,$in0,$leperm\n\tvncipher\t$out1,$out1,v29\n\tvncipher\t$out2,$out2,v29\n\tvncipher\t$out3,$out3,v29\n\tvncipher\t$out4,$out4,v29\n\tlvx\t\tv25,$x10,$key_\t\t# re-pre-load round[2]\n\t vxor\t\t$in4,$twk4,v31\n\n\tvncipher\t$out0,$out0,v30\n\tvncipher\t$out1,$out1,v30\n\tvncipher\t$out2,$out2,v30\n\tvncipher\t$out3,$out3,v30\n\tvncipher\t$out4,$out4,v30\n\n\tvncipherlast\t$out0,$out0,$twk0\n\tvncipherlast\t$out1,$out1,$in1\n\tvncipherlast\t$out2,$out2,$in2\n\tvncipherlast\t$out3,$out3,$in3\n\tvncipherlast\t$out4,$out4,$in4\n\tmtctr\t\t$rounds\n\tblr\n        .long   \t0\n        .byte   \t0,12,0x14,0,0,0,0,0\n___\n}}\t}}}\n\nmy $consts=1;\nforeach(split(\"\\n\",$code)) {\n        s/\\`([^\\`]*)\\`/eval($1)/geo;\n\n\t# constants table endian-specific conversion\n\tif ($consts && m/\\.(long|byte)\\s+(.+)\\s+(\\?[a-z]*)$/o) {\n\t    my $conv=$3;\n\t    my @bytes=();\n\n\t    # convert to endian-agnostic format\n\t    if ($1 eq \"long\") {\n\t      foreach (split(/,\\s*/,$2)) {\n\t\tmy $l = /^0/?oct:int;\n\t\tpush @bytes,($l>>24)&0xff,($l>>16)&0xff,($l>>8)&0xff,$l&0xff;\n\t      }\n\t    } else {\n\t\t@bytes = map(/^0/?oct:int,split(/,\\s*/,$2));\n\t    }\n\n\t    # little-endian conversion\n\t    if ($flavour =~ /le$/o) {\n\t\tSWITCH: for($conv)  {\n\t\t    /\\?inv/ && do   { @bytes=map($_^0xf,@bytes); last; };\n\t\t    /\\?rev/ && do   { @bytes=reverse(@bytes);    last; };\n\t\t}\n\t    }\n\n\t    #emit\n\t    print \".byte\\t\",join(',',map (sprintf(\"0x%02x\",$_),@bytes)),\"\\n\";\n\t    next;\n\t}\n\t$consts=0 if (m/Lconsts:/o);\t# end of table\n\n\t# instructions prefixed with '?' are endian-specific and need\n\t# to be adjusted accordingly...\n\tif ($flavour =~ /le$/o) {\t# little-endian\n\t    s/le\\?//o\t\tor\n\t    s/be\\?/#be#/o\tor\n\t    s/\\?lvsr/lvsl/o\tor\n\t    s/\\?lvsl/lvsr/o\tor\n\t    s/\\?(vperm\\s+v[0-9]+,\\s*)(v[0-9]+,\\s*)(v[0-9]+,\\s*)(v[0-9]+)/$1$3$2$4/o or\n\t    s/\\?(vsldoi\\s+v[0-9]+,\\s*)(v[0-9]+,)\\s*(v[0-9]+,\\s*)([0-9]+)/$1$3$2 16-$4/o or\n\t    s/\\?(vspltw\\s+v[0-9]+,\\s*)(v[0-9]+,)\\s*([0-9])/$1$2 3-$3/o;\n\t} else {\t\t\t# big-endian\n\t    s/le\\?/#le#/o\tor\n\t    s/be\\?//o\t\tor\n\t    s/\\?([a-z]+)/$1/o;\n\t}\n\n        print $_,\"\\n\";\n}\n\nclose STDOUT;\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}