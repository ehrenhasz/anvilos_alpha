{
  "module_name": "i82860_edac.c",
  "hash_id": "852699e6560d5077e1c9dc090ab516455052f5a91d288bb921921d1b55c538a0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/edac/i82860_edac.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/pci.h>\n#include <linux/pci_ids.h>\n#include <linux/edac.h>\n#include \"edac_module.h\"\n\n#define EDAC_MOD_STR\t\"i82860_edac\"\n\n#define i82860_printk(level, fmt, arg...) \\\n\tedac_printk(level, \"i82860\", fmt, ##arg)\n\n#define i82860_mc_printk(mci, level, fmt, arg...) \\\n\tedac_mc_chipset_printk(mci, level, \"i82860\", fmt, ##arg)\n\n#ifndef PCI_DEVICE_ID_INTEL_82860_0\n#define PCI_DEVICE_ID_INTEL_82860_0\t0x2531\n#endif\t\t\t\t \n\n#define I82860_MCHCFG 0x50\n#define I82860_GBA 0x60\n#define I82860_GBA_MASK 0x7FF\n#define I82860_GBA_SHIFT 24\n#define I82860_ERRSTS 0xC8\n#define I82860_EAP 0xE4\n#define I82860_DERRCTL_STS 0xE2\n\nenum i82860_chips {\n\tI82860 = 0,\n};\n\nstruct i82860_dev_info {\n\tconst char *ctl_name;\n};\n\nstruct i82860_error_info {\n\tu16 errsts;\n\tu32 eap;\n\tu16 derrsyn;\n\tu16 errsts2;\n};\n\nstatic const struct i82860_dev_info i82860_devs[] = {\n\t[I82860] = {\n\t\t.ctl_name = \"i82860\"},\n};\n\nstatic struct pci_dev *mci_pdev;\t \nstatic struct edac_pci_ctl_info *i82860_pci;\n\nstatic void i82860_get_error_info(struct mem_ctl_info *mci,\n\t\t\t\tstruct i82860_error_info *info)\n{\n\tstruct pci_dev *pdev;\n\n\tpdev = to_pci_dev(mci->pdev);\n\n\t \n\tpci_read_config_word(pdev, I82860_ERRSTS, &info->errsts);\n\tpci_read_config_dword(pdev, I82860_EAP, &info->eap);\n\tpci_read_config_word(pdev, I82860_DERRCTL_STS, &info->derrsyn);\n\tpci_read_config_word(pdev, I82860_ERRSTS, &info->errsts2);\n\n\tpci_write_bits16(pdev, I82860_ERRSTS, 0x0003, 0x0003);\n\n\t \n\tif (!(info->errsts2 & 0x0003))\n\t\treturn;\n\n\tif ((info->errsts ^ info->errsts2) & 0x0003) {\n\t\tpci_read_config_dword(pdev, I82860_EAP, &info->eap);\n\t\tpci_read_config_word(pdev, I82860_DERRCTL_STS, &info->derrsyn);\n\t}\n}\n\nstatic int i82860_process_error_info(struct mem_ctl_info *mci,\n\t\t\t\tstruct i82860_error_info *info,\n\t\t\t\tint handle_errors)\n{\n\tstruct dimm_info *dimm;\n\tint row;\n\n\tif (!(info->errsts2 & 0x0003))\n\t\treturn 0;\n\n\tif (!handle_errors)\n\t\treturn 1;\n\n\tif ((info->errsts ^ info->errsts2) & 0x0003) {\n\t\tedac_mc_handle_error(HW_EVENT_ERR_UNCORRECTED, mci, 1, 0, 0, 0,\n\t\t\t\t     -1, -1, -1, \"UE overwrote CE\", \"\");\n\t\tinfo->errsts = info->errsts2;\n\t}\n\n\tinfo->eap >>= PAGE_SHIFT;\n\trow = edac_mc_find_csrow_by_page(mci, info->eap);\n\tdimm = mci->csrows[row]->channels[0]->dimm;\n\n\tif (info->errsts & 0x0002)\n\t\tedac_mc_handle_error(HW_EVENT_ERR_UNCORRECTED, mci, 1,\n\t\t\t\t     info->eap, 0, 0,\n\t\t\t\t     dimm->location[0], dimm->location[1], -1,\n\t\t\t\t     \"i82860 UE\", \"\");\n\telse\n\t\tedac_mc_handle_error(HW_EVENT_ERR_CORRECTED, mci, 1,\n\t\t\t\t     info->eap, 0, info->derrsyn,\n\t\t\t\t     dimm->location[0], dimm->location[1], -1,\n\t\t\t\t     \"i82860 CE\", \"\");\n\n\treturn 1;\n}\n\nstatic void i82860_check(struct mem_ctl_info *mci)\n{\n\tstruct i82860_error_info info;\n\n\ti82860_get_error_info(mci, &info);\n\ti82860_process_error_info(mci, &info, 1);\n}\n\nstatic void i82860_init_csrows(struct mem_ctl_info *mci, struct pci_dev *pdev)\n{\n\tunsigned long last_cumul_size;\n\tu16 mchcfg_ddim;\t \n\tu16 value;\n\tu32 cumul_size;\n\tstruct csrow_info *csrow;\n\tstruct dimm_info *dimm;\n\tint index;\n\n\tpci_read_config_word(pdev, I82860_MCHCFG, &mchcfg_ddim);\n\tmchcfg_ddim = mchcfg_ddim & 0x180;\n\tlast_cumul_size = 0;\n\n\t \n\tfor (index = 0; index < mci->nr_csrows; index++) {\n\t\tcsrow = mci->csrows[index];\n\t\tdimm = csrow->channels[0]->dimm;\n\n\t\tpci_read_config_word(pdev, I82860_GBA + index * 2, &value);\n\t\tcumul_size = (value & I82860_GBA_MASK) <<\n\t\t\t(I82860_GBA_SHIFT - PAGE_SHIFT);\n\t\tedac_dbg(3, \"(%d) cumul_size 0x%x\\n\", index, cumul_size);\n\n\t\tif (cumul_size == last_cumul_size)\n\t\t\tcontinue;\t \n\n\t\tcsrow->first_page = last_cumul_size;\n\t\tcsrow->last_page = cumul_size - 1;\n\t\tdimm->nr_pages = cumul_size - last_cumul_size;\n\t\tlast_cumul_size = cumul_size;\n\t\tdimm->grain = 1 << 12;\t \n\t\tdimm->mtype = MEM_RMBS;\n\t\tdimm->dtype = DEV_UNKNOWN;\n\t\tdimm->edac_mode = mchcfg_ddim ? EDAC_SECDED : EDAC_NONE;\n\t}\n}\n\nstatic int i82860_probe1(struct pci_dev *pdev, int dev_idx)\n{\n\tstruct mem_ctl_info *mci;\n\tstruct edac_mc_layer layers[2];\n\tstruct i82860_error_info discard;\n\n\t \n\tlayers[0].type = EDAC_MC_LAYER_CHANNEL;\n\tlayers[0].size = 2;\n\tlayers[0].is_virt_csrow = true;\n\tlayers[1].type = EDAC_MC_LAYER_SLOT;\n\tlayers[1].size = 8;\n\tlayers[1].is_virt_csrow = true;\n\tmci = edac_mc_alloc(0, ARRAY_SIZE(layers), layers, 0);\n\tif (!mci)\n\t\treturn -ENOMEM;\n\n\tedac_dbg(3, \"init mci\\n\");\n\tmci->pdev = &pdev->dev;\n\tmci->mtype_cap = MEM_FLAG_DDR;\n\tmci->edac_ctl_cap = EDAC_FLAG_NONE | EDAC_FLAG_SECDED;\n\t \n\tmci->edac_cap = EDAC_FLAG_SECDED;\n\tmci->mod_name = EDAC_MOD_STR;\n\tmci->ctl_name = i82860_devs[dev_idx].ctl_name;\n\tmci->dev_name = pci_name(pdev);\n\tmci->edac_check = i82860_check;\n\tmci->ctl_page_to_phys = NULL;\n\ti82860_init_csrows(mci, pdev);\n\ti82860_get_error_info(mci, &discard);\t \n\n\t \n\tif (edac_mc_add_mc(mci)) {\n\t\tedac_dbg(3, \"failed edac_mc_add_mc()\\n\");\n\t\tgoto fail;\n\t}\n\n\t \n\ti82860_pci = edac_pci_create_generic_ctl(&pdev->dev, EDAC_MOD_STR);\n\tif (!i82860_pci) {\n\t\tprintk(KERN_WARNING\n\t\t\t\"%s(): Unable to create PCI control\\n\",\n\t\t\t__func__);\n\t\tprintk(KERN_WARNING\n\t\t\t\"%s(): PCI error report via EDAC not setup\\n\",\n\t\t\t__func__);\n\t}\n\n\t \n\tedac_dbg(3, \"success\\n\");\n\n\treturn 0;\n\nfail:\n\tedac_mc_free(mci);\n\treturn -ENODEV;\n}\n\n \nstatic int i82860_init_one(struct pci_dev *pdev,\n\t\t\t   const struct pci_device_id *ent)\n{\n\tint rc;\n\n\tedac_dbg(0, \"\\n\");\n\ti82860_printk(KERN_INFO, \"i82860 init one\\n\");\n\n\tif (pci_enable_device(pdev) < 0)\n\t\treturn -EIO;\n\n\trc = i82860_probe1(pdev, ent->driver_data);\n\n\tif (rc == 0)\n\t\tmci_pdev = pci_dev_get(pdev);\n\n\treturn rc;\n}\n\nstatic void i82860_remove_one(struct pci_dev *pdev)\n{\n\tstruct mem_ctl_info *mci;\n\n\tedac_dbg(0, \"\\n\");\n\n\tif (i82860_pci)\n\t\tedac_pci_release_generic_ctl(i82860_pci);\n\n\tif ((mci = edac_mc_del_mc(&pdev->dev)) == NULL)\n\t\treturn;\n\n\tedac_mc_free(mci);\n}\n\nstatic const struct pci_device_id i82860_pci_tbl[] = {\n\t{\n\t PCI_VEND_DEV(INTEL, 82860_0), PCI_ANY_ID, PCI_ANY_ID, 0, 0,\n\t I82860},\n\t{\n\t 0,\n\t }\t\t\t \n};\n\nMODULE_DEVICE_TABLE(pci, i82860_pci_tbl);\n\nstatic struct pci_driver i82860_driver = {\n\t.name = EDAC_MOD_STR,\n\t.probe = i82860_init_one,\n\t.remove = i82860_remove_one,\n\t.id_table = i82860_pci_tbl,\n};\n\nstatic int __init i82860_init(void)\n{\n\tint pci_rc;\n\n\tedac_dbg(3, \"\\n\");\n\n        \n       opstate_init();\n\n\tif ((pci_rc = pci_register_driver(&i82860_driver)) < 0)\n\t\tgoto fail0;\n\n\tif (!mci_pdev) {\n\t\tmci_pdev = pci_get_device(PCI_VENDOR_ID_INTEL,\n\t\t\t\t\tPCI_DEVICE_ID_INTEL_82860_0, NULL);\n\n\t\tif (mci_pdev == NULL) {\n\t\t\tedac_dbg(0, \"860 pci_get_device fail\\n\");\n\t\t\tpci_rc = -ENODEV;\n\t\t\tgoto fail1;\n\t\t}\n\n\t\tpci_rc = i82860_init_one(mci_pdev, i82860_pci_tbl);\n\n\t\tif (pci_rc < 0) {\n\t\t\tedac_dbg(0, \"860 init fail\\n\");\n\t\t\tpci_rc = -ENODEV;\n\t\t\tgoto fail1;\n\t\t}\n\t}\n\n\treturn 0;\n\nfail1:\n\tpci_unregister_driver(&i82860_driver);\n\nfail0:\n\tpci_dev_put(mci_pdev);\n\treturn pci_rc;\n}\n\nstatic void __exit i82860_exit(void)\n{\n\tedac_dbg(3, \"\\n\");\n\tpci_unregister_driver(&i82860_driver);\n\tpci_dev_put(mci_pdev);\n}\n\nmodule_init(i82860_init);\nmodule_exit(i82860_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Red Hat Inc. (http://www.redhat.com) Ben Woodard <woodard@redhat.com>\");\nMODULE_DESCRIPTION(\"ECC support for Intel 82860 memory hub controllers\");\n\nmodule_param(edac_op_state, int, 0444);\nMODULE_PARM_DESC(edac_op_state, \"EDAC Error Reporting state: 0=Poll,1=NMI\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}