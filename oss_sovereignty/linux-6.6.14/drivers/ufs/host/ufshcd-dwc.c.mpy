{
  "module_name": "ufshcd-dwc.c",
  "hash_id": "f2a55bb1784be656e3e6b8965580149061496522489066bba0748d0cd588fed8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ufs/host/ufshcd-dwc.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n\n#include <ufs/ufshcd.h>\n#include <ufs/unipro.h>\n\n#include \"ufshcd-dwc.h\"\n#include \"ufshci-dwc.h\"\n\nint ufshcd_dwc_dme_set_attrs(struct ufs_hba *hba,\n\t\t\t\tconst struct ufshcd_dme_attr_val *v, int n)\n{\n\tint ret = 0;\n\tint attr_node = 0;\n\n\tfor (attr_node = 0; attr_node < n; attr_node++) {\n\t\tret = ufshcd_dme_set_attr(hba, v[attr_node].attr_sel,\n\t\t\tATTR_SET_NOR, v[attr_node].mib_val, v[attr_node].peer);\n\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL(ufshcd_dwc_dme_set_attrs);\n\n \nstatic void ufshcd_dwc_program_clk_div(struct ufs_hba *hba, u32 divider_val)\n{\n\tufshcd_writel(hba, divider_val, DWC_UFS_REG_HCLKDIV);\n}\n\n \nstatic int ufshcd_dwc_link_is_up(struct ufs_hba *hba)\n{\n\tint dme_result = 0;\n\n\tufshcd_dme_get(hba, UIC_ARG_MIB(VS_POWERSTATE), &dme_result);\n\n\tif (dme_result == UFSHCD_LINK_IS_UP) {\n\t\tufshcd_set_link_active(hba);\n\t\treturn 0;\n\t}\n\n\treturn 1;\n}\n\n \nstatic int ufshcd_dwc_connection_setup(struct ufs_hba *hba)\n{\n\tstatic const struct ufshcd_dme_attr_val setup_attrs[] = {\n\t\t{ UIC_ARG_MIB(T_CONNECTIONSTATE), 0, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(N_DEVICEID), 0, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(N_DEVICEID_VALID), 0, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(T_PEERDEVICEID), 1, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(T_PEERCPORTID), 0, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(T_TRAFFICCLASS), 0, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(T_CPORTFLAGS), 0x6, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(T_CPORTMODE), 1, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(T_CONNECTIONSTATE), 1, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(T_CONNECTIONSTATE), 0, DME_PEER },\n\t\t{ UIC_ARG_MIB(N_DEVICEID), 1, DME_PEER },\n\t\t{ UIC_ARG_MIB(N_DEVICEID_VALID), 1, DME_PEER },\n\t\t{ UIC_ARG_MIB(T_PEERDEVICEID), 1, DME_PEER },\n\t\t{ UIC_ARG_MIB(T_PEERCPORTID), 0, DME_PEER },\n\t\t{ UIC_ARG_MIB(T_TRAFFICCLASS), 0, DME_PEER },\n\t\t{ UIC_ARG_MIB(T_CPORTFLAGS), 0x6, DME_PEER },\n\t\t{ UIC_ARG_MIB(T_CPORTMODE), 1, DME_PEER },\n\t\t{ UIC_ARG_MIB(T_CONNECTIONSTATE), 1, DME_PEER }\n\t};\n\n\treturn ufshcd_dwc_dme_set_attrs(hba, setup_attrs, ARRAY_SIZE(setup_attrs));\n}\n\n \nint ufshcd_dwc_link_startup_notify(struct ufs_hba *hba,\n\t\t\t\t\tenum ufs_notify_change_status status)\n{\n\tint err = 0;\n\n\tif (status == PRE_CHANGE) {\n\t\tufshcd_dwc_program_clk_div(hba, DWC_UFS_REG_HCLKDIV_DIV_125);\n\n\t\terr = ufshcd_vops_phy_initialization(hba);\n\t\tif (err) {\n\t\t\tdev_err(hba->dev, \"Phy setup failed (%d)\\n\", err);\n\t\t\tgoto out;\n\t\t}\n\t} else {  \n\t\terr = ufshcd_dwc_link_is_up(hba);\n\t\tif (err) {\n\t\t\tdev_err(hba->dev, \"Link is not up\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\terr = ufshcd_dwc_connection_setup(hba);\n\t\tif (err)\n\t\t\tdev_err(hba->dev, \"Connection setup failed (%d)\\n\",\n\t\t\t\t\t\t\t\t\terr);\n\t}\n\nout:\n\treturn err;\n}\nEXPORT_SYMBOL(ufshcd_dwc_link_startup_notify);\n\nMODULE_AUTHOR(\"Joao Pinto <Joao.Pinto@synopsys.com>\");\nMODULE_DESCRIPTION(\"UFS Host driver for Synopsys Designware Core\");\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}