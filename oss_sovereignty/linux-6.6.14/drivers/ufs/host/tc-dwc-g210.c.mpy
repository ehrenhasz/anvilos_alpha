{
  "module_name": "tc-dwc-g210.c",
  "hash_id": "33d593188f8e9efb14b4ad6eba24b5d55f1742346b501eda301d30d881ddb1a8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ufs/host/tc-dwc-g210.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n\n#include <ufs/ufshcd.h>\n#include <ufs/unipro.h>\n\n#include \"ufshcd-dwc.h\"\n#include \"ufshci-dwc.h\"\n#include \"tc-dwc-g210.h\"\n\n \nstatic int tc_dwc_g210_setup_40bit_rmmi(struct ufs_hba *hba)\n{\n\tstatic const struct ufshcd_dme_attr_val setup_attrs[] = {\n\t\t{ UIC_ARG_MIB(TX_GLOBALHIBERNATE), 0x00, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(REFCLKMODE), 0x01, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(CDIRECTCTRL6), 0x80, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(CBDIVFACTOR), 0x08, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(CBDCOCTRL5), 0x64, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(CBPRGTUNING), 0x09, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(RTOBSERVESELECT), 0x00, DME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(TX_REFCLKFREQ, SELIND_LN0_TX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(TX_CFGCLKFREQVAL, SELIND_LN0_TX), 0x19,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGEXTRATTR, SELIND_LN0_TX), 0x14,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(DITHERCTRL2, SELIND_LN0_TX), 0xd6,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RX_REFCLKFREQ, SELIND_LN0_RX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RX_CFGCLKFREQVAL, SELIND_LN0_RX), 0x19,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGWIDEINLN, SELIND_LN0_RX), 4,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXCDR8, SELIND_LN0_RX), 0x80,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB(DIRECTCTRL10), 0x04, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(DIRECTCTRL19), 0x02, DME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXCDR8, SELIND_LN0_RX), 0x80,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG4, SELIND_LN0_RX), 0x03,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR8, SELIND_LN0_RX), 0x16,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RXDIRECTCTRL2, SELIND_LN0_RX), 0x42,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG3, SELIND_LN0_RX), 0xa4,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RXCALCTRL, SELIND_LN0_RX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG2, SELIND_LN0_RX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR4, SELIND_LN0_RX), 0x28,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RXSQCTRL, SELIND_LN0_RX), 0x1E,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR6, SELIND_LN0_RX), 0x2f,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR6, SELIND_LN0_RX), 0x2f,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB(CBPRGPLL2), 0x00, DME_LOCAL },\n\t};\n\n\treturn ufshcd_dwc_dme_set_attrs(hba, setup_attrs,\n\t\t\t\t\t\tARRAY_SIZE(setup_attrs));\n}\n\n \nstatic int tc_dwc_g210_setup_20bit_rmmi_lane0(struct ufs_hba *hba)\n{\n\tstatic const struct ufshcd_dme_attr_val setup_attrs[] = {\n\t\t{ UIC_ARG_MIB_SEL(TX_REFCLKFREQ, SELIND_LN0_TX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(TX_CFGCLKFREQVAL, SELIND_LN0_TX), 0x19,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RX_CFGCLKFREQVAL, SELIND_LN0_RX), 0x19,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGEXTRATTR, SELIND_LN0_TX), 0x12,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(DITHERCTRL2, SELIND_LN0_TX), 0xd6,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RX_REFCLKFREQ, SELIND_LN0_RX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGWIDEINLN, SELIND_LN0_RX), 2,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXCDR8, SELIND_LN0_RX), 0x80,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB(DIRECTCTRL10), 0x04, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(DIRECTCTRL19), 0x02, DME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG4, SELIND_LN0_RX), 0x03,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR8, SELIND_LN0_RX), 0x16,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RXDIRECTCTRL2, SELIND_LN0_RX), 0x42,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG3, SELIND_LN0_RX), 0xa4,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RXCALCTRL, SELIND_LN0_RX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG2, SELIND_LN0_RX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR4, SELIND_LN0_RX), 0x28,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RXSQCTRL, SELIND_LN0_RX), 0x1E,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR6, SELIND_LN0_RX), 0x2f,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB(CBPRGPLL2), 0x00, DME_LOCAL },\n\t};\n\n\treturn ufshcd_dwc_dme_set_attrs(hba, setup_attrs,\n\t\t\t\t\t\tARRAY_SIZE(setup_attrs));\n}\n\n \nstatic int tc_dwc_g210_setup_20bit_rmmi_lane1(struct ufs_hba *hba)\n{\n\tint connected_rx_lanes = 0;\n\tint connected_tx_lanes = 0;\n\tint ret = 0;\n\n\tstatic const struct ufshcd_dme_attr_val setup_tx_attrs[] = {\n\t\t{ UIC_ARG_MIB_SEL(TX_REFCLKFREQ, SELIND_LN1_TX), 0x0d,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(TX_CFGCLKFREQVAL, SELIND_LN1_TX), 0x19,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGEXTRATTR, SELIND_LN1_TX), 0x12,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(DITHERCTRL2, SELIND_LN0_TX), 0xd6,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t};\n\n\tstatic const struct ufshcd_dme_attr_val setup_rx_attrs[] = {\n\t\t{ UIC_ARG_MIB_SEL(RX_REFCLKFREQ, SELIND_LN1_RX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RX_CFGCLKFREQVAL, SELIND_LN1_RX), 0x19,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGWIDEINLN, SELIND_LN1_RX), 2,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXCDR8, SELIND_LN1_RX), 0x80,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG4, SELIND_LN1_RX), 0x03,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR8, SELIND_LN1_RX), 0x16,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RXDIRECTCTRL2, SELIND_LN1_RX), 0x42,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG3, SELIND_LN1_RX), 0xa4,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RXCALCTRL, SELIND_LN1_RX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(ENARXDIRECTCFG2, SELIND_LN1_RX), 0x01,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR4, SELIND_LN1_RX), 0x28,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(RXSQCTRL, SELIND_LN1_RX), 0x1E,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t\t{ UIC_ARG_MIB_SEL(CFGRXOVR6, SELIND_LN1_RX), 0x2f,\n\t\t\t\t\t\t\t\tDME_LOCAL },\n\t};\n\n\t \n\tufshcd_dme_get(hba, UIC_ARG_MIB(PA_AVAILRXDATALANES),\n\t\t\t&connected_rx_lanes);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(PA_AVAILTXDATALANES),\n\t\t\t&connected_tx_lanes);\n\n\tif (connected_tx_lanes == 2) {\n\n\t\tret = ufshcd_dwc_dme_set_attrs(hba, setup_tx_attrs,\n\t\t\t\t\t\tARRAY_SIZE(setup_tx_attrs));\n\n\t\tif (ret)\n\t\t\tgoto out;\n\t}\n\n\tif (connected_rx_lanes == 2) {\n\t\tret = ufshcd_dwc_dme_set_attrs(hba, setup_rx_attrs,\n\t\t\t\t\t\tARRAY_SIZE(setup_rx_attrs));\n\t}\n\nout:\n\treturn ret;\n}\n\n \nstatic int tc_dwc_g210_setup_20bit_rmmi(struct ufs_hba *hba)\n{\n\tint ret = 0;\n\n\tstatic const struct ufshcd_dme_attr_val setup_attrs[] = {\n\t\t{ UIC_ARG_MIB(TX_GLOBALHIBERNATE), 0x00, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(REFCLKMODE), 0x01, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(CDIRECTCTRL6), 0xc0, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(CBDIVFACTOR), 0x44, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(CBDCOCTRL5), 0x64, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(CBPRGTUNING), 0x09, DME_LOCAL },\n\t\t{ UIC_ARG_MIB(RTOBSERVESELECT), 0x00, DME_LOCAL },\n\t};\n\n\tret = ufshcd_dwc_dme_set_attrs(hba, setup_attrs,\n\t\t\t\t\t\tARRAY_SIZE(setup_attrs));\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = tc_dwc_g210_setup_20bit_rmmi_lane0(hba);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = tc_dwc_g210_setup_20bit_rmmi_lane1(hba);\n\tif (ret)\n\t\tgoto out;\n\nout:\n\treturn ret;\n}\n\n \nint tc_dwc_g210_config_40_bit(struct ufs_hba *hba)\n{\n\tint ret = 0;\n\n\tdev_info(hba->dev, \"Configuring Test Chip 40-bit RMMI\\n\");\n\tret = tc_dwc_g210_setup_40bit_rmmi(hba);\n\tif (ret) {\n\t\tdev_err(hba->dev, \"Configuration failed\\n\");\n\t\tgoto out;\n\t}\n\n\t \n\tret = ufshcd_dme_set(hba, UIC_ARG_MIB(VS_MPHYCFGUPDT), 0x01);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = ufshcd_dme_set(hba, UIC_ARG_MIB(VS_DEBUGOMC), 0x01);\n\nout:\n\treturn ret;\n}\nEXPORT_SYMBOL(tc_dwc_g210_config_40_bit);\n\n \nint tc_dwc_g210_config_20_bit(struct ufs_hba *hba)\n{\n\tint ret = 0;\n\n\tdev_info(hba->dev, \"Configuring Test Chip 20-bit RMMI\\n\");\n\tret = tc_dwc_g210_setup_20bit_rmmi(hba);\n\tif (ret) {\n\t\tdev_err(hba->dev, \"Configuration failed\\n\");\n\t\tgoto out;\n\t}\n\n\t \n\tret = ufshcd_dme_set(hba, UIC_ARG_MIB(VS_MPHYCFGUPDT), 0x01);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = ufshcd_dme_set(hba, UIC_ARG_MIB(VS_DEBUGOMC), 0x01);\n\nout:\n\treturn ret;\n}\nEXPORT_SYMBOL(tc_dwc_g210_config_20_bit);\n\nMODULE_AUTHOR(\"Joao Pinto <Joao.Pinto@synopsys.com>\");\nMODULE_DESCRIPTION(\"Synopsys G210 Test Chip driver\");\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}