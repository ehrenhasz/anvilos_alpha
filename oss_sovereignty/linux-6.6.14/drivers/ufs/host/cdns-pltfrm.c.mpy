{
  "module_name": "cdns-pltfrm.c",
  "hash_id": "0519ef88e7ca7415ae6c63ebfb9fc5f087f5ea50176c1dff8cdb870e031568ff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ufs/host/cdns-pltfrm.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/of.h>\n#include <linux/time.h>\n\n#include \"ufshcd-pltfrm.h\"\n\n#define CDNS_UFS_REG_HCLKDIV\t0xFC\n#define CDNS_UFS_REG_PHY_XCFGD1\t0x113C\n#define CDNS_UFS_MAX_L4_ATTRS 12\n\nstruct cdns_ufs_host {\n\t \n\tu32 cdns_ufs_dme_attr_val[CDNS_UFS_MAX_L4_ATTRS];\n};\n\n \nstatic void cdns_ufs_get_l4_attr(struct ufs_hba *hba)\n{\n\tstruct cdns_ufs_host *host = ufshcd_get_variant(hba);\n\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_PEERDEVICEID),\n\t\t       &host->cdns_ufs_dme_attr_val[0]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_PEERCPORTID),\n\t\t       &host->cdns_ufs_dme_attr_val[1]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_TRAFFICCLASS),\n\t\t       &host->cdns_ufs_dme_attr_val[2]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_PROTOCOLID),\n\t\t       &host->cdns_ufs_dme_attr_val[3]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_CPORTFLAGS),\n\t\t       &host->cdns_ufs_dme_attr_val[4]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_TXTOKENVALUE),\n\t\t       &host->cdns_ufs_dme_attr_val[5]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_RXTOKENVALUE),\n\t\t       &host->cdns_ufs_dme_attr_val[6]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_LOCALBUFFERSPACE),\n\t\t       &host->cdns_ufs_dme_attr_val[7]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_PEERBUFFERSPACE),\n\t\t       &host->cdns_ufs_dme_attr_val[8]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_CREDITSTOSEND),\n\t\t       &host->cdns_ufs_dme_attr_val[9]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_CPORTMODE),\n\t\t       &host->cdns_ufs_dme_attr_val[10]);\n\tufshcd_dme_get(hba, UIC_ARG_MIB(T_CONNECTIONSTATE),\n\t\t       &host->cdns_ufs_dme_attr_val[11]);\n}\n\n \nstatic void cdns_ufs_set_l4_attr(struct ufs_hba *hba)\n{\n\tstruct cdns_ufs_host *host = ufshcd_get_variant(hba);\n\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_CONNECTIONSTATE), 0);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_PEERDEVICEID),\n\t\t       host->cdns_ufs_dme_attr_val[0]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_PEERCPORTID),\n\t\t       host->cdns_ufs_dme_attr_val[1]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_TRAFFICCLASS),\n\t\t       host->cdns_ufs_dme_attr_val[2]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_PROTOCOLID),\n\t\t       host->cdns_ufs_dme_attr_val[3]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_CPORTFLAGS),\n\t\t       host->cdns_ufs_dme_attr_val[4]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_TXTOKENVALUE),\n\t\t       host->cdns_ufs_dme_attr_val[5]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_RXTOKENVALUE),\n\t\t       host->cdns_ufs_dme_attr_val[6]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_LOCALBUFFERSPACE),\n\t\t       host->cdns_ufs_dme_attr_val[7]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_PEERBUFFERSPACE),\n\t\t       host->cdns_ufs_dme_attr_val[8]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_CREDITSTOSEND),\n\t\t       host->cdns_ufs_dme_attr_val[9]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_CPORTMODE),\n\t\t       host->cdns_ufs_dme_attr_val[10]);\n\tufshcd_dme_set(hba, UIC_ARG_MIB(T_CONNECTIONSTATE),\n\t\t       host->cdns_ufs_dme_attr_val[11]);\n}\n\n \nstatic int cdns_ufs_set_hclkdiv(struct ufs_hba *hba)\n{\n\tstruct ufs_clk_info *clki;\n\tstruct list_head *head = &hba->clk_list_head;\n\tunsigned long core_clk_rate = 0;\n\tu32 core_clk_div = 0;\n\n\tif (list_empty(head))\n\t\treturn 0;\n\n\tlist_for_each_entry(clki, head, list) {\n\t\tif (IS_ERR_OR_NULL(clki->clk))\n\t\t\tcontinue;\n\t\tif (!strcmp(clki->name, \"core_clk\"))\n\t\t\tcore_clk_rate = clk_get_rate(clki->clk);\n\t}\n\n\tif (!core_clk_rate) {\n\t\tdev_err(hba->dev, \"%s: unable to find core_clk rate\\n\",\n\t\t\t__func__);\n\t\treturn -EINVAL;\n\t}\n\n\tcore_clk_div = core_clk_rate / USEC_PER_SEC;\n\n\tufshcd_writel(hba, core_clk_div, CDNS_UFS_REG_HCLKDIV);\n\t \n\tmb();\n\n\treturn 0;\n}\n\n \nstatic int cdns_ufs_hce_enable_notify(struct ufs_hba *hba,\n\t\t\t\t      enum ufs_notify_change_status status)\n{\n\tif (status != PRE_CHANGE)\n\t\treturn 0;\n\n\treturn cdns_ufs_set_hclkdiv(hba);\n}\n\n \nstatic void cdns_ufs_hibern8_notify(struct ufs_hba *hba, enum uic_cmd_dme cmd,\n\t\t\t\t    enum ufs_notify_change_status status)\n{\n\tif (status == PRE_CHANGE && cmd == UIC_CMD_DME_HIBER_ENTER)\n\t\tcdns_ufs_get_l4_attr(hba);\n\tif (status == POST_CHANGE && cmd == UIC_CMD_DME_HIBER_EXIT)\n\t\tcdns_ufs_set_l4_attr(hba);\n}\n\n \nstatic int cdns_ufs_link_startup_notify(struct ufs_hba *hba,\n\t\t\t\t\tenum ufs_notify_change_status status)\n{\n\tif (status != PRE_CHANGE)\n\t\treturn 0;\n\n\t \n\tufshcd_disable_host_tx_lcc(hba);\n\n\t \n\thba->ahit = 0;\n\n\treturn 0;\n}\n\n \nstatic int cdns_ufs_init(struct ufs_hba *hba)\n{\n\tint status = 0;\n\tstruct cdns_ufs_host *host;\n\tstruct device *dev = hba->dev;\n\n\thost = devm_kzalloc(dev, sizeof(*host), GFP_KERNEL);\n\n\tif (!host)\n\t\treturn -ENOMEM;\n\tufshcd_set_variant(hba, host);\n\n\tstatus = ufshcd_vops_phy_initialization(hba);\n\n\treturn status;\n}\n\n \nstatic int cdns_ufs_m31_16nm_phy_initialization(struct ufs_hba *hba)\n{\n\tu32 data;\n\n\t \n\tdata = ufshcd_readl(hba, CDNS_UFS_REG_PHY_XCFGD1);\n\tdata |= BIT(24);\n\tufshcd_writel(hba, data, CDNS_UFS_REG_PHY_XCFGD1);\n\n\treturn 0;\n}\n\nstatic const struct ufs_hba_variant_ops cdns_ufs_pltfm_hba_vops = {\n\t.name = \"cdns-ufs-pltfm\",\n\t.init = cdns_ufs_init,\n\t.hce_enable_notify = cdns_ufs_hce_enable_notify,\n\t.link_startup_notify = cdns_ufs_link_startup_notify,\n\t.hibern8_notify = cdns_ufs_hibern8_notify,\n};\n\nstatic const struct ufs_hba_variant_ops cdns_ufs_m31_16nm_pltfm_hba_vops = {\n\t.name = \"cdns-ufs-pltfm\",\n\t.init = cdns_ufs_init,\n\t.hce_enable_notify = cdns_ufs_hce_enable_notify,\n\t.link_startup_notify = cdns_ufs_link_startup_notify,\n\t.phy_initialization = cdns_ufs_m31_16nm_phy_initialization,\n\t.hibern8_notify = cdns_ufs_hibern8_notify,\n};\n\nstatic const struct of_device_id cdns_ufs_of_match[] = {\n\t{\n\t\t.compatible = \"cdns,ufshc\",\n\t\t.data =  &cdns_ufs_pltfm_hba_vops,\n\t},\n\t{\n\t\t.compatible = \"cdns,ufshc-m31-16nm\",\n\t\t.data =  &cdns_ufs_m31_16nm_pltfm_hba_vops,\n\t},\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(of, cdns_ufs_of_match);\n\n \nstatic int cdns_ufs_pltfrm_probe(struct platform_device *pdev)\n{\n\tint err;\n\tconst struct of_device_id *of_id;\n\tstruct ufs_hba_variant_ops *vops;\n\tstruct device *dev = &pdev->dev;\n\n\tof_id = of_match_node(cdns_ufs_of_match, dev->of_node);\n\tvops = (struct ufs_hba_variant_ops *)of_id->data;\n\n\t \n\terr = ufshcd_pltfrm_init(pdev, vops);\n\tif (err)\n\t\tdev_err(dev, \"ufshcd_pltfrm_init() failed %d\\n\", err);\n\n\treturn err;\n}\n\n \nstatic int cdns_ufs_pltfrm_remove(struct platform_device *pdev)\n{\n\tstruct ufs_hba *hba =  platform_get_drvdata(pdev);\n\n\tufshcd_remove(hba);\n\treturn 0;\n}\n\nstatic const struct dev_pm_ops cdns_ufs_dev_pm_ops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(ufshcd_system_suspend, ufshcd_system_resume)\n\tSET_RUNTIME_PM_OPS(ufshcd_runtime_suspend, ufshcd_runtime_resume, NULL)\n\t.prepare\t = ufshcd_suspend_prepare,\n\t.complete\t = ufshcd_resume_complete,\n};\n\nstatic struct platform_driver cdns_ufs_pltfrm_driver = {\n\t.probe\t= cdns_ufs_pltfrm_probe,\n\t.remove\t= cdns_ufs_pltfrm_remove,\n\t.driver\t= {\n\t\t.name   = \"cdns-ufshcd\",\n\t\t.pm     = &cdns_ufs_dev_pm_ops,\n\t\t.of_match_table = cdns_ufs_of_match,\n\t},\n};\n\nmodule_platform_driver(cdns_ufs_pltfrm_driver);\n\nMODULE_AUTHOR(\"Jan Kotas <jank@cadence.com>\");\nMODULE_DESCRIPTION(\"Cadence UFS host controller platform driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}