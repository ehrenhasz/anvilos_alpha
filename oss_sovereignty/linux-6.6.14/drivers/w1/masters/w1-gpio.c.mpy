{
  "module_name": "w1-gpio.c",
  "hash_id": "ccb30449dcfb78c2922f6c8fbb23fc377a15dc097fbbe2eb94da5cc1973da5eb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/w1/masters/w1-gpio.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/w1-gpio.h>\n#include <linux/gpio/consumer.h>\n#include <linux/of_platform.h>\n#include <linux/err.h>\n#include <linux/of.h>\n#include <linux/delay.h>\n\n#include <linux/w1.h>\n\nstatic u8 w1_gpio_set_pullup(void *data, int delay)\n{\n\tstruct w1_gpio_platform_data *pdata = data;\n\n\tif (delay) {\n\t\tpdata->pullup_duration = delay;\n\t} else {\n\t\tif (pdata->pullup_duration) {\n\t\t\t \n\t\t\tgpiod_set_raw_value(pdata->gpiod, 1);\n\t\t\tmsleep(pdata->pullup_duration);\n\t\t\t \n\t\t\tgpiod_set_value(pdata->gpiod, 1);\n\t\t}\n\t\tpdata->pullup_duration = 0;\n\t}\n\n\treturn 0;\n}\n\nstatic void w1_gpio_write_bit(void *data, u8 bit)\n{\n\tstruct w1_gpio_platform_data *pdata = data;\n\n\tgpiod_set_value(pdata->gpiod, bit);\n}\n\nstatic u8 w1_gpio_read_bit(void *data)\n{\n\tstruct w1_gpio_platform_data *pdata = data;\n\n\treturn gpiod_get_value(pdata->gpiod) ? 1 : 0;\n}\n\n#if defined(CONFIG_OF)\nstatic const struct of_device_id w1_gpio_dt_ids[] = {\n\t{ .compatible = \"w1-gpio\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, w1_gpio_dt_ids);\n#endif\n\nstatic int w1_gpio_probe(struct platform_device *pdev)\n{\n\tstruct w1_bus_master *master;\n\tstruct w1_gpio_platform_data *pdata;\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *np = dev->of_node;\n\t \n\tenum gpiod_flags gflags = GPIOD_OUT_LOW_OPEN_DRAIN;\n\tint err;\n\n\tif (of_have_populated_dt()) {\n\t\tpdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\n\t\tif (!pdata)\n\t\t\treturn -ENOMEM;\n\n\t\t \n\t\tif (of_property_present(np, \"linux,open-drain\"))\n\t\t\tgflags = GPIOD_OUT_LOW;\n\n\t\tpdev->dev.platform_data = pdata;\n\t}\n\tpdata = dev_get_platdata(dev);\n\n\tif (!pdata) {\n\t\tdev_err(dev, \"No configuration data\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\tmaster = devm_kzalloc(dev, sizeof(struct w1_bus_master),\n\t\t\tGFP_KERNEL);\n\tif (!master)\n\t\treturn -ENOMEM;\n\n\tpdata->gpiod = devm_gpiod_get_index(dev, NULL, 0, gflags);\n\tif (IS_ERR(pdata->gpiod)) {\n\t\tdev_err(dev, \"gpio_request (pin) failed\\n\");\n\t\treturn PTR_ERR(pdata->gpiod);\n\t}\n\n\tpdata->pullup_gpiod =\n\t\tdevm_gpiod_get_index_optional(dev, NULL, 1, GPIOD_OUT_LOW);\n\tif (IS_ERR(pdata->pullup_gpiod)) {\n\t\tdev_err(dev, \"gpio_request_one \"\n\t\t\t\"(ext_pullup_enable_pin) failed\\n\");\n\t\treturn PTR_ERR(pdata->pullup_gpiod);\n\t}\n\n\tmaster->data = pdata;\n\tmaster->read_bit = w1_gpio_read_bit;\n\tgpiod_direction_output(pdata->gpiod, 1);\n\tmaster->write_bit = w1_gpio_write_bit;\n\n\t \n\tif (gflags == GPIOD_OUT_LOW_OPEN_DRAIN)\n\t\tmaster->set_pullup = w1_gpio_set_pullup;\n\n\terr = w1_add_master_device(master);\n\tif (err) {\n\t\tdev_err(dev, \"w1_add_master device failed\\n\");\n\t\treturn err;\n\t}\n\n\tif (pdata->enable_external_pullup)\n\t\tpdata->enable_external_pullup(1);\n\n\tif (pdata->pullup_gpiod)\n\t\tgpiod_set_value(pdata->pullup_gpiod, 1);\n\n\tplatform_set_drvdata(pdev, master);\n\n\treturn 0;\n}\n\nstatic int w1_gpio_remove(struct platform_device *pdev)\n{\n\tstruct w1_bus_master *master = platform_get_drvdata(pdev);\n\tstruct w1_gpio_platform_data *pdata = dev_get_platdata(&pdev->dev);\n\n\tif (pdata->enable_external_pullup)\n\t\tpdata->enable_external_pullup(0);\n\n\tif (pdata->pullup_gpiod)\n\t\tgpiod_set_value(pdata->pullup_gpiod, 0);\n\n\tw1_remove_master_device(master);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused w1_gpio_suspend(struct device *dev)\n{\n\tstruct w1_gpio_platform_data *pdata = dev_get_platdata(dev);\n\n\tif (pdata->enable_external_pullup)\n\t\tpdata->enable_external_pullup(0);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused w1_gpio_resume(struct device *dev)\n{\n\tstruct w1_gpio_platform_data *pdata = dev_get_platdata(dev);\n\n\tif (pdata->enable_external_pullup)\n\t\tpdata->enable_external_pullup(1);\n\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(w1_gpio_pm_ops, w1_gpio_suspend, w1_gpio_resume);\n\nstatic struct platform_driver w1_gpio_driver = {\n\t.driver = {\n\t\t.name\t= \"w1-gpio\",\n\t\t.pm\t= &w1_gpio_pm_ops,\n\t\t.of_match_table = of_match_ptr(w1_gpio_dt_ids),\n\t},\n\t.probe = w1_gpio_probe,\n\t.remove = w1_gpio_remove,\n};\n\nmodule_platform_driver(w1_gpio_driver);\n\nMODULE_DESCRIPTION(\"GPIO w1 bus master driver\");\nMODULE_AUTHOR(\"Ville Syrjala <syrjala@sci.fi>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}