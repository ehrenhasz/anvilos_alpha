{
  "module_name": "vivid-rds-gen.c",
  "hash_id": "3ba3fd8b8b07a62e5f72e4bd1f40cc085655ad8b5fc8940a7bfd9239529c5172",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/test-drivers/vivid/vivid-rds-gen.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/ktime.h>\n#include <linux/string.h>\n#include <linux/videodev2.h>\n\n#include \"vivid-rds-gen.h\"\n\nstatic u8 vivid_get_di(const struct vivid_rds_gen *rds, unsigned grp)\n{\n\tswitch (grp) {\n\tcase 0:\n\t\treturn (rds->dyn_pty << 2) | (grp & 3);\n\tcase 1:\n\t\treturn (rds->compressed << 2) | (grp & 3);\n\tcase 2:\n\t\treturn (rds->art_head << 2) | (grp & 3);\n\tcase 3:\n\t\treturn (rds->mono_stereo << 2) | (grp & 3);\n\t}\n\treturn 0;\n}\n\n \nvoid vivid_rds_generate(struct vivid_rds_gen *rds)\n{\n\tstruct v4l2_rds_data *data = rds->data;\n\tunsigned grp;\n\tunsigned idx;\n\tstruct tm tm;\n\tunsigned date;\n\tunsigned time;\n\tint l;\n\n\tfor (grp = 0; grp < VIVID_RDS_GEN_GROUPS; grp++, data += VIVID_RDS_GEN_BLKS_PER_GRP) {\n\t\tdata[0].lsb = rds->picode & 0xff;\n\t\tdata[0].msb = rds->picode >> 8;\n\t\tdata[0].block = V4L2_RDS_BLOCK_A | (V4L2_RDS_BLOCK_A << 3);\n\t\tdata[1].lsb = rds->pty << 5;\n\t\tdata[1].msb = (rds->pty >> 3) | (rds->tp << 2);\n\t\tdata[1].block = V4L2_RDS_BLOCK_B | (V4L2_RDS_BLOCK_B << 3);\n\t\tdata[3].block = V4L2_RDS_BLOCK_D | (V4L2_RDS_BLOCK_D << 3);\n\n\t\tswitch (grp) {\n\t\tcase 0 ... 3:\n\t\tcase 22 ... 25:\n\t\tcase 44 ... 47:  \n\t\t\tidx = (grp % 22) % 4;\n\t\t\tdata[1].lsb |= (rds->ta << 4) | (rds->ms << 3);\n\t\t\tdata[1].lsb |= vivid_get_di(rds, idx);\n\t\t\tdata[1].msb |= 1 << 3;\n\t\t\tdata[2].lsb = rds->picode & 0xff;\n\t\t\tdata[2].msb = rds->picode >> 8;\n\t\t\tdata[2].block = V4L2_RDS_BLOCK_C_ALT | (V4L2_RDS_BLOCK_C_ALT << 3);\n\t\t\tdata[3].lsb = rds->psname[2 * idx + 1];\n\t\t\tdata[3].msb = rds->psname[2 * idx];\n\t\t\tbreak;\n\t\tcase 4 ... 19:\n\t\tcase 26 ... 41:  \n\t\t\tidx = ((grp - 4) % 22) % 16;\n\t\t\tdata[1].lsb |= idx;\n\t\t\tdata[1].msb |= 4 << 3;\n\t\t\tdata[2].msb = rds->radiotext[4 * idx];\n\t\t\tdata[2].lsb = rds->radiotext[4 * idx + 1];\n\t\t\tdata[2].block = V4L2_RDS_BLOCK_C | (V4L2_RDS_BLOCK_C << 3);\n\t\t\tdata[3].msb = rds->radiotext[4 * idx + 2];\n\t\t\tdata[3].lsb = rds->radiotext[4 * idx + 3];\n\t\t\tbreak;\n\t\tcase 56:\n\t\t\t \n\t\t\ttime64_to_tm(ktime_get_real_seconds(), 0, &tm);\n\t\t\tl = tm.tm_mon <= 1;\n\t\t\tdate = 14956 + tm.tm_mday + ((tm.tm_year - l) * 1461) / 4 +\n\t\t\t\t((tm.tm_mon + 2 + l * 12) * 306001) / 10000;\n\t\t\ttime = (tm.tm_hour << 12) |\n\t\t\t       (tm.tm_min << 6) |\n\t\t\t       (sys_tz.tz_minuteswest >= 0 ? 0x20 : 0) |\n\t\t\t       (abs(sys_tz.tz_minuteswest) / 30);\n\t\t\tdata[1].lsb &= ~3;\n\t\t\tdata[1].lsb |= date >> 15;\n\t\t\tdata[1].msb |= 8 << 3;\n\t\t\tdata[2].lsb = (date << 1) & 0xfe;\n\t\t\tdata[2].lsb |= (time >> 16) & 1;\n\t\t\tdata[2].msb = (date >> 7) & 0xff;\n\t\t\tdata[2].block = V4L2_RDS_BLOCK_C | (V4L2_RDS_BLOCK_C << 3);\n\t\t\tdata[3].lsb = time & 0xff;\n\t\t\tdata[3].msb = (time >> 8) & 0xff;\n\t\t\tbreak;\n\t\tdefault:  \n\t\t\tdata[1].lsb |= (rds->ta << 4) | (rds->ms << 3);\n\t\t\tdata[1].lsb |= vivid_get_di(rds, grp % 22);\n\t\t\tdata[1].msb |= 0x1f << 3;\n\t\t\tdata[2].lsb = rds->picode & 0xff;\n\t\t\tdata[2].msb = rds->picode >> 8;\n\t\t\tdata[2].block = V4L2_RDS_BLOCK_C_ALT | (V4L2_RDS_BLOCK_C_ALT << 3);\n\t\t\tdata[3].lsb = rds->pty << 5;\n\t\t\tdata[3].lsb |= (rds->ta << 4) | (rds->ms << 3);\n\t\t\tdata[3].lsb |= vivid_get_di(rds, grp % 22);\n\t\t\tdata[3].msb |= rds->pty >> 3;\n\t\t\tdata[3].msb |= 0x1f << 3;\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nvoid vivid_rds_gen_fill(struct vivid_rds_gen *rds, unsigned freq,\n\t\t\t  bool alt)\n{\n\t \n\tif (rds->use_rbds) {\n\t\trds->picode = 0x2e75;  \n\t\trds->pty = alt ? 29 : 2;\n\t} else {\n\t\trds->picode = 0x8088;\n\t\trds->pty = alt ? 16 : 3;\n\t}\n\trds->mono_stereo = true;\n\trds->art_head = false;\n\trds->compressed = false;\n\trds->dyn_pty = false;\n\trds->tp = true;\n\trds->ta = alt;\n\trds->ms = true;\n\tsnprintf(rds->psname, sizeof(rds->psname), \"%6d.%1d\",\n\t\t (freq / 16) % 1000000, (((freq & 0xf) * 10) / 16) % 10);\n\tif (alt)\n\t\tstrscpy(rds->radiotext,\n\t\t\t\" The Radio Data System can switch between different Radio Texts \",\n\t\t\tsizeof(rds->radiotext));\n\telse\n\t\tstrscpy(rds->radiotext,\n\t\t\t\"An example of Radio Text as transmitted by the Radio Data System\",\n\t\t\tsizeof(rds->radiotext));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}