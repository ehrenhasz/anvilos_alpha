{
  "module_name": "vivid-osd.c",
  "hash_id": "15f8a9e006d511ea09c34a4af05af7d3a1e9af1b49e0df7872d19c72cfb0fc94",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/test-drivers/vivid/vivid-osd.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/sched.h>\n#include <linux/slab.h>\n#include <linux/font.h>\n#include <linux/mutex.h>\n#include <linux/videodev2.h>\n#include <linux/kthread.h>\n#include <linux/freezer.h>\n#include <linux/fb.h>\n#include <media/videobuf2-vmalloc.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-fh.h>\n#include <media/v4l2-event.h>\n#include <media/v4l2-common.h>\n\n#include \"vivid-core.h\"\n#include \"vivid-osd.h\"\n\n#define MAX_OSD_WIDTH  720\n#define MAX_OSD_HEIGHT 576\n\n \nstatic const u16 rgb555[16] = {\n\t0x7fff, 0x7fe0, 0x03ff, 0x03e0, 0x7c1f, 0x7c00, 0x001f, 0x0000,\n\t0xffff, 0xffe0, 0x83ff, 0x83e0, 0xfc1f, 0xfc00, 0x801f, 0x8000\n};\n\nstatic const u16 rgb565[16] = {\n\t0xffff, 0xffe0, 0x07ff, 0x07e0, 0xf81f, 0xf800, 0x001f, 0x0000,\n\t0xffff, 0xffe0, 0x07ff, 0x07e0, 0xf81f, 0xf800, 0x001f, 0x0000\n};\n\nvoid vivid_clear_fb(struct vivid_dev *dev)\n{\n\tvoid *p = dev->video_vbase;\n\tconst u16 *rgb = rgb555;\n\tunsigned x, y;\n\n\tif (dev->fb_defined.green.length == 6)\n\t\trgb = rgb565;\n\n\tfor (y = 0; y < dev->display_height; y++) {\n\t\tu16 *d = p;\n\n\t\tfor (x = 0; x < dev->display_width; x++)\n\t\t\td[x] = rgb[(y / 16 + x / 16) % 16];\n\t\tp += dev->display_byte_stride;\n\t}\n}\n\n \n\nstatic int vivid_fb_ioctl(struct fb_info *info, unsigned cmd, unsigned long arg)\n{\n\tstruct vivid_dev *dev = (struct vivid_dev *)info->par;\n\n\tswitch (cmd) {\n\tcase FBIOGET_VBLANK: {\n\t\tstruct fb_vblank vblank;\n\n\t\tmemset(&vblank, 0, sizeof(vblank));\n\t\tvblank.flags = FB_VBLANK_HAVE_COUNT | FB_VBLANK_HAVE_VCOUNT |\n\t\t\tFB_VBLANK_HAVE_VSYNC;\n\t\tvblank.count = 0;\n\t\tvblank.vcount = 0;\n\t\tvblank.hcount = 0;\n\t\tif (copy_to_user((void __user *)arg, &vblank, sizeof(vblank)))\n\t\t\treturn -EFAULT;\n\t\treturn 0;\n\t}\n\n\tdefault:\n\t\tdprintk(dev, 1, \"Unknown ioctl %08x\\n\", cmd);\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\n \n\nstatic int vivid_fb_set_var(struct vivid_dev *dev, struct fb_var_screeninfo *var)\n{\n\tdprintk(dev, 1, \"vivid_fb_set_var\\n\");\n\n\tif (var->bits_per_pixel != 16) {\n\t\tdprintk(dev, 1, \"vivid_fb_set_var - Invalid bpp\\n\");\n\t\treturn -EINVAL;\n\t}\n\tdev->display_byte_stride = var->xres * dev->bytes_per_pixel;\n\n\treturn 0;\n}\n\nstatic int vivid_fb_get_fix(struct vivid_dev *dev, struct fb_fix_screeninfo *fix)\n{\n\tdprintk(dev, 1, \"vivid_fb_get_fix\\n\");\n\tmemset(fix, 0, sizeof(struct fb_fix_screeninfo));\n\tstrscpy(fix->id, \"vioverlay fb\", sizeof(fix->id));\n\tfix->smem_start = dev->video_pbase;\n\tfix->smem_len = dev->video_buffer_size;\n\tfix->type = FB_TYPE_PACKED_PIXELS;\n\tfix->visual = FB_VISUAL_TRUECOLOR;\n\tfix->xpanstep = 1;\n\tfix->ypanstep = 1;\n\tfix->ywrapstep = 0;\n\tfix->line_length = dev->display_byte_stride;\n\tfix->accel = FB_ACCEL_NONE;\n\treturn 0;\n}\n\n \n\nstatic int _vivid_fb_check_var(struct fb_var_screeninfo *var, struct vivid_dev *dev)\n{\n\tdprintk(dev, 1, \"vivid_fb_check_var\\n\");\n\n\tvar->bits_per_pixel = 16;\n\tif (var->green.length == 5) {\n\t\tvar->red.offset = 10;\n\t\tvar->red.length = 5;\n\t\tvar->green.offset = 5;\n\t\tvar->green.length = 5;\n\t\tvar->blue.offset = 0;\n\t\tvar->blue.length = 5;\n\t\tvar->transp.offset = 15;\n\t\tvar->transp.length = 1;\n\t} else {\n\t\tvar->red.offset = 11;\n\t\tvar->red.length = 5;\n\t\tvar->green.offset = 5;\n\t\tvar->green.length = 6;\n\t\tvar->blue.offset = 0;\n\t\tvar->blue.length = 5;\n\t\tvar->transp.offset = 0;\n\t\tvar->transp.length = 0;\n\t}\n\tvar->xoffset = var->yoffset = 0;\n\tvar->left_margin = var->upper_margin = 0;\n\tvar->nonstd = 0;\n\n\tvar->vmode &= ~FB_VMODE_MASK;\n\tvar->vmode |= FB_VMODE_NONINTERLACED;\n\n\t \n\tvar->hsync_len = 24;\n\tvar->vsync_len = 2;\n\tvar->pixclock = 84316;\n\tvar->right_margin = 776;\n\tvar->lower_margin = 591;\n\treturn 0;\n}\n\nstatic int vivid_fb_check_var(struct fb_var_screeninfo *var, struct fb_info *info)\n{\n\tstruct vivid_dev *dev = (struct vivid_dev *) info->par;\n\n\tdprintk(dev, 1, \"vivid_fb_check_var\\n\");\n\treturn _vivid_fb_check_var(var, dev);\n}\n\nstatic int vivid_fb_pan_display(struct fb_var_screeninfo *var, struct fb_info *info)\n{\n\treturn 0;\n}\n\nstatic int vivid_fb_set_par(struct fb_info *info)\n{\n\tint rc = 0;\n\tstruct vivid_dev *dev = (struct vivid_dev *) info->par;\n\n\tdprintk(dev, 1, \"vivid_fb_set_par\\n\");\n\n\trc = vivid_fb_set_var(dev, &info->var);\n\tvivid_fb_get_fix(dev, &info->fix);\n\treturn rc;\n}\n\nstatic int vivid_fb_setcolreg(unsigned regno, unsigned red, unsigned green,\n\t\t\t\tunsigned blue, unsigned transp,\n\t\t\t\tstruct fb_info *info)\n{\n\tu32 color, *palette;\n\n\tif (regno >= info->cmap.len)\n\t\treturn -EINVAL;\n\n\tcolor = ((transp & 0xFF00) << 16) | ((red & 0xFF00) << 8) |\n\t\t (green & 0xFF00) | ((blue & 0xFF00) >> 8);\n\tif (regno >= 16)\n\t\treturn -EINVAL;\n\n\tpalette = info->pseudo_palette;\n\tif (info->var.bits_per_pixel == 16) {\n\t\tswitch (info->var.green.length) {\n\t\tcase 6:\n\t\t\tcolor = (red & 0xf800) |\n\t\t\t\t((green & 0xfc00) >> 5) |\n\t\t\t\t((blue & 0xf800) >> 11);\n\t\t\tbreak;\n\t\tcase 5:\n\t\t\tcolor = ((red & 0xf800) >> 1) |\n\t\t\t\t((green & 0xf800) >> 6) |\n\t\t\t\t((blue & 0xf800) >> 11) |\n\t\t\t\t(transp ? 0x8000 : 0);\n\t\t\tbreak;\n\t\t}\n\t}\n\tpalette[regno] = color;\n\treturn 0;\n}\n\n \nstatic int vivid_fb_blank(int blank_mode, struct fb_info *info)\n{\n\tstruct vivid_dev *dev = (struct vivid_dev *)info->par;\n\n\tdprintk(dev, 1, \"Set blanking mode : %d\\n\", blank_mode);\n\tswitch (blank_mode) {\n\tcase FB_BLANK_UNBLANK:\n\t\tbreak;\n\tcase FB_BLANK_NORMAL:\n\tcase FB_BLANK_HSYNC_SUSPEND:\n\tcase FB_BLANK_VSYNC_SUSPEND:\n\tcase FB_BLANK_POWERDOWN:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic const struct fb_ops vivid_fb_ops = {\n\t.owner = THIS_MODULE,\n\tFB_DEFAULT_IOMEM_OPS,\n\t.fb_check_var   = vivid_fb_check_var,\n\t.fb_set_par     = vivid_fb_set_par,\n\t.fb_setcolreg   = vivid_fb_setcolreg,\n\t.fb_cursor      = NULL,\n\t.fb_ioctl       = vivid_fb_ioctl,\n\t.fb_pan_display = vivid_fb_pan_display,\n\t.fb_blank       = vivid_fb_blank,\n};\n\n \n\n\n \nstatic int vivid_fb_init_vidmode(struct vivid_dev *dev)\n{\n\tstruct v4l2_rect start_window;\n\n\t \n\n\tdev->bits_per_pixel = 16;\n\tdev->bytes_per_pixel = dev->bits_per_pixel / 8;\n\n\tstart_window.width = MAX_OSD_WIDTH;\n\tstart_window.left = 0;\n\n\tdev->display_byte_stride = start_window.width * dev->bytes_per_pixel;\n\n\t \n\n\tstart_window.height = MAX_OSD_HEIGHT;\n\tstart_window.top = 0;\n\n\tdev->display_width = start_window.width;\n\tdev->display_height = start_window.height;\n\n\t \n\n\tdev->fb_defined.xres = dev->display_width;\n\tdev->fb_defined.yres = dev->display_height;\n\tdev->fb_defined.xres_virtual = dev->display_width;\n\tdev->fb_defined.yres_virtual = dev->display_height;\n\tdev->fb_defined.bits_per_pixel = dev->bits_per_pixel;\n\tdev->fb_defined.vmode = FB_VMODE_NONINTERLACED;\n\tdev->fb_defined.left_margin = start_window.left + 1;\n\tdev->fb_defined.upper_margin = start_window.top + 1;\n\tdev->fb_defined.accel_flags = FB_ACCEL_NONE;\n\tdev->fb_defined.nonstd = 0;\n\t \n\tdev->fb_defined.green.length = 5;\n\n\t \n\t_vivid_fb_check_var(&dev->fb_defined, dev);\n\n\t \n\n\tvivid_fb_get_fix(dev, &dev->fb_fix);\n\n\t \n\n\tdev->fb_info.node = -1;\n\tdev->fb_info.par = dev;\n\tdev->fb_info.var = dev->fb_defined;\n\tdev->fb_info.fix = dev->fb_fix;\n\tdev->fb_info.screen_base = (u8 __iomem *)dev->video_vbase;\n\tdev->fb_info.fbops = &vivid_fb_ops;\n\n\t \n\tdev->fb_info.monspecs.hfmin = 8000;\n\tdev->fb_info.monspecs.hfmax = 70000;\n\tdev->fb_info.monspecs.vfmin = 10;\n\tdev->fb_info.monspecs.vfmax = 100;\n\n\t \n\tif (fb_alloc_cmap(&dev->fb_info.cmap, 256, 1)) {\n\t\tpr_err(\"abort, unable to alloc cmap\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\t \n\tdev->fb_info.pseudo_palette = kmalloc_array(16, sizeof(u32), GFP_KERNEL);\n\n\treturn dev->fb_info.pseudo_palette ? 0 : -ENOMEM;\n}\n\n \nvoid vivid_fb_release_buffers(struct vivid_dev *dev)\n{\n\tif (dev->video_vbase == NULL)\n\t\treturn;\n\n\t \n\tif (dev->fb_info.cmap.len)\n\t\tfb_dealloc_cmap(&dev->fb_info.cmap);\n\n\t \n\tkfree(dev->fb_info.pseudo_palette);\n\tkfree(dev->video_vbase);\n}\n\n \n\nint vivid_fb_init(struct vivid_dev *dev)\n{\n\tint ret;\n\n\tdev->video_buffer_size = MAX_OSD_HEIGHT * MAX_OSD_WIDTH * 2;\n\tdev->video_vbase = kzalloc(dev->video_buffer_size, GFP_KERNEL);\n\tif (dev->video_vbase == NULL)\n\t\treturn -ENOMEM;\n\tdev->video_pbase = virt_to_phys(dev->video_vbase);\n\n\tpr_info(\"Framebuffer at 0x%lx, mapped to 0x%p, size %dk\\n\",\n\t\t\tdev->video_pbase, dev->video_vbase,\n\t\t\tdev->video_buffer_size / 1024);\n\n\t \n\tret = vivid_fb_init_vidmode(dev);\n\tif (ret) {\n\t\tvivid_fb_release_buffers(dev);\n\t\treturn ret;\n\t}\n\n\tvivid_clear_fb(dev);\n\n\t \n\tif (register_framebuffer(&dev->fb_info) < 0) {\n\t\tvivid_fb_release_buffers(dev);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tvivid_fb_set_par(&dev->fb_info);\n\treturn 0;\n\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}