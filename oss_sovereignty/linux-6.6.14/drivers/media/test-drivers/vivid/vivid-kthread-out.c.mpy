{
  "module_name": "vivid-kthread-out.c",
  "hash_id": "ebd9d39cc96d1ff1138062468b372f41490f2244887054a69ff78b2895be413f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/test-drivers/vivid/vivid-kthread-out.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/sched.h>\n#include <linux/slab.h>\n#include <linux/font.h>\n#include <linux/mutex.h>\n#include <linux/videodev2.h>\n#include <linux/kthread.h>\n#include <linux/freezer.h>\n#include <linux/random.h>\n#include <linux/v4l2-dv-timings.h>\n#include <linux/jiffies.h>\n#include <asm/div64.h>\n#include <media/videobuf2-vmalloc.h>\n#include <media/v4l2-dv-timings.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-fh.h>\n#include <media/v4l2-event.h>\n\n#include \"vivid-core.h\"\n#include \"vivid-vid-common.h\"\n#include \"vivid-vid-cap.h\"\n#include \"vivid-vid-out.h\"\n#include \"vivid-radio-common.h\"\n#include \"vivid-radio-rx.h\"\n#include \"vivid-radio-tx.h\"\n#include \"vivid-sdr-cap.h\"\n#include \"vivid-vbi-cap.h\"\n#include \"vivid-vbi-out.h\"\n#include \"vivid-osd.h\"\n#include \"vivid-ctrls.h\"\n#include \"vivid-kthread-out.h\"\n#include \"vivid-meta-out.h\"\n\nstatic void vivid_thread_vid_out_tick(struct vivid_dev *dev)\n{\n\tstruct vivid_buffer *vid_out_buf = NULL;\n\tstruct vivid_buffer *vbi_out_buf = NULL;\n\tstruct vivid_buffer *meta_out_buf = NULL;\n\n\tdprintk(dev, 1, \"Video Output Thread Tick\\n\");\n\n\t \n\tif (dev->perc_dropped_buffers &&\n\t    get_random_u32_below(100) < dev->perc_dropped_buffers)\n\t\treturn;\n\n\tspin_lock(&dev->slock);\n\t \n\tif (!list_empty(&dev->vid_out_active) &&\n\t    !list_is_singular(&dev->vid_out_active)) {\n\t\tvid_out_buf = list_entry(dev->vid_out_active.next,\n\t\t\t\t\t struct vivid_buffer, list);\n\t\tlist_del(&vid_out_buf->list);\n\t}\n\tif (!list_empty(&dev->vbi_out_active) &&\n\t    (dev->field_out != V4L2_FIELD_ALTERNATE ||\n\t     (dev->vbi_out_seq_count & 1))) {\n\t\tvbi_out_buf = list_entry(dev->vbi_out_active.next,\n\t\t\t\t\t struct vivid_buffer, list);\n\t\tlist_del(&vbi_out_buf->list);\n\t}\n\tif (!list_empty(&dev->meta_out_active)) {\n\t\tmeta_out_buf = list_entry(dev->meta_out_active.next,\n\t\t\t\t\t  struct vivid_buffer, list);\n\t\tlist_del(&meta_out_buf->list);\n\t}\n\tspin_unlock(&dev->slock);\n\n\tif (!vid_out_buf && !vbi_out_buf && !meta_out_buf)\n\t\treturn;\n\n\tif (vid_out_buf) {\n\t\tv4l2_ctrl_request_setup(vid_out_buf->vb.vb2_buf.req_obj.req,\n\t\t\t\t\t&dev->ctrl_hdl_vid_out);\n\t\tv4l2_ctrl_request_complete(vid_out_buf->vb.vb2_buf.req_obj.req,\n\t\t\t\t\t   &dev->ctrl_hdl_vid_out);\n\t\tvid_out_buf->vb.sequence = dev->vid_out_seq_count;\n\t\tif (dev->field_out == V4L2_FIELD_ALTERNATE) {\n\t\t\t \n\t\t\tvid_out_buf->vb.sequence /= 2;\n\t\t}\n\t\tvid_out_buf->vb.vb2_buf.timestamp =\n\t\t\tktime_get_ns() + dev->time_wrap_offset;\n\t\tvb2_buffer_done(&vid_out_buf->vb.vb2_buf, dev->dqbuf_error ?\n\t\t\t\tVB2_BUF_STATE_ERROR : VB2_BUF_STATE_DONE);\n\t\tdprintk(dev, 2, \"vid_out buffer %d done\\n\",\n\t\t\tvid_out_buf->vb.vb2_buf.index);\n\t}\n\n\tif (vbi_out_buf) {\n\t\tv4l2_ctrl_request_setup(vbi_out_buf->vb.vb2_buf.req_obj.req,\n\t\t\t\t\t&dev->ctrl_hdl_vbi_out);\n\t\tv4l2_ctrl_request_complete(vbi_out_buf->vb.vb2_buf.req_obj.req,\n\t\t\t\t\t   &dev->ctrl_hdl_vbi_out);\n\t\tif (dev->stream_sliced_vbi_out)\n\t\t\tvivid_sliced_vbi_out_process(dev, vbi_out_buf);\n\n\t\tvbi_out_buf->vb.sequence = dev->vbi_out_seq_count;\n\t\tvbi_out_buf->vb.vb2_buf.timestamp =\n\t\t\tktime_get_ns() + dev->time_wrap_offset;\n\t\tvb2_buffer_done(&vbi_out_buf->vb.vb2_buf, dev->dqbuf_error ?\n\t\t\t\tVB2_BUF_STATE_ERROR : VB2_BUF_STATE_DONE);\n\t\tdprintk(dev, 2, \"vbi_out buffer %d done\\n\",\n\t\t\tvbi_out_buf->vb.vb2_buf.index);\n\t}\n\tif (meta_out_buf) {\n\t\tv4l2_ctrl_request_setup(meta_out_buf->vb.vb2_buf.req_obj.req,\n\t\t\t\t\t&dev->ctrl_hdl_meta_out);\n\t\tv4l2_ctrl_request_complete(meta_out_buf->vb.vb2_buf.req_obj.req,\n\t\t\t\t\t   &dev->ctrl_hdl_meta_out);\n\t\tvivid_meta_out_process(dev, meta_out_buf);\n\t\tmeta_out_buf->vb.sequence = dev->meta_out_seq_count;\n\t\tmeta_out_buf->vb.vb2_buf.timestamp =\n\t\t\tktime_get_ns() + dev->time_wrap_offset;\n\t\tvb2_buffer_done(&meta_out_buf->vb.vb2_buf, dev->dqbuf_error ?\n\t\t\t\tVB2_BUF_STATE_ERROR : VB2_BUF_STATE_DONE);\n\t\tdprintk(dev, 2, \"meta_out buffer %d done\\n\",\n\t\t\tmeta_out_buf->vb.vb2_buf.index);\n\t}\n\n\tdev->dqbuf_error = false;\n}\n\nstatic int vivid_thread_vid_out(void *data)\n{\n\tstruct vivid_dev *dev = data;\n\tu64 numerators_since_start;\n\tu64 buffers_since_start;\n\tu64 next_jiffies_since_start;\n\tunsigned long jiffies_since_start;\n\tunsigned long cur_jiffies;\n\tunsigned wait_jiffies;\n\tunsigned numerator;\n\tunsigned denominator;\n\n\tdprintk(dev, 1, \"Video Output Thread Start\\n\");\n\n\tset_freezable();\n\n\t \n\tdev->out_seq_offset = 0;\n\tdev->out_seq_count = 0;\n\tdev->jiffies_vid_out = jiffies;\n\tdev->out_seq_resync = false;\n\tif (dev->time_wrap)\n\t\tdev->time_wrap_offset = dev->time_wrap - ktime_get_ns();\n\telse\n\t\tdev->time_wrap_offset = 0;\n\n\tfor (;;) {\n\t\ttry_to_freeze();\n\t\tif (kthread_should_stop())\n\t\t\tbreak;\n\n\t\tif (!mutex_trylock(&dev->mutex)) {\n\t\t\tschedule();\n\t\t\tcontinue;\n\t\t}\n\n\t\tcur_jiffies = jiffies;\n\t\tif (dev->out_seq_resync) {\n\t\t\tdev->jiffies_vid_out = cur_jiffies;\n\t\t\tdev->out_seq_offset = dev->out_seq_count + 1;\n\t\t\tdev->out_seq_count = 0;\n\t\t\tdev->out_seq_resync = false;\n\t\t}\n\t\tnumerator = dev->timeperframe_vid_out.numerator;\n\t\tdenominator = dev->timeperframe_vid_out.denominator;\n\n\t\tif (dev->field_out == V4L2_FIELD_ALTERNATE)\n\t\t\tdenominator *= 2;\n\n\t\t \n\t\tjiffies_since_start = cur_jiffies - dev->jiffies_vid_out;\n\t\t \n\t\tbuffers_since_start = (u64)jiffies_since_start * denominator +\n\t\t\t\t      (HZ * numerator) / 2;\n\t\tdo_div(buffers_since_start, HZ * numerator);\n\n\t\t \n\t\tif (jiffies_since_start > JIFFIES_RESYNC) {\n\t\t\tdev->jiffies_vid_out = cur_jiffies;\n\t\t\tdev->out_seq_offset = buffers_since_start;\n\t\t\tbuffers_since_start = 0;\n\t\t}\n\t\tdev->out_seq_count = buffers_since_start + dev->out_seq_offset;\n\t\tdev->vid_out_seq_count = dev->out_seq_count - dev->vid_out_seq_start;\n\t\tdev->vbi_out_seq_count = dev->out_seq_count - dev->vbi_out_seq_start;\n\t\tdev->meta_out_seq_count = dev->out_seq_count - dev->meta_out_seq_start;\n\n\t\tvivid_thread_vid_out_tick(dev);\n\t\tmutex_unlock(&dev->mutex);\n\n\t\t \n\t\tnumerators_since_start = buffers_since_start * numerator;\n\n\t\t \n\t\tjiffies_since_start = jiffies - dev->jiffies_vid_out;\n\n\t\t \n\t\tnumerators_since_start += numerator;\n\t\t \n\t\tnext_jiffies_since_start = numerators_since_start * HZ +\n\t\t\t\t\t   denominator / 2;\n\t\tdo_div(next_jiffies_since_start, denominator);\n\t\t \n\t\tif (next_jiffies_since_start < jiffies_since_start)\n\t\t\tnext_jiffies_since_start = jiffies_since_start;\n\n\t\twait_jiffies = next_jiffies_since_start - jiffies_since_start;\n\t\twhile (time_is_after_jiffies(cur_jiffies + wait_jiffies) &&\n\t\t       !kthread_should_stop())\n\t\t\tschedule();\n\t}\n\tdprintk(dev, 1, \"Video Output Thread End\\n\");\n\treturn 0;\n}\n\nstatic void vivid_grab_controls(struct vivid_dev *dev, bool grab)\n{\n\tv4l2_ctrl_grab(dev->ctrl_has_crop_out, grab);\n\tv4l2_ctrl_grab(dev->ctrl_has_compose_out, grab);\n\tv4l2_ctrl_grab(dev->ctrl_has_scaler_out, grab);\n\tv4l2_ctrl_grab(dev->ctrl_tx_mode, grab);\n\tv4l2_ctrl_grab(dev->ctrl_tx_rgb_range, grab);\n}\n\nint vivid_start_generating_vid_out(struct vivid_dev *dev, bool *pstreaming)\n{\n\tdprintk(dev, 1, \"%s\\n\", __func__);\n\n\tif (dev->kthread_vid_out) {\n\t\tu32 seq_count = dev->out_seq_count + dev->seq_wrap * 128;\n\n\t\tif (pstreaming == &dev->vid_out_streaming)\n\t\t\tdev->vid_out_seq_start = seq_count;\n\t\telse if (pstreaming == &dev->vbi_out_streaming)\n\t\t\tdev->vbi_out_seq_start = seq_count;\n\t\telse\n\t\t\tdev->meta_out_seq_start = seq_count;\n\t\t*pstreaming = true;\n\t\treturn 0;\n\t}\n\n\t \n\tdev->jiffies_vid_out = jiffies;\n\tdev->vid_out_seq_start = dev->seq_wrap * 128;\n\tdev->vbi_out_seq_start = dev->seq_wrap * 128;\n\tdev->meta_out_seq_start = dev->seq_wrap * 128;\n\n\tdev->kthread_vid_out = kthread_run(vivid_thread_vid_out, dev,\n\t\t\t\"%s-vid-out\", dev->v4l2_dev.name);\n\n\tif (IS_ERR(dev->kthread_vid_out)) {\n\t\tint err = PTR_ERR(dev->kthread_vid_out);\n\n\t\tdev->kthread_vid_out = NULL;\n\t\tv4l2_err(&dev->v4l2_dev, \"kernel_thread() failed\\n\");\n\t\treturn err;\n\t}\n\t*pstreaming = true;\n\tvivid_grab_controls(dev, true);\n\n\tdprintk(dev, 1, \"returning from %s\\n\", __func__);\n\treturn 0;\n}\n\nvoid vivid_stop_generating_vid_out(struct vivid_dev *dev, bool *pstreaming)\n{\n\tdprintk(dev, 1, \"%s\\n\", __func__);\n\n\tif (dev->kthread_vid_out == NULL)\n\t\treturn;\n\n\t*pstreaming = false;\n\tif (pstreaming == &dev->vid_out_streaming) {\n\t\t \n\t\twhile (!list_empty(&dev->vid_out_active)) {\n\t\t\tstruct vivid_buffer *buf;\n\n\t\t\tbuf = list_entry(dev->vid_out_active.next,\n\t\t\t\t\t struct vivid_buffer, list);\n\t\t\tlist_del(&buf->list);\n\t\t\tv4l2_ctrl_request_complete(buf->vb.vb2_buf.req_obj.req,\n\t\t\t\t\t\t   &dev->ctrl_hdl_vid_out);\n\t\t\tvb2_buffer_done(&buf->vb.vb2_buf, VB2_BUF_STATE_ERROR);\n\t\t\tdprintk(dev, 2, \"vid_out buffer %d done\\n\",\n\t\t\t\tbuf->vb.vb2_buf.index);\n\t\t}\n\t}\n\n\tif (pstreaming == &dev->vbi_out_streaming) {\n\t\twhile (!list_empty(&dev->vbi_out_active)) {\n\t\t\tstruct vivid_buffer *buf;\n\n\t\t\tbuf = list_entry(dev->vbi_out_active.next,\n\t\t\t\t\t struct vivid_buffer, list);\n\t\t\tlist_del(&buf->list);\n\t\t\tv4l2_ctrl_request_complete(buf->vb.vb2_buf.req_obj.req,\n\t\t\t\t\t\t   &dev->ctrl_hdl_vbi_out);\n\t\t\tvb2_buffer_done(&buf->vb.vb2_buf, VB2_BUF_STATE_ERROR);\n\t\t\tdprintk(dev, 2, \"vbi_out buffer %d done\\n\",\n\t\t\t\tbuf->vb.vb2_buf.index);\n\t\t}\n\t}\n\n\tif (pstreaming == &dev->meta_out_streaming) {\n\t\twhile (!list_empty(&dev->meta_out_active)) {\n\t\t\tstruct vivid_buffer *buf;\n\n\t\t\tbuf = list_entry(dev->meta_out_active.next,\n\t\t\t\t\t struct vivid_buffer, list);\n\t\t\tlist_del(&buf->list);\n\t\t\tv4l2_ctrl_request_complete(buf->vb.vb2_buf.req_obj.req,\n\t\t\t\t\t\t   &dev->ctrl_hdl_meta_out);\n\t\t\tvb2_buffer_done(&buf->vb.vb2_buf, VB2_BUF_STATE_ERROR);\n\t\t\tdprintk(dev, 2, \"meta_out buffer %d done\\n\",\n\t\t\t\tbuf->vb.vb2_buf.index);\n\t\t}\n\t}\n\n\tif (dev->vid_out_streaming || dev->vbi_out_streaming ||\n\t    dev->meta_out_streaming)\n\t\treturn;\n\n\t \n\tvivid_grab_controls(dev, false);\n\tkthread_stop(dev->kthread_vid_out);\n\tdev->kthread_vid_out = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}