{
  "module_name": "vivid-radio-common.c",
  "hash_id": "42548c3f205a326993a3c08b29dbf4979c6c5fb4b3db2e91984552eb6be49580",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/test-drivers/vivid/vivid-radio-common.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/videodev2.h>\n\n#include \"vivid-core.h\"\n#include \"vivid-ctrls.h\"\n#include \"vivid-radio-common.h\"\n#include \"vivid-rds-gen.h\"\n\n \n\nconst struct v4l2_frequency_band vivid_radio_bands[TOT_BANDS] = {\n\t \n\t{\n\t\t.type = V4L2_TUNER_RADIO,\n\t\t.index = 0,\n\t\t.capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO |\n\t\t\t      V4L2_TUNER_CAP_FREQ_BANDS,\n\t\t.rangelow   = FM_FREQ_RANGE_LOW,\n\t\t.rangehigh  = FM_FREQ_RANGE_HIGH,\n\t\t.modulation = V4L2_BAND_MODULATION_FM,\n\t},\n\t \n\t{\n\t\t.type = V4L2_TUNER_RADIO,\n\t\t.index = 1,\n\t\t.capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_FREQ_BANDS,\n\t\t.rangelow   = AM_FREQ_RANGE_LOW,\n\t\t.rangehigh  = AM_FREQ_RANGE_HIGH,\n\t\t.modulation = V4L2_BAND_MODULATION_AM,\n\t},\n\t \n\t{\n\t\t.type = V4L2_TUNER_RADIO,\n\t\t.index = 2,\n\t\t.capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_FREQ_BANDS,\n\t\t.rangelow   = SW_FREQ_RANGE_LOW,\n\t\t.rangehigh  = SW_FREQ_RANGE_HIGH,\n\t\t.modulation = V4L2_BAND_MODULATION_AM,\n\t},\n};\n\n \nvoid vivid_radio_rds_init(struct vivid_dev *dev)\n{\n\tstruct vivid_rds_gen *rds = &dev->rds_gen;\n\tbool alt = dev->radio_rx_rds_use_alternates;\n\n\t \n\tif (dev->radio_rds_loop && !dev->radio_tx_rds_controls)\n\t\treturn;\n\n\tif (dev->radio_rds_loop) {\n\t\tv4l2_ctrl_lock(dev->radio_tx_rds_pi);\n\t\trds->picode = dev->radio_tx_rds_pi->cur.val;\n\t\trds->pty = dev->radio_tx_rds_pty->cur.val;\n\t\trds->mono_stereo = dev->radio_tx_rds_mono_stereo->cur.val;\n\t\trds->art_head = dev->radio_tx_rds_art_head->cur.val;\n\t\trds->compressed = dev->radio_tx_rds_compressed->cur.val;\n\t\trds->dyn_pty = dev->radio_tx_rds_dyn_pty->cur.val;\n\t\trds->ta = dev->radio_tx_rds_ta->cur.val;\n\t\trds->tp = dev->radio_tx_rds_tp->cur.val;\n\t\trds->ms = dev->radio_tx_rds_ms->cur.val;\n\t\tstrscpy(rds->psname,\n\t\t\tdev->radio_tx_rds_psname->p_cur.p_char,\n\t\t\tsizeof(rds->psname));\n\t\tstrscpy(rds->radiotext,\n\t\t\tdev->radio_tx_rds_radiotext->p_cur.p_char + alt * 64,\n\t\t\tsizeof(rds->radiotext));\n\t\tv4l2_ctrl_unlock(dev->radio_tx_rds_pi);\n\t} else {\n\t\tvivid_rds_gen_fill(rds, dev->radio_rx_freq, alt);\n\t}\n\tif (dev->radio_rx_rds_controls) {\n\t\tv4l2_ctrl_s_ctrl(dev->radio_rx_rds_pty, rds->pty);\n\t\tv4l2_ctrl_s_ctrl(dev->radio_rx_rds_ta, rds->ta);\n\t\tv4l2_ctrl_s_ctrl(dev->radio_rx_rds_tp, rds->tp);\n\t\tv4l2_ctrl_s_ctrl(dev->radio_rx_rds_ms, rds->ms);\n\t\tv4l2_ctrl_s_ctrl_string(dev->radio_rx_rds_psname, rds->psname);\n\t\tv4l2_ctrl_s_ctrl_string(dev->radio_rx_rds_radiotext, rds->radiotext);\n\t\tif (!dev->radio_rds_loop)\n\t\t\tdev->radio_rx_rds_use_alternates = !dev->radio_rx_rds_use_alternates;\n\t}\n\tvivid_rds_generate(rds);\n}\n\n \nstatic void vivid_radio_calc_sig_qual(struct vivid_dev *dev)\n{\n\tint mod = 16000;\n\tint delta = 800;\n\tint sig_qual, sig_qual_tx = mod;\n\n\t \n\tif (dev->radio_rx_freq <= AM_FREQ_RANGE_HIGH) {\n\t\tmod /= 10;\n\t\tdelta /= 10;\n\t}\n\tsig_qual = (dev->radio_rx_freq + delta) % mod - delta;\n\tif (dev->has_radio_tx)\n\t\tsig_qual_tx = dev->radio_rx_freq - dev->radio_tx_freq;\n\tif (abs(sig_qual_tx) <= abs(sig_qual)) {\n\t\tsig_qual = sig_qual_tx;\n\t\t \n\t\tif (!dev->radio_rds_loop && !dev->radio_tx_rds_controls)\n\t\t\tmemset(dev->rds_gen.data, 0,\n\t\t\t       sizeof(dev->rds_gen.data));\n\t\tdev->radio_rds_loop = dev->radio_rx_freq >= FM_FREQ_RANGE_LOW;\n\t} else {\n\t\tdev->radio_rds_loop = false;\n\t}\n\tif (dev->radio_rx_freq <= AM_FREQ_RANGE_HIGH)\n\t\tsig_qual *= 10;\n\tdev->radio_rx_sig_qual = sig_qual;\n}\n\nint vivid_radio_g_frequency(struct file *file, const unsigned *pfreq, struct v4l2_frequency *vf)\n{\n\tif (vf->tuner != 0)\n\t\treturn -EINVAL;\n\tvf->frequency = *pfreq;\n\treturn 0;\n}\n\nint vivid_radio_s_frequency(struct file *file, unsigned *pfreq, const struct v4l2_frequency *vf)\n{\n\tstruct vivid_dev *dev = video_drvdata(file);\n\tunsigned freq;\n\tunsigned band;\n\n\tif (vf->tuner != 0)\n\t\treturn -EINVAL;\n\n\tif (vf->frequency >= (FM_FREQ_RANGE_LOW + SW_FREQ_RANGE_HIGH) / 2)\n\t\tband = BAND_FM;\n\telse if (vf->frequency <= (AM_FREQ_RANGE_HIGH + SW_FREQ_RANGE_LOW) / 2)\n\t\tband = BAND_AM;\n\telse\n\t\tband = BAND_SW;\n\n\tfreq = clamp_t(u32, vf->frequency, vivid_radio_bands[band].rangelow,\n\t\t\t\t\t   vivid_radio_bands[band].rangehigh);\n\t*pfreq = freq;\n\n\t \n\tvivid_radio_calc_sig_qual(dev);\n\tvivid_radio_rds_init(dev);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}