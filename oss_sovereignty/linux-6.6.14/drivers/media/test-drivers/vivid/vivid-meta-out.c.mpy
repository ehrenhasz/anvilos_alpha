{
  "module_name": "vivid-meta-out.c",
  "hash_id": "113ea6fc92195639550e5a02b30aee015ec191d2bbe550e97a5134f857fecd83",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/test-drivers/vivid/vivid-meta-out.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/videodev2.h>\n#include <media/v4l2-common.h>\n#include <linux/usb/video.h>\n\n#include \"vivid-core.h\"\n#include \"vivid-kthread-out.h\"\n#include \"vivid-meta-out.h\"\n\nstatic int meta_out_queue_setup(struct vb2_queue *vq, unsigned int *nbuffers,\n\t\t\t\tunsigned int *nplanes, unsigned int sizes[],\n\t\t\t\tstruct device *alloc_devs[])\n{\n\tstruct vivid_dev *dev = vb2_get_drv_priv(vq);\n\tunsigned int size =  sizeof(struct vivid_meta_out_buf);\n\n\tif (!vivid_is_webcam(dev))\n\t\treturn -EINVAL;\n\n\tif (*nplanes) {\n\t\tif (sizes[0] < size)\n\t\t\treturn -EINVAL;\n\t} else {\n\t\tsizes[0] = size;\n\t}\n\n\tif (vq->num_buffers + *nbuffers < 2)\n\t\t*nbuffers = 2 - vq->num_buffers;\n\n\t*nplanes = 1;\n\treturn 0;\n}\n\nstatic int meta_out_buf_prepare(struct vb2_buffer *vb)\n{\n\tstruct vivid_dev *dev = vb2_get_drv_priv(vb->vb2_queue);\n\tunsigned int size = sizeof(struct vivid_meta_out_buf);\n\n\tdprintk(dev, 1, \"%s\\n\", __func__);\n\n\tif (dev->buf_prepare_error) {\n\t\t \n\t\tdev->buf_prepare_error = false;\n\t\treturn -EINVAL;\n\t}\n\tif (vb2_plane_size(vb, 0) < size) {\n\t\tdprintk(dev, 1, \"%s data will not fit into plane (%lu < %u)\\n\",\n\t\t\t__func__, vb2_plane_size(vb, 0), size);\n\t\treturn -EINVAL;\n\t}\n\tvb2_set_plane_payload(vb, 0, size);\n\n\treturn 0;\n}\n\nstatic void meta_out_buf_queue(struct vb2_buffer *vb)\n{\n\tstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\n\tstruct vivid_dev *dev = vb2_get_drv_priv(vb->vb2_queue);\n\tstruct vivid_buffer *buf = container_of(vbuf, struct vivid_buffer, vb);\n\n\tdprintk(dev, 1, \"%s\\n\", __func__);\n\n\tspin_lock(&dev->slock);\n\tlist_add_tail(&buf->list, &dev->meta_out_active);\n\tspin_unlock(&dev->slock);\n}\n\nstatic int meta_out_start_streaming(struct vb2_queue *vq, unsigned int count)\n{\n\tstruct vivid_dev *dev = vb2_get_drv_priv(vq);\n\tint err;\n\n\tdprintk(dev, 1, \"%s\\n\", __func__);\n\tdev->meta_out_seq_count = 0;\n\tif (dev->start_streaming_error) {\n\t\tdev->start_streaming_error = false;\n\t\terr = -EINVAL;\n\t} else {\n\t\terr = vivid_start_generating_vid_out(dev,\n\t\t\t\t\t\t     &dev->meta_out_streaming);\n\t}\n\tif (err) {\n\t\tstruct vivid_buffer *buf, *tmp;\n\n\t\tlist_for_each_entry_safe(buf, tmp,\n\t\t\t\t\t &dev->meta_out_active, list) {\n\t\t\tlist_del(&buf->list);\n\t\t\tvb2_buffer_done(&buf->vb.vb2_buf,\n\t\t\t\t\tVB2_BUF_STATE_QUEUED);\n\t\t}\n\t}\n\treturn err;\n}\n\n \nstatic void meta_out_stop_streaming(struct vb2_queue *vq)\n{\n\tstruct vivid_dev *dev = vb2_get_drv_priv(vq);\n\n\tdprintk(dev, 1, \"%s\\n\", __func__);\n\tvivid_stop_generating_vid_out(dev, &dev->meta_out_streaming);\n}\n\nstatic void meta_out_buf_request_complete(struct vb2_buffer *vb)\n{\n\tstruct vivid_dev *dev = vb2_get_drv_priv(vb->vb2_queue);\n\n\tv4l2_ctrl_request_complete(vb->req_obj.req, &dev->ctrl_hdl_meta_out);\n}\n\nconst struct vb2_ops vivid_meta_out_qops = {\n\t.queue_setup            = meta_out_queue_setup,\n\t.buf_prepare            = meta_out_buf_prepare,\n\t.buf_queue              = meta_out_buf_queue,\n\t.start_streaming        = meta_out_start_streaming,\n\t.stop_streaming         = meta_out_stop_streaming,\n\t.buf_request_complete   = meta_out_buf_request_complete,\n\t.wait_prepare           = vb2_ops_wait_prepare,\n\t.wait_finish            = vb2_ops_wait_finish,\n};\n\nint vidioc_enum_fmt_meta_out(struct file *file, void  *priv,\n\t\t\t     struct v4l2_fmtdesc *f)\n{\n\tstruct vivid_dev *dev = video_drvdata(file);\n\n\tif (!vivid_is_webcam(dev))\n\t\treturn -EINVAL;\n\n\tif (f->index > 0)\n\t\treturn -EINVAL;\n\n\tf->type = V4L2_BUF_TYPE_META_OUTPUT;\n\tf->pixelformat = V4L2_META_FMT_VIVID;\n\treturn 0;\n}\n\nint vidioc_g_fmt_meta_out(struct file *file, void *priv,\n\t\t\t  struct v4l2_format *f)\n{\n\tstruct vivid_dev *dev = video_drvdata(file);\n\tstruct v4l2_meta_format *meta = &f->fmt.meta;\n\n\tif (!vivid_is_webcam(dev) || !dev->has_meta_out)\n\t\treturn -EINVAL;\n\n\tmeta->dataformat = V4L2_META_FMT_VIVID;\n\tmeta->buffersize = sizeof(struct vivid_meta_out_buf);\n\treturn 0;\n}\n\nvoid vivid_meta_out_process(struct vivid_dev *dev,\n\t\t\t    struct vivid_buffer *buf)\n{\n\tstruct vivid_meta_out_buf *meta = vb2_plane_vaddr(&buf->vb.vb2_buf, 0);\n\n\tv4l2_ctrl_s_ctrl(dev->brightness, meta->brightness);\n\tv4l2_ctrl_s_ctrl(dev->contrast, meta->contrast);\n\tv4l2_ctrl_s_ctrl(dev->saturation, meta->saturation);\n\tv4l2_ctrl_s_ctrl(dev->hue, meta->hue);\n\n\tdprintk(dev, 2, \" %s brightness %u contrast %u saturation %u hue %d\\n\",\n\t\t__func__, meta->brightness, meta->contrast,\n\t\tmeta->saturation, meta->hue);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}