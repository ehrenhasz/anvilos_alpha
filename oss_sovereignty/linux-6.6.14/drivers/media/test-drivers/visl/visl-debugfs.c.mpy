{
  "module_name": "visl-debugfs.c",
  "hash_id": "c10dc8a541e00c3fd34367ab93f62c201d2c42b7b3d963b93fb0276a226232f2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/test-drivers/visl/visl-debugfs.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/list.h>\n#include <linux/mutex.h>\n#include <media/v4l2-mem2mem.h>\n\n#include \"visl-debugfs.h\"\n\nint visl_debugfs_init(struct visl_dev *dev)\n{\n\tdev->debugfs_root = debugfs_create_dir(\"visl\", NULL);\n\tINIT_LIST_HEAD(&dev->bitstream_blobs);\n\tmutex_init(&dev->bitstream_lock);\n\n\tif (IS_ERR(dev->debugfs_root))\n\t\treturn PTR_ERR(dev->debugfs_root);\n\n\treturn visl_debugfs_bitstream_init(dev);\n}\n\nint visl_debugfs_bitstream_init(struct visl_dev *dev)\n{\n\tdev->bitstream_debugfs = debugfs_create_dir(\"bitstream\",\n\t\t\t\t\t\t    dev->debugfs_root);\n\tif (IS_ERR(dev->bitstream_debugfs))\n\t\treturn PTR_ERR(dev->bitstream_debugfs);\n\n\treturn 0;\n}\n\nvoid visl_trace_bitstream(struct visl_ctx *ctx, struct visl_run *run)\n{\n\tu8 *vaddr = vb2_plane_vaddr(&run->src->vb2_buf, 0);\n\tstruct visl_blob *blob;\n\tsize_t data_sz = vb2_get_plane_payload(&run->src->vb2_buf, 0);\n\tstruct dentry *dentry;\n\tchar name[32];\n\n\tblob  = kzalloc(sizeof(*blob), GFP_KERNEL);\n\tif (!blob)\n\t\treturn;\n\n\tblob->blob.data = vzalloc(data_sz);\n\tif (!blob->blob.data)\n\t\tgoto err_vmalloc;\n\n\tblob->blob.size = data_sz;\n\tsnprintf(name, 32, \"bitstream%d\", run->src->sequence);\n\n\tmemcpy(blob->blob.data, vaddr, data_sz);\n\n\tdentry = debugfs_create_blob(name, 0444, ctx->dev->bitstream_debugfs,\n\t\t\t\t     &blob->blob);\n\tif (IS_ERR(dentry))\n\t\tgoto err_debugfs;\n\n\tblob->dentry = dentry;\n\n\tmutex_lock(&ctx->dev->bitstream_lock);\n\tlist_add_tail(&blob->list, &ctx->dev->bitstream_blobs);\n\tmutex_unlock(&ctx->dev->bitstream_lock);\n\n\treturn;\n\nerr_debugfs:\n\tvfree(blob->blob.data);\nerr_vmalloc:\n\tkfree(blob);\n}\n\nvoid visl_debugfs_clear_bitstream(struct visl_dev *dev)\n{\n\tstruct visl_blob *blob;\n\tstruct visl_blob *tmp;\n\n\tmutex_lock(&dev->bitstream_lock);\n\tif (list_empty(&dev->bitstream_blobs))\n\t\tgoto unlock;\n\n\tlist_for_each_entry_safe(blob, tmp, &dev->bitstream_blobs, list) {\n\t\tlist_del(&blob->list);\n\t\tdebugfs_remove(blob->dentry);\n\t\tvfree(blob->blob.data);\n\t\tkfree(blob);\n\t}\n\nunlock:\n\tmutex_unlock(&dev->bitstream_lock);\n}\n\nvoid visl_debugfs_bitstream_deinit(struct visl_dev *dev)\n{\n\tvisl_debugfs_clear_bitstream(dev);\n\tdebugfs_remove_recursive(dev->bitstream_debugfs);\n\tdev->bitstream_debugfs = NULL;\n}\n\nvoid visl_debugfs_deinit(struct visl_dev *dev)\n{\n\tvisl_debugfs_bitstream_deinit(dev);\n\tdebugfs_remove_recursive(dev->debugfs_root);\n\tdev->debugfs_root = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}