{
  "module_name": "vimc-lens.c",
  "hash_id": "90ee5e11a35c318fe63e6858aff7bd3dded3d80bd933616827a0bcd21b47f9d6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/test-drivers/vimc/vimc-lens.c",
  "human_readable_source": "\n \n\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-event.h>\n#include <media/v4l2-subdev.h>\n\n#include \"vimc-common.h\"\n\n#define VIMC_LENS_MAX_FOCUS_POS\t1023\n#define VIMC_LENS_MAX_FOCUS_STEP\t1\n\nstruct vimc_lens_device {\n\tstruct vimc_ent_device ved;\n\tstruct v4l2_subdev sd;\n\tstruct v4l2_ctrl_handler hdl;\n\tu32 focus_absolute;\n};\n\nstatic const struct v4l2_subdev_core_ops vimc_lens_core_ops = {\n\t.log_status = v4l2_ctrl_subdev_log_status,\n\t.subscribe_event = v4l2_ctrl_subdev_subscribe_event,\n\t.unsubscribe_event = v4l2_event_subdev_unsubscribe,\n};\n\nstatic const struct v4l2_subdev_ops vimc_lens_ops = {\n\t.core = &vimc_lens_core_ops\n};\n\nstatic int vimc_lens_s_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct vimc_lens_device *vlens =\n\t\tcontainer_of(ctrl->handler, struct vimc_lens_device, hdl);\n\tif (ctrl->id == V4L2_CID_FOCUS_ABSOLUTE) {\n\t\tvlens->focus_absolute = ctrl->val;\n\t\treturn 0;\n\t}\n\treturn -EINVAL;\n}\n\nstatic const struct v4l2_ctrl_ops vimc_lens_ctrl_ops = {\n\t.s_ctrl = vimc_lens_s_ctrl,\n};\n\nstatic struct vimc_ent_device *vimc_lens_add(struct vimc_device *vimc,\n\t\t\t\t\t     const char *vcfg_name)\n{\n\tstruct v4l2_device *v4l2_dev = &vimc->v4l2_dev;\n\tstruct vimc_lens_device *vlens;\n\tint ret;\n\n\t \n\tvlens = kzalloc(sizeof(*vlens), GFP_KERNEL);\n\tif (!vlens)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tv4l2_ctrl_handler_init(&vlens->hdl, 1);\n\n\tv4l2_ctrl_new_std(&vlens->hdl, &vimc_lens_ctrl_ops,\n\t\t\t  V4L2_CID_FOCUS_ABSOLUTE, 0,\n\t\t\t  VIMC_LENS_MAX_FOCUS_POS, VIMC_LENS_MAX_FOCUS_STEP, 0);\n\tvlens->sd.ctrl_handler = &vlens->hdl;\n\tif (vlens->hdl.error) {\n\t\tret = vlens->hdl.error;\n\t\tgoto err_free_vlens;\n\t}\n\tvlens->ved.dev = vimc->mdev.dev;\n\n\tret = vimc_ent_sd_register(&vlens->ved, &vlens->sd, v4l2_dev,\n\t\t\t\t   vcfg_name, MEDIA_ENT_F_LENS, 0,\n\t\t\t\t   NULL, &vimc_lens_ops);\n\tif (ret)\n\t\tgoto err_free_hdl;\n\n\treturn &vlens->ved;\n\nerr_free_hdl:\n\tv4l2_ctrl_handler_free(&vlens->hdl);\nerr_free_vlens:\n\tkfree(vlens);\n\n\treturn ERR_PTR(ret);\n}\n\nstatic void vimc_lens_release(struct vimc_ent_device *ved)\n{\n\tstruct vimc_lens_device *vlens =\n\t\tcontainer_of(ved, struct vimc_lens_device, ved);\n\n\tv4l2_ctrl_handler_free(&vlens->hdl);\n\tmedia_entity_cleanup(vlens->ved.ent);\n\tkfree(vlens);\n}\n\nstruct vimc_ent_type vimc_lens_type = {\n\t.add = vimc_lens_add,\n\t.release = vimc_lens_release\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}