{
  "module_name": "dtt200u-fe.c",
  "hash_id": "e17e33394fdf0a821b2e964cc1011e9bf11f8403b1fbe500e3a97b67336d0905",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/dvb-usb/dtt200u-fe.c",
  "human_readable_source": "\n \n#include \"dtt200u.h\"\n\nstruct dtt200u_fe_state {\n\tstruct dvb_usb_device *d;\n\n\tenum fe_status stat;\n\n\tstruct dtv_frontend_properties fep;\n\tstruct dvb_frontend frontend;\n\n\tunsigned char data[80];\n\tstruct mutex data_mutex;\n};\n\nstatic int dtt200u_fe_read_status(struct dvb_frontend *fe,\n\t\t\t\t  enum fe_status *stat)\n{\n\tstruct dtt200u_fe_state *state = fe->demodulator_priv;\n\tint ret;\n\n\tmutex_lock(&state->data_mutex);\n\tstate->data[0] = GET_TUNE_STATUS;\n\n\tret = dvb_usb_generic_rw(state->d, state->data, 1, state->data, 3, 0);\n\tif (ret < 0) {\n\t\t*stat = 0;\n\t\tmutex_unlock(&state->data_mutex);\n\t\treturn ret;\n\t}\n\n\tswitch (state->data[0]) {\n\t\tcase 0x01:\n\t\t\t*stat = FE_HAS_SIGNAL | FE_HAS_CARRIER |\n\t\t\t\tFE_HAS_VITERBI | FE_HAS_SYNC | FE_HAS_LOCK;\n\t\t\tbreak;\n\t\tcase 0x00:  \n\t\t\t*stat = FE_TIMEDOUT;  \n\t\t\tbreak;\n\t\tdefault:\n\t\tcase 0x02:  \n\t\t\t*stat = 0;\n\t\t\tbreak;\n\t}\n\tmutex_unlock(&state->data_mutex);\n\treturn 0;\n}\n\nstatic int dtt200u_fe_read_ber(struct dvb_frontend* fe, u32 *ber)\n{\n\tstruct dtt200u_fe_state *state = fe->demodulator_priv;\n\tint ret;\n\n\tmutex_lock(&state->data_mutex);\n\tstate->data[0] = GET_VIT_ERR_CNT;\n\n\tret = dvb_usb_generic_rw(state->d, state->data, 1, state->data, 3, 0);\n\tif (ret >= 0)\n\t\t*ber = (state->data[0] << 16) | (state->data[1] << 8) | state->data[2];\n\n\tmutex_unlock(&state->data_mutex);\n\treturn ret;\n}\n\nstatic int dtt200u_fe_read_unc_blocks(struct dvb_frontend* fe, u32 *unc)\n{\n\tstruct dtt200u_fe_state *state = fe->demodulator_priv;\n\tint ret;\n\n\tmutex_lock(&state->data_mutex);\n\tstate->data[0] = GET_RS_UNCOR_BLK_CNT;\n\n\tret = dvb_usb_generic_rw(state->d, state->data, 1, state->data, 2, 0);\n\tif (ret >= 0)\n\t\t*unc = (state->data[0] << 8) | state->data[1];\n\n\tmutex_unlock(&state->data_mutex);\n\treturn ret;\n}\n\nstatic int dtt200u_fe_read_signal_strength(struct dvb_frontend* fe, u16 *strength)\n{\n\tstruct dtt200u_fe_state *state = fe->demodulator_priv;\n\tint ret;\n\n\tmutex_lock(&state->data_mutex);\n\tstate->data[0] = GET_AGC;\n\n\tret = dvb_usb_generic_rw(state->d, state->data, 1, state->data, 1, 0);\n\tif (ret >= 0)\n\t\t*strength = (state->data[0] << 8) | state->data[0];\n\n\tmutex_unlock(&state->data_mutex);\n\treturn ret;\n}\n\nstatic int dtt200u_fe_read_snr(struct dvb_frontend* fe, u16 *snr)\n{\n\tstruct dtt200u_fe_state *state = fe->demodulator_priv;\n\tint ret;\n\n\tmutex_lock(&state->data_mutex);\n\tstate->data[0] = GET_SNR;\n\n\tret = dvb_usb_generic_rw(state->d, state->data, 1, state->data, 1, 0);\n\tif (ret >= 0)\n\t\t*snr = ~((state->data[0] << 8) | state->data[0]);\n\n\tmutex_unlock(&state->data_mutex);\n\treturn ret;\n}\n\nstatic int dtt200u_fe_init(struct dvb_frontend* fe)\n{\n\tstruct dtt200u_fe_state *state = fe->demodulator_priv;\n\tint ret;\n\n\tmutex_lock(&state->data_mutex);\n\tstate->data[0] = SET_INIT;\n\n\tret = dvb_usb_generic_write(state->d, state->data, 1);\n\tmutex_unlock(&state->data_mutex);\n\n\treturn ret;\n}\n\nstatic int dtt200u_fe_sleep(struct dvb_frontend* fe)\n{\n\treturn dtt200u_fe_init(fe);\n}\n\nstatic int dtt200u_fe_get_tune_settings(struct dvb_frontend* fe, struct dvb_frontend_tune_settings *tune)\n{\n\ttune->min_delay_ms = 1500;\n\ttune->step_size = 0;\n\ttune->max_drift = 0;\n\treturn 0;\n}\n\nstatic int dtt200u_fe_set_frontend(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *fep = &fe->dtv_property_cache;\n\tstruct dtt200u_fe_state *state = fe->demodulator_priv;\n\tint ret;\n\tu16 freq = fep->frequency / 250000;\n\n\tmutex_lock(&state->data_mutex);\n\tstate->data[0] = SET_BANDWIDTH;\n\tswitch (fep->bandwidth_hz) {\n\tcase 8000000:\n\t\tstate->data[1] = 8;\n\t\tbreak;\n\tcase 7000000:\n\t\tstate->data[1] = 7;\n\t\tbreak;\n\tcase 6000000:\n\t\tstate->data[1] = 6;\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tgoto ret;\n\t}\n\n\tret = dvb_usb_generic_write(state->d, state->data, 2);\n\tif (ret < 0)\n\t\tgoto ret;\n\n\tstate->data[0] = SET_RF_FREQ;\n\tstate->data[1] = freq & 0xff;\n\tstate->data[2] = (freq >> 8) & 0xff;\n\tret = dvb_usb_generic_write(state->d, state->data, 3);\n\tif (ret < 0)\n\t\tgoto ret;\n\nret:\n\tmutex_unlock(&state->data_mutex);\n\treturn ret;\n}\n\nstatic int dtt200u_fe_get_frontend(struct dvb_frontend* fe,\n\t\t\t\t   struct dtv_frontend_properties *fep)\n{\n\tstruct dtt200u_fe_state *state = fe->demodulator_priv;\n\n\tmemcpy(fep, &state->fep, sizeof(struct dtv_frontend_properties));\n\treturn 0;\n}\n\nstatic void dtt200u_fe_release(struct dvb_frontend* fe)\n{\n\tstruct dtt200u_fe_state *state = fe->demodulator_priv;\n\tkfree(state);\n}\n\nstatic const struct dvb_frontend_ops dtt200u_fe_ops;\n\nstruct dvb_frontend* dtt200u_fe_attach(struct dvb_usb_device *d)\n{\n\tstruct dtt200u_fe_state* state = NULL;\n\n\t \n\tstate = kzalloc(sizeof(struct dtt200u_fe_state), GFP_KERNEL);\n\tif (state == NULL)\n\t\tgoto error;\n\n\tdeb_info(\"attaching frontend dtt200u\\n\");\n\n\tstate->d = d;\n\tmutex_init(&state->data_mutex);\n\n\tmemcpy(&state->frontend.ops,&dtt200u_fe_ops,sizeof(struct dvb_frontend_ops));\n\tstate->frontend.demodulator_priv = state;\n\n\treturn &state->frontend;\nerror:\n\treturn NULL;\n}\n\nstatic const struct dvb_frontend_ops dtt200u_fe_ops = {\n\t.delsys = { SYS_DVBT },\n\t.info = {\n\t\t.name\t\t\t= \"WideView USB DVB-T\",\n\t\t.frequency_min_hz\t=  44250 * kHz,\n\t\t.frequency_max_hz\t= 867250 * kHz,\n\t\t.frequency_stepsize_hz\t=    250 * kHz,\n\t\t.caps = FE_CAN_INVERSION_AUTO |\n\t\t\t\tFE_CAN_FEC_1_2 | FE_CAN_FEC_2_3 | FE_CAN_FEC_3_4 |\n\t\t\t\tFE_CAN_FEC_5_6 | FE_CAN_FEC_7_8 | FE_CAN_FEC_AUTO |\n\t\t\t\tFE_CAN_QPSK | FE_CAN_QAM_16 | FE_CAN_QAM_64 | FE_CAN_QAM_AUTO |\n\t\t\t\tFE_CAN_TRANSMISSION_MODE_AUTO |\n\t\t\t\tFE_CAN_GUARD_INTERVAL_AUTO |\n\t\t\t\tFE_CAN_RECOVER |\n\t\t\t\tFE_CAN_HIERARCHY_AUTO,\n\t},\n\n\t.release = dtt200u_fe_release,\n\n\t.init = dtt200u_fe_init,\n\t.sleep = dtt200u_fe_sleep,\n\n\t.set_frontend = dtt200u_fe_set_frontend,\n\t.get_frontend = dtt200u_fe_get_frontend,\n\t.get_tune_settings = dtt200u_fe_get_tune_settings,\n\n\t.read_status = dtt200u_fe_read_status,\n\t.read_ber = dtt200u_fe_read_ber,\n\t.read_signal_strength = dtt200u_fe_read_signal_strength,\n\t.read_snr = dtt200u_fe_read_snr,\n\t.read_ucblocks = dtt200u_fe_read_unc_blocks,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}