{
  "module_name": "cinergyT2-fe.c",
  "hash_id": "cdc466a99f30bf8ae06cfeaaf0eb22fa41f1862f663f9e366a573f047b363b21",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/dvb-usb/cinergyT2-fe.c",
  "human_readable_source": "\n \n\n#include \"cinergyT2.h\"\n\n\n \n\nstatic uint16_t compute_tps(struct dtv_frontend_properties *op)\n{\n\tuint16_t tps = 0;\n\n\tswitch (op->code_rate_HP) {\n\tcase FEC_2_3:\n\t\ttps |= (1 << 7);\n\t\tbreak;\n\tcase FEC_3_4:\n\t\ttps |= (2 << 7);\n\t\tbreak;\n\tcase FEC_5_6:\n\t\ttps |= (3 << 7);\n\t\tbreak;\n\tcase FEC_7_8:\n\t\ttps |= (4 << 7);\n\t\tbreak;\n\tcase FEC_1_2:\n\tcase FEC_AUTO:\n\tdefault:\n\t\t ;\n\t}\n\n\tswitch (op->code_rate_LP) {\n\tcase FEC_2_3:\n\t\ttps |= (1 << 4);\n\t\tbreak;\n\tcase FEC_3_4:\n\t\ttps |= (2 << 4);\n\t\tbreak;\n\tcase FEC_5_6:\n\t\ttps |= (3 << 4);\n\t\tbreak;\n\tcase FEC_7_8:\n\t\ttps |= (4 << 4);\n\t\tbreak;\n\tcase FEC_1_2:\n\tcase FEC_AUTO:\n\tdefault:\n\t\t ;\n\t}\n\n\tswitch (op->modulation) {\n\tcase QAM_16:\n\t\ttps |= (1 << 13);\n\t\tbreak;\n\tcase QAM_64:\n\t\ttps |= (2 << 13);\n\t\tbreak;\n\tcase QPSK:\n\tdefault:\n\t\t ;\n\t}\n\n\tswitch (op->transmission_mode) {\n\tcase TRANSMISSION_MODE_8K:\n\t\ttps |= (1 << 0);\n\t\tbreak;\n\tcase TRANSMISSION_MODE_2K:\n\tdefault:\n\t\t ;\n\t}\n\n\tswitch (op->guard_interval) {\n\tcase GUARD_INTERVAL_1_16:\n\t\ttps |= (1 << 2);\n\t\tbreak;\n\tcase GUARD_INTERVAL_1_8:\n\t\ttps |= (2 << 2);\n\t\tbreak;\n\tcase GUARD_INTERVAL_1_4:\n\t\ttps |= (3 << 2);\n\t\tbreak;\n\tcase GUARD_INTERVAL_1_32:\n\tdefault:\n\t\t ;\n\t}\n\n\tswitch (op->hierarchy) {\n\tcase HIERARCHY_1:\n\t\ttps |= (1 << 10);\n\t\tbreak;\n\tcase HIERARCHY_2:\n\t\ttps |= (2 << 10);\n\t\tbreak;\n\tcase HIERARCHY_4:\n\t\ttps |= (3 << 10);\n\t\tbreak;\n\tcase HIERARCHY_NONE:\n\tdefault:\n\t\t ;\n\t}\n\n\treturn tps;\n}\n\nstruct cinergyt2_fe_state {\n\tstruct dvb_frontend fe;\n\tstruct dvb_usb_device *d;\n\n\tunsigned char data[64];\n\tstruct mutex data_mutex;\n\n\tstruct dvbt_get_status_msg status;\n};\n\nstatic int cinergyt2_fe_read_status(struct dvb_frontend *fe,\n\t\t\t\t    enum fe_status *status)\n{\n\tstruct cinergyt2_fe_state *state = fe->demodulator_priv;\n\tint ret;\n\n\tmutex_lock(&state->data_mutex);\n\tstate->data[0] = CINERGYT2_EP1_GET_TUNER_STATUS;\n\n\tret = dvb_usb_generic_rw(state->d, state->data, 1,\n\t\t\t\t state->data, sizeof(state->status), 0);\n\tif (!ret)\n\t\tmemcpy(&state->status, state->data, sizeof(state->status));\n\tmutex_unlock(&state->data_mutex);\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*status = 0;\n\n\tif (0xffff - le16_to_cpu(state->status.gain) > 30)\n\t\t*status |= FE_HAS_SIGNAL;\n\tif (state->status.lock_bits & (1 << 6))\n\t\t*status |= FE_HAS_LOCK;\n\tif (state->status.lock_bits & (1 << 5))\n\t\t*status |= FE_HAS_SYNC;\n\tif (state->status.lock_bits & (1 << 4))\n\t\t*status |= FE_HAS_CARRIER;\n\tif (state->status.lock_bits & (1 << 1))\n\t\t*status |= FE_HAS_VITERBI;\n\n\tif ((*status & (FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC)) !=\n\t\t\t(FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC))\n\t\t*status &= ~FE_HAS_LOCK;\n\n\treturn 0;\n}\n\nstatic int cinergyt2_fe_read_ber(struct dvb_frontend *fe, u32 *ber)\n{\n\tstruct cinergyt2_fe_state *state = fe->demodulator_priv;\n\n\t*ber = le32_to_cpu(state->status.viterbi_error_rate);\n\treturn 0;\n}\n\nstatic int cinergyt2_fe_read_unc_blocks(struct dvb_frontend *fe, u32 *unc)\n{\n\tstruct cinergyt2_fe_state *state = fe->demodulator_priv;\n\n\t*unc = le32_to_cpu(state->status.uncorrected_block_count);\n\treturn 0;\n}\n\nstatic int cinergyt2_fe_read_signal_strength(struct dvb_frontend *fe,\n\t\t\t\t\t\tu16 *strength)\n{\n\tstruct cinergyt2_fe_state *state = fe->demodulator_priv;\n\n\t*strength = (0xffff - le16_to_cpu(state->status.gain));\n\treturn 0;\n}\n\nstatic int cinergyt2_fe_read_snr(struct dvb_frontend *fe, u16 *snr)\n{\n\tstruct cinergyt2_fe_state *state = fe->demodulator_priv;\n\n\t*snr = (state->status.snr << 8) | state->status.snr;\n\treturn 0;\n}\n\nstatic int cinergyt2_fe_init(struct dvb_frontend *fe)\n{\n\treturn 0;\n}\n\nstatic int cinergyt2_fe_sleep(struct dvb_frontend *fe)\n{\n\tdeb_info(\"cinergyt2_fe_sleep() Called\\n\");\n\treturn 0;\n}\n\nstatic int cinergyt2_fe_get_tune_settings(struct dvb_frontend *fe,\n\t\t\t\tstruct dvb_frontend_tune_settings *tune)\n{\n\ttune->min_delay_ms = 800;\n\treturn 0;\n}\n\nstatic int cinergyt2_fe_set_frontend(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *fep = &fe->dtv_property_cache;\n\tstruct cinergyt2_fe_state *state = fe->demodulator_priv;\n\tstruct dvbt_set_parameters_msg *param;\n\tint err;\n\n\tmutex_lock(&state->data_mutex);\n\n\tparam = (void *)state->data;\n\tparam->cmd = CINERGYT2_EP1_SET_TUNER_PARAMETERS;\n\tparam->tps = cpu_to_le16(compute_tps(fep));\n\tparam->freq = cpu_to_le32(fep->frequency / 1000);\n\tparam->flags = 0;\n\n\tswitch (fep->bandwidth_hz) {\n\tdefault:\n\tcase 8000000:\n\t\tparam->bandwidth = 8;\n\t\tbreak;\n\tcase 7000000:\n\t\tparam->bandwidth = 7;\n\t\tbreak;\n\tcase 6000000:\n\t\tparam->bandwidth = 6;\n\t\tbreak;\n\t}\n\n\terr = dvb_usb_generic_rw(state->d, state->data, sizeof(*param),\n\t\t\t\t state->data, 2, 0);\n\tif (err < 0)\n\t\terr(\"cinergyt2_fe_set_frontend() Failed! err=%d\\n\", err);\n\n\tmutex_unlock(&state->data_mutex);\n\treturn (err < 0) ? err : 0;\n}\n\nstatic void cinergyt2_fe_release(struct dvb_frontend *fe)\n{\n\tstruct cinergyt2_fe_state *state = fe->demodulator_priv;\n\tkfree(state);\n}\n\nstatic const struct dvb_frontend_ops cinergyt2_fe_ops;\n\nstruct dvb_frontend *cinergyt2_fe_attach(struct dvb_usb_device *d)\n{\n\tstruct cinergyt2_fe_state *s = kzalloc(sizeof(\n\t\t\t\t\tstruct cinergyt2_fe_state), GFP_KERNEL);\n\tif (s == NULL)\n\t\treturn NULL;\n\n\ts->d = d;\n\tmemcpy(&s->fe.ops, &cinergyt2_fe_ops, sizeof(struct dvb_frontend_ops));\n\ts->fe.demodulator_priv = s;\n\tmutex_init(&s->data_mutex);\n\treturn &s->fe;\n}\n\n\nstatic const struct dvb_frontend_ops cinergyt2_fe_ops = {\n\t.delsys = { SYS_DVBT },\n\t.info = {\n\t\t.name\t\t\t= DRIVER_NAME,\n\t\t.frequency_min_hz\t= 174 * MHz,\n\t\t.frequency_max_hz\t= 862 * MHz,\n\t\t.frequency_stepsize_hz\t= 166667,\n\t\t.caps = FE_CAN_INVERSION_AUTO | FE_CAN_FEC_1_2\n\t\t\t| FE_CAN_FEC_2_3 | FE_CAN_FEC_3_4\n\t\t\t| FE_CAN_FEC_5_6 | FE_CAN_FEC_7_8\n\t\t\t| FE_CAN_FEC_AUTO | FE_CAN_QPSK\n\t\t\t| FE_CAN_QAM_16 | FE_CAN_QAM_64\n\t\t\t| FE_CAN_QAM_AUTO\n\t\t\t| FE_CAN_TRANSMISSION_MODE_AUTO\n\t\t\t| FE_CAN_GUARD_INTERVAL_AUTO\n\t\t\t| FE_CAN_HIERARCHY_AUTO\n\t\t\t| FE_CAN_RECOVER\n\t\t\t| FE_CAN_MUTE_TS\n\t},\n\n\t.release\t\t= cinergyt2_fe_release,\n\n\t.init\t\t\t= cinergyt2_fe_init,\n\t.sleep\t\t\t= cinergyt2_fe_sleep,\n\n\t.set_frontend\t\t= cinergyt2_fe_set_frontend,\n\t.get_tune_settings\t= cinergyt2_fe_get_tune_settings,\n\n\t.read_status\t\t= cinergyt2_fe_read_status,\n\t.read_ber\t\t= cinergyt2_fe_read_ber,\n\t.read_signal_strength\t= cinergyt2_fe_read_signal_strength,\n\t.read_snr\t\t= cinergyt2_fe_read_snr,\n\t.read_ucblocks\t\t= cinergyt2_fe_read_unc_blocks,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}