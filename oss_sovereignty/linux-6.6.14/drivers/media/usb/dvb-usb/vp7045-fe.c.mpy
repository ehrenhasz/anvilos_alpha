{
  "module_name": "vp7045-fe.c",
  "hash_id": "728be8d1122b80198a19fbb95d90bea4767a08fc80466f6fa1f51cf3c6ab0832",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/dvb-usb/vp7045-fe.c",
  "human_readable_source": "\n \n#include \"vp7045.h\"\n\n \n\nstruct vp7045_fe_state {\n\tstruct dvb_frontend fe;\n\tstruct dvb_usb_device *d;\n};\n\nstatic int vp7045_fe_read_status(struct dvb_frontend *fe,\n\t\t\t\t enum fe_status *status)\n{\n\tstruct vp7045_fe_state *state = fe->demodulator_priv;\n\tu8 s0 = vp7045_read_reg(state->d,0x00),\n\t   s1 = vp7045_read_reg(state->d,0x01),\n\t   s3 = vp7045_read_reg(state->d,0x03);\n\n\t*status = 0;\n\tif (s0 & (1 << 4))\n\t\t*status |= FE_HAS_CARRIER;\n\tif (s0 & (1 << 1))\n\t\t*status |= FE_HAS_VITERBI;\n\tif (s0 & (1 << 5))\n\t\t*status |= FE_HAS_LOCK;\n\tif (s1 & (1 << 1))\n\t\t*status |= FE_HAS_SYNC;\n\tif (s3 & (1 << 6))\n\t\t*status |= FE_HAS_SIGNAL;\n\n\tif ((*status & (FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC)) !=\n\t\t\t(FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC))\n\t\t*status &= ~FE_HAS_LOCK;\n\n\treturn 0;\n}\n\nstatic int vp7045_fe_read_ber(struct dvb_frontend* fe, u32 *ber)\n{\n\tstruct vp7045_fe_state *state = fe->demodulator_priv;\n\t*ber = (vp7045_read_reg(state->d, 0x0D) << 16) |\n\t       (vp7045_read_reg(state->d, 0x0E) << 8) |\n\t\tvp7045_read_reg(state->d, 0x0F);\n\treturn 0;\n}\n\nstatic int vp7045_fe_read_unc_blocks(struct dvb_frontend* fe, u32 *unc)\n{\n\tstruct vp7045_fe_state *state = fe->demodulator_priv;\n\t*unc = (vp7045_read_reg(state->d, 0x10) << 8) |\n\t\t    vp7045_read_reg(state->d, 0x11);\n\treturn 0;\n}\n\nstatic int vp7045_fe_read_signal_strength(struct dvb_frontend* fe, u16 *strength)\n{\n\tstruct vp7045_fe_state *state = fe->demodulator_priv;\n\tu16 signal = (vp7045_read_reg(state->d, 0x14) << 8) |\n\t\tvp7045_read_reg(state->d, 0x15);\n\n\t*strength = ~signal;\n\treturn 0;\n}\n\nstatic int vp7045_fe_read_snr(struct dvb_frontend* fe, u16 *snr)\n{\n\tstruct vp7045_fe_state *state = fe->demodulator_priv;\n\tu8 _snr = vp7045_read_reg(state->d, 0x09);\n\t*snr = (_snr << 8) | _snr;\n\treturn 0;\n}\n\nstatic int vp7045_fe_init(struct dvb_frontend* fe)\n{\n\treturn 0;\n}\n\nstatic int vp7045_fe_sleep(struct dvb_frontend* fe)\n{\n\treturn 0;\n}\n\nstatic int vp7045_fe_get_tune_settings(struct dvb_frontend* fe, struct dvb_frontend_tune_settings *tune)\n{\n\ttune->min_delay_ms = 800;\n\treturn 0;\n}\n\nstatic int vp7045_fe_set_frontend(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *fep = &fe->dtv_property_cache;\n\tstruct vp7045_fe_state *state = fe->demodulator_priv;\n\tu8 buf[5];\n\tu32 freq = fep->frequency / 1000;\n\n\tbuf[0] = (freq >> 16) & 0xff;\n\tbuf[1] = (freq >>  8) & 0xff;\n\tbuf[2] =  freq        & 0xff;\n\tbuf[3] = 0;\n\n\tswitch (fep->bandwidth_hz) {\n\tcase 8000000:\n\t\tbuf[4] = 8;\n\t\tbreak;\n\tcase 7000000:\n\t\tbuf[4] = 7;\n\t\tbreak;\n\tcase 6000000:\n\t\tbuf[4] = 6;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tvp7045_usb_op(state->d,LOCK_TUNER_COMMAND,buf,5,NULL,0,200);\n\treturn 0;\n}\n\nstatic void vp7045_fe_release(struct dvb_frontend* fe)\n{\n\tstruct vp7045_fe_state *state = fe->demodulator_priv;\n\tkfree(state);\n}\n\nstatic const struct dvb_frontend_ops vp7045_fe_ops;\n\nstruct dvb_frontend * vp7045_fe_attach(struct dvb_usb_device *d)\n{\n\tstruct vp7045_fe_state *s = kzalloc(sizeof(struct vp7045_fe_state), GFP_KERNEL);\n\tif (s == NULL)\n\t\tgoto error;\n\n\ts->d = d;\n\tmemcpy(&s->fe.ops, &vp7045_fe_ops, sizeof(struct dvb_frontend_ops));\n\ts->fe.demodulator_priv = s;\n\n\treturn &s->fe;\nerror:\n\treturn NULL;\n}\n\n\nstatic const struct dvb_frontend_ops vp7045_fe_ops = {\n\t.delsys = { SYS_DVBT },\n\t.info = {\n\t\t.name\t\t\t= \"Twinhan VP7045/46 USB DVB-T\",\n\t\t.frequency_min_hz\t=  44250 * kHz,\n\t\t.frequency_max_hz\t= 867250 * kHz,\n\t\t.frequency_stepsize_hz\t=      1 * kHz,\n\t\t.caps = FE_CAN_INVERSION_AUTO |\n\t\t\t\tFE_CAN_FEC_1_2 | FE_CAN_FEC_2_3 | FE_CAN_FEC_3_4 |\n\t\t\t\tFE_CAN_FEC_5_6 | FE_CAN_FEC_7_8 | FE_CAN_FEC_AUTO |\n\t\t\t\tFE_CAN_QPSK | FE_CAN_QAM_16 | FE_CAN_QAM_64 | FE_CAN_QAM_AUTO |\n\t\t\t\tFE_CAN_TRANSMISSION_MODE_AUTO |\n\t\t\t\tFE_CAN_GUARD_INTERVAL_AUTO |\n\t\t\t\tFE_CAN_RECOVER |\n\t\t\t\tFE_CAN_HIERARCHY_AUTO,\n\t},\n\n\t.release = vp7045_fe_release,\n\n\t.init = vp7045_fe_init,\n\t.sleep = vp7045_fe_sleep,\n\n\t.set_frontend = vp7045_fe_set_frontend,\n\t.get_tune_settings = vp7045_fe_get_tune_settings,\n\n\t.read_status = vp7045_fe_read_status,\n\t.read_ber = vp7045_fe_read_ber,\n\t.read_signal_strength = vp7045_fe_read_signal_strength,\n\t.read_snr = vp7045_fe_read_snr,\n\t.read_ucblocks = vp7045_fe_read_unc_blocks,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}