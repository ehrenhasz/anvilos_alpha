{
  "module_name": "pvrusb2-debugifc.c",
  "hash_id": "2270823f858ee5a083cde7a18fcc8228931263308f8e8c96c17fb589b4dd646b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/pvrusb2/pvrusb2-debugifc.c",
  "human_readable_source": "\n \n\n#include <linux/string.h>\n#include \"pvrusb2-debugifc.h\"\n#include \"pvrusb2-hdw.h\"\n#include \"pvrusb2-debug.h\"\n\nstruct debugifc_mask_item {\n\tconst char *name;\n\tunsigned long msk;\n};\n\n\nstatic unsigned int debugifc_count_whitespace(const char *buf,\n\t\t\t\t\t      unsigned int count)\n{\n\tunsigned int scnt;\n\tchar ch;\n\n\tfor (scnt = 0; scnt < count; scnt++) {\n\t\tch = buf[scnt];\n\t\tif (ch == ' ') continue;\n\t\tif (ch == '\\t') continue;\n\t\tif (ch == '\\n') continue;\n\t\tbreak;\n\t}\n\treturn scnt;\n}\n\n\nstatic unsigned int debugifc_count_nonwhitespace(const char *buf,\n\t\t\t\t\t\t unsigned int count)\n{\n\tunsigned int scnt;\n\tchar ch;\n\n\tfor (scnt = 0; scnt < count; scnt++) {\n\t\tch = buf[scnt];\n\t\tif (ch == ' ') break;\n\t\tif (ch == '\\t') break;\n\t\tif (ch == '\\n') break;\n\t}\n\treturn scnt;\n}\n\n\nstatic unsigned int debugifc_isolate_word(const char *buf,unsigned int count,\n\t\t\t\t\t  const char **wstrPtr,\n\t\t\t\t\t  unsigned int *wlenPtr)\n{\n\tconst char *wptr;\n\tunsigned int consume_cnt = 0;\n\tunsigned int wlen;\n\tunsigned int scnt;\n\n\twptr = NULL;\n\twlen = 0;\n\tscnt = debugifc_count_whitespace(buf,count);\n\tconsume_cnt += scnt; count -= scnt; buf += scnt;\n\tif (!count) goto done;\n\n\tscnt = debugifc_count_nonwhitespace(buf,count);\n\tif (!scnt) goto done;\n\twptr = buf;\n\twlen = scnt;\n\tconsume_cnt += scnt; count -= scnt; buf += scnt;\n\n done:\n\t*wstrPtr = wptr;\n\t*wlenPtr = wlen;\n\treturn consume_cnt;\n}\n\n\nstatic int debugifc_parse_unsigned_number(const char *buf,unsigned int count,\n\t\t\t\t\t  u32 *num_ptr)\n{\n\tu32 result = 0;\n\tint radix = 10;\n\tif ((count >= 2) && (buf[0] == '0') &&\n\t    ((buf[1] == 'x') || (buf[1] == 'X'))) {\n\t\tradix = 16;\n\t\tcount -= 2;\n\t\tbuf += 2;\n\t} else if ((count >= 1) && (buf[0] == '0')) {\n\t\tradix = 8;\n\t}\n\n\twhile (count--) {\n\t\tint val = hex_to_bin(*buf++);\n\t\tif (val < 0 || val >= radix)\n\t\t\treturn -EINVAL;\n\t\tresult *= radix;\n\t\tresult += val;\n\t}\n\t*num_ptr = result;\n\treturn 0;\n}\n\n\nstatic int debugifc_match_keyword(const char *buf,unsigned int count,\n\t\t\t\t  const char *keyword)\n{\n\tunsigned int kl;\n\tif (!keyword) return 0;\n\tkl = strlen(keyword);\n\tif (kl != count) return 0;\n\treturn !memcmp(buf,keyword,kl);\n}\n\n\nint pvr2_debugifc_print_info(struct pvr2_hdw *hdw,char *buf,unsigned int acnt)\n{\n\tint bcnt = 0;\n\tint ccnt;\n\tccnt = scnprintf(buf, acnt, \"Driver hardware description: %s\\n\",\n\t\t\t pvr2_hdw_get_desc(hdw));\n\tbcnt += ccnt; acnt -= ccnt; buf += ccnt;\n\tccnt = scnprintf(buf,acnt,\"Driver state info:\\n\");\n\tbcnt += ccnt; acnt -= ccnt; buf += ccnt;\n\tccnt = pvr2_hdw_state_report(hdw,buf,acnt);\n\tbcnt += ccnt; acnt -= ccnt; buf += ccnt;\n\n\treturn bcnt;\n}\n\n\nint pvr2_debugifc_print_status(struct pvr2_hdw *hdw,\n\t\t\t       char *buf,unsigned int acnt)\n{\n\tint bcnt = 0;\n\tint ccnt;\n\tint ret;\n\tu32 gpio_dir,gpio_in,gpio_out;\n\tstruct pvr2_stream_stats stats;\n\tstruct pvr2_stream *sp;\n\n\tret = pvr2_hdw_is_hsm(hdw);\n\tccnt = scnprintf(buf,acnt,\"USB link speed: %s\\n\",\n\t\t\t (ret < 0 ? \"FAIL\" : (ret ? \"high\" : \"full\")));\n\tbcnt += ccnt; acnt -= ccnt; buf += ccnt;\n\n\tgpio_dir = 0; gpio_in = 0; gpio_out = 0;\n\tpvr2_hdw_gpio_get_dir(hdw,&gpio_dir);\n\tpvr2_hdw_gpio_get_out(hdw,&gpio_out);\n\tpvr2_hdw_gpio_get_in(hdw,&gpio_in);\n\tccnt = scnprintf(buf,acnt,\"GPIO state: dir=0x%x in=0x%x out=0x%x\\n\",\n\t\t\t gpio_dir,gpio_in,gpio_out);\n\tbcnt += ccnt; acnt -= ccnt; buf += ccnt;\n\n\tccnt = scnprintf(buf,acnt,\"Streaming is %s\\n\",\n\t\t\t pvr2_hdw_get_streaming(hdw) ? \"on\" : \"off\");\n\tbcnt += ccnt; acnt -= ccnt; buf += ccnt;\n\n\n\tsp = pvr2_hdw_get_video_stream(hdw);\n\tif (sp) {\n\t\tpvr2_stream_get_stats(sp, &stats, 0);\n\t\tccnt = scnprintf(\n\t\t\tbuf,acnt,\n\t\t\t\"Bytes streamed=%u URBs: queued=%u idle=%u ready=%u processed=%u failed=%u\\n\",\n\t\t\tstats.bytes_processed,\n\t\t\tstats.buffers_in_queue,\n\t\t\tstats.buffers_in_idle,\n\t\t\tstats.buffers_in_ready,\n\t\t\tstats.buffers_processed,\n\t\t\tstats.buffers_failed);\n\t\tbcnt += ccnt; acnt -= ccnt; buf += ccnt;\n\t}\n\n\treturn bcnt;\n}\n\n\nstatic int pvr2_debugifc_do1cmd(struct pvr2_hdw *hdw,const char *buf,\n\t\t\t\tunsigned int count)\n{\n\tconst char *wptr;\n\tunsigned int wlen;\n\tunsigned int scnt;\n\n\tscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\n\tif (!scnt) return 0;\n\tcount -= scnt; buf += scnt;\n\tif (!wptr) return 0;\n\n\tpvr2_trace(PVR2_TRACE_DEBUGIFC,\"debugifc cmd: \\\"%.*s\\\"\",wlen,wptr);\n\tif (debugifc_match_keyword(wptr,wlen,\"reset\")) {\n\t\tscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\n\t\tif (!scnt) return -EINVAL;\n\t\tcount -= scnt; buf += scnt;\n\t\tif (!wptr) return -EINVAL;\n\t\tif (debugifc_match_keyword(wptr,wlen,\"cpu\")) {\n\t\t\tpvr2_hdw_cpureset_assert(hdw,!0);\n\t\t\tpvr2_hdw_cpureset_assert(hdw,0);\n\t\t\treturn 0;\n\t\t} else if (debugifc_match_keyword(wptr,wlen,\"bus\")) {\n\t\t\tpvr2_hdw_device_reset(hdw);\n\t\t} else if (debugifc_match_keyword(wptr,wlen,\"soft\")) {\n\t\t\treturn pvr2_hdw_cmd_powerup(hdw);\n\t\t} else if (debugifc_match_keyword(wptr,wlen,\"deep\")) {\n\t\t\treturn pvr2_hdw_cmd_deep_reset(hdw);\n\t\t} else if (debugifc_match_keyword(wptr,wlen,\"firmware\")) {\n\t\t\treturn pvr2_upload_firmware2(hdw);\n\t\t} else if (debugifc_match_keyword(wptr,wlen,\"decoder\")) {\n\t\t\treturn pvr2_hdw_cmd_decoder_reset(hdw);\n\t\t} else if (debugifc_match_keyword(wptr,wlen,\"worker\")) {\n\t\t\treturn pvr2_hdw_untrip(hdw);\n\t\t} else if (debugifc_match_keyword(wptr,wlen,\"usbstats\")) {\n\t\t\tpvr2_stream_get_stats(pvr2_hdw_get_video_stream(hdw),\n\t\t\t\t\t      NULL, !0);\n\t\t\treturn 0;\n\t\t}\n\t\treturn -EINVAL;\n\t} else if (debugifc_match_keyword(wptr,wlen,\"cpufw\")) {\n\t\tscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\n\t\tif (!scnt) return -EINVAL;\n\t\tcount -= scnt; buf += scnt;\n\t\tif (!wptr) return -EINVAL;\n\t\tif (debugifc_match_keyword(wptr,wlen,\"fetch\")) {\n\t\t\tscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\n\t\t\tif (scnt && wptr) {\n\t\t\t\tcount -= scnt; buf += scnt;\n\t\t\t\tif (debugifc_match_keyword(wptr, wlen,\n\t\t\t\t\t\t\t   \"prom\")) {\n\t\t\t\t\tpvr2_hdw_cpufw_set_enabled(hdw, 2, !0);\n\t\t\t\t} else if (debugifc_match_keyword(wptr, wlen,\n\t\t\t\t\t\t\t\t  \"ram8k\")) {\n\t\t\t\t\tpvr2_hdw_cpufw_set_enabled(hdw, 0, !0);\n\t\t\t\t} else if (debugifc_match_keyword(wptr, wlen,\n\t\t\t\t\t\t\t\t  \"ram16k\")) {\n\t\t\t\t\tpvr2_hdw_cpufw_set_enabled(hdw, 1, !0);\n\t\t\t\t} else {\n\t\t\t\t\treturn -EINVAL;\n\t\t\t\t}\n\t\t\t}\n\t\t\tpvr2_hdw_cpufw_set_enabled(hdw,0,!0);\n\t\t\treturn 0;\n\t\t} else if (debugifc_match_keyword(wptr,wlen,\"done\")) {\n\t\t\tpvr2_hdw_cpufw_set_enabled(hdw,0,0);\n\t\t\treturn 0;\n\t\t} else {\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else if (debugifc_match_keyword(wptr,wlen,\"gpio\")) {\n\t\tint dir_fl = 0;\n\t\tint ret;\n\t\tu32 msk,val;\n\t\tscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\n\t\tif (!scnt) return -EINVAL;\n\t\tcount -= scnt; buf += scnt;\n\t\tif (!wptr) return -EINVAL;\n\t\tif (debugifc_match_keyword(wptr,wlen,\"dir\")) {\n\t\t\tdir_fl = !0;\n\t\t} else if (!debugifc_match_keyword(wptr,wlen,\"out\")) {\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\n\t\tif (!scnt) return -EINVAL;\n\t\tcount -= scnt; buf += scnt;\n\t\tif (!wptr) return -EINVAL;\n\t\tret = debugifc_parse_unsigned_number(wptr,wlen,&msk);\n\t\tif (ret) return ret;\n\t\tscnt = debugifc_isolate_word(buf,count,&wptr,&wlen);\n\t\tif (wptr) {\n\t\t\tret = debugifc_parse_unsigned_number(wptr,wlen,&val);\n\t\t\tif (ret) return ret;\n\t\t} else {\n\t\t\tval = msk;\n\t\t\tmsk = 0xffffffff;\n\t\t}\n\t\tif (dir_fl) {\n\t\t\tret = pvr2_hdw_gpio_chg_dir(hdw,msk,val);\n\t\t} else {\n\t\t\tret = pvr2_hdw_gpio_chg_out(hdw,msk,val);\n\t\t}\n\t\treturn ret;\n\t}\n\tpvr2_trace(PVR2_TRACE_DEBUGIFC,\n\t\t   \"debugifc failed to recognize cmd: \\\"%.*s\\\"\",wlen,wptr);\n\treturn -EINVAL;\n}\n\n\nint pvr2_debugifc_docmd(struct pvr2_hdw *hdw,const char *buf,\n\t\t\tunsigned int count)\n{\n\tunsigned int bcnt = 0;\n\tint ret;\n\n\twhile (count) {\n\t\tfor (bcnt = 0; bcnt < count; bcnt++) {\n\t\t\tif (buf[bcnt] == '\\n') break;\n\t\t}\n\n\t\tret = pvr2_debugifc_do1cmd(hdw,buf,bcnt);\n\t\tif (ret < 0) return ret;\n\t\tif (bcnt < count) bcnt++;\n\t\tbuf += bcnt;\n\t\tcount -= bcnt;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}