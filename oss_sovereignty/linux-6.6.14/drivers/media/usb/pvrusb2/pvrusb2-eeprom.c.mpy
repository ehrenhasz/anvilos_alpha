{
  "module_name": "pvrusb2-eeprom.c",
  "hash_id": "181d21bed6ed530fc7f52692140be2edc1e35fa6d7638026cc356efeeaa1b6e1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/pvrusb2/pvrusb2-eeprom.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n#include \"pvrusb2-eeprom.h\"\n#include \"pvrusb2-hdw-internal.h\"\n#include \"pvrusb2-debug.h\"\n\n#define trace_eeprom(...) pvr2_trace(PVR2_TRACE_EEPROM,__VA_ARGS__)\n\n\n\n \n\n#include <media/tveeprom.h>\n\n \n#define EEPROM_SIZE 128\n\n \nstatic u8 *pvr2_eeprom_fetch(struct pvr2_hdw *hdw)\n{\n\tstruct i2c_msg msg[2];\n\tu8 *eeprom;\n\tu8 iadd[2];\n\tu8 addr;\n\tu16 eepromSize;\n\tunsigned int offs;\n\tint ret;\n\tint mode16 = 0;\n\tunsigned pcnt,tcnt;\n\teeprom = kzalloc(EEPROM_SIZE, GFP_KERNEL);\n\tif (!eeprom) {\n\t\tpvr2_trace(PVR2_TRACE_ERROR_LEGS,\n\t\t\t   \"Failed to allocate memory required to read eeprom\");\n\t\treturn NULL;\n\t}\n\n\ttrace_eeprom(\"Value for eeprom addr from controller was 0x%x\",\n\t\t     hdw->eeprom_addr);\n\taddr = hdw->eeprom_addr;\n\t \n\tif (addr & 0x80) addr >>= 1;\n\n\t \n\tmode16 = (addr & 1);\n\teepromSize = (mode16 ? 4096 : 256);\n\ttrace_eeprom(\"Examining %d byte eeprom at location 0x%x using %d bit addressing\",\n\t\t     eepromSize, addr,\n\t\t     mode16 ? 16 : 8);\n\n\tmsg[0].addr = addr;\n\tmsg[0].flags = 0;\n\tmsg[0].len = mode16 ? 2 : 1;\n\tmsg[0].buf = iadd;\n\tmsg[1].addr = addr;\n\tmsg[1].flags = I2C_M_RD;\n\n\t \n\tfor (tcnt = 0; tcnt < EEPROM_SIZE; tcnt += pcnt) {\n\t\tpcnt = 16;\n\t\tif (pcnt + tcnt > EEPROM_SIZE) pcnt = EEPROM_SIZE-tcnt;\n\t\toffs = tcnt + (eepromSize - EEPROM_SIZE);\n\t\tif (mode16) {\n\t\t\tiadd[0] = offs >> 8;\n\t\t\tiadd[1] = offs;\n\t\t} else {\n\t\t\tiadd[0] = offs;\n\t\t}\n\t\tmsg[1].len = pcnt;\n\t\tmsg[1].buf = eeprom+tcnt;\n\t\tif ((ret = i2c_transfer(&hdw->i2c_adap,\n\t\t\t\t\tmsg,ARRAY_SIZE(msg))) != 2) {\n\t\t\tpvr2_trace(PVR2_TRACE_ERROR_LEGS,\n\t\t\t\t   \"eeprom fetch set offs err=%d\",ret);\n\t\t\tkfree(eeprom);\n\t\t\treturn NULL;\n\t\t}\n\t}\n\treturn eeprom;\n}\n\n\n \nint pvr2_eeprom_analyze(struct pvr2_hdw *hdw)\n{\n\tu8 *eeprom;\n\tstruct tveeprom tvdata;\n\n\tmemset(&tvdata,0,sizeof(tvdata));\n\n\teeprom = pvr2_eeprom_fetch(hdw);\n\tif (!eeprom)\n\t\treturn -EINVAL;\n\n\ttveeprom_hauppauge_analog(&tvdata, eeprom);\n\n\ttrace_eeprom(\"eeprom assumed v4l tveeprom module\");\n\ttrace_eeprom(\"eeprom direct call results:\");\n\ttrace_eeprom(\"has_radio=%d\",tvdata.has_radio);\n\ttrace_eeprom(\"tuner_type=%d\",tvdata.tuner_type);\n\ttrace_eeprom(\"tuner_formats=0x%x\",tvdata.tuner_formats);\n\ttrace_eeprom(\"audio_processor=%d\",tvdata.audio_processor);\n\ttrace_eeprom(\"model=%d\",tvdata.model);\n\ttrace_eeprom(\"revision=%d\",tvdata.revision);\n\ttrace_eeprom(\"serial_number=%d\",tvdata.serial_number);\n\ttrace_eeprom(\"rev_str=%s\",tvdata.rev_str);\n\thdw->tuner_type = tvdata.tuner_type;\n\thdw->tuner_updated = !0;\n\thdw->serial_number = tvdata.serial_number;\n\thdw->std_mask_eeprom = tvdata.tuner_formats;\n\n\tkfree(eeprom);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}