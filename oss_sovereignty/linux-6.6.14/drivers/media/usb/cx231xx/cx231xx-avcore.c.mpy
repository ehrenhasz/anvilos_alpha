{
  "module_name": "cx231xx-avcore.c",
  "hash_id": "1dfa5095d567caa1b1196545970d37e883a3391062cffc452137832250f6afce",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/cx231xx/cx231xx-avcore.c",
  "human_readable_source": "\n \n\n#include \"cx231xx.h\"\n#include <linux/init.h>\n#include <linux/list.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/bitmap.h>\n#include <linux/i2c.h>\n#include <linux/mm.h>\n#include <linux/mutex.h>\n#include <media/tuner.h>\n\n#include <media/v4l2-common.h>\n#include <media/v4l2-ioctl.h>\n\n#include \"cx231xx-dif.h\"\n\n#define TUNER_MODE_FM_RADIO 0\n \n \nstatic int verve_write_byte(struct cx231xx *dev, u8 saddr, u8 data)\n{\n\treturn cx231xx_write_i2c_data(dev, VERVE_I2C_ADDRESS,\n\t\t\t\t\tsaddr, 1, data, 1);\n}\n\nstatic int verve_read_byte(struct cx231xx *dev, u8 saddr, u8 *data)\n{\n\tint status;\n\tu32 temp = 0;\n\n\tstatus = cx231xx_read_i2c_data(dev, VERVE_I2C_ADDRESS,\n\t\t\t\t\tsaddr, 1, &temp, 1);\n\t*data = (u8) temp;\n\treturn status;\n}\nvoid initGPIO(struct cx231xx *dev)\n{\n\tu32 _gpio_direction = 0;\n\tu32 value = 0;\n\tu8 val = 0;\n\n\t_gpio_direction = _gpio_direction & 0xFC0003FF;\n\t_gpio_direction = _gpio_direction | 0x03FDFC00;\n\tcx231xx_send_gpio_cmd(dev, _gpio_direction, (u8 *)&value, 4, 0, 0);\n\n\tverve_read_byte(dev, 0x07, &val);\n\tdev_dbg(dev->dev, \"verve_read_byte address0x07=0x%x\\n\", val);\n\tverve_write_byte(dev, 0x07, 0xF4);\n\tverve_read_byte(dev, 0x07, &val);\n\tdev_dbg(dev->dev, \"verve_read_byte address0x07=0x%x\\n\", val);\n\n\tcx231xx_capture_start(dev, 1, Vbi);\n\n\tcx231xx_mode_register(dev, EP_MODE_SET, 0x0500FE00);\n\tcx231xx_mode_register(dev, GBULK_BIT_EN, 0xFFFDFFFF);\n\n}\nvoid uninitGPIO(struct cx231xx *dev)\n{\n\tu8 value[4] = { 0, 0, 0, 0 };\n\n\tcx231xx_capture_start(dev, 0, Vbi);\n\tverve_write_byte(dev, 0x07, 0x14);\n\tcx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t0x68, value, 4);\n}\n\n \nstatic int afe_write_byte(struct cx231xx *dev, u16 saddr, u8 data)\n{\n\treturn cx231xx_write_i2c_data(dev, AFE_DEVICE_ADDRESS,\n\t\t\t\t\tsaddr, 2, data, 1);\n}\n\nstatic int afe_read_byte(struct cx231xx *dev, u16 saddr, u8 *data)\n{\n\tint status;\n\tu32 temp = 0;\n\n\tstatus = cx231xx_read_i2c_data(dev, AFE_DEVICE_ADDRESS,\n\t\t\t\t\tsaddr, 2, &temp, 1);\n\t*data = (u8) temp;\n\treturn status;\n}\n\nint cx231xx_afe_init_super_block(struct cx231xx *dev, u32 ref_count)\n{\n\tint status = 0;\n\tu8 temp = 0;\n\tu8 afe_power_status = 0;\n\tint i = 0;\n\n\t \n\ttemp = (u8) (ref_count & 0xff);\n\tstatus = afe_write_byte(dev, SUP_BLK_TUNE2, temp);\n\tif (status < 0)\n\t\treturn status;\n\n\tstatus = afe_read_byte(dev, SUP_BLK_TUNE2, &afe_power_status);\n\tif (status < 0)\n\t\treturn status;\n\n\ttemp = (u8) ((ref_count & 0x300) >> 8);\n\ttemp |= 0x40;\n\tstatus = afe_write_byte(dev, SUP_BLK_TUNE1, temp);\n\tif (status < 0)\n\t\treturn status;\n\n\tstatus = afe_write_byte(dev, SUP_BLK_PLL2, 0x0f);\n\tif (status < 0)\n\t\treturn status;\n\n\t \n\twhile (afe_power_status != 0x18) {\n\t\tstatus = afe_write_byte(dev, SUP_BLK_PWRDN, 0x18);\n\t\tif (status < 0) {\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"%s: Init Super Block failed in send cmd\\n\",\n\t\t\t\t__func__);\n\t\t\tbreak;\n\t\t}\n\n\t\tstatus = afe_read_byte(dev, SUP_BLK_PWRDN, &afe_power_status);\n\t\tafe_power_status &= 0xff;\n\t\tif (status < 0) {\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"%s: Init Super Block failed in receive cmd\\n\",\n\t\t\t\t__func__);\n\t\t\tbreak;\n\t\t}\n\t\ti++;\n\t\tif (i == 10) {\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"%s: Init Super Block force break in loop !!!!\\n\",\n\t\t\t\t__func__);\n\t\t\tstatus = -1;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (status < 0)\n\t\treturn status;\n\n\t \n\tstatus = afe_write_byte(dev, SUP_BLK_TUNE3, 0x40);\n\tif (status < 0)\n\t\treturn status;\n\n\tmsleep(5);\n\n\t \n\tstatus = afe_write_byte(dev, SUP_BLK_TUNE3, 0x00);\n\n\treturn status;\n}\n\nint cx231xx_afe_init_channels(struct cx231xx *dev)\n{\n\tint status = 0;\n\n\t \n\tstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1, 0x00);\n\tstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2, 0x00);\n\tstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3, 0x00);\n\n\t \n\tstatus = afe_write_byte(dev, ADC_COM_QUANT, 0x02);\n\n\t \n\tstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH1, 0x17);\n\tstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH2, 0x17);\n\tstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH3, 0x17);\n\n\t \n\tstatus = afe_write_byte(dev, ADC_CAL_ATEST_CH1, 0x10);\n\tstatus = afe_write_byte(dev, ADC_CAL_ATEST_CH2, 0x10);\n\tstatus = afe_write_byte(dev, ADC_CAL_ATEST_CH3, 0x10);\n\tmsleep(5);\n\n\t \n\tstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH1, 0x07);\n\tstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH2, 0x07);\n\tstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH3, 0x07);\n\n\t \n\tstatus = afe_write_byte(dev, ADC_NTF_PRECLMP_EN_CH1, 0xf0);\n\tstatus = afe_write_byte(dev, ADC_NTF_PRECLMP_EN_CH2, 0xf0);\n\tstatus = afe_write_byte(dev, ADC_NTF_PRECLMP_EN_CH3, 0xf0);\n\n\t \n\tstatus = cx231xx_reg_mask_write(dev, AFE_DEVICE_ADDRESS, 8,\n\t\t\t\t   ADC_QGAIN_RES_TRM_CH1, 3, 7, 0x00);\n\tstatus = cx231xx_reg_mask_write(dev, AFE_DEVICE_ADDRESS, 8,\n\t\t\t\t   ADC_QGAIN_RES_TRM_CH2, 3, 7, 0x00);\n\tstatus = cx231xx_reg_mask_write(dev, AFE_DEVICE_ADDRESS, 8,\n\t\t\t\t   ADC_QGAIN_RES_TRM_CH3, 3, 7, 0x00);\n\n\t \n\tstatus = afe_write_byte(dev, ADC_DCSERVO_DEM_CH1, 0x03);\n\tstatus = afe_write_byte(dev, ADC_DCSERVO_DEM_CH2, 0x03);\n\tstatus = afe_write_byte(dev, ADC_DCSERVO_DEM_CH3, 0x03);\n\n\treturn status;\n}\n\nint cx231xx_afe_setup_AFE_for_baseband(struct cx231xx *dev)\n{\n\tu8 c_value = 0;\n\tint status = 0;\n\n\tstatus = afe_read_byte(dev, ADC_PWRDN_CLAMP_CH2, &c_value);\n\tc_value &= (~(0x50));\n\tstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2, c_value);\n\n\treturn status;\n}\n\n \nint cx231xx_afe_set_input_mux(struct cx231xx *dev, u32 input_mux)\n{\n\tu8 ch1_setting = (u8) input_mux;\n\tu8 ch2_setting = (u8) (input_mux >> 8);\n\tu8 ch3_setting = (u8) (input_mux >> 16);\n\tint status = 0;\n\tu8 value = 0;\n\n\tif (ch1_setting != 0) {\n\t\tstatus = afe_read_byte(dev, ADC_INPUT_CH1, &value);\n\t\tvalue &= ~INPUT_SEL_MASK;\n\t\tvalue |= (ch1_setting - 1) << 4;\n\t\tvalue &= 0xff;\n\t\tstatus = afe_write_byte(dev, ADC_INPUT_CH1, value);\n\t}\n\n\tif (ch2_setting != 0) {\n\t\tstatus = afe_read_byte(dev, ADC_INPUT_CH2, &value);\n\t\tvalue &= ~INPUT_SEL_MASK;\n\t\tvalue |= (ch2_setting - 1) << 4;\n\t\tvalue &= 0xff;\n\t\tstatus = afe_write_byte(dev, ADC_INPUT_CH2, value);\n\t}\n\n\t \n\tif (ch3_setting != 0) {\n\t\tstatus = afe_read_byte(dev, ADC_INPUT_CH3, &value);\n\t\tvalue &= ~INPUT_SEL_MASK;\n\t\tvalue |= (ch3_setting - 1) << 4;\n\t\tvalue &= 0xff;\n\t\tstatus = afe_write_byte(dev, ADC_INPUT_CH3, value);\n\t}\n\n\treturn status;\n}\n\nint cx231xx_afe_set_mode(struct cx231xx *dev, enum AFE_MODE mode)\n{\n\tint status = 0;\n\n\t \n\n\tswitch (mode) {\n\tcase AFE_MODE_LOW_IF:\n\t\tcx231xx_Setup_AFE_for_LowIF(dev);\n\t\tbreak;\n\tcase AFE_MODE_BASEBAND:\n\t\tstatus = cx231xx_afe_setup_AFE_for_baseband(dev);\n\t\tbreak;\n\tcase AFE_MODE_EU_HI_IF:\n\t\t \n\t\tbreak;\n\tcase AFE_MODE_US_HI_IF:\n\t\t \n\t\tbreak;\n\tcase AFE_MODE_JAPAN_HI_IF:\n\t\t \n\t\tbreak;\n\t}\n\n\tif ((mode != dev->afe_mode) &&\n\t\t(dev->video_input == CX231XX_VMUX_TELEVISION))\n\t\tstatus = cx231xx_afe_adjust_ref_count(dev,\n\t\t\t\t\t\t     CX231XX_VMUX_TELEVISION);\n\n\tdev->afe_mode = mode;\n\n\treturn status;\n}\n\nint cx231xx_afe_update_power_control(struct cx231xx *dev,\n\t\t\t\t\tenum AV_MODE avmode)\n{\n\tu8 afe_power_status = 0;\n\tint status = 0;\n\n\tswitch (dev->model) {\n\tcase CX231XX_BOARD_CNXT_CARRAERA:\n\tcase CX231XX_BOARD_CNXT_RDE_250:\n\tcase CX231XX_BOARD_CNXT_SHELBY:\n\tcase CX231XX_BOARD_CNXT_RDU_250:\n\tcase CX231XX_BOARD_CNXT_RDE_253S:\n\tcase CX231XX_BOARD_CNXT_RDU_253S:\n\tcase CX231XX_BOARD_CNXT_VIDEO_GRABBER:\n\tcase CX231XX_BOARD_HAUPPAUGE_EXETER:\n\tcase CX231XX_BOARD_HAUPPAUGE_930C_HD_1113xx:\n\tcase CX231XX_BOARD_HAUPPAUGE_USBLIVE2:\n\tcase CX231XX_BOARD_PV_PLAYTV_USB_HYBRID:\n\tcase CX231XX_BOARD_HAUPPAUGE_USB2_FM_PAL:\n\tcase CX231XX_BOARD_HAUPPAUGE_USB2_FM_NTSC:\n\tcase CX231XX_BOARD_OTG102:\n\t\tif (avmode == POLARIS_AVMODE_ANALOGT_TV) {\n\t\t\twhile (afe_power_status != (FLD_PWRDN_TUNING_BIAS |\n\t\t\t\t\t\tFLD_PWRDN_ENABLE_PLL)) {\n\t\t\t\tstatus = afe_write_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t\tFLD_PWRDN_TUNING_BIAS |\n\t\t\t\t\t\t\tFLD_PWRDN_ENABLE_PLL);\n\t\t\t\tstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t\t&afe_power_status);\n\t\t\t\tif (status < 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\n\t\t\t\t\t\t\t0x00);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\n\t\t\t\t\t\t\t0x00);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\n\t\t\t\t\t\t\t0x00);\n\t\t} else if (avmode == POLARIS_AVMODE_DIGITAL) {\n\t\t\tstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\n\t\t\t\t\t\t\t0x70);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\n\t\t\t\t\t\t\t0x70);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\n\t\t\t\t\t\t\t0x70);\n\n\t\t\tstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t  &afe_power_status);\n\t\t\tafe_power_status |= FLD_PWRDN_PD_BANDGAP |\n\t\t\t\t\t\tFLD_PWRDN_PD_BIAS |\n\t\t\t\t\t\tFLD_PWRDN_PD_TUNECK;\n\t\t\tstatus |= afe_write_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t   afe_power_status);\n\t\t} else if (avmode == POLARIS_AVMODE_ENXTERNAL_AV) {\n\t\t\twhile (afe_power_status != (FLD_PWRDN_TUNING_BIAS |\n\t\t\t\t\t\tFLD_PWRDN_ENABLE_PLL)) {\n\t\t\t\tstatus = afe_write_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t\tFLD_PWRDN_TUNING_BIAS |\n\t\t\t\t\t\t\tFLD_PWRDN_ENABLE_PLL);\n\t\t\t\tstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t\t&afe_power_status);\n\t\t\t\tif (status < 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\n\t\t\t\t\t\t0x00);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\n\t\t\t\t\t\t0x00);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\n\t\t\t\t\t\t0x00);\n\t\t} else {\n\t\t\tdev_dbg(dev->dev, \"Invalid AV mode input\\n\");\n\t\t\tstatus = -1;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tif (avmode == POLARIS_AVMODE_ANALOGT_TV) {\n\t\t\twhile (afe_power_status != (FLD_PWRDN_TUNING_BIAS |\n\t\t\t\t\t\tFLD_PWRDN_ENABLE_PLL)) {\n\t\t\t\tstatus = afe_write_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t\tFLD_PWRDN_TUNING_BIAS |\n\t\t\t\t\t\t\tFLD_PWRDN_ENABLE_PLL);\n\t\t\t\tstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t\t&afe_power_status);\n\t\t\t\tif (status < 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\n\t\t\t\t\t\t\t0x40);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\n\t\t\t\t\t\t\t0x40);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\n\t\t\t\t\t\t\t0x00);\n\t\t} else if (avmode == POLARIS_AVMODE_DIGITAL) {\n\t\t\tstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\n\t\t\t\t\t\t\t0x70);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\n\t\t\t\t\t\t\t0x70);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\n\t\t\t\t\t\t\t0x70);\n\n\t\t\tstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t       &afe_power_status);\n\t\t\tafe_power_status |= FLD_PWRDN_PD_BANDGAP |\n\t\t\t\t\t\tFLD_PWRDN_PD_BIAS |\n\t\t\t\t\t\tFLD_PWRDN_PD_TUNECK;\n\t\t\tstatus |= afe_write_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t\tafe_power_status);\n\t\t} else if (avmode == POLARIS_AVMODE_ENXTERNAL_AV) {\n\t\t\twhile (afe_power_status != (FLD_PWRDN_TUNING_BIAS |\n\t\t\t\t\t\tFLD_PWRDN_ENABLE_PLL)) {\n\t\t\t\tstatus = afe_write_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t\tFLD_PWRDN_TUNING_BIAS |\n\t\t\t\t\t\t\tFLD_PWRDN_ENABLE_PLL);\n\t\t\t\tstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\n\t\t\t\t\t\t\t&afe_power_status);\n\t\t\t\tif (status < 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\n\t\t\t\t\t\t\t0x00);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\n\t\t\t\t\t\t\t0x00);\n\t\t\tstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\n\t\t\t\t\t\t\t0x40);\n\t\t} else {\n\t\t\tdev_dbg(dev->dev, \"Invalid AV mode input\\n\");\n\t\t\tstatus = -1;\n\t\t}\n\t}\t\t\t \n\n\treturn status;\n}\n\nint cx231xx_afe_adjust_ref_count(struct cx231xx *dev, u32 video_input)\n{\n\tu8 input_mode = 0;\n\tu8 ntf_mode = 0;\n\tint status = 0;\n\n\tdev->video_input = video_input;\n\n\tif (video_input == CX231XX_VMUX_TELEVISION) {\n\t\tstatus = afe_read_byte(dev, ADC_INPUT_CH3, &input_mode);\n\t\tstatus = afe_read_byte(dev, ADC_NTF_PRECLMP_EN_CH3,\n\t\t\t\t\t&ntf_mode);\n\t} else {\n\t\tstatus = afe_read_byte(dev, ADC_INPUT_CH1, &input_mode);\n\t\tstatus = afe_read_byte(dev, ADC_NTF_PRECLMP_EN_CH1,\n\t\t\t\t\t&ntf_mode);\n\t}\n\n\tinput_mode = (ntf_mode & 0x3) | ((input_mode & 0x6) << 1);\n\n\tswitch (input_mode) {\n\tcase SINGLE_ENDED:\n\t\tdev->afe_ref_count = 0x23C;\n\t\tbreak;\n\tcase LOW_IF:\n\t\tdev->afe_ref_count = 0x24C;\n\t\tbreak;\n\tcase EU_IF:\n\t\tdev->afe_ref_count = 0x258;\n\t\tbreak;\n\tcase US_IF:\n\t\tdev->afe_ref_count = 0x260;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tstatus = cx231xx_afe_init_super_block(dev, dev->afe_ref_count);\n\n\treturn status;\n}\n\n \nstatic int vid_blk_write_byte(struct cx231xx *dev, u16 saddr, u8 data)\n{\n\treturn cx231xx_write_i2c_data(dev, VID_BLK_I2C_ADDRESS,\n\t\t\t\t\tsaddr, 2, data, 1);\n}\n\nstatic int vid_blk_read_byte(struct cx231xx *dev, u16 saddr, u8 *data)\n{\n\tint status;\n\tu32 temp = 0;\n\n\tstatus = cx231xx_read_i2c_data(dev, VID_BLK_I2C_ADDRESS,\n\t\t\t\t\tsaddr, 2, &temp, 1);\n\t*data = (u8) temp;\n\treturn status;\n}\n\nstatic int vid_blk_write_word(struct cx231xx *dev, u16 saddr, u32 data)\n{\n\treturn cx231xx_write_i2c_data(dev, VID_BLK_I2C_ADDRESS,\n\t\t\t\t\tsaddr, 2, data, 4);\n}\n\nstatic int vid_blk_read_word(struct cx231xx *dev, u16 saddr, u32 *data)\n{\n\treturn cx231xx_read_i2c_data(dev, VID_BLK_I2C_ADDRESS,\n\t\t\t\t\tsaddr, 2, data, 4);\n}\nint cx231xx_check_fw(struct cx231xx *dev)\n{\n\tu8 temp = 0;\n\tint status = 0;\n\tstatus = vid_blk_read_byte(dev, DL_CTL_ADDRESS_LOW, &temp);\n\tif (status < 0)\n\t\treturn status;\n\telse\n\t\treturn temp;\n\n}\n\nint cx231xx_set_video_input_mux(struct cx231xx *dev, u8 input)\n{\n\tint status = 0;\n\n\tswitch (INPUT(input)->type) {\n\tcase CX231XX_VMUX_COMPOSITE1:\n\tcase CX231XX_VMUX_SVIDEO:\n\t\tif ((dev->current_pcb_config.type == USB_BUS_POWER) &&\n\t\t    (dev->power_mode != POLARIS_AVMODE_ENXTERNAL_AV)) {\n\t\t\t \n\t\t\tstatus = cx231xx_set_power_mode(dev,\n\t\t\t\t\tPOLARIS_AVMODE_ENXTERNAL_AV);\n\t\t\tif (status < 0) {\n\t\t\t\tdev_err(dev->dev,\n\t\t\t\t\t\"%s: Failed to set Power - errCode [%d]!\\n\",\n\t\t\t\t\t__func__, status);\n\t\t\t\treturn status;\n\t\t\t}\n\t\t}\n\t\tstatus = cx231xx_set_decoder_video_input(dev,\n\t\t\t\t\t\t\t INPUT(input)->type,\n\t\t\t\t\t\t\t INPUT(input)->vmux);\n\t\tbreak;\n\tcase CX231XX_VMUX_TELEVISION:\n\tcase CX231XX_VMUX_CABLE:\n\t\tif ((dev->current_pcb_config.type == USB_BUS_POWER) &&\n\t\t    (dev->power_mode != POLARIS_AVMODE_ANALOGT_TV)) {\n\t\t\t \n\t\t\tstatus = cx231xx_set_power_mode(dev,\n\t\t\t\t\t\tPOLARIS_AVMODE_ANALOGT_TV);\n\t\t\tif (status < 0) {\n\t\t\t\tdev_err(dev->dev,\n\t\t\t\t\t\"%s: Failed to set Power - errCode [%d]!\\n\",\n\t\t\t\t\t__func__, status);\n\t\t\t\treturn status;\n\t\t\t}\n\t\t}\n\t\tswitch (dev->model) {  \n\t\tcase CX231XX_BOARD_HAUPPAUGE_930C_HD_1114xx:\n\t\tcase CX231XX_BOARD_HAUPPAUGE_935C:\n\t\tcase CX231XX_BOARD_HAUPPAUGE_955Q:\n\t\tcase CX231XX_BOARD_HAUPPAUGE_975:\n\t\tcase CX231XX_BOARD_EVROMEDIA_FULL_HYBRID_FULLHD:\n\t\t\tstatus = cx231xx_set_decoder_video_input(dev,\n\t\t\t\t\t\t\tCX231XX_VMUX_TELEVISION,\n\t\t\t\t\t\t\tINPUT(input)->vmux);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tif (dev->tuner_type == TUNER_NXP_TDA18271)\n\t\t\t\tstatus = cx231xx_set_decoder_video_input(dev,\n\t\t\t\t\t\t\tCX231XX_VMUX_TELEVISION,\n\t\t\t\t\t\t\tINPUT(input)->vmux);\n\t\t\telse\n\t\t\t\tstatus = cx231xx_set_decoder_video_input(dev,\n\t\t\t\t\t\t\tCX231XX_VMUX_COMPOSITE1,\n\t\t\t\t\t\t\tINPUT(input)->vmux);\n\t\t\tbreak;\n\t\t}\n\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev->dev, \"%s: Unknown Input %d !\\n\",\n\t\t\t__func__, INPUT(input)->type);\n\t\tbreak;\n\t}\n\n\t \n\tdev->video_input = input;\n\n\treturn status;\n}\n\nint cx231xx_set_decoder_video_input(struct cx231xx *dev,\n\t\t\t\tu8 pin_type, u8 input)\n{\n\tint status = 0;\n\tu32 value = 0;\n\n\tif (pin_type != dev->video_input) {\n\t\tstatus = cx231xx_afe_adjust_ref_count(dev, pin_type);\n\t\tif (status < 0) {\n\t\t\tdev_err(dev->dev,\n\t\t\t\t\"%s: adjust_ref_count :Failed to set AFE input mux - errCode [%d]!\\n\",\n\t\t\t\t__func__, status);\n\t\t\treturn status;\n\t\t}\n\t}\n\n\t \n\tstatus = cx231xx_afe_set_input_mux(dev, input);\n\tif (status < 0) {\n\t\tdev_err(dev->dev,\n\t\t\t\"%s: set_input_mux :Failed to set AFE input mux - errCode [%d]!\\n\",\n\t\t\t__func__, status);\n\t\treturn status;\n\t}\n\n\tswitch (pin_type) {\n\tcase CX231XX_VMUX_COMPOSITE1:\n\t\tstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\n\t\tvalue |= (0 << 13) | (1 << 4);\n\t\tvalue &= ~(1 << 5);\n\n\t\t \n\t\tvalue &= (~(0x1ff8000));\n\t\t \n\t\tvalue |= 0x1000000;\n\t\tstatus = vid_blk_write_word(dev, AFE_CTRL, value);\n\n\t\tstatus = vid_blk_read_word(dev, OUT_CTRL1, &value);\n\t\tvalue |= (1 << 7);\n\t\tstatus = vid_blk_write_word(dev, OUT_CTRL1, value);\n\n\t\t \n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tOUT_CTRL1,\n\t\t\t\t\t\t\tFLD_OUT_MODE,\n\t\t\t\t\t\t\tdev->board.output_mode);\n\n\t\t \n\t\tstatus = cx231xx_dif_set_standard(dev, DIF_USE_BASEBAND);\n\t\tif (status < 0) {\n\t\t\tdev_err(dev->dev,\n\t\t\t\t\"%s: cx231xx_dif set to By pass mode- errCode [%d]!\\n\",\n\t\t\t\t__func__, status);\n\t\t\treturn status;\n\t\t}\n\n\t\t \n\t\tstatus = vid_blk_read_word(dev, DFE_CTRL1, &value);\n\n\t\t \n\t\tvalue |= FLD_VBI_GATE_EN;\n\n\t\t \n\t\tvalue |= FLD_VGA_AUTO_EN;\n\n\t\t \n\t\tstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\n\n\t\t \n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\tMODE_CTRL, FLD_ACFG_DIS,\n\t\t\t\t\tcx231xx_set_field(FLD_ACFG_DIS, 1));\n\n\t\t \n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\tMODE_CTRL, FLD_INPUT_MODE,\n\t\t\tcx231xx_set_field(FLD_INPUT_MODE, INPUT_MODE_CVBS_0));\n\t\tbreak;\n\tcase CX231XX_VMUX_SVIDEO:\n\t\t \n\n\t\tstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\n\n\t\t \n\t\tvalue &= (~(0x1ff8000));\n\t\t \n\t\tvalue |= 0x1000010;\n\t\tstatus = vid_blk_write_word(dev, AFE_CTRL, value);\n\n\t\t \n\t\tstatus = cx231xx_dif_set_standard(dev, DIF_USE_BASEBAND);\n\t\tif (status < 0) {\n\t\t\tdev_err(dev->dev,\n\t\t\t\t\"%s: cx231xx_dif set to By pass mode- errCode [%d]!\\n\",\n\t\t\t\t__func__, status);\n\t\t\treturn status;\n\t\t}\n\n\t\t \n\t\tstatus = vid_blk_read_word(dev, DFE_CTRL1, &value);\n\n\t\t \n\t\tvalue |= FLD_VBI_GATE_EN;\n\n\t\t \n\t\tvalue |= FLD_VGA_AUTO_EN;\n\n\t\t \n\t\tstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\n\n\t\t \n\t\tstatus =  cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\tMODE_CTRL, FLD_ACFG_DIS,\n\t\t\t\t\tcx231xx_set_field(FLD_ACFG_DIS, 1));\n\n\t\t \n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\tMODE_CTRL,\n\t\t\tFLD_INPUT_MODE,\n\t\t\tcx231xx_set_field(FLD_INPUT_MODE, INPUT_MODE_YC_1));\n\n\t\t \n\t\tstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\n\t\tvalue |= FLD_CHROMA_IN_SEL;\t \n\n\t\t \n\t\tvalue &= ~(FLD_VGA_SEL_CH2 | FLD_VGA_SEL_CH3);\n\n\t\tstatus = vid_blk_write_word(dev, AFE_CTRL, value);\n\n\t\tstatus = cx231xx_afe_set_mode(dev, AFE_MODE_BASEBAND);\n\t\tbreak;\n\tcase CX231XX_VMUX_TELEVISION:\n\tcase CX231XX_VMUX_CABLE:\n\tdefault:\n\t\t \n\t\tif (dev->board.tuner_type == TUNER_XC5000) {\n\t\t\t \n\n\t\t\tstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\n\t\t\tvalue |= (0 << 13) | (1 << 4);\n\t\t\tvalue &= ~(1 << 5);\n\n\t\t\t \n\t\t\tvalue &= (~(0x1FF8000));\n\t\t\t \n\t\t\tvalue |= 0x1000000;\n\t\t\tstatus = vid_blk_write_word(dev, AFE_CTRL, value);\n\n\t\t\tstatus = vid_blk_read_word(dev, OUT_CTRL1, &value);\n\t\t\tvalue |= (1 << 7);\n\t\t\tstatus = vid_blk_write_word(dev, OUT_CTRL1, value);\n\n\t\t\t \n\t\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tOUT_CTRL1, FLD_OUT_MODE,\n\t\t\t\t\t\t\tdev->board.output_mode);\n\n\t\t\t \n\t\t\tstatus = cx231xx_dif_set_standard(dev,\n\t\t\t\t\t\t\t  DIF_USE_BASEBAND);\n\t\t\tif (status < 0) {\n\t\t\t\tdev_err(dev->dev,\n\t\t\t\t\t\"%s: cx231xx_dif set to By pass mode- errCode [%d]!\\n\",\n\t\t\t\t       __func__, status);\n\t\t\t\treturn status;\n\t\t\t}\n\n\t\t\t \n\t\t\tstatus = vid_blk_read_word(dev, DFE_CTRL1, &value);\n\n\t\t\t \n\t\t\tvalue |= FLD_VBI_GATE_EN;\n\n\t\t\t \n\t\t\tvalue |= FLD_VGA_AUTO_EN;\n\n\t\t\t \n\t\t\tstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\n\n\t\t\t \n\t\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\tMODE_CTRL, FLD_ACFG_DIS,\n\t\t\t\t\tcx231xx_set_field(FLD_ACFG_DIS, 1));\n\n\t\t\t \n\t\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\tMODE_CTRL, FLD_INPUT_MODE,\n\t\t\t\tcx231xx_set_field(FLD_INPUT_MODE,\n\t\t\t\t\t\tINPUT_MODE_CVBS_0));\n\t\t} else {\n\t\t\t \n\n\t\t\t \n\t\t\tstatus = cx231xx_dif_set_standard(dev, dev->norm);\n\t\t\tif (status < 0) {\n\t\t\t\tdev_err(dev->dev,\n\t\t\t\t\t\"%s: cx231xx_dif set to By pass mode- errCode [%d]!\\n\",\n\t\t\t\t\t__func__, status);\n\t\t\t\treturn status;\n\t\t\t}\n\n\t\t\t \n\t\t\tstatus = vid_blk_read_word(dev, DIF_MISC_CTRL, &value);\n\n\t\t\t \n\t\t\tvalue &= ~FLD_DIF_DIF_BYPASS;\n\n\t\t\t \n\t\t\tstatus = vid_blk_write_word(dev, DIF_MISC_CTRL, value);\n\n\t\t\t \n\t\t\tstatus = vid_blk_read_word(dev, DFE_CTRL1, &value);\n\n\t\t\t \n\t\t\tvalue &= ~FLD_VBI_GATE_EN;\n\n\t\t\t \n\t\t\tvalue |= FLD_VGA_AUTO_EN | FLD_AGC_AUTO_EN | 0x00200000;\n\n\t\t\t \n\t\t\tstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\n\n\t\t\t \n\t\t\tmsleep(1);\n\n\t\t\t \n\t\t\tvalue &= ~(FLD_VGA_AUTO_EN);\n\n\t\t\t \n\t\t\tstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\n\n\t\t\t \n\t\t\tstatus = vid_blk_read_word(dev, PIN_CTRL, &value);\n\t\t\tvalue |= (FLD_OEF_AGC_RF) |\n\t\t\t\t (FLD_OEF_AGC_IFVGA) |\n\t\t\t\t (FLD_OEF_AGC_IF);\n\t\t\tstatus = vid_blk_write_word(dev, PIN_CTRL, value);\n\n\t\t\t \n\t\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\tOUT_CTRL1, FLD_OUT_MODE,\n\t\t\t\t\t\tdev->board.output_mode);\n\n\t\t\t \n\t\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\tMODE_CTRL, FLD_ACFG_DIS,\n\t\t\t\t\tcx231xx_set_field(FLD_ACFG_DIS, 1));\n\n\t\t\t \n\t\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\tMODE_CTRL, FLD_INPUT_MODE,\n\t\t\t\tcx231xx_set_field(FLD_INPUT_MODE,\n\t\t\t\t\t\tINPUT_MODE_CVBS_0));\n\n\t\t\t \n\t\t\t \n\t\t\t \n\t\t\t \n\t\t\tstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\n\n\t\t\t \n\t\t\tvalue &= (~(FLD_FUNC_MODE));\n\t\t\tvalue |= 0x800000;\n\n\t\t\tvalue |= FLD_VGA_SEL_CH3 | FLD_VGA_SEL_CH2;\n\n\t\t\tstatus = vid_blk_write_word(dev, AFE_CTRL, value);\n\n\t\t\tif (dev->tuner_type == TUNER_NXP_TDA18271) {\n\t\t\t\tstatus = vid_blk_read_word(dev, PIN_CTRL,\n\t\t\t\t &value);\n\t\t\t\tstatus = vid_blk_write_word(dev, PIN_CTRL,\n\t\t\t\t (value & 0xFFFFFFEF));\n\t\t\t}\n\n\t\t\tbreak;\n\n\t\t}\n\t\tbreak;\n\t}\n\n\t \n\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\tOUT_CTRL1, FLD_VBIHACTRAW_EN,\n\t\t\t\tcx231xx_set_field(FLD_VBIHACTRAW_EN, 1));\n\n\tstatus = vid_blk_read_word(dev, OUT_CTRL1, &value);\n\tif (value & 0x02) {\n\t\tvalue |= (1 << 19);\n\t\tstatus = vid_blk_write_word(dev, OUT_CTRL1, value);\n\t}\n\n\treturn status;\n}\n\nvoid cx231xx_enable656(struct cx231xx *dev)\n{\n\tu8 temp = 0;\n\t \n\n\tvid_blk_write_byte(dev, TS1_PIN_CTL0, 0xFF);\n\n\t \n\n\tvid_blk_read_byte(dev, TS1_PIN_CTL1, &temp);\n\ttemp = temp|0x04;\n\n\tvid_blk_write_byte(dev, TS1_PIN_CTL1, temp);\n}\nEXPORT_SYMBOL_GPL(cx231xx_enable656);\n\nvoid cx231xx_disable656(struct cx231xx *dev)\n{\n\tu8 temp = 0;\n\n\tvid_blk_write_byte(dev, TS1_PIN_CTL0, 0x00);\n\n\tvid_blk_read_byte(dev, TS1_PIN_CTL1, &temp);\n\ttemp = temp&0xFB;\n\n\tvid_blk_write_byte(dev, TS1_PIN_CTL1, temp);\n}\nEXPORT_SYMBOL_GPL(cx231xx_disable656);\n\n \nint cx231xx_do_mode_ctrl_overrides(struct cx231xx *dev)\n{\n\tint status = 0;\n\n\tdev_dbg(dev->dev, \"%s: 0x%x\\n\",\n\t\t__func__, (unsigned int)dev->norm);\n\n\t \n\tstatus = vid_blk_write_word(dev, DFE_CTRL3, 0xCD3F0280);\n\n\tif (dev->norm & (V4L2_STD_NTSC | V4L2_STD_PAL_M)) {\n\t\tdev_dbg(dev->dev, \"%s: NTSC\\n\", __func__);\n\n\t\t \n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tVERT_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_VBLANK_CNT, 0x18);\n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tVERT_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_VACTIVE_CNT,\n\t\t\t\t\t\t\t0x1E7000);\n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tVERT_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_V656BLANK_CNT,\n\t\t\t\t\t\t\t0x1C000000);\n\n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tHORIZ_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_HBLANK_CNT,\n\t\t\t\t\t\t\tcx231xx_set_field\n\t\t\t\t\t\t\t(FLD_HBLANK_CNT, 0x79));\n\n\t} else if (dev->norm & V4L2_STD_SECAM) {\n\t\tdev_dbg(dev->dev, \"%s: SECAM\\n\", __func__);\n\t\tstatus =  cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tVERT_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_VBLANK_CNT, 0x20);\n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tVERT_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_VACTIVE_CNT,\n\t\t\t\t\t\t\tcx231xx_set_field\n\t\t\t\t\t\t\t(FLD_VACTIVE_CNT,\n\t\t\t\t\t\t\t 0x244));\n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tVERT_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_V656BLANK_CNT,\n\t\t\t\t\t\t\tcx231xx_set_field\n\t\t\t\t\t\t\t(FLD_V656BLANK_CNT,\n\t\t\t\t\t\t\t0x24));\n\t\t \n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tHORIZ_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_HBLANK_CNT,\n\t\t\t\t\t\t\tcx231xx_set_field\n\t\t\t\t\t\t\t(FLD_HBLANK_CNT, 0x85));\n\t} else {\n\t\tdev_dbg(dev->dev, \"%s: PAL\\n\", __func__);\n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tVERT_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_VBLANK_CNT, 0x20);\n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tVERT_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_VACTIVE_CNT,\n\t\t\t\t\t\t\tcx231xx_set_field\n\t\t\t\t\t\t\t(FLD_VACTIVE_CNT,\n\t\t\t\t\t\t\t 0x244));\n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tVERT_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_V656BLANK_CNT,\n\t\t\t\t\t\t\tcx231xx_set_field\n\t\t\t\t\t\t\t(FLD_V656BLANK_CNT,\n\t\t\t\t\t\t\t0x24));\n\t\t \n\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\t\t\tHORIZ_TIM_CTRL,\n\t\t\t\t\t\t\tFLD_HBLANK_CNT,\n\t\t\t\t\t\t\tcx231xx_set_field\n\t\t\t\t\t\t\t(FLD_HBLANK_CNT, 0x85));\n\n\t}\n\n\treturn status;\n}\n\nint cx231xx_unmute_audio(struct cx231xx *dev)\n{\n\treturn vid_blk_write_byte(dev, PATH1_VOL_CTL, 0x24);\n}\nEXPORT_SYMBOL_GPL(cx231xx_unmute_audio);\n\nstatic int stopAudioFirmware(struct cx231xx *dev)\n{\n\treturn vid_blk_write_byte(dev, DL_CTL_CONTROL, 0x03);\n}\n\nstatic int restartAudioFirmware(struct cx231xx *dev)\n{\n\treturn vid_blk_write_byte(dev, DL_CTL_CONTROL, 0x13);\n}\n\nint cx231xx_set_audio_input(struct cx231xx *dev, u8 input)\n{\n\tint status = 0;\n\tenum AUDIO_INPUT ainput = AUDIO_INPUT_LINE;\n\n\tswitch (INPUT(input)->amux) {\n\tcase CX231XX_AMUX_VIDEO:\n\t\tainput = AUDIO_INPUT_TUNER_TV;\n\t\tbreak;\n\tcase CX231XX_AMUX_LINE_IN:\n\t\tstatus = cx231xx_i2s_blk_set_audio_input(dev, input);\n\t\tainput = AUDIO_INPUT_LINE;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tstatus = cx231xx_set_audio_decoder_input(dev, ainput);\n\n\treturn status;\n}\n\nint cx231xx_set_audio_decoder_input(struct cx231xx *dev,\n\t\t\t\t    enum AUDIO_INPUT audio_input)\n{\n\tu32 dwval;\n\tint status;\n\tu8 gen_ctrl;\n\tu32 value = 0;\n\n\t \n\tstatus = vid_blk_read_byte(dev, GENERAL_CTL, &gen_ctrl);\n\tgen_ctrl |= 1;\n\tstatus = vid_blk_write_byte(dev, GENERAL_CTL, gen_ctrl);\n\n\tswitch (audio_input) {\n\tcase AUDIO_INPUT_LINE:\n\t\t \n\t\tvalue = cx231xx_set_field(FLD_AUD_CHAN1_SRC,\n\t\t\t\t\t  AUD_CHAN_SRC_PARALLEL);\n\t\tstatus = vid_blk_write_word(dev, AUD_IO_CTRL, value);\n\n\t\t \n\t\tstatus = vid_blk_read_word(dev, AC97_CTL, &dwval);\n\n\t\tstatus = vid_blk_write_word(dev, AC97_CTL,\n\t\t\t\t\t   (dwval | FLD_AC97_UP2X_BYPASS));\n\n\t\t \n\t\tstatus = vid_blk_write_word(dev, BAND_OUT_SEL,\n\t\t\t\tcx231xx_set_field(FLD_SRC3_IN_SEL, 0x0) |\n\t\t\t\tcx231xx_set_field(FLD_SRC3_CLK_SEL, 0x0) |\n\t\t\t\tcx231xx_set_field(FLD_PARALLEL1_SRC_SEL, 0x0));\n\n\t\t \n\t\tstatus = vid_blk_write_word(dev, DL_CTL, 0x3000001);\n\t\tstatus = vid_blk_write_word(dev, PATH1_CTL1, 0x00063073);\n\n\t\t \n\t\tstatus = vid_blk_read_word(dev, PATH1_VOL_CTL, &dwval);\n\t\tstatus = vid_blk_write_word(dev, PATH1_VOL_CTL,\n\t\t\t\t\t   (dwval | FLD_PATH1_AVC_THRESHOLD));\n\n\t\t \n\t\tstatus = vid_blk_read_word(dev, PATH1_SC_CTL, &dwval);\n\t\tstatus = vid_blk_write_word(dev, PATH1_SC_CTL,\n\t\t\t\t\t   (dwval | FLD_PATH1_SC_THRESHOLD));\n\t\tbreak;\n\n\tcase AUDIO_INPUT_TUNER_TV:\n\tdefault:\n\t\tstatus = stopAudioFirmware(dev);\n\t\t \n\t\tstatus = vid_blk_write_word(dev, BAND_OUT_SEL,\n\t\t\tcx231xx_set_field(FLD_SRC6_IN_SEL, 0x00)         |\n\t\t\tcx231xx_set_field(FLD_SRC6_CLK_SEL, 0x01)        |\n\t\t\tcx231xx_set_field(FLD_SRC5_IN_SEL, 0x00)         |\n\t\t\tcx231xx_set_field(FLD_SRC5_CLK_SEL, 0x02)        |\n\t\t\tcx231xx_set_field(FLD_SRC4_IN_SEL, 0x02)         |\n\t\t\tcx231xx_set_field(FLD_SRC4_CLK_SEL, 0x03)        |\n\t\t\tcx231xx_set_field(FLD_SRC3_IN_SEL, 0x00)         |\n\t\t\tcx231xx_set_field(FLD_SRC3_CLK_SEL, 0x00)        |\n\t\t\tcx231xx_set_field(FLD_BASEBAND_BYPASS_CTL, 0x00) |\n\t\t\tcx231xx_set_field(FLD_AC97_SRC_SEL, 0x03)        |\n\t\t\tcx231xx_set_field(FLD_I2S_SRC_SEL, 0x00)         |\n\t\t\tcx231xx_set_field(FLD_PARALLEL2_SRC_SEL, 0x02)   |\n\t\t\tcx231xx_set_field(FLD_PARALLEL1_SRC_SEL, 0x01));\n\n\t\t \n\t\tstatus = vid_blk_write_word(dev, AUD_IO_CTRL,\n\t\t\tcx231xx_set_field(FLD_I2S_PORT_DIR, 0x00)  |\n\t\t\tcx231xx_set_field(FLD_I2S_OUT_SRC, 0x00)   |\n\t\t\tcx231xx_set_field(FLD_AUD_CHAN3_SRC, 0x00) |\n\t\t\tcx231xx_set_field(FLD_AUD_CHAN2_SRC, 0x00) |\n\t\t\tcx231xx_set_field(FLD_AUD_CHAN1_SRC, 0x03));\n\n\t\tstatus = vid_blk_write_word(dev, PATH1_CTL1, 0x1F063870);\n\n\t\t \n\t\tstatus = vid_blk_write_word(dev, PATH1_CTL1, 0x00063870);\n\n\t\tstatus = restartAudioFirmware(dev);\n\n\t\tswitch (dev->board.tuner_type) {\n\t\tcase TUNER_XC5000:\n\t\t\t \n\t\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\tCHIP_CTRL,\n\t\t\t\t\tFLD_SIF_EN,\n\t\t\t\t\tcx231xx_set_field(FLD_SIF_EN, 1));\n\t\t\tbreak;\n\t\tcase TUNER_NXP_TDA18271:\n\t\t\t \n\t\t\tstatus = cx231xx_read_modify_write_i2c_dword(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS,\n\t\t\t\t\tCHIP_CTRL,\n\t\t\t\t\tFLD_SIF_EN,\n\t\t\t\t\tcx231xx_set_field(FLD_SIF_EN, 0));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tswitch (dev->model) {  \n\t\t\tcase CX231XX_BOARD_HAUPPAUGE_930C_HD_1114xx:\n\t\t\tcase CX231XX_BOARD_HAUPPAUGE_935C:\n\t\t\tcase CX231XX_BOARD_HAUPPAUGE_955Q:\n\t\t\tcase CX231XX_BOARD_HAUPPAUGE_975:\n\t\t\tcase CX231XX_BOARD_EVROMEDIA_FULL_HYBRID_FULLHD:\n\t\t\t \n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t \n\t\t\t\tdev_info(dev->dev,\n\t\t\t\t\t \"Unknown tuner type configuring SIF\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tcase AUDIO_INPUT_TUNER_FM:\n\t\t \n\t\tbreak;\n\n\tcase AUDIO_INPUT_MUTE:\n\t\tstatus = vid_blk_write_word(dev, PATH1_CTL1, 0x1F011012);\n\t\tbreak;\n\t}\n\n\t \n\tstatus = vid_blk_read_byte(dev, GENERAL_CTL, &gen_ctrl);\n\tgen_ctrl &= ~1;\n\tstatus = vid_blk_write_byte(dev, GENERAL_CTL, gen_ctrl);\n\n\treturn status;\n}\n\n \nint cx231xx_init_ctrl_pin_status(struct cx231xx *dev)\n{\n\tu32 value;\n\tint status = 0;\n\n\tstatus = vid_blk_read_word(dev, PIN_CTRL, &value);\n\tvalue |= (~dev->board.ctl_pin_status_mask);\n\tstatus = vid_blk_write_word(dev, PIN_CTRL, value);\n\n\treturn status;\n}\n\nint cx231xx_set_agc_analog_digital_mux_select(struct cx231xx *dev,\n\t\t\t\t\t      u8 analog_or_digital)\n{\n\tint status;\n\n\t \n\tstatus = cx231xx_set_gpio_direction(dev,\n\t\t\t\t\t    dev->board.\n\t\t\t\t\t    agc_analog_digital_select_gpio, 1);\n\n\t \n\tstatus = cx231xx_set_gpio_value(dev,\n\t\t\t\t   dev->board.agc_analog_digital_select_gpio,\n\t\t\t\t   analog_or_digital);\n\n\tif (status < 0)\n\t\treturn status;\n\n\treturn 0;\n}\n\nint cx231xx_enable_i2c_port_3(struct cx231xx *dev, bool is_port_3)\n{\n\tu8 value[4] = { 0, 0, 0, 0 };\n\tint status = 0;\n\tbool current_is_port_3;\n\n\t \n\n\tstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER,\n\t\t\t\t       PWR_CTL_EN, value, 4);\n\tif (status < 0)\n\t\treturn status;\n\n\tcurrent_is_port_3 = value[0] & I2C_DEMOD_EN ? true : false;\n\n\t \n\tif (current_is_port_3 == is_port_3)\n\t\treturn 0;\n\n\tif (is_port_3)\n\t\tvalue[0] |= I2C_DEMOD_EN;\n\telse\n\t\tvalue[0] &= ~I2C_DEMOD_EN;\n\n\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\tPWR_CTL_EN, value, 4);\n\n\t \n\tif (status >= 0)\n\t\tdev->port_3_switch_enabled = is_port_3;\n\n\treturn status;\n\n}\nEXPORT_SYMBOL_GPL(cx231xx_enable_i2c_port_3);\n\nvoid update_HH_register_after_set_DIF(struct cx231xx *dev)\n{\n \n}\n\nvoid cx231xx_dump_HH_reg(struct cx231xx *dev)\n{\n\tu32 value = 0;\n\tu16  i = 0;\n\n\tvalue = 0x45005390;\n\tvid_blk_write_word(dev, 0x104, value);\n\n\tfor (i = 0x100; i < 0x140; i++) {\n\t\tvid_blk_read_word(dev, i, &value);\n\t\tdev_dbg(dev->dev, \"reg0x%x=0x%x\\n\", i, value);\n\t\ti = i+3;\n\t}\n\n\tfor (i = 0x300; i < 0x400; i++) {\n\t\tvid_blk_read_word(dev, i, &value);\n\t\tdev_dbg(dev->dev, \"reg0x%x=0x%x\\n\", i, value);\n\t\ti = i+3;\n\t}\n\n\tfor (i = 0x400; i < 0x440; i++) {\n\t\tvid_blk_read_word(dev, i,  &value);\n\t\tdev_dbg(dev->dev, \"reg0x%x=0x%x\\n\", i, value);\n\t\ti = i+3;\n\t}\n\n\tvid_blk_read_word(dev, AFE_CTRL_C2HH_SRC_CTRL, &value);\n\tdev_dbg(dev->dev, \"AFE_CTRL_C2HH_SRC_CTRL=0x%x\\n\", value);\n\tvid_blk_write_word(dev, AFE_CTRL_C2HH_SRC_CTRL, 0x4485D390);\n\tvid_blk_read_word(dev, AFE_CTRL_C2HH_SRC_CTRL, &value);\n\tdev_dbg(dev->dev, \"AFE_CTRL_C2HH_SRC_CTRL=0x%x\\n\", value);\n}\n\n#if 0\nstatic void cx231xx_dump_SC_reg(struct cx231xx *dev)\n{\n\tu8 value[4] = { 0, 0, 0, 0 };\n\tdev_dbg(dev->dev, \"%s!\\n\", __func__);\n\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, BOARD_CFG_STAT,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", BOARD_CFG_STAT, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS_MODE_REG,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", TS_MODE_REG, value[0],\n\t\t value[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS1_CFG_REG,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", TS1_CFG_REG, value[0],\n\t\t value[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS1_LENGTH_REG,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", TS1_LENGTH_REG, value[0],\n\t\tvalue[1], value[2], value[3]);\n\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS2_CFG_REG,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", TS2_CFG_REG, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS2_LENGTH_REG,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", TS2_LENGTH_REG, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, EP_MODE_SET,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", EP_MODE_SET, value[0],\n\t\t value[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_PTN1,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_PWR_PTN1, value[0],\n\t\tvalue[1], value[2], value[3]);\n\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_PTN2,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_PWR_PTN2, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_PTN3,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_PWR_PTN3, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_MASK0,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_PWR_MASK0, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_MASK1,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_PWR_MASK1, value[0],\n\t\tvalue[1], value[2], value[3]);\n\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_MASK2,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_PWR_MASK2, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_GAIN,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_GAIN, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_CAR_REG,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_CAR_REG, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_OT_CFG1,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_OT_CFG1, value[0],\n\t\tvalue[1], value[2], value[3]);\n\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_OT_CFG2,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", CIR_OT_CFG2, value[0],\n\t\tvalue[1], value[2], value[3]);\n\tcx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, PWR_CTL_EN,\n\t\t\t\t value, 4);\n\tdev_dbg(dev->dev,\n\t\t\"reg0x%x=0x%x 0x%x 0x%x 0x%x\\n\", PWR_CTL_EN, value[0],\n\t\tvalue[1], value[2], value[3]);\n}\n#endif\n\nvoid cx231xx_Setup_AFE_for_LowIF(struct cx231xx *dev)\n\n{\n\tu8 value = 0;\n\n\tafe_read_byte(dev, ADC_STATUS2_CH3, &value);\n\tvalue = (value & 0xFE)|0x01;\n\tafe_write_byte(dev, ADC_STATUS2_CH3, value);\n\n\tafe_read_byte(dev, ADC_STATUS2_CH3, &value);\n\tvalue = (value & 0xFE)|0x00;\n\tafe_write_byte(dev, ADC_STATUS2_CH3, value);\n\n\n \n\n\tafe_read_byte(dev, ADC_NTF_PRECLMP_EN_CH3, &value);\n\tvalue = (value & 0xFC)|0x00;\n\tafe_write_byte(dev, ADC_NTF_PRECLMP_EN_CH3, value);\n\n\tafe_read_byte(dev, ADC_INPUT_CH3, &value);\n\tvalue = (value & 0xF9)|0x02;\n\tafe_write_byte(dev, ADC_INPUT_CH3, value);\n\n\tafe_read_byte(dev, ADC_FB_FRCRST_CH3, &value);\n\tvalue = (value & 0xFB)|0x04;\n\tafe_write_byte(dev, ADC_FB_FRCRST_CH3, value);\n\n\tafe_read_byte(dev, ADC_DCSERVO_DEM_CH3, &value);\n\tvalue = (value & 0xFC)|0x03;\n\tafe_write_byte(dev, ADC_DCSERVO_DEM_CH3, value);\n\n\tafe_read_byte(dev, ADC_CTRL_DAC1_CH3, &value);\n\tvalue = (value & 0xFB)|0x04;\n\tafe_write_byte(dev, ADC_CTRL_DAC1_CH3, value);\n\n\tafe_read_byte(dev, ADC_CTRL_DAC23_CH3, &value);\n\tvalue = (value & 0xF8)|0x06;\n\tafe_write_byte(dev, ADC_CTRL_DAC23_CH3, value);\n\n\tafe_read_byte(dev, ADC_CTRL_DAC23_CH3, &value);\n\tvalue = (value & 0x8F)|0x40;\n\tafe_write_byte(dev, ADC_CTRL_DAC23_CH3, value);\n\n\tafe_read_byte(dev, ADC_PWRDN_CLAMP_CH3, &value);\n\tvalue = (value & 0xDF)|0x20;\n\tafe_write_byte(dev, ADC_PWRDN_CLAMP_CH3, value);\n}\n\nvoid cx231xx_set_Colibri_For_LowIF(struct cx231xx *dev, u32 if_freq,\n\t\t u8 spectral_invert, u32 mode)\n{\n\tu32 colibri_carrier_offset = 0;\n\tu32 func_mode = 0x01;  \n\tu32 standard = 0;\n\tu8 value[4] = { 0, 0, 0, 0 };\n\n\tdev_dbg(dev->dev, \"Enter cx231xx_set_Colibri_For_LowIF()\\n\");\n\tvalue[0] = (u8) 0x6F;\n\tvalue[1] = (u8) 0x6F;\n\tvalue[2] = (u8) 0x6F;\n\tvalue[3] = (u8) 0x6F;\n\tcx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\tPWR_CTL_EN, value, 4);\n\n\t \n\tcx231xx_afe_set_mode(dev, AFE_MODE_LOW_IF);\n\n\t \n\tstandard = dev->norm;\n\tcx231xx_dif_configure_C2HH_for_low_IF(dev, dev->active_mode,\n\t\t\t\t\t\t       func_mode, standard);\n\n\t \n\tcolibri_carrier_offset = cx231xx_Get_Colibri_CarrierOffset(mode,\n\t\t\t\t\t\t\t\t   standard);\n\n\tdev_dbg(dev->dev, \"colibri_carrier_offset=%d, standard=0x%x\\n\",\n\t\t     colibri_carrier_offset, standard);\n\n\t \n\tcx231xx_set_DIF_bandpass(dev, (if_freq+colibri_carrier_offset),\n\t\t\t\t spectral_invert, mode);\n}\n\nu32 cx231xx_Get_Colibri_CarrierOffset(u32 mode, u32 standerd)\n{\n\tu32 colibri_carrier_offset = 0;\n\n\tif (mode == TUNER_MODE_FM_RADIO) {\n\t\tcolibri_carrier_offset = 1100000;\n\t} else if (standerd & (V4L2_STD_MN | V4L2_STD_NTSC_M_JP)) {\n\t\tcolibri_carrier_offset = 4832000;   \n\t} else if (standerd & (V4L2_STD_PAL_B | V4L2_STD_PAL_G)) {\n\t\tcolibri_carrier_offset = 2700000;   \n\t} else if (standerd & (V4L2_STD_PAL_D | V4L2_STD_PAL_I\n\t\t\t| V4L2_STD_SECAM)) {\n\t\tcolibri_carrier_offset = 2100000;   \n\t}\n\n\treturn colibri_carrier_offset;\n}\n\nvoid cx231xx_set_DIF_bandpass(struct cx231xx *dev, u32 if_freq,\n\t\t u8 spectral_invert, u32 mode)\n{\n\tunsigned long pll_freq_word;\n\tu32 dif_misc_ctrl_value = 0;\n\tu64 pll_freq_u64 = 0;\n\tu32 i = 0;\n\n\tdev_dbg(dev->dev, \"if_freq=%d;spectral_invert=0x%x;mode=0x%x\\n\",\n\t\tif_freq, spectral_invert, mode);\n\n\n\tif (mode == TUNER_MODE_FM_RADIO) {\n\t\tpll_freq_word = 0x905A1CAC;\n\t\tvid_blk_write_word(dev, DIF_PLL_FREQ_WORD,  pll_freq_word);\n\n\t} else  {\n\t\t \n\t\tpll_freq_word = if_freq;\n\t\tpll_freq_u64 = (u64)pll_freq_word << 28L;\n\t\tdo_div(pll_freq_u64, 50000000);\n\t\tpll_freq_word = (u32)pll_freq_u64;\n\t\t \n\t\tvid_blk_write_word(dev, DIF_PLL_FREQ_WORD,  pll_freq_word);\n\n\t\tif (spectral_invert) {\n\t\t\tif_freq -= 400000;\n\t\t\t \n\t\t\tvid_blk_read_word(dev, DIF_MISC_CTRL,\n\t\t\t\t\t  &dif_misc_ctrl_value);\n\t\t\tdif_misc_ctrl_value = dif_misc_ctrl_value | 0x00200000;\n\t\t\tvid_blk_write_word(dev, DIF_MISC_CTRL,\n\t\t\t\t\t  dif_misc_ctrl_value);\n\t\t} else {\n\t\t\tif_freq += 400000;\n\t\t\t \n\t\t\tvid_blk_read_word(dev, DIF_MISC_CTRL,\n\t\t\t\t\t  &dif_misc_ctrl_value);\n\t\t\tdif_misc_ctrl_value = dif_misc_ctrl_value & 0xFFDFFFFF;\n\t\t\tvid_blk_write_word(dev, DIF_MISC_CTRL,\n\t\t\t\t\t  dif_misc_ctrl_value);\n\t\t}\n\n\t\tif_freq = (if_freq / 100000) * 100000;\n\n\t\tif (if_freq < 3000000)\n\t\t\tif_freq = 3000000;\n\n\t\tif (if_freq > 16000000)\n\t\t\tif_freq = 16000000;\n\t}\n\n\tdev_dbg(dev->dev, \"Enter IF=%zu\\n\", ARRAY_SIZE(Dif_set_array));\n\tfor (i = 0; i < ARRAY_SIZE(Dif_set_array); i++) {\n\t\tif (Dif_set_array[i].if_freq == if_freq) {\n\t\t\tvid_blk_write_word(dev,\n\t\t\tDif_set_array[i].register_address, Dif_set_array[i].value);\n\t\t}\n\t}\n}\n\n \nint cx231xx_dif_configure_C2HH_for_low_IF(struct cx231xx *dev, u32 mode,\n\t\t\t\t\t  u32 function_mode, u32 standard)\n{\n\tint status = 0;\n\n\n\tif (mode == V4L2_TUNER_RADIO) {\n\t\t \n\t\t \n\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 30, 31, 0x1);\n\t\t \n\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 23, 24, function_mode);\n\t\t \n\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 15, 22, 0xFF);\n\t\t \n\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 9, 9, 0x1);\n\t} else if (standard != DIF_USE_BASEBAND) {\n\t\tif (standard & V4L2_STD_MN) {\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 30, 31, 0x1);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 23, 24,\n\t\t\t\t\tfunction_mode);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 15, 22, 0xb);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 9, 9, 0x1);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAUD_IO_CTRL, 0, 31, 0x00000003);\n\t\t} else if ((standard == V4L2_STD_PAL_I) |\n\t\t\t(standard & V4L2_STD_PAL_D) |\n\t\t\t(standard & V4L2_STD_SECAM)) {\n\t\t\t \n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 30, 31, 0x1);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 23, 24,\n\t\t\t\t\tfunction_mode);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 15, 22, 0xF);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 9, 9, 0x1);\n\t\t} else {\n\t\t\t \n\t\t\t \n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 30, 31, 0x1);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 23, 24,\n\t\t\t\t\tfunction_mode);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 15, 22, 0xE);\n\t\t\t \n\t\t\tstatus = cx231xx_reg_mask_write(dev,\n\t\t\t\t\tVID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\tAFE_CTRL_C2HH_SRC_CTRL, 9, 9, 0x1);\n\t\t}\n\t}\n\n\treturn status;\n}\n\nint cx231xx_dif_set_standard(struct cx231xx *dev, u32 standard)\n{\n\tint status = 0;\n\tu32 dif_misc_ctrl_value = 0;\n\tu32 func_mode = 0;\n\n\tdev_dbg(dev->dev, \"%s: setStandard to %x\\n\", __func__, standard);\n\n\tstatus = vid_blk_read_word(dev, DIF_MISC_CTRL, &dif_misc_ctrl_value);\n\tif (standard != DIF_USE_BASEBAND)\n\t\tdev->norm = standard;\n\n\tswitch (dev->model) {\n\tcase CX231XX_BOARD_CNXT_CARRAERA:\n\tcase CX231XX_BOARD_CNXT_RDE_250:\n\tcase CX231XX_BOARD_CNXT_SHELBY:\n\tcase CX231XX_BOARD_CNXT_RDU_250:\n\tcase CX231XX_BOARD_CNXT_VIDEO_GRABBER:\n\tcase CX231XX_BOARD_HAUPPAUGE_EXETER:\n\tcase CX231XX_BOARD_OTG102:\n\t\tfunc_mode = 0x03;\n\t\tbreak;\n\tcase CX231XX_BOARD_CNXT_RDE_253S:\n\tcase CX231XX_BOARD_CNXT_RDU_253S:\n\tcase CX231XX_BOARD_HAUPPAUGE_USB2_FM_PAL:\n\tcase CX231XX_BOARD_HAUPPAUGE_USB2_FM_NTSC:\n\t\tfunc_mode = 0x01;\n\t\tbreak;\n\tdefault:\n\t\tfunc_mode = 0x01;\n\t}\n\n\tstatus = cx231xx_dif_configure_C2HH_for_low_IF(dev, dev->active_mode,\n\t\t\t\t\t\t  func_mode, standard);\n\n\tif (standard == DIF_USE_BASEBAND) {\t \n\t\t \n\t\tstatus = vid_blk_write_word(dev, DIF_SRC_PHASE_INC, 0xDF7DF83);\n\t\tstatus = vid_blk_read_word(dev, DIF_MISC_CTRL,\n\t\t\t\t\t\t&dif_misc_ctrl_value);\n\t\tdif_misc_ctrl_value |= FLD_DIF_DIF_BYPASS;\n\t\tstatus = vid_blk_write_word(dev, DIF_MISC_CTRL,\n\t\t\t\t\t\tdif_misc_ctrl_value);\n\t} else if (standard & V4L2_STD_PAL_D) {\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL, 0, 31, 0x6503bc0c);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL1, 0, 31, 0xbd038c85);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL2, 0, 31, 0x1db4640a);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL3, 0, 31, 0x00008800);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_REF, 0, 31, 0x444C1380);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_IF, 0, 31, 0xDA302600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_INT, 0, 31, 0xDA261700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_RF, 0, 31, 0xDA262600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_INT_CURRENT, 0, 31,\n\t\t\t\t\t   0x26001700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_RF_CURRENT, 0, 31,\n\t\t\t\t\t   0x00002660);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VIDEO_AGC_CTRL, 0, 31,\n\t\t\t\t\t   0x72500800);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VID_AUD_OVERRIDE, 0, 31,\n\t\t\t\t\t   0x27000100);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AV_SEP_CTRL, 0, 31, 0x3F3934EA);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_COMP_FLT_CTRL, 0, 31,\n\t\t\t\t\t   0x00000000);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_PHASE_INC, 0, 31,\n\t\t\t\t\t   0x1befbf06);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_GAIN_CONTROL, 0, 31,\n\t\t\t\t\t   0x000035e8);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_RPT_VARIANCE, 0, 31, 0x00000000);\n\t\t \n\t\tdif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\n\t\tdif_misc_ctrl_value |= 0x3a023F11;\n\t} else if (standard & V4L2_STD_PAL_I) {\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL, 0, 31, 0x6503bc0c);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL1, 0, 31, 0xbd038c85);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL2, 0, 31, 0x1db4640a);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL3, 0, 31, 0x00008800);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_REF, 0, 31, 0x444C1380);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_IF, 0, 31, 0xDA302600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_INT, 0, 31, 0xDA261700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_RF, 0, 31, 0xDA262600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_INT_CURRENT, 0, 31,\n\t\t\t\t\t   0x26001700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_RF_CURRENT, 0, 31,\n\t\t\t\t\t   0x00002660);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VIDEO_AGC_CTRL, 0, 31,\n\t\t\t\t\t   0x72500800);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VID_AUD_OVERRIDE, 0, 31,\n\t\t\t\t\t   0x27000100);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AV_SEP_CTRL, 0, 31, 0x5F39A934);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_COMP_FLT_CTRL, 0, 31,\n\t\t\t\t\t   0x00000000);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_PHASE_INC, 0, 31,\n\t\t\t\t\t   0x1befbf06);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_GAIN_CONTROL, 0, 31,\n\t\t\t\t\t   0x000035e8);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_RPT_VARIANCE, 0, 31, 0x00000000);\n\t\t \n\t\tdif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\n\t\tdif_misc_ctrl_value |= 0x3a033F11;\n\t} else if (standard & V4L2_STD_PAL_M) {\n\t\t \n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL, 0xFF01FF0C);\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL1, 0xbd038c85);\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL2, 0x1db4640a);\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL3, 0x00008800);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, 0x444C1380);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_IF_INT_CURRENT,\n\t\t\t\t\t\t0x26001700);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_RF_CURRENT,\n\t\t\t\t\t\t0x00002660);\n\t\tstatus = vid_blk_write_word(dev, DIF_VIDEO_AGC_CTRL,\n\t\t\t\t\t\t0x72500800);\n\t\tstatus = vid_blk_write_word(dev, DIF_VID_AUD_OVERRIDE,\n\t\t\t\t\t\t0x27000100);\n\t\tstatus = vid_blk_write_word(dev, DIF_AV_SEP_CTRL, 0x012c405d);\n\t\tstatus = vid_blk_write_word(dev, DIF_COMP_FLT_CTRL,\n\t\t\t\t\t\t0x009f50c1);\n\t\tstatus = vid_blk_write_word(dev, DIF_SRC_PHASE_INC,\n\t\t\t\t\t\t0x1befbf06);\n\t\tstatus = vid_blk_write_word(dev, DIF_SRC_GAIN_CONTROL,\n\t\t\t\t\t\t0x000035e8);\n\t\tstatus = vid_blk_write_word(dev, DIF_SOFT_RST_CTRL_REVB,\n\t\t\t\t\t\t0x00000000);\n\t\t \n\t\tdif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\n\t\tdif_misc_ctrl_value |= 0x3A0A3F10;\n\t} else if (standard & (V4L2_STD_PAL_N | V4L2_STD_PAL_Nc)) {\n\t\t \n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL, 0xFF01FF0C);\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL1, 0xbd038c85);\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL2, 0x1db4640a);\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL3, 0x00008800);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, 0x444C1380);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_IF_INT_CURRENT,\n\t\t\t\t\t\t0x26001700);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_RF_CURRENT,\n\t\t\t\t\t\t0x00002660);\n\t\tstatus = vid_blk_write_word(dev, DIF_VIDEO_AGC_CTRL,\n\t\t\t\t\t\t0x72500800);\n\t\tstatus = vid_blk_write_word(dev, DIF_VID_AUD_OVERRIDE,\n\t\t\t\t\t\t0x27000100);\n\t\tstatus = vid_blk_write_word(dev, DIF_AV_SEP_CTRL,\n\t\t\t\t\t\t0x012c405d);\n\t\tstatus = vid_blk_write_word(dev, DIF_COMP_FLT_CTRL,\n\t\t\t\t\t\t0x009f50c1);\n\t\tstatus = vid_blk_write_word(dev, DIF_SRC_PHASE_INC,\n\t\t\t\t\t\t0x1befbf06);\n\t\tstatus = vid_blk_write_word(dev, DIF_SRC_GAIN_CONTROL,\n\t\t\t\t\t\t0x000035e8);\n\t\tstatus = vid_blk_write_word(dev, DIF_SOFT_RST_CTRL_REVB,\n\t\t\t\t\t\t0x00000000);\n\t\t \n\t\tdif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\n\t\tdif_misc_ctrl_value = 0x3A093F10;\n\t} else if (standard &\n\t\t  (V4L2_STD_SECAM_B | V4L2_STD_SECAM_D | V4L2_STD_SECAM_G |\n\t\t   V4L2_STD_SECAM_K | V4L2_STD_SECAM_K1)) {\n\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL, 0, 31, 0x6503bc0c);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL1, 0, 31, 0xbd038c85);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL2, 0, 31, 0x1db4640a);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL3, 0, 31, 0x00008800);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_REF, 0, 31, 0x888C0380);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_IF, 0, 31, 0xe0262600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_INT, 0, 31, 0xc2171700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_RF, 0, 31, 0xc2262600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_INT_CURRENT, 0, 31,\n\t\t\t\t\t   0x26001700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_RF_CURRENT, 0, 31,\n\t\t\t\t\t   0x00002660);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VID_AUD_OVERRIDE, 0, 31,\n\t\t\t\t\t   0x27000100);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AV_SEP_CTRL, 0, 31, 0x3F3530ec);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_COMP_FLT_CTRL, 0, 31,\n\t\t\t\t\t   0x00000000);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_PHASE_INC, 0, 31,\n\t\t\t\t\t   0x1befbf06);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_GAIN_CONTROL, 0, 31,\n\t\t\t\t\t   0x000035e8);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_RPT_VARIANCE, 0, 31, 0x00000000);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VIDEO_AGC_CTRL, 0, 31,\n\t\t\t\t\t   0xf4000000);\n\n\t\t \n\t\tdif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\n\t\tdif_misc_ctrl_value |= 0x3a023F11;\n\t} else if (standard & (V4L2_STD_SECAM_L | V4L2_STD_SECAM_LC)) {\n\t\t \n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL, 0, 31, 0x6503bc0c);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL1, 0, 31, 0xbd038c85);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL2, 0, 31, 0x1db4640a);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL3, 0, 31, 0x00008800);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_REF, 0, 31, 0x888C0380);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_IF, 0, 31, 0xe0262600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_INT, 0, 31, 0xc2171700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_RF, 0, 31, 0xc2262600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_INT_CURRENT, 0, 31,\n\t\t\t\t\t   0x26001700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_RF_CURRENT, 0, 31,\n\t\t\t\t\t   0x00002660);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VID_AUD_OVERRIDE, 0, 31,\n\t\t\t\t\t   0x27000100);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AV_SEP_CTRL, 0, 31, 0x3F3530ec);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_COMP_FLT_CTRL, 0, 31,\n\t\t\t\t\t   0x00000000);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_PHASE_INC, 0, 31,\n\t\t\t\t\t   0x1befbf06);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_GAIN_CONTROL, 0, 31,\n\t\t\t\t\t   0x000035e8);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_RPT_VARIANCE, 0, 31, 0x00000000);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VIDEO_AGC_CTRL, 0, 31,\n\t\t\t\t\t   0xf2560000);\n\n\t\t \n\t\tdif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\n\t\tdif_misc_ctrl_value |= 0x3a023F11;\n\n\t} else if (standard & V4L2_STD_NTSC_M) {\n\t\t \n\n\t\t \n\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL, 0x6503BC0C);\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL1, 0xBD038C85);\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL2, 0x1DB4640A);\n\t\tstatus = vid_blk_write_word(dev, DIF_PLL_CTRL3, 0x00008800);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, 0x444C0380);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_IF_INT_CURRENT,\n\t\t\t\t\t\t0x26001700);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_RF_CURRENT,\n\t\t\t\t\t\t0x00002660);\n\t\tstatus = vid_blk_write_word(dev, DIF_VIDEO_AGC_CTRL,\n\t\t\t\t\t\t0x04000800);\n\t\tstatus = vid_blk_write_word(dev, DIF_VID_AUD_OVERRIDE,\n\t\t\t\t\t\t0x27000100);\n\t\tstatus = vid_blk_write_word(dev, DIF_AV_SEP_CTRL, 0x01296e1f);\n\n\t\tstatus = vid_blk_write_word(dev, DIF_COMP_FLT_CTRL,\n\t\t\t\t\t\t0x009f50c1);\n\t\tstatus = vid_blk_write_word(dev, DIF_SRC_PHASE_INC,\n\t\t\t\t\t\t0x1befbf06);\n\t\tstatus = vid_blk_write_word(dev, DIF_SRC_GAIN_CONTROL,\n\t\t\t\t\t\t0x000035e8);\n\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_CTRL_IF, 0xC2262600);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_CTRL_INT,\n\t\t\t\t\t\t0xC2262600);\n\t\tstatus = vid_blk_write_word(dev, DIF_AGC_CTRL_RF, 0xC2262600);\n\n\t\t \n\t\tdif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\n\t\tdif_misc_ctrl_value |= 0x3a003F10;\n\t} else {\n\t\t \n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL, 0, 31, 0x6503bc0c);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL1, 0, 31, 0xbd038c85);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL2, 0, 31, 0x1db4640a);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_PLL_CTRL3, 0, 31, 0x00008800);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_REF, 0, 31, 0x444C1380);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_IF, 0, 31, 0xDA302600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_INT, 0, 31, 0xDA261700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_CTRL_RF, 0, 31, 0xDA262600);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_IF_INT_CURRENT, 0, 31,\n\t\t\t\t\t   0x26001700);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AGC_RF_CURRENT, 0, 31,\n\t\t\t\t\t   0x00002660);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VIDEO_AGC_CTRL, 0, 31,\n\t\t\t\t\t   0x72500800);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_VID_AUD_OVERRIDE, 0, 31,\n\t\t\t\t\t   0x27000100);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_AV_SEP_CTRL, 0, 31, 0x3F3530EC);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_COMP_FLT_CTRL, 0, 31,\n\t\t\t\t\t   0x00A653A8);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_PHASE_INC, 0, 31,\n\t\t\t\t\t   0x1befbf06);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_SRC_GAIN_CONTROL, 0, 31,\n\t\t\t\t\t   0x000035e8);\n\t\tstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\n\t\t\t\t\t   DIF_RPT_VARIANCE, 0, 31, 0x00000000);\n\t\t \n\t\tdif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\n\t\tdif_misc_ctrl_value |= 0x3a013F11;\n\t}\n\n\t \n\tdif_misc_ctrl_value &= ~FLD_DIF_AUD_SRC_SEL;\n\n\t \n\tif (dev->active_mode == V4L2_TUNER_RADIO)\n\t\tdif_misc_ctrl_value = 0x7a080000;\n\n\t \n\tstatus = vid_blk_write_word(dev, DIF_MISC_CTRL, dif_misc_ctrl_value);\n\n\treturn status;\n}\n\nint cx231xx_tuner_pre_channel_change(struct cx231xx *dev)\n{\n\tint status = 0;\n\tu32 dwval;\n\n\t \n\tstatus = vid_blk_read_word(dev, DIF_AGC_IF_REF, &dwval);\n\tdwval &= ~(FLD_DIF_K_AGC_RF | FLD_DIF_K_AGC_IF);\n\tdwval |= 0x33000000;\n\n\tstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, dwval);\n\n\treturn status;\n}\n\nint cx231xx_tuner_post_channel_change(struct cx231xx *dev)\n{\n\tint status = 0;\n\tu32 dwval;\n\tdev_dbg(dev->dev, \"%s: dev->tuner_type =0%d\\n\",\n\t\t__func__, dev->tuner_type);\n\t \n\tstatus = vid_blk_read_word(dev, DIF_AGC_IF_REF, &dwval);\n\tdwval &= ~(FLD_DIF_K_AGC_RF | FLD_DIF_K_AGC_IF);\n\n\tif (dev->norm & (V4L2_STD_SECAM_L | V4L2_STD_SECAM_B |\n\t\t\t V4L2_STD_SECAM_D)) {\n\t\t\tif (dev->tuner_type == TUNER_NXP_TDA18271) {\n\t\t\t\tdwval &= ~FLD_DIF_IF_REF;\n\t\t\t\tdwval |= 0x88000300;\n\t\t\t} else\n\t\t\t\tdwval |= 0x88000000;\n\t\t} else {\n\t\t\tif (dev->tuner_type == TUNER_NXP_TDA18271) {\n\t\t\t\tdwval &= ~FLD_DIF_IF_REF;\n\t\t\t\tdwval |= 0xCC000300;\n\t\t\t} else\n\t\t\t\tdwval |= 0x44000000;\n\t\t}\n\n\tstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, dwval);\n\n\treturn status == sizeof(dwval) ? 0 : -EIO;\n}\n\n \nint cx231xx_i2s_blk_initialize(struct cx231xx *dev)\n{\n\tint status = 0;\n\tu32 value;\n\n\tstatus = cx231xx_read_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\n\t\t\t\t       CH_PWR_CTRL1, 1, &value, 1);\n\t \n\tvalue |= 0x80;\n\tstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\n\t\t\t\t\tCH_PWR_CTRL1, 1, value, 1);\n\t \n\tstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\n\t\t\t\t\tCH_PWR_CTRL2, 1, 0x00, 1);\n\n\treturn status;\n}\n\nint cx231xx_i2s_blk_update_power_control(struct cx231xx *dev,\n\t\t\t\t\tenum AV_MODE avmode)\n{\n\tint status = 0;\n\tu32 value = 0;\n\n\tif (avmode != POLARIS_AVMODE_ENXTERNAL_AV) {\n\t\tstatus = cx231xx_read_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\n\t\t\t\t\t  CH_PWR_CTRL2, 1, &value, 1);\n\t\tvalue |= 0xfe;\n\t\tstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\n\t\t\t\t\t\tCH_PWR_CTRL2, 1, value, 1);\n\t} else {\n\t\tstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\n\t\t\t\t\t\tCH_PWR_CTRL2, 1, 0x00, 1);\n\t}\n\n\treturn status;\n}\n\n \nint cx231xx_i2s_blk_set_audio_input(struct cx231xx *dev, u8 audio_input)\n{\n\tint status = 0;\n\n\tswitch (audio_input) {\n\tcase CX231XX_AMUX_LINE_IN:\n\t\tstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\n\t\t\t\t\t\tCH_PWR_CTRL2, 1, 0x00, 1);\n\t\tstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\n\t\t\t\t\t\tCH_PWR_CTRL1, 1, 0x80, 1);\n\t\tbreak;\n\tcase CX231XX_AMUX_VIDEO:\n\tdefault:\n\t\tbreak;\n\t}\n\n\tdev->ctl_ainput = audio_input;\n\n\treturn status;\n}\n\n \nint cx231xx_set_power_mode(struct cx231xx *dev, enum AV_MODE mode)\n{\n\tu8 value[4] = { 0, 0, 0, 0 };\n\tu32 tmp = 0;\n\tint status = 0;\n\n\tif (dev->power_mode != mode)\n\t\tdev->power_mode = mode;\n\telse {\n\t\tdev_dbg(dev->dev, \"%s: mode = %d, No Change req.\\n\",\n\t\t\t __func__, mode);\n\t\treturn 0;\n\t}\n\n\tstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, PWR_CTL_EN, value,\n\t\t\t\t       4);\n\tif (status < 0)\n\t\treturn status;\n\n\ttmp = le32_to_cpu(*((__le32 *) value));\n\n\tswitch (mode) {\n\tcase POLARIS_AVMODE_ENXTERNAL_AV:\n\n\t\ttmp &= (~PWR_MODE_MASK);\n\n\t\ttmp |= PWR_AV_EN;\n\t\tvalue[0] = (u8) tmp;\n\t\tvalue[1] = (u8) (tmp >> 8);\n\t\tvalue[2] = (u8) (tmp >> 16);\n\t\tvalue[3] = (u8) (tmp >> 24);\n\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\tmsleep(PWR_SLEEP_INTERVAL);\n\n\t\ttmp |= PWR_ISO_EN;\n\t\tvalue[0] = (u8) tmp;\n\t\tvalue[1] = (u8) (tmp >> 8);\n\t\tvalue[2] = (u8) (tmp >> 16);\n\t\tvalue[3] = (u8) (tmp >> 24);\n\t\tstatus =\n\t\t    cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER, PWR_CTL_EN,\n\t\t\t\t\t   value, 4);\n\t\tmsleep(PWR_SLEEP_INTERVAL);\n\n\t\ttmp |= POLARIS_AVMODE_ENXTERNAL_AV;\n\t\tvalue[0] = (u8) tmp;\n\t\tvalue[1] = (u8) (tmp >> 8);\n\t\tvalue[2] = (u8) (tmp >> 16);\n\t\tvalue[3] = (u8) (tmp >> 24);\n\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\n\t\t \n\t\tdev->xc_fw_load_done = 0;\n\t\tbreak;\n\n\tcase POLARIS_AVMODE_ANALOGT_TV:\n\n\t\ttmp |= PWR_DEMOD_EN;\n\t\tvalue[0] = (u8) tmp;\n\t\tvalue[1] = (u8) (tmp >> 8);\n\t\tvalue[2] = (u8) (tmp >> 16);\n\t\tvalue[3] = (u8) (tmp >> 24);\n\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\tmsleep(PWR_SLEEP_INTERVAL);\n\n\t\tif (!(tmp & PWR_TUNER_EN)) {\n\t\t\ttmp |= (PWR_TUNER_EN);\n\t\t\tvalue[0] = (u8) tmp;\n\t\t\tvalue[1] = (u8) (tmp >> 8);\n\t\t\tvalue[2] = (u8) (tmp >> 16);\n\t\t\tvalue[3] = (u8) (tmp >> 24);\n\t\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\t\tmsleep(PWR_SLEEP_INTERVAL);\n\t\t}\n\n\t\tif (!(tmp & PWR_AV_EN)) {\n\t\t\ttmp |= PWR_AV_EN;\n\t\t\tvalue[0] = (u8) tmp;\n\t\t\tvalue[1] = (u8) (tmp >> 8);\n\t\t\tvalue[2] = (u8) (tmp >> 16);\n\t\t\tvalue[3] = (u8) (tmp >> 24);\n\t\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\t\tmsleep(PWR_SLEEP_INTERVAL);\n\t\t}\n\t\tif (!(tmp & PWR_ISO_EN)) {\n\t\t\ttmp |= PWR_ISO_EN;\n\t\t\tvalue[0] = (u8) tmp;\n\t\t\tvalue[1] = (u8) (tmp >> 8);\n\t\t\tvalue[2] = (u8) (tmp >> 16);\n\t\t\tvalue[3] = (u8) (tmp >> 24);\n\t\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\t\tmsleep(PWR_SLEEP_INTERVAL);\n\t\t}\n\n\t\tif (!(tmp & POLARIS_AVMODE_ANALOGT_TV)) {\n\t\t\ttmp |= POLARIS_AVMODE_ANALOGT_TV;\n\t\t\tvalue[0] = (u8) tmp;\n\t\t\tvalue[1] = (u8) (tmp >> 8);\n\t\t\tvalue[2] = (u8) (tmp >> 16);\n\t\t\tvalue[3] = (u8) (tmp >> 24);\n\t\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\t\tmsleep(PWR_SLEEP_INTERVAL);\n\t\t}\n\n\t\tif (dev->board.tuner_type != TUNER_ABSENT) {\n\t\t\t \n\t\t\tif (dev->board.tuner_gpio)\n\t\t\t\tcx231xx_gpio_set(dev, dev->board.tuner_gpio);\n\n\t\t\tif (dev->cx231xx_reset_analog_tuner)\n\t\t\t\tdev->cx231xx_reset_analog_tuner(dev);\n\t\t}\n\n\t\tbreak;\n\n\tcase POLARIS_AVMODE_DIGITAL:\n\t\tif (!(tmp & PWR_TUNER_EN)) {\n\t\t\ttmp |= (PWR_TUNER_EN);\n\t\t\tvalue[0] = (u8) tmp;\n\t\t\tvalue[1] = (u8) (tmp >> 8);\n\t\t\tvalue[2] = (u8) (tmp >> 16);\n\t\t\tvalue[3] = (u8) (tmp >> 24);\n\t\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\t\tmsleep(PWR_SLEEP_INTERVAL);\n\t\t}\n\t\tif (!(tmp & PWR_AV_EN)) {\n\t\t\ttmp |= PWR_AV_EN;\n\t\t\tvalue[0] = (u8) tmp;\n\t\t\tvalue[1] = (u8) (tmp >> 8);\n\t\t\tvalue[2] = (u8) (tmp >> 16);\n\t\t\tvalue[3] = (u8) (tmp >> 24);\n\t\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\t\tmsleep(PWR_SLEEP_INTERVAL);\n\t\t}\n\t\tif (!(tmp & PWR_ISO_EN)) {\n\t\t\ttmp |= PWR_ISO_EN;\n\t\t\tvalue[0] = (u8) tmp;\n\t\t\tvalue[1] = (u8) (tmp >> 8);\n\t\t\tvalue[2] = (u8) (tmp >> 16);\n\t\t\tvalue[3] = (u8) (tmp >> 24);\n\t\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\t\tmsleep(PWR_SLEEP_INTERVAL);\n\t\t}\n\n\t\ttmp &= (~PWR_AV_MODE);\n\t\ttmp |= POLARIS_AVMODE_DIGITAL;\n\t\tvalue[0] = (u8) tmp;\n\t\tvalue[1] = (u8) (tmp >> 8);\n\t\tvalue[2] = (u8) (tmp >> 16);\n\t\tvalue[3] = (u8) (tmp >> 24);\n\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\tmsleep(PWR_SLEEP_INTERVAL);\n\n\t\tif (!(tmp & PWR_DEMOD_EN)) {\n\t\t\ttmp |= PWR_DEMOD_EN;\n\t\t\tvalue[0] = (u8) tmp;\n\t\t\tvalue[1] = (u8) (tmp >> 8);\n\t\t\tvalue[2] = (u8) (tmp >> 16);\n\t\t\tvalue[3] = (u8) (tmp >> 24);\n\t\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\t\tmsleep(PWR_SLEEP_INTERVAL);\n\t\t}\n\n\t\tif (dev->board.tuner_type != TUNER_ABSENT) {\n\t\t\t \n\t\t\tif (dev->board.tuner_gpio)\n\t\t\t\tcx231xx_gpio_set(dev, dev->board.tuner_gpio);\n\n\t\t\tif (dev->cx231xx_reset_analog_tuner)\n\t\t\t\tdev->cx231xx_reset_analog_tuner(dev);\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tmsleep(PWR_SLEEP_INTERVAL);\n\n\t \n\tif (mode == POLARIS_AVMODE_DIGITAL) {\n\t\ttmp |= PWR_RESETOUT_EN;\n\t\tvalue[0] = (u8) tmp;\n\t\tvalue[1] = (u8) (tmp >> 8);\n\t\tvalue[2] = (u8) (tmp >> 16);\n\t\tvalue[3] = (u8) (tmp >> 24);\n\t\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\n\t\t\t\t\t\tPWR_CTL_EN, value, 4);\n\t\tmsleep(PWR_SLEEP_INTERVAL);\n\t}\n\n\t \n\tstatus = cx231xx_afe_update_power_control(dev, mode);\n\n\t \n\tstatus = cx231xx_i2s_blk_update_power_control(dev, mode);\n\n\tstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, PWR_CTL_EN, value,\n\t\t\t\t       4);\n\n\treturn status;\n}\n\nint cx231xx_power_suspend(struct cx231xx *dev)\n{\n\tu8 value[4] = { 0, 0, 0, 0 };\n\tu32 tmp = 0;\n\tint status = 0;\n\n\tstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, PWR_CTL_EN,\n\t\t\t\t       value, 4);\n\tif (status > 0)\n\t\treturn status;\n\n\ttmp = le32_to_cpu(*((__le32 *) value));\n\ttmp &= (~PWR_MODE_MASK);\n\n\tvalue[0] = (u8) tmp;\n\tvalue[1] = (u8) (tmp >> 8);\n\tvalue[2] = (u8) (tmp >> 16);\n\tvalue[3] = (u8) (tmp >> 24);\n\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER, PWR_CTL_EN,\n\t\t\t\t\tvalue, 4);\n\n\treturn status;\n}\n\n \nint cx231xx_start_stream(struct cx231xx *dev, u32 ep_mask)\n{\n\tu8 value[4] = { 0x0, 0x0, 0x0, 0x0 };\n\tu32 tmp = 0;\n\tint status = 0;\n\n\tdev_dbg(dev->dev, \"%s: ep_mask = %x\\n\", __func__, ep_mask);\n\tstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, EP_MODE_SET,\n\t\t\t\t       value, 4);\n\tif (status < 0)\n\t\treturn status;\n\n\ttmp = le32_to_cpu(*((__le32 *) value));\n\ttmp |= ep_mask;\n\tvalue[0] = (u8) tmp;\n\tvalue[1] = (u8) (tmp >> 8);\n\tvalue[2] = (u8) (tmp >> 16);\n\tvalue[3] = (u8) (tmp >> 24);\n\n\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER, EP_MODE_SET,\n\t\t\t\t\tvalue, 4);\n\n\treturn status;\n}\n\nint cx231xx_stop_stream(struct cx231xx *dev, u32 ep_mask)\n{\n\tu8 value[4] = { 0x0, 0x0, 0x0, 0x0 };\n\tu32 tmp = 0;\n\tint status = 0;\n\n\tdev_dbg(dev->dev, \"%s: ep_mask = %x\\n\", __func__, ep_mask);\n\tstatus =\n\t    cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, EP_MODE_SET, value, 4);\n\tif (status < 0)\n\t\treturn status;\n\n\ttmp = le32_to_cpu(*((__le32 *) value));\n\ttmp &= (~ep_mask);\n\tvalue[0] = (u8) tmp;\n\tvalue[1] = (u8) (tmp >> 8);\n\tvalue[2] = (u8) (tmp >> 16);\n\tvalue[3] = (u8) (tmp >> 24);\n\n\tstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER, EP_MODE_SET,\n\t\t\t\t\tvalue, 4);\n\n\treturn status;\n}\n\nint cx231xx_initialize_stream_xfer(struct cx231xx *dev, u32 media_type)\n{\n\tint status = 0;\n\tu32 value = 0;\n\tu8 val[4] = { 0, 0, 0, 0 };\n\n\tif (dev->udev->speed == USB_SPEED_HIGH) {\n\t\tswitch (media_type) {\n\t\tcase Audio:\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"%s: Audio enter HANC\\n\", __func__);\n\t\t\tstatus =\n\t\t\t    cx231xx_mode_register(dev, TS_MODE_REG, 0x9300);\n\t\t\tbreak;\n\n\t\tcase Vbi:\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"%s: set vanc registers\\n\", __func__);\n\t\t\tstatus = cx231xx_mode_register(dev, TS_MODE_REG, 0x300);\n\t\t\tbreak;\n\n\t\tcase Sliced_cc:\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"%s: set hanc registers\\n\", __func__);\n\t\t\tstatus =\n\t\t\t    cx231xx_mode_register(dev, TS_MODE_REG, 0x1300);\n\t\t\tbreak;\n\n\t\tcase Raw_Video:\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"%s: set video registers\\n\", __func__);\n\t\t\tstatus = cx231xx_mode_register(dev, TS_MODE_REG, 0x100);\n\t\t\tbreak;\n\n\t\tcase TS1_serial_mode:\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"%s: set ts1 registers\", __func__);\n\n\t\t\tif (dev->board.has_417) {\n\t\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\t\"%s: MPEG\\n\", __func__);\n\t\t\t\tvalue &= 0xFFFFFFFC;\n\t\t\t\tvalue |= 0x3;\n\n\t\t\t\tstatus = cx231xx_mode_register(dev,\n\t\t\t\t\t\t\t TS_MODE_REG, value);\n\n\t\t\t\tval[0] = 0x04;\n\t\t\t\tval[1] = 0xA3;\n\t\t\t\tval[2] = 0x3B;\n\t\t\t\tval[3] = 0x00;\n\t\t\t\tstatus = cx231xx_write_ctrl_reg(dev,\n\t\t\t\t\t\t\tVRT_SET_REGISTER,\n\t\t\t\t\t\t\tTS1_CFG_REG, val, 4);\n\n\t\t\t\tval[0] = 0x00;\n\t\t\t\tval[1] = 0x08;\n\t\t\t\tval[2] = 0x00;\n\t\t\t\tval[3] = 0x08;\n\t\t\t\tstatus = cx231xx_write_ctrl_reg(dev,\n\t\t\t\t\t\t\tVRT_SET_REGISTER,\n\t\t\t\t\t\t\tTS1_LENGTH_REG, val, 4);\n\t\t\t} else {\n\t\t\t\tdev_dbg(dev->dev, \"%s: BDA\\n\", __func__);\n\t\t\t\tstatus = cx231xx_mode_register(dev,\n\t\t\t\t\t\t\t TS_MODE_REG, 0x101);\n\t\t\t\tstatus = cx231xx_mode_register(dev,\n\t\t\t\t\t\t\tTS1_CFG_REG, 0x010);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase TS1_parallel_mode:\n\t\t\tdev_dbg(dev->dev,\n\t\t\t\t\"%s: set ts1 parallel mode registers\\n\",\n\t\t\t\t__func__);\n\t\t\tstatus = cx231xx_mode_register(dev, TS_MODE_REG, 0x100);\n\t\t\tstatus = cx231xx_mode_register(dev, TS1_CFG_REG, 0x400);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tstatus = cx231xx_mode_register(dev, TS_MODE_REG, 0x101);\n\t}\n\n\treturn status;\n}\n\nint cx231xx_capture_start(struct cx231xx *dev, int start, u8 media_type)\n{\n\tint rc = -1;\n\tu32 ep_mask = -1;\n\tstruct pcb_config *pcb_config;\n\n\t \n\tpcb_config = (struct pcb_config *)&dev->current_pcb_config;\n\n\tif (pcb_config->config_num) {\n\t\tswitch (media_type) {\n\t\tcase Raw_Video:\n\t\t\tep_mask = ENABLE_EP4;\t \n\t\t\tbreak;\n\t\tcase Audio:\n\t\t\tep_mask = ENABLE_EP3;\t \n\t\t\tbreak;\n\t\tcase Vbi:\n\t\t\tep_mask = ENABLE_EP5;\t \n\t\t\tbreak;\n\t\tcase Sliced_cc:\n\t\t\tep_mask = ENABLE_EP6;\t \n\t\t\tbreak;\n\t\tcase TS1_serial_mode:\n\t\tcase TS1_parallel_mode:\n\t\t\tep_mask = ENABLE_EP1;\t \n\t\t\tbreak;\n\t\tcase TS2:\n\t\t\tep_mask = ENABLE_EP2;\t \n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (start) {\n\t\trc = cx231xx_initialize_stream_xfer(dev, media_type);\n\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\t \n\t\tif (ep_mask > 0)\n\t\t\trc = cx231xx_start_stream(dev, ep_mask);\n\t} else {\n\t\t \n\t\tif (ep_mask > 0)\n\t\t\trc = cx231xx_stop_stream(dev, ep_mask);\n\t}\n\n\treturn rc;\n}\nEXPORT_SYMBOL_GPL(cx231xx_capture_start);\n\n \nstatic int cx231xx_set_gpio_bit(struct cx231xx *dev, u32 gpio_bit, u32 gpio_val)\n{\n\tint status = 0;\n\n\tgpio_val = (__force u32)cpu_to_le32(gpio_val);\n\tstatus = cx231xx_send_gpio_cmd(dev, gpio_bit, (u8 *)&gpio_val, 4, 0, 0);\n\n\treturn status;\n}\n\nstatic int cx231xx_get_gpio_bit(struct cx231xx *dev, u32 gpio_bit, u32 *gpio_val)\n{\n\t__le32 tmp;\n\tint status = 0;\n\n\tstatus = cx231xx_send_gpio_cmd(dev, gpio_bit, (u8 *)&tmp, 4, 0, 1);\n\t*gpio_val = le32_to_cpu(tmp);\n\n\treturn status;\n}\n\n \nint cx231xx_set_gpio_direction(struct cx231xx *dev,\n\t\t\t       int pin_number, int pin_value)\n{\n\tint status = 0;\n\tu32 value = 0;\n\n\t \n\tif (pin_number >= 32)\n\t\treturn -EINVAL;\n\n\t \n\tif (pin_value == 0)\n\t\tvalue = dev->gpio_dir & (~(1 << pin_number));\t \n\telse\n\t\tvalue = dev->gpio_dir | (1 << pin_number);\n\n\tstatus = cx231xx_set_gpio_bit(dev, value, dev->gpio_val);\n\n\t \n\tdev->gpio_dir = value;\n\n\treturn status;\n}\n\n \nint cx231xx_set_gpio_value(struct cx231xx *dev, int pin_number, int pin_value)\n{\n\tint status = 0;\n\tu32 value = 0;\n\n\t \n\tif (pin_number >= 32)\n\t\treturn -EINVAL;\n\n\t \n\tif ((dev->gpio_dir & (1 << pin_number)) == 0x00) {\n\t\t \n\t\tvalue = dev->gpio_dir | (1 << pin_number);\n\t\tdev->gpio_dir = value;\n\t\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t      dev->gpio_val);\n\t\tvalue = 0;\n\t}\n\n\tif (pin_value == 0)\n\t\tvalue = dev->gpio_val & (~(1 << pin_number));\n\telse\n\t\tvalue = dev->gpio_val | (1 << pin_number);\n\n\t \n\tdev->gpio_val = value;\n\n\t \n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\treturn status;\n}\n\n \nint cx231xx_gpio_i2c_start(struct cx231xx *dev)\n{\n\tint status = 0;\n\n\t \n\tdev->gpio_dir |= 1 << dev->board.tuner_scl_gpio;\n\tdev->gpio_dir |= 1 << dev->board.tuner_sda_gpio;\n\tdev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\n\tdev->gpio_val |= 1 << dev->board.tuner_sda_gpio;\n\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\tif (status < 0)\n\t\treturn -EINVAL;\n\n\t \n\tdev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\n\tdev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\n\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\tif (status < 0)\n\t\treturn -EINVAL;\n\n\t \n\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\tdev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\n\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\tif (status < 0)\n\t\treturn -EINVAL;\n\n\treturn status;\n}\n\nint cx231xx_gpio_i2c_end(struct cx231xx *dev)\n{\n\tint status = 0;\n\n\t \n\tdev->gpio_dir |= 1 << dev->board.tuner_scl_gpio;\n\tdev->gpio_dir |= 1 << dev->board.tuner_sda_gpio;\n\n\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\tdev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\n\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\tif (status < 0)\n\t\treturn -EINVAL;\n\n\t \n\tdev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\n\tdev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\n\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\tif (status < 0)\n\t\treturn -EINVAL;\n\n\t \n\tdev->gpio_dir &= ~(1 << dev->board.tuner_scl_gpio);\n\tdev->gpio_dir &= ~(1 << dev->board.tuner_sda_gpio);\n\n\tstatus =\n\t    cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\tif (status < 0)\n\t\treturn -EINVAL;\n\n\treturn status;\n}\n\nint cx231xx_gpio_i2c_write_byte(struct cx231xx *dev, u8 data)\n{\n\tint status = 0;\n\tu8 i;\n\n\t \n\tdev->gpio_dir |= 1 << dev->board.tuner_scl_gpio;\n\tdev->gpio_dir |= 1 << dev->board.tuner_sda_gpio;\n\n\tfor (i = 0; i < 8; i++) {\n\t\tif (((data << i) & 0x80) == 0) {\n\t\t\t \n\t\t\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\t\t\tdev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\n\t\t\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t\t      dev->gpio_val);\n\n\t\t\t \n\t\t\tdev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\n\t\t\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t\t      dev->gpio_val);\n\n\t\t\t \n\t\t\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\t\t\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t\t      dev->gpio_val);\n\t\t} else {\n\t\t\t \n\t\t\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\t\t\tdev->gpio_val |= 1 << dev->board.tuner_sda_gpio;\n\t\t\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t\t      dev->gpio_val);\n\n\t\t\t \n\t\t\tdev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\n\t\t\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t\t      dev->gpio_val);\n\n\t\t\t \n\t\t\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\t\t\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t\t      dev->gpio_val);\n\t\t}\n\t}\n\treturn status;\n}\n\nint cx231xx_gpio_i2c_read_byte(struct cx231xx *dev, u8 *buf)\n{\n\tu8 value = 0;\n\tint status = 0;\n\tu32 gpio_logic_value = 0;\n\tu8 i;\n\n\t \n\tfor (i = 0; i < 8; i++) {\t \n\n\t\t \n\t\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\t\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t      dev->gpio_val);\n\n\t\t \n\t\tdev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\n\t\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t      dev->gpio_val);\n\n\t\t \n\t\tgpio_logic_value = dev->gpio_val;\n\t\tstatus = cx231xx_get_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t      &dev->gpio_val);\n\t\tif ((dev->gpio_val & (1 << dev->board.tuner_sda_gpio)) != 0)\n\t\t\tvalue |= (1 << (8 - i - 1));\n\n\t\tdev->gpio_val = gpio_logic_value;\n\t}\n\n\t \n\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\t \n\t*buf = value & 0xff;\n\n\treturn status;\n}\n\nint cx231xx_gpio_i2c_read_ack(struct cx231xx *dev)\n{\n\tint status = 0;\n\tu32 gpio_logic_value = 0;\n\tint nCnt = 10;\n\tint nInit = nCnt;\n\n\t \n\tdev->gpio_dir &= ~(1 << dev->board.tuner_sda_gpio);\n\tdev->gpio_dir &= ~(1 << dev->board.tuner_scl_gpio);\n\n\tgpio_logic_value = dev->gpio_val;\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\tdo {\n\t\tmsleep(2);\n\t\tstatus = cx231xx_get_gpio_bit(dev, dev->gpio_dir,\n\t\t\t\t\t      &dev->gpio_val);\n\t\tnCnt--;\n\t} while (((dev->gpio_val &\n\t\t\t  (1 << dev->board.tuner_scl_gpio)) == 0) &&\n\t\t\t (nCnt > 0));\n\n\tif (nCnt == 0)\n\t\tdev_dbg(dev->dev,\n\t\t\t\"No ACK after %d msec -GPIO I2C failed!\",\n\t\t\tnInit * 10);\n\n\t \n\tstatus = cx231xx_get_gpio_bit(dev, dev->gpio_dir, &dev->gpio_val);\n\n\tif ((dev->gpio_val & 1 << dev->board.tuner_sda_gpio) == 0) {\n\t\tdev->gpio_val = gpio_logic_value;\n\t\tdev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\n\t\tstatus = 0;\n\t} else {\n\t\tdev->gpio_val = gpio_logic_value;\n\t\tdev->gpio_val |= (1 << dev->board.tuner_sda_gpio);\n\t}\n\n\t \n\tdev->gpio_val = gpio_logic_value;\n\tdev->gpio_dir |= (1 << dev->board.tuner_scl_gpio);\n\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\treturn status;\n}\n\nint cx231xx_gpio_i2c_write_ack(struct cx231xx *dev)\n{\n\tint status = 0;\n\n\t \n\tdev->gpio_dir |= 1 << dev->board.tuner_sda_gpio;\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\t \n\tdev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\n\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\t \n\tdev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\t \n\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\t \n\tdev->gpio_dir &= ~(1 << dev->board.tuner_sda_gpio);\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\treturn status;\n}\n\nint cx231xx_gpio_i2c_write_nak(struct cx231xx *dev)\n{\n\tint status = 0;\n\n\t \n\tdev->gpio_dir |= 1 << dev->board.tuner_scl_gpio;\n\tdev->gpio_dir &= ~(1 << dev->board.tuner_sda_gpio);\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\t \n\tdev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\t \n\tdev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\n\tstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, dev->gpio_val);\n\n\treturn status;\n}\n\n \n \nint cx231xx_gpio_i2c_read(struct cx231xx *dev, u8 dev_addr, u8 *buf, u8 len)\n{\n\tint status = 0;\n\tint i = 0;\n\n\t \n\tmutex_lock(&dev->gpio_i2c_lock);\n\n\t \n\tstatus = cx231xx_gpio_i2c_start(dev);\n\n\t \n\tstatus = cx231xx_gpio_i2c_write_byte(dev, (dev_addr << 1) + 1);\n\n\t \n\tstatus = cx231xx_gpio_i2c_read_ack(dev);\n\n\t \n\tfor (i = 0; i < len; i++) {\n\t\t \n\t\tbuf[i] = 0;\n\t\tstatus = cx231xx_gpio_i2c_read_byte(dev, &buf[i]);\n\n\t\tif ((i + 1) != len) {\n\t\t\t \n\t\t\tstatus = cx231xx_gpio_i2c_write_ack(dev);\n\t\t}\n\t}\n\n\t \n\tstatus = cx231xx_gpio_i2c_write_nak(dev);\n\n\t \n\tstatus = cx231xx_gpio_i2c_end(dev);\n\n\t \n\tmutex_unlock(&dev->gpio_i2c_lock);\n\n\treturn status;\n}\n\n \nint cx231xx_gpio_i2c_write(struct cx231xx *dev, u8 dev_addr, u8 *buf, u8 len)\n{\n\tint i = 0;\n\n\t \n\tmutex_lock(&dev->gpio_i2c_lock);\n\n\t \n\tcx231xx_gpio_i2c_start(dev);\n\n\t \n\tcx231xx_gpio_i2c_write_byte(dev, dev_addr << 1);\n\n\t \n\tcx231xx_gpio_i2c_read_ack(dev);\n\n\tfor (i = 0; i < len; i++) {\n\t\t \n\t\tcx231xx_gpio_i2c_write_byte(dev, buf[i]);\n\n\t\t \n\t\tcx231xx_gpio_i2c_read_ack(dev);\n\t}\n\n\t \n\tcx231xx_gpio_i2c_end(dev);\n\n\t \n\tmutex_unlock(&dev->gpio_i2c_lock);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}