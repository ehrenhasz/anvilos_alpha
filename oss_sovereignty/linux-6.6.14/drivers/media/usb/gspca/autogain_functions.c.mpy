{
  "module_name": "autogain_functions.c",
  "hash_id": "ae76a96f4d3f771324e6cb361b2dc7f298c998d20741d03ceea79d7f9462af1b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/gspca/autogain_functions.c",
  "human_readable_source": "\n \n#include \"gspca.h\"\n\n \nint gspca_expo_autogain(\n\t\t\tstruct gspca_dev *gspca_dev,\n\t\t\tint avg_lum,\n\t\t\tint desired_avg_lum,\n\t\t\tint deadzone,\n\t\t\tint gain_knee,\n\t\t\tint exposure_knee)\n{\n\ts32 gain, orig_gain, exposure, orig_exposure;\n\tint i, steps, retval = 0;\n\n\tif (v4l2_ctrl_g_ctrl(gspca_dev->autogain) == 0)\n\t\treturn 0;\n\n\torig_gain = gain = v4l2_ctrl_g_ctrl(gspca_dev->gain);\n\torig_exposure = exposure = v4l2_ctrl_g_ctrl(gspca_dev->exposure);\n\n\t \n\tsteps = abs(desired_avg_lum - avg_lum) / deadzone;\n\n\tgspca_dbg(gspca_dev, D_FRAM, \"autogain: lum: %d, desired: %d, steps: %d\\n\",\n\t\t  avg_lum, desired_avg_lum, steps);\n\n\tfor (i = 0; i < steps; i++) {\n\t\tif (avg_lum > desired_avg_lum) {\n\t\t\tif (gain > gain_knee)\n\t\t\t\tgain--;\n\t\t\telse if (exposure > exposure_knee)\n\t\t\t\texposure--;\n\t\t\telse if (gain > gspca_dev->gain->default_value)\n\t\t\t\tgain--;\n\t\t\telse if (exposure > gspca_dev->exposure->minimum)\n\t\t\t\texposure--;\n\t\t\telse if (gain > gspca_dev->gain->minimum)\n\t\t\t\tgain--;\n\t\t\telse\n\t\t\t\tbreak;\n\t\t} else {\n\t\t\tif (gain < gspca_dev->gain->default_value)\n\t\t\t\tgain++;\n\t\t\telse if (exposure < exposure_knee)\n\t\t\t\texposure++;\n\t\t\telse if (gain < gain_knee)\n\t\t\t\tgain++;\n\t\t\telse if (exposure < gspca_dev->exposure->maximum)\n\t\t\t\texposure++;\n\t\t\telse if (gain < gspca_dev->gain->maximum)\n\t\t\t\tgain++;\n\t\t\telse\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (gain != orig_gain) {\n\t\tv4l2_ctrl_s_ctrl(gspca_dev->gain, gain);\n\t\tretval = 1;\n\t}\n\tif (exposure != orig_exposure) {\n\t\tv4l2_ctrl_s_ctrl(gspca_dev->exposure, exposure);\n\t\tretval = 1;\n\t}\n\n\tif (retval)\n\t\tgspca_dbg(gspca_dev, D_FRAM, \"autogain: changed gain: %d, expo: %d\\n\",\n\t\t\t  gain, exposure);\n\treturn retval;\n}\nEXPORT_SYMBOL(gspca_expo_autogain);\n\n \nint gspca_coarse_grained_expo_autogain(\n\t\t\tstruct gspca_dev *gspca_dev,\n\t\t\tint avg_lum,\n\t\t\tint desired_avg_lum,\n\t\t\tint deadzone)\n{\n\ts32 gain_low, gain_high, gain, orig_gain, exposure, orig_exposure;\n\tint steps, retval = 0;\n\n\tif (v4l2_ctrl_g_ctrl(gspca_dev->autogain) == 0)\n\t\treturn 0;\n\n\torig_gain = gain = v4l2_ctrl_g_ctrl(gspca_dev->gain);\n\torig_exposure = exposure = v4l2_ctrl_g_ctrl(gspca_dev->exposure);\n\n\tgain_low  = (s32)(gspca_dev->gain->maximum - gspca_dev->gain->minimum) /\n\t\t    5 * 2 + gspca_dev->gain->minimum;\n\tgain_high = (s32)(gspca_dev->gain->maximum - gspca_dev->gain->minimum) /\n\t\t    5 * 4 + gspca_dev->gain->minimum;\n\n\t \n\tsteps = (desired_avg_lum - avg_lum) / deadzone;\n\n\tgspca_dbg(gspca_dev, D_FRAM, \"autogain: lum: %d, desired: %d, steps: %d\\n\",\n\t\t  avg_lum, desired_avg_lum, steps);\n\n\tif ((gain + steps) > gain_high &&\n\t    exposure < gspca_dev->exposure->maximum) {\n\t\tgain = gain_high;\n\t\tgspca_dev->exp_too_low_cnt++;\n\t\tgspca_dev->exp_too_high_cnt = 0;\n\t} else if ((gain + steps) < gain_low &&\n\t\t   exposure > gspca_dev->exposure->minimum) {\n\t\tgain = gain_low;\n\t\tgspca_dev->exp_too_high_cnt++;\n\t\tgspca_dev->exp_too_low_cnt = 0;\n\t} else {\n\t\tgain += steps;\n\t\tif (gain > gspca_dev->gain->maximum)\n\t\t\tgain = gspca_dev->gain->maximum;\n\t\telse if (gain < gspca_dev->gain->minimum)\n\t\t\tgain = gspca_dev->gain->minimum;\n\t\tgspca_dev->exp_too_high_cnt = 0;\n\t\tgspca_dev->exp_too_low_cnt = 0;\n\t}\n\n\tif (gspca_dev->exp_too_high_cnt > 3) {\n\t\texposure--;\n\t\tgspca_dev->exp_too_high_cnt = 0;\n\t} else if (gspca_dev->exp_too_low_cnt > 3) {\n\t\texposure++;\n\t\tgspca_dev->exp_too_low_cnt = 0;\n\t}\n\n\tif (gain != orig_gain) {\n\t\tv4l2_ctrl_s_ctrl(gspca_dev->gain, gain);\n\t\tretval = 1;\n\t}\n\tif (exposure != orig_exposure) {\n\t\tv4l2_ctrl_s_ctrl(gspca_dev->exposure, exposure);\n\t\tretval = 1;\n\t}\n\n\tif (retval)\n\t\tgspca_dbg(gspca_dev, D_FRAM, \"autogain: changed gain: %d, expo: %d\\n\",\n\t\t\t  gain, exposure);\n\treturn retval;\n}\nEXPORT_SYMBOL(gspca_coarse_grained_expo_autogain);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}