{
  "module_name": "m5602_s5k4aa.c",
  "hash_id": "ceb94c12903bf450471a17e939a59a4d48fa6136e631b7f71e5e14942e2f7f8c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/gspca/m5602/m5602_s5k4aa.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include \"m5602_s5k4aa.h\"\n\nstatic const unsigned char preinit_s5k4aa[][4] = {\n\t{BRIDGE, M5602_XB_MCU_CLK_DIV, 0x02, 0x00},\n\t{BRIDGE, M5602_XB_MCU_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_ADC_CTRL, 0xc0, 0x00},\n\t{BRIDGE, M5602_XB_SENSOR_TYPE, 0x0d, 0x00},\n\t{BRIDGE, M5602_XB_SENSOR_CTRL, 0x00, 0x00},\n\n\t{BRIDGE, M5602_XB_GPIO_DIR, 0x1d, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT, 0x08, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0x80, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_EN_H, 0x3f, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR_H, 0x3f, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT_H, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR, 0x1d, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_EN_L, 0xff, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR_L, 0xff, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT_L, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_ADC_CTRL, 0xc0, 0x00},\n\t{BRIDGE, M5602_XB_SENSOR_TYPE, 0x08, 0x00},\n\n\t{BRIDGE, M5602_XB_MCU_CLK_DIV, 0x02, 0x00},\n\t{BRIDGE, M5602_XB_MCU_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR, 0x1d, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT, 0x14, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xf0, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR, 0x1d, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT, 0x1c, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_EN_H, 0x06, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR_H, 0x06, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT_H, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_EN_L, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_I2C_CLK_DIV, 0x20, 0x00},\n\n\t{SENSOR, S5K4AA_PAGE_MAP, 0x00, 0x00}\n};\n\nstatic const unsigned char init_s5k4aa[][4] = {\n\t{BRIDGE, M5602_XB_MCU_CLK_DIV, 0x02, 0x00},\n\t{BRIDGE, M5602_XB_MCU_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_ADC_CTRL, 0xc0, 0x00},\n\t{BRIDGE, M5602_XB_SENSOR_TYPE, 0x0d, 0x00},\n\t{BRIDGE, M5602_XB_SENSOR_CTRL, 0x00, 0x00},\n\n\t{BRIDGE, M5602_XB_GPIO_DIR, 0x1d, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT, 0x08, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0x80, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_EN_H, 0x3f, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR_H, 0x3f, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT_H, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR, 0x1d, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_EN_L, 0xff, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR_L, 0xff, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT_L, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_ADC_CTRL, 0xc0, 0x00},\n\t{BRIDGE, M5602_XB_SENSOR_TYPE, 0x08, 0x00},\n\n\t{BRIDGE, M5602_XB_MCU_CLK_DIV, 0x02, 0x00},\n\t{BRIDGE, M5602_XB_MCU_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR, 0x1d, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT, 0x14, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xf0, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR, 0x1d, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT, 0x1c, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_EN_H, 0x06, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DIR_H, 0x06, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_DAT_H, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_GPIO_EN_L, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_I2C_CLK_DIV, 0x20, 0x00},\n\n\t{SENSOR, S5K4AA_PAGE_MAP, 0x07, 0x00},\n\t{SENSOR, 0x36, 0x01, 0x00},\n\t{SENSOR, S5K4AA_PAGE_MAP, 0x00, 0x00},\n\t{SENSOR, 0x7b, 0xff, 0x00},\n\t{SENSOR, S5K4AA_PAGE_MAP, 0x02, 0x00},\n\t{SENSOR, 0x0c, 0x05, 0x00},\n\t{SENSOR, 0x02, 0x0e, 0x00},\n\t{SENSOR, S5K4AA_READ_MODE, 0xa0, 0x00},\n\t{SENSOR, 0x37, 0x00, 0x00},\n};\n\nstatic const unsigned char VGA_s5k4aa[][4] = {\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x06, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_ADC_CTRL, 0xc0, 0x00},\n\t{BRIDGE, M5602_XB_SENSOR_TYPE, 0x08, 0x00},\n\t{BRIDGE, M5602_XB_LINE_OF_FRAME_H, 0x81, 0x00},\n\t{BRIDGE, M5602_XB_PIX_OF_LINE_H, 0x82, 0x00},\n\t{BRIDGE, M5602_XB_SIG_INI, 0x01, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t \n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x01, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0xe0, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SIG_INI, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SIG_INI, 0x02, 0x00},\n\t{BRIDGE, M5602_XB_HSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_HSYNC_PARA, 0x00, 0x00},\n\t \n\t{BRIDGE, M5602_XB_HSYNC_PARA, 0x02, 0x00},\n\t{BRIDGE, M5602_XB_HSYNC_PARA, 0x80, 0x00},\n\t{BRIDGE, M5602_XB_SIG_INI, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xa0, 0x00},  \n\n\t{SENSOR, S5K4AA_PAGE_MAP, 0x02, 0x00},\n\t{SENSOR, S5K4AA_READ_MODE, S5K4AA_RM_H_FLIP | S5K4AA_RM_ROW_SKIP_2X\n\t\t| S5K4AA_RM_COL_SKIP_2X, 0x00},\n\t \n\t{SENSOR, 0x37, 0x01, 0x00},\n\t \n\t{SENSOR, S5K4AA_ROWSTART_HI, 0x00, 0x00},\n\t{SENSOR, S5K4AA_ROWSTART_LO, 0x29, 0x00},\n\t{SENSOR, S5K4AA_COLSTART_HI, 0x00, 0x00},\n\t{SENSOR, S5K4AA_COLSTART_LO, 0x0c, 0x00},\n\t \n\t{SENSOR, S5K4AA_WINDOW_HEIGHT_HI, 0x03, 0x00},\n\t{SENSOR, S5K4AA_WINDOW_HEIGHT_LO, 0xc0, 0x00},\n\t \n\t{SENSOR, S5K4AA_WINDOW_WIDTH_HI, 0x05, 0x00},\n\t{SENSOR, S5K4AA_WINDOW_WIDTH_LO, 0x00, 0x00},\n\t{SENSOR, S5K4AA_H_BLANK_HI__, 0x00, 0x00},\n\t{SENSOR, S5K4AA_H_BLANK_LO__, 0xa8, 0x00},  \n\t{SENSOR, S5K4AA_EXPOSURE_HI, 0x01, 0x00},\n\t{SENSOR, S5K4AA_EXPOSURE_LO, 0x00, 0x00},\n\t{SENSOR, 0x11, 0x04, 0x00},\n\t{SENSOR, 0x12, 0xc3, 0x00},\n\t{SENSOR, S5K4AA_PAGE_MAP, 0x02, 0x00},\n\t{SENSOR, 0x02, 0x0e, 0x00},\n};\n\nstatic const unsigned char SXGA_s5k4aa[][4] = {\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x06, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xb0, 0x00},\n\t{BRIDGE, M5602_XB_ADC_CTRL, 0xc0, 0x00},\n\t{BRIDGE, M5602_XB_SENSOR_TYPE, 0x08, 0x00},\n\t{BRIDGE, M5602_XB_LINE_OF_FRAME_H, 0x81, 0x00},\n\t{BRIDGE, M5602_XB_PIX_OF_LINE_H, 0x82, 0x00},\n\t{BRIDGE, M5602_XB_SIG_INI, 0x01, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t \n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x04, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_VSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SIG_INI, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SIG_INI, 0x02, 0x00},\n\t{BRIDGE, M5602_XB_HSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_HSYNC_PARA, 0x00, 0x00},\n\t \n\t{BRIDGE, M5602_XB_HSYNC_PARA, 0x05, 0x00},\n\t{BRIDGE, M5602_XB_HSYNC_PARA, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SIG_INI, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_DIV, 0x00, 0x00},\n\t{BRIDGE, M5602_XB_SEN_CLK_CTRL, 0xa0, 0x00},  \n\n\t{SENSOR, S5K4AA_PAGE_MAP, 0x02, 0x00},\n\t{SENSOR, S5K4AA_READ_MODE, S5K4AA_RM_H_FLIP, 0x00},\n\t{SENSOR, 0x37, 0x01, 0x00},\n\t{SENSOR, S5K4AA_ROWSTART_HI, 0x00, 0x00},\n\t{SENSOR, S5K4AA_ROWSTART_LO, 0x09, 0x00},\n\t{SENSOR, S5K4AA_COLSTART_HI, 0x00, 0x00},\n\t{SENSOR, S5K4AA_COLSTART_LO, 0x0a, 0x00},\n\t{SENSOR, S5K4AA_WINDOW_HEIGHT_HI, 0x04, 0x00},\n\t{SENSOR, S5K4AA_WINDOW_HEIGHT_LO, 0x00, 0x00},\n\t{SENSOR, S5K4AA_WINDOW_WIDTH_HI, 0x05, 0x00},\n\t{SENSOR, S5K4AA_WINDOW_WIDTH_LO, 0x00, 0x00},\n\t{SENSOR, S5K4AA_H_BLANK_HI__, 0x01, 0x00},\n\t{SENSOR, S5K4AA_H_BLANK_LO__, 0xa8, 0x00},\n\t{SENSOR, S5K4AA_EXPOSURE_HI, 0x01, 0x00},\n\t{SENSOR, S5K4AA_EXPOSURE_LO, 0x00, 0x00},\n\t{SENSOR, 0x11, 0x04, 0x00},\n\t{SENSOR, 0x12, 0xc3, 0x00},\n\t{SENSOR, S5K4AA_PAGE_MAP, 0x02, 0x00},\n\t{SENSOR, 0x02, 0x0e, 0x00},\n};\n\n\nstatic int s5k4aa_s_ctrl(struct v4l2_ctrl *ctrl);\nstatic void s5k4aa_dump_registers(struct sd *sd);\n\nstatic const struct v4l2_ctrl_ops s5k4aa_ctrl_ops = {\n\t.s_ctrl = s5k4aa_s_ctrl,\n};\n\nstatic\n    const\n\tstruct dmi_system_id s5k4aa_vflip_dmi_table[] = {\n\t{\n\t\t.ident = \"BRUNEINIT\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"BRUNENIT\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"BRUNENIT\"),\n\t\t\tDMI_MATCH(DMI_BOARD_VERSION, \"00030D0000000001\")\n\t\t}\n\t}, {\n\t\t.ident = \"Fujitsu-Siemens Amilo Xa 2528\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"FUJITSU SIEMENS\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"AMILO Xa 2528\")\n\t\t}\n\t}, {\n\t\t.ident = \"Fujitsu-Siemens Amilo Xi 2428\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"FUJITSU SIEMENS\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"AMILO Xi 2428\")\n\t\t}\n\t}, {\n\t\t.ident = \"Fujitsu-Siemens Amilo Xi 2528\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"FUJITSU SIEMENS\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"AMILO Xi 2528\")\n\t\t}\n\t}, {\n\t\t.ident = \"Fujitsu-Siemens Amilo Xi 2550\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"FUJITSU SIEMENS\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"AMILO Xi 2550\")\n\t\t}\n\t}, {\n\t\t.ident = \"Fujitsu-Siemens Amilo Pa 2548\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"FUJITSU SIEMENS\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"AMILO Pa 2548\")\n\t\t}\n\t}, {\n\t\t.ident = \"Fujitsu-Siemens Amilo Pi 2530\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"FUJITSU SIEMENS\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"AMILO Pi 2530\")\n\t\t}\n\t}, {\n\t\t.ident = \"MSI GX700\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Micro-Star International\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"GX700\"),\n\t\t\tDMI_MATCH(DMI_BIOS_DATE, \"12/02/2008\")\n\t\t}\n\t}, {\n\t\t.ident = \"MSI GX700\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Micro-Star International\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"GX700\"),\n\t\t\tDMI_MATCH(DMI_BIOS_DATE, \"07/26/2007\")\n\t\t}\n\t}, {\n\t\t.ident = \"MSI GX700\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Micro-Star International\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"GX700\"),\n\t\t\tDMI_MATCH(DMI_BIOS_DATE, \"07/19/2007\")\n\t\t}\n\t}, {\n\t\t.ident = \"MSI GX700/GX705/EX700\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Micro-Star International\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"GX700/GX705/EX700\")\n\t\t}\n\t}, {\n\t\t.ident = \"MSI L735\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Micro-Star International\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"MS-1717X\")\n\t\t}\n\t}, {\n\t\t.ident = \"Lenovo Y300\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"L3000 Y300\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Y300\")\n\t\t}\n\t},\n\t{ }\n};\n\nstatic struct v4l2_pix_format s5k4aa_modes[] = {\n\t{\n\t\t640,\n\t\t480,\n\t\tV4L2_PIX_FMT_SBGGR8,\n\t\tV4L2_FIELD_NONE,\n\t\t.sizeimage =\n\t\t\t640 * 480,\n\t\t.bytesperline = 640,\n\t\t.colorspace = V4L2_COLORSPACE_SRGB,\n\t\t.priv = 0\n\t},\n\t{\n\t\t1280,\n\t\t1024,\n\t\tV4L2_PIX_FMT_SBGGR8,\n\t\tV4L2_FIELD_NONE,\n\t\t.sizeimage =\n\t\t\t1280 * 1024,\n\t\t.bytesperline = 1280,\n\t\t.colorspace = V4L2_COLORSPACE_SRGB,\n\t\t.priv = 0\n\t}\n};\n\nint s5k4aa_probe(struct sd *sd)\n{\n\tu8 prod_id[6] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00};\n\tconst u8 expected_prod_id[6] = {0x00, 0x10, 0x00, 0x4b, 0x33, 0x75};\n\tstruct gspca_dev *gspca_dev = (struct gspca_dev *)sd;\n\tint i, err = 0;\n\n\tif (force_sensor) {\n\t\tif (force_sensor == S5K4AA_SENSOR) {\n\t\t\tpr_info(\"Forcing a %s sensor\\n\", s5k4aa.name);\n\t\t\tgoto sensor_found;\n\t\t}\n\t\t \n\t\treturn -ENODEV;\n\t}\n\n\tgspca_dbg(gspca_dev, D_PROBE, \"Probing for a s5k4aa sensor\\n\");\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(preinit_s5k4aa) && !err; i++) {\n\t\tu8 data[2] = {0x00, 0x00};\n\n\t\tswitch (preinit_s5k4aa[i][0]) {\n\t\tcase BRIDGE:\n\t\t\terr = m5602_write_bridge(sd,\n\t\t\t\t\t\t preinit_s5k4aa[i][1],\n\t\t\t\t\t\t preinit_s5k4aa[i][2]);\n\t\t\tbreak;\n\n\t\tcase SENSOR:\n\t\t\tdata[0] = preinit_s5k4aa[i][2];\n\t\t\terr = m5602_write_sensor(sd,\n\t\t\t\t\t\t  preinit_s5k4aa[i][1],\n\t\t\t\t\t\t  data, 1);\n\t\t\tbreak;\n\n\t\tcase SENSOR_LONG:\n\t\t\tdata[0] = preinit_s5k4aa[i][2];\n\t\t\tdata[1] = preinit_s5k4aa[i][3];\n\t\t\terr = m5602_write_sensor(sd,\n\t\t\t\t\t\t  preinit_s5k4aa[i][1],\n\t\t\t\t\t\t  data, 2);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpr_info(\"Invalid stream command, exiting init\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\t \n\tif (m5602_read_sensor(sd, 0x00, prod_id, 2))\n\t\treturn -ENODEV;\n\tif (m5602_read_sensor(sd, 0x02, prod_id+2, 2))\n\t\treturn -ENODEV;\n\tif (m5602_read_sensor(sd, 0x04, prod_id+4, 2))\n\t\treturn -ENODEV;\n\n\tif (memcmp(prod_id, expected_prod_id, sizeof(prod_id)))\n\t\treturn -ENODEV;\n\telse\n\t\tpr_info(\"Detected a s5k4aa sensor\\n\");\n\nsensor_found:\n\tsd->gspca_dev.cam.cam_mode = s5k4aa_modes;\n\tsd->gspca_dev.cam.nmodes = ARRAY_SIZE(s5k4aa_modes);\n\n\treturn 0;\n}\n\nint s5k4aa_start(struct sd *sd)\n{\n\tint i, err = 0;\n\tu8 data[2];\n\tstruct cam *cam = &sd->gspca_dev.cam;\n\tstruct gspca_dev *gspca_dev = (struct gspca_dev *)sd;\n\n\tswitch (cam->cam_mode[sd->gspca_dev.curr_mode].width) {\n\tcase 1280:\n\t\tgspca_dbg(gspca_dev, D_CONF, \"Configuring camera for SXGA mode\\n\");\n\n\t\tfor (i = 0; i < ARRAY_SIZE(SXGA_s5k4aa); i++) {\n\t\t\tswitch (SXGA_s5k4aa[i][0]) {\n\t\t\tcase BRIDGE:\n\t\t\t\terr = m5602_write_bridge(sd,\n\t\t\t\t\t\t SXGA_s5k4aa[i][1],\n\t\t\t\t\t\t SXGA_s5k4aa[i][2]);\n\t\t\tbreak;\n\n\t\t\tcase SENSOR:\n\t\t\t\tdata[0] = SXGA_s5k4aa[i][2];\n\t\t\t\terr = m5602_write_sensor(sd,\n\t\t\t\t\t\t SXGA_s5k4aa[i][1],\n\t\t\t\t\t\t data, 1);\n\t\t\tbreak;\n\n\t\t\tcase SENSOR_LONG:\n\t\t\t\tdata[0] = SXGA_s5k4aa[i][2];\n\t\t\t\tdata[1] = SXGA_s5k4aa[i][3];\n\t\t\t\terr = m5602_write_sensor(sd,\n\t\t\t\t\t\t  SXGA_s5k4aa[i][1],\n\t\t\t\t\t\t  data, 2);\n\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tpr_err(\"Invalid stream command, exiting init\\n\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tcase 640:\n\t\tgspca_dbg(gspca_dev, D_CONF, \"Configuring camera for VGA mode\\n\");\n\n\t\tfor (i = 0; i < ARRAY_SIZE(VGA_s5k4aa); i++) {\n\t\t\tswitch (VGA_s5k4aa[i][0]) {\n\t\t\tcase BRIDGE:\n\t\t\t\terr = m5602_write_bridge(sd,\n\t\t\t\t\t\t VGA_s5k4aa[i][1],\n\t\t\t\t\t\t VGA_s5k4aa[i][2]);\n\t\t\tbreak;\n\n\t\t\tcase SENSOR:\n\t\t\t\tdata[0] = VGA_s5k4aa[i][2];\n\t\t\t\terr = m5602_write_sensor(sd,\n\t\t\t\t\t\t VGA_s5k4aa[i][1],\n\t\t\t\t\t\t data, 1);\n\t\t\tbreak;\n\n\t\t\tcase SENSOR_LONG:\n\t\t\t\tdata[0] = VGA_s5k4aa[i][2];\n\t\t\t\tdata[1] = VGA_s5k4aa[i][3];\n\t\t\t\terr = m5602_write_sensor(sd,\n\t\t\t\t\t\t  VGA_s5k4aa[i][1],\n\t\t\t\t\t\t  data, 2);\n\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tpr_err(\"Invalid stream command, exiting init\\n\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\t}\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\nint s5k4aa_init(struct sd *sd)\n{\n\tint i, err = 0;\n\n\tfor (i = 0; i < ARRAY_SIZE(init_s5k4aa) && !err; i++) {\n\t\tu8 data[2] = {0x00, 0x00};\n\n\t\tswitch (init_s5k4aa[i][0]) {\n\t\tcase BRIDGE:\n\t\t\terr = m5602_write_bridge(sd,\n\t\t\t\tinit_s5k4aa[i][1],\n\t\t\t\tinit_s5k4aa[i][2]);\n\t\t\tbreak;\n\n\t\tcase SENSOR:\n\t\t\tdata[0] = init_s5k4aa[i][2];\n\t\t\terr = m5602_write_sensor(sd,\n\t\t\t\tinit_s5k4aa[i][1], data, 1);\n\t\t\tbreak;\n\n\t\tcase SENSOR_LONG:\n\t\t\tdata[0] = init_s5k4aa[i][2];\n\t\t\tdata[1] = init_s5k4aa[i][3];\n\t\t\terr = m5602_write_sensor(sd,\n\t\t\t\tinit_s5k4aa[i][1], data, 2);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpr_info(\"Invalid stream command, exiting init\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tif (dump_sensor)\n\t\ts5k4aa_dump_registers(sd);\n\n\treturn err;\n}\n\nint s5k4aa_init_controls(struct sd *sd)\n{\n\tstruct v4l2_ctrl_handler *hdl = &sd->gspca_dev.ctrl_handler;\n\n\tsd->gspca_dev.vdev.ctrl_handler = hdl;\n\tv4l2_ctrl_handler_init(hdl, 6);\n\n\tv4l2_ctrl_new_std(hdl, &s5k4aa_ctrl_ops, V4L2_CID_BRIGHTNESS,\n\t\t\t  0, 0x1f, 1, S5K4AA_DEFAULT_BRIGHTNESS);\n\n\tv4l2_ctrl_new_std(hdl, &s5k4aa_ctrl_ops, V4L2_CID_EXPOSURE,\n\t\t\t  13, 0xfff, 1, 0x100);\n\n\tv4l2_ctrl_new_std(hdl, &s5k4aa_ctrl_ops, V4L2_CID_GAIN,\n\t\t\t  0, 127, 1, S5K4AA_DEFAULT_GAIN);\n\n\tv4l2_ctrl_new_std(hdl, &s5k4aa_ctrl_ops, V4L2_CID_SHARPNESS,\n\t\t\t  0, 1, 1, 1);\n\n\tsd->hflip = v4l2_ctrl_new_std(hdl, &s5k4aa_ctrl_ops, V4L2_CID_HFLIP,\n\t\t\t\t      0, 1, 1, 0);\n\tsd->vflip = v4l2_ctrl_new_std(hdl, &s5k4aa_ctrl_ops, V4L2_CID_VFLIP,\n\t\t\t\t      0, 1, 1, 0);\n\n\tif (hdl->error) {\n\t\tpr_err(\"Could not initialize controls\\n\");\n\t\treturn hdl->error;\n\t}\n\n\tv4l2_ctrl_cluster(2, &sd->hflip);\n\n\treturn 0;\n}\n\nstatic int s5k4aa_set_exposure(struct gspca_dev *gspca_dev, __s32 val)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tu8 data = S5K4AA_PAGE_MAP_2;\n\tint err;\n\n\tgspca_dbg(gspca_dev, D_CONF, \"Set exposure to %d\\n\", val);\n\terr = m5602_write_sensor(sd, S5K4AA_PAGE_MAP, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\tdata = (val >> 8) & 0xff;\n\terr = m5602_write_sensor(sd, S5K4AA_EXPOSURE_HI, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\tdata = val & 0xff;\n\terr = m5602_write_sensor(sd, S5K4AA_EXPOSURE_LO, &data, 1);\n\n\treturn err;\n}\n\nstatic int s5k4aa_set_hvflip(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tu8 data = S5K4AA_PAGE_MAP_2;\n\tint err;\n\tint hflip = sd->hflip->val;\n\tint vflip = sd->vflip->val;\n\n\tgspca_dbg(gspca_dev, D_CONF, \"Set hvflip %d %d\\n\", hflip, vflip);\n\terr = m5602_write_sensor(sd, S5K4AA_PAGE_MAP, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = m5602_read_sensor(sd, S5K4AA_READ_MODE, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (dmi_check_system(s5k4aa_vflip_dmi_table)) {\n\t\thflip = !hflip;\n\t\tvflip = !vflip;\n\t}\n\n\tdata = (data & 0x7f) | (vflip << 7) | (hflip << 6);\n\terr = m5602_write_sensor(sd, S5K4AA_READ_MODE, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = m5602_read_sensor(sd, S5K4AA_COLSTART_LO, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\tif (hflip)\n\t\tdata &= 0xfe;\n\telse\n\t\tdata |= 0x01;\n\terr = m5602_write_sensor(sd, S5K4AA_COLSTART_LO, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = m5602_read_sensor(sd, S5K4AA_ROWSTART_LO, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\tif (vflip)\n\t\tdata &= 0xfe;\n\telse\n\t\tdata |= 0x01;\n\terr = m5602_write_sensor(sd, S5K4AA_ROWSTART_LO, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic int s5k4aa_set_gain(struct gspca_dev *gspca_dev, __s32 val)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tu8 data = S5K4AA_PAGE_MAP_2;\n\tint err;\n\n\tgspca_dbg(gspca_dev, D_CONF, \"Set gain to %d\\n\", val);\n\terr = m5602_write_sensor(sd, S5K4AA_PAGE_MAP, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\n\tdata = val & 0xff;\n\terr = m5602_write_sensor(sd, S5K4AA_GAIN, &data, 1);\n\n\treturn err;\n}\n\nstatic int s5k4aa_set_brightness(struct gspca_dev *gspca_dev, __s32 val)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tu8 data = S5K4AA_PAGE_MAP_2;\n\tint err;\n\n\tgspca_dbg(gspca_dev, D_CONF, \"Set brightness to %d\\n\", val);\n\terr = m5602_write_sensor(sd, S5K4AA_PAGE_MAP, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\n\tdata = val & 0xff;\n\treturn m5602_write_sensor(sd, S5K4AA_BRIGHTNESS, &data, 1);\n}\n\nstatic int s5k4aa_set_noise(struct gspca_dev *gspca_dev, __s32 val)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tu8 data = S5K4AA_PAGE_MAP_2;\n\tint err;\n\n\tgspca_dbg(gspca_dev, D_CONF, \"Set noise to %d\\n\", val);\n\terr = m5602_write_sensor(sd, S5K4AA_PAGE_MAP, &data, 1);\n\tif (err < 0)\n\t\treturn err;\n\n\tdata = val & 0x01;\n\treturn m5602_write_sensor(sd, S5K4AA_NOISE_SUPP, &data, 1);\n}\n\nstatic int s5k4aa_s_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct gspca_dev *gspca_dev =\n\t\tcontainer_of(ctrl->handler, struct gspca_dev, ctrl_handler);\n\tint err;\n\n\tif (!gspca_dev->streaming)\n\t\treturn 0;\n\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_BRIGHTNESS:\n\t\terr = s5k4aa_set_brightness(gspca_dev, ctrl->val);\n\t\tbreak;\n\tcase V4L2_CID_EXPOSURE:\n\t\terr = s5k4aa_set_exposure(gspca_dev, ctrl->val);\n\t\tbreak;\n\tcase V4L2_CID_GAIN:\n\t\terr = s5k4aa_set_gain(gspca_dev, ctrl->val);\n\t\tbreak;\n\tcase V4L2_CID_SHARPNESS:\n\t\terr = s5k4aa_set_noise(gspca_dev, ctrl->val);\n\t\tbreak;\n\tcase V4L2_CID_HFLIP:\n\t\terr = s5k4aa_set_hvflip(gspca_dev);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn err;\n}\n\nvoid s5k4aa_disconnect(struct sd *sd)\n{\n\tsd->sensor = NULL;\n}\n\nstatic void s5k4aa_dump_registers(struct sd *sd)\n{\n\tint address;\n\tu8 page, old_page;\n\tm5602_read_sensor(sd, S5K4AA_PAGE_MAP, &old_page, 1);\n\tfor (page = 0; page < 16; page++) {\n\t\tm5602_write_sensor(sd, S5K4AA_PAGE_MAP, &page, 1);\n\t\tpr_info(\"Dumping the s5k4aa register state for page 0x%x\\n\",\n\t\t\tpage);\n\t\tfor (address = 0; address <= 0xff; address++) {\n\t\t\tu8 value = 0;\n\t\t\tm5602_read_sensor(sd, address, &value, 1);\n\t\t\tpr_info(\"register 0x%x contains 0x%x\\n\",\n\t\t\t\taddress, value);\n\t\t}\n\t}\n\tpr_info(\"s5k4aa register state dump complete\\n\");\n\n\tfor (page = 0; page < 16; page++) {\n\t\tm5602_write_sensor(sd, S5K4AA_PAGE_MAP, &page, 1);\n\t\tpr_info(\"Probing for which registers that are read/write for page 0x%x\\n\",\n\t\t\tpage);\n\t\tfor (address = 0; address <= 0xff; address++) {\n\t\t\tu8 old_value, ctrl_value, test_value = 0xff;\n\n\t\t\tm5602_read_sensor(sd, address, &old_value, 1);\n\t\t\tm5602_write_sensor(sd, address, &test_value, 1);\n\t\t\tm5602_read_sensor(sd, address, &ctrl_value, 1);\n\n\t\t\tif (ctrl_value == test_value)\n\t\t\t\tpr_info(\"register 0x%x is writeable\\n\",\n\t\t\t\t\taddress);\n\t\t\telse\n\t\t\t\tpr_info(\"register 0x%x is read only\\n\",\n\t\t\t\t\taddress);\n\n\t\t\t \n\t\t\tm5602_write_sensor(sd, address, &old_value, 1);\n\t\t}\n\t}\n\tpr_info(\"Read/write register probing complete\\n\");\n\tm5602_write_sensor(sd, S5K4AA_PAGE_MAP, &old_page, 1);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}