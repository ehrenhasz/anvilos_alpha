{
  "module_name": "cpia1.c",
  "hash_id": "cace068eac9fd6ef2fe4c7ab21963b9fe35a24afc4945510b0d71c74b0d35c88",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/gspca/cpia1.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#define MODULE_NAME \"cpia1\"\n\n#include <linux/input.h>\n#include <linux/sched/signal.h>\n#include <linux/bitops.h>\n\n#include \"gspca.h\"\n\nMODULE_AUTHOR(\"Hans de Goede <hdegoede@redhat.com>\");\nMODULE_DESCRIPTION(\"Vision CPiA\");\nMODULE_LICENSE(\"GPL\");\n\n \n#define MAGIC_0\t\t0x19\n#define MAGIC_1\t\t0x68\n#define DATA_IN\t\t0xc0\n#define DATA_OUT\t0x40\n#define VIDEOSIZE_QCIF\t0\t \n#define VIDEOSIZE_CIF\t1\t \n#define SUBSAMPLE_420\t0\n#define SUBSAMPLE_422\t1\n#define YUVORDER_YUYV\t0\n#define YUVORDER_UYVY\t1\n#define NOT_COMPRESSED\t0\n#define COMPRESSED\t1\n#define NO_DECIMATION\t0\n#define DECIMATION_ENAB\t1\n#define EOI\t\t0xff\t \n#define EOL\t\t0xfd\t \n#define FRAME_HEADER_SIZE\t64\n\n \n#define CPIA_GRAB_SINGLE\t0\n#define CPIA_GRAB_CONTINEOUS\t1\n\n \n#define CPIA_COMPRESSION_NONE\t0\n#define CPIA_COMPRESSION_AUTO\t1\n#define CPIA_COMPRESSION_MANUAL\t2\n#define CPIA_COMPRESSION_TARGET_QUALITY         0\n#define CPIA_COMPRESSION_TARGET_FRAMERATE       1\n\n \n#define SYSTEMSTATE\t0\n#define GRABSTATE\t1\n#define STREAMSTATE\t2\n#define FATALERROR\t3\n#define CMDERROR\t4\n#define DEBUGFLAGS\t5\n#define VPSTATUS\t6\n#define ERRORCODE\t7\n\n \n#define UNINITIALISED_STATE\t0\n#define PASS_THROUGH_STATE\t1\n#define LO_POWER_STATE\t\t2\n#define HI_POWER_STATE\t\t3\n#define WARM_BOOT_STATE\t\t4\n\n \n#define GRAB_IDLE\t\t0\n#define GRAB_ACTIVE\t\t1\n#define GRAB_DONE\t\t2\n\n \n#define STREAM_NOT_READY\t0\n#define STREAM_READY\t\t1\n#define STREAM_OPEN\t\t2\n#define STREAM_PAUSED\t\t3\n#define STREAM_FINISHED\t\t4\n\n \n#define CPIA_FLAG\t  1\n#define SYSTEM_FLAG\t  2\n#define INT_CTRL_FLAG\t  4\n#define PROCESS_FLAG\t  8\n#define COM_FLAG\t 16\n#define VP_CTRL_FLAG\t 32\n#define CAPTURE_FLAG\t 64\n#define DEBUG_FLAG\t128\n\n \n#define VP_STATE_OK\t\t\t0x00\n\n#define VP_STATE_FAILED_VIDEOINIT\t0x01\n#define VP_STATE_FAILED_AECACBINIT\t0x02\n#define VP_STATE_AEC_MAX\t\t0x04\n#define VP_STATE_ACB_BMAX\t\t0x08\n\n#define VP_STATE_ACB_RMIN\t\t0x10\n#define VP_STATE_ACB_GMIN\t\t0x20\n#define VP_STATE_ACB_RMAX\t\t0x40\n#define VP_STATE_ACB_GMAX\t\t0x80\n\n \n#define COMP_RED        220\n#define COMP_GREEN1     214\n#define COMP_GREEN2     COMP_GREEN1\n#define COMP_BLUE       230\n\n \n#define EXPOSURE_VERY_LIGHT 0\n#define EXPOSURE_LIGHT      1\n#define EXPOSURE_NORMAL     2\n#define EXPOSURE_DARK       3\n#define EXPOSURE_VERY_DARK  4\n\n#define CPIA_MODULE_CPIA\t\t\t(0 << 5)\n#define CPIA_MODULE_SYSTEM\t\t\t(1 << 5)\n#define CPIA_MODULE_VP_CTRL\t\t\t(5 << 5)\n#define CPIA_MODULE_CAPTURE\t\t\t(6 << 5)\n#define CPIA_MODULE_DEBUG\t\t\t(7 << 5)\n\n#define INPUT (DATA_IN << 8)\n#define OUTPUT (DATA_OUT << 8)\n\n#define CPIA_COMMAND_GetCPIAVersion\t(INPUT | CPIA_MODULE_CPIA | 1)\n#define CPIA_COMMAND_GetPnPID\t\t(INPUT | CPIA_MODULE_CPIA | 2)\n#define CPIA_COMMAND_GetCameraStatus\t(INPUT | CPIA_MODULE_CPIA | 3)\n#define CPIA_COMMAND_GotoHiPower\t(OUTPUT | CPIA_MODULE_CPIA | 4)\n#define CPIA_COMMAND_GotoLoPower\t(OUTPUT | CPIA_MODULE_CPIA | 5)\n#define CPIA_COMMAND_GotoSuspend\t(OUTPUT | CPIA_MODULE_CPIA | 7)\n#define CPIA_COMMAND_GotoPassThrough\t(OUTPUT | CPIA_MODULE_CPIA | 8)\n#define CPIA_COMMAND_ModifyCameraStatus\t(OUTPUT | CPIA_MODULE_CPIA | 10)\n\n#define CPIA_COMMAND_ReadVCRegs\t\t(INPUT | CPIA_MODULE_SYSTEM | 1)\n#define CPIA_COMMAND_WriteVCReg\t\t(OUTPUT | CPIA_MODULE_SYSTEM | 2)\n#define CPIA_COMMAND_ReadMCPorts\t(INPUT | CPIA_MODULE_SYSTEM | 3)\n#define CPIA_COMMAND_WriteMCPort\t(OUTPUT | CPIA_MODULE_SYSTEM | 4)\n#define CPIA_COMMAND_SetBaudRate\t(OUTPUT | CPIA_MODULE_SYSTEM | 5)\n#define CPIA_COMMAND_SetECPTiming\t(OUTPUT | CPIA_MODULE_SYSTEM | 6)\n#define CPIA_COMMAND_ReadIDATA\t\t(INPUT | CPIA_MODULE_SYSTEM | 7)\n#define CPIA_COMMAND_WriteIDATA\t\t(OUTPUT | CPIA_MODULE_SYSTEM | 8)\n#define CPIA_COMMAND_GenericCall\t(OUTPUT | CPIA_MODULE_SYSTEM | 9)\n#define CPIA_COMMAND_I2CStart\t\t(OUTPUT | CPIA_MODULE_SYSTEM | 10)\n#define CPIA_COMMAND_I2CStop\t\t(OUTPUT | CPIA_MODULE_SYSTEM | 11)\n#define CPIA_COMMAND_I2CWrite\t\t(OUTPUT | CPIA_MODULE_SYSTEM | 12)\n#define CPIA_COMMAND_I2CRead\t\t(INPUT | CPIA_MODULE_SYSTEM | 13)\n\n#define CPIA_COMMAND_GetVPVersion\t(INPUT | CPIA_MODULE_VP_CTRL | 1)\n#define CPIA_COMMAND_ResetFrameCounter\t(INPUT | CPIA_MODULE_VP_CTRL | 2)\n#define CPIA_COMMAND_SetColourParams\t(OUTPUT | CPIA_MODULE_VP_CTRL | 3)\n#define CPIA_COMMAND_SetExposure\t(OUTPUT | CPIA_MODULE_VP_CTRL | 4)\n#define CPIA_COMMAND_SetColourBalance\t(OUTPUT | CPIA_MODULE_VP_CTRL | 6)\n#define CPIA_COMMAND_SetSensorFPS\t(OUTPUT | CPIA_MODULE_VP_CTRL | 7)\n#define CPIA_COMMAND_SetVPDefaults\t(OUTPUT | CPIA_MODULE_VP_CTRL | 8)\n#define CPIA_COMMAND_SetApcor\t\t(OUTPUT | CPIA_MODULE_VP_CTRL | 9)\n#define CPIA_COMMAND_SetFlickerCtrl\t(OUTPUT | CPIA_MODULE_VP_CTRL | 10)\n#define CPIA_COMMAND_SetVLOffset\t(OUTPUT | CPIA_MODULE_VP_CTRL | 11)\n#define CPIA_COMMAND_GetColourParams\t(INPUT | CPIA_MODULE_VP_CTRL | 16)\n#define CPIA_COMMAND_GetColourBalance\t(INPUT | CPIA_MODULE_VP_CTRL | 17)\n#define CPIA_COMMAND_GetExposure\t(INPUT | CPIA_MODULE_VP_CTRL | 18)\n#define CPIA_COMMAND_SetSensorMatrix\t(OUTPUT | CPIA_MODULE_VP_CTRL | 19)\n#define CPIA_COMMAND_ColourBars\t\t(OUTPUT | CPIA_MODULE_VP_CTRL | 25)\n#define CPIA_COMMAND_ReadVPRegs\t\t(INPUT | CPIA_MODULE_VP_CTRL | 30)\n#define CPIA_COMMAND_WriteVPReg\t\t(OUTPUT | CPIA_MODULE_VP_CTRL | 31)\n\n#define CPIA_COMMAND_GrabFrame\t\t(OUTPUT | CPIA_MODULE_CAPTURE | 1)\n#define CPIA_COMMAND_UploadFrame\t(OUTPUT | CPIA_MODULE_CAPTURE | 2)\n#define CPIA_COMMAND_SetGrabMode\t(OUTPUT | CPIA_MODULE_CAPTURE | 3)\n#define CPIA_COMMAND_InitStreamCap\t(OUTPUT | CPIA_MODULE_CAPTURE | 4)\n#define CPIA_COMMAND_FiniStreamCap\t(OUTPUT | CPIA_MODULE_CAPTURE | 5)\n#define CPIA_COMMAND_StartStreamCap\t(OUTPUT | CPIA_MODULE_CAPTURE | 6)\n#define CPIA_COMMAND_EndStreamCap\t(OUTPUT | CPIA_MODULE_CAPTURE | 7)\n#define CPIA_COMMAND_SetFormat\t\t(OUTPUT | CPIA_MODULE_CAPTURE | 8)\n#define CPIA_COMMAND_SetROI\t\t(OUTPUT | CPIA_MODULE_CAPTURE | 9)\n#define CPIA_COMMAND_SetCompression\t(OUTPUT | CPIA_MODULE_CAPTURE | 10)\n#define CPIA_COMMAND_SetCompressionTarget (OUTPUT | CPIA_MODULE_CAPTURE | 11)\n#define CPIA_COMMAND_SetYUVThresh\t(OUTPUT | CPIA_MODULE_CAPTURE | 12)\n#define CPIA_COMMAND_SetCompressionParams (OUTPUT | CPIA_MODULE_CAPTURE | 13)\n#define CPIA_COMMAND_DiscardFrame\t(OUTPUT | CPIA_MODULE_CAPTURE | 14)\n#define CPIA_COMMAND_GrabReset\t\t(OUTPUT | CPIA_MODULE_CAPTURE | 15)\n\n#define CPIA_COMMAND_OutputRS232\t(OUTPUT | CPIA_MODULE_DEBUG | 1)\n#define CPIA_COMMAND_AbortProcess\t(OUTPUT | CPIA_MODULE_DEBUG | 4)\n#define CPIA_COMMAND_SetDramPage\t(OUTPUT | CPIA_MODULE_DEBUG | 5)\n#define CPIA_COMMAND_StartDramUpload\t(OUTPUT | CPIA_MODULE_DEBUG | 6)\n#define CPIA_COMMAND_StartDummyDtream\t(OUTPUT | CPIA_MODULE_DEBUG | 8)\n#define CPIA_COMMAND_AbortStream\t(OUTPUT | CPIA_MODULE_DEBUG | 9)\n#define CPIA_COMMAND_DownloadDRAM\t(OUTPUT | CPIA_MODULE_DEBUG | 10)\n#define CPIA_COMMAND_Null\t\t(OUTPUT | CPIA_MODULE_DEBUG | 11)\n\n#define ROUND_UP_EXP_FOR_FLICKER 15\n\n \n#define MAX_EXP       302\n#define MAX_EXP_102   255\n#define LOW_EXP       140\n#define VERY_LOW_EXP   70\n#define TC             94\n#define\tEXP_ACC_DARK   50\n#define\tEXP_ACC_LIGHT  90\n#define HIGH_COMP_102 160\n#define MAX_COMP      239\n#define DARK_TIME       3\n#define LIGHT_TIME      3\n\n#define FIRMWARE_VERSION(x, y) (sd->params.version.firmwareVersion == (x) && \\\n\t\t\t\tsd->params.version.firmwareRevision == (y))\n\n#define CPIA1_CID_COMP_TARGET (V4L2_CTRL_CLASS_USER + 0x1000)\n#define BRIGHTNESS_DEF 50\n#define CONTRAST_DEF 48\n#define SATURATION_DEF 50\n#define FREQ_DEF V4L2_CID_POWER_LINE_FREQUENCY_50HZ\n#define ILLUMINATORS_1_DEF 0\n#define ILLUMINATORS_2_DEF 0\n#define COMP_TARGET_DEF CPIA_COMPRESSION_TARGET_QUALITY\n\n \nstatic u8 flicker_jumps[2][2][4] =\n{ { { 76, 38, 19, 9 }, { 92, 46, 23, 11 } },\n  { { 64, 32, 16, 8 }, { 76, 38, 19, 9} }\n};\n\nstruct cam_params {\n\tstruct {\n\t\tu8 firmwareVersion;\n\t\tu8 firmwareRevision;\n\t\tu8 vcVersion;\n\t\tu8 vcRevision;\n\t} version;\n\tstruct {\n\t\tu16 vendor;\n\t\tu16 product;\n\t\tu16 deviceRevision;\n\t} pnpID;\n\tstruct {\n\t\tu8 vpVersion;\n\t\tu8 vpRevision;\n\t\tu16 cameraHeadID;\n\t} vpVersion;\n\tstruct {\n\t\tu8 systemState;\n\t\tu8 grabState;\n\t\tu8 streamState;\n\t\tu8 fatalError;\n\t\tu8 cmdError;\n\t\tu8 debugFlags;\n\t\tu8 vpStatus;\n\t\tu8 errorCode;\n\t} status;\n\tstruct {\n\t\tu8 brightness;\n\t\tu8 contrast;\n\t\tu8 saturation;\n\t} colourParams;\n\tstruct {\n\t\tu8 gainMode;\n\t\tu8 expMode;\n\t\tu8 compMode;\n\t\tu8 centreWeight;\n\t\tu8 gain;\n\t\tu8 fineExp;\n\t\tu8 coarseExpLo;\n\t\tu8 coarseExpHi;\n\t\tu8 redComp;\n\t\tu8 green1Comp;\n\t\tu8 green2Comp;\n\t\tu8 blueComp;\n\t} exposure;\n\tstruct {\n\t\tu8 balanceMode;\n\t\tu8 redGain;\n\t\tu8 greenGain;\n\t\tu8 blueGain;\n\t} colourBalance;\n\tstruct {\n\t\tu8 divisor;\n\t\tu8 baserate;\n\t} sensorFps;\n\tstruct {\n\t\tu8 gain1;\n\t\tu8 gain2;\n\t\tu8 gain4;\n\t\tu8 gain8;\n\t} apcor;\n\tstruct {\n\t\tu8 disabled;\n\t\tu8 flickerMode;\n\t\tu8 coarseJump;\n\t\tu8 allowableOverExposure;\n\t} flickerControl;\n\tstruct {\n\t\tu8 gain1;\n\t\tu8 gain2;\n\t\tu8 gain4;\n\t\tu8 gain8;\n\t} vlOffset;\n\tstruct {\n\t\tu8 mode;\n\t\tu8 decimation;\n\t} compression;\n\tstruct {\n\t\tu8 frTargeting;\n\t\tu8 targetFR;\n\t\tu8 targetQ;\n\t} compressionTarget;\n\tstruct {\n\t\tu8 yThreshold;\n\t\tu8 uvThreshold;\n\t} yuvThreshold;\n\tstruct {\n\t\tu8 hysteresis;\n\t\tu8 threshMax;\n\t\tu8 smallStep;\n\t\tu8 largeStep;\n\t\tu8 decimationHysteresis;\n\t\tu8 frDiffStepThresh;\n\t\tu8 qDiffStepThresh;\n\t\tu8 decimationThreshMod;\n\t} compressionParams;\n\tstruct {\n\t\tu8 videoSize;\t\t \n\t\tu8 subSample;\n\t\tu8 yuvOrder;\n\t} format;\n\tstruct {                         \n\t\tu8 qx3_detected;         \n\t\tu8 toplight;             \n\t\tu8 bottomlight;          \n\t\tu8 button;               \n\t\tu8 cradled;              \n\t} qx3;\n\tstruct {\n\t\tu8 colStart;\t\t \n\t\tu8 colEnd;\t\t \n\t\tu8 rowStart;\t\t \n\t\tu8 rowEnd;\t\t \n\t} roi;\n\tu8 ecpTiming;\n\tu8 streamStartLine;\n};\n\n \nstruct sd {\n\tstruct gspca_dev gspca_dev;\t\t \n\tstruct cam_params params;\t\t \n\n\tatomic_t cam_exposure;\n\tatomic_t fps;\n\tint exposure_count;\n\tu8 exposure_status;\n\tstruct v4l2_ctrl *freq;\n\tu8 mainsFreq;\t\t\t\t \n\tu8 first_frame;\n};\n\nstatic const struct v4l2_pix_format mode[] = {\n\t{160, 120, V4L2_PIX_FMT_CPIA1, V4L2_FIELD_NONE,\n\t\t \n\t\t.bytesperline = 160,\n\t\t.sizeimage = 65536,\n\t\t.colorspace = V4L2_COLORSPACE_SRGB,\n\t\t.priv = 3},\n\t{176, 144, V4L2_PIX_FMT_CPIA1, V4L2_FIELD_NONE,\n\t\t.bytesperline = 172,\n\t\t.sizeimage = 65536,\n\t\t.colorspace = V4L2_COLORSPACE_SRGB,\n\t\t.priv = 2},\n\t{320, 240, V4L2_PIX_FMT_CPIA1, V4L2_FIELD_NONE,\n\t\t.bytesperline = 320,\n\t\t.sizeimage = 262144,\n\t\t.colorspace = V4L2_COLORSPACE_SRGB,\n\t\t.priv = 1},\n\t{352, 288, V4L2_PIX_FMT_CPIA1, V4L2_FIELD_NONE,\n\t\t.bytesperline = 352,\n\t\t.sizeimage = 262144,\n\t\t.colorspace = V4L2_COLORSPACE_SRGB,\n\t\t.priv = 0},\n};\n\n \n\nstatic int cpia_usb_transferCmd(struct gspca_dev *gspca_dev, u8 *command)\n{\n\tu8 requesttype;\n\tunsigned int pipe;\n\tint ret, databytes = command[6] | (command[7] << 8);\n\t \n\tint retries = 3;\n\n\tif (command[0] == DATA_IN) {\n\t\tpipe = usb_rcvctrlpipe(gspca_dev->dev, 0);\n\t\trequesttype = USB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE;\n\t} else if (command[0] == DATA_OUT) {\n\t\tpipe = usb_sndctrlpipe(gspca_dev->dev, 0);\n\t\trequesttype = USB_TYPE_VENDOR | USB_RECIP_DEVICE;\n\t} else {\n\t\tgspca_err(gspca_dev, \"Unexpected first byte of command: %x\\n\",\n\t\t\t  command[0]);\n\t\treturn -EINVAL;\n\t}\n\nretry:\n\tret = usb_control_msg(gspca_dev->dev, pipe,\n\t\t\t      command[1],\n\t\t\t      requesttype,\n\t\t\t      command[2] | (command[3] << 8),\n\t\t\t      command[4] | (command[5] << 8),\n\t\t\t      gspca_dev->usb_buf, databytes, 1000);\n\n\tif (ret < 0)\n\t\tpr_err(\"usb_control_msg %02x, error %d\\n\", command[1], ret);\n\n\tif (ret == -EPIPE && retries > 0) {\n\t\tretries--;\n\t\tgoto retry;\n\t}\n\n\treturn (ret < 0) ? ret : 0;\n}\n\n \nstatic int do_command(struct gspca_dev *gspca_dev, u16 command,\n\t\t      u8 a, u8 b, u8 c, u8 d)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint ret, datasize;\n\tu8 cmd[8];\n\n\tswitch (command) {\n\tcase CPIA_COMMAND_GetCPIAVersion:\n\tcase CPIA_COMMAND_GetPnPID:\n\tcase CPIA_COMMAND_GetCameraStatus:\n\tcase CPIA_COMMAND_GetVPVersion:\n\tcase CPIA_COMMAND_GetColourParams:\n\tcase CPIA_COMMAND_GetColourBalance:\n\tcase CPIA_COMMAND_GetExposure:\n\t\tdatasize = 8;\n\t\tbreak;\n\tcase CPIA_COMMAND_ReadMCPorts:\n\tcase CPIA_COMMAND_ReadVCRegs:\n\t\tdatasize = 4;\n\t\tbreak;\n\tdefault:\n\t\tdatasize = 0;\n\t\tbreak;\n\t}\n\n\tcmd[0] = command >> 8;\n\tcmd[1] = command & 0xff;\n\tcmd[2] = a;\n\tcmd[3] = b;\n\tcmd[4] = c;\n\tcmd[5] = d;\n\tcmd[6] = datasize;\n\tcmd[7] = 0;\n\n\tret = cpia_usb_transferCmd(gspca_dev, cmd);\n\tif (ret)\n\t\treturn ret;\n\n\tswitch (command) {\n\tcase CPIA_COMMAND_GetCPIAVersion:\n\t\tsd->params.version.firmwareVersion = gspca_dev->usb_buf[0];\n\t\tsd->params.version.firmwareRevision = gspca_dev->usb_buf[1];\n\t\tsd->params.version.vcVersion = gspca_dev->usb_buf[2];\n\t\tsd->params.version.vcRevision = gspca_dev->usb_buf[3];\n\t\tbreak;\n\tcase CPIA_COMMAND_GetPnPID:\n\t\tsd->params.pnpID.vendor =\n\t\t\tgspca_dev->usb_buf[0] | (gspca_dev->usb_buf[1] << 8);\n\t\tsd->params.pnpID.product =\n\t\t\tgspca_dev->usb_buf[2] | (gspca_dev->usb_buf[3] << 8);\n\t\tsd->params.pnpID.deviceRevision =\n\t\t\tgspca_dev->usb_buf[4] | (gspca_dev->usb_buf[5] << 8);\n\t\tbreak;\n\tcase CPIA_COMMAND_GetCameraStatus:\n\t\tsd->params.status.systemState = gspca_dev->usb_buf[0];\n\t\tsd->params.status.grabState = gspca_dev->usb_buf[1];\n\t\tsd->params.status.streamState = gspca_dev->usb_buf[2];\n\t\tsd->params.status.fatalError = gspca_dev->usb_buf[3];\n\t\tsd->params.status.cmdError = gspca_dev->usb_buf[4];\n\t\tsd->params.status.debugFlags = gspca_dev->usb_buf[5];\n\t\tsd->params.status.vpStatus = gspca_dev->usb_buf[6];\n\t\tsd->params.status.errorCode = gspca_dev->usb_buf[7];\n\t\tbreak;\n\tcase CPIA_COMMAND_GetVPVersion:\n\t\tsd->params.vpVersion.vpVersion = gspca_dev->usb_buf[0];\n\t\tsd->params.vpVersion.vpRevision = gspca_dev->usb_buf[1];\n\t\tsd->params.vpVersion.cameraHeadID =\n\t\t\tgspca_dev->usb_buf[2] | (gspca_dev->usb_buf[3] << 8);\n\t\tbreak;\n\tcase CPIA_COMMAND_GetColourParams:\n\t\tsd->params.colourParams.brightness = gspca_dev->usb_buf[0];\n\t\tsd->params.colourParams.contrast = gspca_dev->usb_buf[1];\n\t\tsd->params.colourParams.saturation = gspca_dev->usb_buf[2];\n\t\tbreak;\n\tcase CPIA_COMMAND_GetColourBalance:\n\t\tsd->params.colourBalance.redGain = gspca_dev->usb_buf[0];\n\t\tsd->params.colourBalance.greenGain = gspca_dev->usb_buf[1];\n\t\tsd->params.colourBalance.blueGain = gspca_dev->usb_buf[2];\n\t\tbreak;\n\tcase CPIA_COMMAND_GetExposure:\n\t\tsd->params.exposure.gain = gspca_dev->usb_buf[0];\n\t\tsd->params.exposure.fineExp = gspca_dev->usb_buf[1];\n\t\tsd->params.exposure.coarseExpLo = gspca_dev->usb_buf[2];\n\t\tsd->params.exposure.coarseExpHi = gspca_dev->usb_buf[3];\n\t\tsd->params.exposure.redComp = gspca_dev->usb_buf[4];\n\t\tsd->params.exposure.green1Comp = gspca_dev->usb_buf[5];\n\t\tsd->params.exposure.green2Comp = gspca_dev->usb_buf[6];\n\t\tsd->params.exposure.blueComp = gspca_dev->usb_buf[7];\n\t\tbreak;\n\n\tcase CPIA_COMMAND_ReadMCPorts:\n\t\t \n\t\ta = ((gspca_dev->usb_buf[1] & 0x02) == 0);\n\t\tif (a != sd->params.qx3.button) {\n#if IS_ENABLED(CONFIG_INPUT)\n\t\t\tinput_report_key(gspca_dev->input_dev, KEY_CAMERA, a);\n\t\t\tinput_sync(gspca_dev->input_dev);\n#endif\n\t\t\tsd->params.qx3.button = a;\n\t\t}\n\t\tif (sd->params.qx3.button) {\n\t\t\t \n\t\t\tret = do_command(gspca_dev, CPIA_COMMAND_WriteMCPort,\n\t\t\t\t   3, 0xdf, 0xdf, 0);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t\tret = do_command(gspca_dev, CPIA_COMMAND_WriteMCPort,\n\t\t\t\t   3, 0xff, 0xff, 0);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t}\n\n\t\t \n\t\tsd->params.qx3.cradled = ((gspca_dev->usb_buf[2] & 0x40) == 0);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int do_command_extended(struct gspca_dev *gspca_dev, u16 command,\n\t\t\t       u8 a, u8 b, u8 c, u8 d,\n\t\t\t       u8 e, u8 f, u8 g, u8 h,\n\t\t\t       u8 i, u8 j, u8 k, u8 l)\n{\n\tu8 cmd[8];\n\n\tcmd[0] = command >> 8;\n\tcmd[1] = command & 0xff;\n\tcmd[2] = a;\n\tcmd[3] = b;\n\tcmd[4] = c;\n\tcmd[5] = d;\n\tcmd[6] = 8;\n\tcmd[7] = 0;\n\tgspca_dev->usb_buf[0] = e;\n\tgspca_dev->usb_buf[1] = f;\n\tgspca_dev->usb_buf[2] = g;\n\tgspca_dev->usb_buf[3] = h;\n\tgspca_dev->usb_buf[4] = i;\n\tgspca_dev->usb_buf[5] = j;\n\tgspca_dev->usb_buf[6] = k;\n\tgspca_dev->usb_buf[7] = l;\n\n\treturn cpia_usb_transferCmd(gspca_dev, cmd);\n}\n\n \n#define FLICKER_MAX_EXPOSURE                    250\n#define FLICKER_ALLOWABLE_OVER_EXPOSURE         146\n#define FLICKER_BRIGHTNESS_CONSTANT             59\nstatic int find_over_exposure(int brightness)\n{\n\tint MaxAllowableOverExposure, OverExposure;\n\n\tMaxAllowableOverExposure = FLICKER_MAX_EXPOSURE - brightness -\n\t\t\t\t   FLICKER_BRIGHTNESS_CONSTANT;\n\n\tif (MaxAllowableOverExposure < FLICKER_ALLOWABLE_OVER_EXPOSURE)\n\t\tOverExposure = MaxAllowableOverExposure;\n\telse\n\t\tOverExposure = FLICKER_ALLOWABLE_OVER_EXPOSURE;\n\n\treturn OverExposure;\n}\n#undef FLICKER_MAX_EXPOSURE\n#undef FLICKER_ALLOWABLE_OVER_EXPOSURE\n#undef FLICKER_BRIGHTNESS_CONSTANT\n\n \nstatic void reset_camera_params(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tstruct cam_params *params = &sd->params;\n\n\t \n\tparams->colourParams.brightness = BRIGHTNESS_DEF;\n\tparams->colourParams.contrast = CONTRAST_DEF;\n\tparams->colourParams.saturation = SATURATION_DEF;\n\tparams->exposure.gainMode = 4;\n\tparams->exposure.expMode = 2;\t\t \n\tparams->exposure.compMode = 1;\n\tparams->exposure.centreWeight = 1;\n\tparams->exposure.gain = 0;\n\tparams->exposure.fineExp = 0;\n\tparams->exposure.coarseExpLo = 185;\n\tparams->exposure.coarseExpHi = 0;\n\tparams->exposure.redComp = COMP_RED;\n\tparams->exposure.green1Comp = COMP_GREEN1;\n\tparams->exposure.green2Comp = COMP_GREEN2;\n\tparams->exposure.blueComp = COMP_BLUE;\n\tparams->colourBalance.balanceMode = 2;\t \n\tparams->colourBalance.redGain = 32;\n\tparams->colourBalance.greenGain = 6;\n\tparams->colourBalance.blueGain = 92;\n\tparams->apcor.gain1 = 0x18;\n\tparams->apcor.gain2 = 0x16;\n\tparams->apcor.gain4 = 0x24;\n\tparams->apcor.gain8 = 0x34;\n\tparams->vlOffset.gain1 = 20;\n\tparams->vlOffset.gain2 = 24;\n\tparams->vlOffset.gain4 = 26;\n\tparams->vlOffset.gain8 = 26;\n\tparams->compressionParams.hysteresis = 3;\n\tparams->compressionParams.threshMax = 11;\n\tparams->compressionParams.smallStep = 1;\n\tparams->compressionParams.largeStep = 3;\n\tparams->compressionParams.decimationHysteresis = 2;\n\tparams->compressionParams.frDiffStepThresh = 5;\n\tparams->compressionParams.qDiffStepThresh = 3;\n\tparams->compressionParams.decimationThreshMod = 2;\n\t \n\n\t \n\tparams->sensorFps.divisor = 1;\n\tparams->sensorFps.baserate = 1;\n\n\tparams->flickerControl.flickerMode = 0;\n\tparams->flickerControl.disabled = 1;\n\tparams->flickerControl.coarseJump =\n\t\tflicker_jumps[sd->mainsFreq]\n\t\t\t     [params->sensorFps.baserate]\n\t\t\t     [params->sensorFps.divisor];\n\tparams->flickerControl.allowableOverExposure =\n\t\tfind_over_exposure(params->colourParams.brightness);\n\n\tparams->yuvThreshold.yThreshold = 6;  \n\tparams->yuvThreshold.uvThreshold = 6;  \n\n\tparams->format.subSample = SUBSAMPLE_420;\n\tparams->format.yuvOrder = YUVORDER_YUYV;\n\n\tparams->compression.mode = CPIA_COMPRESSION_AUTO;\n\tparams->compression.decimation = NO_DECIMATION;\n\n\tparams->compressionTarget.frTargeting = COMP_TARGET_DEF;\n\tparams->compressionTarget.targetFR = 15;  \n\tparams->compressionTarget.targetQ = 5;  \n\n\tparams->qx3.qx3_detected = 0;\n\tparams->qx3.toplight = 0;\n\tparams->qx3.bottomlight = 0;\n\tparams->qx3.button = 0;\n\tparams->qx3.cradled = 0;\n}\n\nstatic void printstatus(struct gspca_dev *gspca_dev, struct cam_params *params)\n{\n\tgspca_dbg(gspca_dev, D_PROBE, \"status: %02x %02x %02x %02x %02x %02x %02x %02x\\n\",\n\t\t  params->status.systemState, params->status.grabState,\n\t\t  params->status.streamState, params->status.fatalError,\n\t\t  params->status.cmdError, params->status.debugFlags,\n\t\t  params->status.vpStatus, params->status.errorCode);\n}\n\nstatic int goto_low_power(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint ret;\n\n\tret = do_command(gspca_dev, CPIA_COMMAND_GotoLoPower, 0, 0, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tret = do_command(gspca_dev, CPIA_COMMAND_GetCameraStatus, 0, 0, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tif (sd->params.status.systemState != LO_POWER_STATE) {\n\t\tif (sd->params.status.systemState != WARM_BOOT_STATE) {\n\t\t\tgspca_err(gspca_dev, \"unexpected state after lo power cmd: %02x\\n\",\n\t\t\t\t  sd->params.status.systemState);\n\t\t\tprintstatus(gspca_dev, &sd->params);\n\t\t}\n\t\treturn -EIO;\n\t}\n\n\tgspca_dbg(gspca_dev, D_CONF, \"camera now in LOW power state\\n\");\n\treturn 0;\n}\n\nstatic int goto_high_power(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint ret;\n\n\tret = do_command(gspca_dev, CPIA_COMMAND_GotoHiPower, 0, 0, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tmsleep_interruptible(40);\t \n\n\tif (signal_pending(current))\n\t\treturn -EINTR;\n\n\tret = do_command(gspca_dev, CPIA_COMMAND_GetCameraStatus, 0, 0, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tif (sd->params.status.systemState != HI_POWER_STATE) {\n\t\tgspca_err(gspca_dev, \"unexpected state after hi power cmd: %02x\\n\",\n\t\t\t  sd->params.status.systemState);\n\t\tprintstatus(gspca_dev, &sd->params);\n\t\treturn -EIO;\n\t}\n\n\tgspca_dbg(gspca_dev, D_CONF, \"camera now in HIGH power state\\n\");\n\treturn 0;\n}\n\nstatic int get_version_information(struct gspca_dev *gspca_dev)\n{\n\tint ret;\n\n\t \n\tret = do_command(gspca_dev, CPIA_COMMAND_GetCPIAVersion, 0, 0, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\treturn do_command(gspca_dev, CPIA_COMMAND_GetPnPID, 0, 0, 0, 0);\n}\n\nstatic int save_camera_state(struct gspca_dev *gspca_dev)\n{\n\tint ret;\n\n\tret = do_command(gspca_dev, CPIA_COMMAND_GetColourBalance, 0, 0, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_GetExposure, 0, 0, 0, 0);\n}\n\nstatic int command_setformat(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint ret;\n\n\tret = do_command(gspca_dev, CPIA_COMMAND_SetFormat,\n\t\t\t sd->params.format.videoSize,\n\t\t\t sd->params.format.subSample,\n\t\t\t sd->params.format.yuvOrder, 0);\n\tif (ret)\n\t\treturn ret;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetROI,\n\t\t\t  sd->params.roi.colStart, sd->params.roi.colEnd,\n\t\t\t  sd->params.roi.rowStart, sd->params.roi.rowEnd);\n}\n\nstatic int command_setcolourparams(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetColourParams,\n\t\t\t  sd->params.colourParams.brightness,\n\t\t\t  sd->params.colourParams.contrast,\n\t\t\t  sd->params.colourParams.saturation, 0);\n}\n\nstatic int command_setapcor(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetApcor,\n\t\t\t  sd->params.apcor.gain1,\n\t\t\t  sd->params.apcor.gain2,\n\t\t\t  sd->params.apcor.gain4,\n\t\t\t  sd->params.apcor.gain8);\n}\n\nstatic int command_setvloffset(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetVLOffset,\n\t\t\t  sd->params.vlOffset.gain1,\n\t\t\t  sd->params.vlOffset.gain2,\n\t\t\t  sd->params.vlOffset.gain4,\n\t\t\t  sd->params.vlOffset.gain8);\n}\n\nstatic int command_setexposure(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint ret;\n\n\tret = do_command_extended(gspca_dev, CPIA_COMMAND_SetExposure,\n\t\t\t\t  sd->params.exposure.gainMode,\n\t\t\t\t  1,\n\t\t\t\t  sd->params.exposure.compMode,\n\t\t\t\t  sd->params.exposure.centreWeight,\n\t\t\t\t  sd->params.exposure.gain,\n\t\t\t\t  sd->params.exposure.fineExp,\n\t\t\t\t  sd->params.exposure.coarseExpLo,\n\t\t\t\t  sd->params.exposure.coarseExpHi,\n\t\t\t\t  sd->params.exposure.redComp,\n\t\t\t\t  sd->params.exposure.green1Comp,\n\t\t\t\t  sd->params.exposure.green2Comp,\n\t\t\t\t  sd->params.exposure.blueComp);\n\tif (ret)\n\t\treturn ret;\n\n\tif (sd->params.exposure.expMode != 1) {\n\t\tret = do_command_extended(gspca_dev, CPIA_COMMAND_SetExposure,\n\t\t\t\t\t  0,\n\t\t\t\t\t  sd->params.exposure.expMode,\n\t\t\t\t\t  0, 0,\n\t\t\t\t\t  sd->params.exposure.gain,\n\t\t\t\t\t  sd->params.exposure.fineExp,\n\t\t\t\t\t  sd->params.exposure.coarseExpLo,\n\t\t\t\t\t  sd->params.exposure.coarseExpHi,\n\t\t\t\t\t  0, 0, 0, 0);\n\t}\n\n\treturn ret;\n}\n\nstatic int command_setcolourbalance(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\tif (sd->params.colourBalance.balanceMode == 1) {\n\t\tint ret;\n\n\t\tret = do_command(gspca_dev, CPIA_COMMAND_SetColourBalance,\n\t\t\t\t 1,\n\t\t\t\t sd->params.colourBalance.redGain,\n\t\t\t\t sd->params.colourBalance.greenGain,\n\t\t\t\t sd->params.colourBalance.blueGain);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\treturn do_command(gspca_dev, CPIA_COMMAND_SetColourBalance,\n\t\t\t\t  3, 0, 0, 0);\n\t}\n\tif (sd->params.colourBalance.balanceMode == 2) {\n\t\treturn do_command(gspca_dev, CPIA_COMMAND_SetColourBalance,\n\t\t\t\t  2, 0, 0, 0);\n\t}\n\tif (sd->params.colourBalance.balanceMode == 3) {\n\t\treturn do_command(gspca_dev, CPIA_COMMAND_SetColourBalance,\n\t\t\t\t  3, 0, 0, 0);\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int command_setcompressiontarget(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetCompressionTarget,\n\t\t\t  sd->params.compressionTarget.frTargeting,\n\t\t\t  sd->params.compressionTarget.targetFR,\n\t\t\t  sd->params.compressionTarget.targetQ, 0);\n}\n\nstatic int command_setyuvtresh(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetYUVThresh,\n\t\t\t  sd->params.yuvThreshold.yThreshold,\n\t\t\t  sd->params.yuvThreshold.uvThreshold, 0, 0);\n}\n\nstatic int command_setcompressionparams(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\treturn do_command_extended(gspca_dev,\n\t\t\t    CPIA_COMMAND_SetCompressionParams,\n\t\t\t    0, 0, 0, 0,\n\t\t\t    sd->params.compressionParams.hysteresis,\n\t\t\t    sd->params.compressionParams.threshMax,\n\t\t\t    sd->params.compressionParams.smallStep,\n\t\t\t    sd->params.compressionParams.largeStep,\n\t\t\t    sd->params.compressionParams.decimationHysteresis,\n\t\t\t    sd->params.compressionParams.frDiffStepThresh,\n\t\t\t    sd->params.compressionParams.qDiffStepThresh,\n\t\t\t    sd->params.compressionParams.decimationThreshMod);\n}\n\nstatic int command_setcompression(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetCompression,\n\t\t\t  sd->params.compression.mode,\n\t\t\t  sd->params.compression.decimation, 0, 0);\n}\n\nstatic int command_setsensorfps(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetSensorFPS,\n\t\t\t  sd->params.sensorFps.divisor,\n\t\t\t  sd->params.sensorFps.baserate, 0, 0);\n}\n\nstatic int command_setflickerctrl(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetFlickerCtrl,\n\t\t\t  sd->params.flickerControl.flickerMode,\n\t\t\t  sd->params.flickerControl.coarseJump,\n\t\t\t  sd->params.flickerControl.allowableOverExposure,\n\t\t\t  0);\n}\n\nstatic int command_setecptiming(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_SetECPTiming,\n\t\t\t  sd->params.ecpTiming, 0, 0, 0);\n}\n\nstatic int command_pause(struct gspca_dev *gspca_dev)\n{\n\treturn do_command(gspca_dev, CPIA_COMMAND_EndStreamCap, 0, 0, 0, 0);\n}\n\nstatic int command_resume(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_InitStreamCap,\n\t\t\t  0, sd->params.streamStartLine, 0, 0);\n}\n\nstatic int command_setlights(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint ret, p1, p2;\n\n\tp1 = (sd->params.qx3.bottomlight == 0) << 1;\n\tp2 = (sd->params.qx3.toplight == 0) << 3;\n\n\tret = do_command(gspca_dev, CPIA_COMMAND_WriteVCReg,\n\t\t\t 0x90, 0x8f, 0x50, 0);\n\tif (ret)\n\t\treturn ret;\n\n\treturn do_command(gspca_dev, CPIA_COMMAND_WriteMCPort, 2, 0,\n\t\t\t  p1 | p2 | 0xe0, 0);\n}\n\nstatic int set_flicker(struct gspca_dev *gspca_dev, int on, int apply)\n{\n\t \n \n#if 0\n#define COMPGAIN(base, curexp, newexp) \\\n    (u8) ((((float) base - 128.0) * ((float) curexp / (float) newexp)) + 128.5)\n#define EXP_FROM_COMP(basecomp, curcomp, curexp) \\\n    (u16)((float)curexp * (float)(u8)(curcomp + 128) / \\\n    (float)(u8)(basecomp - 128))\n#else\n   \n#define COMPGAIN(base, curexp, newexp) \\\n    (u8)(128 + (((u32)(2*(base-128)*curexp + newexp)) / (2 * newexp)))\n#define EXP_FROM_COMP(basecomp, curcomp, curexp) \\\n    (u16)(((u32)(curexp * (u8)(curcomp + 128)) / (u8)(basecomp - 128)))\n#endif\n\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint currentexp = sd->params.exposure.coarseExpLo +\n\t\t\t sd->params.exposure.coarseExpHi * 256;\n\tint ret, startexp;\n\n\tif (on) {\n\t\tint cj = sd->params.flickerControl.coarseJump;\n\t\tsd->params.flickerControl.flickerMode = 1;\n\t\tsd->params.flickerControl.disabled = 0;\n\t\tif (sd->params.exposure.expMode != 2) {\n\t\t\tsd->params.exposure.expMode = 2;\n\t\t\tsd->exposure_status = EXPOSURE_NORMAL;\n\t\t}\n\t\tif (sd->params.exposure.gain >= BITS_PER_TYPE(currentexp))\n\t\t\treturn -EINVAL;\n\t\tcurrentexp = currentexp << sd->params.exposure.gain;\n\t\tsd->params.exposure.gain = 0;\n\t\t \n\t\tstartexp = (currentexp + ROUND_UP_EXP_FOR_FLICKER) / cj;\n\t\tif (startexp < 1)\n\t\t\tstartexp = 1;\n\t\tstartexp = (startexp * cj) - 1;\n\t\tif (FIRMWARE_VERSION(1, 2))\n\t\t\twhile (startexp > MAX_EXP_102)\n\t\t\t\tstartexp -= cj;\n\t\telse\n\t\t\twhile (startexp > MAX_EXP)\n\t\t\t\tstartexp -= cj;\n\t\tsd->params.exposure.coarseExpLo = startexp & 0xff;\n\t\tsd->params.exposure.coarseExpHi = startexp >> 8;\n\t\tif (currentexp > startexp) {\n\t\t\tif (currentexp > (2 * startexp))\n\t\t\t\tcurrentexp = 2 * startexp;\n\t\t\tsd->params.exposure.redComp =\n\t\t\t\tCOMPGAIN(COMP_RED, currentexp, startexp);\n\t\t\tsd->params.exposure.green1Comp =\n\t\t\t\tCOMPGAIN(COMP_GREEN1, currentexp, startexp);\n\t\t\tsd->params.exposure.green2Comp =\n\t\t\t\tCOMPGAIN(COMP_GREEN2, currentexp, startexp);\n\t\t\tsd->params.exposure.blueComp =\n\t\t\t\tCOMPGAIN(COMP_BLUE, currentexp, startexp);\n\t\t} else {\n\t\t\tsd->params.exposure.redComp = COMP_RED;\n\t\t\tsd->params.exposure.green1Comp = COMP_GREEN1;\n\t\t\tsd->params.exposure.green2Comp = COMP_GREEN2;\n\t\t\tsd->params.exposure.blueComp = COMP_BLUE;\n\t\t}\n\t\tif (FIRMWARE_VERSION(1, 2))\n\t\t\tsd->params.exposure.compMode = 0;\n\t\telse\n\t\t\tsd->params.exposure.compMode = 1;\n\n\t\tsd->params.apcor.gain1 = 0x18;\n\t\tsd->params.apcor.gain2 = 0x18;\n\t\tsd->params.apcor.gain4 = 0x16;\n\t\tsd->params.apcor.gain8 = 0x14;\n\t} else {\n\t\tsd->params.flickerControl.flickerMode = 0;\n\t\tsd->params.flickerControl.disabled = 1;\n\t\t \n\t\tstartexp = EXP_FROM_COMP(COMP_RED,\n\t\t\t\tsd->params.exposure.redComp, currentexp);\n\t\tstartexp += EXP_FROM_COMP(COMP_GREEN1,\n\t\t\t\tsd->params.exposure.green1Comp, currentexp);\n\t\tstartexp += EXP_FROM_COMP(COMP_GREEN2,\n\t\t\t\tsd->params.exposure.green2Comp, currentexp);\n\t\tstartexp += EXP_FROM_COMP(COMP_BLUE,\n\t\t\t\tsd->params.exposure.blueComp, currentexp);\n\t\tstartexp = startexp >> 2;\n\t\twhile (startexp > MAX_EXP && sd->params.exposure.gain <\n\t\t       sd->params.exposure.gainMode - 1) {\n\t\t\tstartexp = startexp >> 1;\n\t\t\t++sd->params.exposure.gain;\n\t\t}\n\t\tif (FIRMWARE_VERSION(1, 2) && startexp > MAX_EXP_102)\n\t\t\tstartexp = MAX_EXP_102;\n\t\tif (startexp > MAX_EXP)\n\t\t\tstartexp = MAX_EXP;\n\t\tsd->params.exposure.coarseExpLo = startexp & 0xff;\n\t\tsd->params.exposure.coarseExpHi = startexp >> 8;\n\t\tsd->params.exposure.redComp = COMP_RED;\n\t\tsd->params.exposure.green1Comp = COMP_GREEN1;\n\t\tsd->params.exposure.green2Comp = COMP_GREEN2;\n\t\tsd->params.exposure.blueComp = COMP_BLUE;\n\t\tsd->params.exposure.compMode = 1;\n\t\tsd->params.apcor.gain1 = 0x18;\n\t\tsd->params.apcor.gain2 = 0x16;\n\t\tsd->params.apcor.gain4 = 0x24;\n\t\tsd->params.apcor.gain8 = 0x34;\n\t}\n\tsd->params.vlOffset.gain1 = 20;\n\tsd->params.vlOffset.gain2 = 24;\n\tsd->params.vlOffset.gain4 = 26;\n\tsd->params.vlOffset.gain8 = 26;\n\n\tif (apply) {\n\t\tret = command_setexposure(gspca_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = command_setapcor(gspca_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = command_setvloffset(gspca_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = command_setflickerctrl(gspca_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n#undef EXP_FROM_COMP\n#undef COMPGAIN\n}\n\n \nstatic void monitor_exposure(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tu8 exp_acc, bcomp, cmd[8];\n\tint ret, light_exp, dark_exp, very_dark_exp;\n\tint old_exposure, new_exposure, framerate;\n\tint setfps = 0, setexp = 0, setflicker = 0;\n\n\t \n\t \n\tcmd[0] = CPIA_COMMAND_ReadVPRegs >> 8;\n\tcmd[1] = CPIA_COMMAND_ReadVPRegs & 0xff;\n\tcmd[2] = 30;\n\tcmd[3] = 4;\n\tcmd[4] = 9;\n\tcmd[5] = 8;\n\tcmd[6] = 8;\n\tcmd[7] = 0;\n\tret = cpia_usb_transferCmd(gspca_dev, cmd);\n\tif (ret) {\n\t\tpr_err(\"ReadVPRegs(30,4,9,8) - failed: %d\\n\", ret);\n\t\treturn;\n\t}\n\texp_acc = gspca_dev->usb_buf[0];\n\tbcomp = gspca_dev->usb_buf[1];\n\n\tlight_exp = sd->params.colourParams.brightness +\n\t\t    TC - 50 + EXP_ACC_LIGHT;\n\tif (light_exp > 255)\n\t\tlight_exp = 255;\n\tdark_exp = sd->params.colourParams.brightness +\n\t\t   TC - 50 - EXP_ACC_DARK;\n\tif (dark_exp < 0)\n\t\tdark_exp = 0;\n\tvery_dark_exp = dark_exp / 2;\n\n\told_exposure = sd->params.exposure.coarseExpHi * 256 +\n\t\t       sd->params.exposure.coarseExpLo;\n\n\tif (!sd->params.flickerControl.disabled) {\n\t\t \n\t\tint max_comp = FIRMWARE_VERSION(1, 2) ? MAX_COMP :\n\t\t\t\t\t\t\tHIGH_COMP_102;\n\t\tbcomp += 128;\t \n\t\tif (bcomp >= max_comp && exp_acc < dark_exp) {\n\t\t\t \n\t\t\tif (exp_acc < very_dark_exp) {\n\t\t\t\t \n\t\t\t\tif (sd->exposure_status == EXPOSURE_VERY_DARK)\n\t\t\t\t\t++sd->exposure_count;\n\t\t\t\telse {\n\t\t\t\t\tsd->exposure_status =\n\t\t\t\t\t\tEXPOSURE_VERY_DARK;\n\t\t\t\t\tsd->exposure_count = 1;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tif (sd->exposure_status == EXPOSURE_DARK)\n\t\t\t\t\t++sd->exposure_count;\n\t\t\t\telse {\n\t\t\t\t\tsd->exposure_status = EXPOSURE_DARK;\n\t\t\t\t\tsd->exposure_count = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (old_exposure <= LOW_EXP || exp_acc > light_exp) {\n\t\t\t \n\t\t\tif (old_exposure <= VERY_LOW_EXP) {\n\t\t\t\t \n\t\t\t\tif (sd->exposure_status == EXPOSURE_VERY_LIGHT)\n\t\t\t\t\t++sd->exposure_count;\n\t\t\t\telse {\n\t\t\t\t\tsd->exposure_status =\n\t\t\t\t\t\tEXPOSURE_VERY_LIGHT;\n\t\t\t\t\tsd->exposure_count = 1;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tif (sd->exposure_status == EXPOSURE_LIGHT)\n\t\t\t\t\t++sd->exposure_count;\n\t\t\t\telse {\n\t\t\t\t\tsd->exposure_status = EXPOSURE_LIGHT;\n\t\t\t\t\tsd->exposure_count = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tsd->exposure_status = EXPOSURE_NORMAL;\n\t\t}\n\t} else {\n\t\t \n\t\tif (old_exposure >= MAX_EXP && exp_acc < dark_exp) {\n\t\t\t \n\t\t\tif (exp_acc < very_dark_exp) {\n\t\t\t\t \n\t\t\t\tif (sd->exposure_status == EXPOSURE_VERY_DARK)\n\t\t\t\t\t++sd->exposure_count;\n\t\t\t\telse {\n\t\t\t\t\tsd->exposure_status =\n\t\t\t\t\t\tEXPOSURE_VERY_DARK;\n\t\t\t\t\tsd->exposure_count = 1;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tif (sd->exposure_status == EXPOSURE_DARK)\n\t\t\t\t\t++sd->exposure_count;\n\t\t\t\telse {\n\t\t\t\t\tsd->exposure_status = EXPOSURE_DARK;\n\t\t\t\t\tsd->exposure_count = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (old_exposure <= LOW_EXP || exp_acc > light_exp) {\n\t\t\t \n\t\t\tif (old_exposure <= VERY_LOW_EXP) {\n\t\t\t\t \n\t\t\t\tif (sd->exposure_status == EXPOSURE_VERY_LIGHT)\n\t\t\t\t\t++sd->exposure_count;\n\t\t\t\telse {\n\t\t\t\t\tsd->exposure_status =\n\t\t\t\t\t\tEXPOSURE_VERY_LIGHT;\n\t\t\t\t\tsd->exposure_count = 1;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tif (sd->exposure_status == EXPOSURE_LIGHT)\n\t\t\t\t\t++sd->exposure_count;\n\t\t\t\telse {\n\t\t\t\t\tsd->exposure_status = EXPOSURE_LIGHT;\n\t\t\t\t\tsd->exposure_count = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tsd->exposure_status = EXPOSURE_NORMAL;\n\t\t}\n\t}\n\n\tframerate = atomic_read(&sd->fps);\n\tif (framerate > 30 || framerate < 1)\n\t\tframerate = 1;\n\n\tif (!sd->params.flickerControl.disabled) {\n\t\t \n\t\tif ((sd->exposure_status == EXPOSURE_VERY_DARK ||\n\t\t     sd->exposure_status == EXPOSURE_DARK) &&\n\t\t    sd->exposure_count >= DARK_TIME * framerate &&\n\t\t    sd->params.sensorFps.divisor < 2) {\n\n\t\t\t \n\t\t\t++sd->params.sensorFps.divisor;\n\t\t\tsetfps = 1;\n\n\t\t\tsd->params.flickerControl.coarseJump =\n\t\t\t\tflicker_jumps[sd->mainsFreq]\n\t\t\t\t\t     [sd->params.sensorFps.baserate]\n\t\t\t\t\t     [sd->params.sensorFps.divisor];\n\t\t\tsetflicker = 1;\n\n\t\t\tnew_exposure = sd->params.flickerControl.coarseJump-1;\n\t\t\twhile (new_exposure < old_exposure / 2)\n\t\t\t\tnew_exposure +=\n\t\t\t\t\tsd->params.flickerControl.coarseJump;\n\t\t\tsd->params.exposure.coarseExpLo = new_exposure & 0xff;\n\t\t\tsd->params.exposure.coarseExpHi = new_exposure >> 8;\n\t\t\tsetexp = 1;\n\t\t\tsd->exposure_status = EXPOSURE_NORMAL;\n\t\t\tgspca_dbg(gspca_dev, D_CONF, \"Automatically decreasing sensor_fps\\n\");\n\n\t\t} else if ((sd->exposure_status == EXPOSURE_VERY_LIGHT ||\n\t\t\t    sd->exposure_status == EXPOSURE_LIGHT) &&\n\t\t\t   sd->exposure_count >= LIGHT_TIME * framerate &&\n\t\t\t   sd->params.sensorFps.divisor > 0) {\n\n\t\t\t \n\t\t\tint max_exp = FIRMWARE_VERSION(1, 2) ? MAX_EXP_102 :\n\t\t\t\t\t\t\t       MAX_EXP;\n\t\t\t--sd->params.sensorFps.divisor;\n\t\t\tsetfps = 1;\n\n\t\t\tsd->params.flickerControl.coarseJump =\n\t\t\t\tflicker_jumps[sd->mainsFreq]\n\t\t\t\t\t     [sd->params.sensorFps.baserate]\n\t\t\t\t\t     [sd->params.sensorFps.divisor];\n\t\t\tsetflicker = 1;\n\n\t\t\tnew_exposure = sd->params.flickerControl.coarseJump-1;\n\t\t\twhile (new_exposure < 2 * old_exposure &&\n\t\t\t       new_exposure +\n\t\t\t       sd->params.flickerControl.coarseJump < max_exp)\n\t\t\t\tnew_exposure +=\n\t\t\t\t\tsd->params.flickerControl.coarseJump;\n\t\t\tsd->params.exposure.coarseExpLo = new_exposure & 0xff;\n\t\t\tsd->params.exposure.coarseExpHi = new_exposure >> 8;\n\t\t\tsetexp = 1;\n\t\t\tsd->exposure_status = EXPOSURE_NORMAL;\n\t\t\tgspca_dbg(gspca_dev, D_CONF, \"Automatically increasing sensor_fps\\n\");\n\t\t}\n\t} else {\n\t\t \n\t\tif ((sd->exposure_status == EXPOSURE_VERY_DARK ||\n\t\t     sd->exposure_status == EXPOSURE_DARK) &&\n\t\t    sd->exposure_count >= DARK_TIME * framerate &&\n\t\t    sd->params.sensorFps.divisor < 2) {\n\n\t\t\t \n\t\t\t++sd->params.sensorFps.divisor;\n\t\t\tsetfps = 1;\n\n\t\t\tif (sd->params.exposure.gain > 0) {\n\t\t\t\t--sd->params.exposure.gain;\n\t\t\t\tsetexp = 1;\n\t\t\t}\n\t\t\tsd->exposure_status = EXPOSURE_NORMAL;\n\t\t\tgspca_dbg(gspca_dev, D_CONF, \"Automatically decreasing sensor_fps\\n\");\n\n\t\t} else if ((sd->exposure_status == EXPOSURE_VERY_LIGHT ||\n\t\t\t    sd->exposure_status == EXPOSURE_LIGHT) &&\n\t\t\t   sd->exposure_count >= LIGHT_TIME * framerate &&\n\t\t\t   sd->params.sensorFps.divisor > 0) {\n\n\t\t\t \n\t\t\t--sd->params.sensorFps.divisor;\n\t\t\tsetfps = 1;\n\n\t\t\tif (sd->params.exposure.gain <\n\t\t\t    sd->params.exposure.gainMode - 1) {\n\t\t\t\t++sd->params.exposure.gain;\n\t\t\t\tsetexp = 1;\n\t\t\t}\n\t\t\tsd->exposure_status = EXPOSURE_NORMAL;\n\t\t\tgspca_dbg(gspca_dev, D_CONF, \"Automatically increasing sensor_fps\\n\");\n\t\t}\n\t}\n\n\tif (setexp)\n\t\tcommand_setexposure(gspca_dev);\n\n\tif (setfps)\n\t\tcommand_setsensorfps(gspca_dev);\n\n\tif (setflicker)\n\t\tcommand_setflickerctrl(gspca_dev);\n}\n\n \n \nstatic void restart_flicker(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint cam_exposure, old_exp;\n\n\tif (!FIRMWARE_VERSION(1, 2))\n\t\treturn;\n\n\tcam_exposure = atomic_read(&sd->cam_exposure);\n\n\tif (sd->params.flickerControl.flickerMode == 0 ||\n\t    cam_exposure == 0)\n\t\treturn;\n\n\told_exp = sd->params.exposure.coarseExpLo +\n\t\t  sd->params.exposure.coarseExpHi*256;\n\t \n\tcam_exposure %= sd->params.flickerControl.coarseJump;\n\tif (!sd->params.flickerControl.disabled &&\n\t    cam_exposure <= sd->params.flickerControl.coarseJump - 3) {\n\t\t \n\t\tsd->params.flickerControl.disabled = 1;\n\t}\n\n\tif (sd->params.flickerControl.disabled &&\n\t    old_exp > sd->params.flickerControl.coarseJump +\n\t\t      ROUND_UP_EXP_FOR_FLICKER) {\n\t\t \n\t\tset_flicker(gspca_dev, 1, 1);\n\t}\n}\n\n \nstatic int sd_config(struct gspca_dev *gspca_dev,\n\t\t\tconst struct usb_device_id *id)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tstruct cam *cam;\n\n\tsd->mainsFreq = FREQ_DEF == V4L2_CID_POWER_LINE_FREQUENCY_60HZ;\n\treset_camera_params(gspca_dev);\n\n\tgspca_dbg(gspca_dev, D_PROBE, \"cpia CPiA camera detected (vid/pid 0x%04X:0x%04X)\\n\",\n\t\t  id->idVendor, id->idProduct);\n\n\tcam = &gspca_dev->cam;\n\tcam->cam_mode = mode;\n\tcam->nmodes = ARRAY_SIZE(mode);\n\n\tgoto_low_power(gspca_dev);\n\t \n\tsd->params.version.firmwareVersion = 0;\n\tget_version_information(gspca_dev);\n\tif (sd->params.version.firmwareVersion != 1) {\n\t\tgspca_err(gspca_dev, \"only firmware version 1 is supported (got: %d)\\n\",\n\t\t\t  sd->params.version.firmwareVersion);\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tif (sd->params.version.firmwareRevision <= 2 &&\n\t    sd->params.exposure.gainMode > 2) {\n\t\tsd->params.exposure.gainMode = 2;\n\t}\n\n\t \n\tsd->params.qx3.qx3_detected = (sd->params.pnpID.vendor == 0x0813 &&\n\t\t\t\t       sd->params.pnpID.product == 0x0001);\n\treturn 0;\n}\n\n \nstatic int sd_start(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint priv, ret;\n\n\t \n\tif (goto_low_power(gspca_dev)) {\n\t\tif (sd->params.status.systemState != WARM_BOOT_STATE) {\n\t\t\tgspca_err(gspca_dev, \"unexpected systemstate: %02x\\n\",\n\t\t\t\t  sd->params.status.systemState);\n\t\t\tprintstatus(gspca_dev, &sd->params);\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\t \n\t\tret = goto_high_power(gspca_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = do_command(gspca_dev, CPIA_COMMAND_DiscardFrame,\n\t\t\t\t 0, 0, 0, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = goto_low_power(gspca_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\n\t \n\tsd->params.version.firmwareVersion = 0;\n\tget_version_information(gspca_dev);\n\n\t \n\n\t \n\tret = do_command(gspca_dev, CPIA_COMMAND_ModifyCameraStatus,\n\t\t\t STREAMSTATE, 0, STREAM_NOT_READY, 0);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = goto_high_power(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = do_command(gspca_dev, CPIA_COMMAND_GetCameraStatus, 0, 0, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tif (sd->params.status.fatalError) {\n\t\tgspca_err(gspca_dev, \"fatal_error: %04x, vp_status: %04x\\n\",\n\t\t\t  sd->params.status.fatalError,\n\t\t\t  sd->params.status.vpStatus);\n\t\treturn -EIO;\n\t}\n\n\t \n\tret = do_command(gspca_dev, CPIA_COMMAND_GetVPVersion, 0, 0, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tsd->params.streamStartLine = 120;\n\n\tpriv = gspca_dev->cam.cam_mode[gspca_dev->curr_mode].priv;\n\tif (priv & 0x01) {  \n\t\tsd->params.roi.colStart = 2;\n\t\tsd->params.roi.rowStart = 6;\n\t} else {\n\t\tsd->params.roi.colStart = 0;\n\t\tsd->params.roi.rowStart = 0;\n\t}\n\n\tif (priv & 0x02) {  \n\t\tsd->params.format.videoSize = VIDEOSIZE_QCIF;\n\t\tsd->params.roi.colStart /= 2;\n\t\tsd->params.roi.rowStart /= 2;\n\t\tsd->params.streamStartLine /= 2;\n\t} else\n\t\tsd->params.format.videoSize = VIDEOSIZE_CIF;\n\n\tsd->params.roi.colEnd = sd->params.roi.colStart +\n\t\t\t\t(gspca_dev->pixfmt.width >> 3);\n\tsd->params.roi.rowEnd = sd->params.roi.rowStart +\n\t\t\t\t(gspca_dev->pixfmt.height >> 2);\n\n\t \n\tret = do_command(gspca_dev, CPIA_COMMAND_SetGrabMode,\n\t\t\t CPIA_GRAB_CONTINEOUS, 0, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\t \n\tret = do_command(gspca_dev, CPIA_COMMAND_SetCompression,\n\t\t\t CPIA_COMPRESSION_NONE,\n\t\t\t NO_DECIMATION, 0, 0);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setcompressiontarget(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setcolourparams(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setformat(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setyuvtresh(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setecptiming(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setcompressionparams(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setexposure(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setcolourbalance(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setsensorfps(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setapcor(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setflickerctrl(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\tret = command_setvloffset(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = command_resume(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tsd->first_frame = 6;\n\tsd->exposure_status = EXPOSURE_NORMAL;\n\tsd->exposure_count = 0;\n\tatomic_set(&sd->cam_exposure, 0);\n\tatomic_set(&sd->fps, 0);\n\n\treturn 0;\n}\n\nstatic void sd_stopN(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd __maybe_unused = (struct sd *) gspca_dev;\n\n\tcommand_pause(gspca_dev);\n\n\t \n\tsave_camera_state(gspca_dev);\n\n\t \n\tgoto_low_power(gspca_dev);\n\n\t \n\tdo_command(gspca_dev, CPIA_COMMAND_GetCameraStatus, 0, 0, 0, 0);\n\n#if IS_ENABLED(CONFIG_INPUT)\n\t \n\tif (sd->params.qx3.button) {\n\t\t \n\t\tinput_report_key(gspca_dev->input_dev, KEY_CAMERA, 0);\n\t\tinput_sync(gspca_dev->input_dev);\n\t}\n#endif\n}\n\n \nstatic int sd_init(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\tint ret;\n\n\t \n\tret = sd_start(gspca_dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (sd->params.qx3.qx3_detected)\n\t\tcommand_setlights(gspca_dev);\n\n\tsd_stopN(gspca_dev);\n\n\tgspca_dbg(gspca_dev, D_PROBE, \"CPIA Version:             %d.%02d (%d.%d)\\n\",\n\t\t  sd->params.version.firmwareVersion,\n\t\t  sd->params.version.firmwareRevision,\n\t\t  sd->params.version.vcVersion,\n\t\t  sd->params.version.vcRevision);\n\tgspca_dbg(gspca_dev, D_PROBE, \"CPIA PnP-ID:              %04x:%04x:%04x\",\n\t\t  sd->params.pnpID.vendor, sd->params.pnpID.product,\n\t\t  sd->params.pnpID.deviceRevision);\n\tgspca_dbg(gspca_dev, D_PROBE, \"VP-Version:               %d.%d %04x\",\n\t\t  sd->params.vpVersion.vpVersion,\n\t\t  sd->params.vpVersion.vpRevision,\n\t\t  sd->params.vpVersion.cameraHeadID);\n\n\treturn 0;\n}\n\nstatic void sd_pkt_scan(struct gspca_dev *gspca_dev,\n\t\t\tu8 *data,\n\t\t\tint len)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\t \n\tif (len >= 64 &&\n\t    data[0] == MAGIC_0 && data[1] == MAGIC_1 &&\n\t    data[16] == sd->params.format.videoSize &&\n\t    data[17] == sd->params.format.subSample &&\n\t    data[18] == sd->params.format.yuvOrder &&\n\t    data[24] == sd->params.roi.colStart &&\n\t    data[25] == sd->params.roi.colEnd &&\n\t    data[26] == sd->params.roi.rowStart &&\n\t    data[27] == sd->params.roi.rowEnd) {\n\t\tu8 *image;\n\n\t\tatomic_set(&sd->cam_exposure, data[39] * 2);\n\t\tatomic_set(&sd->fps, data[41]);\n\n\t\t \n\t\timage = gspca_dev->image;\n\t\tif (image != NULL &&\n\t\t    gspca_dev->image_len > 4 &&\n\t\t    image[gspca_dev->image_len - 4] == 0xff &&\n\t\t    image[gspca_dev->image_len - 3] == 0xff &&\n\t\t    image[gspca_dev->image_len - 2] == 0xff &&\n\t\t    image[gspca_dev->image_len - 1] == 0xff)\n\t\t\tgspca_frame_add(gspca_dev, LAST_PACKET,\n\t\t\t\t\t\tNULL, 0);\n\n\t\tgspca_frame_add(gspca_dev, FIRST_PACKET, data, len);\n\t\treturn;\n\t}\n\n\tgspca_frame_add(gspca_dev, INTER_PACKET, data, len);\n}\n\nstatic void sd_dq_callback(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *) gspca_dev;\n\n\t \n\tif (sd->first_frame) {\n\t\tsd->first_frame--;\n\t\tif (sd->first_frame == 0)\n\t\t\tcommand_setcompression(gspca_dev);\n\t}\n\n\t \n\trestart_flicker(gspca_dev);\n\n\t \n\tif (sd->params.exposure.expMode == 2)\n\t\tmonitor_exposure(gspca_dev);\n\n\t \n\tdo_command(gspca_dev, CPIA_COMMAND_GetExposure, 0, 0, 0, 0);\n\tdo_command(gspca_dev, CPIA_COMMAND_ReadMCPorts, 0, 0, 0, 0);\n}\n\nstatic int sd_s_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct gspca_dev *gspca_dev =\n\t\tcontainer_of(ctrl->handler, struct gspca_dev, ctrl_handler);\n\tstruct sd *sd = (struct sd *)gspca_dev;\n\n\tgspca_dev->usb_err = 0;\n\n\tif (!gspca_dev->streaming && ctrl->id != V4L2_CID_POWER_LINE_FREQUENCY)\n\t\treturn 0;\n\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_BRIGHTNESS:\n\t\tsd->params.colourParams.brightness = ctrl->val;\n\t\tsd->params.flickerControl.allowableOverExposure =\n\t\t\tfind_over_exposure(sd->params.colourParams.brightness);\n\t\tgspca_dev->usb_err = command_setcolourparams(gspca_dev);\n\t\tif (!gspca_dev->usb_err)\n\t\t\tgspca_dev->usb_err = command_setflickerctrl(gspca_dev);\n\t\tbreak;\n\tcase V4L2_CID_CONTRAST:\n\t\tsd->params.colourParams.contrast = ctrl->val;\n\t\tgspca_dev->usb_err = command_setcolourparams(gspca_dev);\n\t\tbreak;\n\tcase V4L2_CID_SATURATION:\n\t\tsd->params.colourParams.saturation = ctrl->val;\n\t\tgspca_dev->usb_err = command_setcolourparams(gspca_dev);\n\t\tbreak;\n\tcase V4L2_CID_POWER_LINE_FREQUENCY:\n\t\tsd->mainsFreq = ctrl->val == V4L2_CID_POWER_LINE_FREQUENCY_60HZ;\n\t\tsd->params.flickerControl.coarseJump =\n\t\t\tflicker_jumps[sd->mainsFreq]\n\t\t\t[sd->params.sensorFps.baserate]\n\t\t\t[sd->params.sensorFps.divisor];\n\n\t\tgspca_dev->usb_err = set_flicker(gspca_dev,\n\t\t\tctrl->val != V4L2_CID_POWER_LINE_FREQUENCY_DISABLED,\n\t\t\tgspca_dev->streaming);\n\t\tbreak;\n\tcase V4L2_CID_ILLUMINATORS_1:\n\t\tsd->params.qx3.bottomlight = ctrl->val;\n\t\tgspca_dev->usb_err = command_setlights(gspca_dev);\n\t\tbreak;\n\tcase V4L2_CID_ILLUMINATORS_2:\n\t\tsd->params.qx3.toplight = ctrl->val;\n\t\tgspca_dev->usb_err = command_setlights(gspca_dev);\n\t\tbreak;\n\tcase CPIA1_CID_COMP_TARGET:\n\t\tsd->params.compressionTarget.frTargeting = ctrl->val;\n\t\tgspca_dev->usb_err = command_setcompressiontarget(gspca_dev);\n\t\tbreak;\n\t}\n\treturn gspca_dev->usb_err;\n}\n\nstatic const struct v4l2_ctrl_ops sd_ctrl_ops = {\n\t.s_ctrl = sd_s_ctrl,\n};\n\nstatic int sd_init_controls(struct gspca_dev *gspca_dev)\n{\n\tstruct sd *sd = (struct sd *)gspca_dev;\n\tstruct v4l2_ctrl_handler *hdl = &gspca_dev->ctrl_handler;\n\tstatic const char * const comp_target_menu[] = {\n\t\t\"Quality\",\n\t\t\"Framerate\",\n\t\tNULL\n\t};\n\tstatic const struct v4l2_ctrl_config comp_target = {\n\t\t.ops = &sd_ctrl_ops,\n\t\t.id = CPIA1_CID_COMP_TARGET,\n\t\t.type = V4L2_CTRL_TYPE_MENU,\n\t\t.name = \"Compression Target\",\n\t\t.qmenu = comp_target_menu,\n\t\t.max = 1,\n\t\t.def = COMP_TARGET_DEF,\n\t};\n\n\tgspca_dev->vdev.ctrl_handler = hdl;\n\tv4l2_ctrl_handler_init(hdl, 7);\n\tv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\n\t\t\tV4L2_CID_BRIGHTNESS, 0, 100, 1, BRIGHTNESS_DEF);\n\tv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\n\t\t\tV4L2_CID_CONTRAST, 0, 96, 8, CONTRAST_DEF);\n\tv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\n\t\t\tV4L2_CID_SATURATION, 0, 100, 1, SATURATION_DEF);\n\tsd->freq = v4l2_ctrl_new_std_menu(hdl, &sd_ctrl_ops,\n\t\t\tV4L2_CID_POWER_LINE_FREQUENCY,\n\t\t\tV4L2_CID_POWER_LINE_FREQUENCY_60HZ, 0,\n\t\t\tFREQ_DEF);\n\tif (sd->params.qx3.qx3_detected) {\n\t\tv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\n\t\t\t\tV4L2_CID_ILLUMINATORS_1, 0, 1, 1,\n\t\t\t\tILLUMINATORS_1_DEF);\n\t\tv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\n\t\t\t\tV4L2_CID_ILLUMINATORS_2, 0, 1, 1,\n\t\t\t\tILLUMINATORS_2_DEF);\n\t}\n\tv4l2_ctrl_new_custom(hdl, &comp_target, NULL);\n\n\tif (hdl->error) {\n\t\tpr_err(\"Could not initialize controls\\n\");\n\t\treturn hdl->error;\n\t}\n\treturn 0;\n}\n\n \nstatic const struct sd_desc sd_desc = {\n\t.name = MODULE_NAME,\n\t.config = sd_config,\n\t.init = sd_init,\n\t.init_controls = sd_init_controls,\n\t.start = sd_start,\n\t.stopN = sd_stopN,\n\t.dq_callback = sd_dq_callback,\n\t.pkt_scan = sd_pkt_scan,\n#if IS_ENABLED(CONFIG_INPUT)\n\t.other_input = 1,\n#endif\n};\n\n \nstatic const struct usb_device_id device_table[] = {\n\t{USB_DEVICE(0x0553, 0x0002)},\n\t{USB_DEVICE(0x0813, 0x0001)},\n\t{}\n};\nMODULE_DEVICE_TABLE(usb, device_table);\n\n \nstatic int sd_probe(struct usb_interface *intf,\n\t\t\tconst struct usb_device_id *id)\n{\n\treturn gspca_dev_probe(intf, id, &sd_desc, sizeof(struct sd),\n\t\t\t\tTHIS_MODULE);\n}\n\nstatic struct usb_driver sd_driver = {\n\t.name = MODULE_NAME,\n\t.id_table = device_table,\n\t.probe = sd_probe,\n\t.disconnect = gspca_disconnect,\n#ifdef CONFIG_PM\n\t.suspend = gspca_suspend,\n\t.resume = gspca_resume,\n\t.reset_resume = gspca_resume,\n#endif\n};\n\nmodule_usb_driver(sd_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}