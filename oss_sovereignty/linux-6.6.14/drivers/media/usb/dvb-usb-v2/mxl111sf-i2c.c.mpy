{
  "module_name": "mxl111sf-i2c.c",
  "hash_id": "02492d6883ee2bf356fbc479efa5406f4a09505a53b85160781832199f951907",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/dvb-usb-v2/mxl111sf-i2c.c",
  "human_readable_source": "\n \n\n#include \"mxl111sf-i2c.h\"\n#include \"mxl111sf.h\"\n\n \n\n#define SW_I2C_ADDR\t\t0x1a\n#define SW_I2C_EN\t\t0x02\n#define SW_SCL_OUT\t\t0x04\n#define SW_SDA_OUT\t\t0x08\n#define SW_SDA_IN\t\t0x04\n\n#define SW_I2C_BUSY_ADDR\t0x2f\n#define SW_I2C_BUSY\t\t0x02\n\nstatic int mxl111sf_i2c_bitbang_sendbyte(struct mxl111sf_state *state,\n\t\t\t\t\t u8 byte)\n{\n\tint i, ret;\n\tu8 data = 0;\n\n\tmxl_i2c(\"(0x%02x)\", byte);\n\n\tret = mxl111sf_read_reg(state, SW_I2C_BUSY_ADDR, &data);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tfor (i = 0; i < 8; i++) {\n\n\t\tdata = (byte & (0x80 >> i)) ? SW_SDA_OUT : 0;\n\n\t\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t\t 0x10 | SW_I2C_EN | data);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\n\t\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t\t 0x10 | SW_I2C_EN | data | SW_SCL_OUT);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\n\t\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t\t 0x10 | SW_I2C_EN | data);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\t}\n\n\t \n\tif (!(byte & 1)) {\n\t\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t\t 0x10 | SW_I2C_EN | SW_SDA_OUT);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\t}\n\n\t \n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SCL_OUT | SW_SDA_OUT);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tret = mxl111sf_read_reg(state, SW_I2C_BUSY_ADDR, &data);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\t \n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SDA_OUT);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tif (data & SW_SDA_IN)\n\t\tret = -EIO;\nfail:\n\treturn ret;\n}\n\nstatic int mxl111sf_i2c_bitbang_recvbyte(struct mxl111sf_state *state,\n\t\t\t\t\t u8 *pbyte)\n{\n\tint i, ret;\n\tu8 byte = 0;\n\tu8 data = 0;\n\n\tmxl_i2c(\"()\");\n\n\t*pbyte = 0;\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SDA_OUT);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tfor (i = 0; i < 8; i++) {\n\t\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t\t 0x10 | SW_I2C_EN |\n\t\t\t\t\t SW_SCL_OUT | SW_SDA_OUT);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\n\t\tret = mxl111sf_read_reg(state, SW_I2C_BUSY_ADDR, &data);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\n\t\tif (data & SW_SDA_IN)\n\t\t\tbyte |= (0x80 >> i);\n\n\t\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t\t 0x10 | SW_I2C_EN | SW_SDA_OUT);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\t}\n\t*pbyte = byte;\nfail:\n\treturn ret;\n}\n\nstatic int mxl111sf_i2c_start(struct mxl111sf_state *state)\n{\n\tint ret;\n\n\tmxl_i2c(\"()\");\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SCL_OUT | SW_SDA_OUT);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SCL_OUT);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN);  \n\tmxl_fail(ret);\nfail:\n\treturn ret;\n}\n\nstatic int mxl111sf_i2c_stop(struct mxl111sf_state *state)\n{\n\tint ret;\n\n\tmxl_i2c(\"()\");\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN);  \n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SCL_OUT);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SCL_OUT | SW_SDA_OUT);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_SCL_OUT | SW_SDA_OUT);\n\tmxl_fail(ret);\nfail:\n\treturn ret;\n}\n\nstatic int mxl111sf_i2c_ack(struct mxl111sf_state *state)\n{\n\tint ret;\n\tu8 b = 0;\n\n\tmxl_i2c(\"()\");\n\n\tret = mxl111sf_read_reg(state, SW_I2C_BUSY_ADDR, &b);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\t \n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SCL_OUT);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SDA_OUT);\n\tmxl_fail(ret);\nfail:\n\treturn ret;\n}\n\nstatic int mxl111sf_i2c_nack(struct mxl111sf_state *state)\n{\n\tint ret;\n\n\tmxl_i2c(\"()\");\n\n\t \n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SCL_OUT | SW_SDA_OUT);\n\tif (mxl_fail(ret))\n\t\tgoto fail;\n\n\tret = mxl111sf_write_reg(state, SW_I2C_ADDR,\n\t\t\t\t 0x10 | SW_I2C_EN | SW_SDA_OUT);\n\tmxl_fail(ret);\nfail:\n\treturn ret;\n}\n\n \n\nstatic int mxl111sf_i2c_sw_xfer_msg(struct mxl111sf_state *state,\n\t\t\t\t    struct i2c_msg *msg)\n{\n\tint i, ret;\n\n\tmxl_i2c(\"()\");\n\n\tif (msg->flags & I2C_M_RD) {\n\n\t\tret = mxl111sf_i2c_start(state);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\n\t\tret = mxl111sf_i2c_bitbang_sendbyte(state,\n\t\t\t\t\t\t    (msg->addr << 1) | 0x01);\n\t\tif (mxl_fail(ret)) {\n\t\t\tmxl111sf_i2c_stop(state);\n\t\t\tgoto fail;\n\t\t}\n\n\t\tfor (i = 0; i < msg->len; i++) {\n\t\t\tret = mxl111sf_i2c_bitbang_recvbyte(state,\n\t\t\t\t\t\t\t    &msg->buf[i]);\n\t\t\tif (mxl_fail(ret)) {\n\t\t\t\tmxl111sf_i2c_stop(state);\n\t\t\t\tgoto fail;\n\t\t\t}\n\n\t\t\tif (i < msg->len - 1)\n\t\t\t\tmxl111sf_i2c_ack(state);\n\t\t}\n\n\t\tmxl111sf_i2c_nack(state);\n\n\t\tret = mxl111sf_i2c_stop(state);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\n\t} else {\n\n\t\tret = mxl111sf_i2c_start(state);\n\t\tif (mxl_fail(ret))\n\t\t\tgoto fail;\n\n\t\tret = mxl111sf_i2c_bitbang_sendbyte(state,\n\t\t\t\t\t\t    (msg->addr << 1) & 0xfe);\n\t\tif (mxl_fail(ret)) {\n\t\t\tmxl111sf_i2c_stop(state);\n\t\t\tgoto fail;\n\t\t}\n\n\t\tfor (i = 0; i < msg->len; i++) {\n\t\t\tret = mxl111sf_i2c_bitbang_sendbyte(state,\n\t\t\t\t\t\t\t    msg->buf[i]);\n\t\t\tif (mxl_fail(ret)) {\n\t\t\t\tmxl111sf_i2c_stop(state);\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tmxl111sf_i2c_stop(state);\n\t}\nfail:\n\treturn ret;\n}\n\n \n\n#define USB_WRITE_I2C_CMD     0x99\n#define USB_READ_I2C_CMD      0xdd\n#define USB_END_I2C_CMD       0xfe\n\n#define USB_WRITE_I2C_CMD_LEN   26\n#define USB_READ_I2C_CMD_LEN    24\n\n#define I2C_MUX_REG           0x30\n#define I2C_CONTROL_REG       0x00\n#define I2C_SLAVE_ADDR_REG    0x08\n#define I2C_DATA_REG          0x0c\n#define I2C_INT_STATUS_REG    0x10\n\nstatic int mxl111sf_i2c_send_data(struct mxl111sf_state *state,\n\t\t\t\t  u8 index, u8 *wdata)\n{\n\tint ret = mxl111sf_ctrl_msg(state, wdata[0],\n\t\t\t\t    &wdata[1], 25, NULL, 0);\n\tmxl_fail(ret);\n\n\treturn ret;\n}\n\nstatic int mxl111sf_i2c_get_data(struct mxl111sf_state *state,\n\t\t\t\t u8 index, u8 *wdata, u8 *rdata)\n{\n\tint ret = mxl111sf_ctrl_msg(state, wdata[0],\n\t\t\t\t    &wdata[1], 25, rdata, 24);\n\tmxl_fail(ret);\n\n\treturn ret;\n}\n\nstatic u8 mxl111sf_i2c_check_status(struct mxl111sf_state *state)\n{\n\tu8 status = 0;\n\tu8 buf[26];\n\n\tmxl_i2c_adv(\"()\");\n\n\tbuf[0] = USB_READ_I2C_CMD;\n\tbuf[1] = 0x00;\n\n\tbuf[2] = I2C_INT_STATUS_REG;\n\tbuf[3] = 0x00;\n\tbuf[4] = 0x00;\n\n\tbuf[5] = USB_END_I2C_CMD;\n\n\tmxl111sf_i2c_get_data(state, 0, buf, buf);\n\n\tif (buf[1] & 0x04)\n\t\tstatus = 1;\n\n\treturn status;\n}\n\nstatic u8 mxl111sf_i2c_check_fifo(struct mxl111sf_state *state)\n{\n\tu8 status = 0;\n\tu8 buf[26];\n\n\tmxl_i2c(\"()\");\n\n\tbuf[0] = USB_READ_I2C_CMD;\n\tbuf[1] = 0x00;\n\n\tbuf[2] = I2C_MUX_REG;\n\tbuf[3] = 0x00;\n\tbuf[4] = 0x00;\n\n\tbuf[5] = I2C_INT_STATUS_REG;\n\tbuf[6] = 0x00;\n\tbuf[7] = 0x00;\n\tbuf[8] = USB_END_I2C_CMD;\n\n\tmxl111sf_i2c_get_data(state, 0, buf, buf);\n\n\tif (0x08 == (buf[1] & 0x08))\n\t\tstatus = 1;\n\n\tif ((buf[5] & 0x02) == 0x02)\n\t\tmxl_i2c(\"(buf[5] & 0x02) == 0x02\");  \n\n\treturn status;\n}\n\nstatic int mxl111sf_i2c_readagain(struct mxl111sf_state *state,\n\t\t\t\t  u8 count, u8 *rbuf)\n{\n\tu8 i2c_w_data[26];\n\tu8 i2c_r_data[24];\n\tu8 i = 0;\n\tu8 fifo_status = 0;\n\tint status = 0;\n\n\tmxl_i2c(\"read %d bytes\", count);\n\n\twhile ((fifo_status == 0) && (i++ < 5))\n\t\tfifo_status = mxl111sf_i2c_check_fifo(state);\n\n\ti2c_w_data[0] = 0xDD;\n\ti2c_w_data[1] = 0x00;\n\n\tfor (i = 2; i < 26; i++)\n\t\ti2c_w_data[i] = 0xFE;\n\n\tfor (i = 0; i < count; i++) {\n\t\ti2c_w_data[2+(i*3)] = 0x0C;\n\t\ti2c_w_data[3+(i*3)] = 0x00;\n\t\ti2c_w_data[4+(i*3)] = 0x00;\n\t}\n\n\tmxl111sf_i2c_get_data(state, 0, i2c_w_data, i2c_r_data);\n\n\t \n\tif (mxl111sf_i2c_check_status(state) == 1) {\n\t\tmxl_i2c(\"error!\");\n\t} else {\n\t\tfor (i = 0; i < count; i++) {\n\t\t\trbuf[i] = i2c_r_data[(i*3)+1];\n\t\t\tmxl_i2c(\"%02x\\t %02x\",\n\t\t\t\ti2c_r_data[(i*3)+1],\n\t\t\t\ti2c_r_data[(i*3)+2]);\n\t\t}\n\n\t\tstatus = 1;\n\t}\n\n\treturn status;\n}\n\n#define HWI2C400 1\nstatic int mxl111sf_i2c_hw_xfer_msg(struct mxl111sf_state *state,\n\t\t\t\t    struct i2c_msg *msg)\n{\n\tint i, k, ret = 0;\n\tu16 index = 0;\n\tu8 buf[26];\n\tu8 i2c_r_data[24];\n\tu16 block_len;\n\tu16 left_over_len;\n\tu8 rd_status[8];\n\tu8 ret_status;\n\tu8 readbuff[26];\n\n\tmxl_i2c(\"addr: 0x%02x, read buff len: %d, write buff len: %d\",\n\t\tmsg->addr, (msg->flags & I2C_M_RD) ? msg->len : 0,\n\t\t(!(msg->flags & I2C_M_RD)) ? msg->len : 0);\n\n\tfor (index = 0; index < 26; index++)\n\t\tbuf[index] = USB_END_I2C_CMD;\n\n\t \n\tbuf[0] = USB_WRITE_I2C_CMD;\n\tbuf[1] = 0x00;\n\n\t \n\tbuf[2] = I2C_MUX_REG;\n\tbuf[3] = 0x80;\n\tbuf[4] = 0x00;\n\n\t \n\tbuf[5] = I2C_MUX_REG;\n\tbuf[6] = 0x81;\n\tbuf[7] = 0x00;\n\n\t \n\tbuf[8] = 0x14;\n\tbuf[9] = 0xff;\n\tbuf[10] = 0x00;\n#if 0\n\t \n\tbuf[8] = 0x24;\n\tbuf[9] = 0xF7;\n\tbuf[10] = 0x00;\n#endif\n\tbuf[11] = 0x24;\n\tbuf[12] = 0xF7;\n\tbuf[13] = 0x00;\n\n\tret = mxl111sf_i2c_send_data(state, 0, buf);\n\n\t \n\tif (!(msg->flags & I2C_M_RD) && (msg->len > 0)) {\n\t\tmxl_i2c(\"%d\\t%02x\", msg->len, msg->buf[0]);\n\n\t\t \n\t\tbuf[2] = I2C_CONTROL_REG;\n\t\tbuf[3] = 0x5E;\n\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\n\t\t \n\t\tbuf[5] = I2C_SLAVE_ADDR_REG;\n\t\tbuf[6] = (msg->addr);\n\t\tbuf[7] = 0x00;\n\t\tbuf[8] = USB_END_I2C_CMD;\n\t\tret = mxl111sf_i2c_send_data(state, 0, buf);\n\n\t\t \n\t\tif (mxl111sf_i2c_check_status(state) == 1) {\n\t\t\tmxl_i2c(\"NACK writing slave address %02x\",\n\t\t\t\tmsg->addr);\n\t\t\t \n\t\t\tbuf[2] = I2C_CONTROL_REG;\n\t\t\tbuf[3] = 0x4E;\n\t\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\t\t\tret = -EIO;\n\t\t\tgoto exit;\n\t\t}\n\n\t\t \n\t\tblock_len = (msg->len / 8);\n\t\tleft_over_len = (msg->len % 8);\n\n\t\tmxl_i2c(\"block_len %d, left_over_len %d\",\n\t\t\tblock_len, left_over_len);\n\n\t\tfor (index = 0; index < block_len; index++) {\n\t\t\tfor (i = 0; i < 8; i++) {\n\t\t\t\t \n\t\t\t\tbuf[2+(i*3)] = I2C_DATA_REG;\n\t\t\t\tbuf[3+(i*3)] = msg->buf[(index*8)+i];\n\t\t\t\tbuf[4+(i*3)] = 0x00;\n\t\t\t}\n\n\t\t\tret = mxl111sf_i2c_send_data(state, 0, buf);\n\n\t\t\t \n\t\t\tif (mxl111sf_i2c_check_status(state) == 1) {\n\t\t\t\tmxl_i2c(\"NACK writing slave address %02x\",\n\t\t\t\t\tmsg->addr);\n\n\t\t\t\t \n\t\t\t\tbuf[2] = I2C_CONTROL_REG;\n\t\t\t\tbuf[3] = 0x4E;\n\t\t\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\t\t\t\tret = -EIO;\n\t\t\t\tgoto exit;\n\t\t\t}\n\n\t\t}\n\n\t\tif (left_over_len) {\n\t\t\tfor (k = 0; k < 26; k++)\n\t\t\t\tbuf[k] = USB_END_I2C_CMD;\n\n\t\t\tbuf[0] = 0x99;\n\t\t\tbuf[1] = 0x00;\n\n\t\t\tfor (i = 0; i < left_over_len; i++) {\n\t\t\t\tbuf[2+(i*3)] = I2C_DATA_REG;\n\t\t\t\tbuf[3+(i*3)] = msg->buf[(index*8)+i];\n\t\t\t\tmxl_i2c(\"index = %d %d data %d\",\n\t\t\t\t\tindex, i, msg->buf[(index*8)+i]);\n\t\t\t\tbuf[4+(i*3)] = 0x00;\n\t\t\t}\n\t\t\tret = mxl111sf_i2c_send_data(state, 0, buf);\n\n\t\t\t \n\t\t\tif (mxl111sf_i2c_check_status(state) == 1) {\n\t\t\t\tmxl_i2c(\"NACK writing slave address %02x\",\n\t\t\t\t\tmsg->addr);\n\n\t\t\t\t \n\t\t\t\tbuf[2] = I2C_CONTROL_REG;\n\t\t\t\tbuf[3] = 0x4E;\n\t\t\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\t\t\t\tret = -EIO;\n\t\t\t\tgoto exit;\n\t\t\t}\n\n\t\t}\n\n\t\t \n\t\tbuf[2] = I2C_CONTROL_REG;\n\t\tbuf[3] = 0x4E;\n\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\n\t}\n\n\t \n\tif ((msg->flags & I2C_M_RD) && (msg->len > 0)) {\n\t\tmxl_i2c(\"read buf len %d\", msg->len);\n\n\t\t \n\t\tbuf[2] = I2C_CONTROL_REG;\n\t\tbuf[3] = 0xDF;\n\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\n\t\t \n\t\tbuf[5] = 0x14;\n\t\tbuf[6] = (msg->len & 0xFF);\n\t\tbuf[7] = 0;\n\n\t\t \n\t\tbuf[8] = I2C_SLAVE_ADDR_REG;\n\t\tbuf[9] = msg->addr;\n\t\tbuf[10] = 0x00;\n\t\tbuf[11] = USB_END_I2C_CMD;\n\t\tret = mxl111sf_i2c_send_data(state, 0, buf);\n\n\t\t \n\t\tif (mxl111sf_i2c_check_status(state) == 1) {\n\t\t\tmxl_i2c(\"NACK reading slave address %02x\",\n\t\t\t\tmsg->addr);\n\n\t\t\t \n\t\t\tbuf[2] = I2C_CONTROL_REG;\n\t\t\tbuf[3] = 0xC7;\n\t\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\t\t\tret = -EIO;\n\t\t\tgoto exit;\n\t\t}\n\n\t\t \n\t\tblock_len = ((msg->len) / 8);\n\t\tleft_over_len = ((msg->len) % 8);\n\t\tindex = 0;\n\n\t\tmxl_i2c(\"block_len %d, left_over_len %d\",\n\t\t\tblock_len, left_over_len);\n\n\t\t \n\t\tbuf[0] = USB_READ_I2C_CMD;\n\t\tbuf[1] = 0x00;\n\n\t\tfor (index = 0; index < block_len; index++) {\n\t\t\t \n\t\t\tfor (i = 0; i < 8; i++) {\n\t\t\t\tbuf[2+(i*3)] = I2C_DATA_REG;\n\t\t\t\tbuf[3+(i*3)] = 0x00;\n\t\t\t\tbuf[4+(i*3)] = 0x00;\n\t\t\t}\n\n\t\t\tret = mxl111sf_i2c_get_data(state, 0, buf, i2c_r_data);\n\n\t\t\t \n\t\t\tif (mxl111sf_i2c_check_status(state) == 1) {\n\t\t\t\tmxl_i2c(\"NACK reading slave address %02x\",\n\t\t\t\t\tmsg->addr);\n\n\t\t\t\t \n\t\t\t\tbuf[2] = I2C_CONTROL_REG;\n\t\t\t\tbuf[3] = 0xC7;\n\t\t\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\t\t\t\tret = -EIO;\n\t\t\t\tgoto exit;\n\t\t\t}\n\n\t\t\t \n\t\t\tfor (i = 0; i < 8; i++) {\n\t\t\t\trd_status[i] = i2c_r_data[(i*3)+2];\n\n\t\t\t\tif (rd_status[i] == 0x04) {\n\t\t\t\t\tif (i < 7) {\n\t\t\t\t\t\tmxl_i2c(\"i2c fifo empty! @ %d\",\n\t\t\t\t\t\t\ti);\n\t\t\t\t\t\tmsg->buf[(index*8)+i] =\n\t\t\t\t\t\t\ti2c_r_data[(i*3)+1];\n\t\t\t\t\t\t \n\t\t\t\t\t\tret_status =\n\t\t\t\t\t\t\tmxl111sf_i2c_readagain(\n\t\t\t\t\t\t\t\tstate, 8-(i+1),\n\t\t\t\t\t\t\t\treadbuff);\n\t\t\t\t\t\tif (ret_status == 1) {\n\t\t\t\t\t\t\tfor (k = 0;\n\t\t\t\t\t\t\t     k < 8-(i+1);\n\t\t\t\t\t\t\t     k++) {\n\n\t\t\t\t\tmsg->buf[(index*8)+(k+i+1)] =\n\t\t\t\t\t\treadbuff[k];\n\t\t\t\t\tmxl_i2c(\"read data: %02x\\t %02x\",\n\t\t\t\t\t\tmsg->buf[(index*8)+(k+i)],\n\t\t\t\t\t\t(index*8)+(k+i));\n\t\t\t\t\tmxl_i2c(\"read data: %02x\\t %02x\",\n\t\t\t\t\t\tmsg->buf[(index*8)+(k+i+1)],\n\t\t\t\t\t\treadbuff[k]);\n\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tgoto stop_copy;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tmxl_i2c(\"readagain ERROR!\");\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmsg->buf[(index*8)+i] =\n\t\t\t\t\t\t\ti2c_r_data[(i*3)+1];\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tmsg->buf[(index*8)+i] =\n\t\t\t\t\t\ti2c_r_data[(i*3)+1];\n\t\t\t\t}\n\t\t\t}\nstop_copy:\n\t\t\t;\n\n\t\t}\n\n\t\tif (left_over_len) {\n\t\t\tfor (k = 0; k < 26; k++)\n\t\t\t\tbuf[k] = USB_END_I2C_CMD;\n\n\t\t\tbuf[0] = 0xDD;\n\t\t\tbuf[1] = 0x00;\n\n\t\t\tfor (i = 0; i < left_over_len; i++) {\n\t\t\t\tbuf[2+(i*3)] = I2C_DATA_REG;\n\t\t\t\tbuf[3+(i*3)] = 0x00;\n\t\t\t\tbuf[4+(i*3)] = 0x00;\n\t\t\t}\n\t\t\tret = mxl111sf_i2c_get_data(state, 0, buf,\n\t\t\t\t\t\t    i2c_r_data);\n\n\t\t\t \n\t\t\tif (mxl111sf_i2c_check_status(state) == 1) {\n\t\t\t\tmxl_i2c(\"NACK reading slave address %02x\",\n\t\t\t\t\tmsg->addr);\n\n\t\t\t\t \n\t\t\t\tbuf[2] = I2C_CONTROL_REG;\n\t\t\t\tbuf[3] = 0xC7;\n\t\t\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\t\t\t\tret = -EIO;\n\t\t\t\tgoto exit;\n\t\t\t}\n\n\t\t\tfor (i = 0; i < left_over_len; i++) {\n\t\t\t\tmsg->buf[(block_len*8)+i] =\n\t\t\t\t\ti2c_r_data[(i*3)+1];\n\t\t\t\tmxl_i2c(\"read data: %02x\\t %02x\",\n\t\t\t\t\ti2c_r_data[(i*3)+1],\n\t\t\t\t\ti2c_r_data[(i*3)+2]);\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tbuf[0] = USB_WRITE_I2C_CMD;\n\t\tbuf[1] = 0x00;\n\n\t\t \n\t\tbuf[2] = I2C_CONTROL_REG;\n\t\tbuf[3] = 0x17;\n\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\n\t\tbuf[5] = USB_END_I2C_CMD;\n\t\tret = mxl111sf_i2c_send_data(state, 0, buf);\n\n\t\t \n\t\tbuf[2] = I2C_CONTROL_REG;\n\t\tbuf[3] = 0xC7;\n\t\tbuf[4] = (HWI2C400) ? 0x03 : 0x0D;\n\n\t}\nexit:\n\t \n\tbuf[0] = USB_WRITE_I2C_CMD;\n\tbuf[1] = 0x00;\n\n\t \n\tbuf[5] = USB_END_I2C_CMD;\n\tmxl111sf_i2c_send_data(state, 0, buf);\n\n\t \n\tbuf[2] = I2C_CONTROL_REG;\n\tbuf[3] = 0xDF;\n\tbuf[4] = 0x03;\n\n\t \n\tbuf[5] = I2C_MUX_REG;\n\tbuf[6] = 0x00;\n\tbuf[7] = 0x00;\n\n\t \n\tbuf[8] = USB_END_I2C_CMD;\n\tmxl111sf_i2c_send_data(state, 0, buf);\n\n\t \n\tbuf[2] = I2C_MUX_REG;\n\tbuf[3] = 0x81;\n\tbuf[4] = 0x00;\n\n\t \n\tbuf[5] = I2C_MUX_REG;\n\tbuf[6] = 0x00;\n\tbuf[7] = 0x00;\n\n\t \n\tbuf[8] = I2C_MUX_REG;\n\tbuf[9] = 0x00;\n\tbuf[10] = 0x00;\n\n\tbuf[11] = USB_END_I2C_CMD;\n\tmxl111sf_i2c_send_data(state, 0, buf);\n\n\treturn ret;\n}\n\n \n\nint mxl111sf_i2c_xfer(struct i2c_adapter *adap,\n\t\t      struct i2c_msg msg[], int num)\n{\n\tstruct dvb_usb_device *d = i2c_get_adapdata(adap);\n\tstruct mxl111sf_state *state = d->priv;\n\tint hwi2c = (state->chip_rev > MXL111SF_V6);\n\tint i, ret;\n\n\tif (mutex_lock_interruptible(&d->i2c_mutex) < 0)\n\t\treturn -EAGAIN;\n\n\tfor (i = 0; i < num; i++) {\n\t\tret = (hwi2c) ?\n\t\t\tmxl111sf_i2c_hw_xfer_msg(state, &msg[i]) :\n\t\t\tmxl111sf_i2c_sw_xfer_msg(state, &msg[i]);\n\t\tif (mxl_fail(ret)) {\n\t\t\tmxl_debug_adv(\"failed with error %d on i2c transaction %d of %d, %sing %d bytes to/from 0x%02x\",\n\t\t\t\t      ret, i+1, num,\n\t\t\t\t      (msg[i].flags & I2C_M_RD) ?\n\t\t\t\t      \"read\" : \"writ\",\n\t\t\t\t      msg[i].len, msg[i].addr);\n\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tmutex_unlock(&d->i2c_mutex);\n\n\treturn i == num ? num : -EREMOTEIO;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}