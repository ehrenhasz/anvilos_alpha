{
  "module_name": "au0828-vbi.c",
  "hash_id": "fb7484ded3f86087eb06207354d635cb631c9f44521284af89452e01fbc0365b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/au0828/au0828-vbi.c",
  "human_readable_source": "\n \n\n#include \"au0828.h\"\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <media/v4l2-mc.h>\n\n \n\nstatic int vbi_queue_setup(struct vb2_queue *vq,\n\t\t\t   unsigned int *nbuffers, unsigned int *nplanes,\n\t\t\t   unsigned int sizes[], struct device *alloc_devs[])\n{\n\tstruct au0828_dev *dev = vb2_get_drv_priv(vq);\n\tunsigned long size = dev->vbi_width * dev->vbi_height * 2;\n\n\tif (*nplanes)\n\t\treturn sizes[0] < size ? -EINVAL : 0;\n\t*nplanes = 1;\n\tsizes[0] = size;\n\treturn 0;\n}\n\nstatic int vbi_buffer_prepare(struct vb2_buffer *vb)\n{\n\tstruct au0828_dev *dev = vb2_get_drv_priv(vb->vb2_queue);\n\tunsigned long size;\n\n\tsize = dev->vbi_width * dev->vbi_height * 2;\n\n\tif (vb2_plane_size(vb, 0) < size) {\n\t\tpr_err(\"%s data will not fit into plane (%lu < %lu)\\n\",\n\t\t\t__func__, vb2_plane_size(vb, 0), size);\n\t\treturn -EINVAL;\n\t}\n\tvb2_set_plane_payload(vb, 0, size);\n\n\treturn 0;\n}\n\nstatic void\nvbi_buffer_queue(struct vb2_buffer *vb)\n{\n\tstruct au0828_dev *dev = vb2_get_drv_priv(vb->vb2_queue);\n\tstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\n\tstruct au0828_buffer *buf =\n\t\t\tcontainer_of(vbuf, struct au0828_buffer, vb);\n\tstruct au0828_dmaqueue *vbiq = &dev->vbiq;\n\tunsigned long flags = 0;\n\n\tbuf->mem = vb2_plane_vaddr(vb, 0);\n\tbuf->length = vb2_plane_size(vb, 0);\n\n\tspin_lock_irqsave(&dev->slock, flags);\n\tlist_add_tail(&buf->list, &vbiq->active);\n\tspin_unlock_irqrestore(&dev->slock, flags);\n}\n\nconst struct vb2_ops au0828_vbi_qops = {\n\t.queue_setup     = vbi_queue_setup,\n\t.buf_prepare     = vbi_buffer_prepare,\n\t.buf_queue       = vbi_buffer_queue,\n\t.prepare_streaming = v4l_vb2q_enable_media_source,\n\t.start_streaming = au0828_start_analog_streaming,\n\t.stop_streaming  = au0828_stop_vbi_streaming,\n\t.wait_prepare    = vb2_ops_wait_prepare,\n\t.wait_finish     = vb2_ops_wait_finish,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}