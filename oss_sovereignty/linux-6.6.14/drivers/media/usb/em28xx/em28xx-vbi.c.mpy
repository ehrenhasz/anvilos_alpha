{
  "module_name": "em28xx-vbi.c",
  "hash_id": "d691c77158194a442ee4005b2b999e95bf135b4010067bd7891f606559197a71",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/em28xx/em28xx-vbi.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include \"em28xx.h\"\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/hardirq.h>\n#include <linux/init.h>\n#include <linux/usb.h>\n\n#include \"em28xx-v4l.h\"\n\n \n\nstatic int vbi_queue_setup(struct vb2_queue *vq,\n\t\t\t   unsigned int *nbuffers, unsigned int *nplanes,\n\t\t\t   unsigned int sizes[], struct device *alloc_devs[])\n{\n\tstruct em28xx *dev = vb2_get_drv_priv(vq);\n\tstruct em28xx_v4l2 *v4l2 = dev->v4l2;\n\tunsigned long size = v4l2->vbi_width * v4l2->vbi_height * 2;\n\n\tif (*nbuffers < 2)\n\t\t*nbuffers = 2;\n\n\tif (*nplanes) {\n\t\tif (sizes[0] < size)\n\t\t\treturn -EINVAL;\n\t\tsize = sizes[0];\n\t}\n\n\t*nplanes = 1;\n\tsizes[0] = size;\n\n\treturn 0;\n}\n\nstatic int vbi_buffer_prepare(struct vb2_buffer *vb)\n{\n\tstruct em28xx        *dev  = vb2_get_drv_priv(vb->vb2_queue);\n\tstruct em28xx_v4l2   *v4l2 = dev->v4l2;\n\tunsigned long        size;\n\n\tsize = v4l2->vbi_width * v4l2->vbi_height * 2;\n\n\tif (vb2_plane_size(vb, 0) < size) {\n\t\tdev_info(&dev->intf->dev,\n\t\t\t \"%s data will not fit into plane (%lu < %lu)\\n\",\n\t\t\t __func__, vb2_plane_size(vb, 0), size);\n\t\treturn -EINVAL;\n\t}\n\tvb2_set_plane_payload(vb, 0, size);\n\n\treturn 0;\n}\n\nstatic void\nvbi_buffer_queue(struct vb2_buffer *vb)\n{\n\tstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\n\tstruct em28xx *dev = vb2_get_drv_priv(vb->vb2_queue);\n\tstruct em28xx_buffer *buf =\n\t\tcontainer_of(vbuf, struct em28xx_buffer, vb);\n\tstruct em28xx_dmaqueue *vbiq = &dev->vbiq;\n\tunsigned long flags = 0;\n\n\tbuf->mem = vb2_plane_vaddr(vb, 0);\n\tbuf->length = vb2_plane_size(vb, 0);\n\n\tspin_lock_irqsave(&dev->slock, flags);\n\tlist_add_tail(&buf->list, &vbiq->active);\n\tspin_unlock_irqrestore(&dev->slock, flags);\n}\n\nconst struct vb2_ops em28xx_vbi_qops = {\n\t.queue_setup    = vbi_queue_setup,\n\t.buf_prepare    = vbi_buffer_prepare,\n\t.buf_queue      = vbi_buffer_queue,\n\t.start_streaming = em28xx_start_analog_streaming,\n\t.stop_streaming = em28xx_stop_vbi_streaming,\n\t.wait_prepare   = vb2_ops_wait_prepare,\n\t.wait_finish    = vb2_ops_wait_finish,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}