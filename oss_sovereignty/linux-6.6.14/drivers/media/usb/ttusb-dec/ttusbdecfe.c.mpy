{
  "module_name": "ttusbdecfe.c",
  "hash_id": "8e572df852a97dc9fc5f8c8b98b19e66badd9658ac3a714a254b49e3b180f114",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/ttusb-dec/ttusbdecfe.c",
  "human_readable_source": "\n \n\n#include <media/dvb_frontend.h>\n#include \"ttusbdecfe.h\"\n\n\n#define LOF_HI\t\t\t10600000\n#define LOF_LO\t\t\t9750000\n\nstruct ttusbdecfe_state {\n\n\t \n\tconst struct ttusbdecfe_config* config;\n\n\tstruct dvb_frontend frontend;\n\n\tu8 hi_band;\n\tu8 voltage;\n};\n\n\nstatic int ttusbdecfe_dvbs_read_status(struct dvb_frontend *fe,\n\t\t\t\t       enum fe_status *status)\n{\n\t*status = FE_HAS_SIGNAL | FE_HAS_VITERBI |\n\t\tFE_HAS_SYNC | FE_HAS_CARRIER | FE_HAS_LOCK;\n\treturn 0;\n}\n\n\nstatic int ttusbdecfe_dvbt_read_status(struct dvb_frontend *fe,\n\t\t\t\t       enum fe_status *status)\n{\n\tstruct ttusbdecfe_state* state = fe->demodulator_priv;\n\tu8 b[] = { 0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x00 };\n\tu8 result[4];\n\tint len, ret;\n\n\t*status=0;\n\n\tret=state->config->send_command(fe, 0x73, sizeof(b), b, &len, result);\n\tif(ret)\n\t\treturn ret;\n\n\tif(len != 4) {\n\t\tprintk(KERN_ERR \"%s: unexpected reply\\n\", __func__);\n\t\treturn -EIO;\n\t}\n\n\tswitch(result[3]) {\n\t\tcase 1:   \n\t\tcase 2:   \n\t\t\tbreak;\n\t\tcase 3:\t  \n\t\t\t*status = FE_HAS_SIGNAL | FE_HAS_VITERBI |\n\t\t\tFE_HAS_SYNC | FE_HAS_CARRIER | FE_HAS_LOCK;\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\t*status = FE_TIMEDOUT;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpr_info(\"%s: returned unknown value: %d\\n\",\n\t\t\t\t__func__, result[3]);\n\t\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic int ttusbdecfe_dvbt_set_frontend(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\tstruct ttusbdecfe_state *state = fe->demodulator_priv;\n\tu8 b[] = { 0x00, 0x00, 0x00, 0x03,\n\t\t   0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x01,\n\t\t   0x00, 0x00, 0x00, 0xff,\n\t\t   0x00, 0x00, 0x00, 0xff };\n\n\t__be32 freq = htonl(p->frequency / 1000);\n\tmemcpy(&b[4], &freq, sizeof (u32));\n\tstate->config->send_command(fe, 0x71, sizeof(b), b, NULL, NULL);\n\n\treturn 0;\n}\n\nstatic int ttusbdecfe_dvbt_get_tune_settings(struct dvb_frontend* fe,\n\t\t\t\t\tstruct dvb_frontend_tune_settings* fesettings)\n{\n\t\tfesettings->min_delay_ms = 1500;\n\t\t \n\t\tfesettings->step_size = 0;\n\t\tfesettings->max_drift = 0;\n\t\treturn 0;\n}\n\nstatic int ttusbdecfe_dvbs_set_frontend(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\tstruct ttusbdecfe_state *state = fe->demodulator_priv;\n\n\tu8 b[] = { 0x00, 0x00, 0x00, 0x01,\n\t\t   0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x01,\n\t\t   0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x00 };\n\t__be32 freq;\n\t__be32 sym_rate;\n\t__be32 band;\n\t__be32 lnb_voltage;\n\n\tfreq = htonl(p->frequency +\n\t       (state->hi_band ? LOF_HI : LOF_LO));\n\tmemcpy(&b[4], &freq, sizeof(u32));\n\tsym_rate = htonl(p->symbol_rate);\n\tmemcpy(&b[12], &sym_rate, sizeof(u32));\n\tband = htonl(state->hi_band ? LOF_HI : LOF_LO);\n\tmemcpy(&b[24], &band, sizeof(u32));\n\tlnb_voltage = htonl(state->voltage);\n\tmemcpy(&b[28], &lnb_voltage, sizeof(u32));\n\n\tstate->config->send_command(fe, 0x71, sizeof(b), b, NULL, NULL);\n\n\treturn 0;\n}\n\nstatic int ttusbdecfe_dvbs_diseqc_send_master_cmd(struct dvb_frontend* fe, struct dvb_diseqc_master_cmd *cmd)\n{\n\tstruct ttusbdecfe_state *state = fe->demodulator_priv;\n\tu8 b[] = { 0x00, 0xff, 0x00, 0x00,\n\t\t   0x00, 0x00, 0x00, 0x00,\n\t\t   0x00, 0x00 };\n\n\tif (cmd->msg_len > sizeof(b) - 4)\n\t\treturn -EINVAL;\n\n\tmemcpy(&b[4], cmd->msg, cmd->msg_len);\n\n\tstate->config->send_command(fe, 0x72,\n\t\t\t\t    sizeof(b) - (6 - cmd->msg_len), b,\n\t\t\t\t    NULL, NULL);\n\n\treturn 0;\n}\n\n\nstatic int ttusbdecfe_dvbs_set_tone(struct dvb_frontend *fe,\n\t\t\t\t    enum fe_sec_tone_mode tone)\n{\n\tstruct ttusbdecfe_state *state = fe->demodulator_priv;\n\n\tstate->hi_band = (SEC_TONE_ON == tone);\n\n\treturn 0;\n}\n\n\nstatic int ttusbdecfe_dvbs_set_voltage(struct dvb_frontend *fe,\n\t\t\t\t       enum fe_sec_voltage voltage)\n{\n\tstruct ttusbdecfe_state *state = fe->demodulator_priv;\n\n\tswitch (voltage) {\n\tcase SEC_VOLTAGE_13:\n\t\tstate->voltage = 13;\n\t\tbreak;\n\tcase SEC_VOLTAGE_18:\n\t\tstate->voltage = 18;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void ttusbdecfe_release(struct dvb_frontend* fe)\n{\n\tstruct ttusbdecfe_state *state = fe->demodulator_priv;\n\tkfree(state);\n}\n\nstatic const struct dvb_frontend_ops ttusbdecfe_dvbt_ops;\n\nstruct dvb_frontend* ttusbdecfe_dvbt_attach(const struct ttusbdecfe_config* config)\n{\n\tstruct ttusbdecfe_state* state = NULL;\n\n\t \n\tstate = kmalloc(sizeof(struct ttusbdecfe_state), GFP_KERNEL);\n\tif (state == NULL)\n\t\treturn NULL;\n\n\t \n\tstate->config = config;\n\n\t \n\tmemcpy(&state->frontend.ops, &ttusbdecfe_dvbt_ops, sizeof(struct dvb_frontend_ops));\n\tstate->frontend.demodulator_priv = state;\n\treturn &state->frontend;\n}\n\nstatic const struct dvb_frontend_ops ttusbdecfe_dvbs_ops;\n\nstruct dvb_frontend* ttusbdecfe_dvbs_attach(const struct ttusbdecfe_config* config)\n{\n\tstruct ttusbdecfe_state* state = NULL;\n\n\t \n\tstate = kmalloc(sizeof(struct ttusbdecfe_state), GFP_KERNEL);\n\tif (state == NULL)\n\t\treturn NULL;\n\n\t \n\tstate->config = config;\n\tstate->voltage = 0;\n\tstate->hi_band = 0;\n\n\t \n\tmemcpy(&state->frontend.ops, &ttusbdecfe_dvbs_ops, sizeof(struct dvb_frontend_ops));\n\tstate->frontend.demodulator_priv = state;\n\treturn &state->frontend;\n}\n\nstatic const struct dvb_frontend_ops ttusbdecfe_dvbt_ops = {\n\t.delsys = { SYS_DVBT },\n\t.info = {\n\t\t.name\t\t\t= \"TechnoTrend/Hauppauge DEC2000-t Frontend\",\n\t\t.frequency_min_hz\t=  51 * MHz,\n\t\t.frequency_max_hz\t= 858 * MHz,\n\t\t.frequency_stepsize_hz\t= 62500,\n\t\t.caps =\tFE_CAN_FEC_1_2 | FE_CAN_FEC_2_3 | FE_CAN_FEC_3_4 |\n\t\t\tFE_CAN_FEC_5_6 | FE_CAN_FEC_7_8 | FE_CAN_FEC_AUTO |\n\t\t\tFE_CAN_QAM_16 | FE_CAN_QAM_64 | FE_CAN_QAM_AUTO |\n\t\t\tFE_CAN_TRANSMISSION_MODE_AUTO | FE_CAN_GUARD_INTERVAL_AUTO |\n\t\t\tFE_CAN_HIERARCHY_AUTO,\n\t},\n\n\t.release = ttusbdecfe_release,\n\n\t.set_frontend = ttusbdecfe_dvbt_set_frontend,\n\n\t.get_tune_settings = ttusbdecfe_dvbt_get_tune_settings,\n\n\t.read_status = ttusbdecfe_dvbt_read_status,\n};\n\nstatic const struct dvb_frontend_ops ttusbdecfe_dvbs_ops = {\n\t.delsys = { SYS_DVBS },\n\t.info = {\n\t\t.name\t\t\t= \"TechnoTrend/Hauppauge DEC3000-s Frontend\",\n\t\t.frequency_min_hz\t=  950 * MHz,\n\t\t.frequency_max_hz\t= 2150 * MHz,\n\t\t.frequency_stepsize_hz\t=  125 * kHz,\n\t\t.symbol_rate_min        = 1000000,   \n\t\t.symbol_rate_max        = 45000000,  \n\t\t.caps =\tFE_CAN_FEC_1_2 | FE_CAN_FEC_2_3 | FE_CAN_FEC_3_4 |\n\t\t\tFE_CAN_FEC_5_6 | FE_CAN_FEC_7_8 | FE_CAN_FEC_AUTO |\n\t\t\tFE_CAN_QPSK\n\t},\n\n\t.release = ttusbdecfe_release,\n\n\t.set_frontend = ttusbdecfe_dvbs_set_frontend,\n\n\t.read_status = ttusbdecfe_dvbs_read_status,\n\n\t.diseqc_send_master_cmd = ttusbdecfe_dvbs_diseqc_send_master_cmd,\n\t.set_voltage = ttusbdecfe_dvbs_set_voltage,\n\t.set_tone = ttusbdecfe_dvbs_set_tone,\n};\n\nMODULE_DESCRIPTION(\"TTUSB DEC DVB-T/S Demodulator driver\");\nMODULE_AUTHOR(\"Alex Woods/Andrew de Quincey\");\nMODULE_LICENSE(\"GPL\");\n\nEXPORT_SYMBOL(ttusbdecfe_dvbt_attach);\nEXPORT_SYMBOL(ttusbdecfe_dvbs_attach);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}