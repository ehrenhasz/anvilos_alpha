{
  "module_name": "as102_fw.c",
  "hash_id": "48a4e9c8adb566a949054c96d20e4152a0722138a02e4b7022d1638caf824000",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/as102/as102_fw.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/ctype.h>\n#include <linux/delay.h>\n#include <linux/firmware.h>\n\n#include \"as102_drv.h\"\n#include \"as102_fw.h\"\n\nstatic const char as102_st_fw1[] = \"as102_data1_st.hex\";\nstatic const char as102_st_fw2[] = \"as102_data2_st.hex\";\nstatic const char as102_dt_fw1[] = \"as102_data1_dt.hex\";\nstatic const char as102_dt_fw2[] = \"as102_data2_dt.hex\";\n\nstatic unsigned char atohx(unsigned char *dst, char *src)\n{\n\tunsigned char value = 0;\n\n\tchar msb = tolower(*src) - '0';\n\tchar lsb = tolower(*(src + 1)) - '0';\n\n\tif (msb > 9)\n\t\tmsb -= 7;\n\tif (lsb > 9)\n\t\tlsb -= 7;\n\n\t*dst = value = ((msb & 0xF) << 4) | (lsb & 0xF);\n\treturn value;\n}\n\n \nstatic int parse_hex_line(unsigned char *fw_data, unsigned char *addr,\n\t\t\t  unsigned char *data, int *dataLength,\n\t\t\t  unsigned char *addr_has_changed) {\n\n\tint count = 0;\n\tunsigned char *src, dst;\n\n\tif (*fw_data++ != ':') {\n\t\tpr_err(\"invalid firmware file\\n\");\n\t\treturn -EFAULT;\n\t}\n\n\t \n\tfor (src = fw_data; *src != '\\n'; src += 2) {\n\t\tatohx(&dst, src);\n\t\t \n\t\tswitch (count) {\n\t\tcase 0:\n\t\t\t*dataLength = dst;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\taddr[2] = dst;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\taddr[3] = dst;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\t \n\t\t\tif (dst == 0x04)\n\t\t\t\t*addr_has_changed = 1;\n\t\t\telse\n\t\t\t\t*addr_has_changed = 0;\n\t\t\tbreak;\n\t\tcase  4:\n\t\tcase  5:\n\t\t\tif (*addr_has_changed)\n\t\t\t\taddr[(count - 4)] = dst;\n\t\t\telse\n\t\t\t\tdata[(count - 4)] = dst;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdata[(count - 4)] = dst;\n\t\t\tbreak;\n\t\t}\n\t\tcount++;\n\t}\n\n\t \n\treturn (count * 2) + 2;\n}\n\nstatic int as102_firmware_upload(struct as10x_bus_adapter_t *bus_adap,\n\t\t\t\t unsigned char *cmd,\n\t\t\t\t const struct firmware *firmware) {\n\n\tstruct as10x_fw_pkt_t *fw_pkt;\n\tint total_read_bytes = 0, errno = 0;\n\tunsigned char addr_has_changed = 0;\n\n\tfw_pkt = kmalloc(sizeof(*fw_pkt), GFP_KERNEL);\n\tif (!fw_pkt)\n\t\treturn -ENOMEM;\n\n\n\tfor (total_read_bytes = 0; total_read_bytes < firmware->size; ) {\n\t\tint read_bytes = 0, data_len = 0;\n\n\t\t \n\t\tread_bytes = parse_hex_line(\n\t\t\t\t(u8 *) (firmware->data + total_read_bytes),\n\t\t\t\tfw_pkt->raw.address,\n\t\t\t\tfw_pkt->raw.data,\n\t\t\t\t&data_len,\n\t\t\t\t&addr_has_changed);\n\n\t\tif (read_bytes <= 0)\n\t\t\tgoto error;\n\n\t\t \n\t\ttotal_read_bytes += read_bytes;\n\t\tif (total_read_bytes == firmware->size) {\n\t\t\tfw_pkt->u.request[0] = 0x00;\n\t\t\tfw_pkt->u.request[1] = 0x03;\n\n\t\t\t \n\t\t\terrno = bus_adap->ops->upload_fw_pkt(bus_adap,\n\t\t\t\t\t\t\t     (uint8_t *)\n\t\t\t\t\t\t\t     fw_pkt, 2, 0);\n\t\t\tif (errno < 0)\n\t\t\t\tgoto error;\n\t\t} else {\n\t\t\tif (!addr_has_changed) {\n\t\t\t\t \n\t\t\t\tfw_pkt->u.request[0] = 0x00;\n\t\t\t\tfw_pkt->u.request[1] = 0x01;\n\n\t\t\t\tdata_len += sizeof(fw_pkt->u.request);\n\t\t\t\tdata_len += sizeof(fw_pkt->raw.address);\n\n\t\t\t\t \n\t\t\t\terrno = bus_adap->ops->upload_fw_pkt(bus_adap,\n\t\t\t\t\t\t\t\t     (uint8_t *)\n\t\t\t\t\t\t\t\t     fw_pkt,\n\t\t\t\t\t\t\t\t     data_len,\n\t\t\t\t\t\t\t\t     0);\n\t\t\t\tif (errno < 0)\n\t\t\t\t\tgoto error;\n\t\t\t}\n\t\t}\n\t}\nerror:\n\tkfree(fw_pkt);\n\treturn (errno == 0) ? total_read_bytes : errno;\n}\n\nint as102_fw_upload(struct as10x_bus_adapter_t *bus_adap)\n{\n\tint errno = -EFAULT;\n\tconst struct firmware *firmware = NULL;\n\tunsigned char *cmd_buf = NULL;\n\tconst char *fw1, *fw2;\n\tstruct usb_device *dev = bus_adap->usb_dev;\n\n\t \n\tif (dual_tuner) {\n\t\tfw1 = as102_dt_fw1;\n\t\tfw2 = as102_dt_fw2;\n\t} else {\n\t\tfw1 = as102_st_fw1;\n\t\tfw2 = as102_st_fw2;\n\t}\n\n\t \n\tcmd_buf = kzalloc(MAX_FW_PKT_SIZE, GFP_KERNEL);\n\tif (cmd_buf == NULL) {\n\t\terrno = -ENOMEM;\n\t\tgoto error;\n\t}\n\n\t \n\terrno = request_firmware(&firmware, fw1, &dev->dev);\n\tif (errno < 0) {\n\t\tpr_err(\"%s: unable to locate firmware file: %s\\n\",\n\t\t       DRIVER_NAME, fw1);\n\t\tgoto error;\n\t}\n\n\t \n\terrno = as102_firmware_upload(bus_adap, cmd_buf, firmware);\n\tif (errno < 0) {\n\t\tpr_err(\"%s: error during firmware upload part1\\n\",\n\t\t       DRIVER_NAME);\n\t\tgoto error;\n\t}\n\n\tpr_info(\"%s: firmware: %s loaded with success\\n\",\n\t\tDRIVER_NAME, fw1);\n\trelease_firmware(firmware);\n\tfirmware = NULL;\n\n\t \n\tmdelay(100);\n\n\t \n\terrno = request_firmware(&firmware, fw2, &dev->dev);\n\tif (errno < 0) {\n\t\tpr_err(\"%s: unable to locate firmware file: %s\\n\",\n\t\t       DRIVER_NAME, fw2);\n\t\tgoto error;\n\t}\n\n\t \n\terrno = as102_firmware_upload(bus_adap, cmd_buf, firmware);\n\tif (errno < 0) {\n\t\tpr_err(\"%s: error during firmware upload part2\\n\",\n\t\t       DRIVER_NAME);\n\t\tgoto error;\n\t}\n\n\tpr_info(\"%s: firmware: %s loaded with success\\n\",\n\t\tDRIVER_NAME, fw2);\nerror:\n\tkfree(cmd_buf);\n\trelease_firmware(firmware);\n\n\treturn errno;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}