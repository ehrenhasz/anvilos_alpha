{
  "module_name": "go7007-usb.c",
  "hash_id": "64134833c8104096a5461b25d2ed0770b1d566847ef8e34ab08750d35e672238",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/go7007/go7007-usb.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/wait.h>\n#include <linux/list.h>\n#include <linux/slab.h>\n#include <linux/time.h>\n#include <linux/mm.h>\n#include <linux/usb.h>\n#include <linux/i2c.h>\n#include <asm/byteorder.h>\n#include <media/i2c/saa7115.h>\n#include <media/tuner.h>\n#include <media/i2c/uda1342.h>\n\n#include \"go7007-priv.h\"\n\nstatic unsigned int assume_endura;\nmodule_param(assume_endura, int, 0644);\nMODULE_PARM_DESC(assume_endura,\n\t\t\t\"when probing fails, hardware is a Pelco Endura\");\n\n   \n\n#define\tHPI_STATUS_ADDR\t0xFFF4\n#define\tINT_PARAM_ADDR\t0xFFF6\n#define\tINT_INDEX_ADDR\t0xFFF8\n\n \n\n#define GO7007_USB_EZUSB\t\t(1<<0)\n#define GO7007_USB_EZUSB_I2C\t\t(1<<1)\n\nstruct go7007_usb_board {\n\tunsigned int flags;\n\tstruct go7007_board_info main_info;\n};\n\nstruct go7007_usb {\n\tconst struct go7007_usb_board *board;\n\tstruct mutex i2c_lock;\n\tstruct usb_device *usbdev;\n\tstruct urb *video_urbs[8];\n\tstruct urb *audio_urbs[8];\n\tstruct urb *intr_urb;\n};\n\n \n\nstatic const struct go7007_usb_board board_matrix_ii = {\n\t.flags\t\t= GO7007_USB_EZUSB,\n\t.main_info\t= {\n\t\t.flags\t\t = GO7007_BOARD_HAS_AUDIO |\n\t\t\t\t\tGO7007_BOARD_USE_ONBOARD_I2C,\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.audio_rate\t = 48000,\n\t\t.audio_bclk_div\t = 8,\n\t\t.audio_main_div\t = 2,\n\t\t.hpi_buffer_cap  = 7,\n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_VALID_ENABLE |\n\t\t\t\t\tGO7007_SENSOR_TV |\n\t\t\t\t\tGO7007_SENSOR_SAA7115 |\n\t\t\t\t\tGO7007_SENSOR_VBI |\n\t\t\t\t\tGO7007_SENSOR_SCALING,\n\t\t.num_i2c_devs\t = 1,\n\t\t.i2c_devs\t = {\n\t\t\t{\n\t\t\t\t.type\t= \"saa7115\",\n\t\t\t\t.addr\t= 0x20,\n\t\t\t\t.is_video = 1,\n\t\t\t},\n\t\t},\n\t\t.num_inputs\t = 2,\n\t\t.inputs\t\t = {\n\t\t\t{\n\t\t\t\t.video_input\t= 0,\n\t\t\t\t.name\t\t= \"Composite\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.video_input\t= 9,\n\t\t\t\t.name\t\t= \"S-Video\",\n\t\t\t},\n\t\t},\n\t\t.video_config\t= SAA7115_IDQ_IS_DEFAULT,\n\t},\n};\n\nstatic const struct go7007_usb_board board_matrix_reload = {\n\t.flags\t\t= GO7007_USB_EZUSB,\n\t.main_info\t= {\n\t\t.flags\t\t = GO7007_BOARD_HAS_AUDIO |\n\t\t\t\t\tGO7007_BOARD_USE_ONBOARD_I2C,\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_I2S_MASTER |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.audio_rate\t = 48000,\n\t\t.audio_bclk_div\t = 8,\n\t\t.audio_main_div\t = 2,\n\t\t.hpi_buffer_cap  = 7,\n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_TV,\n\t\t.num_i2c_devs\t = 1,\n\t\t.i2c_devs\t = {\n\t\t\t{\n\t\t\t\t.type\t= \"saa7113\",\n\t\t\t\t.addr\t= 0x25,\n\t\t\t\t.is_video = 1,\n\t\t\t},\n\t\t},\n\t\t.num_inputs\t = 2,\n\t\t.inputs\t\t = {\n\t\t\t{\n\t\t\t\t.video_input\t= 0,\n\t\t\t\t.name\t\t= \"Composite\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.video_input\t= 9,\n\t\t\t\t.name\t\t= \"S-Video\",\n\t\t\t},\n\t\t},\n\t\t.video_config\t= SAA7115_IDQ_IS_DEFAULT,\n\t},\n};\n\nstatic const struct go7007_usb_board board_star_trek = {\n\t.flags\t\t= GO7007_USB_EZUSB | GO7007_USB_EZUSB_I2C,\n\t.main_info\t= {\n\t\t.flags\t\t = GO7007_BOARD_HAS_AUDIO,  \n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_VALID_ENABLE |\n\t\t\t\t\tGO7007_SENSOR_TV |\n\t\t\t\t\tGO7007_SENSOR_SAA7115 |\n\t\t\t\t\tGO7007_SENSOR_VBI |\n\t\t\t\t\tGO7007_SENSOR_SCALING,\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.audio_bclk_div\t = 8,\n\t\t.audio_main_div\t = 2,\n\t\t.hpi_buffer_cap  = 7,\n\t\t.num_i2c_devs\t = 1,\n\t\t.i2c_devs\t = {\n\t\t\t{\n\t\t\t\t.type\t= \"saa7115\",\n\t\t\t\t.addr\t= 0x20,\n\t\t\t\t.is_video = 1,\n\t\t\t},\n\t\t},\n\t\t.num_inputs\t = 2,\n\t\t.inputs\t\t = {\n\t\t \n\t\t\t{\n\t\t\t\t.video_input\t= 1,\n\t\t\t \n\t\t\t\t.name\t\t= \"Composite\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.video_input\t= 8,\n\t\t\t \n\t\t\t\t.name\t\t= \"S-Video\",\n\t\t\t},\n\t\t},\n\t\t.video_config\t= SAA7115_IDQ_IS_DEFAULT,\n\t},\n};\n\nstatic const struct go7007_usb_board board_px_tv402u = {\n\t.flags\t\t= GO7007_USB_EZUSB | GO7007_USB_EZUSB_I2C,\n\t.main_info\t= {\n\t\t.flags\t\t = GO7007_BOARD_HAS_AUDIO |\n\t\t\t\t\tGO7007_BOARD_HAS_TUNER,\n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_VALID_ENABLE |\n\t\t\t\t\tGO7007_SENSOR_TV |\n\t\t\t\t\tGO7007_SENSOR_SAA7115 |\n\t\t\t\t\tGO7007_SENSOR_VBI |\n\t\t\t\t\tGO7007_SENSOR_SCALING,\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.audio_bclk_div\t = 8,\n\t\t.audio_main_div\t = 2,\n\t\t.hpi_buffer_cap  = 7,\n\t\t.num_i2c_devs\t = 5,\n\t\t.i2c_devs\t = {\n\t\t\t{\n\t\t\t\t.type\t= \"saa7115\",\n\t\t\t\t.addr\t= 0x20,\n\t\t\t\t.is_video = 1,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.type\t= \"uda1342\",\n\t\t\t\t.addr\t= 0x1a,\n\t\t\t\t.is_audio = 1,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.type\t= \"tuner\",\n\t\t\t\t.addr\t= 0x60,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.type\t= \"tuner\",\n\t\t\t\t.addr\t= 0x43,\n\t\t\t},\n\t\t\t{\n\t\t\t\t.type\t= \"sony-btf-mpx\",\n\t\t\t\t.addr\t= 0x44,\n\t\t\t},\n\t\t},\n\t\t.num_inputs\t = 3,\n\t\t.inputs\t\t = {\n\t\t\t{\n\t\t\t\t.video_input\t= 3,\n\t\t\t\t.audio_index\t= 0,\n\t\t\t\t.name\t\t= \"Tuner\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.video_input\t= 1,\n\t\t\t\t.audio_index\t= 1,\n\t\t\t\t.name\t\t= \"Composite\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.video_input\t= 8,\n\t\t\t\t.audio_index\t= 1,\n\t\t\t\t.name\t\t= \"S-Video\",\n\t\t\t},\n\t\t},\n\t\t.video_config\t= SAA7115_IDQ_IS_DEFAULT,\n\t\t.num_aud_inputs\t = 2,\n\t\t.aud_inputs\t = {\n\t\t\t{\n\t\t\t\t.audio_input\t= UDA1342_IN2,\n\t\t\t\t.name\t\t= \"Tuner\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.audio_input\t= UDA1342_IN1,\n\t\t\t\t.name\t\t= \"Line In\",\n\t\t\t},\n\t\t},\n\t},\n};\n\nstatic const struct go7007_usb_board board_xmen = {\n\t.flags\t\t= 0,\n\t.main_info\t= {\n\t\t.flags\t\t  = GO7007_BOARD_USE_ONBOARD_I2C,\n\t\t.hpi_buffer_cap   = 0,\n\t\t.sensor_flags\t  = GO7007_SENSOR_VREF_POLAR,\n\t\t.sensor_width\t  = 320,\n\t\t.sensor_height\t  = 240,\n\t\t.sensor_framerate = 30030,\n\t\t.audio_flags\t  = GO7007_AUDIO_ONE_CHANNEL |\n\t\t\t\t\tGO7007_AUDIO_I2S_MODE_3 |\n\t\t\t\t\tGO7007_AUDIO_WORD_14 |\n\t\t\t\t\tGO7007_AUDIO_I2S_MASTER |\n\t\t\t\t\tGO7007_AUDIO_BCLK_POLAR |\n\t\t\t\t\tGO7007_AUDIO_OKI_MODE,\n\t\t.audio_rate\t  = 8000,\n\t\t.audio_bclk_div\t  = 48,\n\t\t.audio_main_div\t  = 1,\n\t\t.num_i2c_devs\t  = 1,\n\t\t.i2c_devs\t  = {\n\t\t\t{\n\t\t\t\t.type\t= \"ov7640\",\n\t\t\t\t.addr\t= 0x21,\n\t\t\t},\n\t\t},\n\t\t.num_inputs\t  = 1,\n\t\t.inputs\t\t  = {\n\t\t\t{\n\t\t\t\t.name\t\t= \"Camera\",\n\t\t\t},\n\t\t},\n\t},\n};\n\nstatic const struct go7007_usb_board board_matrix_revolution = {\n\t.flags\t\t= GO7007_USB_EZUSB,\n\t.main_info\t= {\n\t\t.flags\t\t = GO7007_BOARD_HAS_AUDIO |\n\t\t\t\t\tGO7007_BOARD_USE_ONBOARD_I2C,\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_I2S_MASTER |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.audio_rate\t = 48000,\n\t\t.audio_bclk_div\t = 8,\n\t\t.audio_main_div\t = 2,\n\t\t.hpi_buffer_cap  = 7,\n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_TV |\n\t\t\t\t\tGO7007_SENSOR_VBI,\n\t\t.num_i2c_devs\t = 1,\n\t\t.i2c_devs\t = {\n\t\t\t{\n\t\t\t\t.type\t= \"tw9903\",\n\t\t\t\t.is_video = 1,\n\t\t\t\t.addr\t= 0x44,\n\t\t\t},\n\t\t},\n\t\t.num_inputs\t = 2,\n\t\t.inputs\t\t = {\n\t\t\t{\n\t\t\t\t.video_input\t= 2,\n\t\t\t\t.name\t\t= \"Composite\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.video_input\t= 8,\n\t\t\t\t.name\t\t= \"S-Video\",\n\t\t\t},\n\t\t},\n\t},\n};\n\n#if 0\nstatic const struct go7007_usb_board board_lifeview_lr192 = {\n\t.flags\t\t= GO7007_USB_EZUSB,\n\t.main_info\t= {\n\t\t.flags\t\t = GO7007_BOARD_HAS_AUDIO |\n\t\t\t\t\tGO7007_BOARD_USE_ONBOARD_I2C,\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.audio_rate\t = 48000,\n\t\t.audio_bclk_div\t = 8,\n\t\t.audio_main_div\t = 2,\n\t\t.hpi_buffer_cap  = 7,\n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_VALID_ENABLE |\n\t\t\t\t\tGO7007_SENSOR_TV |\n\t\t\t\t\tGO7007_SENSOR_VBI |\n\t\t\t\t\tGO7007_SENSOR_SCALING,\n\t\t.num_i2c_devs\t = 0,\n\t\t.num_inputs\t = 1,\n\t\t.inputs\t\t = {\n\t\t\t{\n\t\t\t\t.video_input\t= 0,\n\t\t\t\t.name\t\t= \"Composite\",\n\t\t\t},\n\t\t},\n\t},\n};\n#endif\n\nstatic const struct go7007_usb_board board_endura = {\n\t.flags\t\t= 0,\n\t.main_info\t= {\n\t\t.flags\t\t = 0,\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_I2S_MASTER |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.audio_rate\t = 8000,\n\t\t.audio_bclk_div\t = 48,\n\t\t.audio_main_div\t = 8,\n\t\t.hpi_buffer_cap  = 0,\n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_TV,\n\t\t.sensor_h_offset = 8,\n\t\t.num_i2c_devs\t = 0,\n\t\t.num_inputs\t = 1,\n\t\t.inputs\t\t = {\n\t\t\t{\n\t\t\t\t.name\t\t= \"Camera\",\n\t\t\t},\n\t\t},\n\t},\n};\n\nstatic const struct go7007_usb_board board_adlink_mpg24 = {\n\t.flags\t\t= 0,\n\t.main_info\t= {\n\t\t.flags\t\t = GO7007_BOARD_USE_ONBOARD_I2C,\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_I2S_MASTER |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.audio_rate\t = 48000,\n\t\t.audio_bclk_div\t = 8,\n\t\t.audio_main_div\t = 2,\n\t\t.hpi_buffer_cap  = 0,\n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_TV |\n\t\t\t\t\tGO7007_SENSOR_VBI,\n\t\t.num_i2c_devs\t = 1,\n\t\t.i2c_devs\t = {\n\t\t\t{\n\t\t\t\t.type\t= \"tw2804\",\n\t\t\t\t.addr\t= 0x00,  \n\t\t\t\t.flags  = I2C_CLIENT_TEN,\n\t\t\t\t.is_video = 1,\n\t\t\t},\n\t\t},\n\t\t.num_inputs\t = 1,\n\t\t.inputs\t\t = {\n\t\t\t{\n\t\t\t\t.name\t\t= \"Composite\",\n\t\t\t},\n\t\t},\n\t},\n};\n\nstatic const struct go7007_usb_board board_sensoray_2250 = {\n\t.flags\t\t= GO7007_USB_EZUSB | GO7007_USB_EZUSB_I2C,\n\t.main_info\t= {\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_I2S_MASTER |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.flags\t\t = GO7007_BOARD_HAS_AUDIO,\n\t\t.audio_rate\t = 48000,\n\t\t.audio_bclk_div\t = 8,\n\t\t.audio_main_div\t = 2,\n\t\t.hpi_buffer_cap  = 7,\n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_TV,\n\t\t.num_i2c_devs\t = 1,\n\t\t.i2c_devs\t = {\n\t\t\t{\n\t\t\t\t.type\t= \"s2250\",\n\t\t\t\t.addr\t= 0x43,\n\t\t\t\t.is_video = 1,\n\t\t\t\t.is_audio = 1,\n\t\t\t},\n\t\t},\n\t\t.num_inputs\t = 2,\n\t\t.inputs\t\t = {\n\t\t\t{\n\t\t\t\t.video_input\t= 0,\n\t\t\t\t.name\t\t= \"Composite\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.video_input\t= 1,\n\t\t\t\t.name\t\t= \"S-Video\",\n\t\t\t},\n\t\t},\n\t\t.num_aud_inputs\t = 3,\n\t\t.aud_inputs\t = {\n\t\t\t{\n\t\t\t\t.audio_input\t= 0,\n\t\t\t\t.name\t\t= \"Line In\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.audio_input\t= 1,\n\t\t\t\t.name\t\t= \"Mic\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.audio_input\t= 2,\n\t\t\t\t.name\t\t= \"Mic Boost\",\n\t\t\t},\n\t\t},\n\t},\n};\n\nstatic const struct go7007_usb_board board_ads_usbav_709 = {\n\t.flags\t\t= GO7007_USB_EZUSB,\n\t.main_info\t= {\n\t\t.flags\t\t = GO7007_BOARD_HAS_AUDIO |\n\t\t\t\t\tGO7007_BOARD_USE_ONBOARD_I2C,\n\t\t.audio_flags\t = GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\t\tGO7007_AUDIO_I2S_MASTER |\n\t\t\t\t\tGO7007_AUDIO_WORD_16,\n\t\t.audio_rate\t = 48000,\n\t\t.audio_bclk_div\t = 8,\n\t\t.audio_main_div\t = 2,\n\t\t.hpi_buffer_cap  = 7,\n\t\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\t\tGO7007_SENSOR_TV |\n\t\t\t\t\tGO7007_SENSOR_VBI,\n\t\t.num_i2c_devs\t = 1,\n\t\t.i2c_devs\t = {\n\t\t\t{\n\t\t\t\t.type\t= \"tw9906\",\n\t\t\t\t.is_video = 1,\n\t\t\t\t.addr\t= 0x44,\n\t\t\t},\n\t\t},\n\t\t.num_inputs\t = 2,\n\t\t.inputs\t\t = {\n\t\t\t{\n\t\t\t\t.video_input\t= 0,\n\t\t\t\t.name\t\t= \"Composite\",\n\t\t\t},\n\t\t\t{\n\t\t\t\t.video_input\t= 10,\n\t\t\t\t.name\t\t= \"S-Video\",\n\t\t\t},\n\t\t},\n\t},\n};\n\nstatic const struct usb_device_id go7007_usb_id_table[] = {\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION |\n\t\t\t\t\tUSB_DEVICE_ID_MATCH_INT_INFO,\n\t\t.idVendor\t= 0x0eb1,   \n\t\t.idProduct\t= 0x7007,   \n\t\t.bcdDevice_lo\t= 0x200,    \n\t\t.bcdDevice_hi\t= 0x200,\n\t\t.bInterfaceClass\t= 255,\n\t\t.bInterfaceSubClass\t= 0,\n\t\t.bInterfaceProtocol\t= 255,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_XMEN,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION,\n\t\t.idVendor\t= 0x0eb1,   \n\t\t.idProduct\t= 0x7007,   \n\t\t.bcdDevice_lo\t= 0x202,    \n\t\t.bcdDevice_hi\t= 0x202,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_MATRIX_II,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION,\n\t\t.idVendor\t= 0x0eb1,   \n\t\t.idProduct\t= 0x7007,   \n\t\t.bcdDevice_lo\t= 0x204,    \n\t\t.bcdDevice_hi\t= 0x204,    \n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_MATRIX_RELOAD,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION |\n\t\t\t\t\tUSB_DEVICE_ID_MATCH_INT_INFO,\n\t\t.idVendor\t= 0x0eb1,   \n\t\t.idProduct\t= 0x7007,   \n\t\t.bcdDevice_lo\t= 0x205,    \n\t\t.bcdDevice_hi\t= 0x205,\n\t\t.bInterfaceClass\t= 255,\n\t\t.bInterfaceSubClass\t= 0,\n\t\t.bInterfaceProtocol\t= 255,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_XMEN_II,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION,\n\t\t.idVendor\t= 0x0eb1,   \n\t\t.idProduct\t= 0x7007,   \n\t\t.bcdDevice_lo\t= 0x208,    \n\t\t.bcdDevice_hi\t= 0x208,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_STAR_TREK,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION |\n\t\t\t\t\tUSB_DEVICE_ID_MATCH_INT_INFO,\n\t\t.idVendor\t= 0x0eb1,   \n\t\t.idProduct\t= 0x7007,   \n\t\t.bcdDevice_lo\t= 0x209,    \n\t\t.bcdDevice_hi\t= 0x209,\n\t\t.bInterfaceClass\t= 255,\n\t\t.bInterfaceSubClass\t= 0,\n\t\t.bInterfaceProtocol\t= 255,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_XMEN_III,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION,\n\t\t.idVendor\t= 0x0eb1,   \n\t\t.idProduct\t= 0x7007,   \n\t\t.bcdDevice_lo\t= 0x210,    \n\t\t.bcdDevice_hi\t= 0x210,    \n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_MATRIX_REV,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION,\n\t\t.idVendor\t= 0x093b,   \n\t\t.idProduct\t= 0xa102,   \n\t\t.bcdDevice_lo\t= 0x1,\t    \n\t\t.bcdDevice_hi\t= 0x1,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_PX_M402U,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION,\n\t\t.idVendor\t= 0x093b,   \n\t\t.idProduct\t= 0xa104,   \n\t\t.bcdDevice_lo\t= 0x1,\n\t\t.bcdDevice_hi\t= 0x1,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_PX_TV402U,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION,\n\t\t.idVendor\t= 0x10fd,   \n\t\t.idProduct\t= 0xde00,   \n\t\t.bcdDevice_lo\t= 0x1,\n\t\t.bcdDevice_hi\t= 0x1,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_LIFEVIEW_LR192,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION,\n\t\t.idVendor\t= 0x1943,   \n\t\t.idProduct\t= 0x2250,   \n\t\t.bcdDevice_lo\t= 0x1,\n\t\t.bcdDevice_hi\t= 0x1,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_SENSORAY_2250,\n\t},\n\t{\n\t\t.match_flags\t= USB_DEVICE_ID_MATCH_DEVICE_AND_VERSION,\n\t\t.idVendor\t= 0x06e1,   \n\t\t.idProduct\t= 0x0709,   \n\t\t.bcdDevice_lo\t= 0x204,\n\t\t.bcdDevice_hi\t= 0x204,\n\t\t.driver_info\t= (kernel_ulong_t)GO7007_BOARDID_ADS_USBAV_709,\n\t},\n\t{ }\t\t\t\t\t \n};\n\nMODULE_DEVICE_TABLE(usb, go7007_usb_id_table);\n\n \n\nstatic int go7007_usb_vendor_request(struct go7007 *go, int request,\n\t\tint value, int index, void *transfer_buffer, int length, int in)\n{\n\tstruct go7007_usb *usb = go->hpi_context;\n\tint timeout = 5000;\n\n\tif (in) {\n\t\treturn usb_control_msg(usb->usbdev,\n\t\t\t\tusb_rcvctrlpipe(usb->usbdev, 0), request,\n\t\t\t\tUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\n\t\t\t\tvalue, index, transfer_buffer, length, timeout);\n\t} else {\n\t\treturn usb_control_msg(usb->usbdev,\n\t\t\t\tusb_sndctrlpipe(usb->usbdev, 0), request,\n\t\t\t\tUSB_TYPE_VENDOR | USB_RECIP_DEVICE,\n\t\t\t\tvalue, index, transfer_buffer, length, timeout);\n\t}\n}\n\nstatic int go7007_usb_interface_reset(struct go7007 *go)\n{\n\tstruct go7007_usb *usb = go->hpi_context;\n\tu16 intr_val, intr_data;\n\n\tif (go->status == STATUS_SHUTDOWN)\n\t\treturn -1;\n\t \n\tif (go7007_write_interrupt(go, 0x0001, 0x0001) < 0)\n\t\treturn -1;\n\tmsleep(100);\n\n\tif (usb->board->flags & GO7007_USB_EZUSB) {\n\t\t \n\t\tpr_debug(\"resetting EZ-USB buffers\\n\");\n\t\tif (go7007_usb_vendor_request(go, 0x10, 0, 0, NULL, 0, 0) < 0 ||\n\t\t    go7007_usb_vendor_request(go, 0x10, 0, 0, NULL, 0, 0) < 0)\n\t\t\treturn -1;\n\n\t\t \n\t\tif (go7007_write_interrupt(go, 0x0001, 0x0001) < 0)\n\t\t\treturn -1;\n\t\tmsleep(100);\n\t}\n\n\t \n\tif (go7007_read_interrupt(go, &intr_val, &intr_data) < 0 ||\n\t\t\t(intr_val & ~0x1) != 0x55aa) {\n\t\tdev_err(go->dev, \"unable to reset the USB interface\\n\");\n\t\treturn -1;\n\t}\n\treturn 0;\n}\n\nstatic int go7007_usb_ezusb_write_interrupt(struct go7007 *go,\n\t\t\t\t\t\tint addr, int data)\n{\n\tstruct go7007_usb *usb = go->hpi_context;\n\tint i, r;\n\tu16 status_reg = 0;\n\tint timeout = 500;\n\n\tpr_debug(\"WriteInterrupt: %04x %04x\\n\", addr, data);\n\n\tfor (i = 0; i < 100; ++i) {\n\t\tr = usb_control_msg(usb->usbdev,\n\t\t\t\tusb_rcvctrlpipe(usb->usbdev, 0), 0x14,\n\t\t\t\tUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\n\t\t\t\t0, HPI_STATUS_ADDR, go->usb_buf,\n\t\t\t\tsizeof(status_reg), timeout);\n\t\tif (r < 0)\n\t\t\tbreak;\n\t\tstatus_reg = le16_to_cpu(*((__le16 *)go->usb_buf));\n\t\tif (!(status_reg & 0x0010))\n\t\t\tbreak;\n\t\tmsleep(10);\n\t}\n\tif (r < 0)\n\t\tgoto write_int_error;\n\tif (i == 100) {\n\t\tdev_err(go->dev, \"device is hung, status reg = 0x%04x\\n\", status_reg);\n\t\treturn -1;\n\t}\n\tr = usb_control_msg(usb->usbdev, usb_sndctrlpipe(usb->usbdev, 0), 0x12,\n\t\t\tUSB_TYPE_VENDOR | USB_RECIP_DEVICE, data,\n\t\t\tINT_PARAM_ADDR, NULL, 0, timeout);\n\tif (r < 0)\n\t\tgoto write_int_error;\n\tr = usb_control_msg(usb->usbdev, usb_sndctrlpipe(usb->usbdev, 0),\n\t\t\t0x12, USB_TYPE_VENDOR | USB_RECIP_DEVICE, addr,\n\t\t\tINT_INDEX_ADDR, NULL, 0, timeout);\n\tif (r < 0)\n\t\tgoto write_int_error;\n\treturn 0;\n\nwrite_int_error:\n\tdev_err(go->dev, \"error in WriteInterrupt: %d\\n\", r);\n\treturn r;\n}\n\nstatic int go7007_usb_onboard_write_interrupt(struct go7007 *go,\n\t\t\t\t\t\tint addr, int data)\n{\n\tstruct go7007_usb *usb = go->hpi_context;\n\tint r;\n\tint timeout = 500;\n\n\tpr_debug(\"WriteInterrupt: %04x %04x\\n\", addr, data);\n\n\tgo->usb_buf[0] = data & 0xff;\n\tgo->usb_buf[1] = data >> 8;\n\tgo->usb_buf[2] = addr & 0xff;\n\tgo->usb_buf[3] = addr >> 8;\n\tgo->usb_buf[4] = go->usb_buf[5] = go->usb_buf[6] = go->usb_buf[7] = 0;\n\tr = usb_control_msg(usb->usbdev, usb_sndctrlpipe(usb->usbdev, 2), 0x00,\n\t\t\tUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT, 0x55aa,\n\t\t\t0xf0f0, go->usb_buf, 8, timeout);\n\tif (r < 0) {\n\t\tdev_err(go->dev, \"error in WriteInterrupt: %d\\n\", r);\n\t\treturn r;\n\t}\n\treturn 0;\n}\n\nstatic void go7007_usb_readinterrupt_complete(struct urb *urb)\n{\n\tstruct go7007 *go = (struct go7007 *)urb->context;\n\t__le16 *regs = (__le16 *)urb->transfer_buffer;\n\tint status = urb->status;\n\n\tif (status) {\n\t\tif (status != -ESHUTDOWN &&\n\t\t\t\tgo->status != STATUS_SHUTDOWN) {\n\t\t\tdev_err(go->dev, \"error in read interrupt: %d\\n\", urb->status);\n\t\t} else {\n\t\t\twake_up(&go->interrupt_waitq);\n\t\t\treturn;\n\t\t}\n\t} else if (urb->actual_length != urb->transfer_buffer_length) {\n\t\tdev_err(go->dev, \"short read in interrupt pipe!\\n\");\n\t} else {\n\t\tgo->interrupt_available = 1;\n\t\tgo->interrupt_data = __le16_to_cpu(regs[0]);\n\t\tgo->interrupt_value = __le16_to_cpu(regs[1]);\n\t\tpr_debug(\"ReadInterrupt: %04x %04x\\n\",\n\t\t\t\tgo->interrupt_value, go->interrupt_data);\n\t}\n\n\twake_up(&go->interrupt_waitq);\n}\n\nstatic int go7007_usb_read_interrupt(struct go7007 *go)\n{\n\tstruct go7007_usb *usb = go->hpi_context;\n\tint r;\n\n\tr = usb_submit_urb(usb->intr_urb, GFP_KERNEL);\n\tif (r < 0) {\n\t\tdev_err(go->dev, \"unable to submit interrupt urb: %d\\n\", r);\n\t\treturn r;\n\t}\n\treturn 0;\n}\n\nstatic void go7007_usb_read_video_pipe_complete(struct urb *urb)\n{\n\tstruct go7007 *go = (struct go7007 *)urb->context;\n\tint r, status = urb->status;\n\n\tif (!vb2_is_streaming(&go->vidq)) {\n\t\twake_up_interruptible(&go->frame_waitq);\n\t\treturn;\n\t}\n\tif (status) {\n\t\tdev_err(go->dev, \"error in video pipe: %d\\n\", status);\n\t\treturn;\n\t}\n\tif (urb->actual_length != urb->transfer_buffer_length) {\n\t\tdev_err(go->dev, \"short read in video pipe!\\n\");\n\t\treturn;\n\t}\n\tgo7007_parse_video_stream(go, urb->transfer_buffer, urb->actual_length);\n\tr = usb_submit_urb(urb, GFP_ATOMIC);\n\tif (r < 0)\n\t\tdev_err(go->dev, \"error in video pipe: %d\\n\", r);\n}\n\nstatic void go7007_usb_read_audio_pipe_complete(struct urb *urb)\n{\n\tstruct go7007 *go = (struct go7007 *)urb->context;\n\tint r, status = urb->status;\n\n\tif (!vb2_is_streaming(&go->vidq))\n\t\treturn;\n\tif (status) {\n\t\tdev_err(go->dev, \"error in audio pipe: %d\\n\",\n\t\t\tstatus);\n\t\treturn;\n\t}\n\tif (urb->actual_length != urb->transfer_buffer_length) {\n\t\tdev_err(go->dev, \"short read in audio pipe!\\n\");\n\t\treturn;\n\t}\n\tif (go->audio_deliver != NULL)\n\t\tgo->audio_deliver(go, urb->transfer_buffer, urb->actual_length);\n\tr = usb_submit_urb(urb, GFP_ATOMIC);\n\tif (r < 0)\n\t\tdev_err(go->dev, \"error in audio pipe: %d\\n\", r);\n}\n\nstatic int go7007_usb_stream_start(struct go7007 *go)\n{\n\tstruct go7007_usb *usb = go->hpi_context;\n\tint i, r;\n\n\tfor (i = 0; i < 8; ++i) {\n\t\tr = usb_submit_urb(usb->video_urbs[i], GFP_KERNEL);\n\t\tif (r < 0) {\n\t\t\tdev_err(go->dev, \"error submitting video urb %d: %d\\n\", i, r);\n\t\t\tgoto video_submit_failed;\n\t\t}\n\t}\n\tif (!go->audio_enabled)\n\t\treturn 0;\n\n\tfor (i = 0; i < 8; ++i) {\n\t\tr = usb_submit_urb(usb->audio_urbs[i], GFP_KERNEL);\n\t\tif (r < 0) {\n\t\t\tdev_err(go->dev, \"error submitting audio urb %d: %d\\n\", i, r);\n\t\t\tgoto audio_submit_failed;\n\t\t}\n\t}\n\treturn 0;\n\naudio_submit_failed:\n\tfor (i = 0; i < 7; ++i)\n\t\tusb_kill_urb(usb->audio_urbs[i]);\nvideo_submit_failed:\n\tfor (i = 0; i < 8; ++i)\n\t\tusb_kill_urb(usb->video_urbs[i]);\n\treturn -1;\n}\n\nstatic int go7007_usb_stream_stop(struct go7007 *go)\n{\n\tstruct go7007_usb *usb = go->hpi_context;\n\tint i;\n\n\tif (go->status == STATUS_SHUTDOWN)\n\t\treturn 0;\n\tfor (i = 0; i < 8; ++i)\n\t\tusb_kill_urb(usb->video_urbs[i]);\n\tif (go->audio_enabled)\n\t\tfor (i = 0; i < 8; ++i)\n\t\t\tusb_kill_urb(usb->audio_urbs[i]);\n\treturn 0;\n}\n\nstatic int go7007_usb_send_firmware(struct go7007 *go, u8 *data, int len)\n{\n\tstruct go7007_usb *usb = go->hpi_context;\n\tint transferred, pipe;\n\tint timeout = 500;\n\n\tpr_debug(\"DownloadBuffer sending %d bytes\\n\", len);\n\n\tif (usb->board->flags & GO7007_USB_EZUSB)\n\t\tpipe = usb_sndbulkpipe(usb->usbdev, 2);\n\telse\n\t\tpipe = usb_sndbulkpipe(usb->usbdev, 3);\n\n\treturn usb_bulk_msg(usb->usbdev, pipe, data, len,\n\t\t\t\t\t&transferred, timeout);\n}\n\nstatic void go7007_usb_release(struct go7007 *go)\n{\n\tstruct go7007_usb *usb = go->hpi_context;\n\tstruct urb *vurb, *aurb;\n\tint i;\n\n\tif (usb->intr_urb) {\n\t\tusb_kill_urb(usb->intr_urb);\n\t\tkfree(usb->intr_urb->transfer_buffer);\n\t\tusb_free_urb(usb->intr_urb);\n\t}\n\n\t \n\tfor (i = 0; i < 8; ++i) {\n\t\tvurb = usb->video_urbs[i];\n\t\tif (vurb) {\n\t\t\tusb_kill_urb(vurb);\n\t\t\tkfree(vurb->transfer_buffer);\n\t\t\tusb_free_urb(vurb);\n\t\t}\n\t\taurb = usb->audio_urbs[i];\n\t\tif (aurb) {\n\t\t\tusb_kill_urb(aurb);\n\t\t\tkfree(aurb->transfer_buffer);\n\t\t\tusb_free_urb(aurb);\n\t\t}\n\t}\n\n\tkfree(go->hpi_context);\n}\n\nstatic const struct go7007_hpi_ops go7007_usb_ezusb_hpi_ops = {\n\t.interface_reset\t= go7007_usb_interface_reset,\n\t.write_interrupt\t= go7007_usb_ezusb_write_interrupt,\n\t.read_interrupt\t\t= go7007_usb_read_interrupt,\n\t.stream_start\t\t= go7007_usb_stream_start,\n\t.stream_stop\t\t= go7007_usb_stream_stop,\n\t.send_firmware\t\t= go7007_usb_send_firmware,\n\t.release\t\t= go7007_usb_release,\n};\n\nstatic const struct go7007_hpi_ops go7007_usb_onboard_hpi_ops = {\n\t.interface_reset\t= go7007_usb_interface_reset,\n\t.write_interrupt\t= go7007_usb_onboard_write_interrupt,\n\t.read_interrupt\t\t= go7007_usb_read_interrupt,\n\t.stream_start\t\t= go7007_usb_stream_start,\n\t.stream_stop\t\t= go7007_usb_stream_stop,\n\t.send_firmware\t\t= go7007_usb_send_firmware,\n\t.release\t\t= go7007_usb_release,\n};\n\n \n\nstatic int go7007_usb_i2c_master_xfer(struct i2c_adapter *adapter,\n\t\t\t\t\tstruct i2c_msg msgs[], int num)\n{\n\tstruct go7007 *go = i2c_get_adapdata(adapter);\n\tstruct go7007_usb *usb = go->hpi_context;\n\tu8 *buf = go->usb_buf;\n\tint buf_len, i;\n\tint ret = -EIO;\n\n\tif (go->status == STATUS_SHUTDOWN)\n\t\treturn -ENODEV;\n\n\tmutex_lock(&usb->i2c_lock);\n\n\tfor (i = 0; i < num; ++i) {\n\t\t \n\t\tif (i + 1 < num && msgs[i].addr == msgs[i + 1].addr &&\n\t\t\t\t!(msgs[i].flags & I2C_M_RD) &&\n\t\t\t\t(msgs[i + 1].flags & I2C_M_RD)) {\n#ifdef GO7007_I2C_DEBUG\n\t\t\tpr_debug(\"i2c write/read %d/%d bytes on %02x\\n\",\n\t\t\t\tmsgs[i].len, msgs[i + 1].len, msgs[i].addr);\n#endif\n\t\t\tbuf[0] = 0x01;\n\t\t\tbuf[1] = msgs[i].len + 1;\n\t\t\tbuf[2] = msgs[i].addr << 1;\n\t\t\tmemcpy(&buf[3], msgs[i].buf, msgs[i].len);\n\t\t\tbuf_len = msgs[i].len + 3;\n\t\t\tbuf[buf_len++] = msgs[++i].len;\n\t\t} else if (msgs[i].flags & I2C_M_RD) {\n#ifdef GO7007_I2C_DEBUG\n\t\t\tpr_debug(\"i2c read %d bytes on %02x\\n\",\n\t\t\t\t\tmsgs[i].len, msgs[i].addr);\n#endif\n\t\t\tbuf[0] = 0x01;\n\t\t\tbuf[1] = 1;\n\t\t\tbuf[2] = msgs[i].addr << 1;\n\t\t\tbuf[3] = msgs[i].len;\n\t\t\tbuf_len = 4;\n\t\t} else {\n#ifdef GO7007_I2C_DEBUG\n\t\t\tpr_debug(\"i2c write %d bytes on %02x\\n\",\n\t\t\t\t\tmsgs[i].len, msgs[i].addr);\n#endif\n\t\t\tbuf[0] = 0x00;\n\t\t\tbuf[1] = msgs[i].len + 1;\n\t\t\tbuf[2] = msgs[i].addr << 1;\n\t\t\tmemcpy(&buf[3], msgs[i].buf, msgs[i].len);\n\t\t\tbuf_len = msgs[i].len + 3;\n\t\t\tbuf[buf_len++] = 0;\n\t\t}\n\t\tif (go7007_usb_vendor_request(go, 0x24, 0, 0,\n\t\t\t\t\t\tbuf, buf_len, 0) < 0)\n\t\t\tgoto i2c_done;\n\t\tif (msgs[i].flags & I2C_M_RD) {\n\t\t\tmemset(buf, 0, msgs[i].len + 1);\n\t\t\tif (go7007_usb_vendor_request(go, 0x25, 0, 0, buf,\n\t\t\t\t\t\tmsgs[i].len + 1, 1) < 0)\n\t\t\t\tgoto i2c_done;\n\t\t\tmemcpy(msgs[i].buf, buf + 1, msgs[i].len);\n\t\t}\n\t}\n\tret = num;\n\ni2c_done:\n\tmutex_unlock(&usb->i2c_lock);\n\treturn ret;\n}\n\nstatic u32 go7007_usb_functionality(struct i2c_adapter *adapter)\n{\n\t \n\treturn (I2C_FUNC_SMBUS_EMUL) & ~I2C_FUNC_SMBUS_QUICK;\n}\n\nstatic const struct i2c_algorithm go7007_usb_algo = {\n\t.master_xfer\t= go7007_usb_i2c_master_xfer,\n\t.functionality\t= go7007_usb_functionality,\n};\n\nstatic struct i2c_adapter go7007_usb_adap_templ = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.name\t\t\t= \"WIS GO7007SB EZ-USB\",\n\t.algo\t\t\t= &go7007_usb_algo,\n};\n\n \n\nstatic int go7007_usb_probe(struct usb_interface *intf,\n\t\tconst struct usb_device_id *id)\n{\n\tstruct go7007 *go;\n\tstruct go7007_usb *usb;\n\tconst struct go7007_usb_board *board;\n\tstruct usb_device *usbdev = interface_to_usbdev(intf);\n\tstruct usb_host_endpoint *ep;\n\tunsigned num_i2c_devs;\n\tchar *name;\n\tint video_pipe, i, v_urb_len;\n\n\tpr_debug(\"probing new GO7007 USB board\\n\");\n\n\tswitch (id->driver_info) {\n\tcase GO7007_BOARDID_MATRIX_II:\n\t\tname = \"WIS Matrix II or compatible\";\n\t\tboard = &board_matrix_ii;\n\t\tbreak;\n\tcase GO7007_BOARDID_MATRIX_RELOAD:\n\t\tname = \"WIS Matrix Reloaded or compatible\";\n\t\tboard = &board_matrix_reload;\n\t\tbreak;\n\tcase GO7007_BOARDID_MATRIX_REV:\n\t\tname = \"WIS Matrix Revolution or compatible\";\n\t\tboard = &board_matrix_revolution;\n\t\tbreak;\n\tcase GO7007_BOARDID_STAR_TREK:\n\t\tname = \"WIS Star Trek or compatible\";\n\t\tboard = &board_star_trek;\n\t\tbreak;\n\tcase GO7007_BOARDID_XMEN:\n\t\tname = \"WIS XMen or compatible\";\n\t\tboard = &board_xmen;\n\t\tbreak;\n\tcase GO7007_BOARDID_XMEN_II:\n\t\tname = \"WIS XMen II or compatible\";\n\t\tboard = &board_xmen;\n\t\tbreak;\n\tcase GO7007_BOARDID_XMEN_III:\n\t\tname = \"WIS XMen III or compatible\";\n\t\tboard = &board_xmen;\n\t\tbreak;\n\tcase GO7007_BOARDID_PX_M402U:\n\t\tname = \"Plextor PX-M402U\";\n\t\tboard = &board_matrix_ii;\n\t\tbreak;\n\tcase GO7007_BOARDID_PX_TV402U:\n\t\tname = \"Plextor PX-TV402U (unknown tuner)\";\n\t\tboard = &board_px_tv402u;\n\t\tbreak;\n\tcase GO7007_BOARDID_LIFEVIEW_LR192:\n\t\tdev_err(&intf->dev, \"The Lifeview TV Walker Ultra is not supported. Sorry!\\n\");\n\t\treturn -ENODEV;\n#if 0\n\t\tname = \"Lifeview TV Walker Ultra\";\n\t\tboard = &board_lifeview_lr192;\n#endif\n\t\tbreak;\n\tcase GO7007_BOARDID_SENSORAY_2250:\n\t\tdev_info(&intf->dev, \"Sensoray 2250 found\\n\");\n\t\tname = \"Sensoray 2250/2251\";\n\t\tboard = &board_sensoray_2250;\n\t\tbreak;\n\tcase GO7007_BOARDID_ADS_USBAV_709:\n\t\tname = \"ADS Tech DVD Xpress DX2\";\n\t\tboard = &board_ads_usbav_709;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&intf->dev, \"unknown board ID %d!\\n\",\n\t\t\t\t(unsigned int)id->driver_info);\n\t\treturn -ENODEV;\n\t}\n\n\tgo = go7007_alloc(&board->main_info, &intf->dev);\n\tif (go == NULL)\n\t\treturn -ENOMEM;\n\n\tusb = kzalloc(sizeof(struct go7007_usb), GFP_KERNEL);\n\tif (usb == NULL) {\n\t\tkfree(go);\n\t\treturn -ENOMEM;\n\t}\n\n\tusb->board = board;\n\tusb->usbdev = usbdev;\n\tusb_make_path(usbdev, go->bus_info, sizeof(go->bus_info));\n\tgo->board_id = id->driver_info;\n\tstrscpy(go->name, name, sizeof(go->name));\n\tif (board->flags & GO7007_USB_EZUSB)\n\t\tgo->hpi_ops = &go7007_usb_ezusb_hpi_ops;\n\telse\n\t\tgo->hpi_ops = &go7007_usb_onboard_hpi_ops;\n\tgo->hpi_context = usb;\n\n\tep = usb->usbdev->ep_in[4];\n\tif (!ep)\n\t\tgoto allocfail;\n\n\t \n\tusb->intr_urb = usb_alloc_urb(0, GFP_KERNEL);\n\tif (usb->intr_urb == NULL)\n\t\tgoto allocfail;\n\tusb->intr_urb->transfer_buffer = kmalloc_array(2, sizeof(u16),\n\t\t\t\t\t\t       GFP_KERNEL);\n\tif (usb->intr_urb->transfer_buffer == NULL)\n\t\tgoto allocfail;\n\n\tif (usb_endpoint_type(&ep->desc) == USB_ENDPOINT_XFER_BULK)\n\t\tusb_fill_bulk_urb(usb->intr_urb, usb->usbdev,\n\t\t\tusb_rcvbulkpipe(usb->usbdev, 4),\n\t\t\tusb->intr_urb->transfer_buffer, 2*sizeof(u16),\n\t\t\tgo7007_usb_readinterrupt_complete, go);\n\telse\n\t\tusb_fill_int_urb(usb->intr_urb, usb->usbdev,\n\t\t\tusb_rcvintpipe(usb->usbdev, 4),\n\t\t\tusb->intr_urb->transfer_buffer, 2*sizeof(u16),\n\t\t\tgo7007_usb_readinterrupt_complete, go, 8);\n\tusb_set_intfdata(intf, &go->v4l2_dev);\n\n\t \n\tif (go7007_boot_encoder(go, go->board_info->flags &\n\t\t\t\t\tGO7007_BOARD_USE_ONBOARD_I2C) < 0)\n\t\tgoto allocfail;\n\n\t \n\tif (board->flags & GO7007_USB_EZUSB_I2C) {\n\t\tmemcpy(&go->i2c_adapter, &go7007_usb_adap_templ,\n\t\t\t\tsizeof(go7007_usb_adap_templ));\n\t\tmutex_init(&usb->i2c_lock);\n\t\tgo->i2c_adapter.dev.parent = go->dev;\n\t\ti2c_set_adapdata(&go->i2c_adapter, go);\n\t\tif (i2c_add_adapter(&go->i2c_adapter) < 0) {\n\t\t\tdev_err(go->dev, \"error: i2c_add_adapter failed\\n\");\n\t\t\tgoto allocfail;\n\t\t}\n\t\tgo->i2c_adapter_online = 1;\n\t}\n\n\t \n\tif ((go->board_id == GO7007_BOARDID_XMEN ||\n\t\t\t\tgo->board_id == GO7007_BOARDID_XMEN_III) &&\n\t\t\tgo->i2c_adapter_online) {\n\t\tunion i2c_smbus_data data;\n\n\t\t \n\t\ti2c_smbus_xfer(&go->i2c_adapter, 0x21, I2C_CLIENT_SCCB,\n\t\t\tI2C_SMBUS_READ, 0x0A, I2C_SMBUS_BYTE_DATA, &data);\n\t\tif (data.byte != 0x76) {\n\t\t\tif (assume_endura) {\n\t\t\t\tgo->board_id = GO7007_BOARDID_ENDURA;\n\t\t\t\tusb->board = board = &board_endura;\n\t\t\t\tgo->board_info = &board->main_info;\n\t\t\t\tstrscpy(go->name, \"Pelco Endura\",\n\t\t\t\t\tsizeof(go->name));\n\t\t\t} else {\n\t\t\t\tu16 channel;\n\n\t\t\t\t \n\t\t\t\tgo7007_read_addr(go, 0x3c81, &channel);\n\t\t\t\tchannel &= 0x3;\n\t\t\t\tgo->board_id = GO7007_BOARDID_ADLINK_MPG24;\n\t\t\t\tusb->board = board = &board_adlink_mpg24;\n\t\t\t\tgo->board_info = &board->main_info;\n\t\t\t\tgo->channel_number = channel;\n\t\t\t\tsnprintf(go->name, sizeof(go->name),\n\t\t\t\t\t\"Adlink PCI-MPG24, channel #%d\",\n\t\t\t\t\tchannel);\n\t\t\t}\n\t\t\tgo7007_update_board(go);\n\t\t}\n\t}\n\n\tnum_i2c_devs = go->board_info->num_i2c_devs;\n\n\t \n\tif (go->board_id == GO7007_BOARDID_PX_TV402U) {\n\t\t \n\t\tif (go7007_usb_vendor_request(go, 0x41, 0, 0, go->usb_buf, 3,\n\t\t\t\t\t1) < 0) {\n\t\t\tdev_err(go->dev, \"GPIO read failed!\\n\");\n\t\t\tgoto allocfail;\n\t\t}\n\t\tswitch (go->usb_buf[0] >> 6) {\n\t\tcase 1:\n\t\t\tgo->tuner_type = TUNER_SONY_BTF_PG472Z;\n\t\t\tgo->std = V4L2_STD_PAL;\n\t\t\tstrscpy(go->name, \"Plextor PX-TV402U-EU\",\n\t\t\t\tsizeof(go->name));\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tgo->tuner_type = TUNER_SONY_BTF_PK467Z;\n\t\t\tgo->std = V4L2_STD_NTSC_M_JP;\n\t\t\tnum_i2c_devs -= 2;\n\t\t\tstrscpy(go->name, \"Plextor PX-TV402U-JP\",\n\t\t\t\tsizeof(go->name));\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tgo->tuner_type = TUNER_SONY_BTF_PB463Z;\n\t\t\tnum_i2c_devs -= 2;\n\t\t\tstrscpy(go->name, \"Plextor PX-TV402U-NA\",\n\t\t\t\tsizeof(go->name));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpr_debug(\"unable to detect tuner type!\\n\");\n\t\t\tbreak;\n\t\t}\n\t\t \n\t\tif (go7007_usb_vendor_request(go, 0x40, 0x7f02, 0,\n\t\t\t\t\tNULL, 0, 0) < 0) {\n\t\t\tdev_err(go->dev, \"GPIO write failed!\\n\");\n\t\t\tgoto allocfail;\n\t\t}\n\t}\n\n\t \n\tif ((board->flags & GO7007_USB_EZUSB) &&\n\t\t\tusbdev->speed != USB_SPEED_HIGH)\n\t\tdev_err(go->dev, \"*** WARNING ***  This device must be connected to a USB 2.0 port! Attempting to capture video through a USB 1.1 port will result in stream corruption, even at low bitrates!\\n\");\n\n\t \n\tif (board->flags & GO7007_USB_EZUSB) {\n\t\tif (!usb->usbdev->ep_in[6])\n\t\t\tgoto allocfail;\n\t\tv_urb_len = 1024;\n\t\tvideo_pipe = usb_rcvbulkpipe(usb->usbdev, 6);\n\t} else {\n\t\tif (!usb->usbdev->ep_in[1])\n\t\t\tgoto allocfail;\n\t\tv_urb_len = 512;\n\t\tvideo_pipe = usb_rcvbulkpipe(usb->usbdev, 1);\n\t}\n\tfor (i = 0; i < 8; ++i) {\n\t\tusb->video_urbs[i] = usb_alloc_urb(0, GFP_KERNEL);\n\t\tif (usb->video_urbs[i] == NULL)\n\t\t\tgoto allocfail;\n\t\tusb->video_urbs[i]->transfer_buffer =\n\t\t\t\t\t\tkmalloc(v_urb_len, GFP_KERNEL);\n\t\tif (usb->video_urbs[i]->transfer_buffer == NULL)\n\t\t\tgoto allocfail;\n\t\tusb_fill_bulk_urb(usb->video_urbs[i], usb->usbdev, video_pipe,\n\t\t\t\tusb->video_urbs[i]->transfer_buffer, v_urb_len,\n\t\t\t\tgo7007_usb_read_video_pipe_complete, go);\n\t}\n\n\t \n\tif ((board->flags & GO7007_USB_EZUSB) &&\n\t    (board->main_info.flags & GO7007_BOARD_HAS_AUDIO)) {\n\t\tif (!usb->usbdev->ep_in[8])\n\t\t\tgoto allocfail;\n\t\tfor (i = 0; i < 8; ++i) {\n\t\t\tusb->audio_urbs[i] = usb_alloc_urb(0, GFP_KERNEL);\n\t\t\tif (usb->audio_urbs[i] == NULL)\n\t\t\t\tgoto allocfail;\n\t\t\tusb->audio_urbs[i]->transfer_buffer = kmalloc(4096,\n\t\t\t\t\t\t\t\tGFP_KERNEL);\n\t\t\tif (usb->audio_urbs[i]->transfer_buffer == NULL)\n\t\t\t\tgoto allocfail;\n\t\t\tusb_fill_bulk_urb(usb->audio_urbs[i], usb->usbdev,\n\t\t\t\tusb_rcvbulkpipe(usb->usbdev, 8),\n\t\t\t\tusb->audio_urbs[i]->transfer_buffer, 4096,\n\t\t\t\tgo7007_usb_read_audio_pipe_complete, go);\n\t\t}\n\t}\n\n\t \n\tif (go7007_register_encoder(go, num_i2c_devs) < 0)\n\t\tgoto allocfail;\n\n\tgo->status = STATUS_ONLINE;\n\treturn 0;\n\nallocfail:\n\tgo7007_usb_release(go);\n\tkfree(go);\n\treturn -ENOMEM;\n}\n\nstatic void go7007_usb_disconnect(struct usb_interface *intf)\n{\n\tstruct go7007 *go = to_go7007(usb_get_intfdata(intf));\n\n\tmutex_lock(&go->queue_lock);\n\tmutex_lock(&go->serialize_lock);\n\n\tif (go->audio_enabled)\n\t\tgo7007_snd_remove(go);\n\n\tgo->status = STATUS_SHUTDOWN;\n\tv4l2_device_disconnect(&go->v4l2_dev);\n\tvideo_unregister_device(&go->vdev);\n\tmutex_unlock(&go->serialize_lock);\n\tmutex_unlock(&go->queue_lock);\n\n\tv4l2_device_put(&go->v4l2_dev);\n}\n\nstatic struct usb_driver go7007_usb_driver = {\n\t.name\t\t= \"go7007\",\n\t.probe\t\t= go7007_usb_probe,\n\t.disconnect\t= go7007_usb_disconnect,\n\t.id_table\t= go7007_usb_id_table,\n};\n\nmodule_usb_driver(go7007_usb_driver);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}