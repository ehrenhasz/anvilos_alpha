{
  "module_name": "snd-go7007.c",
  "hash_id": "d4b5f9ccc8c811bb98dc41c49f05260960c0e869fa037e7eb1b7cc441b8e2e52",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/go7007/snd-go7007.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/spinlock.h>\n#include <linux/delay.h>\n#include <linux/sched.h>\n#include <linux/time.h>\n#include <linux/mm.h>\n#include <linux/i2c.h>\n#include <linux/mutex.h>\n#include <linux/uaccess.h>\n#include <linux/slab.h>\n#include <sound/core.h>\n#include <sound/pcm.h>\n#include <sound/initval.h>\n\n#include \"go7007-priv.h\"\n\nstatic int index[SNDRV_CARDS] = SNDRV_DEFAULT_IDX;\nstatic char *id[SNDRV_CARDS] = SNDRV_DEFAULT_STR;\nstatic bool enable[SNDRV_CARDS] = SNDRV_DEFAULT_ENABLE_PNP;\n\nmodule_param_array(index, int, NULL, 0444);\nmodule_param_array(id, charp, NULL, 0444);\nmodule_param_array(enable, bool, NULL, 0444);\nMODULE_PARM_DESC(index, \"Index value for the go7007 audio driver\");\nMODULE_PARM_DESC(id, \"ID string for the go7007 audio driver\");\nMODULE_PARM_DESC(enable, \"Enable for the go7007 audio driver\");\n\nstruct go7007_snd {\n\tstruct snd_card *card;\n\tstruct snd_pcm *pcm;\n\tstruct snd_pcm_substream *substream;\n\tspinlock_t lock;\n\tint w_idx;\n\tint hw_ptr;\n\tint avail;\n\tint capturing;\n};\n\nstatic const struct snd_pcm_hardware go7007_snd_capture_hw = {\n\t.info\t\t\t= (SNDRV_PCM_INFO_MMAP |\n\t\t\t\t\tSNDRV_PCM_INFO_INTERLEAVED |\n\t\t\t\t\tSNDRV_PCM_INFO_BLOCK_TRANSFER |\n\t\t\t\t\tSNDRV_PCM_INFO_MMAP_VALID),\n\t.formats\t\t= SNDRV_PCM_FMTBIT_S16_LE,\n\t.rates\t\t\t= SNDRV_PCM_RATE_48000,\n\t.rate_min\t\t= 48000,\n\t.rate_max\t\t= 48000,\n\t.channels_min\t\t= 2,\n\t.channels_max\t\t= 2,\n\t.buffer_bytes_max\t= (128*1024),\n\t.period_bytes_min\t= 4096,\n\t.period_bytes_max\t= (128*1024),\n\t.periods_min\t\t= 1,\n\t.periods_max\t\t= 32,\n};\n\nstatic void parse_audio_stream_data(struct go7007 *go, u8 *buf, int length)\n{\n\tstruct go7007_snd *gosnd = go->snd_context;\n\tstruct snd_pcm_runtime *runtime = gosnd->substream->runtime;\n\tint frames = bytes_to_frames(runtime, length);\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gosnd->lock, flags);\n\tgosnd->hw_ptr += frames;\n\tif (gosnd->hw_ptr >= runtime->buffer_size)\n\t\tgosnd->hw_ptr -= runtime->buffer_size;\n\tgosnd->avail += frames;\n\tspin_unlock_irqrestore(&gosnd->lock, flags);\n\tif (gosnd->w_idx + length > runtime->dma_bytes) {\n\t\tint cpy = runtime->dma_bytes - gosnd->w_idx;\n\n\t\tmemcpy(runtime->dma_area + gosnd->w_idx, buf, cpy);\n\t\tlength -= cpy;\n\t\tbuf += cpy;\n\t\tgosnd->w_idx = 0;\n\t}\n\tmemcpy(runtime->dma_area + gosnd->w_idx, buf, length);\n\tgosnd->w_idx += length;\n\tspin_lock_irqsave(&gosnd->lock, flags);\n\tif (gosnd->avail < runtime->period_size) {\n\t\tspin_unlock_irqrestore(&gosnd->lock, flags);\n\t\treturn;\n\t}\n\tgosnd->avail -= runtime->period_size;\n\tspin_unlock_irqrestore(&gosnd->lock, flags);\n\tif (gosnd->capturing)\n\t\tsnd_pcm_period_elapsed(gosnd->substream);\n}\n\nstatic int go7007_snd_hw_params(struct snd_pcm_substream *substream,\n\t\t\t\tstruct snd_pcm_hw_params *hw_params)\n{\n\tstruct go7007 *go = snd_pcm_substream_chip(substream);\n\n\tgo->audio_deliver = parse_audio_stream_data;\n\treturn 0;\n}\n\nstatic int go7007_snd_hw_free(struct snd_pcm_substream *substream)\n{\n\tstruct go7007 *go = snd_pcm_substream_chip(substream);\n\n\tgo->audio_deliver = NULL;\n\treturn 0;\n}\n\nstatic int go7007_snd_capture_open(struct snd_pcm_substream *substream)\n{\n\tstruct go7007 *go = snd_pcm_substream_chip(substream);\n\tstruct go7007_snd *gosnd = go->snd_context;\n\tunsigned long flags;\n\tint r;\n\n\tspin_lock_irqsave(&gosnd->lock, flags);\n\tif (gosnd->substream == NULL) {\n\t\tgosnd->substream = substream;\n\t\tsubstream->runtime->hw = go7007_snd_capture_hw;\n\t\tr = 0;\n\t} else\n\t\tr = -EBUSY;\n\tspin_unlock_irqrestore(&gosnd->lock, flags);\n\treturn r;\n}\n\nstatic int go7007_snd_capture_close(struct snd_pcm_substream *substream)\n{\n\tstruct go7007 *go = snd_pcm_substream_chip(substream);\n\tstruct go7007_snd *gosnd = go->snd_context;\n\n\tgosnd->substream = NULL;\n\treturn 0;\n}\n\nstatic int go7007_snd_pcm_prepare(struct snd_pcm_substream *substream)\n{\n\treturn 0;\n}\n\nstatic int go7007_snd_pcm_trigger(struct snd_pcm_substream *substream, int cmd)\n{\n\tstruct go7007 *go = snd_pcm_substream_chip(substream);\n\tstruct go7007_snd *gosnd = go->snd_context;\n\n\tswitch (cmd) {\n\tcase SNDRV_PCM_TRIGGER_START:\n\t\t \n\t\tgosnd->capturing = 1;\n\t\treturn 0;\n\tcase SNDRV_PCM_TRIGGER_STOP:\n\t\tgosnd->hw_ptr = gosnd->w_idx = gosnd->avail = 0;\n\t\tgosnd->capturing = 0;\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic snd_pcm_uframes_t go7007_snd_pcm_pointer(struct snd_pcm_substream *substream)\n{\n\tstruct go7007 *go = snd_pcm_substream_chip(substream);\n\tstruct go7007_snd *gosnd = go->snd_context;\n\n\treturn gosnd->hw_ptr;\n}\n\nstatic const struct snd_pcm_ops go7007_snd_capture_ops = {\n\t.open\t\t= go7007_snd_capture_open,\n\t.close\t\t= go7007_snd_capture_close,\n\t.hw_params\t= go7007_snd_hw_params,\n\t.hw_free\t= go7007_snd_hw_free,\n\t.prepare\t= go7007_snd_pcm_prepare,\n\t.trigger\t= go7007_snd_pcm_trigger,\n\t.pointer\t= go7007_snd_pcm_pointer,\n};\n\nstatic int go7007_snd_free(struct snd_device *device)\n{\n\tstruct go7007 *go = device->device_data;\n\n\tkfree(go->snd_context);\n\tgo->snd_context = NULL;\n\treturn 0;\n}\n\nstatic const struct snd_device_ops go7007_snd_device_ops = {\n\t.dev_free\t= go7007_snd_free,\n};\n\nint go7007_snd_init(struct go7007 *go)\n{\n\tstatic int dev;\n\tstruct go7007_snd *gosnd;\n\tint ret;\n\n\tif (dev >= SNDRV_CARDS)\n\t\treturn -ENODEV;\n\tif (!enable[dev]) {\n\t\tdev++;\n\t\treturn -ENOENT;\n\t}\n\tgosnd = kmalloc(sizeof(struct go7007_snd), GFP_KERNEL);\n\tif (gosnd == NULL)\n\t\treturn -ENOMEM;\n\tspin_lock_init(&gosnd->lock);\n\tgosnd->hw_ptr = gosnd->w_idx = gosnd->avail = 0;\n\tgosnd->capturing = 0;\n\tret = snd_card_new(go->dev, index[dev], id[dev], THIS_MODULE, 0,\n\t\t\t   &gosnd->card);\n\tif (ret < 0)\n\t\tgoto free_snd;\n\n\tret = snd_device_new(gosnd->card, SNDRV_DEV_LOWLEVEL, go,\n\t\t\t&go7007_snd_device_ops);\n\tif (ret < 0)\n\t\tgoto free_card;\n\n\tret = snd_pcm_new(gosnd->card, \"go7007\", 0, 0, 1, &gosnd->pcm);\n\tif (ret < 0)\n\t\tgoto free_card;\n\n\tstrscpy(gosnd->card->driver, \"go7007\", sizeof(gosnd->card->driver));\n\tstrscpy(gosnd->card->shortname, go->name, sizeof(gosnd->card->shortname));\n\tstrscpy(gosnd->card->longname, gosnd->card->shortname,\n\t\tsizeof(gosnd->card->longname));\n\n\tgosnd->pcm->private_data = go;\n\tsnd_pcm_set_ops(gosnd->pcm, SNDRV_PCM_STREAM_CAPTURE,\n\t\t\t&go7007_snd_capture_ops);\n\tsnd_pcm_set_managed_buffer_all(gosnd->pcm, SNDRV_DMA_TYPE_VMALLOC,\n\t\t\t\t       NULL, 0, 0);\n\n\tret = snd_card_register(gosnd->card);\n\tif (ret < 0)\n\t\tgoto free_card;\n\n\tgosnd->substream = NULL;\n\tgo->snd_context = gosnd;\n\tv4l2_device_get(&go->v4l2_dev);\n\t++dev;\n\n\treturn 0;\n\nfree_card:\n\tsnd_card_free(gosnd->card);\nfree_snd:\n\tkfree(gosnd);\n\treturn ret;\n}\nEXPORT_SYMBOL(go7007_snd_init);\n\nint go7007_snd_remove(struct go7007 *go)\n{\n\tstruct go7007_snd *gosnd = go->snd_context;\n\n\tsnd_card_disconnect(gosnd->card);\n\tsnd_card_free_when_closed(gosnd->card);\n\tv4l2_device_put(&go->v4l2_dev);\n\treturn 0;\n}\nEXPORT_SYMBOL(go7007_snd_remove);\n\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}