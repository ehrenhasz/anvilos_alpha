{
  "module_name": "stk1160-ac97.c",
  "hash_id": "8401ced9d7b740d5fe23b71ee04a3bf994b3194c1aa0de95c9f383f3df9698cc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/usb/stk1160/stk1160-ac97.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n\n#include \"stk1160.h\"\n#include \"stk1160-reg.h\"\n\nstatic int stk1160_ac97_wait_transfer_complete(struct stk1160 *dev)\n{\n\tunsigned long timeout = jiffies + msecs_to_jiffies(STK1160_AC97_TIMEOUT);\n\tu8 value;\n\n\t \n\twhile (time_is_after_jiffies(timeout)) {\n\t\tstk1160_read_reg(dev, STK1160_AC97CTL_0, &value);\n\n\t\tif (!(value & (STK1160_AC97CTL_0_CR | STK1160_AC97CTL_0_CW)))\n\t\t\treturn 0;\n\n\t\tusleep_range(50, 100);\n\t}\n\n\tstk1160_err(\"AC97 transfer took too long, this should never happen!\");\n\treturn -EBUSY;\n}\n\nstatic void stk1160_write_ac97(struct stk1160 *dev, u16 reg, u16 value)\n{\n\t \n\tstk1160_write_reg(dev, STK1160_AC97_ADDR, reg);\n\n\t \n\tstk1160_write_reg(dev, STK1160_AC97_CMD, value & 0xff);\n\tstk1160_write_reg(dev, STK1160_AC97_CMD + 1, (value & 0xff00) >> 8);\n\n\t \n\tstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x8c);\n\n\t \n\tstk1160_ac97_wait_transfer_complete(dev);\n}\n\n#ifdef DEBUG\nstatic u16 stk1160_read_ac97(struct stk1160 *dev, u16 reg)\n{\n\tu8 vall = 0;\n\tu8 valh = 0;\n\n\t \n\tstk1160_write_reg(dev, STK1160_AC97_ADDR, reg);\n\n\t \n\tstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x8b);\n\n\t \n\tif (stk1160_ac97_wait_transfer_complete(dev) < 0)\n\t\treturn 0;\n\n\n\t \n\tstk1160_read_reg(dev, STK1160_AC97_CMD, &vall);\n\tstk1160_read_reg(dev, STK1160_AC97_CMD + 1, &valh);\n\n\treturn (valh << 8) | vall;\n}\n\nvoid stk1160_ac97_dump_regs(struct stk1160 *dev)\n{\n\tu16 value;\n\n\tvalue = stk1160_read_ac97(dev, 0x12);  \n\tstk1160_dbg(\"0x12 == 0x%04x\", value);\n\n\tvalue = stk1160_read_ac97(dev, 0x10);  \n\tstk1160_dbg(\"0x10 == 0x%04x\", value);\n\n\tvalue = stk1160_read_ac97(dev, 0x0e);  \n\tstk1160_dbg(\"0x0e == 0x%04x\", value);\n\n\tvalue = stk1160_read_ac97(dev, 0x16);  \n\tstk1160_dbg(\"0x16 == 0x%04x\", value);\n\n\tvalue = stk1160_read_ac97(dev, 0x1a);  \n\tstk1160_dbg(\"0x1a == 0x%04x\", value);\n\n\tvalue = stk1160_read_ac97(dev, 0x02);  \n\tstk1160_dbg(\"0x02 == 0x%04x\", value);\n\n\tvalue = stk1160_read_ac97(dev, 0x1c);  \n\tstk1160_dbg(\"0x1c == 0x%04x\", value);\n}\n#endif\n\nstatic int stk1160_has_audio(struct stk1160 *dev)\n{\n\tu8 value;\n\n\tstk1160_read_reg(dev, STK1160_POSV_L, &value);\n\treturn !(value & STK1160_POSV_L_ACDOUT);\n}\n\nstatic int stk1160_has_ac97(struct stk1160 *dev)\n{\n\tu8 value;\n\n\tstk1160_read_reg(dev, STK1160_POSV_L, &value);\n\treturn !(value & STK1160_POSV_L_ACSYNC);\n}\n\nvoid stk1160_ac97_setup(struct stk1160 *dev)\n{\n\tif (!stk1160_has_audio(dev)) {\n\t\tstk1160_info(\"Device doesn't support audio, skipping AC97 setup.\");\n\t\treturn;\n\t}\n\n\tif (!stk1160_has_ac97(dev)) {\n\t\tstk1160_info(\"Device uses internal 8-bit ADC, skipping AC97 setup.\");\n\t\treturn;\n\t}\n\n\t \n\tstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x94);\n\tstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x8c);\n\n\t \n\tstk1160_write_reg(dev, STK1160_AC97CTL_1 + 2, 0x01);\n\tstk1160_write_reg(dev, STK1160_AC97CTL_1 + 3, 0x00);\n\n\t \n\tstk1160_write_ac97(dev, 0x12, 0x8808);  \n\tstk1160_write_ac97(dev, 0x10, 0x0808);  \n\tstk1160_write_ac97(dev, 0x0e, 0x0008);  \n\tstk1160_write_ac97(dev, 0x16, 0x0808);  \n\tstk1160_write_ac97(dev, 0x1a, 0x0404);  \n\tstk1160_write_ac97(dev, 0x02, 0x0000);  \n\tstk1160_write_ac97(dev, 0x1c, 0x0808);  \n\n#ifdef DEBUG\n\tstk1160_ac97_dump_regs(dev);\n#endif\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}