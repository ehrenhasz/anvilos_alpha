{
  "module_name": "max9271.c",
  "hash_id": "5402761ead379967c4129ae34beeee3d70f800ceb5ab403a1499fc17c97d9468",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/i2c/max9271.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/i2c.h>\n#include <linux/module.h>\n\n#include \"max9271.h\"\n\nstatic int max9271_read(struct max9271_device *dev, u8 reg)\n{\n\tint ret;\n\n\tdev_dbg(&dev->client->dev, \"%s(0x%02x)\\n\", __func__, reg);\n\n\tret = i2c_smbus_read_byte_data(dev->client, reg);\n\tif (ret < 0)\n\t\tdev_dbg(&dev->client->dev,\n\t\t\t\"%s: register 0x%02x read failed (%d)\\n\",\n\t\t\t__func__, reg, ret);\n\n\treturn ret;\n}\n\nstatic int max9271_write(struct max9271_device *dev, u8 reg, u8 val)\n{\n\tint ret;\n\n\tdev_dbg(&dev->client->dev, \"%s(0x%02x, 0x%02x)\\n\", __func__, reg, val);\n\n\tret = i2c_smbus_write_byte_data(dev->client, reg, val);\n\tif (ret < 0)\n\t\tdev_err(&dev->client->dev,\n\t\t\t\"%s: register 0x%02x write failed (%d)\\n\",\n\t\t\t__func__, reg, ret);\n\n\treturn ret;\n}\n\n \nstatic int max9271_pclk_detect(struct max9271_device *dev)\n{\n\tunsigned int i;\n\tint ret;\n\n\tfor (i = 0; i < 100; i++) {\n\t\tret = max9271_read(dev, 0x15);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tif (ret & MAX9271_PCLKDET)\n\t\t\treturn 0;\n\n\t\tusleep_range(50, 100);\n\t}\n\n\tdev_err(&dev->client->dev, \"Unable to detect valid pixel clock\\n\");\n\n\treturn -EIO;\n}\n\nvoid max9271_wake_up(struct max9271_device *dev)\n{\n\t \n\tdev->client->addr = MAX9271_DEFAULT_ADDR;\n\ti2c_smbus_read_byte(dev->client);\n\tusleep_range(5000, 8000);\n}\nEXPORT_SYMBOL_GPL(max9271_wake_up);\n\nint max9271_set_serial_link(struct max9271_device *dev, bool enable)\n{\n\tint ret;\n\tu8 val = MAX9271_REVCCEN | MAX9271_FWDCCEN;\n\n\tif (enable) {\n\t\tret = max9271_pclk_detect(dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tval |= MAX9271_SEREN;\n\t} else {\n\t\tval |= MAX9271_CLINKEN;\n\t}\n\n\t \n\tret = max9271_write(dev, 0x04, val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tusleep_range(5000, 8000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_set_serial_link);\n\nint max9271_configure_i2c(struct max9271_device *dev, u8 i2c_config)\n{\n\tint ret;\n\n\tret = max9271_write(dev, 0x0d, i2c_config);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tusleep_range(3500, 5000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_configure_i2c);\n\nint max9271_set_high_threshold(struct max9271_device *dev, bool enable)\n{\n\tint ret;\n\n\tret = max9271_read(dev, 0x08);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = max9271_write(dev, 0x08, enable ? ret | BIT(0) : ret & ~BIT(0));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tusleep_range(2000, 2500);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_set_high_threshold);\n\nint max9271_configure_gmsl_link(struct max9271_device *dev)\n{\n\tint ret;\n\n\t \n\tret = max9271_write(dev, 0x07, MAX9271_DBL | MAX9271_HVEN |\n\t\t\t    MAX9271_EDC_1BIT_PARITY);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tusleep_range(5000, 8000);\n\n\t \n\tret = max9271_write(dev, 0x02,\n\t\t\t    MAX9271_SPREAD_SPECT_4 | MAX9271_R02_RES |\n\t\t\t    MAX9271_PCLK_AUTODETECT |\n\t\t\t    MAX9271_SERIAL_AUTODETECT);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tusleep_range(5000, 8000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_configure_gmsl_link);\n\nint max9271_set_gpios(struct max9271_device *dev, u8 gpio_mask)\n{\n\tint ret;\n\n\tret = max9271_read(dev, 0x0f);\n\tif (ret < 0)\n\t\treturn 0;\n\n\tret |= gpio_mask;\n\tret = max9271_write(dev, 0x0f, ret);\n\tif (ret < 0) {\n\t\tdev_err(&dev->client->dev, \"Failed to set gpio (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tusleep_range(3500, 5000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_set_gpios);\n\nint max9271_clear_gpios(struct max9271_device *dev, u8 gpio_mask)\n{\n\tint ret;\n\n\tret = max9271_read(dev, 0x0f);\n\tif (ret < 0)\n\t\treturn 0;\n\n\tret &= ~gpio_mask;\n\tret = max9271_write(dev, 0x0f, ret);\n\tif (ret < 0) {\n\t\tdev_err(&dev->client->dev, \"Failed to clear gpio (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tusleep_range(3500, 5000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_clear_gpios);\n\nint max9271_enable_gpios(struct max9271_device *dev, u8 gpio_mask)\n{\n\tint ret;\n\n\tret = max9271_read(dev, 0x0e);\n\tif (ret < 0)\n\t\treturn 0;\n\n\t \n\tret |= (gpio_mask & ~BIT(0));\n\tret = max9271_write(dev, 0x0e, ret);\n\tif (ret < 0) {\n\t\tdev_err(&dev->client->dev, \"Failed to enable gpio (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tusleep_range(3500, 5000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_enable_gpios);\n\nint max9271_disable_gpios(struct max9271_device *dev, u8 gpio_mask)\n{\n\tint ret;\n\n\tret = max9271_read(dev, 0x0e);\n\tif (ret < 0)\n\t\treturn 0;\n\n\t \n\tret &= ~(gpio_mask | BIT(0));\n\tret = max9271_write(dev, 0x0e, ret);\n\tif (ret < 0) {\n\t\tdev_err(&dev->client->dev, \"Failed to disable gpio (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tusleep_range(3500, 5000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_disable_gpios);\n\nint max9271_verify_id(struct max9271_device *dev)\n{\n\tint ret;\n\n\tret = max9271_read(dev, 0x1e);\n\tif (ret < 0) {\n\t\tdev_err(&dev->client->dev, \"MAX9271 ID read failed (%d)\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tif (ret != MAX9271_ID) {\n\t\tdev_err(&dev->client->dev, \"MAX9271 ID mismatch (0x%02x)\\n\",\n\t\t\tret);\n\t\treturn -ENXIO;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_verify_id);\n\nint max9271_set_address(struct max9271_device *dev, u8 addr)\n{\n\tint ret;\n\n\tret = max9271_write(dev, 0x00, addr << 1);\n\tif (ret < 0) {\n\t\tdev_err(&dev->client->dev,\n\t\t\t\"MAX9271 I2C address change failed (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\tusleep_range(3500, 5000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_set_address);\n\nint max9271_set_deserializer_address(struct max9271_device *dev, u8 addr)\n{\n\tint ret;\n\n\tret = max9271_write(dev, 0x01, addr << 1);\n\tif (ret < 0) {\n\t\tdev_err(&dev->client->dev,\n\t\t\t\"MAX9271 deserializer address set failed (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\tusleep_range(3500, 5000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_set_deserializer_address);\n\nint max9271_set_translation(struct max9271_device *dev, u8 source, u8 dest)\n{\n\tint ret;\n\n\tret = max9271_write(dev, 0x09, source << 1);\n\tif (ret < 0) {\n\t\tdev_err(&dev->client->dev,\n\t\t\t\"MAX9271 I2C translation setup failed (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\tusleep_range(3500, 5000);\n\n\tret = max9271_write(dev, 0x0a, dest << 1);\n\tif (ret < 0) {\n\t\tdev_err(&dev->client->dev,\n\t\t\t\"MAX9271 I2C translation setup failed (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\tusleep_range(3500, 5000);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(max9271_set_translation);\n\nMODULE_DESCRIPTION(\"Maxim MAX9271 GMSL Serializer\");\nMODULE_AUTHOR(\"Jacopo Mondi\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}