{
  "module_name": "msp3400-kthreads.c",
  "hash_id": "6194d39d187d727c076981fa3c0706c9f8aadd1c9922c5d45c1a7a4ca8202a34",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/i2c/msp3400-kthreads.c",
  "human_readable_source": "\n \n\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/i2c.h>\n#include <linux/freezer.h>\n#include <linux/videodev2.h>\n#include <media/v4l2-common.h>\n#include <media/drv-intf/msp3400.h>\n#include <linux/kthread.h>\n#include <linux/suspend.h>\n#include \"msp3400-driver.h\"\n\n \nstatic struct {\n\tint retval;\n\tint main, second;\n\tchar *name;\n\tv4l2_std_id std;\n} msp_stdlist[] = {\n\t{ 0x0000, 0, 0, \"could not detect sound standard\", V4L2_STD_ALL },\n\t{ 0x0001, 0, 0, \"autodetect start\", V4L2_STD_ALL },\n\t{ 0x0002, MSP_CARRIER(4.5), MSP_CARRIER(4.72),\n\t  \"4.5/4.72  M Dual FM-Stereo\", V4L2_STD_MN },\n\t{ 0x0003, MSP_CARRIER(5.5), MSP_CARRIER(5.7421875),\n\t  \"5.5/5.74  B/G Dual FM-Stereo\", V4L2_STD_BG },\n\t{ 0x0004, MSP_CARRIER(6.5), MSP_CARRIER(6.2578125),\n\t  \"6.5/6.25  D/K1 Dual FM-Stereo\", V4L2_STD_DK },\n\t{ 0x0005, MSP_CARRIER(6.5), MSP_CARRIER(6.7421875),\n\t  \"6.5/6.74  D/K2 Dual FM-Stereo\", V4L2_STD_DK },\n\t{ 0x0006, MSP_CARRIER(6.5), MSP_CARRIER(6.5),\n\t  \"6.5  D/K FM-Mono (HDEV3)\", V4L2_STD_DK },\n\t{ 0x0007, MSP_CARRIER(6.5), MSP_CARRIER(5.7421875),\n\t  \"6.5/5.74  D/K3 Dual FM-Stereo\", V4L2_STD_DK },\n\t{ 0x0008, MSP_CARRIER(5.5), MSP_CARRIER(5.85),\n\t  \"5.5/5.85  B/G NICAM FM\", V4L2_STD_BG },\n\t{ 0x0009, MSP_CARRIER(6.5), MSP_CARRIER(5.85),\n\t  \"6.5/5.85  L NICAM AM\", V4L2_STD_L },\n\t{ 0x000a, MSP_CARRIER(6.0), MSP_CARRIER(6.55),\n\t  \"6.0/6.55  I NICAM FM\", V4L2_STD_PAL_I },\n\t{ 0x000b, MSP_CARRIER(6.5), MSP_CARRIER(5.85),\n\t  \"6.5/5.85  D/K NICAM FM\", V4L2_STD_DK },\n\t{ 0x000c, MSP_CARRIER(6.5), MSP_CARRIER(5.85),\n\t  \"6.5/5.85  D/K NICAM FM (HDEV2)\", V4L2_STD_DK },\n\t{ 0x000d, MSP_CARRIER(6.5), MSP_CARRIER(5.85),\n\t  \"6.5/5.85  D/K NICAM FM (HDEV3)\", V4L2_STD_DK },\n\t{ 0x0020, MSP_CARRIER(4.5), MSP_CARRIER(4.5),\n\t  \"4.5  M BTSC-Stereo\", V4L2_STD_MTS },\n\t{ 0x0021, MSP_CARRIER(4.5), MSP_CARRIER(4.5),\n\t  \"4.5  M BTSC-Mono + SAP\", V4L2_STD_MTS },\n\t{ 0x0030, MSP_CARRIER(4.5), MSP_CARRIER(4.5),\n\t  \"4.5  M EIA-J Japan Stereo\", V4L2_STD_NTSC_M_JP },\n\t{ 0x0040, MSP_CARRIER(10.7), MSP_CARRIER(10.7),\n\t  \"10.7  FM-Stereo Radio\", V4L2_STD_ALL },\n\t{ 0x0050, MSP_CARRIER(6.5), MSP_CARRIER(6.5),\n\t  \"6.5  SAT-Mono\", V4L2_STD_ALL },\n\t{ 0x0051, MSP_CARRIER(7.02), MSP_CARRIER(7.20),\n\t  \"7.02/7.20  SAT-Stereo\", V4L2_STD_ALL },\n\t{ 0x0060, MSP_CARRIER(7.2), MSP_CARRIER(7.2),\n\t  \"7.2  SAT ADR\", V4L2_STD_ALL },\n\t{     -1, 0, 0, NULL, 0 },  \n};\n\nstatic struct msp3400c_init_data_dem {\n\tint fir1[6];\n\tint fir2[6];\n\tint cdo1;\n\tint cdo2;\n\tint ad_cv;\n\tint mode_reg;\n\tint dsp_src;\n\tint dsp_matrix;\n} msp3400c_init_data[] = {\n\t{\t \n\t\t{75, 19, 36, 35, 39, 40},\n\t\t{75, 19, 36, 35, 39, 40},\n\t\tMSP_CARRIER(5.5), MSP_CARRIER(5.5),\n\t\t0x00d0, 0x0500, 0x0020, 0x3000\n\t}, {\t \n\t\t{-1, -1, -8, 2, 59, 126},\n\t\t{-1, -1, -8, 2, 59, 126},\n\t\tMSP_CARRIER(5.5), MSP_CARRIER(5.5),\n\t\t0x00d0, 0x0100, 0x0020, 0x3000\n\t}, {\t \n\t\t{-8, -8, 4, 6, 78, 107},\n\t\t{-8, -8, 4, 6, 78, 107},\n\t\tMSP_CARRIER(10.7), MSP_CARRIER(10.7),\n\t\t0x00d0, 0x0480, 0x0020, 0x3000\n\t}, {\t \n\t\t{3, 18, 27, 48, 66, 72},\n\t\t{3, 18, 27, 48, 66, 72},\n\t\tMSP_CARRIER(5.5), MSP_CARRIER(5.5),\n\t\t0x00d0, 0x0480, 0x0030, 0x3000\n\t}, {\t \n\t\t{ 1, 9, 14, 24, 33, 37},\n\t\t{ 3, 18, 27, 48, 66, 72},\n\t\tMSP_CARRIER(6.5), MSP_CARRIER(6.5),\n\t\t0x00c6, 0x0480, 0x0000, 0x3000\n\t}, {\t \n\t\t{-2, -8, -10, 10, 50, 86},\n\t\t{3, 18, 27, 48, 66, 72},\n\t\tMSP_CARRIER(5.5), MSP_CARRIER(5.5),\n\t\t0x00d0, 0x0040, 0x0120, 0x3000\n\t}, {\t \n\t\t{2, 4, -6, -4, 40, 94},\n\t\t{3, 18, 27, 48, 66, 72},\n\t\tMSP_CARRIER(6.0), MSP_CARRIER(6.0),\n\t\t0x00d0, 0x0040, 0x0120, 0x3000\n\t}, {\t \n\t\t{-2, -8, -10, 10, 50, 86},\n\t\t{-4, -12, -9, 23, 79, 126},\n\t\tMSP_CARRIER(6.5), MSP_CARRIER(6.5),\n\t\t0x00c6, 0x0140, 0x0120, 0x7c00\n\t},\n};\n\nstruct msp3400c_carrier_detect {\n\tint   cdo;\n\tchar *name;\n};\n\nstatic struct msp3400c_carrier_detect msp3400c_carrier_detect_main[] = {\n\t \n\t{ MSP_CARRIER(4.5),        \"4.5   NTSC\"                   },\n\t{ MSP_CARRIER(5.5),        \"5.5   PAL B/G\"                },\n\t{ MSP_CARRIER(6.0),        \"6.0   PAL I\"                  },\n\t{ MSP_CARRIER(6.5),        \"6.5   PAL D/K + SAT + SECAM\"  }\n};\n\nstatic struct msp3400c_carrier_detect msp3400c_carrier_detect_55[] = {\n\t \n\t{ MSP_CARRIER(5.7421875),  \"5.742 PAL B/G FM-stereo\"     },\n\t{ MSP_CARRIER(5.85),       \"5.85  PAL B/G NICAM\"         }\n};\n\nstatic struct msp3400c_carrier_detect msp3400c_carrier_detect_65[] = {\n\t \n\t{ MSP_CARRIER(5.85),       \"5.85  PAL D/K + SECAM NICAM\" },\n\t{ MSP_CARRIER(6.2578125),  \"6.25  PAL D/K1 FM-stereo\" },\n\t{ MSP_CARRIER(6.7421875),  \"6.74  PAL D/K2 FM-stereo\" },\n\t{ MSP_CARRIER(7.02),       \"7.02  PAL SAT FM-stereo s/b\" },\n\t{ MSP_CARRIER(7.20),       \"7.20  PAL SAT FM-stereo s\"   },\n\t{ MSP_CARRIER(7.38),       \"7.38  PAL SAT FM-stereo b\"   },\n};\n\n \n\nconst char *msp_standard_std_name(int std)\n{\n\tint i;\n\n\tfor (i = 0; msp_stdlist[i].name != NULL; i++)\n\t\tif (msp_stdlist[i].retval == std)\n\t\t\treturn msp_stdlist[i].name;\n\treturn \"unknown\";\n}\n\nstatic v4l2_std_id msp_standard_std(int std)\n{\n\tint i;\n\n\tfor (i = 0; msp_stdlist[i].name != NULL; i++)\n\t\tif (msp_stdlist[i].retval == std)\n\t\t\treturn msp_stdlist[i].std;\n\treturn V4L2_STD_ALL;\n}\n\nstatic void msp_set_source(struct i2c_client *client, u16 src)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\n\tif (msp_dolby) {\n\t\tmsp_write_dsp(client, 0x0008, 0x0520);  \n\t\tmsp_write_dsp(client, 0x0009, 0x0620);  \n\t} else {\n\t\tmsp_write_dsp(client, 0x0008, src);\n\t\tmsp_write_dsp(client, 0x0009, src);\n\t}\n\tmsp_write_dsp(client, 0x000a, src);\n\tmsp_write_dsp(client, 0x000b, src);\n\tmsp_write_dsp(client, 0x000c, src);\n\tif (state->has_scart2_out)\n\t\tmsp_write_dsp(client, 0x0041, src);\n}\n\nvoid msp3400c_set_carrier(struct i2c_client *client, int cdo1, int cdo2)\n{\n\tmsp_write_dem(client, 0x0093, cdo1 & 0xfff);\n\tmsp_write_dem(client, 0x009b, cdo1 >> 12);\n\tmsp_write_dem(client, 0x00a3, cdo2 & 0xfff);\n\tmsp_write_dem(client, 0x00ab, cdo2 >> 12);\n\tmsp_write_dem(client, 0x0056, 0);  \n}\n\nvoid msp3400c_set_mode(struct i2c_client *client, int mode)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tstruct msp3400c_init_data_dem *data = &msp3400c_init_data[mode];\n\tint tuner = (state->route_in >> 3) & 1;\n\tint i;\n\n\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"set_mode: %d\\n\", mode);\n\tstate->mode = mode;\n\tstate->rxsubchans = V4L2_TUNER_SUB_MONO;\n\n\tmsp_write_dem(client, 0x00bb, data->ad_cv | (tuner ? 0x100 : 0));\n\n\tfor (i = 5; i >= 0; i--)                \n\t\tmsp_write_dem(client, 0x0001, data->fir1[i]);\n\n\tmsp_write_dem(client, 0x0005, 0x0004);  \n\tmsp_write_dem(client, 0x0005, 0x0040);\n\tmsp_write_dem(client, 0x0005, 0x0000);\n\tfor (i = 5; i >= 0; i--)\n\t\tmsp_write_dem(client, 0x0005, data->fir2[i]);\n\n\tmsp_write_dem(client, 0x0083, data->mode_reg);\n\n\tmsp3400c_set_carrier(client, data->cdo1, data->cdo2);\n\n\tmsp_set_source(client, data->dsp_src);\n\t \n\n\t \n\tmsp_write_dsp(client, 0x000d, 0x1900);\n\tmsp_write_dsp(client, 0x000e, data->dsp_matrix);\n\tif (state->has_nicam)  \n\t\tmsp_write_dsp(client, 0x0010, 0x5a00);\n}\n\n \nstatic void msp3400c_set_audmode(struct i2c_client *client)\n{\n\tstatic char *strmode[] = {\n\t\t\"mono\", \"stereo\", \"lang2\", \"lang1\", \"lang1+lang2\"\n\t};\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tchar *modestr = (state->audmode >= 0 && state->audmode < 5) ?\n\t\tstrmode[state->audmode] : \"unknown\";\n\tint src = 0;\t \n\tint audmode = state->audmode;\n\n\tif (state->opmode == OPMODE_AUTOSELECT) {\n\t\t \n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"set_audmode called with mode=%d instead of set_source (ignored)\\n\",\n\t\t\tstate->audmode);\n\t\treturn;\n\t}\n\n\t \n\n\tif (state->mode != MSP_MODE_EXTERN) {\n\t\t \n\t\tif (state->rxsubchans == V4L2_TUNER_SUB_MONO)\n\t\t\taudmode = V4L2_TUNER_MODE_MONO;\n\t\t \n\t\telse if (state->rxsubchans & V4L2_TUNER_SUB_LANG2) {\n\t\t\t \n\t\t\tif (audmode == V4L2_TUNER_MODE_MONO ||\n\t\t\t    audmode == V4L2_TUNER_MODE_STEREO)\n\t\t\t\taudmode = V4L2_TUNER_MODE_LANG1;\n\t\t}\n\t\t \n\t\telse if (audmode != V4L2_TUNER_MODE_MONO)\n\t\t\taudmode = V4L2_TUNER_MODE_STEREO;\n\t}\n\n\t \n\tswitch (state->mode) {\n\tcase MSP_MODE_FM_TERRA:\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"FM set_audmode: %s\\n\", modestr);\n\t\tswitch (audmode) {\n\t\tcase V4L2_TUNER_MODE_STEREO:\n\t\t\tmsp_write_dsp(client, 0x000e, 0x3001);\n\t\t\tbreak;\n\t\tcase V4L2_TUNER_MODE_MONO:\n\t\tcase V4L2_TUNER_MODE_LANG1:\n\t\tcase V4L2_TUNER_MODE_LANG2:\n\t\tcase V4L2_TUNER_MODE_LANG1_LANG2:\n\t\t\tmsp_write_dsp(client, 0x000e, 0x3000);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase MSP_MODE_FM_SAT:\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"SAT set_audmode: %s\\n\", modestr);\n\t\tswitch (audmode) {\n\t\tcase V4L2_TUNER_MODE_MONO:\n\t\t\tmsp3400c_set_carrier(client, MSP_CARRIER(6.5), MSP_CARRIER(6.5));\n\t\t\tbreak;\n\t\tcase V4L2_TUNER_MODE_STEREO:\n\t\tcase V4L2_TUNER_MODE_LANG1_LANG2:\n\t\t\tmsp3400c_set_carrier(client, MSP_CARRIER(7.2), MSP_CARRIER(7.02));\n\t\t\tbreak;\n\t\tcase V4L2_TUNER_MODE_LANG1:\n\t\t\tmsp3400c_set_carrier(client, MSP_CARRIER(7.38), MSP_CARRIER(7.02));\n\t\t\tbreak;\n\t\tcase V4L2_TUNER_MODE_LANG2:\n\t\t\tmsp3400c_set_carrier(client, MSP_CARRIER(7.38), MSP_CARRIER(7.02));\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase MSP_MODE_FM_NICAM1:\n\tcase MSP_MODE_FM_NICAM2:\n\tcase MSP_MODE_AM_NICAM:\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"NICAM set_audmode: %s\\n\", modestr);\n\t\tif (state->nicam_on)\n\t\t\tsrc = 0x0100;   \n\t\tbreak;\n\tcase MSP_MODE_BTSC:\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"BTSC set_audmode: %s\\n\", modestr);\n\t\tbreak;\n\tcase MSP_MODE_EXTERN:\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"extern set_audmode: %s\\n\", modestr);\n\t\tsrc = 0x0200;   \n\t\tbreak;\n\tcase MSP_MODE_FM_RADIO:\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"FM-Radio set_audmode: %s\\n\", modestr);\n\t\tbreak;\n\tdefault:\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"mono set_audmode\\n\");\n\t\treturn;\n\t}\n\n\t \n\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"set audmode %d\\n\", audmode);\n\tswitch (audmode) {\n\tcase V4L2_TUNER_MODE_STEREO:\n\tcase V4L2_TUNER_MODE_LANG1_LANG2:\n\t\tsrc |= 0x0020;\n\t\tbreak;\n\tcase V4L2_TUNER_MODE_MONO:\n\t\tif (state->mode == MSP_MODE_AM_NICAM) {\n\t\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"switching to AM mono\\n\");\n\t\t\t \n\t\t\t \n\t\t\tmsp_set_scart(client, SCART_MONO, 0);\n\t\t\tsrc = 0x0200;\n\t\t\tbreak;\n\t\t}\n\t\tif (state->rxsubchans & V4L2_TUNER_SUB_STEREO)\n\t\t\tsrc = 0x0030;\n\t\tbreak;\n\tcase V4L2_TUNER_MODE_LANG1:\n\t\tbreak;\n\tcase V4L2_TUNER_MODE_LANG2:\n\t\tsrc |= 0x0010;\n\t\tbreak;\n\t}\n\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\"set_audmode final source/matrix = 0x%x\\n\", src);\n\n\tmsp_set_source(client, src);\n}\n\nstatic void msp3400c_print_mode(struct i2c_client *client)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\n\tif (state->main == state->second)\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"mono sound carrier: %d.%03d MHz\\n\",\n\t\t\tstate->main / 910000, (state->main / 910) % 1000);\n\telse\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"main sound carrier: %d.%03d MHz\\n\",\n\t\t\tstate->main / 910000, (state->main / 910) % 1000);\n\tif (state->mode == MSP_MODE_FM_NICAM1 || state->mode == MSP_MODE_FM_NICAM2)\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"NICAM/FM carrier  : %d.%03d MHz\\n\",\n\t\t\tstate->second / 910000, (state->second/910) % 1000);\n\tif (state->mode == MSP_MODE_AM_NICAM)\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"NICAM/AM carrier  : %d.%03d MHz\\n\",\n\t\t\tstate->second / 910000, (state->second / 910) % 1000);\n\tif (state->mode == MSP_MODE_FM_TERRA && state->main != state->second) {\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"FM-stereo carrier : %d.%03d MHz\\n\",\n\t\t\tstate->second / 910000, (state->second / 910) % 1000);\n\t}\n}\n\n \n\nstatic int msp3400c_detect_stereo(struct i2c_client *client)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tint val;\n\tint rxsubchans = state->rxsubchans;\n\tint newnicam = state->nicam_on;\n\tint update = 0;\n\n\tswitch (state->mode) {\n\tcase MSP_MODE_FM_TERRA:\n\t\tval = msp_read_dsp(client, 0x18);\n\t\tif (val > 32767)\n\t\t\tval -= 65536;\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug,\n\t\t\t\"stereo detect register: %d\\n\", val);\n\t\tif (val > 8192) {\n\t\t\trxsubchans = V4L2_TUNER_SUB_STEREO;\n\t\t} else if (val < -4096) {\n\t\t\trxsubchans = V4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_LANG2;\n\t\t} else {\n\t\t\trxsubchans = V4L2_TUNER_SUB_MONO;\n\t\t}\n\t\tnewnicam = 0;\n\t\tbreak;\n\tcase MSP_MODE_FM_NICAM1:\n\tcase MSP_MODE_FM_NICAM2:\n\tcase MSP_MODE_AM_NICAM:\n\t\tval = msp_read_dem(client, 0x23);\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug, \"nicam sync=%d, mode=%d\\n\",\n\t\t\tval & 1, (val & 0x1e) >> 1);\n\n\t\tif (val & 1) {\n\t\t\t \n\t\t\tswitch ((val & 0x1e) >> 1)  {\n\t\t\tcase 0:\n\t\t\tcase 8:\n\t\t\t\trxsubchans = V4L2_TUNER_SUB_STEREO;\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\tcase 9:\n\t\t\t\trxsubchans = V4L2_TUNER_SUB_MONO;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\tcase 10:\n\t\t\t\trxsubchans = V4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_LANG2;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\trxsubchans = V4L2_TUNER_SUB_MONO;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tnewnicam = 1;\n\t\t} else {\n\t\t\tnewnicam = 0;\n\t\t\trxsubchans = V4L2_TUNER_SUB_MONO;\n\t\t}\n\t\tbreak;\n\t}\n\tif (rxsubchans != state->rxsubchans) {\n\t\tupdate = 1;\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"watch: rxsubchans %02x => %02x\\n\",\n\t\t\tstate->rxsubchans, rxsubchans);\n\t\tstate->rxsubchans = rxsubchans;\n\t}\n\tif (newnicam != state->nicam_on) {\n\t\tupdate = 1;\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"watch: nicam %d => %d\\n\",\n\t\t\tstate->nicam_on, newnicam);\n\t\tstate->nicam_on = newnicam;\n\t}\n\treturn update;\n}\n\n \n \nstatic void watch_stereo(struct i2c_client *client)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\n\tif (msp_detect_stereo(client))\n\t\tmsp_set_audmode(client);\n\n\tif (msp_once)\n\t\tstate->watch_stereo = 0;\n}\n\nint msp3400c_thread(void *data)\n{\n\tstruct i2c_client *client = data;\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tstruct msp3400c_carrier_detect *cd;\n\tint count, max1, max2, val1, val2, val, i;\n\n\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"msp3400 daemon started\\n\");\n\tstate->detected_std = V4L2_STD_ALL;\n\tset_freezable();\n\tfor (;;) {\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug, \"msp3400 thread: sleep\\n\");\n\t\tmsp_sleep(state, -1);\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug, \"msp3400 thread: wakeup\\n\");\n\nrestart:\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug, \"thread: restart scan\\n\");\n\t\tstate->restart = 0;\n\t\tif (kthread_should_stop())\n\t\t\tbreak;\n\n\t\tif (state->radio || MSP_MODE_EXTERN == state->mode) {\n\t\t\t \n\t\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\t\"thread: no carrier scan\\n\");\n\t\t\tstate->scan_in_progress = 0;\n\t\t\tmsp_update_volume(state);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tstate->scan_in_progress = 1;\n\t\tmsp_update_volume(state);\n\n\t\tmsp3400c_set_mode(client, MSP_MODE_AM_DETECT);\n\t\tval1 = val2 = 0;\n\t\tmax1 = max2 = -1;\n\t\tstate->watch_stereo = 0;\n\t\tstate->nicam_on = 0;\n\n\t\t \n\t\tif (msp_sleep(state, 200))\n\t\t\tgoto restart;\n\n\t\t \n\t\tcd = msp3400c_carrier_detect_main;\n\t\tcount = ARRAY_SIZE(msp3400c_carrier_detect_main);\n\n\t\tif (msp_amsound && (state->v4l2_std & V4L2_STD_SECAM)) {\n\t\t\t \n\t\t\tmax1 = 3;\n\t\t\tcount = 0;\n\t\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"AM sound override\\n\");\n\t\t}\n\n\t\tfor (i = 0; i < count; i++) {\n\t\t\tmsp3400c_set_carrier(client, cd[i].cdo, cd[i].cdo);\n\t\t\tif (msp_sleep(state, 100))\n\t\t\t\tgoto restart;\n\t\t\tval = msp_read_dsp(client, 0x1b);\n\t\t\tif (val > 32767)\n\t\t\t\tval -= 65536;\n\t\t\tif (val1 < val) {\n\t\t\t\tval1 = val;\n\t\t\t\tmax1 = i;\n\t\t\t}\n\t\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\t\"carrier1 val: %5d / %s\\n\", val, cd[i].name);\n\t\t}\n\n\t\t \n\t\tswitch (max1) {\n\t\tcase 1:  \n\t\t\tcd = msp3400c_carrier_detect_55;\n\t\t\tcount = ARRAY_SIZE(msp3400c_carrier_detect_55);\n\t\t\tbreak;\n\t\tcase 3:  \n\t\t\tcd = msp3400c_carrier_detect_65;\n\t\t\tcount = ARRAY_SIZE(msp3400c_carrier_detect_65);\n\t\t\tbreak;\n\t\tcase 0:  \n\t\tcase 2:  \n\t\tdefault:\n\t\t\tcd = NULL;\n\t\t\tcount = 0;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (msp_amsound && (state->v4l2_std & V4L2_STD_SECAM)) {\n\t\t\t \n\t\t\tcd = NULL;\n\t\t\tcount = 0;\n\t\t\tmax2 = 0;\n\t\t}\n\t\tfor (i = 0; i < count; i++) {\n\t\t\tmsp3400c_set_carrier(client, cd[i].cdo, cd[i].cdo);\n\t\t\tif (msp_sleep(state, 100))\n\t\t\t\tgoto restart;\n\t\t\tval = msp_read_dsp(client, 0x1b);\n\t\t\tif (val > 32767)\n\t\t\t\tval -= 65536;\n\t\t\tif (val2 < val) {\n\t\t\t\tval2 = val;\n\t\t\t\tmax2 = i;\n\t\t\t}\n\t\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\t\"carrier2 val: %5d / %s\\n\", val, cd[i].name);\n\t\t}\n\n\t\t \n\t\tstate->main = msp3400c_carrier_detect_main[max1].cdo;\n\t\tswitch (max1) {\n\t\tcase 1:  \n\t\t\tstate->detected_std = V4L2_STD_BG | V4L2_STD_PAL_H;\n\t\t\tif (max2 == 0) {\n\t\t\t\t \n\t\t\t\tstate->second = msp3400c_carrier_detect_55[max2].cdo;\n\t\t\t\tmsp3400c_set_mode(client, MSP_MODE_FM_TERRA);\n\t\t\t\tstate->watch_stereo = 1;\n\t\t\t} else if (max2 == 1 && state->has_nicam) {\n\t\t\t\t \n\t\t\t\tstate->second = msp3400c_carrier_detect_55[max2].cdo;\n\t\t\t\tmsp3400c_set_mode(client, MSP_MODE_FM_NICAM1);\n\t\t\t\tstate->nicam_on = 1;\n\t\t\t\tstate->watch_stereo = 1;\n\t\t\t} else {\n\t\t\t\tgoto no_second;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 2:  \n\t\t\t \n\t\t\tstate->detected_std = V4L2_STD_PAL_I;\n\t\t\tstate->second = MSP_CARRIER(6.552);\n\t\t\tmsp3400c_set_mode(client, MSP_MODE_FM_NICAM2);\n\t\t\tstate->nicam_on = 1;\n\t\t\tstate->watch_stereo = 1;\n\t\t\tbreak;\n\t\tcase 3:  \n\t\t\tif (max2 == 1 || max2 == 2) {\n\t\t\t\t \n\t\t\t\tstate->second = msp3400c_carrier_detect_65[max2].cdo;\n\t\t\t\tmsp3400c_set_mode(client, MSP_MODE_FM_TERRA);\n\t\t\t\tstate->watch_stereo = 1;\n\t\t\t\tstate->detected_std = V4L2_STD_DK;\n\t\t\t} else if (max2 == 0 && (state->v4l2_std & V4L2_STD_SECAM)) {\n\t\t\t\t \n\t\t\t\tstate->second = msp3400c_carrier_detect_65[max2].cdo;\n\t\t\t\tmsp3400c_set_mode(client, MSP_MODE_AM_NICAM);\n\t\t\t\tstate->watch_stereo = 1;\n\t\t\t\tstate->detected_std = V4L2_STD_L;\n\t\t\t} else if (max2 == 0 && state->has_nicam) {\n\t\t\t\t \n\t\t\t\tstate->second = msp3400c_carrier_detect_65[max2].cdo;\n\t\t\t\tmsp3400c_set_mode(client, MSP_MODE_FM_NICAM1);\n\t\t\t\tstate->nicam_on = 1;\n\t\t\t\tstate->watch_stereo = 1;\n\t\t\t\tstate->detected_std = V4L2_STD_DK;\n\t\t\t} else {\n\t\t\t\tgoto no_second;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 0:  \n\t\t\tstate->detected_std = V4L2_STD_MN;\n\t\t\tfallthrough;\n\t\tdefault:\nno_second:\n\t\t\tstate->second = msp3400c_carrier_detect_main[max1].cdo;\n\t\t\tmsp3400c_set_mode(client, MSP_MODE_FM_TERRA);\n\t\t\tbreak;\n\t\t}\n\t\tmsp3400c_set_carrier(client, state->second, state->main);\n\n\t\t \n\t\tstate->scan_in_progress = 0;\n\t\tmsp3400c_set_audmode(client);\n\t\tmsp_update_volume(state);\n\n\t\tif (msp_debug)\n\t\t\tmsp3400c_print_mode(client);\n\n\t\t \n\t\tcount = 3;\n\t\twhile (state->watch_stereo) {\n\t\t\tif (msp_sleep(state, count ? 1000 : 5000))\n\t\t\t\tgoto restart;\n\t\t\tif (count)\n\t\t\t\tcount--;\n\t\t\twatch_stereo(client);\n\t\t}\n\t}\n\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"thread: exit\\n\");\n\treturn 0;\n}\n\n\nint msp3410d_thread(void *data)\n{\n\tstruct i2c_client *client = data;\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tint val, i, std, count;\n\n\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"msp3410 daemon started\\n\");\n\tstate->detected_std = V4L2_STD_ALL;\n\tset_freezable();\n\tfor (;;) {\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug, \"msp3410 thread: sleep\\n\");\n\t\tmsp_sleep(state, -1);\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug, \"msp3410 thread: wakeup\\n\");\n\nrestart:\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug, \"thread: restart scan\\n\");\n\t\tstate->restart = 0;\n\t\tif (kthread_should_stop())\n\t\t\tbreak;\n\n\t\tif (state->mode == MSP_MODE_EXTERN) {\n\t\t\t \n\t\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\t\"thread: no carrier scan\\n\");\n\t\t\tstate->scan_in_progress = 0;\n\t\t\tmsp_update_volume(state);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tstate->scan_in_progress = 1;\n\t\tmsp_update_volume(state);\n\n\t\t \n\t\tif (state->radio)\n\t\t\tstd = 0x40;\n\t\telse\n\t\t\tstd = (state->v4l2_std & V4L2_STD_NTSC) ? 0x20 : 1;\n\t\tstate->watch_stereo = 0;\n\t\tstate->nicam_on = 0;\n\n\t\t \n\t\tif (msp_sleep(state, 200))\n\t\t\tgoto restart;\n\n\t\tif (msp_debug)\n\t\t\tdev_dbg_lvl(&client->dev, 2, msp_debug,\n\t\t\t\t\"setting standard: %s (0x%04x)\\n\",\n\t\t\t\tmsp_standard_std_name(std), std);\n\n\t\tif (std != 1) {\n\t\t\t \n\t\t\tval = std;\n\t\t} else {\n\t\t\t \n\t\t\tmsp_write_dem(client, 0x20, std);\n\t\t\tfor (;;) {\n\t\t\t\tif (msp_sleep(state, 100))\n\t\t\t\t\tgoto restart;\n\n\t\t\t\t \n\t\t\t\tval = msp_read_dem(client, 0x7e);\n\t\t\t\tif (val < 0x07ff)\n\t\t\t\t\tbreak;\n\t\t\t\tdev_dbg_lvl(&client->dev, 2, msp_debug,\n\t\t\t\t\t\"detection still in progress\\n\");\n\t\t\t}\n\t\t}\n\t\tfor (i = 0; msp_stdlist[i].name != NULL; i++)\n\t\t\tif (msp_stdlist[i].retval == val)\n\t\t\t\tbreak;\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"current standard: %s (0x%04x)\\n\",\n\t\t\tmsp_standard_std_name(val), val);\n\t\tstate->main   = msp_stdlist[i].main;\n\t\tstate->second = msp_stdlist[i].second;\n\t\tstate->std = val;\n\t\tstate->rxsubchans = V4L2_TUNER_SUB_MONO;\n\n\t\tif (msp_amsound && !state->radio &&\n\t\t    (state->v4l2_std & V4L2_STD_SECAM) && (val != 0x0009)) {\n\t\t\t \n\t\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"autodetection failed, switching to backup standard: %s (0x%04x)\\n\",\n\t\t\t\tmsp_stdlist[8].name ?\n\t\t\t\t\tmsp_stdlist[8].name : \"unknown\", val);\n\t\t\tstate->std = val = 0x0009;\n\t\t\tmsp_write_dem(client, 0x20, val);\n\t\t} else {\n\t\t\tstate->detected_std = msp_standard_std(state->std);\n\t\t}\n\n\t\t \n\t\tswitch (val) {\n\t\tcase 0x0008:  \n\t\tcase 0x000a:  \n\t\tcase 0x000b:  \n\t\t\tif (val == 0x000a)\n\t\t\t\tstate->mode = MSP_MODE_FM_NICAM2;\n\t\t\telse\n\t\t\t\tstate->mode = MSP_MODE_FM_NICAM1;\n\t\t\t \n\t\t\tstate->nicam_on = 1;\n\t\t\tstate->watch_stereo = 1;\n\t\t\tbreak;\n\t\tcase 0x0009:\n\t\t\tstate->mode = MSP_MODE_AM_NICAM;\n\t\t\tstate->nicam_on = 1;\n\t\t\tstate->watch_stereo = 1;\n\t\t\tbreak;\n\t\tcase 0x0020:  \n\t\t\t \n\t\t\tstate->mode = MSP_MODE_BTSC;\n\t\t\tbreak;\n\t\tcase 0x0040:  \n\t\t\tstate->mode = MSP_MODE_FM_RADIO;\n\t\t\tstate->rxsubchans = V4L2_TUNER_SUB_STEREO;\n\t\t\t \n\t\t\tmsp3400c_set_mode(client, MSP_MODE_FM_RADIO);\n\t\t\tmsp3400c_set_carrier(client, MSP_CARRIER(10.7),\n\t\t\t\t\t    MSP_CARRIER(10.7));\n\t\t\tbreak;\n\t\tcase 0x0002:\n\t\tcase 0x0003:\n\t\tcase 0x0004:\n\t\tcase 0x0005:\n\t\t\tstate->mode = MSP_MODE_FM_TERRA;\n\t\t\tstate->watch_stereo = 1;\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tmsp_write_dsp(client, 0x0d, 0x1900);  \n\t\tmsp_write_dsp(client, 0x0e, 0x3000);  \n\t\tif (state->has_nicam)\n\t\t\tmsp_write_dsp(client, 0x10, 0x5a00);  \n\n\t\tif (state->has_i2s_conf)\n\t\t\tmsp_write_dem(client, 0x40, state->i2s_mode);\n\n\t\t \n\t\tmsp3400c_set_audmode(client);\n\t\tstate->scan_in_progress = 0;\n\t\tmsp_update_volume(state);\n\n\t\t \n\t\tcount = 3;\n\t\twhile (state->watch_stereo) {\n\t\t\tif (msp_sleep(state, count ? 1000 : 5000))\n\t\t\t\tgoto restart;\n\t\t\tif (count)\n\t\t\t\tcount--;\n\t\t\twatch_stereo(client);\n\t\t}\n\t}\n\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"thread: exit\\n\");\n\treturn 0;\n}\n\n \n\n \n\nstatic int msp34xxg_modus(struct i2c_client *client)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\n\tif (state->radio) {\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"selected radio modus\\n\");\n\t\treturn 0x0001;\n\t}\n\tif (state->v4l2_std == V4L2_STD_NTSC_M_JP) {\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"selected M (EIA-J) modus\\n\");\n\t\treturn 0x4001;\n\t}\n\tif (state->v4l2_std == V4L2_STD_NTSC_M_KR) {\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"selected M (A2) modus\\n\");\n\t\treturn 0x0001;\n\t}\n\tif (state->v4l2_std == V4L2_STD_SECAM_L) {\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"selected SECAM-L modus\\n\");\n\t\treturn 0x6001;\n\t}\n\tif (state->v4l2_std & V4L2_STD_MN) {\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"selected M (BTSC) modus\\n\");\n\t\treturn 0x2001;\n\t}\n\treturn 0x7001;\n}\n\nstatic void msp34xxg_set_source(struct i2c_client *client, u16 reg, int in)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tint source, matrix;\n\n\tswitch (state->audmode) {\n\tcase V4L2_TUNER_MODE_MONO:\n\t\tsource = 0;  \n\t\tmatrix = 0x30;\n\t\tbreak;\n\tcase V4L2_TUNER_MODE_LANG2:\n\t\tsource = 4;  \n\t\tmatrix = 0x10;\n\t\tbreak;\n\tcase V4L2_TUNER_MODE_LANG1_LANG2:\n\t\tsource = 1;  \n\t\tmatrix = 0x20;\n\t\tbreak;\n\tcase V4L2_TUNER_MODE_LANG1:\n\t\tsource = 3;  \n\t\tmatrix = 0x00;\n\t\tbreak;\n\tcase V4L2_TUNER_MODE_STEREO:\n\tdefault:\n\t\tsource = 3;  \n\t\tmatrix = 0x20;\n\t\tbreak;\n\t}\n\n\tif (in == MSP_DSP_IN_TUNER)\n\t\tsource = (source << 8) | 0x20;\n\t \n\telse if (in >= MSP_DSP_IN_MAIN_AVC && state->has_dolby_pro_logic)\n\t\tsource = ((in + 1) << 8) | matrix;\n\telse\n\t\tsource = (in << 8) | matrix;\n\n\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\"set source to %d (0x%x) for output %02x\\n\", in, source, reg);\n\tmsp_write_dsp(client, reg, source);\n}\n\nstatic void msp34xxg_set_sources(struct i2c_client *client)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tu32 in = state->route_in;\n\n\tmsp34xxg_set_source(client, 0x0008, (in >> 4) & 0xf);\n\t \n\tmsp34xxg_set_source(client, 0x000c, (in >> 4) & 0xf);\n\tmsp34xxg_set_source(client, 0x0009, (in >> 8) & 0xf);\n\tmsp34xxg_set_source(client, 0x000a, (in >> 12) & 0xf);\n\tif (state->has_scart2_out)\n\t\tmsp34xxg_set_source(client, 0x0041, (in >> 16) & 0xf);\n\tmsp34xxg_set_source(client, 0x000b, (in >> 20) & 0xf);\n}\n\n \nstatic void msp34xxg_reset(struct i2c_client *client)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tint tuner = (state->route_in >> 3) & 1;\n\tint modus;\n\n\t \n\tstate->std = 1;\n\n\tmsp_reset(client);\n\n\tif (state->has_i2s_conf)\n\t\tmsp_write_dem(client, 0x40, state->i2s_mode);\n\n\t \n\tmodus = msp34xxg_modus(client);\n\tmodus |= tuner ? 0x100 : 0;\n\tmsp_write_dem(client, 0x30, modus);\n\n\t \n\tmsp34xxg_set_sources(client);\n\n\tmsp_write_dsp(client, 0x0d, 0x1900);  \n\tmsp_write_dsp(client, 0x0e, 0x3000);  \n\tif (state->has_nicam)\n\t\tmsp_write_dsp(client, 0x10, 0x5a00);  \n\n\t \n\tmsp_write_dem(client, 0x22, msp_stereo_thresh);\n}\n\nint msp34xxg_thread(void *data)\n{\n\tstruct i2c_client *client = data;\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tint val, i;\n\n\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"msp34xxg daemon started\\n\");\n\tstate->detected_std = V4L2_STD_ALL;\n\tset_freezable();\n\tfor (;;) {\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug, \"msp34xxg thread: sleep\\n\");\n\t\tmsp_sleep(state, -1);\n\t\tdev_dbg_lvl(&client->dev, 2, msp_debug, \"msp34xxg thread: wakeup\\n\");\n\nrestart:\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"thread: restart scan\\n\");\n\t\tstate->restart = 0;\n\t\tif (kthread_should_stop())\n\t\t\tbreak;\n\n\t\tif (state->mode == MSP_MODE_EXTERN) {\n\t\t\t \n\t\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\t\"thread: no carrier scan\\n\");\n\t\t\tstate->scan_in_progress = 0;\n\t\t\tmsp_update_volume(state);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tmsp34xxg_reset(client);\n\t\tstate->std = state->radio ? 0x40 :\n\t\t\t(state->force_btsc && msp_standard == 1) ? 32 : msp_standard;\n\t\tmsp_write_dem(client, 0x20, state->std);\n\t\t \n\t\tif (state->std != 1)\n\t\t\tgoto unmute;\n\n\t\t \n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"started autodetect, waiting for result\\n\");\n\t\tfor (i = 0; i < 10; i++) {\n\t\t\tif (msp_sleep(state, 100))\n\t\t\t\tgoto restart;\n\n\t\t\t \n\t\t\tval = msp_read_dem(client, 0x7e);\n\t\t\tif (val < 0x07ff) {\n\t\t\t\tstate->std = val;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdev_dbg_lvl(&client->dev, 2, msp_debug,\n\t\t\t\t\"detection still in progress\\n\");\n\t\t}\n\t\tif (state->std == 1) {\n\t\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\t\"detection still in progress after 10 tries. giving up.\\n\");\n\t\t\tcontinue;\n\t\t}\n\nunmute:\n\t\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\t\"detected standard: %s (0x%04x)\\n\",\n\t\t\tmsp_standard_std_name(state->std), state->std);\n\t\tstate->detected_std = msp_standard_std(state->std);\n\n\t\tif (state->std == 9) {\n\t\t\t \n\t\t\tmsp_write_dsp(client, 0x0e, 0x7c00);\n\t\t}\n\n\t\t \n\t\tmsp_update_volume(state);\n\n\t\t \n\t\tif (msp_write_dsp(client, 0x13, state->acb))\n\t\t\treturn -1;\n\n\t\t \n\t\tif (state->std != 0x20)\n\t\t\tcontinue;\n\n\t\tstate->watch_stereo = 1;\n\n\t\t \n\t\twatch_stereo(client);\n\t\twhile (state->watch_stereo) {\n\t\t\twatch_stereo(client);\n\t\t\tif (msp_sleep(state, 5000))\n\t\t\t\tgoto restart;\n\t\t}\n\t}\n\tdev_dbg_lvl(&client->dev, 1, msp_debug, \"thread: exit\\n\");\n\treturn 0;\n}\n\nstatic int msp34xxg_detect_stereo(struct i2c_client *client)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\tint status = msp_read_dem(client, 0x0200);\n\tint is_bilingual = status & 0x100;\n\tint is_stereo = status & 0x40;\n\tint oldrx = state->rxsubchans;\n\n\tif (state->mode == MSP_MODE_EXTERN)\n\t\treturn 0;\n\n\tstate->rxsubchans = 0;\n\tif (is_stereo)\n\t\tstate->rxsubchans = V4L2_TUNER_SUB_STEREO;\n\telse\n\t\tstate->rxsubchans = V4L2_TUNER_SUB_MONO;\n\tif (is_bilingual) {\n\t\tif (state->std == 0x20)\n\t\t\tstate->rxsubchans |= V4L2_TUNER_SUB_SAP;\n\t\telse\n\t\t\tstate->rxsubchans =\n\t\t\t\tV4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_LANG2;\n\t}\n\tdev_dbg_lvl(&client->dev, 1, msp_debug,\n\t\t\"status=0x%x, stereo=%d, bilingual=%d -> rxsubchans=%d\\n\",\n\t\tstatus, is_stereo, is_bilingual, state->rxsubchans);\n\treturn (oldrx != state->rxsubchans);\n}\n\nstatic void msp34xxg_set_audmode(struct i2c_client *client)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\n\tif (state->std == 0x20) {\n\t       if ((state->rxsubchans & V4L2_TUNER_SUB_SAP) &&\n\t\t   (state->audmode == V4L2_TUNER_MODE_LANG1_LANG2 ||\n\t\t    state->audmode == V4L2_TUNER_MODE_LANG2)) {\n\t\t\tmsp_write_dem(client, 0x20, 0x21);\n\t       } else {\n\t\t\tmsp_write_dem(client, 0x20, 0x20);\n\t       }\n\t}\n\n\tmsp34xxg_set_sources(client);\n}\n\nvoid msp_set_audmode(struct i2c_client *client)\n{\n\tstruct msp_state *state = to_state(i2c_get_clientdata(client));\n\n\tswitch (state->opmode) {\n\tcase OPMODE_MANUAL:\n\tcase OPMODE_AUTODETECT:\n\t\tmsp3400c_set_audmode(client);\n\t\tbreak;\n\tcase OPMODE_AUTOSELECT:\n\t\tmsp34xxg_set_audmode(client);\n\t\tbreak;\n\t}\n}\n\nint msp_detect_stereo(struct i2c_client *client)\n{\n\tstruct msp_state *state  = to_state(i2c_get_clientdata(client));\n\n\tswitch (state->opmode) {\n\tcase OPMODE_MANUAL:\n\tcase OPMODE_AUTODETECT:\n\t\treturn msp3400c_detect_stereo(client);\n\tcase OPMODE_AUTOSELECT:\n\t\treturn msp34xxg_detect_stereo(client);\n\t}\n\treturn 0;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}