{
  "module_name": "tvp7002.c",
  "hash_id": "3ac4c64e34e184c075b93508f3474373419bb2ce7c1e4d0c918ce5d4c2c543e0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/i2c/tvp7002.c",
  "human_readable_source": "\n \n#include <linux/delay.h>\n#include <linux/i2c.h>\n#include <linux/slab.h>\n#include <linux/videodev2.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_graph.h>\n#include <linux/v4l2-dv-timings.h>\n#include <media/i2c/tvp7002.h>\n#include <media/v4l2-async.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-common.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-fwnode.h>\n\n#include \"tvp7002_reg.h\"\n\nMODULE_DESCRIPTION(\"TI TVP7002 Video and Graphics Digitizer driver\");\nMODULE_AUTHOR(\"Santiago Nunez-Corrales <santiago.nunez@ridgerun.com>\");\nMODULE_LICENSE(\"GPL\");\n\n \n#define I2C_RETRY_COUNT\t\t(5)\n\n \n#define TVP7002_EOR\t\t0x5c\n\n \n#define TVP7002_READ\t\t0\n#define TVP7002_WRITE\t\t1\n#define TVP7002_RESERVED\t2\n\n \n#define TVP7002_IP_SHIFT\t5\n#define TVP7002_INPR_MASK\t(0x01 << TVP7002_IP_SHIFT)\n\n \n#define TVP7002_CL_SHIFT\t8\n#define TVP7002_CL_MASK\t\t0x0f\n\n \nstatic bool debug;\nmodule_param(debug, bool, 0644);\nMODULE_PARM_DESC(debug, \"Debug level (0-2)\");\n\n \nstruct i2c_reg_value {\n\tu8 reg;\n\tu8 value;\n\tu8 type;\n};\n\n \nstatic const struct i2c_reg_value tvp7002_init_default[] = {\n\t{ TVP7002_CHIP_REV, 0xff, TVP7002_READ },\n\t{ TVP7002_HPLL_FDBK_DIV_MSBS, 0x67, TVP7002_WRITE },\n\t{ TVP7002_HPLL_FDBK_DIV_LSBS, 0x20, TVP7002_WRITE },\n\t{ TVP7002_HPLL_CRTL, 0xa0, TVP7002_WRITE },\n\t{ TVP7002_HPLL_PHASE_SEL, 0x80, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_START, 0x32, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_W, 0x20, TVP7002_WRITE },\n\t{ TVP7002_HSYNC_OUT_W, 0x60, TVP7002_WRITE },\n\t{ TVP7002_B_FINE_GAIN, 0x00, TVP7002_WRITE },\n\t{ TVP7002_G_FINE_GAIN, 0x00, TVP7002_WRITE },\n\t{ TVP7002_R_FINE_GAIN, 0x00, TVP7002_WRITE },\n\t{ TVP7002_B_FINE_OFF_MSBS, 0x80, TVP7002_WRITE },\n\t{ TVP7002_G_FINE_OFF_MSBS, 0x80, TVP7002_WRITE },\n\t{ TVP7002_R_FINE_OFF_MSBS, 0x80, TVP7002_WRITE },\n\t{ TVP7002_SYNC_CTL_1, 0x20, TVP7002_WRITE },\n\t{ TVP7002_HPLL_AND_CLAMP_CTL, 0x2e, TVP7002_WRITE },\n\t{ TVP7002_SYNC_ON_G_THRS, 0x5d, TVP7002_WRITE },\n\t{ TVP7002_SYNC_SEPARATOR_THRS, 0x47, TVP7002_WRITE },\n\t{ TVP7002_HPLL_PRE_COAST, 0x00, TVP7002_WRITE },\n\t{ TVP7002_HPLL_POST_COAST, 0x00, TVP7002_WRITE },\n\t{ TVP7002_SYNC_DETECT_STAT, 0xff, TVP7002_READ },\n\t{ TVP7002_OUT_FORMATTER, 0x47, TVP7002_WRITE },\n\t{ TVP7002_MISC_CTL_1, 0x01, TVP7002_WRITE },\n\t{ TVP7002_MISC_CTL_2, 0x00, TVP7002_WRITE },\n\t{ TVP7002_MISC_CTL_3, 0x01, TVP7002_WRITE },\n\t{ TVP7002_IN_MUX_SEL_1, 0x00, TVP7002_WRITE },\n\t{ TVP7002_IN_MUX_SEL_2, 0x67, TVP7002_WRITE },\n\t{ TVP7002_B_AND_G_COARSE_GAIN, 0x77, TVP7002_WRITE },\n\t{ TVP7002_R_COARSE_GAIN, 0x07, TVP7002_WRITE },\n\t{ TVP7002_FINE_OFF_LSBS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_B_COARSE_OFF, 0x10, TVP7002_WRITE },\n\t{ TVP7002_G_COARSE_OFF, 0x10, TVP7002_WRITE },\n\t{ TVP7002_R_COARSE_OFF, 0x10, TVP7002_WRITE },\n\t{ TVP7002_HSOUT_OUT_START, 0x08, TVP7002_WRITE },\n\t{ TVP7002_MISC_CTL_4, 0x00, TVP7002_WRITE },\n\t{ TVP7002_B_DGTL_ALC_OUT_LSBS, 0xff, TVP7002_READ },\n\t{ TVP7002_G_DGTL_ALC_OUT_LSBS, 0xff, TVP7002_READ },\n\t{ TVP7002_R_DGTL_ALC_OUT_LSBS, 0xff, TVP7002_READ },\n\t{ TVP7002_AUTO_LVL_CTL_ENABLE, 0x80, TVP7002_WRITE },\n\t{ TVP7002_DGTL_ALC_OUT_MSBS, 0xff, TVP7002_READ },\n\t{ TVP7002_AUTO_LVL_CTL_FILTER, 0x53, TVP7002_WRITE },\n\t{ 0x29, 0x08, TVP7002_RESERVED },\n\t{ TVP7002_FINE_CLAMP_CTL, 0x07, TVP7002_WRITE },\n\t \n\t{ TVP7002_PWR_CTL, 0x00, TVP7002_RESERVED },\n\t{ TVP7002_ADC_SETUP, 0x50, TVP7002_WRITE },\n\t{ TVP7002_COARSE_CLAMP_CTL, 0x00, TVP7002_WRITE },\n\t{ TVP7002_SOG_CLAMP, 0x80, TVP7002_WRITE },\n\t{ TVP7002_RGB_COARSE_CLAMP_CTL, 0x8c, TVP7002_WRITE },\n\t{ TVP7002_SOG_COARSE_CLAMP_CTL, 0x04, TVP7002_WRITE },\n\t{ TVP7002_ALC_PLACEMENT, 0x5a, TVP7002_WRITE },\n\t{ 0x32, 0x18, TVP7002_RESERVED },\n\t{ 0x33, 0x60, TVP7002_RESERVED },\n\t{ TVP7002_MVIS_STRIPPER_W, 0xff, TVP7002_RESERVED },\n\t{ TVP7002_VSYNC_ALGN, 0x10, TVP7002_WRITE },\n\t{ TVP7002_SYNC_BYPASS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_L_FRAME_STAT_LSBS, 0xff, TVP7002_READ },\n\t{ TVP7002_L_FRAME_STAT_MSBS, 0xff, TVP7002_READ },\n\t{ TVP7002_CLK_L_STAT_LSBS, 0xff, TVP7002_READ },\n\t{ TVP7002_CLK_L_STAT_MSBS, 0xff, TVP7002_READ },\n\t{ TVP7002_HSYNC_W, 0xff, TVP7002_READ },\n\t{ TVP7002_VSYNC_W, 0xff, TVP7002_READ },\n\t{ TVP7002_L_LENGTH_TOL, 0x03, TVP7002_WRITE },\n\t{ 0x3e, 0x60, TVP7002_RESERVED },\n\t{ TVP7002_VIDEO_BWTH_CTL, 0x01, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_LSBS, 0x01, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_MSBS, 0x2c, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_LSBS, 0x06, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_MSBS, 0x2c, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_START_L_OFF, 0x05, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_START_L_OFF, 0x00, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_DURATION, 0x1e, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_DURATION, 0x00, TVP7002_WRITE },\n\t{ TVP7002_FBIT_F_0_START_L_OFF, 0x00, TVP7002_WRITE },\n\t{ TVP7002_FBIT_F_1_START_L_OFF, 0x00, TVP7002_WRITE },\n\t{ TVP7002_YUV_Y_G_COEF_LSBS, 0xe3, TVP7002_WRITE },\n\t{ TVP7002_YUV_Y_G_COEF_MSBS, 0x16, TVP7002_WRITE },\n\t{ TVP7002_YUV_Y_B_COEF_LSBS, 0x4f, TVP7002_WRITE },\n\t{ TVP7002_YUV_Y_B_COEF_MSBS, 0x02, TVP7002_WRITE },\n\t{ TVP7002_YUV_Y_R_COEF_LSBS, 0xce, TVP7002_WRITE },\n\t{ TVP7002_YUV_Y_R_COEF_MSBS, 0x06, TVP7002_WRITE },\n\t{ TVP7002_YUV_U_G_COEF_LSBS, 0xab, TVP7002_WRITE },\n\t{ TVP7002_YUV_U_G_COEF_MSBS, 0xf3, TVP7002_WRITE },\n\t{ TVP7002_YUV_U_B_COEF_LSBS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_YUV_U_B_COEF_MSBS, 0x10, TVP7002_WRITE },\n\t{ TVP7002_YUV_U_R_COEF_LSBS, 0x55, TVP7002_WRITE },\n\t{ TVP7002_YUV_U_R_COEF_MSBS, 0xfc, TVP7002_WRITE },\n\t{ TVP7002_YUV_V_G_COEF_LSBS, 0x78, TVP7002_WRITE },\n\t{ TVP7002_YUV_V_G_COEF_MSBS, 0xf1, TVP7002_WRITE },\n\t{ TVP7002_YUV_V_B_COEF_LSBS, 0x88, TVP7002_WRITE },\n\t{ TVP7002_YUV_V_B_COEF_MSBS, 0xfe, TVP7002_WRITE },\n\t{ TVP7002_YUV_V_R_COEF_LSBS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_YUV_V_R_COEF_MSBS, 0x10, TVP7002_WRITE },\n\t \n\t{ TVP7002_EOR, 0xff, TVP7002_RESERVED }\n};\n\n \nstatic const struct i2c_reg_value tvp7002_parms_480P[] = {\n\t{ TVP7002_HPLL_FDBK_DIV_MSBS, 0x35, TVP7002_WRITE },\n\t{ TVP7002_HPLL_FDBK_DIV_LSBS, 0xa0, TVP7002_WRITE },\n\t{ TVP7002_HPLL_CRTL, 0x02, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_LSBS, 0x91, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_MSBS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_LSBS, 0x0B, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_MSBS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_START_L_OFF, 0x03, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_START_L_OFF, 0x01, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_DURATION, 0x13, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_DURATION, 0x13, TVP7002_WRITE },\n\t{ TVP7002_ALC_PLACEMENT, 0x18, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_START, 0x06, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_W, 0x10, TVP7002_WRITE },\n\t{ TVP7002_HPLL_PRE_COAST, 0x03, TVP7002_WRITE },\n\t{ TVP7002_HPLL_POST_COAST, 0x03, TVP7002_WRITE },\n\t{ TVP7002_EOR, 0xff, TVP7002_RESERVED }\n};\n\n \nstatic const struct i2c_reg_value tvp7002_parms_576P[] = {\n\t{ TVP7002_HPLL_FDBK_DIV_MSBS, 0x36, TVP7002_WRITE },\n\t{ TVP7002_HPLL_FDBK_DIV_LSBS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_HPLL_CRTL, 0x18, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_LSBS, 0x9B, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_MSBS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_LSBS, 0x0F, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_MSBS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_START_L_OFF, 0x00, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_START_L_OFF, 0x00, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_DURATION, 0x2D, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_DURATION, 0x00, TVP7002_WRITE },\n\t{ TVP7002_ALC_PLACEMENT, 0x18, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_START, 0x06, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_W, 0x10, TVP7002_WRITE },\n\t{ TVP7002_HPLL_PRE_COAST, 0x03, TVP7002_WRITE },\n\t{ TVP7002_HPLL_POST_COAST, 0x03, TVP7002_WRITE },\n\t{ TVP7002_EOR, 0xff, TVP7002_RESERVED }\n};\n\n \nstatic const struct i2c_reg_value tvp7002_parms_1080I60[] = {\n\t{ TVP7002_HPLL_FDBK_DIV_MSBS, 0x89, TVP7002_WRITE },\n\t{ TVP7002_HPLL_FDBK_DIV_LSBS, 0x80, TVP7002_WRITE },\n\t{ TVP7002_HPLL_CRTL, 0x98, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_LSBS, 0x06, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_MSBS, 0x01, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_LSBS, 0x8a, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_MSBS, 0x08, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_START_L_OFF, 0x02, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_START_L_OFF, 0x02, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_DURATION, 0x16, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_DURATION, 0x17, TVP7002_WRITE },\n\t{ TVP7002_ALC_PLACEMENT, 0x5a, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_START, 0x32, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_W, 0x20, TVP7002_WRITE },\n\t{ TVP7002_HPLL_PRE_COAST, 0x01, TVP7002_WRITE },\n\t{ TVP7002_HPLL_POST_COAST, 0x00, TVP7002_WRITE },\n\t{ TVP7002_EOR, 0xff, TVP7002_RESERVED }\n};\n\n \nstatic const struct i2c_reg_value tvp7002_parms_1080P60[] = {\n\t{ TVP7002_HPLL_FDBK_DIV_MSBS, 0x89, TVP7002_WRITE },\n\t{ TVP7002_HPLL_FDBK_DIV_LSBS, 0x80, TVP7002_WRITE },\n\t{ TVP7002_HPLL_CRTL, 0xE0, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_LSBS, 0x06, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_MSBS, 0x01, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_LSBS, 0x8a, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_MSBS, 0x08, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_START_L_OFF, 0x02, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_START_L_OFF, 0x02, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_DURATION, 0x16, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_DURATION, 0x17, TVP7002_WRITE },\n\t{ TVP7002_ALC_PLACEMENT, 0x5a, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_START, 0x32, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_W, 0x20, TVP7002_WRITE },\n\t{ TVP7002_HPLL_PRE_COAST, 0x01, TVP7002_WRITE },\n\t{ TVP7002_HPLL_POST_COAST, 0x00, TVP7002_WRITE },\n\t{ TVP7002_EOR, 0xff, TVP7002_RESERVED }\n};\n\n \nstatic const struct i2c_reg_value tvp7002_parms_1080I50[] = {\n\t{ TVP7002_HPLL_FDBK_DIV_MSBS, 0xa5, TVP7002_WRITE },\n\t{ TVP7002_HPLL_FDBK_DIV_LSBS, 0x00, TVP7002_WRITE },\n\t{ TVP7002_HPLL_CRTL, 0x98, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_LSBS, 0x06, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_MSBS, 0x01, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_LSBS, 0x8a, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_MSBS, 0x08, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_START_L_OFF, 0x02, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_START_L_OFF, 0x02, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_DURATION, 0x16, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_DURATION, 0x17, TVP7002_WRITE },\n\t{ TVP7002_ALC_PLACEMENT, 0x5a, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_START, 0x32, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_W, 0x20, TVP7002_WRITE },\n\t{ TVP7002_HPLL_PRE_COAST, 0x01, TVP7002_WRITE },\n\t{ TVP7002_HPLL_POST_COAST, 0x00, TVP7002_WRITE },\n\t{ TVP7002_EOR, 0xff, TVP7002_RESERVED }\n};\n\n \nstatic const struct i2c_reg_value tvp7002_parms_720P60[] = {\n\t{ TVP7002_HPLL_FDBK_DIV_MSBS, 0x67, TVP7002_WRITE },\n\t{ TVP7002_HPLL_FDBK_DIV_LSBS, 0x20, TVP7002_WRITE },\n\t{ TVP7002_HPLL_CRTL, 0xa0, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_LSBS, 0x47, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_MSBS, 0x01, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_LSBS, 0x4B, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_MSBS, 0x06, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_START_L_OFF, 0x05, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_START_L_OFF, 0x00, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_DURATION, 0x2D, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_DURATION, 0x00, TVP7002_WRITE },\n\t{ TVP7002_ALC_PLACEMENT, 0x5a, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_START, 0x32, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_W, 0x20, TVP7002_WRITE },\n\t{ TVP7002_HPLL_PRE_COAST, 0x00, TVP7002_WRITE },\n\t{ TVP7002_HPLL_POST_COAST, 0x00, TVP7002_WRITE },\n\t{ TVP7002_EOR, 0xff, TVP7002_RESERVED }\n};\n\n \nstatic const struct i2c_reg_value tvp7002_parms_720P50[] = {\n\t{ TVP7002_HPLL_FDBK_DIV_MSBS, 0x7b, TVP7002_WRITE },\n\t{ TVP7002_HPLL_FDBK_DIV_LSBS, 0xc0, TVP7002_WRITE },\n\t{ TVP7002_HPLL_CRTL, 0x98, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_LSBS, 0x47, TVP7002_WRITE },\n\t{ TVP7002_AVID_START_PIXEL_MSBS, 0x01, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_LSBS, 0x4B, TVP7002_WRITE },\n\t{ TVP7002_AVID_STOP_PIXEL_MSBS, 0x06, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_START_L_OFF, 0x05, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_START_L_OFF, 0x00, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_0_DURATION, 0x2D, TVP7002_WRITE },\n\t{ TVP7002_VBLK_F_1_DURATION, 0x00, TVP7002_WRITE },\n\t{ TVP7002_ALC_PLACEMENT, 0x5a, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_START, 0x32, TVP7002_WRITE },\n\t{ TVP7002_CLAMP_W, 0x20, TVP7002_WRITE },\n\t{ TVP7002_HPLL_PRE_COAST, 0x01, TVP7002_WRITE },\n\t{ TVP7002_HPLL_POST_COAST, 0x00, TVP7002_WRITE },\n\t{ TVP7002_EOR, 0xff, TVP7002_RESERVED }\n};\n\n \nstruct tvp7002_timings_definition {\n\tstruct v4l2_dv_timings timings;\n\tconst struct i2c_reg_value *p_settings;\n\tenum v4l2_colorspace color_space;\n\tenum v4l2_field scanmode;\n\tu16 progressive;\n\tu16 lines_per_frame;\n\tu16 cpl_min;\n\tu16 cpl_max;\n};\n\n \nstatic const struct tvp7002_timings_definition tvp7002_timings[] = {\n\t{\n\t\tV4L2_DV_BT_CEA_1280X720P60,\n\t\ttvp7002_parms_720P60,\n\t\tV4L2_COLORSPACE_REC709,\n\t\tV4L2_FIELD_NONE,\n\t\t1,\n\t\t0x2EE,\n\t\t135,\n\t\t153\n\t},\n\t{\n\t\tV4L2_DV_BT_CEA_1920X1080I60,\n\t\ttvp7002_parms_1080I60,\n\t\tV4L2_COLORSPACE_REC709,\n\t\tV4L2_FIELD_INTERLACED,\n\t\t0,\n\t\t0x465,\n\t\t181,\n\t\t205\n\t},\n\t{\n\t\tV4L2_DV_BT_CEA_1920X1080I50,\n\t\ttvp7002_parms_1080I50,\n\t\tV4L2_COLORSPACE_REC709,\n\t\tV4L2_FIELD_INTERLACED,\n\t\t0,\n\t\t0x465,\n\t\t217,\n\t\t245\n\t},\n\t{\n\t\tV4L2_DV_BT_CEA_1280X720P50,\n\t\ttvp7002_parms_720P50,\n\t\tV4L2_COLORSPACE_REC709,\n\t\tV4L2_FIELD_NONE,\n\t\t1,\n\t\t0x2EE,\n\t\t163,\n\t\t183\n\t},\n\t{\n\t\tV4L2_DV_BT_CEA_1920X1080P60,\n\t\ttvp7002_parms_1080P60,\n\t\tV4L2_COLORSPACE_REC709,\n\t\tV4L2_FIELD_NONE,\n\t\t1,\n\t\t0x465,\n\t\t90,\n\t\t102\n\t},\n\t{\n\t\tV4L2_DV_BT_CEA_720X480P59_94,\n\t\ttvp7002_parms_480P,\n\t\tV4L2_COLORSPACE_SMPTE170M,\n\t\tV4L2_FIELD_NONE,\n\t\t1,\n\t\t0x20D,\n\t\t0xffff,\n\t\t0xffff\n\t},\n\t{\n\t\tV4L2_DV_BT_CEA_720X576P50,\n\t\ttvp7002_parms_576P,\n\t\tV4L2_COLORSPACE_SMPTE170M,\n\t\tV4L2_FIELD_NONE,\n\t\t1,\n\t\t0x271,\n\t\t0xffff,\n\t\t0xffff\n\t}\n};\n\n#define NUM_TIMINGS ARRAY_SIZE(tvp7002_timings)\n\n \nstruct tvp7002 {\n\tstruct v4l2_subdev sd;\n\tstruct v4l2_ctrl_handler hdl;\n\tconst struct tvp7002_config *pdata;\n\n\tint ver;\n\tint streaming;\n\n\tconst struct tvp7002_timings_definition *current_timings;\n\tstruct media_pad pad;\n};\n\n \nstatic inline struct tvp7002 *to_tvp7002(struct v4l2_subdev *sd)\n{\n\treturn container_of(sd, struct tvp7002, sd);\n}\n\nstatic inline struct v4l2_subdev *to_sd(struct v4l2_ctrl *ctrl)\n{\n\treturn &container_of(ctrl->handler, struct tvp7002, hdl)->sd;\n}\n\n \nstatic int tvp7002_read(struct v4l2_subdev *sd, u8 addr, u8 *dst)\n{\n\tstruct i2c_client *c = v4l2_get_subdevdata(sd);\n\tint retry;\n\tint error;\n\n\tfor (retry = 0; retry < I2C_RETRY_COUNT; retry++) {\n\t\terror = i2c_smbus_read_byte_data(c, addr);\n\n\t\tif (error >= 0) {\n\t\t\t*dst = (u8)error;\n\t\t\treturn 0;\n\t\t}\n\n\t\tmsleep_interruptible(10);\n\t}\n\tv4l2_err(sd, \"TVP7002 read error %d\\n\", error);\n\treturn error;\n}\n\n \nstatic inline void tvp7002_read_err(struct v4l2_subdev *sd, u8 reg,\n\t\t\t\t\t\t\tu8 *dst, int *err)\n{\n\tif (!*err)\n\t\t*err = tvp7002_read(sd, reg, dst);\n}\n\n \nstatic int tvp7002_write(struct v4l2_subdev *sd, u8 addr, u8 value)\n{\n\tstruct i2c_client *c;\n\tint retry;\n\tint error;\n\n\tc = v4l2_get_subdevdata(sd);\n\n\tfor (retry = 0; retry < I2C_RETRY_COUNT; retry++) {\n\t\terror = i2c_smbus_write_byte_data(c, addr, value);\n\n\t\tif (error >= 0)\n\t\t\treturn 0;\n\n\t\tv4l2_warn(sd, \"Write: retry ... %d\\n\", retry);\n\t\tmsleep_interruptible(10);\n\t}\n\tv4l2_err(sd, \"TVP7002 write error %d\\n\", error);\n\treturn error;\n}\n\n \nstatic inline void tvp7002_write_err(struct v4l2_subdev *sd, u8 reg,\n\t\t\t\t\t\t\tu8 val, int *err)\n{\n\tif (!*err)\n\t\t*err = tvp7002_write(sd, reg, val);\n}\n\n \nstatic int tvp7002_write_inittab(struct v4l2_subdev *sd,\n\t\t\t\t\tconst struct i2c_reg_value *regs)\n{\n\tint error = 0;\n\n\t \n\twhile (TVP7002_EOR != regs->reg) {\n\t\tif (TVP7002_WRITE == regs->type)\n\t\t\ttvp7002_write_err(sd, regs->reg, regs->value, &error);\n\t\tregs++;\n\t}\n\n\treturn error;\n}\n\nstatic int tvp7002_s_dv_timings(struct v4l2_subdev *sd,\n\t\t\t\t\tstruct v4l2_dv_timings *dv_timings)\n{\n\tstruct tvp7002 *device = to_tvp7002(sd);\n\tconst struct v4l2_bt_timings *bt = &dv_timings->bt;\n\tint i;\n\n\tif (dv_timings->type != V4L2_DV_BT_656_1120)\n\t\treturn -EINVAL;\n\tfor (i = 0; i < NUM_TIMINGS; i++) {\n\t\tconst struct v4l2_bt_timings *t = &tvp7002_timings[i].timings.bt;\n\n\t\tif (!memcmp(bt, t, &bt->standards - &bt->width)) {\n\t\t\tdevice->current_timings = &tvp7002_timings[i];\n\t\t\treturn tvp7002_write_inittab(sd, tvp7002_timings[i].p_settings);\n\t\t}\n\t}\n\treturn -EINVAL;\n}\n\nstatic int tvp7002_g_dv_timings(struct v4l2_subdev *sd,\n\t\t\t\t\tstruct v4l2_dv_timings *dv_timings)\n{\n\tstruct tvp7002 *device = to_tvp7002(sd);\n\n\t*dv_timings = device->current_timings->timings;\n\treturn 0;\n}\n\n \nstatic int tvp7002_s_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct v4l2_subdev *sd = to_sd(ctrl);\n\tint error = 0;\n\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_GAIN:\n\t\ttvp7002_write_err(sd, TVP7002_R_FINE_GAIN, ctrl->val, &error);\n\t\ttvp7002_write_err(sd, TVP7002_G_FINE_GAIN, ctrl->val, &error);\n\t\ttvp7002_write_err(sd, TVP7002_B_FINE_GAIN, ctrl->val, &error);\n\t\treturn error;\n\t}\n\treturn -EINVAL;\n}\n\n \nstatic int tvp7002_query_dv(struct v4l2_subdev *sd, int *index)\n{\n\tconst struct tvp7002_timings_definition *timings = tvp7002_timings;\n\tu8 progressive;\n\tu32 lpfr;\n\tu32 cpln;\n\tint error = 0;\n\tu8 lpf_lsb;\n\tu8 lpf_msb;\n\tu8 cpl_lsb;\n\tu8 cpl_msb;\n\n\t \n\t*index = NUM_TIMINGS;\n\n\t \n\ttvp7002_read_err(sd, TVP7002_L_FRAME_STAT_LSBS, &lpf_lsb, &error);\n\ttvp7002_read_err(sd, TVP7002_L_FRAME_STAT_MSBS, &lpf_msb, &error);\n\n\tif (error < 0)\n\t\treturn error;\n\n\ttvp7002_read_err(sd, TVP7002_CLK_L_STAT_LSBS, &cpl_lsb, &error);\n\ttvp7002_read_err(sd, TVP7002_CLK_L_STAT_MSBS, &cpl_msb, &error);\n\n\tif (error < 0)\n\t\treturn error;\n\n\t \n\tlpfr = lpf_lsb | ((TVP7002_CL_MASK & lpf_msb) << TVP7002_CL_SHIFT);\n\tcpln = cpl_lsb | ((TVP7002_CL_MASK & cpl_msb) << TVP7002_CL_SHIFT);\n\tprogressive = (lpf_msb & TVP7002_INPR_MASK) >> TVP7002_IP_SHIFT;\n\n\t \n\tfor (*index = 0; *index < NUM_TIMINGS; (*index)++, timings++)\n\t\tif (lpfr == timings->lines_per_frame &&\n\t\t\tprogressive == timings->progressive) {\n\t\t\tif (timings->cpl_min == 0xffff)\n\t\t\t\tbreak;\n\t\t\tif (cpln >= timings->cpl_min && cpln <= timings->cpl_max)\n\t\t\t\tbreak;\n\t\t}\n\n\tif (*index == NUM_TIMINGS) {\n\t\tv4l2_dbg(1, debug, sd, \"detection failed: lpf = %x, cpl = %x\\n\",\n\t\t\t\t\t\t\t\tlpfr, cpln);\n\t\treturn -ENOLINK;\n\t}\n\n\t \n\tv4l2_dbg(1, debug, sd, \"detected timings: %d\\n\", *index);\n\treturn 0;\n}\n\nstatic int tvp7002_query_dv_timings(struct v4l2_subdev *sd,\n\t\t\t\t\tstruct v4l2_dv_timings *timings)\n{\n\tint index;\n\tint err = tvp7002_query_dv(sd, &index);\n\n\tif (err)\n\t\treturn err;\n\t*timings = tvp7002_timings[index].timings;\n\treturn 0;\n}\n\n#ifdef CONFIG_VIDEO_ADV_DEBUG\n \nstatic int tvp7002_g_register(struct v4l2_subdev *sd,\n\t\t\t\t\t\tstruct v4l2_dbg_register *reg)\n{\n\tu8 val;\n\tint ret;\n\n\tret = tvp7002_read(sd, reg->reg & 0xff, &val);\n\tif (ret < 0)\n\t\treturn ret;\n\treg->val = val;\n\treg->size = 1;\n\treturn 0;\n}\n\n \nstatic int tvp7002_s_register(struct v4l2_subdev *sd,\n\t\t\t\t\t\tconst struct v4l2_dbg_register *reg)\n{\n\treturn tvp7002_write(sd, reg->reg & 0xff, reg->val & 0xff);\n}\n#endif\n\n \nstatic int tvp7002_s_stream(struct v4l2_subdev *sd, int enable)\n{\n\tstruct tvp7002 *device = to_tvp7002(sd);\n\tint error;\n\n\tif (device->streaming == enable)\n\t\treturn 0;\n\n\t \n\terror = tvp7002_write(sd, TVP7002_MISC_CTL_2, enable ? 0x00 : 0x03);\n\tif (error) {\n\t\tv4l2_dbg(1, debug, sd, \"Fail to set streaming\\n\");\n\t\treturn error;\n\t}\n\n\tdevice->streaming = enable;\n\treturn 0;\n}\n\n \nstatic int tvp7002_log_status(struct v4l2_subdev *sd)\n{\n\tstruct tvp7002 *device = to_tvp7002(sd);\n\tconst struct v4l2_bt_timings *bt;\n\tint detected;\n\n\t \n\ttvp7002_query_dv(sd, &detected);\n\n\tbt = &device->current_timings->timings.bt;\n\tv4l2_info(sd, \"Selected DV Timings: %ux%u\\n\", bt->width, bt->height);\n\tif (detected == NUM_TIMINGS) {\n\t\tv4l2_info(sd, \"Detected DV Timings: None\\n\");\n\t} else {\n\t\tbt = &tvp7002_timings[detected].timings.bt;\n\t\tv4l2_info(sd, \"Detected DV Timings: %ux%u\\n\",\n\t\t\t\tbt->width, bt->height);\n\t}\n\tv4l2_info(sd, \"Streaming enabled: %s\\n\",\n\t\t\t\t\tdevice->streaming ? \"yes\" : \"no\");\n\n\t \n\tv4l2_ctrl_handler_log_status(&device->hdl, sd->name);\n\n\treturn 0;\n}\n\nstatic int tvp7002_enum_dv_timings(struct v4l2_subdev *sd,\n\t\tstruct v4l2_enum_dv_timings *timings)\n{\n\tif (timings->pad != 0)\n\t\treturn -EINVAL;\n\n\t \n\tif (timings->index >= NUM_TIMINGS)\n\t\treturn -EINVAL;\n\n\ttimings->timings = tvp7002_timings[timings->index].timings;\n\treturn 0;\n}\n\nstatic const struct v4l2_ctrl_ops tvp7002_ctrl_ops = {\n\t.s_ctrl = tvp7002_s_ctrl,\n};\n\n \nstatic int\ntvp7002_enum_mbus_code(struct v4l2_subdev *sd,\n\t\t       struct v4l2_subdev_state *sd_state,\n\t\t       struct v4l2_subdev_mbus_code_enum *code)\n{\n\t \n\tif (code->index != 0)\n\t\treturn -EINVAL;\n\n\tcode->code = MEDIA_BUS_FMT_YUYV10_1X20;\n\n\treturn 0;\n}\n\n \nstatic int\ntvp7002_get_pad_format(struct v4l2_subdev *sd,\n\t\t       struct v4l2_subdev_state *sd_state,\n\t\t       struct v4l2_subdev_format *fmt)\n{\n\tstruct tvp7002 *tvp7002 = to_tvp7002(sd);\n\n\tfmt->format.code = MEDIA_BUS_FMT_YUYV10_1X20;\n\tfmt->format.width = tvp7002->current_timings->timings.bt.width;\n\tfmt->format.height = tvp7002->current_timings->timings.bt.height;\n\tfmt->format.field = tvp7002->current_timings->scanmode;\n\tfmt->format.colorspace = tvp7002->current_timings->color_space;\n\n\treturn 0;\n}\n\n \nstatic int\ntvp7002_set_pad_format(struct v4l2_subdev *sd,\n\t\t       struct v4l2_subdev_state *sd_state,\n\t\t       struct v4l2_subdev_format *fmt)\n{\n\treturn tvp7002_get_pad_format(sd, sd_state, fmt);\n}\n\n \nstatic const struct v4l2_subdev_core_ops tvp7002_core_ops = {\n\t.log_status = tvp7002_log_status,\n#ifdef CONFIG_VIDEO_ADV_DEBUG\n\t.g_register = tvp7002_g_register,\n\t.s_register = tvp7002_s_register,\n#endif\n};\n\n \nstatic const struct v4l2_subdev_video_ops tvp7002_video_ops = {\n\t.g_dv_timings = tvp7002_g_dv_timings,\n\t.s_dv_timings = tvp7002_s_dv_timings,\n\t.query_dv_timings = tvp7002_query_dv_timings,\n\t.s_stream = tvp7002_s_stream,\n};\n\n \nstatic const struct v4l2_subdev_pad_ops tvp7002_pad_ops = {\n\t.enum_mbus_code = tvp7002_enum_mbus_code,\n\t.get_fmt = tvp7002_get_pad_format,\n\t.set_fmt = tvp7002_set_pad_format,\n\t.enum_dv_timings = tvp7002_enum_dv_timings,\n};\n\n \nstatic const struct v4l2_subdev_ops tvp7002_ops = {\n\t.core = &tvp7002_core_ops,\n\t.video = &tvp7002_video_ops,\n\t.pad = &tvp7002_pad_ops,\n};\n\nstatic struct tvp7002_config *\ntvp7002_get_pdata(struct i2c_client *client)\n{\n\tstruct v4l2_fwnode_endpoint bus_cfg = { .bus_type = 0 };\n\tstruct tvp7002_config *pdata = NULL;\n\tstruct device_node *endpoint;\n\tunsigned int flags;\n\n\tif (!IS_ENABLED(CONFIG_OF) || !client->dev.of_node)\n\t\treturn client->dev.platform_data;\n\n\tendpoint = of_graph_get_next_endpoint(client->dev.of_node, NULL);\n\tif (!endpoint)\n\t\treturn NULL;\n\n\tif (v4l2_fwnode_endpoint_parse(of_fwnode_handle(endpoint), &bus_cfg))\n\t\tgoto done;\n\n\tpdata = devm_kzalloc(&client->dev, sizeof(*pdata), GFP_KERNEL);\n\tif (!pdata)\n\t\tgoto done;\n\n\tflags = bus_cfg.bus.parallel.flags;\n\n\tif (flags & V4L2_MBUS_HSYNC_ACTIVE_HIGH)\n\t\tpdata->hs_polarity = 1;\n\n\tif (flags & V4L2_MBUS_VSYNC_ACTIVE_HIGH)\n\t\tpdata->vs_polarity = 1;\n\n\tif (flags & V4L2_MBUS_PCLK_SAMPLE_RISING)\n\t\tpdata->clk_polarity = 1;\n\n\tif (flags & V4L2_MBUS_FIELD_EVEN_HIGH)\n\t\tpdata->fid_polarity = 1;\n\n\tif (flags & V4L2_MBUS_VIDEO_SOG_ACTIVE_HIGH)\n\t\tpdata->sog_polarity = 1;\n\ndone:\n\tof_node_put(endpoint);\n\treturn pdata;\n}\n\n \nstatic int tvp7002_probe(struct i2c_client *c)\n{\n\tstruct tvp7002_config *pdata = tvp7002_get_pdata(c);\n\tstruct v4l2_subdev *sd;\n\tstruct tvp7002 *device;\n\tstruct v4l2_dv_timings timings;\n\tint polarity_a;\n\tint polarity_b;\n\tu8 revision;\n\tint error;\n\n\tif (pdata == NULL) {\n\t\tdev_err(&c->dev, \"No platform data\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (!i2c_check_functionality(c->adapter,\n\t\tI2C_FUNC_SMBUS_READ_BYTE | I2C_FUNC_SMBUS_WRITE_BYTE_DATA))\n\t\treturn -EIO;\n\n\tdevice = devm_kzalloc(&c->dev, sizeof(struct tvp7002), GFP_KERNEL);\n\n\tif (!device)\n\t\treturn -ENOMEM;\n\n\tsd = &device->sd;\n\tdevice->pdata = pdata;\n\tdevice->current_timings = tvp7002_timings;\n\n\t \n\tv4l2_i2c_subdev_init(sd, c, &tvp7002_ops);\n\tv4l_info(c, \"tvp7002 found @ 0x%02x (%s)\\n\",\n\t\t\t\t\tc->addr, c->adapter->name);\n\n\terror = tvp7002_read(sd, TVP7002_CHIP_REV, &revision);\n\tif (error < 0)\n\t\treturn error;\n\n\t \n\tv4l2_info(sd, \"Rev. %02x detected.\\n\", revision);\n\tif (revision != 0x02)\n\t\tv4l2_info(sd, \"Unknown revision detected.\\n\");\n\n\t \n\terror = tvp7002_write_inittab(sd, tvp7002_init_default);\n\n\tif (error < 0)\n\t\treturn error;\n\n\t \n\tpolarity_a = 0x20 | device->pdata->hs_polarity << 5\n\t\t\t| device->pdata->vs_polarity << 2;\n\terror = tvp7002_write(sd, TVP7002_SYNC_CTL_1, polarity_a);\n\tif (error < 0)\n\t\treturn error;\n\n\tpolarity_b = 0x01  | device->pdata->fid_polarity << 2\n\t\t\t| device->pdata->sog_polarity << 1\n\t\t\t| device->pdata->clk_polarity;\n\terror = tvp7002_write(sd, TVP7002_MISC_CTL_3, polarity_b);\n\tif (error < 0)\n\t\treturn error;\n\n\t \n\ttimings = device->current_timings->timings;\n\terror = tvp7002_s_dv_timings(sd, &timings);\n\n#if defined(CONFIG_MEDIA_CONTROLLER)\n\tdevice->pad.flags = MEDIA_PAD_FL_SOURCE;\n\tdevice->sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\n\tdevice->sd.entity.function = MEDIA_ENT_F_ATV_DECODER;\n\n\terror = media_entity_pads_init(&device->sd.entity, 1, &device->pad);\n\tif (error < 0)\n\t\treturn error;\n#endif\n\n\tv4l2_ctrl_handler_init(&device->hdl, 1);\n\tv4l2_ctrl_new_std(&device->hdl, &tvp7002_ctrl_ops,\n\t\t\tV4L2_CID_GAIN, 0, 255, 1, 0);\n\tsd->ctrl_handler = &device->hdl;\n\tif (device->hdl.error) {\n\t\terror = device->hdl.error;\n\t\tgoto error;\n\t}\n\tv4l2_ctrl_handler_setup(&device->hdl);\n\n\terror = v4l2_async_register_subdev(&device->sd);\n\tif (error)\n\t\tgoto error;\n\n\treturn 0;\n\nerror:\n\tv4l2_ctrl_handler_free(&device->hdl);\n#if defined(CONFIG_MEDIA_CONTROLLER)\n\tmedia_entity_cleanup(&device->sd.entity);\n#endif\n\treturn error;\n}\n\n \nstatic void tvp7002_remove(struct i2c_client *c)\n{\n\tstruct v4l2_subdev *sd = i2c_get_clientdata(c);\n\tstruct tvp7002 *device = to_tvp7002(sd);\n\n\tv4l2_dbg(1, debug, sd, \"Removing tvp7002 adapter\"\n\t\t\t\t\"on address 0x%x\\n\", c->addr);\n\tv4l2_async_unregister_subdev(&device->sd);\n#if defined(CONFIG_MEDIA_CONTROLLER)\n\tmedia_entity_cleanup(&device->sd.entity);\n#endif\n\tv4l2_ctrl_handler_free(&device->hdl);\n}\n\n \nstatic const struct i2c_device_id tvp7002_id[] = {\n\t{ \"tvp7002\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, tvp7002_id);\n\n#if IS_ENABLED(CONFIG_OF)\nstatic const struct of_device_id tvp7002_of_match[] = {\n\t{ .compatible = \"ti,tvp7002\", },\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, tvp7002_of_match);\n#endif\n\n \nstatic struct i2c_driver tvp7002_driver = {\n\t.driver = {\n\t\t.of_match_table = of_match_ptr(tvp7002_of_match),\n\t\t.name = TVP7002_MODULE_NAME,\n\t},\n\t.probe = tvp7002_probe,\n\t.remove = tvp7002_remove,\n\t.id_table = tvp7002_id,\n};\n\nmodule_i2c_driver(tvp7002_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}