{
  "module_name": "saa717x.c",
  "hash_id": "857c2eb966ff914b3108e48d4b6b00d7800804acba0d97622bbd97b4ff297630",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/i2c/saa717x.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/sched.h>\n\n#include <linux/videodev2.h>\n#include <linux/i2c.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ctrls.h>\n\nMODULE_DESCRIPTION(\"Philips SAA717x audio/video decoder driver\");\nMODULE_AUTHOR(\"K. Ohta, T. Adachi, Hans Verkuil\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int debug;\nmodule_param(debug, int, 0644);\nMODULE_PARM_DESC(debug, \"Debug level (0-1)\");\n\n \n\nstruct saa717x_state {\n\tstruct v4l2_subdev sd;\n\tstruct v4l2_ctrl_handler hdl;\n\tv4l2_std_id std;\n\tint input;\n\tint enable;\n\tint radio;\n\tint playback;\n\tint audio;\n\tint tuner_audio_mode;\n\tint audio_main_mute;\n\tint audio_main_vol_r;\n\tint audio_main_vol_l;\n\tu16 audio_main_bass;\n\tu16 audio_main_treble;\n\tu16 audio_main_volume;\n\tu16 audio_main_balance;\n\tint audio_input;\n};\n\nstatic inline struct saa717x_state *to_state(struct v4l2_subdev *sd)\n{\n\treturn container_of(sd, struct saa717x_state, sd);\n}\n\nstatic inline struct v4l2_subdev *to_sd(struct v4l2_ctrl *ctrl)\n{\n\treturn &container_of(ctrl->handler, struct saa717x_state, hdl)->sd;\n}\n\n \n\n \n#define TUNER_AUDIO_MONO\t0   \n#define TUNER_AUDIO_STEREO\t1   \n#define TUNER_AUDIO_LANG1\t2   \n#define TUNER_AUDIO_LANG2\t3   \n\n#define SAA717X_NTSC_WIDTH\t(704)\n#define SAA717X_NTSC_HEIGHT\t(480)\n\n \n\nstatic int saa717x_write(struct v4l2_subdev *sd, u32 reg, u32 value)\n{\n\tstruct i2c_client *client = v4l2_get_subdevdata(sd);\n\tstruct i2c_adapter *adap = client->adapter;\n\tint fw_addr = reg == 0x454 || (reg >= 0x464 && reg <= 0x478) || reg == 0x480 || reg == 0x488;\n\tunsigned char mm1[6];\n\tstruct i2c_msg msg;\n\n\tmsg.flags = 0;\n\tmsg.addr = client->addr;\n\tmm1[0] = (reg >> 8) & 0xff;\n\tmm1[1] = reg & 0xff;\n\n\tif (fw_addr) {\n\t\tmm1[4] = (value >> 16) & 0xff;\n\t\tmm1[3] = (value >> 8) & 0xff;\n\t\tmm1[2] = value & 0xff;\n\t} else {\n\t\tmm1[2] = value & 0xff;\n\t}\n\tmsg.len = fw_addr ? 5 : 3;  \n\tmsg.buf = mm1;\n\tv4l2_dbg(2, debug, sd, \"wrote:  reg 0x%03x=%08x\\n\", reg, value);\n\treturn i2c_transfer(adap, &msg, 1) == 1;\n}\n\nstatic void saa717x_write_regs(struct v4l2_subdev *sd, u32 *data)\n{\n\twhile (data[0] || data[1]) {\n\t\tsaa717x_write(sd, data[0], data[1]);\n\t\tdata += 2;\n\t}\n}\n\nstatic u32 saa717x_read(struct v4l2_subdev *sd, u32 reg)\n{\n\tstruct i2c_client *client = v4l2_get_subdevdata(sd);\n\tstruct i2c_adapter *adap = client->adapter;\n\tint fw_addr = (reg >= 0x404 && reg <= 0x4b8) || reg == 0x528;\n\tunsigned char mm1[2];\n\tunsigned char mm2[4] = { 0, 0, 0, 0 };\n\tstruct i2c_msg msgs[2];\n\tu32 value;\n\n\tmsgs[0].flags = 0;\n\tmsgs[1].flags = I2C_M_RD;\n\tmsgs[0].addr = msgs[1].addr = client->addr;\n\tmm1[0] = (reg >> 8) & 0xff;\n\tmm1[1] = reg & 0xff;\n\tmsgs[0].len = 2;\n\tmsgs[0].buf = mm1;\n\tmsgs[1].len = fw_addr ? 3 : 1;  \n\tmsgs[1].buf = mm2;\n\ti2c_transfer(adap, msgs, 2);\n\n\tif (fw_addr)\n\t\tvalue = (mm2[2] << 16)  | (mm2[1] << 8) | mm2[0];\n\telse\n\t\tvalue = mm2[0];\n\n\tv4l2_dbg(2, debug, sd, \"read:  reg 0x%03x=0x%08x\\n\", reg, value);\n\treturn value;\n}\n\n \n\nstatic u32 reg_init_initialize[] =\n{\n\t \n\t0x101, 0x008,  \n\n\t0x103, 0x000,  \n\t0x104, 0x090,  \n\t0x105, 0x090,  \n\t0x106, 0x0eb,  \n\t0x107, 0x0e0,  \n\t0x109, 0x055,  \n\n\t0x10f, 0x02a,  \n\t0x110, 0x000,  \n\n\t0x114, 0x045,  \n\n\t0x118, 0x040,  \n\t0x119, 0x080,  \n\n\t0x044, 0x000,  \n\t0x045, 0x000,  \n\t0x046, 0x0cf,  \n\t0x047, 0x002,  \n\n\t0x049, 0x000,  \n\n\t0x04c, 0x0d0,  \n\t0x04d, 0x002,  \n\n\t0x064, 0x080,  \n\t0x065, 0x040,  \n\t0x066, 0x040,  \n\t \n\t0x068, 0x000,  \n\t0x069, 0x004,  \n\t0x06a, 0x000,  \n\n\t0x06e, 0x000,  \n\t0x06f, 0x000,  \n\n\t0x072, 0x000,  \n\n\t0x084, 0x000,  \n\t0x085, 0x000,  \n\t0x086, 0x0cf,  \n\t0x087, 0x002,  \n\n\t0x089, 0x000,  \n\n\t0x08c, 0x0d0,  \n\t0x08d, 0x002,  \n\n\t0x0a4, 0x080,  \n\t0x0a5, 0x040,  \n\t0x0a6, 0x040,  \n\t \n\t0x0a8, 0x000,  \n\t0x0a9, 0x004,  \n\t0x0aa, 0x000,  \n\n\t0x0ae, 0x000,  \n\t0x0af, 0x000,  \n\n\t0x0b2, 0x000,  \n\n\t0x00c, 0x000,  \n\t0x00d, 0x000,  \n\t0x00e, 0x000,  \n\n\t0x010, 0x010,  \n\t0x011, 0x020,\n\t0x012, 0x030,\n\t0x013, 0x040,\n\t0x014, 0x050,\n\t0x015, 0x060,\n\t0x016, 0x070,\n\t0x017, 0x080,\n\t0x018, 0x090,\n\t0x019, 0x0a0,\n\t0x01a, 0x0b0,\n\t0x01b, 0x0c0,\n\t0x01c, 0x0d0,\n\t0x01d, 0x0e0,\n\t0x01e, 0x0f0,\n\t0x01f, 0x0ff,  \n\n\t0x020, 0x010,  \n\t0x021, 0x020,\n\t0x022, 0x030,\n\t0x023, 0x040,\n\t0x024, 0x050,\n\t0x025, 0x060,\n\t0x026, 0x070,\n\t0x027, 0x080,\n\t0x028, 0x090,\n\t0x029, 0x0a0,\n\t0x02a, 0x0b0,\n\t0x02b, 0x0c0,\n\t0x02c, 0x0d0,\n\t0x02d, 0x0e0,\n\t0x02e, 0x0f0,\n\t0x02f, 0x0ff,  \n\n\t0x030, 0x010,  \n\t0x031, 0x020,\n\t0x032, 0x030,\n\t0x033, 0x040,\n\t0x034, 0x050,\n\t0x035, 0x060,\n\t0x036, 0x070,\n\t0x037, 0x080,\n\t0x038, 0x090,\n\t0x039, 0x0a0,\n\t0x03a, 0x0b0,\n\t0x03b, 0x0c0,\n\t0x03c, 0x0d0,\n\t0x03d, 0x0e0,\n\t0x03e, 0x0f0,\n\t0x03f, 0x0ff,  \n\n\t0x109, 0x085,  \n\n\t \n\t0x584, 0x000,  \n\t0x585, 0x000,  \n\t0x586, 0x003,  \n\t0x588, 0x0ff,  \n\t0x589, 0x00f,  \n\t0x58a, 0x000,  \n\t0x58b, 0x000,  \n\t0x58c, 0x010,  \n\t0x58d, 0x032,  \n\t0x58e, 0x054,  \n\t0x58f, 0x023,  \n\t0x590, 0x000,  \n\n\t0x595, 0x000,  \n\t0x596, 0x000,  \n\t0x597, 0x000,  \n\n\t0x464, 0x00,  \n\n\t0x46c, 0xbbbb10,  \n\t0x470, 0x101010,  \n\n\t0x478, 0x00,  \n\n\t0x474, 0x18,  \n\n\t0x454, 0x0425b9,  \n\t0x454, 0x042539,  \n\n\n\t \n\t0x042, 0x003,  \n\n\t0x082, 0x003,  \n\n\t0x108, 0x0f8,  \n\t0x2a9, 0x0fd,  \n\t0x102, 0x089,  \n\t0x111, 0x000,  \n\n\t0x10e, 0x00a,  \n\n\t0x594, 0x002,  \n\n\t0x454, 0x0425b9,  \n\t0x454, 0x042539,\n\n\t0x111, 0x000,\n\t0x10e, 0x00a,\n\t0x464, 0x000,\n\t0x300, 0x000,\n\t0x301, 0x006,\n\t0x302, 0x000,\n\t0x303, 0x006,\n\t0x308, 0x040,\n\t0x309, 0x000,\n\t0x30a, 0x000,\n\t0x30b, 0x000,\n\t0x000, 0x002,\n\t0x001, 0x000,\n\t0x002, 0x000,\n\t0x003, 0x000,\n\t0x004, 0x033,\n\t0x040, 0x01d,\n\t0x041, 0x001,\n\t0x042, 0x004,\n\t0x043, 0x000,\n\t0x080, 0x01e,\n\t0x081, 0x001,\n\t0x082, 0x004,\n\t0x083, 0x000,\n\t0x190, 0x018,\n\t0x115, 0x000,\n\t0x116, 0x012,\n\t0x117, 0x018,\n\t0x04a, 0x011,\n\t0x08a, 0x011,\n\t0x04b, 0x000,\n\t0x08b, 0x000,\n\t0x048, 0x000,\n\t0x088, 0x000,\n\t0x04e, 0x012,\n\t0x08e, 0x012,\n\t0x058, 0x012,\n\t0x098, 0x012,\n\t0x059, 0x000,\n\t0x099, 0x000,\n\t0x05a, 0x003,\n\t0x09a, 0x003,\n\t0x05b, 0x001,\n\t0x09b, 0x001,\n\t0x054, 0x008,\n\t0x094, 0x008,\n\t0x055, 0x000,\n\t0x095, 0x000,\n\t0x056, 0x0c7,\n\t0x096, 0x0c7,\n\t0x057, 0x002,\n\t0x097, 0x002,\n\t0x0ff, 0x0ff,\n\t0x060, 0x001,\n\t0x0a0, 0x001,\n\t0x061, 0x000,\n\t0x0a1, 0x000,\n\t0x062, 0x000,\n\t0x0a2, 0x000,\n\t0x063, 0x000,\n\t0x0a3, 0x000,\n\t0x070, 0x000,\n\t0x0b0, 0x000,\n\t0x071, 0x004,\n\t0x0b1, 0x004,\n\t0x06c, 0x0e9,\n\t0x0ac, 0x0e9,\n\t0x06d, 0x003,\n\t0x0ad, 0x003,\n\t0x05c, 0x0d0,\n\t0x09c, 0x0d0,\n\t0x05d, 0x002,\n\t0x09d, 0x002,\n\t0x05e, 0x0f2,\n\t0x09e, 0x0f2,\n\t0x05f, 0x000,\n\t0x09f, 0x000,\n\t0x074, 0x000,\n\t0x0b4, 0x000,\n\t0x075, 0x000,\n\t0x0b5, 0x000,\n\t0x076, 0x000,\n\t0x0b6, 0x000,\n\t0x077, 0x000,\n\t0x0b7, 0x000,\n\t0x195, 0x008,\n\t0x0ff, 0x0ff,\n\t0x108, 0x0f8,\n\t0x111, 0x000,\n\t0x10e, 0x00a,\n\t0x2a9, 0x0fd,\n\t0x464, 0x001,\n\t0x454, 0x042135,\n\t0x598, 0x0e7,\n\t0x599, 0x07d,\n\t0x59a, 0x018,\n\t0x59c, 0x066,\n\t0x59d, 0x090,\n\t0x59e, 0x001,\n\t0x584, 0x000,\n\t0x585, 0x000,\n\t0x586, 0x003,\n\t0x588, 0x0ff,\n\t0x589, 0x00f,\n\t0x58a, 0x000,\n\t0x58b, 0x000,\n\t0x58c, 0x010,\n\t0x58d, 0x032,\n\t0x58e, 0x054,\n\t0x58f, 0x023,\n\t0x590, 0x000,\n\t0x595, 0x000,\n\t0x596, 0x000,\n\t0x597, 0x000,\n\t0x464, 0x000,\n\t0x46c, 0xbbbb10,\n\t0x470, 0x101010,\n\n\n\t0x478, 0x000,\n\t0x474, 0x018,\n\t0x454, 0x042135,\n\t0x598, 0x0e7,\n\t0x599, 0x07d,\n\t0x59a, 0x018,\n\t0x59c, 0x066,\n\t0x59d, 0x090,\n\t0x59e, 0x001,\n\t0x584, 0x000,\n\t0x585, 0x000,\n\t0x586, 0x003,\n\t0x588, 0x0ff,\n\t0x589, 0x00f,\n\t0x58a, 0x000,\n\t0x58b, 0x000,\n\t0x58c, 0x010,\n\t0x58d, 0x032,\n\t0x58e, 0x054,\n\t0x58f, 0x023,\n\t0x590, 0x000,\n\t0x595, 0x000,\n\t0x596, 0x000,\n\t0x597, 0x000,\n\t0x464, 0x000,\n\t0x46c, 0xbbbb10,\n\t0x470, 0x101010,\n\n\t0x478, 0x000,\n\t0x474, 0x018,\n\t0x454, 0x042135,\n\t0x598, 0x0e7,\n\t0x599, 0x07d,\n\t0x59a, 0x018,\n\t0x59c, 0x066,\n\t0x59d, 0x090,\n\t0x59e, 0x001,\n\t0x584, 0x000,\n\t0x585, 0x000,\n\t0x586, 0x003,\n\t0x588, 0x0ff,\n\t0x589, 0x00f,\n\t0x58a, 0x000,\n\t0x58b, 0x000,\n\t0x58c, 0x010,\n\t0x58d, 0x032,\n\t0x58e, 0x054,\n\t0x58f, 0x023,\n\t0x590, 0x000,\n\t0x595, 0x000,\n\t0x596, 0x000,\n\t0x597, 0x000,\n\t0x464, 0x000,\n\t0x46c, 0xbbbb10,\n\t0x470, 0x101010,\n\t0x478, 0x000,\n\t0x474, 0x018,\n\t0x454, 0x042135,\n\t0x193, 0x000,\n\t0x300, 0x000,\n\t0x301, 0x006,\n\t0x302, 0x000,\n\t0x303, 0x006,\n\t0x308, 0x040,\n\t0x309, 0x000,\n\t0x30a, 0x000,\n\t0x30b, 0x000,\n\t0x000, 0x002,\n\t0x001, 0x000,\n\t0x002, 0x000,\n\t0x003, 0x000,\n\t0x004, 0x033,\n\t0x040, 0x01d,\n\t0x041, 0x001,\n\t0x042, 0x004,\n\t0x043, 0x000,\n\t0x080, 0x01e,\n\t0x081, 0x001,\n\t0x082, 0x004,\n\t0x083, 0x000,\n\t0x190, 0x018,\n\t0x115, 0x000,\n\t0x116, 0x012,\n\t0x117, 0x018,\n\t0x04a, 0x011,\n\t0x08a, 0x011,\n\t0x04b, 0x000,\n\t0x08b, 0x000,\n\t0x048, 0x000,\n\t0x088, 0x000,\n\t0x04e, 0x012,\n\t0x08e, 0x012,\n\t0x058, 0x012,\n\t0x098, 0x012,\n\t0x059, 0x000,\n\t0x099, 0x000,\n\t0x05a, 0x003,\n\t0x09a, 0x003,\n\t0x05b, 0x001,\n\t0x09b, 0x001,\n\t0x054, 0x008,\n\t0x094, 0x008,\n\t0x055, 0x000,\n\t0x095, 0x000,\n\t0x056, 0x0c7,\n\t0x096, 0x0c7,\n\t0x057, 0x002,\n\t0x097, 0x002,\n\t0x060, 0x001,\n\t0x0a0, 0x001,\n\t0x061, 0x000,\n\t0x0a1, 0x000,\n\t0x062, 0x000,\n\t0x0a2, 0x000,\n\t0x063, 0x000,\n\t0x0a3, 0x000,\n\t0x070, 0x000,\n\t0x0b0, 0x000,\n\t0x071, 0x004,\n\t0x0b1, 0x004,\n\t0x06c, 0x0e9,\n\t0x0ac, 0x0e9,\n\t0x06d, 0x003,\n\t0x0ad, 0x003,\n\t0x05c, 0x0d0,\n\t0x09c, 0x0d0,\n\t0x05d, 0x002,\n\t0x09d, 0x002,\n\t0x05e, 0x0f2,\n\t0x09e, 0x0f2,\n\t0x05f, 0x000,\n\t0x09f, 0x000,\n\t0x074, 0x000,\n\t0x0b4, 0x000,\n\t0x075, 0x000,\n\t0x0b5, 0x000,\n\t0x076, 0x000,\n\t0x0b6, 0x000,\n\t0x077, 0x000,\n\t0x0b7, 0x000,\n\t0x195, 0x008,\n\t0x598, 0x0e7,\n\t0x599, 0x07d,\n\t0x59a, 0x018,\n\t0x59c, 0x066,\n\t0x59d, 0x090,\n\t0x59e, 0x001,\n\t0x584, 0x000,\n\t0x585, 0x000,\n\t0x586, 0x003,\n\t0x588, 0x0ff,\n\t0x589, 0x00f,\n\t0x58a, 0x000,\n\t0x58b, 0x000,\n\t0x58c, 0x010,\n\t0x58d, 0x032,\n\t0x58e, 0x054,\n\t0x58f, 0x023,\n\t0x590, 0x000,\n\t0x595, 0x000,\n\t0x596, 0x000,\n\t0x597, 0x000,\n\t0x464, 0x000,\n\t0x46c, 0xbbbb10,\n\t0x470, 0x101010,\n\t0x478, 0x000,\n\t0x474, 0x018,\n\t0x454, 0x042135,\n\t0x193, 0x0a6,\n\t0x108, 0x0f8,\n\t0x042, 0x003,\n\t0x082, 0x003,\n\t0x454, 0x0425b9,\n\t0x454, 0x042539,\n\t0x193, 0x000,\n\t0x193, 0x0a6,\n\t0x464, 0x000,\n\n\t0, 0\n};\n\n \nstatic u32 reg_init_tuner_input[] = {\n\t0x108, 0x0f8,  \n\t0x111, 0x000,  \n\t0x10e, 0x00a,  \n\t0, 0\n};\n\n \nstatic u32 reg_init_composite_input[] = {\n\t0x108, 0x0e8,  \n\t0x111, 0x000,  \n\t0x10e, 0x04a,  \n\t0, 0\n};\n\n \nstatic u32 reg_init_svideo_input[] = {\n\t0x108, 0x0e8,  \n\t0x111, 0x000,  \n\t0x10e, 0x04a,  \n\t0, 0\n};\n\nstatic u32 reg_set_audio_template[4][2] =\n{\n\t{  \n\t\t0xbbbb00,\n\n\t\t \n\t\t0x00,\n\t},\n\t{  \n\t\t0xbbbb10, 0x101010,\n\t},\n\t{  \n\t\t0xbbbb00, 0x00,\n\t},\n\t{  \n\t\t0xbbbb11, 0x111111,\n\t}\n};\n\n\n \nstatic void get_inf_dev_status(struct v4l2_subdev *sd,\n\t\tint *dual_flag, int *stereo_flag)\n{\n\tu32 reg_data3;\n\n\tstatic char *stdres[0x20] = {\n\t\t[0x00] = \"no standard detected\",\n\t\t[0x01] = \"B/G (in progress)\",\n\t\t[0x02] = \"D/K (in progress)\",\n\t\t[0x03] = \"M (in progress)\",\n\n\t\t[0x04] = \"B/G A2\",\n\t\t[0x05] = \"B/G NICAM\",\n\t\t[0x06] = \"D/K A2 (1)\",\n\t\t[0x07] = \"D/K A2 (2)\",\n\t\t[0x08] = \"D/K A2 (3)\",\n\t\t[0x09] = \"D/K NICAM\",\n\t\t[0x0a] = \"L NICAM\",\n\t\t[0x0b] = \"I NICAM\",\n\n\t\t[0x0c] = \"M Korea\",\n\t\t[0x0d] = \"M BTSC \",\n\t\t[0x0e] = \"M EIAJ\",\n\n\t\t[0x0f] = \"FM radio / IF 10.7 / 50 deemp\",\n\t\t[0x10] = \"FM radio / IF 10.7 / 75 deemp\",\n\t\t[0x11] = \"FM radio / IF sel / 50 deemp\",\n\t\t[0x12] = \"FM radio / IF sel / 75 deemp\",\n\n\t\t[0x13 ... 0x1e] = \"unknown\",\n\t\t[0x1f] = \"??? [in progress]\",\n\t};\n\n\n\t*dual_flag = *stereo_flag = 0;\n\n\t \n\n\t \n\treg_data3 = saa717x_read(sd, 0x0528);\n\n\tv4l2_dbg(1, debug, sd, \"tvaudio thread status: 0x%x [%s%s%s]\\n\",\n\t\treg_data3, stdres[reg_data3 & 0x1f],\n\t\t(reg_data3 & 0x000020) ? \",stereo\" : \"\",\n\t\t(reg_data3 & 0x000040) ? \",dual\"   : \"\");\n\tv4l2_dbg(1, debug, sd, \"detailed status: \"\n\t\t\"%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s\\n\",\n\t\t(reg_data3 & 0x000080) ? \" A2/EIAJ pilot tone \"     : \"\",\n\t\t(reg_data3 & 0x000100) ? \" A2/EIAJ dual \"           : \"\",\n\t\t(reg_data3 & 0x000200) ? \" A2/EIAJ stereo \"         : \"\",\n\t\t(reg_data3 & 0x000400) ? \" A2/EIAJ noise mute \"     : \"\",\n\n\t\t(reg_data3 & 0x000800) ? \" BTSC/FM radio pilot \"    : \"\",\n\t\t(reg_data3 & 0x001000) ? \" SAP carrier \"            : \"\",\n\t\t(reg_data3 & 0x002000) ? \" BTSC stereo noise mute \" : \"\",\n\t\t(reg_data3 & 0x004000) ? \" SAP noise mute \"         : \"\",\n\t\t(reg_data3 & 0x008000) ? \" VDSP \"                   : \"\",\n\n\t\t(reg_data3 & 0x010000) ? \" NICST \"                  : \"\",\n\t\t(reg_data3 & 0x020000) ? \" NICDU \"                  : \"\",\n\t\t(reg_data3 & 0x040000) ? \" NICAM muted \"            : \"\",\n\t\t(reg_data3 & 0x080000) ? \" NICAM reserve sound \"    : \"\",\n\n\t\t(reg_data3 & 0x100000) ? \" init done \"              : \"\");\n\n\tif (reg_data3 & 0x000220) {\n\t\tv4l2_dbg(1, debug, sd, \"ST!!!\\n\");\n\t\t*stereo_flag = 1;\n\t}\n\n\tif (reg_data3 & 0x000140) {\n\t\tv4l2_dbg(1, debug, sd, \"DUAL!!!\\n\");\n\t\t*dual_flag = 1;\n\t}\n}\n\n \nstatic void set_audio_mode(struct v4l2_subdev *sd, int audio_mode)\n{\n\tv4l2_dbg(1, debug, sd, \"writing registers to set audio mode by set %d\\n\",\n\t\t\taudio_mode);\n\n\tsaa717x_write(sd, 0x46c, reg_set_audio_template[audio_mode][0]);\n\tsaa717x_write(sd, 0x470, reg_set_audio_template[audio_mode][1]);\n}\n\n \nstatic int set_audio_regs(struct v4l2_subdev *sd,\n\t\tstruct saa717x_state *decoder)\n{\n\tu8 mute = 0xac;  \n\tu32 val;\n\tunsigned int work_l, work_r;\n\n\t \n\tsaa717x_write(sd, 0x0594, decoder->audio_input);\n\tv4l2_dbg(1, debug, sd, \"set audio input %d\\n\",\n\t\t\tdecoder->audio_input);\n\n\t \n\twork_l = (min(65536 - decoder->audio_main_balance, 32768) * decoder->audio_main_volume) / 32768;\n\twork_r = (min(decoder->audio_main_balance, (u16)32768) * decoder->audio_main_volume) / 32768;\n\tdecoder->audio_main_vol_l = (long)work_l * (24 - (-40)) / 65535 - 40;\n\tdecoder->audio_main_vol_r = (long)work_r * (24 - (-40)) / 65535 - 40;\n\n\t \n\t \n\t \n\t \n\tif (decoder->audio_main_mute) {\n\t\tval = mute | (mute << 8);\n\t} else {\n\t\tval = (u8)decoder->audio_main_vol_l |\n\t\t\t((u8)decoder->audio_main_vol_r << 8);\n\t}\n\n\tsaa717x_write(sd, 0x480, val);\n\n\t \n\tval = decoder->audio_main_bass & 0x1f;\n\tval |= (decoder->audio_main_treble & 0x1f) << 5;\n\tsaa717x_write(sd, 0x488, val);\n\treturn 0;\n}\n\n \nstatic void set_h_prescale(struct v4l2_subdev *sd,\n\t\tint task, int prescale)\n{\n\tstatic const struct {\n\t\tint xpsc;\n\t\tint xacl;\n\t\tint xc2_1;\n\t\tint xdcg;\n\t\tint vpfy;\n\t} vals[] = {\n\t\t \n\t\t{    1,   0,    0,    0,   0 },\n\t\t{    2,   2,    1,    2,   2 },\n\t\t{    3,   4,    1,    3,   2 },\n\t\t{    4,   8,    1,    4,   2 },\n\t\t{    5,   8,    1,    4,   2 },\n\t\t{    6,   8,    1,    4,   3 },\n\t\t{    7,   8,    1,    4,   3 },\n\t\t{    8,  15,    0,    4,   3 },\n\t\t{    9,  15,    0,    4,   3 },\n\t\t{   10,  16,    1,    5,   3 },\n\t};\n\tstatic const int count = ARRAY_SIZE(vals);\n\tint i, task_shift;\n\n\ttask_shift = task * 0x40;\n\tfor (i = 0; i < count; i++)\n\t\tif (vals[i].xpsc == prescale)\n\t\t\tbreak;\n\tif (i == count)\n\t\treturn;\n\n\t \n\tsaa717x_write(sd, 0x60 + task_shift, vals[i].xpsc);\n\t \n\tsaa717x_write(sd, 0x61 + task_shift, vals[i].xacl);\n\t \n\tsaa717x_write(sd, 0x62 + task_shift,\n\t\t\t(vals[i].xc2_1 << 3) | vals[i].xdcg);\n\t \n\tsaa717x_write(sd, 0x63 + task_shift,\n\t\t\t(vals[i].vpfy << 2) | vals[i].vpfy);\n}\n\n \nstatic void set_v_scale(struct v4l2_subdev *sd, int task, int yscale)\n{\n\tint task_shift;\n\n\ttask_shift = task * 0x40;\n\t \n\tsaa717x_write(sd, 0x70 + task_shift, yscale & 0xff);\n\t \n\tsaa717x_write(sd, 0x71 + task_shift, yscale >> 8);\n}\n\nstatic int saa717x_s_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct v4l2_subdev *sd = to_sd(ctrl);\n\tstruct saa717x_state *state = to_state(sd);\n\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_BRIGHTNESS:\n\t\tsaa717x_write(sd, 0x10a, ctrl->val);\n\t\treturn 0;\n\n\tcase V4L2_CID_CONTRAST:\n\t\tsaa717x_write(sd, 0x10b, ctrl->val);\n\t\treturn 0;\n\n\tcase V4L2_CID_SATURATION:\n\t\tsaa717x_write(sd, 0x10c, ctrl->val);\n\t\treturn 0;\n\n\tcase V4L2_CID_HUE:\n\t\tsaa717x_write(sd, 0x10d, ctrl->val);\n\t\treturn 0;\n\n\tcase V4L2_CID_AUDIO_MUTE:\n\t\tstate->audio_main_mute = ctrl->val;\n\t\tbreak;\n\n\tcase V4L2_CID_AUDIO_VOLUME:\n\t\tstate->audio_main_volume = ctrl->val;\n\t\tbreak;\n\n\tcase V4L2_CID_AUDIO_BALANCE:\n\t\tstate->audio_main_balance = ctrl->val;\n\t\tbreak;\n\n\tcase V4L2_CID_AUDIO_TREBLE:\n\t\tstate->audio_main_treble = ctrl->val;\n\t\tbreak;\n\n\tcase V4L2_CID_AUDIO_BASS:\n\t\tstate->audio_main_bass = ctrl->val;\n\t\tbreak;\n\n\tdefault:\n\t\treturn 0;\n\t}\n\tset_audio_regs(sd, state);\n\treturn 0;\n}\n\nstatic int saa717x_s_video_routing(struct v4l2_subdev *sd,\n\t\t\t\t   u32 input, u32 output, u32 config)\n{\n\tstruct saa717x_state *decoder = to_state(sd);\n\tint is_tuner = input & 0x80;   \n\n\tinput &= 0x7f;\n\n\tv4l2_dbg(1, debug, sd, \"decoder set input (%d)\\n\", input);\n\t \n\t \n\tif (input > 9 || input == 5)\n\t\treturn -EINVAL;\n\n\tif (decoder->input != input) {\n\t\tint input_line = input;\n\n\t\tdecoder->input = input_line;\n\t\tv4l2_dbg(1, debug, sd,  \"now setting %s input %d\\n\",\n\t\t\t\tinput_line >= 6 ? \"S-Video\" : \"Composite\",\n\t\t\t\tinput_line);\n\n\t\t \n\t\tsaa717x_write(sd, 0x102,\n\t\t\t\t(saa717x_read(sd, 0x102) & 0xf0) |\n\t\t\t\tinput_line);\n\n\t\t \n\t\tsaa717x_write(sd, 0x109,\n\t\t\t\t(saa717x_read(sd, 0x109) & 0x7f) |\n\t\t\t\t(input_line < 6 ? 0x0 : 0x80));\n\n\t\t \n\t\tif (is_tuner) {\n\t\t\t \n\t\t\tset_audio_mode(sd, decoder->tuner_audio_mode);\n\t\t} else {\n\t\t\t \n\t\t\tset_audio_mode(sd, TUNER_AUDIO_STEREO);\n\t\t}\n\t\t \n\t\tif (is_tuner)\n\t\t\tsaa717x_write_regs(sd, reg_init_tuner_input);\n\t\telse if (input_line >= 6)\n\t\t\tsaa717x_write_regs(sd, reg_init_svideo_input);\n\t\telse\n\t\t\tsaa717x_write_regs(sd, reg_init_composite_input);\n\t}\n\n\treturn 0;\n}\n\n#ifdef CONFIG_VIDEO_ADV_DEBUG\nstatic int saa717x_g_register(struct v4l2_subdev *sd, struct v4l2_dbg_register *reg)\n{\n\treg->val = saa717x_read(sd, reg->reg);\n\treg->size = 1;\n\treturn 0;\n}\n\nstatic int saa717x_s_register(struct v4l2_subdev *sd, const struct v4l2_dbg_register *reg)\n{\n\tu16 addr = reg->reg & 0xffff;\n\tu8 val = reg->val & 0xff;\n\n\tsaa717x_write(sd, addr, val);\n\treturn 0;\n}\n#endif\n\nstatic int saa717x_set_fmt(struct v4l2_subdev *sd,\n\t\tstruct v4l2_subdev_state *sd_state,\n\t\tstruct v4l2_subdev_format *format)\n{\n\tstruct v4l2_mbus_framefmt *fmt = &format->format;\n\tint prescale, h_scale, v_scale;\n\n\tv4l2_dbg(1, debug, sd, \"decoder set size\\n\");\n\n\tif (format->pad || fmt->code != MEDIA_BUS_FMT_FIXED)\n\t\treturn -EINVAL;\n\n\t \n\tif (fmt->width < 1 || fmt->width > 1440)\n\t\treturn -EINVAL;\n\tif (fmt->height < 1 || fmt->height > 960)\n\t\treturn -EINVAL;\n\n\tfmt->field = V4L2_FIELD_INTERLACED;\n\tfmt->colorspace = V4L2_COLORSPACE_SMPTE170M;\n\n\tif (format->which == V4L2_SUBDEV_FORMAT_TRY)\n\t\treturn 0;\n\n\t \n\t \n\tprescale = SAA717X_NTSC_WIDTH / fmt->width;\n\tif (prescale == 0)\n\t\tprescale = 1;\n\th_scale = 1024 * SAA717X_NTSC_WIDTH / prescale / fmt->width;\n\t \n\tv_scale = 512 * 2 * SAA717X_NTSC_HEIGHT / fmt->height;\n\n\t \n\tset_h_prescale(sd, 0, prescale);\n\tset_h_prescale(sd, 1, prescale);\n\n\t \n\t \n\tsaa717x_write(sd, 0x6C, (u8)(h_scale & 0xFF));\n\tsaa717x_write(sd, 0x6D, (u8)((h_scale >> 8) & 0xFF));\n\t \n\tsaa717x_write(sd, 0xAC, (u8)(h_scale & 0xFF));\n\tsaa717x_write(sd, 0xAD, (u8)((h_scale >> 8) & 0xFF));\n\n\t \n\tset_v_scale(sd, 0, v_scale);\n\tset_v_scale(sd, 1, v_scale);\n\n\t \n\t \n\t \n\tsaa717x_write(sd, 0x5C, (u8)(fmt->width & 0xFF));\n\tsaa717x_write(sd, 0x5D, (u8)((fmt->width >> 8) & 0xFF));\n\t \n\tsaa717x_write(sd, 0x9C, (u8)(fmt->width & 0xFF));\n\tsaa717x_write(sd, 0x9D, (u8)((fmt->width >> 8) & 0xFF));\n\n\t \n\t \n\tsaa717x_write(sd, 0x5E, (u8)(fmt->height & 0xFF));\n\tsaa717x_write(sd, 0x5F, (u8)((fmt->height >> 8) & 0xFF));\n\t \n\tsaa717x_write(sd, 0x9E, (u8)(fmt->height & 0xFF));\n\tsaa717x_write(sd, 0x9F, (u8)((fmt->height >> 8) & 0xFF));\n\treturn 0;\n}\n\nstatic int saa717x_s_radio(struct v4l2_subdev *sd)\n{\n\tstruct saa717x_state *decoder = to_state(sd);\n\n\tdecoder->radio = 1;\n\treturn 0;\n}\n\nstatic int saa717x_s_std(struct v4l2_subdev *sd, v4l2_std_id std)\n{\n\tstruct saa717x_state *decoder = to_state(sd);\n\n\tv4l2_dbg(1, debug, sd, \"decoder set norm \");\n\tv4l2_dbg(1, debug, sd, \"(not yet implemented)\\n\");\n\n\tdecoder->radio = 0;\n\tdecoder->std = std;\n\treturn 0;\n}\n\nstatic int saa717x_s_audio_routing(struct v4l2_subdev *sd,\n\t\t\t\t   u32 input, u32 output, u32 config)\n{\n\tstruct saa717x_state *decoder = to_state(sd);\n\n\tif (input < 3) {  \n\t\tdecoder->audio_input = input;\n\t\tv4l2_dbg(1, debug, sd,\n\t\t\t\t\"set decoder audio input to %d\\n\",\n\t\t\t\tdecoder->audio_input);\n\t\tset_audio_regs(sd, decoder);\n\t\treturn 0;\n\t}\n\treturn -ERANGE;\n}\n\nstatic int saa717x_s_stream(struct v4l2_subdev *sd, int enable)\n{\n\tstruct saa717x_state *decoder = to_state(sd);\n\n\tv4l2_dbg(1, debug, sd, \"decoder %s output\\n\",\n\t\t\tenable ? \"enable\" : \"disable\");\n\tdecoder->enable = enable;\n\tsaa717x_write(sd, 0x193, enable ? 0xa6 : 0x26);\n\treturn 0;\n}\n\n \nstatic int saa717x_s_tuner(struct v4l2_subdev *sd, const struct v4l2_tuner *vt)\n{\n\tstruct saa717x_state *decoder = to_state(sd);\n\tint audio_mode;\n\tchar *mes[4] = {\n\t\t\"MONO\", \"STEREO\", \"LANG1\", \"LANG2/SAP\"\n\t};\n\n\taudio_mode = TUNER_AUDIO_STEREO;\n\n\tswitch (vt->audmode) {\n\t\tcase V4L2_TUNER_MODE_MONO:\n\t\t\taudio_mode = TUNER_AUDIO_MONO;\n\t\t\tbreak;\n\t\tcase V4L2_TUNER_MODE_STEREO:\n\t\t\taudio_mode = TUNER_AUDIO_STEREO;\n\t\t\tbreak;\n\t\tcase V4L2_TUNER_MODE_LANG2:\n\t\t\taudio_mode = TUNER_AUDIO_LANG2;\n\t\t\tbreak;\n\t\tcase V4L2_TUNER_MODE_LANG1:\n\t\t\taudio_mode = TUNER_AUDIO_LANG1;\n\t\t\tbreak;\n\t}\n\n\tv4l2_dbg(1, debug, sd, \"change audio mode to %s\\n\",\n\t\t\tmes[audio_mode]);\n\tdecoder->tuner_audio_mode = audio_mode;\n\t \n\t \n\tset_audio_mode(sd, decoder->tuner_audio_mode);\n\treturn 0;\n}\n\nstatic int saa717x_g_tuner(struct v4l2_subdev *sd, struct v4l2_tuner *vt)\n{\n\tstruct saa717x_state *decoder = to_state(sd);\n\tint dual_f, stereo_f;\n\n\tif (decoder->radio)\n\t\treturn 0;\n\tget_inf_dev_status(sd, &dual_f, &stereo_f);\n\n\tv4l2_dbg(1, debug, sd, \"DETECT==st:%d dual:%d\\n\",\n\t\t\tstereo_f, dual_f);\n\n\t \n\tif ((dual_f == 0) && (stereo_f == 0)) {\n\t\tvt->rxsubchans = V4L2_TUNER_SUB_MONO;\n\t\tv4l2_dbg(1, debug, sd, \"DETECT==MONO\\n\");\n\t}\n\n\t \n\tif (stereo_f == 1) {\n\t\tif (vt->audmode == V4L2_TUNER_MODE_STEREO ||\n\t\t\t\tvt->audmode == V4L2_TUNER_MODE_LANG1) {\n\t\t\tvt->rxsubchans = V4L2_TUNER_SUB_STEREO;\n\t\t\tv4l2_dbg(1, debug, sd, \"DETECT==ST(ST)\\n\");\n\t\t} else {\n\t\t\tvt->rxsubchans = V4L2_TUNER_SUB_MONO;\n\t\t\tv4l2_dbg(1, debug, sd, \"DETECT==ST(MONO)\\n\");\n\t\t}\n\t}\n\n\t \n\tif (dual_f == 1) {\n\t\tif (vt->audmode == V4L2_TUNER_MODE_LANG2) {\n\t\t\tvt->rxsubchans = V4L2_TUNER_SUB_LANG2 | V4L2_TUNER_SUB_MONO;\n\t\t\tv4l2_dbg(1, debug, sd, \"DETECT==DUAL1\\n\");\n\t\t} else {\n\t\t\tvt->rxsubchans = V4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_MONO;\n\t\t\tv4l2_dbg(1, debug, sd, \"DETECT==DUAL2\\n\");\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic int saa717x_log_status(struct v4l2_subdev *sd)\n{\n\tstruct saa717x_state *state = to_state(sd);\n\n\tv4l2_ctrl_handler_log_status(&state->hdl, sd->name);\n\treturn 0;\n}\n\n \n\nstatic const struct v4l2_ctrl_ops saa717x_ctrl_ops = {\n\t.s_ctrl = saa717x_s_ctrl,\n};\n\nstatic const struct v4l2_subdev_core_ops saa717x_core_ops = {\n#ifdef CONFIG_VIDEO_ADV_DEBUG\n\t.g_register = saa717x_g_register,\n\t.s_register = saa717x_s_register,\n#endif\n\t.log_status = saa717x_log_status,\n};\n\nstatic const struct v4l2_subdev_tuner_ops saa717x_tuner_ops = {\n\t.g_tuner = saa717x_g_tuner,\n\t.s_tuner = saa717x_s_tuner,\n\t.s_radio = saa717x_s_radio,\n};\n\nstatic const struct v4l2_subdev_video_ops saa717x_video_ops = {\n\t.s_std = saa717x_s_std,\n\t.s_routing = saa717x_s_video_routing,\n\t.s_stream = saa717x_s_stream,\n};\n\nstatic const struct v4l2_subdev_audio_ops saa717x_audio_ops = {\n\t.s_routing = saa717x_s_audio_routing,\n};\n\nstatic const struct v4l2_subdev_pad_ops saa717x_pad_ops = {\n\t.set_fmt = saa717x_set_fmt,\n};\n\nstatic const struct v4l2_subdev_ops saa717x_ops = {\n\t.core = &saa717x_core_ops,\n\t.tuner = &saa717x_tuner_ops,\n\t.audio = &saa717x_audio_ops,\n\t.video = &saa717x_video_ops,\n\t.pad = &saa717x_pad_ops,\n};\n\n \n\n\n \n\n \nstatic int saa717x_probe(struct i2c_client *client)\n{\n\tstruct saa717x_state *decoder;\n\tstruct v4l2_ctrl_handler *hdl;\n\tstruct v4l2_subdev *sd;\n\tu8 id = 0;\n\tchar *p = \"\";\n\n\t \n\tif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA))\n\t\treturn -EIO;\n\n\tdecoder = devm_kzalloc(&client->dev, sizeof(*decoder), GFP_KERNEL);\n\tif (decoder == NULL)\n\t\treturn -ENOMEM;\n\n\tsd = &decoder->sd;\n\tv4l2_i2c_subdev_init(sd, client, &saa717x_ops);\n\n\tif (saa717x_write(sd, 0x5a4, 0xfe) &&\n\t\t\tsaa717x_write(sd, 0x5a5, 0x0f) &&\n\t\t\tsaa717x_write(sd, 0x5a6, 0x00) &&\n\t\t\tsaa717x_write(sd, 0x5a7, 0x01))\n\t\tid = saa717x_read(sd, 0x5a0);\n\tif (id != 0xc2 && id != 0x32 && id != 0xf2 && id != 0x6c) {\n\t\tv4l2_dbg(1, debug, sd, \"saa717x not found (id=%02x)\\n\", id);\n\t\treturn -ENODEV;\n\t}\n\tif (id == 0xc2)\n\t\tp = \"saa7173\";\n\telse if (id == 0x32)\n\t\tp = \"saa7174A\";\n\telse if (id == 0x6c)\n\t\tp = \"saa7174HL\";\n\telse\n\t\tp = \"saa7171\";\n\tv4l2_info(sd, \"%s found @ 0x%x (%s)\\n\", p,\n\t\t\tclient->addr << 1, client->adapter->name);\n\n\thdl = &decoder->hdl;\n\tv4l2_ctrl_handler_init(hdl, 9);\n\t \n\tv4l2_ctrl_new_std(hdl, &saa717x_ctrl_ops,\n\t\t\tV4L2_CID_BRIGHTNESS, 0, 255, 1, 128);\n\tv4l2_ctrl_new_std(hdl, &saa717x_ctrl_ops,\n\t\t\tV4L2_CID_CONTRAST, 0, 255, 1, 68);\n\tv4l2_ctrl_new_std(hdl, &saa717x_ctrl_ops,\n\t\t\tV4L2_CID_SATURATION, 0, 255, 1, 64);\n\tv4l2_ctrl_new_std(hdl, &saa717x_ctrl_ops,\n\t\t\tV4L2_CID_HUE, -128, 127, 1, 0);\n\tv4l2_ctrl_new_std(hdl, &saa717x_ctrl_ops,\n\t\t\tV4L2_CID_AUDIO_VOLUME, 0, 65535, 65535 / 100, 42000);\n\tv4l2_ctrl_new_std(hdl, &saa717x_ctrl_ops,\n\t\t\tV4L2_CID_AUDIO_BALANCE, 0, 65535, 65535 / 100, 32768);\n\tv4l2_ctrl_new_std(hdl, &saa717x_ctrl_ops,\n\t\t\tV4L2_CID_AUDIO_BASS, -16, 15, 1, 0);\n\tv4l2_ctrl_new_std(hdl, &saa717x_ctrl_ops,\n\t\t\tV4L2_CID_AUDIO_TREBLE, -16, 15, 1, 0);\n\tv4l2_ctrl_new_std(hdl, &saa717x_ctrl_ops,\n\t\t\tV4L2_CID_AUDIO_MUTE, 0, 1, 1, 0);\n\tsd->ctrl_handler = hdl;\n\tif (hdl->error) {\n\t\tint err = hdl->error;\n\n\t\tv4l2_ctrl_handler_free(hdl);\n\t\treturn err;\n\t}\n\n\tdecoder->std = V4L2_STD_NTSC;\n\tdecoder->input = -1;\n\tdecoder->enable = 1;\n\n\t \n\tdecoder->playback = 0;\t \n\tdecoder->audio = 1;  \n\n\tdecoder->audio_input = 2;  \n\n\tdecoder->tuner_audio_mode = TUNER_AUDIO_STEREO;\n\t \n\tdecoder->audio_main_vol_l = 6;\n\tdecoder->audio_main_vol_r = 6;\n\n\tv4l2_dbg(1, debug, sd, \"writing init values\\n\");\n\n\t \n\tsaa717x_write_regs(sd, reg_init_initialize);\n\n\tv4l2_ctrl_handler_setup(hdl);\n\n\tset_current_state(TASK_INTERRUPTIBLE);\n\tschedule_timeout(2*HZ);\n\treturn 0;\n}\n\nstatic void saa717x_remove(struct i2c_client *client)\n{\n\tstruct v4l2_subdev *sd = i2c_get_clientdata(client);\n\n\tv4l2_device_unregister_subdev(sd);\n\tv4l2_ctrl_handler_free(sd->ctrl_handler);\n}\n\n \n\nstatic const struct i2c_device_id saa717x_id[] = {\n\t{ \"saa717x\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, saa717x_id);\n\nstatic struct i2c_driver saa717x_driver = {\n\t.driver = {\n\t\t.name\t= \"saa717x\",\n\t},\n\t.probe\t\t= saa717x_probe,\n\t.remove\t\t= saa717x_remove,\n\t.id_table\t= saa717x_id,\n};\n\nmodule_i2c_driver(saa717x_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}