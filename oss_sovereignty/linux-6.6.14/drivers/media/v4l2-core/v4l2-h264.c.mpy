{
  "module_name": "v4l2-h264.c",
  "hash_id": "8e9dacbb9391e6070234b25235eb6845184c06ecdb5649dd1eeee3b1553a40da",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/v4l2-core/v4l2-h264.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/sort.h>\n\n#include <media/v4l2-h264.h>\n\n \nstatic const int tmp_str_size = 1024;\n\n \nvoid\nv4l2_h264_init_reflist_builder(struct v4l2_h264_reflist_builder *b,\n\t\tconst struct v4l2_ctrl_h264_decode_params *dec_params,\n\t\tconst struct v4l2_ctrl_h264_sps *sps,\n\t\tconst struct v4l2_h264_dpb_entry dpb[V4L2_H264_NUM_DPB_ENTRIES])\n{\n\tint cur_frame_num, max_frame_num;\n\tunsigned int i;\n\n\tmax_frame_num = 1 << (sps->log2_max_frame_num_minus4 + 4);\n\tcur_frame_num = dec_params->frame_num;\n\n\tmemset(b, 0, sizeof(*b));\n\tif (!(dec_params->flags & V4L2_H264_DECODE_PARAM_FLAG_FIELD_PIC)) {\n\t\tb->cur_pic_order_count = min(dec_params->bottom_field_order_cnt,\n\t\t\t\t\t     dec_params->top_field_order_cnt);\n\t\tb->cur_pic_fields = V4L2_H264_FRAME_REF;\n\t} else if (dec_params->flags & V4L2_H264_DECODE_PARAM_FLAG_BOTTOM_FIELD) {\n\t\tb->cur_pic_order_count = dec_params->bottom_field_order_cnt;\n\t\tb->cur_pic_fields = V4L2_H264_BOTTOM_FIELD_REF;\n\t} else {\n\t\tb->cur_pic_order_count = dec_params->top_field_order_cnt;\n\t\tb->cur_pic_fields = V4L2_H264_TOP_FIELD_REF;\n\t}\n\n\tfor (i = 0; i < V4L2_H264_NUM_DPB_ENTRIES; i++) {\n\t\tif (!(dpb[i].flags & V4L2_H264_DPB_ENTRY_FLAG_ACTIVE))\n\t\t\tcontinue;\n\n\t\tif (dpb[i].flags & V4L2_H264_DPB_ENTRY_FLAG_LONG_TERM)\n\t\t\tb->refs[i].longterm = true;\n\n\t\t \n\t\tif (!b->refs[i].longterm && dpb[i].frame_num > cur_frame_num)\n\t\t\tb->refs[i].frame_num = (int)dpb[i].frame_num -\n\t\t\t\t\t       max_frame_num;\n\t\telse\n\t\t\tb->refs[i].frame_num = dpb[i].frame_num;\n\n\t\tb->refs[i].top_field_order_cnt = dpb[i].top_field_order_cnt;\n\t\tb->refs[i].bottom_field_order_cnt = dpb[i].bottom_field_order_cnt;\n\n\t\tif (b->cur_pic_fields == V4L2_H264_FRAME_REF) {\n\t\t\tu8 fields = V4L2_H264_FRAME_REF;\n\n\t\t\tb->unordered_reflist[b->num_valid].index = i;\n\t\t\tb->unordered_reflist[b->num_valid].fields = fields;\n\t\t\tb->num_valid++;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (dpb[i].fields & V4L2_H264_TOP_FIELD_REF) {\n\t\t\tu8 fields = V4L2_H264_TOP_FIELD_REF;\n\n\t\t\tb->unordered_reflist[b->num_valid].index = i;\n\t\t\tb->unordered_reflist[b->num_valid].fields = fields;\n\t\t\tb->num_valid++;\n\t\t}\n\n\t\tif (dpb[i].fields & V4L2_H264_BOTTOM_FIELD_REF) {\n\t\t\tu8 fields = V4L2_H264_BOTTOM_FIELD_REF;\n\n\t\t\tb->unordered_reflist[b->num_valid].index = i;\n\t\t\tb->unordered_reflist[b->num_valid].fields = fields;\n\t\t\tb->num_valid++;\n\t\t}\n\t}\n\n\tfor (i = b->num_valid; i < ARRAY_SIZE(b->unordered_reflist); i++)\n\t\tb->unordered_reflist[i].index = i;\n}\nEXPORT_SYMBOL_GPL(v4l2_h264_init_reflist_builder);\n\nstatic s32 v4l2_h264_get_poc(const struct v4l2_h264_reflist_builder *b,\n\t\t\t     const struct v4l2_h264_reference *ref)\n{\n\tswitch (ref->fields) {\n\tcase V4L2_H264_FRAME_REF:\n\t\treturn min(b->refs[ref->index].top_field_order_cnt,\n\t\t\t\tb->refs[ref->index].bottom_field_order_cnt);\n\tcase V4L2_H264_TOP_FIELD_REF:\n\t\treturn b->refs[ref->index].top_field_order_cnt;\n\tcase V4L2_H264_BOTTOM_FIELD_REF:\n\t\treturn b->refs[ref->index].bottom_field_order_cnt;\n\t}\n\n\t \n\treturn 0;\n}\n\nstatic int v4l2_h264_p_ref_list_cmp(const void *ptra, const void *ptrb,\n\t\t\t\t    const void *data)\n{\n\tconst struct v4l2_h264_reflist_builder *builder = data;\n\tu8 idxa, idxb;\n\n\tidxa = ((struct v4l2_h264_reference *)ptra)->index;\n\tidxb = ((struct v4l2_h264_reference *)ptrb)->index;\n\n\tif (WARN_ON(idxa >= V4L2_H264_NUM_DPB_ENTRIES ||\n\t\t    idxb >= V4L2_H264_NUM_DPB_ENTRIES))\n\t\treturn 1;\n\n\tif (builder->refs[idxa].longterm != builder->refs[idxb].longterm) {\n\t\t \n\t\tif (!builder->refs[idxa].longterm)\n\t\t\treturn -1;\n\t\telse\n\t\t\treturn 1;\n\t}\n\n\t \n\tif (!builder->refs[idxa].longterm)\n\t\treturn builder->refs[idxb].frame_num <\n\t\t       builder->refs[idxa].frame_num ?\n\t\t       -1 : 1;\n\n\treturn builder->refs[idxa].frame_num < builder->refs[idxb].frame_num ?\n\t       -1 : 1;\n}\n\nstatic int v4l2_h264_b0_ref_list_cmp(const void *ptra, const void *ptrb,\n\t\t\t\t     const void *data)\n{\n\tconst struct v4l2_h264_reflist_builder *builder = data;\n\ts32 poca, pocb;\n\tu8 idxa, idxb;\n\n\tidxa = ((struct v4l2_h264_reference *)ptra)->index;\n\tidxb = ((struct v4l2_h264_reference *)ptrb)->index;\n\n\tif (WARN_ON(idxa >= V4L2_H264_NUM_DPB_ENTRIES ||\n\t\t    idxb >= V4L2_H264_NUM_DPB_ENTRIES))\n\t\treturn 1;\n\n\tif (builder->refs[idxa].longterm != builder->refs[idxb].longterm) {\n\t\t \n\t\tif (!builder->refs[idxa].longterm)\n\t\t\treturn -1;\n\t\telse\n\t\t\treturn 1;\n\t}\n\n\t \n\tif (builder->refs[idxa].longterm)\n\t\treturn builder->refs[idxa].frame_num <\n\t\t       builder->refs[idxb].frame_num ?\n\t\t       -1 : 1;\n\n\tpoca = v4l2_h264_get_poc(builder, ptra);\n\tpocb = v4l2_h264_get_poc(builder, ptrb);\n\n\t \n\tif ((poca < builder->cur_pic_order_count) !=\n\t     (pocb < builder->cur_pic_order_count))\n\t\treturn poca < pocb ? -1 : 1;\n\telse if (poca < builder->cur_pic_order_count)\n\t\treturn pocb < poca ? -1 : 1;\n\n\treturn poca < pocb ? -1 : 1;\n}\n\nstatic int v4l2_h264_b1_ref_list_cmp(const void *ptra, const void *ptrb,\n\t\t\t\t     const void *data)\n{\n\tconst struct v4l2_h264_reflist_builder *builder = data;\n\ts32 poca, pocb;\n\tu8 idxa, idxb;\n\n\tidxa = ((struct v4l2_h264_reference *)ptra)->index;\n\tidxb = ((struct v4l2_h264_reference *)ptrb)->index;\n\n\tif (WARN_ON(idxa >= V4L2_H264_NUM_DPB_ENTRIES ||\n\t\t    idxb >= V4L2_H264_NUM_DPB_ENTRIES))\n\t\treturn 1;\n\n\tif (builder->refs[idxa].longterm != builder->refs[idxb].longterm) {\n\t\t \n\t\tif (!builder->refs[idxa].longterm)\n\t\t\treturn -1;\n\t\telse\n\t\t\treturn 1;\n\t}\n\n\t \n\tif (builder->refs[idxa].longterm)\n\t\treturn builder->refs[idxa].frame_num <\n\t\t       builder->refs[idxb].frame_num ?\n\t\t       -1 : 1;\n\n\tpoca = v4l2_h264_get_poc(builder, ptra);\n\tpocb = v4l2_h264_get_poc(builder, ptrb);\n\n\t \n\tif ((poca < builder->cur_pic_order_count) !=\n\t    (pocb < builder->cur_pic_order_count))\n\t\treturn pocb < poca ? -1 : 1;\n\telse if (poca < builder->cur_pic_order_count)\n\t\treturn pocb < poca ? -1 : 1;\n\n\treturn poca < pocb ? -1 : 1;\n}\n\n \nstatic void reorder_field_reflist(const struct v4l2_h264_reflist_builder *b,\n\t\t\t\t  struct v4l2_h264_reference *reflist)\n{\n\tstruct v4l2_h264_reference tmplist[V4L2_H264_REF_LIST_LEN];\n\tu8 lt, i = 0, j = 0, k = 0;\n\n\tmemcpy(tmplist, reflist, sizeof(tmplist[0]) * b->num_valid);\n\n\tfor (lt = 0; lt <= 1; lt++) {\n\t\tdo {\n\t\t\tfor (; i < b->num_valid && b->refs[tmplist[i].index].longterm == lt; i++) {\n\t\t\t\tif (tmplist[i].fields == b->cur_pic_fields) {\n\t\t\t\t\treflist[k++] = tmplist[i++];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (; j < b->num_valid && b->refs[tmplist[j].index].longterm == lt; j++) {\n\t\t\t\tif (tmplist[j].fields != b->cur_pic_fields) {\n\t\t\t\t\treflist[k++] = tmplist[j++];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} while ((i < b->num_valid && b->refs[tmplist[i].index].longterm == lt) ||\n\t\t\t (j < b->num_valid && b->refs[tmplist[j].index].longterm == lt));\n\t}\n}\n\nstatic char ref_type_to_char(u8 ref_type)\n{\n\tswitch (ref_type) {\n\tcase V4L2_H264_FRAME_REF:\n\t\treturn 'f';\n\tcase V4L2_H264_TOP_FIELD_REF:\n\t\treturn 't';\n\tcase V4L2_H264_BOTTOM_FIELD_REF:\n\t\treturn 'b';\n\t}\n\n\treturn '?';\n}\n\nstatic const char *format_ref_list_p(const struct v4l2_h264_reflist_builder *builder,\n\t\t\t\t     struct v4l2_h264_reference *reflist,\n\t\t\t\t     char **out_str)\n{\n\tint n = 0, i;\n\n\t*out_str = kmalloc(tmp_str_size, GFP_KERNEL);\n\tif (!(*out_str))\n\t\treturn NULL;\n\n\tn += snprintf(*out_str + n, tmp_str_size - n, \"|\");\n\n\tfor (i = 0; i < builder->num_valid; i++) {\n\t\t \n\t\tint frame_num = builder->refs[reflist[i].index].frame_num;\n\t\tbool longterm = builder->refs[reflist[i].index].longterm;\n\n\t\tn += scnprintf(*out_str + n, tmp_str_size - n, \"%i%c%c|\",\n\t\t\t       frame_num, longterm ? 'l' : 's',\n\t\t\t       ref_type_to_char(reflist[i].fields));\n\t}\n\n\treturn *out_str;\n}\n\nstatic void print_ref_list_p(const struct v4l2_h264_reflist_builder *builder,\n\t\t\t     struct v4l2_h264_reference *reflist)\n{\n\tchar *buf = NULL;\n\n\tpr_debug(\"ref_pic_list_p (cur_poc %u%c) %s\\n\",\n\t\t builder->cur_pic_order_count,\n\t\t ref_type_to_char(builder->cur_pic_fields),\n\t\t format_ref_list_p(builder, reflist, &buf));\n\n\tkfree(buf);\n}\n\nstatic const char *format_ref_list_b(const struct v4l2_h264_reflist_builder *builder,\n\t\t\t\t     struct v4l2_h264_reference *reflist,\n\t\t\t\t     char **out_str)\n{\n\tint n = 0, i;\n\n\t*out_str = kmalloc(tmp_str_size, GFP_KERNEL);\n\tif (!(*out_str))\n\t\treturn NULL;\n\n\tn += snprintf(*out_str + n, tmp_str_size - n, \"|\");\n\n\tfor (i = 0; i < builder->num_valid; i++) {\n\t\tint frame_num = builder->refs[reflist[i].index].frame_num;\n\t\tu32 poc = v4l2_h264_get_poc(builder, reflist + i);\n\t\tbool longterm = builder->refs[reflist[i].index].longterm;\n\n\t\tn += scnprintf(*out_str + n, tmp_str_size - n, \"%i%c%c|\",\n\t\t\t       longterm ? frame_num : poc,\n\t\t\t       longterm ? 'l' : 's',\n\t\t\t       ref_type_to_char(reflist[i].fields));\n\t}\n\n\treturn *out_str;\n}\n\nstatic void print_ref_list_b(const struct v4l2_h264_reflist_builder *builder,\n\t\t\t     struct v4l2_h264_reference *reflist, u8 list_num)\n{\n\tchar *buf = NULL;\n\n\tpr_debug(\"ref_pic_list_b%u (cur_poc %u%c) %s\",\n\t\t list_num, builder->cur_pic_order_count,\n\t\t ref_type_to_char(builder->cur_pic_fields),\n\t\t format_ref_list_b(builder, reflist, &buf));\n\n\tkfree(buf);\n}\n\n \nvoid\nv4l2_h264_build_p_ref_list(const struct v4l2_h264_reflist_builder *builder,\n\t\t\t   struct v4l2_h264_reference *reflist)\n{\n\tmemcpy(reflist, builder->unordered_reflist,\n\t       sizeof(builder->unordered_reflist[0]) * builder->num_valid);\n\tsort_r(reflist, builder->num_valid, sizeof(*reflist),\n\t       v4l2_h264_p_ref_list_cmp, NULL, builder);\n\n\tif (builder->cur_pic_fields != V4L2_H264_FRAME_REF)\n\t\treorder_field_reflist(builder, reflist);\n\n\tprint_ref_list_p(builder, reflist);\n}\nEXPORT_SYMBOL_GPL(v4l2_h264_build_p_ref_list);\n\n \nvoid\nv4l2_h264_build_b_ref_lists(const struct v4l2_h264_reflist_builder *builder,\n\t\t\t    struct v4l2_h264_reference *b0_reflist,\n\t\t\t    struct v4l2_h264_reference *b1_reflist)\n{\n\tmemcpy(b0_reflist, builder->unordered_reflist,\n\t       sizeof(builder->unordered_reflist[0]) * builder->num_valid);\n\tsort_r(b0_reflist, builder->num_valid, sizeof(*b0_reflist),\n\t       v4l2_h264_b0_ref_list_cmp, NULL, builder);\n\n\tmemcpy(b1_reflist, builder->unordered_reflist,\n\t       sizeof(builder->unordered_reflist[0]) * builder->num_valid);\n\tsort_r(b1_reflist, builder->num_valid, sizeof(*b1_reflist),\n\t       v4l2_h264_b1_ref_list_cmp, NULL, builder);\n\n\tif (builder->cur_pic_fields != V4L2_H264_FRAME_REF) {\n\t\treorder_field_reflist(builder, b0_reflist);\n\t\treorder_field_reflist(builder, b1_reflist);\n\t}\n\n\tif (builder->num_valid > 1 &&\n\t    !memcmp(b1_reflist, b0_reflist, builder->num_valid))\n\t\tswap(b1_reflist[0], b1_reflist[1]);\n\n\tprint_ref_list_b(builder, b0_reflist, 0);\n\tprint_ref_list_b(builder, b1_reflist, 1);\n}\nEXPORT_SYMBOL_GPL(v4l2_h264_build_b_ref_lists);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"V4L2 H264 Helpers\");\nMODULE_AUTHOR(\"Boris Brezillon <boris.brezillon@collabora.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}