{
  "module_name": "v4l2-fh.c",
  "hash_id": "8cc3f854384b32d154f888d02407382e47ad89c771d8197ff600a0745aace01e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/v4l2-core/v4l2-fh.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/slab.h>\n#include <linux/export.h>\n#include <media/v4l2-dev.h>\n#include <media/v4l2-fh.h>\n#include <media/v4l2-event.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-mc.h>\n\nvoid v4l2_fh_init(struct v4l2_fh *fh, struct video_device *vdev)\n{\n\tfh->vdev = vdev;\n\t \n\tfh->ctrl_handler = vdev->ctrl_handler;\n\tINIT_LIST_HEAD(&fh->list);\n\tset_bit(V4L2_FL_USES_V4L2_FH, &fh->vdev->flags);\n\t \n\tset_bit(_IOC_NR(VIDIOC_G_PRIORITY), vdev->valid_ioctls);\n\tset_bit(_IOC_NR(VIDIOC_S_PRIORITY), vdev->valid_ioctls);\n\tfh->prio = V4L2_PRIORITY_UNSET;\n\tinit_waitqueue_head(&fh->wait);\n\tINIT_LIST_HEAD(&fh->available);\n\tINIT_LIST_HEAD(&fh->subscribed);\n\tfh->sequence = -1;\n\tmutex_init(&fh->subscribe_lock);\n}\nEXPORT_SYMBOL_GPL(v4l2_fh_init);\n\nvoid v4l2_fh_add(struct v4l2_fh *fh)\n{\n\tunsigned long flags;\n\n\tv4l2_prio_open(fh->vdev->prio, &fh->prio);\n\tspin_lock_irqsave(&fh->vdev->fh_lock, flags);\n\tlist_add(&fh->list, &fh->vdev->fh_list);\n\tspin_unlock_irqrestore(&fh->vdev->fh_lock, flags);\n}\nEXPORT_SYMBOL_GPL(v4l2_fh_add);\n\nint v4l2_fh_open(struct file *filp)\n{\n\tstruct video_device *vdev = video_devdata(filp);\n\tstruct v4l2_fh *fh = kzalloc(sizeof(*fh), GFP_KERNEL);\n\n\tfilp->private_data = fh;\n\tif (fh == NULL)\n\t\treturn -ENOMEM;\n\tv4l2_fh_init(fh, vdev);\n\tv4l2_fh_add(fh);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(v4l2_fh_open);\n\nvoid v4l2_fh_del(struct v4l2_fh *fh)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&fh->vdev->fh_lock, flags);\n\tlist_del_init(&fh->list);\n\tspin_unlock_irqrestore(&fh->vdev->fh_lock, flags);\n\tv4l2_prio_close(fh->vdev->prio, fh->prio);\n}\nEXPORT_SYMBOL_GPL(v4l2_fh_del);\n\nvoid v4l2_fh_exit(struct v4l2_fh *fh)\n{\n\tif (fh->vdev == NULL)\n\t\treturn;\n\tv4l_disable_media_source(fh->vdev);\n\tv4l2_event_unsubscribe_all(fh);\n\tmutex_destroy(&fh->subscribe_lock);\n\tfh->vdev = NULL;\n}\nEXPORT_SYMBOL_GPL(v4l2_fh_exit);\n\nint v4l2_fh_release(struct file *filp)\n{\n\tstruct v4l2_fh *fh = filp->private_data;\n\n\tif (fh) {\n\t\tv4l2_fh_del(fh);\n\t\tv4l2_fh_exit(fh);\n\t\tkfree(fh);\n\t\tfilp->private_data = NULL;\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(v4l2_fh_release);\n\nint v4l2_fh_is_singular(struct v4l2_fh *fh)\n{\n\tunsigned long flags;\n\tint is_singular;\n\n\tif (fh == NULL || fh->vdev == NULL)\n\t\treturn 0;\n\tspin_lock_irqsave(&fh->vdev->fh_lock, flags);\n\tis_singular = list_is_singular(&fh->list);\n\tspin_unlock_irqrestore(&fh->vdev->fh_lock, flags);\n\treturn is_singular;\n}\nEXPORT_SYMBOL_GPL(v4l2_fh_is_singular);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}