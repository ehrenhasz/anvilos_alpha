{
  "module_name": "v4l2-flash-led-class.c",
  "hash_id": "011a78beed5170edffadf557d2fbf2404afc341323ae03b9cf6640b40a91dd43",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/v4l2-core/v4l2-flash-led-class.c",
  "human_readable_source": "\n \n\n#include <linux/led-class-flash.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/property.h>\n#include <linux/slab.h>\n#include <linux/types.h>\n#include <media/v4l2-flash-led-class.h>\n\n#define has_flash_op(v4l2_flash, op)\t\t\t\t\\\n\t(v4l2_flash && v4l2_flash->ops && v4l2_flash->ops->op)\n\n#define call_flash_op(v4l2_flash, op, arg)\t\t\t\\\n\t\t(has_flash_op(v4l2_flash, op) ?\t\t\t\\\n\t\t\tv4l2_flash->ops->op(v4l2_flash, arg) :\t\\\n\t\t\t-EINVAL)\n\nenum ctrl_init_data_id {\n\tLED_MODE,\n\tTORCH_INTENSITY,\n\tFLASH_INTENSITY,\n\tINDICATOR_INTENSITY,\n\tFLASH_TIMEOUT,\n\tSTROBE_SOURCE,\n\t \n\tFLASH_STROBE,\n\tSTROBE_STOP,\n\tSTROBE_STATUS,\n\tFLASH_FAULT,\n\tNUM_FLASH_CTRLS,\n};\n\nstatic enum led_brightness __intensity_to_led_brightness(\n\t\t\t\t\tstruct v4l2_ctrl *ctrl, s32 intensity)\n{\n\tintensity -= ctrl->minimum;\n\tintensity /= (u32) ctrl->step;\n\n\t \n\tif (ctrl->minimum)\n\t\t++intensity;\n\n\treturn intensity;\n}\n\nstatic s32 __led_brightness_to_intensity(struct v4l2_ctrl *ctrl,\n\t\t\t\t\t enum led_brightness brightness)\n{\n\t \n\tif (ctrl->id != V4L2_CID_FLASH_INDICATOR_INTENSITY)\n\t\t--brightness;\n\n\treturn (brightness * ctrl->step) + ctrl->minimum;\n}\n\nstatic int v4l2_flash_set_led_brightness(struct v4l2_flash *v4l2_flash,\n\t\t\t\t\t struct v4l2_ctrl *ctrl)\n{\n\tstruct v4l2_ctrl **ctrls = v4l2_flash->ctrls;\n\tstruct led_classdev *led_cdev;\n\tenum led_brightness brightness;\n\n\tif (has_flash_op(v4l2_flash, intensity_to_led_brightness))\n\t\tbrightness = call_flash_op(v4l2_flash,\n\t\t\t\t\tintensity_to_led_brightness,\n\t\t\t\t\tctrl->val);\n\telse\n\t\tbrightness = __intensity_to_led_brightness(ctrl, ctrl->val);\n\t \n\tif (has_flash_op(v4l2_flash, led_brightness_to_intensity))\n\t\tctrl->val = call_flash_op(v4l2_flash,\n\t\t\t\t\tled_brightness_to_intensity,\n\t\t\t\t\tbrightness);\n\n\tif (ctrl == ctrls[TORCH_INTENSITY]) {\n\t\tif (ctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_TORCH)\n\t\t\treturn 0;\n\n\t\tif (WARN_ON_ONCE(!v4l2_flash->fled_cdev))\n\t\t\treturn -EINVAL;\n\n\t\tled_cdev = &v4l2_flash->fled_cdev->led_cdev;\n\t} else {\n\t\tif (WARN_ON_ONCE(!v4l2_flash->iled_cdev))\n\t\t\treturn -EINVAL;\n\n\t\tled_cdev = v4l2_flash->iled_cdev;\n\t}\n\n\treturn led_set_brightness_sync(led_cdev, brightness);\n}\n\nstatic int v4l2_flash_update_led_brightness(struct v4l2_flash *v4l2_flash,\n\t\t\t\t\tstruct v4l2_ctrl *ctrl)\n{\n\tstruct v4l2_ctrl **ctrls = v4l2_flash->ctrls;\n\tstruct led_classdev *led_cdev;\n\tint ret;\n\n\tif (ctrl == ctrls[TORCH_INTENSITY]) {\n\t\t \n\t\tif (ctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_TORCH)\n\t\t\treturn 0;\n\n\t\tif (WARN_ON_ONCE(!v4l2_flash->fled_cdev))\n\t\t\treturn -EINVAL;\n\n\t\tled_cdev = &v4l2_flash->fled_cdev->led_cdev;\n\t} else {\n\t\tif (WARN_ON_ONCE(!v4l2_flash->iled_cdev))\n\t\t\treturn -EINVAL;\n\n\t\tled_cdev = v4l2_flash->iled_cdev;\n\t}\n\n\tret = led_update_brightness(led_cdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (has_flash_op(v4l2_flash, led_brightness_to_intensity))\n\t\tctrl->val = call_flash_op(v4l2_flash,\n\t\t\t\t\t\tled_brightness_to_intensity,\n\t\t\t\t\t\tled_cdev->brightness);\n\telse\n\t\tctrl->val = __led_brightness_to_intensity(ctrl,\n\t\t\t\t\t\tled_cdev->brightness);\n\n\treturn 0;\n}\n\nstatic int v4l2_flash_g_volatile_ctrl(struct v4l2_ctrl *c)\n{\n\tstruct v4l2_flash *v4l2_flash = v4l2_ctrl_to_v4l2_flash(c);\n\tstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\n\tbool is_strobing;\n\tint ret;\n\n\tswitch (c->id) {\n\tcase V4L2_CID_FLASH_TORCH_INTENSITY:\n\tcase V4L2_CID_FLASH_INDICATOR_INTENSITY:\n\t\treturn v4l2_flash_update_led_brightness(v4l2_flash, c);\n\t}\n\n\tif (!fled_cdev)\n\t\treturn -EINVAL;\n\n\tswitch (c->id) {\n\tcase V4L2_CID_FLASH_INTENSITY:\n\t\tret = led_update_flash_brightness(fled_cdev);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\t \n\t\tc->val = fled_cdev->brightness.val;\n\t\treturn 0;\n\tcase V4L2_CID_FLASH_STROBE_STATUS:\n\t\tret = led_get_flash_strobe(fled_cdev, &is_strobing);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tc->val = is_strobing;\n\t\treturn 0;\n\tcase V4L2_CID_FLASH_FAULT:\n\t\t \n\t\treturn led_get_flash_fault(fled_cdev, &c->val);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic bool __software_strobe_mode_inactive(struct v4l2_ctrl **ctrls)\n{\n\treturn ((ctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_FLASH) ||\n\t\t(ctrls[STROBE_SOURCE] && (ctrls[STROBE_SOURCE]->val !=\n\t\t\t\tV4L2_FLASH_STROBE_SOURCE_SOFTWARE)));\n}\n\nstatic int v4l2_flash_s_ctrl(struct v4l2_ctrl *c)\n{\n\tstruct v4l2_flash *v4l2_flash = v4l2_ctrl_to_v4l2_flash(c);\n\tstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\n\tstruct led_classdev *led_cdev;\n\tstruct v4l2_ctrl **ctrls = v4l2_flash->ctrls;\n\tbool external_strobe;\n\tint ret = 0;\n\n\tswitch (c->id) {\n\tcase V4L2_CID_FLASH_TORCH_INTENSITY:\n\tcase V4L2_CID_FLASH_INDICATOR_INTENSITY:\n\t\treturn v4l2_flash_set_led_brightness(v4l2_flash, c);\n\t}\n\n\tif (!fled_cdev)\n\t\treturn -EINVAL;\n\n\tled_cdev = &fled_cdev->led_cdev;\n\n\tswitch (c->id) {\n\tcase V4L2_CID_FLASH_LED_MODE:\n\t\tswitch (c->val) {\n\t\tcase V4L2_FLASH_LED_MODE_NONE:\n\t\t\tled_set_brightness_sync(led_cdev, LED_OFF);\n\t\t\treturn led_set_flash_strobe(fled_cdev, false);\n\t\tcase V4L2_FLASH_LED_MODE_FLASH:\n\t\t\t \n\t\t\tled_set_brightness_sync(led_cdev, LED_OFF);\n\t\t\tif (ctrls[STROBE_SOURCE]) {\n\t\t\t\texternal_strobe = (ctrls[STROBE_SOURCE]->val ==\n\t\t\t\t\tV4L2_FLASH_STROBE_SOURCE_EXTERNAL);\n\n\t\t\t\tret = call_flash_op(v4l2_flash,\n\t\t\t\t\t\texternal_strobe_set,\n\t\t\t\t\t\texternal_strobe);\n\t\t\t}\n\t\t\treturn ret;\n\t\tcase V4L2_FLASH_LED_MODE_TORCH:\n\t\t\tif (ctrls[STROBE_SOURCE]) {\n\t\t\t\tret = call_flash_op(v4l2_flash,\n\t\t\t\t\t\texternal_strobe_set,\n\t\t\t\t\t\tfalse);\n\t\t\t\tif (ret < 0)\n\t\t\t\t\treturn ret;\n\t\t\t}\n\t\t\t \n\t\t\tret = led_set_flash_strobe(fled_cdev, false);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\treturn v4l2_flash_set_led_brightness(v4l2_flash,\n\t\t\t\t\t\t\t     ctrls[TORCH_INTENSITY]);\n\t\t}\n\t\tbreak;\n\tcase V4L2_CID_FLASH_STROBE_SOURCE:\n\t\texternal_strobe = (c->val == V4L2_FLASH_STROBE_SOURCE_EXTERNAL);\n\t\t \n\t\tif (ctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_FLASH)\n\t\t\treturn 0;\n\n\t\treturn call_flash_op(v4l2_flash, external_strobe_set,\n\t\t\t\t\texternal_strobe);\n\tcase V4L2_CID_FLASH_STROBE:\n\t\tif (__software_strobe_mode_inactive(ctrls))\n\t\t\treturn -EBUSY;\n\t\treturn led_set_flash_strobe(fled_cdev, true);\n\tcase V4L2_CID_FLASH_STROBE_STOP:\n\t\tif (__software_strobe_mode_inactive(ctrls))\n\t\t\treturn -EBUSY;\n\t\treturn led_set_flash_strobe(fled_cdev, false);\n\tcase V4L2_CID_FLASH_TIMEOUT:\n\t\t \n\t\treturn led_set_flash_timeout(fled_cdev, c->val);\n\tcase V4L2_CID_FLASH_INTENSITY:\n\t\t \n\t\treturn led_set_flash_brightness(fled_cdev, c->val);\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic const struct v4l2_ctrl_ops v4l2_flash_ctrl_ops = {\n\t.g_volatile_ctrl = v4l2_flash_g_volatile_ctrl,\n\t.s_ctrl = v4l2_flash_s_ctrl,\n};\n\nstatic void __lfs_to_v4l2_ctrl_config(struct led_flash_setting *s,\n\t\t\t\tstruct v4l2_ctrl_config *c)\n{\n\tc->min = s->min;\n\tc->max = s->max;\n\tc->step = s->step;\n\tc->def = s->val;\n}\n\nstatic void __fill_ctrl_init_data(struct v4l2_flash *v4l2_flash,\n\t\t\t  struct v4l2_flash_config *flash_cfg,\n\t\t\t  struct v4l2_flash_ctrl_data *ctrl_init_data)\n{\n\tstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\n\tstruct led_classdev *led_cdev = fled_cdev ? &fled_cdev->led_cdev : NULL;\n\tstruct v4l2_ctrl_config *ctrl_cfg;\n\tu32 mask;\n\n\t \n\tif (v4l2_flash->iled_cdev) {\n\t\tctrl_init_data[INDICATOR_INTENSITY].cid =\n\t\t\t\t\tV4L2_CID_FLASH_INDICATOR_INTENSITY;\n\t\tctrl_cfg = &ctrl_init_data[INDICATOR_INTENSITY].config;\n\t\t__lfs_to_v4l2_ctrl_config(&flash_cfg->intensity,\n\t\t\t\t\t  ctrl_cfg);\n\t\tctrl_cfg->id = V4L2_CID_FLASH_INDICATOR_INTENSITY;\n\t\tctrl_cfg->min = 0;\n\t\tctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\n\t\t\t\t  V4L2_CTRL_FLAG_EXECUTE_ON_WRITE;\n\t}\n\n\tif (!led_cdev || WARN_ON(!(led_cdev->flags & LED_DEV_CAP_FLASH)))\n\t\treturn;\n\n\t \n\tif (flash_cfg->flash_faults) {\n\t\tctrl_init_data[FLASH_FAULT].cid = V4L2_CID_FLASH_FAULT;\n\t\tctrl_cfg = &ctrl_init_data[FLASH_FAULT].config;\n\t\tctrl_cfg->id = V4L2_CID_FLASH_FAULT;\n\t\tctrl_cfg->max = flash_cfg->flash_faults;\n\t\tctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\n\t\t\t\t  V4L2_CTRL_FLAG_READ_ONLY;\n\t}\n\n\t \n\tmask = 1 << V4L2_FLASH_LED_MODE_NONE |\n\t       1 << V4L2_FLASH_LED_MODE_TORCH;\n\tif (led_cdev->flags & LED_DEV_CAP_FLASH)\n\t\tmask |= 1 << V4L2_FLASH_LED_MODE_FLASH;\n\n\tctrl_init_data[LED_MODE].cid = V4L2_CID_FLASH_LED_MODE;\n\tctrl_cfg = &ctrl_init_data[LED_MODE].config;\n\tctrl_cfg->id = V4L2_CID_FLASH_LED_MODE;\n\tctrl_cfg->max = V4L2_FLASH_LED_MODE_TORCH;\n\tctrl_cfg->menu_skip_mask = ~mask;\n\tctrl_cfg->def = V4L2_FLASH_LED_MODE_NONE;\n\tctrl_cfg->flags = 0;\n\n\t \n\tctrl_init_data[TORCH_INTENSITY].cid = V4L2_CID_FLASH_TORCH_INTENSITY;\n\tctrl_cfg = &ctrl_init_data[TORCH_INTENSITY].config;\n\t__lfs_to_v4l2_ctrl_config(&flash_cfg->intensity, ctrl_cfg);\n\tctrl_cfg->id = V4L2_CID_FLASH_TORCH_INTENSITY;\n\tctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\n\t\t\t  V4L2_CTRL_FLAG_EXECUTE_ON_WRITE;\n\n\t \n\tctrl_init_data[FLASH_STROBE].cid = V4L2_CID_FLASH_STROBE;\n\tctrl_cfg = &ctrl_init_data[FLASH_STROBE].config;\n\tctrl_cfg->id = V4L2_CID_FLASH_STROBE;\n\n\t \n\tctrl_init_data[STROBE_STOP].cid = V4L2_CID_FLASH_STROBE_STOP;\n\tctrl_cfg = &ctrl_init_data[STROBE_STOP].config;\n\tctrl_cfg->id = V4L2_CID_FLASH_STROBE_STOP;\n\n\t \n\tif (flash_cfg->has_external_strobe) {\n\t\tmask = (1 << V4L2_FLASH_STROBE_SOURCE_SOFTWARE) |\n\t\t       (1 << V4L2_FLASH_STROBE_SOURCE_EXTERNAL);\n\t\tctrl_init_data[STROBE_SOURCE].cid =\n\t\t\t\t\tV4L2_CID_FLASH_STROBE_SOURCE;\n\t\tctrl_cfg = &ctrl_init_data[STROBE_SOURCE].config;\n\t\tctrl_cfg->id = V4L2_CID_FLASH_STROBE_SOURCE;\n\t\tctrl_cfg->max = V4L2_FLASH_STROBE_SOURCE_EXTERNAL;\n\t\tctrl_cfg->menu_skip_mask = ~mask;\n\t\tctrl_cfg->def = V4L2_FLASH_STROBE_SOURCE_SOFTWARE;\n\t}\n\n\t \n\tif (has_flash_op(fled_cdev, strobe_get)) {\n\t\tctrl_init_data[STROBE_STATUS].cid =\n\t\t\t\t\tV4L2_CID_FLASH_STROBE_STATUS;\n\t\tctrl_cfg = &ctrl_init_data[STROBE_STATUS].config;\n\t\tctrl_cfg->id = V4L2_CID_FLASH_STROBE_STATUS;\n\t\tctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\n\t\t\t\t  V4L2_CTRL_FLAG_READ_ONLY;\n\t}\n\n\t \n\tif (has_flash_op(fled_cdev, timeout_set)) {\n\t\tctrl_init_data[FLASH_TIMEOUT].cid = V4L2_CID_FLASH_TIMEOUT;\n\t\tctrl_cfg = &ctrl_init_data[FLASH_TIMEOUT].config;\n\t\t__lfs_to_v4l2_ctrl_config(&fled_cdev->timeout, ctrl_cfg);\n\t\tctrl_cfg->id = V4L2_CID_FLASH_TIMEOUT;\n\t}\n\n\t \n\tif (has_flash_op(fled_cdev, flash_brightness_set)) {\n\t\tctrl_init_data[FLASH_INTENSITY].cid = V4L2_CID_FLASH_INTENSITY;\n\t\tctrl_cfg = &ctrl_init_data[FLASH_INTENSITY].config;\n\t\t__lfs_to_v4l2_ctrl_config(&fled_cdev->brightness, ctrl_cfg);\n\t\tctrl_cfg->id = V4L2_CID_FLASH_INTENSITY;\n\t\tctrl_cfg->flags = V4L2_CTRL_FLAG_VOLATILE |\n\t\t\t\t  V4L2_CTRL_FLAG_EXECUTE_ON_WRITE;\n\t}\n}\n\nstatic int v4l2_flash_init_controls(struct v4l2_flash *v4l2_flash,\n\t\t\t\tstruct v4l2_flash_config *flash_cfg)\n\n{\n\tstruct v4l2_flash_ctrl_data *ctrl_init_data;\n\tstruct v4l2_ctrl *ctrl;\n\tstruct v4l2_ctrl_config *ctrl_cfg;\n\tint i, ret, num_ctrls = 0;\n\n\tv4l2_flash->ctrls = devm_kcalloc(v4l2_flash->sd.dev,\n\t\t\t\t\tSTROBE_SOURCE + 1,\n\t\t\t\t\tsizeof(*v4l2_flash->ctrls),\n\t\t\t\t\tGFP_KERNEL);\n\tif (!v4l2_flash->ctrls)\n\t\treturn -ENOMEM;\n\n\t \n\tctrl_init_data = kcalloc(NUM_FLASH_CTRLS, sizeof(*ctrl_init_data),\n\t\t\t\t\tGFP_KERNEL);\n\tif (!ctrl_init_data)\n\t\treturn -ENOMEM;\n\n\t__fill_ctrl_init_data(v4l2_flash, flash_cfg, ctrl_init_data);\n\n\tfor (i = 0; i < NUM_FLASH_CTRLS; ++i)\n\t\tif (ctrl_init_data[i].cid)\n\t\t\t++num_ctrls;\n\n\tv4l2_ctrl_handler_init(&v4l2_flash->hdl, num_ctrls);\n\n\tfor (i = 0; i < NUM_FLASH_CTRLS; ++i) {\n\t\tctrl_cfg = &ctrl_init_data[i].config;\n\t\tif (!ctrl_init_data[i].cid)\n\t\t\tcontinue;\n\n\t\tif (ctrl_cfg->id == V4L2_CID_FLASH_LED_MODE ||\n\t\t    ctrl_cfg->id == V4L2_CID_FLASH_STROBE_SOURCE)\n\t\t\tctrl = v4l2_ctrl_new_std_menu(&v4l2_flash->hdl,\n\t\t\t\t\t\t&v4l2_flash_ctrl_ops,\n\t\t\t\t\t\tctrl_cfg->id,\n\t\t\t\t\t\tctrl_cfg->max,\n\t\t\t\t\t\tctrl_cfg->menu_skip_mask,\n\t\t\t\t\t\tctrl_cfg->def);\n\t\telse\n\t\t\tctrl = v4l2_ctrl_new_std(&v4l2_flash->hdl,\n\t\t\t\t\t\t&v4l2_flash_ctrl_ops,\n\t\t\t\t\t\tctrl_cfg->id,\n\t\t\t\t\t\tctrl_cfg->min,\n\t\t\t\t\t\tctrl_cfg->max,\n\t\t\t\t\t\tctrl_cfg->step,\n\t\t\t\t\t\tctrl_cfg->def);\n\n\t\tif (ctrl)\n\t\t\tctrl->flags |= ctrl_cfg->flags;\n\n\t\tif (i <= STROBE_SOURCE)\n\t\t\tv4l2_flash->ctrls[i] = ctrl;\n\t}\n\n\tkfree(ctrl_init_data);\n\n\tif (v4l2_flash->hdl.error) {\n\t\tret = v4l2_flash->hdl.error;\n\t\tgoto error_free_handler;\n\t}\n\n\tv4l2_ctrl_handler_setup(&v4l2_flash->hdl);\n\n\tv4l2_flash->sd.ctrl_handler = &v4l2_flash->hdl;\n\n\treturn 0;\n\nerror_free_handler:\n\tv4l2_ctrl_handler_free(&v4l2_flash->hdl);\n\treturn ret;\n}\n\nstatic int __sync_device_with_v4l2_controls(struct v4l2_flash *v4l2_flash)\n{\n\tstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\n\tstruct v4l2_ctrl **ctrls = v4l2_flash->ctrls;\n\tint ret = 0;\n\n\tif (ctrls[TORCH_INTENSITY]) {\n\t\tret = v4l2_flash_set_led_brightness(v4l2_flash,\n\t\t\t\t\t\t    ctrls[TORCH_INTENSITY]);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (ctrls[INDICATOR_INTENSITY]) {\n\t\tret = v4l2_flash_set_led_brightness(v4l2_flash,\n\t\t\t\t\t\t    ctrls[INDICATOR_INTENSITY]);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (ctrls[FLASH_TIMEOUT]) {\n\t\tif (WARN_ON_ONCE(!fled_cdev))\n\t\t\treturn -EINVAL;\n\n\t\tret = led_set_flash_timeout(fled_cdev,\n\t\t\t\t\tctrls[FLASH_TIMEOUT]->val);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (ctrls[FLASH_INTENSITY]) {\n\t\tif (WARN_ON_ONCE(!fled_cdev))\n\t\t\treturn -EINVAL;\n\n\t\tret = led_set_flash_brightness(fled_cdev,\n\t\t\t\t\tctrls[FLASH_INTENSITY]->val);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (ctrls[STROBE_SOURCE] &&\n\t    ctrls[LED_MODE]->val != V4L2_FLASH_LED_MODE_TORCH)\n\t\tret = call_flash_op(v4l2_flash, external_strobe_set,\n\t\t\t\t\tctrls[STROBE_SOURCE]->val);\n\n\treturn ret;\n}\n\n \n\nstatic int v4l2_flash_open(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)\n{\n\tstruct v4l2_flash *v4l2_flash = v4l2_subdev_to_v4l2_flash(sd);\n\tstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\n\tstruct led_classdev *led_cdev = fled_cdev ? &fled_cdev->led_cdev : NULL;\n\tstruct led_classdev *led_cdev_ind = v4l2_flash->iled_cdev;\n\tint ret = 0;\n\n\tif (!v4l2_fh_is_singular(&fh->vfh))\n\t\treturn 0;\n\n\tif (led_cdev) {\n\t\tmutex_lock(&led_cdev->led_access);\n\n\t\tled_sysfs_disable(led_cdev);\n\t\tled_trigger_remove(led_cdev);\n\n\t\tmutex_unlock(&led_cdev->led_access);\n\t}\n\n\tif (led_cdev_ind) {\n\t\tmutex_lock(&led_cdev_ind->led_access);\n\n\t\tled_sysfs_disable(led_cdev_ind);\n\t\tled_trigger_remove(led_cdev_ind);\n\n\t\tmutex_unlock(&led_cdev_ind->led_access);\n\t}\n\n\tret = __sync_device_with_v4l2_controls(v4l2_flash);\n\tif (ret < 0)\n\t\tgoto out_sync_device;\n\n\treturn 0;\nout_sync_device:\n\tif (led_cdev) {\n\t\tmutex_lock(&led_cdev->led_access);\n\t\tled_sysfs_enable(led_cdev);\n\t\tmutex_unlock(&led_cdev->led_access);\n\t}\n\n\tif (led_cdev_ind) {\n\t\tmutex_lock(&led_cdev_ind->led_access);\n\t\tled_sysfs_enable(led_cdev_ind);\n\t\tmutex_unlock(&led_cdev_ind->led_access);\n\t}\n\n\treturn ret;\n}\n\nstatic int v4l2_flash_close(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)\n{\n\tstruct v4l2_flash *v4l2_flash = v4l2_subdev_to_v4l2_flash(sd);\n\tstruct led_classdev_flash *fled_cdev = v4l2_flash->fled_cdev;\n\tstruct led_classdev *led_cdev = fled_cdev ? &fled_cdev->led_cdev : NULL;\n\tstruct led_classdev *led_cdev_ind = v4l2_flash->iled_cdev;\n\tint ret = 0;\n\n\tif (!v4l2_fh_is_singular(&fh->vfh))\n\t\treturn 0;\n\n\tif (led_cdev) {\n\t\tmutex_lock(&led_cdev->led_access);\n\n\t\tif (v4l2_flash->ctrls[STROBE_SOURCE])\n\t\t\tret = v4l2_ctrl_s_ctrl(\n\t\t\t\tv4l2_flash->ctrls[STROBE_SOURCE],\n\t\t\t\tV4L2_FLASH_STROBE_SOURCE_SOFTWARE);\n\t\tled_sysfs_enable(led_cdev);\n\n\t\tmutex_unlock(&led_cdev->led_access);\n\t}\n\n\tif (led_cdev_ind) {\n\t\tmutex_lock(&led_cdev_ind->led_access);\n\t\tled_sysfs_enable(led_cdev_ind);\n\t\tmutex_unlock(&led_cdev_ind->led_access);\n\t}\n\n\treturn ret;\n}\n\nstatic const struct v4l2_subdev_internal_ops v4l2_flash_subdev_internal_ops = {\n\t.open = v4l2_flash_open,\n\t.close = v4l2_flash_close,\n};\n\nstatic const struct v4l2_subdev_ops v4l2_flash_subdev_ops;\n\nstatic struct v4l2_flash *__v4l2_flash_init(\n\tstruct device *dev, struct fwnode_handle *fwn,\n\tstruct led_classdev_flash *fled_cdev, struct led_classdev *iled_cdev,\n\tconst struct v4l2_flash_ops *ops, struct v4l2_flash_config *config)\n{\n\tstruct v4l2_flash *v4l2_flash;\n\tstruct v4l2_subdev *sd;\n\tint ret;\n\n\tif (!config)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tv4l2_flash = devm_kzalloc(dev, sizeof(*v4l2_flash), GFP_KERNEL);\n\tif (!v4l2_flash)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tsd = &v4l2_flash->sd;\n\tv4l2_flash->fled_cdev = fled_cdev;\n\tv4l2_flash->iled_cdev = iled_cdev;\n\tv4l2_flash->ops = ops;\n\tsd->dev = dev;\n\tsd->fwnode = fwn ? fwn : dev_fwnode(dev);\n\tv4l2_subdev_init(sd, &v4l2_flash_subdev_ops);\n\tsd->internal_ops = &v4l2_flash_subdev_internal_ops;\n\tsd->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\n\tstrscpy(sd->name, config->dev_name, sizeof(sd->name));\n\n\tret = media_entity_pads_init(&sd->entity, 0, NULL);\n\tif (ret < 0)\n\t\treturn ERR_PTR(ret);\n\n\tsd->entity.function = MEDIA_ENT_F_FLASH;\n\n\tret = v4l2_flash_init_controls(v4l2_flash, config);\n\tif (ret < 0)\n\t\tgoto err_init_controls;\n\n\tfwnode_handle_get(sd->fwnode);\n\n\tret = v4l2_async_register_subdev(sd);\n\tif (ret < 0)\n\t\tgoto err_async_register_sd;\n\n\treturn v4l2_flash;\n\nerr_async_register_sd:\n\tfwnode_handle_put(sd->fwnode);\n\tv4l2_ctrl_handler_free(sd->ctrl_handler);\nerr_init_controls:\n\tmedia_entity_cleanup(&sd->entity);\n\n\treturn ERR_PTR(ret);\n}\n\nstruct v4l2_flash *v4l2_flash_init(\n\tstruct device *dev, struct fwnode_handle *fwn,\n\tstruct led_classdev_flash *fled_cdev,\n\tconst struct v4l2_flash_ops *ops,\n\tstruct v4l2_flash_config *config)\n{\n\treturn __v4l2_flash_init(dev, fwn, fled_cdev, NULL, ops, config);\n}\nEXPORT_SYMBOL_GPL(v4l2_flash_init);\n\nstruct v4l2_flash *v4l2_flash_indicator_init(\n\tstruct device *dev, struct fwnode_handle *fwn,\n\tstruct led_classdev *iled_cdev,\n\tstruct v4l2_flash_config *config)\n{\n\treturn __v4l2_flash_init(dev, fwn, NULL, iled_cdev, NULL, config);\n}\nEXPORT_SYMBOL_GPL(v4l2_flash_indicator_init);\n\nvoid v4l2_flash_release(struct v4l2_flash *v4l2_flash)\n{\n\tstruct v4l2_subdev *sd;\n\n\tif (IS_ERR_OR_NULL(v4l2_flash))\n\t\treturn;\n\n\tsd = &v4l2_flash->sd;\n\n\tv4l2_async_unregister_subdev(sd);\n\n\tfwnode_handle_put(sd->fwnode);\n\n\tv4l2_ctrl_handler_free(sd->ctrl_handler);\n\tmedia_entity_cleanup(&sd->entity);\n}\nEXPORT_SYMBOL_GPL(v4l2_flash_release);\n\nMODULE_AUTHOR(\"Jacek Anaszewski <j.anaszewski@samsung.com>\");\nMODULE_DESCRIPTION(\"V4L2 Flash sub-device helpers\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}