{
  "module_name": "isl6421.c",
  "hash_id": "0f7f4432270ee38cacfac41aeaccb0ad138cbb129379580690871808668c4543",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/dvb-frontends/isl6421.c",
  "human_readable_source": "\n \n#include <linux/delay.h>\n#include <linux/errno.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/string.h>\n#include <linux/slab.h>\n\n#include <media/dvb_frontend.h>\n#include \"isl6421.h\"\n\nstruct isl6421 {\n\tu8\t\t\tconfig;\n\tu8\t\t\toverride_or;\n\tu8\t\t\toverride_and;\n\tstruct i2c_adapter\t*i2c;\n\tu8\t\t\ti2c_addr;\n\tbool\t\t\tis_off;\n};\n\nstatic int isl6421_set_voltage(struct dvb_frontend *fe,\n\t\t\t       enum fe_sec_voltage voltage)\n{\n\tint ret;\n\tu8 buf;\n\tbool is_off;\n\tstruct isl6421 *isl6421 = (struct isl6421 *) fe->sec_priv;\n\tstruct i2c_msg msg[2] = {\n\t\t{\n\t\t  .addr = isl6421->i2c_addr,\n\t\t  .flags = 0,\n\t\t  .buf = &isl6421->config,\n\t\t  .len = 1,\n\t\t}, {\n\t\t  .addr = isl6421->i2c_addr,\n\t\t  .flags = I2C_M_RD,\n\t\t  .buf = &buf,\n\t\t  .len = 1,\n\t\t}\n\n\t};\n\n\tisl6421->config &= ~(ISL6421_VSEL1 | ISL6421_EN1);\n\n\tswitch(voltage) {\n\tcase SEC_VOLTAGE_OFF:\n\t\tis_off = true;\n\t\tbreak;\n\tcase SEC_VOLTAGE_13:\n\t\tis_off = false;\n\t\tisl6421->config |= ISL6421_EN1;\n\t\tbreak;\n\tcase SEC_VOLTAGE_18:\n\t\tis_off = false;\n\t\tisl6421->config |= (ISL6421_EN1 | ISL6421_VSEL1);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (isl6421->is_off && !is_off)\n\t\tisl6421->config |= ISL6421_DCL;\n\n\tisl6421->config |= isl6421->override_or;\n\tisl6421->config &= isl6421->override_and;\n\n\tret = i2c_transfer(isl6421->i2c, msg, 2);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret != 2)\n\t\treturn -EIO;\n\n\t \n\tisl6421->is_off = is_off;\n\n\t \n\tif (!is_off && (buf & ISL6421_OLF1))\n\t\tmsleep(1000);\n\n\t \n\tif ((isl6421->config & ISL6421_DCL) &&\n\t    !(isl6421->override_or & ISL6421_DCL)) {\n\t\tisl6421->config &= ~ISL6421_DCL;\n\n\t\tret = i2c_transfer(isl6421->i2c, msg, 2);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tif (ret != 2)\n\t\t\treturn -EIO;\n\t}\n\n\t \n\tif (!is_off && (buf & ISL6421_OLF1)) {\n\t\tisl6421->config &= ~(ISL6421_VSEL1 | ISL6421_EN1);\n\t\tret = i2c_transfer(isl6421->i2c, msg, 1);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tif (ret != 1)\n\t\t\treturn -EIO;\n\t\tisl6421->is_off = true;\n\n\t\tdev_warn(&isl6421->i2c->dev,\n\t\t\t \"Overload current detected. disabling LNBf power\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int isl6421_enable_high_lnb_voltage(struct dvb_frontend *fe, long arg)\n{\n\tstruct isl6421 *isl6421 = (struct isl6421 *) fe->sec_priv;\n\tstruct i2c_msg msg = {\t.addr = isl6421->i2c_addr, .flags = 0,\n\t\t\t\t.buf = &isl6421->config,\n\t\t\t\t.len = sizeof(isl6421->config) };\n\n\tif (arg)\n\t\tisl6421->config |= ISL6421_LLC1;\n\telse\n\t\tisl6421->config &= ~ISL6421_LLC1;\n\n\tisl6421->config |= isl6421->override_or;\n\tisl6421->config &= isl6421->override_and;\n\n\treturn (i2c_transfer(isl6421->i2c, &msg, 1) == 1) ? 0 : -EIO;\n}\n\nstatic int isl6421_set_tone(struct dvb_frontend *fe,\n\t\t\t    enum fe_sec_tone_mode tone)\n{\n\tstruct isl6421 *isl6421 = (struct isl6421 *) fe->sec_priv;\n\tstruct i2c_msg msg = { .addr = isl6421->i2c_addr, .flags = 0,\n\t\t\t       .buf = &isl6421->config,\n\t\t\t       .len = sizeof(isl6421->config) };\n\n\tswitch (tone) {\n\tcase SEC_TONE_ON:\n\t\tisl6421->config |= ISL6421_ENT1;\n\t\tbreak;\n\tcase SEC_TONE_OFF:\n\t\tisl6421->config &= ~ISL6421_ENT1;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tisl6421->config |= isl6421->override_or;\n\tisl6421->config &= isl6421->override_and;\n\n\treturn (i2c_transfer(isl6421->i2c, &msg, 1) == 1) ? 0 : -EIO;\n}\n\nstatic void isl6421_release(struct dvb_frontend *fe)\n{\n\t \n\tisl6421_set_voltage(fe, SEC_VOLTAGE_OFF);\n\n\t \n\tkfree(fe->sec_priv);\n\tfe->sec_priv = NULL;\n}\n\nstruct dvb_frontend *isl6421_attach(struct dvb_frontend *fe, struct i2c_adapter *i2c, u8 i2c_addr,\n\t\t   u8 override_set, u8 override_clear, bool override_tone)\n{\n\tstruct isl6421 *isl6421 = kmalloc(sizeof(struct isl6421), GFP_KERNEL);\n\tif (!isl6421)\n\t\treturn NULL;\n\n\t \n\tisl6421->config = ISL6421_ISEL1;\n\tisl6421->i2c = i2c;\n\tisl6421->i2c_addr = i2c_addr;\n\tfe->sec_priv = isl6421;\n\n\t \n\tisl6421->override_or = override_set;\n\n\t \n\tisl6421->override_and = ~override_clear;\n\n\t \n\tif (isl6421_set_voltage(fe, SEC_VOLTAGE_OFF)) {\n\t\tkfree(isl6421);\n\t\tfe->sec_priv = NULL;\n\t\treturn NULL;\n\t}\n\n\tisl6421->is_off = true;\n\n\t \n\tfe->ops.release_sec = isl6421_release;\n\n\t \n\tfe->ops.set_voltage = isl6421_set_voltage;\n\tfe->ops.enable_high_lnb_voltage = isl6421_enable_high_lnb_voltage;\n\tif (override_tone)\n\t\tfe->ops.set_tone = isl6421_set_tone;\n\n\treturn fe;\n}\nEXPORT_SYMBOL_GPL(isl6421_attach);\n\nMODULE_DESCRIPTION(\"Driver for lnb supply and control ic isl6421\");\nMODULE_AUTHOR(\"Andrew de Quincey & Oliver Endriss\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}