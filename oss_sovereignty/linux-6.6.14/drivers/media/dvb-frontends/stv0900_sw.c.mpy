{
  "module_name": "stv0900_sw.c",
  "hash_id": "9ec235aab601562402cc0c4f75a459aeba4f5b2b58984aae205d5afda548d583",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/dvb-frontends/stv0900_sw.c",
  "human_readable_source": "\n \n\n#include \"stv0900.h\"\n#include \"stv0900_reg.h\"\n#include \"stv0900_priv.h\"\n\ns32 shiftx(s32 x, int demod, s32 shift)\n{\n\tif (demod == 1)\n\t\treturn x - shift;\n\n\treturn x;\n}\n\nint stv0900_check_signal_presence(struct stv0900_internal *intp,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\ts32\tcarr_offset,\n\t\tagc2_integr,\n\t\tmax_carrier;\n\n\tint no_signal = FALSE;\n\n\tcarr_offset = (stv0900_read_reg(intp, CFR2) << 8)\n\t\t\t\t\t| stv0900_read_reg(intp, CFR1);\n\tcarr_offset = ge2comp(carr_offset, 16);\n\tagc2_integr = (stv0900_read_reg(intp, AGC2I1) << 8)\n\t\t\t\t\t| stv0900_read_reg(intp, AGC2I0);\n\tmax_carrier = intp->srch_range[demod] / 1000;\n\n\tmax_carrier += (max_carrier / 10);\n\tmax_carrier = 65536 * (max_carrier / 2);\n\tmax_carrier /= intp->mclk / 1000;\n\tif (max_carrier > 0x4000)\n\t\tmax_carrier = 0x4000;\n\n\tif ((agc2_integr > 0x2000)\n\t\t\t|| (carr_offset > (2 * max_carrier))\n\t\t\t|| (carr_offset < (-2 * max_carrier)))\n\t\tno_signal = TRUE;\n\n\treturn no_signal;\n}\n\nstatic void stv0900_get_sw_loop_params(struct stv0900_internal *intp,\n\t\t\t\ts32 *frequency_inc, s32 *sw_timeout,\n\t\t\t\ts32 *steps,\n\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\ts32 timeout, freq_inc, max_steps, srate, max_carrier;\n\n\tenum fe_stv0900_search_standard\tstandard;\n\n\tsrate = intp->symbol_rate[demod];\n\tmax_carrier = intp->srch_range[demod] / 1000;\n\tmax_carrier += max_carrier / 10;\n\tstandard = intp->srch_standard[demod];\n\n\tmax_carrier = 65536 * (max_carrier / 2);\n\tmax_carrier /= intp->mclk / 1000;\n\n\tif (max_carrier > 0x4000)\n\t\tmax_carrier = 0x4000;\n\n\tfreq_inc = srate;\n\tfreq_inc /= intp->mclk >> 10;\n\tfreq_inc = freq_inc << 6;\n\n\tswitch (standard) {\n\tcase STV0900_SEARCH_DVBS1:\n\tcase STV0900_SEARCH_DSS:\n\t\tfreq_inc *= 3;\n\t\ttimeout = 20;\n\t\tbreak;\n\tcase STV0900_SEARCH_DVBS2:\n\t\tfreq_inc *= 4;\n\t\ttimeout = 25;\n\t\tbreak;\n\tcase STV0900_AUTO_SEARCH:\n\tdefault:\n\t\tfreq_inc *= 3;\n\t\ttimeout = 25;\n\t\tbreak;\n\t}\n\n\tfreq_inc /= 100;\n\n\tif ((freq_inc > max_carrier) || (freq_inc < 0))\n\t\tfreq_inc = max_carrier / 2;\n\n\ttimeout *= 27500;\n\n\tif (srate > 0)\n\t\ttimeout /= srate / 1000;\n\n\tif ((timeout > 100) || (timeout < 0))\n\t\ttimeout = 100;\n\n\tmax_steps = (max_carrier / freq_inc) + 1;\n\n\tif ((max_steps > 100) || (max_steps < 0)) {\n\t\tmax_steps =  100;\n\t\tfreq_inc = max_carrier / max_steps;\n\t}\n\n\t*frequency_inc = freq_inc;\n\t*sw_timeout = timeout;\n\t*steps = max_steps;\n\n}\n\nstatic int stv0900_search_carr_sw_loop(struct stv0900_internal *intp,\n\t\t\t\ts32 FreqIncr, s32 Timeout, int zigzag,\n\t\t\t\ts32 MaxStep, enum fe_stv0900_demod_num demod)\n{\n\tint\tno_signal,\n\t\tlock = FALSE;\n\ts32\tstepCpt,\n\t\tfreqOffset,\n\t\tmax_carrier;\n\n\tmax_carrier = intp->srch_range[demod] / 1000;\n\tmax_carrier += (max_carrier / 10);\n\n\tmax_carrier = 65536 * (max_carrier / 2);\n\tmax_carrier /= intp->mclk / 1000;\n\n\tif (max_carrier > 0x4000)\n\t\tmax_carrier = 0x4000;\n\n\tif (zigzag == TRUE)\n\t\tfreqOffset = 0;\n\telse\n\t\tfreqOffset = -max_carrier + FreqIncr;\n\n\tstepCpt = 0;\n\n\tdo {\n\t\tstv0900_write_reg(intp, DMDISTATE, 0x1c);\n\t\tstv0900_write_reg(intp, CFRINIT1, (freqOffset / 256) & 0xff);\n\t\tstv0900_write_reg(intp, CFRINIT0, freqOffset & 0xff);\n\t\tstv0900_write_reg(intp, DMDISTATE, 0x18);\n\t\tstv0900_write_bits(intp, ALGOSWRST, 1);\n\n\t\tif (intp->chip_id == 0x12) {\n\t\t\tstv0900_write_bits(intp, RST_HWARE, 1);\n\t\t\tstv0900_write_bits(intp, RST_HWARE, 0);\n\t\t}\n\n\t\tif (zigzag == TRUE) {\n\t\t\tif (freqOffset >= 0)\n\t\t\t\tfreqOffset = -freqOffset - 2 * FreqIncr;\n\t\t\telse\n\t\t\t\tfreqOffset = -freqOffset;\n\t\t} else\n\t\t\tfreqOffset += + 2 * FreqIncr;\n\n\t\tstepCpt++;\n\t\tlock = stv0900_get_demod_lock(intp, demod, Timeout);\n\t\tno_signal = stv0900_check_signal_presence(intp, demod);\n\n\t} while ((lock == FALSE)\n\t\t\t&& (no_signal == FALSE)\n\t\t\t&& ((freqOffset - FreqIncr) <  max_carrier)\n\t\t\t&& ((freqOffset + FreqIncr) > -max_carrier)\n\t\t\t&& (stepCpt < MaxStep));\n\n\tstv0900_write_bits(intp, ALGOSWRST, 0);\n\n\treturn lock;\n}\n\nstatic int stv0900_sw_algo(struct stv0900_internal *intp,\n\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\tint\tlock = FALSE,\n\t\tno_signal,\n\t\tzigzag;\n\ts32\ts2fw,\n\t\tfqc_inc,\n\t\tsft_stp_tout,\n\t\ttrial_cntr,\n\t\tmax_steps;\n\n\tstv0900_get_sw_loop_params(intp, &fqc_inc, &sft_stp_tout,\n\t\t\t\t\t&max_steps, demod);\n\tswitch (intp->srch_standard[demod]) {\n\tcase STV0900_SEARCH_DVBS1:\n\tcase STV0900_SEARCH_DSS:\n\t\tif (intp->chip_id >= 0x20)\n\t\t\tstv0900_write_reg(intp, CARFREQ, 0x3b);\n\t\telse\n\t\t\tstv0900_write_reg(intp, CARFREQ, 0xef);\n\n\t\tstv0900_write_reg(intp, DMDCFGMD, 0x49);\n\t\tzigzag = FALSE;\n\t\tbreak;\n\tcase STV0900_SEARCH_DVBS2:\n\t\tif (intp->chip_id >= 0x20)\n\t\t\tstv0900_write_reg(intp, CORRELABS, 0x79);\n\t\telse\n\t\t\tstv0900_write_reg(intp, CORRELABS, 0x68);\n\n\t\tstv0900_write_reg(intp, DMDCFGMD, 0x89);\n\n\t\tzigzag = TRUE;\n\t\tbreak;\n\tcase STV0900_AUTO_SEARCH:\n\tdefault:\n\t\tif (intp->chip_id >= 0x20) {\n\t\t\tstv0900_write_reg(intp, CARFREQ, 0x3b);\n\t\t\tstv0900_write_reg(intp, CORRELABS, 0x79);\n\t\t} else {\n\t\t\tstv0900_write_reg(intp, CARFREQ, 0xef);\n\t\t\tstv0900_write_reg(intp, CORRELABS, 0x68);\n\t\t}\n\n\t\tstv0900_write_reg(intp, DMDCFGMD, 0xc9);\n\t\tzigzag = FALSE;\n\t\tbreak;\n\t}\n\n\ttrial_cntr = 0;\n\tdo {\n\t\tlock = stv0900_search_carr_sw_loop(intp,\n\t\t\t\t\t\tfqc_inc,\n\t\t\t\t\t\tsft_stp_tout,\n\t\t\t\t\t\tzigzag,\n\t\t\t\t\t\tmax_steps,\n\t\t\t\t\t\tdemod);\n\t\tno_signal = stv0900_check_signal_presence(intp, demod);\n\t\ttrial_cntr++;\n\t\tif ((lock == TRUE)\n\t\t\t\t|| (no_signal == TRUE)\n\t\t\t\t|| (trial_cntr == 2)) {\n\n\t\t\tif (intp->chip_id >= 0x20) {\n\t\t\t\tstv0900_write_reg(intp, CARFREQ, 0x49);\n\t\t\t\tstv0900_write_reg(intp, CORRELABS, 0x9e);\n\t\t\t} else {\n\t\t\t\tstv0900_write_reg(intp, CARFREQ, 0xed);\n\t\t\t\tstv0900_write_reg(intp, CORRELABS, 0x88);\n\t\t\t}\n\n\t\t\tif ((stv0900_get_bits(intp, HEADER_MODE) ==\n\t\t\t\t\t\tSTV0900_DVBS2_FOUND) &&\n\t\t\t\t\t\t\t(lock == TRUE)) {\n\t\t\t\tmsleep(sft_stp_tout);\n\t\t\t\ts2fw = stv0900_get_bits(intp, FLYWHEEL_CPT);\n\n\t\t\t\tif (s2fw < 0xd) {\n\t\t\t\t\tmsleep(sft_stp_tout);\n\t\t\t\t\ts2fw = stv0900_get_bits(intp,\n\t\t\t\t\t\t\t\tFLYWHEEL_CPT);\n\t\t\t\t}\n\n\t\t\t\tif (s2fw < 0xd) {\n\t\t\t\t\tlock = FALSE;\n\n\t\t\t\t\tif (trial_cntr < 2) {\n\t\t\t\t\t\tif (intp->chip_id >= 0x20)\n\t\t\t\t\t\t\tstv0900_write_reg(intp,\n\t\t\t\t\t\t\t\tCORRELABS,\n\t\t\t\t\t\t\t\t0x79);\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tstv0900_write_reg(intp,\n\t\t\t\t\t\t\t\tCORRELABS,\n\t\t\t\t\t\t\t\t0x68);\n\n\t\t\t\t\t\tstv0900_write_reg(intp,\n\t\t\t\t\t\t\t\tDMDCFGMD,\n\t\t\t\t\t\t\t\t0x89);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t} while ((lock == FALSE)\n\t\t&& (trial_cntr < 2)\n\t\t&& (no_signal == FALSE));\n\n\treturn lock;\n}\n\nstatic u32 stv0900_get_symbol_rate(struct stv0900_internal *intp,\n\t\t\t\t\tu32 mclk,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\ts32\trem1, rem2, intval1, intval2, srate;\n\n\tsrate = (stv0900_get_bits(intp, SYMB_FREQ3) << 24) +\n\t\t(stv0900_get_bits(intp, SYMB_FREQ2) << 16) +\n\t\t(stv0900_get_bits(intp, SYMB_FREQ1) << 8) +\n\t\t(stv0900_get_bits(intp, SYMB_FREQ0));\n\tdprintk(\"lock: srate=%d r0=0x%x r1=0x%x r2=0x%x r3=0x%x \\n\",\n\t\tsrate, stv0900_get_bits(intp, SYMB_FREQ0),\n\t\tstv0900_get_bits(intp, SYMB_FREQ1),\n\t\tstv0900_get_bits(intp, SYMB_FREQ2),\n\t\tstv0900_get_bits(intp, SYMB_FREQ3));\n\n\tintval1 = (mclk) >> 16;\n\tintval2 = (srate) >> 16;\n\n\trem1 = (mclk) % 0x10000;\n\trem2 = (srate) % 0x10000;\n\tsrate =\t(intval1 * intval2) +\n\t\t((intval1 * rem2) >> 16) +\n\t\t((intval2 * rem1) >> 16);\n\n\treturn srate;\n}\n\nstatic void stv0900_set_symbol_rate(struct stv0900_internal *intp,\n\t\t\t\t\tu32 mclk, u32 srate,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\tu32 symb;\n\n\tdprintk(\"%s: Mclk %d, SR %d, Dmd %d\\n\", __func__, mclk,\n\t\t\t\t\t\t\tsrate, demod);\n\n\tif (srate > 60000000) {\n\t\tsymb = srate << 4;\n\t\tsymb /= (mclk >> 12);\n\t} else if (srate > 6000000) {\n\t\tsymb = srate << 6;\n\t\tsymb /= (mclk >> 10);\n\t} else {\n\t\tsymb = srate << 9;\n\t\tsymb /= (mclk >> 7);\n\t}\n\n\tstv0900_write_reg(intp, SFRINIT1, (symb >> 8) & 0x7f);\n\tstv0900_write_reg(intp, SFRINIT1 + 1, (symb & 0xff));\n}\n\nstatic void stv0900_set_max_symbol_rate(struct stv0900_internal *intp,\n\t\t\t\t\tu32 mclk, u32 srate,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\tu32 symb;\n\n\tsrate = 105 * (srate / 100);\n\n\tif (srate > 60000000) {\n\t\tsymb = srate << 4;\n\t\tsymb /= (mclk >> 12);\n\t} else if (srate > 6000000) {\n\t\tsymb = srate << 6;\n\t\tsymb /= (mclk >> 10);\n\t} else {\n\t\tsymb = srate << 9;\n\t\tsymb /= (mclk >> 7);\n\t}\n\n\tif (symb < 0x7fff) {\n\t\tstv0900_write_reg(intp, SFRUP1, (symb >> 8) & 0x7f);\n\t\tstv0900_write_reg(intp, SFRUP1 + 1, (symb & 0xff));\n\t} else {\n\t\tstv0900_write_reg(intp, SFRUP1, 0x7f);\n\t\tstv0900_write_reg(intp, SFRUP1 + 1, 0xff);\n\t}\n}\n\nstatic void stv0900_set_min_symbol_rate(struct stv0900_internal *intp,\n\t\t\t\t\tu32 mclk, u32 srate,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\tu32\tsymb;\n\n\tsrate = 95 * (srate / 100);\n\tif (srate > 60000000) {\n\t\tsymb = srate << 4;\n\t\tsymb /= (mclk >> 12);\n\n\t} else if (srate > 6000000) {\n\t\tsymb = srate << 6;\n\t\tsymb /= (mclk >> 10);\n\n\t} else {\n\t\tsymb = srate << 9;\n\t\tsymb /= (mclk >> 7);\n\t}\n\n\tstv0900_write_reg(intp, SFRLOW1, (symb >> 8) & 0xff);\n\tstv0900_write_reg(intp, SFRLOW1 + 1, (symb & 0xff));\n}\n\nstatic s32 stv0900_get_timing_offst(struct stv0900_internal *intp,\n\t\t\t\t\tu32 srate,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\ts32 timingoffset;\n\n\n\ttimingoffset = (stv0900_read_reg(intp, TMGREG2) << 16) +\n\t\t       (stv0900_read_reg(intp, TMGREG2 + 1) << 8) +\n\t\t       (stv0900_read_reg(intp, TMGREG2 + 2));\n\n\ttimingoffset = ge2comp(timingoffset, 24);\n\n\n\tif (timingoffset == 0)\n\t\ttimingoffset = 1;\n\n\ttimingoffset = ((s32)srate * 10) / ((s32)0x1000000 / timingoffset);\n\ttimingoffset /= 320;\n\n\treturn timingoffset;\n}\n\nstatic void stv0900_set_dvbs2_rolloff(struct stv0900_internal *intp,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\ts32 rolloff;\n\n\tif (intp->chip_id == 0x10) {\n\t\tstv0900_write_bits(intp, MANUALSX_ROLLOFF, 1);\n\t\trolloff = stv0900_read_reg(intp, MATSTR1) & 0x03;\n\t\tstv0900_write_bits(intp, ROLLOFF_CONTROL, rolloff);\n\t} else if (intp->chip_id <= 0x20)\n\t\tstv0900_write_bits(intp, MANUALSX_ROLLOFF, 0);\n\telse  \n\t\tstv0900_write_bits(intp, MANUALS2_ROLLOFF, 0);\n}\n\nstatic u32 stv0900_carrier_width(u32 srate, enum fe_stv0900_rolloff ro)\n{\n\tu32 rolloff;\n\n\tswitch (ro) {\n\tcase STV0900_20:\n\t\trolloff = 20;\n\t\tbreak;\n\tcase STV0900_25:\n\t\trolloff = 25;\n\t\tbreak;\n\tcase STV0900_35:\n\tdefault:\n\t\trolloff = 35;\n\t\tbreak;\n\t}\n\n\treturn srate  + (srate * rolloff) / 100;\n}\n\nstatic int stv0900_check_timing_lock(struct stv0900_internal *intp,\n\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\tint timingLock = FALSE;\n\ts32\ti,\n\t\ttimingcpt = 0;\n\tu8\tcar_freq,\n\t\ttmg_th_high,\n\t\ttmg_th_low;\n\n\tcar_freq = stv0900_read_reg(intp, CARFREQ);\n\ttmg_th_high = stv0900_read_reg(intp, TMGTHRISE);\n\ttmg_th_low = stv0900_read_reg(intp, TMGTHFALL);\n\tstv0900_write_reg(intp, TMGTHRISE, 0x20);\n\tstv0900_write_reg(intp, TMGTHFALL, 0x0);\n\tstv0900_write_bits(intp, CFR_AUTOSCAN, 0);\n\tstv0900_write_reg(intp, RTC, 0x80);\n\tstv0900_write_reg(intp, RTCS2, 0x40);\n\tstv0900_write_reg(intp, CARFREQ, 0x0);\n\tstv0900_write_reg(intp, CFRINIT1, 0x0);\n\tstv0900_write_reg(intp, CFRINIT0, 0x0);\n\tstv0900_write_reg(intp, AGC2REF, 0x65);\n\tstv0900_write_reg(intp, DMDISTATE, 0x18);\n\tmsleep(7);\n\n\tfor (i = 0; i < 10; i++) {\n\t\tif (stv0900_get_bits(intp, TMGLOCK_QUALITY) >= 2)\n\t\t\ttimingcpt++;\n\n\t\tmsleep(1);\n\t}\n\n\tif (timingcpt >= 3)\n\t\ttimingLock = TRUE;\n\n\tstv0900_write_reg(intp, AGC2REF, 0x38);\n\tstv0900_write_reg(intp, RTC, 0x88);\n\tstv0900_write_reg(intp, RTCS2, 0x68);\n\tstv0900_write_reg(intp, CARFREQ, car_freq);\n\tstv0900_write_reg(intp, TMGTHRISE, tmg_th_high);\n\tstv0900_write_reg(intp, TMGTHFALL, tmg_th_low);\n\n\treturn\ttimingLock;\n}\n\nstatic int stv0900_get_demod_cold_lock(struct dvb_frontend *fe,\n\t\t\t\t\ts32 demod_timeout)\n{\n\tstruct stv0900_state *state = fe->demodulator_priv;\n\tstruct stv0900_internal *intp = state->internal;\n\tenum fe_stv0900_demod_num demod = state->demod;\n\tint\tlock = FALSE,\n\t\td = demod;\n\ts32\tsrate,\n\t\tsearch_range,\n\t\tlocktimeout,\n\t\tcurrier_step,\n\t\tnb_steps,\n\t\tcurrent_step,\n\t\tdirection,\n\t\ttuner_freq,\n\t\ttimeout,\n\t\tfreq;\n\n\tsrate = intp->symbol_rate[d];\n\tsearch_range = intp->srch_range[d];\n\n\tif (srate >= 10000000)\n\t\tlocktimeout = demod_timeout / 3;\n\telse\n\t\tlocktimeout = demod_timeout / 2;\n\n\tlock = stv0900_get_demod_lock(intp, d, locktimeout);\n\n\tif (lock != FALSE)\n\t\treturn lock;\n\n\tif (srate >= 10000000) {\n\t\tif (stv0900_check_timing_lock(intp, d) == TRUE) {\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x1f);\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x15);\n\t\t\tlock = stv0900_get_demod_lock(intp, d, demod_timeout);\n\t\t} else\n\t\t\tlock = FALSE;\n\n\t\treturn lock;\n\t}\n\n\tif (intp->chip_id <= 0x20) {\n\t\tif (srate <= 1000000)\n\t\t\tcurrier_step = 500;\n\t\telse if (srate <= 4000000)\n\t\t\tcurrier_step = 1000;\n\t\telse if (srate <= 7000000)\n\t\t\tcurrier_step = 2000;\n\t\telse if (srate <= 10000000)\n\t\t\tcurrier_step = 3000;\n\t\telse\n\t\t\tcurrier_step = 5000;\n\n\t\tif (srate >= 2000000) {\n\t\t\ttimeout = (demod_timeout / 3);\n\t\t\tif (timeout > 1000)\n\t\t\t\ttimeout = 1000;\n\t\t} else\n\t\t\ttimeout = (demod_timeout / 2);\n\t} else {\n\t\t \n\t\tcurrier_step = srate / 4000;\n\t\ttimeout = (demod_timeout * 3) / 4;\n\t}\n\n\tnb_steps = ((search_range / 1000) / currier_step);\n\n\tif ((nb_steps % 2) != 0)\n\t\tnb_steps += 1;\n\n\tif (nb_steps <= 0)\n\t\tnb_steps = 2;\n\telse if (nb_steps > 12)\n\t\tnb_steps = 12;\n\n\tcurrent_step = 1;\n\tdirection = 1;\n\n\tif (intp->chip_id <= 0x20) {\n\t\ttuner_freq = intp->freq[d];\n\t\tintp->bw[d] = stv0900_carrier_width(intp->symbol_rate[d],\n\t\t\t\tintp->rolloff) + intp->symbol_rate[d];\n\t} else\n\t\ttuner_freq = 0;\n\n\twhile ((current_step <= nb_steps) && (lock == FALSE)) {\n\t\tif (direction > 0)\n\t\t\ttuner_freq += (current_step * currier_step);\n\t\telse\n\t\t\ttuner_freq -= (current_step * currier_step);\n\n\t\tif (intp->chip_id <= 0x20) {\n\t\t\tif (intp->tuner_type[d] == 3)\n\t\t\t\tstv0900_set_tuner_auto(intp, tuner_freq,\n\t\t\t\t\t\tintp->bw[d], demod);\n\t\t\telse\n\t\t\t\tstv0900_set_tuner(fe, tuner_freq, intp->bw[d]);\n\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x1c);\n\t\t\tstv0900_write_reg(intp, CFRINIT1, 0);\n\t\t\tstv0900_write_reg(intp, CFRINIT0, 0);\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x1f);\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x15);\n\t\t} else {\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x1c);\n\t\t\tfreq = (tuner_freq * 65536) / (intp->mclk / 1000);\n\t\t\tstv0900_write_bits(intp, CFR_INIT1, MSB(freq));\n\t\t\tstv0900_write_bits(intp, CFR_INIT0, LSB(freq));\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x1f);\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x05);\n\t\t}\n\n\t\tlock = stv0900_get_demod_lock(intp, d, timeout);\n\t\tdirection *= -1;\n\t\tcurrent_step++;\n\t}\n\n\treturn\tlock;\n}\n\nstatic void stv0900_get_lock_timeout(s32 *demod_timeout, s32 *fec_timeout,\n\t\t\t\t\ts32 srate,\n\t\t\t\t\tenum fe_stv0900_search_algo algo)\n{\n\tswitch (algo) {\n\tcase STV0900_BLIND_SEARCH:\n\t\tif (srate <= 1500000) {\n\t\t\t(*demod_timeout) = 1500;\n\t\t\t(*fec_timeout) = 400;\n\t\t} else if (srate <= 5000000) {\n\t\t\t(*demod_timeout) = 1000;\n\t\t\t(*fec_timeout) = 300;\n\t\t} else {\n\t\t\t(*demod_timeout) = 700;\n\t\t\t(*fec_timeout) = 100;\n\t\t}\n\n\t\tbreak;\n\tcase STV0900_COLD_START:\n\tcase STV0900_WARM_START:\n\tdefault:\n\t\tif (srate <= 1000000) {\n\t\t\t(*demod_timeout) = 3000;\n\t\t\t(*fec_timeout) = 1700;\n\t\t} else if (srate <= 2000000) {\n\t\t\t(*demod_timeout) = 2500;\n\t\t\t(*fec_timeout) = 1100;\n\t\t} else if (srate <= 5000000) {\n\t\t\t(*demod_timeout) = 1000;\n\t\t\t(*fec_timeout) = 550;\n\t\t} else if (srate <= 10000000) {\n\t\t\t(*demod_timeout) = 700;\n\t\t\t(*fec_timeout) = 250;\n\t\t} else if (srate <= 20000000) {\n\t\t\t(*demod_timeout) = 400;\n\t\t\t(*fec_timeout) = 130;\n\t\t} else {\n\t\t\t(*demod_timeout) = 300;\n\t\t\t(*fec_timeout) = 100;\n\t\t}\n\n\t\tbreak;\n\n\t}\n\n\tif (algo == STV0900_WARM_START)\n\t\t(*demod_timeout) /= 2;\n}\n\nstatic void stv0900_set_viterbi_tracq(struct stv0900_internal *intp,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\n\ts32 vth_reg = VTH12;\n\n\tdprintk(\"%s\\n\", __func__);\n\n\tstv0900_write_reg(intp, vth_reg++, 0xd0);\n\tstv0900_write_reg(intp, vth_reg++, 0x7d);\n\tstv0900_write_reg(intp, vth_reg++, 0x53);\n\tstv0900_write_reg(intp, vth_reg++, 0x2f);\n\tstv0900_write_reg(intp, vth_reg++, 0x24);\n\tstv0900_write_reg(intp, vth_reg++, 0x1f);\n}\n\nstatic void stv0900_set_viterbi_standard(struct stv0900_internal *intp,\n\t\t\t\t   enum fe_stv0900_search_standard standard,\n\t\t\t\t   enum fe_stv0900_fec fec,\n\t\t\t\t   enum fe_stv0900_demod_num demod)\n{\n\tdprintk(\"%s: ViterbiStandard = \", __func__);\n\n\tswitch (standard) {\n\tcase STV0900_AUTO_SEARCH:\n\t\tdprintk(\"Auto\\n\");\n\t\tstv0900_write_reg(intp, FECM, 0x10);\n\t\tstv0900_write_reg(intp, PRVIT, 0x3f);\n\t\tbreak;\n\tcase STV0900_SEARCH_DVBS1:\n\t\tdprintk(\"DVBS1\\n\");\n\t\tstv0900_write_reg(intp, FECM, 0x00);\n\t\tswitch (fec) {\n\t\tcase STV0900_FEC_UNKNOWN:\n\t\tdefault:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x2f);\n\t\t\tbreak;\n\t\tcase STV0900_FEC_1_2:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x01);\n\t\t\tbreak;\n\t\tcase STV0900_FEC_2_3:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x02);\n\t\t\tbreak;\n\t\tcase STV0900_FEC_3_4:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x04);\n\t\t\tbreak;\n\t\tcase STV0900_FEC_5_6:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x08);\n\t\t\tbreak;\n\t\tcase STV0900_FEC_7_8:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x20);\n\t\t\tbreak;\n\t\t}\n\n\t\tbreak;\n\tcase STV0900_SEARCH_DSS:\n\t\tdprintk(\"DSS\\n\");\n\t\tstv0900_write_reg(intp, FECM, 0x80);\n\t\tswitch (fec) {\n\t\tcase STV0900_FEC_UNKNOWN:\n\t\tdefault:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x13);\n\t\t\tbreak;\n\t\tcase STV0900_FEC_1_2:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x01);\n\t\t\tbreak;\n\t\tcase STV0900_FEC_2_3:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x02);\n\t\t\tbreak;\n\t\tcase STV0900_FEC_6_7:\n\t\t\tstv0900_write_reg(intp, PRVIT, 0x10);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic enum fe_stv0900_fec stv0900_get_vit_fec(struct stv0900_internal *intp,\n\t\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\tenum fe_stv0900_fec prate;\n\ts32 rate_fld = stv0900_get_bits(intp, VIT_CURPUN);\n\n\tswitch (rate_fld) {\n\tcase 13:\n\t\tprate = STV0900_FEC_1_2;\n\t\tbreak;\n\tcase 18:\n\t\tprate = STV0900_FEC_2_3;\n\t\tbreak;\n\tcase 21:\n\t\tprate = STV0900_FEC_3_4;\n\t\tbreak;\n\tcase 24:\n\t\tprate = STV0900_FEC_5_6;\n\t\tbreak;\n\tcase 25:\n\t\tprate = STV0900_FEC_6_7;\n\t\tbreak;\n\tcase 26:\n\t\tprate = STV0900_FEC_7_8;\n\t\tbreak;\n\tdefault:\n\t\tprate = STV0900_FEC_UNKNOWN;\n\t\tbreak;\n\t}\n\n\treturn prate;\n}\n\nstatic void stv0900_set_dvbs1_track_car_loop(struct stv0900_internal *intp,\n\t\t\t\t\tenum fe_stv0900_demod_num demod,\n\t\t\t\t\tu32 srate)\n{\n\tif (intp->chip_id >= 0x30) {\n\t\tif (srate >= 15000000) {\n\t\t\tstv0900_write_reg(intp, ACLC, 0x2b);\n\t\t\tstv0900_write_reg(intp, BCLC, 0x1a);\n\t\t} else if ((srate >= 7000000) && (15000000 > srate)) {\n\t\t\tstv0900_write_reg(intp, ACLC, 0x0c);\n\t\t\tstv0900_write_reg(intp, BCLC, 0x1b);\n\t\t} else if (srate < 7000000) {\n\t\t\tstv0900_write_reg(intp, ACLC, 0x2c);\n\t\t\tstv0900_write_reg(intp, BCLC, 0x1c);\n\t\t}\n\n\t} else {  \n\t\tstv0900_write_reg(intp, ACLC, 0x1a);\n\t\tstv0900_write_reg(intp, BCLC, 0x09);\n\t}\n\n}\n\nstatic void stv0900_track_optimization(struct dvb_frontend *fe)\n{\n\tstruct stv0900_state *state = fe->demodulator_priv;\n\tstruct stv0900_internal *intp = state->internal;\n\tenum fe_stv0900_demod_num demod = state->demod;\n\n\ts32\tsrate,\n\t\tpilots,\n\t\taclc,\n\t\tfreq1,\n\t\tfreq0,\n\t\ti = 0,\n\t\ttimed,\n\t\ttimef,\n\t\tblind_tun_sw = 0,\n\t\tmodulation;\n\n\tenum fe_stv0900_modcode foundModcod;\n\n\tdprintk(\"%s\\n\", __func__);\n\n\tsrate = stv0900_get_symbol_rate(intp, intp->mclk, demod);\n\tsrate += stv0900_get_timing_offst(intp, srate, demod);\n\n\tswitch (intp->result[demod].standard) {\n\tcase STV0900_DVBS1_STANDARD:\n\tcase STV0900_DSS_STANDARD:\n\t\tdprintk(\"%s: found DVB-S or DSS\\n\", __func__);\n\t\tif (intp->srch_standard[demod] == STV0900_AUTO_SEARCH) {\n\t\t\tstv0900_write_bits(intp, DVBS1_ENABLE, 1);\n\t\t\tstv0900_write_bits(intp, DVBS2_ENABLE, 0);\n\t\t}\n\n\t\tstv0900_write_bits(intp, ROLLOFF_CONTROL, intp->rolloff);\n\t\tstv0900_write_bits(intp, MANUALSX_ROLLOFF, 1);\n\n\t\tif (intp->chip_id < 0x30) {\n\t\t\tstv0900_write_reg(intp, ERRCTRL1, 0x75);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (stv0900_get_vit_fec(intp, demod) == STV0900_FEC_1_2) {\n\t\t\tstv0900_write_reg(intp, GAUSSR0, 0x98);\n\t\t\tstv0900_write_reg(intp, CCIR0, 0x18);\n\t\t} else {\n\t\t\tstv0900_write_reg(intp, GAUSSR0, 0x18);\n\t\t\tstv0900_write_reg(intp, CCIR0, 0x18);\n\t\t}\n\n\t\tstv0900_write_reg(intp, ERRCTRL1, 0x75);\n\t\tbreak;\n\tcase STV0900_DVBS2_STANDARD:\n\t\tdprintk(\"%s: found DVB-S2\\n\", __func__);\n\t\tstv0900_write_bits(intp, DVBS1_ENABLE, 0);\n\t\tstv0900_write_bits(intp, DVBS2_ENABLE, 1);\n\t\tstv0900_write_reg(intp, ACLC, 0);\n\t\tstv0900_write_reg(intp, BCLC, 0);\n\t\tif (intp->result[demod].frame_len == STV0900_LONG_FRAME) {\n\t\t\tfoundModcod = stv0900_get_bits(intp, DEMOD_MODCOD);\n\t\t\tpilots = stv0900_get_bits(intp, DEMOD_TYPE) & 0x01;\n\t\t\taclc = stv0900_get_optim_carr_loop(srate,\n\t\t\t\t\t\t\tfoundModcod,\n\t\t\t\t\t\t\tpilots,\n\t\t\t\t\t\t\tintp->chip_id);\n\t\t\tif (foundModcod <= STV0900_QPSK_910)\n\t\t\t\tstv0900_write_reg(intp, ACLC2S2Q, aclc);\n\t\t\telse if (foundModcod <= STV0900_8PSK_910) {\n\t\t\t\tstv0900_write_reg(intp, ACLC2S2Q, 0x2a);\n\t\t\t\tstv0900_write_reg(intp, ACLC2S28, aclc);\n\t\t\t}\n\n\t\t\tif ((intp->demod_mode == STV0900_SINGLE) &&\n\t\t\t\t\t(foundModcod > STV0900_8PSK_910)) {\n\t\t\t\tif (foundModcod <= STV0900_16APSK_910) {\n\t\t\t\t\tstv0900_write_reg(intp, ACLC2S2Q, 0x2a);\n\t\t\t\t\tstv0900_write_reg(intp, ACLC2S216A,\n\t\t\t\t\t\t\t\t\taclc);\n\t\t\t\t} else if (foundModcod <= STV0900_32APSK_910) {\n\t\t\t\t\tstv0900_write_reg(intp, ACLC2S2Q, 0x2a);\n\t\t\t\t\tstv0900_write_reg(intp,\tACLC2S232A,\n\t\t\t\t\t\t\t\t\taclc);\n\t\t\t\t}\n\t\t\t}\n\n\t\t} else {\n\t\t\tmodulation = intp->result[demod].modulation;\n\t\t\taclc = stv0900_get_optim_short_carr_loop(srate,\n\t\t\t\t\tmodulation, intp->chip_id);\n\t\t\tif (modulation == STV0900_QPSK)\n\t\t\t\tstv0900_write_reg(intp, ACLC2S2Q, aclc);\n\t\t\telse if (modulation == STV0900_8PSK) {\n\t\t\t\tstv0900_write_reg(intp, ACLC2S2Q, 0x2a);\n\t\t\t\tstv0900_write_reg(intp, ACLC2S28, aclc);\n\t\t\t} else if (modulation == STV0900_16APSK) {\n\t\t\t\tstv0900_write_reg(intp, ACLC2S2Q, 0x2a);\n\t\t\t\tstv0900_write_reg(intp, ACLC2S216A, aclc);\n\t\t\t} else if (modulation == STV0900_32APSK) {\n\t\t\t\tstv0900_write_reg(intp, ACLC2S2Q, 0x2a);\n\t\t\t\tstv0900_write_reg(intp, ACLC2S232A, aclc);\n\t\t\t}\n\n\t\t}\n\n\t\tif (intp->chip_id <= 0x11) {\n\t\t\tif (intp->demod_mode != STV0900_SINGLE)\n\t\t\t\tstv0900_activate_s2_modcod(intp, demod);\n\n\t\t}\n\n\t\tstv0900_write_reg(intp, ERRCTRL1, 0x67);\n\t\tbreak;\n\tcase STV0900_UNKNOWN_STANDARD:\n\tdefault:\n\t\tdprintk(\"%s: found unknown standard\\n\", __func__);\n\t\tstv0900_write_bits(intp, DVBS1_ENABLE, 1);\n\t\tstv0900_write_bits(intp, DVBS2_ENABLE, 1);\n\t\tbreak;\n\t}\n\n\tfreq1 = stv0900_read_reg(intp, CFR2);\n\tfreq0 = stv0900_read_reg(intp, CFR1);\n\tif (intp->srch_algo[demod] == STV0900_BLIND_SEARCH) {\n\t\tstv0900_write_reg(intp, SFRSTEP, 0x00);\n\t\tstv0900_write_bits(intp, SCAN_ENABLE, 0);\n\t\tstv0900_write_bits(intp, CFR_AUTOSCAN, 0);\n\t\tstv0900_write_reg(intp, TMGCFG2, 0xc1);\n\t\tstv0900_set_symbol_rate(intp, intp->mclk, srate, demod);\n\t\tblind_tun_sw = 1;\n\t\tif (intp->result[demod].standard != STV0900_DVBS2_STANDARD)\n\t\t\tstv0900_set_dvbs1_track_car_loop(intp, demod, srate);\n\n\t}\n\n\tif (intp->chip_id >= 0x20) {\n\t\tif ((intp->srch_standard[demod] == STV0900_SEARCH_DVBS1) ||\n\t\t\t\t(intp->srch_standard[demod] ==\n\t\t\t\t\t\t\tSTV0900_SEARCH_DSS) ||\n\t\t\t\t(intp->srch_standard[demod] ==\n\t\t\t\t\t\t\tSTV0900_AUTO_SEARCH)) {\n\t\t\tstv0900_write_reg(intp, VAVSRVIT, 0x0a);\n\t\t\tstv0900_write_reg(intp, VITSCALE, 0x0);\n\t\t}\n\t}\n\n\tif (intp->chip_id < 0x20)\n\t\tstv0900_write_reg(intp, CARHDR, 0x08);\n\n\tif (intp->chip_id == 0x10)\n\t\tstv0900_write_reg(intp, CORRELEXP, 0x0a);\n\n\tstv0900_write_reg(intp, AGC2REF, 0x38);\n\n\tif ((intp->chip_id >= 0x20) ||\n\t\t\t(blind_tun_sw == 1) ||\n\t\t\t(intp->symbol_rate[demod] < 10000000)) {\n\t\tstv0900_write_reg(intp, CFRINIT1, freq1);\n\t\tstv0900_write_reg(intp, CFRINIT0, freq0);\n\t\tintp->bw[demod] = stv0900_carrier_width(srate,\n\t\t\t\t\tintp->rolloff) + 10000000;\n\n\t\tif ((intp->chip_id >= 0x20) || (blind_tun_sw == 1)) {\n\t\t\tif (intp->srch_algo[demod] != STV0900_WARM_START) {\n\t\t\t\tif (intp->tuner_type[demod] == 3)\n\t\t\t\t\tstv0900_set_tuner_auto(intp,\n\t\t\t\t\t\t\tintp->freq[demod],\n\t\t\t\t\t\t\tintp->bw[demod],\n\t\t\t\t\t\t\tdemod);\n\t\t\t\telse\n\t\t\t\t\tstv0900_set_bandwidth(fe,\n\t\t\t\t\t\t\tintp->bw[demod]);\n\t\t\t}\n\t\t}\n\n\t\tif ((intp->srch_algo[demod] == STV0900_BLIND_SEARCH) ||\n\t\t\t\t(intp->symbol_rate[demod] < 10000000))\n\t\t\tmsleep(50);\n\t\telse\n\t\t\tmsleep(5);\n\n\t\tstv0900_get_lock_timeout(&timed, &timef, srate,\n\t\t\t\t\t\tSTV0900_WARM_START);\n\n\t\tif (stv0900_get_demod_lock(intp, demod, timed / 2) == FALSE) {\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x1f);\n\t\t\tstv0900_write_reg(intp, CFRINIT1, freq1);\n\t\t\tstv0900_write_reg(intp, CFRINIT0, freq0);\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x18);\n\t\t\ti = 0;\n\t\t\twhile ((stv0900_get_demod_lock(intp,\n\t\t\t\t\t\t\tdemod,\n\t\t\t\t\t\t\ttimed / 2) == FALSE) &&\n\t\t\t\t\t\t(i <= 2)) {\n\t\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x1f);\n\t\t\t\tstv0900_write_reg(intp, CFRINIT1, freq1);\n\t\t\t\tstv0900_write_reg(intp, CFRINIT0, freq0);\n\t\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x18);\n\t\t\t\ti++;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tif (intp->chip_id >= 0x20)\n\t\tstv0900_write_reg(intp, CARFREQ, 0x49);\n\n\tif ((intp->result[demod].standard == STV0900_DVBS1_STANDARD) ||\n\t\t\t(intp->result[demod].standard == STV0900_DSS_STANDARD))\n\t\tstv0900_set_viterbi_tracq(intp, demod);\n\n}\n\nstatic int stv0900_get_fec_lock(struct stv0900_internal *intp,\n\t\t\t\tenum fe_stv0900_demod_num demod, s32 time_out)\n{\n\ts32 timer = 0, lock = 0;\n\n\tenum fe_stv0900_search_state dmd_state;\n\n\tdprintk(\"%s\\n\", __func__);\n\n\tdmd_state = stv0900_get_bits(intp, HEADER_MODE);\n\n\twhile ((timer < time_out) && (lock == 0)) {\n\t\tswitch (dmd_state) {\n\t\tcase STV0900_SEARCH:\n\t\tcase STV0900_PLH_DETECTED:\n\t\tdefault:\n\t\t\tlock = 0;\n\t\t\tbreak;\n\t\tcase STV0900_DVBS2_FOUND:\n\t\t\tlock = stv0900_get_bits(intp, PKTDELIN_LOCK);\n\t\t\tbreak;\n\t\tcase STV0900_DVBS_FOUND:\n\t\t\tlock = stv0900_get_bits(intp, LOCKEDVIT);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (lock == 0) {\n\t\t\tmsleep(10);\n\t\t\ttimer += 10;\n\t\t}\n\t}\n\n\tif (lock)\n\t\tdprintk(\"%s: DEMOD FEC LOCK OK\\n\", __func__);\n\telse\n\t\tdprintk(\"%s: DEMOD FEC LOCK FAIL\\n\", __func__);\n\n\treturn lock;\n}\n\nstatic int stv0900_wait_for_lock(struct stv0900_internal *intp,\n\t\t\t\tenum fe_stv0900_demod_num demod,\n\t\t\t\ts32 dmd_timeout, s32 fec_timeout)\n{\n\n\ts32 timer = 0, lock = 0;\n\n\tdprintk(\"%s\\n\", __func__);\n\n\tlock = stv0900_get_demod_lock(intp, demod, dmd_timeout);\n\n\tif (lock)\n\t\tlock = stv0900_get_fec_lock(intp, demod, fec_timeout);\n\n\tif (lock) {\n\t\tlock = 0;\n\n\t\tdprintk(\"%s: Timer = %d, time_out = %d\\n\",\n\t\t\t\t__func__, timer, fec_timeout);\n\n\t\twhile ((timer < fec_timeout) && (lock == 0)) {\n\t\t\tlock = stv0900_get_bits(intp, TSFIFO_LINEOK);\n\t\t\tmsleep(1);\n\t\t\ttimer++;\n\t\t}\n\t}\n\n\tif (lock)\n\t\tdprintk(\"%s: DEMOD LOCK OK\\n\", __func__);\n\telse\n\t\tdprintk(\"%s: DEMOD LOCK FAIL\\n\", __func__);\n\n\tif (lock)\n\t\treturn TRUE;\n\telse\n\t\treturn FALSE;\n}\n\nenum fe_stv0900_tracking_standard stv0900_get_standard(struct dvb_frontend *fe,\n\t\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\tstruct stv0900_state *state = fe->demodulator_priv;\n\tstruct stv0900_internal *intp = state->internal;\n\tenum fe_stv0900_tracking_standard fnd_standard;\n\n\tint hdr_mode = stv0900_get_bits(intp, HEADER_MODE);\n\n\tswitch (hdr_mode) {\n\tcase 2:\n\t\tfnd_standard = STV0900_DVBS2_STANDARD;\n\t\tbreak;\n\tcase 3:\n\t\tif (stv0900_get_bits(intp, DSS_DVB) == 1)\n\t\t\tfnd_standard = STV0900_DSS_STANDARD;\n\t\telse\n\t\t\tfnd_standard = STV0900_DVBS1_STANDARD;\n\n\t\tbreak;\n\tdefault:\n\t\tfnd_standard = STV0900_UNKNOWN_STANDARD;\n\t}\n\n\tdprintk(\"%s: standard %d\\n\", __func__, fnd_standard);\n\n\treturn fnd_standard;\n}\n\nstatic s32 stv0900_get_carr_freq(struct stv0900_internal *intp, u32 mclk,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\ts32\tderot,\n\t\trem1,\n\t\trem2,\n\t\tintval1,\n\t\tintval2;\n\n\tderot = (stv0900_get_bits(intp, CAR_FREQ2) << 16) +\n\t\t(stv0900_get_bits(intp, CAR_FREQ1) << 8) +\n\t\t(stv0900_get_bits(intp, CAR_FREQ0));\n\n\tderot = ge2comp(derot, 24);\n\tintval1 = mclk >> 12;\n\tintval2 = derot >> 12;\n\trem1 = mclk % 0x1000;\n\trem2 = derot % 0x1000;\n\tderot = (intval1 * intval2) +\n\t\t((intval1 * rem2) >> 12) +\n\t\t((intval2 * rem1) >> 12);\n\n\treturn derot;\n}\n\nstatic u32 stv0900_get_tuner_freq(struct dvb_frontend *fe)\n{\n\tstruct dvb_frontend_ops\t*frontend_ops = NULL;\n\tstruct dvb_tuner_ops *tuner_ops = NULL;\n\tu32 freq = 0;\n\n\tfrontend_ops = &fe->ops;\n\ttuner_ops = &frontend_ops->tuner_ops;\n\n\tif (tuner_ops->get_frequency) {\n\t\tif ((tuner_ops->get_frequency(fe, &freq)) < 0)\n\t\t\tdprintk(\"%s: Invalid parameter\\n\", __func__);\n\t\telse\n\t\t\tdprintk(\"%s: Frequency=%d\\n\", __func__, freq);\n\n\t}\n\n\treturn freq;\n}\n\nstatic enum\nfe_stv0900_signal_type stv0900_get_signal_params(struct dvb_frontend *fe)\n{\n\tstruct stv0900_state *state = fe->demodulator_priv;\n\tstruct stv0900_internal *intp = state->internal;\n\tenum fe_stv0900_demod_num demod = state->demod;\n\tenum fe_stv0900_signal_type range = STV0900_OUTOFRANGE;\n\tstruct stv0900_signal_info *result = &intp->result[demod];\n\ts32\toffsetFreq,\n\t\tsrate_offset;\n\tint\ti = 0,\n\t\td = demod;\n\n\tu8 timing;\n\n\tmsleep(5);\n\tif (intp->srch_algo[d] == STV0900_BLIND_SEARCH) {\n\t\ttiming = stv0900_read_reg(intp, TMGREG2);\n\t\ti = 0;\n\t\tstv0900_write_reg(intp, SFRSTEP, 0x5c);\n\n\t\twhile ((i <= 50) && (timing != 0) && (timing != 0xff)) {\n\t\t\ttiming = stv0900_read_reg(intp, TMGREG2);\n\t\t\tmsleep(5);\n\t\t\ti += 5;\n\t\t}\n\t}\n\n\tresult->standard = stv0900_get_standard(fe, d);\n\tif (intp->tuner_type[demod] == 3)\n\t\tresult->frequency = stv0900_get_freq_auto(intp, d);\n\telse\n\t\tresult->frequency = stv0900_get_tuner_freq(fe);\n\n\toffsetFreq = stv0900_get_carr_freq(intp, intp->mclk, d) / 1000;\n\tresult->frequency += offsetFreq;\n\tresult->symbol_rate = stv0900_get_symbol_rate(intp, intp->mclk, d);\n\tsrate_offset = stv0900_get_timing_offst(intp, result->symbol_rate, d);\n\tresult->symbol_rate += srate_offset;\n\tresult->fec = stv0900_get_vit_fec(intp, d);\n\tresult->modcode = stv0900_get_bits(intp, DEMOD_MODCOD);\n\tresult->pilot = stv0900_get_bits(intp, DEMOD_TYPE) & 0x01;\n\tresult->frame_len = ((u32)stv0900_get_bits(intp, DEMOD_TYPE)) >> 1;\n\tresult->rolloff = stv0900_get_bits(intp, ROLLOFF_STATUS);\n\n\tdprintk(\"%s: modcode=0x%x \\n\", __func__, result->modcode);\n\n\tswitch (result->standard) {\n\tcase STV0900_DVBS2_STANDARD:\n\t\tresult->spectrum = stv0900_get_bits(intp, SPECINV_DEMOD);\n\t\tif (result->modcode <= STV0900_QPSK_910)\n\t\t\tresult->modulation = STV0900_QPSK;\n\t\telse if (result->modcode <= STV0900_8PSK_910)\n\t\t\tresult->modulation = STV0900_8PSK;\n\t\telse if (result->modcode <= STV0900_16APSK_910)\n\t\t\tresult->modulation = STV0900_16APSK;\n\t\telse if (result->modcode <= STV0900_32APSK_910)\n\t\t\tresult->modulation = STV0900_32APSK;\n\t\telse\n\t\t\tresult->modulation = STV0900_UNKNOWN;\n\t\tbreak;\n\tcase STV0900_DVBS1_STANDARD:\n\tcase STV0900_DSS_STANDARD:\n\t\tresult->spectrum = stv0900_get_bits(intp, IQINV);\n\t\tresult->modulation = STV0900_QPSK;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif ((intp->srch_algo[d] == STV0900_BLIND_SEARCH) ||\n\t\t\t\t(intp->symbol_rate[d] < 10000000)) {\n\t\toffsetFreq = result->frequency - intp->freq[d];\n\t\tif (intp->tuner_type[demod] == 3)\n\t\t\tintp->freq[d] = stv0900_get_freq_auto(intp, d);\n\t\telse\n\t\t\tintp->freq[d] = stv0900_get_tuner_freq(fe);\n\n\t\tif (abs(offsetFreq) <= ((intp->srch_range[d] / 2000) + 500))\n\t\t\trange = STV0900_RANGEOK;\n\t\telse if (abs(offsetFreq) <=\n\t\t\t\t(stv0900_carrier_width(result->symbol_rate,\n\t\t\t\t\t\tresult->rolloff) / 2000))\n\t\t\trange = STV0900_RANGEOK;\n\n\t} else if (abs(offsetFreq) <= ((intp->srch_range[d] / 2000) + 500))\n\t\trange = STV0900_RANGEOK;\n\n\tdprintk(\"%s: range %d\\n\", __func__, range);\n\n\treturn range;\n}\n\nstatic enum\nfe_stv0900_signal_type stv0900_dvbs1_acq_workaround(struct dvb_frontend *fe)\n{\n\tstruct stv0900_state *state = fe->demodulator_priv;\n\tstruct stv0900_internal *intp = state->internal;\n\tenum fe_stv0900_demod_num demod = state->demod;\n\tenum fe_stv0900_signal_type signal_type = STV0900_NODATA;\n\n\ts32\tsrate,\n\t\tdemod_timeout,\n\t\tfec_timeout,\n\t\tfreq1,\n\t\tfreq0;\n\n\tintp->result[demod].locked = FALSE;\n\n\tif (stv0900_get_bits(intp, HEADER_MODE) == STV0900_DVBS_FOUND) {\n\t\tsrate = stv0900_get_symbol_rate(intp, intp->mclk, demod);\n\t\tsrate += stv0900_get_timing_offst(intp, srate, demod);\n\t\tif (intp->srch_algo[demod] == STV0900_BLIND_SEARCH)\n\t\t\tstv0900_set_symbol_rate(intp, intp->mclk, srate, demod);\n\n\t\tstv0900_get_lock_timeout(&demod_timeout, &fec_timeout,\n\t\t\t\t\tsrate, STV0900_WARM_START);\n\t\tfreq1 = stv0900_read_reg(intp, CFR2);\n\t\tfreq0 = stv0900_read_reg(intp, CFR1);\n\t\tstv0900_write_bits(intp, CFR_AUTOSCAN, 0);\n\t\tstv0900_write_bits(intp, SPECINV_CONTROL,\n\t\t\t\t\tSTV0900_IQ_FORCE_SWAPPED);\n\t\tstv0900_write_reg(intp, DMDISTATE, 0x1c);\n\t\tstv0900_write_reg(intp, CFRINIT1, freq1);\n\t\tstv0900_write_reg(intp, CFRINIT0, freq0);\n\t\tstv0900_write_reg(intp, DMDISTATE, 0x18);\n\t\tif (stv0900_wait_for_lock(intp, demod,\n\t\t\t\tdemod_timeout, fec_timeout) == TRUE) {\n\t\t\tintp->result[demod].locked = TRUE;\n\t\t\tsignal_type = stv0900_get_signal_params(fe);\n\t\t\tstv0900_track_optimization(fe);\n\t\t} else {\n\t\t\tstv0900_write_bits(intp, SPECINV_CONTROL,\n\t\t\t\t\tSTV0900_IQ_FORCE_NORMAL);\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x1c);\n\t\t\tstv0900_write_reg(intp, CFRINIT1, freq1);\n\t\t\tstv0900_write_reg(intp, CFRINIT0, freq0);\n\t\t\tstv0900_write_reg(intp, DMDISTATE, 0x18);\n\t\t\tif (stv0900_wait_for_lock(intp, demod,\n\t\t\t\t\tdemod_timeout, fec_timeout) == TRUE) {\n\t\t\t\tintp->result[demod].locked = TRUE;\n\t\t\t\tsignal_type = stv0900_get_signal_params(fe);\n\t\t\t\tstv0900_track_optimization(fe);\n\t\t\t}\n\n\t\t}\n\n\t} else\n\t\tintp->result[demod].locked = FALSE;\n\n\treturn signal_type;\n}\n\nstatic u16 stv0900_blind_check_agc2_min_level(struct stv0900_internal *intp,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\tu32 minagc2level = 0xffff,\n\t\tagc2level,\n\t\tinit_freq, freq_step;\n\n\ts32 i, j, nb_steps, direction;\n\n\tdprintk(\"%s\\n\", __func__);\n\n\tstv0900_write_reg(intp, AGC2REF, 0x38);\n\tstv0900_write_bits(intp, SCAN_ENABLE, 0);\n\tstv0900_write_bits(intp, CFR_AUTOSCAN, 0);\n\n\tstv0900_write_bits(intp, AUTO_GUP, 1);\n\tstv0900_write_bits(intp, AUTO_GLOW, 1);\n\n\tstv0900_write_reg(intp, DMDT0M, 0x0);\n\n\tstv0900_set_symbol_rate(intp, intp->mclk, 1000000, demod);\n\tnb_steps = -1 + (intp->srch_range[demod] / 1000000);\n\tnb_steps /= 2;\n\tnb_steps = (2 * nb_steps) + 1;\n\n\tif (nb_steps < 0)\n\t\tnb_steps = 1;\n\n\tdirection = 1;\n\n\tfreq_step = (1000000 << 8) / (intp->mclk >> 8);\n\n\tinit_freq = 0;\n\n\tfor (i = 0; i < nb_steps; i++) {\n\t\tif (direction > 0)\n\t\t\tinit_freq = init_freq + (freq_step * i);\n\t\telse\n\t\t\tinit_freq = init_freq - (freq_step * i);\n\n\t\tdirection *= -1;\n\t\tstv0900_write_reg(intp, DMDISTATE, 0x5C);\n\t\tstv0900_write_reg(intp, CFRINIT1, (init_freq >> 8) & 0xff);\n\t\tstv0900_write_reg(intp, CFRINIT0, init_freq  & 0xff);\n\t\tstv0900_write_reg(intp, DMDISTATE, 0x58);\n\t\tmsleep(10);\n\t\tagc2level = 0;\n\n\t\tfor (j = 0; j < 10; j++)\n\t\t\tagc2level += (stv0900_read_reg(intp, AGC2I1) << 8)\n\t\t\t\t\t| stv0900_read_reg(intp, AGC2I0);\n\n\t\tagc2level /= 10;\n\n\t\tif (agc2level < minagc2level)\n\t\t\tminagc2level = agc2level;\n\n\t}\n\n\treturn (u16)minagc2level;\n}\n\nstatic u32 stv0900_search_srate_coarse(struct dvb_frontend *fe)\n{\n\tstruct stv0900_state *state = fe->demodulator_priv;\n\tstruct stv0900_internal *intp = state->internal;\n\tenum fe_stv0900_demod_num demod = state->demod;\n\tint timing_lck = FALSE;\n\ts32 i, timingcpt = 0,\n\t\tdirection = 1,\n\t\tnb_steps,\n\t\tcurrent_step = 0,\n\t\ttuner_freq;\n\tu32 agc2_th,\n\t\tcoarse_srate = 0,\n\t\tagc2_integr = 0,\n\t\tcurrier_step = 1200;\n\n\tif (intp->chip_id >= 0x30)\n\t\tagc2_th = 0x2e00;\n\telse\n\t\tagc2_th = 0x1f00;\n\n\tstv0900_write_bits(intp, DEMOD_MODE, 0x1f);\n\tstv0900_write_reg(intp, TMGCFG, 0x12);\n\tstv0900_write_reg(intp, TMGTHRISE, 0xf0);\n\tstv0900_write_reg(intp, TMGTHFALL, 0xe0);\n\tstv0900_write_bits(intp, SCAN_ENABLE, 1);\n\tstv0900_write_bits(intp, CFR_AUTOSCAN, 1);\n\tstv0900_write_reg(intp, SFRUP1, 0x83);\n\tstv0900_write_reg(intp, SFRUP0, 0xc0);\n\tstv0900_write_reg(intp, SFRLOW1, 0x82);\n\tstv0900_write_reg(intp, SFRLOW0, 0xa0);\n\tstv0900_write_reg(intp, DMDT0M, 0x0);\n\tstv0900_write_reg(intp, AGC2REF, 0x50);\n\n\tif (intp->chip_id >= 0x30) {\n\t\tstv0900_write_reg(intp, CARFREQ, 0x99);\n\t\tstv0900_write_reg(intp, SFRSTEP, 0x98);\n\t} else if (intp->chip_id >= 0x20) {\n\t\tstv0900_write_reg(intp, CARFREQ, 0x6a);\n\t\tstv0900_write_reg(intp, SFRSTEP, 0x95);\n\t} else {\n\t\tstv0900_write_reg(intp, CARFREQ, 0xed);\n\t\tstv0900_write_reg(intp, SFRSTEP, 0x73);\n\t}\n\n\tif (intp->symbol_rate[demod] <= 2000000)\n\t\tcurrier_step = 1000;\n\telse if (intp->symbol_rate[demod] <= 5000000)\n\t\tcurrier_step = 2000;\n\telse if (intp->symbol_rate[demod] <= 12000000)\n\t\tcurrier_step = 3000;\n\telse\n\t\t\tcurrier_step = 5000;\n\n\tnb_steps = -1 + ((intp->srch_range[demod] / 1000) / currier_step);\n\tnb_steps /= 2;\n\tnb_steps = (2 * nb_steps) + 1;\n\n\tif (nb_steps < 0)\n\t\tnb_steps = 1;\n\telse if (nb_steps > 10) {\n\t\tnb_steps = 11;\n\t\tcurrier_step = (intp->srch_range[demod] / 1000) / 10;\n\t}\n\n\tcurrent_step = 0;\n\tdirection = 1;\n\n\ttuner_freq = intp->freq[demod];\n\n\twhile ((timing_lck == FALSE) && (current_step < nb_steps)) {\n\t\tstv0900_write_reg(intp, DMDISTATE, 0x5f);\n\t\tstv0900_write_bits(intp, DEMOD_MODE, 0);\n\n\t\tmsleep(50);\n\n\t\tfor (i = 0; i < 10; i++) {\n\t\t\tif (stv0900_get_bits(intp, TMGLOCK_QUALITY) >= 2)\n\t\t\t\ttimingcpt++;\n\n\t\t\tagc2_integr += (stv0900_read_reg(intp, AGC2I1) << 8) |\n\t\t\t\t\tstv0900_read_reg(intp, AGC2I0);\n\t\t}\n\n\t\tagc2_integr /= 10;\n\t\tcoarse_srate = stv0900_get_symbol_rate(intp, intp->mclk, demod);\n\t\tcurrent_step++;\n\t\tdirection *= -1;\n\n\t\tdprintk(\"lock: I2C_DEMOD_MODE_FIELD =0. Search started. tuner freq=%d agc2=0x%x srate_coarse=%d tmg_cpt=%d\\n\",\n\t\t\ttuner_freq, agc2_integr, coarse_srate, timingcpt);\n\n\t\tif ((timingcpt >= 5) &&\n\t\t\t\t(agc2_integr < agc2_th) &&\n\t\t\t\t(coarse_srate < 55000000) &&\n\t\t\t\t(coarse_srate > 850000))\n\t\t\ttiming_lck = TRUE;\n\t\telse if (current_step < nb_steps) {\n\t\t\tif (direction > 0)\n\t\t\t\ttuner_freq += (current_step * currier_step);\n\t\t\telse\n\t\t\t\ttuner_freq -= (current_step * currier_step);\n\n\t\t\tif (intp->tuner_type[demod] == 3)\n\t\t\t\tstv0900_set_tuner_auto(intp, tuner_freq,\n\t\t\t\t\t\tintp->bw[demod], demod);\n\t\t\telse\n\t\t\t\tstv0900_set_tuner(fe, tuner_freq,\n\t\t\t\t\t\tintp->bw[demod]);\n\t\t}\n\t}\n\n\tif (timing_lck == FALSE)\n\t\tcoarse_srate = 0;\n\telse\n\t\tcoarse_srate = stv0900_get_symbol_rate(intp, intp->mclk, demod);\n\n\treturn coarse_srate;\n}\n\nstatic u32 stv0900_search_srate_fine(struct dvb_frontend *fe)\n{\n\tstruct stv0900_state *state = fe->demodulator_priv;\n\tstruct stv0900_internal *intp = state->internal;\n\tenum fe_stv0900_demod_num demod = state->demod;\n\tu32\tcoarse_srate,\n\t\tcoarse_freq,\n\t\tsymb,\n\t\tsymbmax,\n\t\tsymbmin,\n\t\tsymbcomp;\n\n\tcoarse_srate = stv0900_get_symbol_rate(intp, intp->mclk, demod);\n\n\tif (coarse_srate > 3000000) {\n\t\tsymbmax = 13 * (coarse_srate / 10);\n\t\tsymbmax = (symbmax / 1000) * 65536;\n\t\tsymbmax /= (intp->mclk / 1000);\n\n\t\tsymbmin = 10 * (coarse_srate / 13);\n\t\tsymbmin = (symbmin / 1000)*65536;\n\t\tsymbmin /= (intp->mclk / 1000);\n\n\t\tsymb = (coarse_srate / 1000) * 65536;\n\t\tsymb /= (intp->mclk / 1000);\n\t} else {\n\t\tsymbmax = 13 * (coarse_srate / 10);\n\t\tsymbmax = (symbmax / 100) * 65536;\n\t\tsymbmax /= (intp->mclk / 100);\n\n\t\tsymbmin = 10 * (coarse_srate / 14);\n\t\tsymbmin = (symbmin / 100) * 65536;\n\t\tsymbmin /= (intp->mclk / 100);\n\n\t\tsymb = (coarse_srate / 100) * 65536;\n\t\tsymb /= (intp->mclk / 100);\n\t}\n\n\tsymbcomp = 13 * (coarse_srate / 10);\n\tcoarse_freq = (stv0900_read_reg(intp, CFR2) << 8)\n\t\t      | stv0900_read_reg(intp, CFR1);\n\n\tif (symbcomp < intp->symbol_rate[demod])\n\t\tcoarse_srate = 0;\n\telse {\n\t\tstv0900_write_reg(intp, DMDISTATE, 0x1f);\n\t\tstv0900_write_reg(intp, TMGCFG2, 0xc1);\n\t\tstv0900_write_reg(intp, TMGTHRISE, 0x20);\n\t\tstv0900_write_reg(intp, TMGTHFALL, 0x00);\n\t\tstv0900_write_reg(intp, TMGCFG, 0xd2);\n\t\tstv0900_write_bits(intp, CFR_AUTOSCAN, 0);\n\t\tstv0900_write_reg(intp, AGC2REF, 0x38);\n\n\t\tif (intp->chip_id >= 0x30)\n\t\t\tstv0900_write_reg(intp, CARFREQ, 0x79);\n\t\telse if (intp->chip_id >= 0x20)\n\t\t\tstv0900_write_reg(intp, CARFREQ, 0x49);\n\t\telse\n\t\t\tstv0900_write_reg(intp, CARFREQ, 0xed);\n\n\t\tstv0900_write_reg(intp, SFRUP1, (symbmax >> 8) & 0x7f);\n\t\tstv0900_write_reg(intp, SFRUP0, (symbmax & 0xff));\n\n\t\tstv0900_write_reg(intp, SFRLOW1, (symbmin >> 8) & 0x7f);\n\t\tstv0900_write_reg(intp, SFRLOW0, (symbmin & 0xff));\n\n\t\tstv0900_write_reg(intp, SFRINIT1, (symb >> 8) & 0xff);\n\t\tstv0900_write_reg(intp, SFRINIT0, (symb & 0xff));\n\n\t\tstv0900_write_reg(intp, DMDT0M, 0x20);\n\t\tstv0900_write_reg(intp, CFRINIT1, (coarse_freq >> 8) & 0xff);\n\t\tstv0900_write_reg(intp, CFRINIT0, coarse_freq  & 0xff);\n\t\tstv0900_write_reg(intp, DMDISTATE, 0x15);\n\t}\n\n\treturn coarse_srate;\n}\n\nstatic int stv0900_blind_search_algo(struct dvb_frontend *fe)\n{\n\tstruct stv0900_state *state = fe->demodulator_priv;\n\tstruct stv0900_internal *intp = state->internal;\n\tenum fe_stv0900_demod_num demod = state->demod;\n\tu8\tk_ref_tmg,\n\t\tk_ref_tmg_max,\n\t\tk_ref_tmg_min;\n\tu32\tcoarse_srate,\n\t\tagc2_th;\n\tint\tlock = FALSE,\n\t\tcoarse_fail = FALSE;\n\ts32\tdemod_timeout = 500,\n\t\tfec_timeout = 50,\n\t\tfail_cpt,\n\t\ti,\n\t\tagc2_overflow;\n\tu16\tagc2_int;\n\tu8\tdstatus2;\n\n\tdprintk(\"%s\\n\", __func__);\n\n\tif (intp->chip_id < 0x20) {\n\t\tk_ref_tmg_max = 233;\n\t\tk_ref_tmg_min = 143;\n\t} else {\n\t\tk_ref_tmg_max = 110;\n\t\tk_ref_tmg_min = 10;\n\t}\n\n\tif (intp->chip_id <= 0x20)\n\t\tagc2_th = STV0900_BLIND_SEARCH_AGC2_TH;\n\telse\n\t\tagc2_th = STV0900_BLIND_SEARCH_AGC2_TH_CUT30;\n\n\tagc2_int = stv0900_blind_check_agc2_min_level(intp, demod);\n\n\tdprintk(\"%s agc2_int=%d agc2_th=%d \\n\", __func__, agc2_int, agc2_th);\n\tif (agc2_int > agc2_th)\n\t\treturn FALSE;\n\n\tif (intp->chip_id == 0x10)\n\t\tstv0900_write_reg(intp, CORRELEXP, 0xaa);\n\n\tif (intp->chip_id < 0x20)\n\t\tstv0900_write_reg(intp, CARHDR, 0x55);\n\telse\n\t\tstv0900_write_reg(intp, CARHDR, 0x20);\n\n\tif (intp->chip_id <= 0x20)\n\t\tstv0900_write_reg(intp, CARCFG, 0xc4);\n\telse\n\t\tstv0900_write_reg(intp, CARCFG, 0x6);\n\n\tstv0900_write_reg(intp, RTCS2, 0x44);\n\n\tif (intp->chip_id >= 0x20) {\n\t\tstv0900_write_reg(intp, EQUALCFG, 0x41);\n\t\tstv0900_write_reg(intp, FFECFG, 0x41);\n\t\tstv0900_write_reg(intp, VITSCALE, 0x82);\n\t\tstv0900_write_reg(intp, VAVSRVIT, 0x0);\n\t}\n\n\tk_ref_tmg = k_ref_tmg_max;\n\n\tdo {\n\t\tstv0900_write_reg(intp, KREFTMG, k_ref_tmg);\n\t\tif (stv0900_search_srate_coarse(fe) != 0) {\n\t\t\tcoarse_srate = stv0900_search_srate_fine(fe);\n\n\t\t\tif (coarse_srate != 0) {\n\t\t\t\tstv0900_get_lock_timeout(&demod_timeout,\n\t\t\t\t\t\t\t&fec_timeout,\n\t\t\t\t\t\t\tcoarse_srate,\n\t\t\t\t\t\t\tSTV0900_BLIND_SEARCH);\n\t\t\t\tlock = stv0900_get_demod_lock(intp,\n\t\t\t\t\t\t\tdemod,\n\t\t\t\t\t\t\tdemod_timeout);\n\t\t\t} else\n\t\t\t\tlock = FALSE;\n\t\t} else {\n\t\t\tfail_cpt = 0;\n\t\t\tagc2_overflow = 0;\n\n\t\t\tfor (i = 0; i < 10; i++) {\n\t\t\t\tagc2_int = (stv0900_read_reg(intp, AGC2I1) << 8)\n\t\t\t\t\t| stv0900_read_reg(intp, AGC2I0);\n\n\t\t\t\tif (agc2_int >= 0xff00)\n\t\t\t\t\tagc2_overflow++;\n\n\t\t\t\tdstatus2 = stv0900_read_reg(intp, DSTATUS2);\n\n\t\t\t\tif (((dstatus2 & 0x1) == 0x1) &&\n\t\t\t\t\t\t((dstatus2 >> 7) == 1))\n\t\t\t\t\tfail_cpt++;\n\t\t\t}\n\n\t\t\tif ((fail_cpt > 7) || (agc2_overflow > 7))\n\t\t\t\tcoarse_fail = TRUE;\n\n\t\t\tlock = FALSE;\n\t\t}\n\t\tk_ref_tmg -= 30;\n\t} while ((k_ref_tmg >= k_ref_tmg_min) &&\n\t\t\t\t(lock == FALSE) &&\n\t\t\t\t(coarse_fail == FALSE));\n\n\treturn lock;\n}\n\nstatic void stv0900_set_viterbi_acq(struct stv0900_internal *intp,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\ts32 vth_reg = VTH12;\n\n\tdprintk(\"%s\\n\", __func__);\n\n\tstv0900_write_reg(intp, vth_reg++, 0x96);\n\tstv0900_write_reg(intp, vth_reg++, 0x64);\n\tstv0900_write_reg(intp, vth_reg++, 0x36);\n\tstv0900_write_reg(intp, vth_reg++, 0x23);\n\tstv0900_write_reg(intp, vth_reg++, 0x1e);\n\tstv0900_write_reg(intp, vth_reg++, 0x19);\n}\n\nstatic void stv0900_set_search_standard(struct stv0900_internal *intp,\n\t\t\t\t\tenum fe_stv0900_demod_num demod)\n{\n\n\tdprintk(\"%s\\n\", __func__);\n\n\tswitch (intp->srch_standard[demod]) {\n\tcase STV0900_SEARCH_DVBS1:\n\t\tdprintk(\"Search Standard = DVBS1\\n\");\n\t\tbreak;\n\tcase STV0900_SEARCH_DSS:\n\t\tdprintk(\"Search Standard = DSS\\n\");\n\t\tbreak;\n\tcase STV0900_SEARCH_DVBS2:\n\t\tdprintk(\"Search Standard = DVBS2\\n\");\n\t\tbreak;\n\tcase STV0900_AUTO_SEARCH:\n\tdefault:\n\t\tdprintk(\"Search Standard = AUTO\\n\");\n\t\tbreak;\n\t}\n\n\tswitch (intp->srch_standard[demod]) {\n\tcase STV0900_SEARCH_DVBS1:\n\tcase STV0900_SEARCH_DSS:\n\t\tstv0900_write_bits(intp, DVBS1_ENABLE, 1);\n\t\tstv0900_write_bits(intp, DVBS2_ENABLE, 0);\n\t\tstv0900_write_bits(intp, STOP_CLKVIT, 0);\n\t\tstv0900_set_dvbs1_track_car_loop(intp,\n\t\t\t\t\t\tdemod,\n\t\t\t\t\t\tintp->symbol_rate[demod]);\n\t\tstv0900_write_reg(intp, CAR2CFG, 0x22);\n\n\t\tstv0900_set_viterbi_acq(intp, demod);\n\t\tstv0900_set_viterbi_standard(intp,\n\t\t\t\t\tintp->srch_standard[demod],\n\t\t\t\t\tintp->fec[demod], demod);\n\n\t\tbreak;\n\tcase STV0900_SEARCH_DVBS2:\n\t\tstv0900_write_bits(intp, DVBS1_ENABLE, 0);\n\t\tstv0900_write_bits(intp, DVBS2_ENABLE, 1);\n\t\tstv0900_write_bits(intp, STOP_CLKVIT, 1);\n\t\tstv0900_write_reg(intp, ACLC, 0x1a);\n\t\tstv0900_write_reg(intp, BCLC, 0x09);\n\t\tif (intp->chip_id <= 0x20)  \n\t\t\tstv0900_write_reg(intp, CAR2CFG, 0x26);\n\t\telse\n\t\t\tstv0900_write_reg(intp, CAR2CFG, 0x66);\n\n\t\tif (intp->demod_mode != STV0900_SINGLE) {\n\t\t\tif (intp->chip_id <= 0x11)\n\t\t\t\tstv0900_stop_all_s2_modcod(intp, demod);\n\t\t\telse\n\t\t\t\tstv0900_activate_s2_modcod(intp, demod);\n\n\t\t} else\n\t\t\tstv0900_activate_s2_modcod_single(intp, demod);\n\n\t\tstv0900_set_viterbi_tracq(intp, demod);\n\n\t\tbreak;\n\tcase STV0900_AUTO_SEARCH:\n\tdefault:\n\t\tstv0900_write_bits(intp, DVBS1_ENABLE, 1);\n\t\tstv0900_write_bits(intp, DVBS2_ENABLE, 1);\n\t\tstv0900_write_bits(intp, STOP_CLKVIT, 0);\n\t\tstv0900_write_reg(intp, ACLC, 0x1a);\n\t\tstv0900_write_reg(intp, BCLC, 0x09);\n\t\tstv0900_set_dvbs1_track_car_loop(intp,\n\t\t\t\t\t\tdemod,\n\t\t\t\t\t\tintp->symbol_rate[demod]);\n\t\tif (intp->chip_id <= 0x20)  \n\t\t\tstv0900_write_reg(intp, CAR2CFG, 0x26);\n\t\telse\n\t\t\tstv0900_write_reg(intp, CAR2CFG, 0x66);\n\n\t\tif (intp->demod_mode != STV0900_SINGLE) {\n\t\t\tif (intp->chip_id <= 0x11)\n\t\t\t\tstv0900_stop_all_s2_modcod(intp, demod);\n\t\t\telse\n\t\t\t\tstv0900_activate_s2_modcod(intp, demod);\n\n\t\t} else\n\t\t\tstv0900_activate_s2_modcod_single(intp, demod);\n\n\t\tstv0900_set_viterbi_tracq(intp, demod);\n\t\tstv0900_set_viterbi_standard(intp,\n\t\t\t\t\t\tintp->srch_standard[demod],\n\t\t\t\t\t\tintp->fec[demod], demod);\n\n\t\tbreak;\n\t}\n}\n\nenum fe_stv0900_signal_type stv0900_algo(struct dvb_frontend *fe)\n{\n\tstruct stv0900_state *state = fe->demodulator_priv;\n\tstruct stv0900_internal *intp = state->internal;\n\tenum fe_stv0900_demod_num demod = state->demod;\n\n\ts32 demod_timeout = 500, fec_timeout = 50;\n\ts32 aq_power, agc1_power, i;\n\n\tint lock = FALSE, low_sr = FALSE;\n\n\tenum fe_stv0900_signal_type signal_type = STV0900_NOCARRIER;\n\tenum fe_stv0900_search_algo algo;\n\tint no_signal = FALSE;\n\n\tdprintk(\"%s\\n\", __func__);\n\n\talgo = intp->srch_algo[demod];\n\tstv0900_write_bits(intp, RST_HWARE, 1);\n\tstv0900_write_reg(intp, DMDISTATE, 0x5c);\n\tif (intp->chip_id >= 0x20) {\n\t\tif (intp->symbol_rate[demod] > 5000000)\n\t\t\tstv0900_write_reg(intp, CORRELABS, 0x9e);\n\t\telse\n\t\t\tstv0900_write_reg(intp, CORRELABS, 0x82);\n\t} else\n\t\tstv0900_write_reg(intp, CORRELABS, 0x88);\n\n\tstv0900_get_lock_timeout(&demod_timeout, &fec_timeout,\n\t\t\t\tintp->symbol_rate[demod],\n\t\t\t\tintp->srch_algo[demod]);\n\n\tif (intp->srch_algo[demod] == STV0900_BLIND_SEARCH) {\n\t\tintp->bw[demod] = 2 * 36000000;\n\n\t\tstv0900_write_reg(intp, TMGCFG2, 0xc0);\n\t\tstv0900_write_reg(intp, CORRELMANT, 0x70);\n\n\t\tstv0900_set_symbol_rate(intp, intp->mclk, 1000000, demod);\n\t} else {\n\t\tstv0900_write_reg(intp, DMDT0M, 0x20);\n\t\tstv0900_write_reg(intp, TMGCFG, 0xd2);\n\n\t\tif (intp->symbol_rate[demod] < 2000000)\n\t\t\tstv0900_write_reg(intp, CORRELMANT, 0x63);\n\t\telse\n\t\t\tstv0900_write_reg(intp, CORRELMANT, 0x70);\n\n\t\tstv0900_write_reg(intp, AGC2REF, 0x38);\n\n\t\tintp->bw[demod] =\n\t\t\t\tstv0900_carrier_width(intp->symbol_rate[demod],\n\t\t\t\t\t\t\t\tintp->rolloff);\n\t\tif (intp->chip_id >= 0x20) {\n\t\t\tstv0900_write_reg(intp, KREFTMG, 0x5a);\n\n\t\t\tif (intp->srch_algo[demod] == STV0900_COLD_START) {\n\t\t\t\tintp->bw[demod] += 10000000;\n\t\t\t\tintp->bw[demod] *= 15;\n\t\t\t\tintp->bw[demod] /= 10;\n\t\t\t} else if (intp->srch_algo[demod] == STV0900_WARM_START)\n\t\t\t\tintp->bw[demod] += 10000000;\n\n\t\t} else {\n\t\t\tstv0900_write_reg(intp, KREFTMG, 0xc1);\n\t\t\tintp->bw[demod] += 10000000;\n\t\t\tintp->bw[demod] *= 15;\n\t\t\tintp->bw[demod] /= 10;\n\t\t}\n\n\t\tstv0900_write_reg(intp, TMGCFG2, 0xc1);\n\n\t\tstv0900_set_symbol_rate(intp, intp->mclk,\n\t\t\t\t\tintp->symbol_rate[demod], demod);\n\t\tstv0900_set_max_symbol_rate(intp, intp->mclk,\n\t\t\t\t\tintp->symbol_rate[demod], demod);\n\t\tstv0900_set_min_symbol_rate(intp, intp->mclk,\n\t\t\t\t\tintp->symbol_rate[demod], demod);\n\t\tif (intp->symbol_rate[demod] >= 10000000)\n\t\t\tlow_sr = FALSE;\n\t\telse\n\t\t\tlow_sr = TRUE;\n\n\t}\n\n\tif (intp->tuner_type[demod] == 3)\n\t\tstv0900_set_tuner_auto(intp, intp->freq[demod],\n\t\t\t\tintp->bw[demod], demod);\n\telse\n\t\tstv0900_set_tuner(fe, intp->freq[demod], intp->bw[demod]);\n\n\tagc1_power = MAKEWORD(stv0900_get_bits(intp, AGCIQ_VALUE1),\n\t\t\t\tstv0900_get_bits(intp, AGCIQ_VALUE0));\n\n\taq_power = 0;\n\n\tif (agc1_power == 0) {\n\t\tfor (i = 0; i < 5; i++)\n\t\t\taq_power += (stv0900_get_bits(intp, POWER_I) +\n\t\t\t\t\tstv0900_get_bits(intp, POWER_Q)) / 2;\n\n\t\taq_power /= 5;\n\t}\n\n\tif ((agc1_power == 0) && (aq_power < IQPOWER_THRESHOLD)) {\n\t\tintp->result[demod].locked = FALSE;\n\t\tsignal_type = STV0900_NOAGC1;\n\t\tdprintk(\"%s: NO AGC1, POWERI, POWERQ\\n\", __func__);\n\t} else {\n\t\tstv0900_write_bits(intp, SPECINV_CONTROL,\n\t\t\t\t\tintp->srch_iq_inv[demod]);\n\t\tif (intp->chip_id <= 0x20)  \n\t\t\tstv0900_write_bits(intp, MANUALSX_ROLLOFF, 1);\n\t\telse  \n\t\t\tstv0900_write_bits(intp, MANUALS2_ROLLOFF, 1);\n\n\t\tstv0900_set_search_standard(intp, demod);\n\n\t\tif (intp->srch_algo[demod] != STV0900_BLIND_SEARCH)\n\t\t\tstv0900_start_search(intp, demod);\n\t}\n\n\tif (signal_type == STV0900_NOAGC1)\n\t\treturn signal_type;\n\n\tif (intp->chip_id == 0x12) {\n\t\tstv0900_write_bits(intp, RST_HWARE, 0);\n\t\tmsleep(3);\n\t\tstv0900_write_bits(intp, RST_HWARE, 1);\n\t\tstv0900_write_bits(intp, RST_HWARE, 0);\n\t}\n\n\tif (algo == STV0900_BLIND_SEARCH)\n\t\tlock = stv0900_blind_search_algo(fe);\n\telse if (algo == STV0900_COLD_START)\n\t\tlock = stv0900_get_demod_cold_lock(fe, demod_timeout);\n\telse if (algo == STV0900_WARM_START)\n\t\tlock = stv0900_get_demod_lock(intp, demod, demod_timeout);\n\n\tif ((lock == FALSE) && (algo == STV0900_COLD_START)) {\n\t\tif (low_sr == FALSE) {\n\t\t\tif (stv0900_check_timing_lock(intp, demod) == TRUE)\n\t\t\t\tlock = stv0900_sw_algo(intp, demod);\n\t\t}\n\t}\n\n\tif (lock == TRUE)\n\t\tsignal_type = stv0900_get_signal_params(fe);\n\n\tif ((lock == TRUE) && (signal_type == STV0900_RANGEOK)) {\n\t\tstv0900_track_optimization(fe);\n\t\tif (intp->chip_id <= 0x11) {\n\t\t\tif ((stv0900_get_standard(fe, 0) ==\n\t\t\t\t\t\tSTV0900_DVBS1_STANDARD) &&\n\t\t\t   (stv0900_get_standard(fe, 1) ==\n\t\t\t\t\t\tSTV0900_DVBS1_STANDARD)) {\n\t\t\t\tmsleep(20);\n\t\t\t\tstv0900_write_bits(intp, RST_HWARE, 0);\n\t\t\t} else {\n\t\t\t\tstv0900_write_bits(intp, RST_HWARE, 0);\n\t\t\t\tmsleep(3);\n\t\t\t\tstv0900_write_bits(intp, RST_HWARE, 1);\n\t\t\t\tstv0900_write_bits(intp, RST_HWARE, 0);\n\t\t\t}\n\n\t\t} else if (intp->chip_id >= 0x20) {\n\t\t\tstv0900_write_bits(intp, RST_HWARE, 0);\n\t\t\tmsleep(3);\n\t\t\tstv0900_write_bits(intp, RST_HWARE, 1);\n\t\t\tstv0900_write_bits(intp, RST_HWARE, 0);\n\t\t}\n\n\t\tif (stv0900_wait_for_lock(intp, demod,\n\t\t\t\t\tfec_timeout, fec_timeout) == TRUE) {\n\t\t\tlock = TRUE;\n\t\t\tintp->result[demod].locked = TRUE;\n\t\t\tif (intp->result[demod].standard ==\n\t\t\t\t\t\tSTV0900_DVBS2_STANDARD) {\n\t\t\t\tstv0900_set_dvbs2_rolloff(intp, demod);\n\t\t\t\tstv0900_write_bits(intp, RESET_UPKO_COUNT, 1);\n\t\t\t\tstv0900_write_bits(intp, RESET_UPKO_COUNT, 0);\n\t\t\t\tstv0900_write_reg(intp, ERRCTRL1, 0x67);\n\t\t\t} else {\n\t\t\t\tstv0900_write_reg(intp, ERRCTRL1, 0x75);\n\t\t\t}\n\n\t\t\tstv0900_write_reg(intp, FBERCPT4, 0);\n\t\t\tstv0900_write_reg(intp, ERRCTRL2, 0xc1);\n\t\t} else {\n\t\t\tlock = FALSE;\n\t\t\tsignal_type = STV0900_NODATA;\n\t\t\tno_signal = stv0900_check_signal_presence(intp, demod);\n\n\t\t\tintp->result[demod].locked = FALSE;\n\t\t}\n\t}\n\n\tif ((signal_type != STV0900_NODATA) || (no_signal != FALSE))\n\t\treturn signal_type;\n\n\tif (intp->chip_id > 0x11) {\n\t\tintp->result[demod].locked = FALSE;\n\t\treturn signal_type;\n\t}\n\n\tif ((stv0900_get_bits(intp, HEADER_MODE) == STV0900_DVBS_FOUND) &&\n\t   (intp->srch_iq_inv[demod] <= STV0900_IQ_AUTO_NORMAL_FIRST))\n\t\tsignal_type = stv0900_dvbs1_acq_workaround(fe);\n\n\treturn signal_type;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}