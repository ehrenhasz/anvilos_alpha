{
  "module_name": "drxj.c",
  "hash_id": "4135dc8c55832fc82602667b9b74443bb7511501baf764291139e9f431691c0c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/dvb-frontends/drx39xyj/drxj.c",
  "human_readable_source": " \n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \":%s: \" fmt, __func__\n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/string.h>\n#include <linux/slab.h>\n#include <asm/div64.h>\n\n#include <media/dvb_frontend.h>\n#include \"drx39xxj.h\"\n\n#include \"drxj.h\"\n#include \"drxj_map.h\"\n\n \n \n \n\n#define DRX39XX_MAIN_FIRMWARE \"dvb-fe-drxj-mc-1.0.8.fw\"\n\n \n#ifndef MAX_U32\n#define MAX_U32  ((u32) (0xFFFFFFFFL))\n#endif\n\n \n#ifndef MPEG_SERIAL_OUTPUT_PIN_DRIVE_STRENGTH\n#define MPEG_SERIAL_OUTPUT_PIN_DRIVE_STRENGTH 0x02\n#endif\n\n#ifndef MPEG_PARALLEL_OUTPUT_PIN_DRIVE_STRENGTH\n#define MPEG_PARALLEL_OUTPUT_PIN_DRIVE_STRENGTH 0x02\n#endif\n\n#ifndef MPEG_OUTPUT_CLK_DRIVE_STRENGTH\n#define MPEG_OUTPUT_CLK_DRIVE_STRENGTH 0x06\n#endif\n\n#ifndef OOB_CRX_DRIVE_STRENGTH\n#define OOB_CRX_DRIVE_STRENGTH 0x02\n#endif\n\n#ifndef OOB_DRX_DRIVE_STRENGTH\n#define OOB_DRX_DRIVE_STRENGTH 0x02\n#endif\n \n \n#define   ATV_TOP_CR_AMP_TH_FM                                              0x0\n#define   ATV_TOP_CR_AMP_TH_L                                               0xA\n#define   ATV_TOP_CR_AMP_TH_LP                                              0xA\n#define   ATV_TOP_CR_AMP_TH_BG                                              0x8\n#define   ATV_TOP_CR_AMP_TH_DK                                              0x8\n#define   ATV_TOP_CR_AMP_TH_I                                               0x8\n#define     ATV_TOP_CR_CONT_CR_D_MN                                         0x18\n#define     ATV_TOP_CR_CONT_CR_D_FM                                         0x0\n#define     ATV_TOP_CR_CONT_CR_D_L                                          0x20\n#define     ATV_TOP_CR_CONT_CR_D_LP                                         0x20\n#define     ATV_TOP_CR_CONT_CR_D_BG                                         0x18\n#define     ATV_TOP_CR_CONT_CR_D_DK                                         0x18\n#define     ATV_TOP_CR_CONT_CR_D_I                                          0x18\n#define     ATV_TOP_CR_CONT_CR_I_MN                                         0x80\n#define     ATV_TOP_CR_CONT_CR_I_FM                                         0x0\n#define     ATV_TOP_CR_CONT_CR_I_L                                          0x80\n#define     ATV_TOP_CR_CONT_CR_I_LP                                         0x80\n#define     ATV_TOP_CR_CONT_CR_I_BG                                         0x80\n#define     ATV_TOP_CR_CONT_CR_I_DK                                         0x80\n#define     ATV_TOP_CR_CONT_CR_I_I                                          0x80\n#define     ATV_TOP_CR_CONT_CR_P_MN                                         0x4\n#define     ATV_TOP_CR_CONT_CR_P_FM                                         0x0\n#define     ATV_TOP_CR_CONT_CR_P_L                                          0x4\n#define     ATV_TOP_CR_CONT_CR_P_LP                                         0x4\n#define     ATV_TOP_CR_CONT_CR_P_BG                                         0x4\n#define     ATV_TOP_CR_CONT_CR_P_DK                                         0x4\n#define     ATV_TOP_CR_CONT_CR_P_I                                          0x4\n#define   ATV_TOP_CR_OVM_TH_MN                                              0xA0\n#define   ATV_TOP_CR_OVM_TH_FM                                              0x0\n#define   ATV_TOP_CR_OVM_TH_L                                               0xA0\n#define   ATV_TOP_CR_OVM_TH_LP                                              0xA0\n#define   ATV_TOP_CR_OVM_TH_BG                                              0xA0\n#define   ATV_TOP_CR_OVM_TH_DK                                              0xA0\n#define   ATV_TOP_CR_OVM_TH_I                                               0xA0\n#define     ATV_TOP_EQU0_EQU_C0_FM                                          0x0\n#define     ATV_TOP_EQU0_EQU_C0_L                                           0x3\n#define     ATV_TOP_EQU0_EQU_C0_LP                                          0x3\n#define     ATV_TOP_EQU0_EQU_C0_BG                                          0x7\n#define     ATV_TOP_EQU0_EQU_C0_DK                                          0x0\n#define     ATV_TOP_EQU0_EQU_C0_I                                           0x3\n#define     ATV_TOP_EQU1_EQU_C1_FM                                          0x0\n#define     ATV_TOP_EQU1_EQU_C1_L                                           0x1F6\n#define     ATV_TOP_EQU1_EQU_C1_LP                                          0x1F6\n#define     ATV_TOP_EQU1_EQU_C1_BG                                          0x197\n#define     ATV_TOP_EQU1_EQU_C1_DK                                          0x198\n#define     ATV_TOP_EQU1_EQU_C1_I                                           0x1F6\n#define     ATV_TOP_EQU2_EQU_C2_FM                                          0x0\n#define     ATV_TOP_EQU2_EQU_C2_L                                           0x28\n#define     ATV_TOP_EQU2_EQU_C2_LP                                          0x28\n#define     ATV_TOP_EQU2_EQU_C2_BG                                          0xC5\n#define     ATV_TOP_EQU2_EQU_C2_DK                                          0xB0\n#define     ATV_TOP_EQU2_EQU_C2_I                                           0x28\n#define     ATV_TOP_EQU3_EQU_C3_FM                                          0x0\n#define     ATV_TOP_EQU3_EQU_C3_L                                           0x192\n#define     ATV_TOP_EQU3_EQU_C3_LP                                          0x192\n#define     ATV_TOP_EQU3_EQU_C3_BG                                          0x12E\n#define     ATV_TOP_EQU3_EQU_C3_DK                                          0x18E\n#define     ATV_TOP_EQU3_EQU_C3_I                                           0x192\n#define     ATV_TOP_STD_MODE_MN                                             0x0\n#define     ATV_TOP_STD_MODE_FM                                             0x1\n#define     ATV_TOP_STD_MODE_L                                              0x0\n#define     ATV_TOP_STD_MODE_LP                                             0x0\n#define     ATV_TOP_STD_MODE_BG                                             0x0\n#define     ATV_TOP_STD_MODE_DK                                             0x0\n#define     ATV_TOP_STD_MODE_I                                              0x0\n#define     ATV_TOP_STD_VID_POL_MN                                          0x0\n#define     ATV_TOP_STD_VID_POL_FM                                          0x0\n#define     ATV_TOP_STD_VID_POL_L                                           0x2\n#define     ATV_TOP_STD_VID_POL_LP                                          0x2\n#define     ATV_TOP_STD_VID_POL_BG                                          0x0\n#define     ATV_TOP_STD_VID_POL_DK                                          0x0\n#define     ATV_TOP_STD_VID_POL_I                                           0x0\n#define   ATV_TOP_VID_AMP_MN                                                0x380\n#define   ATV_TOP_VID_AMP_FM                                                0x0\n#define   ATV_TOP_VID_AMP_L                                                 0xF50\n#define   ATV_TOP_VID_AMP_LP                                                0xF50\n#define   ATV_TOP_VID_AMP_BG                                                0x380\n#define   ATV_TOP_VID_AMP_DK                                                0x394\n#define   ATV_TOP_VID_AMP_I                                                 0x3D8\n#define   IQM_CF_OUT_ENA_OFDM__M                                            0x4\n#define     IQM_FS_ADJ_SEL_B_QAM                                            0x1\n#define     IQM_FS_ADJ_SEL_B_OFF                                            0x0\n#define     IQM_FS_ADJ_SEL_B_VSB                                            0x2\n#define     IQM_RC_ADJ_SEL_B_OFF                                            0x0\n#define     IQM_RC_ADJ_SEL_B_QAM                                            0x1\n#define     IQM_RC_ADJ_SEL_B_VSB                                            0x2\n \n\n#include \"drx_driver_version.h\"\n\n \n#ifdef DRX_DEBUG\n#include <stdio.h>\n#endif\n\n \n\n \n#ifndef DRXJ_WAKE_UP_KEY\n#define DRXJ_WAKE_UP_KEY (demod->my_i2c_dev_addr->i2c_addr)\n#endif\n\n \n#define DRXJ_DEF_I2C_ADDR (0x52)\n\n \n#define DRXJ_DEF_DEMOD_DEV_ID      (1)\n\n \n#define DRXJ_SCAN_TIMEOUT    1000\n\n \n#define HI_I2C_DELAY    42\n\n \n#define HI_I2C_BRIDGE_DELAY   750\n\n \n#define VSB_TOP_MEASUREMENT_PERIOD  64\n#define SYMBOLS_PER_SEGMENT         832\n\n \n \n#define DRXJ_QAM_SL_SIG_POWER_QAM_UNKNOWN 0\n#define DRXJ_QAM_SL_SIG_POWER_QPSK        32768\n#define DRXJ_QAM_SL_SIG_POWER_QAM8        24576\n#define DRXJ_QAM_SL_SIG_POWER_QAM16       40960\n#define DRXJ_QAM_SL_SIG_POWER_QAM32       20480\n#define DRXJ_QAM_SL_SIG_POWER_QAM64       43008\n#define DRXJ_QAM_SL_SIG_POWER_QAM128      20992\n#define DRXJ_QAM_SL_SIG_POWER_QAM256      43520\n \n#ifndef DRXJ_QAM_SYMBOLRATE_MIN\n#define DRXJ_QAM_SYMBOLRATE_MIN          (520000)\n#endif\n\n \n#ifndef DRXJ_QAM_SYMBOLRATE_MAX\n#define DRXJ_QAM_SYMBOLRATE_MAX         (7233000)\n#endif\n\n \n#ifndef DRXJ_QAM_MAX_WAITTIME\n#define DRXJ_QAM_MAX_WAITTIME 900\n#endif\n\n#ifndef DRXJ_QAM_FEC_LOCK_WAITTIME\n#define DRXJ_QAM_FEC_LOCK_WAITTIME 150\n#endif\n\n#ifndef DRXJ_QAM_DEMOD_LOCK_EXT_WAITTIME\n#define DRXJ_QAM_DEMOD_LOCK_EXT_WAITTIME 200\n#endif\n\n \n#define DRX_SCU_READY               0\n#define DRXJ_MAX_WAITTIME           100\t \n#define FEC_RS_MEASUREMENT_PERIOD   12894\t \n#define FEC_RS_MEASUREMENT_PRESCALE 1\t \n\n \n#ifndef DRXJ_AUD_MAX_FM_DEVIATION\n#define DRXJ_AUD_MAX_FM_DEVIATION  100\t \n#endif\n\n \n#ifndef DRXJ_AUD_MAX_NICAM_PRESCALE\n#define DRXJ_AUD_MAX_NICAM_PRESCALE  (9)\t \n#endif\n\n \n#ifndef DRXJ_AUD_MAX_WAITTIME\n#define DRXJ_AUD_MAX_WAITTIME  250\t \n#endif\n\n \n#define DRXJ_ATV_CHANGED_COEF          (0x00000001UL)\n#define DRXJ_ATV_CHANGED_PEAK_FLT      (0x00000008UL)\n#define DRXJ_ATV_CHANGED_NOISE_FLT     (0x00000010UL)\n#define DRXJ_ATV_CHANGED_OUTPUT        (0x00000020UL)\n#define DRXJ_ATV_CHANGED_SIF_ATT       (0x00000040UL)\n\n \n#define DRX_UIO_MODE_FIRMWARE_SMA DRX_UIO_MODE_FIRMWARE0\n#define DRX_UIO_MODE_FIRMWARE_SAW DRX_UIO_MODE_FIRMWARE1\n\n \n\n \n#define DRX_UCODE_MAGIC_WORD         ((((u16)'H')<<8)+((u16)'L'))\n\n \n#define DRX_UCODE_CRC_FLAG           (0x0001)\n\n \n#define DRX_UCODE_MAX_BUF_SIZE       (DRXDAP_MAX_RCHUNKSIZE)\n\n#if DRX_UCODE_MAX_BUF_SIZE & 1\n#error DRX_UCODE_MAX_BUF_SIZE must be an even number\n#endif\n\n \n\n#define DRX_ISPOWERDOWNMODE(mode) ((mode == DRX_POWER_MODE_9) || \\\n\t\t\t\t       (mode == DRX_POWER_MODE_10) || \\\n\t\t\t\t       (mode == DRX_POWER_MODE_11) || \\\n\t\t\t\t       (mode == DRX_POWER_MODE_12) || \\\n\t\t\t\t       (mode == DRX_POWER_MODE_13) || \\\n\t\t\t\t       (mode == DRX_POWER_MODE_14) || \\\n\t\t\t\t       (mode == DRX_POWER_MODE_15) || \\\n\t\t\t\t       (mode == DRX_POWER_MODE_16) || \\\n\t\t\t\t       (mode == DRX_POWER_DOWN))\n\n \n#define DRXJ_PIN_SAFE_MODE 0x0000\n \n \n \n \n\n \n\n \n \n \n \n \n \n \n#define AUD_DEM_RAM_MODUS_HI__A              0x10204A3\n#define AUD_DEM_RAM_MODUS_HI__M              0xF000\n\n#define AUD_DEM_RAM_MODUS_LO__A              0x10204A4\n#define AUD_DEM_RAM_MODUS_LO__M              0x0FFF\n\n \n#define AUD_DEM_RAM_I2S_CONFIG1__A           0x10204B1\n#define AUD_DEM_RAM_I2S_CONFIG2__A           0x10204B2\n\n \n#define AUD_DEM_RAM_DCO_B_HI__A              0x1020461\n#define AUD_DEM_RAM_DCO_B_LO__A              0x1020462\n#define AUD_DEM_RAM_DCO_A_HI__A              0x1020463\n#define AUD_DEM_RAM_DCO_A_LO__A              0x1020464\n\n \n#define AUD_DEM_RAM_NICAM_THRSHLD__A         0x102045A\n#define AUD_DEM_RAM_A2_THRSHLD__A            0x10204BB\n#define AUD_DEM_RAM_BTSC_THRSHLD__A          0x10204A6\n\n \n#define AUD_DEM_RAM_CM_A_THRSHLD__A          0x10204AF\n#define AUD_DEM_RAM_CM_B_THRSHLD__A          0x10204B0\n\n \n#ifdef AUD_DEM_WR_FM_MATRIX__A\n#undef  AUD_DEM_WR_FM_MATRIX__A\n#endif\n#define AUD_DEM_WR_FM_MATRIX__A              0x105006F\n\n \n \n#define AUD_VOLUME_ZERO_DB                      115\n#define AUD_VOLUME_DB_MIN                       -60\n#define AUD_VOLUME_DB_MAX                       12\n#define AUD_CARRIER_STRENGTH_QP_0DB             0x4000\n#define AUD_CARRIER_STRENGTH_QP_0DB_LOG10T100   421\n#define AUD_MAX_AVC_REF_LEVEL                   15\n#define AUD_I2S_FREQUENCY_MAX                   48000UL\n#define AUD_I2S_FREQUENCY_MIN                   12000UL\n#define AUD_RDS_ARRAY_SIZE                      18\n\n \n#ifndef DRX_AUD_MAX_FM_DEVIATION\n#define DRX_AUD_MAX_FM_DEVIATION  (100)\t \n#endif\n\n \n#ifndef DRX_AUD_MAX_NICAM_PRESCALE\n#define DRX_AUD_MAX_NICAM_PRESCALE  (9)\t \n#endif\n\n \n \n#define SIO_PDR_I2S_CL_CFG_MODE__MASTER      0x0004\n#define SIO_PDR_I2S_CL_CFG_DRIVE__MASTER     0x0008\n#define SIO_PDR_I2S_CL_CFG_MODE__SLAVE       0x0004\n#define SIO_PDR_I2S_CL_CFG_DRIVE__SLAVE      0x0000\n\n#define SIO_PDR_I2S_DA_CFG_MODE__MASTER      0x0003\n#define SIO_PDR_I2S_DA_CFG_DRIVE__MASTER     0x0008\n#define SIO_PDR_I2S_DA_CFG_MODE__SLAVE       0x0003\n#define SIO_PDR_I2S_DA_CFG_DRIVE__SLAVE      0x0008\n\n#define SIO_PDR_I2S_WS_CFG_MODE__MASTER      0x0004\n#define SIO_PDR_I2S_WS_CFG_DRIVE__MASTER     0x0008\n#define SIO_PDR_I2S_WS_CFG_MODE__SLAVE       0x0004\n#define SIO_PDR_I2S_WS_CFG_DRIVE__SLAVE      0x0000\n\n \n \n \n\n \n#define DRXJ_16TO8(x) ((u8) (((u16)x) & 0xFF)), \\\n\t\t       ((u8)((((u16)x)>>8)&0xFF))\n \n#define DRXJ_8TO16(x) ((u16) (x[0] | (x[1] << 8)))\n\n \n \n \n\n \n \n \n\n \n#define DRXJ_MAX_RETRIES (100)\n\n \n \n \n\n#define DRXJ_ISATVSTD(std) ((std == DRX_STANDARD_PAL_SECAM_BG) || \\\n\t\t\t       (std == DRX_STANDARD_PAL_SECAM_DK) || \\\n\t\t\t       (std == DRX_STANDARD_PAL_SECAM_I) || \\\n\t\t\t       (std == DRX_STANDARD_PAL_SECAM_L) || \\\n\t\t\t       (std == DRX_STANDARD_PAL_SECAM_LP) || \\\n\t\t\t       (std == DRX_STANDARD_NTSC) || \\\n\t\t\t       (std == DRX_STANDARD_FM))\n\n#define DRXJ_ISQAMSTD(std) ((std == DRX_STANDARD_ITU_A) || \\\n\t\t\t       (std == DRX_STANDARD_ITU_B) || \\\n\t\t\t       (std == DRX_STANDARD_ITU_C) || \\\n\t\t\t       (std == DRX_STANDARD_ITU_D))\n\n \n \n\nstatic int drxdap_fasi_read_block(struct i2c_device_addr *dev_addr,\n\t\t\t\t      u32 addr,\n\t\t\t\t      u16 datasize,\n\t\t\t\t      u8 *data, u32 flags);\n\n\nstatic int drxj_dap_read_modify_write_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t\t u32 waddr,\n\t\t\t\t\t\t u32 raddr,\n\t\t\t\t\t\t u16 wdata, u16 *rdata);\n\nstatic int drxj_dap_read_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t      u32 addr,\n\t\t\t\t      u16 *data, u32 flags);\n\nstatic int drxdap_fasi_read_reg32(struct i2c_device_addr *dev_addr,\n\t\t\t\t      u32 addr,\n\t\t\t\t      u32 *data, u32 flags);\n\nstatic int drxdap_fasi_write_block(struct i2c_device_addr *dev_addr,\n\t\t\t\t       u32 addr,\n\t\t\t\t       u16 datasize,\n\t\t\t\t       u8 *data, u32 flags);\n\nstatic int drxj_dap_write_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t       u32 addr,\n\t\t\t\t       u16 data, u32 flags);\n\nstatic int drxdap_fasi_write_reg32(struct i2c_device_addr *dev_addr,\n\t\t\t\t       u32 addr,\n\t\t\t\t       u32 data, u32 flags);\n\nstatic struct drxj_data drxj_data_g = {\n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\t0,\t\t\t \n\n\t \n\tfalse,\t\t\t \n\t \n\tDRX_STANDARD_UNKNOWN,\t \n\tDRX_CONSTELLATION_AUTO,\t \n\t0,\t\t\t \n\tDRX_BANDWIDTH_UNKNOWN,\t \n\tDRX_MIRROR_NO,\t\t \n\n\t \n\t \n\t \n\t4000000,\t\t \n\t5,\t\t\t \n\t4,\t\t\t \n\t0xFFFF,\t\t\t \n\t204 * 8,\t\t \n\t1,\t\t\t \n\tFEC_RS_MEASUREMENT_PERIOD,\t \n\ttrue,\t\t\t \n\t0,\t\t\t \n\n\t \n\t0,\t\t\t \n\t0,\t\t\t \n\t0,\t\t\t \n\t0,\t\t\t \n\t0,\t\t\t \n\t \n\tDRX_UIO_MODE_DISABLE,\t \n\tDRX_UIO_MODE_DISABLE,\t \n\tDRX_UIO_MODE_DISABLE,\t \n\tDRX_UIO_MODE_DISABLE,\t \n\t \n\t0UL,\t\t\t \n\tfalse,\t\t\t \n\t \n\t0UL,\t\t\t \n\t \n \n \n \n \n \n \n\n\t \n\t0UL,\t\t\t \n\t \n\t{-5,\n\t ATV_TOP_EQU0_EQU_C0_FM,\n\t ATV_TOP_EQU0_EQU_C0_L,\n\t ATV_TOP_EQU0_EQU_C0_LP,\n\t ATV_TOP_EQU0_EQU_C0_BG,\n\t ATV_TOP_EQU0_EQU_C0_DK,\n\t ATV_TOP_EQU0_EQU_C0_I},\n\t \n\t{-50,\n\t ATV_TOP_EQU1_EQU_C1_FM,\n\t ATV_TOP_EQU1_EQU_C1_L,\n\t ATV_TOP_EQU1_EQU_C1_LP,\n\t ATV_TOP_EQU1_EQU_C1_BG,\n\t ATV_TOP_EQU1_EQU_C1_DK,\n\t ATV_TOP_EQU1_EQU_C1_I},\n\t \n\t{210,\n\t ATV_TOP_EQU2_EQU_C2_FM,\n\t ATV_TOP_EQU2_EQU_C2_L,\n\t ATV_TOP_EQU2_EQU_C2_LP,\n\t ATV_TOP_EQU2_EQU_C2_BG,\n\t ATV_TOP_EQU2_EQU_C2_DK,\n\t ATV_TOP_EQU2_EQU_C2_I},\n\t \n\t{-160,\n\t ATV_TOP_EQU3_EQU_C3_FM,\n\t ATV_TOP_EQU3_EQU_C3_L,\n\t ATV_TOP_EQU3_EQU_C3_LP,\n\t ATV_TOP_EQU3_EQU_C3_BG,\n\t ATV_TOP_EQU3_EQU_C3_DK,\n\t ATV_TOP_EQU3_EQU_C3_I},\n\tfalse,\t\t\t \n\tATV_TOP_VID_PEAK__PRE,\t \n\tATV_TOP_NOISE_TH__PRE,\t \n\ttrue,\t\t\t \n\tfalse,\t\t\t \n\tDRXJ_SIF_ATTENUATION_0DB,\t \n\t{\t\t\t \n\t DRX_STANDARD_ITU_B,\t \n\t DRX_AGC_CTRL_AUTO,\t \n\t 0,\t\t\t \n\t 0,\t\t\t \n\t 0xFFFF,\t\t \n\t 0x0000,\t\t \n\t 0x0000,\t\t \n\t 0x0000\t\t\t \n\t },\n\t{\t\t\t \n\t DRX_STANDARD_ITU_B,\t \n\t DRX_AGC_CTRL_AUTO,\t \n\t 0,\t\t\t \n\t 0,\t\t\t \n\t 0xFFFF,\t\t \n\t 0x0000,\t\t \n\t 0x0000,\t\t \n\t 0x0000\t\t\t \n\t },\n\t{\t\t\t \n\t DRX_STANDARD_8VSB,\t \n\t DRX_AGC_CTRL_AUTO,\t \n\t 0,\t\t\t \n\t 0,\t\t\t \n\t 0xFFFF,\t\t \n\t 0x0000,\t\t \n\t 0x0000,\t\t \n\t 0x0000\t\t\t \n\t },\n\t{\t\t\t \n\t DRX_STANDARD_8VSB,\t \n\t DRX_AGC_CTRL_AUTO,\t \n\t 0,\t\t\t \n\t 0,\t\t\t \n\t 0xFFFF,\t\t \n\t 0x0000,\t\t \n\t 0x0000,\t\t \n\t 0x0000\t\t\t \n\t },\n\t0,\t\t\t \n\t0,\t\t\t \n\t{\t\t\t \n\t DRX_STANDARD_ITU_B,\t \n\t 0,\t\t\t \n\t false\t\t\t \n\t },\n\t{\t\t\t \n\t DRX_STANDARD_8VSB,\t \n\t 0,\t\t\t \n\t false\t\t\t \n\t },\n\n\t \n#ifndef _CH_\n\t{\n\t \"01234567890\",\t\t \n\t \"01234567890\"\t\t \n\t },\n\t{\n\t {\t\t\t \n\t  DRX_MODULE_UNKNOWN,\n\t  (char *)(NULL),\n\t  0,\n\t  0,\n\t  0,\n\t  (char *)(NULL)\n\t  },\n\t {\t\t\t \n\t  DRX_MODULE_UNKNOWN,\n\t  (char *)(NULL),\n\t  0,\n\t  0,\n\t  0,\n\t  (char *)(NULL)\n\t  }\n\t },\n\t{\n\t {\t\t\t \n\t  (struct drx_version *) (NULL),\n\t  (struct drx_version_list *) (NULL)\n\t  },\n\t {\t\t\t \n\t  (struct drx_version *) (NULL),\n\t  (struct drx_version_list *) (NULL)\n\t  }\n\t },\n#endif\n\tfalse,\t\t\t \n\t \n\t{\n\t 12000,\n\t 9300,\n\t 6600,\n\t 5280,\n\t 3700,\n\t 3000,\n\t 2000,\n\t 0},\n\tfalse,\t\t\t \n\t0,\t\t\t \n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\tDRXJ_MPEGOUTPUT_CLOCK_RATE_AUTO,\t \n\tDRXJ_MPEG_START_WIDTH_1CLKCYC,\t \n\n\t \n\t{\n\t DRX_STANDARD_NTSC,\t \n\t 7,\t\t\t \n\t true\t\t\t \n\t },\n\t{\t\t\t \n\t DRX_STANDARD_NTSC,\t \n\t DRX_AGC_CTRL_AUTO,\t \n\t 0,\t\t\t \n\t 0,\t\t\t \n\t 0,\t\t\t \n\t 3,\t\t\t \n\t 9500,\t\t\t \n\t 4000\t\t\t \n\t },\n\t{\t\t\t \n\t DRX_STANDARD_NTSC,\t \n\t DRX_AGC_CTRL_AUTO,\t \n\t 0,\t\t\t \n\t 0,\t\t\t \n\t 0,\t\t\t \n\t 3,\t\t\t \n\t 2400,\t\t\t \n\t 0\t\t\t \n\t },\n\t140,\t\t\t \n\t0,\t\t\t \n\n\tfalse,\t\t\t \n\tSIO_PDR_GPIO_CFG__PRE,\t \n\tSIO_PDR_VSYNC_CFG__PRE,\t \n\tSIO_PDR_SMA_RX_CFG__PRE,\t \n\tSIO_PDR_SMA_TX_CFG__PRE,\t \n\n\t4,\t\t\t \n\tDRXJ_OOB_LO_POW_MINUS10DB,\t \n\t{\n\t false\t\t\t \n\t },\n};\n\n \nstatic struct i2c_device_addr drxj_default_addr_g = {\n\tDRXJ_DEF_I2C_ADDR,\t \n\tDRXJ_DEF_DEMOD_DEV_ID\t \n};\n\n \nstatic struct drx_common_attr drxj_default_comm_attr_g = {\n\tNULL,\t\t\t \n\ttrue,\t\t\t \n\t{0},\t\t\t \n\n\t44000,\t\t\t \n\t(151875 - 0),\t\t \n\t0,\t\t\t \n\t0,\t\t\t \n\tfalse,\t\t\t \n\t{\n\t  \n\t true,\t\t\t \n\t false,\t\t\t \n\t false,\t\t\t \n\t false,\t\t\t \n\t false,\t\t\t \n\t false,\t\t\t \n\t false,\t\t\t \n\t false,\t\t\t \n\t true,\t\t\t \n\t 19392658UL,\t\t \n\t DRX_MPEG_STR_WIDTH_1\t \n\t },\n\t \n\tfalse,\t\t\t \n\n\t \n\tNULL,\t\t\t \n\t0,\t\t\t \n\t0,\t\t\t \n\tfalse,\t\t\t \n\t0,\t\t\t \n\t0,\t\t\t \n\tNULL,\t\t\t \n\tNULL,\t\t\t \n\t0,\t\t\t \n\tDRXJ_DEMOD_LOCK,\t \n\tfalse,\n\n\t \n\tDRX_POWER_UP,\n\n\t \n\t1,\t\t\t \n\t0L,\t\t\t \n\t0L,\t\t\t \n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\tfalse,\t\t\t \n\n\t{\t\t\t \n\t 0UL\t\t\t \n\t },\n\tDRX_STANDARD_UNKNOWN,\t \n\tDRX_STANDARD_UNKNOWN,\t \n\tDRX_STANDARD_UNKNOWN,\t \n\tfalse,\t\t\t \n\t0UL,\t\t\t \n\t0\t\t\t \n};\n\n \nstatic struct drx_demod_instance drxj_default_demod_g = {\n\t&drxj_default_addr_g,\t \n\t&drxj_default_comm_attr_g,\t \n\t&drxj_data_g\t\t \n};\n\n \nstatic struct drx_aud_data drxj_default_aud_data_g = {\n\tfalse,\t\t\t \n\tDRX_AUD_STANDARD_AUTO,\t \n\n\t \n\t{\n\t false,\t\t\t \n\t 48000,\t\t\t \n\t DRX_I2S_MODE_MASTER,\t \n\t DRX_I2S_WORDLENGTH_32,\t \n\t DRX_I2S_POLARITY_RIGHT,\t \n\t DRX_I2S_FORMAT_WS_WITH_DATA\t \n\t },\n\t \n\t{\n\t true,\t\t\t \n\t 0,\t\t\t \n\t DRX_AUD_AVC_OFF,\t \n\t 0,\t\t\t \n\t DRX_AUD_AVC_MAX_GAIN_12DB,\t \n\t DRX_AUD_AVC_MAX_ATTEN_24DB,\t \n\t 0,\t\t\t \n\t 0\t\t\t \n\t },\n\tDRX_AUD_AUTO_SOUND_SELECT_ON_CHANGE_ON,\t \n\t \n\t{\n\t 440,\t\t\t \n\t 12,\t\t\t \n\t 700,\t\t\t \n\t },\n\t \n\t{\n\t  \n\t {\n\t  42,\t\t\t \n\t  DRX_NO_CARRIER_NOISE,\t \n\t  0,\t\t\t \n\t  0\t\t\t \n\t  },\n\t  \n\t {\n\t  42,\t\t\t \n\t  DRX_NO_CARRIER_MUTE,\t \n\t  0,\t\t\t \n\t  0\t\t\t \n\t  },\n\n\t },\n\t \n\t{\n\t DRX_AUD_SRC_STEREO_OR_A,\t \n\t DRX_AUD_I2S_MATRIX_STEREO,\t \n\t DRX_AUD_FM_MATRIX_SOUND_A\t \n\t },\n\tDRX_AUD_DEVIATION_NORMAL,\t \n\tDRX_AUD_AVSYNC_OFF,\t \n\n\t \n\t{\n\t DRX_AUD_MAX_FM_DEVIATION,\t \n\t DRX_AUD_MAX_NICAM_PRESCALE\t \n\t },\n\tDRX_AUD_FM_DEEMPH_75US,\t \n\tDRX_BTSC_STEREO,\t \n\t0,\t\t\t \n\tfalse\t\t\t \n};\n\n \nstruct drxjeq_stat {\n\tu16 eq_mse;\n\tu8 eq_mode;\n\tu8 eq_ctrl;\n\tu8 eq_stat;\n};\n\n \nstruct drxj_hi_cmd {\n\tu16 cmd;\n\tu16 param1;\n\tu16 param2;\n\tu16 param3;\n\tu16 param4;\n\tu16 param5;\n\tu16 param6;\n};\n\n \n \n \n\n \nstruct drxu_code_block_hdr {\n\tu32 addr;\n\tu16 size;\n\tu16 flags;\n\tu16 CRC;\n};\n\n \n \nstatic int\nhi_command(struct i2c_device_addr *dev_addr,\n\t   const struct drxj_hi_cmd *cmd, u16 *result);\n\nstatic int\nctrl_lock_status(struct drx_demod_instance *demod, enum drx_lock_status *lock_stat);\n\nstatic int\nctrl_power_mode(struct drx_demod_instance *demod, enum drx_power_mode *mode);\n\nstatic int power_down_aud(struct drx_demod_instance *demod);\n\nstatic int\nctrl_set_cfg_pre_saw(struct drx_demod_instance *demod, struct drxj_cfg_pre_saw *pre_saw);\n\nstatic int\nctrl_set_cfg_afe_gain(struct drx_demod_instance *demod, struct drxj_cfg_afe_gain *afe_gain);\n\n \n \n \n \n \n\n\n \n\n \nstatic u32 frac28(u32 N, u32 D)\n{\n\tint i = 0;\n\tu32 Q1 = 0;\n\tu32 R0 = 0;\n\n\tR0 = (N % D) << 4;\t \n\tQ1 = N / D;\t\t \n\n\t \n\tfor (i = 0; i < 7; i++) {\n\t\tQ1 = (Q1 << 4) | R0 / D;\n\t\tR0 = (R0 % D) << 4;\n\t}\n\t \n\tif ((R0 >> 3) >= D)\n\t\tQ1++;\n\n\treturn Q1;\n}\n\n \n\nstatic u32 log1_times100(u32 x)\n{\n\tstatic const u8 scale = 15;\n\tstatic const u8 index_width = 5;\n\t \n\n\tstatic const u32 log2lut[] = {\n\t\t0,\t\t \n\t\t290941,\t\t \n\t\t573196,\t\t \n\t\t847269,\t\t \n\t\t1113620,\t \n\t\t1372674,\t \n\t\t1624818,\t \n\t\t1870412,\t \n\t\t2109788,\t \n\t\t2343253,\t \n\t\t2571091,\t \n\t\t2793569,\t \n\t\t3010931,\t \n\t\t3223408,\t \n\t\t3431216,\t \n\t\t3634553,\t \n\t\t3833610,\t \n\t\t4028562,\t \n\t\t4219576,\t \n\t\t4406807,\t \n\t\t4590402,\t \n\t\t4770499,\t \n\t\t4947231,\t \n\t\t5120719,\t \n\t\t5291081,\t \n\t\t5458428,\t \n\t\t5622864,\t \n\t\t5784489,\t \n\t\t5943398,\t \n\t\t6099680,\t \n\t\t6253421,\t \n\t\t6404702,\t \n\t\t6553600,\t \n\t};\n\n\tu8 i = 0;\n\tu32 y = 0;\n\tu32 d = 0;\n\tu32 k = 0;\n\tu32 r = 0;\n\n\tif (x == 0)\n\t\treturn 0;\n\n\t \n\t \n\tif ((x & (((u32) (-1)) << (scale + 1))) == 0) {\n\t\tfor (k = scale; k > 0; k--) {\n\t\t\tif (x & (((u32) 1) << scale))\n\t\t\t\tbreak;\n\t\t\tx <<= 1;\n\t\t}\n\t} else {\n\t\tfor (k = scale; k < 31; k++) {\n\t\t\tif ((x & (((u32) (-1)) << (scale + 1))) == 0)\n\t\t\t\tbreak;\n\t\t\tx >>= 1;\n\t\t}\n\t}\n\t \n\n\t \n\ty = k * ((((u32) 1) << scale) * 200);\n\n\t \n\tx &= ((((u32) 1) << scale) - 1);\n\t \n\ti = (u8) (x >> (scale - index_width));\n\t \n\td = x & ((((u32) 1) << (scale - index_width)) - 1);\n\t \n\ty += log2lut[i] +\n\t    ((d * (log2lut[i + 1] - log2lut[i])) >> (scale - index_width));\n\t \n\ty /= 108853;\t\t \n\tr = (y >> 1);\n\t \n\tif (y & ((u32)1))\n\t\tr++;\n\n\treturn r;\n\n}\n\n \nstatic u32 frac_times1e6(u32 N, u32 D)\n{\n\tu32 remainder = 0;\n\tu32 frac = 0;\n\n\t \n\tfrac = (((u32) N) * (1000000 >> 4)) / D;\n\tfrac <<= 4;\n\tremainder = (((u32) N) * (1000000 >> 4)) % D;\n\tremainder <<= 4;\n\tfrac += remainder / D;\n\tremainder = remainder % D;\n\tif ((remainder * 2) > D)\n\t\tfrac++;\n\n\treturn frac;\n}\n\n \n\n\n \n#if 0\n \nstatic const u16 nicam_presc_table_val[43] = {\n\t1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 4,\n\t5, 5, 6, 6, 7, 8, 9, 10, 11, 13, 14, 16,\n\t18, 20, 23, 25, 28, 32, 36, 40, 45,\n\t51, 57, 64, 71, 80, 90, 101, 113, 127\n};\n#endif\n\n \n \n \n\n \n \n \n \n \n\n \n\n#define DRXJ_ISAUDWRITE(addr) (((((addr)>>16)&1) == 1) ? true : false)\n#define DRXJ_DAP_AUDTRIF_TIMEOUT 80\t \n \n\n \nstatic\nbool is_handled_by_aud_tr_if(u32 addr)\n{\n\tbool retval = false;\n\n\tif ((DRXDAP_FASI_ADDR2BLOCK(addr) == 4) &&\n\t    (DRXDAP_FASI_ADDR2BANK(addr) > 1) &&\n\t    (DRXDAP_FASI_ADDR2BANK(addr) < 6)) {\n\t\tretval = true;\n\t}\n\n\treturn retval;\n}\n\n \n\nint drxbsp_i2c_write_read(struct i2c_device_addr *w_dev_addr,\n\t\t\t\t u16 w_count,\n\t\t\t\t u8 *wData,\n\t\t\t\t struct i2c_device_addr *r_dev_addr,\n\t\t\t\t u16 r_count, u8 *r_data)\n{\n\tstruct drx39xxj_state *state;\n\tstruct i2c_msg msg[2];\n\tunsigned int num_msgs;\n\n\tif (w_dev_addr == NULL) {\n\t\t \n\t\tstate = r_dev_addr->user_data;\n\t\tmsg[0].addr = r_dev_addr->i2c_addr >> 1;\n\t\tmsg[0].flags = I2C_M_RD;\n\t\tmsg[0].buf = r_data;\n\t\tmsg[0].len = r_count;\n\t\tnum_msgs = 1;\n\t} else if (r_dev_addr == NULL) {\n\t\t \n\t\tstate = w_dev_addr->user_data;\n\t\tmsg[0].addr = w_dev_addr->i2c_addr >> 1;\n\t\tmsg[0].flags = 0;\n\t\tmsg[0].buf = wData;\n\t\tmsg[0].len = w_count;\n\t\tnum_msgs = 1;\n\t} else {\n\t\t \n\t\tstate = w_dev_addr->user_data;\n\t\tmsg[0].addr = w_dev_addr->i2c_addr >> 1;\n\t\tmsg[0].flags = 0;\n\t\tmsg[0].buf = wData;\n\t\tmsg[0].len = w_count;\n\t\tmsg[1].addr = r_dev_addr->i2c_addr >> 1;\n\t\tmsg[1].flags = I2C_M_RD;\n\t\tmsg[1].buf = r_data;\n\t\tmsg[1].len = r_count;\n\t\tnum_msgs = 2;\n\t}\n\n\tif (state->i2c == NULL) {\n\t\tpr_err(\"i2c was zero, aborting\\n\");\n\t\treturn 0;\n\t}\n\tif (i2c_transfer(state->i2c, msg, num_msgs) != num_msgs) {\n\t\tpr_warn(\"drx3933: I2C write/read failed\\n\");\n\t\treturn -EREMOTEIO;\n\t}\n\n#ifdef DJH_DEBUG\n\tif (w_dev_addr == NULL || r_dev_addr == NULL)\n\t\treturn 0;\n\n\tstate = w_dev_addr->user_data;\n\n\tif (state->i2c == NULL)\n\t\treturn 0;\n\n\tmsg[0].addr = w_dev_addr->i2c_addr;\n\tmsg[0].flags = 0;\n\tmsg[0].buf = wData;\n\tmsg[0].len = w_count;\n\tmsg[1].addr = r_dev_addr->i2c_addr;\n\tmsg[1].flags = I2C_M_RD;\n\tmsg[1].buf = r_data;\n\tmsg[1].len = r_count;\n\tnum_msgs = 2;\n\n\tpr_debug(\"drx3933 i2c operation addr=%x i2c=%p, wc=%x rc=%x\\n\",\n\t       w_dev_addr->i2c_addr, state->i2c, w_count, r_count);\n\n\tif (i2c_transfer(state->i2c, msg, 2) != 2) {\n\t\tpr_warn(\"drx3933: I2C write/read failed\\n\");\n\t\treturn -EREMOTEIO;\n\t}\n#endif\n\treturn 0;\n}\n\n \n\n \n\nstatic int drxdap_fasi_read_block(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t u32 addr,\n\t\t\t\t\t u16 datasize,\n\t\t\t\t\t u8 *data, u32 flags)\n{\n\tu8 buf[4];\n\tu16 bufx;\n\tint rc;\n\tu16 overhead_size = 0;\n\n\t \n\tif (dev_addr == NULL)\n\t\treturn -EINVAL;\n\n\toverhead_size = (IS_I2C_10BIT(dev_addr->i2c_addr) ? 2 : 1) +\n\t    (DRXDAP_FASI_LONG_FORMAT(addr) ? 4 : 2);\n\n\tif ((DRXDAP_FASI_OFFSET_TOO_LARGE(addr)) ||\n\t    ((!(DRXDAPFASI_LONG_ADDR_ALLOWED)) &&\n\t     DRXDAP_FASI_LONG_FORMAT(addr)) ||\n\t    (overhead_size > (DRXDAP_MAX_WCHUNKSIZE)) ||\n\t    ((datasize != 0) && (data == NULL)) || ((datasize & 1) == 1)) {\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tflags &= (~DRXDAP_FASI_RMW & ~DRXDAP_FASI_MODEFLAGS);\n#if DRXDAP_SINGLE_MASTER\n\tflags |= DRXDAP_FASI_SINGLE_MASTER;\n#endif\n\n\t \n\tdo {\n\t\tu16 todo = (datasize < DRXDAP_MAX_RCHUNKSIZE ?\n\t\t\t      datasize : DRXDAP_MAX_RCHUNKSIZE);\n\n\t\tbufx = 0;\n\n\t\taddr &= ~DRXDAP_FASI_FLAGS;\n\t\taddr |= flags;\n\n#if ((DRXDAPFASI_LONG_ADDR_ALLOWED == 1) && (DRXDAPFASI_SHORT_ADDR_ALLOWED == 1))\n\t\t \n\t\tif (DRXDAP_FASI_LONG_FORMAT(addr)) {\n#endif\n#if (DRXDAPFASI_LONG_ADDR_ALLOWED == 1)\n\t\t\tbuf[bufx++] = (u8) (((addr << 1) & 0xFF) | 0x01);\n\t\t\tbuf[bufx++] = (u8) ((addr >> 16) & 0xFF);\n\t\t\tbuf[bufx++] = (u8) ((addr >> 24) & 0xFF);\n\t\t\tbuf[bufx++] = (u8) ((addr >> 7) & 0xFF);\n#endif\n#if ((DRXDAPFASI_LONG_ADDR_ALLOWED == 1) && (DRXDAPFASI_SHORT_ADDR_ALLOWED == 1))\n\t\t} else {\n#endif\n#if (DRXDAPFASI_SHORT_ADDR_ALLOWED == 1)\n\t\t\tbuf[bufx++] = (u8) ((addr << 1) & 0xFF);\n\t\t\tbuf[bufx++] =\n\t\t\t    (u8) (((addr >> 16) & 0x0F) |\n\t\t\t\t    ((addr >> 18) & 0xF0));\n#endif\n#if ((DRXDAPFASI_LONG_ADDR_ALLOWED == 1) && (DRXDAPFASI_SHORT_ADDR_ALLOWED == 1))\n\t\t}\n#endif\n\n#if DRXDAP_SINGLE_MASTER\n\t\t \n\t\trc = drxbsp_i2c_write_read(dev_addr, bufx, buf,\n\t\t\t\t\t   NULL, 0, NULL);\n\t\tif (rc == 0)\n\t\t\trc = drxbsp_i2c_write_read(NULL, 0, NULL, dev_addr, todo, data);\n#else\n\t\t \n\t\trc = drxbsp_i2c_write_read(dev_addr, bufx, buf, dev_addr, todo,\n\t\t\t\t\t  data);\n#endif\n\t\tdata += todo;\n\t\taddr += (todo >> 1);\n\t\tdatasize -= todo;\n\t} while (datasize && rc == 0);\n\n\treturn rc;\n}\n\n\n \n\nstatic int drxdap_fasi_read_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t u32 addr,\n\t\t\t\t\t u16 *data, u32 flags)\n{\n\tu8 buf[sizeof(*data)];\n\tint rc;\n\n\tif (!data)\n\t\treturn -EINVAL;\n\n\trc = drxdap_fasi_read_block(dev_addr, addr, sizeof(*data), buf, flags);\n\t*data = buf[0] + (((u16) buf[1]) << 8);\n\treturn rc;\n}\n\n \n\nstatic int drxdap_fasi_read_reg32(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t u32 addr,\n\t\t\t\t\t u32 *data, u32 flags)\n{\n\tu8 buf[sizeof(*data)];\n\tint rc;\n\n\tif (!data)\n\t\treturn -EINVAL;\n\n\trc = drxdap_fasi_read_block(dev_addr, addr, sizeof(*data), buf, flags);\n\t*data = (((u32) buf[0]) << 0) +\n\t    (((u32) buf[1]) << 8) +\n\t    (((u32) buf[2]) << 16) + (((u32) buf[3]) << 24);\n\treturn rc;\n}\n\n \n\nstatic int drxdap_fasi_write_block(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t  u32 addr,\n\t\t\t\t\t  u16 datasize,\n\t\t\t\t\t  u8 *data, u32 flags)\n{\n\tu8 buf[DRXDAP_MAX_WCHUNKSIZE];\n\tint st = -EIO;\n\tint first_err = 0;\n\tu16 overhead_size = 0;\n\tu16 block_size = 0;\n\n\t \n\tif (dev_addr == NULL)\n\t\treturn -EINVAL;\n\n\toverhead_size = (IS_I2C_10BIT(dev_addr->i2c_addr) ? 2 : 1) +\n\t    (DRXDAP_FASI_LONG_FORMAT(addr) ? 4 : 2);\n\n\tif ((DRXDAP_FASI_OFFSET_TOO_LARGE(addr)) ||\n\t    ((!(DRXDAPFASI_LONG_ADDR_ALLOWED)) &&\n\t     DRXDAP_FASI_LONG_FORMAT(addr)) ||\n\t    (overhead_size > (DRXDAP_MAX_WCHUNKSIZE)) ||\n\t    ((datasize != 0) && (data == NULL)) || ((datasize & 1) == 1))\n\t\treturn -EINVAL;\n\n\tflags &= DRXDAP_FASI_FLAGS;\n\tflags &= ~DRXDAP_FASI_MODEFLAGS;\n#if DRXDAP_SINGLE_MASTER\n\tflags |= DRXDAP_FASI_SINGLE_MASTER;\n#endif\n\n\t \n\tblock_size = ((DRXDAP_MAX_WCHUNKSIZE) - overhead_size) & ~1;\n\tdo {\n\t\tu16 todo = 0;\n\t\tu16 bufx = 0;\n\n\t\t \n\t\taddr &= ~DRXDAP_FASI_FLAGS;\n\t\taddr |= flags;\n#if (((DRXDAPFASI_LONG_ADDR_ALLOWED) == 1) && ((DRXDAPFASI_SHORT_ADDR_ALLOWED) == 1))\n\t\t \n\t\tif (DRXDAP_FASI_LONG_FORMAT(addr)) {\n#endif\n#if ((DRXDAPFASI_LONG_ADDR_ALLOWED) == 1)\n\t\t\tbuf[bufx++] = (u8) (((addr << 1) & 0xFF) | 0x01);\n\t\t\tbuf[bufx++] = (u8) ((addr >> 16) & 0xFF);\n\t\t\tbuf[bufx++] = (u8) ((addr >> 24) & 0xFF);\n\t\t\tbuf[bufx++] = (u8) ((addr >> 7) & 0xFF);\n#endif\n#if (((DRXDAPFASI_LONG_ADDR_ALLOWED) == 1) && ((DRXDAPFASI_SHORT_ADDR_ALLOWED) == 1))\n\t\t} else {\n#endif\n#if ((DRXDAPFASI_SHORT_ADDR_ALLOWED) == 1)\n\t\t\tbuf[bufx++] = (u8) ((addr << 1) & 0xFF);\n\t\t\tbuf[bufx++] =\n\t\t\t    (u8) (((addr >> 16) & 0x0F) |\n\t\t\t\t    ((addr >> 18) & 0xF0));\n#endif\n#if (((DRXDAPFASI_LONG_ADDR_ALLOWED) == 1) && ((DRXDAPFASI_SHORT_ADDR_ALLOWED) == 1))\n\t\t}\n#endif\n\n\t\t \n\t\ttodo = (block_size < datasize ? block_size : datasize);\n\t\tif (todo == 0) {\n\t\t\tu16 overhead_size_i2c_addr = 0;\n\t\t\tu16 data_block_size = 0;\n\n\t\t\toverhead_size_i2c_addr =\n\t\t\t    (IS_I2C_10BIT(dev_addr->i2c_addr) ? 2 : 1);\n\t\t\tdata_block_size =\n\t\t\t    (DRXDAP_MAX_WCHUNKSIZE - overhead_size_i2c_addr) & ~1;\n\n\t\t\t \n\t\t\tst = drxbsp_i2c_write_read(dev_addr,\n\t\t\t\t\t\t  (u16) (bufx),\n\t\t\t\t\t\t  buf,\n\t\t\t\t\t\t  (struct i2c_device_addr *)(NULL),\n\t\t\t\t\t\t  0, (u8 *)(NULL));\n\n\t\t\tif ((st != 0) && (first_err == 0)) {\n\t\t\t\t \n\t\t\t\tfirst_err = st;\n\t\t\t}\n\t\t\tbufx = 0;\n\t\t\ttodo =\n\t\t\t    (data_block_size <\n\t\t\t     datasize ? data_block_size : datasize);\n\t\t}\n\t\tmemcpy(&buf[bufx], data, todo);\n\t\t \n\t\tst = drxbsp_i2c_write_read(dev_addr,\n\t\t\t\t\t  (u16) (bufx + todo),\n\t\t\t\t\t  buf,\n\t\t\t\t\t  (struct i2c_device_addr *)(NULL),\n\t\t\t\t\t  0, (u8 *)(NULL));\n\n\t\tif ((st != 0) && (first_err == 0)) {\n\t\t\t \n\t\t\tfirst_err = st;\n\t\t}\n\t\tdatasize -= todo;\n\t\tdata += todo;\n\t\taddr += (todo >> 1);\n\t} while (datasize);\n\n\treturn first_err;\n}\n\n \n\nstatic int drxdap_fasi_write_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t  u32 addr,\n\t\t\t\t\t  u16 data, u32 flags)\n{\n\tu8 buf[sizeof(data)];\n\n\tbuf[0] = (u8) ((data >> 0) & 0xFF);\n\tbuf[1] = (u8) ((data >> 8) & 0xFF);\n\n\treturn drxdap_fasi_write_block(dev_addr, addr, sizeof(data), buf, flags);\n}\n\n \n\nstatic int drxdap_fasi_read_modify_write_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t\t    u32 waddr,\n\t\t\t\t\t\t    u32 raddr,\n\t\t\t\t\t\t    u16 wdata, u16 *rdata)\n{\n\tint rc = -EIO;\n\n#if (DRXDAPFASI_LONG_ADDR_ALLOWED == 1)\n\tif (rdata == NULL)\n\t\treturn -EINVAL;\n\n\trc = drxdap_fasi_write_reg16(dev_addr, waddr, wdata, DRXDAP_FASI_RMW);\n\tif (rc == 0)\n\t\trc = drxdap_fasi_read_reg16(dev_addr, raddr, rdata, 0);\n#endif\n\n\treturn rc;\n}\n\n \n\nstatic int drxdap_fasi_write_reg32(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t  u32 addr,\n\t\t\t\t\t  u32 data, u32 flags)\n{\n\tu8 buf[sizeof(data)];\n\n\tbuf[0] = (u8) ((data >> 0) & 0xFF);\n\tbuf[1] = (u8) ((data >> 8) & 0xFF);\n\tbuf[2] = (u8) ((data >> 16) & 0xFF);\n\tbuf[3] = (u8) ((data >> 24) & 0xFF);\n\n\treturn drxdap_fasi_write_block(dev_addr, addr, sizeof(data), buf, flags);\n}\n\n \n\n \n\n \n#if (DRXDAPFASI_LONG_ADDR_ALLOWED == 0)\nstatic int drxj_dap_rm_write_reg16short(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t      u32 waddr,\n\t\t\t\t\t      u32 raddr,\n\t\t\t\t\t      u16 wdata, u16 *rdata)\n{\n\tint rc;\n\n\tif (rdata == NULL)\n\t\treturn -EINVAL;\n\n\t \n\trc = drxdap_fasi_write_reg16(dev_addr,\n\t\t\t\t\t      SIO_HI_RA_RAM_S0_FLG_ACC__A,\n\t\t\t\t\t      SIO_HI_RA_RAM_S0_FLG_ACC_S0_RWM__M,\n\t\t\t\t\t      0x0000);\n\tif (rc == 0) {\n\t\t \n\t\trc = drxdap_fasi_write_reg16(dev_addr, waddr, wdata,\n\t\t\t\t\t\t      0x0000);\n\t}\n\tif (rc == 0) {\n\t\t \n\t\trc = drxdap_fasi_read_reg16(dev_addr, raddr, rdata,\n\t\t\t\t\t\t     0x0000);\n\t}\n\tif (rc == 0) {\n\t\t \n\t\trc = drxdap_fasi_write_reg16(dev_addr,\n\t\t\t\t\t\t      SIO_HI_RA_RAM_S0_FLG_ACC__A,\n\t\t\t\t\t\t      0, 0x0000);\n\t}\n\n\treturn rc;\n}\n#endif\n\n \n\nstatic int drxj_dap_read_modify_write_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t\t u32 waddr,\n\t\t\t\t\t\t u32 raddr,\n\t\t\t\t\t\t u16 wdata, u16 *rdata)\n{\n\t \n#if (DRXDAPFASI_LONG_ADDR_ALLOWED == 1)\n\treturn drxdap_fasi_read_modify_write_reg16(dev_addr,\n\t\t\t\t\t\t\t  waddr,\n\t\t\t\t\t\t\t  raddr, wdata, rdata);\n#else\n\treturn drxj_dap_rm_write_reg16short(dev_addr, waddr, raddr, wdata, rdata);\n#endif\n}\n\n\n \n\n \nstatic int drxj_dap_read_aud_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t u32 addr, u16 *data)\n{\n\tu32 start_timer = 0;\n\tu32 current_timer = 0;\n\tu32 delta_timer = 0;\n\tu16 tr_status = 0;\n\tint stat = -EIO;\n\n\t \n\tif (DRXDAP_FASI_ADDR2BANK(addr) == 3) {\n\t\tstat = -EINVAL;\n\t} else {\n\t\tconst u32 write_bit = ((dr_xaddr_t) 1) << 16;\n\n\t\t \n\t\taddr &= (~write_bit);\n\n\t\t \n\t\tstart_timer = jiffies_to_msecs(jiffies);\n\t\tdo {\n\t\t\t \n\t\t\tstat = drxj_dap_read_modify_write_reg16(dev_addr,\n\t\t\t\t\t\t\t     addr,\n\t\t\t\t\t\t\t     SIO_HI_RA_RAM_S0_RMWBUF__A,\n\t\t\t\t\t\t\t     0x0000, &tr_status);\n\n\t\t\tif (stat != 0)\n\t\t\t\tbreak;\n\n\t\t\tcurrent_timer = jiffies_to_msecs(jiffies);\n\t\t\tdelta_timer = current_timer - start_timer;\n\t\t\tif (delta_timer > DRXJ_DAP_AUDTRIF_TIMEOUT) {\n\t\t\t\tstat = -EIO;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t} while (((tr_status & AUD_TOP_TR_CTR_FIFO_LOCK__M) ==\n\t\t\t  AUD_TOP_TR_CTR_FIFO_LOCK_LOCKED) ||\n\t\t\t ((tr_status & AUD_TOP_TR_CTR_FIFO_FULL__M) ==\n\t\t\t  AUD_TOP_TR_CTR_FIFO_FULL_FULL));\n\t}\t\t\t \n\n\t \n\tif (stat == 0) {\n\t\tstart_timer = jiffies_to_msecs(jiffies);\n\n\t\twhile ((tr_status & AUD_TOP_TR_CTR_FIFO_RD_RDY__M) !=\n\t\t       AUD_TOP_TR_CTR_FIFO_RD_RDY_READY) {\n\t\t\tstat = drxj_dap_read_reg16(dev_addr,\n\t\t\t\t\t\t  AUD_TOP_TR_CTR__A,\n\t\t\t\t\t\t  &tr_status, 0x0000);\n\t\t\tif (stat != 0)\n\t\t\t\tbreak;\n\n\t\t\tcurrent_timer = jiffies_to_msecs(jiffies);\n\t\t\tdelta_timer = current_timer - start_timer;\n\t\t\tif (delta_timer > DRXJ_DAP_AUDTRIF_TIMEOUT) {\n\t\t\t\tstat = -EIO;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\t\t \n\t}\n\n\t \n\tif (stat == 0)\n\t\tstat = drxj_dap_read_modify_write_reg16(dev_addr,\n\t\t\t\t\t\t     AUD_TOP_TR_RD_REG__A,\n\t\t\t\t\t\t     SIO_HI_RA_RAM_S0_RMWBUF__A,\n\t\t\t\t\t\t     0x0000, data);\n\treturn stat;\n}\n\n \n\nstatic int drxj_dap_read_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t      u32 addr,\n\t\t\t\t      u16 *data, u32 flags)\n{\n\tint stat = -EIO;\n\n\t \n\tif ((dev_addr == NULL) || (data == NULL))\n\t\treturn -EINVAL;\n\n\tif (is_handled_by_aud_tr_if(addr))\n\t\tstat = drxj_dap_read_aud_reg16(dev_addr, addr, data);\n\telse\n\t\tstat = drxdap_fasi_read_reg16(dev_addr, addr, data, flags);\n\n\treturn stat;\n}\n \n\n \nstatic int drxj_dap_write_aud_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t  u32 addr, u16 data)\n{\n\tint stat = -EIO;\n\n\t \n\tif (DRXDAP_FASI_ADDR2BANK(addr) == 2) {\n\t\tstat = -EINVAL;\n\t} else {\n\t\tu32 start_timer = 0;\n\t\tu32 current_timer = 0;\n\t\tu32 delta_timer = 0;\n\t\tu16 tr_status = 0;\n\t\tconst u32 write_bit = ((dr_xaddr_t) 1) << 16;\n\n\t\t \n\t\taddr |= write_bit;\n\t\tstart_timer = jiffies_to_msecs(jiffies);\n\t\tdo {\n\t\t\t \n\t\t\tstat = drxj_dap_read_modify_write_reg16(dev_addr,\n\t\t\t\t\t\t\t     addr,\n\t\t\t\t\t\t\t     SIO_HI_RA_RAM_S0_RMWBUF__A,\n\t\t\t\t\t\t\t     data, &tr_status);\n\t\t\tif (stat != 0)\n\t\t\t\tbreak;\n\n\t\t\tcurrent_timer = jiffies_to_msecs(jiffies);\n\t\t\tdelta_timer = current_timer - start_timer;\n\t\t\tif (delta_timer > DRXJ_DAP_AUDTRIF_TIMEOUT) {\n\t\t\t\tstat = -EIO;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t} while (((tr_status & AUD_TOP_TR_CTR_FIFO_LOCK__M) ==\n\t\t\t  AUD_TOP_TR_CTR_FIFO_LOCK_LOCKED) ||\n\t\t\t ((tr_status & AUD_TOP_TR_CTR_FIFO_FULL__M) ==\n\t\t\t  AUD_TOP_TR_CTR_FIFO_FULL_FULL));\n\n\t}\t\t\t \n\n\treturn stat;\n}\n\n \n\nstatic int drxj_dap_write_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t       u32 addr,\n\t\t\t\t       u16 data, u32 flags)\n{\n\tint stat = -EIO;\n\n\t \n\tif (dev_addr == NULL)\n\t\treturn -EINVAL;\n\n\tif (is_handled_by_aud_tr_if(addr))\n\t\tstat = drxj_dap_write_aud_reg16(dev_addr, addr, data);\n\telse\n\t\tstat = drxdap_fasi_write_reg16(dev_addr,\n\t\t\t\t\t\t\t    addr, data, flags);\n\n\treturn stat;\n}\n\n \n\n \n#define SIO_HI_RA_RAM_USR_BEGIN__A 0x420040\n#define SIO_HI_RA_RAM_USR_END__A   0x420060\n\n#define DRXJ_HI_ATOMIC_BUF_START (SIO_HI_RA_RAM_USR_BEGIN__A)\n#define DRXJ_HI_ATOMIC_BUF_END   (SIO_HI_RA_RAM_USR_BEGIN__A + 7)\n#define DRXJ_HI_ATOMIC_READ      SIO_HI_RA_RAM_PAR_3_ACP_RW_READ\n#define DRXJ_HI_ATOMIC_WRITE     SIO_HI_RA_RAM_PAR_3_ACP_RW_WRITE\n\n \nstatic\nint drxj_dap_atomic_read_write_block(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t  u32 addr,\n\t\t\t\t\t  u16 datasize,\n\t\t\t\t\t  u8 *data, bool read_flag)\n{\n\tstruct drxj_hi_cmd hi_cmd;\n\tint rc;\n\tu16 word;\n\tu16 dummy = 0;\n\tu16 i = 0;\n\n\t \n\tif (!data || !dev_addr || ((datasize % 2)) || ((datasize / 2) > 8))\n\t\treturn -EINVAL;\n\n\t \n\thi_cmd.cmd = SIO_HI_RA_RAM_CMD_ATOMIC_COPY;\n\thi_cmd.param1 =\n\t    (u16) ((DRXDAP_FASI_ADDR2BLOCK(DRXJ_HI_ATOMIC_BUF_START) << 6) +\n\t\t     DRXDAP_FASI_ADDR2BANK(DRXJ_HI_ATOMIC_BUF_START));\n\thi_cmd.param2 =\n\t    (u16) DRXDAP_FASI_ADDR2OFFSET(DRXJ_HI_ATOMIC_BUF_START);\n\thi_cmd.param3 = (u16) ((datasize / 2) - 1);\n\tif (!read_flag)\n\t\thi_cmd.param3 |= DRXJ_HI_ATOMIC_WRITE;\n\telse\n\t\thi_cmd.param3 |= DRXJ_HI_ATOMIC_READ;\n\thi_cmd.param4 = (u16) ((DRXDAP_FASI_ADDR2BLOCK(addr) << 6) +\n\t\t\t\tDRXDAP_FASI_ADDR2BANK(addr));\n\thi_cmd.param5 = (u16) DRXDAP_FASI_ADDR2OFFSET(addr);\n\n\tif (!read_flag) {\n\t\t \n\t\tfor (i = 0; i < (datasize / 2); i++) {\n\n\t\t\tword = ((u16) data[2 * i]);\n\t\t\tword += (((u16) data[(2 * i) + 1]) << 8);\n\t\t\tdrxj_dap_write_reg16(dev_addr,\n\t\t\t\t\t     (DRXJ_HI_ATOMIC_BUF_START + i),\n\t\t\t\t\t    word, 0);\n\t\t}\n\t}\n\n\trc = hi_command(dev_addr, &hi_cmd, &dummy);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tif (read_flag) {\n\t\t \n\t\tfor (i = 0; i < (datasize / 2); i++) {\n\t\t\trc = drxj_dap_read_reg16(dev_addr,\n\t\t\t\t\t\t (DRXJ_HI_ATOMIC_BUF_START + i),\n\t\t\t\t\t\t &word, 0);\n\t\t\tif (rc) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata[2 * i] = (u8) (word & 0xFF);\n\t\t\tdata[(2 * i) + 1] = (u8) (word >> 8);\n\t\t}\n\t}\n\n\treturn 0;\n\nrw_error:\n\treturn rc;\n\n}\n\n \n\n \nstatic\nint drxj_dap_atomic_read_reg32(struct i2c_device_addr *dev_addr,\n\t\t\t\t     u32 addr,\n\t\t\t\t     u32 *data, u32 flags)\n{\n\tu8 buf[sizeof(*data)] = { 0 };\n\tint rc;\n\tu32 word = 0;\n\n\tif (!data)\n\t\treturn -EINVAL;\n\n\trc = drxj_dap_atomic_read_write_block(dev_addr, addr,\n\t\t\t\t\t      sizeof(*data), buf, true);\n\n\tif (rc < 0)\n\t\treturn 0;\n\n\tword = (u32) buf[3];\n\tword <<= 8;\n\tword |= (u32) buf[2];\n\tword <<= 8;\n\tword |= (u32) buf[1];\n\tword <<= 8;\n\tword |= (u32) buf[0];\n\n\t*data = word;\n\n\treturn rc;\n}\n\n \n\n \n \n \n\n \n \n \n \n \n\n \nstatic int hi_cfg_command(const struct drx_demod_instance *demod)\n{\n\tstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\n\tstruct drxj_hi_cmd hi_cmd;\n\tu16 result = 0;\n\tint rc;\n\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\thi_cmd.cmd = SIO_HI_RA_RAM_CMD_CONFIG;\n\thi_cmd.param1 = SIO_HI_RA_RAM_PAR_1_PAR1_SEC_KEY;\n\thi_cmd.param2 = ext_attr->hi_cfg_timing_div;\n\thi_cmd.param3 = ext_attr->hi_cfg_bridge_delay;\n\thi_cmd.param4 = ext_attr->hi_cfg_wake_up_key;\n\thi_cmd.param5 = ext_attr->hi_cfg_ctrl;\n\thi_cmd.param6 = ext_attr->hi_cfg_transmit;\n\n\trc = hi_command(demod->my_i2c_dev_addr, &hi_cmd, &result);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\text_attr->hi_cfg_ctrl &= (~(SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ));\n\n\treturn 0;\n\nrw_error:\n\treturn rc;\n}\n\n \nstatic int\nhi_command(struct i2c_device_addr *dev_addr, const struct drxj_hi_cmd *cmd, u16 *result)\n{\n\tu16 wait_cmd = 0;\n\tu16 nr_retries = 0;\n\tbool powerdown_cmd = false;\n\tint rc;\n\n\t \n\tswitch (cmd->cmd) {\n\n\tcase SIO_HI_RA_RAM_CMD_CONFIG:\n\tcase SIO_HI_RA_RAM_CMD_ATOMIC_COPY:\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_6__A, cmd->param6, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_5__A, cmd->param5, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_4__A, cmd->param4, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_3__A, cmd->param3, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tfallthrough;\n\tcase SIO_HI_RA_RAM_CMD_BRDCTRL:\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_2__A, cmd->param2, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_PAR_1__A, cmd->param1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tfallthrough;\n\tcase SIO_HI_RA_RAM_CMD_NULL:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SIO_HI_RA_RAM_CMD__A, cmd->cmd, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tif ((cmd->cmd) == SIO_HI_RA_RAM_CMD_RESET)\n\t\tmsleep(1);\n\n\t \n\tpowerdown_cmd = (bool) ((cmd->cmd == SIO_HI_RA_RAM_CMD_CONFIG) &&\n\t\t\t\t  (((cmd->\n\t\t\t\t     param5) & SIO_HI_RA_RAM_PAR_5_CFG_SLEEP__M)\n\t\t\t\t   == SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ));\n\tif (!powerdown_cmd) {\n\t\t \n\t\tdo {\n\t\t\tnr_retries++;\n\t\t\tif (nr_retries > DRXJ_MAX_RETRIES) {\n\t\t\t\trc = -ETIMEDOUT;\n\t\t\t\tpr_err(\"timeout\\n\");\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\trc = drxj_dap_read_reg16(dev_addr, SIO_HI_RA_RAM_CMD__A, &wait_cmd, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t} while (wait_cmd != 0);\n\n\t\t \n\t\trc = drxj_dap_read_reg16(dev_addr, SIO_HI_RA_RAM_RES__A, result, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t}\n\t \n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int init_hi(const struct drx_demod_instance *demod)\n{\n\tstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\n\tstruct drx_common_attr *common_attr = (struct drx_common_attr *) (NULL);\n\tstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\n\tint rc;\n\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\tdev_addr = demod->my_i2c_dev_addr;\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, 0x4301D7, 0x801, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\t \n\text_attr->hi_cfg_timing_div =\n\t    (u16) ((common_attr->sys_clock_freq / 1000) * HI_I2C_DELAY) / 1000;\n\t \n\tif ((ext_attr->hi_cfg_timing_div) > SIO_HI_RA_RAM_PAR_2_CFG_DIV__M)\n\t\text_attr->hi_cfg_timing_div = SIO_HI_RA_RAM_PAR_2_CFG_DIV__M;\n\t \n\t \n\t \n\text_attr->hi_cfg_bridge_delay =\n\t    (u16) ((common_attr->osc_clock_freq / 1000) * HI_I2C_BRIDGE_DELAY) /\n\t    1000;\n\t \n\tif ((ext_attr->hi_cfg_bridge_delay) > SIO_HI_RA_RAM_PAR_3_CFG_DBL_SDA__M)\n\t\text_attr->hi_cfg_bridge_delay = SIO_HI_RA_RAM_PAR_3_CFG_DBL_SDA__M;\n\t \n\text_attr->hi_cfg_bridge_delay += ((ext_attr->hi_cfg_bridge_delay) <<\n\t\t\t\t      SIO_HI_RA_RAM_PAR_3_CFG_DBL_SCL__B);\n\t \n\text_attr->hi_cfg_wake_up_key = DRXJ_WAKE_UP_KEY;\n\t \n\text_attr->hi_cfg_ctrl = (SIO_HI_RA_RAM_PAR_5_CFG_SLV0_SLAVE);\n\t \n\text_attr->hi_cfg_transmit = SIO_HI_RA_RAM_PAR_6__PRE;\n\n\trc = hi_cfg_command(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\n\nrw_error:\n\treturn rc;\n}\n\n \n \n \n\n \n \n \n \n \n\n \nstatic int get_device_capabilities(struct drx_demod_instance *demod)\n{\n\tstruct drx_common_attr *common_attr = (struct drx_common_attr *) (NULL);\n\tstruct drxj_data *ext_attr = (struct drxj_data *) NULL;\n\tstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\n\tu16 sio_pdr_ohw_cfg = 0;\n\tu32 sio_top_jtagid_lo = 0;\n\tu16 bid = 0;\n\tint rc;\n\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tdev_addr = demod->my_i2c_dev_addr;\n\n\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_read_reg16(dev_addr, SIO_PDR_OHW_CFG__A, &sio_pdr_ohw_cfg, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY__PRE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tswitch ((sio_pdr_ohw_cfg & SIO_PDR_OHW_CFG_FREF_SEL__M)) {\n\tcase 0:\n\t\t \n\t\tbreak;\n\tcase 1:\n\t\t \n\t\tcommon_attr->osc_clock_freq = 27000;\n\t\tbreak;\n\tcase 2:\n\t\t \n\t\tcommon_attr->osc_clock_freq = 20250;\n\t\tbreak;\n\tcase 3:\n\t\t \n\t\tcommon_attr->osc_clock_freq = 4000;\n\t\tbreak;\n\tdefault:\n\t\treturn -EIO;\n\t}\n\n\t \n\trc = drxdap_fasi_read_reg32(dev_addr, SIO_TOP_JTAGID_LO__A, &sio_top_jtagid_lo, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\text_attr->mfx = (u8) ((sio_top_jtagid_lo >> 29) & 0xF);\n\n\tswitch ((sio_top_jtagid_lo >> 12) & 0xFF) {\n\tcase 0x31:\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_read_reg16(dev_addr, SIO_PDR_UIO_IN_HI__A, &bid, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbid = (bid >> 10) & 0xf;\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY__PRE, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\text_attr->has_lna = true;\n\t\text_attr->has_ntsc = false;\n\t\text_attr->has_btsc = false;\n\t\text_attr->has_oob = false;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = false;\n\t\text_attr->has_gpio = false;\n\t\text_attr->has_irqn = false;\n\t\tbreak;\n\tcase 0x33:\n\t\text_attr->has_lna = false;\n\t\text_attr->has_ntsc = false;\n\t\text_attr->has_btsc = false;\n\t\text_attr->has_oob = false;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = false;\n\t\text_attr->has_gpio = false;\n\t\text_attr->has_irqn = false;\n\t\tbreak;\n\tcase 0x45:\n\t\text_attr->has_lna = true;\n\t\text_attr->has_ntsc = true;\n\t\text_attr->has_btsc = false;\n\t\text_attr->has_oob = false;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = true;\n\t\text_attr->has_gpio = true;\n\t\text_attr->has_irqn = false;\n\t\tbreak;\n\tcase 0x46:\n\t\text_attr->has_lna = false;\n\t\text_attr->has_ntsc = true;\n\t\text_attr->has_btsc = false;\n\t\text_attr->has_oob = false;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = true;\n\t\text_attr->has_gpio = true;\n\t\text_attr->has_irqn = false;\n\t\tbreak;\n\tcase 0x41:\n\t\text_attr->has_lna = true;\n\t\text_attr->has_ntsc = true;\n\t\text_attr->has_btsc = true;\n\t\text_attr->has_oob = false;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = true;\n\t\text_attr->has_gpio = true;\n\t\text_attr->has_irqn = false;\n\t\tbreak;\n\tcase 0x43:\n\t\text_attr->has_lna = false;\n\t\text_attr->has_ntsc = true;\n\t\text_attr->has_btsc = true;\n\t\text_attr->has_oob = false;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = true;\n\t\text_attr->has_gpio = true;\n\t\text_attr->has_irqn = false;\n\t\tbreak;\n\tcase 0x32:\n\t\text_attr->has_lna = true;\n\t\text_attr->has_ntsc = false;\n\t\text_attr->has_btsc = false;\n\t\text_attr->has_oob = true;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = true;\n\t\text_attr->has_gpio = true;\n\t\text_attr->has_irqn = true;\n\t\tbreak;\n\tcase 0x34:\n\t\text_attr->has_lna = false;\n\t\text_attr->has_ntsc = true;\n\t\text_attr->has_btsc = true;\n\t\text_attr->has_oob = true;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = true;\n\t\text_attr->has_gpio = true;\n\t\text_attr->has_irqn = true;\n\t\tbreak;\n\tcase 0x42:\n\t\text_attr->has_lna = true;\n\t\text_attr->has_ntsc = true;\n\t\text_attr->has_btsc = true;\n\t\text_attr->has_oob = true;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = true;\n\t\text_attr->has_gpio = true;\n\t\text_attr->has_irqn = true;\n\t\tbreak;\n\tcase 0x44:\n\t\text_attr->has_lna = false;\n\t\text_attr->has_ntsc = true;\n\t\text_attr->has_btsc = true;\n\t\text_attr->has_oob = true;\n\t\text_attr->has_smatx = true;\n\t\text_attr->has_smarx = true;\n\t\text_attr->has_gpio = true;\n\t\text_attr->has_irqn = true;\n\t\tbreak;\n\tdefault:\n\t\t \n\t\treturn -EIO;\n\t\tbreak;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n#ifndef DRXJ_MAX_RETRIES_POWERUP\n#define DRXJ_MAX_RETRIES_POWERUP 10\n#endif\n\nstatic int power_up_device(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\n\tu8 data = 0;\n\tu16 retry_count = 0;\n\tstruct i2c_device_addr wake_up_addr;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\twake_up_addr.i2c_addr = DRXJ_WAKE_UP_KEY;\n\twake_up_addr.i2c_dev_id = dev_addr->i2c_dev_id;\n\twake_up_addr.user_data = dev_addr->user_data;\n\t \n\tdo {\n\t\tdata = 0;\n\t\tdrxbsp_i2c_write_read(&wake_up_addr, 1, &data,\n\t\t\t\t      (struct i2c_device_addr *)(NULL), 0,\n\t\t\t\t     (u8 *)(NULL));\n\t\tmsleep(10);\n\t\tretry_count++;\n\t} while ((drxbsp_i2c_write_read\n\t\t  ((struct i2c_device_addr *) (NULL), 0, (u8 *)(NULL), dev_addr, 1,\n\t\t   &data)\n\t\t  != 0) && (retry_count < DRXJ_MAX_RETRIES_POWERUP));\n\n\t \n\tmsleep(10);\n\n\tif (retry_count == DRXJ_MAX_RETRIES_POWERUP)\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\n \n \n \n \nstatic int\nctrl_set_cfg_mpeg_output(struct drx_demod_instance *demod, struct drx_cfg_mpeg_output *cfg_data)\n{\n\tstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\n\tstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\n\tstruct drx_common_attr *common_attr = (struct drx_common_attr *) (NULL);\n\tint rc;\n\tu16 fec_oc_reg_mode = 0;\n\tu16 fec_oc_reg_ipr_mode = 0;\n\tu16 fec_oc_reg_ipr_invert = 0;\n\tu32 max_bit_rate = 0;\n\tu32 rcn_rate = 0;\n\tu32 nr_bits = 0;\n\tu16 sio_pdr_md_cfg = 0;\n\t \n\tu16 invert_data_mask =\n\t    FEC_OC_IPR_INVERT_MD7__M | FEC_OC_IPR_INVERT_MD6__M |\n\t    FEC_OC_IPR_INVERT_MD5__M | FEC_OC_IPR_INVERT_MD4__M |\n\t    FEC_OC_IPR_INVERT_MD3__M | FEC_OC_IPR_INVERT_MD2__M |\n\t    FEC_OC_IPR_INVERT_MD1__M | FEC_OC_IPR_INVERT_MD0__M;\n\n\t \n\tif ((demod == NULL) || (cfg_data == NULL))\n\t\treturn -EINVAL;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\n\tif (cfg_data->enable_mpeg_output == true) {\n\t\t \n\t\tswitch (ext_attr->standard) {\n\t\tcase DRX_STANDARD_8VSB:\n\t\tcase DRX_STANDARD_ITU_A:\n\t\tcase DRX_STANDARD_ITU_B:\n\t\tcase DRX_STANDARD_ITU_C:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn 0;\n\t\t}\n\n\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_OCR_INVERT__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tswitch (ext_attr->standard) {\n\t\tcase DRX_STANDARD_8VSB:\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_FCT_USAGE__A, 7, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\t \n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_TMD_CTL_UPD_RATE__A, 10, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_TMD_INT_UPD_RATE__A, 10, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_AVR_PARM_A__A, 5, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_AVR_PARM_B__A, 7, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_RCN_GAIN__A, 10, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\t \n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_LWM__A, 3, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\t \n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_HWM__A, 5, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_STANDARD_ITU_A:\n\t\tcase DRX_STANDARD_ITU_C:\n\t\t\tswitch (ext_attr->constellation) {\n\t\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\t\tnr_bits = 8;\n\t\t\t\tbreak;\n\t\t\tcase DRX_CONSTELLATION_QAM128:\n\t\t\t\tnr_bits = 7;\n\t\t\t\tbreak;\n\t\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\t\tnr_bits = 6;\n\t\t\t\tbreak;\n\t\t\tcase DRX_CONSTELLATION_QAM32:\n\t\t\t\tnr_bits = 5;\n\t\t\t\tbreak;\n\t\t\tcase DRX_CONSTELLATION_QAM16:\n\t\t\t\tnr_bits = 4;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -EIO;\n\t\t\t}\t \n\t\t\t \n\t\t\t \n\t\t\tmax_bit_rate =\n\t\t\t    (ext_attr->curr_symbol_rate / 8) * nr_bits * 188;\n\t\t\tfallthrough;\t \n\t\tcase DRX_STANDARD_ITU_B:\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_FCT_USAGE__A, FEC_OC_FCT_USAGE__PRE, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_TMD_CTL_UPD_RATE__A, FEC_OC_TMD_CTL_UPD_RATE__PRE, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_TMD_INT_UPD_RATE__A, 5, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_AVR_PARM_A__A, FEC_OC_AVR_PARM_A__PRE, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_AVR_PARM_B__A, FEC_OC_AVR_PARM_B__PRE, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tif (cfg_data->static_clk == true) {\n\t\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_RCN_GAIN__A, 0xD, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_RCN_GAIN__A, FEC_OC_RCN_GAIN__PRE, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_LWM__A, 2, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_HWM__A, 12, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\t\t \n\n\t\t \n\t\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_MODE__A, &fec_oc_reg_mode, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_IPR_MODE__A, &fec_oc_reg_ipr_mode, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tif (cfg_data->insert_rs_byte == true) {\n\t\t\t \n\t\t\tfec_oc_reg_mode |= FEC_OC_MODE_PARITY__M;\n\t\t\t \n\t\t\tfec_oc_reg_ipr_mode |= FEC_OC_IPR_MODE_MVAL_DIS_PAR__M;\n\t\t\tswitch (ext_attr->standard) {\n\t\t\tcase DRX_STANDARD_8VSB:\n\t\t\t\trcn_rate = 0x004854D3;\n\t\t\t\tbreak;\n\t\t\tcase DRX_STANDARD_ITU_B:\n\t\t\t\tfec_oc_reg_mode |= FEC_OC_MODE_TRANSPARENT__M;\n\t\t\t\tswitch (ext_attr->constellation) {\n\t\t\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\t\t\trcn_rate = 0x008945E7;\n\t\t\t\t\tbreak;\n\t\t\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\t\t\trcn_rate = 0x005F64D4;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn -EIO;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase DRX_STANDARD_ITU_A:\n\t\t\tcase DRX_STANDARD_ITU_C:\n\t\t\t\t \n\t\t\t\trcn_rate =\n\t\t\t\t    (frac28\n\t\t\t\t     (max_bit_rate,\n\t\t\t\t      (u32) (common_attr->sys_clock_freq / 8))) /\n\t\t\t\t    188;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -EIO;\n\t\t\t}\t \n\t\t} else {\t \n\n\t\t\t \n\t\t\tfec_oc_reg_mode &= (~FEC_OC_MODE_PARITY__M);\n\t\t\t \n\t\t\tfec_oc_reg_ipr_mode &= (~FEC_OC_IPR_MODE_MVAL_DIS_PAR__M);\n\t\t\tswitch (ext_attr->standard) {\n\t\t\tcase DRX_STANDARD_8VSB:\n\t\t\t\trcn_rate = 0x0041605C;\n\t\t\t\tbreak;\n\t\t\tcase DRX_STANDARD_ITU_B:\n\t\t\t\tfec_oc_reg_mode &= (~FEC_OC_MODE_TRANSPARENT__M);\n\t\t\t\tswitch (ext_attr->constellation) {\n\t\t\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\t\t\trcn_rate = 0x0082D6A0;\n\t\t\t\t\tbreak;\n\t\t\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\t\t\trcn_rate = 0x005AEC1A;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn -EIO;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase DRX_STANDARD_ITU_A:\n\t\t\tcase DRX_STANDARD_ITU_C:\n\t\t\t\t \n\t\t\t\trcn_rate =\n\t\t\t\t    (frac28\n\t\t\t\t     (max_bit_rate,\n\t\t\t\t      (u32) (common_attr->sys_clock_freq / 8))) /\n\t\t\t\t    204;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -EIO;\n\t\t\t}\t \n\t\t}\n\n\t\tif (cfg_data->enable_parallel == true) {\t \n\t\t\tfec_oc_reg_ipr_mode &= (~(FEC_OC_IPR_MODE_SERIAL__M));\n\t\t} else {\t \n\t\t\tfec_oc_reg_ipr_mode |= FEC_OC_IPR_MODE_SERIAL__M;\n\t\t}\n\n\t\t \n\t\tif (cfg_data->invert_data == true)\n\t\t\tfec_oc_reg_ipr_invert |= invert_data_mask;\n\t\telse\n\t\t\tfec_oc_reg_ipr_invert &= (~(invert_data_mask));\n\n\t\tif (cfg_data->invert_err == true)\n\t\t\tfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MERR__M;\n\t\telse\n\t\t\tfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MERR__M));\n\n\t\tif (cfg_data->invert_str == true)\n\t\t\tfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MSTRT__M;\n\t\telse\n\t\t\tfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MSTRT__M));\n\n\t\tif (cfg_data->invert_val == true)\n\t\t\tfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MVAL__M;\n\t\telse\n\t\t\tfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MVAL__M));\n\n\t\tif (cfg_data->invert_clk == true)\n\t\t\tfec_oc_reg_ipr_invert |= FEC_OC_IPR_INVERT_MCLK__M;\n\t\telse\n\t\t\tfec_oc_reg_ipr_invert &= (~(FEC_OC_IPR_INVERT_MCLK__M));\n\n\n\t\tif (cfg_data->static_clk == true) {\t \n\t\t\tu32 dto_rate = 0;\n\t\t\tu32 bit_rate = 0;\n\t\t\tu16 fec_oc_dto_burst_len = 0;\n\t\t\tu16 fec_oc_dto_period = 0;\n\n\t\t\tfec_oc_dto_burst_len = FEC_OC_DTO_BURST_LEN__PRE;\n\n\t\t\tswitch (ext_attr->standard) {\n\t\t\tcase DRX_STANDARD_8VSB:\n\t\t\t\tfec_oc_dto_period = 4;\n\t\t\t\tif (cfg_data->insert_rs_byte == true)\n\t\t\t\t\tfec_oc_dto_burst_len = 208;\n\t\t\t\tbreak;\n\t\t\tcase DRX_STANDARD_ITU_A:\n\t\t\t\t{\n\t\t\t\t\tu32 symbol_rate_th = 6400000;\n\t\t\t\t\tif (cfg_data->insert_rs_byte == true) {\n\t\t\t\t\t\tfec_oc_dto_burst_len = 204;\n\t\t\t\t\t\tsymbol_rate_th = 5900000;\n\t\t\t\t\t}\n\t\t\t\t\tif (ext_attr->curr_symbol_rate >=\n\t\t\t\t\t    symbol_rate_th) {\n\t\t\t\t\t\tfec_oc_dto_period = 0;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfec_oc_dto_period = 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase DRX_STANDARD_ITU_B:\n\t\t\t\tfec_oc_dto_period = 1;\n\t\t\t\tif (cfg_data->insert_rs_byte == true)\n\t\t\t\t\tfec_oc_dto_burst_len = 128;\n\t\t\t\tbreak;\n\t\t\tcase DRX_STANDARD_ITU_C:\n\t\t\t\tfec_oc_dto_period = 1;\n\t\t\t\tif (cfg_data->insert_rs_byte == true)\n\t\t\t\t\tfec_oc_dto_burst_len = 204;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -EIO;\n\t\t\t}\n\t\t\tbit_rate =\n\t\t\t    common_attr->sys_clock_freq * 1000 / (fec_oc_dto_period +\n\t\t\t\t\t\t\t       2);\n\t\t\tdto_rate =\n\t\t\t    frac28(bit_rate, common_attr->sys_clock_freq * 1000);\n\t\t\tdto_rate >>= 3;\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_RATE_HI__A, (u16)((dto_rate >> 16) & FEC_OC_DTO_RATE_HI__M), 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_RATE_LO__A, (u16)(dto_rate & FEC_OC_DTO_RATE_LO_RATE_LO__M), 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_MODE__A, FEC_OC_DTO_MODE_DYNAMIC__M | FEC_OC_DTO_MODE_OFFSET_ENABLE__M, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_FCT_MODE__A, FEC_OC_FCT_MODE_RAT_ENA__M | FEC_OC_FCT_MODE_VIRT_ENA__M, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_BURST_LEN__A, fec_oc_dto_burst_len, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tif (ext_attr->mpeg_output_clock_rate != DRXJ_MPEGOUTPUT_CLOCK_RATE_AUTO)\n\t\t\t\tfec_oc_dto_period = ext_attr->mpeg_output_clock_rate - 1;\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_PERIOD__A, fec_oc_dto_period, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t} else {\t \n\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_DTO_MODE__A, FEC_OC_DTO_MODE_DYNAMIC__M, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_FCT_MODE__A, 0, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t}\n\n\t\trc = drxdap_fasi_write_reg32(dev_addr, FEC_OC_RCN_CTL_RATE_LO__A, rcn_rate, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_MODE__A, fec_oc_reg_mode, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_IPR_MODE__A, fec_oc_reg_ipr_mode, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_IPR_INVERT__A, fec_oc_reg_ipr_invert, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\t \n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0xFABA, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MSTRT_CFG__A, 0x0013, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MERR_CFG__A, 0x0013, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MCLK_CFG__A, MPEG_OUTPUT_CLK_DRIVE_STRENGTH << SIO_PDR_MCLK_CFG_DRIVE__B | 0x03 << SIO_PDR_MCLK_CFG_MODE__B, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MVAL_CFG__A, 0x0013, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tsio_pdr_md_cfg =\n\t\t    MPEG_SERIAL_OUTPUT_PIN_DRIVE_STRENGTH <<\n\t\t    SIO_PDR_MD0_CFG_DRIVE__B | 0x03 << SIO_PDR_MD0_CFG_MODE__B;\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD0_CFG__A, sio_pdr_md_cfg, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tif (cfg_data->enable_parallel == true) {\t \n\t\t\tsio_pdr_md_cfg =\n\t\t\t    MPEG_PARALLEL_OUTPUT_PIN_DRIVE_STRENGTH <<\n\t\t\t    SIO_PDR_MD0_CFG_DRIVE__B | 0x03 <<\n\t\t\t    SIO_PDR_MD0_CFG_MODE__B;\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD0_CFG__A, sio_pdr_md_cfg, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD1_CFG__A, sio_pdr_md_cfg, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD2_CFG__A, sio_pdr_md_cfg, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD3_CFG__A, sio_pdr_md_cfg, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD4_CFG__A, sio_pdr_md_cfg, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD5_CFG__A, sio_pdr_md_cfg, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD6_CFG__A, sio_pdr_md_cfg, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD7_CFG__A, sio_pdr_md_cfg, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t} else {\t \n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD1_CFG__A, 0x0000, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD2_CFG__A, 0x0000, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD3_CFG__A, 0x0000, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD4_CFG__A, 0x0000, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD5_CFG__A, 0x0000, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD6_CFG__A, 0x0000, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD7_CFG__A, 0x0000, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t}\n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MON_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t} else {\n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0xFABA, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MSTRT_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MERR_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MCLK_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MVAL_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD0_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD1_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD2_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD3_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD4_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD5_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD6_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MD7_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_MON_CFG__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\t \n\tcommon_attr->mpeg_cfg.enable_mpeg_output = cfg_data->enable_mpeg_output;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n\n \n \n \n\n \n \n \n\n \nstatic int set_mpegtei_handling(struct drx_demod_instance *demod)\n{\n\tstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\n\tstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\n\tint rc;\n\tu16 fec_oc_dpr_mode = 0;\n\tu16 fec_oc_snc_mode = 0;\n\tu16 fec_oc_ems_mode = 0;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_DPR_MODE__A, &fec_oc_dpr_mode, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_SNC_MODE__A, &fec_oc_snc_mode, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_EMS_MODE__A, &fec_oc_ems_mode, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tfec_oc_dpr_mode &= (~FEC_OC_DPR_MODE_ERR_DISABLE__M);\n\tfec_oc_snc_mode &= (~(FEC_OC_SNC_MODE_ERROR_CTL__M |\n\t\t\t   FEC_OC_SNC_MODE_CORR_DISABLE__M));\n\tfec_oc_ems_mode &= (~FEC_OC_EMS_MODE_MODE__M);\n\n\tif (ext_attr->disable_te_ihandling) {\n\t\t \n\t\tfec_oc_dpr_mode |= FEC_OC_DPR_MODE_ERR_DISABLE__M;\n\t\tfec_oc_snc_mode |= FEC_OC_SNC_MODE_CORR_DISABLE__M |\n\t\t    ((0x2) << (FEC_OC_SNC_MODE_ERROR_CTL__B));\n\t\tfec_oc_ems_mode |= ((0x01) << (FEC_OC_EMS_MODE_MODE__B));\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_DPR_MODE__A, fec_oc_dpr_mode, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_MODE__A, fec_oc_snc_mode, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_EMS_MODE__A, fec_oc_ems_mode, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n \nstatic int bit_reverse_mpeg_output(struct drx_demod_instance *demod)\n{\n\tstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\n\tstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\n\tint rc;\n\tu16 fec_oc_ipr_mode = 0;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_IPR_MODE__A, &fec_oc_ipr_mode, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tfec_oc_ipr_mode &= (~FEC_OC_IPR_MODE_REVERSE_ORDER__M);\n\n\tif (ext_attr->bit_reverse_mpeg_outout)\n\t\tfec_oc_ipr_mode |= FEC_OC_IPR_MODE_REVERSE_ORDER__M;\n\n\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_IPR_MODE__A, fec_oc_ipr_mode, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n \nstatic int set_mpeg_start_width(struct drx_demod_instance *demod)\n{\n\tstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\n\tstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)(NULL);\n\tstruct drx_common_attr *common_attr = (struct drx_common_attr *) NULL;\n\tint rc;\n\tu16 fec_oc_comm_mb = 0;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tcommon_attr = demod->my_common_attr;\n\n\tif ((common_attr->mpeg_cfg.static_clk == true)\n\t    && (common_attr->mpeg_cfg.enable_parallel == false)) {\n\t\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_COMM_MB__A, &fec_oc_comm_mb, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tfec_oc_comm_mb &= ~FEC_OC_COMM_MB_CTL_ON;\n\t\tif (ext_attr->mpeg_start_width == DRXJ_MPEG_START_WIDTH_8CLKCYC)\n\t\t\tfec_oc_comm_mb |= FEC_OC_COMM_MB_CTL_ON;\n\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_COMM_MB__A, fec_oc_comm_mb, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n \n \n\n \n \n \n \nstatic int ctrl_set_uio_cfg(struct drx_demod_instance *demod, struct drxuio_cfg *uio_cfg)\n{\n\tstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\n\tint rc;\n\n\tif ((uio_cfg == NULL) || (demod == NULL))\n\t\treturn -EINVAL;\n\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\t \n\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tswitch (uio_cfg->uio) {\n       \n\tcase DRX_UIO1:\n\t\t \n\t\tif (!ext_attr->has_smatx)\n\t\t\treturn -EIO;\n\t\tswitch (uio_cfg->mode) {\n\t\tcase DRX_UIO_MODE_FIRMWARE_SMA:\n\t\tcase DRX_UIO_MODE_FIRMWARE_SAW:\n\t\tcase DRX_UIO_MODE_READWRITE:\n\t\t\text_attr->uio_sma_tx_mode = uio_cfg->mode;\n\t\t\tbreak;\n\t\tcase DRX_UIO_MODE_DISABLE:\n\t\t\text_attr->uio_sma_tx_mode = uio_cfg->mode;\n\t\t\t \n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_TX_CFG__A, 0, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\t\t \n\t\tbreak;\n       \n\tcase DRX_UIO2:\n\t\t \n\t\tif (!ext_attr->has_smarx)\n\t\t\treturn -EIO;\n\t\tswitch (uio_cfg->mode) {\n\t\tcase DRX_UIO_MODE_FIRMWARE0:\n\t\tcase DRX_UIO_MODE_READWRITE:\n\t\t\text_attr->uio_sma_rx_mode = uio_cfg->mode;\n\t\t\tbreak;\n\t\tcase DRX_UIO_MODE_DISABLE:\n\t\t\text_attr->uio_sma_rx_mode = uio_cfg->mode;\n\t\t\t \n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_RX_CFG__A, 0, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\t\t \n\t\tbreak;\n       \n\tcase DRX_UIO3:\n\t\t \n\t\tif (!ext_attr->has_gpio)\n\t\t\treturn -EIO;\n\t\tswitch (uio_cfg->mode) {\n\t\tcase DRX_UIO_MODE_FIRMWARE0:\n\t\tcase DRX_UIO_MODE_READWRITE:\n\t\t\text_attr->uio_gpio_mode = uio_cfg->mode;\n\t\t\tbreak;\n\t\tcase DRX_UIO_MODE_DISABLE:\n\t\t\text_attr->uio_gpio_mode = uio_cfg->mode;\n\t\t\t \n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_GPIO_CFG__A, 0, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\t\t \n\t\tbreak;\n       \n\tcase DRX_UIO4:\n\t\t \n\t\tif (!ext_attr->has_irqn)\n\t\t\treturn -EIO;\n\t\tswitch (uio_cfg->mode) {\n\t\tcase DRX_UIO_MODE_READWRITE:\n\t\t\text_attr->uio_irqn_mode = uio_cfg->mode;\n\t\t\tbreak;\n\t\tcase DRX_UIO_MODE_DISABLE:\n\t\t\t \n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_IRQN_CFG__A, 0, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\text_attr->uio_irqn_mode = uio_cfg->mode;\n\t\t\tbreak;\n\t\tcase DRX_UIO_MODE_FIRMWARE0:\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\t\t \n\t\tbreak;\n       \n\tdefault:\n\t\treturn -EINVAL;\n\t}\t\t\t \n\n\t \n\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int\nctrl_uio_write(struct drx_demod_instance *demod, struct drxuio_data *uio_data)\n{\n\tstruct drxj_data *ext_attr = (struct drxj_data *) (NULL);\n\tint rc;\n\tu16 pin_cfg_value = 0;\n\tu16 value = 0;\n\n\tif ((uio_data == NULL) || (demod == NULL))\n\t\treturn -EINVAL;\n\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\t \n\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tswitch (uio_data->uio) {\n       \n\tcase DRX_UIO1:\n\t\t \n\t\tif (!ext_attr->has_smatx)\n\t\t\treturn -EIO;\n\t\tif ((ext_attr->uio_sma_tx_mode != DRX_UIO_MODE_READWRITE)\n\t\t    && (ext_attr->uio_sma_tx_mode != DRX_UIO_MODE_FIRMWARE_SAW)) {\n\t\t\treturn -EIO;\n\t\t}\n\t\tpin_cfg_value = 0;\n\t\t \n\t\tpin_cfg_value |= 0x0113;\n\t\t \n\t\t \n\n\t\t \n\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_TX_CFG__A, pin_cfg_value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\t \n\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, &value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tif (!uio_data->value)\n\t\t\tvalue &= 0x7FFF;\t \n\t\telse\n\t\t\tvalue |= 0x8000;\t \n\n\t\t \n\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n    \n\tcase DRX_UIO2:\n\t\t \n\t\tif (!ext_attr->has_smarx)\n\t\t\treturn -EIO;\n\t\tif (ext_attr->uio_sma_rx_mode != DRX_UIO_MODE_READWRITE)\n\t\t\treturn -EIO;\n\n\t\tpin_cfg_value = 0;\n\t\t \n\t\tpin_cfg_value |= 0x0113;\n\t\t \n\t\t \n\n\t\t \n\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_RX_CFG__A, pin_cfg_value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\t \n\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, &value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tif (!uio_data->value)\n\t\t\tvalue &= 0xBFFF;\t \n\t\telse\n\t\t\tvalue |= 0x4000;\t \n\n\t\t \n\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n    \n\tcase DRX_UIO3:\n\t\t \n\t\tif (!ext_attr->has_gpio)\n\t\t\treturn -EIO;\n\t\tif (ext_attr->uio_gpio_mode != DRX_UIO_MODE_READWRITE)\n\t\t\treturn -EIO;\n\n\t\tpin_cfg_value = 0;\n\t\t \n\t\tpin_cfg_value |= 0x0113;\n\t\t \n\t\t \n\n\t\t \n\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_GPIO_CFG__A, pin_cfg_value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\t \n\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_HI__A, &value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tif (!uio_data->value)\n\t\t\tvalue &= 0xFFFB;\t \n\t\telse\n\t\t\tvalue |= 0x0004;\t \n\n\t\t \n\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_HI__A, value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n    \n\tcase DRX_UIO4:\n\t\t \n\t\tif (!ext_attr->has_irqn)\n\t\t\treturn -EIO;\n\n\t\tif (ext_attr->uio_irqn_mode != DRX_UIO_MODE_READWRITE)\n\t\t\treturn -EIO;\n\n\t\tpin_cfg_value = 0;\n\t\t \n\t\tpin_cfg_value |= 0x0113;\n\t\t \n\t\t \n\n\t\t \n\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_IRQN_CFG__A, pin_cfg_value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\t \n\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, &value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tif (uio_data->value == false)\n\t\t\tvalue &= 0xEFFF;\t \n\t\telse\n\t\t\tvalue |= 0x1000;\t \n\n\t\t \n\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_UIO_OUT_LO__A, value, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n       \n\tdefault:\n\t\treturn -EINVAL;\n\t}\t\t\t \n\n\t \n\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n \n \n\n \n \n \n \nstatic int\nctrl_i2c_bridge(struct drx_demod_instance *demod, bool *bridge_closed)\n{\n\tstruct drxj_hi_cmd hi_cmd;\n\tu16 result = 0;\n\n\t \n\tif (bridge_closed == NULL)\n\t\treturn -EINVAL;\n\n\thi_cmd.cmd = SIO_HI_RA_RAM_CMD_BRDCTRL;\n\thi_cmd.param1 = SIO_HI_RA_RAM_PAR_1_PAR1_SEC_KEY;\n\tif (*bridge_closed)\n\t\thi_cmd.param2 = SIO_HI_RA_RAM_PAR_2_BRD_CFG_CLOSED;\n\telse\n\t\thi_cmd.param2 = SIO_HI_RA_RAM_PAR_2_BRD_CFG_OPEN;\n\n\treturn hi_command(demod->my_i2c_dev_addr, &hi_cmd, &result);\n}\n\n \n \n \n\n \n \n \n \nstatic int smart_ant_init(struct drx_demod_instance *demod)\n{\n\tstruct drxj_data *ext_attr = NULL;\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxuio_cfg uio_cfg = { DRX_UIO1, DRX_UIO_MODE_FIRMWARE_SMA };\n\tint rc;\n\tu16 data = 0;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\t \n\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, SIO_TOP_COMM_KEY_KEY, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = drxj_dap_read_reg16(dev_addr, SIO_SA_TX_COMMAND__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (ext_attr->smart_ant_inverted) {\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_SA_TX_COMMAND__A, (data | SIO_SA_TX_COMMAND_TX_INVERT__M) | SIO_SA_TX_COMMAND_TX_ENABLE__M, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t} else {\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_SA_TX_COMMAND__A, (data & (~SIO_SA_TX_COMMAND_TX_INVERT__M)) | SIO_SA_TX_COMMAND_TX_ENABLE__M, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\t \n\trc = ctrl_set_uio_cfg(demod, &uio_cfg);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_TX_CFG__A, 0x13, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_PDR_SMA_TX_GPIO_FNC__A, 0x03, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\nstatic int scu_command(struct i2c_device_addr *dev_addr, struct drxjscu_cmd *cmd)\n{\n\tint rc;\n\tu16 cur_cmd = 0;\n\tunsigned long timeout;\n\n\t \n\tif (cmd == NULL)\n\t\treturn -EINVAL;\n\n\t \n\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_COMMAND__A, &cur_cmd, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (cur_cmd != DRX_SCU_READY)\n\t\treturn -EIO;\n\n\tswitch (cmd->parameter_len) {\n\tcase 5:\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_4__A, *(cmd->parameter + 4), 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tfallthrough;\n\tcase 4:\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_3__A, *(cmd->parameter + 3), 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tfallthrough;\n\tcase 3:\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_2__A, *(cmd->parameter + 2), 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tfallthrough;\n\tcase 2:\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_1__A, *(cmd->parameter + 1), 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tfallthrough;\n\tcase 1:\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_PARAM_0__A, *(cmd->parameter + 0), 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tfallthrough;\n\tcase 0:\n\t\t \n\t\tbreak;\n\tdefault:\n\t\t \n\t\treturn -EIO;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_COMMAND__A, cmd->command, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\ttimeout = jiffies + msecs_to_jiffies(DRXJ_MAX_WAITTIME);\n\twhile (time_is_after_jiffies(timeout)) {\n\t\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_COMMAND__A, &cur_cmd, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tif (cur_cmd == DRX_SCU_READY)\n\t\t\tbreak;\n\t\tusleep_range(1000, 2000);\n\t}\n\n\tif (cur_cmd != DRX_SCU_READY)\n\t\treturn -EIO;\n\n\t \n\tif ((cmd->result_len > 0) && (cmd->result != NULL)) {\n\t\ts16 err;\n\n\t\tswitch (cmd->result_len) {\n\t\tcase 4:\n\t\t\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_PARAM_3__A, cmd->result + 3, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tfallthrough;\n\t\tcase 3:\n\t\t\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_PARAM_2__A, cmd->result + 2, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tfallthrough;\n\t\tcase 2:\n\t\t\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_PARAM_1__A, cmd->result + 1, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tfallthrough;\n\t\tcase 1:\n\t\t\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_PARAM_0__A, cmd->result + 0, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tfallthrough;\n\t\tcase 0:\n\t\t\t \n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\treturn -EIO;\n\t\t}\n\n\t\t \n\t\terr = cmd->result[0];\n\n\t\t \n\t\tif ((err == (s16) SCU_RAM_PARAM_0_RESULT_UNKSTD)\n\t\t    || (err == (s16) SCU_RAM_PARAM_0_RESULT_UNKCMD)\n\t\t    || (err == (s16) SCU_RAM_PARAM_0_RESULT_INVPAR)\n\t\t    || (err == (s16) SCU_RAM_PARAM_0_RESULT_SIZE)\n\t\t    ) {\n\t\t\treturn -EINVAL;\n\t\t}\n\t\t \n\t\telse if (err < 0)\n\t\t\treturn -EIO;\n\t\telse\n\t\t\treturn 0;\n\t}\n\n\treturn 0;\n\nrw_error:\n\treturn rc;\n}\n\n \n#define ADDR_AT_SCU_SPACE(x) ((x - 0x82E000) * 2)\nstatic\nint drxj_dap_scu_atomic_read_write_block(struct i2c_device_addr *dev_addr, u32 addr, u16 datasize,\t \n\t\t\t\t\t      u8 *data, bool read_flag)\n{\n\tstruct drxjscu_cmd scu_cmd;\n\tint rc;\n\tu16 set_param_parameters[18];\n\tu16 cmd_result[15];\n\n\t \n\tif (!data || !dev_addr || (datasize % 2) || ((datasize / 2) > 16))\n\t\treturn -EINVAL;\n\n\tset_param_parameters[1] = (u16) ADDR_AT_SCU_SPACE(addr);\n\tif (read_flag) {\t\t \n\t\tset_param_parameters[0] = ((~(0x0080)) & datasize);\n\t\tscu_cmd.parameter_len = 2;\n\t\tscu_cmd.result_len = datasize / 2 + 2;\n\t} else {\n\t\tint i = 0;\n\n\t\tset_param_parameters[0] = 0x0080 | datasize;\n\t\tfor (i = 0; i < (datasize / 2); i++) {\n\t\t\tset_param_parameters[i + 2] =\n\t\t\t    (data[2 * i] | (data[(2 * i) + 1] << 8));\n\t\t}\n\t\tscu_cmd.parameter_len = datasize / 2 + 2;\n\t\tscu_cmd.result_len = 1;\n\t}\n\n\tscu_cmd.command =\n\t    SCU_RAM_COMMAND_STANDARD_TOP |\n\t    SCU_RAM_COMMAND_CMD_AUX_SCU_ATOMIC_ACCESS;\n\tscu_cmd.result = cmd_result;\n\tscu_cmd.parameter = set_param_parameters;\n\trc = scu_command(dev_addr, &scu_cmd);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tif (read_flag) {\n\t\tint i = 0;\n\t\t \n\t\tfor (i = 0; i < (datasize / 2); i++) {\n\t\t\tdata[2 * i] = (u8) (scu_cmd.result[i + 2] & 0xFF);\n\t\t\tdata[(2 * i) + 1] = (u8) (scu_cmd.result[i + 2] >> 8);\n\t\t}\n\t}\n\n\treturn 0;\n\nrw_error:\n\treturn rc;\n\n}\n\n \n\n \nstatic\nint drxj_dap_scu_atomic_read_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t u32 addr,\n\t\t\t\t\t u16 *data, u32 flags)\n{\n\tu8 buf[2] = { 0 };\n\tint rc;\n\tu16 word = 0;\n\n\tif (!data)\n\t\treturn -EINVAL;\n\n\trc = drxj_dap_scu_atomic_read_write_block(dev_addr, addr, 2, buf, true);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tword = (u16) (buf[0] + (buf[1] << 8));\n\n\t*data = word;\n\n\treturn rc;\n}\n\n \n \nstatic\nint drxj_dap_scu_atomic_write_reg16(struct i2c_device_addr *dev_addr,\n\t\t\t\t\t  u32 addr,\n\t\t\t\t\t  u16 data, u32 flags)\n{\n\tu8 buf[2];\n\tint rc;\n\n\tbuf[0] = (u8) (data & 0xff);\n\tbuf[1] = (u8) ((data >> 8) & 0xff);\n\n\trc = drxj_dap_scu_atomic_read_write_block(dev_addr, addr, 2, buf, false);\n\n\treturn rc;\n}\n\n \n \nstatic int adc_sync_measurement(struct drx_demod_instance *demod, u16 *count)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tint rc;\n\tu16 data = 0;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_COMM_EXEC__A, IQM_AF_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_START_LOCK__A, 1, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tmsleep(1);\n\n\t*count = 0;\n\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_PHASE0__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (data == 127)\n\t\t*count = *count + 1;\n\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_PHASE1__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (data == 127)\n\t\t*count = *count + 1;\n\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_PHASE2__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (data == 127)\n\t\t*count = *count + 1;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\nstatic int adc_synchronization(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tint rc;\n\tu16 count = 0;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\n\trc = adc_sync_measurement(demod, &count);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tif (count == 1) {\n\t\t \n\t\tu16 clk_neg = 0;\n\n\t\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_CLKNEG__A, &clk_neg, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\tclk_neg ^= IQM_AF_CLKNEG_CLKNEGDATA__M;\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLKNEG__A, clk_neg, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\trc = adc_sync_measurement(demod, &count);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\t \n\tif (count < 2)\n\t\treturn -EIO;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n \n \n\n \n \n \n \n \n \nstatic int init_agc(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drx_common_attr *common_attr = NULL;\n\tstruct drxj_data *ext_attr = NULL;\n\tstruct drxj_cfg_agc *p_agc_rf_settings = NULL;\n\tstruct drxj_cfg_agc *p_agc_if_settings = NULL;\n\tint rc;\n\tu16 ingain_tgt_max = 0;\n\tu16 clp_dir_to = 0;\n\tu16 sns_sum_max = 0;\n\tu16 clp_sum_max = 0;\n\tu16 sns_dir_to = 0;\n\tu16 ki_innergain_min = 0;\n\tu16 agc_ki = 0;\n\tu16 ki_max = 0;\n\tu16 if_iaccu_hi_tgt_min = 0;\n\tu16 data = 0;\n\tu16 agc_ki_dgain = 0;\n\tu16 ki_min = 0;\n\tu16 clp_ctrl_mode = 0;\n\tu16 agc_rf = 0;\n\tu16 agc_if = 0;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\tswitch (ext_attr->standard) {\n\tcase DRX_STANDARD_8VSB:\n\t\tclp_sum_max = 1023;\n\t\tclp_dir_to = (u16) (-9);\n\t\tsns_sum_max = 1023;\n\t\tsns_dir_to = (u16) (-9);\n\t\tki_innergain_min = (u16) (-32768);\n\t\tki_max = 0x032C;\n\t\tagc_ki_dgain = 0xC;\n\t\tif_iaccu_hi_tgt_min = 2047;\n\t\tki_min = 0x0117;\n\t\tingain_tgt_max = 16383;\n\t\tclp_ctrl_mode = 0;\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MINGAIN__A, 0x7fff, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MAXGAIN__A, 0x0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_SUM__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_CYCCNT__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_WD__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_STP__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_SUM__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_CYCCNT__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_WD__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_STP__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN__A, 1024, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_VSB_AGC_POW_TGT__A, 22600, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN_TGT__A, 13200, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tp_agc_if_settings = &(ext_attr->vsb_if_agc_cfg);\n\t\tp_agc_rf_settings = &(ext_attr->vsb_rf_agc_cfg);\n\t\tbreak;\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_C:\n\tcase DRX_STANDARD_ITU_B:\n\t\tingain_tgt_max = 5119;\n\t\tclp_sum_max = 1023;\n\t\tclp_dir_to = (u16) (-5);\n\t\tsns_sum_max = 127;\n\t\tsns_dir_to = (u16) (-3);\n\t\tki_innergain_min = 0;\n\t\tki_max = 0x0657;\n\t\tif_iaccu_hi_tgt_min = 2047;\n\t\tagc_ki_dgain = 0x7;\n\t\tki_min = 0x0117;\n\t\tclp_ctrl_mode = 0;\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MINGAIN__A, 0x7fff, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MAXGAIN__A, 0x0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_SUM__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_CYCCNT__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_WD__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_STP__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_SUM__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_CYCCNT__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_WD__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_STP__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tp_agc_if_settings = &(ext_attr->qam_if_agc_cfg);\n\t\tp_agc_rf_settings = &(ext_attr->qam_rf_agc_cfg);\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN_TGT__A, p_agc_if_settings->top, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_AGC_KI__A, &agc_ki, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tagc_ki &= 0xf000;\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI__A, agc_ki, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n#endif\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN_TGT_MIN__A, p_agc_if_settings->top, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN__A, p_agc_if_settings->top, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_INGAIN_TGT_MAX__A, ingain_tgt_max, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MIN__A, if_iaccu_hi_tgt_min, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_IF_IACCU_HI__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_IF_IACCU_LO__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_RF_IACCU_HI__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_RF_IACCU_LO__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_RF_MAX__A, 32767, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_SUM_MAX__A, clp_sum_max, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_SUM_MAX__A, sns_sum_max, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_INNERGAIN_MIN__A, ki_innergain_min, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_FAST_SNS_CTRL_DELAY__A, 50, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_CYCLEN__A, 500, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_CYCLEN__A, 500, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MAXMINGAIN_TH__A, 20, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MIN__A, ki_min, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_MAX__A, ki_max, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI_RED__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_SUM_MIN__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_CYCLEN__A, 500, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_DIR_TO__A, clp_dir_to, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_SUM_MIN__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_SNS_DIR_TO__A, sns_dir_to, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_FAST_CLP_CTRL_DELAY__A, 50, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_CLP_CTRL_MODE__A, clp_ctrl_mode, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tagc_rf = 0x800 + p_agc_rf_settings->cut_off_current;\n\tif (common_attr->tuner_rf_agc_pol == true)\n\t\tagc_rf = 0x87ff - agc_rf;\n\n\tagc_if = 0x800;\n\tif (common_attr->tuner_if_agc_pol == true)\n\t\tagc_rf = 0x87ff - agc_rf;\n\n\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_AGC_RF__A, agc_rf, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_AGC_IF__A, agc_if, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tdata &= ~SCU_RAM_AGC_KI_DGAIN__M;\n\tdata |= (agc_ki_dgain << SCU_RAM_AGC_KI_DGAIN__B);\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int\nset_frequency(struct drx_demod_instance *demod,\n\t      struct drx_channel *channel, s32 tuner_freq_offset)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tstruct drxj_data *ext_attr = demod->my_ext_attr;\n\tint rc;\n\ts32 sampling_frequency = 0;\n\ts32 frequency_shift = 0;\n\ts32 if_freq_actual = 0;\n\ts32 rf_freq_residual = -1 * tuner_freq_offset;\n\ts32 adc_freq = 0;\n\ts32 intermediate_freq = 0;\n\tu32 iqm_fs_rate_ofs = 0;\n\tbool adc_flip = true;\n\tbool select_pos_image = false;\n\tbool rf_mirror;\n\tbool tuner_mirror;\n\tbool image_to_select;\n\ts32 fm_frequency_shift = 0;\n\n\trf_mirror = (ext_attr->mirror == DRX_MIRROR_YES) ? true : false;\n\ttuner_mirror = demod->my_common_attr->mirror_freq_spect ? false : true;\n\t \n\tswitch (ext_attr->standard) {\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_C:\n\tcase DRX_STANDARD_PAL_SECAM_LP:\n\tcase DRX_STANDARD_8VSB:\n\t\tselect_pos_image = true;\n\t\tbreak;\n\tcase DRX_STANDARD_FM:\n\t\t \n\t\tfm_frequency_shift = 1000;\n\t\tfallthrough;\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_NTSC:\n\tcase DRX_STANDARD_PAL_SECAM_BG:\n\tcase DRX_STANDARD_PAL_SECAM_DK:\n\tcase DRX_STANDARD_PAL_SECAM_I:\n\tcase DRX_STANDARD_PAL_SECAM_L:\n\t\tselect_pos_image = false;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\tintermediate_freq = demod->my_common_attr->intermediate_freq;\n\tsampling_frequency = demod->my_common_attr->sys_clock_freq / 3;\n\tif (tuner_mirror)\n\t\tif_freq_actual = intermediate_freq + rf_freq_residual + fm_frequency_shift;\n\telse\n\t\tif_freq_actual = intermediate_freq - rf_freq_residual - fm_frequency_shift;\n\tif (if_freq_actual > sampling_frequency / 2) {\n\t\t \n\t\tadc_freq = sampling_frequency - if_freq_actual;\n\t\tadc_flip = true;\n\t} else {\n\t\t \n\t\tadc_freq = if_freq_actual;\n\t\tadc_flip = false;\n\t}\n\n\tfrequency_shift = adc_freq;\n\timage_to_select =\n\t    (bool) (rf_mirror ^ tuner_mirror ^ adc_flip ^ select_pos_image);\n\tiqm_fs_rate_ofs = frac28(frequency_shift, sampling_frequency);\n\n\tif (image_to_select)\n\t\tiqm_fs_rate_ofs = ~iqm_fs_rate_ofs + 1;\n\n\t \n\t \n\trc = drxdap_fasi_write_reg32(dev_addr, IQM_FS_RATE_OFS_LO__A, iqm_fs_rate_ofs, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\text_attr->iqm_fs_rate_ofs = iqm_fs_rate_ofs;\n\text_attr->pos_image = (bool) (rf_mirror ^ tuner_mirror ^ select_pos_image);\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n#ifdef DRXJ_SIGNAL_ACCUM_ERR\nstatic int get_acc_pkt_err(struct drx_demod_instance *demod, u16 *packet_err)\n{\n\tint rc;\n\tstatic u16 pkt_err;\n\tstatic u16 last_pkt_err;\n\tu16 data = 0;\n\tstruct drxj_data *ext_attr = NULL;\n\tstruct i2c_device_addr *dev_addr = NULL;\n\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tdev_addr = demod->my_i2c_dev_addr;\n\n\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (ext_attr->reset_pkt_err_acc) {\n\t\tlast_pkt_err = data;\n\t\tpkt_err = 0;\n\t\text_attr->reset_pkt_err_acc = false;\n\t}\n\n\tif (data < last_pkt_err) {\n\t\tpkt_err += 0xffff - last_pkt_err;\n\t\tpkt_err += data;\n\t} else {\n\t\tpkt_err += (data - last_pkt_err);\n\t}\n\t*packet_err = pkt_err;\n\tlast_pkt_err = data;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n#endif\n\n\n \n\n \nstatic int\nset_agc_rf(struct drx_demod_instance *demod, struct drxj_cfg_agc *agc_settings, bool atomic)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxj_data *ext_attr = NULL;\n\tstruct drxj_cfg_agc *p_agc_settings = NULL;\n\tstruct drx_common_attr *common_attr = NULL;\n\tint rc;\n\tdrx_write_reg16func_t scu_wr16 = NULL;\n\tdrx_read_reg16func_t scu_rr16 = NULL;\n\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\tif (atomic) {\n\t\tscu_rr16 = drxj_dap_scu_atomic_read_reg16;\n\t\tscu_wr16 = drxj_dap_scu_atomic_write_reg16;\n\t} else {\n\t\tscu_rr16 = drxj_dap_read_reg16;\n\t\tscu_wr16 = drxj_dap_write_reg16;\n\t}\n\n\t \n\tif ((ext_attr->standard == agc_settings->standard) ||\n\t    (DRXJ_ISQAMSTD(ext_attr->standard) &&\n\t     DRXJ_ISQAMSTD(agc_settings->standard)) ||\n\t    (DRXJ_ISATVSTD(ext_attr->standard) &&\n\t     DRXJ_ISATVSTD(agc_settings->standard))) {\n\t\tu16 data = 0;\n\n\t\tswitch (agc_settings->ctrl_mode) {\n\t\tcase DRX_AGC_CTRL_AUTO:\n\n\t\t\t \n\t\t\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata |= IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE;\n\t\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= ~SCU_RAM_AGC_KI_RF__M;\n\t\t\tif (ext_attr->standard == DRX_STANDARD_8VSB)\n\t\t\t\tdata |= (2 << SCU_RAM_AGC_KI_RF__B);\n\t\t\telse if (DRXJ_ISQAMSTD(ext_attr->standard))\n\t\t\t\tdata |= (5 << SCU_RAM_AGC_KI_RF__B);\n\t\t\telse\n\t\t\t\tdata |= (4 << SCU_RAM_AGC_KI_RF__B);\n\n\t\t\tif (common_attr->tuner_rf_agc_pol)\n\t\t\t\tdata |= SCU_RAM_AGC_KI_INV_RF_POL__M;\n\t\t\telse\n\t\t\t\tdata &= ~SCU_RAM_AGC_KI_INV_RF_POL__M;\n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI_RED__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= ~SCU_RAM_AGC_KI_RED_RAGC_RED__M;\n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI_RED__A, (~(agc_settings->speed << SCU_RAM_AGC_KI_RED_RAGC_RED__B) & SCU_RAM_AGC_KI_RED_RAGC_RED__M) | data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\tif (agc_settings->standard == DRX_STANDARD_8VSB)\n\t\t\t\tp_agc_settings = &(ext_attr->vsb_if_agc_cfg);\n\t\t\telse if (DRXJ_ISQAMSTD(agc_settings->standard))\n\t\t\t\tp_agc_settings = &(ext_attr->qam_if_agc_cfg);\n\t\t\telse if (DRXJ_ISATVSTD(agc_settings->standard))\n\t\t\t\tp_agc_settings = &(ext_attr->atv_if_agc_cfg);\n\t\t\telse\n\t\t\t\treturn -EINVAL;\n\n\t\t\t \n\t\t\tif (p_agc_settings->ctrl_mode == DRX_AGC_CTRL_AUTO) {\n\t\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A, agc_settings->top, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT__A, agc_settings->top, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_RF_IACCU_HI_CO__A, agc_settings->cut_off_current, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_AGC_CTRL_USER:\n\n\t\t\t \n\t\t\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata |= IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE;\n\t\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= ~SCU_RAM_AGC_KI_RF__M;\n\t\t\tif (common_attr->tuner_rf_agc_pol)\n\t\t\t\tdata |= SCU_RAM_AGC_KI_INV_RF_POL__M;\n\t\t\telse\n\t\t\t\tdata &= ~SCU_RAM_AGC_KI_INV_RF_POL__M;\n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_RF_IACCU_HI__A, agc_settings->output_level, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_AGC_CTRL_OFF:\n\n\t\t\t \n\t\t\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= (~IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE);\n\t\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= ~SCU_RAM_AGC_KI_RF__M;\n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\t\t \n\t}\n\n\t \n\tswitch (agc_settings->standard) {\n\tcase DRX_STANDARD_8VSB:\n\t\text_attr->vsb_rf_agc_cfg = *agc_settings;\n\t\tbreak;\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n\t\text_attr->qam_rf_agc_cfg = *agc_settings;\n\t\tbreak;\n#endif\n\tdefault:\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int\nset_agc_if(struct drx_demod_instance *demod, struct drxj_cfg_agc *agc_settings, bool atomic)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxj_data *ext_attr = NULL;\n\tstruct drxj_cfg_agc *p_agc_settings = NULL;\n\tstruct drx_common_attr *common_attr = NULL;\n\tdrx_write_reg16func_t scu_wr16 = NULL;\n\tdrx_read_reg16func_t scu_rr16 = NULL;\n\tint rc;\n\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\tif (atomic) {\n\t\tscu_rr16 = drxj_dap_scu_atomic_read_reg16;\n\t\tscu_wr16 = drxj_dap_scu_atomic_write_reg16;\n\t} else {\n\t\tscu_rr16 = drxj_dap_read_reg16;\n\t\tscu_wr16 = drxj_dap_write_reg16;\n\t}\n\n\t \n\tif ((ext_attr->standard == agc_settings->standard) ||\n\t    (DRXJ_ISQAMSTD(ext_attr->standard) &&\n\t     DRXJ_ISQAMSTD(agc_settings->standard)) ||\n\t    (DRXJ_ISATVSTD(ext_attr->standard) &&\n\t     DRXJ_ISATVSTD(agc_settings->standard))) {\n\t\tu16 data = 0;\n\n\t\tswitch (agc_settings->ctrl_mode) {\n\t\tcase DRX_AGC_CTRL_AUTO:\n\t\t\t \n\t\t\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata |= IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE;\n\t\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= ~SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\n\t\t\tdata &= ~SCU_RAM_AGC_KI_IF__M;\n\t\t\tif (ext_attr->standard == DRX_STANDARD_8VSB)\n\t\t\t\tdata |= (3 << SCU_RAM_AGC_KI_IF__B);\n\t\t\telse if (DRXJ_ISQAMSTD(ext_attr->standard))\n\t\t\t\tdata |= (6 << SCU_RAM_AGC_KI_IF__B);\n\t\t\telse\n\t\t\t\tdata |= (5 << SCU_RAM_AGC_KI_IF__B);\n\n\t\t\tif (common_attr->tuner_if_agc_pol)\n\t\t\t\tdata |= SCU_RAM_AGC_KI_INV_IF_POL__M;\n\t\t\telse\n\t\t\t\tdata &= ~SCU_RAM_AGC_KI_INV_IF_POL__M;\n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI_RED__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= ~SCU_RAM_AGC_KI_RED_IAGC_RED__M;\n\t\t\trc = (*scu_wr16) (dev_addr, SCU_RAM_AGC_KI_RED__A, (~(agc_settings->speed << SCU_RAM_AGC_KI_RED_IAGC_RED__B) & SCU_RAM_AGC_KI_RED_IAGC_RED__M) | data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\tif (agc_settings->standard == DRX_STANDARD_8VSB)\n\t\t\t\tp_agc_settings = &(ext_attr->vsb_rf_agc_cfg);\n\t\t\telse if (DRXJ_ISQAMSTD(agc_settings->standard))\n\t\t\t\tp_agc_settings = &(ext_attr->qam_rf_agc_cfg);\n\t\t\telse if (DRXJ_ISATVSTD(agc_settings->standard))\n\t\t\t\tp_agc_settings = &(ext_attr->atv_rf_agc_cfg);\n\t\t\telse\n\t\t\t\treturn -EINVAL;\n\n\t\t\t \n\t\t\tif (p_agc_settings->ctrl_mode == DRX_AGC_CTRL_AUTO) {\n\t\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A, p_agc_settings->top, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT__A, p_agc_settings->top, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A, 0, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT__A, 0, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase DRX_AGC_CTRL_USER:\n\n\t\t\t \n\t\t\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata |= IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE;\n\t\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= ~SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\n\t\t\tdata |= SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\n\t\t\tif (common_attr->tuner_if_agc_pol)\n\t\t\t\tdata |= SCU_RAM_AGC_KI_INV_IF_POL__M;\n\t\t\telse\n\t\t\t\tdata &= ~SCU_RAM_AGC_KI_INV_IF_POL__M;\n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_IF_IACCU_HI_TGT_MAX__A, agc_settings->output_level, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase DRX_AGC_CTRL_OFF:\n\n\t\t\t \n\t\t\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= (~IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE);\n\t\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = (*scu_rr16)(dev_addr, SCU_RAM_AGC_KI__A, &data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tdata &= ~SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\n\t\t\tdata |= SCU_RAM_AGC_KI_IF_AGC_DISABLE__M;\n\t\t\trc = (*scu_wr16)(dev_addr, SCU_RAM_AGC_KI__A, data, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\t\t \n\n\t\t \n\t\trc = (*scu_wr16) (dev_addr, SCU_RAM_AGC_INGAIN_TGT_MIN__A, agc_settings->top, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\t \n\tswitch (agc_settings->standard) {\n\tcase DRX_STANDARD_8VSB:\n\t\text_attr->vsb_if_agc_cfg = *agc_settings;\n\t\tbreak;\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n\t\text_attr->qam_if_agc_cfg = *agc_settings;\n\t\tbreak;\n#endif\n\tdefault:\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int set_iqm_af(struct drx_demod_instance *demod, bool active)\n{\n\tu16 data = 0;\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tint rc;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\n\t \n\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_STDBY__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (!active)\n\t\tdata &= ((~IQM_AF_STDBY_STDBY_ADC_A2_ACTIVE) & (~IQM_AF_STDBY_STDBY_AMP_A2_ACTIVE) & (~IQM_AF_STDBY_STDBY_PD_A2_ACTIVE) & (~IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE) & (~IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE));\n\telse\n\t\tdata |= (IQM_AF_STDBY_STDBY_ADC_A2_ACTIVE | IQM_AF_STDBY_STDBY_AMP_A2_ACTIVE | IQM_AF_STDBY_STDBY_PD_A2_ACTIVE | IQM_AF_STDBY_STDBY_TAGC_IF_A2_ACTIVE | IQM_AF_STDBY_STDBY_TAGC_RF_A2_ACTIVE);\n\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n \n \n\n \n \n \n \n \n\n \nstatic int power_down_vsb(struct drx_demod_instance *demod, bool primary)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tstruct drxjscu_cmd cmd_scu = {   0,\n\t\t  0,\n\t\t  0,\n\t\t  NULL,\n\t\t  NULL\n\t};\n\tstruct drx_cfg_mpeg_output cfg_mpeg_output;\n\tint rc;\n\tu16 cmd_result = 0;\n\n\t \n\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB |\n\t    SCU_RAM_COMMAND_CMD_DEMOD_STOP;\n\tcmd_scu.parameter_len = 0;\n\tcmd_scu.result_len = 1;\n\tcmd_scu.parameter = NULL;\n\tcmd_scu.result = &cmd_result;\n\trc = scu_command(dev_addr, &cmd_scu);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_COMM_EXEC__A, VSB_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (primary) {\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = set_iqm_af(demod, false);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t} else {\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\tcfg_mpeg_output.enable_mpeg_output = false;\n\trc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int set_vsb_leak_n_gain(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tint rc;\n\n\tstatic const u8 vsb_ffe_leak_gain_ram0[] = {\n\t\tDRXJ_16TO8(0x8),\t \n\t\tDRXJ_16TO8(0x8),\t \n\t\tDRXJ_16TO8(0x8),\t \n\t\tDRXJ_16TO8(0xf),\t \n\t\tDRXJ_16TO8(0xf),\t \n\t\tDRXJ_16TO8(0xf),\t \n\t\tDRXJ_16TO8(0xf),\t \n\t\tDRXJ_16TO8(0xf),\t \n\t\tDRXJ_16TO8(0xf),\t \n\t\tDRXJ_16TO8(0x8),\t \n\t\tDRXJ_16TO8(0x8),\t \n\t\tDRXJ_16TO8(0x8),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x20),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x10),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x0e),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x07),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x0c),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x06),\t \n\t\tDRXJ_16TO8(0x2020),\t \n\t\tDRXJ_16TO8(0x2020),\t \n\t\tDRXJ_16TO8(0x2020),\t \n\t\tDRXJ_16TO8(0x4040),\t \n\t\tDRXJ_16TO8(0x4040),\t \n\t\tDRXJ_16TO8(0x4040),\t \n\t\tDRXJ_16TO8(0x4040),\t \n\t\tDRXJ_16TO8(0x4040),\t \n\t\tDRXJ_16TO8(0x4040),\t \n\t\tDRXJ_16TO8(0x2020),\t \n\t\tDRXJ_16TO8(0x2020),\t \n\t\tDRXJ_16TO8(0x2020),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1010)\t \n\t};\n\n\tstatic const u8 vsb_ffe_leak_gain_ram1[] = {\n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0808),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0606),\t \n\t\tDRXJ_16TO8(0x0606),\t \n\t\tDRXJ_16TO8(0x0606),\t \n\t\tDRXJ_16TO8(0x0606),\t \n\t\tDRXJ_16TO8(0x0606),\t \n\t\tDRXJ_16TO8(0x0606),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0505),\t \n\t\tDRXJ_16TO8(0x0505),\t \n\t\tDRXJ_16TO8(0x0505),\t \n\t\tDRXJ_16TO8(0x0505),\t \n\t\tDRXJ_16TO8(0x0505),\t \n\t\tDRXJ_16TO8(0x0505),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x0303),\t \n\t\tDRXJ_16TO8(0x001f),\t \n\t\tDRXJ_16TO8(0x01ff),\t \n\t\tDRXJ_16TO8(0x01ff),\t \n\t\tDRXJ_16TO8(0x004f),\t \n\t\tDRXJ_16TO8(0x004f),\t \n\t\tDRXJ_16TO8(0x01ff),\t \n\t\tDRXJ_16TO8(0x01ff),\t \n\t\tDRXJ_16TO8(0x0352),\t \n\t\tDRXJ_16TO8(0x0352),\t \n\t\tDRXJ_16TO8(0x0000),\t \n\t\tDRXJ_16TO8(0x2020),\t \n\t\tDRXJ_16TO8(0x1010),\t \n\t\tDRXJ_16TO8(0x1818),\t \n\t\tDRXJ_16TO8(0x1212)\t \n\t};\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\trc = drxdap_fasi_write_block(dev_addr, VSB_SYSCTRL_RAM0_FFETRAINLKRATIO1__A, sizeof(vsb_ffe_leak_gain_ram0), ((u8 *)vsb_ffe_leak_gain_ram0), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxdap_fasi_write_block(dev_addr, VSB_SYSCTRL_RAM1_FIRRCA1GAIN9__A, sizeof(vsb_ffe_leak_gain_ram1), ((u8 *)vsb_ffe_leak_gain_ram1), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int set_vsb(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tint rc;\n\tstruct drx_common_attr *common_attr = NULL;\n\tstruct drxjscu_cmd cmd_scu;\n\tstruct drxj_data *ext_attr = NULL;\n\tu16 cmd_result = 0;\n\tu16 cmd_param = 0;\n\tstatic const u8 vsb_taps_re[] = {\n\t\tDRXJ_16TO8(-2),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(1),\t \n\t\tDRXJ_16TO8(-4),\t \n\t\tDRXJ_16TO8(1),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(-3),\t \n\t\tDRXJ_16TO8(-3),\t \n\t\tDRXJ_16TO8(6),\t \n\t\tDRXJ_16TO8(1),\t \n\t\tDRXJ_16TO8(-9),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(12),\t \n\t\tDRXJ_16TO8(-9),\t \n\t\tDRXJ_16TO8(-15),\t \n\t\tDRXJ_16TO8(17),\t \n\t\tDRXJ_16TO8(19),\t \n\t\tDRXJ_16TO8(-29),\t \n\t\tDRXJ_16TO8(-22),\t \n\t\tDRXJ_16TO8(45),\t \n\t\tDRXJ_16TO8(25),\t \n\t\tDRXJ_16TO8(-70),\t \n\t\tDRXJ_16TO8(-28),\t \n\t\tDRXJ_16TO8(111),\t \n\t\tDRXJ_16TO8(30),\t \n\t\tDRXJ_16TO8(-201),\t \n\t\tDRXJ_16TO8(-31),\t \n\t\tDRXJ_16TO8(629)\t \n\t};\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_COMM_EXEC__A, VSB_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB\n\t    | SCU_RAM_COMMAND_CMD_DEMOD_RESET;\n\tcmd_scu.parameter_len = 0;\n\tcmd_scu.result_len = 1;\n\tcmd_scu.parameter = NULL;\n\tcmd_scu.result = &cmd_result;\n\trc = scu_command(dev_addr, &cmd_scu);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_DCF_BYPASS__A, 1, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_FS_ADJ_SEL__A, IQM_FS_ADJ_SEL_B_VSB, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_ADJ_SEL__A, IQM_RC_ADJ_SEL_B_VSB, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\text_attr->iqm_rc_rate_ofs = 0x00AD0D79;\n\trc = drxdap_fasi_write_reg32(dev_addr, IQM_RC_RATE_OFS_LO__A, ext_attr->iqm_rc_rate_ofs, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CFAGC_GAINSHIFT__A, 4, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CYGN1TRK__A, 1, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_CROUT_ENA__A, 1, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_STRETCH__A, 28, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_RT_ACTIVE__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_SYMMETRIC__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_MIDTAP__A, 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_OUT_ENA__A, IQM_CF_OUT_ENA_VSB__M, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_SCALE__A, 1393, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_SCALE_SH__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_POW_MEAS_LEN__A, 1, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(vsb_taps_re), ((u8 *)vsb_taps_re), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(vsb_taps_re), ((u8 *)vsb_taps_re), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_BNTHRESH__A, 330, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CLPLASTNUM__A, 90, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SNRTH_RCA1__A, 0x0042, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SNRTH_RCA2__A, 0x0053, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_EQCTRL__A, 0x1, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_GPIO__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, FEC_TOP_ANNEX__A, FEC_TOP_ANNEX_D, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t{\n\t\tu16 fec_oc_snc_mode = 0;\n\t\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_SNC_MODE__A, &fec_oc_snc_mode, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_MODE__A, fec_oc_snc_mode | FEC_OC_SNC_MODE_UNLOCK_ENABLE__M, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLP_LEN__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLP_TH__A, 470, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_SNS_LEN__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SNRTH_PT__A, 0xD4, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\t{\n\t\tu16 fec_oc_reg_mode = 0;\n\t\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_MODE__A, &fec_oc_reg_mode, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_MODE__A, fec_oc_reg_mode & (~(FEC_OC_MODE_TRANSPARENT__M | FEC_OC_MODE_CLEAR__M | FEC_OC_MODE_RETAIN_FRAMING__M)), 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, FEC_DI_TIMEOUT_LO__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\trc = drxj_dap_write_reg16(dev_addr, FEC_DI_TIMEOUT_HI__A, 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, FEC_RS_MODE__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\t \n\trc = drxj_dap_write_reg16(dev_addr, FEC_RS_MEASUREMENT_PERIOD__A, FEC_RS_MEASUREMENT_PERIOD, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, FEC_RS_MEASUREMENT_PRESCALE__A, FEC_RS_MEASUREMENT_PRESCALE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_MEASUREMENT_PERIOD__A, VSB_TOP_MEASUREMENT_PERIOD, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxdap_fasi_write_reg32(dev_addr, SCU_RAM_FEC_ACCUM_CW_CORRECTED_LO__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_FEC_MEAS_COUNT__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CKGN1TRK__A, 128, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\tif (!ext_attr->has_lna) {\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_AMUX__A, 0x02, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\t \n\trc = set_iqm_af(demod, true);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = adc_synchronization(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = init_agc(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = set_agc_if(demod, &(ext_attr->vsb_if_agc_cfg), false);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = set_agc_rf(demod, &(ext_attr->vsb_rf_agc_cfg), false);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t{\n\t\t \n\t\tstruct drxj_cfg_afe_gain vsb_pga_cfg = { DRX_STANDARD_8VSB, 0 };\n\n\t\tvsb_pga_cfg.gain = ext_attr->vsb_pga_cfg;\n\t\trc = ctrl_set_cfg_afe_gain(demod, &vsb_pga_cfg);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\trc = ctrl_set_cfg_pre_saw(demod, &(ext_attr->vsb_pre_saw_cfg));\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = set_mpegtei_handling(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = bit_reverse_mpeg_output(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = set_mpeg_start_width(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t{\n\t\t \n\t\t \n\t\tstruct drx_cfg_mpeg_output cfg_mpeg_output;\n\n\t\tmemcpy(&cfg_mpeg_output, &common_attr->mpeg_cfg, sizeof(cfg_mpeg_output));\n\t\tcfg_mpeg_output.enable_mpeg_output = true;\n\n\t\trc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\t \n\tcmd_param = 0x00;\t \n\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB\n\t    | SCU_RAM_COMMAND_CMD_DEMOD_SET_PARAM;\n\tcmd_scu.parameter_len = 1;\n\tcmd_scu.result_len = 1;\n\tcmd_scu.parameter = &cmd_param;\n\tcmd_scu.result = &cmd_result;\n\trc = scu_command(dev_addr, &cmd_scu);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_BEAGC_GAINSHIFT__A, 0x0004, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SNRTH_PT__A, 0x00D2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_SYSSMTRNCTRL__A, VSB_TOP_SYSSMTRNCTRL__PRE | VSB_TOP_SYSSMTRNCTRL_NCOTIMEOUTCNTEN__M, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_BEDETCTRL__A, 0x142, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_LBAGCREFLVL__A, 640, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CYGN1ACQ__A, 4, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CYGN1TRK__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_TOP_CYGN2TRK__A, 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB\n\t    | SCU_RAM_COMMAND_CMD_DEMOD_START;\n\tcmd_scu.parameter_len = 0;\n\tcmd_scu.result_len = 1;\n\tcmd_scu.parameter = NULL;\n\tcmd_scu.result = &cmd_result;\n\trc = scu_command(dev_addr, &cmd_scu);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, VSB_COMM_EXEC__A, VSB_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int get_vsb_post_rs_pck_err(struct i2c_device_addr *dev_addr,\n\t\t\t\t   u32 *pck_errs, u32 *pck_count)\n{\n\tint rc;\n\tu16 data = 0;\n\tu16 period = 0;\n\tu16 prescale = 0;\n\tu16 packet_errors_mant = 0;\n\tu16 packet_errors_exp = 0;\n\n\trc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_FAILURES__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tpacket_errors_mant = data & FEC_RS_NR_FAILURES_FIXED_MANT__M;\n\tpacket_errors_exp = (data & FEC_RS_NR_FAILURES_EXP__M)\n\t    >> FEC_RS_NR_FAILURES_EXP__B;\n\tperiod = FEC_RS_MEASUREMENT_PERIOD;\n\tprescale = FEC_RS_MEASUREMENT_PRESCALE;\n\t \n\t \n\tif (period * prescale == 0) {\n\t\tpr_err(\"error: period and/or prescale is zero!\\n\");\n\t\treturn -EIO;\n\t}\n\t*pck_errs = packet_errors_mant * (1 << packet_errors_exp);\n\t*pck_count = period * prescale * 77;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int get_vs_bpost_viterbi_ber(struct i2c_device_addr *dev_addr,\n\t\t\t\t    u32 *ber, u32 *cnt)\n{\n\tint rc;\n\tu16 data = 0;\n\tu16 period = 0;\n\tu16 prescale = 0;\n\tu16 bit_errors_mant = 0;\n\tu16 bit_errors_exp = 0;\n\n\trc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_BIT_ERRORS__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tperiod = FEC_RS_MEASUREMENT_PERIOD;\n\tprescale = FEC_RS_MEASUREMENT_PRESCALE;\n\n\tbit_errors_mant = data & FEC_RS_NR_BIT_ERRORS_FIXED_MANT__M;\n\tbit_errors_exp = (data & FEC_RS_NR_BIT_ERRORS_EXP__M)\n\t    >> FEC_RS_NR_BIT_ERRORS_EXP__B;\n\n\t*cnt = period * prescale * 207 * ((bit_errors_exp > 2) ? 1 : 8);\n\n\tif (((bit_errors_mant << bit_errors_exp) >> 3) > 68700)\n\t\t*ber = (*cnt) * 26570;\n\telse {\n\t\tif (period * prescale == 0) {\n\t\t\tpr_err(\"error: period and/or prescale is zero!\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t\t*ber = bit_errors_mant << ((bit_errors_exp > 2) ?\n\t\t\t(bit_errors_exp - 3) : bit_errors_exp);\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int get_vs_bpre_viterbi_ber(struct i2c_device_addr *dev_addr,\n\t\t\t\t   u32 *ber, u32 *cnt)\n{\n\tu16 data = 0;\n\tint rc;\n\n\trc = drxj_dap_read_reg16(dev_addr, VSB_TOP_NR_SYM_ERRS__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\treturn -EIO;\n\t}\n\t*ber = data;\n\t*cnt = VSB_TOP_MEASUREMENT_PERIOD * SYMBOLS_PER_SEGMENT;\n\n\treturn 0;\n}\n\n \nstatic int get_vsbmer(struct i2c_device_addr *dev_addr, u16 *mer)\n{\n\tint rc;\n\tu16 data_hi = 0;\n\n\trc = drxj_dap_read_reg16(dev_addr, VSB_TOP_ERR_ENERGY_H__A, &data_hi, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t*mer =\n\t    (u16) (log1_times100(21504) - log1_times100((data_hi << 6) / 52));\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n\n \n \n \n\n \n \n \n \n \n\n \nstatic int power_down_qam(struct drx_demod_instance *demod, bool primary)\n{\n\tstruct drxjscu_cmd cmd_scu = {   0,\n\t\t  0,\n\t\t  0,\n\t\t  NULL,\n\t\t  NULL\n\t};\n\tint rc;\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tstruct drx_cfg_mpeg_output cfg_mpeg_output;\n\tstruct drx_common_attr *common_attr = demod->my_common_attr;\n\tu16 cmd_result = 0;\n\n\t \n\t \n\trc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, QAM_COMM_EXEC__A, QAM_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\n\t    SCU_RAM_COMMAND_CMD_DEMOD_STOP;\n\tcmd_scu.parameter_len = 0;\n\tcmd_scu.result_len = 1;\n\tcmd_scu.parameter = NULL;\n\tcmd_scu.result = &cmd_result;\n\trc = scu_command(dev_addr, &cmd_scu);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tif (primary) {\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = set_iqm_af(demod, false);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t} else {\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\tmemcpy(&cfg_mpeg_output, &common_attr->mpeg_cfg, sizeof(cfg_mpeg_output));\n\tcfg_mpeg_output.enable_mpeg_output = false;\n\n\trc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \n#ifndef DRXJ_VSB_ONLY\nstatic int\nset_qam_measurement(struct drx_demod_instance *demod,\n\t\t    enum drx_modulation constellation, u32 symbol_rate)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\t \n\tstruct drxj_data *ext_attr = NULL;\t \n\tint rc;\n\tu32 fec_bits_desired = 0;\t \n\tu16 fec_rs_plen = 0;\t \n\tu16 fec_rs_prescale = 0;\t \n\tu32 fec_rs_period = 0;\t \n\tu32 fec_rs_bit_cnt = 0;\t \n\tu32 fec_oc_snc_fail_period = 0;\t \n\tu32 qam_vd_period = 0;\t \n\tu32 qam_vd_bit_cnt = 0;\t \n\tu16 fec_vd_plen = 0;\t \n\tu16 qam_vd_prescale = 0;\t \n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\tfec_bits_desired = ext_attr->fec_bits_desired;\n\tfec_rs_prescale = ext_attr->fec_rs_prescale;\n\n\tswitch (constellation) {\n\tcase DRX_CONSTELLATION_QAM16:\n\t\tfec_bits_desired = 4 * symbol_rate;\n\t\tbreak;\n\tcase DRX_CONSTELLATION_QAM32:\n\t\tfec_bits_desired = 5 * symbol_rate;\n\t\tbreak;\n\tcase DRX_CONSTELLATION_QAM64:\n\t\tfec_bits_desired = 6 * symbol_rate;\n\t\tbreak;\n\tcase DRX_CONSTELLATION_QAM128:\n\t\tfec_bits_desired = 7 * symbol_rate;\n\t\tbreak;\n\tcase DRX_CONSTELLATION_QAM256:\n\t\tfec_bits_desired = 8 * symbol_rate;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\t \n\t \n\t \n\t \n\n\t \n\tswitch (ext_attr->standard) {\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_C:\n\t\tfec_rs_plen = 204 * 8;\n\t\tbreak;\n\tcase DRX_STANDARD_ITU_B:\n\t\tfec_rs_plen = 128 * 7;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\text_attr->fec_rs_plen = fec_rs_plen;\t \n\tfec_rs_bit_cnt = fec_rs_prescale * fec_rs_plen;\t \n\tif (fec_rs_bit_cnt == 0) {\n\t\tpr_err(\"error: fec_rs_bit_cnt is zero!\\n\");\n\t\treturn -EIO;\n\t}\n\tfec_rs_period = fec_bits_desired / fec_rs_bit_cnt + 1;\t \n\tif (ext_attr->standard != DRX_STANDARD_ITU_B)\n\t\tfec_oc_snc_fail_period = fec_rs_period;\n\n\t \n\tif (fec_rs_period > 0xFFFF)\n\t\tfec_rs_period = 0xFFFF;\n\n\t \n\tswitch (ext_attr->standard) {\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_C:\n\t\tbreak;\n\tcase DRX_STANDARD_ITU_B:\n\t\tswitch (constellation) {\n\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\tfec_rs_period = 31581;\n\t\t\tfec_oc_snc_fail_period = 17932;\n\t\t\tbreak;\n\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\tfec_rs_period = 45446;\n\t\t\tfec_oc_snc_fail_period = 25805;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, FEC_OC_SNC_FAIL_PERIOD__A, (u16)fec_oc_snc_fail_period, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, FEC_RS_MEASUREMENT_PERIOD__A, (u16)fec_rs_period, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, FEC_RS_MEASUREMENT_PRESCALE__A, fec_rs_prescale, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\text_attr->fec_rs_period = (u16) fec_rs_period;\n\text_attr->fec_rs_prescale = fec_rs_prescale;\n\trc = drxdap_fasi_write_reg32(dev_addr, SCU_RAM_FEC_ACCUM_CW_CORRECTED_LO__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_FEC_MEAS_COUNT__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_FEC_ACCUM_PKT_FAILURES__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tif (ext_attr->standard == DRX_STANDARD_ITU_B) {\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t \n\t\t \n\n\t\t \n\t\tfec_vd_plen = ext_attr->fec_vd_plen;\n\t\tqam_vd_prescale = ext_attr->qam_vd_prescale;\n\t\tqam_vd_bit_cnt = qam_vd_prescale * fec_vd_plen;\t \n\n\t\tswitch (constellation) {\n\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\t \n\t\t\tqam_vd_period =\n\t\t\t    qam_vd_bit_cnt * (QAM_TOP_CONSTELLATION_QAM64 + 1)\n\t\t\t    * (QAM_TOP_CONSTELLATION_QAM64 + 1);\n\t\t\tbreak;\n\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\t \n\t\t\tqam_vd_period =\n\t\t\t    qam_vd_bit_cnt * (QAM_TOP_CONSTELLATION_QAM256 + 1)\n\t\t\t    * (QAM_TOP_CONSTELLATION_QAM256 + 1);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tif (qam_vd_period == 0) {\n\t\t\tpr_err(\"error: qam_vd_period is zero!\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t\tqam_vd_period = fec_bits_desired / qam_vd_period;\n\t\t \n\t\tif (qam_vd_period > 0xFFFF)\n\t\t\tqam_vd_period = 0xFFFF;\n\n\t\t \n\t\tqam_vd_bit_cnt *= qam_vd_period;\n\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_VD_MEASUREMENT_PERIOD__A, (u16)qam_vd_period, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_VD_MEASUREMENT_PRESCALE__A, qam_vd_prescale, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\text_attr->qam_vd_period = (u16) qam_vd_period;\n\t\text_attr->qam_vd_prescale = qam_vd_prescale;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int set_qam16(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tint rc;\n\tstatic const u8 qam_dq_qual_fun[] = {\n\t\tDRXJ_16TO8(2),\t \n\t\tDRXJ_16TO8(2),\t \n\t\tDRXJ_16TO8(2),\t \n\t\tDRXJ_16TO8(2),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(3),\t \n\t};\n\tstatic const u8 qam_eq_cma_rad[] = {\n\t\tDRXJ_16TO8(13517),\t \n\t\tDRXJ_16TO8(13517),\t \n\t\tDRXJ_16TO8(13517),\t \n\t\tDRXJ_16TO8(13517),\t \n\t\tDRXJ_16TO8(13517),\t \n\t\tDRXJ_16TO8(13517),\t \n\t};\n\n\trc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 140, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 50, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 120, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 230, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 95, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 105, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 56, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 220, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, 25, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, 6, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16)(-24), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16)(-65), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-127), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 20, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 10, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 50, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 32, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 240, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 32, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 40960, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int set_qam32(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tint rc;\n\tstatic const u8 qam_dq_qual_fun[] = {\n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(4),\t \n\t};\n\tstatic const u8 qam_eq_cma_rad[] = {\n\t\tDRXJ_16TO8(6707),\t \n\t\tDRXJ_16TO8(6707),\t \n\t\tDRXJ_16TO8(6707),\t \n\t\tDRXJ_16TO8(6707),\t \n\t\tDRXJ_16TO8(6707),\t \n\t\tDRXJ_16TO8(6707),\t \n\t};\n\n\trc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 90, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 50, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 100, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 170, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 80, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 100, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 56, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 140, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, (u16)(-8), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, (u16)(-16), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16)(-26), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16)(-56), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-86), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 20, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 10, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 50, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 32, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 176, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 20480, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int set_qam64(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tint rc;\n\tstatic const u8 qam_dq_qual_fun[] = {\n\t\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(6),\t \n\t\tDRXJ_16TO8(6),\t \n\t};\n\tstatic const u8 qam_eq_cma_rad[] = {\n\t\tDRXJ_16TO8(13336),\t \n\t\tDRXJ_16TO8(12618),\t \n\t\tDRXJ_16TO8(11988),\t \n\t\tDRXJ_16TO8(13809),\t \n\t\tDRXJ_16TO8(13809),\t \n\t\tDRXJ_16TO8(15609),\t \n\t};\n\n\trc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 105, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 60, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 100, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 195, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 80, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 84, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 32, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 141, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, 7, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16)(-15), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, (u16)(-45), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-80), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 30, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 80, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 48, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 160, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 32, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 43008, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int set_qam128(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tint rc;\n\tstatic const u8 qam_dq_qual_fun[] = {\n\t\tDRXJ_16TO8(6),\t \n\t\tDRXJ_16TO8(6),\t \n\t\tDRXJ_16TO8(6),\t \n\t\tDRXJ_16TO8(6),\t \n\t\tDRXJ_16TO8(9),\t \n\t\tDRXJ_16TO8(9),\t \n\t};\n\tstatic const u8 qam_eq_cma_rad[] = {\n\t\tDRXJ_16TO8(6164),\t \n\t\tDRXJ_16TO8(6598),\t \n\t\tDRXJ_16TO8(6394),\t \n\t\tDRXJ_16TO8(6409),\t \n\t\tDRXJ_16TO8(6656),\t \n\t\tDRXJ_16TO8(7238),\t \n\t};\n\n\trc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 50, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 60, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 100, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 140, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 80, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 100, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 32, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 65, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, 5, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, (u16)(-1), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-23), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 20, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 80, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 32, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 144, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 20992, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int set_qam256(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tint rc;\n\tstatic const u8 qam_dq_qual_fun[] = {\n\t\tDRXJ_16TO8(8),\t \n\t\tDRXJ_16TO8(8),\t \n\t\tDRXJ_16TO8(8),\t \n\t\tDRXJ_16TO8(8),\t \n\t\tDRXJ_16TO8(12),\t \n\t\tDRXJ_16TO8(12),\t \n\t};\n\tstatic const u8 qam_eq_cma_rad[] = {\n\t\tDRXJ_16TO8(12345),\t \n\t\tDRXJ_16TO8(12345),\t \n\t\tDRXJ_16TO8(13626),\t \n\t\tDRXJ_16TO8(12931),\t \n\t\tDRXJ_16TO8(14719),\t \n\t\tDRXJ_16TO8(15356),\t \n\t};\n\n\trc = drxdap_fasi_write_block(dev_addr, QAM_DQ_QUAL_FUN0__A, sizeof(qam_dq_qual_fun), ((u8 *)qam_dq_qual_fun), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxdap_fasi_write_block(dev_addr, SCU_RAM_QAM_EQ_CMA_RAD0__A, sizeof(qam_eq_cma_rad), ((u8 *)qam_eq_cma_rad), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RTH__A, 50, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FTH__A, 60, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_PTH__A, 100, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_QTH__A, 150, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_CTH__A, 80, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MTH__A, 110, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RATE_LIM__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_FREQ_LIM__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_COUNT_LIM__A, 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_MEDIAN_AV_MULT__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_RADIUS_AV_LIMIT__A, 74, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET1__A, 18, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET2__A, 13, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET3__A, 7, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET4__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_LCAVG_OFFSET5__A, (u16)(-8), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_FINE__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CA_COARSE__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_MEDIUM__A, 50, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CP_COARSE__A, 255, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_FINE__A, 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_MEDIUM__A, 25, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CI_COARSE__A, 80, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_MEDIUM__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EP_COARSE__A, 24, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_FINE__A, 12, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_MEDIUM__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_EI_COARSE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_FINE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_MEDIUM__A, 48, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF_COARSE__A, 80, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_FINE__A, 5, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_MEDIUM__A, 15, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_LC_CF1_COARSE__A, 16, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_SL_SIG_POWER__A, 43520, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n#define QAM_SET_OP_ALL 0x1\n#define QAM_SET_OP_CONSTELLATION 0x2\n#define QAM_SET_OP_SPECTRUM 0X4\n\n \nstatic int\nset_qam(struct drx_demod_instance *demod,\n\tstruct drx_channel *channel, s32 tuner_freq_offset, u32 op)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxj_data *ext_attr = NULL;\n\tstruct drx_common_attr *common_attr = NULL;\n\tint rc;\n\tu32 adc_frequency = 0;\n\tu32 iqm_rc_rate = 0;\n\tu16 cmd_result = 0;\n\tu16 lc_symbol_freq = 0;\n\tu16 iqm_rc_stretch = 0;\n\tu16 set_env_parameters = 0;\n\tu16 set_param_parameters[2] = { 0 };\n\tstruct drxjscu_cmd cmd_scu = {   0,\n\t\t  0,\n\t\t  0,\n\t\t  NULL,\n\t\t  NULL\n\t};\n\tstatic const u8 qam_a_taps[] = {\n\t\tDRXJ_16TO8(-1),\t \n\t\tDRXJ_16TO8(1),\t \n\t\tDRXJ_16TO8(1),\t \n\t\tDRXJ_16TO8(-1),\t \n\t\tDRXJ_16TO8(-1),\t \n\t\tDRXJ_16TO8(2),\t \n\t\tDRXJ_16TO8(1),\t \n\t\tDRXJ_16TO8(-2),\t \n\t\tDRXJ_16TO8(0),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(-1),\t \n\t\tDRXJ_16TO8(-3),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(1),\t \n\t\tDRXJ_16TO8(-8),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(13),\t \n\t\tDRXJ_16TO8(-13),\t \n\t\tDRXJ_16TO8(-19),\t \n\t\tDRXJ_16TO8(28),\t \n\t\tDRXJ_16TO8(25),\t \n\t\tDRXJ_16TO8(-53),\t \n\t\tDRXJ_16TO8(-31),\t \n\t\tDRXJ_16TO8(96),\t \n\t\tDRXJ_16TO8(37),\t \n\t\tDRXJ_16TO8(-190),\t \n\t\tDRXJ_16TO8(-40),\t \n\t\tDRXJ_16TO8(619)\t \n\t};\n\tstatic const u8 qam_b64_taps[] = {\n\t\tDRXJ_16TO8(0),\t \n\t\tDRXJ_16TO8(-2),\t \n\t\tDRXJ_16TO8(1),\t \n\t\tDRXJ_16TO8(2),\t \n\t\tDRXJ_16TO8(-2),\t \n\t\tDRXJ_16TO8(0),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(-2),\t \n\t\tDRXJ_16TO8(-4),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(-6),\t \n\t\tDRXJ_16TO8(0),\t \n\t\tDRXJ_16TO8(6),\t \n\t\tDRXJ_16TO8(-5),\t \n\t\tDRXJ_16TO8(-3),\t \n\t\tDRXJ_16TO8(11),\t \n\t\tDRXJ_16TO8(-4),\t \n\t\tDRXJ_16TO8(-19),\t \n\t\tDRXJ_16TO8(19),\t \n\t\tDRXJ_16TO8(28),\t \n\t\tDRXJ_16TO8(-45),\t \n\t\tDRXJ_16TO8(-36),\t \n\t\tDRXJ_16TO8(90),\t \n\t\tDRXJ_16TO8(42),\t \n\t\tDRXJ_16TO8(-185),\t \n\t\tDRXJ_16TO8(-46),\t \n\t\tDRXJ_16TO8(614)\t \n\t};\n\tstatic const u8 qam_b256_taps[] = {\n\t\tDRXJ_16TO8(-2),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(1),\t \n\t\tDRXJ_16TO8(-4),\t \n\t\tDRXJ_16TO8(0),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(-2),\t \n\t\tDRXJ_16TO8(-4),\t \n\t\tDRXJ_16TO8(5),\t \n\t\tDRXJ_16TO8(2),\t \n\t\tDRXJ_16TO8(-8),\t \n\t\tDRXJ_16TO8(2),\t \n\t\tDRXJ_16TO8(11),\t \n\t\tDRXJ_16TO8(-8),\t \n\t\tDRXJ_16TO8(-15),\t \n\t\tDRXJ_16TO8(16),\t \n\t\tDRXJ_16TO8(19),\t \n\t\tDRXJ_16TO8(-27),\t \n\t\tDRXJ_16TO8(-22),\t \n\t\tDRXJ_16TO8(44),\t \n\t\tDRXJ_16TO8(26),\t \n\t\tDRXJ_16TO8(-69),\t \n\t\tDRXJ_16TO8(-28),\t \n\t\tDRXJ_16TO8(110),\t \n\t\tDRXJ_16TO8(31),\t \n\t\tDRXJ_16TO8(-201),\t \n\t\tDRXJ_16TO8(-32),\t \n\t\tDRXJ_16TO8(628)\t \n\t};\n\tstatic const u8 qam_c_taps[] = {\n\t\tDRXJ_16TO8(-3),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(2),\t \n\t\tDRXJ_16TO8(-4),\t \n\t\tDRXJ_16TO8(0),\t \n\t\tDRXJ_16TO8(4),\t \n\t\tDRXJ_16TO8(-1),\t \n\t\tDRXJ_16TO8(-4),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(3),\t \n\t\tDRXJ_16TO8(-5),\t \n\t\tDRXJ_16TO8(0),\t \n\t\tDRXJ_16TO8(9),\t \n\t\tDRXJ_16TO8(-4),\t \n\t\tDRXJ_16TO8(-12),\t \n\t\tDRXJ_16TO8(10),\t \n\t\tDRXJ_16TO8(16),\t \n\t\tDRXJ_16TO8(-21),\t \n\t\tDRXJ_16TO8(-20),\t \n\t\tDRXJ_16TO8(37),\t \n\t\tDRXJ_16TO8(25),\t \n\t\tDRXJ_16TO8(-62),\t \n\t\tDRXJ_16TO8(-28),\t \n\t\tDRXJ_16TO8(105),\t \n\t\tDRXJ_16TO8(31),\t \n\t\tDRXJ_16TO8(-197),\t \n\t\tDRXJ_16TO8(-33),\t \n\t\tDRXJ_16TO8(626)\t \n\t};\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\n\tif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\n\t\tif (ext_attr->standard == DRX_STANDARD_ITU_B) {\n\t\t\tswitch (channel->constellation) {\n\t\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\t\tiqm_rc_rate = 0x00AE3562;\n\t\t\t\tlc_symbol_freq =\n\t\t\t\t    QAM_LC_SYMBOL_FREQ_FREQ_QAM_B_256;\n\t\t\t\tchannel->symbolrate = 5360537;\n\t\t\t\tiqm_rc_stretch = IQM_RC_STRETCH_QAM_B_256;\n\t\t\t\tbreak;\n\t\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\t\tiqm_rc_rate = 0x00C05A0E;\n\t\t\t\tlc_symbol_freq = 409;\n\t\t\t\tchannel->symbolrate = 5056941;\n\t\t\t\tiqm_rc_stretch = IQM_RC_STRETCH_QAM_B_64;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t} else {\n\t\t\tadc_frequency = (common_attr->sys_clock_freq * 1000) / 3;\n\t\t\tif (channel->symbolrate == 0) {\n\t\t\t\tpr_err(\"error: channel symbolrate is zero!\\n\");\n\t\t\t\treturn -EIO;\n\t\t\t}\n\t\t\tiqm_rc_rate =\n\t\t\t    (adc_frequency / channel->symbolrate) * (1 << 21) +\n\t\t\t    (frac28\n\t\t\t     ((adc_frequency % channel->symbolrate),\n\t\t\t      channel->symbolrate) >> 7) - (1 << 23);\n\t\t\tlc_symbol_freq =\n\t\t\t    (u16) (frac28\n\t\t\t\t     (channel->symbolrate +\n\t\t\t\t      (adc_frequency >> 13),\n\t\t\t\t      adc_frequency) >> 16);\n\t\t\tif (lc_symbol_freq > 511)\n\t\t\t\tlc_symbol_freq = 511;\n\n\t\t\tiqm_rc_stretch = 21;\n\t\t}\n\n\t\tif (ext_attr->standard == DRX_STANDARD_ITU_A) {\n\t\t\tset_env_parameters = QAM_TOP_ANNEX_A;\t \n\t\t\tset_param_parameters[0] = channel->constellation;\t \n\t\t\tset_param_parameters[1] = DRX_INTERLEAVEMODE_I12_J17;\t \n\t\t} else if (ext_attr->standard == DRX_STANDARD_ITU_B) {\n\t\t\tset_env_parameters = QAM_TOP_ANNEX_B;\t \n\t\t\tset_param_parameters[0] = channel->constellation;\t \n\t\t\tset_param_parameters[1] = channel->interleavemode;\t \n\t\t} else if (ext_attr->standard == DRX_STANDARD_ITU_C) {\n\t\t\tset_env_parameters = QAM_TOP_ANNEX_C;\t \n\t\t\tset_param_parameters[0] = channel->constellation;\t \n\t\t\tset_param_parameters[1] = DRX_INTERLEAVEMODE_I12_J17;\t \n\t\t} else {\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tif (op & QAM_SET_OP_ALL) {\n\t\t \n\t\t \n\t\trc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_COMM_EXEC__A, QAM_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\n\t\t    SCU_RAM_COMMAND_CMD_DEMOD_RESET;\n\t\tcmd_scu.parameter_len = 0;\n\t\tcmd_scu.result_len = 1;\n\t\tcmd_scu.parameter = NULL;\n\t\tcmd_scu.result = &cmd_result;\n\t\trc = scu_command(dev_addr, &cmd_scu);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\tif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\n\t\t \n\t\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\n\t\t    SCU_RAM_COMMAND_CMD_DEMOD_SET_ENV;\n\t\tcmd_scu.parameter_len = 1;\n\t\tcmd_scu.result_len = 1;\n\t\tcmd_scu.parameter = &set_env_parameters;\n\t\tcmd_scu.result = &cmd_result;\n\t\trc = scu_command(dev_addr, &cmd_scu);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\n\t\t    SCU_RAM_COMMAND_CMD_DEMOD_SET_PARAM;\n\t\tcmd_scu.parameter_len = 2;\n\t\tcmd_scu.result_len = 1;\n\t\tcmd_scu.parameter = set_param_parameters;\n\t\tcmd_scu.result = &cmd_result;\n\t\trc = scu_command(dev_addr, &cmd_scu);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\t \n\t\trc = drxdap_fasi_write_reg32(dev_addr, IQM_RC_RATE_OFS_LO__A, iqm_rc_rate, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\text_attr->iqm_rc_rate_ofs = iqm_rc_rate;\n\t\trc = set_qam_measurement(demod, channel->constellation, channel->symbolrate);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\t \n\t \n\t \n\tif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_SPECTRUM)) {\n\t\trc = set_frequency(demod, channel, tuner_freq_offset);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\tif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\n\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_SYMBOL_FREQ__A, lc_symbol_freq, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_STRETCH__A, iqm_rc_stretch, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\tif (op & QAM_SET_OP_ALL) {\n\t\tif (!ext_attr->has_lna) {\n\t\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_AMUX__A, 0x02, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_SYMMETRIC__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_MIDTAP__A, 3, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_OUT_ENA__A, IQM_CF_OUT_ENA_QAM__M, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_WR_RSV_0__A, 0x5f, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\t \n\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_SYNC_SEL__A, 3, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLP_LEN__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_CLP_TH__A, 448, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_SNS_LEN__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_PDREF__A, 4, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_STDBY__A, 0x10, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_PGA_GAIN__A, 11, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_POW_MEAS_LEN__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_SCALE_SH__A, IQM_CF_SCALE_SH__PRE, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\t \n\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_TIMEOUT__A, QAM_SY_TIMEOUT__PRE, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\t \n\t\tif (ext_attr->standard == DRX_STANDARD_ITU_B) {\n\t\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_LWM__A, QAM_SY_SYNC_LWM__PRE, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\t \n\t\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_AWM__A, QAM_SY_SYNC_AWM__PRE, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\t \n\t\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_HWM__A, QAM_SY_SYNC_HWM__PRE, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\t \n\t\t} else {\n\t\t\tswitch (channel->constellation) {\n\t\t\tcase DRX_CONSTELLATION_QAM16:\n\t\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_LWM__A, 0x03, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_AWM__A, 0x04, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_HWM__A, QAM_SY_SYNC_HWM__PRE, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\t \n\t\t\t\tbreak;\n\t\t\tcase DRX_CONSTELLATION_QAM32:\n\t\t\tcase DRX_CONSTELLATION_QAM128:\n\t\t\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_LWM__A, 0x03, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_AWM__A, 0x05, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = drxj_dap_write_reg16(dev_addr, QAM_SY_SYNC_HWM__A, 0x06, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -EIO;\n\t\t\t}\t \n\t\t}\n\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_MODE__A, QAM_LC_MODE__PRE, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\t \n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_RATE_LIMIT__A, 3, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_LPF_FACTORP__A, 4, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_LPF_FACTORI__A, 4, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_MODE__A, 7, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB0__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB1__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB2__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB3__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB4__A, 2, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB5__A, 2, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB6__A, 2, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB8__A, 2, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB9__A, 2, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB10__A, 2, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB12__A, 2, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB15__A, 3, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB16__A, 3, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB20__A, 4, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_QUAL_TAB25__A, 4, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_FS_ADJ_SEL__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_ADJ_SEL__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_ADJ_SEL__A, 1, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_POW_MEAS_LEN__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_GPIO__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\t \n\t\t \n\t\trc = set_iqm_af(demod, true);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = adc_synchronization(demod);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\trc = init_agc(demod);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = set_agc_if(demod, &(ext_attr->qam_if_agc_cfg), false);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = set_agc_rf(demod, &(ext_attr->qam_rf_agc_cfg), false);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\t{\n\t\t\t \n\t\t\tstruct drxj_cfg_afe_gain qam_pga_cfg = { DRX_STANDARD_ITU_B, 0 };\n\n\t\t\tqam_pga_cfg.gain = ext_attr->qam_pga_cfg;\n\t\t\trc = ctrl_set_cfg_afe_gain(demod, &qam_pga_cfg);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t}\n\t\trc = ctrl_set_cfg_pre_saw(demod, &(ext_attr->qam_pre_saw_cfg));\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\tif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\n\t\tif (ext_attr->standard == DRX_STANDARD_ITU_A) {\n\t\t\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(qam_a_taps), ((u8 *)qam_a_taps), 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(qam_a_taps), ((u8 *)qam_a_taps), 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t} else if (ext_attr->standard == DRX_STANDARD_ITU_B) {\n\t\t\tswitch (channel->constellation) {\n\t\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\t\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(qam_b64_taps), ((u8 *)qam_b64_taps), 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(qam_b64_taps), ((u8 *)qam_b64_taps), 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\t\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(qam_b256_taps), ((u8 *)qam_b256_taps), 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(qam_b256_taps), ((u8 *)qam_b256_taps), 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -EIO;\n\t\t\t}\n\t\t} else if (ext_attr->standard == DRX_STANDARD_ITU_C) {\n\t\t\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_RE0__A, sizeof(qam_c_taps), ((u8 *)qam_c_taps), 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxdap_fasi_write_block(dev_addr, IQM_CF_TAP_IM0__A, sizeof(qam_c_taps), ((u8 *)qam_c_taps), 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tswitch (channel->constellation) {\n\t\tcase DRX_CONSTELLATION_QAM16:\n\t\t\trc = set_qam16(demod);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_CONSTELLATION_QAM32:\n\t\t\trc = set_qam32(demod);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\trc = set_qam64(demod);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_CONSTELLATION_QAM128:\n\t\t\trc = set_qam128(demod);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\trc = set_qam256(demod);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EIO;\n\t\t}\t\t \n\t}\n\n\tif ((op & QAM_SET_OP_ALL)) {\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_SCALE_SH__A, 0, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\t \n\t\trc = set_mpegtei_handling(demod);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = bit_reverse_mpeg_output(demod);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = set_mpeg_start_width(demod);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\t{\n\t\t\t \n\t\t\t \n\t\t\tstruct drx_cfg_mpeg_output cfg_mpeg_output;\n\n\t\t\tmemcpy(&cfg_mpeg_output, &common_attr->mpeg_cfg, sizeof(cfg_mpeg_output));\n\t\t\tcfg_mpeg_output.enable_mpeg_output = true;\n\n\t\t\trc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ((op & QAM_SET_OP_ALL) || (op & QAM_SET_OP_CONSTELLATION)) {\n\n\t\t \n\t\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\n\t\t    SCU_RAM_COMMAND_CMD_DEMOD_START;\n\t\tcmd_scu.parameter_len = 0;\n\t\tcmd_scu.result_len = 1;\n\t\tcmd_scu.parameter = NULL;\n\t\tcmd_scu.result = &cmd_result;\n\t\trc = scu_command(dev_addr, &cmd_scu);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, QAM_COMM_EXEC__A, QAM_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, FEC_COMM_EXEC__A, FEC_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int ctrl_get_qam_sig_quality(struct drx_demod_instance *demod);\n\nstatic int qam_flip_spec(struct drx_demod_instance *demod, struct drx_channel *channel)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tstruct drxj_data *ext_attr = demod->my_ext_attr;\n\tint rc;\n\tu32 iqm_fs_rate_ofs = 0;\n\tu32 iqm_fs_rate_lo = 0;\n\tu16 qam_ctl_ena = 0;\n\tu16 data = 0;\n\tu16 equ_mode = 0;\n\tu16 fsm_state = 0;\n\tint i = 0;\n\tint ofsofs = 0;\n\n\t \n\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_QAM_CTL_ENA__A, &qam_ctl_ena, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_CTL_ENA__A, qam_ctl_ena & ~(SCU_RAM_QAM_CTL_ENA_ACQ__M | SCU_RAM_QAM_CTL_ENA_EQU__M | SCU_RAM_QAM_CTL_ENA_LC__M), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_CF__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_CF1__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_atomic_read_reg32(dev_addr, IQM_FS_RATE_OFS_LO__A, &iqm_fs_rate_ofs, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_atomic_read_reg32(dev_addr, IQM_FS_RATE_LO__A, &iqm_fs_rate_lo, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tofsofs = iqm_fs_rate_lo - iqm_fs_rate_ofs;\n\tiqm_fs_rate_ofs = ~iqm_fs_rate_ofs + 1;\n\tiqm_fs_rate_ofs -= 2 * ofsofs;\n\n\t \n\trc = drxj_dap_read_reg16(dev_addr, QAM_DQ_MODE__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tdata = (data & 0xfff9);\n\trc = drxj_dap_write_reg16(dev_addr, QAM_DQ_MODE__A, data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, QAM_FQ_MODE__A, data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_CI__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, QAM_LC_EP__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, QAM_FQ_LA_FACTOR__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxdap_fasi_write_reg32(dev_addr, IQM_FS_RATE_OFS_LO__A, iqm_fs_rate_ofs, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\text_attr->iqm_fs_rate_ofs = iqm_fs_rate_ofs;\n\text_attr->pos_image = (ext_attr->pos_image) ? false : true;\n\n\t \n\trc = drxj_dap_read_reg16(dev_addr, QAM_DQ_MODE__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tequ_mode = data;\n\tdata = (data & 0xfff9);\n\trc = drxj_dap_write_reg16(dev_addr, QAM_DQ_MODE__A, data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, QAM_FQ_MODE__A, data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tfor (i = 0; i < 28; i++) {\n\t\trc = drxj_dap_read_reg16(dev_addr, QAM_DQ_TAP_IM_EL0__A + (2 * i), &data, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_DQ_TAP_IM_EL0__A + (2 * i), -data, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\tfor (i = 0; i < 24; i++) {\n\t\trc = drxj_dap_read_reg16(dev_addr, QAM_FQ_TAP_IM_EL0__A + (2 * i), &data, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, QAM_FQ_TAP_IM_EL0__A + (2 * i), -data, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\tdata = equ_mode;\n\trc = drxj_dap_write_reg16(dev_addr, QAM_DQ_MODE__A, data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, QAM_FQ_MODE__A, data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_FSM_STATE_TGT__A, 4, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\ti = 0;\n\twhile ((fsm_state != 4) && (i++ < 100)) {\n\t\trc = drxj_dap_read_reg16(dev_addr, SCU_RAM_QAM_FSM_STATE__A, &fsm_state, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_QAM_CTL_ENA__A, (qam_ctl_ena | 0x0016), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n\n}\n\n#define  NO_LOCK        0x0\n#define  DEMOD_LOCKED   0x1\n#define  SYNC_FLIPPED   0x2\n#define  SPEC_MIRRORED  0x4\n \nstatic int\nqam64auto(struct drx_demod_instance *demod,\n\t  struct drx_channel *channel,\n\t  s32 tuner_freq_offset, enum drx_lock_status *lock_status)\n{\n\tstruct drxj_data *ext_attr = demod->my_ext_attr;\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tstruct drx39xxj_state *state = dev_addr->user_data;\n\tstruct dtv_frontend_properties *p = &state->frontend.dtv_property_cache;\n\tint rc;\n\tu32 lck_state = NO_LOCK;\n\tu32 start_time = 0;\n\tu32 d_locked_time = 0;\n\tu32 timeout_ofs = 0;\n\tu16 data = 0;\n\n\t \n\t*lock_status = DRX_NOT_LOCKED;\n\tstart_time = jiffies_to_msecs(jiffies);\n\tlck_state = NO_LOCK;\n\tdo {\n\t\trc = ctrl_lock_status(demod, lock_status);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\tswitch (lck_state) {\n\t\tcase NO_LOCK:\n\t\t\tif (*lock_status == DRXJ_DEMOD_LOCK) {\n\t\t\t\trc = ctrl_get_qam_sig_quality(demod);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\tif (p->cnr.stat[0].svalue > 20800) {\n\t\t\t\t\tlck_state = DEMOD_LOCKED;\n\t\t\t\t\t \n\t\t\t\t\ttimeout_ofs += DRXJ_QAM_DEMOD_LOCK_EXT_WAITTIME;\t \n\t\t\t\t\td_locked_time = jiffies_to_msecs(jiffies);\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DEMOD_LOCKED:\n\t\t\tif ((*lock_status == DRXJ_DEMOD_LOCK) &&\t \n\t\t\t    ((jiffies_to_msecs(jiffies) - d_locked_time) >\n\t\t\t     DRXJ_QAM_FEC_LOCK_WAITTIME)) {\n\t\t\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, &data, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, data | 0x1, 0);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\tlck_state = SYNC_FLIPPED;\n\t\t\t\tmsleep(10);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase SYNC_FLIPPED:\n\t\t\tif (*lock_status == DRXJ_DEMOD_LOCK) {\n\t\t\t\tif (channel->mirror == DRX_MIRROR_AUTO) {\n\t\t\t\t\t \n\t\t\t\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, &data, 0);\n\t\t\t\t\tif (rc != 0) {\n\t\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\t\tgoto rw_error;\n\t\t\t\t\t}\n\t\t\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, data & 0xFFFE, 0);\n\t\t\t\t\tif (rc != 0) {\n\t\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\t\tgoto rw_error;\n\t\t\t\t\t}\n\t\t\t\t\t \n\t\t\t\t\text_attr->mirror = DRX_MIRROR_YES;\n\t\t\t\t\trc = qam_flip_spec(demod, channel);\n\t\t\t\t\tif (rc != 0) {\n\t\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\t\tgoto rw_error;\n\t\t\t\t\t}\n\t\t\t\t\tlck_state = SPEC_MIRRORED;\n\t\t\t\t\t \n\t\t\t\t\tstart_time = d_locked_time =\n\t\t\t\t\t    jiffies_to_msecs(jiffies);\n\t\t\t\t\ttimeout_ofs = 0;\n\t\t\t\t} else {\t \n\n\t\t\t\t\tstart_time =\n\t\t\t\t\t    jiffies_to_msecs(jiffies) -\n\t\t\t\t\t    DRXJ_QAM_MAX_WAITTIME - timeout_ofs;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase SPEC_MIRRORED:\n\t\t\tif ((*lock_status == DRXJ_DEMOD_LOCK) &&\t \n\t\t\t    ((jiffies_to_msecs(jiffies) - d_locked_time) >\n\t\t\t     DRXJ_QAM_FEC_LOCK_WAITTIME)) {\n\t\t\t\trc = ctrl_get_qam_sig_quality(demod);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\tif (p->cnr.stat[0].svalue > 20800) {\n\t\t\t\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, &data, 0);\n\t\t\t\t\tif (rc != 0) {\n\t\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\t\tgoto rw_error;\n\t\t\t\t\t}\n\t\t\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr, QAM_SY_TIMEOUT__A, data | 0x1, 0);\n\t\t\t\t\tif (rc != 0) {\n\t\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\t\tgoto rw_error;\n\t\t\t\t\t}\n\t\t\t\t\t \n\t\t\t\t\tstart_time =\n\t\t\t\t\t    jiffies_to_msecs(jiffies) -\n\t\t\t\t\t    DRXJ_QAM_MAX_WAITTIME - timeout_ofs;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tmsleep(10);\n\t} while\n\t    ((*lock_status != DRX_LOCKED) &&\n\t     (*lock_status != DRX_NEVER_LOCK) &&\n\t     ((jiffies_to_msecs(jiffies) - start_time) <\n\t      (DRXJ_QAM_MAX_WAITTIME + timeout_ofs))\n\t    );\n\t \n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int\nqam256auto(struct drx_demod_instance *demod,\n\t   struct drx_channel *channel,\n\t   s32 tuner_freq_offset, enum drx_lock_status *lock_status)\n{\n\tstruct drxj_data *ext_attr = demod->my_ext_attr;\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tstruct drx39xxj_state *state = dev_addr->user_data;\n\tstruct dtv_frontend_properties *p = &state->frontend.dtv_property_cache;\n\tint rc;\n\tu32 lck_state = NO_LOCK;\n\tu32 start_time = 0;\n\tu32 d_locked_time = 0;\n\tu32 timeout_ofs = DRXJ_QAM_DEMOD_LOCK_EXT_WAITTIME;\n\n\t \n\t*lock_status = DRX_NOT_LOCKED;\n\tstart_time = jiffies_to_msecs(jiffies);\n\tlck_state = NO_LOCK;\n\tdo {\n\t\trc = ctrl_lock_status(demod, lock_status);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tswitch (lck_state) {\n\t\tcase NO_LOCK:\n\t\t\tif (*lock_status == DRXJ_DEMOD_LOCK) {\n\t\t\t\trc = ctrl_get_qam_sig_quality(demod);\n\t\t\t\tif (rc != 0) {\n\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\tgoto rw_error;\n\t\t\t\t}\n\t\t\t\tif (p->cnr.stat[0].svalue > 26800) {\n\t\t\t\t\tlck_state = DEMOD_LOCKED;\n\t\t\t\t\ttimeout_ofs += DRXJ_QAM_DEMOD_LOCK_EXT_WAITTIME;\t \n\t\t\t\t\td_locked_time = jiffies_to_msecs(jiffies);\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DEMOD_LOCKED:\n\t\t\tif (*lock_status == DRXJ_DEMOD_LOCK) {\n\t\t\t\tif ((channel->mirror == DRX_MIRROR_AUTO) &&\n\t\t\t\t    ((jiffies_to_msecs(jiffies) - d_locked_time) >\n\t\t\t\t     DRXJ_QAM_FEC_LOCK_WAITTIME)) {\n\t\t\t\t\text_attr->mirror = DRX_MIRROR_YES;\n\t\t\t\t\trc = qam_flip_spec(demod, channel);\n\t\t\t\t\tif (rc != 0) {\n\t\t\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\t\t\tgoto rw_error;\n\t\t\t\t\t}\n\t\t\t\t\tlck_state = SPEC_MIRRORED;\n\t\t\t\t\t \n\t\t\t\t\tstart_time = jiffies_to_msecs(jiffies);\n\t\t\t\t\ttimeout_ofs = -DRXJ_QAM_MAX_WAITTIME / 2;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase SPEC_MIRRORED:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tmsleep(10);\n\t} while\n\t    ((*lock_status < DRX_LOCKED) &&\n\t     (*lock_status != DRX_NEVER_LOCK) &&\n\t     ((jiffies_to_msecs(jiffies) - start_time) <\n\t      (DRXJ_QAM_MAX_WAITTIME + timeout_ofs)));\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int\nset_qam_channel(struct drx_demod_instance *demod,\n\t       struct drx_channel *channel, s32 tuner_freq_offset)\n{\n\tstruct drxj_data *ext_attr = NULL;\n\tint rc;\n\tenum drx_lock_status lock_status = DRX_NOT_LOCKED;\n\tbool auto_flag = false;\n\n\t \n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\t \n\tswitch (channel->constellation) {\n\tcase DRX_CONSTELLATION_QAM16:\n\tcase DRX_CONSTELLATION_QAM32:\n\tcase DRX_CONSTELLATION_QAM128:\n\t\treturn -EINVAL;\n\tcase DRX_CONSTELLATION_QAM64:\n\tcase DRX_CONSTELLATION_QAM256:\n\t\tif (ext_attr->standard != DRX_STANDARD_ITU_B)\n\t\t\treturn -EINVAL;\n\n\t\text_attr->constellation = channel->constellation;\n\t\tif (channel->mirror == DRX_MIRROR_AUTO)\n\t\t\text_attr->mirror = DRX_MIRROR_NO;\n\t\telse\n\t\t\text_attr->mirror = channel->mirror;\n\n\t\trc = set_qam(demod, channel, tuner_freq_offset, QAM_SET_OP_ALL);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\tif (channel->constellation == DRX_CONSTELLATION_QAM64)\n\t\t\trc = qam64auto(demod, channel, tuner_freq_offset,\n\t\t\t\t       &lock_status);\n\t\telse\n\t\t\trc = qam256auto(demod, channel, tuner_freq_offset,\n\t\t\t\t\t&lock_status);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n\tcase DRX_CONSTELLATION_AUTO:\t \n\t\tif (ext_attr->standard == DRX_STANDARD_ITU_B) {\n\t\t\tu16 qam_ctl_ena = 0;\n\n\t\t\tauto_flag = true;\n\n\t\t\t \n\t\t\tchannel->constellation = DRX_CONSTELLATION_QAM256;\n\t\t\text_attr->constellation = DRX_CONSTELLATION_QAM256;\n\t\t\tif (channel->mirror == DRX_MIRROR_AUTO)\n\t\t\t\text_attr->mirror = DRX_MIRROR_NO;\n\t\t\telse\n\t\t\t\text_attr->mirror = channel->mirror;\n\t\t\trc = set_qam(demod, channel, tuner_freq_offset,\n\t\t\t\t     QAM_SET_OP_ALL);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = qam256auto(demod, channel, tuner_freq_offset,\n\t\t\t\t\t&lock_status);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\tif (lock_status >= DRX_LOCKED) {\n\t\t\t\tchannel->constellation = DRX_CONSTELLATION_AUTO;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t \n\t\t\tchannel->constellation = DRX_CONSTELLATION_QAM64;\n\t\t\text_attr->constellation = DRX_CONSTELLATION_QAM64;\n\t\t\tif (channel->mirror == DRX_MIRROR_AUTO)\n\t\t\t\text_attr->mirror = DRX_MIRROR_NO;\n\t\t\telse\n\t\t\t\text_attr->mirror = channel->mirror;\n\n\t\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr,\n\t\t\t\t\t\t     SCU_RAM_QAM_CTL_ENA__A,\n\t\t\t\t\t\t     &qam_ctl_ena, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\n\t\t\t\t\t\t      SCU_RAM_QAM_CTL_ENA__A,\n\t\t\t\t\t\t      qam_ctl_ena & ~SCU_RAM_QAM_CTL_ENA_ACQ__M, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\n\t\t\t\t\t\t      SCU_RAM_QAM_FSM_STATE_TGT__A,\n\t\t\t\t\t\t      0x2, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\t \n\n\t\t\trc = set_qam(demod, channel, tuner_freq_offset,\n\t\t\t\t     QAM_SET_OP_CONSTELLATION);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\n\t\t\t\t\t\t      SCU_RAM_QAM_CTL_ENA__A,\n\t\t\t\t\t\t      qam_ctl_ena, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\trc = qam64auto(demod, channel, tuner_freq_offset,\n\t\t\t\t       &lock_status);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\tchannel->constellation = DRX_CONSTELLATION_AUTO;\n\t\t} else if (ext_attr->standard == DRX_STANDARD_ITU_C) {\n\t\t\tu16 qam_ctl_ena = 0;\n\n\t\t\tchannel->constellation = DRX_CONSTELLATION_QAM64;\n\t\t\text_attr->constellation = DRX_CONSTELLATION_QAM64;\n\t\t\tauto_flag = true;\n\n\t\t\tif (channel->mirror == DRX_MIRROR_AUTO)\n\t\t\t\text_attr->mirror = DRX_MIRROR_NO;\n\t\t\telse\n\t\t\t\text_attr->mirror = channel->mirror;\n\t\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr,\n\t\t\t\t\t\t     SCU_RAM_QAM_CTL_ENA__A,\n\t\t\t\t\t\t     &qam_ctl_ena, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\n\t\t\t\t\t\t      SCU_RAM_QAM_CTL_ENA__A,\n\t\t\t\t\t\t      qam_ctl_ena & ~SCU_RAM_QAM_CTL_ENA_ACQ__M, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\n\t\t\t\t\t\t      SCU_RAM_QAM_FSM_STATE_TGT__A,\n\t\t\t\t\t\t      0x2, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\t \n\n\t\t\trc = set_qam(demod, channel, tuner_freq_offset,\n\t\t\t\t     QAM_SET_OP_CONSTELLATION);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = drxj_dap_write_reg16(demod->my_i2c_dev_addr,\n\t\t\t\t\t\t      SCU_RAM_QAM_CTL_ENA__A,\n\t\t\t\t\t\t      qam_ctl_ena, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\trc = qam64auto(demod, channel, tuner_freq_offset,\n\t\t\t\t       &lock_status);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tchannel->constellation = DRX_CONSTELLATION_AUTO;\n\t\t} else {\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\nrw_error:\n\t \n\tif (auto_flag)\n\t\tchannel->constellation = DRX_CONSTELLATION_AUTO;\n\treturn rc;\n}\n\n \n\n \nstatic int\nget_qamrs_err_count(struct i2c_device_addr *dev_addr,\n\t\t    struct drxjrs_errors *rs_errors)\n{\n\tint rc;\n\tu16 nr_bit_errors = 0,\n\t    nr_symbol_errors = 0,\n\t    nr_packet_errors = 0, nr_failures = 0, nr_snc_par_fail_count = 0;\n\n\t \n\tif (dev_addr == NULL)\n\t\treturn -EINVAL;\n\n\t \n\t \n\t \n\trc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_BIT_ERRORS__A, &nr_bit_errors, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_SYMBOL_ERRORS__A, &nr_symbol_errors, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_PACKET_ERRORS__A, &nr_packet_errors, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = drxj_dap_read_reg16(dev_addr, FEC_RS_NR_FAILURES__A, &nr_failures, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_SNC_FAIL_COUNT__A, &nr_snc_par_fail_count, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\t \n\t \n\n\trs_errors->nr_bit_errors = nr_bit_errors & FEC_RS_NR_BIT_ERRORS__M;\n\trs_errors->nr_symbol_errors = nr_symbol_errors & FEC_RS_NR_SYMBOL_ERRORS__M;\n\trs_errors->nr_packet_errors = nr_packet_errors & FEC_RS_NR_PACKET_ERRORS__M;\n\trs_errors->nr_failures = nr_failures & FEC_RS_NR_FAILURES__M;\n\trs_errors->nr_snc_par_fail_count =\n\t    nr_snc_par_fail_count & FEC_OC_SNC_FAIL_COUNT__M;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \n#define DRXJ_AGC_TOP    0x2800\n#define DRXJ_AGC_SNS    0x1600\n#define DRXJ_RFAGC_MAX  0x3fff\n#define DRXJ_RFAGC_MIN  0x800\n\nstatic int get_sig_strength(struct drx_demod_instance *demod, u16 *sig_strength)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tint rc;\n\tu16 rf_gain = 0;\n\tu16 if_gain = 0;\n\tu16 if_agc_sns = 0;\n\tu16 if_agc_top = 0;\n\tu16 rf_agc_max = 0;\n\tu16 rf_agc_min = 0;\n\n\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_AGC_IF__A, &if_gain, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif_gain &= IQM_AF_AGC_IF__M;\n\trc = drxj_dap_read_reg16(dev_addr, IQM_AF_AGC_RF__A, &rf_gain, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trf_gain &= IQM_AF_AGC_RF__M;\n\n\tif_agc_sns = DRXJ_AGC_SNS;\n\tif_agc_top = DRXJ_AGC_TOP;\n\trf_agc_max = DRXJ_RFAGC_MAX;\n\trf_agc_min = DRXJ_RFAGC_MIN;\n\n\tif (if_gain > if_agc_top) {\n\t\tif (rf_gain > rf_agc_max)\n\t\t\t*sig_strength = 100;\n\t\telse if (rf_gain > rf_agc_min) {\n\t\t\tif (rf_agc_max == rf_agc_min) {\n\t\t\t\tpr_err(\"error: rf_agc_max == rf_agc_min\\n\");\n\t\t\t\treturn -EIO;\n\t\t\t}\n\t\t\t*sig_strength =\n\t\t\t75 + 25 * (rf_gain - rf_agc_min) / (rf_agc_max -\n\t\t\t\t\t\t\t\trf_agc_min);\n\t\t} else\n\t\t\t*sig_strength = 75;\n\t} else if (if_gain > if_agc_sns) {\n\t\tif (if_agc_top == if_agc_sns) {\n\t\t\tpr_err(\"error: if_agc_top == if_agc_sns\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t\t*sig_strength =\n\t\t20 + 55 * (if_gain - if_agc_sns) / (if_agc_top - if_agc_sns);\n\t} else {\n\t\tif (!if_agc_sns) {\n\t\t\tpr_err(\"error: if_agc_sns is zero!\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t\t*sig_strength = (20 * if_gain / if_agc_sns);\n\t}\n\n\tif (*sig_strength <= 7)\n\t\t*sig_strength = 0;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int\nctrl_get_qam_sig_quality(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tstruct drxj_data *ext_attr = demod->my_ext_attr;\n\tstruct drx39xxj_state *state = dev_addr->user_data;\n\tstruct dtv_frontend_properties *p = &state->frontend.dtv_property_cache;\n\tstruct drxjrs_errors measuredrs_errors = { 0, 0, 0, 0, 0 };\n\tenum drx_modulation constellation = ext_attr->constellation;\n\tint rc;\n\n\tu32 pre_bit_err_rs = 0;\t \n\tu32 post_bit_err_rs = 0;\t \n\tu32 pkt_errs = 0;\t \n\tu16 qam_sl_err_power = 0;\t \n\tu16 qsym_err_vd = 0;\t \n\tu16 fec_oc_period = 0;\t \n\tu16 fec_rs_prescale = 0;\t \n\tu16 fec_rs_period = 0;\t \n\t \n\tu32 rs_bit_cnt = 0;\t \n\tu32 qam_sl_sig_power = 0;\t \n\t \n\tu32 e = 0;\t\t \n\tu32 m = 0;\t\t \n\tu32 ber_cnt = 0;\t \n\t \n\tu32 qam_sl_mer = 0;\t \n\tu32 qam_pre_rs_ber = 0;\t \n\tu32 qam_post_rs_ber = 0;\t \n\tu32 qam_vd_ser = 0;\t \n\tu16 qam_vd_prescale = 0;\t \n\tu16 qam_vd_period = 0;\t \n\tu32 vd_bit_cnt = 0;\t \n\n\tp->block_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\n\t \n\t \n\trc = get_qamrs_err_count(dev_addr, &measuredrs_errors);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = drxj_dap_read_reg16(dev_addr, QAM_SL_ERR_POWER__A, &qam_sl_err_power, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = drxj_dap_read_reg16(dev_addr, FEC_OC_SNC_FAIL_PERIOD__A, &fec_oc_period, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tfec_rs_period = ext_attr->fec_rs_period;\n\tfec_rs_prescale = ext_attr->fec_rs_prescale;\n\trs_bit_cnt = fec_rs_period * fec_rs_prescale * ext_attr->fec_rs_plen;\n\tqam_vd_period = ext_attr->qam_vd_period;\n\tqam_vd_prescale = ext_attr->qam_vd_prescale;\n\tvd_bit_cnt = qam_vd_period * qam_vd_prescale * ext_attr->fec_vd_plen;\n\n\t \n\tswitch (constellation) {\n\tcase DRX_CONSTELLATION_QAM16:\n\t\tqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM16 << 2;\n\t\tbreak;\n\tcase DRX_CONSTELLATION_QAM32:\n\t\tqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM32 << 2;\n\t\tbreak;\n\tcase DRX_CONSTELLATION_QAM64:\n\t\tqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM64 << 2;\n\t\tbreak;\n\tcase DRX_CONSTELLATION_QAM128:\n\t\tqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM128 << 2;\n\t\tbreak;\n\tcase DRX_CONSTELLATION_QAM256:\n\t\tqam_sl_sig_power = DRXJ_QAM_SL_SIG_POWER_QAM256 << 2;\n\t\tbreak;\n\tdefault:\n\t\trc = -EIO;\n\t\tgoto rw_error;\n\t}\n\n\t \n\t \n\t \n\t \n\n\t \n\tif (qam_sl_err_power == 0)\n\t\tqam_sl_mer = 0;\n\telse\n\t\tqam_sl_mer = log1_times100(qam_sl_sig_power) - log1_times100((u32)qam_sl_err_power);\n\n\t \n\t \n\t \n\t \n\n\t \n\t \n\trc = drxj_dap_read_reg16(dev_addr, QAM_VD_NR_QSYM_ERRORS__A, &qsym_err_vd, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\t \n\te = (qsym_err_vd & QAM_VD_NR_QSYM_ERRORS_EXP__M) >>\n\t    QAM_VD_NR_QSYM_ERRORS_EXP__B;\n\tm = (qsym_err_vd & QAM_VD_NR_SYMBOL_ERRORS_FIXED_MANT__M) >>\n\t    QAM_VD_NR_SYMBOL_ERRORS_FIXED_MANT__B;\n\n\tif ((m << e) >> 3 > 549752)\n\t\tqam_vd_ser = 500000 * vd_bit_cnt * ((e > 2) ? 1 : 8) / 8;\n\telse\n\t\tqam_vd_ser = m << ((e > 2) ? (e - 3) : e);\n\n\t \n\t \n\t \n\t \n\n\t \n\tpre_bit_err_rs = (u32) measuredrs_errors.nr_bit_errors;\n\tpkt_errs = post_bit_err_rs = (u32) measuredrs_errors.nr_snc_par_fail_count;\n\n\t \n\t \n\te = (pre_bit_err_rs & FEC_RS_NR_BIT_ERRORS_EXP__M) >>\n\t    FEC_RS_NR_BIT_ERRORS_EXP__B;\n\tm = (pre_bit_err_rs & FEC_RS_NR_BIT_ERRORS_FIXED_MANT__M) >>\n\t    FEC_RS_NR_BIT_ERRORS_FIXED_MANT__B;\n\n\tber_cnt = m << e;\n\n\t \n\tif (m > (rs_bit_cnt >> (e + 1)) || (rs_bit_cnt >> e) == 0)\n\t\tqam_pre_rs_ber = 500000 * rs_bit_cnt >> e;\n\telse\n\t\tqam_pre_rs_ber = ber_cnt;\n\n\t \n\t \n\t \n\tif (!fec_oc_period) {\n\t\tqam_post_rs_ber = 0xFFFFFFFF;\n\t} else {\n\t\te = post_bit_err_rs * 742686;\n\t\tm = fec_oc_period * 100;\n\t\tqam_post_rs_ber = e / m;\n\t}\n\n\t \n\tp->pre_bit_count.stat[0].scale = FE_SCALE_COUNTER;\n\tp->post_bit_count.stat[0].scale = FE_SCALE_COUNTER;\n\tp->pre_bit_error.stat[0].scale = FE_SCALE_COUNTER;\n\tp->post_bit_error.stat[0].scale = FE_SCALE_COUNTER;\n\tp->block_error.stat[0].scale = FE_SCALE_COUNTER;\n\tp->cnr.stat[0].scale = FE_SCALE_DECIBEL;\n\n\tp->cnr.stat[0].svalue = ((u16) qam_sl_mer) * 100;\n\tif (ext_attr->standard == DRX_STANDARD_ITU_B) {\n\t\tp->pre_bit_error.stat[0].uvalue += qam_vd_ser;\n\t\tp->pre_bit_count.stat[0].uvalue += vd_bit_cnt * ((e > 2) ? 1 : 8) / 8;\n\t} else {\n\t\tp->pre_bit_error.stat[0].uvalue += qam_pre_rs_ber;\n\t\tp->pre_bit_count.stat[0].uvalue += rs_bit_cnt >> e;\n\t}\n\n\tp->post_bit_error.stat[0].uvalue += qam_post_rs_ber;\n\tp->post_bit_count.stat[0].uvalue += rs_bit_cnt >> e;\n\n\tp->block_error.stat[0].uvalue += pkt_errs;\n\n#ifdef DRXJ_SIGNAL_ACCUM_ERR\n\trc = get_acc_pkt_err(demod, &sig_quality->packet_error);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n#endif\n\n\treturn 0;\nrw_error:\n\tp->pre_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->post_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\n\treturn rc;\n}\n\n#endif  \n\n \n \n \n\n \n \n \n \n \n\n \n \n\n \nstatic int\npower_down_atv(struct drx_demod_instance *demod, enum drx_standard standard, bool primary)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tstruct drxjscu_cmd cmd_scu = {   0,\n\t\t  0,\n\t\t  0,\n\t\t  NULL,\n\t\t  NULL\n\t};\n\tint rc;\n\tu16 cmd_result = 0;\n\n\t \n\n\t \n\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_ATV |\n\t    SCU_RAM_COMMAND_CMD_DEMOD_STOP;\n\tcmd_scu.parameter_len = 0;\n\tcmd_scu.result_len = 1;\n\tcmd_scu.parameter = NULL;\n\tcmd_scu.result = &cmd_result;\n\trc = scu_command(dev_addr, &cmd_scu);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = drxj_dap_write_reg16(dev_addr, ATV_TOP_STDBY__A, (ATV_TOP_STDBY_SIF_STDBY_STANDBY & (~ATV_TOP_STDBY_CVBS_STDBY_A2_ACTIVE)), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, ATV_COMM_EXEC__A, ATV_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (primary) {\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_COMM_EXEC__A, IQM_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = set_iqm_af(demod, false);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t} else {\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_FS_COMM_EXEC__A, IQM_FS_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_FD_COMM_EXEC__A, IQM_FD_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RC_COMM_EXEC__A, IQM_RC_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_RT_COMM_EXEC__A, IQM_RT_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_CF_COMM_EXEC__A, IQM_CF_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\trc = power_down_aud(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int power_down_aud(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxj_data *ext_attr = NULL;\n\tint rc;\n\n\tdev_addr = (struct i2c_device_addr *)demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\trc = drxj_dap_write_reg16(dev_addr, AUD_COMM_EXEC__A, AUD_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\text_attr->aud_data.audio_is_active = false;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \nstatic int set_orx_nsu_aox(struct drx_demod_instance *demod, bool active)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tint rc;\n\tu16 data = 0;\n\n\t \n\trc = drxj_dap_read_reg16(dev_addr, ORX_NSU_AOX_STDBY_W__A, &data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (!active)\n\t\tdata &= ((~ORX_NSU_AOX_STDBY_W_STDBYADC_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYAMP_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYBIAS_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYPLL_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYPD_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYTAGC_IF_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYTAGC_RF_A2_ON) & (~ORX_NSU_AOX_STDBY_W_STDBYFLT_A2_ON));\n\telse\n\t\tdata |= (ORX_NSU_AOX_STDBY_W_STDBYADC_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYAMP_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYBIAS_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYPLL_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYPD_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYTAGC_IF_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYTAGC_RF_A2_ON | ORX_NSU_AOX_STDBY_W_STDBYFLT_A2_ON);\n\trc = drxj_dap_write_reg16(dev_addr, ORX_NSU_AOX_STDBY_W__A, data, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \n#define IMPULSE_COSINE_ALPHA_0_3    {-3, -4, -1, 6, 10, 7, -5, -20, -25, -10, 29, 79, 123, 140}\t \n#define IMPULSE_COSINE_ALPHA_0_5    { 2, 0, -2, -2, 2, 5, 2, -10, -20, -14, 20, 74, 125, 145}\t \n#define IMPULSE_COSINE_ALPHA_RO_0_5 { 0, 0, 1, 2, 3, 0, -7, -15, -16,  0, 34, 77, 114, 128}\t \n\n \n#define NYQFILTERLEN 27\n\nstatic int ctrl_set_oob(struct drx_demod_instance *demod, struct drxoob *oob_param)\n{\n\tint rc;\n\ts32 freq = 0;\t \n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxj_data *ext_attr = NULL;\n\tu16 i = 0;\n\tbool mirror_freq_spect_oob = false;\n\tu16 trk_filter_value = 0;\n\tstruct drxjscu_cmd scu_cmd;\n\tu16 set_param_parameters[3];\n\tu16 cmd_result[2] = { 0, 0 };\n\ts16 nyquist_coeffs[4][(NYQFILTERLEN + 1) / 2] = {\n\t\tIMPULSE_COSINE_ALPHA_0_3,\t \n\t\tIMPULSE_COSINE_ALPHA_0_3,\t \n\t\tIMPULSE_COSINE_ALPHA_0_5,\t \n\t\tIMPULSE_COSINE_ALPHA_RO_0_5\t \n\t};\n\tu8 mode_val[4] = { 2, 2, 0, 1 };\n\tu8 pfi_coeffs[4][6] = {\n\t\t{DRXJ_16TO8(-92), DRXJ_16TO8(-108), DRXJ_16TO8(100)},\t \n\t\t{DRXJ_16TO8(-64), DRXJ_16TO8(-80), DRXJ_16TO8(80)},\t \n\t\t{DRXJ_16TO8(-80), DRXJ_16TO8(-98), DRXJ_16TO8(92)},\t \n\t\t{DRXJ_16TO8(-80), DRXJ_16TO8(-98), DRXJ_16TO8(92)}\t \n\t};\n\tu16 mode_index;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tmirror_freq_spect_oob = ext_attr->mirror_freq_spect_oob;\n\n\t \n\tif (oob_param == NULL) {\n\t\t \n\t\tscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\n\t\t    | SCU_RAM_COMMAND_CMD_DEMOD_STOP;\n\t\tscu_cmd.parameter_len = 0;\n\t\tscu_cmd.result_len = 1;\n\t\tscu_cmd.result = cmd_result;\n\t\trc = scu_command(dev_addr, &scu_cmd);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = set_orx_nsu_aox(demod, false);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, ORX_COMM_EXEC__A, ORX_COMM_EXEC_STOP, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\text_attr->oob_power_on = false;\n\t\treturn 0;\n\t}\n\n\tfreq = oob_param->frequency;\n\tif ((freq < 70000) || (freq > 130000))\n\t\treturn -EIO;\n\tfreq = (freq - 50000) / 50;\n\n\t{\n\t\tu16 index = 0;\n\t\tu16 remainder = 0;\n\t\tu16 *trk_filtercfg = ext_attr->oob_trk_filter_cfg;\n\n\t\tindex = (u16) ((freq - 400) / 200);\n\t\tremainder = (u16) ((freq - 400) % 200);\n\t\ttrk_filter_value =\n\t\t    trk_filtercfg[index] - (trk_filtercfg[index] -\n\t\t\t\t\t   trk_filtercfg[index +\n\t\t\t\t\t\t\t1]) / 10 * remainder /\n\t\t    20;\n\t}\n\n    \n\t \n    \n\trc = drxj_dap_write_reg16(dev_addr, ORX_COMM_EXEC__A, ORX_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\n\t    | SCU_RAM_COMMAND_CMD_DEMOD_STOP;\n\tscu_cmd.parameter_len = 0;\n\tscu_cmd.result_len = 1;\n\tscu_cmd.result = cmd_result;\n\trc = scu_command(dev_addr, &scu_cmd);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n    \n\t \n    \n\tscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\n\t    | SCU_RAM_COMMAND_CMD_DEMOD_RESET;\n\tscu_cmd.parameter_len = 0;\n\tscu_cmd.result_len = 1;\n\tscu_cmd.result = cmd_result;\n\trc = scu_command(dev_addr, &scu_cmd);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n    \n\t \n    \n\t \n\tscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\n\t    | SCU_RAM_COMMAND_CMD_DEMOD_SET_ENV;\n\tscu_cmd.parameter_len = 3;\n\t \n\tswitch (oob_param->standard) {\n\tcase DRX_OOB_MODE_A:\n\t\tif (\n\t\t\t    \n\t\t\t   ((oob_param->spectrum_inverted == true) &&\n\t\t\t     \n\t\t\t    (!mirror_freq_spect_oob)) |\n\t\t\t    \n\t\t\t    \n\t\t\t   ((oob_param->spectrum_inverted == false) &&\n\t\t\t     \n\t\t\t    (mirror_freq_spect_oob))\n\t\t    )\n\t\t\tset_param_parameters[0] =\n\t\t\t    SCU_RAM_ORX_RF_RX_DATA_RATE_2048KBPS_INVSPEC;\n\t\telse\n\t\t\tset_param_parameters[0] =\n\t\t\t    SCU_RAM_ORX_RF_RX_DATA_RATE_2048KBPS_REGSPEC;\n\t\tbreak;\n\tcase DRX_OOB_MODE_B_GRADE_A:\n\t\tif (\n\t\t\t    \n\t\t\t   ((oob_param->spectrum_inverted == true) &&\n\t\t\t     \n\t\t\t    (!mirror_freq_spect_oob)) |\n\t\t\t    \n\t\t\t    \n\t\t\t   ((oob_param->spectrum_inverted == false) &&\n\t\t\t     \n\t\t\t    (mirror_freq_spect_oob))\n\t\t    )\n\t\t\tset_param_parameters[0] =\n\t\t\t    SCU_RAM_ORX_RF_RX_DATA_RATE_1544KBPS_INVSPEC;\n\t\telse\n\t\t\tset_param_parameters[0] =\n\t\t\t    SCU_RAM_ORX_RF_RX_DATA_RATE_1544KBPS_REGSPEC;\n\t\tbreak;\n\tcase DRX_OOB_MODE_B_GRADE_B:\n\tdefault:\n\t\tif (\n\t\t\t    \n\t\t\t   ((oob_param->spectrum_inverted == true) &&\n\t\t\t     \n\t\t\t    (!mirror_freq_spect_oob)) |\n\t\t\t    \n\t\t\t    \n\t\t\t   ((oob_param->spectrum_inverted == false) &&\n\t\t\t     \n\t\t\t    (mirror_freq_spect_oob))\n\t\t    )\n\t\t\tset_param_parameters[0] =\n\t\t\t    SCU_RAM_ORX_RF_RX_DATA_RATE_3088KBPS_INVSPEC;\n\t\telse\n\t\t\tset_param_parameters[0] =\n\t\t\t    SCU_RAM_ORX_RF_RX_DATA_RATE_3088KBPS_REGSPEC;\n\t\tbreak;\n\t}\n\tset_param_parameters[1] = (u16) (freq & 0xFFFF);\n\tset_param_parameters[2] = trk_filter_value;\n\tscu_cmd.parameter = set_param_parameters;\n\tscu_cmd.result_len = 1;\n\tscu_cmd.result = cmd_result;\n\tmode_index = mode_val[(set_param_parameters[0] & 0xC0) >> 6];\n\trc = scu_command(dev_addr, &scu_cmd);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0xFABA, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_OOB_CRX_CFG__A, OOB_CRX_DRIVE_STRENGTH << SIO_PDR_OOB_CRX_CFG_DRIVE__B | 0x03 << SIO_PDR_OOB_CRX_CFG_MODE__B, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SIO_PDR_OOB_DRX_CFG__A, OOB_DRX_DRIVE_STRENGTH << SIO_PDR_OOB_DRX_CFG_DRIVE__B | 0x03 << SIO_PDR_OOB_DRX_CFG_MODE__B, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SIO_TOP_COMM_KEY__A, 0x0000, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\t \n\n\trc = drxj_dap_write_reg16(dev_addr, ORX_TOP_COMM_KEY__A, 0, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, ORX_FWP_AAG_LEN_W__A, 16000, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, ORX_FWP_AAG_THR_W__A, 40, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, ORX_DDC_OFO_SET_W__A, ORX_DDC_OFO_SET_W__PRE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, ORX_NSU_AOX_LOPOW_W__A, ext_attr->oob_lo_pow, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TARGET_MODE__A, SCU_RAM_ORX_TARGET_MODE_2048KBPS_SQRT, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FREQ_GAIN_CORR__A, SCU_RAM_ORX_FREQ_GAIN_CORR_2048KBPS, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_RST_CPH__A, 0x0001, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_RST_CTI__A, 0x0002, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_RST_KRN__A, 0x0004, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_RST_KRP__A, 0x0008, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_LOCK_TH__A, 2048 >> 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_LOCK_TOTH__A, (u16)(-2048), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_ONLOCK_TTH__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_UNLOCK_TTH__A, (u16)(-8), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_AGN_LOCK_MASK__A, 1, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_LOCK_TH__A, 10, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_LOCK_TOTH__A, (u16)(-2048), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_ONLOCK_TTH__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_UNLOCK_TTH__A, (u16)(-8), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_DGN_LOCK_MASK__A, 1 << 1, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_LOCK_TH__A, 17, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_LOCK_TOTH__A, (u16)(-2048), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_ONLOCK_TTH__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_UNLOCK_TTH__A, (u16)(-8), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_FRQ_LOCK_MASK__A, 1 << 2, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_LOCK_TH__A, 3000, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_LOCK_TOTH__A, (u16)(-2048), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_ONLOCK_TTH__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_UNLOCK_TTH__A, (u16)(-8), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_PHA_LOCK_MASK__A, 1 << 3, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_LOCK_TH__A, 400, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_LOCK_TOTH__A, (u16)(-2048), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_ONLOCK_TTH__A, 8, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_UNLOCK_TTH__A, (u16)(-8), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_TIM_LOCK_MASK__A, 1 << 4, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_LOCK_TH__A, 20, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_LOCK_TOTH__A, (u16)(-2048), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_ONLOCK_TTH__A, 4, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_UNLOCK_TTH__A, (u16)(-4), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_ORX_EQU_LOCK_MASK__A, 1 << 5, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxdap_fasi_write_block(dev_addr, ORX_FWP_PFI_A_W__A, sizeof(pfi_coeffs[mode_index]), ((u8 *)pfi_coeffs[mode_index]), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, ORX_TOP_MDE_W__A, mode_index, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tfor (i = 0; i < (NYQFILTERLEN + 1) / 2; i++) {\n\t\trc = drxj_dap_write_reg16(dev_addr, ORX_FWP_NYQ_ADR_W__A, i, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, ORX_FWP_NYQ_COF_RW__A, nyquist_coeffs[mode_index][i], 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, ORX_FWP_NYQ_ADR_W__A, 31, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, ORX_COMM_EXEC__A, ORX_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\t \n\t \n\tscu_cmd.command = SCU_RAM_COMMAND_STANDARD_OOB\n\t    | SCU_RAM_COMMAND_CMD_DEMOD_START;\n\tscu_cmd.parameter_len = 0;\n\tscu_cmd.result_len = 1;\n\tscu_cmd.result = cmd_result;\n\trc = scu_command(dev_addr, &scu_cmd);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = set_orx_nsu_aox(demod, true);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, ORX_NSU_AOX_STHR_W__A, ext_attr->oob_pre_saw, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\text_attr->oob_power_on = true;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n \n \n\n \n\n \n \nstatic int\nctrl_set_channel(struct drx_demod_instance *demod, struct drx_channel *channel)\n{\n\tint rc;\n\ts32 tuner_freq_offset = 0;\n\tstruct drxj_data *ext_attr = NULL;\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tenum drx_standard standard = DRX_STANDARD_UNKNOWN;\n#ifndef DRXJ_VSB_ONLY\n\tu32 min_symbol_rate = 0;\n\tu32 max_symbol_rate = 0;\n\tint bandwidth_temp = 0;\n\tint bandwidth = 0;\n#endif\n    \n\tif ((demod == NULL) || (channel == NULL))\n\t\treturn -EINVAL;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tstandard = ext_attr->standard;\n\n\t \n\tswitch (standard) {\n\tcase DRX_STANDARD_8VSB:\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n#endif  \n\t\tbreak;\n\tcase DRX_STANDARD_UNKNOWN:\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif ((standard == DRX_STANDARD_ITU_B) ||\n\t    (standard == DRX_STANDARD_8VSB) ||\n\t    (standard == DRX_STANDARD_NTSC)) {\n\t\tswitch (channel->bandwidth) {\n\t\tcase DRX_BANDWIDTH_6MHZ:\n\t\tcase DRX_BANDWIDTH_UNKNOWN:\n\t\t\tchannel->bandwidth = DRX_BANDWIDTH_6MHZ;\n\t\t\tbreak;\n\t\tcase DRX_BANDWIDTH_8MHZ:\n\t\tcase DRX_BANDWIDTH_7MHZ:\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\t \n#ifndef DRXJ_VSB_ONLY\n\tif ((standard == DRX_STANDARD_ITU_A) ||\n\t    (standard == DRX_STANDARD_ITU_C)) {\n\t\tstruct drxuio_cfg uio_cfg = { DRX_UIO1, DRX_UIO_MODE_FIRMWARE_SAW };\n\t\tint bw_rolloff_factor = 0;\n\n\t\tbw_rolloff_factor = (standard == DRX_STANDARD_ITU_A) ? 115 : 113;\n\t\tmin_symbol_rate = DRXJ_QAM_SYMBOLRATE_MIN;\n\t\tmax_symbol_rate = DRXJ_QAM_SYMBOLRATE_MAX;\n\t\t \n\t\trc = ctrl_set_uio_cfg(demod, &uio_cfg);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\tif (channel->symbolrate < min_symbol_rate ||\n\t\t    channel->symbolrate > max_symbol_rate) {\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tswitch (channel->constellation) {\n\t\tcase DRX_CONSTELLATION_QAM16:\n\t\tcase DRX_CONSTELLATION_QAM32:\n\t\tcase DRX_CONSTELLATION_QAM64:\n\t\tcase DRX_CONSTELLATION_QAM128:\n\t\tcase DRX_CONSTELLATION_QAM256:\n\t\t\tbandwidth_temp = channel->symbolrate * bw_rolloff_factor;\n\t\t\tbandwidth = bandwidth_temp / 100;\n\n\t\t\tif ((bandwidth_temp % 100) >= 50)\n\t\t\t\tbandwidth++;\n\n\t\t\tif (bandwidth <= 6100000) {\n\t\t\t\tchannel->bandwidth = DRX_BANDWIDTH_6MHZ;\n\t\t\t} else if ((bandwidth > 6100000)\n\t\t\t\t   && (bandwidth <= 7100000)) {\n\t\t\t\tchannel->bandwidth = DRX_BANDWIDTH_7MHZ;\n\t\t\t} else if (bandwidth > 7100000) {\n\t\t\t\tchannel->bandwidth = DRX_BANDWIDTH_8MHZ;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\t \n\tif (standard == DRX_STANDARD_ITU_B) {\n\t\tswitch (channel->constellation) {\n\t\tcase DRX_CONSTELLATION_AUTO:\n\t\tcase DRX_CONSTELLATION_QAM256:\n\t\tcase DRX_CONSTELLATION_QAM64:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tswitch (channel->interleavemode) {\n\t\tcase DRX_INTERLEAVEMODE_I128_J1:\n\t\tcase DRX_INTERLEAVEMODE_I128_J1_V2:\n\t\tcase DRX_INTERLEAVEMODE_I128_J2:\n\t\tcase DRX_INTERLEAVEMODE_I64_J2:\n\t\tcase DRX_INTERLEAVEMODE_I128_J3:\n\t\tcase DRX_INTERLEAVEMODE_I32_J4:\n\t\tcase DRX_INTERLEAVEMODE_I128_J4:\n\t\tcase DRX_INTERLEAVEMODE_I16_J8:\n\t\tcase DRX_INTERLEAVEMODE_I128_J5:\n\t\tcase DRX_INTERLEAVEMODE_I8_J16:\n\t\tcase DRX_INTERLEAVEMODE_I128_J6:\n\t\tcase DRX_INTERLEAVEMODE_I128_J7:\n\t\tcase DRX_INTERLEAVEMODE_I128_J8:\n\t\tcase DRX_INTERLEAVEMODE_I12_J17:\n\t\tcase DRX_INTERLEAVEMODE_I5_J4:\n\t\tcase DRX_INTERLEAVEMODE_B52_M240:\n\t\tcase DRX_INTERLEAVEMODE_B52_M720:\n\t\tcase DRX_INTERLEAVEMODE_UNKNOWN:\n\t\tcase DRX_INTERLEAVEMODE_AUTO:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tif ((ext_attr->uio_sma_tx_mode) == DRX_UIO_MODE_FIRMWARE_SAW) {\n\t\t \n\t\tstruct drxuio_data uio1 = { DRX_UIO1, false };\n\n\t\tswitch (channel->bandwidth) {\n\t\tcase DRX_BANDWIDTH_8MHZ:\n\t\t\tuio1.value = true;\n\t\t\tbreak;\n\t\tcase DRX_BANDWIDTH_7MHZ:\n\t\t\tuio1.value = false;\n\t\t\tbreak;\n\t\tcase DRX_BANDWIDTH_6MHZ:\n\t\t\tuio1.value = false;\n\t\t\tbreak;\n\t\tcase DRX_BANDWIDTH_UNKNOWN:\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\trc = ctrl_uio_write(demod, &uio1);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n#endif  \n\trc = drxj_dap_write_reg16(dev_addr, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\ttuner_freq_offset = 0;\n\n    \n\tswitch (standard) {\n\tcase DRX_STANDARD_8VSB:\n\t\tif (channel->mirror == DRX_MIRROR_AUTO)\n\t\t\text_attr->mirror = DRX_MIRROR_NO;\n\t\telse\n\t\t\text_attr->mirror = channel->mirror;\n\t\trc = set_vsb(demod);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = set_frequency(demod, channel, tuner_freq_offset);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n\t\trc = set_qam_channel(demod, channel, tuner_freq_offset);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n#endif\n\tcase DRX_STANDARD_UNKNOWN:\n\tdefault:\n\t\treturn -EIO;\n\t}\n\n\t \n\text_attr->reset_pkt_err_acc = true;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int\nctrl_sig_quality(struct drx_demod_instance *demod,\n\t\t enum drx_lock_status lock_status)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tstruct drxj_data *ext_attr = demod->my_ext_attr;\n\tstruct drx39xxj_state *state = dev_addr->user_data;\n\tstruct dtv_frontend_properties *p = &state->frontend.dtv_property_cache;\n\tenum drx_standard standard = ext_attr->standard;\n\tint rc;\n\tu32 ber, cnt, err, pkt;\n\tu16 mer, strength = 0;\n\n\trc = get_sig_strength(demod, &strength);\n\tif (rc < 0) {\n\t\tpr_err(\"error getting signal strength %d\\n\", rc);\n\t\tp->strength.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t} else {\n\t\tp->strength.stat[0].scale = FE_SCALE_RELATIVE;\n\t\tp->strength.stat[0].uvalue = 65535UL *  strength/ 100;\n\t}\n\n\tswitch (standard) {\n\tcase DRX_STANDARD_8VSB:\n#ifdef DRXJ_SIGNAL_ACCUM_ERR\n\t\trc = get_acc_pkt_err(demod, &pkt);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n#endif\n\t\tif (lock_status != DRXJ_DEMOD_LOCK && lock_status != DRX_LOCKED) {\n\t\t\tp->pre_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\tp->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\tp->post_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\tp->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\tp->block_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\tp->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\tp->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t} else {\n\t\t\trc = get_vsb_post_rs_pck_err(dev_addr, &err, &pkt);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d getting UCB\\n\", rc);\n\t\t\t\tp->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\t} else {\n\t\t\t\tp->block_error.stat[0].scale = FE_SCALE_COUNTER;\n\t\t\t\tp->block_error.stat[0].uvalue += err;\n\t\t\t\tp->block_count.stat[0].scale = FE_SCALE_COUNTER;\n\t\t\t\tp->block_count.stat[0].uvalue += pkt;\n\t\t\t}\n\n\t\t\t \n\t\t\trc = get_vs_bpre_viterbi_ber(dev_addr, &ber, &cnt);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d getting pre-ber\\n\", rc);\n\t\t\t\tp->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\t} else {\n\t\t\t\tp->pre_bit_error.stat[0].scale = FE_SCALE_COUNTER;\n\t\t\t\tp->pre_bit_error.stat[0].uvalue += ber;\n\t\t\t\tp->pre_bit_count.stat[0].scale = FE_SCALE_COUNTER;\n\t\t\t\tp->pre_bit_count.stat[0].uvalue += cnt;\n\t\t\t}\n\n\t\t\trc = get_vs_bpost_viterbi_ber(dev_addr, &ber, &cnt);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d getting post-ber\\n\", rc);\n\t\t\t\tp->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\t} else {\n\t\t\t\tp->post_bit_error.stat[0].scale = FE_SCALE_COUNTER;\n\t\t\t\tp->post_bit_error.stat[0].uvalue += ber;\n\t\t\t\tp->post_bit_count.stat[0].scale = FE_SCALE_COUNTER;\n\t\t\t\tp->post_bit_count.stat[0].uvalue += cnt;\n\t\t\t}\n\t\t\trc = get_vsbmer(dev_addr, &mer);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d getting MER\\n\", rc);\n\t\t\t\tp->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\t\t\t} else {\n\t\t\t\tp->cnr.stat[0].svalue = mer * 100;\n\t\t\t\tp->cnr.stat[0].scale = FE_SCALE_DECIBEL;\n\t\t\t}\n\t\t}\n\t\tbreak;\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n\t\trc = ctrl_get_qam_sig_quality(demod);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n#endif\n\tdefault:\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int\nctrl_lock_status(struct drx_demod_instance *demod, enum drx_lock_status *lock_stat)\n{\n\tenum drx_standard standard = DRX_STANDARD_UNKNOWN;\n\tstruct drxj_data *ext_attr = NULL;\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxjscu_cmd cmd_scu = {   0,\n\t\t  0,\n\t\t  0,\n\t\t  NULL,\n\t\t  NULL\n\t};\n\tint rc;\n\tu16 cmd_result[2] = { 0, 0 };\n\tu16 demod_lock = SCU_RAM_PARAM_1_RES_DEMOD_GET_LOCK_DEMOD_LOCKED;\n\n\t \n\tif ((demod == NULL) || (lock_stat == NULL))\n\t\treturn -EINVAL;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tstandard = ext_attr->standard;\n\n\t*lock_stat = DRX_NOT_LOCKED;\n\n\t \n\tswitch (standard) {\n\tcase DRX_STANDARD_8VSB:\n\t\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_VSB |\n\t\t    SCU_RAM_COMMAND_CMD_DEMOD_GET_LOCK;\n\t\tdemod_lock |= 0x6;\n\t\tbreak;\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n\t\tcmd_scu.command = SCU_RAM_COMMAND_STANDARD_QAM |\n\t\t    SCU_RAM_COMMAND_CMD_DEMOD_GET_LOCK;\n\t\tbreak;\n#endif\n\tcase DRX_STANDARD_UNKNOWN:\n\tdefault:\n\t\treturn -EIO;\n\t}\n\n\t \n\tcmd_scu.parameter_len = 0;\n\tcmd_scu.result_len = 2;\n\tcmd_scu.parameter = NULL;\n\tcmd_scu.result = cmd_result;\n\trc = scu_command(dev_addr, &cmd_scu);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tif (cmd_scu.result[1] < demod_lock) {\n\t\t \n\t\t*lock_stat = DRX_NOT_LOCKED;\n\t} else if (cmd_scu.result[1] < SCU_RAM_PARAM_1_RES_DEMOD_GET_LOCK_LOCKED) {\n\t\t*lock_stat = DRXJ_DEMOD_LOCK;\n\t} else if (cmd_scu.result[1] <\n\t\t   SCU_RAM_PARAM_1_RES_DEMOD_GET_LOCK_NEVER_LOCK) {\n\t\t \n\t\t*lock_stat = DRX_LOCKED;\n\t} else {\n\t\t \n\t\t \n\t\t*lock_stat = DRX_NEVER_LOCK;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int\nctrl_set_standard(struct drx_demod_instance *demod, enum drx_standard *standard)\n{\n\tstruct drxj_data *ext_attr = NULL;\n\tint rc;\n\tenum drx_standard prev_standard;\n\n\t \n\tif ((standard == NULL) || (demod == NULL))\n\t\treturn -EINVAL;\n\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tprev_standard = ext_attr->standard;\n\n\t \n\tswitch (prev_standard) {\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n\t\trc = power_down_qam(demod, false);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n#endif\n\tcase DRX_STANDARD_8VSB:\n\t\trc = power_down_vsb(demod, false);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n\tcase DRX_STANDARD_UNKNOWN:\n\t\t \n\t\tbreak;\n\tcase DRX_STANDARD_AUTO:\n\tdefault:\n\t\trc = -EINVAL;\n\t\tgoto rw_error;\n\t}\n\n\t \n\text_attr->standard = *standard;\n\n\tswitch (*standard) {\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n\t\tdo {\n\t\t\tu16 dummy;\n\t\t\trc = drxj_dap_read_reg16(demod->my_i2c_dev_addr, SCU_RAM_VERSION_HI__A, &dummy, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t} while (0);\n\t\tbreak;\n#endif\n\tcase DRX_STANDARD_8VSB:\n\t\trc = set_vsb_leak_n_gain(demod);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\text_attr->standard = DRX_STANDARD_UNKNOWN;\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\nrw_error:\n\t \n\text_attr->standard = DRX_STANDARD_UNKNOWN;\n\treturn rc;\n}\n\n \n\nstatic void drxj_reset_mode(struct drxj_data *ext_attr)\n{\n\t \n\tif (ext_attr->has_lna) {\n\t\t \n#ifndef DRXJ_VSB_ONLY\n\t\text_attr->qam_if_agc_cfg.standard = DRX_STANDARD_ITU_B;\n\t\text_attr->qam_if_agc_cfg.ctrl_mode = DRX_AGC_CTRL_OFF;\n\t\text_attr->qam_pga_cfg = 140 + (11 * 13);\n#endif\n\t\text_attr->vsb_if_agc_cfg.standard = DRX_STANDARD_8VSB;\n\t\text_attr->vsb_if_agc_cfg.ctrl_mode = DRX_AGC_CTRL_OFF;\n\t\text_attr->vsb_pga_cfg = 140 + (11 * 13);\n\t} else {\n\t\t \n#ifndef DRXJ_VSB_ONLY\n\t\text_attr->qam_if_agc_cfg.standard = DRX_STANDARD_ITU_B;\n\t\text_attr->qam_if_agc_cfg.ctrl_mode = DRX_AGC_CTRL_AUTO;\n\t\text_attr->qam_if_agc_cfg.min_output_level = 0;\n\t\text_attr->qam_if_agc_cfg.max_output_level = 0x7FFF;\n\t\text_attr->qam_if_agc_cfg.speed = 3;\n\t\text_attr->qam_if_agc_cfg.top = 1297;\n\t\text_attr->qam_pga_cfg = 140;\n#endif\n\t\text_attr->vsb_if_agc_cfg.standard = DRX_STANDARD_8VSB;\n\t\text_attr->vsb_if_agc_cfg.ctrl_mode = DRX_AGC_CTRL_AUTO;\n\t\text_attr->vsb_if_agc_cfg.min_output_level = 0;\n\t\text_attr->vsb_if_agc_cfg.max_output_level = 0x7FFF;\n\t\text_attr->vsb_if_agc_cfg.speed = 3;\n\t\text_attr->vsb_if_agc_cfg.top = 1024;\n\t\text_attr->vsb_pga_cfg = 140;\n\t}\n\t \n\t \n#ifndef DRXJ_VSB_ONLY\n\text_attr->qam_rf_agc_cfg.standard = DRX_STANDARD_ITU_B;\n\text_attr->qam_rf_agc_cfg.ctrl_mode = DRX_AGC_CTRL_AUTO;\n\text_attr->qam_rf_agc_cfg.min_output_level = 0;\n\text_attr->qam_rf_agc_cfg.max_output_level = 0x7FFF;\n\text_attr->qam_rf_agc_cfg.speed = 3;\n\text_attr->qam_rf_agc_cfg.top = 9500;\n\text_attr->qam_rf_agc_cfg.cut_off_current = 4000;\n\text_attr->qam_pre_saw_cfg.standard = DRX_STANDARD_ITU_B;\n\text_attr->qam_pre_saw_cfg.reference = 0x07;\n\text_attr->qam_pre_saw_cfg.use_pre_saw = true;\n#endif\n\t \n\text_attr->vsb_rf_agc_cfg.standard = DRX_STANDARD_8VSB;\n\text_attr->vsb_rf_agc_cfg.ctrl_mode = DRX_AGC_CTRL_AUTO;\n\text_attr->vsb_rf_agc_cfg.min_output_level = 0;\n\text_attr->vsb_rf_agc_cfg.max_output_level = 0x7FFF;\n\text_attr->vsb_rf_agc_cfg.speed = 3;\n\text_attr->vsb_rf_agc_cfg.top = 9500;\n\text_attr->vsb_rf_agc_cfg.cut_off_current = 4000;\n\text_attr->vsb_pre_saw_cfg.standard = DRX_STANDARD_8VSB;\n\text_attr->vsb_pre_saw_cfg.reference = 0x07;\n\text_attr->vsb_pre_saw_cfg.use_pre_saw = true;\n}\n\n \nstatic int\nctrl_power_mode(struct drx_demod_instance *demod, enum drx_power_mode *mode)\n{\n\tstruct drx_common_attr *common_attr = (struct drx_common_attr *) NULL;\n\tstruct drxj_data *ext_attr = (struct drxj_data *) NULL;\n\tstruct i2c_device_addr *dev_addr = (struct i2c_device_addr *)NULL;\n\tint rc;\n\tu16 sio_cc_pwd_mode = 0;\n\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tdev_addr = demod->my_i2c_dev_addr;\n\n\t \n\tif (mode == NULL)\n\t\treturn -EINVAL;\n\n\t \n\tif (common_attr->current_power_mode == *mode)\n\t\treturn 0;\n\n\tswitch (*mode) {\n\tcase DRX_POWER_UP:\n\tcase DRXJ_POWER_DOWN_MAIN_PATH:\n\t\tsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_NONE;\n\t\tbreak;\n\tcase DRXJ_POWER_DOWN_CORE:\n\t\tsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_CLOCK;\n\t\tbreak;\n\tcase DRXJ_POWER_DOWN_PLL:\n\t\tsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_PLL;\n\t\tbreak;\n\tcase DRX_POWER_DOWN:\n\t\tsio_cc_pwd_mode = SIO_CC_PWD_MODE_LEVEL_OSC;\n\t\tbreak;\n\tdefault:\n\t\t \n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif ((common_attr->current_power_mode != DRX_POWER_UP)) {\n\t\trc = power_up_device(demod);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\tif (*mode == DRX_POWER_UP) {\n\t\t \n\n\t\t \n\t\tdrxj_reset_mode(ext_attr);\n\t} else {\n\t\t \n\t\t \n\t\t \n\t\t \n\t\t \n\t\t \n\t\t \n\t\t \n\n\t\tswitch (ext_attr->standard) {\n\t\tcase DRX_STANDARD_ITU_A:\n\t\tcase DRX_STANDARD_ITU_B:\n\t\tcase DRX_STANDARD_ITU_C:\n\t\t\trc = power_down_qam(demod, true);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_STANDARD_8VSB:\n\t\t\trc = power_down_vsb(demod, true);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_STANDARD_PAL_SECAM_BG:\n\t\tcase DRX_STANDARD_PAL_SECAM_DK:\n\t\tcase DRX_STANDARD_PAL_SECAM_I:\n\t\tcase DRX_STANDARD_PAL_SECAM_L:\n\t\tcase DRX_STANDARD_PAL_SECAM_LP:\n\t\tcase DRX_STANDARD_NTSC:\n\t\tcase DRX_STANDARD_FM:\n\t\t\trc = power_down_atv(demod, ext_attr->standard, true);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DRX_STANDARD_UNKNOWN:\n\t\t\t \n\t\t\tbreak;\n\t\tcase DRX_STANDARD_AUTO:\n\t\tdefault:\n\t\t\treturn -EIO;\n\t\t}\n\t\text_attr->standard = DRX_STANDARD_UNKNOWN;\n\t}\n\n\tif (*mode != DRXJ_POWER_DOWN_MAIN_PATH) {\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_CC_PWD_MODE__A, sio_cc_pwd_mode, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\trc = drxj_dap_write_reg16(dev_addr, SIO_CC_UPDATE__A, SIO_CC_UPDATE_KEY, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\tif ((*mode != DRX_POWER_UP)) {\n\t\t\t \n\t\t\trc = init_hi(demod);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\n\t\t\text_attr->hi_cfg_ctrl |= SIO_HI_RA_RAM_PAR_5_CFG_SLEEP_ZZZ;\n\t\t\trc = hi_cfg_command(demod);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t}\n\t}\n\n\tcommon_attr->current_power_mode = *mode;\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n \n \n\n \nstatic int\nctrl_set_cfg_pre_saw(struct drx_demod_instance *demod, struct drxj_cfg_pre_saw *pre_saw)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxj_data *ext_attr = NULL;\n\tint rc;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\t \n\tif ((pre_saw == NULL) || (pre_saw->reference > IQM_AF_PDREF__M)\n\t    ) {\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif ((ext_attr->standard == pre_saw->standard) ||\n\t    (DRXJ_ISQAMSTD(ext_attr->standard) &&\n\t     DRXJ_ISQAMSTD(pre_saw->standard)) ||\n\t    (DRXJ_ISATVSTD(ext_attr->standard) &&\n\t     DRXJ_ISATVSTD(pre_saw->standard))) {\n\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_PDREF__A, pre_saw->reference, 0);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t}\n\n\t \n\tswitch (pre_saw->standard) {\n\tcase DRX_STANDARD_8VSB:\n\t\text_attr->vsb_pre_saw_cfg = *pre_saw;\n\t\tbreak;\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n\t\text_attr->qam_pre_saw_cfg = *pre_saw;\n\t\tbreak;\n#endif\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n \nstatic int\nctrl_set_cfg_afe_gain(struct drx_demod_instance *demod, struct drxj_cfg_afe_gain *afe_gain)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxj_data *ext_attr = NULL;\n\tint rc;\n\tu8 gain = 0;\n\n\t \n\tif (afe_gain == NULL)\n\t\treturn -EINVAL;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\n\tswitch (afe_gain->standard) {\n\tcase DRX_STANDARD_8VSB:\tfallthrough;\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n#endif\n\t\t \n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\n\tif (afe_gain->gain >= 329)\n\t\tgain = 15;\n\telse if (afe_gain->gain <= 147)\n\t\tgain = 0;\n\telse\n\t\tgain = (afe_gain->gain - 140 + 6) / 13;\n\n\t \n\tif (ext_attr->standard == afe_gain->standard) {\n\t\t\trc = drxj_dap_write_reg16(dev_addr, IQM_AF_PGA_GAIN__A, gain, 0);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d\\n\", rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t}\n\n\t \n\tswitch (afe_gain->standard) {\n\tcase DRX_STANDARD_8VSB:\n\t\text_attr->vsb_pga_cfg = gain * 13 + 140;\n\t\tbreak;\n#ifndef DRXJ_VSB_ONLY\n\tcase DRX_STANDARD_ITU_A:\n\tcase DRX_STANDARD_ITU_B:\n\tcase DRX_STANDARD_ITU_C:\n\t\text_attr->qam_pga_cfg = gain * 13 + 140;\n\t\tbreak;\n#endif\n\tdefault:\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\nrw_error:\n\treturn rc;\n}\n\n \n\n\n \n\nstatic int drx_ctrl_u_code(struct drx_demod_instance *demod,\n\t\t       struct drxu_code_info *mc_info,\n\t\t       enum drxu_code_action action);\nstatic int drxj_set_lna_state(struct drx_demod_instance *demod, bool state);\n\n \n\nstatic int drxj_open(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = NULL;\n\tstruct drxj_data *ext_attr = NULL;\n\tstruct drx_common_attr *common_attr = NULL;\n\tu32 driver_version = 0;\n\tstruct drxu_code_info ucode_info;\n\tstruct drx_cfg_mpeg_output cfg_mpeg_output;\n\tint rc;\n\tenum drx_power_mode power_mode = DRX_POWER_UP;\n\n\tif ((demod == NULL) ||\n\t    (demod->my_common_attr == NULL) ||\n\t    (demod->my_ext_attr == NULL) ||\n\t    (demod->my_i2c_dev_addr == NULL) ||\n\t    (demod->my_common_attr->is_opened)) {\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (demod->my_ext_attr == NULL)\n\t\treturn -EINVAL;\n\n\tdev_addr = demod->my_i2c_dev_addr;\n\text_attr = (struct drxj_data *) demod->my_ext_attr;\n\tcommon_attr = (struct drx_common_attr *) demod->my_common_attr;\n\n\trc = ctrl_power_mode(demod, &power_mode);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tif (power_mode != DRX_POWER_UP) {\n\t\trc = -EINVAL;\n\t\tpr_err(\"failed to powerup device\\n\");\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = get_device_capabilities(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SIO_CC_SOFT_RST__A, (0x04 | SIO_CC_SOFT_RST_SYS__M | SIO_CC_SOFT_RST_OSC__M), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SIO_CC_UPDATE__A, SIO_CC_UPDATE_KEY, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tmsleep(1);\n\n\t \n\t \n\trc = drxj_dap_write_reg16(dev_addr, ATV_TOP_STDBY__A, (~ATV_TOP_STDBY_CVBS_STDBY_A2_ACTIVE) | ATV_TOP_STDBY_SIF_STDBY_STANDBY, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = set_iqm_af(demod, false);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = set_orx_nsu_aox(demod, false);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = init_hi(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tmemcpy(&cfg_mpeg_output, &common_attr->mpeg_cfg, sizeof(cfg_mpeg_output));\n\tcfg_mpeg_output.enable_mpeg_output = false;\n\n\trc = ctrl_set_cfg_mpeg_output(demod, &cfg_mpeg_output);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = power_down_aud(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_COMM_EXEC__A, SCU_COMM_EXEC_STOP, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tif (common_attr->microcode_file != NULL) {\n\t\t \n\t\tcommon_attr->is_opened = true;\n\t\tucode_info.mc_file = common_attr->microcode_file;\n\n\t\tif (DRX_ISPOWERDOWNMODE(demod->my_common_attr->current_power_mode)) {\n\t\t\tpr_err(\"Should powerup before loading the firmware.\");\n\t\t\trc = -EINVAL;\n\t\t\tgoto rw_error;\n\t\t}\n\n\t\trc = drx_ctrl_u_code(demod, &ucode_info, UCODE_UPLOAD);\n\t\tif (rc != 0) {\n\t\t\tpr_err(\"error %d while uploading the firmware\\n\", rc);\n\t\t\tgoto rw_error;\n\t\t}\n\t\tif (common_attr->verify_microcode == true) {\n\t\t\trc = drx_ctrl_u_code(demod, &ucode_info, UCODE_VERIFY);\n\t\t\tif (rc != 0) {\n\t\t\t\tpr_err(\"error %d while verifying the firmware\\n\",\n\t\t\t\t       rc);\n\t\t\t\tgoto rw_error;\n\t\t\t}\n\t\t}\n\t\tcommon_attr->is_opened = false;\n\t}\n\n\t \n\trc = drxj_dap_write_reg16(dev_addr, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tcommon_attr->scan_demod_lock_timeout = DRXJ_SCAN_TIMEOUT;\n\tcommon_attr->scan_desired_lock = DRX_LOCKED;\n\n\tdrxj_reset_mode(ext_attr);\n\text_attr->standard = DRX_STANDARD_UNKNOWN;\n\n\trc = smart_ant_init(demod);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\tdriver_version = (VERSION_MAJOR / 100) % 10;\n\tdriver_version <<= 4;\n\tdriver_version += (VERSION_MAJOR / 10) % 10;\n\tdriver_version <<= 4;\n\tdriver_version += (VERSION_MAJOR % 10);\n\tdriver_version <<= 4;\n\tdriver_version += (VERSION_MINOR % 10);\n\tdriver_version <<= 4;\n\tdriver_version += (VERSION_PATCH / 1000) % 10;\n\tdriver_version <<= 4;\n\tdriver_version += (VERSION_PATCH / 100) % 10;\n\tdriver_version <<= 4;\n\tdriver_version += (VERSION_PATCH / 10) % 10;\n\tdriver_version <<= 4;\n\tdriver_version += (VERSION_PATCH % 10);\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_DRIVER_VER_HI__A, (u16)(driver_version >> 16), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\trc = drxj_dap_write_reg16(dev_addr, SCU_RAM_DRIVER_VER_LO__A, (u16)(driver_version & 0xFFFF), 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = ctrl_set_oob(demod, NULL);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\t \n\text_attr->aud_data = drxj_default_aud_data_g;\n\n\tdemod->my_common_attr->is_opened = true;\n\tdrxj_set_lna_state(demod, false);\n\treturn 0;\nrw_error:\n\tcommon_attr->is_opened = false;\n\treturn rc;\n}\n\n \n \nstatic int drxj_close(struct drx_demod_instance *demod)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tint rc;\n\tenum drx_power_mode power_mode = DRX_POWER_UP;\n\n\tif ((demod->my_common_attr == NULL) ||\n\t    (demod->my_ext_attr == NULL) ||\n\t    (demod->my_i2c_dev_addr == NULL) ||\n\t    (!demod->my_common_attr->is_opened)) {\n\t\treturn -EINVAL;\n\t}\n\n\t \n\trc = ctrl_power_mode(demod, &power_mode);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\trc = drxj_dap_write_reg16(dev_addr, SCU_COMM_EXEC__A, SCU_COMM_EXEC_ACTIVE, 0);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\tpower_mode = DRX_POWER_DOWN;\n\trc = ctrl_power_mode(demod, &power_mode);\n\tif (rc != 0) {\n\t\tpr_err(\"error %d\\n\", rc);\n\t\tgoto rw_error;\n\t}\n\n\tDRX_ATTR_ISOPENED(demod) = false;\n\n\treturn 0;\nrw_error:\n\tDRX_ATTR_ISOPENED(demod) = false;\n\n\treturn rc;\n}\n\n \n\n \nstatic u16 drx_u_code_compute_crc(u8 *block_data, u16 nr_words)\n{\n\tu16 i = 0;\n\tu16 j = 0;\n\tu32 crc_word = 0;\n\tu32 carry = 0;\n\n\twhile (i < nr_words) {\n\t\tcrc_word |= (u32)be16_to_cpu(*(__be16 *)(block_data));\n\t\tfor (j = 0; j < 16; j++) {\n\t\t\tcrc_word <<= 1;\n\t\t\tif (carry != 0)\n\t\t\t\tcrc_word ^= 0x80050000UL;\n\t\t\tcarry = crc_word & 0x80000000UL;\n\t\t}\n\t\ti++;\n\t\tblock_data += (sizeof(u16));\n\t}\n\treturn (u16)(crc_word >> 16);\n}\n\n \nstatic int drx_check_firmware(struct drx_demod_instance *demod, u8 *mc_data,\n\t\t\t  unsigned size)\n{\n\tstruct drxu_code_block_hdr block_hdr;\n\tint i;\n\tunsigned count = 2 * sizeof(u16);\n\tu32 mc_dev_type, mc_version, mc_base_version;\n\tu16 mc_nr_of_blks = be16_to_cpu(*(__be16 *)(mc_data + sizeof(u16)));\n\n\t \n\n\t \n\tDRX_ATTR_MCRECORD(demod).aux_type = 0;\n\tDRX_ATTR_MCRECORD(demod).mc_dev_type = 0;\n\tDRX_ATTR_MCRECORD(demod).mc_version = 0;\n\tDRX_ATTR_MCRECORD(demod).mc_base_version = 0;\n\n\tfor (i = 0; i < mc_nr_of_blks; i++) {\n\t\tif (count + 3 * sizeof(u16) + sizeof(u32) > size)\n\t\t\tgoto eof;\n\n\t\t \n\t\tblock_hdr.addr = be32_to_cpu(*(__be32 *)(mc_data + count));\n\t\tcount += sizeof(u32);\n\t\tblock_hdr.size = be16_to_cpu(*(__be16 *)(mc_data + count));\n\t\tcount += sizeof(u16);\n\t\tblock_hdr.flags = be16_to_cpu(*(__be16 *)(mc_data + count));\n\t\tcount += sizeof(u16);\n\t\tblock_hdr.CRC = be16_to_cpu(*(__be16 *)(mc_data + count));\n\t\tcount += sizeof(u16);\n\n\t\tpr_debug(\"%u: addr %u, size %u, flags 0x%04x, CRC 0x%04x\\n\",\n\t\t\tcount, block_hdr.addr, block_hdr.size, block_hdr.flags,\n\t\t\tblock_hdr.CRC);\n\n\t\tif (block_hdr.flags & 0x8) {\n\t\t\tu8 *auxblk = ((void *)mc_data) + block_hdr.addr;\n\t\t\tu16 auxtype;\n\n\t\t\tif (block_hdr.addr + sizeof(u16) > size)\n\t\t\t\tgoto eof;\n\n\t\t\tauxtype = be16_to_cpu(*(__be16 *)(auxblk));\n\n\t\t\t \n\t\t\tif (DRX_ISMCVERTYPE(auxtype)) {\n\t\t\t\tif (block_hdr.addr + 2 * sizeof(u16) + 2 * sizeof (u32) > size)\n\t\t\t\t\tgoto eof;\n\n\t\t\t\tauxblk += sizeof(u16);\n\t\t\t\tmc_dev_type = be32_to_cpu(*(__be32 *)(auxblk));\n\t\t\t\tauxblk += sizeof(u32);\n\t\t\t\tmc_version = be32_to_cpu(*(__be32 *)(auxblk));\n\t\t\t\tauxblk += sizeof(u32);\n\t\t\t\tmc_base_version = be32_to_cpu(*(__be32 *)(auxblk));\n\n\t\t\t\tDRX_ATTR_MCRECORD(demod).aux_type = auxtype;\n\t\t\t\tDRX_ATTR_MCRECORD(demod).mc_dev_type = mc_dev_type;\n\t\t\t\tDRX_ATTR_MCRECORD(demod).mc_version = mc_version;\n\t\t\t\tDRX_ATTR_MCRECORD(demod).mc_base_version = mc_base_version;\n\n\t\t\t\tpr_info(\"Firmware dev %x, ver %x, base ver %x\\n\",\n\t\t\t\t\tmc_dev_type, mc_version, mc_base_version);\n\n\t\t\t}\n\t\t} else if (count + block_hdr.size * sizeof(u16) > size)\n\t\t\tgoto eof;\n\n\t\tcount += block_hdr.size * sizeof(u16);\n\t}\n\treturn 0;\neof:\n\tpr_err(\"Firmware is truncated at pos %u/%u\\n\", count, size);\n\treturn -EINVAL;\n}\n\n \nstatic int drx_ctrl_u_code(struct drx_demod_instance *demod,\n\t\t       struct drxu_code_info *mc_info,\n\t\t       enum drxu_code_action action)\n{\n\tstruct i2c_device_addr *dev_addr = demod->my_i2c_dev_addr;\n\tint rc;\n\tu16 i = 0;\n\tu16 mc_nr_of_blks = 0;\n\tu16 mc_magic_word = 0;\n\tconst u8 *mc_data_init = NULL;\n\tu8 *mc_data = NULL;\n\tunsigned size;\n\tchar *mc_file;\n\n\t \n\tif (!mc_info || !mc_info->mc_file)\n\t\treturn -EINVAL;\n\n\tmc_file = mc_info->mc_file;\n\n\tif (!demod->firmware) {\n\t\tconst struct firmware *fw = NULL;\n\n\t\trc = request_firmware(&fw, mc_file, demod->i2c->dev.parent);\n\t\tif (rc < 0) {\n\t\t\tpr_err(\"Couldn't read firmware %s\\n\", mc_file);\n\t\t\treturn rc;\n\t\t}\n\t\tdemod->firmware = fw;\n\n\t\tif (demod->firmware->size < 2 * sizeof(u16)) {\n\t\t\trc = -EINVAL;\n\t\t\tpr_err(\"Firmware is too short!\\n\");\n\t\t\tgoto release;\n\t\t}\n\n\t\tpr_info(\"Firmware %s, size %zu\\n\",\n\t\t\tmc_file, demod->firmware->size);\n\t}\n\n\tmc_data_init = demod->firmware->data;\n\tsize = demod->firmware->size;\n\n\tmc_data = (void *)mc_data_init;\n\t \n\tmc_magic_word = be16_to_cpu(*(__be16 *)(mc_data));\n\tmc_data += sizeof(u16);\n\tmc_nr_of_blks = be16_to_cpu(*(__be16 *)(mc_data));\n\tmc_data += sizeof(u16);\n\n\tif ((mc_magic_word != DRX_UCODE_MAGIC_WORD) || (mc_nr_of_blks == 0)) {\n\t\trc = -EINVAL;\n\t\tpr_err(\"Firmware magic word doesn't match\\n\");\n\t\tgoto release;\n\t}\n\n\tif (action == UCODE_UPLOAD) {\n\t\trc = drx_check_firmware(demod, (u8 *)mc_data_init, size);\n\t\tif (rc)\n\t\t\tgoto release;\n\t\tpr_info(\"Uploading firmware %s\\n\", mc_file);\n\t} else {\n\t\tpr_info(\"Verifying if firmware upload was ok.\\n\");\n\t}\n\n\t \n\tfor (i = 0; i < mc_nr_of_blks; i++) {\n\t\tstruct drxu_code_block_hdr block_hdr;\n\t\tu16 mc_block_nr_bytes = 0;\n\n\t\t \n\t\tblock_hdr.addr = be32_to_cpu(*(__be32 *)(mc_data));\n\t\tmc_data += sizeof(u32);\n\t\tblock_hdr.size = be16_to_cpu(*(__be16 *)(mc_data));\n\t\tmc_data += sizeof(u16);\n\t\tblock_hdr.flags = be16_to_cpu(*(__be16 *)(mc_data));\n\t\tmc_data += sizeof(u16);\n\t\tblock_hdr.CRC = be16_to_cpu(*(__be16 *)(mc_data));\n\t\tmc_data += sizeof(u16);\n\n\t\tpr_debug(\"%zd: addr %u, size %u, flags 0x%04x, CRC 0x%04x\\n\",\n\t\t\t(mc_data - mc_data_init), block_hdr.addr,\n\t\t\t block_hdr.size, block_hdr.flags, block_hdr.CRC);\n\n\t\t \n\t\tif ((block_hdr.size > 0x7FFF) ||\n\t\t    (((block_hdr.flags & DRX_UCODE_CRC_FLAG) != 0) &&\n\t\t     (block_hdr.CRC != drx_u_code_compute_crc(mc_data, block_hdr.size)))\n\t\t    ) {\n\t\t\t \n\t\t\trc = -EINVAL;\n\t\t\tpr_err(\"firmware CRC is wrong\\n\");\n\t\t\tgoto release;\n\t\t}\n\n\t\tif (!block_hdr.size)\n\t\t\tcontinue;\n\n\t\tmc_block_nr_bytes = block_hdr.size * ((u16) sizeof(u16));\n\n\t\t \n\t\tswitch (action) {\n\t\tcase UCODE_UPLOAD:\t \n\t\t\tif (drxdap_fasi_write_block(dev_addr,\n\t\t\t\t\t\t\tblock_hdr.addr,\n\t\t\t\t\t\t\tmc_block_nr_bytes,\n\t\t\t\t\t\t\tmc_data, 0x0000)) {\n\t\t\t\trc = -EIO;\n\t\t\t\tpr_err(\"error writing firmware at pos %zd\\n\",\n\t\t\t\t       mc_data - mc_data_init);\n\t\t\t\tgoto release;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase UCODE_VERIFY: {\t \n\t\t\tint result = 0;\n\t\t\tu8 mc_data_buffer[DRX_UCODE_MAX_BUF_SIZE];\n\t\t\tu32 bytes_to_comp = 0;\n\t\t\tu32 bytes_left = mc_block_nr_bytes;\n\t\t\tu32 curr_addr = block_hdr.addr;\n\t\t\tu8 *curr_ptr = mc_data;\n\n\t\t\twhile (bytes_left != 0) {\n\t\t\t\tif (bytes_left > DRX_UCODE_MAX_BUF_SIZE)\n\t\t\t\t\tbytes_to_comp = DRX_UCODE_MAX_BUF_SIZE;\n\t\t\t\telse\n\t\t\t\t\tbytes_to_comp = bytes_left;\n\n\t\t\t\tif (drxdap_fasi_read_block(dev_addr,\n\t\t\t\t\t\t    curr_addr,\n\t\t\t\t\t\t    (u16)bytes_to_comp,\n\t\t\t\t\t\t    (u8 *)mc_data_buffer,\n\t\t\t\t\t\t    0x0000)) {\n\t\t\t\t\tpr_err(\"error reading firmware at pos %zd\\n\",\n\t\t\t\t\t       mc_data - mc_data_init);\n\t\t\t\t\treturn -EIO;\n\t\t\t\t}\n\n\t\t\t\tresult = memcmp(curr_ptr, mc_data_buffer,\n\t\t\t\t\t\tbytes_to_comp);\n\n\t\t\t\tif (result) {\n\t\t\t\t\tpr_err(\"error verifying firmware at pos %zd\\n\",\n\t\t\t\t\t       mc_data - mc_data_init);\n\t\t\t\t\treturn -EIO;\n\t\t\t\t}\n\n\t\t\t\tcurr_addr += ((dr_xaddr_t)(bytes_to_comp / 2));\n\t\t\t\tcurr_ptr =&(curr_ptr[bytes_to_comp]);\n\t\t\t\tbytes_left -=((u32) bytes_to_comp);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\n\t\t}\n\t\tmc_data += mc_block_nr_bytes;\n\t}\n\n\treturn 0;\n\nrelease:\n\trelease_firmware(demod->firmware);\n\tdemod->firmware = NULL;\n\n\treturn rc;\n}\n\n \nstatic int drxj_set_lna_state(struct drx_demod_instance *demod, bool state)\n{\n\tstruct drxuio_cfg uio_cfg;\n\tstruct drxuio_data uio_data;\n\tint result;\n\n\tuio_cfg.uio = DRX_UIO1;\n\tuio_cfg.mode = DRX_UIO_MODE_READWRITE;\n\t \n\tresult = ctrl_set_uio_cfg(demod, &uio_cfg);\n\tif (result) {\n\t\tpr_err(\"Failed to setup LNA GPIO!\\n\");\n\t\treturn result;\n\t}\n\n\tuio_data.uio = DRX_UIO1;\n\tuio_data.value = state;\n\tresult = ctrl_uio_write(demod, &uio_data);\n\tif (result != 0) {\n\t\tpr_err(\"Failed to %sable LNA!\\n\",\n\t\t       state ? \"en\" : \"dis\");\n\t\treturn result;\n\t}\n\treturn 0;\n}\n\n \n\nstatic int drx39xxj_set_powerstate(struct dvb_frontend *fe, int enable)\n{\n\tstruct drx39xxj_state *state = fe->demodulator_priv;\n\tstruct drx_demod_instance *demod = state->demod;\n\tint result;\n\tenum drx_power_mode power_mode;\n\n\tif (enable)\n\t\tpower_mode = DRX_POWER_UP;\n\telse\n\t\tpower_mode = DRX_POWER_DOWN;\n\n\tresult = ctrl_power_mode(demod, &power_mode);\n\tif (result != 0) {\n\t\tpr_err(\"Power state change failed\\n\");\n\t\treturn 0;\n\t}\n\n\treturn 0;\n}\n\nstatic int drx39xxj_read_status(struct dvb_frontend *fe, enum fe_status *status)\n{\n\tstruct drx39xxj_state *state = fe->demodulator_priv;\n\tstruct drx_demod_instance *demod = state->demod;\n\tint result;\n\tenum drx_lock_status lock_status;\n\n\t*status = 0;\n\n\tresult = ctrl_lock_status(demod, &lock_status);\n\tif (result != 0) {\n\t\tpr_err(\"drx39xxj: could not get lock status!\\n\");\n\t\t*status = 0;\n\t}\n\n\tswitch (lock_status) {\n\tcase DRX_NEVER_LOCK:\n\t\t*status = 0;\n\t\tpr_err(\"drx says NEVER_LOCK\\n\");\n\t\tbreak;\n\tcase DRX_NOT_LOCKED:\n\t\t*status = 0;\n\t\tbreak;\n\tcase DRX_LOCK_STATE_1:\n\tcase DRX_LOCK_STATE_2:\n\tcase DRX_LOCK_STATE_3:\n\tcase DRX_LOCK_STATE_4:\n\tcase DRX_LOCK_STATE_5:\n\tcase DRX_LOCK_STATE_6:\n\tcase DRX_LOCK_STATE_7:\n\tcase DRX_LOCK_STATE_8:\n\tcase DRX_LOCK_STATE_9:\n\t\t*status = FE_HAS_SIGNAL\n\t\t    | FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC;\n\t\tbreak;\n\tcase DRX_LOCKED:\n\t\t*status = FE_HAS_SIGNAL\n\t\t    | FE_HAS_CARRIER\n\t\t    | FE_HAS_VITERBI | FE_HAS_SYNC | FE_HAS_LOCK;\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"Lock state unknown %d\\n\", lock_status);\n\t}\n\tctrl_sig_quality(demod, lock_status);\n\n\treturn 0;\n}\n\nstatic int drx39xxj_read_ber(struct dvb_frontend *fe, u32 *ber)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\n\tif (p->pre_bit_error.stat[0].scale == FE_SCALE_NOT_AVAILABLE) {\n\t\t*ber = 0;\n\t\treturn 0;\n\t}\n\n\tif (!p->pre_bit_count.stat[0].uvalue) {\n\t\tif (!p->pre_bit_error.stat[0].uvalue)\n\t\t\t*ber = 0;\n\t\telse\n\t\t\t*ber = 1000000;\n\t} else {\n\t\t*ber = frac_times1e6(p->pre_bit_error.stat[0].uvalue,\n\t\t\t\t     p->pre_bit_count.stat[0].uvalue);\n\t}\n\treturn 0;\n}\n\nstatic int drx39xxj_read_signal_strength(struct dvb_frontend *fe,\n\t\t\t\t\t u16 *strength)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\n\tif (p->strength.stat[0].scale == FE_SCALE_NOT_AVAILABLE) {\n\t\t*strength = 0;\n\t\treturn 0;\n\t}\n\n\t*strength = p->strength.stat[0].uvalue;\n\treturn 0;\n}\n\nstatic int drx39xxj_read_snr(struct dvb_frontend *fe, u16 *snr)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\tu64 tmp64;\n\n\tif (p->cnr.stat[0].scale == FE_SCALE_NOT_AVAILABLE) {\n\t\t*snr = 0;\n\t\treturn 0;\n\t}\n\n\ttmp64 = p->cnr.stat[0].svalue;\n\tdo_div(tmp64, 10);\n\t*snr = tmp64;\n\treturn 0;\n}\n\nstatic int drx39xxj_read_ucblocks(struct dvb_frontend *fe, u32 *ucb)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\n\tif (p->block_error.stat[0].scale == FE_SCALE_NOT_AVAILABLE) {\n\t\t*ucb = 0;\n\t\treturn 0;\n\t}\n\n\t*ucb = p->block_error.stat[0].uvalue;\n\treturn 0;\n}\n\nstatic int drx39xxj_set_frontend(struct dvb_frontend *fe)\n{\n#ifdef DJH_DEBUG\n\tint i;\n#endif\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\tstruct drx39xxj_state *state = fe->demodulator_priv;\n\tstruct drx_demod_instance *demod = state->demod;\n\tenum drx_standard standard = DRX_STANDARD_8VSB;\n\tstruct drx_channel channel;\n\tint result;\n\tstatic const struct drx_channel def_channel = {\n\t\t  0,\n\t\t  DRX_BANDWIDTH_6MHZ,\n\t\t  DRX_MIRROR_NO,\n\t\t  DRX_CONSTELLATION_AUTO,\n\t\t  DRX_HIERARCHY_UNKNOWN,\n\t\t  DRX_PRIORITY_UNKNOWN,\n\t\t  DRX_CODERATE_UNKNOWN,\n\t\t  DRX_GUARD_UNKNOWN,\n\t\t  DRX_FFTMODE_UNKNOWN,\n\t\t  DRX_CLASSIFICATION_AUTO,\n\t\t  5057000,\n\t\t  DRX_INTERLEAVEMODE_UNKNOWN,\n\t\t  DRX_LDPC_UNKNOWN,\n\t\t  DRX_CARRIER_UNKNOWN,\n\t\t  DRX_FRAMEMODE_UNKNOWN\n\t};\n\tu32 constellation = DRX_CONSTELLATION_AUTO;\n\n\t \n\tdrx39xxj_set_powerstate(fe, 1);\n\n\tif (fe->ops.tuner_ops.set_params) {\n\t\tu32 int_freq;\n\n\t\tif (fe->ops.i2c_gate_ctrl)\n\t\t\tfe->ops.i2c_gate_ctrl(fe, 1);\n\n\t\t \n\t\tfe->ops.tuner_ops.set_params(fe);\n\n\t\t \n\t\tif (fe->ops.tuner_ops.get_if_frequency) {\n\t\t\tfe->ops.tuner_ops.get_if_frequency(fe, &int_freq);\n\t\t\tdemod->my_common_attr->intermediate_freq = int_freq / 1000;\n\t\t}\n\n\t\tif (fe->ops.i2c_gate_ctrl)\n\t\t\tfe->ops.i2c_gate_ctrl(fe, 0);\n\t}\n\n\tswitch (p->delivery_system) {\n\tcase SYS_ATSC:\n\t\tstandard = DRX_STANDARD_8VSB;\n\t\tbreak;\n\tcase SYS_DVBC_ANNEX_B:\n\t\tstandard = DRX_STANDARD_ITU_B;\n\n\t\tswitch (p->modulation) {\n\t\tcase QAM_64:\n\t\t\tconstellation = DRX_CONSTELLATION_QAM64;\n\t\t\tbreak;\n\t\tcase QAM_256:\n\t\t\tconstellation = DRX_CONSTELLATION_QAM256;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tconstellation = DRX_CONSTELLATION_AUTO;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\t \n\tresult = ctrl_set_standard(demod, &standard);\n\tif (result != 0) {\n\t\tpr_err(\"Failed to set standard! result=%02x\\n\",\n\t\t\tresult);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tchannel = def_channel;\n\tchannel.frequency = p->frequency / 1000;\n\tchannel.bandwidth = DRX_BANDWIDTH_6MHZ;\n\tchannel.constellation = constellation;\n\n\t \n\tresult = ctrl_set_channel(demod, &channel);\n\tif (result != 0) {\n\t\tpr_err(\"Failed to set channel!\\n\");\n\t\treturn -EINVAL;\n\t}\n\t \n\tdrxj_set_lna_state(demod, false);\n\n\t \n\tp->strength.stat[0].scale = FE_SCALE_RELATIVE;\n\n\treturn 0;\n}\n\nstatic int drx39xxj_sleep(struct dvb_frontend *fe)\n{\n\t \n\treturn drx39xxj_set_powerstate(fe, 0);\n}\n\nstatic int drx39xxj_i2c_gate_ctrl(struct dvb_frontend *fe, int enable)\n{\n\tstruct drx39xxj_state *state = fe->demodulator_priv;\n\tstruct drx_demod_instance *demod = state->demod;\n\tbool i2c_gate_state;\n\tint result;\n\n#ifdef DJH_DEBUG\n\tpr_debug(\"i2c gate call: enable=%d state=%d\\n\", enable,\n\t       state->i2c_gate_open);\n#endif\n\n\tif (enable)\n\t\ti2c_gate_state = true;\n\telse\n\t\ti2c_gate_state = false;\n\n\tif (state->i2c_gate_open == enable) {\n\t\t \n\t\treturn 0;\n\t}\n\n\tresult = ctrl_i2c_bridge(demod, &i2c_gate_state);\n\tif (result != 0) {\n\t\tpr_err(\"drx39xxj: could not open i2c gate [%d]\\n\",\n\t\t       result);\n\t\tdump_stack();\n\t} else {\n\t\tstate->i2c_gate_open = enable;\n\t}\n\treturn 0;\n}\n\nstatic int drx39xxj_init(struct dvb_frontend *fe)\n{\n\tstruct drx39xxj_state *state = fe->demodulator_priv;\n\tstruct drx_demod_instance *demod = state->demod;\n\tint rc = 0;\n\n\tif (fe->exit == DVB_FE_DEVICE_RESUME) {\n\t\t \n\t\tdemod->my_common_attr->is_opened = false;\n\t\trc = drxj_open(demod);\n\t\tif (rc != 0)\n\t\t\tpr_err(\"drx39xxj_init(): DRX open failed rc=%d!\\n\", rc);\n\t} else\n\t\tdrx39xxj_set_powerstate(fe, 1);\n\n\treturn rc;\n}\n\nstatic int drx39xxj_set_lna(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\n\tstruct drx39xxj_state *state = fe->demodulator_priv;\n\tstruct drx_demod_instance *demod = state->demod;\n\tstruct drxj_data *ext_attr = demod->my_ext_attr;\n\n\tif (c->lna) {\n\t\tif (!ext_attr->has_lna) {\n\t\t\tpr_err(\"LNA is not supported on this device!\\n\");\n\t\t\treturn -EINVAL;\n\n\t\t}\n\t}\n\n\treturn drxj_set_lna_state(demod, c->lna);\n}\n\nstatic int drx39xxj_get_tune_settings(struct dvb_frontend *fe,\n\t\t\t\t      struct dvb_frontend_tune_settings *tune)\n{\n\ttune->min_delay_ms = 1000;\n\treturn 0;\n}\n\nstatic void drx39xxj_release(struct dvb_frontend *fe)\n{\n\tstruct drx39xxj_state *state = fe->demodulator_priv;\n\tstruct drx_demod_instance *demod = state->demod;\n\n\t \n\tif (fe->exit != DVB_FE_DEVICE_REMOVED)\n\t\tdrxj_close(demod);\n\n\tkfree(demod->my_ext_attr);\n\tkfree(demod->my_common_attr);\n\tkfree(demod->my_i2c_dev_addr);\n\trelease_firmware(demod->firmware);\n\tkfree(demod);\n\tkfree(state);\n}\n\nstatic const struct dvb_frontend_ops drx39xxj_ops;\n\nstruct dvb_frontend *drx39xxj_attach(struct i2c_adapter *i2c)\n{\n\tstruct drx39xxj_state *state = NULL;\n\tstruct i2c_device_addr *demod_addr = NULL;\n\tstruct drx_common_attr *demod_comm_attr = NULL;\n\tstruct drxj_data *demod_ext_attr = NULL;\n\tstruct drx_demod_instance *demod = NULL;\n\tstruct dtv_frontend_properties *p;\n\tint result;\n\n\t \n\tstate = kzalloc(sizeof(struct drx39xxj_state), GFP_KERNEL);\n\tif (state == NULL)\n\t\tgoto error;\n\n\tdemod = kmemdup(&drxj_default_demod_g,\n\t\t\tsizeof(struct drx_demod_instance), GFP_KERNEL);\n\tif (demod == NULL)\n\t\tgoto error;\n\n\tdemod_addr = kmemdup(&drxj_default_addr_g,\n\t\t\t     sizeof(struct i2c_device_addr), GFP_KERNEL);\n\tif (demod_addr == NULL)\n\t\tgoto error;\n\n\tdemod_comm_attr = kmemdup(&drxj_default_comm_attr_g,\n\t\t\t\t  sizeof(struct drx_common_attr), GFP_KERNEL);\n\tif (demod_comm_attr == NULL)\n\t\tgoto error;\n\n\tdemod_ext_attr = kmemdup(&drxj_data_g, sizeof(struct drxj_data),\n\t\t\t\t GFP_KERNEL);\n\tif (demod_ext_attr == NULL)\n\t\tgoto error;\n\n\t \n\tstate->i2c = i2c;\n\tstate->demod = demod;\n\n\t \n\tdemod->my_i2c_dev_addr = demod_addr;\n\tdemod->my_common_attr = demod_comm_attr;\n\tdemod->my_i2c_dev_addr->user_data = state;\n\tdemod->my_common_attr->microcode_file = DRX39XX_MAIN_FIRMWARE;\n\tdemod->my_common_attr->verify_microcode = true;\n\tdemod->my_common_attr->intermediate_freq = 5000;\n\tdemod->my_common_attr->current_power_mode = DRX_POWER_DOWN;\n\tdemod->my_ext_attr = demod_ext_attr;\n\t((struct drxj_data *)demod_ext_attr)->uio_sma_tx_mode = DRX_UIO_MODE_READWRITE;\n\tdemod->i2c = i2c;\n\n\tresult = drxj_open(demod);\n\tif (result != 0) {\n\t\tpr_err(\"DRX open failed!  Aborting\\n\");\n\t\tgoto error;\n\t}\n\n\t \n\tmemcpy(&state->frontend.ops, &drx39xxj_ops,\n\t       sizeof(struct dvb_frontend_ops));\n\n\tstate->frontend.demodulator_priv = state;\n\n\t \n\tp = &state->frontend.dtv_property_cache;\n\tp->strength.len = 1;\n\tp->pre_bit_count.len = 1;\n\tp->pre_bit_error.len = 1;\n\tp->post_bit_count.len = 1;\n\tp->post_bit_error.len = 1;\n\tp->block_count.len = 1;\n\tp->block_error.len = 1;\n\tp->cnr.len = 1;\n\n\tp->strength.stat[0].scale = FE_SCALE_RELATIVE;\n\tp->pre_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->pre_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->post_bit_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->post_bit_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->block_count.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->block_error.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\tp->cnr.stat[0].scale = FE_SCALE_NOT_AVAILABLE;\n\n\treturn &state->frontend;\n\nerror:\n\tkfree(demod_ext_attr);\n\tkfree(demod_comm_attr);\n\tkfree(demod_addr);\n\tkfree(demod);\n\tkfree(state);\n\n\treturn NULL;\n}\nEXPORT_SYMBOL_GPL(drx39xxj_attach);\n\nstatic const struct dvb_frontend_ops drx39xxj_ops = {\n\t.delsys = { SYS_ATSC, SYS_DVBC_ANNEX_B },\n\t.info = {\n\t\t .name = \"Micronas DRX39xxj family Frontend\",\n\t\t .frequency_min_hz =  51 * MHz,\n\t\t .frequency_max_hz = 858 * MHz,\n\t\t .frequency_stepsize_hz = 62500,\n\t\t .caps = FE_CAN_QAM_64 | FE_CAN_QAM_256 | FE_CAN_8VSB\n\t},\n\n\t.init = drx39xxj_init,\n\t.i2c_gate_ctrl = drx39xxj_i2c_gate_ctrl,\n\t.sleep = drx39xxj_sleep,\n\t.set_frontend = drx39xxj_set_frontend,\n\t.get_tune_settings = drx39xxj_get_tune_settings,\n\t.read_status = drx39xxj_read_status,\n\t.read_ber = drx39xxj_read_ber,\n\t.read_signal_strength = drx39xxj_read_signal_strength,\n\t.read_snr = drx39xxj_read_snr,\n\t.read_ucblocks = drx39xxj_read_ucblocks,\n\t.release = drx39xxj_release,\n\t.set_lna = drx39xxj_set_lna,\n};\n\nMODULE_DESCRIPTION(\"Micronas DRX39xxj Frontend\");\nMODULE_AUTHOR(\"Devin Heitmueller\");\nMODULE_LICENSE(\"GPL\");\nMODULE_FIRMWARE(DRX39XX_MAIN_FIRMWARE);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}