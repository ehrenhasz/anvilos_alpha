{
  "module_name": "cxd2880_tnrdmd_dvbt_mon.c",
  "hash_id": "bcdbafa8dfb47e00e1ad6af07f8b521b36530ca394d48441704fb3fccc865ee1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/dvb-frontends/cxd2880/cxd2880_tnrdmd_dvbt_mon.c",
  "human_readable_source": "\n \n\n#include \"cxd2880_tnrdmd_mon.h\"\n#include \"cxd2880_tnrdmd_dvbt.h\"\n#include \"cxd2880_tnrdmd_dvbt_mon.h\"\n\n#include <linux/int_log.h>\n\nstatic const int ref_dbm_1000[3][5] = {\n\t{-93000, -91000, -90000, -89000, -88000},\n\t{-87000, -85000, -84000, -83000, -82000},\n\t{-82000, -80000, -78000, -77000, -76000},\n};\n\nstatic int is_tps_locked(struct cxd2880_tnrdmd *tnr_dmd);\n\nint cxd2880_tnrdmd_dvbt_mon_sync_stat(struct cxd2880_tnrdmd\n\t\t\t\t      *tnr_dmd, u8 *sync_stat,\n\t\t\t\t      u8 *ts_lock_stat,\n\t\t\t\t      u8 *unlock_detected)\n{\n\tu8 rdata = 0x00;\n\tint ret;\n\n\tif (!tnr_dmd || !sync_stat || !ts_lock_stat || !unlock_detected)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0d);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x10, &rdata, 1);\n\tif (ret)\n\t\treturn ret;\n\n\t*unlock_detected = (rdata & 0x10) ? 1 : 0;\n\t*sync_stat = rdata & 0x07;\n\t*ts_lock_stat = (rdata & 0x20) ? 1 : 0;\n\n\tif (*sync_stat == 0x07)\n\t\treturn -EAGAIN;\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt_mon_sync_stat_sub(struct cxd2880_tnrdmd\n\t\t\t\t\t  *tnr_dmd, u8 *sync_stat,\n\t\t\t\t\t  u8 *unlock_detected)\n{\n\tu8 ts_lock_stat = 0;\n\n\tif (!tnr_dmd || !sync_stat || !unlock_detected)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\treturn cxd2880_tnrdmd_dvbt_mon_sync_stat(tnr_dmd->diver_sub,\n\t\t\t\t\t\t sync_stat,\n\t\t\t\t\t\t &ts_lock_stat,\n\t\t\t\t\t\t unlock_detected);\n}\n\nint cxd2880_tnrdmd_dvbt_mon_mode_guard(struct cxd2880_tnrdmd\n\t\t\t\t       *tnr_dmd,\n\t\t\t\t       enum cxd2880_dvbt_mode\n\t\t\t\t       *mode,\n\t\t\t\t       enum cxd2880_dvbt_guard\n\t\t\t\t       *guard)\n{\n\tu8 rdata = 0x00;\n\tint ret;\n\n\tif (!tnr_dmd || !mode || !guard)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = is_tps_locked(tnr_dmd);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\n\t\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\t\tret =\n\t\t\t    cxd2880_tnrdmd_dvbt_mon_mode_guard(tnr_dmd->diver_sub,\n\t\t\t\t\t\t\t       mode, guard);\n\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0d);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x1b, &rdata, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\t*mode = (enum cxd2880_dvbt_mode)((rdata >> 2) & 0x03);\n\t*guard = (enum cxd2880_dvbt_guard)(rdata & 0x03);\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt_mon_carrier_offset(struct cxd2880_tnrdmd\n\t\t\t\t\t   *tnr_dmd, int *offset)\n{\n\tu8 rdata[4];\n\tu32 ctl_val = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !offset)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = is_tps_locked(tnr_dmd);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0d);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x1d, rdata, 4);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tctl_val =\n\t    ((rdata[0] & 0x1f) << 24) | (rdata[1] << 16) | (rdata[2] << 8) |\n\t    (rdata[3]);\n\t*offset = cxd2880_convert2s_complement(ctl_val, 29);\n\t*offset = -1 * ((*offset) * tnr_dmd->bandwidth / 235);\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt_mon_carrier_offset_sub(struct\n\t\t\t\t\t       cxd2880_tnrdmd\n\t\t\t\t\t       *tnr_dmd,\n\t\t\t\t\t       int *offset)\n{\n\tif (!tnr_dmd || !offset)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\treturn cxd2880_tnrdmd_dvbt_mon_carrier_offset(tnr_dmd->diver_sub,\n\t\t\t\t\t\t      offset);\n}\n\nint cxd2880_tnrdmd_dvbt_mon_tps_info(struct cxd2880_tnrdmd\n\t\t\t\t     *tnr_dmd,\n\t\t\t\t     struct cxd2880_dvbt_tpsinfo\n\t\t\t\t     *info)\n{\n\tu8 rdata[7];\n\tu8 cell_id_ok = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !info)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = is_tps_locked(tnr_dmd);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\n\t\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\t\tret =\n\t\t\t    cxd2880_tnrdmd_dvbt_mon_tps_info(tnr_dmd->diver_sub,\n\t\t\t\t\t\t\t     info);\n\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0d);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x29, rdata, 7);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x11);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0xd5, &cell_id_ok, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tinfo->constellation =\n\t    (enum cxd2880_dvbt_constellation)((rdata[0] >> 6) & 0x03);\n\tinfo->hierarchy = (enum cxd2880_dvbt_hierarchy)((rdata[0] >> 3) & 0x07);\n\tinfo->rate_hp = (enum cxd2880_dvbt_coderate)(rdata[0] & 0x07);\n\tinfo->rate_lp = (enum cxd2880_dvbt_coderate)((rdata[1] >> 5) & 0x07);\n\tinfo->guard = (enum cxd2880_dvbt_guard)((rdata[1] >> 3) & 0x03);\n\tinfo->mode = (enum cxd2880_dvbt_mode)((rdata[1] >> 1) & 0x03);\n\tinfo->fnum = (rdata[2] >> 6) & 0x03;\n\tinfo->length_indicator = rdata[2] & 0x3f;\n\tinfo->cell_id = (rdata[3] << 8) | rdata[4];\n\tinfo->reserved_even = rdata[5] & 0x3f;\n\tinfo->reserved_odd = rdata[6] & 0x3f;\n\n\tinfo->cell_id_ok = cell_id_ok & 0x01;\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt_mon_packet_error_number(struct\n\t\t\t\t\t\tcxd2880_tnrdmd\n\t\t\t\t\t\t*tnr_dmd,\n\t\t\t\t\t\tu32 *pen)\n{\n\tu8 rdata[3];\n\tint ret;\n\n\tif (!tnr_dmd || !pen)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0d);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x26, rdata, 3);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!(rdata[0] & 0x01))\n\t\treturn -EAGAIN;\n\n\t*pen = (rdata[1] << 8) | rdata[2];\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt_mon_spectrum_sense(struct cxd2880_tnrdmd\n\t\t\t\t\t   *tnr_dmd,\n\t\t\t\t\t    enum\n\t\t\t\t\t    cxd2880_tnrdmd_spectrum_sense\n\t\t\t\t\t    *sense)\n{\n\tu8 data = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !sense)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = is_tps_locked(tnr_dmd);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\n\t\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\t\tret = cxd2880_tnrdmd_dvbt_mon_spectrum_sense(tnr_dmd->diver_sub,\n\t\t\t\t\t\t\t\t     sense);\n\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0d);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x1c, &data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\t*sense =\n\t    (data & 0x01) ? CXD2880_TNRDMD_SPECTRUM_INV :\n\t    CXD2880_TNRDMD_SPECTRUM_NORMAL;\n\n\treturn ret;\n}\n\nstatic int dvbt_read_snr_reg(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t     u16 *reg_value)\n{\n\tu8 rdata[2];\n\tint ret;\n\n\tif (!tnr_dmd || !reg_value)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = is_tps_locked(tnr_dmd);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0d);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x13, rdata, 2);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\t*reg_value = (rdata[0] << 8) | rdata[1];\n\n\treturn ret;\n}\n\nstatic int dvbt_calc_snr(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t u32 reg_value, int *snr)\n{\n\tif (!tnr_dmd || !snr)\n\t\treturn -EINVAL;\n\n\tif (reg_value == 0)\n\t\treturn -EAGAIN;\n\n\tif (reg_value > 4996)\n\t\treg_value = 4996;\n\n\t*snr = intlog10(reg_value) - intlog10(5350 - reg_value);\n\t*snr = (*snr + 839) / 1678 + 28500;\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt_mon_snr(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t\tint *snr)\n{\n\tu16 reg_value = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !snr)\n\t\treturn -EINVAL;\n\n\t*snr = -1000 * 1000;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SINGLE) {\n\t\tret = dvbt_read_snr_reg(tnr_dmd, &reg_value);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = dvbt_calc_snr(tnr_dmd, reg_value, snr);\n\t} else {\n\t\tint snr_main = 0;\n\t\tint snr_sub = 0;\n\n\t\tret =\n\t\t    cxd2880_tnrdmd_dvbt_mon_snr_diver(tnr_dmd, snr, &snr_main,\n\t\t\t\t\t\t      &snr_sub);\n\t}\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt_mon_snr_diver(struct cxd2880_tnrdmd\n\t\t\t\t      *tnr_dmd, int *snr,\n\t\t\t\t      int *snr_main, int *snr_sub)\n{\n\tu16 reg_value = 0;\n\tu32 reg_value_sum = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !snr || !snr_main || !snr_sub)\n\t\treturn -EINVAL;\n\n\t*snr = -1000 * 1000;\n\t*snr_main = -1000 * 1000;\n\t*snr_sub = -1000 * 1000;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = dvbt_read_snr_reg(tnr_dmd, &reg_value);\n\tif (!ret) {\n\t\tret = dvbt_calc_snr(tnr_dmd, reg_value, snr_main);\n\t\tif (ret)\n\t\t\treg_value = 0;\n\t} else if (ret == -EAGAIN) {\n\t\treg_value = 0;\n\t} else {\n\t\treturn ret;\n\t}\n\n\treg_value_sum += reg_value;\n\n\tret = dvbt_read_snr_reg(tnr_dmd->diver_sub, &reg_value);\n\tif (!ret) {\n\t\tret = dvbt_calc_snr(tnr_dmd->diver_sub, reg_value, snr_sub);\n\t\tif (ret)\n\t\t\treg_value = 0;\n\t} else if (ret == -EAGAIN) {\n\t\treg_value = 0;\n\t} else {\n\t\treturn ret;\n\t}\n\n\treg_value_sum += reg_value;\n\n\treturn dvbt_calc_snr(tnr_dmd, reg_value_sum, snr);\n}\n\nint cxd2880_tnrdmd_dvbt_mon_sampling_offset(struct cxd2880_tnrdmd\n\t\t\t\t\t    *tnr_dmd, int *ppm)\n{\n\tu8 ctl_val_reg[5];\n\tu8 nominal_rate_reg[5];\n\tu32 trl_ctl_val = 0;\n\tu32 trcg_nominal_rate = 0;\n\tint num;\n\tint den;\n\ts8 diff_upper = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !ppm)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = is_tps_locked(tnr_dmd);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0d);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x21, ctl_val_reg,\n\t\t\t\t     sizeof(ctl_val_reg));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x04);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x60, nominal_rate_reg,\n\t\t\t\t     sizeof(nominal_rate_reg));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tdiff_upper =\n\t    (ctl_val_reg[0] & 0x7f) - (nominal_rate_reg[0] & 0x7f);\n\n\tif (diff_upper < -1 || diff_upper > 1)\n\t\treturn -EAGAIN;\n\n\ttrl_ctl_val = ctl_val_reg[1] << 24;\n\ttrl_ctl_val |= ctl_val_reg[2] << 16;\n\ttrl_ctl_val |= ctl_val_reg[3] << 8;\n\ttrl_ctl_val |= ctl_val_reg[4];\n\n\ttrcg_nominal_rate = nominal_rate_reg[1] << 24;\n\ttrcg_nominal_rate |= nominal_rate_reg[2] << 16;\n\ttrcg_nominal_rate |= nominal_rate_reg[3] << 8;\n\ttrcg_nominal_rate |= nominal_rate_reg[4];\n\n\ttrl_ctl_val >>= 1;\n\ttrcg_nominal_rate >>= 1;\n\n\tif (diff_upper == 1)\n\t\tnum =\n\t\t    (int)((trl_ctl_val + 0x80000000u) -\n\t\t\t  trcg_nominal_rate);\n\telse if (diff_upper == -1)\n\t\tnum =\n\t\t    -(int)((trcg_nominal_rate + 0x80000000u) -\n\t\t\t   trl_ctl_val);\n\telse\n\t\tnum = (int)(trl_ctl_val - trcg_nominal_rate);\n\n\tden = (nominal_rate_reg[0] & 0x7f) << 24;\n\tden |= nominal_rate_reg[1] << 16;\n\tden |= nominal_rate_reg[2] << 8;\n\tden |= nominal_rate_reg[3];\n\tden = (den + (390625 / 2)) / 390625;\n\n\tden >>= 1;\n\n\tif (num >= 0)\n\t\t*ppm = (num + (den / 2)) / den;\n\telse\n\t\t*ppm = (num - (den / 2)) / den;\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt_mon_sampling_offset_sub(struct\n\t\t\t\t\t\tcxd2880_tnrdmd\n\t\t\t\t\t\t*tnr_dmd, int *ppm)\n{\n\tif (!tnr_dmd || !ppm)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\treturn cxd2880_tnrdmd_dvbt_mon_sampling_offset(tnr_dmd->diver_sub, ppm);\n}\n\nstatic int dvbt_calc_ssi(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t int rf_lvl, u8 *ssi)\n{\n\tstruct cxd2880_dvbt_tpsinfo tps;\n\tint prel;\n\tint temp_ssi = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !ssi)\n\t\treturn -EINVAL;\n\n\tret = cxd2880_tnrdmd_dvbt_mon_tps_info(tnr_dmd, &tps);\n\tif (ret)\n\t\treturn ret;\n\n\tif (tps.constellation >= CXD2880_DVBT_CONSTELLATION_RESERVED_3 ||\n\t    tps.rate_hp >= CXD2880_DVBT_CODERATE_RESERVED_5)\n\t\treturn -EINVAL;\n\n\tprel = rf_lvl - ref_dbm_1000[tps.constellation][tps.rate_hp];\n\n\tif (prel < -15000)\n\t\ttemp_ssi = 0;\n\telse if (prel < 0)\n\t\ttemp_ssi = ((2 * (prel + 15000)) + 1500) / 3000;\n\telse if (prel < 20000)\n\t\ttemp_ssi = (((4 * prel) + 500) / 1000) + 10;\n\telse if (prel < 35000)\n\t\ttemp_ssi = (((2 * (prel - 20000)) + 1500) / 3000) + 90;\n\telse\n\t\ttemp_ssi = 100;\n\n\t*ssi = (temp_ssi > 100) ? 100 : (u8)temp_ssi;\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt_mon_ssi(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t\tu8 *ssi)\n{\n\tint rf_lvl = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !ssi)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = cxd2880_tnrdmd_mon_rf_lvl(tnr_dmd, &rf_lvl);\n\tif (ret)\n\t\treturn ret;\n\n\treturn dvbt_calc_ssi(tnr_dmd, rf_lvl, ssi);\n}\n\nint cxd2880_tnrdmd_dvbt_mon_ssi_sub(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t\t    u8 *ssi)\n{\n\tint rf_lvl = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !ssi)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT)\n\t\treturn -EINVAL;\n\n\tret = cxd2880_tnrdmd_mon_rf_lvl(tnr_dmd->diver_sub, &rf_lvl);\n\tif (ret)\n\t\treturn ret;\n\n\treturn dvbt_calc_ssi(tnr_dmd, rf_lvl, ssi);\n}\n\nstatic int is_tps_locked(struct cxd2880_tnrdmd *tnr_dmd)\n{\n\tu8 sync = 0;\n\tu8 tslock = 0;\n\tu8 early_unlock = 0;\n\tint ret;\n\n\tif (!tnr_dmd)\n\t\treturn -EINVAL;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt_mon_sync_stat(tnr_dmd, &sync, &tslock,\n\t\t\t\t\t      &early_unlock);\n\tif (ret)\n\t\treturn ret;\n\n\tif (sync != 6)\n\t\treturn -EAGAIN;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}