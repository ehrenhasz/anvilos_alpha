{
  "module_name": "cxd2880_tnrdmd_dvbt2_mon.c",
  "hash_id": "3bb775d8eccf9c48063381580b2ca386a39361ad0d97b4ba01cf70716fe03c9a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/dvb-frontends/cxd2880/cxd2880_tnrdmd_dvbt2_mon.c",
  "human_readable_source": "\n \n\n#include \"cxd2880_tnrdmd_mon.h\"\n#include \"cxd2880_tnrdmd_dvbt2.h\"\n#include \"cxd2880_tnrdmd_dvbt2_mon.h\"\n\n#include <linux/int_log.h>\n\nstatic const int ref_dbm_1000[4][8] = {\n\t{-96000, -95000, -94000, -93000, -92000, -92000, -98000, -97000},\n\t{-91000, -89000, -88000, -87000, -86000, -86000, -93000, -92000},\n\t{-86000, -85000, -83000, -82000, -81000, -80000, -89000, -88000},\n\t{-82000, -80000, -78000, -76000, -75000, -74000, -86000, -84000},\n};\n\nint cxd2880_tnrdmd_dvbt2_mon_sync_stat(struct cxd2880_tnrdmd\n\t\t\t\t       *tnr_dmd, u8 *sync_stat,\n\t\t\t\t       u8 *ts_lock_stat,\n\t\t\t\t       u8 *unlock_detected)\n{\n\tu8 data;\n\tint ret;\n\n\tif (!tnr_dmd || !sync_stat || !ts_lock_stat || !unlock_detected)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x10, &data, sizeof(data));\n\tif (ret)\n\t\treturn ret;\n\n\t*sync_stat = data & 0x07;\n\t*ts_lock_stat = ((data & 0x20) ? 1 : 0);\n\t*unlock_detected = ((data & 0x10) ? 1 : 0);\n\n\tif (*sync_stat == 0x07)\n\t\treturn -EAGAIN;\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_sync_stat_sub(struct cxd2880_tnrdmd\n\t\t\t\t\t   *tnr_dmd,\n\t\t\t\t\t   u8 *sync_stat,\n\t\t\t\t\t   u8 *unlock_detected)\n{\n\tu8 ts_lock_stat = 0;\n\n\tif (!tnr_dmd || !sync_stat || !unlock_detected)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\treturn cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd->diver_sub,\n\t\t\t\t\t\t  sync_stat,\n\t\t\t\t\t\t  &ts_lock_stat,\n\t\t\t\t\t\t  unlock_detected);\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_carrier_offset(struct cxd2880_tnrdmd\n\t\t\t\t\t    *tnr_dmd, int *offset)\n{\n\tu8 data[4];\n\tu32 ctl_val = 0;\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 unlock_detected = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !offset)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state,\n\t\t\t\t\t       &ts_lock,\n\t\t\t\t\t       &unlock_detected);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (sync_state != 6) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x30, data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tctl_val =\n\t    ((data[0] & 0x0f) << 24) | (data[1] << 16) | (data[2] << 8)\n\t    | (data[3]);\n\t*offset = cxd2880_convert2s_complement(ctl_val, 28);\n\n\tswitch (tnr_dmd->bandwidth) {\n\tcase CXD2880_DTV_BW_1_7_MHZ:\n\t\t*offset = -1 * ((*offset) / 582);\n\t\tbreak;\n\tcase CXD2880_DTV_BW_5_MHZ:\n\tcase CXD2880_DTV_BW_6_MHZ:\n\tcase CXD2880_DTV_BW_7_MHZ:\n\tcase CXD2880_DTV_BW_8_MHZ:\n\t\t*offset = -1 * ((*offset) * tnr_dmd->bandwidth / 940);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_carrier_offset_sub(struct\n\t\t\t\t\t\tcxd2880_tnrdmd\n\t\t\t\t\t\t*tnr_dmd,\n\t\t\t\t\t\tint *offset)\n{\n\tif (!tnr_dmd || !offset)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\treturn cxd2880_tnrdmd_dvbt2_mon_carrier_offset(tnr_dmd->diver_sub,\n\t\t\t\t\t\t       offset);\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_l1_pre(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t\t    struct cxd2880_dvbt2_l1pre\n\t\t\t\t    *l1_pre)\n{\n\tu8 data[37];\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 unlock_detected = 0;\n\tu8 version = 0;\n\tenum cxd2880_dvbt2_profile profile;\n\tint ret;\n\n\tif (!tnr_dmd || !l1_pre)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state,\n\t\t\t\t\t       &ts_lock,\n\t\t\t\t\t       &unlock_detected);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (sync_state < 5) {\n\t\tif (tnr_dmd->diver_mode ==\n\t\t    CXD2880_TNRDMD_DIVERMODE_MAIN) {\n\t\t\tret =\n\t\t\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat_sub\n\t\t\t    (tnr_dmd, &sync_state, &unlock_detected);\n\t\t\tif (ret) {\n\t\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\t\treturn ret;\n\t\t\t}\n\n\t\t\tif (sync_state < 5) {\n\t\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\t\treturn -EAGAIN;\n\t\t\t}\n\t\t} else {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn -EAGAIN;\n\t\t}\n\t}\n\n\tret = cxd2880_tnrdmd_dvbt2_mon_profile(tnr_dmd, &profile);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x61, data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tl1_pre->type = (enum cxd2880_dvbt2_l1pre_type)data[0];\n\tl1_pre->bw_ext = data[1] & 0x01;\n\tl1_pre->s1 = (enum cxd2880_dvbt2_s1)(data[2] & 0x07);\n\tl1_pre->s2 = data[3] & 0x0f;\n\tl1_pre->l1_rep = data[4] & 0x01;\n\tl1_pre->gi = (enum cxd2880_dvbt2_guard)(data[5] & 0x07);\n\tl1_pre->papr = (enum cxd2880_dvbt2_papr)(data[6] & 0x0f);\n\tl1_pre->mod =\n\t    (enum cxd2880_dvbt2_l1post_constell)(data[7] & 0x0f);\n\tl1_pre->cr = (enum cxd2880_dvbt2_l1post_cr)(data[8] & 0x03);\n\tl1_pre->fec =\n\t    (enum cxd2880_dvbt2_l1post_fec_type)(data[9] & 0x03);\n\tl1_pre->l1_post_size = (data[10] & 0x03) << 16;\n\tl1_pre->l1_post_size |= (data[11]) << 8;\n\tl1_pre->l1_post_size |= (data[12]);\n\tl1_pre->l1_post_info_size = (data[13] & 0x03) << 16;\n\tl1_pre->l1_post_info_size |= (data[14]) << 8;\n\tl1_pre->l1_post_info_size |= (data[15]);\n\tl1_pre->pp = (enum cxd2880_dvbt2_pp)(data[16] & 0x0f);\n\tl1_pre->tx_id_availability = data[17];\n\tl1_pre->cell_id = (data[18] << 8);\n\tl1_pre->cell_id |= (data[19]);\n\tl1_pre->network_id = (data[20] << 8);\n\tl1_pre->network_id |= (data[21]);\n\tl1_pre->sys_id = (data[22] << 8);\n\tl1_pre->sys_id |= (data[23]);\n\tl1_pre->num_frames = data[24];\n\tl1_pre->num_symbols = (data[25] & 0x0f) << 8;\n\tl1_pre->num_symbols |= data[26];\n\tl1_pre->regen = data[27] & 0x07;\n\tl1_pre->post_ext = data[28] & 0x01;\n\tl1_pre->num_rf_freqs = data[29] & 0x07;\n\tl1_pre->rf_idx = data[30] & 0x07;\n\tversion = (data[31] & 0x03) << 2;\n\tversion |= (data[32] & 0xc0) >> 6;\n\tl1_pre->t2_version = (enum cxd2880_dvbt2_version)version;\n\tl1_pre->l1_post_scrambled = (data[32] & 0x20) >> 5;\n\tl1_pre->t2_base_lite = (data[32] & 0x10) >> 4;\n\tl1_pre->crc32 = (data[33] << 24);\n\tl1_pre->crc32 |= (data[34] << 16);\n\tl1_pre->crc32 |= (data[35] << 8);\n\tl1_pre->crc32 |= data[36];\n\n\tif (profile == CXD2880_DVBT2_PROFILE_BASE) {\n\t\tswitch ((l1_pre->s2 >> 1)) {\n\t\tcase CXD2880_DVBT2_BASE_S2_M1K_G_ANY:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M1K;\n\t\t\tbreak;\n\t\tcase CXD2880_DVBT2_BASE_S2_M2K_G_ANY:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M2K;\n\t\t\tbreak;\n\t\tcase CXD2880_DVBT2_BASE_S2_M4K_G_ANY:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M4K;\n\t\t\tbreak;\n\t\tcase CXD2880_DVBT2_BASE_S2_M8K_G_DVBT:\n\t\tcase CXD2880_DVBT2_BASE_S2_M8K_G_DVBT2:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M8K;\n\t\t\tbreak;\n\t\tcase CXD2880_DVBT2_BASE_S2_M16K_G_ANY:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M16K;\n\t\t\tbreak;\n\t\tcase CXD2880_DVBT2_BASE_S2_M32K_G_DVBT:\n\t\tcase CXD2880_DVBT2_BASE_S2_M32K_G_DVBT2:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M32K;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EAGAIN;\n\t\t}\n\t} else if (profile == CXD2880_DVBT2_PROFILE_LITE) {\n\t\tswitch ((l1_pre->s2 >> 1)) {\n\t\tcase CXD2880_DVBT2_LITE_S2_M2K_G_ANY:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M2K;\n\t\t\tbreak;\n\t\tcase CXD2880_DVBT2_LITE_S2_M4K_G_ANY:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M4K;\n\t\t\tbreak;\n\t\tcase CXD2880_DVBT2_LITE_S2_M8K_G_DVBT:\n\t\tcase CXD2880_DVBT2_LITE_S2_M8K_G_DVBT2:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M8K;\n\t\t\tbreak;\n\t\tcase CXD2880_DVBT2_LITE_S2_M16K_G_DVBT:\n\t\tcase CXD2880_DVBT2_LITE_S2_M16K_G_DVBT2:\n\t\t\tl1_pre->fft_mode = CXD2880_DVBT2_M16K;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EAGAIN;\n\t\t}\n\t} else {\n\t\treturn -EAGAIN;\n\t}\n\n\tl1_pre->mixed = l1_pre->s2 & 0x01;\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_version(struct cxd2880_tnrdmd\n\t\t\t\t     *tnr_dmd,\n\t\t\t\t     enum cxd2880_dvbt2_version\n\t\t\t\t     *ver)\n{\n\tu8 data[2];\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 unlock_detected = 0;\n\tu8 version = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !ver)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state,\n\t\t\t\t\t       &ts_lock,\n\t\t\t\t\t       &unlock_detected);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (sync_state < 5) {\n\t\tif (tnr_dmd->diver_mode ==\n\t\t    CXD2880_TNRDMD_DIVERMODE_MAIN) {\n\t\t\tret =\n\t\t\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat_sub\n\t\t\t    (tnr_dmd, &sync_state, &unlock_detected);\n\t\t\tif (ret) {\n\t\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\t\treturn ret;\n\t\t\t}\n\n\t\t\tif (sync_state < 5) {\n\t\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\t\treturn -EAGAIN;\n\t\t\t}\n\t\t} else {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn -EAGAIN;\n\t\t}\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x80, data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tversion = ((data[0] & 0x03) << 2);\n\tversion |= ((data[1] & 0xc0) >> 6);\n\t*ver = (enum cxd2880_dvbt2_version)version;\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_ofdm(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t\t  struct cxd2880_dvbt2_ofdm *ofdm)\n{\n\tu8 data[5];\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 unlock_detected = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !ofdm)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state,\n\t\t\t\t\t       &ts_lock,\n\t\t\t\t\t       &unlock_detected);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (sync_state != 6) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\n\t\tret = -EAGAIN;\n\n\t\tif (tnr_dmd->diver_mode ==\n\t\t    CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\t\tret =\n\t\t\t    cxd2880_tnrdmd_dvbt2_mon_ofdm(tnr_dmd->diver_sub,\n\t\t\t\t\t\t\t  ofdm);\n\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x1d, data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tofdm->mixed = ((data[0] & 0x20) ? 1 : 0);\n\tofdm->is_miso = ((data[0] & 0x10) >> 4);\n\tofdm->mode = (enum cxd2880_dvbt2_mode)(data[0] & 0x07);\n\tofdm->gi = (enum cxd2880_dvbt2_guard)((data[1] & 0x70) >> 4);\n\tofdm->pp = (enum cxd2880_dvbt2_pp)(data[1] & 0x07);\n\tofdm->bw_ext = (data[2] & 0x10) >> 4;\n\tofdm->papr = (enum cxd2880_dvbt2_papr)(data[2] & 0x0f);\n\tofdm->num_symbols = (data[3] << 8) | data[4];\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_data_plps(struct cxd2880_tnrdmd\n\t\t\t\t       *tnr_dmd, u8 *plp_ids,\n\t\t\t\t       u8 *num_plps)\n{\n\tu8 l1_post_ok = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !num_plps)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret)\n\t\treturn ret;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x86, &l1_post_ok, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (!(l1_post_ok & 0x01)) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0xc1, num_plps, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (*num_plps == 0) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!plp_ids) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn 0;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0xc2,\n\t\t\t\t     plp_ids,\n\t\t\t\t     ((*num_plps > 62) ?\n\t\t\t\t     62 : *num_plps));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (*num_plps > 62) {\n\t\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0x00, 0x0c);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0x10, plp_ids + 62,\n\t\t\t\t\t     *num_plps - 62);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_active_plp(struct cxd2880_tnrdmd\n\t\t\t\t\t*tnr_dmd,\n\t\t\t\t\tenum\n\t\t\t\t\tcxd2880_dvbt2_plp_btype\n\t\t\t\t\ttype,\n\t\t\t\t\tstruct cxd2880_dvbt2_plp\n\t\t\t\t\t*plp_info)\n{\n\tu8 data[20];\n\tu8 addr = 0;\n\tu8 index = 0;\n\tu8 l1_post_ok = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !plp_info)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x86, &l1_post_ok, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (!l1_post_ok) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tif (type == CXD2880_DVBT2_PLP_COMMON)\n\t\taddr = 0xa9;\n\telse\n\t\taddr = 0x96;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     addr, data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tif (type == CXD2880_DVBT2_PLP_COMMON && !data[13])\n\t\treturn -EAGAIN;\n\n\tplp_info->id = data[index++];\n\tplp_info->type =\n\t    (enum cxd2880_dvbt2_plp_type)(data[index++] & 0x07);\n\tplp_info->payload =\n\t    (enum cxd2880_dvbt2_plp_payload)(data[index++] & 0x1f);\n\tplp_info->ff = data[index++] & 0x01;\n\tplp_info->first_rf_idx = data[index++] & 0x07;\n\tplp_info->first_frm_idx = data[index++];\n\tplp_info->group_id = data[index++];\n\tplp_info->plp_cr =\n\t    (enum cxd2880_dvbt2_plp_code_rate)(data[index++] & 0x07);\n\tplp_info->constell =\n\t    (enum cxd2880_dvbt2_plp_constell)(data[index++] & 0x07);\n\tplp_info->rot = data[index++] & 0x01;\n\tplp_info->fec =\n\t    (enum cxd2880_dvbt2_plp_fec)(data[index++] & 0x03);\n\tplp_info->num_blocks_max = (data[index++] & 0x03) << 8;\n\tplp_info->num_blocks_max |= data[index++];\n\tplp_info->frm_int = data[index++];\n\tplp_info->til_len = data[index++];\n\tplp_info->til_type = data[index++] & 0x01;\n\n\tplp_info->in_band_a_flag = data[index++] & 0x01;\n\tplp_info->rsvd = data[index++] << 8;\n\tplp_info->rsvd |= data[index++];\n\n\tplp_info->in_band_b_flag =\n\t    (plp_info->rsvd & 0x8000) >> 15;\n\tplp_info->plp_mode =\n\t    (enum cxd2880_dvbt2_plp_mode)((plp_info->rsvd & 0x000c) >> 2);\n\tplp_info->static_flag = (plp_info->rsvd & 0x0002) >> 1;\n\tplp_info->static_padding_flag = plp_info->rsvd & 0x0001;\n\tplp_info->rsvd = (plp_info->rsvd & 0x7ff0) >> 4;\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_data_plp_error(struct cxd2880_tnrdmd\n\t\t\t\t\t    *tnr_dmd,\n\t\t\t\t\t    u8 *plp_error)\n{\n\tu8 data;\n\tint ret;\n\n\tif (!tnr_dmd || !plp_error)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x86, &data, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif ((data & 0x01) == 0x00) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0xc0, &data, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\t*plp_error = data & 0x01;\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_l1_change(struct cxd2880_tnrdmd\n\t\t\t\t       *tnr_dmd, u8 *l1_change)\n{\n\tu8 data;\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 unlock_detected = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !l1_change)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state,\n\t\t\t\t\t       &ts_lock,\n\t\t\t\t\t       &unlock_detected);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (sync_state < 5) {\n\t\tif (tnr_dmd->diver_mode ==\n\t\t    CXD2880_TNRDMD_DIVERMODE_MAIN) {\n\t\t\tret =\n\t\t\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat_sub\n\t\t\t    (tnr_dmd, &sync_state, &unlock_detected);\n\t\t\tif (ret) {\n\t\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\t\treturn ret;\n\t\t\t}\n\n\t\t\tif (sync_state < 5) {\n\t\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\t\treturn -EAGAIN;\n\t\t\t}\n\t\t} else {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn -EAGAIN;\n\t\t}\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x5f, &data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\t*l1_change = data & 0x01;\n\tif (*l1_change) {\n\t\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0x00, 0x22);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0x16, 0x01);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\t}\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_l1_post(struct cxd2880_tnrdmd\n\t\t\t\t     *tnr_dmd,\n\t\t\t\t     struct cxd2880_dvbt2_l1post\n\t\t\t\t     *l1_post)\n{\n\tu8 data[16];\n\tint ret;\n\n\tif (!tnr_dmd || !l1_post)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x86, data, sizeof(data));\n\tif (ret)\n\t\treturn ret;\n\n\tif (!(data[0] & 0x01))\n\t\treturn -EAGAIN;\n\n\tl1_post->sub_slices_per_frame = (data[1] & 0x7f) << 8;\n\tl1_post->sub_slices_per_frame |= data[2];\n\tl1_post->num_plps = data[3];\n\tl1_post->num_aux = data[4] & 0x0f;\n\tl1_post->aux_cfg_rfu = data[5];\n\tl1_post->rf_idx = data[6] & 0x07;\n\tl1_post->freq = data[7] << 24;\n\tl1_post->freq |= data[8] << 16;\n\tl1_post->freq |= data[9] << 8;\n\tl1_post->freq |= data[10];\n\tl1_post->fef_type = data[11] & 0x0f;\n\tl1_post->fef_length = data[12] << 16;\n\tl1_post->fef_length |= data[13] << 8;\n\tl1_post->fef_length |= data[14];\n\tl1_post->fef_intvl = data[15];\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_bbheader(struct cxd2880_tnrdmd\n\t\t\t\t      *tnr_dmd,\n\t\t\t\t      enum cxd2880_dvbt2_plp_btype\n\t\t\t\t      type,\n\t\t\t\t      struct cxd2880_dvbt2_bbheader\n\t\t\t\t      *bbheader)\n{\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 unlock_detected = 0;\n\tu8 data[14];\n\tu8 addr = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !bbheader)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state,\n\t\t\t\t\t\t       &ts_lock,\n\t\t\t\t\t\t       &unlock_detected);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (!ts_lock) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (type == CXD2880_DVBT2_PLP_COMMON) {\n\t\tu8 l1_post_ok;\n\t\tu8 data;\n\n\t\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0x86, &l1_post_ok, 1);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (!(l1_post_ok & 0x01)) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0xb6, &data, 1);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (data == 0) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn -EAGAIN;\n\t\t}\n\t}\n\n\tif (type == CXD2880_DVBT2_PLP_COMMON)\n\t\taddr = 0x51;\n\telse\n\t\taddr = 0x42;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     addr, data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tbbheader->stream_input =\n\t    (enum cxd2880_dvbt2_stream)((data[0] >> 6) & 0x03);\n\tbbheader->is_single_input_stream = (data[0] >> 5) & 0x01;\n\tbbheader->is_constant_coding_modulation =\n\t    (data[0] >> 4) & 0x01;\n\tbbheader->issy_indicator = (data[0] >> 3) & 0x01;\n\tbbheader->null_packet_deletion = (data[0] >> 2) & 0x01;\n\tbbheader->ext = data[0] & 0x03;\n\n\tbbheader->input_stream_identifier = data[1];\n\tbbheader->plp_mode =\n\t    (data[3] & 0x01) ? CXD2880_DVBT2_PLP_MODE_HEM :\n\t    CXD2880_DVBT2_PLP_MODE_NM;\n\tbbheader->data_field_length = (data[4] << 8) | data[5];\n\n\tif (bbheader->plp_mode == CXD2880_DVBT2_PLP_MODE_NM) {\n\t\tbbheader->user_packet_length =\n\t\t    (data[6] << 8) | data[7];\n\t\tbbheader->sync_byte = data[8];\n\t\tbbheader->issy = 0;\n\t} else {\n\t\tbbheader->user_packet_length = 0;\n\t\tbbheader->sync_byte = 0;\n\t\tbbheader->issy =\n\t\t    (data[11] << 16) | (data[12] << 8) | data[13];\n\t}\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_in_bandb_ts_rate(struct cxd2880_tnrdmd\n\t\t\t\t\t      *tnr_dmd,\n\t\t\t\t\t      enum\n\t\t\t\t\t      cxd2880_dvbt2_plp_btype\n\t\t\t\t\t      type,\n\t\t\t\t\t      u32 *ts_rate_bps)\n{\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 unlock_detected = 0;\n\tu8 l1_post_ok = 0;\n\tu8 data[4];\n\tu8 addr = 0;\n\n\tint ret;\n\n\tif (!tnr_dmd || !ts_rate_bps)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state,\n\t\t\t\t\t       &ts_lock,\n\t\t\t\t\t       &unlock_detected);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (!ts_lock) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x86, &l1_post_ok, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (!(l1_post_ok & 0x01)) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tif (type == CXD2880_DVBT2_PLP_COMMON)\n\t\taddr = 0xba;\n\telse\n\t\taddr = 0xa7;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     addr, &data[0], 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif ((data[0] & 0x80) == 0x00) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x25);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (type == CXD2880_DVBT2_PLP_COMMON)\n\t\taddr = 0xa6;\n\telse\n\t\taddr = 0xaa;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     addr, &data[0], 4);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\t*ts_rate_bps = ((data[0] & 0x07) << 24) | (data[1] << 16) |\n\t\t       (data[2] << 8) | data[3];\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_spectrum_sense(struct cxd2880_tnrdmd\n\t\t\t\t\t    *tnr_dmd,\n\t\t\t\t\t    enum\n\t\t\t\t\t    cxd2880_tnrdmd_spectrum_sense\n\t\t\t\t\t    *sense)\n{\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 early_unlock = 0;\n\tu8 data = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !sense)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state, &ts_lock,\n\t\t\t\t\t       &early_unlock);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (sync_state != 6) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\n\t\tret = -EAGAIN;\n\n\t\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\t\tret =\n\t\t\t    cxd2880_tnrdmd_dvbt2_mon_spectrum_sense(tnr_dmd->diver_sub,\n\t\t\t\t\t\t\t\t    sense);\n\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x2f, &data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\t*sense =\n\t    (data & 0x01) ? CXD2880_TNRDMD_SPECTRUM_INV :\n\t    CXD2880_TNRDMD_SPECTRUM_NORMAL;\n\n\treturn 0;\n}\n\nstatic int dvbt2_read_snr_reg(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t      u16 *reg_value)\n{\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 unlock_detected = 0;\n\tu8 data[2];\n\tint ret;\n\n\tif (!tnr_dmd || !reg_value)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state,\n\t\t\t\t\t       &ts_lock,\n\t\t\t\t\t       &unlock_detected);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (sync_state != 6) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x13, data, sizeof(data));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\t*reg_value = (data[0] << 8) | data[1];\n\n\treturn ret;\n}\n\nstatic int dvbt2_calc_snr(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t  u32 reg_value, int *snr)\n{\n\tif (!tnr_dmd || !snr)\n\t\treturn -EINVAL;\n\n\tif (reg_value == 0)\n\t\treturn -EAGAIN;\n\n\tif (reg_value > 10876)\n\t\treg_value = 10876;\n\n\t*snr = intlog10(reg_value) - intlog10(12600 - reg_value);\n\t*snr = (*snr + 839) / 1678 + 32000;\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_snr(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t\t int *snr)\n{\n\tu16 reg_value = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !snr)\n\t\treturn -EINVAL;\n\n\t*snr = -1000 * 1000;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SINGLE) {\n\t\tret = dvbt2_read_snr_reg(tnr_dmd, &reg_value);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = dvbt2_calc_snr(tnr_dmd, reg_value, snr);\n\t} else {\n\t\tint snr_main = 0;\n\t\tint snr_sub = 0;\n\n\t\tret =\n\t\t    cxd2880_tnrdmd_dvbt2_mon_snr_diver(tnr_dmd, snr, &snr_main,\n\t\t\t\t\t\t       &snr_sub);\n\t}\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_snr_diver(struct cxd2880_tnrdmd\n\t\t\t\t       *tnr_dmd, int *snr,\n\t\t\t\t       int *snr_main, int *snr_sub)\n{\n\tu16 reg_value = 0;\n\tu32 reg_value_sum = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !snr || !snr_main || !snr_sub)\n\t\treturn -EINVAL;\n\n\t*snr = -1000 * 1000;\n\t*snr_main = -1000 * 1000;\n\t*snr_sub = -1000 * 1000;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = dvbt2_read_snr_reg(tnr_dmd, &reg_value);\n\tif (!ret) {\n\t\tret = dvbt2_calc_snr(tnr_dmd, reg_value, snr_main);\n\t\tif (ret)\n\t\t\treg_value = 0;\n\t} else if (ret == -EAGAIN) {\n\t\treg_value = 0;\n\t} else {\n\t\treturn ret;\n\t}\n\n\treg_value_sum += reg_value;\n\n\tret = dvbt2_read_snr_reg(tnr_dmd->diver_sub, &reg_value);\n\tif (!ret) {\n\t\tret = dvbt2_calc_snr(tnr_dmd->diver_sub, reg_value, snr_sub);\n\t\tif (ret)\n\t\t\treg_value = 0;\n\t} else if (ret == -EAGAIN) {\n\t\treg_value = 0;\n\t} else {\n\t\treturn ret;\n\t}\n\n\treg_value_sum += reg_value;\n\n\treturn dvbt2_calc_snr(tnr_dmd, reg_value_sum, snr);\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_packet_error_number(struct\n\t\t\t\t\t\t cxd2880_tnrdmd\n\t\t\t\t\t\t *tnr_dmd,\n\t\t\t\t\t\t u32 *pen)\n{\n\tint ret;\n\tu8 data[3];\n\n\tif (!tnr_dmd || !pen)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x39, data, sizeof(data));\n\tif (ret)\n\t\treturn ret;\n\n\tif (!(data[0] & 0x01))\n\t\treturn -EAGAIN;\n\n\t*pen = ((data[1] << 8) | data[2]);\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_sampling_offset(struct cxd2880_tnrdmd\n\t\t\t\t\t     *tnr_dmd, int *ppm)\n{\n\tu8 ctl_val_reg[5];\n\tu8 nominal_rate_reg[5];\n\tu32 trl_ctl_val = 0;\n\tu32 trcg_nominal_rate = 0;\n\tint num;\n\tint den;\n\tint ret;\n\tu8 sync_state = 0;\n\tu8 ts_lock = 0;\n\tu8 unlock_detected = 0;\n\ts8 diff_upper = 0;\n\n\tif (!tnr_dmd || !ppm)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_sync_stat(tnr_dmd, &sync_state,\n\t\t\t\t\t       &ts_lock,\n\t\t\t\t\t       &unlock_detected);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (sync_state != 6) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x34, ctl_val_reg,\n\t\t\t\t     sizeof(ctl_val_reg));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x04);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x10, nominal_rate_reg,\n\t\t\t\t     sizeof(nominal_rate_reg));\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\tdiff_upper =\n\t    (ctl_val_reg[0] & 0x7f) - (nominal_rate_reg[0] & 0x7f);\n\n\tif (diff_upper < -1 || diff_upper > 1)\n\t\treturn -EAGAIN;\n\n\ttrl_ctl_val = ctl_val_reg[1] << 24;\n\ttrl_ctl_val |= ctl_val_reg[2] << 16;\n\ttrl_ctl_val |= ctl_val_reg[3] << 8;\n\ttrl_ctl_val |= ctl_val_reg[4];\n\n\ttrcg_nominal_rate = nominal_rate_reg[1] << 24;\n\ttrcg_nominal_rate |= nominal_rate_reg[2] << 16;\n\ttrcg_nominal_rate |= nominal_rate_reg[3] << 8;\n\ttrcg_nominal_rate |= nominal_rate_reg[4];\n\n\ttrl_ctl_val >>= 1;\n\ttrcg_nominal_rate >>= 1;\n\n\tif (diff_upper == 1)\n\t\tnum =\n\t\t    (int)((trl_ctl_val + 0x80000000u) -\n\t\t\t  trcg_nominal_rate);\n\telse if (diff_upper == -1)\n\t\tnum =\n\t\t    -(int)((trcg_nominal_rate + 0x80000000u) -\n\t\t\t   trl_ctl_val);\n\telse\n\t\tnum = (int)(trl_ctl_val - trcg_nominal_rate);\n\n\tden = (nominal_rate_reg[0] & 0x7f) << 24;\n\tden |= nominal_rate_reg[1] << 16;\n\tden |= nominal_rate_reg[2] << 8;\n\tden |= nominal_rate_reg[3];\n\tden = (den + (390625 / 2)) / 390625;\n\n\tden >>= 1;\n\n\tif (num >= 0)\n\t\t*ppm = (num + (den / 2)) / den;\n\telse\n\t\t*ppm = (num - (den / 2)) / den;\n\n\treturn 0;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_sampling_offset_sub(struct\n\t\t\t\t\t\t cxd2880_tnrdmd\n\t\t\t\t\t\t *tnr_dmd,\n\t\t\t\t\t\t int *ppm)\n{\n\tif (!tnr_dmd || !ppm)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\treturn cxd2880_tnrdmd_dvbt2_mon_sampling_offset(tnr_dmd->diver_sub,\n\t\t\t\t\t\t\tppm);\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_qam(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t\t enum cxd2880_dvbt2_plp_btype type,\n\t\t\t\t enum cxd2880_dvbt2_plp_constell *qam)\n{\n\tu8 data;\n\tu8 l1_post_ok = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !qam)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x86, &l1_post_ok, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (!(l1_post_ok & 0x01)) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tif (type == CXD2880_DVBT2_PLP_COMMON) {\n\t\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0xb6, &data, 1);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (data == 0) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0xb1, &data, 1);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0x9e, &data, 1);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\t*qam = (enum cxd2880_dvbt2_plp_constell)(data & 0x07);\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_code_rate(struct cxd2880_tnrdmd\n\t\t\t\t       *tnr_dmd,\n\t\t\t\t       enum cxd2880_dvbt2_plp_btype\n\t\t\t\t       type,\n\t\t\t\t       enum\n\t\t\t\t       cxd2880_dvbt2_plp_code_rate\n\t\t\t\t       *code_rate)\n{\n\tu8 data;\n\tu8 l1_post_ok = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !code_rate)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = slvt_freeze_reg(tnr_dmd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x86, &l1_post_ok, 1);\n\tif (ret) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn ret;\n\t}\n\n\tif (!(l1_post_ok & 0x01)) {\n\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\treturn -EAGAIN;\n\t}\n\n\tif (type == CXD2880_DVBT2_PLP_COMMON) {\n\t\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0xb6, &data, 1);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (data == 0) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0xb0, &data, 1);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t\t     0x9d, &data, 1);\n\t\tif (ret) {\n\t\t\tslvt_unfreeze_reg(tnr_dmd);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tslvt_unfreeze_reg(tnr_dmd);\n\n\t*code_rate = (enum cxd2880_dvbt2_plp_code_rate)(data & 0x07);\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_profile(struct cxd2880_tnrdmd\n\t\t\t\t     *tnr_dmd,\n\t\t\t\t     enum cxd2880_dvbt2_profile\n\t\t\t\t     *profile)\n{\n\tu8 data;\n\tint ret;\n\n\tif (!tnr_dmd || !profile)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = tnr_dmd->io->write_reg(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x00, 0x0b);\n\tif (ret)\n\t\treturn ret;\n\n\tret = tnr_dmd->io->read_regs(tnr_dmd->io,\n\t\t\t\t     CXD2880_IO_TGT_DMD,\n\t\t\t\t     0x22, &data, sizeof(data));\n\tif (ret)\n\t\treturn ret;\n\n\tif (data & 0x02) {\n\t\tif (data & 0x01)\n\t\t\t*profile = CXD2880_DVBT2_PROFILE_LITE;\n\t\telse\n\t\t\t*profile = CXD2880_DVBT2_PROFILE_BASE;\n\t} else {\n\t\tret = -EAGAIN;\n\t\tif (tnr_dmd->diver_mode ==\n\t\t    CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\t\tret =\n\t\t\t    cxd2880_tnrdmd_dvbt2_mon_profile(tnr_dmd->diver_sub,\n\t\t\t\t\t\t\t     profile);\n\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int dvbt2_calc_ssi(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t  int rf_lvl, u8 *ssi)\n{\n\tenum cxd2880_dvbt2_plp_constell qam;\n\tenum cxd2880_dvbt2_plp_code_rate code_rate;\n\tint prel;\n\tint temp_ssi = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !ssi)\n\t\treturn -EINVAL;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_qam(tnr_dmd, CXD2880_DVBT2_PLP_DATA, &qam);\n\tif (ret)\n\t\treturn ret;\n\n\tret =\n\t    cxd2880_tnrdmd_dvbt2_mon_code_rate(tnr_dmd, CXD2880_DVBT2_PLP_DATA,\n\t\t\t\t\t       &code_rate);\n\tif (ret)\n\t\treturn ret;\n\n\tif (code_rate > CXD2880_DVBT2_R2_5 || qam > CXD2880_DVBT2_QAM256)\n\t\treturn -EINVAL;\n\n\tprel = rf_lvl - ref_dbm_1000[qam][code_rate];\n\n\tif (prel < -15000)\n\t\ttemp_ssi = 0;\n\telse if (prel < 0)\n\t\ttemp_ssi = ((2 * (prel + 15000)) + 1500) / 3000;\n\telse if (prel < 20000)\n\t\ttemp_ssi = (((4 * prel) + 500) / 1000) + 10;\n\telse if (prel < 35000)\n\t\ttemp_ssi = (((2 * (prel - 20000)) + 1500) / 3000) + 90;\n\telse\n\t\ttemp_ssi = 100;\n\n\t*ssi = (temp_ssi > 100) ? 100 : (u8)temp_ssi;\n\n\treturn ret;\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_ssi(struct cxd2880_tnrdmd *tnr_dmd,\n\t\t\t\t u8 *ssi)\n{\n\tint rf_lvl = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !ssi)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode == CXD2880_TNRDMD_DIVERMODE_SUB)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = cxd2880_tnrdmd_mon_rf_lvl(tnr_dmd, &rf_lvl);\n\tif (ret)\n\t\treturn ret;\n\n\treturn dvbt2_calc_ssi(tnr_dmd, rf_lvl, ssi);\n}\n\nint cxd2880_tnrdmd_dvbt2_mon_ssi_sub(struct cxd2880_tnrdmd\n\t\t\t\t     *tnr_dmd, u8 *ssi)\n{\n\tint rf_lvl = 0;\n\tint ret;\n\n\tif (!tnr_dmd || !ssi)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->diver_mode != CXD2880_TNRDMD_DIVERMODE_MAIN)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->state != CXD2880_TNRDMD_STATE_ACTIVE)\n\t\treturn -EINVAL;\n\n\tif (tnr_dmd->sys != CXD2880_DTV_SYS_DVBT2)\n\t\treturn -EINVAL;\n\n\tret = cxd2880_tnrdmd_mon_rf_lvl(tnr_dmd->diver_sub, &rf_lvl);\n\tif (ret)\n\t\treturn ret;\n\n\treturn dvbt2_calc_ssi(tnr_dmd, rf_lvl, ssi);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}