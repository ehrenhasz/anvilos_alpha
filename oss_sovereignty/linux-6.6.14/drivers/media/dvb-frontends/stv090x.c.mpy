{
  "module_name": "stv090x.c",
  "hash_id": "c9057a95fdb00a2e3000a366ece59e6fedc4efb098d9c46ef0f81bcc9d5619f9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/dvb-frontends/stv090x.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/string.h>\n#include <linux/slab.h>\n#include <linux/mutex.h>\n\n#include <linux/dvb/frontend.h>\n#include <media/dvb_frontend.h>\n\n#include \"stv6110x.h\"  \n\n#include \"stv090x_reg.h\"\n#include \"stv090x.h\"\n#include \"stv090x_priv.h\"\n\n \n#define MAX_XFER_SIZE  64\n\nstatic unsigned int verbose;\nmodule_param(verbose, int, 0644);\n\n \nstruct stv090x_dev {\n\t \n\tstruct stv090x_internal\t\t*internal;\n\tstruct stv090x_dev\t\t*next_dev;\n};\n\n \nstatic struct stv090x_dev *stv090x_first_dev;\n\n \nstatic struct stv090x_dev *find_dev(struct i2c_adapter *i2c_adap,\n\t\t\t\t\tu8 i2c_addr)\n{\n\tstruct stv090x_dev *temp_dev = stv090x_first_dev;\n\n\t \n\twhile ((temp_dev != NULL) &&\n\t\t((temp_dev->internal->i2c_adap != i2c_adap) ||\n\t\t(temp_dev->internal->i2c_addr != i2c_addr))) {\n\n\t\ttemp_dev = temp_dev->next_dev;\n\t}\n\n\treturn temp_dev;\n}\n\n \nstatic void remove_dev(struct stv090x_internal *internal)\n{\n\tstruct stv090x_dev *prev_dev = stv090x_first_dev;\n\tstruct stv090x_dev *del_dev = find_dev(internal->i2c_adap,\n\t\t\t\t\t\tinternal->i2c_addr);\n\n\tif (del_dev != NULL) {\n\t\tif (del_dev == stv090x_first_dev) {\n\t\t\tstv090x_first_dev = del_dev->next_dev;\n\t\t} else {\n\t\t\twhile (prev_dev->next_dev != del_dev)\n\t\t\t\tprev_dev = prev_dev->next_dev;\n\n\t\t\tprev_dev->next_dev = del_dev->next_dev;\n\t\t}\n\n\t\tkfree(del_dev);\n\t}\n}\n\n \nstatic struct stv090x_dev *append_internal(struct stv090x_internal *internal)\n{\n\tstruct stv090x_dev *new_dev;\n\tstruct stv090x_dev *temp_dev;\n\n\tnew_dev = kmalloc(sizeof(struct stv090x_dev), GFP_KERNEL);\n\tif (new_dev != NULL) {\n\t\tnew_dev->internal = internal;\n\t\tnew_dev->next_dev = NULL;\n\n\t\t \n\t\tif (stv090x_first_dev == NULL) {\n\t\t\tstv090x_first_dev = new_dev;\n\t\t} else {\n\t\t\ttemp_dev = stv090x_first_dev;\n\t\t\twhile (temp_dev->next_dev != NULL)\n\t\t\t\ttemp_dev = temp_dev->next_dev;\n\n\t\t\ttemp_dev->next_dev = new_dev;\n\t\t}\n\t}\n\n\treturn new_dev;\n}\n\n\n \nstatic const struct stv090x_tab stv090x_s1cn_tab[] = {\n\t{   0, 8917 },  \n\t{   5, 8801 },  \n\t{  10, 8667 },  \n\t{  15, 8522 },  \n\t{  20, 8355 },  \n\t{  25, 8175 },  \n\t{  30, 7979 },  \n\t{  35, 7763 },  \n\t{  40, 7530 },  \n\t{  45, 7282 },  \n\t{  50, 7026 },  \n\t{  55, 6781 },  \n\t{  60, 6514 },  \n\t{  65, 6241 },  \n\t{  70, 5965 },  \n\t{  75, 5690 },  \n\t{  80, 5424 },  \n\t{  85, 5161 },  \n\t{  90, 4902 },  \n\t{  95, 4654 },  \n\t{ 100, 4417 },  \n\t{ 105, 4186 },  \n\t{ 110, 3968 },  \n\t{ 115, 3757 },  \n\t{ 120, 3558 },  \n\t{ 125, 3366 },  \n\t{ 130, 3185 },  \n\t{ 135, 3012 },  \n\t{ 140, 2850 },  \n\t{ 145, 2698 },  \n\t{ 150, 2550 },  \n\t{ 160, 2283 },  \n\t{ 170, 2042 },  \n\t{ 180, 1827 },  \n\t{ 190, 1636 },  \n\t{ 200, 1466 },  \n\t{ 210, 1315 },  \n\t{ 220, 1181 },  \n\t{ 230, 1064 },  \n\t{ 240,\t960 },  \n\t{ 250,\t869 },  \n\t{ 260,\t792 },  \n\t{ 270,\t724 },  \n\t{ 280,\t665 },  \n\t{ 290,\t616 },  \n\t{ 300,\t573 },  \n\t{ 310,\t537 },  \n\t{ 320,\t507 },  \n\t{ 330,\t483 },  \n\t{ 400,\t398 },  \n\t{ 450,\t381 },  \n\t{ 500,\t377 }   \n};\n\n \nstatic const struct stv090x_tab stv090x_s2cn_tab[] = {\n\t{ -30, 13348 },  \n\t{ -20, 12640 },  \n\t{ -10, 11883 },  \n\t{   0, 11101 },  \n\t{   5, 10718 },  \n\t{  10, 10339 },  \n\t{  15,  9947 },  \n\t{  20,  9552 },  \n\t{  25,  9183 },  \n\t{  30,  8799 },  \n\t{  35,  8422 },  \n\t{  40,  8062 },  \n\t{  45,  7707 },  \n\t{  50,  7353 },  \n\t{  55,  7025 },  \n\t{  60,  6684 },  \n\t{  65,  6331 },  \n\t{  70,  6036 },  \n\t{  75,  5727 },  \n\t{  80,  5437 },  \n\t{  85,  5164 },  \n\t{  90,  4902 },  \n\t{  95,  4653 },  \n\t{ 100,  4408 },  \n\t{ 105,  4187 },  \n\t{ 110,  3961 },  \n\t{ 115,  3751 },  \n\t{ 120,  3558 },  \n\t{ 125,  3368 },  \n\t{ 130,  3191 },  \n\t{ 135,  3017 },  \n\t{ 140,  2862 },  \n\t{ 145,  2710 },  \n\t{ 150,  2565 },  \n\t{ 160,  2300 },  \n\t{ 170,  2058 },  \n\t{ 180,  1849 },  \n\t{ 190,  1663 },  \n\t{ 200,  1495 },  \n\t{ 210,  1349 },  \n\t{ 220,  1222 },  \n\t{ 230,  1110 },  \n\t{ 240,  1011 },  \n\t{ 250,   925 },  \n\t{ 260,   853 },  \n\t{ 270,   789 },  \n\t{ 280,   734 },  \n\t{ 290,   690 },  \n\t{ 300,   650 },  \n\t{ 310,   619 },  \n\t{ 320,   593 },  \n\t{ 330,   571 },  \n\t{ 400,   498 },  \n\t{ 450,\t 484 },  \n\t{ 500,\t 481 }\t \n};\n\n \nstatic const struct stv090x_tab stv090x_rf_tab[] = {\n\t{  -5, 0xcaa1 },  \n\t{ -10, 0xc229 },  \n\t{ -15, 0xbb08 },  \n\t{ -20, 0xb4bc },  \n\t{ -25, 0xad5a },  \n\t{ -30, 0xa298 },  \n\t{ -35, 0x98a8 },  \n\t{ -40, 0x8389 },  \n\t{ -45, 0x59be },  \n\t{ -50, 0x3a14 },  \n\t{ -55, 0x2d11 },  \n\t{ -60, 0x210d },  \n\t{ -65, 0xa14f },  \n\t{ -70, 0x07aa }\t  \n};\n\n\nstatic struct stv090x_reg stv0900_initval[] = {\n\n\t{ STV090x_OUTCFG,\t\t0x00 },\n\t{ STV090x_MODECFG,\t\t0xff },\n\t{ STV090x_AGCRF1CFG,\t\t0x11 },\n\t{ STV090x_AGCRF2CFG,\t\t0x13 },\n\t{ STV090x_TSGENERAL1X,\t\t0x14 },\n\t{ STV090x_TSTTNR2,\t\t0x21 },\n\t{ STV090x_TSTTNR4,\t\t0x21 },\n\t{ STV090x_P2_DISTXCTL,\t\t0x22 },\n\t{ STV090x_P2_F22TX,\t\t0xc0 },\n\t{ STV090x_P2_F22RX,\t\t0xc0 },\n\t{ STV090x_P2_DISRXCTL,\t\t0x00 },\n\t{ STV090x_P2_DMDCFGMD,\t\t0xF9 },\n\t{ STV090x_P2_DEMOD,\t\t0x08 },\n\t{ STV090x_P2_DMDCFG3,\t\t0xc4 },\n\t{ STV090x_P2_CARFREQ,\t\t0xed },\n\t{ STV090x_P2_LDT,\t\t0xd0 },\n\t{ STV090x_P2_LDT2,\t\t0xb8 },\n\t{ STV090x_P2_TMGCFG,\t\t0xd2 },\n\t{ STV090x_P2_TMGTHRISE,\t\t0x20 },\n\t{ STV090x_P1_TMGCFG,\t\t0xd2 },\n\n\t{ STV090x_P2_TMGTHFALL,\t\t0x00 },\n\t{ STV090x_P2_FECSPY,\t\t0x88 },\n\t{ STV090x_P2_FSPYDATA,\t\t0x3a },\n\t{ STV090x_P2_FBERCPT4,\t\t0x00 },\n\t{ STV090x_P2_FSPYBER,\t\t0x10 },\n\t{ STV090x_P2_ERRCTRL1,\t\t0x35 },\n\t{ STV090x_P2_ERRCTRL2,\t\t0xc1 },\n\t{ STV090x_P2_CFRICFG,\t\t0xf8 },\n\t{ STV090x_P2_NOSCFG,\t\t0x1c },\n\t{ STV090x_P2_DMDTOM,\t\t0x20 },\n\t{ STV090x_P2_CORRELMANT,\t0x70 },\n\t{ STV090x_P2_CORRELABS,\t\t0x88 },\n\t{ STV090x_P2_AGC2O,\t\t0x5b },\n\t{ STV090x_P2_AGC2REF,\t\t0x38 },\n\t{ STV090x_P2_CARCFG,\t\t0xe4 },\n\t{ STV090x_P2_ACLC,\t\t0x1A },\n\t{ STV090x_P2_BCLC,\t\t0x09 },\n\t{ STV090x_P2_CARHDR,\t\t0x08 },\n\t{ STV090x_P2_KREFTMG,\t\t0xc1 },\n\t{ STV090x_P2_SFRUPRATIO,\t0xf0 },\n\t{ STV090x_P2_SFRLOWRATIO,\t0x70 },\n\t{ STV090x_P2_SFRSTEP,\t\t0x58 },\n\t{ STV090x_P2_TMGCFG2,\t\t0x01 },\n\t{ STV090x_P2_CAR2CFG,\t\t0x26 },\n\t{ STV090x_P2_BCLC2S2Q,\t\t0x86 },\n\t{ STV090x_P2_BCLC2S28,\t\t0x86 },\n\t{ STV090x_P2_SMAPCOEF7,\t\t0x77 },\n\t{ STV090x_P2_SMAPCOEF6,\t\t0x85 },\n\t{ STV090x_P2_SMAPCOEF5,\t\t0x77 },\n\t{ STV090x_P2_TSCFGL,\t\t0x20 },\n\t{ STV090x_P2_DMDCFG2,\t\t0x3b },\n\t{ STV090x_P2_MODCODLST0,\t0xff },\n\t{ STV090x_P2_MODCODLST1,\t0xff },\n\t{ STV090x_P2_MODCODLST2,\t0xff },\n\t{ STV090x_P2_MODCODLST3,\t0xff },\n\t{ STV090x_P2_MODCODLST4,\t0xff },\n\t{ STV090x_P2_MODCODLST5,\t0xff },\n\t{ STV090x_P2_MODCODLST6,\t0xff },\n\t{ STV090x_P2_MODCODLST7,\t0xcc },\n\t{ STV090x_P2_MODCODLST8,\t0xcc },\n\t{ STV090x_P2_MODCODLST9,\t0xcc },\n\t{ STV090x_P2_MODCODLSTA,\t0xcc },\n\t{ STV090x_P2_MODCODLSTB,\t0xcc },\n\t{ STV090x_P2_MODCODLSTC,\t0xcc },\n\t{ STV090x_P2_MODCODLSTD,\t0xcc },\n\t{ STV090x_P2_MODCODLSTE,\t0xcc },\n\t{ STV090x_P2_MODCODLSTF,\t0xcf },\n\t{ STV090x_P1_DISTXCTL,\t\t0x22 },\n\t{ STV090x_P1_F22TX,\t\t0xc0 },\n\t{ STV090x_P1_F22RX,\t\t0xc0 },\n\t{ STV090x_P1_DISRXCTL,\t\t0x00 },\n\t{ STV090x_P1_DMDCFGMD,\t\t0xf9 },\n\t{ STV090x_P1_DEMOD,\t\t0x08 },\n\t{ STV090x_P1_DMDCFG3,\t\t0xc4 },\n\t{ STV090x_P1_DMDTOM,\t\t0x20 },\n\t{ STV090x_P1_CARFREQ,\t\t0xed },\n\t{ STV090x_P1_LDT,\t\t0xd0 },\n\t{ STV090x_P1_LDT2,\t\t0xb8 },\n\t{ STV090x_P1_TMGCFG,\t\t0xd2 },\n\t{ STV090x_P1_TMGTHRISE,\t\t0x20 },\n\t{ STV090x_P1_TMGTHFALL,\t\t0x00 },\n\t{ STV090x_P1_SFRUPRATIO,\t0xf0 },\n\t{ STV090x_P1_SFRLOWRATIO,\t0x70 },\n\t{ STV090x_P1_TSCFGL,\t\t0x20 },\n\t{ STV090x_P1_FECSPY,\t\t0x88 },\n\t{ STV090x_P1_FSPYDATA,\t\t0x3a },\n\t{ STV090x_P1_FBERCPT4,\t\t0x00 },\n\t{ STV090x_P1_FSPYBER,\t\t0x10 },\n\t{ STV090x_P1_ERRCTRL1,\t\t0x35 },\n\t{ STV090x_P1_ERRCTRL2,\t\t0xc1 },\n\t{ STV090x_P1_CFRICFG,\t\t0xf8 },\n\t{ STV090x_P1_NOSCFG,\t\t0x1c },\n\t{ STV090x_P1_CORRELMANT,\t0x70 },\n\t{ STV090x_P1_CORRELABS,\t\t0x88 },\n\t{ STV090x_P1_AGC2O,\t\t0x5b },\n\t{ STV090x_P1_AGC2REF,\t\t0x38 },\n\t{ STV090x_P1_CARCFG,\t\t0xe4 },\n\t{ STV090x_P1_ACLC,\t\t0x1A },\n\t{ STV090x_P1_BCLC,\t\t0x09 },\n\t{ STV090x_P1_CARHDR,\t\t0x08 },\n\t{ STV090x_P1_KREFTMG,\t\t0xc1 },\n\t{ STV090x_P1_SFRSTEP,\t\t0x58 },\n\t{ STV090x_P1_TMGCFG2,\t\t0x01 },\n\t{ STV090x_P1_CAR2CFG,\t\t0x26 },\n\t{ STV090x_P1_BCLC2S2Q,\t\t0x86 },\n\t{ STV090x_P1_BCLC2S28,\t\t0x86 },\n\t{ STV090x_P1_SMAPCOEF7,\t\t0x77 },\n\t{ STV090x_P1_SMAPCOEF6,\t\t0x85 },\n\t{ STV090x_P1_SMAPCOEF5,\t\t0x77 },\n\t{ STV090x_P1_DMDCFG2,\t\t0x3b },\n\t{ STV090x_P1_MODCODLST0,\t0xff },\n\t{ STV090x_P1_MODCODLST1,\t0xff },\n\t{ STV090x_P1_MODCODLST2,\t0xff },\n\t{ STV090x_P1_MODCODLST3,\t0xff },\n\t{ STV090x_P1_MODCODLST4,\t0xff },\n\t{ STV090x_P1_MODCODLST5,\t0xff },\n\t{ STV090x_P1_MODCODLST6,\t0xff },\n\t{ STV090x_P1_MODCODLST7,\t0xcc },\n\t{ STV090x_P1_MODCODLST8,\t0xcc },\n\t{ STV090x_P1_MODCODLST9,\t0xcc },\n\t{ STV090x_P1_MODCODLSTA,\t0xcc },\n\t{ STV090x_P1_MODCODLSTB,\t0xcc },\n\t{ STV090x_P1_MODCODLSTC,\t0xcc },\n\t{ STV090x_P1_MODCODLSTD,\t0xcc },\n\t{ STV090x_P1_MODCODLSTE,\t0xcc },\n\t{ STV090x_P1_MODCODLSTF,\t0xcf },\n\t{ STV090x_GENCFG,\t\t0x1d },\n\t{ STV090x_NBITER_NF4,\t\t0x37 },\n\t{ STV090x_NBITER_NF5,\t\t0x29 },\n\t{ STV090x_NBITER_NF6,\t\t0x37 },\n\t{ STV090x_NBITER_NF7,\t\t0x33 },\n\t{ STV090x_NBITER_NF8,\t\t0x31 },\n\t{ STV090x_NBITER_NF9,\t\t0x2f },\n\t{ STV090x_NBITER_NF10,\t\t0x39 },\n\t{ STV090x_NBITER_NF11,\t\t0x3a },\n\t{ STV090x_NBITER_NF12,\t\t0x29 },\n\t{ STV090x_NBITER_NF13,\t\t0x37 },\n\t{ STV090x_NBITER_NF14,\t\t0x33 },\n\t{ STV090x_NBITER_NF15,\t\t0x2f },\n\t{ STV090x_NBITER_NF16,\t\t0x39 },\n\t{ STV090x_NBITER_NF17,\t\t0x3a },\n\t{ STV090x_NBITERNOERR,\t\t0x04 },\n\t{ STV090x_GAINLLR_NF4,\t\t0x0C },\n\t{ STV090x_GAINLLR_NF5,\t\t0x0F },\n\t{ STV090x_GAINLLR_NF6,\t\t0x11 },\n\t{ STV090x_GAINLLR_NF7,\t\t0x14 },\n\t{ STV090x_GAINLLR_NF8,\t\t0x17 },\n\t{ STV090x_GAINLLR_NF9,\t\t0x19 },\n\t{ STV090x_GAINLLR_NF10,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF11,\t\t0x21 },\n\t{ STV090x_GAINLLR_NF12,\t\t0x0D },\n\t{ STV090x_GAINLLR_NF13,\t\t0x0F },\n\t{ STV090x_GAINLLR_NF14,\t\t0x13 },\n\t{ STV090x_GAINLLR_NF15,\t\t0x1A },\n\t{ STV090x_GAINLLR_NF16,\t\t0x1F },\n\t{ STV090x_GAINLLR_NF17,\t\t0x21 },\n\t{ STV090x_RCCFGH,\t\t0x20 },\n\t{ STV090x_P1_FECM,\t\t0x01 },  \n\t{ STV090x_P2_FECM,\t\t0x01 },  \n\t{ STV090x_P1_PRVIT,\t\t0x2F },  \n\t{ STV090x_P2_PRVIT,\t\t0x2F },  \n};\n\nstatic struct stv090x_reg stv0903_initval[] = {\n\t{ STV090x_OUTCFG,\t\t0x00 },\n\t{ STV090x_AGCRF1CFG,\t\t0x11 },\n\t{ STV090x_STOPCLK1,\t\t0x48 },\n\t{ STV090x_STOPCLK2,\t\t0x14 },\n\t{ STV090x_TSTTNR1,\t\t0x27 },\n\t{ STV090x_TSTTNR2,\t\t0x21 },\n\t{ STV090x_P1_DISTXCTL,\t\t0x22 },\n\t{ STV090x_P1_F22TX,\t\t0xc0 },\n\t{ STV090x_P1_F22RX,\t\t0xc0 },\n\t{ STV090x_P1_DISRXCTL,\t\t0x00 },\n\t{ STV090x_P1_DMDCFGMD,\t\t0xF9 },\n\t{ STV090x_P1_DEMOD,\t\t0x08 },\n\t{ STV090x_P1_DMDCFG3,\t\t0xc4 },\n\t{ STV090x_P1_CARFREQ,\t\t0xed },\n\t{ STV090x_P1_TNRCFG2,\t\t0x82 },\n\t{ STV090x_P1_LDT,\t\t0xd0 },\n\t{ STV090x_P1_LDT2,\t\t0xb8 },\n\t{ STV090x_P1_TMGCFG,\t\t0xd2 },\n\t{ STV090x_P1_TMGTHRISE,\t\t0x20 },\n\t{ STV090x_P1_TMGTHFALL,\t\t0x00 },\n\t{ STV090x_P1_SFRUPRATIO,\t0xf0 },\n\t{ STV090x_P1_SFRLOWRATIO,\t0x70 },\n\t{ STV090x_P1_TSCFGL,\t\t0x20 },\n\t{ STV090x_P1_FECSPY,\t\t0x88 },\n\t{ STV090x_P1_FSPYDATA,\t\t0x3a },\n\t{ STV090x_P1_FBERCPT4,\t\t0x00 },\n\t{ STV090x_P1_FSPYBER,\t\t0x10 },\n\t{ STV090x_P1_ERRCTRL1,\t\t0x35 },\n\t{ STV090x_P1_ERRCTRL2,\t\t0xc1 },\n\t{ STV090x_P1_CFRICFG,\t\t0xf8 },\n\t{ STV090x_P1_NOSCFG,\t\t0x1c },\n\t{ STV090x_P1_DMDTOM,\t\t0x20 },\n\t{ STV090x_P1_CORRELMANT,\t0x70 },\n\t{ STV090x_P1_CORRELABS,\t\t0x88 },\n\t{ STV090x_P1_AGC2O,\t\t0x5b },\n\t{ STV090x_P1_AGC2REF,\t\t0x38 },\n\t{ STV090x_P1_CARCFG,\t\t0xe4 },\n\t{ STV090x_P1_ACLC,\t\t0x1A },\n\t{ STV090x_P1_BCLC,\t\t0x09 },\n\t{ STV090x_P1_CARHDR,\t\t0x08 },\n\t{ STV090x_P1_KREFTMG,\t\t0xc1 },\n\t{ STV090x_P1_SFRSTEP,\t\t0x58 },\n\t{ STV090x_P1_TMGCFG2,\t\t0x01 },\n\t{ STV090x_P1_CAR2CFG,\t\t0x26 },\n\t{ STV090x_P1_BCLC2S2Q,\t\t0x86 },\n\t{ STV090x_P1_BCLC2S28,\t\t0x86 },\n\t{ STV090x_P1_SMAPCOEF7,\t\t0x77 },\n\t{ STV090x_P1_SMAPCOEF6,\t\t0x85 },\n\t{ STV090x_P1_SMAPCOEF5,\t\t0x77 },\n\t{ STV090x_P1_DMDCFG2,\t\t0x3b },\n\t{ STV090x_P1_MODCODLST0,\t0xff },\n\t{ STV090x_P1_MODCODLST1,\t0xff },\n\t{ STV090x_P1_MODCODLST2,\t0xff },\n\t{ STV090x_P1_MODCODLST3,\t0xff },\n\t{ STV090x_P1_MODCODLST4,\t0xff },\n\t{ STV090x_P1_MODCODLST5,\t0xff },\n\t{ STV090x_P1_MODCODLST6,\t0xff },\n\t{ STV090x_P1_MODCODLST7,\t0xcc },\n\t{ STV090x_P1_MODCODLST8,\t0xcc },\n\t{ STV090x_P1_MODCODLST9,\t0xcc },\n\t{ STV090x_P1_MODCODLSTA,\t0xcc },\n\t{ STV090x_P1_MODCODLSTB,\t0xcc },\n\t{ STV090x_P1_MODCODLSTC,\t0xcc },\n\t{ STV090x_P1_MODCODLSTD,\t0xcc },\n\t{ STV090x_P1_MODCODLSTE,\t0xcc },\n\t{ STV090x_P1_MODCODLSTF,\t0xcf },\n\t{ STV090x_GENCFG,\t\t0x1c },\n\t{ STV090x_NBITER_NF4,\t\t0x37 },\n\t{ STV090x_NBITER_NF5,\t\t0x29 },\n\t{ STV090x_NBITER_NF6,\t\t0x37 },\n\t{ STV090x_NBITER_NF7,\t\t0x33 },\n\t{ STV090x_NBITER_NF8,\t\t0x31 },\n\t{ STV090x_NBITER_NF9,\t\t0x2f },\n\t{ STV090x_NBITER_NF10,\t\t0x39 },\n\t{ STV090x_NBITER_NF11,\t\t0x3a },\n\t{ STV090x_NBITER_NF12,\t\t0x29 },\n\t{ STV090x_NBITER_NF13,\t\t0x37 },\n\t{ STV090x_NBITER_NF14,\t\t0x33 },\n\t{ STV090x_NBITER_NF15,\t\t0x2f },\n\t{ STV090x_NBITER_NF16,\t\t0x39 },\n\t{ STV090x_NBITER_NF17,\t\t0x3a },\n\t{ STV090x_NBITERNOERR,\t\t0x04 },\n\t{ STV090x_GAINLLR_NF4,\t\t0x0C },\n\t{ STV090x_GAINLLR_NF5,\t\t0x0F },\n\t{ STV090x_GAINLLR_NF6,\t\t0x11 },\n\t{ STV090x_GAINLLR_NF7,\t\t0x14 },\n\t{ STV090x_GAINLLR_NF8,\t\t0x17 },\n\t{ STV090x_GAINLLR_NF9,\t\t0x19 },\n\t{ STV090x_GAINLLR_NF10,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF11,\t\t0x21 },\n\t{ STV090x_GAINLLR_NF12,\t\t0x0D },\n\t{ STV090x_GAINLLR_NF13,\t\t0x0F },\n\t{ STV090x_GAINLLR_NF14,\t\t0x13 },\n\t{ STV090x_GAINLLR_NF15,\t\t0x1A },\n\t{ STV090x_GAINLLR_NF16,\t\t0x1F },\n\t{ STV090x_GAINLLR_NF17,\t\t0x21 },\n\t{ STV090x_RCCFGH,\t\t0x20 },\n\t{ STV090x_P1_FECM,\t\t0x01 },  \n\t{ STV090x_P1_PRVIT,\t\t0x2f }   \n};\n\nstatic struct stv090x_reg stv0900_cut20_val[] = {\n\n\t{ STV090x_P2_DMDCFG3,\t\t0xe8 },\n\t{ STV090x_P2_DMDCFG4,\t\t0x10 },\n\t{ STV090x_P2_CARFREQ,\t\t0x38 },\n\t{ STV090x_P2_CARHDR,\t\t0x20 },\n\t{ STV090x_P2_KREFTMG,\t\t0x5a },\n\t{ STV090x_P2_SMAPCOEF7,\t\t0x06 },\n\t{ STV090x_P2_SMAPCOEF6,\t\t0x00 },\n\t{ STV090x_P2_SMAPCOEF5,\t\t0x04 },\n\t{ STV090x_P2_NOSCFG,\t\t0x0c },\n\t{ STV090x_P1_DMDCFG3,\t\t0xe8 },\n\t{ STV090x_P1_DMDCFG4,\t\t0x10 },\n\t{ STV090x_P1_CARFREQ,\t\t0x38 },\n\t{ STV090x_P1_CARHDR,\t\t0x20 },\n\t{ STV090x_P1_KREFTMG,\t\t0x5a },\n\t{ STV090x_P1_SMAPCOEF7,\t\t0x06 },\n\t{ STV090x_P1_SMAPCOEF6,\t\t0x00 },\n\t{ STV090x_P1_SMAPCOEF5,\t\t0x04 },\n\t{ STV090x_P1_NOSCFG,\t\t0x0c },\n\t{ STV090x_GAINLLR_NF4,\t\t0x21 },\n\t{ STV090x_GAINLLR_NF5,\t\t0x21 },\n\t{ STV090x_GAINLLR_NF6,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF7,\t\t0x1F },\n\t{ STV090x_GAINLLR_NF8,\t\t0x1E },\n\t{ STV090x_GAINLLR_NF9,\t\t0x1E },\n\t{ STV090x_GAINLLR_NF10,\t\t0x1D },\n\t{ STV090x_GAINLLR_NF11,\t\t0x1B },\n\t{ STV090x_GAINLLR_NF12,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF13,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF14,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF15,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF16,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF17,\t\t0x21 },\n};\n\nstatic struct stv090x_reg stv0903_cut20_val[] = {\n\t{ STV090x_P1_DMDCFG3,\t\t0xe8 },\n\t{ STV090x_P1_DMDCFG4,\t\t0x10 },\n\t{ STV090x_P1_CARFREQ,\t\t0x38 },\n\t{ STV090x_P1_CARHDR,\t\t0x20 },\n\t{ STV090x_P1_KREFTMG,\t\t0x5a },\n\t{ STV090x_P1_SMAPCOEF7,\t\t0x06 },\n\t{ STV090x_P1_SMAPCOEF6,\t\t0x00 },\n\t{ STV090x_P1_SMAPCOEF5,\t\t0x04 },\n\t{ STV090x_P1_NOSCFG,\t\t0x0c },\n\t{ STV090x_GAINLLR_NF4,\t\t0x21 },\n\t{ STV090x_GAINLLR_NF5,\t\t0x21 },\n\t{ STV090x_GAINLLR_NF6,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF7,\t\t0x1F },\n\t{ STV090x_GAINLLR_NF8,\t\t0x1E },\n\t{ STV090x_GAINLLR_NF9,\t\t0x1E },\n\t{ STV090x_GAINLLR_NF10,\t\t0x1D },\n\t{ STV090x_GAINLLR_NF11,\t\t0x1B },\n\t{ STV090x_GAINLLR_NF12,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF13,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF14,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF15,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF16,\t\t0x20 },\n\t{ STV090x_GAINLLR_NF17,\t\t0x21 }\n};\n\n \nstatic struct stv090x_long_frame_crloop stv090x_s2_crl_cut20[] = {\n\t \n\t{ STV090x_QPSK_12,  0x1f, 0x3f, 0x1e, 0x3f, 0x3d, 0x1f, 0x3d, 0x3e, 0x3d, 0x1e },\n\t{ STV090x_QPSK_35,  0x2f, 0x3f, 0x2e, 0x2f, 0x3d, 0x0f, 0x0e, 0x2e, 0x3d, 0x0e },\n\t{ STV090x_QPSK_23,  0x2f, 0x3f, 0x2e, 0x2f, 0x0e, 0x0f, 0x0e, 0x1e, 0x3d, 0x3d },\n\t{ STV090x_QPSK_34,  0x3f, 0x3f, 0x3e, 0x1f, 0x0e, 0x3e, 0x0e, 0x1e, 0x3d, 0x3d },\n\t{ STV090x_QPSK_45,  0x3f, 0x3f, 0x3e, 0x1f, 0x0e, 0x3e, 0x0e, 0x1e, 0x3d, 0x3d },\n\t{ STV090x_QPSK_56,  0x3f, 0x3f, 0x3e, 0x1f, 0x0e, 0x3e, 0x0e, 0x1e, 0x3d, 0x3d },\n\t{ STV090x_QPSK_89,  0x3f, 0x3f, 0x3e, 0x1f, 0x1e, 0x3e, 0x0e, 0x1e, 0x3d, 0x3d },\n\t{ STV090x_QPSK_910, 0x3f, 0x3f, 0x3e, 0x1f, 0x1e, 0x3e, 0x0e, 0x1e, 0x3d, 0x3d },\n\t{ STV090x_8PSK_35,  0x3c, 0x3e, 0x1c, 0x2e, 0x0c, 0x1e, 0x2b, 0x2d, 0x1b, 0x1d },\n\t{ STV090x_8PSK_23,  0x1d, 0x3e, 0x3c, 0x2e, 0x2c, 0x1e, 0x0c, 0x2d, 0x2b, 0x1d },\n\t{ STV090x_8PSK_34,  0x0e, 0x3e, 0x3d, 0x2e, 0x0d, 0x1e, 0x2c, 0x2d, 0x0c, 0x1d },\n\t{ STV090x_8PSK_56,  0x2e, 0x3e, 0x1e, 0x2e, 0x2d, 0x1e, 0x3c, 0x2d, 0x2c, 0x1d },\n\t{ STV090x_8PSK_89,  0x3e, 0x3e, 0x1e, 0x2e, 0x3d, 0x1e, 0x0d, 0x2d, 0x3c, 0x1d },\n\t{ STV090x_8PSK_910, 0x3e, 0x3e, 0x1e, 0x2e, 0x3d, 0x1e, 0x1d, 0x2d, 0x0d, 0x1d }\n};\n\n \nstatic\tstruct stv090x_long_frame_crloop stv090x_s2_crl_cut30[] = {\n\t \n\t{ STV090x_QPSK_12,  0x3c, 0x2c, 0x0c, 0x2c, 0x1b, 0x2c, 0x1b, 0x1c, 0x0b, 0x3b },\n\t{ STV090x_QPSK_35,  0x0d, 0x0d, 0x0c, 0x0d, 0x1b, 0x3c, 0x1b, 0x1c, 0x0b, 0x3b },\n\t{ STV090x_QPSK_23,  0x1d, 0x0d, 0x0c, 0x1d, 0x2b, 0x3c, 0x1b, 0x1c, 0x0b, 0x3b },\n\t{ STV090x_QPSK_34,  0x1d, 0x1d, 0x0c, 0x1d, 0x2b, 0x3c, 0x1b, 0x1c, 0x0b, 0x3b },\n\t{ STV090x_QPSK_45,  0x2d, 0x1d, 0x1c, 0x1d, 0x2b, 0x3c, 0x2b, 0x0c, 0x1b, 0x3b },\n\t{ STV090x_QPSK_56,  0x2d, 0x1d, 0x1c, 0x1d, 0x2b, 0x3c, 0x2b, 0x0c, 0x1b, 0x3b },\n\t{ STV090x_QPSK_89,  0x3d, 0x2d, 0x1c, 0x1d, 0x3b, 0x3c, 0x2b, 0x0c, 0x1b, 0x3b },\n\t{ STV090x_QPSK_910, 0x3d, 0x2d, 0x1c, 0x1d, 0x3b, 0x3c, 0x2b, 0x0c, 0x1b, 0x3b },\n\t{ STV090x_8PSK_35,  0x39, 0x29, 0x39, 0x19, 0x19, 0x19, 0x19, 0x19, 0x09, 0x19 },\n\t{ STV090x_8PSK_23,  0x2a, 0x39, 0x1a, 0x0a, 0x39, 0x0a, 0x29, 0x39, 0x29, 0x0a },\n\t{ STV090x_8PSK_34,  0x2b, 0x3a, 0x1b, 0x1b, 0x3a, 0x1b, 0x1a, 0x0b, 0x1a, 0x3a },\n\t{ STV090x_8PSK_56,  0x0c, 0x1b, 0x3b, 0x3b, 0x1b, 0x3b, 0x3a, 0x3b, 0x3a, 0x1b },\n\t{ STV090x_8PSK_89,  0x0d, 0x3c, 0x2c, 0x2c, 0x2b, 0x0c, 0x0b, 0x3b, 0x0b, 0x1b },\n\t{ STV090x_8PSK_910, 0x0d, 0x0d, 0x2c, 0x3c, 0x3b, 0x1c, 0x0b, 0x3b, 0x0b, 0x1b }\n};\n\n \nstatic struct stv090x_long_frame_crloop stv090x_s2_apsk_crl_cut20[] = {\n\t \n\t{ STV090x_16APSK_23,  0x0c, 0x0c, 0x0c, 0x0c, 0x1d, 0x0c, 0x3c, 0x0c, 0x2c, 0x0c },\n\t{ STV090x_16APSK_34,  0x0c, 0x0c, 0x0c, 0x0c, 0x0e, 0x0c, 0x2d, 0x0c, 0x1d, 0x0c },\n\t{ STV090x_16APSK_45,  0x0c, 0x0c, 0x0c, 0x0c, 0x1e, 0x0c, 0x3d, 0x0c, 0x2d, 0x0c },\n\t{ STV090x_16APSK_56,  0x0c, 0x0c, 0x0c, 0x0c, 0x1e, 0x0c, 0x3d, 0x0c, 0x2d, 0x0c },\n\t{ STV090x_16APSK_89,  0x0c, 0x0c, 0x0c, 0x0c, 0x2e, 0x0c, 0x0e, 0x0c, 0x3d, 0x0c },\n\t{ STV090x_16APSK_910, 0x0c, 0x0c, 0x0c, 0x0c, 0x2e, 0x0c, 0x0e, 0x0c, 0x3d, 0x0c },\n\t{ STV090x_32APSK_34,  0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c },\n\t{ STV090x_32APSK_45,  0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c },\n\t{ STV090x_32APSK_56,  0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c },\n\t{ STV090x_32APSK_89,  0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c },\n\t{ STV090x_32APSK_910, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c }\n};\n\n \nstatic struct stv090x_long_frame_crloop\tstv090x_s2_apsk_crl_cut30[] = {\n\t \n\t{ STV090x_16APSK_23,  0x0a, 0x0a, 0x0a, 0x0a, 0x1a, 0x0a, 0x3a, 0x0a, 0x2a, 0x0a },\n\t{ STV090x_16APSK_34,  0x0a, 0x0a, 0x0a, 0x0a, 0x0b, 0x0a, 0x3b, 0x0a, 0x1b, 0x0a },\n\t{ STV090x_16APSK_45,  0x0a, 0x0a, 0x0a, 0x0a, 0x1b, 0x0a, 0x3b, 0x0a, 0x2b, 0x0a },\n\t{ STV090x_16APSK_56,  0x0a, 0x0a, 0x0a, 0x0a, 0x1b, 0x0a, 0x3b, 0x0a, 0x2b, 0x0a },\n\t{ STV090x_16APSK_89,  0x0a, 0x0a, 0x0a, 0x0a, 0x2b, 0x0a, 0x0c, 0x0a, 0x3b, 0x0a },\n\t{ STV090x_16APSK_910, 0x0a, 0x0a, 0x0a, 0x0a, 0x2b, 0x0a, 0x0c, 0x0a, 0x3b, 0x0a },\n\t{ STV090x_32APSK_34,  0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a },\n\t{ STV090x_32APSK_45,  0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a },\n\t{ STV090x_32APSK_56,  0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a },\n\t{ STV090x_32APSK_89,  0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a },\n\t{ STV090x_32APSK_910, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a, 0x0a }\n};\n\nstatic struct stv090x_long_frame_crloop stv090x_s2_lowqpsk_crl_cut20[] = {\n\t \n\t{ STV090x_QPSK_14,  0x0f, 0x3f, 0x0e, 0x3f, 0x2d, 0x2f, 0x2d, 0x1f, 0x3d, 0x3e },\n\t{ STV090x_QPSK_13,  0x0f, 0x3f, 0x0e, 0x3f, 0x2d, 0x2f, 0x3d, 0x0f, 0x3d, 0x2e },\n\t{ STV090x_QPSK_25,  0x1f, 0x3f, 0x1e, 0x3f, 0x3d, 0x1f, 0x3d, 0x3e, 0x3d, 0x2e }\n};\n\nstatic struct stv090x_long_frame_crloop\tstv090x_s2_lowqpsk_crl_cut30[] = {\n\t \n\t{ STV090x_QPSK_14,  0x0c, 0x3c, 0x0b, 0x3c, 0x2a, 0x2c, 0x2a, 0x1c, 0x3a, 0x3b },\n\t{ STV090x_QPSK_13,  0x0c, 0x3c, 0x0b, 0x3c, 0x2a, 0x2c, 0x3a, 0x0c, 0x3a, 0x2b },\n\t{ STV090x_QPSK_25,  0x1c, 0x3c, 0x1b, 0x3c, 0x3a, 0x1c, 0x3a, 0x3b, 0x3a, 0x2b }\n};\n\n \nstatic struct stv090x_short_frame_crloop stv090x_s2_short_crl_cut20[] = {\n\t \n\t{ STV090x_QPSK,   0x2f, 0x2e, 0x0e, 0x0e, 0x3d },\n\t{ STV090x_8PSK,   0x3e, 0x0e, 0x2d, 0x0d, 0x3c },\n\t{ STV090x_16APSK, 0x1e, 0x1e, 0x1e, 0x3d, 0x2d },\n\t{ STV090x_32APSK, 0x1e, 0x1e, 0x1e, 0x3d, 0x2d }\n};\n\n \nstatic struct stv090x_short_frame_crloop stv090x_s2_short_crl_cut30[] = {\n\t \n\t{ STV090x_QPSK,   0x2C, 0x2B, 0x0B, 0x0B, 0x3A },\n\t{ STV090x_8PSK,   0x3B, 0x0B, 0x2A, 0x0A, 0x39 },\n\t{ STV090x_16APSK, 0x1B, 0x1B, 0x1B, 0x3A, 0x2A },\n\t{ STV090x_32APSK, 0x1B, 0x1B, 0x1B, 0x3A, 0x2A }\n};\n\nstatic inline s32 comp2(s32 __x, s32 __width)\n{\n\tif (__width == 32)\n\t\treturn __x;\n\telse\n\t\treturn (__x >= (1 << (__width - 1))) ? (__x - (1 << __width)) : __x;\n}\n\nstatic int stv090x_read_reg(struct stv090x_state *state, unsigned int reg)\n{\n\tconst struct stv090x_config *config = state->config;\n\tint ret;\n\n\tu8 b0[] = { reg >> 8, reg & 0xff };\n\tu8 buf;\n\n\tstruct i2c_msg msg[] = {\n\t\t{ .addr\t= config->address, .flags\t= 0,\t\t.buf = b0,   .len = 2 },\n\t\t{ .addr\t= config->address, .flags\t= I2C_M_RD,\t.buf = &buf, .len = 1 }\n\t};\n\n\tret = i2c_transfer(state->i2c, msg, 2);\n\tif (ret != 2) {\n\t\tif (ret != -ERESTARTSYS)\n\t\t\tdprintk(FE_ERROR, 1,\n\t\t\t\t\"Read error, Reg=[0x%02x], Status=%d\",\n\t\t\t\treg, ret);\n\n\t\treturn ret < 0 ? ret : -EREMOTEIO;\n\t}\n\tif (unlikely(*state->verbose >= FE_DEBUGREG))\n\t\tdprintk(FE_ERROR, 1, \"Reg=[0x%02x], data=%02x\",\n\t\t\treg, buf);\n\n\treturn (unsigned int) buf;\n}\n\nstatic int stv090x_write_regs(struct stv090x_state *state, unsigned int reg, u8 *data, u32 count)\n{\n\tconst struct stv090x_config *config = state->config;\n\tint ret;\n\tu8 buf[MAX_XFER_SIZE];\n\tstruct i2c_msg i2c_msg = { .addr = config->address, .flags = 0, .buf = buf, .len = 2 + count };\n\n\tif (2 + count > sizeof(buf)) {\n\t\tprintk(KERN_WARNING\n\t\t       \"%s: i2c wr reg=%04x: len=%d is too big!\\n\",\n\t\t       KBUILD_MODNAME, reg, count);\n\t\treturn -EINVAL;\n\t}\n\n\tbuf[0] = reg >> 8;\n\tbuf[1] = reg & 0xff;\n\tmemcpy(&buf[2], data, count);\n\n\tdprintk(FE_DEBUGREG, 1, \"%s [0x%04x]: %*ph\",\n\t\t__func__, reg, count, data);\n\n\tret = i2c_transfer(state->i2c, &i2c_msg, 1);\n\tif (ret != 1) {\n\t\tif (ret != -ERESTARTSYS)\n\t\t\tdprintk(FE_ERROR, 1, \"Reg=[0x%04x], Data=[0x%02x ...], Count=%u, Status=%d\",\n\t\t\t\treg, data[0], count, ret);\n\t\treturn ret < 0 ? ret : -EREMOTEIO;\n\t}\n\n\treturn 0;\n}\n\nstatic int stv090x_write_reg(struct stv090x_state *state, unsigned int reg, u8 data)\n{\n\tu8 tmp = data;  \n\n\treturn stv090x_write_regs(state, reg, &tmp, 1);\n}\n\nstatic int stv090x_i2c_gate_ctrl(struct stv090x_state *state, int enable)\n{\n\tu32 reg;\n\n\t \n\tif (enable) {\n\t\tif (state->config->tuner_i2c_lock)\n\t\t\tstate->config->tuner_i2c_lock(&state->frontend, 1);\n\t\telse\n\t\t\tmutex_lock(&state->internal->tuner_lock);\n\t}\n\n\treg = STV090x_READ_DEMOD(state, I2CRPT);\n\tif (enable) {\n\t\tdprintk(FE_DEBUG, 1, \"Enable Gate\");\n\t\tSTV090x_SETFIELD_Px(reg, I2CT_ON_FIELD, 1);\n\t\tif (STV090x_WRITE_DEMOD(state, I2CRPT, reg) < 0)\n\t\t\tgoto err;\n\n\t} else {\n\t\tdprintk(FE_DEBUG, 1, \"Disable Gate\");\n\t\tSTV090x_SETFIELD_Px(reg, I2CT_ON_FIELD, 0);\n\t\tif ((STV090x_WRITE_DEMOD(state, I2CRPT, reg)) < 0)\n\t\t\tgoto err;\n\t}\n\n\tif (!enable) {\n\t\tif (state->config->tuner_i2c_lock)\n\t\t\tstate->config->tuner_i2c_lock(&state->frontend, 0);\n\t\telse\n\t\t\tmutex_unlock(&state->internal->tuner_lock);\n\t}\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\tif (state->config->tuner_i2c_lock)\n\t\tstate->config->tuner_i2c_lock(&state->frontend, 0);\n\telse\n\t\tmutex_unlock(&state->internal->tuner_lock);\n\treturn -1;\n}\n\nstatic void stv090x_get_lock_tmg(struct stv090x_state *state)\n{\n\tswitch (state->algo) {\n\tcase STV090x_BLIND_SEARCH:\n\t\tdprintk(FE_DEBUG, 1, \"Blind Search\");\n\t\tif (state->srate <= 1500000) {   \n\t\t\tstate->DemodTimeout = 1500;\n\t\t\tstate->FecTimeout = 400;\n\t\t} else if (state->srate <= 5000000) {   \n\t\t\tstate->DemodTimeout = 1000;\n\t\t\tstate->FecTimeout = 300;\n\t\t} else {   \n\t\t\tstate->DemodTimeout = 700;\n\t\t\tstate->FecTimeout = 100;\n\t\t}\n\t\tbreak;\n\n\tcase STV090x_COLD_SEARCH:\n\tcase STV090x_WARM_SEARCH:\n\tdefault:\n\t\tdprintk(FE_DEBUG, 1, \"Normal Search\");\n\t\tif (state->srate <= 1000000) {   \n\t\t\tstate->DemodTimeout = 4500;\n\t\t\tstate->FecTimeout = 1700;\n\t\t} else if (state->srate <= 2000000) {  \n\t\t\tstate->DemodTimeout = 2500;\n\t\t\tstate->FecTimeout = 1100;\n\t\t} else if (state->srate <= 5000000) {  \n\t\t\tstate->DemodTimeout = 1000;\n\t\t\tstate->FecTimeout = 550;\n\t\t} else if (state->srate <= 10000000) {  \n\t\t\tstate->DemodTimeout = 700;\n\t\t\tstate->FecTimeout = 250;\n\t\t} else if (state->srate <= 20000000) {  \n\t\t\tstate->DemodTimeout = 400;\n\t\t\tstate->FecTimeout = 130;\n\t\t} else {    \n\t\t\tstate->DemodTimeout = 300;\n\t\t\tstate->FecTimeout = 100;\n\t\t}\n\t\tbreak;\n\t}\n\n\tif (state->algo == STV090x_WARM_SEARCH)\n\t\tstate->DemodTimeout /= 2;\n}\n\nstatic int stv090x_set_srate(struct stv090x_state *state, u32 srate)\n{\n\tu32 sym;\n\n\tif (srate > 60000000) {\n\t\tsym  = (srate << 4);  \n\t\tsym /= (state->internal->mclk >> 12);\n\t} else if (srate > 6000000) {\n\t\tsym  = (srate << 6);\n\t\tsym /= (state->internal->mclk >> 10);\n\t} else {\n\t\tsym  = (srate << 9);\n\t\tsym /= (state->internal->mclk >> 7);\n\t}\n\n\tif (STV090x_WRITE_DEMOD(state, SFRINIT1, (sym >> 8) & 0x7f) < 0)  \n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, SFRINIT0, (sym & 0xff)) < 0)  \n\t\tgoto err;\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_set_max_srate(struct stv090x_state *state, u32 clk, u32 srate)\n{\n\tu32 sym;\n\n\tsrate = 105 * (srate / 100);\n\tif (srate > 60000000) {\n\t\tsym  = (srate << 4);  \n\t\tsym /= (state->internal->mclk >> 12);\n\t} else if (srate > 6000000) {\n\t\tsym  = (srate << 6);\n\t\tsym /= (state->internal->mclk >> 10);\n\t} else {\n\t\tsym  = (srate << 9);\n\t\tsym /= (state->internal->mclk >> 7);\n\t}\n\n\tif (sym < 0x7fff) {\n\t\tif (STV090x_WRITE_DEMOD(state, SFRUP1, (sym >> 8) & 0x7f) < 0)  \n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, SFRUP0, sym & 0xff) < 0)  \n\t\t\tgoto err;\n\t} else {\n\t\tif (STV090x_WRITE_DEMOD(state, SFRUP1, 0x7f) < 0)  \n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, SFRUP0, 0xff) < 0)  \n\t\t\tgoto err;\n\t}\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_set_min_srate(struct stv090x_state *state, u32 clk, u32 srate)\n{\n\tu32 sym;\n\n\tsrate = 95 * (srate / 100);\n\tif (srate > 60000000) {\n\t\tsym  = (srate << 4);  \n\t\tsym /= (state->internal->mclk >> 12);\n\t} else if (srate > 6000000) {\n\t\tsym  = (srate << 6);\n\t\tsym /= (state->internal->mclk >> 10);\n\t} else {\n\t\tsym  = (srate << 9);\n\t\tsym /= (state->internal->mclk >> 7);\n\t}\n\n\tif (STV090x_WRITE_DEMOD(state, SFRLOW1, ((sym >> 8) & 0x7f)) < 0)  \n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, SFRLOW0, (sym & 0xff)) < 0)  \n\t\tgoto err;\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic u32 stv090x_car_width(u32 srate, enum stv090x_rolloff rolloff)\n{\n\tu32 ro;\n\n\tswitch (rolloff) {\n\tcase STV090x_RO_20:\n\t\tro = 20;\n\t\tbreak;\n\tcase STV090x_RO_25:\n\t\tro = 25;\n\t\tbreak;\n\tcase STV090x_RO_35:\n\tdefault:\n\t\tro = 35;\n\t\tbreak;\n\t}\n\n\treturn srate + (srate * ro) / 100;\n}\n\nstatic int stv090x_set_vit_thacq(struct stv090x_state *state)\n{\n\tif (STV090x_WRITE_DEMOD(state, VTH12, 0x96) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH23, 0x64) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH34, 0x36) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH56, 0x23) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH67, 0x1e) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH78, 0x19) < 0)\n\t\tgoto err;\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_set_vit_thtracq(struct stv090x_state *state)\n{\n\tif (STV090x_WRITE_DEMOD(state, VTH12, 0xd0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH23, 0x7d) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH34, 0x53) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH56, 0x2f) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH67, 0x24) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, VTH78, 0x1f) < 0)\n\t\tgoto err;\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_set_viterbi(struct stv090x_state *state)\n{\n\tswitch (state->search_mode) {\n\tcase STV090x_SEARCH_AUTO:\n\t\tif (STV090x_WRITE_DEMOD(state, FECM, 0x10) < 0)  \n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x3f) < 0)  \n\t\t\tgoto err;\n\t\tbreak;\n\tcase STV090x_SEARCH_DVBS1:\n\t\tif (STV090x_WRITE_DEMOD(state, FECM, 0x00) < 0)  \n\t\t\tgoto err;\n\t\tswitch (state->fec) {\n\t\tcase STV090x_PR12:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x01) < 0)\n\t\t\t\tgoto err;\n\t\t\tbreak;\n\n\t\tcase STV090x_PR23:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x02) < 0)\n\t\t\t\tgoto err;\n\t\t\tbreak;\n\n\t\tcase STV090x_PR34:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x04) < 0)\n\t\t\t\tgoto err;\n\t\t\tbreak;\n\n\t\tcase STV090x_PR56:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x08) < 0)\n\t\t\t\tgoto err;\n\t\t\tbreak;\n\n\t\tcase STV090x_PR78:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x20) < 0)\n\t\t\t\tgoto err;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x2f) < 0)  \n\t\t\t\tgoto err;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase STV090x_SEARCH_DSS:\n\t\tif (STV090x_WRITE_DEMOD(state, FECM, 0x80) < 0)\n\t\t\tgoto err;\n\t\tswitch (state->fec) {\n\t\tcase STV090x_PR12:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x01) < 0)\n\t\t\t\tgoto err;\n\t\t\tbreak;\n\n\t\tcase STV090x_PR23:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x02) < 0)\n\t\t\t\tgoto err;\n\t\t\tbreak;\n\n\t\tcase STV090x_PR67:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x10) < 0)\n\t\t\t\tgoto err;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tif (STV090x_WRITE_DEMOD(state, PRVIT, 0x13) < 0)  \n\t\t\t\tgoto err;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_stop_modcod(struct stv090x_state *state)\n{\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST0, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST1, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST2, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST3, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST4, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST5, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST6, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST7, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST8, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST9, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTA, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTB, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTC, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTD, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTE, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTF, 0xff) < 0)\n\t\tgoto err;\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_activate_modcod(struct stv090x_state *state)\n{\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST0, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST1, 0xfc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST2, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST3, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST4, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST5, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST6, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST7, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST8, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST9, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTA, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTB, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTC, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTD, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTE, 0xcc) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTF, 0xcf) < 0)\n\t\tgoto err;\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_activate_modcod_single(struct stv090x_state *state)\n{\n\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST0, 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST1, 0xf0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST2, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST3, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST4, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST5, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST6, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST7, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST8, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLST9, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTA, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTB, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTC, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTD, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTE, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, MODCODLSTF, 0x0f) < 0)\n\t\tgoto err;\n\n\treturn 0;\n\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_vitclk_ctl(struct stv090x_state *state, int enable)\n{\n\tu32 reg;\n\n\tswitch (state->demod) {\n\tcase STV090x_DEMODULATOR_0:\n\t\tmutex_lock(&state->internal->demod_lock);\n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK2);\n\t\tSTV090x_SETFIELD(reg, STOP_CLKVIT1_FIELD, enable);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\n\t\t\tgoto err;\n\t\tmutex_unlock(&state->internal->demod_lock);\n\t\tbreak;\n\n\tcase STV090x_DEMODULATOR_1:\n\t\tmutex_lock(&state->internal->demod_lock);\n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK2);\n\t\tSTV090x_SETFIELD(reg, STOP_CLKVIT2_FIELD, enable);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\n\t\t\tgoto err;\n\t\tmutex_unlock(&state->internal->demod_lock);\n\t\tbreak;\n\n\tdefault:\n\t\tdprintk(FE_ERROR, 1, \"Wrong demodulator!\");\n\t\tbreak;\n\t}\n\treturn 0;\nerr:\n\tmutex_unlock(&state->internal->demod_lock);\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_dvbs_track_crl(struct stv090x_state *state)\n{\n\tif (state->internal->dev_ver >= 0x30) {\n\t\t \n\t\tif (state->srate >= 15000000) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC, 0x2b) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, BCLC, 0x1a) < 0)\n\t\t\t\tgoto err;\n\t\t} else if ((state->srate >= 7000000) && (15000000 > state->srate)) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC, 0x0c) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, BCLC, 0x1b) < 0)\n\t\t\t\tgoto err;\n\t\t} else if (state->srate < 7000000) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC, 0x2c) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, BCLC, 0x1c) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t} else {\n\t\t \n\t\tif (STV090x_WRITE_DEMOD(state, ACLC, 0x1a) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, BCLC, 0x09) < 0)\n\t\t\tgoto err;\n\t}\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_delivery_search(struct stv090x_state *state)\n{\n\tu32 reg;\n\n\tswitch (state->search_mode) {\n\tcase STV090x_SEARCH_DVBS1:\n\tcase STV090x_SEARCH_DSS:\n\t\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 0);\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\tgoto err;\n\n\t\t \n\t\tif (stv090x_vitclk_ctl(state, 0) < 0)\n\t\t\tgoto err;\n\n\t\tif (stv090x_dvbs_track_crl(state) < 0)\n\t\t\tgoto err;\n\n\t\tif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x22) < 0)  \n\t\t\tgoto err;\n\n\t\tif (stv090x_set_vit_thacq(state) < 0)\n\t\t\tgoto err;\n\t\tif (stv090x_set_viterbi(state) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_SEARCH_DVBS2:\n\t\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 0);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 0);\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\tgoto err;\n\t\tSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 1);\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\tgoto err;\n\n\t\tif (stv090x_vitclk_ctl(state, 1) < 0)\n\t\t\tgoto err;\n\n\t\tif (STV090x_WRITE_DEMOD(state, ACLC, 0x1a) < 0)  \n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, BCLC, 0x09) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->internal->dev_ver <= 0x20) {\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x26) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x66) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (state->demod_mode != STV090x_SINGLE) {\n\t\t\t \n\t\t\tif (stv090x_activate_modcod(state) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\t \n\t\t\tif (stv090x_activate_modcod_single(state) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (stv090x_set_vit_thtracq(state) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_SEARCH_AUTO:\n\tdefault:\n\t\t \n\t\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 0);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 0);\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\tgoto err;\n\t\tSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 1);\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\tgoto err;\n\n\t\tif (stv090x_vitclk_ctl(state, 0) < 0)\n\t\t\tgoto err;\n\n\t\tif (stv090x_dvbs_track_crl(state) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->internal->dev_ver <= 0x20) {\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x26) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x66) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (state->demod_mode != STV090x_SINGLE) {\n\t\t\t \n\t\t\tif (stv090x_activate_modcod(state) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\t \n\t\t\tif (stv090x_activate_modcod_single(state) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (stv090x_set_vit_thacq(state) < 0)\n\t\t\tgoto err;\n\n\t\tif (stv090x_set_viterbi(state) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\t}\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_start_search(struct stv090x_state *state)\n{\n\tu32 reg, freq_abs;\n\ts16 freq;\n\n\t \n\treg = STV090x_READ_DEMOD(state, DMDISTATE);\n\tSTV090x_SETFIELD_Px(reg, I2C_DEMOD_MODE_FIELD, 0x1f);\n\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, reg) < 0)\n\t\tgoto err;\n\n\tif (state->internal->dev_ver <= 0x20) {\n\t\tif (state->srate <= 5000000) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARCFG, 0x44) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, CFRUP1, 0x0f) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, CFRUP0, 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, CFRLOW1, 0xf0) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, CFRLOW0, 0x00) < 0)\n\t\t\t\tgoto err;\n\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, RTCS2, 0x68) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, CARCFG, 0xc4) < 0)\n\t\t\t\tgoto err;\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, RTCS2, 0x44) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t} else {\n\t\t \n\t\tif (state->srate <= 5000000) {\n\t\t\t \n\t\t\tSTV090x_WRITE_DEMOD(state, RTCS2, 0x68);\n\t\t} else {\n\t\t\t \n\t\t\tSTV090x_WRITE_DEMOD(state, RTCS2, 0x44);\n\t\t}\n\n\t\t \n\t\tSTV090x_WRITE_DEMOD(state, CARCFG, 0x46);\n\n\t\tif (state->algo == STV090x_WARM_SEARCH) {\n\t\t\t \n\t\t\tfreq_abs  = 1000 << 16;\n\t\t\tfreq_abs /= (state->internal->mclk / 1000);\n\t\t\tfreq      = (s16) freq_abs;\n\t\t} else {\n\t\t\t \n\t\t\tfreq_abs  = (state->search_range / 2000) + 600;\n\t\t\tfreq_abs  = freq_abs << 16;\n\t\t\tfreq_abs /= (state->internal->mclk / 1000);\n\t\t\tfreq      = (s16) freq_abs;\n\t\t}\n\n\t\tif (STV090x_WRITE_DEMOD(state, CFRUP1, MSB(freq)) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRUP0, LSB(freq)) < 0)\n\t\t\tgoto err;\n\n\t\tfreq *= -1;\n\n\t\tif (STV090x_WRITE_DEMOD(state, CFRLOW1, MSB(freq)) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRLOW0, LSB(freq)) < 0)\n\t\t\tgoto err;\n\n\t}\n\n\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, 0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, 0) < 0)\n\t\tgoto err;\n\n\tif (state->internal->dev_ver >= 0x20) {\n\t\tif (STV090x_WRITE_DEMOD(state, EQUALCFG, 0x41) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, FFECFG, 0x41) < 0)\n\t\t\tgoto err;\n\n\t\tif ((state->search_mode == STV090x_SEARCH_DVBS1)\t||\n\t\t\t(state->search_mode == STV090x_SEARCH_DSS)\t||\n\t\t\t(state->search_mode == STV090x_SEARCH_AUTO)) {\n\n\t\t\tif (STV090x_WRITE_DEMOD(state, VITSCALE, 0x82) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, VAVSRVIT, 0x00) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t}\n\n\tif (STV090x_WRITE_DEMOD(state, SFRSTEP, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, TMGTHRISE, 0xe0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, TMGTHFALL, 0xc0) < 0)\n\t\tgoto err;\n\n\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\tSTV090x_SETFIELD_Px(reg, SCAN_ENABLE_FIELD, 0);\n\tSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0);\n\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\tgoto err;\n\treg = STV090x_READ_DEMOD(state, DMDCFG2);\n\tSTV090x_SETFIELD_Px(reg, S1S2_SEQUENTIAL_FIELD, 0x0);\n\tif (STV090x_WRITE_DEMOD(state, DMDCFG2, reg) < 0)\n\t\tgoto err;\n\n\tif (STV090x_WRITE_DEMOD(state, RTC, 0x88) < 0)\n\t\tgoto err;\n\n\tif (state->internal->dev_ver >= 0x20) {\n\t\t \n\t\tif (state->srate < 2000000) {\n\t\t\tif (state->internal->dev_ver <= 0x20) {\n\t\t\t\t \n\t\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x39) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x89) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t}\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARHDR, 0x40) < 0)\n\t\t\t\tgoto err;\n\t\t} else if (state->srate < 10000000) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x4c) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARHDR, 0x20) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x4b) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARHDR, 0x20) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t} else {\n\t\tif (state->srate < 10000000) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0xef) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0xed) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t}\n\n\tswitch (state->algo) {\n\tcase STV090x_WARM_SEARCH:\n\t\t \n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_COLD_SEARCH:\n\t\t \n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x15) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_get_agc2_min_level(struct stv090x_state *state)\n{\n\tu32 agc2_min = 0xffff, agc2 = 0, freq_init, freq_step, reg;\n\ts32 i, j, steps, dir;\n\n\tif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\n\t\tgoto err;\n\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\tSTV090x_SETFIELD_Px(reg, SCAN_ENABLE_FIELD, 0);\n\tSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0);\n\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\tgoto err;\n\n\tif (STV090x_WRITE_DEMOD(state, SFRUP1, 0x83) < 0)  \n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, SFRUP0, 0xc0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, SFRLOW1, 0x82) < 0)  \n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, SFRLOW0, 0xa0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, DMDTOM, 0x00) < 0)  \n\t\tgoto err;\n\tif (stv090x_set_srate(state, 1000000) < 0)\n\t\tgoto err;\n\n\tsteps  = state->search_range / 1000000;\n\tif (steps <= 0)\n\t\tsteps = 1;\n\n\tdir = 1;\n\tfreq_step = (1000000 * 256) / (state->internal->mclk / 256);\n\tfreq_init = 0;\n\n\tfor (i = 0; i < steps; i++) {\n\t\tif (dir > 0)\n\t\t\tfreq_init = freq_init + (freq_step * i);\n\t\telse\n\t\t\tfreq_init = freq_init - (freq_step * i);\n\n\t\tdir *= -1;\n\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x5c) < 0)  \n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, (freq_init >> 8) & 0xff) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, freq_init & 0xff) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x58) < 0)  \n\t\t\tgoto err;\n\t\tmsleep(10);\n\n\t\tagc2 = 0;\n\t\tfor (j = 0; j < 10; j++) {\n\t\t\tagc2 += (STV090x_READ_DEMOD(state, AGC2I1) << 8) |\n\t\t\t\tSTV090x_READ_DEMOD(state, AGC2I0);\n\t\t}\n\t\tagc2 /= 10;\n\t\tif (agc2 < agc2_min)\n\t\t\tagc2_min = agc2;\n\t}\n\n\treturn agc2_min;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic u32 stv090x_get_srate(struct stv090x_state *state, u32 clk)\n{\n\tu8 r3, r2, r1, r0;\n\ts32 srate, int_1, int_2, tmp_1, tmp_2;\n\n\tr3 = STV090x_READ_DEMOD(state, SFR3);\n\tr2 = STV090x_READ_DEMOD(state, SFR2);\n\tr1 = STV090x_READ_DEMOD(state, SFR1);\n\tr0 = STV090x_READ_DEMOD(state, SFR0);\n\n\tsrate = ((r3 << 24) | (r2 << 16) | (r1 <<  8) | r0);\n\n\tint_1 = clk >> 16;\n\tint_2 = srate >> 16;\n\n\ttmp_1 = clk % 0x10000;\n\ttmp_2 = srate % 0x10000;\n\n\tsrate = (int_1 * int_2) +\n\t\t((int_1 * tmp_2) >> 16) +\n\t\t((int_2 * tmp_1) >> 16);\n\n\treturn srate;\n}\n\nstatic u32 stv090x_srate_srch_coarse(struct stv090x_state *state)\n{\n\tstruct dvb_frontend *fe = &state->frontend;\n\n\tint tmg_lock = 0, i;\n\ts32 tmg_cpt = 0, dir = 1, steps, cur_step = 0, freq;\n\tu32 srate_coarse = 0, agc2 = 0, car_step = 1200, reg;\n\tu32 agc2th;\n\n\tif (state->internal->dev_ver >= 0x30)\n\t\tagc2th = 0x2e00;\n\telse\n\t\tagc2th = 0x1f00;\n\n\treg = STV090x_READ_DEMOD(state, DMDISTATE);\n\tSTV090x_SETFIELD_Px(reg, I2C_DEMOD_MODE_FIELD, 0x1f);  \n\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, reg) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, TMGCFG, 0x12) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, TMGTHRISE, 0xf0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, TMGTHFALL, 0xe0) < 0)\n\t\tgoto err;\n\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\tSTV090x_SETFIELD_Px(reg, SCAN_ENABLE_FIELD, 1);\n\tSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0);\n\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\tgoto err;\n\n\tif (STV090x_WRITE_DEMOD(state, SFRUP1, 0x83) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, SFRUP0, 0xc0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, SFRLOW1, 0x82) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, SFRLOW0, 0xa0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, DMDTOM, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x50) < 0)\n\t\tgoto err;\n\n\tif (state->internal->dev_ver >= 0x30) {\n\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x99) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, SFRSTEP, 0x98) < 0)\n\t\t\tgoto err;\n\n\t} else if (state->internal->dev_ver >= 0x20) {\n\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x6a) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, SFRSTEP, 0x95) < 0)\n\t\t\tgoto err;\n\t}\n\n\tif (state->srate <= 2000000)\n\t\tcar_step = 1000;\n\telse if (state->srate <= 5000000)\n\t\tcar_step = 2000;\n\telse if (state->srate <= 12000000)\n\t\tcar_step = 3000;\n\telse\n\t\tcar_step = 5000;\n\n\tsteps  = -1 + ((state->search_range / 1000) / car_step);\n\tsteps /= 2;\n\tsteps  = (2 * steps) + 1;\n\tif (steps < 0)\n\t\tsteps = 1;\n\telse if (steps > 10) {\n\t\tsteps = 11;\n\t\tcar_step = (state->search_range / 1000) / 10;\n\t}\n\tcur_step = 0;\n\tdir = 1;\n\tfreq = state->frequency;\n\n\twhile ((!tmg_lock) && (cur_step < steps)) {\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x5f) < 0)  \n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, 0x00) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, 0x00) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, SFRINIT1, 0x00) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, SFRINIT0, 0x00) < 0)\n\t\t\tgoto err;\n\t\t \n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x40) < 0)\n\t\t\tgoto err;\n\t\tmsleep(50);\n\t\tfor (i = 0; i < 10; i++) {\n\t\t\treg = STV090x_READ_DEMOD(state, DSTATUS);\n\t\t\tif (STV090x_GETFIELD_Px(reg, TMGLOCK_QUALITY_FIELD) >= 2)\n\t\t\t\ttmg_cpt++;\n\t\t\tagc2 += (STV090x_READ_DEMOD(state, AGC2I1) << 8) |\n\t\t\t\tSTV090x_READ_DEMOD(state, AGC2I0);\n\t\t}\n\t\tagc2 /= 10;\n\t\tsrate_coarse = stv090x_get_srate(state, state->internal->mclk);\n\t\tcur_step++;\n\t\tdir *= -1;\n\t\tif ((tmg_cpt >= 5) && (agc2 < agc2th) &&\n\t\t    (srate_coarse < 50000000) && (srate_coarse > 850000))\n\t\t\ttmg_lock = 1;\n\t\telse if (cur_step < steps) {\n\t\t\tif (dir > 0)\n\t\t\t\tfreq += cur_step * car_step;\n\t\t\telse\n\t\t\t\tfreq -= cur_step * car_step;\n\n\t\t\t \n\t\t\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tif (state->config->tuner_set_frequency) {\n\t\t\t\tif (state->config->tuner_set_frequency(fe, freq) < 0)\n\t\t\t\t\tgoto err_gateoff;\n\t\t\t}\n\n\t\t\tif (state->config->tuner_set_bandwidth) {\n\t\t\t\tif (state->config->tuner_set_bandwidth(fe, state->tuner_bw) < 0)\n\t\t\t\t\tgoto err_gateoff;\n\t\t\t}\n\n\t\t\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tmsleep(50);\n\n\t\t\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tif (state->config->tuner_get_status) {\n\t\t\t\tif (state->config->tuner_get_status(fe, &reg) < 0)\n\t\t\t\t\tgoto err_gateoff;\n\t\t\t}\n\n\t\t\tif (reg)\n\t\t\t\tdprintk(FE_DEBUG, 1, \"Tuner phase locked\");\n\t\t\telse\n\t\t\t\tdprintk(FE_DEBUG, 1, \"Tuner unlocked\");\n\n\t\t\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\t\t\tgoto err;\n\n\t\t}\n\t}\n\tif (!tmg_lock)\n\t\tsrate_coarse = 0;\n\telse\n\t\tsrate_coarse = stv090x_get_srate(state, state->internal->mclk);\n\n\treturn srate_coarse;\n\nerr_gateoff:\n\tstv090x_i2c_gate_ctrl(state, 0);\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic u32 stv090x_srate_srch_fine(struct stv090x_state *state)\n{\n\tu32 srate_coarse, freq_coarse, sym, reg;\n\n\tsrate_coarse = stv090x_get_srate(state, state->internal->mclk);\n\tfreq_coarse  = STV090x_READ_DEMOD(state, CFR2) << 8;\n\tfreq_coarse |= STV090x_READ_DEMOD(state, CFR1);\n\tsym = 13 * (srate_coarse / 10);  \n\n\tif (sym < state->srate)\n\t\tsrate_coarse = 0;\n\telse {\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)  \n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc1) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, TMGTHRISE, 0x20) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, TMGTHFALL, 0x00) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, TMGCFG, 0xd2) < 0)\n\t\t\tgoto err;\n\t\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\t\tSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0x00);\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\tgoto err;\n\n\t\tif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->internal->dev_ver >= 0x30) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x79) < 0)\n\t\t\t\tgoto err;\n\t\t} else if (state->internal->dev_ver >= 0x20) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x49) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (srate_coarse > 3000000) {\n\t\t\tsym  = 13 * (srate_coarse / 10);  \n\t\t\tsym  = (sym / 1000) * 65536;\n\t\t\tsym /= (state->internal->mclk / 1000);\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRUP1, (sym >> 8) & 0x7f) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRUP0, sym & 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tsym  = 10 * (srate_coarse / 13);  \n\t\t\tsym  = (sym / 1000) * 65536;\n\t\t\tsym /= (state->internal->mclk / 1000);\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRLOW1, (sym >> 8) & 0x7f) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRLOW0, sym & 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tsym  = (srate_coarse / 1000) * 65536;\n\t\t\tsym /= (state->internal->mclk / 1000);\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRINIT1, (sym >> 8) & 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRINIT0, sym & 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\tsym  = 13 * (srate_coarse / 10);  \n\t\t\tsym  = (sym / 100) * 65536;\n\t\t\tsym /= (state->internal->mclk / 100);\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRUP1, (sym >> 8) & 0x7f) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRUP0, sym & 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tsym  = 10 * (srate_coarse / 14);  \n\t\t\tsym  = (sym / 100) * 65536;\n\t\t\tsym /= (state->internal->mclk / 100);\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRLOW1, (sym >> 8) & 0x7f) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRLOW0, sym & 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tsym  = (srate_coarse / 100) * 65536;\n\t\t\tsym /= (state->internal->mclk / 100);\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRINIT1, (sym >> 8) & 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, SFRINIT0, sym & 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t\tif (STV090x_WRITE_DEMOD(state, DMDTOM, 0x20) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, (freq_coarse >> 8) & 0xff) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, freq_coarse & 0xff) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x15) < 0)  \n\t\t\tgoto err;\n\t}\n\n\treturn srate_coarse;\n\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_get_dmdlock(struct stv090x_state *state, s32 timeout)\n{\n\ts32 timer = 0, lock = 0;\n\tu32 reg;\n\tu8 stat;\n\n\twhile ((timer < timeout) && (!lock)) {\n\t\treg = STV090x_READ_DEMOD(state, DMDSTATE);\n\t\tstat = STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD);\n\n\t\tswitch (stat) {\n\t\tcase 0:  \n\t\tcase 1:  \n\t\tdefault:\n\t\t\tdprintk(FE_DEBUG, 1, \"Demodulator searching ..\");\n\t\t\tlock = 0;\n\t\t\tbreak;\n\t\tcase 2:  \n\t\tcase 3:  \n\t\t\treg = STV090x_READ_DEMOD(state, DSTATUS);\n\t\t\tlock = STV090x_GETFIELD_Px(reg, LOCK_DEFINITIF_FIELD);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!lock)\n\t\t\tmsleep(10);\n\t\telse\n\t\t\tdprintk(FE_DEBUG, 1, \"Demodulator acquired LOCK\");\n\n\t\ttimer += 10;\n\t}\n\treturn lock;\n}\n\nstatic int stv090x_blind_search(struct stv090x_state *state)\n{\n\tu32 agc2, reg, srate_coarse;\n\ts32 cpt_fail, agc2_ovflw, i;\n\tu8 k_ref, k_max, k_min;\n\tint coarse_fail = 0;\n\tint lock;\n\n\tk_max = 110;\n\tk_min = 10;\n\n\tagc2 = stv090x_get_agc2_min_level(state);\n\n\tif (agc2 > STV090x_SEARCH_AGC2_TH(state->internal->dev_ver)) {\n\t\tlock = 0;\n\t} else {\n\n\t\tif (state->internal->dev_ver <= 0x20) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARCFG, 0xc4) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, CARCFG, 0x06) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (STV090x_WRITE_DEMOD(state, RTCS2, 0x44) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->internal->dev_ver >= 0x20) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, EQUALCFG, 0x41) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, FFECFG, 0x41) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, VITSCALE, 0x82) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, VAVSRVIT, 0x00) < 0)  \n\t\t\t\tgoto err;\n\t\t}\n\n\t\tk_ref = k_max;\n\t\tdo {\n\t\t\tif (STV090x_WRITE_DEMOD(state, KREFTMG, k_ref) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (stv090x_srate_srch_coarse(state) != 0) {\n\t\t\t\tsrate_coarse = stv090x_srate_srch_fine(state);\n\t\t\t\tif (srate_coarse != 0) {\n\t\t\t\t\tstv090x_get_lock_tmg(state);\n\t\t\t\t\tlock = stv090x_get_dmdlock(state,\n\t\t\t\t\t\t\tstate->DemodTimeout);\n\t\t\t\t} else {\n\t\t\t\t\tlock = 0;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tcpt_fail = 0;\n\t\t\t\tagc2_ovflw = 0;\n\t\t\t\tfor (i = 0; i < 10; i++) {\n\t\t\t\t\tagc2 += (STV090x_READ_DEMOD(state, AGC2I1) << 8) |\n\t\t\t\t\t\tSTV090x_READ_DEMOD(state, AGC2I0);\n\t\t\t\t\tif (agc2 >= 0xff00)\n\t\t\t\t\t\tagc2_ovflw++;\n\t\t\t\t\treg = STV090x_READ_DEMOD(state, DSTATUS2);\n\t\t\t\t\tif ((STV090x_GETFIELD_Px(reg, CFR_OVERFLOW_FIELD) == 0x01) &&\n\t\t\t\t\t    (STV090x_GETFIELD_Px(reg, DEMOD_DELOCK_FIELD) == 0x01))\n\n\t\t\t\t\t\tcpt_fail++;\n\t\t\t\t}\n\t\t\t\tif ((cpt_fail > 7) || (agc2_ovflw > 7))\n\t\t\t\t\tcoarse_fail = 1;\n\n\t\t\t\tlock = 0;\n\t\t\t}\n\t\t\tk_ref -= 20;\n\t\t} while ((k_ref >= k_min) && (!lock) && (!coarse_fail));\n\t}\n\n\treturn lock;\n\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_chk_tmg(struct stv090x_state *state)\n{\n\tu32 reg;\n\ts32 tmg_cpt = 0, i;\n\tu8 freq, tmg_thh, tmg_thl;\n\tint tmg_lock = 0;\n\n\tfreq = STV090x_READ_DEMOD(state, CARFREQ);\n\ttmg_thh = STV090x_READ_DEMOD(state, TMGTHRISE);\n\ttmg_thl = STV090x_READ_DEMOD(state, TMGTHFALL);\n\tif (STV090x_WRITE_DEMOD(state, TMGTHRISE, 0x20) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, TMGTHFALL, 0x00) < 0)\n\t\tgoto err;\n\n\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\tSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0x00);  \n\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, RTC, 0x80) < 0)\n\t\tgoto err;\n\n\tif (STV090x_WRITE_DEMOD(state, RTCS2, 0x40) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x00) < 0)\n\t\tgoto err;\n\n\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, 0x00) < 0)  \n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, 0x00) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x65) < 0)\n\t\tgoto err;\n\n\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)  \n\t\tgoto err;\n\tmsleep(10);\n\n\tfor (i = 0; i < 10; i++) {\n\t\treg = STV090x_READ_DEMOD(state, DSTATUS);\n\t\tif (STV090x_GETFIELD_Px(reg, TMGLOCK_QUALITY_FIELD) >= 2)\n\t\t\ttmg_cpt++;\n\t\tmsleep(1);\n\t}\n\tif (tmg_cpt >= 3)\n\t\ttmg_lock = 1;\n\n\tif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, RTC, 0x88) < 0)  \n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, RTCS2, 0x68) < 0)  \n\t\tgoto err;\n\n\tif (STV090x_WRITE_DEMOD(state, CARFREQ, freq) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, TMGTHRISE, tmg_thh) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, TMGTHFALL, tmg_thl) < 0)\n\t\tgoto err;\n\n\treturn\ttmg_lock;\n\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_get_coldlock(struct stv090x_state *state, s32 timeout_dmd)\n{\n\tstruct dvb_frontend *fe = &state->frontend;\n\n\tu32 reg;\n\ts32 car_step, steps, cur_step, dir, freq, timeout_lock;\n\tint lock;\n\n\tif (state->srate >= 10000000)\n\t\ttimeout_lock = timeout_dmd / 3;\n\telse\n\t\ttimeout_lock = timeout_dmd / 2;\n\n\tlock = stv090x_get_dmdlock(state, timeout_lock);  \n\tif (lock)\n\t\treturn lock;\n\n\tif (state->srate >= 10000000) {\n\t\tif (stv090x_chk_tmg(state)) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x15) < 0)\n\t\t\t\tgoto err;\n\t\t\treturn stv090x_get_dmdlock(state, timeout_dmd);\n\t\t}\n\t\treturn 0;\n\t}\n\n\tif (state->srate <= 4000000)\n\t\tcar_step = 1000;\n\telse if (state->srate <= 7000000)\n\t\tcar_step = 2000;\n\telse if (state->srate <= 10000000)\n\t\tcar_step = 3000;\n\telse\n\t\tcar_step = 5000;\n\n\tsteps  = (state->search_range / 1000) / car_step;\n\tsteps /= 2;\n\tsteps  = 2 * (steps + 1);\n\tif (steps < 0)\n\t\tsteps = 2;\n\telse if (steps > 12)\n\t\tsteps = 12;\n\n\tcur_step = 1;\n\tdir = 1;\n\n\tfreq = state->frequency;\n\tstate->tuner_bw = stv090x_car_width(state->srate, state->rolloff) + state->srate;\n\twhile ((cur_step <= steps) && (!lock)) {\n\t\tif (dir > 0)\n\t\t\tfreq += cur_step * car_step;\n\t\telse\n\t\t\tfreq -= cur_step * car_step;\n\n\t\t \n\t\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->config->tuner_set_frequency) {\n\t\t\tif (state->config->tuner_set_frequency(fe, freq) < 0)\n\t\t\t\tgoto err_gateoff;\n\t\t}\n\n\t\tif (state->config->tuner_set_bandwidth) {\n\t\t\tif (state->config->tuner_set_bandwidth(fe, state->tuner_bw) < 0)\n\t\t\t\tgoto err_gateoff;\n\t\t}\n\n\t\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\t\tgoto err;\n\n\t\tmsleep(50);\n\n\t\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->config->tuner_get_status) {\n\t\t\tif (state->config->tuner_get_status(fe, &reg) < 0)\n\t\t\t\tgoto err_gateoff;\n\t\t\tif (reg)\n\t\t\t\tdprintk(FE_DEBUG, 1, \"Tuner phase locked\");\n\t\t\telse\n\t\t\t\tdprintk(FE_DEBUG, 1, \"Tuner unlocked\");\n\t\t}\n\n\t\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\t\tgoto err;\n\n\t\tSTV090x_WRITE_DEMOD(state, DMDISTATE, 0x1c);\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, 0x00) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, 0x00) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x15) < 0)\n\t\t\tgoto err;\n\t\tlock = stv090x_get_dmdlock(state, (timeout_dmd / 3));\n\n\t\tdir *= -1;\n\t\tcur_step++;\n\t}\n\n\treturn lock;\n\nerr_gateoff:\n\tstv090x_i2c_gate_ctrl(state, 0);\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_get_loop_params(struct stv090x_state *state, s32 *freq_inc, s32 *timeout_sw, s32 *steps)\n{\n\ts32 timeout, inc, steps_max, srate, car_max;\n\n\tsrate = state->srate;\n\tcar_max = state->search_range / 1000;\n\tcar_max += car_max / 10;\n\tcar_max  = 65536 * (car_max / 2);\n\tcar_max /= (state->internal->mclk / 1000);\n\n\tif (car_max > 0x4000)\n\t\tcar_max = 0x4000 ;  \n\n\tinc  = srate;\n\tinc /= state->internal->mclk / 1000;\n\tinc *= 256;\n\tinc *= 256;\n\tinc /= 1000;\n\n\tswitch (state->search_mode) {\n\tcase STV090x_SEARCH_DVBS1:\n\tcase STV090x_SEARCH_DSS:\n\t\tinc *= 3;  \n\t\ttimeout = 20;\n\t\tbreak;\n\n\tcase STV090x_SEARCH_DVBS2:\n\t\tinc *= 4;\n\t\ttimeout = 25;\n\t\tbreak;\n\n\tcase STV090x_SEARCH_AUTO:\n\tdefault:\n\t\tinc *= 3;\n\t\ttimeout = 25;\n\t\tbreak;\n\t}\n\tinc /= 100;\n\tif ((inc > car_max) || (inc < 0))\n\t\tinc = car_max / 2;  \n\n\ttimeout *= 27500;  \n\tif (srate > 0)\n\t\ttimeout /= (srate / 1000);\n\n\tif ((timeout > 100) || (timeout < 0))\n\t\ttimeout = 100;\n\n\tsteps_max = (car_max / inc) + 1;  \n\tif ((steps_max > 100) || (steps_max < 0)) {\n\t\tsteps_max = 100;  \n\t\tinc = car_max / steps_max;\n\t}\n\t*freq_inc = inc;\n\t*timeout_sw = timeout;\n\t*steps = steps_max;\n\n\treturn 0;\n}\n\nstatic int stv090x_chk_signal(struct stv090x_state *state)\n{\n\ts32 offst_car, agc2, car_max;\n\tint no_signal;\n\n\toffst_car  = STV090x_READ_DEMOD(state, CFR2) << 8;\n\toffst_car |= STV090x_READ_DEMOD(state, CFR1);\n\toffst_car = comp2(offst_car, 16);\n\n\tagc2  = STV090x_READ_DEMOD(state, AGC2I1) << 8;\n\tagc2 |= STV090x_READ_DEMOD(state, AGC2I0);\n\tcar_max = state->search_range / 1000;\n\n\tcar_max += (car_max / 10);  \n\tcar_max  = (65536 * car_max / 2);\n\tcar_max /= state->internal->mclk / 1000;\n\n\tif (car_max > 0x4000)\n\t\tcar_max = 0x4000;\n\n\tif ((agc2 > 0x2000) || (offst_car > 2 * car_max) || (offst_car < -2 * car_max)) {\n\t\tno_signal = 1;\n\t\tdprintk(FE_DEBUG, 1, \"No Signal\");\n\t} else {\n\t\tno_signal = 0;\n\t\tdprintk(FE_DEBUG, 1, \"Found Signal\");\n\t}\n\n\treturn no_signal;\n}\n\nstatic int stv090x_search_car_loop(struct stv090x_state *state, s32 inc, s32 timeout, int zigzag, s32 steps_max)\n{\n\tint no_signal, lock = 0;\n\ts32 cpt_step = 0, offst_freq, car_max;\n\tu32 reg;\n\n\tcar_max  = state->search_range / 1000;\n\tcar_max += (car_max / 10);\n\tcar_max  = (65536 * car_max / 2);\n\tcar_max /= (state->internal->mclk / 1000);\n\tif (car_max > 0x4000)\n\t\tcar_max = 0x4000;\n\n\tif (zigzag)\n\t\toffst_freq = 0;\n\telse\n\t\toffst_freq = -car_max + inc;\n\n\tdo {\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1c) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, ((offst_freq / 256) & 0xff)) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, offst_freq & 0xff) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)\n\t\t\tgoto err;\n\n\t\treg = STV090x_READ_DEMOD(state, PDELCTRL1);\n\t\tSTV090x_SETFIELD_Px(reg, ALGOSWRST_FIELD, 0x1);  \n\t\tif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\n\t\t\tgoto err;\n\n\t\tif (zigzag) {\n\t\t\tif (offst_freq >= 0)\n\t\t\t\toffst_freq = -offst_freq - 2 * inc;\n\t\t\telse\n\t\t\t\toffst_freq = -offst_freq;\n\t\t} else {\n\t\t\toffst_freq += 2 * inc;\n\t\t}\n\n\t\tcpt_step++;\n\n\t\tlock = stv090x_get_dmdlock(state, timeout);\n\t\tno_signal = stv090x_chk_signal(state);\n\n\t} while ((!lock) &&\n\t\t (!no_signal) &&\n\t\t  ((offst_freq - inc) < car_max) &&\n\t\t  ((offst_freq + inc) > -car_max) &&\n\t\t  (cpt_step < steps_max));\n\n\treg = STV090x_READ_DEMOD(state, PDELCTRL1);\n\tSTV090x_SETFIELD_Px(reg, ALGOSWRST_FIELD, 0);\n\tif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\n\t\t\tgoto err;\n\n\treturn lock;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_sw_algo(struct stv090x_state *state)\n{\n\tint no_signal, zigzag, lock = 0;\n\tu32 reg;\n\n\ts32 dvbs2_fly_wheel;\n\ts32 inc, timeout_step, trials, steps_max;\n\n\t \n\tstv090x_get_loop_params(state, &inc, &timeout_step, &steps_max);\n\n\tswitch (state->search_mode) {\n\tcase STV090x_SEARCH_DVBS1:\n\tcase STV090x_SEARCH_DSS:\n\t\t \n\t\tif (state->internal->dev_ver >= 0x20) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x3B) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, 0x49) < 0)\n\t\t\tgoto err;\n\t\tzigzag = 0;\n\t\tbreak;\n\n\tcase STV090x_SEARCH_DVBS2:\n\t\tif (state->internal->dev_ver >= 0x20) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x79) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, 0x89) < 0)\n\t\t\tgoto err;\n\t\tzigzag = 1;\n\t\tbreak;\n\n\tcase STV090x_SEARCH_AUTO:\n\tdefault:\n\t\t \n\t\tif (state->internal->dev_ver >= 0x20) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x3b) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x79) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, 0xc9) < 0)\n\t\t\tgoto err;\n\t\tzigzag = 0;\n\t\tbreak;\n\t}\n\n\ttrials = 0;\n\tdo {\n\t\tlock = stv090x_search_car_loop(state, inc, timeout_step, zigzag, steps_max);\n\t\tno_signal = stv090x_chk_signal(state);\n\t\ttrials++;\n\n\t\t \n\t\tif (lock || no_signal || (trials == 2)) {\n\t\t\t \n\t\t\tif (state->internal->dev_ver >= 0x20) {\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x49) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x9e) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t}\n\n\t\t\treg = STV090x_READ_DEMOD(state, DMDSTATE);\n\t\t\tif ((lock) && (STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD) == STV090x_DVBS2)) {\n\t\t\t\t \n\t\t\t\tmsleep(timeout_step);\n\t\t\t\treg = STV090x_READ_DEMOD(state, DMDFLYW);\n\t\t\t\tdvbs2_fly_wheel = STV090x_GETFIELD_Px(reg, FLYWHEEL_CPT_FIELD);\n\t\t\t\tif (dvbs2_fly_wheel < 0xd) {\t  \n\t\t\t\t\tmsleep(timeout_step);\n\t\t\t\t\treg = STV090x_READ_DEMOD(state, DMDFLYW);\n\t\t\t\t\tdvbs2_fly_wheel = STV090x_GETFIELD_Px(reg, FLYWHEEL_CPT_FIELD);\n\t\t\t\t}\n\t\t\t\tif (dvbs2_fly_wheel < 0xd) {\n\t\t\t\t\t \n\t\t\t\t\tlock = 0;\n\t\t\t\t\tif (trials < 2) {\n\t\t\t\t\t\tif (state->internal->dev_ver >= 0x20) {\n\t\t\t\t\t\t\tif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x79) < 0)\n\t\t\t\t\t\t\t\tgoto err;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, 0x89) < 0)\n\t\t\t\t\t\t\tgoto err;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} while ((!lock) && (trials < 2) && (!no_signal));\n\n\treturn lock;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic enum stv090x_delsys stv090x_get_std(struct stv090x_state *state)\n{\n\tu32 reg;\n\tenum stv090x_delsys delsys;\n\n\treg = STV090x_READ_DEMOD(state, DMDSTATE);\n\tif (STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD) == 2)\n\t\tdelsys = STV090x_DVBS2;\n\telse if (STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD) == 3) {\n\t\treg = STV090x_READ_DEMOD(state, FECM);\n\t\tif (STV090x_GETFIELD_Px(reg, DSS_DVB_FIELD) == 1)\n\t\t\tdelsys = STV090x_DSS;\n\t\telse\n\t\t\tdelsys = STV090x_DVBS1;\n\t} else {\n\t\tdelsys = STV090x_ERROR;\n\t}\n\n\treturn delsys;\n}\n\n \nstatic s32 stv090x_get_car_freq(struct stv090x_state *state, u32 mclk)\n{\n\ts32 derot, int_1, int_2, tmp_1, tmp_2;\n\n\tderot  = STV090x_READ_DEMOD(state, CFR2) << 16;\n\tderot |= STV090x_READ_DEMOD(state, CFR1) <<  8;\n\tderot |= STV090x_READ_DEMOD(state, CFR0);\n\n\tderot = comp2(derot, 24);\n\tint_1 = mclk >> 12;\n\tint_2 = derot >> 12;\n\n\t \n\ttmp_1 = mclk % 0x1000;\n\ttmp_2 = derot % 0x1000;\n\n\tderot = (int_1 * int_2) +\n\t\t((int_1 * tmp_2) >> 12) +\n\t\t((int_2 * tmp_1) >> 12);\n\n\treturn derot;\n}\n\nstatic int stv090x_get_viterbi(struct stv090x_state *state)\n{\n\tu32 reg, rate;\n\n\treg = STV090x_READ_DEMOD(state, VITCURPUN);\n\trate = STV090x_GETFIELD_Px(reg, VIT_CURPUN_FIELD);\n\n\tswitch (rate) {\n\tcase 13:\n\t\tstate->fec = STV090x_PR12;\n\t\tbreak;\n\n\tcase 18:\n\t\tstate->fec = STV090x_PR23;\n\t\tbreak;\n\n\tcase 21:\n\t\tstate->fec = STV090x_PR34;\n\t\tbreak;\n\n\tcase 24:\n\t\tstate->fec = STV090x_PR56;\n\t\tbreak;\n\n\tcase 25:\n\t\tstate->fec = STV090x_PR67;\n\t\tbreak;\n\n\tcase 26:\n\t\tstate->fec = STV090x_PR78;\n\t\tbreak;\n\n\tdefault:\n\t\tstate->fec = STV090x_PRERR;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic enum stv090x_signal_state stv090x_get_sig_params(struct stv090x_state *state)\n{\n\tstruct dvb_frontend *fe = &state->frontend;\n\n\tu8 tmg;\n\tu32 reg;\n\ts32 i = 0, offst_freq;\n\n\tmsleep(5);\n\n\tif (state->algo == STV090x_BLIND_SEARCH) {\n\t\ttmg = STV090x_READ_DEMOD(state, TMGREG2);\n\t\tSTV090x_WRITE_DEMOD(state, SFRSTEP, 0x5c);\n\t\twhile ((i <= 50) && (tmg != 0) && (tmg != 0xff)) {\n\t\t\ttmg = STV090x_READ_DEMOD(state, TMGREG2);\n\t\t\tmsleep(5);\n\t\t\ti += 5;\n\t\t}\n\t}\n\tstate->delsys = stv090x_get_std(state);\n\n\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\tgoto err;\n\n\tif (state->config->tuner_get_frequency) {\n\t\tif (state->config->tuner_get_frequency(fe, &state->frequency) < 0)\n\t\t\tgoto err_gateoff;\n\t}\n\n\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\tgoto err;\n\n\toffst_freq = stv090x_get_car_freq(state, state->internal->mclk) / 1000;\n\tstate->frequency += offst_freq;\n\n\tif (stv090x_get_viterbi(state) < 0)\n\t\tgoto err;\n\n\treg = STV090x_READ_DEMOD(state, DMDMODCOD);\n\tstate->modcod = STV090x_GETFIELD_Px(reg, DEMOD_MODCOD_FIELD);\n\tstate->pilots = STV090x_GETFIELD_Px(reg, DEMOD_TYPE_FIELD) & 0x01;\n\tstate->frame_len = STV090x_GETFIELD_Px(reg, DEMOD_TYPE_FIELD) >> 1;\n\treg = STV090x_READ_DEMOD(state, TMGOBS);\n\tstate->rolloff = STV090x_GETFIELD_Px(reg, ROLLOFF_STATUS_FIELD);\n\treg = STV090x_READ_DEMOD(state, FECM);\n\tstate->inversion = STV090x_GETFIELD_Px(reg, IQINV_FIELD);\n\n\tif ((state->algo == STV090x_BLIND_SEARCH) || (state->srate < 10000000)) {\n\n\t\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->config->tuner_get_frequency) {\n\t\t\tif (state->config->tuner_get_frequency(fe, &state->frequency) < 0)\n\t\t\t\tgoto err_gateoff;\n\t\t}\n\n\t\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\t\tgoto err;\n\n\t\tif (abs(offst_freq) <= ((state->search_range / 2000) + 500))\n\t\t\treturn STV090x_RANGEOK;\n\t\telse if (abs(offst_freq) <= (stv090x_car_width(state->srate, state->rolloff) / 2000))\n\t\t\treturn STV090x_RANGEOK;\n\t} else {\n\t\tif (abs(offst_freq) <= ((state->search_range / 2000) + 500))\n\t\t\treturn STV090x_RANGEOK;\n\t}\n\n\treturn STV090x_OUTOFRANGE;\n\nerr_gateoff:\n\tstv090x_i2c_gate_ctrl(state, 0);\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic u32 stv090x_get_tmgoffst(struct stv090x_state *state, u32 srate)\n{\n\ts32 offst_tmg;\n\n\toffst_tmg  = STV090x_READ_DEMOD(state, TMGREG2) << 16;\n\toffst_tmg |= STV090x_READ_DEMOD(state, TMGREG1) <<  8;\n\toffst_tmg |= STV090x_READ_DEMOD(state, TMGREG0);\n\n\toffst_tmg = comp2(offst_tmg, 24);  \n\tif (!offst_tmg)\n\t\toffst_tmg = 1;\n\n\toffst_tmg  = ((s32) srate * 10) / ((s32) 0x1000000 / offst_tmg);\n\toffst_tmg /= 320;\n\n\treturn offst_tmg;\n}\n\nstatic u8 stv090x_optimize_carloop(struct stv090x_state *state, enum stv090x_modcod modcod, s32 pilots)\n{\n\tu8 aclc = 0x29;\n\ts32 i;\n\tstruct stv090x_long_frame_crloop *car_loop, *car_loop_qpsk_low, *car_loop_apsk_low;\n\n\tif (state->internal->dev_ver == 0x20) {\n\t\tcar_loop\t\t= stv090x_s2_crl_cut20;\n\t\tcar_loop_qpsk_low\t= stv090x_s2_lowqpsk_crl_cut20;\n\t\tcar_loop_apsk_low\t= stv090x_s2_apsk_crl_cut20;\n\t} else {\n\t\t \n\t\tcar_loop\t\t= stv090x_s2_crl_cut30;\n\t\tcar_loop_qpsk_low\t= stv090x_s2_lowqpsk_crl_cut30;\n\t\tcar_loop_apsk_low\t= stv090x_s2_apsk_crl_cut30;\n\t}\n\n\tif (modcod < STV090x_QPSK_12) {\n\t\ti = 0;\n\t\twhile ((i < 3) && (modcod != car_loop_qpsk_low[i].modcod))\n\t\t\ti++;\n\n\t\tif (i >= 3)\n\t\t\ti = 2;\n\n\t} else {\n\t\ti = 0;\n\t\twhile ((i < 14) && (modcod != car_loop[i].modcod))\n\t\t\ti++;\n\n\t\tif (i >= 14) {\n\t\t\ti = 0;\n\t\t\twhile ((i < 11) && (modcod != car_loop_apsk_low[i].modcod))\n\t\t\t\ti++;\n\n\t\t\tif (i >= 11)\n\t\t\t\ti = 10;\n\t\t}\n\t}\n\n\tif (modcod <= STV090x_QPSK_25) {\n\t\tif (pilots) {\n\t\t\tif (state->srate <= 3000000)\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_on_2;\n\t\t\telse if (state->srate <= 7000000)\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_on_5;\n\t\t\telse if (state->srate <= 15000000)\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_on_10;\n\t\t\telse if (state->srate <= 25000000)\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_on_20;\n\t\t\telse\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_on_30;\n\t\t} else {\n\t\t\tif (state->srate <= 3000000)\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_off_2;\n\t\t\telse if (state->srate <= 7000000)\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_off_5;\n\t\t\telse if (state->srate <= 15000000)\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_off_10;\n\t\t\telse if (state->srate <= 25000000)\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_off_20;\n\t\t\telse\n\t\t\t\taclc = car_loop_qpsk_low[i].crl_pilots_off_30;\n\t\t}\n\n\t} else if (modcod <= STV090x_8PSK_910) {\n\t\tif (pilots) {\n\t\t\tif (state->srate <= 3000000)\n\t\t\t\taclc = car_loop[i].crl_pilots_on_2;\n\t\t\telse if (state->srate <= 7000000)\n\t\t\t\taclc = car_loop[i].crl_pilots_on_5;\n\t\t\telse if (state->srate <= 15000000)\n\t\t\t\taclc = car_loop[i].crl_pilots_on_10;\n\t\t\telse if (state->srate <= 25000000)\n\t\t\t\taclc = car_loop[i].crl_pilots_on_20;\n\t\t\telse\n\t\t\t\taclc = car_loop[i].crl_pilots_on_30;\n\t\t} else {\n\t\t\tif (state->srate <= 3000000)\n\t\t\t\taclc = car_loop[i].crl_pilots_off_2;\n\t\t\telse if (state->srate <= 7000000)\n\t\t\t\taclc = car_loop[i].crl_pilots_off_5;\n\t\t\telse if (state->srate <= 15000000)\n\t\t\t\taclc = car_loop[i].crl_pilots_off_10;\n\t\t\telse if (state->srate <= 25000000)\n\t\t\t\taclc = car_loop[i].crl_pilots_off_20;\n\t\t\telse\n\t\t\t\taclc = car_loop[i].crl_pilots_off_30;\n\t\t}\n\t} else {  \n\t\t \n\t\tif (i >= 11)\n\t\t\ti = 10;\n\t\tif (state->srate <= 3000000)\n\t\t\taclc = car_loop_apsk_low[i].crl_pilots_on_2;\n\t\telse if (state->srate <= 7000000)\n\t\t\taclc = car_loop_apsk_low[i].crl_pilots_on_5;\n\t\telse if (state->srate <= 15000000)\n\t\t\taclc = car_loop_apsk_low[i].crl_pilots_on_10;\n\t\telse if (state->srate <= 25000000)\n\t\t\taclc = car_loop_apsk_low[i].crl_pilots_on_20;\n\t\telse\n\t\t\taclc = car_loop_apsk_low[i].crl_pilots_on_30;\n\t}\n\n\treturn aclc;\n}\n\nstatic u8 stv090x_optimize_carloop_short(struct stv090x_state *state)\n{\n\tstruct stv090x_short_frame_crloop *short_crl = NULL;\n\ts32 index = 0;\n\tu8 aclc = 0x0b;\n\n\tswitch (state->modulation) {\n\tcase STV090x_QPSK:\n\tdefault:\n\t\tindex = 0;\n\t\tbreak;\n\tcase STV090x_8PSK:\n\t\tindex = 1;\n\t\tbreak;\n\tcase STV090x_16APSK:\n\t\tindex = 2;\n\t\tbreak;\n\tcase STV090x_32APSK:\n\t\tindex = 3;\n\t\tbreak;\n\t}\n\n\tif (state->internal->dev_ver >= 0x30) {\n\t\t \n\t\tshort_crl = stv090x_s2_short_crl_cut30;\n\t} else {\n\t\t \n\t\tshort_crl = stv090x_s2_short_crl_cut20;\n\t}\n\n\tif (state->srate <= 3000000)\n\t\taclc = short_crl[index].crl_2;\n\telse if (state->srate <= 7000000)\n\t\taclc = short_crl[index].crl_5;\n\telse if (state->srate <= 15000000)\n\t\taclc = short_crl[index].crl_10;\n\telse if (state->srate <= 25000000)\n\t\taclc = short_crl[index].crl_20;\n\telse\n\t\taclc = short_crl[index].crl_30;\n\n\treturn aclc;\n}\n\nstatic int stv090x_optimize_track(struct stv090x_state *state)\n{\n\tstruct dvb_frontend *fe = &state->frontend;\n\n\tenum stv090x_modcod modcod;\n\n\ts32 srate, pilots, aclc, f_1, f_0, i = 0, blind_tune = 0;\n\tu32 reg;\n\n\tsrate  = stv090x_get_srate(state, state->internal->mclk);\n\tsrate += stv090x_get_tmgoffst(state, srate);\n\n\tswitch (state->delsys) {\n\tcase STV090x_DVBS1:\n\tcase STV090x_DSS:\n\t\tif (state->search_mode == STV090x_SEARCH_AUTO) {\n\t\t\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\t\t\tSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\n\t\t\tSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 0);\n\t\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t\treg = STV090x_READ_DEMOD(state, DEMOD);\n\t\tSTV090x_SETFIELD_Px(reg, ROLLOFF_CONTROL_FIELD, state->rolloff);\n\t\tSTV090x_SETFIELD_Px(reg, MANUAL_SXROLLOFF_FIELD, 0x01);\n\t\tif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->internal->dev_ver >= 0x30) {\n\t\t\tif (stv090x_get_viterbi(state) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tif (state->fec == STV090x_PR12) {\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, GAUSSR0, 0x98) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, CCIR0, 0x18) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t} else {\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, GAUSSR0, 0x18) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, CCIR0, 0x18) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t}\n\t\t}\n\n\t\tif (STV090x_WRITE_DEMOD(state, ERRCTRL1, 0x75) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_DVBS2:\n\t\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 0);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 1);\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\tgoto err;\n\t\tif (state->internal->dev_ver >= 0x30) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC, 0) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, BCLC, 0) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t\tif (state->frame_len == STV090x_LONG_FRAME) {\n\t\t\treg = STV090x_READ_DEMOD(state, DMDMODCOD);\n\t\t\tmodcod = STV090x_GETFIELD_Px(reg, DEMOD_MODCOD_FIELD);\n\t\t\tpilots = STV090x_GETFIELD_Px(reg, DEMOD_TYPE_FIELD) & 0x01;\n\t\t\taclc = stv090x_optimize_carloop(state, modcod, pilots);\n\t\t\tif (modcod <= STV090x_QPSK_910) {\n\t\t\t\tSTV090x_WRITE_DEMOD(state, ACLC2S2Q, aclc);\n\t\t\t} else if (modcod <= STV090x_8PSK_910) {\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S28, aclc) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t}\n\t\t\tif ((state->demod_mode == STV090x_SINGLE) && (modcod > STV090x_8PSK_910)) {\n\t\t\t\tif (modcod <= STV090x_16APSK_910) {\n\t\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\n\t\t\t\t\t\tgoto err;\n\t\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S216A, aclc) < 0)\n\t\t\t\t\t\tgoto err;\n\t\t\t\t} else {\n\t\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\n\t\t\t\t\t\tgoto err;\n\t\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S232A, aclc) < 0)\n\t\t\t\t\t\tgoto err;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\taclc = stv090x_optimize_carloop_short(state);\n\t\t\tif (state->modulation == STV090x_QPSK) {\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, aclc) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t} else if (state->modulation == STV090x_8PSK) {\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S28, aclc) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t} else if (state->modulation == STV090x_16APSK) {\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S216A, aclc) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t} else if (state->modulation == STV090x_32APSK)  {\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ACLC2S232A, aclc) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t}\n\t\t}\n\n\t\tSTV090x_WRITE_DEMOD(state, ERRCTRL1, 0x67);  \n\t\tbreak;\n\n\tcase STV090x_ERROR:\n\tdefault:\n\t\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\n\t\tSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 1);\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\t}\n\n\tf_1 = STV090x_READ_DEMOD(state, CFR2);\n\tf_0 = STV090x_READ_DEMOD(state, CFR1);\n\treg = STV090x_READ_DEMOD(state, TMGOBS);\n\n\tif (state->algo == STV090x_BLIND_SEARCH) {\n\t\tSTV090x_WRITE_DEMOD(state, SFRSTEP, 0x00);\n\t\treg = STV090x_READ_DEMOD(state, DMDCFGMD);\n\t\tSTV090x_SETFIELD_Px(reg, SCAN_ENABLE_FIELD, 0x00);\n\t\tSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0x00);\n\t\tif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc1) < 0)\n\t\t\tgoto err;\n\n\t\tif (stv090x_set_srate(state, srate) < 0)\n\t\t\tgoto err;\n\t\tblind_tune = 1;\n\n\t\tif (stv090x_dvbs_track_crl(state) < 0)\n\t\t\tgoto err;\n\t}\n\n\tif (state->internal->dev_ver >= 0x20) {\n\t\tif ((state->search_mode == STV090x_SEARCH_DVBS1)\t||\n\t\t    (state->search_mode == STV090x_SEARCH_DSS)\t\t||\n\t\t    (state->search_mode == STV090x_SEARCH_AUTO)) {\n\n\t\t\tif (STV090x_WRITE_DEMOD(state, VAVSRVIT, 0x0a) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, VITSCALE, 0x00) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t}\n\n\tif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\n\t\tgoto err;\n\n\t \n\tif (STV090x_WRITE_DEMOD(state, SFRUP1, 0x80) < 0)\n\t\tgoto err;\n\t \n\tif (STV090x_WRITE_DEMOD(state, SFRLOW1, 0x80) < 0)\n\t\tgoto err;\n\n\tif ((state->internal->dev_ver >= 0x20) || (blind_tune == 1) ||\n\t    (state->srate < 10000000)) {\n\t\t \n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, f_1) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, f_0) < 0)\n\t\t\tgoto err;\n\t\tstate->tuner_bw = stv090x_car_width(srate, state->rolloff) + 10000000;\n\n\t\tif ((state->internal->dev_ver >= 0x20) || (blind_tune == 1)) {\n\n\t\t\tif (state->algo != STV090x_WARM_SEARCH) {\n\n\t\t\t\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\t\t\t\tgoto err;\n\n\t\t\t\tif (state->config->tuner_set_bandwidth) {\n\t\t\t\t\tif (state->config->tuner_set_bandwidth(fe, state->tuner_bw) < 0)\n\t\t\t\t\t\tgoto err_gateoff;\n\t\t\t\t}\n\n\t\t\t\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\t\t\t\tgoto err;\n\n\t\t\t}\n\t\t}\n\t\tif ((state->algo == STV090x_BLIND_SEARCH) || (state->srate < 10000000))\n\t\t\tmsleep(50);  \n\t\telse\n\t\t\tmsleep(5);\n\n\t\tstv090x_get_lock_tmg(state);\n\n\t\tif (!(stv090x_get_dmdlock(state, (state->DemodTimeout / 2)))) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, f_1) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, f_0) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)\n\t\t\t\tgoto err;\n\n\t\t\ti = 0;\n\n\t\t\twhile ((!(stv090x_get_dmdlock(state, (state->DemodTimeout / 2)))) && (i <= 2)) {\n\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT1, f_1) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, CFRINIT0, f_0) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\ti++;\n\t\t\t}\n\t\t}\n\n\t}\n\n\tif (state->internal->dev_ver >= 0x20) {\n\t\tif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x49) < 0)\n\t\t\tgoto err;\n\t}\n\n\tif ((state->delsys == STV090x_DVBS1) || (state->delsys == STV090x_DSS))\n\t\tstv090x_set_vit_thtracq(state);\n\n\treturn 0;\n\nerr_gateoff:\n\tstv090x_i2c_gate_ctrl(state, 0);\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_get_feclock(struct stv090x_state *state, s32 timeout)\n{\n\ts32 timer = 0, lock = 0, stat;\n\tu32 reg;\n\n\twhile ((timer < timeout) && (!lock)) {\n\t\treg = STV090x_READ_DEMOD(state, DMDSTATE);\n\t\tstat = STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD);\n\n\t\tswitch (stat) {\n\t\tcase 0:  \n\t\tcase 1:  \n\t\tdefault:\n\t\t\tlock = 0;\n\t\t\tbreak;\n\n\t\tcase 2:  \n\t\t\treg = STV090x_READ_DEMOD(state, PDELSTATUS1);\n\t\t\tlock = STV090x_GETFIELD_Px(reg, PKTDELIN_LOCK_FIELD);\n\t\t\tbreak;\n\n\t\tcase 3:  \n\t\t\treg = STV090x_READ_DEMOD(state, VSTATUSVIT);\n\t\t\tlock = STV090x_GETFIELD_Px(reg, LOCKEDVIT_FIELD);\n\t\t\tbreak;\n\t\t}\n\t\tif (!lock) {\n\t\t\tmsleep(10);\n\t\t\ttimer += 10;\n\t\t}\n\t}\n\treturn lock;\n}\n\nstatic int stv090x_get_lock(struct stv090x_state *state, s32 timeout_dmd, s32 timeout_fec)\n{\n\tu32 reg;\n\ts32 timer = 0;\n\tint lock;\n\n\tlock = stv090x_get_dmdlock(state, timeout_dmd);\n\tif (lock)\n\t\tlock = stv090x_get_feclock(state, timeout_fec);\n\n\tif (lock) {\n\t\tlock = 0;\n\n\t\twhile ((timer < timeout_fec) && (!lock)) {\n\t\t\treg = STV090x_READ_DEMOD(state, TSSTATUS);\n\t\t\tlock = STV090x_GETFIELD_Px(reg, TSFIFO_LINEOK_FIELD);\n\t\t\tmsleep(1);\n\t\t\ttimer++;\n\t\t}\n\t}\n\n\treturn lock;\n}\n\nstatic int stv090x_set_s2rolloff(struct stv090x_state *state)\n{\n\tu32 reg;\n\n\tif (state->internal->dev_ver <= 0x20) {\n\t\t \n\t\treg = STV090x_READ_DEMOD(state, DEMOD);\n\t\tSTV090x_SETFIELD_Px(reg, MANUAL_SXROLLOFF_FIELD, 0x00);\n\t\tif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\n\t\t\tgoto err;\n\t} else {\n\t\t \n\t\treg = STV090x_READ_DEMOD(state, DEMOD);\n\t\tSTV090x_SETFIELD_Px(reg, MANUAL_S2ROLLOFF_FIELD, 0x00);\n\t\tif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\n\t\t\tgoto err;\n\t}\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\n\nstatic enum stv090x_signal_state stv090x_algo(struct stv090x_state *state)\n{\n\tstruct dvb_frontend *fe = &state->frontend;\n\tenum stv090x_signal_state signal_state = STV090x_NOCARRIER;\n\tu32 reg;\n\ts32 agc1_power, power_iq = 0, i;\n\tint lock = 0, low_sr = 0;\n\n\treg = STV090x_READ_DEMOD(state, TSCFGH);\n\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 1);  \n\tif (STV090x_WRITE_DEMOD(state, TSCFGH, reg) < 0)\n\t\tgoto err;\n\n\tif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x5c) < 0)  \n\t\tgoto err;\n\n\tif (state->internal->dev_ver >= 0x20) {\n\t\tif (state->srate > 5000000) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x9e) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\tif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x82) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t}\n\n\tstv090x_get_lock_tmg(state);\n\n\tif (state->algo == STV090x_BLIND_SEARCH) {\n\t\tstate->tuner_bw = 2 * 36000000;  \n\t\tif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc0) < 0)  \n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, CORRELMANT, 0x70) < 0)\n\t\t\tgoto err;\n\t\tif (stv090x_set_srate(state, 1000000) < 0)  \n\t\t\tgoto err;\n\t} else {\n\t\t \n\t\tif (STV090x_WRITE_DEMOD(state, DMDTOM, 0x20) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, TMGCFG, 0xd2) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->srate < 2000000) {\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, CORRELMANT, 0x63) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, CORRELMANT, 0x70) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->internal->dev_ver >= 0x20) {\n\t\t\tif (STV090x_WRITE_DEMOD(state, KREFTMG, 0x5a) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (state->algo == STV090x_COLD_SEARCH)\n\t\t\t\tstate->tuner_bw = (15 * (stv090x_car_width(state->srate, state->rolloff) + 10000000)) / 10;\n\t\t\telse if (state->algo == STV090x_WARM_SEARCH)\n\t\t\t\tstate->tuner_bw = stv090x_car_width(state->srate, state->rolloff) + 10000000;\n\t\t}\n\n\t\t \n\t\tif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc1) < 0)  \n\t\t\tgoto err;\n\n\t\tif (stv090x_set_srate(state, state->srate) < 0)\n\t\t\tgoto err;\n\n\t\tif (stv090x_set_max_srate(state, state->internal->mclk,\n\t\t\t\t\t  state->srate) < 0)\n\t\t\tgoto err;\n\t\tif (stv090x_set_min_srate(state, state->internal->mclk,\n\t\t\t\t\t  state->srate) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->srate >= 10000000)\n\t\t\tlow_sr = 0;\n\t\telse\n\t\t\tlow_sr = 1;\n\t}\n\n\t \n\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\tgoto err;\n\n\tif (state->config->tuner_set_bbgain) {\n\t\treg = state->config->tuner_bbgain;\n\t\tif (reg == 0)\n\t\t\treg = 10;  \n\t\tif (state->config->tuner_set_bbgain(fe, reg) < 0)\n\t\t\tgoto err_gateoff;\n\t}\n\n\tif (state->config->tuner_set_frequency) {\n\t\tif (state->config->tuner_set_frequency(fe, state->frequency) < 0)\n\t\t\tgoto err_gateoff;\n\t}\n\n\tif (state->config->tuner_set_bandwidth) {\n\t\tif (state->config->tuner_set_bandwidth(fe, state->tuner_bw) < 0)\n\t\t\tgoto err_gateoff;\n\t}\n\n\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\tgoto err;\n\n\tmsleep(50);\n\n\tif (state->config->tuner_get_status) {\n\t\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\t\tgoto err;\n\t\tif (state->config->tuner_get_status(fe, &reg) < 0)\n\t\t\tgoto err_gateoff;\n\t\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\t\tgoto err;\n\n\t\tif (reg)\n\t\t\tdprintk(FE_DEBUG, 1, \"Tuner phase locked\");\n\t\telse {\n\t\t\tdprintk(FE_DEBUG, 1, \"Tuner unlocked\");\n\t\t\treturn STV090x_NOCARRIER;\n\t\t}\n\t}\n\n\tmsleep(10);\n\tagc1_power = MAKEWORD16(STV090x_READ_DEMOD(state, AGCIQIN1),\n\t\t\t\tSTV090x_READ_DEMOD(state, AGCIQIN0));\n\n\tif (agc1_power == 0) {\n\t\t \n\t\tfor (i = 0; i < 5; i++) {\n\t\t\tpower_iq += (STV090x_READ_DEMOD(state, POWERI) +\n\t\t\t\t     STV090x_READ_DEMOD(state, POWERQ)) >> 1;\n\t\t}\n\t\tpower_iq /= 5;\n\t}\n\n\tif ((agc1_power == 0) && (power_iq < STV090x_IQPOWER_THRESHOLD)) {\n\t\tdprintk(FE_ERROR, 1, \"No Signal: POWER_IQ=0x%02x\", power_iq);\n\t\tlock = 0;\n\t\tsignal_state = STV090x_NOAGC1;\n\t} else {\n\t\treg = STV090x_READ_DEMOD(state, DEMOD);\n\t\tSTV090x_SETFIELD_Px(reg, SPECINV_CONTROL_FIELD, state->inversion);\n\n\t\tif (state->internal->dev_ver <= 0x20) {\n\t\t\t \n\t\t\tSTV090x_SETFIELD_Px(reg, MANUAL_SXROLLOFF_FIELD, 1);\n\t\t} else {\n\t\t\t \n\t\t\tSTV090x_SETFIELD_Px(reg, MANUAL_S2ROLLOFF_FIELD, 1);\n\t\t}\n\t\tif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\n\t\t\tgoto err;\n\n\t\tif (stv090x_delivery_search(state) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->algo != STV090x_BLIND_SEARCH) {\n\t\t\tif (stv090x_start_search(state) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t}\n\n\tif (signal_state == STV090x_NOAGC1)\n\t\treturn signal_state;\n\n\tif (state->algo == STV090x_BLIND_SEARCH)\n\t\tlock = stv090x_blind_search(state);\n\n\telse if (state->algo == STV090x_COLD_SEARCH)\n\t\tlock = stv090x_get_coldlock(state, state->DemodTimeout);\n\n\telse if (state->algo == STV090x_WARM_SEARCH)\n\t\tlock = stv090x_get_dmdlock(state, state->DemodTimeout);\n\n\tif ((!lock) && (state->algo == STV090x_COLD_SEARCH)) {\n\t\tif (!low_sr) {\n\t\t\tif (stv090x_chk_tmg(state))\n\t\t\t\tlock = stv090x_sw_algo(state);\n\t\t}\n\t}\n\n\tif (lock)\n\t\tsignal_state = stv090x_get_sig_params(state);\n\n\tif ((lock) && (signal_state == STV090x_RANGEOK)) {  \n\t\tstv090x_optimize_track(state);\n\n\t\tif (state->internal->dev_ver >= 0x20) {\n\t\t\t \n\t\t\treg = STV090x_READ_DEMOD(state, TSCFGH);\n\t\t\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0);  \n\t\t\tif (STV090x_WRITE_DEMOD(state, TSCFGH, reg) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tmsleep(3);\n\n\t\t\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 1);  \n\t\t\tif (STV090x_WRITE_DEMOD(state, TSCFGH, reg) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0);  \n\t\t\tif (STV090x_WRITE_DEMOD(state, TSCFGH, reg) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tlock = stv090x_get_lock(state, state->FecTimeout,\n\t\t\t\tstate->FecTimeout);\n\t\tif (lock) {\n\t\t\tif (state->delsys == STV090x_DVBS2) {\n\t\t\t\tstv090x_set_s2rolloff(state);\n\n\t\t\t\treg = STV090x_READ_DEMOD(state, PDELCTRL2);\n\t\t\t\tSTV090x_SETFIELD_Px(reg, RESET_UPKO_COUNT, 1);\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, PDELCTRL2, reg) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\t \n\t\t\t\treg = STV090x_READ_DEMOD(state, PDELCTRL2);\n\t\t\t\tSTV090x_SETFIELD_Px(reg, RESET_UPKO_COUNT, 0);\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, PDELCTRL2, reg) < 0)\n\t\t\t\t\tgoto err;\n\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ERRCTRL1, 0x67) < 0)  \n\t\t\t\t\tgoto err;\n\t\t\t} else {\n\t\t\t\tif (STV090x_WRITE_DEMOD(state, ERRCTRL1, 0x75) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t}\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, FBERCPT4, 0x00) < 0)\n\t\t\t\tgoto err;\n\t\t\t \n\t\t\tif (STV090x_WRITE_DEMOD(state, ERRCTRL2, 0xc1) < 0)\n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\tsignal_state = STV090x_NODATA;\n\t\t\tstv090x_chk_signal(state);\n\t\t}\n\t}\n\treturn signal_state;\n\nerr_gateoff:\n\tstv090x_i2c_gate_ctrl(state, 0);\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_set_pls(struct stv090x_state *state, u32 pls_code)\n{\n\tdprintk(FE_DEBUG, 1, \"Set Gold PLS code %d\", pls_code);\n\tif (STV090x_WRITE_DEMOD(state, PLROOT0, pls_code & 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, PLROOT1, (pls_code >> 8) & 0xff) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, PLROOT2, 0x04 | (pls_code >> 16)) < 0)\n\t\tgoto err;\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_set_mis(struct stv090x_state *state, int mis)\n{\n\tu32 reg;\n\n\tif (mis < 0 || mis > 255) {\n\t\tdprintk(FE_DEBUG, 1, \"Disable MIS filtering\");\n\t\treg = STV090x_READ_DEMOD(state, PDELCTRL1);\n\t\tSTV090x_SETFIELD_Px(reg, FILTER_EN_FIELD, 0x00);\n\t\tif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\n\t\t\tgoto err;\n\t} else {\n\t\tdprintk(FE_DEBUG, 1, \"Enable MIS filtering - %d\", mis);\n\t\treg = STV090x_READ_DEMOD(state, PDELCTRL1);\n\t\tSTV090x_SETFIELD_Px(reg, FILTER_EN_FIELD, 0x01);\n\t\tif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, ISIENTRY, mis) < 0)\n\t\t\tgoto err;\n\t\tif (STV090x_WRITE_DEMOD(state, ISIBITENA, 0xff) < 0)\n\t\t\tgoto err;\n\t}\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic enum dvbfe_search stv090x_search(struct dvb_frontend *fe)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tstruct dtv_frontend_properties *props = &fe->dtv_property_cache;\n\n\tif (props->frequency == 0)\n\t\treturn DVBFE_ALGO_SEARCH_INVALID;\n\n\tswitch (props->delivery_system) {\n\tcase SYS_DSS:\n\t\tstate->delsys = STV090x_DSS;\n\t\tbreak;\n\tcase SYS_DVBS:\n\t\tstate->delsys = STV090x_DVBS1;\n\t\tbreak;\n\tcase SYS_DVBS2:\n\t\tstate->delsys = STV090x_DVBS2;\n\t\tbreak;\n\tdefault:\n\t\treturn DVBFE_ALGO_SEARCH_INVALID;\n\t}\n\n\tstate->frequency = props->frequency;\n\tstate->srate = props->symbol_rate;\n\tstate->search_mode = STV090x_SEARCH_AUTO;\n\tstate->algo = STV090x_COLD_SEARCH;\n\tstate->fec = STV090x_PRERR;\n\tif (state->srate > 10000000) {\n\t\tdprintk(FE_DEBUG, 1, \"Search range: 10 MHz\");\n\t\tstate->search_range = 10000000;\n\t} else {\n\t\tdprintk(FE_DEBUG, 1, \"Search range: 5 MHz\");\n\t\tstate->search_range = 5000000;\n\t}\n\n\tstv090x_set_pls(state, props->scrambling_sequence_index);\n\tstv090x_set_mis(state, props->stream_id);\n\n\tif (stv090x_algo(state) == STV090x_RANGEOK) {\n\t\tdprintk(FE_DEBUG, 1, \"Search success!\");\n\t\treturn DVBFE_ALGO_SEARCH_SUCCESS;\n\t} else {\n\t\tdprintk(FE_DEBUG, 1, \"Search failed!\");\n\t\treturn DVBFE_ALGO_SEARCH_FAILED;\n\t}\n\n\treturn DVBFE_ALGO_SEARCH_ERROR;\n}\n\nstatic int stv090x_read_status(struct dvb_frontend *fe, enum fe_status *status)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu32 reg, dstatus;\n\tu8 search_state;\n\n\t*status = 0;\n\n\tdstatus = STV090x_READ_DEMOD(state, DSTATUS);\n\tif (STV090x_GETFIELD_Px(dstatus, CAR_LOCK_FIELD))\n\t\t*status |= FE_HAS_SIGNAL | FE_HAS_CARRIER;\n\n\treg = STV090x_READ_DEMOD(state, DMDSTATE);\n\tsearch_state = STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD);\n\n\tswitch (search_state) {\n\tcase 0:  \n\tcase 1:  \n\tdefault:\n\t\tdprintk(FE_DEBUG, 1, \"Status: Unlocked (Searching ..)\");\n\t\tbreak;\n\n\tcase 2:  \n\t\tdprintk(FE_DEBUG, 1, \"Delivery system: DVB-S2\");\n\t\tif (STV090x_GETFIELD_Px(dstatus, LOCK_DEFINITIF_FIELD)) {\n\t\t\treg = STV090x_READ_DEMOD(state, PDELSTATUS1);\n\t\t\tif (STV090x_GETFIELD_Px(reg, PKTDELIN_LOCK_FIELD)) {\n\t\t\t\t*status |= FE_HAS_VITERBI;\n\t\t\t\treg = STV090x_READ_DEMOD(state, TSSTATUS);\n\t\t\t\tif (STV090x_GETFIELD_Px(reg, TSFIFO_LINEOK_FIELD))\n\t\t\t\t\t*status |= FE_HAS_SYNC | FE_HAS_LOCK;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tcase 3:  \n\t\tdprintk(FE_DEBUG, 1, \"Delivery system: DVB-S\");\n\t\tif (STV090x_GETFIELD_Px(dstatus, LOCK_DEFINITIF_FIELD)) {\n\t\t\treg = STV090x_READ_DEMOD(state, VSTATUSVIT);\n\t\t\tif (STV090x_GETFIELD_Px(reg, LOCKEDVIT_FIELD)) {\n\t\t\t\t*status |= FE_HAS_VITERBI;\n\t\t\t\treg = STV090x_READ_DEMOD(state, TSSTATUS);\n\t\t\t\tif (STV090x_GETFIELD_Px(reg, TSFIFO_LINEOK_FIELD))\n\t\t\t\t\t*status |= FE_HAS_SYNC | FE_HAS_LOCK;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int stv090x_read_per(struct dvb_frontend *fe, u32 *per)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\n\ts32 count_4, count_3, count_2, count_1, count_0, count;\n\tu32 reg, h, m, l;\n\tenum fe_status status;\n\n\tstv090x_read_status(fe, &status);\n\tif (!(status & FE_HAS_LOCK)) {\n\t\t*per = 1 << 23;  \n\t} else {\n\t\t \n\t\treg = STV090x_READ_DEMOD(state, ERRCNT22);\n\t\th = STV090x_GETFIELD_Px(reg, ERR_CNT2_FIELD);\n\n\t\treg = STV090x_READ_DEMOD(state, ERRCNT21);\n\t\tm = STV090x_GETFIELD_Px(reg, ERR_CNT21_FIELD);\n\n\t\treg = STV090x_READ_DEMOD(state, ERRCNT20);\n\t\tl = STV090x_GETFIELD_Px(reg, ERR_CNT20_FIELD);\n\n\t\t*per = ((h << 16) | (m << 8) | l);\n\n\t\tcount_4 = STV090x_READ_DEMOD(state, FBERCPT4);\n\t\tcount_3 = STV090x_READ_DEMOD(state, FBERCPT3);\n\t\tcount_2 = STV090x_READ_DEMOD(state, FBERCPT2);\n\t\tcount_1 = STV090x_READ_DEMOD(state, FBERCPT1);\n\t\tcount_0 = STV090x_READ_DEMOD(state, FBERCPT0);\n\n\t\tif ((!count_4) && (!count_3)) {\n\t\t\tcount  = (count_2 & 0xff) << 16;\n\t\t\tcount |= (count_1 & 0xff) <<  8;\n\t\t\tcount |=  count_0 & 0xff;\n\t\t} else {\n\t\t\tcount = 1 << 24;\n\t\t}\n\t\tif (count == 0)\n\t\t\t*per = 1;\n\t}\n\tif (STV090x_WRITE_DEMOD(state, FBERCPT4, 0) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, ERRCTRL2, 0xc1) < 0)\n\t\tgoto err;\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_table_lookup(const struct stv090x_tab *tab, int max, int val)\n{\n\tint res = 0;\n\tint min = 0, med;\n\n\tif ((val >= tab[min].read && val < tab[max].read) ||\n\t    (val >= tab[max].read && val < tab[min].read)) {\n\t\twhile ((max - min) > 1) {\n\t\t\tmed = (max + min) / 2;\n\t\t\tif ((val >= tab[min].read && val < tab[med].read) ||\n\t\t\t    (val >= tab[med].read && val < tab[min].read))\n\t\t\t\tmax = med;\n\t\t\telse\n\t\t\t\tmin = med;\n\t\t}\n\t\tres = ((val - tab[min].read) *\n\t\t       (tab[max].real - tab[min].real) /\n\t\t       (tab[max].read - tab[min].read)) +\n\t\t\ttab[min].real;\n\t} else {\n\t\tif (tab[min].read < tab[max].read) {\n\t\t\tif (val < tab[min].read)\n\t\t\t\tres = tab[min].real;\n\t\t\telse if (val >= tab[max].read)\n\t\t\t\tres = tab[max].real;\n\t\t} else {\n\t\t\tif (val >= tab[min].read)\n\t\t\t\tres = tab[min].real;\n\t\t\telse if (val < tab[max].read)\n\t\t\t\tres = tab[max].real;\n\t\t}\n\t}\n\n\treturn res;\n}\n\nstatic int stv090x_read_signal_strength(struct dvb_frontend *fe, u16 *strength)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu32 reg;\n\ts32 agc_0, agc_1, agc;\n\ts32 str;\n\n\treg = STV090x_READ_DEMOD(state, AGCIQIN1);\n\tagc_1 = STV090x_GETFIELD_Px(reg, AGCIQ_VALUE_FIELD);\n\treg = STV090x_READ_DEMOD(state, AGCIQIN0);\n\tagc_0 = STV090x_GETFIELD_Px(reg, AGCIQ_VALUE_FIELD);\n\tagc = MAKEWORD16(agc_1, agc_0);\n\n\tstr = stv090x_table_lookup(stv090x_rf_tab,\n\t\tARRAY_SIZE(stv090x_rf_tab) - 1, agc);\n\tif (agc > stv090x_rf_tab[0].read)\n\t\tstr = 0;\n\telse if (agc < stv090x_rf_tab[ARRAY_SIZE(stv090x_rf_tab) - 1].read)\n\t\tstr = -100;\n\t*strength = (str + 100) * 0xFFFF / 100;\n\n\treturn 0;\n}\n\nstatic int stv090x_read_cnr(struct dvb_frontend *fe, u16 *cnr)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu32 reg_0, reg_1, reg, i;\n\ts32 val_0, val_1, val = 0;\n\tu8 lock_f;\n\ts32 div;\n\tu32 last;\n\n\tswitch (state->delsys) {\n\tcase STV090x_DVBS2:\n\t\treg = STV090x_READ_DEMOD(state, DSTATUS);\n\t\tlock_f = STV090x_GETFIELD_Px(reg, LOCK_DEFINITIF_FIELD);\n\t\tif (lock_f) {\n\t\t\tmsleep(5);\n\t\t\tfor (i = 0; i < 16; i++) {\n\t\t\t\treg_1 = STV090x_READ_DEMOD(state, NNOSPLHT1);\n\t\t\t\tval_1 = STV090x_GETFIELD_Px(reg_1, NOSPLHT_NORMED_FIELD);\n\t\t\t\treg_0 = STV090x_READ_DEMOD(state, NNOSPLHT0);\n\t\t\t\tval_0 = STV090x_GETFIELD_Px(reg_0, NOSPLHT_NORMED_FIELD);\n\t\t\t\tval  += MAKEWORD16(val_1, val_0);\n\t\t\t\tmsleep(1);\n\t\t\t}\n\t\t\tval /= 16;\n\t\t\tlast = ARRAY_SIZE(stv090x_s2cn_tab) - 1;\n\t\t\tdiv = stv090x_s2cn_tab[last].real -\n\t\t\t      stv090x_s2cn_tab[3].real;\n\t\t\tval = stv090x_table_lookup(stv090x_s2cn_tab, last, val);\n\t\t\tif (val < 0)\n\t\t\t\tval = 0;\n\t\t\t*cnr = val * 0xFFFF / div;\n\t\t}\n\t\tbreak;\n\n\tcase STV090x_DVBS1:\n\tcase STV090x_DSS:\n\t\treg = STV090x_READ_DEMOD(state, DSTATUS);\n\t\tlock_f = STV090x_GETFIELD_Px(reg, LOCK_DEFINITIF_FIELD);\n\t\tif (lock_f) {\n\t\t\tmsleep(5);\n\t\t\tfor (i = 0; i < 16; i++) {\n\t\t\t\treg_1 = STV090x_READ_DEMOD(state, NOSDATAT1);\n\t\t\t\tval_1 = STV090x_GETFIELD_Px(reg_1, NOSDATAT_UNNORMED_FIELD);\n\t\t\t\treg_0 = STV090x_READ_DEMOD(state, NOSDATAT0);\n\t\t\t\tval_0 = STV090x_GETFIELD_Px(reg_0, NOSDATAT_UNNORMED_FIELD);\n\t\t\t\tval  += MAKEWORD16(val_1, val_0);\n\t\t\t\tmsleep(1);\n\t\t\t}\n\t\t\tval /= 16;\n\t\t\tlast = ARRAY_SIZE(stv090x_s1cn_tab) - 1;\n\t\t\tdiv = stv090x_s1cn_tab[last].real -\n\t\t\t      stv090x_s1cn_tab[0].real;\n\t\t\tval = stv090x_table_lookup(stv090x_s1cn_tab, last, val);\n\t\t\t*cnr = val * 0xFFFF / div;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int stv090x_set_tone(struct dvb_frontend *fe, enum fe_sec_tone_mode tone)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu32 reg;\n\n\treg = STV090x_READ_DEMOD(state, DISTXCTL);\n\tswitch (tone) {\n\tcase SEC_TONE_ON:\n\t\tSTV090x_SETFIELD_Px(reg, DISTX_MODE_FIELD, 0);\n\t\tSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 1);\n\t\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\t\tgoto err;\n\t\tSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 0);\n\t\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase SEC_TONE_OFF:\n\t\tSTV090x_SETFIELD_Px(reg, DISTX_MODE_FIELD, 0);\n\t\tSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 1);\n\t\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\n\nstatic enum dvbfe_algo stv090x_frontend_algo(struct dvb_frontend *fe)\n{\n\treturn DVBFE_ALGO_CUSTOM;\n}\n\nstatic int stv090x_send_diseqc_msg(struct dvb_frontend *fe, struct dvb_diseqc_master_cmd *cmd)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu32 reg, idle = 0, fifo_full = 1;\n\tint i;\n\n\treg = STV090x_READ_DEMOD(state, DISTXCTL);\n\n\tSTV090x_SETFIELD_Px(reg, DISTX_MODE_FIELD,\n\t\t(state->config->diseqc_envelope_mode) ? 4 : 2);\n\tSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 1);\n\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\tgoto err;\n\tSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 0);\n\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\tgoto err;\n\n\tSTV090x_SETFIELD_Px(reg, DIS_PRECHARGE_FIELD, 1);\n\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\tgoto err;\n\n\tfor (i = 0; i < cmd->msg_len; i++) {\n\n\t\twhile (fifo_full) {\n\t\t\treg = STV090x_READ_DEMOD(state, DISTXSTATUS);\n\t\t\tfifo_full = STV090x_GETFIELD_Px(reg, FIFO_FULL_FIELD);\n\t\t}\n\n\t\tif (STV090x_WRITE_DEMOD(state, DISTXDATA, cmd->msg[i]) < 0)\n\t\t\tgoto err;\n\t}\n\treg = STV090x_READ_DEMOD(state, DISTXCTL);\n\tSTV090x_SETFIELD_Px(reg, DIS_PRECHARGE_FIELD, 0);\n\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\tgoto err;\n\n\ti = 0;\n\n\twhile ((!idle) && (i < 10)) {\n\t\treg = STV090x_READ_DEMOD(state, DISTXSTATUS);\n\t\tidle = STV090x_GETFIELD_Px(reg, TX_IDLE_FIELD);\n\t\tmsleep(10);\n\t\ti++;\n\t}\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_send_diseqc_burst(struct dvb_frontend *fe,\n\t\t\t\t     enum fe_sec_mini_cmd burst)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu32 reg, idle = 0, fifo_full = 1;\n\tu8 mode, value;\n\tint i;\n\n\treg = STV090x_READ_DEMOD(state, DISTXCTL);\n\n\tif (burst == SEC_MINI_A) {\n\t\tmode = (state->config->diseqc_envelope_mode) ? 5 : 3;\n\t\tvalue = 0x00;\n\t} else {\n\t\tmode = (state->config->diseqc_envelope_mode) ? 4 : 2;\n\t\tvalue = 0xFF;\n\t}\n\n\tSTV090x_SETFIELD_Px(reg, DISTX_MODE_FIELD, mode);\n\tSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 1);\n\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\tgoto err;\n\tSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 0);\n\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\tgoto err;\n\n\tSTV090x_SETFIELD_Px(reg, DIS_PRECHARGE_FIELD, 1);\n\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\tgoto err;\n\n\twhile (fifo_full) {\n\t\treg = STV090x_READ_DEMOD(state, DISTXSTATUS);\n\t\tfifo_full = STV090x_GETFIELD_Px(reg, FIFO_FULL_FIELD);\n\t}\n\n\tif (STV090x_WRITE_DEMOD(state, DISTXDATA, value) < 0)\n\t\tgoto err;\n\n\treg = STV090x_READ_DEMOD(state, DISTXCTL);\n\tSTV090x_SETFIELD_Px(reg, DIS_PRECHARGE_FIELD, 0);\n\tif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\n\t\tgoto err;\n\n\ti = 0;\n\n\twhile ((!idle) && (i < 10)) {\n\t\treg = STV090x_READ_DEMOD(state, DISTXSTATUS);\n\t\tidle = STV090x_GETFIELD_Px(reg, TX_IDLE_FIELD);\n\t\tmsleep(10);\n\t\ti++;\n\t}\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_recv_slave_reply(struct dvb_frontend *fe, struct dvb_diseqc_slave_reply *reply)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu32 reg = 0, i = 0, rx_end = 0;\n\n\twhile ((rx_end != 1) && (i < 10)) {\n\t\tmsleep(10);\n\t\ti++;\n\t\treg = STV090x_READ_DEMOD(state, DISRX_ST0);\n\t\trx_end = STV090x_GETFIELD_Px(reg, RX_END_FIELD);\n\t}\n\n\tif (rx_end) {\n\t\treply->msg_len = STV090x_GETFIELD_Px(reg, FIFO_BYTENBR_FIELD);\n\t\tfor (i = 0; i < reply->msg_len; i++)\n\t\t\treply->msg[i] = STV090x_READ_DEMOD(state, DISRXDATA);\n\t}\n\n\treturn 0;\n}\n\nstatic int stv090x_sleep(struct dvb_frontend *fe)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu32 reg;\n\tu8 full_standby = 0;\n\n\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\tgoto err;\n\n\tif (state->config->tuner_sleep) {\n\t\tif (state->config->tuner_sleep(fe) < 0)\n\t\t\tgoto err_gateoff;\n\t}\n\n\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\tgoto err;\n\n\tdprintk(FE_DEBUG, 1, \"Set %s(%d) to sleep\",\n\t\tstate->device == STV0900 ? \"STV0900\" : \"STV0903\",\n\t\tstate->demod);\n\n\tmutex_lock(&state->internal->demod_lock);\n\n\tswitch (state->demod) {\n\tcase STV090x_DEMODULATOR_0:\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR1);\n\t\tSTV090x_SETFIELD(reg, ADC1_PON_FIELD, 0);\n\t\tif (stv090x_write_reg(state, STV090x_TSTTNR1, reg) < 0)\n\t\t\tgoto err_unlock;\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR2);\n\t\tSTV090x_SETFIELD(reg, DISEQC1_PON_FIELD, 0);\n\t\tif (stv090x_write_reg(state, STV090x_TSTTNR2, reg) < 0)\n\t\t\tgoto err_unlock;\n\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR3);\n\t\tif (STV090x_GETFIELD(reg, ADC2_PON_FIELD) == 0)\n\t\t\tfull_standby = 1;\n\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK1);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKPKDT1_FIELD, 1);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKADCI1_FIELD, 1);\n\t\t \n\t\tif (full_standby)\n\t\t\tSTV090x_SETFIELD(reg, STOP_CLKFEC_FIELD, 1);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK1, reg) < 0)\n\t\t\tgoto err_unlock;\n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK2);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKSAMP1_FIELD, 1);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKVIT1_FIELD, 1);\n\t\t \n\t\tif (full_standby)\n\t\t\tSTV090x_SETFIELD(reg, STOP_CLKTS_FIELD, 1);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\n\t\t\tgoto err_unlock;\n\t\tbreak;\n\n\tcase STV090x_DEMODULATOR_1:\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR3);\n\t\tSTV090x_SETFIELD(reg, ADC2_PON_FIELD, 0);\n\t\tif (stv090x_write_reg(state, STV090x_TSTTNR3, reg) < 0)\n\t\t\tgoto err_unlock;\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR4);\n\t\tSTV090x_SETFIELD(reg, DISEQC2_PON_FIELD, 0);\n\t\tif (stv090x_write_reg(state, STV090x_TSTTNR4, reg) < 0)\n\t\t\tgoto err_unlock;\n\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR1);\n\t\tif (STV090x_GETFIELD(reg, ADC1_PON_FIELD) == 0)\n\t\t\tfull_standby = 1;\n\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK1);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKPKDT2_FIELD, 1);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKADCI2_FIELD, 1);\n\t\t \n\t\tif (full_standby)\n\t\t\tSTV090x_SETFIELD(reg, STOP_CLKFEC_FIELD, 1);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK1, reg) < 0)\n\t\t\tgoto err_unlock;\n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK2);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKSAMP2_FIELD, 1);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKVIT2_FIELD, 1);\n\t\t \n\t\tif (full_standby)\n\t\t\tSTV090x_SETFIELD(reg, STOP_CLKTS_FIELD, 1);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\n\t\t\tgoto err_unlock;\n\t\tbreak;\n\n\tdefault:\n\t\tdprintk(FE_ERROR, 1, \"Wrong demodulator!\");\n\t\tbreak;\n\t}\n\n\tif (full_standby) {\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_SYNTCTRL);\n\t\tSTV090x_SETFIELD(reg, STANDBY_FIELD, 0x01);\n\t\tif (stv090x_write_reg(state, STV090x_SYNTCTRL, reg) < 0)\n\t\t\tgoto err_unlock;\n\t}\n\n\tmutex_unlock(&state->internal->demod_lock);\n\treturn 0;\n\nerr_gateoff:\n\tstv090x_i2c_gate_ctrl(state, 0);\n\tgoto err;\nerr_unlock:\n\tmutex_unlock(&state->internal->demod_lock);\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_wakeup(struct dvb_frontend *fe)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu32 reg;\n\n\tdprintk(FE_DEBUG, 1, \"Wake %s(%d) from standby\",\n\t\tstate->device == STV0900 ? \"STV0900\" : \"STV0903\",\n\t\tstate->demod);\n\n\tmutex_lock(&state->internal->demod_lock);\n\n\t \n\treg = stv090x_read_reg(state, STV090x_SYNTCTRL);\n\tSTV090x_SETFIELD(reg, STANDBY_FIELD, 0x00);\n\tif (stv090x_write_reg(state, STV090x_SYNTCTRL, reg) < 0)\n\t\tgoto err;\n\n\tswitch (state->demod) {\n\tcase STV090x_DEMODULATOR_0:\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR1);\n\t\tSTV090x_SETFIELD(reg, ADC1_PON_FIELD, 1);\n\t\tif (stv090x_write_reg(state, STV090x_TSTTNR1, reg) < 0)\n\t\t\tgoto err;\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR2);\n\t\tSTV090x_SETFIELD(reg, DISEQC1_PON_FIELD, 1);\n\t\tif (stv090x_write_reg(state, STV090x_TSTTNR2, reg) < 0)\n\t\t\tgoto err;\n\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK1);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKPKDT1_FIELD, 0);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKADCI1_FIELD, 0);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKFEC_FIELD, 0);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK1, reg) < 0)\n\t\t\tgoto err;\n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK2);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKSAMP1_FIELD, 0);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKVIT1_FIELD, 0);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKTS_FIELD, 0);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_DEMODULATOR_1:\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR3);\n\t\tSTV090x_SETFIELD(reg, ADC2_PON_FIELD, 1);\n\t\tif (stv090x_write_reg(state, STV090x_TSTTNR3, reg) < 0)\n\t\t\tgoto err;\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_TSTTNR4);\n\t\tSTV090x_SETFIELD(reg, DISEQC2_PON_FIELD, 1);\n\t\tif (stv090x_write_reg(state, STV090x_TSTTNR4, reg) < 0)\n\t\t\tgoto err;\n\n\t\t \n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK1);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKPKDT2_FIELD, 0);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKADCI2_FIELD, 0);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKFEC_FIELD, 0);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK1, reg) < 0)\n\t\t\tgoto err;\n\t\treg = stv090x_read_reg(state, STV090x_STOPCLK2);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKSAMP2_FIELD, 0);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKVIT2_FIELD, 0);\n\t\t \n\t\tSTV090x_SETFIELD(reg, STOP_CLKTS_FIELD, 0);\n\t\tif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tdefault:\n\t\tdprintk(FE_ERROR, 1, \"Wrong demodulator!\");\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&state->internal->demod_lock);\n\treturn 0;\nerr:\n\tmutex_unlock(&state->internal->demod_lock);\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic void stv090x_release(struct dvb_frontend *fe)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\n\tstate->internal->num_used--;\n\tif (state->internal->num_used <= 0) {\n\n\t\tdprintk(FE_ERROR, 1, \"Actually removing\");\n\n\t\tremove_dev(state->internal);\n\t\tkfree(state->internal);\n\t}\n\n\tkfree(state);\n}\n\nstatic int stv090x_ldpc_mode(struct stv090x_state *state, enum stv090x_mode ldpc_mode)\n{\n\tu32 reg = 0;\n\n\treg = stv090x_read_reg(state, STV090x_GENCFG);\n\n\tswitch (ldpc_mode) {\n\tcase STV090x_DUAL:\n\tdefault:\n\t\tif ((state->demod_mode != STV090x_DUAL) || (STV090x_GETFIELD(reg, DDEMOD_FIELD) != 1)) {\n\t\t\t \n\t\t\tif (stv090x_write_reg(state, STV090x_GENCFG, 0x1d) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tstate->demod_mode = STV090x_DUAL;\n\n\t\t\treg = stv090x_read_reg(state, STV090x_TSTRES0);\n\t\t\tSTV090x_SETFIELD(reg, FRESFEC_FIELD, 0x1);\n\t\t\tif (stv090x_write_reg(state, STV090x_TSTRES0, reg) < 0)\n\t\t\t\tgoto err;\n\t\t\tSTV090x_SETFIELD(reg, FRESFEC_FIELD, 0x0);\n\t\t\tif (stv090x_write_reg(state, STV090x_TSTRES0, reg) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST0, 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST1, 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST2, 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST3, 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST4, 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST5, 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST6, 0xff) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST7, 0xcc) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST8, 0xcc) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLST9, 0xcc) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLSTA, 0xcc) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLSTB, 0xcc) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLSTC, 0xcc) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLSTD, 0xcc) < 0)\n\t\t\t\tgoto err;\n\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLSTE, 0xff) < 0)\n\t\t\t\tgoto err;\n\t\t\tif (STV090x_WRITE_DEMOD(state, MODCODLSTF, 0xcf) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\t\tbreak;\n\n\tcase STV090x_SINGLE:\n\t\tif (stv090x_stop_modcod(state) < 0)\n\t\t\tgoto err;\n\t\tif (stv090x_activate_modcod_single(state) < 0)\n\t\t\tgoto err;\n\n\t\tif (state->demod == STV090x_DEMODULATOR_1) {\n\t\t\tif (stv090x_write_reg(state, STV090x_GENCFG, 0x06) < 0)  \n\t\t\t\tgoto err;\n\t\t} else {\n\t\t\tif (stv090x_write_reg(state, STV090x_GENCFG, 0x04) < 0)  \n\t\t\t\tgoto err;\n\t\t}\n\n\t\treg = stv090x_read_reg(state, STV090x_TSTRES0);\n\t\tSTV090x_SETFIELD(reg, FRESFEC_FIELD, 0x1);\n\t\tif (stv090x_write_reg(state, STV090x_TSTRES0, reg) < 0)\n\t\t\tgoto err;\n\t\tSTV090x_SETFIELD(reg, FRESFEC_FIELD, 0x0);\n\t\tif (stv090x_write_reg(state, STV090x_TSTRES0, reg) < 0)\n\t\t\tgoto err;\n\n\t\treg = STV090x_READ_DEMOD(state, PDELCTRL1);\n\t\tSTV090x_SETFIELD_Px(reg, ALGOSWRST_FIELD, 0x01);\n\t\tif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\n\t\t\tgoto err;\n\t\tSTV090x_SETFIELD_Px(reg, ALGOSWRST_FIELD, 0x00);\n\t\tif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\t}\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\n \nstatic u32 stv090x_get_mclk(struct stv090x_state *state)\n{\n\tconst struct stv090x_config *config = state->config;\n\tu32 div, reg;\n\tu8 ratio;\n\n\tdiv = stv090x_read_reg(state, STV090x_NCOARSE);\n\treg = stv090x_read_reg(state, STV090x_SYNTCTRL);\n\tratio = STV090x_GETFIELD(reg, SELX1RATIO_FIELD) ? 4 : 6;\n\n\treturn (div + 1) * config->xtal / ratio;  \n}\n\nstatic int stv090x_set_mclk(struct stv090x_state *state, u32 mclk, u32 clk)\n{\n\tconst struct stv090x_config *config = state->config;\n\tu32 reg, div, clk_sel;\n\n\treg = stv090x_read_reg(state, STV090x_SYNTCTRL);\n\tclk_sel = ((STV090x_GETFIELD(reg, SELX1RATIO_FIELD) == 1) ? 4 : 6);\n\n\tdiv = ((clk_sel * mclk) / config->xtal) - 1;\n\n\treg = stv090x_read_reg(state, STV090x_NCOARSE);\n\tSTV090x_SETFIELD(reg, M_DIV_FIELD, div);\n\tif (stv090x_write_reg(state, STV090x_NCOARSE, reg) < 0)\n\t\tgoto err;\n\n\tstate->internal->mclk = stv090x_get_mclk(state);\n\n\t \n\tdiv = state->internal->mclk / 704000;\n\tif (STV090x_WRITE_DEMOD(state, F22TX, div) < 0)\n\t\tgoto err;\n\tif (STV090x_WRITE_DEMOD(state, F22RX, div) < 0)\n\t\tgoto err;\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv0900_set_tspath(struct stv090x_state *state)\n{\n\tu32 reg;\n\n\tif (state->internal->dev_ver >= 0x20) {\n\t\tswitch (state->config->ts1_mode) {\n\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\tcase STV090x_TSMODE_DVBCI:\n\t\t\tswitch (state->config->ts2_mode) {\n\t\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\t\tdefault:\n\t\t\t\tstv090x_write_reg(state, STV090x_TSGENERAL, 0x00);\n\t\t\t\tbreak;\n\n\t\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\t\tcase STV090x_TSMODE_DVBCI:\n\t\t\t\tif (stv090x_write_reg(state, STV090x_TSGENERAL, 0x06) < 0)  \n\t\t\t\t\tgoto err;\n\t\t\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGM);\n\t\t\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\n\t\t\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGM, reg) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\treg = stv090x_read_reg(state, STV090x_P2_TSCFGM);\n\t\t\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\n\t\t\t\tif (stv090x_write_reg(state, STV090x_P2_TSCFGM, reg) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (stv090x_write_reg(state, STV090x_P1_TSSPEED, 0x14) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (stv090x_write_reg(state, STV090x_P2_TSSPEED, 0x28) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\tdefault:\n\t\t\tswitch (state->config->ts2_mode) {\n\t\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\t\tdefault:\n\t\t\t\tif (stv090x_write_reg(state, STV090x_TSGENERAL, 0x0c) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tbreak;\n\n\t\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\t\tcase STV090x_TSMODE_DVBCI:\n\t\t\t\tif (stv090x_write_reg(state, STV090x_TSGENERAL, 0x0a) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tswitch (state->config->ts1_mode) {\n\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\tcase STV090x_TSMODE_DVBCI:\n\t\t\tswitch (state->config->ts2_mode) {\n\t\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\t\tdefault:\n\t\t\t\tstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x10);\n\t\t\t\tbreak;\n\n\t\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\t\tcase STV090x_TSMODE_DVBCI:\n\t\t\t\tstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x16);\n\t\t\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGM);\n\t\t\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\n\t\t\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGM, reg) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGM);\n\t\t\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 0);\n\t\t\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGM, reg) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (stv090x_write_reg(state, STV090x_P1_TSSPEED, 0x14) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tif (stv090x_write_reg(state, STV090x_P2_TSSPEED, 0x28) < 0)\n\t\t\t\t\tgoto err;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\tdefault:\n\t\t\tswitch (state->config->ts2_mode) {\n\t\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\t\tdefault:\n\t\t\t\tstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x14);\n\t\t\t\tbreak;\n\n\t\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\t\tcase STV090x_TSMODE_DVBCI:\n\t\t\t\tstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x12);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tswitch (state->config->ts1_mode) {\n\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts1_tei);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_TSMODE_DVBCI:\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts1_tei);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts1_tei);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts1_tei);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tswitch (state->config->ts2_mode) {\n\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\treg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts2_tei);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\n\t\tif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_TSMODE_DVBCI:\n\t\treg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts2_tei);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\n\t\tif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\treg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts2_tei);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\n\t\tif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\treg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts2_tei);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\n\t\tif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (state->config->ts1_clk > 0) {\n\t\tu32 speed;\n\n\t\tswitch (state->config->ts1_mode) {\n\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\tcase STV090x_TSMODE_DVBCI:\n\t\tdefault:\n\t\t\tspeed = state->internal->mclk /\n\t\t\t\t(state->config->ts1_clk / 4);\n\t\t\tif (speed < 0x08)\n\t\t\t\tspeed = 0x08;\n\t\t\tif (speed > 0xFF)\n\t\t\t\tspeed = 0xFF;\n\t\t\tbreak;\n\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\t\tspeed = state->internal->mclk /\n\t\t\t\t(state->config->ts1_clk / 32);\n\t\t\tif (speed < 0x20)\n\t\t\t\tspeed = 0x20;\n\t\t\tif (speed > 0xFF)\n\t\t\t\tspeed = 0xFF;\n\t\t\tbreak;\n\t\t}\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGM);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGM, reg) < 0)\n\t\t\tgoto err;\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSSPEED, speed) < 0)\n\t\t\tgoto err;\n\t}\n\n\tif (state->config->ts2_clk > 0) {\n\t\tu32 speed;\n\n\t\tswitch (state->config->ts2_mode) {\n\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\tcase STV090x_TSMODE_DVBCI:\n\t\tdefault:\n\t\t\tspeed = state->internal->mclk /\n\t\t\t\t(state->config->ts2_clk / 4);\n\t\t\tif (speed < 0x08)\n\t\t\t\tspeed = 0x08;\n\t\t\tif (speed > 0xFF)\n\t\t\t\tspeed = 0xFF;\n\t\t\tbreak;\n\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\t\tspeed = state->internal->mclk /\n\t\t\t\t(state->config->ts2_clk / 32);\n\t\t\tif (speed < 0x20)\n\t\t\t\tspeed = 0x20;\n\t\t\tif (speed > 0xFF)\n\t\t\t\tspeed = 0xFF;\n\t\t\tbreak;\n\t\t}\n\t\treg = stv090x_read_reg(state, STV090x_P2_TSCFGM);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\n\t\tif (stv090x_write_reg(state, STV090x_P2_TSCFGM, reg) < 0)\n\t\t\tgoto err;\n\t\tif (stv090x_write_reg(state, STV090x_P2_TSSPEED, speed) < 0)\n\t\t\tgoto err;\n\t}\n\n\treg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\n\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x01);\n\tif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\n\t\tgoto err;\n\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x00);\n\tif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\n\t\tgoto err;\n\n\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x01);\n\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\tgoto err;\n\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x00);\n\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\tgoto err;\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv0903_set_tspath(struct stv090x_state *state)\n{\n\tu32 reg;\n\n\tif (state->internal->dev_ver >= 0x20) {\n\t\tswitch (state->config->ts1_mode) {\n\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\tcase STV090x_TSMODE_DVBCI:\n\t\t\tstv090x_write_reg(state, STV090x_TSGENERAL, 0x00);\n\t\t\tbreak;\n\n\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\tdefault:\n\t\t\tstv090x_write_reg(state, STV090x_TSGENERAL, 0x0c);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tswitch (state->config->ts1_mode) {\n\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\tcase STV090x_TSMODE_DVBCI:\n\t\t\tstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x10);\n\t\t\tbreak;\n\n\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\tdefault:\n\t\t\tstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x14);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tswitch (state->config->ts1_mode) {\n\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_TSMODE_DVBCI:\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\t\tgoto err;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (state->config->ts1_clk > 0) {\n\t\tu32 speed;\n\n\t\tswitch (state->config->ts1_mode) {\n\t\tcase STV090x_TSMODE_PARALLEL_PUNCTURED:\n\t\tcase STV090x_TSMODE_DVBCI:\n\t\tdefault:\n\t\t\tspeed = state->internal->mclk /\n\t\t\t\t(state->config->ts1_clk / 4);\n\t\t\tif (speed < 0x08)\n\t\t\t\tspeed = 0x08;\n\t\t\tif (speed > 0xFF)\n\t\t\t\tspeed = 0xFF;\n\t\t\tbreak;\n\t\tcase STV090x_TSMODE_SERIAL_PUNCTURED:\n\t\tcase STV090x_TSMODE_SERIAL_CONTINUOUS:\n\t\t\tspeed = state->internal->mclk /\n\t\t\t\t(state->config->ts1_clk / 32);\n\t\t\tif (speed < 0x20)\n\t\t\t\tspeed = 0x20;\n\t\t\tif (speed > 0xFF)\n\t\t\t\tspeed = 0xFF;\n\t\t\tbreak;\n\t\t}\n\t\treg = stv090x_read_reg(state, STV090x_P1_TSCFGM);\n\t\tSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSCFGM, reg) < 0)\n\t\t\tgoto err;\n\t\tif (stv090x_write_reg(state, STV090x_P1_TSSPEED, speed) < 0)\n\t\t\tgoto err;\n\t}\n\n\treg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\n\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x01);\n\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\tgoto err;\n\tSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x00);\n\tif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\n\t\tgoto err;\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_init(struct dvb_frontend *fe)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tconst struct stv090x_config *config = state->config;\n\tu32 reg;\n\n\tif (state->internal->mclk == 0) {\n\t\t \n\t\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\t\tgoto err;\n\n\t\tif (config->tuner_init) {\n\t\t\tif (config->tuner_init(fe) < 0)\n\t\t\t\tgoto err_gateoff;\n\t\t}\n\n\t\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\t\tgoto err;\n\n\t\tstv090x_set_mclk(state, 135000000, config->xtal);  \n\t\tmsleep(5);\n\t\tif (stv090x_write_reg(state, STV090x_SYNTCTRL,\n\t\t\t\t      0x20 | config->clk_mode) < 0)\n\t\t\tgoto err;\n\t\tstv090x_get_mclk(state);\n\t}\n\n\tif (stv090x_wakeup(fe) < 0) {\n\t\tdprintk(FE_ERROR, 1, \"Error waking device\");\n\t\tgoto err;\n\t}\n\n\tif (stv090x_ldpc_mode(state, state->demod_mode) < 0)\n\t\tgoto err;\n\n\treg = STV090x_READ_DEMOD(state, TNRCFG2);\n\tSTV090x_SETFIELD_Px(reg, TUN_IQSWAP_FIELD, state->inversion);\n\tif (STV090x_WRITE_DEMOD(state, TNRCFG2, reg) < 0)\n\t\tgoto err;\n\treg = STV090x_READ_DEMOD(state, DEMOD);\n\tSTV090x_SETFIELD_Px(reg, ROLLOFF_CONTROL_FIELD, state->rolloff);\n\tif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\n\t\tgoto err;\n\n\tif (stv090x_i2c_gate_ctrl(state, 1) < 0)\n\t\tgoto err;\n\n\tif (config->tuner_set_mode) {\n\t\tif (config->tuner_set_mode(fe, TUNER_WAKE) < 0)\n\t\t\tgoto err_gateoff;\n\t}\n\n\tif (config->tuner_init) {\n\t\tif (config->tuner_init(fe) < 0)\n\t\t\tgoto err_gateoff;\n\t}\n\n\tif (stv090x_i2c_gate_ctrl(state, 0) < 0)\n\t\tgoto err;\n\n\tif (state->device == STV0900) {\n\t\tif (stv0900_set_tspath(state) < 0)\n\t\t\tgoto err;\n\t} else {\n\t\tif (stv0903_set_tspath(state) < 0)\n\t\t\tgoto err;\n\t}\n\n\treturn 0;\n\nerr_gateoff:\n\tstv090x_i2c_gate_ctrl(state, 0);\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_setup(struct dvb_frontend *fe)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tconst struct stv090x_config *config = state->config;\n\tconst struct stv090x_reg *stv090x_initval = NULL;\n\tconst struct stv090x_reg *stv090x_cut20_val = NULL;\n\tunsigned long t1_size = 0, t2_size = 0;\n\tu32 reg = 0;\n\n\tint i;\n\n\tif (state->device == STV0900) {\n\t\tdprintk(FE_DEBUG, 1, \"Initializing STV0900\");\n\t\tstv090x_initval = stv0900_initval;\n\t\tt1_size = ARRAY_SIZE(stv0900_initval);\n\t\tstv090x_cut20_val = stv0900_cut20_val;\n\t\tt2_size = ARRAY_SIZE(stv0900_cut20_val);\n\t} else if (state->device == STV0903) {\n\t\tdprintk(FE_DEBUG, 1, \"Initializing STV0903\");\n\t\tstv090x_initval = stv0903_initval;\n\t\tt1_size = ARRAY_SIZE(stv0903_initval);\n\t\tstv090x_cut20_val = stv0903_cut20_val;\n\t\tt2_size = ARRAY_SIZE(stv0903_cut20_val);\n\t}\n\n\t \n\n\t \n\tif (stv090x_write_reg(state, STV090x_P1_DMDISTATE, 0x5c) < 0)\n\t\tgoto err;\n\tif (state->device == STV0900)\n\t\tif (stv090x_write_reg(state, STV090x_P2_DMDISTATE, 0x5c) < 0)\n\t\t\tgoto err;\n\n\tmsleep(5);\n\n\t \n\tif (stv090x_write_reg(state, STV090x_P1_TNRCFG, 0x6c) < 0)\n\t\tgoto err;\n\tif (state->device == STV0900)\n\t\tif (stv090x_write_reg(state, STV090x_P2_TNRCFG, 0x6c) < 0)\n\t\t\tgoto err;\n\n\t \n\tSTV090x_SETFIELD_Px(reg, ENARPT_LEVEL_FIELD, config->repeater_level);\n\tif (stv090x_write_reg(state, STV090x_P1_I2CRPT, reg) < 0)\n\t\tgoto err;\n\tif (state->device == STV0900)\n\t\tif (stv090x_write_reg(state, STV090x_P2_I2CRPT, reg) < 0)\n\t\t\tgoto err;\n\n\tif (stv090x_write_reg(state, STV090x_NCOARSE, 0x13) < 0)  \n\t\tgoto err;\n\tmsleep(5);\n\tif (stv090x_write_reg(state, STV090x_I2CCFG, 0x08) < 0)  \n\t\tgoto err;\n\tif (stv090x_write_reg(state, STV090x_SYNTCTRL, 0x20 | config->clk_mode) < 0)  \n\t\tgoto err;\n\tmsleep(5);\n\n\t \n\tdprintk(FE_DEBUG, 1, \"Setting up initial values\");\n\tfor (i = 0; i < t1_size; i++) {\n\t\tif (stv090x_write_reg(state, stv090x_initval[i].addr, stv090x_initval[i].data) < 0)\n\t\t\tgoto err;\n\t}\n\n\tstate->internal->dev_ver = stv090x_read_reg(state, STV090x_MID);\n\tif (state->internal->dev_ver >= 0x20) {\n\t\tif (stv090x_write_reg(state, STV090x_TSGENERAL, 0x0c) < 0)\n\t\t\tgoto err;\n\n\t\t \n\t\tdprintk(FE_DEBUG, 1, \"Setting up Cut 2.0 initial values\");\n\t\tfor (i = 0; i < t2_size; i++) {\n\t\t\tif (stv090x_write_reg(state, stv090x_cut20_val[i].addr, stv090x_cut20_val[i].data) < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t} else if (state->internal->dev_ver < 0x20) {\n\t\tdprintk(FE_ERROR, 1, \"ERROR: Unsupported Cut: 0x%02x!\",\n\t\t\tstate->internal->dev_ver);\n\n\t\tgoto err;\n\t} else if (state->internal->dev_ver > 0x30) {\n\t\t \n\t\tdprintk(FE_ERROR, 1, \"INFO: Cut: 0x%02x probably incomplete support!\",\n\t\t\tstate->internal->dev_ver);\n\t}\n\n\t \n\treg = stv090x_read_reg(state, STV090x_TSTTNR1);\n\tSTV090x_SETFIELD(reg, ADC1_INMODE_FIELD,\n\t\t(config->adc1_range == STV090x_ADC_1Vpp) ? 0 : 1);\n\tif (stv090x_write_reg(state, STV090x_TSTTNR1, reg) < 0)\n\t\tgoto err;\n\n\t \n\treg = stv090x_read_reg(state, STV090x_TSTTNR3);\n\tSTV090x_SETFIELD(reg, ADC2_INMODE_FIELD,\n\t\t(config->adc2_range == STV090x_ADC_1Vpp) ? 0 : 1);\n\tif (stv090x_write_reg(state, STV090x_TSTTNR3, reg) < 0)\n\t\tgoto err;\n\n\tif (stv090x_write_reg(state, STV090x_TSTRES0, 0x80) < 0)\n\t\tgoto err;\n\tif (stv090x_write_reg(state, STV090x_TSTRES0, 0x00) < 0)\n\t\tgoto err;\n\n\treturn 0;\nerr:\n\tdprintk(FE_ERROR, 1, \"I/O error\");\n\treturn -1;\n}\n\nstatic int stv090x_set_gpio(struct dvb_frontend *fe, u8 gpio, u8 dir,\n\t\t\t    u8 value, u8 xor_value)\n{\n\tstruct stv090x_state *state = fe->demodulator_priv;\n\tu8 reg = 0;\n\n\tSTV090x_SETFIELD(reg, GPIOx_OPD_FIELD, dir);\n\tSTV090x_SETFIELD(reg, GPIOx_CONFIG_FIELD, value);\n\tSTV090x_SETFIELD(reg, GPIOx_XOR_FIELD, xor_value);\n\n\treturn stv090x_write_reg(state, STV090x_GPIOxCFG(gpio), reg);\n}\n\nstatic int stv090x_setup_compound(struct stv090x_state *state)\n{\n\tstruct stv090x_dev *temp_int;\n\n\ttemp_int = find_dev(state->i2c,\n\t\t\t    state->config->address);\n\n\tif (temp_int && state->demod_mode == STV090x_DUAL) {\n\t\tstate->internal = temp_int->internal;\n\t\tstate->internal->num_used++;\n\t\tdprintk(FE_INFO, 1, \"Found Internal Structure!\");\n\t} else {\n\t\tstate->internal = kmalloc(sizeof(*state->internal), GFP_KERNEL);\n\t\tif (!state->internal)\n\t\t\tgoto error;\n\t\ttemp_int = append_internal(state->internal);\n\t\tif (!temp_int) {\n\t\t\tkfree(state->internal);\n\t\t\tgoto error;\n\t\t}\n\t\tstate->internal->num_used = 1;\n\t\tstate->internal->mclk = 0;\n\t\tstate->internal->dev_ver = 0;\n\t\tstate->internal->i2c_adap = state->i2c;\n\t\tstate->internal->i2c_addr = state->config->address;\n\t\tdprintk(FE_INFO, 1, \"Create New Internal Structure!\");\n\n\t\tmutex_init(&state->internal->demod_lock);\n\t\tmutex_init(&state->internal->tuner_lock);\n\n\t\tif (stv090x_setup(&state->frontend) < 0) {\n\t\t\tdprintk(FE_ERROR, 1, \"Error setting up device\");\n\t\t\tgoto err_remove;\n\t\t}\n\t}\n\n\tif (state->internal->dev_ver >= 0x30)\n\t\tstate->frontend.ops.info.caps |= FE_CAN_MULTISTREAM;\n\n\t \n\tif (state->config->diseqc_envelope_mode)\n\t\tstv090x_send_diseqc_burst(&state->frontend, SEC_MINI_A);\n\n\tstate->config->set_gpio = stv090x_set_gpio;\n\n\tdprintk(FE_ERROR, 1, \"Probing %s demodulator(%d) Cut=0x%02x\",\n\t\tstate->device == STV0900 ? \"STV0900\" : \"STV0903\",\n\t\tstate->config->demod,\n\t\tstate->internal->dev_ver);\n\n\treturn 0;\n\nerror:\n\treturn -ENOMEM;\nerr_remove:\n\tremove_dev(state->internal);\n\tkfree(state->internal);\n\treturn -ENODEV;\n}\n\nstatic const struct dvb_frontend_ops stv090x_ops = {\n\t.delsys = { SYS_DVBS, SYS_DVBS2, SYS_DSS },\n\t.info = {\n\t\t.name\t\t\t= \"STV090x Multistandard\",\n\t\t.frequency_min_hz\t=  950 * MHz,\n\t\t.frequency_max_hz\t= 2150 * MHz,\n\t\t.symbol_rate_min\t= 1000000,\n\t\t.symbol_rate_max\t= 45000000,\n\t\t.caps\t\t\t= FE_CAN_INVERSION_AUTO |\n\t\t\t\t\t  FE_CAN_FEC_AUTO       |\n\t\t\t\t\t  FE_CAN_QPSK           |\n\t\t\t\t\t  FE_CAN_2G_MODULATION\n\t},\n\n\t.release\t\t\t= stv090x_release,\n\t.init\t\t\t\t= stv090x_init,\n\n\t.sleep\t\t\t\t= stv090x_sleep,\n\t.get_frontend_algo\t\t= stv090x_frontend_algo,\n\n\t.diseqc_send_master_cmd\t\t= stv090x_send_diseqc_msg,\n\t.diseqc_send_burst\t\t= stv090x_send_diseqc_burst,\n\t.diseqc_recv_slave_reply\t= stv090x_recv_slave_reply,\n\t.set_tone\t\t\t= stv090x_set_tone,\n\n\t.search\t\t\t\t= stv090x_search,\n\t.read_status\t\t\t= stv090x_read_status,\n\t.read_ber\t\t\t= stv090x_read_per,\n\t.read_signal_strength\t\t= stv090x_read_signal_strength,\n\t.read_snr\t\t\t= stv090x_read_cnr,\n};\n\nstatic struct dvb_frontend *stv090x_get_dvb_frontend(struct i2c_client *client)\n{\n\tstruct stv090x_state *state = i2c_get_clientdata(client);\n\n\tdev_dbg(&client->dev, \"\\n\");\n\n\treturn &state->frontend;\n}\n\nstatic int stv090x_probe(struct i2c_client *client)\n{\n\tint ret = 0;\n\tstruct stv090x_config *config = client->dev.platform_data;\n\n\tstruct stv090x_state *state = NULL;\n\n\tstate = kzalloc(sizeof(*state), GFP_KERNEL);\n\tif (!state) {\n\t\tret = -ENOMEM;\n\t\tgoto error;\n\t}\n\n\tstate->verbose\t\t\t\t= &verbose;\n\tstate->config\t\t\t\t= config;\n\tstate->i2c\t\t\t\t= client->adapter;\n\tstate->frontend.ops\t\t\t= stv090x_ops;\n\tstate->frontend.demodulator_priv\t= state;\n\tstate->demod\t\t\t\t= config->demod;\n\t\t\t\t\t\t \n\tstate->demod_mode\t\t\t= config->demod_mode;\n\tstate->device\t\t\t\t= config->device;\n\t\t\t\t\t\t \n\tstate->rolloff\t\t\t\t= STV090x_RO_35;\n\n\tret = stv090x_setup_compound(state);\n\tif (ret)\n\t\tgoto error;\n\n\ti2c_set_clientdata(client, state);\n\n\t \n\tconfig->get_dvb_frontend = stv090x_get_dvb_frontend;\n\n\treturn 0;\n\nerror:\n\tkfree(state);\n\treturn ret;\n}\n\nstatic void stv090x_remove(struct i2c_client *client)\n{\n\tstruct stv090x_state *state = i2c_get_clientdata(client);\n\n\tstv090x_release(&state->frontend);\n}\n\nstruct dvb_frontend *stv090x_attach(struct stv090x_config *config,\n\t\t\t\t    struct i2c_adapter *i2c,\n\t\t\t\t    enum stv090x_demodulator demod)\n{\n\tint ret = 0;\n\tstruct stv090x_state *state = NULL;\n\n\tstate = kzalloc(sizeof(*state), GFP_KERNEL);\n\tif (!state)\n\t\tgoto error;\n\n\tstate->verbose\t\t\t\t= &verbose;\n\tstate->config\t\t\t\t= config;\n\tstate->i2c\t\t\t\t= i2c;\n\tstate->frontend.ops\t\t\t= stv090x_ops;\n\tstate->frontend.demodulator_priv\t= state;\n\tstate->demod\t\t\t\t= demod;\n\t\t\t\t\t\t \n\tstate->demod_mode\t\t\t= config->demod_mode;\n\tstate->device\t\t\t\t= config->device;\n\t\t\t\t\t\t \n\tstate->rolloff\t\t\t\t= STV090x_RO_35;\n\n\tret = stv090x_setup_compound(state);\n\tif (ret)\n\t\tgoto error;\n\n\treturn &state->frontend;\n\nerror:\n\tkfree(state);\n\treturn NULL;\n}\nEXPORT_SYMBOL_GPL(stv090x_attach);\n\nstatic const struct i2c_device_id stv090x_id_table[] = {\n\t{\"stv090x\", 0},\n\t{}\n};\nMODULE_DEVICE_TABLE(i2c, stv090x_id_table);\n\nstatic struct i2c_driver stv090x_driver = {\n\t.driver = {\n\t\t.name\t= \"stv090x\",\n\t\t.suppress_bind_attrs = true,\n\t},\n\t.probe\t\t= stv090x_probe,\n\t.remove\t\t= stv090x_remove,\n\t.id_table\t= stv090x_id_table,\n};\n\nmodule_i2c_driver(stv090x_driver);\n\nMODULE_PARM_DESC(verbose, \"Set Verbosity level\");\nMODULE_AUTHOR(\"Manu Abraham\");\nMODULE_DESCRIPTION(\"STV090x Multi-Std Broadcast frontend\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}