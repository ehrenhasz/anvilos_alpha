{
  "module_name": "cx22700.c",
  "hash_id": "dec61b7d7346911bd3c067b02253a583ae51acc953b3ba60dc220c66352ce9d0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/dvb-frontends/cx22700.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/string.h>\n#include <linux/slab.h>\n#include <media/dvb_frontend.h>\n#include \"cx22700.h\"\n\n\nstruct cx22700_state {\n\n\tstruct i2c_adapter* i2c;\n\n\tconst struct cx22700_config* config;\n\n\tstruct dvb_frontend frontend;\n};\n\n\nstatic int debug;\n#define dprintk(args...) \\\n\tdo { \\\n\t\tif (debug) printk(KERN_DEBUG \"cx22700: \" args); \\\n\t} while (0)\n\nstatic u8 init_tab [] = {\n\t0x04, 0x10,\n\t0x05, 0x09,\n\t0x06, 0x00,\n\t0x08, 0x04,\n\t0x09, 0x00,\n\t0x0a, 0x01,\n\t0x15, 0x40,\n\t0x16, 0x10,\n\t0x17, 0x87,\n\t0x18, 0x17,\n\t0x1a, 0x10,\n\t0x25, 0x04,\n\t0x2e, 0x00,\n\t0x39, 0x00,\n\t0x3a, 0x04,\n\t0x45, 0x08,\n\t0x46, 0x02,\n\t0x47, 0x05,\n};\n\n\nstatic int cx22700_writereg (struct cx22700_state* state, u8 reg, u8 data)\n{\n\tint ret;\n\tu8 buf [] = { reg, data };\n\tstruct i2c_msg msg = { .addr = state->config->demod_address, .flags = 0, .buf = buf, .len = 2 };\n\n\tdprintk (\"%s\\n\", __func__);\n\n\tret = i2c_transfer (state->i2c, &msg, 1);\n\n\tif (ret != 1)\n\t\tprintk(\"%s: writereg error (reg == 0x%02x, val == 0x%02x, ret == %i)\\n\",\n\t\t\t__func__, reg, data, ret);\n\n\treturn (ret != 1) ? -1 : 0;\n}\n\nstatic int cx22700_readreg (struct cx22700_state* state, u8 reg)\n{\n\tint ret;\n\tu8 b0 [] = { reg };\n\tu8 b1 [] = { 0 };\n\tstruct i2c_msg msg [] = { { .addr = state->config->demod_address, .flags = 0, .buf = b0, .len = 1 },\n\t\t\t   { .addr = state->config->demod_address, .flags = I2C_M_RD, .buf = b1, .len = 1 } };\n\n\tdprintk (\"%s\\n\", __func__);\n\n\tret = i2c_transfer (state->i2c, msg, 2);\n\n\tif (ret != 2) return -EIO;\n\n\treturn b1[0];\n}\n\nstatic int cx22700_set_inversion (struct cx22700_state* state, int inversion)\n{\n\tu8 val;\n\n\tdprintk (\"%s\\n\", __func__);\n\n\tswitch (inversion) {\n\tcase INVERSION_AUTO:\n\t\treturn -EOPNOTSUPP;\n\tcase INVERSION_ON:\n\t\tval = cx22700_readreg (state, 0x09);\n\t\treturn cx22700_writereg (state, 0x09, val | 0x01);\n\tcase INVERSION_OFF:\n\t\tval = cx22700_readreg (state, 0x09);\n\t\treturn cx22700_writereg (state, 0x09, val & 0xfe);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int cx22700_set_tps(struct cx22700_state *state,\n\t\t\t   struct dtv_frontend_properties *p)\n{\n\tstatic const u8 qam_tab [4] = { 0, 1, 0, 2 };\n\tstatic const u8 fec_tab [6] = { 0, 1, 2, 0, 3, 4 };\n\tu8 val;\n\n\tdprintk (\"%s\\n\", __func__);\n\n\tif (p->code_rate_HP < FEC_1_2 || p->code_rate_HP > FEC_7_8)\n\t\treturn -EINVAL;\n\n\tif (p->code_rate_LP < FEC_1_2 || p->code_rate_LP > FEC_7_8)\n\t\treturn -EINVAL;\n\n\tif (p->code_rate_HP == FEC_4_5 || p->code_rate_LP == FEC_4_5)\n\t\treturn -EINVAL;\n\n\tif ((int)p->guard_interval < GUARD_INTERVAL_1_32 ||\n\t    p->guard_interval > GUARD_INTERVAL_1_4)\n\t\treturn -EINVAL;\n\n\tif (p->transmission_mode != TRANSMISSION_MODE_2K &&\n\t    p->transmission_mode != TRANSMISSION_MODE_8K)\n\t\treturn -EINVAL;\n\n\tif (p->modulation != QPSK &&\n\t    p->modulation != QAM_16 &&\n\t    p->modulation != QAM_64)\n\t\treturn -EINVAL;\n\n\tif ((int)p->hierarchy < HIERARCHY_NONE ||\n\t    p->hierarchy > HIERARCHY_4)\n\t\treturn -EINVAL;\n\n\tif (p->bandwidth_hz > 8000000 || p->bandwidth_hz < 6000000)\n\t\treturn -EINVAL;\n\n\tif (p->bandwidth_hz == 7000000)\n\t\tcx22700_writereg (state, 0x09, cx22700_readreg (state, 0x09 | 0x10));\n\telse\n\t\tcx22700_writereg (state, 0x09, cx22700_readreg (state, 0x09 & ~0x10));\n\n\tval = qam_tab[p->modulation - QPSK];\n\tval |= p->hierarchy - HIERARCHY_NONE;\n\n\tcx22700_writereg (state, 0x04, val);\n\n\tif (p->code_rate_HP - FEC_1_2 >= sizeof(fec_tab) ||\n\t    p->code_rate_LP - FEC_1_2 >= sizeof(fec_tab))\n\t\treturn -EINVAL;\n\tval = fec_tab[p->code_rate_HP - FEC_1_2] << 3;\n\tval |= fec_tab[p->code_rate_LP - FEC_1_2];\n\n\tcx22700_writereg (state, 0x05, val);\n\n\tval = (p->guard_interval - GUARD_INTERVAL_1_32) << 2;\n\tval |= p->transmission_mode - TRANSMISSION_MODE_2K;\n\n\tcx22700_writereg (state, 0x06, val);\n\n\tcx22700_writereg (state, 0x08, 0x04 | 0x02);   \n\tcx22700_writereg (state, 0x08, 0x04);          \n\n\treturn 0;\n}\n\nstatic int cx22700_get_tps(struct cx22700_state *state,\n\t\t\t   struct dtv_frontend_properties *p)\n{\n\tstatic const enum fe_modulation qam_tab[3] = { QPSK, QAM_16, QAM_64 };\n\tstatic const enum fe_code_rate fec_tab[5] = {\n\t\tFEC_1_2, FEC_2_3, FEC_3_4, FEC_5_6, FEC_7_8\n\t};\n\tu8 val;\n\n\tdprintk (\"%s\\n\", __func__);\n\n\tif (!(cx22700_readreg(state, 0x07) & 0x20))   \n\t\treturn -EAGAIN;\n\n\tval = cx22700_readreg (state, 0x01);\n\n\tif ((val & 0x7) > 4)\n\t\tp->hierarchy = HIERARCHY_AUTO;\n\telse\n\t\tp->hierarchy = HIERARCHY_NONE + (val & 0x7);\n\n\tif (((val >> 3) & 0x3) > 2)\n\t\tp->modulation = QAM_AUTO;\n\telse\n\t\tp->modulation = qam_tab[(val >> 3) & 0x3];\n\n\tval = cx22700_readreg (state, 0x02);\n\n\tif (((val >> 3) & 0x07) > 4)\n\t\tp->code_rate_HP = FEC_AUTO;\n\telse\n\t\tp->code_rate_HP = fec_tab[(val >> 3) & 0x07];\n\n\tif ((val & 0x07) > 4)\n\t\tp->code_rate_LP = FEC_AUTO;\n\telse\n\t\tp->code_rate_LP = fec_tab[val & 0x07];\n\n\tval = cx22700_readreg (state, 0x03);\n\n\tp->guard_interval = GUARD_INTERVAL_1_32 + ((val >> 6) & 0x3);\n\tp->transmission_mode = TRANSMISSION_MODE_2K + ((val >> 5) & 0x1);\n\n\treturn 0;\n}\n\nstatic int cx22700_init (struct dvb_frontend* fe)\n\n{\tstruct cx22700_state* state = fe->demodulator_priv;\n\tint i;\n\n\tdprintk(\"cx22700_init: init chip\\n\");\n\n\tcx22700_writereg (state, 0x00, 0x02);    \n\tcx22700_writereg (state, 0x00, 0x00);\n\n\tmsleep(10);\n\n\tfor (i=0; i<sizeof(init_tab); i+=2)\n\t\tcx22700_writereg (state, init_tab[i], init_tab[i+1]);\n\n\tcx22700_writereg (state, 0x00, 0x01);\n\n\treturn 0;\n}\n\nstatic int cx22700_read_status(struct dvb_frontend *fe, enum fe_status *status)\n{\n\tstruct cx22700_state* state = fe->demodulator_priv;\n\n\tu16 rs_ber = (cx22700_readreg (state, 0x0d) << 9)\n\t\t   | (cx22700_readreg (state, 0x0e) << 1);\n\tu8 sync = cx22700_readreg (state, 0x07);\n\n\t*status = 0;\n\n\tif (rs_ber < 0xff00)\n\t\t*status |= FE_HAS_SIGNAL;\n\n\tif (sync & 0x20)\n\t\t*status |= FE_HAS_CARRIER;\n\n\tif (sync & 0x10)\n\t\t*status |= FE_HAS_VITERBI;\n\n\tif (sync & 0x10)\n\t\t*status |= FE_HAS_SYNC;\n\n\tif (*status == 0x0f)\n\t\t*status |= FE_HAS_LOCK;\n\n\treturn 0;\n}\n\nstatic int cx22700_read_ber(struct dvb_frontend* fe, u32* ber)\n{\n\tstruct cx22700_state* state = fe->demodulator_priv;\n\n\t*ber = cx22700_readreg (state, 0x0c) & 0x7f;\n\tcx22700_writereg (state, 0x0c, 0x00);\n\n\treturn 0;\n}\n\nstatic int cx22700_read_signal_strength(struct dvb_frontend* fe, u16* signal_strength)\n{\n\tstruct cx22700_state* state = fe->demodulator_priv;\n\n\tu16 rs_ber = (cx22700_readreg (state, 0x0d) << 9)\n\t\t   | (cx22700_readreg (state, 0x0e) << 1);\n\t*signal_strength = ~rs_ber;\n\n\treturn 0;\n}\n\nstatic int cx22700_read_snr(struct dvb_frontend* fe, u16* snr)\n{\n\tstruct cx22700_state* state = fe->demodulator_priv;\n\n\tu16 rs_ber = (cx22700_readreg (state, 0x0d) << 9)\n\t\t   | (cx22700_readreg (state, 0x0e) << 1);\n\t*snr = ~rs_ber;\n\n\treturn 0;\n}\n\nstatic int cx22700_read_ucblocks(struct dvb_frontend* fe, u32* ucblocks)\n{\n\tstruct cx22700_state* state = fe->demodulator_priv;\n\n\t*ucblocks = cx22700_readreg (state, 0x0f);\n\tcx22700_writereg (state, 0x0f, 0x00);\n\n\treturn 0;\n}\n\nstatic int cx22700_set_frontend(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\n\tstruct cx22700_state* state = fe->demodulator_priv;\n\n\tcx22700_writereg (state, 0x00, 0x02);  \n\tcx22700_writereg (state, 0x00, 0x00);\n\n\tif (fe->ops.tuner_ops.set_params) {\n\t\tfe->ops.tuner_ops.set_params(fe);\n\t\tif (fe->ops.i2c_gate_ctrl) fe->ops.i2c_gate_ctrl(fe, 0);\n\t}\n\n\tcx22700_set_inversion(state, c->inversion);\n\tcx22700_set_tps(state, c);\n\tcx22700_writereg (state, 0x37, 0x01);   \n\tcx22700_writereg (state, 0x00, 0x01);   \n\n\treturn 0;\n}\n\nstatic int cx22700_get_frontend(struct dvb_frontend *fe,\n\t\t\t\tstruct dtv_frontend_properties *c)\n{\n\tstruct cx22700_state* state = fe->demodulator_priv;\n\tu8 reg09 = cx22700_readreg (state, 0x09);\n\n\tc->inversion = reg09 & 0x1 ? INVERSION_ON : INVERSION_OFF;\n\treturn cx22700_get_tps(state, c);\n}\n\nstatic int cx22700_i2c_gate_ctrl(struct dvb_frontend* fe, int enable)\n{\n\tstruct cx22700_state* state = fe->demodulator_priv;\n\n\tif (enable) {\n\t\treturn cx22700_writereg(state, 0x0a, 0x00);\n\t} else {\n\t\treturn cx22700_writereg(state, 0x0a, 0x01);\n\t}\n}\n\nstatic int cx22700_get_tune_settings(struct dvb_frontend* fe, struct dvb_frontend_tune_settings* fesettings)\n{\n\tfesettings->min_delay_ms = 150;\n\tfesettings->step_size = 166667;\n\tfesettings->max_drift = 166667*2;\n\treturn 0;\n}\n\nstatic void cx22700_release(struct dvb_frontend* fe)\n{\n\tstruct cx22700_state* state = fe->demodulator_priv;\n\tkfree(state);\n}\n\nstatic const struct dvb_frontend_ops cx22700_ops;\n\nstruct dvb_frontend* cx22700_attach(const struct cx22700_config* config,\n\t\t\t\t    struct i2c_adapter* i2c)\n{\n\tstruct cx22700_state* state = NULL;\n\n\t \n\tstate = kzalloc(sizeof(struct cx22700_state), GFP_KERNEL);\n\tif (state == NULL) goto error;\n\n\t \n\tstate->config = config;\n\tstate->i2c = i2c;\n\n\t \n\tif (cx22700_readreg(state, 0x07) < 0) goto error;\n\n\t \n\tmemcpy(&state->frontend.ops, &cx22700_ops, sizeof(struct dvb_frontend_ops));\n\tstate->frontend.demodulator_priv = state;\n\treturn &state->frontend;\n\nerror:\n\tkfree(state);\n\treturn NULL;\n}\n\nstatic const struct dvb_frontend_ops cx22700_ops = {\n\t.delsys = { SYS_DVBT },\n\t.info = {\n\t\t.name\t\t\t= \"Conexant CX22700 DVB-T\",\n\t\t.frequency_min_hz\t= 470 * MHz,\n\t\t.frequency_max_hz\t= 860 * MHz,\n\t\t.frequency_stepsize_hz\t= 166667,\n\t\t.caps = FE_CAN_FEC_1_2 | FE_CAN_FEC_2_3 | FE_CAN_FEC_3_4 |\n\t\t      FE_CAN_FEC_5_6 | FE_CAN_FEC_7_8 | FE_CAN_FEC_AUTO |\n\t\t      FE_CAN_QPSK | FE_CAN_QAM_16 | FE_CAN_QAM_64 |\n\t\t      FE_CAN_RECOVER\n\t},\n\n\t.release = cx22700_release,\n\n\t.init = cx22700_init,\n\t.i2c_gate_ctrl = cx22700_i2c_gate_ctrl,\n\n\t.set_frontend = cx22700_set_frontend,\n\t.get_frontend = cx22700_get_frontend,\n\t.get_tune_settings = cx22700_get_tune_settings,\n\n\t.read_status = cx22700_read_status,\n\t.read_ber = cx22700_read_ber,\n\t.read_signal_strength = cx22700_read_signal_strength,\n\t.read_snr = cx22700_read_snr,\n\t.read_ucblocks = cx22700_read_ucblocks,\n};\n\nmodule_param(debug, int, 0644);\nMODULE_PARM_DESC(debug, \"Turn on/off frontend debugging (default:off).\");\n\nMODULE_DESCRIPTION(\"Conexant CX22700 DVB-T Demodulator driver\");\nMODULE_AUTHOR(\"Holger Waechtler\");\nMODULE_LICENSE(\"GPL\");\n\nEXPORT_SYMBOL_GPL(cx22700_attach);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}