{
  "module_name": "lnbp21.c",
  "hash_id": "9e720fc3275dfc4c16f57b8519b310b2739ba217e6d0da2f85c64bd7095bade3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/dvb-frontends/lnbp21.c",
  "human_readable_source": "\n \n#include <linux/delay.h>\n#include <linux/errno.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/string.h>\n#include <linux/slab.h>\n\n#include <media/dvb_frontend.h>\n#include \"lnbp21.h\"\n#include \"lnbh24.h\"\n\nstruct lnbp21 {\n\tu8\t\t\tconfig;\n\tu8\t\t\toverride_or;\n\tu8\t\t\toverride_and;\n\tstruct i2c_adapter\t*i2c;\n\tu8\t\t\ti2c_addr;\n};\n\nstatic int lnbp21_set_voltage(struct dvb_frontend *fe,\n\t\t\t      enum fe_sec_voltage voltage)\n{\n\tstruct lnbp21 *lnbp21 = (struct lnbp21 *) fe->sec_priv;\n\tstruct i2c_msg msg = {\t.addr = lnbp21->i2c_addr, .flags = 0,\n\t\t\t\t.buf = &lnbp21->config,\n\t\t\t\t.len = sizeof(lnbp21->config) };\n\n\tlnbp21->config &= ~(LNBP21_VSEL | LNBP21_EN);\n\n\tswitch(voltage) {\n\tcase SEC_VOLTAGE_OFF:\n\t\tbreak;\n\tcase SEC_VOLTAGE_13:\n\t\tlnbp21->config |= LNBP21_EN;\n\t\tbreak;\n\tcase SEC_VOLTAGE_18:\n\t\tlnbp21->config |= (LNBP21_EN | LNBP21_VSEL);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tlnbp21->config |= lnbp21->override_or;\n\tlnbp21->config &= lnbp21->override_and;\n\n\treturn (i2c_transfer(lnbp21->i2c, &msg, 1) == 1) ? 0 : -EIO;\n}\n\nstatic int lnbp21_enable_high_lnb_voltage(struct dvb_frontend *fe, long arg)\n{\n\tstruct lnbp21 *lnbp21 = (struct lnbp21 *) fe->sec_priv;\n\tstruct i2c_msg msg = {\t.addr = lnbp21->i2c_addr, .flags = 0,\n\t\t\t\t.buf = &lnbp21->config,\n\t\t\t\t.len = sizeof(lnbp21->config) };\n\n\tif (arg)\n\t\tlnbp21->config |= LNBP21_LLC;\n\telse\n\t\tlnbp21->config &= ~LNBP21_LLC;\n\n\tlnbp21->config |= lnbp21->override_or;\n\tlnbp21->config &= lnbp21->override_and;\n\n\treturn (i2c_transfer(lnbp21->i2c, &msg, 1) == 1) ? 0 : -EIO;\n}\n\nstatic int lnbp21_set_tone(struct dvb_frontend *fe,\n\t\t\t   enum fe_sec_tone_mode tone)\n{\n\tstruct lnbp21 *lnbp21 = (struct lnbp21 *) fe->sec_priv;\n\tstruct i2c_msg msg = {\t.addr = lnbp21->i2c_addr, .flags = 0,\n\t\t\t\t.buf = &lnbp21->config,\n\t\t\t\t.len = sizeof(lnbp21->config) };\n\n\tswitch (tone) {\n\tcase SEC_TONE_OFF:\n\t\tlnbp21->config &= ~LNBP21_TEN;\n\t\tbreak;\n\tcase SEC_TONE_ON:\n\t\tlnbp21->config |= LNBP21_TEN;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tlnbp21->config |= lnbp21->override_or;\n\tlnbp21->config &= lnbp21->override_and;\n\n\treturn (i2c_transfer(lnbp21->i2c, &msg, 1) == 1) ? 0 : -EIO;\n}\n\nstatic void lnbp21_release(struct dvb_frontend *fe)\n{\n\t \n\tlnbp21_set_voltage(fe, SEC_VOLTAGE_OFF);\n\n\t \n\tkfree(fe->sec_priv);\n\tfe->sec_priv = NULL;\n}\n\nstatic struct dvb_frontend *lnbx2x_attach(struct dvb_frontend *fe,\n\t\t\t\tstruct i2c_adapter *i2c, u8 override_set,\n\t\t\t\tu8 override_clear, u8 i2c_addr, u8 config)\n{\n\tstruct lnbp21 *lnbp21 = kmalloc(sizeof(struct lnbp21), GFP_KERNEL);\n\tif (!lnbp21)\n\t\treturn NULL;\n\n\t \n\tlnbp21->config = config;\n\tlnbp21->i2c = i2c;\n\tlnbp21->i2c_addr = i2c_addr;\n\tfe->sec_priv = lnbp21;\n\n\t \n\tlnbp21->override_or = override_set;\n\n\t \n\tlnbp21->override_and = ~override_clear;\n\n\t \n\tif (lnbp21_set_voltage(fe, SEC_VOLTAGE_OFF)) {\n\t\tkfree(lnbp21);\n\t\treturn NULL;\n\t}\n\n\t \n\tfe->ops.release_sec = lnbp21_release;\n\n\t \n\tfe->ops.set_voltage = lnbp21_set_voltage;\n\tfe->ops.enable_high_lnb_voltage = lnbp21_enable_high_lnb_voltage;\n\tif (!(override_clear & LNBH24_TEN))  \n\t\tfe->ops.set_tone = lnbp21_set_tone;\n\tprintk(KERN_INFO \"LNBx2x attached on addr=%x\\n\", lnbp21->i2c_addr);\n\n\treturn fe;\n}\n\nstruct dvb_frontend *lnbh24_attach(struct dvb_frontend *fe,\n\t\t\t\tstruct i2c_adapter *i2c, u8 override_set,\n\t\t\t\tu8 override_clear, u8 i2c_addr)\n{\n\treturn lnbx2x_attach(fe, i2c, override_set, override_clear,\n\t\t\t\t\t\t\ti2c_addr, LNBH24_TTX);\n}\nEXPORT_SYMBOL_GPL(lnbh24_attach);\n\nstruct dvb_frontend *lnbp21_attach(struct dvb_frontend *fe,\n\t\t\t\tstruct i2c_adapter *i2c, u8 override_set,\n\t\t\t\tu8 override_clear)\n{\n\treturn lnbx2x_attach(fe, i2c, override_set, override_clear,\n\t\t\t\t\t\t\t0x08, LNBP21_ISEL);\n}\nEXPORT_SYMBOL_GPL(lnbp21_attach);\n\nMODULE_DESCRIPTION(\"Driver for lnb supply and control ic lnbp21, lnbh24\");\nMODULE_AUTHOR(\"Oliver Endriss, Igor M. Liplianin\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}