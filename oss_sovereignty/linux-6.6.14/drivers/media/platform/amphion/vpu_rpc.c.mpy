{
  "module_name": "vpu_rpc.c",
  "hash_id": "4723ca00a2cb470409caa705bb43b59c8e0be35c28deed9875ebdb46259f3e54",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/amphion/vpu_rpc.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/interconnect.h>\n#include <linux/ioctl.h>\n#include <linux/list.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/firmware/imx/ipc.h>\n#include <linux/firmware/imx/svc/misc.h>\n#include \"vpu.h\"\n#include \"vpu_rpc.h\"\n#include \"vpu_imx8q.h\"\n#include \"vpu_windsor.h\"\n#include \"vpu_malone.h\"\n\nint vpu_iface_check_memory_region(struct vpu_core *core, dma_addr_t addr, u32 size)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->check_memory_region)\n\t\treturn VPU_CORE_MEMORY_INVALID;\n\n\treturn ops->check_memory_region(core->fw.phys, addr, size);\n}\n\nstatic u32 vpu_rpc_check_buffer_space(struct vpu_rpc_buffer_desc *desc, bool write)\n{\n\tu32 ptr1;\n\tu32 ptr2;\n\tu32 size;\n\n\tsize = desc->end - desc->start;\n\tif (write) {\n\t\tptr1 = desc->wptr;\n\t\tptr2 = desc->rptr;\n\t} else {\n\t\tptr1 = desc->rptr;\n\t\tptr2 = desc->wptr;\n\t}\n\n\tif (ptr1 == ptr2) {\n\t\tif (!write)\n\t\t\treturn 0;\n\t\telse\n\t\t\treturn size;\n\t}\n\n\treturn (ptr2 + size - ptr1) % size;\n}\n\nstatic int vpu_rpc_send_cmd_buf(struct vpu_shared_addr *shared, struct vpu_rpc_event *cmd)\n{\n\tstruct vpu_rpc_buffer_desc *desc;\n\tu32 space = 0;\n\tu32 *data;\n\tu32 wptr;\n\tu32 i;\n\n\tif (cmd->hdr.num > 0xff || cmd->hdr.num >= ARRAY_SIZE(cmd->data))\n\t\treturn -EINVAL;\n\tdesc = shared->cmd_desc;\n\tspace = vpu_rpc_check_buffer_space(desc, true);\n\tif (space < (((cmd->hdr.num + 1) << 2) + 16))\n\t\treturn -EINVAL;\n\twptr = desc->wptr;\n\tdata = (u32 *)(shared->cmd_mem_vir + desc->wptr - desc->start);\n\t*data = 0;\n\t*data |= ((cmd->hdr.index & 0xff) << 24);\n\t*data |= ((cmd->hdr.num & 0xff) << 16);\n\t*data |= (cmd->hdr.id & 0x3fff);\n\twptr += 4;\n\tdata++;\n\tif (wptr >= desc->end) {\n\t\twptr = desc->start;\n\t\tdata = shared->cmd_mem_vir;\n\t}\n\n\tfor (i = 0; i < cmd->hdr.num; i++) {\n\t\t*data = cmd->data[i];\n\t\twptr += 4;\n\t\tdata++;\n\t\tif (wptr >= desc->end) {\n\t\t\twptr = desc->start;\n\t\t\tdata = shared->cmd_mem_vir;\n\t\t}\n\t}\n\n\t \n\tmb();\n\tdesc->wptr = wptr;\n\n\treturn 0;\n}\n\nstatic bool vpu_rpc_check_msg(struct vpu_shared_addr *shared)\n{\n\tstruct vpu_rpc_buffer_desc *desc;\n\tu32 space = 0;\n\tu32 msgword;\n\tu32 msgnum;\n\n\tdesc = shared->msg_desc;\n\tspace = vpu_rpc_check_buffer_space(desc, 0);\n\tspace = (space >> 2);\n\n\tif (space) {\n\t\tmsgword = *(u32 *)(shared->msg_mem_vir + desc->rptr - desc->start);\n\t\tmsgnum = (msgword & 0xff0000) >> 16;\n\t\tif (msgnum <= space)\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic int vpu_rpc_receive_msg_buf(struct vpu_shared_addr *shared, struct vpu_rpc_event *msg)\n{\n\tstruct vpu_rpc_buffer_desc *desc;\n\tu32 *data;\n\tu32 msgword;\n\tu32 rptr;\n\tu32 i;\n\n\tif (!vpu_rpc_check_msg(shared))\n\t\treturn -EINVAL;\n\n\tdesc = shared->msg_desc;\n\tdata = (u32 *)(shared->msg_mem_vir + desc->rptr - desc->start);\n\trptr = desc->rptr;\n\tmsgword = *data;\n\tdata++;\n\trptr += 4;\n\tif (rptr >= desc->end) {\n\t\trptr = desc->start;\n\t\tdata = shared->msg_mem_vir;\n\t}\n\n\tmsg->hdr.index = (msgword >> 24) & 0xff;\n\tmsg->hdr.num = (msgword >> 16) & 0xff;\n\tmsg->hdr.id = msgword & 0x3fff;\n\n\tif (msg->hdr.num > ARRAY_SIZE(msg->data))\n\t\treturn -EINVAL;\n\n\tfor (i = 0; i < msg->hdr.num; i++) {\n\t\tmsg->data[i] = *data;\n\t\tdata++;\n\t\trptr += 4;\n\t\tif (rptr >= desc->end) {\n\t\t\trptr = desc->start;\n\t\t\tdata = shared->msg_mem_vir;\n\t\t}\n\t}\n\n\t \n\tmb();\n\tdesc->rptr = rptr;\n\n\treturn 0;\n}\n\nstatic struct vpu_iface_ops imx8q_rpc_ops[] = {\n\t[VPU_CORE_TYPE_ENC] = {\n\t\t.check_codec = vpu_imx8q_check_codec,\n\t\t.check_fmt = vpu_imx8q_check_fmt,\n\t\t.boot_core = vpu_imx8q_boot_core,\n\t\t.get_power_state = vpu_imx8q_get_power_state,\n\t\t.on_firmware_loaded = vpu_imx8q_on_firmware_loaded,\n\t\t.get_data_size = vpu_windsor_get_data_size,\n\t\t.check_memory_region = vpu_imx8q_check_memory_region,\n\t\t.init_rpc = vpu_windsor_init_rpc,\n\t\t.set_log_buf = vpu_windsor_set_log_buf,\n\t\t.set_system_cfg = vpu_windsor_set_system_cfg,\n\t\t.get_version = vpu_windsor_get_version,\n\t\t.send_cmd_buf = vpu_rpc_send_cmd_buf,\n\t\t.receive_msg_buf = vpu_rpc_receive_msg_buf,\n\t\t.pack_cmd = vpu_windsor_pack_cmd,\n\t\t.convert_msg_id = vpu_windsor_convert_msg_id,\n\t\t.unpack_msg_data = vpu_windsor_unpack_msg_data,\n\t\t.config_memory_resource = vpu_windsor_config_memory_resource,\n\t\t.get_stream_buffer_size = vpu_windsor_get_stream_buffer_size,\n\t\t.config_stream_buffer = vpu_windsor_config_stream_buffer,\n\t\t.get_stream_buffer_desc = vpu_windsor_get_stream_buffer_desc,\n\t\t.update_stream_buffer = vpu_windsor_update_stream_buffer,\n\t\t.set_encode_params = vpu_windsor_set_encode_params,\n\t\t.input_frame = vpu_windsor_input_frame,\n\t\t.get_max_instance_count = vpu_windsor_get_max_instance_count,\n\t},\n\t[VPU_CORE_TYPE_DEC] = {\n\t\t.check_codec = vpu_imx8q_check_codec,\n\t\t.check_fmt = vpu_malone_check_fmt,\n\t\t.boot_core = vpu_imx8q_boot_core,\n\t\t.get_power_state = vpu_imx8q_get_power_state,\n\t\t.on_firmware_loaded = vpu_imx8q_on_firmware_loaded,\n\t\t.get_data_size = vpu_malone_get_data_size,\n\t\t.check_memory_region = vpu_imx8q_check_memory_region,\n\t\t.init_rpc = vpu_malone_init_rpc,\n\t\t.set_log_buf = vpu_malone_set_log_buf,\n\t\t.set_system_cfg = vpu_malone_set_system_cfg,\n\t\t.get_version = vpu_malone_get_version,\n\t\t.send_cmd_buf = vpu_rpc_send_cmd_buf,\n\t\t.receive_msg_buf = vpu_rpc_receive_msg_buf,\n\t\t.get_stream_buffer_size = vpu_malone_get_stream_buffer_size,\n\t\t.config_stream_buffer = vpu_malone_config_stream_buffer,\n\t\t.set_decode_params = vpu_malone_set_decode_params,\n\t\t.pack_cmd = vpu_malone_pack_cmd,\n\t\t.convert_msg_id = vpu_malone_convert_msg_id,\n\t\t.unpack_msg_data = vpu_malone_unpack_msg_data,\n\t\t.get_stream_buffer_desc = vpu_malone_get_stream_buffer_desc,\n\t\t.update_stream_buffer = vpu_malone_update_stream_buffer,\n\t\t.add_scode = vpu_malone_add_scode,\n\t\t.input_frame = vpu_malone_input_frame,\n\t\t.pre_send_cmd = vpu_malone_pre_cmd,\n\t\t.post_send_cmd = vpu_malone_post_cmd,\n\t\t.init_instance = vpu_malone_init_instance,\n\t\t.get_max_instance_count = vpu_malone_get_max_instance_count,\n\t},\n};\n\nstatic struct vpu_iface_ops *vpu_get_iface(struct vpu_dev *vpu, enum vpu_core_type type)\n{\n\tstruct vpu_iface_ops *rpc_ops = NULL;\n\tu32 size = 0;\n\n\tswitch (vpu->res->plat_type) {\n\tcase IMX8QXP:\n\tcase IMX8QM:\n\t\trpc_ops = imx8q_rpc_ops;\n\t\tsize = ARRAY_SIZE(imx8q_rpc_ops);\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\tif (type >= size)\n\t\treturn NULL;\n\n\treturn &rpc_ops[type];\n}\n\nstruct vpu_iface_ops *vpu_core_get_iface(struct vpu_core *core)\n{\n\treturn vpu_get_iface(core->vpu, core->type);\n}\n\nstruct vpu_iface_ops *vpu_inst_get_iface(struct vpu_inst *inst)\n{\n\tif (inst->core)\n\t\treturn vpu_core_get_iface(inst->core);\n\n\treturn vpu_get_iface(inst->vpu, inst->type);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}