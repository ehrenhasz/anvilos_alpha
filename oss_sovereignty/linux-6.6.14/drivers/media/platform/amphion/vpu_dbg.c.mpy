{
  "module_name": "vpu_dbg.c",
  "hash_id": "689b007862fc0c1f2660ad35876ea23a2887477cc174ac794883180af74fd0a2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/amphion/vpu_dbg.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/device.h>\n#include <linux/ioctl.h>\n#include <linux/list.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/pm_runtime.h>\n#include <media/v4l2-device.h>\n#include <linux/debugfs.h>\n#include \"vpu.h\"\n#include \"vpu_defs.h\"\n#include \"vpu_core.h\"\n#include \"vpu_helpers.h\"\n#include \"vpu_cmds.h\"\n#include \"vpu_rpc.h\"\n#include \"vpu_v4l2.h\"\n\nstruct print_buf_desc {\n\tu32 start_h_phy;\n\tu32 start_h_vir;\n\tu32 start_m;\n\tu32 bytes;\n\tu32 read;\n\tu32 write;\n\tchar buffer[];\n};\n\nstatic char *vb2_stat_name[] = {\n\t[VB2_BUF_STATE_DEQUEUED] = \"dequeued\",\n\t[VB2_BUF_STATE_IN_REQUEST] = \"in_request\",\n\t[VB2_BUF_STATE_PREPARING] = \"preparing\",\n\t[VB2_BUF_STATE_QUEUED] = \"queued\",\n\t[VB2_BUF_STATE_ACTIVE] = \"active\",\n\t[VB2_BUF_STATE_DONE] = \"done\",\n\t[VB2_BUF_STATE_ERROR] = \"error\",\n};\n\nstatic char *vpu_stat_name[] = {\n\t[VPU_BUF_STATE_IDLE] = \"idle\",\n\t[VPU_BUF_STATE_INUSE] = \"inuse\",\n\t[VPU_BUF_STATE_DECODED] = \"decoded\",\n\t[VPU_BUF_STATE_READY] = \"ready\",\n\t[VPU_BUF_STATE_SKIP] = \"skip\",\n\t[VPU_BUF_STATE_ERROR] = \"error\",\n};\n\nstatic inline const char *to_vpu_stat_name(int state)\n{\n\tif (state <= VPU_BUF_STATE_ERROR)\n\t\treturn vpu_stat_name[state];\n\treturn \"unknown\";\n}\n\nstatic int vpu_dbg_instance(struct seq_file *s, void *data)\n{\n\tstruct vpu_inst *inst = s->private;\n\tchar str[128];\n\tint num;\n\tstruct vb2_queue *vq;\n\tint i;\n\n\tif (!inst->fh.m2m_ctx)\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str), \"[%s]\\n\", vpu_core_type_desc(inst->type));\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\n\tnum = scnprintf(str, sizeof(str), \"tgig = %d,pid = %d\\n\", inst->tgid, inst->pid);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str), \"state = %s\\n\", vpu_codec_state_name(inst->state));\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str),\n\t\t\t\"min_buffer_out = %d, min_buffer_cap = %d\\n\",\n\t\t\tinst->min_buffer_out, inst->min_buffer_cap);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\n\tvq = v4l2_m2m_get_src_vq(inst->fh.m2m_ctx);\n\tnum = scnprintf(str, sizeof(str),\n\t\t\t\"output (%2d, %2d): fmt = %c%c%c%c %d x %d, %d;\",\n\t\t\tvb2_is_streaming(vq),\n\t\t\tvq->num_buffers,\n\t\t\tinst->out_format.pixfmt,\n\t\t\tinst->out_format.pixfmt >> 8,\n\t\t\tinst->out_format.pixfmt >> 16,\n\t\t\tinst->out_format.pixfmt >> 24,\n\t\t\tinst->out_format.width,\n\t\t\tinst->out_format.height,\n\t\t\tvq->last_buffer_dequeued);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tfor (i = 0; i < inst->out_format.mem_planes; i++) {\n\t\tnum = scnprintf(str, sizeof(str), \" %d(%d)\",\n\t\t\t\tvpu_get_fmt_plane_size(&inst->out_format, i),\n\t\t\t\tinst->out_format.bytesperline[i]);\n\t\tif (seq_write(s, str, num))\n\t\t\treturn 0;\n\t}\n\tif (seq_write(s, \"\\n\", 1))\n\t\treturn 0;\n\n\tvq = v4l2_m2m_get_dst_vq(inst->fh.m2m_ctx);\n\tnum = scnprintf(str, sizeof(str),\n\t\t\t\"capture(%2d, %2d): fmt = %c%c%c%c %d x %d, %d;\",\n\t\t\tvb2_is_streaming(vq),\n\t\t\tvq->num_buffers,\n\t\t\tinst->cap_format.pixfmt,\n\t\t\tinst->cap_format.pixfmt >> 8,\n\t\t\tinst->cap_format.pixfmt >> 16,\n\t\t\tinst->cap_format.pixfmt >> 24,\n\t\t\tinst->cap_format.width,\n\t\t\tinst->cap_format.height,\n\t\t\tvq->last_buffer_dequeued);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tfor (i = 0; i < inst->cap_format.mem_planes; i++) {\n\t\tnum = scnprintf(str, sizeof(str), \" %d(%d)\",\n\t\t\t\tvpu_get_fmt_plane_size(&inst->cap_format, i),\n\t\t\t\tinst->cap_format.bytesperline[i]);\n\t\tif (seq_write(s, str, num))\n\t\t\treturn 0;\n\t}\n\tif (seq_write(s, \"\\n\", 1))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str), \"crop: (%d, %d) %d x %d\\n\",\n\t\t\tinst->crop.left,\n\t\t\tinst->crop.top,\n\t\t\tinst->crop.width,\n\t\t\tinst->crop.height);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\n\tvq = v4l2_m2m_get_src_vq(inst->fh.m2m_ctx);\n\tfor (i = 0; i < vq->num_buffers; i++) {\n\t\tstruct vb2_buffer *vb = vq->bufs[i];\n\t\tstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\n\n\t\tif (vb->state == VB2_BUF_STATE_DEQUEUED)\n\t\t\tcontinue;\n\t\tnum = scnprintf(str, sizeof(str),\n\t\t\t\t\"output [%2d] state = %10s, %8s\\n\",\n\t\t\t\ti, vb2_stat_name[vb->state],\n\t\t\t\tto_vpu_stat_name(vpu_get_buffer_state(vbuf)));\n\t\tif (seq_write(s, str, num))\n\t\t\treturn 0;\n\t}\n\n\tvq = v4l2_m2m_get_dst_vq(inst->fh.m2m_ctx);\n\tfor (i = 0; i < vq->num_buffers; i++) {\n\t\tstruct vb2_buffer *vb = vq->bufs[i];\n\t\tstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\n\n\t\tif (vb->state == VB2_BUF_STATE_DEQUEUED)\n\t\t\tcontinue;\n\t\tnum = scnprintf(str, sizeof(str),\n\t\t\t\t\"capture[%2d] state = %10s, %8s\\n\",\n\t\t\t\ti, vb2_stat_name[vb->state],\n\t\t\t\tto_vpu_stat_name(vpu_get_buffer_state(vbuf)));\n\t\tif (seq_write(s, str, num))\n\t\t\treturn 0;\n\t}\n\n\tnum = scnprintf(str, sizeof(str), \"sequence = %d\\n\", inst->sequence);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\n\tif (inst->use_stream_buffer) {\n\t\tnum = scnprintf(str, sizeof(str), \"stream_buffer = %d / %d, <%pad, 0x%x>\\n\",\n\t\t\t\tvpu_helper_get_used_space(inst),\n\t\t\t\tinst->stream_buffer.length,\n\t\t\t\t&inst->stream_buffer.phys,\n\t\t\t\tinst->stream_buffer.length);\n\t\tif (seq_write(s, str, num))\n\t\t\treturn 0;\n\t}\n\tnum = scnprintf(str, sizeof(str), \"kfifo len = 0x%x\\n\", kfifo_len(&inst->msg_fifo));\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\n\tnum = scnprintf(str, sizeof(str), \"flow :\\n\");\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\n\tmutex_lock(&inst->core->cmd_lock);\n\tfor (i = 0; i < ARRAY_SIZE(inst->flows); i++) {\n\t\tu32 idx = (inst->flow_idx + i) % (ARRAY_SIZE(inst->flows));\n\n\t\tif (!inst->flows[idx])\n\t\t\tcontinue;\n\t\tnum = scnprintf(str, sizeof(str), \"\\t[%s] %s\\n\",\n\t\t\t\tinst->flows[idx] >= VPU_MSG_ID_NOOP ? \"M\" : \"C\",\n\t\t\t\tvpu_id_name(inst->flows[idx]));\n\t\tif (seq_write(s, str, num)) {\n\t\t\tmutex_unlock(&inst->core->cmd_lock);\n\t\t\treturn 0;\n\t\t}\n\t}\n\tmutex_unlock(&inst->core->cmd_lock);\n\n\ti = 0;\n\twhile (true) {\n\t\tnum = call_vop(inst, get_debug_info, str, sizeof(str), i++);\n\t\tif (num <= 0)\n\t\t\tbreak;\n\t\tif (seq_write(s, str, num))\n\t\t\treturn 0;\n\t}\n\n\treturn 0;\n}\n\nstatic int vpu_dbg_core(struct seq_file *s, void *data)\n{\n\tstruct vpu_core *core = s->private;\n\tstruct vpu_shared_addr *iface = core->iface;\n\tchar str[128];\n\tint num;\n\n\tnum = scnprintf(str, sizeof(str), \"[%s]\\n\", vpu_core_type_desc(core->type));\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\n\tnum = scnprintf(str, sizeof(str), \"boot_region  = <%pad, 0x%x>\\n\",\n\t\t\t&core->fw.phys, core->fw.length);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str), \"rpc_region   = <%pad, 0x%x> used = 0x%x\\n\",\n\t\t\t&core->rpc.phys, core->rpc.length, core->rpc.bytesused);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str), \"fwlog_region = <%pad, 0x%x>\\n\",\n\t\t\t&core->log.phys, core->log.length);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\n\tnum = scnprintf(str, sizeof(str), \"power %s\\n\",\n\t\t\tvpu_iface_get_power_state(core) ? \"on\" : \"off\");\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str), \"state = %d\\n\", core->state);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tif (core->state == VPU_CORE_DEINIT)\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str), \"fw version = %d.%d.%d\\n\",\n\t\t\t(core->fw_version >> 16) & 0xff,\n\t\t\t(core->fw_version >> 8) & 0xff,\n\t\t\tcore->fw_version & 0xff);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str), \"instances = %d/%d (0x%02lx), %d\\n\",\n\t\t\thweight32(core->instance_mask),\n\t\t\tcore->supported_instance_count,\n\t\t\tcore->instance_mask,\n\t\t\tcore->request_count);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str), \"kfifo len = 0x%x\\n\", kfifo_len(&core->msg_fifo));\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str),\n\t\t\t\"cmd_buf:[0x%x, 0x%x], wptr = 0x%x, rptr = 0x%x\\n\",\n\t\t\tiface->cmd_desc->start,\n\t\t\tiface->cmd_desc->end,\n\t\t\tiface->cmd_desc->wptr,\n\t\t\tiface->cmd_desc->rptr);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\tnum = scnprintf(str, sizeof(str),\n\t\t\t\"msg_buf:[0x%x, 0x%x], wptr = 0x%x, rptr = 0x%x\\n\",\n\t\t\tiface->msg_desc->start,\n\t\t\tiface->msg_desc->end,\n\t\t\tiface->msg_desc->wptr,\n\t\t\tiface->msg_desc->rptr);\n\tif (seq_write(s, str, num))\n\t\treturn 0;\n\n\treturn 0;\n}\n\nstatic int vpu_dbg_fwlog(struct seq_file *s, void *data)\n{\n\tstruct vpu_core *core = s->private;\n\tstruct print_buf_desc *print_buf;\n\tint length;\n\tu32 rptr;\n\tu32 wptr;\n\tint ret = 0;\n\n\tif (!core->log.virt || core->state == VPU_CORE_DEINIT)\n\t\treturn 0;\n\n\tprint_buf = core->log.virt;\n\trptr = print_buf->read;\n\twptr = print_buf->write;\n\n\tif (rptr == wptr)\n\t\treturn 0;\n\telse if (rptr < wptr)\n\t\tlength = wptr - rptr;\n\telse\n\t\tlength = print_buf->bytes + wptr - rptr;\n\n\tif (s->count + length >= s->size) {\n\t\ts->count = s->size;\n\t\treturn 0;\n\t}\n\n\tif (rptr + length >= print_buf->bytes) {\n\t\tint num = print_buf->bytes - rptr;\n\n\t\tif (seq_write(s, print_buf->buffer + rptr, num))\n\t\t\tret = -1;\n\t\tlength -= num;\n\t\trptr = 0;\n\t}\n\n\tif (length) {\n\t\tif (seq_write(s, print_buf->buffer + rptr, length))\n\t\t\tret = -1;\n\t\trptr += length;\n\t}\n\tif (!ret)\n\t\tprint_buf->read = rptr;\n\n\treturn 0;\n}\n\nstatic int vpu_dbg_inst_open(struct inode *inode, struct file *filp)\n{\n\treturn single_open(filp, vpu_dbg_instance, inode->i_private);\n}\n\nstatic ssize_t vpu_dbg_inst_write(struct file *file,\n\t\t\t\t  const char __user *user_buf, size_t size, loff_t *ppos)\n{\n\tstruct seq_file *s = file->private_data;\n\tstruct vpu_inst *inst = s->private;\n\n\tvpu_session_debug(inst);\n\n\treturn size;\n}\n\nstatic ssize_t vpu_dbg_core_write(struct file *file,\n\t\t\t\t  const char __user *user_buf, size_t size, loff_t *ppos)\n{\n\tstruct seq_file *s = file->private_data;\n\tstruct vpu_core *core = s->private;\n\n\tpm_runtime_resume_and_get(core->dev);\n\tmutex_lock(&core->lock);\n\tif (vpu_iface_get_power_state(core) && !core->request_count) {\n\t\tdev_info(core->dev, \"reset\\n\");\n\t\tif (!vpu_core_sw_reset(core)) {\n\t\t\tvpu_core_set_state(core, VPU_CORE_ACTIVE);\n\t\t\tcore->hang_mask = 0;\n\t\t}\n\t}\n\tmutex_unlock(&core->lock);\n\tpm_runtime_put_sync(core->dev);\n\n\treturn size;\n}\n\nstatic int vpu_dbg_core_open(struct inode *inode, struct file *filp)\n{\n\treturn single_open(filp, vpu_dbg_core, inode->i_private);\n}\n\nstatic int vpu_dbg_fwlog_open(struct inode *inode, struct file *filp)\n{\n\treturn single_open(filp, vpu_dbg_fwlog, inode->i_private);\n}\n\nstatic const struct file_operations vpu_dbg_inst_fops = {\n\t.owner = THIS_MODULE,\n\t.open = vpu_dbg_inst_open,\n\t.release = single_release,\n\t.read = seq_read,\n\t.write = vpu_dbg_inst_write,\n};\n\nstatic const struct file_operations vpu_dbg_core_fops = {\n\t.owner = THIS_MODULE,\n\t.open = vpu_dbg_core_open,\n\t.release = single_release,\n\t.read = seq_read,\n\t.write = vpu_dbg_core_write,\n};\n\nstatic const struct file_operations vpu_dbg_fwlog_fops = {\n\t.owner = THIS_MODULE,\n\t.open = vpu_dbg_fwlog_open,\n\t.release = single_release,\n\t.read = seq_read,\n};\n\nint vpu_inst_create_dbgfs_file(struct vpu_inst *inst)\n{\n\tstruct vpu_dev *vpu;\n\tchar name[64];\n\n\tif (!inst || !inst->core || !inst->core->vpu)\n\t\treturn -EINVAL;\n\n\tvpu = inst->core->vpu;\n\tif (!vpu->debugfs)\n\t\treturn -EINVAL;\n\n\tif (inst->debugfs)\n\t\treturn 0;\n\n\tscnprintf(name, sizeof(name), \"instance.%d.%d\", inst->core->id, inst->id);\n\tinst->debugfs = debugfs_create_file((const char *)name,\n\t\t\t\t\t    VERIFY_OCTAL_PERMISSIONS(0644),\n\t\t\t\t\t    vpu->debugfs,\n\t\t\t\t\t    inst,\n\t\t\t\t\t    &vpu_dbg_inst_fops);\n\n\treturn 0;\n}\n\nint vpu_inst_remove_dbgfs_file(struct vpu_inst *inst)\n{\n\tif (!inst)\n\t\treturn 0;\n\n\tdebugfs_remove(inst->debugfs);\n\tinst->debugfs = NULL;\n\n\treturn 0;\n}\n\nint vpu_core_create_dbgfs_file(struct vpu_core *core)\n{\n\tstruct vpu_dev *vpu;\n\tchar name[64];\n\n\tif (!core || !core->vpu)\n\t\treturn -EINVAL;\n\n\tvpu = core->vpu;\n\tif (!vpu->debugfs)\n\t\treturn -EINVAL;\n\n\tif (!core->debugfs) {\n\t\tscnprintf(name, sizeof(name), \"core.%d\", core->id);\n\t\tcore->debugfs = debugfs_create_file((const char *)name,\n\t\t\t\t\t\t    VERIFY_OCTAL_PERMISSIONS(0644),\n\t\t\t\t\t\t    vpu->debugfs,\n\t\t\t\t\t\t    core,\n\t\t\t\t\t\t    &vpu_dbg_core_fops);\n\t}\n\tif (!core->debugfs_fwlog) {\n\t\tscnprintf(name, sizeof(name), \"fwlog.%d\", core->id);\n\t\tcore->debugfs_fwlog = debugfs_create_file((const char *)name,\n\t\t\t\t\t\t\t  VERIFY_OCTAL_PERMISSIONS(0444),\n\t\t\t\t\t\t\t  vpu->debugfs,\n\t\t\t\t\t\t\t  core,\n\t\t\t\t\t\t\t  &vpu_dbg_fwlog_fops);\n\t}\n\n\treturn 0;\n}\n\nint vpu_core_remove_dbgfs_file(struct vpu_core *core)\n{\n\tif (!core)\n\t\treturn 0;\n\tdebugfs_remove(core->debugfs);\n\tcore->debugfs = NULL;\n\tdebugfs_remove(core->debugfs_fwlog);\n\tcore->debugfs_fwlog = NULL;\n\n\treturn 0;\n}\n\nvoid vpu_inst_record_flow(struct vpu_inst *inst, u32 flow)\n{\n\tif (!inst)\n\t\treturn;\n\n\tinst->flows[inst->flow_idx] = flow;\n\tinst->flow_idx = (inst->flow_idx + 1) % (ARRAY_SIZE(inst->flows));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}