{
  "module_name": "vpu_rpc.h",
  "hash_id": "67776581267be6a699ba011b485b383739434d2f5bbd4071451203627981f8d0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/amphion/vpu_rpc.h",
  "human_readable_source": " \n \n\n#ifndef _AMPHION_VPU_RPC_H\n#define _AMPHION_VPU_RPC_H\n\n#include <media/videobuf2-core.h>\n#include \"vpu_codec.h\"\n\nstruct vpu_rpc_buffer_desc {\n\tu32 wptr;\n\tu32 rptr;\n\tu32 start;\n\tu32 end;\n};\n\nstruct vpu_shared_addr {\n\tvoid *iface;\n\tstruct vpu_rpc_buffer_desc *cmd_desc;\n\tvoid *cmd_mem_vir;\n\tstruct vpu_rpc_buffer_desc *msg_desc;\n\tvoid *msg_mem_vir;\n\n\tunsigned long boot_addr;\n\tstruct vpu_core *core;\n\tvoid *priv;\n};\n\nstruct vpu_rpc_event_header {\n\tu32 index;\n\tu32 id;\n\tu32 num;\n};\n\nstruct vpu_rpc_event {\n\tstruct vpu_rpc_event_header hdr;\n\tu32 data[128];\n};\n\nstruct vpu_iface_ops {\n\tbool (*check_codec)(enum vpu_core_type type);\n\tbool (*check_fmt)(enum vpu_core_type type, u32 pixelfmt);\n\tu32 (*get_data_size)(void);\n\tint (*check_memory_region)(dma_addr_t base, dma_addr_t addr, u32 size);\n\tint (*boot_core)(struct vpu_core *core);\n\tint (*shutdown_core)(struct vpu_core *core);\n\tint (*restore_core)(struct vpu_core *core);\n\tint (*get_power_state)(struct vpu_core *core);\n\tint (*on_firmware_loaded)(struct vpu_core *core);\n\tvoid (*init_rpc)(struct vpu_shared_addr *shared,\n\t\t\t struct vpu_buffer *rpc, dma_addr_t boot_addr);\n\tvoid (*set_log_buf)(struct vpu_shared_addr *shared,\n\t\t\t    struct vpu_buffer *log);\n\tvoid (*set_system_cfg)(struct vpu_shared_addr *shared,\n\t\t\t       u32 regs_base, void __iomem *regs, u32 index);\n\tvoid (*set_stream_cfg)(struct vpu_shared_addr *shared, u32 index);\n\tu32 (*get_version)(struct vpu_shared_addr *shared);\n\tu32 (*get_max_instance_count)(struct vpu_shared_addr *shared);\n\tint (*get_stream_buffer_size)(struct vpu_shared_addr *shared);\n\tint (*send_cmd_buf)(struct vpu_shared_addr *shared,\n\t\t\t    struct vpu_rpc_event *cmd);\n\tint (*receive_msg_buf)(struct vpu_shared_addr *shared,\n\t\t\t       struct vpu_rpc_event *msg);\n\tint (*pack_cmd)(struct vpu_rpc_event *pkt, u32 index, u32 id, void *data);\n\tint (*convert_msg_id)(u32 msg_id);\n\tint (*unpack_msg_data)(struct vpu_rpc_event *pkt, void *data);\n\tint (*input_frame)(struct vpu_shared_addr *shared,\n\t\t\t   struct vpu_inst *inst, struct vb2_buffer *vb);\n\tint (*config_memory_resource)(struct vpu_shared_addr *shared,\n\t\t\t\t      u32 instance,\n\t\t\t\t      u32 type,\n\t\t\t\t      u32 index,\n\t\t\t\t      struct vpu_buffer *buf);\n\tint (*config_stream_buffer)(struct vpu_shared_addr *shared,\n\t\t\t\t    u32 instance,\n\t\t\t\t    struct vpu_buffer *buf);\n\tint (*update_stream_buffer)(struct vpu_shared_addr *shared,\n\t\t\t\t    u32 instance, u32 ptr, bool write);\n\tint (*get_stream_buffer_desc)(struct vpu_shared_addr *shared,\n\t\t\t\t      u32 instance,\n\t\t\t\t      struct vpu_rpc_buffer_desc *desc);\n\tint (*set_encode_params)(struct vpu_shared_addr *shared,\n\t\t\t\t u32 instance,\n\t\t\t\t struct vpu_encode_params *params,\n\t\t\t\t u32 update);\n\tint (*set_decode_params)(struct vpu_shared_addr *shared,\n\t\t\t\t u32 instance,\n\t\t\t\t struct vpu_decode_params *params,\n\t\t\t\t u32 update);\n\tint (*add_scode)(struct vpu_shared_addr *shared,\n\t\t\t u32 instance,\n\t\t\t struct vpu_buffer *stream_buffer,\n\t\t\t u32 pixelformat,\n\t\t\t u32 scode_type);\n\tint (*pre_send_cmd)(struct vpu_shared_addr *shared, u32 instance);\n\tint (*post_send_cmd)(struct vpu_shared_addr *shared, u32 instance);\n\tint (*init_instance)(struct vpu_shared_addr *shared, u32 instance);\n};\n\nenum {\n\tVPU_CORE_MEMORY_INVALID = 0,\n\tVPU_CORE_MEMORY_CACHED,\n\tVPU_CORE_MEMORY_UNCACHED\n};\n\nstruct vpu_rpc_region_t {\n\tdma_addr_t start;\n\tdma_addr_t end;\n\tdma_addr_t type;\n};\n\nstruct vpu_iface_ops *vpu_core_get_iface(struct vpu_core *core);\nstruct vpu_iface_ops *vpu_inst_get_iface(struct vpu_inst *inst);\nint vpu_iface_check_memory_region(struct vpu_core *core, dma_addr_t addr, u32 size);\n\nstatic inline bool vpu_iface_check_codec(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (ops && ops->check_codec)\n\t\treturn ops->check_codec(core->type);\n\n\treturn true;\n}\n\nstatic inline bool vpu_iface_check_format(struct vpu_inst *inst, u32 pixelfmt)\n{\n\tstruct vpu_iface_ops *ops = vpu_inst_get_iface(inst);\n\n\tif (ops && ops->check_fmt)\n\t\treturn ops->check_fmt(inst->type, pixelfmt);\n\n\treturn true;\n}\n\nstatic inline int vpu_iface_boot_core(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (ops && ops->boot_core)\n\t\treturn ops->boot_core(core);\n\treturn 0;\n}\n\nstatic inline int vpu_iface_get_power_state(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (ops && ops->get_power_state)\n\t\treturn ops->get_power_state(core);\n\treturn 1;\n}\n\nstatic inline int vpu_iface_shutdown_core(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (ops && ops->shutdown_core)\n\t\treturn ops->shutdown_core(core);\n\treturn 0;\n}\n\nstatic inline int vpu_iface_restore_core(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (ops && ops->restore_core)\n\t\treturn ops->restore_core(core);\n\treturn 0;\n}\n\nstatic inline int vpu_iface_on_firmware_loaded(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (ops && ops->on_firmware_loaded)\n\t\treturn ops->on_firmware_loaded(core);\n\n\treturn 0;\n}\n\nstatic inline u32 vpu_iface_get_data_size(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->get_data_size)\n\t\treturn 0;\n\n\treturn ops->get_data_size();\n}\n\nstatic inline int vpu_iface_init(struct vpu_core *core,\n\t\t\t\t struct vpu_shared_addr *shared,\n\t\t\t\t struct vpu_buffer *rpc,\n\t\t\t\t dma_addr_t boot_addr)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->init_rpc)\n\t\treturn -EINVAL;\n\n\tops->init_rpc(shared, rpc, boot_addr);\n\tcore->iface = shared;\n\tshared->core = core;\n\tif (rpc->bytesused > rpc->length)\n\t\treturn -ENOSPC;\n\treturn 0;\n}\n\nstatic inline int vpu_iface_set_log_buf(struct vpu_core *core,\n\t\t\t\t\tstruct vpu_buffer *log)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops)\n\t\treturn -EINVAL;\n\n\tif (ops->set_log_buf)\n\t\tops->set_log_buf(core->iface, log);\n\n\treturn 0;\n}\n\nstatic inline int vpu_iface_config_system(struct vpu_core *core, u32 regs_base, void __iomem *regs)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops)\n\t\treturn -EINVAL;\n\tif (ops->set_system_cfg)\n\t\tops->set_system_cfg(core->iface, regs_base, regs, core->id);\n\n\treturn 0;\n}\n\nstatic inline int vpu_iface_get_stream_buffer_size(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->get_stream_buffer_size)\n\t\treturn 0;\n\n\treturn ops->get_stream_buffer_size(core->iface);\n}\n\nstatic inline int vpu_iface_config_stream(struct vpu_inst *inst)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (!ops || inst->id < 0)\n\t\treturn -EINVAL;\n\tif (ops->set_stream_cfg)\n\t\tops->set_stream_cfg(inst->core->iface, inst->id);\n\treturn 0;\n}\n\nstatic inline int vpu_iface_send_cmd(struct vpu_core *core, struct vpu_rpc_event *cmd)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->send_cmd_buf)\n\t\treturn -EINVAL;\n\n\treturn ops->send_cmd_buf(core->iface, cmd);\n}\n\nstatic inline int vpu_iface_receive_msg(struct vpu_core *core, struct vpu_rpc_event *msg)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->receive_msg_buf)\n\t\treturn -EINVAL;\n\n\treturn ops->receive_msg_buf(core->iface, msg);\n}\n\nstatic inline int vpu_iface_pack_cmd(struct vpu_core *core,\n\t\t\t\t     struct vpu_rpc_event *pkt,\n\t\t\t\t     u32 index, u32 id, void *data)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->pack_cmd)\n\t\treturn -EINVAL;\n\treturn ops->pack_cmd(pkt, index, id, data);\n}\n\nstatic inline int vpu_iface_convert_msg_id(struct vpu_core *core, u32 msg_id)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->convert_msg_id)\n\t\treturn -EINVAL;\n\n\treturn ops->convert_msg_id(msg_id);\n}\n\nstatic inline int vpu_iface_unpack_msg_data(struct vpu_core *core,\n\t\t\t\t\t    struct vpu_rpc_event *pkt, void *data)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->unpack_msg_data)\n\t\treturn -EINVAL;\n\n\treturn ops->unpack_msg_data(pkt, data);\n}\n\nstatic inline int vpu_iface_input_frame(struct vpu_inst *inst,\n\t\t\t\t\tstruct vb2_buffer *vb)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\tint ret;\n\n\tif (!ops || !ops->input_frame)\n\t\treturn -EINVAL;\n\n\tret = ops->input_frame(inst->core->iface, inst, vb);\n\tif (ret < 0)\n\t\treturn ret;\n\tinst->total_input_count++;\n\treturn ret;\n}\n\nstatic inline int vpu_iface_config_memory_resource(struct vpu_inst *inst,\n\t\t\t\t\t\t   u32 type,\n\t\t\t\t\t\t   u32 index,\n\t\t\t\t\t\t   struct vpu_buffer *buf)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (!ops || !ops->config_memory_resource || inst->id < 0)\n\t\treturn -EINVAL;\n\n\treturn ops->config_memory_resource(inst->core->iface,\n\t\t\t\t\tinst->id,\n\t\t\t\t\ttype, index, buf);\n}\n\nstatic inline int vpu_iface_config_stream_buffer(struct vpu_inst *inst,\n\t\t\t\t\t\t struct vpu_buffer *buf)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (!ops || !ops->config_stream_buffer || inst->id < 0)\n\t\treturn -EINVAL;\n\n\tif ((buf->phys % 4) || (buf->length % 4))\n\t\treturn -EINVAL;\n\tif (buf->phys + buf->length > (u64)UINT_MAX)\n\t\treturn -EINVAL;\n\n\treturn ops->config_stream_buffer(inst->core->iface, inst->id, buf);\n}\n\nstatic inline int vpu_iface_update_stream_buffer(struct vpu_inst *inst,\n\t\t\t\t\t\t u32 ptr, bool write)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (!ops || !ops->update_stream_buffer || inst->id < 0)\n\t\treturn -EINVAL;\n\n\treturn ops->update_stream_buffer(inst->core->iface, inst->id, ptr, write);\n}\n\nstatic inline int vpu_iface_get_stream_buffer_desc(struct vpu_inst *inst,\n\t\t\t\t\t\t   struct vpu_rpc_buffer_desc *desc)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (!ops || !ops->get_stream_buffer_desc || inst->id < 0)\n\t\treturn -EINVAL;\n\n\tif (!desc)\n\t\treturn 0;\n\n\treturn ops->get_stream_buffer_desc(inst->core->iface, inst->id, desc);\n}\n\nstatic inline u32 vpu_iface_get_version(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->get_version)\n\t\treturn 0;\n\n\treturn ops->get_version(core->iface);\n}\n\nstatic inline u32 vpu_iface_get_max_instance_count(struct vpu_core *core)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(core);\n\n\tif (!ops || !ops->get_max_instance_count)\n\t\treturn 0;\n\n\treturn ops->get_max_instance_count(core->iface);\n}\n\nstatic inline int vpu_iface_set_encode_params(struct vpu_inst *inst,\n\t\t\t\t\t      struct vpu_encode_params *params, u32 update)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (!ops || !ops->set_encode_params || inst->id < 0)\n\t\treturn -EINVAL;\n\n\treturn ops->set_encode_params(inst->core->iface, inst->id, params, update);\n}\n\nstatic inline int vpu_iface_set_decode_params(struct vpu_inst *inst,\n\t\t\t\t\t      struct vpu_decode_params *params, u32 update)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (!ops || !ops->set_decode_params  || inst->id < 0)\n\t\treturn -EINVAL;\n\n\treturn ops->set_decode_params(inst->core->iface, inst->id, params, update);\n}\n\nstatic inline int vpu_iface_add_scode(struct vpu_inst *inst, u32 scode_type)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (!ops || !ops->add_scode  || inst->id < 0)\n\t\treturn -EINVAL;\n\n\treturn ops->add_scode(inst->core->iface, inst->id,\n\t\t\t\t&inst->stream_buffer,\n\t\t\t\tinst->out_format.pixfmt,\n\t\t\t\tscode_type);\n}\n\nstatic inline int vpu_iface_pre_send_cmd(struct vpu_inst *inst)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (ops && ops->pre_send_cmd && inst->id >= 0)\n\t\treturn ops->pre_send_cmd(inst->core->iface, inst->id);\n\treturn 0;\n}\n\nstatic inline int vpu_iface_post_send_cmd(struct vpu_inst *inst)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (ops && ops->post_send_cmd && inst->id >= 0)\n\t\treturn ops->post_send_cmd(inst->core->iface, inst->id);\n\treturn 0;\n}\n\nstatic inline int vpu_iface_init_instance(struct vpu_inst *inst)\n{\n\tstruct vpu_iface_ops *ops = vpu_core_get_iface(inst->core);\n\n\tif (ops && ops->init_instance && inst->id >= 0)\n\t\treturn ops->init_instance(inst->core->iface, inst->id);\n\n\treturn 0;\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}