{
  "module_name": "hantro.h",
  "hash_id": "9c1edc1871f2002bdb84138ddb34c002f5c3b30fc6c347b5c25683379efd6e75",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/verisilicon/hantro.h",
  "human_readable_source": " \n \n\n#ifndef HANTRO_H_\n#define HANTRO_H_\n\n#include <linux/platform_device.h>\n#include <linux/videodev2.h>\n#include <linux/wait.h>\n#include <linux/clk.h>\n#include <linux/reset.h>\n\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-mem2mem.h>\n#include <media/videobuf2-core.h>\n#include <media/videobuf2-dma-contig.h>\n\n#include \"hantro_hw.h\"\n\nstruct hantro_ctx;\nstruct hantro_codec_ops;\nstruct hantro_postproc_ops;\n\n#define HANTRO_JPEG_ENCODER\tBIT(0)\n#define HANTRO_ENCODERS\t\t0x0000ffff\n#define HANTRO_MPEG2_DECODER\tBIT(16)\n#define HANTRO_VP8_DECODER\tBIT(17)\n#define HANTRO_H264_DECODER\tBIT(18)\n#define HANTRO_HEVC_DECODER\tBIT(19)\n#define HANTRO_VP9_DECODER\tBIT(20)\n#define HANTRO_AV1_DECODER\tBIT(21)\n#define HANTRO_DECODERS\t\t0xffff0000\n\n \nstruct hantro_irq {\n\tconst char *name;\n\tirqreturn_t (*handler)(int irq, void *priv);\n};\n\n \nstruct hantro_variant {\n\tunsigned int enc_offset;\n\tunsigned int dec_offset;\n\tconst struct hantro_fmt *enc_fmts;\n\tunsigned int num_enc_fmts;\n\tconst struct hantro_fmt *dec_fmts;\n\tunsigned int num_dec_fmts;\n\tconst struct hantro_fmt *postproc_fmts;\n\tunsigned int num_postproc_fmts;\n\tconst struct hantro_postproc_ops *postproc_ops;\n\tunsigned int codec;\n\tconst struct hantro_codec_ops *codec_ops;\n\tint (*init)(struct hantro_dev *vpu);\n\tint (*runtime_resume)(struct hantro_dev *vpu);\n\tconst struct hantro_irq *irqs;\n\tint num_irqs;\n\tconst char * const *clk_names;\n\tint num_clocks;\n\tconst char * const *reg_names;\n\tint num_regs;\n\tunsigned int double_buffer : 1;\n\tunsigned int legacy_regs : 1;\n\tunsigned int late_postproc : 1;\n};\n\n \nenum hantro_codec_mode {\n\tHANTRO_MODE_NONE = -1,\n\tHANTRO_MODE_JPEG_ENC,\n\tHANTRO_MODE_H264_DEC,\n\tHANTRO_MODE_MPEG2_DEC,\n\tHANTRO_MODE_VP8_DEC,\n\tHANTRO_MODE_HEVC_DEC,\n\tHANTRO_MODE_VP9_DEC,\n\tHANTRO_MODE_AV1_DEC,\n};\n\n \nstruct hantro_ctrl {\n\tunsigned int codec;\n\tstruct v4l2_ctrl_config cfg;\n};\n\n \nstruct hantro_func {\n\tunsigned int id;\n\tstruct video_device vdev;\n\tstruct media_pad source_pad;\n\tstruct media_entity sink;\n\tstruct media_pad sink_pad;\n\tstruct media_entity proc;\n\tstruct media_pad proc_pads[2];\n\tstruct media_intf_devnode *intf_devnode;\n};\n\nstatic inline struct hantro_func *\nhantro_vdev_to_func(struct video_device *vdev)\n{\n\treturn container_of(vdev, struct hantro_func, vdev);\n}\n\n \nstruct hantro_dev {\n\tstruct v4l2_device v4l2_dev;\n\tstruct v4l2_m2m_dev *m2m_dev;\n\tstruct media_device mdev;\n\tstruct hantro_func *encoder;\n\tstruct hantro_func *decoder;\n\tstruct platform_device *pdev;\n\tstruct device *dev;\n\tstruct clk_bulk_data *clocks;\n\tstruct reset_control *resets;\n\tvoid __iomem **reg_bases;\n\tvoid __iomem *enc_base;\n\tvoid __iomem *dec_base;\n\tvoid __iomem *ctrl_base;\n\n\tstruct mutex vpu_mutex;\t \n\tspinlock_t irqlock;\n\tconst struct hantro_variant *variant;\n\tstruct delayed_work watchdog_work;\n};\n\n \nstruct hantro_ctx {\n\tstruct hantro_dev *dev;\n\tstruct v4l2_fh fh;\n\tbool is_encoder;\n\n\tu32 sequence_cap;\n\tu32 sequence_out;\n\n\tconst struct hantro_fmt *vpu_src_fmt;\n\tstruct v4l2_pix_format_mplane src_fmt;\n\tconst struct hantro_fmt *vpu_dst_fmt;\n\tstruct v4l2_pix_format_mplane dst_fmt;\n\n\tstruct v4l2_ctrl_handler ctrl_handler;\n\tint jpeg_quality;\n\tint bit_depth;\n\n\tconst struct hantro_codec_ops *codec_ops;\n\tstruct hantro_postproc_ctx postproc;\n\tbool need_postproc;\n\n\t \n\tunion {\n\t\tstruct hantro_h264_dec_hw_ctx h264_dec;\n\t\tstruct hantro_mpeg2_dec_hw_ctx mpeg2_dec;\n\t\tstruct hantro_vp8_dec_hw_ctx vp8_dec;\n\t\tstruct hantro_hevc_dec_hw_ctx hevc_dec;\n\t\tstruct hantro_vp9_dec_hw_ctx vp9_dec;\n\t\tstruct hantro_av1_dec_hw_ctx av1_dec;\n\t};\n};\n\n \nstruct hantro_fmt {\n\tchar *name;\n\tu32 fourcc;\n\tenum hantro_codec_mode codec_mode;\n\tint header_size;\n\tint max_depth;\n\tenum hantro_enc_fmt enc_fmt;\n\tstruct v4l2_frmsize_stepwise frmsize;\n\tbool postprocessed;\n\tbool match_depth;\n};\n\nstruct hantro_reg {\n\tu32 base;\n\tu32 shift;\n\tu32 mask;\n};\n\nstruct hantro_postproc_regs {\n\tstruct hantro_reg pipeline_en;\n\tstruct hantro_reg max_burst;\n\tstruct hantro_reg clk_gate;\n\tstruct hantro_reg out_swap32;\n\tstruct hantro_reg out_endian;\n\tstruct hantro_reg out_luma_base;\n\tstruct hantro_reg input_width;\n\tstruct hantro_reg input_height;\n\tstruct hantro_reg output_width;\n\tstruct hantro_reg output_height;\n\tstruct hantro_reg input_fmt;\n\tstruct hantro_reg output_fmt;\n\tstruct hantro_reg orig_width;\n\tstruct hantro_reg display_width;\n};\n\nstruct hantro_vp9_decoded_buffer_info {\n\t \n\tunsigned short width;\n\tunsigned short height;\n\tu32 bit_depth : 4;\n};\n\nstruct hantro_decoded_buffer {\n\t \n\tstruct v4l2_m2m_buffer base;\n\n\tunion {\n\t\tstruct hantro_vp9_decoded_buffer_info vp9;\n\t};\n};\n\n \n\n \nextern int hantro_debug;\n\n#define vpu_debug(level, fmt, args...)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\tif (hantro_debug & BIT(level))\t\t\\\n\t\t\tpr_info(\"%s:%d: \" fmt,\t                \\\n\t\t\t\t __func__, __LINE__, ##args);\t\\\n\t} while (0)\n\n#define vpu_err(fmt, args...)\t\t\t\t\t\\\n\tpr_err(\"%s:%d: \" fmt, __func__, __LINE__, ##args)\n\n \nstatic __always_inline struct hantro_ctx *fh_to_ctx(struct v4l2_fh *fh)\n{\n\treturn container_of(fh, struct hantro_ctx, fh);\n}\n\n \nstatic __always_inline void vepu_write_relaxed(struct hantro_dev *vpu,\n\t\t\t\t\t       u32 val, u32 reg)\n{\n\tvpu_debug(6, \"0x%04x = 0x%08x\\n\", reg / 4, val);\n\twritel_relaxed(val, vpu->enc_base + reg);\n}\n\nstatic __always_inline void vepu_write(struct hantro_dev *vpu, u32 val, u32 reg)\n{\n\tvpu_debug(6, \"0x%04x = 0x%08x\\n\", reg / 4, val);\n\twritel(val, vpu->enc_base + reg);\n}\n\nstatic __always_inline u32 vepu_read(struct hantro_dev *vpu, u32 reg)\n{\n\tu32 val = readl(vpu->enc_base + reg);\n\n\tvpu_debug(6, \"0x%04x = 0x%08x\\n\", reg / 4, val);\n\treturn val;\n}\n\nstatic __always_inline void vdpu_write_relaxed(struct hantro_dev *vpu,\n\t\t\t\t\t       u32 val, u32 reg)\n{\n\tvpu_debug(6, \"0x%04x = 0x%08x\\n\", reg / 4, val);\n\twritel_relaxed(val, vpu->dec_base + reg);\n}\n\nstatic __always_inline void vdpu_write(struct hantro_dev *vpu, u32 val, u32 reg)\n{\n\tvpu_debug(6, \"0x%04x = 0x%08x\\n\", reg / 4, val);\n\twritel(val, vpu->dec_base + reg);\n}\n\nstatic __always_inline void hantro_write_addr(struct hantro_dev *vpu,\n\t\t\t\t\t      unsigned long offset,\n\t\t\t\t\t      dma_addr_t addr)\n{\n\tvdpu_write(vpu, addr & 0xffffffff, offset);\n}\n\nstatic __always_inline u32 vdpu_read(struct hantro_dev *vpu, u32 reg)\n{\n\tu32 val = readl(vpu->dec_base + reg);\n\n\tvpu_debug(6, \"0x%04x = 0x%08x\\n\", reg / 4, val);\n\treturn val;\n}\n\nstatic __always_inline u32 vdpu_read_mask(struct hantro_dev *vpu,\n\t\t\t\t\t  const struct hantro_reg *reg,\n\t\t\t\t\t  u32 val)\n{\n\tu32 v;\n\n\tv = vdpu_read(vpu, reg->base);\n\tv &= ~(reg->mask << reg->shift);\n\tv |= ((val & reg->mask) << reg->shift);\n\treturn v;\n}\n\nstatic __always_inline void hantro_reg_write(struct hantro_dev *vpu,\n\t\t\t\t\t     const struct hantro_reg *reg,\n\t\t\t\t\t     u32 val)\n{\n\tvdpu_write(vpu, vdpu_read_mask(vpu, reg, val), reg->base);\n}\n\nstatic __always_inline void hantro_reg_write_relaxed(struct hantro_dev *vpu,\n\t\t\t\t\t\t     const struct hantro_reg *reg,\n\t\t\t\t\t\t     u32 val)\n{\n\tvdpu_write_relaxed(vpu, vdpu_read_mask(vpu, reg, val), reg->base);\n}\n\nvoid *hantro_get_ctrl(struct hantro_ctx *ctx, u32 id);\ndma_addr_t hantro_get_ref(struct hantro_ctx *ctx, u64 ts);\n\nstatic inline struct vb2_v4l2_buffer *\nhantro_get_src_buf(struct hantro_ctx *ctx)\n{\n\treturn v4l2_m2m_next_src_buf(ctx->fh.m2m_ctx);\n}\n\nstatic inline struct vb2_v4l2_buffer *\nhantro_get_dst_buf(struct hantro_ctx *ctx)\n{\n\treturn v4l2_m2m_next_dst_buf(ctx->fh.m2m_ctx);\n}\n\nbool hantro_needs_postproc(const struct hantro_ctx *ctx,\n\t\t\t   const struct hantro_fmt *fmt);\n\nstatic inline dma_addr_t\nhantro_get_dec_buf_addr(struct hantro_ctx *ctx, struct vb2_buffer *vb)\n{\n\tif (hantro_needs_postproc(ctx, ctx->vpu_dst_fmt))\n\t\treturn ctx->postproc.dec_q[vb->index].dma;\n\treturn vb2_dma_contig_plane_dma_addr(vb, 0);\n}\n\nstatic inline struct hantro_decoded_buffer *\nvb2_to_hantro_decoded_buf(struct vb2_buffer *buf)\n{\n\treturn container_of(buf, struct hantro_decoded_buffer, base.vb.vb2_buf);\n}\n\nvoid hantro_postproc_disable(struct hantro_ctx *ctx);\nvoid hantro_postproc_enable(struct hantro_ctx *ctx);\nvoid hantro_postproc_free(struct hantro_ctx *ctx);\nint hantro_postproc_alloc(struct hantro_ctx *ctx);\nint hanto_postproc_enum_framesizes(struct hantro_ctx *ctx,\n\t\t\t\t   struct v4l2_frmsizeenum *fsize);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}