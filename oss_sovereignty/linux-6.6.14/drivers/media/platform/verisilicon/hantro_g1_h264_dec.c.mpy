{
  "module_name": "hantro_g1_h264_dec.c",
  "hash_id": "0229829ec33380789d02d19ecb78fa763e0e6c6b79acefe455d9dd1e2129ae33",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/verisilicon/hantro_g1_h264_dec.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/sort.h>\n\n#include <media/v4l2-mem2mem.h>\n\n#include \"hantro_g1_regs.h\"\n#include \"hantro_hw.h\"\n#include \"hantro_v4l2.h\"\n\nstatic void set_params(struct hantro_ctx *ctx, struct vb2_v4l2_buffer *src_buf)\n{\n\tconst struct hantro_h264_dec_ctrls *ctrls = &ctx->h264_dec.ctrls;\n\tconst struct v4l2_ctrl_h264_decode_params *dec_param = ctrls->decode;\n\tconst struct v4l2_ctrl_h264_sps *sps = ctrls->sps;\n\tconst struct v4l2_ctrl_h264_pps *pps = ctrls->pps;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tu32 reg;\n\n\t \n\treg = G1_REG_DEC_CTRL0_DEC_AXI_AUTO;\n\tif (sps->flags & V4L2_H264_SPS_FLAG_MB_ADAPTIVE_FRAME_FIELD)\n\t\treg |= G1_REG_DEC_CTRL0_SEQ_MBAFF_E;\n\tif (sps->profile_idc > 66) {\n\t\treg |= G1_REG_DEC_CTRL0_PICORD_COUNT_E;\n\t\tif (dec_param->nal_ref_idc)\n\t\t\treg |= G1_REG_DEC_CTRL0_WRITE_MVS_E;\n\t}\n\n\tif (!(sps->flags & V4L2_H264_SPS_FLAG_FRAME_MBS_ONLY) &&\n\t    (sps->flags & V4L2_H264_SPS_FLAG_MB_ADAPTIVE_FRAME_FIELD ||\n\t     dec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_FIELD_PIC))\n\t\treg |= G1_REG_DEC_CTRL0_PIC_INTERLACE_E;\n\tif (dec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_FIELD_PIC)\n\t\treg |= G1_REG_DEC_CTRL0_PIC_FIELDMODE_E;\n\tif (!(dec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_BOTTOM_FIELD))\n\t\treg |= G1_REG_DEC_CTRL0_PIC_TOPFIELD_E;\n\tvdpu_write_relaxed(vpu, reg, G1_REG_DEC_CTRL0);\n\n\t \n\treg = G1_REG_DEC_CTRL1_PIC_MB_WIDTH(MB_WIDTH(ctx->src_fmt.width)) |\n\t      G1_REG_DEC_CTRL1_PIC_MB_HEIGHT_P(MB_HEIGHT(ctx->src_fmt.height)) |\n\t      G1_REG_DEC_CTRL1_REF_FRAMES(sps->max_num_ref_frames);\n\tvdpu_write_relaxed(vpu, reg, G1_REG_DEC_CTRL1);\n\n\t \n\treg = G1_REG_DEC_CTRL2_CH_QP_OFFSET(pps->chroma_qp_index_offset) |\n\t      G1_REG_DEC_CTRL2_CH_QP_OFFSET2(pps->second_chroma_qp_index_offset);\n\n\tif (pps->flags & V4L2_H264_PPS_FLAG_SCALING_MATRIX_PRESENT)\n\t\treg |= G1_REG_DEC_CTRL2_TYPE1_QUANT_E;\n\tif (!(sps->flags & V4L2_H264_SPS_FLAG_FRAME_MBS_ONLY))\n\t\treg |= G1_REG_DEC_CTRL2_FIELDPIC_FLAG_E;\n\tvdpu_write_relaxed(vpu, reg, G1_REG_DEC_CTRL2);\n\n\t \n\treg = G1_REG_DEC_CTRL3_START_CODE_E |\n\t      G1_REG_DEC_CTRL3_INIT_QP(pps->pic_init_qp_minus26 + 26) |\n\t      G1_REG_DEC_CTRL3_STREAM_LEN(vb2_get_plane_payload(&src_buf->vb2_buf, 0));\n\tvdpu_write_relaxed(vpu, reg, G1_REG_DEC_CTRL3);\n\n\t \n\treg = G1_REG_DEC_CTRL4_FRAMENUM_LEN(sps->log2_max_frame_num_minus4 + 4) |\n\t      G1_REG_DEC_CTRL4_FRAMENUM(dec_param->frame_num) |\n\t      G1_REG_DEC_CTRL4_WEIGHT_BIPR_IDC(pps->weighted_bipred_idc);\n\tif (pps->flags & V4L2_H264_PPS_FLAG_ENTROPY_CODING_MODE)\n\t\treg |= G1_REG_DEC_CTRL4_CABAC_E;\n\tif (sps->flags & V4L2_H264_SPS_FLAG_DIRECT_8X8_INFERENCE)\n\t\treg |= G1_REG_DEC_CTRL4_DIR_8X8_INFER_E;\n\tif (sps->profile_idc >= 100 && sps->chroma_format_idc == 0)\n\t\treg |= G1_REG_DEC_CTRL4_BLACKWHITE_E;\n\tif (pps->flags & V4L2_H264_PPS_FLAG_WEIGHTED_PRED)\n\t\treg |= G1_REG_DEC_CTRL4_WEIGHT_PRED_E;\n\tvdpu_write_relaxed(vpu, reg, G1_REG_DEC_CTRL4);\n\n\t \n\treg = G1_REG_DEC_CTRL5_REFPIC_MK_LEN(dec_param->dec_ref_pic_marking_bit_size) |\n\t      G1_REG_DEC_CTRL5_IDR_PIC_ID(dec_param->idr_pic_id);\n\tif (pps->flags & V4L2_H264_PPS_FLAG_CONSTRAINED_INTRA_PRED)\n\t\treg |= G1_REG_DEC_CTRL5_CONST_INTRA_E;\n\tif (pps->flags & V4L2_H264_PPS_FLAG_DEBLOCKING_FILTER_CONTROL_PRESENT)\n\t\treg |= G1_REG_DEC_CTRL5_FILT_CTRL_PRES;\n\tif (pps->flags & V4L2_H264_PPS_FLAG_REDUNDANT_PIC_CNT_PRESENT)\n\t\treg |= G1_REG_DEC_CTRL5_RDPIC_CNT_PRES;\n\tif (pps->flags & V4L2_H264_PPS_FLAG_TRANSFORM_8X8_MODE)\n\t\treg |= G1_REG_DEC_CTRL5_8X8TRANS_FLAG_E;\n\tif (dec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_IDR_PIC)\n\t\treg |= G1_REG_DEC_CTRL5_IDR_PIC_E;\n\tvdpu_write_relaxed(vpu, reg, G1_REG_DEC_CTRL5);\n\n\t \n\treg = G1_REG_DEC_CTRL6_PPS_ID(pps->pic_parameter_set_id) |\n\t      G1_REG_DEC_CTRL6_REFIDX0_ACTIVE(pps->num_ref_idx_l0_default_active_minus1 + 1) |\n\t      G1_REG_DEC_CTRL6_REFIDX1_ACTIVE(pps->num_ref_idx_l1_default_active_minus1 + 1) |\n\t      G1_REG_DEC_CTRL6_POC_LENGTH(dec_param->pic_order_cnt_bit_size);\n\tvdpu_write_relaxed(vpu, reg, G1_REG_DEC_CTRL6);\n\n\t \n\tvdpu_write_relaxed(vpu, 0, G1_REG_ERR_CONC);\n\n\t \n\tvdpu_write_relaxed(vpu,\n\t\t\t   G1_REG_PRED_FLT_PRED_BC_TAP_0_0(1) |\n\t\t\t   G1_REG_PRED_FLT_PRED_BC_TAP_0_1(-5 & 0x3ff) |\n\t\t\t   G1_REG_PRED_FLT_PRED_BC_TAP_0_2(20),\n\t\t\t   G1_REG_PRED_FLT);\n\n\t \n\tvdpu_write_relaxed(vpu, 0, G1_REG_REF_BUF_CTRL);\n\n\t \n\tvdpu_write_relaxed(vpu, G1_REG_REF_BUF_CTRL2_APF_THRESHOLD(8),\n\t\t\t   G1_REG_REF_BUF_CTRL2);\n}\n\nstatic void set_ref(struct hantro_ctx *ctx)\n{\n\tconst struct v4l2_h264_reference *b0_reflist, *b1_reflist, *p_reflist;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tint reg_num;\n\tu32 reg;\n\tint i;\n\n\tvdpu_write_relaxed(vpu, ctx->h264_dec.dpb_valid, G1_REG_VALID_REF);\n\tvdpu_write_relaxed(vpu, ctx->h264_dec.dpb_longterm, G1_REG_LT_REF);\n\n\t \n\tfor (i = 0; i < HANTRO_H264_DPB_SIZE; i += 2) {\n\t\treg = G1_REG_REF_PIC_REFER0_NBR(hantro_h264_get_ref_nbr(ctx, i)) |\n\t\t      G1_REG_REF_PIC_REFER1_NBR(hantro_h264_get_ref_nbr(ctx, i + 1));\n\t\tvdpu_write_relaxed(vpu, reg, G1_REG_REF_PIC(i / 2));\n\t}\n\n\tb0_reflist = ctx->h264_dec.reflists.b0;\n\tb1_reflist = ctx->h264_dec.reflists.b1;\n\tp_reflist = ctx->h264_dec.reflists.p;\n\n\t \n\treg_num = 0;\n\tfor (i = 0; i < 15; i += 3) {\n\t\treg = G1_REG_BD_REF_PIC_BINIT_RLIST_F0(b0_reflist[i].index) |\n\t\t      G1_REG_BD_REF_PIC_BINIT_RLIST_F1(b0_reflist[i + 1].index) |\n\t\t      G1_REG_BD_REF_PIC_BINIT_RLIST_F2(b0_reflist[i + 2].index) |\n\t\t      G1_REG_BD_REF_PIC_BINIT_RLIST_B0(b1_reflist[i].index) |\n\t\t      G1_REG_BD_REF_PIC_BINIT_RLIST_B1(b1_reflist[i + 1].index) |\n\t\t      G1_REG_BD_REF_PIC_BINIT_RLIST_B2(b1_reflist[i + 2].index);\n\t\tvdpu_write_relaxed(vpu, reg, G1_REG_BD_REF_PIC(reg_num++));\n\t}\n\n\t \n\treg = G1_REG_BD_P_REF_PIC_BINIT_RLIST_F15(b0_reflist[15].index) |\n\t      G1_REG_BD_P_REF_PIC_BINIT_RLIST_B15(b1_reflist[15].index) |\n\t      G1_REG_BD_P_REF_PIC_PINIT_RLIST_F0(p_reflist[0].index) |\n\t      G1_REG_BD_P_REF_PIC_PINIT_RLIST_F1(p_reflist[1].index) |\n\t      G1_REG_BD_P_REF_PIC_PINIT_RLIST_F2(p_reflist[2].index) |\n\t      G1_REG_BD_P_REF_PIC_PINIT_RLIST_F3(p_reflist[3].index);\n\tvdpu_write_relaxed(vpu, reg, G1_REG_BD_P_REF_PIC);\n\n\t \n\treg_num = 0;\n\tfor (i = 4; i < HANTRO_H264_DPB_SIZE; i += 6) {\n\t\treg = G1_REG_FWD_PIC_PINIT_RLIST_F0(p_reflist[i].index) |\n\t\t      G1_REG_FWD_PIC_PINIT_RLIST_F1(p_reflist[i + 1].index) |\n\t\t      G1_REG_FWD_PIC_PINIT_RLIST_F2(p_reflist[i + 2].index) |\n\t\t      G1_REG_FWD_PIC_PINIT_RLIST_F3(p_reflist[i + 3].index) |\n\t\t      G1_REG_FWD_PIC_PINIT_RLIST_F4(p_reflist[i + 4].index) |\n\t\t      G1_REG_FWD_PIC_PINIT_RLIST_F5(p_reflist[i + 5].index);\n\t\tvdpu_write_relaxed(vpu, reg, G1_REG_FWD_PIC(reg_num++));\n\t}\n\n\t \n\tfor (i = 0; i < HANTRO_H264_DPB_SIZE; i++) {\n\t\tdma_addr_t dma_addr = hantro_h264_get_ref_buf(ctx, i);\n\n\t\tvdpu_write_relaxed(vpu, dma_addr, G1_REG_ADDR_REF(i));\n\t}\n}\n\nstatic void set_buffers(struct hantro_ctx *ctx, struct vb2_v4l2_buffer *src_buf)\n{\n\tconst struct hantro_h264_dec_ctrls *ctrls = &ctx->h264_dec.ctrls;\n\tstruct vb2_v4l2_buffer *dst_buf;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tdma_addr_t src_dma, dst_dma;\n\tsize_t offset = 0;\n\n\t \n\tsrc_dma = vb2_dma_contig_plane_dma_addr(&src_buf->vb2_buf, 0);\n\tvdpu_write_relaxed(vpu, src_dma, G1_REG_ADDR_STR);\n\n\t \n\tdst_buf = hantro_get_dst_buf(ctx);\n\tdst_dma = hantro_get_dec_buf_addr(ctx, &dst_buf->vb2_buf);\n\t \n\tif (ctrls->decode->flags & V4L2_H264_DECODE_PARAM_FLAG_BOTTOM_FIELD)\n\t\toffset = ALIGN(ctx->src_fmt.width, MB_DIM);\n\tvdpu_write_relaxed(vpu, dst_dma + offset, G1_REG_ADDR_DST);\n\n\t \n\tif (ctrls->sps->profile_idc > 66 && ctrls->decode->nal_ref_idc) {\n\t\tunsigned int bytes_per_mb = 384;\n\n\t\t \n\t\tif (ctrls->sps->profile_idc >= 100 &&\n\t\t    ctrls->sps->chroma_format_idc == 0)\n\t\t\tbytes_per_mb = 256;\n\t\toffset = bytes_per_mb * MB_WIDTH(ctx->src_fmt.width) *\n\t\t\t MB_HEIGHT(ctx->src_fmt.height);\n\n\t\t \n\t\tif (ctrls->decode->flags & V4L2_H264_DECODE_PARAM_FLAG_BOTTOM_FIELD)\n\t\t\toffset += 32 * MB_WIDTH(ctx->src_fmt.width) *\n\t\t\t\t  MB_HEIGHT(ctx->src_fmt.height);\n\t\tvdpu_write_relaxed(vpu, dst_dma + offset, G1_REG_ADDR_DIR_MV);\n\t}\n\n\t \n\tvdpu_write_relaxed(vpu, ctx->h264_dec.priv.dma, G1_REG_ADDR_QTABLE);\n}\n\nint hantro_g1_h264_dec_run(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct vb2_v4l2_buffer *src_buf;\n\tint ret;\n\n\t \n\tret = hantro_h264_dec_prepare_run(ctx);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tsrc_buf = hantro_get_src_buf(ctx);\n\tset_params(ctx, src_buf);\n\tset_ref(ctx);\n\tset_buffers(ctx, src_buf);\n\n\thantro_end_prepare_run(ctx);\n\n\t \n\tvdpu_write_relaxed(vpu,\n\t\t\t   G1_REG_CONFIG_DEC_AXI_RD_ID(0xffu) |\n\t\t\t   G1_REG_CONFIG_DEC_TIMEOUT_E |\n\t\t\t   G1_REG_CONFIG_DEC_OUT_ENDIAN |\n\t\t\t   G1_REG_CONFIG_DEC_STRENDIAN_E |\n\t\t\t   G1_REG_CONFIG_DEC_MAX_BURST(16) |\n\t\t\t   G1_REG_CONFIG_DEC_OUTSWAP32_E |\n\t\t\t   G1_REG_CONFIG_DEC_INSWAP32_E |\n\t\t\t   G1_REG_CONFIG_DEC_STRSWAP32_E |\n\t\t\t   G1_REG_CONFIG_DEC_CLK_GATE_E,\n\t\t\t   G1_REG_CONFIG);\n\tvdpu_write(vpu, G1_REG_INTERRUPT_DEC_E, G1_REG_INTERRUPT);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}