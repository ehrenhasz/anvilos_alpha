{
  "module_name": "hantro_hw.h",
  "hash_id": "b5f21ec76cd6ec8e3016cd737a1a87fc84bc1d1ee45fca3929f6b4fd20d13eae",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/verisilicon/hantro_hw.h",
  "human_readable_source": " \n \n\n#ifndef HANTRO_HW_H_\n#define HANTRO_HW_H_\n\n#include <linux/interrupt.h>\n#include <linux/v4l2-controls.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-vp9.h>\n#include <media/videobuf2-core.h>\n\n#include \"rockchip_av1_entropymode.h\"\n#include \"rockchip_av1_filmgrain.h\"\n\n#define DEC_8190_ALIGN_MASK\t0x07U\n\n#define MB_DIM\t\t\t16\n#define TILE_MB_DIM\t\t4\n#define MB_WIDTH(w)\t\tDIV_ROUND_UP(w, MB_DIM)\n#define MB_HEIGHT(h)\t\tDIV_ROUND_UP(h, MB_DIM)\n\n#define FMT_MIN_WIDTH\t\t48\n#define FMT_MIN_HEIGHT\t\t48\n#define FMT_HD_WIDTH\t\t1280\n#define FMT_HD_HEIGHT\t\t720\n#define FMT_FHD_WIDTH\t\t1920\n#define FMT_FHD_HEIGHT\t\t1088\n#define FMT_UHD_WIDTH\t\t3840\n#define FMT_UHD_HEIGHT\t\t2160\n#define FMT_4K_WIDTH\t\t4096\n#define FMT_4K_HEIGHT\t\t2304\n\n#define NUM_REF_PICTURES\t(V4L2_HEVC_DPB_ENTRIES_NUM_MAX + 1)\n\n#define AV1_MAX_FRAME_BUF_COUNT\t(V4L2_AV1_TOTAL_REFS_PER_FRAME + 1)\n\nstruct hantro_dev;\nstruct hantro_ctx;\nstruct hantro_buf;\nstruct hantro_variant;\n\n \nstruct hantro_aux_buf {\n\tvoid *cpu;\n\tdma_addr_t dma;\n\tsize_t size;\n\tunsigned long attrs;\n};\n\n \n#define HANTRO_H264_DPB_SIZE\t\t16\n\n \nstruct hantro_h264_dec_ctrls {\n\tconst struct v4l2_ctrl_h264_decode_params *decode;\n\tconst struct v4l2_ctrl_h264_scaling_matrix *scaling;\n\tconst struct v4l2_ctrl_h264_sps *sps;\n\tconst struct v4l2_ctrl_h264_pps *pps;\n};\n\n \nstruct hantro_h264_dec_reflists {\n\tstruct v4l2_h264_reference p[V4L2_H264_REF_LIST_LEN];\n\tstruct v4l2_h264_reference b0[V4L2_H264_REF_LIST_LEN];\n\tstruct v4l2_h264_reference b1[V4L2_H264_REF_LIST_LEN];\n};\n\n \nstruct hantro_h264_dec_hw_ctx {\n\tstruct hantro_aux_buf priv;\n\tstruct v4l2_h264_dpb_entry dpb[HANTRO_H264_DPB_SIZE];\n\tstruct hantro_h264_dec_reflists reflists;\n\tstruct hantro_h264_dec_ctrls ctrls;\n\tu32 dpb_longterm;\n\tu32 dpb_valid;\n\ts32 cur_poc;\n};\n\n \nstruct hantro_hevc_dec_ctrls {\n\tconst struct v4l2_ctrl_hevc_decode_params *decode_params;\n\tconst struct v4l2_ctrl_hevc_scaling_matrix *scaling;\n\tconst struct v4l2_ctrl_hevc_sps *sps;\n\tconst struct v4l2_ctrl_hevc_pps *pps;\n\tu32 hevc_hdr_skip_length;\n};\n\n \nstruct hantro_hevc_dec_hw_ctx {\n\tstruct hantro_aux_buf tile_sizes;\n\tstruct hantro_aux_buf tile_filter;\n\tstruct hantro_aux_buf tile_sao;\n\tstruct hantro_aux_buf tile_bsd;\n\tstruct hantro_aux_buf ref_bufs[NUM_REF_PICTURES];\n\tstruct hantro_aux_buf scaling_lists;\n\ts32 ref_bufs_poc[NUM_REF_PICTURES];\n\tu32 ref_bufs_used;\n\tstruct hantro_hevc_dec_ctrls ctrls;\n\tunsigned int num_tile_cols_allocated;\n};\n\n \nstruct hantro_mpeg2_dec_hw_ctx {\n\tstruct hantro_aux_buf qtable;\n};\n\n \nstruct hantro_vp8_dec_hw_ctx {\n\tstruct hantro_aux_buf segment_map;\n\tstruct hantro_aux_buf prob_tbl;\n};\n\n \nstruct hantro_vp9_frame_info {\n\tu32 valid : 1;\n\tu32 frame_context_idx : 2;\n\tu32 reference_mode : 2;\n\tu32 tx_mode : 3;\n\tu32 interpolation_filter : 3;\n\tu32 flags;\n\tu64 timestamp;\n};\n\n#define MAX_SB_COLS\t64\n#define MAX_SB_ROWS\t34\n\n \nstruct hantro_vp9_dec_hw_ctx {\n\tstruct hantro_aux_buf tile_edge;\n\tstruct hantro_aux_buf segment_map;\n\tstruct hantro_aux_buf misc;\n\tstruct v4l2_vp9_frame_symbol_counts cnts;\n\tstruct v4l2_vp9_frame_context probability_tables;\n\tstruct v4l2_vp9_frame_context frame_context[4];\n\tstruct hantro_vp9_frame_info cur;\n\tstruct hantro_vp9_frame_info last;\n\n\tunsigned int bsd_ctrl_offset;\n\tunsigned int segment_map_size;\n\tunsigned int ctx_counters_offset;\n\tunsigned int tile_info_offset;\n\n\tunsigned short tile_r_info[MAX_SB_ROWS];\n\tunsigned short tile_c_info[MAX_SB_COLS];\n\tunsigned int last_tile_r;\n\tunsigned int last_tile_c;\n\tunsigned int last_sbs_r;\n\tunsigned int last_sbs_c;\n\n\tunsigned int active_segment;\n\tu8 feature_enabled[8];\n\ts16 feature_data[8][4];\n};\n\n \nstruct hantro_av1_dec_ctrls {\n\tconst struct v4l2_ctrl_av1_sequence *sequence;\n\tconst struct v4l2_ctrl_av1_tile_group_entry *tile_group_entry;\n\tconst struct v4l2_ctrl_av1_frame *frame;\n\tconst struct v4l2_ctrl_av1_film_grain *film_grain;\n};\n\nstruct hantro_av1_frame_ref {\n\tint width;\n\tint height;\n\tint mi_cols;\n\tint mi_rows;\n\tu64 timestamp;\n\tenum v4l2_av1_frame_type frame_type;\n\tbool used;\n\tu32 order_hint;\n\tu32 order_hints[V4L2_AV1_TOTAL_REFS_PER_FRAME];\n\tstruct vb2_v4l2_buffer *vb2_ref;\n};\n\n \nstruct hantro_av1_dec_hw_ctx {\n\tstruct hantro_aux_buf db_data_col;\n\tstruct hantro_aux_buf db_ctrl_col;\n\tstruct hantro_aux_buf cdef_col;\n\tstruct hantro_aux_buf sr_col;\n\tstruct hantro_aux_buf lr_col;\n\tstruct hantro_aux_buf global_model;\n\tstruct hantro_aux_buf tile_info;\n\tstruct hantro_aux_buf segment;\n\tstruct hantro_aux_buf film_grain;\n\tstruct hantro_aux_buf prob_tbl;\n\tstruct hantro_aux_buf prob_tbl_out;\n\tstruct hantro_aux_buf tile_buf;\n\tstruct hantro_av1_dec_ctrls ctrls;\n\tstruct hantro_av1_frame_ref frame_refs[AV1_MAX_FRAME_BUF_COUNT];\n\tu32 ref_frame_sign_bias[V4L2_AV1_TOTAL_REFS_PER_FRAME];\n\tunsigned int num_tile_cols_allocated;\n\tstruct av1cdfs *cdfs;\n\tstruct mvcdfs  *cdfs_ndvc;\n\tstruct av1cdfs default_cdfs;\n\tstruct mvcdfs  default_cdfs_ndvc;\n\tstruct av1cdfs cdfs_last[NUM_REF_FRAMES];\n\tstruct mvcdfs  cdfs_last_ndvc[NUM_REF_FRAMES];\n\tint current_frame_index;\n};\n \nstruct hantro_postproc_ctx {\n\tstruct hantro_aux_buf dec_q[VB2_MAX_FRAME];\n};\n\n \nstruct hantro_postproc_ops {\n\tvoid (*enable)(struct hantro_ctx *ctx);\n\tvoid (*disable)(struct hantro_ctx *ctx);\n\tint (*enum_framesizes)(struct hantro_ctx *ctx, struct v4l2_frmsizeenum *fsize);\n};\n\n \nstruct hantro_codec_ops {\n\tint (*init)(struct hantro_ctx *ctx);\n\tvoid (*exit)(struct hantro_ctx *ctx);\n\tint (*run)(struct hantro_ctx *ctx);\n\tvoid (*done)(struct hantro_ctx *ctx);\n\tvoid (*reset)(struct hantro_ctx *ctx);\n};\n\n \nenum hantro_enc_fmt {\n\tROCKCHIP_VPU_ENC_FMT_YUV420P = 0,\n\tROCKCHIP_VPU_ENC_FMT_YUV420SP = 1,\n\tROCKCHIP_VPU_ENC_FMT_YUYV422 = 2,\n\tROCKCHIP_VPU_ENC_FMT_UYVY422 = 3,\n};\n\nextern const struct hantro_variant imx8mm_vpu_g1_variant;\nextern const struct hantro_variant imx8mq_vpu_g1_variant;\nextern const struct hantro_variant imx8mq_vpu_g2_variant;\nextern const struct hantro_variant imx8mq_vpu_variant;\nextern const struct hantro_variant px30_vpu_variant;\nextern const struct hantro_variant rk3036_vpu_variant;\nextern const struct hantro_variant rk3066_vpu_variant;\nextern const struct hantro_variant rk3288_vpu_variant;\nextern const struct hantro_variant rk3328_vpu_variant;\nextern const struct hantro_variant rk3399_vpu_variant;\nextern const struct hantro_variant rk3568_vepu_variant;\nextern const struct hantro_variant rk3568_vpu_variant;\nextern const struct hantro_variant rk3588_vpu981_variant;\nextern const struct hantro_variant sama5d4_vdec_variant;\nextern const struct hantro_variant sunxi_vpu_variant;\n\nextern const struct hantro_postproc_ops hantro_g1_postproc_ops;\nextern const struct hantro_postproc_ops hantro_g2_postproc_ops;\nextern const struct hantro_postproc_ops rockchip_vpu981_postproc_ops;\n\nextern const u32 hantro_vp8_dec_mc_filter[8][6];\n\nvoid hantro_watchdog(struct work_struct *work);\nvoid hantro_run(struct hantro_ctx *ctx);\nvoid hantro_irq_done(struct hantro_dev *vpu,\n\t\t     enum vb2_buffer_state result);\nvoid hantro_start_prepare_run(struct hantro_ctx *ctx);\nvoid hantro_end_prepare_run(struct hantro_ctx *ctx);\n\nirqreturn_t hantro_g1_irq(int irq, void *dev_id);\nvoid hantro_g1_reset(struct hantro_ctx *ctx);\n\nint hantro_h1_jpeg_enc_run(struct hantro_ctx *ctx);\nint rockchip_vpu2_jpeg_enc_run(struct hantro_ctx *ctx);\nvoid hantro_h1_jpeg_enc_done(struct hantro_ctx *ctx);\nvoid rockchip_vpu2_jpeg_enc_done(struct hantro_ctx *ctx);\n\ndma_addr_t hantro_h264_get_ref_buf(struct hantro_ctx *ctx,\n\t\t\t\t   unsigned int dpb_idx);\nu16 hantro_h264_get_ref_nbr(struct hantro_ctx *ctx,\n\t\t\t    unsigned int dpb_idx);\nint hantro_h264_dec_prepare_run(struct hantro_ctx *ctx);\nint rockchip_vpu2_h264_dec_run(struct hantro_ctx *ctx);\nint hantro_g1_h264_dec_run(struct hantro_ctx *ctx);\nint hantro_h264_dec_init(struct hantro_ctx *ctx);\nvoid hantro_h264_dec_exit(struct hantro_ctx *ctx);\n\nint hantro_hevc_dec_init(struct hantro_ctx *ctx);\nvoid hantro_hevc_dec_exit(struct hantro_ctx *ctx);\nint hantro_g2_hevc_dec_run(struct hantro_ctx *ctx);\nint hantro_hevc_dec_prepare_run(struct hantro_ctx *ctx);\nvoid hantro_hevc_ref_init(struct hantro_ctx *ctx);\ndma_addr_t hantro_hevc_get_ref_buf(struct hantro_ctx *ctx, s32 poc);\nint hantro_hevc_add_ref_buf(struct hantro_ctx *ctx, int poc, dma_addr_t addr);\n\nint rockchip_vpu981_av1_dec_init(struct hantro_ctx *ctx);\nvoid rockchip_vpu981_av1_dec_exit(struct hantro_ctx *ctx);\nint rockchip_vpu981_av1_dec_run(struct hantro_ctx *ctx);\nvoid rockchip_vpu981_av1_dec_done(struct hantro_ctx *ctx);\n\nstatic inline unsigned short hantro_vp9_num_sbs(unsigned short dimension)\n{\n\treturn (dimension + 63) / 64;\n}\n\nstatic inline size_t\nhantro_vp9_mv_size(unsigned int width, unsigned int height)\n{\n\tint num_ctbs;\n\n\t \n\tnum_ctbs = hantro_vp9_num_sbs(width) * hantro_vp9_num_sbs(height);\n\treturn (num_ctbs * 64) * 16;\n}\n\nstatic inline size_t\nhantro_h264_mv_size(unsigned int width, unsigned int height)\n{\n\t \n\treturn 64 * MB_WIDTH(width) * MB_WIDTH(height) + 32;\n}\n\nstatic inline size_t\nhantro_hevc_mv_size(unsigned int width, unsigned int height)\n{\n\t \n\treturn width * height / 16;\n}\n\nstatic inline unsigned short hantro_av1_num_sbs(unsigned short dimension)\n{\n\treturn DIV_ROUND_UP(dimension, 64);\n}\n\nstatic inline size_t\nhantro_av1_mv_size(unsigned int width, unsigned int height)\n{\n\tsize_t num_sbs = hantro_av1_num_sbs(width) * hantro_av1_num_sbs(height);\n\n\treturn ALIGN(num_sbs * 384, 16) * 2 + 512;\n}\n\nint hantro_g1_mpeg2_dec_run(struct hantro_ctx *ctx);\nint rockchip_vpu2_mpeg2_dec_run(struct hantro_ctx *ctx);\nvoid hantro_mpeg2_dec_copy_qtable(u8 *qtable,\n\t\t\t\t  const struct v4l2_ctrl_mpeg2_quantisation *ctrl);\nint hantro_mpeg2_dec_init(struct hantro_ctx *ctx);\nvoid hantro_mpeg2_dec_exit(struct hantro_ctx *ctx);\n\nint hantro_g1_vp8_dec_run(struct hantro_ctx *ctx);\nint rockchip_vpu2_vp8_dec_run(struct hantro_ctx *ctx);\nint hantro_vp8_dec_init(struct hantro_ctx *ctx);\nvoid hantro_vp8_dec_exit(struct hantro_ctx *ctx);\nvoid hantro_vp8_prob_update(struct hantro_ctx *ctx,\n\t\t\t    const struct v4l2_ctrl_vp8_frame *hdr);\n\nint hantro_g2_vp9_dec_run(struct hantro_ctx *ctx);\nvoid hantro_g2_vp9_dec_done(struct hantro_ctx *ctx);\nint hantro_vp9_dec_init(struct hantro_ctx *ctx);\nvoid hantro_vp9_dec_exit(struct hantro_ctx *ctx);\nvoid hantro_g2_check_idle(struct hantro_dev *vpu);\nirqreturn_t hantro_g2_irq(int irq, void *dev_id);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}