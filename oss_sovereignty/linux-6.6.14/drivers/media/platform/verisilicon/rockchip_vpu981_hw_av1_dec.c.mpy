{
  "module_name": "rockchip_vpu981_hw_av1_dec.c",
  "hash_id": "4bced0457d9be2429b82fb6a83450ce9c52e926748ea21c63dc44c57498ca653",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/verisilicon/rockchip_vpu981_hw_av1_dec.c",
  "human_readable_source": "\n \n\n#include <media/v4l2-mem2mem.h>\n#include \"hantro.h\"\n#include \"hantro_v4l2.h\"\n#include \"rockchip_vpu981_regs.h\"\n\n#define AV1_DEC_MODE\t\t17\n#define GM_GLOBAL_MODELS_PER_FRAME\t7\n#define GLOBAL_MODEL_TOTAL_SIZE\t(6 * 4 + 4 * 2)\n#define GLOBAL_MODEL_SIZE\tALIGN(GM_GLOBAL_MODELS_PER_FRAME * GLOBAL_MODEL_TOTAL_SIZE, 2048)\n#define AV1_MAX_TILES\t\t128\n#define AV1_TILE_INFO_SIZE\t(AV1_MAX_TILES * 16)\n#define AV1DEC_MAX_PIC_BUFFERS\t24\n#define AV1_REF_SCALE_SHIFT\t14\n#define AV1_INVALID_IDX\t\t-1\n#define MAX_FRAME_DISTANCE\t31\n#define AV1_PRIMARY_REF_NONE\t7\n#define AV1_TILE_SIZE\t\tALIGN(32 * 128, 4096)\n \n#define V4L2_AV1_SEG_LVL_ALT_LF_Y_H\t2\n#define V4L2_AV1_SEG_LVL_ALT_LF_U\t3\n#define V4L2_AV1_SEG_LVL_ALT_LF_V\t4\n\n#define SUPERRES_SCALE_BITS 3\n#define SCALE_NUMERATOR 8\n#define SUPERRES_SCALE_DENOMINATOR_MIN (SCALE_NUMERATOR + 1)\n\n#define RS_SUBPEL_BITS 6\n#define RS_SUBPEL_MASK ((1 << RS_SUBPEL_BITS) - 1)\n#define RS_SCALE_SUBPEL_BITS 14\n#define RS_SCALE_SUBPEL_MASK ((1 << RS_SCALE_SUBPEL_BITS) - 1)\n#define RS_SCALE_EXTRA_BITS (RS_SCALE_SUBPEL_BITS - RS_SUBPEL_BITS)\n#define RS_SCALE_EXTRA_OFF (1 << (RS_SCALE_EXTRA_BITS - 1))\n\n#define IS_INTRA(type) ((type == V4L2_AV1_KEY_FRAME) || (type == V4L2_AV1_INTRA_ONLY_FRAME))\n\n#define LST_BUF_IDX (V4L2_AV1_REF_LAST_FRAME - V4L2_AV1_REF_LAST_FRAME)\n#define LST2_BUF_IDX (V4L2_AV1_REF_LAST2_FRAME - V4L2_AV1_REF_LAST_FRAME)\n#define LST3_BUF_IDX (V4L2_AV1_REF_LAST3_FRAME - V4L2_AV1_REF_LAST_FRAME)\n#define GLD_BUF_IDX (V4L2_AV1_REF_GOLDEN_FRAME - V4L2_AV1_REF_LAST_FRAME)\n#define BWD_BUF_IDX (V4L2_AV1_REF_BWDREF_FRAME - V4L2_AV1_REF_LAST_FRAME)\n#define ALT2_BUF_IDX (V4L2_AV1_REF_ALTREF2_FRAME - V4L2_AV1_REF_LAST_FRAME)\n#define ALT_BUF_IDX (V4L2_AV1_REF_ALTREF_FRAME - V4L2_AV1_REF_LAST_FRAME)\n\n#define DIV_LUT_PREC_BITS 14\n#define DIV_LUT_BITS 8\n#define DIV_LUT_NUM BIT(DIV_LUT_BITS)\n#define WARP_PARAM_REDUCE_BITS 6\n#define WARPEDMODEL_PREC_BITS 16\n\n#define AV1_DIV_ROUND_UP_POW2(value, n)\t\t\t\\\n({\t\t\t\t\t\t\t\\\n\ttypeof(n) _n  = n;\t\t\t\t\\\n\ttypeof(value) _value = value;\t\t\t\\\n\t(_value + (BIT(_n) >> 1)) >> _n;\t\t\\\n})\n\n#define AV1_DIV_ROUND_UP_POW2_SIGNED(value, n)\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\ttypeof(n) _n_  = n;\t\t\t\t\t\t\\\n\ttypeof(value) _value_ = value;\t\t\t\t\t\\\n\t(((_value_) < 0) ? -AV1_DIV_ROUND_UP_POW2(-(_value_), (_n_))\t\\\n\t\t: AV1_DIV_ROUND_UP_POW2((_value_), (_n_)));\t\t\\\n})\n\nstruct rockchip_av1_film_grain {\n\tu8 scaling_lut_y[256];\n\tu8 scaling_lut_cb[256];\n\tu8 scaling_lut_cr[256];\n\ts16 cropped_luma_grain_block[4096];\n\ts16 cropped_chroma_grain_block[1024 * 2];\n};\n\nstatic const short div_lut[DIV_LUT_NUM + 1] = {\n\t16384, 16320, 16257, 16194, 16132, 16070, 16009, 15948, 15888, 15828, 15768,\n\t15709, 15650, 15592, 15534, 15477, 15420, 15364, 15308, 15252, 15197, 15142,\n\t15087, 15033, 14980, 14926, 14873, 14821, 14769, 14717, 14665, 14614, 14564,\n\t14513, 14463, 14413, 14364, 14315, 14266, 14218, 14170, 14122, 14075, 14028,\n\t13981, 13935, 13888, 13843, 13797, 13752, 13707, 13662, 13618, 13574, 13530,\n\t13487, 13443, 13400, 13358, 13315, 13273, 13231, 13190, 13148, 13107, 13066,\n\t13026, 12985, 12945, 12906, 12866, 12827, 12788, 12749, 12710, 12672, 12633,\n\t12596, 12558, 12520, 12483, 12446, 12409, 12373, 12336, 12300, 12264, 12228,\n\t12193, 12157, 12122, 12087, 12053, 12018, 11984, 11950, 11916, 11882, 11848,\n\t11815, 11782, 11749, 11716, 11683, 11651, 11619, 11586, 11555, 11523, 11491,\n\t11460, 11429, 11398, 11367, 11336, 11305, 11275, 11245, 11215, 11185, 11155,\n\t11125, 11096, 11067, 11038, 11009, 10980, 10951, 10923, 10894, 10866, 10838,\n\t10810, 10782, 10755, 10727, 10700, 10673, 10645, 10618, 10592, 10565, 10538,\n\t10512, 10486, 10460, 10434, 10408, 10382, 10356, 10331, 10305, 10280, 10255,\n\t10230, 10205, 10180, 10156, 10131, 10107, 10082, 10058, 10034, 10010, 9986,\n\t9963,  9939,  9916,  9892,  9869,  9846,  9823,  9800,  9777,  9754,  9732,\n\t9709,  9687,  9664,  9642,  9620,  9598,  9576,  9554,  9533,  9511,  9489,\n\t9468,  9447,  9425,  9404,  9383,  9362,  9341,  9321,  9300,  9279,  9259,\n\t9239,  9218,  9198,  9178,  9158,  9138,  9118,  9098,  9079,  9059,  9039,\n\t9020,  9001,  8981,  8962,  8943,  8924,  8905,  8886,  8867,  8849,  8830,\n\t8812,  8793,  8775,  8756,  8738,  8720,  8702,  8684,  8666,  8648,  8630,\n\t8613,  8595,  8577,  8560,  8542,  8525,  8508,  8490,  8473,  8456,  8439,\n\t8422,  8405,  8389,  8372,  8355,  8339,  8322,  8306,  8289,  8273,  8257,\n\t8240,  8224,  8208,  8192,\n};\n\nstatic int rockchip_vpu981_get_frame_index(struct hantro_ctx *ctx, int ref)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tu64 timestamp;\n\tint i, idx = frame->ref_frame_idx[ref];\n\n\tif (idx >= V4L2_AV1_TOTAL_REFS_PER_FRAME || idx < 0)\n\t\treturn AV1_INVALID_IDX;\n\n\ttimestamp = frame->reference_frame_ts[idx];\n\tfor (i = 0; i < AV1_MAX_FRAME_BUF_COUNT; i++) {\n\t\tif (!av1_dec->frame_refs[i].used)\n\t\t\tcontinue;\n\t\tif (av1_dec->frame_refs[i].timestamp == timestamp)\n\t\t\treturn i;\n\t}\n\n\treturn AV1_INVALID_IDX;\n}\n\nstatic int rockchip_vpu981_get_order_hint(struct hantro_ctx *ctx, int ref)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tint idx = rockchip_vpu981_get_frame_index(ctx, ref);\n\n\tif (idx != AV1_INVALID_IDX)\n\t\treturn av1_dec->frame_refs[idx].order_hint;\n\n\treturn 0;\n}\n\nstatic int rockchip_vpu981_av1_dec_frame_ref(struct hantro_ctx *ctx,\n\t\t\t\t\t     u64 timestamp)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tint i;\n\n\tfor (i = 0; i < AV1_MAX_FRAME_BUF_COUNT; i++) {\n\t\tint j;\n\n\t\tif (av1_dec->frame_refs[i].used)\n\t\t\tcontinue;\n\n\t\tav1_dec->frame_refs[i].width = frame->frame_width_minus_1 + 1;\n\t\tav1_dec->frame_refs[i].height = frame->frame_height_minus_1 + 1;\n\t\tav1_dec->frame_refs[i].mi_cols = DIV_ROUND_UP(frame->frame_width_minus_1 + 1, 8);\n\t\tav1_dec->frame_refs[i].mi_rows = DIV_ROUND_UP(frame->frame_height_minus_1 + 1, 8);\n\t\tav1_dec->frame_refs[i].timestamp = timestamp;\n\t\tav1_dec->frame_refs[i].frame_type = frame->frame_type;\n\t\tav1_dec->frame_refs[i].order_hint = frame->order_hint;\n\t\tif (!av1_dec->frame_refs[i].vb2_ref)\n\t\t\tav1_dec->frame_refs[i].vb2_ref = hantro_get_dst_buf(ctx);\n\n\t\tfor (j = 0; j < V4L2_AV1_TOTAL_REFS_PER_FRAME; j++)\n\t\t\tav1_dec->frame_refs[i].order_hints[j] = frame->order_hints[j];\n\t\tav1_dec->frame_refs[i].used = true;\n\t\tav1_dec->current_frame_index = i;\n\n\t\treturn i;\n\t}\n\n\treturn AV1_INVALID_IDX;\n}\n\nstatic void rockchip_vpu981_av1_dec_frame_unref(struct hantro_ctx *ctx, int idx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\n\tif (idx >= 0)\n\t\tav1_dec->frame_refs[idx].used = false;\n}\n\nstatic void rockchip_vpu981_av1_dec_clean_refs(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\n\tint ref, idx;\n\n\tfor (idx = 0; idx < AV1_MAX_FRAME_BUF_COUNT; idx++) {\n\t\tu64 timestamp = av1_dec->frame_refs[idx].timestamp;\n\t\tbool used = false;\n\n\t\tif (!av1_dec->frame_refs[idx].used)\n\t\t\tcontinue;\n\n\t\tfor (ref = 0; ref < V4L2_AV1_TOTAL_REFS_PER_FRAME; ref++) {\n\t\t\tif (ctrls->frame->reference_frame_ts[ref] == timestamp)\n\t\t\t\tused = true;\n\t\t}\n\n\t\tif (!used)\n\t\t\trockchip_vpu981_av1_dec_frame_unref(ctx, idx);\n\t}\n}\n\nstatic size_t rockchip_vpu981_av1_dec_luma_size(struct hantro_ctx *ctx)\n{\n\treturn ctx->dst_fmt.width * ctx->dst_fmt.height * ctx->bit_depth / 8;\n}\n\nstatic size_t rockchip_vpu981_av1_dec_chroma_size(struct hantro_ctx *ctx)\n{\n\tsize_t cr_offset = rockchip_vpu981_av1_dec_luma_size(ctx);\n\n\treturn ALIGN((cr_offset * 3) / 2, 64);\n}\n\nstatic void rockchip_vpu981_av1_dec_tiles_free(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\n\tif (av1_dec->db_data_col.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->db_data_col.size,\n\t\t\t\t  av1_dec->db_data_col.cpu,\n\t\t\t\t  av1_dec->db_data_col.dma);\n\tav1_dec->db_data_col.cpu = NULL;\n\n\tif (av1_dec->db_ctrl_col.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->db_ctrl_col.size,\n\t\t\t\t  av1_dec->db_ctrl_col.cpu,\n\t\t\t\t  av1_dec->db_ctrl_col.dma);\n\tav1_dec->db_ctrl_col.cpu = NULL;\n\n\tif (av1_dec->cdef_col.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->cdef_col.size,\n\t\t\t\t  av1_dec->cdef_col.cpu, av1_dec->cdef_col.dma);\n\tav1_dec->cdef_col.cpu = NULL;\n\n\tif (av1_dec->sr_col.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->sr_col.size,\n\t\t\t\t  av1_dec->sr_col.cpu, av1_dec->sr_col.dma);\n\tav1_dec->sr_col.cpu = NULL;\n\n\tif (av1_dec->lr_col.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->lr_col.size,\n\t\t\t\t  av1_dec->lr_col.cpu, av1_dec->lr_col.dma);\n\tav1_dec->lr_col.cpu = NULL;\n}\n\nstatic int rockchip_vpu981_av1_dec_tiles_reallocate(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tunsigned int num_tile_cols = 1 << ctrls->tile_group_entry->tile_col;\n\tunsigned int height = ALIGN(ctrls->frame->frame_height_minus_1 + 1, 64);\n\tunsigned int height_in_sb = height / 64;\n\tunsigned int stripe_num = ((height + 8) + 63) / 64;\n\tsize_t size;\n\n\tif (av1_dec->db_data_col.size >=\n\t    ALIGN(height * 12 * ctx->bit_depth / 8, 128) * num_tile_cols)\n\t\treturn 0;\n\n\trockchip_vpu981_av1_dec_tiles_free(ctx);\n\n\tsize = ALIGN(height * 12 * ctx->bit_depth / 8, 128) * num_tile_cols;\n\tav1_dec->db_data_col.cpu = dma_alloc_coherent(vpu->dev, size,\n\t\t\t\t\t\t      &av1_dec->db_data_col.dma,\n\t\t\t\t\t\t      GFP_KERNEL);\n\tif (!av1_dec->db_data_col.cpu)\n\t\tgoto buffer_allocation_error;\n\tav1_dec->db_data_col.size = size;\n\n\tsize = ALIGN(height * 2 * 16 / 4, 128) * num_tile_cols;\n\tav1_dec->db_ctrl_col.cpu = dma_alloc_coherent(vpu->dev, size,\n\t\t\t\t\t\t      &av1_dec->db_ctrl_col.dma,\n\t\t\t\t\t\t      GFP_KERNEL);\n\tif (!av1_dec->db_ctrl_col.cpu)\n\t\tgoto buffer_allocation_error;\n\tav1_dec->db_ctrl_col.size = size;\n\n\tsize = ALIGN(height_in_sb * 44 * ctx->bit_depth * 16 / 8, 128) * num_tile_cols;\n\tav1_dec->cdef_col.cpu = dma_alloc_coherent(vpu->dev, size,\n\t\t\t\t\t\t   &av1_dec->cdef_col.dma,\n\t\t\t\t\t\t   GFP_KERNEL);\n\tif (!av1_dec->cdef_col.cpu)\n\t\tgoto buffer_allocation_error;\n\tav1_dec->cdef_col.size = size;\n\n\tsize = ALIGN(height_in_sb * (3040 + 1280), 128) * num_tile_cols;\n\tav1_dec->sr_col.cpu = dma_alloc_coherent(vpu->dev, size,\n\t\t\t\t\t\t &av1_dec->sr_col.dma,\n\t\t\t\t\t\t GFP_KERNEL);\n\tif (!av1_dec->sr_col.cpu)\n\t\tgoto buffer_allocation_error;\n\tav1_dec->sr_col.size = size;\n\n\tsize = ALIGN(stripe_num * 1536 * ctx->bit_depth / 8, 128) * num_tile_cols;\n\tav1_dec->lr_col.cpu = dma_alloc_coherent(vpu->dev, size,\n\t\t\t\t\t\t &av1_dec->lr_col.dma,\n\t\t\t\t\t\t GFP_KERNEL);\n\tif (!av1_dec->lr_col.cpu)\n\t\tgoto buffer_allocation_error;\n\tav1_dec->lr_col.size = size;\n\n\tav1_dec->num_tile_cols_allocated = num_tile_cols;\n\treturn 0;\n\nbuffer_allocation_error:\n\trockchip_vpu981_av1_dec_tiles_free(ctx);\n\treturn -ENOMEM;\n}\n\nvoid rockchip_vpu981_av1_dec_exit(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\n\tif (av1_dec->global_model.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->global_model.size,\n\t\t\t\t  av1_dec->global_model.cpu,\n\t\t\t\t  av1_dec->global_model.dma);\n\tav1_dec->global_model.cpu = NULL;\n\n\tif (av1_dec->tile_info.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->tile_info.size,\n\t\t\t\t  av1_dec->tile_info.cpu,\n\t\t\t\t  av1_dec->tile_info.dma);\n\tav1_dec->tile_info.cpu = NULL;\n\n\tif (av1_dec->film_grain.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->film_grain.size,\n\t\t\t\t  av1_dec->film_grain.cpu,\n\t\t\t\t  av1_dec->film_grain.dma);\n\tav1_dec->film_grain.cpu = NULL;\n\n\tif (av1_dec->prob_tbl.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->prob_tbl.size,\n\t\t\t\t  av1_dec->prob_tbl.cpu, av1_dec->prob_tbl.dma);\n\tav1_dec->prob_tbl.cpu = NULL;\n\n\tif (av1_dec->prob_tbl_out.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->prob_tbl_out.size,\n\t\t\t\t  av1_dec->prob_tbl_out.cpu,\n\t\t\t\t  av1_dec->prob_tbl_out.dma);\n\tav1_dec->prob_tbl_out.cpu = NULL;\n\n\tif (av1_dec->tile_buf.cpu)\n\t\tdma_free_coherent(vpu->dev, av1_dec->tile_buf.size,\n\t\t\t\t  av1_dec->tile_buf.cpu, av1_dec->tile_buf.dma);\n\tav1_dec->tile_buf.cpu = NULL;\n\n\trockchip_vpu981_av1_dec_tiles_free(ctx);\n}\n\nint rockchip_vpu981_av1_dec_init(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\n\tmemset(av1_dec, 0, sizeof(*av1_dec));\n\n\tav1_dec->global_model.cpu = dma_alloc_coherent(vpu->dev, GLOBAL_MODEL_SIZE,\n\t\t\t\t\t\t       &av1_dec->global_model.dma,\n\t\t\t\t\t\t       GFP_KERNEL);\n\tif (!av1_dec->global_model.cpu)\n\t\treturn -ENOMEM;\n\tav1_dec->global_model.size = GLOBAL_MODEL_SIZE;\n\n\tav1_dec->tile_info.cpu = dma_alloc_coherent(vpu->dev, AV1_MAX_TILES,\n\t\t\t\t\t\t    &av1_dec->tile_info.dma,\n\t\t\t\t\t\t    GFP_KERNEL);\n\tif (!av1_dec->tile_info.cpu)\n\t\treturn -ENOMEM;\n\tav1_dec->tile_info.size = AV1_MAX_TILES;\n\n\tav1_dec->film_grain.cpu = dma_alloc_coherent(vpu->dev,\n\t\t\t\t\t\t     ALIGN(sizeof(struct rockchip_av1_film_grain), 2048),\n\t\t\t\t\t\t     &av1_dec->film_grain.dma,\n\t\t\t\t\t\t     GFP_KERNEL);\n\tif (!av1_dec->film_grain.cpu)\n\t\treturn -ENOMEM;\n\tav1_dec->film_grain.size = ALIGN(sizeof(struct rockchip_av1_film_grain), 2048);\n\n\tav1_dec->prob_tbl.cpu = dma_alloc_coherent(vpu->dev,\n\t\t\t\t\t\t   ALIGN(sizeof(struct av1cdfs), 2048),\n\t\t\t\t\t\t   &av1_dec->prob_tbl.dma,\n\t\t\t\t\t\t   GFP_KERNEL);\n\tif (!av1_dec->prob_tbl.cpu)\n\t\treturn -ENOMEM;\n\tav1_dec->prob_tbl.size = ALIGN(sizeof(struct av1cdfs), 2048);\n\n\tav1_dec->prob_tbl_out.cpu = dma_alloc_coherent(vpu->dev,\n\t\t\t\t\t\t       ALIGN(sizeof(struct av1cdfs), 2048),\n\t\t\t\t\t\t       &av1_dec->prob_tbl_out.dma,\n\t\t\t\t\t\t       GFP_KERNEL);\n\tif (!av1_dec->prob_tbl_out.cpu)\n\t\treturn -ENOMEM;\n\tav1_dec->prob_tbl_out.size = ALIGN(sizeof(struct av1cdfs), 2048);\n\tav1_dec->cdfs = &av1_dec->default_cdfs;\n\tav1_dec->cdfs_ndvc = &av1_dec->default_cdfs_ndvc;\n\n\trockchip_av1_set_default_cdfs(av1_dec->cdfs, av1_dec->cdfs_ndvc);\n\n\tav1_dec->tile_buf.cpu = dma_alloc_coherent(vpu->dev,\n\t\t\t\t\t\t   AV1_TILE_SIZE,\n\t\t\t\t\t\t   &av1_dec->tile_buf.dma,\n\t\t\t\t\t\t   GFP_KERNEL);\n\tif (!av1_dec->tile_buf.cpu)\n\t\treturn -ENOMEM;\n\tav1_dec->tile_buf.size = AV1_TILE_SIZE;\n\n\treturn 0;\n}\n\nstatic int rockchip_vpu981_av1_dec_prepare_run(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\n\tctrls->sequence = hantro_get_ctrl(ctx, V4L2_CID_STATELESS_AV1_SEQUENCE);\n\tif (WARN_ON(!ctrls->sequence))\n\t\treturn -EINVAL;\n\n\tctrls->tile_group_entry =\n\t    hantro_get_ctrl(ctx, V4L2_CID_STATELESS_AV1_TILE_GROUP_ENTRY);\n\tif (WARN_ON(!ctrls->tile_group_entry))\n\t\treturn -EINVAL;\n\n\tctrls->frame = hantro_get_ctrl(ctx, V4L2_CID_STATELESS_AV1_FRAME);\n\tif (WARN_ON(!ctrls->frame))\n\t\treturn -EINVAL;\n\n\tctrls->film_grain =\n\t    hantro_get_ctrl(ctx, V4L2_CID_STATELESS_AV1_FILM_GRAIN);\n\n\treturn rockchip_vpu981_av1_dec_tiles_reallocate(ctx);\n}\n\nstatic inline int rockchip_vpu981_av1_dec_get_msb(u32 n)\n{\n\tif (n == 0)\n\t\treturn 0;\n\treturn 31 ^ __builtin_clz(n);\n}\n\nstatic short rockchip_vpu981_av1_dec_resolve_divisor_32(u32 d, short *shift)\n{\n\tint f;\n\tu64 e;\n\n\t*shift = rockchip_vpu981_av1_dec_get_msb(d);\n\t \n\te = d - ((u32)1 << *shift);\n\t \n\tif (*shift > DIV_LUT_BITS)\n\t\tf = AV1_DIV_ROUND_UP_POW2(e, *shift - DIV_LUT_BITS);\n\telse\n\t\tf = e << (DIV_LUT_BITS - *shift);\n\tif (f > DIV_LUT_NUM)\n\t\treturn -1;\n\t*shift += DIV_LUT_PREC_BITS;\n\t \n\treturn div_lut[f];\n}\n\nstatic void\nrockchip_vpu981_av1_dec_get_shear_params(const u32 *params, s64 *alpha,\n\t\t\t\t\t s64 *beta, s64 *gamma, s64 *delta)\n{\n\tconst int *mat = params;\n\tshort shift;\n\tshort y;\n\tlong long gv, dv;\n\n\tif (mat[2] <= 0)\n\t\treturn;\n\n\t*alpha = clamp_val(mat[2] - (1 << WARPEDMODEL_PREC_BITS), S16_MIN, S16_MAX);\n\t*beta = clamp_val(mat[3], S16_MIN, S16_MAX);\n\n\ty = rockchip_vpu981_av1_dec_resolve_divisor_32(abs(mat[2]), &shift) * (mat[2] < 0 ? -1 : 1);\n\n\tgv = ((long long)mat[4] * (1 << WARPEDMODEL_PREC_BITS)) * y;\n\n\t*gamma = clamp_val((int)AV1_DIV_ROUND_UP_POW2_SIGNED(gv, shift), S16_MIN, S16_MAX);\n\n\tdv = ((long long)mat[3] * mat[4]) * y;\n\t*delta = clamp_val(mat[5] -\n\t\t(int)AV1_DIV_ROUND_UP_POW2_SIGNED(dv, shift) - (1 << WARPEDMODEL_PREC_BITS),\n\t\tS16_MIN, S16_MAX);\n\n\t*alpha = AV1_DIV_ROUND_UP_POW2_SIGNED(*alpha, WARP_PARAM_REDUCE_BITS)\n\t\t * (1 << WARP_PARAM_REDUCE_BITS);\n\t*beta = AV1_DIV_ROUND_UP_POW2_SIGNED(*beta, WARP_PARAM_REDUCE_BITS)\n\t\t* (1 << WARP_PARAM_REDUCE_BITS);\n\t*gamma = AV1_DIV_ROUND_UP_POW2_SIGNED(*gamma, WARP_PARAM_REDUCE_BITS)\n\t\t * (1 << WARP_PARAM_REDUCE_BITS);\n\t*delta = AV1_DIV_ROUND_UP_POW2_SIGNED(*delta, WARP_PARAM_REDUCE_BITS)\n\t\t* (1 << WARP_PARAM_REDUCE_BITS);\n}\n\nstatic void rockchip_vpu981_av1_dec_set_global_model(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tconst struct v4l2_av1_global_motion *gm = &frame->global_motion;\n\tu8 *dst = av1_dec->global_model.cpu;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tint ref_frame, i;\n\n\tmemset(dst, 0, GLOBAL_MODEL_SIZE);\n\tfor (ref_frame = 0; ref_frame < V4L2_AV1_REFS_PER_FRAME; ++ref_frame) {\n\t\ts64 alpha = 0, beta = 0, gamma = 0, delta = 0;\n\n\t\tfor (i = 0; i < 6; ++i) {\n\t\t\tif (i == 2)\n\t\t\t\t*(s32 *)dst =\n\t\t\t\t\tgm->params[V4L2_AV1_REF_LAST_FRAME + ref_frame][3];\n\t\t\telse if (i == 3)\n\t\t\t\t*(s32 *)dst =\n\t\t\t\t\tgm->params[V4L2_AV1_REF_LAST_FRAME + ref_frame][2];\n\t\t\telse\n\t\t\t\t*(s32 *)dst =\n\t\t\t\t\tgm->params[V4L2_AV1_REF_LAST_FRAME + ref_frame][i];\n\t\t\tdst += 4;\n\t\t}\n\n\t\tif (gm->type[V4L2_AV1_REF_LAST_FRAME + ref_frame] <= V4L2_AV1_WARP_MODEL_AFFINE)\n\t\t\trockchip_vpu981_av1_dec_get_shear_params(&gm->params[V4L2_AV1_REF_LAST_FRAME + ref_frame][0],\n\t\t\t\t\t\t\t\t &alpha, &beta, &gamma, &delta);\n\n\t\t*(s16 *)dst = alpha;\n\t\tdst += 2;\n\t\t*(s16 *)dst = beta;\n\t\tdst += 2;\n\t\t*(s16 *)dst = gamma;\n\t\tdst += 2;\n\t\t*(s16 *)dst = delta;\n\t\tdst += 2;\n\t}\n\n\thantro_write_addr(vpu, AV1_GLOBAL_MODEL, av1_dec->global_model.dma);\n}\n\nstatic int rockchip_vpu981_av1_tile_log2(int target)\n{\n\tint k;\n\n\t \n\tfor (k = 0; (1 << k) < target; k++);\n\n\treturn k;\n}\n\nstatic void rockchip_vpu981_av1_dec_set_tile_info(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_av1_tile_info *tile_info = &ctrls->frame->tile_info;\n\tconst struct v4l2_ctrl_av1_tile_group_entry *group_entry =\n\t    ctrls->tile_group_entry;\n\tint context_update_y =\n\t    tile_info->context_update_tile_id / tile_info->tile_cols;\n\tint context_update_x =\n\t    tile_info->context_update_tile_id % tile_info->tile_cols;\n\tint context_update_tile_id =\n\t    context_update_x * tile_info->tile_rows + context_update_y;\n\tu8 *dst = av1_dec->tile_info.cpu;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tint tile0, tile1;\n\n\tmemset(dst, 0, av1_dec->tile_info.size);\n\n\tfor (tile0 = 0; tile0 < tile_info->tile_cols; tile0++) {\n\t\tfor (tile1 = 0; tile1 < tile_info->tile_rows; tile1++) {\n\t\t\tint tile_id = tile1 * tile_info->tile_cols + tile0;\n\t\t\tu32 start, end;\n\t\t\tu32 y0 =\n\t\t\t    tile_info->height_in_sbs_minus_1[tile1] + 1;\n\t\t\tu32 x0 = tile_info->width_in_sbs_minus_1[tile0] + 1;\n\n\t\t\t \n\t\t\t*dst++ = x0;\n\t\t\t*dst++ = 0;\n\t\t\t*dst++ = 0;\n\t\t\t*dst++ = 0;\n\t\t\t*dst++ = y0;\n\t\t\t*dst++ = 0;\n\t\t\t*dst++ = 0;\n\t\t\t*dst++ = 0;\n\n\t\t\t \n\t\t\tstart = group_entry[tile_id].tile_offset - group_entry[0].tile_offset;\n\t\t\t*dst++ = start & 255;\n\t\t\t*dst++ = (start >> 8) & 255;\n\t\t\t*dst++ = (start >> 16) & 255;\n\t\t\t*dst++ = (start >> 24) & 255;\n\n\t\t\t \n\t\t\tend = start + group_entry[tile_id].tile_size;\n\t\t\t*dst++ = end & 255;\n\t\t\t*dst++ = (end >> 8) & 255;\n\t\t\t*dst++ = (end >> 16) & 255;\n\t\t\t*dst++ = (end >> 24) & 255;\n\t\t}\n\t}\n\n\thantro_reg_write(vpu, &av1_multicore_expect_context_update, !!(context_update_x == 0));\n\thantro_reg_write(vpu, &av1_tile_enable,\n\t\t\t !!((tile_info->tile_cols > 1) || (tile_info->tile_rows > 1)));\n\thantro_reg_write(vpu, &av1_num_tile_cols_8k, tile_info->tile_cols);\n\thantro_reg_write(vpu, &av1_num_tile_rows_8k, tile_info->tile_rows);\n\thantro_reg_write(vpu, &av1_context_update_tile_id, context_update_tile_id);\n\thantro_reg_write(vpu, &av1_tile_transpose, 1);\n\tif (rockchip_vpu981_av1_tile_log2(tile_info->tile_cols) ||\n\t    rockchip_vpu981_av1_tile_log2(tile_info->tile_rows))\n\t\thantro_reg_write(vpu, &av1_dec_tile_size_mag, tile_info->tile_size_bytes - 1);\n\telse\n\t\thantro_reg_write(vpu, &av1_dec_tile_size_mag, 3);\n\n\thantro_write_addr(vpu, AV1_TILE_BASE, av1_dec->tile_info.dma);\n}\n\nstatic int rockchip_vpu981_av1_dec_get_dist(struct hantro_ctx *ctx,\n\t\t\t\t\t    int a, int b)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tint bits = ctrls->sequence->order_hint_bits - 1;\n\tint diff, m;\n\n\tif (!ctrls->sequence->order_hint_bits)\n\t\treturn 0;\n\n\tdiff = a - b;\n\tm = 1 << bits;\n\tdiff = (diff & (m - 1)) - (diff & m);\n\n\treturn diff;\n}\n\nstatic void rockchip_vpu981_av1_dec_set_frame_sign_bias(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tconst struct v4l2_ctrl_av1_sequence *sequence = ctrls->sequence;\n\tint i;\n\n\tif (!sequence->order_hint_bits || IS_INTRA(frame->frame_type)) {\n\t\tfor (i = 0; i < V4L2_AV1_TOTAL_REFS_PER_FRAME; i++)\n\t\t\tav1_dec->ref_frame_sign_bias[i] = 0;\n\n\t\treturn;\n\t}\n\t\n\tfor (i = 0; i < V4L2_AV1_TOTAL_REFS_PER_FRAME - 1; i++) {\n\t\tif (rockchip_vpu981_get_frame_index(ctx, i) >= 0) {\n\t\t\tint rel_off =\n\t\t\t    rockchip_vpu981_av1_dec_get_dist(ctx,\n\t\t\t\t\t\t\t     rockchip_vpu981_get_order_hint(ctx, i),\n\t\t\t\t\t\t\t     frame->order_hint);\n\t\t\tav1_dec->ref_frame_sign_bias[i + 1] = (rel_off <= 0) ? 0 : 1;\n\t\t}\n\t}\n}\n\nstatic bool\nrockchip_vpu981_av1_dec_set_ref(struct hantro_ctx *ctx, int ref, int idx,\n\t\t\t\tint width, int height)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_decoded_buffer *dst;\n\tdma_addr_t luma_addr, chroma_addr, mv_addr = 0;\n\tsize_t cr_offset = rockchip_vpu981_av1_dec_luma_size(ctx);\n\tsize_t mv_offset = rockchip_vpu981_av1_dec_chroma_size(ctx);\n\tint cur_width = frame->frame_width_minus_1 + 1;\n\tint cur_height = frame->frame_height_minus_1 + 1;\n\tint scale_width =\n\t    ((width << AV1_REF_SCALE_SHIFT) + cur_width / 2) / cur_width;\n\tint scale_height =\n\t    ((height << AV1_REF_SCALE_SHIFT) + cur_height / 2) / cur_height;\n\n\tswitch (ref) {\n\tcase 0:\n\t\thantro_reg_write(vpu, &av1_ref0_height, height);\n\t\thantro_reg_write(vpu, &av1_ref0_width, width);\n\t\thantro_reg_write(vpu, &av1_ref0_ver_scale, scale_width);\n\t\thantro_reg_write(vpu, &av1_ref0_hor_scale, scale_height);\n\t\tbreak;\n\tcase 1:\n\t\thantro_reg_write(vpu, &av1_ref1_height, height);\n\t\thantro_reg_write(vpu, &av1_ref1_width, width);\n\t\thantro_reg_write(vpu, &av1_ref1_ver_scale, scale_width);\n\t\thantro_reg_write(vpu, &av1_ref1_hor_scale, scale_height);\n\t\tbreak;\n\tcase 2:\n\t\thantro_reg_write(vpu, &av1_ref2_height, height);\n\t\thantro_reg_write(vpu, &av1_ref2_width, width);\n\t\thantro_reg_write(vpu, &av1_ref2_ver_scale, scale_width);\n\t\thantro_reg_write(vpu, &av1_ref2_hor_scale, scale_height);\n\t\tbreak;\n\tcase 3:\n\t\thantro_reg_write(vpu, &av1_ref3_height, height);\n\t\thantro_reg_write(vpu, &av1_ref3_width, width);\n\t\thantro_reg_write(vpu, &av1_ref3_ver_scale, scale_width);\n\t\thantro_reg_write(vpu, &av1_ref3_hor_scale, scale_height);\n\t\tbreak;\n\tcase 4:\n\t\thantro_reg_write(vpu, &av1_ref4_height, height);\n\t\thantro_reg_write(vpu, &av1_ref4_width, width);\n\t\thantro_reg_write(vpu, &av1_ref4_ver_scale, scale_width);\n\t\thantro_reg_write(vpu, &av1_ref4_hor_scale, scale_height);\n\t\tbreak;\n\tcase 5:\n\t\thantro_reg_write(vpu, &av1_ref5_height, height);\n\t\thantro_reg_write(vpu, &av1_ref5_width, width);\n\t\thantro_reg_write(vpu, &av1_ref5_ver_scale, scale_width);\n\t\thantro_reg_write(vpu, &av1_ref5_hor_scale, scale_height);\n\t\tbreak;\n\tcase 6:\n\t\thantro_reg_write(vpu, &av1_ref6_height, height);\n\t\thantro_reg_write(vpu, &av1_ref6_width, width);\n\t\thantro_reg_write(vpu, &av1_ref6_ver_scale, scale_width);\n\t\thantro_reg_write(vpu, &av1_ref6_hor_scale, scale_height);\n\t\tbreak;\n\tdefault:\n\t\tpr_warn(\"AV1 invalid reference frame index\\n\");\n\t}\n\n\tdst = vb2_to_hantro_decoded_buf(&av1_dec->frame_refs[idx].vb2_ref->vb2_buf);\n\tluma_addr = hantro_get_dec_buf_addr(ctx, &dst->base.vb.vb2_buf);\n\tchroma_addr = luma_addr + cr_offset;\n\tmv_addr = luma_addr + mv_offset;\n\n\thantro_write_addr(vpu, AV1_REFERENCE_Y(ref), luma_addr);\n\thantro_write_addr(vpu, AV1_REFERENCE_CB(ref), chroma_addr);\n\thantro_write_addr(vpu, AV1_REFERENCE_MV(ref), mv_addr);\n\n\treturn (scale_width != (1 << AV1_REF_SCALE_SHIFT)) ||\n\t\t(scale_height != (1 << AV1_REF_SCALE_SHIFT));\n}\n\nstatic void rockchip_vpu981_av1_dec_set_sign_bias(struct hantro_ctx *ctx,\n\t\t\t\t\t\t  int ref, int val)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\n\tswitch (ref) {\n\tcase 0:\n\t\thantro_reg_write(vpu, &av1_ref0_sign_bias, val);\n\t\tbreak;\n\tcase 1:\n\t\thantro_reg_write(vpu, &av1_ref1_sign_bias, val);\n\t\tbreak;\n\tcase 2:\n\t\thantro_reg_write(vpu, &av1_ref2_sign_bias, val);\n\t\tbreak;\n\tcase 3:\n\t\thantro_reg_write(vpu, &av1_ref3_sign_bias, val);\n\t\tbreak;\n\tcase 4:\n\t\thantro_reg_write(vpu, &av1_ref4_sign_bias, val);\n\t\tbreak;\n\tcase 5:\n\t\thantro_reg_write(vpu, &av1_ref5_sign_bias, val);\n\t\tbreak;\n\tcase 6:\n\t\thantro_reg_write(vpu, &av1_ref6_sign_bias, val);\n\t\tbreak;\n\tdefault:\n\t\tpr_warn(\"AV1 invalid sign bias index\\n\");\n\t\tbreak;\n\t}\n}\n\nstatic void rockchip_vpu981_av1_dec_set_segmentation(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tconst struct v4l2_av1_segmentation *seg = &frame->segmentation;\n\tu32 segval[V4L2_AV1_MAX_SEGMENTS][V4L2_AV1_SEG_LVL_MAX] = { 0 };\n\tstruct hantro_dev *vpu = ctx->dev;\n\tu8 segsign = 0, preskip_segid = 0, last_active_seg = 0, i, j;\n\n\tif (!!(seg->flags & V4L2_AV1_SEGMENTATION_FLAG_ENABLED) &&\n\t    frame->primary_ref_frame < V4L2_AV1_REFS_PER_FRAME) {\n\t\tint idx = rockchip_vpu981_get_frame_index(ctx, frame->primary_ref_frame);\n\n\t\tif (idx >= 0) {\n\t\t\tdma_addr_t luma_addr, mv_addr = 0;\n\t\t\tstruct hantro_decoded_buffer *seg;\n\t\t\tsize_t mv_offset = rockchip_vpu981_av1_dec_chroma_size(ctx);\n\n\t\t\tseg = vb2_to_hantro_decoded_buf(&av1_dec->frame_refs[idx].vb2_ref->vb2_buf);\n\t\t\tluma_addr = hantro_get_dec_buf_addr(ctx, &seg->base.vb.vb2_buf);\n\t\t\tmv_addr = luma_addr + mv_offset;\n\n\t\t\thantro_write_addr(vpu, AV1_SEGMENTATION, mv_addr);\n\t\t\thantro_reg_write(vpu, &av1_use_temporal3_mvs, 1);\n\t\t}\n\t}\n\n\thantro_reg_write(vpu, &av1_segment_temp_upd_e,\n\t\t\t !!(seg->flags & V4L2_AV1_SEGMENTATION_FLAG_TEMPORAL_UPDATE));\n\thantro_reg_write(vpu, &av1_segment_upd_e,\n\t\t\t !!(seg->flags & V4L2_AV1_SEGMENTATION_FLAG_UPDATE_MAP));\n\thantro_reg_write(vpu, &av1_segment_e,\n\t\t\t !!(seg->flags & V4L2_AV1_SEGMENTATION_FLAG_ENABLED));\n\n\thantro_reg_write(vpu, &av1_error_resilient,\n\t\t\t !!(frame->flags & V4L2_AV1_FRAME_FLAG_ERROR_RESILIENT_MODE));\n\n\tif (IS_INTRA(frame->frame_type) ||\n\t    !!(frame->flags & V4L2_AV1_FRAME_FLAG_ERROR_RESILIENT_MODE)) {\n\t\thantro_reg_write(vpu, &av1_use_temporal3_mvs, 0);\n\t}\n\n\tif (seg->flags & V4L2_AV1_SEGMENTATION_FLAG_ENABLED) {\n\t\tint s;\n\n\t\tfor (s = 0; s < V4L2_AV1_MAX_SEGMENTS; s++) {\n\t\t\tif (seg->feature_enabled[s] &\n\t\t\t    V4L2_AV1_SEGMENT_FEATURE_ENABLED(V4L2_AV1_SEG_LVL_ALT_Q)) {\n\t\t\t\tsegval[s][V4L2_AV1_SEG_LVL_ALT_Q] =\n\t\t\t\t    clamp(abs(seg->feature_data[s][V4L2_AV1_SEG_LVL_ALT_Q]),\n\t\t\t\t\t  0, 255);\n\t\t\t\tsegsign |=\n\t\t\t\t\t(seg->feature_data[s][V4L2_AV1_SEG_LVL_ALT_Q] < 0) << s;\n\t\t\t}\n\n\t\t\tif (seg->feature_enabled[s] &\n\t\t\t    V4L2_AV1_SEGMENT_FEATURE_ENABLED(V4L2_AV1_SEG_LVL_ALT_LF_Y_V))\n\t\t\t\tsegval[s][V4L2_AV1_SEG_LVL_ALT_LF_Y_V] =\n\t\t\t\t\tclamp(abs(seg->feature_data[s][V4L2_AV1_SEG_LVL_ALT_LF_Y_V]),\n\t\t\t\t\t      -63, 63);\n\n\t\t\tif (seg->feature_enabled[s] &\n\t\t\t    V4L2_AV1_SEGMENT_FEATURE_ENABLED(V4L2_AV1_SEG_LVL_ALT_LF_Y_H))\n\t\t\t\tsegval[s][V4L2_AV1_SEG_LVL_ALT_LF_Y_H] =\n\t\t\t\t    clamp(abs(seg->feature_data[s][V4L2_AV1_SEG_LVL_ALT_LF_Y_H]),\n\t\t\t\t\t  -63, 63);\n\n\t\t\tif (seg->feature_enabled[s] &\n\t\t\t    V4L2_AV1_SEGMENT_FEATURE_ENABLED(V4L2_AV1_SEG_LVL_ALT_LF_U))\n\t\t\t\tsegval[s][V4L2_AV1_SEG_LVL_ALT_LF_U] =\n\t\t\t\t    clamp(abs(seg->feature_data[s][V4L2_AV1_SEG_LVL_ALT_LF_U]),\n\t\t\t\t\t  -63, 63);\n\n\t\t\tif (seg->feature_enabled[s] &\n\t\t\t    V4L2_AV1_SEGMENT_FEATURE_ENABLED(V4L2_AV1_SEG_LVL_ALT_LF_V))\n\t\t\t\tsegval[s][V4L2_AV1_SEG_LVL_ALT_LF_V] =\n\t\t\t\t    clamp(abs(seg->feature_data[s][V4L2_AV1_SEG_LVL_ALT_LF_V]),\n\t\t\t\t\t  -63, 63);\n\n\t\t\tif (frame->frame_type && seg->feature_enabled[s] &\n\t\t\t    V4L2_AV1_SEGMENT_FEATURE_ENABLED(V4L2_AV1_SEG_LVL_REF_FRAME))\n\t\t\t\tsegval[s][V4L2_AV1_SEG_LVL_REF_FRAME]++;\n\n\t\t\tif (seg->feature_enabled[s] &\n\t\t\t    V4L2_AV1_SEGMENT_FEATURE_ENABLED(V4L2_AV1_SEG_LVL_REF_SKIP))\n\t\t\t\tsegval[s][V4L2_AV1_SEG_LVL_REF_SKIP] = 1;\n\n\t\t\tif (seg->feature_enabled[s] &\n\t\t\t    V4L2_AV1_SEGMENT_FEATURE_ENABLED(V4L2_AV1_SEG_LVL_REF_GLOBALMV))\n\t\t\t\tsegval[s][V4L2_AV1_SEG_LVL_REF_GLOBALMV] = 1;\n\t\t}\n\t}\n\n\tfor (i = 0; i < V4L2_AV1_MAX_SEGMENTS; i++) {\n\t\tfor (j = 0; j < V4L2_AV1_SEG_LVL_MAX; j++) {\n\t\t\tif (seg->feature_enabled[i]\n\t\t\t    & V4L2_AV1_SEGMENT_FEATURE_ENABLED(j)) {\n\t\t\t\tpreskip_segid |= (j >= V4L2_AV1_SEG_LVL_REF_FRAME);\n\t\t\t\tlast_active_seg = max(i, last_active_seg);\n\t\t\t}\n\t\t}\n\t}\n\n\thantro_reg_write(vpu, &av1_last_active_seg, last_active_seg);\n\thantro_reg_write(vpu, &av1_preskip_segid, preskip_segid);\n\n\thantro_reg_write(vpu, &av1_seg_quant_sign, segsign);\n\n\t \n\thantro_reg_write(vpu, &av1_quant_seg0,\n\t\t\t segval[0][V4L2_AV1_SEG_LVL_ALT_Q]);\n\thantro_reg_write(vpu, &av1_filt_level_delta0_seg0,\n\t\t\t segval[0][V4L2_AV1_SEG_LVL_ALT_LF_Y_V]);\n\thantro_reg_write(vpu, &av1_filt_level_delta1_seg0,\n\t\t\t segval[0][V4L2_AV1_SEG_LVL_ALT_LF_Y_H]);\n\thantro_reg_write(vpu, &av1_filt_level_delta2_seg0,\n\t\t\t segval[0][V4L2_AV1_SEG_LVL_ALT_LF_U]);\n\thantro_reg_write(vpu, &av1_filt_level_delta3_seg0,\n\t\t\t segval[0][V4L2_AV1_SEG_LVL_ALT_LF_V]);\n\thantro_reg_write(vpu, &av1_refpic_seg0,\n\t\t\t segval[0][V4L2_AV1_SEG_LVL_REF_FRAME]);\n\thantro_reg_write(vpu, &av1_skip_seg0,\n\t\t\t segval[0][V4L2_AV1_SEG_LVL_REF_SKIP]);\n\thantro_reg_write(vpu, &av1_global_mv_seg0,\n\t\t\t segval[0][V4L2_AV1_SEG_LVL_REF_GLOBALMV]);\n\n\thantro_reg_write(vpu, &av1_quant_seg1,\n\t\t\t segval[1][V4L2_AV1_SEG_LVL_ALT_Q]);\n\thantro_reg_write(vpu, &av1_filt_level_delta0_seg1,\n\t\t\t segval[1][V4L2_AV1_SEG_LVL_ALT_LF_Y_V]);\n\thantro_reg_write(vpu, &av1_filt_level_delta1_seg1,\n\t\t\t segval[1][V4L2_AV1_SEG_LVL_ALT_LF_Y_H]);\n\thantro_reg_write(vpu, &av1_filt_level_delta2_seg1,\n\t\t\t segval[1][V4L2_AV1_SEG_LVL_ALT_LF_U]);\n\thantro_reg_write(vpu, &av1_filt_level_delta3_seg1,\n\t\t\t segval[1][V4L2_AV1_SEG_LVL_ALT_LF_V]);\n\thantro_reg_write(vpu, &av1_refpic_seg1,\n\t\t\t segval[1][V4L2_AV1_SEG_LVL_REF_FRAME]);\n\thantro_reg_write(vpu, &av1_skip_seg1,\n\t\t\t segval[1][V4L2_AV1_SEG_LVL_REF_SKIP]);\n\thantro_reg_write(vpu, &av1_global_mv_seg1,\n\t\t\t segval[1][V4L2_AV1_SEG_LVL_REF_GLOBALMV]);\n\n\thantro_reg_write(vpu, &av1_quant_seg2,\n\t\t\t segval[2][V4L2_AV1_SEG_LVL_ALT_Q]);\n\thantro_reg_write(vpu, &av1_filt_level_delta0_seg2,\n\t\t\t segval[2][V4L2_AV1_SEG_LVL_ALT_LF_Y_V]);\n\thantro_reg_write(vpu, &av1_filt_level_delta1_seg2,\n\t\t\t segval[2][V4L2_AV1_SEG_LVL_ALT_LF_Y_H]);\n\thantro_reg_write(vpu, &av1_filt_level_delta2_seg2,\n\t\t\t segval[2][V4L2_AV1_SEG_LVL_ALT_LF_U]);\n\thantro_reg_write(vpu, &av1_filt_level_delta3_seg2,\n\t\t\t segval[2][V4L2_AV1_SEG_LVL_ALT_LF_V]);\n\thantro_reg_write(vpu, &av1_refpic_seg2,\n\t\t\t segval[2][V4L2_AV1_SEG_LVL_REF_FRAME]);\n\thantro_reg_write(vpu, &av1_skip_seg2,\n\t\t\t segval[2][V4L2_AV1_SEG_LVL_REF_SKIP]);\n\thantro_reg_write(vpu, &av1_global_mv_seg2,\n\t\t\t segval[2][V4L2_AV1_SEG_LVL_REF_GLOBALMV]);\n\n\thantro_reg_write(vpu, &av1_quant_seg3,\n\t\t\t segval[3][V4L2_AV1_SEG_LVL_ALT_Q]);\n\thantro_reg_write(vpu, &av1_filt_level_delta0_seg3,\n\t\t\t segval[3][V4L2_AV1_SEG_LVL_ALT_LF_Y_V]);\n\thantro_reg_write(vpu, &av1_filt_level_delta1_seg3,\n\t\t\t segval[3][V4L2_AV1_SEG_LVL_ALT_LF_Y_H]);\n\thantro_reg_write(vpu, &av1_filt_level_delta2_seg3,\n\t\t\t segval[3][V4L2_AV1_SEG_LVL_ALT_LF_U]);\n\thantro_reg_write(vpu, &av1_filt_level_delta3_seg3,\n\t\t\t segval[3][V4L2_AV1_SEG_LVL_ALT_LF_V]);\n\thantro_reg_write(vpu, &av1_refpic_seg3,\n\t\t\t segval[3][V4L2_AV1_SEG_LVL_REF_FRAME]);\n\thantro_reg_write(vpu, &av1_skip_seg3,\n\t\t\t segval[3][V4L2_AV1_SEG_LVL_REF_SKIP]);\n\thantro_reg_write(vpu, &av1_global_mv_seg3,\n\t\t\t segval[3][V4L2_AV1_SEG_LVL_REF_GLOBALMV]);\n\n\thantro_reg_write(vpu, &av1_quant_seg4,\n\t\t\t segval[4][V4L2_AV1_SEG_LVL_ALT_Q]);\n\thantro_reg_write(vpu, &av1_filt_level_delta0_seg4,\n\t\t\t segval[4][V4L2_AV1_SEG_LVL_ALT_LF_Y_V]);\n\thantro_reg_write(vpu, &av1_filt_level_delta1_seg4,\n\t\t\t segval[4][V4L2_AV1_SEG_LVL_ALT_LF_Y_H]);\n\thantro_reg_write(vpu, &av1_filt_level_delta2_seg4,\n\t\t\t segval[4][V4L2_AV1_SEG_LVL_ALT_LF_U]);\n\thantro_reg_write(vpu, &av1_filt_level_delta3_seg4,\n\t\t\t segval[4][V4L2_AV1_SEG_LVL_ALT_LF_V]);\n\thantro_reg_write(vpu, &av1_refpic_seg4,\n\t\t\t segval[4][V4L2_AV1_SEG_LVL_REF_FRAME]);\n\thantro_reg_write(vpu, &av1_skip_seg4,\n\t\t\t segval[4][V4L2_AV1_SEG_LVL_REF_SKIP]);\n\thantro_reg_write(vpu, &av1_global_mv_seg4,\n\t\t\t segval[4][V4L2_AV1_SEG_LVL_REF_GLOBALMV]);\n\n\thantro_reg_write(vpu, &av1_quant_seg5,\n\t\t\t segval[5][V4L2_AV1_SEG_LVL_ALT_Q]);\n\thantro_reg_write(vpu, &av1_filt_level_delta0_seg5,\n\t\t\t segval[5][V4L2_AV1_SEG_LVL_ALT_LF_Y_V]);\n\thantro_reg_write(vpu, &av1_filt_level_delta1_seg5,\n\t\t\t segval[5][V4L2_AV1_SEG_LVL_ALT_LF_Y_H]);\n\thantro_reg_write(vpu, &av1_filt_level_delta2_seg5,\n\t\t\t segval[5][V4L2_AV1_SEG_LVL_ALT_LF_U]);\n\thantro_reg_write(vpu, &av1_filt_level_delta3_seg5,\n\t\t\t segval[5][V4L2_AV1_SEG_LVL_ALT_LF_V]);\n\thantro_reg_write(vpu, &av1_refpic_seg5,\n\t\t\t segval[5][V4L2_AV1_SEG_LVL_REF_FRAME]);\n\thantro_reg_write(vpu, &av1_skip_seg5,\n\t\t\t segval[5][V4L2_AV1_SEG_LVL_REF_SKIP]);\n\thantro_reg_write(vpu, &av1_global_mv_seg5,\n\t\t\t segval[5][V4L2_AV1_SEG_LVL_REF_GLOBALMV]);\n\n\thantro_reg_write(vpu, &av1_quant_seg6,\n\t\t\t segval[6][V4L2_AV1_SEG_LVL_ALT_Q]);\n\thantro_reg_write(vpu, &av1_filt_level_delta0_seg6,\n\t\t\t segval[6][V4L2_AV1_SEG_LVL_ALT_LF_Y_V]);\n\thantro_reg_write(vpu, &av1_filt_level_delta1_seg6,\n\t\t\t segval[6][V4L2_AV1_SEG_LVL_ALT_LF_Y_H]);\n\thantro_reg_write(vpu, &av1_filt_level_delta2_seg6,\n\t\t\t segval[6][V4L2_AV1_SEG_LVL_ALT_LF_U]);\n\thantro_reg_write(vpu, &av1_filt_level_delta3_seg6,\n\t\t\t segval[6][V4L2_AV1_SEG_LVL_ALT_LF_V]);\n\thantro_reg_write(vpu, &av1_refpic_seg6,\n\t\t\t segval[6][V4L2_AV1_SEG_LVL_REF_FRAME]);\n\thantro_reg_write(vpu, &av1_skip_seg6,\n\t\t\t segval[6][V4L2_AV1_SEG_LVL_REF_SKIP]);\n\thantro_reg_write(vpu, &av1_global_mv_seg6,\n\t\t\t segval[6][V4L2_AV1_SEG_LVL_REF_GLOBALMV]);\n\n\thantro_reg_write(vpu, &av1_quant_seg7,\n\t\t\t segval[7][V4L2_AV1_SEG_LVL_ALT_Q]);\n\thantro_reg_write(vpu, &av1_filt_level_delta0_seg7,\n\t\t\t segval[7][V4L2_AV1_SEG_LVL_ALT_LF_Y_V]);\n\thantro_reg_write(vpu, &av1_filt_level_delta1_seg7,\n\t\t\t segval[7][V4L2_AV1_SEG_LVL_ALT_LF_Y_H]);\n\thantro_reg_write(vpu, &av1_filt_level_delta2_seg7,\n\t\t\t segval[7][V4L2_AV1_SEG_LVL_ALT_LF_U]);\n\thantro_reg_write(vpu, &av1_filt_level_delta3_seg7,\n\t\t\t segval[7][V4L2_AV1_SEG_LVL_ALT_LF_V]);\n\thantro_reg_write(vpu, &av1_refpic_seg7,\n\t\t\t segval[7][V4L2_AV1_SEG_LVL_REF_FRAME]);\n\thantro_reg_write(vpu, &av1_skip_seg7,\n\t\t\t segval[7][V4L2_AV1_SEG_LVL_REF_SKIP]);\n\thantro_reg_write(vpu, &av1_global_mv_seg7,\n\t\t\t segval[7][V4L2_AV1_SEG_LVL_REF_GLOBALMV]);\n}\n\nstatic bool rockchip_vpu981_av1_dec_is_lossless(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tconst struct v4l2_av1_segmentation *segmentation = &frame->segmentation;\n\tconst struct v4l2_av1_quantization *quantization = &frame->quantization;\n\tint i;\n\n\tfor (i = 0; i < V4L2_AV1_MAX_SEGMENTS; i++) {\n\t\tint qindex = quantization->base_q_idx;\n\n\t\tif (segmentation->feature_enabled[i] &\n\t\t    V4L2_AV1_SEGMENT_FEATURE_ENABLED(V4L2_AV1_SEG_LVL_ALT_Q)) {\n\t\t\tqindex += segmentation->feature_data[i][V4L2_AV1_SEG_LVL_ALT_Q];\n\t\t}\n\t\tqindex = clamp(qindex, 0, 255);\n\n\t\tif (qindex ||\n\t\t    quantization->delta_q_y_dc ||\n\t\t    quantization->delta_q_u_dc ||\n\t\t    quantization->delta_q_u_ac ||\n\t\t    quantization->delta_q_v_dc ||\n\t\t    quantization->delta_q_v_ac)\n\t\t\treturn false;\n\t}\n\treturn true;\n}\n\nstatic void rockchip_vpu981_av1_dec_set_loopfilter(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tconst struct v4l2_av1_loop_filter *loop_filter = &frame->loop_filter;\n\tbool filtering_dis = (loop_filter->level[0] == 0) && (loop_filter->level[1] == 0);\n\tstruct hantro_dev *vpu = ctx->dev;\n\n\thantro_reg_write(vpu, &av1_filtering_dis, filtering_dis);\n\thantro_reg_write(vpu, &av1_filt_level_base_gt32, loop_filter->level[0] > 32);\n\thantro_reg_write(vpu, &av1_filt_sharpness, loop_filter->sharpness);\n\n\thantro_reg_write(vpu, &av1_filt_level0, loop_filter->level[0]);\n\thantro_reg_write(vpu, &av1_filt_level1, loop_filter->level[1]);\n\thantro_reg_write(vpu, &av1_filt_level2, loop_filter->level[2]);\n\thantro_reg_write(vpu, &av1_filt_level3, loop_filter->level[3]);\n\n\tif (loop_filter->flags & V4L2_AV1_LOOP_FILTER_FLAG_DELTA_ENABLED &&\n\t    !rockchip_vpu981_av1_dec_is_lossless(ctx) &&\n\t    !(frame->flags & V4L2_AV1_FRAME_FLAG_ALLOW_INTRABC)) {\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_0,\n\t\t\t\t loop_filter->ref_deltas[0]);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_1,\n\t\t\t\t loop_filter->ref_deltas[1]);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_2,\n\t\t\t\t loop_filter->ref_deltas[2]);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_3,\n\t\t\t\t loop_filter->ref_deltas[3]);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_4,\n\t\t\t\t loop_filter->ref_deltas[4]);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_5,\n\t\t\t\t loop_filter->ref_deltas[5]);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_6,\n\t\t\t\t loop_filter->ref_deltas[6]);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_7,\n\t\t\t\t loop_filter->ref_deltas[7]);\n\t\thantro_reg_write(vpu, &av1_filt_mb_adj_0,\n\t\t\t\t loop_filter->mode_deltas[0]);\n\t\thantro_reg_write(vpu, &av1_filt_mb_adj_1,\n\t\t\t\t loop_filter->mode_deltas[1]);\n\t} else {\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_0, 0);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_1, 0);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_2, 0);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_3, 0);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_4, 0);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_5, 0);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_6, 0);\n\t\thantro_reg_write(vpu, &av1_filt_ref_adj_7, 0);\n\t\thantro_reg_write(vpu, &av1_filt_mb_adj_0, 0);\n\t\thantro_reg_write(vpu, &av1_filt_mb_adj_1, 0);\n\t}\n\n\thantro_write_addr(vpu, AV1_DB_DATA_COL, av1_dec->db_data_col.dma);\n\thantro_write_addr(vpu, AV1_DB_CTRL_COL, av1_dec->db_ctrl_col.dma);\n}\n\nstatic void rockchip_vpu981_av1_dec_update_prob(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tbool frame_is_intra = IS_INTRA(frame->frame_type);\n\tstruct av1cdfs *out_cdfs = (struct av1cdfs *)av1_dec->prob_tbl_out.cpu;\n\tint i;\n\n\tif (frame->flags & V4L2_AV1_FRAME_FLAG_DISABLE_FRAME_END_UPDATE_CDF)\n\t\treturn;\n\n\tfor (i = 0; i < NUM_REF_FRAMES; i++) {\n\t\tif (frame->refresh_frame_flags & BIT(i)) {\n\t\t\tstruct mvcdfs stored_mv_cdf;\n\n\t\t\trockchip_av1_get_cdfs(ctx, i);\n\t\t\tstored_mv_cdf = av1_dec->cdfs->mv_cdf;\n\t\t\t*av1_dec->cdfs = *out_cdfs;\n\t\t\tif (frame_is_intra) {\n\t\t\t\tav1_dec->cdfs->mv_cdf = stored_mv_cdf;\n\t\t\t\t*av1_dec->cdfs_ndvc = out_cdfs->mv_cdf;\n\t\t\t}\n\t\t\trockchip_av1_store_cdfs(ctx,\n\t\t\t\t\t\tframe->refresh_frame_flags);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nvoid rockchip_vpu981_av1_dec_done(struct hantro_ctx *ctx)\n{\n\trockchip_vpu981_av1_dec_update_prob(ctx);\n}\n\nstatic void rockchip_vpu981_av1_dec_set_prob(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tconst struct v4l2_av1_quantization *quantization = &frame->quantization;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tbool error_resilient_mode =\n\t    !!(frame->flags & V4L2_AV1_FRAME_FLAG_ERROR_RESILIENT_MODE);\n\tbool frame_is_intra = IS_INTRA(frame->frame_type);\n\n\tif (error_resilient_mode || frame_is_intra ||\n\t    frame->primary_ref_frame == AV1_PRIMARY_REF_NONE) {\n\t\tav1_dec->cdfs = &av1_dec->default_cdfs;\n\t\tav1_dec->cdfs_ndvc = &av1_dec->default_cdfs_ndvc;\n\t\trockchip_av1_default_coeff_probs(quantization->base_q_idx,\n\t\t\t\t\t\t av1_dec->cdfs);\n\t} else {\n\t\trockchip_av1_get_cdfs(ctx, frame->ref_frame_idx[frame->primary_ref_frame]);\n\t}\n\trockchip_av1_store_cdfs(ctx, frame->refresh_frame_flags);\n\n\tmemcpy(av1_dec->prob_tbl.cpu, av1_dec->cdfs, sizeof(struct av1cdfs));\n\n\tif (frame_is_intra) {\n\t\tint mv_offset = offsetof(struct av1cdfs, mv_cdf);\n\t\t \n\t\tmemcpy(av1_dec->prob_tbl.cpu + mv_offset, av1_dec->cdfs_ndvc,\n\t\t       sizeof(struct mvcdfs));\n\t}\n\n\thantro_write_addr(vpu, AV1_PROP_TABLE_OUT, av1_dec->prob_tbl_out.dma);\n\thantro_write_addr(vpu, AV1_PROP_TABLE, av1_dec->prob_tbl.dma);\n}\n\nstatic void\nrockchip_vpu981_av1_dec_init_scaling_function(const u8 *values, const u8 *scaling,\n\t\t\t\t\t      u8 num_points, u8 *scaling_lut)\n{\n\tint i, point;\n\n\tif (num_points == 0) {\n\t\tmemset(scaling_lut, 0, 256);\n\t\treturn;\n\t}\n\n\tfor (point = 0; point < num_points - 1; point++) {\n\t\tint x;\n\t\ts32 delta_y = scaling[point + 1] - scaling[point];\n\t\ts32 delta_x = values[point + 1] - values[point];\n\t\ts64 delta =\n\t\t    delta_x ? delta_y * ((65536 + (delta_x >> 1)) /\n\t\t\t\t\t delta_x) : 0;\n\n\t\tfor (x = 0; x < delta_x; x++) {\n\t\t\tscaling_lut[values[point] + x] =\n\t\t\t    scaling[point] +\n\t\t\t    (s32)((x * delta + 32768) >> 16);\n\t\t}\n\t}\n\n\tfor (i = values[num_points - 1]; i < 256; i++)\n\t\tscaling_lut[i] = scaling[num_points - 1];\n}\n\nstatic void rockchip_vpu981_av1_dec_set_fgs(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_film_grain *film_grain = ctrls->film_grain;\n\tstruct rockchip_av1_film_grain *fgmem = av1_dec->film_grain.cpu;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tbool scaling_from_luma =\n\t\t!!(film_grain->flags & V4L2_AV1_FILM_GRAIN_FLAG_CHROMA_SCALING_FROM_LUMA);\n\ts32 (*ar_coeffs_y)[24];\n\ts32 (*ar_coeffs_cb)[25];\n\ts32 (*ar_coeffs_cr)[25];\n\ts32 (*luma_grain_block)[73][82];\n\ts32 (*cb_grain_block)[38][44];\n\ts32 (*cr_grain_block)[38][44];\n\ts32 ar_coeff_lag, ar_coeff_shift;\n\ts32 grain_scale_shift, bitdepth;\n\ts32 grain_center, grain_min, grain_max;\n\tint i, j;\n\n\thantro_reg_write(vpu, &av1_apply_grain, 0);\n\n\tif (!(film_grain->flags & V4L2_AV1_FILM_GRAIN_FLAG_APPLY_GRAIN)) {\n\t\thantro_reg_write(vpu, &av1_num_y_points_b, 0);\n\t\thantro_reg_write(vpu, &av1_num_cb_points_b, 0);\n\t\thantro_reg_write(vpu, &av1_num_cr_points_b, 0);\n\t\thantro_reg_write(vpu, &av1_scaling_shift, 0);\n\t\thantro_reg_write(vpu, &av1_cb_mult, 0);\n\t\thantro_reg_write(vpu, &av1_cb_luma_mult, 0);\n\t\thantro_reg_write(vpu, &av1_cb_offset, 0);\n\t\thantro_reg_write(vpu, &av1_cr_mult, 0);\n\t\thantro_reg_write(vpu, &av1_cr_luma_mult, 0);\n\t\thantro_reg_write(vpu, &av1_cr_offset, 0);\n\t\thantro_reg_write(vpu, &av1_overlap_flag, 0);\n\t\thantro_reg_write(vpu, &av1_clip_to_restricted_range, 0);\n\t\thantro_reg_write(vpu, &av1_chroma_scaling_from_luma, 0);\n\t\thantro_reg_write(vpu, &av1_random_seed, 0);\n\t\thantro_write_addr(vpu, AV1_FILM_GRAIN, 0);\n\t\treturn;\n\t}\n\n\tar_coeffs_y = kzalloc(sizeof(int32_t) * 24, GFP_KERNEL);\n\tar_coeffs_cb = kzalloc(sizeof(int32_t) * 25, GFP_KERNEL);\n\tar_coeffs_cr = kzalloc(sizeof(int32_t) * 25, GFP_KERNEL);\n\tluma_grain_block = kzalloc(sizeof(int32_t) * 73 * 82, GFP_KERNEL);\n\tcb_grain_block = kzalloc(sizeof(int32_t) * 38 * 44, GFP_KERNEL);\n\tcr_grain_block = kzalloc(sizeof(int32_t) * 38 * 44, GFP_KERNEL);\n\n\tif (!ar_coeffs_y || !ar_coeffs_cb || !ar_coeffs_cr ||\n\t    !luma_grain_block || !cb_grain_block || !cr_grain_block) {\n\t\tpr_warn(\"Fail allocating memory for film grain parameters\\n\");\n\t\tgoto alloc_fail;\n\t}\n\n\thantro_reg_write(vpu, &av1_apply_grain, 1);\n\n\thantro_reg_write(vpu, &av1_num_y_points_b,\n\t\t\t film_grain->num_y_points > 0);\n\thantro_reg_write(vpu, &av1_num_cb_points_b,\n\t\t\t film_grain->num_cb_points > 0);\n\thantro_reg_write(vpu, &av1_num_cr_points_b,\n\t\t\t film_grain->num_cr_points > 0);\n\thantro_reg_write(vpu, &av1_scaling_shift,\n\t\t\t film_grain->grain_scaling_minus_8 + 8);\n\n\tif (!scaling_from_luma) {\n\t\thantro_reg_write(vpu, &av1_cb_mult, film_grain->cb_mult - 128);\n\t\thantro_reg_write(vpu, &av1_cb_luma_mult, film_grain->cb_luma_mult - 128);\n\t\thantro_reg_write(vpu, &av1_cb_offset, film_grain->cb_offset - 256);\n\t\thantro_reg_write(vpu, &av1_cr_mult, film_grain->cr_mult - 128);\n\t\thantro_reg_write(vpu, &av1_cr_luma_mult, film_grain->cr_luma_mult - 128);\n\t\thantro_reg_write(vpu, &av1_cr_offset, film_grain->cr_offset - 256);\n\t} else {\n\t\thantro_reg_write(vpu, &av1_cb_mult, 0);\n\t\thantro_reg_write(vpu, &av1_cb_luma_mult, 0);\n\t\thantro_reg_write(vpu, &av1_cb_offset, 0);\n\t\thantro_reg_write(vpu, &av1_cr_mult, 0);\n\t\thantro_reg_write(vpu, &av1_cr_luma_mult, 0);\n\t\thantro_reg_write(vpu, &av1_cr_offset, 0);\n\t}\n\n\thantro_reg_write(vpu, &av1_overlap_flag,\n\t\t\t !!(film_grain->flags & V4L2_AV1_FILM_GRAIN_FLAG_OVERLAP));\n\thantro_reg_write(vpu, &av1_clip_to_restricted_range,\n\t\t\t !!(film_grain->flags & V4L2_AV1_FILM_GRAIN_FLAG_CLIP_TO_RESTRICTED_RANGE));\n\thantro_reg_write(vpu, &av1_chroma_scaling_from_luma, scaling_from_luma);\n\thantro_reg_write(vpu, &av1_random_seed, film_grain->grain_seed);\n\n\trockchip_vpu981_av1_dec_init_scaling_function(film_grain->point_y_value,\n\t\t\t\t\t\t      film_grain->point_y_scaling,\n\t\t\t\t\t\t      film_grain->num_y_points,\n\t\t\t\t\t\t      fgmem->scaling_lut_y);\n\n\tif (film_grain->flags &\n\t    V4L2_AV1_FILM_GRAIN_FLAG_CHROMA_SCALING_FROM_LUMA) {\n\t\tmemcpy(fgmem->scaling_lut_cb, fgmem->scaling_lut_y,\n\t\t       sizeof(*fgmem->scaling_lut_y) * 256);\n\t\tmemcpy(fgmem->scaling_lut_cr, fgmem->scaling_lut_y,\n\t\t       sizeof(*fgmem->scaling_lut_y) * 256);\n\t} else {\n\t\trockchip_vpu981_av1_dec_init_scaling_function\n\t\t    (film_grain->point_cb_value, film_grain->point_cb_scaling,\n\t\t     film_grain->num_cb_points, fgmem->scaling_lut_cb);\n\t\trockchip_vpu981_av1_dec_init_scaling_function\n\t\t    (film_grain->point_cr_value, film_grain->point_cr_scaling,\n\t\t     film_grain->num_cr_points, fgmem->scaling_lut_cr);\n\t}\n\n\tfor (i = 0; i < V4L2_AV1_AR_COEFFS_SIZE; i++) {\n\t\tif (i < 24)\n\t\t\t(*ar_coeffs_y)[i] = film_grain->ar_coeffs_y_plus_128[i] - 128;\n\t\t(*ar_coeffs_cb)[i] = film_grain->ar_coeffs_cb_plus_128[i] - 128;\n\t\t(*ar_coeffs_cr)[i] = film_grain->ar_coeffs_cr_plus_128[i] - 128;\n\t}\n\n\tar_coeff_lag = film_grain->ar_coeff_lag;\n\tar_coeff_shift = film_grain->ar_coeff_shift_minus_6 + 6;\n\tgrain_scale_shift = film_grain->grain_scale_shift;\n\tbitdepth = ctx->bit_depth;\n\tgrain_center = 128 << (bitdepth - 8);\n\tgrain_min = 0 - grain_center;\n\tgrain_max = (256 << (bitdepth - 8)) - 1 - grain_center;\n\n\trockchip_av1_generate_luma_grain_block(luma_grain_block, bitdepth,\n\t\t\t\t\t       film_grain->num_y_points, grain_scale_shift,\n\t\t\t\t\t       ar_coeff_lag, ar_coeffs_y, ar_coeff_shift,\n\t\t\t\t\t       grain_min, grain_max, film_grain->grain_seed);\n\n\trockchip_av1_generate_chroma_grain_block(luma_grain_block, cb_grain_block,\n\t\t\t\t\t\t cr_grain_block, bitdepth,\n\t\t\t\t\t\t film_grain->num_y_points,\n\t\t\t\t\t\t film_grain->num_cb_points,\n\t\t\t\t\t\t film_grain->num_cr_points,\n\t\t\t\t\t\t grain_scale_shift, ar_coeff_lag, ar_coeffs_cb,\n\t\t\t\t\t\t ar_coeffs_cr, ar_coeff_shift, grain_min,\n\t\t\t\t\t\t grain_max,\n\t\t\t\t\t\t scaling_from_luma,\n\t\t\t\t\t\t film_grain->grain_seed);\n\n\tfor (i = 0; i < 64; i++) {\n\t\tfor (j = 0; j < 64; j++)\n\t\t\tfgmem->cropped_luma_grain_block[i * 64 + j] =\n\t\t\t\t(*luma_grain_block)[i + 9][j + 9];\n\t}\n\n\tfor (i = 0; i < 32; i++) {\n\t\tfor (j = 0; j < 32; j++) {\n\t\t\tfgmem->cropped_chroma_grain_block[i * 64 + 2 * j] =\n\t\t\t\t(*cb_grain_block)[i + 6][j + 6];\n\t\t\tfgmem->cropped_chroma_grain_block[i * 64 + 2 * j + 1] =\n\t\t\t\t(*cr_grain_block)[i + 6][j + 6];\n\t\t}\n\t}\n\n\thantro_write_addr(vpu, AV1_FILM_GRAIN, av1_dec->film_grain.dma);\n\nalloc_fail:\n\tkfree(ar_coeffs_y);\n\tkfree(ar_coeffs_cb);\n\tkfree(ar_coeffs_cr);\n\tkfree(luma_grain_block);\n\tkfree(cb_grain_block);\n\tkfree(cr_grain_block);\n}\n\nstatic void rockchip_vpu981_av1_dec_set_cdef(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tconst struct v4l2_av1_cdef *cdef = &frame->cdef;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tu32 luma_pri_strength = 0;\n\tu16 luma_sec_strength = 0;\n\tu32 chroma_pri_strength = 0;\n\tu16 chroma_sec_strength = 0;\n\tint i;\n\n\thantro_reg_write(vpu, &av1_cdef_bits, cdef->bits);\n\thantro_reg_write(vpu, &av1_cdef_damping, cdef->damping_minus_3);\n\n\tfor (i = 0; i < BIT(cdef->bits); i++) {\n\t\tluma_pri_strength |= cdef->y_pri_strength[i] << (i * 4);\n\t\tif (cdef->y_sec_strength[i] == 4)\n\t\t\tluma_sec_strength |= 3 << (i * 2);\n\t\telse\n\t\t\tluma_sec_strength |= cdef->y_sec_strength[i] << (i * 2);\n\n\t\tchroma_pri_strength |= cdef->uv_pri_strength[i] << (i * 4);\n\t\tif (cdef->uv_sec_strength[i] == 4)\n\t\t\tchroma_sec_strength |= 3 << (i * 2);\n\t\telse\n\t\t\tchroma_sec_strength |= cdef->uv_sec_strength[i] << (i * 2);\n\t}\n\n\thantro_reg_write(vpu, &av1_cdef_luma_primary_strength,\n\t\t\t luma_pri_strength);\n\thantro_reg_write(vpu, &av1_cdef_luma_secondary_strength,\n\t\t\t luma_sec_strength);\n\thantro_reg_write(vpu, &av1_cdef_chroma_primary_strength,\n\t\t\t chroma_pri_strength);\n\thantro_reg_write(vpu, &av1_cdef_chroma_secondary_strength,\n\t\t\t chroma_sec_strength);\n\n\thantro_write_addr(vpu, AV1_CDEF_COL, av1_dec->cdef_col.dma);\n}\n\nstatic void rockchip_vpu981_av1_dec_set_lr(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tconst struct v4l2_av1_loop_restoration *loop_restoration =\n\t    &frame->loop_restoration;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tu16 lr_type = 0, lr_unit_size = 0;\n\tu8 restoration_unit_size[V4L2_AV1_NUM_PLANES_MAX] = { 3, 3, 3 };\n\tint i;\n\n\tif (loop_restoration->flags & V4L2_AV1_LOOP_RESTORATION_FLAG_USES_LR) {\n\t\trestoration_unit_size[0] = 1 + loop_restoration->lr_unit_shift;\n\t\trestoration_unit_size[1] =\n\t\t    1 + loop_restoration->lr_unit_shift - loop_restoration->lr_uv_shift;\n\t\trestoration_unit_size[2] =\n\t\t    1 + loop_restoration->lr_unit_shift - loop_restoration->lr_uv_shift;\n\t}\n\n\tfor (i = 0; i < V4L2_AV1_NUM_PLANES_MAX; i++) {\n\t\tlr_type |=\n\t\t    loop_restoration->frame_restoration_type[i] << (i * 2);\n\t\tlr_unit_size |= restoration_unit_size[i] << (i * 2);\n\t}\n\n\thantro_reg_write(vpu, &av1_lr_type, lr_type);\n\thantro_reg_write(vpu, &av1_lr_unit_size, lr_unit_size);\n\thantro_write_addr(vpu, AV1_LR_COL, av1_dec->lr_col.dma);\n}\n\nstatic void rockchip_vpu981_av1_dec_set_superres_params(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tu8 superres_scale_denominator = SCALE_NUMERATOR;\n\tint superres_luma_step = RS_SCALE_SUBPEL_BITS;\n\tint superres_chroma_step = RS_SCALE_SUBPEL_BITS;\n\tint superres_luma_step_invra = RS_SCALE_SUBPEL_BITS;\n\tint superres_chroma_step_invra = RS_SCALE_SUBPEL_BITS;\n\tint superres_init_luma_subpel_x = 0;\n\tint superres_init_chroma_subpel_x = 0;\n\tint superres_is_scaled = 0;\n\tint min_w = min_t(uint32_t, 16, frame->upscaled_width);\n\tint upscaled_luma, downscaled_luma;\n\tint downscaled_chroma, upscaled_chroma;\n\tint step_luma, step_chroma;\n\tint err_luma, err_chroma;\n\tint initial_luma, initial_chroma;\n\tint width = 0;\n\n\tif (frame->flags & V4L2_AV1_FRAME_FLAG_USE_SUPERRES)\n\t\tsuperres_scale_denominator = frame->superres_denom;\n\n\tif (superres_scale_denominator <= SCALE_NUMERATOR)\n\t\tgoto set_regs;\n\n\twidth = (frame->upscaled_width * SCALE_NUMERATOR +\n\t\t(superres_scale_denominator / 2)) / superres_scale_denominator;\n\n\tif (width < min_w)\n\t\twidth = min_w;\n\n\tif (width == frame->upscaled_width)\n\t\tgoto set_regs;\n\n\tsuperres_is_scaled = 1;\n\tupscaled_luma = frame->upscaled_width;\n\tdownscaled_luma = width;\n\tdownscaled_chroma = (downscaled_luma + 1) >> 1;\n\tupscaled_chroma = (upscaled_luma + 1) >> 1;\n\tstep_luma =\n\t\t((downscaled_luma << RS_SCALE_SUBPEL_BITS) +\n\t\t (upscaled_luma / 2)) / upscaled_luma;\n\tstep_chroma =\n\t\t((downscaled_chroma << RS_SCALE_SUBPEL_BITS) +\n\t\t (upscaled_chroma / 2)) / upscaled_chroma;\n\terr_luma =\n\t\t(upscaled_luma * step_luma)\n\t\t- (downscaled_luma << RS_SCALE_SUBPEL_BITS);\n\terr_chroma =\n\t\t(upscaled_chroma * step_chroma)\n\t\t- (downscaled_chroma << RS_SCALE_SUBPEL_BITS);\n\tinitial_luma =\n\t\t((-((upscaled_luma - downscaled_luma) << (RS_SCALE_SUBPEL_BITS - 1))\n\t\t  + upscaled_luma / 2)\n\t\t / upscaled_luma + (1 << (RS_SCALE_EXTRA_BITS - 1)) - err_luma / 2)\n\t\t& RS_SCALE_SUBPEL_MASK;\n\tinitial_chroma =\n\t\t((-((upscaled_chroma - downscaled_chroma) << (RS_SCALE_SUBPEL_BITS - 1))\n\t\t  + upscaled_chroma / 2)\n\t\t / upscaled_chroma + (1 << (RS_SCALE_EXTRA_BITS - 1)) - err_chroma / 2)\n\t\t& RS_SCALE_SUBPEL_MASK;\n\tsuperres_luma_step = step_luma;\n\tsuperres_chroma_step = step_chroma;\n\tsuperres_luma_step_invra =\n\t\t((upscaled_luma << RS_SCALE_SUBPEL_BITS) + (downscaled_luma / 2))\n\t\t/ downscaled_luma;\n\tsuperres_chroma_step_invra =\n\t\t((upscaled_chroma << RS_SCALE_SUBPEL_BITS) + (downscaled_chroma / 2))\n\t\t/ downscaled_chroma;\n\tsuperres_init_luma_subpel_x = initial_luma;\n\tsuperres_init_chroma_subpel_x = initial_chroma;\n\nset_regs:\n\thantro_reg_write(vpu, &av1_superres_pic_width, frame->upscaled_width);\n\n\tif (frame->flags & V4L2_AV1_FRAME_FLAG_USE_SUPERRES)\n\t\thantro_reg_write(vpu, &av1_scale_denom_minus9,\n\t\t\t\t frame->superres_denom - SUPERRES_SCALE_DENOMINATOR_MIN);\n\telse\n\t\thantro_reg_write(vpu, &av1_scale_denom_minus9, frame->superres_denom);\n\n\thantro_reg_write(vpu, &av1_superres_luma_step, superres_luma_step);\n\thantro_reg_write(vpu, &av1_superres_chroma_step, superres_chroma_step);\n\thantro_reg_write(vpu, &av1_superres_luma_step_invra,\n\t\t\t superres_luma_step_invra);\n\thantro_reg_write(vpu, &av1_superres_chroma_step_invra,\n\t\t\t superres_chroma_step_invra);\n\thantro_reg_write(vpu, &av1_superres_init_luma_subpel_x,\n\t\t\t superres_init_luma_subpel_x);\n\thantro_reg_write(vpu, &av1_superres_init_chroma_subpel_x,\n\t\t\t superres_init_chroma_subpel_x);\n\thantro_reg_write(vpu, &av1_superres_is_scaled, superres_is_scaled);\n\n\thantro_write_addr(vpu, AV1_SR_COL, av1_dec->sr_col.dma);\n}\n\nstatic void rockchip_vpu981_av1_dec_set_picture_dimensions(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tint pic_width_in_cbs = DIV_ROUND_UP(frame->frame_width_minus_1 + 1, 8);\n\tint pic_height_in_cbs = DIV_ROUND_UP(frame->frame_height_minus_1 + 1, 8);\n\tint pic_width_pad = ALIGN(frame->frame_width_minus_1 + 1, 8)\n\t\t\t    - (frame->frame_width_minus_1 + 1);\n\tint pic_height_pad = ALIGN(frame->frame_height_minus_1 + 1, 8)\n\t\t\t     - (frame->frame_height_minus_1 + 1);\n\n\thantro_reg_write(vpu, &av1_pic_width_in_cbs, pic_width_in_cbs);\n\thantro_reg_write(vpu, &av1_pic_height_in_cbs, pic_height_in_cbs);\n\thantro_reg_write(vpu, &av1_pic_width_pad, pic_width_pad);\n\thantro_reg_write(vpu, &av1_pic_height_pad, pic_height_pad);\n\n\trockchip_vpu981_av1_dec_set_superres_params(ctx);\n}\n\nstatic void rockchip_vpu981_av1_dec_set_other_frames(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tbool use_ref_frame_mvs =\n\t    !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_USE_REF_FRAME_MVS);\n\tint cur_frame_offset = frame->order_hint;\n\tint alt_frame_offset = 0;\n\tint gld_frame_offset = 0;\n\tint bwd_frame_offset = 0;\n\tint alt2_frame_offset = 0;\n\tint refs_selected[3] = { 0, 0, 0 };\n\tint cur_mi_cols = DIV_ROUND_UP(frame->frame_width_minus_1 + 1, 8);\n\tint cur_mi_rows = DIV_ROUND_UP(frame->frame_height_minus_1 + 1, 8);\n\tint cur_offset[V4L2_AV1_TOTAL_REFS_PER_FRAME - 1];\n\tint cur_roffset[V4L2_AV1_TOTAL_REFS_PER_FRAME - 1];\n\tint mf_types[3] = { 0, 0, 0 };\n\tint ref_stamp = 2;\n\tint ref_ind = 0;\n\tint rf, idx;\n\n\talt_frame_offset = rockchip_vpu981_get_order_hint(ctx, ALT_BUF_IDX);\n\tgld_frame_offset = rockchip_vpu981_get_order_hint(ctx, GLD_BUF_IDX);\n\tbwd_frame_offset = rockchip_vpu981_get_order_hint(ctx, BWD_BUF_IDX);\n\talt2_frame_offset = rockchip_vpu981_get_order_hint(ctx, ALT2_BUF_IDX);\n\n\tidx = rockchip_vpu981_get_frame_index(ctx, LST_BUF_IDX);\n\tif (idx >= 0) {\n\t\tint alt_frame_offset_in_lst =\n\t\t\tav1_dec->frame_refs[idx].order_hints[V4L2_AV1_REF_ALTREF_FRAME];\n\t\tbool is_lst_overlay =\n\t\t    (alt_frame_offset_in_lst == gld_frame_offset);\n\n\t\tif (!is_lst_overlay) {\n\t\t\tint lst_mi_cols = av1_dec->frame_refs[idx].mi_cols;\n\t\t\tint lst_mi_rows = av1_dec->frame_refs[idx].mi_rows;\n\t\t\tbool lst_intra_only =\n\t\t\t    IS_INTRA(av1_dec->frame_refs[idx].frame_type);\n\n\t\t\tif (lst_mi_cols == cur_mi_cols &&\n\t\t\t    lst_mi_rows == cur_mi_rows && !lst_intra_only) {\n\t\t\t\tmf_types[ref_ind] = V4L2_AV1_REF_LAST_FRAME;\n\t\t\t\trefs_selected[ref_ind++] = LST_BUF_IDX;\n\t\t\t}\n\t\t}\n\t\tref_stamp--;\n\t}\n\n\tidx = rockchip_vpu981_get_frame_index(ctx, BWD_BUF_IDX);\n\tif (rockchip_vpu981_av1_dec_get_dist(ctx, bwd_frame_offset, cur_frame_offset) > 0) {\n\t\tint bwd_mi_cols = av1_dec->frame_refs[idx].mi_cols;\n\t\tint bwd_mi_rows = av1_dec->frame_refs[idx].mi_rows;\n\t\tbool bwd_intra_only =\n\t\t    IS_INTRA(av1_dec->frame_refs[idx].frame_type);\n\n\t\tif (bwd_mi_cols == cur_mi_cols && bwd_mi_rows == cur_mi_rows &&\n\t\t    !bwd_intra_only) {\n\t\t\tmf_types[ref_ind] = V4L2_AV1_REF_BWDREF_FRAME;\n\t\t\trefs_selected[ref_ind++] = BWD_BUF_IDX;\n\t\t\tref_stamp--;\n\t\t}\n\t}\n\n\tidx = rockchip_vpu981_get_frame_index(ctx, ALT2_BUF_IDX);\n\tif (rockchip_vpu981_av1_dec_get_dist(ctx, alt2_frame_offset, cur_frame_offset) > 0) {\n\t\tint alt2_mi_cols = av1_dec->frame_refs[idx].mi_cols;\n\t\tint alt2_mi_rows = av1_dec->frame_refs[idx].mi_rows;\n\t\tbool alt2_intra_only =\n\t\t    IS_INTRA(av1_dec->frame_refs[idx].frame_type);\n\n\t\tif (alt2_mi_cols == cur_mi_cols && alt2_mi_rows == cur_mi_rows &&\n\t\t    !alt2_intra_only) {\n\t\t\tmf_types[ref_ind] = V4L2_AV1_REF_ALTREF2_FRAME;\n\t\t\trefs_selected[ref_ind++] = ALT2_BUF_IDX;\n\t\t\tref_stamp--;\n\t\t}\n\t}\n\n\tidx = rockchip_vpu981_get_frame_index(ctx, ALT_BUF_IDX);\n\tif (rockchip_vpu981_av1_dec_get_dist(ctx, alt_frame_offset, cur_frame_offset) > 0 &&\n\t    ref_stamp >= 0) {\n\t\tint alt_mi_cols = av1_dec->frame_refs[idx].mi_cols;\n\t\tint alt_mi_rows = av1_dec->frame_refs[idx].mi_rows;\n\t\tbool alt_intra_only =\n\t\t    IS_INTRA(av1_dec->frame_refs[idx].frame_type);\n\n\t\tif (alt_mi_cols == cur_mi_cols && alt_mi_rows == cur_mi_rows &&\n\t\t    !alt_intra_only) {\n\t\t\tmf_types[ref_ind] = V4L2_AV1_REF_ALTREF_FRAME;\n\t\t\trefs_selected[ref_ind++] = ALT_BUF_IDX;\n\t\t\tref_stamp--;\n\t\t}\n\t}\n\n\tidx = rockchip_vpu981_get_frame_index(ctx, LST2_BUF_IDX);\n\tif (idx >= 0 && ref_stamp >= 0) {\n\t\tint lst2_mi_cols = av1_dec->frame_refs[idx].mi_cols;\n\t\tint lst2_mi_rows = av1_dec->frame_refs[idx].mi_rows;\n\t\tbool lst2_intra_only =\n\t\t    IS_INTRA(av1_dec->frame_refs[idx].frame_type);\n\n\t\tif (lst2_mi_cols == cur_mi_cols && lst2_mi_rows == cur_mi_rows &&\n\t\t    !lst2_intra_only) {\n\t\t\tmf_types[ref_ind] = V4L2_AV1_REF_LAST2_FRAME;\n\t\t\trefs_selected[ref_ind++] = LST2_BUF_IDX;\n\t\t\tref_stamp--;\n\t\t}\n\t}\n\n\tfor (rf = 0; rf < V4L2_AV1_TOTAL_REFS_PER_FRAME - 1; ++rf) {\n\t\tidx = rockchip_vpu981_get_frame_index(ctx, rf);\n\t\tif (idx >= 0) {\n\t\t\tint rf_order_hint = rockchip_vpu981_get_order_hint(ctx, rf);\n\n\t\t\tcur_offset[rf] =\n\t\t\t    rockchip_vpu981_av1_dec_get_dist(ctx, cur_frame_offset, rf_order_hint);\n\t\t\tcur_roffset[rf] =\n\t\t\t    rockchip_vpu981_av1_dec_get_dist(ctx, rf_order_hint, cur_frame_offset);\n\t\t} else {\n\t\t\tcur_offset[rf] = 0;\n\t\t\tcur_roffset[rf] = 0;\n\t\t}\n\t}\n\n\thantro_reg_write(vpu, &av1_use_temporal0_mvs, 0);\n\thantro_reg_write(vpu, &av1_use_temporal1_mvs, 0);\n\thantro_reg_write(vpu, &av1_use_temporal2_mvs, 0);\n\thantro_reg_write(vpu, &av1_use_temporal3_mvs, 0);\n\n\thantro_reg_write(vpu, &av1_mf1_last_offset, 0);\n\thantro_reg_write(vpu, &av1_mf1_last2_offset, 0);\n\thantro_reg_write(vpu, &av1_mf1_last3_offset, 0);\n\thantro_reg_write(vpu, &av1_mf1_golden_offset, 0);\n\thantro_reg_write(vpu, &av1_mf1_bwdref_offset, 0);\n\thantro_reg_write(vpu, &av1_mf1_altref2_offset, 0);\n\thantro_reg_write(vpu, &av1_mf1_altref_offset, 0);\n\n\tif (use_ref_frame_mvs && ref_ind > 0 &&\n\t    cur_offset[mf_types[0] - V4L2_AV1_REF_LAST_FRAME] <= MAX_FRAME_DISTANCE &&\n\t    cur_offset[mf_types[0] - V4L2_AV1_REF_LAST_FRAME] >= -MAX_FRAME_DISTANCE) {\n\t\tint rf = rockchip_vpu981_get_order_hint(ctx, refs_selected[0]);\n\t\tint idx = rockchip_vpu981_get_frame_index(ctx, refs_selected[0]);\n\t\tu32 *oh = av1_dec->frame_refs[idx].order_hints;\n\t\tint val;\n\n\t\thantro_reg_write(vpu, &av1_use_temporal0_mvs, 1);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_LAST_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf1_last_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_LAST2_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf1_last2_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_LAST3_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf1_last3_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_GOLDEN_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf1_golden_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_BWDREF_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf1_bwdref_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_ALTREF2_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf1_altref2_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_ALTREF_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf1_altref_offset, val);\n\t}\n\n\thantro_reg_write(vpu, &av1_mf2_last_offset, 0);\n\thantro_reg_write(vpu, &av1_mf2_last2_offset, 0);\n\thantro_reg_write(vpu, &av1_mf2_last3_offset, 0);\n\thantro_reg_write(vpu, &av1_mf2_golden_offset, 0);\n\thantro_reg_write(vpu, &av1_mf2_bwdref_offset, 0);\n\thantro_reg_write(vpu, &av1_mf2_altref2_offset, 0);\n\thantro_reg_write(vpu, &av1_mf2_altref_offset, 0);\n\n\tif (use_ref_frame_mvs && ref_ind > 1 &&\n\t    cur_offset[mf_types[1] - V4L2_AV1_REF_LAST_FRAME] <= MAX_FRAME_DISTANCE &&\n\t    cur_offset[mf_types[1] - V4L2_AV1_REF_LAST_FRAME] >= -MAX_FRAME_DISTANCE) {\n\t\tint rf = rockchip_vpu981_get_order_hint(ctx, refs_selected[1]);\n\t\tint idx = rockchip_vpu981_get_frame_index(ctx, refs_selected[1]);\n\t\tu32 *oh = av1_dec->frame_refs[idx].order_hints;\n\t\tint val;\n\n\t\thantro_reg_write(vpu, &av1_use_temporal1_mvs, 1);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_LAST_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf2_last_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_LAST2_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf2_last2_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_LAST3_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf2_last3_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_GOLDEN_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf2_golden_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_BWDREF_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf2_bwdref_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_ALTREF2_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf2_altref2_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_ALTREF_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf2_altref_offset, val);\n\t}\n\n\thantro_reg_write(vpu, &av1_mf3_last_offset, 0);\n\thantro_reg_write(vpu, &av1_mf3_last2_offset, 0);\n\thantro_reg_write(vpu, &av1_mf3_last3_offset, 0);\n\thantro_reg_write(vpu, &av1_mf3_golden_offset, 0);\n\thantro_reg_write(vpu, &av1_mf3_bwdref_offset, 0);\n\thantro_reg_write(vpu, &av1_mf3_altref2_offset, 0);\n\thantro_reg_write(vpu, &av1_mf3_altref_offset, 0);\n\n\tif (use_ref_frame_mvs && ref_ind > 2 &&\n\t    cur_offset[mf_types[2] - V4L2_AV1_REF_LAST_FRAME] <= MAX_FRAME_DISTANCE &&\n\t    cur_offset[mf_types[2] - V4L2_AV1_REF_LAST_FRAME] >= -MAX_FRAME_DISTANCE) {\n\t\tint rf = rockchip_vpu981_get_order_hint(ctx, refs_selected[2]);\n\t\tint idx = rockchip_vpu981_get_frame_index(ctx, refs_selected[2]);\n\t\tu32 *oh = av1_dec->frame_refs[idx].order_hints;\n\t\tint val;\n\n\t\thantro_reg_write(vpu, &av1_use_temporal2_mvs, 1);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_LAST_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf3_last_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_LAST2_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf3_last2_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_LAST3_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf3_last3_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_GOLDEN_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf3_golden_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_BWDREF_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf3_bwdref_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_ALTREF2_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf3_altref2_offset, val);\n\n\t\tval = rockchip_vpu981_av1_dec_get_dist(ctx, rf, oh[V4L2_AV1_REF_ALTREF_FRAME]);\n\t\thantro_reg_write(vpu, &av1_mf3_altref_offset, val);\n\t}\n\n\thantro_reg_write(vpu, &av1_cur_last_offset, cur_offset[0]);\n\thantro_reg_write(vpu, &av1_cur_last2_offset, cur_offset[1]);\n\thantro_reg_write(vpu, &av1_cur_last3_offset, cur_offset[2]);\n\thantro_reg_write(vpu, &av1_cur_golden_offset, cur_offset[3]);\n\thantro_reg_write(vpu, &av1_cur_bwdref_offset, cur_offset[4]);\n\thantro_reg_write(vpu, &av1_cur_altref2_offset, cur_offset[5]);\n\thantro_reg_write(vpu, &av1_cur_altref_offset, cur_offset[6]);\n\n\thantro_reg_write(vpu, &av1_cur_last_roffset, cur_roffset[0]);\n\thantro_reg_write(vpu, &av1_cur_last2_roffset, cur_roffset[1]);\n\thantro_reg_write(vpu, &av1_cur_last3_roffset, cur_roffset[2]);\n\thantro_reg_write(vpu, &av1_cur_golden_roffset, cur_roffset[3]);\n\thantro_reg_write(vpu, &av1_cur_bwdref_roffset, cur_roffset[4]);\n\thantro_reg_write(vpu, &av1_cur_altref2_roffset, cur_roffset[5]);\n\thantro_reg_write(vpu, &av1_cur_altref_roffset, cur_roffset[6]);\n\n\thantro_reg_write(vpu, &av1_mf1_type, mf_types[0] - V4L2_AV1_REF_LAST_FRAME);\n\thantro_reg_write(vpu, &av1_mf2_type, mf_types[1] - V4L2_AV1_REF_LAST_FRAME);\n\thantro_reg_write(vpu, &av1_mf3_type, mf_types[2] - V4L2_AV1_REF_LAST_FRAME);\n}\n\nstatic void rockchip_vpu981_av1_dec_set_reference_frames(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_frame *frame = ctrls->frame;\n\tint frame_type = frame->frame_type;\n\tbool allow_intrabc = !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_ALLOW_INTRABC);\n\tint ref_count[AV1DEC_MAX_PIC_BUFFERS] = { 0 };\n\tstruct hantro_dev *vpu = ctx->dev;\n\tint i, ref_frames = 0;\n\tbool scale_enable = false;\n\n\tif (IS_INTRA(frame_type) && !allow_intrabc)\n\t\treturn;\n\n\tif (!allow_intrabc) {\n\t\tfor (i = 0; i < V4L2_AV1_REFS_PER_FRAME; i++) {\n\t\t\tint idx = rockchip_vpu981_get_frame_index(ctx, i);\n\n\t\t\tif (idx >= 0)\n\t\t\t\tref_count[idx]++;\n\t\t}\n\n\t\tfor (i = 0; i < AV1DEC_MAX_PIC_BUFFERS; i++) {\n\t\t\tif (ref_count[i])\n\t\t\t\tref_frames++;\n\t\t}\n\t} else {\n\t\tref_frames = 1;\n\t}\n\thantro_reg_write(vpu, &av1_ref_frames, ref_frames);\n\n\trockchip_vpu981_av1_dec_set_frame_sign_bias(ctx);\n\n\tfor (i = V4L2_AV1_REF_LAST_FRAME; i < V4L2_AV1_TOTAL_REFS_PER_FRAME; i++) {\n\t\tu32 ref = i - 1;\n\t\tint idx = 0;\n\t\tint width, height;\n\n\t\tif (allow_intrabc) {\n\t\t\tidx = av1_dec->current_frame_index;\n\t\t\twidth = frame->frame_width_minus_1 + 1;\n\t\t\theight = frame->frame_height_minus_1 + 1;\n\t\t} else {\n\t\t\tif (rockchip_vpu981_get_frame_index(ctx, ref) > 0)\n\t\t\t\tidx = rockchip_vpu981_get_frame_index(ctx, ref);\n\t\t\twidth = av1_dec->frame_refs[idx].width;\n\t\t\theight = av1_dec->frame_refs[idx].height;\n\t\t}\n\n\t\tscale_enable |=\n\t\t    rockchip_vpu981_av1_dec_set_ref(ctx, ref, idx, width,\n\t\t\t\t\t\t    height);\n\n\t\trockchip_vpu981_av1_dec_set_sign_bias(ctx, ref,\n\t\t\t\t\t\t      av1_dec->ref_frame_sign_bias[i]);\n\t}\n\thantro_reg_write(vpu, &av1_ref_scaling_enable, scale_enable);\n\n\thantro_reg_write(vpu, &av1_ref0_gm_mode,\n\t\t\t frame->global_motion.type[V4L2_AV1_REF_LAST_FRAME]);\n\thantro_reg_write(vpu, &av1_ref1_gm_mode,\n\t\t\t frame->global_motion.type[V4L2_AV1_REF_LAST2_FRAME]);\n\thantro_reg_write(vpu, &av1_ref2_gm_mode,\n\t\t\t frame->global_motion.type[V4L2_AV1_REF_LAST3_FRAME]);\n\thantro_reg_write(vpu, &av1_ref3_gm_mode,\n\t\t\t frame->global_motion.type[V4L2_AV1_REF_GOLDEN_FRAME]);\n\thantro_reg_write(vpu, &av1_ref4_gm_mode,\n\t\t\t frame->global_motion.type[V4L2_AV1_REF_BWDREF_FRAME]);\n\thantro_reg_write(vpu, &av1_ref5_gm_mode,\n\t\t\t frame->global_motion.type[V4L2_AV1_REF_ALTREF2_FRAME]);\n\thantro_reg_write(vpu, &av1_ref6_gm_mode,\n\t\t\t frame->global_motion.type[V4L2_AV1_REF_ALTREF_FRAME]);\n\n\trockchip_vpu981_av1_dec_set_other_frames(ctx);\n}\n\nstatic void rockchip_vpu981_av1_dec_set_parameters(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\n\thantro_reg_write(vpu, &av1_skip_mode,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_SKIP_MODE_PRESENT));\n\thantro_reg_write(vpu, &av1_tempor_mvp_e,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_USE_REF_FRAME_MVS));\n\thantro_reg_write(vpu, &av1_delta_lf_res_log,\n\t\t\t ctrls->frame->loop_filter.delta_lf_res);\n\thantro_reg_write(vpu, &av1_delta_lf_multi,\n\t\t\t !!(ctrls->frame->loop_filter.flags\n\t\t\t    & V4L2_AV1_LOOP_FILTER_FLAG_DELTA_LF_MULTI));\n\thantro_reg_write(vpu, &av1_delta_lf_present,\n\t\t\t !!(ctrls->frame->loop_filter.flags\n\t\t\t    & V4L2_AV1_LOOP_FILTER_FLAG_DELTA_LF_PRESENT));\n\thantro_reg_write(vpu, &av1_disable_cdf_update,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_DISABLE_CDF_UPDATE));\n\thantro_reg_write(vpu, &av1_allow_warp,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_ALLOW_WARPED_MOTION));\n\thantro_reg_write(vpu, &av1_show_frame,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_SHOW_FRAME));\n\thantro_reg_write(vpu, &av1_switchable_motion_mode,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_IS_MOTION_MODE_SWITCHABLE));\n\thantro_reg_write(vpu, &av1_enable_cdef,\n\t\t\t !!(ctrls->sequence->flags & V4L2_AV1_SEQUENCE_FLAG_ENABLE_CDEF));\n\thantro_reg_write(vpu, &av1_allow_masked_compound,\n\t\t\t !!(ctrls->sequence->flags\n\t\t\t    & V4L2_AV1_SEQUENCE_FLAG_ENABLE_MASKED_COMPOUND));\n\thantro_reg_write(vpu, &av1_allow_interintra,\n\t\t\t !!(ctrls->sequence->flags\n\t\t\t    & V4L2_AV1_SEQUENCE_FLAG_ENABLE_INTERINTRA_COMPOUND));\n\thantro_reg_write(vpu, &av1_enable_intra_edge_filter,\n\t\t\t !!(ctrls->sequence->flags\n\t\t\t    & V4L2_AV1_SEQUENCE_FLAG_ENABLE_INTRA_EDGE_FILTER));\n\thantro_reg_write(vpu, &av1_allow_filter_intra,\n\t\t\t !!(ctrls->sequence->flags & V4L2_AV1_SEQUENCE_FLAG_ENABLE_FILTER_INTRA));\n\thantro_reg_write(vpu, &av1_enable_jnt_comp,\n\t\t\t !!(ctrls->sequence->flags & V4L2_AV1_SEQUENCE_FLAG_ENABLE_JNT_COMP));\n\thantro_reg_write(vpu, &av1_enable_dual_filter,\n\t\t\t !!(ctrls->sequence->flags & V4L2_AV1_SEQUENCE_FLAG_ENABLE_DUAL_FILTER));\n\thantro_reg_write(vpu, &av1_reduced_tx_set_used,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_REDUCED_TX_SET));\n\thantro_reg_write(vpu, &av1_allow_screen_content_tools,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_ALLOW_SCREEN_CONTENT_TOOLS));\n\thantro_reg_write(vpu, &av1_allow_intrabc,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_ALLOW_INTRABC));\n\n\tif (!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_ALLOW_SCREEN_CONTENT_TOOLS))\n\t\thantro_reg_write(vpu, &av1_force_interger_mv, 0);\n\telse\n\t\thantro_reg_write(vpu, &av1_force_interger_mv,\n\t\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_FORCE_INTEGER_MV));\n\n\thantro_reg_write(vpu, &av1_blackwhite_e, 0);\n\thantro_reg_write(vpu, &av1_delta_q_res_log, ctrls->frame->quantization.delta_q_res);\n\thantro_reg_write(vpu, &av1_delta_q_present,\n\t\t\t !!(ctrls->frame->quantization.flags\n\t\t\t    & V4L2_AV1_QUANTIZATION_FLAG_DELTA_Q_PRESENT));\n\n\thantro_reg_write(vpu, &av1_idr_pic_e, !ctrls->frame->frame_type);\n\thantro_reg_write(vpu, &av1_quant_base_qindex, ctrls->frame->quantization.base_q_idx);\n\thantro_reg_write(vpu, &av1_bit_depth_y_minus8, ctx->bit_depth - 8);\n\thantro_reg_write(vpu, &av1_bit_depth_c_minus8, ctx->bit_depth - 8);\n\n\thantro_reg_write(vpu, &av1_mcomp_filt_type, ctrls->frame->interpolation_filter);\n\thantro_reg_write(vpu, &av1_high_prec_mv_e,\n\t\t\t !!(ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_ALLOW_HIGH_PRECISION_MV));\n\thantro_reg_write(vpu, &av1_comp_pred_mode,\n\t\t\t (ctrls->frame->flags & V4L2_AV1_FRAME_FLAG_REFERENCE_SELECT) ? 2 : 0);\n\thantro_reg_write(vpu, &av1_transform_mode, (ctrls->frame->tx_mode == 1) ? 3 : 4);\n\thantro_reg_write(vpu, &av1_max_cb_size,\n\t\t\t (ctrls->sequence->flags\n\t\t\t  & V4L2_AV1_SEQUENCE_FLAG_USE_128X128_SUPERBLOCK) ? 7 : 6);\n\thantro_reg_write(vpu, &av1_min_cb_size, 3);\n\n\thantro_reg_write(vpu, &av1_comp_pred_fixed_ref, 0);\n\thantro_reg_write(vpu, &av1_comp_pred_var_ref0_av1, 0);\n\thantro_reg_write(vpu, &av1_comp_pred_var_ref1_av1, 0);\n\thantro_reg_write(vpu, &av1_filt_level_seg0, 0);\n\thantro_reg_write(vpu, &av1_filt_level_seg1, 0);\n\thantro_reg_write(vpu, &av1_filt_level_seg2, 0);\n\thantro_reg_write(vpu, &av1_filt_level_seg3, 0);\n\thantro_reg_write(vpu, &av1_filt_level_seg4, 0);\n\thantro_reg_write(vpu, &av1_filt_level_seg5, 0);\n\thantro_reg_write(vpu, &av1_filt_level_seg6, 0);\n\thantro_reg_write(vpu, &av1_filt_level_seg7, 0);\n\n\thantro_reg_write(vpu, &av1_qp_delta_y_dc_av1, ctrls->frame->quantization.delta_q_y_dc);\n\thantro_reg_write(vpu, &av1_qp_delta_ch_dc_av1, ctrls->frame->quantization.delta_q_u_dc);\n\thantro_reg_write(vpu, &av1_qp_delta_ch_ac_av1, ctrls->frame->quantization.delta_q_u_ac);\n\tif (ctrls->frame->quantization.flags & V4L2_AV1_QUANTIZATION_FLAG_USING_QMATRIX) {\n\t\thantro_reg_write(vpu, &av1_qmlevel_y, ctrls->frame->quantization.qm_y);\n\t\thantro_reg_write(vpu, &av1_qmlevel_u, ctrls->frame->quantization.qm_u);\n\t\thantro_reg_write(vpu, &av1_qmlevel_v, ctrls->frame->quantization.qm_v);\n\t} else {\n\t\thantro_reg_write(vpu, &av1_qmlevel_y, 0xff);\n\t\thantro_reg_write(vpu, &av1_qmlevel_u, 0xff);\n\t\thantro_reg_write(vpu, &av1_qmlevel_v, 0xff);\n\t}\n\n\thantro_reg_write(vpu, &av1_lossless_e, rockchip_vpu981_av1_dec_is_lossless(ctx));\n\thantro_reg_write(vpu, &av1_quant_delta_v_dc, ctrls->frame->quantization.delta_q_v_dc);\n\thantro_reg_write(vpu, &av1_quant_delta_v_ac, ctrls->frame->quantization.delta_q_v_ac);\n\n\thantro_reg_write(vpu, &av1_skip_ref0,\n\t\t\t (ctrls->frame->skip_mode_frame[0]) ? ctrls->frame->skip_mode_frame[0] : 1);\n\thantro_reg_write(vpu, &av1_skip_ref1,\n\t\t\t (ctrls->frame->skip_mode_frame[1]) ? ctrls->frame->skip_mode_frame[1] : 1);\n\n\thantro_write_addr(vpu, AV1_MC_SYNC_CURR, av1_dec->tile_buf.dma);\n\thantro_write_addr(vpu, AV1_MC_SYNC_LEFT, av1_dec->tile_buf.dma);\n}\n\nstatic void\nrockchip_vpu981_av1_dec_set_input_buffer(struct hantro_ctx *ctx,\n\t\t\t\t\t struct vb2_v4l2_buffer *vb2_src)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_av1_dec_ctrls *ctrls = &av1_dec->ctrls;\n\tconst struct v4l2_ctrl_av1_tile_group_entry *group_entry =\n\t    ctrls->tile_group_entry;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tdma_addr_t src_dma;\n\tu32 src_len, src_buf_len;\n\tint start_bit, offset;\n\n\tsrc_dma = vb2_dma_contig_plane_dma_addr(&vb2_src->vb2_buf, 0);\n\tsrc_len = vb2_get_plane_payload(&vb2_src->vb2_buf, 0);\n\tsrc_buf_len = vb2_plane_size(&vb2_src->vb2_buf, 0);\n\n\tstart_bit = (group_entry[0].tile_offset & 0xf) * 8;\n\toffset = group_entry[0].tile_offset & ~0xf;\n\n\thantro_reg_write(vpu, &av1_strm_buffer_len, src_buf_len);\n\thantro_reg_write(vpu, &av1_strm_start_bit, start_bit);\n\thantro_reg_write(vpu, &av1_stream_len, src_len);\n\thantro_reg_write(vpu, &av1_strm_start_offset, 0);\n\thantro_write_addr(vpu, AV1_INPUT_STREAM, src_dma + offset);\n}\n\nstatic void\nrockchip_vpu981_av1_dec_set_output_buffer(struct hantro_ctx *ctx)\n{\n\tstruct hantro_av1_dec_hw_ctx *av1_dec = &ctx->av1_dec;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_decoded_buffer *dst;\n\tstruct vb2_v4l2_buffer *vb2_dst;\n\tdma_addr_t luma_addr, chroma_addr, mv_addr = 0;\n\tsize_t cr_offset = rockchip_vpu981_av1_dec_luma_size(ctx);\n\tsize_t mv_offset = rockchip_vpu981_av1_dec_chroma_size(ctx);\n\n\tvb2_dst = av1_dec->frame_refs[av1_dec->current_frame_index].vb2_ref;\n\tdst = vb2_to_hantro_decoded_buf(&vb2_dst->vb2_buf);\n\tluma_addr = hantro_get_dec_buf_addr(ctx, &dst->base.vb.vb2_buf);\n\tchroma_addr = luma_addr + cr_offset;\n\tmv_addr = luma_addr + mv_offset;\n\n\thantro_write_addr(vpu, AV1_TILE_OUT_LU, luma_addr);\n\thantro_write_addr(vpu, AV1_TILE_OUT_CH, chroma_addr);\n\thantro_write_addr(vpu, AV1_TILE_OUT_MV, mv_addr);\n}\n\nint rockchip_vpu981_av1_dec_run(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct vb2_v4l2_buffer *vb2_src;\n\tint ret;\n\n\thantro_start_prepare_run(ctx);\n\n\tret = rockchip_vpu981_av1_dec_prepare_run(ctx);\n\tif (ret)\n\t\tgoto prepare_error;\n\n\tvb2_src = hantro_get_src_buf(ctx);\n\tif (!vb2_src) {\n\t\tret = -EINVAL;\n\t\tgoto prepare_error;\n\t}\n\n\trockchip_vpu981_av1_dec_clean_refs(ctx);\n\trockchip_vpu981_av1_dec_frame_ref(ctx, vb2_src->vb2_buf.timestamp);\n\n\trockchip_vpu981_av1_dec_set_parameters(ctx);\n\trockchip_vpu981_av1_dec_set_global_model(ctx);\n\trockchip_vpu981_av1_dec_set_tile_info(ctx);\n\trockchip_vpu981_av1_dec_set_reference_frames(ctx);\n\trockchip_vpu981_av1_dec_set_segmentation(ctx);\n\trockchip_vpu981_av1_dec_set_loopfilter(ctx);\n\trockchip_vpu981_av1_dec_set_picture_dimensions(ctx);\n\trockchip_vpu981_av1_dec_set_cdef(ctx);\n\trockchip_vpu981_av1_dec_set_lr(ctx);\n\trockchip_vpu981_av1_dec_set_fgs(ctx);\n\trockchip_vpu981_av1_dec_set_prob(ctx);\n\n\thantro_reg_write(vpu, &av1_dec_mode, AV1_DEC_MODE);\n\thantro_reg_write(vpu, &av1_dec_out_ec_byte_word, 0);\n\thantro_reg_write(vpu, &av1_write_mvs_e, 1);\n\thantro_reg_write(vpu, &av1_dec_out_ec_bypass, 1);\n\thantro_reg_write(vpu, &av1_dec_clk_gate_e, 1);\n\n\thantro_reg_write(vpu, &av1_dec_abort_e, 0);\n\thantro_reg_write(vpu, &av1_dec_tile_int_e, 0);\n\n\thantro_reg_write(vpu, &av1_dec_alignment, 64);\n\thantro_reg_write(vpu, &av1_apf_disable, 0);\n\thantro_reg_write(vpu, &av1_apf_threshold, 8);\n\thantro_reg_write(vpu, &av1_dec_buswidth, 2);\n\thantro_reg_write(vpu, &av1_dec_max_burst, 16);\n\thantro_reg_write(vpu, &av1_error_conceal_e, 0);\n\thantro_reg_write(vpu, &av1_axi_rd_ostd_threshold, 64);\n\thantro_reg_write(vpu, &av1_axi_wr_ostd_threshold, 64);\n\n\thantro_reg_write(vpu, &av1_ext_timeout_cycles, 0xfffffff);\n\thantro_reg_write(vpu, &av1_ext_timeout_override_e, 1);\n\thantro_reg_write(vpu, &av1_timeout_cycles, 0xfffffff);\n\thantro_reg_write(vpu, &av1_timeout_override_e, 1);\n\n\trockchip_vpu981_av1_dec_set_output_buffer(ctx);\n\trockchip_vpu981_av1_dec_set_input_buffer(ctx, vb2_src);\n\n\thantro_end_prepare_run(ctx);\n\n\thantro_reg_write(vpu, &av1_dec_e, 1);\n\n\treturn 0;\n\nprepare_error:\n\thantro_end_prepare_run(ctx);\n\thantro_irq_done(vpu, VB2_BUF_STATE_ERROR);\n\treturn ret;\n}\n\nstatic void rockchip_vpu981_postproc_enable(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tint width = ctx->dst_fmt.width;\n\tint height = ctx->dst_fmt.height;\n\tstruct vb2_v4l2_buffer *vb2_dst;\n\tsize_t chroma_offset;\n\tdma_addr_t dst_dma;\n\n\tvb2_dst = hantro_get_dst_buf(ctx);\n\n\tdst_dma = vb2_dma_contig_plane_dma_addr(&vb2_dst->vb2_buf, 0);\n\tchroma_offset = ctx->dst_fmt.plane_fmt[0].bytesperline *\n\t    ctx->dst_fmt.height;\n\n\t \n\thantro_reg_write(vpu, &av1_pp_out_e, 1);\n\thantro_reg_write(vpu, &av1_pp_in_format, 0);\n\thantro_reg_write(vpu, &av1_pp0_dup_hor, 1);\n\thantro_reg_write(vpu, &av1_pp0_dup_ver, 1);\n\n\thantro_reg_write(vpu, &av1_pp_in_height, height / 2);\n\thantro_reg_write(vpu, &av1_pp_in_width, width / 2);\n\thantro_reg_write(vpu, &av1_pp_out_height, height);\n\thantro_reg_write(vpu, &av1_pp_out_width, width);\n\thantro_reg_write(vpu, &av1_pp_out_y_stride,\n\t\t\t ctx->dst_fmt.plane_fmt[0].bytesperline);\n\thantro_reg_write(vpu, &av1_pp_out_c_stride,\n\t\t\t ctx->dst_fmt.plane_fmt[0].bytesperline);\n\tswitch (ctx->dst_fmt.pixelformat) {\n\tcase V4L2_PIX_FMT_P010:\n\t\thantro_reg_write(vpu, &av1_pp_out_format, 1);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_NV12:\n\t\thantro_reg_write(vpu, &av1_pp_out_format, 3);\n\t\tbreak;\n\tdefault:\n\t\thantro_reg_write(vpu, &av1_pp_out_format, 0);\n\t}\n\n\thantro_reg_write(vpu, &av1_ppd_blend_exist, 0);\n\thantro_reg_write(vpu, &av1_ppd_dith_exist, 0);\n\thantro_reg_write(vpu, &av1_ablend_crop_e, 0);\n\thantro_reg_write(vpu, &av1_pp_format_customer1_e, 0);\n\thantro_reg_write(vpu, &av1_pp_crop_exist, 0);\n\thantro_reg_write(vpu, &av1_pp_up_level, 0);\n\thantro_reg_write(vpu, &av1_pp_down_level, 0);\n\thantro_reg_write(vpu, &av1_pp_exist, 0);\n\n\thantro_write_addr(vpu, AV1_PP_OUT_LU, dst_dma);\n\thantro_write_addr(vpu, AV1_PP_OUT_CH, dst_dma + chroma_offset);\n}\n\nstatic void rockchip_vpu981_postproc_disable(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\n\t \n\thantro_reg_write(vpu, &av1_pp_out_e, 0);\n}\n\nconst struct hantro_postproc_ops rockchip_vpu981_postproc_ops = {\n\t.enable = rockchip_vpu981_postproc_enable,\n\t.disable = rockchip_vpu981_postproc_disable,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}