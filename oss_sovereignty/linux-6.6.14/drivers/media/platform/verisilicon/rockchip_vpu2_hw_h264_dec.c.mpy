{
  "module_name": "rockchip_vpu2_hw_h264_dec.c",
  "hash_id": "fd390958b0f8c658588343bd4a2a824ff309d5da9401e980d86f8b3f9b9130de",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/verisilicon/rockchip_vpu2_hw_h264_dec.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/sort.h>\n\n#include <media/v4l2-mem2mem.h>\n\n#include \"hantro_hw.h\"\n#include \"hantro_v4l2.h\"\n\n#define VDPU_SWREG(nr)\t\t\t((nr) * 4)\n\n#define VDPU_REG_DEC_OUT_BASE\t\tVDPU_SWREG(63)\n#define VDPU_REG_RLC_VLC_BASE\t\tVDPU_SWREG(64)\n#define VDPU_REG_QTABLE_BASE\t\tVDPU_SWREG(61)\n#define VDPU_REG_DIR_MV_BASE\t\tVDPU_SWREG(62)\n#define VDPU_REG_REFER_BASE(i)\t\t(VDPU_SWREG(84 + (i)))\n#define VDPU_REG_DEC_E(v)\t\t((v) ? BIT(0) : 0)\n\n#define VDPU_REG_DEC_ADV_PRE_DIS(v)\t((v) ? BIT(11) : 0)\n#define VDPU_REG_DEC_SCMD_DIS(v)\t((v) ? BIT(10) : 0)\n#define VDPU_REG_FILTERING_DIS(v)\t((v) ? BIT(8) : 0)\n#define VDPU_REG_PIC_FIXED_QUANT(v)\t((v) ? BIT(7) : 0)\n#define VDPU_REG_DEC_LATENCY(v)\t\t(((v) << 1) & GENMASK(6, 1))\n\n#define VDPU_REG_INIT_QP(v)\t\t(((v) << 25) & GENMASK(30, 25))\n#define VDPU_REG_STREAM_LEN(v)\t\t(((v) << 0) & GENMASK(23, 0))\n\n#define VDPU_REG_APF_THRESHOLD(v)\t(((v) << 17) & GENMASK(30, 17))\n#define VDPU_REG_STARTMB_X(v)\t\t(((v) << 8) & GENMASK(16, 8))\n#define VDPU_REG_STARTMB_Y(v)\t\t(((v) << 0) & GENMASK(7, 0))\n\n#define VDPU_REG_DEC_MODE(v)\t\t(((v) << 0) & GENMASK(3, 0))\n\n#define VDPU_REG_DEC_STRENDIAN_E(v)\t((v) ? BIT(5) : 0)\n#define VDPU_REG_DEC_STRSWAP32_E(v)\t((v) ? BIT(4) : 0)\n#define VDPU_REG_DEC_OUTSWAP32_E(v)\t((v) ? BIT(3) : 0)\n#define VDPU_REG_DEC_INSWAP32_E(v)\t((v) ? BIT(2) : 0)\n#define VDPU_REG_DEC_OUT_ENDIAN(v)\t((v) ? BIT(1) : 0)\n#define VDPU_REG_DEC_IN_ENDIAN(v)\t((v) ? BIT(0) : 0)\n\n#define VDPU_REG_DEC_DATA_DISC_E(v)\t((v) ? BIT(22) : 0)\n#define VDPU_REG_DEC_MAX_BURST(v)\t(((v) << 16) & GENMASK(20, 16))\n#define VDPU_REG_DEC_AXI_WR_ID(v)\t(((v) << 8) & GENMASK(15, 8))\n#define VDPU_REG_DEC_AXI_RD_ID(v)\t(((v) << 0) & GENMASK(7, 0))\n\n#define VDPU_REG_START_CODE_E(v)\t((v) ? BIT(22) : 0)\n#define VDPU_REG_CH_8PIX_ILEAV_E(v)\t((v) ? BIT(21) : 0)\n#define VDPU_REG_RLC_MODE_E(v)\t\t((v) ? BIT(20) : 0)\n#define VDPU_REG_PIC_INTERLACE_E(v)\t((v) ? BIT(17) : 0)\n#define VDPU_REG_PIC_FIELDMODE_E(v)\t((v) ? BIT(16) : 0)\n#define VDPU_REG_PIC_TOPFIELD_E(v)\t((v) ? BIT(13) : 0)\n#define VDPU_REG_WRITE_MVS_E(v)\t\t((v) ? BIT(10) : 0)\n#define VDPU_REG_SEQ_MBAFF_E(v)\t\t((v) ? BIT(7) : 0)\n#define VDPU_REG_PICORD_COUNT_E(v)\t((v) ? BIT(6) : 0)\n#define VDPU_REG_DEC_TIMEOUT_E(v)\t((v) ? BIT(5) : 0)\n#define VDPU_REG_DEC_CLK_GATE_E(v)\t((v) ? BIT(4) : 0)\n\n#define VDPU_REG_PRED_BC_TAP_0_0(v)\t(((v) << 22) & GENMASK(31, 22))\n#define VDPU_REG_PRED_BC_TAP_0_1(v)\t(((v) << 12) & GENMASK(21, 12))\n#define VDPU_REG_PRED_BC_TAP_0_2(v)\t(((v) << 2) & GENMASK(11, 2))\n\n#define VDPU_REG_REFBU_E(v)\t\t((v) ? BIT(31) : 0)\n\n#define VDPU_REG_PINIT_RLIST_F9(v)\t(((v) << 25) & GENMASK(29, 25))\n#define VDPU_REG_PINIT_RLIST_F8(v)\t(((v) << 20) & GENMASK(24, 20))\n#define VDPU_REG_PINIT_RLIST_F7(v)\t(((v) << 15) & GENMASK(19, 15))\n#define VDPU_REG_PINIT_RLIST_F6(v)\t(((v) << 10) & GENMASK(14, 10))\n#define VDPU_REG_PINIT_RLIST_F5(v)\t(((v) << 5) & GENMASK(9, 5))\n#define VDPU_REG_PINIT_RLIST_F4(v)\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_PINIT_RLIST_F15(v)\t(((v) << 25) & GENMASK(29, 25))\n#define VDPU_REG_PINIT_RLIST_F14(v)\t(((v) << 20) & GENMASK(24, 20))\n#define VDPU_REG_PINIT_RLIST_F13(v)\t(((v) << 15) & GENMASK(19, 15))\n#define VDPU_REG_PINIT_RLIST_F12(v)\t(((v) << 10) & GENMASK(14, 10))\n#define VDPU_REG_PINIT_RLIST_F11(v)\t(((v) << 5) & GENMASK(9, 5))\n#define VDPU_REG_PINIT_RLIST_F10(v)\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_REFER1_NBR(v)\t\t(((v) << 16) & GENMASK(31, 16))\n#define VDPU_REG_REFER0_NBR(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_REFER3_NBR(v)\t\t(((v) << 16) & GENMASK(31, 16))\n#define VDPU_REG_REFER2_NBR(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_REFER5_NBR(v)\t\t(((v) << 16) & GENMASK(31, 16))\n#define VDPU_REG_REFER4_NBR(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_REFER7_NBR(v)\t\t(((v) << 16) & GENMASK(31, 16))\n#define VDPU_REG_REFER6_NBR(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_REFER9_NBR(v)\t\t(((v) << 16) & GENMASK(31, 16))\n#define VDPU_REG_REFER8_NBR(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_REFER11_NBR(v)\t\t(((v) << 16) & GENMASK(31, 16))\n#define VDPU_REG_REFER10_NBR(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_REFER13_NBR(v)\t\t(((v) << 16) & GENMASK(31, 16))\n#define VDPU_REG_REFER12_NBR(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_REFER15_NBR(v)\t\t(((v) << 16) & GENMASK(31, 16))\n#define VDPU_REG_REFER14_NBR(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_BINIT_RLIST_F5(v)\t(((v) << 25) & GENMASK(29, 25))\n#define VDPU_REG_BINIT_RLIST_F4(v)\t(((v) << 20) & GENMASK(24, 20))\n#define VDPU_REG_BINIT_RLIST_F3(v)\t(((v) << 15) & GENMASK(19, 15))\n#define VDPU_REG_BINIT_RLIST_F2(v)\t(((v) << 10) & GENMASK(14, 10))\n#define VDPU_REG_BINIT_RLIST_F1(v)\t(((v) << 5) & GENMASK(9, 5))\n#define VDPU_REG_BINIT_RLIST_F0(v)\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_BINIT_RLIST_F11(v)\t(((v) << 25) & GENMASK(29, 25))\n#define VDPU_REG_BINIT_RLIST_F10(v)\t(((v) << 20) & GENMASK(24, 20))\n#define VDPU_REG_BINIT_RLIST_F9(v)\t(((v) << 15) & GENMASK(19, 15))\n#define VDPU_REG_BINIT_RLIST_F8(v)\t(((v) << 10) & GENMASK(14, 10))\n#define VDPU_REG_BINIT_RLIST_F7(v)\t(((v) << 5) & GENMASK(9, 5))\n#define VDPU_REG_BINIT_RLIST_F6(v)\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_BINIT_RLIST_F15(v)\t(((v) << 15) & GENMASK(19, 15))\n#define VDPU_REG_BINIT_RLIST_F14(v)\t(((v) << 10) & GENMASK(14, 10))\n#define VDPU_REG_BINIT_RLIST_F13(v)\t(((v) << 5) & GENMASK(9, 5))\n#define VDPU_REG_BINIT_RLIST_F12(v)\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_BINIT_RLIST_B5(v)\t(((v) << 25) & GENMASK(29, 25))\n#define VDPU_REG_BINIT_RLIST_B4(v)\t(((v) << 20) & GENMASK(24, 20))\n#define VDPU_REG_BINIT_RLIST_B3(v)\t(((v) << 15) & GENMASK(19, 15))\n#define VDPU_REG_BINIT_RLIST_B2(v)\t(((v) << 10) & GENMASK(14, 10))\n#define VDPU_REG_BINIT_RLIST_B1(v)\t(((v) << 5) & GENMASK(9, 5))\n#define VDPU_REG_BINIT_RLIST_B0(v)\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_BINIT_RLIST_B11(v)\t(((v) << 25) & GENMASK(29, 25))\n#define VDPU_REG_BINIT_RLIST_B10(v)\t(((v) << 20) & GENMASK(24, 20))\n#define VDPU_REG_BINIT_RLIST_B9(v)\t(((v) << 15) & GENMASK(19, 15))\n#define VDPU_REG_BINIT_RLIST_B8(v)\t(((v) << 10) & GENMASK(14, 10))\n#define VDPU_REG_BINIT_RLIST_B7(v)\t(((v) << 5) & GENMASK(9, 5))\n#define VDPU_REG_BINIT_RLIST_B6(v)\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_BINIT_RLIST_B15(v)\t(((v) << 15) & GENMASK(19, 15))\n#define VDPU_REG_BINIT_RLIST_B14(v)\t(((v) << 10) & GENMASK(14, 10))\n#define VDPU_REG_BINIT_RLIST_B13(v)\t(((v) << 5) & GENMASK(9, 5))\n#define VDPU_REG_BINIT_RLIST_B12(v)\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_PINIT_RLIST_F3(v)\t(((v) << 15) & GENMASK(19, 15))\n#define VDPU_REG_PINIT_RLIST_F2(v)\t(((v) << 10) & GENMASK(14, 10))\n#define VDPU_REG_PINIT_RLIST_F1(v)\t(((v) << 5) & GENMASK(9, 5))\n#define VDPU_REG_PINIT_RLIST_F0(v)\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_REFER_LTERM_E(v)\t(((v) << 0) & GENMASK(31, 0))\n\n#define VDPU_REG_REFER_VALID_E(v)\t(((v) << 0) & GENMASK(31, 0))\n\n#define VDPU_REG_STRM_START_BIT(v)\t(((v) << 0) & GENMASK(5, 0))\n\n#define VDPU_REG_CH_QP_OFFSET2(v)\t(((v) << 22) & GENMASK(26, 22))\n#define VDPU_REG_CH_QP_OFFSET(v)\t(((v) << 17) & GENMASK(21, 17))\n#define VDPU_REG_PIC_MB_HEIGHT_P(v)\t(((v) << 9) & GENMASK(16, 9))\n#define VDPU_REG_PIC_MB_WIDTH(v)\t(((v) << 0) & GENMASK(8, 0))\n\n#define VDPU_REG_WEIGHT_BIPR_IDC(v)\t(((v) << 16) & GENMASK(17, 16))\n#define VDPU_REG_REF_FRAMES(v)\t\t(((v) << 0) & GENMASK(4, 0))\n\n#define VDPU_REG_FILT_CTRL_PRES(v)\t((v) ? BIT(31) : 0)\n#define VDPU_REG_RDPIC_CNT_PRES(v)\t((v) ? BIT(30) : 0)\n#define VDPU_REG_FRAMENUM_LEN(v)\t(((v) << 16) & GENMASK(20, 16))\n#define VDPU_REG_FRAMENUM(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_REFPIC_MK_LEN(v)\t(((v) << 16) & GENMASK(26, 16))\n#define VDPU_REG_IDR_PIC_ID(v)\t\t(((v) << 0) & GENMASK(15, 0))\n\n#define VDPU_REG_PPS_ID(v)\t\t(((v) << 24) & GENMASK(31, 24))\n#define VDPU_REG_REFIDX1_ACTIVE(v)\t(((v) << 19) & GENMASK(23, 19))\n#define VDPU_REG_REFIDX0_ACTIVE(v)\t(((v) << 14) & GENMASK(18, 14))\n#define VDPU_REG_POC_LENGTH(v)\t\t(((v) << 0) & GENMASK(7, 0))\n\n#define VDPU_REG_IDR_PIC_E(v)\t\t((v) ? BIT(8) : 0)\n#define VDPU_REG_DIR_8X8_INFER_E(v)\t((v) ? BIT(7) : 0)\n#define VDPU_REG_BLACKWHITE_E(v)\t((v) ? BIT(6) : 0)\n#define VDPU_REG_CABAC_E(v)\t\t((v) ? BIT(5) : 0)\n#define VDPU_REG_WEIGHT_PRED_E(v)\t((v) ? BIT(4) : 0)\n#define VDPU_REG_CONST_INTRA_E(v)\t((v) ? BIT(3) : 0)\n#define VDPU_REG_8X8TRANS_FLAG_E(v)\t((v) ? BIT(2) : 0)\n#define VDPU_REG_TYPE1_QUANT_E(v)\t((v) ? BIT(1) : 0)\n#define VDPU_REG_FIELDPIC_FLAG_E(v)\t((v) ? BIT(0) : 0)\n\nstatic void set_params(struct hantro_ctx *ctx, struct vb2_v4l2_buffer *src_buf)\n{\n\tconst struct hantro_h264_dec_ctrls *ctrls = &ctx->h264_dec.ctrls;\n\tconst struct v4l2_ctrl_h264_decode_params *dec_param = ctrls->decode;\n\tconst struct v4l2_ctrl_h264_sps *sps = ctrls->sps;\n\tconst struct v4l2_ctrl_h264_pps *pps = ctrls->pps;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tu32 reg;\n\n\treg = VDPU_REG_DEC_ADV_PRE_DIS(0) |\n\t      VDPU_REG_DEC_SCMD_DIS(0) |\n\t      VDPU_REG_FILTERING_DIS(0) |\n\t      VDPU_REG_PIC_FIXED_QUANT(0) |\n\t      VDPU_REG_DEC_LATENCY(0);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(50));\n\n\treg = VDPU_REG_INIT_QP(pps->pic_init_qp_minus26 + 26) |\n\t      VDPU_REG_STREAM_LEN(vb2_get_plane_payload(&src_buf->vb2_buf, 0));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(51));\n\n\treg = VDPU_REG_APF_THRESHOLD(8) |\n\t      VDPU_REG_STARTMB_X(0) |\n\t      VDPU_REG_STARTMB_Y(0);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(52));\n\n\treg = VDPU_REG_DEC_MODE(0);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(53));\n\n\treg = VDPU_REG_DEC_STRENDIAN_E(1) |\n\t      VDPU_REG_DEC_STRSWAP32_E(1) |\n\t      VDPU_REG_DEC_OUTSWAP32_E(1) |\n\t      VDPU_REG_DEC_INSWAP32_E(1) |\n\t      VDPU_REG_DEC_OUT_ENDIAN(1) |\n\t      VDPU_REG_DEC_IN_ENDIAN(0);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(54));\n\n\treg = VDPU_REG_DEC_DATA_DISC_E(0) |\n\t      VDPU_REG_DEC_MAX_BURST(16) |\n\t      VDPU_REG_DEC_AXI_WR_ID(0) |\n\t      VDPU_REG_DEC_AXI_RD_ID(0xff);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(56));\n\n\treg = VDPU_REG_START_CODE_E(1) |\n\t      VDPU_REG_CH_8PIX_ILEAV_E(0) |\n\t      VDPU_REG_RLC_MODE_E(0) |\n\t      VDPU_REG_PIC_INTERLACE_E(!(sps->flags & V4L2_H264_SPS_FLAG_FRAME_MBS_ONLY) &&\n\t\t\t\t       (sps->flags & V4L2_H264_SPS_FLAG_MB_ADAPTIVE_FRAME_FIELD ||\n\t\t\t\t\tdec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_FIELD_PIC)) |\n\t      VDPU_REG_PIC_FIELDMODE_E(dec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_FIELD_PIC) |\n\t      VDPU_REG_PIC_TOPFIELD_E(!(dec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_BOTTOM_FIELD)) |\n\t      VDPU_REG_WRITE_MVS_E((sps->profile_idc > 66) && dec_param->nal_ref_idc) |\n\t      VDPU_REG_SEQ_MBAFF_E(sps->flags & V4L2_H264_SPS_FLAG_MB_ADAPTIVE_FRAME_FIELD) |\n\t      VDPU_REG_PICORD_COUNT_E(sps->profile_idc > 66) |\n\t      VDPU_REG_DEC_TIMEOUT_E(1) |\n\t      VDPU_REG_DEC_CLK_GATE_E(1);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(57));\n\n\treg = VDPU_REG_PRED_BC_TAP_0_0(1) |\n\t      VDPU_REG_PRED_BC_TAP_0_1((u32)-5) |\n\t      VDPU_REG_PRED_BC_TAP_0_2(20);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(59));\n\n\treg = VDPU_REG_REFBU_E(0);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(65));\n\n\treg = VDPU_REG_STRM_START_BIT(0);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(109));\n\n\treg = VDPU_REG_CH_QP_OFFSET2(pps->second_chroma_qp_index_offset) |\n\t      VDPU_REG_CH_QP_OFFSET(pps->chroma_qp_index_offset) |\n\t      VDPU_REG_PIC_MB_HEIGHT_P(MB_HEIGHT(ctx->src_fmt.height)) |\n\t      VDPU_REG_PIC_MB_WIDTH(MB_WIDTH(ctx->src_fmt.width));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(110));\n\n\treg = VDPU_REG_WEIGHT_BIPR_IDC(pps->weighted_bipred_idc) |\n\t      VDPU_REG_REF_FRAMES(sps->max_num_ref_frames);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(111));\n\n\treg = VDPU_REG_FILT_CTRL_PRES(pps->flags & V4L2_H264_PPS_FLAG_DEBLOCKING_FILTER_CONTROL_PRESENT) |\n\t      VDPU_REG_RDPIC_CNT_PRES(pps->flags & V4L2_H264_PPS_FLAG_REDUNDANT_PIC_CNT_PRESENT) |\n\t      VDPU_REG_FRAMENUM_LEN(sps->log2_max_frame_num_minus4 + 4) |\n\t      VDPU_REG_FRAMENUM(dec_param->frame_num);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(112));\n\n\treg = VDPU_REG_REFPIC_MK_LEN(dec_param->dec_ref_pic_marking_bit_size) |\n\t      VDPU_REG_IDR_PIC_ID(dec_param->idr_pic_id);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(113));\n\n\treg = VDPU_REG_PPS_ID(pps->pic_parameter_set_id) |\n\t      VDPU_REG_REFIDX1_ACTIVE(pps->num_ref_idx_l1_default_active_minus1 + 1) |\n\t      VDPU_REG_REFIDX0_ACTIVE(pps->num_ref_idx_l0_default_active_minus1 + 1) |\n\t      VDPU_REG_POC_LENGTH(dec_param->pic_order_cnt_bit_size);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(114));\n\n\treg = VDPU_REG_IDR_PIC_E(dec_param->flags & V4L2_H264_DECODE_PARAM_FLAG_IDR_PIC) |\n\t      VDPU_REG_DIR_8X8_INFER_E(sps->flags & V4L2_H264_SPS_FLAG_DIRECT_8X8_INFERENCE) |\n\t      VDPU_REG_BLACKWHITE_E(sps->profile_idc >= 100 && sps->chroma_format_idc == 0) |\n\t      VDPU_REG_CABAC_E(pps->flags & V4L2_H264_PPS_FLAG_ENTROPY_CODING_MODE) |\n\t      VDPU_REG_WEIGHT_PRED_E(pps->flags & V4L2_H264_PPS_FLAG_WEIGHTED_PRED) |\n\t      VDPU_REG_CONST_INTRA_E(pps->flags & V4L2_H264_PPS_FLAG_CONSTRAINED_INTRA_PRED) |\n\t      VDPU_REG_8X8TRANS_FLAG_E(pps->flags & V4L2_H264_PPS_FLAG_TRANSFORM_8X8_MODE) |\n\t      VDPU_REG_TYPE1_QUANT_E(pps->flags & V4L2_H264_PPS_FLAG_SCALING_MATRIX_PRESENT) |\n\t      VDPU_REG_FIELDPIC_FLAG_E(!(sps->flags & V4L2_H264_SPS_FLAG_FRAME_MBS_ONLY));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(115));\n}\n\nstatic void set_ref(struct hantro_ctx *ctx)\n{\n\tconst struct v4l2_h264_reference *b0_reflist, *b1_reflist, *p_reflist;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tu32 reg;\n\tint i;\n\n\tb0_reflist = ctx->h264_dec.reflists.b0;\n\tb1_reflist = ctx->h264_dec.reflists.b1;\n\tp_reflist = ctx->h264_dec.reflists.p;\n\n\treg = VDPU_REG_PINIT_RLIST_F9(p_reflist[9].index) |\n\t      VDPU_REG_PINIT_RLIST_F8(p_reflist[8].index) |\n\t      VDPU_REG_PINIT_RLIST_F7(p_reflist[7].index) |\n\t      VDPU_REG_PINIT_RLIST_F6(p_reflist[6].index) |\n\t      VDPU_REG_PINIT_RLIST_F5(p_reflist[5].index) |\n\t      VDPU_REG_PINIT_RLIST_F4(p_reflist[4].index);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(74));\n\n\treg = VDPU_REG_PINIT_RLIST_F15(p_reflist[15].index) |\n\t      VDPU_REG_PINIT_RLIST_F14(p_reflist[14].index) |\n\t      VDPU_REG_PINIT_RLIST_F13(p_reflist[13].index) |\n\t      VDPU_REG_PINIT_RLIST_F12(p_reflist[12].index) |\n\t      VDPU_REG_PINIT_RLIST_F11(p_reflist[11].index) |\n\t      VDPU_REG_PINIT_RLIST_F10(p_reflist[10].index);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(75));\n\n\treg = VDPU_REG_REFER1_NBR(hantro_h264_get_ref_nbr(ctx, 1)) |\n\t      VDPU_REG_REFER0_NBR(hantro_h264_get_ref_nbr(ctx, 0));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(76));\n\n\treg = VDPU_REG_REFER3_NBR(hantro_h264_get_ref_nbr(ctx, 3)) |\n\t      VDPU_REG_REFER2_NBR(hantro_h264_get_ref_nbr(ctx, 2));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(77));\n\n\treg = VDPU_REG_REFER5_NBR(hantro_h264_get_ref_nbr(ctx, 5)) |\n\t      VDPU_REG_REFER4_NBR(hantro_h264_get_ref_nbr(ctx, 4));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(78));\n\n\treg = VDPU_REG_REFER7_NBR(hantro_h264_get_ref_nbr(ctx, 7)) |\n\t      VDPU_REG_REFER6_NBR(hantro_h264_get_ref_nbr(ctx, 6));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(79));\n\n\treg = VDPU_REG_REFER9_NBR(hantro_h264_get_ref_nbr(ctx, 9)) |\n\t      VDPU_REG_REFER8_NBR(hantro_h264_get_ref_nbr(ctx, 8));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(80));\n\n\treg = VDPU_REG_REFER11_NBR(hantro_h264_get_ref_nbr(ctx, 11)) |\n\t      VDPU_REG_REFER10_NBR(hantro_h264_get_ref_nbr(ctx, 10));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(81));\n\n\treg = VDPU_REG_REFER13_NBR(hantro_h264_get_ref_nbr(ctx, 13)) |\n\t      VDPU_REG_REFER12_NBR(hantro_h264_get_ref_nbr(ctx, 12));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(82));\n\n\treg = VDPU_REG_REFER15_NBR(hantro_h264_get_ref_nbr(ctx, 15)) |\n\t      VDPU_REG_REFER14_NBR(hantro_h264_get_ref_nbr(ctx, 14));\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(83));\n\n\treg = VDPU_REG_BINIT_RLIST_F5(b0_reflist[5].index) |\n\t      VDPU_REG_BINIT_RLIST_F4(b0_reflist[4].index) |\n\t      VDPU_REG_BINIT_RLIST_F3(b0_reflist[3].index) |\n\t      VDPU_REG_BINIT_RLIST_F2(b0_reflist[2].index) |\n\t      VDPU_REG_BINIT_RLIST_F1(b0_reflist[1].index) |\n\t      VDPU_REG_BINIT_RLIST_F0(b0_reflist[0].index);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(100));\n\n\treg = VDPU_REG_BINIT_RLIST_F11(b0_reflist[11].index) |\n\t      VDPU_REG_BINIT_RLIST_F10(b0_reflist[10].index) |\n\t      VDPU_REG_BINIT_RLIST_F9(b0_reflist[9].index) |\n\t      VDPU_REG_BINIT_RLIST_F8(b0_reflist[8].index) |\n\t      VDPU_REG_BINIT_RLIST_F7(b0_reflist[7].index) |\n\t      VDPU_REG_BINIT_RLIST_F6(b0_reflist[6].index);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(101));\n\n\treg = VDPU_REG_BINIT_RLIST_F15(b0_reflist[15].index) |\n\t      VDPU_REG_BINIT_RLIST_F14(b0_reflist[14].index) |\n\t      VDPU_REG_BINIT_RLIST_F13(b0_reflist[13].index) |\n\t      VDPU_REG_BINIT_RLIST_F12(b0_reflist[12].index);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(102));\n\n\treg = VDPU_REG_BINIT_RLIST_B5(b1_reflist[5].index) |\n\t      VDPU_REG_BINIT_RLIST_B4(b1_reflist[4].index) |\n\t      VDPU_REG_BINIT_RLIST_B3(b1_reflist[3].index) |\n\t      VDPU_REG_BINIT_RLIST_B2(b1_reflist[2].index) |\n\t      VDPU_REG_BINIT_RLIST_B1(b1_reflist[1].index) |\n\t      VDPU_REG_BINIT_RLIST_B0(b1_reflist[0].index);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(103));\n\n\treg = VDPU_REG_BINIT_RLIST_B11(b1_reflist[11].index) |\n\t      VDPU_REG_BINIT_RLIST_B10(b1_reflist[10].index) |\n\t      VDPU_REG_BINIT_RLIST_B9(b1_reflist[9].index) |\n\t      VDPU_REG_BINIT_RLIST_B8(b1_reflist[8].index) |\n\t      VDPU_REG_BINIT_RLIST_B7(b1_reflist[7].index) |\n\t      VDPU_REG_BINIT_RLIST_B6(b1_reflist[6].index);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(104));\n\n\treg = VDPU_REG_BINIT_RLIST_B15(b1_reflist[15].index) |\n\t      VDPU_REG_BINIT_RLIST_B14(b1_reflist[14].index) |\n\t      VDPU_REG_BINIT_RLIST_B13(b1_reflist[13].index) |\n\t      VDPU_REG_BINIT_RLIST_B12(b1_reflist[12].index);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(105));\n\n\treg = VDPU_REG_PINIT_RLIST_F3(p_reflist[3].index) |\n\t      VDPU_REG_PINIT_RLIST_F2(p_reflist[2].index) |\n\t      VDPU_REG_PINIT_RLIST_F1(p_reflist[1].index) |\n\t      VDPU_REG_PINIT_RLIST_F0(p_reflist[0].index);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(106));\n\n\treg = VDPU_REG_REFER_LTERM_E(ctx->h264_dec.dpb_longterm);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(107));\n\n\treg = VDPU_REG_REFER_VALID_E(ctx->h264_dec.dpb_valid);\n\tvdpu_write_relaxed(vpu, reg, VDPU_SWREG(108));\n\n\t \n\tfor (i = 0; i < HANTRO_H264_DPB_SIZE; i++) {\n\t\tdma_addr_t dma_addr = hantro_h264_get_ref_buf(ctx, i);\n\n\t\tvdpu_write_relaxed(vpu, dma_addr, VDPU_REG_REFER_BASE(i));\n\t}\n}\n\nstatic void set_buffers(struct hantro_ctx *ctx, struct vb2_v4l2_buffer *src_buf)\n{\n\tconst struct hantro_h264_dec_ctrls *ctrls = &ctx->h264_dec.ctrls;\n\tstruct vb2_v4l2_buffer *dst_buf;\n\tstruct hantro_dev *vpu = ctx->dev;\n\tdma_addr_t src_dma, dst_dma;\n\tsize_t offset = 0;\n\n\t \n\tsrc_dma = vb2_dma_contig_plane_dma_addr(&src_buf->vb2_buf, 0);\n\tvdpu_write_relaxed(vpu, src_dma, VDPU_REG_RLC_VLC_BASE);\n\n\t \n\tdst_buf = hantro_get_dst_buf(ctx);\n\tdst_dma = hantro_get_dec_buf_addr(ctx, &dst_buf->vb2_buf);\n\t \n\tif (ctrls->decode->flags & V4L2_H264_DECODE_PARAM_FLAG_BOTTOM_FIELD)\n\t\toffset = ALIGN(ctx->src_fmt.width, MB_DIM);\n\tvdpu_write_relaxed(vpu, dst_dma + offset, VDPU_REG_DEC_OUT_BASE);\n\n\t \n\tif (ctrls->sps->profile_idc > 66 && ctrls->decode->nal_ref_idc) {\n\t\tunsigned int bytes_per_mb = 384;\n\n\t\t \n\t\tif (ctrls->sps->profile_idc >= 100 &&\n\t\t    ctrls->sps->chroma_format_idc == 0)\n\t\t\tbytes_per_mb = 256;\n\t\toffset = bytes_per_mb * MB_WIDTH(ctx->src_fmt.width) *\n\t\t\t MB_HEIGHT(ctx->src_fmt.height);\n\n\t\t \n\t\tif (ctrls->decode->flags & V4L2_H264_DECODE_PARAM_FLAG_BOTTOM_FIELD)\n\t\t\toffset += 32 * MB_WIDTH(ctx->src_fmt.width) *\n\t\t\t\t  MB_HEIGHT(ctx->src_fmt.height);\n\t\tvdpu_write_relaxed(vpu, dst_dma + offset, VDPU_REG_DIR_MV_BASE);\n\t}\n\n\t \n\tvdpu_write_relaxed(vpu, ctx->h264_dec.priv.dma, VDPU_REG_QTABLE_BASE);\n}\n\nint rockchip_vpu2_h264_dec_run(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct vb2_v4l2_buffer *src_buf;\n\tu32 reg;\n\tint ret;\n\n\t \n\tret = hantro_h264_dec_prepare_run(ctx);\n\tif (ret)\n\t\treturn ret;\n\n\tsrc_buf = hantro_get_src_buf(ctx);\n\tset_params(ctx, src_buf);\n\tset_ref(ctx);\n\tset_buffers(ctx, src_buf);\n\n\thantro_end_prepare_run(ctx);\n\n\t \n\treg = vdpu_read(vpu, VDPU_SWREG(57)) | VDPU_REG_DEC_E(1);\n\tvdpu_write(vpu, reg, VDPU_SWREG(57));\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}