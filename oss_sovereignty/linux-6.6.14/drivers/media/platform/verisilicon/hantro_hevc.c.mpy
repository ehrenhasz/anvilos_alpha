{
  "module_name": "hantro_hevc.c",
  "hash_id": "cda24fce59d5142a1b4a6302c32d8c26048544c655da780da0c98613d871451e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/verisilicon/hantro_hevc.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <media/v4l2-mem2mem.h>\n\n#include \"hantro.h\"\n#include \"hantro_hw.h\"\n\n#define VERT_FILTER_RAM_SIZE 8  \n \n#define BSD_CTRL_RAM_SIZE 4  \n \n#define VERT_SAO_RAM_SIZE 48  \n\n#define SCALING_LIST_SIZE (16 * 64)\n\n#define MAX_TILE_COLS 20\n#define MAX_TILE_ROWS 22\n\nvoid hantro_hevc_ref_init(struct hantro_ctx *ctx)\n{\n\tstruct hantro_hevc_dec_hw_ctx *hevc_dec = &ctx->hevc_dec;\n\n\thevc_dec->ref_bufs_used = 0;\n}\n\ndma_addr_t hantro_hevc_get_ref_buf(struct hantro_ctx *ctx,\n\t\t\t\t   s32 poc)\n{\n\tstruct hantro_hevc_dec_hw_ctx *hevc_dec = &ctx->hevc_dec;\n\tint i;\n\n\t \n\tfor (i = 0;  i < NUM_REF_PICTURES; i++) {\n\t\tif (hevc_dec->ref_bufs_poc[i] == poc) {\n\t\t\thevc_dec->ref_bufs_used |= 1 << i;\n\t\t\treturn hevc_dec->ref_bufs[i].dma;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint hantro_hevc_add_ref_buf(struct hantro_ctx *ctx, int poc, dma_addr_t addr)\n{\n\tstruct hantro_hevc_dec_hw_ctx *hevc_dec = &ctx->hevc_dec;\n\tint i;\n\n\t \n\tfor (i = 0; i < NUM_REF_PICTURES; i++) {\n\t\tif (!(hevc_dec->ref_bufs_used & 1 << i)) {\n\t\t\thevc_dec->ref_bufs_used |= 1 << i;\n\t\t\thevc_dec->ref_bufs_poc[i] = poc;\n\t\t\thevc_dec->ref_bufs[i].dma = addr;\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int tile_buffer_reallocate(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_hevc_dec_hw_ctx *hevc_dec = &ctx->hevc_dec;\n\tconst struct hantro_hevc_dec_ctrls *ctrls = &ctx->hevc_dec.ctrls;\n\tconst struct v4l2_ctrl_hevc_pps *pps = ctrls->pps;\n\tconst struct v4l2_ctrl_hevc_sps *sps = ctrls->sps;\n\tunsigned int num_tile_cols = pps->num_tile_columns_minus1 + 1;\n\tunsigned int height64 = (sps->pic_height_in_luma_samples + 63) & ~63;\n\tunsigned int size;\n\n\tif (num_tile_cols <= 1 ||\n\t    num_tile_cols <= hevc_dec->num_tile_cols_allocated)\n\t\treturn 0;\n\n\t \n\tif (hevc_dec->tile_filter.cpu) {\n\t\tdma_free_coherent(vpu->dev, hevc_dec->tile_filter.size,\n\t\t\t\t  hevc_dec->tile_filter.cpu,\n\t\t\t\t  hevc_dec->tile_filter.dma);\n\t\thevc_dec->tile_filter.cpu = NULL;\n\t}\n\n\tif (hevc_dec->tile_sao.cpu) {\n\t\tdma_free_coherent(vpu->dev, hevc_dec->tile_sao.size,\n\t\t\t\t  hevc_dec->tile_sao.cpu,\n\t\t\t\t  hevc_dec->tile_sao.dma);\n\t\thevc_dec->tile_sao.cpu = NULL;\n\t}\n\n\tif (hevc_dec->tile_bsd.cpu) {\n\t\tdma_free_coherent(vpu->dev, hevc_dec->tile_bsd.size,\n\t\t\t\t  hevc_dec->tile_bsd.cpu,\n\t\t\t\t  hevc_dec->tile_bsd.dma);\n\t\thevc_dec->tile_bsd.cpu = NULL;\n\t}\n\n\tsize = (VERT_FILTER_RAM_SIZE * height64 * (num_tile_cols - 1) * ctx->bit_depth) / 8;\n\thevc_dec->tile_filter.cpu = dma_alloc_coherent(vpu->dev, size,\n\t\t\t\t\t\t       &hevc_dec->tile_filter.dma,\n\t\t\t\t\t\t       GFP_KERNEL);\n\tif (!hevc_dec->tile_filter.cpu)\n\t\treturn -ENOMEM;\n\thevc_dec->tile_filter.size = size;\n\n\tsize = (VERT_SAO_RAM_SIZE * height64 * (num_tile_cols - 1) * ctx->bit_depth) / 8;\n\thevc_dec->tile_sao.cpu = dma_alloc_coherent(vpu->dev, size,\n\t\t\t\t\t\t    &hevc_dec->tile_sao.dma,\n\t\t\t\t\t\t    GFP_KERNEL);\n\tif (!hevc_dec->tile_sao.cpu)\n\t\tgoto err_free_tile_buffers;\n\thevc_dec->tile_sao.size = size;\n\n\tsize = BSD_CTRL_RAM_SIZE * height64 * (num_tile_cols - 1);\n\thevc_dec->tile_bsd.cpu = dma_alloc_coherent(vpu->dev, size,\n\t\t\t\t\t\t    &hevc_dec->tile_bsd.dma,\n\t\t\t\t\t\t    GFP_KERNEL);\n\tif (!hevc_dec->tile_bsd.cpu)\n\t\tgoto err_free_sao_buffers;\n\thevc_dec->tile_bsd.size = size;\n\n\thevc_dec->num_tile_cols_allocated = num_tile_cols;\n\n\treturn 0;\n\nerr_free_sao_buffers:\n\tif (hevc_dec->tile_sao.cpu)\n\t\tdma_free_coherent(vpu->dev, hevc_dec->tile_sao.size,\n\t\t\t\t  hevc_dec->tile_sao.cpu,\n\t\t\t\t  hevc_dec->tile_sao.dma);\n\thevc_dec->tile_sao.cpu = NULL;\n\nerr_free_tile_buffers:\n\tif (hevc_dec->tile_filter.cpu)\n\t\tdma_free_coherent(vpu->dev, hevc_dec->tile_filter.size,\n\t\t\t\t  hevc_dec->tile_filter.cpu,\n\t\t\t\t  hevc_dec->tile_filter.dma);\n\thevc_dec->tile_filter.cpu = NULL;\n\n\treturn -ENOMEM;\n}\n\nstatic int hantro_hevc_validate_sps(struct hantro_ctx *ctx, const struct v4l2_ctrl_hevc_sps *sps)\n{\n\t \n\tif (ctx->vpu_dst_fmt->fourcc == V4L2_PIX_FMT_NV12_4L4) {\n\t\tif (ctx->dst_fmt.width !=\n\t\t    ALIGN(sps->pic_width_in_luma_samples, ctx->vpu_dst_fmt->frmsize.step_width))\n\t\t\treturn -EINVAL;\n\n\t\tif (ctx->dst_fmt.height !=\n\t\t    ALIGN(sps->pic_height_in_luma_samples, ctx->vpu_dst_fmt->frmsize.step_height))\n\t\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nint hantro_hevc_dec_prepare_run(struct hantro_ctx *ctx)\n{\n\tstruct hantro_hevc_dec_hw_ctx *hevc_ctx = &ctx->hevc_dec;\n\tstruct hantro_hevc_dec_ctrls *ctrls = &hevc_ctx->ctrls;\n\tint ret;\n\n\thantro_start_prepare_run(ctx);\n\n\tctrls->decode_params =\n\t\thantro_get_ctrl(ctx, V4L2_CID_STATELESS_HEVC_DECODE_PARAMS);\n\tif (WARN_ON(!ctrls->decode_params))\n\t\treturn -EINVAL;\n\n\tctrls->scaling =\n\t\thantro_get_ctrl(ctx, V4L2_CID_STATELESS_HEVC_SCALING_MATRIX);\n\tif (WARN_ON(!ctrls->scaling))\n\t\treturn -EINVAL;\n\n\tctrls->sps =\n\t\thantro_get_ctrl(ctx, V4L2_CID_STATELESS_HEVC_SPS);\n\tif (WARN_ON(!ctrls->sps))\n\t\treturn -EINVAL;\n\n\tret = hantro_hevc_validate_sps(ctx, ctrls->sps);\n\tif (ret)\n\t\treturn ret;\n\n\tctrls->pps =\n\t\thantro_get_ctrl(ctx, V4L2_CID_STATELESS_HEVC_PPS);\n\tif (WARN_ON(!ctrls->pps))\n\t\treturn -EINVAL;\n\n\tret = tile_buffer_reallocate(ctx);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nvoid hantro_hevc_dec_exit(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_hevc_dec_hw_ctx *hevc_dec = &ctx->hevc_dec;\n\n\tif (hevc_dec->tile_sizes.cpu)\n\t\tdma_free_coherent(vpu->dev, hevc_dec->tile_sizes.size,\n\t\t\t\t  hevc_dec->tile_sizes.cpu,\n\t\t\t\t  hevc_dec->tile_sizes.dma);\n\thevc_dec->tile_sizes.cpu = NULL;\n\n\tif (hevc_dec->scaling_lists.cpu)\n\t\tdma_free_coherent(vpu->dev, hevc_dec->scaling_lists.size,\n\t\t\t\t  hevc_dec->scaling_lists.cpu,\n\t\t\t\t  hevc_dec->scaling_lists.dma);\n\thevc_dec->scaling_lists.cpu = NULL;\n\n\tif (hevc_dec->tile_filter.cpu)\n\t\tdma_free_coherent(vpu->dev, hevc_dec->tile_filter.size,\n\t\t\t\t  hevc_dec->tile_filter.cpu,\n\t\t\t\t  hevc_dec->tile_filter.dma);\n\thevc_dec->tile_filter.cpu = NULL;\n\n\tif (hevc_dec->tile_sao.cpu)\n\t\tdma_free_coherent(vpu->dev, hevc_dec->tile_sao.size,\n\t\t\t\t  hevc_dec->tile_sao.cpu,\n\t\t\t\t  hevc_dec->tile_sao.dma);\n\thevc_dec->tile_sao.cpu = NULL;\n\n\tif (hevc_dec->tile_bsd.cpu)\n\t\tdma_free_coherent(vpu->dev, hevc_dec->tile_bsd.size,\n\t\t\t\t  hevc_dec->tile_bsd.cpu,\n\t\t\t\t  hevc_dec->tile_bsd.dma);\n\thevc_dec->tile_bsd.cpu = NULL;\n}\n\nint hantro_hevc_dec_init(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct hantro_hevc_dec_hw_ctx *hevc_dec = &ctx->hevc_dec;\n\tunsigned int size;\n\n\tmemset(hevc_dec, 0, sizeof(*hevc_dec));\n\n\t \n\tsize = round_up(MAX_TILE_COLS * MAX_TILE_ROWS * 4 * sizeof(u16) + 16, 16);\n\thevc_dec->tile_sizes.cpu = dma_alloc_coherent(vpu->dev, size,\n\t\t\t\t\t\t      &hevc_dec->tile_sizes.dma,\n\t\t\t\t\t\t      GFP_KERNEL);\n\tif (!hevc_dec->tile_sizes.cpu)\n\t\treturn -ENOMEM;\n\n\thevc_dec->tile_sizes.size = size;\n\n\thevc_dec->scaling_lists.cpu = dma_alloc_coherent(vpu->dev, SCALING_LIST_SIZE,\n\t\t\t\t\t\t\t &hevc_dec->scaling_lists.dma,\n\t\t\t\t\t\t\t GFP_KERNEL);\n\tif (!hevc_dec->scaling_lists.cpu)\n\t\treturn -ENOMEM;\n\n\thevc_dec->scaling_lists.size = SCALING_LIST_SIZE;\n\n\thantro_hevc_ref_init(ctx);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}