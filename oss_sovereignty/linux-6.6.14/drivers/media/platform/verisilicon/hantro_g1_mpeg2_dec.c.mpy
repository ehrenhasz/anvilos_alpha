{
  "module_name": "hantro_g1_mpeg2_dec.c",
  "hash_id": "3cd594fe6861ff6ba7ea8d29e1e9fd3076eec4f990803a225f961d88bf010094",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/verisilicon/hantro_g1_mpeg2_dec.c",
  "human_readable_source": "\n \n\n#include <asm/unaligned.h>\n#include <linux/bitfield.h>\n#include <media/v4l2-mem2mem.h>\n#include \"hantro.h\"\n#include \"hantro_hw.h\"\n#include \"hantro_g1_regs.h\"\n\n#define G1_SWREG(nr)\t\t\t((nr) * 4)\n\n#define G1_REG_RLC_VLC_BASE\t\tG1_SWREG(12)\n#define G1_REG_DEC_OUT_BASE\t\tG1_SWREG(13)\n#define G1_REG_REFER0_BASE\t\tG1_SWREG(14)\n#define G1_REG_REFER1_BASE\t\tG1_SWREG(15)\n#define G1_REG_REFER2_BASE\t\tG1_SWREG(16)\n#define G1_REG_REFER3_BASE\t\tG1_SWREG(17)\n#define G1_REG_QTABLE_BASE\t\tG1_SWREG(40)\n\n#define G1_REG_DEC_AXI_RD_ID(v)\t\t(((v) << 24) & GENMASK(31, 24))\n#define G1_REG_DEC_TIMEOUT_E(v)\t\t((v) ? BIT(23) : 0)\n#define G1_REG_DEC_STRSWAP32_E(v)\t((v) ? BIT(22) : 0)\n#define G1_REG_DEC_STRENDIAN_E(v)\t((v) ? BIT(21) : 0)\n#define G1_REG_DEC_INSWAP32_E(v)\t((v) ? BIT(20) : 0)\n#define G1_REG_DEC_OUTSWAP32_E(v)\t((v) ? BIT(19) : 0)\n#define G1_REG_DEC_DATA_DISC_E(v)\t((v) ? BIT(18) : 0)\n#define G1_REG_DEC_LATENCY(v)\t\t(((v) << 11) & GENMASK(16, 11))\n#define G1_REG_DEC_CLK_GATE_E(v)\t((v) ? BIT(10) : 0)\n#define G1_REG_DEC_IN_ENDIAN(v)\t\t((v) ? BIT(9) : 0)\n#define G1_REG_DEC_OUT_ENDIAN(v)\t((v) ? BIT(8) : 0)\n#define G1_REG_DEC_ADV_PRE_DIS(v)\t((v) ? BIT(6) : 0)\n#define G1_REG_DEC_SCMD_DIS(v)\t\t((v) ? BIT(5) : 0)\n#define G1_REG_DEC_MAX_BURST(v)\t\t(((v) << 0) & GENMASK(4, 0))\n\n#define G1_REG_DEC_MODE(v)\t\t(((v) << 28) & GENMASK(31, 28))\n#define G1_REG_RLC_MODE_E(v)\t\t((v) ? BIT(27) : 0)\n#define G1_REG_PIC_INTERLACE_E(v)\t((v) ? BIT(23) : 0)\n#define G1_REG_PIC_FIELDMODE_E(v)\t((v) ? BIT(22) : 0)\n#define G1_REG_PIC_B_E(v)\t\t((v) ? BIT(21) : 0)\n#define G1_REG_PIC_INTER_E(v)\t\t((v) ? BIT(20) : 0)\n#define G1_REG_PIC_TOPFIELD_E(v)\t((v) ? BIT(19) : 0)\n#define G1_REG_FWD_INTERLACE_E(v)\t((v) ? BIT(18) : 0)\n#define G1_REG_FILTERING_DIS(v)\t\t((v) ? BIT(14) : 0)\n#define G1_REG_WRITE_MVS_E(v)\t\t((v) ? BIT(12) : 0)\n#define G1_REG_DEC_AXI_WR_ID(v)\t\t(((v) << 0) & GENMASK(7, 0))\n\n#define G1_REG_PIC_MB_WIDTH(v)\t\t(((v) << 23) & GENMASK(31, 23))\n#define G1_REG_PIC_MB_HEIGHT_P(v)\t(((v) << 11) & GENMASK(18, 11))\n#define G1_REG_ALT_SCAN_E(v)\t\t((v) ? BIT(6) : 0)\n#define G1_REG_TOPFIELDFIRST_E(v)\t((v) ? BIT(5) : 0)\n\n#define G1_REG_STRM_START_BIT(v)\t(((v) << 26) & GENMASK(31, 26))\n#define G1_REG_QSCALE_TYPE(v)\t\t((v) ? BIT(24) : 0)\n#define G1_REG_CON_MV_E(v)\t\t((v) ? BIT(4) : 0)\n#define G1_REG_INTRA_DC_PREC(v)\t\t(((v) << 2) & GENMASK(3, 2))\n#define G1_REG_INTRA_VLC_TAB(v)\t\t((v) ? BIT(1) : 0)\n#define G1_REG_FRAME_PRED_DCT(v)\t((v) ? BIT(0) : 0)\n\n#define G1_REG_INIT_QP(v)\t\t(((v) << 25) & GENMASK(30, 25))\n#define G1_REG_STREAM_LEN(v)\t\t(((v) << 0) & GENMASK(23, 0))\n\n#define G1_REG_ALT_SCAN_FLAG_E(v)\t((v) ? BIT(19) : 0)\n#define G1_REG_FCODE_FWD_HOR(v)\t\t(((v) << 15) & GENMASK(18, 15))\n#define G1_REG_FCODE_FWD_VER(v)\t\t(((v) << 11) & GENMASK(14, 11))\n#define G1_REG_FCODE_BWD_HOR(v)\t\t(((v) << 7) & GENMASK(10, 7))\n#define G1_REG_FCODE_BWD_VER(v)\t\t(((v) << 3) & GENMASK(6, 3))\n#define G1_REG_MV_ACCURACY_FWD(v)\t((v) ? BIT(2) : 0)\n#define G1_REG_MV_ACCURACY_BWD(v)\t((v) ? BIT(1) : 0)\n\n#define G1_REG_STARTMB_X(v)\t\t(((v) << 23) & GENMASK(31, 23))\n#define G1_REG_STARTMB_Y(v)\t\t(((v) << 15) & GENMASK(22, 15))\n\n#define G1_REG_APF_THRESHOLD(v)\t\t(((v) << 0) & GENMASK(13, 0))\n\nstatic void\nhantro_g1_mpeg2_dec_set_quantisation(struct hantro_dev *vpu,\n\t\t\t\t     struct hantro_ctx *ctx)\n{\n\tstruct v4l2_ctrl_mpeg2_quantisation *q;\n\n\tq = hantro_get_ctrl(ctx, V4L2_CID_STATELESS_MPEG2_QUANTISATION);\n\thantro_mpeg2_dec_copy_qtable(ctx->mpeg2_dec.qtable.cpu, q);\n\tvdpu_write_relaxed(vpu, ctx->mpeg2_dec.qtable.dma, G1_REG_QTABLE_BASE);\n}\n\nstatic void\nhantro_g1_mpeg2_dec_set_buffers(struct hantro_dev *vpu, struct hantro_ctx *ctx,\n\t\t\t\tstruct vb2_buffer *src_buf,\n\t\t\t\tstruct vb2_buffer *dst_buf,\n\t\t\t\tconst struct v4l2_ctrl_mpeg2_sequence *seq,\n\t\t\t\tconst struct v4l2_ctrl_mpeg2_picture *pic)\n{\n\tdma_addr_t forward_addr = 0, backward_addr = 0;\n\tdma_addr_t current_addr, addr;\n\n\tswitch (pic->picture_coding_type) {\n\tcase V4L2_MPEG2_PIC_CODING_TYPE_B:\n\t\tbackward_addr = hantro_get_ref(ctx, pic->backward_ref_ts);\n\t\tfallthrough;\n\tcase V4L2_MPEG2_PIC_CODING_TYPE_P:\n\t\tforward_addr = hantro_get_ref(ctx, pic->forward_ref_ts);\n\t}\n\n\t \n\taddr = vb2_dma_contig_plane_dma_addr(src_buf, 0);\n\tvdpu_write_relaxed(vpu, addr, G1_REG_RLC_VLC_BASE);\n\n\t \n\taddr = hantro_get_dec_buf_addr(ctx, dst_buf);\n\tcurrent_addr = addr;\n\n\tif (pic->picture_structure == V4L2_MPEG2_PIC_BOTTOM_FIELD)\n\t\taddr += ALIGN(ctx->dst_fmt.width, 16);\n\tvdpu_write_relaxed(vpu, addr, G1_REG_DEC_OUT_BASE);\n\n\tif (!forward_addr)\n\t\tforward_addr = current_addr;\n\tif (!backward_addr)\n\t\tbackward_addr = current_addr;\n\n\t \n\tif (pic->picture_structure == V4L2_MPEG2_PIC_FRAME ||\n\t    pic->picture_coding_type == V4L2_MPEG2_PIC_CODING_TYPE_B ||\n\t    (pic->picture_structure == V4L2_MPEG2_PIC_TOP_FIELD &&\n\t     pic->flags & V4L2_MPEG2_PIC_FLAG_TOP_FIELD_FIRST) ||\n\t    (pic->picture_structure == V4L2_MPEG2_PIC_BOTTOM_FIELD &&\n\t     !(pic->flags & V4L2_MPEG2_PIC_FLAG_TOP_FIELD_FIRST))) {\n\t\tvdpu_write_relaxed(vpu, forward_addr, G1_REG_REFER0_BASE);\n\t\tvdpu_write_relaxed(vpu, forward_addr, G1_REG_REFER1_BASE);\n\t} else if (pic->picture_structure == V4L2_MPEG2_PIC_TOP_FIELD) {\n\t\tvdpu_write_relaxed(vpu, forward_addr, G1_REG_REFER0_BASE);\n\t\tvdpu_write_relaxed(vpu, current_addr, G1_REG_REFER1_BASE);\n\t} else if (pic->picture_structure == V4L2_MPEG2_PIC_BOTTOM_FIELD) {\n\t\tvdpu_write_relaxed(vpu, current_addr, G1_REG_REFER0_BASE);\n\t\tvdpu_write_relaxed(vpu, forward_addr, G1_REG_REFER1_BASE);\n\t}\n\n\t \n\tvdpu_write_relaxed(vpu, backward_addr, G1_REG_REFER2_BASE);\n\tvdpu_write_relaxed(vpu, backward_addr, G1_REG_REFER3_BASE);\n}\n\nint hantro_g1_mpeg2_dec_run(struct hantro_ctx *ctx)\n{\n\tstruct hantro_dev *vpu = ctx->dev;\n\tstruct vb2_v4l2_buffer *src_buf, *dst_buf;\n\tconst struct v4l2_ctrl_mpeg2_sequence *seq;\n\tconst struct v4l2_ctrl_mpeg2_picture *pic;\n\tu32 reg;\n\n\tsrc_buf = hantro_get_src_buf(ctx);\n\tdst_buf = hantro_get_dst_buf(ctx);\n\n\t \n\thantro_start_prepare_run(ctx);\n\n\tseq = hantro_get_ctrl(ctx,\n\t\t\t      V4L2_CID_STATELESS_MPEG2_SEQUENCE);\n\tpic = hantro_get_ctrl(ctx,\n\t\t\t      V4L2_CID_STATELESS_MPEG2_PICTURE);\n\n\treg = G1_REG_DEC_AXI_RD_ID(0) |\n\t      G1_REG_DEC_TIMEOUT_E(1) |\n\t      G1_REG_DEC_STRSWAP32_E(1) |\n\t      G1_REG_DEC_STRENDIAN_E(1) |\n\t      G1_REG_DEC_INSWAP32_E(1) |\n\t      G1_REG_DEC_OUTSWAP32_E(1) |\n\t      G1_REG_DEC_DATA_DISC_E(0) |\n\t      G1_REG_DEC_LATENCY(0) |\n\t      G1_REG_DEC_CLK_GATE_E(1) |\n\t      G1_REG_DEC_IN_ENDIAN(1) |\n\t      G1_REG_DEC_OUT_ENDIAN(1) |\n\t      G1_REG_DEC_ADV_PRE_DIS(0) |\n\t      G1_REG_DEC_SCMD_DIS(0) |\n\t      G1_REG_DEC_MAX_BURST(16);\n\tvdpu_write_relaxed(vpu, reg, G1_SWREG(2));\n\n\treg = G1_REG_DEC_MODE(5) |\n\t      G1_REG_RLC_MODE_E(0) |\n\t      G1_REG_PIC_INTERLACE_E(!(seq->flags & V4L2_MPEG2_SEQ_FLAG_PROGRESSIVE)) |\n\t      G1_REG_PIC_FIELDMODE_E(pic->picture_structure != V4L2_MPEG2_PIC_FRAME) |\n\t      G1_REG_PIC_B_E(pic->picture_coding_type == V4L2_MPEG2_PIC_CODING_TYPE_B) |\n\t      G1_REG_PIC_INTER_E(pic->picture_coding_type != V4L2_MPEG2_PIC_CODING_TYPE_I) |\n\t      G1_REG_PIC_TOPFIELD_E(pic->picture_structure == V4L2_MPEG2_PIC_TOP_FIELD) |\n\t      G1_REG_FWD_INTERLACE_E(0) |\n\t      G1_REG_FILTERING_DIS(1) |\n\t      G1_REG_WRITE_MVS_E(0) |\n\t      G1_REG_DEC_AXI_WR_ID(0);\n\tvdpu_write_relaxed(vpu, reg, G1_SWREG(3));\n\n\treg = G1_REG_PIC_MB_WIDTH(MB_WIDTH(ctx->dst_fmt.width)) |\n\t      G1_REG_PIC_MB_HEIGHT_P(MB_HEIGHT(ctx->dst_fmt.height)) |\n\t      G1_REG_ALT_SCAN_E(pic->flags & V4L2_MPEG2_PIC_FLAG_ALT_SCAN) |\n\t      G1_REG_TOPFIELDFIRST_E(pic->flags & V4L2_MPEG2_PIC_FLAG_TOP_FIELD_FIRST);\n\tvdpu_write_relaxed(vpu, reg, G1_SWREG(4));\n\n\treg = G1_REG_STRM_START_BIT(0) |\n\t      G1_REG_QSCALE_TYPE(pic->flags & V4L2_MPEG2_PIC_FLAG_Q_SCALE_TYPE) |\n\t      G1_REG_CON_MV_E(pic->flags & V4L2_MPEG2_PIC_FLAG_CONCEALMENT_MV) |\n\t      G1_REG_INTRA_DC_PREC(pic->intra_dc_precision) |\n\t      G1_REG_INTRA_VLC_TAB(pic->flags & V4L2_MPEG2_PIC_FLAG_INTRA_VLC) |\n\t      G1_REG_FRAME_PRED_DCT(pic->flags & V4L2_MPEG2_PIC_FLAG_FRAME_PRED_DCT);\n\tvdpu_write_relaxed(vpu, reg, G1_SWREG(5));\n\n\treg = G1_REG_INIT_QP(1) |\n\t      G1_REG_STREAM_LEN(vb2_get_plane_payload(&src_buf->vb2_buf, 0));\n\tvdpu_write_relaxed(vpu, reg, G1_SWREG(6));\n\n\treg = G1_REG_ALT_SCAN_FLAG_E(pic->flags & V4L2_MPEG2_PIC_FLAG_ALT_SCAN) |\n\t      G1_REG_FCODE_FWD_HOR(pic->f_code[0][0]) |\n\t      G1_REG_FCODE_FWD_VER(pic->f_code[0][1]) |\n\t      G1_REG_FCODE_BWD_HOR(pic->f_code[1][0]) |\n\t      G1_REG_FCODE_BWD_VER(pic->f_code[1][1]) |\n\t      G1_REG_MV_ACCURACY_FWD(1) |\n\t      G1_REG_MV_ACCURACY_BWD(1);\n\tvdpu_write_relaxed(vpu, reg, G1_SWREG(18));\n\n\treg = G1_REG_STARTMB_X(0) |\n\t      G1_REG_STARTMB_Y(0);\n\tvdpu_write_relaxed(vpu, reg, G1_SWREG(48));\n\n\treg = G1_REG_APF_THRESHOLD(8);\n\tvdpu_write_relaxed(vpu, reg, G1_SWREG(55));\n\n\thantro_g1_mpeg2_dec_set_quantisation(vpu, ctx);\n\thantro_g1_mpeg2_dec_set_buffers(vpu, ctx, &src_buf->vb2_buf,\n\t\t\t\t\t&dst_buf->vb2_buf,\n\t\t\t\t\tseq, pic);\n\n\thantro_end_prepare_run(ctx);\n\n\tvdpu_write(vpu, G1_REG_INTERRUPT_DEC_E, G1_REG_INTERRUPT);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}