{
  "module_name": "iommu.c",
  "hash_id": "e49d71271aed23a776ad034fa65a2e802a30bbf5d668cb25e7a355fdb6ded774",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/nvidia/tegra-vde/iommu.c",
  "human_readable_source": "\n \n\n#include <linux/iommu.h>\n#include <linux/iova.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n\n#if IS_ENABLED(CONFIG_ARM_DMA_USE_IOMMU)\n#include <asm/dma-iommu.h>\n#endif\n\n#include \"vde.h\"\n\nint tegra_vde_iommu_map(struct tegra_vde *vde,\n\t\t\tstruct sg_table *sgt,\n\t\t\tstruct iova **iovap,\n\t\t\tsize_t size)\n{\n\tstruct iova *iova;\n\tunsigned long shift;\n\tunsigned long end;\n\tdma_addr_t addr;\n\n\tend = vde->domain->geometry.aperture_end;\n\tsize = iova_align(&vde->iova, size);\n\tshift = iova_shift(&vde->iova);\n\n\tiova = alloc_iova(&vde->iova, size >> shift, end >> shift, true);\n\tif (!iova)\n\t\treturn -ENOMEM;\n\n\taddr = iova_dma_addr(&vde->iova, iova);\n\n\tsize = iommu_map_sgtable(vde->domain, addr, sgt,\n\t\t\t\t IOMMU_READ | IOMMU_WRITE);\n\tif (!size) {\n\t\t__free_iova(&vde->iova, iova);\n\t\treturn -ENXIO;\n\t}\n\n\t*iovap = iova;\n\n\treturn 0;\n}\n\nvoid tegra_vde_iommu_unmap(struct tegra_vde *vde, struct iova *iova)\n{\n\tunsigned long shift = iova_shift(&vde->iova);\n\tunsigned long size = iova_size(iova) << shift;\n\tdma_addr_t addr = iova_dma_addr(&vde->iova, iova);\n\n\tiommu_unmap(vde->domain, addr, size);\n\t__free_iova(&vde->iova, iova);\n}\n\nint tegra_vde_iommu_init(struct tegra_vde *vde)\n{\n\tstruct device *dev = vde->dev;\n\tstruct iova *iova;\n\tunsigned long order;\n\tunsigned long shift;\n\tint err;\n\n\tvde->group = iommu_group_get(dev);\n\tif (!vde->group)\n\t\treturn 0;\n\n#if IS_ENABLED(CONFIG_ARM_DMA_USE_IOMMU)\n\tif (dev->archdata.mapping) {\n\t\tstruct dma_iommu_mapping *mapping = to_dma_iommu_mapping(dev);\n\n\t\tarm_iommu_detach_device(dev);\n\t\tarm_iommu_release_mapping(mapping);\n\t}\n#endif\n\tvde->domain = iommu_domain_alloc(&platform_bus_type);\n\tif (!vde->domain) {\n\t\terr = -ENOMEM;\n\t\tgoto put_group;\n\t}\n\n\terr = iova_cache_get();\n\tif (err)\n\t\tgoto free_domain;\n\n\torder = __ffs(vde->domain->pgsize_bitmap);\n\tinit_iova_domain(&vde->iova, 1UL << order, 0);\n\n\terr = iommu_attach_group(vde->domain, vde->group);\n\tif (err)\n\t\tgoto put_iova;\n\n\t \n\tshift = iova_shift(&vde->iova);\n\tiova = reserve_iova(&vde->iova, 0x60000000 >> shift,\n\t\t\t    0x70000000 >> shift);\n\tif (!iova) {\n\t\terr = -ENOMEM;\n\t\tgoto detach_group;\n\t}\n\n\tvde->iova_resv_static_addresses = iova;\n\n\t \n\tiova = reserve_iova(&vde->iova, 0xffffffff >> shift,\n\t\t\t    (0xffffffff >> shift) + 1);\n\tif (!iova) {\n\t\terr = -ENOMEM;\n\t\tgoto unreserve_iova;\n\t}\n\n\tvde->iova_resv_last_page = iova;\n\n\treturn 0;\n\nunreserve_iova:\n\t__free_iova(&vde->iova, vde->iova_resv_static_addresses);\ndetach_group:\n\tiommu_detach_group(vde->domain, vde->group);\nput_iova:\n\tput_iova_domain(&vde->iova);\n\tiova_cache_put();\nfree_domain:\n\tiommu_domain_free(vde->domain);\nput_group:\n\tiommu_group_put(vde->group);\n\n\treturn err;\n}\n\nvoid tegra_vde_iommu_deinit(struct tegra_vde *vde)\n{\n\tif (vde->domain) {\n\t\t__free_iova(&vde->iova, vde->iova_resv_last_page);\n\t\t__free_iova(&vde->iova, vde->iova_resv_static_addresses);\n\t\tiommu_detach_group(vde->domain, vde->group);\n\t\tput_iova_domain(&vde->iova);\n\t\tiova_cache_put();\n\t\tiommu_domain_free(vde->domain);\n\t\tiommu_group_put(vde->group);\n\n\t\tvde->domain = NULL;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}