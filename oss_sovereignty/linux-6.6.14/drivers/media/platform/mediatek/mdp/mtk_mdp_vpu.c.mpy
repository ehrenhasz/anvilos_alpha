{
  "module_name": "mtk_mdp_vpu.c",
  "hash_id": "5c012567b2c1ace8889e1889e7bea77ebf2cd728de0b80b9fc97d44a12e2c71f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/mediatek/mdp/mtk_mdp_vpu.c",
  "human_readable_source": "\n \n\n#include \"mtk_mdp_core.h\"\n#include \"mtk_mdp_vpu.h\"\n#include \"mtk_vpu.h\"\n\n\nstatic inline struct mtk_mdp_ctx *vpu_to_ctx(struct mtk_mdp_vpu *vpu)\n{\n\treturn container_of(vpu, struct mtk_mdp_ctx, vpu);\n}\n\nstatic void mtk_mdp_vpu_handle_init_ack(const struct mdp_ipi_comm_ack *msg)\n{\n\tstruct mtk_mdp_vpu *vpu = (struct mtk_mdp_vpu *)\n\t\t\t\t\t(unsigned long)msg->ap_inst;\n\n\t \n\tvpu->vsi = (struct mdp_process_vsi *)\n\t\t\tvpu_mapping_dm_addr(vpu->pdev, msg->vpu_inst_addr);\n\tvpu->inst_addr = msg->vpu_inst_addr;\n}\n\nstatic void mtk_mdp_vpu_ipi_handler(const void *data, unsigned int len,\n\t\t\t\t    void *priv)\n{\n\tconst struct mdp_ipi_comm_ack *msg = data;\n\tunsigned int msg_id = msg->msg_id;\n\tstruct mtk_mdp_vpu *vpu = (struct mtk_mdp_vpu *)\n\t\t\t\t\t(unsigned long)msg->ap_inst;\n\tstruct mtk_mdp_ctx *ctx;\n\n\tvpu->failure = msg->status;\n\tif (!vpu->failure) {\n\t\tswitch (msg_id) {\n\t\tcase VPU_MDP_INIT_ACK:\n\t\t\tmtk_mdp_vpu_handle_init_ack(data);\n\t\t\tbreak;\n\t\tcase VPU_MDP_DEINIT_ACK:\n\t\tcase VPU_MDP_PROCESS_ACK:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tctx = vpu_to_ctx(vpu);\n\t\t\tdev_err(&ctx->mdp_dev->pdev->dev,\n\t\t\t\t\"handle unknown ipi msg:0x%x\\n\",\n\t\t\t\tmsg_id);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tctx = vpu_to_ctx(vpu);\n\t\tmtk_mdp_dbg(0, \"[%d]:msg 0x%x, failure:%d\", ctx->id,\n\t\t\t    msg_id, vpu->failure);\n\t}\n}\n\nint mtk_mdp_vpu_register(struct platform_device *pdev)\n{\n\tstruct mtk_mdp_dev *mdp = platform_get_drvdata(pdev);\n\tint err;\n\n\terr = vpu_ipi_register(mdp->vpu_dev, IPI_MDP,\n\t\t\t       mtk_mdp_vpu_ipi_handler, \"mdp_vpu\", NULL);\n\tif (err)\n\t\tdev_err(&mdp->pdev->dev,\n\t\t\t\"vpu_ipi_registration fail status=%d\\n\", err);\n\n\treturn err;\n}\n\nstatic int mtk_mdp_vpu_send_msg(void *msg, int len, struct mtk_mdp_vpu *vpu,\n\t\t\t\tint id)\n{\n\tstruct mtk_mdp_ctx *ctx = vpu_to_ctx(vpu);\n\tint err;\n\n\tif (!vpu->pdev) {\n\t\tmtk_mdp_dbg(1, \"[%d]:vpu pdev is NULL\", ctx->id);\n\t\treturn -EINVAL;\n\t}\n\n\tmutex_lock(&ctx->mdp_dev->vpulock);\n\terr = vpu_ipi_send(vpu->pdev, (enum ipi_id)id, msg, len);\n\tif (err)\n\t\tdev_err(&ctx->mdp_dev->pdev->dev,\n\t\t\t\"vpu_ipi_send fail status %d\\n\", err);\n\tmutex_unlock(&ctx->mdp_dev->vpulock);\n\n\treturn err;\n}\n\nstatic int mtk_mdp_vpu_send_ap_ipi(struct mtk_mdp_vpu *vpu, uint32_t msg_id)\n{\n\tint err;\n\tstruct mdp_ipi_comm msg;\n\n\tmsg.msg_id = msg_id;\n\tmsg.ipi_id = IPI_MDP;\n\tmsg.vpu_inst_addr = vpu->inst_addr;\n\tmsg.ap_inst = (unsigned long)vpu;\n\terr = mtk_mdp_vpu_send_msg((void *)&msg, sizeof(msg), vpu, IPI_MDP);\n\tif (!err && vpu->failure)\n\t\terr = -EINVAL;\n\n\treturn err;\n}\n\nint mtk_mdp_vpu_init(struct mtk_mdp_vpu *vpu)\n{\n\tint err;\n\tstruct mdp_ipi_init msg;\n\tstruct mtk_mdp_ctx *ctx = vpu_to_ctx(vpu);\n\n\tvpu->pdev = ctx->mdp_dev->vpu_dev;\n\n\tmsg.msg_id = AP_MDP_INIT;\n\tmsg.ipi_id = IPI_MDP;\n\tmsg.ap_inst = (unsigned long)vpu;\n\terr = mtk_mdp_vpu_send_msg((void *)&msg, sizeof(msg), vpu, IPI_MDP);\n\tif (!err && vpu->failure)\n\t\terr = -EINVAL;\n\n\treturn err;\n}\n\nint mtk_mdp_vpu_deinit(struct mtk_mdp_vpu *vpu)\n{\n\treturn mtk_mdp_vpu_send_ap_ipi(vpu, AP_MDP_DEINIT);\n}\n\nint mtk_mdp_vpu_process(struct mtk_mdp_vpu *vpu)\n{\n\treturn mtk_mdp_vpu_send_ap_ipi(vpu, AP_MDP_PROCESS);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}