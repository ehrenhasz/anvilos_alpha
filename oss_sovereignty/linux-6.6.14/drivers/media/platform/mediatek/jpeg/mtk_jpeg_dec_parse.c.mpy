{
  "module_name": "mtk_jpeg_dec_parse.c",
  "hash_id": "3f72f3b24852050262953eb2d3dd95c5c8fa9f64b156e221f3fdd9580a9564fd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/mediatek/jpeg/mtk_jpeg_dec_parse.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/videodev2.h>\n#include <media/jpeg.h>\n\n#include \"mtk_jpeg_dec_parse.h\"\n\nstruct mtk_jpeg_stream {\n\tu8 *addr;\n\tu32 size;\n\tu32 curr;\n};\n\nstatic int read_byte(struct mtk_jpeg_stream *stream)\n{\n\tif (stream->curr >= stream->size)\n\t\treturn -1;\n\treturn stream->addr[stream->curr++];\n}\n\nstatic int read_word_be(struct mtk_jpeg_stream *stream, u32 *word)\n{\n\tu32 temp;\n\tint byte;\n\n\tbyte = read_byte(stream);\n\tif (byte == -1)\n\t\treturn -1;\n\ttemp = byte << 8;\n\tbyte = read_byte(stream);\n\tif (byte == -1)\n\t\treturn -1;\n\t*word = (u32)byte | temp;\n\n\treturn 0;\n}\n\nstatic void read_skip(struct mtk_jpeg_stream *stream, long len)\n{\n\tif (len <= 0)\n\t\treturn;\n\twhile (len--)\n\t\tread_byte(stream);\n}\n\nstatic bool mtk_jpeg_do_parse(struct mtk_jpeg_dec_param *param, u8 *src_addr_va,\n\t\t\t      u32 src_size)\n{\n\tbool notfound = true;\n\tstruct mtk_jpeg_stream stream;\n\n\tstream.addr = src_addr_va;\n\tstream.size = src_size;\n\tstream.curr = 0;\n\n\twhile (notfound) {\n\t\tint i, length, byte;\n\t\tu32 word;\n\n\t\tbyte = read_byte(&stream);\n\t\tif (byte == -1)\n\t\t\treturn false;\n\t\tif (byte != 0xff)\n\t\t\tcontinue;\n\t\tdo\n\t\t\tbyte = read_byte(&stream);\n\t\twhile (byte == 0xff);\n\t\tif (byte == -1)\n\t\t\treturn false;\n\t\tif (byte == 0)\n\t\t\tcontinue;\n\n\t\tlength = 0;\n\t\tswitch (byte) {\n\t\tcase JPEG_MARKER_SOF0:\n\t\t\t \n\t\t\tif (read_word_be(&stream, &word))\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\tif (read_byte(&stream) == -1)\n\t\t\t\tbreak;\n\n\t\t\tif (read_word_be(&stream, &word))\n\t\t\t\tbreak;\n\t\t\tparam->pic_h = word;\n\n\t\t\tif (read_word_be(&stream, &word))\n\t\t\t\tbreak;\n\t\t\tparam->pic_w = word;\n\n\t\t\tparam->comp_num = read_byte(&stream);\n\t\t\tif (param->comp_num != 1 && param->comp_num != 3)\n\t\t\t\tbreak;\n\n\t\t\tfor (i = 0; i < param->comp_num; i++) {\n\t\t\t\tparam->comp_id[i] = read_byte(&stream);\n\t\t\t\tif (param->comp_id[i] == -1)\n\t\t\t\t\tbreak;\n\n\t\t\t\t \n\t\t\t\tbyte = read_byte(&stream);\n\t\t\t\tif (byte == -1)\n\t\t\t\t\tbreak;\n\t\t\t\tparam->sampling_w[i] = (byte >> 4) & 0x0F;\n\t\t\t\tparam->sampling_h[i] = byte & 0x0F;\n\n\t\t\t\tparam->qtbl_num[i] = read_byte(&stream);\n\t\t\t\tif (param->qtbl_num[i] == -1)\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tnotfound = !(i == param->comp_num);\n\t\t\tbreak;\n\t\tcase JPEG_MARKER_RST ... JPEG_MARKER_RST + 7:\n\t\tcase JPEG_MARKER_SOI:\n\t\tcase JPEG_MARKER_EOI:\n\t\tcase JPEG_MARKER_TEM:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tif (read_word_be(&stream, &word))\n\t\t\t\tbreak;\n\t\t\tlength = (long)word - 2;\n\t\t\tread_skip(&stream, length);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn !notfound;\n}\n\nbool mtk_jpeg_parse(struct mtk_jpeg_dec_param *param, u8 *src_addr_va,\n\t\t    u32 src_size)\n{\n\tif (!mtk_jpeg_do_parse(param, src_addr_va, src_size))\n\t\treturn false;\n\tif (mtk_jpeg_dec_fill_param(param))\n\t\treturn false;\n\n\treturn true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}