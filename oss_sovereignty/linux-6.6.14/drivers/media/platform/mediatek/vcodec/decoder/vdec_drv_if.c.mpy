{
  "module_name": "vdec_drv_if.c",
  "hash_id": "09abaa23629e0c8ac0eb6099033825c7f4ad88b5488ee004c1966dab44f4d46e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/mediatek/vcodec/decoder/vdec_drv_if.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n\n#include \"vdec_drv_if.h\"\n#include \"mtk_vcodec_dec.h\"\n#include \"vdec_drv_base.h\"\n#include \"mtk_vcodec_dec_pm.h\"\n\nint vdec_if_init(struct mtk_vcodec_dec_ctx *ctx, unsigned int fourcc)\n{\n\tenum mtk_vdec_hw_arch hw_arch = ctx->dev->vdec_pdata->hw_arch;\n\tint ret = 0;\n\n\tswitch (fourcc) {\n\tcase V4L2_PIX_FMT_H264_SLICE:\n\t\tif (!ctx->dev->vdec_pdata->is_subdev_supported) {\n\t\t\tctx->dec_if = &vdec_h264_slice_if;\n\t\t\tctx->hw_id = MTK_VDEC_CORE;\n\t\t} else {\n\t\t\tctx->dec_if = &vdec_h264_slice_multi_if;\n\t\t\tctx->hw_id = IS_VDEC_LAT_ARCH(hw_arch) ? MTK_VDEC_LAT0 : MTK_VDEC_CORE;\n\t\t}\n\t\tbreak;\n\tcase V4L2_PIX_FMT_H264:\n\t\tctx->dec_if = &vdec_h264_if;\n\t\tctx->hw_id = MTK_VDEC_CORE;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_VP8_FRAME:\n\t\tctx->dec_if = &vdec_vp8_slice_if;\n\t\tctx->hw_id = MTK_VDEC_CORE;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_VP8:\n\t\tctx->dec_if = &vdec_vp8_if;\n\t\tctx->hw_id = MTK_VDEC_CORE;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_VP9:\n\t\tctx->dec_if = &vdec_vp9_if;\n\t\tctx->hw_id = MTK_VDEC_CORE;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_VP9_FRAME:\n\t\tctx->dec_if = &vdec_vp9_slice_lat_if;\n\t\tctx->hw_id = IS_VDEC_LAT_ARCH(hw_arch) ? MTK_VDEC_LAT0 : MTK_VDEC_CORE;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_HEVC_SLICE:\n\t\tctx->dec_if = &vdec_hevc_slice_multi_if;\n\t\tctx->hw_id = MTK_VDEC_LAT0;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_AV1_FRAME:\n\t\tctx->dec_if = &vdec_av1_slice_lat_if;\n\t\tctx->hw_id = MTK_VDEC_LAT0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tmtk_vcodec_dec_enable_hardware(ctx, ctx->hw_id);\n\tret = ctx->dec_if->init(ctx);\n\tmtk_vcodec_dec_disable_hardware(ctx, ctx->hw_id);\n\n\treturn ret;\n}\n\nint vdec_if_decode(struct mtk_vcodec_dec_ctx *ctx, struct mtk_vcodec_mem *bs,\n\t\t   struct vdec_fb *fb, bool *res_chg)\n{\n\tint ret = 0;\n\n\tif (bs) {\n\t\tif ((bs->dma_addr & 63) != 0) {\n\t\t\tmtk_v4l2_vdec_err(ctx, \"bs dma_addr should 64 byte align\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tif (fb) {\n\t\tif (((fb->base_y.dma_addr & 511) != 0) ||\n\t\t    ((fb->base_c.dma_addr & 511) != 0)) {\n\t\t\tmtk_v4l2_vdec_err(ctx, \"frame buffer dma_addr should 512 byte align\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tif (!ctx->drv_handle)\n\t\treturn -EIO;\n\n\tmtk_vcodec_dec_enable_hardware(ctx, ctx->hw_id);\n\tmtk_vcodec_set_curr_ctx(ctx->dev, ctx, ctx->hw_id);\n\tret = ctx->dec_if->decode(ctx->drv_handle, bs, fb, res_chg);\n\tmtk_vcodec_set_curr_ctx(ctx->dev, NULL, ctx->hw_id);\n\tmtk_vcodec_dec_disable_hardware(ctx, ctx->hw_id);\n\n\treturn ret;\n}\n\nint vdec_if_get_param(struct mtk_vcodec_dec_ctx *ctx, enum vdec_get_param_type type,\n\t\t      void *out)\n{\n\tint ret = 0;\n\n\tif (!ctx->drv_handle)\n\t\treturn -EIO;\n\n\tmtk_vdec_lock(ctx);\n\tret = ctx->dec_if->get_param(ctx->drv_handle, type, out);\n\tmtk_vdec_unlock(ctx);\n\n\treturn ret;\n}\n\nvoid vdec_if_deinit(struct mtk_vcodec_dec_ctx *ctx)\n{\n\tif (!ctx->drv_handle)\n\t\treturn;\n\n\tmtk_vcodec_dec_enable_hardware(ctx, ctx->hw_id);\n\tctx->dec_if->deinit(ctx->drv_handle);\n\tmtk_vcodec_dec_disable_hardware(ctx, ctx->hw_id);\n\n\tctx->drv_handle = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}