{
  "module_name": "mtk_vcodec_dec_drv.h",
  "hash_id": "405566adde815e3eeb5abd6b779c226ab0adfe3919188d63fae42a830ceec50e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/mediatek/vcodec/decoder/mtk_vcodec_dec_drv.h",
  "human_readable_source": " \n \n\n#ifndef _MTK_VCODEC_DEC_DRV_H_\n#define _MTK_VCODEC_DEC_DRV_H_\n\n#include \"../common/mtk_vcodec_cmn_drv.h\"\n#include \"../common/mtk_vcodec_dbgfs.h\"\n#include \"../common/mtk_vcodec_fw_priv.h\"\n#include \"../common/mtk_vcodec_util.h\"\n#include \"vdec_msg_queue.h\"\n\n#define MTK_VCODEC_DEC_NAME\t\"mtk-vcodec-dec\"\n\n#define IS_VDEC_LAT_ARCH(hw_arch) ((hw_arch) >= MTK_VDEC_LAT_SINGLE_CORE)\n#define IS_VDEC_INNER_RACING(capability) ((capability) & MTK_VCODEC_INNER_RACING)\n\n \nenum mtk_vdec_format_types {\n\tMTK_VDEC_FORMAT_MM21 = 0x20,\n\tMTK_VDEC_FORMAT_MT21C = 0x40,\n\tMTK_VDEC_FORMAT_H264_SLICE = 0x100,\n\tMTK_VDEC_FORMAT_VP8_FRAME = 0x200,\n\tMTK_VDEC_FORMAT_VP9_FRAME = 0x400,\n\tMTK_VDEC_FORMAT_AV1_FRAME = 0x800,\n\tMTK_VDEC_FORMAT_HEVC_FRAME = 0x1000,\n\tMTK_VCODEC_INNER_RACING = 0x20000,\n\tMTK_VDEC_IS_SUPPORT_10BIT = 0x40000,\n};\n\n \nenum mtk_vdec_hw_count {\n\tMTK_VDEC_NO_HW = 0,\n\tMTK_VDEC_ONE_CORE,\n\tMTK_VDEC_ONE_LAT_ONE_CORE,\n\tMTK_VDEC_MAX_HW_COUNT,\n};\n\n \nenum mtk_vdec_hw_arch {\n\tMTK_VDEC_PURE_SINGLE_CORE,\n\tMTK_VDEC_LAT_SINGLE_CORE,\n};\n\n \nstruct vdec_pic_info {\n\tunsigned int pic_w;\n\tunsigned int pic_h;\n\tunsigned int buf_w;\n\tunsigned int buf_h;\n\tunsigned int fb_sz[VIDEO_MAX_PLANES];\n\tunsigned int cap_fourcc;\n\tunsigned int reserved;\n};\n\n \nstruct mtk_vcodec_dec_pdata {\n\tvoid (*init_vdec_params)(struct mtk_vcodec_dec_ctx *ctx);\n\tint (*ctrls_setup)(struct mtk_vcodec_dec_ctx *ctx);\n\tvoid (*worker)(struct work_struct *work);\n\tint (*flush_decoder)(struct mtk_vcodec_dec_ctx *ctx);\n\tstruct vdec_fb *(*get_cap_buffer)(struct mtk_vcodec_dec_ctx *ctx);\n\tvoid (*cap_to_disp)(struct mtk_vcodec_dec_ctx *ctx, int error,\n\t\t\t    struct media_request *src_buf_req);\n\n\tconst struct vb2_ops *vdec_vb2_ops;\n\n\tconst struct mtk_video_fmt *vdec_formats;\n\tconst int *num_formats;\n\tconst struct mtk_video_fmt *default_out_fmt;\n\tconst struct mtk_video_fmt *default_cap_fmt;\n\n\tenum mtk_vdec_hw_arch hw_arch;\n\n\tbool is_subdev_supported;\n\tbool uses_stateless_api;\n};\n\n \nstruct mtk_vcodec_dec_ctx {\n\tenum mtk_instance_type type;\n\tstruct mtk_vcodec_dec_dev *dev;\n\tstruct list_head list;\n\n\tstruct v4l2_fh fh;\n\tstruct v4l2_m2m_ctx *m2m_ctx;\n\tstruct mtk_q_data q_data[2];\n\tint id;\n\tenum mtk_instance_state state;\n\n\tconst struct vdec_common_if *dec_if;\n\tvoid *drv_handle;\n\n\tstruct vdec_pic_info picinfo;\n\tint dpb_size;\n\n\tint int_cond[MTK_VDEC_HW_MAX];\n\tint int_type[MTK_VDEC_HW_MAX];\n\twait_queue_head_t queue[MTK_VDEC_HW_MAX];\n\tunsigned int irq_status;\n\n\tstruct v4l2_ctrl_handler ctrl_hdl;\n\tstruct work_struct decode_work;\n\tstruct vdec_pic_info last_decoded_picinfo;\n\tstruct v4l2_m2m_buffer empty_flush_buf;\n\tbool is_flushing;\n\n\tu32 current_codec;\n\tu32 capture_fourcc;\n\n\tenum v4l2_colorspace colorspace;\n\tenum v4l2_ycbcr_encoding ycbcr_enc;\n\tenum v4l2_quantization quantization;\n\tenum v4l2_xfer_func xfer_func;\n\n\tint decoded_frame_cnt;\n\tstruct mutex lock;\n\tint hw_id;\n\n\tstruct vdec_msg_queue msg_queue;\n\tvoid *vpu_inst;\n\n\tbool is_10bit_bitstream;\n};\n\n \nstruct mtk_vcodec_dec_dev {\n\tstruct v4l2_device v4l2_dev;\n\tstruct video_device *vfd_dec;\n\tstruct media_device mdev_dec;\n\n\tstruct v4l2_m2m_dev *m2m_dev_dec;\n\tstruct platform_device *plat_dev;\n\tstruct list_head ctx_list;\n\tstruct mtk_vcodec_dec_ctx *curr_ctx;\n\n\tvoid __iomem *reg_base[NUM_MAX_VCODEC_REG_BASE];\n\tconst struct mtk_vcodec_dec_pdata *vdec_pdata;\n\tstruct regmap *vdecsys_regmap;\n\n\tstruct mtk_vcodec_fw *fw_handler;\n\tu64 id_counter;\n\n\t \n\tstruct mutex dec_mutex[MTK_VDEC_HW_MAX];\n\tstruct mutex dev_mutex;\n\tstruct workqueue_struct *decode_workqueue;\n\n\tspinlock_t irqlock;\n\tint dec_irq;\n\n\tstruct mtk_vcodec_pm pm;\n\tunsigned int dec_capability;\n\n\tstruct workqueue_struct *core_workqueue;\n\n\tvoid *subdev_dev[MTK_VDEC_HW_MAX];\n\tint (*subdev_prob_done)(struct mtk_vcodec_dec_dev *vdec_dev);\n\tDECLARE_BITMAP(subdev_bitmap, MTK_VDEC_HW_MAX);\n\n\tatomic_t dec_active_cnt;\n\tu32 vdec_racing_info[132];\n\t \n\tstruct mutex dec_racing_info_mutex;\n\tstruct mtk_vcodec_dbgfs dbgfs;\n};\n\nstatic inline struct mtk_vcodec_dec_ctx *fh_to_dec_ctx(struct v4l2_fh *fh)\n{\n\treturn container_of(fh, struct mtk_vcodec_dec_ctx, fh);\n}\n\nstatic inline struct mtk_vcodec_dec_ctx *ctrl_to_dec_ctx(struct v4l2_ctrl *ctrl)\n{\n\treturn container_of(ctrl->handler, struct mtk_vcodec_dec_ctx, ctrl_hdl);\n}\n\n \nstatic inline void\nwake_up_dec_ctx(struct mtk_vcodec_dec_ctx *ctx, unsigned int reason, unsigned int hw_id)\n{\n\tctx->int_cond[hw_id] = 1;\n\tctx->int_type[hw_id] = reason;\n\twake_up_interruptible(&ctx->queue[hw_id]);\n}\n\n#define mtk_vdec_err(ctx, fmt, args...)                               \\\n\tmtk_vcodec_err((ctx)->id, (ctx)->dev->plat_dev, fmt, ##args)\n\n#define mtk_vdec_debug(ctx, fmt, args...)                             \\\n\tmtk_vcodec_debug((ctx)->id, (ctx)->dev->plat_dev, fmt, ##args)\n\n#define mtk_v4l2_vdec_err(ctx, fmt, args...) mtk_v4l2_err((ctx)->dev->plat_dev, fmt, ##args)\n\n#define mtk_v4l2_vdec_dbg(level, ctx, fmt, args...)             \\\n\tmtk_v4l2_debug((ctx)->dev->plat_dev, level, fmt, ##args)\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}