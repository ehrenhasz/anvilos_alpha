{
  "module_name": "vdec_vpu_if.c",
  "hash_id": "a80cff91dbaf3e7af16bb915a9be7b91c5cef85bed5c8d9d20204bd9ed8ebd64",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/mediatek/vcodec/decoder/vdec_vpu_if.c",
  "human_readable_source": "\n \n\n#include \"mtk_vcodec_dec_drv.h\"\n#include \"vdec_drv_if.h\"\n#include \"vdec_ipi_msg.h\"\n#include \"vdec_vpu_if.h\"\n\nstatic void handle_init_ack_msg(const struct vdec_vpu_ipi_init_ack *msg)\n{\n\tstruct vdec_vpu_inst *vpu = (struct vdec_vpu_inst *)\n\t\t\t\t\t(unsigned long)msg->ap_inst_addr;\n\n\tmtk_vdec_debug(vpu->ctx, \"+ ap_inst_addr = 0x%llx\", msg->ap_inst_addr);\n\n\t \n\t \n\tvpu->vsi = mtk_vcodec_fw_map_dm_addr(vpu->ctx->dev->fw_handler,\n\t\t\t\t\t     msg->vpu_inst_addr);\n\tvpu->inst_addr = msg->vpu_inst_addr;\n\n\tmtk_vdec_debug(vpu->ctx, \"- vpu_inst_addr = 0x%x\", vpu->inst_addr);\n\n\t \n\tvpu->fw_abi_version = 0;\n\t \n\tvpu->inst_id = 0xdeadbeef;\n\n\t \n\tif (mtk_vcodec_fw_get_type(vpu->ctx->dev->fw_handler) == VPU)\n\t\treturn;\n\n\t \n\tvpu->fw_abi_version = msg->vdec_abi_version;\n\tmtk_vdec_debug(vpu->ctx, \"firmware version 0x%x\\n\", vpu->fw_abi_version);\n\tswitch (vpu->fw_abi_version) {\n\tcase 1:\n\t\tbreak;\n\tcase 2:\n\t\tvpu->inst_id = msg->inst_id;\n\t\tbreak;\n\tdefault:\n\t\tmtk_vdec_err(vpu->ctx, \"unhandled firmware version 0x%x\\n\", vpu->fw_abi_version);\n\t\tvpu->failure = 1;\n\t\tbreak;\n\t}\n}\n\nstatic void handle_get_param_msg_ack(const struct vdec_vpu_ipi_get_param_ack *msg)\n{\n\tstruct vdec_vpu_inst *vpu = (struct vdec_vpu_inst *)\n\t\t\t\t\t(unsigned long)msg->ap_inst_addr;\n\n\tmtk_vdec_debug(vpu->ctx, \"+ ap_inst_addr = 0x%llx\", msg->ap_inst_addr);\n\n\t \n\tswitch (msg->param_type) {\n\tcase GET_PARAM_PIC_INFO:\n\t\tvpu->fb_sz[0] = msg->data[0];\n\t\tvpu->fb_sz[1] = msg->data[1];\n\t\tbreak;\n\tdefault:\n\t\tmtk_vdec_err(vpu->ctx, \"invalid get param type=%d\", msg->param_type);\n\t\tvpu->failure = 1;\n\t\tbreak;\n\t}\n}\n\nstatic bool vpu_dec_check_ap_inst(struct mtk_vcodec_dec_dev *dec_dev, struct vdec_vpu_inst *vpu)\n{\n\tstruct mtk_vcodec_dec_ctx *ctx;\n\tint ret = false;\n\n\tlist_for_each_entry(ctx, &dec_dev->ctx_list, list) {\n\t\tif (!IS_ERR_OR_NULL(ctx) && ctx->vpu_inst == vpu) {\n\t\t\tret = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\n \nstatic void vpu_dec_ipi_handler(void *data, unsigned int len, void *priv)\n{\n\tstruct mtk_vcodec_dec_dev *dec_dev;\n\tconst struct vdec_vpu_ipi_ack *msg = data;\n\tstruct vdec_vpu_inst *vpu;\n\n\tdec_dev = (struct mtk_vcodec_dec_dev *)priv;\n\tvpu = (struct vdec_vpu_inst *)(unsigned long)msg->ap_inst_addr;\n\tif (!priv || !vpu) {\n\t\tpr_err(MTK_DBG_V4L2_STR \"ap_inst_addr is NULL, did the SCP hang or crash?\");\n\t\treturn;\n\t}\n\n\tif (!vpu_dec_check_ap_inst(dec_dev, vpu) || msg->msg_id < VPU_IPIMSG_DEC_INIT_ACK ||\n\t    msg->msg_id > VPU_IPIMSG_DEC_GET_PARAM_ACK) {\n\t\tmtk_v4l2_vdec_err(vpu->ctx, \"vdec msg id not correctly => 0x%x\", msg->msg_id);\n\t\tvpu->failure = -EINVAL;\n\t\tgoto error;\n\t}\n\n\tvpu->failure = msg->status;\n\tif (msg->status != 0)\n\t\tgoto error;\n\n\tswitch (msg->msg_id) {\n\tcase VPU_IPIMSG_DEC_INIT_ACK:\n\t\thandle_init_ack_msg(data);\n\t\tbreak;\n\n\tcase VPU_IPIMSG_DEC_START_ACK:\n\tcase VPU_IPIMSG_DEC_END_ACK:\n\tcase VPU_IPIMSG_DEC_DEINIT_ACK:\n\tcase VPU_IPIMSG_DEC_RESET_ACK:\n\tcase VPU_IPIMSG_DEC_CORE_ACK:\n\tcase VPU_IPIMSG_DEC_CORE_END_ACK:\n\t\tbreak;\n\n\tcase VPU_IPIMSG_DEC_GET_PARAM_ACK:\n\t\thandle_get_param_msg_ack(data);\n\t\tbreak;\n\tdefault:\n\t\tmtk_vdec_err(vpu->ctx, \"invalid msg=%X\", msg->msg_id);\n\t\tbreak;\n\t}\n\nerror:\n\tvpu->signaled = 1;\n}\n\nstatic int vcodec_vpu_send_msg(struct vdec_vpu_inst *vpu, void *msg, int len)\n{\n\tint err, id, msgid;\n\n\tmsgid = *(uint32_t *)msg;\n\tmtk_vdec_debug(vpu->ctx, \"id=%X\", msgid);\n\n\tvpu->failure = 0;\n\tvpu->signaled = 0;\n\n\tif (vpu->ctx->dev->vdec_pdata->hw_arch == MTK_VDEC_LAT_SINGLE_CORE) {\n\t\tif (msgid == AP_IPIMSG_DEC_CORE ||\n\t\t    msgid == AP_IPIMSG_DEC_CORE_END)\n\t\t\tid = vpu->core_id;\n\t\telse\n\t\t\tid = vpu->id;\n\t} else {\n\t\tid = vpu->id;\n\t}\n\n\terr = mtk_vcodec_fw_ipi_send(vpu->ctx->dev->fw_handler, id, msg,\n\t\t\t\t     len, 2000);\n\tif (err) {\n\t\tmtk_vdec_err(vpu->ctx, \"send fail vpu_id=%d msg_id=%X status=%d\",\n\t\t\t     id, msgid, err);\n\t\treturn err;\n\t}\n\n\treturn vpu->failure;\n}\n\nstatic int vcodec_send_ap_ipi(struct vdec_vpu_inst *vpu, unsigned int msg_id)\n{\n\tstruct vdec_ap_ipi_cmd msg;\n\tint err = 0;\n\n\tmtk_vdec_debug(vpu->ctx, \"+ id=%X\", msg_id);\n\n\tmemset(&msg, 0, sizeof(msg));\n\tmsg.msg_id = msg_id;\n\tif (vpu->fw_abi_version < 2)\n\t\tmsg.vpu_inst_addr = vpu->inst_addr;\n\telse\n\t\tmsg.inst_id = vpu->inst_id;\n\tmsg.codec_type = vpu->codec_type;\n\n\terr = vcodec_vpu_send_msg(vpu, &msg, sizeof(msg));\n\tmtk_vdec_debug(vpu->ctx, \"- id=%X ret=%d\", msg_id, err);\n\treturn err;\n}\n\nint vpu_dec_init(struct vdec_vpu_inst *vpu)\n{\n\tstruct vdec_ap_ipi_init msg;\n\tint err;\n\n\tinit_waitqueue_head(&vpu->wq);\n\tvpu->handler = vpu_dec_ipi_handler;\n\tvpu->ctx->vpu_inst = vpu;\n\n\terr = mtk_vcodec_fw_ipi_register(vpu->ctx->dev->fw_handler, vpu->id,\n\t\t\t\t\t vpu->handler, \"vdec\", vpu->ctx->dev);\n\tif (err) {\n\t\tmtk_vdec_err(vpu->ctx, \"vpu_ipi_register fail status=%d\", err);\n\t\treturn err;\n\t}\n\n\tif (vpu->ctx->dev->vdec_pdata->hw_arch == MTK_VDEC_LAT_SINGLE_CORE) {\n\t\terr = mtk_vcodec_fw_ipi_register(vpu->ctx->dev->fw_handler,\n\t\t\t\t\t\t vpu->core_id, vpu->handler,\n\t\t\t\t\t\t \"vdec\", vpu->ctx->dev);\n\t\tif (err) {\n\t\t\tmtk_vdec_err(vpu->ctx, \"vpu_ipi_register core fail status=%d\", err);\n\t\t\treturn err;\n\t\t}\n\t}\n\n\tmemset(&msg, 0, sizeof(msg));\n\tmsg.msg_id = AP_IPIMSG_DEC_INIT;\n\tmsg.ap_inst_addr = (unsigned long)vpu;\n\tmsg.codec_type = vpu->codec_type;\n\n\tmtk_vdec_debug(vpu->ctx, \"vdec_inst=%p\", vpu);\n\n\terr = vcodec_vpu_send_msg(vpu, (void *)&msg, sizeof(msg));\n\tmtk_vdec_debug(vpu->ctx, \"- ret=%d\", err);\n\treturn err;\n}\n\nint vpu_dec_start(struct vdec_vpu_inst *vpu, uint32_t *data, unsigned int len)\n{\n\tstruct vdec_ap_ipi_dec_start msg;\n\tint i;\n\tint err = 0;\n\n\tif (len > ARRAY_SIZE(msg.data)) {\n\t\tmtk_vdec_err(vpu->ctx, \"invalid len = %d\\n\", len);\n\t\treturn -EINVAL;\n\t}\n\n\tmemset(&msg, 0, sizeof(msg));\n\tmsg.msg_id = AP_IPIMSG_DEC_START;\n\tif (vpu->fw_abi_version < 2)\n\t\tmsg.vpu_inst_addr = vpu->inst_addr;\n\telse\n\t\tmsg.inst_id = vpu->inst_id;\n\n\tfor (i = 0; i < len; i++)\n\t\tmsg.data[i] = data[i];\n\tmsg.codec_type = vpu->codec_type;\n\n\terr = vcodec_vpu_send_msg(vpu, (void *)&msg, sizeof(msg));\n\tmtk_vdec_debug(vpu->ctx, \"- ret=%d\", err);\n\treturn err;\n}\n\nint vpu_dec_get_param(struct vdec_vpu_inst *vpu, uint32_t *data,\n\t\t      unsigned int len, unsigned int param_type)\n{\n\tstruct vdec_ap_ipi_get_param msg;\n\tint err;\n\n\tif (len > ARRAY_SIZE(msg.data)) {\n\t\tmtk_vdec_err(vpu->ctx, \"invalid len = %d\\n\", len);\n\t\treturn -EINVAL;\n\t}\n\n\tmemset(&msg, 0, sizeof(msg));\n\tmsg.msg_id = AP_IPIMSG_DEC_GET_PARAM;\n\tmsg.inst_id = vpu->inst_id;\n\tmemcpy(msg.data, data, sizeof(unsigned int) * len);\n\tmsg.param_type = param_type;\n\tmsg.codec_type = vpu->codec_type;\n\n\terr = vcodec_vpu_send_msg(vpu, (void *)&msg, sizeof(msg));\n\tmtk_vdec_debug(vpu->ctx, \"- ret=%d\", err);\n\treturn err;\n}\n\nint vpu_dec_core(struct vdec_vpu_inst *vpu)\n{\n\treturn vcodec_send_ap_ipi(vpu, AP_IPIMSG_DEC_CORE);\n}\n\nint vpu_dec_end(struct vdec_vpu_inst *vpu)\n{\n\treturn vcodec_send_ap_ipi(vpu, AP_IPIMSG_DEC_END);\n}\n\nint vpu_dec_core_end(struct vdec_vpu_inst *vpu)\n{\n\treturn vcodec_send_ap_ipi(vpu, AP_IPIMSG_DEC_CORE_END);\n}\n\nint vpu_dec_deinit(struct vdec_vpu_inst *vpu)\n{\n\treturn vcodec_send_ap_ipi(vpu, AP_IPIMSG_DEC_DEINIT);\n}\n\nint vpu_dec_reset(struct vdec_vpu_inst *vpu)\n{\n\treturn vcodec_send_ap_ipi(vpu, AP_IPIMSG_DEC_RESET);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}