{
  "module_name": "mtk_vcodec_dbgfs.c",
  "hash_id": "5cc94390823d0fac4f92939e7b5e6c0fbd5496fca4703897cdcecad8a24403b4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/mediatek/vcodec/common/mtk_vcodec_dbgfs.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n\n#include \"mtk_vcodec_dbgfs.h\"\n#include \"../decoder/mtk_vcodec_dec_drv.h\"\n#include \"../encoder/mtk_vcodec_enc_drv.h\"\n#include \"mtk_vcodec_util.h\"\n\nstatic void mtk_vdec_dbgfs_get_format_type(struct mtk_vcodec_dec_ctx *ctx, char *buf,\n\t\t\t\t\t   int *used, int total)\n{\n\tint curr_len;\n\n\tswitch (ctx->current_codec) {\n\tcase V4L2_PIX_FMT_H264_SLICE:\n\t\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t\t    \"\\toutput format: h264 slice\\n\");\n\t\tbreak;\n\tcase V4L2_PIX_FMT_VP8_FRAME:\n\t\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t\t    \"\\toutput format: vp8 slice\\n\");\n\t\tbreak;\n\tcase V4L2_PIX_FMT_VP9_FRAME:\n\t\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t\t    \"\\toutput format: vp9 slice\\n\");\n\t\tbreak;\n\tdefault:\n\t\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t\t    \"\\tunsupported output format: 0x%x\\n\",\n\t\t\t\t    ctx->current_codec);\n\t}\n\t*used += curr_len;\n\n\tswitch (ctx->capture_fourcc) {\n\tcase V4L2_PIX_FMT_MM21:\n\t\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t\t    \"\\tcapture format: MM21\\n\");\n\t\tbreak;\n\tcase V4L2_PIX_FMT_MT21C:\n\t\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t\t    \"\\tcapture format: MT21C\\n\");\n\t\tbreak;\n\tdefault:\n\t\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t\t    \"\\tunsupported capture format: 0x%x\\n\",\n\t\t\t\t    ctx->capture_fourcc);\n\t}\n\t*used += curr_len;\n}\n\nstatic void mtk_vdec_dbgfs_get_help(char *buf, int *used, int total)\n{\n\tint curr_len;\n\n\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t    \"help: (1: echo -'info' > vdec 2: cat vdec)\\n\");\n\t*used += curr_len;\n\n\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t    \"\\t-picinfo: get resolution\\n\");\n\t*used += curr_len;\n\n\tcurr_len = snprintf(buf + *used, total - *used,\n\t\t\t    \"\\t-format: get output & capture queue format\\n\");\n\t*used += curr_len;\n}\n\nstatic ssize_t mtk_vdec_dbgfs_write(struct file *filp, const char __user *ubuf,\n\t\t\t\t    size_t count, loff_t *ppos)\n{\n\tstruct mtk_vcodec_dec_dev *vcodec_dev = filp->private_data;\n\tstruct mtk_vcodec_dbgfs *dbgfs = &vcodec_dev->dbgfs;\n\n\tmutex_lock(&dbgfs->dbgfs_lock);\n\tdbgfs->buf_size = simple_write_to_buffer(dbgfs->dbgfs_buf, sizeof(dbgfs->dbgfs_buf),\n\t\t\t\t\t\t ppos, ubuf, count);\n\tmutex_unlock(&dbgfs->dbgfs_lock);\n\tif (dbgfs->buf_size > 0)\n\t\treturn count;\n\n\treturn dbgfs->buf_size;\n}\n\nstatic ssize_t mtk_vdec_dbgfs_read(struct file *filp, char __user *ubuf,\n\t\t\t\t   size_t count, loff_t *ppos)\n{\n\tstruct mtk_vcodec_dec_dev *vcodec_dev = filp->private_data;\n\tstruct mtk_vcodec_dbgfs *dbgfs = &vcodec_dev->dbgfs;\n\tstruct mtk_vcodec_dbgfs_inst *dbgfs_inst;\n\tstruct mtk_vcodec_dec_ctx *ctx;\n\tint total_len = 200 * (dbgfs->inst_count == 0 ? 1 : dbgfs->inst_count);\n\tint used_len = 0, curr_len, ret;\n\tbool dbgfs_index[MTK_VDEC_DBGFS_MAX] = {0};\n\tchar *buf = kmalloc(total_len, GFP_KERNEL);\n\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\tif (strstr(dbgfs->dbgfs_buf, \"-help\") || dbgfs->buf_size == 1) {\n\t\tmtk_vdec_dbgfs_get_help(buf, &used_len, total_len);\n\t\tgoto read_buffer;\n\t}\n\n\tif (strstr(dbgfs->dbgfs_buf, \"-picinfo\"))\n\t\tdbgfs_index[MTK_VDEC_DBGFS_PICINFO] = true;\n\n\tif (strstr(dbgfs->dbgfs_buf, \"-format\"))\n\t\tdbgfs_index[MTK_VDEC_DBGFS_FORMAT] = true;\n\n\tmutex_lock(&dbgfs->dbgfs_lock);\n\tlist_for_each_entry(dbgfs_inst, &dbgfs->dbgfs_head, node) {\n\t\tctx = dbgfs_inst->vcodec_ctx;\n\n\t\tcurr_len = snprintf(buf + used_len, total_len - used_len,\n\t\t\t\t    \"inst[%d]:\\n \", ctx->id);\n\t\tused_len += curr_len;\n\n\t\tif (dbgfs_index[MTK_VDEC_DBGFS_PICINFO]) {\n\t\t\tcurr_len = snprintf(buf + used_len, total_len - used_len,\n\t\t\t\t\t    \"\\treal(%dx%d)=>align(%dx%d)\\n\",\n\t\t\t\t\t    ctx->picinfo.pic_w, ctx->picinfo.pic_h,\n\t\t\t\t\t    ctx->picinfo.buf_w, ctx->picinfo.buf_h);\n\t\t\tused_len += curr_len;\n\t\t}\n\n\t\tif (dbgfs_index[MTK_VDEC_DBGFS_FORMAT])\n\t\t\tmtk_vdec_dbgfs_get_format_type(ctx, buf, &used_len, total_len);\n\t}\n\tmutex_unlock(&dbgfs->dbgfs_lock);\nread_buffer:\n\tret = simple_read_from_buffer(ubuf, count, ppos, buf, used_len);\n\tkfree(buf);\n\treturn ret;\n}\n\nstatic const struct file_operations vdec_fops = {\n\t.open = simple_open,\n\t.write = mtk_vdec_dbgfs_write,\n\t.read = mtk_vdec_dbgfs_read,\n};\n\nvoid mtk_vcodec_dbgfs_create(struct mtk_vcodec_dec_ctx *ctx)\n{\n\tstruct mtk_vcodec_dbgfs_inst *dbgfs_inst;\n\tstruct mtk_vcodec_dec_dev *vcodec_dev = ctx->dev;\n\n\tdbgfs_inst = kzalloc(sizeof(*dbgfs_inst), GFP_KERNEL);\n\tif (!dbgfs_inst)\n\t\treturn;\n\n\tlist_add_tail(&dbgfs_inst->node, &vcodec_dev->dbgfs.dbgfs_head);\n\n\tvcodec_dev->dbgfs.inst_count++;\n\n\tdbgfs_inst->inst_id = ctx->id;\n\tdbgfs_inst->vcodec_ctx = ctx;\n}\nEXPORT_SYMBOL_GPL(mtk_vcodec_dbgfs_create);\n\nvoid mtk_vcodec_dbgfs_remove(struct mtk_vcodec_dec_dev *vcodec_dev, int ctx_id)\n{\n\tstruct mtk_vcodec_dbgfs_inst *dbgfs_inst;\n\n\tlist_for_each_entry(dbgfs_inst, &vcodec_dev->dbgfs.dbgfs_head, node) {\n\t\tif (dbgfs_inst->inst_id == ctx_id) {\n\t\t\tvcodec_dev->dbgfs.inst_count--;\n\t\t\tlist_del(&dbgfs_inst->node);\n\t\t\tkfree(dbgfs_inst);\n\t\t\treturn;\n\t\t}\n\t}\n}\nEXPORT_SYMBOL_GPL(mtk_vcodec_dbgfs_remove);\n\nstatic void mtk_vcodec_dbgfs_vdec_init(struct mtk_vcodec_dec_dev *vcodec_dev)\n{\n\tstruct dentry *vcodec_root;\n\n\tvcodec_dev->dbgfs.vcodec_root = debugfs_create_dir(\"vcodec-dec\", NULL);\n\tif (IS_ERR(vcodec_dev->dbgfs.vcodec_root))\n\t\tdev_err(&vcodec_dev->plat_dev->dev, \"create vcodec dir err:%ld\\n\",\n\t\t\tPTR_ERR(vcodec_dev->dbgfs.vcodec_root));\n\n\tvcodec_root = vcodec_dev->dbgfs.vcodec_root;\n\tdebugfs_create_x32(\"mtk_v4l2_dbg_level\", 0644, vcodec_root, &mtk_v4l2_dbg_level);\n\tdebugfs_create_x32(\"mtk_vcodec_dbg\", 0644, vcodec_root, &mtk_vcodec_dbg);\n\n\tvcodec_dev->dbgfs.inst_count = 0;\n\tINIT_LIST_HEAD(&vcodec_dev->dbgfs.dbgfs_head);\n\tdebugfs_create_file(\"vdec\", 0200, vcodec_root, vcodec_dev, &vdec_fops);\n\tmutex_init(&vcodec_dev->dbgfs.dbgfs_lock);\n}\n\nstatic void mtk_vcodec_dbgfs_venc_init(struct mtk_vcodec_enc_dev *vcodec_dev)\n{\n\tstruct dentry *vcodec_root;\n\n\tvcodec_dev->dbgfs.vcodec_root = debugfs_create_dir(\"vcodec-enc\", NULL);\n\tif (IS_ERR(vcodec_dev->dbgfs.vcodec_root))\n\t\tdev_err(&vcodec_dev->plat_dev->dev, \"create venc dir err:%d\\n\",\n\t\t\tIS_ERR(vcodec_dev->dbgfs.vcodec_root));\n\n\tvcodec_root = vcodec_dev->dbgfs.vcodec_root;\n\tdebugfs_create_x32(\"mtk_v4l2_dbg_level\", 0644, vcodec_root, &mtk_v4l2_dbg_level);\n\tdebugfs_create_x32(\"mtk_vcodec_dbg\", 0644, vcodec_root, &mtk_vcodec_dbg);\n\n\tvcodec_dev->dbgfs.inst_count = 0;\n}\n\nvoid mtk_vcodec_dbgfs_init(void *vcodec_dev, bool is_encode)\n{\n\tif (is_encode)\n\t\tmtk_vcodec_dbgfs_venc_init(vcodec_dev);\n\telse\n\t\tmtk_vcodec_dbgfs_vdec_init(vcodec_dev);\n}\nEXPORT_SYMBOL_GPL(mtk_vcodec_dbgfs_init);\n\nvoid mtk_vcodec_dbgfs_deinit(struct mtk_vcodec_dbgfs *dbgfs)\n{\n\tdebugfs_remove_recursive(dbgfs->vcodec_root);\n}\nEXPORT_SYMBOL_GPL(mtk_vcodec_dbgfs_deinit);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Mediatek video codec driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}