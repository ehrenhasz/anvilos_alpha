{
  "module_name": "venc_drv_if.c",
  "hash_id": "6d3b190d6659f111848212df380dcae81443a4b70b4e7362f0d4e54f1b4f7739",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/mediatek/vcodec/encoder/venc_drv_if.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n\n#include \"venc_drv_base.h\"\n#include \"venc_drv_if.h\"\n\n#include \"mtk_vcodec_enc.h\"\n#include \"mtk_vcodec_enc_pm.h\"\n\nint venc_if_init(struct mtk_vcodec_enc_ctx *ctx, unsigned int fourcc)\n{\n\tint ret = 0;\n\n\tswitch (fourcc) {\n\tcase V4L2_PIX_FMT_VP8:\n\t\tctx->enc_if = &venc_vp8_if;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_H264:\n\t\tctx->enc_if = &venc_h264_if;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tmtk_venc_lock(ctx);\n\tmtk_vcodec_enc_clock_on(&ctx->dev->pm);\n\tret = ctx->enc_if->init(ctx);\n\tmtk_vcodec_enc_clock_off(&ctx->dev->pm);\n\tmtk_venc_unlock(ctx);\n\n\treturn ret;\n}\n\nint venc_if_set_param(struct mtk_vcodec_enc_ctx *ctx,\n\t\t      enum venc_set_param_type type, struct venc_enc_param *in)\n{\n\tint ret = 0;\n\n\tmtk_venc_lock(ctx);\n\tmtk_vcodec_enc_clock_on(&ctx->dev->pm);\n\tret = ctx->enc_if->set_param(ctx->drv_handle, type, in);\n\tmtk_vcodec_enc_clock_off(&ctx->dev->pm);\n\tmtk_venc_unlock(ctx);\n\n\treturn ret;\n}\n\nint venc_if_encode(struct mtk_vcodec_enc_ctx *ctx,\n\t\t   enum venc_start_opt opt, struct venc_frm_buf *frm_buf,\n\t\t   struct mtk_vcodec_mem *bs_buf,\n\t\t   struct venc_done_result *result)\n{\n\tint ret = 0;\n\tunsigned long flags;\n\n\tmtk_venc_lock(ctx);\n\n\tspin_lock_irqsave(&ctx->dev->irqlock, flags);\n\tctx->dev->curr_ctx = ctx;\n\tspin_unlock_irqrestore(&ctx->dev->irqlock, flags);\n\n\tmtk_vcodec_enc_clock_on(&ctx->dev->pm);\n\tret = ctx->enc_if->encode(ctx->drv_handle, opt, frm_buf,\n\t\t\t\t  bs_buf, result);\n\tmtk_vcodec_enc_clock_off(&ctx->dev->pm);\n\n\tspin_lock_irqsave(&ctx->dev->irqlock, flags);\n\tctx->dev->curr_ctx = NULL;\n\tspin_unlock_irqrestore(&ctx->dev->irqlock, flags);\n\n\tmtk_venc_unlock(ctx);\n\treturn ret;\n}\n\nint venc_if_deinit(struct mtk_vcodec_enc_ctx *ctx)\n{\n\tint ret = 0;\n\n\tif (!ctx->drv_handle)\n\t\treturn 0;\n\n\tmtk_venc_lock(ctx);\n\tmtk_vcodec_enc_clock_on(&ctx->dev->pm);\n\tret = ctx->enc_if->deinit(ctx->drv_handle);\n\tmtk_vcodec_enc_clock_off(&ctx->dev->pm);\n\tmtk_venc_unlock(ctx);\n\n\tctx->drv_handle = NULL;\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}