{
  "module_name": "core.h",
  "hash_id": "9a710143fd41afc6aaa63dc09da8120e7db33c92d41afb9056ebb8c2952d2e67",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/qcom/venus/core.h",
  "human_readable_source": " \n \n\n#ifndef __VENUS_CORE_H_\n#define __VENUS_CORE_H_\n\n#include <linux/bitops.h>\n#include <linux/list.h>\n#include <media/videobuf2-v4l2.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-device.h>\n\n#include \"dbgfs.h\"\n#include \"hfi.h\"\n#include \"hfi_platform.h\"\n#include \"hfi_helper.h\"\n\n#define VDBGL\t\"VenusLow : \"\n#define VDBGM\t\"VenusMed : \"\n#define VDBGH\t\"VenusHigh: \"\n#define VDBGFW\t\"VenusFW  : \"\n\n#define VIDC_CLKS_NUM_MAX\t\t4\n#define VIDC_VCODEC_CLKS_NUM_MAX\t2\n#define VIDC_PMDOMAINS_NUM_MAX\t\t3\n#define VIDC_RESETS_NUM_MAX\t\t2\n\nextern int venus_fw_debug;\n\nstruct freq_tbl {\n\tunsigned int load;\n\tunsigned long freq;\n};\n\nstruct reg_val {\n\tu32 reg;\n\tu32 value;\n};\n\nstruct bw_tbl {\n\tu32 mbs_per_sec;\n\tu32 avg;\n\tu32 peak;\n\tu32 avg_10bit;\n\tu32 peak_10bit;\n};\n\nenum vpu_version {\n\tVPU_VERSION_AR50,\n\tVPU_VERSION_AR50_LITE,\n\tVPU_VERSION_IRIS1,\n\tVPU_VERSION_IRIS2,\n\tVPU_VERSION_IRIS2_1,\n};\n\nstruct venus_resources {\n\tu64 dma_mask;\n\tconst struct freq_tbl *freq_tbl;\n\tunsigned int freq_tbl_size;\n\tconst struct bw_tbl *bw_tbl_enc;\n\tunsigned int bw_tbl_enc_size;\n\tconst struct bw_tbl *bw_tbl_dec;\n\tunsigned int bw_tbl_dec_size;\n\tconst struct reg_val *reg_tbl;\n\tunsigned int reg_tbl_size;\n\tconst struct hfi_ubwc_config *ubwc_conf;\n\tconst char * const clks[VIDC_CLKS_NUM_MAX];\n\tunsigned int clks_num;\n\tconst char * const vcodec0_clks[VIDC_VCODEC_CLKS_NUM_MAX];\n\tconst char * const vcodec1_clks[VIDC_VCODEC_CLKS_NUM_MAX];\n\tunsigned int vcodec_clks_num;\n\tconst char * const vcodec_pmdomains[VIDC_PMDOMAINS_NUM_MAX];\n\tunsigned int vcodec_pmdomains_num;\n\tconst char **opp_pmdomain;\n\tunsigned int vcodec_num;\n\tconst char * const resets[VIDC_RESETS_NUM_MAX];\n\tunsigned int resets_num;\n\tenum hfi_version hfi_version;\n\tenum vpu_version vpu_version;\n\tu8 num_vpp_pipes;\n\tu32 max_load;\n\tunsigned int vmem_id;\n\tu32 vmem_size;\n\tu32 vmem_addr;\n\tu32 cp_start;\n\tu32 cp_size;\n\tu32 cp_nonpixel_start;\n\tu32 cp_nonpixel_size;\n\tconst char *fwname;\n};\n\nenum venus_fmt {\n\tVENUS_FMT_NV12\t\t\t= 0,\n\tVENUS_FMT_QC08C\t\t\t= 1,\n\tVENUS_FMT_QC10C\t\t\t= 2,\n\tVENUS_FMT_P010\t\t\t= 3,\n\tVENUS_FMT_H264\t\t\t= 4,\n\tVENUS_FMT_VP8\t\t\t= 5,\n\tVENUS_FMT_VP9\t\t\t= 6,\n\tVENUS_FMT_HEVC\t\t\t= 7,\n\tVENUS_FMT_VC1_ANNEX_G\t\t= 8,\n\tVENUS_FMT_VC1_ANNEX_L\t\t= 9,\n\tVENUS_FMT_MPEG4\t\t\t= 10,\n\tVENUS_FMT_MPEG2\t\t\t= 11,\n\tVENUS_FMT_H263\t\t\t= 12,\n\tVENUS_FMT_XVID\t\t\t= 13,\n};\n\nstruct venus_format {\n\tu32 pixfmt;\n\tunsigned int num_planes;\n\tu32 type;\n\tu32 flags;\n};\n\n \nstruct venus_core {\n\tvoid __iomem *base;\n\tvoid __iomem *vbif_base;\n\tvoid __iomem *cpu_base;\n\tvoid __iomem *cpu_cs_base;\n\tvoid __iomem *cpu_ic_base;\n\tvoid __iomem *wrapper_base;\n\tvoid __iomem *wrapper_tz_base;\n\tvoid __iomem *aon_base;\n\tint irq;\n\tstruct clk *clks[VIDC_CLKS_NUM_MAX];\n\tstruct clk *vcodec0_clks[VIDC_VCODEC_CLKS_NUM_MAX];\n\tstruct clk *vcodec1_clks[VIDC_VCODEC_CLKS_NUM_MAX];\n\tstruct icc_path *video_path;\n\tstruct icc_path *cpucfg_path;\n\tbool has_opp_table;\n\tstruct device *pmdomains[VIDC_PMDOMAINS_NUM_MAX];\n\tstruct device_link *opp_dl_venus;\n\tstruct device *opp_pmdomain;\n\tstruct reset_control *resets[VIDC_RESETS_NUM_MAX];\n\tstruct video_device *vdev_dec;\n\tstruct video_device *vdev_enc;\n\tstruct v4l2_device v4l2_dev;\n\tconst struct venus_resources *res;\n\tstruct device *dev;\n\tstruct device *dev_dec;\n\tstruct device *dev_enc;\n\tunsigned int use_tz;\n\tstruct video_firmware {\n\t\tstruct device *dev;\n\t\tstruct iommu_domain *iommu_domain;\n\t\tsize_t mapped_mem_size;\n\t\tphys_addr_t mem_phys;\n\t\tsize_t mem_size;\n\t} fw;\n\tstruct mutex lock;\n\tstruct list_head instances;\n\tatomic_t insts_count;\n\tunsigned int state;\n\tstruct completion done;\n\tunsigned int error;\n\tunsigned long sys_error;\n\twait_queue_head_t sys_err_done;\n\tconst struct hfi_core_ops *core_ops;\n\tconst struct venus_pm_ops *pm_ops;\n\tstruct mutex pm_lock;\n\tunsigned long enc_codecs;\n\tunsigned long dec_codecs;\n\tunsigned int max_sessions_supported;\n\tvoid *priv;\n\tconst struct hfi_ops *ops;\n\tstruct delayed_work work;\n\tstruct hfi_plat_caps caps[MAX_CODEC_NUM];\n\tunsigned int codecs_count;\n\tunsigned int core0_usage_count;\n\tunsigned int core1_usage_count;\n\tstruct dentry *root;\n\tstruct venus_img_version {\n\t\tu32 major;\n\t\tu32 minor;\n\t\tu32 rev;\n\t} venus_ver;\n};\n\nstruct vdec_controls {\n\tu32 post_loop_deb_mode;\n\tu32 profile;\n\tu32 level;\n\tu32 display_delay;\n\tu32 display_delay_enable;\n\tu64 conceal_color;\n};\n\nstruct venc_controls {\n\tu16 gop_size;\n\tu32 num_p_frames;\n\tu32 num_b_frames;\n\tu32 bitrate_mode;\n\tu32 bitrate;\n\tu32 bitrate_peak;\n\tu32 rc_enable;\n\tu32 const_quality;\n\tu32 frame_skip_mode;\n\n\tu32 h264_i_period;\n\tu32 h264_entropy_mode;\n\tu32 h264_i_qp;\n\tu32 h264_p_qp;\n\tu32 h264_b_qp;\n\tu32 h264_min_qp;\n\tu32 h264_max_qp;\n\tu32 h264_i_min_qp;\n\tu32 h264_i_max_qp;\n\tu32 h264_p_min_qp;\n\tu32 h264_p_max_qp;\n\tu32 h264_b_min_qp;\n\tu32 h264_b_max_qp;\n\tu32 h264_loop_filter_mode;\n\ts32 h264_loop_filter_alpha;\n\ts32 h264_loop_filter_beta;\n\tu32 h264_8x8_transform;\n\n\tu32 hevc_i_qp;\n\tu32 hevc_p_qp;\n\tu32 hevc_b_qp;\n\tu32 hevc_min_qp;\n\tu32 hevc_max_qp;\n\tu32 hevc_i_min_qp;\n\tu32 hevc_i_max_qp;\n\tu32 hevc_p_min_qp;\n\tu32 hevc_p_max_qp;\n\tu32 hevc_b_min_qp;\n\tu32 hevc_b_max_qp;\n\n\tu32 vp8_min_qp;\n\tu32 vp8_max_qp;\n\n\tu32 multi_slice_mode;\n\tu32 multi_slice_max_bytes;\n\tu32 multi_slice_max_mb;\n\n\tu32 header_mode;\n\tbool aud_enable;\n\tu32 intra_refresh_type;\n\tu32 intra_refresh_period;\n\n\tstruct {\n\t\tu32 h264;\n\t\tu32 mpeg4;\n\t\tu32 hevc;\n\t\tu32 vp8;\n\t\tu32 vp9;\n\t} profile;\n\tstruct {\n\t\tu32 h264;\n\t\tu32 mpeg4;\n\t\tu32 hevc;\n\t\tu32 vp9;\n\t} level;\n\n\tu32 base_priority_id;\n\tu32 ltr_count;\n\tstruct v4l2_ctrl_hdr10_cll_info cll;\n\tstruct v4l2_ctrl_hdr10_mastering_display mastering;\n};\n\nstruct venus_buffer {\n\tstruct vb2_v4l2_buffer vb;\n\tstruct list_head list;\n\tdma_addr_t dma_addr;\n\tu32 size;\n\tstruct list_head reg_list;\n\tu32 flags;\n\tstruct list_head ref_list;\n};\n\nstruct clock_data {\n\tu32 core_id;\n\tunsigned long freq;\n\tunsigned long vpp_freq;\n\tunsigned long vsp_freq;\n\tunsigned long low_power_freq;\n};\n\n#define to_venus_buffer(ptr)\tcontainer_of(ptr, struct venus_buffer, vb)\n\nenum venus_dec_state {\n\tVENUS_DEC_STATE_DEINIT\t\t= 0,\n\tVENUS_DEC_STATE_INIT\t\t= 1,\n\tVENUS_DEC_STATE_CAPTURE_SETUP\t= 2,\n\tVENUS_DEC_STATE_STOPPED\t\t= 3,\n\tVENUS_DEC_STATE_SEEK\t\t= 4,\n\tVENUS_DEC_STATE_DRAIN\t\t= 5,\n\tVENUS_DEC_STATE_DECODING\t= 6,\n\tVENUS_DEC_STATE_DRC\t\t= 7,\n};\n\nenum venus_enc_state {\n\tVENUS_ENC_STATE_DEINIT\t\t= 0,\n\tVENUS_ENC_STATE_INIT\t\t= 1,\n\tVENUS_ENC_STATE_ENCODING\t= 2,\n\tVENUS_ENC_STATE_STOPPED\t\t= 3,\n\tVENUS_ENC_STATE_DRAIN\t\t= 4,\n};\n\nstruct venus_ts_metadata {\n\tbool used;\n\tu64 ts_ns;\n\tu64 ts_us;\n\tu32 flags;\n\tstruct v4l2_timecode tc;\n};\n\nenum venus_inst_modes {\n\tVENUS_LOW_POWER = BIT(0),\n};\n\n \nstruct venus_inst {\n\tstruct list_head list;\n\tstruct mutex lock;\n\tstruct venus_core *core;\n\tstruct clock_data clk_data;\n\tstruct list_head dpbbufs;\n\tstruct list_head internalbufs;\n\tstruct list_head registeredbufs;\n\tstruct list_head delayed_process;\n\tstruct work_struct delayed_process_work;\n\tbool nonblock;\n\n\tstruct v4l2_ctrl_handler ctrl_handler;\n\tunion {\n\t\tstruct vdec_controls dec;\n\t\tstruct venc_controls enc;\n\t} controls;\n\tstruct v4l2_fh fh;\n\tunsigned int streamon_cap, streamon_out;\n\tu32 width;\n\tu32 height;\n\tstruct v4l2_rect crop;\n\tu32 fw_min_cnt;\n\tu32 out_width;\n\tu32 out_height;\n\tu32 colorspace;\n\tu8 ycbcr_enc;\n\tu8 quantization;\n\tu8 xfer_func;\n\tenum venus_dec_state codec_state;\n\tenum venus_enc_state enc_state;\n\twait_queue_head_t reconf_wait;\n\tunsigned int subscriptions;\n\tint buf_count;\n\tstruct venus_ts_metadata tss[VIDEO_MAX_FRAME];\n\tunsigned long payloads[VIDEO_MAX_FRAME];\n\tu64 fps;\n\tstruct v4l2_fract timeperframe;\n\tconst struct venus_format *fmt_out;\n\tconst struct venus_format *fmt_cap;\n\tunsigned int num_input_bufs;\n\tunsigned int num_output_bufs;\n\tunsigned int input_buf_size;\n\tunsigned int output_buf_size;\n\tunsigned int output2_buf_size;\n\tu32 dpb_buftype;\n\tu32 dpb_fmt;\n\tu32 opb_buftype;\n\tu32 opb_fmt;\n\tbool reconfig;\n\tu32 hfi_codec;\n\tu32 sequence_cap;\n\tu32 sequence_out;\n\tstruct v4l2_m2m_dev *m2m_dev;\n\tstruct v4l2_m2m_ctx *m2m_ctx;\n\tstruct mutex ctx_q_lock;\n\tunsigned int state;\n\tstruct completion done;\n\tunsigned int error;\n\tbool session_error;\n\tconst struct hfi_inst_ops *ops;\n\tu32 session_type;\n\tunion hfi_get_property hprop;\n\tunsigned int core_acquired: 1;\n\tunsigned int bit_depth;\n\tunsigned int pic_struct;\n\tbool next_buf_last;\n\tbool drain_active;\n\tenum venus_inst_modes flags;\n\tstruct ida dpb_ids;\n};\n\n#define IS_V1(core)\t((core)->res->hfi_version == HFI_VERSION_1XX)\n#define IS_V3(core)\t((core)->res->hfi_version == HFI_VERSION_3XX)\n#define IS_V4(core)\t((core)->res->hfi_version == HFI_VERSION_4XX)\n#define IS_V6(core)\t((core)->res->hfi_version == HFI_VERSION_6XX)\n\n#define IS_AR50(core)\t\t((core)->res->vpu_version == VPU_VERSION_AR50)\n#define IS_AR50_LITE(core)\t((core)->res->vpu_version == VPU_VERSION_AR50_LITE)\n#define IS_IRIS1(core)\t\t((core)->res->vpu_version == VPU_VERSION_IRIS1)\n#define IS_IRIS2(core)\t\t((core)->res->vpu_version == VPU_VERSION_IRIS2)\n#define IS_IRIS2_1(core)\t((core)->res->vpu_version == VPU_VERSION_IRIS2_1)\n\n#define ctrl_to_inst(ctrl)\t\\\n\tcontainer_of((ctrl)->handler, struct venus_inst, ctrl_handler)\n\nstatic inline struct venus_inst *to_inst(struct file *filp)\n{\n\treturn container_of(filp->private_data, struct venus_inst, fh);\n}\n\nstatic inline void *to_hfi_priv(struct venus_core *core)\n{\n\treturn core->priv;\n}\n\nstatic inline struct hfi_plat_caps *\nvenus_caps_by_codec(struct venus_core *core, u32 codec, u32 domain)\n{\n\tunsigned int c;\n\n\tfor (c = 0; c < core->codecs_count; c++) {\n\t\tif (core->caps[c].codec == codec &&\n\t\t    core->caps[c].domain == domain)\n\t\t\treturn &core->caps[c];\n\t}\n\n\treturn NULL;\n}\n\nstatic inline bool\nis_fw_rev_or_newer(struct venus_core *core, u32 vmajor, u32 vminor, u32 vrev)\n{\n\treturn ((core)->venus_ver.major == vmajor &&\n\t\t(core)->venus_ver.minor == vminor &&\n\t\t(core)->venus_ver.rev >= vrev);\n}\n\nstatic inline bool\nis_fw_rev_or_older(struct venus_core *core, u32 vmajor, u32 vminor, u32 vrev)\n{\n\treturn ((core)->venus_ver.major == vmajor &&\n\t\t(core)->venus_ver.minor == vminor &&\n\t\t(core)->venus_ver.rev <= vrev);\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}