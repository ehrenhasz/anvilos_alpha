{
  "module_name": "hfi_plat_bufs_v6.c",
  "hash_id": "45f177ac89ab1f79d26f16d4e5ea00de5402503fd9a8eb9210194f8c7edd1663",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/qcom/venus/hfi_plat_bufs_v6.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/sizes.h>\n#include <linux/videodev2.h>\n\n#include \"hfi.h\"\n#include \"hfi_plat_bufs.h\"\n#include \"helpers.h\"\n\n#define MIN_INPUT_BUFFERS\t\t\t\t4\n#define MIN_ENC_OUTPUT_BUFFERS\t\t\t\t4\n\n#define NV12_UBWC_Y_TILE_WIDTH\t\t\t\t32\n#define NV12_UBWC_Y_TILE_HEIGHT\t\t\t\t8\n#define NV12_UBWC_UV_TILE_WIDTH\t\t\t\t16\n#define NV12_UBWC_UV_TILE_HEIGHT\t\t\t8\n#define TP10_UBWC_Y_TILE_WIDTH\t\t\t\t48\n#define TP10_UBWC_Y_TILE_HEIGHT\t\t\t\t4\n#define METADATA_STRIDE_MULTIPLE\t\t\t64\n#define METADATA_HEIGHT_MULTIPLE\t\t\t16\n#define HFI_DMA_ALIGNMENT\t\t\t\t256\n\n#define MAX_FE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE\t\t64\n#define MAX_FE_NBR_CTRL_LCU32_LINE_BUFFER_SIZE\t\t64\n#define MAX_FE_NBR_CTRL_LCU16_LINE_BUFFER_SIZE\t\t64\n#define MAX_FE_NBR_DATA_LUMA_LINE_BUFFER_SIZE\t\t640\n#define MAX_FE_NBR_DATA_CB_LINE_BUFFER_SIZE\t\t320\n#define MAX_FE_NBR_DATA_CR_LINE_BUFFER_SIZE\t\t320\n\n#define MAX_SE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE\t\t(128 / 8)\n#define MAX_SE_NBR_CTRL_LCU32_LINE_BUFFER_SIZE\t\t(128 / 8)\n#define MAX_SE_NBR_CTRL_LCU16_LINE_BUFFER_SIZE\t\t(128 / 8)\n\n#define MAX_PE_NBR_DATA_LCU64_LINE_BUFFER_SIZE\t\t(64 * 2 * 3)\n#define MAX_PE_NBR_DATA_LCU32_LINE_BUFFER_SIZE\t\t(32 * 2 * 3)\n#define MAX_PE_NBR_DATA_LCU16_LINE_BUFFER_SIZE\t\t(16 * 2 * 3)\n\n#define MAX_TILE_COLUMNS\t\t\t\t32  \n\n#define VPP_CMD_MAX_SIZE\t\t\t\tBIT(20)\n#define NUM_HW_PIC_BUF\t\t\t\t\t32\n#define BIN_BUFFER_THRESHOLD\t\t\t\t(1280 * 736)\n#define H264D_MAX_SLICE\t\t\t\t\t1800\n \n#define SIZE_H264D_BUFTAB_T\t\t\t\t256\n \n#define SIZE_H264D_HW_PIC_T\t\t\t\tBIT(11)\n#define SIZE_H264D_BSE_CMD_PER_BUF\t\t\t(32 * 4)\n#define SIZE_H264D_VPP_CMD_PER_BUF\t\t\t512\n\n \n#define SIZE_H264D_LB_FE_TOP_DATA(width, height)\t\\\n\t(MAX_FE_NBR_DATA_LUMA_LINE_BUFFER_SIZE * ALIGN((width), 16) * 3)\n\n#define SIZE_H264D_LB_FE_TOP_CTRL(width, height)\t\\\n\t(MAX_FE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE * (((width) + 15) >> 4))\n\n#define SIZE_H264D_LB_FE_LEFT_CTRL(width, height)\t\\\n\t(MAX_FE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE * (((height) + 15) >> 4))\n\n#define SIZE_H264D_LB_SE_TOP_CTRL(width, height)\t\\\n\t(MAX_SE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE * (((width) + 15) >> 4))\n\n#define SIZE_H264D_LB_SE_LEFT_CTRL(width, height)\t\\\n\t(MAX_SE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE * (((height) + 15) >> 4))\n\n#define SIZE_H264D_LB_PE_TOP_DATA(width, height)\t\\\n\t(MAX_PE_NBR_DATA_LCU64_LINE_BUFFER_SIZE * (((width) + 15) >> 4))\n\n#define SIZE_H264D_LB_VSP_TOP(width, height)\t(((((width) + 15) >> 4) << 7))\n\n#define SIZE_H264D_LB_RECON_DMA_METADATA_WR(width, height)\t\\\n\t(ALIGN((height), 16) * 32)\n\n#define SIZE_H264D_QP(width, height)\t\\\n\t((((width) + 63) >> 6) * (((height) + 63) >> 6) * 128)\n\n#define SIZE_HW_PIC(size_per_buf)\t(NUM_HW_PIC_BUF * (size_per_buf))\n\n#define H264_CABAC_HDR_RATIO_HD_TOT\t1\n#define H264_CABAC_RES_RATIO_HD_TOT\t3\n\n \n#define NUM_SLIST_BUF_H264\t\t(256 + 32)\n#define SIZE_SLIST_BUF_H264\t\t512\n#define LCU_MAX_SIZE_PELS\t\t64\n#define LCU_MIN_SIZE_PELS\t\t16\n#define SIZE_SEI_USERDATA\t\t4096\n\n#define H265D_MAX_SLICE\t\t\t3600\n#define SIZE_H265D_HW_PIC_T\t\tSIZE_H264D_HW_PIC_T\n#define SIZE_H265D_BSE_CMD_PER_BUF\t(16 * sizeof(u32))\n#define SIZE_H265D_VPP_CMD_PER_BUF\t256\n\n#define SIZE_H265D_LB_FE_TOP_DATA(width, height)\t\\\n\t(MAX_FE_NBR_DATA_LUMA_LINE_BUFFER_SIZE * (ALIGN(width, 64) + 8) * 2)\n\n#define SIZE_H265D_LB_FE_TOP_CTRL(width, height)\t\\\n\t(MAX_FE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE *\t\\\n\t(ALIGN(width, LCU_MAX_SIZE_PELS) / LCU_MIN_SIZE_PELS))\n\n#define SIZE_H265D_LB_FE_LEFT_CTRL(width, height)\t\\\n\t(MAX_FE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE *\t\\\n\t(ALIGN(height, LCU_MAX_SIZE_PELS) / LCU_MIN_SIZE_PELS))\n\n#define SIZE_H265D_LB_SE_TOP_CTRL(width, height)\t\\\n\t((LCU_MAX_SIZE_PELS / 8 * (128 / 8)) * (((width) + 15) >> 4))\n\nstatic inline u32 size_h265d_lb_se_left_ctrl(u32 width, u32 height)\n{\n\tu32 x, y, z;\n\n\tx = ((height + 16 - 1) / 8) * MAX_SE_NBR_CTRL_LCU16_LINE_BUFFER_SIZE;\n\ty = ((height + 32 - 1) / 8) * MAX_SE_NBR_CTRL_LCU32_LINE_BUFFER_SIZE;\n\tz = ((height + 64 - 1) / 8) * MAX_SE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE;\n\n\treturn max3(x, y, z);\n}\n\n#define SIZE_H265D_LB_PE_TOP_DATA(width, height)\t\\\n\t(MAX_PE_NBR_DATA_LCU64_LINE_BUFFER_SIZE *\t\\\n\t(ALIGN(width, LCU_MIN_SIZE_PELS) / LCU_MIN_SIZE_PELS))\n\n#define SIZE_H265D_LB_VSP_TOP(width, height)\t((((width) + 63) >> 6) * 128)\n\n#define SIZE_H265D_LB_VSP_LEFT(width, height)\t((((height) + 63) >> 6) * 128)\n\n#define SIZE_H265D_LB_RECON_DMA_METADATA_WR(width, height)\t\\\n\tSIZE_H264D_LB_RECON_DMA_METADATA_WR(width, height)\n\n#define SIZE_H265D_QP(width, height)\tSIZE_H264D_QP(width, height)\n\n#define H265_CABAC_HDR_RATIO_HD_TOT\t2\n#define H265_CABAC_RES_RATIO_HD_TOT\t2\n\n \n#define SIZE_SLIST_BUF_H265\tBIT(10)\n#define NUM_SLIST_BUF_H265\t(80 + 20)\n#define H265_NUM_TILE_COL\t32\n#define H265_NUM_TILE_ROW\t128\n#define H265_NUM_TILE\t\t(H265_NUM_TILE_ROW * H265_NUM_TILE_COL + 1)\n\nstatic inline u32 size_vpxd_lb_fe_left_ctrl(u32 width, u32 height)\n{\n\tu32 x, y, z;\n\n\tx = ((height + 15) >> 4) * MAX_FE_NBR_CTRL_LCU16_LINE_BUFFER_SIZE;\n\ty = ((height + 31) >> 5) * MAX_FE_NBR_CTRL_LCU32_LINE_BUFFER_SIZE;\n\tz = ((height + 63) >> 6) * MAX_FE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE;\n\n\treturn max3(x, y, z);\n}\n\n#define SIZE_VPXD_LB_FE_TOP_CTRL(width, height)\t\t\\\n\t(((ALIGN(width, 64) + 8) * 10 * 2))  \n#define SIZE_VPXD_LB_SE_TOP_CTRL(width, height) \\\n\t((((width) + 15) >> 4) * MAX_FE_NBR_CTRL_LCU16_LINE_BUFFER_SIZE)\n\nstatic inline u32 size_vpxd_lb_se_left_ctrl(u32 width, u32 height)\n{\n\tu32 x, y, z;\n\n\tx = ((height + 15) >> 4) * MAX_SE_NBR_CTRL_LCU16_LINE_BUFFER_SIZE;\n\ty = ((height + 31) >> 5) * MAX_SE_NBR_CTRL_LCU32_LINE_BUFFER_SIZE;\n\tz = ((height + 63) >> 6) * MAX_SE_NBR_CTRL_LCU64_LINE_BUFFER_SIZE;\n\n\treturn max3(x, y, z);\n}\n\n#define SIZE_VPXD_LB_RECON_DMA_METADATA_WR(width, height)\t\\\n\tALIGN((ALIGN(height, 16) / (4 / 2)) * 64, 32)\n#define SIZE_VP8D_LB_FE_TOP_DATA(width, height)\t\t\t\\\n\t((ALIGN(width, 16) + 8) * 10 * 2)\n#define SIZE_VP9D_LB_FE_TOP_DATA(width, height)\t\t\t\\\n\t((ALIGN(ALIGN(width, 16), 64) + 8) * 10 * 2)\n#define SIZE_VP8D_LB_PE_TOP_DATA(width, height)\t\t\t\\\n\t((ALIGN(width, 16) >> 4) * 64)\n#define SIZE_VP9D_LB_PE_TOP_DATA(width, height)\t\t\t\\\n\t((ALIGN(ALIGN(width, 16), 64) >> 6) * 176)\n#define SIZE_VP8D_LB_VSP_TOP(width, height)\t\t\t\\\n\t(((ALIGN(width, 16) >> 4) * 64 / 2) + 256)\n#define SIZE_VP9D_LB_VSP_TOP(width, height)\t\t\t\\\n\t(((ALIGN(ALIGN(width, 16), 64) >> 6) * 64 * 8) + 256)\n\n#define HFI_IRIS2_VP9D_COMV_SIZE\t\t\t\t\\\n\t((((8192 + 63) >> 6) * ((4320 + 63) >> 6) * 8 * 8 * 2 * 8))\n\n#define VPX_DECODER_FRAME_CONCURENCY_LVL\t\t2\n#define VPX_DECODER_FRAME_BIN_HDR_BUDGET_RATIO_NUM\t1\n#define VPX_DECODER_FRAME_BIN_HDR_BUDGET_RATIO_DEN\t2\n#define VPX_DECODER_FRAME_BIN_RES_BUDGET_RATIO_NUM\t3\n#define VPX_DECODER_FRAME_BIN_RES_BUDGET_RATIO_DEN\t2\n\n#define VP8_NUM_FRAME_INFO_BUF\t\t\t(5 + 1)\n#define VP9_NUM_FRAME_INFO_BUF\t\t\t32\n#define VP8_NUM_PROBABILITY_TABLE_BUF\t\tVP8_NUM_FRAME_INFO_BUF\n#define VP9_NUM_PROBABILITY_TABLE_BUF\t\t(VP9_NUM_FRAME_INFO_BUF + 4)\n#define VP8_PROB_TABLE_SIZE\t\t\t3840\n#define VP9_PROB_TABLE_SIZE\t\t\t3840\n\n#define VP9_UDC_HEADER_BUF_SIZE\t\t\t(3 * 128)\n#define MAX_SUPERFRAME_HEADER_LEN\t\t34\n#define CCE_TILE_OFFSET_SIZE\t\t\tALIGN(32 * 4 * 4, 32)\n\n#define QMATRIX_SIZE\t\t\t\t(sizeof(u32) * 128 + 256)\n#define MP2D_QPDUMP_SIZE\t\t\t115200\n#define HFI_IRIS2_ENC_PERSIST_SIZE\t\t204800\n#define HFI_MAX_COL_FRAME\t\t\t6\n#define HFI_VENUS_VENC_TRE_WB_BUFF_SIZE\t\t(65 << 4)  \n#define HFI_VENUS_VENC_DB_LINE_BUFF_PER_MB\t512\n#define HFI_VENUS_VPPSG_MAX_REGISTERS\t\t2048\n#define HFI_VENUS_WIDTH_ALIGNMENT\t\t128\n#define HFI_VENUS_WIDTH_TEN_BIT_ALIGNMENT\t192\n#define HFI_VENUS_HEIGHT_ALIGNMENT\t\t32\n\n#define SYSTEM_LAL_TILE10\t192\n#define NUM_MBS_720P\t\t(((1280 + 15) >> 4) * ((720 + 15) >> 4))\n#define NUM_MBS_4K\t\t(((4096 + 15) >> 4) * ((2304 + 15) >> 4))\n#define MB_SIZE_IN_PIXEL\t(16 * 16)\n#define HDR10PLUS_PAYLOAD_SIZE\t\t1024\n#define HDR10_HIST_EXTRADATA_SIZE\t4096\n\nstatic u32 size_vpss_lb(u32 width, u32 height, u32 num_vpp_pipes)\n{\n\tu32 vpss_4tap_top_buffer_size, vpss_div2_top_buffer_size;\n\tu32 vpss_4tap_left_buffer_size, vpss_div2_left_buffer_size;\n\tu32 opb_wr_top_line_luma_buf_size, opb_wr_top_line_chroma_buf_size;\n\tu32 opb_lb_wr_llb_y_buffer_size, opb_lb_wr_llb_uv_buffer_size;\n\tu32 macrotiling_size;\n\tu32 size = 0;\n\n\tvpss_4tap_top_buffer_size = 0;\n\tvpss_div2_top_buffer_size = 0;\n\tvpss_4tap_left_buffer_size = 0;\n\tvpss_div2_left_buffer_size = 0;\n\n\tmacrotiling_size = 32;\n\topb_wr_top_line_luma_buf_size =\n\t\tALIGN(width, macrotiling_size) / macrotiling_size * 256;\n\topb_wr_top_line_luma_buf_size =\n\t\tALIGN(opb_wr_top_line_luma_buf_size, HFI_DMA_ALIGNMENT) +\n\t\t(MAX_TILE_COLUMNS - 1) * 256;\n\topb_wr_top_line_luma_buf_size =\n\t\tmax(opb_wr_top_line_luma_buf_size, (32 * ALIGN(height, 16)));\n\topb_wr_top_line_chroma_buf_size = opb_wr_top_line_luma_buf_size;\n\topb_lb_wr_llb_y_buffer_size = ALIGN((ALIGN(height, 16) / 2) * 64, 32);\n\topb_lb_wr_llb_uv_buffer_size = opb_lb_wr_llb_y_buffer_size;\n\tsize = num_vpp_pipes *\n\t\t2 * (vpss_4tap_top_buffer_size + vpss_div2_top_buffer_size) +\n\t\t2 * (vpss_4tap_left_buffer_size + vpss_div2_left_buffer_size) +\n\t\topb_wr_top_line_luma_buf_size +\n\t\topb_wr_top_line_chroma_buf_size +\n\t\topb_lb_wr_llb_uv_buffer_size +\n\t\topb_lb_wr_llb_y_buffer_size;\n\n\treturn size;\n}\n\nstatic u32 size_h264d_hw_bin_buffer(u32 width, u32 height)\n{\n\tu32 size_yuv, size_bin_hdr, size_bin_res;\n\tu32 size = 0;\n\tu32 product;\n\n\tproduct = width * height;\n\tsize_yuv = (product <= BIN_BUFFER_THRESHOLD) ?\n\t\t((BIN_BUFFER_THRESHOLD * 3) >> 1) : ((product * 3) >> 1);\n\n\tsize_bin_hdr = size_yuv * H264_CABAC_HDR_RATIO_HD_TOT;\n\tsize_bin_res = size_yuv * H264_CABAC_RES_RATIO_HD_TOT;\n\tsize_bin_hdr = ALIGN(size_bin_hdr, HFI_DMA_ALIGNMENT);\n\tsize_bin_res = ALIGN(size_bin_res, HFI_DMA_ALIGNMENT);\n\tsize = size_bin_hdr + size_bin_res;\n\n\treturn size;\n}\n\nstatic u32 h264d_scratch_size(u32 width, u32 height, bool is_interlaced)\n{\n\tu32 aligned_width = ALIGN(width, 16);\n\tu32 aligned_height = ALIGN(height, 16);\n\tu32 size = 0;\n\n\tif (!is_interlaced)\n\t\tsize = size_h264d_hw_bin_buffer(aligned_width, aligned_height);\n\n\treturn size;\n}\n\nstatic u32 size_h265d_hw_bin_buffer(u32 width, u32 height)\n{\n\tu32 size_yuv, size_bin_hdr, size_bin_res;\n\tu32 size = 0;\n\tu32 product;\n\n\tproduct = width * height;\n\tsize_yuv = (product <= BIN_BUFFER_THRESHOLD) ?\n\t\t((BIN_BUFFER_THRESHOLD * 3) >> 1) : ((product * 3) >> 1);\n\tsize_bin_hdr = size_yuv * H265_CABAC_HDR_RATIO_HD_TOT;\n\tsize_bin_res = size_yuv * H265_CABAC_RES_RATIO_HD_TOT;\n\tsize_bin_hdr = ALIGN(size_bin_hdr, HFI_DMA_ALIGNMENT);\n\tsize_bin_res = ALIGN(size_bin_res, HFI_DMA_ALIGNMENT);\n\tsize = size_bin_hdr + size_bin_res;\n\n\treturn size;\n}\n\nstatic u32 h265d_scratch_size(u32 width, u32 height, bool is_interlaced)\n{\n\tu32 aligned_width = ALIGN(width, 16);\n\tu32 aligned_height = ALIGN(height, 16);\n\tu32 size = 0;\n\n\tif (!is_interlaced)\n\t\tsize = size_h265d_hw_bin_buffer(aligned_width, aligned_height);\n\n\treturn size;\n}\n\nstatic u32 vpxd_scratch_size(u32 width, u32 height, bool is_interlaced)\n{\n\tu32 aligned_width = ALIGN(width, 16);\n\tu32 aligned_height = ALIGN(height, 16);\n\tu32 size_yuv = aligned_width * aligned_height * 3 / 2;\n\tu32 size = 0;\n\n\tif (!is_interlaced) {\n\t\tu32 binbuffer1_size, binbufer2_size;\n\n\t\tbinbuffer1_size = max_t(u32, size_yuv,\n\t\t\t\t\t((BIN_BUFFER_THRESHOLD * 3) >> 1));\n\t\tbinbuffer1_size *= VPX_DECODER_FRAME_CONCURENCY_LVL *\n\t\t\t\t   VPX_DECODER_FRAME_BIN_HDR_BUDGET_RATIO_NUM /\n\t\t\t\t   VPX_DECODER_FRAME_BIN_HDR_BUDGET_RATIO_DEN;\n\t\tbinbufer2_size = max_t(u32, size_yuv,\n\t\t\t\t       ((BIN_BUFFER_THRESHOLD * 3) >> 1));\n\t\tbinbufer2_size *= VPX_DECODER_FRAME_CONCURENCY_LVL *\n\t\t\t\t  VPX_DECODER_FRAME_BIN_RES_BUDGET_RATIO_NUM /\n\t\t\t\t  VPX_DECODER_FRAME_BIN_RES_BUDGET_RATIO_DEN;\n\t\tsize = ALIGN(binbuffer1_size + binbufer2_size,\n\t\t\t     HFI_DMA_ALIGNMENT);\n\t}\n\n\treturn size;\n}\n\nstatic u32 mpeg2d_scratch_size(u32 width, u32 height, bool is_interlaced)\n{\n\treturn 0;\n}\n\nstatic u32 calculate_enc_output_frame_size(u32 width, u32 height, u32 rc_type)\n{\n\tu32 aligned_width, aligned_height;\n\tu32 mbs_per_frame;\n\tu32 frame_size;\n\n\t \n\taligned_width = ALIGN(width, 32);\n\taligned_height = ALIGN(height, 32);\n\tmbs_per_frame = (ALIGN(aligned_height, 16) *\n\t\t\t ALIGN(aligned_width, 16)) / 256;\n\tframe_size = width * height * 3;\n\n\tif (mbs_per_frame < NUM_MBS_720P)\n\t\tframe_size = frame_size << 1;\n\telse if (mbs_per_frame <= NUM_MBS_4K)\n\t\tframe_size = frame_size >> 2;\n\telse\n\t\tframe_size = frame_size >> 3;\n\n\tif (rc_type == HFI_RATE_CONTROL_OFF || rc_type == HFI_RATE_CONTROL_CQ)\n\t\tframe_size = frame_size << 1;\n\n\t \n\tframe_size *= 5;\n\tframe_size /= 4;\n\n\treturn ALIGN(frame_size, SZ_4K);\n}\n\nstatic u32 calculate_enc_scratch_size(u32 width, u32 height, u32 work_mode,\n\t\t\t\t      u32 lcu_size, u32 num_vpp_pipes,\n\t\t\t\t      u32 rc_type)\n{\n\tu32 aligned_width, aligned_height, bitstream_size;\n\tu32 total_bitbin_buffers, size_single_pipe, bitbin_size;\n\tu32 sao_bin_buffer_size, padded_bin_size, size;\n\n\taligned_width = ALIGN(width, lcu_size);\n\taligned_height = ALIGN(height, lcu_size);\n\tbitstream_size =\n\t\tcalculate_enc_output_frame_size(width, height, rc_type);\n\n\tbitstream_size = ALIGN(bitstream_size, HFI_DMA_ALIGNMENT);\n\n\tif (work_mode == VIDC_WORK_MODE_2) {\n\t\ttotal_bitbin_buffers = 3;\n\t\tbitbin_size = bitstream_size * 17 / 10;\n\t\tbitbin_size = ALIGN(bitbin_size, HFI_DMA_ALIGNMENT);\n\t} else {\n\t\ttotal_bitbin_buffers = 1;\n\t\tbitstream_size = aligned_width * aligned_height * 3;\n\t\tbitbin_size = ALIGN(bitstream_size, HFI_DMA_ALIGNMENT);\n\t}\n\n\tif (num_vpp_pipes > 2)\n\t\tsize_single_pipe = bitbin_size / 2;\n\telse\n\t\tsize_single_pipe = bitbin_size;\n\n\tsize_single_pipe = ALIGN(size_single_pipe, HFI_DMA_ALIGNMENT);\n\tsao_bin_buffer_size =\n\t\t(64 * (((width + 32) * (height + 32)) >> 10)) + 384;\n\tpadded_bin_size = ALIGN(size_single_pipe, HFI_DMA_ALIGNMENT);\n\tsize_single_pipe = sao_bin_buffer_size + padded_bin_size;\n\tsize_single_pipe = ALIGN(size_single_pipe, HFI_DMA_ALIGNMENT);\n\tbitbin_size = size_single_pipe * num_vpp_pipes;\n\tsize = ALIGN(bitbin_size, HFI_DMA_ALIGNMENT) *\n\t\ttotal_bitbin_buffers + 512;\n\n\treturn size;\n}\n\nstatic u32 h264e_scratch_size(u32 width, u32 height, u32 work_mode,\n\t\t\t      u32 num_vpp_pipes, u32 rc_type)\n{\n\treturn calculate_enc_scratch_size(width, height, work_mode, 16,\n\t\t\t\t\t  num_vpp_pipes, rc_type);\n}\n\nstatic u32 h265e_scratch_size(u32 width, u32 height, u32 work_mode,\n\t\t\t      u32 num_vpp_pipes, u32 rc_type)\n{\n\treturn calculate_enc_scratch_size(width, height, work_mode, 32,\n\t\t\t\t\t  num_vpp_pipes, rc_type);\n}\n\nstatic u32 vp8e_scratch_size(u32 width, u32 height, u32 work_mode,\n\t\t\t     u32 num_vpp_pipes, u32 rc_type)\n{\n\treturn calculate_enc_scratch_size(width, height, work_mode, 16,\n\t\t\t\t\t  num_vpp_pipes, rc_type);\n}\n\nstatic u32 hfi_iris2_h264d_comv_size(u32 width, u32 height,\n\t\t\t\t     u32 yuv_buf_min_count)\n{\n\tu32 frame_width_in_mbs = ((width + 15) >> 4);\n\tu32 frame_height_in_mbs = ((height + 15) >> 4);\n\tu32 col_mv_aligned_width = (frame_width_in_mbs << 7);\n\tu32 col_zero_aligned_width = (frame_width_in_mbs << 2);\n\tu32 col_zero_size = 0, size_colloc = 0, comv_size = 0;\n\n\tcol_mv_aligned_width = ALIGN(col_mv_aligned_width, 16);\n\tcol_zero_aligned_width = ALIGN(col_zero_aligned_width, 16);\n\tcol_zero_size =\n\t\tcol_zero_aligned_width * ((frame_height_in_mbs + 1) >> 1);\n\tcol_zero_size = ALIGN(col_zero_size, 64);\n\tcol_zero_size <<= 1;\n\tcol_zero_size = ALIGN(col_zero_size, 512);\n\tsize_colloc = col_mv_aligned_width * ((frame_height_in_mbs + 1) >> 1);\n\tsize_colloc = ALIGN(size_colloc, 64);\n\tsize_colloc <<= 1;\n\tsize_colloc = ALIGN(size_colloc, 512);\n\tsize_colloc += (col_zero_size + SIZE_H264D_BUFTAB_T * 2);\n\tcomv_size = size_colloc * yuv_buf_min_count;\n\tcomv_size += 512;\n\n\treturn comv_size;\n}\n\nstatic u32 size_h264d_bse_cmd_buf(u32 height)\n{\n\tu32 aligned_height = ALIGN(height, 32);\n\n\treturn min_t(u32, (((aligned_height + 15) >> 4) * 3 * 4),\n\t\t     H264D_MAX_SLICE) * SIZE_H264D_BSE_CMD_PER_BUF;\n}\n\nstatic u32 size_h264d_vpp_cmd_buf(u32 height)\n{\n\tu32 aligned_height = ALIGN(height, 32);\n\tu32 size;\n\n\tsize = min_t(u32, (((aligned_height + 15) >> 4) * 3 * 4),\n\t\t     H264D_MAX_SLICE) * SIZE_H264D_VPP_CMD_PER_BUF;\n\tif (size > VPP_CMD_MAX_SIZE)\n\t\tsize = VPP_CMD_MAX_SIZE;\n\n\treturn size;\n}\n\nstatic u32 hfi_iris2_h264d_non_comv_size(u32 width, u32 height,\n\t\t\t\t\t u32 num_vpp_pipes)\n{\n\tu32 size_bse, size_vpp, size;\n\n\tsize_bse = size_h264d_bse_cmd_buf(height);\n\tsize_vpp = size_h264d_vpp_cmd_buf(height);\n\tsize =\n\t\tALIGN(size_bse, HFI_DMA_ALIGNMENT) +\n\t\tALIGN(size_vpp, HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_HW_PIC(SIZE_H264D_HW_PIC_T), HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H264D_LB_FE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H264D_LB_FE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H264D_LB_FE_LEFT_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(SIZE_H264D_LB_SE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H264D_LB_SE_LEFT_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(SIZE_H264D_LB_PE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H264D_LB_VSP_TOP(width, height), HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H264D_LB_RECON_DMA_METADATA_WR(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * 2 +\n\t\tALIGN(SIZE_H264D_QP(width, height), HFI_DMA_ALIGNMENT);\n\n\treturn ALIGN(size, HFI_DMA_ALIGNMENT);\n}\n\nstatic u32 size_h265d_bse_cmd_buf(u32 width, u32 height)\n{\n\tu32 size;\n\n\tsize = (ALIGN(width, LCU_MAX_SIZE_PELS) / LCU_MIN_SIZE_PELS) *\n\t       (ALIGN(height, LCU_MAX_SIZE_PELS) / LCU_MIN_SIZE_PELS) *\n\t       NUM_HW_PIC_BUF;\n\tsize = min_t(u32, size, H265D_MAX_SLICE + 1);\n\tsize = 2 * size * SIZE_H265D_BSE_CMD_PER_BUF;\n\n\treturn ALIGN(size, HFI_DMA_ALIGNMENT);\n}\n\nstatic u32 size_h265d_vpp_cmd_buf(u32 width, u32 height)\n{\n\tu32 size;\n\n\tsize = (ALIGN(width, LCU_MAX_SIZE_PELS) / LCU_MIN_SIZE_PELS) *\n\t       (ALIGN(height, LCU_MAX_SIZE_PELS) / LCU_MIN_SIZE_PELS) *\n\t       NUM_HW_PIC_BUF;\n\tsize = min_t(u32, size, H265D_MAX_SLICE + 1);\n\tsize = ALIGN(size, 4);\n\tsize = 2 * size * SIZE_H265D_VPP_CMD_PER_BUF;\n\tsize = ALIGN(size, HFI_DMA_ALIGNMENT);\n\tif (size > VPP_CMD_MAX_SIZE)\n\t\tsize = VPP_CMD_MAX_SIZE;\n\n\treturn size;\n}\n\nstatic u32 hfi_iris2_h265d_comv_size(u32 width, u32 height,\n\t\t\t\t     u32 yuv_buf_count_min)\n{\n\tu32 size;\n\n\tsize = ALIGN(((((width + 15) >> 4) * ((height + 15) >> 4)) << 8), 512);\n\tsize *= yuv_buf_count_min;\n\tsize += 512;\n\n\treturn size;\n}\n\nstatic u32 hfi_iris2_h265d_non_comv_size(u32 width, u32 height,\n\t\t\t\t\t u32 num_vpp_pipes)\n{\n\tu32 size_bse, size_vpp, size;\n\n\tsize_bse = size_h265d_bse_cmd_buf(width, height);\n\tsize_vpp = size_h265d_vpp_cmd_buf(width, height);\n\tsize =\n\t\tALIGN(size_bse, HFI_DMA_ALIGNMENT) +\n\t\tALIGN(size_vpp, HFI_DMA_ALIGNMENT) +\n\t\tALIGN(NUM_HW_PIC_BUF * 20 * 22 * 4, HFI_DMA_ALIGNMENT) +\n\t\tALIGN(2 * sizeof(u16) *\n\t\t(ALIGN(width, LCU_MAX_SIZE_PELS) / LCU_MIN_SIZE_PELS) *\n\t\t(ALIGN(height, LCU_MAX_SIZE_PELS) / LCU_MIN_SIZE_PELS),\n\t\t       HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_HW_PIC(SIZE_H265D_HW_PIC_T), HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H265D_LB_FE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H265D_LB_FE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H265D_LB_FE_LEFT_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(size_h265d_lb_se_left_ctrl(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(SIZE_H265D_LB_SE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H265D_LB_PE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H265D_LB_VSP_TOP(width, height), HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_H265D_LB_VSP_LEFT(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(SIZE_H265D_LB_RECON_DMA_METADATA_WR(width, height),\n\t\t      HFI_DMA_ALIGNMENT)\n\t\t\t* 4 +\n\t\tALIGN(SIZE_H265D_QP(width, height), HFI_DMA_ALIGNMENT);\n\n\treturn ALIGN(size, HFI_DMA_ALIGNMENT);\n}\n\nstatic u32 hfi_iris2_vp8d_comv_size(u32 width, u32 height,\n\t\t\t\t    u32 yuv_min_buf_count)\n{\n\treturn (((width + 15) >> 4) * ((height + 15) >> 4) * 8 * 2);\n}\n\nstatic u32 h264d_scratch1_size(u32 width, u32 height, u32 min_buf_count,\n\t\t\t       bool split_mode_enabled, u32 num_vpp_pipes)\n{\n\tu32 co_mv_size, nonco_mv_size, vpss_lb_size = 0;\n\n\tco_mv_size = hfi_iris2_h264d_comv_size(width, height, min_buf_count);\n\tnonco_mv_size = hfi_iris2_h264d_non_comv_size(width, height,\n\t\t\t\t\t\t      num_vpp_pipes);\n\tif (split_mode_enabled)\n\t\tvpss_lb_size = size_vpss_lb(width, height, num_vpp_pipes);\n\n\treturn co_mv_size + nonco_mv_size + vpss_lb_size;\n}\n\nstatic u32 h265d_scratch1_size(u32 width, u32 height, u32 min_buf_count,\n\t\t\t       bool split_mode_enabled, u32 num_vpp_pipes)\n{\n\tu32 co_mv_size, nonco_mv_size, vpss_lb_size = 0;\n\n\tco_mv_size = hfi_iris2_h265d_comv_size(width, height, min_buf_count);\n\tnonco_mv_size = hfi_iris2_h265d_non_comv_size(width, height,\n\t\t\t\t\t\t      num_vpp_pipes);\n\tif (split_mode_enabled)\n\t\tvpss_lb_size = size_vpss_lb(width, height, num_vpp_pipes);\n\n\treturn co_mv_size + nonco_mv_size + vpss_lb_size +\n\t\tHDR10_HIST_EXTRADATA_SIZE;\n}\n\nstatic u32 vp8d_scratch1_size(u32 width, u32 height, u32 min_buf_count,\n\t\t\t      bool split_mode_enabled, u32 num_vpp_pipes)\n{\n\tu32 vpss_lb_size = 0, size;\n\n\tsize = hfi_iris2_vp8d_comv_size(width, height, 0);\n\tsize += ALIGN(size_vpxd_lb_fe_left_ctrl(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(size_vpxd_lb_se_left_ctrl(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(SIZE_VP8D_LB_VSP_TOP(width, height), HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VPXD_LB_FE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\t2 * ALIGN(SIZE_VPXD_LB_RECON_DMA_METADATA_WR(width, height),\n\t\t\t  HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VPXD_LB_SE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VP8D_LB_PE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VP8D_LB_FE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT);\n\tif (split_mode_enabled)\n\t\tvpss_lb_size = size_vpss_lb(width, height, num_vpp_pipes);\n\n\tsize += vpss_lb_size;\n\n\treturn size;\n}\n\nstatic u32 vp9d_scratch1_size(u32 width, u32 height, u32 min_buf_count,\n\t\t\t      bool split_mode_enabled, u32 num_vpp_pipes)\n{\n\tu32 vpss_lb_size = 0;\n\tu32 size;\n\n\tsize =\n\t\tALIGN(size_vpxd_lb_fe_left_ctrl(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(size_vpxd_lb_se_left_ctrl(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(SIZE_VP9D_LB_VSP_TOP(width, height), HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VPXD_LB_FE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\t2 * ALIGN(SIZE_VPXD_LB_RECON_DMA_METADATA_WR(width, height),\n\t\t\t  HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VPXD_LB_SE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VP9D_LB_PE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VP9D_LB_FE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT);\n\n\tif (split_mode_enabled)\n\t\tvpss_lb_size = size_vpss_lb(width, height, num_vpp_pipes);\n\n\tsize += vpss_lb_size + HDR10_HIST_EXTRADATA_SIZE;\n\n\treturn size;\n}\n\nstatic u32 mpeg2d_scratch1_size(u32 width, u32 height, u32 min_buf_count,\n\t\t\t\tbool split_mode_enabled, u32 num_vpp_pipes)\n{\n\tu32 vpss_lb_size = 0;\n\tu32 size;\n\n\tsize =\n\t\tALIGN(size_vpxd_lb_fe_left_ctrl(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(size_vpxd_lb_se_left_ctrl(width, height),\n\t\t      HFI_DMA_ALIGNMENT) * num_vpp_pipes +\n\t\tALIGN(SIZE_VP8D_LB_VSP_TOP(width, height), HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VPXD_LB_FE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\t2 * ALIGN(SIZE_VPXD_LB_RECON_DMA_METADATA_WR(width, height),\n\t\t\t  HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VPXD_LB_SE_TOP_CTRL(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VP8D_LB_PE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(SIZE_VP8D_LB_FE_TOP_DATA(width, height),\n\t\t      HFI_DMA_ALIGNMENT);\n\n\tif (split_mode_enabled)\n\t\tvpss_lb_size = size_vpss_lb(width, height, num_vpp_pipes);\n\n\tsize += vpss_lb_size;\n\n\treturn size;\n}\n\nstatic u32\ncalculate_enc_scratch1_size(u32 width, u32 height, u32 lcu_size, u32 num_ref,\n\t\t\t    bool ten_bit, u32 num_vpp_pipes, bool is_h265)\n{\n\tu32 line_buf_ctrl_size, line_buf_data_size, leftline_buf_ctrl_size;\n\tu32 line_buf_sde_size, sps_pps_slice_hdr, topline_buf_ctrl_size_FE;\n\tu32 leftline_buf_ctrl_size_FE, line_buf_recon_pix_size;\n\tu32 leftline_buf_recon_pix_size, lambda_lut_size, override_buffer_size;\n\tu32 col_mv_buf_size, vpp_reg_buffer_size, ir_buffer_size;\n\tu32 vpss_line_buf, leftline_buf_meta_recony, h265e_colrcbuf_size;\n\tu32 h265e_framerc_bufsize, h265e_lcubitcnt_bufsize;\n\tu32 h265e_lcubitmap_bufsize, se_stats_bufsize;\n\tu32 bse_reg_buffer_size, bse_slice_cmd_buffer_size, slice_info_bufsize;\n\tu32 line_buf_ctrl_size_buffid2, slice_cmd_buffer_size;\n\tu32 width_lcu_num, height_lcu_num, width_coded, height_coded;\n\tu32 frame_num_lcu, linebuf_meta_recon_uv, topline_bufsize_fe_1stg_sao;\n\tu32 size, bit_depth, num_lcu_mb;\n\tu32 vpss_line_buffer_size_1;\n\n\twidth_lcu_num = (width + lcu_size - 1) / lcu_size;\n\theight_lcu_num = (height + lcu_size - 1) / lcu_size;\n\tframe_num_lcu = width_lcu_num * height_lcu_num;\n\twidth_coded = width_lcu_num * lcu_size;\n\theight_coded = height_lcu_num * lcu_size;\n\tnum_lcu_mb = (height_coded / lcu_size) *\n\t\t     ((width_coded + lcu_size * 8) / lcu_size);\n\tslice_info_bufsize = 256 + (frame_num_lcu << 4);\n\tslice_info_bufsize = ALIGN(slice_info_bufsize, HFI_DMA_ALIGNMENT);\n\tline_buf_ctrl_size = ALIGN(width_coded, HFI_DMA_ALIGNMENT);\n\tline_buf_ctrl_size_buffid2 = ALIGN(width_coded, HFI_DMA_ALIGNMENT);\n\n\tbit_depth = ten_bit ? 10 : 8;\n\tline_buf_data_size =\n\t\t(((((bit_depth * width_coded + 1024) +\n\t\t(HFI_DMA_ALIGNMENT - 1)) & (~(HFI_DMA_ALIGNMENT - 1))) * 1) +\n\t\t(((((bit_depth * width_coded + 1024) >> 1) +\n\t\t(HFI_DMA_ALIGNMENT - 1)) & (~(HFI_DMA_ALIGNMENT - 1))) * 2));\n\n\tleftline_buf_ctrl_size = is_h265 ?\n\t\t((height_coded + 32) / 32 * 4 * 16) :\n\t\t((height_coded + 15) / 16 * 5 * 16);\n\n\tif (num_vpp_pipes > 1) {\n\t\tleftline_buf_ctrl_size += 512;\n\t\tleftline_buf_ctrl_size =\n\t\t\tALIGN(leftline_buf_ctrl_size, 512) * num_vpp_pipes;\n\t}\n\n\tleftline_buf_ctrl_size =\n\t\tALIGN(leftline_buf_ctrl_size, HFI_DMA_ALIGNMENT);\n\tleftline_buf_recon_pix_size = (((ten_bit + 1) * 2 *\n\t\t(height_coded) + HFI_DMA_ALIGNMENT) +\n\t\t(HFI_DMA_ALIGNMENT << (num_vpp_pipes - 1)) - 1) &\n\t\t(~((HFI_DMA_ALIGNMENT << (num_vpp_pipes - 1)) - 1)) * 1;\n\n\ttopline_buf_ctrl_size_FE = is_h265 ? (64 * (width_coded >> 5)) :\n\t\t(HFI_DMA_ALIGNMENT + 16 * (width_coded >> 4));\n\ttopline_buf_ctrl_size_FE =\n\t\tALIGN(topline_buf_ctrl_size_FE, HFI_DMA_ALIGNMENT);\n\tleftline_buf_ctrl_size_FE =\n\t\t(((HFI_DMA_ALIGNMENT + 64 * (height_coded >> 4)) +\n\t\t(HFI_DMA_ALIGNMENT << (num_vpp_pipes - 1)) - 1) &\n\t\t(~((HFI_DMA_ALIGNMENT << (num_vpp_pipes - 1)) - 1)) * 1) *\n\t\tnum_vpp_pipes;\n\tleftline_buf_meta_recony = (HFI_DMA_ALIGNMENT + 64 *\n\t\t((height_coded) / (8 * (ten_bit ? 4 : 8))));\n\tleftline_buf_meta_recony =\n\t\tALIGN(leftline_buf_meta_recony, HFI_DMA_ALIGNMENT);\n\tleftline_buf_meta_recony = leftline_buf_meta_recony * num_vpp_pipes;\n\tlinebuf_meta_recon_uv = (HFI_DMA_ALIGNMENT + 64 *\n\t\t((height_coded) / (4 * (ten_bit ? 4 : 8))));\n\tlinebuf_meta_recon_uv = ALIGN(linebuf_meta_recon_uv, HFI_DMA_ALIGNMENT);\n\tlinebuf_meta_recon_uv = linebuf_meta_recon_uv * num_vpp_pipes;\n\tline_buf_recon_pix_size = ((ten_bit ? 3 : 2) * width_coded);\n\tline_buf_recon_pix_size =\n\t\tALIGN(line_buf_recon_pix_size, HFI_DMA_ALIGNMENT);\n\tslice_cmd_buffer_size = ALIGN(20480, HFI_DMA_ALIGNMENT);\n\tsps_pps_slice_hdr = 2048 + 4096;\n\tcol_mv_buf_size = is_h265 ? (16 * ((frame_num_lcu << 2) + 32)) :\n\t\t(3 * 16 * (width_lcu_num * height_lcu_num + 32));\n\tcol_mv_buf_size =\n\t\tALIGN(col_mv_buf_size, HFI_DMA_ALIGNMENT) * (num_ref + 1);\n\th265e_colrcbuf_size =\n\t\t(((width_lcu_num + 7) >> 3) * 16 * 2 * height_lcu_num);\n\tif (num_vpp_pipes > 1)\n\t\th265e_colrcbuf_size =\n\t\t\tALIGN(h265e_colrcbuf_size, HFI_DMA_ALIGNMENT) *\n\t\t\tnum_vpp_pipes;\n\n\th265e_colrcbuf_size = ALIGN(h265e_colrcbuf_size, HFI_DMA_ALIGNMENT) *\n\t\t\t\tHFI_MAX_COL_FRAME;\n\th265e_framerc_bufsize = (is_h265) ? (256 + 16 *\n\t\t(14 + (((height_coded >> 5) + 7) >> 3))) :\n\t\t(256 + 16 * (14 + (((height_coded >> 4) + 7) >> 3)));\n\th265e_framerc_bufsize *= 6;    \n\tif (num_vpp_pipes > 1)\n\t\th265e_framerc_bufsize =\n\t\t\tALIGN(h265e_framerc_bufsize, HFI_DMA_ALIGNMENT) *\n\t\t\tnum_vpp_pipes;\n\n\th265e_framerc_bufsize = ALIGN(h265e_framerc_bufsize, 512) *\n\t\t\t\tHFI_MAX_COL_FRAME;\n\th265e_lcubitcnt_bufsize = 256 + 4 * frame_num_lcu;\n\th265e_lcubitcnt_bufsize =\n\t\tALIGN(h265e_lcubitcnt_bufsize, HFI_DMA_ALIGNMENT);\n\th265e_lcubitmap_bufsize = 256 + (frame_num_lcu >> 3);\n\th265e_lcubitmap_bufsize =\n\t\tALIGN(h265e_lcubitmap_bufsize, HFI_DMA_ALIGNMENT);\n\tline_buf_sde_size = 256 + 16 * (width_coded >> 4);\n\tline_buf_sde_size = ALIGN(line_buf_sde_size, HFI_DMA_ALIGNMENT);\n\tif ((width_coded * height_coded) > (4096 * 2160))\n\t\tse_stats_bufsize = 0;\n\telse if ((width_coded * height_coded) > (1920 * 1088))\n\t\tse_stats_bufsize = (40 * 4 * frame_num_lcu + 256 + 256);\n\telse\n\t\tse_stats_bufsize = (1024 * frame_num_lcu + 256 + 256);\n\n\tse_stats_bufsize = ALIGN(se_stats_bufsize, HFI_DMA_ALIGNMENT) * 2;\n\tbse_slice_cmd_buffer_size = (((8192 << 2) + 7) & (~7)) * 6;\n\tbse_reg_buffer_size = (((512 << 3) + 7) & (~7)) * 4;\n\tvpp_reg_buffer_size =\n\t\t(((HFI_VENUS_VPPSG_MAX_REGISTERS << 3) + 31) & (~31)) * 10;\n\tlambda_lut_size = 256 * 11;\n\toverride_buffer_size = 16 * ((num_lcu_mb + 7) >> 3);\n\toverride_buffer_size =\n\t\tALIGN(override_buffer_size, HFI_DMA_ALIGNMENT) * 2;\n\tir_buffer_size = (((frame_num_lcu << 1) + 7) & (~7)) * 3;\n\tvpss_line_buffer_size_1 = (((8192 >> 2) << 5) * num_vpp_pipes) + 64;\n\tvpss_line_buf =\n\t\t(((((max(width_coded, height_coded) + 3) >> 2) << 5) + 256) *\n\t\t16) + vpss_line_buffer_size_1;\n\ttopline_bufsize_fe_1stg_sao = 16 * (width_coded >> 5);\n\ttopline_bufsize_fe_1stg_sao =\n\t\tALIGN(topline_bufsize_fe_1stg_sao, HFI_DMA_ALIGNMENT);\n\n\tsize =\n\t\tline_buf_ctrl_size + line_buf_data_size +\n\t\tline_buf_ctrl_size_buffid2 + leftline_buf_ctrl_size +\n\t\tvpss_line_buf + col_mv_buf_size + topline_buf_ctrl_size_FE +\n\t\tleftline_buf_ctrl_size_FE + line_buf_recon_pix_size +\n\t\tleftline_buf_recon_pix_size +\n\t\tleftline_buf_meta_recony + linebuf_meta_recon_uv +\n\t\th265e_colrcbuf_size + h265e_framerc_bufsize +\n\t\th265e_lcubitcnt_bufsize + h265e_lcubitmap_bufsize +\n\t\tline_buf_sde_size +\n\t\ttopline_bufsize_fe_1stg_sao + override_buffer_size +\n\t\tbse_reg_buffer_size + vpp_reg_buffer_size + sps_pps_slice_hdr +\n\t\tslice_cmd_buffer_size + bse_slice_cmd_buffer_size +\n\t\tir_buffer_size + slice_info_bufsize + lambda_lut_size +\n\t\tse_stats_bufsize + 1024;\n\n\treturn size;\n}\n\nstatic u32 h264e_scratch1_size(u32 width, u32 height, u32 num_ref, bool ten_bit,\n\t\t\t       u32 num_vpp_pipes)\n{\n\treturn calculate_enc_scratch1_size(width, height, 16, num_ref, ten_bit,\n\t\t\t\t\t   num_vpp_pipes, false);\n}\n\nstatic u32 h265e_scratch1_size(u32 width, u32 height, u32 num_ref, bool ten_bit,\n\t\t\t       u32 num_vpp_pipes)\n{\n\treturn calculate_enc_scratch1_size(width, height, 32, num_ref, ten_bit,\n\t\t\t\t\t   num_vpp_pipes, true);\n}\n\nstatic u32 vp8e_scratch1_size(u32 width, u32 height, u32 num_ref, bool ten_bit,\n\t\t\t      u32 num_vpp_pipes)\n{\n\treturn calculate_enc_scratch1_size(width, height, 16, num_ref, ten_bit,\n\t\t\t\t\t   1, false);\n}\n\nstatic u32 ubwc_metadata_plane_stride(u32 width, u32 metadata_stride_multi,\n\t\t\t\t      u32 tile_width_pels)\n{\n\treturn ALIGN(((width + (tile_width_pels - 1)) / tile_width_pels),\n\t\t\tmetadata_stride_multi);\n}\n\nstatic u32 ubwc_metadata_plane_bufheight(u32 height, u32 metadata_height_multi,\n\t\t\t\t\t u32 tile_height_pels)\n{\n\treturn ALIGN(((height + (tile_height_pels - 1)) / tile_height_pels),\n\t\t\tmetadata_height_multi);\n}\n\nstatic u32 ubwc_metadata_plane_buffer_size(u32 metadata_stride,\n\t\t\t\t\t   u32 metadata_buf_height)\n{\n\treturn ALIGN(metadata_stride * metadata_buf_height, SZ_4K);\n}\n\nstatic u32 enc_scratch2_size(u32 width, u32 height, u32 num_ref, bool ten_bit)\n{\n\tu32 aligned_width, aligned_height, chroma_height, ref_buf_height;\n\tu32 luma_size, chroma_size;\n\tu32 metadata_stride, meta_buf_height, meta_size_y, meta_size_c;\n\tu32 ref_luma_stride_bytes, ref_chroma_height_bytes;\n\tu32 ref_buf_size, ref_stride;\n\tu32 size;\n\n\tif (!ten_bit) {\n\t\taligned_height = ALIGN(height, HFI_VENUS_HEIGHT_ALIGNMENT);\n\t\tchroma_height = height >> 1;\n\t\tchroma_height = ALIGN(chroma_height,\n\t\t\t\t      HFI_VENUS_HEIGHT_ALIGNMENT);\n\t\taligned_width = ALIGN(width, HFI_VENUS_WIDTH_ALIGNMENT);\n\t\tmetadata_stride =\n\t\t\tubwc_metadata_plane_stride(width, 64,\n\t\t\t\t\t\t   NV12_UBWC_Y_TILE_WIDTH);\n\t\tmeta_buf_height =\n\t\t\tubwc_metadata_plane_bufheight(height, 16,\n\t\t\t\t\t\t      NV12_UBWC_Y_TILE_HEIGHT);\n\t\tmeta_size_y = ubwc_metadata_plane_buffer_size(metadata_stride,\n\t\t\t\t\t\t\t      meta_buf_height);\n\t\tmeta_size_c = ubwc_metadata_plane_buffer_size(metadata_stride,\n\t\t\t\t\t\t\t      meta_buf_height);\n\t\tsize = (aligned_height + chroma_height) * aligned_width +\n\t\t\tmeta_size_y + meta_size_c;\n\t\tsize = (size * (num_ref + 3)) + 4096;\n\t} else {\n\t\tref_buf_height = (height + (HFI_VENUS_HEIGHT_ALIGNMENT - 1))\n\t\t\t\t\t& (~(HFI_VENUS_HEIGHT_ALIGNMENT - 1));\n\t\tref_luma_stride_bytes =\n\t\t\t((width + SYSTEM_LAL_TILE10 - 1) / SYSTEM_LAL_TILE10) *\n\t\t\tSYSTEM_LAL_TILE10;\n\t\tref_stride = 4 * (ref_luma_stride_bytes / 3);\n\t\tref_stride = (ref_stride + (128 - 1)) & (~(128 - 1));\n\t\tluma_size = ref_buf_height * ref_stride;\n\t\tref_chroma_height_bytes = (((height + 1) >> 1) +\n\t\t\t(32 - 1)) & (~(32 - 1));\n\t\tchroma_size = ref_stride * ref_chroma_height_bytes;\n\t\tluma_size = (luma_size + (SZ_4K - 1)) & (~(SZ_4K - 1));\n\t\tchroma_size = (chroma_size + (SZ_4K - 1)) & (~(SZ_4K - 1));\n\t\tref_buf_size = luma_size + chroma_size;\n\t\tmetadata_stride =\n\t\t\tubwc_metadata_plane_stride(width,\n\t\t\t\t\t\t   METADATA_STRIDE_MULTIPLE,\n\t\t\t\t\t\t   TP10_UBWC_Y_TILE_WIDTH);\n\t\tmeta_buf_height =\n\t\t\tubwc_metadata_plane_bufheight(height,\n\t\t\t\t\t\t      METADATA_HEIGHT_MULTIPLE,\n\t\t\t\t\t\t      TP10_UBWC_Y_TILE_HEIGHT);\n\t\tmeta_size_y = ubwc_metadata_plane_buffer_size(metadata_stride,\n\t\t\t\t\t\t\t      meta_buf_height);\n\t\tmeta_size_c = ubwc_metadata_plane_buffer_size(metadata_stride,\n\t\t\t\t\t\t\t      meta_buf_height);\n\t\tsize = ref_buf_size + meta_size_y + meta_size_c;\n\t\tsize = (size * (num_ref + 3)) + 4096;\n\t}\n\n\treturn size;\n}\n\nstatic u32 enc_persist_size(void)\n{\n\treturn HFI_IRIS2_ENC_PERSIST_SIZE;\n}\n\nstatic u32 h264d_persist1_size(void)\n{\n\treturn ALIGN((SIZE_SLIST_BUF_H264 * NUM_SLIST_BUF_H264\n\t\t     + NUM_HW_PIC_BUF * SIZE_SEI_USERDATA), HFI_DMA_ALIGNMENT);\n}\n\nstatic u32 h265d_persist1_size(void)\n{\n\treturn ALIGN((SIZE_SLIST_BUF_H265 * NUM_SLIST_BUF_H265 + H265_NUM_TILE\n\t\t\t* sizeof(u32) + NUM_HW_PIC_BUF * SIZE_SEI_USERDATA), HFI_DMA_ALIGNMENT);\n}\n\nstatic u32 vp8d_persist1_size(void)\n{\n\treturn ALIGN(VP8_NUM_PROBABILITY_TABLE_BUF * VP8_PROB_TABLE_SIZE,\n\t\t\tHFI_DMA_ALIGNMENT);\n}\n\nstatic u32 vp9d_persist1_size(void)\n{\n\treturn\n\t\tALIGN(VP9_NUM_PROBABILITY_TABLE_BUF * VP9_PROB_TABLE_SIZE,\n\t\t      HFI_DMA_ALIGNMENT) +\n\t\tALIGN(HFI_IRIS2_VP9D_COMV_SIZE, HFI_DMA_ALIGNMENT) +\n\t\tALIGN(MAX_SUPERFRAME_HEADER_LEN, HFI_DMA_ALIGNMENT) +\n\t\tALIGN(VP9_UDC_HEADER_BUF_SIZE, HFI_DMA_ALIGNMENT) +\n\t\tALIGN(VP9_NUM_FRAME_INFO_BUF * CCE_TILE_OFFSET_SIZE,\n\t\t      HFI_DMA_ALIGNMENT);\n}\n\nstatic u32 mpeg2d_persist1_size(void)\n{\n\treturn QMATRIX_SIZE + MP2D_QPDUMP_SIZE;\n}\n\nstruct dec_bufsize_ops {\n\tu32 (*scratch)(u32 width, u32 height, bool is_interlaced);\n\tu32 (*scratch1)(u32 width, u32 height, u32 min_buf_count,\n\t\t\tbool split_mode_enabled, u32 num_vpp_pipes);\n\tu32 (*persist1)(void);\n};\n\nstruct enc_bufsize_ops {\n\tu32 (*scratch)(u32 width, u32 height, u32 work_mode, u32 num_vpp_pipes,\n\t\t       u32 rc_type);\n\tu32 (*scratch1)(u32 width, u32 height, u32 num_ref, bool ten_bit,\n\t\t\tu32 num_vpp_pipes);\n\tu32 (*scratch2)(u32 width, u32 height, u32 num_ref, bool ten_bit);\n\tu32 (*persist)(void);\n};\n\nstatic struct dec_bufsize_ops dec_h264_ops = {\n\t.scratch = h264d_scratch_size,\n\t.scratch1 = h264d_scratch1_size,\n\t.persist1 = h264d_persist1_size,\n};\n\nstatic struct dec_bufsize_ops dec_h265_ops = {\n\t.scratch = h265d_scratch_size,\n\t.scratch1 = h265d_scratch1_size,\n\t.persist1 = h265d_persist1_size,\n};\n\nstatic struct dec_bufsize_ops dec_vp8_ops = {\n\t.scratch = vpxd_scratch_size,\n\t.scratch1 = vp8d_scratch1_size,\n\t.persist1 = vp8d_persist1_size,\n};\n\nstatic struct dec_bufsize_ops dec_vp9_ops = {\n\t.scratch = vpxd_scratch_size,\n\t.scratch1 = vp9d_scratch1_size,\n\t.persist1 = vp9d_persist1_size,\n};\n\nstatic struct dec_bufsize_ops dec_mpeg2_ops = {\n\t.scratch = mpeg2d_scratch_size,\n\t.scratch1 = mpeg2d_scratch1_size,\n\t.persist1 = mpeg2d_persist1_size,\n};\n\nstatic struct enc_bufsize_ops enc_h264_ops = {\n\t.scratch = h264e_scratch_size,\n\t.scratch1 = h264e_scratch1_size,\n\t.scratch2 = enc_scratch2_size,\n\t.persist = enc_persist_size,\n};\n\nstatic struct enc_bufsize_ops enc_h265_ops = {\n\t.scratch = h265e_scratch_size,\n\t.scratch1 = h265e_scratch1_size,\n\t.scratch2 = enc_scratch2_size,\n\t.persist = enc_persist_size,\n};\n\nstatic struct enc_bufsize_ops enc_vp8_ops = {\n\t.scratch = vp8e_scratch_size,\n\t.scratch1 = vp8e_scratch1_size,\n\t.scratch2 = enc_scratch2_size,\n\t.persist = enc_persist_size,\n};\n\nstatic u32\ncalculate_dec_input_frame_size(u32 width, u32 height, u32 codec,\n\t\t\t       u32 max_mbs_per_frame, u32 buffer_size_limit)\n{\n\tu32 frame_size, num_mbs;\n\tu32 div_factor = 1;\n\tu32 base_res_mbs = NUM_MBS_4K;\n\n\t \n\tnum_mbs = (ALIGN(height, 16) * ALIGN(width, 16)) / 256;\n\tif (num_mbs > NUM_MBS_4K) {\n\t\tdiv_factor = 4;\n\t\tbase_res_mbs = max_mbs_per_frame;\n\t} else {\n\t\tbase_res_mbs = NUM_MBS_4K;\n\t\tif (codec == V4L2_PIX_FMT_VP9)\n\t\t\tdiv_factor = 1;\n\t\telse\n\t\t\tdiv_factor = 2;\n\t}\n\n\tframe_size = base_res_mbs * MB_SIZE_IN_PIXEL * 3 / 2 / div_factor;\n\n\t \n\tif (codec == V4L2_PIX_FMT_VP9 || codec == V4L2_PIX_FMT_HEVC)\n\t\tframe_size = frame_size + (frame_size >> 2);\n\n\tif (buffer_size_limit && buffer_size_limit < frame_size)\n\t\tframe_size = buffer_size_limit;\n\n\treturn ALIGN(frame_size, SZ_4K);\n}\n\nstatic int output_buffer_count(u32 session_type, u32 codec)\n{\n\tu32 output_min_count;\n\n\tif (session_type == VIDC_SESSION_TYPE_DEC) {\n\t\tswitch (codec) {\n\t\tcase V4L2_PIX_FMT_MPEG2:\n\t\tcase V4L2_PIX_FMT_VP8:\n\t\t\toutput_min_count = 6;\n\t\t\tbreak;\n\t\tcase V4L2_PIX_FMT_VP9:\n\t\t\toutput_min_count = 11;\n\t\t\tbreak;\n\t\tcase V4L2_PIX_FMT_H264:\n\t\tcase V4L2_PIX_FMT_HEVC:\n\t\tdefault:\n\t\t\toutput_min_count = 18;\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\toutput_min_count = MIN_ENC_OUTPUT_BUFFERS;\n\t}\n\n\treturn output_min_count;\n}\n\nstatic int bufreq_dec(struct hfi_plat_buffers_params *params, u32 buftype,\n\t\t      struct hfi_buffer_requirements *bufreq)\n{\n\tenum hfi_version version = params->version;\n\tu32 codec = params->codec;\n\tu32 width = params->width, height = params->height, out_min_count;\n\tu32 out_width = params->out_width, out_height = params->out_height;\n\tstruct dec_bufsize_ops *dec_ops;\n\tbool is_secondary_output = params->dec.is_secondary_output;\n\tbool is_interlaced = params->dec.is_interlaced;\n\tu32 max_mbs_per_frame = params->dec.max_mbs_per_frame;\n\tu32 buffer_size_limit = params->dec.buffer_size_limit;\n\tu32 num_vpp_pipes = params->num_vpp_pipes;\n\n\tswitch (codec) {\n\tcase V4L2_PIX_FMT_H264:\n\t\tdec_ops = &dec_h264_ops;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_HEVC:\n\t\tdec_ops = &dec_h265_ops;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_VP8:\n\t\tdec_ops = &dec_vp8_ops;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_VP9:\n\t\tdec_ops = &dec_vp9_ops;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_MPEG2:\n\t\tdec_ops = &dec_mpeg2_ops;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tout_min_count = output_buffer_count(VIDC_SESSION_TYPE_DEC, codec);\n\t \n\tout_min_count = max(out_min_count, hfi_bufreq_get_count_min(bufreq, version));\n\n\tbufreq->type = buftype;\n\tbufreq->region_size = 0;\n\tbufreq->count_actual = 1;\n\thfi_bufreq_set_count_min(bufreq, version, 1);\n\thfi_bufreq_set_hold_count(bufreq, version, 1);\n\tbufreq->contiguous = 1;\n\tbufreq->alignment = 256;\n\n\tif (buftype == HFI_BUFFER_INPUT) {\n\t\thfi_bufreq_set_count_min(bufreq, version, MIN_INPUT_BUFFERS);\n\t\tbufreq->size =\n\t\t\tcalculate_dec_input_frame_size(width, height, codec,\n\t\t\t\t\t\t       max_mbs_per_frame,\n\t\t\t\t\t\t       buffer_size_limit);\n\t} else if (buftype == HFI_BUFFER_OUTPUT || buftype == HFI_BUFFER_OUTPUT2) {\n\t\thfi_bufreq_set_count_min(bufreq, version, out_min_count);\n\t\tbufreq->size =\n\t\t\tvenus_helper_get_framesz_raw(params->hfi_color_fmt,\n\t\t\t\t\t\t     out_width, out_height);\n\t\tif (buftype == HFI_BUFFER_OUTPUT &&\n\t\t    params->dec.is_secondary_output)\n\t\t\tbufreq->size =\n\t\t\t\tvenus_helper_get_framesz_raw(params->hfi_dpb_color_fmt,\n\t\t\t\t\t\t\t     out_width, out_height);\n\t} else if (buftype == HFI_BUFFER_INTERNAL_SCRATCH(version)) {\n\t\tbufreq->size = dec_ops->scratch(width, height, is_interlaced);\n\t} else if (buftype == HFI_BUFFER_INTERNAL_SCRATCH_1(version)) {\n\t\tbufreq->size = dec_ops->scratch1(width, height, VB2_MAX_FRAME,\n\t\t\t\t\t\t is_secondary_output,\n\t\t\t\t\t\t num_vpp_pipes);\n\t} else if (buftype == HFI_BUFFER_INTERNAL_PERSIST_1) {\n\t\tbufreq->size = dec_ops->persist1();\n\t} else {\n\t\tbufreq->size = 0;\n\t}\n\n\treturn 0;\n}\n\nstatic int bufreq_enc(struct hfi_plat_buffers_params *params, u32 buftype,\n\t\t      struct hfi_buffer_requirements *bufreq)\n{\n\tenum hfi_version version = params->version;\n\tstruct enc_bufsize_ops *enc_ops;\n\tu32 width = params->width;\n\tu32 height = params->height;\n\tbool is_tenbit = params->enc.is_tenbit;\n\tu32 num_bframes = params->enc.num_b_frames;\n\tu32 codec = params->codec;\n\tu32 work_mode = params->enc.work_mode;\n\tu32 rc_type = params->enc.rc_type;\n\tu32 num_vpp_pipes = params->num_vpp_pipes;\n\tu32 num_ref, count_min;\n\n\tswitch (codec) {\n\tcase V4L2_PIX_FMT_H264:\n\t\tenc_ops = &enc_h264_ops;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_HEVC:\n\t\tenc_ops = &enc_h265_ops;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_VP8:\n\t\tenc_ops = &enc_vp8_ops;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tnum_ref = num_bframes > 0 ? num_bframes + 1 : 1;\n\n\tbufreq->type = buftype;\n\tbufreq->region_size = 0;\n\tbufreq->count_actual = 1;\n\thfi_bufreq_set_count_min(bufreq, version, 1);\n\thfi_bufreq_set_hold_count(bufreq, version, 1);\n\tbufreq->contiguous = 1;\n\tbufreq->alignment = 256;\n\n\tif (buftype == HFI_BUFFER_INPUT) {\n\t\thfi_bufreq_set_count_min(bufreq, version, MIN_INPUT_BUFFERS);\n\t\tbufreq->size =\n\t\t\tvenus_helper_get_framesz_raw(params->hfi_color_fmt,\n\t\t\t\t\t\t     width, height);\n\t} else if (buftype == HFI_BUFFER_OUTPUT ||\n\t\t   buftype == HFI_BUFFER_OUTPUT2) {\n\t\tcount_min = output_buffer_count(VIDC_SESSION_TYPE_ENC, codec);\n\t\thfi_bufreq_set_count_min(bufreq, version, count_min);\n\t\tbufreq->size = calculate_enc_output_frame_size(width, height,\n\t\t\t\t\t\t\t       rc_type);\n\t} else if (buftype == HFI_BUFFER_INTERNAL_SCRATCH(version)) {\n\t\tbufreq->size = enc_ops->scratch(width, height, work_mode,\n\t\t\t\t\t\tnum_vpp_pipes, rc_type);\n\t} else if (buftype == HFI_BUFFER_INTERNAL_SCRATCH_1(version)) {\n\t\tbufreq->size = enc_ops->scratch1(width, height, num_ref,\n\t\t\t\t\t\t is_tenbit, num_vpp_pipes);\n\t} else if (buftype == HFI_BUFFER_INTERNAL_SCRATCH_2(version)) {\n\t\tbufreq->size = enc_ops->scratch2(width, height, num_ref,\n\t\t\t\t\t\t is_tenbit);\n\t} else if (buftype == HFI_BUFFER_INTERNAL_PERSIST) {\n\t\tbufreq->size = enc_ops->persist();\n\t} else {\n\t\tbufreq->size = 0;\n\t}\n\n\treturn 0;\n}\n\nint hfi_plat_bufreq_v6(struct hfi_plat_buffers_params *params, u32 session_type,\n\t\t       u32 buftype, struct hfi_buffer_requirements *bufreq)\n{\n\tif (session_type == VIDC_SESSION_TYPE_DEC)\n\t\treturn bufreq_dec(params, buftype, bufreq);\n\telse\n\t\treturn bufreq_enc(params, buftype, bufreq);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}