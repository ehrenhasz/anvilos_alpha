{
  "module_name": "camss-csid-4-7.c",
  "hash_id": "9b70c13a1a555980458b221c74719d12c61db0a4c04d07830b13c6afaf5a40dc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/qcom/camss/camss-csid-4-7.c",
  "human_readable_source": "\n \n#include <linux/completion.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n\n#include \"camss-csid.h\"\n#include \"camss-csid-gen1.h\"\n#include \"camss.h\"\n\n#define CAMSS_CSID_HW_VERSION\t\t0x0\n#define CAMSS_CSID_CORE_CTRL_0\t\t0x004\n#define CAMSS_CSID_CORE_CTRL_1\t\t0x008\n#define CAMSS_CSID_RST_CMD\t\t0x010\n#define CAMSS_CSID_CID_LUT_VC_n(n)\t(0x014 + 0x4 * (n))\n#define CAMSS_CSID_CID_n_CFG(n)\t\t(0x024 + 0x4 * (n))\n#define CAMSS_CSID_CID_n_CFG_ISPIF_EN\tBIT(0)\n#define CAMSS_CSID_CID_n_CFG_RDI_EN\tBIT(1)\n#define CAMSS_CSID_CID_n_CFG_DECODE_FORMAT_SHIFT\t4\n#define CAMSS_CSID_CID_n_CFG_PLAIN_FORMAT_8\t\t(PLAIN_FORMAT_PLAIN8 << 8)\n#define CAMSS_CSID_CID_n_CFG_PLAIN_FORMAT_16\t\t(PLAIN_FORMAT_PLAIN16 << 8)\n#define CAMSS_CSID_CID_n_CFG_PLAIN_ALIGNMENT_LSB\t(0 << 9)\n#define CAMSS_CSID_CID_n_CFG_PLAIN_ALIGNMENT_MSB\t(1 << 9)\n#define CAMSS_CSID_CID_n_CFG_RDI_MODE_RAW_DUMP\t\t(0 << 10)\n#define CAMSS_CSID_CID_n_CFG_RDI_MODE_PLAIN_PACKING\t(1 << 10)\n#define CAMSS_CSID_IRQ_CLEAR_CMD\t0x064\n#define CAMSS_CSID_IRQ_MASK\t\t0x068\n#define CAMSS_CSID_IRQ_STATUS\t\t0x06c\n#define CAMSS_CSID_TG_CTRL\t\t0x0a8\n#define CAMSS_CSID_TG_CTRL_DISABLE\t0xa06436\n#define CAMSS_CSID_TG_CTRL_ENABLE\t0xa06437\n#define CAMSS_CSID_TG_VC_CFG\t\t0x0ac\n#define CAMSS_CSID_TG_VC_CFG_H_BLANKING\t\t0x3ff\n#define CAMSS_CSID_TG_VC_CFG_V_BLANKING\t\t0x7f\n#define CAMSS_CSID_TG_DT_n_CGG_0(n)\t(0x0b4 + 0xc * (n))\n#define CAMSS_CSID_TG_DT_n_CGG_1(n)\t(0x0b8 + 0xc * (n))\n#define CAMSS_CSID_TG_DT_n_CGG_2(n)\t(0x0bc + 0xc * (n))\n\nstatic const struct csid_format csid_formats[] = {\n\t{\n\t\tMEDIA_BUS_FMT_UYVY8_2X8,\n\t\tDATA_TYPE_YUV422_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t2,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_VYUY8_2X8,\n\t\tDATA_TYPE_YUV422_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t2,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_YUYV8_2X8,\n\t\tDATA_TYPE_YUV422_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t2,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_YVYU8_2X8,\n\t\tDATA_TYPE_YUV422_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t2,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SBGGR8_1X8,\n\t\tDATA_TYPE_RAW_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGBRG8_1X8,\n\t\tDATA_TYPE_RAW_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGRBG8_1X8,\n\t\tDATA_TYPE_RAW_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SRGGB8_1X8,\n\t\tDATA_TYPE_RAW_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SBGGR10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGBRG10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGRBG10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SRGGB10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SBGGR12_1X12,\n\t\tDATA_TYPE_RAW_12BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_12_BIT,\n\t\t12,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGBRG12_1X12,\n\t\tDATA_TYPE_RAW_12BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_12_BIT,\n\t\t12,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGRBG12_1X12,\n\t\tDATA_TYPE_RAW_12BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_12_BIT,\n\t\t12,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SRGGB12_1X12,\n\t\tDATA_TYPE_RAW_12BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_12_BIT,\n\t\t12,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SBGGR14_1X14,\n\t\tDATA_TYPE_RAW_14BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_14_BIT,\n\t\t14,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGBRG14_1X14,\n\t\tDATA_TYPE_RAW_14BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_14_BIT,\n\t\t14,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGRBG14_1X14,\n\t\tDATA_TYPE_RAW_14BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_14_BIT,\n\t\t14,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SRGGB14_1X14,\n\t\tDATA_TYPE_RAW_14BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_14_BIT,\n\t\t14,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_Y10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n};\n\nstatic void csid_configure_stream(struct csid_device *csid, u8 enable)\n{\n\tstruct csid_testgen_config *tg = &csid->testgen;\n\tu32 sink_code = csid->fmt[MSM_CSID_PAD_SINK].code;\n\tu32 src_code = csid->fmt[MSM_CSID_PAD_SRC].code;\n\tu32 val;\n\n\tif (enable) {\n\t\tstruct v4l2_mbus_framefmt *input_format;\n\t\tconst struct csid_format *format;\n\t\tu8 vc = 0;  \n\t\tu8 cid = vc * 4;  \n\t\tu8 dt_shift;\n\n\t\tif (tg->enabled) {\n\t\t\t \n\t\t\tu32 num_bytes_per_line, num_lines;\n\n\t\t\tinput_format = &csid->fmt[MSM_CSID_PAD_SRC];\n\t\t\tformat = csid_get_fmt_entry(csid->formats, csid->nformats,\n\t\t\t\t\t\t    input_format->code);\n\t\t\tnum_bytes_per_line = input_format->width * format->bpp * format->spp / 8;\n\t\t\tnum_lines = input_format->height;\n\n\t\t\t \n\t\t\t \n\t\t\tval = ((CAMSS_CSID_TG_VC_CFG_V_BLANKING & 0xff) << 24) |\n\t\t\t\t  ((CAMSS_CSID_TG_VC_CFG_H_BLANKING & 0x7ff) << 13);\n\t\t\twritel_relaxed(val, csid->base + CAMSS_CSID_TG_VC_CFG);\n\n\t\t\t \n\t\t\tval = ((num_bytes_per_line & 0x1fff) << 16) |\n\t\t\t\t  (num_lines & 0x1fff);\n\t\t\twritel_relaxed(val, csid->base + CAMSS_CSID_TG_DT_n_CGG_0(0));\n\n\t\t\t \n\t\t\tval = format->data_type;\n\t\t\twritel_relaxed(val, csid->base + CAMSS_CSID_TG_DT_n_CGG_1(0));\n\n\t\t\t \n\t\t\tval = tg->mode - 1;\n\t\t\twritel_relaxed(val, csid->base + CAMSS_CSID_TG_DT_n_CGG_2(0));\n\t\t} else {\n\t\t\tstruct csid_phy_config *phy = &csid->phy;\n\n\t\t\tinput_format = &csid->fmt[MSM_CSID_PAD_SINK];\n\t\t\tformat = csid_get_fmt_entry(csid->formats, csid->nformats,\n\t\t\t\t\t\t    input_format->code);\n\n\t\t\tval = phy->lane_cnt - 1;\n\t\t\tval |= phy->lane_assign << 4;\n\n\t\t\twritel_relaxed(val, csid->base + CAMSS_CSID_CORE_CTRL_0);\n\n\t\t\tval = phy->csiphy_id << 17;\n\t\t\tval |= 0x9;\n\n\t\t\twritel_relaxed(val, csid->base + CAMSS_CSID_CORE_CTRL_1);\n\t\t}\n\n\t\t \n\n\t\tdt_shift = (cid % 4) * 8;\n\n\t\tval = readl_relaxed(csid->base + CAMSS_CSID_CID_LUT_VC_n(vc));\n\t\tval &= ~(0xff << dt_shift);\n\t\tval |= format->data_type << dt_shift;\n\t\twritel_relaxed(val, csid->base + CAMSS_CSID_CID_LUT_VC_n(vc));\n\n\t\tval = CAMSS_CSID_CID_n_CFG_ISPIF_EN;\n\t\tval |= CAMSS_CSID_CID_n_CFG_RDI_EN;\n\t\tval |= format->decode_format << CAMSS_CSID_CID_n_CFG_DECODE_FORMAT_SHIFT;\n\t\tval |= CAMSS_CSID_CID_n_CFG_RDI_MODE_RAW_DUMP;\n\n\t\tif ((sink_code == MEDIA_BUS_FMT_SBGGR10_1X10 &&\n\t\t     src_code == MEDIA_BUS_FMT_SBGGR10_2X8_PADHI_LE) ||\n\t\t    (sink_code == MEDIA_BUS_FMT_Y10_1X10 &&\n\t\t     src_code == MEDIA_BUS_FMT_Y10_2X8_PADHI_LE)) {\n\t\t\tval |= CAMSS_CSID_CID_n_CFG_RDI_MODE_PLAIN_PACKING;\n\t\t\tval |= CAMSS_CSID_CID_n_CFG_PLAIN_FORMAT_16;\n\t\t\tval |= CAMSS_CSID_CID_n_CFG_PLAIN_ALIGNMENT_LSB;\n\t\t}\n\n\t\twritel_relaxed(val, csid->base + CAMSS_CSID_CID_n_CFG(cid));\n\n\t\tif (tg->enabled) {\n\t\t\tval = CAMSS_CSID_TG_CTRL_ENABLE;\n\t\t\twritel_relaxed(val, csid->base + CAMSS_CSID_TG_CTRL);\n\t\t}\n\t} else {\n\t\tif (tg->enabled) {\n\t\t\tval = CAMSS_CSID_TG_CTRL_DISABLE;\n\t\t\twritel_relaxed(val, csid->base + CAMSS_CSID_TG_CTRL);\n\t\t}\n\t}\n}\n\nstatic int csid_configure_testgen_pattern(struct csid_device *csid, s32 val)\n{\n\tif (val > 0 && val <= csid->testgen.nmodes)\n\t\tcsid->testgen.mode = val;\n\n\treturn 0;\n}\n\nstatic u32 csid_hw_version(struct csid_device *csid)\n{\n\tu32 hw_version = readl_relaxed(csid->base + CAMSS_CSID_HW_VERSION);\n\n\tdev_dbg(csid->camss->dev, \"CSID HW Version = 0x%08x\\n\", hw_version);\n\n\treturn hw_version;\n}\n\n \nstatic irqreturn_t csid_isr(int irq, void *dev)\n{\n\tstruct csid_device *csid = dev;\n\tu32 value;\n\n\tvalue = readl_relaxed(csid->base + CAMSS_CSID_IRQ_STATUS);\n\twritel_relaxed(value, csid->base + CAMSS_CSID_IRQ_CLEAR_CMD);\n\n\tif ((value >> 11) & 0x1)\n\t\tcomplete(&csid->reset_complete);\n\n\treturn IRQ_HANDLED;\n}\n\n \nstatic int csid_reset(struct csid_device *csid)\n{\n\tunsigned long time;\n\n\treinit_completion(&csid->reset_complete);\n\n\twritel_relaxed(0x7fff, csid->base + CAMSS_CSID_RST_CMD);\n\n\ttime = wait_for_completion_timeout(&csid->reset_complete,\n\t\t\t\t\t   msecs_to_jiffies(CSID_RESET_TIMEOUT_MS));\n\tif (!time) {\n\t\tdev_err(csid->camss->dev, \"CSID reset timeout\\n\");\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 csid_src_pad_code(struct csid_device *csid, u32 sink_code,\n\t\t\t     unsigned int match_format_idx, u32 match_code)\n{\n\tswitch (sink_code) {\n\tcase MEDIA_BUS_FMT_SBGGR10_1X10:\n\t{\n\t\tu32 src_code[] = {\n\t\t\tMEDIA_BUS_FMT_SBGGR10_1X10,\n\t\t\tMEDIA_BUS_FMT_SBGGR10_2X8_PADHI_LE,\n\t\t};\n\n\t\treturn csid_find_code(src_code, ARRAY_SIZE(src_code),\n\t\t\t\t      match_format_idx, match_code);\n\t}\n\tcase MEDIA_BUS_FMT_Y10_1X10:\n\t{\n\t\tu32 src_code[] = {\n\t\t\tMEDIA_BUS_FMT_Y10_1X10,\n\t\t\tMEDIA_BUS_FMT_Y10_2X8_PADHI_LE,\n\t\t};\n\n\t\treturn csid_find_code(src_code, ARRAY_SIZE(src_code),\n\t\t\t\t      match_format_idx, match_code);\n\t}\n\tdefault:\n\t\tif (match_format_idx > 0)\n\t\t\treturn 0;\n\n\t\treturn sink_code;\n\t}\n}\n\nstatic void csid_subdev_init(struct csid_device *csid)\n{\n\tcsid->formats = csid_formats;\n\tcsid->nformats = ARRAY_SIZE(csid_formats);\n\tcsid->testgen.modes = csid_testgen_modes;\n\tcsid->testgen.nmodes = CSID_PAYLOAD_MODE_NUM_SUPPORTED_GEN1;\n}\n\nconst struct csid_hw_ops csid_ops_4_7 = {\n\t.configure_stream = csid_configure_stream,\n\t.configure_testgen_pattern = csid_configure_testgen_pattern,\n\t.hw_version = csid_hw_version,\n\t.isr = csid_isr,\n\t.reset = csid_reset,\n\t.src_pad_code = csid_src_pad_code,\n\t.subdev_init = csid_subdev_init,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}