{
  "module_name": "camss-vfe-4-1.c",
  "hash_id": "5d17a62d946d4843e6724acd9eeb9f17dd4ced2374f4d4eacc81f5a0dd765e82",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/qcom/camss/camss-vfe-4-1.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/iopoll.h>\n\n#include \"camss.h\"\n#include \"camss-vfe.h\"\n#include \"camss-vfe-gen1.h\"\n\n#define VFE_0_HW_VERSION\t\t0x000\n\n#define VFE_0_GLOBAL_RESET_CMD\t\t0x00c\n#define VFE_0_GLOBAL_RESET_CMD_CORE\tBIT(0)\n#define VFE_0_GLOBAL_RESET_CMD_CAMIF\tBIT(1)\n#define VFE_0_GLOBAL_RESET_CMD_BUS\tBIT(2)\n#define VFE_0_GLOBAL_RESET_CMD_BUS_BDG\tBIT(3)\n#define VFE_0_GLOBAL_RESET_CMD_REGISTER\tBIT(4)\n#define VFE_0_GLOBAL_RESET_CMD_TIMER\tBIT(5)\n#define VFE_0_GLOBAL_RESET_CMD_PM\tBIT(6)\n#define VFE_0_GLOBAL_RESET_CMD_BUS_MISR\tBIT(7)\n#define VFE_0_GLOBAL_RESET_CMD_TESTGEN\tBIT(8)\n\n#define VFE_0_MODULE_CFG\t\t0x018\n#define VFE_0_MODULE_CFG_DEMUX\t\t\tBIT(2)\n#define VFE_0_MODULE_CFG_CHROMA_UPSAMPLE\tBIT(3)\n#define VFE_0_MODULE_CFG_SCALE_ENC\t\tBIT(23)\n#define VFE_0_MODULE_CFG_CROP_ENC\t\tBIT(27)\n\n#define VFE_0_CORE_CFG\t\t\t0x01c\n#define VFE_0_CORE_CFG_PIXEL_PATTERN_YCBYCR\t0x4\n#define VFE_0_CORE_CFG_PIXEL_PATTERN_YCRYCB\t0x5\n#define VFE_0_CORE_CFG_PIXEL_PATTERN_CBYCRY\t0x6\n#define VFE_0_CORE_CFG_PIXEL_PATTERN_CRYCBY\t0x7\n\n#define VFE_0_IRQ_CMD\t\t\t0x024\n#define VFE_0_IRQ_CMD_GLOBAL_CLEAR\tBIT(0)\n\n#define VFE_0_IRQ_MASK_0\t\t0x028\n#define VFE_0_IRQ_MASK_0_CAMIF_SOF\t\t\tBIT(0)\n#define VFE_0_IRQ_MASK_0_CAMIF_EOF\t\t\tBIT(1)\n#define VFE_0_IRQ_MASK_0_RDIn_REG_UPDATE(n)\t\tBIT((n) + 5)\n#define VFE_0_IRQ_MASK_0_line_n_REG_UPDATE(n)\t\t\\\n\t((n) == VFE_LINE_PIX ? BIT(4) : VFE_0_IRQ_MASK_0_RDIn_REG_UPDATE(n))\n#define VFE_0_IRQ_MASK_0_IMAGE_MASTER_n_PING_PONG(n)\tBIT((n) + 8)\n#define VFE_0_IRQ_MASK_0_IMAGE_COMPOSITE_DONE_n(n)\tBIT((n) + 25)\n#define VFE_0_IRQ_MASK_0_RESET_ACK\t\t\tBIT(31)\n#define VFE_0_IRQ_MASK_1\t\t0x02c\n#define VFE_0_IRQ_MASK_1_CAMIF_ERROR\t\t\tBIT(0)\n#define VFE_0_IRQ_MASK_1_VIOLATION\t\t\tBIT(7)\n#define VFE_0_IRQ_MASK_1_BUS_BDG_HALT_ACK\t\tBIT(8)\n#define VFE_0_IRQ_MASK_1_IMAGE_MASTER_n_BUS_OVERFLOW(n)\tBIT((n) + 9)\n#define VFE_0_IRQ_MASK_1_RDIn_SOF(n)\t\t\tBIT((n) + 29)\n\n#define VFE_0_IRQ_CLEAR_0\t\t0x030\n#define VFE_0_IRQ_CLEAR_1\t\t0x034\n\n#define VFE_0_IRQ_STATUS_0\t\t0x038\n#define VFE_0_IRQ_STATUS_0_CAMIF_SOF\t\t\tBIT(0)\n#define VFE_0_IRQ_STATUS_0_RDIn_REG_UPDATE(n)\t\tBIT((n) + 5)\n#define VFE_0_IRQ_STATUS_0_line_n_REG_UPDATE(n)\t\t\\\n\t((n) == VFE_LINE_PIX ? BIT(4) : VFE_0_IRQ_STATUS_0_RDIn_REG_UPDATE(n))\n#define VFE_0_IRQ_STATUS_0_IMAGE_MASTER_n_PING_PONG(n)\tBIT((n) + 8)\n#define VFE_0_IRQ_STATUS_0_IMAGE_COMPOSITE_DONE_n(n)\tBIT((n) + 25)\n#define VFE_0_IRQ_STATUS_0_RESET_ACK\t\t\tBIT(31)\n#define VFE_0_IRQ_STATUS_1\t\t0x03c\n#define VFE_0_IRQ_STATUS_1_VIOLATION\t\t\tBIT(7)\n#define VFE_0_IRQ_STATUS_1_BUS_BDG_HALT_ACK\t\tBIT(8)\n#define VFE_0_IRQ_STATUS_1_RDIn_SOF(n)\t\t\tBIT((n) + 29)\n\n#define VFE_0_IRQ_COMPOSITE_MASK_0\t0x40\n#define VFE_0_VIOLATION_STATUS\t\t0x48\n\n#define VFE_0_BUS_CMD\t\t\t0x4c\n#define VFE_0_BUS_CMD_Mx_RLD_CMD(x)\tBIT(x)\n\n#define VFE_0_BUS_CFG\t\t\t0x050\n\n#define VFE_0_BUS_XBAR_CFG_x(x)\t\t(0x58 + 0x4 * ((x) / 2))\n#define VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_EN\t\t\tBIT(1)\n#define VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_SWAP_INTER_INTRA\t(0x3 << 4)\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT\t\t8\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_LUMA\t\t0\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI0\t5\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI1\t6\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI2\t7\n\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_CFG(n)\t\t(0x06c + 0x24 * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_CFG_WR_PATH_SHIFT\t0\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_CFG_FRM_BASED_SHIFT\t1\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_PING_ADDR(n)\t(0x070 + 0x24 * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_PONG_ADDR(n)\t(0x074 + 0x24 * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG(n)\t\t(0x078 + 0x24 * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_SHIFT\t2\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_MASK\t(0x1f << 2)\n\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_UB_CFG(n)\t\t(0x07c + 0x24 * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_UB_CFG_OFFSET_SHIFT\t16\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_IMAGE_SIZE(n)\t(0x080 + 0x24 * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_BUFFER_CFG(n)\t(0x084 + 0x24 * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_FRAMEDROP_PATTERN(n)\t\\\n\t\t\t\t\t\t\t(0x088 + 0x24 * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_IRQ_SUBSAMPLE_PATTERN(n)\t\\\n\t\t\t\t\t\t\t(0x08c + 0x24 * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_IRQ_SUBSAMPLE_PATTERN_DEF\t0xffffffff\n\n#define VFE_0_BUS_PING_PONG_STATUS\t0x268\n\n#define VFE_0_BUS_BDG_CMD\t\t0x2c0\n#define VFE_0_BUS_BDG_CMD_HALT_REQ\t1\n\n#define VFE_0_BUS_BDG_QOS_CFG_0\t\t0x2c4\n#define VFE_0_BUS_BDG_QOS_CFG_0_CFG\t0xaaa5aaa5\n#define VFE_0_BUS_BDG_QOS_CFG_1\t\t0x2c8\n#define VFE_0_BUS_BDG_QOS_CFG_2\t\t0x2cc\n#define VFE_0_BUS_BDG_QOS_CFG_3\t\t0x2d0\n#define VFE_0_BUS_BDG_QOS_CFG_4\t\t0x2d4\n#define VFE_0_BUS_BDG_QOS_CFG_5\t\t0x2d8\n#define VFE_0_BUS_BDG_QOS_CFG_6\t\t0x2dc\n#define VFE_0_BUS_BDG_QOS_CFG_7\t\t0x2e0\n#define VFE_0_BUS_BDG_QOS_CFG_7_CFG\t0x0001aaa5\n\n#define VFE_0_RDI_CFG_x(x)\t\t(0x2e8 + (0x4 * (x)))\n#define VFE_0_RDI_CFG_x_RDI_STREAM_SEL_SHIFT\t28\n#define VFE_0_RDI_CFG_x_RDI_STREAM_SEL_MASK\t(0xf << 28)\n#define VFE_0_RDI_CFG_x_RDI_M0_SEL_SHIFT\t4\n#define VFE_0_RDI_CFG_x_RDI_M0_SEL_MASK\t\t(0xf << 4)\n#define VFE_0_RDI_CFG_x_RDI_EN_BIT\t\tBIT(2)\n#define VFE_0_RDI_CFG_x_MIPI_EN_BITS\t\t0x3\n#define VFE_0_RDI_CFG_x_RDI_Mr_FRAME_BASED_EN(r)\tBIT(16 + (r))\n\n#define VFE_0_CAMIF_CMD\t\t\t\t0x2f4\n#define VFE_0_CAMIF_CMD_DISABLE_FRAME_BOUNDARY\t0\n#define VFE_0_CAMIF_CMD_ENABLE_FRAME_BOUNDARY\t1\n#define VFE_0_CAMIF_CMD_NO_CHANGE\t\t3\n#define VFE_0_CAMIF_CMD_CLEAR_CAMIF_STATUS\tBIT(2)\n#define VFE_0_CAMIF_CFG\t\t\t\t0x2f8\n#define VFE_0_CAMIF_CFG_VFE_OUTPUT_EN\t\tBIT(6)\n#define VFE_0_CAMIF_FRAME_CFG\t\t\t0x300\n#define VFE_0_CAMIF_WINDOW_WIDTH_CFG\t\t0x304\n#define VFE_0_CAMIF_WINDOW_HEIGHT_CFG\t\t0x308\n#define VFE_0_CAMIF_SUBSAMPLE_CFG_0\t\t0x30c\n#define VFE_0_CAMIF_IRQ_SUBSAMPLE_PATTERN\t0x314\n#define VFE_0_CAMIF_STATUS\t\t\t0x31c\n#define VFE_0_CAMIF_STATUS_HALT\t\t\tBIT(31)\n\n#define VFE_0_REG_UPDATE\t\t\t0x378\n#define VFE_0_REG_UPDATE_RDIn(n)\t\tBIT(1 + (n))\n#define VFE_0_REG_UPDATE_line_n(n)\t\t\\\n\t\t\t((n) == VFE_LINE_PIX ? 1 : VFE_0_REG_UPDATE_RDIn(n))\n\n#define VFE_0_DEMUX_CFG\t\t\t\t0x424\n#define VFE_0_DEMUX_CFG_PERIOD\t\t\t0x3\n#define VFE_0_DEMUX_GAIN_0\t\t\t0x428\n#define VFE_0_DEMUX_GAIN_0_CH0_EVEN\t\t(0x80 << 0)\n#define VFE_0_DEMUX_GAIN_0_CH0_ODD\t\t(0x80 << 16)\n#define VFE_0_DEMUX_GAIN_1\t\t\t0x42c\n#define VFE_0_DEMUX_GAIN_1_CH1\t\t\t(0x80 << 0)\n#define VFE_0_DEMUX_GAIN_1_CH2\t\t\t(0x80 << 16)\n#define VFE_0_DEMUX_EVEN_CFG\t\t\t0x438\n#define VFE_0_DEMUX_EVEN_CFG_PATTERN_YUYV\t0x9cac\n#define VFE_0_DEMUX_EVEN_CFG_PATTERN_YVYU\t0xac9c\n#define VFE_0_DEMUX_EVEN_CFG_PATTERN_UYVY\t0xc9ca\n#define VFE_0_DEMUX_EVEN_CFG_PATTERN_VYUY\t0xcac9\n#define VFE_0_DEMUX_ODD_CFG\t\t\t0x43c\n#define VFE_0_DEMUX_ODD_CFG_PATTERN_YUYV\t0x9cac\n#define VFE_0_DEMUX_ODD_CFG_PATTERN_YVYU\t0xac9c\n#define VFE_0_DEMUX_ODD_CFG_PATTERN_UYVY\t0xc9ca\n#define VFE_0_DEMUX_ODD_CFG_PATTERN_VYUY\t0xcac9\n\n#define VFE_0_SCALE_ENC_Y_CFG\t\t\t0x75c\n#define VFE_0_SCALE_ENC_Y_H_IMAGE_SIZE\t\t0x760\n#define VFE_0_SCALE_ENC_Y_H_PHASE\t\t0x764\n#define VFE_0_SCALE_ENC_Y_V_IMAGE_SIZE\t\t0x76c\n#define VFE_0_SCALE_ENC_Y_V_PHASE\t\t0x770\n#define VFE_0_SCALE_ENC_CBCR_CFG\t\t0x778\n#define VFE_0_SCALE_ENC_CBCR_H_IMAGE_SIZE\t0x77c\n#define VFE_0_SCALE_ENC_CBCR_H_PHASE\t\t0x780\n#define VFE_0_SCALE_ENC_CBCR_V_IMAGE_SIZE\t0x790\n#define VFE_0_SCALE_ENC_CBCR_V_PHASE\t\t0x794\n\n#define VFE_0_CROP_ENC_Y_WIDTH\t\t\t0x854\n#define VFE_0_CROP_ENC_Y_HEIGHT\t\t\t0x858\n#define VFE_0_CROP_ENC_CBCR_WIDTH\t\t0x85c\n#define VFE_0_CROP_ENC_CBCR_HEIGHT\t\t0x860\n\n#define VFE_0_CLAMP_ENC_MAX_CFG\t\t\t0x874\n#define VFE_0_CLAMP_ENC_MAX_CFG_CH0\t\t(0xff << 0)\n#define VFE_0_CLAMP_ENC_MAX_CFG_CH1\t\t(0xff << 8)\n#define VFE_0_CLAMP_ENC_MAX_CFG_CH2\t\t(0xff << 16)\n#define VFE_0_CLAMP_ENC_MIN_CFG\t\t\t0x878\n#define VFE_0_CLAMP_ENC_MIN_CFG_CH0\t\t(0x0 << 0)\n#define VFE_0_CLAMP_ENC_MIN_CFG_CH1\t\t(0x0 << 8)\n#define VFE_0_CLAMP_ENC_MIN_CFG_CH2\t\t(0x0 << 16)\n\n#define VFE_0_CGC_OVERRIDE_1\t\t\t0x974\n#define VFE_0_CGC_OVERRIDE_1_IMAGE_Mx_CGC_OVERRIDE(x)\tBIT(x)\n\n#define CAMIF_TIMEOUT_SLEEP_US 1000\n#define CAMIF_TIMEOUT_ALL_US 1000000\n\n#define MSM_VFE_VFE0_UB_SIZE 1023\n#define MSM_VFE_VFE0_UB_SIZE_RDI (MSM_VFE_VFE0_UB_SIZE / 3)\n\nstatic u32 vfe_hw_version(struct vfe_device *vfe)\n{\n\tu32 hw_version = readl_relaxed(vfe->base + VFE_0_HW_VERSION);\n\n\tdev_dbg(vfe->camss->dev, \"VFE HW Version = 0x%08x\\n\", hw_version);\n\n\treturn hw_version;\n}\n\nstatic u16 vfe_get_ub_size(u8 vfe_id)\n{\n\tif (vfe_id == 0)\n\t\treturn MSM_VFE_VFE0_UB_SIZE_RDI;\n\n\treturn 0;\n}\n\nstatic inline void vfe_reg_clr(struct vfe_device *vfe, u32 reg, u32 clr_bits)\n{\n\tu32 bits = readl_relaxed(vfe->base + reg);\n\n\twritel_relaxed(bits & ~clr_bits, vfe->base + reg);\n}\n\nstatic inline void vfe_reg_set(struct vfe_device *vfe, u32 reg, u32 set_bits)\n{\n\tu32 bits = readl_relaxed(vfe->base + reg);\n\n\twritel_relaxed(bits | set_bits, vfe->base + reg);\n}\n\nstatic void vfe_global_reset(struct vfe_device *vfe)\n{\n\tu32 reset_bits = VFE_0_GLOBAL_RESET_CMD_TESTGEN\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_BUS_MISR\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_PM\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_TIMER\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_REGISTER\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_BUS_BDG\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_BUS\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_CAMIF\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_CORE;\n\n\twritel_relaxed(reset_bits, vfe->base + VFE_0_GLOBAL_RESET_CMD);\n}\n\nstatic void vfe_halt_request(struct vfe_device *vfe)\n{\n\twritel_relaxed(VFE_0_BUS_BDG_CMD_HALT_REQ,\n\t\t       vfe->base + VFE_0_BUS_BDG_CMD);\n}\n\nstatic void vfe_halt_clear(struct vfe_device *vfe)\n{\n\twritel_relaxed(0x0, vfe->base + VFE_0_BUS_BDG_CMD);\n}\n\nstatic void vfe_wm_enable(struct vfe_device *vfe, u8 wm, u8 enable)\n{\n\tif (enable)\n\t\tvfe_reg_set(vfe, VFE_0_BUS_IMAGE_MASTER_n_WR_CFG(wm),\n\t\t\t    1 << VFE_0_BUS_IMAGE_MASTER_n_WR_CFG_WR_PATH_SHIFT);\n\telse\n\t\tvfe_reg_clr(vfe, VFE_0_BUS_IMAGE_MASTER_n_WR_CFG(wm),\n\t\t\t    1 << VFE_0_BUS_IMAGE_MASTER_n_WR_CFG_WR_PATH_SHIFT);\n}\n\nstatic void vfe_wm_frame_based(struct vfe_device *vfe, u8 wm, u8 enable)\n{\n\tif (enable)\n\t\tvfe_reg_set(vfe, VFE_0_BUS_IMAGE_MASTER_n_WR_CFG(wm),\n\t\t\t1 << VFE_0_BUS_IMAGE_MASTER_n_WR_CFG_FRM_BASED_SHIFT);\n\telse\n\t\tvfe_reg_clr(vfe, VFE_0_BUS_IMAGE_MASTER_n_WR_CFG(wm),\n\t\t\t1 << VFE_0_BUS_IMAGE_MASTER_n_WR_CFG_FRM_BASED_SHIFT);\n}\n\nstatic void vfe_get_wm_sizes(struct v4l2_pix_format_mplane *pix, u8 plane,\n\t\t\t     u16 *width, u16 *height, u16 *bytesperline)\n{\n\t*width = pix->width;\n\t*height = pix->height;\n\t*bytesperline = pix->plane_fmt[0].bytesperline;\n\n\tif (pix->pixelformat == V4L2_PIX_FMT_NV12 ||\n\t    pix->pixelformat == V4L2_PIX_FMT_NV21)\n\t\tif (plane == 1)\n\t\t\t*height /= 2;\n}\n\nstatic void vfe_wm_line_based(struct vfe_device *vfe, u32 wm,\n\t\t\t      struct v4l2_pix_format_mplane *pix,\n\t\t\t      u8 plane, u32 enable)\n{\n\tu32 reg;\n\n\tif (enable) {\n\t\tu16 width = 0, height = 0, bytesperline = 0, wpl;\n\n\t\tvfe_get_wm_sizes(pix, plane, &width, &height, &bytesperline);\n\n\t\twpl = vfe_word_per_line(pix->pixelformat, width);\n\n\t\treg = height - 1;\n\t\treg |= ((wpl + 1) / 2 - 1) << 16;\n\n\t\twritel_relaxed(reg, vfe->base +\n\t\t\t       VFE_0_BUS_IMAGE_MASTER_n_WR_IMAGE_SIZE(wm));\n\n\t\twpl = vfe_word_per_line(pix->pixelformat, bytesperline);\n\n\t\treg = 0x3;\n\t\treg |= (height - 1) << 4;\n\t\treg |= wpl << 16;\n\n\t\twritel_relaxed(reg, vfe->base +\n\t\t\t       VFE_0_BUS_IMAGE_MASTER_n_WR_BUFFER_CFG(wm));\n\t} else {\n\t\twritel_relaxed(0, vfe->base +\n\t\t\t       VFE_0_BUS_IMAGE_MASTER_n_WR_IMAGE_SIZE(wm));\n\t\twritel_relaxed(0, vfe->base +\n\t\t\t       VFE_0_BUS_IMAGE_MASTER_n_WR_BUFFER_CFG(wm));\n\t}\n}\n\nstatic void vfe_wm_set_framedrop_period(struct vfe_device *vfe, u8 wm, u8 per)\n{\n\tu32 reg;\n\n\treg = readl_relaxed(vfe->base +\n\t\t\t    VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG(wm));\n\n\treg &= ~(VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_MASK);\n\n\treg |= (per << VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_SHIFT)\n\t\t& VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_MASK;\n\n\twritel_relaxed(reg,\n\t\t       vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG(wm));\n}\n\nstatic void vfe_wm_set_framedrop_pattern(struct vfe_device *vfe, u8 wm,\n\t\t\t\t\t u32 pattern)\n{\n\twritel_relaxed(pattern,\n\t       vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_FRAMEDROP_PATTERN(wm));\n}\n\nstatic void vfe_wm_set_ub_cfg(struct vfe_device *vfe, u8 wm,\n\t\t\t      u16 offset, u16 depth)\n{\n\tu32 reg;\n\n\treg = (offset << VFE_0_BUS_IMAGE_MASTER_n_WR_UB_CFG_OFFSET_SHIFT) |\n\t\tdepth;\n\twritel_relaxed(reg, vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_UB_CFG(wm));\n}\n\nstatic void vfe_bus_reload_wm(struct vfe_device *vfe, u8 wm)\n{\n\twmb();\n\twritel_relaxed(VFE_0_BUS_CMD_Mx_RLD_CMD(wm), vfe->base + VFE_0_BUS_CMD);\n\twmb();\n}\n\nstatic void vfe_wm_set_ping_addr(struct vfe_device *vfe, u8 wm, u32 addr)\n{\n\twritel_relaxed(addr,\n\t\t       vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_PING_ADDR(wm));\n}\n\nstatic void vfe_wm_set_pong_addr(struct vfe_device *vfe, u8 wm, u32 addr)\n{\n\twritel_relaxed(addr,\n\t\t       vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_PONG_ADDR(wm));\n}\n\nstatic int vfe_wm_get_ping_pong_status(struct vfe_device *vfe, u8 wm)\n{\n\tu32 reg;\n\n\treg = readl_relaxed(vfe->base + VFE_0_BUS_PING_PONG_STATUS);\n\n\treturn (reg >> wm) & 0x1;\n}\n\nstatic void vfe_bus_enable_wr_if(struct vfe_device *vfe, u8 enable)\n{\n\tif (enable)\n\t\twritel_relaxed(0x10000009, vfe->base + VFE_0_BUS_CFG);\n\telse\n\t\twritel_relaxed(0, vfe->base + VFE_0_BUS_CFG);\n}\n\nstatic void vfe_bus_connect_wm_to_rdi(struct vfe_device *vfe, u8 wm,\n\t\t\t\t      enum vfe_line_id id)\n{\n\tu32 reg;\n\n\treg = VFE_0_RDI_CFG_x_MIPI_EN_BITS;\n\treg |= VFE_0_RDI_CFG_x_RDI_Mr_FRAME_BASED_EN(id);\n\tvfe_reg_set(vfe, VFE_0_RDI_CFG_x(0), reg);\n\n\treg = VFE_0_RDI_CFG_x_RDI_EN_BIT;\n\treg |= ((3 * id) << VFE_0_RDI_CFG_x_RDI_STREAM_SEL_SHIFT) &\n\t\tVFE_0_RDI_CFG_x_RDI_STREAM_SEL_MASK;\n\tvfe_reg_set(vfe, VFE_0_RDI_CFG_x(id), reg);\n\n\tswitch (id) {\n\tcase VFE_LINE_RDI0:\n\tdefault:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI0 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\tcase VFE_LINE_RDI1:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI1 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\tcase VFE_LINE_RDI2:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI2 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\t}\n\n\tif (wm % 2 == 1)\n\t\treg <<= 16;\n\n\tvfe_reg_set(vfe, VFE_0_BUS_XBAR_CFG_x(wm), reg);\n}\n\nstatic void vfe_wm_set_subsample(struct vfe_device *vfe, u8 wm)\n{\n\twritel_relaxed(VFE_0_BUS_IMAGE_MASTER_n_WR_IRQ_SUBSAMPLE_PATTERN_DEF,\n\t\t       vfe->base +\n\t\t       VFE_0_BUS_IMAGE_MASTER_n_WR_IRQ_SUBSAMPLE_PATTERN(wm));\n}\n\nstatic void vfe_bus_disconnect_wm_from_rdi(struct vfe_device *vfe, u8 wm,\n\t\t\t\t\t   enum vfe_line_id id)\n{\n\tu32 reg;\n\n\treg = VFE_0_RDI_CFG_x_RDI_Mr_FRAME_BASED_EN(id);\n\tvfe_reg_clr(vfe, VFE_0_RDI_CFG_x(0), reg);\n\n\treg = VFE_0_RDI_CFG_x_RDI_EN_BIT;\n\tvfe_reg_clr(vfe, VFE_0_RDI_CFG_x(id), reg);\n\n\tswitch (id) {\n\tcase VFE_LINE_RDI0:\n\tdefault:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI0 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\tcase VFE_LINE_RDI1:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI1 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\tcase VFE_LINE_RDI2:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI2 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\t}\n\n\tif (wm % 2 == 1)\n\t\treg <<= 16;\n\n\tvfe_reg_clr(vfe, VFE_0_BUS_XBAR_CFG_x(wm), reg);\n}\n\nstatic void vfe_set_xbar_cfg(struct vfe_device *vfe, struct vfe_output *output,\n\t\t\t     u8 enable)\n{\n\tstruct vfe_line *line = container_of(output, struct vfe_line, output);\n\tu32 p = line->video_out.active_fmt.fmt.pix_mp.pixelformat;\n\tu32 reg;\n\tunsigned int i;\n\n\tfor (i = 0; i < output->wm_num; i++) {\n\t\tif (i == 0) {\n\t\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_LUMA <<\n\t\t\t\tVFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\t} else if (i == 1) {\n\t\t\treg = VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_EN;\n\t\t\tif (p == V4L2_PIX_FMT_NV12 || p == V4L2_PIX_FMT_NV16)\n\t\t\t\treg |= VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_SWAP_INTER_INTRA;\n\t\t} else {\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\n\t\tif (output->wm_idx[i] % 2 == 1)\n\t\t\treg <<= 16;\n\n\t\tif (enable)\n\t\t\tvfe_reg_set(vfe,\n\t\t\t\t    VFE_0_BUS_XBAR_CFG_x(output->wm_idx[i]),\n\t\t\t\t    reg);\n\t\telse\n\t\t\tvfe_reg_clr(vfe,\n\t\t\t\t    VFE_0_BUS_XBAR_CFG_x(output->wm_idx[i]),\n\t\t\t\t    reg);\n\t}\n}\n\nstatic void vfe_set_realign_cfg(struct vfe_device *vfe, struct vfe_line *line,\n\t\t\t\tu8 enable)\n{\n\t \n}\nstatic void vfe_set_rdi_cid(struct vfe_device *vfe, enum vfe_line_id id, u8 cid)\n{\n\tvfe_reg_clr(vfe, VFE_0_RDI_CFG_x(id),\n\t\t    VFE_0_RDI_CFG_x_RDI_M0_SEL_MASK);\n\n\tvfe_reg_set(vfe, VFE_0_RDI_CFG_x(id),\n\t\t    cid << VFE_0_RDI_CFG_x_RDI_M0_SEL_SHIFT);\n}\n\nstatic void vfe_reg_update(struct vfe_device *vfe, enum vfe_line_id line_id)\n{\n\tvfe->reg_update |= VFE_0_REG_UPDATE_line_n(line_id);\n\twmb();\n\twritel_relaxed(vfe->reg_update, vfe->base + VFE_0_REG_UPDATE);\n\twmb();\n}\n\nstatic inline void vfe_reg_update_clear(struct vfe_device *vfe,\n\t\t\t\t\tenum vfe_line_id line_id)\n{\n\tvfe->reg_update &= ~VFE_0_REG_UPDATE_line_n(line_id);\n}\n\nstatic void vfe_enable_irq_wm_line(struct vfe_device *vfe, u8 wm,\n\t\t\t\t   enum vfe_line_id line_id, u8 enable)\n{\n\tu32 irq_en0 = VFE_0_IRQ_MASK_0_IMAGE_MASTER_n_PING_PONG(wm) |\n\t\t      VFE_0_IRQ_MASK_0_line_n_REG_UPDATE(line_id);\n\tu32 irq_en1 = VFE_0_IRQ_MASK_1_IMAGE_MASTER_n_BUS_OVERFLOW(wm) |\n\t\t      VFE_0_IRQ_MASK_1_RDIn_SOF(line_id);\n\n\tif (enable) {\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n\t} else {\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n\t}\n}\n\nstatic void vfe_enable_irq_pix_line(struct vfe_device *vfe, u8 comp,\n\t\t\t\t    enum vfe_line_id line_id, u8 enable)\n{\n\tstruct vfe_output *output = &vfe->line[line_id].output;\n\tunsigned int i;\n\tu32 irq_en0;\n\tu32 irq_en1;\n\tu32 comp_mask = 0;\n\n\tirq_en0 = VFE_0_IRQ_MASK_0_CAMIF_SOF;\n\tirq_en0 |= VFE_0_IRQ_MASK_0_CAMIF_EOF;\n\tirq_en0 |= VFE_0_IRQ_MASK_0_IMAGE_COMPOSITE_DONE_n(comp);\n\tirq_en0 |= VFE_0_IRQ_MASK_0_line_n_REG_UPDATE(line_id);\n\tirq_en1 = VFE_0_IRQ_MASK_1_CAMIF_ERROR;\n\tfor (i = 0; i < output->wm_num; i++) {\n\t\tirq_en1 |= VFE_0_IRQ_MASK_1_IMAGE_MASTER_n_BUS_OVERFLOW(\n\t\t\t\t\t\t\toutput->wm_idx[i]);\n\t\tcomp_mask |= (1 << output->wm_idx[i]) << comp * 8;\n\t}\n\n\tif (enable) {\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_COMPOSITE_MASK_0, comp_mask);\n\t} else {\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_COMPOSITE_MASK_0, comp_mask);\n\t}\n}\n\nstatic void vfe_enable_irq_common(struct vfe_device *vfe)\n{\n\tu32 irq_en0 = VFE_0_IRQ_MASK_0_RESET_ACK;\n\tu32 irq_en1 = VFE_0_IRQ_MASK_1_VIOLATION |\n\t\t      VFE_0_IRQ_MASK_1_BUS_BDG_HALT_ACK;\n\n\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n}\n\nstatic void vfe_set_demux_cfg(struct vfe_device *vfe, struct vfe_line *line)\n{\n\tu32 val, even_cfg, odd_cfg;\n\n\twritel_relaxed(VFE_0_DEMUX_CFG_PERIOD, vfe->base + VFE_0_DEMUX_CFG);\n\n\tval = VFE_0_DEMUX_GAIN_0_CH0_EVEN | VFE_0_DEMUX_GAIN_0_CH0_ODD;\n\twritel_relaxed(val, vfe->base + VFE_0_DEMUX_GAIN_0);\n\n\tval = VFE_0_DEMUX_GAIN_1_CH1 | VFE_0_DEMUX_GAIN_1_CH2;\n\twritel_relaxed(val, vfe->base + VFE_0_DEMUX_GAIN_1);\n\n\tswitch (line->fmt[MSM_VFE_PAD_SINK].code) {\n\tcase MEDIA_BUS_FMT_YUYV8_2X8:\n\t\teven_cfg = VFE_0_DEMUX_EVEN_CFG_PATTERN_YUYV;\n\t\todd_cfg = VFE_0_DEMUX_ODD_CFG_PATTERN_YUYV;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_YVYU8_2X8:\n\t\teven_cfg = VFE_0_DEMUX_EVEN_CFG_PATTERN_YVYU;\n\t\todd_cfg = VFE_0_DEMUX_ODD_CFG_PATTERN_YVYU;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_UYVY8_2X8:\n\tdefault:\n\t\teven_cfg = VFE_0_DEMUX_EVEN_CFG_PATTERN_UYVY;\n\t\todd_cfg = VFE_0_DEMUX_ODD_CFG_PATTERN_UYVY;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_VYUY8_2X8:\n\t\teven_cfg = VFE_0_DEMUX_EVEN_CFG_PATTERN_VYUY;\n\t\todd_cfg = VFE_0_DEMUX_ODD_CFG_PATTERN_VYUY;\n\t\tbreak;\n\t}\n\n\twritel_relaxed(even_cfg, vfe->base + VFE_0_DEMUX_EVEN_CFG);\n\twritel_relaxed(odd_cfg, vfe->base + VFE_0_DEMUX_ODD_CFG);\n}\n\nstatic void vfe_set_scale_cfg(struct vfe_device *vfe, struct vfe_line *line)\n{\n\tu32 p = line->video_out.active_fmt.fmt.pix_mp.pixelformat;\n\tu32 reg;\n\tu16 input, output;\n\tu8 interp_reso;\n\tu32 phase_mult;\n\n\twritel_relaxed(0x3, vfe->base + VFE_0_SCALE_ENC_Y_CFG);\n\n\tinput = line->fmt[MSM_VFE_PAD_SINK].width;\n\toutput = line->compose.width;\n\treg = (output << 16) | input;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_Y_H_IMAGE_SIZE);\n\n\tinterp_reso = vfe_calc_interp_reso(input, output);\n\tphase_mult = input * (1 << (13 + interp_reso)) / output;\n\treg = (interp_reso << 20) | phase_mult;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_Y_H_PHASE);\n\n\tinput = line->fmt[MSM_VFE_PAD_SINK].height;\n\toutput = line->compose.height;\n\treg = (output << 16) | input;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_Y_V_IMAGE_SIZE);\n\n\tinterp_reso = vfe_calc_interp_reso(input, output);\n\tphase_mult = input * (1 << (13 + interp_reso)) / output;\n\treg = (interp_reso << 20) | phase_mult;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_Y_V_PHASE);\n\n\twritel_relaxed(0x3, vfe->base + VFE_0_SCALE_ENC_CBCR_CFG);\n\n\tinput = line->fmt[MSM_VFE_PAD_SINK].width;\n\toutput = line->compose.width / 2;\n\treg = (output << 16) | input;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_CBCR_H_IMAGE_SIZE);\n\n\tinterp_reso = vfe_calc_interp_reso(input, output);\n\tphase_mult = input * (1 << (13 + interp_reso)) / output;\n\treg = (interp_reso << 20) | phase_mult;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_CBCR_H_PHASE);\n\n\tinput = line->fmt[MSM_VFE_PAD_SINK].height;\n\toutput = line->compose.height;\n\tif (p == V4L2_PIX_FMT_NV12 || p == V4L2_PIX_FMT_NV21)\n\t\toutput = line->compose.height / 2;\n\treg = (output << 16) | input;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_CBCR_V_IMAGE_SIZE);\n\n\tinterp_reso = vfe_calc_interp_reso(input, output);\n\tphase_mult = input * (1 << (13 + interp_reso)) / output;\n\treg = (interp_reso << 20) | phase_mult;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_CBCR_V_PHASE);\n}\n\nstatic void vfe_set_crop_cfg(struct vfe_device *vfe, struct vfe_line *line)\n{\n\tu32 p = line->video_out.active_fmt.fmt.pix_mp.pixelformat;\n\tu32 reg;\n\tu16 first, last;\n\n\tfirst = line->crop.left;\n\tlast = line->crop.left + line->crop.width - 1;\n\treg = (first << 16) | last;\n\twritel_relaxed(reg, vfe->base + VFE_0_CROP_ENC_Y_WIDTH);\n\n\tfirst = line->crop.top;\n\tlast = line->crop.top + line->crop.height - 1;\n\treg = (first << 16) | last;\n\twritel_relaxed(reg, vfe->base + VFE_0_CROP_ENC_Y_HEIGHT);\n\n\tfirst = line->crop.left / 2;\n\tlast = line->crop.left / 2 + line->crop.width / 2 - 1;\n\treg = (first << 16) | last;\n\twritel_relaxed(reg, vfe->base + VFE_0_CROP_ENC_CBCR_WIDTH);\n\n\tfirst = line->crop.top;\n\tlast = line->crop.top + line->crop.height - 1;\n\tif (p == V4L2_PIX_FMT_NV12 || p == V4L2_PIX_FMT_NV21) {\n\t\tfirst = line->crop.top / 2;\n\t\tlast = line->crop.top / 2 + line->crop.height / 2 - 1;\n\t}\n\treg = (first << 16) | last;\n\twritel_relaxed(reg, vfe->base + VFE_0_CROP_ENC_CBCR_HEIGHT);\n}\n\nstatic void vfe_set_clamp_cfg(struct vfe_device *vfe)\n{\n\tu32 val = VFE_0_CLAMP_ENC_MAX_CFG_CH0 |\n\t\tVFE_0_CLAMP_ENC_MAX_CFG_CH1 |\n\t\tVFE_0_CLAMP_ENC_MAX_CFG_CH2;\n\n\twritel_relaxed(val, vfe->base + VFE_0_CLAMP_ENC_MAX_CFG);\n\n\tval = VFE_0_CLAMP_ENC_MIN_CFG_CH0 |\n\t\tVFE_0_CLAMP_ENC_MIN_CFG_CH1 |\n\t\tVFE_0_CLAMP_ENC_MIN_CFG_CH2;\n\n\twritel_relaxed(val, vfe->base + VFE_0_CLAMP_ENC_MIN_CFG);\n}\n\nstatic void vfe_set_qos(struct vfe_device *vfe)\n{\n\tu32 val = VFE_0_BUS_BDG_QOS_CFG_0_CFG;\n\tu32 val7 = VFE_0_BUS_BDG_QOS_CFG_7_CFG;\n\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_0);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_1);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_2);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_3);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_4);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_5);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_6);\n\twritel_relaxed(val7, vfe->base + VFE_0_BUS_BDG_QOS_CFG_7);\n}\n\nstatic void vfe_set_ds(struct vfe_device *vfe)\n{\n\t \n}\n\nstatic void vfe_set_cgc_override(struct vfe_device *vfe, u8 wm, u8 enable)\n{\n\tu32 val = VFE_0_CGC_OVERRIDE_1_IMAGE_Mx_CGC_OVERRIDE(wm);\n\n\tif (enable)\n\t\tvfe_reg_set(vfe, VFE_0_CGC_OVERRIDE_1, val);\n\telse\n\t\tvfe_reg_clr(vfe, VFE_0_CGC_OVERRIDE_1, val);\n\n\twmb();\n}\n\nstatic void vfe_set_camif_cfg(struct vfe_device *vfe, struct vfe_line *line)\n{\n\tu32 val;\n\n\tswitch (line->fmt[MSM_VFE_PAD_SINK].code) {\n\tcase MEDIA_BUS_FMT_YUYV8_2X8:\n\t\tval = VFE_0_CORE_CFG_PIXEL_PATTERN_YCBYCR;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_YVYU8_2X8:\n\t\tval = VFE_0_CORE_CFG_PIXEL_PATTERN_YCRYCB;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_UYVY8_2X8:\n\tdefault:\n\t\tval = VFE_0_CORE_CFG_PIXEL_PATTERN_CBYCRY;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_VYUY8_2X8:\n\t\tval = VFE_0_CORE_CFG_PIXEL_PATTERN_CRYCBY;\n\t\tbreak;\n\t}\n\n\twritel_relaxed(val, vfe->base + VFE_0_CORE_CFG);\n\n\tval = line->fmt[MSM_VFE_PAD_SINK].width * 2;\n\tval |= line->fmt[MSM_VFE_PAD_SINK].height << 16;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_FRAME_CFG);\n\n\tval = line->fmt[MSM_VFE_PAD_SINK].width * 2 - 1;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_WINDOW_WIDTH_CFG);\n\n\tval = line->fmt[MSM_VFE_PAD_SINK].height - 1;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_WINDOW_HEIGHT_CFG);\n\n\tval = 0xffffffff;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_SUBSAMPLE_CFG_0);\n\n\tval = 0xffffffff;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_IRQ_SUBSAMPLE_PATTERN);\n\n\tval = VFE_0_RDI_CFG_x_MIPI_EN_BITS;\n\tvfe_reg_set(vfe, VFE_0_RDI_CFG_x(0), val);\n\n\tval = VFE_0_CAMIF_CFG_VFE_OUTPUT_EN;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_CFG);\n}\n\nstatic void vfe_set_camif_cmd(struct vfe_device *vfe, u8 enable)\n{\n\tu32 cmd;\n\n\tcmd = VFE_0_CAMIF_CMD_CLEAR_CAMIF_STATUS | VFE_0_CAMIF_CMD_NO_CHANGE;\n\twritel_relaxed(cmd, vfe->base + VFE_0_CAMIF_CMD);\n\twmb();\n\n\tif (enable)\n\t\tcmd = VFE_0_CAMIF_CMD_ENABLE_FRAME_BOUNDARY;\n\telse\n\t\tcmd = VFE_0_CAMIF_CMD_DISABLE_FRAME_BOUNDARY;\n\n\twritel_relaxed(cmd, vfe->base + VFE_0_CAMIF_CMD);\n}\n\nstatic void vfe_set_module_cfg(struct vfe_device *vfe, u8 enable)\n{\n\tu32 val = VFE_0_MODULE_CFG_DEMUX |\n\t\t  VFE_0_MODULE_CFG_CHROMA_UPSAMPLE |\n\t\t  VFE_0_MODULE_CFG_SCALE_ENC |\n\t\t  VFE_0_MODULE_CFG_CROP_ENC;\n\n\tif (enable)\n\t\twritel_relaxed(val, vfe->base + VFE_0_MODULE_CFG);\n\telse\n\t\twritel_relaxed(0x0, vfe->base + VFE_0_MODULE_CFG);\n}\n\nstatic int vfe_camif_wait_for_stop(struct vfe_device *vfe, struct device *dev)\n{\n\tu32 val;\n\tint ret;\n\n\tret = readl_poll_timeout(vfe->base + VFE_0_CAMIF_STATUS,\n\t\t\t\t val,\n\t\t\t\t (val & VFE_0_CAMIF_STATUS_HALT),\n\t\t\t\t CAMIF_TIMEOUT_SLEEP_US,\n\t\t\t\t CAMIF_TIMEOUT_ALL_US);\n\tif (ret < 0)\n\t\tdev_err(dev, \"%s: camif stop timeout\\n\", __func__);\n\n\treturn ret;\n}\n\nstatic void vfe_isr_read(struct vfe_device *vfe, u32 *value0, u32 *value1)\n{\n\t*value0 = readl_relaxed(vfe->base + VFE_0_IRQ_STATUS_0);\n\t*value1 = readl_relaxed(vfe->base + VFE_0_IRQ_STATUS_1);\n\n\twritel_relaxed(*value0, vfe->base + VFE_0_IRQ_CLEAR_0);\n\twritel_relaxed(*value1, vfe->base + VFE_0_IRQ_CLEAR_1);\n\n\twmb();\n\twritel_relaxed(VFE_0_IRQ_CMD_GLOBAL_CLEAR, vfe->base + VFE_0_IRQ_CMD);\n}\n\nstatic void vfe_violation_read(struct vfe_device *vfe)\n{\n\tu32 violation = readl_relaxed(vfe->base + VFE_0_VIOLATION_STATUS);\n\n\tpr_err_ratelimited(\"VFE: violation = 0x%08x\\n\", violation);\n}\n\n \nstatic irqreturn_t vfe_isr(int irq, void *dev)\n{\n\tstruct vfe_device *vfe = dev;\n\tu32 value0, value1;\n\tint i, j;\n\n\tvfe->ops->isr_read(vfe, &value0, &value1);\n\n\tdev_dbg(vfe->camss->dev, \"VFE: status0 = 0x%08x, status1 = 0x%08x\\n\",\n\t\tvalue0, value1);\n\n\tif (value0 & VFE_0_IRQ_STATUS_0_RESET_ACK)\n\t\tvfe->isr_ops.reset_ack(vfe);\n\n\tif (value1 & VFE_0_IRQ_STATUS_1_VIOLATION)\n\t\tvfe->ops->violation_read(vfe);\n\n\tif (value1 & VFE_0_IRQ_STATUS_1_BUS_BDG_HALT_ACK)\n\t\tvfe->isr_ops.halt_ack(vfe);\n\n\tfor (i = VFE_LINE_RDI0; i <= VFE_LINE_PIX; i++)\n\t\tif (value0 & VFE_0_IRQ_STATUS_0_line_n_REG_UPDATE(i))\n\t\t\tvfe->isr_ops.reg_update(vfe, i);\n\n\tif (value0 & VFE_0_IRQ_STATUS_0_CAMIF_SOF)\n\t\tvfe->isr_ops.sof(vfe, VFE_LINE_PIX);\n\n\tfor (i = VFE_LINE_RDI0; i <= VFE_LINE_RDI2; i++)\n\t\tif (value1 & VFE_0_IRQ_STATUS_1_RDIn_SOF(i))\n\t\t\tvfe->isr_ops.sof(vfe, i);\n\n\tfor (i = 0; i < MSM_VFE_COMPOSITE_IRQ_NUM; i++)\n\t\tif (value0 & VFE_0_IRQ_STATUS_0_IMAGE_COMPOSITE_DONE_n(i)) {\n\t\t\tvfe->isr_ops.comp_done(vfe, i);\n\t\t\tfor (j = 0; j < ARRAY_SIZE(vfe->wm_output_map); j++)\n\t\t\t\tif (vfe->wm_output_map[j] == VFE_LINE_PIX)\n\t\t\t\t\tvalue0 &= ~VFE_0_IRQ_MASK_0_IMAGE_MASTER_n_PING_PONG(j);\n\t\t}\n\n\tfor (i = 0; i < MSM_VFE_IMAGE_MASTERS_NUM; i++)\n\t\tif (value0 & VFE_0_IRQ_STATUS_0_IMAGE_MASTER_n_PING_PONG(i))\n\t\t\tvfe->isr_ops.wm_done(vfe, i);\n\n\treturn IRQ_HANDLED;\n}\n\n \nstatic void vfe_pm_domain_off(struct vfe_device *vfe)\n{\n\t \n}\n\n \nstatic int vfe_pm_domain_on(struct vfe_device *vfe)\n{\n\treturn 0;\n}\n\nstatic const struct vfe_hw_ops_gen1 vfe_ops_gen1_4_1 = {\n\t.bus_connect_wm_to_rdi = vfe_bus_connect_wm_to_rdi,\n\t.bus_disconnect_wm_from_rdi = vfe_bus_disconnect_wm_from_rdi,\n\t.bus_enable_wr_if = vfe_bus_enable_wr_if,\n\t.bus_reload_wm = vfe_bus_reload_wm,\n\t.camif_wait_for_stop = vfe_camif_wait_for_stop,\n\t.enable_irq_common = vfe_enable_irq_common,\n\t.enable_irq_pix_line = vfe_enable_irq_pix_line,\n\t.enable_irq_wm_line = vfe_enable_irq_wm_line,\n\t.get_ub_size = vfe_get_ub_size,\n\t.halt_clear = vfe_halt_clear,\n\t.halt_request = vfe_halt_request,\n\t.set_camif_cfg = vfe_set_camif_cfg,\n\t.set_camif_cmd = vfe_set_camif_cmd,\n\t.set_cgc_override = vfe_set_cgc_override,\n\t.set_clamp_cfg = vfe_set_clamp_cfg,\n\t.set_crop_cfg = vfe_set_crop_cfg,\n\t.set_demux_cfg = vfe_set_demux_cfg,\n\t.set_ds = vfe_set_ds,\n\t.set_module_cfg = vfe_set_module_cfg,\n\t.set_qos = vfe_set_qos,\n\t.set_rdi_cid = vfe_set_rdi_cid,\n\t.set_realign_cfg = vfe_set_realign_cfg,\n\t.set_scale_cfg = vfe_set_scale_cfg,\n\t.set_xbar_cfg = vfe_set_xbar_cfg,\n\t.wm_enable = vfe_wm_enable,\n\t.wm_frame_based = vfe_wm_frame_based,\n\t.wm_get_ping_pong_status = vfe_wm_get_ping_pong_status,\n\t.wm_line_based = vfe_wm_line_based,\n\t.wm_set_framedrop_pattern = vfe_wm_set_framedrop_pattern,\n\t.wm_set_framedrop_period = vfe_wm_set_framedrop_period,\n\t.wm_set_ping_addr = vfe_wm_set_ping_addr,\n\t.wm_set_pong_addr = vfe_wm_set_pong_addr,\n\t.wm_set_subsample = vfe_wm_set_subsample,\n\t.wm_set_ub_cfg = vfe_wm_set_ub_cfg,\n};\n\nstatic void vfe_subdev_init(struct device *dev, struct vfe_device *vfe)\n{\n\tvfe->isr_ops = vfe_isr_ops_gen1;\n\tvfe->ops_gen1 = &vfe_ops_gen1_4_1;\n\tvfe->video_ops = vfe_video_ops_gen1;\n\n\tvfe->line_num = VFE_LINE_NUM_GEN1;\n}\n\nconst struct vfe_hw_ops vfe_ops_4_1 = {\n\t.global_reset = vfe_global_reset,\n\t.hw_version = vfe_hw_version,\n\t.isr_read = vfe_isr_read,\n\t.isr = vfe_isr,\n\t.pm_domain_off = vfe_pm_domain_off,\n\t.pm_domain_on = vfe_pm_domain_on,\n\t.reg_update_clear = vfe_reg_update_clear,\n\t.reg_update = vfe_reg_update,\n\t.subdev_init = vfe_subdev_init,\n\t.vfe_disable = vfe_gen1_disable,\n\t.vfe_enable = vfe_gen1_enable,\n\t.vfe_halt = vfe_gen1_halt,\n\t.violation_read = vfe_violation_read,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}