{
  "module_name": "camss-vfe-4-7.c",
  "hash_id": "4d8d43b15e4f35531936d4908404dc47c6152219fc9a0bcf9fd6ebb535ebb5ff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/qcom/camss/camss-vfe-4-7.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/iopoll.h>\n\n#include \"camss.h\"\n#include \"camss-vfe.h\"\n#include \"camss-vfe-gen1.h\"\n\n\n#define VFE_0_HW_VERSION\t\t0x000\n\n#define VFE_0_GLOBAL_RESET_CMD\t\t0x018\n#define VFE_0_GLOBAL_RESET_CMD_CORE\tBIT(0)\n#define VFE_0_GLOBAL_RESET_CMD_CAMIF\tBIT(1)\n#define VFE_0_GLOBAL_RESET_CMD_BUS\tBIT(2)\n#define VFE_0_GLOBAL_RESET_CMD_BUS_BDG\tBIT(3)\n#define VFE_0_GLOBAL_RESET_CMD_REGISTER\tBIT(4)\n#define VFE_0_GLOBAL_RESET_CMD_PM\tBIT(5)\n#define VFE_0_GLOBAL_RESET_CMD_BUS_MISR\tBIT(6)\n#define VFE_0_GLOBAL_RESET_CMD_TESTGEN\tBIT(7)\n#define VFE_0_GLOBAL_RESET_CMD_DSP\tBIT(8)\n#define VFE_0_GLOBAL_RESET_CMD_IDLE_CGC\tBIT(9)\n\n#define VFE_0_MODULE_LENS_EN\t\t0x040\n#define VFE_0_MODULE_LENS_EN_DEMUX\t\tBIT(2)\n#define VFE_0_MODULE_LENS_EN_CHROMA_UPSAMPLE\tBIT(3)\n\n#define VFE_0_MODULE_ZOOM_EN\t\t0x04c\n#define VFE_0_MODULE_ZOOM_EN_SCALE_ENC\t\tBIT(1)\n#define VFE_0_MODULE_ZOOM_EN_CROP_ENC\t\tBIT(2)\n#define VFE_0_MODULE_ZOOM_EN_REALIGN_BUF\tBIT(9)\n\n#define VFE_0_CORE_CFG\t\t\t0x050\n#define VFE_0_CORE_CFG_PIXEL_PATTERN_YCBYCR\t0x4\n#define VFE_0_CORE_CFG_PIXEL_PATTERN_YCRYCB\t0x5\n#define VFE_0_CORE_CFG_PIXEL_PATTERN_CBYCRY\t0x6\n#define VFE_0_CORE_CFG_PIXEL_PATTERN_CRYCBY\t0x7\n#define VFE_0_CORE_CFG_COMPOSITE_REG_UPDATE_EN\tBIT(4)\n\n#define VFE_0_IRQ_CMD\t\t\t0x058\n#define VFE_0_IRQ_CMD_GLOBAL_CLEAR\tBIT(0)\n\n#define VFE_0_IRQ_MASK_0\t\t0x05c\n#define VFE_0_IRQ_MASK_0_CAMIF_SOF\t\t\tBIT(0)\n#define VFE_0_IRQ_MASK_0_CAMIF_EOF\t\t\tBIT(1)\n#define VFE_0_IRQ_MASK_0_RDIn_REG_UPDATE(n)\t\tBIT((n) + 5)\n#define VFE_0_IRQ_MASK_0_line_n_REG_UPDATE(n)\t\t\\\n\t((n) == VFE_LINE_PIX ? BIT(4) : VFE_0_IRQ_MASK_0_RDIn_REG_UPDATE(n))\n#define VFE_0_IRQ_MASK_0_IMAGE_MASTER_n_PING_PONG(n)\tBIT((n) + 8)\n#define VFE_0_IRQ_MASK_0_IMAGE_COMPOSITE_DONE_n(n)\tBIT((n) + 25)\n#define VFE_0_IRQ_MASK_0_RESET_ACK\t\t\tBIT(31)\n#define VFE_0_IRQ_MASK_1\t\t0x060\n#define VFE_0_IRQ_MASK_1_CAMIF_ERROR\t\t\tBIT(0)\n#define VFE_0_IRQ_MASK_1_VIOLATION\t\t\tBIT(7)\n#define VFE_0_IRQ_MASK_1_BUS_BDG_HALT_ACK\t\tBIT(8)\n#define VFE_0_IRQ_MASK_1_IMAGE_MASTER_n_BUS_OVERFLOW(n)\tBIT((n) + 9)\n#define VFE_0_IRQ_MASK_1_RDIn_SOF(n)\t\t\tBIT((n) + 29)\n\n#define VFE_0_IRQ_CLEAR_0\t\t0x064\n#define VFE_0_IRQ_CLEAR_1\t\t0x068\n\n#define VFE_0_IRQ_STATUS_0\t\t0x06c\n#define VFE_0_IRQ_STATUS_0_CAMIF_SOF\t\t\tBIT(0)\n#define VFE_0_IRQ_STATUS_0_RDIn_REG_UPDATE(n)\t\tBIT((n) + 5)\n#define VFE_0_IRQ_STATUS_0_line_n_REG_UPDATE(n)\t\t\\\n\t((n) == VFE_LINE_PIX ? BIT(4) : VFE_0_IRQ_STATUS_0_RDIn_REG_UPDATE(n))\n#define VFE_0_IRQ_STATUS_0_IMAGE_MASTER_n_PING_PONG(n)\tBIT((n) + 8)\n#define VFE_0_IRQ_STATUS_0_IMAGE_COMPOSITE_DONE_n(n)\tBIT((n) + 25)\n#define VFE_0_IRQ_STATUS_0_RESET_ACK\t\t\tBIT(31)\n#define VFE_0_IRQ_STATUS_1\t\t0x070\n#define VFE_0_IRQ_STATUS_1_VIOLATION\t\t\tBIT(7)\n#define VFE_0_IRQ_STATUS_1_BUS_BDG_HALT_ACK\t\tBIT(8)\n#define VFE_0_IRQ_STATUS_1_RDIn_SOF(n)\t\t\tBIT((n) + 29)\n\n#define VFE_0_IRQ_COMPOSITE_MASK_0\t0x074\n#define VFE_0_VIOLATION_STATUS\t\t0x07c\n\n#define VFE_0_BUS_CMD\t\t\t0x80\n#define VFE_0_BUS_CMD_Mx_RLD_CMD(x)\tBIT(x)\n\n#define VFE_0_BUS_CFG\t\t\t0x084\n\n#define VFE_0_BUS_XBAR_CFG_x(x)\t\t(0x90 + 0x4 * ((x) / 2))\n#define VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_EN\t\t\tBIT(2)\n#define VFE_0_BUS_XBAR_CFG_x_M_REALIGN_BUF_EN\t\t\tBIT(3)\n#define VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_SWAP_INTRA\t\t(0x1 << 4)\n#define VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_SWAP_INTER\t\t(0x2 << 4)\n#define VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_SWAP_INTER_INTRA\t(0x3 << 4)\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT\t\t8\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_LUMA\t\t0x0\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI0\t0xc\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI1\t0xd\n#define VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI2\t0xe\n\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_CFG(n)\t\t(0x0a0 + 0x2c * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_CFG_WR_PATH_SHIFT\t0\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_PING_ADDR(n)\t(0x0a4 + 0x2c * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_PONG_ADDR(n)\t(0x0ac + 0x2c * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG(n)\t\t(0x0b4 + 0x2c * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_BASED_SHIFT\t1\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_SHIFT\t2\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_MASK\t(0x1f << 2)\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_UB_CFG(n)\t\t(0x0b8 + 0x2c * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_UB_CFG_OFFSET_SHIFT\t16\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_IMAGE_SIZE(n)\t(0x0bc + 0x2c * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_BUFFER_CFG(n)\t(0x0c0 + 0x2c * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_FRAMEDROP_PATTERN(n)\t\\\n\t\t\t\t\t\t\t(0x0c4 + 0x2c * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_IRQ_SUBSAMPLE_PATTERN(n)\t\\\n\t\t\t\t\t\t\t(0x0c8 + 0x2c * (n))\n#define VFE_0_BUS_IMAGE_MASTER_n_WR_IRQ_SUBSAMPLE_PATTERN_DEF\t0xffffffff\n\n#define VFE_0_BUS_PING_PONG_STATUS\t0x338\n\n#define VFE_0_BUS_BDG_CMD\t\t0x400\n#define VFE_0_BUS_BDG_CMD_HALT_REQ\t1\n\n#define VFE_0_BUS_BDG_QOS_CFG_0\t\t0x404\n#define VFE_0_BUS_BDG_QOS_CFG_0_CFG\t0xaaa9aaa9\n#define VFE_0_BUS_BDG_QOS_CFG_1\t\t0x408\n#define VFE_0_BUS_BDG_QOS_CFG_2\t\t0x40c\n#define VFE_0_BUS_BDG_QOS_CFG_3\t\t0x410\n#define VFE_0_BUS_BDG_QOS_CFG_4\t\t0x414\n#define VFE_0_BUS_BDG_QOS_CFG_5\t\t0x418\n#define VFE_0_BUS_BDG_QOS_CFG_6\t\t0x41c\n#define VFE_0_BUS_BDG_QOS_CFG_7\t\t0x420\n#define VFE_0_BUS_BDG_QOS_CFG_7_CFG\t0x0001aaa9\n\n#define VFE48_0_BUS_BDG_QOS_CFG_0_CFG\t0xaaa5aaa5\n#define VFE48_0_BUS_BDG_QOS_CFG_3_CFG\t0xaa55aaa5\n#define VFE48_0_BUS_BDG_QOS_CFG_4_CFG\t0xaa55aa55\n#define VFE48_0_BUS_BDG_QOS_CFG_7_CFG\t0x0005aa55\n\n#define VFE_0_BUS_BDG_DS_CFG_0\t\t0x424\n#define VFE_0_BUS_BDG_DS_CFG_0_CFG\t0xcccc0011\n#define VFE_0_BUS_BDG_DS_CFG_1\t\t0x428\n#define VFE_0_BUS_BDG_DS_CFG_2\t\t0x42c\n#define VFE_0_BUS_BDG_DS_CFG_3\t\t0x430\n#define VFE_0_BUS_BDG_DS_CFG_4\t\t0x434\n#define VFE_0_BUS_BDG_DS_CFG_5\t\t0x438\n#define VFE_0_BUS_BDG_DS_CFG_6\t\t0x43c\n#define VFE_0_BUS_BDG_DS_CFG_7\t\t0x440\n#define VFE_0_BUS_BDG_DS_CFG_8\t\t0x444\n#define VFE_0_BUS_BDG_DS_CFG_9\t\t0x448\n#define VFE_0_BUS_BDG_DS_CFG_10\t\t0x44c\n#define VFE_0_BUS_BDG_DS_CFG_11\t\t0x450\n#define VFE_0_BUS_BDG_DS_CFG_12\t\t0x454\n#define VFE_0_BUS_BDG_DS_CFG_13\t\t0x458\n#define VFE_0_BUS_BDG_DS_CFG_14\t\t0x45c\n#define VFE_0_BUS_BDG_DS_CFG_15\t\t0x460\n#define VFE_0_BUS_BDG_DS_CFG_16\t\t0x464\n#define VFE_0_BUS_BDG_DS_CFG_16_CFG\t0x40000103\n\n#define VFE48_0_BUS_BDG_DS_CFG_0_CFG\t0xcccc1111\n#define VFE48_0_BUS_BDG_DS_CFG_16_CFG\t0x00000110\n\n#define VFE_0_RDI_CFG_x(x)\t\t(0x46c + (0x4 * (x)))\n#define VFE_0_RDI_CFG_x_RDI_STREAM_SEL_SHIFT\t28\n#define VFE_0_RDI_CFG_x_RDI_STREAM_SEL_MASK\t(0xf << 28)\n#define VFE_0_RDI_CFG_x_RDI_M0_SEL_SHIFT\t4\n#define VFE_0_RDI_CFG_x_RDI_M0_SEL_MASK\t\t(0xf << 4)\n#define VFE_0_RDI_CFG_x_RDI_EN_BIT\t\tBIT(2)\n#define VFE_0_RDI_CFG_x_MIPI_EN_BITS\t\t0x3\n\n#define VFE_0_CAMIF_CMD\t\t\t\t0x478\n#define VFE_0_CAMIF_CMD_DISABLE_FRAME_BOUNDARY\t0\n#define VFE_0_CAMIF_CMD_ENABLE_FRAME_BOUNDARY\t1\n#define VFE_0_CAMIF_CMD_NO_CHANGE\t\t3\n#define VFE_0_CAMIF_CMD_CLEAR_CAMIF_STATUS\tBIT(2)\n#define VFE_0_CAMIF_CFG\t\t\t\t0x47c\n#define VFE_0_CAMIF_CFG_VFE_OUTPUT_EN\t\tBIT(6)\n#define VFE_0_CAMIF_FRAME_CFG\t\t\t0x484\n#define VFE_0_CAMIF_WINDOW_WIDTH_CFG\t\t0x488\n#define VFE_0_CAMIF_WINDOW_HEIGHT_CFG\t\t0x48c\n#define VFE_0_CAMIF_SUBSAMPLE_CFG\t\t0x490\n#define VFE_0_CAMIF_IRQ_FRAMEDROP_PATTERN\t0x498\n#define VFE_0_CAMIF_IRQ_SUBSAMPLE_PATTERN\t0x49c\n#define VFE_0_CAMIF_STATUS\t\t\t0x4a4\n#define VFE_0_CAMIF_STATUS_HALT\t\t\tBIT(31)\n\n#define VFE_0_REG_UPDATE\t\t0x4ac\n#define VFE_0_REG_UPDATE_RDIn(n)\t\tBIT(1 + (n))\n#define VFE_0_REG_UPDATE_line_n(n)\t\t\\\n\t\t\t((n) == VFE_LINE_PIX ? 1 : VFE_0_REG_UPDATE_RDIn(n))\n\n#define VFE_0_DEMUX_CFG\t\t\t\t0x560\n#define VFE_0_DEMUX_CFG_PERIOD\t\t\t0x3\n#define VFE_0_DEMUX_GAIN_0\t\t\t0x564\n#define VFE_0_DEMUX_GAIN_0_CH0_EVEN\t\t(0x80 << 0)\n#define VFE_0_DEMUX_GAIN_0_CH0_ODD\t\t(0x80 << 16)\n#define VFE_0_DEMUX_GAIN_1\t\t\t0x568\n#define VFE_0_DEMUX_GAIN_1_CH1\t\t\t(0x80 << 0)\n#define VFE_0_DEMUX_GAIN_1_CH2\t\t\t(0x80 << 16)\n#define VFE_0_DEMUX_EVEN_CFG\t\t\t0x574\n#define VFE_0_DEMUX_EVEN_CFG_PATTERN_YUYV\t0x9cac\n#define VFE_0_DEMUX_EVEN_CFG_PATTERN_YVYU\t0xac9c\n#define VFE_0_DEMUX_EVEN_CFG_PATTERN_UYVY\t0xc9ca\n#define VFE_0_DEMUX_EVEN_CFG_PATTERN_VYUY\t0xcac9\n#define VFE_0_DEMUX_ODD_CFG\t\t\t0x578\n#define VFE_0_DEMUX_ODD_CFG_PATTERN_YUYV\t0x9cac\n#define VFE_0_DEMUX_ODD_CFG_PATTERN_YVYU\t0xac9c\n#define VFE_0_DEMUX_ODD_CFG_PATTERN_UYVY\t0xc9ca\n#define VFE_0_DEMUX_ODD_CFG_PATTERN_VYUY\t0xcac9\n\n#define VFE_0_SCALE_ENC_Y_CFG\t\t\t0x91c\n#define VFE_0_SCALE_ENC_Y_H_IMAGE_SIZE\t\t0x920\n#define VFE_0_SCALE_ENC_Y_H_PHASE\t\t0x924\n#define VFE_0_SCALE_ENC_Y_V_IMAGE_SIZE\t\t0x934\n#define VFE_0_SCALE_ENC_Y_V_PHASE\t\t0x938\n#define VFE_0_SCALE_ENC_CBCR_CFG\t\t0x948\n#define VFE_0_SCALE_ENC_CBCR_H_IMAGE_SIZE\t0x94c\n#define VFE_0_SCALE_ENC_CBCR_H_PHASE\t\t0x950\n#define VFE_0_SCALE_ENC_CBCR_V_IMAGE_SIZE\t0x960\n#define VFE_0_SCALE_ENC_CBCR_V_PHASE\t\t0x964\n\n#define VFE_0_CROP_ENC_Y_WIDTH\t\t\t0x974\n#define VFE_0_CROP_ENC_Y_HEIGHT\t\t\t0x978\n#define VFE_0_CROP_ENC_CBCR_WIDTH\t\t0x97c\n#define VFE_0_CROP_ENC_CBCR_HEIGHT\t\t0x980\n\n#define VFE_0_CLAMP_ENC_MAX_CFG\t\t\t0x984\n#define VFE_0_CLAMP_ENC_MAX_CFG_CH0\t\t(0xff << 0)\n#define VFE_0_CLAMP_ENC_MAX_CFG_CH1\t\t(0xff << 8)\n#define VFE_0_CLAMP_ENC_MAX_CFG_CH2\t\t(0xff << 16)\n#define VFE_0_CLAMP_ENC_MIN_CFG\t\t\t0x988\n#define VFE_0_CLAMP_ENC_MIN_CFG_CH0\t\t(0x0 << 0)\n#define VFE_0_CLAMP_ENC_MIN_CFG_CH1\t\t(0x0 << 8)\n#define VFE_0_CLAMP_ENC_MIN_CFG_CH2\t\t(0x0 << 16)\n\n#define VFE_0_REALIGN_BUF_CFG\t\t\t0xaac\n#define VFE_0_REALIGN_BUF_CFG_CB_ODD_PIXEL     BIT(2)\n#define VFE_0_REALIGN_BUF_CFG_CR_ODD_PIXEL     BIT(3)\n#define VFE_0_REALIGN_BUF_CFG_HSUB_ENABLE      BIT(4)\n\n#define VFE48_0_BUS_IMAGE_MASTER_CMD\t\t0xcec\n#define VFE48_0_BUS_IMAGE_MASTER_n_SHIFT(x)\t(2 * (x))\n\n#define CAMIF_TIMEOUT_SLEEP_US 1000\n#define CAMIF_TIMEOUT_ALL_US 1000000\n\n#define MSM_VFE_VFE0_UB_SIZE 2047\n#define MSM_VFE_VFE0_UB_SIZE_RDI (MSM_VFE_VFE0_UB_SIZE / 3)\n#define MSM_VFE_VFE1_UB_SIZE 1535\n#define MSM_VFE_VFE1_UB_SIZE_RDI (MSM_VFE_VFE1_UB_SIZE / 3)\n\nstatic u32 vfe_hw_version(struct vfe_device *vfe)\n{\n\tu32 hw_version = readl_relaxed(vfe->base + VFE_0_HW_VERSION);\n\n\tdev_dbg(vfe->camss->dev, \"VFE HW Version = 0x%08x\\n\", hw_version);\n\n\treturn hw_version;\n}\n\nstatic u16 vfe_get_ub_size(u8 vfe_id)\n{\n\tif (vfe_id == 0)\n\t\treturn MSM_VFE_VFE0_UB_SIZE_RDI;\n\telse if (vfe_id == 1)\n\t\treturn MSM_VFE_VFE1_UB_SIZE_RDI;\n\n\treturn 0;\n}\n\nstatic inline void vfe_reg_clr(struct vfe_device *vfe, u32 reg, u32 clr_bits)\n{\n\tu32 bits = readl_relaxed(vfe->base + reg);\n\n\twritel_relaxed(bits & ~clr_bits, vfe->base + reg);\n}\n\nstatic inline void vfe_reg_set(struct vfe_device *vfe, u32 reg, u32 set_bits)\n{\n\tu32 bits = readl_relaxed(vfe->base + reg);\n\n\twritel_relaxed(bits | set_bits, vfe->base + reg);\n}\n\nstatic void vfe_global_reset(struct vfe_device *vfe)\n{\n\tu32 reset_bits = VFE_0_GLOBAL_RESET_CMD_IDLE_CGC\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_DSP\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_TESTGEN\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_BUS_MISR\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_PM\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_REGISTER\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_BUS_BDG\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_BUS\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_CAMIF\t\t|\n\t\t\t VFE_0_GLOBAL_RESET_CMD_CORE;\n\n\twritel_relaxed(BIT(31), vfe->base + VFE_0_IRQ_MASK_0);\n\n\t \n\twmb();\n\twritel_relaxed(reset_bits, vfe->base + VFE_0_GLOBAL_RESET_CMD);\n}\n\nstatic void vfe_halt_request(struct vfe_device *vfe)\n{\n\twritel_relaxed(VFE_0_BUS_BDG_CMD_HALT_REQ,\n\t\t       vfe->base + VFE_0_BUS_BDG_CMD);\n}\n\nstatic void vfe_halt_clear(struct vfe_device *vfe)\n{\n\twritel_relaxed(0x0, vfe->base + VFE_0_BUS_BDG_CMD);\n}\n\nstatic void vfe_wm_enable(struct vfe_device *vfe, u8 wm, u8 enable)\n{\n\tif (enable)\n\t\tvfe_reg_set(vfe, VFE_0_BUS_IMAGE_MASTER_n_WR_CFG(wm),\n\t\t\t    1 << VFE_0_BUS_IMAGE_MASTER_n_WR_CFG_WR_PATH_SHIFT);\n\telse\n\t\tvfe_reg_clr(vfe, VFE_0_BUS_IMAGE_MASTER_n_WR_CFG(wm),\n\t\t\t    1 << VFE_0_BUS_IMAGE_MASTER_n_WR_CFG_WR_PATH_SHIFT);\n}\n\nstatic void vfe_wm_frame_based(struct vfe_device *vfe, u8 wm, u8 enable)\n{\n\tif (enable)\n\t\tvfe_reg_set(vfe, VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG(wm),\n\t\t\t1 << VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_BASED_SHIFT);\n\telse\n\t\tvfe_reg_clr(vfe, VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG(wm),\n\t\t\t1 << VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_BASED_SHIFT);\n}\n\n#define CALC_WORD(width, M, N) (((width) * (M) + (N) - 1) / (N))\n\nstatic int vfe_word_per_line_by_pixel(u32 format, u32 pixel_per_line)\n{\n\tint val = 0;\n\n\tswitch (format) {\n\tcase V4L2_PIX_FMT_NV12:\n\tcase V4L2_PIX_FMT_NV21:\n\tcase V4L2_PIX_FMT_NV16:\n\tcase V4L2_PIX_FMT_NV61:\n\t\tval = CALC_WORD(pixel_per_line, 1, 8);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_YUYV:\n\tcase V4L2_PIX_FMT_YVYU:\n\tcase V4L2_PIX_FMT_UYVY:\n\tcase V4L2_PIX_FMT_VYUY:\n\t\tval = CALC_WORD(pixel_per_line, 2, 8);\n\t\tbreak;\n\t}\n\n\treturn val;\n}\n\nstatic int vfe_word_per_line_by_bytes(u32 bytes_per_line)\n{\n\treturn CALC_WORD(bytes_per_line, 1, 8);\n}\n\nstatic void vfe_get_wm_sizes(struct v4l2_pix_format_mplane *pix, u8 plane,\n\t\t\t     u16 *width, u16 *height, u16 *bytesperline)\n{\n\t*width = pix->width;\n\t*height = pix->height;\n\n\tswitch (pix->pixelformat) {\n\tcase V4L2_PIX_FMT_NV12:\n\tcase V4L2_PIX_FMT_NV21:\n\t\t*bytesperline = pix->plane_fmt[0].bytesperline;\n\t\tif (plane == 1)\n\t\t\t*height /= 2;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_NV16:\n\tcase V4L2_PIX_FMT_NV61:\n\t\t*bytesperline = pix->plane_fmt[0].bytesperline;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_YUYV:\n\tcase V4L2_PIX_FMT_YVYU:\n\tcase V4L2_PIX_FMT_VYUY:\n\tcase V4L2_PIX_FMT_UYVY:\n\t\t*bytesperline = pix->plane_fmt[plane].bytesperline;\n\t\tbreak;\n\t}\n}\n\nstatic void vfe_wm_line_based(struct vfe_device *vfe, u32 wm,\n\t\t\t      struct v4l2_pix_format_mplane *pix,\n\t\t\t      u8 plane, u32 enable)\n{\n\tu32 reg;\n\n\tif (enable) {\n\t\tu16 width = 0, height = 0, bytesperline = 0, wpl;\n\n\t\tvfe_get_wm_sizes(pix, plane, &width, &height, &bytesperline);\n\n\t\twpl = vfe_word_per_line_by_pixel(pix->pixelformat, width);\n\n\t\treg = height - 1;\n\t\treg |= ((wpl + 3) / 4 - 1) << 16;\n\n\t\twritel_relaxed(reg, vfe->base +\n\t\t\t       VFE_0_BUS_IMAGE_MASTER_n_WR_IMAGE_SIZE(wm));\n\n\t\twpl = vfe_word_per_line_by_bytes(bytesperline);\n\n\t\treg = 0x3;\n\t\treg |= (height - 1) << 2;\n\t\treg |= ((wpl + 1) / 2) << 16;\n\n\t\twritel_relaxed(reg, vfe->base +\n\t\t\t       VFE_0_BUS_IMAGE_MASTER_n_WR_BUFFER_CFG(wm));\n\t} else {\n\t\twritel_relaxed(0, vfe->base +\n\t\t\t       VFE_0_BUS_IMAGE_MASTER_n_WR_IMAGE_SIZE(wm));\n\t\twritel_relaxed(0, vfe->base +\n\t\t\t       VFE_0_BUS_IMAGE_MASTER_n_WR_BUFFER_CFG(wm));\n\t}\n}\n\nstatic void vfe_wm_set_framedrop_period(struct vfe_device *vfe, u8 wm, u8 per)\n{\n\tu32 reg;\n\n\treg = readl_relaxed(vfe->base +\n\t\t\t    VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG(wm));\n\n\treg &= ~(VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_MASK);\n\n\treg |= (per << VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_SHIFT)\n\t\t& VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG_FRM_DROP_PER_MASK;\n\n\twritel_relaxed(reg,\n\t\t       vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_ADDR_CFG(wm));\n}\n\nstatic void vfe_wm_set_framedrop_pattern(struct vfe_device *vfe, u8 wm,\n\t\t\t\t\t u32 pattern)\n{\n\twritel_relaxed(pattern,\n\t       vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_FRAMEDROP_PATTERN(wm));\n}\n\nstatic void vfe_wm_set_ub_cfg(struct vfe_device *vfe, u8 wm,\n\t\t\t      u16 offset, u16 depth)\n{\n\tu32 reg;\n\n\treg = (offset << VFE_0_BUS_IMAGE_MASTER_n_WR_UB_CFG_OFFSET_SHIFT) |\n\t\tdepth;\n\twritel_relaxed(reg, vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_UB_CFG(wm));\n}\n\nstatic void vfe_bus_reload_wm(struct vfe_device *vfe, u8 wm)\n{\n\t \n\twmb();\n\n\twritel_relaxed(VFE_0_BUS_CMD_Mx_RLD_CMD(wm), vfe->base + VFE_0_BUS_CMD);\n\n\t \n\twmb();\n}\n\nstatic void vfe_wm_set_ping_addr(struct vfe_device *vfe, u8 wm, u32 addr)\n{\n\twritel_relaxed(addr,\n\t\t       vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_PING_ADDR(wm));\n}\n\nstatic void vfe_wm_set_pong_addr(struct vfe_device *vfe, u8 wm, u32 addr)\n{\n\twritel_relaxed(addr,\n\t\t       vfe->base + VFE_0_BUS_IMAGE_MASTER_n_WR_PONG_ADDR(wm));\n}\n\nstatic int vfe_wm_get_ping_pong_status(struct vfe_device *vfe, u8 wm)\n{\n\tu32 reg;\n\n\treg = readl_relaxed(vfe->base + VFE_0_BUS_PING_PONG_STATUS);\n\n\treturn (reg >> wm) & 0x1;\n}\n\nstatic void vfe_bus_enable_wr_if(struct vfe_device *vfe, u8 enable)\n{\n\tif (enable)\n\t\twritel_relaxed(0x101, vfe->base + VFE_0_BUS_CFG);\n\telse\n\t\twritel_relaxed(0, vfe->base + VFE_0_BUS_CFG);\n}\n\nstatic void vfe_bus_connect_wm_to_rdi(struct vfe_device *vfe, u8 wm,\n\t\t\t\t      enum vfe_line_id id)\n{\n\tu32 reg;\n\n\treg = VFE_0_RDI_CFG_x_MIPI_EN_BITS;\n\tvfe_reg_set(vfe, VFE_0_RDI_CFG_x(0), reg);\n\n\treg = VFE_0_RDI_CFG_x_RDI_EN_BIT;\n\treg |= ((3 * id) << VFE_0_RDI_CFG_x_RDI_STREAM_SEL_SHIFT) &\n\t\tVFE_0_RDI_CFG_x_RDI_STREAM_SEL_MASK;\n\tvfe_reg_set(vfe, VFE_0_RDI_CFG_x(id), reg);\n\n\tswitch (id) {\n\tcase VFE_LINE_RDI0:\n\tdefault:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI0 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\tcase VFE_LINE_RDI1:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI1 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\tcase VFE_LINE_RDI2:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI2 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\t}\n\n\tif (wm % 2 == 1)\n\t\treg <<= 16;\n\n\tvfe_reg_set(vfe, VFE_0_BUS_XBAR_CFG_x(wm), reg);\n}\n\nstatic void vfe_wm_set_subsample(struct vfe_device *vfe, u8 wm)\n{\n\twritel_relaxed(VFE_0_BUS_IMAGE_MASTER_n_WR_IRQ_SUBSAMPLE_PATTERN_DEF,\n\t       vfe->base +\n\t       VFE_0_BUS_IMAGE_MASTER_n_WR_IRQ_SUBSAMPLE_PATTERN(wm));\n}\n\nstatic void vfe_bus_disconnect_wm_from_rdi(struct vfe_device *vfe, u8 wm,\n\t\t\t\t\t   enum vfe_line_id id)\n{\n\tu32 reg;\n\n\treg = VFE_0_RDI_CFG_x_RDI_EN_BIT;\n\tvfe_reg_clr(vfe, VFE_0_RDI_CFG_x(id), reg);\n\n\tswitch (id) {\n\tcase VFE_LINE_RDI0:\n\tdefault:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI0 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\tcase VFE_LINE_RDI1:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI1 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\tcase VFE_LINE_RDI2:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_VAL_RDI2 <<\n\t\t      VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\t\tbreak;\n\t}\n\n\tif (wm % 2 == 1)\n\t\treg <<= 16;\n\n\tvfe_reg_clr(vfe, VFE_0_BUS_XBAR_CFG_x(wm), reg);\n}\n\nstatic void vfe_set_xbar_cfg(struct vfe_device *vfe, struct vfe_output *output,\n\t\t\t     u8 enable)\n{\n\tstruct vfe_line *line = container_of(output, struct vfe_line, output);\n\tu32 p = line->video_out.active_fmt.fmt.pix_mp.pixelformat;\n\tu32 reg;\n\n\tswitch (p) {\n\tcase V4L2_PIX_FMT_NV12:\n\tcase V4L2_PIX_FMT_NV21:\n\tcase V4L2_PIX_FMT_NV16:\n\tcase V4L2_PIX_FMT_NV61:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_LUMA <<\n\t\t\tVFE_0_BUS_XBAR_CFG_x_M_SINGLE_STREAM_SEL_SHIFT;\n\n\t\tif (output->wm_idx[0] % 2 == 1)\n\t\t\treg <<= 16;\n\n\t\tif (enable)\n\t\t\tvfe_reg_set(vfe,\n\t\t\t\t    VFE_0_BUS_XBAR_CFG_x(output->wm_idx[0]),\n\t\t\t\t    reg);\n\t\telse\n\t\t\tvfe_reg_clr(vfe,\n\t\t\t\t    VFE_0_BUS_XBAR_CFG_x(output->wm_idx[0]),\n\t\t\t\t    reg);\n\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_EN;\n\t\tif (p == V4L2_PIX_FMT_NV12 || p == V4L2_PIX_FMT_NV16)\n\t\t\treg |= VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_SWAP_INTER_INTRA;\n\n\t\tif (output->wm_idx[1] % 2 == 1)\n\t\t\treg <<= 16;\n\n\t\tif (enable)\n\t\t\tvfe_reg_set(vfe,\n\t\t\t\t    VFE_0_BUS_XBAR_CFG_x(output->wm_idx[1]),\n\t\t\t\t    reg);\n\t\telse\n\t\t\tvfe_reg_clr(vfe,\n\t\t\t\t    VFE_0_BUS_XBAR_CFG_x(output->wm_idx[1]),\n\t\t\t\t    reg);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_YUYV:\n\tcase V4L2_PIX_FMT_YVYU:\n\tcase V4L2_PIX_FMT_VYUY:\n\tcase V4L2_PIX_FMT_UYVY:\n\t\treg = VFE_0_BUS_XBAR_CFG_x_M_REALIGN_BUF_EN;\n\t\treg |= VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_EN;\n\n\t\tif (p == V4L2_PIX_FMT_YUYV || p == V4L2_PIX_FMT_YVYU)\n\t\t\treg |= VFE_0_BUS_XBAR_CFG_x_M_PAIR_STREAM_SWAP_INTER_INTRA;\n\n\t\tif (output->wm_idx[0] % 2 == 1)\n\t\t\treg <<= 16;\n\n\t\tif (enable)\n\t\t\tvfe_reg_set(vfe,\n\t\t\t\t    VFE_0_BUS_XBAR_CFG_x(output->wm_idx[0]),\n\t\t\t\t    reg);\n\t\telse\n\t\t\tvfe_reg_clr(vfe,\n\t\t\t\t    VFE_0_BUS_XBAR_CFG_x(output->wm_idx[0]),\n\t\t\t\t    reg);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void vfe_set_realign_cfg(struct vfe_device *vfe, struct vfe_line *line,\n\t\t\t\tu8 enable)\n{\n\tu32 p = line->video_out.active_fmt.fmt.pix_mp.pixelformat;\n\tu32 val = VFE_0_MODULE_ZOOM_EN_REALIGN_BUF;\n\n\tif (p != V4L2_PIX_FMT_YUYV && p != V4L2_PIX_FMT_YVYU &&\n\t\t\tp != V4L2_PIX_FMT_VYUY && p != V4L2_PIX_FMT_UYVY)\n\t\treturn;\n\n\tif (enable) {\n\t\tvfe_reg_set(vfe, VFE_0_MODULE_ZOOM_EN, val);\n\t} else {\n\t\tvfe_reg_clr(vfe, VFE_0_MODULE_ZOOM_EN, val);\n\t\treturn;\n\t}\n\n\tval = VFE_0_REALIGN_BUF_CFG_HSUB_ENABLE;\n\n\tif (p == V4L2_PIX_FMT_UYVY || p == V4L2_PIX_FMT_YUYV)\n\t\tval |= VFE_0_REALIGN_BUF_CFG_CR_ODD_PIXEL;\n\telse\n\t\tval |= VFE_0_REALIGN_BUF_CFG_CB_ODD_PIXEL;\n\n\twritel_relaxed(val, vfe->base + VFE_0_REALIGN_BUF_CFG);\n}\n\nstatic void vfe_set_rdi_cid(struct vfe_device *vfe, enum vfe_line_id id, u8 cid)\n{\n\tvfe_reg_clr(vfe, VFE_0_RDI_CFG_x(id),\n\t\t    VFE_0_RDI_CFG_x_RDI_M0_SEL_MASK);\n\n\tvfe_reg_set(vfe, VFE_0_RDI_CFG_x(id),\n\t\t    cid << VFE_0_RDI_CFG_x_RDI_M0_SEL_SHIFT);\n}\n\nstatic void vfe_reg_update(struct vfe_device *vfe, enum vfe_line_id line_id)\n{\n\tvfe->reg_update |= VFE_0_REG_UPDATE_line_n(line_id);\n\n\t \n\twmb();\n\twritel_relaxed(vfe->reg_update, vfe->base + VFE_0_REG_UPDATE);\n\n\t \n\twmb();\n}\n\nstatic inline void vfe_reg_update_clear(struct vfe_device *vfe,\n\t\t\t\t\tenum vfe_line_id line_id)\n{\n\tvfe->reg_update &= ~VFE_0_REG_UPDATE_line_n(line_id);\n}\n\nstatic void vfe_enable_irq_wm_line(struct vfe_device *vfe, u8 wm,\n\t\t\t\t   enum vfe_line_id line_id, u8 enable)\n{\n\tu32 irq_en0 = VFE_0_IRQ_MASK_0_IMAGE_MASTER_n_PING_PONG(wm) |\n\t\t      VFE_0_IRQ_MASK_0_line_n_REG_UPDATE(line_id);\n\tu32 irq_en1 = VFE_0_IRQ_MASK_1_IMAGE_MASTER_n_BUS_OVERFLOW(wm) |\n\t\t      VFE_0_IRQ_MASK_1_RDIn_SOF(line_id);\n\n\tif (enable) {\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n\t} else {\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n\t}\n}\n\nstatic void vfe_enable_irq_pix_line(struct vfe_device *vfe, u8 comp,\n\t\t\t\t    enum vfe_line_id line_id, u8 enable)\n{\n\tstruct vfe_output *output = &vfe->line[line_id].output;\n\tunsigned int i;\n\tu32 irq_en0;\n\tu32 irq_en1;\n\tu32 comp_mask = 0;\n\n\tirq_en0 = VFE_0_IRQ_MASK_0_CAMIF_SOF;\n\tirq_en0 |= VFE_0_IRQ_MASK_0_CAMIF_EOF;\n\tirq_en0 |= VFE_0_IRQ_MASK_0_IMAGE_COMPOSITE_DONE_n(comp);\n\tirq_en0 |= VFE_0_IRQ_MASK_0_line_n_REG_UPDATE(line_id);\n\tirq_en1 = VFE_0_IRQ_MASK_1_CAMIF_ERROR;\n\tfor (i = 0; i < output->wm_num; i++) {\n\t\tirq_en1 |= VFE_0_IRQ_MASK_1_IMAGE_MASTER_n_BUS_OVERFLOW(\n\t\t\t\t\t\t\toutput->wm_idx[i]);\n\t\tcomp_mask |= (1 << output->wm_idx[i]) << comp * 8;\n\t}\n\n\tif (enable) {\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n\t\tvfe_reg_set(vfe, VFE_0_IRQ_COMPOSITE_MASK_0, comp_mask);\n\t} else {\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n\t\tvfe_reg_clr(vfe, VFE_0_IRQ_COMPOSITE_MASK_0, comp_mask);\n\t}\n}\n\nstatic void vfe_enable_irq_common(struct vfe_device *vfe)\n{\n\tu32 irq_en0 = VFE_0_IRQ_MASK_0_RESET_ACK;\n\tu32 irq_en1 = VFE_0_IRQ_MASK_1_VIOLATION |\n\t\t      VFE_0_IRQ_MASK_1_BUS_BDG_HALT_ACK;\n\n\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_0, irq_en0);\n\tvfe_reg_set(vfe, VFE_0_IRQ_MASK_1, irq_en1);\n}\n\nstatic void vfe_set_demux_cfg(struct vfe_device *vfe, struct vfe_line *line)\n{\n\tu32 val, even_cfg, odd_cfg;\n\n\twritel_relaxed(VFE_0_DEMUX_CFG_PERIOD, vfe->base + VFE_0_DEMUX_CFG);\n\n\tval = VFE_0_DEMUX_GAIN_0_CH0_EVEN | VFE_0_DEMUX_GAIN_0_CH0_ODD;\n\twritel_relaxed(val, vfe->base + VFE_0_DEMUX_GAIN_0);\n\n\tval = VFE_0_DEMUX_GAIN_1_CH1 | VFE_0_DEMUX_GAIN_1_CH2;\n\twritel_relaxed(val, vfe->base + VFE_0_DEMUX_GAIN_1);\n\n\tswitch (line->fmt[MSM_VFE_PAD_SINK].code) {\n\tcase MEDIA_BUS_FMT_YUYV8_2X8:\n\t\teven_cfg = VFE_0_DEMUX_EVEN_CFG_PATTERN_YUYV;\n\t\todd_cfg = VFE_0_DEMUX_ODD_CFG_PATTERN_YUYV;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_YVYU8_2X8:\n\t\teven_cfg = VFE_0_DEMUX_EVEN_CFG_PATTERN_YVYU;\n\t\todd_cfg = VFE_0_DEMUX_ODD_CFG_PATTERN_YVYU;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_UYVY8_2X8:\n\tdefault:\n\t\teven_cfg = VFE_0_DEMUX_EVEN_CFG_PATTERN_UYVY;\n\t\todd_cfg = VFE_0_DEMUX_ODD_CFG_PATTERN_UYVY;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_VYUY8_2X8:\n\t\teven_cfg = VFE_0_DEMUX_EVEN_CFG_PATTERN_VYUY;\n\t\todd_cfg = VFE_0_DEMUX_ODD_CFG_PATTERN_VYUY;\n\t\tbreak;\n\t}\n\n\twritel_relaxed(even_cfg, vfe->base + VFE_0_DEMUX_EVEN_CFG);\n\twritel_relaxed(odd_cfg, vfe->base + VFE_0_DEMUX_ODD_CFG);\n}\n\nstatic void vfe_set_scale_cfg(struct vfe_device *vfe, struct vfe_line *line)\n{\n\tu32 p = line->video_out.active_fmt.fmt.pix_mp.pixelformat;\n\tu32 reg;\n\tu16 input, output;\n\tu8 interp_reso;\n\tu32 phase_mult;\n\n\twritel_relaxed(0x3, vfe->base + VFE_0_SCALE_ENC_Y_CFG);\n\n\tinput = line->fmt[MSM_VFE_PAD_SINK].width - 1;\n\toutput = line->compose.width - 1;\n\treg = (output << 16) | input;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_Y_H_IMAGE_SIZE);\n\n\tinterp_reso = vfe_calc_interp_reso(input, output);\n\tphase_mult = input * (1 << (14 + interp_reso)) / output;\n\treg = (interp_reso << 28) | phase_mult;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_Y_H_PHASE);\n\n\tinput = line->fmt[MSM_VFE_PAD_SINK].height - 1;\n\toutput = line->compose.height - 1;\n\treg = (output << 16) | input;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_Y_V_IMAGE_SIZE);\n\n\tinterp_reso = vfe_calc_interp_reso(input, output);\n\tphase_mult = input * (1 << (14 + interp_reso)) / output;\n\treg = (interp_reso << 28) | phase_mult;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_Y_V_PHASE);\n\n\twritel_relaxed(0x3, vfe->base + VFE_0_SCALE_ENC_CBCR_CFG);\n\n\tinput = line->fmt[MSM_VFE_PAD_SINK].width - 1;\n\toutput = line->compose.width / 2 - 1;\n\treg = (output << 16) | input;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_CBCR_H_IMAGE_SIZE);\n\n\tinterp_reso = vfe_calc_interp_reso(input, output);\n\tphase_mult = input * (1 << (14 + interp_reso)) / output;\n\treg = (interp_reso << 28) | phase_mult;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_CBCR_H_PHASE);\n\n\tinput = line->fmt[MSM_VFE_PAD_SINK].height - 1;\n\toutput = line->compose.height - 1;\n\tif (p == V4L2_PIX_FMT_NV12 || p == V4L2_PIX_FMT_NV21)\n\t\toutput = line->compose.height / 2 - 1;\n\treg = (output << 16) | input;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_CBCR_V_IMAGE_SIZE);\n\n\tinterp_reso = vfe_calc_interp_reso(input, output);\n\tphase_mult = input * (1 << (14 + interp_reso)) / output;\n\treg = (interp_reso << 28) | phase_mult;\n\twritel_relaxed(reg, vfe->base + VFE_0_SCALE_ENC_CBCR_V_PHASE);\n}\n\nstatic void vfe_set_crop_cfg(struct vfe_device *vfe, struct vfe_line *line)\n{\n\tu32 p = line->video_out.active_fmt.fmt.pix_mp.pixelformat;\n\tu32 reg;\n\tu16 first, last;\n\n\tfirst = line->crop.left;\n\tlast = line->crop.left + line->crop.width - 1;\n\treg = (first << 16) | last;\n\twritel_relaxed(reg, vfe->base + VFE_0_CROP_ENC_Y_WIDTH);\n\n\tfirst = line->crop.top;\n\tlast = line->crop.top + line->crop.height - 1;\n\treg = (first << 16) | last;\n\twritel_relaxed(reg, vfe->base + VFE_0_CROP_ENC_Y_HEIGHT);\n\n\tfirst = line->crop.left / 2;\n\tlast = line->crop.left / 2 + line->crop.width / 2 - 1;\n\treg = (first << 16) | last;\n\twritel_relaxed(reg, vfe->base + VFE_0_CROP_ENC_CBCR_WIDTH);\n\n\tfirst = line->crop.top;\n\tlast = line->crop.top + line->crop.height - 1;\n\tif (p == V4L2_PIX_FMT_NV12 || p == V4L2_PIX_FMT_NV21) {\n\t\tfirst = line->crop.top / 2;\n\t\tlast = line->crop.top / 2 + line->crop.height / 2 - 1;\n\t}\n\treg = (first << 16) | last;\n\twritel_relaxed(reg, vfe->base + VFE_0_CROP_ENC_CBCR_HEIGHT);\n}\n\nstatic void vfe_set_clamp_cfg(struct vfe_device *vfe)\n{\n\tu32 val = VFE_0_CLAMP_ENC_MAX_CFG_CH0 |\n\t\tVFE_0_CLAMP_ENC_MAX_CFG_CH1 |\n\t\tVFE_0_CLAMP_ENC_MAX_CFG_CH2;\n\n\twritel_relaxed(val, vfe->base + VFE_0_CLAMP_ENC_MAX_CFG);\n\n\tval = VFE_0_CLAMP_ENC_MIN_CFG_CH0 |\n\t\tVFE_0_CLAMP_ENC_MIN_CFG_CH1 |\n\t\tVFE_0_CLAMP_ENC_MIN_CFG_CH2;\n\n\twritel_relaxed(val, vfe->base + VFE_0_CLAMP_ENC_MIN_CFG);\n}\n\nstatic void vfe_set_qos(struct vfe_device *vfe)\n{\n\tu32 val = VFE_0_BUS_BDG_QOS_CFG_0_CFG;\n\tu32 val7 = VFE_0_BUS_BDG_QOS_CFG_7_CFG;\n\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_0);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_1);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_2);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_3);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_4);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_5);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_QOS_CFG_6);\n\twritel_relaxed(val7, vfe->base + VFE_0_BUS_BDG_QOS_CFG_7);\n}\n\nstatic void vfe_set_ds(struct vfe_device *vfe)\n{\n\tu32 val = VFE_0_BUS_BDG_DS_CFG_0_CFG;\n\tu32 val16 = VFE_0_BUS_BDG_DS_CFG_16_CFG;\n\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_0);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_1);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_2);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_3);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_4);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_5);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_6);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_7);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_8);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_9);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_10);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_11);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_12);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_13);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_14);\n\twritel_relaxed(val, vfe->base + VFE_0_BUS_BDG_DS_CFG_15);\n\twritel_relaxed(val16, vfe->base + VFE_0_BUS_BDG_DS_CFG_16);\n}\n\nstatic void vfe_set_cgc_override(struct vfe_device *vfe, u8 wm, u8 enable)\n{\n\t \n}\n\nstatic void vfe_set_camif_cfg(struct vfe_device *vfe, struct vfe_line *line)\n{\n\tu32 val;\n\n\tswitch (line->fmt[MSM_VFE_PAD_SINK].code) {\n\tcase MEDIA_BUS_FMT_YUYV8_2X8:\n\t\tval = VFE_0_CORE_CFG_PIXEL_PATTERN_YCBYCR;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_YVYU8_2X8:\n\t\tval = VFE_0_CORE_CFG_PIXEL_PATTERN_YCRYCB;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_UYVY8_2X8:\n\tdefault:\n\t\tval = VFE_0_CORE_CFG_PIXEL_PATTERN_CBYCRY;\n\t\tbreak;\n\tcase MEDIA_BUS_FMT_VYUY8_2X8:\n\t\tval = VFE_0_CORE_CFG_PIXEL_PATTERN_CRYCBY;\n\t\tbreak;\n\t}\n\n\tval |= VFE_0_CORE_CFG_COMPOSITE_REG_UPDATE_EN;\n\twritel_relaxed(val, vfe->base + VFE_0_CORE_CFG);\n\n\tval = line->fmt[MSM_VFE_PAD_SINK].width * 2 - 1;\n\tval |= (line->fmt[MSM_VFE_PAD_SINK].height - 1) << 16;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_FRAME_CFG);\n\n\tval = line->fmt[MSM_VFE_PAD_SINK].width * 2 - 1;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_WINDOW_WIDTH_CFG);\n\n\tval = line->fmt[MSM_VFE_PAD_SINK].height - 1;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_WINDOW_HEIGHT_CFG);\n\n\tval = 0xffffffff;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_SUBSAMPLE_CFG);\n\n\tval = 0xffffffff;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_IRQ_FRAMEDROP_PATTERN);\n\n\tval = 0xffffffff;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_IRQ_SUBSAMPLE_PATTERN);\n\n\tval = VFE_0_RDI_CFG_x_MIPI_EN_BITS;\n\tvfe_reg_set(vfe, VFE_0_RDI_CFG_x(0), val);\n\n\tval = VFE_0_CAMIF_CFG_VFE_OUTPUT_EN;\n\twritel_relaxed(val, vfe->base + VFE_0_CAMIF_CFG);\n}\n\nstatic void vfe_set_camif_cmd(struct vfe_device *vfe, u8 enable)\n{\n\tu32 cmd;\n\n\tcmd = VFE_0_CAMIF_CMD_CLEAR_CAMIF_STATUS | VFE_0_CAMIF_CMD_NO_CHANGE;\n\twritel_relaxed(cmd, vfe->base + VFE_0_CAMIF_CMD);\n\n\t \n\twmb();\n\n\tif (enable)\n\t\tcmd = VFE_0_CAMIF_CMD_ENABLE_FRAME_BOUNDARY;\n\telse\n\t\tcmd = VFE_0_CAMIF_CMD_DISABLE_FRAME_BOUNDARY;\n\n\twritel_relaxed(cmd, vfe->base + VFE_0_CAMIF_CMD);\n}\n\nstatic void vfe_set_module_cfg(struct vfe_device *vfe, u8 enable)\n{\n\tu32 val_lens = VFE_0_MODULE_LENS_EN_DEMUX |\n\t\t       VFE_0_MODULE_LENS_EN_CHROMA_UPSAMPLE;\n\tu32 val_zoom = VFE_0_MODULE_ZOOM_EN_SCALE_ENC |\n\t\t       VFE_0_MODULE_ZOOM_EN_CROP_ENC;\n\n\tif (enable) {\n\t\tvfe_reg_set(vfe, VFE_0_MODULE_LENS_EN, val_lens);\n\t\tvfe_reg_set(vfe, VFE_0_MODULE_ZOOM_EN, val_zoom);\n\t} else {\n\t\tvfe_reg_clr(vfe, VFE_0_MODULE_LENS_EN, val_lens);\n\t\tvfe_reg_clr(vfe, VFE_0_MODULE_ZOOM_EN, val_zoom);\n\t}\n}\n\nstatic int vfe_camif_wait_for_stop(struct vfe_device *vfe, struct device *dev)\n{\n\tu32 val;\n\tint ret;\n\n\tret = readl_poll_timeout(vfe->base + VFE_0_CAMIF_STATUS,\n\t\t\t\t val,\n\t\t\t\t (val & VFE_0_CAMIF_STATUS_HALT),\n\t\t\t\t CAMIF_TIMEOUT_SLEEP_US,\n\t\t\t\t CAMIF_TIMEOUT_ALL_US);\n\tif (ret < 0)\n\t\tdev_err(dev, \"%s: camif stop timeout\\n\", __func__);\n\n\treturn ret;\n}\n\n\n\n \nstatic irqreturn_t vfe_isr(int irq, void *dev)\n{\n\tstruct vfe_device *vfe = dev;\n\tu32 value0, value1;\n\tint i, j;\n\n\tvfe->ops->isr_read(vfe, &value0, &value1);\n\n\tdev_dbg(vfe->camss->dev, \"VFE: status0 = 0x%08x, status1 = 0x%08x\\n\",\n\t\tvalue0, value1);\n\n\tif (value0 & VFE_0_IRQ_STATUS_0_RESET_ACK)\n\t\tvfe->isr_ops.reset_ack(vfe);\n\n\tif (value1 & VFE_0_IRQ_STATUS_1_VIOLATION)\n\t\tvfe->ops->violation_read(vfe);\n\n\tif (value1 & VFE_0_IRQ_STATUS_1_BUS_BDG_HALT_ACK)\n\t\tvfe->isr_ops.halt_ack(vfe);\n\n\tfor (i = VFE_LINE_RDI0; i < vfe->line_num; i++)\n\t\tif (value0 & VFE_0_IRQ_STATUS_0_line_n_REG_UPDATE(i))\n\t\t\tvfe->isr_ops.reg_update(vfe, i);\n\n\tif (value0 & VFE_0_IRQ_STATUS_0_CAMIF_SOF)\n\t\tvfe->isr_ops.sof(vfe, VFE_LINE_PIX);\n\n\tfor (i = VFE_LINE_RDI0; i <= VFE_LINE_RDI2; i++)\n\t\tif (value1 & VFE_0_IRQ_STATUS_1_RDIn_SOF(i))\n\t\t\tvfe->isr_ops.sof(vfe, i);\n\n\tfor (i = 0; i < MSM_VFE_COMPOSITE_IRQ_NUM; i++)\n\t\tif (value0 & VFE_0_IRQ_STATUS_0_IMAGE_COMPOSITE_DONE_n(i)) {\n\t\t\tvfe->isr_ops.comp_done(vfe, i);\n\t\t\tfor (j = 0; j < ARRAY_SIZE(vfe->wm_output_map); j++)\n\t\t\t\tif (vfe->wm_output_map[j] == VFE_LINE_PIX)\n\t\t\t\t\tvalue0 &= ~VFE_0_IRQ_MASK_0_IMAGE_MASTER_n_PING_PONG(j);\n\t\t}\n\n\tfor (i = 0; i < MSM_VFE_IMAGE_MASTERS_NUM; i++)\n\t\tif (value0 & VFE_0_IRQ_STATUS_0_IMAGE_MASTER_n_PING_PONG(i))\n\t\t\tvfe->isr_ops.wm_done(vfe, i);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void vfe_isr_read(struct vfe_device *vfe, u32 *value0, u32 *value1)\n{\n\t*value0 = readl_relaxed(vfe->base + VFE_0_IRQ_STATUS_0);\n\t*value1 = readl_relaxed(vfe->base + VFE_0_IRQ_STATUS_1);\n\n\twritel_relaxed(*value0, vfe->base + VFE_0_IRQ_CLEAR_0);\n\twritel_relaxed(*value1, vfe->base + VFE_0_IRQ_CLEAR_1);\n\n\t \n\twmb();\n\twritel_relaxed(VFE_0_IRQ_CMD_GLOBAL_CLEAR, vfe->base + VFE_0_IRQ_CMD);\n}\n\n \nstatic void vfe_pm_domain_off(struct vfe_device *vfe)\n{\n\tstruct camss *camss;\n\n\tif (!vfe)\n\t\treturn;\n\n\tcamss = vfe->camss;\n\n\tdevice_link_del(camss->genpd_link[vfe->id]);\n}\n\n \nstatic int vfe_pm_domain_on(struct vfe_device *vfe)\n{\n\tstruct camss *camss = vfe->camss;\n\tenum vfe_line_id id = vfe->id;\n\n\tcamss->genpd_link[id] = device_link_add(camss->dev, camss->genpd[id], DL_FLAG_STATELESS |\n\t\t\t\t\t\tDL_FLAG_PM_RUNTIME | DL_FLAG_RPM_ACTIVE);\n\n\tif (!camss->genpd_link[id]) {\n\t\tdev_err(vfe->camss->dev, \"Failed to add VFE#%d to power domain\\n\", id);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void vfe_violation_read(struct vfe_device *vfe)\n{\n\tu32 violation = readl_relaxed(vfe->base + VFE_0_VIOLATION_STATUS);\n\n\tpr_err_ratelimited(\"VFE: violation = 0x%08x\\n\", violation);\n}\n\nstatic const struct vfe_hw_ops_gen1 vfe_ops_gen1_4_7 = {\n\t.bus_connect_wm_to_rdi = vfe_bus_connect_wm_to_rdi,\n\t.bus_disconnect_wm_from_rdi = vfe_bus_disconnect_wm_from_rdi,\n\t.bus_enable_wr_if = vfe_bus_enable_wr_if,\n\t.bus_reload_wm = vfe_bus_reload_wm,\n\t.camif_wait_for_stop = vfe_camif_wait_for_stop,\n\t.enable_irq_common = vfe_enable_irq_common,\n\t.enable_irq_pix_line = vfe_enable_irq_pix_line,\n\t.enable_irq_wm_line = vfe_enable_irq_wm_line,\n\t.get_ub_size = vfe_get_ub_size,\n\t.halt_clear = vfe_halt_clear,\n\t.halt_request = vfe_halt_request,\n\t.set_camif_cfg = vfe_set_camif_cfg,\n\t.set_camif_cmd = vfe_set_camif_cmd,\n\t.set_cgc_override = vfe_set_cgc_override,\n\t.set_clamp_cfg = vfe_set_clamp_cfg,\n\t.set_crop_cfg = vfe_set_crop_cfg,\n\t.set_demux_cfg = vfe_set_demux_cfg,\n\t.set_ds = vfe_set_ds,\n\t.set_module_cfg = vfe_set_module_cfg,\n\t.set_qos = vfe_set_qos,\n\t.set_rdi_cid = vfe_set_rdi_cid,\n\t.set_realign_cfg = vfe_set_realign_cfg,\n\t.set_scale_cfg = vfe_set_scale_cfg,\n\t.set_xbar_cfg = vfe_set_xbar_cfg,\n\t.wm_enable = vfe_wm_enable,\n\t.wm_frame_based = vfe_wm_frame_based,\n\t.wm_get_ping_pong_status = vfe_wm_get_ping_pong_status,\n\t.wm_line_based = vfe_wm_line_based,\n\t.wm_set_framedrop_pattern = vfe_wm_set_framedrop_pattern,\n\t.wm_set_framedrop_period = vfe_wm_set_framedrop_period,\n\t.wm_set_ping_addr = vfe_wm_set_ping_addr,\n\t.wm_set_pong_addr = vfe_wm_set_pong_addr,\n\t.wm_set_subsample = vfe_wm_set_subsample,\n\t.wm_set_ub_cfg = vfe_wm_set_ub_cfg,\n};\n\nstatic void vfe_subdev_init(struct device *dev, struct vfe_device *vfe)\n{\n\tvfe->isr_ops = vfe_isr_ops_gen1;\n\tvfe->ops_gen1 = &vfe_ops_gen1_4_7;\n\tvfe->video_ops = vfe_video_ops_gen1;\n\n\tvfe->line_num = VFE_LINE_NUM_GEN1;\n}\n\nconst struct vfe_hw_ops vfe_ops_4_7 = {\n\t.global_reset = vfe_global_reset,\n\t.hw_version = vfe_hw_version,\n\t.isr_read = vfe_isr_read,\n\t.isr = vfe_isr,\n\t.pm_domain_off = vfe_pm_domain_off,\n\t.pm_domain_on = vfe_pm_domain_on,\n\t.reg_update_clear = vfe_reg_update_clear,\n\t.reg_update = vfe_reg_update,\n\t.subdev_init = vfe_subdev_init,\n\t.vfe_disable = vfe_gen1_disable,\n\t.vfe_enable = vfe_gen1_enable,\n\t.vfe_halt = vfe_gen1_halt,\n\t.violation_read = vfe_violation_read,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}