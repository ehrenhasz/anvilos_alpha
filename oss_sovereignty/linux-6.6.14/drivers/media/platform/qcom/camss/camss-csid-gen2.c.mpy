{
  "module_name": "camss-csid-gen2.c",
  "hash_id": "f47e5a4c304739ac90656d1652a7b343215a5abf70d10e4d53db4e443d40becc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/qcom/camss/camss-csid-gen2.c",
  "human_readable_source": "\n \n#include <linux/completion.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n\n#include \"camss-csid.h\"\n#include \"camss-csid-gen2.h\"\n#include \"camss.h\"\n\n \n#define IS_LITE\t\t(csid->id >= 2 ? 1 : 0)\n\n#define CSID_HW_VERSION\t\t0x0\n#define\t\tHW_VERSION_STEPPING\t0\n#define\t\tHW_VERSION_REVISION\t16\n#define\t\tHW_VERSION_GENERATION\t28\n\n#define CSID_RST_STROBES\t0x10\n#define\t\tRST_STROBES\t0\n\n#define CSID_CSI2_RX_IRQ_STATUS\t0x20\n#define\tCSID_CSI2_RX_IRQ_MASK\t0x24\n#define CSID_CSI2_RX_IRQ_CLEAR\t0x28\n\n#define CSID_CSI2_RDIN_IRQ_STATUS(rdi)\t\t((IS_LITE ? 0x30 : 0x40) \\\n\t\t\t\t\t\t + 0x10 * (rdi))\n#define CSID_CSI2_RDIN_IRQ_MASK(rdi)\t\t((IS_LITE ? 0x34 : 0x44) \\\n\t\t\t\t\t\t + 0x10 * (rdi))\n#define CSID_CSI2_RDIN_IRQ_CLEAR(rdi)\t\t((IS_LITE ? 0x38 : 0x48) \\\n\t\t\t\t\t\t + 0x10 * (rdi))\n#define CSID_CSI2_RDIN_IRQ_SET(rdi)\t\t((IS_LITE ? 0x3C : 0x4C) \\\n\t\t\t\t\t\t + 0x10 * (rdi))\n\n#define CSID_TOP_IRQ_STATUS\t0x70\n#define\t\tTOP_IRQ_STATUS_RESET_DONE 0\n#define CSID_TOP_IRQ_MASK\t0x74\n#define CSID_TOP_IRQ_CLEAR\t0x78\n#define CSID_TOP_IRQ_SET\t0x7C\n#define CSID_IRQ_CMD\t\t0x80\n#define\t\tIRQ_CMD_CLEAR\t0\n#define\t\tIRQ_CMD_SET\t4\n\n#define CSID_CSI2_RX_CFG0\t0x100\n#define\t\tCSI2_RX_CFG0_NUM_ACTIVE_LANES\t0\n#define\t\tCSI2_RX_CFG0_DL0_INPUT_SEL\t4\n#define\t\tCSI2_RX_CFG0_DL1_INPUT_SEL\t8\n#define\t\tCSI2_RX_CFG0_DL2_INPUT_SEL\t12\n#define\t\tCSI2_RX_CFG0_DL3_INPUT_SEL\t16\n#define\t\tCSI2_RX_CFG0_PHY_NUM_SEL\t20\n#define\t\tCSI2_RX_CFG0_PHY_TYPE_SEL\t24\n\n#define CSID_CSI2_RX_CFG1\t0x104\n#define\t\tCSI2_RX_CFG1_PACKET_ECC_CORRECTION_EN\t\t0\n#define\t\tCSI2_RX_CFG1_DE_SCRAMBLE_EN\t\t\t1\n#define\t\tCSI2_RX_CFG1_VC_MODE\t\t\t\t2\n#define\t\tCSI2_RX_CFG1_COMPLETE_STREAM_EN\t\t\t4\n#define\t\tCSI2_RX_CFG1_COMPLETE_STREAM_FRAME_TIMING\t5\n#define\t\tCSI2_RX_CFG1_MISR_EN\t\t\t\t6\n#define\t\tCSI2_RX_CFG1_CGC_MODE\t\t\t\t7\n#define\t\t\tCGC_MODE_DYNAMIC_GATING\t\t0\n#define\t\t\tCGC_MODE_ALWAYS_ON\t\t1\n\n#define CSID_RDI_CFG0(rdi)\t\t\t((IS_LITE ? 0x200 : 0x300) \\\n\t\t\t\t\t\t + 0x100 * (rdi))\n#define\t\tRDI_CFG0_BYTE_CNTR_EN\t\t0\n#define\t\tRDI_CFG0_FORMAT_MEASURE_EN\t1\n#define\t\tRDI_CFG0_TIMESTAMP_EN\t\t2\n#define\t\tRDI_CFG0_DROP_H_EN\t\t3\n#define\t\tRDI_CFG0_DROP_V_EN\t\t4\n#define\t\tRDI_CFG0_CROP_H_EN\t\t5\n#define\t\tRDI_CFG0_CROP_V_EN\t\t6\n#define\t\tRDI_CFG0_MISR_EN\t\t7\n#define\t\tRDI_CFG0_CGC_MODE\t\t8\n#define\t\t\tCGC_MODE_DYNAMIC\t0\n#define\t\t\tCGC_MODE_ALWAYS_ON\t1\n#define\t\tRDI_CFG0_PLAIN_ALIGNMENT\t9\n#define\t\t\tPLAIN_ALIGNMENT_LSB\t0\n#define\t\t\tPLAIN_ALIGNMENT_MSB\t1\n#define\t\tRDI_CFG0_PLAIN_FORMAT\t\t10\n#define\t\tRDI_CFG0_DECODE_FORMAT\t\t12\n#define\t\tRDI_CFG0_DATA_TYPE\t\t16\n#define\t\tRDI_CFG0_VIRTUAL_CHANNEL\t22\n#define\t\tRDI_CFG0_DT_ID\t\t\t27\n#define\t\tRDI_CFG0_EARLY_EOF_EN\t\t29\n#define\t\tRDI_CFG0_PACKING_FORMAT\t\t30\n#define\t\tRDI_CFG0_ENABLE\t\t\t31\n\n#define CSID_RDI_CFG1(rdi)\t\t\t((IS_LITE ? 0x204 : 0x304)\\\n\t\t\t\t\t\t+ 0x100 * (rdi))\n#define\t\tRDI_CFG1_TIMESTAMP_STB_SEL\t0\n\n#define CSID_RDI_CTRL(rdi)\t\t\t((IS_LITE ? 0x208 : 0x308)\\\n\t\t\t\t\t\t+ 0x100 * (rdi))\n#define\t\tRDI_CTRL_HALT_CMD\t\t0\n#define\t\t\tHALT_CMD_HALT_AT_FRAME_BOUNDARY\t\t0\n#define\t\t\tHALT_CMD_RESUME_AT_FRAME_BOUNDARY\t1\n#define\t\tRDI_CTRL_HALT_MODE\t\t2\n\n#define CSID_RDI_FRM_DROP_PATTERN(rdi)\t\t\t((IS_LITE ? 0x20C : 0x30C)\\\n\t\t\t\t\t\t\t+ 0x100 * (rdi))\n#define CSID_RDI_FRM_DROP_PERIOD(rdi)\t\t\t((IS_LITE ? 0x210 : 0x310)\\\n\t\t\t\t\t\t\t+ 0x100 * (rdi))\n#define CSID_RDI_IRQ_SUBSAMPLE_PATTERN(rdi)\t\t((IS_LITE ? 0x214 : 0x314)\\\n\t\t\t\t\t\t\t+ 0x100 * (rdi))\n#define CSID_RDI_IRQ_SUBSAMPLE_PERIOD(rdi)\t\t((IS_LITE ? 0x218 : 0x318)\\\n\t\t\t\t\t\t\t+ 0x100 * (rdi))\n#define CSID_RDI_RPP_PIX_DROP_PATTERN(rdi)\t\t((IS_LITE ? 0x224 : 0x324)\\\n\t\t\t\t\t\t\t+ 0x100 * (rdi))\n#define CSID_RDI_RPP_PIX_DROP_PERIOD(rdi)\t\t((IS_LITE ? 0x228 : 0x328)\\\n\t\t\t\t\t\t\t+ 0x100 * (rdi))\n#define CSID_RDI_RPP_LINE_DROP_PATTERN(rdi)\t\t((IS_LITE ? 0x22C : 0x32C)\\\n\t\t\t\t\t\t\t+ 0x100 * (rdi))\n#define CSID_RDI_RPP_LINE_DROP_PERIOD(rdi)\t\t((IS_LITE ? 0x230 : 0x330)\\\n\t\t\t\t\t\t\t+ 0x100 * (rdi))\n\n#define CSID_TPG_CTRL\t\t0x600\n#define\t\tTPG_CTRL_TEST_EN\t\t0\n#define\t\tTPG_CTRL_FS_PKT_EN\t\t1\n#define\t\tTPG_CTRL_FE_PKT_EN\t\t2\n#define\t\tTPG_CTRL_NUM_ACTIVE_LANES\t4\n#define\t\tTPG_CTRL_CYCLES_BETWEEN_PKTS\t8\n#define\t\tTPG_CTRL_NUM_TRAIL_BYTES\t20\n\n#define CSID_TPG_VC_CFG0\t0x604\n#define\t\tTPG_VC_CFG0_VC_NUM\t\t\t0\n#define\t\tTPG_VC_CFG0_NUM_ACTIVE_SLOTS\t\t8\n#define\t\t\tNUM_ACTIVE_SLOTS_0_ENABLED\t0\n#define\t\t\tNUM_ACTIVE_SLOTS_0_1_ENABLED\t1\n#define\t\t\tNUM_ACTIVE_SLOTS_0_1_2_ENABLED\t2\n#define\t\t\tNUM_ACTIVE_SLOTS_0_1_3_ENABLED\t3\n#define\t\tTPG_VC_CFG0_LINE_INTERLEAVING_MODE\t10\n#define\t\t\tINTELEAVING_MODE_INTERLEAVED\t0\n#define\t\t\tINTELEAVING_MODE_ONE_SHOT\t1\n#define\t\tTPG_VC_CFG0_NUM_FRAMES\t\t\t16\n\n#define CSID_TPG_VC_CFG1\t0x608\n#define\t\tTPG_VC_CFG1_H_BLANKING_COUNT\t\t0\n#define\t\tTPG_VC_CFG1_V_BLANKING_COUNT\t\t12\n#define\t\tTPG_VC_CFG1_V_BLANK_FRAME_WIDTH_SEL\t24\n\n#define CSID_TPG_LFSR_SEED\t0x60C\n\n#define CSID_TPG_DT_n_CFG_0(n)\t(0x610 + (n) * 0xC)\n#define\t\tTPG_DT_n_CFG_0_FRAME_HEIGHT\t0\n#define\t\tTPG_DT_n_CFG_0_FRAME_WIDTH\t16\n\n#define CSID_TPG_DT_n_CFG_1(n)\t(0x614 + (n) * 0xC)\n#define\t\tTPG_DT_n_CFG_1_DATA_TYPE\t0\n#define\t\tTPG_DT_n_CFG_1_ECC_XOR_MASK\t8\n#define\t\tTPG_DT_n_CFG_1_CRC_XOR_MASK\t16\n\n#define CSID_TPG_DT_n_CFG_2(n)\t(0x618 + (n) * 0xC)\n#define\t\tTPG_DT_n_CFG_2_PAYLOAD_MODE\t\t0\n#define\t\tTPG_DT_n_CFG_2_USER_SPECIFIED_PAYLOAD\t4\n#define\t\tTPG_DT_n_CFG_2_ENCODE_FORMAT\t\t16\n\n#define CSID_TPG_COLOR_BARS_CFG\t0x640\n#define\t\tTPG_COLOR_BARS_CFG_UNICOLOR_BAR_EN\t0\n#define\t\tTPG_COLOR_BARS_CFG_UNICOLOR_BAR_SEL\t4\n#define\t\tTPG_COLOR_BARS_CFG_SPLIT_EN\t\t5\n#define\t\tTPG_COLOR_BARS_CFG_ROTATE_PERIOD\t8\n\n#define CSID_TPG_COLOR_BOX_CFG\t0x644\n#define\t\tTPG_COLOR_BOX_CFG_MODE\t\t0\n#define\t\tTPG_COLOR_BOX_PATTERN_SEL\t2\n\nstatic const struct csid_format csid_formats[] = {\n\t{\n\t\tMEDIA_BUS_FMT_UYVY8_2X8,\n\t\tDATA_TYPE_YUV422_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t2,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_VYUY8_2X8,\n\t\tDATA_TYPE_YUV422_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t2,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_YUYV8_2X8,\n\t\tDATA_TYPE_YUV422_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t2,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_YVYU8_2X8,\n\t\tDATA_TYPE_YUV422_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t2,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SBGGR8_1X8,\n\t\tDATA_TYPE_RAW_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGBRG8_1X8,\n\t\tDATA_TYPE_RAW_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGRBG8_1X8,\n\t\tDATA_TYPE_RAW_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SRGGB8_1X8,\n\t\tDATA_TYPE_RAW_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SBGGR10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGBRG10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGRBG10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SRGGB10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_Y8_1X8,\n\t\tDATA_TYPE_RAW_8BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_8_BIT,\n\t\t8,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_Y10_1X10,\n\t\tDATA_TYPE_RAW_10BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_10_BIT,\n\t\t10,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SBGGR12_1X12,\n\t\tDATA_TYPE_RAW_12BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_12_BIT,\n\t\t12,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGBRG12_1X12,\n\t\tDATA_TYPE_RAW_12BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_12_BIT,\n\t\t12,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGRBG12_1X12,\n\t\tDATA_TYPE_RAW_12BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_12_BIT,\n\t\t12,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SRGGB12_1X12,\n\t\tDATA_TYPE_RAW_12BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_12_BIT,\n\t\t12,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SBGGR14_1X14,\n\t\tDATA_TYPE_RAW_14BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_14_BIT,\n\t\t14,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGBRG14_1X14,\n\t\tDATA_TYPE_RAW_14BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_14_BIT,\n\t\t14,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SGRBG14_1X14,\n\t\tDATA_TYPE_RAW_14BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_14_BIT,\n\t\t14,\n\t\t1,\n\t},\n\t{\n\t\tMEDIA_BUS_FMT_SRGGB14_1X14,\n\t\tDATA_TYPE_RAW_14BIT,\n\t\tDECODE_FORMAT_UNCOMPRESSED_14_BIT,\n\t\t14,\n\t\t1,\n\t},\n};\n\nstatic void __csid_configure_stream(struct csid_device *csid, u8 enable, u8 vc)\n{\n\tstruct csid_testgen_config *tg = &csid->testgen;\n\tu32 val;\n\tu32 phy_sel = 0;\n\tu8 lane_cnt = csid->phy.lane_cnt;\n\t \n\tstruct v4l2_mbus_framefmt *input_format = &csid->fmt[MSM_CSID_PAD_FIRST_SRC + vc];\n\tconst struct csid_format *format = csid_get_fmt_entry(csid->formats, csid->nformats,\n\t\t\t\t\t\t\t      input_format->code);\n\n\tif (!lane_cnt)\n\t\tlane_cnt = 4;\n\n\tif (!tg->enabled)\n\t\tphy_sel = csid->phy.csiphy_id;\n\n\tif (enable) {\n\t\t \n\t\tu8 dt_id = vc & 0x03;\n\n\t\tif (tg->enabled) {\n\t\t\t \n\t\t\tval = vc << TPG_VC_CFG0_VC_NUM;\n\t\t\tval |= INTELEAVING_MODE_ONE_SHOT << TPG_VC_CFG0_LINE_INTERLEAVING_MODE;\n\t\t\tval |= 0 << TPG_VC_CFG0_NUM_FRAMES;\n\t\t\twritel_relaxed(val, csid->base + CSID_TPG_VC_CFG0);\n\n\t\t\tval = 0x740 << TPG_VC_CFG1_H_BLANKING_COUNT;\n\t\t\tval |= 0x3ff << TPG_VC_CFG1_V_BLANKING_COUNT;\n\t\t\twritel_relaxed(val, csid->base + CSID_TPG_VC_CFG1);\n\n\t\t\twritel_relaxed(0x12345678, csid->base + CSID_TPG_LFSR_SEED);\n\n\t\t\tval = (input_format->height & 0x1fff) << TPG_DT_n_CFG_0_FRAME_HEIGHT;\n\t\t\tval |= (input_format->width & 0x1fff) << TPG_DT_n_CFG_0_FRAME_WIDTH;\n\t\t\twritel_relaxed(val, csid->base + CSID_TPG_DT_n_CFG_0(0));\n\n\t\t\tval = format->data_type << TPG_DT_n_CFG_1_DATA_TYPE;\n\t\t\twritel_relaxed(val, csid->base + CSID_TPG_DT_n_CFG_1(0));\n\n\t\t\tval = (tg->mode - 1) << TPG_DT_n_CFG_2_PAYLOAD_MODE;\n\t\t\tval |= 0xBE << TPG_DT_n_CFG_2_USER_SPECIFIED_PAYLOAD;\n\t\t\tval |= format->decode_format << TPG_DT_n_CFG_2_ENCODE_FORMAT;\n\t\t\twritel_relaxed(val, csid->base + CSID_TPG_DT_n_CFG_2(0));\n\n\t\t\twritel_relaxed(0, csid->base + CSID_TPG_COLOR_BARS_CFG);\n\n\t\t\twritel_relaxed(0, csid->base + CSID_TPG_COLOR_BOX_CFG);\n\t\t}\n\n\t\tval = 1 << RDI_CFG0_BYTE_CNTR_EN;\n\t\tval |= 1 << RDI_CFG0_FORMAT_MEASURE_EN;\n\t\tval |= 1 << RDI_CFG0_TIMESTAMP_EN;\n\t\t \n\t\tval |= DECODE_FORMAT_PAYLOAD_ONLY << RDI_CFG0_DECODE_FORMAT;\n\t\tval |= format->data_type << RDI_CFG0_DATA_TYPE;\n\t\tval |= vc << RDI_CFG0_VIRTUAL_CHANNEL;\n\t\tval |= dt_id << RDI_CFG0_DT_ID;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_CFG0(vc));\n\n\t\t \n\t\tval = 2 << RDI_CFG1_TIMESTAMP_STB_SEL;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_CFG1(vc));\n\n\t\tval = 1;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_FRM_DROP_PERIOD(vc));\n\n\t\tval = 0;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_FRM_DROP_PATTERN(vc));\n\n\t\tval = 1;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_IRQ_SUBSAMPLE_PERIOD(vc));\n\n\t\tval = 0;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_IRQ_SUBSAMPLE_PATTERN(vc));\n\n\t\tval = 1;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_RPP_PIX_DROP_PERIOD(vc));\n\n\t\tval = 0;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_RPP_PIX_DROP_PATTERN(vc));\n\n\t\tval = 1;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_RPP_LINE_DROP_PERIOD(vc));\n\n\t\tval = 0;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_RPP_LINE_DROP_PATTERN(vc));\n\n\t\tval = 0;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_CTRL(vc));\n\n\t\tval = readl_relaxed(csid->base + CSID_RDI_CFG0(vc));\n\t\tval |=  1 << RDI_CFG0_ENABLE;\n\t\twritel_relaxed(val, csid->base + CSID_RDI_CFG0(vc));\n\t}\n\n\tif (tg->enabled) {\n\t\tval = enable << TPG_CTRL_TEST_EN;\n\t\tval |= 1 << TPG_CTRL_FS_PKT_EN;\n\t\tval |= 1 << TPG_CTRL_FE_PKT_EN;\n\t\tval |= (lane_cnt - 1) << TPG_CTRL_NUM_ACTIVE_LANES;\n\t\tval |= 0x64 << TPG_CTRL_CYCLES_BETWEEN_PKTS;\n\t\tval |= 0xA << TPG_CTRL_NUM_TRAIL_BYTES;\n\t\twritel_relaxed(val, csid->base + CSID_TPG_CTRL);\n\t}\n\n\tval = (lane_cnt - 1) << CSI2_RX_CFG0_NUM_ACTIVE_LANES;\n\tval |= csid->phy.lane_assign << CSI2_RX_CFG0_DL0_INPUT_SEL;\n\tval |= phy_sel << CSI2_RX_CFG0_PHY_NUM_SEL;\n\twritel_relaxed(val, csid->base + CSID_CSI2_RX_CFG0);\n\n\tval = 1 << CSI2_RX_CFG1_PACKET_ECC_CORRECTION_EN;\n\tif (vc > 3)\n\t\tval |= 1 << CSI2_RX_CFG1_VC_MODE;\n\tval |= 1 << CSI2_RX_CFG1_MISR_EN;\n\twritel_relaxed(val, csid->base + CSID_CSI2_RX_CFG1);\n\n\tif (enable)\n\t\tval = HALT_CMD_RESUME_AT_FRAME_BOUNDARY << RDI_CTRL_HALT_CMD;\n\telse\n\t\tval = HALT_CMD_HALT_AT_FRAME_BOUNDARY << RDI_CTRL_HALT_CMD;\n\twritel_relaxed(val, csid->base + CSID_RDI_CTRL(vc));\n}\n\nstatic void csid_configure_stream(struct csid_device *csid, u8 enable)\n{\n\tu8 i;\n\t \n\tfor (i = 0; i < MSM_CSID_MAX_SRC_STREAMS; i++)\n\t\tif (csid->phy.en_vc & BIT(i))\n\t\t\t__csid_configure_stream(csid, enable, i);\n}\n\nstatic int csid_configure_testgen_pattern(struct csid_device *csid, s32 val)\n{\n\tif (val > 0 && val <= csid->testgen.nmodes)\n\t\tcsid->testgen.mode = val;\n\n\treturn 0;\n}\n\n \nstatic u32 csid_hw_version(struct csid_device *csid)\n{\n\tu32 hw_version;\n\tu32 hw_gen;\n\tu32 hw_rev;\n\tu32 hw_step;\n\n\thw_version = readl_relaxed(csid->base + CSID_HW_VERSION);\n\thw_gen = (hw_version >> HW_VERSION_GENERATION) & 0xF;\n\thw_rev = (hw_version >> HW_VERSION_REVISION) & 0xFFF;\n\thw_step = (hw_version >> HW_VERSION_STEPPING) & 0xFFFF;\n\tdev_dbg(csid->camss->dev, \"CSID HW Version = %u.%u.%u\\n\",\n\t\thw_gen, hw_rev, hw_step);\n\n\treturn hw_version;\n}\n\n \nstatic irqreturn_t csid_isr(int irq, void *dev)\n{\n\tstruct csid_device *csid = dev;\n\tu32 val;\n\tu8 reset_done;\n\tint i;\n\n\tval = readl_relaxed(csid->base + CSID_TOP_IRQ_STATUS);\n\twritel_relaxed(val, csid->base + CSID_TOP_IRQ_CLEAR);\n\treset_done = val & BIT(TOP_IRQ_STATUS_RESET_DONE);\n\n\tval = readl_relaxed(csid->base + CSID_CSI2_RX_IRQ_STATUS);\n\twritel_relaxed(val, csid->base + CSID_CSI2_RX_IRQ_CLEAR);\n\n\t \n\tfor (i = 0; i < MSM_CSID_MAX_SRC_STREAMS; i++)\n\t\tif (csid->phy.en_vc & BIT(i)) {\n\t\t\tval = readl_relaxed(csid->base + CSID_CSI2_RDIN_IRQ_STATUS(i));\n\t\t\twritel_relaxed(val, csid->base + CSID_CSI2_RDIN_IRQ_CLEAR(i));\n\t\t}\n\n\tval = 1 << IRQ_CMD_CLEAR;\n\twritel_relaxed(val, csid->base + CSID_IRQ_CMD);\n\n\tif (reset_done)\n\t\tcomplete(&csid->reset_complete);\n\n\treturn IRQ_HANDLED;\n}\n\n \nstatic int csid_reset(struct csid_device *csid)\n{\n\tunsigned long time;\n\tu32 val;\n\n\treinit_completion(&csid->reset_complete);\n\n\twritel_relaxed(1, csid->base + CSID_TOP_IRQ_CLEAR);\n\twritel_relaxed(1, csid->base + CSID_IRQ_CMD);\n\twritel_relaxed(1, csid->base + CSID_TOP_IRQ_MASK);\n\twritel_relaxed(1, csid->base + CSID_IRQ_CMD);\n\n\t \n\tval = 0x1e << RST_STROBES;\n\twritel_relaxed(val, csid->base + CSID_RST_STROBES);\n\n\ttime = wait_for_completion_timeout(&csid->reset_complete,\n\t\t\t\t\t   msecs_to_jiffies(CSID_RESET_TIMEOUT_MS));\n\tif (!time) {\n\t\tdev_err(csid->camss->dev, \"CSID reset timeout\\n\");\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 csid_src_pad_code(struct csid_device *csid, u32 sink_code,\n\t\t\t     unsigned int match_format_idx, u32 match_code)\n{\n\tswitch (sink_code) {\n\tcase MEDIA_BUS_FMT_SBGGR10_1X10:\n\t{\n\t\tu32 src_code[] = {\n\t\t\tMEDIA_BUS_FMT_SBGGR10_1X10,\n\t\t\tMEDIA_BUS_FMT_SBGGR10_2X8_PADHI_LE,\n\t\t};\n\n\t\treturn csid_find_code(src_code, ARRAY_SIZE(src_code),\n\t\t\t\t      match_format_idx, match_code);\n\t}\n\tcase MEDIA_BUS_FMT_Y10_1X10:\n\t{\n\t\tu32 src_code[] = {\n\t\t\tMEDIA_BUS_FMT_Y10_1X10,\n\t\t\tMEDIA_BUS_FMT_Y10_2X8_PADHI_LE,\n\t\t};\n\n\t\treturn csid_find_code(src_code, ARRAY_SIZE(src_code),\n\t\t\t\t      match_format_idx, match_code);\n\t}\n\tdefault:\n\t\tif (match_format_idx > 0)\n\t\t\treturn 0;\n\n\t\treturn sink_code;\n\t}\n}\n\nstatic void csid_subdev_init(struct csid_device *csid)\n{\n\tcsid->formats = csid_formats;\n\tcsid->nformats = ARRAY_SIZE(csid_formats);\n\tcsid->testgen.modes = csid_testgen_modes;\n\tcsid->testgen.nmodes = CSID_PAYLOAD_MODE_NUM_SUPPORTED_GEN2;\n}\n\nconst struct csid_hw_ops csid_ops_gen2 = {\n\t.configure_stream = csid_configure_stream,\n\t.configure_testgen_pattern = csid_configure_testgen_pattern,\n\t.hw_version = csid_hw_version,\n\t.isr = csid_isr,\n\t.reset = csid_reset,\n\t.src_pad_code = csid_src_pad_code,\n\t.subdev_init = csid_subdev_init,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}