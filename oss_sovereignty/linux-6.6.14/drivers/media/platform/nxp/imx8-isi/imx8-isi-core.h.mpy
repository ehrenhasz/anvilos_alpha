{
  "module_name": "imx8-isi-core.h",
  "hash_id": "19446d46b5df927478d6d1f2c18494c1af47f349b09147a2613066edc94bd33d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/nxp/imx8-isi/imx8-isi-core.h",
  "human_readable_source": " \n \n\n#ifndef __MXC_ISI_CORE_H__\n#define __MXC_ISI_CORE_H__\n\n#include <linux/list.h>\n#include <linux/mutex.h>\n#include <linux/spinlock.h>\n#include <linux/types.h>\n#include <linux/videodev2.h>\n\n#include <media/media-device.h>\n#include <media/media-entity.h>\n#include <media/v4l2-async.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-dev.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-subdev.h>\n#include <media/videobuf2-core.h>\n#include <media/videobuf2-v4l2.h>\n\nstruct clk_bulk_data;\nstruct dentry;\nstruct device;\nstruct media_intf_devnode;\nstruct regmap;\nstruct v4l2_m2m_dev;\n\n \n#define MXC_ISI_PIPE_PAD_SINK\t\t0\n#define MXC_ISI_PIPE_PAD_SOURCE\t\t1\n#define MXC_ISI_PIPE_PADS_NUM\t\t2\n\n#define MXC_ISI_MIN_WIDTH\t\t1U\n#define MXC_ISI_MIN_HEIGHT\t\t1U\n#define MXC_ISI_MAX_WIDTH_UNCHAINED\t2048U\n#define MXC_ISI_MAX_WIDTH_CHAINED\t4096U\n#define MXC_ISI_MAX_HEIGHT\t\t8191U\n\n#define MXC_ISI_DEF_WIDTH\t\t1920U\n#define MXC_ISI_DEF_HEIGHT\t\t1080U\n#define MXC_ISI_DEF_MBUS_CODE_SINK\tMEDIA_BUS_FMT_UYVY8_1X16\n#define MXC_ISI_DEF_MBUS_CODE_SOURCE\tMEDIA_BUS_FMT_YUV8_1X24\n#define MXC_ISI_DEF_PIXEL_FORMAT\tV4L2_PIX_FMT_YUYV\n#define MXC_ISI_DEF_COLOR_SPACE\t\tV4L2_COLORSPACE_SRGB\n#define MXC_ISI_DEF_YCBCR_ENC\t\tV4L2_YCBCR_ENC_601\n#define MXC_ISI_DEF_QUANTIZATION\tV4L2_QUANTIZATION_LIM_RANGE\n#define MXC_ISI_DEF_XFER_FUNC\t\tV4L2_XFER_FUNC_SRGB\n\n#define MXC_ISI_DRIVER_NAME\t\t\"mxc-isi\"\n#define MXC_ISI_CAPTURE\t\t\t\"mxc-isi-cap\"\n#define MXC_ISI_M2M\t\t\t\"mxc-isi-m2m\"\n#define MXC_MAX_PLANES\t\t\t3\n\nstruct mxc_isi_dev;\nstruct mxc_isi_m2m_ctx;\n\nenum mxc_isi_buf_id {\n\tMXC_ISI_BUF1 = 0x0,\n\tMXC_ISI_BUF2,\n};\n\nenum mxc_isi_encoding {\n\tMXC_ISI_ENC_RAW,\n\tMXC_ISI_ENC_RGB,\n\tMXC_ISI_ENC_YUV,\n};\n\nenum mxc_isi_input_id {\n\t \n\tMXC_ISI_INPUT_MEM = 16,\n};\n\nenum mxc_isi_video_type {\n\tMXC_ISI_VIDEO_CAP = BIT(0),\n\tMXC_ISI_VIDEO_M2M_OUT = BIT(1),\n\tMXC_ISI_VIDEO_M2M_CAP = BIT(2),\n};\n\nstruct mxc_isi_format_info {\n\tu32\tmbus_code;\n\tu32\tfourcc;\n\tenum mxc_isi_video_type type;\n\tu32\tisi_in_format;\n\tu32\tisi_out_format;\n\tu8\tmem_planes;\n\tu8\tcolor_planes;\n\tu8\tdepth[MXC_MAX_PLANES];\n\tu8\thsub;\n\tu8\tvsub;\n\tenum mxc_isi_encoding encoding;\n};\n\nstruct mxc_isi_bus_format_info {\n\tu32\tmbus_code;\n\tu32\toutput;\n\tu32\tpads;\n\tenum mxc_isi_encoding encoding;\n};\n\nstruct mxc_isi_buffer {\n\tstruct vb2_v4l2_buffer  v4l2_buf;\n\tstruct list_head\tlist;\n\tdma_addr_t\t\tdma_addrs[3];\n\tenum mxc_isi_buf_id\tid;\n\tbool discard;\n};\n\nstruct mxc_isi_reg {\n\tu32 offset;\n\tu32 mask;\n};\n\nstruct mxc_isi_ier_reg {\n\t \n\tstruct mxc_isi_reg oflw_y_buf_en;\n\tstruct mxc_isi_reg oflw_u_buf_en;\n\tstruct mxc_isi_reg oflw_v_buf_en;\n\n\t \n\tstruct mxc_isi_reg excs_oflw_y_buf_en;\n\tstruct mxc_isi_reg excs_oflw_u_buf_en;\n\tstruct mxc_isi_reg excs_oflw_v_buf_en;\n\n\t \n\tstruct mxc_isi_reg panic_y_buf_en;\n\tstruct mxc_isi_reg panic_v_buf_en;\n\tstruct mxc_isi_reg panic_u_buf_en;\n};\n\nstruct mxc_isi_panic_thd {\n\tu32 mask;\n\tu32 offset;\n\tu32 threshold;\n};\n\nstruct mxc_isi_set_thd {\n\tstruct mxc_isi_panic_thd panic_set_thd_y;\n\tstruct mxc_isi_panic_thd panic_set_thd_u;\n\tstruct mxc_isi_panic_thd panic_set_thd_v;\n};\n\nstruct mxc_gasket_ops {\n\tvoid (*enable)(struct mxc_isi_dev *isi,\n\t\t       const struct v4l2_mbus_frame_desc *fd,\n\t\t       const struct v4l2_mbus_framefmt *fmt,\n\t\t       const unsigned int port);\n\tvoid (*disable)(struct mxc_isi_dev *isi, const unsigned int port);\n};\n\nenum model {\n\tMXC_ISI_IMX8MN,\n\tMXC_ISI_IMX8MP,\n\tMXC_ISI_IMX93,\n};\n\nstruct mxc_isi_plat_data {\n\tenum model model;\n\tunsigned int num_ports;\n\tunsigned int num_channels;\n\tunsigned int reg_offset;\n\tconst struct mxc_isi_ier_reg  *ier_reg;\n\tconst struct mxc_isi_set_thd *set_thd;\n\tconst struct mxc_gasket_ops *gasket_ops;\n\tconst struct clk_bulk_data *clks;\n\tunsigned int num_clks;\n\tbool buf_active_reverse;\n\tbool has_36bit_dma;\n};\n\nstruct mxc_isi_dma_buffer {\n\tsize_t\t\t\t\tsize;\n\tvoid\t\t\t\t*addr;\n\tdma_addr_t\t\t\tdma;\n};\n\nstruct mxc_isi_input {\n\tunsigned int\t\t\tenable_count;\n};\n\nstruct mxc_isi_crossbar {\n\tstruct mxc_isi_dev\t\t*isi;\n\n\tunsigned int\t\t\tnum_sinks;\n\tunsigned int\t\t\tnum_sources;\n\tstruct mxc_isi_input\t\t*inputs;\n\n\tstruct v4l2_subdev\t\tsd;\n\tstruct media_pad\t\t*pads;\n};\n\nstruct mxc_isi_video {\n\tstruct mxc_isi_pipe\t\t*pipe;\n\n\tstruct video_device\t\tvdev;\n\tstruct media_pad\t\tpad;\n\n\t \n\tstruct mutex\t\t\tlock;\n\tbool\t\t\t\tis_streaming;\n\n\tstruct v4l2_pix_format_mplane\tpix;\n\tconst struct mxc_isi_format_info *fmtinfo;\n\n\tstruct {\n\t\tstruct v4l2_ctrl_handler handler;\n\t\tunsigned int\t\talpha;\n\t\tbool\t\t\thflip;\n\t\tbool\t\t\tvflip;\n\t} ctrls;\n\n\tstruct vb2_queue\t\tvb2_q;\n\tstruct mxc_isi_buffer\t\tbuf_discard[3];\n\tstruct list_head\t\tout_pending;\n\tstruct list_head\t\tout_active;\n\tstruct list_head\t\tout_discard;\n\tu32\t\t\t\tframe_count;\n\t \n\tspinlock_t\t\t\tbuf_lock;\n\n\tstruct mxc_isi_dma_buffer\tdiscard_buffer[MXC_MAX_PLANES];\n};\n\ntypedef void(*mxc_isi_pipe_irq_t)(struct mxc_isi_pipe *, u32);\n\nstruct mxc_isi_pipe {\n\tstruct mxc_isi_dev\t\t*isi;\n\tu32\t\t\t\tid;\n\tvoid __iomem\t\t\t*regs;\n\n\tstruct media_pipeline\t\tpipe;\n\n\tstruct v4l2_subdev\t\tsd;\n\tstruct media_pad\t\tpads[MXC_ISI_PIPE_PADS_NUM];\n\n\tstruct mxc_isi_video\t\tvideo;\n\n\t \n\tstruct mutex\t\t\tlock;\n\tunsigned int\t\t\tuse_count;\n\tmxc_isi_pipe_irq_t\t\tirq_handler;\n\n#define MXC_ISI_CHANNEL_RES_LINE_BUF\tBIT(0)\n#define MXC_ISI_CHANNEL_RES_OUTPUT_BUF\tBIT(1)\n\tu8\t\t\t\tavailable_res;\n\tu8\t\t\t\tacquired_res;\n\tu8\t\t\t\tchained_res;\n\tbool\t\t\t\tchained;\n};\n\nstruct mxc_isi_m2m {\n\tstruct mxc_isi_dev\t\t*isi;\n\tstruct mxc_isi_pipe\t\t*pipe;\n\n\tstruct media_pad\t\tpad;\n\tstruct video_device\t\tvdev;\n\tstruct media_intf_devnode\t*intf;\n\tstruct v4l2_m2m_dev\t\t*m2m_dev;\n\n\t \n\tstruct mutex\t\t\tlock;\n\n\tstruct mxc_isi_m2m_ctx\t\t*last_ctx;\n\tint\t\t\t\tusage_count;\n\tint\t\t\t\tchained_count;\n};\n\nstruct mxc_isi_dev {\n\tstruct device\t\t\t*dev;\n\n\tconst struct mxc_isi_plat_data\t*pdata;\n\n\tvoid __iomem\t\t\t*regs;\n\tstruct clk_bulk_data\t\t*clks;\n\tstruct regmap\t\t\t*gasket;\n\n\tstruct mxc_isi_crossbar\t\tcrossbar;\n\tstruct mxc_isi_pipe\t\t*pipes;\n\tstruct mxc_isi_m2m\t\tm2m;\n\n\tstruct media_device\t\tmedia_dev;\n\tstruct v4l2_device\t\tv4l2_dev;\n\tstruct v4l2_async_notifier\tnotifier;\n\n\tstruct dentry\t\t\t*debugfs_root;\n};\n\nextern const struct mxc_gasket_ops mxc_imx8_gasket_ops;\nextern const struct mxc_gasket_ops mxc_imx93_gasket_ops;\n\nint mxc_isi_crossbar_init(struct mxc_isi_dev *isi);\nvoid mxc_isi_crossbar_cleanup(struct mxc_isi_crossbar *xbar);\nint mxc_isi_crossbar_register(struct mxc_isi_crossbar *xbar);\nvoid mxc_isi_crossbar_unregister(struct mxc_isi_crossbar *xbar);\n\nconst struct mxc_isi_bus_format_info *\nmxc_isi_bus_format_by_code(u32 code, unsigned int pad);\nconst struct mxc_isi_bus_format_info *\nmxc_isi_bus_format_by_index(unsigned int index, unsigned int pad);\nconst struct mxc_isi_format_info *\nmxc_isi_format_by_fourcc(u32 fourcc, enum mxc_isi_video_type type);\nconst struct mxc_isi_format_info *\nmxc_isi_format_enum(unsigned int index, enum mxc_isi_video_type type);\nconst struct mxc_isi_format_info *\nmxc_isi_format_try(struct mxc_isi_pipe *pipe, struct v4l2_pix_format_mplane *pix,\n\t\t   enum mxc_isi_video_type type);\n\nint mxc_isi_pipe_init(struct mxc_isi_dev *isi, unsigned int id);\nvoid mxc_isi_pipe_cleanup(struct mxc_isi_pipe *pipe);\nint mxc_isi_pipe_acquire(struct mxc_isi_pipe *pipe,\n\t\t\t mxc_isi_pipe_irq_t irq_handler);\nvoid mxc_isi_pipe_release(struct mxc_isi_pipe *pipe);\nint mxc_isi_pipe_enable(struct mxc_isi_pipe *pipe);\nvoid mxc_isi_pipe_disable(struct mxc_isi_pipe *pipe);\n\nint mxc_isi_video_register(struct mxc_isi_pipe *pipe,\n\t\t\t   struct v4l2_device *v4l2_dev);\nvoid mxc_isi_video_unregister(struct mxc_isi_pipe *pipe);\nvoid mxc_isi_video_suspend(struct mxc_isi_pipe *pipe);\nint mxc_isi_video_resume(struct mxc_isi_pipe *pipe);\nint mxc_isi_video_queue_setup(const struct v4l2_pix_format_mplane *format,\n\t\t\t      const struct mxc_isi_format_info *info,\n\t\t\t      unsigned int *num_buffers,\n\t\t\t      unsigned int *num_planes, unsigned int sizes[]);\nvoid mxc_isi_video_buffer_init(struct vb2_buffer *vb2, dma_addr_t dma_addrs[3],\n\t\t\t       const struct mxc_isi_format_info *info,\n\t\t\t       const struct v4l2_pix_format_mplane *pix);\nint mxc_isi_video_buffer_prepare(struct mxc_isi_dev *isi, struct vb2_buffer *vb2,\n\t\t\t\t const struct mxc_isi_format_info *info,\n\t\t\t\t const struct v4l2_pix_format_mplane *pix);\n\n#ifdef CONFIG_VIDEO_IMX8_ISI_M2M\nint mxc_isi_m2m_register(struct mxc_isi_dev *isi, struct v4l2_device *v4l2_dev);\nint mxc_isi_m2m_unregister(struct mxc_isi_dev *isi);\n#else\nstatic inline int mxc_isi_m2m_register(struct mxc_isi_dev *isi,\n\t\t\t\t       struct v4l2_device *v4l2_dev)\n{\n\treturn 0;\n}\nstatic inline int mxc_isi_m2m_unregister(struct mxc_isi_dev *isi)\n{\n\treturn 0;\n}\n#endif\n\nint mxc_isi_channel_acquire(struct mxc_isi_pipe *pipe,\n\t\t\t    mxc_isi_pipe_irq_t irq_handler, bool bypass);\nvoid mxc_isi_channel_release(struct mxc_isi_pipe *pipe);\nvoid mxc_isi_channel_get(struct mxc_isi_pipe *pipe);\nvoid mxc_isi_channel_put(struct mxc_isi_pipe *pipe);\nvoid mxc_isi_channel_enable(struct mxc_isi_pipe *pipe);\nvoid mxc_isi_channel_disable(struct mxc_isi_pipe *pipe);\nint mxc_isi_channel_chain(struct mxc_isi_pipe *pipe, bool bypass);\nvoid mxc_isi_channel_unchain(struct mxc_isi_pipe *pipe);\n\nvoid mxc_isi_channel_config(struct mxc_isi_pipe *pipe,\n\t\t\t    enum mxc_isi_input_id input,\n\t\t\t    const struct v4l2_area *in_size,\n\t\t\t    const struct v4l2_area *scale,\n\t\t\t    const struct v4l2_rect *crop,\n\t\t\t    enum mxc_isi_encoding in_encoding,\n\t\t\t    enum mxc_isi_encoding out_encoding);\n\nvoid mxc_isi_channel_set_input_format(struct mxc_isi_pipe *pipe,\n\t\t\t\t      const struct mxc_isi_format_info *info,\n\t\t\t\t      const struct v4l2_pix_format_mplane *format);\nvoid mxc_isi_channel_set_output_format(struct mxc_isi_pipe *pipe,\n\t\t\t\t       const struct mxc_isi_format_info *info,\n\t\t\t\t       struct v4l2_pix_format_mplane *format);\nvoid mxc_isi_channel_m2m_start(struct mxc_isi_pipe *pipe);\n\nvoid mxc_isi_channel_set_alpha(struct mxc_isi_pipe *pipe, u8 alpha);\nvoid mxc_isi_channel_set_flip(struct mxc_isi_pipe *pipe, bool hflip, bool vflip);\n\nvoid mxc_isi_channel_set_inbuf(struct mxc_isi_pipe *pipe, dma_addr_t dma_addr);\nvoid mxc_isi_channel_set_outbuf(struct mxc_isi_pipe *pipe,\n\t\t\t\tconst dma_addr_t dma_addrs[3],\n\t\t\t\tenum mxc_isi_buf_id buf_id);\n\nu32 mxc_isi_channel_irq_status(struct mxc_isi_pipe *pipe, bool clear);\nvoid mxc_isi_channel_irq_clear(struct mxc_isi_pipe *pipe);\n\n#if IS_ENABLED(CONFIG_DEBUG_FS)\nvoid mxc_isi_debug_init(struct mxc_isi_dev *isi);\nvoid mxc_isi_debug_cleanup(struct mxc_isi_dev *isi);\n#else\nstatic inline void mxc_isi_debug_init(struct mxc_isi_dev *isi)\n{\n}\nstatic inline void mxc_isi_debug_cleanup(struct mxc_isi_dev *isi)\n{\n}\n#endif\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}