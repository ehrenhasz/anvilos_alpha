{
  "module_name": "rga-hw.c",
  "hash_id": "1eb9fc53d86f0f5a63ccdbf066c48a804fda18b024c52153cedd5b18252fcd38",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/rockchip/rga/rga-hw.c",
  "human_readable_source": "\n \n\n#include <linux/pm_runtime.h>\n\n#include \"rga-hw.h\"\n#include \"rga.h\"\n\nenum e_rga_start_pos {\n\tLT = 0,\n\tLB = 1,\n\tRT = 2,\n\tRB = 3,\n};\n\nstruct rga_addr_offset {\n\tunsigned int y_off;\n\tunsigned int u_off;\n\tunsigned int v_off;\n};\n\nstruct rga_corners_addr_offset {\n\tstruct rga_addr_offset left_top;\n\tstruct rga_addr_offset right_top;\n\tstruct rga_addr_offset left_bottom;\n\tstruct rga_addr_offset right_bottom;\n};\n\nstatic unsigned int rga_get_scaling(unsigned int src, unsigned int dst)\n{\n\t \n\n\treturn (src > dst) ? ((dst << 16) / src) : ((src << 16) / dst);\n}\n\nstatic struct rga_corners_addr_offset\nrga_get_addr_offset(struct rga_frame *frm, unsigned int x, unsigned int y,\n\t\t    unsigned int w, unsigned int h)\n{\n\tstruct rga_corners_addr_offset offsets;\n\tstruct rga_addr_offset *lt, *lb, *rt, *rb;\n\tunsigned int x_div = 0,\n\t\t     y_div = 0, uv_stride = 0, pixel_width = 0, uv_factor = 0;\n\n\tlt = &offsets.left_top;\n\tlb = &offsets.left_bottom;\n\trt = &offsets.right_top;\n\trb = &offsets.right_bottom;\n\n\tx_div = frm->fmt->x_div;\n\ty_div = frm->fmt->y_div;\n\tuv_factor = frm->fmt->uv_factor;\n\tuv_stride = frm->stride / x_div;\n\tpixel_width = frm->stride / frm->width;\n\n\tlt->y_off = y * frm->stride + x * pixel_width;\n\tlt->u_off =\n\t\tfrm->width * frm->height + (y / y_div) * uv_stride + x / x_div;\n\tlt->v_off = lt->u_off + frm->width * frm->height / uv_factor;\n\n\tlb->y_off = lt->y_off + (h - 1) * frm->stride;\n\tlb->u_off = lt->u_off + (h / y_div - 1) * uv_stride;\n\tlb->v_off = lt->v_off + (h / y_div - 1) * uv_stride;\n\n\trt->y_off = lt->y_off + (w - 1) * pixel_width;\n\trt->u_off = lt->u_off + w / x_div - 1;\n\trt->v_off = lt->v_off + w / x_div - 1;\n\n\trb->y_off = lb->y_off + (w - 1) * pixel_width;\n\trb->u_off = lb->u_off + w / x_div - 1;\n\trb->v_off = lb->v_off + w / x_div - 1;\n\n\treturn offsets;\n}\n\nstatic struct rga_addr_offset *rga_lookup_draw_pos(struct\n\t\trga_corners_addr_offset\n\t\t* offsets, u32 rotate_mode,\n\t\tu32 mirr_mode)\n{\n\tstatic enum e_rga_start_pos rot_mir_point_matrix[4][4] = {\n\t\t{\n\t\t\tLT, RT, LB, RB,\n\t\t},\n\t\t{\n\t\t\tRT, LT, RB, LB,\n\t\t},\n\t\t{\n\t\t\tRB, LB, RT, LT,\n\t\t},\n\t\t{\n\t\t\tLB, RB, LT, RT,\n\t\t},\n\t};\n\n\tif (!offsets)\n\t\treturn NULL;\n\n\tswitch (rot_mir_point_matrix[rotate_mode][mirr_mode]) {\n\tcase LT:\n\t\treturn &offsets->left_top;\n\tcase LB:\n\t\treturn &offsets->left_bottom;\n\tcase RT:\n\t\treturn &offsets->right_top;\n\tcase RB:\n\t\treturn &offsets->right_bottom;\n\t}\n\n\treturn NULL;\n}\n\nstatic void rga_cmd_set_src_addr(struct rga_ctx *ctx, void *mmu_pages)\n{\n\tstruct rockchip_rga *rga = ctx->rga;\n\tu32 *dest = rga->cmdbuf_virt;\n\tunsigned int reg;\n\n\treg = RGA_MMU_SRC_BASE - RGA_MODE_BASE_REG;\n\tdest[reg >> 2] = virt_to_phys(mmu_pages) >> 4;\n\n\treg = RGA_MMU_CTRL1 - RGA_MODE_BASE_REG;\n\tdest[reg >> 2] |= 0x7;\n}\n\nstatic void rga_cmd_set_src1_addr(struct rga_ctx *ctx, void *mmu_pages)\n{\n\tstruct rockchip_rga *rga = ctx->rga;\n\tu32 *dest = rga->cmdbuf_virt;\n\tunsigned int reg;\n\n\treg = RGA_MMU_SRC1_BASE - RGA_MODE_BASE_REG;\n\tdest[reg >> 2] = virt_to_phys(mmu_pages) >> 4;\n\n\treg = RGA_MMU_CTRL1 - RGA_MODE_BASE_REG;\n\tdest[reg >> 2] |= 0x7 << 4;\n}\n\nstatic void rga_cmd_set_dst_addr(struct rga_ctx *ctx, void *mmu_pages)\n{\n\tstruct rockchip_rga *rga = ctx->rga;\n\tu32 *dest = rga->cmdbuf_virt;\n\tunsigned int reg;\n\n\treg = RGA_MMU_DST_BASE - RGA_MODE_BASE_REG;\n\tdest[reg >> 2] = virt_to_phys(mmu_pages) >> 4;\n\n\treg = RGA_MMU_CTRL1 - RGA_MODE_BASE_REG;\n\tdest[reg >> 2] |= 0x7 << 8;\n}\n\nstatic void rga_cmd_set_trans_info(struct rga_ctx *ctx)\n{\n\tstruct rockchip_rga *rga = ctx->rga;\n\tu32 *dest = rga->cmdbuf_virt;\n\tunsigned int scale_dst_w, scale_dst_h;\n\tunsigned int src_h, src_w, src_x, src_y, dst_h, dst_w, dst_x, dst_y;\n\tunion rga_src_info src_info;\n\tunion rga_dst_info dst_info;\n\tunion rga_src_x_factor x_factor;\n\tunion rga_src_y_factor y_factor;\n\tunion rga_src_vir_info src_vir_info;\n\tunion rga_src_act_info src_act_info;\n\tunion rga_dst_vir_info dst_vir_info;\n\tunion rga_dst_act_info dst_act_info;\n\n\tstruct rga_addr_offset *dst_offset;\n\tstruct rga_corners_addr_offset offsets;\n\tstruct rga_corners_addr_offset src_offsets;\n\n\tsrc_h = ctx->in.crop.height;\n\tsrc_w = ctx->in.crop.width;\n\tsrc_x = ctx->in.crop.left;\n\tsrc_y = ctx->in.crop.top;\n\tdst_h = ctx->out.crop.height;\n\tdst_w = ctx->out.crop.width;\n\tdst_x = ctx->out.crop.left;\n\tdst_y = ctx->out.crop.top;\n\n\tsrc_info.val = dest[(RGA_SRC_INFO - RGA_MODE_BASE_REG) >> 2];\n\tdst_info.val = dest[(RGA_DST_INFO - RGA_MODE_BASE_REG) >> 2];\n\tx_factor.val = dest[(RGA_SRC_X_FACTOR - RGA_MODE_BASE_REG) >> 2];\n\ty_factor.val = dest[(RGA_SRC_Y_FACTOR - RGA_MODE_BASE_REG) >> 2];\n\tsrc_vir_info.val = dest[(RGA_SRC_VIR_INFO - RGA_MODE_BASE_REG) >> 2];\n\tsrc_act_info.val = dest[(RGA_SRC_ACT_INFO - RGA_MODE_BASE_REG) >> 2];\n\tdst_vir_info.val = dest[(RGA_DST_VIR_INFO - RGA_MODE_BASE_REG) >> 2];\n\tdst_act_info.val = dest[(RGA_DST_ACT_INFO - RGA_MODE_BASE_REG) >> 2];\n\n\tsrc_info.data.format = ctx->in.fmt->hw_format;\n\tsrc_info.data.swap = ctx->in.fmt->color_swap;\n\tdst_info.data.format = ctx->out.fmt->hw_format;\n\tdst_info.data.swap = ctx->out.fmt->color_swap;\n\n\t \n\n\tif (RGA_COLOR_FMT_IS_YUV(ctx->in.fmt->hw_format) &&\n\t    RGA_COLOR_FMT_IS_RGB(ctx->out.fmt->hw_format)) {\n\t\tswitch (ctx->in.colorspace) {\n\t\tcase V4L2_COLORSPACE_REC709:\n\t\t\tsrc_info.data.csc_mode = RGA_SRC_CSC_MODE_BT709_R0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsrc_info.data.csc_mode = RGA_SRC_CSC_MODE_BT601_R0;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (RGA_COLOR_FMT_IS_RGB(ctx->in.fmt->hw_format) &&\n\t    RGA_COLOR_FMT_IS_YUV(ctx->out.fmt->hw_format)) {\n\t\tswitch (ctx->out.colorspace) {\n\t\tcase V4L2_COLORSPACE_REC709:\n\t\t\tdst_info.data.csc_mode = RGA_SRC_CSC_MODE_BT709_R0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdst_info.data.csc_mode = RGA_DST_CSC_MODE_BT601_R0;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (ctx->vflip)\n\t\tsrc_info.data.mir_mode |= RGA_SRC_MIRR_MODE_X;\n\n\tif (ctx->hflip)\n\t\tsrc_info.data.mir_mode |= RGA_SRC_MIRR_MODE_Y;\n\n\tswitch (ctx->rotate) {\n\tcase 90:\n\t\tsrc_info.data.rot_mode = RGA_SRC_ROT_MODE_90_DEGREE;\n\t\tbreak;\n\tcase 180:\n\t\tsrc_info.data.rot_mode = RGA_SRC_ROT_MODE_180_DEGREE;\n\t\tbreak;\n\tcase 270:\n\t\tsrc_info.data.rot_mode = RGA_SRC_ROT_MODE_270_DEGREE;\n\t\tbreak;\n\tdefault:\n\t\tsrc_info.data.rot_mode = RGA_SRC_ROT_MODE_0_DEGREE;\n\t\tbreak;\n\t}\n\n\t \n\tif (src_info.data.rot_mode == RGA_SRC_ROT_MODE_90_DEGREE ||\n\t    src_info.data.rot_mode == RGA_SRC_ROT_MODE_270_DEGREE) {\n\t\tif (rga->version.major == 0 || rga->version.minor == 0) {\n\t\t\tif (dst_w == src_h)\n\t\t\t\tsrc_h -= 8;\n\t\t\tif (abs(src_w - dst_h) < 16)\n\t\t\t\tsrc_w -= 16;\n\t\t}\n\n\t\tscale_dst_h = dst_w;\n\t\tscale_dst_w = dst_h;\n\t} else {\n\t\tscale_dst_w = dst_w;\n\t\tscale_dst_h = dst_h;\n\t}\n\n\tif (src_w == scale_dst_w) {\n\t\tsrc_info.data.hscl_mode = RGA_SRC_HSCL_MODE_NO;\n\t\tx_factor.val = 0;\n\t} else if (src_w > scale_dst_w) {\n\t\tsrc_info.data.hscl_mode = RGA_SRC_HSCL_MODE_DOWN;\n\t\tx_factor.data.down_scale_factor =\n\t\t\trga_get_scaling(src_w, scale_dst_w) + 1;\n\t} else {\n\t\tsrc_info.data.hscl_mode = RGA_SRC_HSCL_MODE_UP;\n\t\tx_factor.data.up_scale_factor =\n\t\t\trga_get_scaling(src_w - 1, scale_dst_w - 1);\n\t}\n\n\tif (src_h == scale_dst_h) {\n\t\tsrc_info.data.vscl_mode = RGA_SRC_VSCL_MODE_NO;\n\t\ty_factor.val = 0;\n\t} else if (src_h > scale_dst_h) {\n\t\tsrc_info.data.vscl_mode = RGA_SRC_VSCL_MODE_DOWN;\n\t\ty_factor.data.down_scale_factor =\n\t\t\trga_get_scaling(src_h, scale_dst_h) + 1;\n\t} else {\n\t\tsrc_info.data.vscl_mode = RGA_SRC_VSCL_MODE_UP;\n\t\ty_factor.data.up_scale_factor =\n\t\t\trga_get_scaling(src_h - 1, scale_dst_h - 1);\n\t}\n\n\t \n\tsrc_vir_info.data.vir_stride = ctx->in.stride >> 2;\n\tsrc_vir_info.data.vir_width = ctx->in.stride >> 2;\n\n\tsrc_act_info.data.act_height = src_h - 1;\n\tsrc_act_info.data.act_width = src_w - 1;\n\n\tdst_vir_info.data.vir_stride = ctx->out.stride >> 2;\n\tdst_act_info.data.act_height = dst_h - 1;\n\tdst_act_info.data.act_width = dst_w - 1;\n\n\t \n\tsrc_offsets = rga_get_addr_offset(&ctx->in, src_x, src_y,\n\t\t\t\t\t  src_w, src_h);\n\n\t \n\toffsets = rga_get_addr_offset(&ctx->out, dst_x, dst_y, dst_w, dst_h);\n\tdst_offset = rga_lookup_draw_pos(&offsets, src_info.data.rot_mode,\n\t\t\t\t\t src_info.data.mir_mode);\n\n\tdest[(RGA_SRC_Y_RGB_BASE_ADDR - RGA_MODE_BASE_REG) >> 2] =\n\t\tsrc_offsets.left_top.y_off;\n\tdest[(RGA_SRC_CB_BASE_ADDR - RGA_MODE_BASE_REG) >> 2] =\n\t\tsrc_offsets.left_top.u_off;\n\tdest[(RGA_SRC_CR_BASE_ADDR - RGA_MODE_BASE_REG) >> 2] =\n\t\tsrc_offsets.left_top.v_off;\n\n\tdest[(RGA_SRC_X_FACTOR - RGA_MODE_BASE_REG) >> 2] = x_factor.val;\n\tdest[(RGA_SRC_Y_FACTOR - RGA_MODE_BASE_REG) >> 2] = y_factor.val;\n\tdest[(RGA_SRC_VIR_INFO - RGA_MODE_BASE_REG) >> 2] = src_vir_info.val;\n\tdest[(RGA_SRC_ACT_INFO - RGA_MODE_BASE_REG) >> 2] = src_act_info.val;\n\n\tdest[(RGA_SRC_INFO - RGA_MODE_BASE_REG) >> 2] = src_info.val;\n\n\tdest[(RGA_DST_Y_RGB_BASE_ADDR - RGA_MODE_BASE_REG) >> 2] =\n\t\tdst_offset->y_off;\n\tdest[(RGA_DST_CB_BASE_ADDR - RGA_MODE_BASE_REG) >> 2] =\n\t\tdst_offset->u_off;\n\tdest[(RGA_DST_CR_BASE_ADDR - RGA_MODE_BASE_REG) >> 2] =\n\t\tdst_offset->v_off;\n\n\tdest[(RGA_DST_VIR_INFO - RGA_MODE_BASE_REG) >> 2] = dst_vir_info.val;\n\tdest[(RGA_DST_ACT_INFO - RGA_MODE_BASE_REG) >> 2] = dst_act_info.val;\n\n\tdest[(RGA_DST_INFO - RGA_MODE_BASE_REG) >> 2] = dst_info.val;\n}\n\nstatic void rga_cmd_set_mode(struct rga_ctx *ctx)\n{\n\tstruct rockchip_rga *rga = ctx->rga;\n\tu32 *dest = rga->cmdbuf_virt;\n\tunion rga_mode_ctrl mode;\n\tunion rga_alpha_ctrl0 alpha_ctrl0;\n\tunion rga_alpha_ctrl1 alpha_ctrl1;\n\n\tmode.val = 0;\n\talpha_ctrl0.val = 0;\n\talpha_ctrl1.val = 0;\n\n\tmode.data.gradient_sat = 1;\n\tmode.data.render = RGA_MODE_RENDER_BITBLT;\n\tmode.data.bitblt = RGA_MODE_BITBLT_MODE_SRC_TO_DST;\n\n\t \n\tdest[(RGA_ALPHA_CTRL0 - RGA_MODE_BASE_REG) >> 2] = alpha_ctrl0.val;\n\tdest[(RGA_ALPHA_CTRL1 - RGA_MODE_BASE_REG) >> 2] = alpha_ctrl1.val;\n\n\tdest[(RGA_MODE_CTRL - RGA_MODE_BASE_REG) >> 2] = mode.val;\n}\n\nstatic void rga_cmd_set(struct rga_ctx *ctx)\n{\n\tstruct rockchip_rga *rga = ctx->rga;\n\n\tmemset(rga->cmdbuf_virt, 0, RGA_CMDBUF_SIZE * 4);\n\n\trga_cmd_set_src_addr(ctx, rga->src_mmu_pages);\n\t \n\trga_cmd_set_src1_addr(ctx, rga->dst_mmu_pages);\n\n\trga_cmd_set_dst_addr(ctx, rga->dst_mmu_pages);\n\trga_cmd_set_mode(ctx);\n\n\trga_cmd_set_trans_info(ctx);\n\n\trga_write(rga, RGA_CMD_BASE, rga->cmdbuf_phy);\n\n\t \n\tdma_sync_single_for_device(rga->dev, rga->cmdbuf_phy,\n\t\tPAGE_SIZE, DMA_BIDIRECTIONAL);\n}\n\nvoid rga_hw_start(struct rockchip_rga *rga)\n{\n\tstruct rga_ctx *ctx = rga->curr;\n\n\trga_cmd_set(ctx);\n\n\trga_write(rga, RGA_SYS_CTRL, 0x00);\n\n\trga_write(rga, RGA_SYS_CTRL, 0x22);\n\n\trga_write(rga, RGA_INT, 0x600);\n\n\trga_write(rga, RGA_CMD_CTRL, 0x1);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}