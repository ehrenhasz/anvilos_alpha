{
  "module_name": "rkisp1-stats.c",
  "hash_id": "7360d216f07b80d6d5c29609a98e22484c8bff3bd9ea9c939cb97e33dded3ce4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/rockchip/rkisp1/rkisp1-stats.c",
  "human_readable_source": "\n \n\n#include <media/v4l2-common.h>\n#include <media/v4l2-event.h>\n#include <media/v4l2-ioctl.h>\n#include <media/videobuf2-core.h>\n#include <media/videobuf2-vmalloc.h>\t \n\n#include \"rkisp1-common.h\"\n\n#define RKISP1_STATS_DEV_NAME\tRKISP1_DRIVER_NAME \"_stats\"\n\n#define RKISP1_ISP_STATS_REQ_BUFS_MIN 2\n#define RKISP1_ISP_STATS_REQ_BUFS_MAX 8\n\nstatic int rkisp1_stats_enum_fmt_meta_cap(struct file *file, void *priv,\n\t\t\t\t\t  struct v4l2_fmtdesc *f)\n{\n\tstruct video_device *video = video_devdata(file);\n\tstruct rkisp1_stats *stats = video_get_drvdata(video);\n\n\tif (f->index > 0 || f->type != video->queue->type)\n\t\treturn -EINVAL;\n\n\tf->pixelformat = stats->vdev_fmt.fmt.meta.dataformat;\n\treturn 0;\n}\n\nstatic int rkisp1_stats_g_fmt_meta_cap(struct file *file, void *priv,\n\t\t\t\t       struct v4l2_format *f)\n{\n\tstruct video_device *video = video_devdata(file);\n\tstruct rkisp1_stats *stats = video_get_drvdata(video);\n\tstruct v4l2_meta_format *meta = &f->fmt.meta;\n\n\tif (f->type != video->queue->type)\n\t\treturn -EINVAL;\n\n\tmemset(meta, 0, sizeof(*meta));\n\tmeta->dataformat = stats->vdev_fmt.fmt.meta.dataformat;\n\tmeta->buffersize = stats->vdev_fmt.fmt.meta.buffersize;\n\n\treturn 0;\n}\n\nstatic int rkisp1_stats_querycap(struct file *file,\n\t\t\t\t void *priv, struct v4l2_capability *cap)\n{\n\tstruct video_device *vdev = video_devdata(file);\n\n\tstrscpy(cap->driver, RKISP1_DRIVER_NAME, sizeof(cap->driver));\n\tstrscpy(cap->card, vdev->name, sizeof(cap->card));\n\tstrscpy(cap->bus_info, RKISP1_BUS_INFO, sizeof(cap->bus_info));\n\n\treturn 0;\n}\n\n \nstatic const struct v4l2_ioctl_ops rkisp1_stats_ioctl = {\n\t.vidioc_reqbufs = vb2_ioctl_reqbufs,\n\t.vidioc_querybuf = vb2_ioctl_querybuf,\n\t.vidioc_create_bufs = vb2_ioctl_create_bufs,\n\t.vidioc_qbuf = vb2_ioctl_qbuf,\n\t.vidioc_dqbuf = vb2_ioctl_dqbuf,\n\t.vidioc_prepare_buf = vb2_ioctl_prepare_buf,\n\t.vidioc_expbuf = vb2_ioctl_expbuf,\n\t.vidioc_streamon = vb2_ioctl_streamon,\n\t.vidioc_streamoff = vb2_ioctl_streamoff,\n\t.vidioc_enum_fmt_meta_cap = rkisp1_stats_enum_fmt_meta_cap,\n\t.vidioc_g_fmt_meta_cap = rkisp1_stats_g_fmt_meta_cap,\n\t.vidioc_s_fmt_meta_cap = rkisp1_stats_g_fmt_meta_cap,\n\t.vidioc_try_fmt_meta_cap = rkisp1_stats_g_fmt_meta_cap,\n\t.vidioc_querycap = rkisp1_stats_querycap,\n\t.vidioc_subscribe_event = v4l2_ctrl_subscribe_event,\n\t.vidioc_unsubscribe_event = v4l2_event_unsubscribe,\n};\n\nstatic const struct v4l2_file_operations rkisp1_stats_fops = {\n\t.mmap = vb2_fop_mmap,\n\t.unlocked_ioctl = video_ioctl2,\n\t.poll = vb2_fop_poll,\n\t.open = v4l2_fh_open,\n\t.release = vb2_fop_release\n};\n\nstatic int rkisp1_stats_vb2_queue_setup(struct vb2_queue *vq,\n\t\t\t\t\tunsigned int *num_buffers,\n\t\t\t\t\tunsigned int *num_planes,\n\t\t\t\t\tunsigned int sizes[],\n\t\t\t\t\tstruct device *alloc_devs[])\n{\n\t*num_planes = 1;\n\n\t*num_buffers = clamp_t(u32, *num_buffers, RKISP1_ISP_STATS_REQ_BUFS_MIN,\n\t\t\t       RKISP1_ISP_STATS_REQ_BUFS_MAX);\n\n\tsizes[0] = sizeof(struct rkisp1_stat_buffer);\n\n\treturn 0;\n}\n\nstatic void rkisp1_stats_vb2_buf_queue(struct vb2_buffer *vb)\n{\n\tstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\n\tstruct rkisp1_buffer *stats_buf =\n\t\tcontainer_of(vbuf, struct rkisp1_buffer, vb);\n\tstruct vb2_queue *vq = vb->vb2_queue;\n\tstruct rkisp1_stats *stats_dev = vq->drv_priv;\n\n\n\tspin_lock_irq(&stats_dev->lock);\n\tlist_add_tail(&stats_buf->queue, &stats_dev->stat);\n\tspin_unlock_irq(&stats_dev->lock);\n}\n\nstatic int rkisp1_stats_vb2_buf_prepare(struct vb2_buffer *vb)\n{\n\tif (vb2_plane_size(vb, 0) < sizeof(struct rkisp1_stat_buffer))\n\t\treturn -EINVAL;\n\n\tvb2_set_plane_payload(vb, 0, sizeof(struct rkisp1_stat_buffer));\n\n\treturn 0;\n}\n\nstatic void rkisp1_stats_vb2_stop_streaming(struct vb2_queue *vq)\n{\n\tstruct rkisp1_stats *stats = vq->drv_priv;\n\tstruct rkisp1_buffer *buf;\n\tunsigned int i;\n\n\tspin_lock_irq(&stats->lock);\n\tfor (i = 0; i < RKISP1_ISP_STATS_REQ_BUFS_MAX; i++) {\n\t\tif (list_empty(&stats->stat))\n\t\t\tbreak;\n\t\tbuf = list_first_entry(&stats->stat,\n\t\t\t\t       struct rkisp1_buffer, queue);\n\t\tlist_del(&buf->queue);\n\t\tvb2_buffer_done(&buf->vb.vb2_buf, VB2_BUF_STATE_ERROR);\n\t}\n\tspin_unlock_irq(&stats->lock);\n}\n\nstatic const struct vb2_ops rkisp1_stats_vb2_ops = {\n\t.queue_setup = rkisp1_stats_vb2_queue_setup,\n\t.buf_queue = rkisp1_stats_vb2_buf_queue,\n\t.buf_prepare = rkisp1_stats_vb2_buf_prepare,\n\t.wait_prepare = vb2_ops_wait_prepare,\n\t.wait_finish = vb2_ops_wait_finish,\n\t.stop_streaming = rkisp1_stats_vb2_stop_streaming,\n};\n\nstatic int\nrkisp1_stats_init_vb2_queue(struct vb2_queue *q, struct rkisp1_stats *stats)\n{\n\tstruct rkisp1_vdev_node *node;\n\n\tnode = container_of(q, struct rkisp1_vdev_node, buf_queue);\n\n\tq->type = V4L2_BUF_TYPE_META_CAPTURE;\n\tq->io_modes = VB2_MMAP | VB2_USERPTR | VB2_DMABUF;\n\tq->drv_priv = stats;\n\tq->ops = &rkisp1_stats_vb2_ops;\n\tq->mem_ops = &vb2_vmalloc_memops;\n\tq->buf_struct_size = sizeof(struct rkisp1_buffer);\n\tq->timestamp_flags = V4L2_BUF_FLAG_TIMESTAMP_MONOTONIC;\n\tq->lock = &node->vlock;\n\n\treturn vb2_queue_init(q);\n}\n\nstatic void rkisp1_stats_get_awb_meas_v10(struct rkisp1_stats *stats,\n\t\t\t\t\t  struct rkisp1_stat_buffer *pbuf)\n{\n\t \n\tstruct rkisp1_device *rkisp1 = stats->rkisp1;\n\tu32 reg_val;\n\n\tpbuf->meas_type |= RKISP1_CIF_ISP_STAT_AWB;\n\treg_val = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AWB_WHITE_CNT_V10);\n\tpbuf->params.awb.awb_mean[0].cnt =\n\t\t\t\tRKISP1_CIF_ISP_AWB_GET_PIXEL_CNT(reg_val);\n\treg_val = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AWB_MEAN_V10);\n\n\tpbuf->params.awb.awb_mean[0].mean_cr_or_r =\n\t\t\t\tRKISP1_CIF_ISP_AWB_GET_MEAN_CR_R(reg_val);\n\tpbuf->params.awb.awb_mean[0].mean_cb_or_b =\n\t\t\t\tRKISP1_CIF_ISP_AWB_GET_MEAN_CB_B(reg_val);\n\tpbuf->params.awb.awb_mean[0].mean_y_or_g =\n\t\t\t\tRKISP1_CIF_ISP_AWB_GET_MEAN_Y_G(reg_val);\n}\n\nstatic void rkisp1_stats_get_awb_meas_v12(struct rkisp1_stats *stats,\n\t\t\t\t\t  struct rkisp1_stat_buffer *pbuf)\n{\n\t \n\tstruct rkisp1_device *rkisp1 = stats->rkisp1;\n\tu32 reg_val;\n\n\tpbuf->meas_type |= RKISP1_CIF_ISP_STAT_AWB;\n\treg_val = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AWB_WHITE_CNT_V12);\n\tpbuf->params.awb.awb_mean[0].cnt =\n\t\t\t\tRKISP1_CIF_ISP_AWB_GET_PIXEL_CNT(reg_val);\n\treg_val = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AWB_MEAN_V12);\n\n\tpbuf->params.awb.awb_mean[0].mean_cr_or_r =\n\t\t\t\tRKISP1_CIF_ISP_AWB_GET_MEAN_CR_R(reg_val);\n\tpbuf->params.awb.awb_mean[0].mean_cb_or_b =\n\t\t\t\tRKISP1_CIF_ISP_AWB_GET_MEAN_CB_B(reg_val);\n\tpbuf->params.awb.awb_mean[0].mean_y_or_g =\n\t\t\t\tRKISP1_CIF_ISP_AWB_GET_MEAN_Y_G(reg_val);\n}\n\nstatic void rkisp1_stats_get_aec_meas_v10(struct rkisp1_stats *stats,\n\t\t\t\t\t  struct rkisp1_stat_buffer *pbuf)\n{\n\tstruct rkisp1_device *rkisp1 = stats->rkisp1;\n\tunsigned int i;\n\n\tpbuf->meas_type |= RKISP1_CIF_ISP_STAT_AUTOEXP;\n\tfor (i = 0; i < RKISP1_CIF_ISP_AE_MEAN_MAX_V10; i++)\n\t\tpbuf->params.ae.exp_mean[i] =\n\t\t\t(u8)rkisp1_read(rkisp1,\n\t\t\t\t\tRKISP1_CIF_ISP_EXP_MEAN_00_V10 + i * 4);\n}\n\nstatic void rkisp1_stats_get_aec_meas_v12(struct rkisp1_stats *stats,\n\t\t\t\t\t  struct rkisp1_stat_buffer *pbuf)\n{\n\tstruct rkisp1_device *rkisp1 = stats->rkisp1;\n\tu32 value;\n\tint i;\n\n\tpbuf->meas_type |= RKISP1_CIF_ISP_STAT_AUTOEXP;\n\tfor (i = 0; i < RKISP1_CIF_ISP_AE_MEAN_MAX_V12 / 4; i++) {\n\t\tvalue = rkisp1_read(rkisp1, RKISP1_CIF_ISP_EXP_MEAN_V12 + i * 4);\n\t\tpbuf->params.ae.exp_mean[4 * i + 0] =\n\t\t\t\tRKISP1_CIF_ISP_EXP_GET_MEAN_xy0_V12(value);\n\t\tpbuf->params.ae.exp_mean[4 * i + 1] =\n\t\t\t\tRKISP1_CIF_ISP_EXP_GET_MEAN_xy1_V12(value);\n\t\tpbuf->params.ae.exp_mean[4 * i + 2] =\n\t\t\t\tRKISP1_CIF_ISP_EXP_GET_MEAN_xy2_V12(value);\n\t\tpbuf->params.ae.exp_mean[4 * i + 3] =\n\t\t\t\tRKISP1_CIF_ISP_EXP_GET_MEAN_xy3_V12(value);\n\t}\n\n\tvalue = rkisp1_read(rkisp1, RKISP1_CIF_ISP_EXP_MEAN_V12 + i * 4);\n\tpbuf->params.ae.exp_mean[4 * i + 0] = RKISP1_CIF_ISP_EXP_GET_MEAN_xy0_V12(value);\n}\n\nstatic void rkisp1_stats_get_afc_meas(struct rkisp1_stats *stats,\n\t\t\t\t      struct rkisp1_stat_buffer *pbuf)\n{\n\tstruct rkisp1_device *rkisp1 = stats->rkisp1;\n\tstruct rkisp1_cif_isp_af_stat *af;\n\n\tpbuf->meas_type |= RKISP1_CIF_ISP_STAT_AFM;\n\n\taf = &pbuf->params.af;\n\taf->window[0].sum = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AFM_SUM_A);\n\taf->window[0].lum = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AFM_LUM_A);\n\taf->window[1].sum = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AFM_SUM_B);\n\taf->window[1].lum = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AFM_LUM_B);\n\taf->window[2].sum = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AFM_SUM_C);\n\taf->window[2].lum = rkisp1_read(rkisp1, RKISP1_CIF_ISP_AFM_LUM_C);\n}\n\nstatic void rkisp1_stats_get_hst_meas_v10(struct rkisp1_stats *stats,\n\t\t\t\t\t  struct rkisp1_stat_buffer *pbuf)\n{\n\tstruct rkisp1_device *rkisp1 = stats->rkisp1;\n\tunsigned int i;\n\n\tpbuf->meas_type |= RKISP1_CIF_ISP_STAT_HIST;\n\tfor (i = 0; i < RKISP1_CIF_ISP_HIST_BIN_N_MAX_V10; i++) {\n\t\tu32 reg_val = rkisp1_read(rkisp1, RKISP1_CIF_ISP_HIST_BIN_0_V10 + i * 4);\n\n\t\tpbuf->params.hist.hist_bins[i] = RKISP1_CIF_ISP_HIST_GET_BIN_V10(reg_val);\n\t}\n}\n\nstatic void rkisp1_stats_get_hst_meas_v12(struct rkisp1_stats *stats,\n\t\t\t\t\t  struct rkisp1_stat_buffer *pbuf)\n{\n\tstruct rkisp1_device *rkisp1 = stats->rkisp1;\n\tu32 value;\n\tint i;\n\n\tpbuf->meas_type |= RKISP1_CIF_ISP_STAT_HIST;\n\tfor (i = 0; i < RKISP1_CIF_ISP_HIST_BIN_N_MAX_V12 / 2; i++) {\n\t\tvalue = rkisp1_read(rkisp1, RKISP1_CIF_ISP_HIST_BIN_V12 + i * 4);\n\t\tpbuf->params.hist.hist_bins[2 * i] =\n\t\t\t\t\tRKISP1_CIF_ISP_HIST_GET_BIN0_V12(value);\n\t\tpbuf->params.hist.hist_bins[2 * i + 1] =\n\t\t\t\t\tRKISP1_CIF_ISP_HIST_GET_BIN1_V12(value);\n\t}\n}\n\nstatic void rkisp1_stats_get_bls_meas(struct rkisp1_stats *stats,\n\t\t\t\t      struct rkisp1_stat_buffer *pbuf)\n{\n\tstruct rkisp1_device *rkisp1 = stats->rkisp1;\n\tconst struct rkisp1_mbus_info *in_fmt = rkisp1->isp.sink_fmt;\n\tstruct rkisp1_cif_isp_bls_meas_val *bls_val;\n\n\tbls_val = &pbuf->params.ae.bls_val;\n\tif (in_fmt->bayer_pat == RKISP1_RAW_BGGR) {\n\t\tbls_val->meas_b =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_A_MEASURED);\n\t\tbls_val->meas_gb =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_B_MEASURED);\n\t\tbls_val->meas_gr =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_C_MEASURED);\n\t\tbls_val->meas_r =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_D_MEASURED);\n\t} else if (in_fmt->bayer_pat == RKISP1_RAW_GBRG) {\n\t\tbls_val->meas_gb =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_A_MEASURED);\n\t\tbls_val->meas_b =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_B_MEASURED);\n\t\tbls_val->meas_r =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_C_MEASURED);\n\t\tbls_val->meas_gr =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_D_MEASURED);\n\t} else if (in_fmt->bayer_pat == RKISP1_RAW_GRBG) {\n\t\tbls_val->meas_gr =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_A_MEASURED);\n\t\tbls_val->meas_r =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_B_MEASURED);\n\t\tbls_val->meas_b =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_C_MEASURED);\n\t\tbls_val->meas_gb =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_D_MEASURED);\n\t} else if (in_fmt->bayer_pat == RKISP1_RAW_RGGB) {\n\t\tbls_val->meas_r =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_A_MEASURED);\n\t\tbls_val->meas_gr =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_B_MEASURED);\n\t\tbls_val->meas_gb =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_C_MEASURED);\n\t\tbls_val->meas_b =\n\t\t\trkisp1_read(rkisp1, RKISP1_CIF_ISP_BLS_D_MEASURED);\n\t}\n}\n\nstatic const struct rkisp1_stats_ops rkisp1_v10_stats_ops = {\n\t.get_awb_meas = rkisp1_stats_get_awb_meas_v10,\n\t.get_aec_meas = rkisp1_stats_get_aec_meas_v10,\n\t.get_hst_meas = rkisp1_stats_get_hst_meas_v10,\n};\n\nstatic struct rkisp1_stats_ops rkisp1_v12_stats_ops = {\n\t.get_awb_meas = rkisp1_stats_get_awb_meas_v12,\n\t.get_aec_meas = rkisp1_stats_get_aec_meas_v12,\n\t.get_hst_meas = rkisp1_stats_get_hst_meas_v12,\n};\n\nstatic void\nrkisp1_stats_send_measurement(struct rkisp1_stats *stats, u32 isp_ris)\n{\n\tstruct rkisp1_stat_buffer *cur_stat_buf;\n\tstruct rkisp1_buffer *cur_buf = NULL;\n\tunsigned int frame_sequence = stats->rkisp1->isp.frame_sequence;\n\tu64 timestamp = ktime_get_ns();\n\n\t \n\tif (!list_empty(&stats->stat)) {\n\t\tcur_buf = list_first_entry(&stats->stat,\n\t\t\t\t\t   struct rkisp1_buffer, queue);\n\t\tlist_del(&cur_buf->queue);\n\t}\n\n\tif (!cur_buf)\n\t\treturn;\n\n\tcur_stat_buf = (struct rkisp1_stat_buffer *)\n\t\t\tvb2_plane_vaddr(&cur_buf->vb.vb2_buf, 0);\n\tif (isp_ris & RKISP1_CIF_ISP_AWB_DONE)\n\t\tstats->ops->get_awb_meas(stats, cur_stat_buf);\n\n\tif (isp_ris & RKISP1_CIF_ISP_AFM_FIN)\n\t\trkisp1_stats_get_afc_meas(stats, cur_stat_buf);\n\n\tif (isp_ris & RKISP1_CIF_ISP_EXP_END) {\n\t\tstats->ops->get_aec_meas(stats, cur_stat_buf);\n\t\trkisp1_stats_get_bls_meas(stats, cur_stat_buf);\n\t}\n\n\tif (isp_ris & RKISP1_CIF_ISP_HIST_MEASURE_RDY)\n\t\tstats->ops->get_hst_meas(stats, cur_stat_buf);\n\n\tvb2_set_plane_payload(&cur_buf->vb.vb2_buf, 0,\n\t\t\t      sizeof(struct rkisp1_stat_buffer));\n\tcur_buf->vb.sequence = frame_sequence;\n\tcur_buf->vb.vb2_buf.timestamp = timestamp;\n\tvb2_buffer_done(&cur_buf->vb.vb2_buf, VB2_BUF_STATE_DONE);\n}\n\nvoid rkisp1_stats_isr(struct rkisp1_stats *stats, u32 isp_ris)\n{\n\tstruct rkisp1_device *rkisp1 = stats->rkisp1;\n\tunsigned int isp_mis_tmp = 0;\n\n\tspin_lock(&stats->lock);\n\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_ICR, RKISP1_STATS_MEAS_MASK);\n\n\tisp_mis_tmp = rkisp1_read(rkisp1, RKISP1_CIF_ISP_MIS);\n\tif (isp_mis_tmp & RKISP1_STATS_MEAS_MASK)\n\t\trkisp1->debug.stats_error++;\n\n\tif (isp_ris & RKISP1_STATS_MEAS_MASK)\n\t\trkisp1_stats_send_measurement(stats, isp_ris);\n\n\tspin_unlock(&stats->lock);\n}\n\nstatic void rkisp1_init_stats(struct rkisp1_stats *stats)\n{\n\tstats->vdev_fmt.fmt.meta.dataformat =\n\t\tV4L2_META_FMT_RK_ISP1_STAT_3A;\n\tstats->vdev_fmt.fmt.meta.buffersize =\n\t\tsizeof(struct rkisp1_stat_buffer);\n\n\tif (stats->rkisp1->info->isp_ver == RKISP1_V12)\n\t\tstats->ops = &rkisp1_v12_stats_ops;\n\telse\n\t\tstats->ops = &rkisp1_v10_stats_ops;\n}\n\nint rkisp1_stats_register(struct rkisp1_device *rkisp1)\n{\n\tstruct rkisp1_stats *stats = &rkisp1->stats;\n\tstruct rkisp1_vdev_node *node = &stats->vnode;\n\tstruct video_device *vdev = &node->vdev;\n\tint ret;\n\n\tstats->rkisp1 = rkisp1;\n\tmutex_init(&node->vlock);\n\tINIT_LIST_HEAD(&stats->stat);\n\tspin_lock_init(&stats->lock);\n\n\tstrscpy(vdev->name, RKISP1_STATS_DEV_NAME, sizeof(vdev->name));\n\n\tvideo_set_drvdata(vdev, stats);\n\tvdev->ioctl_ops = &rkisp1_stats_ioctl;\n\tvdev->fops = &rkisp1_stats_fops;\n\tvdev->release = video_device_release_empty;\n\tvdev->lock = &node->vlock;\n\tvdev->v4l2_dev = &rkisp1->v4l2_dev;\n\tvdev->queue = &node->buf_queue;\n\tvdev->device_caps = V4L2_CAP_META_CAPTURE | V4L2_CAP_STREAMING;\n\tvdev->vfl_dir =  VFL_DIR_RX;\n\trkisp1_stats_init_vb2_queue(vdev->queue, stats);\n\trkisp1_init_stats(stats);\n\tvideo_set_drvdata(vdev, stats);\n\n\tnode->pad.flags = MEDIA_PAD_FL_SINK;\n\tret = media_entity_pads_init(&vdev->entity, 1, &node->pad);\n\tif (ret)\n\t\tgoto error;\n\n\tret = video_register_device(vdev, VFL_TYPE_VIDEO, -1);\n\tif (ret) {\n\t\tdev_err(&vdev->dev,\n\t\t\t\"failed to register %s, ret=%d\\n\", vdev->name, ret);\n\t\tgoto error;\n\t}\n\n\treturn 0;\n\nerror:\n\tmedia_entity_cleanup(&vdev->entity);\n\tmutex_destroy(&node->vlock);\n\tstats->rkisp1 = NULL;\n\treturn ret;\n}\n\nvoid rkisp1_stats_unregister(struct rkisp1_device *rkisp1)\n{\n\tstruct rkisp1_stats *stats = &rkisp1->stats;\n\tstruct rkisp1_vdev_node *node = &stats->vnode;\n\tstruct video_device *vdev = &node->vdev;\n\n\tif (!stats->rkisp1)\n\t\treturn;\n\n\tvb2_video_unregister_device(vdev);\n\tmedia_entity_cleanup(&vdev->entity);\n\tmutex_destroy(&node->vlock);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}