{
  "module_name": "rkisp1-params.c",
  "hash_id": "7aedcbf741bf43f810898bad03eae6d8f59e792bdf051d22c6b9bc027d8e4401",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/rockchip/rkisp1/rkisp1-params.c",
  "human_readable_source": "\n \n\n#include <media/v4l2-common.h>\n#include <media/v4l2-event.h>\n#include <media/v4l2-ioctl.h>\n#include <media/videobuf2-core.h>\n#include <media/videobuf2-vmalloc.h>\t \n\n#include \"rkisp1-common.h\"\n\n#define RKISP1_PARAMS_DEV_NAME\tRKISP1_DRIVER_NAME \"_params\"\n\n#define RKISP1_ISP_PARAMS_REQ_BUFS_MIN\t2\n#define RKISP1_ISP_PARAMS_REQ_BUFS_MAX\t8\n\n#define RKISP1_ISP_DPCC_METHODS_SET(n) \\\n\t\t\t(RKISP1_CIF_ISP_DPCC_METHODS_SET_1 + 0x4 * (n))\n#define RKISP1_ISP_DPCC_LINE_THRESH(n) \\\n\t\t\t(RKISP1_CIF_ISP_DPCC_LINE_THRESH_1 + 0x14 * (n))\n#define RKISP1_ISP_DPCC_LINE_MAD_FAC(n) \\\n\t\t\t(RKISP1_CIF_ISP_DPCC_LINE_MAD_FAC_1 + 0x14 * (n))\n#define RKISP1_ISP_DPCC_PG_FAC(n) \\\n\t\t\t(RKISP1_CIF_ISP_DPCC_PG_FAC_1 + 0x14 * (n))\n#define RKISP1_ISP_DPCC_RND_THRESH(n) \\\n\t\t\t(RKISP1_CIF_ISP_DPCC_RND_THRESH_1 + 0x14 * (n))\n#define RKISP1_ISP_DPCC_RG_FAC(n) \\\n\t\t\t(RKISP1_CIF_ISP_DPCC_RG_FAC_1 + 0x14 * (n))\n#define RKISP1_ISP_CC_COEFF(n) \\\n\t\t\t(RKISP1_CIF_ISP_CC_COEFF_0 + (n) * 4)\n\nstatic inline void\nrkisp1_param_set_bits(struct rkisp1_params *params, u32 reg, u32 bit_mask)\n{\n\tu32 val;\n\n\tval = rkisp1_read(params->rkisp1, reg);\n\trkisp1_write(params->rkisp1, reg, val | bit_mask);\n}\n\nstatic inline void\nrkisp1_param_clear_bits(struct rkisp1_params *params, u32 reg, u32 bit_mask)\n{\n\tu32 val;\n\n\tval = rkisp1_read(params->rkisp1, reg);\n\trkisp1_write(params->rkisp1, reg, val & ~bit_mask);\n}\n\n \nstatic void rkisp1_dpcc_config(struct rkisp1_params *params,\n\t\t\t       const struct rkisp1_cif_isp_dpcc_config *arg)\n{\n\tunsigned int i;\n\tu32 mode;\n\n\t \n\tmode = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_DPCC_MODE);\n\tmode &= RKISP1_CIF_ISP_DPCC_MODE_DPCC_ENABLE;\n\tmode |= arg->mode & RKISP1_CIF_ISP_DPCC_MODE_STAGE1_ENABLE;\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPCC_MODE, mode);\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPCC_OUTPUT_MODE,\n\t\t     arg->output_mode & RKISP1_CIF_ISP_DPCC_OUTPUT_MODE_MASK);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPCC_SET_USE,\n\t\t     arg->set_use & RKISP1_CIF_ISP_DPCC_SET_USE_MASK);\n\n\tfor (i = 0; i < RKISP1_CIF_ISP_DPCC_METHODS_MAX; i++) {\n\t\trkisp1_write(params->rkisp1, RKISP1_ISP_DPCC_METHODS_SET(i),\n\t\t\t     arg->methods[i].method &\n\t\t\t     RKISP1_CIF_ISP_DPCC_METHODS_SET_MASK);\n\t\trkisp1_write(params->rkisp1, RKISP1_ISP_DPCC_LINE_THRESH(i),\n\t\t\t     arg->methods[i].line_thresh &\n\t\t\t     RKISP1_CIF_ISP_DPCC_LINE_THRESH_MASK);\n\t\trkisp1_write(params->rkisp1, RKISP1_ISP_DPCC_LINE_MAD_FAC(i),\n\t\t\t     arg->methods[i].line_mad_fac &\n\t\t\t     RKISP1_CIF_ISP_DPCC_LINE_MAD_FAC_MASK);\n\t\trkisp1_write(params->rkisp1, RKISP1_ISP_DPCC_PG_FAC(i),\n\t\t\t     arg->methods[i].pg_fac &\n\t\t\t     RKISP1_CIF_ISP_DPCC_PG_FAC_MASK);\n\t\trkisp1_write(params->rkisp1, RKISP1_ISP_DPCC_RND_THRESH(i),\n\t\t\t     arg->methods[i].rnd_thresh &\n\t\t\t     RKISP1_CIF_ISP_DPCC_RND_THRESH_MASK);\n\t\trkisp1_write(params->rkisp1, RKISP1_ISP_DPCC_RG_FAC(i),\n\t\t\t     arg->methods[i].rg_fac &\n\t\t\t     RKISP1_CIF_ISP_DPCC_RG_FAC_MASK);\n\t}\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPCC_RND_OFFS,\n\t\t     arg->rnd_offs & RKISP1_CIF_ISP_DPCC_RND_OFFS_MASK);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPCC_RO_LIMITS,\n\t\t     arg->ro_limits & RKISP1_CIF_ISP_DPCC_RO_LIMIT_MASK);\n}\n\n \nstatic void rkisp1_bls_config(struct rkisp1_params *params,\n\t\t\t      const struct rkisp1_cif_isp_bls_config *arg)\n{\n\t \n\tu32 new_control;\n\n\tnew_control = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_BLS_CTRL);\n\tnew_control &= RKISP1_CIF_ISP_BLS_ENA;\n\t \n\tif (!arg->enable_auto) {\n\t\tconst struct rkisp1_cif_isp_bls_fixed_val *pval =\n\t\t\t\t\t\t\t\t&arg->fixed_val;\n\n\t\tswitch (params->raw_type) {\n\t\tcase RKISP1_RAW_BGGR:\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_D_FIXED,\n\t\t\t\t     pval->r);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_C_FIXED,\n\t\t\t\t     pval->gr);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_B_FIXED,\n\t\t\t\t     pval->gb);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_A_FIXED,\n\t\t\t\t     pval->b);\n\t\t\tbreak;\n\t\tcase RKISP1_RAW_GBRG:\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_C_FIXED,\n\t\t\t\t     pval->r);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_D_FIXED,\n\t\t\t\t     pval->gr);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_A_FIXED,\n\t\t\t\t     pval->gb);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_B_FIXED,\n\t\t\t\t     pval->b);\n\t\t\tbreak;\n\t\tcase RKISP1_RAW_GRBG:\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_B_FIXED,\n\t\t\t\t     pval->r);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_A_FIXED,\n\t\t\t\t     pval->gr);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_D_FIXED,\n\t\t\t\t     pval->gb);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_C_FIXED,\n\t\t\t\t     pval->b);\n\t\t\tbreak;\n\t\tcase RKISP1_RAW_RGGB:\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_A_FIXED,\n\t\t\t\t     pval->r);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_B_FIXED,\n\t\t\t\t     pval->gr);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_C_FIXED,\n\t\t\t\t     pval->gb);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_D_FIXED,\n\t\t\t\t     pval->b);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t} else {\n\t\tif (arg->en_windows & BIT(1)) {\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_H2_START,\n\t\t\t\t     arg->bls_window2.h_offs);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_H2_STOP,\n\t\t\t\t     arg->bls_window2.h_size);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_V2_START,\n\t\t\t\t     arg->bls_window2.v_offs);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_V2_STOP,\n\t\t\t\t     arg->bls_window2.v_size);\n\t\t\tnew_control |= RKISP1_CIF_ISP_BLS_WINDOW_2;\n\t\t}\n\n\t\tif (arg->en_windows & BIT(0)) {\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_H1_START,\n\t\t\t\t     arg->bls_window1.h_offs);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_H1_STOP,\n\t\t\t\t     arg->bls_window1.h_size);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_V1_START,\n\t\t\t\t     arg->bls_window1.v_offs);\n\t\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_V1_STOP,\n\t\t\t\t     arg->bls_window1.v_size);\n\t\t\tnew_control |= RKISP1_CIF_ISP_BLS_WINDOW_1;\n\t\t}\n\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_SAMPLES,\n\t\t\t     arg->bls_samples);\n\n\t\tnew_control |= RKISP1_CIF_ISP_BLS_MODE_MEASURED;\n\t}\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_BLS_CTRL, new_control);\n}\n\n \nstatic void\nrkisp1_lsc_matrix_config_v10(struct rkisp1_params *params,\n\t\t\t     const struct rkisp1_cif_isp_lsc_config *pconfig)\n{\n\tstruct rkisp1_device *rkisp1 = params->rkisp1;\n\tu32 lsc_status, sram_addr, lsc_table_sel;\n\tunsigned int i, j;\n\n\tlsc_status = rkisp1_read(rkisp1, RKISP1_CIF_ISP_LSC_STATUS);\n\n\t \n\tsram_addr = lsc_status & RKISP1_CIF_ISP_LSC_ACTIVE_TABLE ?\n\t\t    RKISP1_CIF_ISP_LSC_TABLE_ADDRESS_0 :\n\t\t    RKISP1_CIF_ISP_LSC_TABLE_ADDRESS_153;\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_R_TABLE_ADDR, sram_addr);\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GR_TABLE_ADDR, sram_addr);\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GB_TABLE_ADDR, sram_addr);\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_B_TABLE_ADDR, sram_addr);\n\n\t \n\tfor (i = 0; i < RKISP1_CIF_ISP_LSC_SAMPLES_MAX; i++) {\n\t\tconst __u16 *r_tbl = pconfig->r_data_tbl[i];\n\t\tconst __u16 *gr_tbl = pconfig->gr_data_tbl[i];\n\t\tconst __u16 *gb_tbl = pconfig->gb_data_tbl[i];\n\t\tconst __u16 *b_tbl = pconfig->b_data_tbl[i];\n\n\t\t \n\t\tfor (j = 0; j < RKISP1_CIF_ISP_LSC_SAMPLES_MAX - 1; j += 2) {\n\t\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_R_TABLE_DATA,\n\t\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V10(\n\t\t\t\t\tr_tbl[j], r_tbl[j + 1]));\n\t\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GR_TABLE_DATA,\n\t\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V10(\n\t\t\t\t\tgr_tbl[j], gr_tbl[j + 1]));\n\t\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GB_TABLE_DATA,\n\t\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V10(\n\t\t\t\t\tgb_tbl[j], gb_tbl[j + 1]));\n\t\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_B_TABLE_DATA,\n\t\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V10(\n\t\t\t\t\tb_tbl[j], b_tbl[j + 1]));\n\t\t}\n\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_R_TABLE_DATA,\n\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V10(r_tbl[j], 0));\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GR_TABLE_DATA,\n\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V10(gr_tbl[j], 0));\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GB_TABLE_DATA,\n\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V10(gb_tbl[j], 0));\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_B_TABLE_DATA,\n\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V10(b_tbl[j], 0));\n\t}\n\n\tlsc_table_sel = lsc_status & RKISP1_CIF_ISP_LSC_ACTIVE_TABLE ?\n\t\t\tRKISP1_CIF_ISP_LSC_TABLE_0 : RKISP1_CIF_ISP_LSC_TABLE_1;\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_TABLE_SEL, lsc_table_sel);\n}\n\nstatic void\nrkisp1_lsc_matrix_config_v12(struct rkisp1_params *params,\n\t\t\t     const struct rkisp1_cif_isp_lsc_config *pconfig)\n{\n\tstruct rkisp1_device *rkisp1 = params->rkisp1;\n\tu32 lsc_status, sram_addr, lsc_table_sel;\n\tunsigned int i, j;\n\n\tlsc_status = rkisp1_read(rkisp1, RKISP1_CIF_ISP_LSC_STATUS);\n\n\t \n\tsram_addr = lsc_status & RKISP1_CIF_ISP_LSC_ACTIVE_TABLE ?\n\t\t    RKISP1_CIF_ISP_LSC_TABLE_ADDRESS_0 :\n\t\t    RKISP1_CIF_ISP_LSC_TABLE_ADDRESS_153;\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_R_TABLE_ADDR, sram_addr);\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GR_TABLE_ADDR, sram_addr);\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GB_TABLE_ADDR, sram_addr);\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_B_TABLE_ADDR, sram_addr);\n\n\t \n\tfor (i = 0; i < RKISP1_CIF_ISP_LSC_SAMPLES_MAX; i++) {\n\t\tconst __u16 *r_tbl = pconfig->r_data_tbl[i];\n\t\tconst __u16 *gr_tbl = pconfig->gr_data_tbl[i];\n\t\tconst __u16 *gb_tbl = pconfig->gb_data_tbl[i];\n\t\tconst __u16 *b_tbl = pconfig->b_data_tbl[i];\n\n\t\t \n\t\tfor (j = 0; j < RKISP1_CIF_ISP_LSC_SAMPLES_MAX - 1; j += 2) {\n\t\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_R_TABLE_DATA,\n\t\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V12(\n\t\t\t\t\tr_tbl[j], r_tbl[j + 1]));\n\t\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GR_TABLE_DATA,\n\t\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V12(\n\t\t\t\t\tgr_tbl[j], gr_tbl[j + 1]));\n\t\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GB_TABLE_DATA,\n\t\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V12(\n\t\t\t\t\tgb_tbl[j], gb_tbl[j + 1]));\n\t\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_B_TABLE_DATA,\n\t\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V12(\n\t\t\t\t\tb_tbl[j], b_tbl[j + 1]));\n\t\t}\n\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_R_TABLE_DATA,\n\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V12(r_tbl[j], 0));\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GR_TABLE_DATA,\n\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V12(gr_tbl[j], 0));\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_GB_TABLE_DATA,\n\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V12(gb_tbl[j], 0));\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_B_TABLE_DATA,\n\t\t\t     RKISP1_CIF_ISP_LSC_TABLE_DATA_V12(b_tbl[j], 0));\n\t}\n\n\tlsc_table_sel = lsc_status & RKISP1_CIF_ISP_LSC_ACTIVE_TABLE ?\n\t\t\tRKISP1_CIF_ISP_LSC_TABLE_0 : RKISP1_CIF_ISP_LSC_TABLE_1;\n\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_TABLE_SEL, lsc_table_sel);\n}\n\nstatic void rkisp1_lsc_config(struct rkisp1_params *params,\n\t\t\t      const struct rkisp1_cif_isp_lsc_config *arg)\n{\n\tstruct rkisp1_device *rkisp1 = params->rkisp1;\n\tu32 lsc_ctrl, data;\n\tunsigned int i;\n\n\t \n\tlsc_ctrl = rkisp1_read(rkisp1, RKISP1_CIF_ISP_LSC_CTRL);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_LSC_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_LSC_CTRL_ENA);\n\tparams->ops->lsc_matrix_config(params, arg);\n\n\tfor (i = 0; i < RKISP1_CIF_ISP_LSC_SECTORS_TBL_SIZE / 2; i++) {\n\t\t \n\t\tdata = RKISP1_CIF_ISP_LSC_SECT_SIZE(arg->x_size_tbl[i * 2],\n\t\t\t\t\t\t    arg->x_size_tbl[i * 2 + 1]);\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_XSIZE(i), data);\n\n\t\t \n\t\tdata = RKISP1_CIF_ISP_LSC_SECT_GRAD(arg->x_grad_tbl[i * 2],\n\t\t\t\t\t\t    arg->x_grad_tbl[i * 2 + 1]);\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_XGRAD(i), data);\n\n\t\t \n\t\tdata = RKISP1_CIF_ISP_LSC_SECT_SIZE(arg->y_size_tbl[i * 2],\n\t\t\t\t\t\t    arg->y_size_tbl[i * 2 + 1]);\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_YSIZE(i), data);\n\n\t\t \n\t\tdata = RKISP1_CIF_ISP_LSC_SECT_GRAD(arg->y_grad_tbl[i * 2],\n\t\t\t\t\t\t    arg->y_grad_tbl[i * 2 + 1]);\n\t\trkisp1_write(rkisp1, RKISP1_CIF_ISP_LSC_YGRAD(i), data);\n\t}\n\n\t \n\tif (lsc_ctrl & RKISP1_CIF_ISP_LSC_CTRL_ENA)\n\t\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_LSC_CTRL,\n\t\t\t\t      RKISP1_CIF_ISP_LSC_CTRL_ENA);\n\telse\n\t\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_LSC_CTRL,\n\t\t\t\t\tRKISP1_CIF_ISP_LSC_CTRL_ENA);\n}\n\n \nstatic void rkisp1_flt_config(struct rkisp1_params *params,\n\t\t\t      const struct rkisp1_cif_isp_flt_config *arg)\n{\n\tu32 filt_mode;\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_THRESH_BL0,\n\t\t     arg->thresh_bl0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_THRESH_BL1,\n\t\t     arg->thresh_bl1);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_THRESH_SH0,\n\t\t     arg->thresh_sh0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_THRESH_SH1,\n\t\t     arg->thresh_sh1);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_FAC_BL0,\n\t\t     arg->fac_bl0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_FAC_BL1,\n\t\t     arg->fac_bl1);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_FAC_MID,\n\t\t     arg->fac_mid);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_FAC_SH0,\n\t\t     arg->fac_sh0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_FAC_SH1,\n\t\t     arg->fac_sh1);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_LUM_WEIGHT,\n\t\t     arg->lum_weight);\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_MODE,\n\t\t     (arg->mode ? RKISP1_CIF_ISP_FLT_MODE_DNR : 0) |\n\t\t     RKISP1_CIF_ISP_FLT_CHROMA_V_MODE(arg->chr_v_mode) |\n\t\t     RKISP1_CIF_ISP_FLT_CHROMA_H_MODE(arg->chr_h_mode) |\n\t\t     RKISP1_CIF_ISP_FLT_GREEN_STAGE1(arg->grn_stage1));\n\n\t \n\tfilt_mode = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_FILT_MODE);\n\tfilt_mode &= RKISP1_CIF_ISP_FLT_ENA;\n\tif (arg->mode)\n\t\tfilt_mode |= RKISP1_CIF_ISP_FLT_MODE_DNR;\n\tfilt_mode |= RKISP1_CIF_ISP_FLT_CHROMA_V_MODE(arg->chr_v_mode) |\n\t\t     RKISP1_CIF_ISP_FLT_CHROMA_H_MODE(arg->chr_h_mode) |\n\t\t     RKISP1_CIF_ISP_FLT_GREEN_STAGE1(arg->grn_stage1);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_FILT_MODE, filt_mode);\n}\n\n \nstatic int rkisp1_bdm_config(struct rkisp1_params *params,\n\t\t\t     const struct rkisp1_cif_isp_bdm_config *arg)\n{\n\tu32 bdm_th;\n\n\t \n\tbdm_th = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_DEMOSAIC);\n\tbdm_th &= RKISP1_CIF_ISP_DEMOSAIC_BYPASS;\n\tbdm_th |= arg->demosaic_th & ~RKISP1_CIF_ISP_DEMOSAIC_BYPASS;\n\t \n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DEMOSAIC, bdm_th);\n\treturn 0;\n}\n\n \nstatic void rkisp1_sdg_config(struct rkisp1_params *params,\n\t\t\t      const struct rkisp1_cif_isp_sdg_config *arg)\n{\n\tunsigned int i;\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_GAMMA_DX_LO,\n\t\t     arg->xa_pnts.gamma_dx0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_GAMMA_DX_HI,\n\t\t     arg->xa_pnts.gamma_dx1);\n\n\tfor (i = 0; i < RKISP1_CIF_ISP_DEGAMMA_CURVE_SIZE; i++) {\n\t\trkisp1_write(params->rkisp1,\n\t\t\t     RKISP1_CIF_ISP_GAMMA_R_Y0 + i * 4,\n\t\t\t     arg->curve_r.gamma_y[i]);\n\t\trkisp1_write(params->rkisp1,\n\t\t\t     RKISP1_CIF_ISP_GAMMA_G_Y0 + i * 4,\n\t\t\t     arg->curve_g.gamma_y[i]);\n\t\trkisp1_write(params->rkisp1,\n\t\t\t     RKISP1_CIF_ISP_GAMMA_B_Y0 + i * 4,\n\t\t\t     arg->curve_b.gamma_y[i]);\n\t}\n}\n\n \nstatic void rkisp1_goc_config_v10(struct rkisp1_params *params,\n\t\t\t\t  const struct rkisp1_cif_isp_goc_config *arg)\n{\n\tunsigned int i;\n\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_GAMMA_OUT_ENA);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_GAMMA_OUT_MODE_V10,\n\t\t     arg->mode);\n\n\tfor (i = 0; i < RKISP1_CIF_ISP_GAMMA_OUT_MAX_SAMPLES_V10; i++)\n\t\trkisp1_write(params->rkisp1,\n\t\t\t     RKISP1_CIF_ISP_GAMMA_OUT_Y_0_V10 + i * 4,\n\t\t\t     arg->gamma_y[i]);\n}\n\nstatic void rkisp1_goc_config_v12(struct rkisp1_params *params,\n\t\t\t\t  const struct rkisp1_cif_isp_goc_config *arg)\n{\n\tunsigned int i;\n\tu32 value;\n\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_GAMMA_OUT_ENA);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_GAMMA_OUT_MODE_V12,\n\t\t     arg->mode);\n\n\tfor (i = 0; i < RKISP1_CIF_ISP_GAMMA_OUT_MAX_SAMPLES_V12 / 2; i++) {\n\t\tvalue = RKISP1_CIF_ISP_GAMMA_VALUE_V12(\n\t\t\targ->gamma_y[2 * i + 1],\n\t\t\targ->gamma_y[2 * i]);\n\t\trkisp1_write(params->rkisp1,\n\t\t\t     RKISP1_CIF_ISP_GAMMA_OUT_Y_0_V12 + i * 4, value);\n\t}\n}\n\n \nstatic void rkisp1_ctk_config(struct rkisp1_params *params,\n\t\t\t      const struct rkisp1_cif_isp_ctk_config *arg)\n{\n\tunsigned int i, j, k = 0;\n\n\tfor (i = 0; i < 3; i++)\n\t\tfor (j = 0; j < 3; j++)\n\t\t\trkisp1_write(params->rkisp1,\n\t\t\t\t     RKISP1_CIF_ISP_CT_COEFF_0 + 4 * k++,\n\t\t\t\t     arg->coeff[i][j]);\n\tfor (i = 0; i < 3; i++)\n\t\trkisp1_write(params->rkisp1,\n\t\t\t     RKISP1_CIF_ISP_CT_OFFSET_R + i * 4,\n\t\t\t     arg->ct_offset[i]);\n}\n\nstatic void rkisp1_ctk_enable(struct rkisp1_params *params, bool en)\n{\n\tif (en)\n\t\treturn;\n\n\t \n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_COEFF_0, 0x80);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_COEFF_1, 0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_COEFF_2, 0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_COEFF_3, 0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_COEFF_4, 0x80);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_COEFF_5, 0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_COEFF_6, 0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_COEFF_7, 0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_COEFF_8, 0x80);\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_OFFSET_R, 0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_OFFSET_G, 0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CT_OFFSET_B, 0);\n}\n\n \nstatic void rkisp1_awb_meas_config_v10(struct rkisp1_params *params,\n\t\t\t\t       const struct rkisp1_cif_isp_awb_meas_config *arg)\n{\n\tu32 reg_val = 0;\n\t \n\tif (arg->awb_mode == RKISP1_CIF_ISP_AWB_MODE_YCBCR) {\n\t\t \n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_REF_V10,\n\t\t\t     RKISP1_CIF_ISP_AWB_REF_CR_SET(arg->awb_ref_cr) |\n\t\t\t     arg->awb_ref_cb);\n\t\t \n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_THRESH_V10,\n\t\t\t     RKISP1_CIF_ISP_AWB_MAX_Y_SET(arg->max_y) |\n\t\t\t     RKISP1_CIF_ISP_AWB_MIN_Y_SET(arg->min_y) |\n\t\t\t     RKISP1_CIF_ISP_AWB_MAX_CS_SET(arg->max_csum) |\n\t\t\t     arg->min_c);\n\t}\n\n\treg_val = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V10);\n\tif (arg->enable_ymax_cmp)\n\t\treg_val |= RKISP1_CIF_ISP_AWB_YMAX_CMP_EN;\n\telse\n\t\treg_val &= ~RKISP1_CIF_ISP_AWB_YMAX_CMP_EN;\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V10, reg_val);\n\n\t \n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_WND_V_OFFS_V10,\n\t\t     arg->awb_wnd.v_offs);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_WND_H_OFFS_V10,\n\t\t     arg->awb_wnd.h_offs);\n\t \n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_WND_V_SIZE_V10,\n\t\t     arg->awb_wnd.v_size);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_WND_H_SIZE_V10,\n\t\t     arg->awb_wnd.h_size);\n\t \n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_FRAMES_V10,\n\t\t     arg->frames);\n}\n\nstatic void rkisp1_awb_meas_config_v12(struct rkisp1_params *params,\n\t\t\t\t       const struct rkisp1_cif_isp_awb_meas_config *arg)\n{\n\tu32 reg_val = 0;\n\t \n\tif (arg->awb_mode == RKISP1_CIF_ISP_AWB_MODE_YCBCR) {\n\t\t \n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_REF_V12,\n\t\t\t     RKISP1_CIF_ISP_AWB_REF_CR_SET(arg->awb_ref_cr) |\n\t\t\t     arg->awb_ref_cb);\n\t\t \n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_THRESH_V12,\n\t\t\t     RKISP1_CIF_ISP_AWB_MAX_Y_SET(arg->max_y) |\n\t\t\t     RKISP1_CIF_ISP_AWB_MIN_Y_SET(arg->min_y) |\n\t\t\t     RKISP1_CIF_ISP_AWB_MAX_CS_SET(arg->max_csum) |\n\t\t\t     arg->min_c);\n\t}\n\n\treg_val = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V12);\n\tif (arg->enable_ymax_cmp)\n\t\treg_val |= RKISP1_CIF_ISP_AWB_YMAX_CMP_EN;\n\telse\n\t\treg_val &= ~RKISP1_CIF_ISP_AWB_YMAX_CMP_EN;\n\treg_val &= ~RKISP1_CIF_ISP_AWB_SET_FRAMES_MASK_V12;\n\treg_val |= RKISP1_CIF_ISP_AWB_SET_FRAMES_V12(arg->frames);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V12, reg_val);\n\n\t \n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_OFFS_V12,\n\t\t     arg->awb_wnd.v_offs << 16 | arg->awb_wnd.h_offs);\n\t \n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_SIZE_V12,\n\t\t     arg->awb_wnd.v_size << 16 | arg->awb_wnd.h_size);\n}\n\nstatic void\nrkisp1_awb_meas_enable_v10(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_awb_meas_config *arg,\n\t\t\t   bool en)\n{\n\tu32 reg_val = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V10);\n\n\t \n\treg_val &= RKISP1_CIF_ISP_AWB_MODE_MASK_NONE;\n\n\tif (en) {\n\t\tif (arg->awb_mode == RKISP1_CIF_ISP_AWB_MODE_RGB)\n\t\t\treg_val |= RKISP1_CIF_ISP_AWB_MODE_RGB_EN;\n\t\telse\n\t\t\treg_val |= RKISP1_CIF_ISP_AWB_MODE_YCBCR_EN;\n\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V10,\n\t\t\t     reg_val);\n\n\t\t \n\t\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_AWB_ENA);\n\t} else {\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V10,\n\t\t\t     reg_val);\n\t\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_AWB_ENA);\n\t}\n}\n\nstatic void\nrkisp1_awb_meas_enable_v12(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_awb_meas_config *arg,\n\t\t\t   bool en)\n{\n\tu32 reg_val = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V12);\n\n\t \n\treg_val &= RKISP1_CIF_ISP_AWB_MODE_MASK_NONE;\n\n\tif (en) {\n\t\tif (arg->awb_mode == RKISP1_CIF_ISP_AWB_MODE_RGB)\n\t\t\treg_val |= RKISP1_CIF_ISP_AWB_MODE_RGB_EN;\n\t\telse\n\t\t\treg_val |= RKISP1_CIF_ISP_AWB_MODE_YCBCR_EN;\n\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V12,\n\t\t\t     reg_val);\n\n\t\t \n\t\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_AWB_ENA);\n\t} else {\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_PROP_V12,\n\t\t\t     reg_val);\n\t\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_AWB_ENA);\n\t}\n}\n\nstatic void\nrkisp1_awb_gain_config_v10(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_awb_gain_config *arg)\n{\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_GAIN_G_V10,\n\t\t     RKISP1_CIF_ISP_AWB_GAIN_R_SET(arg->gain_green_r) |\n\t\t     arg->gain_green_b);\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_GAIN_RB_V10,\n\t\t     RKISP1_CIF_ISP_AWB_GAIN_R_SET(arg->gain_red) |\n\t\t     arg->gain_blue);\n}\n\nstatic void\nrkisp1_awb_gain_config_v12(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_awb_gain_config *arg)\n{\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_GAIN_G_V12,\n\t\t     RKISP1_CIF_ISP_AWB_GAIN_R_SET(arg->gain_green_r) |\n\t\t     arg->gain_green_b);\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AWB_GAIN_RB_V12,\n\t\t     RKISP1_CIF_ISP_AWB_GAIN_R_SET(arg->gain_red) |\n\t\t     arg->gain_blue);\n}\n\nstatic void rkisp1_aec_config_v10(struct rkisp1_params *params,\n\t\t\t\t  const struct rkisp1_cif_isp_aec_config *arg)\n{\n\tunsigned int block_hsize, block_vsize;\n\tu32 exp_ctrl;\n\n\t \n\texp_ctrl = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_EXP_CTRL);\n\texp_ctrl &= RKISP1_CIF_ISP_EXP_ENA;\n\tif (arg->autostop)\n\t\texp_ctrl |= RKISP1_CIF_ISP_EXP_CTRL_AUTOSTOP;\n\tif (arg->mode == RKISP1_CIF_ISP_EXP_MEASURING_MODE_1)\n\t\texp_ctrl |= RKISP1_CIF_ISP_EXP_CTRL_MEASMODE_1;\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_EXP_CTRL, exp_ctrl);\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_EXP_H_OFFSET_V10,\n\t\t     arg->meas_window.h_offs);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_EXP_V_OFFSET_V10,\n\t\t     arg->meas_window.v_offs);\n\n\tblock_hsize = arg->meas_window.h_size /\n\t\t      RKISP1_CIF_ISP_EXP_COLUMN_NUM_V10 - 1;\n\tblock_vsize = arg->meas_window.v_size /\n\t\t      RKISP1_CIF_ISP_EXP_ROW_NUM_V10 - 1;\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_EXP_H_SIZE_V10,\n\t\t     RKISP1_CIF_ISP_EXP_H_SIZE_SET_V10(block_hsize));\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_EXP_V_SIZE_V10,\n\t\t     RKISP1_CIF_ISP_EXP_V_SIZE_SET_V10(block_vsize));\n}\n\nstatic void rkisp1_aec_config_v12(struct rkisp1_params *params,\n\t\t\t       const struct rkisp1_cif_isp_aec_config *arg)\n{\n\tu32 exp_ctrl;\n\tu32 block_hsize, block_vsize;\n\tu32 wnd_num_idx = 1;\n\tstatic const u32 ae_wnd_num[] = { 5, 9, 15, 15 };\n\n\t \n\texp_ctrl = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_EXP_CTRL);\n\texp_ctrl &= RKISP1_CIF_ISP_EXP_ENA;\n\tif (arg->autostop)\n\t\texp_ctrl |= RKISP1_CIF_ISP_EXP_CTRL_AUTOSTOP;\n\tif (arg->mode == RKISP1_CIF_ISP_EXP_MEASURING_MODE_1)\n\t\texp_ctrl |= RKISP1_CIF_ISP_EXP_CTRL_MEASMODE_1;\n\texp_ctrl |= RKISP1_CIF_ISP_EXP_CTRL_WNDNUM_SET_V12(wnd_num_idx);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_EXP_CTRL, exp_ctrl);\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_EXP_OFFS_V12,\n\t\t     RKISP1_CIF_ISP_EXP_V_OFFSET_SET_V12(arg->meas_window.v_offs) |\n\t\t     RKISP1_CIF_ISP_EXP_H_OFFSET_SET_V12(arg->meas_window.h_offs));\n\n\tblock_hsize = arg->meas_window.h_size / ae_wnd_num[wnd_num_idx] - 1;\n\tblock_vsize = arg->meas_window.v_size / ae_wnd_num[wnd_num_idx] - 1;\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_EXP_SIZE_V12,\n\t\t     RKISP1_CIF_ISP_EXP_V_SIZE_SET_V12(block_vsize) |\n\t\t     RKISP1_CIF_ISP_EXP_H_SIZE_SET_V12(block_hsize));\n}\n\nstatic void rkisp1_cproc_config(struct rkisp1_params *params,\n\t\t\t\tconst struct rkisp1_cif_isp_cproc_config *arg)\n{\n\tstruct rkisp1_cif_isp_isp_other_cfg *cur_other_cfg =\n\t\tcontainer_of(arg, struct rkisp1_cif_isp_isp_other_cfg, cproc_config);\n\tstruct rkisp1_cif_isp_ie_config *cur_ie_config =\n\t\t\t\t\t\t&cur_other_cfg->ie_config;\n\tu32 effect = cur_ie_config->effect;\n\tu32 quantization = params->quantization;\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_C_PROC_CONTRAST,\n\t\t     arg->contrast);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_C_PROC_HUE, arg->hue);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_C_PROC_SATURATION, arg->sat);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_C_PROC_BRIGHTNESS,\n\t\t     arg->brightness);\n\n\tif (quantization != V4L2_QUANTIZATION_FULL_RANGE ||\n\t    effect != V4L2_COLORFX_NONE) {\n\t\trkisp1_param_clear_bits(params, RKISP1_CIF_C_PROC_CTRL,\n\t\t\t\t\tRKISP1_CIF_C_PROC_YOUT_FULL |\n\t\t\t\t\tRKISP1_CIF_C_PROC_YIN_FULL |\n\t\t\t\t\tRKISP1_CIF_C_PROC_COUT_FULL);\n\t} else {\n\t\trkisp1_param_set_bits(params, RKISP1_CIF_C_PROC_CTRL,\n\t\t\t\t      RKISP1_CIF_C_PROC_YOUT_FULL |\n\t\t\t\t      RKISP1_CIF_C_PROC_YIN_FULL |\n\t\t\t\t      RKISP1_CIF_C_PROC_COUT_FULL);\n\t}\n}\n\nstatic void rkisp1_hst_config_v10(struct rkisp1_params *params,\n\t\t\t\t  const struct rkisp1_cif_isp_hst_config *arg)\n{\n\tunsigned int block_hsize, block_vsize;\n\tstatic const u32 hist_weight_regs[] = {\n\t\tRKISP1_CIF_ISP_HIST_WEIGHT_00TO30_V10,\n\t\tRKISP1_CIF_ISP_HIST_WEIGHT_40TO21_V10,\n\t\tRKISP1_CIF_ISP_HIST_WEIGHT_31TO12_V10,\n\t\tRKISP1_CIF_ISP_HIST_WEIGHT_22TO03_V10,\n\t\tRKISP1_CIF_ISP_HIST_WEIGHT_13TO43_V10,\n\t\tRKISP1_CIF_ISP_HIST_WEIGHT_04TO34_V10,\n\t};\n\tconst u8 *weight;\n\tunsigned int i;\n\tu32 hist_prop;\n\n\t \n\thist_prop = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_HIST_PROP_V10);\n\thist_prop &= RKISP1_CIF_ISP_HIST_PROP_MODE_MASK_V10;\n\thist_prop |= RKISP1_CIF_ISP_HIST_PREDIV_SET_V10(arg->histogram_predivider);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_PROP_V10, hist_prop);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_H_OFFS_V10,\n\t\t     arg->meas_window.h_offs);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_V_OFFS_V10,\n\t\t     arg->meas_window.v_offs);\n\n\tblock_hsize = arg->meas_window.h_size /\n\t\t      RKISP1_CIF_ISP_HIST_COLUMN_NUM_V10 - 1;\n\tblock_vsize = arg->meas_window.v_size / RKISP1_CIF_ISP_HIST_ROW_NUM_V10 - 1;\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_H_SIZE_V10,\n\t\t     block_hsize);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_V_SIZE_V10,\n\t\t     block_vsize);\n\n\tweight = arg->hist_weight;\n\tfor (i = 0; i < ARRAY_SIZE(hist_weight_regs); ++i, weight += 4)\n\t\trkisp1_write(params->rkisp1, hist_weight_regs[i],\n\t\t\t     RKISP1_CIF_ISP_HIST_WEIGHT_SET_V10(weight[0], weight[1],\n\t\t\t\t\t\t\t\tweight[2], weight[3]));\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_WEIGHT_44_V10,\n\t\t     weight[0] & 0x1F);\n}\n\nstatic void rkisp1_hst_config_v12(struct rkisp1_params *params,\n\t\t\t\t  const struct rkisp1_cif_isp_hst_config *arg)\n{\n\tunsigned int i, j;\n\tu32 block_hsize, block_vsize;\n\tu32 wnd_num_idx, hist_weight_num, hist_ctrl, value;\n\tu8 weight15x15[RKISP1_CIF_ISP_HIST_WEIGHT_REG_SIZE_V12];\n\tstatic const u32 hist_wnd_num[] = { 5, 9, 15, 15 };\n\n\t \n\twnd_num_idx = 1;\n\tmemset(weight15x15, 0x00, sizeof(weight15x15));\n\t \n\thist_ctrl = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_HIST_CTRL_V12);\n\thist_ctrl &= RKISP1_CIF_ISP_HIST_CTRL_MODE_MASK_V12 |\n\t\t     RKISP1_CIF_ISP_HIST_CTRL_EN_MASK_V12;\n\thist_ctrl = hist_ctrl |\n\t\t    RKISP1_CIF_ISP_HIST_CTRL_INTRSEL_SET_V12(1) |\n\t\t    RKISP1_CIF_ISP_HIST_CTRL_DATASEL_SET_V12(0) |\n\t\t    RKISP1_CIF_ISP_HIST_CTRL_WATERLINE_SET_V12(0) |\n\t\t    RKISP1_CIF_ISP_HIST_CTRL_AUTOSTOP_SET_V12(0) |\n\t\t    RKISP1_CIF_ISP_HIST_CTRL_WNDNUM_SET_V12(1) |\n\t\t    RKISP1_CIF_ISP_HIST_CTRL_STEPSIZE_SET_V12(arg->histogram_predivider);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_CTRL_V12, hist_ctrl);\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_OFFS_V12,\n\t\t     RKISP1_CIF_ISP_HIST_OFFS_SET_V12(arg->meas_window.h_offs,\n\t\t\t\t\t\t      arg->meas_window.v_offs));\n\n\tblock_hsize = arg->meas_window.h_size / hist_wnd_num[wnd_num_idx] - 1;\n\tblock_vsize = arg->meas_window.v_size / hist_wnd_num[wnd_num_idx] - 1;\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_SIZE_V12,\n\t\t     RKISP1_CIF_ISP_HIST_SIZE_SET_V12(block_hsize, block_vsize));\n\n\tfor (i = 0; i < hist_wnd_num[wnd_num_idx]; i++) {\n\t\tfor (j = 0; j < hist_wnd_num[wnd_num_idx]; j++) {\n\t\t\tweight15x15[i * RKISP1_CIF_ISP_HIST_ROW_NUM_V12 + j] =\n\t\t\t\targ->hist_weight[i * hist_wnd_num[wnd_num_idx] + j];\n\t\t}\n\t}\n\n\thist_weight_num = RKISP1_CIF_ISP_HIST_WEIGHT_REG_SIZE_V12;\n\tfor (i = 0; i < (hist_weight_num / 4); i++) {\n\t\tvalue = RKISP1_CIF_ISP_HIST_WEIGHT_SET_V12(\n\t\t\t\t weight15x15[4 * i + 0],\n\t\t\t\t weight15x15[4 * i + 1],\n\t\t\t\t weight15x15[4 * i + 2],\n\t\t\t\t weight15x15[4 * i + 3]);\n\t\trkisp1_write(params->rkisp1,\n\t\t\t     RKISP1_CIF_ISP_HIST_WEIGHT_V12 + 4 * i, value);\n\t}\n\tvalue = RKISP1_CIF_ISP_HIST_WEIGHT_SET_V12(weight15x15[4 * i + 0], 0, 0, 0);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_HIST_WEIGHT_V12 + 4 * i,\n\t\t     value);\n}\n\nstatic void\nrkisp1_hst_enable_v10(struct rkisp1_params *params,\n\t\t      const struct rkisp1_cif_isp_hst_config *arg, bool en)\n{\n\tif (en)\t{\n\t\tu32 hist_prop = rkisp1_read(params->rkisp1,\n\t\t\t\t\t    RKISP1_CIF_ISP_HIST_PROP_V10);\n\n\t\thist_prop &= ~RKISP1_CIF_ISP_HIST_PROP_MODE_MASK_V10;\n\t\thist_prop |= arg->mode;\n\t\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_HIST_PROP_V10,\n\t\t\t\t      hist_prop);\n\t} else {\n\t\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_HIST_PROP_V10,\n\t\t\t\t\tRKISP1_CIF_ISP_HIST_PROP_MODE_MASK_V10);\n\t}\n}\n\nstatic void\nrkisp1_hst_enable_v12(struct rkisp1_params *params,\n\t\t      const struct rkisp1_cif_isp_hst_config *arg, bool en)\n{\n\tif (en) {\n\t\tu32 hist_ctrl = rkisp1_read(params->rkisp1,\n\t\t\t\t\t    RKISP1_CIF_ISP_HIST_CTRL_V12);\n\n\t\thist_ctrl &= ~RKISP1_CIF_ISP_HIST_CTRL_MODE_MASK_V12;\n\t\thist_ctrl |= RKISP1_CIF_ISP_HIST_CTRL_MODE_SET_V12(arg->mode);\n\t\thist_ctrl |= RKISP1_CIF_ISP_HIST_CTRL_EN_SET_V12(1);\n\t\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_HIST_CTRL_V12,\n\t\t\t\t      hist_ctrl);\n\t} else {\n\t\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_HIST_CTRL_V12,\n\t\t\t\t\tRKISP1_CIF_ISP_HIST_CTRL_MODE_MASK_V12 |\n\t\t\t\t\tRKISP1_CIF_ISP_HIST_CTRL_EN_MASK_V12);\n\t}\n}\n\nstatic void rkisp1_afm_config_v10(struct rkisp1_params *params,\n\t\t\t\t  const struct rkisp1_cif_isp_afc_config *arg)\n{\n\tsize_t num_of_win = min_t(size_t, ARRAY_SIZE(arg->afm_win),\n\t\t\t\t  arg->num_afm_win);\n\tu32 afm_ctrl = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_AFM_CTRL);\n\tunsigned int i;\n\n\t \n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_AFM_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_AFM_ENA);\n\n\tfor (i = 0; i < num_of_win; i++) {\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_LT_A + i * 8,\n\t\t\t     RKISP1_CIF_ISP_AFM_WINDOW_X(arg->afm_win[i].h_offs) |\n\t\t\t     RKISP1_CIF_ISP_AFM_WINDOW_Y(arg->afm_win[i].v_offs));\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_RB_A + i * 8,\n\t\t\t     RKISP1_CIF_ISP_AFM_WINDOW_X(arg->afm_win[i].h_size +\n\t\t\t\t\t\t\t arg->afm_win[i].h_offs) |\n\t\t\t     RKISP1_CIF_ISP_AFM_WINDOW_Y(arg->afm_win[i].v_size +\n\t\t\t\t\t\t\t arg->afm_win[i].v_offs));\n\t}\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_THRES, arg->thres);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_VAR_SHIFT,\n\t\t     arg->var_shift);\n\t \n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_CTRL, afm_ctrl);\n}\n\nstatic void rkisp1_afm_config_v12(struct rkisp1_params *params,\n\t\t\t\t  const struct rkisp1_cif_isp_afc_config *arg)\n{\n\tsize_t num_of_win = min_t(size_t, ARRAY_SIZE(arg->afm_win),\n\t\t\t\t  arg->num_afm_win);\n\tu32 afm_ctrl = rkisp1_read(params->rkisp1, RKISP1_CIF_ISP_AFM_CTRL);\n\tu32 lum_var_shift, afm_var_shift;\n\tunsigned int i;\n\n\t \n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_AFM_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_AFM_ENA);\n\n\tfor (i = 0; i < num_of_win; i++) {\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_LT_A + i * 8,\n\t\t\t     RKISP1_CIF_ISP_AFM_WINDOW_X(arg->afm_win[i].h_offs) |\n\t\t\t     RKISP1_CIF_ISP_AFM_WINDOW_Y(arg->afm_win[i].v_offs));\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_RB_A + i * 8,\n\t\t\t     RKISP1_CIF_ISP_AFM_WINDOW_X(arg->afm_win[i].h_size +\n\t\t\t\t\t\t\t arg->afm_win[i].h_offs) |\n\t\t\t     RKISP1_CIF_ISP_AFM_WINDOW_Y(arg->afm_win[i].v_size +\n\t\t\t\t\t\t\t arg->afm_win[i].v_offs));\n\t}\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_THRES, arg->thres);\n\n\tlum_var_shift = RKISP1_CIF_ISP_AFM_GET_LUM_SHIFT_a_V12(arg->var_shift);\n\tafm_var_shift = RKISP1_CIF_ISP_AFM_GET_AFM_SHIFT_a_V12(arg->var_shift);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_VAR_SHIFT,\n\t\t     RKISP1_CIF_ISP_AFM_SET_SHIFT_a_V12(lum_var_shift, afm_var_shift) |\n\t\t     RKISP1_CIF_ISP_AFM_SET_SHIFT_b_V12(lum_var_shift, afm_var_shift) |\n\t\t     RKISP1_CIF_ISP_AFM_SET_SHIFT_c_V12(lum_var_shift, afm_var_shift));\n\n\t \n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_AFM_CTRL, afm_ctrl);\n}\n\nstatic void rkisp1_ie_config(struct rkisp1_params *params,\n\t\t\t     const struct rkisp1_cif_isp_ie_config *arg)\n{\n\tu32 eff_ctrl;\n\n\teff_ctrl = rkisp1_read(params->rkisp1, RKISP1_CIF_IMG_EFF_CTRL);\n\teff_ctrl &= ~RKISP1_CIF_IMG_EFF_CTRL_MODE_MASK;\n\n\tif (params->quantization == V4L2_QUANTIZATION_FULL_RANGE)\n\t\teff_ctrl |= RKISP1_CIF_IMG_EFF_CTRL_YCBCR_FULL;\n\n\tswitch (arg->effect) {\n\tcase V4L2_COLORFX_SEPIA:\n\t\teff_ctrl |= RKISP1_CIF_IMG_EFF_CTRL_MODE_SEPIA;\n\t\tbreak;\n\tcase V4L2_COLORFX_SET_CBCR:\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_TINT,\n\t\t\t     arg->eff_tint);\n\t\teff_ctrl |= RKISP1_CIF_IMG_EFF_CTRL_MODE_SEPIA;\n\t\tbreak;\n\t\t \n\tcase V4L2_COLORFX_AQUA:\n\t\teff_ctrl |= RKISP1_CIF_IMG_EFF_CTRL_MODE_COLOR_SEL;\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_COLOR_SEL,\n\t\t\t     arg->color_sel);\n\t\tbreak;\n\tcase V4L2_COLORFX_EMBOSS:\n\t\teff_ctrl |= RKISP1_CIF_IMG_EFF_CTRL_MODE_EMBOSS;\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_MAT_1,\n\t\t\t     arg->eff_mat_1);\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_MAT_2,\n\t\t\t     arg->eff_mat_2);\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_MAT_3,\n\t\t\t     arg->eff_mat_3);\n\t\tbreak;\n\tcase V4L2_COLORFX_SKETCH:\n\t\teff_ctrl |= RKISP1_CIF_IMG_EFF_CTRL_MODE_SKETCH;\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_MAT_3,\n\t\t\t     arg->eff_mat_3);\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_MAT_4,\n\t\t\t     arg->eff_mat_4);\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_MAT_5,\n\t\t\t     arg->eff_mat_5);\n\t\tbreak;\n\tcase V4L2_COLORFX_BW:\n\t\teff_ctrl |= RKISP1_CIF_IMG_EFF_CTRL_MODE_BLACKWHITE;\n\t\tbreak;\n\tcase V4L2_COLORFX_NEGATIVE:\n\t\teff_ctrl |= RKISP1_CIF_IMG_EFF_CTRL_MODE_NEGATIVE;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_CTRL, eff_ctrl);\n}\n\nstatic void rkisp1_ie_enable(struct rkisp1_params *params, bool en)\n{\n\tif (en) {\n\t\trkisp1_param_set_bits(params, RKISP1_CIF_VI_ICCL,\n\t\t\t\t      RKISP1_CIF_VI_ICCL_IE_CLK);\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_IMG_EFF_CTRL,\n\t\t\t     RKISP1_CIF_IMG_EFF_CTRL_ENABLE);\n\t\trkisp1_param_set_bits(params, RKISP1_CIF_IMG_EFF_CTRL,\n\t\t\t\t      RKISP1_CIF_IMG_EFF_CTRL_CFG_UPD);\n\t} else {\n\t\trkisp1_param_clear_bits(params, RKISP1_CIF_IMG_EFF_CTRL,\n\t\t\t\t\tRKISP1_CIF_IMG_EFF_CTRL_ENABLE);\n\t\trkisp1_param_clear_bits(params, RKISP1_CIF_VI_ICCL,\n\t\t\t\t\tRKISP1_CIF_VI_ICCL_IE_CLK);\n\t}\n}\n\nstatic void rkisp1_csm_config(struct rkisp1_params *params)\n{\n\tstruct csm_coeffs {\n\t\tu16 limited[9];\n\t\tu16 full[9];\n\t};\n\tstatic const struct csm_coeffs rec601_coeffs = {\n\t\t.limited = {\n\t\t\t0x0021, 0x0042, 0x000d,\n\t\t\t0x01ed, 0x01db, 0x0038,\n\t\t\t0x0038, 0x01d1, 0x01f7,\n\t\t},\n\t\t.full = {\n\t\t\t0x0026, 0x004b, 0x000f,\n\t\t\t0x01ea, 0x01d6, 0x0040,\n\t\t\t0x0040, 0x01ca, 0x01f6,\n\t\t},\n\t};\n\tstatic const struct csm_coeffs rec709_coeffs = {\n\t\t.limited = {\n\t\t\t0x0018, 0x0050, 0x0008,\n\t\t\t0x01f3, 0x01d5, 0x0038,\n\t\t\t0x0038, 0x01cd, 0x01fb,\n\t\t},\n\t\t.full = {\n\t\t\t0x001b, 0x005c, 0x0009,\n\t\t\t0x01f1, 0x01cf, 0x0040,\n\t\t\t0x0040, 0x01c6, 0x01fa,\n\t\t},\n\t};\n\tstatic const struct csm_coeffs rec2020_coeffs = {\n\t\t.limited = {\n\t\t\t0x001d, 0x004c, 0x0007,\n\t\t\t0x01f0, 0x01d8, 0x0038,\n\t\t\t0x0038, 0x01cd, 0x01fb,\n\t\t},\n\t\t.full = {\n\t\t\t0x0022, 0x0057, 0x0008,\n\t\t\t0x01ee, 0x01d2, 0x0040,\n\t\t\t0x0040, 0x01c5, 0x01fb,\n\t\t},\n\t};\n\tstatic const struct csm_coeffs smpte240m_coeffs = {\n\t\t.limited = {\n\t\t\t0x0018, 0x004f, 0x000a,\n\t\t\t0x01f3, 0x01d5, 0x0038,\n\t\t\t0x0038, 0x01ce, 0x01fa,\n\t\t},\n\t\t.full = {\n\t\t\t0x001b, 0x005a, 0x000b,\n\t\t\t0x01f1, 0x01cf, 0x0040,\n\t\t\t0x0040, 0x01c7, 0x01f9,\n\t\t},\n\t};\n\n\tconst struct csm_coeffs *coeffs;\n\tconst u16 *csm;\n\tunsigned int i;\n\n\tswitch (params->ycbcr_encoding) {\n\tcase V4L2_YCBCR_ENC_601:\n\tdefault:\n\t\tcoeffs = &rec601_coeffs;\n\t\tbreak;\n\tcase V4L2_YCBCR_ENC_709:\n\t\tcoeffs = &rec709_coeffs;\n\t\tbreak;\n\tcase V4L2_YCBCR_ENC_BT2020:\n\t\tcoeffs = &rec2020_coeffs;\n\t\tbreak;\n\tcase V4L2_YCBCR_ENC_SMPTE240M:\n\t\tcoeffs = &smpte240m_coeffs;\n\t\tbreak;\n\t}\n\n\tif (params->quantization == V4L2_QUANTIZATION_FULL_RANGE) {\n\t\tcsm = coeffs->full;\n\t\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_CSM_Y_FULL_ENA |\n\t\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_CSM_C_FULL_ENA);\n\t} else {\n\t\tcsm = coeffs->limited;\n\t\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_CSM_Y_FULL_ENA |\n\t\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_CSM_C_FULL_ENA);\n\t}\n\n\tfor (i = 0; i < 9; i++)\n\t\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_CC_COEFF_0 + i * 4,\n\t\t\t     csm[i]);\n}\n\n \nstatic void rkisp1_dpf_config(struct rkisp1_params *params,\n\t\t\t      const struct rkisp1_cif_isp_dpf_config *arg)\n{\n\tunsigned int isp_dpf_mode, spatial_coeff, i;\n\n\tswitch (arg->gain.mode) {\n\tcase RKISP1_CIF_ISP_DPF_GAIN_USAGE_NF_GAINS:\n\t\tisp_dpf_mode = RKISP1_CIF_ISP_DPF_MODE_USE_NF_GAIN |\n\t\t\t       RKISP1_CIF_ISP_DPF_MODE_AWB_GAIN_COMP;\n\t\tbreak;\n\tcase RKISP1_CIF_ISP_DPF_GAIN_USAGE_LSC_GAINS:\n\t\tisp_dpf_mode = RKISP1_CIF_ISP_DPF_MODE_LSC_GAIN_COMP;\n\t\tbreak;\n\tcase RKISP1_CIF_ISP_DPF_GAIN_USAGE_NF_LSC_GAINS:\n\t\tisp_dpf_mode = RKISP1_CIF_ISP_DPF_MODE_USE_NF_GAIN |\n\t\t\t       RKISP1_CIF_ISP_DPF_MODE_AWB_GAIN_COMP |\n\t\t\t       RKISP1_CIF_ISP_DPF_MODE_LSC_GAIN_COMP;\n\t\tbreak;\n\tcase RKISP1_CIF_ISP_DPF_GAIN_USAGE_AWB_GAINS:\n\t\tisp_dpf_mode = RKISP1_CIF_ISP_DPF_MODE_AWB_GAIN_COMP;\n\t\tbreak;\n\tcase RKISP1_CIF_ISP_DPF_GAIN_USAGE_AWB_LSC_GAINS:\n\t\tisp_dpf_mode = RKISP1_CIF_ISP_DPF_MODE_LSC_GAIN_COMP |\n\t\t\t       RKISP1_CIF_ISP_DPF_MODE_AWB_GAIN_COMP;\n\t\tbreak;\n\tcase RKISP1_CIF_ISP_DPF_GAIN_USAGE_DISABLED:\n\tdefault:\n\t\tisp_dpf_mode = 0;\n\t\tbreak;\n\t}\n\n\tif (arg->nll.scale_mode == RKISP1_CIF_ISP_NLL_SCALE_LOGARITHMIC)\n\t\tisp_dpf_mode |= RKISP1_CIF_ISP_DPF_MODE_NLL_SEGMENTATION;\n\tif (arg->rb_flt.fltsize == RKISP1_CIF_ISP_DPF_RB_FILTERSIZE_9x9)\n\t\tisp_dpf_mode |= RKISP1_CIF_ISP_DPF_MODE_RB_FLTSIZE_9x9;\n\tif (!arg->rb_flt.r_enable)\n\t\tisp_dpf_mode |= RKISP1_CIF_ISP_DPF_MODE_R_FLT_DIS;\n\tif (!arg->rb_flt.b_enable)\n\t\tisp_dpf_mode |= RKISP1_CIF_ISP_DPF_MODE_B_FLT_DIS;\n\tif (!arg->g_flt.gb_enable)\n\t\tisp_dpf_mode |= RKISP1_CIF_ISP_DPF_MODE_GB_FLT_DIS;\n\tif (!arg->g_flt.gr_enable)\n\t\tisp_dpf_mode |= RKISP1_CIF_ISP_DPF_MODE_GR_FLT_DIS;\n\n\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_DPF_MODE,\n\t\t\t      isp_dpf_mode);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_NF_GAIN_B,\n\t\t     arg->gain.nf_b_gain);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_NF_GAIN_R,\n\t\t     arg->gain.nf_r_gain);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_NF_GAIN_GB,\n\t\t     arg->gain.nf_gb_gain);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_NF_GAIN_GR,\n\t\t     arg->gain.nf_gr_gain);\n\n\tfor (i = 0; i < RKISP1_CIF_ISP_DPF_MAX_NLF_COEFFS; i++) {\n\t\trkisp1_write(params->rkisp1,\n\t\t\t     RKISP1_CIF_ISP_DPF_NULL_COEFF_0 + i * 4,\n\t\t\t     arg->nll.coeff[i]);\n\t}\n\n\tspatial_coeff = arg->g_flt.spatial_coeff[0] |\n\t\t\t(arg->g_flt.spatial_coeff[1] << 8) |\n\t\t\t(arg->g_flt.spatial_coeff[2] << 16) |\n\t\t\t(arg->g_flt.spatial_coeff[3] << 24);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_S_WEIGHT_G_1_4,\n\t\t     spatial_coeff);\n\n\tspatial_coeff = arg->g_flt.spatial_coeff[4] |\n\t\t\t(arg->g_flt.spatial_coeff[5] << 8);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_S_WEIGHT_G_5_6,\n\t\t     spatial_coeff);\n\n\tspatial_coeff = arg->rb_flt.spatial_coeff[0] |\n\t\t\t(arg->rb_flt.spatial_coeff[1] << 8) |\n\t\t\t(arg->rb_flt.spatial_coeff[2] << 16) |\n\t\t\t(arg->rb_flt.spatial_coeff[3] << 24);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_S_WEIGHT_RB_1_4,\n\t\t     spatial_coeff);\n\n\tspatial_coeff = arg->rb_flt.spatial_coeff[4] |\n\t\t\t(arg->rb_flt.spatial_coeff[5] << 8);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_S_WEIGHT_RB_5_6,\n\t\t     spatial_coeff);\n}\n\nstatic void\nrkisp1_dpf_strength_config(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_dpf_strength_config *arg)\n{\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_STRENGTH_B, arg->b);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_STRENGTH_G, arg->g);\n\trkisp1_write(params->rkisp1, RKISP1_CIF_ISP_DPF_STRENGTH_R, arg->r);\n}\n\nstatic void\nrkisp1_isp_isr_other_config(struct rkisp1_params *params,\n\t\t\t    const struct rkisp1_params_cfg *new_params)\n{\n\tunsigned int module_en_update, module_cfg_update, module_ens;\n\n\tmodule_en_update = new_params->module_en_update;\n\tmodule_cfg_update = new_params->module_cfg_update;\n\tmodule_ens = new_params->module_ens;\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_DPCC)\n\t\trkisp1_dpcc_config(params,\n\t\t\t\t   &new_params->others.dpcc_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_DPCC) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_DPCC)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_DPCC_MODE,\n\t\t\t\t\t      RKISP1_CIF_ISP_DPCC_MODE_DPCC_ENABLE);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_DPCC_MODE,\n\t\t\t\t\t\tRKISP1_CIF_ISP_DPCC_MODE_DPCC_ENABLE);\n\t}\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_BLS)\n\t\trkisp1_bls_config(params,\n\t\t\t\t  &new_params->others.bls_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_BLS) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_BLS)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_BLS_CTRL,\n\t\t\t\t\t      RKISP1_CIF_ISP_BLS_ENA);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_BLS_CTRL,\n\t\t\t\t\t\tRKISP1_CIF_ISP_BLS_ENA);\n\t}\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_SDG)\n\t\trkisp1_sdg_config(params,\n\t\t\t\t  &new_params->others.sdg_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_SDG) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_SDG)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_CTRL,\n\t\t\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_GAMMA_IN_ENA);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_CTRL,\n\t\t\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_GAMMA_IN_ENA);\n\t}\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_AWB_GAIN)\n\t\tparams->ops->awb_gain_config(params, &new_params->others.awb_gain_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_AWB_GAIN) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_AWB_GAIN)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_CTRL,\n\t\t\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_AWB_ENA);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_CTRL,\n\t\t\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_AWB_ENA);\n\t}\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_BDM)\n\t\trkisp1_bdm_config(params,\n\t\t\t\t  &new_params->others.bdm_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_BDM) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_BDM)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_DEMOSAIC,\n\t\t\t\t\t      RKISP1_CIF_ISP_DEMOSAIC_BYPASS);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_DEMOSAIC,\n\t\t\t\t\t\tRKISP1_CIF_ISP_DEMOSAIC_BYPASS);\n\t}\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_FLT)\n\t\trkisp1_flt_config(params,\n\t\t\t\t  &new_params->others.flt_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_FLT) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_FLT)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_FILT_MODE,\n\t\t\t\t\t      RKISP1_CIF_ISP_FLT_ENA);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_FILT_MODE,\n\t\t\t\t\t\tRKISP1_CIF_ISP_FLT_ENA);\n\t}\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_CTK)\n\t\trkisp1_ctk_config(params,\n\t\t\t\t  &new_params->others.ctk_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_CTK)\n\t\trkisp1_ctk_enable(params, !!(module_ens & RKISP1_CIF_ISP_MODULE_CTK));\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_GOC)\n\t\tparams->ops->goc_config(params, &new_params->others.goc_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_GOC) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_GOC)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_CTRL,\n\t\t\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_GAMMA_OUT_ENA);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_CTRL,\n\t\t\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_GAMMA_OUT_ENA);\n\t}\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_CPROC)\n\t\trkisp1_cproc_config(params,\n\t\t\t\t    &new_params->others.cproc_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_CPROC) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_CPROC)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_C_PROC_CTRL,\n\t\t\t\t\t      RKISP1_CIF_C_PROC_CTR_ENABLE);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_C_PROC_CTRL,\n\t\t\t\t\t\tRKISP1_CIF_C_PROC_CTR_ENABLE);\n\t}\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_IE)\n\t\trkisp1_ie_config(params, &new_params->others.ie_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_IE)\n\t\trkisp1_ie_enable(params, !!(module_ens & RKISP1_CIF_ISP_MODULE_IE));\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_DPF)\n\t\trkisp1_dpf_config(params, &new_params->others.dpf_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_DPF) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_DPF)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_DPF_MODE,\n\t\t\t\t\t      RKISP1_CIF_ISP_DPF_MODE_EN);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_DPF_MODE,\n\t\t\t\t\t\tRKISP1_CIF_ISP_DPF_MODE_EN);\n\t}\n\n\tif ((module_en_update & RKISP1_CIF_ISP_MODULE_DPF_STRENGTH) ||\n\t    (module_cfg_update & RKISP1_CIF_ISP_MODULE_DPF_STRENGTH)) {\n\t\t \n\t\trkisp1_dpf_strength_config(params,\n\t\t\t\t\t   &new_params->others.dpf_strength_config);\n\t}\n}\n\nstatic void\nrkisp1_isp_isr_lsc_config(struct rkisp1_params *params,\n\t\t\t  const struct rkisp1_params_cfg *new_params)\n{\n\tunsigned int module_en_update, module_cfg_update, module_ens;\n\n\tmodule_en_update = new_params->module_en_update;\n\tmodule_cfg_update = new_params->module_cfg_update;\n\tmodule_ens = new_params->module_ens;\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_LSC)\n\t\trkisp1_lsc_config(params,\n\t\t\t\t  &new_params->others.lsc_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_LSC) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_LSC)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_LSC_CTRL,\n\t\t\t\t\t      RKISP1_CIF_ISP_LSC_CTRL_ENA);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_LSC_CTRL,\n\t\t\t\t\t\tRKISP1_CIF_ISP_LSC_CTRL_ENA);\n\t}\n}\n\nstatic void rkisp1_isp_isr_meas_config(struct rkisp1_params *params,\n\t\t\t\t       struct  rkisp1_params_cfg *new_params)\n{\n\tunsigned int module_en_update, module_cfg_update, module_ens;\n\n\tmodule_en_update = new_params->module_en_update;\n\tmodule_cfg_update = new_params->module_cfg_update;\n\tmodule_ens = new_params->module_ens;\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_AWB)\n\t\tparams->ops->awb_meas_config(params, &new_params->meas.awb_meas_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_AWB)\n\t\tparams->ops->awb_meas_enable(params,\n\t\t\t\t\t     &new_params->meas.awb_meas_config,\n\t\t\t\t\t     !!(module_ens & RKISP1_CIF_ISP_MODULE_AWB));\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_AFC)\n\t\tparams->ops->afm_config(params,\n\t\t\t\t\t&new_params->meas.afc_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_AFC) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_AFC)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_AFM_CTRL,\n\t\t\t\t\t      RKISP1_CIF_ISP_AFM_ENA);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_AFM_CTRL,\n\t\t\t\t\t\tRKISP1_CIF_ISP_AFM_ENA);\n\t}\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_HST)\n\t\tparams->ops->hst_config(params,\n\t\t\t\t\t&new_params->meas.hst_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_HST)\n\t\tparams->ops->hst_enable(params,\n\t\t\t\t\t&new_params->meas.hst_config,\n\t\t\t\t\t!!(module_ens & RKISP1_CIF_ISP_MODULE_HST));\n\n\t \n\tif (module_cfg_update & RKISP1_CIF_ISP_MODULE_AEC)\n\t\tparams->ops->aec_config(params,\n\t\t\t\t\t&new_params->meas.aec_config);\n\n\tif (module_en_update & RKISP1_CIF_ISP_MODULE_AEC) {\n\t\tif (module_ens & RKISP1_CIF_ISP_MODULE_AEC)\n\t\t\trkisp1_param_set_bits(params,\n\t\t\t\t\t      RKISP1_CIF_ISP_EXP_CTRL,\n\t\t\t\t\t      RKISP1_CIF_ISP_EXP_ENA);\n\t\telse\n\t\t\trkisp1_param_clear_bits(params,\n\t\t\t\t\t\tRKISP1_CIF_ISP_EXP_CTRL,\n\t\t\t\t\t\tRKISP1_CIF_ISP_EXP_ENA);\n\t}\n}\n\nstatic bool rkisp1_params_get_buffer(struct rkisp1_params *params,\n\t\t\t\t     struct rkisp1_buffer **buf,\n\t\t\t\t     struct rkisp1_params_cfg **cfg)\n{\n\tif (list_empty(&params->params))\n\t\treturn false;\n\n\t*buf = list_first_entry(&params->params, struct rkisp1_buffer, queue);\n\t*cfg = vb2_plane_vaddr(&(*buf)->vb.vb2_buf, 0);\n\n\treturn true;\n}\n\nstatic void rkisp1_params_complete_buffer(struct rkisp1_params *params,\n\t\t\t\t\t  struct rkisp1_buffer *buf,\n\t\t\t\t\t  unsigned int frame_sequence)\n{\n\tlist_del(&buf->queue);\n\n\tbuf->vb.sequence = frame_sequence;\n\tvb2_buffer_done(&buf->vb.vb2_buf, VB2_BUF_STATE_DONE);\n}\n\nvoid rkisp1_params_isr(struct rkisp1_device *rkisp1)\n{\n\tstruct rkisp1_params *params = &rkisp1->params;\n\tstruct rkisp1_params_cfg *new_params;\n\tstruct rkisp1_buffer *cur_buf;\n\n\tspin_lock(&params->config_lock);\n\n\tif (!rkisp1_params_get_buffer(params, &cur_buf, &new_params))\n\t\tgoto unlock;\n\n\trkisp1_isp_isr_other_config(params, new_params);\n\trkisp1_isp_isr_lsc_config(params, new_params);\n\trkisp1_isp_isr_meas_config(params, new_params);\n\n\t \n\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_CFG_UPD);\n\n\t \n\trkisp1_params_complete_buffer(params, cur_buf,\n\t\t\t\t      rkisp1->isp.frame_sequence + 1);\n\nunlock:\n\tspin_unlock(&params->config_lock);\n}\n\nstatic const struct rkisp1_cif_isp_awb_meas_config rkisp1_awb_params_default_config = {\n\t{\n\t\t0, 0, RKISP1_DEFAULT_WIDTH, RKISP1_DEFAULT_HEIGHT\n\t},\n\tRKISP1_CIF_ISP_AWB_MODE_YCBCR, 200, 30, 20, 20, 0, 128, 128\n};\n\nstatic const struct rkisp1_cif_isp_aec_config rkisp1_aec_params_default_config = {\n\tRKISP1_CIF_ISP_EXP_MEASURING_MODE_0,\n\tRKISP1_CIF_ISP_EXP_CTRL_AUTOSTOP_0,\n\t{\n\t\tRKISP1_DEFAULT_WIDTH >> 2, RKISP1_DEFAULT_HEIGHT >> 2,\n\t\tRKISP1_DEFAULT_WIDTH >> 1, RKISP1_DEFAULT_HEIGHT >> 1\n\t}\n};\n\nstatic const struct rkisp1_cif_isp_hst_config rkisp1_hst_params_default_config = {\n\tRKISP1_CIF_ISP_HISTOGRAM_MODE_RGB_COMBINED,\n\t3,\n\t{\n\t\tRKISP1_DEFAULT_WIDTH >> 2, RKISP1_DEFAULT_HEIGHT >> 2,\n\t\tRKISP1_DEFAULT_WIDTH >> 1, RKISP1_DEFAULT_HEIGHT >> 1\n\t},\n\t{\n\t\t0,  \n\t}\n};\n\nstatic const struct rkisp1_cif_isp_afc_config rkisp1_afc_params_default_config = {\n\t1,\n\t{\n\t\t{\n\t\t\t300, 225, 200, 150\n\t\t}\n\t},\n\t4,\n\t14\n};\n\nvoid rkisp1_params_pre_configure(struct rkisp1_params *params,\n\t\t\t\t enum rkisp1_fmt_raw_pat_type bayer_pat,\n\t\t\t\t enum v4l2_quantization quantization,\n\t\t\t\t enum v4l2_ycbcr_encoding ycbcr_encoding)\n{\n\tstruct rkisp1_cif_isp_hst_config hst = rkisp1_hst_params_default_config;\n\tstruct rkisp1_params_cfg *new_params;\n\tstruct rkisp1_buffer *cur_buf;\n\n\tparams->quantization = quantization;\n\tparams->ycbcr_encoding = ycbcr_encoding;\n\tparams->raw_type = bayer_pat;\n\n\tparams->ops->awb_meas_config(params, &rkisp1_awb_params_default_config);\n\tparams->ops->awb_meas_enable(params, &rkisp1_awb_params_default_config,\n\t\t\t\t     true);\n\n\tparams->ops->aec_config(params, &rkisp1_aec_params_default_config);\n\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_EXP_CTRL,\n\t\t\t      RKISP1_CIF_ISP_EXP_ENA);\n\n\tparams->ops->afm_config(params, &rkisp1_afc_params_default_config);\n\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_AFM_CTRL,\n\t\t\t      RKISP1_CIF_ISP_AFM_ENA);\n\n\tmemset(hst.hist_weight, 0x01, sizeof(hst.hist_weight));\n\tparams->ops->hst_config(params, &hst);\n\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_HIST_PROP_V10,\n\t\t\t      rkisp1_hst_params_default_config.mode);\n\n\trkisp1_csm_config(params);\n\n\tspin_lock_irq(&params->config_lock);\n\n\t \n\n\tif (!rkisp1_params_get_buffer(params, &cur_buf, &new_params))\n\t\tgoto unlock;\n\n\trkisp1_isp_isr_other_config(params, new_params);\n\trkisp1_isp_isr_meas_config(params, new_params);\n\n\t \n\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_CFG_UPD);\n\nunlock:\n\tspin_unlock_irq(&params->config_lock);\n}\n\nvoid rkisp1_params_post_configure(struct rkisp1_params *params)\n{\n\tstruct rkisp1_params_cfg *new_params;\n\tstruct rkisp1_buffer *cur_buf;\n\n\tspin_lock_irq(&params->config_lock);\n\n\t \n\n\tif (!rkisp1_params_get_buffer(params, &cur_buf, &new_params))\n\t\tgoto unlock;\n\n\trkisp1_isp_isr_lsc_config(params, new_params);\n\n\t \n\trkisp1_param_set_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t      RKISP1_CIF_ISP_CTRL_ISP_CFG_UPD);\n\n\trkisp1_params_complete_buffer(params, cur_buf, 0);\n\nunlock:\n\tspin_unlock_irq(&params->config_lock);\n}\n\n \nvoid rkisp1_params_disable(struct rkisp1_params *params)\n{\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_DPCC_MODE,\n\t\t\t\tRKISP1_CIF_ISP_DPCC_MODE_DPCC_ENABLE);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_LSC_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_LSC_CTRL_ENA);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_BLS_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_BLS_ENA);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_GAMMA_IN_ENA);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_GAMMA_OUT_ENA);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_DEMOSAIC,\n\t\t\t\tRKISP1_CIF_ISP_DEMOSAIC_BYPASS);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_FILT_MODE,\n\t\t\t\tRKISP1_CIF_ISP_FLT_ENA);\n\tparams->ops->awb_meas_enable(params, NULL, false);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_CTRL_ISP_AWB_ENA);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_EXP_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_EXP_ENA);\n\trkisp1_ctk_enable(params, false);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_C_PROC_CTRL,\n\t\t\t\tRKISP1_CIF_C_PROC_CTR_ENABLE);\n\tparams->ops->hst_enable(params, NULL, false);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_AFM_CTRL,\n\t\t\t\tRKISP1_CIF_ISP_AFM_ENA);\n\trkisp1_ie_enable(params, false);\n\trkisp1_param_clear_bits(params, RKISP1_CIF_ISP_DPF_MODE,\n\t\t\t\tRKISP1_CIF_ISP_DPF_MODE_EN);\n}\n\nstatic const struct rkisp1_params_ops rkisp1_v10_params_ops = {\n\t.lsc_matrix_config = rkisp1_lsc_matrix_config_v10,\n\t.goc_config = rkisp1_goc_config_v10,\n\t.awb_meas_config = rkisp1_awb_meas_config_v10,\n\t.awb_meas_enable = rkisp1_awb_meas_enable_v10,\n\t.awb_gain_config = rkisp1_awb_gain_config_v10,\n\t.aec_config = rkisp1_aec_config_v10,\n\t.hst_config = rkisp1_hst_config_v10,\n\t.hst_enable = rkisp1_hst_enable_v10,\n\t.afm_config = rkisp1_afm_config_v10,\n};\n\nstatic struct rkisp1_params_ops rkisp1_v12_params_ops = {\n\t.lsc_matrix_config = rkisp1_lsc_matrix_config_v12,\n\t.goc_config = rkisp1_goc_config_v12,\n\t.awb_meas_config = rkisp1_awb_meas_config_v12,\n\t.awb_meas_enable = rkisp1_awb_meas_enable_v12,\n\t.awb_gain_config = rkisp1_awb_gain_config_v12,\n\t.aec_config = rkisp1_aec_config_v12,\n\t.hst_config = rkisp1_hst_config_v12,\n\t.hst_enable = rkisp1_hst_enable_v12,\n\t.afm_config = rkisp1_afm_config_v12,\n};\n\nstatic int rkisp1_params_enum_fmt_meta_out(struct file *file, void *priv,\n\t\t\t\t\t   struct v4l2_fmtdesc *f)\n{\n\tstruct video_device *video = video_devdata(file);\n\tstruct rkisp1_params *params = video_get_drvdata(video);\n\n\tif (f->index > 0 || f->type != video->queue->type)\n\t\treturn -EINVAL;\n\n\tf->pixelformat = params->vdev_fmt.fmt.meta.dataformat;\n\n\treturn 0;\n}\n\nstatic int rkisp1_params_g_fmt_meta_out(struct file *file, void *fh,\n\t\t\t\t\tstruct v4l2_format *f)\n{\n\tstruct video_device *video = video_devdata(file);\n\tstruct rkisp1_params *params = video_get_drvdata(video);\n\tstruct v4l2_meta_format *meta = &f->fmt.meta;\n\n\tif (f->type != video->queue->type)\n\t\treturn -EINVAL;\n\n\tmemset(meta, 0, sizeof(*meta));\n\tmeta->dataformat = params->vdev_fmt.fmt.meta.dataformat;\n\tmeta->buffersize = params->vdev_fmt.fmt.meta.buffersize;\n\n\treturn 0;\n}\n\nstatic int rkisp1_params_querycap(struct file *file,\n\t\t\t\t  void *priv, struct v4l2_capability *cap)\n{\n\tstruct video_device *vdev = video_devdata(file);\n\n\tstrscpy(cap->driver, RKISP1_DRIVER_NAME, sizeof(cap->driver));\n\tstrscpy(cap->card, vdev->name, sizeof(cap->card));\n\tstrscpy(cap->bus_info, RKISP1_BUS_INFO, sizeof(cap->bus_info));\n\n\treturn 0;\n}\n\n \nstatic const struct v4l2_ioctl_ops rkisp1_params_ioctl = {\n\t.vidioc_reqbufs = vb2_ioctl_reqbufs,\n\t.vidioc_querybuf = vb2_ioctl_querybuf,\n\t.vidioc_create_bufs = vb2_ioctl_create_bufs,\n\t.vidioc_qbuf = vb2_ioctl_qbuf,\n\t.vidioc_dqbuf = vb2_ioctl_dqbuf,\n\t.vidioc_prepare_buf = vb2_ioctl_prepare_buf,\n\t.vidioc_expbuf = vb2_ioctl_expbuf,\n\t.vidioc_streamon = vb2_ioctl_streamon,\n\t.vidioc_streamoff = vb2_ioctl_streamoff,\n\t.vidioc_enum_fmt_meta_out = rkisp1_params_enum_fmt_meta_out,\n\t.vidioc_g_fmt_meta_out = rkisp1_params_g_fmt_meta_out,\n\t.vidioc_s_fmt_meta_out = rkisp1_params_g_fmt_meta_out,\n\t.vidioc_try_fmt_meta_out = rkisp1_params_g_fmt_meta_out,\n\t.vidioc_querycap = rkisp1_params_querycap,\n\t.vidioc_subscribe_event = v4l2_ctrl_subscribe_event,\n\t.vidioc_unsubscribe_event = v4l2_event_unsubscribe,\n};\n\nstatic int rkisp1_params_vb2_queue_setup(struct vb2_queue *vq,\n\t\t\t\t\t unsigned int *num_buffers,\n\t\t\t\t\t unsigned int *num_planes,\n\t\t\t\t\t unsigned int sizes[],\n\t\t\t\t\t struct device *alloc_devs[])\n{\n\t*num_buffers = clamp_t(u32, *num_buffers,\n\t\t\t       RKISP1_ISP_PARAMS_REQ_BUFS_MIN,\n\t\t\t       RKISP1_ISP_PARAMS_REQ_BUFS_MAX);\n\n\t*num_planes = 1;\n\n\tsizes[0] = sizeof(struct rkisp1_params_cfg);\n\n\treturn 0;\n}\n\nstatic void rkisp1_params_vb2_buf_queue(struct vb2_buffer *vb)\n{\n\tstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\n\tstruct rkisp1_buffer *params_buf =\n\t\tcontainer_of(vbuf, struct rkisp1_buffer, vb);\n\tstruct vb2_queue *vq = vb->vb2_queue;\n\tstruct rkisp1_params *params = vq->drv_priv;\n\n\tspin_lock_irq(&params->config_lock);\n\tlist_add_tail(&params_buf->queue, &params->params);\n\tspin_unlock_irq(&params->config_lock);\n}\n\nstatic int rkisp1_params_vb2_buf_prepare(struct vb2_buffer *vb)\n{\n\tif (vb2_plane_size(vb, 0) < sizeof(struct rkisp1_params_cfg))\n\t\treturn -EINVAL;\n\n\tvb2_set_plane_payload(vb, 0, sizeof(struct rkisp1_params_cfg));\n\n\treturn 0;\n}\n\nstatic void rkisp1_params_vb2_stop_streaming(struct vb2_queue *vq)\n{\n\tstruct rkisp1_params *params = vq->drv_priv;\n\tstruct rkisp1_buffer *buf;\n\tLIST_HEAD(tmp_list);\n\n\t \n\tspin_lock_irq(&params->config_lock);\n\tlist_splice_init(&params->params, &tmp_list);\n\tspin_unlock_irq(&params->config_lock);\n\n\tlist_for_each_entry(buf, &tmp_list, queue)\n\t\tvb2_buffer_done(&buf->vb.vb2_buf, VB2_BUF_STATE_ERROR);\n}\n\nstatic const struct vb2_ops rkisp1_params_vb2_ops = {\n\t.queue_setup = rkisp1_params_vb2_queue_setup,\n\t.wait_prepare = vb2_ops_wait_prepare,\n\t.wait_finish = vb2_ops_wait_finish,\n\t.buf_queue = rkisp1_params_vb2_buf_queue,\n\t.buf_prepare = rkisp1_params_vb2_buf_prepare,\n\t.stop_streaming = rkisp1_params_vb2_stop_streaming,\n\n};\n\nstatic const struct v4l2_file_operations rkisp1_params_fops = {\n\t.mmap = vb2_fop_mmap,\n\t.unlocked_ioctl = video_ioctl2,\n\t.poll = vb2_fop_poll,\n\t.open = v4l2_fh_open,\n\t.release = vb2_fop_release\n};\n\nstatic int rkisp1_params_init_vb2_queue(struct vb2_queue *q,\n\t\t\t\t\tstruct rkisp1_params *params)\n{\n\tstruct rkisp1_vdev_node *node;\n\n\tnode = container_of(q, struct rkisp1_vdev_node, buf_queue);\n\n\tq->type = V4L2_BUF_TYPE_META_OUTPUT;\n\tq->io_modes = VB2_MMAP | VB2_USERPTR | VB2_DMABUF;\n\tq->drv_priv = params;\n\tq->ops = &rkisp1_params_vb2_ops;\n\tq->mem_ops = &vb2_vmalloc_memops;\n\tq->buf_struct_size = sizeof(struct rkisp1_buffer);\n\tq->timestamp_flags = V4L2_BUF_FLAG_TIMESTAMP_MONOTONIC;\n\tq->lock = &node->vlock;\n\n\treturn vb2_queue_init(q);\n}\n\nstatic void rkisp1_init_params(struct rkisp1_params *params)\n{\n\tparams->vdev_fmt.fmt.meta.dataformat =\n\t\tV4L2_META_FMT_RK_ISP1_PARAMS;\n\tparams->vdev_fmt.fmt.meta.buffersize =\n\t\tsizeof(struct rkisp1_params_cfg);\n\n\tif (params->rkisp1->info->isp_ver == RKISP1_V12)\n\t\tparams->ops = &rkisp1_v12_params_ops;\n\telse\n\t\tparams->ops = &rkisp1_v10_params_ops;\n}\n\nint rkisp1_params_register(struct rkisp1_device *rkisp1)\n{\n\tstruct rkisp1_params *params = &rkisp1->params;\n\tstruct rkisp1_vdev_node *node = &params->vnode;\n\tstruct video_device *vdev = &node->vdev;\n\tint ret;\n\n\tparams->rkisp1 = rkisp1;\n\tmutex_init(&node->vlock);\n\tINIT_LIST_HEAD(&params->params);\n\tspin_lock_init(&params->config_lock);\n\n\tstrscpy(vdev->name, RKISP1_PARAMS_DEV_NAME, sizeof(vdev->name));\n\n\tvideo_set_drvdata(vdev, params);\n\tvdev->ioctl_ops = &rkisp1_params_ioctl;\n\tvdev->fops = &rkisp1_params_fops;\n\tvdev->release = video_device_release_empty;\n\t \n\tvdev->lock = &node->vlock;\n\tvdev->v4l2_dev = &rkisp1->v4l2_dev;\n\tvdev->queue = &node->buf_queue;\n\tvdev->device_caps = V4L2_CAP_STREAMING | V4L2_CAP_META_OUTPUT;\n\tvdev->vfl_dir = VFL_DIR_TX;\n\trkisp1_params_init_vb2_queue(vdev->queue, params);\n\trkisp1_init_params(params);\n\tvideo_set_drvdata(vdev, params);\n\n\tnode->pad.flags = MEDIA_PAD_FL_SOURCE;\n\tret = media_entity_pads_init(&vdev->entity, 1, &node->pad);\n\tif (ret)\n\t\tgoto error;\n\n\tret = video_register_device(vdev, VFL_TYPE_VIDEO, -1);\n\tif (ret) {\n\t\tdev_err(rkisp1->dev,\n\t\t\t\"failed to register %s, ret=%d\\n\", vdev->name, ret);\n\t\tgoto error;\n\t}\n\n\treturn 0;\n\nerror:\n\tmedia_entity_cleanup(&vdev->entity);\n\tmutex_destroy(&node->vlock);\n\treturn ret;\n}\n\nvoid rkisp1_params_unregister(struct rkisp1_device *rkisp1)\n{\n\tstruct rkisp1_params *params = &rkisp1->params;\n\tstruct rkisp1_vdev_node *node = &params->vnode;\n\tstruct video_device *vdev = &node->vdev;\n\n\tif (!video_is_registered(vdev))\n\t\treturn;\n\n\tvb2_video_unregister_device(vdev);\n\tmedia_entity_cleanup(&vdev->entity);\n\tmutex_destroy(&node->vlock);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}