{
  "module_name": "rkisp1-debug.c",
  "hash_id": "920ee043b5937913244fda06b5d653051e604f3a94fd7a005e96c6d3e197675b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/rockchip/rkisp1/rkisp1-debug.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/minmax.h>\n#include <linux/pm_runtime.h>\n#include <linux/seq_file.h>\n#include <linux/string.h>\n\n#include \"rkisp1-common.h\"\n#include \"rkisp1-regs.h\"\n\nstruct rkisp1_debug_register {\n\tu32 reg;\n\tu32 shd;\n\tconst char * const name;\n};\n\n#define RKISP1_DEBUG_REG(name)\t\t{ RKISP1_CIF_##name, 0, #name }\n#define RKISP1_DEBUG_SHD_REG(name) { \\\n\tRKISP1_CIF_##name, RKISP1_CIF_##name##_SHD, #name \\\n}\n\n \n#define RKISP1_MAX_REG_LENGTH\t\t21\n\nstatic int rkisp1_debug_dump_regs(struct rkisp1_device *rkisp1,\n\t\t\t\t  struct seq_file *m, unsigned int offset,\n\t\t\t\t  const struct rkisp1_debug_register *regs)\n{\n\tconst int width = RKISP1_MAX_REG_LENGTH;\n\tu32 val, shd;\n\tint ret;\n\n\tret = pm_runtime_get_if_in_use(rkisp1->dev);\n\tif (ret <= 0)\n\t\treturn ret ? : -ENODATA;\n\n\tfor (; regs->name; ++regs) {\n\t\tval = rkisp1_read(rkisp1, offset + regs->reg);\n\n\t\tif (regs->shd) {\n\t\t\tshd = rkisp1_read(rkisp1, offset + regs->shd);\n\t\t\tseq_printf(m, \"%*s: 0x%08x/0x%08x\\n\", width, regs->name,\n\t\t\t\t   val, shd);\n\t\t} else {\n\t\t\tseq_printf(m, \"%*s: 0x%08x\\n\", width, regs->name, val);\n\t\t}\n\t}\n\n\tpm_runtime_put(rkisp1->dev);\n\n\treturn 0;\n}\n\nstatic int rkisp1_debug_dump_core_regs_show(struct seq_file *m, void *p)\n{\n\tstatic const struct rkisp1_debug_register registers[] = {\n\t\tRKISP1_DEBUG_REG(VI_CCL),\n\t\tRKISP1_DEBUG_REG(VI_ICCL),\n\t\tRKISP1_DEBUG_REG(VI_IRCL),\n\t\tRKISP1_DEBUG_REG(VI_DPCL),\n\t\tRKISP1_DEBUG_REG(MI_CTRL),\n\t\tRKISP1_DEBUG_REG(MI_BYTE_CNT),\n\t\tRKISP1_DEBUG_REG(MI_CTRL_SHD),\n\t\tRKISP1_DEBUG_REG(MI_RIS),\n\t\tRKISP1_DEBUG_REG(MI_STATUS),\n\t\tRKISP1_DEBUG_REG(MI_DMA_CTRL),\n\t\tRKISP1_DEBUG_REG(MI_DMA_STATUS),\n\t\t{   },\n\t};\n\tstruct rkisp1_device *rkisp1 = m->private;\n\n\treturn rkisp1_debug_dump_regs(rkisp1, m, 0, registers);\n}\nDEFINE_SHOW_ATTRIBUTE(rkisp1_debug_dump_core_regs);\n\nstatic int rkisp1_debug_dump_isp_regs_show(struct seq_file *m, void *p)\n{\n\tstatic const struct rkisp1_debug_register registers[] = {\n\t\tRKISP1_DEBUG_REG(ISP_CTRL),\n\t\tRKISP1_DEBUG_REG(ISP_ACQ_PROP),\n\t\tRKISP1_DEBUG_REG(ISP_FLAGS_SHD),\n\t\tRKISP1_DEBUG_REG(ISP_RIS),\n\t\tRKISP1_DEBUG_REG(ISP_ERR),\n\t\t{   },\n\t};\n\tstruct rkisp1_device *rkisp1 = m->private;\n\n\treturn rkisp1_debug_dump_regs(rkisp1, m, 0, registers);\n}\nDEFINE_SHOW_ATTRIBUTE(rkisp1_debug_dump_isp_regs);\n\nstatic int rkisp1_debug_dump_rsz_regs_show(struct seq_file *m, void *p)\n{\n\tstatic const struct rkisp1_debug_register registers[] = {\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_CTRL),\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_SCALE_HY),\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_SCALE_HCB),\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_SCALE_HCR),\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_SCALE_VY),\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_SCALE_VC),\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_PHASE_HY),\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_PHASE_HC),\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_PHASE_VY),\n\t\tRKISP1_DEBUG_SHD_REG(RSZ_PHASE_VC),\n\t\t{   },\n\t};\n\tstruct rkisp1_resizer *rsz = m->private;\n\n\treturn rkisp1_debug_dump_regs(rsz->rkisp1, m, rsz->regs_base, registers);\n}\nDEFINE_SHOW_ATTRIBUTE(rkisp1_debug_dump_rsz_regs);\n\nstatic int rkisp1_debug_dump_mi_mp_show(struct seq_file *m, void *p)\n{\n\tstatic const struct rkisp1_debug_register registers[] = {\n\t\tRKISP1_DEBUG_REG(MI_MP_Y_BASE_AD_INIT),\n\t\tRKISP1_DEBUG_REG(MI_MP_Y_BASE_AD_INIT2),\n\t\tRKISP1_DEBUG_REG(MI_MP_Y_BASE_AD_SHD),\n\t\tRKISP1_DEBUG_REG(MI_MP_Y_SIZE_INIT),\n\t\tRKISP1_DEBUG_REG(MI_MP_Y_SIZE_INIT),\n\t\tRKISP1_DEBUG_REG(MI_MP_Y_SIZE_SHD),\n\t\tRKISP1_DEBUG_REG(MI_MP_Y_OFFS_CNT_SHD),\n\t\t{   },\n\t};\n\tstruct rkisp1_device *rkisp1 = m->private;\n\n\treturn rkisp1_debug_dump_regs(rkisp1, m, 0, registers);\n}\nDEFINE_SHOW_ATTRIBUTE(rkisp1_debug_dump_mi_mp);\n\n#define RKISP1_DEBUG_DATA_COUNT_BINS\t32\n#define RKISP1_DEBUG_DATA_COUNT_STEP\t(4096 / RKISP1_DEBUG_DATA_COUNT_BINS)\n\nstatic int rkisp1_debug_input_status_show(struct seq_file *m, void *p)\n{\n\tstruct rkisp1_device *rkisp1 = m->private;\n\tu16 data_count[RKISP1_DEBUG_DATA_COUNT_BINS] = { };\n\tunsigned int hsync_count = 0;\n\tunsigned int vsync_count = 0;\n\tunsigned int i;\n\tu32 data;\n\tu32 val;\n\tint ret;\n\n\tret = pm_runtime_get_if_in_use(rkisp1->dev);\n\tif (ret <= 0)\n\t\treturn ret ? : -ENODATA;\n\n\t \n\tfor (i = 0; i < 10000; ++i) {\n\t\tval = rkisp1_read(rkisp1, RKISP1_CIF_ISP_FLAGS_SHD);\n\n\t\tdata = (val & RKISP1_CIF_ISP_FLAGS_SHD_S_DATA_MASK)\n\t\t     >> RKISP1_CIF_ISP_FLAGS_SHD_S_DATA_SHIFT;\n\t\tdata_count[data / RKISP1_DEBUG_DATA_COUNT_STEP]++;\n\n\t\tif (val & RKISP1_CIF_ISP_FLAGS_SHD_S_HSYNC)\n\t\t\thsync_count++;\n\t\tif (val & RKISP1_CIF_ISP_FLAGS_SHD_S_VSYNC)\n\t\t\tvsync_count++;\n\n\t\tudelay(1);\n\t}\n\n\tpm_runtime_put(rkisp1->dev);\n\n\tseq_printf(m, \"vsync: %u, hsync: %u\\n\", vsync_count, hsync_count);\n\tseq_puts(m, \"data:\\n\");\n\tfor (i = 0; i < ARRAY_SIZE(data_count); ++i)\n\t\tseq_printf(m, \"- [%04u:%04u]: %u\\n\",\n\t\t\t   i * RKISP1_DEBUG_DATA_COUNT_STEP,\n\t\t\t   (i + 1) * RKISP1_DEBUG_DATA_COUNT_STEP - 1,\n\t\t\t   data_count[i]);\n\n\treturn 0;\n}\nDEFINE_SHOW_ATTRIBUTE(rkisp1_debug_input_status);\n\nvoid rkisp1_debug_init(struct rkisp1_device *rkisp1)\n{\n\tstruct rkisp1_debug *debug = &rkisp1->debug;\n\tstruct dentry *regs_dir;\n\n\tdebug->debugfs_dir = debugfs_create_dir(dev_name(rkisp1->dev), NULL);\n\n\tdebugfs_create_ulong(\"data_loss\", 0444, debug->debugfs_dir,\n\t\t\t     &debug->data_loss);\n\tdebugfs_create_ulong(\"outform_size_err\", 0444,  debug->debugfs_dir,\n\t\t\t     &debug->outform_size_error);\n\tdebugfs_create_ulong(\"img_stabilization_size_error\", 0444,\n\t\t\t     debug->debugfs_dir,\n\t\t\t     &debug->img_stabilization_size_error);\n\tdebugfs_create_ulong(\"inform_size_error\", 0444,  debug->debugfs_dir,\n\t\t\t     &debug->inform_size_error);\n\tdebugfs_create_ulong(\"irq_delay\", 0444,  debug->debugfs_dir,\n\t\t\t     &debug->irq_delay);\n\tdebugfs_create_ulong(\"mipi_error\", 0444, debug->debugfs_dir,\n\t\t\t     &debug->mipi_error);\n\tdebugfs_create_ulong(\"stats_error\", 0444, debug->debugfs_dir,\n\t\t\t     &debug->stats_error);\n\tdebugfs_create_ulong(\"mp_stop_timeout\", 0444, debug->debugfs_dir,\n\t\t\t     &debug->stop_timeout[RKISP1_MAINPATH]);\n\tdebugfs_create_ulong(\"sp_stop_timeout\", 0444, debug->debugfs_dir,\n\t\t\t     &debug->stop_timeout[RKISP1_SELFPATH]);\n\tdebugfs_create_ulong(\"mp_frame_drop\", 0444, debug->debugfs_dir,\n\t\t\t     &debug->frame_drop[RKISP1_MAINPATH]);\n\tdebugfs_create_ulong(\"sp_frame_drop\", 0444, debug->debugfs_dir,\n\t\t\t     &debug->frame_drop[RKISP1_SELFPATH]);\n\tdebugfs_create_file(\"input_status\", 0444, debug->debugfs_dir, rkisp1,\n\t\t\t    &rkisp1_debug_input_status_fops);\n\n\tregs_dir = debugfs_create_dir(\"regs\", debug->debugfs_dir);\n\n\tdebugfs_create_file(\"core\", 0444, regs_dir, rkisp1,\n\t\t\t    &rkisp1_debug_dump_core_regs_fops);\n\tdebugfs_create_file(\"isp\", 0444, regs_dir, rkisp1,\n\t\t\t    &rkisp1_debug_dump_isp_regs_fops);\n\tdebugfs_create_file(\"mrsz\", 0444, regs_dir,\n\t\t\t    &rkisp1->resizer_devs[RKISP1_MAINPATH],\n\t\t\t    &rkisp1_debug_dump_rsz_regs_fops);\n\tdebugfs_create_file(\"srsz\", 0444, regs_dir,\n\t\t\t    &rkisp1->resizer_devs[RKISP1_SELFPATH],\n\t\t\t    &rkisp1_debug_dump_rsz_regs_fops);\n\n\tdebugfs_create_file(\"mi_mp\", 0444, regs_dir, rkisp1,\n\t\t\t    &rkisp1_debug_dump_mi_mp_fops);\n}\n\nvoid rkisp1_debug_cleanup(struct rkisp1_device *rkisp1)\n{\n\tdebugfs_remove_recursive(rkisp1->debug.debugfs_dir);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}