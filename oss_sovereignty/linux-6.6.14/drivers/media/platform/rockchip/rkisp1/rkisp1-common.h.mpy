{
  "module_name": "rkisp1-common.h",
  "hash_id": "0d8c9cebb8cde5150e2780dd69708dbcf42608a5cda619505e47b7a44c40047a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/rockchip/rkisp1/rkisp1-common.h",
  "human_readable_source": " \n \n\n#ifndef _RKISP1_COMMON_H\n#define _RKISP1_COMMON_H\n\n#include <linux/clk.h>\n#include <linux/interrupt.h>\n#include <linux/mutex.h>\n#include <linux/rkisp1-config.h>\n#include <media/media-device.h>\n#include <media/media-entity.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-device.h>\n#include <media/videobuf2-v4l2.h>\n\n#include \"rkisp1-regs.h\"\n\nstruct dentry;\n\n \n#define RKISP1_ISP_SD_SRC\t\t\tBIT(0)\n#define RKISP1_ISP_SD_SINK\t\t\tBIT(1)\n\n \n#define RKISP1_ISP_MAX_WIDTH\t\t\t4032\n#define RKISP1_ISP_MAX_HEIGHT\t\t\t3024\n#define RKISP1_ISP_MIN_WIDTH\t\t\t32\n#define RKISP1_ISP_MIN_HEIGHT\t\t\t32\n\n#define RKISP1_RSZ_MP_SRC_MAX_WIDTH\t\t4416\n#define RKISP1_RSZ_MP_SRC_MAX_HEIGHT\t\t3312\n#define RKISP1_RSZ_SP_SRC_MAX_WIDTH\t\t1920\n#define RKISP1_RSZ_SP_SRC_MAX_HEIGHT\t\t1920\n#define RKISP1_RSZ_SRC_MIN_WIDTH\t\t32\n#define RKISP1_RSZ_SRC_MIN_HEIGHT\t\t16\n\n \n#define RKISP1_DEFAULT_WIDTH\t\t\t800\n#define RKISP1_DEFAULT_HEIGHT\t\t\t600\n\n#define RKISP1_DRIVER_NAME\t\t\t\"rkisp1\"\n#define RKISP1_BUS_INFO\t\t\t\t\"platform:\" RKISP1_DRIVER_NAME\n\n \n#define RKISP1_MAX_BUS_CLK\t\t\t8\n\n \n#define RKISP1_STATS_MEAS_MASK\t\t\t(RKISP1_CIF_ISP_AWB_DONE |\t\\\n\t\t\t\t\t\t RKISP1_CIF_ISP_AFM_FIN |\t\\\n\t\t\t\t\t\t RKISP1_CIF_ISP_EXP_END |\t\\\n\t\t\t\t\t\t RKISP1_CIF_ISP_HIST_MEASURE_RDY)\n\n \nenum rkisp1_rsz_pad {\n\tRKISP1_RSZ_PAD_SINK,\n\tRKISP1_RSZ_PAD_SRC,\n\tRKISP1_RSZ_PAD_MAX\n};\n\n \nenum rkisp1_csi_pad {\n\tRKISP1_CSI_PAD_SINK,\n\tRKISP1_CSI_PAD_SRC,\n\tRKISP1_CSI_PAD_NUM\n};\n\n \nenum rkisp1_stream_id {\n\tRKISP1_MAINPATH,\n\tRKISP1_SELFPATH,\n};\n\n \nenum rkisp1_fmt_raw_pat_type {\n\tRKISP1_RAW_RGGB = 0,\n\tRKISP1_RAW_GRBG,\n\tRKISP1_RAW_GBRG,\n\tRKISP1_RAW_BGGR,\n};\n\n \nenum rkisp1_isp_pad {\n\tRKISP1_ISP_PAD_SINK_VIDEO,\n\tRKISP1_ISP_PAD_SINK_PARAMS,\n\tRKISP1_ISP_PAD_SOURCE_VIDEO,\n\tRKISP1_ISP_PAD_SOURCE_STATS,\n\tRKISP1_ISP_PAD_MAX\n};\n\n \nenum rkisp1_feature {\n\tRKISP1_FEATURE_MIPI_CSI2 = BIT(0),\n};\n\n \nstruct rkisp1_info {\n\tconst char * const *clks;\n\tunsigned int clk_size;\n\tconst struct rkisp1_isr_data *isrs;\n\tunsigned int isr_size;\n\tenum rkisp1_cif_isp_version isp_ver;\n\tunsigned int features;\n};\n\n \nstruct rkisp1_sensor_async {\n\tstruct v4l2_async_connection asd;\n\tunsigned int index;\n\tstruct fwnode_handle *source_ep;\n\tunsigned int lanes;\n\tenum v4l2_mbus_type mbus_type;\n\tunsigned int mbus_flags;\n\tstruct v4l2_subdev *sd;\n\tstruct v4l2_ctrl *pixel_rate_ctrl;\n\tunsigned int port;\n};\n\n \nstruct rkisp1_csi {\n\tstruct rkisp1_device *rkisp1;\n\tstruct phy *dphy;\n\tbool is_dphy_errctrl_disabled;\n\tstruct v4l2_subdev sd;\n\tstruct media_pad pads[RKISP1_CSI_PAD_NUM];\n\tstruct v4l2_subdev_pad_config pad_cfg[RKISP1_CSI_PAD_NUM];\n\tconst struct rkisp1_mbus_info *sink_fmt;\n\tstruct mutex lock;\n\tstruct v4l2_subdev *source;\n};\n\n \nstruct rkisp1_isp {\n\tstruct v4l2_subdev sd;\n\tstruct rkisp1_device *rkisp1;\n\tstruct media_pad pads[RKISP1_ISP_PAD_MAX];\n\tstruct v4l2_subdev_pad_config pad_cfg[RKISP1_ISP_PAD_MAX];\n\tconst struct rkisp1_mbus_info *sink_fmt;\n\tconst struct rkisp1_mbus_info *src_fmt;\n\tstruct mutex ops_lock;  \n\t__u32 frame_sequence;\n};\n\n \nstruct rkisp1_vdev_node {\n\tstruct vb2_queue buf_queue;\n\tstruct mutex vlock;  \n\tstruct video_device vdev;\n\tstruct media_pad pad;\n};\n\n \nstruct rkisp1_buffer {\n\tstruct vb2_v4l2_buffer vb;\n\tstruct list_head queue;\n\tu32 buff_addr[VIDEO_MAX_PLANES];\n};\n\n \nstruct rkisp1_dummy_buffer {\n\tvoid *vaddr;\n\tdma_addr_t dma_addr;\n\tu32 size;\n};\n\nstruct rkisp1_device;\n\n \nstruct rkisp1_capture {\n\tstruct rkisp1_vdev_node vnode;\n\tstruct rkisp1_device *rkisp1;\n\tenum rkisp1_stream_id id;\n\tconst struct rkisp1_capture_ops *ops;\n\tconst struct rkisp1_capture_config *config;\n\tbool is_streaming;\n\tbool is_stopping;\n\twait_queue_head_t done;\n\tunsigned int sp_y_stride;\n\tstruct {\n\t\t \n\t\tspinlock_t lock;\n\t\tstruct list_head queue;\n\t\tstruct rkisp1_dummy_buffer dummy;\n\t\tstruct rkisp1_buffer *curr;\n\t\tstruct rkisp1_buffer *next;\n\t} buf;\n\tstruct {\n\t\tconst struct rkisp1_capture_fmt_cfg *cfg;\n\t\tconst struct v4l2_format_info *info;\n\t\tstruct v4l2_pix_format_mplane fmt;\n\t} pix;\n};\n\nstruct rkisp1_stats;\nstruct rkisp1_stats_ops {\n\tvoid (*get_awb_meas)(struct rkisp1_stats *stats,\n\t\t\t     struct rkisp1_stat_buffer *pbuf);\n\tvoid (*get_aec_meas)(struct rkisp1_stats *stats,\n\t\t\t     struct rkisp1_stat_buffer *pbuf);\n\tvoid (*get_hst_meas)(struct rkisp1_stats *stats,\n\t\t\t     struct rkisp1_stat_buffer *pbuf);\n};\n\n \nstruct rkisp1_stats {\n\tstruct rkisp1_vdev_node vnode;\n\tstruct rkisp1_device *rkisp1;\n\tconst struct rkisp1_stats_ops *ops;\n\n\tspinlock_t lock;  \n\tstruct list_head stat;\n\tstruct v4l2_format vdev_fmt;\n};\n\nstruct rkisp1_params;\nstruct rkisp1_params_ops {\n\tvoid (*lsc_matrix_config)(struct rkisp1_params *params,\n\t\t\t\t  const struct rkisp1_cif_isp_lsc_config *pconfig);\n\tvoid (*goc_config)(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_goc_config *arg);\n\tvoid (*awb_meas_config)(struct rkisp1_params *params,\n\t\t\t\tconst struct rkisp1_cif_isp_awb_meas_config *arg);\n\tvoid (*awb_meas_enable)(struct rkisp1_params *params,\n\t\t\t\tconst struct rkisp1_cif_isp_awb_meas_config *arg,\n\t\t\t\tbool en);\n\tvoid (*awb_gain_config)(struct rkisp1_params *params,\n\t\t\t\tconst struct rkisp1_cif_isp_awb_gain_config *arg);\n\tvoid (*aec_config)(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_aec_config *arg);\n\tvoid (*hst_config)(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_hst_config *arg);\n\tvoid (*hst_enable)(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_hst_config *arg, bool en);\n\tvoid (*afm_config)(struct rkisp1_params *params,\n\t\t\t   const struct rkisp1_cif_isp_afc_config *arg);\n};\n\n \nstruct rkisp1_params {\n\tstruct rkisp1_vdev_node vnode;\n\tstruct rkisp1_device *rkisp1;\n\tconst struct rkisp1_params_ops *ops;\n\n\tspinlock_t config_lock;  \n\tstruct list_head params;\n\tstruct v4l2_format vdev_fmt;\n\n\tenum v4l2_quantization quantization;\n\tenum v4l2_ycbcr_encoding ycbcr_encoding;\n\tenum rkisp1_fmt_raw_pat_type raw_type;\n};\n\n \nstruct rkisp1_resizer {\n\tstruct v4l2_subdev sd;\n\tu32 regs_base;\n\tenum rkisp1_stream_id id;\n\tstruct rkisp1_device *rkisp1;\n\tstruct media_pad pads[RKISP1_RSZ_PAD_MAX];\n\tstruct v4l2_subdev_pad_config pad_cfg[RKISP1_RSZ_PAD_MAX];\n\tconst struct rkisp1_rsz_config *config;\n\tenum v4l2_pixel_encoding pixel_enc;\n\tstruct mutex ops_lock;  \n};\n\n \nstruct rkisp1_debug {\n\tstruct dentry *debugfs_dir;\n\tunsigned long data_loss;\n\tunsigned long outform_size_error;\n\tunsigned long img_stabilization_size_error;\n\tunsigned long inform_size_error;\n\tunsigned long irq_delay;\n\tunsigned long mipi_error;\n\tunsigned long stats_error;\n\tunsigned long stop_timeout[2];\n\tunsigned long frame_drop[2];\n};\n\n \nstruct rkisp1_device {\n\tvoid __iomem *base_addr;\n\tstruct device *dev;\n\tunsigned int clk_size;\n\tstruct clk_bulk_data clks[RKISP1_MAX_BUS_CLK];\n\tstruct v4l2_device v4l2_dev;\n\tstruct media_device media_dev;\n\tstruct v4l2_async_notifier notifier;\n\tstruct v4l2_subdev *source;\n\tstruct rkisp1_csi csi;\n\tstruct rkisp1_isp isp;\n\tstruct rkisp1_resizer resizer_devs[2];\n\tstruct rkisp1_capture capture_devs[2];\n\tstruct rkisp1_stats stats;\n\tstruct rkisp1_params params;\n\tstruct media_pipeline pipe;\n\tstruct mutex stream_lock;  \n\tstruct rkisp1_debug debug;\n\tconst struct rkisp1_info *info;\n};\n\n \nstruct rkisp1_mbus_info {\n\tu32 mbus_code;\n\tenum v4l2_pixel_encoding pixel_enc;\n\tu32 mipi_dt;\n\tu32 yuv_seq;\n\tu8 bus_width;\n\tenum rkisp1_fmt_raw_pat_type bayer_pat;\n\tunsigned int direction;\n};\n\nstatic inline void\nrkisp1_write(struct rkisp1_device *rkisp1, unsigned int addr, u32 val)\n{\n\twritel(val, rkisp1->base_addr + addr);\n}\n\nstatic inline u32 rkisp1_read(struct rkisp1_device *rkisp1, unsigned int addr)\n{\n\treturn readl(rkisp1->base_addr + addr);\n}\n\n \nint rkisp1_cap_enum_mbus_codes(struct rkisp1_capture *cap,\n\t\t\t       struct v4l2_subdev_mbus_code_enum *code);\n\n \nconst struct rkisp1_mbus_info *rkisp1_mbus_info_get_by_index(unsigned int index);\n\n \nvoid rkisp1_sd_adjust_crop_rect(struct v4l2_rect *crop,\n\t\t\t\tconst struct v4l2_rect *bounds);\n\n \nvoid rkisp1_sd_adjust_crop(struct v4l2_rect *crop,\n\t\t\t   const struct v4l2_mbus_framefmt *bounds);\n\n \nconst struct rkisp1_mbus_info *rkisp1_mbus_info_get_by_code(u32 mbus_code);\n\n \nvoid rkisp1_params_pre_configure(struct rkisp1_params *params,\n\t\t\t\t enum rkisp1_fmt_raw_pat_type bayer_pat,\n\t\t\t\t enum v4l2_quantization quantization,\n\t\t\t\t enum v4l2_ycbcr_encoding ycbcr_encoding);\n\n \nvoid rkisp1_params_post_configure(struct rkisp1_params *params);\n\n \nvoid rkisp1_params_disable(struct rkisp1_params *params);\n\n \nirqreturn_t rkisp1_isp_isr(int irq, void *ctx);\nirqreturn_t rkisp1_csi_isr(int irq, void *ctx);\nirqreturn_t rkisp1_capture_isr(int irq, void *ctx);\nvoid rkisp1_stats_isr(struct rkisp1_stats *stats, u32 isp_ris);\nvoid rkisp1_params_isr(struct rkisp1_device *rkisp1);\n\n \nint rkisp1_capture_devs_register(struct rkisp1_device *rkisp1);\nvoid rkisp1_capture_devs_unregister(struct rkisp1_device *rkisp1);\n\nint rkisp1_isp_register(struct rkisp1_device *rkisp1);\nvoid rkisp1_isp_unregister(struct rkisp1_device *rkisp1);\n\nint rkisp1_resizer_devs_register(struct rkisp1_device *rkisp1);\nvoid rkisp1_resizer_devs_unregister(struct rkisp1_device *rkisp1);\n\nint rkisp1_stats_register(struct rkisp1_device *rkisp1);\nvoid rkisp1_stats_unregister(struct rkisp1_device *rkisp1);\n\nint rkisp1_params_register(struct rkisp1_device *rkisp1);\nvoid rkisp1_params_unregister(struct rkisp1_device *rkisp1);\n\n#if IS_ENABLED(CONFIG_DEBUG_FS)\nvoid rkisp1_debug_init(struct rkisp1_device *rkisp1);\nvoid rkisp1_debug_cleanup(struct rkisp1_device *rkisp1);\n#else\nstatic inline void rkisp1_debug_init(struct rkisp1_device *rkisp1)\n{\n}\nstatic inline void rkisp1_debug_cleanup(struct rkisp1_device *rkisp1)\n{\n}\n#endif\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}