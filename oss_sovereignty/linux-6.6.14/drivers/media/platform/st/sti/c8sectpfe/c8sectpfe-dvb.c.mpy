{
  "module_name": "c8sectpfe-dvb.c",
  "hash_id": "fa9a54f2bb69cbfee5c96873c6737e15b629b63820990f95d808f131977f7035",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/st/sti/c8sectpfe/c8sectpfe-dvb.c",
  "human_readable_source": "\n \n#include <linux/completion.h>\n#include <linux/delay.h>\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n\n#include <dt-bindings/media/c8sectpfe.h>\n\n#include \"c8sectpfe-common.h\"\n#include \"c8sectpfe-core.h\"\n#include \"c8sectpfe-dvb.h\"\n\n#include \"dvb-pll.h\"\n#include \"lnbh24.h\"\n#include \"stv0367.h\"\n#include \"stv0367_priv.h\"\n#include \"stv6110x.h\"\n#include \"stv090x.h\"\n#include \"tda18212.h\"\n\nstatic inline const char *dvb_card_str(unsigned int c)\n{\n\tswitch (c) {\n\tcase STV0367_TDA18212_NIMA_1:\treturn \"STV0367_TDA18212_NIMA_1\";\n\tcase STV0367_TDA18212_NIMA_2:\treturn \"STV0367_TDA18212_NIMA_2\";\n\tcase STV0367_TDA18212_NIMB_1:\treturn \"STV0367_TDA18212_NIMB_1\";\n\tcase STV0367_TDA18212_NIMB_2:\treturn \"STV0367_TDA18212_NIMB_2\";\n\tcase STV0903_6110_LNB24_NIMA:\treturn \"STV0903_6110_LNB24_NIMA\";\n\tcase STV0903_6110_LNB24_NIMB:\treturn \"STV0903_6110_LNB24_NIMB\";\n\tdefault:\t\t\treturn \"unknown dvb frontend card\";\n\t}\n}\n\nstatic struct stv090x_config stv090x_config = {\n\t.device                 = STV0903,\n\t.demod_mode             = STV090x_SINGLE,\n\t.clk_mode               = STV090x_CLK_EXT,\n\t.xtal                   = 16000000,\n\t.address                = 0x69,\n\n\t.ts1_mode               = STV090x_TSMODE_SERIAL_CONTINUOUS,\n\t.ts2_mode               = STV090x_TSMODE_SERIAL_CONTINUOUS,\n\n\t.repeater_level         = STV090x_RPTLEVEL_64,\n\n\t.tuner_init             = NULL,\n\t.tuner_set_mode         = NULL,\n\t.tuner_set_frequency    = NULL,\n\t.tuner_get_frequency    = NULL,\n\t.tuner_set_bandwidth    = NULL,\n\t.tuner_get_bandwidth    = NULL,\n\t.tuner_set_bbgain       = NULL,\n\t.tuner_get_bbgain       = NULL,\n\t.tuner_set_refclk       = NULL,\n\t.tuner_get_status       = NULL,\n};\n\nstatic struct stv6110x_config stv6110x_config = {\n\t.addr                   = 0x60,\n\t.refclk                 = 16000000,\n};\n\n#define NIMA 0\n#define NIMB 1\n\nstatic struct stv0367_config stv0367_tda18212_config[] = {\n\t{\n\t\t.demod_address = 0x1c,\n\t\t.xtal = 16000000,\n\t\t.if_khz = 4500,\n\t\t.if_iq_mode = FE_TER_NORMAL_IF_TUNER,\n\t\t.ts_mode = STV0367_SERIAL_PUNCT_CLOCK,\n\t\t.clk_pol = STV0367_CLOCKPOLARITY_DEFAULT,\n\t}, {\n\t\t.demod_address = 0x1d,\n\t\t.xtal = 16000000,\n\t\t.if_khz = 4500,\n\t\t.if_iq_mode = FE_TER_NORMAL_IF_TUNER,\n\t\t.ts_mode = STV0367_SERIAL_PUNCT_CLOCK,\n\t\t.clk_pol = STV0367_CLOCKPOLARITY_DEFAULT,\n\t}, {\n\t\t.demod_address = 0x1e,\n\t\t.xtal = 16000000,\n\t\t.if_khz = 4500,\n\t\t.if_iq_mode = FE_TER_NORMAL_IF_TUNER,\n\t\t.ts_mode = STV0367_SERIAL_PUNCT_CLOCK,\n\t\t.clk_pol = STV0367_CLOCKPOLARITY_DEFAULT,\n\t},\n};\n\nstatic struct tda18212_config tda18212_conf = {\n\t.if_dvbt_6 = 4150,\n\t.if_dvbt_7 = 4150,\n\t.if_dvbt_8 = 4500,\n\t.if_dvbc = 5000,\n};\n\nint c8sectpfe_frontend_attach(struct dvb_frontend **fe,\n\t\tstruct c8sectpfe *c8sectpfe,\n\t\tstruct channel_info *tsin, int chan_num)\n{\n\tstruct tda18212_config *tda18212;\n\tconst struct stv6110x_devctl *fe2;\n\tstruct i2c_client *client;\n\tstruct i2c_board_info tda18212_info = {\n\t\t.type = \"tda18212\",\n\t\t.addr = 0x60,\n\t};\n\n\tif (!tsin)\n\t\treturn -EINVAL;\n\n\tswitch (tsin->dvb_card) {\n\n\tcase STV0367_TDA18212_NIMA_1:\n\tcase STV0367_TDA18212_NIMA_2:\n\tcase STV0367_TDA18212_NIMB_1:\n\tcase STV0367_TDA18212_NIMB_2:\n\t\tif (tsin->dvb_card == STV0367_TDA18212_NIMA_1)\n\t\t\t*fe = dvb_attach(stv0367ter_attach,\n\t\t\t\t &stv0367_tda18212_config[0],\n\t\t\t\t\ttsin->i2c_adapter);\n\t\telse if (tsin->dvb_card == STV0367_TDA18212_NIMB_1)\n\t\t\t*fe = dvb_attach(stv0367ter_attach,\n\t\t\t\t &stv0367_tda18212_config[1],\n\t\t\t\t\ttsin->i2c_adapter);\n\t\telse\n\t\t\t*fe = dvb_attach(stv0367ter_attach,\n\t\t\t\t &stv0367_tda18212_config[2],\n\t\t\t\t\ttsin->i2c_adapter);\n\n\t\tif (!*fe) {\n\t\t\tdev_err(c8sectpfe->device,\n\t\t\t\t\"%s: stv0367ter_attach failed for NIM card %s\\n\"\n\t\t\t\t, __func__, dvb_card_str(tsin->dvb_card));\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\t \n\t\t(*fe)->ops.init(*fe);\n\n\t\t \n\t\ttda18212 = devm_kzalloc(c8sectpfe->device,\n\t\t\t\t\tsizeof(struct tda18212_config),\n\t\t\t\t\tGFP_KERNEL);\n\t\tif (!tda18212) {\n\t\t\tdev_err(c8sectpfe->device,\n\t\t\t\t\"%s: devm_kzalloc failed\\n\", __func__);\n\t\t\treturn -ENOMEM;\n\t\t}\n\n\t\tmemcpy(tda18212, &tda18212_conf,\n\t\t\tsizeof(struct tda18212_config));\n\n\t\ttda18212->fe = (*fe);\n\n\t\ttda18212_info.platform_data = tda18212;\n\n\t\t \n\t\trequest_module(\"tda18212\");\n\t\tclient = i2c_new_client_device(tsin->i2c_adapter,\n\t\t\t\t\t       &tda18212_info);\n\t\tif (!i2c_client_has_driver(client)) {\n\t\t\tdvb_frontend_detach(*fe);\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\tif (!try_module_get(client->dev.driver->owner)) {\n\t\t\ti2c_unregister_device(client);\n\t\t\tdvb_frontend_detach(*fe);\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\ttsin->i2c_client = client;\n\n\t\tbreak;\n\n\tcase STV0903_6110_LNB24_NIMA:\n\t\t*fe = dvb_attach(stv090x_attach,\t&stv090x_config,\n\t\t\t\ttsin->i2c_adapter, STV090x_DEMODULATOR_0);\n\t\tif (!*fe) {\n\t\t\tdev_err(c8sectpfe->device, \"%s: stv090x_attach failed\\n\"\n\t\t\t\t\"\\tfor NIM card %s\\n\",\n\t\t\t\t__func__, dvb_card_str(tsin->dvb_card));\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\tfe2 = dvb_attach(stv6110x_attach, *fe,\n\t\t\t\t\t&stv6110x_config, tsin->i2c_adapter);\n\t\tif (!fe2) {\n\t\t\tdev_err(c8sectpfe->device,\n\t\t\t\t\"%s: stv6110x_attach failed for NIM card %s\\n\"\n\t\t\t\t, __func__, dvb_card_str(tsin->dvb_card));\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\tstv090x_config.tuner_init = fe2->tuner_init;\n\t\tstv090x_config.tuner_set_mode = fe2->tuner_set_mode;\n\t\tstv090x_config.tuner_set_frequency = fe2->tuner_set_frequency;\n\t\tstv090x_config.tuner_get_frequency = fe2->tuner_get_frequency;\n\t\tstv090x_config.tuner_set_bandwidth = fe2->tuner_set_bandwidth;\n\t\tstv090x_config.tuner_get_bandwidth = fe2->tuner_get_bandwidth;\n\t\tstv090x_config.tuner_set_bbgain = fe2->tuner_set_bbgain;\n\t\tstv090x_config.tuner_get_bbgain = fe2->tuner_get_bbgain;\n\t\tstv090x_config.tuner_set_refclk = fe2->tuner_set_refclk;\n\t\tstv090x_config.tuner_get_status = fe2->tuner_get_status;\n\n\t\tdvb_attach(lnbh24_attach, *fe, tsin->i2c_adapter, 0, 0, 0x9);\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(c8sectpfe->device,\n\t\t\t\"%s: DVB frontend card %s not yet supported\\n\",\n\t\t\t__func__, dvb_card_str(tsin->dvb_card));\n\t\treturn -ENODEV;\n\t}\n\n\t(*fe)->id = chan_num;\n\n\tdev_info(c8sectpfe->device,\n\t\t\t\"DVB frontend card %s successfully attached\",\n\t\t\tdvb_card_str(tsin->dvb_card));\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}