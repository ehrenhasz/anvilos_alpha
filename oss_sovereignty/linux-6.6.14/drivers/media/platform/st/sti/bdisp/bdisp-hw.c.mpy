{
  "module_name": "bdisp-hw.c",
  "hash_id": "3193f0c777c9b55cde17e778677a092de299d83e5e895365cd4b43df3587aada",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/st/sti/bdisp/bdisp-hw.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n\n#include \"bdisp.h\"\n#include \"bdisp-filter.h\"\n#include \"bdisp-reg.h\"\n\n \n#define MAX_SRC_WIDTH           2048\n\n \n#define POLL_RST_MAX            500\n#define POLL_RST_DELAY_MS       2\n\nenum bdisp_target_plan {\n\tBDISP_RGB,\n\tBDISP_Y,\n\tBDISP_CBCR\n};\n\nstruct bdisp_op_cfg {\n\tbool cconv;           \n\tbool hflip;           \n\tbool vflip;           \n\tbool wide;            \n\tbool scale;           \n\tu16  h_inc;           \n\tu16  v_inc;           \n\tbool src_interlaced;  \n\tu8   src_nbp;         \n\tbool src_yuv;         \n\tbool src_420;         \n\tu8   dst_nbp;         \n\tbool dst_yuv;         \n\tbool dst_420;         \n};\n\nstruct bdisp_filter_addr {\n\tu16 min;              \n\tu16 max;              \n\tvoid *virt;           \n\tdma_addr_t paddr;     \n};\n\nstatic const struct bdisp_filter_h_spec bdisp_h_spec[] = {\n\t{\n\t\t.min = 0,\n\t\t.max = 921,\n\t\t.coef = {\n\t\t\t0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,\n\t\t\t0x00, 0x00, 0xff, 0x07, 0x3d, 0xfc, 0x01, 0x00,\n\t\t\t0x00, 0x01, 0xfd, 0x11, 0x36, 0xf9, 0x02, 0x00,\n\t\t\t0x00, 0x01, 0xfb, 0x1b, 0x2e, 0xf9, 0x02, 0x00,\n\t\t\t0x00, 0x01, 0xf9, 0x26, 0x26, 0xf9, 0x01, 0x00,\n\t\t\t0x00, 0x02, 0xf9, 0x30, 0x19, 0xfb, 0x01, 0x00,\n\t\t\t0x00, 0x02, 0xf9, 0x39, 0x0e, 0xfd, 0x01, 0x00,\n\t\t\t0x00, 0x01, 0xfc, 0x3e, 0x06, 0xff, 0x00, 0x00\n\t\t}\n\t},\n\t{\n\t\t.min = 921,\n\t\t.max = 1024,\n\t\t.coef = {\n\t\t\t0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,\n\t\t\t0xff, 0x03, 0xfd, 0x08, 0x3e, 0xf9, 0x04, 0xfe,\n\t\t\t0xfd, 0x06, 0xf8, 0x13, 0x3b, 0xf4, 0x07, 0xfc,\n\t\t\t0xfb, 0x08, 0xf5, 0x1f, 0x34, 0xf1, 0x09, 0xfb,\n\t\t\t0xfb, 0x09, 0xf2, 0x2b, 0x2a, 0xf1, 0x09, 0xfb,\n\t\t\t0xfb, 0x09, 0xf2, 0x35, 0x1e, 0xf4, 0x08, 0xfb,\n\t\t\t0xfc, 0x07, 0xf5, 0x3c, 0x12, 0xf7, 0x06, 0xfd,\n\t\t\t0xfe, 0x04, 0xfa, 0x3f, 0x07, 0xfc, 0x03, 0xff\n\t\t}\n\t},\n\t{\n\t\t.min = 1024,\n\t\t.max = 1126,\n\t\t.coef = {\n\t\t\t0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,\n\t\t\t0xff, 0x03, 0xfd, 0x08, 0x3e, 0xf9, 0x04, 0xfe,\n\t\t\t0xfd, 0x06, 0xf8, 0x13, 0x3b, 0xf4, 0x07, 0xfc,\n\t\t\t0xfb, 0x08, 0xf5, 0x1f, 0x34, 0xf1, 0x09, 0xfb,\n\t\t\t0xfb, 0x09, 0xf2, 0x2b, 0x2a, 0xf1, 0x09, 0xfb,\n\t\t\t0xfb, 0x09, 0xf2, 0x35, 0x1e, 0xf4, 0x08, 0xfb,\n\t\t\t0xfc, 0x07, 0xf5, 0x3c, 0x12, 0xf7, 0x06, 0xfd,\n\t\t\t0xfe, 0x04, 0xfa, 0x3f, 0x07, 0xfc, 0x03, 0xff\n\t\t}\n\t},\n\t{\n\t\t.min = 1126,\n\t\t.max = 1228,\n\t\t.coef = {\n\t\t\t0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,\n\t\t\t0xff, 0x03, 0xfd, 0x08, 0x3e, 0xf9, 0x04, 0xfe,\n\t\t\t0xfd, 0x06, 0xf8, 0x13, 0x3b, 0xf4, 0x07, 0xfc,\n\t\t\t0xfb, 0x08, 0xf5, 0x1f, 0x34, 0xf1, 0x09, 0xfb,\n\t\t\t0xfb, 0x09, 0xf2, 0x2b, 0x2a, 0xf1, 0x09, 0xfb,\n\t\t\t0xfb, 0x09, 0xf2, 0x35, 0x1e, 0xf4, 0x08, 0xfb,\n\t\t\t0xfc, 0x07, 0xf5, 0x3c, 0x12, 0xf7, 0x06, 0xfd,\n\t\t\t0xfe, 0x04, 0xfa, 0x3f, 0x07, 0xfc, 0x03, 0xff\n\t\t}\n\t},\n\t{\n\t\t.min = 1228,\n\t\t.max = 1331,\n\t\t.coef = {\n\t\t\t0xfd, 0x04, 0xfc, 0x05, 0x39, 0x05, 0xfc, 0x04,\n\t\t\t0xfc, 0x06, 0xf9, 0x0c, 0x39, 0xfe, 0x00, 0x02,\n\t\t\t0xfb, 0x08, 0xf6, 0x17, 0x35, 0xf9, 0x02, 0x00,\n\t\t\t0xfc, 0x08, 0xf4, 0x20, 0x30, 0xf4, 0x05, 0xff,\n\t\t\t0xfd, 0x07, 0xf4, 0x29, 0x28, 0xf3, 0x07, 0xfd,\n\t\t\t0xff, 0x05, 0xf5, 0x31, 0x1f, 0xf3, 0x08, 0xfc,\n\t\t\t0x00, 0x02, 0xf9, 0x38, 0x14, 0xf6, 0x08, 0xfb,\n\t\t\t0x02, 0x00, 0xff, 0x3a, 0x0b, 0xf8, 0x06, 0xfc\n\t\t}\n\t},\n\t{\n\t\t.min = 1331,\n\t\t.max = 1433,\n\t\t.coef = {\n\t\t\t0xfc, 0x06, 0xf9, 0x09, 0x34, 0x09, 0xf9, 0x06,\n\t\t\t0xfd, 0x07, 0xf7, 0x10, 0x32, 0x02, 0xfc, 0x05,\n\t\t\t0xfe, 0x07, 0xf6, 0x17, 0x2f, 0xfc, 0xff, 0x04,\n\t\t\t0xff, 0x06, 0xf5, 0x20, 0x2a, 0xf9, 0x01, 0x02,\n\t\t\t0x00, 0x04, 0xf6, 0x27, 0x25, 0xf6, 0x04, 0x00,\n\t\t\t0x02, 0x01, 0xf9, 0x2d, 0x1d, 0xf5, 0x06, 0xff,\n\t\t\t0x04, 0xff, 0xfd, 0x31, 0x15, 0xf5, 0x07, 0xfe,\n\t\t\t0x05, 0xfc, 0x02, 0x35, 0x0d, 0xf7, 0x07, 0xfd\n\t\t}\n\t},\n\t{\n\t\t.min = 1433,\n\t\t.max = 1536,\n\t\t.coef = {\n\t\t\t0xfe, 0x06, 0xf8, 0x0b, 0x30, 0x0b, 0xf8, 0x06,\n\t\t\t0xff, 0x06, 0xf7, 0x12, 0x2d, 0x05, 0xfa, 0x06,\n\t\t\t0x00, 0x04, 0xf6, 0x18, 0x2c, 0x00, 0xfc, 0x06,\n\t\t\t0x01, 0x02, 0xf7, 0x1f, 0x27, 0xfd, 0xff, 0x04,\n\t\t\t0x03, 0x00, 0xf9, 0x24, 0x24, 0xf9, 0x00, 0x03,\n\t\t\t0x04, 0xff, 0xfd, 0x29, 0x1d, 0xf7, 0x02, 0x01,\n\t\t\t0x06, 0xfc, 0x00, 0x2d, 0x17, 0xf6, 0x04, 0x00,\n\t\t\t0x06, 0xfa, 0x05, 0x30, 0x0f, 0xf7, 0x06, 0xff\n\t\t}\n\t},\n\t{\n\t\t.min = 1536,\n\t\t.max = 2048,\n\t\t.coef = {\n\t\t\t0x05, 0xfd, 0xfb, 0x13, 0x25, 0x13, 0xfb, 0xfd,\n\t\t\t0x05, 0xfc, 0xfd, 0x17, 0x24, 0x0f, 0xf9, 0xff,\n\t\t\t0x04, 0xfa, 0xff, 0x1b, 0x24, 0x0b, 0xf9, 0x00,\n\t\t\t0x03, 0xf9, 0x01, 0x1f, 0x23, 0x08, 0xf8, 0x01,\n\t\t\t0x02, 0xf9, 0x04, 0x22, 0x20, 0x04, 0xf9, 0x02,\n\t\t\t0x01, 0xf8, 0x08, 0x25, 0x1d, 0x01, 0xf9, 0x03,\n\t\t\t0x00, 0xf9, 0x0c, 0x25, 0x1a, 0xfe, 0xfa, 0x04,\n\t\t\t0xff, 0xf9, 0x10, 0x26, 0x15, 0xfc, 0xfc, 0x05\n\t\t}\n\t},\n\t{\n\t\t.min = 2048,\n\t\t.max = 3072,\n\t\t.coef = {\n\t\t\t0xfc, 0xfd, 0x06, 0x13, 0x18, 0x13, 0x06, 0xfd,\n\t\t\t0xfc, 0xfe, 0x08, 0x15, 0x17, 0x12, 0x04, 0xfc,\n\t\t\t0xfb, 0xfe, 0x0a, 0x16, 0x18, 0x10, 0x03, 0xfc,\n\t\t\t0xfb, 0x00, 0x0b, 0x18, 0x17, 0x0f, 0x01, 0xfb,\n\t\t\t0xfb, 0x00, 0x0d, 0x19, 0x17, 0x0d, 0x00, 0xfb,\n\t\t\t0xfb, 0x01, 0x0f, 0x19, 0x16, 0x0b, 0x00, 0xfb,\n\t\t\t0xfc, 0x03, 0x11, 0x19, 0x15, 0x09, 0xfe, 0xfb,\n\t\t\t0xfc, 0x04, 0x12, 0x1a, 0x12, 0x08, 0xfe, 0xfc\n\t\t}\n\t},\n\t{\n\t\t.min = 3072,\n\t\t.max = 4096,\n\t\t.coef = {\n\t\t\t0xfe, 0x02, 0x09, 0x0f, 0x0e, 0x0f, 0x09, 0x02,\n\t\t\t0xff, 0x02, 0x09, 0x0f, 0x10, 0x0e, 0x08, 0x01,\n\t\t\t0xff, 0x03, 0x0a, 0x10, 0x10, 0x0d, 0x07, 0x00,\n\t\t\t0x00, 0x04, 0x0b, 0x10, 0x0f, 0x0c, 0x06, 0x00,\n\t\t\t0x00, 0x05, 0x0c, 0x10, 0x0e, 0x0c, 0x05, 0x00,\n\t\t\t0x00, 0x06, 0x0c, 0x11, 0x0e, 0x0b, 0x04, 0x00,\n\t\t\t0x00, 0x07, 0x0d, 0x11, 0x0f, 0x0a, 0x03, 0xff,\n\t\t\t0x01, 0x08, 0x0e, 0x11, 0x0e, 0x09, 0x02, 0xff\n\t\t}\n\t},\n\t{\n\t\t.min = 4096,\n\t\t.max = 5120,\n\t\t.coef = {\n\t\t\t0x00, 0x04, 0x09, 0x0c, 0x0e, 0x0c, 0x09, 0x04,\n\t\t\t0x01, 0x05, 0x09, 0x0c, 0x0d, 0x0c, 0x08, 0x04,\n\t\t\t0x01, 0x05, 0x0a, 0x0c, 0x0e, 0x0b, 0x08, 0x03,\n\t\t\t0x02, 0x06, 0x0a, 0x0d, 0x0c, 0x0b, 0x07, 0x03,\n\t\t\t0x02, 0x07, 0x0a, 0x0d, 0x0d, 0x0a, 0x07, 0x02,\n\t\t\t0x03, 0x07, 0x0b, 0x0d, 0x0c, 0x0a, 0x06, 0x02,\n\t\t\t0x03, 0x08, 0x0b, 0x0d, 0x0d, 0x0a, 0x05, 0x01,\n\t\t\t0x04, 0x08, 0x0c, 0x0d, 0x0c, 0x09, 0x05, 0x01\n\t\t}\n\t},\n\t{\n\t\t.min = 5120,\n\t\t.max = 65535,\n\t\t.coef = {\n\t\t\t0x03, 0x06, 0x09, 0x0b, 0x09, 0x0b, 0x09, 0x06,\n\t\t\t0x03, 0x06, 0x09, 0x0b, 0x0c, 0x0a, 0x08, 0x05,\n\t\t\t0x03, 0x06, 0x09, 0x0b, 0x0c, 0x0a, 0x08, 0x05,\n\t\t\t0x04, 0x07, 0x09, 0x0b, 0x0b, 0x0a, 0x08, 0x04,\n\t\t\t0x04, 0x07, 0x0a, 0x0b, 0x0b, 0x0a, 0x07, 0x04,\n\t\t\t0x04, 0x08, 0x0a, 0x0b, 0x0b, 0x09, 0x07, 0x04,\n\t\t\t0x05, 0x08, 0x0a, 0x0b, 0x0c, 0x09, 0x06, 0x03,\n\t\t\t0x05, 0x08, 0x0a, 0x0b, 0x0c, 0x09, 0x06, 0x03\n\t\t}\n\t}\n};\n\n#define NB_H_FILTER ARRAY_SIZE(bdisp_h_spec)\n\n\nstatic const struct bdisp_filter_v_spec bdisp_v_spec[] = {\n\t{\n\t\t.min = 0,\n\t\t.max = 1024,\n\t\t.coef = {\n\t\t\t0x00, 0x00, 0x40, 0x00, 0x00,\n\t\t\t0x00, 0x06, 0x3d, 0xfd, 0x00,\n\t\t\t0xfe, 0x0f, 0x38, 0xfb, 0x00,\n\t\t\t0xfd, 0x19, 0x2f, 0xfb, 0x00,\n\t\t\t0xfc, 0x24, 0x24, 0xfc, 0x00,\n\t\t\t0xfb, 0x2f, 0x19, 0xfd, 0x00,\n\t\t\t0xfb, 0x38, 0x0f, 0xfe, 0x00,\n\t\t\t0xfd, 0x3d, 0x06, 0x00, 0x00\n\t\t}\n\t},\n\t{\n\t\t.min = 1024,\n\t\t.max = 1331,\n\t\t.coef = {\n\t\t\t0xfc, 0x05, 0x3e, 0x05, 0xfc,\n\t\t\t0xf8, 0x0e, 0x3b, 0xff, 0x00,\n\t\t\t0xf5, 0x18, 0x38, 0xf9, 0x02,\n\t\t\t0xf4, 0x21, 0x31, 0xf5, 0x05,\n\t\t\t0xf4, 0x2a, 0x27, 0xf4, 0x07,\n\t\t\t0xf6, 0x30, 0x1e, 0xf4, 0x08,\n\t\t\t0xf9, 0x35, 0x15, 0xf6, 0x07,\n\t\t\t0xff, 0x37, 0x0b, 0xf9, 0x06\n\t\t}\n\t},\n\t{\n\t\t.min = 1331,\n\t\t.max = 1433,\n\t\t.coef = {\n\t\t\t0xf8, 0x0a, 0x3c, 0x0a, 0xf8,\n\t\t\t0xf6, 0x12, 0x3b, 0x02, 0xfb,\n\t\t\t0xf4, 0x1b, 0x35, 0xfd, 0xff,\n\t\t\t0xf4, 0x23, 0x30, 0xf8, 0x01,\n\t\t\t0xf6, 0x29, 0x27, 0xf6, 0x04,\n\t\t\t0xf9, 0x2e, 0x1e, 0xf5, 0x06,\n\t\t\t0xfd, 0x31, 0x16, 0xf6, 0x06,\n\t\t\t0x02, 0x32, 0x0d, 0xf8, 0x07\n\t\t}\n\t},\n\t{\n\t\t.min = 1433,\n\t\t.max = 1536,\n\t\t.coef = {\n\t\t\t0xf6, 0x0e, 0x38, 0x0e, 0xf6,\n\t\t\t0xf5, 0x15, 0x38, 0x06, 0xf8,\n\t\t\t0xf5, 0x1d, 0x33, 0x00, 0xfb,\n\t\t\t0xf6, 0x23, 0x2d, 0xfc, 0xfe,\n\t\t\t0xf9, 0x28, 0x26, 0xf9, 0x00,\n\t\t\t0xfc, 0x2c, 0x1e, 0xf7, 0x03,\n\t\t\t0x00, 0x2e, 0x18, 0xf6, 0x04,\n\t\t\t0x05, 0x2e, 0x11, 0xf7, 0x05\n\t\t}\n\t},\n\t{\n\t\t.min = 1536,\n\t\t.max = 2048,\n\t\t.coef = {\n\t\t\t0xfb, 0x13, 0x24, 0x13, 0xfb,\n\t\t\t0xfd, 0x17, 0x23, 0x0f, 0xfa,\n\t\t\t0xff, 0x1a, 0x23, 0x0b, 0xf9,\n\t\t\t0x01, 0x1d, 0x22, 0x07, 0xf9,\n\t\t\t0x04, 0x20, 0x1f, 0x04, 0xf9,\n\t\t\t0x07, 0x22, 0x1c, 0x01, 0xfa,\n\t\t\t0x0b, 0x24, 0x17, 0xff, 0xfb,\n\t\t\t0x0f, 0x24, 0x14, 0xfd, 0xfc\n\t\t}\n\t},\n\t{\n\t\t.min = 2048,\n\t\t.max = 3072,\n\t\t.coef = {\n\t\t\t0x05, 0x10, 0x16, 0x10, 0x05,\n\t\t\t0x06, 0x11, 0x16, 0x0f, 0x04,\n\t\t\t0x08, 0x13, 0x15, 0x0e, 0x02,\n\t\t\t0x09, 0x14, 0x16, 0x0c, 0x01,\n\t\t\t0x0b, 0x15, 0x15, 0x0b, 0x00,\n\t\t\t0x0d, 0x16, 0x13, 0x0a, 0x00,\n\t\t\t0x0f, 0x17, 0x13, 0x08, 0xff,\n\t\t\t0x11, 0x18, 0x12, 0x07, 0xfe\n\t\t}\n\t},\n\t{\n\t\t.min = 3072,\n\t\t.max = 4096,\n\t\t.coef = {\n\t\t\t0x09, 0x0f, 0x10, 0x0f, 0x09,\n\t\t\t0x09, 0x0f, 0x12, 0x0e, 0x08,\n\t\t\t0x0a, 0x10, 0x11, 0x0e, 0x07,\n\t\t\t0x0b, 0x11, 0x11, 0x0d, 0x06,\n\t\t\t0x0c, 0x11, 0x12, 0x0c, 0x05,\n\t\t\t0x0d, 0x12, 0x11, 0x0c, 0x04,\n\t\t\t0x0e, 0x12, 0x11, 0x0b, 0x04,\n\t\t\t0x0f, 0x13, 0x11, 0x0a, 0x03\n\t\t}\n\t},\n\t{\n\t\t.min = 4096,\n\t\t.max = 5120,\n\t\t.coef = {\n\t\t\t0x0a, 0x0e, 0x10, 0x0e, 0x0a,\n\t\t\t0x0b, 0x0e, 0x0f, 0x0e, 0x0a,\n\t\t\t0x0b, 0x0f, 0x10, 0x0d, 0x09,\n\t\t\t0x0c, 0x0f, 0x10, 0x0d, 0x08,\n\t\t\t0x0d, 0x0f, 0x0f, 0x0d, 0x08,\n\t\t\t0x0d, 0x10, 0x10, 0x0c, 0x07,\n\t\t\t0x0e, 0x10, 0x0f, 0x0c, 0x07,\n\t\t\t0x0f, 0x10, 0x10, 0x0b, 0x06\n\t\t}\n\t},\n\t{\n\t\t.min = 5120,\n\t\t.max = 65535,\n\t\t.coef = {\n\t\t\t0x0b, 0x0e, 0x0e, 0x0e, 0x0b,\n\t\t\t0x0b, 0x0e, 0x0f, 0x0d, 0x0b,\n\t\t\t0x0c, 0x0e, 0x0f, 0x0d, 0x0a,\n\t\t\t0x0c, 0x0e, 0x0f, 0x0d, 0x0a,\n\t\t\t0x0d, 0x0f, 0x0e, 0x0d, 0x09,\n\t\t\t0x0d, 0x0f, 0x0f, 0x0c, 0x09,\n\t\t\t0x0e, 0x0f, 0x0e, 0x0c, 0x09,\n\t\t\t0x0e, 0x0f, 0x0f, 0x0c, 0x08\n\t\t}\n\t}\n};\n\n#define NB_V_FILTER ARRAY_SIZE(bdisp_v_spec)\n\nstatic struct bdisp_filter_addr bdisp_h_filter[NB_H_FILTER];\nstatic struct bdisp_filter_addr bdisp_v_filter[NB_V_FILTER];\n\n \nint bdisp_hw_reset(struct bdisp_dev *bdisp)\n{\n\tunsigned int i;\n\n\tdev_dbg(bdisp->dev, \"%s\\n\", __func__);\n\n\t \n\twritel(0, bdisp->regs + BLT_ITM0);\n\n\t \n\twritel(readl(bdisp->regs + BLT_CTL) | BLT_CTL_RESET,\n\t       bdisp->regs + BLT_CTL);\n\twritel(0, bdisp->regs + BLT_CTL);\n\n\t \n\tfor (i = 0; i < POLL_RST_MAX; i++) {\n\t\tif (readl(bdisp->regs + BLT_STA1) & BLT_STA1_IDLE)\n\t\t\tbreak;\n\t\tudelay(POLL_RST_DELAY_MS * 1000);\n\t}\n\tif (i == POLL_RST_MAX)\n\t\tdev_err(bdisp->dev, \"Reset timeout\\n\");\n\n\treturn (i == POLL_RST_MAX) ? -EAGAIN : 0;\n}\n\n \nint bdisp_hw_get_and_clear_irq(struct bdisp_dev *bdisp)\n{\n\tu32 its;\n\n\tits = readl(bdisp->regs + BLT_ITS);\n\n\t \n\tif (!(its & BLT_ITS_AQ1_LNA)) {\n\t\tdev_dbg(bdisp->dev, \"Unexpected IT status: 0x%08X\\n\", its);\n\t\twritel(its, bdisp->regs + BLT_ITS);\n\t\treturn -1;\n\t}\n\n\t \n\twritel(its, bdisp->regs + BLT_ITS);\n\twritel(0, bdisp->regs + BLT_ITM0);\n\n\treturn 0;\n}\n\n \nvoid bdisp_hw_free_nodes(struct bdisp_ctx *ctx)\n{\n\tif (ctx && ctx->node[0])\n\t\tdma_free_attrs(ctx->bdisp_dev->dev,\n\t\t\t       sizeof(struct bdisp_node) * MAX_NB_NODE,\n\t\t\t       ctx->node[0], ctx->node_paddr[0],\n\t\t\t       DMA_ATTR_WRITE_COMBINE);\n}\n\n \nint bdisp_hw_alloc_nodes(struct bdisp_ctx *ctx)\n{\n\tstruct device *dev = ctx->bdisp_dev->dev;\n\tunsigned int i, node_size = sizeof(struct bdisp_node);\n\tvoid *base;\n\tdma_addr_t paddr;\n\n\t \n\tbase = dma_alloc_attrs(dev, node_size * MAX_NB_NODE, &paddr,\n\t\t\t       GFP_KERNEL, DMA_ATTR_WRITE_COMBINE);\n\tif (!base) {\n\t\tdev_err(dev, \"%s no mem\\n\", __func__);\n\t\treturn -ENOMEM;\n\t}\n\n\tmemset(base, 0, node_size * MAX_NB_NODE);\n\n\tfor (i = 0; i < MAX_NB_NODE; i++) {\n\t\tctx->node[i] = base;\n\t\tctx->node_paddr[i] = paddr;\n\t\tdev_dbg(dev, \"node[%d]=0x%p (paddr=%pad)\\n\", i, ctx->node[i],\n\t\t\t&paddr);\n\t\tbase += node_size;\n\t\tpaddr += node_size;\n\t}\n\n\treturn 0;\n}\n\n \nvoid bdisp_hw_free_filters(struct device *dev)\n{\n\tint size = (BDISP_HF_NB * NB_H_FILTER) + (BDISP_VF_NB * NB_V_FILTER);\n\n\tif (bdisp_h_filter[0].virt)\n\t\tdma_free_attrs(dev, size, bdisp_h_filter[0].virt,\n\t\t\t       bdisp_h_filter[0].paddr, DMA_ATTR_WRITE_COMBINE);\n}\n\n \nint bdisp_hw_alloc_filters(struct device *dev)\n{\n\tunsigned int i, size;\n\tvoid *base;\n\tdma_addr_t paddr;\n\n\t \n\tsize = (BDISP_HF_NB * NB_H_FILTER) + (BDISP_VF_NB * NB_V_FILTER);\n\tbase = dma_alloc_attrs(dev, size, &paddr, GFP_KERNEL,\n\t\t\t       DMA_ATTR_WRITE_COMBINE);\n\tif (!base)\n\t\treturn -ENOMEM;\n\n\t \n\tfor (i = 0; i < NB_H_FILTER; i++) {\n\t\tbdisp_h_filter[i].min = bdisp_h_spec[i].min;\n\t\tbdisp_h_filter[i].max = bdisp_h_spec[i].max;\n\t\tmemcpy(base, bdisp_h_spec[i].coef, BDISP_HF_NB);\n\t\tbdisp_h_filter[i].virt = base;\n\t\tbdisp_h_filter[i].paddr = paddr;\n\t\tbase += BDISP_HF_NB;\n\t\tpaddr += BDISP_HF_NB;\n\t}\n\n\tfor (i = 0; i < NB_V_FILTER; i++) {\n\t\tbdisp_v_filter[i].min = bdisp_v_spec[i].min;\n\t\tbdisp_v_filter[i].max = bdisp_v_spec[i].max;\n\t\tmemcpy(base, bdisp_v_spec[i].coef, BDISP_VF_NB);\n\t\tbdisp_v_filter[i].virt = base;\n\t\tbdisp_v_filter[i].paddr = paddr;\n\t\tbase += BDISP_VF_NB;\n\t\tpaddr += BDISP_VF_NB;\n\t}\n\n\treturn 0;\n}\n\n \nstatic dma_addr_t bdisp_hw_get_hf_addr(u16 inc)\n{\n\tunsigned int i;\n\n\tfor (i = NB_H_FILTER - 1; i > 0; i--)\n\t\tif ((bdisp_h_filter[i].min < inc) &&\n\t\t    (inc <= bdisp_h_filter[i].max))\n\t\t\tbreak;\n\n\treturn bdisp_h_filter[i].paddr;\n}\n\n \nstatic dma_addr_t bdisp_hw_get_vf_addr(u16 inc)\n{\n\tunsigned int i;\n\n\tfor (i = NB_V_FILTER - 1; i > 0; i--)\n\t\tif ((bdisp_v_filter[i].min < inc) &&\n\t\t    (inc <= bdisp_v_filter[i].max))\n\t\t\tbreak;\n\n\treturn bdisp_v_filter[i].paddr;\n}\n\n \nstatic int bdisp_hw_get_inc(u32 from, u32 to, u16 *inc)\n{\n\tu32 tmp;\n\n\tif (!to)\n\t\treturn -EINVAL;\n\n\tif (to == from) {\n\t\t*inc = 1 << 10;\n\t\treturn 0;\n\t}\n\n\ttmp = (from << 10) / to;\n\tif ((tmp > 0xFFFF) || (!tmp))\n\t\t \n\t\treturn -EINVAL;\n\n\t*inc = (u16)tmp;\n\n\treturn 0;\n}\n\n \nstatic int bdisp_hw_get_hv_inc(struct bdisp_ctx *ctx, u16 *h_inc, u16 *v_inc)\n{\n\tu32 src_w, src_h, dst_w, dst_h;\n\n\tsrc_w = ctx->src.crop.width;\n\tsrc_h = ctx->src.crop.height;\n\tdst_w = ctx->dst.crop.width;\n\tdst_h = ctx->dst.crop.height;\n\n\tif (bdisp_hw_get_inc(src_w, dst_w, h_inc) ||\n\t    bdisp_hw_get_inc(src_h, dst_h, v_inc)) {\n\t\tdev_err(ctx->bdisp_dev->dev,\n\t\t\t\"scale factors failed (%dx%d)->(%dx%d)\\n\",\n\t\t\tsrc_w, src_h, dst_w, dst_h);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int bdisp_hw_get_op_cfg(struct bdisp_ctx *ctx, struct bdisp_op_cfg *c)\n{\n\tstruct device *dev = ctx->bdisp_dev->dev;\n\tstruct bdisp_frame *src = &ctx->src;\n\tstruct bdisp_frame *dst = &ctx->dst;\n\n\tif (src->width > MAX_SRC_WIDTH * MAX_VERTICAL_STRIDES) {\n\t\tdev_err(dev, \"Image width out of HW caps\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tc->wide = src->width > MAX_SRC_WIDTH;\n\n\tc->hflip = ctx->hflip;\n\tc->vflip = ctx->vflip;\n\n\tc->src_interlaced = (src->field == V4L2_FIELD_INTERLACED);\n\n\tc->src_nbp = src->fmt->nb_planes;\n\tc->src_yuv = (src->fmt->pixelformat == V4L2_PIX_FMT_NV12) ||\n\t\t\t(src->fmt->pixelformat == V4L2_PIX_FMT_YUV420);\n\tc->src_420 = c->src_yuv;\n\n\tc->dst_nbp = dst->fmt->nb_planes;\n\tc->dst_yuv = (dst->fmt->pixelformat == V4L2_PIX_FMT_NV12) ||\n\t\t\t(dst->fmt->pixelformat == V4L2_PIX_FMT_YUV420);\n\tc->dst_420 = c->dst_yuv;\n\n\tc->cconv = (c->src_yuv != c->dst_yuv);\n\n\tif (bdisp_hw_get_hv_inc(ctx, &c->h_inc, &c->v_inc)) {\n\t\tdev_err(dev, \"Scale factor out of HW caps\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (c->src_interlaced)\n\t\tc->v_inc /= 2;\n\n\tif ((c->h_inc != (1 << 10)) || (c->v_inc != (1 << 10)))\n\t\tc->scale = true;\n\telse\n\t\tc->scale = false;\n\n\treturn 0;\n}\n\n \nstatic u32 bdisp_hw_color_format(u32 pixelformat)\n{\n\tu32 ret;\n\n\tswitch (pixelformat) {\n\tcase V4L2_PIX_FMT_YUV420:\n\t\tret = (BDISP_YUV_3B << BLT_TTY_COL_SHIFT);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_NV12:\n\t\tret = (BDISP_NV12 << BLT_TTY_COL_SHIFT) | BLT_TTY_BIG_END;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_RGB565:\n\t\tret = (BDISP_RGB565 << BLT_TTY_COL_SHIFT);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_XBGR32:  \n\t\tret = (BDISP_XRGB8888 << BLT_TTY_COL_SHIFT);\n\t\tbreak;\n\tcase V4L2_PIX_FMT_RGB24:   \n\t\tret = (BDISP_RGB888 << BLT_TTY_COL_SHIFT) | BLT_TTY_BIG_END;\n\t\tbreak;\n\tcase V4L2_PIX_FMT_ABGR32:  \n\n\tdefault:\n\t\tret = (BDISP_ARGB8888 << BLT_TTY_COL_SHIFT) | BLT_TTY_ALPHA_R;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\n \nstatic void bdisp_hw_build_node(struct bdisp_ctx *ctx,\n\t\t\t\tstruct bdisp_op_cfg *cfg,\n\t\t\t\tstruct bdisp_node *node,\n\t\t\t\tenum bdisp_target_plan t_plan, int src_x_offset)\n{\n\tstruct bdisp_frame *src = &ctx->src;\n\tstruct bdisp_frame *dst = &ctx->dst;\n\tu16 h_inc, v_inc, yh_inc, yv_inc;\n\tstruct v4l2_rect src_rect = src->crop;\n\tstruct v4l2_rect dst_rect = dst->crop;\n\tint dst_x_offset;\n\ts32 dst_width = dst->crop.width;\n\tu32 src_fmt, dst_fmt;\n\tconst u32 *ivmx;\n\n\tdev_dbg(ctx->bdisp_dev->dev, \"%s\\n\", __func__);\n\n\tmemset(node, 0, sizeof(*node));\n\n\t \n\tsrc_rect.left += src_x_offset;\n\tsrc_rect.width -= src_x_offset;\n\tsrc_rect.width = min_t(__s32, MAX_SRC_WIDTH, src_rect.width);\n\n\tdst_x_offset = (src_x_offset * dst_width) / ctx->src.crop.width;\n\tdst_rect.left += dst_x_offset;\n\tdst_rect.width = (src_rect.width * dst_width) / ctx->src.crop.width;\n\n\t \n\tsrc_fmt = src->fmt->pixelformat;\n\tdst_fmt = dst->fmt->pixelformat;\n\n\tnode->nip = 0;\n\tnode->cic = BLT_CIC_ALL_GRP;\n\tnode->ack = BLT_ACK_BYPASS_S2S3;\n\n\tswitch (cfg->src_nbp) {\n\tcase 1:\n\t\t \n\t\tnode->ins = BLT_INS_S1_OFF | BLT_INS_S2_MEM | BLT_INS_S3_OFF;\n\t\tbreak;\n\tcase 2:\n\t\t \n\t\tnode->ins = BLT_INS_S1_OFF | BLT_INS_S3_MEM;\n\t\tif (t_plan == BDISP_Y)\n\t\t\tnode->ins |= BLT_INS_S2_CF;\n\t\telse\n\t\t\tnode->ins |= BLT_INS_S2_MEM;\n\t\tbreak;\n\tcase 3:\n\tdefault:\n\t\t \n\t\tnode->ins = BLT_INS_S3_MEM;\n\t\tif (t_plan == BDISP_Y)\n\t\t\tnode->ins |= BLT_INS_S2_CF | BLT_INS_S1_CF;\n\t\telse\n\t\t\tnode->ins |= BLT_INS_S2_MEM | BLT_INS_S1_MEM;\n\t\tbreak;\n\t}\n\n\t \n\tnode->ins |= cfg->cconv ? BLT_INS_IVMX : 0;\n\t \n\tnode->ins |= (cfg->scale || cfg->src_420 || cfg->dst_420) ?\n\t\t\tBLT_INS_SCALE : 0;\n\n\t \n\tnode->tba = (t_plan == BDISP_CBCR) ? dst->paddr[1] : dst->paddr[0];\n\n\tnode->tty = dst->bytesperline;\n\tnode->tty |= bdisp_hw_color_format(dst_fmt);\n\tnode->tty |= BLT_TTY_DITHER;\n\tnode->tty |= (t_plan == BDISP_CBCR) ? BLT_TTY_CHROMA : 0;\n\tnode->tty |= cfg->hflip ? BLT_TTY_HSO : 0;\n\tnode->tty |= cfg->vflip ? BLT_TTY_VSO : 0;\n\n\tif (cfg->dst_420 && (t_plan == BDISP_CBCR)) {\n\t\t \n\t\tdst_rect.height /= 2;\n\t\tdst_rect.width /= 2;\n\t\tdst_rect.left /= 2;\n\t\tdst_rect.top /= 2;\n\t\tdst_x_offset /= 2;\n\t\tdst_width /= 2;\n\t}\n\n\tnode->txy = cfg->vflip ? (dst_rect.height - 1) : dst_rect.top;\n\tnode->txy <<= 16;\n\tnode->txy |= cfg->hflip ? (dst_width - dst_x_offset - 1) :\n\t\t\tdst_rect.left;\n\n\tnode->tsz = dst_rect.height << 16 | dst_rect.width;\n\n\tif (cfg->src_interlaced) {\n\t\t \n\t\tsrc_rect.top /= 2;\n\t\tsrc_rect.height /= 2;\n\t}\n\n\tif (cfg->src_nbp == 1) {\n\t\t \n\t\tnode->s2ba = src->paddr[0];\n\n\t\tnode->s2ty = src->bytesperline;\n\t\tif (cfg->src_interlaced)\n\t\t\tnode->s2ty *= 2;\n\n\t\tnode->s2ty |= bdisp_hw_color_format(src_fmt);\n\n\t\tnode->s2xy = src_rect.top << 16 | src_rect.left;\n\t\tnode->s2sz = src_rect.height << 16 | src_rect.width;\n\t} else {\n\t\t \n\t\tif (cfg->src_420) {\n\t\t\t \n\t\t\tsrc_rect.top /= 2;\n\t\t\tsrc_rect.left /= 2;\n\t\t\tsrc_rect.width /= 2;\n\t\t\tsrc_rect.height /= 2;\n\t\t}\n\n\t\tnode->s2ba = src->paddr[1];\n\n\t\tnode->s2ty = src->bytesperline;\n\t\tif (cfg->src_nbp == 3)\n\t\t\tnode->s2ty /= 2;\n\t\tif (cfg->src_interlaced)\n\t\t\tnode->s2ty *= 2;\n\n\t\tnode->s2ty |= bdisp_hw_color_format(src_fmt);\n\n\t\tnode->s2xy = src_rect.top << 16 | src_rect.left;\n\t\tnode->s2sz = src_rect.height << 16 | src_rect.width;\n\n\t\tif (cfg->src_nbp == 3) {\n\t\t\t \n\t\t\tnode->s1ba = src->paddr[2];\n\n\t\t\tnode->s1ty = node->s2ty;\n\t\t\tnode->s1xy = node->s2xy;\n\t\t}\n\n\t\t \n\t\tnode->s3ba = src->paddr[0];\n\n\t\tnode->s3ty = src->bytesperline;\n\t\tif (cfg->src_interlaced)\n\t\t\tnode->s3ty *= 2;\n\t\tnode->s3ty |= bdisp_hw_color_format(src_fmt);\n\n\t\tif ((t_plan != BDISP_CBCR) && cfg->src_420) {\n\t\t\t \n\t\t\tnode->s3xy = node->s2xy * 2;\n\t\t\tnode->s3sz = node->s2sz * 2;\n\t\t} else {\n\t\t\t \n\t\t\tnode->s3ty |= BLT_S3TY_BLANK_ACC;\n\t\t\tnode->s3xy = node->s2xy;\n\t\t\tnode->s3sz = node->s2sz;\n\t\t}\n\t}\n\n\t \n\tif (node->ins & BLT_INS_SCALE) {\n\t\t \n\t\tbool skip_y = (t_plan == BDISP_CBCR) && !cfg->src_yuv;\n\n\t\t \n\t\tif (cfg->scale) {\n\t\t\tnode->fctl = BLT_FCTL_HV_SCALE;\n\t\t\tif (!skip_y)\n\t\t\t\tnode->fctl |= BLT_FCTL_Y_HV_SCALE;\n\t\t} else {\n\t\t\tnode->fctl = BLT_FCTL_HV_SAMPLE;\n\t\t\tif (!skip_y)\n\t\t\t\tnode->fctl |= BLT_FCTL_Y_HV_SAMPLE;\n\t\t}\n\n\t\t \n\t\th_inc = cfg->h_inc;\n\t\tv_inc = cfg->v_inc;\n\t\tif (!cfg->src_420 && cfg->dst_420 && (t_plan == BDISP_CBCR)) {\n\t\t\t \n\t\t\th_inc *= 2;\n\t\t\tv_inc *= 2;\n\t\t} else if (cfg->src_420 && !cfg->dst_420) {\n\t\t\t \n\t\t\th_inc /= 2;\n\t\t\tv_inc /= 2;\n\t\t}\n\t\tnode->rsf = v_inc << 16 | h_inc;\n\n\t\t \n\t\tnode->rzi = BLT_RZI_DEFAULT;\n\n\t\t \n\t\tnode->hfp = bdisp_hw_get_hf_addr(h_inc);\n\t\tnode->vfp = bdisp_hw_get_vf_addr(v_inc);\n\n\t\t \n\t\tif (!skip_y) {\n\t\t\tyh_inc = cfg->h_inc;\n\t\t\tyv_inc = cfg->v_inc;\n\n\t\t\tnode->y_rsf = yv_inc << 16 | yh_inc;\n\t\t\tnode->y_rzi = BLT_RZI_DEFAULT;\n\t\t\tnode->y_hfp = bdisp_hw_get_hf_addr(yh_inc);\n\t\t\tnode->y_vfp = bdisp_hw_get_vf_addr(yv_inc);\n\t\t}\n\t}\n\n\t \n\tif (cfg->cconv) {\n\t\tivmx = cfg->src_yuv ? bdisp_yuv_to_rgb : bdisp_rgb_to_yuv;\n\n\t\tnode->ivmx0 = ivmx[0];\n\t\tnode->ivmx1 = ivmx[1];\n\t\tnode->ivmx2 = ivmx[2];\n\t\tnode->ivmx3 = ivmx[3];\n\t}\n}\n\n \nstatic int bdisp_hw_build_all_nodes(struct bdisp_ctx *ctx)\n{\n\tstruct bdisp_op_cfg cfg;\n\tunsigned int i, nid = 0;\n\tint src_x_offset = 0;\n\n\tfor (i = 0; i < MAX_NB_NODE; i++)\n\t\tif (!ctx->node[i]) {\n\t\t\tdev_err(ctx->bdisp_dev->dev, \"node %d is null\\n\", i);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t \n\tif (bdisp_hw_get_op_cfg(ctx, &cfg))\n\t\treturn -EINVAL;\n\n\t \n\tfor (i = 0; i < MAX_VERTICAL_STRIDES; i++) {\n\t\t \n\t\tbdisp_hw_build_node(ctx, &cfg, ctx->node[nid],\n\t\t\t\t    cfg.dst_nbp == 1 ? BDISP_RGB : BDISP_Y,\n\t\t\t\t    src_x_offset);\n\t\tif (nid)\n\t\t\tctx->node[nid - 1]->nip = ctx->node_paddr[nid];\n\t\tnid++;\n\n\t\t \n\t\tif (cfg.dst_nbp > 1) {\n\t\t\tbdisp_hw_build_node(ctx, &cfg, ctx->node[nid],\n\t\t\t\t\t    BDISP_CBCR, src_x_offset);\n\t\t\tctx->node[nid - 1]->nip = ctx->node_paddr[nid];\n\t\t\tnid++;\n\t\t}\n\n\t\t \n\t\tsrc_x_offset += MAX_SRC_WIDTH;\n\t\tif (src_x_offset >= ctx->src.crop.width)\n\t\t\tbreak;\n\t}\n\n\t \n\tctx->node[nid - 1]->nip = 0;\n\n\treturn 0;\n}\n\n \nstatic void bdisp_hw_save_request(struct bdisp_ctx *ctx)\n{\n\tstruct bdisp_node **copy_node = ctx->bdisp_dev->dbg.copy_node;\n\tstruct bdisp_request *request = &ctx->bdisp_dev->dbg.copy_request;\n\tstruct bdisp_node **node = ctx->node;\n\tint i;\n\n\t \n\trequest->src = ctx->src;\n\trequest->dst = ctx->dst;\n\trequest->hflip = ctx->hflip;\n\trequest->vflip = ctx->vflip;\n\trequest->nb_req++;\n\n\t \n\tfor (i = 0; i < MAX_NB_NODE; i++) {\n\t\t \n\t\tif (!copy_node[i]) {\n\t\t\tcopy_node[i] = devm_kzalloc(ctx->bdisp_dev->dev,\n\t\t\t\t\t\t    sizeof(*copy_node[i]),\n\t\t\t\t\t\t    GFP_ATOMIC);\n\t\t\tif (!copy_node[i])\n\t\t\t\treturn;\n\t\t}\n\t\t*copy_node[i] = *node[i];\n\t}\n}\n\n \nint bdisp_hw_update(struct bdisp_ctx *ctx)\n{\n\tint ret;\n\tstruct bdisp_dev *bdisp = ctx->bdisp_dev;\n\tstruct device *dev = bdisp->dev;\n\tunsigned int node_id;\n\n\tdev_dbg(dev, \"%s\\n\", __func__);\n\n\t \n\tret = bdisp_hw_build_all_nodes(ctx);\n\tif (ret) {\n\t\tdev_err(dev, \"cannot build nodes (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tbdisp_hw_save_request(ctx);\n\n\t \n\twritel(BLT_AQ1_CTL_CFG, bdisp->regs + BLT_AQ1_CTL);\n\twritel(BLT_ITS_AQ1_LNA, bdisp->regs + BLT_ITM0);\n\n\t \n\twritel(ctx->node_paddr[0], bdisp->regs + BLT_AQ1_IP);\n\n\t \n\tfor (node_id = 0; node_id < MAX_NB_NODE - 1; node_id++) {\n\t\tif (!ctx->node[node_id]->nip)\n\t\t\tbreak;\n\t}\n\twritel(ctx->node_paddr[node_id], bdisp->regs + BLT_AQ1_LNA);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}