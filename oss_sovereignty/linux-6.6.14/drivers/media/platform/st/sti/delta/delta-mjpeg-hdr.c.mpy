{
  "module_name": "delta-mjpeg-hdr.c",
  "hash_id": "c40e43c7e7725d958c2de98788dacc4d459a0765f4e349b395b029554e616eba",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/st/sti/delta/delta-mjpeg-hdr.c",
  "human_readable_source": "\n \n\n#include \"delta.h\"\n#include \"delta-mjpeg.h\"\n\n#define MJPEG_SOF_0  0xc0\n#define MJPEG_SOF_1  0xc1\n#define MJPEG_SOI    0xd8\n#define MJPEG_MARKER 0xff\n\nstatic char *header_str(struct mjpeg_header *header,\n\t\t\tchar *str,\n\t\t\tunsigned int len)\n{\n\tchar *cur = str;\n\tunsigned int left = len;\n\n\tif (!header)\n\t\treturn \"\";\n\n\tsnprintf(cur, left, \"[MJPEG header]\\n\"\n\t\t\t\"|- length     = %d\\n\"\n\t\t\t\"|- precision  = %d\\n\"\n\t\t\t\"|- width      = %d\\n\"\n\t\t\t\"|- height     = %d\\n\"\n\t\t\t\"|- components = %d\\n\",\n\t\t\theader->length,\n\t\t\theader->sample_precision,\n\t\t\theader->frame_width,\n\t\t\theader->frame_height,\n\t\t\theader->nb_of_components);\n\n\treturn str;\n}\n\nstatic int delta_mjpeg_read_sof(struct delta_ctx *pctx,\n\t\t\t\tunsigned char *data, unsigned int size,\n\t\t\t\tstruct mjpeg_header *header)\n{\n\tstruct delta_dev *delta = pctx->dev;\n\tunsigned int offset = 0;\n\n\tif (size < 64)\n\t\tgoto err_no_more;\n\n\tmemset(header, 0, sizeof(*header));\n\theader->length           = be16_to_cpu(*(__be16 *)(data + offset));\n\toffset += sizeof(u16);\n\theader->sample_precision = *(u8 *)(data + offset);\n\toffset += sizeof(u8);\n\theader->frame_height     = be16_to_cpu(*(__be16 *)(data + offset));\n\toffset += sizeof(u16);\n\theader->frame_width      = be16_to_cpu(*(__be16 *)(data + offset));\n\toffset += sizeof(u16);\n\theader->nb_of_components = *(u8 *)(data + offset);\n\toffset += sizeof(u8);\n\n\tif (header->nb_of_components >= MJPEG_MAX_COMPONENTS) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   unsupported number of components (%d > %d)\\n\",\n\t\t\tpctx->name, header->nb_of_components,\n\t\t\tMJPEG_MAX_COMPONENTS);\n\t\treturn -EINVAL;\n\t}\n\n\tif ((offset + header->nb_of_components *\n\t     sizeof(header->components[0])) > size)\n\t\tgoto err_no_more;\n\n\treturn 0;\n\nerr_no_more:\n\tdev_err(delta->dev,\n\t\t\"%s   sof: reached end of %d size input stream\\n\",\n\t\tpctx->name, size);\n\treturn -ENODATA;\n}\n\nint delta_mjpeg_read_header(struct delta_ctx *pctx,\n\t\t\t    unsigned char *data, unsigned int size,\n\t\t\t    struct mjpeg_header *header,\n\t\t\t    unsigned int *data_offset)\n{\n\tstruct delta_dev *delta = pctx->dev;\n\tunsigned char str[200];\n\n\tunsigned int ret = 0;\n\tunsigned int offset = 0;\n\tunsigned int soi = 0;\n\n\tif (size < 2)\n\t\tgoto err_no_more;\n\n\toffset = 0;\n\twhile (1) {\n\t\tif (data[offset] == MJPEG_MARKER)\n\t\t\tswitch (data[offset + 1]) {\n\t\t\tcase MJPEG_SOI:\n\t\t\t\tsoi = 1;\n\t\t\t\t*data_offset = offset;\n\t\t\t\tbreak;\n\n\t\t\tcase MJPEG_SOF_0:\n\t\t\tcase MJPEG_SOF_1:\n\t\t\t\tif (!soi) {\n\t\t\t\t\tdev_err(delta->dev,\n\t\t\t\t\t\t\"%s   wrong sequence, got SOF while SOI not seen\\n\",\n\t\t\t\t\t\tpctx->name);\n\t\t\t\t\treturn -EINVAL;\n\t\t\t\t}\n\n\t\t\t\tret = delta_mjpeg_read_sof(pctx,\n\t\t\t\t\t\t\t   &data[offset + 2],\n\t\t\t\t\t\t\t   size - (offset + 2),\n\t\t\t\t\t\t\t   header);\n\t\t\t\tif (ret)\n\t\t\t\t\tgoto err;\n\n\t\t\t\tgoto done;\n\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\toffset++;\n\t\tif ((offset + 2) >= size)\n\t\t\tgoto err_no_more;\n\t}\n\ndone:\n\tdev_dbg(delta->dev,\n\t\t\"%s   found header @ offset %d:\\n%s\", pctx->name,\n\t\t*data_offset,\n\t\theader_str(header, str, sizeof(str)));\n\treturn 0;\n\nerr_no_more:\n\tdev_err(delta->dev,\n\t\t\"%s   no header found within %d bytes input stream\\n\",\n\t\tpctx->name, size);\n\treturn -ENODATA;\n\nerr:\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}