{
  "module_name": "delta-ipc.c",
  "hash_id": "6e08e6f83d4355e392968f35460a9a3afe52acdcf198de4e3150277a48c82a03",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/st/sti/delta/delta-ipc.c",
  "human_readable_source": "\n \n\n#include <linux/rpmsg.h>\n\n#include \"delta.h\"\n#include \"delta-ipc.h\"\n#include \"delta-mem.h\"\n\n#define IPC_TIMEOUT 100\n#define IPC_SANITY_TAG 0xDEADBEEF\n\nenum delta_ipc_fw_command {\n\tDELTA_IPC_OPEN,\n\tDELTA_IPC_SET_STREAM,\n\tDELTA_IPC_DECODE,\n\tDELTA_IPC_CLOSE\n};\n\n#define to_rpmsg_driver(__drv) container_of(__drv, struct rpmsg_driver, drv)\n#define to_delta(__d) container_of(__d, struct delta_dev, rpmsg_driver)\n\n#define to_ctx(hdl) ((struct delta_ipc_ctx *)hdl)\n#define to_pctx(ctx) container_of(ctx, struct delta_ctx, ipc_ctx)\n\nstruct delta_ipc_header_msg {\n\tu32 tag;\n\tvoid *host_hdl;\n\tu32 copro_hdl;\n\tu32 command;\n};\n\n#define to_host_hdl(ctx) ((void *)ctx)\n\n#define msg_to_ctx(msg) ((struct delta_ipc_ctx *)(msg)->header.host_hdl)\n#define msg_to_copro_hdl(msg) ((msg)->header.copro_hdl)\n\nstatic inline dma_addr_t to_paddr(struct delta_ipc_ctx *ctx, void *vaddr)\n{\n\treturn (ctx->ipc_buf->paddr + (vaddr - ctx->ipc_buf->vaddr));\n}\n\nstatic inline bool is_valid_data(struct delta_ipc_ctx *ctx,\n\t\t\t\t void *data, u32 size)\n{\n\treturn ((data >= ctx->ipc_buf->vaddr) &&\n\t\t((data + size) <= (ctx->ipc_buf->vaddr + ctx->ipc_buf->size)));\n}\n\n \nstruct delta_ipc_open_msg {\n\tstruct delta_ipc_header_msg header;\n\tu32 ipc_buf_size;\n\tdma_addr_t ipc_buf_paddr;\n\tchar name[32];\n\tu32 param_size;\n\tdma_addr_t param_paddr;\n};\n\nstruct delta_ipc_set_stream_msg {\n\tstruct delta_ipc_header_msg header;\n\tu32 param_size;\n\tdma_addr_t param_paddr;\n};\n\nstruct delta_ipc_decode_msg {\n\tstruct delta_ipc_header_msg header;\n\tu32 param_size;\n\tdma_addr_t param_paddr;\n\tu32 status_size;\n\tdma_addr_t status_paddr;\n};\n\nstruct delta_ipc_close_msg {\n\tstruct delta_ipc_header_msg header;\n};\n\nstruct delta_ipc_cb_msg {\n\tstruct delta_ipc_header_msg header;\n\tint err;\n};\n\nstatic void build_msg_header(struct delta_ipc_ctx *ctx,\n\t\t\t     enum delta_ipc_fw_command command,\n\t\t\t     struct delta_ipc_header_msg *header)\n{\n\theader->tag = IPC_SANITY_TAG;\n\theader->host_hdl = to_host_hdl(ctx);\n\theader->copro_hdl = ctx->copro_hdl;\n\theader->command = command;\n}\n\nint delta_ipc_open(struct delta_ctx *pctx, const char *name,\n\t\t   struct delta_ipc_param *param, u32 ipc_buf_size,\n\t\t   struct delta_buf **ipc_buf, void **hdl)\n{\n\tstruct delta_dev *delta = pctx->dev;\n\tstruct rpmsg_device *rpmsg_device = delta->rpmsg_device;\n\tstruct delta_ipc_ctx *ctx = &pctx->ipc_ctx;\n\tstruct delta_ipc_open_msg msg;\n\tstruct delta_buf *buf = &ctx->ipc_buf_struct;\n\tint ret;\n\n\tif (!rpmsg_device) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to open, rpmsg is not initialized\\n\",\n\t\t\tpctx->name);\n\t\tpctx->sys_errors++;\n\t\treturn -EINVAL;\n\t}\n\n\tif (!name) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to open, no name given\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!param || !param->data || !param->size) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s  ipc: failed to open, empty parameter\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!ipc_buf_size) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to open, no size given for ipc buffer\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (param->size > ipc_buf_size) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to open, too large ipc parameter (%d bytes while max %d expected)\\n\",\n\t\t\tpctx->name,\n\t\t\tparam->size, ctx->ipc_buf->size);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tinit_completion(&ctx->done);\n\n\t \n\tret = hw_alloc(pctx, ipc_buf_size,\n\t\t       \"ipc data buffer\", buf);\n\tif (ret)\n\t\treturn ret;\n\tctx->ipc_buf = buf;\n\n\t \n\tbuild_msg_header(ctx, DELTA_IPC_OPEN, &msg.header);\n\n\tmsg.ipc_buf_size = ipc_buf_size;\n\tmsg.ipc_buf_paddr = ctx->ipc_buf->paddr;\n\n\tstrscpy(msg.name, name, sizeof(msg.name));\n\n\tmsg.param_size = param->size;\n\tmemcpy(ctx->ipc_buf->vaddr, param->data, msg.param_size);\n\tmsg.param_paddr = ctx->ipc_buf->paddr;\n\n\t \n\tret = rpmsg_send(rpmsg_device->ept, &msg, sizeof(msg));\n\tif (ret) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to open, rpmsg_send failed (%d) for DELTA_IPC_OPEN (name=%s, size=%d, data=%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tret, name, param->size, param->data);\n\t\tgoto err;\n\t}\n\n\t \n\tif (!wait_for_completion_timeout\n\t    (&ctx->done, msecs_to_jiffies(IPC_TIMEOUT))) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to open, timeout waiting for DELTA_IPC_OPEN callback (name=%s, size=%d, data=%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tname, param->size, param->data);\n\t\tret = -ETIMEDOUT;\n\t\tgoto err;\n\t}\n\n\t \n\tif (ctx->cb_err) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to open, DELTA_IPC_OPEN completed but with error (%d) (name=%s, size=%d, data=%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tctx->cb_err, name, param->size, param->data);\n\t\tret = -EIO;\n\t\tgoto err;\n\t}\n\n\t*ipc_buf = ctx->ipc_buf;\n\t*hdl = (void *)ctx;\n\n\treturn 0;\n\nerr:\n\tpctx->sys_errors++;\n\thw_free(pctx, ctx->ipc_buf);\n\tctx->ipc_buf = NULL;\n\n\treturn ret;\n};\n\nint delta_ipc_set_stream(void *hdl, struct delta_ipc_param *param)\n{\n\tstruct delta_ipc_ctx *ctx = to_ctx(hdl);\n\tstruct delta_ctx *pctx = to_pctx(ctx);\n\tstruct delta_dev *delta = pctx->dev;\n\tstruct rpmsg_device *rpmsg_device = delta->rpmsg_device;\n\tstruct delta_ipc_set_stream_msg msg;\n\tint ret;\n\n\tif (!hdl) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to set stream, invalid ipc handle\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!rpmsg_device) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to set stream, rpmsg is not initialized\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!param || !param->data || !param->size) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s  ipc: failed to set stream, empty parameter\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (param->size > ctx->ipc_buf->size) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to set stream, too large ipc parameter(%d bytes while max %d expected)\\n\",\n\t\t\tpctx->name,\n\t\t\tparam->size, ctx->ipc_buf->size);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!is_valid_data(ctx, param->data, param->size)) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to set stream, parameter is not in expected address range (size=%d, data=%p not in %p..%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tparam->size,\n\t\t\tparam->data,\n\t\t\tctx->ipc_buf->vaddr,\n\t\t\tctx->ipc_buf->vaddr + ctx->ipc_buf->size - 1);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tbuild_msg_header(ctx, DELTA_IPC_SET_STREAM, &msg.header);\n\n\tmsg.param_size = param->size;\n\tmsg.param_paddr = to_paddr(ctx, param->data);\n\n\t \n\tret = rpmsg_send(rpmsg_device->ept, &msg, sizeof(msg));\n\tif (ret) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to set stream, rpmsg_send failed (%d) for DELTA_IPC_SET_STREAM (size=%d, data=%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tret, param->size, param->data);\n\t\tpctx->sys_errors++;\n\t\treturn ret;\n\t}\n\n\t \n\tif (!wait_for_completion_timeout\n\t    (&ctx->done, msecs_to_jiffies(IPC_TIMEOUT))) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to set stream, timeout waiting for DELTA_IPC_SET_STREAM callback (size=%d, data=%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tparam->size, param->data);\n\t\tpctx->sys_errors++;\n\t\treturn -ETIMEDOUT;\n\t}\n\n\t \n\tif (ctx->cb_err) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to set stream, DELTA_IPC_SET_STREAM completed but with error (%d) (size=%d, data=%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tctx->cb_err, param->size, param->data);\n\t\tpctx->sys_errors++;\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nint delta_ipc_decode(void *hdl, struct delta_ipc_param *param,\n\t\t     struct delta_ipc_param *status)\n{\n\tstruct delta_ipc_ctx *ctx = to_ctx(hdl);\n\tstruct delta_ctx *pctx = to_pctx(ctx);\n\tstruct delta_dev *delta = pctx->dev;\n\tstruct rpmsg_device *rpmsg_device = delta->rpmsg_device;\n\tstruct delta_ipc_decode_msg msg;\n\tint ret;\n\n\tif (!hdl) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to decode, invalid ipc handle\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!rpmsg_device) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to decode, rpmsg is not initialized\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!param || !param->data || !param->size) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s  ipc: failed to decode, empty parameter\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!status || !status->data || !status->size) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s  ipc: failed to decode, empty status\\n\",\n\t\t\tpctx->name);\n\t\treturn -EINVAL;\n\t}\n\n\tif (param->size + status->size > ctx->ipc_buf->size) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to decode, too large ipc parameter (%d bytes (param) + %d bytes (status) while max %d expected)\\n\",\n\t\t\tpctx->name,\n\t\t\tparam->size,\n\t\t\tstatus->size,\n\t\t\tctx->ipc_buf->size);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!is_valid_data(ctx, param->data, param->size)) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to decode, parameter is not in expected address range (size=%d, data=%p not in %p..%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tparam->size,\n\t\t\tparam->data,\n\t\t\tctx->ipc_buf->vaddr,\n\t\t\tctx->ipc_buf->vaddr + ctx->ipc_buf->size - 1);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!is_valid_data(ctx, status->data, status->size)) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to decode, status is not in expected address range (size=%d, data=%p not in %p..%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tstatus->size,\n\t\t\tstatus->data,\n\t\t\tctx->ipc_buf->vaddr,\n\t\t\tctx->ipc_buf->vaddr + ctx->ipc_buf->size - 1);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tbuild_msg_header(ctx, DELTA_IPC_DECODE, &msg.header);\n\n\tmsg.param_size = param->size;\n\tmsg.param_paddr = to_paddr(ctx, param->data);\n\n\tmsg.status_size = status->size;\n\tmsg.status_paddr = to_paddr(ctx, status->data);\n\n\t \n\tret = rpmsg_send(rpmsg_device->ept, &msg, sizeof(msg));\n\tif (ret) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to decode, rpmsg_send failed (%d) for DELTA_IPC_DECODE (size=%d, data=%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tret, param->size, param->data);\n\t\tpctx->sys_errors++;\n\t\treturn ret;\n\t}\n\n\t \n\tif (!wait_for_completion_timeout\n\t    (&ctx->done, msecs_to_jiffies(IPC_TIMEOUT))) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to decode, timeout waiting for DELTA_IPC_DECODE callback (size=%d, data=%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tparam->size, param->data);\n\t\tpctx->sys_errors++;\n\t\treturn -ETIMEDOUT;\n\t}\n\n\t \n\tif (ctx->cb_err) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to decode, DELTA_IPC_DECODE completed but with error (%d) (size=%d, data=%p)\\n\",\n\t\t\tpctx->name,\n\t\t\tctx->cb_err, param->size, param->data);\n\t\tpctx->sys_errors++;\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n};\n\nvoid delta_ipc_close(void *hdl)\n{\n\tstruct delta_ipc_ctx *ctx = to_ctx(hdl);\n\tstruct delta_ctx *pctx = to_pctx(ctx);\n\tstruct delta_dev *delta = pctx->dev;\n\tstruct rpmsg_device *rpmsg_device = delta->rpmsg_device;\n\tstruct delta_ipc_close_msg msg;\n\tint ret;\n\n\tif (!hdl) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to close, invalid ipc handle\\n\",\n\t\t\tpctx->name);\n\t\treturn;\n\t}\n\n\tif (ctx->ipc_buf) {\n\t\thw_free(pctx, ctx->ipc_buf);\n\t\tctx->ipc_buf = NULL;\n\t}\n\n\tif (!rpmsg_device) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to close, rpmsg is not initialized\\n\",\n\t\t\tpctx->name);\n\t\treturn;\n\t}\n\n\t \n\tbuild_msg_header(ctx, DELTA_IPC_CLOSE, &msg.header);\n\n\t \n\tret = rpmsg_send(rpmsg_device->ept, &msg, sizeof(msg));\n\tif (ret) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to close, rpmsg_send failed (%d) for DELTA_IPC_CLOSE\\n\",\n\t\t\tpctx->name, ret);\n\t\tpctx->sys_errors++;\n\t\treturn;\n\t}\n\n\t \n\tif (!wait_for_completion_timeout\n\t    (&ctx->done, msecs_to_jiffies(IPC_TIMEOUT))) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to close, timeout waiting for DELTA_IPC_CLOSE callback\\n\",\n\t\t\tpctx->name);\n\t\tpctx->sys_errors++;\n\t\treturn;\n\t}\n\n\t \n\tif (ctx->cb_err) {\n\t\tdev_err(delta->dev,\n\t\t\t\"%s   ipc: failed to close, DELTA_IPC_CLOSE completed but with error (%d)\\n\",\n\t\t\tpctx->name, ctx->cb_err);\n\t\tpctx->sys_errors++;\n\t}\n};\n\nstatic int delta_ipc_cb(struct rpmsg_device *rpdev, void *data,\n\t\t\tint len, void *priv, u32 src)\n{\n\tstruct delta_ipc_ctx *ctx;\n\tstruct delta_ipc_cb_msg *msg;\n\n\t \n\tif (!rpdev) {\n\t\tdev_err(NULL, \"rpdev is NULL\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (!data || !len) {\n\t\tdev_err(&rpdev->dev,\n\t\t\t\"unexpected empty message received from src=%d\\n\", src);\n\t\treturn -EINVAL;\n\t}\n\n\tif (len != sizeof(*msg)) {\n\t\tdev_err(&rpdev->dev,\n\t\t\t\"unexpected message length received from src=%d (received %d bytes while %zu bytes expected)\\n\",\n\t\t\tlen, src, sizeof(*msg));\n\t\treturn -EINVAL;\n\t}\n\n\tmsg = (struct delta_ipc_cb_msg *)data;\n\tif (msg->header.tag != IPC_SANITY_TAG) {\n\t\tdev_err(&rpdev->dev,\n\t\t\t\"unexpected message tag received from src=%d (received %x tag while %x expected)\\n\",\n\t\t\tsrc, msg->header.tag, IPC_SANITY_TAG);\n\t\treturn -EINVAL;\n\t}\n\n\tctx = msg_to_ctx(msg);\n\tif (!ctx) {\n\t\tdev_err(&rpdev->dev,\n\t\t\t\"unexpected message with NULL host_hdl received from src=%d\\n\",\n\t\t\tsrc);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (!ctx->copro_hdl)\n\t\tctx->copro_hdl = msg_to_copro_hdl(msg);\n\n\t \n\tctx->cb_err = msg->err;\n\tcomplete(&ctx->done);\n\n\treturn 0;\n}\n\nstatic int delta_ipc_probe(struct rpmsg_device *rpmsg_device)\n{\n\tstruct rpmsg_driver *rpdrv = to_rpmsg_driver(rpmsg_device->dev.driver);\n\tstruct delta_dev *delta = to_delta(rpdrv);\n\n\tdelta->rpmsg_device = rpmsg_device;\n\n\treturn 0;\n}\n\nstatic void delta_ipc_remove(struct rpmsg_device *rpmsg_device)\n{\n\tstruct rpmsg_driver *rpdrv = to_rpmsg_driver(rpmsg_device->dev.driver);\n\tstruct delta_dev *delta = to_delta(rpdrv);\n\n\tdelta->rpmsg_device = NULL;\n}\n\nstatic struct rpmsg_device_id delta_ipc_device_id_table[] = {\n\t{.name = \"rpmsg-delta\"},\n\t{},\n};\n\nstatic struct rpmsg_driver delta_rpmsg_driver = {\n\t.drv = {.name = KBUILD_MODNAME},\n\t.id_table = delta_ipc_device_id_table,\n\t.probe = delta_ipc_probe,\n\t.callback = delta_ipc_cb,\n\t.remove = delta_ipc_remove,\n};\n\nint delta_ipc_init(struct delta_dev *delta)\n{\n\tdelta->rpmsg_driver = delta_rpmsg_driver;\n\n\treturn register_rpmsg_driver(&delta->rpmsg_driver);\n}\n\nvoid delta_ipc_exit(struct delta_dev *delta)\n{\n\tunregister_rpmsg_driver(&delta->rpmsg_driver);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}