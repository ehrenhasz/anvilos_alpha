{
  "module_name": "xilinx-vtc.c",
  "hash_id": "c79059124986041f0e4ae1cfcd715fbd778283c26f9f2a512a707c0deff5a107",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/xilinx/xilinx-vtc.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\n#include \"xilinx-vip.h\"\n#include \"xilinx-vtc.h\"\n\n#define XVTC_CONTROL_FIELD_ID_POL_SRC\t\t(1 << 26)\n#define XVTC_CONTROL_ACTIVE_CHROMA_POL_SRC\t(1 << 25)\n#define XVTC_CONTROL_ACTIVE_VIDEO_POL_SRC\t(1 << 24)\n#define XVTC_CONTROL_HSYNC_POL_SRC\t\t(1 << 23)\n#define XVTC_CONTROL_VSYNC_POL_SRC\t\t(1 << 22)\n#define XVTC_CONTROL_HBLANK_POL_SRC\t\t(1 << 21)\n#define XVTC_CONTROL_VBLANK_POL_SRC\t\t(1 << 20)\n#define XVTC_CONTROL_CHROMA_SRC\t\t\t(1 << 18)\n#define XVTC_CONTROL_VBLANK_HOFF_SRC\t\t(1 << 17)\n#define XVTC_CONTROL_VSYNC_END_SRC\t\t(1 << 16)\n#define XVTC_CONTROL_VSYNC_START_SRC\t\t(1 << 15)\n#define XVTC_CONTROL_ACTIVE_VSIZE_SRC\t\t(1 << 14)\n#define XVTC_CONTROL_FRAME_VSIZE_SRC\t\t(1 << 13)\n#define XVTC_CONTROL_HSYNC_END_SRC\t\t(1 << 11)\n#define XVTC_CONTROL_HSYNC_START_SRC\t\t(1 << 10)\n#define XVTC_CONTROL_ACTIVE_HSIZE_SRC\t\t(1 << 9)\n#define XVTC_CONTROL_FRAME_HSIZE_SRC\t\t(1 << 8)\n#define XVTC_CONTROL_SYNC_ENABLE\t\t(1 << 5)\n#define XVTC_CONTROL_DET_ENABLE\t\t\t(1 << 3)\n#define XVTC_CONTROL_GEN_ENABLE\t\t\t(1 << 2)\n\n#define XVTC_STATUS_FSYNC(n)\t\t\t((n) << 16)\n#define XVTC_STATUS_GEN_ACTIVE_VIDEO\t\t(1 << 13)\n#define XVTC_STATUS_GEN_VBLANK\t\t\t(1 << 12)\n#define XVTC_STATUS_DET_ACTIVE_VIDEO\t\t(1 << 11)\n#define XVTC_STATUS_DET_VBLANK\t\t\t(1 << 10)\n#define XVTC_STATUS_LOCK_LOSS\t\t\t(1 << 9)\n#define XVTC_STATUS_LOCK\t\t\t(1 << 8)\n\n#define XVTC_ERROR_ACTIVE_CHROMA_LOCK\t\t(1 << 21)\n#define XVTC_ERROR_ACTIVE_VIDEO_LOCK\t\t(1 << 20)\n#define XVTC_ERROR_HSYNC_LOCK\t\t\t(1 << 19)\n#define XVTC_ERROR_VSYNC_LOCK\t\t\t(1 << 18)\n#define XVTC_ERROR_HBLANK_LOCK\t\t\t(1 << 17)\n#define XVTC_ERROR_VBLANK_LOCK\t\t\t(1 << 16)\n\n#define XVTC_IRQ_ENABLE_FSYNC(n)\t\t((n) << 16)\n#define XVTC_IRQ_ENABLE_GEN_ACTIVE_VIDEO\t(1 << 13)\n#define XVTC_IRQ_ENABLE_GEN_VBLANK\t\t(1 << 12)\n#define XVTC_IRQ_ENABLE_DET_ACTIVE_VIDEO\t(1 << 11)\n#define XVTC_IRQ_ENABLE_DET_VBLANK\t\t(1 << 10)\n#define XVTC_IRQ_ENABLE_LOCK_LOSS\t\t(1 << 9)\n#define XVTC_IRQ_ENABLE_LOCK\t\t\t(1 << 8)\n\n \n\n#define XVTC_DETECTOR_OFFSET\t\t\t0x0020\n#define XVTC_GENERATOR_OFFSET\t\t\t0x0060\n\n#define XVTC_ACTIVE_SIZE\t\t\t0x0000\n#define XVTC_ACTIVE_VSIZE_SHIFT\t\t\t16\n#define XVTC_ACTIVE_VSIZE_MASK\t\t\t(0x1fff << 16)\n#define XVTC_ACTIVE_HSIZE_SHIFT\t\t\t0\n#define XVTC_ACTIVE_HSIZE_MASK\t\t\t(0x1fff << 0)\n\n#define XVTC_TIMING_STATUS\t\t\t0x0004\n#define XVTC_TIMING_STATUS_ACTIVE_VIDEO\t\t(1 << 2)\n#define XVTC_TIMING_STATUS_VBLANK\t\t(1 << 1)\n#define XVTC_TIMING_STATUS_LOCKED\t\t(1 << 0)\n\n#define XVTC_ENCODING\t\t\t\t0x0008\n#define XVTC_ENCODING_CHROMA_PARITY_SHIFT\t8\n#define XVTC_ENCODING_CHROMA_PARITY_MASK\t(3 << 8)\n#define XVTC_ENCODING_CHROMA_PARITY_EVEN_ALL\t(0 << 8)\n#define XVTC_ENCODING_CHROMA_PARITY_ODD_ALL\t(1 << 8)\n#define XVTC_ENCODING_CHROMA_PARITY_EVEN_EVEN\t(2 << 8)\n#define XVTC_ENCODING_CHROMA_PARITY_ODD_EVEN\t(3 << 8)\n#define XVTC_ENCODING_VIDEO_FORMAT_SHIFT\t0\n#define XVTC_ENCODING_VIDEO_FORMAT_MASK\t\t(0xf << 0)\n#define XVTC_ENCODING_VIDEO_FORMAT_YUV422\t(0 << 0)\n#define XVTC_ENCODING_VIDEO_FORMAT_YUV444\t(1 << 0)\n#define XVTC_ENCODING_VIDEO_FORMAT_RGB\t\t(2 << 0)\n#define XVTC_ENCODING_VIDEO_FORMAT_YUV420\t(3 << 0)\n\n#define XVTC_POLARITY\t\t\t\t0x000c\n#define XVTC_POLARITY_ACTIVE_CHROMA_POL\t\t(1 << 5)\n#define XVTC_POLARITY_ACTIVE_VIDEO_POL\t\t(1 << 4)\n#define XVTC_POLARITY_HSYNC_POL\t\t\t(1 << 3)\n#define XVTC_POLARITY_VSYNC_POL\t\t\t(1 << 2)\n#define XVTC_POLARITY_HBLANK_POL\t\t(1 << 1)\n#define XVTC_POLARITY_VBLANK_POL\t\t(1 << 0)\n\n#define XVTC_HSIZE\t\t\t\t0x0010\n#define XVTC_HSIZE_MASK\t\t\t\t(0x1fff << 0)\n\n#define XVTC_VSIZE\t\t\t\t0x0014\n#define XVTC_VSIZE_MASK\t\t\t\t(0x1fff << 0)\n\n#define XVTC_HSYNC\t\t\t\t0x0018\n#define XVTC_HSYNC_END_SHIFT\t\t\t16\n#define XVTC_HSYNC_END_MASK\t\t\t(0x1fff << 16)\n#define XVTC_HSYNC_START_SHIFT\t\t\t0\n#define XVTC_HSYNC_START_MASK\t\t\t(0x1fff << 0)\n\n#define XVTC_F0_VBLANK_H\t\t\t0x001c\n#define XVTC_F0_VBLANK_HEND_SHIFT\t\t16\n#define XVTC_F0_VBLANK_HEND_MASK\t\t(0x1fff << 16)\n#define XVTC_F0_VBLANK_HSTART_SHIFT\t\t0\n#define XVTC_F0_VBLANK_HSTART_MASK\t\t(0x1fff << 0)\n\n#define XVTC_F0_VSYNC_V\t\t\t\t0x0020\n#define XVTC_F0_VSYNC_VEND_SHIFT\t\t16\n#define XVTC_F0_VSYNC_VEND_MASK\t\t\t(0x1fff << 16)\n#define XVTC_F0_VSYNC_VSTART_SHIFT\t\t0\n#define XVTC_F0_VSYNC_VSTART_MASK\t\t(0x1fff << 0)\n\n#define XVTC_F0_VSYNC_H\t\t\t\t0x0024\n#define XVTC_F0_VSYNC_HEND_SHIFT\t\t16\n#define XVTC_F0_VSYNC_HEND_MASK\t\t\t(0x1fff << 16)\n#define XVTC_F0_VSYNC_HSTART_SHIFT\t\t0\n#define XVTC_F0_VSYNC_HSTART_MASK\t\t(0x1fff << 0)\n\n#define XVTC_FRAME_SYNC_CONFIG(n)\t\t(0x0100 + 4 * (n))\n#define XVTC_FRAME_SYNC_V_START_SHIFT\t\t16\n#define XVTC_FRAME_SYNC_V_START_MASK\t\t(0x1fff << 16)\n#define XVTC_FRAME_SYNC_H_START_SHIFT\t\t0\n#define XVTC_FRAME_SYNC_H_START_MASK\t\t(0x1fff << 0)\n\n#define XVTC_GENERATOR_GLOBAL_DELAY\t\t0x0104\n\n \nstruct xvtc_device {\n\tstruct xvip_device xvip;\n\tstruct list_head list;\n\n\tbool has_detector;\n\tbool has_generator;\n\n\tstruct xvtc_config config;\n};\n\nstatic LIST_HEAD(xvtc_list);\nstatic DEFINE_MUTEX(xvtc_lock);\n\nstatic inline void xvtc_gen_write(struct xvtc_device *xvtc, u32 addr, u32 value)\n{\n\txvip_write(&xvtc->xvip, XVTC_GENERATOR_OFFSET + addr, value);\n}\n\n \n\nint xvtc_generator_start(struct xvtc_device *xvtc,\n\t\t\t const struct xvtc_config *config)\n{\n\tint ret;\n\n\tif (!xvtc->has_generator)\n\t\treturn -ENXIO;\n\n\tret = clk_prepare_enable(xvtc->xvip.clk);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\txvtc_gen_write(xvtc, XVTC_POLARITY,\n\t\t       XVTC_POLARITY_ACTIVE_CHROMA_POL |\n\t\t       XVTC_POLARITY_ACTIVE_VIDEO_POL |\n\t\t       XVTC_POLARITY_HSYNC_POL | XVTC_POLARITY_VSYNC_POL |\n\t\t       XVTC_POLARITY_HBLANK_POL | XVTC_POLARITY_VBLANK_POL);\n\n\t \n\txvtc_gen_write(xvtc, XVTC_ENCODING, 0);\n\n\t \n\txvtc_gen_write(xvtc, XVTC_ACTIVE_SIZE,\n\t\t       (config->vblank_start << XVTC_ACTIVE_VSIZE_SHIFT) |\n\t\t       (config->hblank_start << XVTC_ACTIVE_HSIZE_SHIFT));\n\txvtc_gen_write(xvtc, XVTC_HSIZE, config->hsize);\n\txvtc_gen_write(xvtc, XVTC_VSIZE, config->vsize);\n\txvtc_gen_write(xvtc, XVTC_HSYNC,\n\t\t       (config->hsync_end << XVTC_HSYNC_END_SHIFT) |\n\t\t       (config->hsync_start << XVTC_HSYNC_START_SHIFT));\n\txvtc_gen_write(xvtc, XVTC_F0_VBLANK_H, 0);\n\txvtc_gen_write(xvtc, XVTC_F0_VSYNC_V,\n\t\t       (config->vsync_end << XVTC_F0_VSYNC_VEND_SHIFT) |\n\t\t       (config->vsync_start << XVTC_F0_VSYNC_VSTART_SHIFT));\n\txvtc_gen_write(xvtc, XVTC_F0_VSYNC_H, 0);\n\n\t \n\txvip_write(&xvtc->xvip, XVIP_CTRL_CONTROL,\n\t\t   XVTC_CONTROL_ACTIVE_CHROMA_POL_SRC |\n\t\t   XVTC_CONTROL_ACTIVE_VIDEO_POL_SRC |\n\t\t   XVTC_CONTROL_HSYNC_POL_SRC | XVTC_CONTROL_VSYNC_POL_SRC |\n\t\t   XVTC_CONTROL_HBLANK_POL_SRC | XVTC_CONTROL_VBLANK_POL_SRC |\n\t\t   XVTC_CONTROL_CHROMA_SRC | XVTC_CONTROL_VBLANK_HOFF_SRC |\n\t\t   XVTC_CONTROL_VSYNC_END_SRC | XVTC_CONTROL_VSYNC_START_SRC |\n\t\t   XVTC_CONTROL_ACTIVE_VSIZE_SRC |\n\t\t   XVTC_CONTROL_FRAME_VSIZE_SRC | XVTC_CONTROL_HSYNC_END_SRC |\n\t\t   XVTC_CONTROL_HSYNC_START_SRC |\n\t\t   XVTC_CONTROL_ACTIVE_HSIZE_SRC |\n\t\t   XVTC_CONTROL_FRAME_HSIZE_SRC | XVTC_CONTROL_GEN_ENABLE |\n\t\t   XVIP_CTRL_CONTROL_REG_UPDATE);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(xvtc_generator_start);\n\nint xvtc_generator_stop(struct xvtc_device *xvtc)\n{\n\tif (!xvtc->has_generator)\n\t\treturn -ENXIO;\n\n\txvip_write(&xvtc->xvip, XVIP_CTRL_CONTROL, 0);\n\n\tclk_disable_unprepare(xvtc->xvip.clk);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(xvtc_generator_stop);\n\nstruct xvtc_device *xvtc_of_get(struct device_node *np)\n{\n\tstruct device_node *xvtc_node;\n\tstruct xvtc_device *found = NULL;\n\tstruct xvtc_device *xvtc;\n\n\tif (!of_property_present(np, \"xlnx,vtc\"))\n\t\treturn NULL;\n\n\txvtc_node = of_parse_phandle(np, \"xlnx,vtc\", 0);\n\tif (xvtc_node == NULL)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tmutex_lock(&xvtc_lock);\n\tlist_for_each_entry(xvtc, &xvtc_list, list) {\n\t\tif (xvtc->xvip.dev->of_node == xvtc_node) {\n\t\t\tfound = xvtc;\n\t\t\tbreak;\n\t\t}\n\t}\n\tmutex_unlock(&xvtc_lock);\n\n\tof_node_put(xvtc_node);\n\n\tif (!found)\n\t\treturn ERR_PTR(-EPROBE_DEFER);\n\n\treturn found;\n}\nEXPORT_SYMBOL_GPL(xvtc_of_get);\n\nvoid xvtc_put(struct xvtc_device *xvtc)\n{\n}\nEXPORT_SYMBOL_GPL(xvtc_put);\n\n \n\nstatic void xvtc_register_device(struct xvtc_device *xvtc)\n{\n\tmutex_lock(&xvtc_lock);\n\tlist_add_tail(&xvtc->list, &xvtc_list);\n\tmutex_unlock(&xvtc_lock);\n}\n\nstatic void xvtc_unregister_device(struct xvtc_device *xvtc)\n{\n\tmutex_lock(&xvtc_lock);\n\tlist_del(&xvtc->list);\n\tmutex_unlock(&xvtc_lock);\n}\n\n \n\nstatic int xvtc_parse_of(struct xvtc_device *xvtc)\n{\n\tstruct device_node *node = xvtc->xvip.dev->of_node;\n\n\txvtc->has_detector = of_property_read_bool(node, \"xlnx,detector\");\n\txvtc->has_generator = of_property_read_bool(node, \"xlnx,generator\");\n\n\treturn 0;\n}\n\nstatic int xvtc_probe(struct platform_device *pdev)\n{\n\tstruct xvtc_device *xvtc;\n\tint ret;\n\n\txvtc = devm_kzalloc(&pdev->dev, sizeof(*xvtc), GFP_KERNEL);\n\tif (!xvtc)\n\t\treturn -ENOMEM;\n\n\txvtc->xvip.dev = &pdev->dev;\n\n\tret = xvtc_parse_of(xvtc);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = xvip_init_resources(&xvtc->xvip);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tplatform_set_drvdata(pdev, xvtc);\n\n\txvip_print_version(&xvtc->xvip);\n\n\txvtc_register_device(xvtc);\n\n\treturn 0;\n}\n\nstatic void xvtc_remove(struct platform_device *pdev)\n{\n\tstruct xvtc_device *xvtc = platform_get_drvdata(pdev);\n\n\txvtc_unregister_device(xvtc);\n\n\txvip_cleanup_resources(&xvtc->xvip);\n}\n\nstatic const struct of_device_id xvtc_of_id_table[] = {\n\t{ .compatible = \"xlnx,v-tc-6.1\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, xvtc_of_id_table);\n\nstatic struct platform_driver xvtc_driver = {\n\t.driver = {\n\t\t.name = \"xilinx-vtc\",\n\t\t.of_match_table = xvtc_of_id_table,\n\t},\n\t.probe = xvtc_probe,\n\t.remove_new = xvtc_remove,\n};\n\nmodule_platform_driver(xvtc_driver);\n\nMODULE_AUTHOR(\"Laurent Pinchart <laurent.pinchart@ideasonboard.com>\");\nMODULE_DESCRIPTION(\"Xilinx Video Timing Controller Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}