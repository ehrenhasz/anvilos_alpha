{
  "module_name": "nal-hevc.c",
  "hash_id": "33df7ebf813e67ed973df228df1f4e764dc49855427c5c0dccc6f8e3f549bd78",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/allegro-dvt/nal-hevc.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/string.h>\n#include <linux/v4l2-controls.h>\n\n#include <linux/device.h>\n#include <linux/export.h>\n#include <linux/log2.h>\n\n#include \"nal-hevc.h\"\n#include \"nal-rbsp.h\"\n\n \nenum nal_unit_type {\n\tVPS_NUT = 32,\n\tSPS_NUT = 33,\n\tPPS_NUT = 34,\n\tFD_NUT = 38,\n};\n\nstatic void nal_hevc_write_start_code_prefix(struct rbsp *rbsp)\n{\n\tu8 *p = rbsp->data + DIV_ROUND_UP(rbsp->pos, 8);\n\tint i = 4;\n\n\tif (DIV_ROUND_UP(rbsp->pos, 8) + i > rbsp->size) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\tp[0] = 0x00;\n\tp[1] = 0x00;\n\tp[2] = 0x00;\n\tp[3] = 0x01;\n\n\trbsp->pos += i * 8;\n}\n\nstatic void nal_hevc_read_start_code_prefix(struct rbsp *rbsp)\n{\n\tu8 *p = rbsp->data + DIV_ROUND_UP(rbsp->pos, 8);\n\tint i = 4;\n\n\tif (DIV_ROUND_UP(rbsp->pos, 8) + i > rbsp->size) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\tif (p[0] != 0x00 || p[1] != 0x00 || p[2] != 0x00 || p[3] != 0x01) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\trbsp->pos += i * 8;\n}\n\nstatic void nal_hevc_write_filler_data(struct rbsp *rbsp)\n{\n\tu8 *p = rbsp->data + DIV_ROUND_UP(rbsp->pos, 8);\n\tint i;\n\n\t \n\ti = rbsp->size - DIV_ROUND_UP(rbsp->pos, 8) - 1;\n\tmemset(p, 0xff, i);\n\trbsp->pos += i * 8;\n}\n\nstatic void nal_hevc_read_filler_data(struct rbsp *rbsp)\n{\n\tu8 *p = rbsp->data + DIV_ROUND_UP(rbsp->pos, 8);\n\n\twhile (*p == 0xff) {\n\t\tif (DIV_ROUND_UP(rbsp->pos, 8) > rbsp->size) {\n\t\t\trbsp->error = -EINVAL;\n\t\t\treturn;\n\t\t}\n\n\t\tp++;\n\t\trbsp->pos += 8;\n\t}\n}\n\nstatic void nal_hevc_rbsp_profile_tier_level(struct rbsp *rbsp,\n\t\t\t\t\t     struct nal_hevc_profile_tier_level *ptl)\n{\n\tunsigned int i;\n\tunsigned int max_num_sub_layers_minus_1 = 0;\n\n\trbsp_bits(rbsp, 2, &ptl->general_profile_space);\n\trbsp_bit(rbsp, &ptl->general_tier_flag);\n\trbsp_bits(rbsp, 5, &ptl->general_profile_idc);\n\tfor (i = 0; i < 32; i++)\n\t\trbsp_bit(rbsp, &ptl->general_profile_compatibility_flag[i]);\n\trbsp_bit(rbsp, &ptl->general_progressive_source_flag);\n\trbsp_bit(rbsp, &ptl->general_interlaced_source_flag);\n\trbsp_bit(rbsp, &ptl->general_non_packed_constraint_flag);\n\trbsp_bit(rbsp, &ptl->general_frame_only_constraint_flag);\n\tif (ptl->general_profile_idc == 4 ||\n\t    ptl->general_profile_compatibility_flag[4] ||\n\t    ptl->general_profile_idc == 5 ||\n\t    ptl->general_profile_compatibility_flag[5] ||\n\t    ptl->general_profile_idc == 6 ||\n\t    ptl->general_profile_compatibility_flag[6] ||\n\t    ptl->general_profile_idc == 7 ||\n\t    ptl->general_profile_compatibility_flag[7] ||\n\t    ptl->general_profile_idc == 8 ||\n\t    ptl->general_profile_compatibility_flag[8] ||\n\t    ptl->general_profile_idc == 9 ||\n\t    ptl->general_profile_compatibility_flag[9] ||\n\t    ptl->general_profile_idc == 10 ||\n\t    ptl->general_profile_compatibility_flag[10]) {\n\t\trbsp_bit(rbsp, &ptl->general_max_12bit_constraint_flag);\n\t\trbsp_bit(rbsp, &ptl->general_max_10bit_constraint_flag);\n\t\trbsp_bit(rbsp, &ptl->general_max_8bit_constraint_flag);\n\t\trbsp_bit(rbsp, &ptl->general_max_422chroma_constraint_flag);\n\t\trbsp_bit(rbsp, &ptl->general_max_420chroma_constraint_flag);\n\t\trbsp_bit(rbsp, &ptl->general_max_monochrome_constraint_flag);\n\t\trbsp_bit(rbsp, &ptl->general_intra_constraint_flag);\n\t\trbsp_bit(rbsp, &ptl->general_one_picture_only_constraint_flag);\n\t\trbsp_bit(rbsp, &ptl->general_lower_bit_rate_constraint_flag);\n\t\tif (ptl->general_profile_idc == 5 ||\n\t\t    ptl->general_profile_compatibility_flag[5] ||\n\t\t    ptl->general_profile_idc == 9 ||\n\t\t    ptl->general_profile_compatibility_flag[9] ||\n\t\t    ptl->general_profile_idc == 10 ||\n\t\t    ptl->general_profile_compatibility_flag[10]) {\n\t\t\trbsp_bit(rbsp, &ptl->general_max_14bit_constraint_flag);\n\t\t\trbsp_bits(rbsp, 32, &ptl->general_reserved_zero_33bits);\n\t\t\trbsp_bits(rbsp, 33 - 32, &ptl->general_reserved_zero_33bits);\n\t\t} else {\n\t\t\trbsp_bits(rbsp, 32, &ptl->general_reserved_zero_34bits);\n\t\t\trbsp_bits(rbsp, 34 - 2, &ptl->general_reserved_zero_34bits);\n\t\t}\n\t} else if (ptl->general_profile_idc == 2 ||\n\t\t   ptl->general_profile_compatibility_flag[2]) {\n\t\trbsp_bits(rbsp, 7, &ptl->general_reserved_zero_7bits);\n\t\trbsp_bit(rbsp, &ptl->general_one_picture_only_constraint_flag);\n\t\trbsp_bits(rbsp, 32, &ptl->general_reserved_zero_35bits);\n\t\trbsp_bits(rbsp, 35 - 32, &ptl->general_reserved_zero_35bits);\n\t} else {\n\t\trbsp_bits(rbsp, 32, &ptl->general_reserved_zero_43bits);\n\t\trbsp_bits(rbsp, 43 - 32, &ptl->general_reserved_zero_43bits);\n\t}\n\tif ((ptl->general_profile_idc >= 1 && ptl->general_profile_idc <= 5) ||\n\t    ptl->general_profile_idc == 9 ||\n\t    ptl->general_profile_compatibility_flag[1] ||\n\t    ptl->general_profile_compatibility_flag[2] ||\n\t    ptl->general_profile_compatibility_flag[3] ||\n\t    ptl->general_profile_compatibility_flag[4] ||\n\t    ptl->general_profile_compatibility_flag[5] ||\n\t    ptl->general_profile_compatibility_flag[9])\n\t\trbsp_bit(rbsp, &ptl->general_inbld_flag);\n\telse\n\t\trbsp_bit(rbsp, &ptl->general_reserved_zero_bit);\n\trbsp_bits(rbsp, 8, &ptl->general_level_idc);\n\tif (max_num_sub_layers_minus_1 > 0)\n\t\trbsp_unsupported(rbsp);\n}\n\nstatic void nal_hevc_rbsp_vps(struct rbsp *rbsp, struct nal_hevc_vps *vps)\n{\n\tunsigned int i, j;\n\tunsigned int reserved_0xffff_16bits = 0xffff;\n\n\trbsp_bits(rbsp, 4, &vps->video_parameter_set_id);\n\trbsp_bit(rbsp, &vps->base_layer_internal_flag);\n\trbsp_bit(rbsp, &vps->base_layer_available_flag);\n\trbsp_bits(rbsp, 6, &vps->max_layers_minus1);\n\trbsp_bits(rbsp, 3, &vps->max_sub_layers_minus1);\n\trbsp_bits(rbsp, 1, &vps->temporal_id_nesting_flag);\n\trbsp_bits(rbsp, 16, &reserved_0xffff_16bits);\n\tnal_hevc_rbsp_profile_tier_level(rbsp, &vps->profile_tier_level);\n\trbsp_bit(rbsp, &vps->sub_layer_ordering_info_present_flag);\n\tfor (i = vps->sub_layer_ordering_info_present_flag ? 0 : vps->max_sub_layers_minus1;\n\t     i <= vps->max_sub_layers_minus1; i++) {\n\t\trbsp_uev(rbsp, &vps->max_dec_pic_buffering_minus1[i]);\n\t\trbsp_uev(rbsp, &vps->max_num_reorder_pics[i]);\n\t\trbsp_uev(rbsp, &vps->max_latency_increase_plus1[i]);\n\t}\n\trbsp_bits(rbsp, 6, &vps->max_layer_id);\n\trbsp_uev(rbsp, &vps->num_layer_sets_minus1);\n\tfor (i = 0; i <= vps->num_layer_sets_minus1; i++)\n\t\tfor (j = 0; j <= vps->max_layer_id; j++)\n\t\t\trbsp_bit(rbsp, &vps->layer_id_included_flag[i][j]);\n\trbsp_bit(rbsp, &vps->timing_info_present_flag);\n\tif (vps->timing_info_present_flag)\n\t\trbsp_unsupported(rbsp);\n\trbsp_bit(rbsp, &vps->extension_flag);\n\tif (vps->extension_flag)\n\t\trbsp_unsupported(rbsp);\n}\n\nstatic void nal_hevc_rbsp_sub_layer_hrd_parameters(struct rbsp *rbsp,\n\t\t\t\t\t\t   struct nal_hevc_sub_layer_hrd_parameters *hrd)\n{\n\tunsigned int i;\n\tunsigned int cpb_cnt = 1;\n\n\tfor (i = 0; i < cpb_cnt; i++) {\n\t\trbsp_uev(rbsp, &hrd->bit_rate_value_minus1[i]);\n\t\trbsp_uev(rbsp, &hrd->cpb_size_value_minus1[i]);\n\t\trbsp_bit(rbsp, &hrd->cbr_flag[i]);\n\t}\n}\n\nstatic void nal_hevc_rbsp_hrd_parameters(struct rbsp *rbsp,\n\t\t\t\t\t struct nal_hevc_hrd_parameters *hrd)\n{\n\tunsigned int i;\n\tunsigned int max_num_sub_layers_minus_1 = 0;\n\n\trbsp_bit(rbsp, &hrd->nal_hrd_parameters_present_flag);\n\trbsp_bit(rbsp, &hrd->vcl_hrd_parameters_present_flag);\n\tif (hrd->nal_hrd_parameters_present_flag || hrd->vcl_hrd_parameters_present_flag) {\n\t\trbsp_bit(rbsp, &hrd->sub_pic_hrd_params_present_flag);\n\t\tif (hrd->sub_pic_hrd_params_present_flag) {\n\t\t\trbsp_bits(rbsp, 8, &hrd->tick_divisor_minus2);\n\t\t\trbsp_bits(rbsp, 5, &hrd->du_cpb_removal_delay_increment_length_minus1);\n\t\t\trbsp_bit(rbsp, &hrd->sub_pic_cpb_params_in_pic_timing_sei_flag);\n\t\t\trbsp_bits(rbsp, 5, &hrd->dpb_output_delay_du_length_minus1);\n\t\t}\n\t\trbsp_bits(rbsp, 4, &hrd->bit_rate_scale);\n\t\trbsp_bits(rbsp, 4, &hrd->cpb_size_scale);\n\t\tif (hrd->sub_pic_hrd_params_present_flag)\n\t\t\trbsp_bits(rbsp, 4, &hrd->cpb_size_du_scale);\n\t\trbsp_bits(rbsp, 5, &hrd->initial_cpb_removal_delay_length_minus1);\n\t\trbsp_bits(rbsp, 5, &hrd->au_cpb_removal_delay_length_minus1);\n\t\trbsp_bits(rbsp, 5, &hrd->dpb_output_delay_length_minus1);\n\t}\n\tfor (i = 0; i <= max_num_sub_layers_minus_1; i++) {\n\t\trbsp_bit(rbsp, &hrd->fixed_pic_rate_general_flag[i]);\n\t\tif (!hrd->fixed_pic_rate_general_flag[i])\n\t\t\trbsp_bit(rbsp, &hrd->fixed_pic_rate_within_cvs_flag[i]);\n\t\tif (hrd->fixed_pic_rate_within_cvs_flag[i])\n\t\t\trbsp_uev(rbsp, &hrd->elemental_duration_in_tc_minus1[i]);\n\t\telse\n\t\t\trbsp_bit(rbsp, &hrd->low_delay_hrd_flag[i]);\n\t\tif (!hrd->low_delay_hrd_flag[i])\n\t\t\trbsp_uev(rbsp, &hrd->cpb_cnt_minus1[i]);\n\t\tif (hrd->nal_hrd_parameters_present_flag)\n\t\t\tnal_hevc_rbsp_sub_layer_hrd_parameters(rbsp, &hrd->vcl_hrd[i]);\n\t\tif (hrd->vcl_hrd_parameters_present_flag)\n\t\t\tnal_hevc_rbsp_sub_layer_hrd_parameters(rbsp, &hrd->vcl_hrd[i]);\n\t}\n}\n\nstatic void nal_hevc_rbsp_vui_parameters(struct rbsp *rbsp,\n\t\t\t\t\t struct nal_hevc_vui_parameters *vui)\n{\n\tif (!vui) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\trbsp_bit(rbsp, &vui->aspect_ratio_info_present_flag);\n\tif (vui->aspect_ratio_info_present_flag) {\n\t\trbsp_bits(rbsp, 8, &vui->aspect_ratio_idc);\n\t\tif (vui->aspect_ratio_idc == 255) {\n\t\t\trbsp_bits(rbsp, 16, &vui->sar_width);\n\t\t\trbsp_bits(rbsp, 16, &vui->sar_height);\n\t\t}\n\t}\n\n\trbsp_bit(rbsp, &vui->overscan_info_present_flag);\n\tif (vui->overscan_info_present_flag)\n\t\trbsp_bit(rbsp, &vui->overscan_appropriate_flag);\n\n\trbsp_bit(rbsp, &vui->video_signal_type_present_flag);\n\tif (vui->video_signal_type_present_flag) {\n\t\trbsp_bits(rbsp, 3, &vui->video_format);\n\t\trbsp_bit(rbsp, &vui->video_full_range_flag);\n\n\t\trbsp_bit(rbsp, &vui->colour_description_present_flag);\n\t\tif (vui->colour_description_present_flag) {\n\t\t\trbsp_bits(rbsp, 8, &vui->colour_primaries);\n\t\t\trbsp_bits(rbsp, 8, &vui->transfer_characteristics);\n\t\t\trbsp_bits(rbsp, 8, &vui->matrix_coeffs);\n\t\t}\n\t}\n\n\trbsp_bit(rbsp, &vui->chroma_loc_info_present_flag);\n\tif (vui->chroma_loc_info_present_flag) {\n\t\trbsp_uev(rbsp, &vui->chroma_sample_loc_type_top_field);\n\t\trbsp_uev(rbsp, &vui->chroma_sample_loc_type_bottom_field);\n\t}\n\n\trbsp_bit(rbsp, &vui->neutral_chroma_indication_flag);\n\trbsp_bit(rbsp, &vui->field_seq_flag);\n\trbsp_bit(rbsp, &vui->frame_field_info_present_flag);\n\trbsp_bit(rbsp, &vui->default_display_window_flag);\n\tif (vui->default_display_window_flag) {\n\t\trbsp_uev(rbsp, &vui->def_disp_win_left_offset);\n\t\trbsp_uev(rbsp, &vui->def_disp_win_right_offset);\n\t\trbsp_uev(rbsp, &vui->def_disp_win_top_offset);\n\t\trbsp_uev(rbsp, &vui->def_disp_win_bottom_offset);\n\t}\n\n\trbsp_bit(rbsp, &vui->vui_timing_info_present_flag);\n\tif (vui->vui_timing_info_present_flag) {\n\t\trbsp_bits(rbsp, 32, &vui->vui_num_units_in_tick);\n\t\trbsp_bits(rbsp, 32, &vui->vui_time_scale);\n\t\trbsp_bit(rbsp, &vui->vui_poc_proportional_to_timing_flag);\n\t\tif (vui->vui_poc_proportional_to_timing_flag)\n\t\t\trbsp_uev(rbsp, &vui->vui_num_ticks_poc_diff_one_minus1);\n\t\trbsp_bit(rbsp, &vui->vui_hrd_parameters_present_flag);\n\t\tif (vui->vui_hrd_parameters_present_flag)\n\t\t\tnal_hevc_rbsp_hrd_parameters(rbsp, &vui->nal_hrd_parameters);\n\t}\n\n\trbsp_bit(rbsp, &vui->bitstream_restriction_flag);\n\tif (vui->bitstream_restriction_flag) {\n\t\trbsp_bit(rbsp, &vui->tiles_fixed_structure_flag);\n\t\trbsp_bit(rbsp, &vui->motion_vectors_over_pic_boundaries_flag);\n\t\trbsp_bit(rbsp, &vui->restricted_ref_pic_lists_flag);\n\t\trbsp_uev(rbsp, &vui->min_spatial_segmentation_idc);\n\t\trbsp_uev(rbsp, &vui->max_bytes_per_pic_denom);\n\t\trbsp_uev(rbsp, &vui->max_bits_per_min_cu_denom);\n\t\trbsp_uev(rbsp, &vui->log2_max_mv_length_horizontal);\n\t\trbsp_uev(rbsp, &vui->log2_max_mv_length_vertical);\n\t}\n}\n\nstatic void nal_hevc_rbsp_sps(struct rbsp *rbsp, struct nal_hevc_sps *sps)\n{\n\tunsigned int i;\n\n\trbsp_bits(rbsp, 4, &sps->video_parameter_set_id);\n\trbsp_bits(rbsp, 3, &sps->max_sub_layers_minus1);\n\trbsp_bit(rbsp, &sps->temporal_id_nesting_flag);\n\tnal_hevc_rbsp_profile_tier_level(rbsp, &sps->profile_tier_level);\n\trbsp_uev(rbsp, &sps->seq_parameter_set_id);\n\n\trbsp_uev(rbsp, &sps->chroma_format_idc);\n\tif (sps->chroma_format_idc == 3)\n\t\trbsp_bit(rbsp, &sps->separate_colour_plane_flag);\n\trbsp_uev(rbsp, &sps->pic_width_in_luma_samples);\n\trbsp_uev(rbsp, &sps->pic_height_in_luma_samples);\n\trbsp_bit(rbsp, &sps->conformance_window_flag);\n\tif (sps->conformance_window_flag) {\n\t\trbsp_uev(rbsp, &sps->conf_win_left_offset);\n\t\trbsp_uev(rbsp, &sps->conf_win_right_offset);\n\t\trbsp_uev(rbsp, &sps->conf_win_top_offset);\n\t\trbsp_uev(rbsp, &sps->conf_win_bottom_offset);\n\t}\n\trbsp_uev(rbsp, &sps->bit_depth_luma_minus8);\n\trbsp_uev(rbsp, &sps->bit_depth_chroma_minus8);\n\n\trbsp_uev(rbsp, &sps->log2_max_pic_order_cnt_lsb_minus4);\n\n\trbsp_bit(rbsp, &sps->sub_layer_ordering_info_present_flag);\n\tfor (i = (sps->sub_layer_ordering_info_present_flag ? 0 : sps->max_sub_layers_minus1);\n\t     i <= sps->max_sub_layers_minus1; i++) {\n\t\trbsp_uev(rbsp, &sps->max_dec_pic_buffering_minus1[i]);\n\t\trbsp_uev(rbsp, &sps->max_num_reorder_pics[i]);\n\t\trbsp_uev(rbsp, &sps->max_latency_increase_plus1[i]);\n\t}\n\trbsp_uev(rbsp, &sps->log2_min_luma_coding_block_size_minus3);\n\trbsp_uev(rbsp, &sps->log2_diff_max_min_luma_coding_block_size);\n\trbsp_uev(rbsp, &sps->log2_min_luma_transform_block_size_minus2);\n\trbsp_uev(rbsp, &sps->log2_diff_max_min_luma_transform_block_size);\n\trbsp_uev(rbsp, &sps->max_transform_hierarchy_depth_inter);\n\trbsp_uev(rbsp, &sps->max_transform_hierarchy_depth_intra);\n\n\trbsp_bit(rbsp, &sps->scaling_list_enabled_flag);\n\tif (sps->scaling_list_enabled_flag)\n\t\trbsp_unsupported(rbsp);\n\n\trbsp_bit(rbsp, &sps->amp_enabled_flag);\n\trbsp_bit(rbsp, &sps->sample_adaptive_offset_enabled_flag);\n\trbsp_bit(rbsp, &sps->pcm_enabled_flag);\n\tif (sps->pcm_enabled_flag) {\n\t\trbsp_bits(rbsp, 4, &sps->pcm_sample_bit_depth_luma_minus1);\n\t\trbsp_bits(rbsp, 4, &sps->pcm_sample_bit_depth_chroma_minus1);\n\t\trbsp_uev(rbsp, &sps->log2_min_pcm_luma_coding_block_size_minus3);\n\t\trbsp_uev(rbsp, &sps->log2_diff_max_min_pcm_luma_coding_block_size);\n\t\trbsp_bit(rbsp, &sps->pcm_loop_filter_disabled_flag);\n\t}\n\n\trbsp_uev(rbsp, &sps->num_short_term_ref_pic_sets);\n\tif (sps->num_short_term_ref_pic_sets > 0)\n\t\trbsp_unsupported(rbsp);\n\n\trbsp_bit(rbsp, &sps->long_term_ref_pics_present_flag);\n\tif (sps->long_term_ref_pics_present_flag)\n\t\trbsp_unsupported(rbsp);\n\n\trbsp_bit(rbsp, &sps->sps_temporal_mvp_enabled_flag);\n\trbsp_bit(rbsp, &sps->strong_intra_smoothing_enabled_flag);\n\trbsp_bit(rbsp, &sps->vui_parameters_present_flag);\n\tif (sps->vui_parameters_present_flag)\n\t\tnal_hevc_rbsp_vui_parameters(rbsp, &sps->vui);\n\n\trbsp_bit(rbsp, &sps->extension_present_flag);\n\tif (sps->extension_present_flag) {\n\t\trbsp_bit(rbsp, &sps->sps_range_extension_flag);\n\t\trbsp_bit(rbsp, &sps->sps_multilayer_extension_flag);\n\t\trbsp_bit(rbsp, &sps->sps_3d_extension_flag);\n\t\trbsp_bit(rbsp, &sps->sps_scc_extension_flag);\n\t\trbsp_bits(rbsp, 5, &sps->sps_extension_4bits);\n\t}\n\tif (sps->sps_range_extension_flag)\n\t\trbsp_unsupported(rbsp);\n\tif (sps->sps_multilayer_extension_flag)\n\t\trbsp_unsupported(rbsp);\n\tif (sps->sps_3d_extension_flag)\n\t\trbsp_unsupported(rbsp);\n\tif (sps->sps_scc_extension_flag)\n\t\trbsp_unsupported(rbsp);\n\tif (sps->sps_extension_4bits)\n\t\trbsp_unsupported(rbsp);\n}\n\nstatic void nal_hevc_rbsp_pps(struct rbsp *rbsp, struct nal_hevc_pps *pps)\n{\n\tunsigned int i;\n\n\trbsp_uev(rbsp, &pps->pps_pic_parameter_set_id);\n\trbsp_uev(rbsp, &pps->pps_seq_parameter_set_id);\n\trbsp_bit(rbsp, &pps->dependent_slice_segments_enabled_flag);\n\trbsp_bit(rbsp, &pps->output_flag_present_flag);\n\trbsp_bits(rbsp, 3, &pps->num_extra_slice_header_bits);\n\trbsp_bit(rbsp, &pps->sign_data_hiding_enabled_flag);\n\trbsp_bit(rbsp, &pps->cabac_init_present_flag);\n\trbsp_uev(rbsp, &pps->num_ref_idx_l0_default_active_minus1);\n\trbsp_uev(rbsp, &pps->num_ref_idx_l1_default_active_minus1);\n\trbsp_sev(rbsp, &pps->init_qp_minus26);\n\trbsp_bit(rbsp, &pps->constrained_intra_pred_flag);\n\trbsp_bit(rbsp, &pps->transform_skip_enabled_flag);\n\trbsp_bit(rbsp, &pps->cu_qp_delta_enabled_flag);\n\tif (pps->cu_qp_delta_enabled_flag)\n\t\trbsp_uev(rbsp, &pps->diff_cu_qp_delta_depth);\n\trbsp_sev(rbsp, &pps->pps_cb_qp_offset);\n\trbsp_sev(rbsp, &pps->pps_cr_qp_offset);\n\trbsp_bit(rbsp, &pps->pps_slice_chroma_qp_offsets_present_flag);\n\trbsp_bit(rbsp, &pps->weighted_pred_flag);\n\trbsp_bit(rbsp, &pps->weighted_bipred_flag);\n\trbsp_bit(rbsp, &pps->transquant_bypass_enabled_flag);\n\trbsp_bit(rbsp, &pps->tiles_enabled_flag);\n\trbsp_bit(rbsp, &pps->entropy_coding_sync_enabled_flag);\n\tif (pps->tiles_enabled_flag) {\n\t\trbsp_uev(rbsp, &pps->num_tile_columns_minus1);\n\t\trbsp_uev(rbsp, &pps->num_tile_rows_minus1);\n\t\trbsp_bit(rbsp, &pps->uniform_spacing_flag);\n\t\tif (!pps->uniform_spacing_flag) {\n\t\t\tfor (i = 0; i < pps->num_tile_columns_minus1; i++)\n\t\t\t\trbsp_uev(rbsp, &pps->column_width_minus1[i]);\n\t\t\tfor (i = 0; i < pps->num_tile_rows_minus1; i++)\n\t\t\t\trbsp_uev(rbsp, &pps->row_height_minus1[i]);\n\t\t}\n\t\trbsp_bit(rbsp, &pps->loop_filter_across_tiles_enabled_flag);\n\t}\n\trbsp_bit(rbsp, &pps->pps_loop_filter_across_slices_enabled_flag);\n\trbsp_bit(rbsp, &pps->deblocking_filter_control_present_flag);\n\tif (pps->deblocking_filter_control_present_flag) {\n\t\trbsp_bit(rbsp, &pps->deblocking_filter_override_enabled_flag);\n\t\trbsp_bit(rbsp, &pps->pps_deblocking_filter_disabled_flag);\n\t\tif (!pps->pps_deblocking_filter_disabled_flag) {\n\t\t\trbsp_sev(rbsp, &pps->pps_beta_offset_div2);\n\t\t\trbsp_sev(rbsp, &pps->pps_tc_offset_div2);\n\t\t}\n\t}\n\trbsp_bit(rbsp, &pps->pps_scaling_list_data_present_flag);\n\tif (pps->pps_scaling_list_data_present_flag)\n\t\trbsp_unsupported(rbsp);\n\trbsp_bit(rbsp, &pps->lists_modification_present_flag);\n\trbsp_uev(rbsp, &pps->log2_parallel_merge_level_minus2);\n\trbsp_bit(rbsp, &pps->slice_segment_header_extension_present_flag);\n\trbsp_bit(rbsp, &pps->pps_extension_present_flag);\n\tif (pps->pps_extension_present_flag) {\n\t\trbsp_bit(rbsp, &pps->pps_range_extension_flag);\n\t\trbsp_bit(rbsp, &pps->pps_multilayer_extension_flag);\n\t\trbsp_bit(rbsp, &pps->pps_3d_extension_flag);\n\t\trbsp_bit(rbsp, &pps->pps_scc_extension_flag);\n\t\trbsp_bits(rbsp, 4, &pps->pps_extension_4bits);\n\t}\n\tif (pps->pps_range_extension_flag)\n\t\trbsp_unsupported(rbsp);\n\tif (pps->pps_multilayer_extension_flag)\n\t\trbsp_unsupported(rbsp);\n\tif (pps->pps_3d_extension_flag)\n\t\trbsp_unsupported(rbsp);\n\tif (pps->pps_scc_extension_flag)\n\t\trbsp_unsupported(rbsp);\n\tif (pps->pps_extension_4bits)\n\t\trbsp_unsupported(rbsp);\n}\n\n \nssize_t nal_hevc_write_vps(const struct device *dev,\n\t\t\t   void *dest, size_t n, struct nal_hevc_vps *vps)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit = 0;\n\tunsigned int nal_unit_type = VPS_NUT;\n\tunsigned int nuh_layer_id = 0;\n\tunsigned int nuh_temporal_id_plus1 = 1;\n\n\tif (!dest)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, dest, n, &write);\n\n\tnal_hevc_write_start_code_prefix(&rbsp);\n\n\t \n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 6, &nal_unit_type);\n\trbsp_bits(&rbsp, 6, &nuh_layer_id);\n\trbsp_bits(&rbsp, 3, &nuh_temporal_id_plus1);\n\n\tnal_hevc_rbsp_vps(&rbsp, vps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_hevc_write_vps);\n\n \nssize_t nal_hevc_read_vps(const struct device *dev,\n\t\t\t  struct nal_hevc_vps *vps, void *src, size_t n)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit;\n\tunsigned int nal_unit_type;\n\tunsigned int nuh_layer_id;\n\tunsigned int nuh_temporal_id_plus1;\n\n\tif (!src)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, src, n, &read);\n\n\tnal_hevc_read_start_code_prefix(&rbsp);\n\n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 6, &nal_unit_type);\n\trbsp_bits(&rbsp, 6, &nuh_layer_id);\n\trbsp_bits(&rbsp, 3, &nuh_temporal_id_plus1);\n\n\tif (rbsp.error ||\n\t    forbidden_zero_bit != 0 ||\n\t    nal_unit_type != VPS_NUT)\n\t\treturn -EINVAL;\n\n\tnal_hevc_rbsp_vps(&rbsp, vps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_hevc_read_vps);\n\n \nssize_t nal_hevc_write_sps(const struct device *dev,\n\t\t\t   void *dest, size_t n, struct nal_hevc_sps *sps)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit = 0;\n\tunsigned int nal_unit_type = SPS_NUT;\n\tunsigned int nuh_layer_id = 0;\n\tunsigned int nuh_temporal_id_plus1 = 1;\n\n\tif (!dest)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, dest, n, &write);\n\n\tnal_hevc_write_start_code_prefix(&rbsp);\n\n\t \n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 6, &nal_unit_type);\n\trbsp_bits(&rbsp, 6, &nuh_layer_id);\n\trbsp_bits(&rbsp, 3, &nuh_temporal_id_plus1);\n\n\tnal_hevc_rbsp_sps(&rbsp, sps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_hevc_write_sps);\n\n \nssize_t nal_hevc_read_sps(const struct device *dev,\n\t\t\t  struct nal_hevc_sps *sps, void *src, size_t n)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit;\n\tunsigned int nal_unit_type;\n\tunsigned int nuh_layer_id;\n\tunsigned int nuh_temporal_id_plus1;\n\n\tif (!src)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, src, n, &read);\n\n\tnal_hevc_read_start_code_prefix(&rbsp);\n\n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 6, &nal_unit_type);\n\trbsp_bits(&rbsp, 6, &nuh_layer_id);\n\trbsp_bits(&rbsp, 3, &nuh_temporal_id_plus1);\n\n\tif (rbsp.error ||\n\t    forbidden_zero_bit != 0 ||\n\t    nal_unit_type != SPS_NUT)\n\t\treturn -EINVAL;\n\n\tnal_hevc_rbsp_sps(&rbsp, sps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_hevc_read_sps);\n\n \nssize_t nal_hevc_write_pps(const struct device *dev,\n\t\t\t   void *dest, size_t n, struct nal_hevc_pps *pps)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit = 0;\n\tunsigned int nal_unit_type = PPS_NUT;\n\tunsigned int nuh_layer_id = 0;\n\tunsigned int nuh_temporal_id_plus1 = 1;\n\n\tif (!dest)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, dest, n, &write);\n\n\tnal_hevc_write_start_code_prefix(&rbsp);\n\n\t \n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 6, &nal_unit_type);\n\trbsp_bits(&rbsp, 6, &nuh_layer_id);\n\trbsp_bits(&rbsp, 3, &nuh_temporal_id_plus1);\n\n\tnal_hevc_rbsp_pps(&rbsp, pps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_hevc_write_pps);\n\n \nssize_t nal_hevc_read_pps(const struct device *dev,\n\t\t\t  struct nal_hevc_pps *pps, void *src, size_t n)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit;\n\tunsigned int nal_unit_type;\n\tunsigned int nuh_layer_id;\n\tunsigned int nuh_temporal_id_plus1;\n\n\tif (!src)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, src, n, &read);\n\n\tnal_hevc_read_start_code_prefix(&rbsp);\n\n\t \n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 6, &nal_unit_type);\n\trbsp_bits(&rbsp, 6, &nuh_layer_id);\n\trbsp_bits(&rbsp, 3, &nuh_temporal_id_plus1);\n\n\tnal_hevc_rbsp_pps(&rbsp, pps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_hevc_read_pps);\n\n \nssize_t nal_hevc_write_filler(const struct device *dev, void *dest, size_t n)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit = 0;\n\tunsigned int nal_unit_type = FD_NUT;\n\tunsigned int nuh_layer_id = 0;\n\tunsigned int nuh_temporal_id_plus1 = 1;\n\n\tif (!dest)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, dest, n, &write);\n\n\tnal_hevc_write_start_code_prefix(&rbsp);\n\n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 6, &nal_unit_type);\n\trbsp_bits(&rbsp, 6, &nuh_layer_id);\n\trbsp_bits(&rbsp, 3, &nuh_temporal_id_plus1);\n\n\tnal_hevc_write_filler_data(&rbsp);\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_hevc_write_filler);\n\n \nssize_t nal_hevc_read_filler(const struct device *dev, void *src, size_t n)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit;\n\tunsigned int nal_unit_type;\n\tunsigned int nuh_layer_id;\n\tunsigned int nuh_temporal_id_plus1;\n\n\tif (!src)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, src, n, &read);\n\n\tnal_hevc_read_start_code_prefix(&rbsp);\n\n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 6, &nal_unit_type);\n\trbsp_bits(&rbsp, 6, &nuh_layer_id);\n\trbsp_bits(&rbsp, 3, &nuh_temporal_id_plus1);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\tif (forbidden_zero_bit != 0 ||\n\t    nal_unit_type != FD_NUT)\n\t\treturn -EINVAL;\n\n\tnal_hevc_read_filler_data(&rbsp);\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_hevc_read_filler);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}