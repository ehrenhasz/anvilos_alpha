{
  "module_name": "nal-rbsp.c",
  "hash_id": "593b22ae76d8ce394381431d87cf8aeff8260f9a2f9bdb68ef663e88a6e5e8dc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/allegro-dvt/nal-rbsp.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/string.h>\n#include <linux/v4l2-controls.h>\n\n#include <linux/device.h>\n#include <linux/export.h>\n#include <linux/log2.h>\n\n#include \"nal-rbsp.h\"\n\nvoid rbsp_init(struct rbsp *rbsp, void *addr, size_t size,\n\t       struct nal_rbsp_ops *ops)\n{\n\tif (!rbsp)\n\t\treturn;\n\n\trbsp->data = addr;\n\trbsp->size = size;\n\trbsp->pos = 0;\n\trbsp->ops = ops;\n\trbsp->error = 0;\n}\n\nvoid rbsp_unsupported(struct rbsp *rbsp)\n{\n\trbsp->error = -EINVAL;\n}\n\nstatic int rbsp_read_bits(struct rbsp *rbsp, int n, unsigned int *value);\nstatic int rbsp_write_bits(struct rbsp *rbsp, int n, unsigned int value);\n\n \n#define EMULATION_PREVENTION_THREE_BYTE (0x3 << 6)\n\nstatic int add_emulation_prevention_three_byte(struct rbsp *rbsp)\n{\n\trbsp->num_consecutive_zeros = 0;\n\trbsp_write_bits(rbsp, 8, EMULATION_PREVENTION_THREE_BYTE);\n\n\treturn 0;\n}\n\nstatic int discard_emulation_prevention_three_byte(struct rbsp *rbsp)\n{\n\tunsigned int tmp = 0;\n\n\trbsp->num_consecutive_zeros = 0;\n\trbsp_read_bits(rbsp, 8, &tmp);\n\tif (tmp != EMULATION_PREVENTION_THREE_BYTE)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic inline int rbsp_read_bit(struct rbsp *rbsp)\n{\n\tint shift;\n\tint ofs;\n\tint bit;\n\tint err;\n\n\tif (rbsp->num_consecutive_zeros == 22) {\n\t\terr = discard_emulation_prevention_three_byte(rbsp);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tshift = 7 - (rbsp->pos % 8);\n\tofs = rbsp->pos / 8;\n\tif (ofs >= rbsp->size)\n\t\treturn -EINVAL;\n\n\tbit = (rbsp->data[ofs] >> shift) & 1;\n\n\trbsp->pos++;\n\n\tif (bit == 1 ||\n\t    (rbsp->num_consecutive_zeros < 7 && (rbsp->pos % 8 == 0)))\n\t\trbsp->num_consecutive_zeros = 0;\n\telse\n\t\trbsp->num_consecutive_zeros++;\n\n\treturn bit;\n}\n\nstatic inline int rbsp_write_bit(struct rbsp *rbsp, bool value)\n{\n\tint shift;\n\tint ofs;\n\n\tif (rbsp->num_consecutive_zeros == 22)\n\t\tadd_emulation_prevention_three_byte(rbsp);\n\n\tshift = 7 - (rbsp->pos % 8);\n\tofs = rbsp->pos / 8;\n\tif (ofs >= rbsp->size)\n\t\treturn -EINVAL;\n\n\trbsp->data[ofs] &= ~(1 << shift);\n\trbsp->data[ofs] |= value << shift;\n\n\trbsp->pos++;\n\n\tif (value ||\n\t    (rbsp->num_consecutive_zeros < 7 && (rbsp->pos % 8 == 0))) {\n\t\trbsp->num_consecutive_zeros = 0;\n\t} else {\n\t\trbsp->num_consecutive_zeros++;\n\t}\n\n\treturn 0;\n}\n\nstatic inline int rbsp_read_bits(struct rbsp *rbsp, int n, unsigned int *value)\n{\n\tint i;\n\tint bit;\n\tunsigned int tmp = 0;\n\n\tif (n > 8 * sizeof(*value))\n\t\treturn -EINVAL;\n\n\tfor (i = n; i > 0; i--) {\n\t\tbit = rbsp_read_bit(rbsp);\n\t\tif (bit < 0)\n\t\t\treturn bit;\n\t\ttmp |= bit << (i - 1);\n\t}\n\n\tif (value)\n\t\t*value = tmp;\n\n\treturn 0;\n}\n\nstatic int rbsp_write_bits(struct rbsp *rbsp, int n, unsigned int value)\n{\n\tint ret;\n\n\tif (n > 8 * sizeof(value))\n\t\treturn -EINVAL;\n\n\twhile (n--) {\n\t\tret = rbsp_write_bit(rbsp, (value >> n) & 1);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int rbsp_read_uev(struct rbsp *rbsp, unsigned int *value)\n{\n\tint leading_zero_bits = 0;\n\tunsigned int tmp = 0;\n\tint ret;\n\n\twhile ((ret = rbsp_read_bit(rbsp)) == 0)\n\t\tleading_zero_bits++;\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (leading_zero_bits > 0) {\n\t\tret = rbsp_read_bits(rbsp, leading_zero_bits, &tmp);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (value)\n\t\t*value = (1 << leading_zero_bits) - 1 + tmp;\n\n\treturn 0;\n}\n\nstatic int rbsp_write_uev(struct rbsp *rbsp, unsigned int *value)\n{\n\tint ret;\n\tint leading_zero_bits;\n\n\tif (!value)\n\t\treturn -EINVAL;\n\n\tleading_zero_bits = ilog2(*value + 1);\n\n\tret = rbsp_write_bits(rbsp, leading_zero_bits, 0);\n\tif (ret)\n\t\treturn ret;\n\n\treturn rbsp_write_bits(rbsp, leading_zero_bits + 1, *value + 1);\n}\n\nstatic int rbsp_read_sev(struct rbsp *rbsp, int *value)\n{\n\tint ret;\n\tunsigned int tmp;\n\n\tret = rbsp_read_uev(rbsp, &tmp);\n\tif (ret)\n\t\treturn ret;\n\n\tif (value) {\n\t\tif (tmp & 1)\n\t\t\t*value = (tmp + 1) / 2;\n\t\telse\n\t\t\t*value = -(tmp / 2);\n\t}\n\n\treturn 0;\n}\n\nstatic int rbsp_write_sev(struct rbsp *rbsp, int *value)\n{\n\tunsigned int tmp;\n\n\tif (!value)\n\t\treturn -EINVAL;\n\n\tif (*value > 0)\n\t\ttmp = (2 * (*value)) | 1;\n\telse\n\t\ttmp = -2 * (*value);\n\n\treturn rbsp_write_uev(rbsp, &tmp);\n}\n\nstatic int __rbsp_write_bit(struct rbsp *rbsp, int *value)\n{\n\treturn rbsp_write_bit(rbsp, *value);\n}\n\nstatic int __rbsp_write_bits(struct rbsp *rbsp, int n, unsigned int *value)\n{\n\treturn rbsp_write_bits(rbsp, n, *value);\n}\n\nstruct nal_rbsp_ops write = {\n\t.rbsp_bit = __rbsp_write_bit,\n\t.rbsp_bits = __rbsp_write_bits,\n\t.rbsp_uev = rbsp_write_uev,\n\t.rbsp_sev = rbsp_write_sev,\n};\n\nstatic int __rbsp_read_bit(struct rbsp *rbsp, int *value)\n{\n\tint tmp = rbsp_read_bit(rbsp);\n\n\tif (tmp < 0)\n\t\treturn tmp;\n\t*value = tmp;\n\n\treturn 0;\n}\n\nstruct nal_rbsp_ops read = {\n\t.rbsp_bit = __rbsp_read_bit,\n\t.rbsp_bits = rbsp_read_bits,\n\t.rbsp_uev = rbsp_read_uev,\n\t.rbsp_sev = rbsp_read_sev,\n};\n\nvoid rbsp_bit(struct rbsp *rbsp, int *value)\n{\n\tif (rbsp->error)\n\t\treturn;\n\trbsp->error = rbsp->ops->rbsp_bit(rbsp, value);\n}\n\nvoid rbsp_bits(struct rbsp *rbsp, int n, int *value)\n{\n\tif (rbsp->error)\n\t\treturn;\n\trbsp->error = rbsp->ops->rbsp_bits(rbsp, n, value);\n}\n\nvoid rbsp_uev(struct rbsp *rbsp, unsigned int *value)\n{\n\tif (rbsp->error)\n\t\treturn;\n\trbsp->error = rbsp->ops->rbsp_uev(rbsp, value);\n}\n\nvoid rbsp_sev(struct rbsp *rbsp, int *value)\n{\n\tif (rbsp->error)\n\t\treturn;\n\trbsp->error = rbsp->ops->rbsp_sev(rbsp, value);\n}\n\nvoid rbsp_trailing_bits(struct rbsp *rbsp)\n{\n\tunsigned int rbsp_stop_one_bit = 1;\n\tunsigned int rbsp_alignment_zero_bit = 0;\n\n\trbsp_bit(rbsp, &rbsp_stop_one_bit);\n\trbsp_bits(rbsp, round_up(rbsp->pos, 8) - rbsp->pos,\n\t\t  &rbsp_alignment_zero_bit);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}