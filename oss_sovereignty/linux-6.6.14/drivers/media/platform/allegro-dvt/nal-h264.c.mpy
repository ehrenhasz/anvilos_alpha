{
  "module_name": "nal-h264.c",
  "hash_id": "77d65a971f962ed01ccf447de8d57baa8fe7519e59af697d2d0411c6daddcf3d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/allegro-dvt/nal-h264.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/string.h>\n#include <linux/v4l2-controls.h>\n\n#include <linux/device.h>\n#include <linux/export.h>\n#include <linux/log2.h>\n\n#include \"nal-h264.h\"\n#include \"nal-rbsp.h\"\n\n \nenum nal_unit_type {\n\tSEQUENCE_PARAMETER_SET = 7,\n\tPICTURE_PARAMETER_SET = 8,\n\tFILLER_DATA = 12,\n};\n\nstatic void nal_h264_write_start_code_prefix(struct rbsp *rbsp)\n{\n\tu8 *p = rbsp->data + DIV_ROUND_UP(rbsp->pos, 8);\n\tint i = 4;\n\n\tif (DIV_ROUND_UP(rbsp->pos, 8) + i > rbsp->size) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\tp[0] = 0x00;\n\tp[1] = 0x00;\n\tp[2] = 0x00;\n\tp[3] = 0x01;\n\n\trbsp->pos += i * 8;\n}\n\nstatic void nal_h264_read_start_code_prefix(struct rbsp *rbsp)\n{\n\tu8 *p = rbsp->data + DIV_ROUND_UP(rbsp->pos, 8);\n\tint i = 4;\n\n\tif (DIV_ROUND_UP(rbsp->pos, 8) + i > rbsp->size) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\tif (p[0] != 0x00 || p[1] != 0x00 || p[2] != 0x00 || p[3] != 0x01) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\trbsp->pos += i * 8;\n}\n\nstatic void nal_h264_write_filler_data(struct rbsp *rbsp)\n{\n\tu8 *p = rbsp->data + DIV_ROUND_UP(rbsp->pos, 8);\n\tint i;\n\n\t \n\ti = rbsp->size - DIV_ROUND_UP(rbsp->pos, 8) - 1;\n\tmemset(p, 0xff, i);\n\trbsp->pos += i * 8;\n}\n\nstatic void nal_h264_read_filler_data(struct rbsp *rbsp)\n{\n\tu8 *p = rbsp->data + DIV_ROUND_UP(rbsp->pos, 8);\n\n\twhile (*p == 0xff) {\n\t\tif (DIV_ROUND_UP(rbsp->pos, 8) > rbsp->size) {\n\t\t\trbsp->error = -EINVAL;\n\t\t\treturn;\n\t\t}\n\n\t\tp++;\n\t\trbsp->pos += 8;\n\t}\n}\n\nstatic void nal_h264_rbsp_hrd_parameters(struct rbsp *rbsp,\n\t\t\t\t\t struct nal_h264_hrd_parameters *hrd)\n{\n\tunsigned int i;\n\n\tif (!hrd) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\trbsp_uev(rbsp, &hrd->cpb_cnt_minus1);\n\trbsp_bits(rbsp, 4, &hrd->bit_rate_scale);\n\trbsp_bits(rbsp, 4, &hrd->cpb_size_scale);\n\n\tfor (i = 0; i <= hrd->cpb_cnt_minus1; i++) {\n\t\trbsp_uev(rbsp, &hrd->bit_rate_value_minus1[i]);\n\t\trbsp_uev(rbsp, &hrd->cpb_size_value_minus1[i]);\n\t\trbsp_bit(rbsp, &hrd->cbr_flag[i]);\n\t}\n\n\trbsp_bits(rbsp, 5, &hrd->initial_cpb_removal_delay_length_minus1);\n\trbsp_bits(rbsp, 5, &hrd->cpb_removal_delay_length_minus1);\n\trbsp_bits(rbsp, 5, &hrd->dpb_output_delay_length_minus1);\n\trbsp_bits(rbsp, 5, &hrd->time_offset_length);\n}\n\nstatic void nal_h264_rbsp_vui_parameters(struct rbsp *rbsp,\n\t\t\t\t\t struct nal_h264_vui_parameters *vui)\n{\n\tif (!vui) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\trbsp_bit(rbsp, &vui->aspect_ratio_info_present_flag);\n\tif (vui->aspect_ratio_info_present_flag) {\n\t\trbsp_bits(rbsp, 8, &vui->aspect_ratio_idc);\n\t\tif (vui->aspect_ratio_idc == 255) {\n\t\t\trbsp_bits(rbsp, 16, &vui->sar_width);\n\t\t\trbsp_bits(rbsp, 16, &vui->sar_height);\n\t\t}\n\t}\n\n\trbsp_bit(rbsp, &vui->overscan_info_present_flag);\n\tif (vui->overscan_info_present_flag)\n\t\trbsp_bit(rbsp, &vui->overscan_appropriate_flag);\n\n\trbsp_bit(rbsp, &vui->video_signal_type_present_flag);\n\tif (vui->video_signal_type_present_flag) {\n\t\trbsp_bits(rbsp, 3, &vui->video_format);\n\t\trbsp_bit(rbsp, &vui->video_full_range_flag);\n\n\t\trbsp_bit(rbsp, &vui->colour_description_present_flag);\n\t\tif (vui->colour_description_present_flag) {\n\t\t\trbsp_bits(rbsp, 8, &vui->colour_primaries);\n\t\t\trbsp_bits(rbsp, 8, &vui->transfer_characteristics);\n\t\t\trbsp_bits(rbsp, 8, &vui->matrix_coefficients);\n\t\t}\n\t}\n\n\trbsp_bit(rbsp, &vui->chroma_loc_info_present_flag);\n\tif (vui->chroma_loc_info_present_flag) {\n\t\trbsp_uev(rbsp, &vui->chroma_sample_loc_type_top_field);\n\t\trbsp_uev(rbsp, &vui->chroma_sample_loc_type_bottom_field);\n\t}\n\n\trbsp_bit(rbsp, &vui->timing_info_present_flag);\n\tif (vui->timing_info_present_flag) {\n\t\trbsp_bits(rbsp, 32, &vui->num_units_in_tick);\n\t\trbsp_bits(rbsp, 32, &vui->time_scale);\n\t\trbsp_bit(rbsp, &vui->fixed_frame_rate_flag);\n\t}\n\n\trbsp_bit(rbsp, &vui->nal_hrd_parameters_present_flag);\n\tif (vui->nal_hrd_parameters_present_flag)\n\t\tnal_h264_rbsp_hrd_parameters(rbsp, &vui->nal_hrd_parameters);\n\n\trbsp_bit(rbsp, &vui->vcl_hrd_parameters_present_flag);\n\tif (vui->vcl_hrd_parameters_present_flag)\n\t\tnal_h264_rbsp_hrd_parameters(rbsp, &vui->vcl_hrd_parameters);\n\n\tif (vui->nal_hrd_parameters_present_flag ||\n\t    vui->vcl_hrd_parameters_present_flag)\n\t\trbsp_bit(rbsp, &vui->low_delay_hrd_flag);\n\n\trbsp_bit(rbsp, &vui->pic_struct_present_flag);\n\n\trbsp_bit(rbsp, &vui->bitstream_restriction_flag);\n\tif (vui->bitstream_restriction_flag) {\n\t\trbsp_bit(rbsp, &vui->motion_vectors_over_pic_boundaries_flag);\n\t\trbsp_uev(rbsp, &vui->max_bytes_per_pic_denom);\n\t\trbsp_uev(rbsp, &vui->max_bits_per_mb_denom);\n\t\trbsp_uev(rbsp, &vui->log2_max_mv_length_horizontal);\n\t\trbsp_uev(rbsp, &vui->log21_max_mv_length_vertical);\n\t\trbsp_uev(rbsp, &vui->max_num_reorder_frames);\n\t\trbsp_uev(rbsp, &vui->max_dec_frame_buffering);\n\t}\n}\n\nstatic void nal_h264_rbsp_sps(struct rbsp *rbsp, struct nal_h264_sps *sps)\n{\n\tunsigned int i;\n\n\tif (!sps) {\n\t\trbsp->error = -EINVAL;\n\t\treturn;\n\t}\n\n\trbsp_bits(rbsp, 8, &sps->profile_idc);\n\trbsp_bit(rbsp, &sps->constraint_set0_flag);\n\trbsp_bit(rbsp, &sps->constraint_set1_flag);\n\trbsp_bit(rbsp, &sps->constraint_set2_flag);\n\trbsp_bit(rbsp, &sps->constraint_set3_flag);\n\trbsp_bit(rbsp, &sps->constraint_set4_flag);\n\trbsp_bit(rbsp, &sps->constraint_set5_flag);\n\trbsp_bits(rbsp, 2, &sps->reserved_zero_2bits);\n\trbsp_bits(rbsp, 8, &sps->level_idc);\n\n\trbsp_uev(rbsp, &sps->seq_parameter_set_id);\n\n\tif (sps->profile_idc == 100 || sps->profile_idc == 110 ||\n\t    sps->profile_idc == 122 || sps->profile_idc == 244 ||\n\t    sps->profile_idc == 44 || sps->profile_idc == 83 ||\n\t    sps->profile_idc == 86 || sps->profile_idc == 118 ||\n\t    sps->profile_idc == 128 || sps->profile_idc == 138 ||\n\t    sps->profile_idc == 139 || sps->profile_idc == 134 ||\n\t    sps->profile_idc == 135) {\n\t\trbsp_uev(rbsp, &sps->chroma_format_idc);\n\n\t\tif (sps->chroma_format_idc == 3)\n\t\t\trbsp_bit(rbsp, &sps->separate_colour_plane_flag);\n\t\trbsp_uev(rbsp, &sps->bit_depth_luma_minus8);\n\t\trbsp_uev(rbsp, &sps->bit_depth_chroma_minus8);\n\t\trbsp_bit(rbsp, &sps->qpprime_y_zero_transform_bypass_flag);\n\t\trbsp_bit(rbsp, &sps->seq_scaling_matrix_present_flag);\n\t\tif (sps->seq_scaling_matrix_present_flag)\n\t\t\trbsp->error = -EINVAL;\n\t}\n\n\trbsp_uev(rbsp, &sps->log2_max_frame_num_minus4);\n\n\trbsp_uev(rbsp, &sps->pic_order_cnt_type);\n\tswitch (sps->pic_order_cnt_type) {\n\tcase 0:\n\t\trbsp_uev(rbsp, &sps->log2_max_pic_order_cnt_lsb_minus4);\n\t\tbreak;\n\tcase 1:\n\t\trbsp_bit(rbsp, &sps->delta_pic_order_always_zero_flag);\n\t\trbsp_sev(rbsp, &sps->offset_for_non_ref_pic);\n\t\trbsp_sev(rbsp, &sps->offset_for_top_to_bottom_field);\n\n\t\trbsp_uev(rbsp, &sps->num_ref_frames_in_pic_order_cnt_cycle);\n\t\tfor (i = 0; i < sps->num_ref_frames_in_pic_order_cnt_cycle; i++)\n\t\t\trbsp_sev(rbsp, &sps->offset_for_ref_frame[i]);\n\t\tbreak;\n\tdefault:\n\t\trbsp->error = -EINVAL;\n\t\tbreak;\n\t}\n\n\trbsp_uev(rbsp, &sps->max_num_ref_frames);\n\trbsp_bit(rbsp, &sps->gaps_in_frame_num_value_allowed_flag);\n\trbsp_uev(rbsp, &sps->pic_width_in_mbs_minus1);\n\trbsp_uev(rbsp, &sps->pic_height_in_map_units_minus1);\n\n\trbsp_bit(rbsp, &sps->frame_mbs_only_flag);\n\tif (!sps->frame_mbs_only_flag)\n\t\trbsp_bit(rbsp, &sps->mb_adaptive_frame_field_flag);\n\n\trbsp_bit(rbsp, &sps->direct_8x8_inference_flag);\n\n\trbsp_bit(rbsp, &sps->frame_cropping_flag);\n\tif (sps->frame_cropping_flag) {\n\t\trbsp_uev(rbsp, &sps->crop_left);\n\t\trbsp_uev(rbsp, &sps->crop_right);\n\t\trbsp_uev(rbsp, &sps->crop_top);\n\t\trbsp_uev(rbsp, &sps->crop_bottom);\n\t}\n\n\trbsp_bit(rbsp, &sps->vui_parameters_present_flag);\n\tif (sps->vui_parameters_present_flag)\n\t\tnal_h264_rbsp_vui_parameters(rbsp, &sps->vui);\n}\n\nstatic void nal_h264_rbsp_pps(struct rbsp *rbsp, struct nal_h264_pps *pps)\n{\n\tint i;\n\n\trbsp_uev(rbsp, &pps->pic_parameter_set_id);\n\trbsp_uev(rbsp, &pps->seq_parameter_set_id);\n\trbsp_bit(rbsp, &pps->entropy_coding_mode_flag);\n\trbsp_bit(rbsp, &pps->bottom_field_pic_order_in_frame_present_flag);\n\trbsp_uev(rbsp, &pps->num_slice_groups_minus1);\n\tif (pps->num_slice_groups_minus1 > 0) {\n\t\trbsp_uev(rbsp, &pps->slice_group_map_type);\n\t\tswitch (pps->slice_group_map_type) {\n\t\tcase 0:\n\t\t\tfor (i = 0; i < pps->num_slice_groups_minus1; i++)\n\t\t\t\trbsp_uev(rbsp, &pps->run_length_minus1[i]);\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tfor (i = 0; i < pps->num_slice_groups_minus1; i++) {\n\t\t\t\trbsp_uev(rbsp, &pps->top_left[i]);\n\t\t\t\trbsp_uev(rbsp, &pps->bottom_right[i]);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 3: case 4: case 5:\n\t\t\trbsp_bit(rbsp, &pps->slice_group_change_direction_flag);\n\t\t\trbsp_uev(rbsp, &pps->slice_group_change_rate_minus1);\n\t\t\tbreak;\n\t\tcase 6:\n\t\t\trbsp_uev(rbsp, &pps->pic_size_in_map_units_minus1);\n\t\t\tfor (i = 0; i < pps->pic_size_in_map_units_minus1; i++)\n\t\t\t\trbsp_bits(rbsp,\n\t\t\t\t\t  order_base_2(pps->num_slice_groups_minus1 + 1),\n\t\t\t\t\t  &pps->slice_group_id[i]);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\trbsp_uev(rbsp, &pps->num_ref_idx_l0_default_active_minus1);\n\trbsp_uev(rbsp, &pps->num_ref_idx_l1_default_active_minus1);\n\trbsp_bit(rbsp, &pps->weighted_pred_flag);\n\trbsp_bits(rbsp, 2, &pps->weighted_bipred_idc);\n\trbsp_sev(rbsp, &pps->pic_init_qp_minus26);\n\trbsp_sev(rbsp, &pps->pic_init_qs_minus26);\n\trbsp_sev(rbsp, &pps->chroma_qp_index_offset);\n\trbsp_bit(rbsp, &pps->deblocking_filter_control_present_flag);\n\trbsp_bit(rbsp, &pps->constrained_intra_pred_flag);\n\trbsp_bit(rbsp, &pps->redundant_pic_cnt_present_flag);\n\tif (  false) {\n\t\trbsp_bit(rbsp, &pps->transform_8x8_mode_flag);\n\t\trbsp_bit(rbsp, &pps->pic_scaling_matrix_present_flag);\n\t\tif (pps->pic_scaling_matrix_present_flag)\n\t\t\trbsp->error = -EINVAL;\n\t\trbsp_sev(rbsp, &pps->second_chroma_qp_index_offset);\n\t}\n}\n\n \nssize_t nal_h264_write_sps(const struct device *dev,\n\t\t\t   void *dest, size_t n, struct nal_h264_sps *sps)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit = 0;\n\tunsigned int nal_ref_idc = 0;\n\tunsigned int nal_unit_type = SEQUENCE_PARAMETER_SET;\n\n\tif (!dest)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, dest, n, &write);\n\n\tnal_h264_write_start_code_prefix(&rbsp);\n\n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 2, &nal_ref_idc);\n\trbsp_bits(&rbsp, 5, &nal_unit_type);\n\n\tnal_h264_rbsp_sps(&rbsp, sps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_h264_write_sps);\n\n \nssize_t nal_h264_read_sps(const struct device *dev,\n\t\t\t  struct nal_h264_sps *sps, void *src, size_t n)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit;\n\tunsigned int nal_ref_idc;\n\tunsigned int nal_unit_type;\n\n\tif (!src)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, src, n, &read);\n\n\tnal_h264_read_start_code_prefix(&rbsp);\n\n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 2, &nal_ref_idc);\n\trbsp_bits(&rbsp, 5, &nal_unit_type);\n\n\tif (rbsp.error ||\n\t    forbidden_zero_bit != 0 ||\n\t    nal_ref_idc != 0 ||\n\t    nal_unit_type != SEQUENCE_PARAMETER_SET)\n\t\treturn -EINVAL;\n\n\tnal_h264_rbsp_sps(&rbsp, sps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_h264_read_sps);\n\n \nssize_t nal_h264_write_pps(const struct device *dev,\n\t\t\t   void *dest, size_t n, struct nal_h264_pps *pps)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit = 0;\n\tunsigned int nal_ref_idc = 0;\n\tunsigned int nal_unit_type = PICTURE_PARAMETER_SET;\n\n\tif (!dest)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, dest, n, &write);\n\n\tnal_h264_write_start_code_prefix(&rbsp);\n\n\t \n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 2, &nal_ref_idc);\n\trbsp_bits(&rbsp, 5, &nal_unit_type);\n\n\tnal_h264_rbsp_pps(&rbsp, pps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_h264_write_pps);\n\n \nssize_t nal_h264_read_pps(const struct device *dev,\n\t\t\t  struct nal_h264_pps *pps, void *src, size_t n)\n{\n\tstruct rbsp rbsp;\n\n\tif (!src)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, src, n, &read);\n\n\tnal_h264_read_start_code_prefix(&rbsp);\n\n\t \n\trbsp.pos += 8;\n\n\tnal_h264_rbsp_pps(&rbsp, pps);\n\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_h264_read_pps);\n\n \nssize_t nal_h264_write_filler(const struct device *dev, void *dest, size_t n)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit = 0;\n\tunsigned int nal_ref_idc = 0;\n\tunsigned int nal_unit_type = FILLER_DATA;\n\n\tif (!dest)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, dest, n, &write);\n\n\tnal_h264_write_start_code_prefix(&rbsp);\n\n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 2, &nal_ref_idc);\n\trbsp_bits(&rbsp, 5, &nal_unit_type);\n\n\tnal_h264_write_filler_data(&rbsp);\n\n\trbsp_trailing_bits(&rbsp);\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_h264_write_filler);\n\n \nssize_t nal_h264_read_filler(const struct device *dev, void *src, size_t n)\n{\n\tstruct rbsp rbsp;\n\tunsigned int forbidden_zero_bit;\n\tunsigned int nal_ref_idc;\n\tunsigned int nal_unit_type;\n\n\tif (!src)\n\t\treturn -EINVAL;\n\n\trbsp_init(&rbsp, src, n, &read);\n\n\tnal_h264_read_start_code_prefix(&rbsp);\n\n\trbsp_bit(&rbsp, &forbidden_zero_bit);\n\trbsp_bits(&rbsp, 2, &nal_ref_idc);\n\trbsp_bits(&rbsp, 5, &nal_unit_type);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\tif (forbidden_zero_bit != 0 ||\n\t    nal_ref_idc != 0 ||\n\t    nal_unit_type != FILLER_DATA)\n\t\treturn -EINVAL;\n\n\tnal_h264_read_filler_data(&rbsp);\n\trbsp_trailing_bits(&rbsp);\n\n\tif (rbsp.error)\n\t\treturn rbsp.error;\n\n\treturn DIV_ROUND_UP(rbsp.pos, 8);\n}\nEXPORT_SYMBOL_GPL(nal_h264_read_filler);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}