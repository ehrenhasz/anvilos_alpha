{
  "module_name": "vsp1_pipe.c",
  "hash_id": "79c27ba7727bafcfb836eebe88437255de8962bce0a2d50ac5cf2fc3cd51d961",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/renesas/vsp1/vsp1_pipe.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/list.h>\n#include <linux/sched.h>\n#include <linux/wait.h>\n\n#include <media/media-entity.h>\n#include <media/v4l2-subdev.h>\n\n#include \"vsp1.h\"\n#include \"vsp1_brx.h\"\n#include \"vsp1_dl.h\"\n#include \"vsp1_entity.h\"\n#include \"vsp1_hgo.h\"\n#include \"vsp1_hgt.h\"\n#include \"vsp1_pipe.h\"\n#include \"vsp1_rwpf.h\"\n#include \"vsp1_uds.h\"\n\n \n\nstatic const struct vsp1_format_info vsp1_video_formats[] = {\n\t{ V4L2_PIX_FMT_RGB332, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGB_332, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 8, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_ARGB444, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ARGB_4444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_XRGB444, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_XRGB_4444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_RGBA444, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGBA_4444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_RGBX444, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGBX_4444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_ABGR444, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ABGR_4444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_XBGR444, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ABGR_4444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_BGRA444, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_BGRA_4444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_BGRX444, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_BGRA_4444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_ARGB555, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ARGB_1555, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_XRGB555, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_XRGB_1555, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_RGBA555, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGBA_5551, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_RGBX555, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGBX_5551, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_ABGR555, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ABGR_1555, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_XBGR555, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ABGR_1555, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_BGRA555, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_BGRA_5551, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_BGRX555, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_BGRA_5551, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_RGB565, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGB_565, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS,\n\t  1, { 16, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_BGR24, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_BGR_888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 24, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_RGB24, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGB_888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 24, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_ABGR32, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ARGB_8888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_XBGR32, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ARGB_8888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_BGRA32, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGBA_8888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_BGRX32, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGBA_8888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_RGBA32, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGBA_8888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_RGBX32, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGBA_8888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_ARGB32, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ARGB_8888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, true },\n\t{ V4L2_PIX_FMT_XRGB32, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_ARGB_8888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_HSV24, MEDIA_BUS_FMT_AHSV8888_1X32,\n\t  VI6_FMT_RGB_888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 24, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_HSV32, MEDIA_BUS_FMT_AHSV8888_1X32,\n\t  VI6_FMT_ARGB_8888, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_RGBX1010102, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGB10_RGB10A2_A2RGB10,\n\t  VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_RGBA1010102, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGB10_RGB10A2_A2RGB10,\n\t  VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_ARGB2101010, MEDIA_BUS_FMT_ARGB8888_1X32,\n\t  VI6_FMT_RGB10_RGB10A2_A2RGB10,\n\t  VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS,\n\t  1, { 32, 0, 0 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_UYVY, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_YUYV_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 16, 0, 0 }, false, false, 2, 1, false },\n\t{ V4L2_PIX_FMT_VYUY, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_YUYV_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 16, 0, 0 }, false, true, 2, 1, false },\n\t{ V4L2_PIX_FMT_YUYV, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_YUYV_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 16, 0, 0 }, true, false, 2, 1, false },\n\t{ V4L2_PIX_FMT_YVYU, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_YUYV_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  1, { 16, 0, 0 }, true, true, 2, 1, false },\n\t{ V4L2_PIX_FMT_NV12M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_UV_420, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  2, { 8, 16, 0 }, false, false, 2, 2, false },\n\t{ V4L2_PIX_FMT_NV21M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_UV_420, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  2, { 8, 16, 0 }, false, true, 2, 2, false },\n\t{ V4L2_PIX_FMT_NV16M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_UV_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  2, { 8, 16, 0 }, false, false, 2, 1, false },\n\t{ V4L2_PIX_FMT_NV61M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_UV_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  2, { 8, 16, 0 }, false, true, 2, 1, false },\n\t{ V4L2_PIX_FMT_YUV420M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_U_V_420, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  3, { 8, 8, 8 }, false, false, 2, 2, false },\n\t{ V4L2_PIX_FMT_YVU420M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_U_V_420, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  3, { 8, 8, 8 }, false, true, 2, 2, false },\n\t{ V4L2_PIX_FMT_YUV422M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_U_V_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  3, { 8, 8, 8 }, false, false, 2, 1, false },\n\t{ V4L2_PIX_FMT_YVU422M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_U_V_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  3, { 8, 8, 8 }, false, true, 2, 1, false },\n\t{ V4L2_PIX_FMT_YUV444M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_U_V_444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  3, { 8, 8, 8 }, false, false, 1, 1, false },\n\t{ V4L2_PIX_FMT_YVU444M, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_Y_U_V_444, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS |\n\t  VI6_RPF_DSWAP_P_WDS | VI6_RPF_DSWAP_P_BTS,\n\t  3, { 8, 8, 8 }, false, true, 1, 1, false },\n\t{ V4L2_PIX_FMT_Y210, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_YUYV_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS,\n\t  1, { 32, 0, 0 }, false, false, 2, 1, false },\n\t{ V4L2_PIX_FMT_Y212, MEDIA_BUS_FMT_AYUV8_1X32,\n\t  VI6_FMT_YUYV_422, VI6_RPF_DSWAP_P_LLS | VI6_RPF_DSWAP_P_LWS,\n\t  1, { 32, 0, 0 }, false, false, 2, 1, false },\n};\n\n \nconst struct vsp1_format_info *vsp1_get_format_info(struct vsp1_device *vsp1,\n\t\t\t\t\t\t    u32 fourcc)\n{\n\tunsigned int i;\n\n\t \n\tif (vsp1->info->gen != 2) {\n\t\tswitch (fourcc) {\n\t\tcase V4L2_PIX_FMT_VYUY:\n\t\tcase V4L2_PIX_FMT_HSV24:\n\t\tcase V4L2_PIX_FMT_HSV32:\n\t\t\treturn NULL;\n\t\t}\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(vsp1_video_formats); ++i) {\n\t\tconst struct vsp1_format_info *info = &vsp1_video_formats[i];\n\n\t\tif (info->fourcc == fourcc)\n\t\t\treturn info;\n\t}\n\n\treturn NULL;\n}\n\n \n\nvoid vsp1_pipeline_reset(struct vsp1_pipeline *pipe)\n{\n\tstruct vsp1_entity *entity;\n\tunsigned int i;\n\n\tif (pipe->brx) {\n\t\tstruct vsp1_brx *brx = to_brx(&pipe->brx->subdev);\n\n\t\tfor (i = 0; i < ARRAY_SIZE(brx->inputs); ++i)\n\t\t\tbrx->inputs[i].rpf = NULL;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(pipe->inputs); ++i)\n\t\tpipe->inputs[i] = NULL;\n\n\tpipe->output = NULL;\n\n\tlist_for_each_entry(entity, &pipe->entities, list_pipe)\n\t\tentity->pipe = NULL;\n\n\tINIT_LIST_HEAD(&pipe->entities);\n\tpipe->state = VSP1_PIPELINE_STOPPED;\n\tpipe->buffers_ready = 0;\n\tpipe->num_inputs = 0;\n\tpipe->brx = NULL;\n\tpipe->hgo = NULL;\n\tpipe->hgt = NULL;\n\tpipe->lif = NULL;\n\tpipe->uds = NULL;\n}\n\nvoid vsp1_pipeline_init(struct vsp1_pipeline *pipe)\n{\n\tmutex_init(&pipe->lock);\n\tspin_lock_init(&pipe->irqlock);\n\tinit_waitqueue_head(&pipe->wq);\n\tkref_init(&pipe->kref);\n\n\tINIT_LIST_HEAD(&pipe->entities);\n\tpipe->state = VSP1_PIPELINE_STOPPED;\n}\n\n \nvoid vsp1_pipeline_run(struct vsp1_pipeline *pipe)\n{\n\tstruct vsp1_device *vsp1 = pipe->output->entity.vsp1;\n\n\tif (pipe->state == VSP1_PIPELINE_STOPPED) {\n\t\tvsp1_write(vsp1, VI6_CMD(pipe->output->entity.index),\n\t\t\t   VI6_CMD_STRCMD);\n\t\tpipe->state = VSP1_PIPELINE_RUNNING;\n\t}\n\n\tpipe->buffers_ready = 0;\n}\n\nbool vsp1_pipeline_stopped(struct vsp1_pipeline *pipe)\n{\n\tunsigned long flags;\n\tbool stopped;\n\n\tspin_lock_irqsave(&pipe->irqlock, flags);\n\tstopped = pipe->state == VSP1_PIPELINE_STOPPED;\n\tspin_unlock_irqrestore(&pipe->irqlock, flags);\n\n\treturn stopped;\n}\n\nint vsp1_pipeline_stop(struct vsp1_pipeline *pipe)\n{\n\tstruct vsp1_device *vsp1 = pipe->output->entity.vsp1;\n\tstruct vsp1_entity *entity;\n\tunsigned long flags;\n\tint ret;\n\n\tif (pipe->lif) {\n\t\t \n\t\tret = vsp1_reset_wpf(vsp1, pipe->output->entity.index);\n\t\tif (ret == 0) {\n\t\t\tspin_lock_irqsave(&pipe->irqlock, flags);\n\t\t\tpipe->state = VSP1_PIPELINE_STOPPED;\n\t\t\tspin_unlock_irqrestore(&pipe->irqlock, flags);\n\t\t}\n\t} else {\n\t\t \n\t\tspin_lock_irqsave(&pipe->irqlock, flags);\n\t\tif (pipe->state == VSP1_PIPELINE_RUNNING)\n\t\t\tpipe->state = VSP1_PIPELINE_STOPPING;\n\t\tspin_unlock_irqrestore(&pipe->irqlock, flags);\n\n\t\tret = wait_event_timeout(pipe->wq, vsp1_pipeline_stopped(pipe),\n\t\t\t\t\t msecs_to_jiffies(500));\n\t\tret = ret == 0 ? -ETIMEDOUT : 0;\n\t}\n\n\tlist_for_each_entry(entity, &pipe->entities, list_pipe) {\n\t\tif (entity->route && entity->route->reg)\n\t\t\tvsp1_write(vsp1, entity->route->reg,\n\t\t\t\t   VI6_DPR_NODE_UNUSED);\n\t}\n\n\tif (pipe->hgo)\n\t\tvsp1_write(vsp1, VI6_DPR_HGO_SMPPT,\n\t\t\t   (7 << VI6_DPR_SMPPT_TGW_SHIFT) |\n\t\t\t   (VI6_DPR_NODE_UNUSED << VI6_DPR_SMPPT_PT_SHIFT));\n\n\tif (pipe->hgt)\n\t\tvsp1_write(vsp1, VI6_DPR_HGT_SMPPT,\n\t\t\t   (7 << VI6_DPR_SMPPT_TGW_SHIFT) |\n\t\t\t   (VI6_DPR_NODE_UNUSED << VI6_DPR_SMPPT_PT_SHIFT));\n\n\tv4l2_subdev_call(&pipe->output->entity.subdev, video, s_stream, 0);\n\n\treturn ret;\n}\n\nbool vsp1_pipeline_ready(struct vsp1_pipeline *pipe)\n{\n\tunsigned int mask;\n\n\tmask = ((1 << pipe->num_inputs) - 1) << 1;\n\tif (!pipe->lif)\n\t\tmask |= 1 << 0;\n\n\treturn pipe->buffers_ready == mask;\n}\n\nvoid vsp1_pipeline_frame_end(struct vsp1_pipeline *pipe)\n{\n\tunsigned int flags;\n\n\tif (pipe == NULL)\n\t\treturn;\n\n\t \n\tflags = vsp1_dlm_irq_frame_end(pipe->output->dlm);\n\n\tif (pipe->hgo)\n\t\tvsp1_hgo_frame_end(pipe->hgo);\n\n\tif (pipe->hgt)\n\t\tvsp1_hgt_frame_end(pipe->hgt);\n\n\t \n\tif (pipe->frame_end)\n\t\tpipe->frame_end(pipe, flags);\n\n\tpipe->sequence++;\n}\n\n \nvoid vsp1_pipeline_propagate_alpha(struct vsp1_pipeline *pipe,\n\t\t\t\t   struct vsp1_dl_body *dlb, unsigned int alpha)\n{\n\tif (!pipe->uds)\n\t\treturn;\n\n\t \n\tif (pipe->uds_input->type == VSP1_ENTITY_BRU ||\n\t    pipe->uds_input->type == VSP1_ENTITY_BRS)\n\t\talpha = 255;\n\n\tvsp1_uds_set_alpha(pipe->uds, dlb, alpha);\n}\n\n \nvoid vsp1_pipeline_propagate_partition(struct vsp1_pipeline *pipe,\n\t\t\t\t       struct vsp1_partition *partition,\n\t\t\t\t       unsigned int index,\n\t\t\t\t       struct vsp1_partition_window *window)\n{\n\tstruct vsp1_entity *entity;\n\n\tlist_for_each_entry_reverse(entity, &pipe->entities, list_pipe) {\n\t\tif (entity->ops->partition)\n\t\t\tentity->ops->partition(entity, pipe, partition, index,\n\t\t\t\t\t       window);\n\t}\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}