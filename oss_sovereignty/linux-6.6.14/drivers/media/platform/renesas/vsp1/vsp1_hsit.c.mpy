{
  "module_name": "vsp1_hsit.c",
  "hash_id": "a996da837990d23d366152e881933bc84f270a6151c1aa3ad7a4879a2874302b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/renesas/vsp1/vsp1_hsit.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/gfp.h>\n\n#include <media/v4l2-subdev.h>\n\n#include \"vsp1.h\"\n#include \"vsp1_dl.h\"\n#include \"vsp1_hsit.h\"\n\n#define HSIT_MIN_SIZE\t\t\t\t4U\n#define HSIT_MAX_SIZE\t\t\t\t8190U\n\n \n\nstatic inline void vsp1_hsit_write(struct vsp1_hsit *hsit,\n\t\t\t\t   struct vsp1_dl_body *dlb, u32 reg, u32 data)\n{\n\tvsp1_dl_body_write(dlb, reg, data);\n}\n\n \n\nstatic int hsit_enum_mbus_code(struct v4l2_subdev *subdev,\n\t\t\t       struct v4l2_subdev_state *sd_state,\n\t\t\t       struct v4l2_subdev_mbus_code_enum *code)\n{\n\tstruct vsp1_hsit *hsit = to_hsit(subdev);\n\n\tif (code->index > 0)\n\t\treturn -EINVAL;\n\n\tif ((code->pad == HSIT_PAD_SINK && !hsit->inverse) |\n\t    (code->pad == HSIT_PAD_SOURCE && hsit->inverse))\n\t\tcode->code = MEDIA_BUS_FMT_ARGB8888_1X32;\n\telse\n\t\tcode->code = MEDIA_BUS_FMT_AHSV8888_1X32;\n\n\treturn 0;\n}\n\nstatic int hsit_enum_frame_size(struct v4l2_subdev *subdev,\n\t\t\t\tstruct v4l2_subdev_state *sd_state,\n\t\t\t\tstruct v4l2_subdev_frame_size_enum *fse)\n{\n\treturn vsp1_subdev_enum_frame_size(subdev, sd_state, fse,\n\t\t\t\t\t   HSIT_MIN_SIZE,\n\t\t\t\t\t   HSIT_MIN_SIZE, HSIT_MAX_SIZE,\n\t\t\t\t\t   HSIT_MAX_SIZE);\n}\n\nstatic int hsit_set_format(struct v4l2_subdev *subdev,\n\t\t\t   struct v4l2_subdev_state *sd_state,\n\t\t\t   struct v4l2_subdev_format *fmt)\n{\n\tstruct vsp1_hsit *hsit = to_hsit(subdev);\n\tstruct v4l2_subdev_state *config;\n\tstruct v4l2_mbus_framefmt *format;\n\tint ret = 0;\n\n\tmutex_lock(&hsit->entity.lock);\n\n\tconfig = vsp1_entity_get_pad_config(&hsit->entity, sd_state,\n\t\t\t\t\t    fmt->which);\n\tif (!config) {\n\t\tret = -EINVAL;\n\t\tgoto done;\n\t}\n\n\tformat = vsp1_entity_get_pad_format(&hsit->entity, config, fmt->pad);\n\n\tif (fmt->pad == HSIT_PAD_SOURCE) {\n\t\t \n\t\tfmt->format = *format;\n\t\tgoto done;\n\t}\n\n\tformat->code = hsit->inverse ? MEDIA_BUS_FMT_AHSV8888_1X32\n\t\t     : MEDIA_BUS_FMT_ARGB8888_1X32;\n\tformat->width = clamp_t(unsigned int, fmt->format.width,\n\t\t\t\tHSIT_MIN_SIZE, HSIT_MAX_SIZE);\n\tformat->height = clamp_t(unsigned int, fmt->format.height,\n\t\t\t\t HSIT_MIN_SIZE, HSIT_MAX_SIZE);\n\tformat->field = V4L2_FIELD_NONE;\n\tformat->colorspace = V4L2_COLORSPACE_SRGB;\n\n\tfmt->format = *format;\n\n\t \n\tformat = vsp1_entity_get_pad_format(&hsit->entity, config,\n\t\t\t\t\t    HSIT_PAD_SOURCE);\n\t*format = fmt->format;\n\tformat->code = hsit->inverse ? MEDIA_BUS_FMT_ARGB8888_1X32\n\t\t     : MEDIA_BUS_FMT_AHSV8888_1X32;\n\ndone:\n\tmutex_unlock(&hsit->entity.lock);\n\treturn ret;\n}\n\nstatic const struct v4l2_subdev_pad_ops hsit_pad_ops = {\n\t.init_cfg = vsp1_entity_init_cfg,\n\t.enum_mbus_code = hsit_enum_mbus_code,\n\t.enum_frame_size = hsit_enum_frame_size,\n\t.get_fmt = vsp1_subdev_get_pad_format,\n\t.set_fmt = hsit_set_format,\n};\n\nstatic const struct v4l2_subdev_ops hsit_ops = {\n\t.pad    = &hsit_pad_ops,\n};\n\n \n\nstatic void hsit_configure_stream(struct vsp1_entity *entity,\n\t\t\t\t  struct vsp1_pipeline *pipe,\n\t\t\t\t  struct vsp1_dl_list *dl,\n\t\t\t\t  struct vsp1_dl_body *dlb)\n{\n\tstruct vsp1_hsit *hsit = to_hsit(&entity->subdev);\n\n\tif (hsit->inverse)\n\t\tvsp1_hsit_write(hsit, dlb, VI6_HSI_CTRL, VI6_HSI_CTRL_EN);\n\telse\n\t\tvsp1_hsit_write(hsit, dlb, VI6_HST_CTRL, VI6_HST_CTRL_EN);\n}\n\nstatic const struct vsp1_entity_operations hsit_entity_ops = {\n\t.configure_stream = hsit_configure_stream,\n};\n\n \n\nstruct vsp1_hsit *vsp1_hsit_create(struct vsp1_device *vsp1, bool inverse)\n{\n\tstruct vsp1_hsit *hsit;\n\tint ret;\n\n\thsit = devm_kzalloc(vsp1->dev, sizeof(*hsit), GFP_KERNEL);\n\tif (hsit == NULL)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\thsit->inverse = inverse;\n\n\thsit->entity.ops = &hsit_entity_ops;\n\n\tif (inverse)\n\t\thsit->entity.type = VSP1_ENTITY_HSI;\n\telse\n\t\thsit->entity.type = VSP1_ENTITY_HST;\n\n\tret = vsp1_entity_init(vsp1, &hsit->entity, inverse ? \"hsi\" : \"hst\",\n\t\t\t       2, &hsit_ops,\n\t\t\t       MEDIA_ENT_F_PROC_VIDEO_PIXEL_ENC_CONV);\n\tif (ret < 0)\n\t\treturn ERR_PTR(ret);\n\n\treturn hsit;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}