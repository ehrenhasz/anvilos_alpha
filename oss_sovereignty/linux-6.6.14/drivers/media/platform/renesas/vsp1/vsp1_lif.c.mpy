{
  "module_name": "vsp1_lif.c",
  "hash_id": "9eaf5b7faa3628009e8f52a780ad53d129cc44ca49581ebcdf7263eac7447284",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/renesas/vsp1/vsp1_lif.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/gfp.h>\n\n#include <media/v4l2-subdev.h>\n\n#include \"vsp1.h\"\n#include \"vsp1_dl.h\"\n#include \"vsp1_lif.h\"\n\n#define LIF_MIN_SIZE\t\t\t\t2U\n#define LIF_MAX_SIZE\t\t\t\t8190U\n\n \n\nstatic inline void vsp1_lif_write(struct vsp1_lif *lif,\n\t\t\t\t  struct vsp1_dl_body *dlb, u32 reg, u32 data)\n{\n\tvsp1_dl_body_write(dlb, reg + lif->entity.index * VI6_LIF_OFFSET,\n\t\t\t       data);\n}\n\n \n\nstatic const unsigned int lif_codes[] = {\n\tMEDIA_BUS_FMT_ARGB8888_1X32,\n\tMEDIA_BUS_FMT_AYUV8_1X32,\n};\n\nstatic int lif_enum_mbus_code(struct v4l2_subdev *subdev,\n\t\t\t      struct v4l2_subdev_state *sd_state,\n\t\t\t      struct v4l2_subdev_mbus_code_enum *code)\n{\n\treturn vsp1_subdev_enum_mbus_code(subdev, sd_state, code, lif_codes,\n\t\t\t\t\t  ARRAY_SIZE(lif_codes));\n}\n\nstatic int lif_enum_frame_size(struct v4l2_subdev *subdev,\n\t\t\t       struct v4l2_subdev_state *sd_state,\n\t\t\t       struct v4l2_subdev_frame_size_enum *fse)\n{\n\treturn vsp1_subdev_enum_frame_size(subdev, sd_state, fse,\n\t\t\t\t\t   LIF_MIN_SIZE,\n\t\t\t\t\t   LIF_MIN_SIZE, LIF_MAX_SIZE,\n\t\t\t\t\t   LIF_MAX_SIZE);\n}\n\nstatic int lif_set_format(struct v4l2_subdev *subdev,\n\t\t\t  struct v4l2_subdev_state *sd_state,\n\t\t\t  struct v4l2_subdev_format *fmt)\n{\n\treturn vsp1_subdev_set_pad_format(subdev, sd_state, fmt, lif_codes,\n\t\t\t\t\t  ARRAY_SIZE(lif_codes),\n\t\t\t\t\t  LIF_MIN_SIZE, LIF_MIN_SIZE,\n\t\t\t\t\t  LIF_MAX_SIZE, LIF_MAX_SIZE);\n}\n\nstatic const struct v4l2_subdev_pad_ops lif_pad_ops = {\n\t.init_cfg = vsp1_entity_init_cfg,\n\t.enum_mbus_code = lif_enum_mbus_code,\n\t.enum_frame_size = lif_enum_frame_size,\n\t.get_fmt = vsp1_subdev_get_pad_format,\n\t.set_fmt = lif_set_format,\n};\n\nstatic const struct v4l2_subdev_ops lif_ops = {\n\t.pad    = &lif_pad_ops,\n};\n\n \n\nstatic void lif_configure_stream(struct vsp1_entity *entity,\n\t\t\t\t struct vsp1_pipeline *pipe,\n\t\t\t\t struct vsp1_dl_list *dl,\n\t\t\t\t struct vsp1_dl_body *dlb)\n{\n\tconst struct v4l2_mbus_framefmt *format;\n\tstruct vsp1_lif *lif = to_lif(&entity->subdev);\n\tunsigned int hbth;\n\tunsigned int obth;\n\tunsigned int lbth;\n\n\tformat = vsp1_entity_get_pad_format(&lif->entity, lif->entity.config,\n\t\t\t\t\t    LIF_PAD_SOURCE);\n\n\tswitch (entity->vsp1->version & VI6_IP_VERSION_MODEL_MASK) {\n\tcase VI6_IP_VERSION_MODEL_VSPD_GEN2:\n\tcase VI6_IP_VERSION_MODEL_VSPD_V2H:\n\t\thbth = 1536;\n\t\tobth = min(128U, (format->width + 1) / 2 * format->height - 4);\n\t\tlbth = 1520;\n\t\tbreak;\n\n\tcase VI6_IP_VERSION_MODEL_VSPDL_GEN3:\n\tcase VI6_IP_VERSION_MODEL_VSPD_V3:\n\tcase VI6_IP_VERSION_MODEL_VSPD_RZG2L:\n\t\thbth = 0;\n\t\tobth = 1500;\n\t\tlbth = 0;\n\t\tbreak;\n\n\tcase VI6_IP_VERSION_MODEL_VSPD_GEN3:\n\tcase VI6_IP_VERSION_MODEL_VSPD_GEN4:\n\tdefault:\n\t\thbth = 0;\n\t\tobth = 3000;\n\t\tlbth = 0;\n\t\tbreak;\n\t}\n\n\tvsp1_lif_write(lif, dlb, VI6_LIF_CSBTH,\n\t\t\t(hbth << VI6_LIF_CSBTH_HBTH_SHIFT) |\n\t\t\t(lbth << VI6_LIF_CSBTH_LBTH_SHIFT));\n\n\tvsp1_lif_write(lif, dlb, VI6_LIF_CTRL,\n\t\t\t(obth << VI6_LIF_CTRL_OBTH_SHIFT) |\n\t\t\t(format->code == 0 ? VI6_LIF_CTRL_CFMT : 0) |\n\t\t\tVI6_LIF_CTRL_REQSEL | VI6_LIF_CTRL_LIF_EN);\n\n\t \n\tif (vsp1_feature(entity->vsp1, VSP1_HAS_NON_ZERO_LBA))\n\t\tvsp1_lif_write(lif, dlb, VI6_LIF_LBA,\n\t\t\t       VI6_LIF_LBA_LBA0 |\n\t\t\t       (1536 << VI6_LIF_LBA_LBA1_SHIFT));\n}\n\nstatic const struct vsp1_entity_operations lif_entity_ops = {\n\t.configure_stream = lif_configure_stream,\n};\n\n \n\nstruct vsp1_lif *vsp1_lif_create(struct vsp1_device *vsp1, unsigned int index)\n{\n\tstruct vsp1_lif *lif;\n\tint ret;\n\n\tlif = devm_kzalloc(vsp1->dev, sizeof(*lif), GFP_KERNEL);\n\tif (lif == NULL)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tlif->entity.ops = &lif_entity_ops;\n\tlif->entity.type = VSP1_ENTITY_LIF;\n\tlif->entity.index = index;\n\n\t \n\tret = vsp1_entity_init(vsp1, &lif->entity, \"lif\", 2, &lif_ops,\n\t\t\t       MEDIA_ENT_F_PROC_VIDEO_PIXEL_FORMATTER);\n\tif (ret < 0)\n\t\treturn ERR_PTR(ret);\n\n\treturn lif;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}