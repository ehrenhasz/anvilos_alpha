{
  "module_name": "s5p_mfc_common.h",
  "hash_id": "6c7c2b0c8e14c6af2c3296fb9f1c9f72b02932de603e0b05832608fe29457c0f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/samsung/s5p-mfc/s5p_mfc_common.h",
  "human_readable_source": " \n \n\n#ifndef S5P_MFC_COMMON_H_\n#define S5P_MFC_COMMON_H_\n\n#include <linux/platform_device.h>\n#include <linux/videodev2.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ioctl.h>\n#include <media/videobuf2-v4l2.h>\n#include \"regs-mfc.h\"\n#include \"regs-mfc-v10.h\"\n\n#define S5P_MFC_NAME\t\t\"s5p-mfc\"\n\n \n\n \n#define DST_QUEUE_OFF_BASE\t(1 << 30)\n\n#define BANK_L_CTX\t0\n#define BANK_R_CTX\t1\n#define BANK_CTX_NUM\t2\n\n#define MFC_BANK1_ALIGN_ORDER\t13\n#define MFC_BANK2_ALIGN_ORDER\t13\n#define MFC_BASE_ALIGN_ORDER\t17\n\n#define MFC_FW_MAX_VERSIONS\t2\n\n#include <media/videobuf2-dma-contig.h>\n\n \n#define MFC_MAX_EXTRA_DPB       5\n#define MFC_MAX_BUFFERS\t\t32\n#define MFC_NUM_CONTEXTS\t4\n \n#define MFC_INT_TIMEOUT\t\t2000\n \n#define MFC_BW_TIMEOUT\t\t500\n \n#define MFC_WATCHDOG_INTERVAL   1000\n \n#define MFC_WATCHDOG_CNT        10\n#define MFC_NO_INSTANCE_SET\t-1\n#define MFC_ENC_CAP_PLANE_COUNT\t1\n#define MFC_ENC_OUT_PLANE_COUNT\t2\n#define STUFF_BYTE\t\t4\n#define MFC_MAX_CTRLS\t\t128\n\n#define S5P_MFC_CODEC_NONE\t\t-1\n#define S5P_MFC_CODEC_H264_DEC\t\t0\n#define S5P_MFC_CODEC_H264_MVC_DEC\t1\n#define S5P_MFC_CODEC_VC1_DEC\t\t2\n#define S5P_MFC_CODEC_MPEG4_DEC\t\t3\n#define S5P_MFC_CODEC_MPEG2_DEC\t\t4\n#define S5P_MFC_CODEC_H263_DEC\t\t5\n#define S5P_MFC_CODEC_VC1RCV_DEC\t6\n#define S5P_MFC_CODEC_VP8_DEC\t\t7\n#define S5P_MFC_CODEC_HEVC_DEC\t\t17\n#define S5P_MFC_CODEC_VP9_DEC\t\t18\n\n#define S5P_MFC_CODEC_H264_ENC\t\t20\n#define S5P_MFC_CODEC_H264_MVC_ENC\t21\n#define S5P_MFC_CODEC_MPEG4_ENC\t\t22\n#define S5P_MFC_CODEC_H263_ENC\t\t23\n#define S5P_MFC_CODEC_VP8_ENC\t\t24\n#define S5P_MFC_CODEC_HEVC_ENC\t\t26\n\n#define S5P_MFC_R2H_CMD_EMPTY\t\t\t0\n#define S5P_MFC_R2H_CMD_SYS_INIT_RET\t\t1\n#define S5P_MFC_R2H_CMD_OPEN_INSTANCE_RET\t2\n#define S5P_MFC_R2H_CMD_SEQ_DONE_RET\t\t3\n#define S5P_MFC_R2H_CMD_INIT_BUFFERS_RET\t4\n#define S5P_MFC_R2H_CMD_CLOSE_INSTANCE_RET\t6\n#define S5P_MFC_R2H_CMD_SLEEP_RET\t\t7\n#define S5P_MFC_R2H_CMD_WAKEUP_RET\t\t8\n#define S5P_MFC_R2H_CMD_COMPLETE_SEQ_RET\t9\n#define S5P_MFC_R2H_CMD_DPB_FLUSH_RET\t\t10\n#define S5P_MFC_R2H_CMD_NAL_ABORT_RET\t\t11\n#define S5P_MFC_R2H_CMD_FW_STATUS_RET\t\t12\n#define S5P_MFC_R2H_CMD_FRAME_DONE_RET\t\t13\n#define S5P_MFC_R2H_CMD_FIELD_DONE_RET\t\t14\n#define S5P_MFC_R2H_CMD_SLICE_DONE_RET\t\t15\n#define S5P_MFC_R2H_CMD_ENC_BUFFER_FUL_RET\t16\n#define S5P_MFC_R2H_CMD_ERR_RET\t\t\t32\n\n#define MFC_MAX_CLOCKS\t\t4\n\n#define mfc_read(dev, offset)\t\treadl(dev->regs_base + (offset))\n#define mfc_write(dev, data, offset)\twritel((data), dev->regs_base + \\\n\t\t\t\t\t\t\t\t(offset))\n\n \nenum s5p_mfc_fmt_type {\n\tMFC_FMT_DEC,\n\tMFC_FMT_ENC,\n\tMFC_FMT_RAW,\n};\n\n \nenum s5p_mfc_inst_type {\n\tMFCINST_INVALID,\n\tMFCINST_DECODER,\n\tMFCINST_ENCODER,\n};\n\n \nenum s5p_mfc_inst_state {\n\tMFCINST_FREE = 0,\n\tMFCINST_INIT = 100,\n\tMFCINST_GOT_INST,\n\tMFCINST_HEAD_PARSED,\n\tMFCINST_HEAD_PRODUCED,\n\tMFCINST_BUFS_SET,\n\tMFCINST_RUNNING,\n\tMFCINST_FINISHING,\n\tMFCINST_FINISHED,\n\tMFCINST_RETURN_INST,\n\tMFCINST_ERROR,\n\tMFCINST_ABORT,\n\tMFCINST_FLUSH,\n\tMFCINST_RES_CHANGE_INIT,\n\tMFCINST_RES_CHANGE_FLUSH,\n\tMFCINST_RES_CHANGE_END,\n};\n\n \nenum s5p_mfc_queue_state {\n\tQUEUE_FREE,\n\tQUEUE_BUFS_REQUESTED,\n\tQUEUE_BUFS_QUERIED,\n\tQUEUE_BUFS_MMAPED,\n};\n\n \nenum s5p_mfc_decode_arg {\n\tMFC_DEC_FRAME,\n\tMFC_DEC_LAST_FRAME,\n\tMFC_DEC_RES_CHANGE,\n};\n\nenum s5p_mfc_fw_ver {\n\tMFC_FW_V1,\n\tMFC_FW_V2,\n};\n\n#define MFC_BUF_FLAG_USED\t(1 << 0)\n#define MFC_BUF_FLAG_EOS\t(1 << 1)\n\nstruct s5p_mfc_ctx;\n\n \nstruct s5p_mfc_buf {\n\tstruct vb2_v4l2_buffer *b;\n\tstruct list_head list;\n\tunion {\n\t\tstruct {\n\t\t\tsize_t luma;\n\t\t\tsize_t chroma;\n\t\t} raw;\n\t\tsize_t stream;\n\t} cookie;\n\tint flags;\n};\n\n \nstruct s5p_mfc_pm {\n\tstruct clk\t*clock_gate;\n\tconst char * const *clk_names;\n\tstruct clk\t*clocks[MFC_MAX_CLOCKS];\n\tint\t\tnum_clocks;\n\tbool\t\tuse_clock_gating;\n\n\tstruct device\t*device;\n};\n\nstruct s5p_mfc_buf_size_v5 {\n\tunsigned int h264_ctx;\n\tunsigned int non_h264_ctx;\n\tunsigned int dsc;\n\tunsigned int shm;\n};\n\nstruct s5p_mfc_buf_size_v6 {\n\tunsigned int dev_ctx;\n\tunsigned int h264_dec_ctx;\n\tunsigned int other_dec_ctx;\n\tunsigned int h264_enc_ctx;\n\tunsigned int hevc_enc_ctx;\n\tunsigned int other_enc_ctx;\n};\n\nstruct s5p_mfc_buf_size {\n\tunsigned int fw;\n\tunsigned int cpb;\n\tvoid *priv;\n};\n\nstruct s5p_mfc_variant {\n\tunsigned int version;\n\tunsigned int port_num;\n\tu32 version_bit;\n\tstruct s5p_mfc_buf_size *buf_size;\n\tchar\t*fw_name[MFC_FW_MAX_VERSIONS];\n\tconst char\t*clk_names[MFC_MAX_CLOCKS];\n\tint\t\tnum_clocks;\n\tbool\t\tuse_clock_gating;\n};\n\n \nstruct s5p_mfc_priv_buf {\n\tunsigned long\tofs;\n\tvoid\t\t*virt;\n\tdma_addr_t\tdma;\n\tsize_t\t\tsize;\n\tunsigned int\tctx;\n};\n\n \nstruct s5p_mfc_dev {\n\tstruct v4l2_device\tv4l2_dev;\n\tstruct video_device\t*vfd_dec;\n\tstruct video_device\t*vfd_enc;\n\tstruct platform_device\t*plat_dev;\n\tstruct device\t\t*mem_dev[BANK_CTX_NUM];\n\tvoid __iomem\t\t*regs_base;\n\tint\t\t\tirq;\n\tstruct v4l2_ctrl_handler dec_ctrl_handler;\n\tstruct v4l2_ctrl_handler enc_ctrl_handler;\n\tstruct s5p_mfc_pm\tpm;\n\tconst struct s5p_mfc_variant\t*variant;\n\tint num_inst;\n\tspinlock_t irqlock;\t \n\tspinlock_t condlock;\t \n\tstruct mutex mfc_mutex;  \n\tint int_cond;\n\tint int_type;\n\tunsigned int int_err;\n\twait_queue_head_t queue;\n\tstruct s5p_mfc_priv_buf fw_buf;\n\tsize_t mem_size;\n\tdma_addr_t mem_base;\n\tunsigned long *mem_bitmap;\n\tvoid *mem_virt;\n\tdma_addr_t dma_base[BANK_CTX_NUM];\n\tunsigned long hw_lock;\n\tstruct s5p_mfc_ctx *ctx[MFC_NUM_CONTEXTS];\n\tint curr_ctx;\n\tunsigned long ctx_work_bits;\n\tatomic_t watchdog_cnt;\n\tstruct timer_list watchdog_timer;\n\tstruct workqueue_struct *watchdog_workqueue;\n\tstruct work_struct watchdog_work;\n\tunsigned long enter_suspend;\n\n\tstruct s5p_mfc_priv_buf ctx_buf;\n\tint warn_start;\n\tstruct s5p_mfc_hw_ops *mfc_ops;\n\tstruct s5p_mfc_hw_cmds *mfc_cmds;\n\tconst struct s5p_mfc_regs *mfc_regs;\n\tenum s5p_mfc_fw_ver fw_ver;\n\tbool fw_get_done;\n\tbool risc_on;  \n};\n\n \nstruct s5p_mfc_h264_enc_params {\n\tenum v4l2_mpeg_video_h264_profile profile;\n\tenum v4l2_mpeg_video_h264_loop_filter_mode loop_filter_mode;\n\ts8 loop_filter_alpha;\n\ts8 loop_filter_beta;\n\tenum v4l2_mpeg_video_h264_entropy_mode entropy_mode;\n\tu8 max_ref_pic;\n\tu8 num_ref_pic_4p;\n\tint _8x8_transform;\n\tint rc_mb_dark;\n\tint rc_mb_smooth;\n\tint rc_mb_static;\n\tint rc_mb_activity;\n\tint vui_sar;\n\tu8 vui_sar_idc;\n\tu16 vui_ext_sar_width;\n\tu16 vui_ext_sar_height;\n\tint open_gop;\n\tu16 open_gop_size;\n\tu8 rc_frame_qp;\n\tu8 rc_min_qp;\n\tu8 rc_max_qp;\n\tu8 rc_p_frame_qp;\n\tu8 rc_b_frame_qp;\n\tenum v4l2_mpeg_video_h264_level level_v4l2;\n\tint level;\n\tu16 cpb_size;\n\tint interlace;\n\tu8 hier_qp;\n\tu8 hier_qp_type;\n\tu8 hier_qp_layer;\n\tu8 hier_qp_layer_qp[7];\n\tu8 sei_frame_packing;\n\tu8 sei_fp_curr_frame_0;\n\tu8 sei_fp_arrangement_type;\n\n\tu8 fmo;\n\tu8 fmo_map_type;\n\tu8 fmo_slice_grp;\n\tu8 fmo_chg_dir;\n\tu32 fmo_chg_rate;\n\tu32 fmo_run_len[4];\n\tu8 aso;\n\tu32 aso_slice_order[8];\n};\n\n \nstruct s5p_mfc_mpeg4_enc_params {\n\t \n\tenum v4l2_mpeg_video_mpeg4_profile profile;\n\tint quarter_pixel;\n\t \n\tu16 vop_time_res;\n\tu16 vop_frm_delta;\n\tu8 rc_frame_qp;\n\tu8 rc_min_qp;\n\tu8 rc_max_qp;\n\tu8 rc_p_frame_qp;\n\tu8 rc_b_frame_qp;\n\tenum v4l2_mpeg_video_mpeg4_level level_v4l2;\n\tint level;\n};\n\n \nstruct s5p_mfc_vp8_enc_params {\n\tu8 imd_4x4;\n\tenum v4l2_vp8_num_partitions num_partitions;\n\tenum v4l2_vp8_num_ref_frames num_ref;\n\tu8 filter_level;\n\tu8 filter_sharpness;\n\tu32 golden_frame_ref_period;\n\tenum v4l2_vp8_golden_frame_sel golden_frame_sel;\n\tu8 hier_layer;\n\tu8 hier_layer_qp[3];\n\tu8 rc_min_qp;\n\tu8 rc_max_qp;\n\tu8 rc_frame_qp;\n\tu8 rc_p_frame_qp;\n\tu8 profile;\n};\n\nstruct s5p_mfc_hevc_enc_params {\n\tenum v4l2_mpeg_video_hevc_profile profile;\n\tint level;\n\tenum v4l2_mpeg_video_h264_level level_v4l2;\n\tu8 tier;\n\tu32 rc_framerate;\n\tu8 rc_min_qp;\n\tu8 rc_max_qp;\n\tu8 rc_lcu_dark;\n\tu8 rc_lcu_smooth;\n\tu8 rc_lcu_static;\n\tu8 rc_lcu_activity;\n\tu8 rc_frame_qp;\n\tu8 rc_p_frame_qp;\n\tu8 rc_b_frame_qp;\n\tu8 max_partition_depth;\n\tu8 num_refs_for_p;\n\tu8 refreshtype;\n\tu16 refreshperiod;\n\ts32 lf_beta_offset_div2;\n\ts32 lf_tc_offset_div2;\n\tu8 loopfilter;\n\tu8 loopfilter_disable;\n\tu8 loopfilter_across;\n\tu8 nal_control_length_filed;\n\tu8 nal_control_user_ref;\n\tu8 nal_control_store_ref;\n\tu8 const_intra_period_enable;\n\tu8 lossless_cu_enable;\n\tu8 wavefront_enable;\n\tu8 enable_ltr;\n\tu8 hier_qp_enable;\n\tenum v4l2_mpeg_video_hevc_hier_coding_type hier_qp_type;\n\tu8 num_hier_layer;\n\tu8 hier_qp_layer[7];\n\tu32 hier_bit_layer[7];\n\tu8 sign_data_hiding;\n\tu8 general_pb_enable;\n\tu8 temporal_id_enable;\n\tu8 strong_intra_smooth;\n\tu8 intra_pu_split_disable;\n\tu8 tmv_prediction_disable;\n\tu8 max_num_merge_mv;\n\tu8 eco_mode_enable;\n\tu8 encoding_nostartcode_enable;\n\tu8 size_of_length_field;\n\tu8 prepend_sps_pps_to_idr;\n};\n\n \nstruct s5p_mfc_enc_params {\n\tu16 width;\n\tu16 height;\n\tu32 mv_h_range;\n\tu32 mv_v_range;\n\n\tu16 gop_size;\n\tenum v4l2_mpeg_video_multi_slice_mode slice_mode;\n\tu16 slice_mb;\n\tu32 slice_bit;\n\tu16 intra_refresh_mb;\n\tint pad;\n\tu8 pad_luma;\n\tu8 pad_cb;\n\tu8 pad_cr;\n\tint rc_frame;\n\tint rc_mb;\n\tu32 rc_bitrate;\n\tu16 rc_reaction_coeff;\n\tu16 vbv_size;\n\tu32 vbv_delay;\n\n\tenum v4l2_mpeg_video_header_mode seq_hdr_mode;\n\tenum v4l2_mpeg_mfc51_video_frame_skip_mode frame_skip_mode;\n\tint fixed_target_bit;\n\n\tu8 num_b_frame;\n\tu32 rc_framerate_num;\n\tu32 rc_framerate_denom;\n\n\tstruct {\n\t\tstruct s5p_mfc_h264_enc_params h264;\n\t\tstruct s5p_mfc_mpeg4_enc_params mpeg4;\n\t\tstruct s5p_mfc_vp8_enc_params vp8;\n\t\tstruct s5p_mfc_hevc_enc_params hevc;\n\t} codec;\n\n};\n\n \nstruct s5p_mfc_codec_ops {\n\t \n\tint (*pre_seq_start) (struct s5p_mfc_ctx *ctx);\n\tint (*post_seq_start) (struct s5p_mfc_ctx *ctx);\n\t \n\tint (*pre_frame_start) (struct s5p_mfc_ctx *ctx);\n\tint (*post_frame_start) (struct s5p_mfc_ctx *ctx);\n};\n\n#define call_cop(c, op, args...)\t\t\t\t\\\n\t(((c)->c_ops->op) ?\t\t\t\t\t\\\n\t\t((c)->c_ops->op(args)) : 0)\n\n \nstruct s5p_mfc_ctx {\n\tstruct s5p_mfc_dev *dev;\n\tstruct v4l2_fh fh;\n\n\tint num;\n\n\tint int_cond;\n\tint int_type;\n\tunsigned int int_err;\n\twait_queue_head_t queue;\n\n\tstruct s5p_mfc_fmt *src_fmt;\n\tstruct s5p_mfc_fmt *dst_fmt;\n\n\tstruct vb2_queue vq_src;\n\tstruct vb2_queue vq_dst;\n\n\tstruct list_head src_queue;\n\tstruct list_head dst_queue;\n\n\tunsigned int src_queue_cnt;\n\tunsigned int dst_queue_cnt;\n\n\tenum s5p_mfc_inst_type type;\n\tenum s5p_mfc_inst_state state;\n\tint inst_no;\n\n\t \n\tint img_width;\n\tint img_height;\n\tint buf_width;\n\tint buf_height;\n\n\tint luma_size;\n\tint chroma_size;\n\tint mv_size;\n\n\tunsigned long consumed_stream;\n\n\tunsigned int dpb_flush_flag;\n\tunsigned int head_processed;\n\n\tstruct s5p_mfc_priv_buf bank1;\n\tstruct s5p_mfc_priv_buf bank2;\n\n\tenum s5p_mfc_queue_state capture_state;\n\tenum s5p_mfc_queue_state output_state;\n\n\tstruct s5p_mfc_buf src_bufs[MFC_MAX_BUFFERS];\n\tint src_bufs_cnt;\n\tstruct s5p_mfc_buf dst_bufs[MFC_MAX_BUFFERS];\n\tint dst_bufs_cnt;\n\n\tunsigned int sequence;\n\tunsigned long dec_dst_flag;\n\tsize_t dec_src_buf_size;\n\n\t \n\tint codec_mode;\n\tint slice_interface;\n\tint loop_filter_mpeg4;\n\tint display_delay;\n\tint display_delay_enable;\n\tint after_packed_pb;\n\tint sei_fp_parse;\n\n\tint pb_count;\n\tint total_dpb_count;\n\tint mv_count;\n\t \n\tstruct s5p_mfc_priv_buf ctx;\n\tstruct s5p_mfc_priv_buf dsc;\n\tstruct s5p_mfc_priv_buf shm;\n\n\tstruct s5p_mfc_enc_params enc_params;\n\n\tsize_t enc_dst_buf_size;\n\tsize_t luma_dpb_size;\n\tsize_t chroma_dpb_size;\n\tsize_t me_buffer_size;\n\tsize_t tmv_buffer_size;\n\n\tenum v4l2_mpeg_mfc51_video_force_frame_type force_frame_type;\n\n\tstruct list_head ref_queue;\n\tunsigned int ref_queue_cnt;\n\n\tenum v4l2_mpeg_video_multi_slice_mode slice_mode;\n\tunion {\n\t\tunsigned int mb;\n\t\tunsigned int bits;\n\t} slice_size;\n\n\tconst struct s5p_mfc_codec_ops *c_ops;\n\n\tstruct v4l2_ctrl *ctrls[MFC_MAX_CTRLS];\n\tstruct v4l2_ctrl_handler ctrl_handler;\n\tsize_t scratch_buf_size;\n};\n\n \nstruct s5p_mfc_fmt {\n\tu32 fourcc;\n\tu32 codec_mode;\n\tenum s5p_mfc_fmt_type type;\n\tu32 num_planes;\n\tu32 versions;\n\tu32 flags;\n};\n\n \nstruct mfc_control {\n\t__u32\t\t\tid;\n\tenum v4l2_ctrl_type\ttype;\n\t__u8\t\t\tname[32];   \n\t__s32\t\t\tminimum;    \n\t__s32\t\t\tmaximum;\n\t__s32\t\t\tstep;\n\t__u32\t\t\tmenu_skip_mask;\n\t__s32\t\t\tdefault_value;\n\t__u32\t\t\tflags;\n\t__u32\t\t\treserved[2];\n\t__u8\t\t\tis_volatile;\n};\n\n \n#define s5p_mfc_hw_call(f, op, args...) \\\n\t((f && f->op) ? f->op(args) : (typeof(f->op(args)))(-ENODEV))\n\n#define fh_to_ctx(__fh) container_of(__fh, struct s5p_mfc_ctx, fh)\n#define ctrl_to_ctx(__ctrl) \\\n\tcontainer_of((__ctrl)->handler, struct s5p_mfc_ctx, ctrl_handler)\n\nvoid clear_work_bit(struct s5p_mfc_ctx *ctx);\nvoid set_work_bit(struct s5p_mfc_ctx *ctx);\nvoid clear_work_bit_irqsave(struct s5p_mfc_ctx *ctx);\nvoid set_work_bit_irqsave(struct s5p_mfc_ctx *ctx);\nint s5p_mfc_get_new_ctx(struct s5p_mfc_dev *dev);\nvoid s5p_mfc_cleanup_queue(struct list_head *lh, struct vb2_queue *vq);\n\n#define HAS_PORTNUM(dev)\t(dev ? (dev->variant ? \\\n\t\t\t\t(dev->variant->port_num ? 1 : 0) : 0) : 0)\n#define IS_TWOPORT(dev)\t\t(dev->variant->port_num == 2 ? 1 : 0)\n#define IS_MFCV6_PLUS(dev)\t(dev->variant->version >= 0x60 ? 1 : 0)\n#define IS_MFCV7_PLUS(dev)\t(dev->variant->version >= 0x70 ? 1 : 0)\n#define IS_MFCV8_PLUS(dev)\t(dev->variant->version >= 0x80 ? 1 : 0)\n#define IS_MFCV10(dev)\t\t(dev->variant->version >= 0xA0 ? 1 : 0)\n#define FW_HAS_E_MIN_SCRATCH_BUF(dev) (IS_MFCV10(dev))\n\n#define MFC_V5_BIT\tBIT(0)\n#define MFC_V6_BIT\tBIT(1)\n#define MFC_V7_BIT\tBIT(2)\n#define MFC_V8_BIT\tBIT(3)\n#define MFC_V10_BIT\tBIT(5)\n\n#define MFC_V5PLUS_BITS\t\t(MFC_V5_BIT | MFC_V6_BIT | MFC_V7_BIT | \\\n\t\t\t\t\tMFC_V8_BIT | MFC_V10_BIT)\n#define MFC_V6PLUS_BITS\t\t(MFC_V6_BIT | MFC_V7_BIT | MFC_V8_BIT | \\\n\t\t\t\t\tMFC_V10_BIT)\n#define MFC_V7PLUS_BITS\t\t(MFC_V7_BIT | MFC_V8_BIT | MFC_V10_BIT)\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}