{
  "module_name": "s5p_mfc_pm.c",
  "hash_id": "fd392161534aebad775f8ff2d0057092aec6d970ed3b512ea681fa11e45591e0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/samsung/s5p-mfc/s5p_mfc_pm.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include \"s5p_mfc_common.h\"\n#include \"s5p_mfc_debug.h\"\n#include \"s5p_mfc_pm.h\"\n\nstatic struct s5p_mfc_pm *pm;\nstatic struct s5p_mfc_dev *p_dev;\nstatic atomic_t clk_ref;\n\nint s5p_mfc_init_pm(struct s5p_mfc_dev *dev)\n{\n\tint i;\n\n\tpm = &dev->pm;\n\tp_dev = dev;\n\n\tpm->num_clocks = dev->variant->num_clocks;\n\tpm->clk_names = dev->variant->clk_names;\n\tpm->device = &dev->plat_dev->dev;\n\tpm->clock_gate = NULL;\n\n\t \n\tfor (i = 0; i < pm->num_clocks; i++) {\n\t\tpm->clocks[i] = devm_clk_get(pm->device, pm->clk_names[i]);\n\t\tif (IS_ERR(pm->clocks[i])) {\n\t\t\t \n\t\t\tif (i && PTR_ERR(pm->clocks[i]) == -ENOENT) {\n\t\t\t\tpm->clocks[i] = NULL;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tmfc_err(\"Failed to get clock: %s\\n\",\n\t\t\t\tpm->clk_names[i]);\n\t\t\treturn PTR_ERR(pm->clocks[i]);\n\t\t}\n\t}\n\n\tif (dev->variant->use_clock_gating)\n\t\tpm->clock_gate = pm->clocks[0];\n\n\tpm_runtime_enable(pm->device);\n\tatomic_set(&clk_ref, 0);\n\treturn 0;\n}\n\nvoid s5p_mfc_final_pm(struct s5p_mfc_dev *dev)\n{\n\tpm_runtime_disable(pm->device);\n}\n\nint s5p_mfc_clock_on(void)\n{\n\tatomic_inc(&clk_ref);\n\tmfc_debug(3, \"+ %d\\n\", atomic_read(&clk_ref));\n\n\treturn clk_enable(pm->clock_gate);\n}\n\nvoid s5p_mfc_clock_off(void)\n{\n\tatomic_dec(&clk_ref);\n\tmfc_debug(3, \"- %d\\n\", atomic_read(&clk_ref));\n\n\tclk_disable(pm->clock_gate);\n}\n\nint s5p_mfc_power_on(void)\n{\n\tint i, ret = 0;\n\n\tret = pm_runtime_resume_and_get(pm->device);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tfor (i = 0; i < pm->num_clocks; i++) {\n\t\tret = clk_prepare_enable(pm->clocks[i]);\n\t\tif (ret < 0) {\n\t\t\tmfc_err(\"clock prepare failed for clock: %s\\n\",\n\t\t\t\tpm->clk_names[i]);\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\t \n\tclk_disable(pm->clock_gate);\n\n\treturn 0;\nerr:\n\twhile (--i >= 0)\n\t\tclk_disable_unprepare(pm->clocks[i]);\n\tpm_runtime_put(pm->device);\n\treturn ret;\n}\n\nint s5p_mfc_power_off(void)\n{\n\tint i;\n\n\t \n\tclk_enable(pm->clock_gate);\n\n\tfor (i = 0; i < pm->num_clocks; i++)\n\t\tclk_disable_unprepare(pm->clocks[i]);\n\n\treturn pm_runtime_put_sync(pm->device);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}