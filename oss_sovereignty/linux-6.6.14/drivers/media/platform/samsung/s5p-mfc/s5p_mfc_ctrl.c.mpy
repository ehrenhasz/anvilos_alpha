{
  "module_name": "s5p_mfc_ctrl.c",
  "hash_id": "b28dce9ef76344d877782c3b03bd6633c9b0894a951202eab1913a6f43128e06",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/platform/samsung/s5p-mfc/s5p_mfc_ctrl.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/firmware.h>\n#include <linux/jiffies.h>\n#include <linux/sched.h>\n#include \"s5p_mfc_cmd.h\"\n#include \"s5p_mfc_common.h\"\n#include \"s5p_mfc_debug.h\"\n#include \"s5p_mfc_intr.h\"\n#include \"s5p_mfc_opr.h\"\n#include \"s5p_mfc_pm.h\"\n#include \"s5p_mfc_ctrl.h\"\n\n \nint s5p_mfc_alloc_firmware(struct s5p_mfc_dev *dev)\n{\n\tstruct s5p_mfc_priv_buf *fw_buf = &dev->fw_buf;\n\tint err;\n\n\tfw_buf->size = dev->variant->buf_size->fw;\n\n\tif (fw_buf->virt) {\n\t\tmfc_err(\"Attempting to allocate firmware when it seems that it is already loaded\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\terr = s5p_mfc_alloc_priv_buf(dev, BANK_L_CTX, &dev->fw_buf);\n\tif (err) {\n\t\tmfc_err(\"Allocating bitprocessor buffer failed\\n\");\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\n \nint s5p_mfc_load_firmware(struct s5p_mfc_dev *dev)\n{\n\tstruct firmware *fw_blob;\n\tint i, err = -EINVAL;\n\n\t \n\tmfc_debug_enter();\n\n\tif (dev->fw_get_done)\n\t\treturn 0;\n\n\tfor (i = MFC_FW_MAX_VERSIONS - 1; i >= 0; i--) {\n\t\tif (!dev->variant->fw_name[i])\n\t\t\tcontinue;\n\t\terr = request_firmware((const struct firmware **)&fw_blob,\n\t\t\t\tdev->variant->fw_name[i], &dev->plat_dev->dev);\n\t\tif (!err) {\n\t\t\tdev->fw_ver = (enum s5p_mfc_fw_ver) i;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (err != 0) {\n\t\tmfc_err(\"Firmware is not present in the /lib/firmware directory nor compiled in kernel\\n\");\n\t\treturn -EINVAL;\n\t}\n\tif (fw_blob->size > dev->fw_buf.size) {\n\t\tmfc_err(\"MFC firmware is too big to be loaded\\n\");\n\t\trelease_firmware(fw_blob);\n\t\treturn -ENOMEM;\n\t}\n\tmemcpy(dev->fw_buf.virt, fw_blob->data, fw_blob->size);\n\twmb();\n\tdev->fw_get_done = true;\n\trelease_firmware(fw_blob);\n\tmfc_debug_leave();\n\treturn 0;\n}\n\n \nint s5p_mfc_release_firmware(struct s5p_mfc_dev *dev)\n{\n\t \n\ts5p_mfc_release_priv_buf(dev, &dev->fw_buf);\n\tdev->fw_get_done = false;\n\treturn 0;\n}\n\nstatic int s5p_mfc_bus_reset(struct s5p_mfc_dev *dev)\n{\n\tunsigned int status;\n\tunsigned long timeout;\n\n\t \n\tmfc_write(dev, 0x1, S5P_FIMV_MFC_BUS_RESET_CTRL);\n\ttimeout = jiffies + msecs_to_jiffies(MFC_BW_TIMEOUT);\n\t \n\tdo {\n\t\tif (time_after(jiffies, timeout)) {\n\t\t\tmfc_err(\"Timeout while resetting MFC.\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t\tstatus = mfc_read(dev, S5P_FIMV_MFC_BUS_RESET_CTRL);\n\t} while ((status & 0x2) == 0);\n\treturn 0;\n}\n\n \nint s5p_mfc_reset(struct s5p_mfc_dev *dev)\n{\n\tunsigned int mc_status;\n\tunsigned long timeout;\n\tint i;\n\n\tmfc_debug_enter();\n\n\tif (IS_MFCV6_PLUS(dev)) {\n\t\t \n\t\tmfc_write(dev, 0, S5P_FIMV_RISC2HOST_CMD_V6);\n\t\tmfc_write(dev, 0, S5P_FIMV_HOST2RISC_CMD_V6);\n\t\tmfc_write(dev, 0, S5P_FIMV_FW_VERSION_V6);\n\n\t\tfor (i = 0; i < S5P_FIMV_REG_CLEAR_COUNT_V6; i++)\n\t\t\tmfc_write(dev, 0, S5P_FIMV_REG_CLEAR_BEGIN_V6 + (i*4));\n\n\t\t \n\t\tif (dev->risc_on)\n\t\t\tif (s5p_mfc_bus_reset(dev))\n\t\t\t\treturn -EIO;\n\t\t \n\t\tif ((!dev->risc_on) || (!IS_MFCV7_PLUS(dev)))\n\t\t\tmfc_write(dev, 0, S5P_FIMV_RISC_ON_V6);\n\n\t\tmfc_write(dev, 0x1FFF, S5P_FIMV_MFC_RESET_V6);\n\t\tmfc_write(dev, 0, S5P_FIMV_MFC_RESET_V6);\n\t} else {\n\t\t \n\t\t \n\t\tmfc_write(dev, 0x3f6, S5P_FIMV_SW_RESET);\n\t\t \n\t\tmfc_write(dev, 0x3e2, S5P_FIMV_SW_RESET);\n\t\tmdelay(10);\n\n\t\ttimeout = jiffies + msecs_to_jiffies(MFC_BW_TIMEOUT);\n\t\t \n\t\tdo {\n\t\t\tif (time_after(jiffies, timeout)) {\n\t\t\t\tmfc_err(\"Timeout while resetting MFC\\n\");\n\t\t\t\treturn -EIO;\n\t\t\t}\n\n\t\t\tmc_status = mfc_read(dev, S5P_FIMV_MC_STATUS);\n\n\t\t} while (mc_status & 0x3);\n\n\t\tmfc_write(dev, 0x0, S5P_FIMV_SW_RESET);\n\t\tmfc_write(dev, 0x3fe, S5P_FIMV_SW_RESET);\n\t}\n\n\tmfc_debug_leave();\n\treturn 0;\n}\n\nstatic inline void s5p_mfc_init_memctrl(struct s5p_mfc_dev *dev)\n{\n\tif (IS_MFCV6_PLUS(dev)) {\n\t\tmfc_write(dev, dev->dma_base[BANK_L_CTX],\n\t\t\t  S5P_FIMV_RISC_BASE_ADDRESS_V6);\n\t\tmfc_debug(2, \"Base Address : %pad\\n\",\n\t\t\t  &dev->dma_base[BANK_L_CTX]);\n\t} else {\n\t\tmfc_write(dev, dev->dma_base[BANK_L_CTX],\n\t\t\t  S5P_FIMV_MC_DRAMBASE_ADR_A);\n\t\tmfc_write(dev, dev->dma_base[BANK_R_CTX],\n\t\t\t  S5P_FIMV_MC_DRAMBASE_ADR_B);\n\t\tmfc_debug(2, \"Bank1: %pad, Bank2: %pad\\n\",\n\t\t\t  &dev->dma_base[BANK_L_CTX],\n\t\t\t  &dev->dma_base[BANK_R_CTX]);\n\t}\n}\n\nstatic inline void s5p_mfc_clear_cmds(struct s5p_mfc_dev *dev)\n{\n\tif (IS_MFCV6_PLUS(dev)) {\n\t\t \n\t} else {\n\t\tmfc_write(dev, 0xffffffff, S5P_FIMV_SI_CH0_INST_ID);\n\t\tmfc_write(dev, 0xffffffff, S5P_FIMV_SI_CH1_INST_ID);\n\t\tmfc_write(dev, 0, S5P_FIMV_RISC2HOST_CMD);\n\t\tmfc_write(dev, 0, S5P_FIMV_HOST2RISC_CMD);\n\t}\n}\n\n \nint s5p_mfc_init_hw(struct s5p_mfc_dev *dev)\n{\n\tunsigned int ver;\n\tint ret;\n\n\tmfc_debug_enter();\n\tif (!dev->fw_buf.virt) {\n\t\tmfc_err(\"Firmware memory is not allocated.\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tmfc_debug(2, \"MFC reset..\\n\");\n\ts5p_mfc_clock_on();\n\tdev->risc_on = 0;\n\tret = s5p_mfc_reset(dev);\n\tif (ret) {\n\t\tmfc_err(\"Failed to reset MFC - timeout\\n\");\n\t\treturn ret;\n\t}\n\tmfc_debug(2, \"Done MFC reset..\\n\");\n\t \n\ts5p_mfc_init_memctrl(dev);\n\t \n\ts5p_mfc_clear_cmds(dev);\n\t \n\ts5p_mfc_clean_dev_int_flags(dev);\n\tif (IS_MFCV6_PLUS(dev)) {\n\t\tdev->risc_on = 1;\n\t\tmfc_write(dev, 0x1, S5P_FIMV_RISC_ON_V6);\n\t}\n\telse\n\t\tmfc_write(dev, 0x3ff, S5P_FIMV_SW_RESET);\n\n\tif (IS_MFCV10(dev))\n\t\tmfc_write(dev, 0x0, S5P_FIMV_MFC_CLOCK_OFF_V10);\n\n\tmfc_debug(2, \"Will now wait for completion of firmware transfer\\n\");\n\tif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_FW_STATUS_RET)) {\n\t\tmfc_err(\"Failed to load firmware\\n\");\n\t\ts5p_mfc_reset(dev);\n\t\ts5p_mfc_clock_off();\n\t\treturn -EIO;\n\t}\n\ts5p_mfc_clean_dev_int_flags(dev);\n\t \n\tret = s5p_mfc_hw_call(dev->mfc_cmds, sys_init_cmd, dev);\n\tif (ret) {\n\t\tmfc_err(\"Failed to send command to MFC - timeout\\n\");\n\t\ts5p_mfc_reset(dev);\n\t\ts5p_mfc_clock_off();\n\t\treturn ret;\n\t}\n\tmfc_debug(2, \"Ok, now will wait for completion of hardware init\\n\");\n\tif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_SYS_INIT_RET)) {\n\t\tmfc_err(\"Failed to init hardware\\n\");\n\t\ts5p_mfc_reset(dev);\n\t\ts5p_mfc_clock_off();\n\t\treturn -EIO;\n\t}\n\tdev->int_cond = 0;\n\tif (dev->int_err != 0 || dev->int_type !=\n\t\t\t\t\tS5P_MFC_R2H_CMD_SYS_INIT_RET) {\n\t\t \n\t\tmfc_err(\"Failed to init firmware - error: %d int: %d\\n\",\n\t\t\t\t\t\tdev->int_err, dev->int_type);\n\t\ts5p_mfc_reset(dev);\n\t\ts5p_mfc_clock_off();\n\t\treturn -EIO;\n\t}\n\tif (IS_MFCV6_PLUS(dev))\n\t\tver = mfc_read(dev, S5P_FIMV_FW_VERSION_V6);\n\telse\n\t\tver = mfc_read(dev, S5P_FIMV_FW_VERSION);\n\n\tmfc_debug(2, \"MFC F/W version : %02xyy, %02xmm, %02xdd\\n\",\n\t\t(ver >> 16) & 0xFF, (ver >> 8) & 0xFF, ver & 0xFF);\n\ts5p_mfc_clock_off();\n\tmfc_debug_leave();\n\treturn 0;\n}\n\n\n \nvoid s5p_mfc_deinit_hw(struct s5p_mfc_dev *dev)\n{\n\ts5p_mfc_clock_on();\n\n\ts5p_mfc_reset(dev);\n\ts5p_mfc_hw_call(dev->mfc_ops, release_dev_context_buffer, dev);\n\n\ts5p_mfc_clock_off();\n}\n\nint s5p_mfc_sleep(struct s5p_mfc_dev *dev)\n{\n\tint ret;\n\n\tmfc_debug_enter();\n\ts5p_mfc_clock_on();\n\ts5p_mfc_clean_dev_int_flags(dev);\n\tret = s5p_mfc_hw_call(dev->mfc_cmds, sleep_cmd, dev);\n\tif (ret) {\n\t\tmfc_err(\"Failed to send command to MFC - timeout\\n\");\n\t\treturn ret;\n\t}\n\tif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_SLEEP_RET)) {\n\t\tmfc_err(\"Failed to sleep\\n\");\n\t\treturn -EIO;\n\t}\n\ts5p_mfc_clock_off();\n\tdev->int_cond = 0;\n\tif (dev->int_err != 0 || dev->int_type !=\n\t\t\t\t\t\tS5P_MFC_R2H_CMD_SLEEP_RET) {\n\t\t \n\t\tmfc_err(\"Failed to sleep - error: %d int: %d\\n\", dev->int_err,\n\t\t\t\t\t\t\t\tdev->int_type);\n\t\treturn -EIO;\n\t}\n\tmfc_debug_leave();\n\treturn ret;\n}\n\nstatic int s5p_mfc_v8_wait_wakeup(struct s5p_mfc_dev *dev)\n{\n\tint ret;\n\n\t \n\tdev->risc_on = 1;\n\tmfc_write(dev, 0x1, S5P_FIMV_RISC_ON_V6);\n\n\tif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_FW_STATUS_RET)) {\n\t\tmfc_err(\"Failed to reset MFCV8\\n\");\n\t\treturn -EIO;\n\t}\n\tmfc_debug(2, \"Write command to wakeup MFCV8\\n\");\n\tret = s5p_mfc_hw_call(dev->mfc_cmds, wakeup_cmd, dev);\n\tif (ret) {\n\t\tmfc_err(\"Failed to send command to MFCV8 - timeout\\n\");\n\t\treturn ret;\n\t}\n\n\tif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_WAKEUP_RET)) {\n\t\tmfc_err(\"Failed to wakeup MFC\\n\");\n\t\treturn -EIO;\n\t}\n\treturn ret;\n}\n\nstatic int s5p_mfc_wait_wakeup(struct s5p_mfc_dev *dev)\n{\n\tint ret;\n\n\t \n\tret = s5p_mfc_hw_call(dev->mfc_cmds, wakeup_cmd, dev);\n\tif (ret) {\n\t\tmfc_err(\"Failed to send command to MFC - timeout\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (IS_MFCV6_PLUS(dev)) {\n\t\tdev->risc_on = 1;\n\t\tmfc_write(dev, 0x1, S5P_FIMV_RISC_ON_V6);\n\t} else {\n\t\tmfc_write(dev, 0x3ff, S5P_FIMV_SW_RESET);\n\t}\n\n\tif (s5p_mfc_wait_for_done_dev(dev, S5P_MFC_R2H_CMD_WAKEUP_RET)) {\n\t\tmfc_err(\"Failed to wakeup MFC\\n\");\n\t\treturn -EIO;\n\t}\n\treturn ret;\n}\n\nint s5p_mfc_wakeup(struct s5p_mfc_dev *dev)\n{\n\tint ret;\n\n\tmfc_debug_enter();\n\t \n\tmfc_debug(2, \"MFC reset..\\n\");\n\ts5p_mfc_clock_on();\n\tdev->risc_on = 0;\n\tret = s5p_mfc_reset(dev);\n\tif (ret) {\n\t\tmfc_err(\"Failed to reset MFC - timeout\\n\");\n\t\ts5p_mfc_clock_off();\n\t\treturn ret;\n\t}\n\tmfc_debug(2, \"Done MFC reset..\\n\");\n\t \n\ts5p_mfc_init_memctrl(dev);\n\t \n\ts5p_mfc_clear_cmds(dev);\n\ts5p_mfc_clean_dev_int_flags(dev);\n\t \n\tif (IS_MFCV8_PLUS(dev))\n\t\tret = s5p_mfc_v8_wait_wakeup(dev);\n\telse\n\t\tret = s5p_mfc_wait_wakeup(dev);\n\n\ts5p_mfc_clock_off();\n\tif (ret)\n\t\treturn ret;\n\n\tdev->int_cond = 0;\n\tif (dev->int_err != 0 || dev->int_type !=\n\t\t\t\t\t\tS5P_MFC_R2H_CMD_WAKEUP_RET) {\n\t\t \n\t\tmfc_err(\"Failed to wakeup - error: %d int: %d\\n\", dev->int_err,\n\t\t\t\t\t\t\t\tdev->int_type);\n\t\treturn -EIO;\n\t}\n\tmfc_debug_leave();\n\treturn 0;\n}\n\nint s5p_mfc_open_mfc_inst(struct s5p_mfc_dev *dev, struct s5p_mfc_ctx *ctx)\n{\n\tint ret = 0;\n\n\tret = s5p_mfc_hw_call(dev->mfc_ops, alloc_instance_buffer, ctx);\n\tif (ret) {\n\t\tmfc_err(\"Failed allocating instance buffer\\n\");\n\t\tgoto err;\n\t}\n\n\tif (ctx->type == MFCINST_DECODER) {\n\t\tret = s5p_mfc_hw_call(dev->mfc_ops,\n\t\t\t\t\talloc_dec_temp_buffers, ctx);\n\t\tif (ret) {\n\t\t\tmfc_err(\"Failed allocating temporary buffers\\n\");\n\t\t\tgoto err_free_inst_buf;\n\t\t}\n\t}\n\n\tset_work_bit_irqsave(ctx);\n\ts5p_mfc_hw_call(dev->mfc_ops, try_run, dev);\n\tif (s5p_mfc_wait_for_done_ctx(ctx,\n\t\tS5P_MFC_R2H_CMD_OPEN_INSTANCE_RET, 0)) {\n\t\t \n\t\tmfc_err(\"Error getting instance from hardware\\n\");\n\t\tret = -EIO;\n\t\tgoto err_free_desc_buf;\n\t}\n\n\tmfc_debug(2, \"Got instance number: %d\\n\", ctx->inst_no);\n\treturn ret;\n\nerr_free_desc_buf:\n\tif (ctx->type == MFCINST_DECODER)\n\t\ts5p_mfc_hw_call(dev->mfc_ops, release_dec_desc_buffer, ctx);\nerr_free_inst_buf:\n\ts5p_mfc_hw_call(dev->mfc_ops, release_instance_buffer, ctx);\nerr:\n\treturn ret;\n}\n\nvoid s5p_mfc_close_mfc_inst(struct s5p_mfc_dev *dev, struct s5p_mfc_ctx *ctx)\n{\n\tctx->state = MFCINST_RETURN_INST;\n\tset_work_bit_irqsave(ctx);\n\ts5p_mfc_hw_call(dev->mfc_ops, try_run, dev);\n\t \n\tif (s5p_mfc_wait_for_done_ctx(ctx,\n\t\t\t\tS5P_MFC_R2H_CMD_CLOSE_INSTANCE_RET, 0)){\n\t\tclear_work_bit_irqsave(ctx);\n\t\tmfc_err(\"Err returning instance\\n\");\n\t}\n\n\t \n\ts5p_mfc_hw_call(dev->mfc_ops, release_codec_buffers, ctx);\n\ts5p_mfc_hw_call(dev->mfc_ops, release_instance_buffer, ctx);\n\tif (ctx->type == MFCINST_DECODER)\n\t\ts5p_mfc_hw_call(dev->mfc_ops, release_dec_desc_buffer, ctx);\n\n\tctx->inst_no = MFC_NO_INSTANCE_SET;\n\tctx->state = MFCINST_FREE;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}