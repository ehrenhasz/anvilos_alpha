{
  "module_name": "flexcop-sram.c",
  "hash_id": "b5cc616fbbce862e2e2682c3d02bba3cd2aa7e1eb9d6964524f48c52292d33f4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/common/b2c2/flexcop-sram.c",
  "human_readable_source": "\n \n#include \"flexcop.h\"\n\nstatic void flexcop_sram_set_chip(struct flexcop_device *fc,\n\t\tflexcop_sram_type_t type)\n{\n\tflexcop_set_ibi_value(wan_ctrl_reg_71c, sram_chip, type);\n}\n\nint flexcop_sram_init(struct flexcop_device *fc)\n{\n\tswitch (fc->rev) {\n\tcase FLEXCOP_II:\n\tcase FLEXCOP_IIB:\n\t\tflexcop_sram_set_chip(fc, FC_SRAM_1_32KB);\n\t\tbreak;\n\tcase FLEXCOP_III:\n\t\tflexcop_sram_set_chip(fc, FC_SRAM_1_48KB);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nint flexcop_sram_set_dest(struct flexcop_device *fc, flexcop_sram_dest_t dest,\n\t\t flexcop_sram_dest_target_t target)\n{\n\tflexcop_ibi_value v;\n\tv = fc->read_ibi_reg(fc, sram_dest_reg_714);\n\n\tif (fc->rev != FLEXCOP_III && target == FC_SRAM_DEST_TARGET_FC3_CA) {\n\t\terr(\"SRAM destination target to available on FlexCopII(b)\\n\");\n\t\treturn -EINVAL;\n\t}\n\tdeb_sram(\"sram dest: %x target: %x\\n\", dest, target);\n\n\tif (dest & FC_SRAM_DEST_NET)\n\t\tv.sram_dest_reg_714.NET_Dest = target;\n\tif (dest & FC_SRAM_DEST_CAI)\n\t\tv.sram_dest_reg_714.CAI_Dest = target;\n\tif (dest & FC_SRAM_DEST_CAO)\n\t\tv.sram_dest_reg_714.CAO_Dest = target;\n\tif (dest & FC_SRAM_DEST_MEDIA)\n\t\tv.sram_dest_reg_714.MEDIA_Dest = target;\n\n\tfc->write_ibi_reg(fc,sram_dest_reg_714,v);\n\tudelay(1000);  \n\n\treturn 0;\n}\nEXPORT_SYMBOL(flexcop_sram_set_dest);\n\nvoid flexcop_wan_set_speed(struct flexcop_device *fc, flexcop_wan_speed_t s)\n{\n\tflexcop_set_ibi_value(wan_ctrl_reg_71c,wan_speed_sig,s);\n}\nEXPORT_SYMBOL(flexcop_wan_set_speed);\n\nvoid flexcop_sram_ctrl(struct flexcop_device *fc, int usb_wan, int sramdma, int maximumfill)\n{\n\tflexcop_ibi_value v = fc->read_ibi_reg(fc,sram_dest_reg_714);\n\tv.sram_dest_reg_714.ctrl_usb_wan = usb_wan;\n\tv.sram_dest_reg_714.ctrl_sramdma = sramdma;\n\tv.sram_dest_reg_714.ctrl_maximumfill = maximumfill;\n\tfc->write_ibi_reg(fc,sram_dest_reg_714,v);\n}\nEXPORT_SYMBOL(flexcop_sram_ctrl);\n\n#if 0\nstatic void flexcop_sram_write(struct adapter *adapter, u32 bank, u32 addr, u8 *buf, u32 len)\n{\n\tint i, retries;\n\tu32 command;\n\n\tfor (i = 0; i < len; i++) {\n\t\tcommand = bank | addr | 0x04000000 | (*buf << 0x10);\n\n\t\tretries = 2;\n\n\t\twhile (((read_reg_dw(adapter, 0x700) & 0x80000000) != 0) && (retries > 0)) {\n\t\t\tmdelay(1);\n\t\t\tretries--;\n\t\t}\n\n\t\tif (retries == 0)\n\t\t\tprintk(\"%s: SRAM timeout\\n\", __func__);\n\n\t\twrite_reg_dw(adapter, 0x700, command);\n\n\t\tbuf++;\n\t\taddr++;\n\t}\n}\n\nstatic void flex_sram_read(struct adapter *adapter, u32 bank, u32 addr, u8 *buf, u32 len)\n{\n\tint i, retries;\n\tu32 command, value;\n\n\tfor (i = 0; i < len; i++) {\n\t\tcommand = bank | addr | 0x04008000;\n\n\t\tretries = 10000;\n\n\t\twhile (((read_reg_dw(adapter, 0x700) & 0x80000000) != 0) && (retries > 0)) {\n\t\t\tmdelay(1);\n\t\t\tretries--;\n\t\t}\n\n\t\tif (retries == 0)\n\t\t\tprintk(\"%s: SRAM timeout\\n\", __func__);\n\n\t\twrite_reg_dw(adapter, 0x700, command);\n\n\t\tretries = 10000;\n\n\t\twhile (((read_reg_dw(adapter, 0x700) & 0x80000000) != 0) && (retries > 0)) {\n\t\t\tmdelay(1);\n\t\t\tretries--;\n\t\t}\n\n\t\tif (retries == 0)\n\t\t\tprintk(\"%s: SRAM timeout\\n\", __func__);\n\n\t\tvalue = read_reg_dw(adapter, 0x700) >> 0x10;\n\n\t\t*buf = (value & 0xff);\n\n\t\taddr++;\n\t\tbuf++;\n\t}\n}\n\nstatic void sram_write_chunk(struct adapter *adapter, u32 addr, u8 *buf, u16 len)\n{\n\tu32 bank;\n\n\tbank = 0;\n\n\tif (adapter->dw_sram_type == 0x20000) {\n\t\tbank = (addr & 0x18000) << 0x0d;\n\t}\n\n\tif (adapter->dw_sram_type == 0x00000) {\n\t\tif ((addr >> 0x0f) == 0)\n\t\t\tbank = 0x20000000;\n\t\telse\n\t\t\tbank = 0x10000000;\n\t}\n\tflex_sram_write(adapter, bank, addr & 0x7fff, buf, len);\n}\n\nstatic void sram_read_chunk(struct adapter *adapter, u32 addr, u8 *buf, u16 len)\n{\n\tu32 bank;\n\tbank = 0;\n\n\tif (adapter->dw_sram_type == 0x20000) {\n\t\tbank = (addr & 0x18000) << 0x0d;\n\t}\n\n\tif (adapter->dw_sram_type == 0x00000) {\n\t\tif ((addr >> 0x0f) == 0)\n\t\t\tbank = 0x20000000;\n\t\telse\n\t\t\tbank = 0x10000000;\n\t}\n\tflex_sram_read(adapter, bank, addr & 0x7fff, buf, len);\n}\n\nstatic void sram_read(struct adapter *adapter, u32 addr, u8 *buf, u32 len)\n{\n\tu32 length;\n\twhile (len != 0) {\n\t\tlength = len;\n\t\t \n\t\tif ((addr >> 0x0f) != ((addr + len - 1) >> 0x0f)) {\n\t\t\tlength = (((addr >> 0x0f) + 1) << 0x0f) - addr;\n\t\t}\n\n\t\tsram_read_chunk(adapter, addr, buf, length);\n\t\taddr = addr + length;\n\t\tbuf = buf + length;\n\t\tlen = len - length;\n\t}\n}\n\nstatic void sram_write(struct adapter *adapter, u32 addr, u8 *buf, u32 len)\n{\n\tu32 length;\n\twhile (len != 0) {\n\t\tlength = len;\n\n\t\t \n\t\tif ((addr >> 0x0f) != ((addr + len - 1) >> 0x0f)) {\n\t\t\tlength = (((addr >> 0x0f) + 1) << 0x0f) - addr;\n\t\t}\n\n\t\tsram_write_chunk(adapter, addr, buf, length);\n\t\taddr = addr + length;\n\t\tbuf = buf + length;\n\t\tlen = len - length;\n\t}\n}\n\nstatic void sram_set_size(struct adapter *adapter, u32 mask)\n{\n\twrite_reg_dw(adapter, 0x71c,\n\t\t\t(mask | (~0x30000 & read_reg_dw(adapter, 0x71c))));\n}\n\nstatic void sram_init(struct adapter *adapter)\n{\n\tu32 tmp;\n\ttmp = read_reg_dw(adapter, 0x71c);\n\twrite_reg_dw(adapter, 0x71c, 1);\n\n\tif (read_reg_dw(adapter, 0x71c) != 0) {\n\t\twrite_reg_dw(adapter, 0x71c, tmp);\n\t\tadapter->dw_sram_type = tmp & 0x30000;\n\t\tddprintk(\"%s: dw_sram_type = %x\\n\", __func__, adapter->dw_sram_type);\n\t} else {\n\t\tadapter->dw_sram_type = 0x10000;\n\t\tddprintk(\"%s: dw_sram_type = %x\\n\", __func__, adapter->dw_sram_type);\n\t}\n}\n\nstatic int sram_test_location(struct adapter *adapter, u32 mask, u32 addr)\n{\n\tu8 tmp1, tmp2;\n\tdprintk(\"%s: mask = %x, addr = %x\\n\", __func__, mask, addr);\n\n\tsram_set_size(adapter, mask);\n\tsram_init(adapter);\n\n\ttmp2 = 0xa5;\n\ttmp1 = 0x4f;\n\n\tsram_write(adapter, addr, &tmp2, 1);\n\tsram_write(adapter, addr + 4, &tmp1, 1);\n\n\ttmp2 = 0;\n\tmdelay(20);\n\n\tsram_read(adapter, addr, &tmp2, 1);\n\tsram_read(adapter, addr, &tmp2, 1);\n\n\tdprintk(\"%s: wrote 0xa5, read 0x%2x\\n\", __func__, tmp2);\n\n\tif (tmp2 != 0xa5)\n\t\treturn 0;\n\n\ttmp2 = 0x5a;\n\ttmp1 = 0xf4;\n\n\tsram_write(adapter, addr, &tmp2, 1);\n\tsram_write(adapter, addr + 4, &tmp1, 1);\n\n\ttmp2 = 0;\n\tmdelay(20);\n\n\tsram_read(adapter, addr, &tmp2, 1);\n\tsram_read(adapter, addr, &tmp2, 1);\n\n\tdprintk(\"%s: wrote 0x5a, read 0x%2x\\n\", __func__, tmp2);\n\n\tif (tmp2 != 0x5a)\n\t\treturn 0;\n\treturn 1;\n}\n\nstatic u32 sram_length(struct adapter *adapter)\n{\n\tif (adapter->dw_sram_type == 0x10000)\n\t\treturn 32768;  \n\tif (adapter->dw_sram_type == 0x00000)\n\t\treturn 65536;  \n\tif (adapter->dw_sram_type == 0x20000)\n\t\treturn 131072;  \n\treturn 32768;  \n}\n\n \n\nstatic int flexcop_sram_detect(struct flexcop_device *fc)\n{\n\tflexcop_ibi_value r208, r71c_0, vr71c_1;\n\tr208 = fc->read_ibi_reg(fc, ctrl_208);\n\tfc->write_ibi_reg(fc, ctrl_208, ibi_zero);\n\n\tr71c_0 = fc->read_ibi_reg(fc, wan_ctrl_reg_71c);\n\twrite_reg_dw(adapter, 0x71c, 1);\n\ttmp3 = read_reg_dw(adapter, 0x71c);\n\tdprintk(\"%s: tmp3 = %x\\n\", __func__, tmp3);\n\twrite_reg_dw(adapter, 0x71c, tmp2);\n\n\t\n\ttmp3--;\n\tif (tmp3 != 0) {\n\t\tsram_set_size(adapter, 0x10000);\n\t\tsram_init(adapter);\n\t\twrite_reg_dw(adapter, 0x208, tmp);\n\t\tdprintk(\"%s: sram size = 32K\\n\", __func__);\n\t\treturn 32;\n\t}\n\n\tif (sram_test_location(adapter, 0x20000, 0x18000) != 0) {\n\t\tsram_set_size(adapter, 0x20000);\n\t\tsram_init(adapter);\n\t\twrite_reg_dw(adapter, 0x208, tmp);\n\t\tdprintk(\"%s: sram size = 128K\\n\", __func__);\n\t\treturn 128;\n\t}\n\n\tif (sram_test_location(adapter, 0x00000, 0x10000) != 0) {\n\t\tsram_set_size(adapter, 0x00000);\n\t\tsram_init(adapter);\n\t\twrite_reg_dw(adapter, 0x208, tmp);\n\t\tdprintk(\"%s: sram size = 64K\\n\", __func__);\n\t\treturn 64;\n\t}\n\n\tif (sram_test_location(adapter, 0x10000, 0x00000) != 0) {\n\t\tsram_set_size(adapter, 0x10000);\n\t\tsram_init(adapter);\n\t\twrite_reg_dw(adapter, 0x208, tmp);\n\t\tdprintk(\"%s: sram size = 32K\\n\", __func__);\n\t\treturn 32;\n\t}\n\n\tsram_set_size(adapter, 0x10000);\n\tsram_init(adapter);\n\twrite_reg_dw(adapter, 0x208, tmp);\n\tdprintk(\"%s: SRAM detection failed. Set to 32K \\n\", __func__);\n\treturn 0;\n}\n\nstatic void sll_detect_sram_size(struct adapter *adapter)\n{\n\tsram_detect_for_flex2(adapter);\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}