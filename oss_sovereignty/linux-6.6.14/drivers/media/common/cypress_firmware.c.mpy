{
  "module_name": "cypress_firmware.c",
  "hash_id": "5c86f8ff1eb3886fb9e78799ab39ddd5a788fade5dbde88ab053e199960911a1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/common/cypress_firmware.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/usb.h>\n#include <linux/firmware.h>\n#include \"cypress_firmware.h\"\n\nstruct usb_cypress_controller {\n\tu8 id;\n\tconst char *name;\t \n\tu16 cs_reg;\t\t \n};\n\nstatic const struct usb_cypress_controller cypress[] = {\n\t{ .id = CYPRESS_AN2135, .name = \"Cypress AN2135\", .cs_reg = 0x7f92 },\n\t{ .id = CYPRESS_AN2235, .name = \"Cypress AN2235\", .cs_reg = 0x7f92 },\n\t{ .id = CYPRESS_FX2,    .name = \"Cypress FX2\",    .cs_reg = 0xe600 },\n};\n\n \nstatic int usb_cypress_writemem(struct usb_device *udev, u16 addr, u8 *data,\n\t\tu8 len)\n{\n\treturn usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\n\t\t\t0xa0, USB_TYPE_VENDOR, addr, 0x00, data, len, 5000);\n}\n\nstatic int cypress_get_hexline(const struct firmware *fw,\n\t\t\t\tstruct hexline *hx, int *pos)\n{\n\tu8 *b = (u8 *) &fw->data[*pos];\n\tint data_offs = 4;\n\n\tif (*pos >= fw->size)\n\t\treturn 0;\n\n\tmemset(hx, 0, sizeof(struct hexline));\n\thx->len = b[0];\n\n\tif ((*pos + hx->len + 4) >= fw->size)\n\t\treturn -EINVAL;\n\n\thx->addr = b[1] | (b[2] << 8);\n\thx->type = b[3];\n\n\tif (hx->type == 0x04) {\n\t\t \n\t\thx->addr |= (b[4] << 24) | (b[5] << 16);\n\t}\n\n\tmemcpy(hx->data, &b[data_offs], hx->len);\n\thx->chk = b[hx->len + data_offs];\n\t*pos += hx->len + 5;\n\n\treturn *pos;\n}\n\nint cypress_load_firmware(struct usb_device *udev,\n\t\tconst struct firmware *fw, int type)\n{\n\tstruct hexline *hx;\n\tint ret, pos = 0;\n\n\thx = kmalloc(sizeof(*hx), GFP_KERNEL);\n\tif (!hx)\n\t\treturn -ENOMEM;\n\n\t \n\thx->data[0] = 1;\n\tret = usb_cypress_writemem(udev, cypress[type].cs_reg, hx->data, 1);\n\tif (ret != 1) {\n\t\tdev_err(&udev->dev, \"%s: CPU stop failed=%d\\n\",\n\t\t\t\tKBUILD_MODNAME, ret);\n\t\tret = -EIO;\n\t\tgoto err_kfree;\n\t}\n\n\t \n\tfor (;;) {\n\t\tret = cypress_get_hexline(fw, hx, &pos);\n\t\tif (ret < 0)\n\t\t\tgoto err_kfree;\n\t\telse if (ret == 0)\n\t\t\tbreak;\n\n\t\tret = usb_cypress_writemem(udev, hx->addr, hx->data, hx->len);\n\t\tif (ret < 0) {\n\t\t\tgoto err_kfree;\n\t\t} else if (ret != hx->len) {\n\t\t\tdev_err(&udev->dev,\n\t\t\t\t\t\"%s: error while transferring firmware (transferred size=%d, block size=%d)\\n\",\n\t\t\t\t\tKBUILD_MODNAME, ret, hx->len);\n\t\t\tret = -EIO;\n\t\t\tgoto err_kfree;\n\t\t}\n\t}\n\n\t \n\thx->data[0] = 0;\n\tret = usb_cypress_writemem(udev, cypress[type].cs_reg, hx->data, 1);\n\tif (ret != 1) {\n\t\tdev_err(&udev->dev, \"%s: CPU start failed=%d\\n\",\n\t\t\t\tKBUILD_MODNAME, ret);\n\t\tret = -EIO;\n\t\tgoto err_kfree;\n\t}\n\n\tret = 0;\nerr_kfree:\n\tkfree(hx);\n\treturn ret;\n}\nEXPORT_SYMBOL(cypress_load_firmware);\n\nMODULE_AUTHOR(\"Antti Palosaari <crope@iki.fi>\");\nMODULE_DESCRIPTION(\"Cypress firmware download\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}