{
  "module_name": "cx2341x.c",
  "hash_id": "daa8b3610cadce8830ce2a35db2acb8eb9a0a46b02241b44602cd99df8388164",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/common/cx2341x.c",
  "human_readable_source": "\n \n\n\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/types.h>\n#include <linux/videodev2.h>\n\n#include <media/tuner.h>\n#include <media/drv-intf/cx2341x.h>\n#include <media/v4l2-common.h>\n\nMODULE_DESCRIPTION(\"cx23415/6/8 driver\");\nMODULE_AUTHOR(\"Hans Verkuil\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int debug;\nmodule_param(debug, int, 0644);\nMODULE_PARM_DESC(debug, \"Debug level (0-1)\");\n\n \n\n \n#define CX2341X_AUDIO_ENCODING_METHOD_MPEG\t0\n#define CX2341X_AUDIO_ENCODING_METHOD_AC3\t1\n#define CX2341X_AUDIO_ENCODING_METHOD_LPCM\t2\n\nstatic const char *cx2341x_get_name(u32 id)\n{\n\tswitch (id) {\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\n\t\treturn \"Spatial Filter Mode\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\n\t\treturn \"Spatial Filter\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\n\t\treturn \"Spatial Luma Filter Type\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\n\t\treturn \"Spatial Chroma Filter Type\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\n\t\treturn \"Temporal Filter Mode\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\n\t\treturn \"Temporal Filter\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\n\t\treturn \"Median Filter Type\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\n\t\treturn \"Median Luma Filter Maximum\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\n\t\treturn \"Median Luma Filter Minimum\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\n\t\treturn \"Median Chroma Filter Maximum\";\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\n\t\treturn \"Median Chroma Filter Minimum\";\n\tcase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\n\t\treturn \"Insert Navigation Packets\";\n\t}\n\treturn NULL;\n}\n\nstatic const char **cx2341x_get_menu(u32 id)\n{\n\tstatic const char *cx2341x_video_spatial_filter_mode_menu[] = {\n\t\t\"Manual\",\n\t\t\"Auto\",\n\t\tNULL\n\t};\n\n\tstatic const char *cx2341x_video_luma_spatial_filter_type_menu[] = {\n\t\t\"Off\",\n\t\t\"1D Horizontal\",\n\t\t\"1D Vertical\",\n\t\t\"2D H/V Separable\",\n\t\t\"2D Symmetric non-separable\",\n\t\tNULL\n\t};\n\n\tstatic const char *cx2341x_video_chroma_spatial_filter_type_menu[] = {\n\t\t\"Off\",\n\t\t\"1D Horizontal\",\n\t\tNULL\n\t};\n\n\tstatic const char *cx2341x_video_temporal_filter_mode_menu[] = {\n\t\t\"Manual\",\n\t\t\"Auto\",\n\t\tNULL\n\t};\n\n\tstatic const char *cx2341x_video_median_filter_type_menu[] = {\n\t\t\"Off\",\n\t\t\"Horizontal\",\n\t\t\"Vertical\",\n\t\t\"Horizontal/Vertical\",\n\t\t\"Diagonal\",\n\t\tNULL\n\t};\n\n\tswitch (id) {\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\n\t\treturn cx2341x_video_spatial_filter_mode_menu;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\n\t\treturn cx2341x_video_luma_spatial_filter_type_menu;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\n\t\treturn cx2341x_video_chroma_spatial_filter_type_menu;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\n\t\treturn cx2341x_video_temporal_filter_mode_menu;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\n\t\treturn cx2341x_video_median_filter_type_menu;\n\t}\n\treturn NULL;\n}\n\nstatic void cx2341x_ctrl_fill(u32 id, const char **name, enum v4l2_ctrl_type *type,\n\t\t    s32 *min, s32 *max, s32 *step, s32 *def, u32 *flags)\n{\n\t*name = cx2341x_get_name(id);\n\t*flags = 0;\n\n\tswitch (id) {\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\n\t\t*type = V4L2_CTRL_TYPE_MENU;\n\t\t*min = 0;\n\t\t*step = 0;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\n\t\t*type = V4L2_CTRL_TYPE_BOOLEAN;\n\t\t*min = 0;\n\t\t*max = *step = 1;\n\t\tbreak;\n\tdefault:\n\t\t*type = V4L2_CTRL_TYPE_INTEGER;\n\t\tbreak;\n\t}\n\tswitch (id) {\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\n\t\t*flags |= V4L2_CTRL_FLAG_UPDATE;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\n\t\t*flags |= V4L2_CTRL_FLAG_SLIDER;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_ENCODING:\n\t\t*flags |= V4L2_CTRL_FLAG_READ_ONLY;\n\t\tbreak;\n\t}\n}\n\n\n \n\n \nconst u32 cx2341x_mpeg_ctrls[] = {\n\tV4L2_CID_CODEC_CLASS,\n\tV4L2_CID_MPEG_STREAM_TYPE,\n\tV4L2_CID_MPEG_STREAM_VBI_FMT,\n\tV4L2_CID_MPEG_AUDIO_SAMPLING_FREQ,\n\tV4L2_CID_MPEG_AUDIO_ENCODING,\n\tV4L2_CID_MPEG_AUDIO_L2_BITRATE,\n\tV4L2_CID_MPEG_AUDIO_MODE,\n\tV4L2_CID_MPEG_AUDIO_MODE_EXTENSION,\n\tV4L2_CID_MPEG_AUDIO_EMPHASIS,\n\tV4L2_CID_MPEG_AUDIO_CRC,\n\tV4L2_CID_MPEG_AUDIO_MUTE,\n\tV4L2_CID_MPEG_AUDIO_AC3_BITRATE,\n\tV4L2_CID_MPEG_VIDEO_ENCODING,\n\tV4L2_CID_MPEG_VIDEO_ASPECT,\n\tV4L2_CID_MPEG_VIDEO_B_FRAMES,\n\tV4L2_CID_MPEG_VIDEO_GOP_SIZE,\n\tV4L2_CID_MPEG_VIDEO_GOP_CLOSURE,\n\tV4L2_CID_MPEG_VIDEO_BITRATE_MODE,\n\tV4L2_CID_MPEG_VIDEO_BITRATE,\n\tV4L2_CID_MPEG_VIDEO_BITRATE_PEAK,\n\tV4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION,\n\tV4L2_CID_MPEG_VIDEO_MUTE,\n\tV4L2_CID_MPEG_VIDEO_MUTE_YUV,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM,\n\tV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP,\n\tV4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS,\n\t0\n};\nEXPORT_SYMBOL(cx2341x_mpeg_ctrls);\n\nstatic const struct cx2341x_mpeg_params default_params = {\n\t \n\t.capabilities = 0,\n\t.port = CX2341X_PORT_MEMORY,\n\t.width = 720,\n\t.height = 480,\n\t.is_50hz = 0,\n\n\t \n\t.stream_type = V4L2_MPEG_STREAM_TYPE_MPEG2_PS,\n\t.stream_vbi_fmt = V4L2_MPEG_STREAM_VBI_FMT_NONE,\n\t.stream_insert_nav_packets = 0,\n\n\t \n\t.audio_sampling_freq = V4L2_MPEG_AUDIO_SAMPLING_FREQ_48000,\n\t.audio_encoding = V4L2_MPEG_AUDIO_ENCODING_LAYER_2,\n\t.audio_l2_bitrate = V4L2_MPEG_AUDIO_L2_BITRATE_224K,\n\t.audio_ac3_bitrate = V4L2_MPEG_AUDIO_AC3_BITRATE_224K,\n\t.audio_mode = V4L2_MPEG_AUDIO_MODE_STEREO,\n\t.audio_mode_extension = V4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_4,\n\t.audio_emphasis = V4L2_MPEG_AUDIO_EMPHASIS_NONE,\n\t.audio_crc = V4L2_MPEG_AUDIO_CRC_NONE,\n\t.audio_mute = 0,\n\n\t \n\t.video_encoding = V4L2_MPEG_VIDEO_ENCODING_MPEG_2,\n\t.video_aspect = V4L2_MPEG_VIDEO_ASPECT_4x3,\n\t.video_b_frames = 2,\n\t.video_gop_size = 12,\n\t.video_gop_closure = 1,\n\t.video_bitrate_mode = V4L2_MPEG_VIDEO_BITRATE_MODE_VBR,\n\t.video_bitrate = 6000000,\n\t.video_bitrate_peak = 8000000,\n\t.video_temporal_decimation = 0,\n\t.video_mute = 0,\n\t.video_mute_yuv = 0x008080,   \n\n\t \n\t.video_spatial_filter_mode =\n\t\tV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_MANUAL,\n\t.video_spatial_filter = 0,\n\t.video_luma_spatial_filter_type =\n\t\tV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_1D_HOR,\n\t.video_chroma_spatial_filter_type =\n\t\tV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_1D_HOR,\n\t.video_temporal_filter_mode =\n\t\tV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_MANUAL,\n\t.video_temporal_filter = 8,\n\t.video_median_filter_type =\n\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF,\n\t.video_luma_median_filter_top = 255,\n\t.video_luma_median_filter_bottom = 0,\n\t.video_chroma_median_filter_top = 255,\n\t.video_chroma_median_filter_bottom = 0,\n};\n \nstatic int cx2341x_get_ctrl(const struct cx2341x_mpeg_params *params,\n\t\tstruct v4l2_ext_control *ctrl)\n{\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ:\n\t\tctrl->value = params->audio_sampling_freq;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_ENCODING:\n\t\tctrl->value = params->audio_encoding;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_L2_BITRATE:\n\t\tctrl->value = params->audio_l2_bitrate;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_AC3_BITRATE:\n\t\tctrl->value = params->audio_ac3_bitrate;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_MODE:\n\t\tctrl->value = params->audio_mode;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_MODE_EXTENSION:\n\t\tctrl->value = params->audio_mode_extension;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_EMPHASIS:\n\t\tctrl->value = params->audio_emphasis;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_CRC:\n\t\tctrl->value = params->audio_crc;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_MUTE:\n\t\tctrl->value = params->audio_mute;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_ENCODING:\n\t\tctrl->value = params->video_encoding;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_ASPECT:\n\t\tctrl->value = params->video_aspect;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_B_FRAMES:\n\t\tctrl->value = params->video_b_frames;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_GOP_SIZE:\n\t\tctrl->value = params->video_gop_size;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_GOP_CLOSURE:\n\t\tctrl->value = params->video_gop_closure;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_BITRATE_MODE:\n\t\tctrl->value = params->video_bitrate_mode;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_BITRATE:\n\t\tctrl->value = params->video_bitrate;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_BITRATE_PEAK:\n\t\tctrl->value = params->video_bitrate_peak;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION:\n\t\tctrl->value = params->video_temporal_decimation;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_MUTE:\n\t\tctrl->value = params->video_mute;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_MUTE_YUV:\n\t\tctrl->value = params->video_mute_yuv;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_STREAM_TYPE:\n\t\tctrl->value = params->stream_type;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_STREAM_VBI_FMT:\n\t\tctrl->value = params->stream_vbi_fmt;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\n\t\tctrl->value = params->video_spatial_filter_mode;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\n\t\tctrl->value = params->video_spatial_filter;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\n\t\tctrl->value = params->video_luma_spatial_filter_type;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\n\t\tctrl->value = params->video_chroma_spatial_filter_type;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\n\t\tctrl->value = params->video_temporal_filter_mode;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\n\t\tctrl->value = params->video_temporal_filter;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\n\t\tctrl->value = params->video_median_filter_type;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\n\t\tctrl->value = params->video_luma_median_filter_top;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\n\t\tctrl->value = params->video_luma_median_filter_bottom;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\n\t\tctrl->value = params->video_chroma_median_filter_top;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\n\t\tctrl->value = params->video_chroma_median_filter_bottom;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\n\t\tctrl->value = params->stream_insert_nav_packets;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\n \nstatic int cx2341x_set_ctrl(struct cx2341x_mpeg_params *params, int busy,\n\t\tstruct v4l2_ext_control *ctrl)\n{\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ:\n\t\tif (busy)\n\t\t\treturn -EBUSY;\n\t\tparams->audio_sampling_freq = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_ENCODING:\n\t\tif (busy)\n\t\t\treturn -EBUSY;\n\t\tif (params->capabilities & CX2341X_CAP_HAS_AC3)\n\t\t\tif (ctrl->value != V4L2_MPEG_AUDIO_ENCODING_LAYER_2 &&\n\t\t\t    ctrl->value != V4L2_MPEG_AUDIO_ENCODING_AC3)\n\t\t\t\treturn -ERANGE;\n\t\tparams->audio_encoding = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_L2_BITRATE:\n\t\tif (busy)\n\t\t\treturn -EBUSY;\n\t\tparams->audio_l2_bitrate = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_AC3_BITRATE:\n\t\tif (busy)\n\t\t\treturn -EBUSY;\n\t\tif (!(params->capabilities & CX2341X_CAP_HAS_AC3))\n\t\t\treturn -EINVAL;\n\t\tparams->audio_ac3_bitrate = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_MODE:\n\t\tparams->audio_mode = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_MODE_EXTENSION:\n\t\tparams->audio_mode_extension = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_EMPHASIS:\n\t\tparams->audio_emphasis = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_CRC:\n\t\tparams->audio_crc = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_AUDIO_MUTE:\n\t\tparams->audio_mute = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_ASPECT:\n\t\tparams->video_aspect = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_B_FRAMES: {\n\t\tint b = ctrl->value + 1;\n\t\tint gop = params->video_gop_size;\n\t\tparams->video_b_frames = ctrl->value;\n\t\tparams->video_gop_size = b * ((gop + b - 1) / b);\n\t\t \n\t\twhile (params->video_gop_size > 34)\n\t\t\tparams->video_gop_size -= b;\n\t\tbreak;\n\t}\n\tcase V4L2_CID_MPEG_VIDEO_GOP_SIZE: {\n\t\tint b = params->video_b_frames + 1;\n\t\tint gop = ctrl->value;\n\t\tparams->video_gop_size = b * ((gop + b - 1) / b);\n\t\t \n\t\twhile (params->video_gop_size > 34)\n\t\t\tparams->video_gop_size -= b;\n\t\tctrl->value = params->video_gop_size;\n\t\tbreak;\n\t}\n\tcase V4L2_CID_MPEG_VIDEO_GOP_CLOSURE:\n\t\tparams->video_gop_closure = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_BITRATE_MODE:\n\t\tif (busy)\n\t\t\treturn -EBUSY;\n\t\t \n\t\tif (params->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1 &&\n\t\t    ctrl->value != V4L2_MPEG_VIDEO_BITRATE_MODE_CBR)\n\t\t\treturn -EINVAL;\n\t\tparams->video_bitrate_mode = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_BITRATE:\n\t\tif (busy)\n\t\t\treturn -EBUSY;\n\t\tparams->video_bitrate = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_BITRATE_PEAK:\n\t\tif (busy)\n\t\t\treturn -EBUSY;\n\t\tparams->video_bitrate_peak = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION:\n\t\tparams->video_temporal_decimation = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_MUTE:\n\t\tparams->video_mute = (ctrl->value != 0);\n\t\tbreak;\n\tcase V4L2_CID_MPEG_VIDEO_MUTE_YUV:\n\t\tparams->video_mute_yuv = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_STREAM_TYPE:\n\t\tif (busy)\n\t\t\treturn -EBUSY;\n\t\tparams->stream_type = ctrl->value;\n\t\tparams->video_encoding =\n\t\t    (params->stream_type == V4L2_MPEG_STREAM_TYPE_MPEG1_SS ||\n\t\t     params->stream_type == V4L2_MPEG_STREAM_TYPE_MPEG1_VCD) ?\n\t\t\tV4L2_MPEG_VIDEO_ENCODING_MPEG_1 :\n\t\t\tV4L2_MPEG_VIDEO_ENCODING_MPEG_2;\n\t\tif (params->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1)\n\t\t\t \n\t\t\tparams->video_bitrate_mode =\n\t\t\t\tV4L2_MPEG_VIDEO_BITRATE_MODE_CBR;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_STREAM_VBI_FMT:\n\t\tparams->stream_vbi_fmt = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\n\t\tparams->video_spatial_filter_mode = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\n\t\tparams->video_spatial_filter = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\n\t\tparams->video_luma_spatial_filter_type = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\n\t\tparams->video_chroma_spatial_filter_type = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\n\t\tparams->video_temporal_filter_mode = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\n\t\tparams->video_temporal_filter = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\n\t\tparams->video_median_filter_type = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\n\t\tparams->video_luma_median_filter_top = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\n\t\tparams->video_luma_median_filter_bottom = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\n\t\tparams->video_chroma_median_filter_top = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\n\t\tparams->video_chroma_median_filter_bottom = ctrl->value;\n\t\tbreak;\n\tcase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\n\t\tparams->stream_insert_nav_packets = ctrl->value;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic int cx2341x_ctrl_query_fill(struct v4l2_queryctrl *qctrl,\n\t\t\t\t   s32 min, s32 max, s32 step, s32 def)\n{\n\tconst char *name;\n\n\tswitch (qctrl->id) {\n\t \n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\n\tcase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\n\t\tcx2341x_ctrl_fill(qctrl->id, &name, &qctrl->type,\n\t\t\t\t&min, &max, &step, &def, &qctrl->flags);\n\t\tqctrl->minimum = min;\n\t\tqctrl->maximum = max;\n\t\tqctrl->step = step;\n\t\tqctrl->default_value = def;\n\t\tqctrl->reserved[0] = qctrl->reserved[1] = 0;\n\t\tstrscpy(qctrl->name, name, sizeof(qctrl->name));\n\t\treturn 0;\n\n\tdefault:\n\t\treturn v4l2_ctrl_query_fill(qctrl, min, max, step, def);\n\t}\n}\n\nint cx2341x_ctrl_query(const struct cx2341x_mpeg_params *params,\n\t\t       struct v4l2_queryctrl *qctrl)\n{\n\tint err;\n\n\tswitch (qctrl->id) {\n\tcase V4L2_CID_CODEC_CLASS:\n\t\treturn v4l2_ctrl_query_fill(qctrl, 0, 0, 0, 0);\n\tcase V4L2_CID_MPEG_STREAM_TYPE:\n\t\treturn v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_STREAM_TYPE_MPEG2_PS,\n\t\t\t\tV4L2_MPEG_STREAM_TYPE_MPEG2_SVCD, 1,\n\t\t\t\tV4L2_MPEG_STREAM_TYPE_MPEG2_PS);\n\n\tcase V4L2_CID_MPEG_STREAM_VBI_FMT:\n\t\tif (params->capabilities & CX2341X_CAP_HAS_SLICED_VBI)\n\t\t\treturn v4l2_ctrl_query_fill(qctrl,\n\t\t\t\t\tV4L2_MPEG_STREAM_VBI_FMT_NONE,\n\t\t\t\t\tV4L2_MPEG_STREAM_VBI_FMT_IVTV, 1,\n\t\t\t\t\tV4L2_MPEG_STREAM_VBI_FMT_NONE);\n\t\treturn cx2341x_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_STREAM_VBI_FMT_NONE,\n\t\t\t\tV4L2_MPEG_STREAM_VBI_FMT_NONE, 1,\n\t\t\t\tdefault_params.stream_vbi_fmt);\n\n\tcase V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ:\n\t\treturn v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_AUDIO_SAMPLING_FREQ_44100,\n\t\t\t\tV4L2_MPEG_AUDIO_SAMPLING_FREQ_32000, 1,\n\t\t\t\tV4L2_MPEG_AUDIO_SAMPLING_FREQ_48000);\n\n\tcase V4L2_CID_MPEG_AUDIO_ENCODING:\n\t\tif (params->capabilities & CX2341X_CAP_HAS_AC3) {\n\t\t\t \n\t\t\treturn v4l2_ctrl_query_fill(qctrl,\n\t\t\t\t\tV4L2_MPEG_AUDIO_ENCODING_LAYER_2,\n\t\t\t\t\tV4L2_MPEG_AUDIO_ENCODING_AC3, 1,\n\t\t\t\t\tdefault_params.audio_encoding);\n\t\t}\n\n\t\treturn v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_AUDIO_ENCODING_LAYER_2,\n\t\t\t\tV4L2_MPEG_AUDIO_ENCODING_LAYER_2, 1,\n\t\t\t\tdefault_params.audio_encoding);\n\n\tcase V4L2_CID_MPEG_AUDIO_L2_BITRATE:\n\t\terr = v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_AUDIO_L2_BITRATE_192K,\n\t\t\t\tV4L2_MPEG_AUDIO_L2_BITRATE_384K, 1,\n\t\t\t\tdefault_params.audio_l2_bitrate);\n\t\tif (err)\n\t\t\treturn err;\n\t\tif (params->capabilities & CX2341X_CAP_HAS_AC3 &&\n\t\t    params->audio_encoding != V4L2_MPEG_AUDIO_ENCODING_LAYER_2)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_AUDIO_MODE:\n\t\treturn v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_AUDIO_MODE_STEREO,\n\t\t\t\tV4L2_MPEG_AUDIO_MODE_MONO, 1,\n\t\t\t\tV4L2_MPEG_AUDIO_MODE_STEREO);\n\n\tcase V4L2_CID_MPEG_AUDIO_MODE_EXTENSION:\n\t\terr = v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_4,\n\t\t\t\tV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_16, 1,\n\t\t\t\tV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_4);\n\t\tif (err == 0 &&\n\t\t    params->audio_mode != V4L2_MPEG_AUDIO_MODE_JOINT_STEREO)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn err;\n\n\tcase V4L2_CID_MPEG_AUDIO_EMPHASIS:\n\t\treturn v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_AUDIO_EMPHASIS_NONE,\n\t\t\t\tV4L2_MPEG_AUDIO_EMPHASIS_CCITT_J17, 1,\n\t\t\t\tV4L2_MPEG_AUDIO_EMPHASIS_NONE);\n\n\tcase V4L2_CID_MPEG_AUDIO_CRC:\n\t\treturn v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_AUDIO_CRC_NONE,\n\t\t\t\tV4L2_MPEG_AUDIO_CRC_CRC16, 1,\n\t\t\t\tV4L2_MPEG_AUDIO_CRC_NONE);\n\n\tcase V4L2_CID_MPEG_AUDIO_MUTE:\n\t\treturn v4l2_ctrl_query_fill(qctrl, 0, 1, 1, 0);\n\n\tcase V4L2_CID_MPEG_AUDIO_AC3_BITRATE:\n\t\terr = v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_AUDIO_AC3_BITRATE_48K,\n\t\t\t\tV4L2_MPEG_AUDIO_AC3_BITRATE_448K, 1,\n\t\t\t\tdefault_params.audio_ac3_bitrate);\n\t\tif (err)\n\t\t\treturn err;\n\t\tif (params->capabilities & CX2341X_CAP_HAS_AC3) {\n\t\t\tif (params->audio_encoding !=\n\t\t\t\t\t\t   V4L2_MPEG_AUDIO_ENCODING_AC3)\n\t\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\t} else\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_DISABLED;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_VIDEO_ENCODING:\n\t\t \n\t\terr = v4l2_ctrl_query_fill(qctrl,\n\t\t\t\t\t   V4L2_MPEG_VIDEO_ENCODING_MPEG_1,\n\t\t\t\t\t   V4L2_MPEG_VIDEO_ENCODING_MPEG_2, 1,\n\t\t\t\t\t   V4L2_MPEG_VIDEO_ENCODING_MPEG_2);\n\t\tif (err == 0)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_READ_ONLY;\n\t\treturn err;\n\n\tcase V4L2_CID_MPEG_VIDEO_ASPECT:\n\t\treturn v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_VIDEO_ASPECT_1x1,\n\t\t\t\tV4L2_MPEG_VIDEO_ASPECT_221x100, 1,\n\t\t\t\tV4L2_MPEG_VIDEO_ASPECT_4x3);\n\n\tcase V4L2_CID_MPEG_VIDEO_B_FRAMES:\n\t\treturn v4l2_ctrl_query_fill(qctrl, 0, 33, 1, 2);\n\n\tcase V4L2_CID_MPEG_VIDEO_GOP_SIZE:\n\t\treturn v4l2_ctrl_query_fill(qctrl, 1, 34, 1,\n\t\t\t\tparams->is_50hz ? 12 : 15);\n\n\tcase V4L2_CID_MPEG_VIDEO_GOP_CLOSURE:\n\t\treturn v4l2_ctrl_query_fill(qctrl, 0, 1, 1, 1);\n\n\tcase V4L2_CID_MPEG_VIDEO_BITRATE_MODE:\n\t\terr = v4l2_ctrl_query_fill(qctrl,\n\t\t\t\tV4L2_MPEG_VIDEO_BITRATE_MODE_VBR,\n\t\t\t\tV4L2_MPEG_VIDEO_BITRATE_MODE_CBR, 1,\n\t\t\t\tV4L2_MPEG_VIDEO_BITRATE_MODE_VBR);\n\t\tif (err == 0 &&\n\t\t    params->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn err;\n\n\tcase V4L2_CID_MPEG_VIDEO_BITRATE:\n\t\treturn v4l2_ctrl_query_fill(qctrl, 0, 27000000, 1, 6000000);\n\n\tcase V4L2_CID_MPEG_VIDEO_BITRATE_PEAK:\n\t\terr = v4l2_ctrl_query_fill(qctrl, 0, 27000000, 1, 8000000);\n\t\tif (err == 0 &&\n\t\t    params->video_bitrate_mode ==\n\t\t\t\tV4L2_MPEG_VIDEO_BITRATE_MODE_CBR)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn err;\n\n\tcase V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION:\n\t\treturn v4l2_ctrl_query_fill(qctrl, 0, 255, 1, 0);\n\n\tcase V4L2_CID_MPEG_VIDEO_MUTE:\n\t\treturn v4l2_ctrl_query_fill(qctrl, 0, 1, 1, 0);\n\n\tcase V4L2_CID_MPEG_VIDEO_MUTE_YUV:   \n\t\treturn v4l2_ctrl_query_fill(qctrl, 0, 0xffffff, 1, 0x008080);\n\n\t \n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\n\t\treturn cx2341x_ctrl_query_fill(qctrl,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_MANUAL,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO, 1,\n\t\t\tdefault_params.video_spatial_filter_mode);\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\n\t\tcx2341x_ctrl_query_fill(qctrl, 0, 15, 1,\n\t\t\t\tdefault_params.video_spatial_filter);\n\t\tqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\n\t\tif (params->video_spatial_filter_mode ==\n\t\t\t    V4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\n\t\tcx2341x_ctrl_query_fill(qctrl,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_OFF,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_2D_SYM_NON_SEPARABLE,\n\t\t\t1,\n\t\t\tdefault_params.video_luma_spatial_filter_type);\n\t\tif (params->video_spatial_filter_mode ==\n\t\t\t    V4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\n\t\tcx2341x_ctrl_query_fill(qctrl,\n\t\t    V4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_OFF,\n\t\t    V4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_1D_HOR,\n\t\t    1,\n\t\t    default_params.video_chroma_spatial_filter_type);\n\t\tif (params->video_spatial_filter_mode ==\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\n\t\treturn cx2341x_ctrl_query_fill(qctrl,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_MANUAL,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_AUTO, 1,\n\t\t\tdefault_params.video_temporal_filter_mode);\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER:\n\t\tcx2341x_ctrl_query_fill(qctrl, 0, 31, 1,\n\t\t\t\tdefault_params.video_temporal_filter);\n\t\tqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\n\t\tif (params->video_temporal_filter_mode ==\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_AUTO)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\n\t\treturn cx2341x_ctrl_query_fill(qctrl,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_DIAG, 1,\n\t\t\tdefault_params.video_median_filter_type);\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\n\t\tcx2341x_ctrl_query_fill(qctrl, 0, 255, 1,\n\t\t\t\tdefault_params.video_luma_median_filter_top);\n\t\tqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\n\t\tif (params->video_median_filter_type ==\n\t\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM:\n\t\tcx2341x_ctrl_query_fill(qctrl, 0, 255, 1,\n\t\t\t\tdefault_params.video_luma_median_filter_bottom);\n\t\tqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\n\t\tif (params->video_median_filter_type ==\n\t\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP:\n\t\tcx2341x_ctrl_query_fill(qctrl, 0, 255, 1,\n\t\t\t\tdefault_params.video_chroma_median_filter_top);\n\t\tqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\n\t\tif (params->video_median_filter_type ==\n\t\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM:\n\t\tcx2341x_ctrl_query_fill(qctrl, 0, 255, 1,\n\t\t\tdefault_params.video_chroma_median_filter_bottom);\n\t\tqctrl->flags |= V4L2_CTRL_FLAG_SLIDER;\n\t\tif (params->video_median_filter_type ==\n\t\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF)\n\t\t\tqctrl->flags |= V4L2_CTRL_FLAG_INACTIVE;\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\n\t\treturn cx2341x_ctrl_query_fill(qctrl, 0, 1, 1,\n\t\t\t\tdefault_params.stream_insert_nav_packets);\n\n\tdefault:\n\t\treturn -EINVAL;\n\n\t}\n}\nEXPORT_SYMBOL(cx2341x_ctrl_query);\n\nconst char * const *cx2341x_ctrl_get_menu(const struct cx2341x_mpeg_params *p, u32 id)\n{\n\tstatic const char * const mpeg_stream_type_without_ts[] = {\n\t\t\"MPEG-2 Program Stream\",\n\t\t\"\",\n\t\t\"MPEG-1 System Stream\",\n\t\t\"MPEG-2 DVD-compatible Stream\",\n\t\t\"MPEG-1 VCD-compatible Stream\",\n\t\t\"MPEG-2 SVCD-compatible Stream\",\n\t\tNULL\n\t};\n\n\tstatic const char *mpeg_stream_type_with_ts[] = {\n\t\t\"MPEG-2 Program Stream\",\n\t\t\"MPEG-2 Transport Stream\",\n\t\t\"MPEG-1 System Stream\",\n\t\t\"MPEG-2 DVD-compatible Stream\",\n\t\t\"MPEG-1 VCD-compatible Stream\",\n\t\t\"MPEG-2 SVCD-compatible Stream\",\n\t\tNULL\n\t};\n\n\tstatic const char *mpeg_audio_encoding_l2_ac3[] = {\n\t\t\"\",\n\t\t\"MPEG-1/2 Layer II\",\n\t\t\"\",\n\t\t\"\",\n\t\t\"AC-3\",\n\t\tNULL\n\t};\n\n\tswitch (id) {\n\tcase V4L2_CID_MPEG_STREAM_TYPE:\n\t\treturn (p->capabilities & CX2341X_CAP_HAS_TS) ?\n\t\t\tmpeg_stream_type_with_ts : mpeg_stream_type_without_ts;\n\tcase V4L2_CID_MPEG_AUDIO_ENCODING:\n\t\treturn (p->capabilities & CX2341X_CAP_HAS_AC3) ?\n\t\t\tmpeg_audio_encoding_l2_ac3 : v4l2_ctrl_get_menu(id);\n\tcase V4L2_CID_MPEG_AUDIO_L1_BITRATE:\n\tcase V4L2_CID_MPEG_AUDIO_L3_BITRATE:\n\t\treturn NULL;\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE:\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE:\n\t\treturn cx2341x_get_menu(id);\n\tdefault:\n\t\treturn v4l2_ctrl_get_menu(id);\n\t}\n}\nEXPORT_SYMBOL(cx2341x_ctrl_get_menu);\n\nstatic void cx2341x_calc_audio_properties(struct cx2341x_mpeg_params *params)\n{\n\tparams->audio_properties =\n\t\t(params->audio_sampling_freq << 0) |\n\t\t(params->audio_mode << 8) |\n\t\t(params->audio_mode_extension << 10) |\n\t\t(((params->audio_emphasis == V4L2_MPEG_AUDIO_EMPHASIS_CCITT_J17)\n\t\t  ? 3 : params->audio_emphasis) << 12) |\n\t\t(params->audio_crc << 14);\n\n\tif ((params->capabilities & CX2341X_CAP_HAS_AC3) &&\n\t    params->audio_encoding == V4L2_MPEG_AUDIO_ENCODING_AC3) {\n\t\tparams->audio_properties |=\n\t\t\t \n\t\t\t((3 - V4L2_MPEG_AUDIO_ENCODING_LAYER_2) << 2) |\n\t\t\t(params->audio_ac3_bitrate << 4) |\n\t\t\t(CX2341X_AUDIO_ENCODING_METHOD_AC3 << 28);\n\t} else {\n\t\t \n\t\tparams->audio_properties |=\n\t\t\t((3 - params->audio_encoding) << 2) |\n\t\t\t((1 + params->audio_l2_bitrate) << 4);\n\t}\n}\n\n \nstatic int v4l2_ctrl_check(struct v4l2_ext_control *ctrl, struct v4l2_queryctrl *qctrl,\n\t\tconst char * const *menu_items)\n{\n\tif (qctrl->flags & V4L2_CTRL_FLAG_DISABLED)\n\t\treturn -EINVAL;\n\tif (qctrl->flags & V4L2_CTRL_FLAG_GRABBED)\n\t\treturn -EBUSY;\n\tif (qctrl->type == V4L2_CTRL_TYPE_STRING)\n\t\treturn 0;\n\tif (qctrl->type == V4L2_CTRL_TYPE_BUTTON ||\n\t    qctrl->type == V4L2_CTRL_TYPE_INTEGER64 ||\n\t    qctrl->type == V4L2_CTRL_TYPE_CTRL_CLASS)\n\t\treturn 0;\n\tif (ctrl->value < qctrl->minimum || ctrl->value > qctrl->maximum)\n\t\treturn -ERANGE;\n\tif (qctrl->type == V4L2_CTRL_TYPE_MENU && menu_items != NULL) {\n\t\tif (menu_items[ctrl->value] == NULL ||\n\t\t    menu_items[ctrl->value][0] == '\\0')\n\t\t\treturn -EINVAL;\n\t}\n\tif (qctrl->type == V4L2_CTRL_TYPE_BITMASK &&\n\t\t\t(ctrl->value & ~qctrl->maximum))\n\t\treturn -ERANGE;\n\treturn 0;\n}\n\nint cx2341x_ext_ctrls(struct cx2341x_mpeg_params *params, int busy,\n\t\t  struct v4l2_ext_controls *ctrls, unsigned int cmd)\n{\n\tint err = 0;\n\tint i;\n\n\tif (cmd == VIDIOC_G_EXT_CTRLS) {\n\t\tfor (i = 0; i < ctrls->count; i++) {\n\t\t\tstruct v4l2_ext_control *ctrl = ctrls->controls + i;\n\n\t\t\terr = cx2341x_get_ctrl(params, ctrl);\n\t\t\tif (err) {\n\t\t\t\tctrls->error_idx = i;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn err;\n\t}\n\tfor (i = 0; i < ctrls->count; i++) {\n\t\tstruct v4l2_ext_control *ctrl = ctrls->controls + i;\n\t\tstruct v4l2_queryctrl qctrl;\n\t\tconst char * const *menu_items = NULL;\n\n\t\tqctrl.id = ctrl->id;\n\t\terr = cx2341x_ctrl_query(params, &qctrl);\n\t\tif (err)\n\t\t\tbreak;\n\t\tif (qctrl.type == V4L2_CTRL_TYPE_MENU)\n\t\t\tmenu_items = cx2341x_ctrl_get_menu(params, qctrl.id);\n\t\terr = v4l2_ctrl_check(ctrl, &qctrl, menu_items);\n\t\tif (err)\n\t\t\tbreak;\n\t\terr = cx2341x_set_ctrl(params, busy, ctrl);\n\t\tif (err)\n\t\t\tbreak;\n\t}\n\tif (err == 0 &&\n\t    params->video_bitrate_mode == V4L2_MPEG_VIDEO_BITRATE_MODE_VBR &&\n\t    params->video_bitrate_peak < params->video_bitrate) {\n\t\terr = -ERANGE;\n\t\tctrls->error_idx = ctrls->count;\n\t}\n\tif (err)\n\t\tctrls->error_idx = i;\n\telse\n\t\tcx2341x_calc_audio_properties(params);\n\treturn err;\n}\nEXPORT_SYMBOL(cx2341x_ext_ctrls);\n\nvoid cx2341x_fill_defaults(struct cx2341x_mpeg_params *p)\n{\n\t*p = default_params;\n\tcx2341x_calc_audio_properties(p);\n}\nEXPORT_SYMBOL(cx2341x_fill_defaults);\n\nstatic int cx2341x_api(void *priv, cx2341x_mbox_func func,\n\t\t       u32 cmd, int args, ...)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tva_list vargs;\n\tint i;\n\n\tva_start(vargs, args);\n\n\tfor (i = 0; i < args; i++)\n\t\tdata[i] = va_arg(vargs, int);\n\tva_end(vargs);\n\treturn func(priv, cmd, args, 0, data);\n}\n\n#define CMP_FIELD(__old, __new, __field) (__old->__field != __new->__field)\n\nint cx2341x_update(void *priv, cx2341x_mbox_func func,\n\t\t   const struct cx2341x_mpeg_params *old,\n\t\t   const struct cx2341x_mpeg_params *new)\n{\n\tstatic int mpeg_stream_type[] = {\n\t\t0,\t \n\t\t1,\t \n\t\t2,\t \n\t\t14,\t \n\t\t11,\t \n\t\t12,\t \n\t};\n\tint err;\n\n\tcx2341x_api(priv, func, CX2341X_ENC_SET_OUTPUT_PORT, 2, new->port, 0);\n\n\tif (!old ||\n\t    CMP_FIELD(old, new, is_50hz)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_FRAME_RATE, 1,\n\t\t\t\t  new->is_50hz);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tif (!old ||\n\t    CMP_FIELD(old, new, width) ||\n\t    CMP_FIELD(old, new, height) ||\n\t    CMP_FIELD(old, new, video_encoding)) {\n\t\tu16 w = new->width;\n\t\tu16 h = new->height;\n\n\t\tif (new->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1) {\n\t\t\tw /= 2;\n\t\t\th /= 2;\n\t\t}\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_FRAME_SIZE, 2,\n\t\t\t\t  h, w);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, stream_type)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_STREAM_TYPE, 1,\n\t\t\t\t  mpeg_stream_type[new->stream_type]);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_aspect)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_ASPECT_RATIO, 1,\n\t\t\t\t  1 + new->video_aspect);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_b_frames) ||\n\t    CMP_FIELD(old, new, video_gop_size)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_GOP_PROPERTIES, 2,\n\t\t\t\t  new->video_gop_size, new->video_b_frames + 1);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_gop_closure)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_GOP_CLOSURE, 1,\n\t\t\t\t  new->video_gop_closure);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, audio_properties)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_AUDIO_PROPERTIES,\n\t\t\t\t  1, new->audio_properties);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, audio_mute)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_MUTE_AUDIO, 1,\n\t\t\t\t  new->audio_mute);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_bitrate_mode) ||\n\t    CMP_FIELD(old, new, video_bitrate) ||\n\t    CMP_FIELD(old, new, video_bitrate_peak)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_BIT_RATE, 5,\n\t\t\t\t  new->video_bitrate_mode, new->video_bitrate,\n\t\t\t\t  new->video_bitrate_peak / 400, 0, 0);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_spatial_filter_mode) ||\n\t    CMP_FIELD(old, new, video_temporal_filter_mode) ||\n\t    CMP_FIELD(old, new, video_median_filter_type)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_DNR_FILTER_MODE,\n\t\t\t\t  2,\n\t\t\t\t  new->video_spatial_filter_mode |\n\t\t\t\t\t(new->video_temporal_filter_mode << 1),\n\t\t\t\t  new->video_median_filter_type);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_luma_median_filter_bottom) ||\n\t    CMP_FIELD(old, new, video_luma_median_filter_top) ||\n\t    CMP_FIELD(old, new, video_chroma_median_filter_bottom) ||\n\t    CMP_FIELD(old, new, video_chroma_median_filter_top)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_CORING_LEVELS, 4,\n\t\t\t\t  new->video_luma_median_filter_bottom,\n\t\t\t\t  new->video_luma_median_filter_top,\n\t\t\t\t  new->video_chroma_median_filter_bottom,\n\t\t\t\t  new->video_chroma_median_filter_top);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_luma_spatial_filter_type) ||\n\t    CMP_FIELD(old, new, video_chroma_spatial_filter_type)) {\n\t\terr = cx2341x_api(priv, func,\n\t\t\t\t  CX2341X_ENC_SET_SPATIAL_FILTER_TYPE,\n\t\t\t\t  2, new->video_luma_spatial_filter_type,\n\t\t\t\t  new->video_chroma_spatial_filter_type);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_spatial_filter) ||\n\t    CMP_FIELD(old, new, video_temporal_filter)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_DNR_FILTER_PROPS,\n\t\t\t\t  2, new->video_spatial_filter,\n\t\t\t\t  new->video_temporal_filter);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_temporal_decimation)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_SET_FRAME_DROP_RATE,\n\t\t\t\t  1, new->video_temporal_decimation);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, video_mute) ||\n\t    (new->video_mute && CMP_FIELD(old, new, video_mute_yuv))) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_MUTE_VIDEO, 1,\n\t\t\t\t  new->video_mute | (new->video_mute_yuv << 8));\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tif (!old ||\n\t    CMP_FIELD(old, new, stream_insert_nav_packets)) {\n\t\terr = cx2341x_api(priv, func, CX2341X_ENC_MISC, 2,\n\t\t\t\t  7, new->stream_insert_nav_packets);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL(cx2341x_update);\n\nstatic const char *cx2341x_menu_item(const struct cx2341x_mpeg_params *p, u32 id)\n{\n\tconst char * const *menu = cx2341x_ctrl_get_menu(p, id);\n\tstruct v4l2_ext_control ctrl;\n\n\tif (menu == NULL)\n\t\tgoto invalid;\n\tctrl.id = id;\n\tif (cx2341x_get_ctrl(p, &ctrl))\n\t\tgoto invalid;\n\twhile (ctrl.value-- && *menu) menu++;\n\tif (*menu == NULL)\n\t\tgoto invalid;\n\treturn *menu;\n\ninvalid:\n\treturn \"<invalid>\";\n}\n\nvoid cx2341x_log_status(const struct cx2341x_mpeg_params *p, const char *prefix)\n{\n\tint is_mpeg1 = p->video_encoding == V4L2_MPEG_VIDEO_ENCODING_MPEG_1;\n\n\t \n\tprintk(KERN_INFO \"%s: Stream: %s\",\n\t\tprefix,\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_STREAM_TYPE));\n\tif (p->stream_insert_nav_packets)\n\t\tprintk(KERN_CONT \" (with navigation packets)\");\n\tprintk(KERN_CONT \"\\n\");\n\tprintk(KERN_INFO \"%s: VBI Format: %s\\n\",\n\t\tprefix,\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_STREAM_VBI_FMT));\n\n\t \n\tprintk(KERN_INFO \"%s: Video:  %dx%d, %d fps%s\\n\",\n\t\tprefix,\n\t\tp->width / (is_mpeg1 ? 2 : 1), p->height / (is_mpeg1 ? 2 : 1),\n\t\tp->is_50hz ? 25 : 30,\n\t\t(p->video_mute) ? \" (muted)\" : \"\");\n\tprintk(KERN_INFO \"%s: Video:  %s, %s, %s, %d\",\n\t\tprefix,\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_VIDEO_ENCODING),\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_VIDEO_ASPECT),\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_VIDEO_BITRATE_MODE),\n\t\tp->video_bitrate);\n\tif (p->video_bitrate_mode == V4L2_MPEG_VIDEO_BITRATE_MODE_VBR)\n\t\tprintk(KERN_CONT \", Peak %d\", p->video_bitrate_peak);\n\tprintk(KERN_CONT \"\\n\");\n\tprintk(KERN_INFO\n\t\t\"%s: Video:  GOP Size %d, %d B-Frames, %sGOP Closure\\n\",\n\t\tprefix,\n\t\tp->video_gop_size, p->video_b_frames,\n\t\tp->video_gop_closure ? \"\" : \"No \");\n\tif (p->video_temporal_decimation)\n\t\tprintk(KERN_INFO \"%s: Video: Temporal Decimation %d\\n\",\n\t\t\tprefix, p->video_temporal_decimation);\n\n\t \n\tprintk(KERN_INFO \"%s: Audio:  %s, %s, %s, %s%s\",\n\t\tprefix,\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ),\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_ENCODING),\n\t\tcx2341x_menu_item(p,\n\t\t\t   p->audio_encoding == V4L2_MPEG_AUDIO_ENCODING_AC3\n\t\t\t\t\t      ? V4L2_CID_MPEG_AUDIO_AC3_BITRATE\n\t\t\t\t\t      : V4L2_CID_MPEG_AUDIO_L2_BITRATE),\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_MODE),\n\t\tp->audio_mute ? \" (muted)\" : \"\");\n\tif (p->audio_mode == V4L2_MPEG_AUDIO_MODE_JOINT_STEREO)\n\t\tprintk(KERN_CONT \", %s\", cx2341x_menu_item(p,\n\t\t\t\tV4L2_CID_MPEG_AUDIO_MODE_EXTENSION));\n\tprintk(KERN_CONT \", %s, %s\\n\",\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_EMPHASIS),\n\t\tcx2341x_menu_item(p, V4L2_CID_MPEG_AUDIO_CRC));\n\n\t \n\tprintk(KERN_INFO \"%s: Spatial Filter:  %s, Luma %s, Chroma %s, %d\\n\",\n\t\tprefix,\n\t\tcx2341x_menu_item(p,\n\t\t    V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE),\n\t\tcx2341x_menu_item(p,\n\t\t    V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE),\n\t\tcx2341x_menu_item(p,\n\t\t    V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE),\n\t\tp->video_spatial_filter);\n\n\tprintk(KERN_INFO \"%s: Temporal Filter: %s, %d\\n\",\n\t\tprefix,\n\t\tcx2341x_menu_item(p,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE),\n\t\tp->video_temporal_filter);\n\tprintk(KERN_INFO\n\t\t\"%s: Median Filter:   %s, Luma [%d, %d], Chroma [%d, %d]\\n\",\n\t\tprefix,\n\t\tcx2341x_menu_item(p,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE),\n\t\tp->video_luma_median_filter_bottom,\n\t\tp->video_luma_median_filter_top,\n\t\tp->video_chroma_median_filter_bottom,\n\t\tp->video_chroma_median_filter_top);\n}\nEXPORT_SYMBOL(cx2341x_log_status);\n\n\n\n \n\nstatic inline struct cx2341x_handler *to_cxhdl(struct v4l2_ctrl *ctrl)\n{\n\treturn container_of(ctrl->handler, struct cx2341x_handler, hdl);\n}\n\nstatic int cx2341x_hdl_api(struct cx2341x_handler *hdl,\n\t\t       u32 cmd, int args, ...)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tva_list vargs;\n\tint i;\n\n\tva_start(vargs, args);\n\n\tfor (i = 0; i < args; i++)\n\t\tdata[i] = va_arg(vargs, int);\n\tva_end(vargs);\n\treturn hdl->func(hdl->priv, cmd, args, 0, data);\n}\n\n \nstatic inline int cx2341x_neq(struct v4l2_ctrl *ctrl)\n{\n\treturn ctrl && ctrl->val != ctrl->cur.val;\n}\n\nstatic int cx2341x_try_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct cx2341x_handler *hdl = to_cxhdl(ctrl);\n\ts32 val = ctrl->val;\n\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_MPEG_VIDEO_B_FRAMES: {\n\t\t \n\t\tint b = val + 1;\n\t\tint gop = hdl->video_gop_size->val;\n\n\t\tgop = b * ((gop + b - 1) / b);\n\n\t\t \n\t\twhile (gop > 34)\n\t\t\tgop -= b;\n\t\thdl->video_gop_size->val = gop;\n\t\tbreak;\n\t}\n\n\tcase V4L2_CID_MPEG_STREAM_TYPE:\n\t\t \n\t\thdl->video_encoding->val =\n\t\t    (hdl->stream_type->val == V4L2_MPEG_STREAM_TYPE_MPEG1_SS ||\n\t\t     hdl->stream_type->val == V4L2_MPEG_STREAM_TYPE_MPEG1_VCD) ?\n\t\t\tV4L2_MPEG_VIDEO_ENCODING_MPEG_1 :\n\t\t\tV4L2_MPEG_VIDEO_ENCODING_MPEG_2;\n\t\tif (hdl->video_encoding->val == V4L2_MPEG_VIDEO_ENCODING_MPEG_1)\n\t\t\t \n\t\t\thdl->video_bitrate_mode->val =\n\t\t\t\tV4L2_MPEG_VIDEO_BITRATE_MODE_CBR;\n\t\t \n\t\tif (hdl->video_bitrate_mode->val == V4L2_MPEG_VIDEO_BITRATE_MODE_VBR &&\n\t\t    hdl->video_bitrate_peak->val < hdl->video_bitrate->val)\n\t\t\thdl->video_bitrate_peak->val = hdl->video_bitrate->val;\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int cx2341x_s_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstatic const int mpeg_stream_type[] = {\n\t\t0,\t \n\t\t1,\t \n\t\t2,\t \n\t\t14,\t \n\t\t11,\t \n\t\t12,\t \n\t};\n\tstruct cx2341x_handler *hdl = to_cxhdl(ctrl);\n\ts32 val = ctrl->val;\n\tu32 props;\n\tint err;\n\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_MPEG_STREAM_VBI_FMT:\n\t\tif (hdl->ops && hdl->ops->s_stream_vbi_fmt)\n\t\t\treturn hdl->ops->s_stream_vbi_fmt(hdl, val);\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_VIDEO_ASPECT:\n\t\treturn cx2341x_hdl_api(hdl,\n\t\t\tCX2341X_ENC_SET_ASPECT_RATIO, 1, val + 1);\n\n\tcase V4L2_CID_MPEG_VIDEO_GOP_CLOSURE:\n\t\treturn cx2341x_hdl_api(hdl, CX2341X_ENC_SET_GOP_CLOSURE, 1, val);\n\n\tcase V4L2_CID_MPEG_AUDIO_MUTE:\n\t\treturn cx2341x_hdl_api(hdl, CX2341X_ENC_MUTE_AUDIO, 1, val);\n\n\tcase V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION:\n\t\treturn cx2341x_hdl_api(hdl,\n\t\t\tCX2341X_ENC_SET_FRAME_DROP_RATE, 1, val);\n\n\tcase V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS:\n\t\treturn cx2341x_hdl_api(hdl, CX2341X_ENC_MISC, 2, 7, val);\n\n\tcase V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ:\n\t\t \n\t\tprops = (hdl->audio_sampling_freq->val << 0) |\n\t\t\t(hdl->audio_mode->val << 8) |\n\t\t\t(hdl->audio_mode_extension->val << 10) |\n\t\t\t(hdl->audio_crc->val << 14);\n\t\tif (hdl->audio_emphasis->val == V4L2_MPEG_AUDIO_EMPHASIS_CCITT_J17)\n\t\t\tprops |= 3 << 12;\n\t\telse\n\t\t\tprops |= hdl->audio_emphasis->val << 12;\n\n\t\tif (hdl->audio_encoding->val == V4L2_MPEG_AUDIO_ENCODING_AC3) {\n\t\t\tprops |=\n#if 1\n\t\t\t\t \n\t\t\t\t((3 - V4L2_MPEG_AUDIO_ENCODING_LAYER_2) << 2) |\n#endif\n\t\t\t\t(hdl->audio_ac3_bitrate->val << 4) |\n\t\t\t\t(CX2341X_AUDIO_ENCODING_METHOD_AC3 << 28);\n\t\t} else {\n\t\t\t \n\t\t\tprops |=\n\t\t\t\t((3 - hdl->audio_encoding->val) << 2) |\n\t\t\t\t((1 + hdl->audio_l2_bitrate->val) << 4);\n\t\t}\n\t\terr = cx2341x_hdl_api(hdl,\n\t\t\t\tCX2341X_ENC_SET_AUDIO_PROPERTIES, 1, props);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\thdl->audio_properties = props;\n\t\tif (hdl->audio_ac3_bitrate) {\n\t\t\tint is_ac3 = hdl->audio_encoding->val ==\n\t\t\t\t\t\tV4L2_MPEG_AUDIO_ENCODING_AC3;\n\n\t\t\tv4l2_ctrl_activate(hdl->audio_ac3_bitrate, is_ac3);\n\t\t\tv4l2_ctrl_activate(hdl->audio_l2_bitrate, !is_ac3);\n\t\t}\n\t\tv4l2_ctrl_activate(hdl->audio_mode_extension,\n\t\t\thdl->audio_mode->val == V4L2_MPEG_AUDIO_MODE_JOINT_STEREO);\n\t\tif (cx2341x_neq(hdl->audio_sampling_freq) &&\n\t\t    hdl->ops && hdl->ops->s_audio_sampling_freq)\n\t\t\treturn hdl->ops->s_audio_sampling_freq(hdl, hdl->audio_sampling_freq->val);\n\t\tif (cx2341x_neq(hdl->audio_mode) &&\n\t\t    hdl->ops && hdl->ops->s_audio_mode)\n\t\t\treturn hdl->ops->s_audio_mode(hdl, hdl->audio_mode->val);\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_VIDEO_B_FRAMES:\n\t\t \n\t\treturn cx2341x_hdl_api(hdl, CX2341X_ENC_SET_GOP_PROPERTIES, 2,\n\t\t\t\thdl->video_gop_size->val,\n\t\t\t\thdl->video_b_frames->val + 1);\n\n\tcase V4L2_CID_MPEG_STREAM_TYPE:\n\t\t \n\t\terr = cx2341x_hdl_api(hdl,\n\t\t\tCX2341X_ENC_SET_STREAM_TYPE, 1, mpeg_stream_type[val]);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = cx2341x_hdl_api(hdl, CX2341X_ENC_SET_BIT_RATE, 5,\n\t\t\t\thdl->video_bitrate_mode->val,\n\t\t\t\thdl->video_bitrate->val,\n\t\t\t\thdl->video_bitrate_peak->val / 400, 0, 0);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tv4l2_ctrl_activate(hdl->video_bitrate_mode,\n\t\t\thdl->video_encoding->val != V4L2_MPEG_VIDEO_ENCODING_MPEG_1);\n\t\tv4l2_ctrl_activate(hdl->video_bitrate_peak,\n\t\t\thdl->video_bitrate_mode->val != V4L2_MPEG_VIDEO_BITRATE_MODE_CBR);\n\t\tif (cx2341x_neq(hdl->video_encoding) &&\n\t\t    hdl->ops && hdl->ops->s_video_encoding)\n\t\t\treturn hdl->ops->s_video_encoding(hdl, hdl->video_encoding->val);\n\t\treturn 0;\n\n\tcase V4L2_CID_MPEG_VIDEO_MUTE:\n\t\t \n\t\treturn cx2341x_hdl_api(hdl, CX2341X_ENC_MUTE_VIDEO, 1,\n\t\t\t\thdl->video_mute->val |\n\t\t\t\t\t(hdl->video_mute_yuv->val << 8));\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE: {\n\t\tint active_filter;\n\n\t\t \n\t\terr = cx2341x_hdl_api(hdl, CX2341X_ENC_SET_DNR_FILTER_MODE, 2,\n\t\t\t\thdl->video_spatial_filter_mode->val |\n\t\t\t\t\t(hdl->video_temporal_filter_mode->val << 1),\n\t\t\t\thdl->video_median_filter_type->val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tactive_filter = hdl->video_spatial_filter_mode->val !=\n\t\t\t\tV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO;\n\t\tv4l2_ctrl_activate(hdl->video_spatial_filter, active_filter);\n\t\tv4l2_ctrl_activate(hdl->video_luma_spatial_filter_type, active_filter);\n\t\tv4l2_ctrl_activate(hdl->video_chroma_spatial_filter_type, active_filter);\n\t\tactive_filter = hdl->video_temporal_filter_mode->val !=\n\t\t\t\tV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_AUTO;\n\t\tv4l2_ctrl_activate(hdl->video_temporal_filter, active_filter);\n\t\tactive_filter = hdl->video_median_filter_type->val !=\n\t\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF;\n\t\tv4l2_ctrl_activate(hdl->video_luma_median_filter_bottom, active_filter);\n\t\tv4l2_ctrl_activate(hdl->video_luma_median_filter_top, active_filter);\n\t\tv4l2_ctrl_activate(hdl->video_chroma_median_filter_bottom, active_filter);\n\t\tv4l2_ctrl_activate(hdl->video_chroma_median_filter_top, active_filter);\n\t\treturn 0;\n\t}\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE:\n\t\t \n\t\treturn cx2341x_hdl_api(hdl,\n\t\t\t\tCX2341X_ENC_SET_SPATIAL_FILTER_TYPE, 2,\n\t\t\t\thdl->video_luma_spatial_filter_type->val,\n\t\t\t\thdl->video_chroma_spatial_filter_type->val);\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER:\n\t\t \n\t\treturn cx2341x_hdl_api(hdl, CX2341X_ENC_SET_DNR_FILTER_PROPS, 2,\n\t\t\t\thdl->video_spatial_filter->val,\n\t\t\t\thdl->video_temporal_filter->val);\n\n\tcase V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP:\n\t\t \n\t\treturn cx2341x_hdl_api(hdl, CX2341X_ENC_SET_CORING_LEVELS, 4,\n\t\t\t\thdl->video_luma_median_filter_bottom->val,\n\t\t\t\thdl->video_luma_median_filter_top->val,\n\t\t\t\thdl->video_chroma_median_filter_bottom->val,\n\t\t\t\thdl->video_chroma_median_filter_top->val);\n\t}\n\treturn -EINVAL;\n}\n\nstatic const struct v4l2_ctrl_ops cx2341x_ops = {\n\t.try_ctrl = cx2341x_try_ctrl,\n\t.s_ctrl = cx2341x_s_ctrl,\n};\n\nstatic struct v4l2_ctrl *cx2341x_ctrl_new_custom(struct v4l2_ctrl_handler *hdl,\n\t\t\tu32 id, s32 min, s32 max, s32 step, s32 def)\n{\n\tstruct v4l2_ctrl_config cfg;\n\n\tmemset(&cfg, 0, sizeof(cfg));\n\tcx2341x_ctrl_fill(id, &cfg.name, &cfg.type, &min, &max, &step, &def, &cfg.flags);\n\tcfg.ops = &cx2341x_ops;\n\tcfg.id = id;\n\tcfg.min = min;\n\tcfg.max = max;\n\tcfg.def = def;\n\tif (cfg.type == V4L2_CTRL_TYPE_MENU) {\n\t\tcfg.step = 0;\n\t\tcfg.menu_skip_mask = step;\n\t\tcfg.qmenu = cx2341x_get_menu(id);\n\t} else {\n\t\tcfg.step = step;\n\t\tcfg.menu_skip_mask = 0;\n\t}\n\treturn v4l2_ctrl_new_custom(hdl, &cfg, NULL);\n}\n\nstatic struct v4l2_ctrl *cx2341x_ctrl_new_std(struct v4l2_ctrl_handler *hdl,\n\t\t\tu32 id, s32 min, s32 max, s32 step, s32 def)\n{\n\treturn v4l2_ctrl_new_std(hdl, &cx2341x_ops, id, min, max, step, def);\n}\n\nstatic struct v4l2_ctrl *cx2341x_ctrl_new_menu(struct v4l2_ctrl_handler *hdl,\n\t\t\tu32 id, s32 max, s32 mask, s32 def)\n{\n\treturn v4l2_ctrl_new_std_menu(hdl, &cx2341x_ops, id, max, mask, def);\n}\n\nint cx2341x_handler_init(struct cx2341x_handler *cxhdl,\n\t\t\t unsigned nr_of_controls_hint)\n{\n\tstruct v4l2_ctrl_handler *hdl = &cxhdl->hdl;\n\tu32 caps = cxhdl->capabilities;\n\tint has_sliced_vbi = caps & CX2341X_CAP_HAS_SLICED_VBI;\n\tint has_ac3 = caps & CX2341X_CAP_HAS_AC3;\n\tint has_ts = caps & CX2341X_CAP_HAS_TS;\n\n\tcxhdl->width = 720;\n\tcxhdl->height = 480;\n\n\tv4l2_ctrl_handler_init(hdl, nr_of_controls_hint);\n\n\t \n\tcxhdl->stream_type = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_STREAM_TYPE,\n\t\t\tV4L2_MPEG_STREAM_TYPE_MPEG2_SVCD, has_ts ? 0 : 2,\n\t\t\tV4L2_MPEG_STREAM_TYPE_MPEG2_PS);\n\tcxhdl->stream_vbi_fmt = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_STREAM_VBI_FMT,\n\t\t\tV4L2_MPEG_STREAM_VBI_FMT_IVTV, has_sliced_vbi ? 0 : 2,\n\t\t\tV4L2_MPEG_STREAM_VBI_FMT_NONE);\n\tcxhdl->audio_sampling_freq = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_AUDIO_SAMPLING_FREQ,\n\t\t\tV4L2_MPEG_AUDIO_SAMPLING_FREQ_32000, 0,\n\t\t\tV4L2_MPEG_AUDIO_SAMPLING_FREQ_48000);\n\tcxhdl->audio_encoding = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_AUDIO_ENCODING,\n\t\t\tV4L2_MPEG_AUDIO_ENCODING_AC3, has_ac3 ? ~0x12 : ~0x2,\n\t\t\tV4L2_MPEG_AUDIO_ENCODING_LAYER_2);\n\tcxhdl->audio_l2_bitrate = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_AUDIO_L2_BITRATE,\n\t\t\tV4L2_MPEG_AUDIO_L2_BITRATE_384K, 0x1ff,\n\t\t\tV4L2_MPEG_AUDIO_L2_BITRATE_224K);\n\tcxhdl->audio_mode = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_AUDIO_MODE,\n\t\t\tV4L2_MPEG_AUDIO_MODE_MONO, 0,\n\t\t\tV4L2_MPEG_AUDIO_MODE_STEREO);\n\tcxhdl->audio_mode_extension = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_AUDIO_MODE_EXTENSION,\n\t\t\tV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_16, 0,\n\t\t\tV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_4);\n\tcxhdl->audio_emphasis = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_AUDIO_EMPHASIS,\n\t\t\tV4L2_MPEG_AUDIO_EMPHASIS_CCITT_J17, 0,\n\t\t\tV4L2_MPEG_AUDIO_EMPHASIS_NONE);\n\tcxhdl->audio_crc = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_AUDIO_CRC,\n\t\t\tV4L2_MPEG_AUDIO_CRC_CRC16, 0,\n\t\t\tV4L2_MPEG_AUDIO_CRC_NONE);\n\n\tcx2341x_ctrl_new_std(hdl, V4L2_CID_MPEG_AUDIO_MUTE, 0, 1, 1, 0);\n\tif (has_ac3)\n\t\tcxhdl->audio_ac3_bitrate = cx2341x_ctrl_new_menu(hdl,\n\t\t\t\tV4L2_CID_MPEG_AUDIO_AC3_BITRATE,\n\t\t\t\tV4L2_MPEG_AUDIO_AC3_BITRATE_448K, 0x03,\n\t\t\t\tV4L2_MPEG_AUDIO_AC3_BITRATE_224K);\n\tcxhdl->video_encoding = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_ENCODING,\n\t\t\tV4L2_MPEG_VIDEO_ENCODING_MPEG_2, 0,\n\t\t\tV4L2_MPEG_VIDEO_ENCODING_MPEG_2);\n\tcx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_ASPECT,\n\t\t\tV4L2_MPEG_VIDEO_ASPECT_221x100, 0,\n\t\t\tV4L2_MPEG_VIDEO_ASPECT_4x3);\n\tcxhdl->video_b_frames = cx2341x_ctrl_new_std(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_B_FRAMES, 0, 33, 1, 2);\n\tcxhdl->video_gop_size = cx2341x_ctrl_new_std(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_GOP_SIZE,\n\t\t\t1, 34, 1, cxhdl->is_50hz ? 12 : 15);\n\tcx2341x_ctrl_new_std(hdl, V4L2_CID_MPEG_VIDEO_GOP_CLOSURE, 0, 1, 1, 1);\n\tcxhdl->video_bitrate_mode = cx2341x_ctrl_new_menu(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_BITRATE_MODE,\n\t\t\tV4L2_MPEG_VIDEO_BITRATE_MODE_CBR, 0,\n\t\t\tV4L2_MPEG_VIDEO_BITRATE_MODE_VBR);\n\tcxhdl->video_bitrate = cx2341x_ctrl_new_std(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_BITRATE,\n\t\t\t0, 27000000, 1, 6000000);\n\tcxhdl->video_bitrate_peak = cx2341x_ctrl_new_std(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_BITRATE_PEAK,\n\t\t\t0, 27000000, 1, 8000000);\n\tcx2341x_ctrl_new_std(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION, 0, 255, 1, 0);\n\tcxhdl->video_mute = cx2341x_ctrl_new_std(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_MUTE, 0, 1, 1, 0);\n\tcxhdl->video_mute_yuv = cx2341x_ctrl_new_std(hdl,\n\t\t\tV4L2_CID_MPEG_VIDEO_MUTE_YUV, 0, 0xffffff, 1, 0x008080);\n\n\t \n\tcxhdl->video_spatial_filter_mode = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_MANUAL,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO, 0,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_MANUAL);\n\tcxhdl->video_spatial_filter = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER,\n\t\t\t0, 15, 1, 0);\n\tcxhdl->video_luma_spatial_filter_type = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_OFF,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_2D_SYM_NON_SEPARABLE,\n\t\t\t0,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_1D_HOR);\n\tcxhdl->video_chroma_spatial_filter_type = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_OFF,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_1D_HOR,\n\t\t\t0,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_1D_HOR);\n\tcxhdl->video_temporal_filter_mode = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_MANUAL,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_AUTO,\n\t\t\t0,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_MANUAL);\n\tcxhdl->video_temporal_filter = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER,\n\t\t\t0, 31, 1, 8);\n\tcxhdl->video_median_filter_type = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_DIAG,\n\t\t\t0,\n\t\t\tV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF);\n\tcxhdl->video_luma_median_filter_bottom = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM,\n\t\t\t0, 255, 1, 0);\n\tcxhdl->video_luma_median_filter_top = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP,\n\t\t\t0, 255, 1, 255);\n\tcxhdl->video_chroma_median_filter_bottom = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM,\n\t\t\t0, 255, 1, 0);\n\tcxhdl->video_chroma_median_filter_top = cx2341x_ctrl_new_custom(hdl,\n\t\t\tV4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP,\n\t\t\t0, 255, 1, 255);\n\tcx2341x_ctrl_new_custom(hdl, V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS,\n\t\t\t0, 1, 1, 0);\n\n\tif (hdl->error) {\n\t\tint err = hdl->error;\n\n\t\tv4l2_ctrl_handler_free(hdl);\n\t\treturn err;\n\t}\n\n\tv4l2_ctrl_cluster(8, &cxhdl->audio_sampling_freq);\n\tv4l2_ctrl_cluster(2, &cxhdl->video_b_frames);\n\tv4l2_ctrl_cluster(5, &cxhdl->stream_type);\n\tv4l2_ctrl_cluster(2, &cxhdl->video_mute);\n\tv4l2_ctrl_cluster(3, &cxhdl->video_spatial_filter_mode);\n\tv4l2_ctrl_cluster(2, &cxhdl->video_luma_spatial_filter_type);\n\tv4l2_ctrl_cluster(2, &cxhdl->video_spatial_filter);\n\tv4l2_ctrl_cluster(4, &cxhdl->video_luma_median_filter_top);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(cx2341x_handler_init);\n\nvoid cx2341x_handler_set_50hz(struct cx2341x_handler *cxhdl, int is_50hz)\n{\n\tcxhdl->is_50hz = is_50hz;\n\tcxhdl->video_gop_size->default_value = cxhdl->is_50hz ? 12 : 15;\n}\nEXPORT_SYMBOL(cx2341x_handler_set_50hz);\n\nint cx2341x_handler_setup(struct cx2341x_handler *cxhdl)\n{\n\tint h = cxhdl->height;\n\tint w = cxhdl->width;\n\tint err;\n\n\terr = cx2341x_hdl_api(cxhdl, CX2341X_ENC_SET_OUTPUT_PORT, 2, cxhdl->port, 0);\n\tif (err)\n\t\treturn err;\n\terr = cx2341x_hdl_api(cxhdl, CX2341X_ENC_SET_FRAME_RATE, 1, cxhdl->is_50hz);\n\tif (err)\n\t\treturn err;\n\n\tif (v4l2_ctrl_g_ctrl(cxhdl->video_encoding) == V4L2_MPEG_VIDEO_ENCODING_MPEG_1) {\n\t\tw /= 2;\n\t\th /= 2;\n\t}\n\terr = cx2341x_hdl_api(cxhdl, CX2341X_ENC_SET_FRAME_SIZE, 2, h, w);\n\tif (err)\n\t\treturn err;\n\treturn v4l2_ctrl_handler_setup(&cxhdl->hdl);\n}\nEXPORT_SYMBOL(cx2341x_handler_setup);\n\nvoid cx2341x_handler_set_busy(struct cx2341x_handler *cxhdl, int busy)\n{\n\tv4l2_ctrl_grab(cxhdl->audio_sampling_freq, busy);\n\tv4l2_ctrl_grab(cxhdl->audio_encoding, busy);\n\tv4l2_ctrl_grab(cxhdl->audio_l2_bitrate, busy);\n\tv4l2_ctrl_grab(cxhdl->audio_ac3_bitrate, busy);\n\tv4l2_ctrl_grab(cxhdl->stream_vbi_fmt, busy);\n\tv4l2_ctrl_grab(cxhdl->stream_type, busy);\n\tv4l2_ctrl_grab(cxhdl->video_bitrate_mode, busy);\n\tv4l2_ctrl_grab(cxhdl->video_bitrate, busy);\n\tv4l2_ctrl_grab(cxhdl->video_bitrate_peak, busy);\n}\nEXPORT_SYMBOL(cx2341x_handler_set_busy);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}