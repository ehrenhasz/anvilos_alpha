{
  "module_name": "tea5761.c",
  "hash_id": "1c3eb5ca141c7afb115f344c836e059691faee520829a79eb7559334489fbd23",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/tuners/tea5761.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/i2c.h>\n#include <linux/slab.h>\n#include <linux/delay.h>\n#include <linux/videodev2.h>\n#include <media/tuner.h>\n#include \"tuner-i2c.h\"\n#include \"tea5761.h\"\n\nstatic int debug;\nmodule_param(debug, int, 0644);\nMODULE_PARM_DESC(debug, \"enable verbose debug messages\");\n\nstruct tea5761_priv {\n\tstruct tuner_i2c_props i2c_props;\n\n\tu32 frequency;\n\tbool standby;\n};\n\n \n\n \n\n \n\n\t \n#define TEA5761_INTREG_IFFLAG\t\t0x10\n#define TEA5761_INTREG_LEVFLAG\t\t0x8\n#define TEA5761_INTREG_FRRFLAG\t\t0x2\n#define TEA5761_INTREG_BLFLAG\t\t0x1\n\n\t \n#define TEA5761_INTREG_IFMSK\t\t0x10\n#define TEA5761_INTREG_LEVMSK\t\t0x8\n#define TEA5761_INTREG_FRMSK\t\t0x2\n#define TEA5761_INTREG_BLMSK\t\t0x1\n\n \n\n\t \n#define TEA5761_FRQSET_SEARCH_UP 0x80\t\t \n#define TEA5761_FRQSET_SEARCH_MODE 0x40\t\t \n\n\t \n\n\t \n\t \n\n \n\n\t \n\n#define TEA5761_TNCTRL_PUPD_0\t0x40\t \n#define TEA5761_TNCTRL_BLIM\t0X20\t \n#define TEA5761_TNCTRL_SWPM\t0x10\t \n#define TEA5761_TNCTRL_IFCTC\t0x08\t \n#define TEA5761_TNCTRL_AFM\t0x04\n#define TEA5761_TNCTRL_SMUTE\t0x02\t \n#define TEA5761_TNCTRL_SNC\t0x01\n\n\t \n\n#define TEA5761_TNCTRL_MU\t0x80\t \n#define TEA5761_TNCTRL_SSL_1\t0x40\n#define TEA5761_TNCTRL_SSL_0\t0x20\n#define TEA5761_TNCTRL_HLSI\t0x10\n#define TEA5761_TNCTRL_MST\t0x08\t \n#define TEA5761_TNCTRL_SWP\t0x04\n#define TEA5761_TNCTRL_DTC\t0x02\t \n#define TEA5761_TNCTRL_AHLSI\t0x01\n\n \n\t \n\n\t \n\n\t \n\t \n\n \n\n\t \n#define TEA5761_TUNCHECK_IF_MASK\t0x7e\t \n#define TEA5761_TUNCHECK_TUNTO\t\t0x01\n\n\t \n#define TEA5761_TUNCHECK_LEV_MASK\t0xf0\t \n#define TEA5761_TUNCHECK_LD\t\t0x08\n#define TEA5761_TUNCHECK_STEREO\t\t0x04\n\n \n\n\t \n\n \n\n\t \n#define TEA5767_MANID_VERSION_MASK\t0xf0\t \n#define TEA5767_MANID_ID_MSB_MASK\t0x0f\t \n\n\t \n\n#define TEA5767_MANID_ID_LSB_MASK\t0xfe\t \n#define TEA5767_MANID_IDAV\t\t0x01\t \n\n \n\n\t \n\n\t \n\n \n\n#define FREQ_OFFSET 0  \nstatic void tea5761_status_dump(unsigned char *buffer)\n{\n\tunsigned int div, frq;\n\n\tdiv = ((buffer[2] & 0x3f) << 8) | buffer[3];\n\n\tfrq = 1000 * (div * 32768 / 1000 + FREQ_OFFSET + 225) / 4;\t \n\n\tprintk(KERN_INFO \"tea5761: Frequency %d.%03d KHz (divider = 0x%04x)\\n\",\n\t       frq / 1000, frq % 1000, div);\n}\n\n \nstatic int __set_radio_freq(struct dvb_frontend *fe,\n\t\t\t    unsigned int freq,\n\t\t\t    bool mono)\n{\n\tstruct tea5761_priv *priv = fe->tuner_priv;\n\tunsigned int frq = freq;\n\tunsigned char buffer[7] = {0, 0, 0, 0, 0, 0, 0 };\n\tunsigned div;\n\tint rc;\n\n\ttuner_dbg(\"radio freq counter %d\\n\", frq);\n\n\tif (priv->standby) {\n\t\ttuner_dbg(\"TEA5761 set to standby mode\\n\");\n\t\tbuffer[5] |= TEA5761_TNCTRL_MU;\n\t} else {\n\t\tbuffer[4] |= TEA5761_TNCTRL_PUPD_0;\n\t}\n\n\n\tif (mono) {\n\t\ttuner_dbg(\"TEA5761 set to mono\\n\");\n\t\tbuffer[5] |= TEA5761_TNCTRL_MST;\n\t} else {\n\t\ttuner_dbg(\"TEA5761 set to stereo\\n\");\n\t}\n\n\tdiv = (1000 * (frq * 4 / 16 + 700 + 225) ) >> 15;\n\tbuffer[1] = (div >> 8) & 0x3f;\n\tbuffer[2] = div & 0xff;\n\n\tif (debug)\n\t\ttea5761_status_dump(buffer);\n\n\tif (7 != (rc = tuner_i2c_xfer_send(&priv->i2c_props, buffer, 7)))\n\t\ttuner_warn(\"i2c i/o error: rc == %d (should be 5)\\n\", rc);\n\n\tpriv->frequency = frq * 125 / 2;\n\n\treturn 0;\n}\n\nstatic int set_radio_freq(struct dvb_frontend *fe,\n\t\t\t  struct analog_parameters *params)\n{\n\tstruct tea5761_priv *priv = fe->analog_demod_priv;\n\n\tpriv->standby = false;\n\n\treturn __set_radio_freq(fe, params->frequency,\n\t\t\t\tparams->audmode == V4L2_TUNER_MODE_MONO);\n}\n\nstatic int set_radio_sleep(struct dvb_frontend *fe)\n{\n\tstruct tea5761_priv *priv = fe->analog_demod_priv;\n\n\tpriv->standby = true;\n\n\treturn __set_radio_freq(fe, priv->frequency, false);\n}\n\nstatic int tea5761_read_status(struct dvb_frontend *fe, char *buffer)\n{\n\tstruct tea5761_priv *priv = fe->tuner_priv;\n\tint rc;\n\n\tmemset(buffer, 0, 16);\n\tif (16 != (rc = tuner_i2c_xfer_recv(&priv->i2c_props, buffer, 16))) {\n\t\ttuner_warn(\"i2c i/o error: rc == %d (should be 16)\\n\", rc);\n\t\treturn -EREMOTEIO;\n\t}\n\n\treturn 0;\n}\n\nstatic inline int tea5761_signal(struct dvb_frontend *fe, const char *buffer)\n{\n\tstruct tea5761_priv *priv = fe->tuner_priv;\n\n\tint signal = ((buffer[9] & TEA5761_TUNCHECK_LEV_MASK) << (13 - 4));\n\n\ttuner_dbg(\"Signal strength: %d\\n\", signal);\n\n\treturn signal;\n}\n\nstatic inline int tea5761_stereo(struct dvb_frontend *fe, const char *buffer)\n{\n\tstruct tea5761_priv *priv = fe->tuner_priv;\n\n\tint stereo = buffer[9] & TEA5761_TUNCHECK_STEREO;\n\n\ttuner_dbg(\"Radio ST GET = %02x\\n\", stereo);\n\n\treturn (stereo ? V4L2_TUNER_SUB_STEREO : 0);\n}\n\nstatic int tea5761_get_status(struct dvb_frontend *fe, u32 *status)\n{\n\tunsigned char buffer[16];\n\n\t*status = 0;\n\n\tif (0 == tea5761_read_status(fe, buffer)) {\n\t\tif (tea5761_signal(fe, buffer))\n\t\t\t*status = TUNER_STATUS_LOCKED;\n\t\tif (tea5761_stereo(fe, buffer))\n\t\t\t*status |= TUNER_STATUS_STEREO;\n\t}\n\n\treturn 0;\n}\n\nstatic int tea5761_get_rf_strength(struct dvb_frontend *fe, u16 *strength)\n{\n\tunsigned char buffer[16];\n\n\t*strength = 0;\n\n\tif (0 == tea5761_read_status(fe, buffer))\n\t\t*strength = tea5761_signal(fe, buffer);\n\n\treturn 0;\n}\n\nint tea5761_autodetection(struct i2c_adapter* i2c_adap, u8 i2c_addr)\n{\n\tunsigned char buffer[16];\n\tint rc;\n\tstruct tuner_i2c_props i2c = { .adap = i2c_adap, .addr = i2c_addr };\n\n\tif (16 != (rc = tuner_i2c_xfer_recv(&i2c, buffer, 16))) {\n\t\tprintk(KERN_WARNING \"it is not a TEA5761. Received %i chars.\\n\", rc);\n\t\treturn -EINVAL;\n\t}\n\n\tif ((buffer[13] != 0x2b) || (buffer[14] != 0x57) || (buffer[15] != 0x061)) {\n\t\tprintk(KERN_WARNING \"Manufacturer ID= 0x%02x, Chip ID = %02x%02x. It is not a TEA5761\\n\",\n\t\t\t\t    buffer[13], buffer[14], buffer[15]);\n\t\treturn -EINVAL;\n\t}\n\tprintk(KERN_WARNING \"tea5761: TEA%02x%02x detected. Manufacturer ID= 0x%02x\\n\",\n\t\t\t    buffer[14], buffer[15], buffer[13]);\n\n\treturn 0;\n}\n\nstatic void tea5761_release(struct dvb_frontend *fe)\n{\n\tkfree(fe->tuner_priv);\n\tfe->tuner_priv = NULL;\n}\n\nstatic int tea5761_get_frequency(struct dvb_frontend *fe, u32 *frequency)\n{\n\tstruct tea5761_priv *priv = fe->tuner_priv;\n\t*frequency = priv->frequency;\n\treturn 0;\n}\n\nstatic const struct dvb_tuner_ops tea5761_tuner_ops = {\n\t.info = {\n\t\t.name           = \"tea5761\", \n\t},\n\t.set_analog_params = set_radio_freq,\n\t.sleep\t\t   = set_radio_sleep,\n\t.release           = tea5761_release,\n\t.get_frequency     = tea5761_get_frequency,\n\t.get_status        = tea5761_get_status,\n\t.get_rf_strength   = tea5761_get_rf_strength,\n};\n\nstruct dvb_frontend *tea5761_attach(struct dvb_frontend *fe,\n\t\t\t\t    struct i2c_adapter* i2c_adap,\n\t\t\t\t    u8 i2c_addr)\n{\n\tstruct tea5761_priv *priv = NULL;\n\n\tif (tea5761_autodetection(i2c_adap, i2c_addr) != 0)\n\t\treturn NULL;\n\n\tpriv = kzalloc(sizeof(struct tea5761_priv), GFP_KERNEL);\n\tif (priv == NULL)\n\t\treturn NULL;\n\tfe->tuner_priv = priv;\n\n\tpriv->i2c_props.addr = i2c_addr;\n\tpriv->i2c_props.adap = i2c_adap;\n\tpriv->i2c_props.name = \"tea5761\";\n\n\tmemcpy(&fe->ops.tuner_ops, &tea5761_tuner_ops,\n\t       sizeof(struct dvb_tuner_ops));\n\n\ttuner_info(\"type set to %s\\n\", \"Philips TEA5761HN FM Radio\");\n\n\treturn fe;\n}\n\n\nEXPORT_SYMBOL_GPL(tea5761_attach);\nEXPORT_SYMBOL_GPL(tea5761_autodetection);\n\nMODULE_DESCRIPTION(\"Philips TEA5761 FM tuner driver\");\nMODULE_AUTHOR(\"Mauro Carvalho Chehab <mchehab@kernel.org>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}