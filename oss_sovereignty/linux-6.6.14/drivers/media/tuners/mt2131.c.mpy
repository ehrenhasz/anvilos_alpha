{
  "module_name": "mt2131.c",
  "hash_id": "55c2023566816813f9df4e546ab4186348356c548ead7da8b6b044e6f4a71ae8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/tuners/mt2131.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/dvb/frontend.h>\n#include <linux/i2c.h>\n#include <linux/slab.h>\n\n#include <media/dvb_frontend.h>\n\n#include \"mt2131.h\"\n#include \"mt2131_priv.h\"\n\nstatic int debug;\nmodule_param(debug, int, 0644);\nMODULE_PARM_DESC(debug, \"Turn on/off debugging (default:off).\");\n\n#define dprintk(level,fmt, arg...) if (debug >= level) \\\n\tprintk(KERN_INFO \"%s: \" fmt, \"mt2131\", ## arg)\n\nstatic u8 mt2131_config1[] = {\n\t0x01,\n\t0x50, 0x00, 0x50, 0x80, 0x00, 0x49, 0xfa, 0x88,\n\t0x08, 0x77, 0x41, 0x04, 0x00, 0x00, 0x00, 0x32,\n\t0x7f, 0xda, 0x4c, 0x00, 0x10, 0xaa, 0x78, 0x80,\n\t0xff, 0x68, 0xa0, 0xff, 0xdd, 0x00, 0x00\n};\n\nstatic u8 mt2131_config2[] = {\n\t0x10,\n\t0x7f, 0xc8, 0x0a, 0x5f, 0x00, 0x04\n};\n\nstatic int mt2131_readreg(struct mt2131_priv *priv, u8 reg, u8 *val)\n{\n\tstruct i2c_msg msg[2] = {\n\t\t{ .addr = priv->cfg->i2c_address, .flags = 0,\n\t\t  .buf = &reg, .len = 1 },\n\t\t{ .addr = priv->cfg->i2c_address, .flags = I2C_M_RD,\n\t\t  .buf = val,  .len = 1 },\n\t};\n\n\tif (i2c_transfer(priv->i2c, msg, 2) != 2) {\n\t\tprintk(KERN_WARNING \"mt2131 I2C read failed\\n\");\n\t\treturn -EREMOTEIO;\n\t}\n\treturn 0;\n}\n\nstatic int mt2131_writereg(struct mt2131_priv *priv, u8 reg, u8 val)\n{\n\tu8 buf[2] = { reg, val };\n\tstruct i2c_msg msg = { .addr = priv->cfg->i2c_address, .flags = 0,\n\t\t\t       .buf = buf, .len = 2 };\n\n\tif (i2c_transfer(priv->i2c, &msg, 1) != 1) {\n\t\tprintk(KERN_WARNING \"mt2131 I2C write failed\\n\");\n\t\treturn -EREMOTEIO;\n\t}\n\treturn 0;\n}\n\nstatic int mt2131_writeregs(struct mt2131_priv *priv,u8 *buf, u8 len)\n{\n\tstruct i2c_msg msg = { .addr = priv->cfg->i2c_address,\n\t\t\t       .flags = 0, .buf = buf, .len = len };\n\n\tif (i2c_transfer(priv->i2c, &msg, 1) != 1) {\n\t\tprintk(KERN_WARNING \"mt2131 I2C write failed (len=%i)\\n\",\n\t\t       (int)len);\n\t\treturn -EREMOTEIO;\n\t}\n\treturn 0;\n}\n\nstatic int mt2131_set_params(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\n\tstruct mt2131_priv *priv;\n\tint ret=0, i;\n\tu32 freq;\n\tu8  if_band_center;\n\tu32 f_lo1, f_lo2;\n\tu32 div1, num1, div2, num2;\n\tu8  b[8];\n\tu8 lockval = 0;\n\n\tpriv = fe->tuner_priv;\n\n\tfreq = c->frequency / 1000;   \n\tdprintk(1, \"%s() freq=%d\\n\", __func__, freq);\n\n\tf_lo1 = freq + MT2131_IF1 * 1000;\n\tf_lo1 = (f_lo1 / 250) * 250;\n\tf_lo2 = f_lo1 - freq - MT2131_IF2;\n\n\tpriv->frequency =  (f_lo1 - f_lo2 - MT2131_IF2) * 1000;\n\n\t \n\tnum1 = f_lo1 * 64 / (MT2131_FREF / 128);\n\tdiv1 = num1 / 8192;\n\tnum1 &= 0x1fff;\n\n\t \n\tnum2 = f_lo2 * 64 / (MT2131_FREF / 128);\n\tdiv2 = num2 / 8192;\n\tnum2 &= 0x1fff;\n\n\tif (freq <=   82500) if_band_center = 0x00; else\n\tif (freq <=  137500) if_band_center = 0x01; else\n\tif (freq <=  192500) if_band_center = 0x02; else\n\tif (freq <=  247500) if_band_center = 0x03; else\n\tif (freq <=  302500) if_band_center = 0x04; else\n\tif (freq <=  357500) if_band_center = 0x05; else\n\tif (freq <=  412500) if_band_center = 0x06; else\n\tif (freq <=  467500) if_band_center = 0x07; else\n\tif (freq <=  522500) if_band_center = 0x08; else\n\tif (freq <=  577500) if_band_center = 0x09; else\n\tif (freq <=  632500) if_band_center = 0x0A; else\n\tif (freq <=  687500) if_band_center = 0x0B; else\n\tif (freq <=  742500) if_band_center = 0x0C; else\n\tif (freq <=  797500) if_band_center = 0x0D; else\n\tif (freq <=  852500) if_band_center = 0x0E; else\n\tif (freq <=  907500) if_band_center = 0x0F; else\n\tif (freq <=  962500) if_band_center = 0x10; else\n\tif (freq <= 1017500) if_band_center = 0x11; else\n\tif (freq <= 1072500) if_band_center = 0x12; else if_band_center = 0x13;\n\n\tb[0] = 1;\n\tb[1] = (num1 >> 5) & 0xFF;\n\tb[2] = (num1 & 0x1F);\n\tb[3] = div1;\n\tb[4] = (num2 >> 5) & 0xFF;\n\tb[5] = num2 & 0x1F;\n\tb[6] = div2;\n\n\tdprintk(1, \"IF1: %dMHz IF2: %dMHz\\n\", MT2131_IF1, MT2131_IF2);\n\tdprintk(1, \"PLL freq=%dkHz  band=%d\\n\", (int)freq, (int)if_band_center);\n\tdprintk(1, \"PLL f_lo1=%dkHz  f_lo2=%dkHz\\n\", (int)f_lo1, (int)f_lo2);\n\tdprintk(1, \"PLL div1=%d  num1=%d  div2=%d  num2=%d\\n\",\n\t\t(int)div1, (int)num1, (int)div2, (int)num2);\n\tdprintk(1, \"PLL [1..6]: %2x %2x %2x %2x %2x %2x\\n\",\n\t\t(int)b[1], (int)b[2], (int)b[3], (int)b[4], (int)b[5],\n\t\t(int)b[6]);\n\n\tret = mt2131_writeregs(priv,b,7);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tmt2131_writereg(priv, 0x0b, if_band_center);\n\n\t \n\ti = 0;\n\tdo {\n\t\tmt2131_readreg(priv, 0x08, &lockval);\n\t\tif ((lockval & 0x88) == 0x88)\n\t\t\tbreak;\n\t\tmsleep(4);\n\t\ti++;\n\t} while (i < 10);\n\n\treturn ret;\n}\n\nstatic int mt2131_get_frequency(struct dvb_frontend *fe, u32 *frequency)\n{\n\tstruct mt2131_priv *priv = fe->tuner_priv;\n\tdprintk(1, \"%s()\\n\", __func__);\n\t*frequency = priv->frequency;\n\treturn 0;\n}\n\nstatic int mt2131_get_status(struct dvb_frontend *fe, u32 *status)\n{\n\tstruct mt2131_priv *priv = fe->tuner_priv;\n\tu8 lock_status = 0;\n\tu8 afc_status = 0;\n\n\t*status = 0;\n\n\tmt2131_readreg(priv, 0x08, &lock_status);\n\tif ((lock_status & 0x88) == 0x88)\n\t\t*status = TUNER_STATUS_LOCKED;\n\n\tmt2131_readreg(priv, 0x09, &afc_status);\n\tdprintk(1, \"%s() - LO Status = 0x%x, AFC Status = 0x%x\\n\",\n\t\t__func__, lock_status, afc_status);\n\n\treturn 0;\n}\n\nstatic int mt2131_init(struct dvb_frontend *fe)\n{\n\tstruct mt2131_priv *priv = fe->tuner_priv;\n\tint ret;\n\tdprintk(1, \"%s()\\n\", __func__);\n\n\tif ((ret = mt2131_writeregs(priv, mt2131_config1,\n\t\t\t\t    sizeof(mt2131_config1))) < 0)\n\t\treturn ret;\n\n\tmt2131_writereg(priv, 0x0b, 0x09);\n\tmt2131_writereg(priv, 0x15, 0x47);\n\tmt2131_writereg(priv, 0x07, 0xf2);\n\tmt2131_writereg(priv, 0x0b, 0x01);\n\n\tif ((ret = mt2131_writeregs(priv, mt2131_config2,\n\t\t\t\t    sizeof(mt2131_config2))) < 0)\n\t\treturn ret;\n\n\treturn ret;\n}\n\nstatic void mt2131_release(struct dvb_frontend *fe)\n{\n\tdprintk(1, \"%s()\\n\", __func__);\n\tkfree(fe->tuner_priv);\n\tfe->tuner_priv = NULL;\n}\n\nstatic const struct dvb_tuner_ops mt2131_tuner_ops = {\n\t.info = {\n\t\t.name              = \"Microtune MT2131\",\n\t\t.frequency_min_hz  =  48 * MHz,\n\t\t.frequency_max_hz  = 860 * MHz,\n\t\t.frequency_step_hz =  50 * kHz,\n\t},\n\n\t.release       = mt2131_release,\n\t.init          = mt2131_init,\n\n\t.set_params    = mt2131_set_params,\n\t.get_frequency = mt2131_get_frequency,\n\t.get_status    = mt2131_get_status\n};\n\nstruct dvb_frontend * mt2131_attach(struct dvb_frontend *fe,\n\t\t\t\t    struct i2c_adapter *i2c,\n\t\t\t\t    struct mt2131_config *cfg, u16 if1)\n{\n\tstruct mt2131_priv *priv = NULL;\n\tu8 id = 0;\n\n\tdprintk(1, \"%s()\\n\", __func__);\n\n\tpriv = kzalloc(sizeof(struct mt2131_priv), GFP_KERNEL);\n\tif (priv == NULL)\n\t\treturn NULL;\n\n\tpriv->cfg = cfg;\n\tpriv->i2c = i2c;\n\n\tif (mt2131_readreg(priv, 0, &id) != 0) {\n\t\tkfree(priv);\n\t\treturn NULL;\n\t}\n\tif ( (id != 0x3E) && (id != 0x3F) ) {\n\t\tprintk(KERN_ERR \"MT2131: Device not found at addr 0x%02x\\n\",\n\t\t       cfg->i2c_address);\n\t\tkfree(priv);\n\t\treturn NULL;\n\t}\n\n\tprintk(KERN_INFO \"MT2131: successfully identified at address 0x%02x\\n\",\n\t       cfg->i2c_address);\n\tmemcpy(&fe->ops.tuner_ops, &mt2131_tuner_ops,\n\t       sizeof(struct dvb_tuner_ops));\n\n\tfe->tuner_priv = priv;\n\treturn fe;\n}\nEXPORT_SYMBOL_GPL(mt2131_attach);\n\nMODULE_AUTHOR(\"Steven Toth\");\nMODULE_DESCRIPTION(\"Microtune MT2131 silicon tuner driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}