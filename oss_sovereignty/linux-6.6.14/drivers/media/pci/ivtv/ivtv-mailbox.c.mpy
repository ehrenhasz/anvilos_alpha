{
  "module_name": "ivtv-mailbox.c",
  "hash_id": "d7a7519e791f8a05206e9d92035256ee92aefa2a4856c5b1e0d971b3810aa0ed",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/ivtv/ivtv-mailbox.c",
  "human_readable_source": "\n \n\n#include \"ivtv-driver.h\"\n#include \"ivtv-mailbox.h\"\n\n \n#define IVTV_MBOX_FIRMWARE_DONE 0x00000004\n#define IVTV_MBOX_DRIVER_DONE   0x00000002\n#define IVTV_MBOX_DRIVER_BUSY   0x00000001\n#define IVTV_MBOX_FREE\t\t0x00000000\n\n \n#define IVTV_API_STD_TIMEOUT\t0x02000000\n\n#define API_CACHE\t (1 << 0)\t \n#define API_RESULT\t (1 << 1)\t \n#define API_FAST_RESULT\t (3 << 1)\t \n#define API_DMA\t\t (1 << 3)\t \n#define API_HIGH_VOL\t (1 << 5)\t \n#define API_NO_WAIT_MB\t (1 << 4)\t \n#define API_NO_WAIT_RES\t (1 << 5)\t \n#define API_NO_POLL\t (1 << 6)\t \n\nstruct ivtv_api_info {\n\tint flags;\t\t \n\tconst char *name;\t \n};\n\n#define API_ENTRY(x, f) [x] = { (f), #x }\n\nstatic const struct ivtv_api_info api_info[256] = {\n\t \n\tAPI_ENTRY(CX2341X_ENC_PING_FW,\t\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_START_CAPTURE,\t\tAPI_RESULT | API_NO_POLL),\n\tAPI_ENTRY(CX2341X_ENC_STOP_CAPTURE,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SET_AUDIO_ID,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_VIDEO_ID,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_PCR_ID,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_FRAME_RATE,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_FRAME_SIZE,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_BIT_RATE,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_GOP_PROPERTIES,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_ASPECT_RATIO,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_DNR_FILTER_MODE,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_DNR_FILTER_PROPS,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_CORING_LEVELS,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_SPATIAL_FILTER_TYPE,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_VBI_LINE,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SET_STREAM_TYPE,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_OUTPUT_PORT,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_AUDIO_PROPERTIES,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_HALT_FW,\t\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_GET_VERSION,\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SET_GOP_CLOSURE,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_GET_SEQ_END,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SET_PGM_INDEX_INFO,\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SET_VBI_CONFIG,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SET_DMA_BLOCK_SIZE,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_GET_PREV_DMA_INFO_MB_10,\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_GET_PREV_DMA_INFO_MB_9,\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SCHED_DMA_TO_HOST,\tAPI_DMA | API_HIGH_VOL),\n\tAPI_ENTRY(CX2341X_ENC_INITIALIZE_INPUT,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SET_FRAME_DROP_RATE,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_PAUSE_ENCODER,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_REFRESH_INPUT,\t\tAPI_NO_WAIT_MB | API_HIGH_VOL),\n\tAPI_ENTRY(CX2341X_ENC_SET_COPYRIGHT,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_EVENT_NOTIFICATION,\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SET_NUM_VSYNC_LINES,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_SET_PLACEHOLDER,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_ENC_MUTE_VIDEO,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_MUTE_AUDIO,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_SET_VERT_CROP_LINE,\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_ENC_MISC,\t\t\tAPI_FAST_RESULT),\n\t \n\tAPI_ENTRY(0xb1,\t\t\t\t\tAPI_CACHE),\n\n\t \n\tAPI_ENTRY(CX2341X_DEC_PING_FW,\t\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_START_PLAYBACK,\t\tAPI_RESULT | API_NO_POLL),\n\tAPI_ENTRY(CX2341X_DEC_STOP_PLAYBACK,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_SET_PLAYBACK_SPEED,\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_STEP_VIDEO,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_SET_DMA_BLOCK_SIZE,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_DEC_GET_XFER_INFO,\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_GET_DMA_STATUS,\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_SCHED_DMA_FROM_HOST,\tAPI_DMA | API_HIGH_VOL),\n\tAPI_ENTRY(CX2341X_DEC_PAUSE_PLAYBACK,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_HALT_FW,\t\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_SET_STANDARD,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_DEC_GET_VERSION,\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_SET_STREAM_INPUT,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_DEC_GET_TIMING_INFO,\t\tAPI_RESULT  ),\n\tAPI_ENTRY(CX2341X_DEC_SET_AUDIO_MODE,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_DEC_SET_EVENT_NOTIFICATION,\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_SET_DISPLAY_BUFFERS,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_DEC_EXTRACT_VBI,\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_SET_DECODER_SOURCE,\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_DEC_SET_PREBUFFERING,\t\tAPI_CACHE),\n\n\t \n\tAPI_ENTRY(CX2341X_OSD_GET_FRAMEBUFFER,\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_GET_PIXEL_FORMAT,\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_SET_PIXEL_FORMAT,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_OSD_GET_STATE,\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_SET_STATE,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_OSD_GET_OSD_COORDS,\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_SET_OSD_COORDS,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_OSD_GET_SCREEN_COORDS,\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_SET_SCREEN_COORDS,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_OSD_GET_GLOBAL_ALPHA,\t\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_SET_GLOBAL_ALPHA,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_OSD_SET_BLEND_COORDS,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_OSD_GET_FLICKER_STATE,\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_SET_FLICKER_STATE,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_OSD_BLT_COPY,\t\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_BLT_FILL,\t\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_BLT_TEXT,\t\t\tAPI_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_SET_FRAMEBUFFER_WINDOW,\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_OSD_SET_CHROMA_KEY,\t\tAPI_CACHE),\n\tAPI_ENTRY(CX2341X_OSD_GET_ALPHA_CONTENT_INDEX,\tAPI_FAST_RESULT),\n\tAPI_ENTRY(CX2341X_OSD_SET_ALPHA_CONTENT_INDEX,\tAPI_CACHE)\n};\n\nstatic int try_mailbox(struct ivtv *itv, struct ivtv_mailbox_data *mbdata, int mb)\n{\n\tu32 flags = readl(&mbdata->mbox[mb].flags);\n\tint is_free = flags == IVTV_MBOX_FREE || (flags & IVTV_MBOX_FIRMWARE_DONE);\n\n\t \n\tif (is_free && !test_and_set_bit(mb, &mbdata->busy)) {\n\t\twrite_sync(IVTV_MBOX_DRIVER_BUSY, &mbdata->mbox[mb].flags);\n\t\treturn 1;\n\t}\n\treturn 0;\n}\n\n \nstatic int get_mailbox(struct ivtv *itv, struct ivtv_mailbox_data *mbdata, int flags)\n{\n\tunsigned long then = jiffies;\n\tint i, mb;\n\tint max_mbox = mbdata->max_mbox;\n\tint retries = 100;\n\n\t \n\tif ((flags & API_FAST_RESULT) == API_RESULT)\n\t\tmax_mbox = 1;\n\n\t \n\tfor (i = 0; i < retries; i++) {\n\t\tfor (mb = 1; mb <= max_mbox; mb++)\n\t\t\tif (try_mailbox(itv, mbdata, mb))\n\t\t\t\treturn mb;\n\n\t\t \n\t\tif (!(flags & API_NO_WAIT_MB)) {\n\t\t\tif (time_after(jiffies,\n\t\t\t\t       then + msecs_to_jiffies(10*retries)))\n\t\t\t       break;\n\t\t\tivtv_msleep_timeout(10, 0);\n\t\t}\n\t}\n\treturn -ENODEV;\n}\n\nstatic void write_mailbox(volatile struct ivtv_mailbox __iomem *mbox, int cmd, int args, u32 data[])\n{\n\tint i;\n\n\twrite_sync(cmd, &mbox->cmd);\n\twrite_sync(IVTV_API_STD_TIMEOUT, &mbox->timeout);\n\n\tfor (i = 0; i < CX2341X_MBOX_MAX_DATA; i++)\n\t\twrite_sync(data[i], &mbox->data[i]);\n\n\twrite_sync(IVTV_MBOX_DRIVER_DONE | IVTV_MBOX_DRIVER_BUSY, &mbox->flags);\n}\n\nstatic void clear_all_mailboxes(struct ivtv *itv, struct ivtv_mailbox_data *mbdata)\n{\n\tint i;\n\n\tfor (i = 0; i <= mbdata->max_mbox; i++) {\n\t\tIVTV_DEBUG_WARN(\"Clearing mailbox %d: cmd 0x%08x flags 0x%08x\\n\",\n\t\t\ti, readl(&mbdata->mbox[i].cmd), readl(&mbdata->mbox[i].flags));\n\t\twrite_sync(0, &mbdata->mbox[i].flags);\n\t\tclear_bit(i, &mbdata->busy);\n\t}\n}\n\nstatic int ivtv_api_call(struct ivtv *itv, int cmd, int args, u32 data[])\n{\n\tstruct ivtv_mailbox_data *mbdata = (cmd >= 128) ? &itv->enc_mbox : &itv->dec_mbox;\n\tvolatile struct ivtv_mailbox __iomem *mbox;\n\tint api_timeout = msecs_to_jiffies(1000);\n\tint flags, mb, i;\n\tunsigned long then;\n\n\t \n\tif (NULL == mbdata) {\n\t\tIVTV_ERR(\"No mailbox allocated\\n\");\n\t\treturn -ENODEV;\n\t}\n\tif (args < 0 || args > CX2341X_MBOX_MAX_DATA ||\n\t    cmd < 0 || cmd > 255 || api_info[cmd].name == NULL) {\n\t\tIVTV_ERR(\"Invalid MB call: cmd = 0x%02x, args = %d\\n\", cmd, args);\n\t\treturn -EINVAL;\n\t}\n\n\tif (api_info[cmd].flags & API_HIGH_VOL) {\n\t    IVTV_DEBUG_HI_MB(\"MB Call: %s\\n\", api_info[cmd].name);\n\t}\n\telse {\n\t    IVTV_DEBUG_MB(\"MB Call: %s\\n\", api_info[cmd].name);\n\t}\n\n\t \n\tfor (i = args; i < CX2341X_MBOX_MAX_DATA; i++)\n\t\tdata[i] = 0;\n\n\t \n\tif (itv->api_cache[cmd].last_jiffies &&\n\t    time_before(jiffies,\n\t\t\titv->api_cache[cmd].last_jiffies +\n\t\t\tmsecs_to_jiffies(1800000)) &&\n\t    !memcmp(data, itv->api_cache[cmd].data, sizeof(itv->api_cache[cmd].data))) {\n\t\titv->api_cache[cmd].last_jiffies = jiffies;\n\t\treturn 0;\n\t}\n\n\tflags = api_info[cmd].flags;\n\n\tif (flags & API_DMA) {\n\t\tfor (i = 0; i < 100; i++) {\n\t\t\tmb = i % (mbdata->max_mbox + 1);\n\t\t\tif (try_mailbox(itv, mbdata, mb)) {\n\t\t\t\twrite_mailbox(&mbdata->mbox[mb], cmd, args, data);\n\t\t\t\tclear_bit(mb, &mbdata->busy);\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tIVTV_DEBUG_WARN(\"%s: mailbox %d not free %08x\\n\",\n\t\t\t\t\tapi_info[cmd].name, mb, readl(&mbdata->mbox[mb].flags));\n\t\t}\n\t\tIVTV_WARN(\"Could not find free DMA mailbox for %s\\n\", api_info[cmd].name);\n\t\tclear_all_mailboxes(itv, mbdata);\n\t\treturn -EBUSY;\n\t}\n\n\tif ((flags & API_FAST_RESULT) == API_FAST_RESULT)\n\t\tapi_timeout = msecs_to_jiffies(100);\n\n\tmb = get_mailbox(itv, mbdata, flags);\n\tif (mb < 0) {\n\t\tIVTV_DEBUG_WARN(\"No free mailbox found (%s)\\n\", api_info[cmd].name);\n\t\tclear_all_mailboxes(itv, mbdata);\n\t\treturn -EBUSY;\n\t}\n\tmbox = &mbdata->mbox[mb];\n\twrite_mailbox(mbox, cmd, args, data);\n\tif (flags & API_CACHE) {\n\t\tmemcpy(itv->api_cache[cmd].data, data, sizeof(itv->api_cache[cmd].data));\n\t\titv->api_cache[cmd].last_jiffies = jiffies;\n\t}\n\tif ((flags & API_RESULT) == 0) {\n\t\tclear_bit(mb, &mbdata->busy);\n\t\treturn 0;\n\t}\n\n\t \n\tthen = jiffies;\n\n\tif (!(flags & API_NO_POLL)) {\n\t\t \n\t\tfor (i = 0; i < 100; i++) {\n\t\t\tif (readl(&mbox->flags) & IVTV_MBOX_FIRMWARE_DONE)\n\t\t\t\tbreak;\n\t\t}\n\t}\n\twhile (!(readl(&mbox->flags) & IVTV_MBOX_FIRMWARE_DONE)) {\n\t\tif (time_after(jiffies, then + api_timeout)) {\n\t\t\tIVTV_DEBUG_WARN(\"Could not get result (%s)\\n\", api_info[cmd].name);\n\t\t\t \n\t\t\twrite_sync(0, &mbox->flags);\n\t\t\tclear_bit(mb, &mbdata->busy);\n\t\t\treturn -EIO;\n\t\t}\n\t\tif (flags & API_NO_WAIT_RES)\n\t\t\tmdelay(1);\n\t\telse\n\t\t\tivtv_msleep_timeout(1, 0);\n\t}\n\tif (time_after(jiffies, then + msecs_to_jiffies(100)))\n\t\tIVTV_DEBUG_WARN(\"%s took %u jiffies\\n\",\n\t\t\t\tapi_info[cmd].name,\n\t\t\t\tjiffies_to_msecs(jiffies - then));\n\n\tfor (i = 0; i < CX2341X_MBOX_MAX_DATA; i++)\n\t\tdata[i] = readl(&mbox->data[i]);\n\twrite_sync(0, &mbox->flags);\n\tclear_bit(mb, &mbdata->busy);\n\treturn 0;\n}\n\nint ivtv_api(struct ivtv *itv, int cmd, int args, u32 data[])\n{\n\tint res = ivtv_api_call(itv, cmd, args, data);\n\n\t \n\treturn (res == -EBUSY) ? ivtv_api_call(itv, cmd, args, data) : res;\n}\n\nint ivtv_api_func(void *priv, u32 cmd, int in, int out, u32 data[CX2341X_MBOX_MAX_DATA])\n{\n\treturn ivtv_api(priv, cmd, in, data);\n}\n\nint ivtv_vapi_result(struct ivtv *itv, u32 data[CX2341X_MBOX_MAX_DATA], int cmd, int args, ...)\n{\n\tva_list ap;\n\tint i;\n\n\tva_start(ap, args);\n\tfor (i = 0; i < args; i++) {\n\t\tdata[i] = va_arg(ap, u32);\n\t}\n\tva_end(ap);\n\treturn ivtv_api(itv, cmd, args, data);\n}\n\nint ivtv_vapi(struct ivtv *itv, int cmd, int args, ...)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tva_list ap;\n\tint i;\n\n\tva_start(ap, args);\n\tfor (i = 0; i < args; i++) {\n\t\tdata[i] = va_arg(ap, u32);\n\t}\n\tva_end(ap);\n\treturn ivtv_api(itv, cmd, args, data);\n}\n\n \nvoid ivtv_api_get_data(struct ivtv_mailbox_data *mbdata, int mb,\n\t\t       int argc, u32 data[])\n{\n\tvolatile u32 __iomem *p = mbdata->mbox[mb].data;\n\tint i;\n\tfor (i = 0; i < argc; i++, p++)\n\t\tdata[i] = readl(p);\n}\n\n \nvoid ivtv_mailbox_cache_invalidate(struct ivtv *itv)\n{\n\tint i;\n\tfor (i = 0; i < 256; i++)\n\t\titv->api_cache[i].last_jiffies = 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}