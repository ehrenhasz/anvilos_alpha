{
  "module_name": "ivtv-firmware.c",
  "hash_id": "26fda4263b8e7eb89a81c062111479df52bad694fbf96c93f902d62564cb29fd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/ivtv/ivtv-firmware.c",
  "human_readable_source": "\n \n\n#include \"ivtv-driver.h\"\n#include \"ivtv-mailbox.h\"\n#include \"ivtv-firmware.h\"\n#include \"ivtv-yuv.h\"\n#include \"ivtv-ioctl.h\"\n#include \"ivtv-cards.h\"\n#include <linux/firmware.h>\n#include <media/i2c/saa7127.h>\n\n#define IVTV_MASK_SPU_ENABLE\t\t0xFFFFFFFE\n#define IVTV_MASK_VPU_ENABLE15\t\t0xFFFFFFF6\n#define IVTV_MASK_VPU_ENABLE16\t\t0xFFFFFFFB\n#define IVTV_CMD_VDM_STOP\t\t0x00000000\n#define IVTV_CMD_AO_STOP\t\t0x00000005\n#define IVTV_CMD_APU_PING\t\t0x00000000\n#define IVTV_CMD_VPU_STOP15\t\t0xFFFFFFFE\n#define IVTV_CMD_VPU_STOP16\t\t0xFFFFFFEE\n#define IVTV_CMD_HW_BLOCKS_RST\t\t0xFFFFFFFF\n#define IVTV_CMD_SPU_STOP\t\t0x00000001\n#define IVTV_CMD_SDRAM_PRECHARGE_INIT\t0x0000001A\n#define IVTV_CMD_SDRAM_REFRESH_INIT\t0x80000640\n#define IVTV_SDRAM_SLEEPTIME\t\t600\n\n#define IVTV_DECODE_INIT_MPEG_FILENAME\t\"v4l-cx2341x-init.mpg\"\n#define IVTV_DECODE_INIT_MPEG_SIZE\t(152*1024)\n\n \n#define IVTV_FW_ENC_SIZE\t\t(376836)\n#define IVTV_FW_DEC_SIZE\t\t(256*1024)\n\nstatic int load_fw_direct(const char *fn, volatile u8 __iomem *mem, struct ivtv *itv, long size)\n{\n\tconst struct firmware *fw = NULL;\n\tint retries = 3;\n\nretry:\n\tif (retries && request_firmware(&fw, fn, &itv->pdev->dev) == 0) {\n\t\tint i;\n\t\tvolatile u32 __iomem *dst = (volatile u32 __iomem *)mem;\n\t\tconst u32 *src = (const u32 *)fw->data;\n\n\t\tif (fw->size != size) {\n\t\t\t \n\t\t\tIVTV_INFO(\"Retry: file loaded was not %s (expected size %ld, got %zu)\\n\", fn, size, fw->size);\n\t\t\trelease_firmware(fw);\n\t\t\tretries--;\n\t\t\tgoto retry;\n\t\t}\n\t\tfor (i = 0; i < fw->size; i += 4) {\n\t\t\t \n\t\t\t__raw_writel(*src, dst);\n\t\t\tdst++;\n\t\t\tsrc++;\n\t\t}\n\t\tIVTV_INFO(\"Loaded %s firmware (%zu bytes)\\n\", fn, fw->size);\n\t\trelease_firmware(fw);\n\t\treturn size;\n\t}\n\tIVTV_ERR(\"Unable to open firmware %s (must be %ld bytes)\\n\", fn, size);\n\tIVTV_ERR(\"Did you put the firmware in the hotplug firmware directory?\\n\");\n\treturn -ENOMEM;\n}\n\nvoid ivtv_halt_firmware(struct ivtv *itv)\n{\n\tIVTV_DEBUG_INFO(\"Preparing for firmware halt.\\n\");\n\tif (itv->has_cx23415 && itv->dec_mbox.mbox)\n\t\tivtv_vapi(itv, CX2341X_DEC_HALT_FW, 0);\n\tif (itv->enc_mbox.mbox)\n\t\tivtv_vapi(itv, CX2341X_ENC_HALT_FW, 0);\n\n\tivtv_msleep_timeout(10, 0);\n\titv->enc_mbox.mbox = itv->dec_mbox.mbox = NULL;\n\n\tIVTV_DEBUG_INFO(\"Stopping VDM\\n\");\n\twrite_reg(IVTV_CMD_VDM_STOP, IVTV_REG_VDM);\n\n\tIVTV_DEBUG_INFO(\"Stopping AO\\n\");\n\twrite_reg(IVTV_CMD_AO_STOP, IVTV_REG_AO);\n\n\tIVTV_DEBUG_INFO(\"pinging (?) APU\\n\");\n\twrite_reg(IVTV_CMD_APU_PING, IVTV_REG_APU);\n\n\tIVTV_DEBUG_INFO(\"Stopping VPU\\n\");\n\tif (!itv->has_cx23415)\n\t\twrite_reg(IVTV_CMD_VPU_STOP16, IVTV_REG_VPU);\n\telse\n\t\twrite_reg(IVTV_CMD_VPU_STOP15, IVTV_REG_VPU);\n\n\tIVTV_DEBUG_INFO(\"Resetting Hw Blocks\\n\");\n\twrite_reg(IVTV_CMD_HW_BLOCKS_RST, IVTV_REG_HW_BLOCKS);\n\n\tIVTV_DEBUG_INFO(\"Stopping SPU\\n\");\n\twrite_reg(IVTV_CMD_SPU_STOP, IVTV_REG_SPU);\n\n\tivtv_msleep_timeout(10, 0);\n\n\tIVTV_DEBUG_INFO(\"init Encoder SDRAM pre-charge\\n\");\n\twrite_reg(IVTV_CMD_SDRAM_PRECHARGE_INIT, IVTV_REG_ENC_SDRAM_PRECHARGE);\n\n\tIVTV_DEBUG_INFO(\"init Encoder SDRAM refresh to 1us\\n\");\n\twrite_reg(IVTV_CMD_SDRAM_REFRESH_INIT, IVTV_REG_ENC_SDRAM_REFRESH);\n\n\tif (itv->has_cx23415) {\n\t\tIVTV_DEBUG_INFO(\"init Decoder SDRAM pre-charge\\n\");\n\t\twrite_reg(IVTV_CMD_SDRAM_PRECHARGE_INIT, IVTV_REG_DEC_SDRAM_PRECHARGE);\n\n\t\tIVTV_DEBUG_INFO(\"init Decoder SDRAM refresh to 1us\\n\");\n\t\twrite_reg(IVTV_CMD_SDRAM_REFRESH_INIT, IVTV_REG_DEC_SDRAM_REFRESH);\n\t}\n\n\tIVTV_DEBUG_INFO(\"Sleeping for %dms\\n\", IVTV_SDRAM_SLEEPTIME);\n\tivtv_msleep_timeout(IVTV_SDRAM_SLEEPTIME, 0);\n}\n\nvoid ivtv_firmware_versions(struct ivtv *itv)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\n\t \n\tivtv_vapi_result(itv, data, CX2341X_ENC_GET_VERSION, 0);\n\tIVTV_INFO(\"Encoder revision: 0x%08x\\n\", data[0]);\n\n\tif (data[0] != 0x02060039)\n\t\tIVTV_WARN(\"Recommended firmware version is 0x02060039.\\n\");\n\n\tif (itv->has_cx23415) {\n\t\t \n\t\tivtv_vapi_result(itv, data, CX2341X_DEC_GET_VERSION, 0);\n\t\tIVTV_INFO(\"Decoder revision: 0x%08x\\n\", data[0]);\n\t}\n}\n\nstatic int ivtv_firmware_copy(struct ivtv *itv)\n{\n\tIVTV_DEBUG_INFO(\"Loading encoder image\\n\");\n\tif (load_fw_direct(CX2341X_FIRM_ENC_FILENAME,\n\t\t   itv->enc_mem, itv, IVTV_FW_ENC_SIZE) != IVTV_FW_ENC_SIZE) {\n\t\tIVTV_DEBUG_WARN(\"failed loading encoder firmware\\n\");\n\t\treturn -3;\n\t}\n\tif (!itv->has_cx23415)\n\t\treturn 0;\n\n\tIVTV_DEBUG_INFO(\"Loading decoder image\\n\");\n\tif (load_fw_direct(CX2341X_FIRM_DEC_FILENAME,\n\t\t   itv->dec_mem, itv, IVTV_FW_DEC_SIZE) != IVTV_FW_DEC_SIZE) {\n\t\tIVTV_DEBUG_WARN(\"failed loading decoder firmware\\n\");\n\t\treturn -1;\n\t}\n\treturn 0;\n}\n\nstatic volatile struct ivtv_mailbox __iomem *ivtv_search_mailbox(const volatile u8 __iomem *mem, u32 size)\n{\n\tint i;\n\n\t \n\tfor (i = 0; i < size; i += 0x100) {\n\t\tif (readl(mem + i)      == 0x12345678 &&\n\t\t    readl(mem + i + 4)  == 0x34567812 &&\n\t\t    readl(mem + i + 8)  == 0x56781234 &&\n\t\t    readl(mem + i + 12) == 0x78123456) {\n\t\t\treturn (volatile struct ivtv_mailbox __iomem *)(mem + i + 16);\n\t\t}\n\t}\n\treturn NULL;\n}\n\nint ivtv_firmware_init(struct ivtv *itv)\n{\n\tint err;\n\n\tivtv_halt_firmware(itv);\n\n\t \n\terr = ivtv_firmware_copy(itv);\n\tif (err) {\n\t\tIVTV_DEBUG_WARN(\"Error %d loading firmware\\n\", err);\n\t\treturn err;\n\t}\n\n\t \n\twrite_reg(read_reg(IVTV_REG_SPU) & IVTV_MASK_SPU_ENABLE, IVTV_REG_SPU);\n\tivtv_msleep_timeout(100, 0);\n\tif (itv->has_cx23415)\n\t\twrite_reg(read_reg(IVTV_REG_VPU) & IVTV_MASK_VPU_ENABLE15, IVTV_REG_VPU);\n\telse\n\t\twrite_reg(read_reg(IVTV_REG_VPU) & IVTV_MASK_VPU_ENABLE16, IVTV_REG_VPU);\n\tivtv_msleep_timeout(100, 0);\n\n\t \n\titv->enc_mbox.mbox = ivtv_search_mailbox(itv->enc_mem, IVTV_ENCODER_SIZE);\n\tif (itv->enc_mbox.mbox == NULL)\n\t\tIVTV_ERR(\"Encoder mailbox not found\\n\");\n\telse if (ivtv_vapi(itv, CX2341X_ENC_PING_FW, 0)) {\n\t\tIVTV_ERR(\"Encoder firmware dead!\\n\");\n\t\titv->enc_mbox.mbox = NULL;\n\t}\n\tif (itv->enc_mbox.mbox == NULL)\n\t\treturn -ENODEV;\n\n\tif (!itv->has_cx23415)\n\t\treturn 0;\n\n\titv->dec_mbox.mbox = ivtv_search_mailbox(itv->dec_mem, IVTV_DECODER_SIZE);\n\tif (itv->dec_mbox.mbox == NULL) {\n\t\tIVTV_ERR(\"Decoder mailbox not found\\n\");\n\t} else if (itv->has_cx23415 && ivtv_vapi(itv, CX2341X_DEC_PING_FW, 0)) {\n\t\tIVTV_ERR(\"Decoder firmware dead!\\n\");\n\t\titv->dec_mbox.mbox = NULL;\n\t} else {\n\t\t \n\t\tivtv_yuv_filter_check(itv);\n\t}\n\treturn itv->dec_mbox.mbox ? 0 : -ENODEV;\n}\n\nvoid ivtv_init_mpeg_decoder(struct ivtv *itv)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tlong readbytes;\n\tvolatile u8 __iomem *mem_offset;\n\n\tdata[0] = 0;\n\tdata[1] = itv->cxhdl.width;\t \n\tdata[2] = itv->cxhdl.height;\n\tdata[3] = itv->cxhdl.audio_properties;\t \n\tif (ivtv_api(itv, CX2341X_DEC_SET_DECODER_SOURCE, 4, data)) {\n\t\tIVTV_ERR(\"ivtv_init_mpeg_decoder failed to set decoder source\\n\");\n\t\treturn;\n\t}\n\n\tif (ivtv_vapi(itv, CX2341X_DEC_START_PLAYBACK, 2, 0, 1) != 0) {\n\t\tIVTV_ERR(\"ivtv_init_mpeg_decoder failed to start playback\\n\");\n\t\treturn;\n\t}\n\tivtv_api_get_data(&itv->dec_mbox, IVTV_MBOX_DMA, 2, data);\n\tmem_offset = itv->dec_mem + data[1];\n\n\tif ((readbytes = load_fw_direct(IVTV_DECODE_INIT_MPEG_FILENAME,\n\t\tmem_offset, itv, IVTV_DECODE_INIT_MPEG_SIZE)) <= 0) {\n\t\tIVTV_DEBUG_WARN(\"failed to read mpeg decoder initialisation file %s\\n\",\n\t\t\t\tIVTV_DECODE_INIT_MPEG_FILENAME);\n\t} else {\n\t\tivtv_vapi(itv, CX2341X_DEC_SCHED_DMA_FROM_HOST, 3, 0, readbytes, 0);\n\t\tivtv_msleep_timeout(100, 0);\n\t}\n\tivtv_vapi(itv, CX2341X_DEC_STOP_PLAYBACK, 4, 0, 0, 0, 1);\n}\n\n \nstatic int ivtv_firmware_restart(struct ivtv *itv)\n{\n\tint rc = 0;\n\tv4l2_std_id std;\n\n\tif (itv->v4l2_cap & V4L2_CAP_VIDEO_OUTPUT)\n\t\t \n\t\tivtv_call_hw(itv, IVTV_HW_SAA7127, video, s_routing,\n\t\t    SAA7127_INPUT_TYPE_TEST_IMAGE,\n\t\t    itv->card->video_outputs[itv->active_output].video_output,\n\t\t    0);\n\n\tmutex_lock(&itv->udma.lock);\n\n\trc = ivtv_firmware_init(itv);\n\tif (rc) {\n\t\tmutex_unlock(&itv->udma.lock);\n\t\treturn rc;\n\t}\n\n\t \n\tivtv_mailbox_cache_invalidate(itv);\n\n\t \n\tstd = itv->std;\n\titv->std = 0;\n\tivtv_s_std_enc(itv, std);\n\n\tif (itv->v4l2_cap & V4L2_CAP_VIDEO_OUTPUT) {\n\t\tivtv_init_mpeg_decoder(itv);\n\n\t\t \n\t\tstd = itv->std_out;\n\t\titv->std_out = 0;\n\t\tivtv_s_std_dec(itv, std);\n\n\t\t \n\t\tif (itv->ivtvfb_restore)\n\t\t\titv->ivtvfb_restore(itv);\n\n\t\t \n\t\tivtv_set_osd_alpha(itv);\n\n\t\t \n\t\tivtv_call_hw(itv, IVTV_HW_SAA7127, video, s_routing,\n\t\t    SAA7127_INPUT_TYPE_NORMAL,\n\t\t    itv->card->video_outputs[itv->active_output].video_output,\n\t\t    0);\n\t}\n\n\tmutex_unlock(&itv->udma.lock);\n\treturn rc;\n}\n\n \nint ivtv_firmware_check(struct ivtv *itv, char *where)\n{\n\tint res = 0;\n\n\t \n\tif (ivtv_vapi(itv, CX2341X_ENC_PING_FW, 0) < 0) {\n\t\tIVTV_WARN(\"Encoder has died : %s\\n\", where);\n\t\tres = -1;\n\t}\n\n\t \n\tif (!res && !atomic_read(&itv->capturing) &&\n\t    (!atomic_read(&itv->decoding) ||\n\t     (atomic_read(&itv->decoding) < 2 && test_bit(IVTV_F_I_DEC_YUV,\n\t\t\t\t\t\t\t     &itv->i_flags)))) {\n\n\t\tif (ivtv_vapi(itv, CX2341X_ENC_MISC, 1, 12) < 0) {\n\t\t\tIVTV_WARN(\"Audio has died (Encoder OK) : %s\\n\", where);\n\t\t\tres = -2;\n\t\t}\n\t}\n\n\tif (itv->v4l2_cap & V4L2_CAP_VIDEO_OUTPUT) {\n\t\t \n\t\tif (res != -2 && read_dec(0x100) != read_dec(0x104)) {\n\t\t\t \n\t\t\tivtv_msleep_timeout(14, 0);\n\t\t\tif (read_dec(0x100) != read_dec(0x104)) {\n\t\t\t\tIVTV_WARN(\"Audio has died (Decoder) : %s\\n\",\n\t\t\t\t\t  where);\n\t\t\t\tres = -1;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tif (ivtv_vapi(itv, CX2341X_DEC_PING_FW, 0) < 0) {\n\t\t\tIVTV_WARN(\"Decoder has died : %s\\n\", where);\n\t\t\tres = -1;\n\t\t}\n\t}\n\n\t \n\tif (res && !atomic_read(&itv->capturing) &&\n\t\t\t\t\t\t!atomic_read(&itv->decoding)) {\n\t\tIVTV_INFO(\"Detected in %s that firmware had failed - Reloading\\n\",\n\t\t\t  where);\n\t\tres = ivtv_firmware_restart(itv);\n\t\t \n\t\tif (!res) {\n\t\t\tIVTV_INFO(\"Firmware restart okay\\n\");\n\t\t\tres = -EAGAIN;\n\t\t} else {\n\t\t\tIVTV_INFO(\"Firmware restart failed\\n\");\n\t\t}\n\t} else if (res) {\n\t\tres = -EIO;\n\t}\n\n\treturn res;\n}\n\nMODULE_FIRMWARE(CX2341X_FIRM_ENC_FILENAME);\nMODULE_FIRMWARE(CX2341X_FIRM_DEC_FILENAME);\nMODULE_FIRMWARE(IVTV_DECODE_INIT_MPEG_FILENAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}