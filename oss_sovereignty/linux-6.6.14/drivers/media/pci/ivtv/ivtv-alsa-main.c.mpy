{
  "module_name": "ivtv-alsa-main.c",
  "hash_id": "cb9ed2964eb451fdab5b23d7f95fd20308bf948d078cbb34097d2edd874ac1cc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/ivtv/ivtv-alsa-main.c",
  "human_readable_source": "\n \n\n#include \"ivtv-driver.h\"\n#include \"ivtv-version.h\"\n#include \"ivtv-alsa.h\"\n#include \"ivtv-alsa-pcm.h\"\n\n#include <sound/core.h>\n#include <sound/initval.h>\n\nint ivtv_alsa_debug;\nstatic int index[SNDRV_CARDS] = SNDRV_DEFAULT_IDX;\n\n#define IVTV_DEBUG_ALSA_INFO(__fmt, __arg...) \\\n\tdo { \\\n\t\tif (ivtv_alsa_debug & 2) \\\n\t\t\tprintk(KERN_INFO pr_fmt(\"%s: alsa:\" __fmt),\t\\\n\t\t\t       __func__, ##__arg);\t\t\t\\\n\t} while (0)\n\nmodule_param_named(debug, ivtv_alsa_debug, int, 0644);\nMODULE_PARM_DESC(debug,\n\t\t \"Debug level (bitmask). Default: 0\\n\"\n\t\t \"\\t\\t\\t  1/0x0001: warning\\n\"\n\t\t \"\\t\\t\\t  2/0x0002: info\\n\");\n\nmodule_param_array(index, int, NULL, 0444);\nMODULE_PARM_DESC(index,\n\t\t \"Index value for IVTV ALSA capture interface(s).\\n\");\n\nMODULE_AUTHOR(\"Andy Walls\");\nMODULE_DESCRIPTION(\"CX23415/CX23416 ALSA Interface\");\nMODULE_LICENSE(\"GPL\");\n\nMODULE_VERSION(IVTV_VERSION);\n\nstatic inline\nstruct snd_ivtv_card *to_snd_ivtv_card(struct v4l2_device *v4l2_dev)\n{\n\treturn to_ivtv(v4l2_dev)->alsa;\n}\n\nstatic void snd_ivtv_card_free(struct snd_ivtv_card *itvsc)\n{\n\tif (itvsc == NULL)\n\t\treturn;\n\n\tif (itvsc->v4l2_dev != NULL)\n\t\tto_ivtv(itvsc->v4l2_dev)->alsa = NULL;\n\n\t \n\n\tkfree(itvsc);\n}\n\nstatic void snd_ivtv_card_private_free(struct snd_card *sc)\n{\n\tif (sc == NULL)\n\t\treturn;\n\tsnd_ivtv_card_free(sc->private_data);\n\tsc->private_data = NULL;\n\tsc->private_free = NULL;\n}\n\nstatic int snd_ivtv_card_create(struct v4l2_device *v4l2_dev,\n\t\t\t\t       struct snd_card *sc,\n\t\t\t\t       struct snd_ivtv_card **itvsc)\n{\n\t*itvsc = kzalloc(sizeof(struct snd_ivtv_card), GFP_KERNEL);\n\tif (*itvsc == NULL)\n\t\treturn -ENOMEM;\n\n\t(*itvsc)->v4l2_dev = v4l2_dev;\n\t(*itvsc)->sc = sc;\n\n\tsc->private_data = *itvsc;\n\tsc->private_free = snd_ivtv_card_private_free;\n\n\treturn 0;\n}\n\nstatic int snd_ivtv_card_set_names(struct snd_ivtv_card *itvsc)\n{\n\tstruct ivtv *itv = to_ivtv(itvsc->v4l2_dev);\n\tstruct snd_card *sc = itvsc->sc;\n\n\t \n\tstrscpy(sc->driver, \"CX2341[56]\", sizeof(sc->driver));\n\n\t \n\tsnprintf(sc->shortname,  sizeof(sc->shortname), \"IVTV-%d\",\n\t\t itv->instance);\n\n\t \n\tsnprintf(sc->longname, sizeof(sc->longname),\n\t\t \"CX2341[56] #%d %s TV/FM Radio/Line-In Capture\",\n\t\t itv->instance, itv->card_name);\n\n\treturn 0;\n}\n\nstatic int snd_ivtv_init(struct v4l2_device *v4l2_dev)\n{\n\tstruct ivtv *itv = to_ivtv(v4l2_dev);\n\tstruct snd_card *sc = NULL;\n\tstruct snd_ivtv_card *itvsc;\n\tint ret, idx;\n\n\t \n\n\t \n\t \n\n\t \n\t \n\tidx = index[itv->instance] == -1 ? SNDRV_DEFAULT_IDX1 : index[itv->instance];\n\tret = snd_card_new(&itv->pdev->dev,\n\t\t\t   idx,\n\t\t\t   SNDRV_DEFAULT_STR1,  \n\t\t\t   THIS_MODULE, 0, &sc);\n\tif (ret) {\n\t\tIVTV_ALSA_ERR(\"%s: snd_card_new() failed with err %d\\n\",\n\t\t\t      __func__, ret);\n\t\tgoto err_exit;\n\t}\n\n\t \n\tret = snd_ivtv_card_create(v4l2_dev, sc, &itvsc);\n\tif (ret) {\n\t\tIVTV_ALSA_ERR(\"%s: snd_ivtv_card_create() failed with err %d\\n\",\n\t\t\t      __func__, ret);\n\t\tgoto err_exit_free;\n\t}\n\n\t \n\tsnd_ivtv_card_set_names(itvsc);\n\n\t \n\tret = snd_ivtv_pcm_create(itvsc);\n\tif (ret) {\n\t\tIVTV_ALSA_ERR(\"%s: snd_ivtv_pcm_create() failed with err %d\\n\",\n\t\t\t      __func__, ret);\n\t\tgoto err_exit_free;\n\t}\n\t \n\n\t \n\t \n\titv->alsa = itvsc;\n\n\t \n\tret = snd_card_register(sc);\n\tif (ret) {\n\t\titv->alsa = NULL;\n\t\tIVTV_ALSA_ERR(\"%s: snd_card_register() failed with err %d\\n\",\n\t\t\t      __func__, ret);\n\t\tgoto err_exit_free;\n\t}\n\n\tIVTV_ALSA_INFO(\"%s: Instance %d registered as ALSA card %d\\n\",\n\t\t\t __func__, itv->instance, sc->number);\n\n\treturn 0;\n\nerr_exit_free:\n\tif (sc != NULL)\n\t\tsnd_card_free(sc);\n\tkfree(itvsc);\nerr_exit:\n\treturn ret;\n}\n\nstatic int ivtv_alsa_load(struct ivtv *itv)\n{\n\tstruct v4l2_device *v4l2_dev = &itv->v4l2_dev;\n\tstruct ivtv_stream *s;\n\n\tif (v4l2_dev == NULL) {\n\t\tpr_err(\"ivtv-alsa: %s: struct v4l2_device * is NULL\\n\",\n\t\t       __func__);\n\t\treturn 0;\n\t}\n\n\titv = to_ivtv(v4l2_dev);\n\tif (itv == NULL) {\n\t\tpr_err(\"ivtv-alsa itv is NULL\\n\");\n\t\treturn 0;\n\t}\n\n\ts = &itv->streams[IVTV_ENC_STREAM_TYPE_PCM];\n\tif (s->vdev.v4l2_dev == NULL) {\n\t\tIVTV_DEBUG_ALSA_INFO(\"PCM stream for card is disabled - skipping\\n\");\n\t\treturn 0;\n\t}\n\n\tif (itv->alsa != NULL) {\n\t\tIVTV_ALSA_ERR(\"%s: struct snd_ivtv_card * already exists\\n\",\n\t\t\t      __func__);\n\t\treturn 0;\n\t}\n\n\tif (snd_ivtv_init(v4l2_dev)) {\n\t\tIVTV_ALSA_ERR(\"%s: failed to create struct snd_ivtv_card\\n\",\n\t\t\t      __func__);\n\t} else {\n\t\tIVTV_DEBUG_ALSA_INFO(\"created ivtv ALSA interface instance\\n\");\n\t}\n\treturn 0;\n}\n\nstatic int __init ivtv_alsa_init(void)\n{\n\tpr_info(\"ivtv-alsa: module loading...\\n\");\n\tivtv_ext_init = &ivtv_alsa_load;\n\treturn 0;\n}\n\nstatic void __exit snd_ivtv_exit(struct snd_ivtv_card *itvsc)\n{\n\tstruct ivtv *itv = to_ivtv(itvsc->v4l2_dev);\n\n\t \n\n\tsnd_card_free(itvsc->sc);\n\titv->alsa = NULL;\n}\n\nstatic int __exit ivtv_alsa_exit_callback(struct device *dev, void *data)\n{\n\tstruct v4l2_device *v4l2_dev = dev_get_drvdata(dev);\n\tstruct snd_ivtv_card *itvsc;\n\n\tif (v4l2_dev == NULL) {\n\t\tpr_err(\"ivtv-alsa: %s: struct v4l2_device * is NULL\\n\",\n\t\t       __func__);\n\t\treturn 0;\n\t}\n\n\titvsc = to_snd_ivtv_card(v4l2_dev);\n\tif (itvsc == NULL) {\n\t\tIVTV_ALSA_WARN(\"%s: struct snd_ivtv_card * is NULL\\n\",\n\t\t\t       __func__);\n\t\treturn 0;\n\t}\n\n\tsnd_ivtv_exit(itvsc);\n\treturn 0;\n}\n\nstatic void __exit ivtv_alsa_exit(void)\n{\n\tstruct device_driver *drv;\n\tint ret;\n\n\tpr_info(\"ivtv-alsa: module unloading...\\n\");\n\n\tdrv = driver_find(\"ivtv\", &pci_bus_type);\n\tret = driver_for_each_device(drv, NULL, NULL, ivtv_alsa_exit_callback);\n\t(void)ret;\t \n\n\tivtv_ext_init = NULL;\n\tpr_info(\"ivtv-alsa: module unload complete\\n\");\n}\n\nmodule_init(ivtv_alsa_init);\nmodule_exit(ivtv_alsa_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}