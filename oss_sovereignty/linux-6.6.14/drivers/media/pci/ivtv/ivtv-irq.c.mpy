{
  "module_name": "ivtv-irq.c",
  "hash_id": "25fe5bf05dff28133b9cc13ed068f166d89bc71ff27e3b17c327b6b77a85e3f7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/ivtv/ivtv-irq.c",
  "human_readable_source": "\n \n\n#include \"ivtv-driver.h\"\n#include \"ivtv-queue.h\"\n#include \"ivtv-udma.h\"\n#include \"ivtv-irq.h\"\n#include \"ivtv-mailbox.h\"\n#include \"ivtv-vbi.h\"\n#include \"ivtv-yuv.h\"\n#include <media/v4l2-event.h>\n\n#define DMA_MAGIC_COOKIE 0x000001fe\n\nstatic void ivtv_dma_dec_start(struct ivtv_stream *s);\n\nstatic const int ivtv_stream_map[] = {\n\tIVTV_ENC_STREAM_TYPE_MPG,\n\tIVTV_ENC_STREAM_TYPE_YUV,\n\tIVTV_ENC_STREAM_TYPE_PCM,\n\tIVTV_ENC_STREAM_TYPE_VBI,\n};\n\nstatic void ivtv_pcm_work_handler(struct ivtv *itv)\n{\n\tstruct ivtv_stream *s = &itv->streams[IVTV_ENC_STREAM_TYPE_PCM];\n\tstruct ivtv_buffer *buf;\n\n\t \n\n\twhile (1) {\n\t\t \n\t\tbuf = ivtv_dequeue(s, &s->q_io);\n\t\tif (buf == NULL)\n\t\t\tbuf = ivtv_dequeue(s, &s->q_full);\n\t\tif (buf == NULL)\n\t\t\tbreak;\n\n\t\tif (buf->readpos < buf->bytesused)\n\t\t\titv->pcm_announce_callback(itv->alsa,\n\t\t\t\t(u8 *)(buf->buf + buf->readpos),\n\t\t\t\t(size_t)(buf->bytesused - buf->readpos));\n\n\t\tivtv_enqueue(s, buf, &s->q_free);\n\t}\n}\n\nstatic void ivtv_pio_work_handler(struct ivtv *itv)\n{\n\tstruct ivtv_stream *s = &itv->streams[itv->cur_pio_stream];\n\tstruct ivtv_buffer *buf;\n\tint i = 0;\n\n\tIVTV_DEBUG_HI_DMA(\"ivtv_pio_work_handler\\n\");\n\tif (itv->cur_pio_stream < 0 || itv->cur_pio_stream >= IVTV_MAX_STREAMS ||\n\t\t\ts->vdev.v4l2_dev == NULL || !ivtv_use_pio(s)) {\n\t\titv->cur_pio_stream = -1;\n\t\t \n\t\twrite_reg(IVTV_IRQ_ENC_PIO_COMPLETE, 0x44);\n\t\treturn;\n\t}\n\tIVTV_DEBUG_HI_DMA(\"Process PIO %s\\n\", s->name);\n\tlist_for_each_entry(buf, &s->q_dma.list, list) {\n\t\tu32 size = s->sg_processing[i].size & 0x3ffff;\n\n\t\t \n\t\tif (s->type == IVTV_DEC_STREAM_TYPE_VBI) {\n\t\t\tmemcpy_fromio(buf->buf, itv->dec_mem + s->sg_processing[i].src - IVTV_DECODER_OFFSET, size);\n\t\t}\n\t\telse {\n\t\t\tmemcpy_fromio(buf->buf, itv->enc_mem + s->sg_processing[i].src, size);\n\t\t}\n\t\ti++;\n\t\tif (i == s->sg_processing_size)\n\t\t\tbreak;\n\t}\n\twrite_reg(IVTV_IRQ_ENC_PIO_COMPLETE, 0x44);\n}\n\nvoid ivtv_irq_work_handler(struct kthread_work *work)\n{\n\tstruct ivtv *itv = container_of(work, struct ivtv, irq_work);\n\n\tif (test_and_clear_bit(IVTV_F_I_WORK_HANDLER_PIO, &itv->i_flags))\n\t\tivtv_pio_work_handler(itv);\n\n\tif (test_and_clear_bit(IVTV_F_I_WORK_HANDLER_VBI, &itv->i_flags))\n\t\tivtv_vbi_work_handler(itv);\n\n\tif (test_and_clear_bit(IVTV_F_I_WORK_HANDLER_YUV, &itv->i_flags))\n\t\tivtv_yuv_work_handler(itv);\n\n\tif (test_and_clear_bit(IVTV_F_I_WORK_HANDLER_PCM, &itv->i_flags))\n\t\tivtv_pcm_work_handler(itv);\n}\n\n \nstatic int stream_enc_dma_append(struct ivtv_stream *s, u32 data[CX2341X_MBOX_MAX_DATA])\n{\n\tstruct ivtv *itv = s->itv;\n\tstruct ivtv_buffer *buf;\n\tu32 bytes_needed = 0;\n\tu32 offset, size;\n\tu32 UVoffset = 0, UVsize = 0;\n\tint skip_bufs = s->q_predma.buffers;\n\tint idx = s->sg_pending_size;\n\tint rc;\n\n\t \n\tif (s->vdev.v4l2_dev == NULL) {\n\t\tIVTV_DEBUG_WARN(\"Stream %s not started\\n\", s->name);\n\t\treturn -1;\n\t}\n\tif (!test_bit(IVTV_F_S_CLAIMED, &s->s_flags)) {\n\t\tIVTV_DEBUG_WARN(\"Stream %s not open\\n\", s->name);\n\t\treturn -1;\n\t}\n\n\t \n\tswitch (s->type) {\n\t\tcase IVTV_ENC_STREAM_TYPE_MPG:\n\t\t\toffset = data[1];\n\t\t\tsize = data[2];\n\t\t\ts->pending_pts = 0;\n\t\t\tbreak;\n\n\t\tcase IVTV_ENC_STREAM_TYPE_YUV:\n\t\t\toffset = data[1];\n\t\t\tsize = data[2];\n\t\t\tUVoffset = data[3];\n\t\t\tUVsize = data[4];\n\t\t\ts->pending_pts = ((u64) data[5] << 32) | data[6];\n\t\t\tbreak;\n\n\t\tcase IVTV_ENC_STREAM_TYPE_PCM:\n\t\t\toffset = data[1] + 12;\n\t\t\tsize = data[2] - 12;\n\t\t\ts->pending_pts = read_dec(offset - 8) |\n\t\t\t\t((u64)(read_dec(offset - 12)) << 32);\n\t\t\tif (itv->has_cx23415)\n\t\t\t\toffset += IVTV_DECODER_OFFSET;\n\t\t\tbreak;\n\n\t\tcase IVTV_ENC_STREAM_TYPE_VBI:\n\t\t\tsize = itv->vbi.enc_size * itv->vbi.fpi;\n\t\t\toffset = read_enc(itv->vbi.enc_start - 4) + 12;\n\t\t\tif (offset == 12) {\n\t\t\t\tIVTV_DEBUG_INFO(\"VBI offset == 0\\n\");\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\ts->pending_pts = read_enc(offset - 4) | ((u64)read_enc(offset - 8) << 32);\n\t\t\tbreak;\n\n\t\tcase IVTV_DEC_STREAM_TYPE_VBI:\n\t\t\tsize = read_dec(itv->vbi.dec_start + 4) + 8;\n\t\t\toffset = read_dec(itv->vbi.dec_start) + itv->vbi.dec_start;\n\t\t\ts->pending_pts = 0;\n\t\t\toffset += IVTV_DECODER_OFFSET;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\treturn -1;\n\t}\n\n\t \n\tif (s->sg_pending_size == 0 && ivtv_use_dma(s)) {\n\t\tif (itv->has_cx23415 && (s->type == IVTV_ENC_STREAM_TYPE_PCM ||\n\t\t    s->type == IVTV_DEC_STREAM_TYPE_VBI)) {\n\t\t\ts->pending_backup = read_dec(offset - IVTV_DECODER_OFFSET);\n\t\t\twrite_dec_sync(DMA_MAGIC_COOKIE, offset - IVTV_DECODER_OFFSET);\n\t\t}\n\t\telse {\n\t\t\ts->pending_backup = read_enc(offset);\n\t\t\twrite_enc_sync(DMA_MAGIC_COOKIE, offset);\n\t\t}\n\t\ts->pending_offset = offset;\n\t}\n\n\tbytes_needed = size;\n\tif (s->type == IVTV_ENC_STREAM_TYPE_YUV) {\n\t\t \n\t\tbytes_needed = s->buf_size * ((bytes_needed + s->buf_size - 1) / s->buf_size);\n\t\tbytes_needed += UVsize;\n\t}\n\n\tIVTV_DEBUG_HI_DMA(\"%s %s: 0x%08x bytes at 0x%08x\\n\",\n\t\tivtv_use_pio(s) ? \"PIO\" : \"DMA\", s->name, bytes_needed, offset);\n\n\trc = ivtv_queue_move(s, &s->q_free, &s->q_full, &s->q_predma, bytes_needed);\n\tif (rc < 0) {  \n\t\tIVTV_DEBUG_WARN(\"Cannot obtain %d bytes for %s data transfer\\n\",\n\t\t\t\tbytes_needed, s->name);\n\t\treturn -1;\n\t}\n\tif (rc && !s->buffers_stolen && test_bit(IVTV_F_S_APPL_IO, &s->s_flags)) {\n\t\tIVTV_WARN(\"All %s stream buffers are full. Dropping data.\\n\", s->name);\n\t\tIVTV_WARN(\"Cause: the application is not reading fast enough.\\n\");\n\t}\n\ts->buffers_stolen = rc;\n\n\t \n\tbuf = list_entry(s->q_predma.list.next, struct ivtv_buffer, list);\n\tmemset(buf->buf, 0, 128);\n\tlist_for_each_entry(buf, &s->q_predma.list, list) {\n\t\tif (skip_bufs-- > 0)\n\t\t\tcontinue;\n\t\ts->sg_pending[idx].dst = buf->dma_handle;\n\t\ts->sg_pending[idx].src = offset;\n\t\ts->sg_pending[idx].size = s->buf_size;\n\t\tbuf->bytesused = min(size, s->buf_size);\n\t\tbuf->dma_xfer_cnt = s->dma_xfer_cnt;\n\n\t\ts->q_predma.bytesused += buf->bytesused;\n\t\tsize -= buf->bytesused;\n\t\toffset += s->buf_size;\n\n\t\t \n\t\tivtv_buf_sync_for_device(s, buf);\n\n\t\tif (size == 0) {\t \n\t\t\t \n\t\t\toffset = UVoffset;\n\t\t\tsize = UVsize;\n\t\t}\n\t\tidx++;\n\t}\n\ts->sg_pending_size = idx;\n\treturn 0;\n}\n\nstatic void dma_post(struct ivtv_stream *s)\n{\n\tstruct ivtv *itv = s->itv;\n\tstruct ivtv_buffer *buf = NULL;\n\tstruct list_head *p;\n\tu32 offset;\n\t__le32 *u32buf;\n\tint x = 0;\n\n\tIVTV_DEBUG_HI_DMA(\"%s %s completed (%x)\\n\", ivtv_use_pio(s) ? \"PIO\" : \"DMA\",\n\t\t\ts->name, s->dma_offset);\n\tlist_for_each(p, &s->q_dma.list) {\n\t\tbuf = list_entry(p, struct ivtv_buffer, list);\n\t\tu32buf = (__le32 *)buf->buf;\n\n\t\t \n\t\tivtv_buf_sync_for_cpu(s, buf);\n\n\t\tif (x == 0 && ivtv_use_dma(s)) {\n\t\t\toffset = s->dma_last_offset;\n\t\t\tif (le32_to_cpu(u32buf[offset / 4]) != DMA_MAGIC_COOKIE)\n\t\t\t{\n\t\t\t\tfor (offset = 0; offset < 64; offset++)\n\t\t\t\t\tif (le32_to_cpu(u32buf[offset]) == DMA_MAGIC_COOKIE)\n\t\t\t\t\t\tbreak;\n\t\t\t\toffset *= 4;\n\t\t\t\tif (offset == 256) {\n\t\t\t\t\tIVTV_DEBUG_WARN(\"%s: Couldn't find start of buffer within the first 256 bytes\\n\", s->name);\n\t\t\t\t\toffset = s->dma_last_offset;\n\t\t\t\t}\n\t\t\t\tif (s->dma_last_offset != offset)\n\t\t\t\t\tIVTV_DEBUG_WARN(\"%s: offset %d -> %d\\n\", s->name, s->dma_last_offset, offset);\n\t\t\t\ts->dma_last_offset = offset;\n\t\t\t}\n\t\t\tif (itv->has_cx23415 && (s->type == IVTV_ENC_STREAM_TYPE_PCM ||\n\t\t\t\t\t\ts->type == IVTV_DEC_STREAM_TYPE_VBI)) {\n\t\t\t\twrite_dec_sync(0, s->dma_offset - IVTV_DECODER_OFFSET);\n\t\t\t}\n\t\t\telse {\n\t\t\t\twrite_enc_sync(0, s->dma_offset);\n\t\t\t}\n\t\t\tif (offset) {\n\t\t\t\tbuf->bytesused -= offset;\n\t\t\t\tmemcpy(buf->buf, buf->buf + offset, buf->bytesused + offset);\n\t\t\t}\n\t\t\t*u32buf = cpu_to_le32(s->dma_backup);\n\t\t}\n\t\tx++;\n\t\t \n\t\tif (s->type == IVTV_ENC_STREAM_TYPE_MPG ||\n\t\t    s->type == IVTV_ENC_STREAM_TYPE_VBI)\n\t\t\tbuf->b_flags |= IVTV_F_B_NEED_BUF_SWAP;\n\t}\n\tif (buf)\n\t\tbuf->bytesused += s->dma_last_offset;\n\tif (buf && s->type == IVTV_DEC_STREAM_TYPE_VBI) {\n\t\tlist_for_each_entry(buf, &s->q_dma.list, list) {\n\t\t\t \n\t\t\ts->q_dma.bytesused -= buf->bytesused;\n\t\t\tivtv_process_vbi_data(itv, buf, 0, s->type);\n\t\t\ts->q_dma.bytesused += buf->bytesused;\n\t\t}\n\t\tif (s->fh == NULL) {\n\t\t\tivtv_queue_move(s, &s->q_dma, NULL, &s->q_free, 0);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tivtv_queue_move(s, &s->q_dma, NULL, &s->q_full, s->q_dma.bytesused);\n\n\tif (s->type == IVTV_ENC_STREAM_TYPE_PCM &&\n\t    itv->pcm_announce_callback != NULL) {\n\t\t \n\t\tset_bit(IVTV_F_I_WORK_HANDLER_PCM, &itv->i_flags);\n\t\tset_bit(IVTV_F_I_HAVE_WORK, &itv->i_flags);\n\t}\n\n\tif (s->fh)\n\t\twake_up(&s->waitq);\n}\n\nvoid ivtv_dma_stream_dec_prepare(struct ivtv_stream *s, u32 offset, int lock)\n{\n\tstruct ivtv *itv = s->itv;\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tu8 frame = yi->draw_frame;\n\tstruct yuv_frame_info *f = &yi->new_frame_info[frame];\n\tstruct ivtv_buffer *buf;\n\tu32 y_size = 720 * ((f->src_h + 31) & ~31);\n\tu32 uv_offset = offset + IVTV_YUV_BUFFER_UV_OFFSET;\n\tint y_done = 0;\n\tint bytes_written = 0;\n\tint idx = 0;\n\n\tIVTV_DEBUG_HI_DMA(\"DEC PREPARE DMA %s: %08x %08x\\n\", s->name, s->q_predma.bytesused, offset);\n\n\t \n\tif (s->type == IVTV_DEC_STREAM_TYPE_YUV && f->offset_y) {\n\t\tif (yi->blanking_dmaptr) {\n\t\t\ts->sg_pending[idx].src = yi->blanking_dmaptr;\n\t\t\ts->sg_pending[idx].dst = offset;\n\t\t\ts->sg_pending[idx].size = 720 * 16;\n\t\t}\n\t\toffset += 720 * 16;\n\t\tidx++;\n\t}\n\n\tlist_for_each_entry(buf, &s->q_predma.list, list) {\n\t\t \n\t\tif (s->type == IVTV_DEC_STREAM_TYPE_YUV && !y_done &&\n\t\t\t\t(bytes_written + buf->bytesused) >= y_size) {\n\t\t\ts->sg_pending[idx].src = buf->dma_handle;\n\t\t\ts->sg_pending[idx].dst = offset;\n\t\t\ts->sg_pending[idx].size = y_size - bytes_written;\n\t\t\toffset = uv_offset;\n\t\t\tif (s->sg_pending[idx].size != buf->bytesused) {\n\t\t\t\tidx++;\n\t\t\t\ts->sg_pending[idx].src =\n\t\t\t\t  buf->dma_handle + s->sg_pending[idx - 1].size;\n\t\t\t\ts->sg_pending[idx].dst = offset;\n\t\t\t\ts->sg_pending[idx].size =\n\t\t\t\t   buf->bytesused - s->sg_pending[idx - 1].size;\n\t\t\t\toffset += s->sg_pending[idx].size;\n\t\t\t}\n\t\t\ty_done = 1;\n\t\t} else {\n\t\t\ts->sg_pending[idx].src = buf->dma_handle;\n\t\t\ts->sg_pending[idx].dst = offset;\n\t\t\ts->sg_pending[idx].size = buf->bytesused;\n\t\t\toffset += buf->bytesused;\n\t\t}\n\t\tbytes_written += buf->bytesused;\n\n\t\t \n\t\tivtv_buf_sync_for_device(s, buf);\n\t\tidx++;\n\t}\n\ts->sg_pending_size = idx;\n\n\t \n\tivtv_stream_sync_for_device(s);\n\tif (lock) {\n\t\tunsigned long flags = 0;\n\n\t\tspin_lock_irqsave(&itv->dma_reg_lock, flags);\n\t\tif (!test_bit(IVTV_F_I_DMA, &itv->i_flags))\n\t\t\tivtv_dma_dec_start(s);\n\t\telse\n\t\t\tset_bit(IVTV_F_S_DMA_PENDING, &s->s_flags);\n\t\tspin_unlock_irqrestore(&itv->dma_reg_lock, flags);\n\t} else {\n\t\tif (!test_bit(IVTV_F_I_DMA, &itv->i_flags))\n\t\t\tivtv_dma_dec_start(s);\n\t\telse\n\t\t\tset_bit(IVTV_F_S_DMA_PENDING, &s->s_flags);\n\t}\n}\n\nstatic void ivtv_dma_enc_start_xfer(struct ivtv_stream *s)\n{\n\tstruct ivtv *itv = s->itv;\n\n\ts->sg_dma->src = cpu_to_le32(s->sg_processing[s->sg_processed].src);\n\ts->sg_dma->dst = cpu_to_le32(s->sg_processing[s->sg_processed].dst);\n\ts->sg_dma->size = cpu_to_le32(s->sg_processing[s->sg_processed].size | 0x80000000);\n\ts->sg_processed++;\n\t \n\tivtv_stream_sync_for_device(s);\n\twrite_reg(s->sg_handle, IVTV_REG_ENCDMAADDR);\n\twrite_reg_sync(read_reg(IVTV_REG_DMAXFER) | 0x02, IVTV_REG_DMAXFER);\n\titv->dma_timer.expires = jiffies + msecs_to_jiffies(300);\n\tadd_timer(&itv->dma_timer);\n}\n\nstatic void ivtv_dma_dec_start_xfer(struct ivtv_stream *s)\n{\n\tstruct ivtv *itv = s->itv;\n\n\ts->sg_dma->src = cpu_to_le32(s->sg_processing[s->sg_processed].src);\n\ts->sg_dma->dst = cpu_to_le32(s->sg_processing[s->sg_processed].dst);\n\ts->sg_dma->size = cpu_to_le32(s->sg_processing[s->sg_processed].size | 0x80000000);\n\ts->sg_processed++;\n\t \n\tivtv_stream_sync_for_device(s);\n\twrite_reg(s->sg_handle, IVTV_REG_DECDMAADDR);\n\twrite_reg_sync(read_reg(IVTV_REG_DMAXFER) | 0x01, IVTV_REG_DMAXFER);\n\titv->dma_timer.expires = jiffies + msecs_to_jiffies(300);\n\tadd_timer(&itv->dma_timer);\n}\n\n \nstatic void ivtv_dma_enc_start(struct ivtv_stream *s)\n{\n\tstruct ivtv *itv = s->itv;\n\tstruct ivtv_stream *s_vbi = &itv->streams[IVTV_ENC_STREAM_TYPE_VBI];\n\tint i;\n\n\tIVTV_DEBUG_HI_DMA(\"start %s for %s\\n\", ivtv_use_dma(s) ? \"DMA\" : \"PIO\", s->name);\n\n\tif (s->q_predma.bytesused)\n\t\tivtv_queue_move(s, &s->q_predma, NULL, &s->q_dma, s->q_predma.bytesused);\n\n\tif (ivtv_use_dma(s))\n\t\ts->sg_pending[s->sg_pending_size - 1].size += 256;\n\n\t \n\tclear_bit(IVTV_F_S_DMA_HAS_VBI, &s->s_flags);\n\tif (s->type == IVTV_ENC_STREAM_TYPE_MPG && s_vbi->sg_pending_size &&\n\t\t\ts->sg_pending_size + s_vbi->sg_pending_size <= s->buffers) {\n\t\tivtv_queue_move(s_vbi, &s_vbi->q_predma, NULL, &s_vbi->q_dma, s_vbi->q_predma.bytesused);\n\t\tif (ivtv_use_dma(s_vbi))\n\t\t\ts_vbi->sg_pending[s_vbi->sg_pending_size - 1].size += 256;\n\t\tfor (i = 0; i < s_vbi->sg_pending_size; i++) {\n\t\t\ts->sg_pending[s->sg_pending_size++] = s_vbi->sg_pending[i];\n\t\t}\n\t\ts_vbi->dma_offset = s_vbi->pending_offset;\n\t\ts_vbi->sg_pending_size = 0;\n\t\ts_vbi->dma_xfer_cnt++;\n\t\tset_bit(IVTV_F_S_DMA_HAS_VBI, &s->s_flags);\n\t\tIVTV_DEBUG_HI_DMA(\"include DMA for %s\\n\", s_vbi->name);\n\t}\n\n\ts->dma_xfer_cnt++;\n\tmemcpy(s->sg_processing, s->sg_pending, sizeof(struct ivtv_sg_host_element) * s->sg_pending_size);\n\ts->sg_processing_size = s->sg_pending_size;\n\ts->sg_pending_size = 0;\n\ts->sg_processed = 0;\n\ts->dma_offset = s->pending_offset;\n\ts->dma_backup = s->pending_backup;\n\ts->dma_pts = s->pending_pts;\n\n\tif (ivtv_use_pio(s)) {\n\t\tset_bit(IVTV_F_I_WORK_HANDLER_PIO, &itv->i_flags);\n\t\tset_bit(IVTV_F_I_HAVE_WORK, &itv->i_flags);\n\t\tset_bit(IVTV_F_I_PIO, &itv->i_flags);\n\t\titv->cur_pio_stream = s->type;\n\t}\n\telse {\n\t\titv->dma_retries = 0;\n\t\tivtv_dma_enc_start_xfer(s);\n\t\tset_bit(IVTV_F_I_DMA, &itv->i_flags);\n\t\titv->cur_dma_stream = s->type;\n\t}\n}\n\nstatic void ivtv_dma_dec_start(struct ivtv_stream *s)\n{\n\tstruct ivtv *itv = s->itv;\n\n\tif (s->q_predma.bytesused)\n\t\tivtv_queue_move(s, &s->q_predma, NULL, &s->q_dma, s->q_predma.bytesused);\n\ts->dma_xfer_cnt++;\n\tmemcpy(s->sg_processing, s->sg_pending, sizeof(struct ivtv_sg_host_element) * s->sg_pending_size);\n\ts->sg_processing_size = s->sg_pending_size;\n\ts->sg_pending_size = 0;\n\ts->sg_processed = 0;\n\n\tIVTV_DEBUG_HI_DMA(\"start DMA for %s\\n\", s->name);\n\titv->dma_retries = 0;\n\tivtv_dma_dec_start_xfer(s);\n\tset_bit(IVTV_F_I_DMA, &itv->i_flags);\n\titv->cur_dma_stream = s->type;\n}\n\nstatic void ivtv_irq_dma_read(struct ivtv *itv)\n{\n\tstruct ivtv_stream *s = NULL;\n\tstruct ivtv_buffer *buf;\n\tint hw_stream_type = 0;\n\n\tIVTV_DEBUG_HI_IRQ(\"DEC DMA READ\\n\");\n\n\tdel_timer(&itv->dma_timer);\n\n\tif (!test_bit(IVTV_F_I_UDMA, &itv->i_flags) && itv->cur_dma_stream < 0)\n\t\treturn;\n\n\tif (!test_bit(IVTV_F_I_UDMA, &itv->i_flags)) {\n\t\ts = &itv->streams[itv->cur_dma_stream];\n\t\tivtv_stream_sync_for_cpu(s);\n\n\t\tif (read_reg(IVTV_REG_DMASTATUS) & 0x14) {\n\t\t\tIVTV_DEBUG_WARN(\"DEC DMA ERROR %x (xfer %d of %d, retry %d)\\n\",\n\t\t\t\t\tread_reg(IVTV_REG_DMASTATUS),\n\t\t\t\t\ts->sg_processed, s->sg_processing_size, itv->dma_retries);\n\t\t\twrite_reg(read_reg(IVTV_REG_DMASTATUS) & 3, IVTV_REG_DMASTATUS);\n\t\t\tif (itv->dma_retries == 3) {\n\t\t\t\t \n\t\t\t\titv->dma_retries = 0;\n\t\t\t\ts->sg_processed = s->sg_processing_size;\n\t\t\t}\n\t\t\telse {\n\t\t\t\t \n\t\t\t\ts->sg_processed = 0;\n\t\t\t\titv->dma_retries++;\n\t\t\t}\n\t\t}\n\t\tif (s->sg_processed < s->sg_processing_size) {\n\t\t\t \n\t\t\tivtv_dma_dec_start_xfer(s);\n\t\t\treturn;\n\t\t}\n\t\tif (s->type == IVTV_DEC_STREAM_TYPE_YUV)\n\t\t\thw_stream_type = 2;\n\t\tIVTV_DEBUG_HI_DMA(\"DEC DATA READ %s: %d\\n\", s->name, s->q_dma.bytesused);\n\n\t\t \n\t\tivtv_vapi(itv, CX2341X_DEC_SCHED_DMA_FROM_HOST, 3, 0, s->q_dma.bytesused,\n\t\t\t\thw_stream_type);\n\n\t\t \n\t\twhile ((buf = ivtv_dequeue(s, &s->q_dma)) != NULL) {\n\t\t\tivtv_buf_sync_for_cpu(s, buf);\n\t\t\tivtv_enqueue(s, buf, &s->q_free);\n\t\t}\n\t\twake_up(&s->waitq);\n\t}\n\tclear_bit(IVTV_F_I_UDMA, &itv->i_flags);\n\tclear_bit(IVTV_F_I_DMA, &itv->i_flags);\n\titv->cur_dma_stream = -1;\n\twake_up(&itv->dma_waitq);\n}\n\nstatic void ivtv_irq_enc_dma_complete(struct ivtv *itv)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tstruct ivtv_stream *s;\n\n\tivtv_api_get_data(&itv->enc_mbox, IVTV_MBOX_DMA_END, 2, data);\n\tIVTV_DEBUG_HI_IRQ(\"ENC DMA COMPLETE %x %d (%d)\\n\", data[0], data[1], itv->cur_dma_stream);\n\n\tdel_timer(&itv->dma_timer);\n\n\tif (itv->cur_dma_stream < 0)\n\t\treturn;\n\n\ts = &itv->streams[itv->cur_dma_stream];\n\tivtv_stream_sync_for_cpu(s);\n\n\tif (data[0] & 0x18) {\n\t\tIVTV_DEBUG_WARN(\"ENC DMA ERROR %x (offset %08x, xfer %d of %d, retry %d)\\n\", data[0],\n\t\t\ts->dma_offset, s->sg_processed, s->sg_processing_size, itv->dma_retries);\n\t\twrite_reg(read_reg(IVTV_REG_DMASTATUS) & 3, IVTV_REG_DMASTATUS);\n\t\tif (itv->dma_retries == 3) {\n\t\t\t \n\t\t\titv->dma_retries = 0;\n\t\t\ts->sg_processed = s->sg_processing_size;\n\t\t}\n\t\telse {\n\t\t\t \n\t\t\ts->sg_processed = 0;\n\t\t\titv->dma_retries++;\n\t\t}\n\t}\n\tif (s->sg_processed < s->sg_processing_size) {\n\t\t \n\t\tivtv_dma_enc_start_xfer(s);\n\t\treturn;\n\t}\n\tclear_bit(IVTV_F_I_DMA, &itv->i_flags);\n\titv->cur_dma_stream = -1;\n\tdma_post(s);\n\tif (test_and_clear_bit(IVTV_F_S_DMA_HAS_VBI, &s->s_flags)) {\n\t\ts = &itv->streams[IVTV_ENC_STREAM_TYPE_VBI];\n\t\tdma_post(s);\n\t}\n\ts->sg_processing_size = 0;\n\ts->sg_processed = 0;\n\twake_up(&itv->dma_waitq);\n}\n\nstatic void ivtv_irq_enc_pio_complete(struct ivtv *itv)\n{\n\tstruct ivtv_stream *s;\n\n\tif (itv->cur_pio_stream < 0 || itv->cur_pio_stream >= IVTV_MAX_STREAMS) {\n\t\titv->cur_pio_stream = -1;\n\t\treturn;\n\t}\n\ts = &itv->streams[itv->cur_pio_stream];\n\tIVTV_DEBUG_HI_IRQ(\"ENC PIO COMPLETE %s\\n\", s->name);\n\tclear_bit(IVTV_F_I_PIO, &itv->i_flags);\n\titv->cur_pio_stream = -1;\n\tdma_post(s);\n\tif (s->type == IVTV_ENC_STREAM_TYPE_MPG)\n\t\tivtv_vapi(itv, CX2341X_ENC_SCHED_DMA_TO_HOST, 3, 0, 0, 0);\n\telse if (s->type == IVTV_ENC_STREAM_TYPE_YUV)\n\t\tivtv_vapi(itv, CX2341X_ENC_SCHED_DMA_TO_HOST, 3, 0, 0, 1);\n\telse if (s->type == IVTV_ENC_STREAM_TYPE_PCM)\n\t\tivtv_vapi(itv, CX2341X_ENC_SCHED_DMA_TO_HOST, 3, 0, 0, 2);\n\tclear_bit(IVTV_F_I_PIO, &itv->i_flags);\n\tif (test_and_clear_bit(IVTV_F_S_DMA_HAS_VBI, &s->s_flags)) {\n\t\ts = &itv->streams[IVTV_ENC_STREAM_TYPE_VBI];\n\t\tdma_post(s);\n\t}\n\twake_up(&itv->dma_waitq);\n}\n\nstatic void ivtv_irq_dma_err(struct ivtv *itv)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tu32 status;\n\n\tdel_timer(&itv->dma_timer);\n\n\tivtv_api_get_data(&itv->enc_mbox, IVTV_MBOX_DMA_END, 2, data);\n\tstatus = read_reg(IVTV_REG_DMASTATUS);\n\tIVTV_DEBUG_WARN(\"DMA ERROR %08x %08x %08x %d\\n\", data[0], data[1],\n\t\t\t\tstatus, itv->cur_dma_stream);\n\t \n\tstatus &= 0x3;\n\tif (status == 0x3)\n\t\twrite_reg(status, IVTV_REG_DMASTATUS);\n\n\tif (!test_bit(IVTV_F_I_UDMA, &itv->i_flags) &&\n\t    itv->cur_dma_stream >= 0 && itv->cur_dma_stream < IVTV_MAX_STREAMS) {\n\t\tstruct ivtv_stream *s = &itv->streams[itv->cur_dma_stream];\n\n\t\tif (s->type >= IVTV_DEC_STREAM_TYPE_MPG) {\n\t\t\t \n\t\t\t \n\t\t\tivtv_dma_dec_start(s);\n\t\t\treturn;\n\t\t} else {\n\t\t\tif ((status & 0x2) == 0) {\n\t\t\t\t \n\t\t\t\titv->dma_timer.expires =\n\t\t\t\t\t\tjiffies + msecs_to_jiffies(600);\n\t\t\t\tadd_timer(&itv->dma_timer);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (itv->dma_retries < 3) {\n\t\t\t\t \n\t\t\t\ts->sg_processed = 0;\n\t\t\t\titv->dma_retries++;\n\t\t\t\tivtv_dma_enc_start_xfer(s);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t \n\t\t}\n\n\t}\n\tif (test_bit(IVTV_F_I_UDMA, &itv->i_flags)) {\n\t\tivtv_udma_start(itv);\n\t\treturn;\n\t}\n\tclear_bit(IVTV_F_I_UDMA, &itv->i_flags);\n\tclear_bit(IVTV_F_I_DMA, &itv->i_flags);\n\titv->cur_dma_stream = -1;\n\twake_up(&itv->dma_waitq);\n}\n\nstatic void ivtv_irq_enc_start_cap(struct ivtv *itv)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tstruct ivtv_stream *s;\n\n\t \n\tivtv_api_get_data(&itv->enc_mbox, IVTV_MBOX_DMA, 7, data);\n\tIVTV_DEBUG_HI_IRQ(\"ENC START CAP %d: %08x %08x\\n\", data[0], data[1], data[2]);\n\n\tif (data[0] > 2 || data[1] == 0 || data[2] == 0) {\n\t\tIVTV_DEBUG_WARN(\"Unknown input: %08x %08x %08x\\n\",\n\t\t\t\tdata[0], data[1], data[2]);\n\t\treturn;\n\t}\n\ts = &itv->streams[ivtv_stream_map[data[0]]];\n\tif (!stream_enc_dma_append(s, data)) {\n\t\tset_bit(ivtv_use_pio(s) ? IVTV_F_S_PIO_PENDING : IVTV_F_S_DMA_PENDING, &s->s_flags);\n\t}\n}\n\nstatic void ivtv_irq_enc_vbi_cap(struct ivtv *itv)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tstruct ivtv_stream *s;\n\n\tIVTV_DEBUG_HI_IRQ(\"ENC START VBI CAP\\n\");\n\ts = &itv->streams[IVTV_ENC_STREAM_TYPE_VBI];\n\n\tif (!stream_enc_dma_append(s, data))\n\t\tset_bit(ivtv_use_pio(s) ? IVTV_F_S_PIO_PENDING : IVTV_F_S_DMA_PENDING, &s->s_flags);\n}\n\nstatic void ivtv_irq_dec_vbi_reinsert(struct ivtv *itv)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tstruct ivtv_stream *s = &itv->streams[IVTV_DEC_STREAM_TYPE_VBI];\n\n\tIVTV_DEBUG_HI_IRQ(\"DEC VBI REINSERT\\n\");\n\tif (test_bit(IVTV_F_S_CLAIMED, &s->s_flags) &&\n\t\t\t!stream_enc_dma_append(s, data)) {\n\t\tset_bit(IVTV_F_S_PIO_PENDING, &s->s_flags);\n\t}\n}\n\nstatic void ivtv_irq_dec_data_req(struct ivtv *itv)\n{\n\tu32 data[CX2341X_MBOX_MAX_DATA];\n\tstruct ivtv_stream *s;\n\n\t \n\n\tif (test_bit(IVTV_F_I_DEC_YUV, &itv->i_flags)) {\n\t\tivtv_api_get_data(&itv->dec_mbox, IVTV_MBOX_DMA, 2, data);\n\t\titv->dma_data_req_size =\n\t\t\t\t 1080 * ((itv->yuv_info.v4l2_src_h + 31) & ~31);\n\t\titv->dma_data_req_offset = data[1];\n\t\tif (atomic_read(&itv->yuv_info.next_dma_frame) >= 0)\n\t\t\tivtv_yuv_frame_complete(itv);\n\t\ts = &itv->streams[IVTV_DEC_STREAM_TYPE_YUV];\n\t}\n\telse {\n\t\tivtv_api_get_data(&itv->dec_mbox, IVTV_MBOX_DMA, 3, data);\n\t\titv->dma_data_req_size = min_t(u32, data[2], 0x10000);\n\t\titv->dma_data_req_offset = data[1];\n\t\ts = &itv->streams[IVTV_DEC_STREAM_TYPE_MPG];\n\t}\n\tIVTV_DEBUG_HI_IRQ(\"DEC DATA REQ %s: %d %08x %u\\n\", s->name, s->q_full.bytesused,\n\t\t       itv->dma_data_req_offset, itv->dma_data_req_size);\n\tif (itv->dma_data_req_size == 0 || s->q_full.bytesused < itv->dma_data_req_size) {\n\t\tset_bit(IVTV_F_S_NEEDS_DATA, &s->s_flags);\n\t}\n\telse {\n\t\tif (test_bit(IVTV_F_I_DEC_YUV, &itv->i_flags))\n\t\t\tivtv_yuv_setup_stream_frame(itv);\n\t\tclear_bit(IVTV_F_S_NEEDS_DATA, &s->s_flags);\n\t\tivtv_queue_move(s, &s->q_full, NULL, &s->q_predma, itv->dma_data_req_size);\n\t\tivtv_dma_stream_dec_prepare(s, itv->dma_data_req_offset + IVTV_DECODER_OFFSET, 0);\n\t}\n}\n\nstatic void ivtv_irq_vsync(struct ivtv *itv)\n{\n\t \n\tunsigned int frame = read_reg(IVTV_REG_DEC_LINE_FIELD) & 1;\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tint last_dma_frame = atomic_read(&yi->next_dma_frame);\n\tstruct yuv_frame_info *f = &yi->new_frame_info[last_dma_frame];\n\n\tif (0) IVTV_DEBUG_IRQ(\"DEC VSYNC\\n\");\n\n\tif (((frame ^ f->sync_field) == 0 &&\n\t\t((itv->last_vsync_field & 1) ^ f->sync_field)) ||\n\t\t\t(frame != (itv->last_vsync_field & 1) && !f->interlaced)) {\n\t\tint next_dma_frame = last_dma_frame;\n\n\t\tif (!(f->interlaced && f->delay && yi->fields_lapsed < 1)) {\n\t\t\tif (next_dma_frame >= 0 && next_dma_frame != atomic_read(&yi->next_fill_frame)) {\n\t\t\t\twrite_reg(yuv_offset[next_dma_frame] >> 4, 0x82c);\n\t\t\t\twrite_reg((yuv_offset[next_dma_frame] + IVTV_YUV_BUFFER_UV_OFFSET) >> 4, 0x830);\n\t\t\t\twrite_reg(yuv_offset[next_dma_frame] >> 4, 0x834);\n\t\t\t\twrite_reg((yuv_offset[next_dma_frame] + IVTV_YUV_BUFFER_UV_OFFSET) >> 4, 0x838);\n\t\t\t\tnext_dma_frame = (next_dma_frame + 1) % IVTV_YUV_BUFFERS;\n\t\t\t\tatomic_set(&yi->next_dma_frame, next_dma_frame);\n\t\t\t\tyi->fields_lapsed = -1;\n\t\t\t\tyi->running = 1;\n\t\t\t}\n\t\t}\n\t}\n\tif (frame != (itv->last_vsync_field & 1)) {\n\t\tstatic const struct v4l2_event evtop = {\n\t\t\t.type = V4L2_EVENT_VSYNC,\n\t\t\t.u.vsync.field = V4L2_FIELD_TOP,\n\t\t};\n\t\tstatic const struct v4l2_event evbottom = {\n\t\t\t.type = V4L2_EVENT_VSYNC,\n\t\t\t.u.vsync.field = V4L2_FIELD_BOTTOM,\n\t\t};\n\t\tstruct ivtv_stream *s = ivtv_get_output_stream(itv);\n\n\t\titv->last_vsync_field += 1;\n\t\tif (frame == 0) {\n\t\t\tclear_bit(IVTV_F_I_VALID_DEC_TIMINGS, &itv->i_flags);\n\t\t\tclear_bit(IVTV_F_I_EV_VSYNC_FIELD, &itv->i_flags);\n\t\t}\n\t\telse {\n\t\t\tset_bit(IVTV_F_I_EV_VSYNC_FIELD, &itv->i_flags);\n\t\t}\n\t\tif (test_bit(IVTV_F_I_EV_VSYNC_ENABLED, &itv->i_flags)) {\n\t\t\tset_bit(IVTV_F_I_EV_VSYNC, &itv->i_flags);\n\t\t\twake_up(&itv->event_waitq);\n\t\t\tif (s)\n\t\t\t\twake_up(&s->waitq);\n\t\t}\n\t\tif (s && s->vdev.v4l2_dev)\n\t\t\tv4l2_event_queue(&s->vdev, frame ? &evtop : &evbottom);\n\t\twake_up(&itv->vsync_waitq);\n\n\t\t \n\t\tif (frame && (itv->output_mode == OUT_PASSTHROUGH ||\n\t\t\ttest_bit(IVTV_F_I_UPDATE_WSS, &itv->i_flags) ||\n\t\t\ttest_bit(IVTV_F_I_UPDATE_VPS, &itv->i_flags) ||\n\t\t\ttest_bit(IVTV_F_I_UPDATE_CC, &itv->i_flags))) {\n\t\t\tset_bit(IVTV_F_I_WORK_HANDLER_VBI, &itv->i_flags);\n\t\t\tset_bit(IVTV_F_I_HAVE_WORK, &itv->i_flags);\n\t\t}\n\n\t\t \n\t\tif (yi->running && (yi->yuv_forced_update || f->update)) {\n\t\t\tif (!f->update) {\n\t\t\t\tlast_dma_frame =\n\t\t\t\t\t(u8)(atomic_read(&yi->next_dma_frame) -\n\t\t\t\t\t\t 1) % IVTV_YUV_BUFFERS;\n\t\t\t\tf = &yi->new_frame_info[last_dma_frame];\n\t\t\t}\n\n\t\t\tif (f->src_w) {\n\t\t\t\tyi->update_frame = last_dma_frame;\n\t\t\t\tf->update = 0;\n\t\t\t\tyi->yuv_forced_update = 0;\n\t\t\t\tset_bit(IVTV_F_I_WORK_HANDLER_YUV, &itv->i_flags);\n\t\t\t\tset_bit(IVTV_F_I_HAVE_WORK, &itv->i_flags);\n\t\t\t}\n\t\t}\n\n\t\tyi->fields_lapsed++;\n\t}\n}\n\n#define IVTV_IRQ_DMA (IVTV_IRQ_DMA_READ | IVTV_IRQ_ENC_DMA_COMPLETE | IVTV_IRQ_DMA_ERR | IVTV_IRQ_ENC_START_CAP | IVTV_IRQ_ENC_VBI_CAP | IVTV_IRQ_DEC_DATA_REQ | IVTV_IRQ_DEC_VBI_RE_INSERT)\n\nirqreturn_t ivtv_irq_handler(int irq, void *dev_id)\n{\n\tstruct ivtv *itv = (struct ivtv *)dev_id;\n\tu32 combo;\n\tu32 stat;\n\tint i;\n\tu8 vsync_force = 0;\n\n\tspin_lock(&itv->dma_reg_lock);\n\t \n\tstat = read_reg(IVTV_REG_IRQSTATUS);\n\n\tcombo = ~itv->irqmask & stat;\n\n\t \n\tif (combo) write_reg(combo, IVTV_REG_IRQSTATUS);\n\n\tif (0 == combo) {\n\t\t \n\t\tif (~itv->irqmask & IVTV_IRQ_DEC_VSYNC) {\n\t\t\t \n\t\t\tif ((itv->last_vsync_field & 1) !=\n\t\t\t    (read_reg(IVTV_REG_DEC_LINE_FIELD) & 1)) {\n\t\t\t\t \n\t\t\t\tIVTV_DEBUG_YUV(\"VSync interrupt missed %d\\n\",\n\t\t\t\t       read_reg(IVTV_REG_DEC_LINE_FIELD) >> 16);\n\t\t\t\tvsync_force = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (!vsync_force) {\n\t\t\t \n\t\t\tspin_unlock(&itv->dma_reg_lock);\n\t\t\treturn IRQ_NONE;\n\t\t}\n\t}\n\n\t \n\tif (combo & ~0xff6d0400)\n\t\tIVTV_DEBUG_HI_IRQ(\"======= valid IRQ bits: 0x%08x ======\\n\", combo);\n\n\tif (combo & IVTV_IRQ_DEC_DMA_COMPLETE) {\n\t\tIVTV_DEBUG_HI_IRQ(\"DEC DMA COMPLETE\\n\");\n\t}\n\n\tif (combo & IVTV_IRQ_DMA_READ) {\n\t\tivtv_irq_dma_read(itv);\n\t}\n\n\tif (combo & IVTV_IRQ_ENC_DMA_COMPLETE) {\n\t\tivtv_irq_enc_dma_complete(itv);\n\t}\n\n\tif (combo & IVTV_IRQ_ENC_PIO_COMPLETE) {\n\t\tivtv_irq_enc_pio_complete(itv);\n\t}\n\n\tif (combo & IVTV_IRQ_DMA_ERR) {\n\t\tivtv_irq_dma_err(itv);\n\t}\n\n\tif (combo & IVTV_IRQ_ENC_START_CAP) {\n\t\tivtv_irq_enc_start_cap(itv);\n\t}\n\n\tif (combo & IVTV_IRQ_ENC_VBI_CAP) {\n\t\tivtv_irq_enc_vbi_cap(itv);\n\t}\n\n\tif (combo & IVTV_IRQ_DEC_VBI_RE_INSERT) {\n\t\tivtv_irq_dec_vbi_reinsert(itv);\n\t}\n\n\tif (combo & IVTV_IRQ_ENC_EOS) {\n\t\tIVTV_DEBUG_IRQ(\"ENC EOS\\n\");\n\t\tset_bit(IVTV_F_I_EOS, &itv->i_flags);\n\t\twake_up(&itv->eos_waitq);\n\t}\n\n\tif (combo & IVTV_IRQ_DEC_DATA_REQ) {\n\t\tivtv_irq_dec_data_req(itv);\n\t}\n\n\t \n\tif (~itv->irqmask & IVTV_IRQ_DEC_VSYNC) {\n\t\tivtv_irq_vsync(itv);\n\t}\n\n\tif (combo & IVTV_IRQ_ENC_VIM_RST) {\n\t\tIVTV_DEBUG_IRQ(\"VIM RST\\n\");\n\t\t \n\t}\n\n\tif (combo & IVTV_IRQ_DEC_AUD_MODE_CHG) {\n\t\tIVTV_DEBUG_INFO(\"Stereo mode changed\\n\");\n\t}\n\n\tif ((combo & IVTV_IRQ_DMA) && !test_bit(IVTV_F_I_DMA, &itv->i_flags)) {\n\t\titv->irq_rr_idx++;\n\t\tfor (i = 0; i < IVTV_MAX_STREAMS; i++) {\n\t\t\tint idx = (i + itv->irq_rr_idx) % IVTV_MAX_STREAMS;\n\t\t\tstruct ivtv_stream *s = &itv->streams[idx];\n\n\t\t\tif (!test_and_clear_bit(IVTV_F_S_DMA_PENDING, &s->s_flags))\n\t\t\t\tcontinue;\n\t\t\tif (s->type >= IVTV_DEC_STREAM_TYPE_MPG)\n\t\t\t\tivtv_dma_dec_start(s);\n\t\t\telse\n\t\t\t\tivtv_dma_enc_start(s);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (i == IVTV_MAX_STREAMS &&\n\t\t    test_bit(IVTV_F_I_UDMA_PENDING, &itv->i_flags))\n\t\t\tivtv_udma_start(itv);\n\t}\n\n\tif ((combo & IVTV_IRQ_DMA) && !test_bit(IVTV_F_I_PIO, &itv->i_flags)) {\n\t\titv->irq_rr_idx++;\n\t\tfor (i = 0; i < IVTV_MAX_STREAMS; i++) {\n\t\t\tint idx = (i + itv->irq_rr_idx) % IVTV_MAX_STREAMS;\n\t\t\tstruct ivtv_stream *s = &itv->streams[idx];\n\n\t\t\tif (!test_and_clear_bit(IVTV_F_S_PIO_PENDING, &s->s_flags))\n\t\t\t\tcontinue;\n\t\t\tif (s->type == IVTV_DEC_STREAM_TYPE_VBI || s->type < IVTV_DEC_STREAM_TYPE_MPG)\n\t\t\t\tivtv_dma_enc_start(s);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (test_and_clear_bit(IVTV_F_I_HAVE_WORK, &itv->i_flags)) {\n\t\tkthread_queue_work(&itv->irq_worker, &itv->irq_work);\n\t}\n\n\tspin_unlock(&itv->dma_reg_lock);\n\n\t \n\treturn vsync_force ? IRQ_NONE : IRQ_HANDLED;\n}\n\nvoid ivtv_unfinished_dma(struct timer_list *t)\n{\n\tstruct ivtv *itv = from_timer(itv, t, dma_timer);\n\n\tif (!test_bit(IVTV_F_I_DMA, &itv->i_flags))\n\t\treturn;\n\tIVTV_ERR(\"DMA TIMEOUT %08x %d\\n\", read_reg(IVTV_REG_DMASTATUS), itv->cur_dma_stream);\n\n\twrite_reg(read_reg(IVTV_REG_DMASTATUS) & 3, IVTV_REG_DMASTATUS);\n\tclear_bit(IVTV_F_I_UDMA, &itv->i_flags);\n\tclear_bit(IVTV_F_I_DMA, &itv->i_flags);\n\titv->cur_dma_stream = -1;\n\twake_up(&itv->dma_waitq);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}