{
  "module_name": "ivtv-yuv.c",
  "hash_id": "032921d417973c106ded60fb38d8061eccf9371e362a19806b5aa515d4b8fe5f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/ivtv/ivtv-yuv.c",
  "human_readable_source": "\n \n\n#include \"ivtv-driver.h\"\n#include \"ivtv-udma.h\"\n#include \"ivtv-yuv.h\"\n\n \nconst u32 yuv_offset[IVTV_YUV_BUFFERS] = {\n\t0x001a8600,\n\t0x00240400,\n\t0x002d8200,\n\t0x00370000,\n\t0x00029000,\n\t0x000C0E00,\n\t0x006B0400,\n\t0x00748200\n};\n\nstatic int ivtv_yuv_prep_user_dma(struct ivtv *itv, struct ivtv_user_dma *dma,\n\t\t\t\t  struct ivtv_dma_frame *args)\n{\n\tstruct ivtv_dma_page_info y_dma;\n\tstruct ivtv_dma_page_info uv_dma;\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tu8 frame = yi->draw_frame;\n\tstruct yuv_frame_info *f = &yi->new_frame_info[frame];\n\tint y_pages, uv_pages;\n\tunsigned long y_buffer_offset, uv_buffer_offset;\n\tint y_decode_height, uv_decode_height, y_size;\n\n\ty_buffer_offset = IVTV_DECODER_OFFSET + yuv_offset[frame];\n\tuv_buffer_offset = y_buffer_offset + IVTV_YUV_BUFFER_UV_OFFSET;\n\n\ty_decode_height = uv_decode_height = f->src_h + f->src_y;\n\n\tif (f->offset_y)\n\t\ty_buffer_offset += 720 * 16;\n\n\tif (y_decode_height & 15)\n\t\ty_decode_height = (y_decode_height + 16) & ~15;\n\n\tif (uv_decode_height & 31)\n\t\tuv_decode_height = (uv_decode_height + 32) & ~31;\n\n\ty_size = 720 * y_decode_height;\n\n\t \n\tif (dma->SG_length || dma->page_count) {\n\t\tIVTV_DEBUG_WARN\n\t\t    (\"prep_user_dma: SG_length %d page_count %d still full?\\n\",\n\t\t     dma->SG_length, dma->page_count);\n\t\treturn -EBUSY;\n\t}\n\n\tivtv_udma_get_page_info (&y_dma, (unsigned long)args->y_source, 720 * y_decode_height);\n\tivtv_udma_get_page_info (&uv_dma, (unsigned long)args->uv_source, 360 * uv_decode_height);\n\n\t \n\ty_pages = pin_user_pages_unlocked(y_dma.uaddr,\n\t\t\ty_dma.page_count, &dma->map[0], 0);\n\tuv_pages = 0;  \n\tif (y_pages == y_dma.page_count) {\n\t\tuv_pages = pin_user_pages_unlocked(uv_dma.uaddr,\n\t\t\t\tuv_dma.page_count, &dma->map[y_pages], 0);\n\t}\n\n\tif (y_pages != y_dma.page_count || uv_pages != uv_dma.page_count) {\n\t\tint rc = -EFAULT;\n\n\t\tif (y_pages == y_dma.page_count) {\n\t\t\tIVTV_DEBUG_WARN\n\t\t\t\t(\"failed to map uv user pages, returned %d expecting %d\\n\",\n\t\t\t\t uv_pages, uv_dma.page_count);\n\n\t\t\tif (uv_pages >= 0) {\n\t\t\t\tunpin_user_pages(&dma->map[y_pages], uv_pages);\n\t\t\t\trc = -EFAULT;\n\t\t\t} else {\n\t\t\t\trc = uv_pages;\n\t\t\t}\n\t\t} else {\n\t\t\tIVTV_DEBUG_WARN\n\t\t\t\t(\"failed to map y user pages, returned %d expecting %d\\n\",\n\t\t\t\t y_pages, y_dma.page_count);\n\t\t}\n\t\tif (y_pages >= 0) {\n\t\t\tunpin_user_pages(dma->map, y_pages);\n\t\t\t \n\t\t} else {\n\t\t\trc = y_pages;\n\t\t}\n\t\treturn rc;\n\t}\n\n\tdma->page_count = y_pages + uv_pages;\n\n\t \n\tif (ivtv_udma_fill_sg_list (dma, &uv_dma, ivtv_udma_fill_sg_list (dma, &y_dma, 0)) < 0) {\n\t\tIVTV_DEBUG_WARN(\"could not allocate bounce buffers for highmem userspace buffers\\n\");\n\t\tunpin_user_pages(dma->map, dma->page_count);\n\t\tdma->page_count = 0;\n\t\treturn -ENOMEM;\n\t}\n\tdma->SG_length = dma_map_sg(&itv->pdev->dev, dma->SGlist,\n\t\t\t\t    dma->page_count, DMA_TO_DEVICE);\n\n\t \n\tivtv_udma_fill_sg_array(dma, y_buffer_offset, uv_buffer_offset, y_size);\n\n\t \n\tif (f->offset_y && yi->blanking_dmaptr) {\n\t\tdma->SGarray[dma->SG_length].size = cpu_to_le32(720*16);\n\t\tdma->SGarray[dma->SG_length].src = cpu_to_le32(yi->blanking_dmaptr);\n\t\tdma->SGarray[dma->SG_length].dst = cpu_to_le32(IVTV_DECODER_OFFSET + yuv_offset[frame]);\n\t\tdma->SG_length++;\n\t}\n\n\t \n\tdma->SGarray[dma->SG_length - 1].size |= cpu_to_le32(0x80000000);\n\n\tivtv_udma_sync_for_device(itv);\n\treturn 0;\n}\n\n \nint ivtv_yuv_filter_check(struct ivtv *itv)\n{\n\tint i, y, uv;\n\n\tfor (i = 0, y = 16, uv = 4; i < 16; i++, y += 24, uv += 12) {\n\t\tif ((read_dec(IVTV_YUV_HORIZONTAL_FILTER_OFFSET + y) != i << 16) ||\n\t\t    (read_dec(IVTV_YUV_VERTICAL_FILTER_OFFSET + uv) != i << 16)) {\n\t\t\tIVTV_WARN (\"YUV filter table not found in firmware.\\n\");\n\t\t\treturn -1;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic void ivtv_yuv_filter(struct ivtv *itv, int h_filter, int v_filter_1, int v_filter_2)\n{\n\tu32 i, line;\n\n\t \n\tif (h_filter > -1) {\n\t\tif (h_filter > 4)\n\t\t\th_filter = 4;\n\t\ti = IVTV_YUV_HORIZONTAL_FILTER_OFFSET + (h_filter * 384);\n\t\tfor (line = 0; line < 16; line++) {\n\t\t\twrite_reg(read_dec(i), 0x02804);\n\t\t\twrite_reg(read_dec(i), 0x0281c);\n\t\t\ti += 4;\n\t\t\twrite_reg(read_dec(i), 0x02808);\n\t\t\twrite_reg(read_dec(i), 0x02820);\n\t\t\ti += 4;\n\t\t\twrite_reg(read_dec(i), 0x0280c);\n\t\t\twrite_reg(read_dec(i), 0x02824);\n\t\t\ti += 4;\n\t\t\twrite_reg(read_dec(i), 0x02810);\n\t\t\twrite_reg(read_dec(i), 0x02828);\n\t\t\ti += 4;\n\t\t\twrite_reg(read_dec(i), 0x02814);\n\t\t\twrite_reg(read_dec(i), 0x0282c);\n\t\t\ti += 8;\n\t\t\twrite_reg(0, 0x02818);\n\t\t\twrite_reg(0, 0x02830);\n\t\t}\n\t\tIVTV_DEBUG_YUV(\"h_filter -> %d\\n\", h_filter);\n\t}\n\n\tif (v_filter_1 > -1) {\n\t\tif (v_filter_1 > 4)\n\t\t\tv_filter_1 = 4;\n\t\ti = IVTV_YUV_VERTICAL_FILTER_OFFSET + (v_filter_1 * 192);\n\t\tfor (line = 0; line < 16; line++) {\n\t\t\twrite_reg(read_dec(i), 0x02900);\n\t\t\ti += 4;\n\t\t\twrite_reg(read_dec(i), 0x02904);\n\t\t\ti += 8;\n\t\t\twrite_reg(0, 0x02908);\n\t\t}\n\t\tIVTV_DEBUG_YUV(\"v_filter_1 -> %d\\n\", v_filter_1);\n\t}\n\n\tif (v_filter_2 > -1) {\n\t\tif (v_filter_2 > 4)\n\t\t\tv_filter_2 = 4;\n\t\ti = IVTV_YUV_VERTICAL_FILTER_OFFSET + (v_filter_2 * 192);\n\t\tfor (line = 0; line < 16; line++) {\n\t\t\twrite_reg(read_dec(i), 0x0290c);\n\t\t\ti += 4;\n\t\t\twrite_reg(read_dec(i), 0x02910);\n\t\t\ti += 8;\n\t\t\twrite_reg(0, 0x02914);\n\t\t}\n\t\tIVTV_DEBUG_YUV(\"v_filter_2 -> %d\\n\", v_filter_2);\n\t}\n}\n\nstatic void ivtv_yuv_handle_horizontal(struct ivtv *itv, struct yuv_frame_info *f)\n{\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tu32 reg_2834, reg_2838, reg_283c;\n\tu32 reg_2844, reg_2854, reg_285c;\n\tu32 reg_2864, reg_2874, reg_2890;\n\tu32 reg_2870, reg_2870_base, reg_2870_offset;\n\tint x_cutoff;\n\tint h_filter;\n\tu32 master_width;\n\n\tIVTV_DEBUG_WARN\n\t    (\"Adjust to width %d src_w %d dst_w %d src_x %d dst_x %d\\n\",\n\t     f->tru_w, f->src_w, f->dst_w, f->src_x, f->dst_x);\n\n\t \n\tx_cutoff = f->src_w + f->src_x;\n\n\t \n\treg_2834 = f->dst_w;\n\treg_2838 = reg_2834;\n\n\t \n\treg_2890 = f->dst_x;\n\n\t \n\treg_2870 = 0;\n\n\t \n\tif (f->vis_w == 720) {\n\t\tif ((f->tru_x - f->pan_x > -1) && (f->tru_x - f->pan_x <= 40) && (f->dst_w >= 680))\n\t\t\treg_2870 = 10 - (f->tru_x - f->pan_x) / 4;\n\t\telse if ((f->tru_x - f->pan_x < 0) && (f->tru_x - f->pan_x >= -20) && (f->dst_w >= 660))\n\t\t\treg_2870 = (10 + (f->tru_x - f->pan_x) / 2);\n\n\t\tif (f->dst_w >= f->src_w)\n\t\t\treg_2870 = reg_2870 << 16 | reg_2870;\n\t\telse\n\t\t\treg_2870 = ((reg_2870 & ~1) << 15) | (reg_2870 & ~1);\n\t}\n\n\tif (f->dst_w < f->src_w)\n\t\treg_2870 = 0x000d000e - reg_2870;\n\telse\n\t\treg_2870 = 0x0012000e - reg_2870;\n\n\t \n\treg_2870_offset = (f->src_x * ((f->dst_w << 21) / f->src_w)) >> 19;\n\n\tif (f->dst_w >= f->src_w) {\n\t\tx_cutoff &= ~1;\n\t\tmaster_width = (f->src_w * 0x00200000) / (f->dst_w);\n\t\tif (master_width * f->dst_w != f->src_w * 0x00200000)\n\t\t\tmaster_width++;\n\t\treg_2834 = (reg_2834 << 16) | x_cutoff;\n\t\treg_2838 = (reg_2838 << 16) | x_cutoff;\n\t\treg_283c = master_width >> 2;\n\t\treg_2844 = master_width >> 2;\n\t\treg_2854 = master_width;\n\t\treg_285c = master_width >> 1;\n\t\treg_2864 = master_width >> 1;\n\n\t\t \n\t\tif (f->dst_w > f->src_w)\n\t\t\treg_2870_base = ((f->dst_w - f->src_w)<<16) / (f->src_w <<14);\n\t\telse\n\t\t\treg_2870_base = 0;\n\n\t\treg_2870 += (((reg_2870_offset << 14) & 0xFFFF0000) | reg_2870_offset >> 2) + (reg_2870_base << 17 | reg_2870_base);\n\t\treg_2874 = 0;\n\t} else if (f->dst_w < f->src_w / 2) {\n\t\tmaster_width = (f->src_w * 0x00080000) / f->dst_w;\n\t\tif (master_width * f->dst_w != f->src_w * 0x00080000)\n\t\t\tmaster_width++;\n\t\treg_2834 = (reg_2834 << 16) | x_cutoff;\n\t\treg_2838 = (reg_2838 << 16) | x_cutoff;\n\t\treg_283c = master_width >> 2;\n\t\treg_2844 = master_width >> 1;\n\t\treg_2854 = master_width;\n\t\treg_285c = master_width >> 1;\n\t\treg_2864 = master_width >> 1;\n\t\treg_2870 += ((reg_2870_offset << 15) & 0xFFFF0000) | reg_2870_offset;\n\t\treg_2870 += (5 - (((f->src_w + f->src_w / 2) - 1) / f->dst_w)) << 16;\n\t\treg_2874 = 0x00000012;\n\t} else {\n\t\tmaster_width = (f->src_w * 0x00100000) / f->dst_w;\n\t\tif (master_width * f->dst_w != f->src_w * 0x00100000)\n\t\t\tmaster_width++;\n\t\treg_2834 = (reg_2834 << 16) | x_cutoff;\n\t\treg_2838 = (reg_2838 << 16) | x_cutoff;\n\t\treg_283c = master_width >> 2;\n\t\treg_2844 = master_width >> 1;\n\t\treg_2854 = master_width;\n\t\treg_285c = master_width >> 1;\n\t\treg_2864 = master_width >> 1;\n\t\treg_2870 += ((reg_2870_offset << 14) & 0xFFFF0000) | reg_2870_offset >> 1;\n\t\treg_2870 += (5 - (((f->src_w * 3) - 1) / f->dst_w)) << 16;\n\t\treg_2874 = 0x00000001;\n\t}\n\n\t \n\tif (f->src_w == f->dst_w) {\n\t\t \n\t\th_filter = 0;\n\t} else {\n\t\t \n\t\th_filter = ((f->src_w << 16) / f->dst_w) >> 15;\n\t\th_filter = (h_filter >> 1) + (h_filter & 1);\n\t\t \n\t\th_filter += !h_filter;\n\t}\n\n\twrite_reg(reg_2834, 0x02834);\n\twrite_reg(reg_2838, 0x02838);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2834 %08x->%08x 0x2838 %08x->%08x\\n\",\n\t\t       yi->reg_2834, reg_2834, yi->reg_2838, reg_2838);\n\n\twrite_reg(reg_283c, 0x0283c);\n\twrite_reg(reg_2844, 0x02844);\n\n\tIVTV_DEBUG_YUV(\"Update reg 0x283c %08x->%08x 0x2844 %08x->%08x\\n\",\n\t\t       yi->reg_283c, reg_283c, yi->reg_2844, reg_2844);\n\n\twrite_reg(0x00080514, 0x02840);\n\twrite_reg(0x00100514, 0x02848);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2840 %08x->%08x 0x2848 %08x->%08x\\n\",\n\t\t       yi->reg_2840, 0x00080514, yi->reg_2848, 0x00100514);\n\n\twrite_reg(reg_2854, 0x02854);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2854 %08x->%08x \\n\",\n\t\t       yi->reg_2854, reg_2854);\n\n\twrite_reg(reg_285c, 0x0285c);\n\twrite_reg(reg_2864, 0x02864);\n\tIVTV_DEBUG_YUV(\"Update reg 0x285c %08x->%08x 0x2864 %08x->%08x\\n\",\n\t\t       yi->reg_285c, reg_285c, yi->reg_2864, reg_2864);\n\n\twrite_reg(reg_2874, 0x02874);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2874 %08x->%08x\\n\",\n\t\t       yi->reg_2874, reg_2874);\n\n\twrite_reg(reg_2870, 0x02870);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2870 %08x->%08x\\n\",\n\t\t       yi->reg_2870, reg_2870);\n\n\twrite_reg(reg_2890, 0x02890);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2890 %08x->%08x\\n\",\n\t\t       yi->reg_2890, reg_2890);\n\n\t \n\tif (h_filter != yi->h_filter) {\n\t\tivtv_yuv_filter(itv, h_filter, -1, -1);\n\t\tyi->h_filter = h_filter;\n\t}\n}\n\nstatic void ivtv_yuv_handle_vertical(struct ivtv *itv, struct yuv_frame_info *f)\n{\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tu32 master_height;\n\tu32 reg_2918, reg_291c, reg_2920, reg_2928;\n\tu32 reg_2930, reg_2934, reg_293c;\n\tu32 reg_2940, reg_2944, reg_294c;\n\tu32 reg_2950, reg_2954, reg_2958, reg_295c;\n\tu32 reg_2960, reg_2964, reg_2968, reg_296c;\n\tu32 reg_289c;\n\tu32 src_major_y, src_minor_y;\n\tu32 src_major_uv, src_minor_uv;\n\tu32 reg_2964_base, reg_2968_base;\n\tint v_filter_1, v_filter_2;\n\n\tIVTV_DEBUG_WARN\n\t    (\"Adjust to height %d src_h %d dst_h %d src_y %d dst_y %d\\n\",\n\t     f->tru_h, f->src_h, f->dst_h, f->src_y, f->dst_y);\n\n\t \n\tIVTV_DEBUG_YUV(\"Scaling mode Y: %s\\n\",\n\t\t       f->interlaced_y ? \"Interlaced\" : \"Progressive\");\n\n\tIVTV_DEBUG_YUV(\"Scaling mode UV: %s\\n\",\n\t\t       f->interlaced_uv ? \"Interlaced\" : \"Progressive\");\n\n\t \n\tIVTV_DEBUG_WARN(\"Source video: %s\\n\",\n\t\t\tf->interlaced ? \"Interlaced\" : \"Progressive\");\n\n\t \n\tif (f->src_y < 8) {\n\t\tsrc_minor_uv = f->src_y;\n\t\tsrc_major_uv = 0;\n\t} else {\n\t\tsrc_minor_uv = 8;\n\t\tsrc_major_uv = f->src_y - 8;\n\t}\n\n\tsrc_minor_y = src_minor_uv;\n\tsrc_major_y = src_major_uv;\n\n\tif (f->offset_y)\n\t\tsrc_minor_y += 16;\n\n\tif (f->interlaced_y)\n\t\treg_2918 = (f->dst_h << 16) | (f->src_h + src_minor_y);\n\telse\n\t\treg_2918 = (f->dst_h << 16) | ((f->src_h + src_minor_y) << 1);\n\n\tif (f->interlaced_uv)\n\t\treg_291c = (f->dst_h << 16) | ((f->src_h + src_minor_uv) >> 1);\n\telse\n\t\treg_291c = (f->dst_h << 16) | (f->src_h + src_minor_uv);\n\n\treg_2964_base = (src_minor_y * ((f->dst_h << 16) / f->src_h)) >> 14;\n\treg_2968_base = (src_minor_uv * ((f->dst_h << 16) / f->src_h)) >> 14;\n\n\tif (f->dst_h / 2 >= f->src_h && !f->interlaced_y) {\n\t\tmaster_height = (f->src_h * 0x00400000) / f->dst_h;\n\t\tif ((f->src_h * 0x00400000) - (master_height * f->dst_h) >= f->dst_h / 2)\n\t\t\tmaster_height++;\n\t\treg_2920 = master_height >> 2;\n\t\treg_2928 = master_height >> 3;\n\t\treg_2930 = master_height;\n\t\treg_2940 = master_height >> 1;\n\t\treg_2964_base >>= 3;\n\t\treg_2968_base >>= 3;\n\t\treg_296c = 0x00000000;\n\t} else if (f->dst_h >= f->src_h) {\n\t\tmaster_height = (f->src_h * 0x00400000) / f->dst_h;\n\t\tmaster_height = (master_height >> 1) + (master_height & 1);\n\t\treg_2920 = master_height >> 2;\n\t\treg_2928 = master_height >> 2;\n\t\treg_2930 = master_height;\n\t\treg_2940 = master_height >> 1;\n\t\treg_296c = 0x00000000;\n\t\tif (f->interlaced_y) {\n\t\t\treg_2964_base >>= 3;\n\t\t} else {\n\t\t\treg_296c++;\n\t\t\treg_2964_base >>= 2;\n\t\t}\n\t\tif (f->interlaced_uv)\n\t\t\treg_2928 >>= 1;\n\t\treg_2968_base >>= 3;\n\t} else if (f->dst_h >= f->src_h / 2) {\n\t\tmaster_height = (f->src_h * 0x00200000) / f->dst_h;\n\t\tmaster_height = (master_height >> 1) + (master_height & 1);\n\t\treg_2920 = master_height >> 2;\n\t\treg_2928 = master_height >> 2;\n\t\treg_2930 = master_height;\n\t\treg_2940 = master_height;\n\t\treg_296c = 0x00000101;\n\t\tif (f->interlaced_y) {\n\t\t\treg_2964_base >>= 2;\n\t\t} else {\n\t\t\treg_296c++;\n\t\t\treg_2964_base >>= 1;\n\t\t}\n\t\tif (f->interlaced_uv)\n\t\t\treg_2928 >>= 1;\n\t\treg_2968_base >>= 2;\n\t} else {\n\t\tmaster_height = (f->src_h * 0x00100000) / f->dst_h;\n\t\tmaster_height = (master_height >> 1) + (master_height & 1);\n\t\treg_2920 = master_height >> 2;\n\t\treg_2928 = master_height >> 2;\n\t\treg_2930 = master_height;\n\t\treg_2940 = master_height;\n\t\treg_2964_base >>= 1;\n\t\treg_2968_base >>= 2;\n\t\treg_296c = 0x00000102;\n\t}\n\n\t \n\tif (f->src_h == f->dst_h) {\n\t\treg_2934 = 0x00020000;\n\t\treg_293c = 0x00100000;\n\t\treg_2944 = 0x00040000;\n\t\treg_294c = 0x000b0000;\n\t} else {\n\t\treg_2934 = 0x00000FF0;\n\t\treg_293c = 0x00000FF0;\n\t\treg_2944 = 0x00000FF0;\n\t\treg_294c = 0x00000FF0;\n\t}\n\n\t \n\treg_2950 = 0x00010000 + src_major_y;\n\tif (f->interlaced_y)\n\t\treg_2950 += 0x00010000;\n\treg_2954 = reg_2950 + 1;\n\n\treg_2958 = 0x00010000 + (src_major_y >> 1);\n\tif (f->interlaced_uv)\n\t\treg_2958 += 0x00010000;\n\treg_295c = reg_2958 + 1;\n\n\tif (yi->decode_height == 480)\n\t\treg_289c = 0x011e0017;\n\telse\n\t\treg_289c = 0x01500017;\n\n\tif (f->dst_y < 0)\n\t\treg_289c = (reg_289c - ((f->dst_y & ~1)<<15))-(f->dst_y >>1);\n\telse\n\t\treg_289c = (reg_289c + ((f->dst_y & ~1)<<15))+(f->dst_y >>1);\n\n\t \n\treg_2960 = ((src_minor_y + f->src_h + src_major_y) - 1) |\n\t\t(((src_minor_uv + f->src_h + src_major_uv - 1) & ~1) << 15);\n\n\t \n\tif (f->src_h == f->dst_h) {\n\t\treg_2964 = 1;\n\t} else {\n\t\treg_2964 = 2 + ((f->dst_h << 1) / f->src_h);\n\t\treg_2964 = (reg_2964 >> 1) + (reg_2964 & 1);\n\t}\n\treg_2968 = (reg_2964 << 16) + reg_2964 + (reg_2964 >> 1);\n\treg_2964 = (reg_2964 << 16) + reg_2964 + (reg_2964 * 46 / 94);\n\n\t \n\treg_2964 = 0x00010001 + ((reg_2964 & 0x0000FFFF) - (reg_2964 >> 16));\n\treg_2968 = 0x00010001 + ((reg_2968 & 0x0000FFFF) - (reg_2968 >> 16));\n\n\t \n\tif ((reg_2964 != 0x00010001) && (f->dst_h / 2 <= f->src_h))\n\t\treg_2964 = (reg_2964 & 0xFFFF0000) + ((reg_2964 & 0x0000FFFF) / 2);\n\n\tif (!f->interlaced_y)\n\t\treg_2964 -= 0x00010001;\n\tif (!f->interlaced_uv)\n\t\treg_2968 -= 0x00010001;\n\n\treg_2964 += ((reg_2964_base << 16) | reg_2964_base);\n\treg_2968 += ((reg_2968_base << 16) | reg_2968_base);\n\n\t \n\tif (f->src_h == f->dst_h) {\n\t\t \n\t\tv_filter_1 = 0;\n\t\tv_filter_2 = 1;\n\t} else {\n\t\t \n\t\tv_filter_1 = ((f->src_h << 16) / f->dst_h) >> 15;\n\t\tv_filter_1 = (v_filter_1 >> 1) + (v_filter_1 & 1);\n\t\t \n\t\tv_filter_1 += !v_filter_1;\n\t\tv_filter_2 = v_filter_1;\n\t}\n\n\twrite_reg(reg_2934, 0x02934);\n\twrite_reg(reg_293c, 0x0293c);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2934 %08x->%08x 0x293c %08x->%08x\\n\",\n\t\t       yi->reg_2934, reg_2934, yi->reg_293c, reg_293c);\n\twrite_reg(reg_2944, 0x02944);\n\twrite_reg(reg_294c, 0x0294c);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2944 %08x->%08x 0x294c %08x->%08x\\n\",\n\t\t       yi->reg_2944, reg_2944, yi->reg_294c, reg_294c);\n\n\t \n \n \n\n\twrite_reg(reg_2930, 0x02938);\n\twrite_reg(reg_2930, 0x02930);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2930 %08x->%08x 0x2938 %08x->%08x\\n\",\n\t\t       yi->reg_2930, reg_2930, yi->reg_2938, reg_2930);\n\n\twrite_reg(reg_2928, 0x02928);\n\twrite_reg(reg_2928 + 0x514, 0x0292C);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2928 %08x->%08x 0x292c %08x->%08x\\n\",\n\t\t       yi->reg_2928, reg_2928, yi->reg_292c, reg_2928 + 0x514);\n\n\twrite_reg(reg_2920, 0x02920);\n\twrite_reg(reg_2920 + 0x514, 0x02924);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2920 %08x->%08x 0x2924 %08x->%08x\\n\",\n\t\t       yi->reg_2920, reg_2920, yi->reg_2924, reg_2920 + 0x514);\n\n\twrite_reg(reg_2918, 0x02918);\n\twrite_reg(reg_291c, 0x0291C);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2918 %08x->%08x 0x291C %08x->%08x\\n\",\n\t\t       yi->reg_2918, reg_2918, yi->reg_291c, reg_291c);\n\n\twrite_reg(reg_296c, 0x0296c);\n\tIVTV_DEBUG_YUV(\"Update reg 0x296c %08x->%08x\\n\",\n\t\t       yi->reg_296c, reg_296c);\n\n\twrite_reg(reg_2940, 0x02948);\n\twrite_reg(reg_2940, 0x02940);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2940 %08x->%08x 0x2948 %08x->%08x\\n\",\n\t\t       yi->reg_2940, reg_2940, yi->reg_2948, reg_2940);\n\n\twrite_reg(reg_2950, 0x02950);\n\twrite_reg(reg_2954, 0x02954);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2950 %08x->%08x 0x2954 %08x->%08x\\n\",\n\t\t       yi->reg_2950, reg_2950, yi->reg_2954, reg_2954);\n\n\twrite_reg(reg_2958, 0x02958);\n\twrite_reg(reg_295c, 0x0295C);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2958 %08x->%08x 0x295C %08x->%08x\\n\",\n\t\t       yi->reg_2958, reg_2958, yi->reg_295c, reg_295c);\n\n\twrite_reg(reg_2960, 0x02960);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2960 %08x->%08x \\n\",\n\t\t       yi->reg_2960, reg_2960);\n\n\twrite_reg(reg_2964, 0x02964);\n\twrite_reg(reg_2968, 0x02968);\n\tIVTV_DEBUG_YUV(\"Update reg 0x2964 %08x->%08x 0x2968 %08x->%08x\\n\",\n\t\t       yi->reg_2964, reg_2964, yi->reg_2968, reg_2968);\n\n\twrite_reg(reg_289c, 0x0289c);\n\tIVTV_DEBUG_YUV(\"Update reg 0x289c %08x->%08x\\n\",\n\t\t       yi->reg_289c, reg_289c);\n\n\t \n\tif (v_filter_1 != yi->v_filter_1) {\n\t\tivtv_yuv_filter(itv, -1, v_filter_1, -1);\n\t\tyi->v_filter_1 = v_filter_1;\n\t}\n\n\t \n\tif (v_filter_2 != yi->v_filter_2) {\n\t\tivtv_yuv_filter(itv, -1, -1, v_filter_2);\n\t\tyi->v_filter_2 = v_filter_2;\n\t}\n}\n\n \nstatic u32 ivtv_yuv_window_setup(struct ivtv *itv, struct yuv_frame_info *f)\n{\n\tstruct yuv_frame_info *of = &itv->yuv_info.old_frame_info;\n\tint osd_crop;\n\tu32 osd_scale;\n\tu32 yuv_update = 0;\n\n\t \n\tif (f->src_x < 0)\n\t\tf->src_x = 0;\n\tif (f->src_y < 0)\n\t\tf->src_y = 0;\n\n\t \n\tif ((osd_crop = f->src_w - 4 * f->dst_w) > 0) {\n\t\tf->src_x += osd_crop / 2;\n\t\tf->src_w = (f->src_w - osd_crop) & ~3;\n\t\tf->dst_w = f->src_w / 4;\n\t\tf->dst_w += f->dst_w & 1;\n\t}\n\n\t \n\tif (f->src_h / f->dst_h >= 2) {\n\t\t \n\t\tf->interlaced_y = 1;\n\t\t \n\t\tif ((osd_crop = f->src_h - 4 * f->dst_h) > 0) {\n\t\t\t \n\t\t\tf->src_y += osd_crop / 2;\n\t\t\tf->src_h = (f->src_h - osd_crop) & ~3;\n\t\t\tf->dst_h = f->src_h / 4;\n\t\t\tf->dst_h += f->dst_h & 1;\n\t\t}\n\t}\n\n\t \n\tif ((int)f->dst_w <= 2 || (int)f->dst_h <= 2 ||\n\t    (int)f->src_w <= 2 || (int)f->src_h <= 2) {\n\t\treturn IVTV_YUV_UPDATE_INVALID;\n\t}\n\n\t \n\tosd_scale = (f->src_h << 16) / f->dst_h;\n\n\tif ((osd_crop = f->pan_y - f->dst_y) > 0) {\n\t\t \n\t\tf->src_y += (osd_scale * osd_crop) >> 16;\n\t\tf->src_h -= (osd_scale * osd_crop) >> 16;\n\t\tf->dst_h -= osd_crop;\n\t\tf->dst_y = 0;\n\t} else {\n\t\tf->dst_y -= f->pan_y;\n\t}\n\n\tif ((osd_crop = f->dst_h + f->dst_y - f->vis_h) > 0) {\n\t\t \n\t\tf->dst_h -= osd_crop;\n\t\tf->src_h -= (osd_scale * osd_crop) >> 16;\n\t}\n\n\tosd_scale = (f->src_w << 16) / f->dst_w;\n\n\tif ((osd_crop = f->pan_x - f->dst_x) > 0) {\n\t\t \n\t\tf->src_x += (osd_scale * osd_crop) >> 16;\n\t\tf->src_w -= (osd_scale * osd_crop) >> 16;\n\t\tf->dst_w -= osd_crop;\n\t\tf->dst_x = 0;\n\t} else {\n\t\tf->dst_x -= f->pan_x;\n\t}\n\n\tif ((osd_crop = f->dst_w + f->dst_x - f->vis_w) > 0) {\n\t\t \n\t\tf->dst_w -= osd_crop;\n\t\tf->src_w -= (osd_scale * osd_crop) >> 16;\n\t}\n\n\tif (itv->yuv_info.track_osd) {\n\t\t \n\t\tf->dst_x += itv->yuv_info.osd_x_offset;\n\t\tf->dst_y += itv->yuv_info.osd_y_offset;\n\t}\n\n\t \n\tf->dst_w &= ~1;\n\tf->dst_x &= ~1;\n\n\tf->src_w += f->src_x & 1;\n\tf->src_x &= ~1;\n\n\tf->src_w &= ~1;\n\tf->dst_w &= ~1;\n\n\tf->dst_h &= ~1;\n\tf->dst_y &= ~1;\n\n\tf->src_h += f->src_y & 1;\n\tf->src_y &= ~1;\n\n\tf->src_h &= ~1;\n\tf->dst_h &= ~1;\n\n\t \n\tif (f->dst_w < f->src_w / 4) {\n\t\tf->src_w &= ~3;\n\t\tf->dst_w = f->src_w / 4;\n\t\tf->dst_w += f->dst_w & 1;\n\t}\n\tif (f->dst_h < f->src_h / 4) {\n\t\tf->src_h &= ~3;\n\t\tf->dst_h = f->src_h / 4;\n\t\tf->dst_h += f->dst_h & 1;\n\t}\n\n\t \n\tif ((int)f->dst_w <= 2 || (int)f->dst_h <= 2 ||\n\t    (int)f->src_w <= 2 || (int)f->src_h <= 2) {\n\t\treturn IVTV_YUV_UPDATE_INVALID;\n\t}\n\n\t \n\tif ((of->dst_w != f->dst_w) || (of->src_w != f->src_w) ||\n\t    (of->dst_x != f->dst_x) || (of->src_x != f->src_x) ||\n\t    (of->pan_x != f->pan_x) || (of->vis_w != f->vis_w)) {\n\t\tyuv_update |= IVTV_YUV_UPDATE_HORIZONTAL;\n\t}\n\n\tif ((of->src_h != f->src_h) || (of->dst_h != f->dst_h) ||\n\t    (of->dst_y != f->dst_y) || (of->src_y != f->src_y) ||\n\t    (of->pan_y != f->pan_y) || (of->vis_h != f->vis_h) ||\n\t    (of->lace_mode != f->lace_mode) ||\n\t    (of->interlaced_y != f->interlaced_y) ||\n\t    (of->interlaced_uv != f->interlaced_uv)) {\n\t\tyuv_update |= IVTV_YUV_UPDATE_VERTICAL;\n\t}\n\n\treturn yuv_update;\n}\n\n \nvoid ivtv_yuv_work_handler(struct ivtv *itv)\n{\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tstruct yuv_frame_info f;\n\tint frame = yi->update_frame;\n\tu32 yuv_update;\n\n\tIVTV_DEBUG_YUV(\"Update yuv registers for frame %d\\n\", frame);\n\tf = yi->new_frame_info[frame];\n\n\tif (yi->track_osd) {\n\t\t \n\t\tf.pan_x = yi->osd_x_pan;\n\t\tf.pan_y = yi->osd_y_pan;\n\t\tf.vis_w = yi->osd_vis_w;\n\t\tf.vis_h = yi->osd_vis_h;\n\t} else {\n\t\t \n\t\tf.pan_x = 0;\n\t\tf.pan_y = 0;\n\t\tf.vis_w = 720;\n\t\tf.vis_h = yi->decode_height;\n\t}\n\n\t \n\tif (!(yuv_update = ivtv_yuv_window_setup(itv, &f)))\n\t\treturn;\n\n\tif (yuv_update & IVTV_YUV_UPDATE_INVALID) {\n\t\twrite_reg(0x01008080, 0x2898);\n\t} else if (yuv_update) {\n\t\twrite_reg(0x00108080, 0x2898);\n\n\t\tif (yuv_update & IVTV_YUV_UPDATE_HORIZONTAL)\n\t\t\tivtv_yuv_handle_horizontal(itv, &f);\n\n\t\tif (yuv_update & IVTV_YUV_UPDATE_VERTICAL)\n\t\t\tivtv_yuv_handle_vertical(itv, &f);\n\t}\n\tyi->old_frame_info = f;\n}\n\nstatic void ivtv_yuv_init(struct ivtv *itv)\n{\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\n\tIVTV_DEBUG_YUV(\"ivtv_yuv_init\\n\");\n\n\t \n\tyi->reg_2834 = read_reg(0x02834);\n\tyi->reg_2838 = read_reg(0x02838);\n\tyi->reg_283c = read_reg(0x0283c);\n\tyi->reg_2840 = read_reg(0x02840);\n\tyi->reg_2844 = read_reg(0x02844);\n\tyi->reg_2848 = read_reg(0x02848);\n\tyi->reg_2854 = read_reg(0x02854);\n\tyi->reg_285c = read_reg(0x0285c);\n\tyi->reg_2864 = read_reg(0x02864);\n\tyi->reg_2870 = read_reg(0x02870);\n\tyi->reg_2874 = read_reg(0x02874);\n\tyi->reg_2898 = read_reg(0x02898);\n\tyi->reg_2890 = read_reg(0x02890);\n\n\tyi->reg_289c = read_reg(0x0289c);\n\tyi->reg_2918 = read_reg(0x02918);\n\tyi->reg_291c = read_reg(0x0291c);\n\tyi->reg_2920 = read_reg(0x02920);\n\tyi->reg_2924 = read_reg(0x02924);\n\tyi->reg_2928 = read_reg(0x02928);\n\tyi->reg_292c = read_reg(0x0292c);\n\tyi->reg_2930 = read_reg(0x02930);\n\tyi->reg_2934 = read_reg(0x02934);\n\tyi->reg_2938 = read_reg(0x02938);\n\tyi->reg_293c = read_reg(0x0293c);\n\tyi->reg_2940 = read_reg(0x02940);\n\tyi->reg_2944 = read_reg(0x02944);\n\tyi->reg_2948 = read_reg(0x02948);\n\tyi->reg_294c = read_reg(0x0294c);\n\tyi->reg_2950 = read_reg(0x02950);\n\tyi->reg_2954 = read_reg(0x02954);\n\tyi->reg_2958 = read_reg(0x02958);\n\tyi->reg_295c = read_reg(0x0295c);\n\tyi->reg_2960 = read_reg(0x02960);\n\tyi->reg_2964 = read_reg(0x02964);\n\tyi->reg_2968 = read_reg(0x02968);\n\tyi->reg_296c = read_reg(0x0296c);\n\tyi->reg_2970 = read_reg(0x02970);\n\n\tyi->v_filter_1 = -1;\n\tyi->v_filter_2 = -1;\n\tyi->h_filter = -1;\n\n\t \n\tyi->osd_x_offset = read_reg(0x02a04) & 0x00000FFF;\n\tyi->osd_y_offset = (read_reg(0x02a04) >> 16) & 0x00000FFF;\n\n\t \n\tif (read_reg(0x2878) & 4)\n\t\tyi->decode_height = 576;\n\telse\n\t\tyi->decode_height = 480;\n\n\tif (!itv->osd_info) {\n\t\tyi->osd_vis_w = 720 - yi->osd_x_offset;\n\t\tyi->osd_vis_h = yi->decode_height - yi->osd_y_offset;\n\t} else {\n\t\t \n\t\tif (!yi->osd_vis_w)\n\t\t\tyi->osd_vis_w = 720 - yi->osd_x_offset;\n\n\t\tif (!yi->osd_vis_h) {\n\t\t\tyi->osd_vis_h = yi->decode_height - yi->osd_y_offset;\n\t\t} else if (yi->osd_vis_h + yi->osd_y_offset > yi->decode_height) {\n\t\t\t \n\t\t\tIVTV_DEBUG_WARN(\"Clipping yuv output - fb size (%d) exceeds video standard limit (%d)\\n\",\n\t\t\t\t\tyi->osd_vis_h + yi->osd_y_offset,\n\t\t\t\t\tyi->decode_height);\n\t\t\tyi->osd_vis_h = yi->decode_height - yi->osd_y_offset;\n\t\t}\n\t}\n\n\t \n\tyi->blanking_ptr = kzalloc(720 * 16, GFP_ATOMIC|__GFP_NOWARN);\n\tif (yi->blanking_ptr) {\n\t\tyi->blanking_dmaptr = dma_map_single(&itv->pdev->dev,\n\t\t\t\t\t\t     yi->blanking_ptr,\n\t\t\t\t\t\t     720 * 16, DMA_TO_DEVICE);\n\t} else {\n\t\tyi->blanking_dmaptr = 0;\n\t\tIVTV_DEBUG_WARN(\"Failed to allocate yuv blanking buffer\\n\");\n\t}\n\n\t \n\twrite_reg_sync(0x01, IVTV_REG_VDM);\n\n\tset_bit(IVTV_F_I_DECODING_YUV, &itv->i_flags);\n\tatomic_set(&yi->next_dma_frame, 0);\n}\n\n \nstatic void ivtv_yuv_next_free(struct ivtv *itv)\n{\n\tint draw, display;\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\n\tif (atomic_read(&yi->next_dma_frame) == -1)\n\t\tivtv_yuv_init(itv);\n\n\tdraw = atomic_read(&yi->next_fill_frame);\n\tdisplay = atomic_read(&yi->next_dma_frame);\n\n\tif (display > draw)\n\t\tdisplay -= IVTV_YUV_BUFFERS;\n\n\tif (draw - display >= yi->max_frames_buffered)\n\t\tdraw = (u8)(draw - 1) % IVTV_YUV_BUFFERS;\n\telse\n\t\tyi->new_frame_info[draw].update = 0;\n\n\tyi->draw_frame = draw;\n}\n\n \nstatic void ivtv_yuv_setup_frame(struct ivtv *itv, struct ivtv_dma_frame *args)\n{\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tu8 frame = yi->draw_frame;\n\tu8 last_frame = (u8)(frame - 1) % IVTV_YUV_BUFFERS;\n\tstruct yuv_frame_info *nf = &yi->new_frame_info[frame];\n\tstruct yuv_frame_info *of = &yi->new_frame_info[last_frame];\n\tint lace_threshold = yi->lace_threshold;\n\n\t \n\tint update = nf->update;\n\n\t \n\tnf->src_x = args->src.left;\n\tnf->src_y = args->src.top;\n\tnf->src_w = args->src.width;\n\tnf->src_h = args->src.height;\n\tnf->dst_x = args->dst.left;\n\tnf->dst_y = args->dst.top;\n\tnf->dst_w = args->dst.width;\n\tnf->dst_h = args->dst.height;\n\tnf->tru_x = args->dst.left;\n\tnf->tru_w = args->src_width;\n\tnf->tru_h = args->src_height;\n\n\t \n\tnf->offset_y = (nf->tru_h + nf->src_x < 512 - 16) ? 1 : 0;\n\n\tnf->update = 0;\n\tnf->interlaced_y = 0;\n\tnf->interlaced_uv = 0;\n\tnf->delay = 0;\n\tnf->sync_field = 0;\n\tnf->lace_mode = yi->lace_mode & IVTV_YUV_MODE_MASK;\n\n\tif (lace_threshold < 0)\n\t\tlace_threshold = yi->decode_height - 1;\n\n\t \n\tswitch (nf->lace_mode) {\n\tcase IVTV_YUV_MODE_PROGRESSIVE:  \n\t\tnf->interlaced = 0;\n\t\tif (nf->tru_h < 512 || (nf->tru_h > 576 && nf->tru_h < 1021))\n\t\t\tnf->interlaced_y = 0;\n\t\telse\n\t\t\tnf->interlaced_y = 1;\n\n\t\tif (nf->tru_h < 1021 && (nf->dst_h >= nf->src_h / 2))\n\t\t\tnf->interlaced_uv = 0;\n\t\telse\n\t\t\tnf->interlaced_uv = 1;\n\t\tbreak;\n\n\tcase IVTV_YUV_MODE_AUTO:\n\t\tif (nf->tru_h <= lace_threshold || nf->tru_h > 576 || nf->tru_w > 720) {\n\t\t\tnf->interlaced = 0;\n\t\t\tif ((nf->tru_h < 512) ||\n\t\t\t    (nf->tru_h > 576 && nf->tru_h < 1021) ||\n\t\t\t    (nf->tru_w > 720 && nf->tru_h < 1021))\n\t\t\t\tnf->interlaced_y = 0;\n\t\t\telse\n\t\t\t\tnf->interlaced_y = 1;\n\t\t\tif (nf->tru_h < 1021 && (nf->dst_h >= nf->src_h / 2))\n\t\t\t\tnf->interlaced_uv = 0;\n\t\t\telse\n\t\t\t\tnf->interlaced_uv = 1;\n\t\t} else {\n\t\t\tnf->interlaced = 1;\n\t\t\tnf->interlaced_y = 1;\n\t\t\tnf->interlaced_uv = 1;\n\t\t}\n\t\tbreak;\n\n\tcase IVTV_YUV_MODE_INTERLACED:  \n\tdefault:\n\t\tnf->interlaced = 1;\n\t\tnf->interlaced_y = 1;\n\t\tnf->interlaced_uv = 1;\n\t\tbreak;\n\t}\n\n\tif (memcmp(&yi->old_frame_info_args, nf, sizeof(*nf))) {\n\t\tyi->old_frame_info_args = *nf;\n\t\tnf->update = 1;\n\t\tIVTV_DEBUG_YUV(\"Requesting reg update for frame %d\\n\", frame);\n\t}\n\n\tnf->update |= update;\n\tnf->sync_field = yi->lace_sync_field;\n\tnf->delay = nf->sync_field != of->sync_field;\n}\n\n \nvoid ivtv_yuv_frame_complete(struct ivtv *itv)\n{\n\tatomic_set(&itv->yuv_info.next_fill_frame,\n\t\t\t(itv->yuv_info.draw_frame + 1) % IVTV_YUV_BUFFERS);\n}\n\nstatic int ivtv_yuv_udma_frame(struct ivtv *itv, struct ivtv_dma_frame *args)\n{\n\tDEFINE_WAIT(wait);\n\tint rc = 0;\n\tint got_sig = 0;\n\t \n\tmutex_lock(&itv->udma.lock);\n\n\tif ((rc = ivtv_yuv_prep_user_dma(itv, &itv->udma, args)) != 0) {\n\t\tmutex_unlock(&itv->udma.lock);\n\t\treturn rc;\n\t}\n\n\tivtv_udma_prepare(itv);\n\tprepare_to_wait(&itv->dma_waitq, &wait, TASK_INTERRUPTIBLE);\n\t \n\twhile (test_bit(IVTV_F_I_UDMA_PENDING, &itv->i_flags) ||\n\t       test_bit(IVTV_F_I_UDMA, &itv->i_flags)) {\n\t\t \n\t\tgot_sig = signal_pending(current);\n\t\tif (got_sig && test_and_clear_bit(IVTV_F_I_UDMA_PENDING, &itv->i_flags))\n\t\t\tbreak;\n\t\tgot_sig = 0;\n\t\tschedule();\n\t}\n\tfinish_wait(&itv->dma_waitq, &wait);\n\n\t \n\tivtv_udma_unmap(itv);\n\n\tif (got_sig) {\n\t\tIVTV_DEBUG_INFO(\"User stopped YUV UDMA\\n\");\n\t\tmutex_unlock(&itv->udma.lock);\n\t\treturn -EINTR;\n\t}\n\n\tivtv_yuv_frame_complete(itv);\n\n\tmutex_unlock(&itv->udma.lock);\n\treturn rc;\n}\n\n \nvoid ivtv_yuv_setup_stream_frame(struct ivtv *itv)\n{\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tstruct ivtv_dma_frame dma_args;\n\n\tivtv_yuv_next_free(itv);\n\n\t \n\tdma_args.y_source = NULL;\n\tdma_args.uv_source = NULL;\n\tdma_args.src.left = 0;\n\tdma_args.src.top = 0;\n\tdma_args.src.width = yi->v4l2_src_w;\n\tdma_args.src.height = yi->v4l2_src_h;\n\tdma_args.dst = yi->main_rect;\n\tdma_args.src_width = yi->v4l2_src_w;\n\tdma_args.src_height = yi->v4l2_src_h;\n\n\t \n\tivtv_yuv_setup_frame(itv, &dma_args);\n\n\tif (!itv->dma_data_req_offset)\n\t\titv->dma_data_req_offset = yuv_offset[yi->draw_frame];\n}\n\n \nint ivtv_yuv_udma_stream_frame(struct ivtv *itv, void __user *src)\n{\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tstruct ivtv_dma_frame dma_args;\n\tint res;\n\n\tivtv_yuv_setup_stream_frame(itv);\n\n\t \n\tdma_args.y_source = src;\n\tdma_args.uv_source = src + 720 * ((yi->v4l2_src_h + 31) & ~31);\n\t \n\tmutex_unlock(&itv->serialize_lock);\n\tres = ivtv_yuv_udma_frame(itv, &dma_args);\n\tmutex_lock(&itv->serialize_lock);\n\treturn res;\n}\n\n \nint ivtv_yuv_prep_frame(struct ivtv *itv, struct ivtv_dma_frame *args)\n{\n\tint res;\n\n \n\tivtv_yuv_next_free(itv);\n\tivtv_yuv_setup_frame(itv, args);\n\t \n\tmutex_unlock(&itv->serialize_lock);\n\tres = ivtv_yuv_udma_frame(itv, args);\n\tmutex_lock(&itv->serialize_lock);\n\treturn res;\n}\n\nvoid ivtv_yuv_close(struct ivtv *itv)\n{\n\tstruct yuv_playback_info *yi = &itv->yuv_info;\n\tint h_filter, v_filter_1, v_filter_2;\n\n\tIVTV_DEBUG_YUV(\"ivtv_yuv_close\\n\");\n\tmutex_unlock(&itv->serialize_lock);\n\tivtv_waitq(&itv->vsync_waitq);\n\tmutex_lock(&itv->serialize_lock);\n\n\tyi->running = 0;\n\tatomic_set(&yi->next_dma_frame, -1);\n\tatomic_set(&yi->next_fill_frame, 0);\n\n\t \n\n\t \n\twrite_reg(yi->reg_2898 | 0x01000000, 0x2898);\n\n\twrite_reg(yi->reg_2834, 0x02834);\n\twrite_reg(yi->reg_2838, 0x02838);\n\twrite_reg(yi->reg_283c, 0x0283c);\n\twrite_reg(yi->reg_2840, 0x02840);\n\twrite_reg(yi->reg_2844, 0x02844);\n\twrite_reg(yi->reg_2848, 0x02848);\n\twrite_reg(yi->reg_2854, 0x02854);\n\twrite_reg(yi->reg_285c, 0x0285c);\n\twrite_reg(yi->reg_2864, 0x02864);\n\twrite_reg(yi->reg_2870, 0x02870);\n\twrite_reg(yi->reg_2874, 0x02874);\n\twrite_reg(yi->reg_2890, 0x02890);\n\twrite_reg(yi->reg_289c, 0x0289c);\n\n\twrite_reg(yi->reg_2918, 0x02918);\n\twrite_reg(yi->reg_291c, 0x0291c);\n\twrite_reg(yi->reg_2920, 0x02920);\n\twrite_reg(yi->reg_2924, 0x02924);\n\twrite_reg(yi->reg_2928, 0x02928);\n\twrite_reg(yi->reg_292c, 0x0292c);\n\twrite_reg(yi->reg_2930, 0x02930);\n\twrite_reg(yi->reg_2934, 0x02934);\n\twrite_reg(yi->reg_2938, 0x02938);\n\twrite_reg(yi->reg_293c, 0x0293c);\n\twrite_reg(yi->reg_2940, 0x02940);\n\twrite_reg(yi->reg_2944, 0x02944);\n\twrite_reg(yi->reg_2948, 0x02948);\n\twrite_reg(yi->reg_294c, 0x0294c);\n\twrite_reg(yi->reg_2950, 0x02950);\n\twrite_reg(yi->reg_2954, 0x02954);\n\twrite_reg(yi->reg_2958, 0x02958);\n\twrite_reg(yi->reg_295c, 0x0295c);\n\twrite_reg(yi->reg_2960, 0x02960);\n\twrite_reg(yi->reg_2964, 0x02964);\n\twrite_reg(yi->reg_2968, 0x02968);\n\twrite_reg(yi->reg_296c, 0x0296c);\n\twrite_reg(yi->reg_2970, 0x02970);\n\n\t \n\n\t \n\tif ((yi->reg_2834 & 0x0000FFFF) == (yi->reg_2834 >> 16)) {\n\t\t \n\t\th_filter = 0;\n\t} else {\n\t\t \n\t\th_filter = ((yi->reg_2834 << 16) / (yi->reg_2834 >> 16)) >> 15;\n\t\th_filter = (h_filter >> 1) + (h_filter & 1);\n\t\t \n\t\th_filter += !h_filter;\n\t}\n\n\t \n\tif ((yi->reg_2918 & 0x0000FFFF) == (yi->reg_2918 >> 16)) {\n\t\t \n\t\tv_filter_1 = 0;\n\t\tv_filter_2 = 1;\n\t} else {\n\t\t \n\t\tv_filter_1 = ((yi->reg_2918 << 16) / (yi->reg_2918 >> 16)) >> 15;\n\t\tv_filter_1 = (v_filter_1 >> 1) + (v_filter_1 & 1);\n\t\t \n\t\tv_filter_1 += !v_filter_1;\n\t\tv_filter_2 = v_filter_1;\n\t}\n\n\t \n\tivtv_yuv_filter(itv, h_filter, v_filter_1, v_filter_2);\n\n\t \n\twrite_reg(0, 0x02814);\n\twrite_reg(0, 0x0282c);\n\twrite_reg(0, 0x02904);\n\twrite_reg(0, 0x02910);\n\n\t \n\tif (yi->blanking_ptr) {\n\t\tkfree(yi->blanking_ptr);\n\t\tyi->blanking_ptr = NULL;\n\t\tdma_unmap_single(&itv->pdev->dev, yi->blanking_dmaptr,\n\t\t\t\t 720 * 16, DMA_TO_DEVICE);\n\t}\n\n\t \n\tyi->old_frame_info.src_w = 0;\n\tyi->old_frame_info.src_h = 0;\n\tyi->old_frame_info_args.src_w = 0;\n\tyi->old_frame_info_args.src_h = 0;\n\n\t \n\tclear_bit(IVTV_F_I_DECODING_YUV, &itv->i_flags);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}