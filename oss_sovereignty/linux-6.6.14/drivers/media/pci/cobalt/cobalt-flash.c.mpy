{
  "module_name": "cobalt-flash.c",
  "hash_id": "b3811ccd54f1191fa85c996538f9c60928421e32d8d23874aa21ad97d40a32e4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/cobalt/cobalt-flash.c",
  "human_readable_source": "\n \n\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/map.h>\n#include <linux/mtd/cfi.h>\n#include <linux/time.h>\n\n#include \"cobalt-flash.h\"\n\n#define ADRS(offset) (COBALT_BUS_FLASH_BASE + offset)\n\nstatic struct map_info cobalt_flash_map = {\n\t.name =\t\t\"cobalt-flash\",\n\t.bankwidth =\t2,          \n\t.size =\t\t0x4000000,  \n\t.phys =\t\t0,          \n};\n\nstatic map_word flash_read16(struct map_info *map, unsigned long offset)\n{\n\tmap_word r;\n\n\tr.x[0] = cobalt_bus_read32(map->virt, ADRS(offset));\n\tif (offset & 0x2)\n\t\tr.x[0] >>= 16;\n\telse\n\t\tr.x[0] &= 0x0000ffff;\n\n\treturn r;\n}\n\nstatic void flash_write16(struct map_info *map, const map_word datum,\n\t\t\t  unsigned long offset)\n{\n\tu16 data = (u16)datum.x[0];\n\n\tcobalt_bus_write16(map->virt, ADRS(offset), data);\n}\n\nstatic void flash_copy_from(struct map_info *map, void *to,\n\t\t\t    unsigned long from, ssize_t len)\n{\n\tu32 src = from;\n\tu8 *dest = to;\n\tu32 data;\n\n\twhile (len) {\n\t\tdata = cobalt_bus_read32(map->virt, ADRS(src));\n\t\tdo {\n\t\t\t*dest = data >> (8 * (src & 3));\n\t\t\tsrc++;\n\t\t\tdest++;\n\t\t\tlen--;\n\t\t} while (len && (src % 4));\n\t}\n}\n\nstatic void flash_copy_to(struct map_info *map, unsigned long to,\n\t\t\t  const void *from, ssize_t len)\n{\n\tconst u8 *src = from;\n\tu32 dest = to;\n\n\tpr_info(\"%s: offset 0x%x: length %zu\\n\", __func__, dest, len);\n\twhile (len) {\n\t\tu16 data;\n\n\t\tdo {\n\t\t\tdata = *src << (8 * (dest & 1));\n\t\t\tsrc++;\n\t\t\tdest++;\n\t\t\tlen--;\n\t\t} while (len && (dest % 2));\n\n\t\tcobalt_bus_write16(map->virt, ADRS(dest - 2), data);\n\t}\n}\n\nint cobalt_flash_probe(struct cobalt *cobalt)\n{\n\tstruct map_info *map = &cobalt_flash_map;\n\tstruct mtd_info *mtd;\n\n\tBUG_ON(!map_bankwidth_supported(map->bankwidth));\n\tmap->virt = cobalt->bar1;\n\tmap->read = flash_read16;\n\tmap->write = flash_write16;\n\tmap->copy_from = flash_copy_from;\n\tmap->copy_to = flash_copy_to;\n\n\tmtd = do_map_probe(\"cfi_probe\", map);\n\tcobalt->mtd = mtd;\n\tif (!mtd) {\n\t\tcobalt_err(\"Probe CFI flash failed!\\n\");\n\t\treturn -1;\n\t}\n\n\tmtd->owner = THIS_MODULE;\n\tmtd->dev.parent = &cobalt->pci_dev->dev;\n\tmtd_device_register(mtd, NULL, 0);\n\treturn 0;\n}\n\nvoid cobalt_flash_remove(struct cobalt *cobalt)\n{\n\tif (cobalt->mtd) {\n\t\tmtd_device_unregister(cobalt->mtd);\n\t\tmap_destroy(cobalt->mtd);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}