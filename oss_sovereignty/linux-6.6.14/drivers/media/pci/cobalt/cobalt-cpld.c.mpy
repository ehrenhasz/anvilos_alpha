{
  "module_name": "cobalt-cpld.c",
  "hash_id": "9138cc00a47d39a41783b833ccbbd89da7cbacd97c3740c3d7fd8f571dccb9a2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/cobalt/cobalt-cpld.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n\n#include \"cobalt-cpld.h\"\n\n#define ADRS(offset) (COBALT_BUS_CPLD_BASE + offset)\n\nstatic u16 cpld_read(struct cobalt *cobalt, u32 offset)\n{\n\treturn cobalt_bus_read32(cobalt->bar1, ADRS(offset));\n}\n\nstatic void cpld_write(struct cobalt *cobalt, u32 offset, u16 val)\n{\n\treturn cobalt_bus_write32(cobalt->bar1, ADRS(offset), val);\n}\n\nstatic void cpld_info_ver3(struct cobalt *cobalt)\n{\n\tu32 rd;\n\tu32 tmp;\n\n\tcobalt_info(\"CPLD System control register (read/write)\\n\");\n\tcobalt_info(\"\\t\\tSystem control:  0x%04x (0x0f00)\\n\",\n\t\t    cpld_read(cobalt, 0));\n\tcobalt_info(\"CPLD Clock control register (read/write)\\n\");\n\tcobalt_info(\"\\t\\tClock control:   0x%04x (0x0000)\\n\",\n\t\t    cpld_read(cobalt, 0x04));\n\tcobalt_info(\"CPLD HSMA Clk Osc register (read/write) - Must set wr trigger to load default values\\n\");\n\tcobalt_info(\"\\t\\tRegister #7:\\t0x%04x (0x0022)\\n\",\n\t\t    cpld_read(cobalt, 0x08));\n\tcobalt_info(\"\\t\\tRegister #8:\\t0x%04x (0x0047)\\n\",\n\t\t    cpld_read(cobalt, 0x0c));\n\tcobalt_info(\"\\t\\tRegister #9:\\t0x%04x (0x00fa)\\n\",\n\t\t    cpld_read(cobalt, 0x10));\n\tcobalt_info(\"\\t\\tRegister #10:\\t0x%04x (0x0061)\\n\",\n\t\t    cpld_read(cobalt, 0x14));\n\tcobalt_info(\"\\t\\tRegister #11:\\t0x%04x (0x001e)\\n\",\n\t\t    cpld_read(cobalt, 0x18));\n\tcobalt_info(\"\\t\\tRegister #12:\\t0x%04x (0x0045)\\n\",\n\t\t    cpld_read(cobalt, 0x1c));\n\tcobalt_info(\"\\t\\tRegister #135:\\t0x%04x\\n\",\n\t\t    cpld_read(cobalt, 0x20));\n\tcobalt_info(\"\\t\\tRegister #137:\\t0x%04x\\n\",\n\t\t    cpld_read(cobalt, 0x24));\n\tcobalt_info(\"CPLD System status register (read only)\\n\");\n\tcobalt_info(\"\\t\\tSystem status:  0x%04x\\n\",\n\t\t    cpld_read(cobalt, 0x28));\n\tcobalt_info(\"CPLD MAXII info register (read only)\\n\");\n\tcobalt_info(\"\\t\\tBoard serial number:     0x%04x\\n\",\n\t\t    cpld_read(cobalt, 0x2c));\n\tcobalt_info(\"\\t\\tMAXII program revision:  0x%04x\\n\",\n\t\t    cpld_read(cobalt, 0x30));\n\tcobalt_info(\"CPLD temp and voltage ADT7411 registers (read only)\\n\");\n\tcobalt_info(\"\\t\\tBoard temperature:  %u Celsius\\n\",\n\t\t    cpld_read(cobalt, 0x34) / 4);\n\tcobalt_info(\"\\t\\tFPGA temperature:   %u Celsius\\n\",\n\t\t    cpld_read(cobalt, 0x38) / 4);\n\trd = cpld_read(cobalt, 0x3c);\n\ttmp = (rd * 33 * 1000) / (483 * 10);\n\tcobalt_info(\"\\t\\tVDD 3V3:      %u,%03uV\\n\", tmp / 1000, tmp % 1000);\n\trd = cpld_read(cobalt, 0x40);\n\ttmp = (rd * 74 * 2197) / (27 * 1000);\n\tcobalt_info(\"\\t\\tADC ch3 5V:   %u,%03uV\\n\", tmp / 1000, tmp % 1000);\n\trd = cpld_read(cobalt, 0x44);\n\ttmp = (rd * 74 * 2197) / (47 * 1000);\n\tcobalt_info(\"\\t\\tADC ch4 3V:   %u,%03uV\\n\", tmp / 1000, tmp % 1000);\n\trd = cpld_read(cobalt, 0x48);\n\ttmp = (rd * 57 * 2197) / (47 * 1000);\n\tcobalt_info(\"\\t\\tADC ch5 2V5:  %u,%03uV\\n\", tmp / 1000, tmp % 1000);\n\trd = cpld_read(cobalt, 0x4c);\n\ttmp = (rd * 2197) / 1000;\n\tcobalt_info(\"\\t\\tADC ch6 1V8:  %u,%03uV\\n\", tmp / 1000, tmp % 1000);\n\trd = cpld_read(cobalt, 0x50);\n\ttmp = (rd * 2197) / 1000;\n\tcobalt_info(\"\\t\\tADC ch7 1V5:  %u,%03uV\\n\", tmp / 1000, tmp % 1000);\n\trd = cpld_read(cobalt, 0x54);\n\ttmp = (rd * 2197) / 1000;\n\tcobalt_info(\"\\t\\tADC ch8 0V9:  %u,%03uV\\n\", tmp / 1000, tmp % 1000);\n}\n\nvoid cobalt_cpld_status(struct cobalt *cobalt)\n{\n\tu32 rev = cpld_read(cobalt, 0x30);\n\n\tswitch (rev) {\n\tcase 3:\n\tcase 4:\n\tcase 5:\n\t\tcpld_info_ver3(cobalt);\n\t\tbreak;\n\tdefault:\n\t\tcobalt_info(\"CPLD revision %u is not supported!\\n\", rev);\n\t\tbreak;\n\t}\n}\n\n#define DCO_MIN 4850000000ULL\n#define DCO_MAX 5670000000ULL\n\n#define SI570_CLOCK_CTRL   0x04\n#define S01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_WR_TRIGGER 0x200\n#define S01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_RST_TRIGGER 0x100\n#define S01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_FPGA_CTRL 0x80\n#define S01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_EN 0x40\n\n#define SI570_REG7   0x08\n#define SI570_REG8   0x0c\n#define SI570_REG9   0x10\n#define SI570_REG10  0x14\n#define SI570_REG11  0x18\n#define SI570_REG12  0x1c\n#define SI570_REG135 0x20\n#define SI570_REG137 0x24\n\nstruct multiplier {\n\tunsigned mult, hsdiv, n1;\n};\n\n \nstatic const struct multiplier multipliers[] = {\n\t{    4,  4,   1 }, {    5,  5,   1 }, {    6,  6,   1 },\n\t{    7,  7,   1 }, {    8,  4,   2 }, {    9,  9,   1 },\n\t{   10,  5,   2 }, {   11, 11,   1 }, {   12,  6,   2 },\n\t{   14,  7,   2 }, {   16,  4,   4 }, {   18,  9,   2 },\n\t{   20,  5,   4 }, {   22, 11,   2 }, {   24,  4,   6 },\n\t{   28,  7,   4 }, {   30,  5,   6 }, {   32,  4,   8 },\n\t{   36,  6,   6 }, {   40,  4,  10 }, {   42,  7,   6 },\n\t{   44, 11,   4 }, {   48,  4,  12 }, {   50,  5,  10 },\n\t{   54,  9,   6 }, {   56,  4,  14 }, {   60,  5,  12 },\n\t{   64,  4,  16 }, {   66, 11,   6 }, {   70,  5,  14 },\n\t{   72,  4,  18 }, {   80,  4,  20 }, {   84,  6,  14 },\n\t{   88, 11,   8 }, {   90,  5,  18 }, {   96,  4,  24 },\n\t{   98,  7,  14 }, {  100,  5,  20 }, {  104,  4,  26 },\n\t{  108,  6,  18 }, {  110, 11,  10 }, {  112,  4,  28 },\n\t{  120,  4,  30 }, {  126,  7,  18 }, {  128,  4,  32 },\n\t{  130,  5,  26 }, {  132, 11,  12 }, {  136,  4,  34 },\n\t{  140,  5,  28 }, {  144,  4,  36 }, {  150,  5,  30 },\n\t{  152,  4,  38 }, {  154, 11,  14 }, {  156,  6,  26 },\n\t{  160,  4,  40 }, {  162,  9,  18 }, {  168,  4,  42 },\n\t{  170,  5,  34 }, {  176, 11,  16 }, {  180,  5,  36 },\n\t{  182,  7,  26 }, {  184,  4,  46 }, {  190,  5,  38 },\n\t{  192,  4,  48 }, {  196,  7,  28 }, {  198, 11,  18 },\n\t{  198,  9,  22 }, {  200,  4,  50 }, {  204,  6,  34 },\n\t{  208,  4,  52 }, {  210,  5,  42 }, {  216,  4,  54 },\n\t{  220, 11,  20 }, {  224,  4,  56 }, {  228,  6,  38 },\n\t{  230,  5,  46 }, {  232,  4,  58 }, {  234,  9,  26 },\n\t{  238,  7,  34 }, {  240,  4,  60 }, {  242, 11,  22 },\n\t{  248,  4,  62 }, {  250,  5,  50 }, {  252,  6,  42 },\n\t{  256,  4,  64 }, {  260,  5,  52 }, {  264, 11,  24 },\n\t{  266,  7,  38 }, {  270,  5,  54 }, {  272,  4,  68 },\n\t{  276,  6,  46 }, {  280,  4,  70 }, {  286, 11,  26 },\n\t{  288,  4,  72 }, {  290,  5,  58 }, {  294,  7,  42 },\n\t{  296,  4,  74 }, {  300,  5,  60 }, {  304,  4,  76 },\n\t{  306,  9,  34 }, {  308, 11,  28 }, {  310,  5,  62 },\n\t{  312,  4,  78 }, {  320,  4,  80 }, {  322,  7,  46 },\n\t{  324,  6,  54 }, {  328,  4,  82 }, {  330, 11,  30 },\n\t{  336,  4,  84 }, {  340,  5,  68 }, {  342,  9,  38 },\n\t{  344,  4,  86 }, {  348,  6,  58 }, {  350,  5,  70 },\n\t{  352, 11,  32 }, {  360,  4,  90 }, {  364,  7,  52 },\n\t{  368,  4,  92 }, {  370,  5,  74 }, {  372,  6,  62 },\n\t{  374, 11,  34 }, {  376,  4,  94 }, {  378,  7,  54 },\n\t{  380,  5,  76 }, {  384,  4,  96 }, {  390,  5,  78 },\n\t{  392,  4,  98 }, {  396, 11,  36 }, {  400,  4, 100 },\n\t{  406,  7,  58 }, {  408,  4, 102 }, {  410,  5,  82 },\n\t{  414,  9,  46 }, {  416,  4, 104 }, {  418, 11,  38 },\n\t{  420,  5,  84 }, {  424,  4, 106 }, {  430,  5,  86 },\n\t{  432,  4, 108 }, {  434,  7,  62 }, {  440, 11,  40 },\n\t{  444,  6,  74 }, {  448,  4, 112 }, {  450,  5,  90 },\n\t{  456,  4, 114 }, {  460,  5,  92 }, {  462, 11,  42 },\n\t{  464,  4, 116 }, {  468,  6,  78 }, {  470,  5,  94 },\n\t{  472,  4, 118 }, {  476,  7,  68 }, {  480,  4, 120 },\n\t{  484, 11,  44 }, {  486,  9,  54 }, {  488,  4, 122 },\n\t{  490,  5,  98 }, {  492,  6,  82 }, {  496,  4, 124 },\n\t{  500,  5, 100 }, {  504,  4, 126 }, {  506, 11,  46 },\n\t{  510,  5, 102 }, {  512,  4, 128 }, {  516,  6,  86 },\n\t{  518,  7,  74 }, {  520,  5, 104 }, {  522,  9,  58 },\n\t{  528, 11,  48 }, {  530,  5, 106 }, {  532,  7,  76 },\n\t{  540,  5, 108 }, {  546,  7,  78 }, {  550, 11,  50 },\n\t{  552,  6,  92 }, {  558,  9,  62 }, {  560,  5, 112 },\n\t{  564,  6,  94 }, {  570,  5, 114 }, {  572, 11,  52 },\n\t{  574,  7,  82 }, {  576,  6,  96 }, {  580,  5, 116 },\n\t{  588,  6,  98 }, {  590,  5, 118 }, {  594, 11,  54 },\n\t{  600,  5, 120 }, {  602,  7,  86 }, {  610,  5, 122 },\n\t{  612,  6, 102 }, {  616, 11,  56 }, {  620,  5, 124 },\n\t{  624,  6, 104 }, {  630,  5, 126 }, {  636,  6, 106 },\n\t{  638, 11,  58 }, {  640,  5, 128 }, {  644,  7,  92 },\n\t{  648,  6, 108 }, {  658,  7,  94 }, {  660, 11,  60 },\n\t{  666,  9,  74 }, {  672,  6, 112 }, {  682, 11,  62 },\n\t{  684,  6, 114 }, {  686,  7,  98 }, {  696,  6, 116 },\n\t{  700,  7, 100 }, {  702,  9,  78 }, {  704, 11,  64 },\n\t{  708,  6, 118 }, {  714,  7, 102 }, {  720,  6, 120 },\n\t{  726, 11,  66 }, {  728,  7, 104 }, {  732,  6, 122 },\n\t{  738,  9,  82 }, {  742,  7, 106 }, {  744,  6, 124 },\n\t{  748, 11,  68 }, {  756,  6, 126 }, {  768,  6, 128 },\n\t{  770, 11,  70 }, {  774,  9,  86 }, {  784,  7, 112 },\n\t{  792, 11,  72 }, {  798,  7, 114 }, {  810,  9,  90 },\n\t{  812,  7, 116 }, {  814, 11,  74 }, {  826,  7, 118 },\n\t{  828,  9,  92 }, {  836, 11,  76 }, {  840,  7, 120 },\n\t{  846,  9,  94 }, {  854,  7, 122 }, {  858, 11,  78 },\n\t{  864,  9,  96 }, {  868,  7, 124 }, {  880, 11,  80 },\n\t{  882,  7, 126 }, {  896,  7, 128 }, {  900,  9, 100 },\n\t{  902, 11,  82 }, {  918,  9, 102 }, {  924, 11,  84 },\n\t{  936,  9, 104 }, {  946, 11,  86 }, {  954,  9, 106 },\n\t{  968, 11,  88 }, {  972,  9, 108 }, {  990, 11,  90 },\n\t{ 1008,  9, 112 }, { 1012, 11,  92 }, { 1026,  9, 114 },\n\t{ 1034, 11,  94 }, { 1044,  9, 116 }, { 1056, 11,  96 },\n\t{ 1062,  9, 118 }, { 1078, 11,  98 }, { 1080,  9, 120 },\n\t{ 1098,  9, 122 }, { 1100, 11, 100 }, { 1116,  9, 124 },\n\t{ 1122, 11, 102 }, { 1134,  9, 126 }, { 1144, 11, 104 },\n\t{ 1152,  9, 128 }, { 1166, 11, 106 }, { 1188, 11, 108 },\n\t{ 1210, 11, 110 }, { 1232, 11, 112 }, { 1254, 11, 114 },\n\t{ 1276, 11, 116 }, { 1298, 11, 118 }, { 1320, 11, 120 },\n\t{ 1342, 11, 122 }, { 1364, 11, 124 }, { 1386, 11, 126 },\n\t{ 1408, 11, 128 },\n};\n\nbool cobalt_cpld_set_freq(struct cobalt *cobalt, unsigned f_out)\n{\n\tconst unsigned f_xtal = 39170000;\t \n\tu64 dco;\n\tu64 rfreq;\n\tunsigned delta = 0xffffffff;\n\tunsigned i_best = 0;\n\tunsigned i;\n\tu8 n1, hsdiv;\n\tu8 regs[6];\n\tint found = 0;\n\tint retries = 3;\n\n\tfor (i = 0; i < ARRAY_SIZE(multipliers); i++) {\n\t\tunsigned mult = multipliers[i].mult;\n\t\tu32 d;\n\n\t\tdco = (u64)f_out * mult;\n\t\tif (dco < DCO_MIN || dco > DCO_MAX)\n\t\t\tcontinue;\n\t\tdiv_u64_rem((dco << 28) + f_xtal / 2, f_xtal, &d);\n\t\tif (d < delta) {\n\t\t\tfound = 1;\n\t\t\ti_best = i;\n\t\t\tdelta = d;\n\t\t}\n\t}\n\tif (!found)\n\t\treturn false;\n\tdco = (u64)f_out * multipliers[i_best].mult;\n\tn1 = multipliers[i_best].n1 - 1;\n\thsdiv = multipliers[i_best].hsdiv - 4;\n\trfreq = div_u64(dco << 28, f_xtal);\n\n\tcpld_read(cobalt, SI570_CLOCK_CTRL);\n\n\tregs[0] = (hsdiv << 5) | (n1 >> 2);\n\tregs[1] = ((n1 & 0x3) << 6) | (rfreq >> 32);\n\tregs[2] = (rfreq >> 24) & 0xff;\n\tregs[3] = (rfreq >> 16) & 0xff;\n\tregs[4] = (rfreq >> 8) & 0xff;\n\tregs[5] = rfreq & 0xff;\n\n\t \n\n\tcobalt_dbg(1, \"%u: %6ph\\n\", f_out, regs);\n\n\twhile (retries--) {\n\t\tu8 read_regs[6];\n\n\t\tcpld_write(cobalt, SI570_CLOCK_CTRL,\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_EN |\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_FPGA_CTRL);\n\t\tusleep_range(10000, 15000);\n\t\tcpld_write(cobalt, SI570_REG7, regs[0]);\n\t\tcpld_write(cobalt, SI570_REG8, regs[1]);\n\t\tcpld_write(cobalt, SI570_REG9, regs[2]);\n\t\tcpld_write(cobalt, SI570_REG10, regs[3]);\n\t\tcpld_write(cobalt, SI570_REG11, regs[4]);\n\t\tcpld_write(cobalt, SI570_REG12, regs[5]);\n\t\tcpld_write(cobalt, SI570_CLOCK_CTRL,\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_EN |\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_WR_TRIGGER);\n\t\tusleep_range(10000, 15000);\n\t\tcpld_write(cobalt, SI570_CLOCK_CTRL,\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_EN |\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_FPGA_CTRL);\n\t\tusleep_range(10000, 15000);\n\t\tread_regs[0] = cpld_read(cobalt, SI570_REG7);\n\t\tread_regs[1] = cpld_read(cobalt, SI570_REG8);\n\t\tread_regs[2] = cpld_read(cobalt, SI570_REG9);\n\t\tread_regs[3] = cpld_read(cobalt, SI570_REG10);\n\t\tread_regs[4] = cpld_read(cobalt, SI570_REG11);\n\t\tread_regs[5] = cpld_read(cobalt, SI570_REG12);\n\t\tcpld_write(cobalt, SI570_CLOCK_CTRL,\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_EN |\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_FPGA_CTRL |\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_RST_TRIGGER);\n\t\tusleep_range(10000, 15000);\n\t\tcpld_write(cobalt, SI570_CLOCK_CTRL,\n\t\t\tS01755_REG_CLOCK_CTRL_BITMAP_CLKHSMA_EN);\n\t\tusleep_range(10000, 15000);\n\n\t\tif (!memcmp(read_regs, regs, sizeof(read_regs)))\n\t\t\tbreak;\n\t\tcobalt_dbg(1, \"retry: %6ph\\n\", read_regs);\n\t}\n\tif (2 - retries)\n\t\tcobalt_info(\"Needed %d retries\\n\", 2 - retries);\n\n\treturn true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}