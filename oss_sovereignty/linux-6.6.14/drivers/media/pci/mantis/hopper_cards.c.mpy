{
  "module_name": "hopper_cards.c",
  "hash_id": "ee361e797d8ccb4d795da8cd3dbb123f8c1eab65087c17a1dee0ae56612d4483",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/mantis/hopper_cards.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/kernel.h>\n#include <linux/pci.h>\n#include <linux/slab.h>\n#include <asm/irq.h>\n#include <linux/interrupt.h>\n\n#include <media/dmxdev.h>\n#include <media/dvbdev.h>\n#include <media/dvb_demux.h>\n#include <media/dvb_frontend.h>\n#include <media/dvb_net.h>\n\n#include \"mantis_common.h\"\n#include \"hopper_vp3028.h\"\n#include \"mantis_dma.h\"\n#include \"mantis_dvb.h\"\n#include \"mantis_uart.h\"\n#include \"mantis_ioc.h\"\n#include \"mantis_pci.h\"\n#include \"mantis_i2c.h\"\n#include \"mantis_reg.h\"\n\nstatic unsigned int verbose;\nmodule_param(verbose, int, 0644);\nMODULE_PARM_DESC(verbose, \"verbose startup messages, default is 0 (no)\");\n\n#define DRIVER_NAME\t\"Hopper\"\n\nstatic char *label[10] = {\n\t\"DMA\",\n\t\"IRQ-0\",\n\t\"IRQ-1\",\n\t\"OCERR\",\n\t\"PABRT\",\n\t\"RIPRR\",\n\t\"PPERR\",\n\t\"FTRGT\",\n\t\"RISCI\",\n\t\"RACK\"\n};\n\nstatic int devs;\n\nstatic irqreturn_t hopper_irq_handler(int irq, void *dev_id)\n{\n\tu32 stat = 0, mask = 0;\n\tu32 rst_stat = 0, rst_mask = 0;\n\n\tstruct mantis_pci *mantis;\n\tstruct mantis_ca *ca;\n\n\tmantis = (struct mantis_pci *) dev_id;\n\tif (unlikely(!mantis))\n\t\treturn IRQ_NONE;\n\tca = mantis->mantis_ca;\n\n\tstat = mmread(MANTIS_INT_STAT);\n\tmask = mmread(MANTIS_INT_MASK);\n\tif (!(stat & mask))\n\t\treturn IRQ_NONE;\n\n\trst_mask  = MANTIS_GPIF_WRACK  |\n\t\t    MANTIS_GPIF_OTHERR |\n\t\t    MANTIS_SBUF_WSTO   |\n\t\t    MANTIS_GPIF_EXTIRQ;\n\n\trst_stat  = mmread(MANTIS_GPIF_STATUS);\n\trst_stat &= rst_mask;\n\tmmwrite(rst_stat, MANTIS_GPIF_STATUS);\n\n\tmantis->mantis_int_stat = stat;\n\tmantis->mantis_int_mask = mask;\n\tdprintk(MANTIS_DEBUG, 0, \"\\n-- Stat=<%02x> Mask=<%02x> --\", stat, mask);\n\tif (stat & MANTIS_INT_RISCEN) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[0]);\n\t}\n\tif (stat & MANTIS_INT_IRQ0) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[1]);\n\t\tmantis->gpif_status = rst_stat;\n\t\twake_up(&ca->hif_write_wq);\n\t\tschedule_work(&ca->hif_evm_work);\n\t}\n\tif (stat & MANTIS_INT_IRQ1) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[2]);\n\t\tspin_lock(&mantis->intmask_lock);\n\t\tmmwrite(mmread(MANTIS_INT_MASK) & ~MANTIS_INT_IRQ1,\n\t\t\tMANTIS_INT_MASK);\n\t\tspin_unlock(&mantis->intmask_lock);\n\t\tschedule_work(&mantis->uart_work);\n\t}\n\tif (stat & MANTIS_INT_OCERR) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[3]);\n\t}\n\tif (stat & MANTIS_INT_PABORT) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[4]);\n\t}\n\tif (stat & MANTIS_INT_RIPERR) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[5]);\n\t}\n\tif (stat & MANTIS_INT_PPERR) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[6]);\n\t}\n\tif (stat & MANTIS_INT_FTRGT) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[7]);\n\t}\n\tif (stat & MANTIS_INT_RISCI) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[8]);\n\t\tmantis->busy_block = (stat & MANTIS_INT_RISCSTAT) >> 28;\n\t\ttasklet_schedule(&mantis->tasklet);\n\t}\n\tif (stat & MANTIS_INT_I2CDONE) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[9]);\n\t\twake_up(&mantis->i2c_wq);\n\t}\n\tmmwrite(stat, MANTIS_INT_STAT);\n\tstat &= ~(MANTIS_INT_RISCEN   | MANTIS_INT_I2CDONE |\n\t\t  MANTIS_INT_I2CRACK  | MANTIS_INT_PCMCIA7 |\n\t\t  MANTIS_INT_PCMCIA6  | MANTIS_INT_PCMCIA5 |\n\t\t  MANTIS_INT_PCMCIA4  | MANTIS_INT_PCMCIA3 |\n\t\t  MANTIS_INT_PCMCIA2  | MANTIS_INT_PCMCIA1 |\n\t\t  MANTIS_INT_PCMCIA0  | MANTIS_INT_IRQ1\t   |\n\t\t  MANTIS_INT_IRQ0     | MANTIS_INT_OCERR   |\n\t\t  MANTIS_INT_PABORT   | MANTIS_INT_RIPERR  |\n\t\t  MANTIS_INT_PPERR    | MANTIS_INT_FTRGT   |\n\t\t  MANTIS_INT_RISCI);\n\n\tif (stat)\n\t\tdprintk(MANTIS_DEBUG, 0, \"<Unknown> Stat=<%02x> Mask=<%02x>\", stat, mask);\n\n\tdprintk(MANTIS_DEBUG, 0, \"\\n\");\n\treturn IRQ_HANDLED;\n}\n\nstatic int hopper_pci_probe(struct pci_dev *pdev,\n\t\t\t    const struct pci_device_id *pci_id)\n{\n\tstruct mantis_pci_drvdata *drvdata;\n\tstruct mantis_pci *mantis;\n\tstruct mantis_hwconfig *config;\n\tint err;\n\n\tmantis = kzalloc(sizeof(*mantis), GFP_KERNEL);\n\tif (!mantis) {\n\t\terr = -ENOMEM;\n\t\tgoto fail0;\n\t}\n\n\tdrvdata\t\t\t= (void *)pci_id->driver_data;\n\tmantis->num\t\t= devs;\n\tmantis->verbose\t\t= verbose;\n\tmantis->pdev\t\t= pdev;\n\tconfig\t\t\t= drvdata->hwconfig;\n\tconfig->irq_handler\t= &hopper_irq_handler;\n\tmantis->hwconfig\t= config;\n\tmantis->rc_map_name\t= drvdata->rc_map_name;\n\n\tspin_lock_init(&mantis->intmask_lock);\n\n\terr = mantis_pci_init(mantis);\n\tif (err) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis PCI initialization failed <%d>\", err);\n\t\tgoto fail1;\n\t}\n\n\terr = mantis_stream_control(mantis, STREAM_TO_HIF);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis stream control failed <%d>\", err);\n\t\tgoto fail1;\n\t}\n\n\terr = mantis_i2c_init(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis I2C initialization failed <%d>\", err);\n\t\tgoto fail2;\n\t}\n\n\terr = mantis_get_mac(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis MAC address read failed <%d>\", err);\n\t\tgoto fail2;\n\t}\n\n\terr = mantis_dma_init(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis DMA initialization failed <%d>\", err);\n\t\tgoto fail3;\n\t}\n\n\terr = mantis_dvb_init(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis DVB initialization failed <%d>\", err);\n\t\tgoto fail4;\n\t}\n\tdevs++;\n\n\treturn err;\n\nfail4:\n\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis DMA exit! <%d>\", err);\n\tmantis_dma_exit(mantis);\n\nfail3:\n\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis I2C exit! <%d>\", err);\n\tmantis_i2c_exit(mantis);\n\nfail2:\n\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis PCI exit! <%d>\", err);\n\tmantis_pci_exit(mantis);\n\nfail1:\n\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis free! <%d>\", err);\n\tkfree(mantis);\n\nfail0:\n\treturn err;\n}\n\nstatic void hopper_pci_remove(struct pci_dev *pdev)\n{\n\tstruct mantis_pci *mantis = pci_get_drvdata(pdev);\n\n\tif (mantis) {\n\t\tmantis_dvb_exit(mantis);\n\t\tmantis_dma_exit(mantis);\n\t\tmantis_i2c_exit(mantis);\n\t\tmantis_pci_exit(mantis);\n\t\tkfree(mantis);\n\t}\n\treturn;\n\n}\n\nstatic const struct pci_device_id hopper_pci_table[] = {\n\tMAKE_ENTRY(TWINHAN_TECHNOLOGIES, MANTIS_VP_3028_DVB_T, &vp3028_config,\n\t\t   NULL),\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(pci, hopper_pci_table);\n\nstatic struct pci_driver hopper_pci_driver = {\n\t.name\t\t= DRIVER_NAME,\n\t.id_table\t= hopper_pci_table,\n\t.probe\t\t= hopper_pci_probe,\n\t.remove\t\t= hopper_pci_remove,\n};\n\nmodule_pci_driver(hopper_pci_driver);\n\nMODULE_DESCRIPTION(\"HOPPER driver\");\nMODULE_AUTHOR(\"Manu Abraham\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}