{
  "module_name": "mantis_vp1033.c",
  "hash_id": "57c96dd6055a514eed40c61557683f8ab7060a1182460e76cee9cf6d82cec47a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/mantis/mantis_vp1033.c",
  "human_readable_source": "\n \n\n#include <linux/signal.h>\n#include <linux/sched.h>\n#include <linux/interrupt.h>\n\n#include <media/dmxdev.h>\n#include <media/dvbdev.h>\n#include <media/dvb_demux.h>\n#include <media/dvb_frontend.h>\n#include <media/dvb_net.h>\n\n#include \"stv0299.h\"\n#include \"mantis_common.h\"\n#include \"mantis_ioc.h\"\n#include \"mantis_dvb.h\"\n#include \"mantis_vp1033.h\"\n#include \"mantis_reg.h\"\n\nstatic u8 lgtdqcs001f_inittab[] = {\n\t0x01, 0x15,\n\t0x02, 0x30,\n\t0x03, 0x00,\n\t0x04, 0x2a,\n\t0x05, 0x85,\n\t0x06, 0x02,\n\t0x07, 0x00,\n\t0x08, 0x00,\n\t0x0c, 0x01,\n\t0x0d, 0x81,\n\t0x0e, 0x44,\n\t0x0f, 0x94,\n\t0x10, 0x3c,\n\t0x11, 0x84,\n\t0x12, 0xb9,\n\t0x13, 0xb5,\n\t0x14, 0x4f,\n\t0x15, 0xc9,\n\t0x16, 0x80,\n\t0x17, 0x36,\n\t0x18, 0xfb,\n\t0x19, 0xcf,\n\t0x1a, 0xbc,\n\t0x1c, 0x2b,\n\t0x1d, 0x27,\n\t0x1e, 0x00,\n\t0x1f, 0x0b,\n\t0x20, 0xa1,\n\t0x21, 0x60,\n\t0x22, 0x00,\n\t0x23, 0x00,\n\t0x28, 0x00,\n\t0x29, 0x28,\n\t0x2a, 0x14,\n\t0x2b, 0x0f,\n\t0x2c, 0x09,\n\t0x2d, 0x05,\n\t0x31, 0x1f,\n\t0x32, 0x19,\n\t0x33, 0xfc,\n\t0x34, 0x13,\n\t0xff, 0xff,\n};\n\n#define MANTIS_MODEL_NAME\t\"VP-1033\"\n#define MANTIS_DEV_TYPE\t\t\"DVB-S/DSS\"\n\nstatic int lgtdqcs001f_tuner_set(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\tstruct mantis_pci *mantis\t= fe->dvb->priv;\n\tstruct i2c_adapter *adapter\t= &mantis->adapter;\n\n\tu8 buf[4];\n\tu32 div;\n\n\n\tstruct i2c_msg msg = {.addr = 0x61, .flags = 0, .buf = buf, .len = sizeof(buf)};\n\n\tdiv = p->frequency / 250;\n\n\tbuf[0] = (div >> 8) & 0x7f;\n\tbuf[1] =  div & 0xff;\n\tbuf[2] =  0x83;\n\tbuf[3] =  0xc0;\n\n\tif (p->frequency < 1531000)\n\t\tbuf[3] |= 0x04;\n\telse\n\t\tbuf[3] &= ~0x04;\n\tif (i2c_transfer(adapter, &msg, 1) < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"Write: I2C Transfer failed\");\n\t\treturn -EIO;\n\t}\n\tmsleep_interruptible(100);\n\n\treturn 0;\n}\n\nstatic int lgtdqcs001f_set_symbol_rate(struct dvb_frontend *fe,\n\t\t\t\t       u32 srate, u32 ratio)\n{\n\tu8 aclk = 0;\n\tu8 bclk = 0;\n\n\tif (srate < 1500000) {\n\t\taclk = 0xb7;\n\t\tbclk = 0x47;\n\t} else if (srate < 3000000) {\n\t\taclk = 0xb7;\n\t\tbclk = 0x4b;\n\t} else if (srate < 7000000) {\n\t\taclk = 0xb7;\n\t\tbclk = 0x4f;\n\t} else if (srate < 14000000) {\n\t\taclk = 0xb7;\n\t\tbclk = 0x53;\n\t} else if (srate < 30000000) {\n\t\taclk = 0xb6;\n\t\tbclk = 0x53;\n\t} else if (srate < 45000000) {\n\t\taclk = 0xb4;\n\t\tbclk = 0x51;\n\t}\n\tstv0299_writereg(fe, 0x13, aclk);\n\tstv0299_writereg(fe, 0x14, bclk);\n\n\tstv0299_writereg(fe, 0x1f, (ratio >> 16) & 0xff);\n\tstv0299_writereg(fe, 0x20, (ratio >>  8) & 0xff);\n\tstv0299_writereg(fe, 0x21,  ratio & 0xf0);\n\n\treturn 0;\n}\n\nstatic struct stv0299_config lgtdqcs001f_config = {\n\t.demod_address\t\t= 0x68,\n\t.inittab\t\t= lgtdqcs001f_inittab,\n\t.mclk\t\t\t= 88000000UL,\n\t.invert\t\t\t= 0,\n\t.skip_reinit\t\t= 0,\n\t.volt13_op0_op1\t\t= STV0299_VOLT13_OP0,\n\t.min_delay_ms\t\t= 100,\n\t.set_symbol_rate\t= lgtdqcs001f_set_symbol_rate,\n};\n\nstatic int vp1033_frontend_init(struct mantis_pci *mantis, struct dvb_frontend *fe)\n{\n\tstruct i2c_adapter *adapter\t= &mantis->adapter;\n\n\tint err = 0;\n\n\terr = mantis_frontend_power(mantis, POWER_ON);\n\tif (err == 0) {\n\t\tmantis_frontend_soft_reset(mantis);\n\t\tmsleep(250);\n\n\t\tdprintk(MANTIS_ERROR, 1, \"Probing for STV0299 (DVB-S)\");\n\t\tfe = dvb_attach(stv0299_attach, &lgtdqcs001f_config, adapter);\n\n\t\tif (fe) {\n\t\t\tfe->ops.tuner_ops.set_params = lgtdqcs001f_tuner_set;\n\t\t\tdprintk(MANTIS_ERROR, 1, \"found STV0299 DVB-S frontend @ 0x%02x\",\n\t\t\t\tlgtdqcs001f_config.demod_address);\n\n\t\t\tdprintk(MANTIS_ERROR, 1, \"Mantis DVB-S STV0299 frontend attach success\");\n\t\t} else {\n\t\t\treturn -1;\n\t\t}\n\t} else {\n\t\tdprintk(MANTIS_ERROR, 1, \"Frontend on <%s> POWER ON failed! <%d>\",\n\t\t\tadapter->name,\n\t\t\terr);\n\n\t\treturn -EIO;\n\t}\n\tmantis->fe = fe;\n\tdprintk(MANTIS_ERROR, 1, \"Done!\");\n\n\treturn 0;\n}\n\nstruct mantis_hwconfig vp1033_config = {\n\t.model_name\t\t= MANTIS_MODEL_NAME,\n\t.dev_type\t\t= MANTIS_DEV_TYPE,\n\t.ts_size\t\t= MANTIS_TS_204,\n\n\t.baud_rate\t\t= MANTIS_BAUD_9600,\n\t.parity\t\t\t= MANTIS_PARITY_NONE,\n\t.bytes\t\t\t= 0,\n\n\t.frontend_init\t\t= vp1033_frontend_init,\n\t.power\t\t\t= GPIF_A12,\n\t.reset\t\t\t= GPIF_A13,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}