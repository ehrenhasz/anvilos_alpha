{
  "module_name": "mantis_dvb.c",
  "hash_id": "09fd578431b9651bb7a13078110b403b7e657b030fb931ce56cd7cfc125eeaad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/mantis/mantis_dvb.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/bitops.h>\n\n#include <linux/signal.h>\n#include <linux/sched.h>\n#include <linux/interrupt.h>\n#include <linux/pci.h>\n#include <linux/i2c.h>\n\n#include <media/dmxdev.h>\n#include <media/dvbdev.h>\n#include <media/dvb_demux.h>\n#include <media/dvb_frontend.h>\n#include <media/dvb_net.h>\n\n#include \"mantis_common.h\"\n#include \"mantis_dma.h\"\n#include \"mantis_ca.h\"\n#include \"mantis_ioc.h\"\n#include \"mantis_dvb.h\"\n\nDVB_DEFINE_MOD_OPT_ADAPTER_NR(adapter_nr);\n\nint mantis_frontend_power(struct mantis_pci *mantis, enum mantis_power power)\n{\n\tstruct mantis_hwconfig *config = mantis->hwconfig;\n\n\tswitch (power) {\n\tcase POWER_ON:\n\t\tdprintk(MANTIS_DEBUG, 1, \"Power ON\");\n\t\tmantis_gpio_set_bits(mantis, config->power, POWER_ON);\n\t\tmsleep(100);\n\t\tmantis_gpio_set_bits(mantis, config->power, POWER_ON);\n\t\tmsleep(100);\n\t\tbreak;\n\n\tcase POWER_OFF:\n\t\tdprintk(MANTIS_DEBUG, 1, \"Power OFF\");\n\t\tmantis_gpio_set_bits(mantis, config->power, POWER_OFF);\n\t\tmsleep(100);\n\t\tbreak;\n\n\tdefault:\n\t\tdprintk(MANTIS_DEBUG, 1, \"Unknown state <%02x>\", power);\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mantis_frontend_power);\n\nvoid mantis_frontend_soft_reset(struct mantis_pci *mantis)\n{\n\tstruct mantis_hwconfig *config = mantis->hwconfig;\n\n\tdprintk(MANTIS_DEBUG, 1, \"Frontend RESET\");\n\tmantis_gpio_set_bits(mantis, config->reset, 0);\n\tmsleep(100);\n\tmantis_gpio_set_bits(mantis, config->reset, 0);\n\tmsleep(100);\n\tmantis_gpio_set_bits(mantis, config->reset, 1);\n\tmsleep(100);\n\tmantis_gpio_set_bits(mantis, config->reset, 1);\n\tmsleep(100);\n\n\treturn;\n}\nEXPORT_SYMBOL_GPL(mantis_frontend_soft_reset);\n\nstatic int mantis_frontend_shutdown(struct mantis_pci *mantis)\n{\n\tint err;\n\n\tmantis_frontend_soft_reset(mantis);\n\terr = mantis_frontend_power(mantis, POWER_OFF);\n\tif (err != 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"Frontend POWER OFF failed! <%d>\", err);\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\nstatic int mantis_dvb_start_feed(struct dvb_demux_feed *dvbdmxfeed)\n{\n\tstruct dvb_demux *dvbdmx = dvbdmxfeed->demux;\n\tstruct mantis_pci *mantis = dvbdmx->priv;\n\n\tdprintk(MANTIS_DEBUG, 1, \"Mantis DVB Start feed\");\n\tif (!dvbdmx->dmx.frontend) {\n\t\tdprintk(MANTIS_DEBUG, 1, \"no frontend ?\");\n\t\treturn -EINVAL;\n\t}\n\n\tmantis->feeds++;\n\tdprintk(MANTIS_DEBUG, 1, \"mantis start feed, feeds=%d\",\tmantis->feeds);\n\n\tif (mantis->feeds == 1)\t {\n\t\tdprintk(MANTIS_DEBUG, 1, \"mantis start feed & dma\");\n\t\tmantis_dma_start(mantis);\n\t\ttasklet_enable(&mantis->tasklet);\n\t}\n\n\treturn mantis->feeds;\n}\n\nstatic int mantis_dvb_stop_feed(struct dvb_demux_feed *dvbdmxfeed)\n{\n\tstruct dvb_demux *dvbdmx = dvbdmxfeed->demux;\n\tstruct mantis_pci *mantis = dvbdmx->priv;\n\n\tdprintk(MANTIS_DEBUG, 1, \"Mantis DVB Stop feed\");\n\tif (!dvbdmx->dmx.frontend) {\n\t\tdprintk(MANTIS_DEBUG, 1, \"no frontend ?\");\n\t\treturn -EINVAL;\n\t}\n\n\tmantis->feeds--;\n\tif (mantis->feeds == 0) {\n\t\tdprintk(MANTIS_DEBUG, 1, \"mantis stop feed and dma\");\n\t\ttasklet_disable(&mantis->tasklet);\n\t\tmantis_dma_stop(mantis);\n\t}\n\n\treturn 0;\n}\n\nint mantis_dvb_init(struct mantis_pci *mantis)\n{\n\tstruct mantis_hwconfig *config = mantis->hwconfig;\n\tint result;\n\n\tdprintk(MANTIS_DEBUG, 1, \"dvb_register_adapter\");\n\n\tresult = dvb_register_adapter(&mantis->dvb_adapter,\n\t\t\t\t      \"Mantis DVB adapter\",\n\t\t\t\t      THIS_MODULE,\n\t\t\t\t      &mantis->pdev->dev,\n\t\t\t\t      adapter_nr);\n\n\tif (result < 0) {\n\n\t\tdprintk(MANTIS_ERROR, 1, \"Error registering adapter\");\n\t\treturn -ENODEV;\n\t}\n\n\tmantis->dvb_adapter.priv\t= mantis;\n\tmantis->demux.dmx.capabilities\t= DMX_TS_FILTERING\t|\n\t\t\t\t\t DMX_SECTION_FILTERING\t|\n\t\t\t\t\t DMX_MEMORY_BASED_FILTERING;\n\n\tmantis->demux.priv\t\t= mantis;\n\tmantis->demux.filternum\t\t= 256;\n\tmantis->demux.feednum\t\t= 256;\n\tmantis->demux.start_feed\t= mantis_dvb_start_feed;\n\tmantis->demux.stop_feed\t\t= mantis_dvb_stop_feed;\n\tmantis->demux.write_to_decoder\t= NULL;\n\n\tdprintk(MANTIS_DEBUG, 1, \"dvb_dmx_init\");\n\tresult = dvb_dmx_init(&mantis->demux);\n\tif (result < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"dvb_dmx_init failed, ERROR=%d\", result);\n\n\t\tgoto err0;\n\t}\n\n\tmantis->dmxdev.filternum\t= 256;\n\tmantis->dmxdev.demux\t\t= &mantis->demux.dmx;\n\tmantis->dmxdev.capabilities\t= 0;\n\tdprintk(MANTIS_DEBUG, 1, \"dvb_dmxdev_init\");\n\n\tresult = dvb_dmxdev_init(&mantis->dmxdev, &mantis->dvb_adapter);\n\tif (result < 0) {\n\n\t\tdprintk(MANTIS_ERROR, 1, \"dvb_dmxdev_init failed, ERROR=%d\", result);\n\t\tgoto err1;\n\t}\n\n\tmantis->fe_hw.source\t\t= DMX_FRONTEND_0;\n\tresult = mantis->demux.dmx.add_frontend(&mantis->demux.dmx, &mantis->fe_hw);\n\tif (result < 0) {\n\n\t\tdprintk(MANTIS_ERROR, 1, \"dvb_dmx_init failed, ERROR=%d\", result);\n\t\tgoto err2;\n\t}\n\n\tmantis->fe_mem.source\t\t= DMX_MEMORY_FE;\n\tresult = mantis->demux.dmx.add_frontend(&mantis->demux.dmx, &mantis->fe_mem);\n\tif (result < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"dvb_dmx_init failed, ERROR=%d\", result);\n\t\tgoto err3;\n\t}\n\n\tresult = mantis->demux.dmx.connect_frontend(&mantis->demux.dmx, &mantis->fe_hw);\n\tif (result < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"dvb_dmx_init failed, ERROR=%d\", result);\n\t\tgoto err4;\n\t}\n\n\tdvb_net_init(&mantis->dvb_adapter, &mantis->dvbnet, &mantis->demux.dmx);\n\ttasklet_setup(&mantis->tasklet, mantis_dma_xfer);\n\ttasklet_disable(&mantis->tasklet);\n\tif (mantis->hwconfig) {\n\t\tresult = config->frontend_init(mantis, mantis->fe);\n\t\tif (result < 0) {\n\t\t\tdprintk(MANTIS_ERROR, 1, \"!!! NO Frontends found !!!\");\n\t\t\tgoto err5;\n\t\t} else {\n\t\t\tif (mantis->fe == NULL) {\n\t\t\t\tresult = -ENOMEM;\n\t\t\t\tdprintk(MANTIS_ERROR, 1, \"FE <NULL>\");\n\t\t\t\tgoto err5;\n\t\t\t}\n\t\t\tresult = dvb_register_frontend(&mantis->dvb_adapter, mantis->fe);\n\t\t\tif (result) {\n\t\t\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Frontend registration failed\");\n\n\t\t\t\tif (mantis->fe->ops.release)\n\t\t\t\t\tmantis->fe->ops.release(mantis->fe);\n\n\t\t\t\tmantis->fe = NULL;\n\t\t\t\tgoto err5;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\n\n\t \nerr5:\n\ttasklet_kill(&mantis->tasklet);\n\tdvb_net_release(&mantis->dvbnet);\n\tif (mantis->fe) {\n\t\tdvb_unregister_frontend(mantis->fe);\n\t\tdvb_frontend_detach(mantis->fe);\n\t}\nerr4:\n\tmantis->demux.dmx.remove_frontend(&mantis->demux.dmx, &mantis->fe_mem);\n\nerr3:\n\tmantis->demux.dmx.remove_frontend(&mantis->demux.dmx, &mantis->fe_hw);\n\nerr2:\n\tdvb_dmxdev_release(&mantis->dmxdev);\n\nerr1:\n\tdvb_dmx_release(&mantis->demux);\n\nerr0:\n\tdvb_unregister_adapter(&mantis->dvb_adapter);\n\n\treturn result;\n}\nEXPORT_SYMBOL_GPL(mantis_dvb_init);\n\nint mantis_dvb_exit(struct mantis_pci *mantis)\n{\n\tint err;\n\n\tif (mantis->fe) {\n\t\t \n\t\terr = mantis_frontend_shutdown(mantis);\n\t\tif (err != 0)\n\t\t\tdprintk(MANTIS_ERROR, 1, \"Frontend exit while POWER ON! <%d>\", err);\n\t\tdvb_unregister_frontend(mantis->fe);\n\t\tdvb_frontend_detach(mantis->fe);\n\t}\n\n\ttasklet_kill(&mantis->tasklet);\n\tdvb_net_release(&mantis->dvbnet);\n\n\tmantis->demux.dmx.remove_frontend(&mantis->demux.dmx, &mantis->fe_mem);\n\tmantis->demux.dmx.remove_frontend(&mantis->demux.dmx, &mantis->fe_hw);\n\n\tdvb_dmxdev_release(&mantis->dmxdev);\n\tdvb_dmx_release(&mantis->demux);\n\n\tdprintk(MANTIS_DEBUG, 1, \"dvb_unregister_adapter\");\n\tdvb_unregister_adapter(&mantis->dvb_adapter);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mantis_dvb_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}