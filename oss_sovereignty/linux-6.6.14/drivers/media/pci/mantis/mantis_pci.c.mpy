{
  "module_name": "mantis_pci.c",
  "hash_id": "b14836313cd3a1ebf042c31d7005319d06e399f269ce2c7b1689d7f9e8123480",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/mantis/mantis_pci.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/kernel.h>\n#include <asm/io.h>\n#include <asm/page.h>\n#include <linux/kmod.h>\n#include <linux/vmalloc.h>\n#include <linux/init.h>\n#include <linux/device.h>\n#include <linux/pci.h>\n\n#include <asm/irq.h>\n#include <linux/signal.h>\n#include <linux/sched.h>\n#include <linux/interrupt.h>\n\n#include <media/dmxdev.h>\n#include <media/dvbdev.h>\n#include <media/dvb_demux.h>\n#include <media/dvb_frontend.h>\n#include <media/dvb_net.h>\n\n#include \"mantis_common.h\"\n#include \"mantis_reg.h\"\n#include \"mantis_pci.h\"\n\n#define DRIVER_NAME\t\t\"Mantis Core\"\n\nint mantis_pci_init(struct mantis_pci *mantis)\n{\n\tu8 latency;\n\tstruct mantis_hwconfig *config\t= mantis->hwconfig;\n\tstruct pci_dev *pdev\t\t= mantis->pdev;\n\tint err, ret = 0;\n\n\tdprintk(MANTIS_ERROR, 0, \"found a %s PCI %s device on (%02x:%02x.%x),\\n\",\n\t\tconfig->model_name,\n\t\tconfig->dev_type,\n\t\tmantis->pdev->bus->number,\n\t\tPCI_SLOT(mantis->pdev->devfn),\n\t\tPCI_FUNC(mantis->pdev->devfn));\n\n\terr = pci_enable_device(pdev);\n\tif (err != 0) {\n\t\tret = -ENODEV;\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: PCI enable failed <%i>\", err);\n\t\tgoto fail0;\n\t}\n\n\terr = dma_set_coherent_mask(&pdev->dev, DMA_BIT_MASK(32));\n\tif (err != 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Unable to obtain 32 bit DMA <%i>\", err);\n\t\tret = -ENOMEM;\n\t\tgoto fail1;\n\t}\n\n\tpci_set_master(pdev);\n\n\tif (!request_mem_region(pci_resource_start(pdev, 0),\n\t\t\t\tpci_resource_len(pdev, 0),\n\t\t\t\tDRIVER_NAME)) {\n\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: BAR0 Request failed !\");\n\t\tret = -ENODEV;\n\t\tgoto fail1;\n\t}\n\n\tmantis->mmio = ioremap(pci_resource_start(pdev, 0),\n\t\t\t       pci_resource_len(pdev, 0));\n\n\tif (!mantis->mmio) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: BAR0 remap failed !\");\n\t\tret = -ENODEV;\n\t\tgoto fail2;\n\t}\n\n\tpci_read_config_byte(pdev, PCI_LATENCY_TIMER, &latency);\n\tmantis->latency = latency;\n\tmantis->revision = pdev->revision;\n\n\tdprintk(MANTIS_ERROR, 0, \"    Mantis Rev %d [%04x:%04x], \",\n\t\tmantis->revision,\n\t\tmantis->pdev->subsystem_vendor,\n\t\tmantis->pdev->subsystem_device);\n\n\tdprintk(MANTIS_ERROR, 0,\n\t\t\"irq: %d, latency: %d\\n    memory: 0x%lx, mmio: 0x%p\\n\",\n\t\tmantis->pdev->irq,\n\t\tmantis->latency,\n\t\tmantis->mantis_addr,\n\t\tmantis->mmio);\n\n\terr = request_irq(pdev->irq,\n\t\t\t  config->irq_handler,\n\t\t\t  IRQF_SHARED,\n\t\t\t  DRIVER_NAME,\n\t\t\t  mantis);\n\n\tif (err != 0) {\n\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: IRQ registration failed ! <%d>\", err);\n\t\tret = -ENODEV;\n\t\tgoto fail3;\n\t}\n\n\tpci_set_drvdata(pdev, mantis);\n\treturn ret;\n\n\t \nfail3:\n\tdprintk(MANTIS_ERROR, 1, \"ERROR: <%d> I/O unmap\", ret);\n\tif (mantis->mmio)\n\t\tiounmap(mantis->mmio);\n\nfail2:\n\tdprintk(MANTIS_ERROR, 1, \"ERROR: <%d> releasing regions\", ret);\n\trelease_mem_region(pci_resource_start(pdev, 0),\n\t\t\t   pci_resource_len(pdev, 0));\n\nfail1:\n\tdprintk(MANTIS_ERROR, 1, \"ERROR: <%d> disabling device\", ret);\n\tpci_disable_device(pdev);\n\nfail0:\n\tdprintk(MANTIS_ERROR, 1, \"ERROR: <%d> exiting\", ret);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(mantis_pci_init);\n\nvoid mantis_pci_exit(struct mantis_pci *mantis)\n{\n\tstruct pci_dev *pdev = mantis->pdev;\n\n\tdprintk(MANTIS_NOTICE, 1, \" mem: 0x%p\", mantis->mmio);\n\tfree_irq(pdev->irq, mantis);\n\tif (mantis->mmio) {\n\t\tiounmap(mantis->mmio);\n\t\trelease_mem_region(pci_resource_start(pdev, 0),\n\t\t\t\t   pci_resource_len(pdev, 0));\n\t}\n\n\tpci_disable_device(pdev);\n}\nEXPORT_SYMBOL_GPL(mantis_pci_exit);\n\nMODULE_DESCRIPTION(\"Mantis PCI DTV bridge driver\");\nMODULE_AUTHOR(\"Manu Abraham\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}