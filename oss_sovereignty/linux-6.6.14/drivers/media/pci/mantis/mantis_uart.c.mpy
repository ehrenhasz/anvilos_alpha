{
  "module_name": "mantis_uart.c",
  "hash_id": "b43a26e18793421ccb13ce38b9510d04f7be8c4c66db5e5d2c097913480e3f1f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/mantis/mantis_uart.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/spinlock.h>\n#include <asm/io.h>\n\n#include <linux/signal.h>\n#include <linux/sched.h>\n#include <linux/interrupt.h>\n#include <linux/pci.h>\n\n#include <media/dmxdev.h>\n#include <media/dvbdev.h>\n#include <media/dvb_demux.h>\n#include <media/dvb_frontend.h>\n#include <media/dvb_net.h>\n\n#include \"mantis_common.h\"\n#include \"mantis_reg.h\"\n#include \"mantis_uart.h\"\n#include \"mantis_input.h\"\n\nstruct mantis_uart_params {\n\tenum mantis_baud\tbaud_rate;\n\tenum mantis_parity\tparity;\n};\n\nstatic struct {\n\tchar string[7];\n} rates[5] = {\n\t{ \"9600\" },\n\t{ \"19200\" },\n\t{ \"38400\" },\n\t{ \"57600\" },\n\t{ \"115200\" }\n};\n\nstatic struct {\n\tchar string[5];\n} parity[3] = {\n\t{ \"NONE\" },\n\t{ \"ODD\" },\n\t{ \"EVEN\" }\n};\n\nstatic void mantis_uart_read(struct mantis_pci *mantis)\n{\n\tstruct mantis_hwconfig *config = mantis->hwconfig;\n\tint i, scancode = 0, err = 0;\n\n\t \n\tdprintk(MANTIS_DEBUG, 1, \"UART Reading ...\");\n\tfor (i = 0; i < (config->bytes + 1); i++) {\n\t\tint data = mmread(MANTIS_UART_RXD);\n\n\t\tdprintk(MANTIS_DEBUG, 0, \" <%02x>\", data);\n\n\t\tscancode = (scancode << 8) | (data & 0x3f);\n\t\terr |= data;\n\n\t\tif (data & (1 << 7))\n\t\t\tdprintk(MANTIS_ERROR, 1, \"UART framing error\");\n\n\t\tif (data & (1 << 6))\n\t\t\tdprintk(MANTIS_ERROR, 1, \"UART parity error\");\n\t}\n\tdprintk(MANTIS_DEBUG, 0, \"\\n\");\n\n\tif ((err & 0xC0) == 0)\n\t\tmantis_input_process(mantis, scancode);\n}\n\nstatic void mantis_uart_work(struct work_struct *work)\n{\n\tstruct mantis_pci *mantis = container_of(work, struct mantis_pci, uart_work);\n\tu32 stat;\n\tunsigned long timeout;\n\n\tstat = mmread(MANTIS_UART_STAT);\n\n\tif (stat & MANTIS_UART_RXFIFO_FULL)\n\t\tdprintk(MANTIS_ERROR, 1, \"RX Fifo FULL\");\n\n\t \n\n\t \n\ttimeout = jiffies +  msecs_to_jiffies(10);\n\twhile (stat & MANTIS_UART_RXFIFO_DATA) {\n\t\tmantis_uart_read(mantis);\n\t\tstat = mmread(MANTIS_UART_STAT);\n\n\t\tif (!time_is_after_jiffies(timeout))\n\t\t\tbreak;\n\t}\n\n\t \n\tmantis_unmask_ints(mantis, MANTIS_INT_IRQ1);\n}\n\nstatic int mantis_uart_setup(struct mantis_pci *mantis,\n\t\t\t     struct mantis_uart_params *params)\n{\n\tu32 reg;\n\n\tmmwrite((mmread(MANTIS_UART_CTL) | (params->parity & 0x3)), MANTIS_UART_CTL);\n\n\treg = mmread(MANTIS_UART_BAUD);\n\n\tswitch (params->baud_rate) {\n\tcase MANTIS_BAUD_9600:\n\t\treg |= 0xd8;\n\t\tbreak;\n\tcase MANTIS_BAUD_19200:\n\t\treg |= 0x6c;\n\t\tbreak;\n\tcase MANTIS_BAUD_38400:\n\t\treg |= 0x36;\n\t\tbreak;\n\tcase MANTIS_BAUD_57600:\n\t\treg |= 0x23;\n\t\tbreak;\n\tcase MANTIS_BAUD_115200:\n\t\treg |= 0x11;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tmmwrite(reg, MANTIS_UART_BAUD);\n\n\treturn 0;\n}\n\nint mantis_uart_init(struct mantis_pci *mantis)\n{\n\tstruct mantis_hwconfig *config = mantis->hwconfig;\n\tstruct mantis_uart_params params;\n\n\t \n\tparams.baud_rate = config->baud_rate;\n\tparams.parity = config->parity;\n\tdprintk(MANTIS_INFO, 1, \"Initializing UART @ %sbps parity:%s\",\n\t\trates[params.baud_rate].string,\n\t\tparity[params.parity].string);\n\n\tINIT_WORK(&mantis->uart_work, mantis_uart_work);\n\n\t \n\tmmwrite(mmread(MANTIS_UART_CTL) & 0xffef, MANTIS_UART_CTL);\n\n\tmantis_uart_setup(mantis, &params);\n\n\t \n\tmmwrite((mmread(MANTIS_UART_BAUD) | (config->bytes << 8)), MANTIS_UART_BAUD);\n\n\t \n\tmmwrite((mmread(MANTIS_UART_CTL) | MANTIS_UART_RXFLUSH), MANTIS_UART_CTL);\n\n\t \n\tmmwrite(mmread(MANTIS_UART_CTL) | MANTIS_UART_RXINT, MANTIS_UART_CTL);\n\tmantis_unmask_ints(mantis, MANTIS_INT_IRQ1);\n\n\tschedule_work(&mantis->uart_work);\n\tdprintk(MANTIS_DEBUG, 1, \"UART successfully initialized\");\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mantis_uart_init);\n\nvoid mantis_uart_exit(struct mantis_pci *mantis)\n{\n\t \n\tmantis_mask_ints(mantis, MANTIS_INT_IRQ1);\n\tmmwrite(mmread(MANTIS_UART_CTL) & 0xffef, MANTIS_UART_CTL);\n\tflush_work(&mantis->uart_work);\n}\nEXPORT_SYMBOL_GPL(mantis_uart_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}