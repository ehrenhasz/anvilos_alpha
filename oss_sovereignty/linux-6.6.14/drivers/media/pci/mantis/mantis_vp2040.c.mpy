{
  "module_name": "mantis_vp2040.c",
  "hash_id": "427247116198af30fb08d74c9cdf3cd856f144af891afde8d71fc646eedec8e5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/mantis/mantis_vp2040.c",
  "human_readable_source": "\n \n\n#include <linux/signal.h>\n#include <linux/sched.h>\n#include <linux/interrupt.h>\n\n#include <media/dmxdev.h>\n#include <media/dvbdev.h>\n#include <media/dvb_demux.h>\n#include <media/dvb_frontend.h>\n#include <media/dvb_net.h>\n\n#include \"tda1002x.h\"\n#include \"mantis_common.h\"\n#include \"mantis_ioc.h\"\n#include \"mantis_dvb.h\"\n#include \"mantis_vp2040.h\"\n\n#define MANTIS_MODEL_NAME\t\"VP-2040\"\n#define MANTIS_DEV_TYPE\t\t\"DVB-C\"\n\nstatic struct tda1002x_config vp2040_tda1002x_cu1216_config = {\n\t.demod_address\t= 0x18 >> 1,\n\t.invert\t\t= 1,\n};\n\nstatic struct tda10023_config vp2040_tda10023_cu1216_config = {\n\t.demod_address\t= 0x18 >> 1,\n\t.invert\t\t= 1,\n};\n\nstatic int tda1002x_cu1216_tuner_set(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\tstruct mantis_pci *mantis\t= fe->dvb->priv;\n\tstruct i2c_adapter *adapter\t= &mantis->adapter;\n\n\tu8 buf[6];\n\tstruct i2c_msg msg = {.addr = 0x60, .flags = 0, .buf = buf, .len = sizeof(buf)};\n\tint i;\n\n#define CU1216_IF 36125000\n#define TUNER_MUL 62500\n\n\tu32 div = (p->frequency + CU1216_IF + TUNER_MUL / 2) / TUNER_MUL;\n\n\tbuf[0] = (div >> 8) & 0x7f;\n\tbuf[1] = div & 0xff;\n\tbuf[2] = 0xce;\n\tbuf[3] = (p->frequency < 150000000 ? 0x01 :\n\t\t  p->frequency < 445000000 ? 0x02 : 0x04);\n\tbuf[4] = 0xde;\n\tbuf[5] = 0x20;\n\n\tif (fe->ops.i2c_gate_ctrl)\n\t\tfe->ops.i2c_gate_ctrl(fe, 1);\n\n\tif (i2c_transfer(adapter, &msg, 1) != 1)\n\t\treturn -EIO;\n\n\t \n\tmsg.flags = I2C_M_RD;\n\tmsg.len = 1;\n\tfor (i = 0; i < 20; i++) {\n\t\tif (fe->ops.i2c_gate_ctrl)\n\t\t\tfe->ops.i2c_gate_ctrl(fe, 1);\n\n\t\tif (i2c_transfer(adapter, &msg, 1) == 1 && (buf[0] & 0x40))\n\t\t\tbreak;\n\n\t\tmsleep(10);\n\t}\n\n\t \n\tmsg.flags = 0;\n\tmsg.len = 2;\n\tmsg.buf = &buf[2];\n\tbuf[2] &= ~0x40;\n\tif (fe->ops.i2c_gate_ctrl)\n\t\tfe->ops.i2c_gate_ctrl(fe, 1);\n\n\tif (i2c_transfer(adapter, &msg, 1) != 1)\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\nstatic u8 read_pwm(struct mantis_pci *mantis)\n{\n\tstruct i2c_adapter *adapter = &mantis->adapter;\n\n\tu8 b = 0xff;\n\tu8 pwm;\n\tstruct i2c_msg msg[] = {\n\t\t{.addr = 0x50, .flags = 0, .buf = &b, .len = 1},\n\t\t{.addr = 0x50, .flags = I2C_M_RD, .buf = &pwm, .len = 1}\n\t};\n\n\tif ((i2c_transfer(adapter, msg, 2) != 2)\n\t    || (pwm == 0xff))\n\t\tpwm = 0x48;\n\n\treturn pwm;\n}\n\nstatic int vp2040_frontend_init(struct mantis_pci *mantis, struct dvb_frontend *fe)\n{\n\tstruct i2c_adapter *adapter = &mantis->adapter;\n\n\tint err = 0;\n\n\terr = mantis_frontend_power(mantis, POWER_ON);\n\tif (err == 0) {\n\t\tmantis_frontend_soft_reset(mantis);\n\t\tmsleep(250);\n\n\t\tdprintk(MANTIS_ERROR, 1, \"Probing for CU1216 (DVB-C)\");\n\t\tfe = dvb_attach(tda10021_attach, &vp2040_tda1002x_cu1216_config,\n\t\t\t\t     adapter,\n\t\t\t\t     read_pwm(mantis));\n\n\t\tif (fe) {\n\t\t\tdprintk(MANTIS_ERROR, 1,\n\t\t\t\t\"found Philips CU1216 DVB-C frontend (TDA10021) @ 0x%02x\",\n\t\t\t\tvp2040_tda1002x_cu1216_config.demod_address);\n\t\t} else {\n\t\t\tfe = dvb_attach(tda10023_attach, &vp2040_tda10023_cu1216_config,\n\t\t\t\t\t     adapter,\n\t\t\t\t\t     read_pwm(mantis));\n\n\t\t\tif (fe) {\n\t\t\t\tdprintk(MANTIS_ERROR, 1,\n\t\t\t\t\t\"found Philips CU1216 DVB-C frontend (TDA10023) @ 0x%02x\",\n\t\t\t\t\tvp2040_tda1002x_cu1216_config.demod_address);\n\t\t\t}\n\t\t}\n\n\t\tif (fe) {\n\t\t\tfe->ops.tuner_ops.set_params = tda1002x_cu1216_tuner_set;\n\t\t\tdprintk(MANTIS_ERROR, 1, \"Mantis DVB-C Philips CU1216 frontend attach success\");\n\t\t} else {\n\t\t\treturn -1;\n\t\t}\n\t} else {\n\t\tdprintk(MANTIS_ERROR, 1, \"Frontend on <%s> POWER ON failed! <%d>\",\n\t\t\tadapter->name,\n\t\t\terr);\n\n\t\treturn -EIO;\n\t}\n\tmantis->fe = fe;\n\tdprintk(MANTIS_DEBUG, 1, \"Done!\");\n\n\treturn 0;\n}\n\nstruct mantis_hwconfig vp2040_config = {\n\t.model_name\t= MANTIS_MODEL_NAME,\n\t.dev_type\t= MANTIS_DEV_TYPE,\n\t.ts_size\t= MANTIS_TS_204,\n\n\t.baud_rate\t= MANTIS_BAUD_9600,\n\t.parity\t\t= MANTIS_PARITY_NONE,\n\t.bytes\t\t= 0,\n\n\t.frontend_init\t= vp2040_frontend_init,\n\t.power\t\t= GPIF_A12,\n\t.reset\t\t= GPIF_A13,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}