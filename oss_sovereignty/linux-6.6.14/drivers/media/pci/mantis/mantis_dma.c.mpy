{
  "module_name": "mantis_dma.c",
  "hash_id": "690e375266290ace9337d8b8359e74389a90135baaca5c7b2b9b3dc5bbf835bc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/mantis/mantis_dma.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <asm/page.h>\n#include <linux/vmalloc.h>\n#include <linux/pci.h>\n\n#include <asm/irq.h>\n#include <linux/signal.h>\n#include <linux/sched.h>\n#include <linux/interrupt.h>\n\n#include <media/dmxdev.h>\n#include <media/dvbdev.h>\n#include <media/dvb_demux.h>\n#include <media/dvb_frontend.h>\n#include <media/dvb_net.h>\n\n#include \"mantis_common.h\"\n#include \"mantis_reg.h\"\n#include \"mantis_dma.h\"\n\n#define RISC_WRITE\t\t(0x01 << 28)\n#define RISC_JUMP\t\t(0x07 << 28)\n#define RISC_IRQ\t\t(0x01 << 24)\n\n#define RISC_STATUS(status)\t((((~status) & 0x0f) << 20) | ((status & 0x0f) << 16))\n#define RISC_FLUSH(risc_pos)\t\t(risc_pos = 0)\n#define RISC_INSTR(risc_pos, opcode)\t(mantis->risc_cpu[risc_pos++] = cpu_to_le32(opcode))\n\n#define MANTIS_BUF_SIZE\t\t(64 * 1024)\n#define MANTIS_BLOCK_BYTES      (MANTIS_BUF_SIZE / 4)\n#define MANTIS_DMA_TR_BYTES     (2 * 1024)  \n#define MANTIS_BLOCK_COUNT\t(MANTIS_BUF_SIZE / MANTIS_BLOCK_BYTES)\n\n#define MANTIS_DMA_TR_UNITS     (MANTIS_BLOCK_BYTES / MANTIS_DMA_TR_BYTES)\n \n#define MANTIS_RISC_SIZE\tPAGE_SIZE  \n\nint mantis_dma_exit(struct mantis_pci *mantis)\n{\n\tif (mantis->buf_cpu) {\n\t\tdprintk(MANTIS_ERROR, 1,\n\t\t\t\"DMA=0x%lx cpu=0x%p size=%d\",\n\t\t\t(unsigned long) mantis->buf_dma,\n\t\t\t mantis->buf_cpu,\n\t\t\t MANTIS_BUF_SIZE);\n\n\t\tdma_free_coherent(&mantis->pdev->dev, MANTIS_BUF_SIZE,\n\t\t\t\t  mantis->buf_cpu, mantis->buf_dma);\n\n\t\tmantis->buf_cpu = NULL;\n\t}\n\tif (mantis->risc_cpu) {\n\t\tdprintk(MANTIS_ERROR, 1,\n\t\t\t\"RISC=0x%lx cpu=0x%p size=%lx\",\n\t\t\t(unsigned long) mantis->risc_dma,\n\t\t\tmantis->risc_cpu,\n\t\t\tMANTIS_RISC_SIZE);\n\n\t\tdma_free_coherent(&mantis->pdev->dev, MANTIS_RISC_SIZE,\n\t\t\t\t  mantis->risc_cpu, mantis->risc_dma);\n\n\t\tmantis->risc_cpu = NULL;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mantis_dma_exit);\n\nstatic inline int mantis_alloc_buffers(struct mantis_pci *mantis)\n{\n\tif (!mantis->buf_cpu) {\n\t\tmantis->buf_cpu = dma_alloc_coherent(&mantis->pdev->dev,\n\t\t\t\t\t\t     MANTIS_BUF_SIZE,\n\t\t\t\t\t\t     &mantis->buf_dma, GFP_KERNEL);\n\t\tif (!mantis->buf_cpu) {\n\t\t\tdprintk(MANTIS_ERROR, 1,\n\t\t\t\t\"DMA buffer allocation failed\");\n\n\t\t\tgoto err;\n\t\t}\n\t\tdprintk(MANTIS_ERROR, 1,\n\t\t\t\"DMA=0x%lx cpu=0x%p size=%d\",\n\t\t\t(unsigned long) mantis->buf_dma,\n\t\t\tmantis->buf_cpu, MANTIS_BUF_SIZE);\n\t}\n\tif (!mantis->risc_cpu) {\n\t\tmantis->risc_cpu = dma_alloc_coherent(&mantis->pdev->dev,\n\t\t\t\t\t\t      MANTIS_RISC_SIZE,\n\t\t\t\t\t\t      &mantis->risc_dma, GFP_KERNEL);\n\n\t\tif (!mantis->risc_cpu) {\n\t\t\tdprintk(MANTIS_ERROR, 1,\n\t\t\t\t\"RISC program allocation failed\");\n\n\t\t\tmantis_dma_exit(mantis);\n\n\t\t\tgoto err;\n\t\t}\n\t\tdprintk(MANTIS_ERROR, 1,\n\t\t\t\"RISC=0x%lx cpu=0x%p size=%lx\",\n\t\t\t(unsigned long) mantis->risc_dma,\n\t\t\tmantis->risc_cpu, MANTIS_RISC_SIZE);\n\t}\n\n\treturn 0;\nerr:\n\tdprintk(MANTIS_ERROR, 1, \"Out of memory (?) .....\");\n\treturn -ENOMEM;\n}\n\nint mantis_dma_init(struct mantis_pci *mantis)\n{\n\tint err;\n\n\tdprintk(MANTIS_DEBUG, 1, \"Mantis DMA init\");\n\terr = mantis_alloc_buffers(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"Error allocating DMA buffer\");\n\n\t\t \n\t\tmmwrite(0, MANTIS_DMA_CTL);\n\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mantis_dma_init);\n\nstatic inline void mantis_risc_program(struct mantis_pci *mantis)\n{\n\tu32 buf_pos = 0;\n\tu32 line, step;\n\tu32 risc_pos;\n\n\tdprintk(MANTIS_DEBUG, 1, \"Mantis create RISC program\");\n\tRISC_FLUSH(risc_pos);\n\n\tdprintk(MANTIS_DEBUG, 1, \"risc len lines %u, bytes per line %u, bytes per DMA tr %u\",\n\t\tMANTIS_BLOCK_COUNT, MANTIS_BLOCK_BYTES, MANTIS_DMA_TR_BYTES);\n\n\tfor (line = 0; line < MANTIS_BLOCK_COUNT; line++) {\n\t\tfor (step = 0; step < MANTIS_DMA_TR_UNITS; step++) {\n\t\t\tdprintk(MANTIS_DEBUG, 1, \"RISC PROG line=[%d], step=[%d]\", line, step);\n\t\t\tif (step == 0) {\n\t\t\t\tRISC_INSTR(risc_pos, RISC_WRITE\t|\n\t\t\t\t\t   RISC_IRQ\t|\n\t\t\t\t\t   RISC_STATUS(line) |\n\t\t\t\t\t   MANTIS_DMA_TR_BYTES);\n\t\t\t} else {\n\t\t\t\tRISC_INSTR(risc_pos, RISC_WRITE | MANTIS_DMA_TR_BYTES);\n\t\t\t}\n\t\t\tRISC_INSTR(risc_pos, mantis->buf_dma + buf_pos);\n\t\t\tbuf_pos += MANTIS_DMA_TR_BYTES;\n\t\t  }\n\t}\n\tRISC_INSTR(risc_pos, RISC_JUMP);\n\tRISC_INSTR(risc_pos, mantis->risc_dma);\n}\n\nvoid mantis_dma_start(struct mantis_pci *mantis)\n{\n\tdprintk(MANTIS_DEBUG, 1, \"Mantis Start DMA engine\");\n\n\tmantis_risc_program(mantis);\n\tmmwrite(mantis->risc_dma, MANTIS_RISC_START);\n\tmmwrite(mmread(MANTIS_GPIF_ADDR) | MANTIS_GPIF_HIFRDWRN, MANTIS_GPIF_ADDR);\n\n\tmmwrite(0, MANTIS_DMA_CTL);\n\tmantis->last_block = mantis->busy_block = 0;\n\n\tmantis_unmask_ints(mantis, MANTIS_INT_RISCI);\n\n\tmmwrite(MANTIS_FIFO_EN | MANTIS_DCAP_EN\n\t\t\t       | MANTIS_RISC_EN, MANTIS_DMA_CTL);\n\n}\n\nvoid mantis_dma_stop(struct mantis_pci *mantis)\n{\n\tdprintk(MANTIS_DEBUG, 1, \"Mantis Stop DMA engine\");\n\n\tmmwrite((mmread(MANTIS_GPIF_ADDR) & (~(MANTIS_GPIF_HIFRDWRN))), MANTIS_GPIF_ADDR);\n\n\tmmwrite((mmread(MANTIS_DMA_CTL) & ~(MANTIS_FIFO_EN |\n\t\t\t\t\t    MANTIS_DCAP_EN |\n\t\t\t\t\t    MANTIS_RISC_EN)), MANTIS_DMA_CTL);\n\n\tmmwrite(mmread(MANTIS_INT_STAT), MANTIS_INT_STAT);\n\n\tmantis_mask_ints(mantis, MANTIS_INT_RISCI | MANTIS_INT_RISCEN);\n}\n\n\nvoid mantis_dma_xfer(struct tasklet_struct *t)\n{\n\tstruct mantis_pci *mantis = from_tasklet(mantis, t, tasklet);\n\tstruct mantis_hwconfig *config = mantis->hwconfig;\n\n\twhile (mantis->last_block != mantis->busy_block) {\n\t\tdprintk(MANTIS_DEBUG, 1, \"last block=[%d] finished block=[%d]\",\n\t\t\tmantis->last_block, mantis->busy_block);\n\n\t\t(config->ts_size ? dvb_dmx_swfilter_204 : dvb_dmx_swfilter)\n\t\t(&mantis->demux, &mantis->buf_cpu[mantis->last_block * MANTIS_BLOCK_BYTES], MANTIS_BLOCK_BYTES);\n\t\tmantis->last_block = (mantis->last_block + 1) % MANTIS_BLOCK_COUNT;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}