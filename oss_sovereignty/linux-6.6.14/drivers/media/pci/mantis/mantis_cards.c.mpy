{
  "module_name": "mantis_cards.c",
  "hash_id": "c974ef57019e0864736da3b52ac29267e85d2b8a025c30fa9390323fe57ff13b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/mantis/mantis_cards.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/pci.h>\n#include <linux/slab.h>\n#include <asm/irq.h>\n#include <linux/interrupt.h>\n#include <media/rc-map.h>\n\n#include <media/dmxdev.h>\n#include <media/dvbdev.h>\n#include <media/dvb_demux.h>\n#include <media/dvb_frontend.h>\n#include <media/dvb_net.h>\n\n#include \"mantis_common.h\"\n\n#include \"mantis_vp1033.h\"\n#include \"mantis_vp1034.h\"\n#include \"mantis_vp1041.h\"\n#include \"mantis_vp2033.h\"\n#include \"mantis_vp2040.h\"\n#include \"mantis_vp3030.h\"\n\n#include \"mantis_dma.h\"\n#include \"mantis_ca.h\"\n#include \"mantis_dvb.h\"\n#include \"mantis_uart.h\"\n#include \"mantis_ioc.h\"\n#include \"mantis_pci.h\"\n#include \"mantis_i2c.h\"\n#include \"mantis_reg.h\"\n#include \"mantis_input.h\"\n\nstatic unsigned int verbose;\nmodule_param(verbose, int, 0644);\nMODULE_PARM_DESC(verbose, \"verbose startup messages, default is 0 (no)\");\n\nstatic int devs;\n\n#define DRIVER_NAME\t\"Mantis\"\n\nstatic char *label[10] = {\n\t\"DMA\",\n\t\"IRQ-0\",\n\t\"IRQ-1\",\n\t\"OCERR\",\n\t\"PABRT\",\n\t\"RIPRR\",\n\t\"PPERR\",\n\t\"FTRGT\",\n\t\"RISCI\",\n\t\"RACK\"\n};\n\nstatic irqreturn_t mantis_irq_handler(int irq, void *dev_id)\n{\n\tu32 stat = 0, mask = 0;\n\tu32 rst_stat = 0, rst_mask = 0;\n\n\tstruct mantis_pci *mantis;\n\tstruct mantis_ca *ca;\n\n\tmantis = (struct mantis_pci *) dev_id;\n\tif (unlikely(!mantis))\n\t\treturn IRQ_NONE;\n\tca = mantis->mantis_ca;\n\n\tstat = mmread(MANTIS_INT_STAT);\n\tmask = mmread(MANTIS_INT_MASK);\n\tif (!(stat & mask))\n\t\treturn IRQ_NONE;\n\n\trst_mask  = MANTIS_GPIF_WRACK  |\n\t\t    MANTIS_GPIF_OTHERR |\n\t\t    MANTIS_SBUF_WSTO   |\n\t\t    MANTIS_GPIF_EXTIRQ;\n\n\trst_stat  = mmread(MANTIS_GPIF_STATUS);\n\trst_stat &= rst_mask;\n\tmmwrite(rst_stat, MANTIS_GPIF_STATUS);\n\n\tmantis->mantis_int_stat = stat;\n\tmantis->mantis_int_mask = mask;\n\tdprintk(MANTIS_DEBUG, 0, \"\\n-- Stat=<%02x> Mask=<%02x> --\", stat, mask);\n\tif (stat & MANTIS_INT_RISCEN) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[0]);\n\t}\n\tif (stat & MANTIS_INT_IRQ0) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[1]);\n\t\tmantis->gpif_status = rst_stat;\n\t\twake_up(&ca->hif_write_wq);\n\t\tschedule_work(&ca->hif_evm_work);\n\t}\n\tif (stat & MANTIS_INT_IRQ1) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[2]);\n\t\tspin_lock(&mantis->intmask_lock);\n\t\tmmwrite(mmread(MANTIS_INT_MASK) & ~MANTIS_INT_IRQ1,\n\t\t\tMANTIS_INT_MASK);\n\t\tspin_unlock(&mantis->intmask_lock);\n\t\tschedule_work(&mantis->uart_work);\n\t}\n\tif (stat & MANTIS_INT_OCERR) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[3]);\n\t}\n\tif (stat & MANTIS_INT_PABORT) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[4]);\n\t}\n\tif (stat & MANTIS_INT_RIPERR) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[5]);\n\t}\n\tif (stat & MANTIS_INT_PPERR) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[6]);\n\t}\n\tif (stat & MANTIS_INT_FTRGT) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[7]);\n\t}\n\tif (stat & MANTIS_INT_RISCI) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[8]);\n\t\tmantis->busy_block = (stat & MANTIS_INT_RISCSTAT) >> 28;\n\t\ttasklet_schedule(&mantis->tasklet);\n\t}\n\tif (stat & MANTIS_INT_I2CDONE) {\n\t\tdprintk(MANTIS_DEBUG, 0, \"<%s>\", label[9]);\n\t\twake_up(&mantis->i2c_wq);\n\t}\n\tmmwrite(stat, MANTIS_INT_STAT);\n\tstat &= ~(MANTIS_INT_RISCEN   | MANTIS_INT_I2CDONE |\n\t\t  MANTIS_INT_I2CRACK  | MANTIS_INT_PCMCIA7 |\n\t\t  MANTIS_INT_PCMCIA6  | MANTIS_INT_PCMCIA5 |\n\t\t  MANTIS_INT_PCMCIA4  | MANTIS_INT_PCMCIA3 |\n\t\t  MANTIS_INT_PCMCIA2  | MANTIS_INT_PCMCIA1 |\n\t\t  MANTIS_INT_PCMCIA0  | MANTIS_INT_IRQ1\t   |\n\t\t  MANTIS_INT_IRQ0     | MANTIS_INT_OCERR   |\n\t\t  MANTIS_INT_PABORT   | MANTIS_INT_RIPERR  |\n\t\t  MANTIS_INT_PPERR    | MANTIS_INT_FTRGT   |\n\t\t  MANTIS_INT_RISCI);\n\n\tif (stat)\n\t\tdprintk(MANTIS_DEBUG, 0, \"<Unknown> Stat=<%02x> Mask=<%02x>\", stat, mask);\n\n\tdprintk(MANTIS_DEBUG, 0, \"\\n\");\n\treturn IRQ_HANDLED;\n}\n\nstatic int mantis_pci_probe(struct pci_dev *pdev,\n\t\t\t    const struct pci_device_id *pci_id)\n{\n\tstruct mantis_pci_drvdata *drvdata;\n\tstruct mantis_pci *mantis;\n\tstruct mantis_hwconfig *config;\n\tint err;\n\n\tmantis = kzalloc(sizeof(*mantis), GFP_KERNEL);\n\tif (!mantis)\n\t\treturn -ENOMEM;\n\n\tdrvdata\t\t\t= (void *)pci_id->driver_data;\n\tmantis->num\t\t= devs;\n\tmantis->verbose\t\t= verbose;\n\tmantis->pdev\t\t= pdev;\n\tconfig\t\t\t= drvdata->hwconfig;\n\tconfig->irq_handler\t= &mantis_irq_handler;\n\tmantis->hwconfig\t= config;\n\tmantis->rc_map_name\t= drvdata->rc_map_name;\n\n\tspin_lock_init(&mantis->intmask_lock);\n\n\terr = mantis_pci_init(mantis);\n\tif (err) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis PCI initialization failed <%d>\", err);\n\t\tgoto err_free_mantis;\n\t}\n\n\terr = mantis_stream_control(mantis, STREAM_TO_HIF);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis stream control failed <%d>\", err);\n\t\tgoto err_pci_exit;\n\t}\n\n\terr = mantis_i2c_init(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis I2C initialization failed <%d>\", err);\n\t\tgoto err_pci_exit;\n\t}\n\n\terr = mantis_get_mac(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis MAC address read failed <%d>\", err);\n\t\tgoto err_i2c_exit;\n\t}\n\n\terr = mantis_dma_init(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis DMA initialization failed <%d>\", err);\n\t\tgoto err_i2c_exit;\n\t}\n\n\terr = mantis_dvb_init(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis DVB initialization failed <%d>\", err);\n\t\tgoto err_dma_exit;\n\t}\n\n\terr = mantis_input_init(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1,\n\t\t\t\"ERROR: Mantis DVB initialization failed <%d>\", err);\n\t\tgoto err_dvb_exit;\n\t}\n\n\terr = mantis_uart_init(mantis);\n\tif (err < 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"ERROR: Mantis UART initialization failed <%d>\", err);\n\t\tgoto err_input_exit;\n\t}\n\n\tdevs++;\n\n\treturn 0;\n\nerr_input_exit:\n\tmantis_input_exit(mantis);\n\nerr_dvb_exit:\n\tmantis_dvb_exit(mantis);\n\nerr_dma_exit:\n\tmantis_dma_exit(mantis);\n\nerr_i2c_exit:\n\tmantis_i2c_exit(mantis);\n\nerr_pci_exit:\n\tmantis_pci_exit(mantis);\n\nerr_free_mantis:\n\tkfree(mantis);\n\n\treturn err;\n}\n\nstatic void mantis_pci_remove(struct pci_dev *pdev)\n{\n\tstruct mantis_pci *mantis = pci_get_drvdata(pdev);\n\n\tif (mantis) {\n\n\t\tmantis_uart_exit(mantis);\n\t\tmantis_input_exit(mantis);\n\t\tmantis_dvb_exit(mantis);\n\t\tmantis_dma_exit(mantis);\n\t\tmantis_i2c_exit(mantis);\n\t\tmantis_pci_exit(mantis);\n\t\tkfree(mantis);\n\t}\n\treturn;\n}\n\nstatic const struct pci_device_id mantis_pci_table[] = {\n\tMAKE_ENTRY(TECHNISAT, CABLESTAR_HD2, &vp2040_config,\n\t\t   RC_MAP_TECHNISAT_TS35),\n\tMAKE_ENTRY(TECHNISAT, SKYSTAR_HD2_10, &vp1041_config,\n\t\t   NULL),\n\tMAKE_ENTRY(TECHNISAT, SKYSTAR_HD2_20, &vp1041_config,\n\t\t   NULL),\n\tMAKE_ENTRY(TERRATEC, CINERGY_C, &vp2040_config,\n\t\t   RC_MAP_TERRATEC_CINERGY_C_PCI),\n\tMAKE_ENTRY(TERRATEC, CINERGY_S2_PCI_HD, &vp1041_config,\n\t\t   RC_MAP_TERRATEC_CINERGY_S2_HD),\n\tMAKE_ENTRY(TWINHAN_TECHNOLOGIES, MANTIS_VP_1033_DVB_S, &vp1033_config,\n\t\t   NULL),\n\tMAKE_ENTRY(TWINHAN_TECHNOLOGIES, MANTIS_VP_1034_DVB_S, &vp1034_config,\n\t\t   NULL),\n\tMAKE_ENTRY(TWINHAN_TECHNOLOGIES, MANTIS_VP_1041_DVB_S2, &vp1041_config,\n\t\t   RC_MAP_TWINHAN_DTV_CAB_CI),\n\tMAKE_ENTRY(TWINHAN_TECHNOLOGIES, MANTIS_VP_2033_DVB_C, &vp2033_config,\n\t\t   RC_MAP_TWINHAN_DTV_CAB_CI),\n\tMAKE_ENTRY(TWINHAN_TECHNOLOGIES, MANTIS_VP_2040_DVB_C, &vp2040_config,\n\t\t   NULL),\n\tMAKE_ENTRY(TWINHAN_TECHNOLOGIES, MANTIS_VP_3030_DVB_T, &vp3030_config,\n\t\t   NULL),\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(pci, mantis_pci_table);\n\nstatic struct pci_driver mantis_pci_driver = {\n\t.name\t\t= DRIVER_NAME,\n\t.id_table\t= mantis_pci_table,\n\t.probe\t\t= mantis_pci_probe,\n\t.remove\t\t= mantis_pci_remove,\n};\n\nmodule_pci_driver(mantis_pci_driver);\n\nMODULE_DESCRIPTION(\"MANTIS driver\");\nMODULE_AUTHOR(\"Manu Abraham\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}