{
  "module_name": "mantis_hif.c",
  "hash_id": "716087d3363cd881cdd35377f43f29bda92d682d8dc0130de6a6749b8f194a9b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/mantis/mantis_hif.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/signal.h>\n#include <linux/sched.h>\n\n#include <linux/interrupt.h>\n#include <asm/io.h>\n\n#include <media/dmxdev.h>\n#include <media/dvbdev.h>\n#include <media/dvb_demux.h>\n#include <media/dvb_frontend.h>\n#include <media/dvb_net.h>\n\n#include \"mantis_common.h\"\n\n#include \"mantis_hif.h\"\n#include \"mantis_link.h\"  \n\n#include \"mantis_reg.h\"\n\n\nstatic int mantis_hif_sbuf_opdone_wait(struct mantis_ca *ca)\n{\n\tstruct mantis_pci *mantis = ca->ca_priv;\n\tint rc = 0;\n\n\tif (wait_event_timeout(ca->hif_opdone_wq,\n\t\t\t       ca->hif_event & MANTIS_SBUF_OPDONE,\n\t\t\t       msecs_to_jiffies(500)) == -ERESTARTSYS) {\n\n\t\tdprintk(MANTIS_ERROR, 1, \"Adapter(%d) Slot(0): Smart buffer operation timeout !\", mantis->num);\n\t\trc = -EREMOTEIO;\n\t}\n\tdprintk(MANTIS_DEBUG, 1, \"Smart Buffer Operation complete\");\n\tca->hif_event &= ~MANTIS_SBUF_OPDONE;\n\treturn rc;\n}\n\nstatic int mantis_hif_write_wait(struct mantis_ca *ca)\n{\n\tstruct mantis_pci *mantis = ca->ca_priv;\n\tu32 opdone = 0, timeout = 0;\n\tint rc = 0;\n\n\tif (wait_event_timeout(ca->hif_write_wq,\n\t\t\t       mantis->gpif_status & MANTIS_GPIF_WRACK,\n\t\t\t       msecs_to_jiffies(500)) == -ERESTARTSYS) {\n\n\t\tdprintk(MANTIS_ERROR, 1, \"Adapter(%d) Slot(0): Write ACK timed out !\", mantis->num);\n\t\trc = -EREMOTEIO;\n\t}\n\tdprintk(MANTIS_DEBUG, 1, \"Write Acknowledged\");\n\tmantis->gpif_status &= ~MANTIS_GPIF_WRACK;\n\twhile (!opdone) {\n\t\topdone = (mmread(MANTIS_GPIF_STATUS) & MANTIS_SBUF_OPDONE);\n\t\tudelay(500);\n\t\ttimeout++;\n\t\tif (timeout > 100) {\n\t\t\tdprintk(MANTIS_ERROR, 1, \"Adapter(%d) Slot(0): Write operation timed out!\", mantis->num);\n\t\t\trc = -ETIMEDOUT;\n\t\t\tbreak;\n\t\t}\n\t}\n\tdprintk(MANTIS_DEBUG, 1, \"HIF Write success\");\n\treturn rc;\n}\n\n\nint mantis_hif_read_mem(struct mantis_ca *ca, u32 addr)\n{\n\tstruct mantis_pci *mantis = ca->ca_priv;\n\tu32 hif_addr = 0, data, count = 4;\n\n\tdprintk(MANTIS_DEBUG, 1, \"Adapter(%d) Slot(0): Request HIF Mem Read\", mantis->num);\n\tmutex_lock(&ca->ca_lock);\n\thif_addr &= ~MANTIS_GPIF_PCMCIAREG;\n\thif_addr &= ~MANTIS_GPIF_PCMCIAIOM;\n\thif_addr |=  MANTIS_HIF_STATUS;\n\thif_addr |=  addr;\n\n\tmmwrite(hif_addr, MANTIS_GPIF_BRADDR);\n\tmmwrite(count, MANTIS_GPIF_BRBYTES);\n\tudelay(20);\n\tmmwrite(hif_addr | MANTIS_GPIF_HIFRDWRN, MANTIS_GPIF_ADDR);\n\n\tif (mantis_hif_sbuf_opdone_wait(ca) != 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"Adapter(%d) Slot(0): GPIF Smart Buffer operation failed\", mantis->num);\n\t\tmutex_unlock(&ca->ca_lock);\n\t\treturn -EREMOTEIO;\n\t}\n\tdata = mmread(MANTIS_GPIF_DIN);\n\tmutex_unlock(&ca->ca_lock);\n\tdprintk(MANTIS_DEBUG, 1, \"Mem Read: 0x%02x\", data);\n\treturn (data >> 24) & 0xff;\n}\n\nint mantis_hif_write_mem(struct mantis_ca *ca, u32 addr, u8 data)\n{\n\tstruct mantis_slot *slot = ca->slot;\n\tstruct mantis_pci *mantis = ca->ca_priv;\n\tu32 hif_addr = 0;\n\n\tdprintk(MANTIS_DEBUG, 1, \"Adapter(%d) Slot(0): Request HIF Mem Write\", mantis->num);\n\tmutex_lock(&ca->ca_lock);\n\thif_addr &= ~MANTIS_GPIF_HIFRDWRN;\n\thif_addr &= ~MANTIS_GPIF_PCMCIAREG;\n\thif_addr &= ~MANTIS_GPIF_PCMCIAIOM;\n\thif_addr |=  MANTIS_HIF_STATUS;\n\thif_addr |=  addr;\n\n\tmmwrite(slot->slave_cfg, MANTIS_GPIF_CFGSLA);  \n\tmmwrite(hif_addr, MANTIS_GPIF_ADDR);\n\tmmwrite(data, MANTIS_GPIF_DOUT);\n\n\tif (mantis_hif_write_wait(ca) != 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"Adapter(%d) Slot(0): HIF Smart Buffer operation failed\", mantis->num);\n\t\tmutex_unlock(&ca->ca_lock);\n\t\treturn -EREMOTEIO;\n\t}\n\tdprintk(MANTIS_DEBUG, 1, \"Mem Write: (0x%02x to 0x%02x)\", data, addr);\n\tmutex_unlock(&ca->ca_lock);\n\n\treturn 0;\n}\n\nint mantis_hif_read_iom(struct mantis_ca *ca, u32 addr)\n{\n\tstruct mantis_pci *mantis = ca->ca_priv;\n\tu32 data, hif_addr = 0;\n\n\tdprintk(MANTIS_DEBUG, 1, \"Adapter(%d) Slot(0): Request HIF I/O Read\", mantis->num);\n\tmutex_lock(&ca->ca_lock);\n\thif_addr &= ~MANTIS_GPIF_PCMCIAREG;\n\thif_addr |=  MANTIS_GPIF_PCMCIAIOM;\n\thif_addr |=  MANTIS_HIF_STATUS;\n\thif_addr |=  addr;\n\n\tmmwrite(hif_addr, MANTIS_GPIF_BRADDR);\n\tmmwrite(1, MANTIS_GPIF_BRBYTES);\n\tudelay(20);\n\tmmwrite(hif_addr | MANTIS_GPIF_HIFRDWRN, MANTIS_GPIF_ADDR);\n\n\tif (mantis_hif_sbuf_opdone_wait(ca) != 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"Adapter(%d) Slot(0): HIF Smart Buffer operation failed\", mantis->num);\n\t\tmutex_unlock(&ca->ca_lock);\n\t\treturn -EREMOTEIO;\n\t}\n\tdata = mmread(MANTIS_GPIF_DIN);\n\tdprintk(MANTIS_DEBUG, 1, \"I/O Read: 0x%02x\", data);\n\tudelay(50);\n\tmutex_unlock(&ca->ca_lock);\n\n\treturn (u8) data;\n}\n\nint mantis_hif_write_iom(struct mantis_ca *ca, u32 addr, u8 data)\n{\n\tstruct mantis_pci *mantis = ca->ca_priv;\n\tu32 hif_addr = 0;\n\n\tdprintk(MANTIS_DEBUG, 1, \"Adapter(%d) Slot(0): Request HIF I/O Write\", mantis->num);\n\tmutex_lock(&ca->ca_lock);\n\thif_addr &= ~MANTIS_GPIF_PCMCIAREG;\n\thif_addr &= ~MANTIS_GPIF_HIFRDWRN;\n\thif_addr |=  MANTIS_GPIF_PCMCIAIOM;\n\thif_addr |=  MANTIS_HIF_STATUS;\n\thif_addr |=  addr;\n\n\tmmwrite(hif_addr, MANTIS_GPIF_ADDR);\n\tmmwrite(data, MANTIS_GPIF_DOUT);\n\n\tif (mantis_hif_write_wait(ca) != 0) {\n\t\tdprintk(MANTIS_ERROR, 1, \"Adapter(%d) Slot(0): HIF Smart Buffer operation failed\", mantis->num);\n\t\tmutex_unlock(&ca->ca_lock);\n\t\treturn -EREMOTEIO;\n\t}\n\tdprintk(MANTIS_DEBUG, 1, \"I/O Write: (0x%02x to 0x%02x)\", data, addr);\n\tmutex_unlock(&ca->ca_lock);\n\tudelay(50);\n\n\treturn 0;\n}\n\nint mantis_hif_init(struct mantis_ca *ca)\n{\n\tstruct mantis_slot *slot = ca->slot;\n\tstruct mantis_pci *mantis = ca->ca_priv;\n\tu32 irqcfg;\n\n\tslot[0].slave_cfg = 0x70773028;\n\tdprintk(MANTIS_ERROR, 1, \"Adapter(%d) Initializing Mantis Host Interface\", mantis->num);\n\n\tmutex_lock(&ca->ca_lock);\n\tirqcfg = mmread(MANTIS_GPIF_IRQCFG);\n\tirqcfg = MANTIS_MASK_BRRDY\t|\n\t\t MANTIS_MASK_WRACK\t|\n\t\t MANTIS_MASK_EXTIRQ\t|\n\t\t MANTIS_MASK_WSTO\t|\n\t\t MANTIS_MASK_OTHERR\t|\n\t\t MANTIS_MASK_OVFLW;\n\n\tmmwrite(irqcfg, MANTIS_GPIF_IRQCFG);\n\tmutex_unlock(&ca->ca_lock);\n\n\treturn 0;\n}\n\nvoid mantis_hif_exit(struct mantis_ca *ca)\n{\n\tstruct mantis_pci *mantis = ca->ca_priv;\n\tu32 irqcfg;\n\n\tdprintk(MANTIS_ERROR, 1, \"Adapter(%d) Exiting Mantis Host Interface\", mantis->num);\n\tmutex_lock(&ca->ca_lock);\n\tirqcfg = mmread(MANTIS_GPIF_IRQCFG);\n\tirqcfg &= ~MANTIS_MASK_BRRDY;\n\tmmwrite(irqcfg, MANTIS_GPIF_IRQCFG);\n\tmutex_unlock(&ca->ca_lock);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}