{
  "module_name": "saa7164-api.c",
  "hash_id": "242c5041197ce17aa05134b58612a435ec90cb17d77e858a445800cc0c3f8026",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/saa7164/saa7164-api.c",
  "human_readable_source": "\n \n\n#include <linux/wait.h>\n#include <linux/slab.h>\n\n#include \"saa7164.h\"\n\nint saa7164_api_get_load_info(struct saa7164_dev *dev, struct tmFwInfoStruct *i)\n{\n\tint ret;\n\n\tif (!(saa_debug & DBGLVL_CPU))\n\t\treturn 0;\n\n\tdprintk(DBGLVL_API, \"%s()\\n\", __func__);\n\n\ti->deviceinst = 0;\n\ti->devicespec = 0;\n\ti->mode = 0;\n\ti->status = 0;\n\n\tret = saa7164_cmd_send(dev, 0, GET_CUR,\n\t\tGET_FW_STATUS_CONTROL, sizeof(struct tmFwInfoStruct), i);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tprintk(KERN_INFO \"saa7164[%d]-CPU: %d percent\", dev->nr, i->CPULoad);\n\n\treturn ret;\n}\n\nint saa7164_api_collect_debug(struct saa7164_dev *dev)\n{\n\tstruct tmComResDebugGetData d;\n\tu8 more = 255;\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s()\\n\", __func__);\n\n\twhile (more--) {\n\n\t\tmemset(&d, 0, sizeof(d));\n\n\t\tret = saa7164_cmd_send(dev, 0, GET_CUR,\n\t\t\tGET_DEBUG_DATA_CONTROL, sizeof(d), &d);\n\t\tif (ret != SAA_OK)\n\t\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\",\n\t\t\t\t__func__, ret);\n\n\t\tif (d.dwResult != SAA_OK)\n\t\t\tbreak;\n\n\t\tprintk(KERN_INFO \"saa7164[%d]-FWMSG: %s\", dev->nr,\n\t\t\td.ucDebugData);\n\t}\n\n\treturn 0;\n}\n\nint saa7164_api_set_debug(struct saa7164_dev *dev, u8 level)\n{\n\tstruct tmComResDebugSetLevel lvl;\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s(level=%d)\\n\", __func__, level);\n\n\t \n\tret = saa7164_cmd_send(dev, 0, GET_CUR,\n\t\tSET_DEBUG_LEVEL_CONTROL, sizeof(lvl), &lvl);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tdprintk(DBGLVL_API, \"%s() Was %d\\n\", __func__, lvl.dwDebugLevel);\n\n\tlvl.dwDebugLevel = level;\n\n\t \n\tret = saa7164_cmd_send(dev, 0, SET_CUR,\n\t\tSET_DEBUG_LEVEL_CONTROL, sizeof(lvl), &lvl);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\treturn ret;\n}\n\nint saa7164_api_set_vbi_format(struct saa7164_port *port)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tstruct tmComResProbeCommit fmt, rsp;\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s(nr=%d, unitid=0x%x)\\n\", __func__,\n\t\tport->nr, port->hwcfg.unitid);\n\n\tfmt.bmHint = 0;\n\tfmt.bFormatIndex = 1;\n\tfmt.bFrameIndex = 1;\n\n\t \n\tret = saa7164_cmd_send(port->dev, port->hwcfg.unitid,\n\t\tSET_CUR, SAA_PROBE_CONTROL, sizeof(fmt), &fmt);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() set error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tret = saa7164_cmd_send(port->dev, port->hwcfg.unitid,\n\t\tGET_CUR, SAA_PROBE_CONTROL, sizeof(rsp), &rsp);\n\tif (ret != SAA_OK) {\n\t\tprintk(KERN_ERR \"%s() get error, ret = 0x%x\\n\", __func__, ret);\n\t} else {\n\t\t \n\t\tif (memcmp(&fmt, &rsp, sizeof(rsp)) == 0) {\n\t\t\tdprintk(DBGLVL_API, \"SET/PROBE Verified\\n\");\n\n\t\t\t \n\t\t\tret = saa7164_cmd_send(port->dev, port->hwcfg.unitid,\n\t\t\t\tSET_CUR, SAA_COMMIT_CONTROL, sizeof(fmt), &fmt);\n\t\t\tif (ret != SAA_OK)\n\t\t\t\tprintk(KERN_ERR \"%s() commit error, ret = 0x%x\\n\",\n\t\t\t\t\t__func__, ret);\n\n\t\t\tret = saa7164_cmd_send(port->dev, port->hwcfg.unitid,\n\t\t\t\tGET_CUR, SAA_COMMIT_CONTROL, sizeof(rsp), &rsp);\n\t\t\tif (ret != SAA_OK)\n\t\t\t\tprintk(KERN_ERR \"%s() GET commit error, ret = 0x%x\\n\",\n\t\t\t\t\t__func__, ret);\n\n\t\t\tif (memcmp(&fmt, &rsp, sizeof(rsp)) != 0) {\n\t\t\t\tprintk(KERN_ERR \"%s() memcmp error, ret = 0x%x\\n\",\n\t\t\t\t\t__func__, ret);\n\t\t\t} else\n\t\t\t\tdprintk(DBGLVL_API, \"SET/COMMIT Verified\\n\");\n\n\t\t\tdprintk(DBGLVL_API, \"rsp.bmHint = 0x%x\\n\", rsp.bmHint);\n\t\t\tdprintk(DBGLVL_API, \"rsp.bFormatIndex = 0x%x\\n\",\n\t\t\t\trsp.bFormatIndex);\n\t\t\tdprintk(DBGLVL_API, \"rsp.bFrameIndex = 0x%x\\n\",\n\t\t\t\trsp.bFrameIndex);\n\t\t} else\n\t\t\tprintk(KERN_ERR \"%s() compare failed\\n\", __func__);\n\t}\n\n\tif (ret == SAA_OK)\n\t\tdprintk(DBGLVL_API, \"%s(nr=%d) Success\\n\", __func__, port->nr);\n\n\treturn ret;\n}\n\nstatic int saa7164_api_set_gop_size(struct saa7164_port *port)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tstruct tmComResEncVideoGopStructure gs;\n\tint ret;\n\n\tdprintk(DBGLVL_ENC, \"%s()\\n\", __func__);\n\n\tgs.ucRefFrameDist = port->encoder_params.refdist;\n\tgs.ucGOPSize = port->encoder_params.gop_size;\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, SET_CUR,\n\t\tEU_VIDEO_GOP_STRUCTURE_CONTROL,\n\t\tsizeof(gs), &gs);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\treturn ret;\n}\n\nint saa7164_api_set_encoder(struct saa7164_port *port)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tstruct tmComResEncVideoBitRate vb;\n\tstruct tmComResEncAudioBitRate ab;\n\tint ret;\n\n\tdprintk(DBGLVL_ENC, \"%s() unitid=0x%x\\n\", __func__,\n\t\tport->hwcfg.sourceid);\n\n\tif (port->encoder_params.stream_type == V4L2_MPEG_STREAM_TYPE_MPEG2_PS)\n\t\tport->encoder_profile = EU_PROFILE_PS_DVD;\n\telse\n\t\tport->encoder_profile = EU_PROFILE_TS_HQ;\n\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, SET_CUR,\n\t\tEU_PROFILE_CONTROL, sizeof(u8), &port->encoder_profile);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, SET_CUR,\n\t\tEU_PROFILE_CONTROL, sizeof(u8), &port->encoder_profile);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tif (port->encoder_params.bitrate_mode ==\n\t\tV4L2_MPEG_VIDEO_BITRATE_MODE_CBR)\n\t\tvb.ucVideoBitRateMode = EU_VIDEO_BIT_RATE_MODE_CONSTANT;\n\telse\n\t\tvb.ucVideoBitRateMode = EU_VIDEO_BIT_RATE_MODE_VARIABLE_PEAK;\n\tvb.dwVideoBitRate = port->encoder_params.bitrate;\n\tvb.dwVideoBitRatePeak = port->encoder_params.bitrate_peak;\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, SET_CUR,\n\t\tEU_VIDEO_BIT_RATE_CONTROL,\n\t\tsizeof(struct tmComResEncVideoBitRate),\n\t\t&vb);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tab.ucAudioBitRateMode = 0;\n\tab.dwAudioBitRate = 384000;\n\tab.dwAudioBitRatePeak = ab.dwAudioBitRate;\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, SET_CUR,\n\t\tEU_AUDIO_BIT_RATE_CONTROL,\n\t\tsizeof(struct tmComResEncAudioBitRate),\n\t\t&ab);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__,\n\t\t\tret);\n\n\tsaa7164_api_set_aspect_ratio(port);\n\tsaa7164_api_set_gop_size(port);\n\n\treturn ret;\n}\n\nint saa7164_api_get_encoder(struct saa7164_port *port)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tstruct tmComResEncVideoBitRate v;\n\tstruct tmComResEncAudioBitRate a;\n\tstruct tmComResEncVideoInputAspectRatio ar;\n\tint ret;\n\n\tdprintk(DBGLVL_ENC, \"%s() unitid=0x%x\\n\", __func__,\n\t\tport->hwcfg.sourceid);\n\n\tport->encoder_profile = 0;\n\tport->video_format = 0;\n\tport->video_resolution = 0;\n\tport->audio_format = 0;\n\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, GET_CUR,\n\t\tEU_PROFILE_CONTROL, sizeof(u8), &port->encoder_profile);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, GET_CUR,\n\t\tEU_VIDEO_RESOLUTION_CONTROL, sizeof(u8),\n\t\t&port->video_resolution);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, GET_CUR,\n\t\tEU_VIDEO_FORMAT_CONTROL, sizeof(u8), &port->video_format);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, GET_CUR,\n\t\tEU_VIDEO_BIT_RATE_CONTROL, sizeof(v), &v);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, GET_CUR,\n\t\tEU_AUDIO_FORMAT_CONTROL, sizeof(u8), &port->audio_format);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, GET_CUR,\n\t\tEU_AUDIO_BIT_RATE_CONTROL, sizeof(a), &a);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tar.width = 0;\n\tar.height = 0;\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, GET_CUR,\n\t\tEU_VIDEO_INPUT_ASPECT_CONTROL,\n\t\tsizeof(struct tmComResEncVideoInputAspectRatio), &ar);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tdprintk(DBGLVL_ENC, \"encoder_profile = %d\\n\", port->encoder_profile);\n\tdprintk(DBGLVL_ENC, \"video_format    = %d\\n\", port->video_format);\n\tdprintk(DBGLVL_ENC, \"audio_format    = %d\\n\", port->audio_format);\n\tdprintk(DBGLVL_ENC, \"video_resolution= %d\\n\", port->video_resolution);\n\tdprintk(DBGLVL_ENC, \"v.ucVideoBitRateMode = %d\\n\",\n\t\tv.ucVideoBitRateMode);\n\tdprintk(DBGLVL_ENC, \"v.dwVideoBitRate     = %d\\n\",\n\t\tv.dwVideoBitRate);\n\tdprintk(DBGLVL_ENC, \"v.dwVideoBitRatePeak = %d\\n\",\n\t\tv.dwVideoBitRatePeak);\n\tdprintk(DBGLVL_ENC, \"a.ucVideoBitRateMode = %d\\n\",\n\t\ta.ucAudioBitRateMode);\n\tdprintk(DBGLVL_ENC, \"a.dwVideoBitRate     = %d\\n\",\n\t\ta.dwAudioBitRate);\n\tdprintk(DBGLVL_ENC, \"a.dwVideoBitRatePeak = %d\\n\",\n\t\ta.dwAudioBitRatePeak);\n\tdprintk(DBGLVL_ENC, \"aspect.width / height = %d:%d\\n\",\n\t\tar.width, ar.height);\n\n\treturn ret;\n}\n\nint saa7164_api_set_aspect_ratio(struct saa7164_port *port)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tstruct tmComResEncVideoInputAspectRatio ar;\n\tint ret;\n\n\tdprintk(DBGLVL_ENC, \"%s(%d)\\n\", __func__,\n\t\tport->encoder_params.ctl_aspect);\n\n\tswitch (port->encoder_params.ctl_aspect) {\n\tcase V4L2_MPEG_VIDEO_ASPECT_1x1:\n\t\tar.width = 1;\n\t\tar.height = 1;\n\t\tbreak;\n\tcase V4L2_MPEG_VIDEO_ASPECT_4x3:\n\t\tar.width = 4;\n\t\tar.height = 3;\n\t\tbreak;\n\tcase V4L2_MPEG_VIDEO_ASPECT_16x9:\n\t\tar.width = 16;\n\t\tar.height = 9;\n\t\tbreak;\n\tcase V4L2_MPEG_VIDEO_ASPECT_221x100:\n\t\tar.width = 221;\n\t\tar.height = 100;\n\t\tbreak;\n\tdefault:\n\t\tBUG();\n\t}\n\n\tdprintk(DBGLVL_ENC, \"%s(%d) now %d:%d\\n\", __func__,\n\t\tport->encoder_params.ctl_aspect,\n\t\tar.width, ar.height);\n\n\t \n\tret = saa7164_cmd_send(port->dev, port->hwcfg.sourceid, SET_CUR,\n\t\tEU_VIDEO_INPUT_ASPECT_CONTROL,\n\t\tsizeof(struct tmComResEncVideoInputAspectRatio), &ar);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\treturn ret;\n}\n\nint saa7164_api_set_usercontrol(struct saa7164_port *port, u8 ctl)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tint ret;\n\tu16 val;\n\n\tif (ctl == PU_BRIGHTNESS_CONTROL)\n\t\tval = port->ctl_brightness;\n\telse\n\tif (ctl == PU_CONTRAST_CONTROL)\n\t\tval = port->ctl_contrast;\n\telse\n\tif (ctl == PU_HUE_CONTROL)\n\t\tval = port->ctl_hue;\n\telse\n\tif (ctl == PU_SATURATION_CONTROL)\n\t\tval = port->ctl_saturation;\n\telse\n\tif (ctl == PU_SHARPNESS_CONTROL)\n\t\tval = port->ctl_sharpness;\n\telse\n\t\treturn -EINVAL;\n\n\tdprintk(DBGLVL_ENC, \"%s() unitid=0x%x ctl=%d, val=%d\\n\",\n\t\t__func__, port->encunit.vsourceid, ctl, val);\n\n\tret = saa7164_cmd_send(port->dev, port->encunit.vsourceid, SET_CUR,\n\t\tctl, sizeof(u16), &val);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\treturn ret;\n}\n\nint saa7164_api_get_usercontrol(struct saa7164_port *port, u8 ctl)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tint ret;\n\tu16 val;\n\n\tret = saa7164_cmd_send(port->dev, port->encunit.vsourceid, GET_CUR,\n\t\tctl, sizeof(u16), &val);\n\tif (ret != SAA_OK) {\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\t\treturn ret;\n\t}\n\n\tdprintk(DBGLVL_ENC, \"%s() ctl=%d, val=%d\\n\",\n\t\t__func__, ctl, val);\n\n\tif (ctl == PU_BRIGHTNESS_CONTROL)\n\t\tport->ctl_brightness = val;\n\telse\n\tif (ctl == PU_CONTRAST_CONTROL)\n\t\tport->ctl_contrast = val;\n\telse\n\tif (ctl == PU_HUE_CONTROL)\n\t\tport->ctl_hue = val;\n\telse\n\tif (ctl == PU_SATURATION_CONTROL)\n\t\tport->ctl_saturation = val;\n\telse\n\tif (ctl == PU_SHARPNESS_CONTROL)\n\t\tport->ctl_sharpness = val;\n\n\treturn ret;\n}\n\nint saa7164_api_set_videomux(struct saa7164_port *port)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tu8 inputs[] = { 1, 2, 2, 2, 5, 5, 5 };\n\tint ret;\n\n\tdprintk(DBGLVL_ENC, \"%s() v_mux=%d a_mux=%d\\n\",\n\t\t__func__, port->mux_input, inputs[port->mux_input - 1]);\n\n\t \n\tret = saa7164_api_audio_mute(port, 1);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tret = saa7164_cmd_send(port->dev, port->vidproc.sourceid, SET_CUR,\n\t\tSU_INPUT_SELECT_CONTROL, sizeof(u8), &port->mux_input);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tret = saa7164_cmd_send(port->dev, port->audfeat.sourceid, SET_CUR,\n\t\tSU_INPUT_SELECT_CONTROL, sizeof(u8),\n\t\t&inputs[port->mux_input - 1]);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tret = saa7164_api_audio_mute(port, 0);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\treturn ret;\n}\n\nint saa7164_api_audio_mute(struct saa7164_port *port, int mute)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tu8 v = mute;\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s(%d)\\n\", __func__, mute);\n\n\tret = saa7164_cmd_send(port->dev, port->audfeat.unitid, SET_CUR,\n\t\tMUTE_CONTROL, sizeof(u8), &v);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\treturn ret;\n}\n\n \nint saa7164_api_set_audio_volume(struct saa7164_port *port, s8 level)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\ts16 v, min, max;\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s(%d)\\n\", __func__, level);\n\n\t \n\tret = saa7164_cmd_send(port->dev, port->audfeat.unitid, GET_MIN,\n\t\tVOLUME_CONTROL, sizeof(u16), &min);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tret = saa7164_cmd_send(port->dev, port->audfeat.unitid, GET_MAX,\n\t\tVOLUME_CONTROL, sizeof(u16), &max);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tret = saa7164_cmd_send(port->dev, port->audfeat.unitid, GET_CUR,\n\t\t(0x01 << 8) | VOLUME_CONTROL, sizeof(u16), &v);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tdprintk(DBGLVL_API, \"%s(%d) min=%d max=%d cur=%d\\n\", __func__,\n\t\tlevel, min, max, v);\n\n\tv = level;\n\tif (v < min)\n\t\tv = min;\n\tif (v > max)\n\t\tv = max;\n\n\t \n\tret = saa7164_cmd_send(port->dev, port->audfeat.unitid, SET_CUR,\n\t\t(0x01 << 8) | VOLUME_CONTROL, sizeof(s16), &v);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tret = saa7164_cmd_send(port->dev, port->audfeat.unitid, SET_CUR,\n\t\t(0x02 << 8) | VOLUME_CONTROL, sizeof(s16), &v);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tret = saa7164_cmd_send(port->dev, port->audfeat.unitid, GET_CUR,\n\t\t(0x01 << 8) | VOLUME_CONTROL, sizeof(u16), &v);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tdprintk(DBGLVL_API, \"%s(%d) min=%d max=%d cur=%d\\n\", __func__,\n\t\tlevel, min, max, v);\n\n\treturn ret;\n}\n\nint saa7164_api_set_audio_std(struct saa7164_port *port)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tstruct tmComResAudioDefaults lvl;\n\tstruct tmComResTunerStandard tvaudio;\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s()\\n\", __func__);\n\n\t \n\tlvl.ucDecoderLevel = TMHW_LEV_ADJ_DECLEV_DEFAULT;\n\tlvl.ucDecoderFM_Level = TMHW_LEV_ADJ_DECLEV_DEFAULT;\n\tlvl.ucMonoLevel = TMHW_LEV_ADJ_MONOLEV_DEFAULT;\n\tlvl.ucNICAM_Level = TMHW_LEV_ADJ_NICLEV_DEFAULT;\n\tlvl.ucSAP_Level = TMHW_LEV_ADJ_SAPLEV_DEFAULT;\n\tlvl.ucADC_Level = TMHW_LEV_ADJ_ADCLEV_DEFAULT;\n\tret = saa7164_cmd_send(port->dev, port->audfeat.unitid, SET_CUR,\n\t\tAUDIO_DEFAULT_CONTROL, sizeof(struct tmComResAudioDefaults),\n\t\t&lvl);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\t \n\tif (port->encodernorm.id & V4L2_STD_NTSC) {\n\t\ttvaudio.std = TU_STANDARD_NTSC_M;\n\t\ttvaudio.country = 1;\n\t} else {\n\t\ttvaudio.std = TU_STANDARD_PAL_I;\n\t\ttvaudio.country = 44;\n\t}\n\n\tret = saa7164_cmd_send(port->dev, port->tunerunit.unitid, SET_CUR,\n\t\tTU_STANDARD_CONTROL, sizeof(tvaudio), &tvaudio);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() TU_STANDARD_CONTROL error, ret = 0x%x\\n\",\n\t\t\t__func__, ret);\n\treturn ret;\n}\n\nint saa7164_api_set_audio_detection(struct saa7164_port *port, int autodetect)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tstruct tmComResTunerStandardAuto p;\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s(%d)\\n\", __func__, autodetect);\n\n\t \n\tif (autodetect)\n\t\tp.mode = TU_STANDARD_AUTO;\n\telse\n\t\tp.mode = TU_STANDARD_MANUAL;\n\tret = saa7164_cmd_send(port->dev, port->tunerunit.unitid, SET_CUR,\n\t\tTU_STANDARD_AUTO_CONTROL, sizeof(p), &p);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR\n\t\t\t\"%s() TU_STANDARD_AUTO_CONTROL error, ret = 0x%x\\n\",\n\t\t\t__func__, ret);\n\n\treturn ret;\n}\n\nint saa7164_api_get_videomux(struct saa7164_port *port)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tint ret;\n\n\tret = saa7164_cmd_send(port->dev, port->vidproc.sourceid, GET_CUR,\n\t\tSU_INPUT_SELECT_CONTROL, sizeof(u8), &port->mux_input);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tdprintk(DBGLVL_ENC, \"%s() v_mux=%d\\n\",\n\t\t__func__, port->mux_input);\n\n\treturn ret;\n}\n\nstatic int saa7164_api_set_dif(struct saa7164_port *port, u8 reg, u8 val)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\n\tu16 len = 0;\n\tu8 buf[256];\n\tint ret;\n\tu8 mas;\n\n\tdprintk(DBGLVL_API, \"%s(nr=%d type=%d val=%x)\\n\", __func__,\n\t\tport->nr, port->type, val);\n\n\tif (port->nr == 0)\n\t\tmas = 0xd0;\n\telse\n\t\tmas = 0xe0;\n\n\tmemset(buf, 0, sizeof(buf));\n\n\tbuf[0x00] = 0x04;\n\tbuf[0x01] = 0x00;\n\tbuf[0x02] = 0x00;\n\tbuf[0x03] = 0x00;\n\n\tbuf[0x04] = 0x04;\n\tbuf[0x05] = 0x00;\n\tbuf[0x06] = 0x00;\n\tbuf[0x07] = 0x00;\n\n\tbuf[0x08] = reg;\n\tbuf[0x09] = 0x26;\n\tbuf[0x0a] = mas;\n\tbuf[0x0b] = 0xb0;\n\n\tbuf[0x0c] = val;\n\tbuf[0x0d] = 0x00;\n\tbuf[0x0e] = 0x00;\n\tbuf[0x0f] = 0x00;\n\n\tret = saa7164_cmd_send(dev, port->ifunit.unitid, GET_LEN,\n\t\tEXU_REGISTER_ACCESS_CONTROL, sizeof(len), &len);\n\tif (ret != SAA_OK) {\n\t\tprintk(KERN_ERR \"%s() error, ret(1) = 0x%x\\n\", __func__, ret);\n\t\treturn -EIO;\n\t}\n\n\tret = saa7164_cmd_send(dev, port->ifunit.unitid, SET_CUR,\n\t\tEXU_REGISTER_ACCESS_CONTROL, len, &buf);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret(2) = 0x%x\\n\", __func__, ret);\n#if 0\n\tprint_hex_dump(KERN_INFO, \"\", DUMP_PREFIX_OFFSET, 16, 1, buf, 16,\n\t\t       false);\n#endif\n\treturn ret == SAA_OK ? 0 : -EIO;\n}\n\n \nint saa7164_api_configure_dif(struct saa7164_port *port, u32 std)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tu8 agc_disable;\n\n\tdprintk(DBGLVL_API, \"%s(nr=%d, 0x%x)\\n\", __func__, port->nr, std);\n\n\tif (std & V4L2_STD_NTSC) {\n\t\tdprintk(DBGLVL_API, \" NTSC\\n\");\n\t\tsaa7164_api_set_dif(port, 0x00, 0x01);  \n\t\tagc_disable = 0;\n\t} else if (std & V4L2_STD_PAL_I) {\n\t\tdprintk(DBGLVL_API, \" PAL-I\\n\");\n\t\tsaa7164_api_set_dif(port, 0x00, 0x08);  \n\t\tagc_disable = 0;\n\t} else if (std & V4L2_STD_PAL_M) {\n\t\tdprintk(DBGLVL_API, \" PAL-M\\n\");\n\t\tsaa7164_api_set_dif(port, 0x00, 0x01);  \n\t\tagc_disable = 0;\n\t} else if (std & V4L2_STD_PAL_N) {\n\t\tdprintk(DBGLVL_API, \" PAL-N\\n\");\n\t\tsaa7164_api_set_dif(port, 0x00, 0x01);  \n\t\tagc_disable = 0;\n\t} else if (std & V4L2_STD_PAL_Nc) {\n\t\tdprintk(DBGLVL_API, \" PAL-Nc\\n\");\n\t\tsaa7164_api_set_dif(port, 0x00, 0x01);  \n\t\tagc_disable = 0;\n\t} else if (std & V4L2_STD_PAL_B) {\n\t\tdprintk(DBGLVL_API, \" PAL-B\\n\");\n\t\tsaa7164_api_set_dif(port, 0x00, 0x02);  \n\t\tagc_disable = 0;\n\t} else if (std & V4L2_STD_PAL_DK) {\n\t\tdprintk(DBGLVL_API, \" PAL-DK\\n\");\n\t\tsaa7164_api_set_dif(port, 0x00, 0x10);  \n\t\tagc_disable = 0;\n\t} else if (std & V4L2_STD_SECAM_L) {\n\t\tdprintk(DBGLVL_API, \" SECAM-L\\n\");\n\t\tsaa7164_api_set_dif(port, 0x00, 0x20);  \n\t\tagc_disable = 0;\n\t} else {\n\t\t \n\t\tdprintk(DBGLVL_API, \" Unknown (assuming DTV)\\n\");\n\t\t \n\t\tsaa7164_api_set_dif(port, 0x00, 0x80);\n\t\tagc_disable = 1;\n\t}\n\n\tsaa7164_api_set_dif(port, 0x48, 0xa0);  \n\tsaa7164_api_set_dif(port, 0xc0, agc_disable);  \n\tsaa7164_api_set_dif(port, 0x7c, 0x04);  \n\tsaa7164_api_set_dif(port, 0x04, 0x01);  \n\tmsleep(100);\n\tsaa7164_api_set_dif(port, 0x04, 0x00);  \n\tmsleep(100);\n\n\treturn 0;\n}\n\n \nint saa7164_api_initialize_dif(struct saa7164_port *port)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\tstruct saa7164_port *p = NULL;\n\tint ret = -EINVAL;\n\tu32 std = 0;\n\n\tdprintk(DBGLVL_API, \"%s(nr=%d type=%d)\\n\", __func__,\n\t\tport->nr, port->type);\n\n\tif (port->type == SAA7164_MPEG_ENCODER) {\n\t\t \n\t\tstd = V4L2_STD_NTSC;\n\t} else\n\tif (port->type == SAA7164_MPEG_DVB) {\n\t\tif (port->nr == SAA7164_PORT_TS1)\n\t\t\tp = &dev->ports[SAA7164_PORT_ENC1];\n\t\telse\n\t\t\tp = &dev->ports[SAA7164_PORT_ENC2];\n\t} else\n\tif (port->type == SAA7164_MPEG_VBI) {\n\t\tstd = V4L2_STD_NTSC;\n\t\tif (port->nr == SAA7164_PORT_VBI1)\n\t\t\tp = &dev->ports[SAA7164_PORT_ENC1];\n\t\telse\n\t\t\tp = &dev->ports[SAA7164_PORT_ENC2];\n\t} else\n\t\tBUG();\n\n\tif (p)\n\t\tret = saa7164_api_configure_dif(p, std);\n\n\treturn ret;\n}\n\nint saa7164_api_transition_port(struct saa7164_port *port, u8 mode)\n{\n\tstruct saa7164_dev *dev = port->dev;\n\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s(nr=%d unitid=0x%x,%d)\\n\",\n\t\t__func__, port->nr, port->hwcfg.unitid, mode);\n\n\tret = saa7164_cmd_send(port->dev, port->hwcfg.unitid, SET_CUR,\n\t\tSAA_STATE_CONTROL, sizeof(mode), &mode);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s(portnr %d unitid 0x%x) error, ret = 0x%x\\n\",\n\t\t\t__func__, port->nr, port->hwcfg.unitid, ret);\n\n\treturn ret;\n}\n\nint saa7164_api_get_fw_version(struct saa7164_dev *dev, u32 *version)\n{\n\tint ret;\n\n\tret = saa7164_cmd_send(dev, 0, GET_CUR,\n\t\tGET_FW_VERSION_CONTROL, sizeof(u32), version);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\treturn ret;\n}\n\nint saa7164_api_read_eeprom(struct saa7164_dev *dev, u8 *buf, int buflen)\n{\n\tu8 reg[] = { 0x0f, 0x00 };\n\n\tif (buflen < 128)\n\t\treturn -ENOMEM;\n\n\t \n\t \n\treturn saa7164_api_i2c_read(&dev->i2c_bus[0], 0xa0 >> 1, sizeof(reg),\n\t\t&reg[0], 128, buf);\n}\n\nstatic int saa7164_api_configure_port_vbi(struct saa7164_dev *dev,\n\t\t\t\t\t  struct saa7164_port *port)\n{\n\tstruct tmComResVBIFormatDescrHeader *fmt = &port->vbi_fmt_ntsc;\n\n\tdprintk(DBGLVL_API, \"    bFormatIndex  = 0x%x\\n\", fmt->bFormatIndex);\n\tdprintk(DBGLVL_API, \"    VideoStandard = 0x%x\\n\", fmt->VideoStandard);\n\tdprintk(DBGLVL_API, \"    StartLine     = %d\\n\", fmt->StartLine);\n\tdprintk(DBGLVL_API, \"    EndLine       = %d\\n\", fmt->EndLine);\n\tdprintk(DBGLVL_API, \"    FieldRate     = %d\\n\", fmt->FieldRate);\n\tdprintk(DBGLVL_API, \"    bNumLines     = %d\\n\", fmt->bNumLines);\n\n\t \n\n\tport->bufcounter = port->hwcfg.BARLocation;\n\tport->pitch = port->hwcfg.BARLocation + (2 * sizeof(u32));\n\tport->bufsize = port->hwcfg.BARLocation + (3 * sizeof(u32));\n\tport->bufoffset = port->hwcfg.BARLocation + (4 * sizeof(u32));\n\tport->bufptr32l = port->hwcfg.BARLocation +\n\t\t(4 * sizeof(u32)) +\n\t\t(sizeof(u32) * port->hwcfg.buffercount) + sizeof(u32);\n\tport->bufptr32h = port->hwcfg.BARLocation +\n\t\t(4 * sizeof(u32)) +\n\t\t(sizeof(u32) * port->hwcfg.buffercount);\n\tport->bufptr64 = port->hwcfg.BARLocation +\n\t\t(4 * sizeof(u32)) +\n\t\t(sizeof(u32) * port->hwcfg.buffercount);\n\tdprintk(DBGLVL_API, \"   = port->hwcfg.BARLocation = 0x%x\\n\",\n\t\tport->hwcfg.BARLocation);\n\n\tdprintk(DBGLVL_API, \"   = VS_FORMAT_VBI (becomes dev->en[%d])\\n\",\n\t\tport->nr);\n\n\treturn 0;\n}\n\nstatic int\nsaa7164_api_configure_port_mpeg2ts(struct saa7164_dev *dev,\n\t\t\t\t   struct saa7164_port *port,\n\t\t\t\t   struct tmComResTSFormatDescrHeader *tsfmt)\n{\n\tdprintk(DBGLVL_API, \"    bFormatIndex = 0x%x\\n\", tsfmt->bFormatIndex);\n\tdprintk(DBGLVL_API, \"    bDataOffset  = 0x%x\\n\", tsfmt->bDataOffset);\n\tdprintk(DBGLVL_API, \"    bPacketLength= 0x%x\\n\", tsfmt->bPacketLength);\n\tdprintk(DBGLVL_API, \"    bStrideLength= 0x%x\\n\", tsfmt->bStrideLength);\n\tdprintk(DBGLVL_API, \"    bguid        = (....)\\n\");\n\n\t \n\n\tport->bufcounter = port->hwcfg.BARLocation;\n\tport->pitch = port->hwcfg.BARLocation + (2 * sizeof(u32));\n\tport->bufsize = port->hwcfg.BARLocation + (3 * sizeof(u32));\n\tport->bufoffset = port->hwcfg.BARLocation + (4 * sizeof(u32));\n\tport->bufptr32l = port->hwcfg.BARLocation +\n\t\t(4 * sizeof(u32)) +\n\t\t(sizeof(u32) * port->hwcfg.buffercount) + sizeof(u32);\n\tport->bufptr32h = port->hwcfg.BARLocation +\n\t\t(4 * sizeof(u32)) +\n\t\t(sizeof(u32) * port->hwcfg.buffercount);\n\tport->bufptr64 = port->hwcfg.BARLocation +\n\t\t(4 * sizeof(u32)) +\n\t\t(sizeof(u32) * port->hwcfg.buffercount);\n\tdprintk(DBGLVL_API, \"   = port->hwcfg.BARLocation = 0x%x\\n\",\n\t\tport->hwcfg.BARLocation);\n\n\tdprintk(DBGLVL_API, \"   = VS_FORMAT_MPEGTS (becomes dev->ts[%d])\\n\",\n\t\tport->nr);\n\n\treturn 0;\n}\n\nstatic int\nsaa7164_api_configure_port_mpeg2ps(struct saa7164_dev *dev,\n\t\t\t\t   struct saa7164_port *port,\n\t\t\t\t   struct tmComResPSFormatDescrHeader *fmt)\n{\n\tdprintk(DBGLVL_API, \"    bFormatIndex = 0x%x\\n\", fmt->bFormatIndex);\n\tdprintk(DBGLVL_API, \"    wPacketLength= 0x%x\\n\", fmt->wPacketLength);\n\tdprintk(DBGLVL_API, \"    wPackLength=   0x%x\\n\", fmt->wPackLength);\n\tdprintk(DBGLVL_API, \"    bPackDataType= 0x%x\\n\", fmt->bPackDataType);\n\n\t \n\t \n\tport->bufcounter = port->hwcfg.BARLocation;\n\tport->pitch = port->hwcfg.BARLocation + (2 * sizeof(u32));\n\tport->bufsize = port->hwcfg.BARLocation + (3 * sizeof(u32));\n\tport->bufoffset = port->hwcfg.BARLocation + (4 * sizeof(u32));\n\tport->bufptr32l = port->hwcfg.BARLocation +\n\t\t(4 * sizeof(u32)) +\n\t\t(sizeof(u32) * port->hwcfg.buffercount) + sizeof(u32);\n\tport->bufptr32h = port->hwcfg.BARLocation +\n\t\t(4 * sizeof(u32)) +\n\t\t(sizeof(u32) * port->hwcfg.buffercount);\n\tport->bufptr64 = port->hwcfg.BARLocation +\n\t\t(4 * sizeof(u32)) +\n\t\t(sizeof(u32) * port->hwcfg.buffercount);\n\tdprintk(DBGLVL_API, \"   = port->hwcfg.BARLocation = 0x%x\\n\",\n\t\tport->hwcfg.BARLocation);\n\n\tdprintk(DBGLVL_API, \"   = VS_FORMAT_MPEGPS (becomes dev->enc[%d])\\n\",\n\t\tport->nr);\n\n\treturn 0;\n}\n\nstatic int saa7164_api_dump_subdevs(struct saa7164_dev *dev, u8 *buf, int len)\n{\n\tstruct saa7164_port *tsport = NULL;\n\tstruct saa7164_port *encport = NULL;\n\tstruct saa7164_port *vbiport = NULL;\n\tu32 idx, next_offset;\n\tint i;\n\tstruct tmComResDescrHeader *hdr, *t;\n\tstruct tmComResExtDevDescrHeader *exthdr;\n\tstruct tmComResPathDescrHeader *pathhdr;\n\tstruct tmComResAntTermDescrHeader *anttermhdr;\n\tstruct tmComResTunerDescrHeader *tunerunithdr;\n\tstruct tmComResDMATermDescrHeader *vcoutputtermhdr;\n\tstruct tmComResTSFormatDescrHeader *tsfmt;\n\tstruct tmComResPSFormatDescrHeader *psfmt;\n\tstruct tmComResSelDescrHeader *psel;\n\tstruct tmComResProcDescrHeader *pdh;\n\tstruct tmComResAFeatureDescrHeader *afd;\n\tstruct tmComResEncoderDescrHeader *edh;\n\tstruct tmComResVBIFormatDescrHeader *vbifmt;\n\tu32 currpath = 0;\n\n\tdprintk(DBGLVL_API,\n\t\t\"%s(?,?,%d) sizeof(struct tmComResDescrHeader) = %d bytes\\n\",\n\t\t__func__, len, (u32)sizeof(struct tmComResDescrHeader));\n\n\tfor (idx = 0; idx < (len - sizeof(struct tmComResDescrHeader));) {\n\n\t\thdr = (struct tmComResDescrHeader *)(buf + idx);\n\n\t\tif (hdr->type != CS_INTERFACE)\n\t\t\treturn SAA_ERR_NOT_SUPPORTED;\n\n\t\tdprintk(DBGLVL_API, \"@ 0x%x =\\n\", idx);\n\t\tswitch (hdr->subtype) {\n\t\tcase GENERAL_REQUEST:\n\t\t\tdprintk(DBGLVL_API, \" GENERAL_REQUEST\\n\");\n\t\t\tbreak;\n\t\tcase VC_TUNER_PATH:\n\t\t\tdprintk(DBGLVL_API, \" VC_TUNER_PATH\\n\");\n\t\t\tpathhdr = (struct tmComResPathDescrHeader *)(buf + idx);\n\t\t\tdprintk(DBGLVL_API, \"  pathid = 0x%x\\n\",\n\t\t\t\tpathhdr->pathid);\n\t\t\tcurrpath = pathhdr->pathid;\n\t\t\tbreak;\n\t\tcase VC_INPUT_TERMINAL:\n\t\t\tdprintk(DBGLVL_API, \" VC_INPUT_TERMINAL\\n\");\n\t\t\tanttermhdr =\n\t\t\t\t(struct tmComResAntTermDescrHeader *)(buf + idx);\n\t\t\tdprintk(DBGLVL_API, \"  terminalid   = 0x%x\\n\",\n\t\t\t\tanttermhdr->terminalid);\n\t\t\tdprintk(DBGLVL_API, \"  terminaltype = 0x%x\\n\",\n\t\t\t\tanttermhdr->terminaltype);\n\t\t\tswitch (anttermhdr->terminaltype) {\n\t\t\tcase ITT_ANTENNA:\n\t\t\t\tdprintk(DBGLVL_API, \"   = ITT_ANTENNA\\n\");\n\t\t\t\tbreak;\n\t\t\tcase LINE_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API, \"   = LINE_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase SPDIF_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API, \"   = SPDIF_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase COMPOSITE_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = COMPOSITE_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase SVIDEO_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API, \"   = SVIDEO_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase COMPONENT_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = COMPONENT_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase STANDARD_DMA:\n\t\t\t\tdprintk(DBGLVL_API, \"   = STANDARD_DMA\\n\");\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdprintk(DBGLVL_API, \"   = undefined (0x%x)\\n\",\n\t\t\t\t\tanttermhdr->terminaltype);\n\t\t\t}\n\t\t\tdprintk(DBGLVL_API, \"  assocterminal= 0x%x\\n\",\n\t\t\t\tanttermhdr->assocterminal);\n\t\t\tdprintk(DBGLVL_API, \"  iterminal    = 0x%x\\n\",\n\t\t\t\tanttermhdr->iterminal);\n\t\t\tdprintk(DBGLVL_API, \"  controlsize  = 0x%x\\n\",\n\t\t\t\tanttermhdr->controlsize);\n\t\t\tbreak;\n\t\tcase VC_OUTPUT_TERMINAL:\n\t\t\tdprintk(DBGLVL_API, \" VC_OUTPUT_TERMINAL\\n\");\n\t\t\tvcoutputtermhdr =\n\t\t\t\t(struct tmComResDMATermDescrHeader *)(buf + idx);\n\t\t\tdprintk(DBGLVL_API, \"  unitid = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->unitid);\n\t\t\tdprintk(DBGLVL_API, \"  terminaltype = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->terminaltype);\n\t\t\tswitch (vcoutputtermhdr->terminaltype) {\n\t\t\tcase ITT_ANTENNA:\n\t\t\t\tdprintk(DBGLVL_API, \"   = ITT_ANTENNA\\n\");\n\t\t\t\tbreak;\n\t\t\tcase LINE_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API, \"   = LINE_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase SPDIF_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API, \"   = SPDIF_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase COMPOSITE_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = COMPOSITE_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase SVIDEO_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API, \"   = SVIDEO_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase COMPONENT_CONNECTOR:\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = COMPONENT_CONNECTOR\\n\");\n\t\t\t\tbreak;\n\t\t\tcase STANDARD_DMA:\n\t\t\t\tdprintk(DBGLVL_API, \"   = STANDARD_DMA\\n\");\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdprintk(DBGLVL_API, \"   = undefined (0x%x)\\n\",\n\t\t\t\t\tvcoutputtermhdr->terminaltype);\n\t\t\t}\n\t\t\tdprintk(DBGLVL_API, \"  assocterminal= 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->assocterminal);\n\t\t\tdprintk(DBGLVL_API, \"  sourceid     = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->sourceid);\n\t\t\tdprintk(DBGLVL_API, \"  iterminal    = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->iterminal);\n\t\t\tdprintk(DBGLVL_API, \"  BARLocation  = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->BARLocation);\n\t\t\tdprintk(DBGLVL_API, \"  flags        = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->flags);\n\t\t\tdprintk(DBGLVL_API, \"  interruptid  = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->interruptid);\n\t\t\tdprintk(DBGLVL_API, \"  buffercount  = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->buffercount);\n\t\t\tdprintk(DBGLVL_API, \"  metadatasize = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->metadatasize);\n\t\t\tdprintk(DBGLVL_API, \"  controlsize  = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->controlsize);\n\t\t\tdprintk(DBGLVL_API, \"  numformats   = 0x%x\\n\",\n\t\t\t\tvcoutputtermhdr->numformats);\n\n\t\t\tnext_offset = idx + (vcoutputtermhdr->len);\n\t\t\tfor (i = 0; i < vcoutputtermhdr->numformats; i++) {\n\t\t\t\tt = (struct tmComResDescrHeader *)\n\t\t\t\t\t(buf + next_offset);\n\t\t\t\tswitch (t->subtype) {\n\t\t\t\tcase VS_FORMAT_MPEG2TS:\n\t\t\t\t\ttsfmt =\n\t\t\t\t\t(struct tmComResTSFormatDescrHeader *)t;\n\t\t\t\t\tif (currpath == 1)\n\t\t\t\t\t\ttsport = &dev->ports[SAA7164_PORT_TS1];\n\t\t\t\t\telse\n\t\t\t\t\t\ttsport = &dev->ports[SAA7164_PORT_TS2];\n\t\t\t\t\tmemcpy(&tsport->hwcfg, vcoutputtermhdr,\n\t\t\t\t\t\tsizeof(*vcoutputtermhdr));\n\t\t\t\t\tsaa7164_api_configure_port_mpeg2ts(dev,\n\t\t\t\t\t\ttsport, tsfmt);\n\t\t\t\t\tbreak;\n\t\t\t\tcase VS_FORMAT_MPEG2PS:\n\t\t\t\t\tpsfmt =\n\t\t\t\t\t(struct tmComResPSFormatDescrHeader *)t;\n\t\t\t\t\tif (currpath == 1)\n\t\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC1];\n\t\t\t\t\telse\n\t\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC2];\n\t\t\t\t\tmemcpy(&encport->hwcfg, vcoutputtermhdr,\n\t\t\t\t\t\tsizeof(*vcoutputtermhdr));\n\t\t\t\t\tsaa7164_api_configure_port_mpeg2ps(dev,\n\t\t\t\t\t\tencport, psfmt);\n\t\t\t\t\tbreak;\n\t\t\t\tcase VS_FORMAT_VBI:\n\t\t\t\t\tvbifmt =\n\t\t\t\t\t(struct tmComResVBIFormatDescrHeader *)t;\n\t\t\t\t\tif (currpath == 1)\n\t\t\t\t\t\tvbiport = &dev->ports[SAA7164_PORT_VBI1];\n\t\t\t\t\telse\n\t\t\t\t\t\tvbiport = &dev->ports[SAA7164_PORT_VBI2];\n\t\t\t\t\tmemcpy(&vbiport->hwcfg, vcoutputtermhdr,\n\t\t\t\t\t\tsizeof(*vcoutputtermhdr));\n\t\t\t\t\tmemcpy(&vbiport->vbi_fmt_ntsc, vbifmt,\n\t\t\t\t\t\tsizeof(*vbifmt));\n\t\t\t\t\tsaa7164_api_configure_port_vbi(dev,\n\t\t\t\t\t\tvbiport);\n\t\t\t\t\tbreak;\n\t\t\t\tcase VS_FORMAT_RDS:\n\t\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\t\"   = VS_FORMAT_RDS\\n\");\n\t\t\t\t\tbreak;\n\t\t\t\tcase VS_FORMAT_UNCOMPRESSED:\n\t\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = VS_FORMAT_UNCOMPRESSED\\n\");\n\t\t\t\t\tbreak;\n\t\t\t\tcase VS_FORMAT_TYPE:\n\t\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\t\"   = VS_FORMAT_TYPE\\n\");\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\t\"   = undefined (0x%x)\\n\",\n\t\t\t\t\t\tt->subtype);\n\t\t\t\t}\n\t\t\t\tnext_offset += t->len;\n\t\t\t}\n\n\t\t\tbreak;\n\t\tcase TUNER_UNIT:\n\t\t\tdprintk(DBGLVL_API, \" TUNER_UNIT\\n\");\n\t\t\ttunerunithdr =\n\t\t\t\t(struct tmComResTunerDescrHeader *)(buf + idx);\n\t\t\tdprintk(DBGLVL_API, \"  unitid = 0x%x\\n\",\n\t\t\t\ttunerunithdr->unitid);\n\t\t\tdprintk(DBGLVL_API, \"  sourceid = 0x%x\\n\",\n\t\t\t\ttunerunithdr->sourceid);\n\t\t\tdprintk(DBGLVL_API, \"  iunit = 0x%x\\n\",\n\t\t\t\ttunerunithdr->iunit);\n\t\t\tdprintk(DBGLVL_API, \"  tuningstandards = 0x%x\\n\",\n\t\t\t\ttunerunithdr->tuningstandards);\n\t\t\tdprintk(DBGLVL_API, \"  controlsize = 0x%x\\n\",\n\t\t\t\ttunerunithdr->controlsize);\n\t\t\tdprintk(DBGLVL_API, \"  controls = 0x%x\\n\",\n\t\t\t\ttunerunithdr->controls);\n\n\t\t\tif (tunerunithdr->unitid == tunerunithdr->iunit) {\n\t\t\t\tif (currpath == 1)\n\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC1];\n\t\t\t\telse\n\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC2];\n\t\t\t\tmemcpy(&encport->tunerunit, tunerunithdr,\n\t\t\t\t\tsizeof(struct tmComResTunerDescrHeader));\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"  (becomes dev->enc[%d] tuner)\\n\",\n\t\t\t\t\tencport->nr);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase VC_SELECTOR_UNIT:\n\t\t\tpsel = (struct tmComResSelDescrHeader *)(buf + idx);\n\t\t\tdprintk(DBGLVL_API, \" VC_SELECTOR_UNIT\\n\");\n\t\t\tdprintk(DBGLVL_API, \"  unitid = 0x%x\\n\",\n\t\t\t\tpsel->unitid);\n\t\t\tdprintk(DBGLVL_API, \"  nrinpins = 0x%x\\n\",\n\t\t\t\tpsel->nrinpins);\n\t\t\tdprintk(DBGLVL_API, \"  sourceid = 0x%x\\n\",\n\t\t\t\tpsel->sourceid);\n\t\t\tbreak;\n\t\tcase VC_PROCESSING_UNIT:\n\t\t\tpdh = (struct tmComResProcDescrHeader *)(buf + idx);\n\t\t\tdprintk(DBGLVL_API, \" VC_PROCESSING_UNIT\\n\");\n\t\t\tdprintk(DBGLVL_API, \"  unitid = 0x%x\\n\",\n\t\t\t\tpdh->unitid);\n\t\t\tdprintk(DBGLVL_API, \"  sourceid = 0x%x\\n\",\n\t\t\t\tpdh->sourceid);\n\t\t\tdprintk(DBGLVL_API, \"  controlsize = 0x%x\\n\",\n\t\t\t\tpdh->controlsize);\n\t\t\tif (pdh->controlsize == 0x04) {\n\t\t\t\tif (currpath == 1)\n\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC1];\n\t\t\t\telse\n\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC2];\n\t\t\t\tmemcpy(&encport->vidproc, pdh,\n\t\t\t\t\tsizeof(struct tmComResProcDescrHeader));\n\t\t\t\tdprintk(DBGLVL_API, \"  (becomes dev->enc[%d])\\n\",\n\t\t\t\t\tencport->nr);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase FEATURE_UNIT:\n\t\t\tafd = (struct tmComResAFeatureDescrHeader *)(buf + idx);\n\t\t\tdprintk(DBGLVL_API, \" FEATURE_UNIT\\n\");\n\t\t\tdprintk(DBGLVL_API, \"  unitid = 0x%x\\n\",\n\t\t\t\tafd->unitid);\n\t\t\tdprintk(DBGLVL_API, \"  sourceid = 0x%x\\n\",\n\t\t\t\tafd->sourceid);\n\t\t\tdprintk(DBGLVL_API, \"  controlsize = 0x%x\\n\",\n\t\t\t\tafd->controlsize);\n\t\t\tif (currpath == 1)\n\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC1];\n\t\t\telse\n\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC2];\n\t\t\tmemcpy(&encport->audfeat, afd,\n\t\t\t\tsizeof(struct tmComResAFeatureDescrHeader));\n\t\t\tdprintk(DBGLVL_API, \"  (becomes dev->enc[%d])\\n\",\n\t\t\t\tencport->nr);\n\t\t\tbreak;\n\t\tcase ENCODER_UNIT:\n\t\t\tedh = (struct tmComResEncoderDescrHeader *)(buf + idx);\n\t\t\tdprintk(DBGLVL_API, \" ENCODER_UNIT\\n\");\n\t\t\tdprintk(DBGLVL_API, \"  subtype = 0x%x\\n\", edh->subtype);\n\t\t\tdprintk(DBGLVL_API, \"  unitid = 0x%x\\n\", edh->unitid);\n\t\t\tdprintk(DBGLVL_API, \"  vsourceid = 0x%x\\n\",\n\t\t\tedh->vsourceid);\n\t\t\tdprintk(DBGLVL_API, \"  asourceid = 0x%x\\n\",\n\t\t\t\tedh->asourceid);\n\t\t\tdprintk(DBGLVL_API, \"  iunit = 0x%x\\n\", edh->iunit);\n\t\t\tif (edh->iunit == edh->unitid) {\n\t\t\t\tif (currpath == 1)\n\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC1];\n\t\t\t\telse\n\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC2];\n\t\t\t\tmemcpy(&encport->encunit, edh,\n\t\t\t\t\tsizeof(struct tmComResEncoderDescrHeader));\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"  (becomes dev->enc[%d])\\n\",\n\t\t\t\t\tencport->nr);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase EXTENSION_UNIT:\n\t\t\tdprintk(DBGLVL_API, \" EXTENSION_UNIT\\n\");\n\t\t\texthdr = (struct tmComResExtDevDescrHeader *)(buf + idx);\n\t\t\tdprintk(DBGLVL_API, \"  unitid = 0x%x\\n\",\n\t\t\t\texthdr->unitid);\n\t\t\tdprintk(DBGLVL_API, \"  deviceid = 0x%x\\n\",\n\t\t\t\texthdr->deviceid);\n\t\t\tdprintk(DBGLVL_API, \"  devicetype = 0x%x\\n\",\n\t\t\t\texthdr->devicetype);\n\t\t\tif (exthdr->devicetype & 0x1)\n\t\t\t\tdprintk(DBGLVL_API, \"   = Decoder Device\\n\");\n\t\t\tif (exthdr->devicetype & 0x2)\n\t\t\t\tdprintk(DBGLVL_API, \"   = GPIO Source\\n\");\n\t\t\tif (exthdr->devicetype & 0x4)\n\t\t\t\tdprintk(DBGLVL_API, \"   = Video Decoder\\n\");\n\t\t\tif (exthdr->devicetype & 0x8)\n\t\t\t\tdprintk(DBGLVL_API, \"   = Audio Decoder\\n\");\n\t\t\tif (exthdr->devicetype & 0x20)\n\t\t\t\tdprintk(DBGLVL_API, \"   = Crossbar\\n\");\n\t\t\tif (exthdr->devicetype & 0x40)\n\t\t\t\tdprintk(DBGLVL_API, \"   = Tuner\\n\");\n\t\t\tif (exthdr->devicetype & 0x80)\n\t\t\t\tdprintk(DBGLVL_API, \"   = IF PLL\\n\");\n\t\t\tif (exthdr->devicetype & 0x100)\n\t\t\t\tdprintk(DBGLVL_API, \"   = Demodulator\\n\");\n\t\t\tif (exthdr->devicetype & 0x200)\n\t\t\t\tdprintk(DBGLVL_API, \"   = RDS Decoder\\n\");\n\t\t\tif (exthdr->devicetype & 0x400)\n\t\t\t\tdprintk(DBGLVL_API, \"   = Encoder\\n\");\n\t\t\tif (exthdr->devicetype & 0x800)\n\t\t\t\tdprintk(DBGLVL_API, \"   = IR Decoder\\n\");\n\t\t\tif (exthdr->devicetype & 0x1000)\n\t\t\t\tdprintk(DBGLVL_API, \"   = EEPROM\\n\");\n\t\t\tif (exthdr->devicetype & 0x2000)\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = VBI Decoder\\n\");\n\t\t\tif (exthdr->devicetype & 0x10000)\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = Streaming Device\\n\");\n\t\t\tif (exthdr->devicetype & 0x20000)\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = DRM Device\\n\");\n\t\t\tif (exthdr->devicetype & 0x40000000)\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = Generic Device\\n\");\n\t\t\tif (exthdr->devicetype & 0x80000000)\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"   = Config Space Device\\n\");\n\t\t\tdprintk(DBGLVL_API, \"  numgpiopins = 0x%x\\n\",\n\t\t\t\texthdr->numgpiopins);\n\t\t\tdprintk(DBGLVL_API, \"  numgpiogroups = 0x%x\\n\",\n\t\t\t\texthdr->numgpiogroups);\n\t\t\tdprintk(DBGLVL_API, \"  controlsize = 0x%x\\n\",\n\t\t\t\texthdr->controlsize);\n\t\t\tif (exthdr->devicetype & 0x80) {\n\t\t\t\tif (currpath == 1)\n\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC1];\n\t\t\t\telse\n\t\t\t\t\tencport = &dev->ports[SAA7164_PORT_ENC2];\n\t\t\t\tmemcpy(&encport->ifunit, exthdr,\n\t\t\t\t\tsizeof(struct tmComResExtDevDescrHeader));\n\t\t\t\tdprintk(DBGLVL_API,\n\t\t\t\t\t\"  (becomes dev->enc[%d])\\n\",\n\t\t\t\t\tencport->nr);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase PVC_INFRARED_UNIT:\n\t\t\tdprintk(DBGLVL_API, \" PVC_INFRARED_UNIT\\n\");\n\t\t\tbreak;\n\t\tcase DRM_UNIT:\n\t\t\tdprintk(DBGLVL_API, \" DRM_UNIT\\n\");\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdprintk(DBGLVL_API, \"default %d\\n\", hdr->subtype);\n\t\t}\n\n\t\tdprintk(DBGLVL_API, \" 1.%x\\n\", hdr->len);\n\t\tdprintk(DBGLVL_API, \" 2.%x\\n\", hdr->type);\n\t\tdprintk(DBGLVL_API, \" 3.%x\\n\", hdr->subtype);\n\t\tdprintk(DBGLVL_API, \" 4.%x\\n\", hdr->unitid);\n\n\t\tidx += hdr->len;\n\t}\n\n\treturn 0;\n}\n\nint saa7164_api_enum_subdevs(struct saa7164_dev *dev)\n{\n\tint ret;\n\tu32 buflen = 0;\n\tu8 *buf;\n\n\tdprintk(DBGLVL_API, \"%s()\\n\", __func__);\n\n\t \n\tret = saa7164_cmd_send(dev, 0, GET_LEN,\n\t\tGET_DESCRIPTORS_CONTROL, sizeof(buflen), &buflen);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\n\tdprintk(DBGLVL_API, \"%s() total descriptor size = %d bytes.\\n\",\n\t\t__func__, buflen);\n\n\t \n\tbuf = kzalloc(buflen, GFP_KERNEL);\n\tif (!buf)\n\t\treturn SAA_ERR_NO_RESOURCES;\n\n\t \n\tret = saa7164_cmd_send(dev, 0, GET_CUR,\n\t\tGET_DESCRIPTORS_CONTROL, buflen, buf);\n\tif (ret != SAA_OK) {\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\", __func__, ret);\n\t\tgoto out;\n\t}\n\n\tif (saa_debug & DBGLVL_API)\n\t\tprint_hex_dump(KERN_INFO, \"\", DUMP_PREFIX_OFFSET, 16, 1, buf,\n\t\t\t       buflen & ~15, false);\n\n\tsaa7164_api_dump_subdevs(dev, buf, buflen);\n\nout:\n\tkfree(buf);\n\treturn ret;\n}\n\nint saa7164_api_i2c_read(struct saa7164_i2c *bus, u8 addr, u32 reglen, u8 *reg,\n\tu32 datalen, u8 *data)\n{\n\tstruct saa7164_dev *dev = bus->dev;\n\tu16 len = 0;\n\tint unitid;\n\tu8 buf[256];\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s() addr=%x reglen=%d datalen=%d\\n\",\n\t\t__func__, addr, reglen, datalen);\n\n\tif (reglen > 4)\n\t\treturn -EIO;\n\n\t \n\t \n\tmemset(buf, 0, sizeof(buf));\n\tmemcpy((buf + 2 * sizeof(u32) + 0), reg, reglen);\n\t*((u32 *)(buf + 0 * sizeof(u32))) = reglen;\n\t*((u32 *)(buf + 1 * sizeof(u32))) = datalen;\n\n\tunitid = saa7164_i2caddr_to_unitid(bus, addr);\n\tif (unitid < 0) {\n\t\tprintk(KERN_ERR\n\t\t\t\"%s() error, cannot translate regaddr 0x%x to unitid\\n\",\n\t\t\t__func__, addr);\n\t\treturn -EIO;\n\t}\n\n\tret = saa7164_cmd_send(bus->dev, unitid, GET_LEN,\n\t\tEXU_REGISTER_ACCESS_CONTROL, sizeof(len), &len);\n\tif (ret != SAA_OK) {\n\t\tprintk(KERN_ERR \"%s() error, ret(1) = 0x%x\\n\", __func__, ret);\n\t\treturn -EIO;\n\t}\n\n\tdprintk(DBGLVL_API, \"%s() len = %d bytes\\n\", __func__, len);\n\n\tif (saa_debug & DBGLVL_I2C)\n\t\tprint_hex_dump(KERN_INFO, \"\", DUMP_PREFIX_OFFSET, 16, 1, buf,\n\t\t\t       32, false);\n\n\tret = saa7164_cmd_send(bus->dev, unitid, GET_CUR,\n\t\tEXU_REGISTER_ACCESS_CONTROL, len, &buf);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret(2) = 0x%x\\n\", __func__, ret);\n\telse {\n\t\tif (saa_debug & DBGLVL_I2C)\n\t\t\tprint_hex_dump(KERN_INFO, \"\", DUMP_PREFIX_OFFSET, 16, 1,\n\t\t\t\t       buf, sizeof(buf), false);\n\t\tmemcpy(data, (buf + 2 * sizeof(u32) + reglen), datalen);\n\t}\n\n\treturn ret == SAA_OK ? 0 : -EIO;\n}\n\n \nint saa7164_api_i2c_write(struct saa7164_i2c *bus, u8 addr, u32 datalen,\n\tu8 *data)\n{\n\tstruct saa7164_dev *dev = bus->dev;\n\tu16 len = 0;\n\tint unitid;\n\tint reglen;\n\tu8 buf[256];\n\tint ret;\n\n\tdprintk(DBGLVL_API, \"%s() addr=0x%2x len=0x%x\\n\",\n\t\t__func__, addr, datalen);\n\n\tif ((datalen == 0) || (datalen > 232))\n\t\treturn -EIO;\n\n\tmemset(buf, 0, sizeof(buf));\n\n\tunitid = saa7164_i2caddr_to_unitid(bus, addr);\n\tif (unitid < 0) {\n\t\tprintk(KERN_ERR\n\t\t\t\"%s() error, cannot translate regaddr 0x%x to unitid\\n\",\n\t\t\t__func__, addr);\n\t\treturn -EIO;\n\t}\n\n\treglen = saa7164_i2caddr_to_reglen(bus, addr);\n\tif (reglen < 0) {\n\t\tprintk(KERN_ERR\n\t\t\t\"%s() error, cannot translate regaddr to reglen\\n\",\n\t\t\t__func__);\n\t\treturn -EIO;\n\t}\n\n\tret = saa7164_cmd_send(bus->dev, unitid, GET_LEN,\n\t\tEXU_REGISTER_ACCESS_CONTROL, sizeof(len), &len);\n\tif (ret != SAA_OK) {\n\t\tprintk(KERN_ERR \"%s() error, ret(1) = 0x%x\\n\", __func__, ret);\n\t\treturn -EIO;\n\t}\n\n\tdprintk(DBGLVL_API, \"%s() len = %d bytes unitid=0x%x\\n\", __func__,\n\t\tlen, unitid);\n\n\t \n\t \n\t*((u32 *)(buf + 0 * sizeof(u32))) = reglen;\n\t*((u32 *)(buf + 1 * sizeof(u32))) = datalen - reglen;\n\tmemcpy((buf + 2 * sizeof(u32)), data, datalen);\n\n\tif (saa_debug & DBGLVL_I2C)\n\t\tprint_hex_dump(KERN_INFO, \"\", DUMP_PREFIX_OFFSET, 16, 1,\n\t\t\t       buf, sizeof(buf), false);\n\n\tret = saa7164_cmd_send(bus->dev, unitid, SET_CUR,\n\t\tEXU_REGISTER_ACCESS_CONTROL, len, &buf);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret(2) = 0x%x\\n\", __func__, ret);\n\n\treturn ret == SAA_OK ? 0 : -EIO;\n}\n\nstatic int saa7164_api_modify_gpio(struct saa7164_dev *dev, u8 unitid,\n\tu8 pin, u8 state)\n{\n\tint ret;\n\tstruct tmComResGPIO t;\n\n\tdprintk(DBGLVL_API, \"%s(0x%x, %d, %d)\\n\",\n\t\t__func__, unitid, pin, state);\n\n\tif ((pin > 7) || (state > 2))\n\t\treturn SAA_ERR_BAD_PARAMETER;\n\n\tt.pin = pin;\n\tt.state = state;\n\n\tret = saa7164_cmd_send(dev, unitid, SET_CUR,\n\t\tEXU_GPIO_CONTROL, sizeof(t), &t);\n\tif (ret != SAA_OK)\n\t\tprintk(KERN_ERR \"%s() error, ret = 0x%x\\n\",\n\t\t\t__func__, ret);\n\n\treturn ret;\n}\n\nint saa7164_api_set_gpiobit(struct saa7164_dev *dev, u8 unitid,\n\tu8 pin)\n{\n\treturn saa7164_api_modify_gpio(dev, unitid, pin, 1);\n}\n\nint saa7164_api_clear_gpiobit(struct saa7164_dev *dev, u8 unitid,\n\tu8 pin)\n{\n\treturn saa7164_api_modify_gpio(dev, unitid, pin, 0);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}