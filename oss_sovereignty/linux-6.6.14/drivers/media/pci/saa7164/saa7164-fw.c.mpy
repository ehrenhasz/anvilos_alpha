{
  "module_name": "saa7164-fw.c",
  "hash_id": "06f90e9c87818d8023a7c42d5a749658a7a532423e259710dd63c01727625227",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/saa7164/saa7164-fw.c",
  "human_readable_source": "\n \n\n#include <linux/firmware.h>\n#include <linux/slab.h>\n\n#include \"saa7164.h\"\n\n#define SAA7164_REV2_FIRMWARE\t\t\"NXP7164-2010-03-10.1.fw\"\n#define SAA7164_REV2_FIRMWARE_SIZE\t4019072\n\n#define SAA7164_REV3_FIRMWARE\t\t\"NXP7164-2010-03-10.1.fw\"\n#define SAA7164_REV3_FIRMWARE_SIZE\t4019072\n\nstruct fw_header {\n\tu32\tfirmwaresize;\n\tu32\tbslsize;\n\tu32\treserved;\n\tu32\tversion;\n};\n\nstatic int saa7164_dl_wait_ack(struct saa7164_dev *dev, u32 reg)\n{\n\tu32 timeout = SAA_DEVICE_TIMEOUT;\n\twhile ((saa7164_readl(reg) & 0x01) == 0) {\n\t\ttimeout -= 10;\n\t\tif (timeout == 0) {\n\t\t\tprintk(KERN_ERR \"%s() timeout (no d/l ack)\\n\",\n\t\t\t\t__func__);\n\t\t\treturn -EBUSY;\n\t\t}\n\t\tmsleep(100);\n\t}\n\n\treturn 0;\n}\n\nstatic int saa7164_dl_wait_clr(struct saa7164_dev *dev, u32 reg)\n{\n\tu32 timeout = SAA_DEVICE_TIMEOUT;\n\twhile (saa7164_readl(reg) & 0x01) {\n\t\ttimeout -= 10;\n\t\tif (timeout == 0) {\n\t\t\tprintk(KERN_ERR \"%s() timeout (no d/l clr)\\n\",\n\t\t\t\t__func__);\n\t\t\treturn -EBUSY;\n\t\t}\n\t\tmsleep(100);\n\t}\n\n\treturn 0;\n}\n\n \n \nstatic int saa7164_downloadimage(struct saa7164_dev *dev, u8 *src, u32 srcsize,\n\t\t\t\t u32 dlflags, u8 __iomem *dst, u32 dstsize)\n{\n\tu32 reg, timeout, offset;\n\tu8 *srcbuf = NULL;\n\tint ret;\n\n\tu32 dlflag = dlflags;\n\tu32 dlflag_ack = dlflag + 4;\n\tu32 drflag = dlflag_ack + 4;\n\tu32 drflag_ack = drflag + 4;\n\tu32 bleflag = drflag_ack + 4;\n\n\tdprintk(DBGLVL_FW,\n\t\t\"%s(image=%p, size=%d, flags=0x%x, dst=%p, dstsize=0x%x)\\n\",\n\t\t__func__, src, srcsize, dlflags, dst, dstsize);\n\n\tif ((src == NULL) || (dst == NULL)) {\n\t\tret = -EIO;\n\t\tgoto out;\n\t}\n\n\tsrcbuf = kzalloc(4 * 1048576, GFP_KERNEL);\n\tif (NULL == srcbuf) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tif (srcsize > (4*1048576)) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tmemcpy(srcbuf, src, srcsize);\n\n\tdprintk(DBGLVL_FW, \"%s() dlflag = 0x%x\\n\", __func__, dlflag);\n\tdprintk(DBGLVL_FW, \"%s() dlflag_ack = 0x%x\\n\", __func__, dlflag_ack);\n\tdprintk(DBGLVL_FW, \"%s() drflag = 0x%x\\n\", __func__, drflag);\n\tdprintk(DBGLVL_FW, \"%s() drflag_ack = 0x%x\\n\", __func__, drflag_ack);\n\tdprintk(DBGLVL_FW, \"%s() bleflag = 0x%x\\n\", __func__, bleflag);\n\n\treg = saa7164_readl(dlflag);\n\tdprintk(DBGLVL_FW, \"%s() dlflag (0x%x)= 0x%x\\n\", __func__, dlflag, reg);\n\tif (reg == 1)\n\t\tdprintk(DBGLVL_FW,\n\t\t\t\"%s() Download flag already set, please reboot\\n\",\n\t\t\t__func__);\n\n\t \n\tsaa7164_writel(dlflag, 1);\n\tret = saa7164_dl_wait_ack(dev, dlflag_ack);\n\tif (ret < 0)\n\t\tgoto out;\n\n\t \n\tsaa7164_writel(dlflag, 0);\n\tret = saa7164_dl_wait_clr(dev, dlflag_ack);\n\tif (ret < 0)\n\t\tgoto out;\n\n\t \n\tfor (offset = 0; srcsize > dstsize;\n\t\tsrcsize -= dstsize, offset += dstsize) {\n\n\t\tdprintk(DBGLVL_FW, \"%s() memcpy %d\\n\", __func__, dstsize);\n\t\tmemcpy_toio(dst, srcbuf + offset, dstsize);\n\n\t\t \n\t\tsaa7164_writel(drflag, 1);\n\t\tret = saa7164_dl_wait_ack(dev, drflag_ack);\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\n\t\t \n\t\tsaa7164_writel(drflag, 0);\n\t\tret = saa7164_dl_wait_clr(dev, drflag_ack);\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\n\t}\n\n\tdprintk(DBGLVL_FW, \"%s() memcpy(l) %d\\n\", __func__, dstsize);\n\t \n\tmemcpy_toio(dst, srcbuf+offset, srcsize);\n\n\t \n\tsaa7164_writel(drflag, 1);\n\tret = saa7164_dl_wait_ack(dev, drflag_ack);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tsaa7164_writel(drflag, 0);\n\ttimeout = 0;\n\twhile (saa7164_readl(bleflag) != SAA_DEVICE_IMAGE_BOOTING) {\n\t\tif (saa7164_readl(bleflag) & SAA_DEVICE_IMAGE_CORRUPT) {\n\t\t\tprintk(KERN_ERR \"%s() image corrupt\\n\", __func__);\n\t\t\tret = -EBUSY;\n\t\t\tgoto out;\n\t\t}\n\n\t\tif (saa7164_readl(bleflag) & SAA_DEVICE_MEMORY_CORRUPT) {\n\t\t\tprintk(KERN_ERR \"%s() device memory corrupt\\n\",\n\t\t\t\t__func__);\n\t\t\tret = -EBUSY;\n\t\t\tgoto out;\n\t\t}\n\n\t\tmsleep(10);  \n\t\tif (timeout++ > 60)\n\t\t\tbreak;\n\t}\n\n\tprintk(KERN_INFO \"%s() Image downloaded, booting...\\n\", __func__);\n\n\tret = saa7164_dl_wait_clr(dev, drflag_ack);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tprintk(KERN_INFO \"%s() Image booted successfully.\\n\", __func__);\n\tret = 0;\n\nout:\n\tkfree(srcbuf);\n\treturn ret;\n}\n\n \n \nint saa7164_downloadfirmware(struct saa7164_dev *dev)\n{\n\t \n\tu32 tmp, filesize, version, err_flags, first_timeout, fwlength;\n\tu32 second_timeout, updatebootloader = 1, bootloadersize = 0;\n\tconst struct firmware *fw = NULL;\n\tstruct fw_header *hdr, *boothdr = NULL, *fwhdr;\n\tu32 bootloaderversion = 0, fwloadersize;\n\tu8 *bootloaderoffset = NULL, *fwloaderoffset;\n\tchar *fwname;\n\tint ret;\n\n\tdprintk(DBGLVL_FW, \"%s()\\n\", __func__);\n\n\tif (saa7164_boards[dev->board].chiprev == SAA7164_CHIP_REV2) {\n\t\tfwname = SAA7164_REV2_FIRMWARE;\n\t\tfwlength = SAA7164_REV2_FIRMWARE_SIZE;\n\t} else {\n\t\tfwname = SAA7164_REV3_FIRMWARE;\n\t\tfwlength = SAA7164_REV3_FIRMWARE_SIZE;\n\t}\n\n\tversion = saa7164_getcurrentfirmwareversion(dev);\n\n\tif (version == 0x00) {\n\n\t\tsecond_timeout = 100;\n\t\tfirst_timeout = 100;\n\t\terr_flags = saa7164_readl(SAA_BOOTLOADERERROR_FLAGS);\n\t\tdprintk(DBGLVL_FW, \"%s() err_flags = %x\\n\",\n\t\t\t__func__, err_flags);\n\n\t\twhile (err_flags != SAA_DEVICE_IMAGE_BOOTING) {\n\t\t\tdprintk(DBGLVL_FW, \"%s() err_flags = %x\\n\",\n\t\t\t\t__func__, err_flags);\n\t\t\tmsleep(10);  \n\n\t\t\tif (err_flags & SAA_DEVICE_IMAGE_CORRUPT) {\n\t\t\t\tprintk(KERN_ERR \"%s() firmware corrupt\\n\",\n\t\t\t\t\t__func__);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (err_flags & SAA_DEVICE_MEMORY_CORRUPT) {\n\t\t\t\tprintk(KERN_ERR \"%s() device memory corrupt\\n\",\n\t\t\t\t\t__func__);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (err_flags & SAA_DEVICE_NO_IMAGE) {\n\t\t\t\tprintk(KERN_ERR \"%s() no first image\\n\",\n\t\t\t\t__func__);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (err_flags & SAA_DEVICE_IMAGE_SEARCHING) {\n\t\t\t\tfirst_timeout -= 10;\n\t\t\t\tif (first_timeout == 0) {\n\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\t\"%s() no first image\\n\",\n\t\t\t\t\t\t__func__);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else if (err_flags & SAA_DEVICE_IMAGE_LOADING) {\n\t\t\t\tsecond_timeout -= 10;\n\t\t\t\tif (second_timeout == 0) {\n\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\"%s() FW load time exceeded\\n\",\n\t\t\t\t\t\t__func__);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tsecond_timeout -= 10;\n\t\t\t\tif (second_timeout == 0) {\n\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\"%s() Unknown bootloader flags 0x%x\\n\",\n\t\t\t\t\t\t__func__, err_flags);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\terr_flags = saa7164_readl(SAA_BOOTLOADERERROR_FLAGS);\n\t\t}  \n\n\t\tif (err_flags == SAA_DEVICE_IMAGE_BOOTING) {\n\t\t\tdprintk(DBGLVL_FW, \"%s() Loader 1 has loaded.\\n\",\n\t\t\t\t__func__);\n\t\t\tfirst_timeout = SAA_DEVICE_TIMEOUT;\n\t\t\tsecond_timeout = 100;\n\n\t\t\terr_flags = saa7164_readl(SAA_SECONDSTAGEERROR_FLAGS);\n\t\t\tdprintk(DBGLVL_FW, \"%s() err_flags2 = %x\\n\",\n\t\t\t\t__func__, err_flags);\n\t\t\twhile (err_flags != SAA_DEVICE_IMAGE_BOOTING) {\n\t\t\t\tdprintk(DBGLVL_FW, \"%s() err_flags2 = %x\\n\",\n\t\t\t\t\t__func__, err_flags);\n\t\t\t\tmsleep(10);  \n\n\t\t\t\tif (err_flags & SAA_DEVICE_IMAGE_CORRUPT) {\n\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\t\"%s() firmware corrupt\\n\",\n\t\t\t\t\t\t__func__);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (err_flags & SAA_DEVICE_MEMORY_CORRUPT) {\n\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\t\"%s() device memory corrupt\\n\",\n\t\t\t\t\t\t__func__);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (err_flags & SAA_DEVICE_NO_IMAGE) {\n\t\t\t\t\tprintk(KERN_ERR \"%s() no second image\\n\",\n\t\t\t\t\t\t__func__);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (err_flags & SAA_DEVICE_IMAGE_SEARCHING) {\n\t\t\t\t\tfirst_timeout -= 10;\n\t\t\t\t\tif (first_timeout == 0) {\n\t\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\t\"%s() no second image\\n\",\n\t\t\t\t\t\t\t__func__);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t} else if (err_flags &\n\t\t\t\t\tSAA_DEVICE_IMAGE_LOADING) {\n\t\t\t\t\tsecond_timeout -= 10;\n\t\t\t\t\tif (second_timeout == 0) {\n\t\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\t\"%s() FW load time exceeded\\n\",\n\t\t\t\t\t\t\t__func__);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tsecond_timeout -= 10;\n\t\t\t\t\tif (second_timeout == 0) {\n\t\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\"%s() Unknown bootloader flags 0x%x\\n\",\n\t\t\t\t\t\t\t__func__, err_flags);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\terr_flags =\n\t\t\t\tsaa7164_readl(SAA_SECONDSTAGEERROR_FLAGS);\n\t\t\t}  \n\n\t\t\tdprintk(DBGLVL_FW, \"%s() Loader flags 1:0x%x 2:0x%x.\\n\",\n\t\t\t\t__func__,\n\t\t\t\tsaa7164_readl(SAA_BOOTLOADERERROR_FLAGS),\n\t\t\t\tsaa7164_readl(SAA_SECONDSTAGEERROR_FLAGS));\n\n\t\t}  \n\n\t\t \n\t\tif ((saa7164_readl(SAA_BOOTLOADERERROR_FLAGS) ==\n\t\t\tSAA_DEVICE_IMAGE_BOOTING) &&\n\t\t\t(saa7164_readl(SAA_SECONDSTAGEERROR_FLAGS) ==\n\t\t\tSAA_DEVICE_IMAGE_BOOTING)) {\n\n\n\t\t\tdprintk(DBGLVL_FW, \"%s() Loader 2 has loaded.\\n\",\n\t\t\t\t__func__);\n\n\t\t\tfirst_timeout = SAA_DEVICE_TIMEOUT;\n\t\t\twhile (first_timeout) {\n\t\t\t\tmsleep(10);  \n\n\t\t\t\tversion =\n\t\t\t\t\tsaa7164_getcurrentfirmwareversion(dev);\n\t\t\t\tif (version) {\n\t\t\t\t\tdprintk(DBGLVL_FW,\n\t\t\t\t\t\"%s() All f/w loaded successfully\\n\",\n\t\t\t\t\t\t__func__);\n\t\t\t\t\tbreak;\n\t\t\t\t} else {\n\t\t\t\t\tfirst_timeout -= 10;\n\t\t\t\t\tif (first_timeout == 0) {\n\t\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\t\"%s() FW did not boot\\n\",\n\t\t\t\t\t\t\t__func__);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tversion = saa7164_getcurrentfirmwareversion(dev);\n\t}  \n\n\t \n\tif ((saa7164_readl(SAA_BOOTLOADERERROR_FLAGS) ==\n\t\tSAA_DEVICE_IMAGE_BOOTING) &&\n\t\t(saa7164_readl(SAA_SECONDSTAGEERROR_FLAGS) ==\n\t\tSAA_DEVICE_IMAGE_BOOTING) && (version == 0)) {\n\n\t\tprintk(KERN_ERR\n\t\t\t\"%s() The firmware hung, probably bad firmware\\n\",\n\t\t\t__func__);\n\n\t\t \n\t\tsaa7164_writel(SAA_DEVICE_DEADLOCK_DETECTED_OFFSET,\n\t\t\tSAA_DEVICE_DEADLOCK_DETECTED);\n\n\t\tsaa7164_getfirmwarestatus(dev);\n\n\t\treturn -ENOMEM;\n\t}\n\n\tdprintk(DBGLVL_FW, \"Device has Firmware Version %d.%d.%d.%d\\n\",\n\t\t(version & 0x0000fc00) >> 10,\n\t\t(version & 0x000003e0) >> 5,\n\t\t(version & 0x0000001f),\n\t\t(version & 0xffff0000) >> 16);\n\n\t \n\tif (version == 0) {\n\n\t\tprintk(KERN_INFO \"%s() Waiting for firmware upload (%s)\\n\",\n\t\t\t__func__, fwname);\n\n\t\tret = request_firmware(&fw, fwname, &dev->pci->dev);\n\t\tif (ret) {\n\t\t\tprintk(KERN_ERR \"%s() Upload failed. (file not found?)\\n\",\n\t\t\t       __func__);\n\t\t\treturn -ENOMEM;\n\t\t}\n\n\t\tprintk(KERN_INFO \"%s() firmware read %zu bytes.\\n\",\n\t\t\t__func__, fw->size);\n\n\t\tif (fw->size != fwlength) {\n\t\t\tprintk(KERN_ERR \"saa7164: firmware incorrect size %zu != %u\\n\",\n\t\t\t\tfw->size, fwlength);\n\t\t\tret = -ENOMEM;\n\t\t\tgoto out;\n\t\t}\n\n\t\tprintk(KERN_INFO \"%s() firmware loaded.\\n\", __func__);\n\n\t\thdr = (struct fw_header *)fw->data;\n\t\tprintk(KERN_INFO \"Firmware file header part 1:\\n\");\n\t\tprintk(KERN_INFO \" .FirmwareSize = 0x%x\\n\", hdr->firmwaresize);\n\t\tprintk(KERN_INFO \" .BSLSize = 0x%x\\n\", hdr->bslsize);\n\t\tprintk(KERN_INFO \" .Reserved = 0x%x\\n\", hdr->reserved);\n\t\tprintk(KERN_INFO \" .Version = 0x%x\\n\", hdr->version);\n\n\t\t \n\t\tif ((hdr->firmwaresize == 0) && (hdr->bslsize == 0))\n\t\t\t \n\t\t\tfilesize = hdr->reserved * 16;\n\t\telse\n\t\t\tfilesize = (hdr->firmwaresize + hdr->bslsize) *\n\t\t\t\t16 + sizeof(struct fw_header);\n\n\t\tprintk(KERN_INFO \"%s() SecBootLoader.FileSize = %d\\n\",\n\t\t\t__func__, filesize);\n\n\t\t \n\t\tif ((hdr->firmwaresize == 0) && (hdr->bslsize == 0)) {\n\t\t\t \n\n\t\t\t \n\t\t\tboothdr = (struct fw_header *)(fw->data +\n\t\t\t\tsizeof(struct fw_header));\n\n\t\t\tbootloaderversion =\n\t\t\t\tsaa7164_readl(SAA_DEVICE_2ND_VERSION);\n\t\t\tdprintk(DBGLVL_FW, \"Onboard BootLoader:\\n\");\n\t\t\tdprintk(DBGLVL_FW, \"->Flag 0x%x\\n\",\n\t\t\t\tsaa7164_readl(SAA_BOOTLOADERERROR_FLAGS));\n\t\t\tdprintk(DBGLVL_FW, \"->Ack 0x%x\\n\",\n\t\t\t\tsaa7164_readl(SAA_DATAREADY_FLAG_ACK));\n\t\t\tdprintk(DBGLVL_FW, \"->FW Version 0x%x\\n\", version);\n\t\t\tdprintk(DBGLVL_FW, \"->Loader Version 0x%x\\n\",\n\t\t\t\tbootloaderversion);\n\n\t\t\tif ((saa7164_readl(SAA_BOOTLOADERERROR_FLAGS) ==\n\t\t\t\t0x03) && (saa7164_readl(SAA_DATAREADY_FLAG_ACK)\n\t\t\t\t== 0x00) && (version == 0x00)) {\n\n\t\t\t\tdprintk(DBGLVL_FW, \"BootLoader version in  rom %d.%d.%d.%d\\n\",\n\t\t\t\t\t(bootloaderversion & 0x0000fc00) >> 10,\n\t\t\t\t\t(bootloaderversion & 0x000003e0) >> 5,\n\t\t\t\t\t(bootloaderversion & 0x0000001f),\n\t\t\t\t\t(bootloaderversion & 0xffff0000) >> 16\n\t\t\t\t\t);\n\t\t\t\tdprintk(DBGLVL_FW, \"BootLoader version in file %d.%d.%d.%d\\n\",\n\t\t\t\t\t(boothdr->version & 0x0000fc00) >> 10,\n\t\t\t\t\t(boothdr->version & 0x000003e0) >> 5,\n\t\t\t\t\t(boothdr->version & 0x0000001f),\n\t\t\t\t\t(boothdr->version & 0xffff0000) >> 16\n\t\t\t\t\t);\n\n\t\t\t\tif (bootloaderversion == boothdr->version)\n\t\t\t\t\tupdatebootloader = 0;\n\t\t\t}\n\n\t\t\t \n\t\t\ttmp = (boothdr->firmwaresize + boothdr->bslsize) * 16 +\n\t\t\t\t(sizeof(struct fw_header) +\n\t\t\t\tsizeof(struct fw_header));\n\n\t\t\tfwhdr = (struct fw_header *)(fw->data+tmp);\n\t\t} else {\n\t\t\t \n\t\t\tfwhdr = hdr;\n\t\t}\n\n\t\tdprintk(DBGLVL_FW, \"Firmware version in file %d.%d.%d.%d\\n\",\n\t\t\t(fwhdr->version & 0x0000fc00) >> 10,\n\t\t\t(fwhdr->version & 0x000003e0) >> 5,\n\t\t\t(fwhdr->version & 0x0000001f),\n\t\t\t(fwhdr->version & 0xffff0000) >> 16\n\t\t\t);\n\n\t\tif (version == fwhdr->version) {\n\t\t\t \n\t\t\tret = 0;\n\t\t\tgoto out;\n\t\t}\n\n\t\tif ((hdr->firmwaresize == 0) && (hdr->bslsize == 0)) {\n\t\t\tif (updatebootloader) {\n\t\t\t\t \n\t\t\t\tbootloadersize = (boothdr->firmwaresize +\n\t\t\t\t\tboothdr->bslsize) * 16 +\n\t\t\t\t\tsizeof(struct fw_header);\n\n\t\t\t\tbootloaderoffset = (u8 *)(fw->data +\n\t\t\t\t\tsizeof(struct fw_header));\n\n\t\t\t\tdprintk(DBGLVL_FW, \"bootloader d/l starts.\\n\");\n\t\t\t\tprintk(KERN_INFO \"%s() FirmwareSize = 0x%x\\n\",\n\t\t\t\t\t__func__, boothdr->firmwaresize);\n\t\t\t\tprintk(KERN_INFO \"%s() BSLSize = 0x%x\\n\",\n\t\t\t\t\t__func__, boothdr->bslsize);\n\t\t\t\tprintk(KERN_INFO \"%s() Reserved = 0x%x\\n\",\n\t\t\t\t\t__func__, boothdr->reserved);\n\t\t\t\tprintk(KERN_INFO \"%s() Version = 0x%x\\n\",\n\t\t\t\t\t__func__, boothdr->version);\n\t\t\t\tret = saa7164_downloadimage(\n\t\t\t\t\tdev,\n\t\t\t\t\tbootloaderoffset,\n\t\t\t\t\tbootloadersize,\n\t\t\t\t\tSAA_DOWNLOAD_FLAGS,\n\t\t\t\t\tdev->bmmio + SAA_DEVICE_DOWNLOAD_OFFSET,\n\t\t\t\t\tSAA_DEVICE_BUFFERBLOCKSIZE);\n\t\t\t\tif (ret < 0) {\n\t\t\t\t\tprintk(KERN_ERR\n\t\t\t\t\t\t\"bootloader d/l has failed\\n\");\n\t\t\t\t\tgoto out;\n\t\t\t\t}\n\t\t\t\tdprintk(DBGLVL_FW,\n\t\t\t\t\t\"bootloader download complete.\\n\");\n\n\t\t\t}\n\n\t\t\tprintk(KERN_ERR \"starting firmware download(2)\\n\");\n\t\t\tbootloadersize = (boothdr->firmwaresize +\n\t\t\t\tboothdr->bslsize) * 16 +\n\t\t\t\tsizeof(struct fw_header);\n\n\t\t\tbootloaderoffset =\n\t\t\t\t(u8 *)(fw->data + sizeof(struct fw_header));\n\n\t\t\tfwloaderoffset = bootloaderoffset + bootloadersize;\n\n\t\t\t \n\t\t\tfwloadersize = (fwhdr->firmwaresize + fwhdr->bslsize) *\n\t\t\t\t16 + sizeof(struct fw_header);\n\n\t\t\tret = saa7164_downloadimage(\n\t\t\t\tdev,\n\t\t\t\tfwloaderoffset,\n\t\t\t\tfwloadersize,\n\t\t\t\tSAA_DEVICE_2ND_DOWNLOADFLAG_OFFSET,\n\t\t\t\tdev->bmmio + SAA_DEVICE_2ND_DOWNLOAD_OFFSET,\n\t\t\t\tSAA_DEVICE_2ND_BUFFERBLOCKSIZE);\n\t\t\tif (ret < 0) {\n\t\t\t\tprintk(KERN_ERR \"firmware download failed\\n\");\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t\tprintk(KERN_ERR \"firmware download complete.\\n\");\n\n\t\t} else {\n\n\t\t\t \n\t\t\tprintk(KERN_ERR \"starting firmware download(3)\\n\");\n\n\t\t\tret = saa7164_downloadimage(\n\t\t\t\tdev,\n\t\t\t\t(u8 *)fw->data,\n\t\t\t\tfw->size,\n\t\t\t\tSAA_DOWNLOAD_FLAGS,\n\t\t\t\tdev->bmmio + SAA_DEVICE_DOWNLOAD_OFFSET,\n\t\t\t\tSAA_DEVICE_BUFFERBLOCKSIZE);\n\t\t\tif (ret < 0) {\n\t\t\t\tprintk(KERN_ERR \"firmware download failed\\n\");\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t\tprintk(KERN_ERR \"firmware download complete.\\n\");\n\t\t}\n\t}\n\n\tdev->firmwareloaded = 1;\n\tret = 0;\n\nout:\n\trelease_firmware(fw);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}