{
  "module_name": "tw686x.h",
  "hash_id": "6d00b90386dd1c9b1609162279968566c7c44bc67432135113ead50b609ff0d7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/tw686x/tw686x.h",
  "human_readable_source": " \n \n\n#include <linux/mutex.h>\n#include <linux/pci.h>\n#include <linux/timer.h>\n#include <linux/videodev2.h>\n#include <media/v4l2-common.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ioctl.h>\n#include <media/videobuf2-v4l2.h>\n#include <sound/pcm.h>\n\n#include \"tw686x-regs.h\"\n\n#define TYPE_MAX_CHANNELS\t0x0f\n#define TYPE_SECOND_GEN\t\t0x10\n#define TW686X_DEF_PHASE_REF\t0x1518\n\n#define TW686X_AUDIO_PAGE_MAX\t\t16\n#define TW686X_AUDIO_PERIODS_MIN\t2\n#define TW686X_AUDIO_PERIODS_MAX\tTW686X_AUDIO_PAGE_MAX\n\n#define TW686X_DMA_MODE_MEMCPY\t\t0\n#define TW686X_DMA_MODE_CONTIG\t\t1\n#define TW686X_DMA_MODE_SG\t\t2\n\nstruct tw686x_format {\n\tchar *name;\n\tunsigned int fourcc;\n\tunsigned int depth;\n\tunsigned int mode;\n};\n\nstruct tw686x_dma_desc {\n\tdma_addr_t phys;\n\tvoid *virt;\n\tunsigned int size;\n};\n\nstruct tw686x_sg_desc {\n\t \n\t__le32 flags_length;\n\t__le32 phys;\n};\n\nstruct tw686x_audio_buf {\n\tdma_addr_t dma;\n\tvoid *virt;\n\tstruct list_head list;\n};\n\nstruct tw686x_v4l2_buf {\n\tstruct vb2_v4l2_buffer vb;\n\tstruct list_head list;\n};\n\nstruct tw686x_audio_channel {\n\tstruct tw686x_dev *dev;\n\tstruct snd_pcm_substream *ss;\n\tunsigned int ch;\n\tstruct tw686x_audio_buf *curr_bufs[2];\n\tstruct tw686x_dma_desc dma_descs[2];\n\tdma_addr_t ptr;\n\n\tstruct tw686x_audio_buf buf[TW686X_AUDIO_PAGE_MAX];\n\tstruct list_head buf_list;\n\tspinlock_t lock;\n};\n\nstruct tw686x_video_channel {\n\tstruct tw686x_dev *dev;\n\n\tstruct vb2_queue vidq;\n\tstruct list_head vidq_queued;\n\tstruct video_device *device;\n\tstruct tw686x_v4l2_buf *curr_bufs[2];\n\tstruct tw686x_dma_desc dma_descs[2];\n\tstruct tw686x_sg_desc *sg_descs[2];\n\n\tstruct v4l2_ctrl_handler ctrl_handler;\n\tconst struct tw686x_format *format;\n\tstruct mutex vb_mutex;\n\tspinlock_t qlock;\n\tv4l2_std_id video_standard;\n\tunsigned int width, height;\n\tunsigned int h_halve, v_halve;\n\tunsigned int ch;\n\tunsigned int num;\n\tunsigned int fps;\n\tunsigned int input;\n\tunsigned int sequence;\n\tunsigned int pb;\n\tbool no_signal;\n};\n\nstruct tw686x_dma_ops {\n\tint (*setup)(struct tw686x_dev *dev);\n\tint (*alloc)(struct tw686x_video_channel *vc, unsigned int pb);\n\tvoid (*free)(struct tw686x_video_channel *vc, unsigned int pb);\n\tvoid (*buf_refill)(struct tw686x_video_channel *vc, unsigned int pb);\n\tconst struct vb2_mem_ops *mem_ops;\n\tenum v4l2_field field;\n\tu32 hw_dma_mode;\n};\n\n \nstruct tw686x_dev {\n\t \n\tspinlock_t lock;\n\n\tstruct v4l2_device v4l2_dev;\n\tstruct snd_card *snd_card;\n\n\tchar name[32];\n\tunsigned int type;\n\tunsigned int dma_mode;\n\tstruct pci_dev *pci_dev;\n\t__u32 __iomem *mmio;\n\n\tconst struct tw686x_dma_ops *dma_ops;\n\tstruct tw686x_video_channel *video_channels;\n\tstruct tw686x_audio_channel *audio_channels;\n\n\t \n\tint audio_rate;\n\tint period_size;\n\tint audio_enabled;\n\n\tstruct timer_list dma_delay_timer;\n\tu32 pending_dma_en;  \n\tu32 pending_dma_cmd;  \n};\n\nstatic inline uint32_t reg_read(struct tw686x_dev *dev, unsigned int reg)\n{\n\treturn readl(dev->mmio + reg);\n}\n\nstatic inline void reg_write(struct tw686x_dev *dev, unsigned int reg,\n\t\t\t     uint32_t value)\n{\n\twritel(value, dev->mmio + reg);\n}\n\nstatic inline unsigned int max_channels(struct tw686x_dev *dev)\n{\n\treturn dev->type & TYPE_MAX_CHANNELS;  \n}\n\nstatic inline unsigned is_second_gen(struct tw686x_dev *dev)\n{\n\t \n\treturn dev->type & TYPE_SECOND_GEN;\n}\n\nvoid tw686x_enable_channel(struct tw686x_dev *dev, unsigned int channel);\nvoid tw686x_disable_channel(struct tw686x_dev *dev, unsigned int channel);\n\nint tw686x_video_init(struct tw686x_dev *dev);\nvoid tw686x_video_free(struct tw686x_dev *dev);\nvoid tw686x_video_irq(struct tw686x_dev *dev, unsigned long requests,\n\t\t      unsigned int pb_status, unsigned int fifo_status,\n\t\t      unsigned int *reset_ch);\n\nint tw686x_audio_init(struct tw686x_dev *dev);\nvoid tw686x_audio_free(struct tw686x_dev *dev);\nvoid tw686x_audio_irq(struct tw686x_dev *dev, unsigned long requests,\n\t\t      unsigned int pb_status);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}