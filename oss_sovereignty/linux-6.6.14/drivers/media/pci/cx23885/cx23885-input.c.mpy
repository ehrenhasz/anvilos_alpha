{
  "module_name": "cx23885-input.c",
  "hash_id": "6b3f61cdb9ac685ffdb771e31272267908dfb23232f89780ba9c1f323722f082",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/cx23885/cx23885-input.c",
  "human_readable_source": "\n \n\n#include \"cx23885.h\"\n#include \"cx23885-input.h\"\n\n#include <linux/slab.h>\n#include <media/rc-core.h>\n#include <media/v4l2-subdev.h>\n\n#define MODULE_NAME \"cx23885\"\n\nstatic void cx23885_input_process_measurements(struct cx23885_dev *dev,\n\t\t\t\t\t       bool overrun)\n{\n\tstruct cx23885_kernel_ir *kernel_ir = dev->kernel_ir;\n\n\tssize_t num;\n\tint count, i;\n\tbool handle = false;\n\tstruct ir_raw_event ir_core_event[64];\n\n\tdo {\n\t\tnum = 0;\n\t\tv4l2_subdev_call(dev->sd_ir, ir, rx_read, (u8 *) ir_core_event,\n\t\t\t\t sizeof(ir_core_event), &num);\n\n\t\tcount = num / sizeof(struct ir_raw_event);\n\n\t\tfor (i = 0; i < count; i++) {\n\t\t\tir_raw_event_store(kernel_ir->rc,\n\t\t\t\t\t   &ir_core_event[i]);\n\t\t\thandle = true;\n\t\t}\n\t} while (num != 0);\n\n\tif (overrun)\n\t\tir_raw_event_overflow(kernel_ir->rc);\n\telse if (handle)\n\t\tir_raw_event_handle(kernel_ir->rc);\n}\n\nvoid cx23885_input_rx_work_handler(struct cx23885_dev *dev, u32 events)\n{\n\tstruct v4l2_subdev_ir_parameters params;\n\tint overrun, data_available;\n\n\tif (dev->sd_ir == NULL || events == 0)\n\t\treturn;\n\n\tswitch (dev->board) {\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1270:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1850:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1290:\n\tcase CX23885_BOARD_TERRATEC_CINERGY_T_PCIE_DUAL:\n\tcase CX23885_BOARD_TEVII_S470:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1250:\n\tcase CX23885_BOARD_MYGICA_X8507:\n\tcase CX23885_BOARD_TBS_6980:\n\tcase CX23885_BOARD_TBS_6981:\n\tcase CX23885_BOARD_DVBSKY_T9580:\n\tcase CX23885_BOARD_DVBSKY_T980C:\n\tcase CX23885_BOARD_DVBSKY_S950C:\n\tcase CX23885_BOARD_TT_CT2_4500_CI:\n\tcase CX23885_BOARD_DVBSKY_S950:\n\tcase CX23885_BOARD_DVBSKY_S952:\n\tcase CX23885_BOARD_DVBSKY_T982:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1265_K4:\n\t\t \n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\toverrun = events & (V4L2_SUBDEV_IR_RX_SW_FIFO_OVERRUN |\n\t\t\t    V4L2_SUBDEV_IR_RX_HW_FIFO_OVERRUN);\n\n\tdata_available = events & (V4L2_SUBDEV_IR_RX_END_OF_RX_DETECTED |\n\t\t\t\t   V4L2_SUBDEV_IR_RX_FIFO_SERVICE_REQ);\n\n\tif (overrun) {\n\t\t \n\t\tv4l2_subdev_call(dev->sd_ir, ir, rx_g_parameters, &params);\n\t\tparams.enable = false;\n\t\t \n\t\tparams.shutdown = atomic_read(&dev->ir_input_stopping);\n\t\tv4l2_subdev_call(dev->sd_ir, ir, rx_s_parameters, &params);\n\t}\n\n\tif (data_available)\n\t\tcx23885_input_process_measurements(dev, overrun);\n\n\tif (overrun) {\n\t\t \n\t\tparams.enable = true;\n\t\t \n\t\tparams.shutdown = atomic_read(&dev->ir_input_stopping);\n\t\tv4l2_subdev_call(dev->sd_ir, ir, rx_s_parameters, &params);\n\t}\n}\n\nstatic int cx23885_input_ir_start(struct cx23885_dev *dev)\n{\n\tstruct v4l2_subdev_ir_parameters params;\n\n\tif (dev->sd_ir == NULL)\n\t\treturn -ENODEV;\n\n\tatomic_set(&dev->ir_input_stopping, 0);\n\n\tv4l2_subdev_call(dev->sd_ir, ir, rx_g_parameters, &params);\n\tswitch (dev->board) {\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1270:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1850:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1290:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1250:\n\tcase CX23885_BOARD_MYGICA_X8507:\n\tcase CX23885_BOARD_DVBSKY_T9580:\n\tcase CX23885_BOARD_DVBSKY_T980C:\n\tcase CX23885_BOARD_DVBSKY_S950C:\n\tcase CX23885_BOARD_TT_CT2_4500_CI:\n\tcase CX23885_BOARD_DVBSKY_S950:\n\tcase CX23885_BOARD_DVBSKY_S952:\n\tcase CX23885_BOARD_DVBSKY_T982:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1265_K4:\n\t\t \n\t\tparams.mode = V4L2_SUBDEV_IR_MODE_PULSE_WIDTH;\n\t\tparams.enable = true;\n\t\tparams.interrupt_enable = true;\n\t\tparams.shutdown = false;\n\n\t\t \n\t\tparams.modulation = false;\n\t\t \n\t\t \n\t\tparams.max_pulse_width = 3333333;  \n\t\t \n\t\t \n\t\tparams.noise_filter_min_width = 333333;  \n\t\t \n\t\tparams.invert_level = true;\n\t\tbreak;\n\tcase CX23885_BOARD_TERRATEC_CINERGY_T_PCIE_DUAL:\n\tcase CX23885_BOARD_TEVII_S470:\n\tcase CX23885_BOARD_TBS_6980:\n\tcase CX23885_BOARD_TBS_6981:\n\t\t \n\t\tparams.mode = V4L2_SUBDEV_IR_MODE_PULSE_WIDTH;\n\t\tparams.enable = true;\n\t\tparams.interrupt_enable = true;\n\t\tparams.shutdown = false;\n\n\t\t \n\t\tparams.carrier_freq = 37917;  \n\t\tparams.carrier_range_lower = 33000;  \n\t\tparams.carrier_range_upper = 43000;  \n\t\tparams.duty_cycle = 33;  \n\n\t\t \n\t\tparams.max_pulse_width = 12378022;  \n\n\t\t \n\t\tparams.noise_filter_min_width = 351648;  \n\n\t\tparams.modulation = false;\n\t\tparams.invert_level = true;\n\t\tbreak;\n\t}\n\tv4l2_subdev_call(dev->sd_ir, ir, rx_s_parameters, &params);\n\treturn 0;\n}\n\nstatic int cx23885_input_ir_open(struct rc_dev *rc)\n{\n\tstruct cx23885_kernel_ir *kernel_ir = rc->priv;\n\n\tif (kernel_ir->cx == NULL)\n\t\treturn -ENODEV;\n\n\treturn cx23885_input_ir_start(kernel_ir->cx);\n}\n\nstatic void cx23885_input_ir_stop(struct cx23885_dev *dev)\n{\n\tstruct v4l2_subdev_ir_parameters params;\n\n\tif (dev->sd_ir == NULL)\n\t\treturn;\n\n\t \n\tatomic_set(&dev->ir_input_stopping, 1);\n\tv4l2_subdev_call(dev->sd_ir, ir, rx_g_parameters, &params);\n\twhile (params.shutdown == false) {\n\t\tparams.enable = false;\n\t\tparams.interrupt_enable = false;\n\t\tparams.shutdown = true;\n\t\tv4l2_subdev_call(dev->sd_ir, ir, rx_s_parameters, &params);\n\t\tv4l2_subdev_call(dev->sd_ir, ir, rx_g_parameters, &params);\n\t}\n\tflush_work(&dev->cx25840_work);\n\tflush_work(&dev->ir_rx_work);\n\tflush_work(&dev->ir_tx_work);\n}\n\nstatic void cx23885_input_ir_close(struct rc_dev *rc)\n{\n\tstruct cx23885_kernel_ir *kernel_ir = rc->priv;\n\n\tif (kernel_ir->cx != NULL)\n\t\tcx23885_input_ir_stop(kernel_ir->cx);\n}\n\nint cx23885_input_init(struct cx23885_dev *dev)\n{\n\tstruct cx23885_kernel_ir *kernel_ir;\n\tstruct rc_dev *rc;\n\tchar *rc_map;\n\tu64 allowed_protos;\n\n\tint ret;\n\n\t \n\tif (dev->sd_ir == NULL)\n\t\treturn -ENODEV;\n\n\tswitch (dev->board) {\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1270:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1850:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1290:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1250:\n\tcase CX23885_BOARD_HAUPPAUGE_HVR1265_K4:\n\t\t \n\t\tallowed_protos = RC_PROTO_BIT_ALL_IR_DECODER;\n\t\t \n\t\trc_map = RC_MAP_HAUPPAUGE;\n\t\tbreak;\n\tcase CX23885_BOARD_TERRATEC_CINERGY_T_PCIE_DUAL:\n\t\t \n\t\tallowed_protos = RC_PROTO_BIT_ALL_IR_DECODER;\n\t\t \n\t\trc_map = RC_MAP_NEC_TERRATEC_CINERGY_XS;\n\t\tbreak;\n\tcase CX23885_BOARD_TEVII_S470:\n\t\t \n\t\tallowed_protos = RC_PROTO_BIT_ALL_IR_DECODER;\n\t\t \n\t\trc_map = RC_MAP_TEVII_NEC;\n\t\tbreak;\n\tcase CX23885_BOARD_MYGICA_X8507:\n\t\t \n\t\tallowed_protos = RC_PROTO_BIT_ALL_IR_DECODER;\n\t\t \n\t\trc_map = RC_MAP_TOTAL_MEDIA_IN_HAND_02;\n\t\tbreak;\n\tcase CX23885_BOARD_TBS_6980:\n\tcase CX23885_BOARD_TBS_6981:\n\t\t \n\t\tallowed_protos = RC_PROTO_BIT_ALL_IR_DECODER;\n\t\t \n\t\trc_map = RC_MAP_TBS_NEC;\n\t\tbreak;\n\tcase CX23885_BOARD_DVBSKY_T9580:\n\tcase CX23885_BOARD_DVBSKY_T980C:\n\tcase CX23885_BOARD_DVBSKY_S950C:\n\tcase CX23885_BOARD_DVBSKY_S950:\n\tcase CX23885_BOARD_DVBSKY_S952:\n\tcase CX23885_BOARD_DVBSKY_T982:\n\t\t \n\t\tallowed_protos = RC_PROTO_BIT_ALL_IR_DECODER;\n\t\trc_map = RC_MAP_DVBSKY;\n\t\tbreak;\n\tcase CX23885_BOARD_TT_CT2_4500_CI:\n\t\t \n\t\tallowed_protos = RC_PROTO_BIT_ALL_IR_DECODER;\n\t\trc_map = RC_MAP_TT_1500;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tkernel_ir = kzalloc(sizeof(struct cx23885_kernel_ir), GFP_KERNEL);\n\tif (kernel_ir == NULL)\n\t\treturn -ENOMEM;\n\n\tkernel_ir->cx = dev;\n\tkernel_ir->name = kasprintf(GFP_KERNEL, \"cx23885 IR (%s)\",\n\t\t\t\t    cx23885_boards[dev->board].name);\n\tif (!kernel_ir->name) {\n\t\tret = -ENOMEM;\n\t\tgoto err_out_free;\n\t}\n\n\tkernel_ir->phys = kasprintf(GFP_KERNEL, \"pci-%s/ir0\",\n\t\t\t\t    pci_name(dev->pci));\n\tif (!kernel_ir->phys) {\n\t\tret = -ENOMEM;\n\t\tgoto err_out_free_name;\n\t}\n\n\t \n\trc = rc_allocate_device(RC_DRIVER_IR_RAW);\n\tif (!rc) {\n\t\tret = -ENOMEM;\n\t\tgoto err_out_free_phys;\n\t}\n\n\tkernel_ir->rc = rc;\n\trc->device_name = kernel_ir->name;\n\trc->input_phys = kernel_ir->phys;\n\trc->input_id.bustype = BUS_PCI;\n\trc->input_id.version = 1;\n\tif (dev->pci->subsystem_vendor) {\n\t\trc->input_id.vendor  = dev->pci->subsystem_vendor;\n\t\trc->input_id.product = dev->pci->subsystem_device;\n\t} else {\n\t\trc->input_id.vendor  = dev->pci->vendor;\n\t\trc->input_id.product = dev->pci->device;\n\t}\n\trc->dev.parent = &dev->pci->dev;\n\trc->allowed_protocols = allowed_protos;\n\trc->priv = kernel_ir;\n\trc->open = cx23885_input_ir_open;\n\trc->close = cx23885_input_ir_close;\n\trc->map_name = rc_map;\n\trc->driver_name = MODULE_NAME;\n\n\t \n\tdev->kernel_ir = kernel_ir;\n\tret = rc_register_device(rc);\n\tif (ret)\n\t\tgoto err_out_stop;\n\n\treturn 0;\n\nerr_out_stop:\n\tcx23885_input_ir_stop(dev);\n\tdev->kernel_ir = NULL;\n\trc_free_device(rc);\nerr_out_free_phys:\n\tkfree(kernel_ir->phys);\nerr_out_free_name:\n\tkfree(kernel_ir->name);\nerr_out_free:\n\tkfree(kernel_ir);\n\treturn ret;\n}\n\nvoid cx23885_input_fini(struct cx23885_dev *dev)\n{\n\t \n\tcx23885_input_ir_stop(dev);\n\n\tif (dev->kernel_ir == NULL)\n\t\treturn;\n\trc_unregister_device(dev->kernel_ir->rc);\n\tkfree(dev->kernel_ir->phys);\n\tkfree(dev->kernel_ir->name);\n\tkfree(dev->kernel_ir);\n\tdev->kernel_ir = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}