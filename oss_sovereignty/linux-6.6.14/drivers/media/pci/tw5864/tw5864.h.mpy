{
  "module_name": "tw5864.h",
  "hash_id": "a8ca32bea3888d16b8932797d5a1a978d517674320a7d5b6dddca40bc632c660",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/tw5864/tw5864.h",
  "human_readable_source": " \n \n\n#include <linux/pci.h>\n#include <linux/videodev2.h>\n#include <linux/notifier.h>\n#include <linux/delay.h>\n#include <linux/mutex.h>\n#include <linux/io.h>\n#include <linux/interrupt.h>\n\n#include <media/v4l2-common.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-device.h>\n#include <media/videobuf2-dma-sg.h>\n\n#include \"tw5864-reg.h\"\n\n#define PCI_DEVICE_ID_TECHWELL_5864 0x5864\n\n#define TW5864_NORMS V4L2_STD_ALL\n\n \n \n\n#define TW5864_INPUTS 4\n\n \n#define MD_CELLS_HOR 16\n#define MD_CELLS_VERT 12\n#define MD_CELLS (MD_CELLS_HOR * MD_CELLS_VERT)\n\n#define H264_VLC_BUF_SIZE 0x80000\n#define H264_MV_BUF_SIZE 0x2000  \n#define QP_VALUE 28\n#define MAX_GOP_SIZE 255\n#define GOP_SIZE MAX_GOP_SIZE\n\nenum resolution {\n\tD1 = 1,\n\tHD1 = 2,  \n\tCIF = 3,\n\tQCIF = 4,\n};\n\n \n \n\nstruct tw5864_dev;  \n\n \nstruct tw5864_buf {\n\tstruct vb2_v4l2_buffer vb;\n\tstruct list_head list;\n\n\tunsigned int size;\n};\n\nstruct tw5864_dma_buf {\n\tvoid *addr;\n\tdma_addr_t dma_addr;\n};\n\nenum tw5864_vid_std {\n\tSTD_NTSC = 0,  \n\tSTD_PAL = 1,  \n\tSTD_SECAM = 2,  \n\tSTD_NTSC443 = 3,  \n\tSTD_PAL_M = 4,  \n\tSTD_PAL_CN = 5,  \n\tSTD_PAL_60 = 6,  \n\tSTD_INVALID = 7,\n\tSTD_AUTO = 7,\n};\n\nstruct tw5864_input {\n\tint nr;  \n\tstruct tw5864_dev *root;\n\tstruct mutex lock;  \n\tspinlock_t slock;  \n\tstruct video_device vdev;\n\tstruct v4l2_ctrl_handler hdl;\n\tstruct vb2_queue vidq;\n\tstruct list_head active;\n\tenum resolution resolution;\n\tunsigned int width, height;\n\tunsigned int frame_seqno;\n\tunsigned int frame_gop_seqno;\n\tunsigned int h264_idr_pic_id;\n\tint enabled;\n\tenum tw5864_vid_std std;\n\tv4l2_std_id v4l2_std;\n\tint tail_nb_bits;\n\tu8 tail;\n\tu8 *buf_cur_ptr;\n\tint buf_cur_space_left;\n\n\tu32 reg_interlacing;\n\tu32 reg_vlc;\n\tu32 reg_dsp_codec;\n\tu32 reg_dsp;\n\tu32 reg_emu;\n\tu32 reg_dsp_qp;\n\tu32 reg_dsp_ref_mvp_lambda;\n\tu32 reg_dsp_i4x4_weight;\n\tu32 buf_id;\n\n\tstruct tw5864_buf *vb;\n\n\tstruct v4l2_ctrl *md_threshold_grid_ctrl;\n\tu16 md_threshold_grid_values[12 * 16];\n\tint qp;\n\tint gop;\n\n\t \n\tint frame_interval;\n\tunsigned long new_frame_deadline;\n};\n\nstruct tw5864_h264_frame {\n\tstruct tw5864_dma_buf vlc;\n\tstruct tw5864_dma_buf mv;\n\tint vlc_len;\n\tu32 checksum;\n\tstruct tw5864_input *input;\n\tu64 timestamp;\n\tunsigned int seqno;\n\tunsigned int gop_seqno;\n};\n\n \nstruct tw5864_dev {\n\tspinlock_t slock;  \n\tstruct v4l2_device v4l2_dev;\n\tstruct tw5864_input inputs[TW5864_INPUTS];\n#define H264_BUF_CNT 4\n\tstruct tw5864_h264_frame h264_buf[H264_BUF_CNT];\n\tint h264_buf_r_index;\n\tint h264_buf_w_index;\n\n\tstruct tasklet_struct tasklet;\n\n\tint encoder_busy;\n\t \n\tint next_input;\n\n\t \n\tchar name[64];\n\tstruct pci_dev *pci;\n\tvoid __iomem *mmio;\n\tu32 irqmask;\n};\n\n#define tw_readl(reg) readl(dev->mmio + reg)\n#define tw_mask_readl(reg, mask) \\\n\t(tw_readl(reg) & (mask))\n#define tw_mask_shift_readl(reg, mask, shift) \\\n\t(tw_mask_readl((reg), ((mask) << (shift))) >> (shift))\n\n#define tw_writel(reg, value) writel((value), dev->mmio + reg)\n#define tw_mask_writel(reg, mask, value) \\\n\ttw_writel(reg, (tw_readl(reg) & ~(mask)) | ((value) & (mask)))\n#define tw_mask_shift_writel(reg, mask, shift, value) \\\n\ttw_mask_writel((reg), ((mask) << (shift)), ((value) << (shift)))\n\n#define tw_setl(reg, bit) tw_writel((reg), tw_readl(reg) | (bit))\n#define tw_clearl(reg, bit) tw_writel((reg), tw_readl(reg) & ~(bit))\n\nu8 tw5864_indir_readb(struct tw5864_dev *dev, u16 addr);\n#define tw_indir_readb(addr) tw5864_indir_readb(dev, addr)\nvoid tw5864_indir_writeb(struct tw5864_dev *dev, u16 addr, u8 data);\n#define tw_indir_writeb(addr, data) tw5864_indir_writeb(dev, addr, data)\n\nvoid tw5864_irqmask_apply(struct tw5864_dev *dev);\nint tw5864_video_init(struct tw5864_dev *dev, int *video_nr);\nvoid tw5864_video_fini(struct tw5864_dev *dev);\nvoid tw5864_prepare_frame_headers(struct tw5864_input *input);\nvoid tw5864_h264_put_stream_header(u8 **buf, size_t *space_left, int qp,\n\t\t\t\t   int width, int height);\nvoid tw5864_h264_put_slice_header(u8 **buf, size_t *space_left,\n\t\t\t\t  unsigned int idr_pic_id,\n\t\t\t\t  unsigned int frame_gop_seqno,\n\t\t\t\t  int *tail_nb_bits, u8 *tail);\nvoid tw5864_request_encoded_frame(struct tw5864_input *input);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}