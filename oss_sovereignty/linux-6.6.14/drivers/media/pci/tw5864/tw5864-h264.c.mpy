{
  "module_name": "tw5864-h264.c",
  "hash_id": "a9130896b50cbb29ac0d7e99ab1af6efc1189b60adb85ea4522939c60bddb355",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/tw5864/tw5864-h264.c",
  "human_readable_source": "\n \n\n#include <linux/log2.h>\n\n#include \"tw5864.h\"\n\nstatic u8 marker[] = { 0x00, 0x00, 0x00, 0x01 };\n\n \n\n \nstruct bs {\n\tu8 *buf;  \n\tu8 *buf_end;  \n\tu8 *ptr;  \n\tunsigned int bits_left;  \n};\n\nstatic void bs_init(struct bs *s, void *buf, int size)\n{\n\ts->buf = buf;\n\ts->ptr = buf;\n\ts->buf_end = s->ptr + size;\n\ts->bits_left = 8;\n}\n\nstatic int bs_len(struct bs *s)\n{\n\treturn s->ptr - s->buf;\n}\n\nstatic void bs_write(struct bs *s, int count, u32 bits)\n{\n\tif (s->ptr >= s->buf_end - 4)\n\t\treturn;\n\twhile (count > 0) {\n\t\tif (count < 32)\n\t\t\tbits &= (1 << count) - 1;\n\t\tif (count < s->bits_left) {\n\t\t\t*s->ptr = (*s->ptr << count) | bits;\n\t\t\ts->bits_left -= count;\n\t\t\tbreak;\n\t\t}\n\t\t*s->ptr = (*s->ptr << s->bits_left) |\n\t\t\t(bits >> (count - s->bits_left));\n\t\tcount -= s->bits_left;\n\t\ts->ptr++;\n\t\ts->bits_left = 8;\n\t}\n}\n\nstatic void bs_write1(struct bs *s, u32 bit)\n{\n\tif (s->ptr < s->buf_end) {\n\t\t*s->ptr <<= 1;\n\t\t*s->ptr |= bit;\n\t\ts->bits_left--;\n\t\tif (s->bits_left == 0) {\n\t\t\ts->ptr++;\n\t\t\ts->bits_left = 8;\n\t\t}\n\t}\n}\n\nstatic void bs_write_ue(struct bs *s, u32 val)\n{\n\tif (val == 0) {\n\t\tbs_write1(s, 1);\n\t} else {\n\t\tval++;\n\t\tbs_write(s, 2 * fls(val) - 1, val);\n\t}\n}\n\nstatic void bs_write_se(struct bs *s, int val)\n{\n\tbs_write_ue(s, val <= 0 ? -val * 2 : val * 2 - 1);\n}\n\nstatic void bs_rbsp_trailing(struct bs *s)\n{\n\tbs_write1(s, 1);\n\tif (s->bits_left != 8)\n\t\tbs_write(s, s->bits_left, 0x00);\n}\n\n \n\nstatic int tw5864_h264_gen_sps_rbsp(u8 *buf, size_t size, int width, int height)\n{\n\tstruct bs bs, *s;\n\n\ts = &bs;\n\tbs_init(s, buf, size);\n\tbs_write(s, 8, 0x42);  \n\tbs_write(s, 1, 1);  \n\tbs_write(s, 1, 1);  \n\tbs_write(s, 1, 0);  \n\tbs_write(s, 5, 0);  \n\tbs_write(s, 8, 0x1e);  \n\tbs_write_ue(s, 0);  \n\tbs_write_ue(s, ilog2(MAX_GOP_SIZE) - 4);  \n\tbs_write_ue(s, 0);  \n\t \n\tbs_write_ue(s, ilog2(MAX_GOP_SIZE) - 4);\n\tbs_write_ue(s, 1);  \n\tbs_write(s, 1, 0);  \n\tbs_write_ue(s, width / 16 - 1);  \n\tbs_write_ue(s, height / 16 - 1);  \n\tbs_write(s, 1, 1);  \n\tbs_write(s, 1, 0);  \n\tbs_write(s, 1, 0);  \n\tbs_write(s, 1, 0);  \n\tbs_rbsp_trailing(s);\n\treturn bs_len(s);\n}\n\nstatic int tw5864_h264_gen_pps_rbsp(u8 *buf, size_t size, int qp)\n{\n\tstruct bs bs, *s;\n\n\ts = &bs;\n\tbs_init(s, buf, size);\n\tbs_write_ue(s, 0);  \n\tbs_write_ue(s, 0);  \n\tbs_write(s, 1, 0);  \n\tbs_write(s, 1, 0);  \n\tbs_write_ue(s, 0);  \n\tbs_write_ue(s, 0);  \n\tbs_write_ue(s, 0);  \n\tbs_write(s, 1, 0);  \n\tbs_write(s, 2, 0);  \n\tbs_write_se(s, qp - 26);  \n\tbs_write_se(s, qp - 26);  \n\tbs_write_se(s, 0);  \n\tbs_write(s, 1, 0);  \n\tbs_write(s, 1, 0);  \n\tbs_write(s, 1, 0);  \n\tbs_rbsp_trailing(s);\n\treturn bs_len(s);\n}\n\nstatic int tw5864_h264_gen_slice_head(u8 *buf, size_t size,\n\t\t\t\t      unsigned int idr_pic_id,\n\t\t\t\t      unsigned int frame_gop_seqno,\n\t\t\t\t      int *tail_nb_bits, u8 *tail)\n{\n\tstruct bs bs, *s;\n\tint is_i_frame = frame_gop_seqno == 0;\n\n\ts = &bs;\n\tbs_init(s, buf, size);\n\tbs_write_ue(s, 0);  \n\tbs_write_ue(s, is_i_frame ? 2 : 5);  \n\tbs_write_ue(s, 0);  \n\tbs_write(s, ilog2(MAX_GOP_SIZE), frame_gop_seqno);  \n\tif (is_i_frame)\n\t\tbs_write_ue(s, idr_pic_id);\n\n\t \n\tbs_write(s, ilog2(MAX_GOP_SIZE), frame_gop_seqno);\n\n\tif (is_i_frame) {\n\t\tbs_write1(s, 0);  \n\t\tbs_write1(s, 0);  \n\t} else {\n\t\tbs_write1(s, 0);  \n\t\tbs_write1(s, 0);  \n\t\tbs_write1(s, 0);  \n\t}\n\n\tbs_write_se(s, 0);  \n\n\tif (s->bits_left != 8) {\n\t\t*tail = ((s->ptr[0]) << s->bits_left);\n\t\t*tail_nb_bits = 8 - s->bits_left;\n\t} else {\n\t\t*tail = 0;\n\t\t*tail_nb_bits = 0;\n\t}\n\n\treturn bs_len(s);\n}\n\nvoid tw5864_h264_put_stream_header(u8 **buf, size_t *space_left, int qp,\n\t\t\t\t   int width, int height)\n{\n\tint nal_len;\n\n\t \n\tmemcpy(*buf, marker, sizeof(marker));\n\t*buf += 4;\n\t*space_left -= 4;\n\n\t**buf = 0x67;  \n\t*buf += 1;\n\t*space_left -= 1;\n\n\tnal_len = tw5864_h264_gen_sps_rbsp(*buf, *space_left, width, height);\n\t*buf += nal_len;\n\t*space_left -= nal_len;\n\n\t \n\tmemcpy(*buf, marker, sizeof(marker));\n\t*buf += 4;\n\t*space_left -= 4;\n\n\t**buf = 0x68;  \n\t*buf += 1;\n\t*space_left -= 1;\n\n\tnal_len = tw5864_h264_gen_pps_rbsp(*buf, *space_left, qp);\n\t*buf += nal_len;\n\t*space_left -= nal_len;\n}\n\nvoid tw5864_h264_put_slice_header(u8 **buf, size_t *space_left,\n\t\t\t\t  unsigned int idr_pic_id,\n\t\t\t\t  unsigned int frame_gop_seqno,\n\t\t\t\t  int *tail_nb_bits, u8 *tail)\n{\n\tint nal_len;\n\n\tmemcpy(*buf, marker, sizeof(marker));\n\t*buf += 4;\n\t*space_left -= 4;\n\n\t \n\t**buf = (frame_gop_seqno == 0) ? 0x25 : 0x21;\n\t*buf += 1;\n\t*space_left -= 1;\n\n\tnal_len = tw5864_h264_gen_slice_head(*buf, *space_left, idr_pic_id,\n\t\t\t\t\t     frame_gop_seqno, tail_nb_bits,\n\t\t\t\t\t     tail);\n\t*buf += nal_len;\n\t*space_left -= nal_len;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}