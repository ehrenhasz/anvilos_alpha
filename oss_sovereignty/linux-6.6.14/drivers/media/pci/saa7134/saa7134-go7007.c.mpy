{
  "module_name": "saa7134-go7007.c",
  "hash_id": "ef5055d8a0ba245b57db75763f483c441dcbeaade4d105d9ca6b87b5f3c35d12",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/saa7134/saa7134-go7007.c",
  "human_readable_source": "\n \n\n#include \"saa7134.h\"\n#include \"saa7134-reg.h\"\n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/spinlock.h>\n#include <linux/wait.h>\n#include <linux/list.h>\n#include <linux/slab.h>\n#include <linux/time.h>\n#include <linux/mm.h>\n#include <linux/usb.h>\n#include <linux/i2c.h>\n#include <asm/byteorder.h>\n#include <media/v4l2-common.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-subdev.h>\n\n#include \"go7007-priv.h\"\n\n \n\nenum hpi_address {\n\tHPI_ADDR_VIDEO_BUFFER = 0xe4,\n\tHPI_ADDR_INIT_BUFFER = 0xea,\n\tHPI_ADDR_INTR_RET_VALUE = 0xee,\n\tHPI_ADDR_INTR_RET_DATA = 0xec,\n\tHPI_ADDR_INTR_STATUS = 0xf4,\n\tHPI_ADDR_INTR_WR_PARAM = 0xf6,\n\tHPI_ADDR_INTR_WR_INDEX = 0xf8,\n};\n\nenum gpio_command {\n\tGPIO_COMMAND_RESET = 0x00,  \n\tGPIO_COMMAND_REQ1  = 0x04,  \n\tGPIO_COMMAND_WRITE = 0x20,  \n\tGPIO_COMMAND_REQ2  = 0x24,  \n\tGPIO_COMMAND_READ  = 0x80,  \n\tGPIO_COMMAND_VIDEO = 0x84,  \n\tGPIO_COMMAND_IDLE  = 0xA0,  \n\tGPIO_COMMAND_ADDR  = 0xA4,  \n};\n\nstruct saa7134_go7007 {\n\tstruct v4l2_subdev sd;\n\tstruct saa7134_dev *dev;\n\tu8 *top;\n\tu8 *bottom;\n\tdma_addr_t top_dma;\n\tdma_addr_t bottom_dma;\n};\n\nstatic const struct go7007_board_info board_voyager = {\n\t.flags\t\t = 0,\n\t.sensor_flags\t = GO7007_SENSOR_656 |\n\t\t\t\tGO7007_SENSOR_VALID_ENABLE |\n\t\t\t\tGO7007_SENSOR_TV |\n\t\t\t\tGO7007_SENSOR_VBI,\n\t.audio_flags\t= GO7007_AUDIO_I2S_MODE_1 |\n\t\t\t\tGO7007_AUDIO_WORD_16,\n\t.audio_rate\t = 48000,\n\t.audio_bclk_div\t = 8,\n\t.audio_main_div\t = 2,\n\t.hpi_buffer_cap  = 7,\n\t.num_inputs\t = 1,\n\t.inputs\t\t = {\n\t\t{\n\t\t\t.name\t\t= \"SAA7134\",\n\t\t},\n\t},\n};\n\n \n\nstatic int gpio_write(struct saa7134_dev *dev, u8 addr, u16 data)\n{\n\tsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\n\n\t \n\tsaa_writeb(SAA7134_GPIO_GPSTATUS0, addr);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_ADDR);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\n\n\t \n\tsaa_writeb(SAA7134_GPIO_GPSTATUS0, data & 0xff);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_WRITE);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\n\n\t \n\tsaa_writeb(SAA7134_GPIO_GPSTATUS0, data >> 8);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_WRITE);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\n\n\treturn 0;\n}\n\nstatic int gpio_read(struct saa7134_dev *dev, u8 addr, u16 *data)\n{\n\tsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\n\n\t \n\tsaa_writeb(SAA7134_GPIO_GPSTATUS0, addr);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_ADDR);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\n\n\tsaa_writeb(SAA7134_GPIO_GPMODE0, 0x00);\n\n\t \n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_READ);\n\tsaa_clearb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\n\tsaa_setb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\n\t*data = saa_readb(SAA7134_GPIO_GPSTATUS0);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\n\n\t \n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_READ);\n\tsaa_clearb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\n\tsaa_setb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\n\t*data |= saa_readb(SAA7134_GPIO_GPSTATUS0) << 8;\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\n\n\treturn 0;\n}\n\nstatic int saa7134_go7007_interface_reset(struct go7007 *go)\n{\n\tstruct saa7134_go7007 *saa = go->hpi_context;\n\tstruct saa7134_dev *dev = saa->dev;\n\tu16 intr_val, intr_data;\n\tint count = 20;\n\n\tsaa_clearb(SAA7134_TS_PARALLEL, 0x80);  \n\tsaa_writeb(SAA7134_GPIO_GPMODE2, 0xa4);\n\tsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\n\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ1);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_RESET);\n\tmsleep(1);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ1);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ2);\n\tmsleep(10);\n\n\tsaa_clearb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\n\tsaa_setb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\n\n\tsaa_readb(SAA7134_GPIO_GPSTATUS2);\n\t \n\n\t \n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ1);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ2);\n\n\tdo {\n\t\tsaa_clearb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\n\t\tsaa_setb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\n\t\tsaa_readb(SAA7134_GPIO_GPSTATUS2);\n\t\t \n\t} while (--count > 0);\n\n\t \n\tif (go7007_read_interrupt(go, &intr_val, &intr_data) < 0 ||\n\t\t\t(intr_val & ~0x1) != 0x55aa) {\n\t\tpr_err(\"saa7134-go7007: unable to reset the GO7007\\n\");\n\t\treturn -1;\n\t}\n\treturn 0;\n}\n\nstatic int saa7134_go7007_write_interrupt(struct go7007 *go, int addr, int data)\n{\n\tstruct saa7134_go7007 *saa = go->hpi_context;\n\tstruct saa7134_dev *dev = saa->dev;\n\tint i;\n\tu16 status_reg;\n\n#ifdef GO7007_HPI_DEBUG\n\tpr_debug(\"saa7134-go7007: WriteInterrupt: %04x %04x\\n\", addr, data);\n#endif\n\n\tfor (i = 0; i < 100; ++i) {\n\t\tgpio_read(dev, HPI_ADDR_INTR_STATUS, &status_reg);\n\t\tif (!(status_reg & 0x0010))\n\t\t\tbreak;\n\t\tmsleep(10);\n\t}\n\tif (i == 100) {\n\t\tpr_err(\"saa7134-go7007: device is hung, status reg = 0x%04x\\n\",\n\t\t\tstatus_reg);\n\t\treturn -1;\n\t}\n\tgpio_write(dev, HPI_ADDR_INTR_WR_PARAM, data);\n\tgpio_write(dev, HPI_ADDR_INTR_WR_INDEX, addr);\n\n\treturn 0;\n}\n\nstatic int saa7134_go7007_read_interrupt(struct go7007 *go)\n{\n\tstruct saa7134_go7007 *saa = go->hpi_context;\n\tstruct saa7134_dev *dev = saa->dev;\n\n\t \n\tgo->interrupt_available = 1;\n\tgpio_read(dev, HPI_ADDR_INTR_RET_VALUE, &go->interrupt_value);\n\tgpio_read(dev, HPI_ADDR_INTR_RET_DATA, &go->interrupt_data);\n#ifdef GO7007_HPI_DEBUG\n\tpr_debug(\"saa7134-go7007: ReadInterrupt: %04x %04x\\n\",\n\t\t\tgo->interrupt_value, go->interrupt_data);\n#endif\n\treturn 0;\n}\n\nstatic void saa7134_go7007_irq_ts_done(struct saa7134_dev *dev,\n\t\t\t\t\t\tunsigned long status)\n{\n\tstruct go7007 *go = video_get_drvdata(dev->empress_dev);\n\tstruct saa7134_go7007 *saa = go->hpi_context;\n\n\tif (!vb2_is_streaming(&go->vidq))\n\t\treturn;\n\tif (0 != (status & 0x000f0000))\n\t\tpr_debug(\"saa7134-go7007: irq: lost %ld\\n\",\n\t\t\t\t(status >> 16) & 0x0f);\n\tif (status & 0x100000) {\n\t\tdma_sync_single_for_cpu(&dev->pci->dev,\n\t\t\t\t\tsaa->bottom_dma, PAGE_SIZE, DMA_FROM_DEVICE);\n\t\tgo7007_parse_video_stream(go, saa->bottom, PAGE_SIZE);\n\t\tsaa_writel(SAA7134_RS_BA2(5), saa->bottom_dma);\n\t} else {\n\t\tdma_sync_single_for_cpu(&dev->pci->dev,\n\t\t\t\t\tsaa->top_dma, PAGE_SIZE, DMA_FROM_DEVICE);\n\t\tgo7007_parse_video_stream(go, saa->top, PAGE_SIZE);\n\t\tsaa_writel(SAA7134_RS_BA1(5), saa->top_dma);\n\t}\n}\n\nstatic int saa7134_go7007_stream_start(struct go7007 *go)\n{\n\tstruct saa7134_go7007 *saa = go->hpi_context;\n\tstruct saa7134_dev *dev = saa->dev;\n\n\tsaa->top_dma = dma_map_page(&dev->pci->dev, virt_to_page(saa->top),\n\t\t\t0, PAGE_SIZE, DMA_FROM_DEVICE);\n\tif (dma_mapping_error(&dev->pci->dev, saa->top_dma))\n\t\treturn -ENOMEM;\n\tsaa->bottom_dma = dma_map_page(&dev->pci->dev,\n\t\t\tvirt_to_page(saa->bottom),\n\t\t\t0, PAGE_SIZE, DMA_FROM_DEVICE);\n\tif (dma_mapping_error(&dev->pci->dev, saa->bottom_dma)) {\n\t\tdma_unmap_page(&dev->pci->dev, saa->top_dma, PAGE_SIZE,\n\t\t\t\tDMA_FROM_DEVICE);\n\t\treturn -ENOMEM;\n\t}\n\n\tsaa_writel(SAA7134_VIDEO_PORT_CTRL0 >> 2, 0xA300B000);\n\tsaa_writel(SAA7134_VIDEO_PORT_CTRL4 >> 2, 0x40000200);\n\n\t \n\tsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS0, HPI_ADDR_VIDEO_BUFFER);\n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_ADDR);\n\tsaa_writeb(SAA7134_GPIO_GPMODE0, 0x00);\n\n\t \n\tsaa_writeb(SAA7134_TS_PARALLEL, 0xe6);\n\n\t \n\tsaa_setb(SAA7134_TS_SERIAL1, 0x01);\n\tsaa_clearb(SAA7134_TS_SERIAL1, 0x01);\n\n\t \n\tsaa_writeb(SAA7134_TS_PARALLEL_SERIAL, 128 - 1);\n\tsaa_writeb(SAA7134_TS_DMA0, ((PAGE_SIZE >> 7) - 1) & 0xff);\n\tsaa_writeb(SAA7134_TS_DMA1, (PAGE_SIZE >> 15) & 0xff);\n\tsaa_writeb(SAA7134_TS_DMA2, (PAGE_SIZE >> 31) & 0x3f);\n\n\t \n\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_VIDEO);\n\n\tsaa_writel(SAA7134_RS_BA1(5), saa->top_dma);\n\tsaa_writel(SAA7134_RS_BA2(5), saa->bottom_dma);\n\tsaa_writel(SAA7134_RS_PITCH(5), 128);\n\tsaa_writel(SAA7134_RS_CONTROL(5), SAA7134_RS_CONTROL_BURST_MAX);\n\n\t \n\tsaa_setl(SAA7134_MAIN_CTRL, SAA7134_MAIN_CTRL_TE5);\n\n\t \n\tsaa_setl(SAA7134_IRQ1,\n\t\t\tSAA7134_IRQ1_INTE_RA2_1 | SAA7134_IRQ1_INTE_RA2_0);\n\n\treturn 0;\n}\n\nstatic int saa7134_go7007_stream_stop(struct go7007 *go)\n{\n\tstruct saa7134_go7007 *saa = go->hpi_context;\n\tstruct saa7134_dev *dev;\n\n\tif (!saa)\n\t\treturn -EINVAL;\n\tdev = saa->dev;\n\tif (!dev)\n\t\treturn -EINVAL;\n\n\t \n\tsaa_clearl(SAA7134_MAIN_CTRL, SAA7134_MAIN_CTRL_TE5);\n\n\t \n\tsaa_clearl(SAA7134_IRQ1,\n\t\t\tSAA7134_IRQ1_INTE_RA2_1 | SAA7134_IRQ1_INTE_RA2_0);\n\n\t \n\tsaa_clearb(SAA7134_TS_PARALLEL, 0x80);\n\n\tdma_unmap_page(&dev->pci->dev, saa->top_dma, PAGE_SIZE,\n\t\t\tDMA_FROM_DEVICE);\n\tdma_unmap_page(&dev->pci->dev, saa->bottom_dma, PAGE_SIZE,\n\t\t\tDMA_FROM_DEVICE);\n\n\treturn 0;\n}\n\nstatic int saa7134_go7007_send_firmware(struct go7007 *go, u8 *data, int len)\n{\n\tstruct saa7134_go7007 *saa = go->hpi_context;\n\tstruct saa7134_dev *dev = saa->dev;\n\tu16 status_reg;\n\tint i;\n\n#ifdef GO7007_HPI_DEBUG\n\tpr_debug(\"saa7134-go7007: DownloadBuffer sending %d bytes\\n\", len);\n#endif\n\n\twhile (len > 0) {\n\t\ti = len > 64 ? 64 : len;\n\t\tsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\n\t\tsaa_writeb(SAA7134_GPIO_GPSTATUS0, HPI_ADDR_INIT_BUFFER);\n\t\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_ADDR);\n\t\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\n\t\twhile (i-- > 0) {\n\t\t\tsaa_writeb(SAA7134_GPIO_GPSTATUS0, *data);\n\t\t\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_WRITE);\n\t\t\tsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\n\t\t\t++data;\n\t\t\t--len;\n\t\t}\n\t\tfor (i = 0; i < 100; ++i) {\n\t\t\tgpio_read(dev, HPI_ADDR_INTR_STATUS, &status_reg);\n\t\t\tif (!(status_reg & 0x0002))\n\t\t\t\tbreak;\n\t\t}\n\t\tif (i == 100) {\n\t\t\tpr_err(\"saa7134-go7007: device is hung, status reg = 0x%04x\\n\",\n\t\t\t       status_reg);\n\t\t\treturn -1;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic const struct go7007_hpi_ops saa7134_go7007_hpi_ops = {\n\t.interface_reset\t= saa7134_go7007_interface_reset,\n\t.write_interrupt\t= saa7134_go7007_write_interrupt,\n\t.read_interrupt\t\t= saa7134_go7007_read_interrupt,\n\t.stream_start\t\t= saa7134_go7007_stream_start,\n\t.stream_stop\t\t= saa7134_go7007_stream_stop,\n\t.send_firmware\t\t= saa7134_go7007_send_firmware,\n};\nMODULE_FIRMWARE(\"go7007/go7007tv.bin\");\n\n \n\nstatic int saa7134_go7007_s_std(struct v4l2_subdev *sd, v4l2_std_id norm)\n{\n#if 0\n\tstruct saa7134_go7007 *saa = container_of(sd, struct saa7134_go7007, sd);\n\tstruct saa7134_dev *dev = saa->dev;\n\n\treturn saa7134_s_std_internal(dev, NULL, norm);\n#else\n\treturn 0;\n#endif\n}\n\nstatic const struct v4l2_subdev_video_ops saa7134_go7007_video_ops = {\n\t.s_std = saa7134_go7007_s_std,\n};\n\nstatic const struct v4l2_subdev_ops saa7134_go7007_sd_ops = {\n\t.video = &saa7134_go7007_video_ops,\n};\n\n \n\n\n \n\nstatic int saa7134_go7007_init(struct saa7134_dev *dev)\n{\n\tstruct go7007 *go;\n\tstruct saa7134_go7007 *saa;\n\tstruct v4l2_subdev *sd;\n\n\tpr_debug(\"saa7134-go7007: probing new SAA713X board\\n\");\n\n\tgo = go7007_alloc(&board_voyager, &dev->pci->dev);\n\tif (go == NULL)\n\t\treturn -ENOMEM;\n\n\tsaa = kzalloc(sizeof(struct saa7134_go7007), GFP_KERNEL);\n\tif (saa == NULL) {\n\t\tkfree(go);\n\t\treturn -ENOMEM;\n\t}\n\n\tgo->board_id = GO7007_BOARDID_PCI_VOYAGER;\n\tsnprintf(go->bus_info, sizeof(go->bus_info), \"PCI:%s\", pci_name(dev->pci));\n\tstrscpy(go->name, saa7134_boards[dev->board].name, sizeof(go->name));\n\tgo->hpi_ops = &saa7134_go7007_hpi_ops;\n\tgo->hpi_context = saa;\n\tsaa->dev = dev;\n\n\t \n\tsd = &saa->sd;\n\tv4l2_subdev_init(sd, &saa7134_go7007_sd_ops);\n\tv4l2_set_subdevdata(sd, saa);\n\tstrscpy(sd->name, \"saa7134-go7007\", sizeof(sd->name));\n\n\t \n\tsaa->top = (u8 *)get_zeroed_page(GFP_KERNEL);\n\tif (!saa->top)\n\t\tgoto allocfail;\n\tsaa->bottom = (u8 *)get_zeroed_page(GFP_KERNEL);\n\tif (!saa->bottom)\n\t\tgoto allocfail;\n\n\t \n\tif (go7007_boot_encoder(go, go->board_info->flags &\n\t\t\t\t\tGO7007_BOARD_USE_ONBOARD_I2C) < 0)\n\t\tgoto allocfail;\n\n\t \n\tif (go7007_register_encoder(go, go->board_info->num_i2c_devs) < 0)\n\t\tgoto allocfail;\n\n\t \n\tif (v4l2_device_register_subdev(&go->v4l2_dev, sd) < 0)\n\t\tpr_info(\"saa7134-go7007: register subdev failed\\n\");\n\n\tdev->empress_dev = &go->vdev;\n\n\tgo->status = STATUS_ONLINE;\n\treturn 0;\n\nallocfail:\n\tif (saa->top)\n\t\tfree_page((unsigned long)saa->top);\n\tif (saa->bottom)\n\t\tfree_page((unsigned long)saa->bottom);\n\tkfree(saa);\n\tkfree(go);\n\treturn -ENOMEM;\n}\n\nstatic int saa7134_go7007_fini(struct saa7134_dev *dev)\n{\n\tstruct go7007 *go;\n\tstruct saa7134_go7007 *saa;\n\n\tif (NULL == dev->empress_dev)\n\t\treturn 0;\n\n\tgo = video_get_drvdata(dev->empress_dev);\n\tif (go->audio_enabled)\n\t\tgo7007_snd_remove(go);\n\n\tsaa = go->hpi_context;\n\tgo->status = STATUS_SHUTDOWN;\n\tfree_page((unsigned long)saa->top);\n\tfree_page((unsigned long)saa->bottom);\n\tv4l2_device_unregister_subdev(&saa->sd);\n\tkfree(saa);\n\tvb2_video_unregister_device(&go->vdev);\n\n\tv4l2_device_put(&go->v4l2_dev);\n\tdev->empress_dev = NULL;\n\n\treturn 0;\n}\n\nstatic struct saa7134_mpeg_ops saa7134_go7007_ops = {\n\t.type          = SAA7134_MPEG_GO7007,\n\t.init          = saa7134_go7007_init,\n\t.fini          = saa7134_go7007_fini,\n\t.irq_ts_done   = saa7134_go7007_irq_ts_done,\n};\n\nstatic int __init saa7134_go7007_mod_init(void)\n{\n\treturn saa7134_ts_register(&saa7134_go7007_ops);\n}\n\nstatic void __exit saa7134_go7007_mod_cleanup(void)\n{\n\tsaa7134_ts_unregister(&saa7134_go7007_ops);\n}\n\nmodule_init(saa7134_go7007_mod_init);\nmodule_exit(saa7134_go7007_mod_cleanup);\n\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}