{
  "module_name": "saa7134-tvaudio.c",
  "hash_id": "5c2f0d073d286506015c54f880a6ca35c278af18646cfa9a4735bd1ba7e16500",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/saa7134/saa7134-tvaudio.c",
  "human_readable_source": "\n \n\n#include \"saa7134.h\"\n#include \"saa7134-reg.h\"\n\n#include <linux/init.h>\n#include <linux/list.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/kthread.h>\n#include <linux/delay.h>\n#include <linux/freezer.h>\n#include <asm/div64.h>\n\n \n\nstatic unsigned int audio_debug;\nmodule_param(audio_debug, int, 0644);\nMODULE_PARM_DESC(audio_debug,\"enable debug messages [tv audio]\");\n\nstatic unsigned int audio_ddep;\nmodule_param(audio_ddep, int, 0644);\nMODULE_PARM_DESC(audio_ddep,\"audio ddep overwrite\");\n\nstatic int audio_clock_override = UNSET;\nmodule_param(audio_clock_override, int, 0644);\n\nstatic int audio_clock_tweak;\nmodule_param(audio_clock_tweak, int, 0644);\nMODULE_PARM_DESC(audio_clock_tweak, \"Audio clock tick fine tuning for cards with audio crystal that's slightly off (range [-1024 .. 1024])\");\n\n#define audio_dbg(level, fmt, arg...) do { \\\n\tif (audio_debug >= level) \\\n\t\tprintk(KERN_DEBUG pr_fmt(\"audio: \" fmt), ## arg); \\\n\t} while (0)\n\n \n#define SCAN_INITIAL_DELAY     1000\n#define SCAN_SAMPLE_DELAY       200\n#define SCAN_SUBCARRIER_DELAY  2000\n\n \n \n\nstatic struct mainscan {\n\tchar         *name;\n\tv4l2_std_id  std;\n\tint          carr;\n} mainscan[] = {\n\t{\n\t\t.name = \"MN\",\n\t\t.std  = V4L2_STD_MN,\n\t\t.carr = 4500,\n\t},{\n\t\t.name = \"BGH\",\n\t\t.std  = V4L2_STD_B | V4L2_STD_GH,\n\t\t.carr = 5500,\n\t},{\n\t\t.name = \"I\",\n\t\t.std  = V4L2_STD_PAL_I,\n\t\t.carr = 6000,\n\t},{\n\t\t.name = \"DKL\",\n\t\t.std  = V4L2_STD_DK | V4L2_STD_SECAM_L | V4L2_STD_SECAM_LC,\n\t\t.carr = 6500,\n\t}\n};\n\nstatic struct saa7134_tvaudio tvaudio[] = {\n\t{\n\t\t.name          = \"PAL-B/G FM-stereo\",\n\t\t.std           = V4L2_STD_PAL_BG,\n\t\t.mode          = TVAUDIO_FM_BG_STEREO,\n\t\t.carr1         = 5500,\n\t\t.carr2         = 5742,\n\t},{\n\t\t.name          = \"PAL-D/K1 FM-stereo\",\n\t\t.std           = V4L2_STD_PAL_DK,\n\t\t.carr1         = 6500,\n\t\t.carr2         = 6258,\n\t\t.mode          = TVAUDIO_FM_BG_STEREO,\n\t},{\n\t\t.name          = \"PAL-D/K2 FM-stereo\",\n\t\t.std           = V4L2_STD_PAL_DK,\n\t\t.carr1         = 6500,\n\t\t.carr2         = 6742,\n\t\t.mode          = TVAUDIO_FM_BG_STEREO,\n\t},{\n\t\t.name          = \"PAL-D/K3 FM-stereo\",\n\t\t.std           = V4L2_STD_PAL_DK,\n\t\t.carr1         = 6500,\n\t\t.carr2         = 5742,\n\t\t.mode          = TVAUDIO_FM_BG_STEREO,\n\t},{\n\t\t.name          = \"PAL-B/G NICAM\",\n\t\t.std           = V4L2_STD_PAL_BG,\n\t\t.carr1         = 5500,\n\t\t.carr2         = 5850,\n\t\t.mode          = TVAUDIO_NICAM_FM,\n\t},{\n\t\t.name          = \"PAL-I NICAM\",\n\t\t.std           = V4L2_STD_PAL_I,\n\t\t.carr1         = 6000,\n\t\t.carr2         = 6552,\n\t\t.mode          = TVAUDIO_NICAM_FM,\n\t},{\n\t\t.name          = \"PAL-D/K NICAM\",\n\t\t.std           = V4L2_STD_PAL_DK,\n\t\t.carr1         = 6500,\n\t\t.carr2         = 5850,\n\t\t.mode          = TVAUDIO_NICAM_FM,\n\t},{\n\t\t.name          = \"SECAM-L NICAM\",\n\t\t.std           = V4L2_STD_SECAM_L,\n\t\t.carr1         = 6500,\n\t\t.carr2         = 5850,\n\t\t.mode          = TVAUDIO_NICAM_AM,\n\t},{\n\t\t.name          = \"SECAM-D/K NICAM\",\n\t\t.std           = V4L2_STD_SECAM_DK,\n\t\t.carr1         = 6500,\n\t\t.carr2         = 5850,\n\t\t.mode          = TVAUDIO_NICAM_FM,\n\t},{\n\t\t.name          = \"NTSC-A2 FM-stereo\",\n\t\t.std           = V4L2_STD_NTSC,\n\t\t.carr1         = 4500,\n\t\t.carr2         = 4724,\n\t\t.mode          = TVAUDIO_FM_K_STEREO,\n\t},{\n\t\t.name          = \"NTSC-M\",\n\t\t.std           = V4L2_STD_NTSC,\n\t\t.carr1         = 4500,\n\t\t.carr2         = -1,\n\t\t.mode          = TVAUDIO_FM_MONO,\n\t}\n};\n#define TVAUDIO ARRAY_SIZE(tvaudio)\n\n \n\nstatic u32 tvaudio_carr2reg(u32 carrier)\n{\n\tu64 a = carrier;\n\n\ta <<= 24;\n\tdo_div(a,12288);\n\treturn a;\n}\n\nstatic void tvaudio_setcarrier(struct saa7134_dev *dev,\n\t\t\t       int primary, int secondary)\n{\n\tif (-1 == secondary)\n\t\tsecondary = primary;\n\tsaa_writel(SAA7134_CARRIER1_FREQ0 >> 2, tvaudio_carr2reg(primary));\n\tsaa_writel(SAA7134_CARRIER2_FREQ0 >> 2, tvaudio_carr2reg(secondary));\n}\n\n#define SAA7134_MUTE_MASK 0xbb\n#define SAA7134_MUTE_ANALOG 0x04\n#define SAA7134_MUTE_I2S 0x40\n\nstatic void mute_input_7134(struct saa7134_dev *dev)\n{\n\tunsigned int mute;\n\tstruct saa7134_input *in;\n\tint ausel=0, ics=0, ocs=0;\n\tint mask;\n\n\t \n\tin   = dev->input;\n\tmute = (dev->ctl_mute ||\n\t\t(dev->automute  &&  (&card(dev).radio) != in));\n\tif (card(dev).mute.type) {\n\t\t \n\t\tif (mute)\n\t\t\tin = &card(dev).mute;\n\t}\n\n\tif (dev->hw_mute  == mute &&\n\t\tdev->hw_input == in && !dev->insuspend) {\n\t\taudio_dbg(1, \"mute/input: nothing to do [mute=%d,input=%s]\\n\",\n\t\t\t  mute, saa7134_input_name[in->type]);\n\t\treturn;\n\t}\n\n\taudio_dbg(1, \"ctl_mute=%d automute=%d input=%s  =>  mute=%d input=%s\\n\",\n\t\t  dev->ctl_mute, dev->automute,\n\t\t  saa7134_input_name[dev->input->type], mute,\n\t\t  saa7134_input_name[in->type]);\n\tdev->hw_mute  = mute;\n\tdev->hw_input = in;\n\n\tif (PCI_DEVICE_ID_PHILIPS_SAA7134 == dev->pci->device)\n\t\t \n\t\tsaa_writeb(SAA7134_AUDIO_MUTE_CTRL, mute ?\n\t\t\t\t\t\t    SAA7134_MUTE_MASK |\n\t\t\t\t\t\t    SAA7134_MUTE_ANALOG |\n\t\t\t\t\t\t    SAA7134_MUTE_I2S :\n\t\t\t\t\t\t    SAA7134_MUTE_MASK);\n\n\t \n\tswitch (in->amux) {\n\tcase TV:         ausel=0xc0; ics=0x00; ocs=0x02; break;\n\tcase LINE1:      ausel=0x80; ics=0x00; ocs=0x00; break;\n\tcase LINE2:      ausel=0x80; ics=0x08; ocs=0x01; break;\n\tcase LINE2_LEFT: ausel=0x80; ics=0x08; ocs=0x05; break;\n\t}\n\tsaa_andorb(SAA7134_AUDIO_FORMAT_CTRL, 0xc0, ausel);\n\tsaa_andorb(SAA7134_ANALOG_IO_SELECT, 0x08, ics);\n\tsaa_andorb(SAA7134_ANALOG_IO_SELECT, 0x07, ocs);\n\t\n\tif (in->amux == TV)\n\t\tsaa_andorb(SAA7134_SIF_SAMPLE_FREQ,   0x03, 0x00);\n\telse\n\t\tsaa_andorb(SAA7134_SIF_SAMPLE_FREQ,   0x03, 0x01);\n\n\t \n\tif (0 == card(dev).gpiomask)\n\t\treturn;\n\n\tmask = card(dev).gpiomask;\n\tsaa_andorl(SAA7134_GPIO_GPMODE0 >> 2,   mask, mask);\n\tsaa_andorl(SAA7134_GPIO_GPSTATUS0 >> 2, mask, in->gpio);\n\tsaa7134_track_gpio(dev, saa7134_input_name[in->type]);\n}\n\nstatic void tvaudio_setmode(struct saa7134_dev *dev,\n\t\t\t    struct saa7134_tvaudio *audio,\n\t\t\t    char *note)\n{\n\tint acpf, tweak = 0;\n\n\tif (dev->tvnorm->id == V4L2_STD_NTSC) {\n\t\tacpf = 0x19066;\n\t} else {\n\t\tacpf = 0x1e000;\n\t}\n\tif (audio_clock_tweak > -1024 && audio_clock_tweak < 1024)\n\t\ttweak = audio_clock_tweak;\n\n\tif (note)\n\t\taudio_dbg(1, \"tvaudio_setmode: %s %s [%d.%03d/%d.%03d MHz] acpf=%d%+d\\n\",\n\t\t\tnote, audio->name,\n\t\t\taudio->carr1 / 1000, audio->carr1 % 1000,\n\t\t\taudio->carr2 / 1000, audio->carr2 % 1000,\n\t\t\tacpf, tweak);\n\n\tacpf += tweak;\n\tsaa_writeb(SAA7134_AUDIO_CLOCKS_PER_FIELD0, (acpf & 0x0000ff) >> 0);\n\tsaa_writeb(SAA7134_AUDIO_CLOCKS_PER_FIELD1, (acpf & 0x00ff00) >> 8);\n\tsaa_writeb(SAA7134_AUDIO_CLOCKS_PER_FIELD2, (acpf & 0x030000) >> 16);\n\ttvaudio_setcarrier(dev,audio->carr1,audio->carr2);\n\n\tswitch (audio->mode) {\n\tcase TVAUDIO_FM_MONO:\n\tcase TVAUDIO_FM_BG_STEREO:\n\t\tsaa_writeb(SAA7134_DEMODULATOR,               0x00);\n\t\tsaa_writeb(SAA7134_DCXO_IDENT_CTRL,           0x00);\n\t\tsaa_writeb(SAA7134_FM_DEEMPHASIS,             0x22);\n\t\tsaa_writeb(SAA7134_FM_DEMATRIX,               0x80);\n\t\tsaa_writeb(SAA7134_STEREO_DAC_OUTPUT_SELECT,  0xa0);\n\t\tbreak;\n\tcase TVAUDIO_FM_K_STEREO:\n\t\tsaa_writeb(SAA7134_DEMODULATOR,               0x00);\n\t\tsaa_writeb(SAA7134_DCXO_IDENT_CTRL,           0x01);\n\t\tsaa_writeb(SAA7134_FM_DEEMPHASIS,             0x22);\n\t\tsaa_writeb(SAA7134_FM_DEMATRIX,               0x80);\n\t\tsaa_writeb(SAA7134_STEREO_DAC_OUTPUT_SELECT,  0xa0);\n\t\tbreak;\n\tcase TVAUDIO_NICAM_FM:\n\t\tsaa_writeb(SAA7134_DEMODULATOR,               0x10);\n\t\tsaa_writeb(SAA7134_DCXO_IDENT_CTRL,           0x00);\n\t\tsaa_writeb(SAA7134_FM_DEEMPHASIS,             0x44);\n\t\tsaa_writeb(SAA7134_STEREO_DAC_OUTPUT_SELECT,  0xa1);\n\t\tsaa_writeb(SAA7134_NICAM_CONFIG,              0x00);\n\t\tbreak;\n\tcase TVAUDIO_NICAM_AM:\n\t\tsaa_writeb(SAA7134_DEMODULATOR,               0x12);\n\t\tsaa_writeb(SAA7134_DCXO_IDENT_CTRL,           0x00);\n\t\tsaa_writeb(SAA7134_FM_DEEMPHASIS,             0x44);\n\t\tsaa_writeb(SAA7134_STEREO_DAC_OUTPUT_SELECT,  0xa1);\n\t\tsaa_writeb(SAA7134_NICAM_CONFIG,              0x00);\n\t\tbreak;\n\tcase TVAUDIO_FM_SAT_STEREO:\n\t\t \n\t\tbreak;\n\t}\n}\n\nstatic int tvaudio_sleep(struct saa7134_dev *dev, int timeout)\n{\n\tif (dev->thread.scan1 == dev->thread.scan2 &&\n\t    !kthread_should_stop()) {\n\t\tif (timeout < 0) {\n\t\t\tset_current_state(TASK_INTERRUPTIBLE);\n\t\t\tschedule();\n\t\t} else {\n\t\t\tschedule_timeout_interruptible\n\t\t\t\t\t\t(msecs_to_jiffies(timeout));\n\t\t}\n\t}\n\treturn dev->thread.scan1 != dev->thread.scan2;\n}\n\nstatic int tvaudio_checkcarrier(struct saa7134_dev *dev, struct mainscan *scan)\n{\n\t__s32 left,right,value;\n\n\tif (!(dev->tvnorm->id & scan->std)) {\n\t\taudio_dbg(1, \"skipping %d.%03d MHz [%4s]\\n\",\n\t\t\t  scan->carr / 1000, scan->carr % 1000, scan->name);\n\t\treturn 0;\n\t}\n\n\tif (audio_debug > 1) {\n\t\tint i;\n\t\taudio_dbg(1, \"debug %d:\", scan->carr);\n\t\tfor (i = -150; i <= 150; i += 30) {\n\t\t\ttvaudio_setcarrier(dev,scan->carr+i,scan->carr+i);\n\t\t\tsaa_readl(SAA7134_LEVEL_READOUT1 >> 2);\n\t\t\tif (tvaudio_sleep(dev,SCAN_SAMPLE_DELAY))\n\t\t\t\treturn -1;\n\t\t\tvalue = saa_readl(SAA7134_LEVEL_READOUT1 >> 2);\n\t\t\tif (0 == i)\n\t\t\t\tpr_cont(\"  #  %6d  # \", value >> 16);\n\t\t\telse\n\t\t\t\tpr_cont(\" %6d\", value >> 16);\n\t\t}\n\t\tpr_cont(\"\\n\");\n\t}\n\n\ttvaudio_setcarrier(dev,scan->carr-90,scan->carr-90);\n\tsaa_readl(SAA7134_LEVEL_READOUT1 >> 2);\n\tif (tvaudio_sleep(dev,SCAN_SAMPLE_DELAY))\n\t\treturn -1;\n\tleft = saa_readl(SAA7134_LEVEL_READOUT1 >> 2);\n\n\ttvaudio_setcarrier(dev,scan->carr+90,scan->carr+90);\n\tsaa_readl(SAA7134_LEVEL_READOUT1 >> 2);\n\tif (tvaudio_sleep(dev,SCAN_SAMPLE_DELAY))\n\t\treturn -1;\n\tright = saa_readl(SAA7134_LEVEL_READOUT1 >> 2);\n\n\tleft >>= 16;\n\tright >>= 16;\n\tvalue = left > right ? left - right : right - left;\n\taudio_dbg(1, \"scanning %d.%03d MHz [%4s] =>  dc is %5d [%d/%d]\\n\",\n\t\t  scan->carr / 1000, scan->carr % 1000,\n\t\t  scan->name, value, left, right);\n\treturn value;\n}\n\n\nstatic int tvaudio_getstereo(struct saa7134_dev *dev, struct saa7134_tvaudio *audio)\n{\n\t__u32 idp, nicam, nicam_status;\n\tint retval = -1;\n\n\tswitch (audio->mode) {\n\tcase TVAUDIO_FM_MONO:\n\t\treturn V4L2_TUNER_SUB_MONO;\n\tcase TVAUDIO_FM_K_STEREO:\n\tcase TVAUDIO_FM_BG_STEREO:\n\t\tidp = (saa_readb(SAA7134_IDENT_SIF) & 0xe0) >> 5;\n\t\taudio_dbg(1, \"getstereo: fm/stereo: idp=0x%x\\n\", idp);\n\t\tif (0x03 == (idp & 0x03))\n\t\t\tretval = V4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_LANG2;\n\t\telse if (0x05 == (idp & 0x05))\n\t\t\tretval = V4L2_TUNER_SUB_MONO | V4L2_TUNER_SUB_STEREO;\n\t\telse if (0x01 == (idp & 0x01))\n\t\t\tretval = V4L2_TUNER_SUB_MONO;\n\t\tbreak;\n\tcase TVAUDIO_FM_SAT_STEREO:\n\t\t \n\t\tbreak;\n\tcase TVAUDIO_NICAM_FM:\n\tcase TVAUDIO_NICAM_AM:\n\t\tnicam = saa_readb(SAA7134_AUDIO_STATUS);\n\t\taudio_dbg(1, \"getstereo: nicam=0x%x\\n\", nicam);\n\t\tif (nicam & 0x1) {\n\t\t\tnicam_status = saa_readb(SAA7134_NICAM_STATUS);\n\t\t\taudio_dbg(1, \"getstereo: nicam_status=0x%x\\n\",\n\t\t\t\t  nicam_status);\n\n\t\t\tswitch (nicam_status & 0x03) {\n\t\t\t    case 0x01:\n\t\t\t\tretval = V4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_LANG2;\n\t\t\t\tbreak;\n\t\t\t    case 0x02:\n\t\t\t\tretval = V4L2_TUNER_SUB_MONO | V4L2_TUNER_SUB_STEREO;\n\t\t\t\tbreak;\n\t\t\t    default:\n\t\t\t\tretval = V4L2_TUNER_SUB_MONO;\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t}\n\t\tbreak;\n\t}\n\tif (retval != -1)\n\t\taudio_dbg(1, \"found audio subchannels:%s%s%s%s\\n\",\n\t\t\t(retval & V4L2_TUNER_SUB_MONO)   ? \" mono\"   : \"\",\n\t\t\t(retval & V4L2_TUNER_SUB_STEREO) ? \" stereo\" : \"\",\n\t\t\t(retval & V4L2_TUNER_SUB_LANG1)  ? \" lang1\"  : \"\",\n\t\t\t(retval & V4L2_TUNER_SUB_LANG2)  ? \" lang2\"  : \"\");\n\treturn retval;\n}\n\nstatic int tvaudio_setstereo(struct saa7134_dev *dev, struct saa7134_tvaudio *audio,\n\t\t\t     u32 mode)\n{\n\tstatic char *name[] = {\n\t\t[ V4L2_TUNER_MODE_MONO   ] = \"mono\",\n\t\t[ V4L2_TUNER_MODE_STEREO ] = \"stereo\",\n\t\t[ V4L2_TUNER_MODE_LANG1  ] = \"lang1\",\n\t\t[ V4L2_TUNER_MODE_LANG2  ] = \"lang2\",\n\t\t[ V4L2_TUNER_MODE_LANG1_LANG2  ] = \"lang1+lang2\",\n\t};\n\tstatic u32 fm[] = {\n\t\t[ V4L2_TUNER_MODE_MONO   ] = 0x00,   \n\t\t[ V4L2_TUNER_MODE_STEREO ] = 0x80,   \n\t\t[ V4L2_TUNER_MODE_LANG1  ] = 0x00,   \n\t\t[ V4L2_TUNER_MODE_LANG2  ] = 0x01,   \n\t\t[ V4L2_TUNER_MODE_LANG1_LANG2 ] = 0x80,   \n\t};\n\tu32 reg;\n\n\tswitch (audio->mode) {\n\tcase TVAUDIO_FM_MONO:\n\t\t \n\t\tbreak;\n\tcase TVAUDIO_FM_K_STEREO:\n\tcase TVAUDIO_FM_BG_STEREO:\n\tcase TVAUDIO_NICAM_AM:\n\tcase TVAUDIO_NICAM_FM:\n\t\taudio_dbg(1, \"setstereo [fm] => %s\\n\",\n\t\t\t  name[mode % ARRAY_SIZE(name)]);\n\t\treg = fm[ mode % ARRAY_SIZE(fm) ];\n\t\tsaa_writeb(SAA7134_FM_DEMATRIX, reg);\n\t\tbreak;\n\tcase TVAUDIO_FM_SAT_STEREO:\n\t\t \n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int tvaudio_thread(void *data)\n{\n\tstruct saa7134_dev *dev = data;\n\tint carr_vals[ARRAY_SIZE(mainscan)];\n\tunsigned int i, audio, nscan;\n\tint max1,max2,carrier,rx,mode,lastmode,default_carrier;\n\n\tset_freezable();\n\n\tfor (;;) {\n\t\ttvaudio_sleep(dev,-1);\n\t\tif (kthread_should_stop())\n\t\t\tgoto done;\n\n\trestart:\n\t\ttry_to_freeze();\n\n\t\tdev->thread.scan1 = dev->thread.scan2;\n\t\taudio_dbg(1, \"tvaudio thread scan start [%d]\\n\",\n\t\t\t  dev->thread.scan1);\n\t\tdev->tvaudio  = NULL;\n\n\t\tsaa_writeb(SAA7134_MONITOR_SELECT,   0xa0);\n\t\tsaa_writeb(SAA7134_FM_DEMATRIX,      0x80);\n\n\t\tif (dev->ctl_automute)\n\t\t\tdev->automute = 1;\n\n\t\tmute_input_7134(dev);\n\n\t\t \n\t\tif (tvaudio_sleep(dev,SCAN_INITIAL_DELAY))\n\t\t\tgoto restart;\n\n\t\tmax1 = 0;\n\t\tmax2 = 0;\n\t\tnscan = 0;\n\t\tcarrier = 0;\n\t\tdefault_carrier = 0;\n\t\tfor (i = 0; i < ARRAY_SIZE(mainscan); i++) {\n\t\t\tif (!(dev->tvnorm->id & mainscan[i].std))\n\t\t\t\tcontinue;\n\t\t\tif (!default_carrier)\n\t\t\t\tdefault_carrier = mainscan[i].carr;\n\t\t\tnscan++;\n\t\t}\n\n\t\tif (1 == nscan) {\n\t\t\t \n\t\t\taudio_dbg(1, \"only one main carrier candidate - skipping scan\\n\");\n\t\t\tmax1 = 12345;\n\t\t\tcarrier = default_carrier;\n\t\t} else {\n\t\t\t \n\t\t\tsaa_writeb(SAA7134_MONITOR_SELECT,0x00);\n\t\t\ttvaudio_setmode(dev,&tvaudio[0],NULL);\n\t\t\tfor (i = 0; i < ARRAY_SIZE(mainscan); i++) {\n\t\t\t\tcarr_vals[i] = tvaudio_checkcarrier(dev, mainscan+i);\n\t\t\t\tif (dev->thread.scan1 != dev->thread.scan2)\n\t\t\t\t\tgoto restart;\n\t\t\t}\n\t\t\tfor (max1 = 0, max2 = 0, i = 0; i < ARRAY_SIZE(mainscan); i++) {\n\t\t\t\tif (max1 < carr_vals[i]) {\n\t\t\t\t\tmax2 = max1;\n\t\t\t\t\tmax1 = carr_vals[i];\n\t\t\t\t\tcarrier = mainscan[i].carr;\n\t\t\t\t} else if (max2 < carr_vals[i]) {\n\t\t\t\t\tmax2 = carr_vals[i];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (0 != carrier && max1 > 2000 && max1 > max2*3) {\n\t\t\t \n\t\t\taudio_dbg(1, \"found %s main sound carrier @ %d.%03d MHz [%d/%d]\\n\",\n\t\t\t\t  dev->tvnorm->name, carrier/1000, carrier%1000,\n\t\t\t\t  max1, max2);\n\t\t\tdev->last_carrier = carrier;\n\t\t\tdev->automute = 0;\n\n\t\t} else if (0 != dev->last_carrier) {\n\t\t\t \n\t\t\tcarrier = dev->last_carrier;\n\t\t\taudio_dbg(1, \"audio carrier scan failed, using %d.%03d MHz [last detected]\\n\",\n\t\t\t\t  carrier/1000, carrier%1000);\n\t\t\tdev->automute = 1;\n\n\t\t} else {\n\t\t\t \n\t\t\tcarrier = default_carrier;\n\t\t\taudio_dbg(1, \"audio carrier scan failed, using %d.%03d MHz [default]\\n\",\n\t\t\t\t  carrier/1000, carrier%1000);\n\t\t\tdev->automute = 1;\n\t\t}\n\t\ttvaudio_setcarrier(dev,carrier,carrier);\n\t\tsaa_andorb(SAA7134_STEREO_DAC_OUTPUT_SELECT, 0x30, 0x00);\n\t\tsaa7134_tvaudio_setmute(dev);\n\t\t \n\t\tfor (audio = UNSET, i = 0; i < TVAUDIO; i++) {\n\t\t\tif (dev->tvnorm->id != UNSET &&\n\t\t\t\t!(dev->tvnorm->id & tvaudio[i].std))\n\t\t\t\tcontinue;\n\t\t\tif (tvaudio[i].carr1 != carrier)\n\t\t\t\tcontinue;\n\t\t\t \n\t\t\tif (UNSET == audio)\n\t\t\t\taudio = i;\n\t\t\ttvaudio_setmode(dev,&tvaudio[i],\"trying\");\n\t\t\tif (tvaudio_sleep(dev,SCAN_SUBCARRIER_DELAY))\n\t\t\t\tgoto restart;\n\t\t\tif (-1 != tvaudio_getstereo(dev,&tvaudio[i])) {\n\t\t\t\taudio = i;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tsaa_andorb(SAA7134_STEREO_DAC_OUTPUT_SELECT, 0x30, 0x30);\n\t\tif (UNSET == audio)\n\t\t\tcontinue;\n\t\ttvaudio_setmode(dev,&tvaudio[audio],\"using\");\n\n\t\ttvaudio_setstereo(dev,&tvaudio[audio],V4L2_TUNER_MODE_MONO);\n\t\tdev->tvaudio = &tvaudio[audio];\n\n\t\tlastmode = 42;\n\t\tfor (;;) {\n\n\t\t\ttry_to_freeze();\n\n\t\t\tif (tvaudio_sleep(dev,5000))\n\t\t\t\tgoto restart;\n\t\t\tif (kthread_should_stop())\n\t\t\t\tbreak;\n\t\t\tif (UNSET == dev->thread.mode) {\n\t\t\t\trx = tvaudio_getstereo(dev, &tvaudio[audio]);\n\t\t\t\tmode = saa7134_tvaudio_rx2mode(rx);\n\t\t\t} else {\n\t\t\t\tmode = dev->thread.mode;\n\t\t\t}\n\t\t\tif (lastmode != mode) {\n\t\t\t\ttvaudio_setstereo(dev,&tvaudio[audio],mode);\n\t\t\t\tlastmode = mode;\n\t\t\t}\n\t\t}\n\t}\n\n done:\n\tdev->thread.stopped = 1;\n\treturn 0;\n}\n\n \n \n\nstatic char *stdres[0x20] = {\n\t[0x00] = \"no standard detected\",\n\t[0x01] = \"B/G (in progress)\",\n\t[0x02] = \"D/K (in progress)\",\n\t[0x03] = \"M (in progress)\",\n\n\t[0x04] = \"B/G A2\",\n\t[0x05] = \"B/G NICAM\",\n\t[0x06] = \"D/K A2 (1)\",\n\t[0x07] = \"D/K A2 (2)\",\n\t[0x08] = \"D/K A2 (3)\",\n\t[0x09] = \"D/K NICAM\",\n\t[0x0a] = \"L NICAM\",\n\t[0x0b] = \"I NICAM\",\n\n\t[0x0c] = \"M Korea\",\n\t[0x0d] = \"M BTSC \",\n\t[0x0e] = \"M EIAJ\",\n\n\t[0x0f] = \"FM radio / IF 10.7 / 50 deemp\",\n\t[0x10] = \"FM radio / IF 10.7 / 75 deemp\",\n\t[0x11] = \"FM radio / IF sel / 50 deemp\",\n\t[0x12] = \"FM radio / IF sel / 75 deemp\",\n\n\t[0x13 ... 0x1e ] = \"unknown\",\n\t[0x1f] = \"??? [in progress]\",\n};\n\n#define DSP_RETRY 32\n#define DSP_DELAY 16\n#define SAA7135_DSP_RWCLEAR_RERR 1\n\nstatic inline int saa_dsp_reset_error_bit(struct saa7134_dev *dev)\n{\n\tint state = saa_readb(SAA7135_DSP_RWSTATE);\n\tif (unlikely(state & SAA7135_DSP_RWSTATE_ERR)) {\n\t\taudio_dbg(2, \"%s: resetting error bit\\n\", dev->name);\n\t\tsaa_writeb(SAA7135_DSP_RWCLEAR, SAA7135_DSP_RWCLEAR_RERR);\n\t}\n\treturn 0;\n}\n\nstatic inline int saa_dsp_wait_bit(struct saa7134_dev *dev, int bit)\n{\n\tint state, count = DSP_RETRY;\n\n\tstate = saa_readb(SAA7135_DSP_RWSTATE);\n\tif (unlikely(state & SAA7135_DSP_RWSTATE_ERR)) {\n\t\tpr_warn(\"%s: dsp access error\\n\", dev->name);\n\t\tsaa_dsp_reset_error_bit(dev);\n\t\treturn -EIO;\n\t}\n\twhile (0 == (state & bit)) {\n\t\tif (unlikely(0 == count)) {\n\t\t\tpr_err(\"dsp access wait timeout [bit=%s]\\n\",\n\t\t\t\t (bit & SAA7135_DSP_RWSTATE_WRR) ? \"WRR\" :\n\t\t\t\t (bit & SAA7135_DSP_RWSTATE_RDB) ? \"RDB\" :\n\t\t\t\t (bit & SAA7135_DSP_RWSTATE_IDA) ? \"IDA\" :\n\t\t\t\t \"???\");\n\t\t\treturn -EIO;\n\t\t}\n\t\tsaa_wait(DSP_DELAY);\n\t\tstate = saa_readb(SAA7135_DSP_RWSTATE);\n\t\tcount--;\n\t}\n\treturn 0;\n}\n\n\nint saa_dsp_writel(struct saa7134_dev *dev, int reg, u32 value)\n{\n\tint err;\n\n\taudio_dbg(2, \"dsp write reg 0x%x = 0x%06x\\n\",\n\t\t  (reg << 2) & 0xffffffff, value);\n\terr = saa_dsp_wait_bit(dev,SAA7135_DSP_RWSTATE_WRR);\n\tif (err < 0)\n\t\treturn err;\n\tsaa_writel(reg,value);\n\terr = saa_dsp_wait_bit(dev,SAA7135_DSP_RWSTATE_WRR);\n\tif (err < 0)\n\t\treturn err;\n\treturn 0;\n}\n\nstatic int getstereo_7133(struct saa7134_dev *dev)\n{\n\tint retval = V4L2_TUNER_SUB_MONO;\n\tu32 value;\n\n\tvalue = saa_readl(0x528 >> 2);\n\tif (value & 0x20)\n\t\tretval = V4L2_TUNER_SUB_MONO | V4L2_TUNER_SUB_STEREO;\n\tif (value & 0x40)\n\t\tretval = V4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_LANG2;\n\treturn retval;\n}\n\nstatic int mute_input_7133(struct saa7134_dev *dev)\n{\n\tu32 reg = 0;\n\tu32 xbarin, xbarout;\n\tint mask;\n\tstruct saa7134_input *in;\n\n\txbarin = 0x03;\n\tswitch (dev->input->amux) {\n\tcase TV:\n\t\treg = 0x02;\n\t\txbarin = 0;\n\t\tbreak;\n\tcase LINE1:\n\t\treg = 0x00;\n\t\tbreak;\n\tcase LINE2:\n\tcase LINE2_LEFT:\n\t\treg = 0x09;\n\t\tbreak;\n\t}\n\tsaa_dsp_writel(dev, 0x464 >> 2, xbarin);\n\tif (dev->ctl_mute) {\n\t\treg = 0x07;\n\t\txbarout = 0xbbbbbb;\n\t} else\n\t\txbarout = 0xbbbb10;\n\tsaa_dsp_writel(dev, 0x46c >> 2, xbarout);\n\n\tsaa_writel(0x594 >> 2, reg);\n\n\n\t \n\tif (0 != card(dev).gpiomask) {\n\t\tmask = card(dev).gpiomask;\n\n\t\tif (card(dev).mute.type && dev->ctl_mute)\n\t\t\tin = &card(dev).mute;\n\t\telse\n\t\t\tin = dev->input;\n\n\t\tsaa_andorl(SAA7134_GPIO_GPMODE0 >> 2,   mask, mask);\n\t\tsaa_andorl(SAA7134_GPIO_GPSTATUS0 >> 2, mask, in->gpio);\n\t\tsaa7134_track_gpio(dev, saa7134_input_name[in->type]);\n\t}\n\n\treturn 0;\n}\n\nstatic int tvaudio_thread_ddep(void *data)\n{\n\tstruct saa7134_dev *dev = data;\n\tu32 value, norms;\n\n\tset_freezable();\n\tfor (;;) {\n\t\ttvaudio_sleep(dev,-1);\n\t\tif (kthread_should_stop())\n\t\t\tgoto done;\n\trestart:\n\t\ttry_to_freeze();\n\n\t\tdev->thread.scan1 = dev->thread.scan2;\n\t\taudio_dbg(1, \"tvaudio thread scan start [%d]\\n\",\n\t\t\t  dev->thread.scan1);\n\n\t\tif (audio_ddep >= 0x04 && audio_ddep <= 0x0e) {\n\t\t\t \n\t\t\tnorms = (audio_ddep << 2) | 0x01;\n\t\t\taudio_dbg(1, \"ddep override: %s\\n\",\n\t\t\t\t  stdres[audio_ddep]);\n\t\t} else if (&card(dev).radio == dev->input) {\n\t\t\taudio_dbg(1, \"FM Radio\\n\");\n\t\t\tif (dev->tuner_type == TUNER_PHILIPS_TDA8290) {\n\t\t\t\tnorms = (0x11 << 2) | 0x01;\n\t\t\t\t \n\t\t\t\tsaa_dsp_writel(dev, 0x42c >> 2, 0x729555);\n\t\t\t} else {\n\t\t\t\tnorms = (0x0f << 2) | 0x01;\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tnorms = 0;\n\t\t\tif (dev->tvnorm->id & (V4L2_STD_B | V4L2_STD_GH))\n\t\t\t\tnorms |= 0x04;\n\t\t\tif (dev->tvnorm->id & V4L2_STD_PAL_I)\n\t\t\t\tnorms |= 0x20;\n\t\t\tif (dev->tvnorm->id & V4L2_STD_DK)\n\t\t\t\tnorms |= 0x08;\n\t\t\tif (dev->tvnorm->id & V4L2_STD_MN)\n\t\t\t\tnorms |= 0x40;\n\t\t\tif (dev->tvnorm->id & (V4L2_STD_SECAM_L | V4L2_STD_SECAM_LC))\n\t\t\t\tnorms |= 0x10;\n\t\t\tif (0 == norms)\n\t\t\t\tnorms = 0x7c;  \n\t\t\taudio_dbg(1, \"scanning:%s%s%s%s%s\\n\",\n\t\t\t\t  (norms & 0x04) ? \" B/G\"  : \"\",\n\t\t\t\t  (norms & 0x08) ? \" D/K\"  : \"\",\n\t\t\t\t  (norms & 0x10) ? \" L/L'\" : \"\",\n\t\t\t\t  (norms & 0x20) ? \" I\"    : \"\",\n\t\t\t\t  (norms & 0x40) ? \" M\"    : \"\");\n\t\t}\n\n\t\t \n\t\tsaa_dsp_writel(dev, 0x454 >> 2, 0);\n\t\tsaa_dsp_writel(dev, 0x454 >> 2, norms | 0x80);\n\n\t\t \n\t\tsaa_dsp_writel(dev, 0x464 >> 2, 0x000000);\n\t\tsaa_dsp_writel(dev, 0x470 >> 2, 0x101010);\n\n\t\tif (tvaudio_sleep(dev,3000))\n\t\t\tgoto restart;\n\t\tvalue = saa_readl(0x528 >> 2) & 0xffffff;\n\n\t\taudio_dbg(1, \"tvaudio thread status: 0x%x [%s%s%s]\\n\",\n\t\t\t  value, stdres[value & 0x1f],\n\t\t\t  (value & 0x000020) ? \",stereo\" : \"\",\n\t\t\t  (value & 0x000040) ? \",dual\"   : \"\");\n\t\taudio_dbg(1, \"detailed status: %s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s\\n\",\n\t\t\t  (value & 0x000080) ? \" A2/EIAJ pilot tone \"     : \"\",\n\t\t\t  (value & 0x000100) ? \" A2/EIAJ dual \"           : \"\",\n\t\t\t  (value & 0x000200) ? \" A2/EIAJ stereo \"         : \"\",\n\t\t\t  (value & 0x000400) ? \" A2/EIAJ noise mute \"     : \"\",\n\n\t\t\t  (value & 0x000800) ? \" BTSC/FM radio pilot \"    : \"\",\n\t\t\t  (value & 0x001000) ? \" SAP carrier \"            : \"\",\n\t\t\t  (value & 0x002000) ? \" BTSC stereo noise mute \" : \"\",\n\t\t\t  (value & 0x004000) ? \" SAP noise mute \"         : \"\",\n\t\t\t  (value & 0x008000) ? \" VDSP \"                   : \"\",\n\n\t\t\t  (value & 0x010000) ? \" NICST \"                  : \"\",\n\t\t\t  (value & 0x020000) ? \" NICDU \"                  : \"\",\n\t\t\t  (value & 0x040000) ? \" NICAM muted \"            : \"\",\n\t\t\t  (value & 0x080000) ? \" NICAM reserve sound \"    : \"\",\n\n\t\t\t  (value & 0x100000) ? \" init done \"              : \"\");\n\t}\n\n done:\n\tdev->thread.stopped = 1;\n\treturn 0;\n}\n\n \n \n\nvoid saa7134_enable_i2s(struct saa7134_dev *dev)\n{\n\tint i2s_format;\n\n\tif (!card_is_empress(dev))\n\t\treturn;\n\n\tif (dev->pci->device == PCI_DEVICE_ID_PHILIPS_SAA7130)\n\t\treturn;\n\n\t \n\tsaa_andorl(SAA7134_GPIO_GPMODE0 >> 2, 0x0E000000, 0x00000000);\n\n\tswitch (dev->pci->device) {\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7133:\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7135:\n\t\t \n\t\tsaa_writeb(SAA7133_I2S_AUDIO_CONTROL, 0x00);\n\t\t \n\t\tsaa_writeb(SAA7134_I2S_AUDIO_OUTPUT, 0x11);\n\t\tbreak;\n\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7134:\n\t\ti2s_format = (dev->input->amux == TV) ? 0x00 : 0x01;\n\n\t\t \n\t\tsaa_writeb(SAA7134_I2S_OUTPUT_SELECT, 0x80);\n\t\tsaa_writeb(SAA7134_I2S_OUTPUT_FORMAT, i2s_format);\n\t\tsaa_writeb(SAA7134_I2S_OUTPUT_LEVEL,  0x0F);\n\t\tsaa_writeb(SAA7134_I2S_AUDIO_OUTPUT,  0x01);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nint saa7134_tvaudio_rx2mode(u32 rx)\n{\n\tu32 mode;\n\n\tmode = V4L2_TUNER_MODE_MONO;\n\tif (rx & V4L2_TUNER_SUB_STEREO)\n\t\tmode = V4L2_TUNER_MODE_STEREO;\n\telse if (rx & V4L2_TUNER_SUB_LANG1)\n\t\tmode = V4L2_TUNER_MODE_LANG1;\n\telse if (rx & V4L2_TUNER_SUB_LANG2)\n\t\tmode = V4L2_TUNER_MODE_LANG2;\n\treturn mode;\n}\n\nvoid saa7134_tvaudio_setmute(struct saa7134_dev *dev)\n{\n\tswitch (dev->pci->device) {\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7130:\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7134:\n\t\tmute_input_7134(dev);\n\t\tbreak;\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7133:\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7135:\n\t\tmute_input_7133(dev);\n\t\tbreak;\n\t}\n}\n\nvoid saa7134_tvaudio_setinput(struct saa7134_dev *dev,\n\t\t\t      struct saa7134_input *in)\n{\n\tdev->input = in;\n\tswitch (dev->pci->device) {\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7130:\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7134:\n\t\tmute_input_7134(dev);\n\t\tbreak;\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7133:\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7135:\n\t\tmute_input_7133(dev);\n\t\tbreak;\n\t}\n\tsaa7134_enable_i2s(dev);\n}\n\nvoid saa7134_tvaudio_setvolume(struct saa7134_dev *dev, int level)\n{\n\tswitch (dev->pci->device) {\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7134:\n\t\tsaa_writeb(SAA7134_CHANNEL1_LEVEL,     level & 0x1f);\n\t\tsaa_writeb(SAA7134_CHANNEL2_LEVEL,     level & 0x1f);\n\t\tsaa_writeb(SAA7134_NICAM_LEVEL_ADJUST, level & 0x1f);\n\t\tbreak;\n\t}\n}\n\nint saa7134_tvaudio_getstereo(struct saa7134_dev *dev)\n{\n\tint retval = V4L2_TUNER_SUB_MONO;\n\n\tswitch (dev->pci->device) {\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7134:\n\t\tif (dev->tvaudio)\n\t\t\tretval = tvaudio_getstereo(dev,dev->tvaudio);\n\t\tbreak;\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7133:\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7135:\n\t\tretval = getstereo_7133(dev);\n\t\tbreak;\n\t}\n\treturn retval;\n}\n\nvoid saa7134_tvaudio_init(struct saa7134_dev *dev)\n{\n\tint clock = saa7134_boards[dev->board].audio_clock;\n\n\tif (UNSET != audio_clock_override)\n\t\tclock = audio_clock_override;\n\n\tswitch (dev->pci->device) {\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7134:\n\t\t \n\t\tsaa_writeb(SAA7134_AUDIO_PLL_CTRL,   0x00);\n\t\tif (need_resched())\n\t\t\tschedule();\n\t\telse\n\t\t\tudelay(10);\n\n\t\tsaa_writeb(SAA7134_AUDIO_CLOCK0,      clock        & 0xff);\n\t\tsaa_writeb(SAA7134_AUDIO_CLOCK1,     (clock >>  8) & 0xff);\n\t\tsaa_writeb(SAA7134_AUDIO_CLOCK2,     (clock >> 16) & 0xff);\n\t\t \n\t\tsaa_writeb(SAA7134_AUDIO_PLL_CTRL,   0x01);\n\t\tsaa_writeb(SAA7134_NICAM_ERROR_LOW,  0x14);\n\t\tsaa_writeb(SAA7134_NICAM_ERROR_HIGH, 0x50);\n\t\tbreak;\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7133:\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7135:\n\t\tsaa_writel(0x598 >> 2, clock);\n\t\tsaa_dsp_writel(dev, 0x474 >> 2, 0x00);\n\t\tsaa_dsp_writel(dev, 0x450 >> 2, 0x00);\n\t}\n}\n\nint saa7134_tvaudio_init2(struct saa7134_dev *dev)\n{\n\tint (*my_thread)(void *data) = NULL;\n\n\tswitch (dev->pci->device) {\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7134:\n\t\tmy_thread = tvaudio_thread;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7133:\n\tcase PCI_DEVICE_ID_PHILIPS_SAA7135:\n\t\tmy_thread = tvaudio_thread_ddep;\n\t\tbreak;\n\t}\n\n\tdev->thread.thread = NULL;\n\tdev->thread.scan1 = dev->thread.scan2 = 0;\n\tif (my_thread) {\n\t\tsaa7134_tvaudio_init(dev);\n\t\t \n\t\tdev->thread.thread = kthread_run(my_thread, dev, \"%s\", dev->name);\n\t\tif (IS_ERR(dev->thread.thread)) {\n\t\t\tpr_warn(\"%s: kernel_thread() failed\\n\",\n\t\t\t       dev->name);\n\t\t\t \n\t\t}\n\t}\n\n\tsaa7134_enable_i2s(dev);\n\treturn 0;\n}\n\nint saa7134_tvaudio_close(struct saa7134_dev *dev)\n{\n\tdev->automute = 1;\n\t \n\treturn 0;\n}\n\nint saa7134_tvaudio_fini(struct saa7134_dev *dev)\n{\n\t \n\tif (dev->thread.thread && !dev->thread.stopped)\n\t\tkthread_stop(dev->thread.thread);\n\n\tsaa_andorb(SAA7134_ANALOG_IO_SELECT, 0x07, 0x00);  \n\treturn 0;\n}\n\nint saa7134_tvaudio_do_scan(struct saa7134_dev *dev)\n{\n\tif (dev->input->amux != TV) {\n\t\taudio_dbg(1, \"sound IF not in use, skipping scan\\n\");\n\t\tdev->automute = 0;\n\t\tsaa7134_tvaudio_setmute(dev);\n\t} else if (dev->thread.thread) {\n\t\tdev->thread.mode = UNSET;\n\t\tdev->thread.scan2++;\n\n\t\tif (!dev->insuspend && !dev->thread.stopped)\n\t\t\twake_up_process(dev->thread.thread);\n\t} else {\n\t\tdev->automute = 0;\n\t\tsaa7134_tvaudio_setmute(dev);\n\t}\n\treturn 0;\n}\n\nEXPORT_SYMBOL(saa_dsp_writel);\nEXPORT_SYMBOL(saa7134_tvaudio_setmute);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}