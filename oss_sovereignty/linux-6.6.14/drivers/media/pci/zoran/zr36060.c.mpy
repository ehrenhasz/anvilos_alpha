{
  "module_name": "zr36060.c",
  "hash_id": "e10eac4dabb4fab7d7aa7259d5f1ee68e674e7571cf6c6f7823711f7304c27c9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/zoran/zr36060.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/delay.h>\n\n#include <linux/types.h>\n#include <linux/wait.h>\n\n \n#include <linux/io.h>\n\n \n#include \"zr36060.h\"\n\n \n#include \"videocodec.h\"\n\n \n#define MAX_CODECS 20\n\n \nstatic int zr36060_codecs;\n\nstatic bool low_bitrate;\nmodule_param(low_bitrate, bool, 0);\nMODULE_PARM_DESC(low_bitrate, \"Buz compatibility option, halves bitrate\");\n\n \n\nstatic u8 zr36060_read(struct zr36060 *ptr, u16 reg)\n{\n\tu8 value = 0;\n\tstruct zoran *zr = videocodec_to_zoran(ptr->codec);\n\n\t \n\tif (ptr->codec->master_data->readreg)\n\t\tvalue = (ptr->codec->master_data->readreg(ptr->codec, reg)) & 0xff;\n\telse\n\t\tzrdev_err(zr, \"%s: invalid I/O setup, nothing read!\\n\", ptr->name);\n\n\treturn value;\n}\n\nstatic void zr36060_write(struct zr36060 *ptr, u16 reg, u8 value)\n{\n\tstruct zoran *zr = videocodec_to_zoran(ptr->codec);\n\n\tzrdev_dbg(zr, \"0x%02x @0x%04x\\n\", value, reg);\n\n\t \n\tif (ptr->codec->master_data->writereg)\n\t\tptr->codec->master_data->writereg(ptr->codec, reg, value);\n\telse\n\t\tzrdev_err(zr, \"%s: invalid I/O setup, nothing written!\\n\", ptr->name);\n}\n\n \n\n \nstatic u8 zr36060_read_status(struct zr36060 *ptr)\n{\n\tptr->status = zr36060_read(ptr, ZR060_CFSR);\n\n\tzr36060_read(ptr, 0);\n\treturn ptr->status;\n}\n\n \nstatic u16 zr36060_read_scalefactor(struct zr36060 *ptr)\n{\n\tptr->scalefact = (zr36060_read(ptr, ZR060_SF_HI) << 8) |\n\t\t\t (zr36060_read(ptr, ZR060_SF_LO) & 0xFF);\n\n\t \n\tzr36060_read(ptr, 0);\n\treturn ptr->scalefact;\n}\n\n \nstatic void zr36060_wait_end(struct zr36060 *ptr)\n{\n\tstruct zoran *zr = videocodec_to_zoran(ptr->codec);\n\tint i = 0;\n\n\twhile (zr36060_read_status(ptr) & ZR060_CFSR_BUSY) {\n\t\tudelay(1);\n\t\tif (i++ > 200000) {\t \n\t\t\tzrdev_dbg(zr,\n\t\t\t\t  \"%s: timeout at wait_end (last status: 0x%02x)\\n\",\n\t\t\t\t  ptr->name, ptr->status);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\n \nstatic int zr36060_basic_test(struct zr36060 *ptr)\n{\n\tstruct zoran *zr = videocodec_to_zoran(ptr->codec);\n\n\tif ((zr36060_read(ptr, ZR060_IDR_DEV) != 0x33) &&\n\t    (zr36060_read(ptr, ZR060_IDR_REV) != 0x01)) {\n\t\tzrdev_err(zr, \"%s: attach failed, can't connect to jpeg processor!\\n\", ptr->name);\n\t\treturn -ENXIO;\n\t}\n\n\tzr36060_wait_end(ptr);\n\tif (ptr->status & ZR060_CFSR_BUSY) {\n\t\tzrdev_err(zr, \"%s: attach failed, jpeg processor failed (end flag)!\\n\", ptr->name);\n\t\treturn -EBUSY;\n\t}\n\n\treturn 0;\t\t \n}\n\n \nstatic int zr36060_pushit(struct zr36060 *ptr, u16 startreg, u16 len, const char *data)\n{\n\tstruct zoran *zr = videocodec_to_zoran(ptr->codec);\n\tint i = 0;\n\n\tzrdev_dbg(zr, \"%s: write data block to 0x%04x (len=%d)\\n\", ptr->name,\n\t\t  startreg, len);\n\twhile (i < len)\n\t\tzr36060_write(ptr, startreg++, data[i++]);\n\n\treturn i;\n}\n\n \nstatic const char zr36060_dqt[0x86] = {\n\t0xff, 0xdb,\t\t \n\t0x00, 0x84,\t\t \n\t0x00,\t\t\t \n\t0x10, 0x0b, 0x0c, 0x0e, 0x0c, 0x0a, 0x10, 0x0e,\n\t0x0d, 0x0e, 0x12, 0x11, 0x10, 0x13, 0x18, 0x28,\n\t0x1a, 0x18, 0x16, 0x16, 0x18, 0x31, 0x23, 0x25,\n\t0x1d, 0x28, 0x3a, 0x33, 0x3d, 0x3c, 0x39, 0x33,\n\t0x38, 0x37, 0x40, 0x48, 0x5c, 0x4e, 0x40, 0x44,\n\t0x57, 0x45, 0x37, 0x38, 0x50, 0x6d, 0x51, 0x57,\n\t0x5f, 0x62, 0x67, 0x68, 0x67, 0x3e, 0x4d, 0x71,\n\t0x79, 0x70, 0x64, 0x78, 0x5c, 0x65, 0x67, 0x63,\n\t0x01,\t\t\t \n\t0x11, 0x12, 0x12, 0x18, 0x15, 0x18, 0x2f, 0x1a,\n\t0x1a, 0x2f, 0x63, 0x42, 0x38, 0x42, 0x63, 0x63,\n\t0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63,\n\t0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63,\n\t0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63,\n\t0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63,\n\t0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63,\n\t0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63\n};\n\nstatic const char zr36060_dht[0x1a4] = {\n\t0xff, 0xc4,\t\t \n\t0x01, 0xa2,\t\t \n\t0x00,\t\t\t \n\t0x00, 0x01, 0x05, 0x01, 0x01, 0x01, 0x01, 0x01,\n\t0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,\n\t0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B,\n\t0x01,\t\t\t \n\t0x00, 0x03, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,\n\t0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,\n\t0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B,\n\t0x10,\t\t\t \n\t0x00, 0x02, 0x01, 0x03, 0x03, 0x02, 0x04, 0x03,\n\t0x05, 0x05, 0x04, 0x04, 0x00, 0x00,\n\t0x01, 0x7D, 0x01, 0x02, 0x03, 0x00, 0x04, 0x11,\n\t0x05, 0x12, 0x21, 0x31, 0x41, 0x06, 0x13, 0x51, 0x61,\n\t0x07, 0x22, 0x71, 0x14, 0x32, 0x81, 0x91, 0xA1,\n\t0x08, 0x23, 0x42, 0xB1, 0xC1, 0x15, 0x52, 0xD1, 0xF0, 0x24,\n\t0x33, 0x62, 0x72, 0x82, 0x09, 0x0A, 0x16, 0x17,\n\t0x18, 0x19, 0x1A, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2A, 0x34,\n\t0x35, 0x36, 0x37, 0x38, 0x39, 0x3A, 0x43, 0x44,\n\t0x45, 0x46, 0x47, 0x48, 0x49, 0x4A, 0x53, 0x54, 0x55, 0x56,\n\t0x57, 0x58, 0x59, 0x5A, 0x63, 0x64, 0x65, 0x66,\n\t0x67, 0x68, 0x69, 0x6A, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78,\n\t0x79, 0x7A, 0x83, 0x84, 0x85, 0x86, 0x87, 0x88,\n\t0x89, 0x8A, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97, 0x98, 0x99,\n\t0x9A, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7, 0xA8,\n\t0xA9, 0xAA, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8, 0xB9,\n\t0xBA, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8,\n\t0xC9, 0xCA, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8, 0xD9,\n\t0xDA, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7,\n\t0xE8, 0xE9, 0xEA, 0xF1, 0xF2, 0xF3, 0xF4, 0xF5, 0xF6, 0xF7,\n\t0xF8, 0xF9, 0xFA,\n\t0x11,\t\t\t \n\t0x00, 0x02, 0x01, 0x02, 0x04, 0x04, 0x03, 0x04,\n\t0x07, 0x05, 0x04, 0x04, 0x00, 0x01,\n\t0x02, 0x77, 0x00, 0x01, 0x02, 0x03, 0x11, 0x04,\n\t0x05, 0x21, 0x31, 0x06, 0x12, 0x41, 0x51, 0x07, 0x61, 0x71,\n\t0x13, 0x22, 0x32, 0x81, 0x08, 0x14, 0x42, 0x91,\n\t0xA1, 0xB1, 0xC1, 0x09, 0x23, 0x33, 0x52, 0xF0, 0x15, 0x62,\n\t0x72, 0xD1, 0x0A, 0x16, 0x24, 0x34, 0xE1, 0x25,\n\t0xF1, 0x17, 0x18, 0x19, 0x1A, 0x26, 0x27, 0x28, 0x29, 0x2A,\n\t0x35, 0x36, 0x37, 0x38, 0x39, 0x3A, 0x43, 0x44,\n\t0x45, 0x46, 0x47, 0x48, 0x49, 0x4A, 0x53, 0x54, 0x55, 0x56,\n\t0x57, 0x58, 0x59, 0x5A, 0x63, 0x64, 0x65, 0x66,\n\t0x67, 0x68, 0x69, 0x6A, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78,\n\t0x79, 0x7A, 0x82, 0x83, 0x84, 0x85, 0x86, 0x87,\n\t0x88, 0x89, 0x8A, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97, 0x98,\n\t0x99, 0x9A, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7,\n\t0xA8, 0xA9, 0xAA, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8,\n\t0xB9, 0xBA, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7,\n\t0xC8, 0xC9, 0xCA, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8,\n\t0xD9, 0xDA, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7,\n\t0xE8, 0xE9, 0xEA, 0xF2, 0xF3, 0xF4, 0xF5, 0xF6, 0xF7, 0xF8,\n\t0xF9, 0xFA\n};\n\n \n#define NO_OF_COMPONENTS          0x3\t \n#define BASELINE_PRECISION        0x8\t \nstatic const char zr36060_tq[8] = { 0, 1, 1, 0, 0, 0, 0, 0 };\t \nstatic const char zr36060_td[8] = { 0, 1, 1, 0, 0, 0, 0, 0 };\t \nstatic const char zr36060_ta[8] = { 0, 1, 1, 0, 0, 0, 0, 0 };\t \n\n \nstatic const char zr36060_decimation_h[8] = { 2, 1, 1, 0, 0, 0, 0, 0 };\nstatic const char zr36060_decimation_v[8] = { 1, 1, 1, 0, 0, 0, 0, 0 };\n\n \nstatic int zr36060_set_sof(struct zr36060 *ptr)\n{\n\tstruct zoran *zr = videocodec_to_zoran(ptr->codec);\n\tchar sof_data[34];\t \n\tint i;\n\n\tzrdev_dbg(zr, \"%s: write SOF (%dx%d, %d components)\\n\", ptr->name,\n\t\t  ptr->width, ptr->height, NO_OF_COMPONENTS);\n\tsof_data[0] = 0xff;\n\tsof_data[1] = 0xc0;\n\tsof_data[2] = 0x00;\n\tsof_data[3] = (3 * NO_OF_COMPONENTS) + 8;\n\tsof_data[4] = BASELINE_PRECISION;\t \n\tsof_data[5] = (ptr->height) >> 8;\n\tsof_data[6] = (ptr->height) & 0xff;\n\tsof_data[7] = (ptr->width) >> 8;\n\tsof_data[8] = (ptr->width) & 0xff;\n\tsof_data[9] = NO_OF_COMPONENTS;\n\tfor (i = 0; i < NO_OF_COMPONENTS; i++) {\n\t\tsof_data[10 + (i * 3)] = i;\t \n\t\tsof_data[11 + (i * 3)] = (ptr->h_samp_ratio[i] << 4) |\n\t\t\t\t\t (ptr->v_samp_ratio[i]);  \n\t\tsof_data[12 + (i * 3)] = zr36060_tq[i];\t \n\t}\n\treturn zr36060_pushit(ptr, ZR060_SOF_IDX,\n\t\t\t      (3 * NO_OF_COMPONENTS) + 10, sof_data);\n}\n\n \nstatic int zr36060_set_sos(struct zr36060 *ptr)\n{\n\tstruct zoran *zr = videocodec_to_zoran(ptr->codec);\n\tchar sos_data[16];\t \n\tint i;\n\n\tzrdev_dbg(zr, \"%s: write SOS\\n\", ptr->name);\n\tsos_data[0] = 0xff;\n\tsos_data[1] = 0xda;\n\tsos_data[2] = 0x00;\n\tsos_data[3] = 2 + 1 + (2 * NO_OF_COMPONENTS) + 3;\n\tsos_data[4] = NO_OF_COMPONENTS;\n\tfor (i = 0; i < NO_OF_COMPONENTS; i++) {\n\t\tsos_data[5 + (i * 2)] = i;\t \n\t\tsos_data[6 + (i * 2)] = (zr36060_td[i] << 4) |\n\t\t\t\t\tzr36060_ta[i];  \n\t}\n\tsos_data[2 + 1 + (2 * NO_OF_COMPONENTS) + 2] = 00;\t \n\tsos_data[2 + 1 + (2 * NO_OF_COMPONENTS) + 3] = 0x3f;\n\tsos_data[2 + 1 + (2 * NO_OF_COMPONENTS) + 4] = 00;\n\treturn zr36060_pushit(ptr, ZR060_SOS_IDX,\n\t\t\t      4 + 1 + (2 * NO_OF_COMPONENTS) + 3,\n\t\t\t      sos_data);\n}\n\n \nstatic int zr36060_set_dri(struct zr36060 *ptr)\n{\n\tstruct zoran *zr = videocodec_to_zoran(ptr->codec);\n\tchar dri_data[6];\t \n\n\tzrdev_dbg(zr, \"%s: write DRI\\n\", ptr->name);\n\tdri_data[0] = 0xff;\n\tdri_data[1] = 0xdd;\n\tdri_data[2] = 0x00;\n\tdri_data[3] = 0x04;\n\tdri_data[4] = (ptr->dri) >> 8;\n\tdri_data[5] = (ptr->dri) & 0xff;\n\treturn zr36060_pushit(ptr, ZR060_DRI_IDX, 6, dri_data);\n}\n\n \nstatic void zr36060_init(struct zr36060 *ptr)\n{\n\tint sum = 0;\n\tlong bitcnt, tmp;\n\tstruct zoran *zr = videocodec_to_zoran(ptr->codec);\n\n\tif (ptr->mode == CODEC_DO_COMPRESSION) {\n\t\tzrdev_dbg(zr, \"%s: COMPRESSION SETUP\\n\", ptr->name);\n\n\t\tzr36060_write(ptr, ZR060_LOAD, ZR060_LOAD_SYNC_RST);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_CIR, ZR060_CIR_CODE_MSTR);\n\n\t\t \n\t\t \n\t\tzr36060_write(ptr, ZR060_CMR, ZR060_CMR_COMP | ZR060_CMR_PASS2 | ZR060_CMR_BRB);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_MBZ, 0x00);\n\t\tzr36060_write(ptr, ZR060_TCR_HI, 0x00);\n\t\tzr36060_write(ptr, ZR060_TCR_LO, 0x00);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_IMR, 0);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_SF_HI, ptr->scalefact >> 8);\n\t\tzr36060_write(ptr, ZR060_SF_LO, ptr->scalefact & 0xff);\n\n\t\tzr36060_write(ptr, ZR060_AF_HI, 0xff);\n\t\tzr36060_write(ptr, ZR060_AF_M, 0xff);\n\t\tzr36060_write(ptr, ZR060_AF_LO, 0xff);\n\n\t\t \n\t\tsum += zr36060_set_sof(ptr);\n\t\tsum += zr36060_set_sos(ptr);\n\t\tsum += zr36060_set_dri(ptr);\n\n \n\t\tsum += zr36060_pushit(ptr, ZR060_DQT_IDX, sizeof(zr36060_dqt), zr36060_dqt);\n\t\tsum += zr36060_pushit(ptr, ZR060_DHT_IDX, sizeof(zr36060_dht), zr36060_dht);\n\t\tzr36060_write(ptr, ZR060_APP_IDX, 0xff);\n\t\tzr36060_write(ptr, ZR060_APP_IDX + 1, 0xe0 + ptr->app.appn);\n\t\tzr36060_write(ptr, ZR060_APP_IDX + 2, 0x00);\n\t\tzr36060_write(ptr, ZR060_APP_IDX + 3, ptr->app.len + 2);\n\t\tsum += zr36060_pushit(ptr, ZR060_APP_IDX + 4, 60, ptr->app.data) + 4;\n\t\tzr36060_write(ptr, ZR060_COM_IDX, 0xff);\n\t\tzr36060_write(ptr, ZR060_COM_IDX + 1, 0xfe);\n\t\tzr36060_write(ptr, ZR060_COM_IDX + 2, 0x00);\n\t\tzr36060_write(ptr, ZR060_COM_IDX + 3, ptr->com.len + 2);\n\t\tsum += zr36060_pushit(ptr, ZR060_COM_IDX + 4, 60, ptr->com.data) + 4;\n\n\t\t \n\n\t\t \n\t\tsum = ptr->real_code_vol - sum;\n\t\tbitcnt = sum << 3;\t \n\n\t\ttmp = bitcnt >> 16;\n\t\tzrdev_dbg(zr,\n\t\t\t  \"%s: code: csize=%d, tot=%d, bit=%ld, highbits=%ld\\n\",\n\t\t\t  ptr->name, sum, ptr->real_code_vol, bitcnt, tmp);\n\t\tzr36060_write(ptr, ZR060_TCV_NET_HI, tmp >> 8);\n\t\tzr36060_write(ptr, ZR060_TCV_NET_MH, tmp & 0xff);\n\t\ttmp = bitcnt & 0xffff;\n\t\tzr36060_write(ptr, ZR060_TCV_NET_ML, tmp >> 8);\n\t\tzr36060_write(ptr, ZR060_TCV_NET_LO, tmp & 0xff);\n\n\t\tbitcnt -= bitcnt >> 7;\t \n\t\tbitcnt -= ((bitcnt * 5) >> 6);\t \n\n\t\ttmp = bitcnt >> 16;\n\t\tzrdev_dbg(zr, \"%s: code: nettobit=%ld, highnettobits=%ld\\n\",\n\t\t\t  ptr->name, bitcnt, tmp);\n\t\tzr36060_write(ptr, ZR060_TCV_DATA_HI, tmp >> 8);\n\t\tzr36060_write(ptr, ZR060_TCV_DATA_MH, tmp & 0xff);\n\t\ttmp = bitcnt & 0xffff;\n\t\tzr36060_write(ptr, ZR060_TCV_DATA_ML, tmp >> 8);\n\t\tzr36060_write(ptr, ZR060_TCV_DATA_LO, tmp & 0xff);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_MER,\n\t\t\t      ZR060_MER_DQT | ZR060_MER_DHT |\n\t\t\t      ((ptr->com.len > 0) ? ZR060_MER_COM : 0) |\n\t\t\t      ((ptr->app.len > 0) ? ZR060_MER_APP : 0));\n\n\t\t \n\t\t \n\t\tzr36060_write(ptr, ZR060_VCR, ZR060_VCR_RANGE);\n\n\t} else {\n\t\tzrdev_dbg(zr, \"%s: EXPANSION SETUP\\n\", ptr->name);\n\n\t\tzr36060_write(ptr, ZR060_LOAD, ZR060_LOAD_SYNC_RST);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_CIR, ZR060_CIR_CODE_MSTR);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_CMR, 0);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_MBZ, 0x00);\n\t\tzr36060_write(ptr, ZR060_TCR_HI, 0x00);\n\t\tzr36060_write(ptr, ZR060_TCR_LO, 0x00);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_IMR, 0);\n\n\t\t \n\t\tzr36060_write(ptr, ZR060_MER, 0);\n\n \n\t\tzr36060_pushit(ptr, ZR060_DHT_IDX, sizeof(zr36060_dht), zr36060_dht);\n\n\t\t \n\t\t \n\t\t \n\t\tzr36060_write(ptr, ZR060_VCR, ZR060_VCR_RANGE);\n\t}\n\n\t \n\tzr36060_write(ptr, ZR060_LOAD, ZR060_LOAD_SYNC_RST | ZR060_LOAD_LOAD);\n\tzr36060_wait_end(ptr);\n\tzrdev_dbg(zr, \"%s: Status after table preload: 0x%02x\\n\",\n\t\t  ptr->name, ptr->status);\n\n\tif (ptr->status & ZR060_CFSR_BUSY) {\n\t\tzrdev_err(zr, \"%s: init aborted!\\n\", ptr->name);\n\t\treturn;\t\t \n\t}\n}\n\n \n\n \nstatic int zr36060_set_mode(struct videocodec *codec, int mode)\n{\n\tstruct zr36060 *ptr = (struct zr36060 *)codec->data;\n\tstruct zoran *zr = videocodec_to_zoran(codec);\n\n\tzrdev_dbg(zr, \"%s: set_mode %d call\\n\", ptr->name, mode);\n\n\tif (mode != CODEC_DO_EXPANSION && mode != CODEC_DO_COMPRESSION)\n\t\treturn -EINVAL;\n\n\tptr->mode = mode;\n\tzr36060_init(ptr);\n\n\treturn 0;\n}\n\n \nstatic int zr36060_set_video(struct videocodec *codec, const struct tvnorm *norm,\n\t\t\t     struct vfe_settings *cap, struct vfe_polarity *pol)\n{\n\tstruct zr36060 *ptr = (struct zr36060 *)codec->data;\n\tstruct zoran *zr = videocodec_to_zoran(codec);\n\tu32 reg;\n\tint size;\n\n\tzrdev_dbg(zr, \"%s: set_video %d/%d-%dx%d (%%%d) call\\n\", ptr->name,\n\t\t  cap->x, cap->y, cap->width, cap->height, cap->decimation);\n\n\t \n\tptr->width = cap->width / (cap->decimation & 0xff);\n\tptr->height = cap->height / (cap->decimation >> 8);\n\n\tzr36060_write(ptr, ZR060_LOAD, ZR060_LOAD_SYNC_RST);\n\n\t \n\treg = (!pol->vsync_pol ? ZR060_VPR_VS_POL : 0)\n\t    | (!pol->hsync_pol ? ZR060_VPR_HS_POL : 0)\n\t    | (pol->field_pol ? ZR060_VPR_FI_POL : 0)\n\t    | (pol->blank_pol ? ZR060_VPR_BL_POL : 0)\n\t    | (pol->subimg_pol ? ZR060_VPR_S_IMG_POL : 0)\n\t    | (pol->poe_pol ? ZR060_VPR_POE_POL : 0)\n\t    | (pol->pvalid_pol ? ZR060_VPR_P_VAL_POL : 0)\n\t    | (pol->vclk_pol ? ZR060_VPR_VCLK_POL : 0);\n\tzr36060_write(ptr, ZR060_VPR, reg);\n\n\treg = 0;\n\tswitch (cap->decimation & 0xff) {\n\tdefault:\n\tcase 1:\n\t\tbreak;\n\n\tcase 2:\n\t\treg |= ZR060_SR_H_SCALE2;\n\t\tbreak;\n\n\tcase 4:\n\t\treg |= ZR060_SR_H_SCALE4;\n\t\tbreak;\n\t}\n\n\tswitch (cap->decimation >> 8) {\n\tdefault:\n\tcase 1:\n\t\tbreak;\n\n\tcase 2:\n\t\treg |= ZR060_SR_V_SCALE;\n\t\tbreak;\n\t}\n\tzr36060_write(ptr, ZR060_SR, reg);\n\n\tzr36060_write(ptr, ZR060_BCR_Y, 0x00);\n\tzr36060_write(ptr, ZR060_BCR_U, 0x80);\n\tzr36060_write(ptr, ZR060_BCR_V, 0x80);\n\n\t \n\n\treg = norm->ht - 1;\t \n\tzr36060_write(ptr, ZR060_SGR_VTOTAL_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_SGR_VTOTAL_LO, (reg >> 0) & 0xff);\n\n\treg = norm->wt - 1;\t \n\tzr36060_write(ptr, ZR060_SGR_HTOTAL_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_SGR_HTOTAL_LO, (reg >> 0) & 0xff);\n\n\treg = 6 - 1;\t\t \n\tzr36060_write(ptr, ZR060_SGR_VSYNC, reg);\n\n\treg = 68;\n\tzr36060_write(ptr, ZR060_SGR_HSYNC, reg);\n\n\treg = norm->v_start - 1;\t \n\tzr36060_write(ptr, ZR060_SGR_BVSTART, reg);\n\n\treg += norm->ha / 2;\t \n\tzr36060_write(ptr, ZR060_SGR_BVEND_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_SGR_BVEND_LO, (reg >> 0) & 0xff);\n\n\treg = norm->h_start - 1;\t \n\tzr36060_write(ptr, ZR060_SGR_BHSTART, reg);\n\n\treg += norm->wa;\t \n\tzr36060_write(ptr, ZR060_SGR_BHEND_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_SGR_BHEND_LO, (reg >> 0) & 0xff);\n\n\t \n\treg = cap->y + norm->v_start;\t \n\tzr36060_write(ptr, ZR060_AAR_VSTART_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_AAR_VSTART_LO, (reg >> 0) & 0xff);\n\n\treg += cap->height;\t \n\tzr36060_write(ptr, ZR060_AAR_VEND_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_AAR_VEND_LO, (reg >> 0) & 0xff);\n\n\treg = cap->x + norm->h_start;\t \n\tzr36060_write(ptr, ZR060_AAR_HSTART_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_AAR_HSTART_LO, (reg >> 0) & 0xff);\n\n\treg += cap->width;\t \n\tzr36060_write(ptr, ZR060_AAR_HEND_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_AAR_HEND_LO, (reg >> 0) & 0xff);\n\n\t \n\treg = norm->v_start - 4;\t \n\tzr36060_write(ptr, ZR060_SWR_VSTART_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_SWR_VSTART_LO, (reg >> 0) & 0xff);\n\n\treg += norm->ha / 2 + 8;\t \n\tzr36060_write(ptr, ZR060_SWR_VEND_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_SWR_VEND_LO, (reg >> 0) & 0xff);\n\n\treg = norm->h_start    - 4;\t \n\tzr36060_write(ptr, ZR060_SWR_HSTART_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_SWR_HSTART_LO, (reg >> 0) & 0xff);\n\n\treg += norm->wa + 8;\t \n\tzr36060_write(ptr, ZR060_SWR_HEND_HI, (reg >> 8) & 0xff);\n\tzr36060_write(ptr, ZR060_SWR_HEND_LO, (reg >> 0) & 0xff);\n\n\tsize = ptr->width * ptr->height;\n\t \n\tsize = size * 16;\t \n\t \n\tsize = size * cap->quality / (low_bitrate ? 400 : 200);\n\t \n\tif (size < 8192)\n\t\tsize = 8192;\n\t \n\tif (size > ptr->total_code_vol * 7)\n\t\tsize = ptr->total_code_vol * 7;\n\n\tptr->real_code_vol = size >> 3;\t \n\n\t \n\treg = ptr->max_block_vol;\n\tzr36060_write(ptr, ZR060_MBCVR, reg);\n\n\treturn 0;\n}\n\n \nstatic int zr36060_control(struct videocodec *codec, int type, int size, void *data)\n{\n\tstruct zr36060 *ptr = (struct zr36060 *)codec->data;\n\tstruct zoran *zr = videocodec_to_zoran(codec);\n\tint *ival = (int *)data;\n\n\tzrdev_dbg(zr, \"%s: control %d call with %d byte\\n\", ptr->name, type,\n\t\t  size);\n\n\tswitch (type) {\n\tcase CODEC_G_STATUS:\t \n\t\tif (size != sizeof(int))\n\t\t\treturn -EFAULT;\n\t\tzr36060_read_status(ptr);\n\t\t*ival = ptr->status;\n\t\tbreak;\n\n\tcase CODEC_G_CODEC_MODE:\n\t\tif (size != sizeof(int))\n\t\t\treturn -EFAULT;\n\t\t*ival = CODEC_MODE_BJPG;\n\t\tbreak;\n\n\tcase CODEC_S_CODEC_MODE:\n\t\tif (size != sizeof(int))\n\t\t\treturn -EFAULT;\n\t\tif (*ival != CODEC_MODE_BJPG)\n\t\t\treturn -EINVAL;\n\t\t \n\t\treturn 0;\n\n\tcase CODEC_G_VFE:\n\tcase CODEC_S_VFE:\n\t\t \n\t\treturn 0;\n\n\tcase CODEC_S_MMAP:\n\t\t \n\t\treturn -ENXIO;\n\n\tcase CODEC_G_JPEG_TDS_BYTE:\t \n\t\tif (size != sizeof(int))\n\t\t\treturn -EFAULT;\n\t\t*ival = ptr->total_code_vol;\n\t\tbreak;\n\n\tcase CODEC_S_JPEG_TDS_BYTE:\t \n\t\tif (size != sizeof(int))\n\t\t\treturn -EFAULT;\n\t\tptr->total_code_vol = *ival;\n\t\tptr->real_code_vol = (ptr->total_code_vol * 6) >> 3;\n\t\tbreak;\n\n\tcase CODEC_G_JPEG_SCALE:\t \n\t\tif (size != sizeof(int))\n\t\t\treturn -EFAULT;\n\t\t*ival = zr36060_read_scalefactor(ptr);\n\t\tbreak;\n\n\tcase CODEC_S_JPEG_SCALE:\t \n\t\tif (size != sizeof(int))\n\t\t\treturn -EFAULT;\n\t\tptr->scalefact = *ival;\n\t\tbreak;\n\n\tcase CODEC_G_JPEG_APP_DATA: {\t \n\t\tstruct jpeg_app_marker *app = data;\n\n\t\tif (size != sizeof(struct jpeg_app_marker))\n\t\t\treturn -EFAULT;\n\n\t\t*app = ptr->app;\n\t\tbreak;\n\t}\n\n\tcase CODEC_S_JPEG_APP_DATA: {\t \n\t\tstruct jpeg_app_marker *app = data;\n\n\t\tif (size != sizeof(struct jpeg_app_marker))\n\t\t\treturn -EFAULT;\n\n\t\tptr->app = *app;\n\t\tbreak;\n\t}\n\n\tcase CODEC_G_JPEG_COM_DATA: {\t \n\t\tstruct jpeg_com_marker *com = data;\n\n\t\tif (size != sizeof(struct jpeg_com_marker))\n\t\t\treturn -EFAULT;\n\n\t\t*com = ptr->com;\n\t\tbreak;\n\t}\n\n\tcase CODEC_S_JPEG_COM_DATA: {\t \n\t\tstruct jpeg_com_marker *com = data;\n\n\t\tif (size != sizeof(struct jpeg_com_marker))\n\t\t\treturn -EFAULT;\n\n\t\tptr->com = *com;\n\t\tbreak;\n\t}\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn size;\n}\n\n \nstatic int zr36060_unset(struct videocodec *codec)\n{\n\tstruct zr36060 *ptr = codec->data;\n\tstruct zoran *zr = videocodec_to_zoran(codec);\n\n\tif (ptr) {\n\t\t \n\n\t\tzrdev_dbg(zr, \"%s: finished codec #%d\\n\", ptr->name, ptr->num);\n\t\tkfree(ptr);\n\t\tcodec->data = NULL;\n\n\t\tzr36060_codecs--;\n\t\treturn 0;\n\t}\n\n\treturn -EFAULT;\n}\n\n \nstatic int zr36060_setup(struct videocodec *codec)\n{\n\tstruct zr36060 *ptr;\n\tstruct zoran *zr = videocodec_to_zoran(codec);\n\tint res;\n\n\tzrdev_dbg(zr, \"zr36060: initializing MJPEG subsystem #%d.\\n\",\n\t\t  zr36060_codecs);\n\n\tif (zr36060_codecs == MAX_CODECS) {\n\t\tzrdev_err(zr, \"zr36060: Can't attach more codecs!\\n\");\n\t\treturn -ENOSPC;\n\t}\n\t \n\tptr = kzalloc(sizeof(*ptr), GFP_KERNEL);\n\tcodec->data = ptr;\n\tif (!ptr)\n\t\treturn -ENOMEM;\n\n\tsnprintf(ptr->name, sizeof(ptr->name), \"zr36060[%d]\", zr36060_codecs);\n\tptr->num = zr36060_codecs++;\n\tptr->codec = codec;\n\n\t \n\tres = zr36060_basic_test(ptr);\n\tif (res < 0) {\n\t\tzr36060_unset(codec);\n\t\treturn res;\n\t}\n\t \n\tmemcpy(ptr->h_samp_ratio, zr36060_decimation_h, 8);\n\tmemcpy(ptr->v_samp_ratio, zr36060_decimation_v, 8);\n\n\tptr->bitrate_ctrl = 0;\t \n\tptr->mode = CODEC_DO_COMPRESSION;\n\tptr->width = 384;\n\tptr->height = 288;\n\tptr->total_code_vol = 16000;\t \n\tptr->real_code_vol = (ptr->total_code_vol * 6) >> 3;\n\tptr->max_block_vol = 240;\t \n\tptr->scalefact = 0x100;\n\tptr->dri = 1;\t\t \n\n\t \n\tptr->com.len = 0;\n\tptr->app.appn = 0;\n\tptr->app.len = 0;\n\n\tzr36060_init(ptr);\n\n\tzrdev_info(zr, \"%s: codec attached and running\\n\", ptr->name);\n\n\treturn 0;\n}\n\nstatic const struct videocodec zr36060_codec = {\n\t.name = \"zr36060\",\n\t.magic = 0L,\t\t \n\t.flags =\n\t    CODEC_FLAG_JPEG | CODEC_FLAG_HARDWARE | CODEC_FLAG_ENCODER |\n\t    CODEC_FLAG_DECODER | CODEC_FLAG_VFE,\n\t.type = CODEC_TYPE_ZR36060,\n\t.setup = zr36060_setup,\t \n\t.unset = zr36060_unset,\n\t.set_mode = zr36060_set_mode,\n\t.set_video = zr36060_set_video,\n\t.control = zr36060_control,\n\t \n};\n\nint zr36060_init_module(void)\n{\n\tzr36060_codecs = 0;\n\treturn videocodec_register(&zr36060_codec);\n}\n\nvoid zr36060_cleanup_module(void)\n{\n\tif (zr36060_codecs) {\n\t\tpr_debug(\"zr36060: something's wrong - %d codecs left somehow.\\n\",\n\t\t\t zr36060_codecs);\n\t}\n\n\t \n\tvideocodec_unregister(&zr36060_codec);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}