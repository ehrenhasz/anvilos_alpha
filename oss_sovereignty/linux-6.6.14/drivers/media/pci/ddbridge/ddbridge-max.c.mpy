{
  "module_name": "ddbridge-max.c",
  "hash_id": "b1284702da09452a6772676d74081ea2ad365ffba4f4e6fe922694e92881602d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/ddbridge/ddbridge-max.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/poll.h>\n#include <linux/io.h>\n#include <linux/pci.h>\n#include <linux/pci_ids.h>\n#include <linux/timer.h>\n#include <linux/i2c.h>\n#include <linux/swab.h>\n#include <linux/vmalloc.h>\n\n#include \"ddbridge.h\"\n#include \"ddbridge-regs.h\"\n#include \"ddbridge-io.h\"\n#include \"ddbridge-mci.h\"\n\n#include \"ddbridge-max.h\"\n#include \"mxl5xx.h\"\n\n \n\n \nstatic int fmode;\nmodule_param(fmode, int, 0444);\nMODULE_PARM_DESC(fmode, \"frontend emulation mode\");\n\nstatic int fmode_sat = -1;\nmodule_param(fmode_sat, int, 0444);\nMODULE_PARM_DESC(fmode_sat, \"set frontend emulation mode sat\");\n\nstatic int old_quattro;\nmodule_param(old_quattro, int, 0444);\nMODULE_PARM_DESC(old_quattro, \"old quattro LNB input order \");\n\n \n\nstatic int lnb_command(struct ddb *dev, u32 link, u32 lnb, u32 cmd)\n{\n\tu32 c, v = 0, tag = DDB_LINK_TAG(link);\n\n\tv = LNB_TONE & (dev->link[link].lnb.tone << (15 - lnb));\n\tddbwritel(dev, cmd | v, tag | LNB_CONTROL(lnb));\n\tfor (c = 0; c < 10; c++) {\n\t\tv = ddbreadl(dev, tag | LNB_CONTROL(lnb));\n\t\tif ((v & LNB_BUSY) == 0)\n\t\t\tbreak;\n\t\tmsleep(20);\n\t}\n\tif (c == 10)\n\t\tdev_info(dev->dev, \"%s lnb = %08x  cmd = %08x\\n\",\n\t\t\t __func__, lnb, cmd);\n\treturn 0;\n}\n\nstatic int max_send_master_cmd(struct dvb_frontend *fe,\n\t\t\t       struct dvb_diseqc_master_cmd *cmd)\n{\n\tstruct ddb_input *input = fe->sec_priv;\n\tstruct ddb_port *port = input->port;\n\tstruct ddb *dev = port->dev;\n\tstruct ddb_dvb *dvb = &port->dvb[input->nr & 1];\n\tu32 tag = DDB_LINK_TAG(port->lnr);\n\tint i;\n\tu32 fmode = dev->link[port->lnr].lnb.fmode;\n\n\tif (fmode == 2 || fmode == 1)\n\t\treturn 0;\n\tif (dvb->diseqc_send_master_cmd)\n\t\tdvb->diseqc_send_master_cmd(fe, cmd);\n\n\tmutex_lock(&dev->link[port->lnr].lnb.lock);\n\tddbwritel(dev, 0, tag | LNB_BUF_LEVEL(dvb->input));\n\tfor (i = 0; i < cmd->msg_len; i++)\n\t\tddbwritel(dev, cmd->msg[i], tag | LNB_BUF_WRITE(dvb->input));\n\tlnb_command(dev, port->lnr, dvb->input, LNB_CMD_DISEQC);\n\tmutex_unlock(&dev->link[port->lnr].lnb.lock);\n\treturn 0;\n}\n\nstatic int lnb_send_diseqc(struct ddb *dev, u32 link, u32 input,\n\t\t\t   struct dvb_diseqc_master_cmd *cmd)\n{\n\tu32 tag = DDB_LINK_TAG(link);\n\tint i;\n\n\tddbwritel(dev, 0, tag | LNB_BUF_LEVEL(input));\n\tfor (i = 0; i < cmd->msg_len; i++)\n\t\tddbwritel(dev, cmd->msg[i], tag | LNB_BUF_WRITE(input));\n\tlnb_command(dev, link, input, LNB_CMD_DISEQC);\n\treturn 0;\n}\n\nstatic int lnb_set_sat(struct ddb *dev, u32 link, u32 input, u32 sat, u32 band,\n\t\t       u32 hor)\n{\n\tstruct dvb_diseqc_master_cmd cmd = {\n\t\t.msg = {0xe0, 0x10, 0x38, 0xf0, 0x00, 0x00},\n\t\t.msg_len = 4\n\t};\n\tcmd.msg[3] = 0xf0 | (((sat << 2) & 0x0c) | (band ? 1 : 0) |\n\t\t(hor ? 2 : 0));\n\treturn lnb_send_diseqc(dev, link, input, &cmd);\n}\n\nstatic int lnb_set_tone(struct ddb *dev, u32 link, u32 input,\n\t\t\tenum fe_sec_tone_mode tone)\n{\n\tint s = 0;\n\tu32 mask = (1ULL << input);\n\n\tswitch (tone) {\n\tcase SEC_TONE_OFF:\n\t\tif (!(dev->link[link].lnb.tone & mask))\n\t\t\treturn 0;\n\t\tdev->link[link].lnb.tone &= ~(1ULL << input);\n\t\tbreak;\n\tcase SEC_TONE_ON:\n\t\tif (dev->link[link].lnb.tone & mask)\n\t\t\treturn 0;\n\t\tdev->link[link].lnb.tone |= (1ULL << input);\n\t\tbreak;\n\tdefault:\n\t\ts = -EINVAL;\n\t\tbreak;\n\t}\n\tif (!s)\n\t\ts = lnb_command(dev, link, input, LNB_CMD_NOP);\n\treturn s;\n}\n\nstatic int lnb_set_voltage(struct ddb *dev, u32 link, u32 input,\n\t\t\t   enum fe_sec_voltage voltage)\n{\n\tint s = 0;\n\n\tif (dev->link[link].lnb.oldvoltage[input] == voltage)\n\t\treturn 0;\n\tswitch (voltage) {\n\tcase SEC_VOLTAGE_OFF:\n\t\tif (dev->link[link].lnb.voltage[input])\n\t\t\treturn 0;\n\t\tlnb_command(dev, link, input, LNB_CMD_OFF);\n\t\tbreak;\n\tcase SEC_VOLTAGE_13:\n\t\tlnb_command(dev, link, input, LNB_CMD_LOW);\n\t\tbreak;\n\tcase SEC_VOLTAGE_18:\n\t\tlnb_command(dev, link, input, LNB_CMD_HIGH);\n\t\tbreak;\n\tdefault:\n\t\ts = -EINVAL;\n\t\tbreak;\n\t}\n\tdev->link[link].lnb.oldvoltage[input] = voltage;\n\treturn s;\n}\n\nstatic int max_set_input_unlocked(struct dvb_frontend *fe, int in)\n{\n\tstruct ddb_input *input = fe->sec_priv;\n\tstruct ddb_port *port = input->port;\n\tstruct ddb *dev = port->dev;\n\tstruct ddb_dvb *dvb = &port->dvb[input->nr & 1];\n\tint res = 0;\n\n\tif (in > 3)\n\t\treturn -EINVAL;\n\tif (dvb->input != in) {\n\t\tu32 bit = (1ULL << input->nr);\n\t\tu32 obit =\n\t\t\tdev->link[port->lnr].lnb.voltage[dvb->input & 3] & bit;\n\n\t\tdev->link[port->lnr].lnb.voltage[dvb->input & 3] &= ~bit;\n\t\tdvb->input = in;\n\t\tdev->link[port->lnr].lnb.voltage[dvb->input & 3] |= obit;\n\t}\n\tres = dvb->set_input(fe, in);\n\treturn res;\n}\n\nstatic int max_set_tone(struct dvb_frontend *fe, enum fe_sec_tone_mode tone)\n{\n\tstruct ddb_input *input = fe->sec_priv;\n\tstruct ddb_port *port = input->port;\n\tstruct ddb *dev = port->dev;\n\tstruct ddb_dvb *dvb = &port->dvb[input->nr & 1];\n\tint tuner = 0;\n\tint res = 0;\n\tu32 fmode = dev->link[port->lnr].lnb.fmode;\n\n\tmutex_lock(&dev->link[port->lnr].lnb.lock);\n\tdvb->tone = tone;\n\tswitch (fmode) {\n\tdefault:\n\tcase 0:\n\tcase 3:\n\t\tres = lnb_set_tone(dev, port->lnr, dvb->input, tone);\n\t\tbreak;\n\tcase 1:\n\tcase 2:\n\t\tif (old_quattro) {\n\t\t\tif (dvb->tone == SEC_TONE_ON)\n\t\t\t\ttuner |= 2;\n\t\t\tif (dvb->voltage == SEC_VOLTAGE_18)\n\t\t\t\ttuner |= 1;\n\t\t} else {\n\t\t\tif (dvb->tone == SEC_TONE_ON)\n\t\t\t\ttuner |= 1;\n\t\t\tif (dvb->voltage == SEC_VOLTAGE_18)\n\t\t\t\ttuner |= 2;\n\t\t}\n\t\tres = max_set_input_unlocked(fe, tuner);\n\t\tbreak;\n\t}\n\tmutex_unlock(&dev->link[port->lnr].lnb.lock);\n\treturn res;\n}\n\nstatic int max_set_voltage(struct dvb_frontend *fe, enum fe_sec_voltage voltage)\n{\n\tstruct ddb_input *input = fe->sec_priv;\n\tstruct ddb_port *port = input->port;\n\tstruct ddb *dev = port->dev;\n\tstruct ddb_dvb *dvb = &port->dvb[input->nr & 1];\n\tint tuner = 0;\n\tu32 nv, ov = dev->link[port->lnr].lnb.voltages;\n\tint res = 0;\n\tu32 fmode = dev->link[port->lnr].lnb.fmode;\n\n\tmutex_lock(&dev->link[port->lnr].lnb.lock);\n\tdvb->voltage = voltage;\n\n\tswitch (fmode) {\n\tcase 3:\n\tdefault:\n\tcase 0:\n\t\tif (fmode == 3)\n\t\t\tmax_set_input_unlocked(fe, 0);\n\t\tif (voltage == SEC_VOLTAGE_OFF)\n\t\t\tdev->link[port->lnr].lnb.voltage[dvb->input] &=\n\t\t\t\t~(1ULL << input->nr);\n\t\telse\n\t\t\tdev->link[port->lnr].lnb.voltage[dvb->input] |=\n\t\t\t\t(1ULL << input->nr);\n\n\t\tres = lnb_set_voltage(dev, port->lnr, dvb->input, voltage);\n\t\tbreak;\n\tcase 1:\n\tcase 2:\n\t\tif (voltage == SEC_VOLTAGE_OFF)\n\t\t\tdev->link[port->lnr].lnb.voltages &=\n\t\t\t\t~(1ULL << input->nr);\n\t\telse\n\t\t\tdev->link[port->lnr].lnb.voltages |=\n\t\t\t\t(1ULL << input->nr);\n\n\t\tnv = dev->link[port->lnr].lnb.voltages;\n\n\t\tif (old_quattro) {\n\t\t\tif (dvb->tone == SEC_TONE_ON)\n\t\t\t\ttuner |= 2;\n\t\t\tif (dvb->voltage == SEC_VOLTAGE_18)\n\t\t\t\ttuner |= 1;\n\t\t} else {\n\t\t\tif (dvb->tone == SEC_TONE_ON)\n\t\t\t\ttuner |= 1;\n\t\t\tif (dvb->voltage == SEC_VOLTAGE_18)\n\t\t\t\ttuner |= 2;\n\t\t}\n\t\tres = max_set_input_unlocked(fe, tuner);\n\n\t\tif (nv != ov) {\n\t\t\tif (nv) {\n\t\t\t\tlnb_set_voltage(\n\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t0, SEC_VOLTAGE_13);\n\t\t\t\tif (fmode == 1) {\n\t\t\t\t\tlnb_set_voltage(\n\t\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t\t0, SEC_VOLTAGE_13);\n\t\t\t\t\tif (old_quattro) {\n\t\t\t\t\t\tlnb_set_voltage(\n\t\t\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t\t\t1, SEC_VOLTAGE_18);\n\t\t\t\t\t\tlnb_set_voltage(\n\t\t\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t\t\t2, SEC_VOLTAGE_13);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlnb_set_voltage(\n\t\t\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t\t\t1, SEC_VOLTAGE_13);\n\t\t\t\t\t\tlnb_set_voltage(\n\t\t\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t\t\t2, SEC_VOLTAGE_18);\n\t\t\t\t\t}\n\t\t\t\t\tlnb_set_voltage(\n\t\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t\t3, SEC_VOLTAGE_18);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tlnb_set_voltage(\n\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t0, SEC_VOLTAGE_OFF);\n\t\t\t\tif (fmode == 1) {\n\t\t\t\t\tlnb_set_voltage(\n\t\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t\t1, SEC_VOLTAGE_OFF);\n\t\t\t\t\tlnb_set_voltage(\n\t\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t\t2, SEC_VOLTAGE_OFF);\n\t\t\t\t\tlnb_set_voltage(\n\t\t\t\t\t\tdev, port->lnr,\n\t\t\t\t\t\t3, SEC_VOLTAGE_OFF);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tbreak;\n\t}\n\tmutex_unlock(&dev->link[port->lnr].lnb.lock);\n\treturn res;\n}\n\nstatic int max_enable_high_lnb_voltage(struct dvb_frontend *fe, long arg)\n{\n\treturn 0;\n}\n\nstatic int max_send_burst(struct dvb_frontend *fe, enum fe_sec_mini_cmd burst)\n{\n\treturn 0;\n}\n\nstatic int mxl_fw_read(void *priv, u8 *buf, u32 len)\n{\n\tstruct ddb_link *link = priv;\n\tstruct ddb *dev = link->dev;\n\n\tdev_info(dev->dev, \"Read mxl_fw from link %u\\n\", link->nr);\n\n\treturn ddbridge_flashread(dev, link->nr, buf, 0xc0000, len);\n}\n\nint ddb_lnb_init_fmode(struct ddb *dev, struct ddb_link *link, u32 fm)\n{\n\tu32 l = link->nr;\n\n\tif (link->lnb.fmode == fm)\n\t\treturn 0;\n\tdev_info(dev->dev, \"Set fmode link %u = %u\\n\", l, fm);\n\tmutex_lock(&link->lnb.lock);\n\tif (fm == 2 || fm == 1) {\n\t\tif (fmode_sat >= 0) {\n\t\t\tlnb_set_sat(dev, l, 0, fmode_sat, 0, 0);\n\t\t\tif (old_quattro) {\n\t\t\t\tlnb_set_sat(dev, l, 1, fmode_sat, 0, 1);\n\t\t\t\tlnb_set_sat(dev, l, 2, fmode_sat, 1, 0);\n\t\t\t} else {\n\t\t\t\tlnb_set_sat(dev, l, 1, fmode_sat, 1, 0);\n\t\t\t\tlnb_set_sat(dev, l, 2, fmode_sat, 0, 1);\n\t\t\t}\n\t\t\tlnb_set_sat(dev, l, 3, fmode_sat, 1, 1);\n\t\t}\n\t\tlnb_set_tone(dev, l, 0, SEC_TONE_OFF);\n\t\tif (old_quattro) {\n\t\t\tlnb_set_tone(dev, l, 1, SEC_TONE_OFF);\n\t\t\tlnb_set_tone(dev, l, 2, SEC_TONE_ON);\n\t\t} else {\n\t\t\tlnb_set_tone(dev, l, 1, SEC_TONE_ON);\n\t\t\tlnb_set_tone(dev, l, 2, SEC_TONE_OFF);\n\t\t}\n\t\tlnb_set_tone(dev, l, 3, SEC_TONE_ON);\n\t}\n\tlink->lnb.fmode = fm;\n\tmutex_unlock(&link->lnb.lock);\n\treturn 0;\n}\n\nstatic struct mxl5xx_cfg mxl5xx = {\n\t.adr      = 0x60,\n\t.type     = 0x01,\n\t.clk      = 27000000,\n\t.ts_clk   = 139,\n\t.cap      = 12,\n\t.fw_read  = mxl_fw_read,\n};\n\nint ddb_fe_attach_mxl5xx(struct ddb_input *input)\n{\n\tstruct ddb *dev = input->port->dev;\n\tstruct i2c_adapter *i2c = &input->port->i2c->adap;\n\tstruct ddb_dvb *dvb = &input->port->dvb[input->nr & 1];\n\tstruct ddb_port *port = input->port;\n\tstruct ddb_link *link = &dev->link[port->lnr];\n\tstruct mxl5xx_cfg cfg;\n\tint demod, tuner;\n\n\tcfg = mxl5xx;\n\tcfg.fw_priv = link;\n\tdvb->set_input = NULL;\n\n\tdemod = input->nr;\n\ttuner = demod & 3;\n\tif (fmode == 3)\n\t\ttuner = 0;\n\n\tdvb->fe = dvb_attach(mxl5xx_attach, i2c, &cfg,\n\t\t\t     demod, tuner, &dvb->set_input);\n\n\tif (!dvb->fe) {\n\t\tdev_err(dev->dev, \"No MXL5XX found!\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (!dvb->set_input) {\n\t\tdev_err(dev->dev, \"No mxl5xx_set_input function pointer!\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (input->nr < 4) {\n\t\tlnb_command(dev, port->lnr, input->nr, LNB_CMD_INIT);\n\t\tlnb_set_voltage(dev, port->lnr, input->nr, SEC_VOLTAGE_OFF);\n\t}\n\tddb_lnb_init_fmode(dev, link, fmode);\n\n\tdvb->fe->ops.set_voltage = max_set_voltage;\n\tdvb->fe->ops.enable_high_lnb_voltage = max_enable_high_lnb_voltage;\n\tdvb->fe->ops.set_tone = max_set_tone;\n\tdvb->diseqc_send_master_cmd = dvb->fe->ops.diseqc_send_master_cmd;\n\tdvb->fe->ops.diseqc_send_master_cmd = max_send_master_cmd;\n\tdvb->fe->ops.diseqc_send_burst = max_send_burst;\n\tdvb->fe->sec_priv = input;\n\tdvb->input = tuner;\n\treturn 0;\n}\n\n \n \n\nint ddb_fe_attach_mci(struct ddb_input *input, u32 type)\n{\n\tstruct ddb *dev = input->port->dev;\n\tstruct ddb_dvb *dvb = &input->port->dvb[input->nr & 1];\n\tstruct ddb_port *port = input->port;\n\tstruct ddb_link *link = &dev->link[port->lnr];\n\tint demod, tuner;\n\tstruct mci_cfg cfg;\n\n\tdemod = input->nr;\n\ttuner = demod & 3;\n\tswitch (type) {\n\tcase DDB_TUNER_MCI_SX8:\n\t\tcfg = ddb_max_sx8_cfg;\n\t\tif (fmode == 3)\n\t\t\ttuner = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\tdvb->fe = ddb_mci_attach(input, &cfg, demod, &dvb->set_input);\n\tif (!dvb->fe) {\n\t\tdev_err(dev->dev, \"No MCI card found!\\n\");\n\t\treturn -ENODEV;\n\t}\n\tif (!dvb->set_input) {\n\t\tdev_err(dev->dev, \"No MCI set_input function pointer!\\n\");\n\t\treturn -ENODEV;\n\t}\n\tif (input->nr < 4) {\n\t\tlnb_command(dev, port->lnr, input->nr, LNB_CMD_INIT);\n\t\tlnb_set_voltage(dev, port->lnr, input->nr, SEC_VOLTAGE_OFF);\n\t}\n\tddb_lnb_init_fmode(dev, link, fmode);\n\n\tdvb->fe->ops.set_voltage = max_set_voltage;\n\tdvb->fe->ops.enable_high_lnb_voltage = max_enable_high_lnb_voltage;\n\tdvb->fe->ops.set_tone = max_set_tone;\n\tdvb->diseqc_send_master_cmd = dvb->fe->ops.diseqc_send_master_cmd;\n\tdvb->fe->ops.diseqc_send_master_cmd = max_send_master_cmd;\n\tdvb->fe->ops.diseqc_send_burst = max_send_burst;\n\tdvb->fe->sec_priv = input;\n\tdvb->input = tuner;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}