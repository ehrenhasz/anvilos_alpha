{
  "module_name": "cx88-dsp.c",
  "hash_id": "71604a9424ff1856f3528f80e12e9e312748468f0963224ed683fc3ed2af729b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/pci/cx88/cx88-dsp.c",
  "human_readable_source": "\n \n\n#include \"cx88.h\"\n#include \"cx88-reg.h\"\n\n#include <linux/slab.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/jiffies.h>\n#include <asm/div64.h>\n\n#define INT_PI\t\t\t((s32)(3.141592653589 * 32768.0))\n\n#define compat_remainder(a, b) \\\n\t ((float)(((s32)((a) * 100)) % ((s32)((b) * 100))) / 100.0)\n\n#define baseband_freq(carrier, srate, tone) ((s32)( \\\n\t (compat_remainder(carrier + tone, srate)) / srate * 2 * INT_PI))\n\n \n\n#define FREQ_A2_CARRIER         baseband_freq(54687.5, 2689.36, 0.0)\n#define FREQ_A2_DUAL            baseband_freq(54687.5, 2689.36, 274.1)\n#define FREQ_A2_STEREO          baseband_freq(54687.5, 2689.36, 117.5)\n\n \n\n#define FREQ_A2M_CARRIER\t((s32)(2.114516 * 32768.0))\n#define FREQ_A2M_DUAL\t\t((s32)(2.754916 * 32768.0))\n#define FREQ_A2M_STEREO\t\t((s32)(2.462326 * 32768.0))\n\n#define FREQ_EIAJ_CARRIER\t((s32)(1.963495 * 32768.0))  \n#define FREQ_EIAJ_DUAL\t\t((s32)(2.562118 * 32768.0))\n#define FREQ_EIAJ_STEREO\t((s32)(2.601053 * 32768.0))\n\n#define FREQ_BTSC_DUAL\t\t((s32)(1.963495 * 32768.0))  \n#define FREQ_BTSC_DUAL_REF\t((s32)(1.374446 * 32768.0))  \n\n#define FREQ_BTSC_SAP\t\t((s32)(2.471532 * 32768.0))\n#define FREQ_BTSC_SAP_REF\t((s32)(1.730072 * 32768.0))\n\n \n#define FREQ_NOISE_START\t((s32)(0.100000 * 32768.0))\n#define FREQ_NOISE_END\t\t((s32)(1.200000 * 32768.0))\n\nstatic unsigned int dsp_debug;\nmodule_param(dsp_debug, int, 0644);\nMODULE_PARM_DESC(dsp_debug, \"enable audio dsp debug messages\");\n\n#define dprintk(level, fmt, arg...) do {\t\t\t\t\\\n\tif (dsp_debug >= level)\t\t\t\t\t\t\\\n\t\tprintk(KERN_DEBUG pr_fmt(\"%s: dsp:\" fmt),\t\t\\\n\t\t\t__func__, ##arg);\t\t\t\t\\\n} while (0)\n\nstatic s32 int_cos(u32 x)\n{\n\tu32 t2, t4, t6, t8;\n\ts32 ret;\n\tu16 period = x / INT_PI;\n\n\tif (period % 2)\n\t\treturn -int_cos(x - INT_PI);\n\tx = x % INT_PI;\n\tif (x > INT_PI / 2)\n\t\treturn -int_cos(INT_PI / 2 - (x % (INT_PI / 2)));\n\t \n\tt2 = x * x / 32768 / 2;\n\tt4 = t2 * x / 32768 * x / 32768 / 3 / 4;\n\tt6 = t4 * x / 32768 * x / 32768 / 5 / 6;\n\tt8 = t6 * x / 32768 * x / 32768 / 7 / 8;\n\tret = 32768 - t2 + t4 - t6 + t8;\n\treturn ret;\n}\n\nstatic u32 int_goertzel(s16 x[], u32 N, u32 freq)\n{\n\t \n\ts32 s_prev = 0;\n\ts32 s_prev2 = 0;\n\ts32 coeff = 2 * int_cos(freq);\n\tu32 i;\n\n\tu64 tmp;\n\tu32 divisor;\n\n\tfor (i = 0; i < N; i++) {\n\t\ts32 s = x[i] + ((s64)coeff * s_prev / 32768) - s_prev2;\n\n\t\ts_prev2 = s_prev;\n\t\ts_prev = s;\n\t}\n\n\ttmp = (s64)s_prev2 * s_prev2 + (s64)s_prev * s_prev -\n\t\t      (s64)coeff * s_prev2 * s_prev / 32768;\n\n\t \n\tdivisor = N * N;\n\tdo_div(tmp, divisor);\n\n\treturn (u32)tmp;\n}\n\nstatic u32 freq_magnitude(s16 x[], u32 N, u32 freq)\n{\n\tu32 sum = int_goertzel(x, N, freq);\n\n\treturn (u32)int_sqrt(sum);\n}\n\nstatic u32 noise_magnitude(s16 x[], u32 N, u32 freq_start, u32 freq_end)\n{\n\tint i;\n\tu32 sum = 0;\n\tu32 freq_step;\n\tint samples = 5;\n\n\tif (N > 192) {\n\t\t \n\t\tx += (N - 192);\n\t\tN = 192;\n\t}\n\n\tfreq_step = (freq_end - freq_start) / (samples - 1);\n\n\tfor (i = 0; i < samples; i++) {\n\t\tsum += int_goertzel(x, N, freq_start);\n\t\tfreq_start += freq_step;\n\t}\n\n\treturn (u32)int_sqrt(sum / samples);\n}\n\nstatic s32 detect_a2_a2m_eiaj(struct cx88_core *core, s16 x[], u32 N)\n{\n\ts32 carrier, stereo, dual, noise;\n\ts32 carrier_freq, stereo_freq, dual_freq;\n\ts32 ret;\n\n\tswitch (core->tvaudio) {\n\tcase WW_BG:\n\tcase WW_DK:\n\t\tcarrier_freq = FREQ_A2_CARRIER;\n\t\tstereo_freq = FREQ_A2_STEREO;\n\t\tdual_freq = FREQ_A2_DUAL;\n\t\tbreak;\n\tcase WW_M:\n\t\tcarrier_freq = FREQ_A2M_CARRIER;\n\t\tstereo_freq = FREQ_A2M_STEREO;\n\t\tdual_freq = FREQ_A2M_DUAL;\n\t\tbreak;\n\tcase WW_EIAJ:\n\t\tcarrier_freq = FREQ_EIAJ_CARRIER;\n\t\tstereo_freq = FREQ_EIAJ_STEREO;\n\t\tdual_freq = FREQ_EIAJ_DUAL;\n\t\tbreak;\n\tdefault:\n\t\tpr_warn(\"unsupported audio mode %d for %s\\n\",\n\t\t\tcore->tvaudio, __func__);\n\t\treturn UNSET;\n\t}\n\n\tcarrier = freq_magnitude(x, N, carrier_freq);\n\tstereo  = freq_magnitude(x, N, stereo_freq);\n\tdual    = freq_magnitude(x, N, dual_freq);\n\tnoise   = noise_magnitude(x, N, FREQ_NOISE_START, FREQ_NOISE_END);\n\n\tdprintk(1,\n\t\t\"detect a2/a2m/eiaj: carrier=%d, stereo=%d, dual=%d, noise=%d\\n\",\n\t\tcarrier, stereo, dual, noise);\n\n\tif (stereo > dual)\n\t\tret = V4L2_TUNER_SUB_STEREO;\n\telse\n\t\tret = V4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_LANG2;\n\n\tif (core->tvaudio == WW_EIAJ) {\n\t\t \n\t\tif ((carrier > max(stereo, dual) * 2) &&\n\t\t    (carrier < max(stereo, dual) * 6) &&\n\t\t    (carrier > 20 && carrier < 200) &&\n\t\t    (max(stereo, dual) > min(stereo, dual))) {\n\t\t\t \n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tif ((carrier > max(stereo, dual) * 2) &&\n\t\t    (carrier < max(stereo, dual) * 8) &&\n\t\t    (carrier > 20 && carrier < 200) &&\n\t\t    (noise < 10) &&\n\t\t    (max(stereo, dual) > min(stereo, dual) * 2)) {\n\t\t\treturn ret;\n\t\t}\n\t}\n\treturn V4L2_TUNER_SUB_MONO;\n}\n\nstatic s32 detect_btsc(struct cx88_core *core, s16 x[], u32 N)\n{\n\ts32 sap_ref = freq_magnitude(x, N, FREQ_BTSC_SAP_REF);\n\ts32 sap = freq_magnitude(x, N, FREQ_BTSC_SAP);\n\ts32 dual_ref = freq_magnitude(x, N, FREQ_BTSC_DUAL_REF);\n\ts32 dual = freq_magnitude(x, N, FREQ_BTSC_DUAL);\n\n\tdprintk(1, \"detect btsc: dual_ref=%d, dual=%d, sap_ref=%d, sap=%d\\n\",\n\t\tdual_ref, dual, sap_ref, sap);\n\t \n\treturn UNSET;\n}\n\nstatic s16 *read_rds_samples(struct cx88_core *core, u32 *N)\n{\n\tconst struct sram_channel *srch = &cx88_sram_channels[SRAM_CH27];\n\ts16 *samples;\n\n\tunsigned int i;\n\tunsigned int bpl = srch->fifo_size / AUD_RDS_LINES;\n\tunsigned int spl = bpl / 4;\n\tunsigned int sample_count = spl * (AUD_RDS_LINES - 1);\n\n\tu32 current_address = cx_read(srch->ptr1_reg);\n\tu32 offset = (current_address - srch->fifo_start + bpl);\n\n\tdprintk(1,\n\t\t\"read RDS samples: current_address=%08x (offset=%08x), sample_count=%d, aud_intstat=%08x\\n\",\n\t\tcurrent_address,\n\t\tcurrent_address - srch->fifo_start, sample_count,\n\t\tcx_read(MO_AUD_INTSTAT));\n\tsamples = kmalloc_array(sample_count, sizeof(*samples), GFP_KERNEL);\n\tif (!samples)\n\t\treturn NULL;\n\n\t*N = sample_count;\n\n\tfor (i = 0; i < sample_count; i++)  {\n\t\toffset = offset % (AUD_RDS_LINES * bpl);\n\t\tsamples[i] = cx_read(srch->fifo_start + offset);\n\t\toffset += 4;\n\t}\n\n\tdprintk(2, \"RDS samples dump: %*ph\\n\", sample_count, samples);\n\n\treturn samples;\n}\n\ns32 cx88_dsp_detect_stereo_sap(struct cx88_core *core)\n{\n\ts16 *samples;\n\tu32 N = 0;\n\ts32 ret = UNSET;\n\n\t \n\tif (!(cx_read(MO_AUD_DMACNTRL) & 0x04))\n\t\treturn ret;\n\tif (!(cx_read(AUD_CTL) & EN_FMRADIO_EN_RDS))\n\t\treturn ret;\n\n\t \n\tif (time_before(jiffies, core->last_change + msecs_to_jiffies(500)))\n\t\treturn ret;\n\n\tsamples = read_rds_samples(core, &N);\n\n\tif (!samples)\n\t\treturn ret;\n\n\tswitch (core->tvaudio) {\n\tcase WW_BG:\n\tcase WW_DK:\n\tcase WW_EIAJ:\n\tcase WW_M:\n\t\tret = detect_a2_a2m_eiaj(core, samples, N);\n\t\tbreak;\n\tcase WW_BTSC:\n\t\tret = detect_btsc(core, samples, N);\n\t\tbreak;\n\tcase WW_NONE:\n\tcase WW_I:\n\tcase WW_L:\n\tcase WW_I2SPT:\n\tcase WW_FM:\n\tcase WW_I2SADC:\n\t\tbreak;\n\t}\n\n\tkfree(samples);\n\n\tif (ret != UNSET)\n\t\tdprintk(1, \"stereo/sap detection result:%s%s%s\\n\",\n\t\t\t(ret & V4L2_TUNER_SUB_MONO) ? \" mono\" : \"\",\n\t\t\t(ret & V4L2_TUNER_SUB_STEREO) ? \" stereo\" : \"\",\n\t\t\t(ret & V4L2_TUNER_SUB_LANG2) ? \" dual\" : \"\");\n\n\treturn ret;\n}\nEXPORT_SYMBOL(cx88_dsp_detect_stereo_sap);\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}