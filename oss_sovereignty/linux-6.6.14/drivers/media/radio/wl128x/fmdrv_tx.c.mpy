{
  "module_name": "fmdrv_tx.c",
  "hash_id": "d0c38fdf451ad5f59e04f3f6c9f0326e3a39f5d58bfa187201ae1ac114ffd490",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/radio/wl128x/fmdrv_tx.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include \"fmdrv.h\"\n#include \"fmdrv_common.h\"\n#include \"fmdrv_tx.h\"\n\nint fm_tx_set_stereo_mono(struct fmdev *fmdev, u16 mode)\n{\n\tu16 payload;\n\tint ret;\n\n\tif (fmdev->tx_data.aud_mode == mode)\n\t\treturn 0;\n\n\tfmdbg(\"stereo mode: %d\\n\", mode);\n\n\t \n\tpayload = (1 - mode);\n\tret = fmc_send_cmd(fmdev, MONO_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfmdev->tx_data.aud_mode = mode;\n\n\treturn ret;\n}\n\nstatic int set_rds_text(struct fmdev *fmdev, u8 *rds_text)\n{\n\tu16 payload;\n\tint ret;\n\n\tret = fmc_send_cmd(fmdev, RDS_DATA_SET, REG_WR, rds_text,\n\t\t\tstrlen(rds_text), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tpayload = (u16)0x1;\n\tret = fmc_send_cmd(fmdev, DISPLAY_MODE, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int set_rds_data_mode(struct fmdev *fmdev, u8 mode)\n{\n\tu16 payload;\n\tint ret;\n\n\t \n\tpayload = (u16)0xcafe;\n\tret = fmc_send_cmd(fmdev, PI_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tpayload = (u16)0xa;\n\tret = fmc_send_cmd(fmdev, DI_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\treturn 0;\n}\n\nstatic int set_rds_len(struct fmdev *fmdev, u8 type, u16 len)\n{\n\tu16 payload;\n\tint ret;\n\n\tlen |= type << 8;\n\tpayload = len;\n\tret = fmc_send_cmd(fmdev, RDS_CONFIG_DATA_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\treturn 0;\n}\n\nint fm_tx_set_rds_mode(struct fmdev *fmdev, u8 rds_en_dis)\n{\n\tu16 payload;\n\tint ret;\n\tu8 rds_text[] = \"Zoom2\\n\";\n\n\tfmdbg(\"rds_en_dis:%d(E:%d, D:%d)\\n\", rds_en_dis,\n\t\t   FM_RDS_ENABLE, FM_RDS_DISABLE);\n\n\tif (rds_en_dis == FM_RDS_ENABLE) {\n\t\t \n\t\tset_rds_len(fmdev, 0, strlen(rds_text));\n\n\t\t \n\t\tset_rds_text(fmdev, rds_text);\n\n\t\t \n\t\tset_rds_data_mode(fmdev, 0x0);\n\t}\n\n\t \n\tif (rds_en_dis == FM_RDS_ENABLE)\n\t\tpayload = 0x01;\n\telse\n\t\tpayload = 0x00;\n\n\tret = fmc_send_cmd(fmdev, RDS_DATA_ENB, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (rds_en_dis == FM_RDS_ENABLE) {\n\t\t \n\t\tset_rds_len(fmdev, 0, strlen(rds_text));\n\n\t\t \n\t\tset_rds_text(fmdev, rds_text);\n\t}\n\tfmdev->tx_data.rds.flag = rds_en_dis;\n\n\treturn 0;\n}\n\nint fm_tx_set_radio_text(struct fmdev *fmdev, u8 *rds_text, u8 rds_type)\n{\n\tu16 payload;\n\tint ret;\n\n\tif (fmdev->curr_fmmode != FM_MODE_TX)\n\t\treturn -EPERM;\n\n\tfm_tx_set_rds_mode(fmdev, 0);\n\n\t \n\tset_rds_len(fmdev, rds_type, strlen(rds_text));\n\n\t \n\tset_rds_text(fmdev, rds_text);\n\n\t \n\tset_rds_data_mode(fmdev, 0x0);\n\n\tpayload = 1;\n\tret = fmc_send_cmd(fmdev, RDS_DATA_ENB, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nint fm_tx_set_af(struct fmdev *fmdev, u32 af)\n{\n\tu16 payload;\n\tint ret;\n\n\tif (fmdev->curr_fmmode != FM_MODE_TX)\n\t\treturn -EPERM;\n\n\tfmdbg(\"AF: %d\\n\", af);\n\n\taf = (af - 87500) / 100;\n\tpayload = (u16)af;\n\tret = fmc_send_cmd(fmdev, TA_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nint fm_tx_set_region(struct fmdev *fmdev, u8 region)\n{\n\tu16 payload;\n\tint ret;\n\n\tif (region != FM_BAND_EUROPE_US && region != FM_BAND_JAPAN) {\n\t\tfmerr(\"Invalid band\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tpayload = (u16)region;\n\tret = fmc_send_cmd(fmdev, TX_BAND_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nint fm_tx_set_mute_mode(struct fmdev *fmdev, u8 mute_mode_toset)\n{\n\tu16 payload;\n\tint ret;\n\n\tfmdbg(\"tx: mute mode %d\\n\", mute_mode_toset);\n\n\tpayload = mute_mode_toset;\n\tret = fmc_send_cmd(fmdev, MUTE, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\n \nstatic int set_audio_io(struct fmdev *fmdev)\n{\n\tstruct fmtx_data *tx = &fmdev->tx_data;\n\tu16 payload;\n\tint ret;\n\n\t \n\tpayload = tx->audio_io;\n\tret = fmc_send_cmd(fmdev, AUDIO_IO_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\treturn 0;\n}\n\n \nstatic int enable_xmit(struct fmdev *fmdev, u8 new_xmit_state)\n{\n\tstruct fmtx_data *tx = &fmdev->tx_data;\n\tunsigned long timeleft;\n\tu16 payload;\n\tint ret;\n\n\t \n\tpayload = FM_POW_ENB_EVENT;\n\tret = fmc_send_cmd(fmdev, INT_MASK_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tpayload = new_xmit_state;\n\tret = fmc_send_cmd(fmdev, POWER_ENB_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tinit_completion(&fmdev->maintask_comp);\n\ttimeleft = wait_for_completion_timeout(&fmdev->maintask_comp,\n\t\t\tFM_DRV_TX_TIMEOUT);\n\tif (!timeleft) {\n\t\tfmerr(\"Timeout(%d sec),didn't get tune ended interrupt\\n\",\n\t\t\t   jiffies_to_msecs(FM_DRV_TX_TIMEOUT) / 1000);\n\t\treturn -ETIMEDOUT;\n\t}\n\n\tset_bit(FM_CORE_TX_XMITING, &fmdev->flag);\n\ttx->xmit_state = new_xmit_state;\n\n\treturn 0;\n}\n\n \nint fm_tx_set_pwr_lvl(struct fmdev *fmdev, u8 new_pwr_lvl)\n{\n\tu16 payload;\n\tstruct fmtx_data *tx = &fmdev->tx_data;\n\tint ret;\n\n\tif (fmdev->curr_fmmode != FM_MODE_TX)\n\t\treturn -EPERM;\n\tfmdbg(\"tx: pwr_level_to_set %ld\\n\", (long int)new_pwr_lvl);\n\n\t \n\tif (!test_bit(FM_CORE_READY, &fmdev->flag)) {\n\t\ttx->pwr_lvl = new_pwr_lvl;\n\t\treturn 0;\n\t}\n\n\t \n\n\tpayload = (FM_PWR_LVL_HIGH - new_pwr_lvl);\n\tret = fmc_send_cmd(fmdev, POWER_LEV_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\ttx->pwr_lvl = new_pwr_lvl;\n\n\treturn 0;\n}\n\n \nint fm_tx_set_preemph_filter(struct fmdev *fmdev, u32 preemphasis)\n{\n\tstruct fmtx_data *tx = &fmdev->tx_data;\n\tu16 payload;\n\tint ret;\n\n\tif (fmdev->curr_fmmode != FM_MODE_TX)\n\t\treturn -EPERM;\n\n\tswitch (preemphasis) {\n\tcase V4L2_PREEMPHASIS_DISABLED:\n\t\tpayload = FM_TX_PREEMPH_OFF;\n\t\tbreak;\n\tcase V4L2_PREEMPHASIS_50_uS:\n\t\tpayload = FM_TX_PREEMPH_50US;\n\t\tbreak;\n\tcase V4L2_PREEMPHASIS_75_uS:\n\t\tpayload = FM_TX_PREEMPH_75US;\n\t\tbreak;\n\t}\n\n\tret = fmc_send_cmd(fmdev, PREMPH_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\ttx->preemph = payload;\n\n\treturn ret;\n}\n\n \nint fm_tx_get_tune_cap_val(struct fmdev *fmdev)\n{\n\tu16 curr_val;\n\tu32 resp_len;\n\tint ret;\n\n\tif (fmdev->curr_fmmode != FM_MODE_TX)\n\t\treturn -EPERM;\n\n\tret = fmc_send_cmd(fmdev, READ_FMANT_TUNE_VALUE, REG_RD,\n\t\t\tNULL, sizeof(curr_val), &curr_val, &resp_len);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tcurr_val = be16_to_cpu((__force __be16)curr_val);\n\n\treturn curr_val;\n}\n\n \nint fm_tx_set_freq(struct fmdev *fmdev, u32 freq_to_set)\n{\n\tstruct fmtx_data *tx = &fmdev->tx_data;\n\tu16 payload, chanl_index;\n\tint ret;\n\n\tif (test_bit(FM_CORE_TX_XMITING, &fmdev->flag)) {\n\t\tenable_xmit(fmdev, 0);\n\t\tclear_bit(FM_CORE_TX_XMITING, &fmdev->flag);\n\t}\n\n\t \n\tpayload = (FM_FR_EVENT | FM_BL_EVENT);\n\tret = fmc_send_cmd(fmdev, INT_MASK_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\ttx->tx_frq = (unsigned long)freq_to_set;\n\tfmdbg(\"tx: freq_to_set %ld\\n\", (long int)tx->tx_frq);\n\n\tchanl_index = freq_to_set / 10;\n\n\t \n\tpayload = chanl_index;\n\tret = fmc_send_cmd(fmdev, CHANL_SET, REG_WR, &payload,\n\t\t\tsizeof(payload), NULL, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfm_tx_set_pwr_lvl(fmdev, tx->pwr_lvl);\n\tfm_tx_set_preemph_filter(fmdev, tx->preemph);\n\n\ttx->audio_io = 0x01;\t \n\tset_audio_io(fmdev);\n\n\tenable_xmit(fmdev, 0x01);\t \n\n\ttx->aud_mode = FM_STEREO_MODE;\n\ttx->rds.flag = FM_RDS_DISABLE;\n\n\treturn 0;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}