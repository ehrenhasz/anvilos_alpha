{
  "module_name": "radio-typhoon.c",
  "hash_id": "cff390e615e87cb18c54b7484a603f2599bcc47b9c59901eabdf4734776fcf17",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/radio/radio-typhoon.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\t \n#include <linux/init.h>\t\t \n#include <linux/ioport.h>\t \n#include <linux/videodev2.h>\t \n#include <linux/io.h>\t\t \n#include <linux/slab.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ioctl.h>\n#include \"radio-isa.h\"\n\n#define DRIVER_VERSION \"0.1.2\"\n\nMODULE_AUTHOR(\"Dr. Henrik Seidel\");\nMODULE_DESCRIPTION(\"A driver for the Typhoon radio card (a.k.a. EcoRadio).\");\nMODULE_LICENSE(\"GPL\");\nMODULE_VERSION(\"0.1.99\");\n\n#ifndef CONFIG_RADIO_TYPHOON_PORT\n#define CONFIG_RADIO_TYPHOON_PORT -1\n#endif\n\n#ifndef CONFIG_RADIO_TYPHOON_MUTEFREQ\n#define CONFIG_RADIO_TYPHOON_MUTEFREQ 87000\n#endif\n\n#define TYPHOON_MAX 2\n\nstatic int io[TYPHOON_MAX] = { [0] = CONFIG_RADIO_TYPHOON_PORT,\n\t\t\t      [1 ... (TYPHOON_MAX - 1)] = -1 };\nstatic int radio_nr[TYPHOON_MAX]\t= { [0 ... (TYPHOON_MAX - 1)] = -1 };\nstatic unsigned long mutefreq = CONFIG_RADIO_TYPHOON_MUTEFREQ;\n\nmodule_param_array(io, int, NULL, 0444);\nMODULE_PARM_DESC(io, \"I/O addresses of the Typhoon card (0x316 or 0x336)\");\nmodule_param_array(radio_nr, int, NULL, 0444);\nMODULE_PARM_DESC(radio_nr, \"Radio device numbers\");\nmodule_param(mutefreq, ulong, 0);\nMODULE_PARM_DESC(mutefreq, \"Frequency used when muting the card (in kHz)\");\n\nstruct typhoon {\n\tstruct radio_isa_card isa;\n\tint muted;\n};\n\nstatic struct radio_isa_card *typhoon_alloc(void)\n{\n\tstruct typhoon *ty = kzalloc(sizeof(*ty), GFP_KERNEL);\n\n\treturn ty ? &ty->isa : NULL;\n}\n\nstatic int typhoon_s_frequency(struct radio_isa_card *isa, u32 freq)\n{\n\tunsigned long outval;\n\tunsigned long x;\n\n\t \n\n\tx = freq / 160;\n\toutval = (x * x + 2500) / 5000;\n\toutval = (outval * x + 5000) / 10000;\n\toutval -= (10 * x * x + 10433) / 20866;\n\toutval += 4 * x - 11505;\n\n\toutb_p((outval >> 8) & 0x01, isa->io + 4);\n\toutb_p(outval >> 9, isa->io + 6);\n\toutb_p(outval & 0xff, isa->io + 8);\n\treturn 0;\n}\n\nstatic int typhoon_s_mute_volume(struct radio_isa_card *isa, bool mute, int vol)\n{\n\tstruct typhoon *ty = container_of(isa, struct typhoon, isa);\n\n\tif (mute)\n\t\tvol = 0;\n\tvol >>= 14;\t\t\t \n\tvol &= 3;\n\toutb_p(vol / 2, isa->io);\t \n\toutb_p(vol % 2, isa->io + 2);\t \n\n\tif (vol == 0 && !ty->muted) {\n\t\tty->muted = true;\n\t\treturn typhoon_s_frequency(isa, mutefreq << 4);\n\t}\n\tif (vol && ty->muted) {\n\t\tty->muted = false;\n\t\treturn typhoon_s_frequency(isa, isa->freq);\n\t}\n\treturn 0;\n}\n\nstatic const struct radio_isa_ops typhoon_ops = {\n\t.alloc = typhoon_alloc,\n\t.s_mute_volume = typhoon_s_mute_volume,\n\t.s_frequency = typhoon_s_frequency,\n};\n\nstatic const int typhoon_ioports[] = { 0x316, 0x336 };\n\nstatic struct radio_isa_driver typhoon_driver = {\n\t.driver = {\n\t\t.match\t\t= radio_isa_match,\n\t\t.probe\t\t= radio_isa_probe,\n\t\t.remove\t\t= radio_isa_remove,\n\t\t.driver\t\t= {\n\t\t\t.name\t= \"radio-typhoon\",\n\t\t},\n\t},\n\t.io_params = io,\n\t.radio_nr_params = radio_nr,\n\t.io_ports = typhoon_ioports,\n\t.num_of_io_ports = ARRAY_SIZE(typhoon_ioports),\n\t.region_size = 8,\n\t.card = \"Typhoon Radio\",\n\t.ops = &typhoon_ops,\n\t.has_stereo = true,\n\t.max_volume = 3,\n};\n\nstatic int __init typhoon_init(void)\n{\n\tif (mutefreq < 87000 || mutefreq > 108000) {\n\t\tprintk(KERN_ERR \"%s: You must set a frequency (in kHz) used when muting the card,\\n\",\n\t\t\t\ttyphoon_driver.driver.driver.name);\n\t\tprintk(KERN_ERR \"%s: e.g. with \\\"mutefreq=87500\\\" (87000 <= mutefreq <= 108000)\\n\",\n\t\t\t\ttyphoon_driver.driver.driver.name);\n\t\treturn -ENODEV;\n\t}\n\treturn isa_register_driver(&typhoon_driver.driver, TYPHOON_MAX);\n}\n\nstatic void __exit typhoon_exit(void)\n{\n\tisa_unregister_driver(&typhoon_driver.driver);\n}\n\n\nmodule_init(typhoon_init);\nmodule_exit(typhoon_exit);\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}