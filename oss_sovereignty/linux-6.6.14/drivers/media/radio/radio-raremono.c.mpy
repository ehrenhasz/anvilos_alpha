{
  "module_name": "radio-raremono.c",
  "hash_id": "7e9c80c0a8ee4fbb4d3da5b1bff88424032bbbbc91d392bb6b45d1c2a29d47ca",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/radio/radio-raremono.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/input.h>\n#include <linux/usb.h>\n#include <linux/hid.h>\n#include <linux/mutex.h>\n#include <linux/videodev2.h>\n#include <asm/unaligned.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-event.h>\n\n \n\n \nMODULE_AUTHOR(\"Hans Verkuil <hverkuil@xs4all.nl>\");\nMODULE_DESCRIPTION(\"Thanko's Raremono AM/FM/SW Receiver USB driver\");\nMODULE_LICENSE(\"GPL v2\");\n\n \n\n \nstatic const struct usb_device_id usb_raremono_device_table[] = {\n\t{USB_DEVICE_AND_INTERFACE_INFO(0x10c4, 0x818a, USB_CLASS_HID, 0, 0) },\n\t{ }\t\t\t\t\t\t \n};\n\nMODULE_DEVICE_TABLE(usb, usb_raremono_device_table);\n\n#define BUFFER_LENGTH 64\n\n \n#define USB_TIMEOUT 10000\n\n \n#define FM_FREQ_RANGE_LOW\t64000\n#define FM_FREQ_RANGE_HIGH\t108000\n\n#define AM_FREQ_RANGE_LOW\t520\n#define AM_FREQ_RANGE_HIGH\t1710\n\n#define SW_FREQ_RANGE_LOW\t2300\n#define SW_FREQ_RANGE_HIGH\t26100\n\nenum { BAND_FM, BAND_AM, BAND_SW };\n\nstatic const struct v4l2_frequency_band bands[] = {\n\t \n\t{\n\t\t.type = V4L2_TUNER_RADIO,\n\t\t.index = 0,\n\t\t.capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO |\n\t\t\t      V4L2_TUNER_CAP_FREQ_BANDS,\n\t\t.rangelow   = FM_FREQ_RANGE_LOW * 16,\n\t\t.rangehigh  = FM_FREQ_RANGE_HIGH * 16,\n\t\t.modulation = V4L2_BAND_MODULATION_FM,\n\t},\n\t \n\t{\n\t\t.type = V4L2_TUNER_RADIO,\n\t\t.index = 1,\n\t\t.capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_FREQ_BANDS,\n\t\t.rangelow   = AM_FREQ_RANGE_LOW * 16,\n\t\t.rangehigh  = AM_FREQ_RANGE_HIGH * 16,\n\t\t.modulation = V4L2_BAND_MODULATION_AM,\n\t},\n\t \n\t{\n\t\t.type = V4L2_TUNER_RADIO,\n\t\t.index = 2,\n\t\t.capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_FREQ_BANDS,\n\t\t.rangelow   = SW_FREQ_RANGE_LOW * 16,\n\t\t.rangehigh  = SW_FREQ_RANGE_HIGH * 16,\n\t\t.modulation = V4L2_BAND_MODULATION_AM,\n\t},\n};\n\nstruct raremono_device {\n\tstruct usb_device *usbdev;\n\tstruct usb_interface *intf;\n\tstruct video_device vdev;\n\tstruct v4l2_device v4l2_dev;\n\tstruct mutex lock;\n\n\tu8 *buffer;\n\tu32 band;\n\tunsigned curfreq;\n};\n\nstatic inline struct raremono_device *to_raremono_dev(struct v4l2_device *v4l2_dev)\n{\n\treturn container_of(v4l2_dev, struct raremono_device, v4l2_dev);\n}\n\n \nstatic int raremono_cmd_main(struct raremono_device *radio, unsigned band, unsigned freq)\n{\n\tunsigned band_offset;\n\tint ret;\n\n\tswitch (band) {\n\tcase BAND_FM:\n\t\tband_offset = 1;\n\t\tfreq /= 10;\n\t\tbreak;\n\tcase BAND_AM:\n\t\tband_offset = 0;\n\t\tbreak;\n\tdefault:\n\t\tband_offset = 2;\n\t\tbreak;\n\t}\n\tradio->buffer[0] = 0x04 + band_offset;\n\tradio->buffer[1] = freq >> 8;\n\tradio->buffer[2] = freq & 0xff;\n\n\tret = usb_control_msg(radio->usbdev, usb_sndctrlpipe(radio->usbdev, 0),\n\t\t\tHID_REQ_SET_REPORT,\n\t\t\tUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_OUT,\n\t\t\t0x0300 + radio->buffer[0], 2,\n\t\t\tradio->buffer, 3, USB_TIMEOUT);\n\n\tif (ret < 0) {\n\t\tdev_warn(radio->v4l2_dev.dev, \"%s failed (%d)\\n\", __func__, ret);\n\t\treturn ret;\n\t}\n\tradio->curfreq = (band == BAND_FM) ? freq * 10 : freq;\n\treturn 0;\n}\n\n \nstatic void usb_raremono_disconnect(struct usb_interface *intf)\n{\n\tstruct raremono_device *radio = to_raremono_dev(usb_get_intfdata(intf));\n\n\tdev_info(&intf->dev, \"Thanko's Raremono disconnected\\n\");\n\n\tmutex_lock(&radio->lock);\n\tusb_set_intfdata(intf, NULL);\n\tvideo_unregister_device(&radio->vdev);\n\tv4l2_device_disconnect(&radio->v4l2_dev);\n\tmutex_unlock(&radio->lock);\n\tv4l2_device_put(&radio->v4l2_dev);\n}\n\n \nstatic int vidioc_querycap(struct file *file, void *priv,\n\t\t\t\t\tstruct v4l2_capability *v)\n{\n\tstruct raremono_device *radio = video_drvdata(file);\n\n\tstrscpy(v->driver, \"radio-raremono\", sizeof(v->driver));\n\tstrscpy(v->card, \"Thanko's Raremono\", sizeof(v->card));\n\tusb_make_path(radio->usbdev, v->bus_info, sizeof(v->bus_info));\n\treturn 0;\n}\n\nstatic int vidioc_enum_freq_bands(struct file *file, void *priv,\n\t\tstruct v4l2_frequency_band *band)\n{\n\tif (band->tuner != 0)\n\t\treturn -EINVAL;\n\n\tif (band->index >= ARRAY_SIZE(bands))\n\t\treturn -EINVAL;\n\n\t*band = bands[band->index];\n\n\treturn 0;\n}\n\nstatic int vidioc_g_tuner(struct file *file, void *priv,\n\t\tstruct v4l2_tuner *v)\n{\n\tstruct raremono_device *radio = video_drvdata(file);\n\tint ret;\n\n\tif (v->index > 0)\n\t\treturn -EINVAL;\n\n\tstrscpy(v->name, \"AM/FM/SW\", sizeof(v->name));\n\tv->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO |\n\t\tV4L2_TUNER_CAP_FREQ_BANDS;\n\tv->rangelow = AM_FREQ_RANGE_LOW * 16;\n\tv->rangehigh = FM_FREQ_RANGE_HIGH * 16;\n\tv->rxsubchans = V4L2_TUNER_SUB_STEREO | V4L2_TUNER_SUB_MONO;\n\tv->audmode = (radio->curfreq < FM_FREQ_RANGE_LOW) ?\n\t\tV4L2_TUNER_MODE_MONO : V4L2_TUNER_MODE_STEREO;\n\tmemset(radio->buffer, 1, BUFFER_LENGTH);\n\tret = usb_control_msg(radio->usbdev, usb_rcvctrlpipe(radio->usbdev, 0),\n\t\t\t1, 0xa1, 0x030d, 2, radio->buffer, BUFFER_LENGTH, USB_TIMEOUT);\n\n\tif (ret < 0) {\n\t\tdev_warn(radio->v4l2_dev.dev, \"%s failed (%d)\\n\", __func__, ret);\n\t\treturn ret;\n\t}\n\tv->signal = ((radio->buffer[1] & 0xf) << 8 | radio->buffer[2]) << 4;\n\treturn 0;\n}\n\nstatic int vidioc_s_tuner(struct file *file, void *priv,\n\t\t\t\t\tconst struct v4l2_tuner *v)\n{\n\treturn v->index ? -EINVAL : 0;\n}\n\nstatic int vidioc_s_frequency(struct file *file, void *priv,\n\t\t\t\tconst struct v4l2_frequency *f)\n{\n\tstruct raremono_device *radio = video_drvdata(file);\n\tu32 freq;\n\tunsigned band;\n\n\tif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\n\t\treturn -EINVAL;\n\n\tif (f->frequency >= (FM_FREQ_RANGE_LOW + SW_FREQ_RANGE_HIGH) * 8)\n\t\tband = BAND_FM;\n\telse if (f->frequency <= (AM_FREQ_RANGE_HIGH + SW_FREQ_RANGE_LOW) * 8)\n\t\tband = BAND_AM;\n\telse\n\t\tband = BAND_SW;\n\n\tfreq = clamp_t(u32, f->frequency, bands[band].rangelow, bands[band].rangehigh);\n\treturn raremono_cmd_main(radio, band, freq / 16);\n}\n\nstatic int vidioc_g_frequency(struct file *file, void *priv,\n\t\t\t\tstruct v4l2_frequency *f)\n{\n\tstruct raremono_device *radio = video_drvdata(file);\n\n\tif (f->tuner != 0)\n\t\treturn -EINVAL;\n\tf->type = V4L2_TUNER_RADIO;\n\tf->frequency = radio->curfreq * 16;\n\treturn 0;\n}\n\nstatic void raremono_device_release(struct v4l2_device *v4l2_dev)\n{\n\tstruct raremono_device *radio = to_raremono_dev(v4l2_dev);\n\n\tkfree(radio->buffer);\n\tkfree(radio);\n}\n\n \nstatic const struct v4l2_file_operations usb_raremono_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.open           = v4l2_fh_open,\n\t.release        = v4l2_fh_release,\n\t.unlocked_ioctl\t= video_ioctl2,\n};\n\nstatic const struct v4l2_ioctl_ops usb_raremono_ioctl_ops = {\n\t.vidioc_querycap = vidioc_querycap,\n\t.vidioc_g_tuner = vidioc_g_tuner,\n\t.vidioc_s_tuner = vidioc_s_tuner,\n\t.vidioc_g_frequency = vidioc_g_frequency,\n\t.vidioc_s_frequency = vidioc_s_frequency,\n\t.vidioc_enum_freq_bands = vidioc_enum_freq_bands,\n};\n\n \nstatic int usb_raremono_probe(struct usb_interface *intf,\n\t\t\t\tconst struct usb_device_id *id)\n{\n\tstruct raremono_device *radio;\n\tint retval = 0;\n\n\tradio = kzalloc(sizeof(*radio), GFP_KERNEL);\n\tif (!radio)\n\t\treturn -ENOMEM;\n\tradio->buffer = kmalloc(BUFFER_LENGTH, GFP_KERNEL);\n\tif (!radio->buffer) {\n\t\tkfree(radio);\n\t\treturn -ENOMEM;\n\t}\n\n\tradio->usbdev = interface_to_usbdev(intf);\n\tradio->intf = intf;\n\n\t \n\tmsleep(20);\n\tretval = usb_control_msg(radio->usbdev,\n\t\tusb_rcvctrlpipe(radio->usbdev, 0),\n\t\tHID_REQ_GET_REPORT,\n\t\tUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_IN,\n\t\t1, 2,\n\t\tradio->buffer, 3, 500);\n\tif (retval != 3 ||\n\t    (get_unaligned_be16(&radio->buffer[1]) & 0xfff) == 0x0242) {\n\t\tdev_info(&intf->dev, \"this is not Thanko's Raremono.\\n\");\n\t\tretval = -ENODEV;\n\t\tgoto free_mem;\n\t}\n\n\tdev_info(&intf->dev, \"Thanko's Raremono connected: (%04X:%04X)\\n\",\n\t\t\tid->idVendor, id->idProduct);\n\n\tretval = v4l2_device_register(&intf->dev, &radio->v4l2_dev);\n\tif (retval < 0) {\n\t\tdev_err(&intf->dev, \"couldn't register v4l2_device\\n\");\n\t\tgoto free_mem;\n\t}\n\n\tmutex_init(&radio->lock);\n\n\tstrscpy(radio->vdev.name, radio->v4l2_dev.name,\n\t\tsizeof(radio->vdev.name));\n\tradio->vdev.v4l2_dev = &radio->v4l2_dev;\n\tradio->vdev.fops = &usb_raremono_fops;\n\tradio->vdev.ioctl_ops = &usb_raremono_ioctl_ops;\n\tradio->vdev.lock = &radio->lock;\n\tradio->vdev.release = video_device_release_empty;\n\tradio->vdev.device_caps = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\n\tradio->v4l2_dev.release = raremono_device_release;\n\n\tusb_set_intfdata(intf, &radio->v4l2_dev);\n\n\tvideo_set_drvdata(&radio->vdev, radio);\n\n\traremono_cmd_main(radio, BAND_FM, 95160);\n\n\tretval = video_register_device(&radio->vdev, VFL_TYPE_RADIO, -1);\n\tif (retval == 0) {\n\t\tdev_info(&intf->dev, \"V4L2 device registered as %s\\n\",\n\t\t\t\tvideo_device_node_name(&radio->vdev));\n\t\treturn 0;\n\t}\n\tdev_err(&intf->dev, \"could not register video device\\n\");\n\tv4l2_device_unregister(&radio->v4l2_dev);\n\nfree_mem:\n\tkfree(radio->buffer);\n\tkfree(radio);\n\treturn retval;\n}\n\n \nstatic struct usb_driver usb_raremono_driver = {\n\t.name\t\t\t= \"radio-raremono\",\n\t.probe\t\t\t= usb_raremono_probe,\n\t.disconnect\t\t= usb_raremono_disconnect,\n\t.id_table\t\t= usb_raremono_device_table,\n};\n\nmodule_usb_driver(usb_raremono_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}