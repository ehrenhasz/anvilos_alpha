{
  "module_name": "radio-wl1273.c",
  "hash_id": "e226b60686fd2ecb91479f4d1cd8ad2f911c7e366224d278ab8c41bbc0ed3cc4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/radio/radio-wl1273.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/firmware.h>\n#include <linux/interrupt.h>\n#include <linux/mfd/wl1273-core.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <media/v4l2-common.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ioctl.h>\n\n#define DRIVER_DESC \"Wl1273 FM Radio\"\n\n#define WL1273_POWER_SET_OFF\t\t0\n#define WL1273_POWER_SET_FM\t\tBIT(0)\n#define WL1273_POWER_SET_RDS\t\tBIT(1)\n#define WL1273_POWER_SET_RETENTION\tBIT(4)\n\n#define WL1273_PUPD_SET_OFF\t\t0x00\n#define WL1273_PUPD_SET_ON\t\t0x01\n#define WL1273_PUPD_SET_RETENTION\t0x10\n\n#define WL1273_FREQ(x)\t\t(x * 10000 / 625)\n#define WL1273_INV_FREQ(x)\t(x * 625 / 10000)\n\n \nstatic int radio_nr;\nmodule_param(radio_nr, int, 0);\nMODULE_PARM_DESC(radio_nr, \"The number of the radio device. Default = 0\");\n\nstruct wl1273_device {\n\tchar *bus_type;\n\n\tu8 forbidden;\n\tunsigned int preemphasis;\n\tunsigned int spacing;\n\tunsigned int tx_power;\n\tunsigned int rx_frequency;\n\tunsigned int tx_frequency;\n\tunsigned int rangelow;\n\tunsigned int rangehigh;\n\tunsigned int band;\n\tbool stereo;\n\n\t \n\tunsigned int rds_on;\n\n\twait_queue_head_t read_queue;\n\tstruct mutex lock;  \n\tstruct completion busy;\n\n\tunsigned char *buffer;\n\tunsigned int buf_size;\n\tunsigned int rd_index;\n\tunsigned int wr_index;\n\n\t \n\tu16 irq_flags;\n\tu16 irq_received;\n\n\tstruct v4l2_ctrl_handler ctrl_handler;\n\tstruct v4l2_device v4l2dev;\n\tstruct video_device videodev;\n\tstruct device *dev;\n\tstruct wl1273_core *core;\n\tstruct file *owner;\n\tchar *write_buf;\n\tunsigned int rds_users;\n};\n\n#define WL1273_IRQ_MASK\t (WL1273_FR_EVENT\t\t|\t\\\n\t\t\t  WL1273_POW_ENB_EVENT)\n\n \nstatic unsigned int rds_buf = 100;\nmodule_param(rds_buf, uint, 0);\nMODULE_PARM_DESC(rds_buf, \"Number of RDS buffer entries. Default = 100\");\n\nstatic int wl1273_fm_write_fw(struct wl1273_core *core,\n\t\t\t      __u8 *fw, int len)\n{\n\tstruct i2c_client *client = core->client;\n\tstruct i2c_msg msg;\n\tint i, r = 0;\n\n\tmsg.addr = client->addr;\n\tmsg.flags = 0;\n\n\tfor (i = 0; i <= len; i++) {\n\t\tmsg.len = fw[0];\n\t\tmsg.buf = fw + 1;\n\n\t\tfw += msg.len + 1;\n\t\tdev_dbg(&client->dev, \"%s:len[%d]: %d\\n\", __func__, i, msg.len);\n\n\t\tr = i2c_transfer(client->adapter, &msg, 1);\n\t\tif (r < 0 && i < len + 1)\n\t\t\tbreak;\n\t}\n\n\tdev_dbg(&client->dev, \"%s: i: %d\\n\", __func__, i);\n\tdev_dbg(&client->dev, \"%s: len + 1: %d\\n\", __func__, len + 1);\n\n\t \n\tif (i == len || r == 1)\n\t\tr = 0;\n\n\treturn r;\n}\n\n#define WL1273_FIFO_HAS_DATA(status)\t(1 << 5 & status)\n#define WL1273_RDS_CORRECTABLE_ERROR\t(1 << 3)\n#define WL1273_RDS_UNCORRECTABLE_ERROR\t(1 << 4)\n\nstatic int wl1273_fm_rds(struct wl1273_device *radio)\n{\n\tstruct wl1273_core *core = radio->core;\n\tstruct i2c_client *client = core->client;\n\tu16 val;\n\tu8 b0 = WL1273_RDS_DATA_GET, status;\n\tstruct v4l2_rds_data rds = { 0, 0, 0 };\n\tstruct i2c_msg msg[] = {\n\t\t{\n\t\t\t.addr = client->addr,\n\t\t\t.flags = 0,\n\t\t\t.buf = &b0,\n\t\t\t.len = 1,\n\t\t},\n\t\t{\n\t\t\t.addr = client->addr,\n\t\t\t.flags = I2C_M_RD,\n\t\t\t.buf = (u8 *) &rds,\n\t\t\t.len = sizeof(rds),\n\t\t}\n\t};\n\tint r;\n\n\tif (core->mode != WL1273_MODE_RX)\n\t\treturn 0;\n\n\tr = core->read(core, WL1273_RDS_SYNC_GET, &val);\n\tif (r)\n\t\treturn r;\n\n\tif ((val & 0x01) == 0) {\n\t\t \n\t\treturn -EAGAIN;\n\t}\n\n\t \n\tdo {\n\t\tr = i2c_transfer(client->adapter, msg, ARRAY_SIZE(msg));\n\t\tif (r != ARRAY_SIZE(msg)) {\n\t\t\tdev_err(radio->dev, WL1273_FM_DRIVER_NAME\n\t\t\t\t\": %s: read_rds error r == %i)\\n\",\n\t\t\t\t__func__, r);\n\t\t}\n\n\t\tstatus = rds.block;\n\n\t\tif (!WL1273_FIFO_HAS_DATA(status))\n\t\t\tbreak;\n\n\t\t \n\t\trds.block = V4L2_RDS_BLOCK_MSK & status;\n\t\trds.block |= rds.block << 3;\n\n\t\t \n\t\tif (WL1273_RDS_UNCORRECTABLE_ERROR & status) {\n\t\t\trds.block |= V4L2_RDS_BLOCK_ERROR;\n\t\t\trds.block &= ~V4L2_RDS_BLOCK_CORRECTED;\n\t\t} else if  (WL1273_RDS_CORRECTABLE_ERROR & status) {\n\t\t\trds.block &= ~V4L2_RDS_BLOCK_ERROR;\n\t\t\trds.block |= V4L2_RDS_BLOCK_CORRECTED;\n\t\t}\n\n\t\t \n\t\tmemcpy(&radio->buffer[radio->wr_index], &rds, RDS_BLOCK_SIZE);\n\t\tradio->wr_index += 3;\n\n\t\t \n\t\tif (radio->wr_index >= radio->buf_size)\n\t\t\tradio->wr_index = 0;\n\n\t\t \n\t\tif (radio->wr_index == radio->rd_index) {\n\t\t\tdev_dbg(radio->dev, \"RDS OVERFLOW\");\n\n\t\t\tradio->rd_index = 0;\n\t\t\tradio->wr_index = 0;\n\t\t\tbreak;\n\t\t}\n\t} while (WL1273_FIFO_HAS_DATA(status));\n\n\t \n\tif (radio->wr_index != radio->rd_index)\n\t\twake_up_interruptible(&radio->read_queue);\n\n\treturn 0;\n}\n\nstatic irqreturn_t wl1273_fm_irq_thread_handler(int irq, void *dev_id)\n{\n\tstruct wl1273_device *radio = dev_id;\n\tstruct wl1273_core *core = radio->core;\n\tu16 flags;\n\tint r;\n\n\tr = core->read(core, WL1273_FLAG_GET, &flags);\n\tif (r)\n\t\tgoto out;\n\n\tif (flags & WL1273_BL_EVENT) {\n\t\tradio->irq_received = flags;\n\t\tdev_dbg(radio->dev, \"IRQ: BL\\n\");\n\t}\n\n\tif (flags & WL1273_RDS_EVENT) {\n\t\tmsleep(200);\n\n\t\twl1273_fm_rds(radio);\n\t}\n\n\tif (flags & WL1273_BBLK_EVENT)\n\t\tdev_dbg(radio->dev, \"IRQ: BBLK\\n\");\n\n\tif (flags & WL1273_LSYNC_EVENT)\n\t\tdev_dbg(radio->dev, \"IRQ: LSYNC\\n\");\n\n\tif (flags & WL1273_LEV_EVENT) {\n\t\tu16 level;\n\n\t\tr = core->read(core, WL1273_RSSI_LVL_GET, &level);\n\t\tif (r)\n\t\t\tgoto out;\n\n\t\tif (level > 14)\n\t\t\tdev_dbg(radio->dev, \"IRQ: LEV: 0x%x04\\n\", level);\n\t}\n\n\tif (flags & WL1273_IFFR_EVENT)\n\t\tdev_dbg(radio->dev, \"IRQ: IFFR\\n\");\n\n\tif (flags & WL1273_PI_EVENT)\n\t\tdev_dbg(radio->dev, \"IRQ: PI\\n\");\n\n\tif (flags & WL1273_PD_EVENT)\n\t\tdev_dbg(radio->dev, \"IRQ: PD\\n\");\n\n\tif (flags & WL1273_STIC_EVENT)\n\t\tdev_dbg(radio->dev, \"IRQ: STIC\\n\");\n\n\tif (flags & WL1273_MAL_EVENT)\n\t\tdev_dbg(radio->dev, \"IRQ: MAL\\n\");\n\n\tif (flags & WL1273_POW_ENB_EVENT) {\n\t\tcomplete(&radio->busy);\n\t\tdev_dbg(radio->dev, \"NOT BUSY\\n\");\n\t\tdev_dbg(radio->dev, \"IRQ: POW_ENB\\n\");\n\t}\n\n\tif (flags & WL1273_SCAN_OVER_EVENT)\n\t\tdev_dbg(radio->dev, \"IRQ: SCAN_OVER\\n\");\n\n\tif (flags & WL1273_ERROR_EVENT)\n\t\tdev_dbg(radio->dev, \"IRQ: ERROR\\n\");\n\n\tif (flags & WL1273_FR_EVENT) {\n\t\tu16 freq;\n\n\t\tdev_dbg(radio->dev, \"IRQ: FR:\\n\");\n\n\t\tif (core->mode == WL1273_MODE_RX) {\n\t\t\tr = core->write(core, WL1273_TUNER_MODE_SET,\n\t\t\t\t\tTUNER_MODE_STOP_SEARCH);\n\t\t\tif (r) {\n\t\t\t\tdev_err(radio->dev,\n\t\t\t\t\t\"%s: TUNER_MODE_SET fails: %d\\n\",\n\t\t\t\t\t__func__, r);\n\t\t\t\tgoto out;\n\t\t\t}\n\n\t\t\tr = core->read(core, WL1273_FREQ_SET, &freq);\n\t\t\tif (r)\n\t\t\t\tgoto out;\n\n\t\t\tif (radio->band == WL1273_BAND_JAPAN)\n\t\t\t\tradio->rx_frequency = WL1273_BAND_JAPAN_LOW +\n\t\t\t\t\tfreq * 50;\n\t\t\telse\n\t\t\t\tradio->rx_frequency = WL1273_BAND_OTHER_LOW +\n\t\t\t\t\tfreq * 50;\n\t\t\t \n\t\t\tusleep_range(10000, 15000);\n\n\t\t\tdev_dbg(radio->dev, \"%dkHz\\n\", radio->rx_frequency);\n\n\t\t} else {\n\t\t\tr = core->read(core, WL1273_CHANL_SET, &freq);\n\t\t\tif (r)\n\t\t\t\tgoto out;\n\n\t\t\tdev_dbg(radio->dev, \"%dkHz\\n\", freq);\n\t\t}\n\t\tdev_dbg(radio->dev, \"%s: NOT BUSY\\n\", __func__);\n\t}\n\nout:\n\tcore->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\n\tcomplete(&radio->busy);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int wl1273_fm_set_tx_freq(struct wl1273_device *radio, unsigned int freq)\n{\n\tstruct wl1273_core *core = radio->core;\n\tint r = 0;\n\tunsigned long t;\n\n\tif (freq < WL1273_BAND_TX_LOW) {\n\t\tdev_err(radio->dev,\n\t\t\t\"Frequency out of range: %d < %d\\n\", freq,\n\t\t\tWL1273_BAND_TX_LOW);\n\t\treturn -ERANGE;\n\t}\n\n\tif (freq > WL1273_BAND_TX_HIGH) {\n\t\tdev_err(radio->dev,\n\t\t\t\"Frequency out of range: %d > %d\\n\", freq,\n\t\t\tWL1273_BAND_TX_HIGH);\n\t\treturn -ERANGE;\n\t}\n\n\t \n\tusleep_range(5000, 10000);\n\n\tdev_dbg(radio->dev, \"%s: freq: %d kHz\\n\", __func__, freq);\n\n\t \n\tr = core->write(core, WL1273_CHANL_SET, freq / 10);\n\tif (r)\n\t\treturn r;\n\n\treinit_completion(&radio->busy);\n\n\t \n\tt = wait_for_completion_timeout(&radio->busy, msecs_to_jiffies(2000));\n\tif (!t)\n\t\treturn -ETIMEDOUT;\n\n\tdev_dbg(radio->dev, \"WL1273_CHANL_SET: %lu\\n\", t);\n\n\t \n\tr = core->write(core, WL1273_POWER_ENB_SET, 1);\n\tif (r)\n\t\treturn r;\n\n\treinit_completion(&radio->busy);\n\n\t \n\tt = wait_for_completion_timeout(&radio->busy, msecs_to_jiffies(1000));\n\tif (!t)\n\t\treturn -ETIMEDOUT;\n\n\tradio->tx_frequency = freq;\n\tdev_dbg(radio->dev, \"WL1273_POWER_ENB_SET: %lu\\n\", t);\n\n\treturn\t0;\n}\n\nstatic int wl1273_fm_set_rx_freq(struct wl1273_device *radio, unsigned int freq)\n{\n\tstruct wl1273_core *core = radio->core;\n\tint r, f;\n\tunsigned long t;\n\n\tif (freq < radio->rangelow) {\n\t\tdev_err(radio->dev,\n\t\t\t\"Frequency out of range: %d < %d\\n\", freq,\n\t\t\tradio->rangelow);\n\t\tr = -ERANGE;\n\t\tgoto err;\n\t}\n\n\tif (freq > radio->rangehigh) {\n\t\tdev_err(radio->dev,\n\t\t\t\"Frequency out of range: %d > %d\\n\", freq,\n\t\t\tradio->rangehigh);\n\t\tr = -ERANGE;\n\t\tgoto err;\n\t}\n\n\tdev_dbg(radio->dev, \"%s: %dkHz\\n\", __func__, freq);\n\n\tcore->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\n\n\tif (radio->band == WL1273_BAND_JAPAN)\n\t\tf = (freq - WL1273_BAND_JAPAN_LOW) / 50;\n\telse\n\t\tf = (freq - WL1273_BAND_OTHER_LOW) / 50;\n\n\tr = core->write(core, WL1273_FREQ_SET, f);\n\tif (r) {\n\t\tdev_err(radio->dev, \"FREQ_SET fails\\n\");\n\t\tgoto err;\n\t}\n\n\tr = core->write(core, WL1273_TUNER_MODE_SET, TUNER_MODE_PRESET);\n\tif (r) {\n\t\tdev_err(radio->dev, \"TUNER_MODE_SET fails\\n\");\n\t\tgoto err;\n\t}\n\n\treinit_completion(&radio->busy);\n\n\tt = wait_for_completion_timeout(&radio->busy, msecs_to_jiffies(2000));\n\tif (!t) {\n\t\tdev_err(radio->dev, \"%s: TIMEOUT\\n\", __func__);\n\t\treturn -ETIMEDOUT;\n\t}\n\n\tradio->rd_index = 0;\n\tradio->wr_index = 0;\n\tradio->rx_frequency = freq;\n\treturn 0;\nerr:\n\treturn r;\n}\n\nstatic int wl1273_fm_get_freq(struct wl1273_device *radio)\n{\n\tstruct wl1273_core *core = radio->core;\n\tunsigned int freq;\n\tu16 f;\n\tint r;\n\n\tif (core->mode == WL1273_MODE_RX) {\n\t\tr = core->read(core, WL1273_FREQ_SET, &f);\n\t\tif (r)\n\t\t\treturn r;\n\n\t\tdev_dbg(radio->dev, \"Freq get: 0x%04x\\n\", f);\n\t\tif (radio->band == WL1273_BAND_JAPAN)\n\t\t\tfreq = WL1273_BAND_JAPAN_LOW + 50 * f;\n\t\telse\n\t\t\tfreq = WL1273_BAND_OTHER_LOW + 50 * f;\n\t} else {\n\t\tr = core->read(core, WL1273_CHANL_SET, &f);\n\t\tif (r)\n\t\t\treturn r;\n\n\t\tfreq = f * 10;\n\t}\n\n\treturn freq;\n}\n\n \nstatic int wl1273_fm_upload_firmware_patch(struct wl1273_device *radio)\n{\n\tstruct wl1273_core *core = radio->core;\n\tunsigned int packet_num;\n\tconst struct firmware *fw_p;\n\tconst char *fw_name = \"radio-wl1273-fw.bin\";\n\tstruct device *dev = radio->dev;\n\t__u8 *ptr;\n\tint r;\n\n\tdev_dbg(dev, \"%s:\\n\", __func__);\n\n\t \n\tif (request_firmware(&fw_p, fw_name, dev)) {\n\t\tdev_info(dev, \"%s - %s not found\\n\", __func__, fw_name);\n\n\t\treturn 0;\n\t}\n\n\tptr = (__u8 *) fw_p->data;\n\tpacket_num = ptr[0];\n\tdev_dbg(dev, \"%s: packets: %d\\n\", __func__, packet_num);\n\n\tr = wl1273_fm_write_fw(core, ptr + 1, packet_num);\n\tif (r) {\n\t\tdev_err(dev, \"FW upload error: %d\\n\", r);\n\t\tgoto out;\n\t}\n\n\t \n\tcore->write(core, WL1273_RESET, 0);\n\n\tdev_dbg(dev, \"%s - download OK, r: %d\\n\", __func__, r);\nout:\n\trelease_firmware(fw_p);\n\treturn r;\n}\n\nstatic int wl1273_fm_stop(struct wl1273_device *radio)\n{\n\tstruct wl1273_core *core = radio->core;\n\n\tif (core->mode == WL1273_MODE_RX) {\n\t\tint r = core->write(core, WL1273_POWER_SET,\n\t\t\t\t    WL1273_POWER_SET_OFF);\n\t\tif (r)\n\t\t\tdev_err(radio->dev, \"%s: POWER_SET fails: %d\\n\",\n\t\t\t\t__func__, r);\n\t} else if (core->mode == WL1273_MODE_TX) {\n\t\tint r = core->write(core, WL1273_PUPD_SET,\n\t\t\t\t    WL1273_PUPD_SET_OFF);\n\t\tif (r)\n\t\t\tdev_err(radio->dev,\n\t\t\t\t\"%s: PUPD_SET fails: %d\\n\", __func__, r);\n\t}\n\n\tif (core->pdata->disable) {\n\t\tcore->pdata->disable();\n\t\tdev_dbg(radio->dev, \"Back to reset\\n\");\n\t}\n\n\treturn 0;\n}\n\nstatic int wl1273_fm_start(struct wl1273_device *radio, int new_mode)\n{\n\tstruct wl1273_core *core = radio->core;\n\tstruct wl1273_fm_platform_data *pdata = core->pdata;\n\tstruct device *dev = radio->dev;\n\tint r = -EINVAL;\n\n\tif (pdata->enable && core->mode == WL1273_MODE_OFF) {\n\t\tdev_dbg(radio->dev, \"Out of reset\\n\");\n\n\t\tpdata->enable();\n\t\tmsleep(250);\n\t}\n\n\tif (new_mode == WL1273_MODE_RX) {\n\t\tu16 val = WL1273_POWER_SET_FM;\n\n\t\tif (radio->rds_on)\n\t\t\tval |= WL1273_POWER_SET_RDS;\n\n\t\t \n\t\tr = core->write(core, WL1273_POWER_SET, val);\n\t\tif (r) {\n\t\t\tmsleep(100);\n\n\t\t\tr = core->write(core, WL1273_POWER_SET, val);\n\t\t\tif (r) {\n\t\t\t\tdev_err(dev, \"%s: POWER_SET fails\\n\", __func__);\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tradio->wr_index = 0;\n\t\tradio->rd_index = 0;\n\n\t} else if (new_mode == WL1273_MODE_TX) {\n\t\t \n\t\tr = core->write(core, WL1273_PUPD_SET, WL1273_PUPD_SET_ON);\n\t\tif (r) {\n\t\t\tmsleep(100);\n\t\t\tr = core->write(core, WL1273_PUPD_SET,\n\t\t\t\t\tWL1273_PUPD_SET_ON);\n\t\t\tif (r) {\n\t\t\t\tdev_err(dev, \"%s: PUPD_SET fails\\n\", __func__);\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t}\n\n\t\tif (radio->rds_on) {\n\t\t\tr = core->write(core, WL1273_RDS_DATA_ENB, 1);\n\t\t\tif (r) {\n\t\t\t\tdev_err(dev, \"%s: RDS_DATA_ENB ON fails\\n\",\n\t\t\t\t\t__func__);\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t} else {\n\t\t\tr = core->write(core, WL1273_RDS_DATA_ENB, 0);\n\t\t\tif (r) {\n\t\t\t\tdev_err(dev, \"%s: RDS_DATA_ENB OFF fails\\n\",\n\t\t\t\t\t__func__);\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tdev_warn(dev, \"%s: Illegal mode.\\n\", __func__);\n\t}\n\n\tif (core->mode == WL1273_MODE_OFF) {\n\t\tr = wl1273_fm_upload_firmware_patch(radio);\n\t\tif (r)\n\t\t\tdev_warn(dev, \"Firmware upload failed.\\n\");\n\n\t\t \n\t\tif (new_mode == WL1273_MODE_RX) {\n\t\t\tu16 val = WL1273_POWER_SET_FM;\n\n\t\t\tif (radio->rds_on)\n\t\t\t\tval |= WL1273_POWER_SET_RDS;\n\n\t\t\tr = core->write(core, WL1273_POWER_SET, val);\n\t\t\tif (r) {\n\t\t\t\tdev_err(dev, \"%s: POWER_SET fails\\n\", __func__);\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t} else if (new_mode == WL1273_MODE_TX) {\n\t\t\tr = core->write(core, WL1273_PUPD_SET,\n\t\t\t\t\tWL1273_PUPD_SET_ON);\n\t\t\tif (r) {\n\t\t\t\tdev_err(dev, \"%s: PUPD_SET fails\\n\", __func__);\n\t\t\t\tgoto fail;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\nfail:\n\tif (pdata->disable)\n\t\tpdata->disable();\n\n\tdev_dbg(dev, \"%s: return: %d\\n\", __func__, r);\n\treturn r;\n}\n\nstatic int wl1273_fm_suspend(struct wl1273_device *radio)\n{\n\tstruct wl1273_core *core = radio->core;\n\tint r;\n\n\t \n\tif (core->mode == WL1273_MODE_RX)\n\t\tr = core->write(core, WL1273_POWER_SET,\n\t\t\t\tWL1273_POWER_SET_RETENTION);\n\telse if (core->mode == WL1273_MODE_TX)\n\t\tr = core->write(core, WL1273_PUPD_SET,\n\t\t\t\tWL1273_PUPD_SET_RETENTION);\n\telse\n\t\tr = -EINVAL;\n\n\tif (r) {\n\t\tdev_err(radio->dev, \"%s: POWER_SET fails: %d\\n\", __func__, r);\n\t\tgoto out;\n\t}\n\nout:\n\treturn r;\n}\n\nstatic int wl1273_fm_set_mode(struct wl1273_device *radio, int mode)\n{\n\tstruct wl1273_core *core = radio->core;\n\tstruct device *dev = radio->dev;\n\tint old_mode;\n\tint r;\n\n\tdev_dbg(dev, \"%s\\n\", __func__);\n\tdev_dbg(dev, \"Forbidden modes: 0x%02x\\n\", radio->forbidden);\n\n\told_mode = core->mode;\n\tif (mode & radio->forbidden) {\n\t\tr = -EPERM;\n\t\tgoto out;\n\t}\n\n\tswitch (mode) {\n\tcase WL1273_MODE_RX:\n\tcase WL1273_MODE_TX:\n\t\tr = wl1273_fm_start(radio, mode);\n\t\tif (r) {\n\t\t\tdev_err(dev, \"%s: Cannot start.\\n\", __func__);\n\t\t\twl1273_fm_stop(radio);\n\t\t\tgoto out;\n\t\t}\n\n\t\tcore->mode = mode;\n\t\tr = core->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\n\t\tif (r) {\n\t\t\tdev_err(dev, \"INT_MASK_SET fails.\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\tif (mode == WL1273_MODE_RX) {\n\t\t\tr = wl1273_fm_set_rx_freq(radio, radio->rx_frequency);\n\t\t\tif (r) {\n\t\t\t\tdev_err(dev, \"set freq fails: %d.\\n\", r);\n\t\t\t\tgoto out;\n\t\t\t}\n\n\t\t\tr = core->set_volume(core, core->volume);\n\t\t\tif (r) {\n\t\t\t\tdev_err(dev, \"set volume fails: %d.\\n\", r);\n\t\t\t\tgoto out;\n\t\t\t}\n\n\t\t\tdev_dbg(dev, \"%s: Set vol: %d.\\n\", __func__,\n\t\t\t\tcore->volume);\n\t\t} else {\n\t\t\tr = wl1273_fm_set_tx_freq(radio, radio->tx_frequency);\n\t\t\tif (r) {\n\t\t\t\tdev_err(dev, \"set freq fails: %d.\\n\", r);\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t}\n\n\t\tdev_dbg(radio->dev, \"%s: Set audio mode.\\n\", __func__);\n\n\t\tr = core->set_audio(core, core->audio_mode);\n\t\tif (r)\n\t\t\tdev_err(dev, \"Cannot set audio mode.\\n\");\n\t\tbreak;\n\n\tcase WL1273_MODE_OFF:\n\t\tr = wl1273_fm_stop(radio);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Off fails: %d\\n\", __func__, r);\n\t\telse\n\t\t\tcore->mode = WL1273_MODE_OFF;\n\n\t\tbreak;\n\n\tcase WL1273_MODE_SUSPENDED:\n\t\tr = wl1273_fm_suspend(radio);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Suspend fails: %d\\n\", __func__, r);\n\t\telse\n\t\t\tcore->mode = WL1273_MODE_SUSPENDED;\n\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(dev, \"%s: Unknown mode: %d\\n\", __func__, mode);\n\t\tr = -EINVAL;\n\t\tbreak;\n\t}\nout:\n\tif (r)\n\t\tcore->mode = old_mode;\n\n\treturn r;\n}\n\nstatic int wl1273_fm_set_seek(struct wl1273_device *radio,\n\t\t\t      unsigned int wrap_around,\n\t\t\t      unsigned int seek_upward,\n\t\t\t      int level)\n{\n\tstruct wl1273_core *core = radio->core;\n\tint r = 0;\n\tunsigned int dir = (seek_upward == 0) ? 0 : 1;\n\tunsigned int f;\n\n\tf = radio->rx_frequency;\n\tdev_dbg(radio->dev, \"rx_frequency: %d\\n\", f);\n\n\tif (dir && f + radio->spacing <= radio->rangehigh)\n\t\tr = wl1273_fm_set_rx_freq(radio, f + radio->spacing);\n\telse if (dir && wrap_around)\n\t\tr = wl1273_fm_set_rx_freq(radio, radio->rangelow);\n\telse if (f - radio->spacing >= radio->rangelow)\n\t\tr = wl1273_fm_set_rx_freq(radio, f - radio->spacing);\n\telse if (wrap_around)\n\t\tr = wl1273_fm_set_rx_freq(radio, radio->rangehigh);\n\n\tif (r)\n\t\tgoto out;\n\n\tif (level < SCHAR_MIN || level > SCHAR_MAX)\n\t\treturn -EINVAL;\n\n\treinit_completion(&radio->busy);\n\tdev_dbg(radio->dev, \"%s: BUSY\\n\", __func__);\n\n\tr = core->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\n\tif (r)\n\t\tgoto out;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tr = core->write(core, WL1273_SEARCH_LVL_SET, level);\n\tif (r)\n\t\tgoto out;\n\n\tr = core->write(core, WL1273_SEARCH_DIR_SET, dir);\n\tif (r)\n\t\tgoto out;\n\n\tr = core->write(core, WL1273_TUNER_MODE_SET, TUNER_MODE_AUTO_SEEK);\n\tif (r)\n\t\tgoto out;\n\n\t \n\twait_for_completion_timeout(&radio->busy, msecs_to_jiffies(1000));\n\tif (!(radio->irq_received & WL1273_BL_EVENT)) {\n\t\tr = -ETIMEDOUT;\n\t\tgoto out;\n\t}\n\n\tradio->irq_received &= ~WL1273_BL_EVENT;\n\n\tif (!wrap_around)\n\t\tgoto out;\n\n\t \n\tdev_dbg(radio->dev, \"Wrap around in HW seek.\\n\");\n\n\tif (seek_upward)\n\t\tf = radio->rangelow;\n\telse\n\t\tf = radio->rangehigh;\n\n\tr = wl1273_fm_set_rx_freq(radio, f);\n\tif (r)\n\t\tgoto out;\n\n\treinit_completion(&radio->busy);\n\tdev_dbg(radio->dev, \"%s: BUSY\\n\", __func__);\n\n\tr = core->write(core, WL1273_TUNER_MODE_SET, TUNER_MODE_AUTO_SEEK);\n\tif (r)\n\t\tgoto out;\n\n\t \n\tif (!wait_for_completion_timeout(&radio->busy, msecs_to_jiffies(1000)))\n\t\tr = -ETIMEDOUT;\nout:\n\tdev_dbg(radio->dev, \"%s: Err: %d\\n\", __func__, r);\n\treturn r;\n}\n\n \nstatic unsigned int wl1273_fm_get_tx_ctune(struct wl1273_device *radio)\n{\n\tstruct wl1273_core *core = radio->core;\n\tstruct device *dev = radio->dev;\n\tu16 val;\n\tint r;\n\n\tif (core->mode == WL1273_MODE_OFF ||\n\t    core->mode == WL1273_MODE_SUSPENDED)\n\t\treturn -EPERM;\n\n\tr = core->read(core, WL1273_READ_FMANT_TUNE_VALUE, &val);\n\tif (r) {\n\t\tdev_err(dev, \"%s: read error: %d\\n\", __func__, r);\n\t\tgoto out;\n\t}\n\nout:\n\treturn val;\n}\n\n \nstatic int wl1273_fm_set_preemphasis(struct wl1273_device *radio,\n\t\t\t\t     unsigned int preemphasis)\n{\n\tstruct wl1273_core *core = radio->core;\n\tint r;\n\tu16 em;\n\n\tif (core->mode == WL1273_MODE_OFF ||\n\t    core->mode == WL1273_MODE_SUSPENDED)\n\t\treturn -EPERM;\n\n\tmutex_lock(&core->lock);\n\n\tswitch (preemphasis) {\n\tcase V4L2_PREEMPHASIS_DISABLED:\n\t\tem = 1;\n\t\tbreak;\n\tcase V4L2_PREEMPHASIS_50_uS:\n\t\tem = 0;\n\t\tbreak;\n\tcase V4L2_PREEMPHASIS_75_uS:\n\t\tem = 2;\n\t\tbreak;\n\tdefault:\n\t\tr = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tr = core->write(core, WL1273_PREMPH_SET, em);\n\tif (r)\n\t\tgoto out;\n\n\tradio->preemphasis = preemphasis;\n\nout:\n\tmutex_unlock(&core->lock);\n\treturn r;\n}\n\nstatic int wl1273_fm_rds_on(struct wl1273_device *radio)\n{\n\tstruct wl1273_core *core = radio->core;\n\tint r;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\tif (radio->rds_on)\n\t\treturn 0;\n\n\tr = core->write(core, WL1273_POWER_SET,\n\t\t\tWL1273_POWER_SET_FM | WL1273_POWER_SET_RDS);\n\tif (r)\n\t\tgoto out;\n\n\tr = wl1273_fm_set_rx_freq(radio, radio->rx_frequency);\n\tif (r)\n\t\tdev_err(radio->dev, \"set freq fails: %d.\\n\", r);\nout:\n\treturn r;\n}\n\nstatic int wl1273_fm_rds_off(struct wl1273_device *radio)\n{\n\tstruct wl1273_core *core = radio->core;\n\tint r;\n\n\tif (!radio->rds_on)\n\t\treturn 0;\n\n\tradio->irq_flags &= ~WL1273_RDS_EVENT;\n\n\tr = core->write(core, WL1273_INT_MASK_SET, radio->irq_flags);\n\tif (r)\n\t\tgoto out;\n\n\t \n\twake_up_interruptible(&radio->read_queue);\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tr = core->write(core, WL1273_POWER_SET, WL1273_POWER_SET_FM);\n\tif (r)\n\t\tgoto out;\n\n\tr = wl1273_fm_set_rx_freq(radio, radio->rx_frequency);\n\tif (r)\n\t\tdev_err(radio->dev, \"set freq fails: %d.\\n\", r);\nout:\n\tdev_dbg(radio->dev, \"%s: exiting...\\n\", __func__);\n\n\treturn r;\n}\n\nstatic int wl1273_fm_set_rds(struct wl1273_device *radio, unsigned int new_mode)\n{\n\tint r = 0;\n\tstruct wl1273_core *core = radio->core;\n\n\tif (core->mode == WL1273_MODE_OFF ||\n\t    core->mode == WL1273_MODE_SUSPENDED)\n\t\treturn -EPERM;\n\n\tif (new_mode == WL1273_RDS_RESET) {\n\t\tr = core->write(core, WL1273_RDS_CNTRL_SET, 1);\n\t\treturn r;\n\t}\n\n\tif (core->mode == WL1273_MODE_TX && new_mode == WL1273_RDS_OFF) {\n\t\tr = core->write(core, WL1273_RDS_DATA_ENB, 0);\n\t} else if (core->mode == WL1273_MODE_TX && new_mode == WL1273_RDS_ON) {\n\t\tr = core->write(core, WL1273_RDS_DATA_ENB, 1);\n\t} else if (core->mode == WL1273_MODE_RX && new_mode == WL1273_RDS_OFF) {\n\t\tr = wl1273_fm_rds_off(radio);\n\t} else if (core->mode == WL1273_MODE_RX && new_mode == WL1273_RDS_ON) {\n\t\tr = wl1273_fm_rds_on(radio);\n\t} else {\n\t\tdev_err(radio->dev, \"%s: Unknown mode: %d\\n\",\n\t\t\t__func__, new_mode);\n\t\tr = -EINVAL;\n\t}\n\n\tif (!r)\n\t\tradio->rds_on = (new_mode == WL1273_RDS_ON) ? true : false;\n\n\treturn r;\n}\n\nstatic ssize_t wl1273_fm_fops_write(struct file *file, const char __user *buf,\n\t\t\t\t    size_t count, loff_t *ppos)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tu16 val;\n\tint r;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (core->mode != WL1273_MODE_TX)\n\t\treturn count;\n\n\tif (radio->rds_users == 0) {\n\t\tdev_warn(radio->dev, \"%s: RDS not on.\\n\", __func__);\n\t\treturn 0;\n\t}\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\t \n\tif (radio->owner && radio->owner != file) {\n\t\tr = -EBUSY;\n\t\tgoto out;\n\t}\n\tradio->owner = file;\n\n\t \n\tif (count > 255)\n\t\tval = 255;\n\telse\n\t\tval = count;\n\n\tcore->write(core, WL1273_RDS_CONFIG_DATA_SET, val);\n\n\tif (copy_from_user(radio->write_buf + 1, buf, val)) {\n\t\tr = -EFAULT;\n\t\tgoto out;\n\t}\n\n\tdev_dbg(radio->dev, \"Count: %d\\n\", val);\n\tdev_dbg(radio->dev, \"From user: \\\"%s\\\"\\n\", radio->write_buf);\n\n\tradio->write_buf[0] = WL1273_RDS_DATA_SET;\n\tcore->write_data(core, radio->write_buf, val + 1);\n\n\tr = val;\nout:\n\tmutex_unlock(&core->lock);\n\n\treturn r;\n}\n\nstatic __poll_t wl1273_fm_fops_poll(struct file *file,\n\t\t\t\t\tstruct poll_table_struct *pts)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\n\tif (radio->owner && radio->owner != file)\n\t\treturn EPOLLERR;\n\n\tradio->owner = file;\n\n\tif (core->mode == WL1273_MODE_RX) {\n\t\tpoll_wait(file, &radio->read_queue, pts);\n\n\t\tif (radio->rd_index != radio->wr_index)\n\t\t\treturn EPOLLIN | EPOLLRDNORM;\n\n\t} else if (core->mode == WL1273_MODE_TX) {\n\t\treturn EPOLLOUT | EPOLLWRNORM;\n\t}\n\n\treturn 0;\n}\n\nstatic int wl1273_fm_fops_open(struct file *file)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tint r = 0;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (core->mode == WL1273_MODE_RX && radio->rds_on &&\n\t    !radio->rds_users) {\n\t\tdev_dbg(radio->dev, \"%s: Mode: %d\\n\", __func__, core->mode);\n\n\t\tif (mutex_lock_interruptible(&core->lock))\n\t\t\treturn -EINTR;\n\n\t\tradio->irq_flags |= WL1273_RDS_EVENT;\n\n\t\tr = core->write(core, WL1273_INT_MASK_SET,\n\t\t\t\tradio->irq_flags);\n\t\tif (r) {\n\t\t\tmutex_unlock(&core->lock);\n\t\t\tgoto out;\n\t\t}\n\n\t\tradio->rds_users++;\n\n\t\tmutex_unlock(&core->lock);\n\t}\nout:\n\treturn r;\n}\n\nstatic int wl1273_fm_fops_release(struct file *file)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tint r = 0;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (radio->rds_users > 0) {\n\t\tradio->rds_users--;\n\t\tif (radio->rds_users == 0) {\n\t\t\tmutex_lock(&core->lock);\n\n\t\t\tradio->irq_flags &= ~WL1273_RDS_EVENT;\n\n\t\t\tif (core->mode == WL1273_MODE_RX) {\n\t\t\t\tr = core->write(core,\n\t\t\t\t\t\tWL1273_INT_MASK_SET,\n\t\t\t\t\t\tradio->irq_flags);\n\t\t\t\tif (r) {\n\t\t\t\t\tmutex_unlock(&core->lock);\n\t\t\t\t\tgoto out;\n\t\t\t\t}\n\t\t\t}\n\t\t\tmutex_unlock(&core->lock);\n\t\t}\n\t}\n\n\tif (file == radio->owner)\n\t\tradio->owner = NULL;\nout:\n\treturn r;\n}\n\nstatic ssize_t wl1273_fm_fops_read(struct file *file, char __user *buf,\n\t\t\t\t   size_t count, loff_t *ppos)\n{\n\tint r = 0;\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tunsigned int block_count = 0;\n\tu16 val;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (core->mode != WL1273_MODE_RX)\n\t\treturn 0;\n\n\tif (radio->rds_users == 0) {\n\t\tdev_warn(radio->dev, \"%s: RDS not on.\\n\", __func__);\n\t\treturn 0;\n\t}\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\n\t \n\tif (radio->owner && radio->owner != file) {\n\t\tr = -EBUSY;\n\t\tgoto out;\n\t}\n\tradio->owner = file;\n\n\tr = core->read(core, WL1273_RDS_SYNC_GET, &val);\n\tif (r) {\n\t\tdev_err(radio->dev, \"%s: Get RDS_SYNC fails.\\n\", __func__);\n\t\tgoto out;\n\t} else if (val == 0) {\n\t\tdev_info(radio->dev, \"RDS_SYNC: Not synchronized\\n\");\n\t\tr = -ENODATA;\n\t\tgoto out;\n\t}\n\n\t \n\twhile (radio->wr_index == radio->rd_index) {\n\t\tif (file->f_flags & O_NONBLOCK) {\n\t\t\tr = -EWOULDBLOCK;\n\t\t\tgoto out;\n\t\t}\n\n\t\tdev_dbg(radio->dev, \"%s: Wait for RDS data.\\n\", __func__);\n\t\tif (wait_event_interruptible(radio->read_queue,\n\t\t\t\t\t     radio->wr_index !=\n\t\t\t\t\t     radio->rd_index) < 0) {\n\t\t\tr = -EINTR;\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\t \n\tcount /= RDS_BLOCK_SIZE;\n\n\t \n\twhile (block_count < count) {\n\t\tif (radio->rd_index == radio->wr_index)\n\t\t\tbreak;\n\n\t\t \n\t\tif (copy_to_user(buf, &radio->buffer[radio->rd_index],\n\t\t\t\t RDS_BLOCK_SIZE))\n\t\t\tbreak;\n\n\t\t \n\t\tradio->rd_index += RDS_BLOCK_SIZE;\n\t\tif (radio->rd_index >= radio->buf_size)\n\t\t\tradio->rd_index = 0;\n\n\t\t \n\t\tblock_count++;\n\t\tbuf += RDS_BLOCK_SIZE;\n\t\tr += RDS_BLOCK_SIZE;\n\t}\n\nout:\n\tdev_dbg(radio->dev, \"%s: exit\\n\", __func__);\n\tmutex_unlock(&core->lock);\n\n\treturn r;\n}\n\nstatic const struct v4l2_file_operations wl1273_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.read\t\t= wl1273_fm_fops_read,\n\t.write\t\t= wl1273_fm_fops_write,\n\t.poll\t\t= wl1273_fm_fops_poll,\n\t.unlocked_ioctl\t= video_ioctl2,\n\t.open\t\t= wl1273_fm_fops_open,\n\t.release\t= wl1273_fm_fops_release,\n};\n\nstatic int wl1273_fm_vidioc_querycap(struct file *file, void *priv,\n\t\t\t\t     struct v4l2_capability *capability)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tstrscpy(capability->driver, WL1273_FM_DRIVER_NAME,\n\t\tsizeof(capability->driver));\n\tstrscpy(capability->card, \"TI Wl1273 FM Radio\",\n\t\tsizeof(capability->card));\n\tstrscpy(capability->bus_info, radio->bus_type,\n\t\tsizeof(capability->bus_info));\n\treturn 0;\n}\n\nstatic int wl1273_fm_vidioc_g_input(struct file *file, void *priv,\n\t\t\t\t    unsigned int *i)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\t*i = 0;\n\n\treturn 0;\n}\n\nstatic int wl1273_fm_vidioc_s_input(struct file *file, void *priv,\n\t\t\t\t    unsigned int i)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (i != 0)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\n \nstatic int wl1273_fm_set_tx_power(struct wl1273_device *radio, u16 power)\n{\n\tstruct wl1273_core *core = radio->core;\n\tint r;\n\n\tif (core->mode == WL1273_MODE_OFF ||\n\t    core->mode == WL1273_MODE_SUSPENDED)\n\t\treturn -EPERM;\n\n\tmutex_lock(&core->lock);\n\n\t \n\tr = core->write(core, WL1273_POWER_LEV_SET, 122 - power);\n\tif (r)\n\t\tgoto out;\n\n\tradio->tx_power = power;\n\nout:\n\tmutex_unlock(&core->lock);\n\treturn r;\n}\n\n#define WL1273_SPACING_50kHz\t1\n#define WL1273_SPACING_100kHz\t2\n#define WL1273_SPACING_200kHz\t4\n\nstatic int wl1273_fm_tx_set_spacing(struct wl1273_device *radio,\n\t\t\t\t    unsigned int spacing)\n{\n\tstruct wl1273_core *core = radio->core;\n\tint r;\n\n\tif (spacing == 0) {\n\t\tr = core->write(core, WL1273_SCAN_SPACING_SET,\n\t\t\t\tWL1273_SPACING_100kHz);\n\t\tradio->spacing = 100;\n\t} else if (spacing - 50000 < 25000) {\n\t\tr = core->write(core, WL1273_SCAN_SPACING_SET,\n\t\t\t\tWL1273_SPACING_50kHz);\n\t\tradio->spacing = 50;\n\t} else if (spacing - 100000 < 50000) {\n\t\tr = core->write(core, WL1273_SCAN_SPACING_SET,\n\t\t\t\tWL1273_SPACING_100kHz);\n\t\tradio->spacing = 100;\n\t} else {\n\t\tr = core->write(core, WL1273_SCAN_SPACING_SET,\n\t\t\t\tWL1273_SPACING_200kHz);\n\t\tradio->spacing = 200;\n\t}\n\n\treturn r;\n}\n\nstatic int wl1273_fm_g_volatile_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct wl1273_device *radio = ctrl->priv;\n\tstruct wl1273_core *core = radio->core;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\n\tswitch (ctrl->id) {\n\tcase  V4L2_CID_TUNE_ANTENNA_CAPACITOR:\n\t\tctrl->val = wl1273_fm_get_tx_ctune(radio);\n\t\tbreak;\n\n\tdefault:\n\t\tdev_warn(radio->dev, \"%s: Unknown IOCTL: %d\\n\",\n\t\t\t __func__, ctrl->id);\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&core->lock);\n\n\treturn 0;\n}\n\n#define WL1273_MUTE_SOFT_ENABLE    (1 << 0)\n#define WL1273_MUTE_AC             (1 << 1)\n#define WL1273_MUTE_HARD_LEFT      (1 << 2)\n#define WL1273_MUTE_HARD_RIGHT     (1 << 3)\n#define WL1273_MUTE_SOFT_FORCE     (1 << 4)\n\nstatic inline struct wl1273_device *to_radio(struct v4l2_ctrl *ctrl)\n{\n\treturn container_of(ctrl->handler, struct wl1273_device, ctrl_handler);\n}\n\nstatic int wl1273_fm_vidioc_s_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct wl1273_device *radio = to_radio(ctrl);\n\tstruct wl1273_core *core = radio->core;\n\tint r = 0;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_AUDIO_MUTE:\n\t\tif (mutex_lock_interruptible(&core->lock))\n\t\t\treturn -EINTR;\n\n\t\tif (core->mode == WL1273_MODE_RX && ctrl->val)\n\t\t\tr = core->write(core,\n\t\t\t\t\tWL1273_MUTE_STATUS_SET,\n\t\t\t\t\tWL1273_MUTE_HARD_LEFT |\n\t\t\t\t\tWL1273_MUTE_HARD_RIGHT);\n\t\telse if (core->mode == WL1273_MODE_RX)\n\t\t\tr = core->write(core,\n\t\t\t\t\tWL1273_MUTE_STATUS_SET, 0x0);\n\t\telse if (core->mode == WL1273_MODE_TX && ctrl->val)\n\t\t\tr = core->write(core, WL1273_MUTE, 1);\n\t\telse if (core->mode == WL1273_MODE_TX)\n\t\t\tr = core->write(core, WL1273_MUTE, 0);\n\n\t\tmutex_unlock(&core->lock);\n\t\tbreak;\n\n\tcase V4L2_CID_AUDIO_VOLUME:\n\t\tif (ctrl->val == 0)\n\t\t\tr = wl1273_fm_set_mode(radio, WL1273_MODE_OFF);\n\t\telse\n\t\t\tr =  core->set_volume(core, core->volume);\n\t\tbreak;\n\n\tcase V4L2_CID_TUNE_PREEMPHASIS:\n\t\tr = wl1273_fm_set_preemphasis(radio, ctrl->val);\n\t\tbreak;\n\n\tcase V4L2_CID_TUNE_POWER_LEVEL:\n\t\tr = wl1273_fm_set_tx_power(radio, ctrl->val);\n\t\tbreak;\n\n\tdefault:\n\t\tdev_warn(radio->dev, \"%s: Unknown IOCTL: %d\\n\",\n\t\t\t __func__, ctrl->id);\n\t\tbreak;\n\t}\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\treturn r;\n}\n\nstatic int wl1273_fm_vidioc_g_audio(struct file *file, void *priv,\n\t\t\t\t    struct v4l2_audio *audio)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (audio->index > 1)\n\t\treturn -EINVAL;\n\n\tstrscpy(audio->name, \"Radio\", sizeof(audio->name));\n\taudio->capability = V4L2_AUDCAP_STEREO;\n\n\treturn 0;\n}\n\nstatic int wl1273_fm_vidioc_s_audio(struct file *file, void *priv,\n\t\t\t\t    const struct v4l2_audio *audio)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (audio->index != 0)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\n#define WL1273_RDS_NOT_SYNCHRONIZED 0\n#define WL1273_RDS_SYNCHRONIZED 1\n\nstatic int wl1273_fm_vidioc_g_tuner(struct file *file, void *priv,\n\t\t\t\t    struct v4l2_tuner *tuner)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tu16 val;\n\tint r;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (tuner->index > 0)\n\t\treturn -EINVAL;\n\n\tstrscpy(tuner->name, WL1273_FM_DRIVER_NAME, sizeof(tuner->name));\n\ttuner->type = V4L2_TUNER_RADIO;\n\n\ttuner->rangelow\t= WL1273_FREQ(WL1273_BAND_JAPAN_LOW);\n\ttuner->rangehigh = WL1273_FREQ(WL1273_BAND_OTHER_HIGH);\n\n\ttuner->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_RDS |\n\t\tV4L2_TUNER_CAP_STEREO | V4L2_TUNER_CAP_RDS_BLOCK_IO |\n\t\tV4L2_TUNER_CAP_HWSEEK_BOUNDED | V4L2_TUNER_CAP_HWSEEK_WRAP;\n\n\tif (radio->stereo)\n\t\ttuner->audmode = V4L2_TUNER_MODE_STEREO;\n\telse\n\t\ttuner->audmode = V4L2_TUNER_MODE_MONO;\n\n\tif (core->mode != WL1273_MODE_RX)\n\t\treturn 0;\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\n\tr = core->read(core, WL1273_STEREO_GET, &val);\n\tif (r)\n\t\tgoto out;\n\n\tif (val == 1)\n\t\ttuner->rxsubchans = V4L2_TUNER_SUB_STEREO;\n\telse\n\t\ttuner->rxsubchans = V4L2_TUNER_SUB_MONO;\n\n\tr = core->read(core, WL1273_RSSI_LVL_GET, &val);\n\tif (r)\n\t\tgoto out;\n\n\ttuner->signal = (s16) val;\n\tdev_dbg(radio->dev, \"Signal: %d\\n\", tuner->signal);\n\n\ttuner->afc = 0;\n\n\tr = core->read(core, WL1273_RDS_SYNC_GET, &val);\n\tif (r)\n\t\tgoto out;\n\n\tif (val == WL1273_RDS_SYNCHRONIZED)\n\t\ttuner->rxsubchans |= V4L2_TUNER_SUB_RDS;\nout:\n\tmutex_unlock(&core->lock);\n\n\treturn r;\n}\n\nstatic int wl1273_fm_vidioc_s_tuner(struct file *file, void *priv,\n\t\t\t\t    const struct v4l2_tuner *tuner)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tint r = 0;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\tdev_dbg(radio->dev, \"tuner->index: %d\\n\", tuner->index);\n\tdev_dbg(radio->dev, \"tuner->name: %s\\n\", tuner->name);\n\tdev_dbg(radio->dev, \"tuner->capability: 0x%04x\\n\", tuner->capability);\n\tdev_dbg(radio->dev, \"tuner->rxsubchans: 0x%04x\\n\", tuner->rxsubchans);\n\tdev_dbg(radio->dev, \"tuner->rangelow: %d\\n\", tuner->rangelow);\n\tdev_dbg(radio->dev, \"tuner->rangehigh: %d\\n\", tuner->rangehigh);\n\n\tif (tuner->index > 0)\n\t\treturn -EINVAL;\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\n\tr = wl1273_fm_set_mode(radio, WL1273_MODE_RX);\n\tif (r)\n\t\tgoto out;\n\n\tif (tuner->rxsubchans & V4L2_TUNER_SUB_RDS)\n\t\tr = wl1273_fm_set_rds(radio, WL1273_RDS_ON);\n\telse\n\t\tr = wl1273_fm_set_rds(radio, WL1273_RDS_OFF);\n\n\tif (r)\n\t\tdev_warn(radio->dev, \"%s: RDS fails: %d\\n\", __func__, r);\n\n\tif (tuner->audmode == V4L2_TUNER_MODE_MONO) {\n\t\tr = core->write(core, WL1273_MOST_MODE_SET, WL1273_RX_MONO);\n\t\tif (r < 0) {\n\t\t\tdev_warn(radio->dev, \"%s: MOST_MODE fails: %d\\n\",\n\t\t\t\t __func__, r);\n\t\t\tgoto out;\n\t\t}\n\t\tradio->stereo = false;\n\t} else if (tuner->audmode == V4L2_TUNER_MODE_STEREO) {\n\t\tr = core->write(core, WL1273_MOST_MODE_SET, WL1273_RX_STEREO);\n\t\tif (r < 0) {\n\t\t\tdev_warn(radio->dev, \"%s: MOST_MODE fails: %d\\n\",\n\t\t\t\t __func__, r);\n\t\t\tgoto out;\n\t\t}\n\t\tradio->stereo = true;\n\t} else {\n\t\tdev_err(radio->dev, \"%s: tuner->audmode: %d\\n\",\n\t\t\t __func__, tuner->audmode);\n\t\tr = -EINVAL;\n\t\tgoto out;\n\t}\n\nout:\n\tmutex_unlock(&core->lock);\n\n\treturn r;\n}\n\nstatic int wl1273_fm_vidioc_g_frequency(struct file *file, void *priv,\n\t\t\t\t\tstruct v4l2_frequency *freq)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\n\tfreq->type = V4L2_TUNER_RADIO;\n\tfreq->frequency = WL1273_FREQ(wl1273_fm_get_freq(radio));\n\n\tmutex_unlock(&core->lock);\n\n\treturn 0;\n}\n\nstatic int wl1273_fm_vidioc_s_frequency(struct file *file, void *priv,\n\t\t\t\t\tconst struct v4l2_frequency *freq)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tint r;\n\n\tdev_dbg(radio->dev, \"%s: %d\\n\", __func__, freq->frequency);\n\n\tif (freq->type != V4L2_TUNER_RADIO) {\n\t\tdev_dbg(radio->dev,\n\t\t\t\"freq->type != V4L2_TUNER_RADIO: %d\\n\", freq->type);\n\t\treturn -EINVAL;\n\t}\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\n\tif (core->mode == WL1273_MODE_RX) {\n\t\tdev_dbg(radio->dev, \"freq: %d\\n\", freq->frequency);\n\n\t\tr = wl1273_fm_set_rx_freq(radio,\n\t\t\t\t\t  WL1273_INV_FREQ(freq->frequency));\n\t\tif (r)\n\t\t\tdev_warn(radio->dev, WL1273_FM_DRIVER_NAME\n\t\t\t\t \": set frequency failed with %d\\n\", r);\n\t} else {\n\t\tr = wl1273_fm_set_tx_freq(radio,\n\t\t\t\t\t  WL1273_INV_FREQ(freq->frequency));\n\t\tif (r)\n\t\t\tdev_warn(radio->dev, WL1273_FM_DRIVER_NAME\n\t\t\t\t \": set frequency failed with %d\\n\", r);\n\t}\n\n\tmutex_unlock(&core->lock);\n\n\tdev_dbg(radio->dev, \"wl1273_vidioc_s_frequency: DONE\\n\");\n\treturn r;\n}\n\n#define WL1273_DEFAULT_SEEK_LEVEL\t7\n\nstatic int wl1273_fm_vidioc_s_hw_freq_seek(struct file *file, void *priv,\n\t\t\t\t\t   const struct v4l2_hw_freq_seek *seek)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tint r;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (seek->tuner != 0 || seek->type != V4L2_TUNER_RADIO)\n\t\treturn -EINVAL;\n\n\tif (file->f_flags & O_NONBLOCK)\n\t\treturn -EWOULDBLOCK;\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\n\tr = wl1273_fm_set_mode(radio, WL1273_MODE_RX);\n\tif (r)\n\t\tgoto out;\n\n\tr = wl1273_fm_tx_set_spacing(radio, seek->spacing);\n\tif (r)\n\t\tdev_warn(radio->dev, \"HW seek failed: %d\\n\", r);\n\n\tr = wl1273_fm_set_seek(radio, seek->wrap_around, seek->seek_upward,\n\t\t\t       WL1273_DEFAULT_SEEK_LEVEL);\n\tif (r)\n\t\tdev_warn(radio->dev, \"HW seek failed: %d\\n\", r);\n\nout:\n\tmutex_unlock(&core->lock);\n\treturn r;\n}\n\nstatic int wl1273_fm_vidioc_s_modulator(struct file *file, void *priv,\n\t\t\t\t\tconst struct v4l2_modulator *modulator)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tint r = 0;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tif (modulator->index > 0)\n\t\treturn -EINVAL;\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\n\tr = wl1273_fm_set_mode(radio, WL1273_MODE_TX);\n\tif (r)\n\t\tgoto out;\n\n\tif (modulator->txsubchans & V4L2_TUNER_SUB_RDS)\n\t\tr = wl1273_fm_set_rds(radio, WL1273_RDS_ON);\n\telse\n\t\tr = wl1273_fm_set_rds(radio, WL1273_RDS_OFF);\n\n\tif (modulator->txsubchans & V4L2_TUNER_SUB_MONO)\n\t\tr = core->write(core, WL1273_MONO_SET, WL1273_TX_MONO);\n\telse\n\t\tr = core->write(core, WL1273_MONO_SET,\n\t\t\t\tWL1273_RX_STEREO);\n\tif (r < 0)\n\t\tdev_warn(radio->dev, WL1273_FM_DRIVER_NAME\n\t\t\t \"MONO_SET fails: %d\\n\", r);\nout:\n\tmutex_unlock(&core->lock);\n\n\treturn r;\n}\n\nstatic int wl1273_fm_vidioc_g_modulator(struct file *file, void *priv,\n\t\t\t\t\tstruct v4l2_modulator *modulator)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tu16 val;\n\tint r;\n\n\tdev_dbg(radio->dev, \"%s\\n\", __func__);\n\n\tstrscpy(modulator->name, WL1273_FM_DRIVER_NAME,\n\t\tsizeof(modulator->name));\n\n\tmodulator->rangelow = WL1273_FREQ(WL1273_BAND_JAPAN_LOW);\n\tmodulator->rangehigh = WL1273_FREQ(WL1273_BAND_OTHER_HIGH);\n\n\tmodulator->capability =  V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_RDS |\n\t\tV4L2_TUNER_CAP_STEREO | V4L2_TUNER_CAP_RDS_BLOCK_IO;\n\n\tif (core->mode != WL1273_MODE_TX)\n\t\treturn 0;\n\n\tif (mutex_lock_interruptible(&core->lock))\n\t\treturn -EINTR;\n\n\tr = core->read(core, WL1273_MONO_SET, &val);\n\tif (r)\n\t\tgoto out;\n\n\tif (val == WL1273_TX_STEREO)\n\t\tmodulator->txsubchans = V4L2_TUNER_SUB_STEREO;\n\telse\n\t\tmodulator->txsubchans = V4L2_TUNER_SUB_MONO;\n\n\tif (radio->rds_on)\n\t\tmodulator->txsubchans |= V4L2_TUNER_SUB_RDS;\nout:\n\tmutex_unlock(&core->lock);\n\n\treturn 0;\n}\n\nstatic int wl1273_fm_vidioc_log_status(struct file *file, void *priv)\n{\n\tstruct wl1273_device *radio = video_get_drvdata(video_devdata(file));\n\tstruct wl1273_core *core = radio->core;\n\tstruct device *dev = radio->dev;\n\tu16 val;\n\tint r;\n\n\tdev_info(dev, DRIVER_DESC);\n\n\tif (core->mode == WL1273_MODE_OFF) {\n\t\tdev_info(dev, \"Mode: Off\\n\");\n\t\treturn 0;\n\t}\n\n\tif (core->mode == WL1273_MODE_SUSPENDED) {\n\t\tdev_info(dev, \"Mode: Suspended\\n\");\n\t\treturn 0;\n\t}\n\n\tr = core->read(core, WL1273_ASIC_ID_GET, &val);\n\tif (r)\n\t\tdev_err(dev, \"%s: Get ASIC_ID fails.\\n\", __func__);\n\telse\n\t\tdev_info(dev, \"ASIC_ID: 0x%04x\\n\", val);\n\n\tr = core->read(core, WL1273_ASIC_VER_GET, &val);\n\tif (r)\n\t\tdev_err(dev, \"%s: Get ASIC_VER fails.\\n\", __func__);\n\telse\n\t\tdev_info(dev, \"ASIC Version: 0x%04x\\n\", val);\n\n\tr = core->read(core, WL1273_FIRM_VER_GET, &val);\n\tif (r)\n\t\tdev_err(dev, \"%s: Get FIRM_VER fails.\\n\", __func__);\n\telse\n\t\tdev_info(dev, \"FW version: %d(0x%04x)\\n\", val, val);\n\n\tr = core->read(core, WL1273_BAND_SET, &val);\n\tif (r)\n\t\tdev_err(dev, \"%s: Get BAND fails.\\n\", __func__);\n\telse\n\t\tdev_info(dev, \"BAND: %d\\n\", val);\n\n\tif (core->mode == WL1273_MODE_TX) {\n\t\tr = core->read(core, WL1273_PUPD_SET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get PUPD fails.\\n\", __func__);\n\t\telse\n\t\t\tdev_info(dev, \"PUPD: 0x%04x\\n\", val);\n\n\t\tr = core->read(core, WL1273_CHANL_SET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get CHANL fails.\\n\", __func__);\n\t\telse\n\t\t\tdev_info(dev, \"Tx frequency: %dkHz\\n\", val*10);\n\t} else if (core->mode == WL1273_MODE_RX) {\n\t\tint bf = radio->rangelow;\n\n\t\tr = core->read(core, WL1273_FREQ_SET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get FREQ fails.\\n\", __func__);\n\t\telse\n\t\t\tdev_info(dev, \"RX Frequency: %dkHz\\n\", bf + val*50);\n\n\t\tr = core->read(core, WL1273_MOST_MODE_SET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get MOST_MODE fails.\\n\",\n\t\t\t\t__func__);\n\t\telse if (val == 0)\n\t\t\tdev_info(dev, \"MOST_MODE: Stereo according to blend\\n\");\n\t\telse if (val == 1)\n\t\t\tdev_info(dev, \"MOST_MODE: Force mono output\\n\");\n\t\telse\n\t\t\tdev_info(dev, \"MOST_MODE: Unexpected value: %d\\n\", val);\n\n\t\tr = core->read(core, WL1273_MOST_BLEND_SET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get MOST_BLEND fails.\\n\", __func__);\n\t\telse if (val == 0)\n\t\t\tdev_info(dev,\n\t\t\t\t \"MOST_BLEND: Switched blend & hysteresis.\\n\");\n\t\telse if (val == 1)\n\t\t\tdev_info(dev, \"MOST_BLEND: Soft blend.\\n\");\n\t\telse\n\t\t\tdev_info(dev, \"MOST_BLEND: Unexpected val: %d\\n\", val);\n\n\t\tr = core->read(core, WL1273_STEREO_GET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get STEREO fails.\\n\", __func__);\n\t\telse if (val == 0)\n\t\t\tdev_info(dev, \"STEREO: Not detected\\n\");\n\t\telse if (val == 1)\n\t\t\tdev_info(dev, \"STEREO: Detected\\n\");\n\t\telse\n\t\t\tdev_info(dev, \"STEREO: Unexpected value: %d\\n\", val);\n\n\t\tr = core->read(core, WL1273_RSSI_LVL_GET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get RSSI_LVL fails.\\n\", __func__);\n\t\telse\n\t\t\tdev_info(dev, \"RX signal strength: %d\\n\", (s16) val);\n\n\t\tr = core->read(core, WL1273_POWER_SET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get POWER fails.\\n\", __func__);\n\t\telse\n\t\t\tdev_info(dev, \"POWER: 0x%04x\\n\", val);\n\n\t\tr = core->read(core, WL1273_INT_MASK_SET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get INT_MASK fails.\\n\", __func__);\n\t\telse\n\t\t\tdev_info(dev, \"INT_MASK: 0x%04x\\n\", val);\n\n\t\tr = core->read(core, WL1273_RDS_SYNC_GET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get RDS_SYNC fails.\\n\",\n\t\t\t\t__func__);\n\t\telse if (val == 0)\n\t\t\tdev_info(dev, \"RDS_SYNC: Not synchronized\\n\");\n\n\t\telse if (val == 1)\n\t\t\tdev_info(dev, \"RDS_SYNC: Synchronized\\n\");\n\t\telse\n\t\t\tdev_info(dev, \"RDS_SYNC: Unexpected value: %d\\n\", val);\n\n\t\tr = core->read(core, WL1273_I2S_MODE_CONFIG_SET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get I2S_MODE_CONFIG fails.\\n\",\n\t\t\t\t__func__);\n\t\telse\n\t\t\tdev_info(dev, \"I2S_MODE_CONFIG: 0x%04x\\n\", val);\n\n\t\tr = core->read(core, WL1273_VOLUME_SET, &val);\n\t\tif (r)\n\t\t\tdev_err(dev, \"%s: Get VOLUME fails.\\n\", __func__);\n\t\telse\n\t\t\tdev_info(dev, \"VOLUME: 0x%04x\\n\", val);\n\t}\n\n\treturn 0;\n}\n\nstatic void wl1273_vdev_release(struct video_device *dev)\n{\n}\n\nstatic const struct v4l2_ctrl_ops wl1273_ctrl_ops = {\n\t.s_ctrl = wl1273_fm_vidioc_s_ctrl,\n\t.g_volatile_ctrl = wl1273_fm_g_volatile_ctrl,\n};\n\nstatic const struct v4l2_ioctl_ops wl1273_ioctl_ops = {\n\t.vidioc_querycap\t= wl1273_fm_vidioc_querycap,\n\t.vidioc_g_input\t\t= wl1273_fm_vidioc_g_input,\n\t.vidioc_s_input\t\t= wl1273_fm_vidioc_s_input,\n\t.vidioc_g_audio\t\t= wl1273_fm_vidioc_g_audio,\n\t.vidioc_s_audio\t\t= wl1273_fm_vidioc_s_audio,\n\t.vidioc_g_tuner\t\t= wl1273_fm_vidioc_g_tuner,\n\t.vidioc_s_tuner\t\t= wl1273_fm_vidioc_s_tuner,\n\t.vidioc_g_frequency\t= wl1273_fm_vidioc_g_frequency,\n\t.vidioc_s_frequency\t= wl1273_fm_vidioc_s_frequency,\n\t.vidioc_s_hw_freq_seek\t= wl1273_fm_vidioc_s_hw_freq_seek,\n\t.vidioc_g_modulator\t= wl1273_fm_vidioc_g_modulator,\n\t.vidioc_s_modulator\t= wl1273_fm_vidioc_s_modulator,\n\t.vidioc_log_status      = wl1273_fm_vidioc_log_status,\n};\n\nstatic const struct video_device wl1273_viddev_template = {\n\t.fops\t\t\t= &wl1273_fops,\n\t.ioctl_ops\t\t= &wl1273_ioctl_ops,\n\t.name\t\t\t= WL1273_FM_DRIVER_NAME,\n\t.release\t\t= wl1273_vdev_release,\n\t.vfl_dir\t\t= VFL_DIR_TX,\n\t.device_caps\t\t= V4L2_CAP_HW_FREQ_SEEK | V4L2_CAP_TUNER |\n\t\t\t\t  V4L2_CAP_RADIO | V4L2_CAP_AUDIO |\n\t\t\t\t  V4L2_CAP_RDS_CAPTURE | V4L2_CAP_MODULATOR |\n\t\t\t\t  V4L2_CAP_RDS_OUTPUT,\n};\n\nstatic void wl1273_fm_radio_remove(struct platform_device *pdev)\n{\n\tstruct wl1273_device *radio = platform_get_drvdata(pdev);\n\tstruct wl1273_core *core = radio->core;\n\n\tdev_info(&pdev->dev, \"%s.\\n\", __func__);\n\n\tfree_irq(core->client->irq, radio);\n\tcore->pdata->free_resources();\n\n\tv4l2_ctrl_handler_free(&radio->ctrl_handler);\n\tvideo_unregister_device(&radio->videodev);\n\tv4l2_device_unregister(&radio->v4l2dev);\n}\n\nstatic int wl1273_fm_radio_probe(struct platform_device *pdev)\n{\n\tstruct wl1273_core **core = pdev->dev.platform_data;\n\tstruct wl1273_device *radio;\n\tstruct v4l2_ctrl *ctrl;\n\tint r = 0;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tif (!core) {\n\t\tdev_err(&pdev->dev, \"No platform data.\\n\");\n\t\tr = -EINVAL;\n\t\tgoto pdata_err;\n\t}\n\n\tradio = devm_kzalloc(&pdev->dev, sizeof(*radio), GFP_KERNEL);\n\tif (!radio) {\n\t\tr = -ENOMEM;\n\t\tgoto pdata_err;\n\t}\n\n\t \n\tradio->buf_size = rds_buf * RDS_BLOCK_SIZE;\n\tradio->buffer = devm_kzalloc(&pdev->dev, radio->buf_size, GFP_KERNEL);\n\tif (!radio->buffer) {\n\t\tpr_err(\"Cannot allocate memory for RDS buffer.\\n\");\n\t\tr = -ENOMEM;\n\t\tgoto pdata_err;\n\t}\n\n\tradio->core = *core;\n\tradio->irq_flags = WL1273_IRQ_MASK;\n\tradio->dev = &radio->core->client->dev;\n\tradio->rds_on = false;\n\tradio->core->mode = WL1273_MODE_OFF;\n\tradio->tx_power = 118;\n\tradio->core->audio_mode = WL1273_AUDIO_ANALOG;\n\tradio->band = WL1273_BAND_OTHER;\n\tradio->core->i2s_mode = WL1273_I2S_DEF_MODE;\n\tradio->core->channel_number = 2;\n\tradio->core->volume = WL1273_DEFAULT_VOLUME;\n\tradio->rx_frequency = WL1273_BAND_OTHER_LOW;\n\tradio->tx_frequency = WL1273_BAND_OTHER_HIGH;\n\tradio->rangelow = WL1273_BAND_OTHER_LOW;\n\tradio->rangehigh = WL1273_BAND_OTHER_HIGH;\n\tradio->stereo = true;\n\tradio->bus_type = \"I2C\";\n\n\tif (radio->core->pdata->request_resources) {\n\t\tr = radio->core->pdata->request_resources(radio->core->client);\n\t\tif (r) {\n\t\t\tdev_err(radio->dev, WL1273_FM_DRIVER_NAME\n\t\t\t\t\": Cannot get platform data\\n\");\n\t\t\tgoto pdata_err;\n\t\t}\n\n\t\tdev_dbg(radio->dev, \"irq: %d\\n\", radio->core->client->irq);\n\n\t\tr = request_threaded_irq(radio->core->client->irq, NULL,\n\t\t\t\t\t wl1273_fm_irq_thread_handler,\n\t\t\t\t\t IRQF_ONESHOT | IRQF_TRIGGER_FALLING,\n\t\t\t\t\t \"wl1273-fm\", radio);\n\t\tif (r < 0) {\n\t\t\tdev_err(radio->dev, WL1273_FM_DRIVER_NAME\n\t\t\t\t\": Unable to register IRQ handler: %d\\n\", r);\n\t\t\tgoto err_request_irq;\n\t\t}\n\t} else {\n\t\tdev_err(radio->dev, WL1273_FM_DRIVER_NAME \": Core WL1273 IRQ not configured\");\n\t\tr = -EINVAL;\n\t\tgoto pdata_err;\n\t}\n\n\tinit_completion(&radio->busy);\n\tinit_waitqueue_head(&radio->read_queue);\n\n\tradio->write_buf = devm_kzalloc(&pdev->dev, 256, GFP_KERNEL);\n\tif (!radio->write_buf) {\n\t\tr = -ENOMEM;\n\t\tgoto write_buf_err;\n\t}\n\n\tradio->dev = &pdev->dev;\n\tradio->v4l2dev.ctrl_handler = &radio->ctrl_handler;\n\tradio->rds_users = 0;\n\n\tr = v4l2_device_register(&pdev->dev, &radio->v4l2dev);\n\tif (r) {\n\t\tdev_err(&pdev->dev, \"Cannot register v4l2_device.\\n\");\n\t\tgoto write_buf_err;\n\t}\n\n\t \n\tradio->videodev = wl1273_viddev_template;\n\n\tradio->videodev.v4l2_dev = &radio->v4l2dev;\n\n\tv4l2_ctrl_handler_init(&radio->ctrl_handler, 6);\n\n\t \n\tv4l2_ctrl_new_std(&radio->ctrl_handler, &wl1273_ctrl_ops,\n\t\t\t  V4L2_CID_AUDIO_VOLUME, 0, WL1273_MAX_VOLUME, 1,\n\t\t\t  WL1273_DEFAULT_VOLUME);\n\n\tv4l2_ctrl_new_std(&radio->ctrl_handler, &wl1273_ctrl_ops,\n\t\t\t  V4L2_CID_AUDIO_MUTE, 0, 1, 1, 1);\n\n\tv4l2_ctrl_new_std_menu(&radio->ctrl_handler, &wl1273_ctrl_ops,\n\t\t\t       V4L2_CID_TUNE_PREEMPHASIS,\n\t\t\t       V4L2_PREEMPHASIS_75_uS, 0x03,\n\t\t\t       V4L2_PREEMPHASIS_50_uS);\n\n\tv4l2_ctrl_new_std(&radio->ctrl_handler, &wl1273_ctrl_ops,\n\t\t\t  V4L2_CID_TUNE_POWER_LEVEL, 91, 122, 1, 118);\n\n\tctrl = v4l2_ctrl_new_std(&radio->ctrl_handler, &wl1273_ctrl_ops,\n\t\t\t\t V4L2_CID_TUNE_ANTENNA_CAPACITOR,\n\t\t\t\t 0, 255, 1, 255);\n\tif (ctrl)\n\t\tctrl->flags |= V4L2_CTRL_FLAG_VOLATILE;\n\n\tif (radio->ctrl_handler.error) {\n\t\tr = radio->ctrl_handler.error;\n\t\tdev_err(&pdev->dev, \"Ctrl handler error: %d\\n\", r);\n\t\tgoto handler_init_err;\n\t}\n\n\tvideo_set_drvdata(&radio->videodev, radio);\n\tplatform_set_drvdata(pdev, radio);\n\n\t \n\tr = video_register_device(&radio->videodev, VFL_TYPE_RADIO, radio_nr);\n\tif (r) {\n\t\tdev_err(&pdev->dev, WL1273_FM_DRIVER_NAME\n\t\t\t\": Could not register video device\\n\");\n\t\tgoto handler_init_err;\n\t}\n\n\treturn 0;\n\nhandler_init_err:\n\tv4l2_ctrl_handler_free(&radio->ctrl_handler);\n\tv4l2_device_unregister(&radio->v4l2dev);\nwrite_buf_err:\n\tfree_irq(radio->core->client->irq, radio);\nerr_request_irq:\n\tradio->core->pdata->free_resources();\npdata_err:\n\treturn r;\n}\n\nstatic struct platform_driver wl1273_fm_radio_driver = {\n\t.probe\t\t= wl1273_fm_radio_probe,\n\t.remove_new\t= wl1273_fm_radio_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"wl1273_fm_radio\",\n\t},\n};\n\nmodule_platform_driver(wl1273_fm_radio_driver);\n\nMODULE_AUTHOR(\"Matti Aaltonen <matti.j.aaltonen@nokia.com>\");\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:wl1273_fm_radio\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}