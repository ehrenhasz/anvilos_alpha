{
  "module_name": "radio-tea5764.c",
  "hash_id": "2a0c62b0ea87928c1ac32e458838411ceeeea82f40bc124dc030310f44813d5d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/radio/radio-tea5764.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/init.h>\t\t\t \n#include <linux/videodev2.h>\t\t \n#include <linux/i2c.h>\t\t\t \n#include <media/v4l2-common.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-event.h>\n\n#define DRIVER_VERSION\t\"0.0.2\"\n\n#define DRIVER_AUTHOR\t\"Fabio Belavenuto <belavenuto@gmail.com>\"\n#define DRIVER_DESC\t\"A driver for the TEA5764 radio chip for EZX Phones.\"\n\n#define PINFO(format, ...)\\\n\tprintk(KERN_INFO KBUILD_MODNAME \": \"\\\n\t\tDRIVER_VERSION \": \" format \"\\n\", ## __VA_ARGS__)\n#define PWARN(format, ...)\\\n\tprintk(KERN_WARNING KBUILD_MODNAME \": \"\\\n\t\tDRIVER_VERSION \": \" format \"\\n\", ## __VA_ARGS__)\n# define PDEBUG(format, ...)\\\n\tprintk(KERN_DEBUG KBUILD_MODNAME \": \"\\\n\t\tDRIVER_VERSION \": \" format \"\\n\", ## __VA_ARGS__)\n\n \n#define FREQ_MIN  87500U\n#define FREQ_MAX 108000U\n#define FREQ_MUL 16\n\n \n#define TEA5764_MANID\t\t0x002b\n#define TEA5764_CHIPID\t\t0x5764\n\n#define TEA5764_INTREG_BLMSK\t0x0001\n#define TEA5764_INTREG_FRRMSK\t0x0002\n#define TEA5764_INTREG_LEVMSK\t0x0008\n#define TEA5764_INTREG_IFMSK\t0x0010\n#define TEA5764_INTREG_BLMFLAG\t0x0100\n#define TEA5764_INTREG_FRRFLAG\t0x0200\n#define TEA5764_INTREG_LEVFLAG\t0x0800\n#define TEA5764_INTREG_IFFLAG\t0x1000\n\n#define TEA5764_FRQSET_SUD\t0x8000\n#define TEA5764_FRQSET_SM\t0x4000\n\n#define TEA5764_TNCTRL_PUPD1\t0x8000\n#define TEA5764_TNCTRL_PUPD0\t0x4000\n#define TEA5764_TNCTRL_BLIM\t0x2000\n#define TEA5764_TNCTRL_SWPM\t0x1000\n#define TEA5764_TNCTRL_IFCTC\t0x0800\n#define TEA5764_TNCTRL_AFM\t0x0400\n#define TEA5764_TNCTRL_SMUTE\t0x0200\n#define TEA5764_TNCTRL_SNC\t0x0100\n#define TEA5764_TNCTRL_MU\t0x0080\n#define TEA5764_TNCTRL_SSL1\t0x0040\n#define TEA5764_TNCTRL_SSL0\t0x0020\n#define TEA5764_TNCTRL_HLSI\t0x0010\n#define TEA5764_TNCTRL_MST\t0x0008\n#define TEA5764_TNCTRL_SWP\t0x0004\n#define TEA5764_TNCTRL_DTC\t0x0002\n#define TEA5764_TNCTRL_AHLSI\t0x0001\n\n#define TEA5764_TUNCHK_LEVEL(x)\t(((x) & 0x00F0) >> 4)\n#define TEA5764_TUNCHK_IFCNT(x) (((x) & 0xFE00) >> 9)\n#define TEA5764_TUNCHK_TUNTO\t0x0100\n#define TEA5764_TUNCHK_LD\t0x0008\n#define TEA5764_TUNCHK_STEREO\t0x0004\n\n#define TEA5764_TESTREG_TRIGFR\t0x0800\n\nstruct tea5764_regs {\n\tu16 intreg;\t\t\t\t \n\tu16 frqset;\t\t\t\t \n\tu16 tnctrl;\t\t\t\t \n\tu16 frqchk;\t\t\t\t \n\tu16 tunchk;\t\t\t\t \n\tu16 testreg;\t\t\t\t \n\tu16 rdsstat;\t\t\t\t \n\tu16 rdslb;\t\t\t\t \n\tu16 rdspb;\t\t\t\t \n\tu16 rdsbc;\t\t\t\t \n\tu16 rdsctrl;\t\t\t\t \n\tu16 rdsbbl;\t\t\t\t \n\tu16 manid;\t\t\t\t \n\tu16 chipid;\t\t\t\t \n} __attribute__ ((packed));\n\nstruct tea5764_write_regs {\n\tu8 intreg;\t\t\t\t \n\t__be16 frqset;\t\t\t\t \n\t__be16 tnctrl;\t\t\t\t \n\t__be16 testreg;\t\t\t\t \n\t__be16 rdsctrl;\t\t\t\t \n\t__be16 rdsbbl;\t\t\t\t \n} __attribute__ ((packed));\n\n#ifdef CONFIG_RADIO_TEA5764_XTAL\n#define RADIO_TEA5764_XTAL 1\n#else\n#define RADIO_TEA5764_XTAL 0\n#endif\n\nstatic int radio_nr = -1;\nstatic int use_xtal = RADIO_TEA5764_XTAL;\n\nstruct tea5764_device {\n\tstruct v4l2_device\t\tv4l2_dev;\n\tstruct v4l2_ctrl_handler\tctrl_handler;\n\tstruct i2c_client\t\t*i2c_client;\n\tstruct video_device\t\tvdev;\n\tstruct tea5764_regs\t\tregs;\n\tstruct mutex\t\t\tmutex;\n};\n\n \nstatic int tea5764_i2c_read(struct tea5764_device *radio)\n{\n\tint i;\n\tu16 *p = (u16 *) &radio->regs;\n\n\tstruct i2c_msg msgs[1] = {\n\t\t{\t.addr = radio->i2c_client->addr,\n\t\t\t.flags = I2C_M_RD,\n\t\t\t.len = sizeof(radio->regs),\n\t\t\t.buf = (void *)&radio->regs\n\t\t},\n\t};\n\tif (i2c_transfer(radio->i2c_client->adapter, msgs, 1) != 1)\n\t\treturn -EIO;\n\tfor (i = 0; i < sizeof(struct tea5764_regs) / sizeof(u16); i++)\n\t\tp[i] = __be16_to_cpu((__force __be16)p[i]);\n\n\treturn 0;\n}\n\nstatic int tea5764_i2c_write(struct tea5764_device *radio)\n{\n\tstruct tea5764_write_regs wr;\n\tstruct tea5764_regs *r = &radio->regs;\n\tstruct i2c_msg msgs[1] = {\n\t\t{\n\t\t\t.addr = radio->i2c_client->addr,\n\t\t\t.len = sizeof(wr),\n\t\t\t.buf = (void *)&wr\n\t\t},\n\t};\n\twr.intreg  = r->intreg & 0xff;\n\twr.frqset  = __cpu_to_be16(r->frqset);\n\twr.tnctrl  = __cpu_to_be16(r->tnctrl);\n\twr.testreg = __cpu_to_be16(r->testreg);\n\twr.rdsctrl = __cpu_to_be16(r->rdsctrl);\n\twr.rdsbbl  = __cpu_to_be16(r->rdsbbl);\n\tif (i2c_transfer(radio->i2c_client->adapter, msgs, 1) != 1)\n\t\treturn -EIO;\n\treturn 0;\n}\n\nstatic void tea5764_power_up(struct tea5764_device *radio)\n{\n\tstruct tea5764_regs *r = &radio->regs;\n\n\tif (!(r->tnctrl & TEA5764_TNCTRL_PUPD0)) {\n\t\tr->tnctrl &= ~(TEA5764_TNCTRL_AFM | TEA5764_TNCTRL_MU |\n\t\t\t       TEA5764_TNCTRL_HLSI);\n\t\tif (!use_xtal)\n\t\t\tr->testreg |= TEA5764_TESTREG_TRIGFR;\n\t\telse\n\t\t\tr->testreg &= ~TEA5764_TESTREG_TRIGFR;\n\n\t\tr->tnctrl |= TEA5764_TNCTRL_PUPD0;\n\t\ttea5764_i2c_write(radio);\n\t}\n}\n\nstatic void tea5764_power_down(struct tea5764_device *radio)\n{\n\tstruct tea5764_regs *r = &radio->regs;\n\n\tif (r->tnctrl & TEA5764_TNCTRL_PUPD0) {\n\t\tr->tnctrl &= ~TEA5764_TNCTRL_PUPD0;\n\t\ttea5764_i2c_write(radio);\n\t}\n}\n\nstatic void tea5764_set_freq(struct tea5764_device *radio, int freq)\n{\n\tstruct tea5764_regs *r = &radio->regs;\n\n\t \n\tif (r->tnctrl & TEA5764_TNCTRL_HLSI)\n\t\tr->frqset = (freq + 225000) / 8192;\n\telse\n\t\tr->frqset = (freq - 225000) / 8192;\n}\n\nstatic int tea5764_get_freq(struct tea5764_device *radio)\n{\n\tstruct tea5764_regs *r = &radio->regs;\n\n\tif (r->tnctrl & TEA5764_TNCTRL_HLSI)\n\t\treturn (r->frqchk * 8192) - 225000;\n\telse\n\t\treturn (r->frqchk * 8192) + 225000;\n}\n\n \nstatic void tea5764_tune(struct tea5764_device *radio, int freq)\n{\n\ttea5764_set_freq(radio, freq);\n\tif (tea5764_i2c_write(radio))\n\t\tPWARN(\"Could not set frequency!\");\n}\n\nstatic void tea5764_set_audout_mode(struct tea5764_device *radio, int audmode)\n{\n\tstruct tea5764_regs *r = &radio->regs;\n\tint tnctrl = r->tnctrl;\n\n\tif (audmode == V4L2_TUNER_MODE_MONO)\n\t\tr->tnctrl |= TEA5764_TNCTRL_MST;\n\telse\n\t\tr->tnctrl &= ~TEA5764_TNCTRL_MST;\n\tif (tnctrl != r->tnctrl)\n\t\ttea5764_i2c_write(radio);\n}\n\nstatic int tea5764_get_audout_mode(struct tea5764_device *radio)\n{\n\tstruct tea5764_regs *r = &radio->regs;\n\n\tif (r->tnctrl & TEA5764_TNCTRL_MST)\n\t\treturn V4L2_TUNER_MODE_MONO;\n\telse\n\t\treturn V4L2_TUNER_MODE_STEREO;\n}\n\nstatic void tea5764_mute(struct tea5764_device *radio, int on)\n{\n\tstruct tea5764_regs *r = &radio->regs;\n\tint tnctrl = r->tnctrl;\n\n\tif (on)\n\t\tr->tnctrl |= TEA5764_TNCTRL_MU;\n\telse\n\t\tr->tnctrl &= ~TEA5764_TNCTRL_MU;\n\tif (tnctrl != r->tnctrl)\n\t\ttea5764_i2c_write(radio);\n}\n\n \nstatic int vidioc_querycap(struct file *file, void  *priv,\n\t\t\t\t\tstruct v4l2_capability *v)\n{\n\tstruct tea5764_device *radio = video_drvdata(file);\n\tstruct video_device *dev = &radio->vdev;\n\n\tstrscpy(v->driver, dev->dev.driver->name, sizeof(v->driver));\n\tstrscpy(v->card, dev->name, sizeof(v->card));\n\tsnprintf(v->bus_info, sizeof(v->bus_info),\n\t\t \"I2C:%s\", dev_name(&dev->dev));\n\treturn 0;\n}\n\nstatic int vidioc_g_tuner(struct file *file, void *priv,\n\t\t\t\tstruct v4l2_tuner *v)\n{\n\tstruct tea5764_device *radio = video_drvdata(file);\n\tstruct tea5764_regs *r = &radio->regs;\n\n\tif (v->index > 0)\n\t\treturn -EINVAL;\n\n\tstrscpy(v->name, \"FM\", sizeof(v->name));\n\tv->type = V4L2_TUNER_RADIO;\n\ttea5764_i2c_read(radio);\n\tv->rangelow   = FREQ_MIN * FREQ_MUL;\n\tv->rangehigh  = FREQ_MAX * FREQ_MUL;\n\tv->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO;\n\tif (r->tunchk & TEA5764_TUNCHK_STEREO)\n\t\tv->rxsubchans = V4L2_TUNER_SUB_STEREO;\n\telse\n\t\tv->rxsubchans = V4L2_TUNER_SUB_MONO;\n\tv->audmode = tea5764_get_audout_mode(radio);\n\tv->signal = TEA5764_TUNCHK_LEVEL(r->tunchk) * 0xffff / 0xf;\n\tv->afc = TEA5764_TUNCHK_IFCNT(r->tunchk);\n\n\treturn 0;\n}\n\nstatic int vidioc_s_tuner(struct file *file, void *priv,\n\t\t\t\tconst struct v4l2_tuner *v)\n{\n\tstruct tea5764_device *radio = video_drvdata(file);\n\n\tif (v->index > 0)\n\t\treturn -EINVAL;\n\n\ttea5764_set_audout_mode(radio, v->audmode);\n\treturn 0;\n}\n\nstatic int vidioc_s_frequency(struct file *file, void *priv,\n\t\t\t\tconst struct v4l2_frequency *f)\n{\n\tstruct tea5764_device *radio = video_drvdata(file);\n\tunsigned freq = f->frequency;\n\n\tif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\n\t\treturn -EINVAL;\n\tif (freq == 0) {\n\t\t \n\t\ttea5764_power_down(radio);\n\t\t \n\t\treturn -EINVAL;\n\t}\n\tfreq = clamp(freq, FREQ_MIN * FREQ_MUL, FREQ_MAX * FREQ_MUL);\n\ttea5764_power_up(radio);\n\ttea5764_tune(radio, (freq * 125) / 2);\n\treturn 0;\n}\n\nstatic int vidioc_g_frequency(struct file *file, void *priv,\n\t\t\t\tstruct v4l2_frequency *f)\n{\n\tstruct tea5764_device *radio = video_drvdata(file);\n\tstruct tea5764_regs *r = &radio->regs;\n\n\tif (f->tuner != 0)\n\t\treturn -EINVAL;\n\ttea5764_i2c_read(radio);\n\tf->type = V4L2_TUNER_RADIO;\n\tif (r->tnctrl & TEA5764_TNCTRL_PUPD0)\n\t\tf->frequency = (tea5764_get_freq(radio) * 2) / 125;\n\telse\n\t\tf->frequency = 0;\n\n\treturn 0;\n}\n\nstatic int tea5764_s_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct tea5764_device *radio =\n\t\tcontainer_of(ctrl->handler, struct tea5764_device, ctrl_handler);\n\n\tswitch (ctrl->id) {\n\tcase V4L2_CID_AUDIO_MUTE:\n\t\ttea5764_mute(radio, ctrl->val);\n\t\treturn 0;\n\t}\n\treturn -EINVAL;\n}\n\nstatic const struct v4l2_ctrl_ops tea5764_ctrl_ops = {\n\t.s_ctrl = tea5764_s_ctrl,\n};\n\n \nstatic const struct v4l2_file_operations tea5764_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.open\t\t= v4l2_fh_open,\n\t.release\t= v4l2_fh_release,\n\t.poll\t\t= v4l2_ctrl_poll,\n\t.unlocked_ioctl\t= video_ioctl2,\n};\n\nstatic const struct v4l2_ioctl_ops tea5764_ioctl_ops = {\n\t.vidioc_querycap    = vidioc_querycap,\n\t.vidioc_g_tuner     = vidioc_g_tuner,\n\t.vidioc_s_tuner     = vidioc_s_tuner,\n\t.vidioc_g_frequency = vidioc_g_frequency,\n\t.vidioc_s_frequency = vidioc_s_frequency,\n\t.vidioc_log_status  = v4l2_ctrl_log_status,\n\t.vidioc_subscribe_event = v4l2_ctrl_subscribe_event,\n\t.vidioc_unsubscribe_event = v4l2_event_unsubscribe,\n};\n\n \nstatic const struct video_device tea5764_radio_template = {\n\t.name\t\t= \"TEA5764 FM-Radio\",\n\t.fops           = &tea5764_fops,\n\t.ioctl_ops\t= &tea5764_ioctl_ops,\n\t.release\t= video_device_release_empty,\n};\n\n \nstatic int tea5764_i2c_probe(struct i2c_client *client)\n{\n\tstruct tea5764_device *radio;\n\tstruct v4l2_device *v4l2_dev;\n\tstruct v4l2_ctrl_handler *hdl;\n\tstruct tea5764_regs *r;\n\tint ret;\n\n\tPDEBUG(\"probe\");\n\tradio = kzalloc(sizeof(struct tea5764_device), GFP_KERNEL);\n\tif (!radio)\n\t\treturn -ENOMEM;\n\n\tv4l2_dev = &radio->v4l2_dev;\n\tret = v4l2_device_register(&client->dev, v4l2_dev);\n\tif (ret < 0) {\n\t\tv4l2_err(v4l2_dev, \"could not register v4l2_device\\n\");\n\t\tgoto errfr;\n\t}\n\n\thdl = &radio->ctrl_handler;\n\tv4l2_ctrl_handler_init(hdl, 1);\n\tv4l2_ctrl_new_std(hdl, &tea5764_ctrl_ops,\n\t\t\tV4L2_CID_AUDIO_MUTE, 0, 1, 1, 1);\n\tv4l2_dev->ctrl_handler = hdl;\n\tif (hdl->error) {\n\t\tret = hdl->error;\n\t\tv4l2_err(v4l2_dev, \"Could not register controls\\n\");\n\t\tgoto errunreg;\n\t}\n\n\tmutex_init(&radio->mutex);\n\tradio->i2c_client = client;\n\tret = tea5764_i2c_read(radio);\n\tif (ret)\n\t\tgoto errunreg;\n\tr = &radio->regs;\n\tPDEBUG(\"chipid = %04X, manid = %04X\", r->chipid, r->manid);\n\tif (r->chipid != TEA5764_CHIPID ||\n\t\t(r->manid & 0x0fff) != TEA5764_MANID) {\n\t\tPWARN(\"This chip is not a TEA5764!\");\n\t\tret = -EINVAL;\n\t\tgoto errunreg;\n\t}\n\n\tradio->vdev = tea5764_radio_template;\n\n\ti2c_set_clientdata(client, radio);\n\tvideo_set_drvdata(&radio->vdev, radio);\n\tradio->vdev.lock = &radio->mutex;\n\tradio->vdev.v4l2_dev = v4l2_dev;\n\tradio->vdev.device_caps = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\n\n\t \n\ttea5764_i2c_read(radio);\n\ttea5764_set_audout_mode(radio, V4L2_TUNER_MODE_STEREO);\n\ttea5764_mute(radio, 1);\n\ttea5764_power_down(radio);\n\n\tret = video_register_device(&radio->vdev, VFL_TYPE_RADIO, radio_nr);\n\tif (ret < 0) {\n\t\tPWARN(\"Could not register video device!\");\n\t\tgoto errunreg;\n\t}\n\n\tPINFO(\"registered.\");\n\treturn 0;\nerrunreg:\n\tv4l2_ctrl_handler_free(hdl);\n\tv4l2_device_unregister(v4l2_dev);\nerrfr:\n\tkfree(radio);\n\treturn ret;\n}\n\nstatic void tea5764_i2c_remove(struct i2c_client *client)\n{\n\tstruct tea5764_device *radio = i2c_get_clientdata(client);\n\n\tPDEBUG(\"remove\");\n\tif (radio) {\n\t\ttea5764_power_down(radio);\n\t\tvideo_unregister_device(&radio->vdev);\n\t\tv4l2_ctrl_handler_free(&radio->ctrl_handler);\n\t\tv4l2_device_unregister(&radio->v4l2_dev);\n\t\tkfree(radio);\n\t}\n}\n\n \nstatic const struct i2c_device_id tea5764_id[] = {\n\t{ \"radio-tea5764\", 0 },\n\t{ }\t\t\t\t\t \n};\nMODULE_DEVICE_TABLE(i2c, tea5764_id);\n\nstatic struct i2c_driver tea5764_i2c_driver = {\n\t.driver = {\n\t\t.name = \"radio-tea5764\",\n\t},\n\t.probe = tea5764_i2c_probe,\n\t.remove = tea5764_i2c_remove,\n\t.id_table = tea5764_id,\n};\n\nmodule_i2c_driver(tea5764_i2c_driver);\n\nMODULE_AUTHOR(DRIVER_AUTHOR);\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL\");\nMODULE_VERSION(DRIVER_VERSION);\n\nmodule_param(use_xtal, int, 0);\nMODULE_PARM_DESC(use_xtal, \"Chip have a xtal connected in board\");\nmodule_param(radio_nr, int, 0);\nMODULE_PARM_DESC(radio_nr, \"video4linux device number to use\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}