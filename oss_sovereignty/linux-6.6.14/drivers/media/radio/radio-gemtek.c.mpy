{
  "module_name": "radio-gemtek.c",
  "hash_id": "9e0a8f3886d1aebed806d47a92d1246616611ec1b0ed899a372d68a8fd550222",
  "original_prompt": "Ingested from linux-6.6.14/drivers/media/radio/radio-gemtek.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\t \n#include <linux/init.h>\t\t \n#include <linux/ioport.h>\t \n#include <linux/delay.h>\t \n#include <linux/videodev2.h>\t \n#include <linux/mutex.h>\n#include <linux/io.h>\t\t \n#include <linux/pnp.h>\n#include <linux/slab.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-device.h>\n#include \"radio-isa.h\"\n\n \n\nMODULE_AUTHOR(\"Jonas Munsin, Pekka Sepp\u00e4nen <pexu@kapsi.fi>\");\nMODULE_DESCRIPTION(\"A driver for the GemTek Radio card.\");\nMODULE_LICENSE(\"GPL\");\nMODULE_VERSION(\"1.0.0\");\n\n \n\n#ifndef CONFIG_RADIO_GEMTEK_PORT\n#define CONFIG_RADIO_GEMTEK_PORT -1\n#endif\n#ifndef CONFIG_RADIO_GEMTEK_PROBE\n#define CONFIG_RADIO_GEMTEK_PROBE 1\n#endif\n\n#define GEMTEK_MAX 4\n\nstatic bool probe = CONFIG_RADIO_GEMTEK_PROBE;\nstatic bool hardmute;\nstatic int io[GEMTEK_MAX] = { [0] = CONFIG_RADIO_GEMTEK_PORT,\n\t\t\t      [1 ... (GEMTEK_MAX - 1)] = -1 };\nstatic int radio_nr[GEMTEK_MAX]\t= { [0 ... (GEMTEK_MAX - 1)] = -1 };\n\nmodule_param(probe, bool, 0444);\nMODULE_PARM_DESC(probe, \"Enable automatic device probing.\");\n\nmodule_param(hardmute, bool, 0644);\nMODULE_PARM_DESC(hardmute, \"Enable 'hard muting' by shutting down PLL, may reduce static noise.\");\n\nmodule_param_array(io, int, NULL, 0444);\nMODULE_PARM_DESC(io, \"Force I/O ports for the GemTek Radio card if automatic probing is disabled or fails. The most common I/O ports are: 0x20c 0x30c, 0x24c or 0x34c (0x20c, 0x248 and 0x28c have been reported to work for the combined sound/radiocard).\");\n\nmodule_param_array(radio_nr, int, NULL, 0444);\nMODULE_PARM_DESC(radio_nr, \"Radio device numbers\");\n\n \n#define FSCALE\t\t8\n#define IF_OFFSET\t((unsigned int)(10.52 * 16000 * (1<<FSCALE)))\n#define REF_FREQ\t((unsigned int)(6.39 * 16 * (1<<FSCALE)))\n\n#define GEMTEK_CK\t\t0x01\t \n#define GEMTEK_DA\t\t0x02\t \n#define GEMTEK_CE\t\t0x04\t \n#define GEMTEK_NS\t\t0x08\t \n#define GEMTEK_MT\t\t0x10\t \n#define GEMTEK_STDF_3_125_KHZ\t0x01\t \n#define GEMTEK_PLL_OFF\t\t0x07\t \n\n#define BU2614_BUS_SIZE\t32\t \n\n#define SHORT_DELAY 5\t\t \n#define LONG_DELAY 75\t\t \n\nstruct gemtek {\n\tstruct radio_isa_card isa;\n\tbool muted;\n\tu32 bu2614data;\n};\n\n#define BU2614_FREQ_BITS\t16  \n#define BU2614_PORT_BITS\t3  \n#define BU2614_VOID_BITS\t4  \n#define BU2614_FMES_BITS\t1  \n#define BU2614_STDF_BITS\t3  \n#define BU2614_SWIN_BITS\t1  \n#define BU2614_SWAL_BITS        1  \n#define BU2614_VOID2_BITS\t1  \n#define BU2614_FMUN_BITS\t1  \n#define BU2614_TEST_BITS\t1  \n\n#define BU2614_FREQ_SHIFT\t0\n#define BU2614_PORT_SHIFT\t(BU2614_FREQ_BITS + BU2614_FREQ_SHIFT)\n#define BU2614_VOID_SHIFT\t(BU2614_PORT_BITS + BU2614_PORT_SHIFT)\n#define BU2614_FMES_SHIFT\t(BU2614_VOID_BITS + BU2614_VOID_SHIFT)\n#define BU2614_STDF_SHIFT\t(BU2614_FMES_BITS + BU2614_FMES_SHIFT)\n#define BU2614_SWIN_SHIFT\t(BU2614_STDF_BITS + BU2614_STDF_SHIFT)\n#define BU2614_SWAL_SHIFT\t(BU2614_SWIN_BITS + BU2614_SWIN_SHIFT)\n#define BU2614_VOID2_SHIFT\t(BU2614_SWAL_BITS + BU2614_SWAL_SHIFT)\n#define BU2614_FMUN_SHIFT\t(BU2614_VOID2_BITS + BU2614_VOID2_SHIFT)\n#define BU2614_TEST_SHIFT\t(BU2614_FMUN_BITS + BU2614_FMUN_SHIFT)\n\n#define MKMASK(field)\t(((1UL<<BU2614_##field##_BITS) - 1) << \\\n\t\t\tBU2614_##field##_SHIFT)\n#define BU2614_PORT_MASK\tMKMASK(PORT)\n#define BU2614_FREQ_MASK\tMKMASK(FREQ)\n#define BU2614_VOID_MASK\tMKMASK(VOID)\n#define BU2614_FMES_MASK\tMKMASK(FMES)\n#define BU2614_STDF_MASK\tMKMASK(STDF)\n#define BU2614_SWIN_MASK\tMKMASK(SWIN)\n#define BU2614_SWAL_MASK\tMKMASK(SWAL)\n#define BU2614_VOID2_MASK\tMKMASK(VOID2)\n#define BU2614_FMUN_MASK\tMKMASK(FMUN)\n#define BU2614_TEST_MASK\tMKMASK(TEST)\n\n \n#define gemtek_bu2614_set(dev, field, data) ((dev)->bu2614data = \\\n\t((dev)->bu2614data & ~field##_MASK) | ((data) << field##_SHIFT))\n\n \nstatic void gemtek_bu2614_transmit(struct gemtek *gt)\n{\n\tstruct radio_isa_card *isa = &gt->isa;\n\tint i, bit, q, mute;\n\n\tmute = gt->muted ? GEMTEK_MT : 0x00;\n\n\toutb_p(mute | GEMTEK_CE | GEMTEK_DA | GEMTEK_CK, isa->io);\n\tudelay(LONG_DELAY);\n\n\tfor (i = 0, q = gt->bu2614data; i < 32; i++, q >>= 1) {\n\t\tbit = (q & 1) ? GEMTEK_DA : 0;\n\t\toutb_p(mute | GEMTEK_CE | bit, isa->io);\n\t\tudelay(SHORT_DELAY);\n\t\toutb_p(mute | GEMTEK_CE | bit | GEMTEK_CK, isa->io);\n\t\tudelay(SHORT_DELAY);\n\t}\n\n\toutb_p(mute | GEMTEK_DA | GEMTEK_CK, isa->io);\n\tudelay(SHORT_DELAY);\n}\n\n \nstatic unsigned long gemtek_convfreq(unsigned long freq)\n{\n\treturn ((freq << FSCALE) + IF_OFFSET + REF_FREQ / 2) / REF_FREQ;\n}\n\nstatic struct radio_isa_card *gemtek_alloc(void)\n{\n\tstruct gemtek *gt = kzalloc(sizeof(*gt), GFP_KERNEL);\n\n\tif (gt)\n\t\tgt->muted = true;\n\treturn gt ? &gt->isa : NULL;\n}\n\n \nstatic int gemtek_s_frequency(struct radio_isa_card *isa, u32 freq)\n{\n\tstruct gemtek *gt = container_of(isa, struct gemtek, isa);\n\n\tif (hardmute && gt->muted)\n\t\treturn 0;\n\n\tgemtek_bu2614_set(gt, BU2614_PORT, 0);\n\tgemtek_bu2614_set(gt, BU2614_FMES, 0);\n\tgemtek_bu2614_set(gt, BU2614_SWIN, 0);\t \n\tgemtek_bu2614_set(gt, BU2614_SWAL, 0);\n\tgemtek_bu2614_set(gt, BU2614_FMUN, 1);\t \n\tgemtek_bu2614_set(gt, BU2614_TEST, 0);\n\tgemtek_bu2614_set(gt, BU2614_STDF, GEMTEK_STDF_3_125_KHZ);\n\tgemtek_bu2614_set(gt, BU2614_FREQ, gemtek_convfreq(freq));\n\tgemtek_bu2614_transmit(gt);\n\treturn 0;\n}\n\n \nstatic int gemtek_s_mute_volume(struct radio_isa_card *isa, bool mute, int vol)\n{\n\tstruct gemtek *gt = container_of(isa, struct gemtek, isa);\n\tint i;\n\n\tgt->muted = mute;\n\tif (hardmute) {\n\t\tif (!mute)\n\t\t\treturn gemtek_s_frequency(isa, isa->freq);\n\n\t\t \n\t\tgemtek_bu2614_set(gt, BU2614_PORT, 0);\n\t\tgemtek_bu2614_set(gt, BU2614_FMES, 0);\t \n\t\tgemtek_bu2614_set(gt, BU2614_SWIN, 0);\t \n\t\tgemtek_bu2614_set(gt, BU2614_SWAL, 0);\n\t\tgemtek_bu2614_set(gt, BU2614_FMUN, 0);\t \n\t\tgemtek_bu2614_set(gt, BU2614_TEST, 0);\n\t\tgemtek_bu2614_set(gt, BU2614_STDF, GEMTEK_PLL_OFF);\n\t\tgemtek_bu2614_set(gt, BU2614_FREQ, 0);\n\t\tgemtek_bu2614_transmit(gt);\n\t\treturn 0;\n\t}\n\n\t \n\ti = inb_p(isa->io);\n\t \n\toutb_p((i >> 5) | (mute ? GEMTEK_MT : 0), isa->io);\n\tudelay(SHORT_DELAY);\n\treturn 0;\n}\n\nstatic u32 gemtek_g_rxsubchans(struct radio_isa_card *isa)\n{\n\tif (inb_p(isa->io) & GEMTEK_NS)\n\t\treturn V4L2_TUNER_SUB_MONO;\n\treturn V4L2_TUNER_SUB_STEREO;\n}\n\n \nstatic bool gemtek_probe(struct radio_isa_card *isa, int io)\n{\n\tint i, q;\n\n\tq = inb_p(io);\t \n\t \n\tfor (i = 0; i < 3; ++i) {\n\t\toutb_p(1 << i, io);\n\t\tudelay(SHORT_DELAY);\n\n\t\tif ((inb_p(io) & ~GEMTEK_NS) != (0x17 | (1 << (i + 5))))\n\t\t\treturn false;\n\t}\n\toutb_p(q >> 5, io);\t \n\tudelay(SHORT_DELAY);\n\treturn true;\n}\n\nstatic const struct radio_isa_ops gemtek_ops = {\n\t.alloc = gemtek_alloc,\n\t.probe = gemtek_probe,\n\t.s_mute_volume = gemtek_s_mute_volume,\n\t.s_frequency = gemtek_s_frequency,\n\t.g_rxsubchans = gemtek_g_rxsubchans,\n};\n\nstatic const int gemtek_ioports[] = { 0x20c, 0x30c, 0x24c, 0x34c, 0x248, 0x28c };\n\n#ifdef CONFIG_PNP\nstatic const struct pnp_device_id gemtek_pnp_devices[] = {\n\t \n\t{.id = \"ADS7183\", .driver_data = 0},\n\t{.id = \"\"}\n};\n\nMODULE_DEVICE_TABLE(pnp, gemtek_pnp_devices);\n#endif\n\nstatic struct radio_isa_driver gemtek_driver = {\n\t.driver = {\n\t\t.match\t\t= radio_isa_match,\n\t\t.probe\t\t= radio_isa_probe,\n\t\t.remove\t\t= radio_isa_remove,\n\t\t.driver\t\t= {\n\t\t\t.name\t= \"radio-gemtek\",\n\t\t},\n\t},\n#ifdef CONFIG_PNP\n\t.pnp_driver = {\n\t\t.name\t\t= \"radio-gemtek\",\n\t\t.id_table\t= gemtek_pnp_devices,\n\t\t.probe\t\t= radio_isa_pnp_probe,\n\t\t.remove\t\t= radio_isa_pnp_remove,\n\t},\n#endif\n\t.io_params = io,\n\t.radio_nr_params = radio_nr,\n\t.io_ports = gemtek_ioports,\n\t.num_of_io_ports = ARRAY_SIZE(gemtek_ioports),\n\t.region_size = 1,\n\t.card = \"GemTek Radio\",\n\t.ops = &gemtek_ops,\n\t.has_stereo = true,\n};\n\nstatic int __init gemtek_init(void)\n{\n\tgemtek_driver.probe = probe;\n#ifdef CONFIG_PNP\n\tpnp_register_driver(&gemtek_driver.pnp_driver);\n#endif\n\treturn isa_register_driver(&gemtek_driver.driver, GEMTEK_MAX);\n}\n\nstatic void __exit gemtek_exit(void)\n{\n\thardmute = true;\t \n#ifdef CONFIG_PNP\n\tpnp_unregister_driver(&gemtek_driver.pnp_driver);\n#endif\n\tisa_unregister_driver(&gemtek_driver.driver);\n}\n\nmodule_init(gemtek_init);\nmodule_exit(gemtek_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}