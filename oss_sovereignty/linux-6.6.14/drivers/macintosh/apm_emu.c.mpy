{
  "module_name": "apm_emu.c",
  "hash_id": "0e2f5b9cd68a39ec034659d0c2aee416aa801fb6dfec2613cb3b53b1a33233d9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/macintosh/apm_emu.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/apm-emulation.h>\n#include <linux/adb.h>\n#include <linux/pmu.h>\n\n#define APM_CRITICAL\t\t10\n#define APM_LOW\t\t\t30\n\nstatic void pmu_apm_get_power_status(struct apm_power_info *info)\n{\n\tint percentage = -1;\n\tint batteries = 0;\n\tint time_units = -1;\n\tint real_count = 0;\n\tint i;\n\tchar charging = 0;\n\tlong charge = -1;\n\tlong amperage = 0;\n\tunsigned long btype = 0;\n\n\tinfo->battery_status = APM_BATTERY_STATUS_UNKNOWN;\n\tinfo->battery_flag = APM_BATTERY_FLAG_UNKNOWN;\n\tinfo->units = APM_UNITS_MINS;\n\n\tif (pmu_power_flags & PMU_PWR_AC_PRESENT)\n\t\tinfo->ac_line_status = APM_AC_ONLINE;\n\telse\n\t\tinfo->ac_line_status = APM_AC_OFFLINE;\n\n\tfor (i=0; i<pmu_battery_count; i++) {\n\t\tif (pmu_batteries[i].flags & PMU_BATT_PRESENT) {\n\t\t\tbatteries++;\n\t\t\tif (percentage < 0)\n\t\t\t\tpercentage = 0;\n\t\t\tif (charge < 0)\n\t\t\t\tcharge = 0;\n\t\t\tpercentage += (pmu_batteries[i].charge * 100) /\n\t\t\t\tpmu_batteries[i].max_charge;\n\t\t\tcharge += pmu_batteries[i].charge;\n\t\t\tamperage += pmu_batteries[i].amperage;\n\t\t\tif (btype == 0)\n\t\t\t\tbtype = (pmu_batteries[i].flags & PMU_BATT_TYPE_MASK);\n\t\t\treal_count++;\n\t\t\tif ((pmu_batteries[i].flags & PMU_BATT_CHARGING))\n\t\t\t\tcharging++;\n\t\t}\n\t}\n\tif (batteries == 0)\n\t\tinfo->ac_line_status = APM_AC_ONLINE;\n\n\tif (real_count) {\n\t\tif (amperage < 0) {\n\t\t\tif (btype == PMU_BATT_TYPE_SMART)\n\t\t\t\ttime_units = (charge * 59) / (amperage * -1);\n\t\t\telse\n\t\t\t\ttime_units = (charge * 16440) / (amperage * -60);\n\t\t}\n\t\tpercentage /= real_count;\n\t\tif (charging > 0) {\n\t\t\tinfo->battery_status = APM_BATTERY_STATUS_CHARGING;\n\t\t\tinfo->battery_flag = APM_BATTERY_FLAG_CHARGING;\n\t\t} else if (percentage <= APM_CRITICAL) {\n\t\t\tinfo->battery_status = APM_BATTERY_STATUS_CRITICAL;\n\t\t\tinfo->battery_flag = APM_BATTERY_FLAG_CRITICAL;\n\t\t} else if (percentage <= APM_LOW) {\n\t\t\tinfo->battery_status = APM_BATTERY_STATUS_LOW;\n\t\t\tinfo->battery_flag = APM_BATTERY_FLAG_LOW;\n\t\t} else {\n\t\t\tinfo->battery_status = APM_BATTERY_STATUS_HIGH;\n\t\t\tinfo->battery_flag = APM_BATTERY_FLAG_HIGH;\n\t\t}\n\t}\n\n\tinfo->battery_life = percentage;\n\tinfo->time = time_units;\n}\n\nstatic int __init apm_emu_init(void)\n{\n\tapm_get_power_status = pmu_apm_get_power_status;\n\n\tprintk(KERN_INFO \"apm_emu: PMU APM Emulation initialized.\\n\");\n\n\treturn 0;\n}\n\nstatic void __exit apm_emu_exit(void)\n{\n\tif (apm_get_power_status == pmu_apm_get_power_status)\n\t\tapm_get_power_status = NULL;\n\n\tprintk(KERN_INFO \"apm_emu: PMU APM Emulation removed.\\n\");\n}\n\nmodule_init(apm_emu_init);\nmodule_exit(apm_emu_exit);\n\nMODULE_AUTHOR(\"Benjamin Herrenschmidt\");\nMODULE_DESCRIPTION(\"APM emulation for PowerMac\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}