{
  "module_name": "ams-pmu.c",
  "hash_id": "df908173595b5e05ae88b90032cac1ec1ef7ccf092c2defb5b83ba34687e8f2f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/macintosh/ams/ams-pmu.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/errno.h>\n#include <linux/init.h>\n#include <linux/adb.h>\n#include <linux/pmu.h>\n\n#include \"ams.h\"\n\n \n#define AMS_X\t\t\t0x00\n#define AMS_Y\t\t\t0x01\n#define AMS_Z\t\t\t0x02\n\n \n#define AMS_VENDOR\t\t0x03\n\n \n#define AMS_FF_CLEAR\t\t0x04\n#define AMS_FF_ENABLE\t\t0x05\n#define AMS_FF_LOW_LIMIT\t0x06\n#define AMS_FF_DEBOUNCE\t\t0x07\n\n \n#define AMS_SHOCK_CLEAR\t\t0x08\n#define AMS_SHOCK_ENABLE\t0x09\n#define AMS_SHOCK_HIGH_LIMIT\t0x0a\n#define AMS_SHOCK_DEBOUNCE\t0x0b\n\n \n#define AMS_CONTROL\t\t0x0c\n\nstatic u8 ams_pmu_cmd;\n\nstatic void ams_pmu_req_complete(struct adb_request *req)\n{\n\tcomplete((struct completion *)req->arg);\n}\n\n \nstatic void ams_pmu_set_register(u8 reg, u8 value)\n{\n\tstatic struct adb_request req;\n\tDECLARE_COMPLETION(req_complete);\n\n\treq.arg = &req_complete;\n\tif (pmu_request(&req, ams_pmu_req_complete, 4, ams_pmu_cmd, 0x00, reg, value))\n\t\treturn;\n\n\twait_for_completion(&req_complete);\n}\n\n \nstatic u8 ams_pmu_get_register(u8 reg)\n{\n\tstatic struct adb_request req;\n\tDECLARE_COMPLETION(req_complete);\n\n\treq.arg = &req_complete;\n\tif (pmu_request(&req, ams_pmu_req_complete, 3, ams_pmu_cmd, 0x01, reg))\n\t\treturn 0;\n\n\twait_for_completion(&req_complete);\n\n\tif (req.reply_len > 0)\n\t\treturn req.reply[0];\n\telse\n\t\treturn 0;\n}\n\n \nstatic void ams_pmu_set_irq(enum ams_irq reg, char enable)\n{\n\tif (reg & AMS_IRQ_FREEFALL) {\n\t\tu8 val = ams_pmu_get_register(AMS_FF_ENABLE);\n\t\tif (enable)\n\t\t\tval |= 0x80;\n\t\telse\n\t\t\tval &= ~0x80;\n\t\tams_pmu_set_register(AMS_FF_ENABLE, val);\n\t}\n\n\tif (reg & AMS_IRQ_SHOCK) {\n\t\tu8 val = ams_pmu_get_register(AMS_SHOCK_ENABLE);\n\t\tif (enable)\n\t\t\tval |= 0x80;\n\t\telse\n\t\t\tval &= ~0x80;\n\t\tams_pmu_set_register(AMS_SHOCK_ENABLE, val);\n\t}\n\n\tif (reg & AMS_IRQ_GLOBAL) {\n\t\tu8 val = ams_pmu_get_register(AMS_CONTROL);\n\t\tif (enable)\n\t\t\tval |= 0x80;\n\t\telse\n\t\t\tval &= ~0x80;\n\t\tams_pmu_set_register(AMS_CONTROL, val);\n\t}\n}\n\nstatic void ams_pmu_clear_irq(enum ams_irq reg)\n{\n\tif (reg & AMS_IRQ_FREEFALL)\n\t\tams_pmu_set_register(AMS_FF_CLEAR, 0x00);\n\n\tif (reg & AMS_IRQ_SHOCK)\n\t\tams_pmu_set_register(AMS_SHOCK_CLEAR, 0x00);\n}\n\nstatic u8 ams_pmu_get_vendor(void)\n{\n\treturn ams_pmu_get_register(AMS_VENDOR);\n}\n\nstatic void ams_pmu_get_xyz(s8 *x, s8 *y, s8 *z)\n{\n\t*x = ams_pmu_get_register(AMS_X);\n\t*y = ams_pmu_get_register(AMS_Y);\n\t*z = ams_pmu_get_register(AMS_Z);\n}\n\nstatic void ams_pmu_exit(void)\n{\n\tams_sensor_detach();\n\n\t \n\tams_pmu_set_irq(AMS_IRQ_ALL, 0);\n\n\t \n\tams_pmu_clear_irq(AMS_IRQ_ALL);\n\n\tams_info.has_device = 0;\n\n\tprintk(KERN_INFO \"ams: Unloading\\n\");\n}\n\nint __init ams_pmu_init(struct device_node *np)\n{\n\tconst u32 *prop;\n\tint result;\n\n\t \n\tams_info.of_node = np;\n\tams_info.exit = ams_pmu_exit;\n\tams_info.get_vendor = ams_pmu_get_vendor;\n\tams_info.get_xyz = ams_pmu_get_xyz;\n\tams_info.clear_irq = ams_pmu_clear_irq;\n\tams_info.bustype = BUS_HOST;\n\n\t \n\tprop = of_get_property(ams_info.of_node, \"reg\", NULL);\n\tif (!prop)\n\t\treturn -ENODEV;\n\n\tams_pmu_cmd = ((*prop) >> 8) & 0xff;\n\n\t \n\tams_pmu_set_irq(AMS_IRQ_ALL, 0);\n\n\t \n\tams_pmu_clear_irq(AMS_IRQ_ALL);\n\n\tresult = ams_sensor_attach();\n\tif (result < 0)\n\t\treturn result;\n\n\t \n\tams_pmu_set_register(AMS_FF_LOW_LIMIT, 0x15);\n\tams_pmu_set_register(AMS_FF_ENABLE, 0x08);\n\tams_pmu_set_register(AMS_FF_DEBOUNCE, 0x14);\n\n\tams_pmu_set_register(AMS_SHOCK_HIGH_LIMIT, 0x60);\n\tams_pmu_set_register(AMS_SHOCK_ENABLE, 0x0f);\n\tams_pmu_set_register(AMS_SHOCK_DEBOUNCE, 0x14);\n\n\tams_pmu_set_register(AMS_CONTROL, 0x4f);\n\n\t \n\tams_pmu_clear_irq(AMS_IRQ_ALL);\n\n\tams_info.has_device = 1;\n\n\t \n\tams_pmu_set_irq(AMS_IRQ_ALL, 1);\n\n\tprintk(KERN_INFO \"ams: Found PMU based motion sensor\\n\");\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}