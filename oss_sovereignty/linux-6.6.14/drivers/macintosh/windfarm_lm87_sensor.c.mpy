{
  "module_name": "windfarm_lm87_sensor.c",
  "hash_id": "4146ba0f0d2da1a8aa93ce251068ce0fe716b58db54bd5f23fc1f87f88ae6279",
  "original_prompt": "Ingested from linux-6.6.14/drivers/macintosh/windfarm_lm87_sensor.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/wait.h>\n#include <linux/i2c.h>\n\n#include <asm/machdep.h>\n#include <asm/io.h>\n#include <asm/sections.h>\n#include <asm/pmac_low_i2c.h>\n\n#include \"windfarm.h\"\n\n#define VERSION \"1.0\"\n\n#undef DEBUG\n\n#ifdef DEBUG\n#define DBG(args...)\tprintk(args)\n#else\n#define DBG(args...)\tdo { } while(0)\n#endif\n\nstruct wf_lm87_sensor {\n\tstruct i2c_client\t*i2c;\n\tstruct wf_sensor\tsens;\n};\n#define wf_to_lm87(c) container_of(c, struct wf_lm87_sensor, sens)\n\n\nstatic int wf_lm87_read_reg(struct i2c_client *chip, int reg)\n{\n\tint rc, tries = 0;\n\tu8 buf;\n\n\tfor (;;) {\n\t\t \n\t\tbuf = (u8)reg;\n\t\trc = i2c_master_send(chip, &buf, 1);\n\t\tif (rc <= 0)\n\t\t\tgoto error;\n\t\trc = i2c_master_recv(chip, &buf, 1);\n\t\tif (rc <= 0)\n\t\t\tgoto error;\n\t\treturn (int)buf;\n\terror:\n\t\tDBG(\"wf_lm87: Error reading LM87, retrying...\\n\");\n\t\tif (++tries > 10) {\n\t\t\tprintk(KERN_ERR \"wf_lm87: Error reading LM87 !\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t\tmsleep(10);\n\t}\n}\n\nstatic int wf_lm87_get(struct wf_sensor *sr, s32 *value)\n{\n\tstruct wf_lm87_sensor *lm = sr->priv;\n\ts32 temp;\n\n\tif (lm->i2c == NULL)\n\t\treturn -ENODEV;\n\n#define LM87_INT_TEMP\t\t0x27\n\n\t \n\ttemp = wf_lm87_read_reg(lm->i2c, LM87_INT_TEMP);\n\tif (temp < 0)\n\t\treturn temp;\n\t*value = temp << 16;\n\n\treturn 0;\n}\n\nstatic void wf_lm87_release(struct wf_sensor *sr)\n{\n\tstruct wf_lm87_sensor *lm = wf_to_lm87(sr);\n\n\tkfree(lm);\n}\n\nstatic const struct wf_sensor_ops wf_lm87_ops = {\n\t.get_value\t= wf_lm87_get,\n\t.release\t= wf_lm87_release,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int wf_lm87_probe(struct i2c_client *client)\n{\t\n\tstruct wf_lm87_sensor *lm;\n\tconst char *name = NULL, *loc;\n\tstruct device_node *np = NULL;\n\tint rc;\n\n\t \n\tfor_each_child_of_node(client->dev.of_node, np) {\n\t\tif (!of_node_name_eq(np, \"int-temp\"))\n\t\t\tcontinue;\n\t\tloc = of_get_property(np, \"location\", NULL);\n\t\tif (!loc)\n\t\t\tcontinue;\n\t\tif (strstr(loc, \"DIMM\"))\n\t\t\tname = \"dimms-temp\";\n\t\telse if (strstr(loc, \"Processors\"))\n\t\t\tname = \"between-cpus-temp\";\n\t\tif (name) {\n\t\t\tof_node_put(np);\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (!name) {\n\t\tpr_warn(\"wf_lm87: Unsupported sensor %pOF\\n\",\n\t\t\tclient->dev.of_node);\n\t\treturn -ENODEV;\n\t}\n\n\tlm = kzalloc(sizeof(struct wf_lm87_sensor), GFP_KERNEL);\n\tif (lm == NULL)\n\t\treturn -ENODEV;\n\n\tlm->i2c = client;\n\tlm->sens.name = name;\n\tlm->sens.ops = &wf_lm87_ops;\n\tlm->sens.priv = lm;\n\ti2c_set_clientdata(client, lm);\n\n\trc = wf_register_sensor(&lm->sens);\n\tif (rc)\n\t\tkfree(lm);\n\treturn rc;\n}\n\nstatic void wf_lm87_remove(struct i2c_client *client)\n{\n\tstruct wf_lm87_sensor *lm = i2c_get_clientdata(client);\n\n\t \n\tlm->i2c = NULL;\n\n\t \n\twf_unregister_sensor(&lm->sens);\n}\n\nstatic const struct i2c_device_id wf_lm87_id[] = {\n\t{ \"MAC,lm87cimt\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, wf_lm87_id);\n\nstatic const struct of_device_id wf_lm87_of_id[] = {\n\t{ .compatible = \"lm87cimt\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, wf_lm87_of_id);\n\nstatic struct i2c_driver wf_lm87_driver = {\n\t.driver = {\n\t\t.name\t= \"wf_lm87\",\n\t\t.of_match_table = wf_lm87_of_id,\n\t},\n\t.probe\t\t= wf_lm87_probe,\n\t.remove\t\t= wf_lm87_remove,\n\t.id_table\t= wf_lm87_id,\n};\n\nstatic int __init wf_lm87_sensor_init(void)\n{\n\t \n\tif (!of_machine_is_compatible(\"RackMac3,1\"))\n\t\treturn -ENODEV;\n\n\treturn i2c_add_driver(&wf_lm87_driver);\n}\n\nstatic void __exit wf_lm87_sensor_exit(void)\n{\n\ti2c_del_driver(&wf_lm87_driver);\n}\n\n\nmodule_init(wf_lm87_sensor_init);\nmodule_exit(wf_lm87_sensor_exit);\n\nMODULE_AUTHOR(\"Benjamin Herrenschmidt <benh@kernel.crashing.org>\");\nMODULE_DESCRIPTION(\"LM87 sensor objects for PowerMacs thermal control\");\nMODULE_LICENSE(\"GPL\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}