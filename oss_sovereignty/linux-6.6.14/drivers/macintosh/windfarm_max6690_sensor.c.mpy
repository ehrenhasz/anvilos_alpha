{
  "module_name": "windfarm_max6690_sensor.c",
  "hash_id": "eb8adc35f0c267f4e6106f2fbf829505ff0f43a7270f0ffbe21e6c7616ce0933",
  "original_prompt": "Ingested from linux-6.6.14/drivers/macintosh/windfarm_max6690_sensor.c",
  "human_readable_source": "\n \n#include <linux/types.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/i2c.h>\n\n#include <asm/pmac_low_i2c.h>\n\n#include \"windfarm.h\"\n\n#define VERSION \"1.0\"\n\n \n\n \n#define MAX6690_INTERNAL_TEMP\t0\n#define MAX6690_EXTERNAL_TEMP\t1\n\nstruct wf_6690_sensor {\n\tstruct i2c_client\t*i2c;\n\tstruct wf_sensor\tsens;\n};\n\n#define wf_to_6690(x)\tcontainer_of((x), struct wf_6690_sensor, sens)\n\nstatic int wf_max6690_get(struct wf_sensor *sr, s32 *value)\n{\n\tstruct wf_6690_sensor *max = wf_to_6690(sr);\n\ts32 data;\n\n\tif (max->i2c == NULL)\n\t\treturn -ENODEV;\n\n\t \n\tdata = i2c_smbus_read_byte_data(max->i2c, MAX6690_EXTERNAL_TEMP);\n\tif (data < 0)\n\t\treturn data;\n\t*value = data << 16;\n\treturn 0;\n}\n\nstatic void wf_max6690_release(struct wf_sensor *sr)\n{\n\tstruct wf_6690_sensor *max = wf_to_6690(sr);\n\n\tkfree(max);\n}\n\nstatic const struct wf_sensor_ops wf_max6690_ops = {\n\t.get_value\t= wf_max6690_get,\n\t.release\t= wf_max6690_release,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int wf_max6690_probe(struct i2c_client *client)\n{\n\tconst char *name, *loc;\n\tstruct wf_6690_sensor *max;\n\tint rc;\n\n\tloc = of_get_property(client->dev.of_node, \"hwsensor-location\", NULL);\n\tif (!loc) {\n\t\tdev_warn(&client->dev, \"Missing hwsensor-location property!\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\t \n\tif (!strcmp(loc, \"BACKSIDE\") || !strcmp(loc, \"SYS CTRLR AMBIENT\"))\n\t\tname = \"backside-temp\";\n\telse if (!strcmp(loc, \"NB Ambient\"))\n\t\tname = \"north-bridge-temp\";\n\telse if (!strcmp(loc, \"GPU Ambient\"))\n\t\tname = \"gpu-temp\";\n\telse\n\t\treturn -ENXIO;\n\n\tmax = kzalloc(sizeof(struct wf_6690_sensor), GFP_KERNEL);\n\tif (max == NULL) {\n\t\tprintk(KERN_ERR \"windfarm: Couldn't create MAX6690 sensor: \"\n\t\t       \"no memory\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tmax->i2c = client;\n\tmax->sens.name = name;\n\tmax->sens.ops = &wf_max6690_ops;\n\ti2c_set_clientdata(client, max);\n\n\trc = wf_register_sensor(&max->sens);\n\tif (rc)\n\t\tkfree(max);\n\treturn rc;\n}\n\nstatic void wf_max6690_remove(struct i2c_client *client)\n{\n\tstruct wf_6690_sensor *max = i2c_get_clientdata(client);\n\n\tmax->i2c = NULL;\n\twf_unregister_sensor(&max->sens);\n}\n\nstatic const struct i2c_device_id wf_max6690_id[] = {\n\t{ \"MAC,max6690\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, wf_max6690_id);\n\nstatic const struct of_device_id wf_max6690_of_id[] = {\n\t{ .compatible = \"max6690\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, wf_max6690_of_id);\n\nstatic struct i2c_driver wf_max6690_driver = {\n\t.driver = {\n\t\t.name\t\t= \"wf_max6690\",\n\t\t.of_match_table = wf_max6690_of_id,\n\t},\n\t.probe\t\t= wf_max6690_probe,\n\t.remove\t\t= wf_max6690_remove,\n\t.id_table\t= wf_max6690_id,\n};\n\nmodule_i2c_driver(wf_max6690_driver);\n\nMODULE_AUTHOR(\"Paul Mackerras <paulus@samba.org>\");\nMODULE_DESCRIPTION(\"MAX6690 sensor objects for PowerMac thermal control\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}