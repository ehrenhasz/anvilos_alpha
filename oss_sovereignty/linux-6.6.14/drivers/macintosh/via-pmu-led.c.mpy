{
  "module_name": "via-pmu-led.c",
  "hash_id": "24784da468b0fd854923cc1a7f36098809ad584d2a3bdaece9af44a62bd96619",
  "original_prompt": "Ingested from linux-6.6.14/drivers/macintosh/via-pmu-led.c",
  "human_readable_source": " \n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/device.h>\n#include <linux/leds.h>\n#include <linux/adb.h>\n#include <linux/pmu.h>\n#include <linux/of.h>\n\nstatic spinlock_t pmu_blink_lock;\nstatic struct adb_request pmu_blink_req;\n \nstatic int requested_change;\n\nstatic void pmu_req_done(struct adb_request * req)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&pmu_blink_lock, flags);\n\t \n\tif (requested_change != -1 && !pmu_sys_suspended)\n\t\tpmu_request(&pmu_blink_req, NULL, 4, 0xee, 4, 0, requested_change);\n\t \n\trequested_change = -1;\n\tspin_unlock_irqrestore(&pmu_blink_lock, flags);\n}\n\nstatic void pmu_led_set(struct led_classdev *led_cdev,\n\t\t\tenum led_brightness brightness)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&pmu_blink_lock, flags);\n\tswitch (brightness) {\n\tcase LED_OFF:\n\t\trequested_change = 0;\n\t\tbreak;\n\tcase LED_FULL:\n\t\trequested_change = 1;\n\t\tbreak;\n\tdefault:\n\t\tgoto out;\n\t\tbreak;\n\t}\n\t \n\tif (pmu_blink_req.complete && !pmu_sys_suspended)\n\t\tpmu_request(&pmu_blink_req, NULL, 4, 0xee, 4, 0, requested_change);\n out:\n \tspin_unlock_irqrestore(&pmu_blink_lock, flags);\n}\n\nstatic struct led_classdev pmu_led = {\n\t.name = \"pmu-led::front\",\n#ifdef CONFIG_ADB_PMU_LED_DISK\n\t.default_trigger = \"disk-activity\",\n#endif\n\t.brightness_set = pmu_led_set,\n};\n\nstatic int __init via_pmu_led_init(void)\n{\n\tstruct device_node *dt;\n\tconst char *model;\n\n\t \n\tif (pmu_get_model() != PMU_KEYLARGO_BASED)\n\t\treturn -ENODEV;\n\n\tdt = of_find_node_by_path(\"/\");\n\tif (dt == NULL)\n\t\treturn -ENODEV;\n\tmodel = of_get_property(dt, \"model\", NULL);\n\tif (model == NULL) {\n\t\tof_node_put(dt);\n\t\treturn -ENODEV;\n\t}\n\tif (strncmp(model, \"PowerBook\", strlen(\"PowerBook\")) != 0 &&\n\t    strncmp(model, \"iBook\", strlen(\"iBook\")) != 0 &&\n\t    strcmp(model, \"PowerMac7,2\") != 0 &&\n\t    strcmp(model, \"PowerMac7,3\") != 0) {\n\t\tof_node_put(dt);\n\t\t \n\t\treturn -ENODEV;\n\t}\n\tof_node_put(dt);\n\n\tspin_lock_init(&pmu_blink_lock);\n\t \n\tpmu_blink_req.complete = 1;\n\tpmu_blink_req.done = pmu_req_done;\n\n\treturn led_classdev_register(NULL, &pmu_led);\n}\n\nlate_initcall(via_pmu_led_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}