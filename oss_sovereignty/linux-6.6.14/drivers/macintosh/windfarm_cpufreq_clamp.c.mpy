{
  "module_name": "windfarm_cpufreq_clamp.c",
  "hash_id": "be8c3789ebbe43eea62dd5773cf9d1af10eb555df0111edffc349cf92f08c1d1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/macintosh/windfarm_cpufreq_clamp.c",
  "human_readable_source": "\n#include <linux/types.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/pm_qos.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/wait.h>\n#include <linux/cpu.h>\n#include <linux/cpufreq.h>\n\n#include \"windfarm.h\"\n\n#define VERSION \"0.3\"\n\nstatic int clamped;\nstatic struct wf_control *clamp_control;\nstatic struct freq_qos_request qos_req;\nstatic unsigned int min_freq, max_freq;\n\nstatic int clamp_set(struct wf_control *ct, s32 value)\n{\n\tunsigned int freq;\n\n\tif (value) {\n\t\tfreq = min_freq;\n\t\tprintk(KERN_INFO \"windfarm: Clamping CPU frequency to \"\n\t\t       \"minimum !\\n\");\n\t} else {\n\t\tfreq = max_freq;\n\t\tprintk(KERN_INFO \"windfarm: CPU frequency unclamped !\\n\");\n\t}\n\tclamped = value;\n\n\treturn freq_qos_update_request(&qos_req, freq);\n}\n\nstatic int clamp_get(struct wf_control *ct, s32 *value)\n{\n\t*value = clamped;\n\treturn 0;\n}\n\nstatic s32 clamp_min(struct wf_control *ct)\n{\n\treturn 0;\n}\n\nstatic s32 clamp_max(struct wf_control *ct)\n{\n\treturn 1;\n}\n\nstatic const struct wf_control_ops clamp_ops = {\n\t.set_value\t= clamp_set,\n\t.get_value\t= clamp_get,\n\t.get_min\t= clamp_min,\n\t.get_max\t= clamp_max,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int __init wf_cpufreq_clamp_init(void)\n{\n\tstruct cpufreq_policy *policy;\n\tstruct wf_control *clamp;\n\tstruct device *dev;\n\tint ret;\n\n\tpolicy = cpufreq_cpu_get(0);\n\tif (!policy) {\n\t\tpr_warn(\"%s: cpufreq policy not found cpu0\\n\", __func__);\n\t\treturn -EPROBE_DEFER;\n\t}\n\n\tmin_freq = policy->cpuinfo.min_freq;\n\tmax_freq = policy->cpuinfo.max_freq;\n\n\tret = freq_qos_add_request(&policy->constraints, &qos_req, FREQ_QOS_MAX,\n\t\t\t\t   max_freq);\n\n\tcpufreq_cpu_put(policy);\n\n\tif (ret < 0) {\n\t\tpr_err(\"%s: Failed to add freq constraint (%d)\\n\", __func__,\n\t\t       ret);\n\t\treturn ret;\n\t}\n\n\tdev = get_cpu_device(0);\n\tif (unlikely(!dev)) {\n\t\tpr_warn(\"%s: No cpu device for cpu0\\n\", __func__);\n\t\tret = -ENODEV;\n\t\tgoto fail;\n\t}\n\n\tclamp = kmalloc(sizeof(struct wf_control), GFP_KERNEL);\n\tif (clamp == NULL) {\n\t\tret = -ENOMEM;\n\t\tgoto fail;\n\t}\n\n\tclamp->ops = &clamp_ops;\n\tclamp->name = \"cpufreq-clamp\";\n\tret = wf_register_control(clamp);\n\tif (ret)\n\t\tgoto free;\n\n\tclamp_control = clamp;\n\treturn 0;\n\n free:\n\tkfree(clamp);\n fail:\n\tfreq_qos_remove_request(&qos_req);\n\treturn ret;\n}\n\nstatic void __exit wf_cpufreq_clamp_exit(void)\n{\n\tif (clamp_control) {\n\t\twf_unregister_control(clamp_control);\n\t\tfreq_qos_remove_request(&qos_req);\n\t}\n}\n\n\nmodule_init(wf_cpufreq_clamp_init);\nmodule_exit(wf_cpufreq_clamp_exit);\n\nMODULE_AUTHOR(\"Benjamin Herrenschmidt <benh@kernel.crashing.org>\");\nMODULE_DESCRIPTION(\"CPU frequency clamp for PowerMacs thermal control\");\nMODULE_LICENSE(\"GPL\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}