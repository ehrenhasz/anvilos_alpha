{
  "module_name": "via-pmu-backlight.c",
  "hash_id": "d5e209b1411b69b562193700bb1a5a9ab76f5b7a815946db40443e5e0236ff6f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/macintosh/via-pmu-backlight.c",
  "human_readable_source": "\n \n\n#include <asm/ptrace.h>\n#include <linux/adb.h>\n#include <linux/pmu.h>\n#include <asm/backlight.h>\n\n#define MAX_PMU_LEVEL 0xFF\n\nstatic const struct backlight_ops pmu_backlight_data;\nstatic DEFINE_SPINLOCK(pmu_backlight_lock);\nstatic int sleeping, uses_pmu_bl;\nstatic u8 bl_curve[FB_BACKLIGHT_LEVELS];\n\nstatic void pmu_backlight_init_curve(u8 off, u8 min, u8 max)\n{\n\tint i, flat, count, range = (max - min);\n\n\tbl_curve[0] = off;\n\n\tfor (flat = 1; flat < (FB_BACKLIGHT_LEVELS / 16); ++flat)\n\t\tbl_curve[flat] = min;\n\n\tcount = FB_BACKLIGHT_LEVELS * 15 / 16;\n\tfor (i = 0; i < count; ++i)\n\t\tbl_curve[flat + i] = min + (range * (i + 1) / count);\n}\n\nstatic int pmu_backlight_curve_lookup(int value)\n{\n\tint level = (FB_BACKLIGHT_LEVELS - 1);\n\tint i, max = 0;\n\n\t \n\tfor (i = 0; i < FB_BACKLIGHT_LEVELS; i++)\n\t\tmax = max((int)bl_curve[i], max);\n\n\t \n\tfor (i = 0; i < FB_BACKLIGHT_LEVELS; i++) {\n\t\tint diff = abs(bl_curve[i] - value);\n\t\tif (diff < max) {\n\t\t\tmax = diff;\n\t\t\tlevel = i;\n\t\t}\n\t}\n\treturn level;\n}\n\nstatic int pmu_backlight_get_level_brightness(int level)\n{\n\tint pmulevel;\n\n\t \n\tpmulevel = bl_curve[level] * FB_BACKLIGHT_MAX / MAX_PMU_LEVEL;\n\tif (pmulevel < 0)\n\t\tpmulevel = 0;\n\telse if (pmulevel > MAX_PMU_LEVEL)\n\t\tpmulevel = MAX_PMU_LEVEL;\n\n\treturn pmulevel;\n}\n\nstatic int __pmu_backlight_update_status(struct backlight_device *bd)\n{\n\tstruct adb_request req;\n\tint level = backlight_get_brightness(bd);\n\n\tif (level > 0) {\n\t\tint pmulevel = pmu_backlight_get_level_brightness(level);\n\n\t\tpmu_request(&req, NULL, 2, PMU_BACKLIGHT_BRIGHT, pmulevel);\n\t\tpmu_wait_complete(&req);\n\n\t\tpmu_request(&req, NULL, 2, PMU_POWER_CTRL,\n\t\t\tPMU_POW_BACKLIGHT | PMU_POW_ON);\n\t\tpmu_wait_complete(&req);\n\t} else {\n\t\tpmu_request(&req, NULL, 2, PMU_POWER_CTRL,\n\t\t\tPMU_POW_BACKLIGHT | PMU_POW_OFF);\n\t\tpmu_wait_complete(&req);\n\t}\n\n\treturn 0;\n}\n\nstatic int pmu_backlight_update_status(struct backlight_device *bd)\n{\n\tunsigned long flags;\n\tint rc = 0;\n\n\tspin_lock_irqsave(&pmu_backlight_lock, flags);\n\t \n\tif (!sleeping)\n\t\trc = __pmu_backlight_update_status(bd);\n\tspin_unlock_irqrestore(&pmu_backlight_lock, flags);\n\treturn rc;\n}\n\n\nstatic const struct backlight_ops pmu_backlight_data = {\n\t.update_status\t= pmu_backlight_update_status,\n\n};\n\n#ifdef CONFIG_PM\nvoid pmu_backlight_set_sleep(int sleep)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&pmu_backlight_lock, flags);\n\tsleeping = sleep;\n\tif (pmac_backlight && uses_pmu_bl) {\n\t\tif (sleep) {\n\t\t\tstruct adb_request req;\n\n\t\t\tpmu_request(&req, NULL, 2, PMU_POWER_CTRL,\n\t\t\t\t    PMU_POW_BACKLIGHT | PMU_POW_OFF);\n\t\t\tpmu_wait_complete(&req);\n\t\t} else\n\t\t\t__pmu_backlight_update_status(pmac_backlight);\n\t}\n\tspin_unlock_irqrestore(&pmu_backlight_lock, flags);\n}\n#endif  \n\nvoid __init pmu_backlight_init(void)\n{\n\tstruct backlight_properties props;\n\tstruct backlight_device *bd;\n\tchar name[10];\n\tint level, autosave;\n\n\t \n\tautosave =\n\t\tof_machine_is_compatible(\"AAPL,3400/2400\") ||\n\t\tof_machine_is_compatible(\"AAPL,3500\");\n\n\tif (!autosave &&\n\t    !pmac_has_backlight_type(\"pmu\") &&\n\t    !of_machine_is_compatible(\"AAPL,PowerBook1998\") &&\n\t    !of_machine_is_compatible(\"PowerBook1,1\"))\n\t\treturn;\n\n\tsnprintf(name, sizeof(name), \"pmubl\");\n\n\tmemset(&props, 0, sizeof(struct backlight_properties));\n\tprops.type = BACKLIGHT_PLATFORM;\n\tprops.max_brightness = FB_BACKLIGHT_LEVELS - 1;\n\tbd = backlight_device_register(name, NULL, NULL, &pmu_backlight_data,\n\t\t\t\t       &props);\n\tif (IS_ERR(bd)) {\n\t\tprintk(KERN_ERR \"PMU Backlight registration failed\\n\");\n\t\treturn;\n\t}\n\tuses_pmu_bl = 1;\n\tpmu_backlight_init_curve(0x7F, 0x46, 0x0E);\n\n\tlevel = bd->props.max_brightness;\n\n\tif (autosave) {\n\t\t \n\t\tstruct adb_request req;\n\t\tpmu_request(&req, NULL, 2, 0xd9, 0);\n\t\tpmu_wait_complete(&req);\n\n\t\tlevel = pmu_backlight_curve_lookup(\n\t\t\t\t(req.reply[0] >> 4) *\n\t\t\t\tbd->props.max_brightness / 15);\n\t}\n\n\tbd->props.brightness = level;\n\tbd->props.power = FB_BLANK_UNBLANK;\n\tbacklight_update_status(bd);\n\n\tprintk(KERN_INFO \"PMU Backlight initialized (%s)\\n\", name);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}