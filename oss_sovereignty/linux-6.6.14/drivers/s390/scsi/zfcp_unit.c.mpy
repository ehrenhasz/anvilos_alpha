{
  "module_name": "zfcp_unit.c",
  "hash_id": "f61fdd56253161b58f8c98b29909a11a357174e75f9d79a215a98678e3ff4d35",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/scsi/zfcp_unit.c",
  "human_readable_source": "\n \n\n#include \"zfcp_def.h\"\n#include \"zfcp_ext.h\"\n\n \nvoid zfcp_unit_scsi_scan(struct zfcp_unit *unit)\n{\n\tstruct fc_rport *rport = unit->port->rport;\n\tu64 lun;\n\n\tlun = scsilun_to_int((struct scsi_lun *) &unit->fcp_lun);\n\n\tif (rport && rport->port_state == FC_PORTSTATE_ONLINE)\n\t\tscsi_scan_target(&rport->dev, 0, rport->scsi_target_id, lun,\n\t\t\t\t SCSI_SCAN_MANUAL);\n}\n\nstatic void zfcp_unit_scsi_scan_work(struct work_struct *work)\n{\n\tstruct zfcp_unit *unit = container_of(work, struct zfcp_unit,\n\t\t\t\t\t      scsi_work);\n\n\tzfcp_unit_scsi_scan(unit);\n\tput_device(&unit->dev);\n}\n\n \nvoid zfcp_unit_queue_scsi_scan(struct zfcp_port *port)\n{\n\tstruct zfcp_unit *unit;\n\n\tread_lock_irq(&port->unit_list_lock);\n\tlist_for_each_entry(unit, &port->unit_list, list) {\n\t\tget_device(&unit->dev);\n\t\tif (scsi_queue_work(port->adapter->scsi_host,\n\t\t\t\t    &unit->scsi_work) <= 0)\n\t\t\tput_device(&unit->dev);\n\t}\n\tread_unlock_irq(&port->unit_list_lock);\n}\n\nstatic struct zfcp_unit *_zfcp_unit_find(struct zfcp_port *port, u64 fcp_lun)\n{\n\tstruct zfcp_unit *unit;\n\n\tlist_for_each_entry(unit, &port->unit_list, list)\n\t\tif (unit->fcp_lun == fcp_lun) {\n\t\t\tget_device(&unit->dev);\n\t\t\treturn unit;\n\t\t}\n\n\treturn NULL;\n}\n\n \nstruct zfcp_unit *zfcp_unit_find(struct zfcp_port *port, u64 fcp_lun)\n{\n\tstruct zfcp_unit *unit;\n\n\tread_lock_irq(&port->unit_list_lock);\n\tunit = _zfcp_unit_find(port, fcp_lun);\n\tread_unlock_irq(&port->unit_list_lock);\n\treturn unit;\n}\n\n \nstatic void zfcp_unit_release(struct device *dev)\n{\n\tstruct zfcp_unit *unit = container_of(dev, struct zfcp_unit, dev);\n\n\tatomic_dec(&unit->port->units);\n\tkfree(unit);\n}\n\n \nint zfcp_unit_add(struct zfcp_port *port, u64 fcp_lun)\n{\n\tstruct zfcp_unit *unit;\n\tint retval = 0;\n\n\tmutex_lock(&zfcp_sysfs_port_units_mutex);\n\tif (zfcp_sysfs_port_is_removing(port)) {\n\t\t \n\t\tretval = -ENODEV;\n\t\tgoto out;\n\t}\n\n\tunit = zfcp_unit_find(port, fcp_lun);\n\tif (unit) {\n\t\tput_device(&unit->dev);\n\t\tretval = -EEXIST;\n\t\tgoto out;\n\t}\n\n\tunit = kzalloc(sizeof(struct zfcp_unit), GFP_KERNEL);\n\tif (!unit) {\n\t\tretval = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tunit->port = port;\n\tunit->fcp_lun = fcp_lun;\n\tunit->dev.parent = &port->dev;\n\tunit->dev.release = zfcp_unit_release;\n\tunit->dev.groups = zfcp_unit_attr_groups;\n\tINIT_WORK(&unit->scsi_work, zfcp_unit_scsi_scan_work);\n\n\tif (dev_set_name(&unit->dev, \"0x%016llx\",\n\t\t\t (unsigned long long) fcp_lun)) {\n\t\tkfree(unit);\n\t\tretval = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tif (device_register(&unit->dev)) {\n\t\tput_device(&unit->dev);\n\t\tretval = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tatomic_inc(&port->units);  \n\n\twrite_lock_irq(&port->unit_list_lock);\n\tlist_add_tail(&unit->list, &port->unit_list);\n\twrite_unlock_irq(&port->unit_list_lock);\n\t \n\tmutex_unlock(&zfcp_sysfs_port_units_mutex);\n\n\tzfcp_unit_scsi_scan(unit);\n\treturn retval;\n\nout:\n\tmutex_unlock(&zfcp_sysfs_port_units_mutex);\n\treturn retval;\n}\n\n \nstruct scsi_device *zfcp_unit_sdev(struct zfcp_unit *unit)\n{\n\tstruct Scsi_Host *shost;\n\tstruct zfcp_port *port;\n\tu64 lun;\n\n\tlun = scsilun_to_int((struct scsi_lun *) &unit->fcp_lun);\n\tport = unit->port;\n\tshost = port->adapter->scsi_host;\n\treturn scsi_device_lookup(shost, 0, port->starget_id, lun);\n}\n\n \nunsigned int zfcp_unit_sdev_status(struct zfcp_unit *unit)\n{\n\tunsigned int status = 0;\n\tstruct scsi_device *sdev;\n\tstruct zfcp_scsi_dev *zfcp_sdev;\n\n\tsdev = zfcp_unit_sdev(unit);\n\tif (sdev) {\n\t\tzfcp_sdev = sdev_to_zfcp(sdev);\n\t\tstatus = atomic_read(&zfcp_sdev->status);\n\t\tscsi_device_put(sdev);\n\t}\n\n\treturn status;\n}\n\n \nint zfcp_unit_remove(struct zfcp_port *port, u64 fcp_lun)\n{\n\tstruct zfcp_unit *unit;\n\tstruct scsi_device *sdev;\n\n\twrite_lock_irq(&port->unit_list_lock);\n\tunit = _zfcp_unit_find(port, fcp_lun);\n\tif (unit)\n\t\tlist_del(&unit->list);\n\twrite_unlock_irq(&port->unit_list_lock);\n\n\tif (!unit)\n\t\treturn -EINVAL;\n\n\tsdev = zfcp_unit_sdev(unit);\n\tif (sdev) {\n\t\tscsi_remove_device(sdev);\n\t\tscsi_device_put(sdev);\n\t}\n\n\tdevice_unregister(&unit->dev);\n\n\tput_device(&unit->dev);  \n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}