{
  "module_name": "diag_ftp.c",
  "hash_id": "56ca2495d3fa64a401230d87b180dc576f50c81e3b09ab66dd669651590c6ec6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/char/diag_ftp.c",
  "human_readable_source": "\n \n\n#define KMSG_COMPONENT \"hmcdrv\"\n#define pr_fmt(fmt) KMSG_COMPONENT \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/mm.h>\n#include <linux/irq.h>\n#include <linux/wait.h>\n#include <linux/string.h>\n#include <asm/asm-extable.h>\n#include <asm/ctl_reg.h>\n#include <asm/diag.h>\n\n#include \"hmcdrv_ftp.h\"\n#include \"diag_ftp.h\"\n\n \n#define DIAG_FTP_RET_OK\t0  \n#define DIAG_FTP_RET_EBUSY\t4  \n#define DIAG_FTP_RET_EIO\t8  \n \n#define DIAG_FTP_RET_EPERM\t2  \n\n \n#define DIAG_FTP_STAT_OK\t0U  \n#define DIAG_FTP_STAT_PGCC\t4U  \n#define DIAG_FTP_STAT_PGIOE\t8U  \n#define DIAG_FTP_STAT_TIMEOUT\t12U  \n#define DIAG_FTP_STAT_EBASE\t16U  \n#define DIAG_FTP_STAT_LDFAIL\t(DIAG_FTP_STAT_EBASE + 1U)  \n#define DIAG_FTP_STAT_LDNPERM\t(DIAG_FTP_STAT_EBASE + 2U)  \n#define DIAG_FTP_STAT_LDRUNS\t(DIAG_FTP_STAT_EBASE + 3U)  \n#define DIAG_FTP_STAT_LDNRUNS\t(DIAG_FTP_STAT_EBASE + 4U)  \n\n \nstruct diag_ftp_ldfpl {\n\tu64 bufaddr;\n\tu64 buflen;\n\tu64 offset;\n\tu64 intparm;\n\tu64 transferred;\n\tu64 fsize;\n\tu64 failaddr;\n\tu64 spare;\n\tu8 fident[HMCDRV_FTP_FIDENT_MAX];\n} __packed;\n\nstatic DECLARE_COMPLETION(diag_ftp_rx_complete);\nstatic int diag_ftp_subcode;\n\n \nstatic void diag_ftp_handler(struct ext_code extirq,\n\t\t\t     unsigned int param32,\n\t\t\t     unsigned long param64)\n{\n\tif ((extirq.subcode >> 8) != 8)\n\t\treturn;  \n\n\tinc_irq_stat(IRQEXT_FTP);\n\tdiag_ftp_subcode = extirq.subcode & 0xffU;\n\tcomplete(&diag_ftp_rx_complete);\n}\n\n \nstatic int diag_ftp_2c4(struct diag_ftp_ldfpl *fpl,\n\t\t\tenum hmcdrv_ftp_cmdid cmd)\n{\n\tint rc;\n\n\tdiag_stat_inc(DIAG_STAT_X2C4);\n\tasm volatile(\n\t\t\"\tdiag\t%[addr],%[cmd],0x2c4\\n\"\n\t\t\"0:\tj\t2f\\n\"\n\t\t\"1:\tla\t%[rc],%[err]\\n\"\n\t\t\"2:\\n\"\n\t\tEX_TABLE(0b, 1b)\n\t\t: [rc] \"=d\" (rc), \"+m\" (*fpl)\n\t\t: [cmd] \"0\" (cmd), [addr] \"d\" (virt_to_phys(fpl)),\n\t\t  [err] \"i\" (DIAG_FTP_RET_EPERM)\n\t\t: \"cc\");\n\n\tswitch (rc) {\n\tcase DIAG_FTP_RET_OK:\n\t\treturn 0;\n\tcase DIAG_FTP_RET_EBUSY:\n\t\treturn -EBUSY;\n\tcase DIAG_FTP_RET_EPERM:\n\t\treturn -EPERM;\n\tcase DIAG_FTP_RET_EIO:\n\tdefault:\n\t\treturn -EIO;\n\t}\n}\n\n \nssize_t diag_ftp_cmd(const struct hmcdrv_ftp_cmdspec *ftp, size_t *fsize)\n{\n\tstruct diag_ftp_ldfpl *ldfpl;\n\tssize_t len;\n#ifdef DEBUG\n\tunsigned long start_jiffies;\n\n\tpr_debug(\"starting DIAG X'2C4' on '%s', requesting %zd bytes\\n\",\n\t\t ftp->fname, ftp->len);\n\tstart_jiffies = jiffies;\n#endif\n\tinit_completion(&diag_ftp_rx_complete);\n\n\tldfpl = (void *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\n\tif (!ldfpl) {\n\t\tlen = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tlen = strscpy(ldfpl->fident, ftp->fname, sizeof(ldfpl->fident));\n\tif (len < 0) {\n\t\tlen = -EINVAL;\n\t\tgoto out_free;\n\t}\n\n\tldfpl->transferred = 0;\n\tldfpl->fsize = 0;\n\tldfpl->offset = ftp->ofs;\n\tldfpl->buflen = ftp->len;\n\tldfpl->bufaddr = virt_to_phys(ftp->buf);\n\n\tlen = diag_ftp_2c4(ldfpl, ftp->id);\n\tif (len)\n\t\tgoto out_free;\n\n\t \n\twait_for_completion(&diag_ftp_rx_complete);\n\n#ifdef DEBUG\n\tpr_debug(\"completed DIAG X'2C4' after %lu ms\\n\",\n\t\t (jiffies - start_jiffies) * 1000 / HZ);\n\tpr_debug(\"status of DIAG X'2C4' is %u, with %lld/%lld bytes\\n\",\n\t\t diag_ftp_subcode, ldfpl->transferred, ldfpl->fsize);\n#endif\n\n\tswitch (diag_ftp_subcode) {\n\tcase DIAG_FTP_STAT_OK:  \n\t\tlen = ldfpl->transferred;\n\t\tif (fsize)\n\t\t\t*fsize = ldfpl->fsize;\n\t\tbreak;\n\tcase DIAG_FTP_STAT_LDNPERM:\n\t\tlen = -EPERM;\n\t\tbreak;\n\tcase DIAG_FTP_STAT_LDRUNS:\n\t\tlen = -EBUSY;\n\t\tbreak;\n\tcase DIAG_FTP_STAT_LDFAIL:\n\t\tlen = -ENOENT;  \n\t\tbreak;\n\tdefault:\n\t\tlen = -EIO;\n\t\tbreak;\n\t}\n\nout_free:\n\tfree_page((unsigned long) ldfpl);\nout:\n\treturn len;\n}\n\n \nint diag_ftp_startup(void)\n{\n\tint rc;\n\n\trc = register_external_irq(EXT_IRQ_CP_SERVICE, diag_ftp_handler);\n\tif (rc)\n\t\treturn rc;\n\n\tirq_subclass_register(IRQ_SUBCLASS_SERVICE_SIGNAL);\n\treturn 0;\n}\n\n \nvoid diag_ftp_shutdown(void)\n{\n\tirq_subclass_unregister(IRQ_SUBCLASS_SERVICE_SIGNAL);\n\tunregister_external_irq(EXT_IRQ_CP_SERVICE, diag_ftp_handler);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}