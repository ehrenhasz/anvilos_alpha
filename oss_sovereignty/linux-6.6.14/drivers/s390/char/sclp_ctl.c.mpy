{
  "module_name": "sclp_ctl.c",
  "hash_id": "a4212529cb6ac1b78e3714ec338e45a7bcd4d11ede5abd62e526b515212b823d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/char/sclp_ctl.c",
  "human_readable_source": "\n \n\n#include <linux/compat.h>\n#include <linux/uaccess.h>\n#include <linux/miscdevice.h>\n#include <linux/gfp.h>\n#include <linux/init.h>\n#include <linux/ioctl.h>\n#include <linux/fs.h>\n#include <asm/sclp_ctl.h>\n#include <asm/sclp.h>\n\n#include \"sclp.h\"\n\n \nstatic unsigned int sclp_ctl_sccb_wlist[] = {\n\t0x00400002,\n\t0x00410002,\n};\n\n \nstatic int sclp_ctl_cmdw_supported(unsigned int cmdw)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(sclp_ctl_sccb_wlist); i++) {\n\t\tif (cmdw == sclp_ctl_sccb_wlist[i])\n\t\t\treturn 1;\n\t}\n\treturn 0;\n}\n\nstatic void __user *u64_to_uptr(u64 value)\n{\n\tif (is_compat_task())\n\t\treturn compat_ptr(value);\n\telse\n\t\treturn (void __user *)(unsigned long)value;\n}\n\n \nstatic int sclp_ctl_ioctl_sccb(void __user *user_area)\n{\n\tstruct sclp_ctl_sccb ctl_sccb;\n\tstruct sccb_header *sccb;\n\tunsigned long copied;\n\tint rc;\n\n\tif (copy_from_user(&ctl_sccb, user_area, sizeof(ctl_sccb)))\n\t\treturn -EFAULT;\n\tif (!sclp_ctl_cmdw_supported(ctl_sccb.cmdw))\n\t\treturn -EOPNOTSUPP;\n\tsccb = (void *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\n\tif (!sccb)\n\t\treturn -ENOMEM;\n\tcopied = PAGE_SIZE -\n\t\tcopy_from_user(sccb, u64_to_uptr(ctl_sccb.sccb), PAGE_SIZE);\n\tif (offsetof(struct sccb_header, length) +\n\t    sizeof(sccb->length) > copied || sccb->length > copied) {\n\t\trc = -EFAULT;\n\t\tgoto out_free;\n\t}\n\tif (sccb->length < 8) {\n\t\trc = -EINVAL;\n\t\tgoto out_free;\n\t}\n\trc = sclp_sync_request(ctl_sccb.cmdw, sccb);\n\tif (rc)\n\t\tgoto out_free;\n\tif (copy_to_user(u64_to_uptr(ctl_sccb.sccb), sccb, sccb->length))\n\t\trc = -EFAULT;\nout_free:\n\tfree_page((unsigned long) sccb);\n\treturn rc;\n}\n\n \nstatic long sclp_ctl_ioctl(struct file *filp, unsigned int cmd,\n\t\t\t   unsigned long arg)\n{\n\tvoid __user *argp;\n\n\tif (is_compat_task())\n\t\targp = compat_ptr(arg);\n\telse\n\t\targp = (void __user *) arg;\n\tswitch (cmd) {\n\tcase SCLP_CTL_SCCB:\n\t\treturn sclp_ctl_ioctl_sccb(argp);\n\tdefault:  \n\t\treturn -ENOTTY;\n\t}\n}\n\n \nstatic const struct file_operations sclp_ctl_fops = {\n\t.owner = THIS_MODULE,\n\t.open = nonseekable_open,\n\t.unlocked_ioctl = sclp_ctl_ioctl,\n\t.compat_ioctl = sclp_ctl_ioctl,\n\t.llseek = no_llseek,\n};\n\n \nstatic struct miscdevice sclp_ctl_device = {\n\t.minor = MISC_DYNAMIC_MINOR,\n\t.name = \"sclp\",\n\t.fops = &sclp_ctl_fops,\n};\nbuiltin_misc_device(sclp_ctl_device);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}