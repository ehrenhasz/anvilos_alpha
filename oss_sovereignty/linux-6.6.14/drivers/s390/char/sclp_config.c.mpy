{
  "module_name": "sclp_config.c",
  "hash_id": "9db7defee83b3332f273e033aba0decfd62234a553c6458f697864640077cb8c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/char/sclp_config.c",
  "human_readable_source": "\n \n\n#define KMSG_COMPONENT \"sclp_config\"\n#define pr_fmt(fmt) KMSG_COMPONENT \": \" fmt\n\n#include <linux/init.h>\n#include <linux/errno.h>\n#include <linux/cpu.h>\n#include <linux/device.h>\n#include <linux/workqueue.h>\n#include <linux/slab.h>\n#include <linux/sysfs.h>\n#include <asm/smp.h>\n\n#include \"sclp.h\"\n\nstruct conf_mgm_data {\n\tu8 reserved;\n\tu8 ev_qualifier;\n} __attribute__((packed));\n\n#define OFB_DATA_MAX 64\n\nstruct sclp_ofb_evbuf {\n\tstruct evbuf_header header;\n\tstruct conf_mgm_data cm_data;\n\tchar ev_data[OFB_DATA_MAX];\n} __packed;\n\nstruct sclp_ofb_sccb {\n\tstruct sccb_header header;\n\tstruct sclp_ofb_evbuf ofb_evbuf;\n} __packed;\n\n#define EV_QUAL_CPU_CHANGE\t1\n#define EV_QUAL_CAP_CHANGE\t3\n#define EV_QUAL_OPEN4BUSINESS\t5\n\nstatic struct work_struct sclp_cpu_capability_work;\nstatic struct work_struct sclp_cpu_change_work;\n\nstatic void sclp_cpu_capability_notify(struct work_struct *work)\n{\n\tint cpu;\n\tstruct device *dev;\n\n\ts390_update_cpu_mhz();\n\tpr_info(\"CPU capability may have changed\\n\");\n\tcpus_read_lock();\n\tfor_each_online_cpu(cpu) {\n\t\tdev = get_cpu_device(cpu);\n\t\tkobject_uevent(&dev->kobj, KOBJ_CHANGE);\n\t}\n\tcpus_read_unlock();\n}\n\nstatic void __ref sclp_cpu_change_notify(struct work_struct *work)\n{\n\tlock_device_hotplug();\n\tsmp_rescan_cpus();\n\tunlock_device_hotplug();\n}\n\nstatic void sclp_conf_receiver_fn(struct evbuf_header *evbuf)\n{\n\tstruct conf_mgm_data *cdata;\n\n\tcdata = (struct conf_mgm_data *)(evbuf + 1);\n\tswitch (cdata->ev_qualifier) {\n\tcase EV_QUAL_CPU_CHANGE:\n\t\tschedule_work(&sclp_cpu_change_work);\n\t\tbreak;\n\tcase EV_QUAL_CAP_CHANGE:\n\t\tschedule_work(&sclp_cpu_capability_work);\n\t\tbreak;\n\t}\n}\n\nstatic struct sclp_register sclp_conf_register =\n{\n#ifdef CONFIG_SCLP_OFB\n\t.send_mask    = EVTYP_CONFMGMDATA_MASK,\n#endif\n\t.receive_mask = EVTYP_CONFMGMDATA_MASK,\n\t.receiver_fn  = sclp_conf_receiver_fn,\n};\n\n#ifdef CONFIG_SCLP_OFB\nstatic int sclp_ofb_send_req(char *ev_data, size_t len)\n{\n\tstatic DEFINE_MUTEX(send_mutex);\n\tstruct sclp_ofb_sccb *sccb;\n\tint rc, response;\n\n\tif (len > OFB_DATA_MAX)\n\t\treturn -EINVAL;\n\tsccb = (struct sclp_ofb_sccb *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\n\tif (!sccb)\n\t\treturn -ENOMEM;\n\t \n\tsccb->header.length = sizeof(struct sclp_ofb_sccb);\n\tsccb->ofb_evbuf.header.length = sizeof(struct sclp_ofb_evbuf);\n\tsccb->ofb_evbuf.header.type = EVTYP_CONFMGMDATA;\n\tsccb->ofb_evbuf.cm_data.ev_qualifier = EV_QUAL_OPEN4BUSINESS;\n\tmemcpy(sccb->ofb_evbuf.ev_data, ev_data, len);\n\n\tif (!(sclp_conf_register.sclp_receive_mask & EVTYP_CONFMGMDATA_MASK))\n\t\tpr_warn(\"SCLP receiver did not register to receive \"\n\t\t\t\"Configuration Management Data Events.\\n\");\n\n\tmutex_lock(&send_mutex);\n\trc = sclp_sync_request(SCLP_CMDW_WRITE_EVENT_DATA, sccb);\n\tmutex_unlock(&send_mutex);\n\tif (rc)\n\t\tgoto out;\n\tresponse = sccb->header.response_code;\n\tif (response != 0x0020) {\n\t\tpr_err(\"Open for Business request failed with response code \"\n\t\t       \"0x%04x\\n\", response);\n\t\trc = -EIO;\n\t}\nout:\n\tfree_page((unsigned long)sccb);\n\treturn rc;\n}\n\nstatic ssize_t sysfs_ofb_data_write(struct file *filp, struct kobject *kobj,\n\t\t\t\t    struct bin_attribute *bin_attr,\n\t\t\t\t    char *buf, loff_t off, size_t count)\n{\n\tint rc;\n\n\trc = sclp_ofb_send_req(buf, count);\n\treturn rc ?: count;\n}\n\nstatic const struct bin_attribute ofb_bin_attr = {\n\t.attr = {\n\t\t.name = \"event_data\",\n\t\t.mode = S_IWUSR,\n\t},\n\t.write = sysfs_ofb_data_write,\n};\n#endif\n\nstatic int __init sclp_ofb_setup(void)\n{\n#ifdef CONFIG_SCLP_OFB\n\tstruct kset *ofb_kset;\n\tint rc;\n\n\tofb_kset = kset_create_and_add(\"ofb\", NULL, firmware_kobj);\n\tif (!ofb_kset)\n\t\treturn -ENOMEM;\n\trc = sysfs_create_bin_file(&ofb_kset->kobj, &ofb_bin_attr);\n\tif (rc) {\n\t\tkset_unregister(ofb_kset);\n\t\treturn rc;\n\t}\n#endif\n\treturn 0;\n}\n\nstatic int __init sclp_conf_init(void)\n{\n\tint rc;\n\n\tINIT_WORK(&sclp_cpu_capability_work, sclp_cpu_capability_notify);\n\tINIT_WORK(&sclp_cpu_change_work, sclp_cpu_change_notify);\n\trc = sclp_register(&sclp_conf_register);\n\tif (rc)\n\t\treturn rc;\n\treturn sclp_ofb_setup();\n}\n\n__initcall(sclp_conf_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}