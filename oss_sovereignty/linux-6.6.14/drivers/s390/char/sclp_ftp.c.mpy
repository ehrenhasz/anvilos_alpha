{
  "module_name": "sclp_ftp.c",
  "hash_id": "2121c19ffc8caff5fa09c625a7f1c7c8c0ae636f4e7ba71243e3ab3978eb845b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/char/sclp_ftp.c",
  "human_readable_source": "\n \n\n#define KMSG_COMPONENT \"hmcdrv\"\n#define pr_fmt(fmt) KMSG_COMPONENT \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/mm.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n#include <linux/wait.h>\n#include <linux/string.h>\n#include <linux/jiffies.h>\n#include <asm/sysinfo.h>\n#include <asm/ebcdic.h>\n\n#include \"sclp.h\"\n#include \"sclp_diag.h\"\n#include \"sclp_ftp.h\"\n\nstatic DECLARE_COMPLETION(sclp_ftp_rx_complete);\nstatic u8 sclp_ftp_ldflg;\nstatic u64 sclp_ftp_fsize;\nstatic u64 sclp_ftp_length;\n\n \nstatic void sclp_ftp_txcb(struct sclp_req *req, void *data)\n{\n\tstruct completion *completion = data;\n\n#ifdef DEBUG\n\tpr_debug(\"SCLP (ET7) TX-IRQ, SCCB @ 0x%p: %*phN\\n\",\n\t\t req->sccb, 24, req->sccb);\n#endif\n\tcomplete(completion);\n}\n\n \nstatic void sclp_ftp_rxcb(struct evbuf_header *evbuf)\n{\n\tstruct sclp_diag_evbuf *diag = (struct sclp_diag_evbuf *) evbuf;\n\n\t \n\tif (evbuf->type != EVTYP_DIAG_TEST ||\n\t    diag->route != SCLP_DIAG_FTP_ROUTE ||\n\t    diag->mdd.ftp.pcx != SCLP_DIAG_FTP_XPCX ||\n\t    evbuf->length < SCLP_DIAG_FTP_EVBUF_LEN)\n\t\treturn;\n\n#ifdef DEBUG\n\tpr_debug(\"SCLP (ET7) RX-IRQ, Event @ 0x%p: %*phN\\n\",\n\t\t evbuf, 24, evbuf);\n#endif\n\n\t \n\tsclp_ftp_ldflg = diag->mdd.ftp.ldflg;\n\tsclp_ftp_fsize = diag->mdd.ftp.fsize;\n\tsclp_ftp_length = diag->mdd.ftp.length;\n\n\tcomplete(&sclp_ftp_rx_complete);\n}\n\n \nstatic int sclp_ftp_et7(const struct hmcdrv_ftp_cmdspec *ftp)\n{\n\tstruct completion completion;\n\tstruct sclp_diag_sccb *sccb;\n\tstruct sclp_req *req;\n\tssize_t len;\n\tint rc;\n\n\treq = kzalloc(sizeof(*req), GFP_KERNEL);\n\tsccb = (void *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\n\tif (!req || !sccb) {\n\t\trc = -ENOMEM;\n\t\tgoto out_free;\n\t}\n\n\tsccb->hdr.length = SCLP_DIAG_FTP_EVBUF_LEN +\n\t\tsizeof(struct sccb_header);\n\tsccb->evbuf.hdr.type = EVTYP_DIAG_TEST;\n\tsccb->evbuf.hdr.length = SCLP_DIAG_FTP_EVBUF_LEN;\n\tsccb->evbuf.hdr.flags = 0;  \n\tsccb->evbuf.route = SCLP_DIAG_FTP_ROUTE;\n\tsccb->evbuf.mdd.ftp.pcx = SCLP_DIAG_FTP_XPCX;\n\tsccb->evbuf.mdd.ftp.srcflg = 0;\n\tsccb->evbuf.mdd.ftp.pgsize = 0;\n\tsccb->evbuf.mdd.ftp.asce = _ASCE_REAL_SPACE;\n\tsccb->evbuf.mdd.ftp.ldflg = SCLP_DIAG_FTP_LDFAIL;\n\tsccb->evbuf.mdd.ftp.fsize = 0;\n\tsccb->evbuf.mdd.ftp.cmd = ftp->id;\n\tsccb->evbuf.mdd.ftp.offset = ftp->ofs;\n\tsccb->evbuf.mdd.ftp.length = ftp->len;\n\tsccb->evbuf.mdd.ftp.bufaddr = virt_to_phys(ftp->buf);\n\n\tlen = strscpy(sccb->evbuf.mdd.ftp.fident, ftp->fname,\n\t\t      HMCDRV_FTP_FIDENT_MAX);\n\tif (len < 0) {\n\t\trc = -EINVAL;\n\t\tgoto out_free;\n\t}\n\n\treq->command = SCLP_CMDW_WRITE_EVENT_DATA;\n\treq->sccb = sccb;\n\treq->status = SCLP_REQ_FILLED;\n\treq->callback = sclp_ftp_txcb;\n\treq->callback_data = &completion;\n\n\tinit_completion(&completion);\n\n\trc = sclp_add_request(req);\n\tif (rc)\n\t\tgoto out_free;\n\n\t \n\twait_for_completion(&completion);\n\n#ifdef DEBUG\n\tpr_debug(\"status of SCLP (ET7) request is 0x%04x (0x%02x)\\n\",\n\t\t sccb->hdr.response_code, sccb->evbuf.hdr.flags);\n#endif\n\n\t \n\tif (req->status != SCLP_REQ_DONE ||\n\t    (sccb->evbuf.hdr.flags & 0x80) == 0 ||  \n\t    (sccb->hdr.response_code & 0xffU) != 0x20U) {\n\t\trc = -EIO;\n\t}\n\nout_free:\n\tfree_page((unsigned long) sccb);\n\tkfree(req);\n\treturn rc;\n}\n\n \nssize_t sclp_ftp_cmd(const struct hmcdrv_ftp_cmdspec *ftp, size_t *fsize)\n{\n\tssize_t len;\n#ifdef DEBUG\n\tunsigned long start_jiffies;\n\n\tpr_debug(\"starting SCLP (ET7), cmd %d for '%s' at %lld with %zd bytes\\n\",\n\t\t ftp->id, ftp->fname, (long long) ftp->ofs, ftp->len);\n\tstart_jiffies = jiffies;\n#endif\n\n\tinit_completion(&sclp_ftp_rx_complete);\n\n\t \n\tlen = sclp_ftp_et7(ftp);\n\tif (len)\n\t\tgoto out_unlock;\n\n\t \n\twait_for_completion(&sclp_ftp_rx_complete);\n\n#ifdef DEBUG\n\tpr_debug(\"completed SCLP (ET7) request after %lu ms (all)\\n\",\n\t\t (jiffies - start_jiffies) * 1000 / HZ);\n\tpr_debug(\"return code of SCLP (ET7) FTP Service is 0x%02x, with %lld/%lld bytes\\n\",\n\t\t sclp_ftp_ldflg, sclp_ftp_length, sclp_ftp_fsize);\n#endif\n\n\tswitch (sclp_ftp_ldflg) {\n\tcase SCLP_DIAG_FTP_OK:\n\t\tlen = sclp_ftp_length;\n\t\tif (fsize)\n\t\t\t*fsize = sclp_ftp_fsize;\n\t\tbreak;\n\tcase SCLP_DIAG_FTP_LDNPERM:\n\t\tlen = -EPERM;\n\t\tbreak;\n\tcase SCLP_DIAG_FTP_LDRUNS:\n\t\tlen = -EBUSY;\n\t\tbreak;\n\tcase SCLP_DIAG_FTP_LDFAIL:\n\t\tlen = -ENOENT;\n\t\tbreak;\n\tdefault:\n\t\tlen = -EIO;\n\t\tbreak;\n\t}\n\nout_unlock:\n\treturn len;\n}\n\n \nstatic struct sclp_register sclp_ftp_event = {\n\t.send_mask = EVTYP_DIAG_TEST_MASK,     \n\t.receive_mask = EVTYP_DIAG_TEST_MASK,  \n\t.receiver_fn = sclp_ftp_rxcb,\t       \n\t.state_change_fn = NULL,\n};\n\n \nint sclp_ftp_startup(void)\n{\n#ifdef DEBUG\n\tunsigned long info;\n#endif\n\tint rc;\n\n\trc = sclp_register(&sclp_ftp_event);\n\tif (rc)\n\t\treturn rc;\n\n#ifdef DEBUG\n\tinfo = get_zeroed_page(GFP_KERNEL);\n\n\tif (info != 0) {\n\t\tstruct sysinfo_2_2_2 *info222 = (struct sysinfo_2_2_2 *)info;\n\n\t\tif (!stsi(info222, 2, 2, 2)) {  \n\t\t\tinfo222->name[sizeof(info222->name) - 1] = '\\0';\n\t\t\tEBCASC_500(info222->name, sizeof(info222->name) - 1);\n\t\t\tpr_debug(\"SCLP (ET7) FTP Service working on LPAR %u (%s)\\n\",\n\t\t\t\t info222->lpar_number, info222->name);\n\t\t}\n\n\t\tfree_page(info);\n\t}\n#endif\t \n\treturn 0;\n}\n\n \nvoid sclp_ftp_shutdown(void)\n{\n\tsclp_unregister(&sclp_ftp_event);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}