{
  "module_name": "hmcdrv_ftp.c",
  "hash_id": "14da71841466d88bff4c2aaee6e3ab3502e508a07dcbf75a3bec73e283db77eb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/char/hmcdrv_ftp.c",
  "human_readable_source": "\n \n\n#define KMSG_COMPONENT \"hmcdrv\"\n#define pr_fmt(fmt) KMSG_COMPONENT \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/uaccess.h>\n#include <linux/export.h>\n\n#include <linux/ctype.h>\n#include <linux/crc16.h>\n\n#include \"hmcdrv_ftp.h\"\n#include \"hmcdrv_cache.h\"\n#include \"sclp_ftp.h\"\n#include \"diag_ftp.h\"\n\n \nstruct hmcdrv_ftp_ops {\n\tint (*startup)(void);\n\tvoid (*shutdown)(void);\n\tssize_t (*transfer)(const struct hmcdrv_ftp_cmdspec *ftp,\n\t\t\t    size_t *fsize);\n};\n\nstatic enum hmcdrv_ftp_cmdid hmcdrv_ftp_cmd_getid(const char *cmd, int len);\nstatic int hmcdrv_ftp_parse(char *cmd, struct hmcdrv_ftp_cmdspec *ftp);\n\nstatic const struct hmcdrv_ftp_ops *hmcdrv_ftp_funcs;  \nstatic DEFINE_MUTEX(hmcdrv_ftp_mutex);  \nstatic unsigned hmcdrv_ftp_refcnt;  \n\n \nstatic enum hmcdrv_ftp_cmdid hmcdrv_ftp_cmd_getid(const char *cmd, int len)\n{\n\t \n\tstruct hmcdrv_ftp_cmd_desc {\n\t\tconst char *str;\t    \n\t\tenum hmcdrv_ftp_cmdid cmd;  \n\t};\n\n\t \n\tstatic const struct hmcdrv_ftp_cmd_desc ftpcmds[7] = {\n\n\t\t{.str = \"get\",  \n\t\t .cmd = HMCDRV_FTP_GET},\n\t\t{.str = \"dir\",  \n\t\t .cmd = HMCDRV_FTP_DIR},\n\t\t{.str = \"delete\",  \n\t\t .cmd = HMCDRV_FTP_DELETE},\n\t\t{.str = \"nls\",  \n\t\t .cmd = HMCDRV_FTP_NLIST},\n\t\t{.str = \"put\",  \n\t\t .cmd = HMCDRV_FTP_PUT},\n\t\t{.str = \"append\",  \n\t\t .cmd = HMCDRV_FTP_APPEND},\n\t\t{.str = NULL}  \n\t};\n\n\tconst struct hmcdrv_ftp_cmd_desc *pdesc;\n\n\tu16 crc = 0xffffU;\n\n\tif (len == 0)\n\t\treturn HMCDRV_FTP_NOOP;  \n\n\tcrc = crc16(crc, cmd, len);\n\tpdesc = ftpcmds + (crc % ARRAY_SIZE(ftpcmds));\n\tpr_debug(\"FTP command '%s' has CRC 0x%04x, at table pos. %lu\\n\",\n\t\t cmd, crc, (crc % ARRAY_SIZE(ftpcmds)));\n\n\tif (!pdesc->str || strncmp(pdesc->str, cmd, len))\n\t\treturn HMCDRV_FTP_NOOP;\n\n\tpr_debug(\"FTP command '%s' found, with ID %d\\n\",\n\t\t pdesc->str, pdesc->cmd);\n\n\treturn pdesc->cmd;\n}\n\n \nstatic int hmcdrv_ftp_parse(char *cmd, struct hmcdrv_ftp_cmdspec *ftp)\n{\n\tchar *start;\n\tint argc = 0;\n\n\tftp->id = HMCDRV_FTP_NOOP;\n\tftp->fname = NULL;\n\n\twhile (*cmd != '\\0') {\n\n\t\twhile (isspace(*cmd))\n\t\t\t++cmd;\n\n\t\tif (*cmd == '\\0')\n\t\t\tbreak;\n\n\t\tstart = cmd;\n\n\t\tswitch (argc) {\n\t\tcase 0:  \n\t\t\twhile ((*cmd != '\\0') && !isspace(*cmd))\n\t\t\t\t++cmd;\n\t\t\tftp->id = hmcdrv_ftp_cmd_getid(start, cmd - start);\n\t\t\tbreak;\n\t\tcase 1:  \n\t\t\twhile ((*cmd != '\\0') && !iscntrl(*cmd))\n\t\t\t\t++cmd;\n\t\t\tftp->fname = start;\n\t\t\tfallthrough;\n\t\tdefault:\n\t\t\t*cmd = '\\0';\n\t\t\tbreak;\n\t\t}  \n\n\t\t++argc;\n\t}  \n\n\tif (!ftp->fname || (ftp->id == HMCDRV_FTP_NOOP))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\n \nssize_t hmcdrv_ftp_do(const struct hmcdrv_ftp_cmdspec *ftp)\n{\n\tssize_t len;\n\n\tmutex_lock(&hmcdrv_ftp_mutex);\n\n\tif (hmcdrv_ftp_funcs && hmcdrv_ftp_refcnt) {\n\t\tpr_debug(\"starting transfer, cmd %d for '%s' at %lld with %zd bytes\\n\",\n\t\t\t ftp->id, ftp->fname, (long long) ftp->ofs, ftp->len);\n\t\tlen = hmcdrv_cache_cmd(ftp, hmcdrv_ftp_funcs->transfer);\n\t} else {\n\t\tlen = -ENXIO;\n\t}\n\n\tmutex_unlock(&hmcdrv_ftp_mutex);\n\treturn len;\n}\nEXPORT_SYMBOL(hmcdrv_ftp_do);\n\n \nint hmcdrv_ftp_probe(void)\n{\n\tint rc;\n\n\tstruct hmcdrv_ftp_cmdspec ftp = {\n\t\t.id = HMCDRV_FTP_NOOP,\n\t\t.ofs = 0,\n\t\t.fname = \"\",\n\t\t.len = PAGE_SIZE\n\t};\n\n\tftp.buf = (void *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\n\n\tif (!ftp.buf)\n\t\treturn -ENOMEM;\n\n\trc = hmcdrv_ftp_startup();\n\n\tif (rc)\n\t\tgoto out;\n\n\trc = hmcdrv_ftp_do(&ftp);\n\thmcdrv_ftp_shutdown();\n\n\tswitch (rc) {\n\tcase -ENOENT:  \n\tcase -EBUSY:   \n\t\trc = 0;\n\t\tbreak;\n\tdefault:  \n\t\tif (rc > 0)\n\t\t\trc = 0;  \n\t\tbreak;\n\t}  \nout:\n\tfree_page((unsigned long) ftp.buf);\n\treturn rc;\n}\nEXPORT_SYMBOL(hmcdrv_ftp_probe);\n\n \nssize_t hmcdrv_ftp_cmd(char __kernel *cmd, loff_t offset,\n\t\t       char __user *buf, size_t len)\n{\n\tint order;\n\n\tstruct hmcdrv_ftp_cmdspec ftp = {.len = len, .ofs = offset};\n\tssize_t retlen = hmcdrv_ftp_parse(cmd, &ftp);\n\n\tif (retlen)\n\t\treturn retlen;\n\n\torder = get_order(ftp.len);\n\tftp.buf = (void *) __get_free_pages(GFP_KERNEL | GFP_DMA, order);\n\n\tif (!ftp.buf)\n\t\treturn -ENOMEM;\n\n\tswitch (ftp.id) {\n\tcase HMCDRV_FTP_DIR:\n\tcase HMCDRV_FTP_NLIST:\n\tcase HMCDRV_FTP_GET:\n\t\tretlen = hmcdrv_ftp_do(&ftp);\n\n\t\tif ((retlen >= 0) &&\n\t\t    copy_to_user(buf, ftp.buf, retlen))\n\t\t\tretlen = -EFAULT;\n\t\tbreak;\n\n\tcase HMCDRV_FTP_PUT:\n\tcase HMCDRV_FTP_APPEND:\n\t\tif (!copy_from_user(ftp.buf, buf, ftp.len))\n\t\t\tretlen = hmcdrv_ftp_do(&ftp);\n\t\telse\n\t\t\tretlen = -EFAULT;\n\t\tbreak;\n\n\tcase HMCDRV_FTP_DELETE:\n\t\tretlen = hmcdrv_ftp_do(&ftp);\n\t\tbreak;\n\n\tdefault:\n\t\tretlen = -EOPNOTSUPP;\n\t\tbreak;\n\t}\n\n\tfree_pages((unsigned long) ftp.buf, order);\n\treturn retlen;\n}\n\n \nint hmcdrv_ftp_startup(void)\n{\n\tstatic const struct hmcdrv_ftp_ops hmcdrv_ftp_zvm = {\n\t\t.startup = diag_ftp_startup,\n\t\t.shutdown = diag_ftp_shutdown,\n\t\t.transfer = diag_ftp_cmd\n\t};\n\n\tstatic const struct hmcdrv_ftp_ops hmcdrv_ftp_lpar = {\n\t\t.startup = sclp_ftp_startup,\n\t\t.shutdown = sclp_ftp_shutdown,\n\t\t.transfer = sclp_ftp_cmd\n\t};\n\n\tint rc = 0;\n\n\tmutex_lock(&hmcdrv_ftp_mutex);  \n\n\tif (hmcdrv_ftp_refcnt == 0) {\n\t\tif (MACHINE_IS_VM)\n\t\t\thmcdrv_ftp_funcs = &hmcdrv_ftp_zvm;\n\t\telse if (MACHINE_IS_LPAR || MACHINE_IS_KVM)\n\t\t\thmcdrv_ftp_funcs = &hmcdrv_ftp_lpar;\n\t\telse\n\t\t\trc = -EOPNOTSUPP;\n\n\t\tif (hmcdrv_ftp_funcs)\n\t\t\trc = hmcdrv_ftp_funcs->startup();\n\t}\n\n\tif (!rc)\n\t\t++hmcdrv_ftp_refcnt;\n\n\tmutex_unlock(&hmcdrv_ftp_mutex);\n\treturn rc;\n}\nEXPORT_SYMBOL(hmcdrv_ftp_startup);\n\n \nvoid hmcdrv_ftp_shutdown(void)\n{\n\tmutex_lock(&hmcdrv_ftp_mutex);\n\t--hmcdrv_ftp_refcnt;\n\n\tif ((hmcdrv_ftp_refcnt == 0) && hmcdrv_ftp_funcs)\n\t\thmcdrv_ftp_funcs->shutdown();\n\n\tmutex_unlock(&hmcdrv_ftp_mutex);\n}\nEXPORT_SYMBOL(hmcdrv_ftp_shutdown);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}