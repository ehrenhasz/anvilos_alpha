{
  "module_name": "sclp_sdias.c",
  "hash_id": "9f2e3ee231261764818008e07b53a1f46a1462e823e33c6a87feea5803a5d835",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/char/sclp_sdias.c",
  "human_readable_source": "\n \n\n#define KMSG_COMPONENT \"sclp_sdias\"\n#define pr_fmt(fmt) KMSG_COMPONENT \": \" fmt\n\n#include <linux/completion.h>\n#include <linux/sched.h>\n#include <asm/sclp.h>\n#include <asm/debug.h>\n#include <asm/ipl.h>\n\n#include \"sclp_sdias.h\"\n#include \"sclp.h\"\n#include \"sclp_rw.h\"\n\n#define TRACE(x...) debug_sprintf_event(sdias_dbf, 1, x)\n\n#define SDIAS_RETRIES 300\n\nstatic struct debug_info *sdias_dbf;\n\nstatic struct sclp_register sclp_sdias_register = {\n\t.send_mask = EVTYP_SDIAS_MASK,\n};\n\nstatic struct sdias_sccb *sclp_sdias_sccb;\nstatic struct sdias_evbuf sdias_evbuf;\n\nstatic DECLARE_COMPLETION(evbuf_accepted);\nstatic DECLARE_COMPLETION(evbuf_done);\nstatic DEFINE_MUTEX(sdias_mutex);\n\n \nstatic void sclp_sdias_receiver_fn(struct evbuf_header *evbuf)\n{\n\tmemcpy(&sdias_evbuf, evbuf,\n\t       min_t(unsigned long, sizeof(sdias_evbuf), evbuf->length));\n\tcomplete(&evbuf_done);\n\tTRACE(\"sclp_sdias_receiver_fn done\\n\");\n}\n\n \nstatic void sdias_callback(struct sclp_req *request, void *data)\n{\n\tcomplete(&evbuf_accepted);\n\tTRACE(\"callback done\\n\");\n}\n\nstatic int sdias_sclp_send(struct sclp_req *req)\n{\n\tstruct sdias_sccb *sccb = sclp_sdias_sccb;\n\tint retries;\n\tint rc;\n\n\tfor (retries = SDIAS_RETRIES; retries; retries--) {\n\t\tTRACE(\"add request\\n\");\n\t\trc = sclp_add_request(req);\n\t\tif (rc) {\n\t\t\t \n\t\t\tset_current_state(TASK_INTERRUPTIBLE);\n\t\t\tTRACE(\"add request failed: rc = %i\\n\",rc);\n\t\t\tschedule_timeout(msecs_to_jiffies(500));\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\twait_for_completion(&evbuf_accepted);\n\t\tif (req->status == SCLP_REQ_FAILED) {\n\t\t\tTRACE(\"sclp request failed\\n\");\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tif (!(sccb->evbuf.hdr.flags & 0x80)) {\n\t\t\tTRACE(\"sclp request failed: flags=%x\\n\",\n\t\t\t      sccb->evbuf.hdr.flags);\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tif (!sclp_sdias_register.receiver_fn) {\n\t\t\tmemcpy(&sdias_evbuf, &sccb->evbuf, sizeof(sdias_evbuf));\n\t\t\tTRACE(\"sync request done\\n\");\n\t\t\treturn 0;\n\t\t}\n\t\t \n\t\twait_for_completion(&evbuf_done);\n\t\tTRACE(\"request done\\n\");\n\t\treturn 0;\n\t}\n\treturn -EIO;\n}\n\n \nint sclp_sdias_blk_count(void)\n{\n\tstruct sdias_sccb *sccb = sclp_sdias_sccb;\n\tstruct sclp_req request;\n\tint rc;\n\n\tmutex_lock(&sdias_mutex);\n\n\tmemset(sccb, 0, sizeof(*sccb));\n\tmemset(&request, 0, sizeof(request));\n\n\tsccb->hdr.length = sizeof(*sccb);\n\tsccb->evbuf.hdr.length = sizeof(struct sdias_evbuf);\n\tsccb->evbuf.hdr.type = EVTYP_SDIAS;\n\tsccb->evbuf.event_qual = SDIAS_EQ_SIZE;\n\tsccb->evbuf.data_id = SDIAS_DI_FCP_DUMP;\n\tsccb->evbuf.event_id = 4712;\n\tsccb->evbuf.dbs = 1;\n\n\trequest.sccb = sccb;\n\trequest.command = SCLP_CMDW_WRITE_EVENT_DATA;\n\trequest.status = SCLP_REQ_FILLED;\n\trequest.callback = sdias_callback;\n\n\trc = sdias_sclp_send(&request);\n\tif (rc) {\n\t\tpr_err(\"sclp_send failed for get_nr_blocks\\n\");\n\t\tgoto out;\n\t}\n\tif (sccb->hdr.response_code != 0x0020) {\n\t\tTRACE(\"send failed: %x\\n\", sccb->hdr.response_code);\n\t\trc = -EIO;\n\t\tgoto out;\n\t}\n\n\tswitch (sdias_evbuf.event_status) {\n\t\tcase 0:\n\t\t\trc = sdias_evbuf.blk_cnt;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpr_err(\"SCLP error: %x\\n\", sdias_evbuf.event_status);\n\t\t\trc = -EIO;\n\t\t\tgoto out;\n\t}\n\tTRACE(\"%i blocks\\n\", rc);\nout:\n\tmutex_unlock(&sdias_mutex);\n\treturn rc;\n}\n\n \nint sclp_sdias_copy(void *dest, int start_blk, int nr_blks)\n{\n\tstruct sdias_sccb *sccb = sclp_sdias_sccb;\n\tstruct sclp_req request;\n\tint rc;\n\n\tmutex_lock(&sdias_mutex);\n\n\tmemset(sccb, 0, sizeof(*sccb));\n\tmemset(&request, 0, sizeof(request));\n\n\tsccb->hdr.length = sizeof(*sccb);\n\tsccb->evbuf.hdr.length = sizeof(struct sdias_evbuf);\n\tsccb->evbuf.hdr.type = EVTYP_SDIAS;\n\tsccb->evbuf.hdr.flags = 0;\n\tsccb->evbuf.event_qual = SDIAS_EQ_STORE_DATA;\n\tsccb->evbuf.data_id = SDIAS_DI_FCP_DUMP;\n\tsccb->evbuf.event_id = 4712;\n\tsccb->evbuf.asa_size = SDIAS_ASA_SIZE_64;\n\tsccb->evbuf.event_status = 0;\n\tsccb->evbuf.blk_cnt = nr_blks;\n\tsccb->evbuf.asa = __pa(dest);\n\tsccb->evbuf.fbn = start_blk;\n\tsccb->evbuf.lbn = 0;\n\tsccb->evbuf.dbs = 1;\n\n\trequest.sccb\t = sccb;\n\trequest.command  = SCLP_CMDW_WRITE_EVENT_DATA;\n\trequest.status\t = SCLP_REQ_FILLED;\n\trequest.callback = sdias_callback;\n\n\trc = sdias_sclp_send(&request);\n\tif (rc) {\n\t\tpr_err(\"sclp_send failed: %x\\n\", rc);\n\t\tgoto out;\n\t}\n\tif (sccb->hdr.response_code != 0x0020) {\n\t\tTRACE(\"copy failed: %x\\n\", sccb->hdr.response_code);\n\t\trc = -EIO;\n\t\tgoto out;\n\t}\n\n\tswitch (sdias_evbuf.event_status) {\n\tcase SDIAS_EVSTATE_ALL_STORED:\n\t\tTRACE(\"all stored\\n\");\n\t\tbreak;\n\tcase SDIAS_EVSTATE_PART_STORED:\n\t\tTRACE(\"part stored: %i\\n\", sdias_evbuf.blk_cnt);\n\t\tbreak;\n\tcase SDIAS_EVSTATE_NO_DATA:\n\t\tTRACE(\"no data\\n\");\n\t\tfallthrough;\n\tdefault:\n\t\tpr_err(\"Error from SCLP while copying hsa. Event status = %x\\n\",\n\t\t       sdias_evbuf.event_status);\n\t\trc = -EIO;\n\t}\nout:\n\tmutex_unlock(&sdias_mutex);\n\treturn rc;\n}\n\nstatic int __init sclp_sdias_register_check(void)\n{\n\tint rc;\n\n\trc = sclp_register(&sclp_sdias_register);\n\tif (rc)\n\t\treturn rc;\n\tif (sclp_sdias_blk_count() == 0) {\n\t\tsclp_unregister(&sclp_sdias_register);\n\t\treturn -ENODEV;\n\t}\n\treturn 0;\n}\n\nstatic int __init sclp_sdias_init_sync(void)\n{\n\tTRACE(\"Try synchronous mode\\n\");\n\tsclp_sdias_register.receive_mask = 0;\n\tsclp_sdias_register.receiver_fn = NULL;\n\treturn sclp_sdias_register_check();\n}\n\nstatic int __init sclp_sdias_init_async(void)\n{\n\tTRACE(\"Try asynchronous mode\\n\");\n\tsclp_sdias_register.receive_mask = EVTYP_SDIAS_MASK;\n\tsclp_sdias_register.receiver_fn = sclp_sdias_receiver_fn;\n\treturn sclp_sdias_register_check();\n}\n\nint __init sclp_sdias_init(void)\n{\n\tif (!is_ipl_type_dump())\n\t\treturn 0;\n\tsclp_sdias_sccb = (void *) __get_free_page(GFP_KERNEL | GFP_DMA);\n\tBUG_ON(!sclp_sdias_sccb);\n\tsdias_dbf = debug_register(\"dump_sdias\", 4, 1, 4 * sizeof(long));\n\tdebug_register_view(sdias_dbf, &debug_sprintf_view);\n\tdebug_set_level(sdias_dbf, 6);\n\tif (sclp_sdias_init_sync() == 0)\n\t\tgoto out;\n\tif (sclp_sdias_init_async() == 0)\n\t\tgoto out;\n\tTRACE(\"init failed\\n\");\n\tfree_page((unsigned long) sclp_sdias_sccb);\n\treturn -ENODEV;\nout:\n\tTRACE(\"init done\\n\");\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}