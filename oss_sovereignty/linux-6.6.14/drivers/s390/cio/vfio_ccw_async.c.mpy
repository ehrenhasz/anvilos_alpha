{
  "module_name": "vfio_ccw_async.c",
  "hash_id": "63145f43affbb49da1dbe80af6009777efed58e3d3edd7bfb6757a9a666f8ff3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/cio/vfio_ccw_async.c",
  "human_readable_source": "\n \n\n#include <linux/vfio.h>\n\n#include \"vfio_ccw_private.h\"\n\nstatic ssize_t vfio_ccw_async_region_read(struct vfio_ccw_private *private,\n\t\t\t\t\t  char __user *buf, size_t count,\n\t\t\t\t\t  loff_t *ppos)\n{\n\tunsigned int i = VFIO_CCW_OFFSET_TO_INDEX(*ppos) - VFIO_CCW_NUM_REGIONS;\n\tloff_t pos = *ppos & VFIO_CCW_OFFSET_MASK;\n\tstruct ccw_cmd_region *region;\n\tint ret;\n\n\tif (pos + count > sizeof(*region))\n\t\treturn -EINVAL;\n\n\tmutex_lock(&private->io_mutex);\n\tregion = private->region[i].data;\n\tif (copy_to_user(buf, (void *)region + pos, count))\n\t\tret = -EFAULT;\n\telse\n\t\tret = count;\n\tmutex_unlock(&private->io_mutex);\n\treturn ret;\n}\n\nstatic ssize_t vfio_ccw_async_region_write(struct vfio_ccw_private *private,\n\t\t\t\t\t   const char __user *buf, size_t count,\n\t\t\t\t\t   loff_t *ppos)\n{\n\tunsigned int i = VFIO_CCW_OFFSET_TO_INDEX(*ppos) - VFIO_CCW_NUM_REGIONS;\n\tloff_t pos = *ppos & VFIO_CCW_OFFSET_MASK;\n\tstruct ccw_cmd_region *region;\n\tint ret;\n\n\tif (pos + count > sizeof(*region))\n\t\treturn -EINVAL;\n\n\tif (!mutex_trylock(&private->io_mutex))\n\t\treturn -EAGAIN;\n\n\tregion = private->region[i].data;\n\tif (copy_from_user((void *)region + pos, buf, count)) {\n\t\tret = -EFAULT;\n\t\tgoto out_unlock;\n\t}\n\n\tvfio_ccw_fsm_event(private, VFIO_CCW_EVENT_ASYNC_REQ);\n\n\tret = region->ret_code ? region->ret_code : count;\n\nout_unlock:\n\tmutex_unlock(&private->io_mutex);\n\treturn ret;\n}\n\nstatic void vfio_ccw_async_region_release(struct vfio_ccw_private *private,\n\t\t\t\t\t  struct vfio_ccw_region *region)\n{\n\n}\n\nstatic const struct vfio_ccw_regops vfio_ccw_async_region_ops = {\n\t.read = vfio_ccw_async_region_read,\n\t.write = vfio_ccw_async_region_write,\n\t.release = vfio_ccw_async_region_release,\n};\n\nint vfio_ccw_register_async_dev_regions(struct vfio_ccw_private *private)\n{\n\treturn vfio_ccw_register_dev_region(private,\n\t\t\t\t\t    VFIO_REGION_SUBTYPE_CCW_ASYNC_CMD,\n\t\t\t\t\t    &vfio_ccw_async_region_ops,\n\t\t\t\t\t    sizeof(struct ccw_cmd_region),\n\t\t\t\t\t    VFIO_REGION_INFO_FLAG_READ |\n\t\t\t\t\t    VFIO_REGION_INFO_FLAG_WRITE,\n\t\t\t\t\t    private->cmd_region);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}