{
  "module_name": "qdio_thinint.c",
  "hash_id": "a4653d0a00bbff76090f9cb2109d395848c6358b82a9d31a58ec92712c98ae1a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/cio/qdio_thinint.c",
  "human_readable_source": "\n \n#include <linux/io.h>\n#include <linux/slab.h>\n#include <linux/kernel_stat.h>\n#include <linux/atomic.h>\n#include <linux/rculist.h>\n\n#include <asm/debug.h>\n#include <asm/qdio.h>\n#include <asm/airq.h>\n#include <asm/isc.h>\n#include <asm/tpi.h>\n\n#include \"cio.h\"\n#include \"ioasm.h\"\n#include \"qdio.h\"\n#include \"qdio_debug.h\"\n\n \n#define TIQDIO_NR_NONSHARED_IND\t\t63\n#define TIQDIO_NR_INDICATORS\t\t(TIQDIO_NR_NONSHARED_IND + 1)\n#define TIQDIO_SHARED_IND\t\t63\n\n \nstruct indicator_t {\n\tu32 ind;\t \n\tatomic_t count;  \n};\n\n \nstatic LIST_HEAD(tiq_list);\nstatic DEFINE_MUTEX(tiq_list_lock);\n\nstatic struct indicator_t *q_indicators;\n\nu64 last_ai_time;\n\n \nstatic u32 *get_indicator(void)\n{\n\tint i;\n\n\tfor (i = 0; i < TIQDIO_NR_NONSHARED_IND; i++)\n\t\tif (!atomic_cmpxchg(&q_indicators[i].count, 0, 1))\n\t\t\treturn &q_indicators[i].ind;\n\n\t \n\tatomic_inc(&q_indicators[TIQDIO_SHARED_IND].count);\n\treturn &q_indicators[TIQDIO_SHARED_IND].ind;\n}\n\nstatic void put_indicator(u32 *addr)\n{\n\tstruct indicator_t *ind = container_of(addr, struct indicator_t, ind);\n\n\tif (!addr)\n\t\treturn;\n\tatomic_dec(&ind->count);\n}\n\nstatic inline int references_shared_dsci(struct qdio_irq *irq_ptr)\n{\n\treturn irq_ptr->dsci == &q_indicators[TIQDIO_SHARED_IND].ind;\n}\n\nint test_nonshared_ind(struct qdio_irq *irq_ptr)\n{\n\tif (!is_thinint_irq(irq_ptr))\n\t\treturn 0;\n\tif (references_shared_dsci(irq_ptr))\n\t\treturn 0;\n\tif (*irq_ptr->dsci)\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\nstatic inline u32 clear_shared_ind(void)\n{\n\tif (!atomic_read(&q_indicators[TIQDIO_SHARED_IND].count))\n\t\treturn 0;\n\treturn xchg(&q_indicators[TIQDIO_SHARED_IND].ind, 0);\n}\n\n \nstatic void tiqdio_thinint_handler(struct airq_struct *airq,\n\t\t\t\t   struct tpi_info *tpi_info)\n{\n\tu64 irq_time = S390_lowcore.int_clock;\n\tu32 si_used = clear_shared_ind();\n\tstruct qdio_irq *irq;\n\n\tlast_ai_time = irq_time;\n\tinc_irq_stat(IRQIO_QAI);\n\n\t \n\trcu_read_lock();\n\n\tlist_for_each_entry_rcu(irq, &tiq_list, entry) {\n\t\t \n\t\tif (unlikely(references_shared_dsci(irq))) {\n\t\t\tif (!si_used)\n\t\t\t\tcontinue;\n\t\t} else {\n\t\t\tif (!*irq->dsci)\n\t\t\t\tcontinue;\n\n\t\t\txchg(irq->dsci, 0);\n\t\t}\n\n\t\tqdio_deliver_irq(irq);\n\t\tirq->last_data_irq_time = irq_time;\n\n\t\tQDIO_PERF_STAT_INC(irq, adapter_int);\n\t}\n\trcu_read_unlock();\n}\n\nstatic struct airq_struct tiqdio_airq = {\n\t.handler = tiqdio_thinint_handler,\n\t.isc = QDIO_AIRQ_ISC,\n};\n\nstatic int set_subchannel_ind(struct qdio_irq *irq_ptr, int reset)\n{\n\tstruct chsc_scssc_area *scssc = (void *)irq_ptr->chsc_page;\n\tu64 summary_indicator_addr, subchannel_indicator_addr;\n\tint rc;\n\n\tif (reset) {\n\t\tsummary_indicator_addr = 0;\n\t\tsubchannel_indicator_addr = 0;\n\t} else {\n\t\tsummary_indicator_addr = virt_to_phys(tiqdio_airq.lsi_ptr);\n\t\tsubchannel_indicator_addr = virt_to_phys(irq_ptr->dsci);\n\t}\n\n\trc = chsc_sadc(irq_ptr->schid, scssc, summary_indicator_addr,\n\t\t       subchannel_indicator_addr, tiqdio_airq.isc);\n\tif (rc) {\n\t\tDBF_ERROR(\"%4x SSI r:%4x\", irq_ptr->schid.sch_no,\n\t\t\t  scssc->response.code);\n\t\tgoto out;\n\t}\n\n\tDBF_EVENT(\"setscind\");\n\tDBF_HEX(&summary_indicator_addr, sizeof(summary_indicator_addr));\n\tDBF_HEX(&subchannel_indicator_addr, sizeof(subchannel_indicator_addr));\nout:\n\treturn rc;\n}\n\nint qdio_establish_thinint(struct qdio_irq *irq_ptr)\n{\n\tint rc;\n\n\tif (!is_thinint_irq(irq_ptr))\n\t\treturn 0;\n\n\tirq_ptr->dsci = get_indicator();\n\tDBF_HEX(&irq_ptr->dsci, sizeof(void *));\n\n\trc = set_subchannel_ind(irq_ptr, 0);\n\tif (rc) {\n\t\tput_indicator(irq_ptr->dsci);\n\t\treturn rc;\n\t}\n\n\tmutex_lock(&tiq_list_lock);\n\tlist_add_rcu(&irq_ptr->entry, &tiq_list);\n\tmutex_unlock(&tiq_list_lock);\n\treturn 0;\n}\n\nvoid qdio_shutdown_thinint(struct qdio_irq *irq_ptr)\n{\n\tif (!is_thinint_irq(irq_ptr))\n\t\treturn;\n\n\tmutex_lock(&tiq_list_lock);\n\tlist_del_rcu(&irq_ptr->entry);\n\tmutex_unlock(&tiq_list_lock);\n\tsynchronize_rcu();\n\n\t \n\tset_subchannel_ind(irq_ptr, 1);\n\tput_indicator(irq_ptr->dsci);\n}\n\nint __init qdio_thinint_init(void)\n{\n\tint rc;\n\n\tq_indicators = kcalloc(TIQDIO_NR_INDICATORS, sizeof(struct indicator_t),\n\t\t\t       GFP_KERNEL);\n\tif (!q_indicators)\n\t\treturn -ENOMEM;\n\n\trc = register_adapter_interrupt(&tiqdio_airq);\n\tif (rc) {\n\t\tDBF_EVENT(\"RTI:%x\", rc);\n\t\tkfree(q_indicators);\n\t\treturn rc;\n\t}\n\treturn 0;\n}\n\nvoid __exit qdio_thinint_exit(void)\n{\n\tWARN_ON(!list_empty(&tiq_list));\n\tunregister_adapter_interrupt(&tiqdio_airq);\n\tkfree(q_indicators);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}