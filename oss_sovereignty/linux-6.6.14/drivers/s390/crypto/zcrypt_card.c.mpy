{
  "module_name": "zcrypt_card.c",
  "hash_id": "37fc12c2b2d95751ffc93a05a9e215e4fb715b90ce1114f8bffa1adec3314e1b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/crypto/zcrypt_card.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/miscdevice.h>\n#include <linux/fs.h>\n#include <linux/proc_fs.h>\n#include <linux/seq_file.h>\n#include <linux/compat.h>\n#include <linux/slab.h>\n#include <linux/atomic.h>\n#include <linux/uaccess.h>\n#include <linux/hw_random.h>\n#include <linux/debugfs.h>\n#include <asm/debug.h>\n\n#include \"zcrypt_debug.h\"\n#include \"zcrypt_api.h\"\n\n#include \"zcrypt_msgtype6.h\"\n#include \"zcrypt_msgtype50.h\"\n\n \n\nstatic ssize_t type_show(struct device *dev,\n\t\t\t struct device_attribute *attr, char *buf)\n{\n\tstruct zcrypt_card *zc = dev_get_drvdata(dev);\n\n\treturn sysfs_emit(buf, \"%s\\n\", zc->type_string);\n}\n\nstatic DEVICE_ATTR_RO(type);\n\nstatic ssize_t online_show(struct device *dev,\n\t\t\t   struct device_attribute *attr,\n\t\t\t   char *buf)\n{\n\tstruct zcrypt_card *zc = dev_get_drvdata(dev);\n\tstruct ap_card *ac = to_ap_card(dev);\n\tint online = ac->config && zc->online ? 1 : 0;\n\n\treturn sysfs_emit(buf, \"%d\\n\", online);\n}\n\nstatic ssize_t online_store(struct device *dev,\n\t\t\t    struct device_attribute *attr,\n\t\t\t    const char *buf, size_t count)\n{\n\tstruct zcrypt_card *zc = dev_get_drvdata(dev);\n\tstruct ap_card *ac = to_ap_card(dev);\n\tstruct zcrypt_queue *zq;\n\tint online, id, i = 0, maxzqs = 0;\n\tstruct zcrypt_queue **zq_uelist = NULL;\n\n\tif (sscanf(buf, \"%d\\n\", &online) != 1 || online < 0 || online > 1)\n\t\treturn -EINVAL;\n\n\tif (online && !ac->config)\n\t\treturn -ENODEV;\n\n\tzc->online = online;\n\tid = zc->card->id;\n\n\tZCRYPT_DBF_INFO(\"%s card=%02x online=%d\\n\", __func__, id, online);\n\n\tap_send_online_uevent(&ac->ap_dev, online);\n\n\tspin_lock(&zcrypt_list_lock);\n\t \n\tlist_for_each_entry(zq, &zc->zqueues, list)\n\t\tmaxzqs++;\n\tif (maxzqs > 0)\n\t\tzq_uelist = kcalloc(maxzqs + 1, sizeof(*zq_uelist), GFP_ATOMIC);\n\tlist_for_each_entry(zq, &zc->zqueues, list)\n\t\tif (zcrypt_queue_force_online(zq, online))\n\t\t\tif (zq_uelist) {\n\t\t\t\tzcrypt_queue_get(zq);\n\t\t\t\tzq_uelist[i++] = zq;\n\t\t\t}\n\tspin_unlock(&zcrypt_list_lock);\n\tif (zq_uelist) {\n\t\tfor (i = 0; zq_uelist[i]; i++) {\n\t\t\tzq = zq_uelist[i];\n\t\t\tap_send_online_uevent(&zq->queue->ap_dev, online);\n\t\t\tzcrypt_queue_put(zq);\n\t\t}\n\t\tkfree(zq_uelist);\n\t}\n\n\treturn count;\n}\n\nstatic DEVICE_ATTR_RW(online);\n\nstatic ssize_t load_show(struct device *dev,\n\t\t\t struct device_attribute *attr,\n\t\t\t char *buf)\n{\n\tstruct zcrypt_card *zc = dev_get_drvdata(dev);\n\n\treturn sysfs_emit(buf, \"%d\\n\", atomic_read(&zc->load));\n}\n\nstatic DEVICE_ATTR_RO(load);\n\nstatic struct attribute *zcrypt_card_attrs[] = {\n\t&dev_attr_type.attr,\n\t&dev_attr_online.attr,\n\t&dev_attr_load.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group zcrypt_card_attr_group = {\n\t.attrs = zcrypt_card_attrs,\n};\n\nstruct zcrypt_card *zcrypt_card_alloc(void)\n{\n\tstruct zcrypt_card *zc;\n\n\tzc = kzalloc(sizeof(*zc), GFP_KERNEL);\n\tif (!zc)\n\t\treturn NULL;\n\tINIT_LIST_HEAD(&zc->list);\n\tINIT_LIST_HEAD(&zc->zqueues);\n\tkref_init(&zc->refcount);\n\treturn zc;\n}\nEXPORT_SYMBOL(zcrypt_card_alloc);\n\nvoid zcrypt_card_free(struct zcrypt_card *zc)\n{\n\tkfree(zc);\n}\nEXPORT_SYMBOL(zcrypt_card_free);\n\nstatic void zcrypt_card_release(struct kref *kref)\n{\n\tstruct zcrypt_card *zdev =\n\t\tcontainer_of(kref, struct zcrypt_card, refcount);\n\tzcrypt_card_free(zdev);\n}\n\nvoid zcrypt_card_get(struct zcrypt_card *zc)\n{\n\tkref_get(&zc->refcount);\n}\nEXPORT_SYMBOL(zcrypt_card_get);\n\nint zcrypt_card_put(struct zcrypt_card *zc)\n{\n\treturn kref_put(&zc->refcount, zcrypt_card_release);\n}\nEXPORT_SYMBOL(zcrypt_card_put);\n\n \nint zcrypt_card_register(struct zcrypt_card *zc)\n{\n\tint rc;\n\n\tspin_lock(&zcrypt_list_lock);\n\tlist_add_tail(&zc->list, &zcrypt_card_list);\n\tspin_unlock(&zcrypt_list_lock);\n\n\tzc->online = 1;\n\n\tZCRYPT_DBF_INFO(\"%s card=%02x register online=1\\n\",\n\t\t\t__func__, zc->card->id);\n\n\trc = sysfs_create_group(&zc->card->ap_dev.device.kobj,\n\t\t\t\t&zcrypt_card_attr_group);\n\tif (rc) {\n\t\tspin_lock(&zcrypt_list_lock);\n\t\tlist_del_init(&zc->list);\n\t\tspin_unlock(&zcrypt_list_lock);\n\t}\n\n\treturn rc;\n}\nEXPORT_SYMBOL(zcrypt_card_register);\n\n \nvoid zcrypt_card_unregister(struct zcrypt_card *zc)\n{\n\tZCRYPT_DBF_INFO(\"%s card=%02x unregister\\n\",\n\t\t\t__func__, zc->card->id);\n\n\tspin_lock(&zcrypt_list_lock);\n\tlist_del_init(&zc->list);\n\tspin_unlock(&zcrypt_list_lock);\n\tsysfs_remove_group(&zc->card->ap_dev.device.kobj,\n\t\t\t   &zcrypt_card_attr_group);\n\tzcrypt_card_put(zc);\n}\nEXPORT_SYMBOL(zcrypt_card_unregister);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}