{
  "module_name": "zcrypt_cca_key.h",
  "hash_id": "b19594bc015165e4b99ceaf512a895f3f530d6a9c342e4ce3e0577733bb6e26d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/s390/crypto/zcrypt_cca_key.h",
  "human_readable_source": " \n \n\n#ifndef _ZCRYPT_CCA_KEY_H_\n#define _ZCRYPT_CCA_KEY_H_\n\nstruct t6_keyblock_hdr {\n\tunsigned short blen;\n\tunsigned short ulen;\n\tunsigned short flags;\n};\n\n \nstruct cca_token_hdr {\n\tunsigned char  token_identifier;\n\tunsigned char  version;\n\tunsigned short token_length;\n\tunsigned char  reserved[4];\n} __packed;\n\n#define CCA_TKN_HDR_ID_EXT 0x1E\n\n#define CCA_PVT_USAGE_ALL 0x80\n\n \nstruct cca_public_sec {\n\tunsigned char  section_identifier;\n\tunsigned char  version;\n\tunsigned short section_length;\n\tunsigned char  reserved[2];\n\tunsigned short exponent_len;\n\tunsigned short modulus_bit_len;\n\tunsigned short modulus_byte_len;     \n} __packed;\n\n \nstruct cca_pvt_ext_crt_sec {\n\tunsigned char  section_identifier;\n\tunsigned char  version;\n\tunsigned short section_length;\n\tunsigned char  private_key_hash[20];\n\tunsigned char  reserved1[4];\n\tunsigned char  key_format;\n\tunsigned char  reserved2;\n\tunsigned char  key_name_hash[20];\n\tunsigned char  key_use_flags[4];\n\tunsigned short p_len;\n\tunsigned short q_len;\n\tunsigned short dp_len;\n\tunsigned short dq_len;\n\tunsigned short u_len;\n\tunsigned short mod_len;\n\tunsigned char  reserved3[4];\n\tunsigned short pad_len;\n\tunsigned char  reserved4[52];\n\tunsigned char  confounder[8];\n} __packed;\n\n#define CCA_PVT_EXT_CRT_SEC_ID_PVT 0x08\n#define CCA_PVT_EXT_CRT_SEC_FMT_CL 0x40\n\n \nstatic inline int zcrypt_type6_mex_key_en(struct ica_rsa_modexpo *mex, void *p)\n{\n\tstatic struct cca_token_hdr static_pub_hdr = {\n\t\t.token_identifier\t=  0x1E,\n\t};\n\tstatic struct cca_public_sec static_pub_sec = {\n\t\t.section_identifier\t=  0x04,\n\t};\n\tstruct {\n\t\tstruct t6_keyblock_hdr t6_hdr;\n\t\tstruct cca_token_hdr pubhdr;\n\t\tstruct cca_public_sec pubsec;\n\t\tchar exponent[];\n\t} __packed *key = p;\n\tunsigned char *ptr;\n\n\t \n\tif (WARN_ON_ONCE(mex->inputdatalength > 512))\n\t\treturn -EINVAL;\n\n\tmemset(key, 0, sizeof(*key));\n\n\tkey->pubhdr = static_pub_hdr;\n\tkey->pubsec = static_pub_sec;\n\n\t \n\tptr = key->exponent;\n\tif (copy_from_user(ptr, mex->b_key, mex->inputdatalength))\n\t\treturn -EFAULT;\n\tptr += mex->inputdatalength;\n\t \n\tif (copy_from_user(ptr, mex->n_modulus, mex->inputdatalength))\n\t\treturn -EFAULT;\n\n\tkey->pubsec.modulus_bit_len = 8 * mex->inputdatalength;\n\tkey->pubsec.modulus_byte_len = mex->inputdatalength;\n\tkey->pubsec.exponent_len = mex->inputdatalength;\n\tkey->pubsec.section_length = sizeof(key->pubsec) +\n\t\t\t\t\t2 * mex->inputdatalength;\n\tkey->pubhdr.token_length =\n\t\tkey->pubsec.section_length + sizeof(key->pubhdr);\n\tkey->t6_hdr.ulen = key->pubhdr.token_length + 4;\n\tkey->t6_hdr.blen = key->pubhdr.token_length + 6;\n\n\treturn sizeof(*key) + 2 * mex->inputdatalength;\n}\n\n \nstatic inline int zcrypt_type6_crt_key(struct ica_rsa_modexpo_crt *crt, void *p)\n{\n\tstatic struct cca_public_sec static_cca_pub_sec = {\n\t\t.section_identifier = 4,\n\t\t.section_length = 0x000f,\n\t\t.exponent_len = 0x0003,\n\t};\n\tstatic char pk_exponent[3] = { 0x01, 0x00, 0x01 };\n\tstruct {\n\t\tstruct t6_keyblock_hdr t6_hdr;\n\t\tstruct cca_token_hdr token;\n\t\tstruct cca_pvt_ext_crt_sec pvt;\n\t\tchar key_parts[];\n\t} __packed *key = p;\n\tstruct cca_public_sec *pub;\n\tint short_len, long_len, pad_len, key_len, size;\n\n\t \n\tif (WARN_ON_ONCE(crt->inputdatalength > 512))\n\t\treturn -EINVAL;\n\n\tmemset(key, 0, sizeof(*key));\n\n\tshort_len = (crt->inputdatalength + 1) / 2;\n\tlong_len = short_len + 8;\n\tpad_len = -(3 * long_len + 2 * short_len) & 7;\n\tkey_len = 3 * long_len + 2 * short_len + pad_len + crt->inputdatalength;\n\tsize = sizeof(*key) + key_len + sizeof(*pub) + 3;\n\n\t \n\tkey->t6_hdr.blen = size;\n\tkey->t6_hdr.ulen = size - 2;\n\n\t \n\tkey->token.token_identifier = CCA_TKN_HDR_ID_EXT;\n\tkey->token.token_length = size - 6;\n\n\t \n\tkey->pvt.section_identifier = CCA_PVT_EXT_CRT_SEC_ID_PVT;\n\tkey->pvt.section_length = sizeof(key->pvt) + key_len;\n\tkey->pvt.key_format = CCA_PVT_EXT_CRT_SEC_FMT_CL;\n\tkey->pvt.key_use_flags[0] = CCA_PVT_USAGE_ALL;\n\tkey->pvt.p_len = key->pvt.dp_len = key->pvt.u_len = long_len;\n\tkey->pvt.q_len = key->pvt.dq_len = short_len;\n\tkey->pvt.mod_len = crt->inputdatalength;\n\tkey->pvt.pad_len = pad_len;\n\n\t \n\tif (copy_from_user(key->key_parts, crt->np_prime, long_len) ||\n\t    copy_from_user(key->key_parts + long_len,\n\t\t\t   crt->nq_prime, short_len) ||\n\t    copy_from_user(key->key_parts + long_len + short_len,\n\t\t\t   crt->bp_key, long_len) ||\n\t    copy_from_user(key->key_parts + 2 * long_len + short_len,\n\t\t\t   crt->bq_key, short_len) ||\n\t    copy_from_user(key->key_parts + 2 * long_len + 2 * short_len,\n\t\t\t   crt->u_mult_inv, long_len))\n\t\treturn -EFAULT;\n\tmemset(key->key_parts + 3 * long_len + 2 * short_len + pad_len,\n\t       0xff, crt->inputdatalength);\n\tpub = (struct cca_public_sec *)(key->key_parts + key_len);\n\t*pub = static_cca_pub_sec;\n\tpub->modulus_bit_len = 8 * crt->inputdatalength;\n\t \n\tmemcpy((char *)(pub + 1), pk_exponent, 3);\n\n\treturn size;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}