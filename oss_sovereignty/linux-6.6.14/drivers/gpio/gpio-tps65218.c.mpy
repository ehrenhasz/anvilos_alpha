{
  "module_name": "gpio-tps65218.c",
  "hash_id": "70ce50f9fedf03be0925d67b46050d6dbd22863d5b8b4ced9bc35edb63f66bce",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-tps65218.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/gpio/driver.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/mfd/tps65218.h>\n\nstruct tps65218_gpio {\n\tstruct tps65218 *tps65218;\n\tstruct gpio_chip gpio_chip;\n};\n\nstatic int tps65218_gpio_get(struct gpio_chip *gc, unsigned offset)\n{\n\tstruct tps65218_gpio *tps65218_gpio = gpiochip_get_data(gc);\n\tstruct tps65218 *tps65218 = tps65218_gpio->tps65218;\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(tps65218->regmap, TPS65218_REG_ENABLE2, &val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn !!(val & (TPS65218_ENABLE2_GPIO1 << offset));\n}\n\nstatic void tps65218_gpio_set(struct gpio_chip *gc, unsigned offset,\n\t\t\t      int value)\n{\n\tstruct tps65218_gpio *tps65218_gpio = gpiochip_get_data(gc);\n\tstruct tps65218 *tps65218 = tps65218_gpio->tps65218;\n\n\tif (value)\n\t\ttps65218_set_bits(tps65218, TPS65218_REG_ENABLE2,\n\t\t\t\t  TPS65218_ENABLE2_GPIO1 << offset,\n\t\t\t\t  TPS65218_ENABLE2_GPIO1 << offset,\n\t\t\t\t  TPS65218_PROTECT_L1);\n\telse\n\t\ttps65218_clear_bits(tps65218, TPS65218_REG_ENABLE2,\n\t\t\t\t    TPS65218_ENABLE2_GPIO1 << offset,\n\t\t\t\t    TPS65218_PROTECT_L1);\n}\n\nstatic int tps65218_gpio_output(struct gpio_chip *gc, unsigned offset,\n\t\t\t\tint value)\n{\n\t \n\ttps65218_gpio_set(gc, offset, value);\n\treturn 0;\n}\n\nstatic int tps65218_gpio_input(struct gpio_chip *gc, unsigned offset)\n{\n\treturn -EPERM;\n}\n\nstatic int tps65218_gpio_request(struct gpio_chip *gc, unsigned offset)\n{\n\tstruct tps65218_gpio *tps65218_gpio = gpiochip_get_data(gc);\n\tstruct tps65218 *tps65218 = tps65218_gpio->tps65218;\n\tint ret;\n\n\tif (gpiochip_line_is_open_source(gc, offset)) {\n\t\tdev_err(gc->parent, \"can't work as open source\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (offset) {\n\tcase 0:\n\t\tif (!gpiochip_line_is_open_drain(gc, offset)) {\n\t\t\tdev_err(gc->parent, \"GPO1 works only as open drain\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tret = tps65218_clear_bits(tps65218, TPS65218_REG_SEQ7,\n\t\t\t\t\t  TPS65218_SEQ7_GPO1_SEQ_MASK,\n\t\t\t\t\t  TPS65218_PROTECT_L1);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tret = tps65218_clear_bits(tps65218, TPS65218_REG_CONFIG1,\n\t\t\t\t\t  TPS65218_CONFIG1_IO1_SEL,\n\t\t\t\t\t  TPS65218_PROTECT_L1);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tbreak;\n\tcase 1:\n\t\t \n\t\tret = tps65218_clear_bits(tps65218, TPS65218_REG_CONFIG1,\n\t\t\t\t\t  TPS65218_CONFIG1_IO1_SEL,\n\t\t\t\t\t  TPS65218_PROTECT_L1);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tbreak;\n\n\tcase 2:\n\t\tif (!gpiochip_line_is_open_drain(gc, offset)) {\n\t\t\tdev_err(gc->parent, \"GPO3 works only as open drain\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tret = tps65218_clear_bits(tps65218, TPS65218_REG_SEQ7,\n\t\t\t\t\t  TPS65218_SEQ7_GPO3_SEQ_MASK,\n\t\t\t\t\t  TPS65218_PROTECT_L1);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tret = tps65218_clear_bits(tps65218, TPS65218_REG_CONFIG2,\n\t\t\t\t\t  TPS65218_CONFIG2_DC12_RST,\n\t\t\t\t\t  TPS65218_PROTECT_L1);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int tps65218_gpio_set_config(struct gpio_chip *gc, unsigned offset,\n\t\t\t\t    unsigned long config)\n{\n\tstruct tps65218_gpio *tps65218_gpio = gpiochip_get_data(gc);\n\tstruct tps65218 *tps65218 = tps65218_gpio->tps65218;\n\tenum pin_config_param param = pinconf_to_config_param(config);\n\n\tswitch (offset) {\n\tcase 0:\n\tcase 2:\n\t\t \n\t\tif (param == PIN_CONFIG_DRIVE_OPEN_DRAIN)\n\t\t\treturn 0;\n\t\treturn -ENOTSUPP;\n\tcase 1:\n\t\t \n\t\tif (param == PIN_CONFIG_DRIVE_OPEN_DRAIN)\n\t\t\treturn tps65218_clear_bits(tps65218,\n\t\t\t\t\t\t   TPS65218_REG_CONFIG1,\n\t\t\t\t\t\t   TPS65218_CONFIG1_GPO2_BUF,\n\t\t\t\t\t\t   TPS65218_PROTECT_L1);\n\t\tif (param == PIN_CONFIG_DRIVE_PUSH_PULL)\n\t\t\treturn tps65218_set_bits(tps65218,\n\t\t\t\t\t\t TPS65218_REG_CONFIG1,\n\t\t\t\t\t\t TPS65218_CONFIG1_GPO2_BUF,\n\t\t\t\t\t\t TPS65218_CONFIG1_GPO2_BUF,\n\t\t\t\t\t\t TPS65218_PROTECT_L1);\n\t\treturn -ENOTSUPP;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn -ENOTSUPP;\n}\n\nstatic const struct gpio_chip template_chip = {\n\t.label\t\t\t= \"gpio-tps65218\",\n\t.owner\t\t\t= THIS_MODULE,\n\t.request\t\t= tps65218_gpio_request,\n\t.direction_output\t= tps65218_gpio_output,\n\t.direction_input\t= tps65218_gpio_input,\n\t.get\t\t\t= tps65218_gpio_get,\n\t.set\t\t\t= tps65218_gpio_set,\n\t.set_config\t\t= tps65218_gpio_set_config,\n\t.can_sleep\t\t= true,\n\t.ngpio\t\t\t= 3,\n\t.base\t\t\t= -1,\n};\n\nstatic int tps65218_gpio_probe(struct platform_device *pdev)\n{\n\tstruct tps65218 *tps65218 = dev_get_drvdata(pdev->dev.parent);\n\tstruct tps65218_gpio *tps65218_gpio;\n\n\ttps65218_gpio = devm_kzalloc(&pdev->dev, sizeof(*tps65218_gpio),\n\t\t\t\t     GFP_KERNEL);\n\tif (!tps65218_gpio)\n\t\treturn -ENOMEM;\n\n\ttps65218_gpio->tps65218 = tps65218;\n\ttps65218_gpio->gpio_chip = template_chip;\n\ttps65218_gpio->gpio_chip.parent = &pdev->dev;\n\n\treturn devm_gpiochip_add_data(&pdev->dev, &tps65218_gpio->gpio_chip,\n\t\t\t\t      tps65218_gpio);\n}\n\nstatic const struct of_device_id tps65218_dt_match[] = {\n\t{ .compatible = \"ti,tps65218-gpio\" },\n\t{  }\n};\nMODULE_DEVICE_TABLE(of, tps65218_dt_match);\n\nstatic const struct platform_device_id tps65218_gpio_id_table[] = {\n\t{ \"tps65218-gpio\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(platform, tps65218_gpio_id_table);\n\nstatic struct platform_driver tps65218_gpio_driver = {\n\t.driver = {\n\t\t.name = \"tps65218-gpio\",\n\t\t.of_match_table = tps65218_dt_match,\n\t},\n\t.probe = tps65218_gpio_probe,\n\t.id_table = tps65218_gpio_id_table,\n};\n\nmodule_platform_driver(tps65218_gpio_driver);\n\nMODULE_AUTHOR(\"Nicolas Saenz Julienne <nicolassaenzj@gmail.com>\");\nMODULE_DESCRIPTION(\"GPO interface for TPS65218 PMICs\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}