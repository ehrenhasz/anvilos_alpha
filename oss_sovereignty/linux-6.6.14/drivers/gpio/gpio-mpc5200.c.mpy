{
  "module_name": "gpio-mpc5200.c",
  "hash_id": "e0d8d0ace1131e2f17ce0b4d211993d0a2d43fe97f209d73c62b5c3cfbb9cfa1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-mpc5200.c",
  "human_readable_source": "\n \n\n#include <linux/of.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/gpio/legacy-of-mm-gpiochip.h>\n#include <linux/io.h>\n#include <linux/platform_device.h>\n#include <linux/module.h>\n\n#include <asm/mpc52xx.h>\n#include <sysdev/fsl_soc.h>\n\nstatic DEFINE_SPINLOCK(gpio_lock);\n\nstruct mpc52xx_gpiochip {\n\tstruct of_mm_gpio_chip mmchip;\n\tunsigned int shadow_dvo;\n\tunsigned int shadow_gpioe;\n\tunsigned int shadow_ddr;\n};\n\n \nstatic int mpc52xx_wkup_gpio_get(struct gpio_chip *gc, unsigned int gpio)\n{\n\tstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\n\tstruct mpc52xx_gpio_wkup __iomem *regs = mm_gc->regs;\n\tunsigned int ret;\n\n\tret = (in_8(&regs->wkup_ival) >> (7 - gpio)) & 1;\n\n\tpr_debug(\"%s: gpio: %d ret: %d\\n\", __func__, gpio, ret);\n\n\treturn ret;\n}\n\nstatic inline void\n__mpc52xx_wkup_gpio_set(struct gpio_chip *gc, unsigned int gpio, int val)\n{\n\tstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\n\tstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\n\tstruct mpc52xx_gpio_wkup __iomem *regs = mm_gc->regs;\n\n\tif (val)\n\t\tchip->shadow_dvo |= 1 << (7 - gpio);\n\telse\n\t\tchip->shadow_dvo &= ~(1 << (7 - gpio));\n\n\tout_8(&regs->wkup_dvo, chip->shadow_dvo);\n}\n\nstatic void\nmpc52xx_wkup_gpio_set(struct gpio_chip *gc, unsigned int gpio, int val)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gpio_lock, flags);\n\n\t__mpc52xx_wkup_gpio_set(gc, gpio, val);\n\n\tspin_unlock_irqrestore(&gpio_lock, flags);\n\n\tpr_debug(\"%s: gpio: %d val: %d\\n\", __func__, gpio, val);\n}\n\nstatic int mpc52xx_wkup_gpio_dir_in(struct gpio_chip *gc, unsigned int gpio)\n{\n\tstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\n\tstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\n\tstruct mpc52xx_gpio_wkup __iomem *regs = mm_gc->regs;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gpio_lock, flags);\n\n\t \n\tchip->shadow_ddr &= ~(1 << (7 - gpio));\n\tout_8(&regs->wkup_ddr, chip->shadow_ddr);\n\n\t \n\tchip->shadow_gpioe |= 1 << (7 - gpio);\n\tout_8(&regs->wkup_gpioe, chip->shadow_gpioe);\n\n\tspin_unlock_irqrestore(&gpio_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nmpc52xx_wkup_gpio_dir_out(struct gpio_chip *gc, unsigned int gpio, int val)\n{\n\tstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\n\tstruct mpc52xx_gpio_wkup __iomem *regs = mm_gc->regs;\n\tstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gpio_lock, flags);\n\n\t__mpc52xx_wkup_gpio_set(gc, gpio, val);\n\n\t \n\tchip->shadow_ddr |= 1 << (7 - gpio);\n\tout_8(&regs->wkup_ddr, chip->shadow_ddr);\n\n\t \n\tchip->shadow_gpioe |= 1 << (7 - gpio);\n\tout_8(&regs->wkup_gpioe, chip->shadow_gpioe);\n\n\tspin_unlock_irqrestore(&gpio_lock, flags);\n\n\tpr_debug(\"%s: gpio: %d val: %d\\n\", __func__, gpio, val);\n\n\treturn 0;\n}\n\nstatic int mpc52xx_wkup_gpiochip_probe(struct platform_device *ofdev)\n{\n\tstruct mpc52xx_gpiochip *chip;\n\tstruct mpc52xx_gpio_wkup __iomem *regs;\n\tstruct gpio_chip *gc;\n\tint ret;\n\n\tchip = devm_kzalloc(&ofdev->dev, sizeof(*chip), GFP_KERNEL);\n\tif (!chip)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(ofdev, chip);\n\n\tgc = &chip->mmchip.gc;\n\n\tgc->ngpio            = 8;\n\tgc->direction_input  = mpc52xx_wkup_gpio_dir_in;\n\tgc->direction_output = mpc52xx_wkup_gpio_dir_out;\n\tgc->get              = mpc52xx_wkup_gpio_get;\n\tgc->set              = mpc52xx_wkup_gpio_set;\n\n\tret = of_mm_gpiochip_add_data(ofdev->dev.of_node, &chip->mmchip, chip);\n\tif (ret)\n\t\treturn ret;\n\n\tregs = chip->mmchip.regs;\n\tchip->shadow_gpioe = in_8(&regs->wkup_gpioe);\n\tchip->shadow_ddr = in_8(&regs->wkup_ddr);\n\tchip->shadow_dvo = in_8(&regs->wkup_dvo);\n\n\treturn 0;\n}\n\nstatic int mpc52xx_gpiochip_remove(struct platform_device *ofdev)\n{\n\tstruct mpc52xx_gpiochip *chip = platform_get_drvdata(ofdev);\n\n\tof_mm_gpiochip_remove(&chip->mmchip);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id mpc52xx_wkup_gpiochip_match[] = {\n\t{ .compatible = \"fsl,mpc5200-gpio-wkup\", },\n\t{}\n};\n\nstatic struct platform_driver mpc52xx_wkup_gpiochip_driver = {\n\t.driver = {\n\t\t.name = \"mpc5200-gpio-wkup\",\n\t\t.of_match_table = mpc52xx_wkup_gpiochip_match,\n\t},\n\t.probe = mpc52xx_wkup_gpiochip_probe,\n\t.remove = mpc52xx_gpiochip_remove,\n};\n\n \nstatic int mpc52xx_simple_gpio_get(struct gpio_chip *gc, unsigned int gpio)\n{\n\tstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\n\tstruct mpc52xx_gpio __iomem *regs = mm_gc->regs;\n\tunsigned int ret;\n\n\tret = (in_be32(&regs->simple_ival) >> (31 - gpio)) & 1;\n\n\treturn ret;\n}\n\nstatic inline void\n__mpc52xx_simple_gpio_set(struct gpio_chip *gc, unsigned int gpio, int val)\n{\n\tstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\n\tstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\n\tstruct mpc52xx_gpio __iomem *regs = mm_gc->regs;\n\n\tif (val)\n\t\tchip->shadow_dvo |= 1 << (31 - gpio);\n\telse\n\t\tchip->shadow_dvo &= ~(1 << (31 - gpio));\n\tout_be32(&regs->simple_dvo, chip->shadow_dvo);\n}\n\nstatic void\nmpc52xx_simple_gpio_set(struct gpio_chip *gc, unsigned int gpio, int val)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gpio_lock, flags);\n\n\t__mpc52xx_simple_gpio_set(gc, gpio, val);\n\n\tspin_unlock_irqrestore(&gpio_lock, flags);\n\n\tpr_debug(\"%s: gpio: %d val: %d\\n\", __func__, gpio, val);\n}\n\nstatic int mpc52xx_simple_gpio_dir_in(struct gpio_chip *gc, unsigned int gpio)\n{\n\tstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\n\tstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\n\tstruct mpc52xx_gpio __iomem *regs = mm_gc->regs;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gpio_lock, flags);\n\n\t \n\tchip->shadow_ddr &= ~(1 << (31 - gpio));\n\tout_be32(&regs->simple_ddr, chip->shadow_ddr);\n\n\t \n\tchip->shadow_gpioe |= 1 << (31 - gpio);\n\tout_be32(&regs->simple_gpioe, chip->shadow_gpioe);\n\n\tspin_unlock_irqrestore(&gpio_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nmpc52xx_simple_gpio_dir_out(struct gpio_chip *gc, unsigned int gpio, int val)\n{\n\tstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\n\tstruct mpc52xx_gpiochip *chip = gpiochip_get_data(gc);\n\tstruct mpc52xx_gpio __iomem *regs = mm_gc->regs;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&gpio_lock, flags);\n\n\t \n\t__mpc52xx_simple_gpio_set(gc, gpio, val);\n\n\t \n\tchip->shadow_ddr |= 1 << (31 - gpio);\n\tout_be32(&regs->simple_ddr, chip->shadow_ddr);\n\n\t \n\tchip->shadow_gpioe |= 1 << (31 - gpio);\n\tout_be32(&regs->simple_gpioe, chip->shadow_gpioe);\n\n\tspin_unlock_irqrestore(&gpio_lock, flags);\n\n\tpr_debug(\"%s: gpio: %d val: %d\\n\", __func__, gpio, val);\n\n\treturn 0;\n}\n\nstatic int mpc52xx_simple_gpiochip_probe(struct platform_device *ofdev)\n{\n\tstruct mpc52xx_gpiochip *chip;\n\tstruct gpio_chip *gc;\n\tstruct mpc52xx_gpio __iomem *regs;\n\tint ret;\n\n\tchip = devm_kzalloc(&ofdev->dev, sizeof(*chip), GFP_KERNEL);\n\tif (!chip)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(ofdev, chip);\n\n\tgc = &chip->mmchip.gc;\n\n\tgc->ngpio            = 32;\n\tgc->direction_input  = mpc52xx_simple_gpio_dir_in;\n\tgc->direction_output = mpc52xx_simple_gpio_dir_out;\n\tgc->get              = mpc52xx_simple_gpio_get;\n\tgc->set              = mpc52xx_simple_gpio_set;\n\n\tret = of_mm_gpiochip_add_data(ofdev->dev.of_node, &chip->mmchip, chip);\n\tif (ret)\n\t\treturn ret;\n\n\tregs = chip->mmchip.regs;\n\tchip->shadow_gpioe = in_be32(&regs->simple_gpioe);\n\tchip->shadow_ddr = in_be32(&regs->simple_ddr);\n\tchip->shadow_dvo = in_be32(&regs->simple_dvo);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id mpc52xx_simple_gpiochip_match[] = {\n\t{ .compatible = \"fsl,mpc5200-gpio\", },\n\t{}\n};\n\nstatic struct platform_driver mpc52xx_simple_gpiochip_driver = {\n\t.driver = {\n\t\t.name = \"mpc5200-gpio\",\n\t\t.of_match_table = mpc52xx_simple_gpiochip_match,\n\t},\n\t.probe = mpc52xx_simple_gpiochip_probe,\n\t.remove = mpc52xx_gpiochip_remove,\n};\n\nstatic struct platform_driver * const drivers[] = {\n\t&mpc52xx_wkup_gpiochip_driver,\n\t&mpc52xx_simple_gpiochip_driver,\n};\n\nstatic int __init mpc52xx_gpio_init(void)\n{\n\treturn platform_register_drivers(drivers, ARRAY_SIZE(drivers));\n}\n\n \nsubsys_initcall(mpc52xx_gpio_init);\n\nstatic void __exit mpc52xx_gpio_exit(void)\n{\n\tplatform_unregister_drivers(drivers, ARRAY_SIZE(drivers));\n}\nmodule_exit(mpc52xx_gpio_exit);\n\nMODULE_DESCRIPTION(\"Freescale MPC52xx gpio driver\");\nMODULE_AUTHOR(\"Sascha Hauer <s.hauer@pengutronix.de\");\nMODULE_LICENSE(\"GPL v2\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}