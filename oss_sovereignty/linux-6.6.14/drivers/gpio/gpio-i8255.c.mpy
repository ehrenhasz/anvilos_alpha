{
  "module_name": "gpio-i8255.c",
  "hash_id": "3bb0c52bcee426b0aa56397e454a2a77d4e6aed896c330873db43987ab6defaf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-i8255.c",
  "human_readable_source": "\n \n#include <linux/bits.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/export.h>\n#include <linux/gpio/regmap.h>\n#include <linux/module.h>\n#include <linux/regmap.h>\n\n#include \"gpio-i8255.h\"\n\n#define I8255_NGPIO 24\n#define I8255_NGPIO_PER_REG 8\n#define I8255_CONTROL_PORTC_LOWER_DIRECTION BIT(0)\n#define I8255_CONTROL_PORTB_DIRECTION BIT(1)\n#define I8255_CONTROL_PORTC_UPPER_DIRECTION BIT(3)\n#define I8255_CONTROL_PORTA_DIRECTION BIT(4)\n#define I8255_CONTROL_MODE_SET BIT(7)\n#define I8255_PORTA 0x0\n#define I8255_PORTB 0x1\n#define I8255_PORTC 0x2\n#define I8255_CONTROL 0x3\n#define I8255_REG_DAT_BASE I8255_PORTA\n#define I8255_REG_DIR_IN_BASE I8255_CONTROL\n\nstatic int i8255_direction_mask(const unsigned int offset)\n{\n\tconst unsigned int stride = offset / I8255_NGPIO_PER_REG;\n\tconst unsigned int line = offset % I8255_NGPIO_PER_REG;\n\n\tswitch (stride) {\n\tcase I8255_PORTA:\n\t\treturn I8255_CONTROL_PORTA_DIRECTION;\n\tcase I8255_PORTB:\n\t\treturn I8255_CONTROL_PORTB_DIRECTION;\n\tcase I8255_PORTC:\n\t\t \n\t\tif (line >= 4)\n\t\t\treturn I8255_CONTROL_PORTC_UPPER_DIRECTION;\n\t\treturn I8255_CONTROL_PORTC_LOWER_DIRECTION;\n\tdefault:\n\t\t \n\t\treturn 0;\n\t}\n}\n\nstatic int i8255_ppi_init(struct regmap *const map, const unsigned int base)\n{\n\tint err;\n\n\t \n\terr = regmap_write(map, base + I8255_CONTROL, I8255_CONTROL_MODE_SET);\n\tif (err)\n\t\treturn err;\n\n\t \n\terr = regmap_write(map, base + I8255_PORTA, 0x00);\n\tif (err)\n\t\treturn err;\n\terr = regmap_write(map, base + I8255_PORTB, 0x00);\n\tif (err)\n\t\treturn err;\n\treturn regmap_write(map, base + I8255_PORTC, 0x00);\n}\n\nstatic int i8255_reg_mask_xlate(struct gpio_regmap *gpio, unsigned int base,\n\t\t\t\tunsigned int offset, unsigned int *reg,\n\t\t\t\tunsigned int *mask)\n{\n\tconst unsigned int ppi = offset / I8255_NGPIO;\n\tconst unsigned int ppi_offset = offset % I8255_NGPIO;\n\tconst unsigned int stride = ppi_offset / I8255_NGPIO_PER_REG;\n\tconst unsigned int line = ppi_offset % I8255_NGPIO_PER_REG;\n\n\tswitch (base) {\n\tcase I8255_REG_DAT_BASE:\n\t\t*reg = base + stride + ppi * 4;\n\t\t*mask = BIT(line);\n\t\treturn 0;\n\tcase I8255_REG_DIR_IN_BASE:\n\t\t*reg = base + ppi * 4;\n\t\t*mask = i8255_direction_mask(ppi_offset);\n\t\treturn 0;\n\tdefault:\n\t\t \n\t\treturn -EINVAL;\n\t}\n}\n\n \nint devm_i8255_regmap_register(struct device *const dev,\n\t\t\t       const struct i8255_regmap_config *const config)\n{\n\tstruct gpio_regmap_config gpio_config = {0};\n\tunsigned long i;\n\tint err;\n\n\tif (!config->parent)\n\t\treturn -EINVAL;\n\n\tif (!config->map)\n\t\treturn -EINVAL;\n\n\tif (!config->num_ppi)\n\t\treturn -EINVAL;\n\n\tfor (i = 0; i < config->num_ppi; i++) {\n\t\terr = i8255_ppi_init(config->map, i * 4);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tgpio_config.parent = config->parent;\n\tgpio_config.regmap = config->map;\n\tgpio_config.ngpio = I8255_NGPIO * config->num_ppi;\n\tgpio_config.names = config->names;\n\tgpio_config.reg_dat_base = GPIO_REGMAP_ADDR(I8255_REG_DAT_BASE);\n\tgpio_config.reg_set_base = GPIO_REGMAP_ADDR(I8255_REG_DAT_BASE);\n\tgpio_config.reg_dir_in_base = GPIO_REGMAP_ADDR(I8255_REG_DIR_IN_BASE);\n\tgpio_config.ngpio_per_reg = I8255_NGPIO_PER_REG;\n\tgpio_config.irq_domain = config->domain;\n\tgpio_config.reg_mask_xlate = i8255_reg_mask_xlate;\n\n\treturn PTR_ERR_OR_ZERO(devm_gpio_regmap_register(dev, &gpio_config));\n}\nEXPORT_SYMBOL_NS_GPL(devm_i8255_regmap_register, I8255);\n\nMODULE_AUTHOR(\"William Breathitt Gray\");\nMODULE_DESCRIPTION(\"Intel 8255 Programmable Peripheral Interface\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}