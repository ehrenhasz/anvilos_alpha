{
  "module_name": "gpio-moxtet.c",
  "hash_id": "b60ee8d054f28b4f60dbad78a3d48f618e337558c4faa5734463e30549de04c3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-moxtet.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/gpio/driver.h>\n#include <linux/moxtet.h>\n#include <linux/module.h>\n\n#define MOXTET_GPIO_NGPIOS\t12\n#define MOXTET_GPIO_INPUTS\t4\n\nstruct moxtet_gpio_desc {\n\tu16 in_mask;\n\tu16 out_mask;\n};\n\nstatic const struct moxtet_gpio_desc descs[] = {\n\t[TURRIS_MOX_MODULE_SFP] = {\n\t\t.in_mask = GENMASK(2, 0),\n\t\t.out_mask = GENMASK(5, 4),\n\t},\n};\n\nstruct moxtet_gpio_chip {\n\tstruct device\t\t\t*dev;\n\tstruct gpio_chip\t\tgpio_chip;\n\tconst struct moxtet_gpio_desc\t*desc;\n};\n\nstatic int moxtet_gpio_get_value(struct gpio_chip *gc, unsigned int offset)\n{\n\tstruct moxtet_gpio_chip *chip = gpiochip_get_data(gc);\n\tint ret;\n\n\tif (chip->desc->in_mask & BIT(offset)) {\n\t\tret = moxtet_device_read(chip->dev);\n\t} else if (chip->desc->out_mask & BIT(offset)) {\n\t\tret = moxtet_device_written(chip->dev);\n\t\tif (ret >= 0)\n\t\t\tret <<= MOXTET_GPIO_INPUTS;\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn !!(ret & BIT(offset));\n}\n\nstatic void moxtet_gpio_set_value(struct gpio_chip *gc, unsigned int offset,\n\t\t\t\t  int val)\n{\n\tstruct moxtet_gpio_chip *chip = gpiochip_get_data(gc);\n\tint state;\n\n\tstate = moxtet_device_written(chip->dev);\n\tif (state < 0)\n\t\treturn;\n\n\toffset -= MOXTET_GPIO_INPUTS;\n\n\tif (val)\n\t\tstate |= BIT(offset);\n\telse\n\t\tstate &= ~BIT(offset);\n\n\tmoxtet_device_write(chip->dev, state);\n}\n\nstatic int moxtet_gpio_get_direction(struct gpio_chip *gc, unsigned int offset)\n{\n\tstruct moxtet_gpio_chip *chip = gpiochip_get_data(gc);\n\n\t \n\tif (chip->desc->in_mask & BIT(offset))\n\t\treturn GPIO_LINE_DIRECTION_IN;\n\telse if (chip->desc->out_mask & BIT(offset))\n\t\treturn GPIO_LINE_DIRECTION_OUT;\n\telse\n\t\treturn -EINVAL;\n}\n\nstatic int moxtet_gpio_direction_input(struct gpio_chip *gc,\n\t\t\t\t       unsigned int offset)\n{\n\tstruct moxtet_gpio_chip *chip = gpiochip_get_data(gc);\n\n\tif (chip->desc->in_mask & BIT(offset))\n\t\treturn 0;\n\telse if (chip->desc->out_mask & BIT(offset))\n\t\treturn -ENOTSUPP;\n\telse\n\t\treturn -EINVAL;\n}\n\nstatic int moxtet_gpio_direction_output(struct gpio_chip *gc,\n\t\t\t\t\tunsigned int offset, int val)\n{\n\tstruct moxtet_gpio_chip *chip = gpiochip_get_data(gc);\n\n\tif (chip->desc->out_mask & BIT(offset))\n\t\tmoxtet_gpio_set_value(gc, offset, val);\n\telse if (chip->desc->in_mask & BIT(offset))\n\t\treturn -ENOTSUPP;\n\telse\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int moxtet_gpio_probe(struct device *dev)\n{\n\tstruct moxtet_gpio_chip *chip;\n\tstruct device_node *nc = dev->of_node;\n\tint id;\n\n\tid = to_moxtet_device(dev)->id;\n\n\tif (id >= ARRAY_SIZE(descs)) {\n\t\tdev_err(dev, \"%pOF Moxtet device id 0x%x is not supported by gpio-moxtet driver\\n\",\n\t\t\tnc, id);\n\t\treturn -ENOTSUPP;\n\t}\n\n\tchip = devm_kzalloc(dev, sizeof(*chip), GFP_KERNEL);\n\tif (!chip)\n\t\treturn -ENOMEM;\n\n\tchip->dev = dev;\n\tchip->gpio_chip.parent = dev;\n\tchip->desc = &descs[id];\n\n\tdev_set_drvdata(dev, chip);\n\n\tchip->gpio_chip.label = dev_name(dev);\n\tchip->gpio_chip.get_direction = moxtet_gpio_get_direction;\n\tchip->gpio_chip.direction_input = moxtet_gpio_direction_input;\n\tchip->gpio_chip.direction_output = moxtet_gpio_direction_output;\n\tchip->gpio_chip.get = moxtet_gpio_get_value;\n\tchip->gpio_chip.set = moxtet_gpio_set_value;\n\tchip->gpio_chip.base = -1;\n\n\tchip->gpio_chip.ngpio = MOXTET_GPIO_NGPIOS;\n\n\tchip->gpio_chip.can_sleep = true;\n\tchip->gpio_chip.owner = THIS_MODULE;\n\n\treturn devm_gpiochip_add_data(dev, &chip->gpio_chip, chip);\n}\n\nstatic const struct of_device_id moxtet_gpio_dt_ids[] = {\n\t{ .compatible = \"cznic,moxtet-gpio\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, moxtet_gpio_dt_ids);\n\nstatic const enum turris_mox_module_id moxtet_gpio_module_table[] = {\n\tTURRIS_MOX_MODULE_SFP,\n\t0,\n};\n\nstatic struct moxtet_driver moxtet_gpio_driver = {\n\t.driver = {\n\t\t.name\t\t= \"moxtet-gpio\",\n\t\t.of_match_table\t= moxtet_gpio_dt_ids,\n\t\t.probe\t\t= moxtet_gpio_probe,\n\t},\n\t.id_table = moxtet_gpio_module_table,\n};\nmodule_moxtet_driver(moxtet_gpio_driver);\n\nMODULE_AUTHOR(\"Marek Behun <kabel@kernel.org>\");\nMODULE_DESCRIPTION(\"Turris Mox Moxtet GPIO expander\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}