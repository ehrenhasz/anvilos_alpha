{
  "module_name": "gpio-74x164.c",
  "hash_id": "129b81645f03e930ea6a410b5b28b32377cde6306771f613b53bb55c45386a13",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-74x164.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/gpio/consumer.h>\n#include <linux/gpio/driver.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/property.h>\n#include <linux/slab.h>\n#include <linux/spi/spi.h>\n\n#define GEN_74X164_NUMBER_GPIOS\t8\n\nstruct gen_74x164_chip {\n\tstruct gpio_chip\tgpio_chip;\n\tstruct mutex\t\tlock;\n\tstruct gpio_desc\t*gpiod_oe;\n\tu32\t\t\tregisters;\n\t \n\tu8\t\t\tbuffer[];\n};\n\nstatic int __gen_74x164_write_config(struct gen_74x164_chip *chip)\n{\n\treturn spi_write(to_spi_device(chip->gpio_chip.parent), chip->buffer,\n\t\t\t chip->registers);\n}\n\nstatic int gen_74x164_get_value(struct gpio_chip *gc, unsigned offset)\n{\n\tstruct gen_74x164_chip *chip = gpiochip_get_data(gc);\n\tu8 bank = chip->registers - 1 - offset / 8;\n\tu8 pin = offset % 8;\n\tint ret;\n\n\tmutex_lock(&chip->lock);\n\tret = (chip->buffer[bank] >> pin) & 0x1;\n\tmutex_unlock(&chip->lock);\n\n\treturn ret;\n}\n\nstatic void gen_74x164_set_value(struct gpio_chip *gc,\n\t\tunsigned offset, int val)\n{\n\tstruct gen_74x164_chip *chip = gpiochip_get_data(gc);\n\tu8 bank = chip->registers - 1 - offset / 8;\n\tu8 pin = offset % 8;\n\n\tmutex_lock(&chip->lock);\n\tif (val)\n\t\tchip->buffer[bank] |= (1 << pin);\n\telse\n\t\tchip->buffer[bank] &= ~(1 << pin);\n\n\t__gen_74x164_write_config(chip);\n\tmutex_unlock(&chip->lock);\n}\n\nstatic void gen_74x164_set_multiple(struct gpio_chip *gc, unsigned long *mask,\n\t\t\t\t    unsigned long *bits)\n{\n\tstruct gen_74x164_chip *chip = gpiochip_get_data(gc);\n\tunsigned long offset;\n\tunsigned long bankmask;\n\tsize_t bank;\n\tunsigned long bitmask;\n\n\tmutex_lock(&chip->lock);\n\tfor_each_set_clump8(offset, bankmask, mask, chip->registers * 8) {\n\t\tbank = chip->registers - 1 - offset / 8;\n\t\tbitmask = bitmap_get_value8(bits, offset) & bankmask;\n\n\t\tchip->buffer[bank] &= ~bankmask;\n\t\tchip->buffer[bank] |= bitmask;\n\t}\n\t__gen_74x164_write_config(chip);\n\tmutex_unlock(&chip->lock);\n}\n\nstatic int gen_74x164_direction_output(struct gpio_chip *gc,\n\t\tunsigned offset, int val)\n{\n\tgen_74x164_set_value(gc, offset, val);\n\treturn 0;\n}\n\nstatic int gen_74x164_probe(struct spi_device *spi)\n{\n\tstruct gen_74x164_chip *chip;\n\tu32 nregs;\n\tint ret;\n\n\t \n\tspi->bits_per_word = 8;\n\n\tret = spi_setup(spi);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = device_property_read_u32(&spi->dev, \"registers-number\", &nregs);\n\tif (ret) {\n\t\tdev_err(&spi->dev, \"Missing 'registers-number' property.\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tchip = devm_kzalloc(&spi->dev, sizeof(*chip) + nregs, GFP_KERNEL);\n\tif (!chip)\n\t\treturn -ENOMEM;\n\n\tchip->gpiod_oe = devm_gpiod_get_optional(&spi->dev, \"enable\",\n\t\t\t\t\t\t GPIOD_OUT_LOW);\n\tif (IS_ERR(chip->gpiod_oe))\n\t\treturn PTR_ERR(chip->gpiod_oe);\n\n\tgpiod_set_value_cansleep(chip->gpiod_oe, 1);\n\n\tspi_set_drvdata(spi, chip);\n\n\tchip->gpio_chip.label = spi->modalias;\n\tchip->gpio_chip.direction_output = gen_74x164_direction_output;\n\tchip->gpio_chip.get = gen_74x164_get_value;\n\tchip->gpio_chip.set = gen_74x164_set_value;\n\tchip->gpio_chip.set_multiple = gen_74x164_set_multiple;\n\tchip->gpio_chip.base = -1;\n\n\tchip->registers = nregs;\n\tchip->gpio_chip.ngpio = GEN_74X164_NUMBER_GPIOS * chip->registers;\n\n\tchip->gpio_chip.can_sleep = true;\n\tchip->gpio_chip.parent = &spi->dev;\n\tchip->gpio_chip.owner = THIS_MODULE;\n\n\tmutex_init(&chip->lock);\n\n\tret = __gen_74x164_write_config(chip);\n\tif (ret) {\n\t\tdev_err(&spi->dev, \"Failed writing: %d\\n\", ret);\n\t\tgoto exit_destroy;\n\t}\n\n\tret = gpiochip_add_data(&chip->gpio_chip, chip);\n\tif (!ret)\n\t\treturn 0;\n\nexit_destroy:\n\tmutex_destroy(&chip->lock);\n\n\treturn ret;\n}\n\nstatic void gen_74x164_remove(struct spi_device *spi)\n{\n\tstruct gen_74x164_chip *chip = spi_get_drvdata(spi);\n\n\tgpiod_set_value_cansleep(chip->gpiod_oe, 0);\n\tgpiochip_remove(&chip->gpio_chip);\n\tmutex_destroy(&chip->lock);\n}\n\nstatic const struct spi_device_id gen_74x164_spi_ids[] = {\n\t{ .name = \"74hc595\" },\n\t{ .name = \"74lvc594\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(spi, gen_74x164_spi_ids);\n\nstatic const struct of_device_id gen_74x164_dt_ids[] = {\n\t{ .compatible = \"fairchild,74hc595\" },\n\t{ .compatible = \"nxp,74lvc594\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, gen_74x164_dt_ids);\n\nstatic struct spi_driver gen_74x164_driver = {\n\t.driver = {\n\t\t.name\t\t= \"74x164\",\n\t\t.of_match_table\t= gen_74x164_dt_ids,\n\t},\n\t.probe\t\t= gen_74x164_probe,\n\t.remove\t\t= gen_74x164_remove,\n\t.id_table\t= gen_74x164_spi_ids,\n};\nmodule_spi_driver(gen_74x164_driver);\n\nMODULE_AUTHOR(\"Gabor Juhos <juhosg@openwrt.org>\");\nMODULE_AUTHOR(\"Miguel Gaio <miguel.gaio@efixo.com>\");\nMODULE_DESCRIPTION(\"GPIO expander driver for 74X164 8-bits shift register\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}