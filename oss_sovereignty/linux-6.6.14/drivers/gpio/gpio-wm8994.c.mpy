{
  "module_name": "gpio-wm8994.c",
  "hash_id": "ae13bc9cfd512e43dead49063c968a778e931b5b95aa4ffb9e5803ffaf012508",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-wm8994.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/gpio/driver.h>\n#include <linux/mfd/core.h>\n#include <linux/platform_device.h>\n#include <linux/seq_file.h>\n#include <linux/regmap.h>\n\n#include <linux/mfd/wm8994/core.h>\n#include <linux/mfd/wm8994/pdata.h>\n#include <linux/mfd/wm8994/gpio.h>\n#include <linux/mfd/wm8994/registers.h>\n\nstruct wm8994_gpio {\n\tstruct wm8994 *wm8994;\n\tstruct gpio_chip gpio_chip;\n};\n\nstatic int wm8994_gpio_request(struct gpio_chip *chip, unsigned offset)\n{\n\tstruct wm8994_gpio *wm8994_gpio = gpiochip_get_data(chip);\n\tstruct wm8994 *wm8994 = wm8994_gpio->wm8994;\n\n\tswitch (wm8994->type) {\n\tcase WM8958:\n\t\tswitch (offset) {\n\t\tcase 1:\n\t\tcase 2:\n\t\tcase 3:\n\t\tcase 4:\n\t\tcase 6:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int wm8994_gpio_direction_in(struct gpio_chip *chip, unsigned offset)\n{\n\tstruct wm8994_gpio *wm8994_gpio = gpiochip_get_data(chip);\n\tstruct wm8994 *wm8994 = wm8994_gpio->wm8994;\n\n\treturn wm8994_set_bits(wm8994, WM8994_GPIO_1 + offset,\n\t\t\t       WM8994_GPN_DIR, WM8994_GPN_DIR);\n}\n\nstatic int wm8994_gpio_get(struct gpio_chip *chip, unsigned offset)\n{\n\tstruct wm8994_gpio *wm8994_gpio = gpiochip_get_data(chip);\n\tstruct wm8994 *wm8994 = wm8994_gpio->wm8994;\n\tint ret;\n\n\tret = wm8994_reg_read(wm8994, WM8994_GPIO_1 + offset);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (ret & WM8994_GPN_LVL)\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\nstatic int wm8994_gpio_direction_out(struct gpio_chip *chip,\n\t\t\t\t     unsigned offset, int value)\n{\n\tstruct wm8994_gpio *wm8994_gpio = gpiochip_get_data(chip);\n\tstruct wm8994 *wm8994 = wm8994_gpio->wm8994;\n\n\tif (value)\n\t\tvalue = WM8994_GPN_LVL;\n\n\treturn wm8994_set_bits(wm8994, WM8994_GPIO_1 + offset,\n\t\t\t       WM8994_GPN_DIR | WM8994_GPN_LVL, value);\n}\n\nstatic void wm8994_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\n{\n\tstruct wm8994_gpio *wm8994_gpio = gpiochip_get_data(chip);\n\tstruct wm8994 *wm8994 = wm8994_gpio->wm8994;\n\n\tif (value)\n\t\tvalue = WM8994_GPN_LVL;\n\n\twm8994_set_bits(wm8994, WM8994_GPIO_1 + offset, WM8994_GPN_LVL, value);\n}\n\nstatic int wm8994_gpio_set_config(struct gpio_chip *chip, unsigned int offset,\n\t\t\t\t  unsigned long config)\n{\n\tstruct wm8994_gpio *wm8994_gpio = gpiochip_get_data(chip);\n\tstruct wm8994 *wm8994 = wm8994_gpio->wm8994;\n\n\tswitch (pinconf_to_config_param(config)) {\n\tcase PIN_CONFIG_DRIVE_OPEN_DRAIN:\n\t\treturn wm8994_set_bits(wm8994, WM8994_GPIO_1 + offset,\n\t\t\t\t       WM8994_GPN_OP_CFG_MASK,\n\t\t\t\t       WM8994_GPN_OP_CFG);\n\tcase PIN_CONFIG_DRIVE_PUSH_PULL:\n\t\treturn wm8994_set_bits(wm8994, WM8994_GPIO_1 + offset,\n\t\t\t\t       WM8994_GPN_OP_CFG_MASK, 0);\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -ENOTSUPP;\n}\n\nstatic int wm8994_gpio_to_irq(struct gpio_chip *chip, unsigned offset)\n{\n\tstruct wm8994_gpio *wm8994_gpio = gpiochip_get_data(chip);\n\tstruct wm8994 *wm8994 = wm8994_gpio->wm8994;\n\n\treturn regmap_irq_get_virq(wm8994->irq_data, offset);\n}\n\n\n#ifdef CONFIG_DEBUG_FS\nstatic const char *wm8994_gpio_fn(u16 fn)\n{\n\tswitch (fn) {\n\tcase WM8994_GP_FN_PIN_SPECIFIC:\n\t\treturn \"pin-specific\";\n\tcase WM8994_GP_FN_GPIO:\n\t\treturn \"GPIO\";\n\tcase WM8994_GP_FN_SDOUT:\n\t\treturn \"SDOUT\";\n\tcase WM8994_GP_FN_IRQ:\n\t\treturn \"IRQ\";\n\tcase WM8994_GP_FN_TEMPERATURE:\n\t\treturn \"Temperature\";\n\tcase WM8994_GP_FN_MICBIAS1_DET:\n\t\treturn \"MICBIAS1 detect\";\n\tcase WM8994_GP_FN_MICBIAS1_SHORT:\n\t\treturn \"MICBIAS1 short\";\n\tcase WM8994_GP_FN_MICBIAS2_DET:\n\t\treturn \"MICBIAS2 detect\";\n\tcase WM8994_GP_FN_MICBIAS2_SHORT:\n\t\treturn \"MICBIAS2 short\";\n\tcase WM8994_GP_FN_FLL1_LOCK:\n\t\treturn \"FLL1 lock\";\n\tcase WM8994_GP_FN_FLL2_LOCK:\n\t\treturn \"FLL2 lock\";\n\tcase WM8994_GP_FN_SRC1_LOCK:\n\t\treturn \"SRC1 lock\";\n\tcase WM8994_GP_FN_SRC2_LOCK:\n\t\treturn \"SRC2 lock\";\n\tcase WM8994_GP_FN_DRC1_ACT:\n\t\treturn \"DRC1 activity\";\n\tcase WM8994_GP_FN_DRC2_ACT:\n\t\treturn \"DRC2 activity\";\n\tcase WM8994_GP_FN_DRC3_ACT:\n\t\treturn \"DRC3 activity\";\n\tcase WM8994_GP_FN_WSEQ_STATUS:\n\t\treturn \"Write sequencer\";\n\tcase WM8994_GP_FN_FIFO_ERROR:\n\t\treturn \"FIFO error\";\n\tcase WM8994_GP_FN_OPCLK:\n\t\treturn \"OPCLK\";\n\tcase WM8994_GP_FN_THW:\n\t\treturn \"Thermal warning\";\n\tcase WM8994_GP_FN_DCS_DONE:\n\t\treturn \"DC servo\";\n\tcase WM8994_GP_FN_FLL1_OUT:\n\t\treturn \"FLL1 output\";\n\tcase WM8994_GP_FN_FLL2_OUT:\n\t\treturn \"FLL1 output\";\n\tdefault:\n\t\treturn \"Unknown\";\n\t}\n}\n\nstatic void wm8994_gpio_dbg_show(struct seq_file *s, struct gpio_chip *chip)\n{\n\tstruct wm8994_gpio *wm8994_gpio = gpiochip_get_data(chip);\n\tstruct wm8994 *wm8994 = wm8994_gpio->wm8994;\n\tint i;\n\n\tfor (i = 0; i < chip->ngpio; i++) {\n\t\tint gpio = i + chip->base;\n\t\tint reg;\n\t\tconst char *label;\n\n\t\t \n\t\tlabel = gpiochip_is_requested(chip, i);\n\t\tif (!label)\n\t\t\tlabel = \"Unrequested\";\n\n\t\tseq_printf(s, \" gpio-%-3d (%-20.20s) \", gpio, label);\n\n\t\treg = wm8994_reg_read(wm8994, WM8994_GPIO_1 + i);\n\t\tif (reg < 0) {\n\t\t\tdev_err(wm8994->dev,\n\t\t\t\t\"GPIO control %d read failed: %d\\n\",\n\t\t\t\tgpio, reg);\n\t\t\tseq_printf(s, \"\\n\");\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (reg & WM8994_GPN_DIR)\n\t\t\tseq_printf(s, \"in \");\n\t\telse\n\t\t\tseq_printf(s, \"out \");\n\n\t\tif (reg & WM8994_GPN_PU)\n\t\t\tseq_printf(s, \"pull up \");\n\n\t\tif (reg & WM8994_GPN_PD)\n\t\t\tseq_printf(s, \"pull down \");\n\n\t\tif (reg & WM8994_GPN_POL)\n\t\t\tseq_printf(s, \"inverted \");\n\t\telse\n\t\t\tseq_printf(s, \"noninverted \");\n\n\t\tif (reg & WM8994_GPN_OP_CFG)\n\t\t\tseq_printf(s, \"open drain \");\n\t\telse\n\t\t\tseq_printf(s, \"push-pull \");\n\n\t\tseq_printf(s, \"%s (%x)\\n\",\n\t\t\t   wm8994_gpio_fn(reg & WM8994_GPN_FN_MASK), reg);\n\t}\n}\n#else\n#define wm8994_gpio_dbg_show NULL\n#endif\n\nstatic const struct gpio_chip template_chip = {\n\t.label\t\t\t= \"wm8994\",\n\t.owner\t\t\t= THIS_MODULE,\n\t.request\t\t= wm8994_gpio_request,\n\t.direction_input\t= wm8994_gpio_direction_in,\n\t.get\t\t\t= wm8994_gpio_get,\n\t.direction_output\t= wm8994_gpio_direction_out,\n\t.set\t\t\t= wm8994_gpio_set,\n\t.set_config\t\t= wm8994_gpio_set_config,\n\t.to_irq\t\t\t= wm8994_gpio_to_irq,\n\t.dbg_show\t\t= wm8994_gpio_dbg_show,\n\t.can_sleep\t\t= true,\n};\n\nstatic int wm8994_gpio_probe(struct platform_device *pdev)\n{\n\tstruct wm8994 *wm8994 = dev_get_drvdata(pdev->dev.parent);\n\tstruct wm8994_pdata *pdata = dev_get_platdata(wm8994->dev);\n\tstruct wm8994_gpio *wm8994_gpio;\n\n\twm8994_gpio = devm_kzalloc(&pdev->dev, sizeof(*wm8994_gpio),\n\t\t\t\t   GFP_KERNEL);\n\tif (wm8994_gpio == NULL)\n\t\treturn -ENOMEM;\n\n\twm8994_gpio->wm8994 = wm8994;\n\twm8994_gpio->gpio_chip = template_chip;\n\twm8994_gpio->gpio_chip.ngpio = WM8994_GPIO_MAX;\n\twm8994_gpio->gpio_chip.parent = &pdev->dev;\n\tif (pdata && pdata->gpio_base)\n\t\twm8994_gpio->gpio_chip.base = pdata->gpio_base;\n\telse\n\t\twm8994_gpio->gpio_chip.base = -1;\n\n\treturn devm_gpiochip_add_data(&pdev->dev, &wm8994_gpio->gpio_chip, wm8994_gpio);\n}\n\nstatic struct platform_driver wm8994_gpio_driver = {\n\t.driver.name\t= \"wm8994-gpio\",\n\t.probe\t\t= wm8994_gpio_probe,\n};\n\nstatic int __init wm8994_gpio_init(void)\n{\n\treturn platform_driver_register(&wm8994_gpio_driver);\n}\nsubsys_initcall(wm8994_gpio_init);\n\nstatic void __exit wm8994_gpio_exit(void)\n{\n\tplatform_driver_unregister(&wm8994_gpio_driver);\n}\nmodule_exit(wm8994_gpio_exit);\n\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_DESCRIPTION(\"GPIO interface for WM8994\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:wm8994-gpio\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}