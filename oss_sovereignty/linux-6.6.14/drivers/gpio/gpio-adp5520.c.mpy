{
  "module_name": "gpio-adp5520.c",
  "hash_id": "24bbf627284255baee4d192bc060e2e459b65d0fd93f4afce87ae29c169e1102",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-adp5520.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/mfd/adp5520.h>\n#include <linux/gpio/driver.h>\n\nstruct adp5520_gpio {\n\tstruct device *master;\n\tstruct gpio_chip gpio_chip;\n\tunsigned char lut[ADP5520_MAXGPIOS];\n\tunsigned long output;\n};\n\nstatic int adp5520_gpio_get_value(struct gpio_chip *chip, unsigned off)\n{\n\tstruct adp5520_gpio *dev;\n\tuint8_t reg_val;\n\n\tdev = gpiochip_get_data(chip);\n\n\t \n\n\tif (test_bit(off, &dev->output))\n\t\tadp5520_read(dev->master, ADP5520_GPIO_OUT, &reg_val);\n\telse\n\t\tadp5520_read(dev->master, ADP5520_GPIO_IN, &reg_val);\n\n\treturn !!(reg_val & dev->lut[off]);\n}\n\nstatic void adp5520_gpio_set_value(struct gpio_chip *chip,\n\t\tunsigned off, int val)\n{\n\tstruct adp5520_gpio *dev;\n\tdev = gpiochip_get_data(chip);\n\n\tif (val)\n\t\tadp5520_set_bits(dev->master, ADP5520_GPIO_OUT, dev->lut[off]);\n\telse\n\t\tadp5520_clr_bits(dev->master, ADP5520_GPIO_OUT, dev->lut[off]);\n}\n\nstatic int adp5520_gpio_direction_input(struct gpio_chip *chip, unsigned off)\n{\n\tstruct adp5520_gpio *dev;\n\tdev = gpiochip_get_data(chip);\n\n\tclear_bit(off, &dev->output);\n\n\treturn adp5520_clr_bits(dev->master, ADP5520_GPIO_CFG_2,\n\t\t\t\tdev->lut[off]);\n}\n\nstatic int adp5520_gpio_direction_output(struct gpio_chip *chip,\n\t\tunsigned off, int val)\n{\n\tstruct adp5520_gpio *dev;\n\tint ret = 0;\n\tdev = gpiochip_get_data(chip);\n\n\tset_bit(off, &dev->output);\n\n\tif (val)\n\t\tret |= adp5520_set_bits(dev->master, ADP5520_GPIO_OUT,\n\t\t\t\t\tdev->lut[off]);\n\telse\n\t\tret |= adp5520_clr_bits(dev->master, ADP5520_GPIO_OUT,\n\t\t\t\t\tdev->lut[off]);\n\n\tret |= adp5520_set_bits(dev->master, ADP5520_GPIO_CFG_2,\n\t\t\t\t\tdev->lut[off]);\n\n\treturn ret;\n}\n\nstatic int adp5520_gpio_probe(struct platform_device *pdev)\n{\n\tstruct adp5520_gpio_platform_data *pdata = dev_get_platdata(&pdev->dev);\n\tstruct adp5520_gpio *dev;\n\tstruct gpio_chip *gc;\n\tint ret, i, gpios;\n\tunsigned char ctl_mask = 0;\n\n\tif (pdata == NULL) {\n\t\tdev_err(&pdev->dev, \"missing platform data\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (pdev->id != ID_ADP5520) {\n\t\tdev_err(&pdev->dev, \"only ADP5520 supports GPIO\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tdev = devm_kzalloc(&pdev->dev, sizeof(*dev), GFP_KERNEL);\n\tif (dev == NULL)\n\t\treturn -ENOMEM;\n\n\tdev->master = pdev->dev.parent;\n\n\tfor (gpios = 0, i = 0; i < ADP5520_MAXGPIOS; i++)\n\t\tif (pdata->gpio_en_mask & (1 << i))\n\t\t\tdev->lut[gpios++] = 1 << i;\n\n\tif (gpios < 1)\n\t\treturn -EINVAL;\n\n\tgc = &dev->gpio_chip;\n\tgc->direction_input  = adp5520_gpio_direction_input;\n\tgc->direction_output = adp5520_gpio_direction_output;\n\tgc->get = adp5520_gpio_get_value;\n\tgc->set = adp5520_gpio_set_value;\n\tgc->can_sleep = true;\n\n\tgc->base = pdata->gpio_start;\n\tgc->ngpio = gpios;\n\tgc->label = pdev->name;\n\tgc->owner = THIS_MODULE;\n\n\tret = adp5520_clr_bits(dev->master, ADP5520_GPIO_CFG_1,\n\t\tpdata->gpio_en_mask);\n\n\tif (pdata->gpio_en_mask & ADP5520_GPIO_C3)\n\t\tctl_mask |= ADP5520_C3_MODE;\n\n\tif (pdata->gpio_en_mask & ADP5520_GPIO_R3)\n\t\tctl_mask |= ADP5520_R3_MODE;\n\n\tif (ctl_mask)\n\t\tret = adp5520_set_bits(dev->master, ADP5520_LED_CONTROL,\n\t\t\tctl_mask);\n\n\tret |= adp5520_set_bits(dev->master, ADP5520_GPIO_PULLUP,\n\t\tpdata->gpio_pullup_mask);\n\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to write\\n\");\n\t\treturn ret;\n\t}\n\n\treturn devm_gpiochip_add_data(&pdev->dev, &dev->gpio_chip, dev);\n}\n\nstatic struct platform_driver adp5520_gpio_driver = {\n\t.driver\t= {\n\t\t.name\t= \"adp5520-gpio\",\n\t},\n\t.probe\t\t= adp5520_gpio_probe,\n};\n\nmodule_platform_driver(adp5520_gpio_driver);\n\nMODULE_AUTHOR(\"Michael Hennerich <michael.hennerich@analog.com>\");\nMODULE_DESCRIPTION(\"GPIO ADP5520 Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:adp5520-gpio\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}