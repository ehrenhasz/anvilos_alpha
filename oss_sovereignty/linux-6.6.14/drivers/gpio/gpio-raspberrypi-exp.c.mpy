{
  "module_name": "gpio-raspberrypi-exp.c",
  "hash_id": "85a76532119bd63ee4308cd91a31b312ff414ae1e14890b84de35eb10c49a03a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-raspberrypi-exp.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/gpio/driver.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <soc/bcm2835/raspberrypi-firmware.h>\n\n#define MODULE_NAME \"raspberrypi-exp-gpio\"\n#define NUM_GPIO 8\n\n#define RPI_EXP_GPIO_BASE\t128\n\n#define RPI_EXP_GPIO_DIR_IN\t0\n#define RPI_EXP_GPIO_DIR_OUT\t1\n\nstruct rpi_exp_gpio {\n\tstruct gpio_chip gc;\n\tstruct rpi_firmware *fw;\n};\n\n \n\nstruct gpio_set_config {\n\tu32 gpio;\n\tu32 direction;\n\tu32 polarity;\n\tu32 term_en;\n\tu32 term_pull_up;\n\tu32 state;\n};\n\nstruct gpio_get_config {\n\tu32 gpio;\n\tu32 direction;\n\tu32 polarity;\n\tu32 term_en;\n\tu32 term_pull_up;\n};\n\nstruct gpio_get_set_state {\n\tu32 gpio;\n\tu32 state;\n};\n\nstatic int rpi_exp_gpio_get_polarity(struct gpio_chip *gc, unsigned int off)\n{\n\tstruct rpi_exp_gpio *gpio;\n\tstruct gpio_get_config get;\n\tint ret;\n\n\tgpio = gpiochip_get_data(gc);\n\n\tget.gpio = off + RPI_EXP_GPIO_BASE;\t \n\n\tret = rpi_firmware_property(gpio->fw, RPI_FIRMWARE_GET_GPIO_CONFIG,\n\t\t\t\t    &get, sizeof(get));\n\tif (ret || get.gpio != 0) {\n\t\tdev_err(gc->parent, \"Failed to get GPIO %u config (%d %x)\\n\",\n\t\t\toff, ret, get.gpio);\n\t\treturn ret ? ret : -EIO;\n\t}\n\treturn get.polarity;\n}\n\nstatic int rpi_exp_gpio_dir_in(struct gpio_chip *gc, unsigned int off)\n{\n\tstruct rpi_exp_gpio *gpio;\n\tstruct gpio_set_config set_in;\n\tint ret;\n\n\tgpio = gpiochip_get_data(gc);\n\n\tset_in.gpio = off + RPI_EXP_GPIO_BASE;\t \n\tset_in.direction = RPI_EXP_GPIO_DIR_IN;\n\tset_in.term_en = 0;\t\t \n\tset_in.term_pull_up = 0;\t \n\tset_in.state = 0;\t\t \n\n\tret = rpi_exp_gpio_get_polarity(gc, off);\n\tif (ret < 0)\n\t\treturn ret;\n\tset_in.polarity = ret;\t\t \n\n\tret = rpi_firmware_property(gpio->fw, RPI_FIRMWARE_SET_GPIO_CONFIG,\n\t\t\t\t    &set_in, sizeof(set_in));\n\tif (ret || set_in.gpio != 0) {\n\t\tdev_err(gc->parent, \"Failed to set GPIO %u to input (%d %x)\\n\",\n\t\t\toff, ret, set_in.gpio);\n\t\treturn ret ? ret : -EIO;\n\t}\n\treturn 0;\n}\n\nstatic int rpi_exp_gpio_dir_out(struct gpio_chip *gc, unsigned int off, int val)\n{\n\tstruct rpi_exp_gpio *gpio;\n\tstruct gpio_set_config set_out;\n\tint ret;\n\n\tgpio = gpiochip_get_data(gc);\n\n\tset_out.gpio = off + RPI_EXP_GPIO_BASE;\t \n\tset_out.direction = RPI_EXP_GPIO_DIR_OUT;\n\tset_out.term_en = 0;\t\t \n\tset_out.term_pull_up = 0;\t \n\tset_out.state = val;\t\t \n\n\tret = rpi_exp_gpio_get_polarity(gc, off);\n\tif (ret < 0)\n\t\treturn ret;\n\tset_out.polarity = ret;\t\t \n\n\tret = rpi_firmware_property(gpio->fw, RPI_FIRMWARE_SET_GPIO_CONFIG,\n\t\t\t\t    &set_out, sizeof(set_out));\n\tif (ret || set_out.gpio != 0) {\n\t\tdev_err(gc->parent, \"Failed to set GPIO %u to output (%d %x)\\n\",\n\t\t\toff, ret, set_out.gpio);\n\t\treturn ret ? ret : -EIO;\n\t}\n\treturn 0;\n}\n\nstatic int rpi_exp_gpio_get_direction(struct gpio_chip *gc, unsigned int off)\n{\n\tstruct rpi_exp_gpio *gpio;\n\tstruct gpio_get_config get;\n\tint ret;\n\n\tgpio = gpiochip_get_data(gc);\n\n\tget.gpio = off + RPI_EXP_GPIO_BASE;\t \n\n\tret = rpi_firmware_property(gpio->fw, RPI_FIRMWARE_GET_GPIO_CONFIG,\n\t\t\t\t    &get, sizeof(get));\n\tif (ret || get.gpio != 0) {\n\t\tdev_err(gc->parent,\n\t\t\t\"Failed to get GPIO %u config (%d %x)\\n\", off, ret,\n\t\t\tget.gpio);\n\t\treturn ret ? ret : -EIO;\n\t}\n\tif (get.direction)\n\t\treturn GPIO_LINE_DIRECTION_OUT;\n\n\treturn GPIO_LINE_DIRECTION_IN;\n}\n\nstatic int rpi_exp_gpio_get(struct gpio_chip *gc, unsigned int off)\n{\n\tstruct rpi_exp_gpio *gpio;\n\tstruct gpio_get_set_state get;\n\tint ret;\n\n\tgpio = gpiochip_get_data(gc);\n\n\tget.gpio = off + RPI_EXP_GPIO_BASE;\t \n\tget.state = 0;\t\t \n\n\tret = rpi_firmware_property(gpio->fw, RPI_FIRMWARE_GET_GPIO_STATE,\n\t\t\t\t\t &get, sizeof(get));\n\tif (ret || get.gpio != 0) {\n\t\tdev_err(gc->parent,\n\t\t\t\"Failed to get GPIO %u state (%d %x)\\n\", off, ret,\n\t\t\tget.gpio);\n\t\treturn ret ? ret : -EIO;\n\t}\n\treturn !!get.state;\n}\n\nstatic void rpi_exp_gpio_set(struct gpio_chip *gc, unsigned int off, int val)\n{\n\tstruct rpi_exp_gpio *gpio;\n\tstruct gpio_get_set_state set;\n\tint ret;\n\n\tgpio = gpiochip_get_data(gc);\n\n\tset.gpio = off + RPI_EXP_GPIO_BASE;\t \n\tset.state = val;\t \n\n\tret = rpi_firmware_property(gpio->fw, RPI_FIRMWARE_SET_GPIO_STATE,\n\t\t\t\t\t &set, sizeof(set));\n\tif (ret || set.gpio != 0)\n\t\tdev_err(gc->parent,\n\t\t\t\"Failed to set GPIO %u state (%d %x)\\n\", off, ret,\n\t\t\tset.gpio);\n}\n\nstatic int rpi_exp_gpio_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *np = dev->of_node;\n\tstruct device_node *fw_node;\n\tstruct rpi_firmware *fw;\n\tstruct rpi_exp_gpio *rpi_gpio;\n\n\tfw_node = of_get_parent(np);\n\tif (!fw_node) {\n\t\tdev_err(dev, \"Missing firmware node\\n\");\n\t\treturn -ENOENT;\n\t}\n\n\tfw = devm_rpi_firmware_get(&pdev->dev, fw_node);\n\tof_node_put(fw_node);\n\tif (!fw)\n\t\treturn -EPROBE_DEFER;\n\n\trpi_gpio = devm_kzalloc(dev, sizeof(*rpi_gpio), GFP_KERNEL);\n\tif (!rpi_gpio)\n\t\treturn -ENOMEM;\n\n\trpi_gpio->fw = fw;\n\trpi_gpio->gc.parent = dev;\n\trpi_gpio->gc.label = MODULE_NAME;\n\trpi_gpio->gc.owner = THIS_MODULE;\n\trpi_gpio->gc.base = -1;\n\trpi_gpio->gc.ngpio = NUM_GPIO;\n\n\trpi_gpio->gc.direction_input = rpi_exp_gpio_dir_in;\n\trpi_gpio->gc.direction_output = rpi_exp_gpio_dir_out;\n\trpi_gpio->gc.get_direction = rpi_exp_gpio_get_direction;\n\trpi_gpio->gc.get = rpi_exp_gpio_get;\n\trpi_gpio->gc.set = rpi_exp_gpio_set;\n\trpi_gpio->gc.can_sleep = true;\n\n\treturn devm_gpiochip_add_data(dev, &rpi_gpio->gc, rpi_gpio);\n}\n\nstatic const struct of_device_id rpi_exp_gpio_ids[] = {\n\t{ .compatible = \"raspberrypi,firmware-gpio\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, rpi_exp_gpio_ids);\n\nstatic struct platform_driver rpi_exp_gpio_driver = {\n\t.driver\t= {\n\t\t.name\t\t= MODULE_NAME,\n\t\t.of_match_table\t= rpi_exp_gpio_ids,\n\t},\n\t.probe\t= rpi_exp_gpio_probe,\n};\nmodule_platform_driver(rpi_exp_gpio_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Dave Stevenson <dave.stevenson@raspberrypi.org>\");\nMODULE_DESCRIPTION(\"Raspberry Pi 3 expander GPIO driver\");\nMODULE_ALIAS(\"platform:rpi-exp-gpio\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}