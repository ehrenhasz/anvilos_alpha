{
  "module_name": "gpio-max3191x.c",
  "hash_id": "86358404c403915453f51b1705013d88a3539e88f9975bb11a02ff2f13356dd2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-max3191x.c",
  "human_readable_source": "\n \n\n#include <linux/bitmap.h>\n#include <linux/bitops.h>\n#include <linux/crc8.h>\n#include <linux/gpio/consumer.h>\n#include <linux/gpio/driver.h>\n#include <linux/module.h>\n#include <linux/spi/spi.h>\n\nenum max3191x_mode {\n\tSTATUS_BYTE_ENABLED,\n\tSTATUS_BYTE_DISABLED,\n};\n\n \nstruct max3191x_chip {\n\tstruct gpio_chip gpio;\n\tstruct mutex lock;\n\tu32 nchips;\n\tenum max3191x_mode mode;\n\tstruct gpio_descs *modesel_pins;\n\tstruct gpio_descs *fault_pins;\n\tstruct gpio_descs *db0_pins;\n\tstruct gpio_descs *db1_pins;\n\tstruct spi_message mesg;\n\tstruct spi_transfer xfer;\n\tunsigned long *crc_error;\n\tunsigned long *overtemp;\n\tunsigned long *undervolt1;\n\tunsigned long *undervolt2;\n\tunsigned long *fault;\n\tbool ignore_uv;\n};\n\n#define MAX3191X_NGPIO 8\n#define MAX3191X_CRC8_POLYNOMIAL 0xa8  \n\nDECLARE_CRC8_TABLE(max3191x_crc8);\n\nstatic int max3191x_get_direction(struct gpio_chip *gpio, unsigned int offset)\n{\n\treturn GPIO_LINE_DIRECTION_IN;  \n}\n\nstatic int max3191x_direction_input(struct gpio_chip *gpio, unsigned int offset)\n{\n\treturn 0;\n}\n\nstatic int max3191x_direction_output(struct gpio_chip *gpio,\n\t\t\t\t     unsigned int offset, int value)\n{\n\treturn -EINVAL;\n}\n\nstatic void max3191x_set(struct gpio_chip *gpio, unsigned int offset, int value)\n{ }\n\nstatic void max3191x_set_multiple(struct gpio_chip *gpio, unsigned long *mask,\n\t\t\t\t  unsigned long *bits)\n{ }\n\nstatic unsigned int max3191x_wordlen(struct max3191x_chip *max3191x)\n{\n\treturn max3191x->mode == STATUS_BYTE_ENABLED ? 2 : 1;\n}\n\nstatic int max3191x_readout_locked(struct max3191x_chip *max3191x)\n{\n\tstruct device *dev = max3191x->gpio.parent;\n\tstruct spi_device *spi = to_spi_device(dev);\n\tint val, i, ot = 0, uv1 = 0;\n\n\tval = spi_sync(spi, &max3191x->mesg);\n\tif (val) {\n\t\tdev_err_ratelimited(dev, \"SPI receive error %d\\n\", val);\n\t\treturn val;\n\t}\n\n\tfor (i = 0; i < max3191x->nchips; i++) {\n\t\tif (max3191x->mode == STATUS_BYTE_ENABLED) {\n\t\t\tu8 in\t  = ((u8 *)max3191x->xfer.rx_buf)[i * 2];\n\t\t\tu8 status = ((u8 *)max3191x->xfer.rx_buf)[i * 2 + 1];\n\n\t\t\tval = (status & 0xf8) != crc8(max3191x_crc8, &in, 1, 0);\n\t\t\t__assign_bit(i, max3191x->crc_error, val);\n\t\t\tif (val)\n\t\t\t\tdev_err_ratelimited(dev,\n\t\t\t\t\t\"chip %d: CRC error\\n\", i);\n\n\t\t\tot  = (status >> 1) & 1;\n\t\t\t__assign_bit(i, max3191x->overtemp, ot);\n\t\t\tif (ot)\n\t\t\t\tdev_err_ratelimited(dev,\n\t\t\t\t\t\"chip %d: overtemperature\\n\", i);\n\n\t\t\tif (!max3191x->ignore_uv) {\n\t\t\t\tuv1 = !((status >> 2) & 1);\n\t\t\t\t__assign_bit(i, max3191x->undervolt1, uv1);\n\t\t\t\tif (uv1)\n\t\t\t\t\tdev_err_ratelimited(dev,\n\t\t\t\t\t\t\"chip %d: undervoltage\\n\", i);\n\n\t\t\t\tval = !(status & 1);\n\t\t\t\t__assign_bit(i, max3191x->undervolt2, val);\n\t\t\t\tif (val && !uv1)\n\t\t\t\t\tdev_warn_ratelimited(dev,\n\t\t\t\t\t\t\"chip %d: voltage warn\\n\", i);\n\t\t\t}\n\t\t}\n\n\t\tif (max3191x->fault_pins && !max3191x->ignore_uv) {\n\t\t\t \n\t\t\tstruct gpio_desc *fault_pin =\n\t\t\t\t(max3191x->fault_pins->ndescs == 1)\n\t\t\t\t\t? max3191x->fault_pins->desc[0]\n\t\t\t\t\t: max3191x->fault_pins->desc[i];\n\n\t\t\tval = gpiod_get_value_cansleep(fault_pin);\n\t\t\tif (val < 0) {\n\t\t\t\tdev_err_ratelimited(dev,\n\t\t\t\t\t\"GPIO read error %d\\n\", val);\n\t\t\t\treturn val;\n\t\t\t}\n\t\t\t__assign_bit(i, max3191x->fault, val);\n\t\t\tif (val && !uv1 && !ot)\n\t\t\t\tdev_err_ratelimited(dev,\n\t\t\t\t\t\"chip %d: fault\\n\", i);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic bool max3191x_chip_is_faulting(struct max3191x_chip *max3191x,\n\t\t\t\t      unsigned int chipnum)\n{\n\t \n\tif (!max3191x->ignore_uv && test_bit(chipnum, max3191x->fault))\n\t\treturn true;\n\n\tif (max3191x->mode == STATUS_BYTE_DISABLED)\n\t\treturn false;\n\n\treturn test_bit(chipnum, max3191x->crc_error) ||\n\t       test_bit(chipnum, max3191x->overtemp)  ||\n\t       (!max3191x->ignore_uv &&\n\t\ttest_bit(chipnum, max3191x->undervolt1));\n}\n\nstatic int max3191x_get(struct gpio_chip *gpio, unsigned int offset)\n{\n\tstruct max3191x_chip *max3191x = gpiochip_get_data(gpio);\n\tint ret, chipnum, wordlen = max3191x_wordlen(max3191x);\n\tu8 in;\n\n\tmutex_lock(&max3191x->lock);\n\tret = max3191x_readout_locked(max3191x);\n\tif (ret)\n\t\tgoto out_unlock;\n\n\tchipnum = offset / MAX3191X_NGPIO;\n\tif (max3191x_chip_is_faulting(max3191x, chipnum)) {\n\t\tret = -EIO;\n\t\tgoto out_unlock;\n\t}\n\n\tin = ((u8 *)max3191x->xfer.rx_buf)[chipnum * wordlen];\n\tret = (in >> (offset % MAX3191X_NGPIO)) & 1;\n\nout_unlock:\n\tmutex_unlock(&max3191x->lock);\n\treturn ret;\n}\n\nstatic int max3191x_get_multiple(struct gpio_chip *gpio, unsigned long *mask,\n\t\t\t\t unsigned long *bits)\n{\n\tstruct max3191x_chip *max3191x = gpiochip_get_data(gpio);\n\tconst unsigned int wordlen = max3191x_wordlen(max3191x);\n\tint ret;\n\tunsigned long bit;\n\tunsigned long gpio_mask;\n\tunsigned long in;\n\n\tmutex_lock(&max3191x->lock);\n\tret = max3191x_readout_locked(max3191x);\n\tif (ret)\n\t\tgoto out_unlock;\n\n\tbitmap_zero(bits, gpio->ngpio);\n\tfor_each_set_clump8(bit, gpio_mask, mask, gpio->ngpio) {\n\t\tunsigned int chipnum = bit / MAX3191X_NGPIO;\n\n\t\tif (max3191x_chip_is_faulting(max3191x, chipnum)) {\n\t\t\tret = -EIO;\n\t\t\tgoto out_unlock;\n\t\t}\n\n\t\tin = ((u8 *)max3191x->xfer.rx_buf)[chipnum * wordlen];\n\t\tin &= gpio_mask;\n\t\tbitmap_set_value8(bits, in, bit);\n\t}\n\nout_unlock:\n\tmutex_unlock(&max3191x->lock);\n\treturn ret;\n}\n\nstatic int max3191x_set_config(struct gpio_chip *gpio, unsigned int offset,\n\t\t\t       unsigned long config)\n{\n\tstruct max3191x_chip *max3191x = gpiochip_get_data(gpio);\n\tu32 debounce, chipnum, db0_val, db1_val;\n\n\tif (pinconf_to_config_param(config) != PIN_CONFIG_INPUT_DEBOUNCE)\n\t\treturn -ENOTSUPP;\n\n\tif (!max3191x->db0_pins || !max3191x->db1_pins)\n\t\treturn -EINVAL;\n\n\tdebounce = pinconf_to_config_argument(config);\n\tswitch (debounce) {\n\tcase 0:\n\t\tdb0_val = 0;\n\t\tdb1_val = 0;\n\t\tbreak;\n\tcase 1 ... 25:\n\t\tdb0_val = 0;\n\t\tdb1_val = 1;\n\t\tbreak;\n\tcase 26 ... 750:\n\t\tdb0_val = 1;\n\t\tdb1_val = 0;\n\t\tbreak;\n\tcase 751 ... 3000:\n\t\tdb0_val = 1;\n\t\tdb1_val = 1;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (max3191x->db0_pins->ndescs == 1)\n\t\tchipnum = 0;  \n\telse\n\t\tchipnum = offset / MAX3191X_NGPIO;  \n\n\tmutex_lock(&max3191x->lock);\n\tgpiod_set_value_cansleep(max3191x->db0_pins->desc[chipnum], db0_val);\n\tgpiod_set_value_cansleep(max3191x->db1_pins->desc[chipnum], db1_val);\n\tmutex_unlock(&max3191x->lock);\n\treturn 0;\n}\n\nstatic void gpiod_set_array_single_value_cansleep(unsigned int ndescs,\n\t\t\t\t\t\t  struct gpio_desc **desc,\n\t\t\t\t\t\t  struct gpio_array *info,\n\t\t\t\t\t\t  int value)\n{\n\tunsigned long *values;\n\n\tvalues = bitmap_alloc(ndescs, GFP_KERNEL);\n\tif (!values)\n\t\treturn;\n\n\tif (value)\n\t\tbitmap_fill(values, ndescs);\n\telse\n\t\tbitmap_zero(values, ndescs);\n\n\tgpiod_set_array_value_cansleep(ndescs, desc, info, values);\n\tbitmap_free(values);\n}\n\nstatic struct gpio_descs *devm_gpiod_get_array_optional_count(\n\t\t\t\tstruct device *dev, const char *con_id,\n\t\t\t\tenum gpiod_flags flags, unsigned int expected)\n{\n\tstruct gpio_descs *descs;\n\tint found = gpiod_count(dev, con_id);\n\n\tif (found == -ENOENT)\n\t\treturn NULL;\n\n\tif (found != expected && found != 1) {\n\t\tdev_err(dev, \"ignoring %s-gpios: found %d, expected %u or 1\\n\",\n\t\t\tcon_id, found, expected);\n\t\treturn NULL;\n\t}\n\n\tdescs = devm_gpiod_get_array_optional(dev, con_id, flags);\n\n\tif (IS_ERR(descs)) {\n\t\tdev_err(dev, \"failed to get %s-gpios: %ld\\n\",\n\t\t\tcon_id, PTR_ERR(descs));\n\t\treturn NULL;\n\t}\n\n\treturn descs;\n}\n\nstatic int max3191x_probe(struct spi_device *spi)\n{\n\tstruct device *dev = &spi->dev;\n\tstruct max3191x_chip *max3191x;\n\tint n, ret;\n\n\tmax3191x = devm_kzalloc(dev, sizeof(*max3191x), GFP_KERNEL);\n\tif (!max3191x)\n\t\treturn -ENOMEM;\n\tspi_set_drvdata(spi, max3191x);\n\n\tmax3191x->nchips = 1;\n\tdevice_property_read_u32(dev, \"#daisy-chained-devices\",\n\t\t\t\t &max3191x->nchips);\n\n\tn = BITS_TO_LONGS(max3191x->nchips);\n\tmax3191x->crc_error   = devm_kcalloc(dev, n, sizeof(long), GFP_KERNEL);\n\tmax3191x->undervolt1  = devm_kcalloc(dev, n, sizeof(long), GFP_KERNEL);\n\tmax3191x->undervolt2  = devm_kcalloc(dev, n, sizeof(long), GFP_KERNEL);\n\tmax3191x->overtemp    = devm_kcalloc(dev, n, sizeof(long), GFP_KERNEL);\n\tmax3191x->fault       = devm_kcalloc(dev, n, sizeof(long), GFP_KERNEL);\n\tmax3191x->xfer.rx_buf = devm_kcalloc(dev, max3191x->nchips,\n\t\t\t\t\t\t\t\t2, GFP_KERNEL);\n\tif (!max3191x->crc_error || !max3191x->undervolt1 ||\n\t    !max3191x->overtemp  || !max3191x->undervolt2 ||\n\t    !max3191x->fault     || !max3191x->xfer.rx_buf)\n\t\treturn -ENOMEM;\n\n\tmax3191x->modesel_pins = devm_gpiod_get_array_optional_count(dev,\n\t\t\t\t \"maxim,modesel\", GPIOD_ASIS, max3191x->nchips);\n\tmax3191x->fault_pins   = devm_gpiod_get_array_optional_count(dev,\n\t\t\t\t \"maxim,fault\", GPIOD_IN, max3191x->nchips);\n\tmax3191x->db0_pins     = devm_gpiod_get_array_optional_count(dev,\n\t\t\t\t \"maxim,db0\", GPIOD_OUT_LOW, max3191x->nchips);\n\tmax3191x->db1_pins     = devm_gpiod_get_array_optional_count(dev,\n\t\t\t\t \"maxim,db1\", GPIOD_OUT_LOW, max3191x->nchips);\n\n\tmax3191x->mode = device_property_read_bool(dev, \"maxim,modesel-8bit\")\n\t\t\t\t ? STATUS_BYTE_DISABLED : STATUS_BYTE_ENABLED;\n\tif (max3191x->modesel_pins)\n\t\tgpiod_set_array_single_value_cansleep(\n\t\t\t\t max3191x->modesel_pins->ndescs,\n\t\t\t\t max3191x->modesel_pins->desc,\n\t\t\t\t max3191x->modesel_pins->info, max3191x->mode);\n\n\tmax3191x->ignore_uv = device_property_read_bool(dev,\n\t\t\t\t\t\t  \"maxim,ignore-undervoltage\");\n\n\tif (max3191x->db0_pins && max3191x->db1_pins &&\n\t    max3191x->db0_pins->ndescs != max3191x->db1_pins->ndescs) {\n\t\tdev_err(dev, \"ignoring maxim,db*-gpios: array len mismatch\\n\");\n\t\tdevm_gpiod_put_array(dev, max3191x->db0_pins);\n\t\tdevm_gpiod_put_array(dev, max3191x->db1_pins);\n\t\tmax3191x->db0_pins = NULL;\n\t\tmax3191x->db1_pins = NULL;\n\t}\n\n\tmax3191x->xfer.len = max3191x->nchips * max3191x_wordlen(max3191x);\n\tspi_message_init_with_transfers(&max3191x->mesg, &max3191x->xfer, 1);\n\n\tmax3191x->gpio.label = spi->modalias;\n\tmax3191x->gpio.owner = THIS_MODULE;\n\tmax3191x->gpio.parent = dev;\n\tmax3191x->gpio.base = -1;\n\tmax3191x->gpio.ngpio = max3191x->nchips * MAX3191X_NGPIO;\n\tmax3191x->gpio.can_sleep = true;\n\n\tmax3191x->gpio.get_direction = max3191x_get_direction;\n\tmax3191x->gpio.direction_input = max3191x_direction_input;\n\tmax3191x->gpio.direction_output = max3191x_direction_output;\n\tmax3191x->gpio.set = max3191x_set;\n\tmax3191x->gpio.set_multiple = max3191x_set_multiple;\n\tmax3191x->gpio.get = max3191x_get;\n\tmax3191x->gpio.get_multiple = max3191x_get_multiple;\n\tmax3191x->gpio.set_config = max3191x_set_config;\n\n\tmutex_init(&max3191x->lock);\n\n\tret = gpiochip_add_data(&max3191x->gpio, max3191x);\n\tif (ret) {\n\t\tmutex_destroy(&max3191x->lock);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic void max3191x_remove(struct spi_device *spi)\n{\n\tstruct max3191x_chip *max3191x = spi_get_drvdata(spi);\n\n\tgpiochip_remove(&max3191x->gpio);\n\tmutex_destroy(&max3191x->lock);\n}\n\nstatic int __init max3191x_register_driver(struct spi_driver *sdrv)\n{\n\tcrc8_populate_msb(max3191x_crc8, MAX3191X_CRC8_POLYNOMIAL);\n\treturn spi_register_driver(sdrv);\n}\n\nstatic const struct of_device_id max3191x_of_id[] = {\n\t{ .compatible = \"maxim,max31910\" },\n\t{ .compatible = \"maxim,max31911\" },\n\t{ .compatible = \"maxim,max31912\" },\n\t{ .compatible = \"maxim,max31913\" },\n\t{ .compatible = \"maxim,max31953\" },\n\t{ .compatible = \"maxim,max31963\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max3191x_of_id);\n\nstatic const struct spi_device_id max3191x_spi_id[] = {\n\t{ \"max31910\" },\n\t{ \"max31911\" },\n\t{ \"max31912\" },\n\t{ \"max31913\" },\n\t{ \"max31953\" },\n\t{ \"max31963\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(spi, max3191x_spi_id);\n\nstatic struct spi_driver max3191x_driver = {\n\t.driver = {\n\t\t.name\t\t= \"max3191x\",\n\t\t.of_match_table\t= max3191x_of_id,\n\t},\n\t.probe\t  = max3191x_probe,\n\t.remove\t  = max3191x_remove,\n\t.id_table = max3191x_spi_id,\n};\nmodule_driver(max3191x_driver, max3191x_register_driver, spi_unregister_driver);\n\nMODULE_AUTHOR(\"Lukas Wunner <lukas@wunner.de>\");\nMODULE_DESCRIPTION(\"GPIO driver for Maxim MAX3191x industrial serializer\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}