{
  "module_name": "gpio-loongson.c",
  "hash_id": "f05d6549b5e6761eee5ee3f87d34997231a4796b4ede7e28998ba719e9145ef0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-loongson.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/spinlock.h>\n#include <linux/err.h>\n#include <linux/gpio/driver.h>\n#include <linux/platform_device.h>\n#include <linux/bitops.h>\n#include <asm/types.h>\n#include <loongson.h>\n\n#define STLS2F_N_GPIO\t\t4\n#define STLS3A_N_GPIO\t\t16\n\n#ifdef CONFIG_CPU_LOONGSON64\n#define LOONGSON_N_GPIO\tSTLS3A_N_GPIO\n#else\n#define LOONGSON_N_GPIO\tSTLS2F_N_GPIO\n#endif\n\n \n#define LOONGSON_GPIO_IN_OFFSET\t16\n\nstatic DEFINE_SPINLOCK(gpio_lock);\n\nstatic int loongson_gpio_get_value(struct gpio_chip *chip, unsigned gpio)\n{\n\tu32 val;\n\n\tspin_lock(&gpio_lock);\n\tval = LOONGSON_GPIODATA;\n\tspin_unlock(&gpio_lock);\n\n\treturn !!(val & BIT(gpio + LOONGSON_GPIO_IN_OFFSET));\n}\n\nstatic void loongson_gpio_set_value(struct gpio_chip *chip,\n\t\tunsigned gpio, int value)\n{\n\tu32 val;\n\n\tspin_lock(&gpio_lock);\n\tval = LOONGSON_GPIODATA;\n\tif (value)\n\t\tval |= BIT(gpio);\n\telse\n\t\tval &= ~BIT(gpio);\n\tLOONGSON_GPIODATA = val;\n\tspin_unlock(&gpio_lock);\n}\n\nstatic int loongson_gpio_direction_input(struct gpio_chip *chip, unsigned gpio)\n{\n\tu32 temp;\n\n\tspin_lock(&gpio_lock);\n\ttemp = LOONGSON_GPIOIE;\n\ttemp |= BIT(gpio);\n\tLOONGSON_GPIOIE = temp;\n\tspin_unlock(&gpio_lock);\n\n\treturn 0;\n}\n\nstatic int loongson_gpio_direction_output(struct gpio_chip *chip,\n\t\tunsigned gpio, int level)\n{\n\tu32 temp;\n\n\tloongson_gpio_set_value(chip, gpio, level);\n\tspin_lock(&gpio_lock);\n\ttemp = LOONGSON_GPIOIE;\n\ttemp &= ~BIT(gpio);\n\tLOONGSON_GPIOIE = temp;\n\tspin_unlock(&gpio_lock);\n\n\treturn 0;\n}\n\nstatic int loongson_gpio_probe(struct platform_device *pdev)\n{\n\tstruct gpio_chip *gc;\n\tstruct device *dev = &pdev->dev;\n\n\tgc = devm_kzalloc(dev, sizeof(*gc), GFP_KERNEL);\n\tif (!gc)\n\t\treturn -ENOMEM;\n\n\tgc->label = \"loongson-gpio-chip\";\n\tgc->base = 0;\n\tgc->ngpio = LOONGSON_N_GPIO;\n\tgc->get = loongson_gpio_get_value;\n\tgc->set = loongson_gpio_set_value;\n\tgc->direction_input = loongson_gpio_direction_input;\n\tgc->direction_output = loongson_gpio_direction_output;\n\n\treturn gpiochip_add_data(gc, NULL);\n}\n\nstatic struct platform_driver loongson_gpio_driver = {\n\t.driver = {\n\t\t.name = \"loongson-gpio\",\n\t},\n\t.probe = loongson_gpio_probe,\n};\n\nstatic int __init loongson_gpio_setup(void)\n{\n\tstruct platform_device *pdev;\n\tint ret;\n\n\tret = platform_driver_register(&loongson_gpio_driver);\n\tif (ret) {\n\t\tpr_err(\"error registering loongson GPIO driver\\n\");\n\t\treturn ret;\n\t}\n\n\tpdev = platform_device_register_simple(\"loongson-gpio\", -1, NULL, 0);\n\treturn PTR_ERR_OR_ZERO(pdev);\n}\npostcore_initcall(loongson_gpio_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}