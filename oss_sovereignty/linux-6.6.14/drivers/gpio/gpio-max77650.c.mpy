{
  "module_name": "gpio-max77650.c",
  "hash_id": "84df71c751b12663419c10237e4ed0f0b19aec28f21edde7892a9ba4040d02fa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-max77650.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/gpio/driver.h>\n#include <linux/i2c.h>\n#include <linux/mfd/max77650.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define MAX77650_GPIO_DIR_MASK\t\tBIT(0)\n#define MAX77650_GPIO_INVAL_MASK\tBIT(1)\n#define MAX77650_GPIO_DRV_MASK\t\tBIT(2)\n#define MAX77650_GPIO_OUTVAL_MASK\tBIT(3)\n#define MAX77650_GPIO_DEBOUNCE_MASK\tBIT(4)\n\n#define MAX77650_GPIO_DIR_OUT\t\t0x00\n#define MAX77650_GPIO_DIR_IN\t\tBIT(0)\n#define MAX77650_GPIO_OUT_LOW\t\t0x00\n#define MAX77650_GPIO_OUT_HIGH\t\tBIT(3)\n#define MAX77650_GPIO_DRV_OPEN_DRAIN\t0x00\n#define MAX77650_GPIO_DRV_PUSH_PULL\tBIT(2)\n#define MAX77650_GPIO_DEBOUNCE\t\tBIT(4)\n\n#define MAX77650_GPIO_DIR_BITS(_reg) \\\n\t\t((_reg) & MAX77650_GPIO_DIR_MASK)\n#define MAX77650_GPIO_INVAL_BITS(_reg) \\\n\t\t(((_reg) & MAX77650_GPIO_INVAL_MASK) >> 1)\n\nstruct max77650_gpio_chip {\n\tstruct regmap *map;\n\tstruct gpio_chip gc;\n\tint irq;\n};\n\nstatic int max77650_gpio_direction_input(struct gpio_chip *gc,\n\t\t\t\t\t unsigned int offset)\n{\n\tstruct max77650_gpio_chip *chip = gpiochip_get_data(gc);\n\n\treturn regmap_update_bits(chip->map,\n\t\t\t\t  MAX77650_REG_CNFG_GPIO,\n\t\t\t\t  MAX77650_GPIO_DIR_MASK,\n\t\t\t\t  MAX77650_GPIO_DIR_IN);\n}\n\nstatic int max77650_gpio_direction_output(struct gpio_chip *gc,\n\t\t\t\t\t  unsigned int offset, int value)\n{\n\tstruct max77650_gpio_chip *chip = gpiochip_get_data(gc);\n\tint mask, regval;\n\n\tmask = MAX77650_GPIO_DIR_MASK | MAX77650_GPIO_OUTVAL_MASK;\n\tregval = value ? MAX77650_GPIO_OUT_HIGH : MAX77650_GPIO_OUT_LOW;\n\tregval |= MAX77650_GPIO_DIR_OUT;\n\n\treturn regmap_update_bits(chip->map,\n\t\t\t\t  MAX77650_REG_CNFG_GPIO, mask, regval);\n}\n\nstatic void max77650_gpio_set_value(struct gpio_chip *gc,\n\t\t\t\t    unsigned int offset, int value)\n{\n\tstruct max77650_gpio_chip *chip = gpiochip_get_data(gc);\n\tint rv, regval;\n\n\tregval = value ? MAX77650_GPIO_OUT_HIGH : MAX77650_GPIO_OUT_LOW;\n\n\trv = regmap_update_bits(chip->map, MAX77650_REG_CNFG_GPIO,\n\t\t\t\tMAX77650_GPIO_OUTVAL_MASK, regval);\n\tif (rv)\n\t\tdev_err(gc->parent, \"cannot set GPIO value: %d\\n\", rv);\n}\n\nstatic int max77650_gpio_get_value(struct gpio_chip *gc,\n\t\t\t\t   unsigned int offset)\n{\n\tstruct max77650_gpio_chip *chip = gpiochip_get_data(gc);\n\tunsigned int val;\n\tint rv;\n\n\trv = regmap_read(chip->map, MAX77650_REG_CNFG_GPIO, &val);\n\tif (rv)\n\t\treturn rv;\n\n\treturn MAX77650_GPIO_INVAL_BITS(val);\n}\n\nstatic int max77650_gpio_get_direction(struct gpio_chip *gc,\n\t\t\t\t       unsigned int offset)\n{\n\tstruct max77650_gpio_chip *chip = gpiochip_get_data(gc);\n\tunsigned int val;\n\tint rv;\n\n\trv = regmap_read(chip->map, MAX77650_REG_CNFG_GPIO, &val);\n\tif (rv)\n\t\treturn rv;\n\n\treturn MAX77650_GPIO_DIR_BITS(val);\n}\n\nstatic int max77650_gpio_set_config(struct gpio_chip *gc,\n\t\t\t\t    unsigned int offset, unsigned long cfg)\n{\n\tstruct max77650_gpio_chip *chip = gpiochip_get_data(gc);\n\n\tswitch (pinconf_to_config_param(cfg)) {\n\tcase PIN_CONFIG_DRIVE_OPEN_DRAIN:\n\t\treturn regmap_update_bits(chip->map,\n\t\t\t\t\t  MAX77650_REG_CNFG_GPIO,\n\t\t\t\t\t  MAX77650_GPIO_DRV_MASK,\n\t\t\t\t\t  MAX77650_GPIO_DRV_OPEN_DRAIN);\n\tcase PIN_CONFIG_DRIVE_PUSH_PULL:\n\t\treturn regmap_update_bits(chip->map,\n\t\t\t\t\t  MAX77650_REG_CNFG_GPIO,\n\t\t\t\t\t  MAX77650_GPIO_DRV_MASK,\n\t\t\t\t\t  MAX77650_GPIO_DRV_PUSH_PULL);\n\tcase PIN_CONFIG_INPUT_DEBOUNCE:\n\t\treturn regmap_update_bits(chip->map,\n\t\t\t\t\t  MAX77650_REG_CNFG_GPIO,\n\t\t\t\t\t  MAX77650_GPIO_DEBOUNCE_MASK,\n\t\t\t\t\t  MAX77650_GPIO_DEBOUNCE);\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int max77650_gpio_to_irq(struct gpio_chip *gc, unsigned int offset)\n{\n\tstruct max77650_gpio_chip *chip = gpiochip_get_data(gc);\n\n\treturn chip->irq;\n}\n\nstatic int max77650_gpio_probe(struct platform_device *pdev)\n{\n\tstruct max77650_gpio_chip *chip;\n\tstruct device *dev, *parent;\n\tstruct i2c_client *i2c;\n\n\tdev = &pdev->dev;\n\tparent = dev->parent;\n\ti2c = to_i2c_client(parent);\n\n\tchip = devm_kzalloc(dev, sizeof(*chip), GFP_KERNEL);\n\tif (!chip)\n\t\treturn -ENOMEM;\n\n\tchip->map = dev_get_regmap(parent, NULL);\n\tif (!chip->map)\n\t\treturn -ENODEV;\n\n\tchip->irq = platform_get_irq_byname(pdev, \"GPI\");\n\tif (chip->irq < 0)\n\t\treturn chip->irq;\n\n\tchip->gc.base = -1;\n\tchip->gc.ngpio = 1;\n\tchip->gc.label = i2c->name;\n\tchip->gc.parent = dev;\n\tchip->gc.owner = THIS_MODULE;\n\tchip->gc.can_sleep = true;\n\n\tchip->gc.direction_input = max77650_gpio_direction_input;\n\tchip->gc.direction_output = max77650_gpio_direction_output;\n\tchip->gc.set = max77650_gpio_set_value;\n\tchip->gc.get = max77650_gpio_get_value;\n\tchip->gc.get_direction = max77650_gpio_get_direction;\n\tchip->gc.set_config = max77650_gpio_set_config;\n\tchip->gc.to_irq = max77650_gpio_to_irq;\n\n\treturn devm_gpiochip_add_data(dev, &chip->gc, chip);\n}\n\nstatic struct platform_driver max77650_gpio_driver = {\n\t.driver = {\n\t\t.name = \"max77650-gpio\",\n\t},\n\t.probe = max77650_gpio_probe,\n};\nmodule_platform_driver(max77650_gpio_driver);\n\nMODULE_DESCRIPTION(\"MAXIM 77650/77651 GPIO driver\");\nMODULE_AUTHOR(\"Bartosz Golaszewski <bgolaszewski@baylibre.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:max77650-gpio\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}