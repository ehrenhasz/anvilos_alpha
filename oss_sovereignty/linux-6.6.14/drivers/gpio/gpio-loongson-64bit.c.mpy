{
  "module_name": "gpio-loongson-64bit.c",
  "hash_id": "5877cbe70cc154cf232b23fbcb44929cdde852a7ebdab165ff051de6a30c53ba",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-loongson-64bit.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/spinlock.h>\n#include <linux/err.h>\n#include <linux/gpio/driver.h>\n#include <linux/platform_device.h>\n#include <linux/bitops.h>\n#include <asm/types.h>\n\nenum loongson_gpio_mode {\n\tBIT_CTRL_MODE,\n\tBYTE_CTRL_MODE,\n};\n\nstruct loongson_gpio_chip_data {\n\tconst char\t\t*label;\n\tenum loongson_gpio_mode\tmode;\n\tunsigned int\t\tconf_offset;\n\tunsigned int\t\tout_offset;\n\tunsigned int\t\tin_offset;\n};\n\nstruct loongson_gpio_chip {\n\tstruct gpio_chip\tchip;\n\tstruct fwnode_handle\t*fwnode;\n\tspinlock_t\t\tlock;\n\tvoid __iomem\t\t*reg_base;\n\tconst struct loongson_gpio_chip_data *chip_data;\n};\n\nstatic inline struct loongson_gpio_chip *to_loongson_gpio_chip(struct gpio_chip *chip)\n{\n\treturn container_of(chip, struct loongson_gpio_chip, chip);\n}\n\nstatic inline void loongson_commit_direction(struct loongson_gpio_chip *lgpio, unsigned int pin,\n\t\t\t\t\t     int input)\n{\n\tu8 bval = input ? 1 : 0;\n\n\twriteb(bval, lgpio->reg_base + lgpio->chip_data->conf_offset + pin);\n}\n\nstatic void loongson_commit_level(struct loongson_gpio_chip *lgpio, unsigned int pin, int high)\n{\n\tu8 bval = high ? 1 : 0;\n\n\twriteb(bval, lgpio->reg_base + lgpio->chip_data->out_offset + pin);\n}\n\nstatic int loongson_gpio_direction_input(struct gpio_chip *chip, unsigned int pin)\n{\n\tunsigned long flags;\n\tstruct loongson_gpio_chip *lgpio = to_loongson_gpio_chip(chip);\n\n\tspin_lock_irqsave(&lgpio->lock, flags);\n\tloongson_commit_direction(lgpio, pin, 1);\n\tspin_unlock_irqrestore(&lgpio->lock, flags);\n\n\treturn 0;\n}\n\nstatic int loongson_gpio_direction_output(struct gpio_chip *chip, unsigned int pin, int value)\n{\n\tunsigned long flags;\n\tstruct loongson_gpio_chip *lgpio = to_loongson_gpio_chip(chip);\n\n\tspin_lock_irqsave(&lgpio->lock, flags);\n\tloongson_commit_level(lgpio, pin, value);\n\tloongson_commit_direction(lgpio, pin, 0);\n\tspin_unlock_irqrestore(&lgpio->lock, flags);\n\n\treturn 0;\n}\n\nstatic int loongson_gpio_get(struct gpio_chip *chip, unsigned int pin)\n{\n\tu8  bval;\n\tint val;\n\tstruct loongson_gpio_chip *lgpio = to_loongson_gpio_chip(chip);\n\n\tbval = readb(lgpio->reg_base + lgpio->chip_data->in_offset + pin);\n\tval = bval & 1;\n\n\treturn val;\n}\n\nstatic int loongson_gpio_get_direction(struct gpio_chip *chip, unsigned int pin)\n{\n\tu8  bval;\n\tstruct loongson_gpio_chip *lgpio = to_loongson_gpio_chip(chip);\n\n\tbval = readb(lgpio->reg_base + lgpio->chip_data->conf_offset + pin);\n\tif (bval & 1)\n\t\treturn GPIO_LINE_DIRECTION_IN;\n\n\treturn GPIO_LINE_DIRECTION_OUT;\n}\n\nstatic void loongson_gpio_set(struct gpio_chip *chip, unsigned int pin, int value)\n{\n\tunsigned long flags;\n\tstruct loongson_gpio_chip *lgpio = to_loongson_gpio_chip(chip);\n\n\tspin_lock_irqsave(&lgpio->lock, flags);\n\tloongson_commit_level(lgpio, pin, value);\n\tspin_unlock_irqrestore(&lgpio->lock, flags);\n}\n\nstatic int loongson_gpio_to_irq(struct gpio_chip *chip, unsigned int offset)\n{\n\tstruct platform_device *pdev = to_platform_device(chip->parent);\n\n\treturn platform_get_irq(pdev, offset);\n}\n\nstatic int loongson_gpio_init(struct device *dev, struct loongson_gpio_chip *lgpio,\n\t\t\t      struct device_node *np, void __iomem *reg_base)\n{\n\tint ret;\n\tu32 ngpios;\n\n\tlgpio->reg_base = reg_base;\n\n\tif (lgpio->chip_data->mode == BIT_CTRL_MODE) {\n\t\tret = bgpio_init(&lgpio->chip, dev, 8,\n\t\t\t\tlgpio->reg_base + lgpio->chip_data->in_offset,\n\t\t\t\tlgpio->reg_base + lgpio->chip_data->out_offset,\n\t\t\t\tNULL, NULL,\n\t\t\t\tlgpio->reg_base + lgpio->chip_data->conf_offset,\n\t\t\t\t0);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"unable to init generic GPIO\\n\");\n\t\t\treturn ret;\n\t\t}\n\t} else {\n\t\tlgpio->chip.direction_input = loongson_gpio_direction_input;\n\t\tlgpio->chip.get = loongson_gpio_get;\n\t\tlgpio->chip.get_direction = loongson_gpio_get_direction;\n\t\tlgpio->chip.direction_output = loongson_gpio_direction_output;\n\t\tlgpio->chip.set = loongson_gpio_set;\n\t\tlgpio->chip.parent = dev;\n\t\tspin_lock_init(&lgpio->lock);\n\t}\n\n\tdevice_property_read_u32(dev, \"ngpios\", &ngpios);\n\n\tlgpio->chip.can_sleep = 0;\n\tlgpio->chip.ngpio = ngpios;\n\tlgpio->chip.label = lgpio->chip_data->label;\n\tlgpio->chip.to_irq = loongson_gpio_to_irq;\n\n\treturn devm_gpiochip_add_data(dev, &lgpio->chip, lgpio);\n}\n\nstatic int loongson_gpio_probe(struct platform_device *pdev)\n{\n\tvoid __iomem *reg_base;\n\tstruct loongson_gpio_chip *lgpio;\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct device *dev = &pdev->dev;\n\n\tlgpio = devm_kzalloc(dev, sizeof(*lgpio), GFP_KERNEL);\n\tif (!lgpio)\n\t\treturn -ENOMEM;\n\n\tlgpio->chip_data = device_get_match_data(dev);\n\n\treg_base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(reg_base))\n\t\treturn PTR_ERR(reg_base);\n\n\treturn loongson_gpio_init(dev, lgpio, np, reg_base);\n}\n\nstatic const struct loongson_gpio_chip_data loongson_gpio_ls2k_data = {\n\t.label = \"ls2k_gpio\",\n\t.mode = BIT_CTRL_MODE,\n\t.conf_offset = 0x0,\n\t.in_offset = 0x20,\n\t.out_offset = 0x10,\n};\n\nstatic const struct loongson_gpio_chip_data loongson_gpio_ls7a_data = {\n\t.label = \"ls7a_gpio\",\n\t.mode = BYTE_CTRL_MODE,\n\t.conf_offset = 0x800,\n\t.in_offset = 0xa00,\n\t.out_offset = 0x900,\n};\n\nstatic const struct of_device_id loongson_gpio_of_match[] = {\n\t{\n\t\t.compatible = \"loongson,ls2k-gpio\",\n\t\t.data = &loongson_gpio_ls2k_data,\n\t},\n\t{\n\t\t.compatible = \"loongson,ls7a-gpio\",\n\t\t.data = &loongson_gpio_ls7a_data,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, loongson_gpio_of_match);\n\nstatic const struct acpi_device_id loongson_gpio_acpi_match[] = {\n\t{\n\t\t.id = \"LOON0002\",\n\t\t.driver_data = (kernel_ulong_t)&loongson_gpio_ls7a_data,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(acpi, loongson_gpio_acpi_match);\n\nstatic struct platform_driver loongson_gpio_driver = {\n\t.driver = {\n\t\t.name = \"loongson-gpio\",\n\t\t.of_match_table = loongson_gpio_of_match,\n\t\t.acpi_match_table = loongson_gpio_acpi_match,\n\t},\n\t.probe = loongson_gpio_probe,\n};\n\nstatic int __init loongson_gpio_setup(void)\n{\n\treturn platform_driver_register(&loongson_gpio_driver);\n}\npostcore_initcall(loongson_gpio_setup);\n\nMODULE_DESCRIPTION(\"Loongson gpio driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}