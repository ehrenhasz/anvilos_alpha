{
  "module_name": "gpio-sl28cpld.c",
  "hash_id": "a14111d7cab962f2ceca1af09c2879966e35378dca9c276a8cf17c89f9b0d26f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gpio/gpio-sl28cpld.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/gpio/driver.h>\n#include <linux/gpio/regmap.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n \n#define GPIO_REG_DIR\t0x00\n#define GPIO_REG_OUT\t0x01\n#define GPIO_REG_IN\t0x02\n#define GPIO_REG_IE\t0x03\n#define GPIO_REG_IP\t0x04\n\n \n#define GPI_REG_IN\t0x00\n\n \n#define GPO_REG_OUT\t0x00\n\nenum sl28cpld_gpio_type {\n\tSL28CPLD_GPIO = 1,\n\tSL28CPLD_GPI,\n\tSL28CPLD_GPO,\n};\n\nstatic const struct regmap_irq sl28cpld_gpio_irqs[] = {\n\tREGMAP_IRQ_REG_LINE(0, 8),\n\tREGMAP_IRQ_REG_LINE(1, 8),\n\tREGMAP_IRQ_REG_LINE(2, 8),\n\tREGMAP_IRQ_REG_LINE(3, 8),\n\tREGMAP_IRQ_REG_LINE(4, 8),\n\tREGMAP_IRQ_REG_LINE(5, 8),\n\tREGMAP_IRQ_REG_LINE(6, 8),\n\tREGMAP_IRQ_REG_LINE(7, 8),\n};\n\nstatic int sl28cpld_gpio_irq_init(struct platform_device *pdev,\n\t\t\t\t  unsigned int base,\n\t\t\t\t  struct gpio_regmap_config *config)\n{\n\tstruct regmap_irq_chip_data *irq_data;\n\tstruct regmap_irq_chip *irq_chip;\n\tstruct device *dev = &pdev->dev;\n\tint irq, ret;\n\n\tif (!device_property_read_bool(dev, \"interrupt-controller\"))\n\t\treturn 0;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\tirq_chip = devm_kzalloc(dev, sizeof(*irq_chip), GFP_KERNEL);\n\tif (!irq_chip)\n\t\treturn -ENOMEM;\n\n\tirq_chip->name = \"sl28cpld-gpio-irq\";\n\tirq_chip->irqs = sl28cpld_gpio_irqs;\n\tirq_chip->num_irqs = ARRAY_SIZE(sl28cpld_gpio_irqs);\n\tirq_chip->num_regs = 1;\n\tirq_chip->status_base = base + GPIO_REG_IP;\n\tirq_chip->unmask_base = base + GPIO_REG_IE;\n\tirq_chip->ack_base = base + GPIO_REG_IP;\n\n\tret = devm_regmap_add_irq_chip_fwnode(dev, dev_fwnode(dev),\n\t\t\t\t\t      config->regmap, irq,\n\t\t\t\t\t      IRQF_SHARED | IRQF_ONESHOT,\n\t\t\t\t\t      0, irq_chip, &irq_data);\n\tif (ret)\n\t\treturn ret;\n\n\tconfig->irq_domain = regmap_irq_get_domain(irq_data);\n\n\treturn 0;\n}\n\nstatic int sl28cpld_gpio_probe(struct platform_device *pdev)\n{\n\tstruct gpio_regmap_config config = {0};\n\tenum sl28cpld_gpio_type type;\n\tstruct regmap *regmap;\n\tu32 base;\n\tint ret;\n\n\tif (!pdev->dev.parent)\n\t\treturn -ENODEV;\n\n\ttype = (uintptr_t)device_get_match_data(&pdev->dev);\n\tif (!type)\n\t\treturn -ENODEV;\n\n\tret = device_property_read_u32(&pdev->dev, \"reg\", &base);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\tregmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!regmap)\n\t\treturn -ENODEV;\n\n\tconfig.regmap = regmap;\n\tconfig.parent = &pdev->dev;\n\tconfig.ngpio = 8;\n\n\tswitch (type) {\n\tcase SL28CPLD_GPIO:\n\t\tconfig.reg_dat_base = base + GPIO_REG_IN;\n\t\tconfig.reg_set_base = base + GPIO_REG_OUT;\n\t\t \n\t\tconfig.reg_dir_out_base = GPIO_REGMAP_ADDR(base + GPIO_REG_DIR);\n\n\t\t \n\t\tret = sl28cpld_gpio_irq_init(pdev, base, &config);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase SL28CPLD_GPO:\n\t\tconfig.reg_set_base = base + GPO_REG_OUT;\n\t\tbreak;\n\tcase SL28CPLD_GPI:\n\t\tconfig.reg_dat_base = base + GPI_REG_IN;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&pdev->dev, \"unknown type %d\\n\", type);\n\t\treturn -ENODEV;\n\t}\n\n\treturn PTR_ERR_OR_ZERO(devm_gpio_regmap_register(&pdev->dev, &config));\n}\n\nstatic const struct of_device_id sl28cpld_gpio_of_match[] = {\n\t{ .compatible = \"kontron,sl28cpld-gpio\", .data = (void *)SL28CPLD_GPIO },\n\t{ .compatible = \"kontron,sl28cpld-gpi\", .data = (void *)SL28CPLD_GPI },\n\t{ .compatible = \"kontron,sl28cpld-gpo\", .data = (void *)SL28CPLD_GPO },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, sl28cpld_gpio_of_match);\n\nstatic struct platform_driver sl28cpld_gpio_driver = {\n\t.probe = sl28cpld_gpio_probe,\n\t.driver = {\n\t\t.name = \"sl28cpld-gpio\",\n\t\t.of_match_table = sl28cpld_gpio_of_match,\n\t},\n};\nmodule_platform_driver(sl28cpld_gpio_driver);\n\nMODULE_DESCRIPTION(\"sl28cpld GPIO Driver\");\nMODULE_AUTHOR(\"Michael Walle <michael@walle.cc>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}