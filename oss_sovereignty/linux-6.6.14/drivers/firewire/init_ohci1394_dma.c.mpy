{
  "module_name": "init_ohci1394_dma.c",
  "hash_id": "725d88825d403acb3b1b7f563686c5e4067a6983d13ade518fd96447d13910f2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firewire/init_ohci1394_dma.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/pci.h>\t\t \n#include <linux/string.h>\n\n#include <asm/pci-direct.h>\t \n#include <asm/fixmap.h>\n\n#include <linux/init_ohci1394_dma.h>\n#include \"ohci.h\"\n\nint __initdata init_ohci1394_dma_early;\n\nstruct ohci {\n\tvoid __iomem *registers;\n};\n\nstatic inline void reg_write(const struct ohci *ohci, int offset, u32 data)\n{\n\twritel(data, ohci->registers + offset);\n}\n\nstatic inline u32 reg_read(const struct ohci *ohci, int offset)\n{\n\treturn readl(ohci->registers + offset);\n}\n\n#define OHCI_LOOP_COUNT\t\t100\t \n\n \nstatic inline u8 __init get_phy_reg(struct ohci *ohci, u8 addr)\n{\n\tint i;\n\tu32 r;\n\n\treg_write(ohci, OHCI1394_PhyControl, (addr << 8) | 0x00008000);\n\n\tfor (i = 0; i < OHCI_LOOP_COUNT; i++) {\n\t\tif (reg_read(ohci, OHCI1394_PhyControl) & 0x80000000)\n\t\t\tbreak;\n\t\tmdelay(1);\n\t}\n\tr = reg_read(ohci, OHCI1394_PhyControl);\n\n\treturn (r & 0x00ff0000) >> 16;\n}\n\n \nstatic inline void __init set_phy_reg(struct ohci *ohci, u8 addr, u8 data)\n{\n\tint i;\n\n\treg_write(ohci, OHCI1394_PhyControl, (addr << 8) | data | 0x00004000);\n\n\tfor (i = 0; i < OHCI_LOOP_COUNT; i++) {\n\t\tif (!(reg_read(ohci, OHCI1394_PhyControl) & 0x00004000))\n\t\t\tbreak;\n\t\tmdelay(1);\n\t}\n}\n\n \nstatic inline void __init init_ohci1394_soft_reset(struct ohci *ohci)\n{\n\tint i;\n\n\treg_write(ohci, OHCI1394_HCControlSet, OHCI1394_HCControl_softReset);\n\n\tfor (i = 0; i < OHCI_LOOP_COUNT; i++) {\n\t\tif (!(reg_read(ohci, OHCI1394_HCControlSet)\n\t\t\t\t   & OHCI1394_HCControl_softReset))\n\t\t\tbreak;\n\t\tmdelay(1);\n\t}\n}\n\n#define OHCI1394_MAX_AT_REQ_RETRIES\t0xf\n#define OHCI1394_MAX_AT_RESP_RETRIES\t0x2\n#define OHCI1394_MAX_PHYS_RESP_RETRIES\t0x8\n\n \nstatic inline void __init init_ohci1394_initialize(struct ohci *ohci)\n{\n\tu32 bus_options;\n\tint num_ports, i;\n\n\t \n\tbus_options = reg_read(ohci, OHCI1394_BusOptions);\n\tbus_options |=  0x60000000;  \n\tbus_options &= ~0x00ff0000;  \n\tbus_options &= ~0x18000000;  \n\treg_write(ohci, OHCI1394_BusOptions, bus_options);\n\n\t \n\treg_write(ohci, OHCI1394_NodeID, 0x0000ffc0);\n\n\t \n\treg_write(ohci, OHCI1394_HCControlSet,\n\t\t\tOHCI1394_HCControl_postedWriteEnable);\n\n\t \n\treg_write(ohci, OHCI1394_LinkControlClear, 0xffffffff);\n\n\t \n\treg_write(ohci, OHCI1394_LinkControlSet,\n\t\t\tOHCI1394_LinkControl_rcvPhyPkt);\n\n\t \n\treg_write(ohci, OHCI1394_LinkControlClear, 0x00000400);\n\n\t \n\treg_write(ohci, OHCI1394_IsoRecvIntMaskClear, 0xffffffff);\n\treg_write(ohci, OHCI1394_IsoRecvIntEventClear, 0xffffffff);\n\treg_write(ohci, OHCI1394_IsoXmitIntMaskClear, 0xffffffff);\n\treg_write(ohci, OHCI1394_IsoXmitIntEventClear, 0xffffffff);\n\n\t \n\treg_write(ohci, OHCI1394_AsReqFilterHiSet, 0x80000000);\n\n\t \n\treg_write(ohci, OHCI1394_ATRetries,\n\t\t  OHCI1394_MAX_AT_REQ_RETRIES |\n\t\t  (OHCI1394_MAX_AT_RESP_RETRIES<<4) |\n\t\t  (OHCI1394_MAX_PHYS_RESP_RETRIES<<8));\n\n\t \n\treg_write(ohci, OHCI1394_HCControlClear,\n\t\t  OHCI1394_HCControl_noByteSwapData);\n\n\t \n\treg_write(ohci, OHCI1394_HCControlSet, OHCI1394_HCControl_linkEnable);\n\n\t \n\tnum_ports = get_phy_reg(ohci, 2) & 0xf;\n\tfor (i = 0; i < num_ports; i++) {\n\t\tunsigned int status;\n\n\t\tset_phy_reg(ohci, 7, i);\n\t\tstatus = get_phy_reg(ohci, 8);\n\n\t\tif (status & 0x20)\n\t\t\tset_phy_reg(ohci, 8, status & ~1);\n\t}\n}\n\n \nstatic inline void __init init_ohci1394_wait_for_busresets(struct ohci *ohci)\n{\n\tint i, events;\n\n\tfor (i = 0; i < 9; i++) {\n\t\tmdelay(200);\n\t\tevents = reg_read(ohci, OHCI1394_IntEventSet);\n\t\tif (events & OHCI1394_busReset)\n\t\t\treg_write(ohci, OHCI1394_IntEventClear,\n\t\t\t\t\tOHCI1394_busReset);\n\t}\n}\n\n \nstatic inline void __init init_ohci1394_enable_physical_dma(struct ohci *ohci)\n{\n\treg_write(ohci, OHCI1394_PhyReqFilterHiSet, 0xffffffff);\n\treg_write(ohci, OHCI1394_PhyReqFilterLoSet, 0xffffffff);\n\treg_write(ohci, OHCI1394_PhyUpperBound, 0xffff0000);\n}\n\n \nstatic inline void __init init_ohci1394_reset_and_init_dma(struct ohci *ohci)\n{\n\t \n\tinit_ohci1394_soft_reset(ohci);\n\n\t \n\treg_write(ohci, OHCI1394_HCControlSet, OHCI1394_HCControl_LPS);\n\n\t \n\treg_write(ohci, OHCI1394_IntEventClear, 0xffffffff);\n\treg_write(ohci, OHCI1394_IntMaskClear, 0xffffffff);\n\n\tmdelay(50);  \n\n\tinit_ohci1394_initialize(ohci);\n\t \n\tinit_ohci1394_wait_for_busresets(ohci);\n\n\t \n\tinit_ohci1394_enable_physical_dma(ohci);\n}\n\n \nstatic inline void __init init_ohci1394_controller(int num, int slot, int func)\n{\n\tunsigned long ohci_base;\n\tstruct ohci ohci;\n\n\tprintk(KERN_INFO \"init_ohci1394_dma: initializing OHCI-1394\"\n\t\t\t \" at %02x:%02x.%x\\n\", num, slot, func);\n\n\tohci_base = read_pci_config(num, slot, func, PCI_BASE_ADDRESS_0+(0<<2))\n\t\t\t\t\t\t   & PCI_BASE_ADDRESS_MEM_MASK;\n\n\tset_fixmap_nocache(FIX_OHCI1394_BASE, ohci_base);\n\n\tohci.registers = (void __iomem *)fix_to_virt(FIX_OHCI1394_BASE);\n\n\tinit_ohci1394_reset_and_init_dma(&ohci);\n}\n\n \nvoid __init init_ohci1394_dma_on_all_controllers(void)\n{\n\tint num, slot, func;\n\tu32 class;\n\n\tif (!early_pci_allowed())\n\t\treturn;\n\n\t \n\tfor (num = 0; num < 32; num++) {\n\t\tfor (slot = 0; slot < 32; slot++) {\n\t\t\tfor (func = 0; func < 8; func++) {\n\t\t\t\tclass = read_pci_config(num, slot, func,\n\t\t\t\t\t\t\tPCI_CLASS_REVISION);\n\t\t\t\tif (class == 0xffffffff)\n\t\t\t\t\tcontinue;  \n\n\t\t\t\tif (class>>8 != PCI_CLASS_SERIAL_FIREWIRE_OHCI)\n\t\t\t\t\tcontinue;  \n\n\t\t\t\tinit_ohci1394_controller(num, slot, func);\n\t\t\t\tbreak;  \n\t\t\t}\n\t\t}\n\t}\n\tprintk(KERN_INFO \"init_ohci1394_dma: finished initializing OHCI DMA\\n\");\n}\n\n \nstatic int __init setup_ohci1394_dma(char *opt)\n{\n\tif (!strcmp(opt, \"early\"))\n\t\tinit_ohci1394_dma_early = 1;\n\treturn 0;\n}\n\n \nearly_param(\"ohci1394_dma\", setup_ohci1394_dma);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}