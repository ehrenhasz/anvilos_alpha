{
  "module_name": "ast2600-i3c-master.c",
  "hash_id": "88ed8ffffffaf1e88d3574dcbd033010f93a41a437c119f76b0a59e91f90e43c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/i3c/master/ast2600-i3c-master.c",
  "human_readable_source": "\n \n\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include \"dw-i3c-master.h\"\n\n \n#define AST2600_I3CG_REG0(idx)\t(((idx) * 4 * 4) + 0x10)\n#define AST2600_I3CG_REG1(idx)\t(((idx) * 4 * 4) + 0x14)\n\n#define AST2600_I3CG_REG0_SDA_PULLUP_EN_MASK\tGENMASK(29, 28)\n#define AST2600_I3CG_REG0_SDA_PULLUP_EN_2K\t(0x0 << 28)\n#define AST2600_I3CG_REG0_SDA_PULLUP_EN_750\t(0x2 << 28)\n#define AST2600_I3CG_REG0_SDA_PULLUP_EN_545\t(0x3 << 28)\n\n#define AST2600_I3CG_REG1_I2C_MODE\t\tBIT(0)\n#define AST2600_I3CG_REG1_TEST_MODE\t\tBIT(1)\n#define AST2600_I3CG_REG1_ACT_MODE_MASK\t\tGENMASK(3, 2)\n#define AST2600_I3CG_REG1_ACT_MODE(x)\t\t(((x) << 2) & AST2600_I3CG_REG1_ACT_MODE_MASK)\n#define AST2600_I3CG_REG1_PENDING_INT_MASK\tGENMASK(7, 4)\n#define AST2600_I3CG_REG1_PENDING_INT(x)\t(((x) << 4) & AST2600_I3CG_REG1_PENDING_INT_MASK)\n#define AST2600_I3CG_REG1_SA_MASK\t\tGENMASK(14, 8)\n#define AST2600_I3CG_REG1_SA(x)\t\t\t(((x) << 8) & AST2600_I3CG_REG1_SA_MASK)\n#define AST2600_I3CG_REG1_SA_EN\t\t\tBIT(15)\n#define AST2600_I3CG_REG1_INST_ID_MASK\t\tGENMASK(19, 16)\n#define AST2600_I3CG_REG1_INST_ID(x)\t\t(((x) << 16) & AST2600_I3CG_REG1_INST_ID_MASK)\n\n#define AST2600_DEFAULT_SDA_PULLUP_OHMS\t\t2000\n\n#define DEV_ADDR_TABLE_IBI_PEC\t\t\tBIT(11)\n\nstruct ast2600_i3c {\n\tstruct dw_i3c_master dw;\n\tstruct regmap *global_regs;\n\tunsigned int global_idx;\n\tunsigned int sda_pullup;\n};\n\nstatic struct ast2600_i3c *to_ast2600_i3c(struct dw_i3c_master *dw)\n{\n\treturn container_of(dw, struct ast2600_i3c, dw);\n}\n\nstatic int ast2600_i3c_pullup_to_reg(unsigned int ohms, u32 *regp)\n{\n\tu32 reg;\n\n\tswitch (ohms) {\n\tcase 2000:\n\t\treg = AST2600_I3CG_REG0_SDA_PULLUP_EN_2K;\n\t\tbreak;\n\tcase 750:\n\t\treg = AST2600_I3CG_REG0_SDA_PULLUP_EN_750;\n\t\tbreak;\n\tcase 545:\n\t\treg = AST2600_I3CG_REG0_SDA_PULLUP_EN_545;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (regp)\n\t\t*regp = reg;\n\n\treturn 0;\n}\n\nstatic int ast2600_i3c_init(struct dw_i3c_master *dw)\n{\n\tstruct ast2600_i3c *i3c = to_ast2600_i3c(dw);\n\tu32 reg = 0;\n\tint rc;\n\n\t \n\trc = ast2600_i3c_pullup_to_reg(i3c->sda_pullup, &reg);\n\tif (rc)\n\t\treturn rc;\n\n\trc = regmap_write(i3c->global_regs,\n\t\t\t  AST2600_I3CG_REG0(i3c->global_idx), reg);\n\tif (rc)\n\t\treturn rc;\n\n\t \n\treg = AST2600_I3CG_REG1_INST_ID(i3c->global_idx);\n\trc = regmap_write(i3c->global_regs,\n\t\t\t  AST2600_I3CG_REG1(i3c->global_idx), reg);\n\n\treturn rc;\n}\n\nstatic void ast2600_i3c_set_dat_ibi(struct dw_i3c_master *i3c,\n\t\t\t\t    struct i3c_dev_desc *dev,\n\t\t\t\t    bool enable, u32 *dat)\n{\n\t \n\tif (enable && dev->info.bcr & I3C_BCR_IBI_PAYLOAD) {\n\t\tdev_warn_once(&i3c->base.dev,\n\t\t      \"Enabling PEC workaround. IBI payloads will be truncated\\n\");\n\t\t*dat |= DEV_ADDR_TABLE_IBI_PEC;\n\t}\n}\n\nstatic const struct dw_i3c_platform_ops ast2600_i3c_ops = {\n\t.init = ast2600_i3c_init,\n\t.set_dat_ibi = ast2600_i3c_set_dat_ibi,\n};\n\nstatic int ast2600_i3c_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct of_phandle_args gspec;\n\tstruct ast2600_i3c *i3c;\n\tint rc;\n\n\ti3c = devm_kzalloc(&pdev->dev, sizeof(*i3c), GFP_KERNEL);\n\tif (!i3c)\n\t\treturn -ENOMEM;\n\n\trc = of_parse_phandle_with_fixed_args(np, \"aspeed,global-regs\", 1, 0,\n\t\t\t\t\t      &gspec);\n\tif (rc)\n\t\treturn -ENODEV;\n\n\ti3c->global_regs = syscon_node_to_regmap(gspec.np);\n\tof_node_put(gspec.np);\n\n\tif (IS_ERR(i3c->global_regs))\n\t\treturn PTR_ERR(i3c->global_regs);\n\n\ti3c->global_idx = gspec.args[0];\n\n\trc = of_property_read_u32(np, \"sda-pullup-ohms\", &i3c->sda_pullup);\n\tif (rc)\n\t\ti3c->sda_pullup = AST2600_DEFAULT_SDA_PULLUP_OHMS;\n\n\trc = ast2600_i3c_pullup_to_reg(i3c->sda_pullup, NULL);\n\tif (rc)\n\t\tdev_err(&pdev->dev, \"invalid sda-pullup value %d\\n\",\n\t\t\ti3c->sda_pullup);\n\n\ti3c->dw.platform_ops = &ast2600_i3c_ops;\n\ti3c->dw.ibi_capable = true;\n\treturn dw_i3c_common_probe(&i3c->dw, pdev);\n}\n\nstatic void ast2600_i3c_remove(struct platform_device *pdev)\n{\n\tstruct dw_i3c_master *dw_i3c = platform_get_drvdata(pdev);\n\n\tdw_i3c_common_remove(dw_i3c);\n}\n\nstatic const struct of_device_id ast2600_i3c_master_of_match[] = {\n\t{ .compatible = \"aspeed,ast2600-i3c\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, ast2600_i3c_master_of_match);\n\nstatic struct platform_driver ast2600_i3c_driver = {\n\t.probe = ast2600_i3c_probe,\n\t.remove_new = ast2600_i3c_remove,\n\t.driver = {\n\t\t.name = \"ast2600-i3c-master\",\n\t\t.of_match_table = ast2600_i3c_master_of_match,\n\t},\n};\nmodule_platform_driver(ast2600_i3c_driver);\n\nMODULE_AUTHOR(\"Jeremy Kerr <jk@codeconstruct.com.au>\");\nMODULE_DESCRIPTION(\"ASPEED AST2600 I3C driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}