{
  "module_name": "timer-owl.c",
  "hash_id": "608f2780dddff20f4be688afd52ba9cb5307a4b789751f94e3709c6d15653b1a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clocksource/timer-owl.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clockchips.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/irqreturn.h>\n#include <linux/sched_clock.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n\n#define OWL_Tx_CTL\t\t0x0\n#define OWL_Tx_CMP\t\t0x4\n#define OWL_Tx_VAL\t\t0x8\n\n#define OWL_Tx_CTL_PD\t\tBIT(0)\n#define OWL_Tx_CTL_INTEN\tBIT(1)\n#define OWL_Tx_CTL_EN\t\tBIT(2)\n\nstatic void __iomem *owl_timer_base;\nstatic void __iomem *owl_clksrc_base;\nstatic void __iomem *owl_clkevt_base;\n\nstatic inline void owl_timer_reset(void __iomem *base)\n{\n\twritel(0, base + OWL_Tx_CTL);\n\twritel(0, base + OWL_Tx_VAL);\n\twritel(0, base + OWL_Tx_CMP);\n}\n\nstatic inline void owl_timer_set_enabled(void __iomem *base, bool enabled)\n{\n\tu32 ctl = readl(base + OWL_Tx_CTL);\n\n\t \n\tctl &= ~OWL_Tx_CTL_PD;\n\n\tif (enabled)\n\t\tctl |= OWL_Tx_CTL_EN;\n\telse\n\t\tctl &= ~OWL_Tx_CTL_EN;\n\n\twritel(ctl, base + OWL_Tx_CTL);\n}\n\nstatic u64 notrace owl_timer_sched_read(void)\n{\n\treturn (u64)readl(owl_clksrc_base + OWL_Tx_VAL);\n}\n\nstatic int owl_timer_set_state_shutdown(struct clock_event_device *evt)\n{\n\towl_timer_set_enabled(owl_clkevt_base, false);\n\n\treturn 0;\n}\n\nstatic int owl_timer_set_state_oneshot(struct clock_event_device *evt)\n{\n\towl_timer_reset(owl_clkevt_base);\n\n\treturn 0;\n}\n\nstatic int owl_timer_tick_resume(struct clock_event_device *evt)\n{\n\treturn 0;\n}\n\nstatic int owl_timer_set_next_event(unsigned long evt,\n\t\t\t\t    struct clock_event_device *ev)\n{\n\tvoid __iomem *base = owl_clkevt_base;\n\n\towl_timer_set_enabled(base, false);\n\twritel(OWL_Tx_CTL_INTEN, base + OWL_Tx_CTL);\n\twritel(0, base + OWL_Tx_VAL);\n\twritel(evt, base + OWL_Tx_CMP);\n\towl_timer_set_enabled(base, true);\n\n\treturn 0;\n}\n\nstatic struct clock_event_device owl_clockevent = {\n\t.name\t\t\t= \"owl_tick\",\n\t.rating\t\t\t= 200,\n\t.features\t\t= CLOCK_EVT_FEAT_ONESHOT |\n\t\t\t\t  CLOCK_EVT_FEAT_DYNIRQ,\n\t.set_state_shutdown\t= owl_timer_set_state_shutdown,\n\t.set_state_oneshot\t= owl_timer_set_state_oneshot,\n\t.tick_resume\t\t= owl_timer_tick_resume,\n\t.set_next_event\t\t= owl_timer_set_next_event,\n};\n\nstatic irqreturn_t owl_timer1_interrupt(int irq, void *dev_id)\n{\n\tstruct clock_event_device *evt = (struct clock_event_device *)dev_id;\n\n\twritel(OWL_Tx_CTL_PD, owl_clkevt_base + OWL_Tx_CTL);\n\n\tevt->event_handler(evt);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int __init owl_timer_init(struct device_node *node)\n{\n\tstruct clk *clk;\n\tunsigned long rate;\n\tint timer1_irq, ret;\n\n\towl_timer_base = of_io_request_and_map(node, 0, \"owl-timer\");\n\tif (IS_ERR(owl_timer_base)) {\n\t\tpr_err(\"Can't map timer registers\\n\");\n\t\treturn PTR_ERR(owl_timer_base);\n\t}\n\n\towl_clksrc_base = owl_timer_base + 0x08;\n\towl_clkevt_base = owl_timer_base + 0x14;\n\n\ttimer1_irq = of_irq_get_byname(node, \"timer1\");\n\tif (timer1_irq <= 0) {\n\t\tpr_err(\"Can't parse timer1 IRQ\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tclk = of_clk_get(node, 0);\n\tif (IS_ERR(clk)) {\n\t\tret = PTR_ERR(clk);\n\t\tpr_err(\"Failed to get clock for clocksource (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\trate = clk_get_rate(clk);\n\n\towl_timer_reset(owl_clksrc_base);\n\towl_timer_set_enabled(owl_clksrc_base, true);\n\n\tsched_clock_register(owl_timer_sched_read, 32, rate);\n\tret = clocksource_mmio_init(owl_clksrc_base + OWL_Tx_VAL, node->name,\n\t\t\t\t    rate, 200, 32, clocksource_mmio_readl_up);\n\tif (ret) {\n\t\tpr_err(\"Failed to register clocksource (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\towl_timer_reset(owl_clkevt_base);\n\n\tret = request_irq(timer1_irq, owl_timer1_interrupt, IRQF_TIMER,\n\t\t\t  \"owl-timer\", &owl_clockevent);\n\tif (ret) {\n\t\tpr_err(\"failed to request irq %d\\n\", timer1_irq);\n\t\treturn ret;\n\t}\n\n\towl_clockevent.cpumask = cpumask_of(0);\n\towl_clockevent.irq = timer1_irq;\n\n\tclockevents_config_and_register(&owl_clockevent, rate,\n\t\t\t\t\t0xf, 0xffffffff);\n\n\treturn 0;\n}\nTIMER_OF_DECLARE(owl_s500, \"actions,s500-timer\", owl_timer_init);\nTIMER_OF_DECLARE(owl_s700, \"actions,s700-timer\", owl_timer_init);\nTIMER_OF_DECLARE(owl_s900, \"actions,s900-timer\", owl_timer_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}