{
  "module_name": "timer-meson6.c",
  "hash_id": "5cc52fde73feace3a9cabafa8edae5b68d3c25189fe0076681d170f35f3c5c04",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clocksource/timer-meson6.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/bitops.h>\n#include <linux/clk.h>\n#include <linux/clockchips.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/irqreturn.h>\n#include <linux/sched_clock.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n\n#ifdef CONFIG_ARM\n#include <linux/delay.h>\n#endif\n\n#define MESON_ISA_TIMER_MUX\t\t\t\t\t0x00\n#define MESON_ISA_TIMER_MUX_TIMERD_EN\t\t\t\tBIT(19)\n#define MESON_ISA_TIMER_MUX_TIMERC_EN\t\t\t\tBIT(18)\n#define MESON_ISA_TIMER_MUX_TIMERB_EN\t\t\t\tBIT(17)\n#define MESON_ISA_TIMER_MUX_TIMERA_EN\t\t\t\tBIT(16)\n#define MESON_ISA_TIMER_MUX_TIMERD_MODE\t\t\t\tBIT(15)\n#define MESON_ISA_TIMER_MUX_TIMERC_MODE\t\t\t\tBIT(14)\n#define MESON_ISA_TIMER_MUX_TIMERB_MODE\t\t\t\tBIT(13)\n#define MESON_ISA_TIMER_MUX_TIMERA_MODE\t\t\t\tBIT(12)\n#define MESON_ISA_TIMER_MUX_TIMERE_INPUT_CLOCK_MASK\t\tGENMASK(10, 8)\n#define MESON_ISA_TIMER_MUX_TIMERE_INPUT_CLOCK_SYSTEM_CLOCK\t0x0\n#define MESON_ISA_TIMER_MUX_TIMERE_INPUT_CLOCK_1US\t\t0x1\n#define MESON_ISA_TIMER_MUX_TIMERE_INPUT_CLOCK_10US\t\t0x2\n#define MESON_ISA_TIMER_MUX_TIMERE_INPUT_CLOCK_100US\t\t0x3\n#define MESON_ISA_TIMER_MUX_TIMERE_INPUT_CLOCK_1MS\t\t0x4\n#define MESON_ISA_TIMER_MUX_TIMERD_INPUT_CLOCK_MASK\t\tGENMASK(7, 6)\n#define MESON_ISA_TIMER_MUX_TIMERC_INPUT_CLOCK_MASK\t\tGENMASK(5, 4)\n#define MESON_ISA_TIMER_MUX_TIMERB_INPUT_CLOCK_MASK\t\tGENMASK(3, 2)\n#define MESON_ISA_TIMER_MUX_TIMERA_INPUT_CLOCK_MASK\t\tGENMASK(1, 0)\n#define MESON_ISA_TIMER_MUX_TIMERABCD_INPUT_CLOCK_1US\t\t0x0\n#define MESON_ISA_TIMER_MUX_TIMERABCD_INPUT_CLOCK_10US\t\t0x1\n#define MESON_ISA_TIMER_MUX_TIMERABCD_INPUT_CLOCK_100US\t\t0x0\n#define MESON_ISA_TIMER_MUX_TIMERABCD_INPUT_CLOCK_1MS\t\t0x3\n\n#define MESON_ISA_TIMERA\t\t\t\t\t0x04\n#define MESON_ISA_TIMERB\t\t\t\t\t0x08\n#define MESON_ISA_TIMERC\t\t\t\t\t0x0c\n#define MESON_ISA_TIMERD\t\t\t\t\t0x10\n#define MESON_ISA_TIMERE\t\t\t\t\t0x14\n\nstatic void __iomem *timer_base;\n\n#ifdef CONFIG_ARM\nstatic unsigned long meson6_read_current_timer(void)\n{\n\treturn readl_relaxed(timer_base + MESON_ISA_TIMERE);\n}\n\nstatic struct delay_timer meson6_delay_timer = {\n\t.read_current_timer = meson6_read_current_timer,\n\t.freq = 1000 * 1000,\n};\n#endif\n\nstatic u64 notrace meson6_timer_sched_read(void)\n{\n\treturn (u64)readl(timer_base + MESON_ISA_TIMERE);\n}\n\nstatic void meson6_clkevt_time_stop(void)\n{\n\tu32 val = readl(timer_base + MESON_ISA_TIMER_MUX);\n\n\twritel(val & ~MESON_ISA_TIMER_MUX_TIMERA_EN,\n\t       timer_base + MESON_ISA_TIMER_MUX);\n}\n\nstatic void meson6_clkevt_time_setup(unsigned long delay)\n{\n\twritel(delay, timer_base + MESON_ISA_TIMERA);\n}\n\nstatic void meson6_clkevt_time_start(bool periodic)\n{\n\tu32 val = readl(timer_base + MESON_ISA_TIMER_MUX);\n\n\tif (periodic)\n\t\tval |= MESON_ISA_TIMER_MUX_TIMERA_MODE;\n\telse\n\t\tval &= ~MESON_ISA_TIMER_MUX_TIMERA_MODE;\n\n\twritel(val | MESON_ISA_TIMER_MUX_TIMERA_EN,\n\t       timer_base + MESON_ISA_TIMER_MUX);\n}\n\nstatic int meson6_shutdown(struct clock_event_device *evt)\n{\n\tmeson6_clkevt_time_stop();\n\treturn 0;\n}\n\nstatic int meson6_set_oneshot(struct clock_event_device *evt)\n{\n\tmeson6_clkevt_time_stop();\n\tmeson6_clkevt_time_start(false);\n\treturn 0;\n}\n\nstatic int meson6_set_periodic(struct clock_event_device *evt)\n{\n\tmeson6_clkevt_time_stop();\n\tmeson6_clkevt_time_setup(USEC_PER_SEC / HZ - 1);\n\tmeson6_clkevt_time_start(true);\n\treturn 0;\n}\n\nstatic int meson6_clkevt_next_event(unsigned long evt,\n\t\t\t\t    struct clock_event_device *unused)\n{\n\tmeson6_clkevt_time_stop();\n\tmeson6_clkevt_time_setup(evt);\n\tmeson6_clkevt_time_start(false);\n\n\treturn 0;\n}\n\nstatic struct clock_event_device meson6_clockevent = {\n\t.name\t\t\t= \"meson6_tick\",\n\t.rating\t\t\t= 400,\n\t.features\t\t= CLOCK_EVT_FEAT_PERIODIC |\n\t\t\t\t  CLOCK_EVT_FEAT_ONESHOT,\n\t.set_state_shutdown\t= meson6_shutdown,\n\t.set_state_periodic\t= meson6_set_periodic,\n\t.set_state_oneshot\t= meson6_set_oneshot,\n\t.tick_resume\t\t= meson6_shutdown,\n\t.set_next_event\t\t= meson6_clkevt_next_event,\n};\n\nstatic irqreturn_t meson6_timer_interrupt(int irq, void *dev_id)\n{\n\tstruct clock_event_device *evt = (struct clock_event_device *)dev_id;\n\n\tevt->event_handler(evt);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int __init meson6_timer_init(struct device_node *node)\n{\n\tu32 val;\n\tint ret, irq;\n\n\ttimer_base = of_io_request_and_map(node, 0, \"meson6-timer\");\n\tif (IS_ERR(timer_base)) {\n\t\tpr_err(\"Can't map registers\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\tirq = irq_of_parse_and_map(node, 0);\n\tif (irq <= 0) {\n\t\tpr_err(\"Can't parse IRQ\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tval = readl(timer_base + MESON_ISA_TIMER_MUX);\n\tval &= ~MESON_ISA_TIMER_MUX_TIMERE_INPUT_CLOCK_MASK;\n\tval |= FIELD_PREP(MESON_ISA_TIMER_MUX_TIMERE_INPUT_CLOCK_MASK,\n\t\t\t  MESON_ISA_TIMER_MUX_TIMERE_INPUT_CLOCK_1US);\n\twritel(val, timer_base + MESON_ISA_TIMER_MUX);\n\n\tsched_clock_register(meson6_timer_sched_read, 32, USEC_PER_SEC);\n\tclocksource_mmio_init(timer_base + MESON_ISA_TIMERE, node->name,\n\t\t\t      1000 * 1000, 300, 32, clocksource_mmio_readl_up);\n\n\t \n\tval &= ~MESON_ISA_TIMER_MUX_TIMERA_INPUT_CLOCK_MASK;\n\tval |= FIELD_PREP(MESON_ISA_TIMER_MUX_TIMERA_INPUT_CLOCK_MASK,\n\t\t\t  MESON_ISA_TIMER_MUX_TIMERABCD_INPUT_CLOCK_1US);\n\twritel(val, timer_base + MESON_ISA_TIMER_MUX);\n\n\t \n\tmeson6_clkevt_time_stop();\n\n\tret = request_irq(irq, meson6_timer_interrupt,\n\t\t\t  IRQF_TIMER | IRQF_IRQPOLL, \"meson6_timer\",\n\t\t\t  &meson6_clockevent);\n\tif (ret) {\n\t\tpr_warn(\"failed to setup irq %d\\n\", irq);\n\t\treturn ret;\n\t}\n\n\tmeson6_clockevent.cpumask = cpu_possible_mask;\n\tmeson6_clockevent.irq = irq;\n\n\tclockevents_config_and_register(&meson6_clockevent, USEC_PER_SEC,\n\t\t\t\t\t1, 0xfffe);\n\n#ifdef CONFIG_ARM\n\t \n\tregister_current_timer_delay(&meson6_delay_timer);\n#endif\n\n\treturn 0;\n}\nTIMER_OF_DECLARE(meson6, \"amlogic,meson6-timer\",\n\t\t       meson6_timer_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}