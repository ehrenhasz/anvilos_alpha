{
  "module_name": "bcm_kona_timer.c",
  "hash_id": "adcd3cfe4cc93aefa9efa2a9b00b4b7f5529750b1713f9e0140147bdba9af762",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clocksource/bcm_kona_timer.c",
  "human_readable_source": "\n\n\n#include <linux/init.h>\n#include <linux/irq.h>\n#include <linux/interrupt.h>\n#include <linux/jiffies.h>\n#include <linux/clockchips.h>\n#include <linux/types.h>\n#include <linux/clk.h>\n\n#include <linux/io.h>\n\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n\n\n#define KONA_GPTIMER_STCS_OFFSET\t\t\t0x00000000\n#define KONA_GPTIMER_STCLO_OFFSET\t\t\t0x00000004\n#define KONA_GPTIMER_STCHI_OFFSET\t\t\t0x00000008\n#define KONA_GPTIMER_STCM0_OFFSET\t\t\t0x0000000C\n\n#define KONA_GPTIMER_STCS_TIMER_MATCH_SHIFT\t\t0\n#define KONA_GPTIMER_STCS_COMPARE_ENABLE_SHIFT\t\t4\n\nstruct kona_bcm_timers {\n\tint tmr_irq;\n\tvoid __iomem *tmr_regs;\n};\n\nstatic struct kona_bcm_timers timers;\n\nstatic u32 arch_timer_rate;\n\n \nstatic void kona_timer_disable_and_clear(void __iomem *base)\n{\n\tuint32_t reg;\n\n\t \n\treg = readl(base + KONA_GPTIMER_STCS_OFFSET);\n\n\t \n\treg |= 1 << KONA_GPTIMER_STCS_TIMER_MATCH_SHIFT;\n\t \n\treg &= ~(1 << KONA_GPTIMER_STCS_COMPARE_ENABLE_SHIFT);\n\n\twritel(reg, base + KONA_GPTIMER_STCS_OFFSET);\n\n}\n\nstatic int\nkona_timer_get_counter(void __iomem *timer_base, uint32_t *msw, uint32_t *lsw)\n{\n\tint loop_limit = 3;\n\n\t \n\n\tdo {\n\t\t*msw = readl(timer_base + KONA_GPTIMER_STCHI_OFFSET);\n\t\t*lsw = readl(timer_base + KONA_GPTIMER_STCLO_OFFSET);\n\t\tif (*msw == readl(timer_base + KONA_GPTIMER_STCHI_OFFSET))\n\t\t\tbreak;\n\t} while (--loop_limit);\n\tif (!loop_limit) {\n\t\tpr_err(\"bcm_kona_timer: getting counter failed.\\n\");\n\t\tpr_err(\" Timer will be impacted\\n\");\n\t\treturn -ETIMEDOUT;\n\t}\n\n\treturn 0;\n}\n\nstatic int kona_timer_set_next_event(unsigned long clc,\n\t\t\t\t  struct clock_event_device *unused)\n{\n\t \n\n\tuint32_t lsw, msw;\n\tuint32_t reg;\n\tint ret;\n\n\tret = kona_timer_get_counter(timers.tmr_regs, &msw, &lsw);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\twritel(lsw + clc, timers.tmr_regs + KONA_GPTIMER_STCM0_OFFSET);\n\n\t \n\treg = readl(timers.tmr_regs + KONA_GPTIMER_STCS_OFFSET);\n\treg |= (1 << KONA_GPTIMER_STCS_COMPARE_ENABLE_SHIFT);\n\twritel(reg, timers.tmr_regs + KONA_GPTIMER_STCS_OFFSET);\n\n\treturn 0;\n}\n\nstatic int kona_timer_shutdown(struct clock_event_device *evt)\n{\n\tkona_timer_disable_and_clear(timers.tmr_regs);\n\treturn 0;\n}\n\nstatic struct clock_event_device kona_clockevent_timer = {\n\t.name = \"timer 1\",\n\t.features = CLOCK_EVT_FEAT_ONESHOT,\n\t.set_next_event = kona_timer_set_next_event,\n\t.set_state_shutdown = kona_timer_shutdown,\n\t.tick_resume = kona_timer_shutdown,\n};\n\nstatic void __init kona_timer_clockevents_init(void)\n{\n\tkona_clockevent_timer.cpumask = cpumask_of(0);\n\tclockevents_config_and_register(&kona_clockevent_timer,\n\t\tarch_timer_rate, 6, 0xffffffff);\n}\n\nstatic irqreturn_t kona_timer_interrupt(int irq, void *dev_id)\n{\n\tstruct clock_event_device *evt = &kona_clockevent_timer;\n\n\tkona_timer_disable_and_clear(timers.tmr_regs);\n\tevt->event_handler(evt);\n\treturn IRQ_HANDLED;\n}\n\nstatic int __init kona_timer_init(struct device_node *node)\n{\n\tu32 freq;\n\tstruct clk *external_clk;\n\n\texternal_clk = of_clk_get_by_name(node, NULL);\n\n\tif (!IS_ERR(external_clk)) {\n\t\tarch_timer_rate = clk_get_rate(external_clk);\n\t\tclk_prepare_enable(external_clk);\n\t} else if (!of_property_read_u32(node, \"clock-frequency\", &freq)) {\n\t\tarch_timer_rate = freq;\n\t} else {\n\t\tpr_err(\"Kona Timer v1 unable to determine clock-frequency\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\ttimers.tmr_irq = irq_of_parse_and_map(node, 0);\n\n\t \n\ttimers.tmr_regs = of_iomap(node, 0);\n\n\tkona_timer_disable_and_clear(timers.tmr_regs);\n\n\tkona_timer_clockevents_init();\n\tif (request_irq(timers.tmr_irq, kona_timer_interrupt, IRQF_TIMER,\n\t\t\t\"Kona Timer Tick\", NULL))\n\t\tpr_err(\"%s: request_irq() failed\\n\", \"Kona Timer Tick\");\n\tkona_timer_set_next_event((arch_timer_rate / HZ), NULL);\n\n\treturn 0;\n}\n\nTIMER_OF_DECLARE(brcm_kona, \"brcm,kona-timer\", kona_timer_init);\n \nTIMER_OF_DECLARE(bcm_kona, \"bcm,kona-timer\", kona_timer_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}