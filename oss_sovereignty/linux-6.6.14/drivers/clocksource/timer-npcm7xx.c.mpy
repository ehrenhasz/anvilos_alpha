{
  "module_name": "timer-npcm7xx.c",
  "hash_id": "5b4693584cb1f77f86717fb0b8f7a4171e729e399c39a2de56837aafd64a0cae",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clocksource/timer-npcm7xx.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/sched.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/err.h>\n#include <linux/clk.h>\n#include <linux/io.h>\n#include <linux/clockchips.h>\n#include <linux/of_irq.h>\n#include <linux/of_address.h>\n#include \"timer-of.h\"\n\n \n#define NPCM7XX_REG_TCSR0\t0x0  \n#define NPCM7XX_REG_TICR0\t0x8  \n#define NPCM7XX_REG_TCSR1\t0x4  \n#define NPCM7XX_REG_TICR1\t0xc  \n#define NPCM7XX_REG_TDR1\t0x14  \n#define NPCM7XX_REG_TISR\t0x18  \n\n \n#define NPCM7XX_Tx_RESETINT\t\t0x1f\n#define NPCM7XX_Tx_PERIOD\t\tBIT(27)\n#define NPCM7XX_Tx_INTEN\t\tBIT(29)\n#define NPCM7XX_Tx_COUNTEN\t\tBIT(30)\n#define NPCM7XX_Tx_ONESHOT\t\t0x0\n#define NPCM7XX_Tx_OPER\t\t\tGENMASK(28, 27)\n#define NPCM7XX_Tx_MIN_PRESCALE\t\t0x1\n#define NPCM7XX_Tx_TDR_MASK_BITS\t24\n#define NPCM7XX_Tx_MAX_CNT\t\t0xFFFFFF\n#define NPCM7XX_T0_CLR_INT\t\t0x1\n#define NPCM7XX_Tx_CLR_CSR\t\t0x0\n\n \n#define NPCM7XX_START_PERIODIC_Tx (NPCM7XX_Tx_PERIOD | NPCM7XX_Tx_COUNTEN | \\\n\t\t\t\t\tNPCM7XX_Tx_INTEN | \\\n\t\t\t\t\tNPCM7XX_Tx_MIN_PRESCALE)\n\n#define NPCM7XX_START_ONESHOT_Tx (NPCM7XX_Tx_ONESHOT | NPCM7XX_Tx_COUNTEN | \\\n\t\t\t\t\tNPCM7XX_Tx_INTEN | \\\n\t\t\t\t\tNPCM7XX_Tx_MIN_PRESCALE)\n\n#define NPCM7XX_START_Tx (NPCM7XX_Tx_COUNTEN | NPCM7XX_Tx_PERIOD | \\\n\t\t\t\tNPCM7XX_Tx_MIN_PRESCALE)\n\n#define NPCM7XX_DEFAULT_CSR (NPCM7XX_Tx_CLR_CSR | NPCM7XX_Tx_MIN_PRESCALE)\n\nstatic int npcm7xx_timer_resume(struct clock_event_device *evt)\n{\n\tstruct timer_of *to = to_timer_of(evt);\n\tu32 val;\n\n\tval = readl(timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\tval |= NPCM7XX_Tx_COUNTEN;\n\twritel(val, timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\n\treturn 0;\n}\n\nstatic int npcm7xx_timer_shutdown(struct clock_event_device *evt)\n{\n\tstruct timer_of *to = to_timer_of(evt);\n\tu32 val;\n\n\tval = readl(timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\tval &= ~NPCM7XX_Tx_COUNTEN;\n\twritel(val, timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\n\treturn 0;\n}\n\nstatic int npcm7xx_timer_oneshot(struct clock_event_device *evt)\n{\n\tstruct timer_of *to = to_timer_of(evt);\n\tu32 val;\n\n\tval = readl(timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\tval &= ~NPCM7XX_Tx_OPER;\n\tval |= NPCM7XX_START_ONESHOT_Tx;\n\twritel(val, timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\n\treturn 0;\n}\n\nstatic int npcm7xx_timer_periodic(struct clock_event_device *evt)\n{\n\tstruct timer_of *to = to_timer_of(evt);\n\tu32 val;\n\n\twritel(timer_of_period(to), timer_of_base(to) + NPCM7XX_REG_TICR0);\n\n\tval = readl(timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\tval &= ~NPCM7XX_Tx_OPER;\n\tval |= NPCM7XX_START_PERIODIC_Tx;\n\twritel(val, timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\n\treturn 0;\n}\n\nstatic int npcm7xx_clockevent_set_next_event(unsigned long evt,\n\t\tstruct clock_event_device *clk)\n{\n\tstruct timer_of *to = to_timer_of(clk);\n\tu32 val;\n\n\twritel(evt, timer_of_base(to) + NPCM7XX_REG_TICR0);\n\tval = readl(timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\tval |= NPCM7XX_START_Tx;\n\twritel(val, timer_of_base(to) + NPCM7XX_REG_TCSR0);\n\n\treturn 0;\n}\n\nstatic irqreturn_t npcm7xx_timer0_interrupt(int irq, void *dev_id)\n{\n\tstruct clock_event_device *evt = (struct clock_event_device *)dev_id;\n\tstruct timer_of *to = to_timer_of(evt);\n\n\twritel(NPCM7XX_T0_CLR_INT, timer_of_base(to) + NPCM7XX_REG_TISR);\n\n\tevt->event_handler(evt);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic struct timer_of npcm7xx_to = {\n\t.flags = TIMER_OF_IRQ | TIMER_OF_BASE | TIMER_OF_CLOCK,\n\n\t.clkevt = {\n\t\t.name\t\t    = \"npcm7xx-timer0\",\n\t\t.features\t    = CLOCK_EVT_FEAT_PERIODIC |\n\t\t\t\t      CLOCK_EVT_FEAT_ONESHOT,\n\t\t.set_next_event\t    = npcm7xx_clockevent_set_next_event,\n\t\t.set_state_shutdown = npcm7xx_timer_shutdown,\n\t\t.set_state_periodic = npcm7xx_timer_periodic,\n\t\t.set_state_oneshot  = npcm7xx_timer_oneshot,\n\t\t.tick_resume\t    = npcm7xx_timer_resume,\n\t\t.rating\t\t    = 300,\n\t},\n\n\t.of_irq = {\n\t\t.handler = npcm7xx_timer0_interrupt,\n\t\t.flags = IRQF_TIMER | IRQF_IRQPOLL,\n\t},\n};\n\nstatic void __init npcm7xx_clockevents_init(void)\n{\n\twritel(NPCM7XX_DEFAULT_CSR,\n\t\ttimer_of_base(&npcm7xx_to) + NPCM7XX_REG_TCSR0);\n\n\twritel(NPCM7XX_Tx_RESETINT,\n\t\ttimer_of_base(&npcm7xx_to) + NPCM7XX_REG_TISR);\n\n\tnpcm7xx_to.clkevt.cpumask = cpumask_of(0);\n\tclockevents_config_and_register(&npcm7xx_to.clkevt,\n\t\t\t\t\ttimer_of_rate(&npcm7xx_to),\n\t\t\t\t\t0x1, NPCM7XX_Tx_MAX_CNT);\n}\n\nstatic void __init npcm7xx_clocksource_init(void)\n{\n\tu32 val;\n\n\twritel(NPCM7XX_DEFAULT_CSR,\n\t\ttimer_of_base(&npcm7xx_to) + NPCM7XX_REG_TCSR1);\n\twritel(NPCM7XX_Tx_MAX_CNT,\n\t\ttimer_of_base(&npcm7xx_to) + NPCM7XX_REG_TICR1);\n\n\tval = readl(timer_of_base(&npcm7xx_to) + NPCM7XX_REG_TCSR1);\n\tval |= NPCM7XX_START_Tx;\n\twritel(val, timer_of_base(&npcm7xx_to) + NPCM7XX_REG_TCSR1);\n\n\tclocksource_mmio_init(timer_of_base(&npcm7xx_to) +\n\t\t\t\tNPCM7XX_REG_TDR1,\n\t\t\t\t\"npcm7xx-timer1\", timer_of_rate(&npcm7xx_to),\n\t\t\t\t200, (unsigned int)NPCM7XX_Tx_TDR_MASK_BITS,\n\t\t\t\tclocksource_mmio_readl_down);\n}\n\nstatic int __init npcm7xx_timer_init(struct device_node *np)\n{\n\tstruct clk *clk;\n\tint ret;\n\n\tret = timer_of_init(np, &npcm7xx_to);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\t \n\tnpcm7xx_to.of_clk.rate = npcm7xx_to.of_clk.rate /\n\t\t(NPCM7XX_Tx_MIN_PRESCALE + 1);\n\n\t \n\tclk = of_clk_get(np, 1);\n\tif (clk) {\n\t\tif (!IS_ERR(clk))\n\t\t\tclk_prepare_enable(clk);\n\t\telse\n\t\t\tpr_warn(\"%pOF: Failed to get clock for timer1: %pe\", np, clk);\n\t}\n\n\tnpcm7xx_clocksource_init();\n\tnpcm7xx_clockevents_init();\n\n\tpr_info(\"Enabling NPCM7xx clocksource timer base: %px, IRQ: %d \",\n\t\ttimer_of_base(&npcm7xx_to), timer_of_irq(&npcm7xx_to));\n\n\treturn 0;\n}\n\nTIMER_OF_DECLARE(wpcm450, \"nuvoton,wpcm450-timer\", npcm7xx_timer_init);\nTIMER_OF_DECLARE(npcm7xx, \"nuvoton,npcm750-timer\", npcm7xx_timer_init);\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}