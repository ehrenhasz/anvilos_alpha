{
  "module_name": "timer-milbeaut.c",
  "hash_id": "48e48244c934fd0fefe922897b89cd65432a88873eef2972ec211fb7b9d04adc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clocksource/timer-milbeaut.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/irqreturn.h>\n#include <linux/sched_clock.h>\n#include \"timer-of.h\"\n\n#define MLB_TMR_TMCSR_OFS\t0x0\n#define MLB_TMR_TMR_OFS\t\t0x4\n#define MLB_TMR_TMRLR1_OFS\t0x8\n#define MLB_TMR_TMRLR2_OFS\t0xc\n#define MLB_TMR_REGSZPCH\t0x10\n\n#define MLB_TMR_TMCSR_OUTL\tBIT(5)\n#define MLB_TMR_TMCSR_RELD\tBIT(4)\n#define MLB_TMR_TMCSR_INTE\tBIT(3)\n#define MLB_TMR_TMCSR_UF\tBIT(2)\n#define MLB_TMR_TMCSR_CNTE\tBIT(1)\n#define MLB_TMR_TMCSR_TRG\tBIT(0)\n\n#define MLB_TMR_TMCSR_CSL_DIV2\t0\n#define MLB_TMR_DIV_CNT\t\t2\n\n#define MLB_TMR_SRC_CH\t\t1\n#define MLB_TMR_EVT_CH\t\t0\n\n#define MLB_TMR_SRC_CH_OFS\t(MLB_TMR_REGSZPCH * MLB_TMR_SRC_CH)\n#define MLB_TMR_EVT_CH_OFS\t(MLB_TMR_REGSZPCH * MLB_TMR_EVT_CH)\n\n#define MLB_TMR_SRC_TMCSR_OFS\t(MLB_TMR_SRC_CH_OFS + MLB_TMR_TMCSR_OFS)\n#define MLB_TMR_SRC_TMR_OFS\t(MLB_TMR_SRC_CH_OFS + MLB_TMR_TMR_OFS)\n#define MLB_TMR_SRC_TMRLR1_OFS\t(MLB_TMR_SRC_CH_OFS + MLB_TMR_TMRLR1_OFS)\n#define MLB_TMR_SRC_TMRLR2_OFS\t(MLB_TMR_SRC_CH_OFS + MLB_TMR_TMRLR2_OFS)\n\n#define MLB_TMR_EVT_TMCSR_OFS\t(MLB_TMR_EVT_CH_OFS + MLB_TMR_TMCSR_OFS)\n#define MLB_TMR_EVT_TMR_OFS\t(MLB_TMR_EVT_CH_OFS + MLB_TMR_TMR_OFS)\n#define MLB_TMR_EVT_TMRLR1_OFS\t(MLB_TMR_EVT_CH_OFS + MLB_TMR_TMRLR1_OFS)\n#define MLB_TMR_EVT_TMRLR2_OFS\t(MLB_TMR_EVT_CH_OFS + MLB_TMR_TMRLR2_OFS)\n\n#define MLB_TIMER_RATING\t500\n#define MLB_TIMER_ONESHOT\t0\n#define MLB_TIMER_PERIODIC\t1\n\nstatic irqreturn_t mlb_timer_interrupt(int irq, void *dev_id)\n{\n\tstruct clock_event_device *clk = dev_id;\n\tstruct timer_of *to = to_timer_of(clk);\n\tu32 val;\n\n\tval = readl_relaxed(timer_of_base(to) + MLB_TMR_EVT_TMCSR_OFS);\n\tval &= ~MLB_TMR_TMCSR_UF;\n\twritel_relaxed(val, timer_of_base(to) + MLB_TMR_EVT_TMCSR_OFS);\n\n\tclk->event_handler(clk);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void mlb_evt_timer_start(struct timer_of *to, bool periodic)\n{\n\tu32 val = MLB_TMR_TMCSR_CSL_DIV2;\n\n\tval |= MLB_TMR_TMCSR_CNTE | MLB_TMR_TMCSR_TRG | MLB_TMR_TMCSR_INTE;\n\tif (periodic)\n\t\tval |= MLB_TMR_TMCSR_RELD;\n\twritel_relaxed(val, timer_of_base(to) + MLB_TMR_EVT_TMCSR_OFS);\n}\n\nstatic void mlb_evt_timer_stop(struct timer_of *to)\n{\n\tu32 val = readl_relaxed(timer_of_base(to) + MLB_TMR_EVT_TMCSR_OFS);\n\n\tval &= ~MLB_TMR_TMCSR_CNTE;\n\twritel_relaxed(val, timer_of_base(to) + MLB_TMR_EVT_TMCSR_OFS);\n}\n\nstatic void mlb_evt_timer_register_count(struct timer_of *to, unsigned long cnt)\n{\n\twritel_relaxed(cnt, timer_of_base(to) + MLB_TMR_EVT_TMRLR1_OFS);\n}\n\nstatic int mlb_set_state_periodic(struct clock_event_device *clk)\n{\n\tstruct timer_of *to = to_timer_of(clk);\n\n\tmlb_evt_timer_stop(to);\n\tmlb_evt_timer_register_count(to, to->of_clk.period);\n\tmlb_evt_timer_start(to, MLB_TIMER_PERIODIC);\n\treturn 0;\n}\n\nstatic int mlb_set_state_oneshot(struct clock_event_device *clk)\n{\n\tstruct timer_of *to = to_timer_of(clk);\n\n\tmlb_evt_timer_stop(to);\n\tmlb_evt_timer_start(to, MLB_TIMER_ONESHOT);\n\treturn 0;\n}\n\nstatic int mlb_set_state_shutdown(struct clock_event_device *clk)\n{\n\tstruct timer_of *to = to_timer_of(clk);\n\n\tmlb_evt_timer_stop(to);\n\treturn 0;\n}\n\nstatic int mlb_clkevt_next_event(unsigned long event,\n\t\t\t\t   struct clock_event_device *clk)\n{\n\tstruct timer_of *to = to_timer_of(clk);\n\n\tmlb_evt_timer_stop(to);\n\tmlb_evt_timer_register_count(to, event);\n\tmlb_evt_timer_start(to, MLB_TIMER_ONESHOT);\n\treturn 0;\n}\n\nstatic int mlb_config_clock_source(struct timer_of *to)\n{\n\tu32 val = MLB_TMR_TMCSR_CSL_DIV2;\n\n\twritel_relaxed(val, timer_of_base(to) + MLB_TMR_SRC_TMCSR_OFS);\n\twritel_relaxed(~0, timer_of_base(to) + MLB_TMR_SRC_TMRLR1_OFS);\n\twritel_relaxed(~0, timer_of_base(to) + MLB_TMR_SRC_TMRLR2_OFS);\n\tval |= MLB_TMR_TMCSR_RELD | MLB_TMR_TMCSR_CNTE | MLB_TMR_TMCSR_TRG;\n\twritel_relaxed(val, timer_of_base(to) + MLB_TMR_SRC_TMCSR_OFS);\n\treturn 0;\n}\n\nstatic int mlb_config_clock_event(struct timer_of *to)\n{\n\twritel_relaxed(0, timer_of_base(to) + MLB_TMR_EVT_TMCSR_OFS);\n\treturn 0;\n}\n\nstatic struct timer_of to = {\n\t.flags = TIMER_OF_IRQ | TIMER_OF_BASE | TIMER_OF_CLOCK,\n\n\t.clkevt = {\n\t\t.name = \"mlb-clkevt\",\n\t\t.rating = MLB_TIMER_RATING,\n\t\t.cpumask = cpu_possible_mask,\n\t\t.features = CLOCK_EVT_FEAT_DYNIRQ | CLOCK_EVT_FEAT_ONESHOT,\n\t\t.set_state_oneshot = mlb_set_state_oneshot,\n\t\t.set_state_periodic = mlb_set_state_periodic,\n\t\t.set_state_shutdown = mlb_set_state_shutdown,\n\t\t.set_next_event = mlb_clkevt_next_event,\n\t},\n\n\t.of_irq = {\n\t\t.flags = IRQF_TIMER | IRQF_IRQPOLL,\n\t\t.handler = mlb_timer_interrupt,\n\t},\n};\n\nstatic u64 notrace mlb_timer_sched_read(void)\n{\n\treturn ~readl_relaxed(timer_of_base(&to) + MLB_TMR_SRC_TMR_OFS);\n}\n\nstatic int __init mlb_timer_init(struct device_node *node)\n{\n\tint ret;\n\tunsigned long rate;\n\n\tret = timer_of_init(node, &to);\n\tif (ret)\n\t\treturn ret;\n\n\trate = timer_of_rate(&to) / MLB_TMR_DIV_CNT;\n\tmlb_config_clock_source(&to);\n\tclocksource_mmio_init(timer_of_base(&to) + MLB_TMR_SRC_TMR_OFS,\n\t\tnode->name, rate, MLB_TIMER_RATING, 32,\n\t\tclocksource_mmio_readl_down);\n\tsched_clock_register(mlb_timer_sched_read, 32, rate);\n\tmlb_config_clock_event(&to);\n\tclockevents_config_and_register(&to.clkevt, timer_of_rate(&to), 15,\n\t\t0xffffffff);\n\treturn 0;\n}\nTIMER_OF_DECLARE(mlb_peritimer, \"socionext,milbeaut-timer\",\n\t\tmlb_timer_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}