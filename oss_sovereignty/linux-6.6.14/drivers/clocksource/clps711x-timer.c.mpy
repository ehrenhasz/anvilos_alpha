{
  "module_name": "clps711x-timer.c",
  "hash_id": "e96d1c9ffe56860b715457e8aaff02451e4453c40f4bb82dcb6a1c2add01ca36",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clocksource/clps711x-timer.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clockchips.h>\n#include <linux/clocksource.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n#include <linux/sched_clock.h>\n#include <linux/slab.h>\n\nenum {\n\tCLPS711X_CLKSRC_CLOCKSOURCE,\n\tCLPS711X_CLKSRC_CLOCKEVENT,\n};\n\nstatic void __iomem *tcd;\n\nstatic u64 notrace clps711x_sched_clock_read(void)\n{\n\treturn ~readw(tcd);\n}\n\nstatic void __init clps711x_clksrc_init(struct clk *clock, void __iomem *base)\n{\n\tunsigned long rate = clk_get_rate(clock);\n\n\ttcd = base;\n\n\tclocksource_mmio_init(tcd, \"clps711x-clocksource\", rate, 300, 16,\n\t\t\t      clocksource_mmio_readw_down);\n\n\tsched_clock_register(clps711x_sched_clock_read, 16, rate);\n}\n\nstatic irqreturn_t clps711x_timer_interrupt(int irq, void *dev_id)\n{\n\tstruct clock_event_device *evt = dev_id;\n\n\tevt->event_handler(evt);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int __init _clps711x_clkevt_init(struct clk *clock, void __iomem *base,\n\t\t\t\t\tunsigned int irq)\n{\n\tstruct clock_event_device *clkevt;\n\tunsigned long rate;\n\n\tclkevt = kzalloc(sizeof(*clkevt), GFP_KERNEL);\n\tif (!clkevt)\n\t\treturn -ENOMEM;\n\n\trate = clk_get_rate(clock);\n\n\t \n\twritew(DIV_ROUND_CLOSEST(rate, HZ), base);\n\n\tclkevt->name = \"clps711x-clockevent\";\n\tclkevt->rating = 300;\n\tclkevt->features = CLOCK_EVT_FEAT_PERIODIC | CLOCK_EVT_FEAT_C3STOP;\n\tclkevt->cpumask = cpumask_of(0);\n\tclockevents_config_and_register(clkevt, HZ, 0, 0);\n\n\treturn request_irq(irq, clps711x_timer_interrupt, IRQF_TIMER,\n\t\t\t   \"clps711x-timer\", clkevt);\n}\n\nstatic int __init clps711x_timer_init(struct device_node *np)\n{\n\tunsigned int irq = irq_of_parse_and_map(np, 0);\n\tstruct clk *clock = of_clk_get(np, 0);\n\tvoid __iomem *base = of_iomap(np, 0);\n\n\tif (!base)\n\t\treturn -ENOMEM;\n\tif (!irq)\n\t\treturn -EINVAL;\n\tif (IS_ERR(clock))\n\t\treturn PTR_ERR(clock);\n\n\tswitch (of_alias_get_id(np, \"timer\")) {\n\tcase CLPS711X_CLKSRC_CLOCKSOURCE:\n\t\tclps711x_clksrc_init(clock, base);\n\t\tbreak;\n\tcase CLPS711X_CLKSRC_CLOCKEVENT:\n\t\treturn _clps711x_clkevt_init(clock, base, irq);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\nTIMER_OF_DECLARE(clps711x, \"cirrus,ep7209-timer\", clps711x_timer_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}