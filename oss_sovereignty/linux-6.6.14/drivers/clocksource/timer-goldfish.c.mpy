{
  "module_name": "timer-goldfish.c",
  "hash_id": "0592d967b128436d7464336ad2490d3ac5e59fb64b905bb27e0c09e5a1ab9118",
  "original_prompt": "Ingested from linux-6.6.14/drivers/clocksource/timer-goldfish.c",
  "human_readable_source": "\n\n#include <linux/interrupt.h>\n#include <linux/ioport.h>\n#include <linux/clocksource.h>\n#include <linux/clockchips.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/goldfish.h>\n#include <clocksource/timer-goldfish.h>\n\nstruct goldfish_timer {\n\tstruct clocksource cs;\n\tstruct clock_event_device ced;\n\tstruct resource res;\n\tvoid __iomem *base;\n};\n\nstatic struct goldfish_timer *ced_to_gf(struct clock_event_device *ced)\n{\n\treturn container_of(ced, struct goldfish_timer, ced);\n}\n\nstatic struct goldfish_timer *cs_to_gf(struct clocksource *cs)\n{\n\treturn container_of(cs, struct goldfish_timer, cs);\n}\n\nstatic u64 goldfish_timer_read(struct clocksource *cs)\n{\n\tstruct goldfish_timer *timerdrv = cs_to_gf(cs);\n\tvoid __iomem *base = timerdrv->base;\n\tu32 time_low, time_high;\n\tu64 ticks;\n\n\t \n\ttime_low = gf_ioread32(base + TIMER_TIME_LOW);\n\ttime_high = gf_ioread32(base + TIMER_TIME_HIGH);\n\n\tticks = ((u64)time_high << 32) | time_low;\n\n\treturn ticks;\n}\n\nstatic int goldfish_timer_set_oneshot(struct clock_event_device *evt)\n{\n\tstruct goldfish_timer *timerdrv = ced_to_gf(evt);\n\tvoid __iomem *base = timerdrv->base;\n\n\tgf_iowrite32(0, base + TIMER_ALARM_HIGH);\n\tgf_iowrite32(0, base + TIMER_ALARM_LOW);\n\tgf_iowrite32(1, base + TIMER_IRQ_ENABLED);\n\n\treturn 0;\n}\n\nstatic int goldfish_timer_shutdown(struct clock_event_device *evt)\n{\n\tstruct goldfish_timer *timerdrv = ced_to_gf(evt);\n\tvoid __iomem *base = timerdrv->base;\n\n\tgf_iowrite32(0, base + TIMER_IRQ_ENABLED);\n\n\treturn 0;\n}\n\nstatic int goldfish_timer_next_event(unsigned long delta,\n\t\t\t\t     struct clock_event_device *evt)\n{\n\tstruct goldfish_timer *timerdrv = ced_to_gf(evt);\n\tvoid __iomem *base = timerdrv->base;\n\tu64 now;\n\n\tnow = goldfish_timer_read(&timerdrv->cs);\n\n\tnow += delta;\n\n\tgf_iowrite32(upper_32_bits(now), base + TIMER_ALARM_HIGH);\n\tgf_iowrite32(lower_32_bits(now), base + TIMER_ALARM_LOW);\n\n\treturn 0;\n}\n\nstatic irqreturn_t goldfish_timer_irq(int irq, void *dev_id)\n{\n\tstruct goldfish_timer *timerdrv = dev_id;\n\tstruct clock_event_device *evt = &timerdrv->ced;\n\tvoid __iomem *base = timerdrv->base;\n\n\tgf_iowrite32(1, base + TIMER_CLEAR_INTERRUPT);\n\n\tevt->event_handler(evt);\n\n\treturn IRQ_HANDLED;\n}\n\nint __init goldfish_timer_init(int irq, void __iomem *base)\n{\n\tstruct goldfish_timer *timerdrv;\n\tint ret;\n\n\ttimerdrv = kzalloc(sizeof(*timerdrv), GFP_KERNEL);\n\tif (!timerdrv)\n\t\treturn -ENOMEM;\n\n\ttimerdrv->base = base;\n\n\ttimerdrv->ced = (struct clock_event_device){\n\t\t.name\t\t\t= \"goldfish_timer\",\n\t\t.features\t\t= CLOCK_EVT_FEAT_ONESHOT,\n\t\t.set_state_shutdown\t= goldfish_timer_shutdown,\n\t\t.set_state_oneshot      = goldfish_timer_set_oneshot,\n\t\t.set_next_event\t\t= goldfish_timer_next_event,\n\t};\n\n\ttimerdrv->res = (struct resource){\n\t\t.name  = \"goldfish_timer\",\n\t\t.start = (unsigned long)base,\n\t\t.end   = (unsigned long)base + 0xfff,\n\t};\n\n\tret = request_resource(&iomem_resource, &timerdrv->res);\n\tif (ret) {\n\t\tpr_err(\"Cannot allocate '%s' resource\\n\", timerdrv->res.name);\n\t\treturn ret;\n\t}\n\n\ttimerdrv->cs = (struct clocksource){\n\t\t.name\t\t= \"goldfish_timer\",\n\t\t.rating\t\t= 400,\n\t\t.read\t\t= goldfish_timer_read,\n\t\t.mask\t\t= CLOCKSOURCE_MASK(64),\n\t\t.flags\t\t= 0,\n\t\t.max_idle_ns\t= LONG_MAX,\n\t};\n\n\tclocksource_register_hz(&timerdrv->cs, NSEC_PER_SEC);\n\n\tret = request_irq(irq, goldfish_timer_irq, IRQF_TIMER,\n\t\t\t  \"goldfish_timer\", timerdrv);\n\tif (ret) {\n\t\tpr_err(\"Couldn't register goldfish-timer interrupt\\n\");\n\t\treturn ret;\n\t}\n\n\tclockevents_config_and_register(&timerdrv->ced, NSEC_PER_SEC,\n\t\t\t\t\t1, 0xffffffff);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}