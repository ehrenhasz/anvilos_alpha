{
  "module_name": "fifo_icap.c",
  "hash_id": "c1fac5e561d14f892320ac1ed66ecc80bee5a87de8a993717944775594540974",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/xilinx_hwicap/fifo_icap.c",
  "human_readable_source": " \n\n#include \"fifo_icap.h\"\n\n \n#define XHI_GIER_OFFSET\t0x1C   \n#define XHI_IPISR_OFFSET 0x20   \n#define XHI_IPIER_OFFSET 0x28   \n#define XHI_WF_OFFSET 0x100  \n#define XHI_RF_OFFSET 0x104  \n#define XHI_SZ_OFFSET 0x108  \n#define XHI_CR_OFFSET 0x10C  \n#define XHI_SR_OFFSET 0x110  \n#define XHI_WFV_OFFSET 0x114  \n#define XHI_RFO_OFFSET 0x118  \n\n \n\n#define XHI_GIER_GIE_MASK 0x80000000  \n\n \n#define XHI_IPIXR_RFULL_MASK 0x00000008  \n#define XHI_IPIXR_WEMPTY_MASK 0x00000004  \n#define XHI_IPIXR_RDP_MASK 0x00000002  \n#define XHI_IPIXR_WRP_MASK 0x00000001  \n#define XHI_IPIXR_ALL_MASK 0x0000000F  \n\n \n#define XHI_CR_SW_RESET_MASK 0x00000008  \n#define XHI_CR_FIFO_CLR_MASK 0x00000004  \n#define XHI_CR_READ_MASK 0x00000002  \n#define XHI_CR_WRITE_MASK 0x00000001  \n\n\n#define XHI_WFO_MAX_VACANCY 1024  \n#define XHI_RFO_MAX_OCCUPANCY 256  \n \n#define XHI_MAX_READ_TRANSACTION_WORDS 0xFFF\n\n\n \nstatic inline void fifo_icap_fifo_write(struct hwicap_drvdata *drvdata,\n\t\tu32 data)\n{\n\tdev_dbg(drvdata->dev, \"fifo_write: %x\\n\", data);\n\tout_be32(drvdata->base_address + XHI_WF_OFFSET, data);\n}\n\n \nstatic inline u32 fifo_icap_fifo_read(struct hwicap_drvdata *drvdata)\n{\n\tu32 data = in_be32(drvdata->base_address + XHI_RF_OFFSET);\n\tdev_dbg(drvdata->dev, \"fifo_read: %x\\n\", data);\n\treturn data;\n}\n\n \nstatic inline void fifo_icap_set_read_size(struct hwicap_drvdata *drvdata,\n\t\tu32 data)\n{\n\tout_be32(drvdata->base_address + XHI_SZ_OFFSET, data);\n}\n\n \nstatic inline void fifo_icap_start_config(struct hwicap_drvdata *drvdata)\n{\n\tout_be32(drvdata->base_address + XHI_CR_OFFSET, XHI_CR_WRITE_MASK);\n\tdev_dbg(drvdata->dev, \"configuration started\\n\");\n}\n\n \nstatic inline void fifo_icap_start_readback(struct hwicap_drvdata *drvdata)\n{\n\tout_be32(drvdata->base_address + XHI_CR_OFFSET, XHI_CR_READ_MASK);\n\tdev_dbg(drvdata->dev, \"readback started\\n\");\n}\n\n \nu32 fifo_icap_get_status(struct hwicap_drvdata *drvdata)\n{\n\tu32 status = in_be32(drvdata->base_address + XHI_SR_OFFSET);\n\tdev_dbg(drvdata->dev, \"Getting status = %x\\n\", status);\n\treturn status;\n}\n\n \nstatic inline u32 fifo_icap_busy(struct hwicap_drvdata *drvdata)\n{\n\tu32 status = in_be32(drvdata->base_address + XHI_SR_OFFSET);\n\treturn (status & XHI_SR_DONE_MASK) ? 0 : 1;\n}\n\n \nstatic inline u32 fifo_icap_write_fifo_vacancy(\n\t\tstruct hwicap_drvdata *drvdata)\n{\n\treturn in_be32(drvdata->base_address + XHI_WFV_OFFSET);\n}\n\n \nstatic inline u32 fifo_icap_read_fifo_occupancy(\n\t\tstruct hwicap_drvdata *drvdata)\n{\n\treturn in_be32(drvdata->base_address + XHI_RFO_OFFSET);\n}\n\n \nint fifo_icap_set_configuration(struct hwicap_drvdata *drvdata,\n\t\tu32 *frame_buffer, u32 num_words)\n{\n\n\tu32 write_fifo_vacancy = 0;\n\tu32 retries = 0;\n\tu32 remaining_words;\n\n\tdev_dbg(drvdata->dev, \"fifo_set_configuration\\n\");\n\n\t \n\tif (fifo_icap_busy(drvdata))\n\t\treturn -EBUSY;\n\n\t \n\tremaining_words = num_words;\n\n\twhile (remaining_words > 0) {\n\t\t \n\t\twhile (write_fifo_vacancy == 0) {\n\t\t\twrite_fifo_vacancy =\n\t\t\t\tfifo_icap_write_fifo_vacancy(drvdata);\n\t\t\tretries++;\n\t\t\tif (retries > XHI_MAX_RETRIES)\n\t\t\t\treturn -EIO;\n\t\t}\n\n\t\t \n\t\twhile ((write_fifo_vacancy != 0) &&\n\t\t\t\t(remaining_words > 0)) {\n\t\t\tfifo_icap_fifo_write(drvdata, *frame_buffer);\n\n\t\t\tremaining_words--;\n\t\t\twrite_fifo_vacancy--;\n\t\t\tframe_buffer++;\n\t\t}\n\t\t \n\t\tfifo_icap_start_config(drvdata);\n\t}\n\n\t \n\twhile (fifo_icap_busy(drvdata)) {\n\t\tretries++;\n\t\tif (retries > XHI_MAX_RETRIES)\n\t\t\tbreak;\n\t}\n\n\tdev_dbg(drvdata->dev, \"done fifo_set_configuration\\n\");\n\n\t \n\tif (remaining_words != 0)\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\n \nint fifo_icap_get_configuration(struct hwicap_drvdata *drvdata,\n\t\tu32 *frame_buffer, u32 num_words)\n{\n\n\tu32 read_fifo_occupancy = 0;\n\tu32 retries = 0;\n\tu32 *data = frame_buffer;\n\tu32 remaining_words;\n\tu32 words_to_read;\n\n\tdev_dbg(drvdata->dev, \"fifo_get_configuration\\n\");\n\n\t \n\tif (fifo_icap_busy(drvdata))\n\t\treturn -EBUSY;\n\n\tremaining_words = num_words;\n\n\twhile (remaining_words > 0) {\n\t\twords_to_read = remaining_words;\n\t\t \n\t\tif (words_to_read > XHI_MAX_READ_TRANSACTION_WORDS)\n\t\t\twords_to_read = XHI_MAX_READ_TRANSACTION_WORDS;\n\n\t\tremaining_words -= words_to_read;\n\n\t\tfifo_icap_set_read_size(drvdata, words_to_read);\n\t\tfifo_icap_start_readback(drvdata);\n\n\t\twhile (words_to_read > 0) {\n\t\t\t \n\t\t\twhile (read_fifo_occupancy == 0) {\n\t\t\t\tread_fifo_occupancy =\n\t\t\t\t\tfifo_icap_read_fifo_occupancy(drvdata);\n\t\t\t\tretries++;\n\t\t\t\tif (retries > XHI_MAX_RETRIES)\n\t\t\t\t\treturn -EIO;\n\t\t\t}\n\n\t\t\tif (read_fifo_occupancy > words_to_read)\n\t\t\t\tread_fifo_occupancy = words_to_read;\n\n\t\t\twords_to_read -= read_fifo_occupancy;\n\n\t\t\t \n\t\t\twhile (read_fifo_occupancy != 0) {\n\t\t\t\t*data++ = fifo_icap_fifo_read(drvdata);\n\t\t\t\tread_fifo_occupancy--;\n\t\t\t}\n\t\t}\n\t}\n\n\tdev_dbg(drvdata->dev, \"done fifo_get_configuration\\n\");\n\n\treturn 0;\n}\n\n \nvoid fifo_icap_reset(struct hwicap_drvdata *drvdata)\n{\n\tu32 reg_data;\n\t \n\treg_data = in_be32(drvdata->base_address + XHI_CR_OFFSET);\n\n\tout_be32(drvdata->base_address + XHI_CR_OFFSET,\n\t\t\t\treg_data | XHI_CR_SW_RESET_MASK);\n\n\tout_be32(drvdata->base_address + XHI_CR_OFFSET,\n\t\t\t\treg_data & (~XHI_CR_SW_RESET_MASK));\n\n}\n\n \nvoid fifo_icap_flush_fifo(struct hwicap_drvdata *drvdata)\n{\n\tu32 reg_data;\n\t \n\treg_data = in_be32(drvdata->base_address + XHI_CR_OFFSET);\n\n\tout_be32(drvdata->base_address + XHI_CR_OFFSET,\n\t\t\t\treg_data | XHI_CR_FIFO_CLR_MASK);\n\n\tout_be32(drvdata->base_address + XHI_CR_OFFSET,\n\t\t\t\treg_data & (~XHI_CR_FIFO_CLR_MASK));\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}