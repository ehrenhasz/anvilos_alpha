{
  "module_name": "smapi.c",
  "hash_id": "62f66c4771d9cdb1ac17bfff1b62493a6bcbce20f52b838292e5783b89ded525",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/mwave/smapi.c",
  "human_readable_source": " \n\n#include <linux/kernel.h>\n#include <linux/mc146818rtc.h>\t \n#include \"smapi.h\"\n#include \"mwavedd.h\"\n\nstatic unsigned short g_usSmapiPort = 0;\n\n\nstatic int smapi_request(unsigned short inBX, unsigned short inCX,\n\t\t\t unsigned short inDI, unsigned short inSI,\n\t\t\t unsigned short *outAX, unsigned short *outBX,\n\t\t\t unsigned short *outCX, unsigned short *outDX,\n\t\t\t unsigned short *outDI, unsigned short *outSI)\n{\n\tunsigned short myoutAX = 2, *pmyoutAX = &myoutAX;\n\tunsigned short myoutBX = 3, *pmyoutBX = &myoutBX;\n\tunsigned short myoutCX = 4, *pmyoutCX = &myoutCX;\n\tunsigned short myoutDX = 5, *pmyoutDX = &myoutDX;\n\tunsigned short myoutDI = 6, *pmyoutDI = &myoutDI;\n\tunsigned short myoutSI = 7, *pmyoutSI = &myoutSI;\n\tunsigned short usSmapiOK = -EIO, *pusSmapiOK = &usSmapiOK;\n\tunsigned int inBXCX = (inBX << 16) | inCX;\n\tunsigned int inDISI = (inDI << 16) | inSI;\n\tint retval = 0;\n\n\tPRINTK_5(TRACE_SMAPI, \"inBX %x inCX %x inDI %x inSI %x\\n\",\n\t\tinBX, inCX, inDI, inSI);\n\n\t__asm__ __volatile__(\"movw  $0x5380,%%ax\\n\\t\"\n\t\t\t    \"movl  %7,%%ebx\\n\\t\"\n\t\t\t    \"shrl  $16, %%ebx\\n\\t\"\n\t\t\t    \"movw  %7,%%cx\\n\\t\"\n\t\t\t    \"movl  %8,%%edi\\n\\t\"\n\t\t\t    \"shrl  $16,%%edi\\n\\t\"\n\t\t\t    \"movw  %8,%%si\\n\\t\"\n\t\t\t    \"movw  %9,%%dx\\n\\t\"\n\t\t\t    \"out   %%al,%%dx\\n\\t\"\n\t\t\t    \"out   %%al,$0x4F\\n\\t\"\n\t\t\t    \"cmpb  $0x53,%%ah\\n\\t\"\n\t\t\t    \"je    2f\\n\\t\"\n\t\t\t    \"1:\\n\\t\"\n\t\t\t    \"orb   %%ah,%%ah\\n\\t\"\n\t\t\t    \"jnz   2f\\n\\t\"\n\t\t\t    \"movw  %%ax,%0\\n\\t\"\n\t\t\t    \"movw  %%bx,%1\\n\\t\"\n\t\t\t    \"movw  %%cx,%2\\n\\t\"\n\t\t\t    \"movw  %%dx,%3\\n\\t\"\n\t\t\t    \"movw  %%di,%4\\n\\t\"\n\t\t\t    \"movw  %%si,%5\\n\\t\"\n\t\t\t    \"movw  $1,%6\\n\\t\"\n\t\t\t    \"2:\\n\\t\":\"=m\"(*(unsigned short *) pmyoutAX),\n\t\t\t    \"=m\"(*(unsigned short *) pmyoutBX),\n\t\t\t    \"=m\"(*(unsigned short *) pmyoutCX),\n\t\t\t    \"=m\"(*(unsigned short *) pmyoutDX),\n\t\t\t    \"=m\"(*(unsigned short *) pmyoutDI),\n\t\t\t    \"=m\"(*(unsigned short *) pmyoutSI),\n\t\t\t    \"=m\"(*(unsigned short *) pusSmapiOK)\n\t\t\t    :\"m\"(inBXCX), \"m\"(inDISI), \"m\"(g_usSmapiPort)\n\t\t\t    :\"%eax\", \"%ebx\", \"%ecx\", \"%edx\", \"%edi\",\n\t\t\t    \"%esi\");\n\n\tPRINTK_8(TRACE_SMAPI,\n\t\t\"myoutAX %x myoutBX %x myoutCX %x myoutDX %x myoutDI %x myoutSI %x usSmapiOK %x\\n\",\n\t\tmyoutAX, myoutBX, myoutCX, myoutDX, myoutDI, myoutSI,\n\t\tusSmapiOK);\n\t*outAX = myoutAX;\n\t*outBX = myoutBX;\n\t*outCX = myoutCX;\n\t*outDX = myoutDX;\n\t*outDI = myoutDI;\n\t*outSI = myoutSI;\n\n\tretval = (usSmapiOK == 1) ? 0 : -EIO;\n\tPRINTK_2(TRACE_SMAPI, \"smapi::smapi_request exit retval %x\\n\", retval);\n\treturn retval;\n}\n\n\nint smapi_query_DSP_cfg(SMAPI_DSP_SETTINGS * pSettings)\n{\n\tint bRC;\n\tunsigned short usAX, usBX, usCX, usDX, usDI, usSI;\n\tstatic const unsigned short ausDspBases[] = {\n\t\t0x0030, 0x4E30, 0x8E30, 0xCE30,\n\t\t0x0130, 0x0350, 0x0070, 0x0DB0 };\n\tstatic const unsigned short ausUartBases[] = {\n\t\t0x03F8, 0x02F8, 0x03E8, 0x02E8 };\n\n\tPRINTK_1(TRACE_SMAPI, \"smapi::smapi_query_DSP_cfg entry\\n\");\n\n\tbRC = smapi_request(0x1802, 0x0000, 0, 0,\n\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\tif (bRC) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_query_DSP_cfg: Error: Could not get DSP Settings. Aborting.\\n\");\n\t\treturn bRC;\n\t}\n\n\tPRINTK_1(TRACE_SMAPI, \"smapi::smapi_query_DSP_cfg, smapi_request OK\\n\");\n\n\tpSettings->bDSPPresent = ((usBX & 0x0100) != 0);\n\tpSettings->bDSPEnabled = ((usCX & 0x0001) != 0);\n\tpSettings->usDspIRQ = usSI & 0x00FF;\n\tpSettings->usDspDMA = (usSI & 0xFF00) >> 8;\n\tif ((usDI & 0x00FF) < ARRAY_SIZE(ausDspBases)) {\n\t\tpSettings->usDspBaseIO = ausDspBases[usDI & 0x00FF];\n\t} else {\n\t\tpSettings->usDspBaseIO = 0;\n\t}\n\tPRINTK_6(TRACE_SMAPI,\n\t\t\"smapi::smapi_query_DSP_cfg get DSP Settings bDSPPresent %x bDSPEnabled %x usDspIRQ %x usDspDMA %x usDspBaseIO %x\\n\",\n\t\tpSettings->bDSPPresent, pSettings->bDSPEnabled,\n\t\tpSettings->usDspIRQ, pSettings->usDspDMA,\n\t\tpSettings->usDspBaseIO);\n\n\t \n\tif ( pSettings->usDspBaseIO == 0 ) \n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_query_DSP_cfg: Worry: DSP base I/O address is 0\\n\");\n\tif ( pSettings->usDspIRQ == 0 )\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_query_DSP_cfg: Worry: DSP IRQ line is 0\\n\");\n\n\tbRC = smapi_request(0x1804, 0x0000, 0, 0,\n\t   \t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\tif (bRC) {\n\t\tPRINTK_ERROR(\"smapi::smapi_query_DSP_cfg: Error: Could not get DSP modem settings. Aborting.\\n\");\n\t\treturn bRC;\n\t} \n\n\tPRINTK_1(TRACE_SMAPI, \"smapi::smapi_query_DSP_cfg, smapi_request OK\\n\");\n\n\tpSettings->bModemEnabled = ((usCX & 0x0001) != 0);\n\tpSettings->usUartIRQ = usSI & 0x000F;\n\tif (((usSI & 0xFF00) >> 8) < ARRAY_SIZE(ausUartBases)) {\n\t\tpSettings->usUartBaseIO = ausUartBases[(usSI & 0xFF00) >> 8];\n\t} else {\n\t\tpSettings->usUartBaseIO = 0;\n\t}\n\n\tPRINTK_4(TRACE_SMAPI,\n\t\t\"smapi::smapi_query_DSP_cfg get DSP modem settings bModemEnabled %x usUartIRQ %x usUartBaseIO %x\\n\",\n\t\tpSettings->bModemEnabled,\n\t\tpSettings->usUartIRQ,\n\t\tpSettings->usUartBaseIO);\n\n\t \n\tif ( pSettings->usUartBaseIO == 0 ) \n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_query_DSP_cfg: Worry: UART base I/O address is 0\\n\");\n\tif ( pSettings->usUartIRQ == 0 )\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_query_DSP_cfg: Worry: UART IRQ line is 0\\n\");\n\n\tPRINTK_2(TRACE_SMAPI, \"smapi::smapi_query_DSP_cfg exit bRC %x\\n\", bRC);\n\n\treturn bRC;\n}\n\n\nint smapi_set_DSP_cfg(void)\n{\n\tint bRC = -EIO;\n\tint i;\n\tunsigned short usAX, usBX, usCX, usDX, usDI, usSI;\n\tstatic const unsigned short ausDspBases[] = {\n\t\t0x0030, 0x4E30, 0x8E30, 0xCE30,\n\t\t0x0130, 0x0350, 0x0070, 0x0DB0 };\n\tstatic const unsigned short ausUartBases[] = {\n\t\t0x03F8, 0x02F8, 0x03E8, 0x02E8 };\n\tstatic const unsigned short ausDspIrqs[] = {\n\t\t5, 7, 10, 11, 15 };\n\tstatic const unsigned short ausUartIrqs[] = {\n\t\t3, 4 };\n\n\tunsigned short dspio_index = 0, uartio_index = 0;\n\n\tPRINTK_5(TRACE_SMAPI,\n\t\t\"smapi::smapi_set_DSP_cfg entry mwave_3780i_irq %x mwave_3780i_io %x mwave_uart_irq %x mwave_uart_io %x\\n\",\n\t\tmwave_3780i_irq, mwave_3780i_io, mwave_uart_irq, mwave_uart_io);\n\n\tif (mwave_3780i_io) {\n\t\tfor (i = 0; i < ARRAY_SIZE(ausDspBases); i++) {\n\t\t\tif (mwave_3780i_io == ausDspBases[i])\n\t\t\t\tbreak;\n\t\t}\n\t\tif (i == ARRAY_SIZE(ausDspBases)) {\n\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_set_DSP_cfg: Error: Invalid mwave_3780i_io address %x. Aborting.\\n\", mwave_3780i_io);\n\t\t\treturn bRC;\n\t\t}\n\t\tdspio_index = i;\n\t}\n\n\tif (mwave_3780i_irq) {\n\t\tfor (i = 0; i < ARRAY_SIZE(ausDspIrqs); i++) {\n\t\t\tif (mwave_3780i_irq == ausDspIrqs[i])\n\t\t\t\tbreak;\n\t\t}\n\t\tif (i == ARRAY_SIZE(ausDspIrqs)) {\n\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_set_DSP_cfg: Error: Invalid mwave_3780i_irq %x. Aborting.\\n\", mwave_3780i_irq);\n\t\t\treturn bRC;\n\t\t}\n\t}\n\n\tif (mwave_uart_io) {\n\t\tfor (i = 0; i < ARRAY_SIZE(ausUartBases); i++) {\n\t\t\tif (mwave_uart_io == ausUartBases[i])\n\t\t\t\tbreak;\n\t\t}\n\t\tif (i == ARRAY_SIZE(ausUartBases)) {\n\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_set_DSP_cfg: Error: Invalid mwave_uart_io address %x. Aborting.\\n\", mwave_uart_io);\n\t\t\treturn bRC;\n\t\t}\n\t\tuartio_index = i;\n\t}\n\n\n\tif (mwave_uart_irq) {\n\t\tfor (i = 0; i < ARRAY_SIZE(ausUartIrqs); i++) {\n\t\t\tif (mwave_uart_irq == ausUartIrqs[i])\n\t\t\t\tbreak;\n\t\t}\n\t\tif (i == ARRAY_SIZE(ausUartIrqs)) {\n\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_set_DSP_cfg: Error: Invalid mwave_uart_irq %x. Aborting.\\n\", mwave_uart_irq);\n\t\t\treturn bRC;\n\t\t}\n\t}\n\n\tif (mwave_uart_irq || mwave_uart_io) {\n\n\t\t \n\t\tbRC = smapi_request(0x1402, 0x0000, 0, 0,\n\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\tif (bRC) goto exit_smapi_request_error;\n\t\t \n\t\tif (usBX & 0x0100) {\t \n\t\t\tif (usCX & 1) {\t \n\t\t\t\tif ((usSI & 0xFF) == mwave_uart_irq) {\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE\n\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: Serial port A irq %x conflicts with mwave_uart_irq %x\\n\", usSI & 0xFF, mwave_uart_irq);\n#else\n\t\t\t\t\tPRINTK_3(TRACE_SMAPI,\n\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: Serial port A irq %x conflicts with mwave_uart_irq %x\\n\", usSI & 0xFF, mwave_uart_irq);\n#endif\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\tPRINTK_1(TRACE_SMAPI,\n\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg Disabling conflicting serial port\\n\");\n\t\t\t\t\tbRC = smapi_request(0x1403, 0x0100, 0, usSI,\n\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\t\tbRC = smapi_request(0x1402, 0x0000, 0, 0,\n\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n#else\n\t\t\t\t\tgoto exit_conflict;\n#endif\n\t\t\t\t} else {\n\t\t\t\t\tif ((usSI >> 8) == uartio_index) {\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE\n\t\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: Serial port A base I/O address %x conflicts with mwave uart I/O %x\\n\", ausUartBases[usSI >> 8], ausUartBases[uartio_index]);\n#else\n\t\t\t\t\t\tPRINTK_3(TRACE_SMAPI,\n\t\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: Serial port A base I/O address %x conflicts with mwave uart I/O %x\\n\", ausUartBases[usSI >> 8], ausUartBases[uartio_index]);\n#endif\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\t\tPRINTK_1(TRACE_SMAPI,\n\t\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg Disabling conflicting serial port A\\n\");\n\t\t\t\t\t\tbRC = smapi_request (0x1403, 0x0100, 0, usSI,\n\t\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\t\t\tbRC = smapi_request (0x1402, 0x0000, 0, 0,\n\t\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n#else\n\t\t\t\t\t\tgoto exit_conflict;\n#endif\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tbRC = smapi_request(0x1404, 0x0000, 0, 0,\n\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\tif (bRC) goto exit_smapi_request_error;\n\t\t \n\t\tif (usBX & 0x0100) {\t \n\t\t\tif (usCX & 1) {\t \n\t\t\t\tif ((usSI & 0xFF) == mwave_uart_irq) {\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE\n\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: Serial port B irq %x conflicts with mwave_uart_irq %x\\n\", usSI & 0xFF, mwave_uart_irq);\n#else\n\t\t\t\t\tPRINTK_3(TRACE_SMAPI,\n\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: Serial port B irq %x conflicts with mwave_uart_irq %x\\n\", usSI & 0xFF, mwave_uart_irq);\n#endif\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\tPRINTK_1(TRACE_SMAPI,\n\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg Disabling conflicting serial port B\\n\");\n\t\t\t\t\tbRC = smapi_request(0x1405, 0x0100, 0, usSI,\n\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\t\tbRC = smapi_request(0x1404, 0x0000, 0, 0,\n\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n#else\n\t\t\t\t\tgoto exit_conflict;\n#endif\n\t\t\t\t} else {\n\t\t\t\t\tif ((usSI >> 8) == uartio_index) {\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE\n\t\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: Serial port B base I/O address %x conflicts with mwave uart I/O %x\\n\", ausUartBases[usSI >> 8], ausUartBases[uartio_index]);\n#else\n\t\t\t\t\t\tPRINTK_3(TRACE_SMAPI,\n\t\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: Serial port B base I/O address %x conflicts with mwave uart I/O %x\\n\", ausUartBases[usSI >> 8], ausUartBases[uartio_index]);\n#endif\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\t\tPRINTK_1 (TRACE_SMAPI,\n\t\t\t\t\t\t    \"smapi::smapi_set_DSP_cfg Disabling conflicting serial port B\\n\");\n\t\t\t\t\t\tbRC = smapi_request (0x1405, 0x0100, 0, usSI,\n\t\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\t\t\tbRC = smapi_request (0x1404, 0x0000, 0, 0,\n\t\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n#else\n\t\t\t\t\t\tgoto exit_conflict;\n#endif\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tbRC = smapi_request(0x1700, 0x0000, 0, 0,\n\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\tif (bRC) goto exit_smapi_request_error;\n\t\tbRC = smapi_request(0x1704, 0x0000, 0, 0,\n\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\tif (bRC) goto exit_smapi_request_error;\n\t\t \n\t\tif ((usCX & 0xff) != 0xff) {  \n\t\t\tif ((usCX & 0xff) == mwave_uart_irq) {\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE\n\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: IR port irq %x conflicts with mwave_uart_irq %x\\n\", usCX & 0xff, mwave_uart_irq);\n#else\n\t\t\t\tPRINTK_3(TRACE_SMAPI,\n\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: IR port irq %x conflicts with mwave_uart_irq %x\\n\", usCX & 0xff, mwave_uart_irq);\n#endif\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\tPRINTK_1(TRACE_SMAPI,\n\t\t\t\t\t\"smapi::smapi_set_DSP_cfg Disabling conflicting IR port\\n\");\n\t\t\t\tbRC = smapi_request(0x1701, 0x0100, 0, 0,\n\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\tbRC = smapi_request(0x1700, 0, 0, 0,\n\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\tbRC = smapi_request(0x1705, 0x01ff, 0, usSI,\n\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\tbRC = smapi_request(0x1704, 0x0000, 0, 0,\n\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\tif (bRC) goto exit_smapi_request_error;\n#else\n\t\t\t\tgoto exit_conflict;\n#endif\n\t\t\t} else {\n\t\t\t\tif ((usSI & 0xff) == uartio_index) {\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE\n\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: IR port base I/O address %x conflicts with mwave uart I/O %x\\n\", ausUartBases[usSI & 0xff], ausUartBases[uartio_index]);\n#else\n\t\t\t\t\tPRINTK_3(TRACE_SMAPI,\n\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg: IR port base I/O address %x conflicts with mwave uart I/O %x\\n\", ausUartBases[usSI & 0xff], ausUartBases[uartio_index]);\n#endif\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\n\t\t\t\t\tPRINTK_1(TRACE_SMAPI,\n\t\t\t\t\t\t\"smapi::smapi_set_DSP_cfg Disabling conflicting IR port\\n\");\n\t\t\t\t\tbRC = smapi_request(0x1701, 0x0100, 0, 0,\n\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\t\tbRC = smapi_request(0x1700, 0, 0, 0,\n\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\t\tbRC = smapi_request(0x1705, 0x01ff, 0, usSI,\n\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n\t\t\t\t\tbRC = smapi_request(0x1704, 0x0000, 0, 0,\n\t\t\t\t\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\t\t\t\t\tif (bRC) goto exit_smapi_request_error;\n#else\n\t\t\t\t\tgoto exit_conflict;\n#endif\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tbRC = smapi_request(0x1802, 0x0000, 0, 0,\n\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\tif (bRC) goto exit_smapi_request_error;\n\n\tif (mwave_3780i_io) {\n\t\tusDI = dspio_index;\n\t}\n\tif (mwave_3780i_irq) {\n\t\tusSI = (usSI & 0xff00) | mwave_3780i_irq;\n\t}\n\n\tbRC = smapi_request(0x1803, 0x0101, usDI, usSI,\n\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\tif (bRC) goto exit_smapi_request_error;\n\n\tbRC = smapi_request(0x1804, 0x0000, 0, 0,\n\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\tif (bRC) goto exit_smapi_request_error;\n\n\tif (mwave_uart_io) {\n\t\tusSI = (usSI & 0x00ff) | (uartio_index << 8);\n\t}\n\tif (mwave_uart_irq) {\n\t\tusSI = (usSI & 0xff00) | mwave_uart_irq;\n\t}\n\tbRC = smapi_request(0x1805, 0x0101, 0, usSI,\n\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\tif (bRC) goto exit_smapi_request_error;\n\n\tbRC = smapi_request(0x1802, 0x0000, 0, 0,\n\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\tif (bRC) goto exit_smapi_request_error;\n\n\tbRC = smapi_request(0x1804, 0x0000, 0, 0,\n\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\tif (bRC) goto exit_smapi_request_error;\n\n \n\tPRINTK_1(TRACE_SMAPI, \"smapi::smapi_set_DSP_cfg exit\\n\");\n\treturn 0;\n\nexit_conflict:\n\t \n\treturn -EIO;\n\nexit_smapi_request_error:\n\tPRINTK_ERROR(KERN_ERR_MWAVE \"smapi::smapi_set_DSP_cfg exit on smapi_request error bRC %x\\n\", bRC);\n\treturn bRC;\n}\n\n\nint smapi_set_DSP_power_state(bool bOn)\n{\n\tint bRC;\n\tunsigned short usAX, usBX, usCX, usDX, usDI, usSI;\n\tunsigned short usPowerFunction;\n\n\tPRINTK_2(TRACE_SMAPI, \"smapi::smapi_set_DSP_power_state entry bOn %x\\n\", bOn);\n\n\tusPowerFunction = (bOn) ? 1 : 0;\n\n\tbRC = smapi_request(0x4901, 0x0000, 0, usPowerFunction,\n\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\n\tPRINTK_2(TRACE_SMAPI, \"smapi::smapi_set_DSP_power_state exit bRC %x\\n\", bRC);\n\n\treturn bRC;\n}\n\n#if 0\nstatic int SmapiQuerySystemID(void)\n{\n\tint bRC = -EIO;\n\tunsigned short usAX = 0xffff, usBX = 0xffff, usCX = 0xffff,\n\t\tusDX = 0xffff, usDI = 0xffff, usSI = 0xffff;\n\n\tprintk(\"smapi::SmapiQUerySystemID entry\\n\");\n\tbRC = smapi_request(0x0000, 0, 0, 0,\n\t\t&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\n\n\tif (bRC == 0) {\n\t\tprintk(\"AX=%x, BX=%x, CX=%x, DX=%x, DI=%x, SI=%x\\n\",\n\t\t\tusAX, usBX, usCX, usDX, usDI, usSI);\n\t} else {\n\t\tprintk(\"smapi::SmapiQuerySystemID smapi_request error\\n\");\n\t}\n\n\treturn bRC;\n}\n#endif   \n\nint smapi_init(void)\n{\n\tint retval = -EIO;\n\tunsigned short usSmapiID = 0;\n\tunsigned long flags;\n\n\tPRINTK_1(TRACE_SMAPI, \"smapi::smapi_init entry\\n\");\n\n\tspin_lock_irqsave(&rtc_lock, flags);\n\tusSmapiID = CMOS_READ(0x7C);\n\tusSmapiID |= (CMOS_READ(0x7D) << 8);\n\tspin_unlock_irqrestore(&rtc_lock, flags);\n\tPRINTK_2(TRACE_SMAPI, \"smapi::smapi_init usSmapiID %x\\n\", usSmapiID);\n\n\tif (usSmapiID == 0x5349) {\n\t\tspin_lock_irqsave(&rtc_lock, flags);\n\t\tg_usSmapiPort = CMOS_READ(0x7E);\n\t\tg_usSmapiPort |= (CMOS_READ(0x7F) << 8);\n\t\tspin_unlock_irqrestore(&rtc_lock, flags);\n\t\tif (g_usSmapiPort == 0) {\n\t\t\tPRINTK_ERROR(\"smapi::smapi_init, ERROR unable to read from SMAPI port\\n\");\n\t\t} else {\n\t\t\tPRINTK_2(TRACE_SMAPI,\n\t\t\t\t\"smapi::smapi_init, exit true g_usSmapiPort %x\\n\",\n\t\t\t\tg_usSmapiPort);\n\t\t\tretval = 0;\n\t\t\t\n\t\t}\n\t} else {\n\t\tPRINTK_ERROR(\"smapi::smapi_init, ERROR invalid usSmapiID\\n\");\n\t\tretval = -ENXIO;\n\t}\n\n\treturn retval;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}