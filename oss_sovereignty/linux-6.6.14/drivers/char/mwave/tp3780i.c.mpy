{
  "module_name": "tp3780i.c",
  "hash_id": "034bc6e35ef906509fa81d85abab28bb672c92925f82ef9a403ccf36e53edbfc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/mwave/tp3780i.c",
  "human_readable_source": " \n\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/ptrace.h>\n#include <linux/ioport.h>\n#include <asm/io.h>\n#include \"smapi.h\"\n#include \"mwavedd.h\"\n#include \"tp3780i.h\"\n#include \"3780i.h\"\n#include \"mwavepub.h\"\n\nstatic unsigned short s_ausThinkpadIrqToField[16] =\n\t{ 0xFFFF, 0xFFFF, 0xFFFF, 0x0001, 0x0002, 0x0003, 0xFFFF, 0x0004,\n\t0xFFFF, 0xFFFF, 0x0005, 0x0006, 0xFFFF, 0xFFFF, 0xFFFF, 0x0007 };\nstatic unsigned short s_ausThinkpadDmaToField[8] =\n\t{ 0x0001, 0x0002, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0003, 0x0004 };\nstatic unsigned short s_numIrqs = 16, s_numDmas = 8;\n\n\nstatic void EnableSRAM(THINKPAD_BD_DATA * pBDData)\n{\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\tunsigned short usDspBaseIO = pSettings->usDspBaseIO;\n\tDSP_GPIO_OUTPUT_DATA_15_8 rGpioOutputData;\n\tDSP_GPIO_DRIVER_ENABLE_15_8 rGpioDriverEnable;\n\tDSP_GPIO_MODE_15_8 rGpioMode;\n\n\tPRINTK_1(TRACE_TP3780I, \"tp3780i::EnableSRAM, entry\\n\");\n\n\tMKWORD(rGpioMode) = ReadMsaCfg(DSP_GpioModeControl_15_8);\n\trGpioMode.GpioMode10 = 0;\n\tWriteMsaCfg(DSP_GpioModeControl_15_8, MKWORD(rGpioMode));\n\n\tMKWORD(rGpioDriverEnable) = 0;\n\trGpioDriverEnable.Enable10 = true;\n\trGpioDriverEnable.Mask10 = true;\n\tWriteMsaCfg(DSP_GpioDriverEnable_15_8, MKWORD(rGpioDriverEnable));\n\n\tMKWORD(rGpioOutputData) = 0;\n\trGpioOutputData.Latch10 = 0;\n\trGpioOutputData.Mask10 = true;\n\tWriteMsaCfg(DSP_GpioOutputData_15_8, MKWORD(rGpioOutputData));\n\n\tPRINTK_1(TRACE_TP3780I, \"tp3780i::EnableSRAM exit\\n\");\n}\n\n\nstatic irqreturn_t UartInterrupt(int irq, void *dev_id)\n{\n\tPRINTK_3(TRACE_TP3780I,\n\t\t\"tp3780i::UartInterrupt entry irq %x dev_id %p\\n\", irq, dev_id);\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t DspInterrupt(int irq, void *dev_id)\n{\n\tpMWAVE_DEVICE_DATA pDrvData = &mwave_s_mdd;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pDrvData->rBDData.rDspSettings;\n\tunsigned short usDspBaseIO = pSettings->usDspBaseIO;\n\tunsigned short usIPCSource = 0, usIsolationMask, usPCNum;\n\n\tPRINTK_3(TRACE_TP3780I,\n\t\t\"tp3780i::DspInterrupt entry irq %x dev_id %p\\n\", irq, dev_id);\n\n\tif (dsp3780I_GetIPCSource(usDspBaseIO, &usIPCSource) == 0) {\n\t\tPRINTK_2(TRACE_TP3780I,\n\t\t\t\"tp3780i::DspInterrupt, return from dsp3780i_GetIPCSource, usIPCSource %x\\n\",\n\t\t\tusIPCSource);\n\t\tusIsolationMask = 1;\n\t\tfor (usPCNum = 1; usPCNum <= 16; usPCNum++) {\n\t\t\tif (usIPCSource & usIsolationMask) {\n\t\t\t\tusIPCSource &= ~usIsolationMask;\n\t\t\t\tPRINTK_3(TRACE_TP3780I,\n\t\t\t\t\t\"tp3780i::DspInterrupt usPCNum %x usIPCSource %x\\n\",\n\t\t\t\t\tusPCNum, usIPCSource);\n\t\t\t\tif (pDrvData->IPCs[usPCNum - 1].usIntCount == 0) {\n\t\t\t\t\tpDrvData->IPCs[usPCNum - 1].usIntCount = 1;\n\t\t\t\t}\n\t\t\t\tPRINTK_2(TRACE_TP3780I,\n\t\t\t\t\t\"tp3780i::DspInterrupt usIntCount %x\\n\",\n\t\t\t\t\tpDrvData->IPCs[usPCNum - 1].usIntCount);\n\t\t\t\tif (pDrvData->IPCs[usPCNum - 1].bIsEnabled == true) {\n\t\t\t\t\tPRINTK_2(TRACE_TP3780I,\n\t\t\t\t\t\t\"tp3780i::DspInterrupt, waking up usPCNum %x\\n\",\n\t\t\t\t\t\tusPCNum - 1);\n\t\t\t\t\twake_up_interruptible(&pDrvData->IPCs[usPCNum - 1].ipc_wait_queue);\n\t\t\t\t} else {\n\t\t\t\t\tPRINTK_2(TRACE_TP3780I,\n\t\t\t\t\t\t\"tp3780i::DspInterrupt, no one waiting for IPC %x\\n\",\n\t\t\t\t\t\tusPCNum - 1);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (usIPCSource == 0)\n\t\t\t\tbreak;\n\t\t\t \n\t\t\tusIsolationMask = usIsolationMask << 1;\n\t\t}\n\t} else {\n\t\tPRINTK_1(TRACE_TP3780I,\n\t\t\t\"tp3780i::DspInterrupt, return false from dsp3780i_GetIPCSource\\n\");\n\t}\n\tPRINTK_1(TRACE_TP3780I, \"tp3780i::DspInterrupt exit\\n\");\n\treturn IRQ_HANDLED;\n}\n\n\nint tp3780I_InitializeBoardData(THINKPAD_BD_DATA * pBDData)\n{\n\tint retval = 0;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_InitializeBoardData entry pBDData %p\\n\", pBDData);\n\n\tpBDData->bDSPEnabled = false;\n\tpSettings->bInterruptClaimed = false;\n\n\tretval = smapi_init();\n\tif (retval) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_InitializeBoardData: Error: SMAPI is not available on this machine\\n\");\n\t} else {\n\t\tif (mwave_3780i_irq || mwave_3780i_io || mwave_uart_irq || mwave_uart_io) {\n\t\t\tretval = smapi_set_DSP_cfg();\n\t\t}\n\t}\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_InitializeBoardData exit retval %x\\n\", retval);\n\n\treturn retval;\n}\n\nvoid tp3780I_Cleanup(THINKPAD_BD_DATA *pBDData)\n{\n\tPRINTK_2(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_Cleanup entry and exit pBDData %p\\n\", pBDData);\n}\n\nint tp3780I_CalcResources(THINKPAD_BD_DATA * pBDData)\n{\n\tSMAPI_DSP_SETTINGS rSmapiInfo;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\n\tPRINTK_2(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_CalcResources entry pBDData %p\\n\", pBDData);\n\n\tif (smapi_query_DSP_cfg(&rSmapiInfo)) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_CalcResources: Error: Could not query DSP config. Aborting.\\n\");\n\t\treturn -EIO;\n\t}\n\n\t \n\tif (\n\t\t( rSmapiInfo.usDspIRQ == 0 )\n\t\t|| ( rSmapiInfo.usDspBaseIO ==  0 )\n\t\t|| ( rSmapiInfo.usUartIRQ ==  0 )\n\t\t|| ( rSmapiInfo.usUartBaseIO ==  0 )\n\t) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_CalcResources: Error: Illegal resource setting. Aborting.\\n\");\n\t\treturn -EIO;\n\t}\n\n\tpSettings->bDSPEnabled = (rSmapiInfo.bDSPEnabled && rSmapiInfo.bDSPPresent);\n\tpSettings->bModemEnabled = rSmapiInfo.bModemEnabled;\n\tpSettings->usDspIrq = rSmapiInfo.usDspIRQ;\n\tpSettings->usDspDma = rSmapiInfo.usDspDMA;\n\tpSettings->usDspBaseIO = rSmapiInfo.usDspBaseIO;\n\tpSettings->usUartIrq = rSmapiInfo.usUartIRQ;\n\tpSettings->usUartBaseIO = rSmapiInfo.usUartBaseIO;\n\n\tpSettings->uDStoreSize = TP_ABILITIES_DATA_SIZE;\n\tpSettings->uIStoreSize = TP_ABILITIES_INST_SIZE;\n\tpSettings->uIps = TP_ABILITIES_INTS_PER_SEC;\n\n\tif (pSettings->bDSPEnabled && pSettings->bModemEnabled && pSettings->usDspIrq == pSettings->usUartIrq) {\n\t\tpBDData->bShareDspIrq = pBDData->bShareUartIrq = 1;\n\t} else {\n\t\tpBDData->bShareDspIrq = pBDData->bShareUartIrq = 0;\n\t}\n\n\tPRINTK_1(TRACE_TP3780I, \"tp3780i::tp3780I_CalcResources exit\\n\");\n\n\treturn 0;\n}\n\n\nint tp3780I_ClaimResources(THINKPAD_BD_DATA * pBDData)\n{\n\tint retval = 0;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\tstruct resource *pres;\n\n\tPRINTK_2(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_ClaimResources entry pBDData %p\\n\", pBDData);\n\n\tpres = request_region(pSettings->usDspBaseIO, 16, \"mwave_3780i\");\n\tif ( pres == NULL ) retval = -EIO;\n\n\tif (retval) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_ClaimResources: Error: Could not claim I/O region starting at %x\\n\", pSettings->usDspBaseIO);\n\t\tretval = -EIO;\n\t}\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_ClaimResources exit retval %x\\n\", retval);\n\n\treturn retval;\n}\n\nint tp3780I_ReleaseResources(THINKPAD_BD_DATA * pBDData)\n{\n\tint retval = 0;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\n\tPRINTK_2(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_ReleaseResources entry pBDData %p\\n\", pBDData);\n\n\trelease_region(pSettings->usDspBaseIO & (~3), 16);\n\n\tif (pSettings->bInterruptClaimed) {\n\t\tfree_irq(pSettings->usDspIrq, NULL);\n\t\tpSettings->bInterruptClaimed = false;\n\t}\n\n\tPRINTK_2(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_ReleaseResources exit retval %x\\n\", retval);\n\n\treturn retval;\n}\n\n\n\nint tp3780I_EnableDSP(THINKPAD_BD_DATA * pBDData)\n{\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\tbool bDSPPoweredUp = false, bInterruptAllocated = false;\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_EnableDSP entry pBDData %p\\n\", pBDData);\n\n\tif (pBDData->bDSPEnabled) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_EnableDSP: Error: DSP already enabled!\\n\");\n\t\tgoto exit_cleanup;\n\t}\n\n\tif (!pSettings->bDSPEnabled) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780::tp3780I_EnableDSP: Error: pSettings->bDSPEnabled not set\\n\");\n\t\tgoto exit_cleanup;\n\t}\n\n\tif (\n\t\t(pSettings->usDspIrq >= s_numIrqs)\n\t\t|| (pSettings->usDspDma >= s_numDmas)\n\t\t|| (s_ausThinkpadIrqToField[pSettings->usDspIrq] == 0xFFFF)\n\t\t|| (s_ausThinkpadDmaToField[pSettings->usDspDma] == 0xFFFF)\n\t) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_EnableDSP: Error: invalid irq %x\\n\", pSettings->usDspIrq);\n\t\tgoto exit_cleanup;\n\t}\n\n\tif (\n\t\t((pSettings->usDspBaseIO & 0xF00F) != 0)\n\t\t|| (pSettings->usDspBaseIO & 0x0FF0) == 0\n\t) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_EnableDSP: Error: Invalid DSP base I/O address %x\\n\", pSettings->usDspBaseIO);\n\t\tgoto exit_cleanup;\n\t}\n\n\tif (pSettings->bModemEnabled) {\n\t\tif (\n\t\t\tpSettings->usUartIrq >= s_numIrqs\n\t\t\t|| s_ausThinkpadIrqToField[pSettings->usUartIrq] == 0xFFFF\n\t\t) {\n\t\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_EnableDSP: Error: Invalid UART IRQ %x\\n\", pSettings->usUartIrq);\n\t\t\tgoto exit_cleanup;\n\t\t}\n\t\tswitch (pSettings->usUartBaseIO) {\n\t\t\tcase 0x03F8:\n\t\t\tcase 0x02F8:\n\t\t\tcase 0x03E8:\n\t\t\tcase 0x02E8:\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tPRINTK_ERROR(\"tp3780i::tp3780I_EnableDSP: Error: Invalid UART base I/O address %x\\n\", pSettings->usUartBaseIO);\n\t\t\t\tgoto exit_cleanup;\n\t\t}\n\t}\n\n\tpSettings->bDspIrqActiveLow = pSettings->bDspIrqPulse = true;\n\tpSettings->bUartIrqActiveLow = pSettings->bUartIrqPulse = true;\n\n\tif (pBDData->bShareDspIrq) {\n\t\tpSettings->bDspIrqActiveLow = false;\n\t}\n\tif (pBDData->bShareUartIrq) {\n\t\tpSettings->bUartIrqActiveLow = false;\n\t}\n\n\tpSettings->usNumTransfers = TP_CFG_NumTransfers;\n\tpSettings->usReRequest = TP_CFG_RerequestTimer;\n\tpSettings->bEnableMEMCS16 = TP_CFG_MEMCS16;\n\tpSettings->usIsaMemCmdWidth = TP_CFG_IsaMemCmdWidth;\n\tpSettings->bGateIOCHRDY = TP_CFG_GateIOCHRDY;\n\tpSettings->bEnablePwrMgmt = TP_CFG_EnablePwrMgmt;\n\tpSettings->usHBusTimerLoadValue = TP_CFG_HBusTimerValue;\n\tpSettings->bDisableLBusTimeout = TP_CFG_DisableLBusTimeout;\n\tpSettings->usN_Divisor = TP_CFG_N_Divisor;\n\tpSettings->usM_Multiplier = TP_CFG_M_Multiplier;\n\tpSettings->bPllBypass = TP_CFG_PllBypass;\n\tpSettings->usChipletEnable = TP_CFG_ChipletEnable;\n\n\tif (request_irq(pSettings->usUartIrq, &UartInterrupt, 0, \"mwave_uart\", NULL)) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_EnableDSP: Error: Could not get UART IRQ %x\\n\", pSettings->usUartIrq);\n\t\tgoto exit_cleanup;\n\t} else {\t\t \n\t\tfree_irq(pSettings->usUartIrq, NULL);\n\t}\n\n\tif (request_irq(pSettings->usDspIrq, &DspInterrupt, 0, \"mwave_3780i\", NULL)) {\n\t\tPRINTK_ERROR(\"tp3780i::tp3780I_EnableDSP: Error: Could not get 3780i IRQ %x\\n\", pSettings->usDspIrq);\n\t\tgoto exit_cleanup;\n\t} else {\n\t\tPRINTK_3(TRACE_TP3780I,\n\t\t\t\"tp3780i::tp3780I_EnableDSP, got interrupt %x bShareDspIrq %x\\n\",\n\t\t\tpSettings->usDspIrq, pBDData->bShareDspIrq);\n\t\tbInterruptAllocated = true;\n\t\tpSettings->bInterruptClaimed = true;\n\t}\n\n\tsmapi_set_DSP_power_state(false);\n\tif (smapi_set_DSP_power_state(true)) {\n\t\tPRINTK_ERROR(KERN_ERR_MWAVE \"tp3780i::tp3780I_EnableDSP: Error: smapi_set_DSP_power_state(true) failed\\n\");\n\t\tgoto exit_cleanup;\n\t} else {\n\t\tbDSPPoweredUp = true;\n\t}\n\n\tif (dsp3780I_EnableDSP(pSettings, s_ausThinkpadIrqToField, s_ausThinkpadDmaToField)) {\n\t\tPRINTK_ERROR(\"tp3780i::tp3780I_EnableDSP: Error: dsp7880I_EnableDSP() failed\\n\");\n\t\tgoto exit_cleanup;\n\t}\n\n\tEnableSRAM(pBDData);\n\n\tpBDData->bDSPEnabled = true;\n\n\tPRINTK_1(TRACE_TP3780I, \"tp3780i::tp3780I_EnableDSP exit\\n\");\n\n\treturn 0;\n\nexit_cleanup:\n\tPRINTK_ERROR(\"tp3780i::tp3780I_EnableDSP: Cleaning up\\n\");\n\tif (bDSPPoweredUp)\n\t\tsmapi_set_DSP_power_state(false);\n\tif (bInterruptAllocated) {\n\t\tfree_irq(pSettings->usDspIrq, NULL);\n\t\tpSettings->bInterruptClaimed = false;\n\t}\n\treturn -EIO;\n}\n\n\nint tp3780I_DisableDSP(THINKPAD_BD_DATA * pBDData)\n{\n\tint retval = 0;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_DisableDSP entry pBDData %p\\n\", pBDData);\n\n\tif (pBDData->bDSPEnabled) {\n\t\tdsp3780I_DisableDSP(&pBDData->rDspSettings);\n\t\tif (pSettings->bInterruptClaimed) {\n\t\t\tfree_irq(pSettings->usDspIrq, NULL);\n\t\t\tpSettings->bInterruptClaimed = false;\n\t\t}\n\t\tsmapi_set_DSP_power_state(false);\n\t\tpBDData->bDSPEnabled = false;\n\t}\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_DisableDSP exit retval %x\\n\", retval);\n\n\treturn retval;\n}\n\n\nint tp3780I_ResetDSP(THINKPAD_BD_DATA * pBDData)\n{\n\tint retval = 0;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_ResetDSP entry pBDData %p\\n\",\n\t\tpBDData);\n\n\tif (dsp3780I_Reset(pSettings) == 0) {\n\t\tEnableSRAM(pBDData);\n\t} else {\n\t\tretval = -EIO;\n\t}\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_ResetDSP exit retval %x\\n\", retval);\n\n\treturn retval;\n}\n\n\nint tp3780I_StartDSP(THINKPAD_BD_DATA * pBDData)\n{\n\tint retval = 0;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_StartDSP entry pBDData %p\\n\", pBDData);\n\n\tif (dsp3780I_Run(pSettings) == 0) {\n\t\t\n\t} else {\n\t\tretval = -EIO;\n\t}\n\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_StartDSP exit retval %x\\n\", retval);\n\n\treturn retval;\n}\n\n\nint tp3780I_QueryAbilities(THINKPAD_BD_DATA * pBDData, MW_ABILITIES * pAbilities)\n{\n\tPRINTK_2(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_QueryAbilities entry pBDData %p\\n\", pBDData);\n\n\tmemset(pAbilities, 0, sizeof(*pAbilities));\n\t \n\tpAbilities->instr_per_sec = pBDData->rDspSettings.uIps;\n\tpAbilities->data_size = pBDData->rDspSettings.uDStoreSize;\n\tpAbilities->inst_size = pBDData->rDspSettings.uIStoreSize;\n\tpAbilities->bus_dma_bw = pBDData->rDspSettings.uDmaBandwidth;\n\n\t \n\tpAbilities->component_list[0] = 0x00010000 | MW_ADC_MASK;\n\tpAbilities->component_list[1] = 0x00010000 | MW_ACI_MASK;\n\tpAbilities->component_list[2] = 0x00010000 | MW_AIC1_MASK;\n\tpAbilities->component_list[3] = 0x00010000 | MW_AIC2_MASK;\n\tpAbilities->component_list[4] = 0x00010000 | MW_CDDAC_MASK;\n\tpAbilities->component_list[5] = 0x00010000 | MW_MIDI_MASK;\n\tpAbilities->component_list[6] = 0x00010000 | MW_UART_MASK;\n\tpAbilities->component_count = 7;\n\n\t \n\n\tmemcpy(pAbilities->mwave_os_name, TP_ABILITIES_MWAVEOS_NAME,\n\t\tsizeof(TP_ABILITIES_MWAVEOS_NAME));\n\tmemcpy(pAbilities->bios_task_name, TP_ABILITIES_BIOSTASK_NAME,\n\t\tsizeof(TP_ABILITIES_BIOSTASK_NAME));\n\n\tPRINTK_1(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_QueryAbilities exit retval=SUCCESSFUL\\n\");\n\n\treturn 0;\n}\n\nint tp3780I_ReadWriteDspDStore(THINKPAD_BD_DATA * pBDData, unsigned int uOpcode,\n                               void __user *pvBuffer, unsigned int uCount,\n                               unsigned long ulDSPAddr)\n{\n\tint retval = 0;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\tunsigned short usDspBaseIO = pSettings->usDspBaseIO;\n\tbool bRC = 0;\n\n\tPRINTK_6(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_ReadWriteDspDStore entry pBDData %p, uOpcode %x, pvBuffer %p, uCount %x, ulDSPAddr %lx\\n\",\n\t\tpBDData, uOpcode, pvBuffer, uCount, ulDSPAddr);\n\n\tif (pBDData->bDSPEnabled) {\n\t\tswitch (uOpcode) {\n\t\tcase IOCTL_MW_READ_DATA:\n\t\t\tbRC = dsp3780I_ReadDStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\n\t\t\tbreak;\n\n\t\tcase IOCTL_MW_READCLEAR_DATA:\n\t\t\tbRC = dsp3780I_ReadAndClearDStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\n\t\t\tbreak;\n\n\t\tcase IOCTL_MW_WRITE_DATA:\n\t\t\tbRC = dsp3780I_WriteDStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tretval = (bRC) ? -EIO : 0;\n\tPRINTK_2(TRACE_TP3780I, \"tp3780i::tp3780I_ReadWriteDspDStore exit retval %x\\n\", retval);\n\n\treturn retval;\n}\n\n\nint tp3780I_ReadWriteDspIStore(THINKPAD_BD_DATA * pBDData, unsigned int uOpcode,\n                               void __user *pvBuffer, unsigned int uCount,\n                               unsigned long ulDSPAddr)\n{\n\tint retval = 0;\n\tDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\n\tunsigned short usDspBaseIO = pSettings->usDspBaseIO;\n\tbool bRC = 0;\n\n\tPRINTK_6(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_ReadWriteDspIStore entry pBDData %p, uOpcode %x, pvBuffer %p, uCount %x, ulDSPAddr %lx\\n\",\n\t\tpBDData, uOpcode, pvBuffer, uCount, ulDSPAddr);\n\n\tif (pBDData->bDSPEnabled) {\n\t\tswitch (uOpcode) {\n\t\tcase IOCTL_MW_READ_INST:\n\t\t\tbRC = dsp3780I_ReadIStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\n\t\t\tbreak;\n\n\t\tcase IOCTL_MW_WRITE_INST:\n\t\t\tbRC = dsp3780I_WriteIStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tretval = (bRC) ? -EIO : 0;\n\n\tPRINTK_2(TRACE_TP3780I,\n\t\t\"tp3780i::tp3780I_ReadWriteDspIStore exit retval %x\\n\", retval);\n\n\treturn retval;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}