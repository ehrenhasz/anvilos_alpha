{
  "module_name": "kcs_bmc_serio.c",
  "hash_id": "55a8b94a26ee34647786e7ea11e3b9562baff8f4f650355738297db11db56bd0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/ipmi/kcs_bmc_serio.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/errno.h>\n#include <linux/list.h>\n#include <linux/module.h>\n#include <linux/sched/signal.h>\n#include <linux/serio.h>\n#include <linux/slab.h>\n\n#include \"kcs_bmc_client.h\"\n\nstruct kcs_bmc_serio {\n\tstruct list_head entry;\n\n\tstruct kcs_bmc_client client;\n\tstruct serio *port;\n\n\tspinlock_t lock;\n};\n\nstatic inline struct kcs_bmc_serio *client_to_kcs_bmc_serio(struct kcs_bmc_client *client)\n{\n\treturn container_of(client, struct kcs_bmc_serio, client);\n}\n\nstatic irqreturn_t kcs_bmc_serio_event(struct kcs_bmc_client *client)\n{\n\tstruct kcs_bmc_serio *priv;\n\tu8 handled = IRQ_NONE;\n\tu8 status;\n\n\tpriv = client_to_kcs_bmc_serio(client);\n\n\tspin_lock(&priv->lock);\n\n\tstatus = kcs_bmc_read_status(client->dev);\n\n\tif (status & KCS_BMC_STR_IBF)\n\t\thandled = serio_interrupt(priv->port, kcs_bmc_read_data(client->dev), 0);\n\n\tspin_unlock(&priv->lock);\n\n\treturn handled;\n}\n\nstatic const struct kcs_bmc_client_ops kcs_bmc_serio_client_ops = {\n\t.event = kcs_bmc_serio_event,\n};\n\nstatic int kcs_bmc_serio_open(struct serio *port)\n{\n\tstruct kcs_bmc_serio *priv = port->port_data;\n\n\treturn kcs_bmc_enable_device(priv->client.dev, &priv->client);\n}\n\nstatic void kcs_bmc_serio_close(struct serio *port)\n{\n\tstruct kcs_bmc_serio *priv = port->port_data;\n\n\tkcs_bmc_disable_device(priv->client.dev, &priv->client);\n}\n\nstatic DEFINE_SPINLOCK(kcs_bmc_serio_instances_lock);\nstatic LIST_HEAD(kcs_bmc_serio_instances);\n\nstatic int kcs_bmc_serio_add_device(struct kcs_bmc_device *kcs_bmc)\n{\n\tstruct kcs_bmc_serio *priv;\n\tstruct serio *port;\n\n\tpriv = devm_kzalloc(kcs_bmc->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\t \n\tport = kzalloc(sizeof(*port), GFP_KERNEL);\n\tif (!port)\n\t\treturn -ENOMEM;\n\n\tport->id.type = SERIO_8042;\n\tport->open = kcs_bmc_serio_open;\n\tport->close = kcs_bmc_serio_close;\n\tport->port_data = priv;\n\tport->dev.parent = kcs_bmc->dev;\n\n\tspin_lock_init(&priv->lock);\n\tpriv->port = port;\n\tpriv->client.dev = kcs_bmc;\n\tpriv->client.ops = &kcs_bmc_serio_client_ops;\n\n\tspin_lock_irq(&kcs_bmc_serio_instances_lock);\n\tlist_add(&priv->entry, &kcs_bmc_serio_instances);\n\tspin_unlock_irq(&kcs_bmc_serio_instances_lock);\n\n\tserio_register_port(port);\n\n\tdev_info(kcs_bmc->dev, \"Initialised serio client for channel %d\", kcs_bmc->channel);\n\n\treturn 0;\n}\n\nstatic int kcs_bmc_serio_remove_device(struct kcs_bmc_device *kcs_bmc)\n{\n\tstruct kcs_bmc_serio *priv = NULL, *pos;\n\n\tspin_lock_irq(&kcs_bmc_serio_instances_lock);\n\tlist_for_each_entry(pos, &kcs_bmc_serio_instances, entry) {\n\t\tif (pos->client.dev == kcs_bmc) {\n\t\t\tpriv = pos;\n\t\t\tlist_del(&pos->entry);\n\t\t\tbreak;\n\t\t}\n\t}\n\tspin_unlock_irq(&kcs_bmc_serio_instances_lock);\n\n\tif (!priv)\n\t\treturn -ENODEV;\n\n\t \n\tserio_unregister_port(priv->port);\n\n\t \n\tkcs_bmc_disable_device(kcs_bmc, &priv->client);\n\n\tdevm_kfree(priv->client.dev->dev, priv);\n\n\treturn 0;\n}\n\nstatic const struct kcs_bmc_driver_ops kcs_bmc_serio_driver_ops = {\n\t.add_device = kcs_bmc_serio_add_device,\n\t.remove_device = kcs_bmc_serio_remove_device,\n};\n\nstatic struct kcs_bmc_driver kcs_bmc_serio_driver = {\n\t.ops = &kcs_bmc_serio_driver_ops,\n};\n\nstatic int __init kcs_bmc_serio_init(void)\n{\n\tkcs_bmc_register_driver(&kcs_bmc_serio_driver);\n\n\treturn 0;\n}\nmodule_init(kcs_bmc_serio_init);\n\nstatic void __exit kcs_bmc_serio_exit(void)\n{\n\tkcs_bmc_unregister_driver(&kcs_bmc_serio_driver);\n}\nmodule_exit(kcs_bmc_serio_exit);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Andrew Jeffery <andrew@aj.id.au>\");\nMODULE_DESCRIPTION(\"Adapter driver for serio access to BMC KCS devices\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}