{
  "module_name": "uv_mmtimer.c",
  "hash_id": "052f0e5986bfbca3a55ef352041e5476a593d038a1d708f859d808321e37b626",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/uv_mmtimer.c",
  "human_readable_source": " \n\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/ioctl.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/errno.h>\n#include <linux/mm.h>\n#include <linux/fs.h>\n#include <linux/mmtimer.h>\n#include <linux/miscdevice.h>\n#include <linux/posix-timers.h>\n#include <linux/interrupt.h>\n#include <linux/time.h>\n#include <linux/math64.h>\n\n#include <asm/genapic.h>\n#include <asm/uv/uv_hub.h>\n#include <asm/uv/bios.h>\n#include <asm/uv/uv.h>\n\nMODULE_AUTHOR(\"Dimitri Sivanich <sivanich@sgi.com>\");\nMODULE_DESCRIPTION(\"SGI UV Memory Mapped RTC Timer\");\nMODULE_LICENSE(\"GPL\");\n\n \n#define UV_MMTIMER_NAME \"mmtimer\"\n#define UV_MMTIMER_DESC \"SGI UV Memory Mapped RTC Timer\"\n#define UV_MMTIMER_VERSION \"1.0\"\n\nstatic long uv_mmtimer_ioctl(struct file *file, unsigned int cmd,\n\t\t\t\t\t\tunsigned long arg);\nstatic int uv_mmtimer_mmap(struct file *file, struct vm_area_struct *vma);\n\n \nstatic unsigned long uv_mmtimer_femtoperiod;\n\nstatic const struct file_operations uv_mmtimer_fops = {\n\t.owner = THIS_MODULE,\n\t.mmap =\tuv_mmtimer_mmap,\n\t.unlocked_ioctl = uv_mmtimer_ioctl,\n\t.llseek = noop_llseek,\n};\n\n \nstatic long uv_mmtimer_ioctl(struct file *file, unsigned int cmd,\n\t\t\t\t\t\tunsigned long arg)\n{\n\tint ret = 0;\n\n\tswitch (cmd) {\n\tcase MMTIMER_GETOFFSET:\t \n\t\t \n\t\tif (uv_get_min_hub_revision_id() == 1)\n\t\t\tret = 0;\n\t\telse\n\t\t\tret = ((uv_blade_processor_id() * L1_CACHE_BYTES) %\n\t\t\t\t\tPAGE_SIZE) / 8;\n\t\tbreak;\n\n\tcase MMTIMER_GETRES:  \n\t\tif (copy_to_user((unsigned long __user *)arg,\n\t\t\t\t&uv_mmtimer_femtoperiod, sizeof(unsigned long)))\n\t\t\tret = -EFAULT;\n\t\tbreak;\n\n\tcase MMTIMER_GETFREQ:  \n\t\tif (copy_to_user((unsigned long __user *)arg,\n\t\t\t\t&sn_rtc_cycles_per_second,\n\t\t\t\tsizeof(unsigned long)))\n\t\t\tret = -EFAULT;\n\t\tbreak;\n\n\tcase MMTIMER_GETBITS:  \n\t\tret = hweight64(UVH_RTC_REAL_TIME_CLOCK_MASK);\n\t\tbreak;\n\n\tcase MMTIMER_MMAPAVAIL:\n\t\tret = 1;\n\t\tbreak;\n\n\tcase MMTIMER_GETCOUNTER:\n\t\tif (copy_to_user((unsigned long __user *)arg,\n\t\t\t\t(unsigned long *)uv_local_mmr_address(UVH_RTC),\n\t\t\t\tsizeof(unsigned long)))\n\t\t\tret = -EFAULT;\n\t\tbreak;\n\tdefault:\n\t\tret = -ENOTTY;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\n \nstatic int uv_mmtimer_mmap(struct file *file, struct vm_area_struct *vma)\n{\n\tunsigned long uv_mmtimer_addr;\n\n\tif (vma->vm_end - vma->vm_start != PAGE_SIZE)\n\t\treturn -EINVAL;\n\n\tif (vma->vm_flags & VM_WRITE)\n\t\treturn -EPERM;\n\n\tif (PAGE_SIZE > (1 << 16))\n\t\treturn -ENOSYS;\n\n\tvma->vm_page_prot = pgprot_noncached(vma->vm_page_prot);\n\n\tuv_mmtimer_addr = UV_LOCAL_MMR_BASE | UVH_RTC;\n\tuv_mmtimer_addr &= ~(PAGE_SIZE - 1);\n\tuv_mmtimer_addr &= 0xfffffffffffffffUL;\n\n\tif (remap_pfn_range(vma, vma->vm_start, uv_mmtimer_addr >> PAGE_SHIFT,\n\t\t\t\t\tPAGE_SIZE, vma->vm_page_prot)) {\n\t\tprintk(KERN_ERR \"remap_pfn_range failed in uv_mmtimer_mmap\\n\");\n\t\treturn -EAGAIN;\n\t}\n\n\treturn 0;\n}\n\nstatic struct miscdevice uv_mmtimer_miscdev = {\n\tMISC_DYNAMIC_MINOR,\n\tUV_MMTIMER_NAME,\n\t&uv_mmtimer_fops\n};\n\n\n \nstatic int __init uv_mmtimer_init(void)\n{\n\tif (!is_uv_system()) {\n\t\tprintk(KERN_ERR \"%s: Hardware unsupported\\n\", UV_MMTIMER_NAME);\n\t\treturn -1;\n\t}\n\n\t \n\tif (sn_rtc_cycles_per_second < 100000) {\n\t\tprintk(KERN_ERR \"%s: unable to determine clock frequency\\n\",\n\t\t       UV_MMTIMER_NAME);\n\t\treturn -1;\n\t}\n\n\tuv_mmtimer_femtoperiod = ((unsigned long)1E15 +\n\t\t\t\tsn_rtc_cycles_per_second / 2) /\n\t\t\t\tsn_rtc_cycles_per_second;\n\n\tif (misc_register(&uv_mmtimer_miscdev)) {\n\t\tprintk(KERN_ERR \"%s: failed to register device\\n\",\n\t\t       UV_MMTIMER_NAME);\n\t\treturn -1;\n\t}\n\n\tprintk(KERN_INFO \"%s: v%s, %ld MHz\\n\", UV_MMTIMER_DESC,\n\t\tUV_MMTIMER_VERSION,\n\t\tsn_rtc_cycles_per_second/(unsigned long)1E6);\n\n\treturn 0;\n}\n\nmodule_init(uv_mmtimer_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}