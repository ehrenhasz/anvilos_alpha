{
  "module_name": "efi.c",
  "hash_id": "0b2dc24d23b28982ae1bd01ff458428940796a970cefa7fee8595ce8da084392",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/tpm/eventlog/efi.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/efi.h>\n#include <linux/tpm_eventlog.h>\n\n#include \"../tpm.h\"\n#include \"common.h\"\n\n \nint tpm_read_log_efi(struct tpm_chip *chip)\n{\n\n\tstruct efi_tcg2_final_events_table *final_tbl = NULL;\n\tint final_events_log_size = efi_tpm_final_log_size;\n\tstruct linux_efi_tpm_eventlog *log_tbl;\n\tstruct tpm_bios_log *log;\n\tu32 log_size;\n\tu8 tpm_log_version;\n\tvoid *tmp;\n\tint ret;\n\n\tif (!(chip->flags & TPM_CHIP_FLAG_TPM2))\n\t\treturn -ENODEV;\n\n\tif (efi.tpm_log == EFI_INVALID_TABLE_ADDR)\n\t\treturn -ENODEV;\n\n\tlog = &chip->log;\n\n\tlog_tbl = memremap(efi.tpm_log, sizeof(*log_tbl), MEMREMAP_WB);\n\tif (!log_tbl) {\n\t\tpr_err(\"Could not map UEFI TPM log table !\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tlog_size = log_tbl->size;\n\tmemunmap(log_tbl);\n\n\tif (!log_size) {\n\t\tpr_warn(\"UEFI TPM log area empty\\n\");\n\t\treturn -EIO;\n\t}\n\n\tlog_tbl = memremap(efi.tpm_log, sizeof(*log_tbl) + log_size,\n\t\t\t   MEMREMAP_WB);\n\tif (!log_tbl) {\n\t\tpr_err(\"Could not map UEFI TPM log table payload!\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\t \n\tlog->bios_event_log = devm_kmemdup(&chip->dev, log_tbl->log, log_size, GFP_KERNEL);\n\tif (!log->bios_event_log) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tlog->bios_event_log_end = log->bios_event_log + log_size;\n\ttpm_log_version = log_tbl->version;\n\n\tret = tpm_log_version;\n\n\tif (efi.tpm_final_log == EFI_INVALID_TABLE_ADDR ||\n\t    final_events_log_size == 0 ||\n\t    tpm_log_version != EFI_TCG2_EVENT_LOG_FORMAT_TCG_2)\n\t\tgoto out;\n\n\tfinal_tbl = memremap(efi.tpm_final_log,\n\t\t\t     sizeof(*final_tbl) + final_events_log_size,\n\t\t\t     MEMREMAP_WB);\n\tif (!final_tbl) {\n\t\tpr_err(\"Could not map UEFI TPM final log\\n\");\n\t\tdevm_kfree(&chip->dev, log->bios_event_log);\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\t \n\tfinal_events_log_size -= log_tbl->final_events_preboot_size;\n\n\t \n\ttmp = devm_krealloc(&chip->dev, log->bios_event_log,\n\t\t\t    log_size + final_events_log_size,\n\t\t\t    GFP_KERNEL);\n\tif (!tmp) {\n\t\tdevm_kfree(&chip->dev, log->bios_event_log);\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tlog->bios_event_log = tmp;\n\n\t \n\tmemcpy((void *)log->bios_event_log + log_size,\n\t       final_tbl->events + log_tbl->final_events_preboot_size,\n\t       final_events_log_size);\n\t \n\tlog->bios_event_log_end = log->bios_event_log +\n\t\tlog_size + final_events_log_size;\n\nout:\n\tmemunmap(final_tbl);\n\tmemunmap(log_tbl);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}