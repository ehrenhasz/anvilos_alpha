{
  "module_name": "of.c",
  "hash_id": "619fe08cbfa0202e26b5fbeaf935c85591d1ef0f9f6df3729c2ed9b7e2b52632",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/tpm/eventlog/of.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_reserved_mem.h>\n#include <linux/tpm_eventlog.h>\n\n#include \"../tpm.h\"\n#include \"common.h\"\n\nstatic int tpm_read_log_memory_region(struct tpm_chip *chip)\n{\n\tstruct device_node *node;\n\tstruct resource res;\n\tint rc;\n\n\tnode = of_parse_phandle(chip->dev.parent->of_node, \"memory-region\", 0);\n\tif (!node)\n\t\treturn -ENODEV;\n\n\trc = of_address_to_resource(node, 0, &res);\n\tof_node_put(node);\n\tif (rc)\n\t\treturn rc;\n\n\tchip->log.bios_event_log = devm_memremap(&chip->dev, res.start, resource_size(&res),\n\t\t\t\t\t\t MEMREMAP_WB);\n\tif (IS_ERR(chip->log.bios_event_log))\n\t\treturn -ENOMEM;\n\n\tchip->log.bios_event_log_end = chip->log.bios_event_log + resource_size(&res);\n\n\treturn chip->flags & TPM_CHIP_FLAG_TPM2 ? EFI_TCG2_EVENT_LOG_FORMAT_TCG_2 :\n\t\tEFI_TCG2_EVENT_LOG_FORMAT_TCG_1_2;\n}\n\nint tpm_read_log_of(struct tpm_chip *chip)\n{\n\tstruct device_node *np;\n\tconst u32 *sizep;\n\tconst u64 *basep;\n\tstruct tpm_bios_log *log;\n\tu32 size;\n\tu64 base;\n\n\tlog = &chip->log;\n\tif (chip->dev.parent && chip->dev.parent->of_node)\n\t\tnp = chip->dev.parent->of_node;\n\telse\n\t\treturn -ENODEV;\n\n\tif (of_property_read_bool(np, \"powered-while-suspended\"))\n\t\tchip->flags |= TPM_CHIP_FLAG_ALWAYS_POWERED;\n\n\tsizep = of_get_property(np, \"linux,sml-size\", NULL);\n\tbasep = of_get_property(np, \"linux,sml-base\", NULL);\n\tif (sizep == NULL && basep == NULL)\n\t\treturn tpm_read_log_memory_region(chip);\n\tif (sizep == NULL || basep == NULL)\n\t\treturn -EIO;\n\n\t \n\tif (of_property_match_string(np, \"compatible\", \"IBM,vtpm\") < 0 &&\n\t    of_property_match_string(np, \"compatible\", \"IBM,vtpm20\") < 0) {\n\t\tsize = be32_to_cpup((__force __be32 *)sizep);\n\t\tbase = be64_to_cpup((__force __be64 *)basep);\n\t} else {\n\t\tsize = *sizep;\n\t\tbase = *basep;\n\t}\n\n\tif (size == 0) {\n\t\tdev_warn(&chip->dev, \"%s: Event log area empty\\n\", __func__);\n\t\treturn -EIO;\n\t}\n\n\tlog->bios_event_log = devm_kmemdup(&chip->dev, __va(base), size, GFP_KERNEL);\n\tif (!log->bios_event_log)\n\t\treturn -ENOMEM;\n\n\tlog->bios_event_log_end = log->bios_event_log + size;\n\n\tif (chip->flags & TPM_CHIP_FLAG_TPM2)\n\t\treturn EFI_TCG2_EVENT_LOG_FORMAT_TCG_2;\n\treturn EFI_TCG2_EVENT_LOG_FORMAT_TCG_1_2;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}