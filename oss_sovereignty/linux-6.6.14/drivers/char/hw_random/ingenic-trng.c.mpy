{
  "module_name": "ingenic-trng.c",
  "hash_id": "0699e37536c8eef3857eaed2e0c6acc21d2c0fe93bed275a56fa51ffd0b8fcfc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/hw_random/ingenic-trng.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/hw_random.h>\n#include <linux/io.h>\n#include <linux/iopoll.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\n \n#define TRNG_REG_CFG_OFFSET\t\t\t0x00\n#define TRNG_REG_RANDOMNUM_OFFSET\t0x04\n#define TRNG_REG_STATUS_OFFSET\t\t0x08\n\n \n#define CFG_GEN_EN\t\t\t\t\tBIT(0)\n\n \n#define STATUS_RANDOM_RDY\t\t\tBIT(0)\n\nstruct ingenic_trng {\n\tvoid __iomem *base;\n\tstruct hwrng rng;\n};\n\nstatic int ingenic_trng_init(struct hwrng *rng)\n{\n\tstruct ingenic_trng *trng = container_of(rng, struct ingenic_trng, rng);\n\tunsigned int ctrl;\n\n\tctrl = readl(trng->base + TRNG_REG_CFG_OFFSET);\n\tctrl |= CFG_GEN_EN;\n\twritel(ctrl, trng->base + TRNG_REG_CFG_OFFSET);\n\n\treturn 0;\n}\n\nstatic void ingenic_trng_cleanup(struct hwrng *rng)\n{\n\tstruct ingenic_trng *trng = container_of(rng, struct ingenic_trng, rng);\n\tunsigned int ctrl;\n\n\tctrl = readl(trng->base + TRNG_REG_CFG_OFFSET);\n\tctrl &= ~CFG_GEN_EN;\n\twritel(ctrl, trng->base + TRNG_REG_CFG_OFFSET);\n}\n\nstatic int ingenic_trng_read(struct hwrng *rng, void *buf, size_t max, bool wait)\n{\n\tstruct ingenic_trng *trng = container_of(rng, struct ingenic_trng, rng);\n\tu32 *data = buf;\n\tu32 status;\n\tint ret;\n\n\tret = readl_poll_timeout(trng->base + TRNG_REG_STATUS_OFFSET, status,\n\t\t\t\t status & STATUS_RANDOM_RDY, 10, 1000);\n\tif (ret == -ETIMEDOUT) {\n\t\tpr_err(\"%s: Wait for DTRNG data ready timeout\\n\", __func__);\n\t\treturn ret;\n\t}\n\n\t*data = readl(trng->base + TRNG_REG_RANDOMNUM_OFFSET);\n\n\treturn 4;\n}\n\nstatic int ingenic_trng_probe(struct platform_device *pdev)\n{\n\tstruct ingenic_trng *trng;\n\tstruct clk *clk;\n\tint ret;\n\n\ttrng = devm_kzalloc(&pdev->dev, sizeof(*trng), GFP_KERNEL);\n\tif (!trng)\n\t\treturn -ENOMEM;\n\n\ttrng->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(trng->base))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(trng->base),\n\t\t\t\t     \"%s: Failed to map DTRNG registers\\n\", __func__);\n\n\tclk = devm_clk_get_enabled(&pdev->dev, NULL);\n\tif (IS_ERR(clk))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(clk),\n\t\t\t\t     \"%s: Cannot get and enable DTRNG clock\\n\", __func__);\n\n\ttrng->rng.name = pdev->name;\n\ttrng->rng.init = ingenic_trng_init;\n\ttrng->rng.cleanup = ingenic_trng_cleanup;\n\ttrng->rng.read = ingenic_trng_read;\n\n\tret = devm_hwrng_register(&pdev->dev, &trng->rng);\n\tif (ret)\n\t\treturn dev_err_probe(&pdev->dev, ret, \"Failed to register hwrng\\n\");\n\n\tplatform_set_drvdata(pdev, trng);\n\n\tdev_info(&pdev->dev, \"Ingenic DTRNG driver registered\\n\");\n\treturn 0;\n}\n\nstatic const struct of_device_id ingenic_trng_of_match[] = {\n\t{ .compatible = \"ingenic,x1830-dtrng\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, ingenic_trng_of_match);\n\nstatic struct platform_driver ingenic_trng_driver = {\n\t.probe\t\t= ingenic_trng_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"ingenic-trng\",\n\t\t.of_match_table = ingenic_trng_of_match,\n\t},\n};\n\nmodule_platform_driver(ingenic_trng_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"\u6f06\u9e4f\u632f (Qi Pengzhen) <aric.pzqi@ingenic.com>\");\nMODULE_AUTHOR(\"\u5468\u7430\u6770 (Zhou Yanjie) <zhouyanjie@wanyeetech.com>\");\nMODULE_DESCRIPTION(\"Ingenic True Random Number Generator driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}