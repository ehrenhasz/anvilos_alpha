{
  "module_name": "hisi-rng.c",
  "hash_id": "d2414abe806c3445b18bbdbb86bff0d7f3a39c5a6ad65d6a2f277fad6fe0719a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/hw_random/hisi-rng.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/hw_random.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/random.h>\n\n#define RNG_SEED\t0x0\n#define RNG_CTRL\t0x4\n  #define RNG_SEED_SEL\tBIT(2)\n  #define RNG_RING_EN\tBIT(1)\n  #define RNG_EN\tBIT(0)\n#define RNG_RAN_NUM\t0x10\n#define RNG_PHY_SEED\t0x14\n\n#define to_hisi_rng(p)\tcontainer_of(p, struct hisi_rng, rng)\n\nstatic int seed_sel;\nmodule_param(seed_sel, int, S_IRUGO);\nMODULE_PARM_DESC(seed_sel, \"Auto reload seed. 0, use LFSR(default); 1, use ring oscillator.\");\n\nstruct hisi_rng {\n\tvoid __iomem *base;\n\tstruct hwrng rng;\n};\n\nstatic int hisi_rng_init(struct hwrng *rng)\n{\n\tstruct hisi_rng *hrng = to_hisi_rng(rng);\n\tint val = RNG_EN;\n\tu32 seed;\n\n\t \n\tget_random_bytes(&seed, sizeof(seed));\n\n\twritel_relaxed(seed, hrng->base + RNG_SEED);\n\n\t \n\tif (seed_sel == 1)\n\t\tval |= RNG_RING_EN | RNG_SEED_SEL;\n\n\twritel_relaxed(val, hrng->base + RNG_CTRL);\n\treturn 0;\n}\n\nstatic void hisi_rng_cleanup(struct hwrng *rng)\n{\n\tstruct hisi_rng *hrng = to_hisi_rng(rng);\n\n\twritel_relaxed(0, hrng->base + RNG_CTRL);\n}\n\nstatic int hisi_rng_read(struct hwrng *rng, void *buf, size_t max, bool wait)\n{\n\tstruct hisi_rng *hrng = to_hisi_rng(rng);\n\tu32 *data = buf;\n\n\t*data = readl_relaxed(hrng->base + RNG_RAN_NUM);\n\treturn 4;\n}\n\nstatic int hisi_rng_probe(struct platform_device *pdev)\n{\n\tstruct hisi_rng *rng;\n\tint ret;\n\n\trng = devm_kzalloc(&pdev->dev, sizeof(*rng), GFP_KERNEL);\n\tif (!rng)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, rng);\n\n\trng->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(rng->base))\n\t\treturn PTR_ERR(rng->base);\n\n\trng->rng.name = pdev->name;\n\trng->rng.init = hisi_rng_init;\n\trng->rng.cleanup = hisi_rng_cleanup;\n\trng->rng.read = hisi_rng_read;\n\n\tret = devm_hwrng_register(&pdev->dev, &rng->rng);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to register hwrng\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id hisi_rng_dt_ids[] __maybe_unused = {\n\t{ .compatible = \"hisilicon,hip04-rng\" },\n\t{ .compatible = \"hisilicon,hip05-rng\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, hisi_rng_dt_ids);\n\nstatic struct platform_driver hisi_rng_driver = {\n\t.probe\t\t= hisi_rng_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"hisi-rng\",\n\t\t.of_match_table = of_match_ptr(hisi_rng_dt_ids),\n\t},\n};\n\nmodule_platform_driver(hisi_rng_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Kefeng Wang <wangkefeng.wang@huawei>\");\nMODULE_DESCRIPTION(\"Hisilicon random number generator driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}