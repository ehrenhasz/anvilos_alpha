{
  "module_name": "geode-rng.c",
  "hash_id": "ed22b84fdf6244dbfe03ab37b5860a73eda8b2e996cd1859dfa6d2bebc6c12ca",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/hw_random/geode-rng.c",
  "human_readable_source": " \n\n#include <linux/delay.h>\n#include <linux/hw_random.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n\n\n#define PFX\tKBUILD_MODNAME \": \"\n\n#define GEODE_RNG_DATA_REG   0x50\n#define GEODE_RNG_STATUS_REG 0x54\n\n \nstatic const struct pci_device_id pci_tbl[] = {\n\t{ PCI_VDEVICE(AMD, PCI_DEVICE_ID_AMD_LX_AES), 0, },\n\t{ 0, },\t \n};\nMODULE_DEVICE_TABLE(pci, pci_tbl);\n\nstruct amd_geode_priv {\n\tstruct pci_dev *pcidev;\n\tvoid __iomem *membase;\n};\n\nstatic int geode_rng_data_read(struct hwrng *rng, u32 *data)\n{\n\tstruct amd_geode_priv *priv = (struct amd_geode_priv *)rng->priv;\n\tvoid __iomem *mem = priv->membase;\n\n\t*data = readl(mem + GEODE_RNG_DATA_REG);\n\n\treturn 4;\n}\n\nstatic int geode_rng_data_present(struct hwrng *rng, int wait)\n{\n\tstruct amd_geode_priv *priv = (struct amd_geode_priv *)rng->priv;\n\tvoid __iomem *mem = priv->membase;\n\tint data, i;\n\n\tfor (i = 0; i < 20; i++) {\n\t\tdata = !!(readl(mem + GEODE_RNG_STATUS_REG));\n\t\tif (data || !wait)\n\t\t\tbreak;\n\t\tudelay(10);\n\t}\n\treturn data;\n}\n\n\nstatic struct hwrng geode_rng = {\n\t.name\t\t= \"geode\",\n\t.data_present\t= geode_rng_data_present,\n\t.data_read\t= geode_rng_data_read,\n};\n\n\nstatic int __init geode_rng_init(void)\n{\n\tint err = -ENODEV;\n\tstruct pci_dev *pdev = NULL;\n\tconst struct pci_device_id *ent;\n\tvoid __iomem *mem;\n\tunsigned long rng_base;\n\tstruct amd_geode_priv *priv;\n\n\tfor_each_pci_dev(pdev) {\n\t\tent = pci_match_id(pci_tbl, pdev);\n\t\tif (ent)\n\t\t\tgoto found;\n\t}\n\t \n\treturn err;\n\nfound:\n\tpriv = kzalloc(sizeof(*priv), GFP_KERNEL);\n\tif (!priv) {\n\t\terr = -ENOMEM;\n\t\tgoto put_dev;\n\t}\n\n\trng_base = pci_resource_start(pdev, 0);\n\tif (rng_base == 0)\n\t\tgoto free_priv;\n\terr = -ENOMEM;\n\tmem = ioremap(rng_base, 0x58);\n\tif (!mem)\n\t\tgoto free_priv;\n\n\tgeode_rng.priv = (unsigned long)priv;\n\tpriv->membase = mem;\n\tpriv->pcidev = pdev;\n\n\tpr_info(\"AMD Geode RNG detected\\n\");\n\terr = hwrng_register(&geode_rng);\n\tif (err) {\n\t\tpr_err(PFX \"RNG registering failed (%d)\\n\",\n\t\t       err);\n\t\tgoto err_unmap;\n\t}\n\treturn err;\n\nerr_unmap:\n\tiounmap(mem);\nfree_priv:\n\tkfree(priv);\nput_dev:\n\tpci_dev_put(pdev);\n\treturn err;\n}\n\nstatic void __exit geode_rng_exit(void)\n{\n\tstruct amd_geode_priv *priv;\n\n\tpriv = (struct amd_geode_priv *)geode_rng.priv;\n\thwrng_unregister(&geode_rng);\n\tiounmap(priv->membase);\n\tpci_dev_put(priv->pcidev);\n\tkfree(priv);\n}\n\nmodule_init(geode_rng_init);\nmodule_exit(geode_rng_exit);\n\nMODULE_DESCRIPTION(\"H/W RNG driver for AMD Geode LX CPUs\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}