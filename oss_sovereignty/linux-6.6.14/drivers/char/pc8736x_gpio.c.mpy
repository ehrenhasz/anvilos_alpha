{
  "module_name": "pc8736x_gpio.c",
  "hash_id": "0be2e96a21e72648fdcbe58c5b0b4ae56aa9c98fcd2b6b8f38f5b7307180baaf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/pc8736x_gpio.c",
  "human_readable_source": "\n \n\n#include <linux/fs.h>\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/cdev.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n#include <linux/mutex.h>\n#include <linux/nsc_gpio.h>\n#include <linux/platform_device.h>\n#include <linux/uaccess.h>\n\n#define DEVNAME \"pc8736x_gpio\"\n\nMODULE_AUTHOR(\"Jim Cromie <jim.cromie@gmail.com>\");\nMODULE_DESCRIPTION(\"NatSemi/Winbond PC-8736x GPIO Pin Driver\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int major;\t\t \nmodule_param(major, int, 0);\nMODULE_PARM_DESC(major, \"Major device number\");\n\nstatic DEFINE_MUTEX(pc8736x_gpio_config_lock);\nstatic unsigned pc8736x_gpio_base;\nstatic u8 pc8736x_gpio_shadow[4];\n\n#define SIO_BASE1       0x2E\t \n#define SIO_BASE2       0x4E\t \n\n#define SIO_SID\t\t0x20\t \n#define SIO_SID_PC87365\t0xe5\t \n#define SIO_SID_PC87366\t0xe9\t \n\n#define SIO_CF1\t\t0x21\t \n\n#define PC8736X_GPIO_RANGE\t16  \n#define PC8736X_GPIO_CT\t\t32  \n\n#define SIO_UNIT_SEL\t0x7\t \n#define SIO_UNIT_ACT\t0x30\t \n#define SIO_GPIO_UNIT\t0x7\t \n#define SIO_VLM_UNIT\t0x0D\n#define SIO_TMS_UNIT\t0x0E\n\n \n#define SIO_BASE_HADDR\t\t0x60\n#define SIO_BASE_LADDR\t\t0x61\n\n \n#define SIO_GPIO_PIN_SELECT\t0xF0\n#define SIO_GPIO_PIN_CONFIG     0xF1\n#define SIO_GPIO_PIN_EVENT      0xF2\n\nstatic unsigned char superio_cmd = 0;\nstatic unsigned char selected_device = 0xFF;\t \n\n \nstatic int port_offset[] = { 0, 4, 8, 10 };\t \n \n\n#define PORT_OUT\t0\n#define PORT_IN\t\t1\n#define PORT_EVT_EN\t2\n#define PORT_EVT_STST\t3\n\nstatic struct platform_device *pdev;   \n\nstatic inline void superio_outb(int addr, int val)\n{\n\toutb_p(addr, superio_cmd);\n\toutb_p(val, superio_cmd + 1);\n}\n\nstatic inline int superio_inb(int addr)\n{\n\toutb_p(addr, superio_cmd);\n\treturn inb_p(superio_cmd + 1);\n}\n\nstatic int pc8736x_superio_present(void)\n{\n\tint id;\n\n\t \n\tsuperio_cmd = SIO_BASE1;\n\tid = superio_inb(SIO_SID);\n\tif (id == SIO_SID_PC87365 || id == SIO_SID_PC87366)\n\t\treturn superio_cmd;\n\n\tsuperio_cmd = SIO_BASE2;\n\tid = superio_inb(SIO_SID);\n\tif (id == SIO_SID_PC87365 || id == SIO_SID_PC87366)\n\t\treturn superio_cmd;\n\n\treturn 0;\n}\n\nstatic void device_select(unsigned devldn)\n{\n\tsuperio_outb(SIO_UNIT_SEL, devldn);\n\tselected_device = devldn;\n}\n\nstatic void select_pin(unsigned iminor)\n{\n\t \n\tdevice_select(SIO_GPIO_UNIT);\n\tsuperio_outb(SIO_GPIO_PIN_SELECT,\n\t\t     ((iminor << 1) & 0xF0) | (iminor & 0x7));\n}\n\nstatic inline u32 pc8736x_gpio_configure_fn(unsigned index, u32 mask, u32 bits,\n\t\t\t\t\t    u32 func_slct)\n{\n\tu32 config, new_config;\n\n\tmutex_lock(&pc8736x_gpio_config_lock);\n\n\tdevice_select(SIO_GPIO_UNIT);\n\tselect_pin(index);\n\n\t \n\tconfig = superio_inb(func_slct);\n\n\t \n\tnew_config = (config & mask) | bits;\n\tsuperio_outb(func_slct, new_config);\n\n\tmutex_unlock(&pc8736x_gpio_config_lock);\n\n\treturn config;\n}\n\nstatic u32 pc8736x_gpio_configure(unsigned index, u32 mask, u32 bits)\n{\n\treturn pc8736x_gpio_configure_fn(index, mask, bits,\n\t\t\t\t\t SIO_GPIO_PIN_CONFIG);\n}\n\nstatic int pc8736x_gpio_get(unsigned minor)\n{\n\tint port, bit, val;\n\n\tport = minor >> 3;\n\tbit = minor & 7;\n\tval = inb_p(pc8736x_gpio_base + port_offset[port] + PORT_IN);\n\tval >>= bit;\n\tval &= 1;\n\n\tdev_dbg(&pdev->dev, \"_gpio_get(%d from %x bit %d) == val %d\\n\",\n\t\tminor, pc8736x_gpio_base + port_offset[port] + PORT_IN, bit,\n\t\tval);\n\n\treturn val;\n}\n\nstatic void pc8736x_gpio_set(unsigned minor, int val)\n{\n\tint port, bit, curval;\n\n\tminor &= 0x1f;\n\tport = minor >> 3;\n\tbit = minor & 7;\n\tcurval = inb_p(pc8736x_gpio_base + port_offset[port] + PORT_OUT);\n\n\tdev_dbg(&pdev->dev, \"addr:%x cur:%x bit-pos:%d cur-bit:%x + new:%d -> bit-new:%d\\n\",\n\t\tpc8736x_gpio_base + port_offset[port] + PORT_OUT,\n\t\tcurval, bit, (curval & ~(1 << bit)), val, (val << bit));\n\n\tval = (curval & ~(1 << bit)) | (val << bit);\n\n\tdev_dbg(&pdev->dev, \"gpio_set(minor:%d port:%d bit:%d)\"\n\t\t\" %2x -> %2x\\n\", minor, port, bit, curval, val);\n\n\toutb_p(val, pc8736x_gpio_base + port_offset[port] + PORT_OUT);\n\n\tcurval = inb_p(pc8736x_gpio_base + port_offset[port] + PORT_OUT);\n\tval = inb_p(pc8736x_gpio_base + port_offset[port] + PORT_IN);\n\n\tdev_dbg(&pdev->dev, \"wrote %x, read: %x\\n\", curval, val);\n\tpc8736x_gpio_shadow[port] = val;\n}\n\nstatic int pc8736x_gpio_current(unsigned minor)\n{\n\tint port, bit;\n\tminor &= 0x1f;\n\tport = minor >> 3;\n\tbit = minor & 7;\n\treturn ((pc8736x_gpio_shadow[port] >> bit) & 0x01);\n}\n\nstatic void pc8736x_gpio_change(unsigned index)\n{\n\tpc8736x_gpio_set(index, !pc8736x_gpio_current(index));\n}\n\nstatic struct nsc_gpio_ops pc8736x_gpio_ops = {\n\t.owner\t\t= THIS_MODULE,\n\t.gpio_config\t= pc8736x_gpio_configure,\n\t.gpio_dump\t= nsc_gpio_dump,\n\t.gpio_get\t= pc8736x_gpio_get,\n\t.gpio_set\t= pc8736x_gpio_set,\n\t.gpio_change\t= pc8736x_gpio_change,\n\t.gpio_current\t= pc8736x_gpio_current\n};\n\nstatic int pc8736x_gpio_open(struct inode *inode, struct file *file)\n{\n\tunsigned m = iminor(inode);\n\tfile->private_data = &pc8736x_gpio_ops;\n\n\tdev_dbg(&pdev->dev, \"open %d\\n\", m);\n\n\tif (m >= PC8736X_GPIO_CT)\n\t\treturn -EINVAL;\n\treturn nonseekable_open(inode, file);\n}\n\nstatic const struct file_operations pc8736x_gpio_fileops = {\n\t.owner\t= THIS_MODULE,\n\t.open\t= pc8736x_gpio_open,\n\t.write\t= nsc_gpio_write,\n\t.read\t= nsc_gpio_read,\n\t.llseek = no_llseek,\n};\n\nstatic void __init pc8736x_init_shadow(void)\n{\n\tint port;\n\n\t \n\tfor (port = 0; port < 4; ++port)\n\t\tpc8736x_gpio_shadow[port]\n\t\t    = inb_p(pc8736x_gpio_base + port_offset[port]\n\t\t\t    + PORT_OUT);\n\n}\n\nstatic struct cdev pc8736x_gpio_cdev;\n\nstatic int __init pc8736x_gpio_init(void)\n{\n\tint rc;\n\tdev_t devid;\n\n\tpdev = platform_device_alloc(DEVNAME, 0);\n\tif (!pdev)\n\t\treturn -ENOMEM;\n\n\trc = platform_device_add(pdev);\n\tif (rc) {\n\t\trc = -ENODEV;\n\t\tgoto undo_platform_dev_alloc;\n\t}\n\tdev_info(&pdev->dev, \"NatSemi pc8736x GPIO Driver Initializing\\n\");\n\n\tif (!pc8736x_superio_present()) {\n\t\trc = -ENODEV;\n\t\tdev_err(&pdev->dev, \"no device found\\n\");\n\t\tgoto undo_platform_dev_add;\n\t}\n\tpc8736x_gpio_ops.dev = &pdev->dev;\n\n\t \n\trc = superio_inb(SIO_CF1);\n\tif (!(rc & 0x01)) {\n\t\trc = -ENODEV;\n\t\tdev_err(&pdev->dev, \"device not enabled\\n\");\n\t\tgoto undo_platform_dev_add;\n\t}\n\tdevice_select(SIO_GPIO_UNIT);\n\tif (!superio_inb(SIO_UNIT_ACT)) {\n\t\trc = -ENODEV;\n\t\tdev_err(&pdev->dev, \"GPIO unit not enabled\\n\");\n\t\tgoto undo_platform_dev_add;\n\t}\n\n\t \n\tpc8736x_gpio_base = (superio_inb(SIO_BASE_HADDR) << 8\n\t\t\t     | superio_inb(SIO_BASE_LADDR));\n\n\tif (!request_region(pc8736x_gpio_base, PC8736X_GPIO_RANGE, DEVNAME)) {\n\t\trc = -ENODEV;\n\t\tdev_err(&pdev->dev, \"GPIO ioport %x busy\\n\",\n\t\t\tpc8736x_gpio_base);\n\t\tgoto undo_platform_dev_add;\n\t}\n\tdev_info(&pdev->dev, \"GPIO ioport %x reserved\\n\", pc8736x_gpio_base);\n\n\tif (major) {\n\t\tdevid = MKDEV(major, 0);\n\t\trc = register_chrdev_region(devid, PC8736X_GPIO_CT, DEVNAME);\n\t} else {\n\t\trc = alloc_chrdev_region(&devid, 0, PC8736X_GPIO_CT, DEVNAME);\n\t\tmajor = MAJOR(devid);\n\t}\n\n\tif (rc < 0) {\n\t\tdev_err(&pdev->dev, \"register-chrdev failed: %d\\n\", rc);\n\t\tgoto undo_request_region;\n\t}\n\tif (!major) {\n\t\tmajor = rc;\n\t\tdev_dbg(&pdev->dev, \"got dynamic major %d\\n\", major);\n\t}\n\n\tpc8736x_init_shadow();\n\n\t \n\tcdev_init(&pc8736x_gpio_cdev, &pc8736x_gpio_fileops);\n\tcdev_add(&pc8736x_gpio_cdev, devid, PC8736X_GPIO_CT);\n\n\treturn 0;\n\nundo_request_region:\n\trelease_region(pc8736x_gpio_base, PC8736X_GPIO_RANGE);\nundo_platform_dev_add:\n\tplatform_device_del(pdev);\nundo_platform_dev_alloc:\n\tplatform_device_put(pdev);\n\n\treturn rc;\n}\n\nstatic void __exit pc8736x_gpio_cleanup(void)\n{\n\tdev_dbg(&pdev->dev, \"cleanup\\n\");\n\n\tcdev_del(&pc8736x_gpio_cdev);\n\tunregister_chrdev_region(MKDEV(major,0), PC8736X_GPIO_CT);\n\trelease_region(pc8736x_gpio_base, PC8736X_GPIO_RANGE);\n\n\tplatform_device_unregister(pdev);\n}\n\nmodule_init(pc8736x_gpio_init);\nmodule_exit(pc8736x_gpio_cleanup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}