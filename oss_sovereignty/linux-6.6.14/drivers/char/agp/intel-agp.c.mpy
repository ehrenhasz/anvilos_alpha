{
  "module_name": "intel-agp.c",
  "hash_id": "b61681dd20ed88f4b160da2cc625b076f93585b5ed7c354474f4abe775064267",
  "original_prompt": "Ingested from linux-6.6.14/drivers/char/agp/intel-agp.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/pagemap.h>\n#include <linux/agp_backend.h>\n#include <asm/smp.h>\n#include \"agp.h\"\n#include \"intel-agp.h\"\n#include <drm/intel-gtt.h>\n\nstatic int intel_fetch_size(void)\n{\n\tint i;\n\tu16 temp;\n\tstruct aper_size_info_16 *values;\n\n\tpci_read_config_word(agp_bridge->dev, INTEL_APSIZE, &temp);\n\tvalues = A_SIZE_16(agp_bridge->driver->aperture_sizes);\n\n\tfor (i = 0; i < agp_bridge->driver->num_aperture_sizes; i++) {\n\t\tif (temp == values[i].size_value) {\n\t\t\tagp_bridge->previous_size = agp_bridge->current_size = (void *) (values + i);\n\t\t\tagp_bridge->aperture_size_idx = i;\n\t\t\treturn values[i].size;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int __intel_8xx_fetch_size(u8 temp)\n{\n\tint i;\n\tstruct aper_size_info_8 *values;\n\n\tvalues = A_SIZE_8(agp_bridge->driver->aperture_sizes);\n\n\tfor (i = 0; i < agp_bridge->driver->num_aperture_sizes; i++) {\n\t\tif (temp == values[i].size_value) {\n\t\t\tagp_bridge->previous_size =\n\t\t\t\tagp_bridge->current_size = (void *) (values + i);\n\t\t\tagp_bridge->aperture_size_idx = i;\n\t\t\treturn values[i].size;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic int intel_8xx_fetch_size(void)\n{\n\tu8 temp;\n\n\tpci_read_config_byte(agp_bridge->dev, INTEL_APSIZE, &temp);\n\treturn __intel_8xx_fetch_size(temp);\n}\n\nstatic int intel_815_fetch_size(void)\n{\n\tu8 temp;\n\n\t \n\tpci_read_config_byte(agp_bridge->dev, INTEL_APSIZE, &temp);\n\ttemp &= (1 << 3);\n\n\treturn __intel_8xx_fetch_size(temp);\n}\n\nstatic void intel_tlbflush(struct agp_memory *mem)\n{\n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x2200);\n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x2280);\n}\n\n\nstatic void intel_8xx_tlbflush(struct agp_memory *mem)\n{\n\tu32 temp;\n\tpci_read_config_dword(agp_bridge->dev, INTEL_AGPCTRL, &temp);\n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, temp & ~(1 << 7));\n\tpci_read_config_dword(agp_bridge->dev, INTEL_AGPCTRL, &temp);\n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, temp | (1 << 7));\n}\n\n\nstatic void intel_cleanup(void)\n{\n\tu16 temp;\n\tstruct aper_size_info_16 *previous_size;\n\n\tprevious_size = A_SIZE_16(agp_bridge->previous_size);\n\tpci_read_config_word(agp_bridge->dev, INTEL_NBXCFG, &temp);\n\tpci_write_config_word(agp_bridge->dev, INTEL_NBXCFG, temp & ~(1 << 9));\n\tpci_write_config_word(agp_bridge->dev, INTEL_APSIZE, previous_size->size_value);\n}\n\n\nstatic void intel_8xx_cleanup(void)\n{\n\tu16 temp;\n\tstruct aper_size_info_8 *previous_size;\n\n\tprevious_size = A_SIZE_8(agp_bridge->previous_size);\n\tpci_read_config_word(agp_bridge->dev, INTEL_NBXCFG, &temp);\n\tpci_write_config_word(agp_bridge->dev, INTEL_NBXCFG, temp & ~(1 << 9));\n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, previous_size->size_value);\n}\n\n\nstatic int intel_configure(void)\n{\n\tu16 temp2;\n\tstruct aper_size_info_16 *current_size;\n\n\tcurrent_size = A_SIZE_16(agp_bridge->current_size);\n\n\t \n\tpci_write_config_word(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\n\n\t \n\tagp_bridge->gart_bus_addr = pci_bus_address(agp_bridge->dev,\n\t\t\t\t\t\t    AGP_APERTURE_BAR);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x2280);\n\n\t \n\tpci_read_config_word(agp_bridge->dev, INTEL_NBXCFG, &temp2);\n\tpci_write_config_word(agp_bridge->dev, INTEL_NBXCFG,\n\t\t\t(temp2 & ~(1 << 10)) | (1 << 9));\n\t \n\tpci_write_config_byte(agp_bridge->dev, INTEL_ERRSTS + 1, 7);\n\treturn 0;\n}\n\nstatic int intel_815_configure(void)\n{\n\tu32 addr;\n\tu8 temp2;\n\tstruct aper_size_info_8 *current_size;\n\n\t \n\t \n\tif (agp_bridge->gatt_bus_addr & INTEL_815_ATTBASE_MASK) {\n\t\tdev_emerg(&agp_bridge->dev->dev, \"gatt bus addr too high\");\n\t\treturn -EINVAL;\n\t}\n\n\tcurrent_size = A_SIZE_8(agp_bridge->current_size);\n\n\t \n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE,\n\t\t\tcurrent_size->size_value);\n\n\t \n\tagp_bridge->gart_bus_addr = pci_bus_address(agp_bridge->dev,\n\t\t\t\t\t\t    AGP_APERTURE_BAR);\n\n\tpci_read_config_dword(agp_bridge->dev, INTEL_ATTBASE, &addr);\n\taddr &= INTEL_815_ATTBASE_MASK;\n\taddr |= agp_bridge->gatt_bus_addr;\n\tpci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, addr);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\n\n\t \n\tpci_read_config_byte(agp_bridge->dev, INTEL_815_APCONT, &temp2);\n\tpci_write_config_byte(agp_bridge->dev, INTEL_815_APCONT, temp2 | (1 << 1));\n\n\t \n\t \n\treturn 0;\n}\n\nstatic void intel_820_tlbflush(struct agp_memory *mem)\n{\n\treturn;\n}\n\nstatic void intel_820_cleanup(void)\n{\n\tu8 temp;\n\tstruct aper_size_info_8 *previous_size;\n\n\tprevious_size = A_SIZE_8(agp_bridge->previous_size);\n\tpci_read_config_byte(agp_bridge->dev, INTEL_I820_RDCR, &temp);\n\tpci_write_config_byte(agp_bridge->dev, INTEL_I820_RDCR,\n\t\t\ttemp & ~(1 << 1));\n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE,\n\t\t\tprevious_size->size_value);\n}\n\n\nstatic int intel_820_configure(void)\n{\n\tu8 temp2;\n\tstruct aper_size_info_8 *current_size;\n\n\tcurrent_size = A_SIZE_8(agp_bridge->current_size);\n\n\t \n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\n\n\t \n\tagp_bridge->gart_bus_addr = pci_bus_address(agp_bridge->dev,\n\t\t\t\t\t\t    AGP_APERTURE_BAR);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\n\n\t \n\t \n\t \n\tpci_read_config_byte(agp_bridge->dev, INTEL_I820_RDCR, &temp2);\n\tpci_write_config_byte(agp_bridge->dev, INTEL_I820_RDCR, temp2 | (1 << 1));\n\t \n\tpci_write_config_word(agp_bridge->dev, INTEL_I820_ERRSTS, 0x001c);\n\treturn 0;\n}\n\nstatic int intel_840_configure(void)\n{\n\tu16 temp2;\n\tstruct aper_size_info_8 *current_size;\n\n\tcurrent_size = A_SIZE_8(agp_bridge->current_size);\n\n\t \n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\n\n\t \n\tagp_bridge->gart_bus_addr = pci_bus_address(agp_bridge->dev,\n\t\t\t\t\t\t    AGP_APERTURE_BAR);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\n\n\t \n\tpci_read_config_word(agp_bridge->dev, INTEL_I840_MCHCFG, &temp2);\n\tpci_write_config_word(agp_bridge->dev, INTEL_I840_MCHCFG, temp2 | (1 << 9));\n\t \n\tpci_write_config_word(agp_bridge->dev, INTEL_I840_ERRSTS, 0xc000);\n\treturn 0;\n}\n\nstatic int intel_845_configure(void)\n{\n\tu8 temp2;\n\tstruct aper_size_info_8 *current_size;\n\n\tcurrent_size = A_SIZE_8(agp_bridge->current_size);\n\n\t \n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\n\n\tif (agp_bridge->apbase_config != 0) {\n\t\tpci_write_config_dword(agp_bridge->dev, AGP_APBASE,\n\t\t\t\t       agp_bridge->apbase_config);\n\t} else {\n\t\t \n\t\tagp_bridge->gart_bus_addr = pci_bus_address(agp_bridge->dev,\n\t\t\t\t\t\t\t    AGP_APERTURE_BAR);\n\t\tagp_bridge->apbase_config = agp_bridge->gart_bus_addr;\n\t}\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\n\n\t \n\tpci_read_config_byte(agp_bridge->dev, INTEL_I845_AGPM, &temp2);\n\tpci_write_config_byte(agp_bridge->dev, INTEL_I845_AGPM, temp2 | (1 << 1));\n\t \n\tpci_write_config_word(agp_bridge->dev, INTEL_I845_ERRSTS, 0x001c);\n\treturn 0;\n}\n\nstatic int intel_850_configure(void)\n{\n\tu16 temp2;\n\tstruct aper_size_info_8 *current_size;\n\n\tcurrent_size = A_SIZE_8(agp_bridge->current_size);\n\n\t \n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\n\n\t \n\tagp_bridge->gart_bus_addr = pci_bus_address(agp_bridge->dev,\n\t\t\t\t\t\t    AGP_APERTURE_BAR);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\n\n\t \n\tpci_read_config_word(agp_bridge->dev, INTEL_I850_MCHCFG, &temp2);\n\tpci_write_config_word(agp_bridge->dev, INTEL_I850_MCHCFG, temp2 | (1 << 9));\n\t \n\tpci_write_config_word(agp_bridge->dev, INTEL_I850_ERRSTS, 0x001c);\n\treturn 0;\n}\n\nstatic int intel_860_configure(void)\n{\n\tu16 temp2;\n\tstruct aper_size_info_8 *current_size;\n\n\tcurrent_size = A_SIZE_8(agp_bridge->current_size);\n\n\t \n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\n\n\t \n\tagp_bridge->gart_bus_addr = pci_bus_address(agp_bridge->dev,\n\t\t\t\t\t\t    AGP_APERTURE_BAR);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\n\n\t \n\tpci_read_config_word(agp_bridge->dev, INTEL_I860_MCHCFG, &temp2);\n\tpci_write_config_word(agp_bridge->dev, INTEL_I860_MCHCFG, temp2 | (1 << 9));\n\t \n\tpci_write_config_word(agp_bridge->dev, INTEL_I860_ERRSTS, 0xf700);\n\treturn 0;\n}\n\nstatic int intel_830mp_configure(void)\n{\n\tu16 temp2;\n\tstruct aper_size_info_8 *current_size;\n\n\tcurrent_size = A_SIZE_8(agp_bridge->current_size);\n\n\t \n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\n\n\t \n\tagp_bridge->gart_bus_addr = pci_bus_address(agp_bridge->dev,\n\t\t\t\t\t\t    AGP_APERTURE_BAR);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\n\n\t \n\tpci_read_config_word(agp_bridge->dev, INTEL_NBXCFG, &temp2);\n\tpci_write_config_word(agp_bridge->dev, INTEL_NBXCFG, temp2 | (1 << 9));\n\t \n\tpci_write_config_word(agp_bridge->dev, INTEL_I830_ERRSTS, 0x1c);\n\treturn 0;\n}\n\nstatic int intel_7505_configure(void)\n{\n\tu16 temp2;\n\tstruct aper_size_info_8 *current_size;\n\n\tcurrent_size = A_SIZE_8(agp_bridge->current_size);\n\n\t \n\tpci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\n\n\t \n\tagp_bridge->gart_bus_addr = pci_bus_address(agp_bridge->dev,\n\t\t\t\t\t\t    AGP_APERTURE_BAR);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\n\n\t \n\tpci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\n\n\t \n\tpci_read_config_word(agp_bridge->dev, INTEL_I7505_MCHCFG, &temp2);\n\tpci_write_config_word(agp_bridge->dev, INTEL_I7505_MCHCFG, temp2 | (1 << 9));\n\n\treturn 0;\n}\n\n \nstatic const struct gatt_mask intel_generic_masks[] =\n{\n\t{.mask = 0x00000017, .type = 0}\n};\n\nstatic const struct aper_size_info_8 intel_815_sizes[2] =\n{\n\t{64, 16384, 4, 0},\n\t{32, 8192, 3, 8},\n};\n\nstatic const struct aper_size_info_8 intel_8xx_sizes[7] =\n{\n\t{256, 65536, 6, 0},\n\t{128, 32768, 5, 32},\n\t{64, 16384, 4, 48},\n\t{32, 8192, 3, 56},\n\t{16, 4096, 2, 60},\n\t{8, 2048, 1, 62},\n\t{4, 1024, 0, 63}\n};\n\nstatic const struct aper_size_info_16 intel_generic_sizes[7] =\n{\n\t{256, 65536, 6, 0},\n\t{128, 32768, 5, 32},\n\t{64, 16384, 4, 48},\n\t{32, 8192, 3, 56},\n\t{16, 4096, 2, 60},\n\t{8, 2048, 1, 62},\n\t{4, 1024, 0, 63}\n};\n\nstatic const struct aper_size_info_8 intel_830mp_sizes[4] =\n{\n\t{256, 65536, 6, 0},\n\t{128, 32768, 5, 32},\n\t{64, 16384, 4, 48},\n\t{32, 8192, 3, 56}\n};\n\nstatic const struct agp_bridge_driver intel_generic_driver = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.aperture_sizes\t\t= intel_generic_sizes,\n\t.size_type\t\t= U16_APER_SIZE,\n\t.num_aperture_sizes\t= 7,\n\t.needs_scratch_page\t= true,\n\t.configure\t\t= intel_configure,\n\t.fetch_size\t\t= intel_fetch_size,\n\t.cleanup\t\t= intel_cleanup,\n\t.tlb_flush\t\t= intel_tlbflush,\n\t.mask_memory\t\t= agp_generic_mask_memory,\n\t.masks\t\t\t= intel_generic_masks,\n\t.agp_enable\t\t= agp_generic_enable,\n\t.cache_flush\t\t= global_cache_flush,\n\t.create_gatt_table\t= agp_generic_create_gatt_table,\n\t.free_gatt_table\t= agp_generic_free_gatt_table,\n\t.insert_memory\t\t= agp_generic_insert_memory,\n\t.remove_memory\t\t= agp_generic_remove_memory,\n\t.alloc_by_type\t\t= agp_generic_alloc_by_type,\n\t.free_by_type\t\t= agp_generic_free_by_type,\n\t.agp_alloc_page\t\t= agp_generic_alloc_page,\n\t.agp_alloc_pages        = agp_generic_alloc_pages,\n\t.agp_destroy_page\t= agp_generic_destroy_page,\n\t.agp_destroy_pages      = agp_generic_destroy_pages,\n\t.agp_type_to_mask_type  = agp_generic_type_to_mask_type,\n};\n\nstatic const struct agp_bridge_driver intel_815_driver = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.aperture_sizes\t\t= intel_815_sizes,\n\t.size_type\t\t= U8_APER_SIZE,\n\t.num_aperture_sizes\t= 2,\n\t.needs_scratch_page\t= true,\n\t.configure\t\t= intel_815_configure,\n\t.fetch_size\t\t= intel_815_fetch_size,\n\t.cleanup\t\t= intel_8xx_cleanup,\n\t.tlb_flush\t\t= intel_8xx_tlbflush,\n\t.mask_memory\t\t= agp_generic_mask_memory,\n\t.masks\t\t\t= intel_generic_masks,\n\t.agp_enable\t\t= agp_generic_enable,\n\t.cache_flush\t\t= global_cache_flush,\n\t.create_gatt_table\t= agp_generic_create_gatt_table,\n\t.free_gatt_table\t= agp_generic_free_gatt_table,\n\t.insert_memory\t\t= agp_generic_insert_memory,\n\t.remove_memory\t\t= agp_generic_remove_memory,\n\t.alloc_by_type\t\t= agp_generic_alloc_by_type,\n\t.free_by_type\t\t= agp_generic_free_by_type,\n\t.agp_alloc_page\t\t= agp_generic_alloc_page,\n\t.agp_alloc_pages        = agp_generic_alloc_pages,\n\t.agp_destroy_page\t= agp_generic_destroy_page,\n\t.agp_destroy_pages      = agp_generic_destroy_pages,\n\t.agp_type_to_mask_type\t= agp_generic_type_to_mask_type,\n};\n\nstatic const struct agp_bridge_driver intel_820_driver = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.aperture_sizes\t\t= intel_8xx_sizes,\n\t.size_type\t\t= U8_APER_SIZE,\n\t.num_aperture_sizes\t= 7,\n\t.needs_scratch_page\t= true,\n\t.configure\t\t= intel_820_configure,\n\t.fetch_size\t\t= intel_8xx_fetch_size,\n\t.cleanup\t\t= intel_820_cleanup,\n\t.tlb_flush\t\t= intel_820_tlbflush,\n\t.mask_memory\t\t= agp_generic_mask_memory,\n\t.masks\t\t\t= intel_generic_masks,\n\t.agp_enable\t\t= agp_generic_enable,\n\t.cache_flush\t\t= global_cache_flush,\n\t.create_gatt_table\t= agp_generic_create_gatt_table,\n\t.free_gatt_table\t= agp_generic_free_gatt_table,\n\t.insert_memory\t\t= agp_generic_insert_memory,\n\t.remove_memory\t\t= agp_generic_remove_memory,\n\t.alloc_by_type\t\t= agp_generic_alloc_by_type,\n\t.free_by_type\t\t= agp_generic_free_by_type,\n\t.agp_alloc_page\t\t= agp_generic_alloc_page,\n\t.agp_alloc_pages        = agp_generic_alloc_pages,\n\t.agp_destroy_page\t= agp_generic_destroy_page,\n\t.agp_destroy_pages      = agp_generic_destroy_pages,\n\t.agp_type_to_mask_type  = agp_generic_type_to_mask_type,\n};\n\nstatic const struct agp_bridge_driver intel_830mp_driver = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.aperture_sizes\t\t= intel_830mp_sizes,\n\t.size_type\t\t= U8_APER_SIZE,\n\t.num_aperture_sizes\t= 4,\n\t.needs_scratch_page\t= true,\n\t.configure\t\t= intel_830mp_configure,\n\t.fetch_size\t\t= intel_8xx_fetch_size,\n\t.cleanup\t\t= intel_8xx_cleanup,\n\t.tlb_flush\t\t= intel_8xx_tlbflush,\n\t.mask_memory\t\t= agp_generic_mask_memory,\n\t.masks\t\t\t= intel_generic_masks,\n\t.agp_enable\t\t= agp_generic_enable,\n\t.cache_flush\t\t= global_cache_flush,\n\t.create_gatt_table\t= agp_generic_create_gatt_table,\n\t.free_gatt_table\t= agp_generic_free_gatt_table,\n\t.insert_memory\t\t= agp_generic_insert_memory,\n\t.remove_memory\t\t= agp_generic_remove_memory,\n\t.alloc_by_type\t\t= agp_generic_alloc_by_type,\n\t.free_by_type\t\t= agp_generic_free_by_type,\n\t.agp_alloc_page\t\t= agp_generic_alloc_page,\n\t.agp_alloc_pages        = agp_generic_alloc_pages,\n\t.agp_destroy_page\t= agp_generic_destroy_page,\n\t.agp_destroy_pages      = agp_generic_destroy_pages,\n\t.agp_type_to_mask_type  = agp_generic_type_to_mask_type,\n};\n\nstatic const struct agp_bridge_driver intel_840_driver = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.aperture_sizes\t\t= intel_8xx_sizes,\n\t.size_type\t\t= U8_APER_SIZE,\n\t.num_aperture_sizes\t= 7,\n\t.needs_scratch_page\t= true,\n\t.configure\t\t= intel_840_configure,\n\t.fetch_size\t\t= intel_8xx_fetch_size,\n\t.cleanup\t\t= intel_8xx_cleanup,\n\t.tlb_flush\t\t= intel_8xx_tlbflush,\n\t.mask_memory\t\t= agp_generic_mask_memory,\n\t.masks\t\t\t= intel_generic_masks,\n\t.agp_enable\t\t= agp_generic_enable,\n\t.cache_flush\t\t= global_cache_flush,\n\t.create_gatt_table\t= agp_generic_create_gatt_table,\n\t.free_gatt_table\t= agp_generic_free_gatt_table,\n\t.insert_memory\t\t= agp_generic_insert_memory,\n\t.remove_memory\t\t= agp_generic_remove_memory,\n\t.alloc_by_type\t\t= agp_generic_alloc_by_type,\n\t.free_by_type\t\t= agp_generic_free_by_type,\n\t.agp_alloc_page\t\t= agp_generic_alloc_page,\n\t.agp_alloc_pages        = agp_generic_alloc_pages,\n\t.agp_destroy_page\t= agp_generic_destroy_page,\n\t.agp_destroy_pages      = agp_generic_destroy_pages,\n\t.agp_type_to_mask_type  = agp_generic_type_to_mask_type,\n};\n\nstatic const struct agp_bridge_driver intel_845_driver = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.aperture_sizes\t\t= intel_8xx_sizes,\n\t.size_type\t\t= U8_APER_SIZE,\n\t.num_aperture_sizes\t= 7,\n\t.needs_scratch_page\t= true,\n\t.configure\t\t= intel_845_configure,\n\t.fetch_size\t\t= intel_8xx_fetch_size,\n\t.cleanup\t\t= intel_8xx_cleanup,\n\t.tlb_flush\t\t= intel_8xx_tlbflush,\n\t.mask_memory\t\t= agp_generic_mask_memory,\n\t.masks\t\t\t= intel_generic_masks,\n\t.agp_enable\t\t= agp_generic_enable,\n\t.cache_flush\t\t= global_cache_flush,\n\t.create_gatt_table\t= agp_generic_create_gatt_table,\n\t.free_gatt_table\t= agp_generic_free_gatt_table,\n\t.insert_memory\t\t= agp_generic_insert_memory,\n\t.remove_memory\t\t= agp_generic_remove_memory,\n\t.alloc_by_type\t\t= agp_generic_alloc_by_type,\n\t.free_by_type\t\t= agp_generic_free_by_type,\n\t.agp_alloc_page\t\t= agp_generic_alloc_page,\n\t.agp_alloc_pages        = agp_generic_alloc_pages,\n\t.agp_destroy_page\t= agp_generic_destroy_page,\n\t.agp_destroy_pages      = agp_generic_destroy_pages,\n\t.agp_type_to_mask_type  = agp_generic_type_to_mask_type,\n};\n\nstatic const struct agp_bridge_driver intel_850_driver = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.aperture_sizes\t\t= intel_8xx_sizes,\n\t.size_type\t\t= U8_APER_SIZE,\n\t.num_aperture_sizes\t= 7,\n\t.needs_scratch_page\t= true,\n\t.configure\t\t= intel_850_configure,\n\t.fetch_size\t\t= intel_8xx_fetch_size,\n\t.cleanup\t\t= intel_8xx_cleanup,\n\t.tlb_flush\t\t= intel_8xx_tlbflush,\n\t.mask_memory\t\t= agp_generic_mask_memory,\n\t.masks\t\t\t= intel_generic_masks,\n\t.agp_enable\t\t= agp_generic_enable,\n\t.cache_flush\t\t= global_cache_flush,\n\t.create_gatt_table\t= agp_generic_create_gatt_table,\n\t.free_gatt_table\t= agp_generic_free_gatt_table,\n\t.insert_memory\t\t= agp_generic_insert_memory,\n\t.remove_memory\t\t= agp_generic_remove_memory,\n\t.alloc_by_type\t\t= agp_generic_alloc_by_type,\n\t.free_by_type\t\t= agp_generic_free_by_type,\n\t.agp_alloc_page\t\t= agp_generic_alloc_page,\n\t.agp_alloc_pages        = agp_generic_alloc_pages,\n\t.agp_destroy_page\t= agp_generic_destroy_page,\n\t.agp_destroy_pages      = agp_generic_destroy_pages,\n\t.agp_type_to_mask_type  = agp_generic_type_to_mask_type,\n};\n\nstatic const struct agp_bridge_driver intel_860_driver = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.aperture_sizes\t\t= intel_8xx_sizes,\n\t.size_type\t\t= U8_APER_SIZE,\n\t.num_aperture_sizes\t= 7,\n\t.needs_scratch_page\t= true,\n\t.configure\t\t= intel_860_configure,\n\t.fetch_size\t\t= intel_8xx_fetch_size,\n\t.cleanup\t\t= intel_8xx_cleanup,\n\t.tlb_flush\t\t= intel_8xx_tlbflush,\n\t.mask_memory\t\t= agp_generic_mask_memory,\n\t.masks\t\t\t= intel_generic_masks,\n\t.agp_enable\t\t= agp_generic_enable,\n\t.cache_flush\t\t= global_cache_flush,\n\t.create_gatt_table\t= agp_generic_create_gatt_table,\n\t.free_gatt_table\t= agp_generic_free_gatt_table,\n\t.insert_memory\t\t= agp_generic_insert_memory,\n\t.remove_memory\t\t= agp_generic_remove_memory,\n\t.alloc_by_type\t\t= agp_generic_alloc_by_type,\n\t.free_by_type\t\t= agp_generic_free_by_type,\n\t.agp_alloc_page\t\t= agp_generic_alloc_page,\n\t.agp_alloc_pages        = agp_generic_alloc_pages,\n\t.agp_destroy_page\t= agp_generic_destroy_page,\n\t.agp_destroy_pages      = agp_generic_destroy_pages,\n\t.agp_type_to_mask_type  = agp_generic_type_to_mask_type,\n};\n\nstatic const struct agp_bridge_driver intel_7505_driver = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.aperture_sizes\t\t= intel_8xx_sizes,\n\t.size_type\t\t= U8_APER_SIZE,\n\t.num_aperture_sizes\t= 7,\n\t.needs_scratch_page\t= true,\n\t.configure\t\t= intel_7505_configure,\n\t.fetch_size\t\t= intel_8xx_fetch_size,\n\t.cleanup\t\t= intel_8xx_cleanup,\n\t.tlb_flush\t\t= intel_8xx_tlbflush,\n\t.mask_memory\t\t= agp_generic_mask_memory,\n\t.masks\t\t\t= intel_generic_masks,\n\t.agp_enable\t\t= agp_generic_enable,\n\t.cache_flush\t\t= global_cache_flush,\n\t.create_gatt_table\t= agp_generic_create_gatt_table,\n\t.free_gatt_table\t= agp_generic_free_gatt_table,\n\t.insert_memory\t\t= agp_generic_insert_memory,\n\t.remove_memory\t\t= agp_generic_remove_memory,\n\t.alloc_by_type\t\t= agp_generic_alloc_by_type,\n\t.free_by_type\t\t= agp_generic_free_by_type,\n\t.agp_alloc_page\t\t= agp_generic_alloc_page,\n\t.agp_alloc_pages        = agp_generic_alloc_pages,\n\t.agp_destroy_page\t= agp_generic_destroy_page,\n\t.agp_destroy_pages      = agp_generic_destroy_pages,\n\t.agp_type_to_mask_type  = agp_generic_type_to_mask_type,\n};\n\n \nstatic const struct intel_agp_driver_description {\n\tunsigned int chip_id;\n\tchar *name;\n\tconst struct agp_bridge_driver *driver;\n} intel_agp_chipsets[] = {\n\t{ PCI_DEVICE_ID_INTEL_82443LX_0, \"440LX\", &intel_generic_driver },\n\t{ PCI_DEVICE_ID_INTEL_82443BX_0, \"440BX\", &intel_generic_driver },\n\t{ PCI_DEVICE_ID_INTEL_82443GX_0, \"440GX\", &intel_generic_driver },\n\t{ PCI_DEVICE_ID_INTEL_82815_MC, \"i815\", &intel_815_driver },\n\t{ PCI_DEVICE_ID_INTEL_82820_HB, \"i820\", &intel_820_driver },\n\t{ PCI_DEVICE_ID_INTEL_82820_UP_HB, \"i820\", &intel_820_driver },\n\t{ PCI_DEVICE_ID_INTEL_82830_HB, \"830M\", &intel_830mp_driver },\n\t{ PCI_DEVICE_ID_INTEL_82840_HB, \"i840\", &intel_840_driver },\n\t{ PCI_DEVICE_ID_INTEL_82845_HB, \"i845\", &intel_845_driver },\n\t{ PCI_DEVICE_ID_INTEL_82845G_HB, \"845G\", &intel_845_driver },\n\t{ PCI_DEVICE_ID_INTEL_82850_HB, \"i850\", &intel_850_driver },\n\t{ PCI_DEVICE_ID_INTEL_82854_HB, \"854\", &intel_845_driver },\n\t{ PCI_DEVICE_ID_INTEL_82855PM_HB, \"855PM\", &intel_845_driver },\n\t{ PCI_DEVICE_ID_INTEL_82855GM_HB, \"855GM\", &intel_845_driver },\n\t{ PCI_DEVICE_ID_INTEL_82860_HB, \"i860\", &intel_860_driver },\n\t{ PCI_DEVICE_ID_INTEL_82865_HB, \"865\", &intel_845_driver },\n\t{ PCI_DEVICE_ID_INTEL_82875_HB, \"i875\", &intel_845_driver },\n\t{ PCI_DEVICE_ID_INTEL_7505_0, \"E7505\", &intel_7505_driver },\n\t{ PCI_DEVICE_ID_INTEL_7205_0, \"E7205\", &intel_7505_driver },\n\t{ 0, NULL, NULL }\n};\n\nstatic int agp_intel_probe(struct pci_dev *pdev,\n\t\t\t   const struct pci_device_id *ent)\n{\n\tstruct agp_bridge_data *bridge;\n\tu8 cap_ptr = 0;\n\tstruct resource *r;\n\tint i, err;\n\n\tcap_ptr = pci_find_capability(pdev, PCI_CAP_ID_AGP);\n\n\tbridge = agp_alloc_bridge();\n\tif (!bridge)\n\t\treturn -ENOMEM;\n\n\tbridge->capndx = cap_ptr;\n\n\tif (intel_gmch_probe(pdev, NULL, bridge))\n\t\tgoto found_gmch;\n\n\tfor (i = 0; intel_agp_chipsets[i].name != NULL; i++) {\n\t\t \n\t\tif (pdev->device == intel_agp_chipsets[i].chip_id) {\n\t\t\tbridge->driver = intel_agp_chipsets[i].driver;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (!bridge->driver) {\n\t\tif (cap_ptr)\n\t\t\tdev_warn(&pdev->dev, \"unsupported Intel chipset [%04x/%04x]\\n\",\n\t\t\t\t pdev->vendor, pdev->device);\n\t\tagp_put_bridge(bridge);\n\t\treturn -ENODEV;\n\t}\n\n\tbridge->dev = pdev;\n\tbridge->dev_private_data = NULL;\n\n\tdev_info(&pdev->dev, \"Intel %s Chipset\\n\", intel_agp_chipsets[i].name);\n\n\t \n\tr = &pdev->resource[0];\n\tif (!r->start && r->end) {\n\t\tif (pci_assign_resource(pdev, 0)) {\n\t\t\tdev_err(&pdev->dev, \"can't assign resource 0\\n\");\n\t\t\tagp_put_bridge(bridge);\n\t\t\treturn -ENODEV;\n\t\t}\n\t}\n\n\t \n\tif (pci_enable_device(pdev)) {\n\t\tdev_err(&pdev->dev, \"can't enable PCI device\\n\");\n\t\tagp_put_bridge(bridge);\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tif (cap_ptr) {\n\t\tpci_read_config_dword(pdev,\n\t\t\t\tbridge->capndx+PCI_AGP_STATUS,\n\t\t\t\t&bridge->mode);\n\t}\n\nfound_gmch:\n\tpci_set_drvdata(pdev, bridge);\n\terr = agp_add_bridge(bridge);\n\treturn err;\n}\n\nstatic void agp_intel_remove(struct pci_dev *pdev)\n{\n\tstruct agp_bridge_data *bridge = pci_get_drvdata(pdev);\n\n\tagp_remove_bridge(bridge);\n\n\tintel_gmch_remove();\n\n\tagp_put_bridge(bridge);\n}\n\nstatic int agp_intel_resume(struct device *dev)\n{\n\tstruct pci_dev *pdev = to_pci_dev(dev);\n\tstruct agp_bridge_data *bridge = pci_get_drvdata(pdev);\n\n\tbridge->driver->configure();\n\n\treturn 0;\n}\n\nstatic const struct pci_device_id agp_intel_pci_table[] = {\n#define ID(x)\t\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\\\n\t.class\t\t= (PCI_CLASS_BRIDGE_HOST << 8),\t\\\n\t.class_mask\t= ~0,\t\t\t\t\\\n\t.vendor\t\t= PCI_VENDOR_ID_INTEL,\t\t\\\n\t.device\t\t= x,\t\t\t\t\\\n\t.subvendor\t= PCI_ANY_ID,\t\t\t\\\n\t.subdevice\t= PCI_ANY_ID,\t\t\t\\\n\t}\n\tID(PCI_DEVICE_ID_INTEL_82441),  \n\tID(PCI_DEVICE_ID_INTEL_82443LX_0),\n\tID(PCI_DEVICE_ID_INTEL_82443BX_0),\n\tID(PCI_DEVICE_ID_INTEL_82443GX_0),\n\tID(PCI_DEVICE_ID_INTEL_82810_MC1),\n\tID(PCI_DEVICE_ID_INTEL_82810_MC3),\n\tID(PCI_DEVICE_ID_INTEL_82810E_MC),\n\tID(PCI_DEVICE_ID_INTEL_82815_MC),\n\tID(PCI_DEVICE_ID_INTEL_82820_HB),\n\tID(PCI_DEVICE_ID_INTEL_82820_UP_HB),\n\tID(PCI_DEVICE_ID_INTEL_82830_HB),\n\tID(PCI_DEVICE_ID_INTEL_82840_HB),\n\tID(PCI_DEVICE_ID_INTEL_82845_HB),\n\tID(PCI_DEVICE_ID_INTEL_82845G_HB),\n\tID(PCI_DEVICE_ID_INTEL_82850_HB),\n\tID(PCI_DEVICE_ID_INTEL_82854_HB),\n\tID(PCI_DEVICE_ID_INTEL_82855PM_HB),\n\tID(PCI_DEVICE_ID_INTEL_82855GM_HB),\n\tID(PCI_DEVICE_ID_INTEL_82860_HB),\n\tID(PCI_DEVICE_ID_INTEL_82865_HB),\n\tID(PCI_DEVICE_ID_INTEL_82875_HB),\n\tID(PCI_DEVICE_ID_INTEL_7505_0),\n\tID(PCI_DEVICE_ID_INTEL_7205_0),\n\tID(PCI_DEVICE_ID_INTEL_E7221_HB),\n\tID(PCI_DEVICE_ID_INTEL_82915G_HB),\n\tID(PCI_DEVICE_ID_INTEL_82915GM_HB),\n\tID(PCI_DEVICE_ID_INTEL_82945G_HB),\n\tID(PCI_DEVICE_ID_INTEL_82945GM_HB),\n\tID(PCI_DEVICE_ID_INTEL_82945GME_HB),\n\tID(PCI_DEVICE_ID_INTEL_PINEVIEW_M_HB),\n\tID(PCI_DEVICE_ID_INTEL_PINEVIEW_HB),\n\tID(PCI_DEVICE_ID_INTEL_82946GZ_HB),\n\tID(PCI_DEVICE_ID_INTEL_82G35_HB),\n\tID(PCI_DEVICE_ID_INTEL_82965Q_HB),\n\tID(PCI_DEVICE_ID_INTEL_82965G_HB),\n\tID(PCI_DEVICE_ID_INTEL_82965GM_HB),\n\tID(PCI_DEVICE_ID_INTEL_82965GME_HB),\n\tID(PCI_DEVICE_ID_INTEL_G33_HB),\n\tID(PCI_DEVICE_ID_INTEL_Q35_HB),\n\tID(PCI_DEVICE_ID_INTEL_Q33_HB),\n\tID(PCI_DEVICE_ID_INTEL_GM45_HB),\n\tID(PCI_DEVICE_ID_INTEL_EAGLELAKE_HB),\n\tID(PCI_DEVICE_ID_INTEL_Q45_HB),\n\tID(PCI_DEVICE_ID_INTEL_G45_HB),\n\tID(PCI_DEVICE_ID_INTEL_G41_HB),\n\tID(PCI_DEVICE_ID_INTEL_B43_HB),\n\tID(PCI_DEVICE_ID_INTEL_B43_1_HB),\n\tID(PCI_DEVICE_ID_INTEL_IRONLAKE_D_HB),\n\tID(PCI_DEVICE_ID_INTEL_IRONLAKE_D2_HB),\n\tID(PCI_DEVICE_ID_INTEL_IRONLAKE_M_HB),\n\tID(PCI_DEVICE_ID_INTEL_IRONLAKE_MA_HB),\n\tID(PCI_DEVICE_ID_INTEL_IRONLAKE_MC2_HB),\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(pci, agp_intel_pci_table);\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(agp_intel_pm_ops, NULL, agp_intel_resume);\n\nstatic struct pci_driver agp_intel_pci_driver = {\n\t.name\t\t= \"agpgart-intel\",\n\t.id_table\t= agp_intel_pci_table,\n\t.probe\t\t= agp_intel_probe,\n\t.remove\t\t= agp_intel_remove,\n\t.driver.pm\t= &agp_intel_pm_ops,\n};\n\nstatic int __init agp_intel_init(void)\n{\n\tif (agp_off)\n\t\treturn -EINVAL;\n\treturn pci_register_driver(&agp_intel_pci_driver);\n}\n\nstatic void __exit agp_intel_cleanup(void)\n{\n\tpci_unregister_driver(&agp_intel_pci_driver);\n}\n\nmodule_init(agp_intel_init);\nmodule_exit(agp_intel_cleanup);\n\nMODULE_AUTHOR(\"Dave Jones, Various @Intel\");\nMODULE_LICENSE(\"GPL and additional rights\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}