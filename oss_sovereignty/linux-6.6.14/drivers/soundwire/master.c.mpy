{
  "module_name": "master.c",
  "hash_id": "9dbde9766d491c1791de478afe479be6d5140ef964a54fa621372d0c262cb014",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soundwire/master.c",
  "human_readable_source": "\n\n\n#include <linux/device.h>\n#include <linux/acpi.h>\n#include <linux/pm_runtime.h>\n#include <linux/soundwire/sdw.h>\n#include <linux/soundwire/sdw_type.h>\n#include \"bus.h\"\n\n \n#define SDW_MASTER_SUSPEND_DELAY_MS 3000\n\n \n\n#define sdw_master_attr(field, format_string)\t\t\t\t\\\nstatic ssize_t field##_show(struct device *dev,\t\t\t\t\\\n\t\t\t    struct device_attribute *attr,\t\t\\\n\t\t\t    char *buf)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tstruct sdw_master_device *md = dev_to_sdw_master_device(dev);\t\\\n\treturn sprintf(buf, format_string, md->bus->prop.field);\t\\\n}\t\t\t\t\t\t\t\t\t\\\nstatic DEVICE_ATTR_RO(field)\n\nsdw_master_attr(revision, \"0x%x\\n\");\nsdw_master_attr(clk_stop_modes, \"0x%x\\n\");\nsdw_master_attr(max_clk_freq, \"%d\\n\");\nsdw_master_attr(default_row, \"%d\\n\");\nsdw_master_attr(default_col, \"%d\\n\");\nsdw_master_attr(default_frame_rate, \"%d\\n\");\nsdw_master_attr(dynamic_frame, \"%d\\n\");\nsdw_master_attr(err_threshold, \"%d\\n\");\n\nstatic ssize_t clock_frequencies_show(struct device *dev,\n\t\t\t\t      struct device_attribute *attr, char *buf)\n{\n\tstruct sdw_master_device *md = dev_to_sdw_master_device(dev);\n\tssize_t size = 0;\n\tint i;\n\n\tfor (i = 0; i < md->bus->prop.num_clk_freq; i++)\n\t\tsize += sprintf(buf + size, \"%8d \",\n\t\t\t\tmd->bus->prop.clk_freq[i]);\n\tsize += sprintf(buf + size, \"\\n\");\n\n\treturn size;\n}\nstatic DEVICE_ATTR_RO(clock_frequencies);\n\nstatic ssize_t clock_gears_show(struct device *dev,\n\t\t\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct sdw_master_device *md = dev_to_sdw_master_device(dev);\n\tssize_t size = 0;\n\tint i;\n\n\tfor (i = 0; i < md->bus->prop.num_clk_gears; i++)\n\t\tsize += sprintf(buf + size, \"%8d \",\n\t\t\t\tmd->bus->prop.clk_gears[i]);\n\tsize += sprintf(buf + size, \"\\n\");\n\n\treturn size;\n}\nstatic DEVICE_ATTR_RO(clock_gears);\n\nstatic struct attribute *master_node_attrs[] = {\n\t&dev_attr_revision.attr,\n\t&dev_attr_clk_stop_modes.attr,\n\t&dev_attr_max_clk_freq.attr,\n\t&dev_attr_default_row.attr,\n\t&dev_attr_default_col.attr,\n\t&dev_attr_default_frame_rate.attr,\n\t&dev_attr_dynamic_frame.attr,\n\t&dev_attr_err_threshold.attr,\n\t&dev_attr_clock_frequencies.attr,\n\t&dev_attr_clock_gears.attr,\n\tNULL,\n};\nATTRIBUTE_GROUPS(master_node);\n\nstatic void sdw_master_device_release(struct device *dev)\n{\n\tstruct sdw_master_device *md = dev_to_sdw_master_device(dev);\n\n\tkfree(md);\n}\n\nstatic const struct dev_pm_ops master_dev_pm = {\n\tSET_RUNTIME_PM_OPS(pm_generic_runtime_suspend,\n\t\t\t   pm_generic_runtime_resume, NULL)\n};\n\nstruct device_type sdw_master_type = {\n\t.name =\t\t\"soundwire_master\",\n\t.release =\tsdw_master_device_release,\n\t.pm = &master_dev_pm,\n};\n\n \nint sdw_master_device_add(struct sdw_bus *bus, struct device *parent,\n\t\t\t  struct fwnode_handle *fwnode)\n{\n\tstruct sdw_master_device *md;\n\tint ret;\n\n\tif (!parent)\n\t\treturn -EINVAL;\n\n\tmd = kzalloc(sizeof(*md), GFP_KERNEL);\n\tif (!md)\n\t\treturn -ENOMEM;\n\n\tmd->dev.bus = &sdw_bus_type;\n\tmd->dev.type = &sdw_master_type;\n\tmd->dev.parent = parent;\n\tmd->dev.groups = master_node_groups;\n\tmd->dev.of_node = parent->of_node;\n\tmd->dev.fwnode = fwnode;\n\tmd->dev.dma_mask = parent->dma_mask;\n\n\tdev_set_name(&md->dev, \"sdw-master-%d\", bus->id);\n\n\tret = device_register(&md->dev);\n\tif (ret) {\n\t\tdev_err(parent, \"Failed to add master: ret %d\\n\", ret);\n\t\t \n\t\tput_device(&md->dev);\n\t\tgoto device_register_err;\n\t}\n\n\t \n\tmd->bus = bus;\n\tbus->dev = &md->dev;\n\tbus->md = md;\n\n\tpm_runtime_set_autosuspend_delay(&bus->md->dev, SDW_MASTER_SUSPEND_DELAY_MS);\n\tpm_runtime_use_autosuspend(&bus->md->dev);\n\tpm_runtime_mark_last_busy(&bus->md->dev);\n\tpm_runtime_set_active(&bus->md->dev);\n\tpm_runtime_enable(&bus->md->dev);\n\tpm_runtime_idle(&bus->md->dev);\ndevice_register_err:\n\treturn ret;\n}\n\n \nint sdw_master_device_del(struct sdw_bus *bus)\n{\n\tpm_runtime_disable(&bus->md->dev);\n\tdevice_unregister(bus->dev);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}