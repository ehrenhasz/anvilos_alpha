{
  "module_name": "sysfs_slave_dpn.c",
  "hash_id": "813f470625ad240cf4deaf34d9a38cc8356182e1094c45d7f198bd44f4932652",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soundwire/sysfs_slave_dpn.c",
  "human_readable_source": "\n\n\n#include <linux/device.h>\n#include <linux/mod_devicetable.h>\n#include <linux/slab.h>\n#include <linux/sysfs.h>\n#include <linux/soundwire/sdw.h>\n#include <linux/soundwire/sdw_type.h>\n#include \"bus.h\"\n#include \"sysfs_local.h\"\n\nstruct dpn_attribute {\n\tstruct device_attribute\tdev_attr;\n\tint N;\n\tint dir;\n\tconst char *format_string;\n};\n\n \n#define SDW_DPN_ATTRIBUTES 15\n\n#define sdw_dpn_attribute_alloc(field)\t\t\t\t\t\\\nstatic int field##_attribute_alloc(struct device *dev,\t\t\t\\\n\t\t\t\tstruct attribute **res,\t\t\t\\\n\t\t\t\tint N, int dir,\t\t\t\t\\\n\t\t\t\tconst char *format_string)\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tstruct dpn_attribute *dpn_attr;\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tdpn_attr = devm_kzalloc(dev, sizeof(*dpn_attr), GFP_KERNEL);\t\\\n\tif (!dpn_attr)\t\t\t\t\t\t\t\\\n\t\treturn -ENOMEM;\t\t\t\t\t\t\\\n\tdpn_attr->N = N;\t\t\t\t\t\t\\\n\tdpn_attr->dir = dir;\t\t\t\t\t\t\\\n\tsysfs_attr_init(&dpn_attr->dev_attr.attr);\t\t\t\\\n\tdpn_attr->format_string = format_string;\t\t\t\\\n\tdpn_attr->dev_attr.attr.name = __stringify(field);\t\t\\\n\tdpn_attr->dev_attr.attr.mode = 0444;\t\t\t\t\\\n\tdpn_attr->dev_attr.show = field##_show;\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t*res = &dpn_attr->dev_attr.attr;\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\treturn 0;\t\t\t\t\t\t\t\\\n}\n\n#define sdw_dpn_attr(field)\t\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\nstatic ssize_t field##_dpn_show(struct sdw_slave *slave,\t\t\\\n\t\t\t\tint N,\t\t\t\t\t\\\n\t\t\t\tint dir,\t\t\t\t\\\n\t\t\t\tconst char *format_string,\t\t\\\n\t\t\t\tchar *buf)\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tstruct sdw_dpn_prop *dpn;\t\t\t\t\t\\\n\tunsigned long mask;\t\t\t\t\t\t\\\n\tint bit;\t\t\t\t\t\t\t\\\n\tint i;\t\t\t\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tif (dir) {\t\t\t\t\t\t\t\\\n\t\tdpn = slave->prop.src_dpn_prop;\t\t\t\t\\\n\t\tmask = slave->prop.source_ports;\t\t\t\\\n\t} else {\t\t\t\t\t\t\t\\\n\t\tdpn = slave->prop.sink_dpn_prop;\t\t\t\\\n\t\tmask = slave->prop.sink_ports;\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\ti = 0;\t\t\t\t\t\t\t\t\\\n\tfor_each_set_bit(bit, &mask, 32) {\t\t\t\t\\\n\t\tif (bit == N) {\t\t\t\t\t\t\\\n\t\t\treturn sprintf(buf, format_string,\t\t\\\n\t\t\t\t       dpn[i].field);\t\t\t\\\n\t\t}\t\t\t\t\t\t\t\\\n\t\ti++;\t\t\t\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n\treturn -EINVAL;\t\t\t\t\t\t\t\\\n}\t\t\t\t\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\nstatic ssize_t field##_show(struct device *dev,\t\t\t\t\\\n\t\t\t    struct device_attribute *attr,\t\t\\\n\t\t\t    char *buf)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tstruct sdw_slave *slave = dev_to_sdw_dev(dev);\t\t\t\\\n\tstruct dpn_attribute *dpn_attr =\t\t\t\t\\\n\t\tcontainer_of(attr, struct dpn_attribute, dev_attr);\t\\\n\t\t\t\t\t\t\t\t\t\\\n\treturn field##_dpn_show(slave,\t\t\t\t\t\\\n\t\t\t\tdpn_attr->N, dpn_attr->dir,\t\t\\\n\t\t\t\tdpn_attr->format_string,\t\t\\\n\t\t\t\tbuf);\t\t\t\t\t\\\n}\t\t\t\t\t\t\t\t\t\\\nsdw_dpn_attribute_alloc(field)\n\nsdw_dpn_attr(imp_def_interrupts);\nsdw_dpn_attr(max_word);\nsdw_dpn_attr(min_word);\nsdw_dpn_attr(type);\nsdw_dpn_attr(max_grouping);\nsdw_dpn_attr(simple_ch_prep_sm);\nsdw_dpn_attr(ch_prep_timeout);\nsdw_dpn_attr(max_ch);\nsdw_dpn_attr(min_ch);\nsdw_dpn_attr(max_async_buffer);\nsdw_dpn_attr(block_pack_mode);\nsdw_dpn_attr(port_encoding);\n\n#define sdw_dpn_array_attr(field)\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\nstatic ssize_t field##_dpn_show(struct sdw_slave *slave,\t\t\\\n\t\t\t\tint N,\t\t\t\t\t\\\n\t\t\t\tint dir,\t\t\t\t\\\n\t\t\t\tconst char *format_string,\t\t\\\n\t\t\t\tchar *buf)\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tstruct sdw_dpn_prop *dpn;\t\t\t\t\t\\\n\tunsigned long mask;\t\t\t\t\t\t\\\n\tssize_t size = 0;\t\t\t\t\t\t\\\n\tint bit;\t\t\t\t\t\t\t\\\n\tint i;\t\t\t\t\t\t\t\t\\\n\tint j;\t\t\t\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\tif (dir) {\t\t\t\t\t\t\t\\\n\t\tdpn = slave->prop.src_dpn_prop;\t\t\t\t\\\n\t\tmask = slave->prop.source_ports;\t\t\t\\\n\t} else {\t\t\t\t\t\t\t\\\n\t\tdpn = slave->prop.sink_dpn_prop;\t\t\t\\\n\t\tmask = slave->prop.sink_ports;\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\ti = 0;\t\t\t\t\t\t\t\t\\\n\tfor_each_set_bit(bit, &mask, 32) {\t\t\t\t\\\n\t\tif (bit == N) {\t\t\t\t\t\t\\\n\t\t\tfor (j = 0; j < dpn[i].num_##field; j++)\t\\\n\t\t\t\tsize += sprintf(buf + size,\t\t\\\n\t\t\t\t\t\tformat_string,\t\t\\\n\t\t\t\t\t\tdpn[i].field[j]);\t\\\n\t\t\tsize += sprintf(buf + size, \"\\n\");\t\t\\\n\t\t\treturn size;\t\t\t\t\t\\\n\t\t}\t\t\t\t\t\t\t\\\n\t\ti++;\t\t\t\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n\treturn -EINVAL;\t\t\t\t\t\t\t\\\n}\t\t\t\t\t\t\t\t\t\\\nstatic ssize_t field##_show(struct device *dev,\t\t\t\t\\\n\t\t\t    struct device_attribute *attr,\t\t\\\n\t\t\t    char *buf)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tstruct sdw_slave *slave = dev_to_sdw_dev(dev);\t\t\t\\\n\tstruct dpn_attribute *dpn_attr =\t\t\t\t\\\n\t\tcontainer_of(attr, struct dpn_attribute, dev_attr);\t\\\n\t\t\t\t\t\t\t\t\t\\\n\treturn field##_dpn_show(slave,\t\t\t\t\t\\\n\t\t\t\tdpn_attr->N, dpn_attr->dir,\t\t\\\n\t\t\t\tdpn_attr->format_string,\t\t\\\n\t\t\t\tbuf);\t\t\t\t\t\\\n}\t\t\t\t\t\t\t\t\t\\\nsdw_dpn_attribute_alloc(field)\n\nsdw_dpn_array_attr(words);\nsdw_dpn_array_attr(ch_combinations);\nsdw_dpn_array_attr(channels);\n\nstatic int add_all_attributes(struct device *dev, int N, int dir)\n{\n\tstruct attribute **dpn_attrs;\n\tstruct attribute_group *dpn_group;\n\tint i = 0;\n\tint ret;\n\n\t \n\tdpn_attrs = devm_kcalloc(dev, SDW_DPN_ATTRIBUTES + 1,\n\t\t\t\t sizeof(struct attribute *),\n\t\t\t\t GFP_KERNEL);\n\tif (!dpn_attrs)\n\t\treturn -ENOMEM;\n\n\tret = max_word_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t       N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = min_word_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t       N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = words_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t    N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = type_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t   N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = max_grouping_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t\t   N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = simple_ch_prep_sm_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t\t\tN, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = ch_prep_timeout_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t\t      N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = imp_def_interrupts_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t\t\t N, dir, \"0x%x\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = min_ch_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t     N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = max_ch_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t     N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = channels_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t       N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = ch_combinations_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t\t      N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = max_async_buffer_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t\t       N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = block_pack_mode_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t\t      N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = port_encoding_attribute_alloc(dev, &dpn_attrs[i++],\n\t\t\t\t\t    N, dir, \"%d\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tif (i != SDW_DPN_ATTRIBUTES) {\n\t\tdev_err(dev, \"mismatch in attributes, allocated %d got %d\\n\",\n\t\t\tSDW_DPN_ATTRIBUTES, i);\n\t\treturn -EINVAL;\n\t}\n\n\tdpn_group = devm_kzalloc(dev, sizeof(*dpn_group), GFP_KERNEL);\n\tif (!dpn_group)\n\t\treturn -ENOMEM;\n\n\tdpn_group->attrs = dpn_attrs;\n\tdpn_group->name = devm_kasprintf(dev, GFP_KERNEL, \"dp%d_%s\",\n\t\t\t\t\t N, dir ? \"src\" : \"sink\");\n\tif (!dpn_group->name)\n\t\treturn -ENOMEM;\n\n\tret = devm_device_add_group(dev, dpn_group);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nint sdw_slave_sysfs_dpn_init(struct sdw_slave *slave)\n{\n\tunsigned long mask;\n\tint ret;\n\tint i;\n\n\tmask = slave->prop.source_ports;\n\tfor_each_set_bit(i, &mask, 32) {\n\t\tret = add_all_attributes(&slave->dev, i, 1);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tmask = slave->prop.sink_ports;\n\tfor_each_set_bit(i, &mask, 32) {\n\t\tret = add_all_attributes(&slave->dev, i, 0);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}