{
  "module_name": "mipi_disco.c",
  "hash_id": "455beda8ce9c3108270b83364b22eb6868b748302b2fb7548c71375a336657b2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/soundwire/mipi_disco.c",
  "human_readable_source": "\n\n\n \n\n#include <linux/device.h>\n#include <linux/property.h>\n#include <linux/mod_devicetable.h>\n#include <linux/soundwire/sdw.h>\n#include \"bus.h\"\n\n \nint sdw_master_read_prop(struct sdw_bus *bus)\n{\n\tstruct sdw_master_prop *prop = &bus->prop;\n\tstruct fwnode_handle *link;\n\tchar name[32];\n\tint nval, i;\n\n\tdevice_property_read_u32(bus->dev,\n\t\t\t\t \"mipi-sdw-sw-interface-revision\",\n\t\t\t\t &prop->revision);\n\n\t \n\tsnprintf(name, sizeof(name),\n\t\t \"mipi-sdw-link-%d-subproperties\", bus->link_id);\n\n\tlink = device_get_named_child_node(bus->dev, name);\n\tif (!link) {\n\t\tdev_err(bus->dev, \"Master node %s not found\\n\", name);\n\t\treturn -EIO;\n\t}\n\n\tif (fwnode_property_read_bool(link,\n\t\t\t\t      \"mipi-sdw-clock-stop-mode0-supported\"))\n\t\tprop->clk_stop_modes |= BIT(SDW_CLK_STOP_MODE0);\n\n\tif (fwnode_property_read_bool(link,\n\t\t\t\t      \"mipi-sdw-clock-stop-mode1-supported\"))\n\t\tprop->clk_stop_modes |= BIT(SDW_CLK_STOP_MODE1);\n\n\tfwnode_property_read_u32(link,\n\t\t\t\t \"mipi-sdw-max-clock-frequency\",\n\t\t\t\t &prop->max_clk_freq);\n\n\tnval = fwnode_property_count_u32(link, \"mipi-sdw-clock-frequencies-supported\");\n\tif (nval > 0) {\n\t\tprop->num_clk_freq = nval;\n\t\tprop->clk_freq = devm_kcalloc(bus->dev, prop->num_clk_freq,\n\t\t\t\t\t      sizeof(*prop->clk_freq),\n\t\t\t\t\t      GFP_KERNEL);\n\t\tif (!prop->clk_freq)\n\t\t\treturn -ENOMEM;\n\n\t\tfwnode_property_read_u32_array(link,\n\t\t\t\t\"mipi-sdw-clock-frequencies-supported\",\n\t\t\t\tprop->clk_freq, prop->num_clk_freq);\n\t}\n\n\t \n\tif (!prop->max_clk_freq && prop->clk_freq) {\n\t\tprop->max_clk_freq = prop->clk_freq[0];\n\t\tfor (i = 1; i < prop->num_clk_freq; i++) {\n\t\t\tif (prop->clk_freq[i] > prop->max_clk_freq)\n\t\t\t\tprop->max_clk_freq = prop->clk_freq[i];\n\t\t}\n\t}\n\n\tnval = fwnode_property_count_u32(link, \"mipi-sdw-supported-clock-gears\");\n\tif (nval > 0) {\n\t\tprop->num_clk_gears = nval;\n\t\tprop->clk_gears = devm_kcalloc(bus->dev, prop->num_clk_gears,\n\t\t\t\t\t       sizeof(*prop->clk_gears),\n\t\t\t\t\t       GFP_KERNEL);\n\t\tif (!prop->clk_gears)\n\t\t\treturn -ENOMEM;\n\n\t\tfwnode_property_read_u32_array(link,\n\t\t\t\t\t       \"mipi-sdw-supported-clock-gears\",\n\t\t\t\t\t       prop->clk_gears,\n\t\t\t\t\t       prop->num_clk_gears);\n\t}\n\n\tfwnode_property_read_u32(link, \"mipi-sdw-default-frame-rate\",\n\t\t\t\t &prop->default_frame_rate);\n\n\tfwnode_property_read_u32(link, \"mipi-sdw-default-frame-row-size\",\n\t\t\t\t &prop->default_row);\n\n\tfwnode_property_read_u32(link, \"mipi-sdw-default-frame-col-size\",\n\t\t\t\t &prop->default_col);\n\n\tprop->dynamic_frame =  fwnode_property_read_bool(link,\n\t\t\t\"mipi-sdw-dynamic-frame-shape\");\n\n\tfwnode_property_read_u32(link, \"mipi-sdw-command-error-threshold\",\n\t\t\t\t &prop->err_threshold);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(sdw_master_read_prop);\n\nstatic int sdw_slave_read_dp0(struct sdw_slave *slave,\n\t\t\t      struct fwnode_handle *port,\n\t\t\t      struct sdw_dp0_prop *dp0)\n{\n\tint nval;\n\n\tfwnode_property_read_u32(port, \"mipi-sdw-port-max-wordlength\",\n\t\t\t\t &dp0->max_word);\n\n\tfwnode_property_read_u32(port, \"mipi-sdw-port-min-wordlength\",\n\t\t\t\t &dp0->min_word);\n\n\tnval = fwnode_property_count_u32(port, \"mipi-sdw-port-wordlength-configs\");\n\tif (nval > 0) {\n\n\t\tdp0->num_words = nval;\n\t\tdp0->words = devm_kcalloc(&slave->dev,\n\t\t\t\t\t  dp0->num_words, sizeof(*dp0->words),\n\t\t\t\t\t  GFP_KERNEL);\n\t\tif (!dp0->words)\n\t\t\treturn -ENOMEM;\n\n\t\tfwnode_property_read_u32_array(port,\n\t\t\t\t\"mipi-sdw-port-wordlength-configs\",\n\t\t\t\tdp0->words, dp0->num_words);\n\t}\n\n\tdp0->BRA_flow_controlled = fwnode_property_read_bool(port,\n\t\t\t\t\"mipi-sdw-bra-flow-controlled\");\n\n\tdp0->simple_ch_prep_sm = fwnode_property_read_bool(port,\n\t\t\t\t\"mipi-sdw-simplified-channel-prepare-sm\");\n\n\tdp0->imp_def_interrupts = fwnode_property_read_bool(port,\n\t\t\t\t\"mipi-sdw-imp-def-dp0-interrupts-supported\");\n\n\treturn 0;\n}\n\nstatic int sdw_slave_read_dpn(struct sdw_slave *slave,\n\t\t\t      struct sdw_dpn_prop *dpn, int count, int ports,\n\t\t\t      char *type)\n{\n\tstruct fwnode_handle *node;\n\tu32 bit, i = 0;\n\tint nval;\n\tunsigned long addr;\n\tchar name[40];\n\n\taddr = ports;\n\t \n\taddr &= GENMASK(14, 1);\n\n\tfor_each_set_bit(bit, &addr, 32) {\n\t\tsnprintf(name, sizeof(name),\n\t\t\t \"mipi-sdw-dp-%d-%s-subproperties\", bit, type);\n\n\t\tdpn[i].num = bit;\n\n\t\tnode = device_get_named_child_node(&slave->dev, name);\n\t\tif (!node) {\n\t\t\tdev_err(&slave->dev, \"%s dpN not found\\n\", name);\n\t\t\treturn -EIO;\n\t\t}\n\n\t\tfwnode_property_read_u32(node, \"mipi-sdw-port-max-wordlength\",\n\t\t\t\t\t &dpn[i].max_word);\n\t\tfwnode_property_read_u32(node, \"mipi-sdw-port-min-wordlength\",\n\t\t\t\t\t &dpn[i].min_word);\n\n\t\tnval = fwnode_property_count_u32(node, \"mipi-sdw-port-wordlength-configs\");\n\t\tif (nval > 0) {\n\t\t\tdpn[i].num_words = nval;\n\t\t\tdpn[i].words = devm_kcalloc(&slave->dev,\n\t\t\t\t\t\t    dpn[i].num_words,\n\t\t\t\t\t\t    sizeof(*dpn[i].words),\n\t\t\t\t\t\t    GFP_KERNEL);\n\t\t\tif (!dpn[i].words)\n\t\t\t\treturn -ENOMEM;\n\n\t\t\tfwnode_property_read_u32_array(node,\n\t\t\t\t\t\"mipi-sdw-port-wordlength-configs\",\n\t\t\t\t\tdpn[i].words, dpn[i].num_words);\n\t\t}\n\n\t\tfwnode_property_read_u32(node, \"mipi-sdw-data-port-type\",\n\t\t\t\t\t &dpn[i].type);\n\n\t\tfwnode_property_read_u32(node,\n\t\t\t\t\t \"mipi-sdw-max-grouping-supported\",\n\t\t\t\t\t &dpn[i].max_grouping);\n\n\t\tdpn[i].simple_ch_prep_sm = fwnode_property_read_bool(node,\n\t\t\t\t\"mipi-sdw-simplified-channelprepare-sm\");\n\n\t\tfwnode_property_read_u32(node,\n\t\t\t\t\t \"mipi-sdw-port-channelprepare-timeout\",\n\t\t\t\t\t &dpn[i].ch_prep_timeout);\n\n\t\tfwnode_property_read_u32(node,\n\t\t\t\t\"mipi-sdw-imp-def-dpn-interrupts-supported\",\n\t\t\t\t&dpn[i].imp_def_interrupts);\n\n\t\tfwnode_property_read_u32(node, \"mipi-sdw-min-channel-number\",\n\t\t\t\t\t &dpn[i].min_ch);\n\n\t\tfwnode_property_read_u32(node, \"mipi-sdw-max-channel-number\",\n\t\t\t\t\t &dpn[i].max_ch);\n\n\t\tnval = fwnode_property_count_u32(node, \"mipi-sdw-channel-number-list\");\n\t\tif (nval > 0) {\n\t\t\tdpn[i].num_channels = nval;\n\t\t\tdpn[i].channels = devm_kcalloc(&slave->dev,\n\t\t\t\t\t\t       dpn[i].num_channels,\n\t\t\t\t\t\t       sizeof(*dpn[i].channels),\n\t\t\t\t\t\t GFP_KERNEL);\n\t\t\tif (!dpn[i].channels)\n\t\t\t\treturn -ENOMEM;\n\n\t\t\tfwnode_property_read_u32_array(node,\n\t\t\t\t\t\"mipi-sdw-channel-number-list\",\n\t\t\t\t\tdpn[i].channels, dpn[i].num_channels);\n\t\t}\n\n\t\tnval = fwnode_property_count_u32(node, \"mipi-sdw-channel-combination-list\");\n\t\tif (nval > 0) {\n\t\t\tdpn[i].num_ch_combinations = nval;\n\t\t\tdpn[i].ch_combinations = devm_kcalloc(&slave->dev,\n\t\t\t\t\tdpn[i].num_ch_combinations,\n\t\t\t\t\tsizeof(*dpn[i].ch_combinations),\n\t\t\t\t\tGFP_KERNEL);\n\t\t\tif (!dpn[i].ch_combinations)\n\t\t\t\treturn -ENOMEM;\n\n\t\t\tfwnode_property_read_u32_array(node,\n\t\t\t\t\t\"mipi-sdw-channel-combination-list\",\n\t\t\t\t\tdpn[i].ch_combinations,\n\t\t\t\t\tdpn[i].num_ch_combinations);\n\t\t}\n\n\t\tfwnode_property_read_u32(node,\n\t\t\t\t\"mipi-sdw-modes-supported\", &dpn[i].modes);\n\n\t\tfwnode_property_read_u32(node, \"mipi-sdw-max-async-buffer\",\n\t\t\t\t\t &dpn[i].max_async_buffer);\n\n\t\tdpn[i].block_pack_mode = fwnode_property_read_bool(node,\n\t\t\t\t\"mipi-sdw-block-packing-mode\");\n\n\t\tfwnode_property_read_u32(node, \"mipi-sdw-port-encoding-type\",\n\t\t\t\t\t &dpn[i].port_encoding);\n\n\t\t \n\n\t\ti++;\n\t}\n\n\treturn 0;\n}\n\n \nint sdw_slave_read_prop(struct sdw_slave *slave)\n{\n\tstruct sdw_slave_prop *prop = &slave->prop;\n\tstruct device *dev = &slave->dev;\n\tstruct fwnode_handle *port;\n\tint nval;\n\n\tdevice_property_read_u32(dev, \"mipi-sdw-sw-interface-revision\",\n\t\t\t\t &prop->mipi_revision);\n\n\tprop->wake_capable = device_property_read_bool(dev,\n\t\t\t\t\"mipi-sdw-wake-up-unavailable\");\n\tprop->wake_capable = !prop->wake_capable;\n\n\tprop->test_mode_capable = device_property_read_bool(dev,\n\t\t\t\t\"mipi-sdw-test-mode-supported\");\n\n\tprop->clk_stop_mode1 = false;\n\tif (device_property_read_bool(dev,\n\t\t\t\t\"mipi-sdw-clock-stop-mode1-supported\"))\n\t\tprop->clk_stop_mode1 = true;\n\n\tprop->simple_clk_stop_capable = device_property_read_bool(dev,\n\t\t\t\"mipi-sdw-simplified-clockstopprepare-sm-supported\");\n\n\tdevice_property_read_u32(dev, \"mipi-sdw-clockstopprepare-timeout\",\n\t\t\t\t &prop->clk_stop_timeout);\n\n\tdevice_property_read_u32(dev, \"mipi-sdw-slave-channelprepare-timeout\",\n\t\t\t\t &prop->ch_prep_timeout);\n\n\tdevice_property_read_u32(dev,\n\t\t\t\"mipi-sdw-clockstopprepare-hard-reset-behavior\",\n\t\t\t&prop->reset_behave);\n\n\tprop->high_PHY_capable = device_property_read_bool(dev,\n\t\t\t\"mipi-sdw-highPHY-capable\");\n\n\tprop->paging_support = device_property_read_bool(dev,\n\t\t\t\"mipi-sdw-paging-support\");\n\n\tprop->bank_delay_support = device_property_read_bool(dev,\n\t\t\t\"mipi-sdw-bank-delay-support\");\n\n\tdevice_property_read_u32(dev,\n\t\t\t\"mipi-sdw-port15-read-behavior\", &prop->p15_behave);\n\n\tdevice_property_read_u32(dev, \"mipi-sdw-master-count\",\n\t\t\t\t &prop->master_count);\n\n\tdevice_property_read_u32(dev, \"mipi-sdw-source-port-list\",\n\t\t\t\t &prop->source_ports);\n\n\tdevice_property_read_u32(dev, \"mipi-sdw-sink-port-list\",\n\t\t\t\t &prop->sink_ports);\n\n\t \n\tport = device_get_named_child_node(dev, \"mipi-sdw-dp-0-subproperties\");\n\tif (!port) {\n\t\tdev_dbg(dev, \"DP0 node not found!!\\n\");\n\t} else {\n\t\tprop->dp0_prop = devm_kzalloc(&slave->dev,\n\t\t\t\t\t      sizeof(*prop->dp0_prop),\n\t\t\t\t\t      GFP_KERNEL);\n\t\tif (!prop->dp0_prop)\n\t\t\treturn -ENOMEM;\n\n\t\tsdw_slave_read_dp0(slave, port, prop->dp0_prop);\n\t}\n\n\t \n\n\t \n\tnval = hweight32(prop->source_ports);\n\tprop->src_dpn_prop = devm_kcalloc(&slave->dev, nval,\n\t\t\t\t\t  sizeof(*prop->src_dpn_prop),\n\t\t\t\t\t  GFP_KERNEL);\n\tif (!prop->src_dpn_prop)\n\t\treturn -ENOMEM;\n\n\t \n\tsdw_slave_read_dpn(slave, prop->src_dpn_prop, nval,\n\t\t\t   prop->source_ports, \"source\");\n\n\tnval = hweight32(prop->sink_ports);\n\tprop->sink_dpn_prop = devm_kcalloc(&slave->dev, nval,\n\t\t\t\t\t   sizeof(*prop->sink_dpn_prop),\n\t\t\t\t\t   GFP_KERNEL);\n\tif (!prop->sink_dpn_prop)\n\t\treturn -ENOMEM;\n\n\t \n\tsdw_slave_read_dpn(slave, prop->sink_dpn_prop, nval,\n\t\t\t   prop->sink_ports, \"sink\");\n\n\treturn 0;\n}\nEXPORT_SYMBOL(sdw_slave_read_prop);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}