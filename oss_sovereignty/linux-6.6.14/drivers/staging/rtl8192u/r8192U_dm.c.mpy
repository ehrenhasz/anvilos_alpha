{
  "module_name": "r8192U_dm.c",
  "hash_id": "1659f9fc212d911bfa4f5a4f125022e90ea9309e92a69ca89dcb3cf0bc4da78c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8192u/r8192U_dm.c",
  "human_readable_source": "\n \n#include \"r8192U.h\"\n#include \"r8192U_dm.h\"\n#include \"r8192U_hw.h\"\n#include \"r819xU_phy.h\"\n#include \"r819xU_phyreg.h\"\n#include \"r8190_rtl8256.h\"\n#include \"r819xU_cmdpkt.h\"\n \n \nstatic u32 edca_setting_DL[HT_IOT_PEER_MAX] = {\n\t0x5e4322, 0x5e4322, 0x5e4322, 0x604322, 0x00a44f, 0x5ea44f\n};\n\nstatic u32 edca_setting_UL[HT_IOT_PEER_MAX] = {\n\t0x5e4322, 0x00a44f, 0x5e4322, 0x604322, 0x5ea44f, 0x5ea44f\n};\n\n#define RTK_UL_EDCA 0xa44f\n#define RTK_DL_EDCA 0x5e4322\n \n\n\n \n \nstruct dig dm_digtable;\n \nu8\t\tdm_shadow[16][256] = { {0} };\n \nstatic struct dynamic_rx_path_sel DM_RxPathSelTable;\n\nextern\tvoid dm_check_fsync(struct net_device *dev);\n\n \nstatic\tvoid\tdm_check_rate_adaptive(struct net_device *dev);\n\n \nstatic\tvoid\tdm_init_bandwidth_autoswitch(struct net_device *dev);\nstatic\tvoid\tdm_bandwidth_autoswitch(struct net_device *dev);\n\n \nstatic\tvoid\tdm_check_txpower_tracking(struct net_device *dev);\n\n \nstatic\tvoid\tdm_dig_init(struct net_device *dev);\nstatic\tvoid\tdm_ctrl_initgain_byrssi(struct net_device *dev);\nstatic\tvoid\tdm_ctrl_initgain_byrssi_highpwr(struct net_device *dev);\nstatic\tvoid\tdm_ctrl_initgain_byrssi_by_driverrssi(struct net_device *dev);\nstatic\tvoid\tdm_ctrl_initgain_byrssi_by_fwfalse_alarm(struct net_device *dev);\nstatic\tvoid\tdm_initial_gain(struct net_device *dev);\nstatic\tvoid\tdm_pd_th(struct net_device *dev);\nstatic\tvoid\tdm_cs_ratio(struct net_device *dev);\n\nstatic\tvoid dm_init_ctstoself(struct net_device *dev);\n \nstatic\tvoid\tdm_check_edca_turbo(struct net_device *dev);\n\n \nstatic\tvoid dm_check_pbc_gpio(struct net_device *dev);\n\n \nstatic\tvoid\tdm_check_rx_path_selection(struct net_device *dev);\nstatic\tvoid dm_init_rxpath_selection(struct net_device *dev);\nstatic\tvoid dm_rxpath_sel_byrssi(struct net_device *dev);\n\n \nstatic void dm_init_fsync(struct net_device *dev);\nstatic void dm_deInit_fsync(struct net_device *dev);\n\n \nstatic\tvoid\tdm_check_txrateandretrycount(struct net_device *dev);\n\n \n\n     \nstatic\tvoid\tdm_init_dynamic_txpower(struct net_device *dev);\nstatic\tvoid\tdm_dynamic_txpower(struct net_device *dev);\n\n \nstatic\tvoid dm_send_rssi_tofw(struct net_device *dev);\nstatic\tvoid\tdm_ctstoself(struct net_device *dev);\n \n \nvoid init_hal_dm(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\t \n\tpriv->undecorated_smoothed_pwdb = -1;\n\n\t \n\tdm_init_dynamic_txpower(dev);\n\tinit_rate_adaptive(dev);\n\tdm_dig_init(dev);\n\tdm_init_edca_turbo(dev);\n\tdm_init_bandwidth_autoswitch(dev);\n\tdm_init_fsync(dev);\n\tdm_init_rxpath_selection(dev);\n\tdm_init_ctstoself(dev);\n\n}\t \n\nvoid deinit_hal_dm(struct net_device *dev)\n{\n\tdm_deInit_fsync(dev);\n}\n\n#ifdef USB_RX_AGGREGATION_SUPPORT\nvoid dm_CheckRxAggregation(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tPRT_HIGH_THROUGHPUT\tpHTInfo = priv->ieee80211->pHTInfo;\n\tstatic unsigned long\tlastTxOkCnt;\n\tstatic unsigned long\tlastRxOkCnt;\n\tunsigned long\t\tcurTxOkCnt = 0;\n\tunsigned long\t\tcurRxOkCnt = 0;\n\n\tcurTxOkCnt = priv->stats.txbytesunicast - lastTxOkCnt;\n\tcurRxOkCnt = priv->stats.rxbytesunicast - lastRxOkCnt;\n\n\tif ((curTxOkCnt + curRxOkCnt) < 15000000)\n\t\treturn;\n\n\tif (curTxOkCnt > 4*curRxOkCnt) {\n\t\tif (priv->bCurrentRxAggrEnable) {\n\t\t\twrite_nic_dword(dev, 0x1a8, 0);\n\t\t\tpriv->bCurrentRxAggrEnable = false;\n\t\t}\n\t} else {\n\t\tif (!priv->bCurrentRxAggrEnable && !pHTInfo->bCurrentRT2RTAggregation) {\n\t\t\tu32 ulValue;\n\n\t\t\tulValue = (pHTInfo->UsbRxFwAggrEn<<24) | (pHTInfo->UsbRxFwAggrPageNum<<16) |\n\t\t\t\t(pHTInfo->UsbRxFwAggrPacketNum<<8) | (pHTInfo->UsbRxFwAggrTimeout);\n\t\t\t \n\t\t\twrite_nic_dword(dev, 0x1a8, ulValue);\n\t\t\tpriv->bCurrentRxAggrEnable = true;\n\t\t}\n\t}\n\n\tlastTxOkCnt = priv->stats.txbytesunicast;\n\tlastRxOkCnt = priv->stats.rxbytesunicast;\n}\t \n#endif\n\nvoid hal_dm_watchdog(struct net_device *dev)\n{\n\t \n\tdm_check_rate_adaptive(dev);\n\tdm_dynamic_txpower(dev);\n\tdm_check_txrateandretrycount(dev);\n\tdm_check_txpower_tracking(dev);\n\tdm_ctrl_initgain_byrssi(dev);\n\tdm_check_edca_turbo(dev);\n\tdm_bandwidth_autoswitch(dev);\n\tdm_check_rx_path_selection(dev);\n\tdm_check_fsync(dev);\n\n\t \n\tdm_check_pbc_gpio(dev);\n\tdm_send_rssi_tofw(dev);\n\tdm_ctstoself(dev);\n#ifdef USB_RX_AGGREGATION_SUPPORT\n\tdm_CheckRxAggregation(dev);\n#endif\n}\t \n\n \nvoid init_rate_adaptive(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tprate_adaptive\tpra = (prate_adaptive)&priv->rate_adaptive;\n\n\tpra->ratr_state = DM_RATR_STA_MAX;\n\tpra->high2low_rssi_thresh_for_ra = RATE_ADAPTIVE_TH_HIGH;\n\tpra->low2high_rssi_thresh_for_ra20M = RATE_ADAPTIVE_TH_LOW_20M + 5;\n\tpra->low2high_rssi_thresh_for_ra40M = RATE_ADAPTIVE_TH_LOW_40M + 5;\n\n\tpra->high_rssi_thresh_for_ra = RATE_ADAPTIVE_TH_HIGH + 5;\n\tpra->low_rssi_thresh_for_ra20M = RATE_ADAPTIVE_TH_LOW_20M;\n\tpra->low_rssi_thresh_for_ra40M = RATE_ADAPTIVE_TH_LOW_40M;\n\n\tif (priv->CustomerID == RT_CID_819x_Netcore)\n\t\tpra->ping_rssi_enable = 1;\n\telse\n\t\tpra->ping_rssi_enable = 0;\n\tpra->ping_rssi_thresh_for_ra = 15;\n\n\tif (priv->rf_type == RF_2T4R) {\n\t\t \n\t\tpra->upper_rssi_threshold_ratr\t\t=\t0x8f0f0000;\n\t\tpra->middle_rssi_threshold_ratr\t\t=\t0x8f0ff000;\n\t\tpra->low_rssi_threshold_ratr\t\t=\t0x8f0ff001;\n\t\tpra->low_rssi_threshold_ratr_40M\t=\t0x8f0ff005;\n\t\tpra->low_rssi_threshold_ratr_20M\t=\t0x8f0ff001;\n\t\tpra->ping_rssi_ratr\t=\t0x0000000d; \n\t} else if (priv->rf_type == RF_1T2R) {\n\t\tpra->upper_rssi_threshold_ratr\t\t=\t0x000f0000;\n\t\tpra->middle_rssi_threshold_ratr\t\t=\t0x000ff000;\n\t\tpra->low_rssi_threshold_ratr\t\t=\t0x000ff001;\n\t\tpra->low_rssi_threshold_ratr_40M\t=\t0x000ff005;\n\t\tpra->low_rssi_threshold_ratr_20M\t=\t0x000ff001;\n\t\tpra->ping_rssi_ratr\t=\t0x0000000d; \n\t}\n\n}\t \n\n \nstatic void dm_check_rate_adaptive(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tPRT_HIGH_THROUGHPUT\tpHTInfo = priv->ieee80211->pHTInfo;\n\tprate_adaptive\t\t\tpra = (prate_adaptive)&priv->rate_adaptive;\n\tu32\t\t\t\t\t\tcurrentRATR, targetRATR = 0;\n\tu32\t\t\t\t\t\tLowRSSIThreshForRA = 0, HighRSSIThreshForRA = 0;\n\tbool\t\t\t\t\t\tbshort_gi_enabled = false;\n\tstatic u8\t\t\t\t\tping_rssi_state;\n\n\tif (!priv->up) {\n\t\tRT_TRACE(COMP_RATE, \"<---- dm_check_rate_adaptive(): driver is going to unload\\n\");\n\t\treturn;\n\t}\n\n\tif (pra->rate_adaptive_disabled)  \n\t\treturn;\n\n\t \n\tif (!(priv->ieee80211->mode == WIRELESS_MODE_N_24G ||\n\t      priv->ieee80211->mode == WIRELESS_MODE_N_5G))\n\t\treturn;\n\n\tif (priv->ieee80211->state == IEEE80211_LINKED) {\n\n\t\t \n\t\tbshort_gi_enabled = (pHTInfo->bCurTxBW40MHz && pHTInfo->bCurShortGI40MHz) ||\n\t\t\t(!pHTInfo->bCurTxBW40MHz && pHTInfo->bCurShortGI20MHz);\n\n\t\tpra->upper_rssi_threshold_ratr =\n\t\t\t\t(pra->upper_rssi_threshold_ratr & (~BIT(31))) |\n\t\t\t\t((bshort_gi_enabled) ? BIT(31) : 0);\n\n\t\tpra->middle_rssi_threshold_ratr =\n\t\t\t\t(pra->middle_rssi_threshold_ratr & (~BIT(31))) |\n\t\t\t\t((bshort_gi_enabled) ? BIT(31) : 0);\n\n\t\tif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\n\t\t\tpra->low_rssi_threshold_ratr =\n\t\t\t      (pra->low_rssi_threshold_ratr_40M & (~BIT(31))) |\n\t\t\t      ((bshort_gi_enabled) ? BIT(31) : 0);\n\t\t} else {\n\t\t\tpra->low_rssi_threshold_ratr =\n\t\t\t(pra->low_rssi_threshold_ratr_20M & (~BIT(31))) |\n\t\t\t((bshort_gi_enabled) ? BIT(31) : 0);\n\t\t}\n\t\t \n\t\tpra->ping_rssi_ratr =\n\t\t\t\t(pra->ping_rssi_ratr & (~BIT(31))) |\n\t\t\t\t((bshort_gi_enabled) ? BIT(31) : 0);\n\n\t\t \n\t\tif (pra->ratr_state == DM_RATR_STA_HIGH) {\n\t\t\tHighRSSIThreshForRA\t= pra->high2low_rssi_thresh_for_ra;\n\t\t\tLowRSSIThreshForRA\t= (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) ?\n\t\t\t\t\t(pra->low_rssi_thresh_for_ra40M):(pra->low_rssi_thresh_for_ra20M);\n\t\t} else if (pra->ratr_state == DM_RATR_STA_LOW) {\n\t\t\tHighRSSIThreshForRA\t= pra->high_rssi_thresh_for_ra;\n\t\t\tLowRSSIThreshForRA\t= (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) ?\n\t\t\t\t\t(pra->low2high_rssi_thresh_for_ra40M):(pra->low2high_rssi_thresh_for_ra20M);\n\t\t} else {\n\t\t\tHighRSSIThreshForRA\t= pra->high_rssi_thresh_for_ra;\n\t\t\tLowRSSIThreshForRA\t= (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) ?\n\t\t\t\t\t(pra->low_rssi_thresh_for_ra40M):(pra->low_rssi_thresh_for_ra20M);\n\t\t}\n\n\t\tif (priv->undecorated_smoothed_pwdb >= (long)HighRSSIThreshForRA) {\n\t\t\tpra->ratr_state = DM_RATR_STA_HIGH;\n\t\t\ttargetRATR = pra->upper_rssi_threshold_ratr;\n\t\t} else if (priv->undecorated_smoothed_pwdb >= (long)LowRSSIThreshForRA) {\n\t\t\tpra->ratr_state = DM_RATR_STA_MIDDLE;\n\t\t\ttargetRATR = pra->middle_rssi_threshold_ratr;\n\t\t} else {\n\t\t\tpra->ratr_state = DM_RATR_STA_LOW;\n\t\t\ttargetRATR = pra->low_rssi_threshold_ratr;\n\t\t}\n\n\t\t \n\t\tif (pra->ping_rssi_enable) {\n\t\t\tif (priv->undecorated_smoothed_pwdb < (long)(pra->ping_rssi_thresh_for_ra+5)) {\n\t\t\t\tif ((priv->undecorated_smoothed_pwdb < (long)pra->ping_rssi_thresh_for_ra) ||\n\t\t\t\t\tping_rssi_state) {\n\t\t\t\t\tpra->ratr_state = DM_RATR_STA_LOW;\n\t\t\t\t\ttargetRATR = pra->ping_rssi_ratr;\n\t\t\t\t\tping_rssi_state = 1;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tping_rssi_state = 0;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tif (priv->ieee80211->GetHalfNmodeSupportByAPsHandler(dev))\n\t\t\ttargetRATR &= 0xf00fffff;\n\n\t\t \n\t\tread_nic_dword(dev, RATR0, &currentRATR);\n\t\tif (targetRATR !=  currentRATR) {\n\t\t\tu32 ratr_value;\n\n\t\t\tratr_value = targetRATR;\n\t\t\tRT_TRACE(COMP_RATE, \"currentRATR = %x, targetRATR = %x\\n\", currentRATR, targetRATR);\n\t\t\tif (priv->rf_type == RF_1T2R)\n\t\t\t\tratr_value &= ~(RATE_ALL_OFDM_2SS);\n\t\t\twrite_nic_dword(dev, RATR0, ratr_value);\n\t\t\twrite_nic_byte(dev, UFWP, 1);\n\n\t\t\tpra->last_ratr = targetRATR;\n\t\t}\n\n\t} else {\n\t\tpra->ratr_state = DM_RATR_STA_MAX;\n\t}\n\n}\t \n\nstatic void dm_init_bandwidth_autoswitch(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tpriv->ieee80211->bandwidth_auto_switch.threshold_20Mhzto40Mhz = BW_AUTO_SWITCH_LOW_HIGH;\n\tpriv->ieee80211->bandwidth_auto_switch.threshold_40Mhzto20Mhz = BW_AUTO_SWITCH_HIGH_LOW;\n\tpriv->ieee80211->bandwidth_auto_switch.bforced_tx20Mhz = false;\n\tpriv->ieee80211->bandwidth_auto_switch.bautoswitch_enable = false;\n\n}\t \n\nstatic void dm_bandwidth_autoswitch(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tif (priv->CurrentChannelBW == HT_CHANNEL_WIDTH_20 || !priv->ieee80211->bandwidth_auto_switch.bautoswitch_enable)\n\t\treturn;\n\tif (!priv->ieee80211->bandwidth_auto_switch.bforced_tx20Mhz) {  \n\t\tif (priv->undecorated_smoothed_pwdb <= priv->ieee80211->bandwidth_auto_switch.threshold_40Mhzto20Mhz)\n\t\t\tpriv->ieee80211->bandwidth_auto_switch.bforced_tx20Mhz = true;\n\t} else {  \n\t\tif (priv->undecorated_smoothed_pwdb >= priv->ieee80211->bandwidth_auto_switch.threshold_20Mhzto40Mhz)\n\t\t\tpriv->ieee80211->bandwidth_auto_switch.bforced_tx20Mhz = false;\n\t}\n}\t \n\n \nstatic u32 OFDMSwingTable[OFDM_Table_Length] = {\n\t0x7f8001fe,\t \n\t0x71c001c7,\t \n\t0x65400195,\t \n\t0x5a400169,\t \n\t0x50800142,\t \n\t0x47c0011f,\t \n\t0x40000100,\t \n\t0x390000e4,\t \n\t0x32c000cb,\t \n\t0x2d4000b5,\t \n\t0x288000a2,\t \n\t0x24000090,\t \n\t0x20000080,\t \n\t0x1c800072,\t \n\t0x19800066,\t \n\t0x26c0005b,\t \n\t0x24400051,\t \n\t0x12000048,\t \n\t0x10000040\t \n};\n\nstatic u8\tCCKSwingTable_Ch1_Ch13[CCK_Table_length][8] = {\n\t{0x36, 0x35, 0x2e, 0x25, 0x1c, 0x12, 0x09, 0x04},\t \n\t{0x30, 0x2f, 0x29, 0x21, 0x19, 0x10, 0x08, 0x03},\t \n\t{0x2b, 0x2a, 0x25, 0x1e, 0x16, 0x0e, 0x07, 0x03},\t \n\t{0x26, 0x25, 0x21, 0x1b, 0x14, 0x0d, 0x06, 0x03},\t \n\t{0x22, 0x21, 0x1d, 0x18, 0x11, 0x0b, 0x06, 0x02},\t \n\t{0x1f, 0x1e, 0x1a, 0x15, 0x10, 0x0a, 0x05, 0x02},\t \n\t{0x1b, 0x1a, 0x17, 0x13, 0x0e, 0x09, 0x04, 0x02},\t \n\t{0x18, 0x17, 0x15, 0x11, 0x0c, 0x08, 0x04, 0x02},\t \n\t{0x16, 0x15, 0x12, 0x0f, 0x0b, 0x07, 0x04, 0x01},\t \n\t{0x13, 0x13, 0x10, 0x0d, 0x0a, 0x06, 0x03, 0x01},\t \n\t{0x11, 0x11, 0x0f, 0x0c, 0x09, 0x06, 0x03, 0x01},\t \n\t{0x0f, 0x0f, 0x0d, 0x0b, 0x08, 0x05, 0x03, 0x01}\t \n};\n\nstatic u8\tCCKSwingTable_Ch14[CCK_Table_length][8] = {\n\t{0x36, 0x35, 0x2e, 0x1b, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x30, 0x2f, 0x29, 0x18, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x2b, 0x2a, 0x25, 0x15, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x26, 0x25, 0x21, 0x13, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x22, 0x21, 0x1d, 0x11, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x1f, 0x1e, 0x1a, 0x0f, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x1b, 0x1a, 0x17, 0x0e, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x18, 0x17, 0x15, 0x0c, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x16, 0x15, 0x12, 0x0b, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x13, 0x13, 0x10, 0x0a, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x11, 0x11, 0x0f, 0x09, 0x00, 0x00, 0x00, 0x00},\t \n\t{0x0f, 0x0f, 0x0d, 0x08, 0x00, 0x00, 0x00, 0x00}\t \n};\n\nstatic void dm_TXPowerTrackingCallback_TSSI(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tbool\t\t\t\t\t\tviviflag = false;\n\tstruct tx_config_cmd\t\t\t        tx_cmd;\n\tu8\t\t\t\t\t\tpowerlevelOFDM24G;\n\tint\t\t\t\t\t\ti = 0, j = 0, k = 0;\n\tu8\t\t\t\t\t\tRF_Type, tmp_report[5] = {0, 0, 0, 0, 0};\n\tu32\t\t\t\t\t\tValue;\n\tu8\t\t\t\t\t\tPwr_Flag;\n\tu16\t\t\t\t\t\tAvg_TSSI_Meas, TSSI_13dBm, Avg_TSSI_Meas_from_driver = 0;\n\tbool rtStatus = true;\n\tu32\t\t\t\t\t\tdelta = 0;\n\n\twrite_nic_byte(dev, 0x1ba, 0);\n\n\tpriv->ieee80211->bdynamic_txpower_enable = false;\n\n\tpowerlevelOFDM24G = (u8)(priv->Pwr_Track>>24);\n\tRF_Type = priv->rf_type;\n\tValue = (RF_Type<<8) | powerlevelOFDM24G;\n\n\tRT_TRACE(COMP_POWER_TRACKING, \"powerlevelOFDM24G = %x\\n\", powerlevelOFDM24G);\n\n\tfor (j = 0; j <= 30; j++) {  \n\t\ttx_cmd.cmd_op = TXCMD_SET_TX_PWR_TRACKING;\n\t\ttx_cmd.cmd_length = sizeof(tx_cmd.cmd_op);\n\t\ttx_cmd.cmd_value = Value;\n\t\trtStatus = SendTxCommandPacket(dev, &tx_cmd, sizeof(struct tx_config_cmd));\n\t\tif (rtStatus == RT_STATUS_FAILURE)\n\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"Set configuration with tx cmd queue fail!\\n\");\n\t\tusleep_range(1000, 2000);\n\t\tfor (i = 0; i <= 30; i++) {\n\t\t\tread_nic_byte(dev, 0x1ba, &Pwr_Flag);\n\n\t\t\tif (Pwr_Flag == 0) {\n\t\t\t\tusleep_range(1000, 2000);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tread_nic_word(dev, 0x13c, &Avg_TSSI_Meas);\n\t\t\tif (Avg_TSSI_Meas == 0) {\n\t\t\t\twrite_nic_byte(dev, 0x1ba, 0);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tfor (k = 0; k < 5; k++) {\n\t\t\t\tif (k != 4)\n\t\t\t\t\tread_nic_byte(dev, 0x134+k, &tmp_report[k]);\n\t\t\t\telse\n\t\t\t\t\tread_nic_byte(dev, 0x13e, &tmp_report[k]);\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"TSSI_report_value = %d\\n\", tmp_report[k]);\n\t\t\t}\n\n\t\t\t \n\t\t\tfor (k = 0; k < 5; k++) {\n\t\t\t\tif (tmp_report[k] <= 20) {\n\t\t\t\t\tviviflag = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (viviflag) {\n\t\t\t\twrite_nic_byte(dev, 0x1ba, 0);\n\t\t\t\tviviflag = false;\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"we filtered the data\\n\");\n\t\t\t\tfor (k = 0; k < 5; k++)\n\t\t\t\t\ttmp_report[k] = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tfor (k = 0; k < 5; k++)\n\t\t\t\tAvg_TSSI_Meas_from_driver += tmp_report[k];\n\n\t\t\tAvg_TSSI_Meas_from_driver = Avg_TSSI_Meas_from_driver*100/5;\n\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"Avg_TSSI_Meas_from_driver = %d\\n\", Avg_TSSI_Meas_from_driver);\n\t\t\tTSSI_13dBm = priv->TSSI_13dBm;\n\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"TSSI_13dBm = %d\\n\", TSSI_13dBm);\n\n\t\t\tif (Avg_TSSI_Meas_from_driver > TSSI_13dBm)\n\t\t\t\tdelta = Avg_TSSI_Meas_from_driver - TSSI_13dBm;\n\t\t\telse\n\t\t\t\tdelta = TSSI_13dBm - Avg_TSSI_Meas_from_driver;\n\n\t\t\tif (delta <= E_FOR_TX_POWER_TRACK) {\n\t\t\t\tpriv->ieee80211->bdynamic_txpower_enable = true;\n\t\t\t\twrite_nic_byte(dev, 0x1ba, 0);\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"tx power track is done\\n\");\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"priv->rfa_txpowertrackingindex = %d\\n\", priv->rfa_txpowertrackingindex);\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"priv->rfa_txpowertrackingindex_real = %d\\n\", priv->rfa_txpowertrackingindex_real);\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"priv->cck_present_attenuation_difference = %d\\n\", priv->cck_present_attenuation_difference);\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"priv->cck_present_attenuation = %d\\n\", priv->cck_present_attenuation);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (Avg_TSSI_Meas_from_driver < TSSI_13dBm - E_FOR_TX_POWER_TRACK) {\n\t\t\t\tif (priv->rfa_txpowertrackingindex > 0) {\n\t\t\t\t\tpriv->rfa_txpowertrackingindex--;\n\t\t\t\t\tif (priv->rfa_txpowertrackingindex_real > 4) {\n\t\t\t\t\t\tpriv->rfa_txpowertrackingindex_real--;\n\t\t\t\t\t\trtl8192_setBBreg(dev, rOFDM0_XATxIQImbalance, bMaskDWord, priv->txbbgain_table[priv->rfa_txpowertrackingindex_real].txbbgain_value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (priv->rfa_txpowertrackingindex < 36) {\n\t\t\t\t\tpriv->rfa_txpowertrackingindex++;\n\t\t\t\t\tpriv->rfa_txpowertrackingindex_real++;\n\t\t\t\t\trtl8192_setBBreg(dev, rOFDM0_XATxIQImbalance, bMaskDWord, priv->txbbgain_table[priv->rfa_txpowertrackingindex_real].txbbgain_value);\n\t\t\t\t}\n\t\t\t}\n\t\t\tpriv->cck_present_attenuation_difference\n\t\t\t\t= priv->rfa_txpowertrackingindex - priv->rfa_txpowertracking_default;\n\n\t\t\tif (priv->CurrentChannelBW == HT_CHANNEL_WIDTH_20)\n\t\t\t\tpriv->cck_present_attenuation\n\t\t\t\t\t= priv->cck_present_attenuation_20Mdefault + priv->cck_present_attenuation_difference;\n\t\t\telse\n\t\t\t\tpriv->cck_present_attenuation\n\t\t\t\t\t= priv->cck_present_attenuation_40Mdefault + priv->cck_present_attenuation_difference;\n\n\t\t\tif (priv->cck_present_attenuation > -1 && priv->cck_present_attenuation < 23) {\n\t\t\t\tif (priv->ieee80211->current_network.channel == 14 && !priv->bcck_in_ch14) {\n\t\t\t\t\tpriv->bcck_in_ch14 = true;\n\t\t\t\t\tdm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\n\t\t\t\t} else if (priv->ieee80211->current_network.channel != 14 && priv->bcck_in_ch14) {\n\t\t\t\t\tpriv->bcck_in_ch14 = false;\n\t\t\t\t\tdm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\n\t\t\t\t} else\n\t\t\t\t\tdm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\n\t\t\t}\n\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"priv->rfa_txpowertrackingindex = %d\\n\", priv->rfa_txpowertrackingindex);\n\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"priv->rfa_txpowertrackingindex_real = %d\\n\", priv->rfa_txpowertrackingindex_real);\n\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"priv->cck_present_attenuation_difference = %d\\n\", priv->cck_present_attenuation_difference);\n\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"priv->cck_present_attenuation = %d\\n\", priv->cck_present_attenuation);\n\n\t\t\tif (priv->cck_present_attenuation_difference <= -12 || priv->cck_present_attenuation_difference >= 24) {\n\t\t\t\tpriv->ieee80211->bdynamic_txpower_enable = true;\n\t\t\t\twrite_nic_byte(dev, 0x1ba, 0);\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"tx power track--->limited\\n\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\twrite_nic_byte(dev, 0x1ba, 0);\n\t\t\tAvg_TSSI_Meas_from_driver = 0;\n\t\t\tfor (k = 0; k < 5; k++)\n\t\t\t\ttmp_report[k] = 0;\n\t\t\tbreak;\n\t\t}\n\t}\n\tpriv->ieee80211->bdynamic_txpower_enable = true;\n\twrite_nic_byte(dev, 0x1ba, 0);\n}\n\nstatic void dm_TXPowerTrackingCallback_ThermalMeter(struct net_device *dev)\n{\n#define ThermalMeterVal\t9\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tu32 tmpRegA, TempCCk;\n\tu8 tmpOFDMindex, tmpCCKindex, tmpCCK20Mindex, tmpCCK40Mindex, tmpval;\n\tint i = 0, CCKSwingNeedUpdate = 0;\n\n\tif (!priv->btxpower_trackingInit) {\n\t\t \n\t\ttmpRegA = rtl8192_QueryBBReg(dev, rOFDM0_XATxIQImbalance, bMaskDWord);\n\t\tfor (i = 0; i < OFDM_Table_Length; i++) {  \n\t\t\tif (tmpRegA == OFDMSwingTable[i]) {\n\t\t\t\tpriv->OFDM_index = (u8)i;\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"Initial reg0x%x = 0x%x, OFDM_index=0x%x\\n\",\n\t\t\t\t\trOFDM0_XATxIQImbalance, tmpRegA, priv->OFDM_index);\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tTempCCk = rtl8192_QueryBBReg(dev, rCCK0_TxFilter1, bMaskByte2);\n\t\tfor (i = 0; i < CCK_Table_length; i++) {\n\t\t\tif (TempCCk == (u32)CCKSwingTable_Ch1_Ch13[i][0]) {\n\t\t\t\tpriv->CCK_index = (u8) i;\n\t\t\t\tRT_TRACE(COMP_POWER_TRACKING, \"Initial reg0x%x = 0x%x, CCK_index=0x%x\\n\",\n\t\t\t\t\trCCK0_TxFilter1, TempCCk, priv->CCK_index);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tpriv->btxpower_trackingInit = true;\n\t\treturn;\n\t}\n\n\t \n\n\t \n\ttmpRegA = rtl8192_phy_QueryRFReg(dev, RF90_PATH_A, 0x12, 0x078);\t \n\tRT_TRACE(COMP_POWER_TRACKING, \"Readback ThermalMeterA = %d\\n\", tmpRegA);\n\tif (tmpRegA < 3 || tmpRegA > 13)\n\t\treturn;\n\tif (tmpRegA >= 12)\t \n\t\ttmpRegA = 12;\n\tRT_TRACE(COMP_POWER_TRACKING, \"Valid ThermalMeterA = %d\\n\", tmpRegA);\n\tpriv->ThermalMeter[0] = ThermalMeterVal;\t \n\tpriv->ThermalMeter[1] = ThermalMeterVal;\t \n\n\t \n\tif (priv->ThermalMeter[0] >= (u8)tmpRegA) {\t \n\t\ttmpOFDMindex = tmpCCK20Mindex = 6+(priv->ThermalMeter[0]-(u8)tmpRegA);\n\t\ttmpCCK40Mindex = tmpCCK20Mindex - 6;\n\t\tif (tmpOFDMindex >= OFDM_Table_Length)\n\t\t\ttmpOFDMindex = OFDM_Table_Length-1;\n\t\tif (tmpCCK20Mindex >= CCK_Table_length)\n\t\t\ttmpCCK20Mindex = CCK_Table_length-1;\n\t\tif (tmpCCK40Mindex >= CCK_Table_length)\n\t\t\ttmpCCK40Mindex = CCK_Table_length-1;\n\t} else {\n\t\ttmpval = (u8)tmpRegA - priv->ThermalMeter[0];\n\n\t\tif (tmpval >= 6) {\n\t\t\t \n\t\t\ttmpOFDMindex = 0;\n\t\t\ttmpCCK20Mindex = 0;\n\t\t} else {\n\t\t\t \n\t\t\ttmpOFDMindex = 6 - tmpval;\n\t\t\ttmpCCK20Mindex = 6 - tmpval;\n\t\t}\n\t\ttmpCCK40Mindex = 0;\n\t}\n\tif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20)\t \n\t\ttmpCCKindex = tmpCCK40Mindex;\n\telse\n\t\ttmpCCKindex = tmpCCK20Mindex;\n\n\tif (priv->ieee80211->current_network.channel == 14 && !priv->bcck_in_ch14) {\n\t\tpriv->bcck_in_ch14 = true;\n\t\tCCKSwingNeedUpdate = 1;\n\t} else if (priv->ieee80211->current_network.channel != 14 && priv->bcck_in_ch14) {\n\t\tpriv->bcck_in_ch14 = false;\n\t\tCCKSwingNeedUpdate = 1;\n\t}\n\n\tif (priv->CCK_index != tmpCCKindex) {\n\t\tpriv->CCK_index = tmpCCKindex;\n\t\tCCKSwingNeedUpdate = 1;\n\t}\n\n\tif (CCKSwingNeedUpdate) {\n\t\tdm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\n\t}\n\tif (priv->OFDM_index != tmpOFDMindex) {\n\t\tpriv->OFDM_index = tmpOFDMindex;\n\t\trtl8192_setBBreg(dev, rOFDM0_XATxIQImbalance, bMaskDWord, OFDMSwingTable[priv->OFDM_index]);\n\t\tRT_TRACE(COMP_POWER_TRACKING, \"Update OFDMSwing[%d] = 0x%x\\n\",\n\t\t\tpriv->OFDM_index, OFDMSwingTable[priv->OFDM_index]);\n\t}\n\tpriv->txpower_count = 0;\n}\n\nvoid dm_txpower_trackingcallback(struct work_struct *work)\n{\n\tstruct delayed_work *dwork = to_delayed_work(work);\n\tstruct r8192_priv *priv = container_of(dwork, struct r8192_priv, txpower_tracking_wq);\n\tstruct net_device *dev = priv->ieee80211->dev;\n\n\tif (priv->bDcut)\n\t\tdm_TXPowerTrackingCallback_TSSI(dev);\n\telse\n\t\tdm_TXPowerTrackingCallback_ThermalMeter(dev);\n}\n\nstatic void dm_InitializeTXPowerTracking_TSSI(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\t \n\tpriv->txbbgain_table[0].txbb_iq_amplifygain =\t\t\t12;\n\tpriv->txbbgain_table[0].txbbgain_value = 0x7f8001fe;\n\tpriv->txbbgain_table[1].txbb_iq_amplifygain =\t\t\t11;\n\tpriv->txbbgain_table[1].txbbgain_value = 0x788001e2;\n\tpriv->txbbgain_table[2].txbb_iq_amplifygain =\t\t\t10;\n\tpriv->txbbgain_table[2].txbbgain_value = 0x71c001c7;\n\tpriv->txbbgain_table[3].txbb_iq_amplifygain =\t\t\t9;\n\tpriv->txbbgain_table[3].txbbgain_value = 0x6b8001ae;\n\tpriv->txbbgain_table[4].txbb_iq_amplifygain =\t\t       8;\n\tpriv->txbbgain_table[4].txbbgain_value = 0x65400195;\n\tpriv->txbbgain_table[5].txbb_iq_amplifygain =\t\t       7;\n\tpriv->txbbgain_table[5].txbbgain_value = 0x5fc0017f;\n\tpriv->txbbgain_table[6].txbb_iq_amplifygain =\t\t       6;\n\tpriv->txbbgain_table[6].txbbgain_value = 0x5a400169;\n\tpriv->txbbgain_table[7].txbb_iq_amplifygain =\t\t       5;\n\tpriv->txbbgain_table[7].txbbgain_value = 0x55400155;\n\tpriv->txbbgain_table[8].txbb_iq_amplifygain =\t\t       4;\n\tpriv->txbbgain_table[8].txbbgain_value = 0x50800142;\n\tpriv->txbbgain_table[9].txbb_iq_amplifygain =\t\t       3;\n\tpriv->txbbgain_table[9].txbbgain_value = 0x4c000130;\n\tpriv->txbbgain_table[10].txbb_iq_amplifygain =\t\t       2;\n\tpriv->txbbgain_table[10].txbbgain_value = 0x47c0011f;\n\tpriv->txbbgain_table[11].txbb_iq_amplifygain =\t\t       1;\n\tpriv->txbbgain_table[11].txbbgain_value = 0x43c0010f;\n\tpriv->txbbgain_table[12].txbb_iq_amplifygain =\t\t       0;\n\tpriv->txbbgain_table[12].txbbgain_value = 0x40000100;\n\tpriv->txbbgain_table[13].txbb_iq_amplifygain =\t\t       -1;\n\tpriv->txbbgain_table[13].txbbgain_value = 0x3c8000f2;\n\tpriv->txbbgain_table[14].txbb_iq_amplifygain =\t\t     -2;\n\tpriv->txbbgain_table[14].txbbgain_value = 0x390000e4;\n\tpriv->txbbgain_table[15].txbb_iq_amplifygain =\t\t     -3;\n\tpriv->txbbgain_table[15].txbbgain_value = 0x35c000d7;\n\tpriv->txbbgain_table[16].txbb_iq_amplifygain =\t\t     -4;\n\tpriv->txbbgain_table[16].txbbgain_value = 0x32c000cb;\n\tpriv->txbbgain_table[17].txbb_iq_amplifygain =\t\t     -5;\n\tpriv->txbbgain_table[17].txbbgain_value = 0x300000c0;\n\tpriv->txbbgain_table[18].txbb_iq_amplifygain =\t\t\t    -6;\n\tpriv->txbbgain_table[18].txbbgain_value = 0x2d4000b5;\n\tpriv->txbbgain_table[19].txbb_iq_amplifygain =\t\t     -7;\n\tpriv->txbbgain_table[19].txbbgain_value = 0x2ac000ab;\n\tpriv->txbbgain_table[20].txbb_iq_amplifygain =\t\t     -8;\n\tpriv->txbbgain_table[20].txbbgain_value = 0x288000a2;\n\tpriv->txbbgain_table[21].txbb_iq_amplifygain =\t\t     -9;\n\tpriv->txbbgain_table[21].txbbgain_value = 0x26000098;\n\tpriv->txbbgain_table[22].txbb_iq_amplifygain =\t\t     -10;\n\tpriv->txbbgain_table[22].txbbgain_value = 0x24000090;\n\tpriv->txbbgain_table[23].txbb_iq_amplifygain =\t\t     -11;\n\tpriv->txbbgain_table[23].txbbgain_value = 0x22000088;\n\tpriv->txbbgain_table[24].txbb_iq_amplifygain =\t\t     -12;\n\tpriv->txbbgain_table[24].txbbgain_value = 0x20000080;\n\tpriv->txbbgain_table[25].txbb_iq_amplifygain =\t\t     -13;\n\tpriv->txbbgain_table[25].txbbgain_value = 0x1a00006c;\n\tpriv->txbbgain_table[26].txbb_iq_amplifygain =\t\t     -14;\n\tpriv->txbbgain_table[26].txbbgain_value = 0x1c800072;\n\tpriv->txbbgain_table[27].txbb_iq_amplifygain =\t\t     -15;\n\tpriv->txbbgain_table[27].txbbgain_value = 0x18000060;\n\tpriv->txbbgain_table[28].txbb_iq_amplifygain =\t\t     -16;\n\tpriv->txbbgain_table[28].txbbgain_value = 0x19800066;\n\tpriv->txbbgain_table[29].txbb_iq_amplifygain =\t\t     -17;\n\tpriv->txbbgain_table[29].txbbgain_value = 0x15800056;\n\tpriv->txbbgain_table[30].txbb_iq_amplifygain =\t\t     -18;\n\tpriv->txbbgain_table[30].txbbgain_value = 0x26c0005b;\n\tpriv->txbbgain_table[31].txbb_iq_amplifygain =\t\t     -19;\n\tpriv->txbbgain_table[31].txbbgain_value = 0x14400051;\n\tpriv->txbbgain_table[32].txbb_iq_amplifygain =\t\t     -20;\n\tpriv->txbbgain_table[32].txbbgain_value = 0x24400051;\n\tpriv->txbbgain_table[33].txbb_iq_amplifygain =\t\t     -21;\n\tpriv->txbbgain_table[33].txbbgain_value = 0x1300004c;\n\tpriv->txbbgain_table[34].txbb_iq_amplifygain =\t\t     -22;\n\tpriv->txbbgain_table[34].txbbgain_value = 0x12000048;\n\tpriv->txbbgain_table[35].txbb_iq_amplifygain =\t\t     -23;\n\tpriv->txbbgain_table[35].txbbgain_value = 0x11000044;\n\tpriv->txbbgain_table[36].txbb_iq_amplifygain =\t\t     -24;\n\tpriv->txbbgain_table[36].txbbgain_value = 0x10000040;\n\n\t \n\tpriv->cck_txbbgain_table[0].ccktxbb_valuearray[0] = 0x36;\n\tpriv->cck_txbbgain_table[0].ccktxbb_valuearray[1] = 0x35;\n\tpriv->cck_txbbgain_table[0].ccktxbb_valuearray[2] = 0x2e;\n\tpriv->cck_txbbgain_table[0].ccktxbb_valuearray[3] = 0x25;\n\tpriv->cck_txbbgain_table[0].ccktxbb_valuearray[4] = 0x1c;\n\tpriv->cck_txbbgain_table[0].ccktxbb_valuearray[5] = 0x12;\n\tpriv->cck_txbbgain_table[0].ccktxbb_valuearray[6] = 0x09;\n\tpriv->cck_txbbgain_table[0].ccktxbb_valuearray[7] = 0x04;\n\n\tpriv->cck_txbbgain_table[1].ccktxbb_valuearray[0] = 0x33;\n\tpriv->cck_txbbgain_table[1].ccktxbb_valuearray[1] = 0x32;\n\tpriv->cck_txbbgain_table[1].ccktxbb_valuearray[2] = 0x2b;\n\tpriv->cck_txbbgain_table[1].ccktxbb_valuearray[3] = 0x23;\n\tpriv->cck_txbbgain_table[1].ccktxbb_valuearray[4] = 0x1a;\n\tpriv->cck_txbbgain_table[1].ccktxbb_valuearray[5] = 0x11;\n\tpriv->cck_txbbgain_table[1].ccktxbb_valuearray[6] = 0x08;\n\tpriv->cck_txbbgain_table[1].ccktxbb_valuearray[7] = 0x04;\n\n\tpriv->cck_txbbgain_table[2].ccktxbb_valuearray[0] = 0x30;\n\tpriv->cck_txbbgain_table[2].ccktxbb_valuearray[1] = 0x2f;\n\tpriv->cck_txbbgain_table[2].ccktxbb_valuearray[2] = 0x29;\n\tpriv->cck_txbbgain_table[2].ccktxbb_valuearray[3] = 0x21;\n\tpriv->cck_txbbgain_table[2].ccktxbb_valuearray[4] = 0x19;\n\tpriv->cck_txbbgain_table[2].ccktxbb_valuearray[5] = 0x10;\n\tpriv->cck_txbbgain_table[2].ccktxbb_valuearray[6] = 0x08;\n\tpriv->cck_txbbgain_table[2].ccktxbb_valuearray[7] = 0x03;\n\n\tpriv->cck_txbbgain_table[3].ccktxbb_valuearray[0] = 0x2d;\n\tpriv->cck_txbbgain_table[3].ccktxbb_valuearray[1] = 0x2d;\n\tpriv->cck_txbbgain_table[3].ccktxbb_valuearray[2] = 0x27;\n\tpriv->cck_txbbgain_table[3].ccktxbb_valuearray[3] = 0x1f;\n\tpriv->cck_txbbgain_table[3].ccktxbb_valuearray[4] = 0x18;\n\tpriv->cck_txbbgain_table[3].ccktxbb_valuearray[5] = 0x0f;\n\tpriv->cck_txbbgain_table[3].ccktxbb_valuearray[6] = 0x08;\n\tpriv->cck_txbbgain_table[3].ccktxbb_valuearray[7] = 0x03;\n\n\tpriv->cck_txbbgain_table[4].ccktxbb_valuearray[0] = 0x2b;\n\tpriv->cck_txbbgain_table[4].ccktxbb_valuearray[1] = 0x2a;\n\tpriv->cck_txbbgain_table[4].ccktxbb_valuearray[2] = 0x25;\n\tpriv->cck_txbbgain_table[4].ccktxbb_valuearray[3] = 0x1e;\n\tpriv->cck_txbbgain_table[4].ccktxbb_valuearray[4] = 0x16;\n\tpriv->cck_txbbgain_table[4].ccktxbb_valuearray[5] = 0x0e;\n\tpriv->cck_txbbgain_table[4].ccktxbb_valuearray[6] = 0x07;\n\tpriv->cck_txbbgain_table[4].ccktxbb_valuearray[7] = 0x03;\n\n\tpriv->cck_txbbgain_table[5].ccktxbb_valuearray[0] = 0x28;\n\tpriv->cck_txbbgain_table[5].ccktxbb_valuearray[1] = 0x28;\n\tpriv->cck_txbbgain_table[5].ccktxbb_valuearray[2] = 0x22;\n\tpriv->cck_txbbgain_table[5].ccktxbb_valuearray[3] = 0x1c;\n\tpriv->cck_txbbgain_table[5].ccktxbb_valuearray[4] = 0x15;\n\tpriv->cck_txbbgain_table[5].ccktxbb_valuearray[5] = 0x0d;\n\tpriv->cck_txbbgain_table[5].ccktxbb_valuearray[6] = 0x07;\n\tpriv->cck_txbbgain_table[5].ccktxbb_valuearray[7] = 0x03;\n\n\tpriv->cck_txbbgain_table[6].ccktxbb_valuearray[0] = 0x26;\n\tpriv->cck_txbbgain_table[6].ccktxbb_valuearray[1] = 0x25;\n\tpriv->cck_txbbgain_table[6].ccktxbb_valuearray[2] = 0x21;\n\tpriv->cck_txbbgain_table[6].ccktxbb_valuearray[3] = 0x1b;\n\tpriv->cck_txbbgain_table[6].ccktxbb_valuearray[4] = 0x14;\n\tpriv->cck_txbbgain_table[6].ccktxbb_valuearray[5] = 0x0d;\n\tpriv->cck_txbbgain_table[6].ccktxbb_valuearray[6] = 0x06;\n\tpriv->cck_txbbgain_table[6].ccktxbb_valuearray[7] = 0x03;\n\n\tpriv->cck_txbbgain_table[7].ccktxbb_valuearray[0] = 0x24;\n\tpriv->cck_txbbgain_table[7].ccktxbb_valuearray[1] = 0x23;\n\tpriv->cck_txbbgain_table[7].ccktxbb_valuearray[2] = 0x1f;\n\tpriv->cck_txbbgain_table[7].ccktxbb_valuearray[3] = 0x19;\n\tpriv->cck_txbbgain_table[7].ccktxbb_valuearray[4] = 0x13;\n\tpriv->cck_txbbgain_table[7].ccktxbb_valuearray[5] = 0x0c;\n\tpriv->cck_txbbgain_table[7].ccktxbb_valuearray[6] = 0x06;\n\tpriv->cck_txbbgain_table[7].ccktxbb_valuearray[7] = 0x03;\n\n\tpriv->cck_txbbgain_table[8].ccktxbb_valuearray[0] = 0x22;\n\tpriv->cck_txbbgain_table[8].ccktxbb_valuearray[1] = 0x21;\n\tpriv->cck_txbbgain_table[8].ccktxbb_valuearray[2] = 0x1d;\n\tpriv->cck_txbbgain_table[8].ccktxbb_valuearray[3] = 0x18;\n\tpriv->cck_txbbgain_table[8].ccktxbb_valuearray[4] = 0x11;\n\tpriv->cck_txbbgain_table[8].ccktxbb_valuearray[5] = 0x0b;\n\tpriv->cck_txbbgain_table[8].ccktxbb_valuearray[6] = 0x06;\n\tpriv->cck_txbbgain_table[8].ccktxbb_valuearray[7] = 0x02;\n\n\tpriv->cck_txbbgain_table[9].ccktxbb_valuearray[0] = 0x20;\n\tpriv->cck_txbbgain_table[9].ccktxbb_valuearray[1] = 0x20;\n\tpriv->cck_txbbgain_table[9].ccktxbb_valuearray[2] = 0x1b;\n\tpriv->cck_txbbgain_table[9].ccktxbb_valuearray[3] = 0x16;\n\tpriv->cck_txbbgain_table[9].ccktxbb_valuearray[4] = 0x11;\n\tpriv->cck_txbbgain_table[9].ccktxbb_valuearray[5] = 0x08;\n\tpriv->cck_txbbgain_table[9].ccktxbb_valuearray[6] = 0x05;\n\tpriv->cck_txbbgain_table[9].ccktxbb_valuearray[7] = 0x02;\n\n\tpriv->cck_txbbgain_table[10].ccktxbb_valuearray[0] = 0x1f;\n\tpriv->cck_txbbgain_table[10].ccktxbb_valuearray[1] = 0x1e;\n\tpriv->cck_txbbgain_table[10].ccktxbb_valuearray[2] = 0x1a;\n\tpriv->cck_txbbgain_table[10].ccktxbb_valuearray[3] = 0x15;\n\tpriv->cck_txbbgain_table[10].ccktxbb_valuearray[4] = 0x10;\n\tpriv->cck_txbbgain_table[10].ccktxbb_valuearray[5] = 0x0a;\n\tpriv->cck_txbbgain_table[10].ccktxbb_valuearray[6] = 0x05;\n\tpriv->cck_txbbgain_table[10].ccktxbb_valuearray[7] = 0x02;\n\n\tpriv->cck_txbbgain_table[11].ccktxbb_valuearray[0] = 0x1d;\n\tpriv->cck_txbbgain_table[11].ccktxbb_valuearray[1] = 0x1c;\n\tpriv->cck_txbbgain_table[11].ccktxbb_valuearray[2] = 0x18;\n\tpriv->cck_txbbgain_table[11].ccktxbb_valuearray[3] = 0x14;\n\tpriv->cck_txbbgain_table[11].ccktxbb_valuearray[4] = 0x0f;\n\tpriv->cck_txbbgain_table[11].ccktxbb_valuearray[5] = 0x0a;\n\tpriv->cck_txbbgain_table[11].ccktxbb_valuearray[6] = 0x05;\n\tpriv->cck_txbbgain_table[11].ccktxbb_valuearray[7] = 0x02;\n\n\tpriv->cck_txbbgain_table[12].ccktxbb_valuearray[0] = 0x1b;\n\tpriv->cck_txbbgain_table[12].ccktxbb_valuearray[1] = 0x1a;\n\tpriv->cck_txbbgain_table[12].ccktxbb_valuearray[2] = 0x17;\n\tpriv->cck_txbbgain_table[12].ccktxbb_valuearray[3] = 0x13;\n\tpriv->cck_txbbgain_table[12].ccktxbb_valuearray[4] = 0x0e;\n\tpriv->cck_txbbgain_table[12].ccktxbb_valuearray[5] = 0x09;\n\tpriv->cck_txbbgain_table[12].ccktxbb_valuearray[6] = 0x04;\n\tpriv->cck_txbbgain_table[12].ccktxbb_valuearray[7] = 0x02;\n\n\tpriv->cck_txbbgain_table[13].ccktxbb_valuearray[0] = 0x1a;\n\tpriv->cck_txbbgain_table[13].ccktxbb_valuearray[1] = 0x19;\n\tpriv->cck_txbbgain_table[13].ccktxbb_valuearray[2] = 0x16;\n\tpriv->cck_txbbgain_table[13].ccktxbb_valuearray[3] = 0x12;\n\tpriv->cck_txbbgain_table[13].ccktxbb_valuearray[4] = 0x0d;\n\tpriv->cck_txbbgain_table[13].ccktxbb_valuearray[5] = 0x09;\n\tpriv->cck_txbbgain_table[13].ccktxbb_valuearray[6] = 0x04;\n\tpriv->cck_txbbgain_table[13].ccktxbb_valuearray[7] = 0x02;\n\n\tpriv->cck_txbbgain_table[14].ccktxbb_valuearray[0] = 0x18;\n\tpriv->cck_txbbgain_table[14].ccktxbb_valuearray[1] = 0x17;\n\tpriv->cck_txbbgain_table[14].ccktxbb_valuearray[2] = 0x15;\n\tpriv->cck_txbbgain_table[14].ccktxbb_valuearray[3] = 0x11;\n\tpriv->cck_txbbgain_table[14].ccktxbb_valuearray[4] = 0x0c;\n\tpriv->cck_txbbgain_table[14].ccktxbb_valuearray[5] = 0x08;\n\tpriv->cck_txbbgain_table[14].ccktxbb_valuearray[6] = 0x04;\n\tpriv->cck_txbbgain_table[14].ccktxbb_valuearray[7] = 0x02;\n\n\tpriv->cck_txbbgain_table[15].ccktxbb_valuearray[0] = 0x17;\n\tpriv->cck_txbbgain_table[15].ccktxbb_valuearray[1] = 0x16;\n\tpriv->cck_txbbgain_table[15].ccktxbb_valuearray[2] = 0x13;\n\tpriv->cck_txbbgain_table[15].ccktxbb_valuearray[3] = 0x10;\n\tpriv->cck_txbbgain_table[15].ccktxbb_valuearray[4] = 0x0c;\n\tpriv->cck_txbbgain_table[15].ccktxbb_valuearray[5] = 0x08;\n\tpriv->cck_txbbgain_table[15].ccktxbb_valuearray[6] = 0x04;\n\tpriv->cck_txbbgain_table[15].ccktxbb_valuearray[7] = 0x02;\n\n\tpriv->cck_txbbgain_table[16].ccktxbb_valuearray[0] = 0x16;\n\tpriv->cck_txbbgain_table[16].ccktxbb_valuearray[1] = 0x15;\n\tpriv->cck_txbbgain_table[16].ccktxbb_valuearray[2] = 0x12;\n\tpriv->cck_txbbgain_table[16].ccktxbb_valuearray[3] = 0x0f;\n\tpriv->cck_txbbgain_table[16].ccktxbb_valuearray[4] = 0x0b;\n\tpriv->cck_txbbgain_table[16].ccktxbb_valuearray[5] = 0x07;\n\tpriv->cck_txbbgain_table[16].ccktxbb_valuearray[6] = 0x04;\n\tpriv->cck_txbbgain_table[16].ccktxbb_valuearray[7] = 0x01;\n\n\tpriv->cck_txbbgain_table[17].ccktxbb_valuearray[0] = 0x14;\n\tpriv->cck_txbbgain_table[17].ccktxbb_valuearray[1] = 0x14;\n\tpriv->cck_txbbgain_table[17].ccktxbb_valuearray[2] = 0x11;\n\tpriv->cck_txbbgain_table[17].ccktxbb_valuearray[3] = 0x0e;\n\tpriv->cck_txbbgain_table[17].ccktxbb_valuearray[4] = 0x0b;\n\tpriv->cck_txbbgain_table[17].ccktxbb_valuearray[5] = 0x07;\n\tpriv->cck_txbbgain_table[17].ccktxbb_valuearray[6] = 0x03;\n\tpriv->cck_txbbgain_table[17].ccktxbb_valuearray[7] = 0x02;\n\n\tpriv->cck_txbbgain_table[18].ccktxbb_valuearray[0] = 0x13;\n\tpriv->cck_txbbgain_table[18].ccktxbb_valuearray[1] = 0x13;\n\tpriv->cck_txbbgain_table[18].ccktxbb_valuearray[2] = 0x10;\n\tpriv->cck_txbbgain_table[18].ccktxbb_valuearray[3] = 0x0d;\n\tpriv->cck_txbbgain_table[18].ccktxbb_valuearray[4] = 0x0a;\n\tpriv->cck_txbbgain_table[18].ccktxbb_valuearray[5] = 0x06;\n\tpriv->cck_txbbgain_table[18].ccktxbb_valuearray[6] = 0x03;\n\tpriv->cck_txbbgain_table[18].ccktxbb_valuearray[7] = 0x01;\n\n\tpriv->cck_txbbgain_table[19].ccktxbb_valuearray[0] = 0x12;\n\tpriv->cck_txbbgain_table[19].ccktxbb_valuearray[1] = 0x12;\n\tpriv->cck_txbbgain_table[19].ccktxbb_valuearray[2] = 0x0f;\n\tpriv->cck_txbbgain_table[19].ccktxbb_valuearray[3] = 0x0c;\n\tpriv->cck_txbbgain_table[19].ccktxbb_valuearray[4] = 0x09;\n\tpriv->cck_txbbgain_table[19].ccktxbb_valuearray[5] = 0x06;\n\tpriv->cck_txbbgain_table[19].ccktxbb_valuearray[6] = 0x03;\n\tpriv->cck_txbbgain_table[19].ccktxbb_valuearray[7] = 0x01;\n\n\tpriv->cck_txbbgain_table[20].ccktxbb_valuearray[0] = 0x11;\n\tpriv->cck_txbbgain_table[20].ccktxbb_valuearray[1] = 0x11;\n\tpriv->cck_txbbgain_table[20].ccktxbb_valuearray[2] = 0x0f;\n\tpriv->cck_txbbgain_table[20].ccktxbb_valuearray[3] = 0x0c;\n\tpriv->cck_txbbgain_table[20].ccktxbb_valuearray[4] = 0x09;\n\tpriv->cck_txbbgain_table[20].ccktxbb_valuearray[5] = 0x06;\n\tpriv->cck_txbbgain_table[20].ccktxbb_valuearray[6] = 0x03;\n\tpriv->cck_txbbgain_table[20].ccktxbb_valuearray[7] = 0x01;\n\n\tpriv->cck_txbbgain_table[21].ccktxbb_valuearray[0] = 0x10;\n\tpriv->cck_txbbgain_table[21].ccktxbb_valuearray[1] = 0x10;\n\tpriv->cck_txbbgain_table[21].ccktxbb_valuearray[2] = 0x0e;\n\tpriv->cck_txbbgain_table[21].ccktxbb_valuearray[3] = 0x0b;\n\tpriv->cck_txbbgain_table[21].ccktxbb_valuearray[4] = 0x08;\n\tpriv->cck_txbbgain_table[21].ccktxbb_valuearray[5] = 0x05;\n\tpriv->cck_txbbgain_table[21].ccktxbb_valuearray[6] = 0x03;\n\tpriv->cck_txbbgain_table[21].ccktxbb_valuearray[7] = 0x01;\n\n\tpriv->cck_txbbgain_table[22].ccktxbb_valuearray[0] = 0x0f;\n\tpriv->cck_txbbgain_table[22].ccktxbb_valuearray[1] = 0x0f;\n\tpriv->cck_txbbgain_table[22].ccktxbb_valuearray[2] = 0x0d;\n\tpriv->cck_txbbgain_table[22].ccktxbb_valuearray[3] = 0x0b;\n\tpriv->cck_txbbgain_table[22].ccktxbb_valuearray[4] = 0x08;\n\tpriv->cck_txbbgain_table[22].ccktxbb_valuearray[5] = 0x05;\n\tpriv->cck_txbbgain_table[22].ccktxbb_valuearray[6] = 0x03;\n\tpriv->cck_txbbgain_table[22].ccktxbb_valuearray[7] = 0x01;\n\n\t \n\tpriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[0] = 0x36;\n\tpriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[1] = 0x35;\n\tpriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[2] = 0x2e;\n\tpriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[3] = 0x1b;\n\tpriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[0] = 0x33;\n\tpriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[1] = 0x32;\n\tpriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[2] = 0x2b;\n\tpriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[3] = 0x19;\n\tpriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[0] = 0x30;\n\tpriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[1] = 0x2f;\n\tpriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[2] = 0x29;\n\tpriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[3] = 0x18;\n\tpriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[0] = 0x2d;\n\tpriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[1] = 0x2d;\n\tpriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[2] = 0x27;\n\tpriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[3] = 0x17;\n\tpriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[0] = 0x2b;\n\tpriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[1] = 0x2a;\n\tpriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[2] = 0x25;\n\tpriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[3] = 0x15;\n\tpriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[0] = 0x28;\n\tpriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[1] = 0x28;\n\tpriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[2] = 0x22;\n\tpriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[3] = 0x14;\n\tpriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[0] = 0x26;\n\tpriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[1] = 0x25;\n\tpriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[2] = 0x21;\n\tpriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[3] = 0x13;\n\tpriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[0] = 0x24;\n\tpriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[1] = 0x23;\n\tpriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[2] = 0x1f;\n\tpriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[3] = 0x12;\n\tpriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[0] = 0x22;\n\tpriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[1] = 0x21;\n\tpriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[2] = 0x1d;\n\tpriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[3] = 0x11;\n\tpriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[0] = 0x20;\n\tpriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[1] = 0x20;\n\tpriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[2] = 0x1b;\n\tpriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[3] = 0x10;\n\tpriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[0] = 0x1f;\n\tpriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[1] = 0x1e;\n\tpriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[2] = 0x1a;\n\tpriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[3] = 0x0f;\n\tpriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[0] = 0x1d;\n\tpriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[1] = 0x1c;\n\tpriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[2] = 0x18;\n\tpriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[3] = 0x0e;\n\tpriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[0] = 0x1b;\n\tpriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[1] = 0x1a;\n\tpriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[2] = 0x17;\n\tpriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[3] = 0x0e;\n\tpriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[0] = 0x1a;\n\tpriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[1] = 0x19;\n\tpriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[2] = 0x16;\n\tpriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[3] = 0x0d;\n\tpriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[0] = 0x18;\n\tpriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[1] = 0x17;\n\tpriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[2] = 0x15;\n\tpriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[3] = 0x0c;\n\tpriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[0] = 0x17;\n\tpriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[1] = 0x16;\n\tpriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[2] = 0x13;\n\tpriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[3] = 0x0b;\n\tpriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[0] = 0x16;\n\tpriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[1] = 0x15;\n\tpriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[2] = 0x12;\n\tpriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[3] = 0x0b;\n\tpriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[0] = 0x14;\n\tpriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[1] = 0x14;\n\tpriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[2] = 0x11;\n\tpriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[3] = 0x0a;\n\tpriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[0] = 0x13;\n\tpriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[1] = 0x13;\n\tpriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[2] = 0x10;\n\tpriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[3] = 0x0a;\n\tpriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[0] = 0x12;\n\tpriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[1] = 0x12;\n\tpriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[2] = 0x0f;\n\tpriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[3] = 0x09;\n\tpriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[0] = 0x11;\n\tpriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[1] = 0x11;\n\tpriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[2] = 0x0f;\n\tpriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[3] = 0x09;\n\tpriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[0] = 0x10;\n\tpriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[1] = 0x10;\n\tpriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[2] = 0x0e;\n\tpriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[3] = 0x08;\n\tpriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[0] = 0x0f;\n\tpriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[1] = 0x0f;\n\tpriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[2] = 0x0d;\n\tpriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[3] = 0x08;\n\tpriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[4] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[5] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[6] = 0x00;\n\tpriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[7] = 0x00;\n\n\tpriv->btxpower_tracking = true;\n\tpriv->txpower_count       = 0;\n\tpriv->btxpower_trackingInit = false;\n}\n\nstatic void dm_InitializeTXPowerTracking_ThermalMeter(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\t \n\tif (priv->ieee80211->FwRWRF)\n\t\tpriv->btxpower_tracking = true;\n\telse\n\t\tpriv->btxpower_tracking = false;\n\tpriv->txpower_count       = 0;\n\tpriv->btxpower_trackingInit = false;\n}\n\nvoid dm_initialize_txpower_tracking(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tif (priv->bDcut)\n\t\tdm_InitializeTXPowerTracking_TSSI(dev);\n\telse\n\t\tdm_InitializeTXPowerTracking_ThermalMeter(dev);\n}  \n\nstatic void dm_CheckTXPowerTracking_TSSI(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tstatic u32 tx_power_track_counter;\n\n\tif (!priv->btxpower_tracking)\n\t\treturn;\n\tif ((tx_power_track_counter % 30 == 0) && (tx_power_track_counter != 0))\n\t\tqueue_delayed_work(priv->priv_wq, &priv->txpower_tracking_wq, 0);\n\ttx_power_track_counter++;\n}\n\nstatic void dm_CheckTXPowerTracking_ThermalMeter(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tstatic u8\tTM_Trigger;\n\tif (!priv->btxpower_tracking)\n\t\treturn;\n\tif (priv->txpower_count  <= 2) {\n\t\tpriv->txpower_count++;\n\t\treturn;\n\t}\n\n\tif (!TM_Trigger) {\n\t\t \n\t\trtl8192_phy_SetRFReg(dev, RF90_PATH_A, 0x02, bMask12Bits, 0x4d);\n\t\trtl8192_phy_SetRFReg(dev, RF90_PATH_A, 0x02, bMask12Bits, 0x4f);\n\t\trtl8192_phy_SetRFReg(dev, RF90_PATH_A, 0x02, bMask12Bits, 0x4d);\n\t\trtl8192_phy_SetRFReg(dev, RF90_PATH_A, 0x02, bMask12Bits, 0x4f);\n\t\tTM_Trigger = 1;\n\t\treturn;\n\t}\n\tqueue_delayed_work(priv->priv_wq, &priv->txpower_tracking_wq, 0);\n\tTM_Trigger = 0;\n}\n\nstatic void dm_check_txpower_tracking(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n#ifdef RTL8190P\n\tdm_CheckTXPowerTracking_TSSI(dev);\n#else\n\tif (priv->bDcut)\n\t\tdm_CheckTXPowerTracking_TSSI(dev);\n\telse\n\t\tdm_CheckTXPowerTracking_ThermalMeter(dev);\n#endif\n\n}\t \n\nstatic void dm_CCKTxPowerAdjust_TSSI(struct net_device *dev, bool  bInCH14)\n{\n\tu32 TempVal;\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\t \n\tTempVal = 0;\n\tif (!bInCH14) {\n\t\t \n\t\tTempVal =\tpriv->cck_txbbgain_table[priv->cck_present_attenuation].ccktxbb_valuearray[0] +\n\t\t\t\t\t(priv->cck_txbbgain_table[priv->cck_present_attenuation].ccktxbb_valuearray[1]<<8);\n\n\t\trtl8192_setBBreg(dev, rCCK0_TxFilter1, bMaskHWord, TempVal);\n\t\t \n\t\tTempVal =\tpriv->cck_txbbgain_table[priv->cck_present_attenuation].ccktxbb_valuearray[2] +\n\t\t\t\t\t(priv->cck_txbbgain_table[priv->cck_present_attenuation].ccktxbb_valuearray[3]<<8) +\n\t\t\t\t\t(priv->cck_txbbgain_table[priv->cck_present_attenuation].ccktxbb_valuearray[4]<<16)+\n\t\t\t\t\t(priv->cck_txbbgain_table[priv->cck_present_attenuation].ccktxbb_valuearray[5]<<24);\n\t\trtl8192_setBBreg(dev, rCCK0_TxFilter2, bMaskDWord, TempVal);\n\t\t \n\t\tTempVal =\tpriv->cck_txbbgain_table[priv->cck_present_attenuation].ccktxbb_valuearray[6] +\n\t\t\t\t\t(priv->cck_txbbgain_table[priv->cck_present_attenuation].ccktxbb_valuearray[7]<<8);\n\n\t\trtl8192_setBBreg(dev, rCCK0_DebugPort, bMaskLWord, TempVal);\n\t} else {\n\t\tTempVal =\tpriv->cck_txbbgain_ch14_table[priv->cck_present_attenuation].ccktxbb_valuearray[0] +\n\t\t\t\t\t(priv->cck_txbbgain_ch14_table[priv->cck_present_attenuation].ccktxbb_valuearray[1]<<8);\n\n\t\trtl8192_setBBreg(dev, rCCK0_TxFilter1, bMaskHWord, TempVal);\n\t\t \n\t\tTempVal =\tpriv->cck_txbbgain_ch14_table[priv->cck_present_attenuation].ccktxbb_valuearray[2] +\n\t\t\t\t\t(priv->cck_txbbgain_ch14_table[priv->cck_present_attenuation].ccktxbb_valuearray[3]<<8) +\n\t\t\t\t\t(priv->cck_txbbgain_ch14_table[priv->cck_present_attenuation].ccktxbb_valuearray[4]<<16)+\n\t\t\t\t\t(priv->cck_txbbgain_ch14_table[priv->cck_present_attenuation].ccktxbb_valuearray[5]<<24);\n\t\trtl8192_setBBreg(dev, rCCK0_TxFilter2, bMaskDWord, TempVal);\n\t\t \n\t\tTempVal =\tpriv->cck_txbbgain_ch14_table[priv->cck_present_attenuation].ccktxbb_valuearray[6] +\n\t\t\t\t\t(priv->cck_txbbgain_ch14_table[priv->cck_present_attenuation].ccktxbb_valuearray[7]<<8);\n\n\t\trtl8192_setBBreg(dev, rCCK0_DebugPort, bMaskLWord, TempVal);\n\t}\n}\n\nstatic void dm_CCKTxPowerAdjust_ThermalMeter(struct net_device *dev, bool  bInCH14)\n{\n\tu32 TempVal;\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tTempVal = 0;\n\tif (!bInCH14) {\n\t\t \n\t\tTempVal =\tCCKSwingTable_Ch1_Ch13[priv->CCK_index][0] +\n\t\t\t\t\t(CCKSwingTable_Ch1_Ch13[priv->CCK_index][1]<<8);\n\t\trtl8192_setBBreg(dev, rCCK0_TxFilter1, bMaskHWord, TempVal);\n\t\tRT_TRACE(COMP_POWER_TRACKING, \"CCK not chnl 14, reg 0x%x = 0x%x\\n\",\n\t\t\trCCK0_TxFilter1, TempVal);\n\t\t \n\t\tTempVal =\tCCKSwingTable_Ch1_Ch13[priv->CCK_index][2] +\n\t\t\t\t\t(CCKSwingTable_Ch1_Ch13[priv->CCK_index][3]<<8) +\n\t\t\t\t\t(CCKSwingTable_Ch1_Ch13[priv->CCK_index][4]<<16)+\n\t\t\t\t\t(CCKSwingTable_Ch1_Ch13[priv->CCK_index][5]<<24);\n\t\trtl8192_setBBreg(dev, rCCK0_TxFilter2, bMaskDWord, TempVal);\n\t\tRT_TRACE(COMP_POWER_TRACKING, \"CCK not chnl 14, reg 0x%x = 0x%x\\n\",\n\t\t\trCCK0_TxFilter2, TempVal);\n\t\t \n\t\tTempVal =\tCCKSwingTable_Ch1_Ch13[priv->CCK_index][6] +\n\t\t\t\t\t(CCKSwingTable_Ch1_Ch13[priv->CCK_index][7]<<8);\n\n\t\trtl8192_setBBreg(dev, rCCK0_DebugPort, bMaskLWord, TempVal);\n\t\tRT_TRACE(COMP_POWER_TRACKING, \"CCK not chnl 14, reg 0x%x = 0x%x\\n\",\n\t\t\trCCK0_DebugPort, TempVal);\n\t} else {\n\t\t \n\t\tTempVal =\tCCKSwingTable_Ch14[priv->CCK_index][0] +\n\t\t\t\t\t(CCKSwingTable_Ch14[priv->CCK_index][1]<<8);\n\n\t\trtl8192_setBBreg(dev, rCCK0_TxFilter1, bMaskHWord, TempVal);\n\t\tRT_TRACE(COMP_POWER_TRACKING, \"CCK chnl 14, reg 0x%x = 0x%x\\n\",\n\t\t\t rCCK0_TxFilter1, TempVal);\n\t\t \n\t\tTempVal =\tCCKSwingTable_Ch14[priv->CCK_index][2] +\n\t\t\t\t\t(CCKSwingTable_Ch14[priv->CCK_index][3]<<8) +\n\t\t\t\t\t(CCKSwingTable_Ch14[priv->CCK_index][4]<<16)+\n\t\t\t\t\t(CCKSwingTable_Ch14[priv->CCK_index][5]<<24);\n\t\trtl8192_setBBreg(dev, rCCK0_TxFilter2, bMaskDWord, TempVal);\n\t\tRT_TRACE(COMP_POWER_TRACKING, \"CCK chnl 14, reg 0x%x = 0x%x\\n\",\n\t\t\t rCCK0_TxFilter2, TempVal);\n\t\t \n\t\tTempVal =\tCCKSwingTable_Ch14[priv->CCK_index][6] +\n\t\t\t\t\t(CCKSwingTable_Ch14[priv->CCK_index][7]<<8);\n\n\t\trtl8192_setBBreg(dev, rCCK0_DebugPort, bMaskLWord, TempVal);\n\t\tRT_TRACE(COMP_POWER_TRACKING, \"CCK chnl 14, reg 0x%x = 0x%x\\n\",\n\t\t\t rCCK0_DebugPort, TempVal);\n\t}\n}\n\nvoid dm_cck_txpower_adjust(struct net_device *dev, bool binch14)\n{\t \n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tif (priv->bDcut)\n\t\tdm_CCKTxPowerAdjust_TSSI(dev, binch14);\n\telse\n\t\tdm_CCKTxPowerAdjust_ThermalMeter(dev, binch14);\n}\n\n#ifndef RTL8192U\nstatic void dm_txpower_reset_recovery(\n\tstruct net_device *dev\n)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tRT_TRACE(COMP_POWER_TRACKING, \"Start Reset Recovery ==>\\n\");\n\trtl8192_setBBreg(dev, rOFDM0_XATxIQImbalance, bMaskDWord, priv->txbbgain_table[priv->rfa_txpowertrackingindex].txbbgain_value);\n\tRT_TRACE(COMP_POWER_TRACKING, \"Reset Recovery: Fill in 0xc80 is %08x\\n\", priv->txbbgain_table[priv->rfa_txpowertrackingindex].txbbgain_value);\n\tRT_TRACE(COMP_POWER_TRACKING, \"Reset Recovery: Fill in RFA_txPowerTrackingIndex is %x\\n\", priv->rfa_txpowertrackingindex);\n\tRT_TRACE(COMP_POWER_TRACKING, \"Reset Recovery : RF A I/Q Amplify Gain is %ld\\n\", priv->txbbgain_table[priv->rfa_txpowertrackingindex].txbb_iq_amplifygain);\n\tRT_TRACE(COMP_POWER_TRACKING, \"Reset Recovery: CCK Attenuation is %d dB\\n\", priv->cck_present_attenuation);\n\tdm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\n\n\trtl8192_setBBreg(dev, rOFDM0_XCTxIQImbalance, bMaskDWord, priv->txbbgain_table[priv->rfc_txpowertrackingindex].txbbgain_value);\n\tRT_TRACE(COMP_POWER_TRACKING, \"Reset Recovery: Fill in 0xc90 is %08x\\n\", priv->txbbgain_table[priv->rfc_txpowertrackingindex].txbbgain_value);\n\tRT_TRACE(COMP_POWER_TRACKING, \"Reset Recovery: Fill in RFC_txPowerTrackingIndex is %x\\n\", priv->rfc_txpowertrackingindex);\n\tRT_TRACE(COMP_POWER_TRACKING, \"Reset Recovery : RF C I/Q Amplify Gain is %ld\\n\", priv->txbbgain_table[priv->rfc_txpowertrackingindex].txbb_iq_amplifygain);\n\n}\t \n\nvoid dm_restore_dynamic_mechanism_state(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tu32\treg_ratr = priv->rate_adaptive.last_ratr;\n\n\tif (!priv->up) {\n\t\tRT_TRACE(COMP_RATE, \"<---- dm_restore_dynamic_mechanism_state(): driver is going to unload\\n\");\n\t\treturn;\n\t}\n\n\t \n\tif (priv->rate_adaptive.rate_adaptive_disabled)\n\t\treturn;\n\t \n\tif (!(priv->ieee80211->mode == WIRELESS_MODE_N_24G ||\n\t      priv->ieee80211->mode == WIRELESS_MODE_N_5G))\n\t\treturn;\n\n\t{\n\t\t\t \n\t\t\tu32 ratr_value;\n\n\t\t\tratr_value = reg_ratr;\n\t\t\tif (priv->rf_type == RF_1T2R) {\t \n\t\t\t\tratr_value &= ~(RATE_ALL_OFDM_2SS);\n\t\t\t}\n\t\t\twrite_nic_dword(dev, RATR0, ratr_value);\n\t\t\twrite_nic_byte(dev, UFWP, 1);\n\t}\n\t \n\tif (priv->btxpower_trackingInit && priv->btxpower_tracking)\n\t\tdm_txpower_reset_recovery(dev);\n\n\t \n\tdm_bb_initialgain_restore(dev);\n\n}\t \n\nstatic void dm_bb_initialgain_restore(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tu32 bit_mask = 0x7f;  \n\n\tif (dm_digtable.dig_algorithm == DIG_ALGO_BY_RSSI)\n\t\treturn;\n\n\t \n\trtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x8);\t \n\trtl8192_setBBreg(dev, rOFDM0_XAAGCCore1, bit_mask, (u32)priv->initgain_backup.xaagccore1);\n\trtl8192_setBBreg(dev, rOFDM0_XBAGCCore1, bit_mask, (u32)priv->initgain_backup.xbagccore1);\n\trtl8192_setBBreg(dev, rOFDM0_XCAGCCore1, bit_mask, (u32)priv->initgain_backup.xcagccore1);\n\trtl8192_setBBreg(dev, rOFDM0_XDAGCCore1, bit_mask, (u32)priv->initgain_backup.xdagccore1);\n\tbit_mask  = bMaskByte2;\n\trtl8192_setBBreg(dev, rCCK0_CCA, bit_mask, (u32)priv->initgain_backup.cca);\n\n\tRT_TRACE(COMP_DIG, \"dm_BBInitialGainRestore 0xc50 is %x\\n\", priv->initgain_backup.xaagccore1);\n\tRT_TRACE(COMP_DIG, \"dm_BBInitialGainRestore 0xc58 is %x\\n\", priv->initgain_backup.xbagccore1);\n\tRT_TRACE(COMP_DIG, \"dm_BBInitialGainRestore 0xc60 is %x\\n\", priv->initgain_backup.xcagccore1);\n\tRT_TRACE(COMP_DIG, \"dm_BBInitialGainRestore 0xc68 is %x\\n\", priv->initgain_backup.xdagccore1);\n\tRT_TRACE(COMP_DIG, \"dm_BBInitialGainRestore 0xa0a is %x\\n\", priv->initgain_backup.cca);\n\t \n\trtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x1);\t \n\n}\t \n\nstatic void dm_bb_initialgain_backup(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tu32 bit_mask = bMaskByte0;  \n\n\tif (dm_digtable.dig_algorithm == DIG_ALGO_BY_RSSI)\n\t\treturn;\n\n\trtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x8);\t \n\tpriv->initgain_backup.xaagccore1 = (u8)rtl8192_QueryBBReg(dev, rOFDM0_XAAGCCore1, bit_mask);\n\tpriv->initgain_backup.xbagccore1 = (u8)rtl8192_QueryBBReg(dev, rOFDM0_XBAGCCore1, bit_mask);\n\tpriv->initgain_backup.xcagccore1 = (u8)rtl8192_QueryBBReg(dev, rOFDM0_XCAGCCore1, bit_mask);\n\tpriv->initgain_backup.xdagccore1 = (u8)rtl8192_QueryBBReg(dev, rOFDM0_XDAGCCore1, bit_mask);\n\tbit_mask  = bMaskByte2;\n\tpriv->initgain_backup.cca = (u8)rtl8192_QueryBBReg(dev, rCCK0_CCA, bit_mask);\n\n\tRT_TRACE(COMP_DIG, \"BBInitialGainBackup 0xc50 is %x\\n\", priv->initgain_backup.xaagccore1);\n\tRT_TRACE(COMP_DIG, \"BBInitialGainBackup 0xc58 is %x\\n\", priv->initgain_backup.xbagccore1);\n\tRT_TRACE(COMP_DIG, \"BBInitialGainBackup 0xc60 is %x\\n\", priv->initgain_backup.xcagccore1);\n\tRT_TRACE(COMP_DIG, \"BBInitialGainBackup 0xc68 is %x\\n\", priv->initgain_backup.xdagccore1);\n\tRT_TRACE(COMP_DIG, \"BBInitialGainBackup 0xa0a is %x\\n\", priv->initgain_backup.cca);\n\n}    \n\n#endif\n \nstatic void dm_dig_init(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\t \n\tdm_digtable.dig_enable_flag\t= true;\n\tdm_digtable.dig_algorithm = DIG_ALGO_BY_RSSI;\n\tdm_digtable.dig_algorithm_switch = 0;\n\n\t \n\tdm_digtable.dig_state\t\t= DM_STA_DIG_MAX;\n\tdm_digtable.dig_highpwr_state\t= DM_STA_DIG_MAX;\n\n\tdm_digtable.rssi_low_thresh\t= DM_DIG_THRESH_LOW;\n\tdm_digtable.rssi_high_thresh\t= DM_DIG_THRESH_HIGH;\n\n\tdm_digtable.rssi_high_power_lowthresh = DM_DIG_HIGH_PWR_THRESH_LOW;\n\tdm_digtable.rssi_high_power_highthresh = DM_DIG_HIGH_PWR_THRESH_HIGH;\n\n\tdm_digtable.rssi_val = 50;\t \n\tdm_digtable.backoff_val = DM_DIG_BACKOFF;\n\tif (priv->CustomerID == RT_CID_819x_Netcore)\n\t\tdm_digtable.rx_gain_range_min = DM_DIG_MIN_NETCORE;\n\telse\n\t\tdm_digtable.rx_gain_range_min = DM_DIG_MIN;\n\n}\t \n\n \nstatic void dm_ctrl_initgain_byrssi(struct net_device *dev)\n{\n\tif (!dm_digtable.dig_enable_flag)\n\t\treturn;\n\n\tif (dm_digtable.dig_algorithm == DIG_ALGO_BY_FALSE_ALARM)\n\t\tdm_ctrl_initgain_byrssi_by_fwfalse_alarm(dev);\n\telse if (dm_digtable.dig_algorithm == DIG_ALGO_BY_RSSI)\n\t\tdm_ctrl_initgain_byrssi_by_driverrssi(dev);\n\t \n\telse\n\t\treturn;\n}\n\nstatic void dm_ctrl_initgain_byrssi_by_driverrssi(\n\tstruct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tu8 i;\n\tstatic u8\tfw_dig;\n\n\tif (!dm_digtable.dig_enable_flag)\n\t\treturn;\n\n\tif (dm_digtable.dig_algorithm_switch)\t \n\t\tfw_dig = 0;\n\n\tif (fw_dig <= 3) {  \n\t\t \n\t\tfor (i = 0; i < 3; i++)\n\t\t\trtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x8);\t \n\t\tfw_dig++;\n\t\tdm_digtable.dig_state = DM_STA_DIG_OFF;\t \n\t}\n\n\tif (priv->ieee80211->state == IEEE80211_LINKED)\n\t\tdm_digtable.cur_connect_state = DIG_CONNECT;\n\telse\n\t\tdm_digtable.cur_connect_state = DIG_DISCONNECT;\n\n\tdm_digtable.rssi_val = priv->undecorated_smoothed_pwdb;\n\tdm_initial_gain(dev);\n\tdm_pd_th(dev);\n\tdm_cs_ratio(dev);\n\tif (dm_digtable.dig_algorithm_switch)\n\t\tdm_digtable.dig_algorithm_switch = 0;\n\tdm_digtable.pre_connect_state = dm_digtable.cur_connect_state;\n\n}\t \n\nstatic void dm_ctrl_initgain_byrssi_by_fwfalse_alarm(\n\tstruct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tstatic u32 reset_cnt;\n\tu8 i;\n\n\tif (!dm_digtable.dig_enable_flag)\n\t\treturn;\n\n\tif (dm_digtable.dig_algorithm_switch) {\n\t\tdm_digtable.dig_state = DM_STA_DIG_MAX;\n\t\t \n\t\tfor (i = 0; i < 3; i++)\n\t\t\trtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x1);\t \n\t\tdm_digtable.dig_algorithm_switch = 0;\n\t}\n\n\tif (priv->ieee80211->state != IEEE80211_LINKED)\n\t\treturn;\n\n\t \n\tif ((priv->undecorated_smoothed_pwdb > dm_digtable.rssi_low_thresh) &&\n\t    (priv->undecorated_smoothed_pwdb < dm_digtable.rssi_high_thresh))\n\t\treturn;\n\n\t \n\tif (priv->undecorated_smoothed_pwdb <= dm_digtable.rssi_low_thresh) {\n\t\t \n\t\tif (dm_digtable.dig_state == DM_STA_DIG_OFF &&\n\t\t    (priv->reset_count == reset_cnt)) {\n\t\t\treturn;\n\t\t}\n\t\treset_cnt = priv->reset_count;\n\n\t\t \n\t\tdm_digtable.dig_highpwr_state = DM_STA_DIG_MAX;\n\t\tdm_digtable.dig_state = DM_STA_DIG_OFF;\n\n\t\t \n\t\trtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x8);\t \n\n\t\t \n\t\twrite_nic_byte(dev, rOFDM0_XAAGCCore1, 0x17);\n\t\twrite_nic_byte(dev, rOFDM0_XBAGCCore1, 0x17);\n\t\twrite_nic_byte(dev, rOFDM0_XCAGCCore1, 0x17);\n\t\twrite_nic_byte(dev, rOFDM0_XDAGCCore1, 0x17);\n\n\t\t \n\t\tif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\n\t\t\t \n\t\t\twrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x00);\n\t\t} else\n\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector1, 0x42);\n\n\t\t \n\t\twrite_nic_byte(dev, 0xa0a, 0x08);\n\n\t\t \n\t\treturn;\n\t}\n\n\t \n\tif (priv->undecorated_smoothed_pwdb >= dm_digtable.rssi_high_thresh) {\n\t\tu8 reset_flag = 0;\n\n\t\tif (dm_digtable.dig_state == DM_STA_DIG_ON &&\n\t\t    (priv->reset_count == reset_cnt)) {\n\t\t\tdm_ctrl_initgain_byrssi_highpwr(dev);\n\t\t\treturn;\n\t\t}\n\t\tif (priv->reset_count != reset_cnt)\n\t\t\treset_flag = 1;\n\n\t\treset_cnt = priv->reset_count;\n\n\t\tdm_digtable.dig_state = DM_STA_DIG_ON;\n\n\t\t \n\t\tif (reset_flag == 1) {\n\t\t\twrite_nic_byte(dev, rOFDM0_XAAGCCore1, 0x2c);\n\t\t\twrite_nic_byte(dev, rOFDM0_XBAGCCore1, 0x2c);\n\t\t\twrite_nic_byte(dev, rOFDM0_XCAGCCore1, 0x2c);\n\t\t\twrite_nic_byte(dev, rOFDM0_XDAGCCore1, 0x2c);\n\t\t} else {\n\t\t\twrite_nic_byte(dev, rOFDM0_XAAGCCore1, 0x20);\n\t\t\twrite_nic_byte(dev, rOFDM0_XBAGCCore1, 0x20);\n\t\t\twrite_nic_byte(dev, rOFDM0_XCAGCCore1, 0x20);\n\t\t\twrite_nic_byte(dev, rOFDM0_XDAGCCore1, 0x20);\n\t\t}\n\n\t\t \n\t\tif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\n\t\t\t \n\t\t\twrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x20);\n\t\t} else\n\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector1, 0x44);\n\n\t\t \n\t\twrite_nic_byte(dev, 0xa0a, 0xcd);\n\n\t\t \n\n\t\t \n\t\trtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x1);\t \n\t}\n\n\tdm_ctrl_initgain_byrssi_highpwr(dev);\n\n}\t \n\n \nstatic void dm_ctrl_initgain_byrssi_highpwr(\n\tstruct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tstatic u32 reset_cnt_highpwr;\n\n\t \n\tif ((priv->undecorated_smoothed_pwdb > dm_digtable.rssi_high_power_lowthresh) &&\n\t\t(priv->undecorated_smoothed_pwdb < dm_digtable.rssi_high_power_highthresh))\n\t\treturn;\n\n\t \n\tif (priv->undecorated_smoothed_pwdb >= dm_digtable.rssi_high_power_highthresh) {\n\t\tif (dm_digtable.dig_highpwr_state == DM_STA_DIG_ON &&\n\t\t    (priv->reset_count == reset_cnt_highpwr))\n\t\t\treturn;\n\t\tdm_digtable.dig_highpwr_state = DM_STA_DIG_ON;\n\n\t\t \n\t\tif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\n\t\t\twrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x10);\n\t\t} else\n\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector1, 0x43);\n\t} else {\n\t\tif (dm_digtable.dig_highpwr_state == DM_STA_DIG_OFF &&\n\t\t    (priv->reset_count == reset_cnt_highpwr))\n\t\t\treturn;\n\t\tdm_digtable.dig_highpwr_state = DM_STA_DIG_OFF;\n\n\t\tif (priv->undecorated_smoothed_pwdb < dm_digtable.rssi_high_power_lowthresh &&\n\t\t\t priv->undecorated_smoothed_pwdb >= dm_digtable.rssi_high_thresh) {\n\t\t\t \n\t\t\tif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\n\t\t\t\twrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x20);\n\t\t\t} else\n\t\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector1, 0x44);\n\t\t}\n\t}\n\n\treset_cnt_highpwr = priv->reset_count;\n\n}\t \n\nstatic void dm_initial_gain(\n\tstruct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tu8\t\t\t\t\tinitial_gain = 0;\n\tstatic u8\t\t\t\tinitialized, force_write;\n\tstatic u32\t\t\treset_cnt;\n\tu8\t\t\t\ttmp;\n\n\tif (dm_digtable.dig_algorithm_switch) {\n\t\tinitialized = 0;\n\t\treset_cnt = 0;\n\t}\n\n\tif (dm_digtable.pre_connect_state == dm_digtable.cur_connect_state) {\n\t\tif (dm_digtable.cur_connect_state == DIG_CONNECT) {\n\t\t\tif ((dm_digtable.rssi_val + 10 - dm_digtable.backoff_val) > DM_DIG_MAX)\n\t\t\t\tdm_digtable.cur_ig_value = DM_DIG_MAX;\n\t\t\telse if ((dm_digtable.rssi_val+10-dm_digtable.backoff_val) < dm_digtable.rx_gain_range_min)\n\t\t\t\tdm_digtable.cur_ig_value = dm_digtable.rx_gain_range_min;\n\t\t\telse\n\t\t\t\tdm_digtable.cur_ig_value = dm_digtable.rssi_val+10-dm_digtable.backoff_val;\n\t\t} else {\t \n\t\t\tif (dm_digtable.cur_ig_value == 0)\n\t\t\t\tdm_digtable.cur_ig_value = priv->DefaultInitialGain[0];\n\t\t\telse\n\t\t\t\tdm_digtable.cur_ig_value = dm_digtable.pre_ig_value;\n\t\t}\n\t} else {  \n\t\tdm_digtable.cur_ig_value = priv->DefaultInitialGain[0];\n\t\tdm_digtable.pre_ig_value = 0;\n\t}\n\n\t \n\tif (priv->reset_count != reset_cnt) {\n\t\tforce_write = 1;\n\t\treset_cnt = priv->reset_count;\n\t}\n\n\tread_nic_byte(dev, rOFDM0_XAAGCCore1, &tmp);\n\tif (dm_digtable.pre_ig_value != tmp)\n\t\tforce_write = 1;\n\n\t{\n\t\tif ((dm_digtable.pre_ig_value != dm_digtable.cur_ig_value)\n\t\t\t|| !initialized || force_write) {\n\t\t\tinitial_gain = (u8)dm_digtable.cur_ig_value;\n\t\t\t \n\t\t\twrite_nic_byte(dev, rOFDM0_XAAGCCore1, initial_gain);\n\t\t\twrite_nic_byte(dev, rOFDM0_XBAGCCore1, initial_gain);\n\t\t\twrite_nic_byte(dev, rOFDM0_XCAGCCore1, initial_gain);\n\t\t\twrite_nic_byte(dev, rOFDM0_XDAGCCore1, initial_gain);\n\t\t\tdm_digtable.pre_ig_value = dm_digtable.cur_ig_value;\n\t\t\tinitialized = 1;\n\t\t\tforce_write = 0;\n\t\t}\n\t}\n}\n\nstatic void dm_pd_th(\n\tstruct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tstatic u8\t\t\t\tinitialized, force_write;\n\tstatic u32\t\t\treset_cnt;\n\n\tif (dm_digtable.dig_algorithm_switch) {\n\t\tinitialized = 0;\n\t\treset_cnt = 0;\n\t}\n\n\tif (dm_digtable.pre_connect_state == dm_digtable.cur_connect_state) {\n\t\tif (dm_digtable.cur_connect_state == DIG_CONNECT) {\n\t\t\tif (dm_digtable.rssi_val >= dm_digtable.rssi_high_power_highthresh)\n\t\t\t\tdm_digtable.curpd_thstate = DIG_PD_AT_HIGH_POWER;\n\t\t\telse if (dm_digtable.rssi_val <= dm_digtable.rssi_low_thresh)\n\t\t\t\tdm_digtable.curpd_thstate = DIG_PD_AT_LOW_POWER;\n\t\t\telse if ((dm_digtable.rssi_val >= dm_digtable.rssi_high_thresh) &&\n\t\t\t\t\t(dm_digtable.rssi_val < dm_digtable.rssi_high_power_lowthresh))\n\t\t\t\tdm_digtable.curpd_thstate = DIG_PD_AT_NORMAL_POWER;\n\t\t\telse\n\t\t\t\tdm_digtable.curpd_thstate = dm_digtable.prepd_thstate;\n\t\t} else {\n\t\t\tdm_digtable.curpd_thstate = DIG_PD_AT_LOW_POWER;\n\t\t}\n\t} else {  \n\t\tdm_digtable.curpd_thstate = DIG_PD_AT_LOW_POWER;\n\t}\n\n\t \n\tif (priv->reset_count != reset_cnt) {\n\t\tforce_write = 1;\n\t\treset_cnt = priv->reset_count;\n\t}\n\n\t{\n\t\tif ((dm_digtable.prepd_thstate != dm_digtable.curpd_thstate) ||\n\t\t    (initialized <= 3) || force_write) {\n\t\t\tif (dm_digtable.curpd_thstate == DIG_PD_AT_LOW_POWER) {\n\t\t\t\t \n\t\t\t\tif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\n\t\t\t\t\t \n\t\t\t\t\twrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x00);\n\t\t\t\t} else\n\t\t\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector1, 0x42);\n\t\t\t} else if (dm_digtable.curpd_thstate == DIG_PD_AT_NORMAL_POWER) {\n\t\t\t\t \n\t\t\t\tif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\n\t\t\t\t\t \n\t\t\t\t\twrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x20);\n\t\t\t\t} else\n\t\t\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector1, 0x44);\n\t\t\t} else if (dm_digtable.curpd_thstate == DIG_PD_AT_HIGH_POWER) {\n\t\t\t\t \n\t\t\t\tif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\n\t\t\t\t\twrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x10);\n\t\t\t\t} else\n\t\t\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector1, 0x43);\n\t\t\t}\n\t\t\tdm_digtable.prepd_thstate = dm_digtable.curpd_thstate;\n\t\t\tif (initialized <= 3)\n\t\t\t\tinitialized++;\n\t\t\tforce_write = 0;\n\t\t}\n\t}\n}\n\nstatic\tvoid dm_cs_ratio(\n\tstruct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tstatic u8\t\t\t\tinitialized, force_write;\n\tstatic u32\t\t\treset_cnt;\n\n\tif (dm_digtable.dig_algorithm_switch) {\n\t\tinitialized = 0;\n\t\treset_cnt = 0;\n\t}\n\n\tif (dm_digtable.pre_connect_state == dm_digtable.cur_connect_state) {\n\t\tif (dm_digtable.cur_connect_state == DIG_CONNECT) {\n\t\t\tif (dm_digtable.rssi_val <= dm_digtable.rssi_low_thresh)\n\t\t\t\tdm_digtable.curcs_ratio_state = DIG_CS_RATIO_LOWER;\n\t\t\telse if (dm_digtable.rssi_val >= dm_digtable.rssi_high_thresh)\n\t\t\t\tdm_digtable.curcs_ratio_state = DIG_CS_RATIO_HIGHER;\n\t\t\telse\n\t\t\t\tdm_digtable.curcs_ratio_state = dm_digtable.precs_ratio_state;\n\t\t} else {\n\t\t\tdm_digtable.curcs_ratio_state = DIG_CS_RATIO_LOWER;\n\t\t}\n\t} else\t \n\t\tdm_digtable.curcs_ratio_state = DIG_CS_RATIO_LOWER;\n\n\t \n\tif (priv->reset_count != reset_cnt) {\n\t\tforce_write = 1;\n\t\treset_cnt = priv->reset_count;\n\t}\n\n\t{\n\t\tif ((dm_digtable.precs_ratio_state != dm_digtable.curcs_ratio_state) ||\n\t\t    !initialized || force_write) {\n\t\t\tif (dm_digtable.curcs_ratio_state == DIG_CS_RATIO_LOWER) {\n\t\t\t\t \n\t\t\t\twrite_nic_byte(dev, 0xa0a, 0x08);\n\t\t\t} else if (dm_digtable.curcs_ratio_state == DIG_CS_RATIO_HIGHER) {\n\t\t\t\t \n\t\t\t\twrite_nic_byte(dev, 0xa0a, 0xcd);\n\t\t\t}\n\t\t\tdm_digtable.precs_ratio_state = dm_digtable.curcs_ratio_state;\n\t\t\tinitialized = 1;\n\t\t\tforce_write = 0;\n\t\t}\n\t}\n}\n\nvoid dm_init_edca_turbo(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tpriv->bcurrent_turbo_EDCA = false;\n\tpriv->ieee80211->bis_any_nonbepkts = false;\n\tpriv->bis_cur_rdlstate = false;\n}\t \n\nstatic void dm_check_edca_turbo(\n\tstruct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tPRT_HIGH_THROUGHPUT\tpHTInfo = priv->ieee80211->pHTInfo;\n\n\t \n\tstatic unsigned long\t\t\tlastTxOkCnt;\n\tstatic unsigned long\t\t\tlastRxOkCnt;\n\tunsigned long\t\t\t\tcurTxOkCnt = 0;\n\tunsigned long\t\t\t\tcurRxOkCnt = 0;\n\n\t \n\tif (priv->ieee80211->state != IEEE80211_LINKED)\n\t\tgoto dm_CheckEdcaTurbo_EXIT;\n\t \n\tif (priv->ieee80211->pHTInfo->IOTAction & HT_IOT_ACT_DISABLE_EDCA_TURBO)\n\t\tgoto dm_CheckEdcaTurbo_EXIT;\n\n\tif (!priv->ieee80211->bis_any_nonbepkts) {\n\t\tcurTxOkCnt = priv->stats.txbytesunicast - lastTxOkCnt;\n\t\tcurRxOkCnt = priv->stats.rxbytesunicast - lastRxOkCnt;\n\t\t \n\t\tif (curRxOkCnt > 4*curTxOkCnt) {\n\t\t\tif (!priv->bis_cur_rdlstate || !priv->bcurrent_turbo_EDCA) {\n\t\t\t\twrite_nic_dword(dev, EDCAPARA_BE, edca_setting_DL[pHTInfo->IOTPeer]);\n\t\t\t\tpriv->bis_cur_rdlstate = true;\n\t\t\t}\n\t\t} else {\n\t\t\tif (priv->bis_cur_rdlstate || !priv->bcurrent_turbo_EDCA) {\n\t\t\t\twrite_nic_dword(dev, EDCAPARA_BE, edca_setting_UL[pHTInfo->IOTPeer]);\n\t\t\t\tpriv->bis_cur_rdlstate = false;\n\t\t\t}\n\t\t}\n\n\t\tpriv->bcurrent_turbo_EDCA = true;\n\t} else {\n\t\t \n\t\tif (priv->bcurrent_turbo_EDCA) {\n\t\t\tu8\tu1bAIFS;\n\t\t\tu32\tu4bAcParam, op_limit, cw_max, cw_min;\n\n\t\t\tstruct ieee80211_qos_parameters *qos_parameters = &priv->ieee80211->current_network.qos_data.parameters;\n\t\t\tu8 mode = priv->ieee80211->mode;\n\n\t\t\t \n\t\t\tdm_init_edca_turbo(dev);\n\n\t\t\tu1bAIFS = qos_parameters->aifs[0] * ((mode & (IEEE_G | IEEE_N_24G)) ? 9 : 20) + aSifsTime;\n\n\t\t\top_limit = (u32)le16_to_cpu(qos_parameters->tx_op_limit[0]);\n\t\t\tcw_max   = (u32)le16_to_cpu(qos_parameters->cw_max[0]);\n\t\t\tcw_min   = (u32)le16_to_cpu(qos_parameters->cw_min[0]);\n\n\t\t\top_limit <<= AC_PARAM_TXOP_LIMIT_OFFSET;\n\t\t\tcw_max   <<= AC_PARAM_ECW_MAX_OFFSET;\n\t\t\tcw_min   <<= AC_PARAM_ECW_MIN_OFFSET;\n\t\t\tu1bAIFS  <<= AC_PARAM_AIFS_OFFSET;\n\n\t\t\tu4bAcParam = op_limit | cw_max | cw_min | u1bAIFS;\n\t\t\tcpu_to_le32s(&u4bAcParam);\n\n\t\t\twrite_nic_dword(dev, EDCAPARA_BE, u4bAcParam);\n\n\t\t\t \n\t\t\t{\n\t\t\t\t \n\n\t\t\t\tstruct aci_aifsn *pAciAifsn = (struct aci_aifsn *)&(qos_parameters->aifs[0]);\n\t\t\t\tu8\t\tAcmCtrl;\n\n\t\t\t\tread_nic_byte(dev, AcmHwCtrl, &AcmCtrl);\n\n\t\t\t\tif (pAciAifsn->acm) {  \n\t\t\t\t\tAcmCtrl |= AcmHw_BeqEn;\n\t\t\t\t} else {\t \n\t\t\t\t\tAcmCtrl &= (~AcmHw_BeqEn);\n\t\t\t\t}\n\n\t\t\t\tRT_TRACE(COMP_QOS, \"SetHwReg8190pci(): [HW_VAR_ACM_CTRL] Write 0x%X\\n\", AcmCtrl);\n\t\t\t\twrite_nic_byte(dev, AcmHwCtrl, AcmCtrl);\n\t\t\t}\n\t\t\tpriv->bcurrent_turbo_EDCA = false;\n\t\t}\n\t}\n\ndm_CheckEdcaTurbo_EXIT:\n\t \n\tpriv->ieee80211->bis_any_nonbepkts = false;\n\tlastTxOkCnt = priv->stats.txbytesunicast;\n\tlastRxOkCnt = priv->stats.rxbytesunicast;\n}\t \n\nstatic void dm_init_ctstoself(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tpriv->ieee80211->bCTSToSelfEnable = true;\n\tpriv->ieee80211->CTSToSelfTH = CTS_TO_SELF_TH_VAL;\n}\n\nstatic void dm_ctstoself(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tPRT_HIGH_THROUGHPUT\tpHTInfo = priv->ieee80211->pHTInfo;\n\tstatic unsigned long\t\t\t\tlastTxOkCnt;\n\tstatic unsigned long\t\t\t\tlastRxOkCnt;\n\tunsigned long\t\t\t\t\t\tcurTxOkCnt = 0;\n\tunsigned long\t\t\t\t\t\tcurRxOkCnt = 0;\n\n\tif (!priv->ieee80211->bCTSToSelfEnable) {\n\t\tpHTInfo->IOTAction &= ~HT_IOT_ACT_FORCED_CTS2SELF;\n\t\treturn;\n\t}\n\t \n\n\tif (pHTInfo->IOTPeer == HT_IOT_PEER_BROADCOM) {\n\t\tcurTxOkCnt = priv->stats.txbytesunicast - lastTxOkCnt;\n\t\tcurRxOkCnt = priv->stats.rxbytesunicast - lastRxOkCnt;\n\t\tif (curRxOkCnt > 4*curTxOkCnt) {  \n\t\t\tpHTInfo->IOTAction &= ~HT_IOT_ACT_FORCED_CTS2SELF;\n\t\t} else {  \n\t\t\tpHTInfo->IOTAction |= HT_IOT_ACT_FORCED_CTS2SELF;\n\t\t}\n\n\t\tlastTxOkCnt = priv->stats.txbytesunicast;\n\t\tlastRxOkCnt = priv->stats.rxbytesunicast;\n\t}\n}\n\n \nstatic\tvoid\tdm_check_pbc_gpio(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tu8 tmp1byte;\n\n\tread_nic_byte(dev, GPI, &tmp1byte);\n\tif (tmp1byte == 0xff)\n\t\treturn;\n\n\tif (tmp1byte & BIT(6) || tmp1byte & BIT(0)) {\n\t\t \n\t\tRT_TRACE(COMP_IO, \"CheckPbcGPIO - PBC is pressed\\n\");\n\t\tpriv->bpbc_pressed = true;\n\t}\n}\n\n \nvoid dm_rf_pathcheck_workitemcallback(struct work_struct *work)\n{\n\tstruct delayed_work *dwork = to_delayed_work(work);\n\tstruct r8192_priv *priv = container_of(dwork, struct r8192_priv, rfpath_check_wq);\n\tstruct net_device *dev = priv->ieee80211->dev;\n\tu8 rfpath = 0, i;\n\n\t \n\tread_nic_byte(dev, 0xc04, &rfpath);\n\n\t \n\tfor (i = 0; i < RF90_PATH_MAX; i++) {\n\t\tif (rfpath & (0x01<<i))\n\t\t\tpriv->brfpath_rxenable[i] = true;\n\t\telse\n\t\t\tpriv->brfpath_rxenable[i] = false;\n\t}\n\n\tdm_rxpath_sel_byrssi(dev);\n}\t \n\nstatic void dm_init_rxpath_selection(struct net_device *dev)\n{\n\tu8 i;\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tif (priv->CustomerID == RT_CID_819x_Netcore)\n\t\tDM_RxPathSelTable.cck_method = CCK_RX_VERSION_2;\n\telse\n\t\tDM_RxPathSelTable.cck_method = CCK_RX_VERSION_1;\n\tDM_RxPathSelTable.disabled_rf = 0;\n\tfor (i = 0; i < 4; i++) {\n\t\tDM_RxPathSelTable.rf_rssi[i] = 50;\n\t\tDM_RxPathSelTable.cck_pwdb_sta[i] = -64;\n\t\tDM_RxPathSelTable.rf_enable_rssi_th[i] = 100;\n\t}\n}\n\nstatic void dm_rxpath_sel_byrssi(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tu8\t\t\t\ti, max_rssi_index = 0, min_rssi_index = 0, sec_rssi_index = 0, rf_num = 0;\n\tu8\t\t\t\ttmp_max_rssi = 0, tmp_min_rssi = 0, tmp_sec_rssi = 0;\n\tu8\t\t\t\tcck_default_Rx = 0x2;   \n\tu8\t\t\t\tcck_optional_Rx = 0x3;  \n\tlong\t\t\t\ttmp_cck_max_pwdb = 0, tmp_cck_min_pwdb = 0, tmp_cck_sec_pwdb = 0;\n\tu8\t\t\t\tcck_rx_ver2_max_index = 0, cck_rx_ver2_min_index = 0, cck_rx_ver2_sec_index = 0;\n\tu8\t\t\t\tcur_rf_rssi;\n\tlong\t\t\t\tcur_cck_pwdb;\n\tstatic u8\t\t\tdisabled_rf_cnt, cck_Rx_Path_initialized;\n\tu8\t\t\t\tupdate_cck_rx_path;\n\n\tif (priv->rf_type != RF_2T4R)\n\t\treturn;\n\n\tif (!cck_Rx_Path_initialized) {\n\t\tread_nic_byte(dev, 0xa07, &DM_RxPathSelTable.cck_rx_path);\n\t\tDM_RxPathSelTable.cck_rx_path &= 0xf;\n\t\tcck_Rx_Path_initialized = 1;\n\t}\n\n\tread_nic_byte(dev, 0xc04, &DM_RxPathSelTable.disabled_rf);\n\tDM_RxPathSelTable.disabled_rf = ~DM_RxPathSelTable.disabled_rf & 0xf;\n\n\tif (priv->ieee80211->mode == WIRELESS_MODE_B) {\n\t\tDM_RxPathSelTable.cck_method = CCK_RX_VERSION_2;\t \n\t}\n\n\t \n\tfor (i = 0; i < RF90_PATH_MAX; i++) {\n\t\tDM_RxPathSelTable.rf_rssi[i] = priv->stats.rx_rssi_percentage[i];\n\n\t\tif (priv->brfpath_rxenable[i]) {\n\t\t\trf_num++;\n\t\t\tcur_rf_rssi = DM_RxPathSelTable.rf_rssi[i];\n\n\t\t\tif (rf_num == 1) {  \n\t\t\t\t \n\t\t\t\tmax_rssi_index = min_rssi_index = sec_rssi_index = i;\n\t\t\t\ttmp_max_rssi = tmp_min_rssi = tmp_sec_rssi = cur_rf_rssi;\n\t\t\t} else if (rf_num == 2) {  \n\t\t\t\tif (cur_rf_rssi >= tmp_max_rssi) {\n\t\t\t\t\ttmp_max_rssi = cur_rf_rssi;\n\t\t\t\t\tmax_rssi_index = i;\n\t\t\t\t} else {\n\t\t\t\t\ttmp_sec_rssi = tmp_min_rssi = cur_rf_rssi;\n\t\t\t\t\tsec_rssi_index = min_rssi_index = i;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (cur_rf_rssi > tmp_max_rssi) {\n\t\t\t\t\ttmp_sec_rssi = tmp_max_rssi;\n\t\t\t\t\tsec_rssi_index = max_rssi_index;\n\t\t\t\t\ttmp_max_rssi = cur_rf_rssi;\n\t\t\t\t\tmax_rssi_index = i;\n\t\t\t\t} else if (cur_rf_rssi == tmp_max_rssi) {\t \n\t\t\t\t\ttmp_sec_rssi = cur_rf_rssi;\n\t\t\t\t\tsec_rssi_index = i;\n\t\t\t\t} else if ((cur_rf_rssi < tmp_max_rssi) && (cur_rf_rssi > tmp_sec_rssi)) {\n\t\t\t\t\ttmp_sec_rssi = cur_rf_rssi;\n\t\t\t\t\tsec_rssi_index = i;\n\t\t\t\t} else if (cur_rf_rssi == tmp_sec_rssi) {\n\t\t\t\t\tif (tmp_sec_rssi == tmp_min_rssi) {\n\t\t\t\t\t\t \n\t\t\t\t\t\ttmp_sec_rssi = cur_rf_rssi;\n\t\t\t\t\t\tsec_rssi_index = i;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t \n\t\t\t\t\t}\n\t\t\t\t} else if ((cur_rf_rssi < tmp_sec_rssi) && (cur_rf_rssi > tmp_min_rssi)) {\n\t\t\t\t\t \n\t\t\t\t} else if (cur_rf_rssi == tmp_min_rssi) {\n\t\t\t\t\tif (tmp_sec_rssi == tmp_min_rssi) {\n\t\t\t\t\t\t \n\t\t\t\t\t\ttmp_min_rssi = cur_rf_rssi;\n\t\t\t\t\t\tmin_rssi_index = i;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t \n\t\t\t\t\t}\n\t\t\t\t} else if (cur_rf_rssi < tmp_min_rssi) {\n\t\t\t\t\ttmp_min_rssi = cur_rf_rssi;\n\t\t\t\t\tmin_rssi_index = i;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\trf_num = 0;\n\t \n\tif (DM_RxPathSelTable.cck_method == CCK_RX_VERSION_2) {\n\t\tfor (i = 0; i < RF90_PATH_MAX; i++) {\n\t\t\tif (priv->brfpath_rxenable[i]) {\n\t\t\t\trf_num++;\n\t\t\t\tcur_cck_pwdb =  DM_RxPathSelTable.cck_pwdb_sta[i];\n\n\t\t\t\tif (rf_num == 1) {\t \n\t\t\t\t\t \n\t\t\t\t\tcck_rx_ver2_max_index = cck_rx_ver2_min_index = cck_rx_ver2_sec_index = i;\n\t\t\t\t\ttmp_cck_max_pwdb = tmp_cck_min_pwdb = tmp_cck_sec_pwdb = cur_cck_pwdb;\n\t\t\t\t} else if (rf_num == 2) {\t \n\t\t\t\t\tif (cur_cck_pwdb >= tmp_cck_max_pwdb) {\n\t\t\t\t\t\ttmp_cck_max_pwdb = cur_cck_pwdb;\n\t\t\t\t\t\tcck_rx_ver2_max_index = i;\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttmp_cck_sec_pwdb = tmp_cck_min_pwdb = cur_cck_pwdb;\n\t\t\t\t\t\tcck_rx_ver2_sec_index = cck_rx_ver2_min_index = i;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (cur_cck_pwdb > tmp_cck_max_pwdb) {\n\t\t\t\t\t\ttmp_cck_sec_pwdb = tmp_cck_max_pwdb;\n\t\t\t\t\t\tcck_rx_ver2_sec_index = cck_rx_ver2_max_index;\n\t\t\t\t\t\ttmp_cck_max_pwdb = cur_cck_pwdb;\n\t\t\t\t\t\tcck_rx_ver2_max_index = i;\n\t\t\t\t\t} else if (cur_cck_pwdb == tmp_cck_max_pwdb) {\n\t\t\t\t\t\t \n\t\t\t\t\t\ttmp_cck_sec_pwdb = cur_cck_pwdb;\n\t\t\t\t\t\tcck_rx_ver2_sec_index = i;\n\t\t\t\t\t} else if ((cur_cck_pwdb < tmp_cck_max_pwdb) && (cur_cck_pwdb > tmp_cck_sec_pwdb)) {\n\t\t\t\t\t\ttmp_cck_sec_pwdb = cur_cck_pwdb;\n\t\t\t\t\t\tcck_rx_ver2_sec_index = i;\n\t\t\t\t\t} else if (cur_cck_pwdb == tmp_cck_sec_pwdb && tmp_cck_sec_pwdb == tmp_cck_min_pwdb) {\n\t\t\t\t\t\t \n\t\t\t\t\t\ttmp_cck_sec_pwdb = cur_cck_pwdb;\n\t\t\t\t\t\tcck_rx_ver2_sec_index = i;\n\t\t\t\t\t\t \n\t\t\t\t\t} else if ((cur_cck_pwdb < tmp_cck_sec_pwdb) && (cur_cck_pwdb > tmp_cck_min_pwdb)) {\n\t\t\t\t\t\t \n\t\t\t\t\t} else if (cur_cck_pwdb == tmp_cck_min_pwdb && tmp_cck_sec_pwdb == tmp_cck_min_pwdb) {\n\t\t\t\t\t\t \n\t\t\t\t\t\ttmp_cck_min_pwdb = cur_cck_pwdb;\n\t\t\t\t\t\tcck_rx_ver2_min_index = i;\n\t\t\t\t\t\t \n\t\t\t\t\t} else if (cur_cck_pwdb < tmp_cck_min_pwdb) {\n\t\t\t\t\t\ttmp_cck_min_pwdb = cur_cck_pwdb;\n\t\t\t\t\t\tcck_rx_ver2_min_index = i;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tupdate_cck_rx_path = 0;\n\tif (DM_RxPathSelTable.cck_method == CCK_RX_VERSION_2) {\n\t\tcck_default_Rx = cck_rx_ver2_max_index;\n\t\tcck_optional_Rx = cck_rx_ver2_sec_index;\n\t\tif (tmp_cck_max_pwdb != -64)\n\t\t\tupdate_cck_rx_path = 1;\n\t}\n\n\tif (tmp_min_rssi < RX_PATH_SELECTION_SS_TH_LOW && disabled_rf_cnt < 2) {\n\t\tif ((tmp_max_rssi - tmp_min_rssi) >= RX_PATH_SELECTION_DIFF_TH) {\n\t\t\t \n\t\t\tDM_RxPathSelTable.rf_enable_rssi_th[min_rssi_index] = tmp_max_rssi+5;\n\t\t\t \n\t\t\trtl8192_setBBreg(dev, rOFDM0_TRxPathEnable, 0x1<<min_rssi_index, 0x0);\t \n\t\t\trtl8192_setBBreg(dev, rOFDM1_TRxPathEnable, 0x1<<min_rssi_index, 0x0);\t \n\t\t\tdisabled_rf_cnt++;\n\t\t}\n\t\tif (DM_RxPathSelTable.cck_method == CCK_RX_VERSION_1) {\n\t\t\tcck_default_Rx = max_rssi_index;\n\t\t\tcck_optional_Rx = sec_rssi_index;\n\t\t\tif (tmp_max_rssi)\n\t\t\t\tupdate_cck_rx_path = 1;\n\t\t}\n\t}\n\n\tif (update_cck_rx_path) {\n\t\tDM_RxPathSelTable.cck_rx_path = (cck_default_Rx<<2)|(cck_optional_Rx);\n\t\trtl8192_setBBreg(dev, rCCK0_AFESetting, 0x0f000000, DM_RxPathSelTable.cck_rx_path);\n\t}\n\n\tif (DM_RxPathSelTable.disabled_rf) {\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tif ((DM_RxPathSelTable.disabled_rf >> i) & 0x1) {\t \n\t\t\t\tif (tmp_max_rssi >= DM_RxPathSelTable.rf_enable_rssi_th[i]) {\n\t\t\t\t\t \n\t\t\t\t\trtl8192_setBBreg(dev, rOFDM0_TRxPathEnable, 0x1<<i, 0x1);\t \n\t\t\t\t\trtl8192_setBBreg(dev, rOFDM1_TRxPathEnable, 0x1<<i, 0x1);\t \n\t\t\t\t\tDM_RxPathSelTable.rf_enable_rssi_th[i] = 100;\n\t\t\t\t\tdisabled_rf_cnt--;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\n \nstatic void dm_check_rx_path_selection(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tqueue_delayed_work(priv->priv_wq, &priv->rfpath_check_wq, 0);\n}\t \n\nstatic void dm_init_fsync(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tpriv->ieee80211->fsync_time_interval = 500;\n\tpriv->ieee80211->fsync_rate_bitmap = 0x0f000800;\n\tpriv->ieee80211->fsync_rssi_threshold = 30;\n\tpriv->ieee80211->bfsync_enable = false;\n\tpriv->ieee80211->fsync_multiple_timeinterval = 3;\n\tpriv->ieee80211->fsync_firstdiff_ratethreshold = 100;\n\tpriv->ieee80211->fsync_seconddiff_ratethreshold = 200;\n\tpriv->ieee80211->fsync_state = Default_Fsync;\n\tpriv->framesyncMonitor = 1;\t \n\tINIT_DELAYED_WORK(&priv->fsync_work, dm_fsync_work_callback);\n}\n\nstatic void dm_deInit_fsync(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tcancel_delayed_work_sync(&priv->fsync_work);\n}\n\nvoid dm_fsync_work_callback(struct work_struct *work)\n{\n\tstruct r8192_priv *priv =\n\t    container_of(work, struct r8192_priv, fsync_work.work);\n\tstruct net_device *dev = priv->ieee80211->dev;\n\tu32 rate_index, rate_count = 0, rate_count_diff = 0;\n\tbool\t\tbSwitchFromCountDiff = false;\n\tbool\t\tbDoubleTimeInterval = false;\n\n\tif (priv->ieee80211->state == IEEE80211_LINKED &&\n\t    priv->ieee80211->bfsync_enable &&\n\t\t(priv->ieee80211->pHTInfo->IOTAction & HT_IOT_ACT_CDD_FSYNC)) {\n\t\t \n\t\tu32 rate_bitmap;\n\n\t\tfor (rate_index = 0; rate_index <= 27; rate_index++) {\n\t\t\trate_bitmap  = 1 << rate_index;\n\t\t\tif (priv->ieee80211->fsync_rate_bitmap &  rate_bitmap)\n\t\t\t\trate_count += priv->stats.received_rate_histogram[1][rate_index];\n\t\t}\n\n\t\tif (rate_count < priv->rate_record)\n\t\t\trate_count_diff = 0xffffffff - rate_count + priv->rate_record;\n\t\telse\n\t\t\trate_count_diff = rate_count - priv->rate_record;\n\t\tif (rate_count_diff < priv->rateCountDiffRecord) {\n\t\t\tu32 DiffNum = priv->rateCountDiffRecord - rate_count_diff;\n\t\t\t \n\t\t\tif (DiffNum >= priv->ieee80211->fsync_seconddiff_ratethreshold)\n\t\t\t\tpriv->ContinueDiffCount++;\n\t\t\telse\n\t\t\t\tpriv->ContinueDiffCount = 0;\n\n\t\t\t \n\t\t\tif (priv->ContinueDiffCount >= 2) {\n\t\t\t\tbSwitchFromCountDiff = true;\n\t\t\t\tpriv->ContinueDiffCount = 0;\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tpriv->ContinueDiffCount = 0;\n\t\t}\n\n\t\t \n\t\tif (rate_count_diff <= priv->ieee80211->fsync_firstdiff_ratethreshold) {\n\t\t\tbSwitchFromCountDiff = true;\n\t\t\tpriv->ContinueDiffCount = 0;\n\t\t}\n\t\tpriv->rate_record = rate_count;\n\t\tpriv->rateCountDiffRecord = rate_count_diff;\n\t\tRT_TRACE(COMP_HALDM, \"rateRecord %d rateCount %d, rateCountdiff %d bSwitchFsync %d\\n\", priv->rate_record, rate_count, rate_count_diff, priv->bswitch_fsync);\n\t\t \n\t\tif (priv->undecorated_smoothed_pwdb > priv->ieee80211->fsync_rssi_threshold && bSwitchFromCountDiff) {\n\t\t\tbDoubleTimeInterval = true;\n\t\t\tpriv->bswitch_fsync = !priv->bswitch_fsync;\n\t\t\tif (priv->bswitch_fsync) {\n\t\t\t\twrite_nic_byte(dev, 0xC36, 0x1c);\n\t\t\t\twrite_nic_byte(dev, 0xC3e, 0x90);\n\t\t\t} else {\n\t\t\t\twrite_nic_byte(dev, 0xC36, 0x5c);\n\t\t\t\twrite_nic_byte(dev, 0xC3e, 0x96);\n\t\t\t}\n\t\t} else if (priv->undecorated_smoothed_pwdb <= priv->ieee80211->fsync_rssi_threshold) {\n\t\t\tif (priv->bswitch_fsync) {\n\t\t\t\tpriv->bswitch_fsync  = false;\n\t\t\t\twrite_nic_byte(dev, 0xC36, 0x5c);\n\t\t\t\twrite_nic_byte(dev, 0xC3e, 0x96);\n\t\t\t}\n\t\t}\n\t\tif (bDoubleTimeInterval) {\n\t\t\tcancel_delayed_work_sync(&priv->fsync_work);\n\t\t\tschedule_delayed_work(&priv->fsync_work,\n\t\t\t\t\t      msecs_to_jiffies(priv\n\t\t\t\t\t      ->ieee80211->fsync_time_interval *\n\t\t\t\t\t      priv->ieee80211->fsync_multiple_timeinterval));\n\t\t} else {\n\t\t\tcancel_delayed_work_sync(&priv->fsync_work);\n\t\t\tschedule_delayed_work(&priv->fsync_work,\n\t\t\t\t\t      msecs_to_jiffies(priv\n\t\t\t\t\t      ->ieee80211->fsync_time_interval));\n\t\t}\n\t} else {\n\t\t \n\t\tif (priv->bswitch_fsync) {\n\t\t\tpriv->bswitch_fsync  = false;\n\t\t\twrite_nic_byte(dev, 0xC36, 0x5c);\n\t\t\twrite_nic_byte(dev, 0xC3e, 0x96);\n\t\t}\n\t\tpriv->ContinueDiffCount = 0;\n\t\twrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c52cd);\n\t}\n\tRT_TRACE(COMP_HALDM, \"ContinueDiffCount %d\\n\", priv->ContinueDiffCount);\n\tRT_TRACE(COMP_HALDM, \"rateRecord %d rateCount %d, rateCountdiff %d bSwitchFsync %d\\n\", priv->rate_record, rate_count, rate_count_diff, priv->bswitch_fsync);\n}\n\nstatic void dm_StartHWFsync(struct net_device *dev)\n{\n\tRT_TRACE(COMP_HALDM, \"%s\\n\", __func__);\n\twrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c12cf);\n\twrite_nic_byte(dev, 0xc3b, 0x41);\n}\n\nstatic void dm_EndSWFsync(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\tRT_TRACE(COMP_HALDM, \"%s\\n\", __func__);\n\tcancel_delayed_work_sync(&priv->fsync_work);\n\n\t \n\tif (priv->bswitch_fsync) {\n\t\tpriv->bswitch_fsync  = false;\n\n\t\twrite_nic_byte(dev, 0xC36, 0x5c);\n\n\t\twrite_nic_byte(dev, 0xC3e, 0x96);\n\t}\n\n\tpriv->ContinueDiffCount = 0;\n\twrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c52cd);\n}\n\nstatic void dm_StartSWFsync(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tu32\t\t\trateIndex;\n\tu32\t\t\trateBitmap;\n\n\tRT_TRACE(COMP_HALDM, \"%s\\n\", __func__);\n\t \n\tpriv->rate_record = 0;\n\t \n\tpriv->ContinueDiffCount = 0;\n\tpriv->rateCountDiffRecord = 0;\n\tpriv->bswitch_fsync  = false;\n\n\tif (priv->ieee80211->mode == WIRELESS_MODE_N_24G) {\n\t\tpriv->ieee80211->fsync_firstdiff_ratethreshold = 600;\n\t\tpriv->ieee80211->fsync_seconddiff_ratethreshold = 0xffff;\n\t} else {\n\t\tpriv->ieee80211->fsync_firstdiff_ratethreshold = 200;\n\t\tpriv->ieee80211->fsync_seconddiff_ratethreshold = 200;\n\t}\n\tfor (rateIndex = 0; rateIndex <= 27; rateIndex++) {\n\t\trateBitmap = 1 << rateIndex;\n\t\tif (priv->ieee80211->fsync_rate_bitmap &  rateBitmap)\n\t\t\tpriv->rate_record += priv->stats.received_rate_histogram[1][rateIndex];\n\t}\n\tcancel_delayed_work_sync(&priv->fsync_work);\n\tschedule_delayed_work(&priv->fsync_work,\n\t\t\t      msecs_to_jiffies(priv->ieee80211->fsync_time_interval));\n\n\twrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c12cd);\n}\n\nstatic void dm_EndHWFsync(struct net_device *dev)\n{\n\tRT_TRACE(COMP_HALDM, \"%s\\n\", __func__);\n\twrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c52cd);\n\twrite_nic_byte(dev, 0xc3b, 0x49);\n}\n\nvoid dm_check_fsync(struct net_device *dev)\n{\n#define\tRegC38_Default\t\t\t\t0\n#define\tRegC38_NonFsync_Other_AP\t\t1\n#define\tRegC38_Fsync_AP_BCM\t\t\t2\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tstatic u8\t\treg_c38_State = RegC38_Default;\n\tstatic u32\treset_cnt;\n\n\tRT_TRACE(COMP_HALDM, \"RSSI %d TimeInterval %d MultipleTimeInterval %d\\n\", priv->ieee80211->fsync_rssi_threshold, priv->ieee80211->fsync_time_interval, priv->ieee80211->fsync_multiple_timeinterval);\n\tRT_TRACE(COMP_HALDM, \"RateBitmap 0x%x FirstDiffRateThreshold %d SecondDiffRateThreshold %d\\n\", priv->ieee80211->fsync_rate_bitmap, priv->ieee80211->fsync_firstdiff_ratethreshold, priv->ieee80211->fsync_seconddiff_ratethreshold);\n\n\tif (priv->ieee80211->state == IEEE80211_LINKED &&\n\t\t(priv->ieee80211->pHTInfo->IOTAction & HT_IOT_ACT_CDD_FSYNC)) {\n\t\tif (priv->ieee80211->bfsync_enable == 0) {\n\t\t\tswitch (priv->ieee80211->fsync_state) {\n\t\t\tcase Default_Fsync:\n\t\t\t\tdm_StartHWFsync(dev);\n\t\t\t\tpriv->ieee80211->fsync_state = HW_Fsync;\n\t\t\t\tbreak;\n\t\t\tcase SW_Fsync:\n\t\t\t\tdm_EndSWFsync(dev);\n\t\t\t\tdm_StartHWFsync(dev);\n\t\t\t\tpriv->ieee80211->fsync_state = HW_Fsync;\n\t\t\t\tbreak;\n\t\t\tcase HW_Fsync:\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t} else {\n\t\t\tswitch (priv->ieee80211->fsync_state) {\n\t\t\tcase Default_Fsync:\n\t\t\t\tdm_StartSWFsync(dev);\n\t\t\t\tpriv->ieee80211->fsync_state = SW_Fsync;\n\t\t\t\tbreak;\n\t\t\tcase HW_Fsync:\n\t\t\t\tdm_EndHWFsync(dev);\n\t\t\t\tdm_StartSWFsync(dev);\n\t\t\t\tpriv->ieee80211->fsync_state = SW_Fsync;\n\t\t\t\tbreak;\n\t\t\tcase SW_Fsync:\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (priv->framesyncMonitor) {\n\t\t\tif (reg_c38_State != RegC38_Fsync_AP_BCM) {\n\t\t\t\t \n\t\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector3, 0x95);\n\n\t\t\t\treg_c38_State = RegC38_Fsync_AP_BCM;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tswitch (priv->ieee80211->fsync_state) {\n\t\tcase HW_Fsync:\n\t\t\tdm_EndHWFsync(dev);\n\t\t\tpriv->ieee80211->fsync_state = Default_Fsync;\n\t\t\tbreak;\n\t\tcase SW_Fsync:\n\t\t\tdm_EndSWFsync(dev);\n\t\t\tpriv->ieee80211->fsync_state = Default_Fsync;\n\t\t\tbreak;\n\t\tcase Default_Fsync:\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tif (priv->framesyncMonitor) {\n\t\t\tif (priv->ieee80211->state == IEEE80211_LINKED) {\n\t\t\t\tif (priv->undecorated_smoothed_pwdb <= REG_C38_TH) {\n\t\t\t\t\tif (reg_c38_State != RegC38_NonFsync_Other_AP) {\n\t\t\t\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector3, 0x90);\n\n\t\t\t\t\t\treg_c38_State = RegC38_NonFsync_Other_AP;\n\t\t\t\t\t}\n\t\t\t\t} else if (priv->undecorated_smoothed_pwdb >= (REG_C38_TH + 5)) {\n\t\t\t\t\tif (reg_c38_State) {\n\t\t\t\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector3, priv->framesync);\n\t\t\t\t\t\treg_c38_State = RegC38_Default;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (reg_c38_State) {\n\t\t\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector3, priv->framesync);\n\t\t\t\t\treg_c38_State = RegC38_Default;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tif (priv->framesyncMonitor) {\n\t\tif (priv->reset_count != reset_cnt) {  \n\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector3, priv->framesync);\n\t\t\treg_c38_State = RegC38_Default;\n\t\t\treset_cnt = priv->reset_count;\n\t\t}\n\t} else {\n\t\tif (reg_c38_State) {\n\t\t\twrite_nic_byte(dev, rOFDM0_RxDetector3, priv->framesync);\n\t\t\treg_c38_State = RegC38_Default;\n\t\t}\n\t}\n}\n\n \n \nstatic void dm_init_dynamic_txpower(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\t \n\tpriv->ieee80211->bdynamic_txpower_enable = true;     \n\tpriv->bLastDTPFlag_High = false;\n\tpriv->bLastDTPFlag_Low = false;\n\tpriv->bDynamicTxHighPower = false;\n\tpriv->bDynamicTxLowPower = false;\n}\n\nstatic void dm_dynamic_txpower(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tunsigned int txhipower_threshold = 0;\n\tunsigned int txlowpower_threshold = 0;\n\n\tif (!priv->ieee80211->bdynamic_txpower_enable) {\n\t\tpriv->bDynamicTxHighPower = false;\n\t\tpriv->bDynamicTxLowPower = false;\n\t\treturn;\n\t}\n\tif ((priv->ieee80211->current_network.atheros_cap_exist) && (priv->ieee80211->mode == IEEE_G)) {\n\t\ttxhipower_threshold = TX_POWER_ATHEROAP_THRESH_HIGH;\n\t\ttxlowpower_threshold = TX_POWER_ATHEROAP_THRESH_LOW;\n\t} else {\n\t\ttxhipower_threshold = TX_POWER_NEAR_FIELD_THRESH_HIGH;\n\t\ttxlowpower_threshold = TX_POWER_NEAR_FIELD_THRESH_LOW;\n\t}\n\n\tRT_TRACE(COMP_TXAGC, \"priv->undecorated_smoothed_pwdb = %ld\\n\", priv->undecorated_smoothed_pwdb);\n\n\tif (priv->ieee80211->state == IEEE80211_LINKED) {\n\t\tif (priv->undecorated_smoothed_pwdb >= txhipower_threshold) {\n\t\t\tpriv->bDynamicTxHighPower = true;\n\t\t\tpriv->bDynamicTxLowPower = false;\n\t\t} else {\n\t\t\t \n\t\t\tif (priv->undecorated_smoothed_pwdb < txlowpower_threshold && priv->bDynamicTxHighPower)\n\t\t\t\tpriv->bDynamicTxHighPower = false;\n\n\t\t\t \n\t\t\tif (priv->undecorated_smoothed_pwdb < 35)\n\t\t\t\tpriv->bDynamicTxLowPower = true;\n\t\t\telse if (priv->undecorated_smoothed_pwdb >= 40)\n\t\t\t\tpriv->bDynamicTxLowPower = false;\n\t\t}\n\t} else {\n\t\tpriv->bDynamicTxHighPower = false;\n\t\tpriv->bDynamicTxLowPower = false;\n\t}\n\n\tif ((priv->bDynamicTxHighPower != priv->bLastDTPFlag_High) ||\n\t\t(priv->bDynamicTxLowPower != priv->bLastDTPFlag_Low)) {\n\t\tRT_TRACE(COMP_TXAGC, \"SetTxPowerLevel8190()  channel = %d\\n\", priv->ieee80211->current_network.channel);\n\n#if  defined(RTL8190P) || defined(RTL8192E)\n\t\tSetTxPowerLevel8190(Adapter, pHalData->CurrentChannel);\n#endif\n\n\t\trtl8192_phy_setTxPower(dev, priv->ieee80211->current_network.channel);\n\t\t \n\t}\n\tpriv->bLastDTPFlag_High = priv->bDynamicTxHighPower;\n\tpriv->bLastDTPFlag_Low = priv->bDynamicTxLowPower;\n\n}\t \n\n \nstatic void dm_check_txrateandretrycount(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\tstruct ieee80211_device *ieee = priv->ieee80211;\n\t \n\tread_nic_byte(dev, CURRENT_TX_RATE_REG, &ieee->softmac_stats.CurrentShowTxate);\n\t \n\tread_nic_byte(dev, INITIAL_TX_RATE_REG, &ieee->softmac_stats.last_packet_rate);\n\t \n\tread_nic_dword(dev, TX_RETRY_COUNT_REG, &ieee->softmac_stats.txretrycount);\n}\n\nstatic void dm_send_rssi_tofw(struct net_device *dev)\n{\n\tstruct r8192_priv *priv = ieee80211_priv(dev);\n\n\t \n\twrite_nic_byte(dev, DRIVER_RSSI, (u8)priv->undecorated_smoothed_pwdb);\n}\n\n \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}