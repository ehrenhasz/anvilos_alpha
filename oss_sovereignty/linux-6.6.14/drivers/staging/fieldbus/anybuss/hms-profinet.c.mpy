{
  "module_name": "hms-profinet.c",
  "hash_id": "0f002ce348c23f7f63c4bbda98b593bccbde4ba244ac2ea18a8e0efe53d7ea6d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/fieldbus/anybuss/hms-profinet.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n\n \n#include \"../fieldbus_dev.h\"\n\n \n#include \"anybuss-client.h\"\n\n#define PROFI_DPRAM_SIZE\t512\n\n \n\nstruct msg_mac_addr {\n\tu8 addr[6];\n};\n\nstruct profi_priv {\n\tstruct fieldbus_dev fbdev;\n\tstruct anybuss_client *client;\n\tstruct mutex enable_lock;  \n\tbool power_on;\n};\n\nstatic ssize_t\nprofi_read_area(struct fieldbus_dev *fbdev, char __user *buf, size_t size,\n\t\tloff_t *offset)\n{\n\tstruct profi_priv *priv = container_of(fbdev, struct profi_priv, fbdev);\n\n\treturn anybuss_read_output(priv->client, buf, size, offset);\n}\n\nstatic ssize_t\nprofi_write_area(struct fieldbus_dev *fbdev, const char __user *buf,\n\t\t size_t size, loff_t *offset)\n{\n\tstruct profi_priv *priv = container_of(fbdev, struct profi_priv, fbdev);\n\n\treturn anybuss_write_input(priv->client, buf, size, offset);\n}\n\nstatic int profi_id_get(struct fieldbus_dev *fbdev, char *buf,\n\t\t\tsize_t max_size)\n{\n\tstruct profi_priv *priv = container_of(fbdev, struct profi_priv, fbdev);\n\tstruct msg_mac_addr response;\n\tint ret;\n\n\tret = anybuss_recv_msg(priv->client, 0x0010, &response,\n\t\t\t       sizeof(response));\n\tif (ret < 0)\n\t\treturn ret;\n\treturn snprintf(buf, max_size, \"%pM\\n\", response.addr);\n}\n\nstatic bool profi_enable_get(struct fieldbus_dev *fbdev)\n{\n\tstruct profi_priv *priv = container_of(fbdev, struct profi_priv, fbdev);\n\tbool power_on;\n\n\tmutex_lock(&priv->enable_lock);\n\tpower_on = priv->power_on;\n\tmutex_unlock(&priv->enable_lock);\n\n\treturn power_on;\n}\n\nstatic int __profi_enable(struct profi_priv *priv)\n{\n\tint ret;\n\tstruct anybuss_client *client = priv->client;\n\t \n\tconst struct anybuss_memcfg mem_cfg = {\n\t\t.input_io = 220,\n\t\t.input_dpram = PROFI_DPRAM_SIZE,\n\t\t.input_total = PROFI_DPRAM_SIZE,\n\t\t.output_io = 220,\n\t\t.output_dpram = PROFI_DPRAM_SIZE,\n\t\t.output_total = PROFI_DPRAM_SIZE,\n\t\t.offl_mode = FIELDBUS_DEV_OFFL_MODE_CLEAR,\n\t};\n\n\t \n\tanybuss_set_power(client, false);\n\tret = anybuss_set_power(client, true);\n\tif (ret)\n\t\tgoto err;\n\tret = anybuss_start_init(client, &mem_cfg);\n\tif (ret)\n\t\tgoto err;\n\tret = anybuss_finish_init(client);\n\tif (ret)\n\t\tgoto err;\n\tpriv->power_on = true;\n\treturn 0;\n\nerr:\n\tanybuss_set_power(client, false);\n\tpriv->power_on = false;\n\treturn ret;\n}\n\nstatic int __profi_disable(struct profi_priv *priv)\n{\n\tstruct anybuss_client *client = priv->client;\n\n\tanybuss_set_power(client, false);\n\tpriv->power_on = false;\n\treturn 0;\n}\n\nstatic int profi_simple_enable(struct fieldbus_dev *fbdev, bool enable)\n{\n\tint ret;\n\tstruct profi_priv *priv = container_of(fbdev, struct profi_priv, fbdev);\n\n\tmutex_lock(&priv->enable_lock);\n\tif (enable)\n\t\tret = __profi_enable(priv);\n\telse\n\t\tret = __profi_disable(priv);\n\tmutex_unlock(&priv->enable_lock);\n\n\treturn ret;\n}\n\nstatic void profi_on_area_updated(struct anybuss_client *client)\n{\n\tstruct profi_priv *priv = anybuss_get_drvdata(client);\n\n\tfieldbus_dev_area_updated(&priv->fbdev);\n}\n\nstatic void profi_on_online_changed(struct anybuss_client *client, bool online)\n{\n\tstruct profi_priv *priv = anybuss_get_drvdata(client);\n\n\tfieldbus_dev_online_changed(&priv->fbdev, online);\n}\n\nstatic int profinet_probe(struct anybuss_client *client)\n{\n\tstruct profi_priv *priv;\n\tstruct device *dev = &client->dev;\n\tint err;\n\n\tclient->on_area_updated = profi_on_area_updated;\n\tclient->on_online_changed = profi_on_online_changed;\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\tmutex_init(&priv->enable_lock);\n\tpriv->client = client;\n\tpriv->fbdev.read_area_sz = PROFI_DPRAM_SIZE;\n\tpriv->fbdev.write_area_sz = PROFI_DPRAM_SIZE;\n\tpriv->fbdev.card_name = \"HMS Profinet IRT (Anybus-S)\";\n\tpriv->fbdev.fieldbus_type = FIELDBUS_DEV_TYPE_PROFINET;\n\tpriv->fbdev.read_area = profi_read_area;\n\tpriv->fbdev.write_area = profi_write_area;\n\tpriv->fbdev.fieldbus_id_get = profi_id_get;\n\tpriv->fbdev.enable_get = profi_enable_get;\n\tpriv->fbdev.simple_enable_set = profi_simple_enable;\n\tpriv->fbdev.parent = dev;\n\terr = fieldbus_dev_register(&priv->fbdev);\n\tif (err < 0)\n\t\treturn err;\n\tdev_info(dev, \"card detected, registered as %s\",\n\t\t dev_name(priv->fbdev.dev));\n\tanybuss_set_drvdata(client, priv);\n\n\treturn 0;\n}\n\nstatic void profinet_remove(struct anybuss_client *client)\n{\n\tstruct profi_priv *priv = anybuss_get_drvdata(client);\n\n\tfieldbus_dev_unregister(&priv->fbdev);\n}\n\nstatic struct anybuss_client_driver profinet_driver = {\n\t.probe = profinet_probe,\n\t.remove = profinet_remove,\n\t.driver\t\t= {\n\t\t.name   = \"hms-profinet\",\n\t\t.owner\t= THIS_MODULE,\n\t},\n\t.anybus_id = 0x0089,\n};\n\nstatic int __init profinet_init(void)\n{\n\treturn anybuss_client_driver_register(&profinet_driver);\n}\nmodule_init(profinet_init);\n\nstatic void __exit profinet_exit(void)\n{\n\treturn anybuss_client_driver_unregister(&profinet_driver);\n}\nmodule_exit(profinet_exit);\n\nMODULE_AUTHOR(\"Sven Van Asbroeck <TheSven73@gmail.com>\");\nMODULE_DESCRIPTION(\"HMS Profinet IRT Driver (Anybus-S)\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}