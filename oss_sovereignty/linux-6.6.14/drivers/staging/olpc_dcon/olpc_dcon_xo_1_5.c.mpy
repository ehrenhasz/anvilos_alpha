{
  "module_name": "olpc_dcon_xo_1_5.c",
  "hash_id": "644b6a033492cddeb47e9311f72975ae918b31296d5df47e3d85eedc23ad0d7d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/olpc_dcon/olpc_dcon_xo_1_5.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/acpi.h>\n#include <linux/delay.h>\n#include <linux/i2c.h>\n#include <linux/gpio/consumer.h>\n#include <linux/gpio/machine.h>\n#include <asm/olpc.h>\n\n \n#define NR_VX855_GPI    14\n#define NR_VX855_GPO    13\n#define NR_VX855_GPIO   15\n\n#define VX855_GPI(n)    (n)\n#define VX855_GPO(n)    (NR_VX855_GPI + (n))\n#define VX855_GPIO(n)   (NR_VX855_GPI + NR_VX855_GPO + (n))\n\n#include \"olpc_dcon.h\"\n\n \n\n#define VX855_GENL_PURPOSE_OUTPUT 0x44c  \n#define VX855_GPI_STATUS_CHG 0x450   \n#define VX855_GPI_SCI_SMI 0x452   \n#define BIT_GPIO12 0x40\n\n#define PREFIX \"OLPC DCON:\"\n\nenum dcon_gpios {\n\tOLPC_DCON_STAT0,\n\tOLPC_DCON_STAT1,\n\tOLPC_DCON_LOAD,\n};\n\nstruct gpiod_lookup_table gpios_table = {\n\t.dev_id = NULL,\n\t.table = {\n\t\tGPIO_LOOKUP(\"VX855 South Bridge\", VX855_GPIO(1), \"dcon_load\",\n\t\t\t    GPIO_ACTIVE_LOW),\n\t\tGPIO_LOOKUP(\"VX855 South Bridge\", VX855_GPI(10), \"dcon_stat0\",\n\t\t\t    GPIO_ACTIVE_LOW),\n\t\tGPIO_LOOKUP(\"VX855 South Bridge\", VX855_GPI(11), \"dcon_stat1\",\n\t\t\t    GPIO_ACTIVE_LOW),\n\t\t{ },\n\t},\n};\n\nstatic const struct dcon_gpio gpios_asis[] = {\n\t[OLPC_DCON_STAT0] = { .name = \"dcon_stat0\", .flags = GPIOD_ASIS },\n\t[OLPC_DCON_STAT1] = { .name = \"dcon_stat1\", .flags = GPIOD_ASIS },\n\t[OLPC_DCON_LOAD] = { .name = \"dcon_load\", .flags = GPIOD_ASIS },\n};\n\nstatic struct gpio_desc *gpios[3];\n\nstatic void dcon_clear_irq(void)\n{\n\t \n\toutb(BIT_GPIO12, VX855_GPI_STATUS_CHG);\n}\n\nstatic int dcon_was_irq(void)\n{\n\tu8 tmp;\n\n\t \n\ttmp = inb(VX855_GPI_STATUS_CHG);\n\n\treturn !!(tmp & BIT_GPIO12);\n}\n\nstatic int dcon_init_xo_1_5(struct dcon_priv *dcon)\n{\n\tunsigned int irq;\n\tconst struct dcon_gpio *pin = &gpios_asis[0];\n\tint i;\n\tint ret;\n\n\t \n\tgpios_table.dev_id = dev_name(&dcon->client->dev);\n\tgpiod_add_lookup_table(&gpios_table);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(gpios_asis); i++) {\n\t\tgpios[i] = devm_gpiod_get(&dcon->client->dev, pin[i].name,\n\t\t\t\t\t  pin[i].flags);\n\t\tif (IS_ERR(gpios[i])) {\n\t\t\tret = PTR_ERR(gpios[i]);\n\t\t\tpr_err(\"failed to request %s GPIO: %d\\n\", pin[i].name,\n\t\t\t       ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tdcon_clear_irq();\n\n\t \n\toutb(inb(VX855_GPI_SCI_SMI) | BIT_GPIO12, VX855_GPI_SCI_SMI);\n\n\t \n\t \n\tdcon->curr_src = (inl(VX855_GENL_PURPOSE_OUTPUT) & 0x1000) ?\n\t\t\tDCON_SOURCE_CPU : DCON_SOURCE_DCON;\n\tdcon->pending_src = dcon->curr_src;\n\n\t \n\tirq = acpi_gbl_FADT.sci_interrupt;\n\tif (request_irq(irq, &dcon_interrupt, IRQF_SHARED, \"DCON\", dcon)) {\n\t\tpr_err(\"DCON (IRQ%d) allocation failed\\n\", irq);\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\nstatic void set_i2c_line(int sda, int scl)\n{\n\tunsigned char tmp;\n\tunsigned int port = 0x26;\n\n\t \n\toutb(port, 0x3c4);\n\ttmp = inb(0x3c5);\n\n\tif (scl)\n\t\ttmp |= 0x20;\n\telse\n\t\ttmp &= ~0x20;\n\n\tif (sda)\n\t\ttmp |= 0x10;\n\telse\n\t\ttmp &= ~0x10;\n\n\ttmp |= 0x01;\n\n\toutb(port, 0x3c4);\n\toutb(tmp, 0x3c5);\n}\n\nstatic void dcon_wiggle_xo_1_5(void)\n{\n\tint x;\n\n\t \n\tset_i2c_line(1, 1);\n\n\tfor (x = 0; x < 16; x++) {\n\t\tudelay(5);\n\t\tset_i2c_line(1, 0);\n\t\tudelay(5);\n\t\tset_i2c_line(1, 1);\n\t}\n\tudelay(5);\n\n\t \n\toutb(inb(VX855_GPI_SCI_SMI) | BIT_GPIO12, VX855_GPI_SCI_SMI);\n}\n\nstatic void dcon_set_dconload_xo_1_5(int val)\n{\n\tgpiod_set_value(gpios[OLPC_DCON_LOAD], val);\n}\n\nstatic int dcon_read_status_xo_1_5(u8 *status)\n{\n\tif (!dcon_was_irq())\n\t\treturn -1;\n\n\t \n\t*status = gpiod_get_value(gpios[OLPC_DCON_STAT0]);\n\t*status |= gpiod_get_value(gpios[OLPC_DCON_STAT1]) << 1;\n\n\tdcon_clear_irq();\n\n\treturn 0;\n}\n\nstruct dcon_platform_data dcon_pdata_xo_1_5 = {\n\t.init = dcon_init_xo_1_5,\n\t.bus_stabilize_wiggle = dcon_wiggle_xo_1_5,\n\t.set_dconload = dcon_set_dconload_xo_1_5,\n\t.read_status = dcon_read_status_xo_1_5,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}