{
  "module_name": "controls.c",
  "hash_id": "3e6fd8a0a617d5dbe918778abda8de48da40a543bba62d549fc057fbf35d2a13",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/vc04_services/bcm2835-camera/controls.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <media/videobuf2-vmalloc.h>\n#include <media/v4l2-device.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-ctrls.h>\n#include <media/v4l2-fh.h>\n#include <media/v4l2-event.h>\n#include <media/v4l2-common.h>\n\n#include \"../vchiq-mmal/mmal-common.h\"\n#include \"../vchiq-mmal/mmal-vchiq.h\"\n#include \"../vchiq-mmal/mmal-parameters.h\"\n#include \"bcm2835-camera.h\"\n\n \nstatic const s64 ev_bias_qmenu[] = {\n\t-4000, -3667, -3333,\n\t-3000, -2667, -2333,\n\t-2000, -1667, -1333,\n\t-1000,  -667,  -333,\n\t    0,   333,   667,\n\t 1000,  1333,  1667,\n\t 2000,  2333,  2667,\n\t 3000,  3333,  3667,\n\t 4000\n};\n\n \nstatic const s64 iso_qmenu[] = {\n\t0, 100000, 200000, 400000, 800000,\n};\n\nstatic const u32 iso_values[] = {\n\t0, 100, 200, 400, 800,\n};\n\nenum bcm2835_mmal_ctrl_type {\n\tMMAL_CONTROL_TYPE_STD,\n\tMMAL_CONTROL_TYPE_STD_MENU,\n\tMMAL_CONTROL_TYPE_INT_MENU,\n\tMMAL_CONTROL_TYPE_CLUSTER,  \n};\n\nstruct bcm2835_mmal_v4l2_ctrl {\n\tu32 id;  \n\tenum bcm2835_mmal_ctrl_type type;\n\t \n\ts64 min;\n\ts64 max;  \n\ts64 def;   \n\tu64 step;  \n\tconst s64 *imenu;  \n\tu32 mmal_id;  \n\tint (*setter)(struct bcm2835_mmal_dev *dev, struct v4l2_ctrl *ctrl,\n\t\t      const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl);\n};\n\nstruct v4l2_to_mmal_effects_setting {\n\tu32 v4l2_effect;\n\tu32 mmal_effect;\n\ts32 col_fx_enable;\n\ts32 col_fx_fixed_cbcr;\n\tu32 u;\n\tu32 v;\n\tu32 num_effect_params;\n\tu32 effect_params[MMAL_MAX_IMAGEFX_PARAMETERS];\n};\n\nstatic const struct v4l2_to_mmal_effects_setting\n\tv4l2_to_mmal_effects_values[] = {\n\t{  V4L2_COLORFX_NONE,         MMAL_PARAM_IMAGEFX_NONE,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_BW,           MMAL_PARAM_IMAGEFX_NONE,\n\t\t1,   0,    128,  128, 0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_SEPIA,        MMAL_PARAM_IMAGEFX_NONE,\n\t\t1,   0,    87,   151, 0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_NEGATIVE,     MMAL_PARAM_IMAGEFX_NEGATIVE,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_EMBOSS,       MMAL_PARAM_IMAGEFX_EMBOSS,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_SKETCH,       MMAL_PARAM_IMAGEFX_SKETCH,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_SKY_BLUE,     MMAL_PARAM_IMAGEFX_PASTEL,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_GRASS_GREEN,  MMAL_PARAM_IMAGEFX_WATERCOLOUR,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_SKIN_WHITEN,  MMAL_PARAM_IMAGEFX_WASHEDOUT,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_VIVID,        MMAL_PARAM_IMAGEFX_SATURATION,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_AQUA,         MMAL_PARAM_IMAGEFX_NONE,\n\t\t1,   0,    171,  121, 0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_ART_FREEZE,   MMAL_PARAM_IMAGEFX_HATCH,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_SILHOUETTE,   MMAL_PARAM_IMAGEFX_FILM,\n\t\t0,   0,    0,    0,   0, {0, 0, 0, 0, 0} },\n\t{  V4L2_COLORFX_SOLARIZATION, MMAL_PARAM_IMAGEFX_SOLARIZE,\n\t\t0,   0,    0,    0,   5, {1, 128, 160, 160, 48} },\n\t{  V4L2_COLORFX_ANTIQUE,      MMAL_PARAM_IMAGEFX_COLOURBALANCE,\n\t\t0,   0,    0,    0,   3, {108, 274, 238, 0, 0} },\n\t{  V4L2_COLORFX_SET_CBCR,     MMAL_PARAM_IMAGEFX_NONE,\n\t\t1,   1,    0,    0,   0, {0, 0, 0, 0, 0} }\n};\n\nstruct v4l2_mmal_scene_config {\n\tenum v4l2_scene_mode v4l2_scene;\n\tenum mmal_parameter_exposuremode exposure_mode;\n\tenum mmal_parameter_exposuremeteringmode metering_mode;\n};\n\nstatic const struct v4l2_mmal_scene_config scene_configs[] = {\n\t \n\t{\n\t\tV4L2_SCENE_MODE_NIGHT,\n\t\tMMAL_PARAM_EXPOSUREMODE_NIGHT,\n\t\tMMAL_PARAM_EXPOSUREMETERINGMODE_AVERAGE\n\t},\n\t{\n\t\tV4L2_SCENE_MODE_SPORTS,\n\t\tMMAL_PARAM_EXPOSUREMODE_SPORTS,\n\t\tMMAL_PARAM_EXPOSUREMETERINGMODE_AVERAGE\n\t},\n};\n\n \n\nstatic int ctrl_set_rational(struct bcm2835_mmal_dev *dev,\n\t\t\t     struct v4l2_ctrl *ctrl,\n\t\t\t     const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tstruct s32_fract rational_value;\n\tstruct vchiq_mmal_port *control;\n\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\trational_value.numerator = ctrl->val;\n\trational_value.denominator = 100;\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t     mmal_ctrl->mmal_id,\n\t\t\t\t\t     &rational_value,\n\t\t\t\t\t     sizeof(rational_value));\n}\n\nstatic int ctrl_set_value(struct bcm2835_mmal_dev *dev,\n\t\t\t  struct v4l2_ctrl *ctrl,\n\t\t\t  const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tu32 u32_value;\n\tstruct vchiq_mmal_port *control;\n\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\tu32_value = ctrl->val;\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t     mmal_ctrl->mmal_id,\n\t\t\t\t\t     &u32_value, sizeof(u32_value));\n}\n\nstatic int ctrl_set_iso(struct bcm2835_mmal_dev *dev,\n\t\t\tstruct v4l2_ctrl *ctrl,\n\t\t\tconst struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tu32 u32_value;\n\tstruct vchiq_mmal_port *control;\n\n\tif (ctrl->val > mmal_ctrl->max || ctrl->val < mmal_ctrl->min)\n\t\treturn 1;\n\n\tif (ctrl->id == V4L2_CID_ISO_SENSITIVITY)\n\t\tdev->iso = iso_values[ctrl->val];\n\telse if (ctrl->id == V4L2_CID_ISO_SENSITIVITY_AUTO)\n\t\tdev->manual_iso_enabled =\n\t\t\t\t(ctrl->val == V4L2_ISO_SENSITIVITY_MANUAL);\n\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\tif (dev->manual_iso_enabled)\n\t\tu32_value = dev->iso;\n\telse\n\t\tu32_value = 0;\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t     MMAL_PARAMETER_ISO,\n\t\t\t\t\t     &u32_value, sizeof(u32_value));\n}\n\nstatic int ctrl_set_value_ev(struct bcm2835_mmal_dev *dev,\n\t\t\t     struct v4l2_ctrl *ctrl,\n\t\t\t     const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\ts32 s32_value;\n\tstruct vchiq_mmal_port *control;\n\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\ts32_value = (ctrl->val - 12) * 2;\t \n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t     mmal_ctrl->mmal_id,\n\t\t\t\t\t     &s32_value, sizeof(s32_value));\n}\n\nstatic int ctrl_set_rotate(struct bcm2835_mmal_dev *dev,\n\t\t\t   struct v4l2_ctrl *ctrl,\n\t\t\t   const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tint ret;\n\tu32 u32_value;\n\tstruct vchiq_mmal_component *camera;\n\n\tcamera = dev->component[COMP_CAMERA];\n\n\tu32_value = ((ctrl->val % 360) / 90) * 90;\n\n\tret = vchiq_mmal_port_parameter_set(dev->instance, &camera->output[0],\n\t\t\t\t\t    mmal_ctrl->mmal_id,\n\t\t\t\t\t    &u32_value, sizeof(u32_value));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = vchiq_mmal_port_parameter_set(dev->instance, &camera->output[1],\n\t\t\t\t\t    mmal_ctrl->mmal_id,\n\t\t\t\t\t    &u32_value, sizeof(u32_value));\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, &camera->output[2],\n\t\t\t\t\t    mmal_ctrl->mmal_id,\n\t\t\t\t\t    &u32_value, sizeof(u32_value));\n}\n\nstatic int ctrl_set_flip(struct bcm2835_mmal_dev *dev,\n\t\t\t struct v4l2_ctrl *ctrl,\n\t\t\t const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tint ret;\n\tu32 u32_value;\n\tstruct vchiq_mmal_component *camera;\n\n\tif (ctrl->id == V4L2_CID_HFLIP)\n\t\tdev->hflip = ctrl->val;\n\telse\n\t\tdev->vflip = ctrl->val;\n\n\tcamera = dev->component[COMP_CAMERA];\n\n\tif (dev->hflip && dev->vflip)\n\t\tu32_value = MMAL_PARAM_MIRROR_BOTH;\n\telse if (dev->hflip)\n\t\tu32_value = MMAL_PARAM_MIRROR_HORIZONTAL;\n\telse if (dev->vflip)\n\t\tu32_value = MMAL_PARAM_MIRROR_VERTICAL;\n\telse\n\t\tu32_value = MMAL_PARAM_MIRROR_NONE;\n\n\tret = vchiq_mmal_port_parameter_set(dev->instance, &camera->output[0],\n\t\t\t\t\t    mmal_ctrl->mmal_id,\n\t\t\t\t\t    &u32_value, sizeof(u32_value));\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = vchiq_mmal_port_parameter_set(dev->instance, &camera->output[1],\n\t\t\t\t\t    mmal_ctrl->mmal_id,\n\t\t\t\t\t    &u32_value, sizeof(u32_value));\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, &camera->output[2],\n\t\t\t\t\t    mmal_ctrl->mmal_id,\n\t\t\t\t\t    &u32_value, sizeof(u32_value));\n}\n\nstatic int ctrl_set_exposure(struct bcm2835_mmal_dev *dev,\n\t\t\t     struct v4l2_ctrl *ctrl,\n\t\t\t     const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tenum mmal_parameter_exposuremode exp_mode = dev->exposure_mode_user;\n\tu32 shutter_speed = 0;\n\tstruct vchiq_mmal_port *control;\n\tint ret = 0;\n\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\tif (mmal_ctrl->mmal_id == MMAL_PARAMETER_SHUTTER_SPEED)\t{\n\t\t \n\t\tdev->manual_shutter_speed = ctrl->val * 100;\n\t} else if (mmal_ctrl->mmal_id == MMAL_PARAMETER_EXPOSURE_MODE) {\n\t\tswitch (ctrl->val) {\n\t\tcase V4L2_EXPOSURE_AUTO:\n\t\t\texp_mode = MMAL_PARAM_EXPOSUREMODE_AUTO;\n\t\t\tbreak;\n\n\t\tcase V4L2_EXPOSURE_MANUAL:\n\t\t\texp_mode = MMAL_PARAM_EXPOSUREMODE_OFF;\n\t\t\tbreak;\n\t\t}\n\t\tdev->exposure_mode_user = exp_mode;\n\t\tdev->exposure_mode_v4l2_user = ctrl->val;\n\t} else if (mmal_ctrl->id == V4L2_CID_EXPOSURE_AUTO_PRIORITY) {\n\t\tdev->exp_auto_priority = ctrl->val;\n\t}\n\n\tif (dev->scene_mode == V4L2_SCENE_MODE_NONE) {\n\t\tif (exp_mode == MMAL_PARAM_EXPOSUREMODE_OFF)\n\t\t\tshutter_speed = dev->manual_shutter_speed;\n\n\t\tret = vchiq_mmal_port_parameter_set(dev->instance,\n\t\t\t\t\t\t    control,\n\t\t\t\t\t\t    MMAL_PARAMETER_SHUTTER_SPEED,\n\t\t\t\t\t\t    &shutter_speed,\n\t\t\t\t\t\t    sizeof(shutter_speed));\n\t\tret += vchiq_mmal_port_parameter_set(dev->instance,\n\t\t\t\t\t\t     control,\n\t\t\t\t\t\t     MMAL_PARAMETER_EXPOSURE_MODE,\n\t\t\t\t\t\t     &exp_mode,\n\t\t\t\t\t\t     sizeof(u32));\n\t\tdev->exposure_mode_active = exp_mode;\n\t}\n\t \n\tret += set_framerate_params(dev);\n\n\treturn ret;\n}\n\nstatic int ctrl_set_metering_mode(struct bcm2835_mmal_dev *dev,\n\t\t\t\t  struct v4l2_ctrl *ctrl,\n\t\t\t\t  const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tswitch (ctrl->val) {\n\tcase V4L2_EXPOSURE_METERING_AVERAGE:\n\t\tdev->metering_mode = MMAL_PARAM_EXPOSUREMETERINGMODE_AVERAGE;\n\t\tbreak;\n\n\tcase V4L2_EXPOSURE_METERING_CENTER_WEIGHTED:\n\t\tdev->metering_mode = MMAL_PARAM_EXPOSUREMETERINGMODE_BACKLIT;\n\t\tbreak;\n\n\tcase V4L2_EXPOSURE_METERING_SPOT:\n\t\tdev->metering_mode = MMAL_PARAM_EXPOSUREMETERINGMODE_SPOT;\n\t\tbreak;\n\n\tcase V4L2_EXPOSURE_METERING_MATRIX:\n\t\tdev->metering_mode = MMAL_PARAM_EXPOSUREMETERINGMODE_MATRIX;\n\t\tbreak;\n\t}\n\n\tif (dev->scene_mode == V4L2_SCENE_MODE_NONE) {\n\t\tstruct vchiq_mmal_port *control;\n\t\tu32 u32_value = dev->metering_mode;\n\n\t\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\t\treturn vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t     mmal_ctrl->mmal_id,\n\t\t\t\t\t     &u32_value, sizeof(u32_value));\n\t} else {\n\t\treturn 0;\n\t}\n}\n\nstatic int ctrl_set_flicker_avoidance(struct bcm2835_mmal_dev *dev,\n\t\t\t\t      struct v4l2_ctrl *ctrl,\n\t\t\t\t      const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tu32 u32_value;\n\tstruct vchiq_mmal_port *control;\n\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\tswitch (ctrl->val) {\n\tcase V4L2_CID_POWER_LINE_FREQUENCY_DISABLED:\n\t\tu32_value = MMAL_PARAM_FLICKERAVOID_OFF;\n\t\tbreak;\n\tcase V4L2_CID_POWER_LINE_FREQUENCY_50HZ:\n\t\tu32_value = MMAL_PARAM_FLICKERAVOID_50HZ;\n\t\tbreak;\n\tcase V4L2_CID_POWER_LINE_FREQUENCY_60HZ:\n\t\tu32_value = MMAL_PARAM_FLICKERAVOID_60HZ;\n\t\tbreak;\n\tcase V4L2_CID_POWER_LINE_FREQUENCY_AUTO:\n\t\tu32_value = MMAL_PARAM_FLICKERAVOID_AUTO;\n\t\tbreak;\n\t}\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t     mmal_ctrl->mmal_id,\n\t\t\t\t\t     &u32_value, sizeof(u32_value));\n}\n\nstatic int ctrl_set_awb_mode(struct bcm2835_mmal_dev *dev,\n\t\t\t     struct v4l2_ctrl *ctrl,\n\t\t\t     const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tu32 u32_value;\n\tstruct vchiq_mmal_port *control;\n\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\tswitch (ctrl->val) {\n\tcase V4L2_WHITE_BALANCE_MANUAL:\n\t\tu32_value = MMAL_PARAM_AWBMODE_OFF;\n\t\tbreak;\n\n\tcase V4L2_WHITE_BALANCE_AUTO:\n\t\tu32_value = MMAL_PARAM_AWBMODE_AUTO;\n\t\tbreak;\n\n\tcase V4L2_WHITE_BALANCE_INCANDESCENT:\n\t\tu32_value = MMAL_PARAM_AWBMODE_INCANDESCENT;\n\t\tbreak;\n\n\tcase V4L2_WHITE_BALANCE_FLUORESCENT:\n\t\tu32_value = MMAL_PARAM_AWBMODE_FLUORESCENT;\n\t\tbreak;\n\n\tcase V4L2_WHITE_BALANCE_FLUORESCENT_H:\n\t\tu32_value = MMAL_PARAM_AWBMODE_TUNGSTEN;\n\t\tbreak;\n\n\tcase V4L2_WHITE_BALANCE_HORIZON:\n\t\tu32_value = MMAL_PARAM_AWBMODE_HORIZON;\n\t\tbreak;\n\n\tcase V4L2_WHITE_BALANCE_DAYLIGHT:\n\t\tu32_value = MMAL_PARAM_AWBMODE_SUNLIGHT;\n\t\tbreak;\n\n\tcase V4L2_WHITE_BALANCE_FLASH:\n\t\tu32_value = MMAL_PARAM_AWBMODE_FLASH;\n\t\tbreak;\n\n\tcase V4L2_WHITE_BALANCE_CLOUDY:\n\t\tu32_value = MMAL_PARAM_AWBMODE_CLOUDY;\n\t\tbreak;\n\n\tcase V4L2_WHITE_BALANCE_SHADE:\n\t\tu32_value = MMAL_PARAM_AWBMODE_SHADE;\n\t\tbreak;\n\t}\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t     mmal_ctrl->mmal_id,\n\t\t\t\t\t     &u32_value, sizeof(u32_value));\n}\n\nstatic int ctrl_set_awb_gains(struct bcm2835_mmal_dev *dev,\n\t\t\t      struct v4l2_ctrl *ctrl,\n\t\t\t      const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tstruct vchiq_mmal_port *control;\n\tstruct mmal_parameter_awbgains gains;\n\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\tif (ctrl->id == V4L2_CID_RED_BALANCE)\n\t\tdev->red_gain = ctrl->val;\n\telse if (ctrl->id == V4L2_CID_BLUE_BALANCE)\n\t\tdev->blue_gain = ctrl->val;\n\n\tgains.r_gain.numerator = dev->red_gain;\n\tgains.r_gain.denominator = 1000;\n\tgains.b_gain.numerator = dev->blue_gain;\n\tgains.b_gain.denominator = 1000;\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t     mmal_ctrl->mmal_id,\n\t\t\t\t\t     &gains, sizeof(gains));\n}\n\nstatic int ctrl_set_image_effect(struct bcm2835_mmal_dev *dev,\n\t\t\t\t struct v4l2_ctrl *ctrl,\n\t\t\t\t const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tint ret = -EINVAL;\n\tint i, j;\n\tstruct vchiq_mmal_port *control;\n\tstruct mmal_parameter_imagefx_parameters imagefx;\n\n\tfor (i = 0; i < ARRAY_SIZE(v4l2_to_mmal_effects_values); i++) {\n\t\tif (ctrl->val != v4l2_to_mmal_effects_values[i].v4l2_effect)\n\t\t\tcontinue;\n\n\t\timagefx.effect =\n\t\t\tv4l2_to_mmal_effects_values[i].mmal_effect;\n\t\timagefx.num_effect_params =\n\t\t\tv4l2_to_mmal_effects_values[i].num_effect_params;\n\n\t\tif (imagefx.num_effect_params > MMAL_MAX_IMAGEFX_PARAMETERS)\n\t\t\timagefx.num_effect_params = MMAL_MAX_IMAGEFX_PARAMETERS;\n\n\t\tfor (j = 0; j < imagefx.num_effect_params; j++)\n\t\t\timagefx.effect_parameter[j] =\n\t\t\t\tv4l2_to_mmal_effects_values[i].effect_params[j];\n\n\t\tdev->colourfx.enable =\n\t\t\tv4l2_to_mmal_effects_values[i].col_fx_enable;\n\t\tif (!v4l2_to_mmal_effects_values[i].col_fx_fixed_cbcr) {\n\t\t\tdev->colourfx.u = v4l2_to_mmal_effects_values[i].u;\n\t\t\tdev->colourfx.v = v4l2_to_mmal_effects_values[i].v;\n\t\t}\n\n\t\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\t\tret = vchiq_mmal_port_parameter_set(\n\t\t\t\tdev->instance, control,\n\t\t\t\tMMAL_PARAMETER_IMAGE_EFFECT_PARAMETERS,\n\t\t\t\t&imagefx, sizeof(imagefx));\n\t\tif (ret)\n\t\t\tgoto exit;\n\n\t\tret = vchiq_mmal_port_parameter_set(\n\t\t\t\tdev->instance, control,\n\t\t\t\tMMAL_PARAMETER_COLOUR_EFFECT,\n\t\t\t\t&dev->colourfx, sizeof(dev->colourfx));\n\t}\n\nexit:\n\tv4l2_dbg(1, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t \"mmal_ctrl:%p ctrl id:0x%x ctrl val:%d imagefx:0x%x color_effect:%s u:%d v:%d ret %d(%d)\\n\",\n\t\t\t\tmmal_ctrl, ctrl->id, ctrl->val, imagefx.effect,\n\t\t\t\tdev->colourfx.enable ? \"true\" : \"false\",\n\t\t\t\tdev->colourfx.u, dev->colourfx.v,\n\t\t\t\tret, (ret == 0 ? 0 : -EINVAL));\n\treturn (ret == 0 ? 0 : -EINVAL);\n}\n\nstatic int ctrl_set_colfx(struct bcm2835_mmal_dev *dev,\n\t\t\t  struct v4l2_ctrl *ctrl,\n\t\t\t  const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tint ret;\n\tstruct vchiq_mmal_port *control;\n\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\tdev->colourfx.u = (ctrl->val & 0xff00) >> 8;\n\tdev->colourfx.v = ctrl->val & 0xff;\n\n\tret = vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t    MMAL_PARAMETER_COLOUR_EFFECT,\n\t\t\t\t\t    &dev->colourfx,\n\t\t\t\t\t    sizeof(dev->colourfx));\n\n\tv4l2_dbg(1, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t \"%s: After: mmal_ctrl:%p ctrl id:0x%x ctrl val:%d ret %d(%d)\\n\",\n\t\t\t__func__, mmal_ctrl, ctrl->id, ctrl->val, ret,\n\t\t\t(ret == 0 ? 0 : -EINVAL));\n\treturn (ret == 0 ? 0 : -EINVAL);\n}\n\nstatic int ctrl_set_bitrate(struct bcm2835_mmal_dev *dev,\n\t\t\t    struct v4l2_ctrl *ctrl,\n\t\t\t    const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tint ret;\n\tstruct vchiq_mmal_port *encoder_out;\n\n\tdev->capture.encode_bitrate = ctrl->val;\n\n\tencoder_out = &dev->component[COMP_VIDEO_ENCODE]->output[0];\n\n\tret = vchiq_mmal_port_parameter_set(dev->instance, encoder_out,\n\t\t\t\t\t    mmal_ctrl->mmal_id, &ctrl->val,\n\t\t\t\t\t    sizeof(ctrl->val));\n\n\tv4l2_dbg(1, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t \"%s: After: mmal_ctrl:%p ctrl id:0x%x ctrl val:%d ret %d(%d)\\n\",\n\t\t __func__, mmal_ctrl, ctrl->id, ctrl->val, ret,\n\t\t (ret == 0 ? 0 : -EINVAL));\n\n\t \n\treturn 0;\n}\n\nstatic int ctrl_set_bitrate_mode(struct bcm2835_mmal_dev *dev,\n\t\t\t\t struct v4l2_ctrl *ctrl,\n\t\t\t\t const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tu32 bitrate_mode;\n\tstruct vchiq_mmal_port *encoder_out;\n\n\tencoder_out = &dev->component[COMP_VIDEO_ENCODE]->output[0];\n\n\tdev->capture.encode_bitrate_mode = ctrl->val;\n\tswitch (ctrl->val) {\n\tdefault:\n\tcase V4L2_MPEG_VIDEO_BITRATE_MODE_VBR:\n\t\tbitrate_mode = MMAL_VIDEO_RATECONTROL_VARIABLE;\n\t\tbreak;\n\tcase V4L2_MPEG_VIDEO_BITRATE_MODE_CBR:\n\t\tbitrate_mode = MMAL_VIDEO_RATECONTROL_CONSTANT;\n\t\tbreak;\n\t}\n\n\tvchiq_mmal_port_parameter_set(dev->instance, encoder_out,\n\t\t\t\t      mmal_ctrl->mmal_id,\n\t\t\t\t\t     &bitrate_mode,\n\t\t\t\t\t     sizeof(bitrate_mode));\n\treturn 0;\n}\n\nstatic int ctrl_set_image_encode_output(struct bcm2835_mmal_dev *dev,\n\t\t\t\t\tstruct v4l2_ctrl *ctrl,\n\t\t\t\t\tconst struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tu32 u32_value;\n\tstruct vchiq_mmal_port *jpeg_out;\n\n\tjpeg_out = &dev->component[COMP_IMAGE_ENCODE]->output[0];\n\n\tu32_value = ctrl->val;\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, jpeg_out,\n\t\t\t\t\t     mmal_ctrl->mmal_id,\n\t\t\t\t\t     &u32_value, sizeof(u32_value));\n}\n\nstatic int ctrl_set_video_encode_param_output(struct bcm2835_mmal_dev *dev,\n\t\t\t\t\t      struct v4l2_ctrl *ctrl,\n\t\t\t\t\t      const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tu32 u32_value;\n\tstruct vchiq_mmal_port *vid_enc_ctl;\n\n\tvid_enc_ctl = &dev->component[COMP_VIDEO_ENCODE]->output[0];\n\n\tu32_value = ctrl->val;\n\n\treturn vchiq_mmal_port_parameter_set(dev->instance, vid_enc_ctl,\n\t\t\t\t\t     mmal_ctrl->mmal_id,\n\t\t\t\t\t     &u32_value, sizeof(u32_value));\n}\n\nstatic int ctrl_set_video_encode_profile_level(struct bcm2835_mmal_dev *dev,\n\t\t\t\t\t       struct v4l2_ctrl *ctrl,\n\t\t\t\t\t       const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tstruct mmal_parameter_video_profile param;\n\tint ret = 0;\n\n\tif (ctrl->id == V4L2_CID_MPEG_VIDEO_H264_PROFILE) {\n\t\tswitch (ctrl->val) {\n\t\tcase V4L2_MPEG_VIDEO_H264_PROFILE_BASELINE:\n\t\tcase V4L2_MPEG_VIDEO_H264_PROFILE_CONSTRAINED_BASELINE:\n\t\tcase V4L2_MPEG_VIDEO_H264_PROFILE_MAIN:\n\t\tcase V4L2_MPEG_VIDEO_H264_PROFILE_HIGH:\n\t\t\tdev->capture.enc_profile = ctrl->val;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret = -EINVAL;\n\t\t\tbreak;\n\t\t}\n\t} else if (ctrl->id == V4L2_CID_MPEG_VIDEO_H264_LEVEL) {\n\t\tswitch (ctrl->val) {\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1_0:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1B:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1_1:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1_2:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1_3:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_2_0:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_2_1:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_2_2:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_3_0:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_3_1:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_3_2:\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_4_0:\n\t\t\tdev->capture.enc_level = ctrl->val;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret = -EINVAL;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (!ret) {\n\t\tswitch (dev->capture.enc_profile) {\n\t\tcase V4L2_MPEG_VIDEO_H264_PROFILE_BASELINE:\n\t\t\tparam.profile = MMAL_VIDEO_PROFILE_H264_BASELINE;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_PROFILE_CONSTRAINED_BASELINE:\n\t\t\tparam.profile =\n\t\t\t\tMMAL_VIDEO_PROFILE_H264_CONSTRAINED_BASELINE;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_PROFILE_MAIN:\n\t\t\tparam.profile = MMAL_VIDEO_PROFILE_H264_MAIN;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_PROFILE_HIGH:\n\t\t\tparam.profile = MMAL_VIDEO_PROFILE_H264_HIGH;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\n\t\tswitch (dev->capture.enc_level) {\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1_0:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_1;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1B:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_1b;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1_1:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_11;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1_2:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_12;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_1_3:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_13;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_2_0:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_2;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_2_1:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_21;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_2_2:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_22;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_3_0:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_3;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_3_1:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_31;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_3_2:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_32;\n\t\t\tbreak;\n\t\tcase V4L2_MPEG_VIDEO_H264_LEVEL_4_0:\n\t\t\tparam.level = MMAL_VIDEO_LEVEL_H264_4;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\n\t\tret = vchiq_mmal_port_parameter_set(dev->instance,\n\t\t\t\t\t\t    &dev->component[COMP_VIDEO_ENCODE]->output[0],\n\t\t\tmmal_ctrl->mmal_id,\n\t\t\t&param, sizeof(param));\n\t}\n\treturn ret;\n}\n\nstatic int ctrl_set_scene_mode(struct bcm2835_mmal_dev *dev,\n\t\t\t       struct v4l2_ctrl *ctrl,\n\t\t\t       const struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl)\n{\n\tint ret = 0;\n\tint shutter_speed;\n\tstruct vchiq_mmal_port *control;\n\n\tv4l2_dbg(0, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t \"scene mode selected %d, was %d\\n\", ctrl->val,\n\t\t dev->scene_mode);\n\tcontrol = &dev->component[COMP_CAMERA]->control;\n\n\tif (ctrl->val == dev->scene_mode)\n\t\treturn 0;\n\n\tif (ctrl->val == V4L2_SCENE_MODE_NONE) {\n\t\t \n\t\tdev->scene_mode = V4L2_SCENE_MODE_NONE;\n\n\t\tif (dev->exposure_mode_user == MMAL_PARAM_EXPOSUREMODE_OFF)\n\t\t\tshutter_speed = dev->manual_shutter_speed;\n\t\telse\n\t\t\tshutter_speed = 0;\n\n\t\tv4l2_dbg(0, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t\t \"%s: scene mode none: shut_speed %d, exp_mode %d, metering %d\\n\",\n\t\t\t __func__, shutter_speed, dev->exposure_mode_user,\n\t\t\t dev->metering_mode);\n\t\tret = vchiq_mmal_port_parameter_set(dev->instance,\n\t\t\t\t\t\t    control,\n\t\t\t\t\t\t    MMAL_PARAMETER_SHUTTER_SPEED,\n\t\t\t\t\t\t    &shutter_speed,\n\t\t\t\t\t\t    sizeof(shutter_speed));\n\t\tret += vchiq_mmal_port_parameter_set(dev->instance,\n\t\t\t\t\t\t     control,\n\t\t\t\t\t\t     MMAL_PARAMETER_EXPOSURE_MODE,\n\t\t\t\t\t\t     &dev->exposure_mode_user,\n\t\t\t\t\t\t     sizeof(u32));\n\t\tdev->exposure_mode_active = dev->exposure_mode_user;\n\t\tret += vchiq_mmal_port_parameter_set(dev->instance,\n\t\t\t\t\t\t     control,\n\t\t\t\t\t\t     MMAL_PARAMETER_EXP_METERING_MODE,\n\t\t\t\t\t\t     &dev->metering_mode,\n\t\t\t\t\t\t     sizeof(u32));\n\t\tret += set_framerate_params(dev);\n\t} else {\n\t\t \n\t\tint i;\n\t\tconst struct v4l2_mmal_scene_config *scene = NULL;\n\t\tint shutter_speed;\n\t\tenum mmal_parameter_exposuremode exposure_mode;\n\t\tenum mmal_parameter_exposuremeteringmode metering_mode;\n\n\t\tfor (i = 0; i < ARRAY_SIZE(scene_configs); i++) {\n\t\t\tif (scene_configs[i].v4l2_scene == ctrl->val) {\n\t\t\t\tscene = &scene_configs[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (!scene)\n\t\t\treturn -EINVAL;\n\t\tif (i >= ARRAY_SIZE(scene_configs))\n\t\t\treturn -EINVAL;\n\n\t\t \n\t\tdev->scene_mode = ctrl->val;\n\n\t\tif (scene->exposure_mode == MMAL_PARAM_EXPOSUREMODE_OFF)\n\t\t\tshutter_speed = dev->manual_shutter_speed;\n\t\telse\n\t\t\tshutter_speed = 0;\n\t\texposure_mode = scene->exposure_mode;\n\t\tmetering_mode = scene->metering_mode;\n\n\t\tv4l2_dbg(1, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t\t \"%s: scene mode none: shut_speed %d, exp_mode %d, metering %d\\n\",\n\t\t\t __func__, shutter_speed, exposure_mode, metering_mode);\n\n\t\tret = vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t\t    MMAL_PARAMETER_SHUTTER_SPEED,\n\t\t\t\t\t\t    &shutter_speed,\n\t\t\t\t\t\t    sizeof(shutter_speed));\n\t\tret += vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t\t     MMAL_PARAMETER_EXPOSURE_MODE,\n\t\t\t\t\t\t     &exposure_mode,\n\t\t\t\t\t\t     sizeof(u32));\n\t\tdev->exposure_mode_active = exposure_mode;\n\t\tret += vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t\t     MMAL_PARAMETER_EXPOSURE_MODE,\n\t\t\t\t\t\t     &exposure_mode,\n\t\t\t\t\t\t     sizeof(u32));\n\t\tret += vchiq_mmal_port_parameter_set(dev->instance, control,\n\t\t\t\t\t\t     MMAL_PARAMETER_EXP_METERING_MODE,\n\t\t\t\t\t\t     &metering_mode,\n\t\t\t\t\t\t     sizeof(u32));\n\t\tret += set_framerate_params(dev);\n\t}\n\tif (ret) {\n\t\tv4l2_dbg(1, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t\t \"%s: Setting scene to %d, ret=%d\\n\",\n\t\t\t __func__, ctrl->val, ret);\n\t\tret = -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic int bcm2835_mmal_s_ctrl(struct v4l2_ctrl *ctrl)\n{\n\tstruct bcm2835_mmal_dev *dev = container_of(ctrl->handler, struct bcm2835_mmal_dev,\n\t\t\t\t\t\t    ctrl_handler);\n\tconst struct bcm2835_mmal_v4l2_ctrl *mmal_ctrl = ctrl->priv;\n\tint ret;\n\n\tif (!mmal_ctrl || mmal_ctrl->id != ctrl->id || !mmal_ctrl->setter) {\n\t\tpr_warn(\"mmal_ctrl:%p ctrl id:%d\\n\", mmal_ctrl, ctrl->id);\n\t\treturn -EINVAL;\n\t}\n\n\tret = mmal_ctrl->setter(dev, ctrl, mmal_ctrl);\n\tif (ret)\n\t\tpr_warn(\"ctrl id:%d/MMAL param %08X- returned ret %d\\n\",\n\t\t\tctrl->id, mmal_ctrl->mmal_id, ret);\n\treturn ret;\n}\n\nstatic const struct v4l2_ctrl_ops bcm2835_mmal_ctrl_ops = {\n\t.s_ctrl = bcm2835_mmal_s_ctrl,\n};\n\nstatic const struct bcm2835_mmal_v4l2_ctrl v4l2_ctrls[V4L2_CTRL_COUNT] = {\n\t{\n\t\t.id = V4L2_CID_SATURATION,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = -100,\n\t\t.max = 100,\n\t\t.def = 0,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_SATURATION,\n\t\t.setter = ctrl_set_rational,\n\t},\n\t{\n\t\t.id = V4L2_CID_SHARPNESS,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = -100,\n\t\t.max = 100,\n\t\t.def = 0,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_SHARPNESS,\n\t\t.setter = ctrl_set_rational,\n\t},\n\t{\n\t\t.id = V4L2_CID_CONTRAST,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = -100,\n\t\t.max = 100,\n\t\t.def = 0,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_CONTRAST,\n\t\t.setter = ctrl_set_rational,\n\t},\n\t{\n\t\t.id = V4L2_CID_BRIGHTNESS,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 0,\n\t\t.max = 100,\n\t\t.def = 50,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_BRIGHTNESS,\n\t\t.setter = ctrl_set_rational,\n\t},\n\t{\n\t\t.id = V4L2_CID_ISO_SENSITIVITY,\n\t\t.type = MMAL_CONTROL_TYPE_INT_MENU,\n\t\t.min = 0,\n\t\t.max = ARRAY_SIZE(iso_qmenu) - 1,\n\t\t.def = 0,\n\t\t.step = 1,\n\t\t.imenu = iso_qmenu,\n\t\t.mmal_id = MMAL_PARAMETER_ISO,\n\t\t.setter = ctrl_set_iso,\n\t},\n\t{\n\t\t.id = V4L2_CID_ISO_SENSITIVITY_AUTO,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t.min = 0,\n\t\t.max = V4L2_ISO_SENSITIVITY_AUTO,\n\t\t.def = V4L2_ISO_SENSITIVITY_AUTO,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_ISO,\n\t\t.setter = ctrl_set_iso,\n\t},\n\t{\n\t\t.id = V4L2_CID_IMAGE_STABILIZATION,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 0,\n\t\t.max = 1,\n\t\t.def = 0,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_VIDEO_STABILISATION,\n\t\t.setter = ctrl_set_value,\n\t},\n\t{\n\t\t.id = V4L2_CID_EXPOSURE_AUTO,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t.min = ~0x03,\n\t\t.max = V4L2_EXPOSURE_APERTURE_PRIORITY,\n\t\t.def = V4L2_EXPOSURE_AUTO,\n\t\t.step = 0,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_EXPOSURE_MODE,\n\t\t.setter = ctrl_set_exposure,\n\t},\n\t{\n\t\t.id = V4L2_CID_EXPOSURE_ABSOLUTE,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t \n\t\t.min = 1,\n\t\t.max = 1 * 1000 * 10,\n\t\t.def = 100 * 10,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_SHUTTER_SPEED,\n\t\t.setter = ctrl_set_exposure,\n\t},\n\t{\n\t\t.id = V4L2_CID_AUTO_EXPOSURE_BIAS,\n\t\t.type = MMAL_CONTROL_TYPE_INT_MENU,\n\t\t.min = 0,\n\t\t.max = ARRAY_SIZE(ev_bias_qmenu) - 1,\n\t\t.def = (ARRAY_SIZE(ev_bias_qmenu) + 1) / 2 - 1,\n\t\t.step = 0,\n\t\t.imenu = ev_bias_qmenu,\n\t\t.mmal_id = MMAL_PARAMETER_EXPOSURE_COMP,\n\t\t.setter = ctrl_set_value_ev,\n\t},\n\t{\n\t\t.id = V4L2_CID_EXPOSURE_AUTO_PRIORITY,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 0,\n\t\t.max = 1,\n\t\t.def = 0,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t \n\t\t.mmal_id = 0,\n\t\t.setter = ctrl_set_exposure,\n\t},\n\t{\n\t\t.id = V4L2_CID_EXPOSURE_METERING,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t.min = ~0xf,\n\t\t.max = V4L2_EXPOSURE_METERING_MATRIX,\n\t\t.def = V4L2_EXPOSURE_METERING_AVERAGE,\n\t\t.step = 0,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_EXP_METERING_MODE,\n\t\t.setter = ctrl_set_metering_mode,\n\t},\n\t{\n\t\t.id = V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t.min = ~0x3ff,\n\t\t.max = V4L2_WHITE_BALANCE_SHADE,\n\t\t.def = V4L2_WHITE_BALANCE_AUTO,\n\t\t.step = 0,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_AWB_MODE,\n\t\t.setter = ctrl_set_awb_mode,\n\t},\n\t{\n\t\t.id = V4L2_CID_RED_BALANCE,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 1,\n\t\t.max = 7999,\n\t\t.def = 1000,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_CUSTOM_AWB_GAINS,\n\t\t.setter = ctrl_set_awb_gains,\n\t},\n\t{\n\t\t.id = V4L2_CID_BLUE_BALANCE,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 1,\n\t\t.max = 7999,\n\t\t.def = 1000,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_CUSTOM_AWB_GAINS,\n\t\t.setter = ctrl_set_awb_gains,\n\t},\n\t{\n\t\t.id = V4L2_CID_COLORFX,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t.min = 0,\n\t\t.max = V4L2_COLORFX_SET_CBCR,\n\t\t.def = V4L2_COLORFX_NONE,\n\t\t.step = 0,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_IMAGE_EFFECT,\n\t\t.setter = ctrl_set_image_effect,\n\t},\n\t{\n\t\t.id = V4L2_CID_COLORFX_CBCR,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 0,\n\t\t.max = 0xffff,\n\t\t.def = 0x8080,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_COLOUR_EFFECT,\n\t\t.setter = ctrl_set_colfx,\n\t},\n\t{\n\t\t.id = V4L2_CID_ROTATE,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 0,\n\t\t.max = 360,\n\t\t.def = 0,\n\t\t.step = 90,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_ROTATION,\n\t\t.setter = ctrl_set_rotate,\n\t},\n\t{\n\t\t.id = V4L2_CID_HFLIP,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 0,\n\t\t.max = 1,\n\t\t.def = 0,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_MIRROR,\n\t\t.setter = ctrl_set_flip,\n\t},\n\t{\n\t\t.id = V4L2_CID_VFLIP,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 0,\n\t\t.max = 1,\n\t\t.def = 0,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_MIRROR,\n\t\t.setter = ctrl_set_flip,\n\t},\n\t{\n\t\t.id = V4L2_CID_MPEG_VIDEO_BITRATE_MODE,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t.min = 0,\n\t\t.max = V4L2_MPEG_VIDEO_BITRATE_MODE_CBR,\n\t\t.def = 0,\n\t\t.step = 0,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_RATECONTROL,\n\t\t.setter = ctrl_set_bitrate_mode,\n\t},\n\t{\n\t\t.id = V4L2_CID_MPEG_VIDEO_BITRATE,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 25 * 1000,\n\t\t.max = 25 * 1000 * 1000,\n\t\t.def = 10 * 1000 * 1000,\n\t\t.step = 25 * 1000,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_VIDEO_BIT_RATE,\n\t\t.setter = ctrl_set_bitrate,\n\t},\n\t{\n\t\t.id = V4L2_CID_JPEG_COMPRESSION_QUALITY,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 1,\n\t\t.max = 100,\n\t\t.def = 30,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_JPEG_Q_FACTOR,\n\t\t.setter = ctrl_set_image_encode_output,\n\t},\n\t{\n\t\t.id = V4L2_CID_POWER_LINE_FREQUENCY,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t.min = 0,\n\t\t.max = V4L2_CID_POWER_LINE_FREQUENCY_AUTO,\n\t\t.def = 1,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_FLICKER_AVOID,\n\t\t.setter = ctrl_set_flicker_avoidance,\n\t},\n\t{\n\t\t.id = V4L2_CID_MPEG_VIDEO_REPEAT_SEQ_HEADER,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 0,\n\t\t.max = 1,\n\t\t.def = 0,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_VIDEO_ENCODE_INLINE_HEADER,\n\t\t.setter = ctrl_set_video_encode_param_output,\n\t},\n\t{\n\t\t.id = V4L2_CID_MPEG_VIDEO_H264_PROFILE,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t.min = ~(BIT(V4L2_MPEG_VIDEO_H264_PROFILE_BASELINE) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_PROFILE_CONSTRAINED_BASELINE) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_PROFILE_MAIN) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_PROFILE_HIGH)),\n\t\t.max = V4L2_MPEG_VIDEO_H264_PROFILE_HIGH,\n\t\t.def = V4L2_MPEG_VIDEO_H264_PROFILE_HIGH,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_PROFILE,\n\t\t.setter = ctrl_set_video_encode_profile_level,\n\t},\n\t{\n\t\t.id = V4L2_CID_MPEG_VIDEO_H264_LEVEL,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t.min = ~(BIT(V4L2_MPEG_VIDEO_H264_LEVEL_1_0) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_1B) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_1_1) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_1_2) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_1_3) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_2_0) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_2_1) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_2_2) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_3_0) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_3_1) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_3_2) |\n\t\t\t BIT(V4L2_MPEG_VIDEO_H264_LEVEL_4_0)),\n\t\t.max = V4L2_MPEG_VIDEO_H264_LEVEL_4_0,\n\t\t.def = V4L2_MPEG_VIDEO_H264_LEVEL_4_0,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_PROFILE,\n\t\t.setter = ctrl_set_video_encode_profile_level,\n\t},\n\t{\n\t\t.id = V4L2_CID_SCENE_MODE,\n\t\t.type = MMAL_CONTROL_TYPE_STD_MENU,\n\t\t \n\t\t.min = -1,\n\t\t.max = V4L2_SCENE_MODE_TEXT,\n\t\t.def = V4L2_SCENE_MODE_NONE,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_PROFILE,\n\t\t.setter = ctrl_set_scene_mode,\n\t},\n\t{\n\t\t.id = V4L2_CID_MPEG_VIDEO_H264_I_PERIOD,\n\t\t.type = MMAL_CONTROL_TYPE_STD,\n\t\t.min = 0,\n\t\t.max = 0x7FFFFFFF,\n\t\t.def = 60,\n\t\t.step = 1,\n\t\t.imenu = NULL,\n\t\t.mmal_id = MMAL_PARAMETER_INTRAPERIOD,\n\t\t.setter = ctrl_set_video_encode_param_output,\n\t},\n};\n\nint bcm2835_mmal_set_all_camera_controls(struct bcm2835_mmal_dev *dev)\n{\n\tint c;\n\tint ret = 0;\n\n\tfor (c = 0; c < V4L2_CTRL_COUNT; c++) {\n\t\tif ((dev->ctrls[c]) && (v4l2_ctrls[c].setter)) {\n\t\t\tret = v4l2_ctrls[c].setter(dev, dev->ctrls[c],\n\t\t\t\t\t\t   &v4l2_ctrls[c]);\n\t\t\tif (ret) {\n\t\t\t\tv4l2_dbg(1, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t\t\t\t \"Failed when setting default values for ctrl %d\\n\",\n\t\t\t\t\t c);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn ret;\n}\n\nint set_framerate_params(struct bcm2835_mmal_dev *dev)\n{\n\tstruct mmal_parameter_fps_range fps_range;\n\tint ret;\n\n\tfps_range.fps_high.numerator = dev->capture.timeperframe.denominator;\n\tfps_range.fps_high.denominator = dev->capture.timeperframe.numerator;\n\n\tif ((dev->exposure_mode_active != MMAL_PARAM_EXPOSUREMODE_OFF) &&\n\t    (dev->exp_auto_priority)) {\n\t\t \n\t\tfps_range.fps_low.numerator = 1;\n\t\tfps_range.fps_low.denominator = 1;\n\t} else {\n\t\t \n\t\tfps_range.fps_low.numerator = fps_range.fps_high.numerator;\n\t\tfps_range.fps_low.denominator = fps_range.fps_high.denominator;\n\t}\n\n\tv4l2_dbg(1, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t \"Set fps range to %d/%d to %d/%d\\n\",\n\t\t fps_range.fps_low.numerator,\n\t\t fps_range.fps_low.denominator,\n\t\t fps_range.fps_high.numerator,\n\t\t fps_range.fps_high.denominator);\n\n\tret = vchiq_mmal_port_parameter_set(dev->instance,\n\t\t\t\t\t    &dev->component[COMP_CAMERA]->output[CAM_PORT_PREVIEW],\n\t\t\t\t\t    MMAL_PARAMETER_FPS_RANGE,\n\t\t\t\t\t    &fps_range, sizeof(fps_range));\n\tret += vchiq_mmal_port_parameter_set(dev->instance,\n\t\t\t\t\t     &dev->component[COMP_CAMERA]->output[CAM_PORT_VIDEO],\n\t\t\t\t\t     MMAL_PARAMETER_FPS_RANGE,\n\t\t\t\t\t     &fps_range, sizeof(fps_range));\n\tret += vchiq_mmal_port_parameter_set(dev->instance,\n\t\t\t\t\t     &dev->component[COMP_CAMERA]->output[CAM_PORT_CAPTURE],\n\t\t\t\t\t     MMAL_PARAMETER_FPS_RANGE,\n\t\t\t\t\t     &fps_range, sizeof(fps_range));\n\tif (ret)\n\t\tv4l2_dbg(0, bcm2835_v4l2_debug, &dev->v4l2_dev,\n\t\t\t \"Failed to set fps ret %d\\n\", ret);\n\n\treturn ret;\n}\n\nint bcm2835_mmal_init_controls(struct bcm2835_mmal_dev *dev, struct v4l2_ctrl_handler *hdl)\n{\n\tint c;\n\tconst struct bcm2835_mmal_v4l2_ctrl *ctrl;\n\n\tv4l2_ctrl_handler_init(hdl, V4L2_CTRL_COUNT);\n\n\tfor (c = 0; c < V4L2_CTRL_COUNT; c++) {\n\t\tctrl = &v4l2_ctrls[c];\n\n\t\tswitch (ctrl->type) {\n\t\tcase MMAL_CONTROL_TYPE_STD:\n\t\t\tdev->ctrls[c] = v4l2_ctrl_new_std(hdl, &bcm2835_mmal_ctrl_ops,\n\t\t\t\t\t\t\t  ctrl->id, ctrl->min, ctrl->max,\n\t\t\t\t\t\t\t  ctrl->step, ctrl->def);\n\t\t\tbreak;\n\n\t\tcase MMAL_CONTROL_TYPE_STD_MENU:\n\t\t{\n\t\t\tu64 mask = ctrl->min;\n\n\t\t\tif (ctrl->id == V4L2_CID_SCENE_MODE) {\n\t\t\t\t \n\t\t\t\tint i;\n\n\t\t\t\tmask = BIT(V4L2_SCENE_MODE_NONE);\n\t\t\t\tfor (i = 0;\n\t\t\t\t     i < ARRAY_SIZE(scene_configs);\n\t\t\t\t     i++) {\n\t\t\t\t\tmask |= BIT(scene_configs[i].v4l2_scene);\n\t\t\t\t}\n\t\t\t\tmask = ~mask;\n\t\t\t}\n\n\t\t\tdev->ctrls[c] = v4l2_ctrl_new_std_menu(hdl, &bcm2835_mmal_ctrl_ops,\n\t\t\t\t\t\t\t       ctrl->id, ctrl->max, mask,\n\t\t\t\t\t\t\t       ctrl->def);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase MMAL_CONTROL_TYPE_INT_MENU:\n\t\t\tdev->ctrls[c] = v4l2_ctrl_new_int_menu(hdl, &bcm2835_mmal_ctrl_ops,\n\t\t\t\t\t\t\t       ctrl->id, ctrl->max,\n\t\t\t\t\t\t\t       ctrl->def, ctrl->imenu);\n\t\t\tbreak;\n\n\t\tcase MMAL_CONTROL_TYPE_CLUSTER:\n\t\t\t \n\t\t\tcontinue;\n\t\t}\n\n\t\tif (hdl->error)\n\t\t\tbreak;\n\n\t\tdev->ctrls[c]->priv = (void *)ctrl;\n\t}\n\n\tif (hdl->error) {\n\t\tpr_err(\"error adding control %d/%d id 0x%x\\n\", c,\n\t\t       V4L2_CTRL_COUNT, ctrl->id);\n\t\treturn hdl->error;\n\t}\n\n\tfor (c = 0; c < V4L2_CTRL_COUNT; c++) {\n\t\tctrl = &v4l2_ctrls[c];\n\n\t\tswitch (ctrl->type) {\n\t\tcase MMAL_CONTROL_TYPE_CLUSTER:\n\t\t\tv4l2_ctrl_auto_cluster(ctrl->min,\n\t\t\t\t\t       &dev->ctrls[c + 1],\n\t\t\t\t\t       ctrl->max,\n\t\t\t\t\t       ctrl->def);\n\t\t\tbreak;\n\n\t\tcase MMAL_CONTROL_TYPE_STD:\n\t\tcase MMAL_CONTROL_TYPE_STD_MENU:\n\t\tcase MMAL_CONTROL_TYPE_INT_MENU:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}