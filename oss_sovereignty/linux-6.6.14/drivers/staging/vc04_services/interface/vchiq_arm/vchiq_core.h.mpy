{
  "module_name": "vchiq_core.h",
  "hash_id": "588e2b7c78d078bf26f470b8e5de29dd3b717d2d49af1dd6f97eef9c8e0d9120",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/vc04_services/interface/vchiq_arm/vchiq_core.h",
  "human_readable_source": " \n \n\n#ifndef VCHIQ_CORE_H\n#define VCHIQ_CORE_H\n\n#include <linux/mutex.h>\n#include <linux/completion.h>\n#include <linux/kthread.h>\n#include <linux/kref.h>\n#include <linux/rcupdate.h>\n#include <linux/wait.h>\n\n#include \"../../include/linux/raspberrypi/vchiq.h\"\n#include \"vchiq_cfg.h\"\n\n \n#if IS_ENABLED(CONFIG_RASPBERRYPI_FIRMWARE)\n\n#else\n\n#ifndef dsb\n#define dsb(a)\n#endif\n\n#endif\t \n\n#define VCHIQ_SERVICE_HANDLE_INVALID 0\n\n#define VCHIQ_SLOT_SIZE     4096\n#define VCHIQ_MAX_MSG_SIZE  (VCHIQ_SLOT_SIZE - sizeof(struct vchiq_header))\n\n \n#define VCHIQ_LOG_DEFAULT  4\n#define VCHIQ_LOG_ERROR    3\n#define VCHIQ_LOG_WARNING  4\n#define VCHIQ_LOG_INFO     6\n#define VCHIQ_LOG_TRACE    7\n\n#define VCHIQ_LOG_PREFIX   KERN_INFO \"vchiq: \"\n\n#ifndef vchiq_log_error\n#define vchiq_log_error(cat, fmt, ...) \\\n\tdo { if (cat >= VCHIQ_LOG_ERROR) \\\n\t\tprintk(VCHIQ_LOG_PREFIX fmt \"\\n\", ##__VA_ARGS__); } while (0)\n#endif\n#ifndef vchiq_log_warning\n#define vchiq_log_warning(cat, fmt, ...) \\\n\tdo { if (cat >= VCHIQ_LOG_WARNING) \\\n\t\t printk(VCHIQ_LOG_PREFIX fmt \"\\n\", ##__VA_ARGS__); } while (0)\n#endif\n#ifndef vchiq_log_info\n#define vchiq_log_info(cat, fmt, ...) \\\n\tdo { if (cat >= VCHIQ_LOG_INFO) \\\n\t\tprintk(VCHIQ_LOG_PREFIX fmt \"\\n\", ##__VA_ARGS__); } while (0)\n#endif\n#ifndef vchiq_log_trace\n#define vchiq_log_trace(cat, fmt, ...) \\\n\tdo { if (cat >= VCHIQ_LOG_TRACE) \\\n\t\tprintk(VCHIQ_LOG_PREFIX fmt \"\\n\", ##__VA_ARGS__); } while (0)\n#endif\n\n#define vchiq_loud_error(...) \\\n\tvchiq_log_error(vchiq_core_log_level, \"===== \" __VA_ARGS__)\n\n#define VCHIQ_SLOT_MASK        (VCHIQ_SLOT_SIZE - 1)\n#define VCHIQ_SLOT_QUEUE_MASK  (VCHIQ_MAX_SLOTS_PER_SIDE - 1)\n#define VCHIQ_SLOT_ZERO_SLOTS  DIV_ROUND_UP(sizeof(struct vchiq_slot_zero), \\\n\t\t\t\t\t    VCHIQ_SLOT_SIZE)\n\n#define VCHIQ_FOURCC_AS_4CHARS(fourcc)\t\\\n\t((fourcc) >> 24) & 0xff, \\\n\t((fourcc) >> 16) & 0xff, \\\n\t((fourcc) >>  8) & 0xff, \\\n\t(fourcc) & 0xff\n\n#define BITSET_SIZE(b)        ((b + 31) >> 5)\n#define BITSET_WORD(b)        (b >> 5)\n#define BITSET_BIT(b)         (1 << (b & 31))\n#define BITSET_IS_SET(bs, b)  (bs[BITSET_WORD(b)] & BITSET_BIT(b))\n#define BITSET_SET(bs, b)     (bs[BITSET_WORD(b)] |= BITSET_BIT(b))\n\nenum {\n\tDEBUG_ENTRIES,\n#if VCHIQ_ENABLE_DEBUG\n\tDEBUG_SLOT_HANDLER_COUNT,\n\tDEBUG_SLOT_HANDLER_LINE,\n\tDEBUG_PARSE_LINE,\n\tDEBUG_PARSE_HEADER,\n\tDEBUG_PARSE_MSGID,\n\tDEBUG_AWAIT_COMPLETION_LINE,\n\tDEBUG_DEQUEUE_MESSAGE_LINE,\n\tDEBUG_SERVICE_CALLBACK_LINE,\n\tDEBUG_MSG_QUEUE_FULL_COUNT,\n\tDEBUG_COMPLETION_QUEUE_FULL_COUNT,\n#endif\n\tDEBUG_MAX\n};\n\n#if VCHIQ_ENABLE_DEBUG\n\n#define DEBUG_INITIALISE(local) int *debug_ptr = (local)->debug\n#define DEBUG_TRACE(d) \\\n\tdo { debug_ptr[DEBUG_ ## d] = __LINE__; dsb(sy); } while (0)\n#define DEBUG_VALUE(d, v) \\\n\tdo { debug_ptr[DEBUG_ ## d] = (v); dsb(sy); } while (0)\n#define DEBUG_COUNT(d) \\\n\tdo { debug_ptr[DEBUG_ ## d]++; dsb(sy); } while (0)\n\n#else  \n\n#define DEBUG_INITIALISE(local)\n#define DEBUG_TRACE(d)\n#define DEBUG_VALUE(d, v)\n#define DEBUG_COUNT(d)\n\n#endif  \n\nenum vchiq_connstate {\n\tVCHIQ_CONNSTATE_DISCONNECTED,\n\tVCHIQ_CONNSTATE_CONNECTING,\n\tVCHIQ_CONNSTATE_CONNECTED,\n\tVCHIQ_CONNSTATE_PAUSING,\n\tVCHIQ_CONNSTATE_PAUSE_SENT,\n\tVCHIQ_CONNSTATE_PAUSED,\n\tVCHIQ_CONNSTATE_RESUMING,\n\tVCHIQ_CONNSTATE_PAUSE_TIMEOUT,\n\tVCHIQ_CONNSTATE_RESUME_TIMEOUT\n};\n\nenum {\n\tVCHIQ_SRVSTATE_FREE,\n\tVCHIQ_SRVSTATE_HIDDEN,\n\tVCHIQ_SRVSTATE_LISTENING,\n\tVCHIQ_SRVSTATE_OPENING,\n\tVCHIQ_SRVSTATE_OPEN,\n\tVCHIQ_SRVSTATE_OPENSYNC,\n\tVCHIQ_SRVSTATE_CLOSESENT,\n\tVCHIQ_SRVSTATE_CLOSERECVD,\n\tVCHIQ_SRVSTATE_CLOSEWAIT,\n\tVCHIQ_SRVSTATE_CLOSED\n};\n\nenum vchiq_bulk_dir {\n\tVCHIQ_BULK_TRANSMIT,\n\tVCHIQ_BULK_RECEIVE\n};\n\nstruct vchiq_bulk {\n\tshort mode;\n\tshort dir;\n\tvoid *userdata;\n\tdma_addr_t data;\n\tint size;\n\tvoid *remote_data;\n\tint remote_size;\n\tint actual;\n};\n\nstruct vchiq_bulk_queue {\n\tint local_insert;   \n\tint remote_insert;  \n\tint process;        \n\tint remote_notify;  \n\tint remove;         \n\tstruct vchiq_bulk bulks[VCHIQ_NUM_SERVICE_BULKS];\n};\n\n \nstruct remote_event {\n\tint armed;\n\tint fired;\n\tu32 __unused;\n};\n\nstruct opaque_platform_state;\n\nstruct vchiq_slot {\n\tchar data[VCHIQ_SLOT_SIZE];\n};\n\nstruct vchiq_slot_info {\n\t \n\tshort use_count;\n\tshort release_count;\n};\n\nstruct vchiq_service {\n\tstruct vchiq_service_base base;\n\tunsigned int handle;\n\tstruct kref ref_count;\n\tstruct rcu_head rcu;\n\tint srvstate;\n\tvoid (*userdata_term)(void *userdata);\n\tunsigned int localport;\n\tunsigned int remoteport;\n\tint public_fourcc;\n\tint client_id;\n\tchar auto_close;\n\tchar sync;\n\tchar closing;\n\tchar trace;\n\tatomic_t poll_flags;\n\tshort version;\n\tshort version_min;\n\tshort peer_version;\n\n\tstruct vchiq_state *state;\n\tstruct vchiq_instance *instance;\n\n\tint service_use_count;\n\n\tstruct vchiq_bulk_queue bulk_tx;\n\tstruct vchiq_bulk_queue bulk_rx;\n\n\tstruct completion remove_event;\n\tstruct completion bulk_remove_event;\n\tstruct mutex bulk_mutex;\n\n\tstruct service_stats_struct {\n\t\tint quota_stalls;\n\t\tint slot_stalls;\n\t\tint bulk_stalls;\n\t\tint error_count;\n\t\tint ctrl_tx_count;\n\t\tint ctrl_rx_count;\n\t\tint bulk_tx_count;\n\t\tint bulk_rx_count;\n\t\tint bulk_aborted_count;\n\t\tu64 ctrl_tx_bytes;\n\t\tu64 ctrl_rx_bytes;\n\t\tu64 bulk_tx_bytes;\n\t\tu64 bulk_rx_bytes;\n\t} stats;\n\n\tint msg_queue_read;\n\tint msg_queue_write;\n\tstruct completion msg_queue_pop;\n\tstruct completion msg_queue_push;\n\tstruct vchiq_header *msg_queue[VCHIQ_MAX_SLOTS];\n};\n\n \nstruct vchiq_service_quota {\n\tunsigned short slot_quota;\n\tunsigned short slot_use_count;\n\tunsigned short message_quota;\n\tunsigned short message_use_count;\n\tstruct completion quota_event;\n\tint previous_tx_index;\n};\n\nstruct vchiq_shared_state {\n\t \n\tint initialised;\n\n\t \n\tint slot_first;\n\tint slot_last;\n\n\t \n\tint slot_sync;\n\n\t \n\tstruct remote_event trigger;\n\n\t \n\tint tx_pos;\n\n\t \n\tstruct remote_event recycle;\n\n\t \n\tint slot_queue_recycle;\n\n\t \n\tstruct remote_event sync_trigger;\n\n\t \n\tstruct remote_event sync_release;\n\n\t \n\tint slot_queue[VCHIQ_MAX_SLOTS_PER_SIDE];\n\n\t \n\tint debug[DEBUG_MAX];\n};\n\nstruct vchiq_slot_zero {\n\tint magic;\n\tshort version;\n\tshort version_min;\n\tint slot_zero_size;\n\tint slot_size;\n\tint max_slots;\n\tint max_slots_per_side;\n\tint platform_data[2];\n\tstruct vchiq_shared_state master;\n\tstruct vchiq_shared_state slave;\n\tstruct vchiq_slot_info slots[VCHIQ_MAX_SLOTS];\n};\n\nstruct vchiq_state {\n\tstruct device *dev;\n\tint id;\n\tint initialised;\n\tenum vchiq_connstate conn_state;\n\tshort version_common;\n\n\tstruct vchiq_shared_state *local;\n\tstruct vchiq_shared_state *remote;\n\tstruct vchiq_slot *slot_data;\n\n\tunsigned short default_slot_quota;\n\tunsigned short default_message_quota;\n\n\t \n\tstruct completion connect;\n\n\t \n\tstruct mutex mutex;\n\tstruct vchiq_instance **instance;\n\n\t \n\tstruct task_struct *slot_handler_thread;\n\n\t \n\tstruct task_struct *recycle_thread;\n\n\t \n\tstruct task_struct *sync_thread;\n\n\t \n\twait_queue_head_t trigger_event;\n\n\t \n\twait_queue_head_t recycle_event;\n\n\t \n\twait_queue_head_t sync_trigger_event;\n\n\t \n\twait_queue_head_t sync_release_event;\n\n\tchar *tx_data;\n\tchar *rx_data;\n\tstruct vchiq_slot_info *rx_info;\n\n\tstruct mutex slot_mutex;\n\n\tstruct mutex recycle_mutex;\n\n\tstruct mutex sync_mutex;\n\n\tstruct mutex bulk_transfer_mutex;\n\n\t \n\tint rx_pos;\n\n\t \n\tint local_tx_pos;\n\n\t \n\tint slot_queue_available;\n\n\t \n\tint poll_needed;\n\n\t \n\tint previous_data_index;\n\n\t \n\tunsigned short data_use_count;\n\n\t \n\tunsigned short data_quota;\n\n\t \n\tatomic_t poll_services[BITSET_SIZE(VCHIQ_MAX_SERVICES)];\n\n\t \n\tint unused_service;\n\n\t \n\tstruct completion slot_available_event;\n\n\tstruct completion slot_remove_event;\n\n\t \n\tstruct completion data_quota_event;\n\n\tstruct state_stats_struct {\n\t\tint slot_stalls;\n\t\tint data_stalls;\n\t\tint ctrl_tx_count;\n\t\tint ctrl_rx_count;\n\t\tint error_count;\n\t} stats;\n\n\tstruct vchiq_service __rcu *services[VCHIQ_MAX_SERVICES];\n\tstruct vchiq_service_quota service_quotas[VCHIQ_MAX_SERVICES];\n\tstruct vchiq_slot_info slot_info[VCHIQ_MAX_SLOTS];\n\n\tstruct opaque_platform_state *platform_state;\n};\n\nstruct bulk_waiter {\n\tstruct vchiq_bulk *bulk;\n\tstruct completion event;\n\tint actual;\n};\n\nstruct vchiq_config {\n\tunsigned int max_msg_size;\n\tunsigned int bulk_threshold;\t \n\tunsigned int max_outstanding_bulks;\n\tunsigned int max_services;\n\tshort version;       \n\tshort version_min;   \n};\n\nextern spinlock_t bulk_waiter_spinlock;\n\nextern int vchiq_core_log_level;\nextern int vchiq_core_msg_log_level;\nextern int vchiq_sync_log_level;\n\nextern const char *\nget_conn_state_name(enum vchiq_connstate conn_state);\n\nextern struct vchiq_slot_zero *\nvchiq_init_slots(void *mem_base, int mem_size);\n\nextern int\nvchiq_init_state(struct vchiq_state *state, struct vchiq_slot_zero *slot_zero, struct device *dev);\n\nextern int\nvchiq_connect_internal(struct vchiq_state *state, struct vchiq_instance *instance);\n\nstruct vchiq_service *\nvchiq_add_service_internal(struct vchiq_state *state,\n\t\t\t   const struct vchiq_service_params_kernel *params,\n\t\t\t   int srvstate, struct vchiq_instance *instance,\n\t\t\t   void (*userdata_term)(void *userdata));\n\nextern int\nvchiq_open_service_internal(struct vchiq_service *service, int client_id);\n\nextern int\nvchiq_close_service_internal(struct vchiq_service *service, int close_recvd);\n\nextern void\nvchiq_terminate_service_internal(struct vchiq_service *service);\n\nextern void\nvchiq_free_service_internal(struct vchiq_service *service);\n\nextern void\nvchiq_shutdown_internal(struct vchiq_state *state, struct vchiq_instance *instance);\n\nextern void\nremote_event_pollall(struct vchiq_state *state);\n\nextern int\nvchiq_bulk_transfer(struct vchiq_instance *instance, unsigned int handle, void *offset,\n\t\t    void __user *uoffset, int size, void *userdata, enum vchiq_bulk_mode mode,\n\t\t    enum vchiq_bulk_dir dir);\n\nextern int\nvchiq_dump_state(void *dump_context, struct vchiq_state *state);\n\nextern int\nvchiq_dump_service_state(void *dump_context, struct vchiq_service *service);\n\nextern void\nvchiq_loud_error_header(void);\n\nextern void\nvchiq_loud_error_footer(void);\n\nextern void\nrequest_poll(struct vchiq_state *state, struct vchiq_service *service,\n\t     int poll_type);\n\nstruct vchiq_service *handle_to_service(struct vchiq_instance *instance, unsigned int handle);\n\nextern struct vchiq_service *\nfind_service_by_handle(struct vchiq_instance *instance, unsigned int handle);\n\nextern struct vchiq_service *\nfind_service_by_port(struct vchiq_state *state, unsigned int localport);\n\nextern struct vchiq_service *\nfind_service_for_instance(struct vchiq_instance *instance, unsigned int handle);\n\nextern struct vchiq_service *\nfind_closed_service_for_instance(struct vchiq_instance *instance, unsigned int handle);\n\nextern struct vchiq_service *\n__next_service_by_instance(struct vchiq_state *state,\n\t\t\t   struct vchiq_instance *instance,\n\t\t\t   int *pidx);\n\nextern struct vchiq_service *\nnext_service_by_instance(struct vchiq_state *state,\n\t\t\t struct vchiq_instance *instance,\n\t\t\t int *pidx);\n\nextern void\nvchiq_service_get(struct vchiq_service *service);\n\nextern void\nvchiq_service_put(struct vchiq_service *service);\n\nextern int\nvchiq_queue_message(struct vchiq_instance *instance, unsigned int handle,\n\t\t    ssize_t (*copy_callback)(void *context, void *dest,\n\t\t\t\t\t     size_t offset, size_t maxsize),\n\t\t    void *context,\n\t\t    size_t size);\n\nint vchiq_prepare_bulk_data(struct vchiq_instance *instance, struct vchiq_bulk *bulk, void *offset,\n\t\t\t    void __user *uoffset, int size, int dir);\n\nvoid vchiq_complete_bulk(struct vchiq_instance *instance, struct vchiq_bulk *bulk);\n\nvoid remote_event_signal(struct remote_event *event);\n\nint vchiq_dump(void *dump_context, const char *str, int len);\n\nint vchiq_dump_platform_state(void *dump_context);\n\nint vchiq_dump_platform_instances(void *dump_context);\n\nint vchiq_dump_platform_service_state(void *dump_context, struct vchiq_service *service);\n\nint vchiq_use_service_internal(struct vchiq_service *service);\n\nint vchiq_release_service_internal(struct vchiq_service *service);\n\nvoid vchiq_on_remote_use(struct vchiq_state *state);\n\nvoid vchiq_on_remote_release(struct vchiq_state *state);\n\nint vchiq_platform_init_state(struct vchiq_state *state);\n\nint vchiq_check_service(struct vchiq_service *service);\n\nvoid vchiq_on_remote_use_active(struct vchiq_state *state);\n\nint vchiq_send_remote_use(struct vchiq_state *state);\n\nint vchiq_send_remote_use_active(struct vchiq_state *state);\n\nvoid vchiq_platform_conn_state_changed(struct vchiq_state *state,\n\t\t\t\t       enum vchiq_connstate oldstate,\n\t\t\t\t  enum vchiq_connstate newstate);\n\nvoid vchiq_set_conn_state(struct vchiq_state *state, enum vchiq_connstate newstate);\n\nvoid vchiq_log_dump_mem(const char *label, u32 addr, const void *void_mem, size_t num_bytes);\n\nint vchiq_remove_service(struct vchiq_instance *instance, unsigned int service);\n\nint vchiq_get_client_id(struct vchiq_instance *instance, unsigned int service);\n\nvoid vchiq_get_config(struct vchiq_config *config);\n\nint vchiq_set_service_option(struct vchiq_instance *instance, unsigned int service,\n\t\t\t     enum vchiq_service_option option, int value);\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}