{
  "module_name": "sd.c",
  "hash_id": "b57139532f24e17e97870eb4b05c84797bfcfa487cfc0b64f0d3a35ad86834c5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rts5208/sd.c",
  "human_readable_source": "\n \n\n#include <linux/blkdev.h>\n#include <linux/kthread.h>\n#include <linux/sched.h>\n\n#include \"rtsx.h\"\n#include \"sd.h\"\n\n#define SD_MAX_RETRY_COUNT\t3\n\nstatic u16 REG_SD_CFG1;\nstatic u16 REG_SD_CFG2;\nstatic u16 REG_SD_CFG3;\nstatic u16 REG_SD_STAT1;\nstatic u16 REG_SD_STAT2;\nstatic u16 REG_SD_BUS_STAT;\nstatic u16 REG_SD_PAD_CTL;\nstatic u16 REG_SD_SAMPLE_POINT_CTL;\nstatic u16 REG_SD_PUSH_POINT_CTL;\nstatic u16 REG_SD_CMD0;\nstatic u16 REG_SD_CMD1;\nstatic u16 REG_SD_CMD2;\nstatic u16 REG_SD_CMD3;\nstatic u16 REG_SD_CMD4;\nstatic u16 REG_SD_CMD5;\nstatic u16 REG_SD_BYTE_CNT_L;\nstatic u16 REG_SD_BYTE_CNT_H;\nstatic u16 REG_SD_BLOCK_CNT_L;\nstatic u16 REG_SD_BLOCK_CNT_H;\nstatic u16 REG_SD_TRANSFER;\nstatic u16 REG_SD_VPCLK0_CTL;\nstatic u16 REG_SD_VPCLK1_CTL;\nstatic u16 REG_SD_DCMPS0_CTL;\nstatic u16 REG_SD_DCMPS1_CTL;\n\nstatic inline void sd_set_err_code(struct rtsx_chip *chip, u8 err_code)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\n\tsd_card->err_code |= err_code;\n}\n\nstatic inline void sd_clr_err_code(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\n\tsd_card->err_code = 0;\n}\n\nstatic inline int sd_check_err_code(struct rtsx_chip *chip, u8 err_code)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\n\treturn sd_card->err_code & err_code;\n}\n\nstatic void sd_init_reg_addr(struct rtsx_chip *chip)\n{\n\tREG_SD_CFG1 = 0xFD31;\n\tREG_SD_CFG2 = 0xFD33;\n\tREG_SD_CFG3 = 0xFD3E;\n\tREG_SD_STAT1 = 0xFD30;\n\tREG_SD_STAT2 = 0;\n\tREG_SD_BUS_STAT = 0;\n\tREG_SD_PAD_CTL = 0;\n\tREG_SD_SAMPLE_POINT_CTL = 0;\n\tREG_SD_PUSH_POINT_CTL = 0;\n\tREG_SD_CMD0 = 0xFD34;\n\tREG_SD_CMD1 = 0xFD35;\n\tREG_SD_CMD2 = 0xFD36;\n\tREG_SD_CMD3 = 0xFD37;\n\tREG_SD_CMD4 = 0xFD38;\n\tREG_SD_CMD5 = 0xFD5A;\n\tREG_SD_BYTE_CNT_L = 0xFD39;\n\tREG_SD_BYTE_CNT_H = 0xFD3A;\n\tREG_SD_BLOCK_CNT_L = 0xFD3B;\n\tREG_SD_BLOCK_CNT_H = 0xFD3C;\n\tREG_SD_TRANSFER = 0xFD32;\n\tREG_SD_VPCLK0_CTL = 0;\n\tREG_SD_VPCLK1_CTL = 0;\n\tREG_SD_DCMPS0_CTL = 0;\n\tREG_SD_DCMPS1_CTL = 0;\n}\n\nstatic int sd_check_data0_status(struct rtsx_chip *chip)\n{\n\tint retval;\n\tu8 stat;\n\n\tretval = rtsx_read_register(chip, REG_SD_STAT1, &stat);\n\tif (retval)\n\t\treturn retval;\n\n\tif (!(stat & SD_DAT0_STATUS)) {\n\t\tsd_set_err_code(chip, SD_BUSY);\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_send_cmd_get_rsp(struct rtsx_chip *chip, u8 cmd_idx,\n\t\t\t       u32 arg, u8 rsp_type, u8 *rsp, int rsp_len)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tint timeout = 100;\n\tu16 reg_addr;\n\tu8 *ptr;\n\tint stat_idx = 0;\n\tint rty_cnt = 0;\n\n\tsd_clr_err_code(chip);\n\n\tdev_dbg(rtsx_dev(chip), \"SD/MMC CMD %d, arg = 0x%08x\\n\", cmd_idx, arg);\n\n\tif (rsp_type == SD_RSP_TYPE_R1b)\n\t\ttimeout = 3000;\n\nRTY_SEND_CMD:\n\n\trtsx_init_cmd(chip);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF, 0x40 | cmd_idx);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD1, 0xFF, (u8)(arg >> 24));\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD2, 0xFF, (u8)(arg >> 16));\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD3, 0xFF, (u8)(arg >> 8));\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD4, 0xFF, (u8)arg);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF, rsp_type);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE,\n\t\t     0x01, PINGPONG_BUFFER);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER,\n\t\t     0xFF, SD_TM_CMD_RSP | SD_TRANSFER_START);\n\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\n\t\t     SD_TRANSFER_END | SD_STAT_IDLE, SD_TRANSFER_END |\n\t\t     SD_STAT_IDLE);\n\n\tif (rsp_type == SD_RSP_TYPE_R2) {\n\t\tfor (reg_addr = PPBUF_BASE2; reg_addr < PPBUF_BASE2 + 16;\n\t\t     reg_addr++)\n\t\t\trtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0, 0);\n\n\t\tstat_idx = 16;\n\t} else if (rsp_type != SD_RSP_TYPE_R0) {\n\t\tfor (reg_addr = REG_SD_CMD0; reg_addr <= REG_SD_CMD4;\n\t\t     reg_addr++)\n\t\t\trtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0, 0);\n\n\t\tstat_idx = 5;\n\t}\n\n\trtsx_add_cmd(chip, READ_REG_CMD, REG_SD_STAT1, 0, 0);\n\n\tretval = rtsx_send_cmd(chip, SD_CARD, timeout);\n\tif (retval < 0) {\n\t\tu8 val;\n\n\t\trtsx_read_register(chip, REG_SD_STAT1, &val);\n\t\tdev_dbg(rtsx_dev(chip), \"SD_STAT1: 0x%x\\n\", val);\n\n\t\trtsx_read_register(chip, REG_SD_CFG3, &val);\n\t\tdev_dbg(rtsx_dev(chip), \"SD_CFG3: 0x%x\\n\", val);\n\n\t\tif (retval == -ETIMEDOUT) {\n\t\t\tif (rsp_type & SD_WAIT_BUSY_END) {\n\t\t\t\tretval = sd_check_data0_status(chip);\n\t\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\t\trtsx_clear_sd_error(chip);\n\t\t\t\t\treturn retval;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tsd_set_err_code(chip, SD_TO_ERR);\n\t\t\t}\n\t\t\tretval = STATUS_TIMEDOUT;\n\t\t} else {\n\t\t\tretval = STATUS_FAIL;\n\t\t}\n\t\trtsx_clear_sd_error(chip);\n\n\t\treturn retval;\n\t}\n\n\tif (rsp_type == SD_RSP_TYPE_R0)\n\t\treturn STATUS_SUCCESS;\n\n\tptr = rtsx_get_cmd_data(chip) + 1;\n\n\tif ((ptr[0] & 0xC0) != 0) {\n\t\tsd_set_err_code(chip, SD_STS_ERR);\n\t\treturn STATUS_FAIL;\n\t}\n\n\tif (!(rsp_type & SD_NO_CHECK_CRC7)) {\n\t\tif (ptr[stat_idx] & SD_CRC7_ERR) {\n\t\t\tif (cmd_idx == WRITE_MULTIPLE_BLOCK) {\n\t\t\t\tsd_set_err_code(chip, SD_CRC_ERR);\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\t\t\tif (rty_cnt < SD_MAX_RETRY_COUNT) {\n\t\t\t\twait_timeout(20);\n\t\t\t\trty_cnt++;\n\t\t\t\tgoto RTY_SEND_CMD;\n\t\t\t} else {\n\t\t\t\tsd_set_err_code(chip, SD_CRC_ERR);\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (rsp_type == SD_RSP_TYPE_R1 || rsp_type == SD_RSP_TYPE_R1b) {\n\t\tif (cmd_idx != SEND_RELATIVE_ADDR &&\n\t\t    cmd_idx != SEND_IF_COND) {\n\t\t\tif (cmd_idx != STOP_TRANSMISSION) {\n\t\t\t\tif (ptr[1] & 0x80)\n\t\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n#ifdef SUPPORT_SD_LOCK\n\t\t\tif (ptr[1] & 0x7D) {\n#else\n\t\t\tif (ptr[1] & 0x7F) {\n#endif\n\t\t\t\tdev_dbg(rtsx_dev(chip), \"ptr[1]: 0x%02x\\n\",\n\t\t\t\t\tptr[1]);\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\t\t\tif (ptr[2] & 0xFF) {\n\t\t\t\tdev_dbg(rtsx_dev(chip), \"ptr[2]: 0x%02x\\n\",\n\t\t\t\t\tptr[2]);\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\t\t\tif (ptr[3] & 0x80) {\n\t\t\t\tdev_dbg(rtsx_dev(chip), \"ptr[3]: 0x%02x\\n\",\n\t\t\t\t\tptr[3]);\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\t\t\tif (ptr[3] & 0x01)\n\t\t\t\tsd_card->sd_data_buf_ready = 1;\n\t\t\telse\n\t\t\t\tsd_card->sd_data_buf_ready = 0;\n\t\t}\n\t}\n\n\tif (rsp && rsp_len)\n\t\tmemcpy(rsp, ptr, rsp_len);\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_read_data(struct rtsx_chip *chip,\n\t\t\tu8 trans_mode, u8 *cmd, int cmd_len, u16 byte_cnt,\n\t\t\tu16 blk_cnt, u8 bus_width, u8 *buf, int buf_len,\n\t\t\tint timeout)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tint i;\n\n\tsd_clr_err_code(chip);\n\n\tif (!buf)\n\t\tbuf_len = 0;\n\n\tif (buf_len > 512)\n\t\treturn STATUS_FAIL;\n\n\trtsx_init_cmd(chip);\n\n\tif (cmd_len) {\n\t\tdev_dbg(rtsx_dev(chip), \"SD/MMC CMD %d\\n\", cmd[0] - 0x40);\n\t\tfor (i = 0; i < (min(cmd_len, 6)); i++)\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0 + i,\n\t\t\t\t     0xFF, cmd[i]);\n\t}\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\n\t\t     (u8)byte_cnt);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\n\t\t     (u8)(byte_cnt >> 8));\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF,\n\t\t     (u8)blk_cnt);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF,\n\t\t     (u8)(blk_cnt >> 8));\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1, 0x03, bus_width);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\n\t\t     SD_CALCULATE_CRC7 | SD_CHECK_CRC16 | SD_NO_WAIT_BUSY_END |\n\t\t     SD_CHECK_CRC7 | SD_RSP_LEN_6);\n\tif (trans_mode != SD_TM_AUTO_TUNING)\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD,\n\t\t\t     CARD_DATA_SOURCE, 0x01, PINGPONG_BUFFER);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t     trans_mode | SD_TRANSFER_START);\n\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER, SD_TRANSFER_END,\n\t\t     SD_TRANSFER_END);\n\n\tretval = rtsx_send_cmd(chip, SD_CARD, timeout);\n\tif (retval < 0) {\n\t\tif (retval == -ETIMEDOUT) {\n\t\t\tsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t\t    SD_RSP_TYPE_R1, NULL, 0);\n\t\t}\n\n\t\treturn STATUS_FAIL;\n\t}\n\n\tif (buf && buf_len) {\n\t\tretval = rtsx_read_ppbuf(chip, buf, buf_len);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_write_data(struct rtsx_chip *chip, u8 trans_mode,\n\t\t\t u8 *cmd, int cmd_len, u16 byte_cnt, u16 blk_cnt,\n\t\t\t u8 bus_width, u8 *buf, int buf_len, int timeout)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tint i;\n\n\tsd_clr_err_code(chip);\n\n\tif (!buf)\n\t\tbuf_len = 0;\n\n\tif (buf_len > 512) {\n\t\t \n\t\treturn STATUS_FAIL;\n\t}\n\n\tif (buf && buf_len) {\n\t\tretval = rtsx_write_ppbuf(chip, buf, buf_len);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\trtsx_init_cmd(chip);\n\n\tif (cmd_len) {\n\t\tdev_dbg(rtsx_dev(chip), \"SD/MMC CMD %d\\n\", cmd[0] - 0x40);\n\t\tfor (i = 0; i < (min(cmd_len, 6)); i++) {\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD,\n\t\t\t\t     REG_SD_CMD0 + i, 0xFF, cmd[i]);\n\t\t}\n\t}\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\n\t\t     (u8)byte_cnt);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\n\t\t     (u8)(byte_cnt >> 8));\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF,\n\t\t     (u8)blk_cnt);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF,\n\t\t     (u8)(blk_cnt >> 8));\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1, 0x03, bus_width);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\n\t\t     SD_CALCULATE_CRC7 | SD_CHECK_CRC16 | SD_NO_WAIT_BUSY_END |\n\t\t     SD_CHECK_CRC7 | SD_RSP_LEN_6);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t     trans_mode | SD_TRANSFER_START);\n\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER, SD_TRANSFER_END,\n\t\t     SD_TRANSFER_END);\n\n\tretval = rtsx_send_cmd(chip, SD_CARD, timeout);\n\tif (retval < 0) {\n\t\tif (retval == -ETIMEDOUT) {\n\t\t\tsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t\t    SD_RSP_TYPE_R1, NULL, 0);\n\t\t}\n\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_check_csd(struct rtsx_chip *chip, char check_wp)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tint i;\n\tu8 csd_ver, trans_speed;\n\tu8 rsp[16];\n\n\tfor (i = 0; i < 6; i++) {\n\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\tsd_set_err_code(chip, SD_NO_CARD);\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\n\t\tretval = sd_send_cmd_get_rsp(chip, SEND_CSD, sd_card->sd_addr,\n\t\t\t\t\t     SD_RSP_TYPE_R2, rsp, 16);\n\t\tif (retval == STATUS_SUCCESS)\n\t\t\tbreak;\n\t}\n\n\tif (i == 6)\n\t\treturn STATUS_FAIL;\n\n\tmemcpy(sd_card->raw_csd, rsp + 1, 15);\n\n\tdev_dbg(rtsx_dev(chip), \"CSD Response:\\n\");\n\tdev_dbg(rtsx_dev(chip), \"%*ph\\n\", 16, sd_card->raw_csd);\n\n\tcsd_ver = (rsp[1] & 0xc0) >> 6;\n\tdev_dbg(rtsx_dev(chip), \"csd_ver = %d\\n\", csd_ver);\n\n\ttrans_speed = rsp[4];\n\tif ((trans_speed & 0x07) == 0x02) {\n\t\tif ((trans_speed & 0xf8) >= 0x30) {\n\t\t\tif (chip->asic_code)\n\t\t\t\tsd_card->sd_clock = 47;\n\t\t\telse\n\t\t\t\tsd_card->sd_clock = CLK_50;\n\n\t\t} else if ((trans_speed & 0xf8) == 0x28) {\n\t\t\tif (chip->asic_code)\n\t\t\t\tsd_card->sd_clock = 39;\n\t\t\telse\n\t\t\t\tsd_card->sd_clock = CLK_40;\n\n\t\t} else if ((trans_speed & 0xf8) == 0x20) {\n\t\t\tif (chip->asic_code)\n\t\t\t\tsd_card->sd_clock = 29;\n\t\t\telse\n\t\t\t\tsd_card->sd_clock = CLK_30;\n\n\t\t} else if ((trans_speed & 0xf8) >= 0x10) {\n\t\t\tif (chip->asic_code)\n\t\t\t\tsd_card->sd_clock = 23;\n\t\t\telse\n\t\t\t\tsd_card->sd_clock = CLK_20;\n\n\t\t} else if ((trans_speed & 0x08) >= 0x08) {\n\t\t\tif (chip->asic_code)\n\t\t\t\tsd_card->sd_clock = 19;\n\t\t\telse\n\t\t\t\tsd_card->sd_clock = CLK_20;\n\t\t} else {\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\t} else {\n\t\treturn STATUS_FAIL;\n\t}\n\n\tif (CHK_MMC_SECTOR_MODE(sd_card)) {\n\t\tsd_card->capacity = 0;\n\t} else {\n\t\tif ((!CHK_SD_HCXC(sd_card)) || csd_ver == 0) {\n\t\t\tu8 blk_size, c_size_mult;\n\t\t\tu16 c_size;\n\n\t\t\tblk_size = rsp[6] & 0x0F;\n\t\t\tc_size =  ((u16)(rsp[7] & 0x03) << 10)\n\t\t\t\t\t+ ((u16)rsp[8] << 2)\n\t\t\t\t\t+ ((u16)(rsp[9] & 0xC0) >> 6);\n\t\t\tc_size_mult = (u8)((rsp[10] & 0x03) << 1);\n\t\t\tc_size_mult += (rsp[11] & 0x80) >> 7;\n\t\t\tsd_card->capacity = (((u32)(c_size + 1)) *\n\t\t\t\t\t(1 << (c_size_mult + 2)))\n\t\t\t\t<< (blk_size - 9);\n\t\t} else {\n\t\t\tu32 total_sector = 0;\n\n\t\t\ttotal_sector = (((u32)rsp[8] & 0x3f) << 16) |\n\t\t\t\t((u32)rsp[9] << 8) | (u32)rsp[10];\n\t\t\tsd_card->capacity = (total_sector + 1) << 10;\n\t\t}\n\t}\n\n\tif (check_wp) {\n\t\tif (rsp[15] & 0x30)\n\t\t\tchip->card_wp |= SD_CARD;\n\n\t\tdev_dbg(rtsx_dev(chip), \"CSD WP Status: 0x%x\\n\", rsp[15]);\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_set_sample_push_timing(struct rtsx_chip *chip)\n{\n\tint retval;\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tu8 val = 0;\n\n\tif ((chip->sd_ctl & SD_PUSH_POINT_CTL_MASK) == SD_PUSH_POINT_DELAY)\n\t\tval |= 0x10;\n\n\tif ((chip->sd_ctl & SD_SAMPLE_POINT_CTL_MASK) == SD_SAMPLE_POINT_AUTO) {\n\t\tif (chip->asic_code) {\n\t\t\tif (CHK_SD_HS(sd_card) || CHK_MMC_52M(sd_card)) {\n\t\t\t\tif (val & 0x10)\n\t\t\t\t\tval |= 0x04;\n\t\t\t\telse\n\t\t\t\t\tval |= 0x08;\n\t\t\t}\n\t\t} else {\n\t\t\tif (val & 0x10)\n\t\t\t\tval |= 0x04;\n\t\t\telse\n\t\t\t\tval |= 0x08;\n\t\t}\n\t} else if ((chip->sd_ctl & SD_SAMPLE_POINT_CTL_MASK) ==\n\t\tSD_SAMPLE_POINT_DELAY) {\n\t\tif (val & 0x10)\n\t\t\tval |= 0x04;\n\t\telse\n\t\t\tval |= 0x08;\n\t}\n\n\tretval = rtsx_write_register(chip, REG_SD_CFG1, 0x1C, val);\n\tif (retval)\n\t\treturn retval;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic void sd_choose_proper_clock(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\n\tif (CHK_SD_SDR104(sd_card)) {\n\t\tif (chip->asic_code)\n\t\t\tsd_card->sd_clock = chip->asic_sd_sdr104_clk;\n\t\telse\n\t\t\tsd_card->sd_clock = chip->fpga_sd_sdr104_clk;\n\n\t} else if (CHK_SD_DDR50(sd_card)) {\n\t\tif (chip->asic_code)\n\t\t\tsd_card->sd_clock = chip->asic_sd_ddr50_clk;\n\t\telse\n\t\t\tsd_card->sd_clock = chip->fpga_sd_ddr50_clk;\n\n\t} else if (CHK_SD_SDR50(sd_card)) {\n\t\tif (chip->asic_code)\n\t\t\tsd_card->sd_clock = chip->asic_sd_sdr50_clk;\n\t\telse\n\t\t\tsd_card->sd_clock = chip->fpga_sd_sdr50_clk;\n\n\t} else if (CHK_SD_HS(sd_card)) {\n\t\tif (chip->asic_code)\n\t\t\tsd_card->sd_clock = chip->asic_sd_hs_clk;\n\t\telse\n\t\t\tsd_card->sd_clock = chip->fpga_sd_hs_clk;\n\n\t} else if (CHK_MMC_52M(sd_card) || CHK_MMC_DDR52(sd_card)) {\n\t\tif (chip->asic_code)\n\t\t\tsd_card->sd_clock = chip->asic_mmc_52m_clk;\n\t\telse\n\t\t\tsd_card->sd_clock = chip->fpga_mmc_52m_clk;\n\n\t} else if (CHK_MMC_26M(sd_card)) {\n\t\tif (chip->asic_code)\n\t\t\tsd_card->sd_clock = 48;\n\t\telse\n\t\t\tsd_card->sd_clock = CLK_50;\n\t}\n}\n\nstatic int sd_set_clock_divider(struct rtsx_chip *chip, u8 clk_div)\n{\n\tint retval;\n\tu8 mask = 0, val = 0;\n\n\tmask = 0x60;\n\tif (clk_div == SD_CLK_DIVIDE_0)\n\t\tval = 0x00;\n\telse if (clk_div == SD_CLK_DIVIDE_128)\n\t\tval = 0x40;\n\telse if (clk_div == SD_CLK_DIVIDE_256)\n\t\tval = 0x20;\n\n\tretval = rtsx_write_register(chip, REG_SD_CFG1, mask, val);\n\tif (retval)\n\t\treturn retval;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_set_init_para(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\n\tretval = sd_set_sample_push_timing(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tsd_choose_proper_clock(chip);\n\n\tretval = switch_clock(chip, sd_card->sd_clock);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\nint sd_select_card(struct rtsx_chip *chip, int select)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 cmd_idx, cmd_type;\n\tu32 addr;\n\n\tif (select) {\n\t\tcmd_idx = SELECT_CARD;\n\t\tcmd_type = SD_RSP_TYPE_R1;\n\t\taddr = sd_card->sd_addr;\n\t} else {\n\t\tcmd_idx = DESELECT_CARD;\n\t\tcmd_type = SD_RSP_TYPE_R0;\n\t\taddr = 0;\n\t}\n\n\tretval = sd_send_cmd_get_rsp(chip, cmd_idx, addr, cmd_type, NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\n#ifdef SUPPORT_SD_LOCK\nstatic int sd_update_lock_status(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 rsp[5];\n\n\tretval = sd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t     SD_RSP_TYPE_R1, rsp, 5);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (rsp[1] & 0x02)\n\t\tsd_card->sd_lock_status |= SD_LOCKED;\n\telse\n\t\tsd_card->sd_lock_status &= ~SD_LOCKED;\n\n\tdev_dbg(rtsx_dev(chip), \"sd_card->sd_lock_status = 0x%x\\n\",\n\t\tsd_card->sd_lock_status);\n\n\tif (rsp[1] & 0x01)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n#endif\n\nstatic int sd_wait_state_data_ready(struct rtsx_chip *chip, u8 state,\n\t\t\t\t    u8 data_ready, int polling_cnt)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval, i;\n\tu8 rsp[5];\n\n\tfor (i = 0; i < polling_cnt; i++) {\n\t\tretval = sd_send_cmd_get_rsp(chip, SEND_STATUS,\n\t\t\t\t\t     sd_card->sd_addr, SD_RSP_TYPE_R1,\n\t\t\t\t\t     rsp, 5);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\n\t\tif (((rsp[3] & 0x1E) == state) &&\n\t\t    ((rsp[3] & 0x01) == data_ready))\n\t\t\treturn STATUS_SUCCESS;\n\t}\n\n\treturn STATUS_FAIL;\n}\n\nstatic int sd_change_bank_voltage(struct rtsx_chip *chip, u8 voltage)\n{\n\tint retval;\n\n\tif (voltage == SD_IO_3V3) {\n\t\tif (chip->asic_code) {\n\t\t\tretval = rtsx_write_phy_register(chip, 0x08,\n\t\t\t\t\t\t\t 0x4FC0 |\n\t\t\t\t\t\t\t chip->phy_voltage);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn STATUS_FAIL;\n\t\t} else {\n\t\t\tretval = rtsx_write_register(chip, SD_PAD_CTL,\n\t\t\t\t\t\t     SD_IO_USING_1V8, 0);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t}\n\t} else if (voltage == SD_IO_1V8) {\n\t\tif (chip->asic_code) {\n\t\t\tretval = rtsx_write_phy_register(chip, 0x08,\n\t\t\t\t\t\t\t 0x4C40 |\n\t\t\t\t\t\t\t chip->phy_voltage);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn STATUS_FAIL;\n\t\t} else {\n\t\t\tretval = rtsx_write_register(chip, SD_PAD_CTL,\n\t\t\t\t\t\t     SD_IO_USING_1V8,\n\t\t\t\t\t\t     SD_IO_USING_1V8);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t}\n\t} else {\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_voltage_switch(struct rtsx_chip *chip)\n{\n\tint retval;\n\tu8 stat;\n\n\tretval = rtsx_write_register(chip, SD_BUS_STAT,\n\t\t\t\t     SD_CLK_TOGGLE_EN | SD_CLK_FORCE_STOP,\n\t\t\t\t     SD_CLK_TOGGLE_EN);\n\tif (retval)\n\t\treturn retval;\n\n\tretval = sd_send_cmd_get_rsp(chip, VOLTAGE_SWITCH, 0, SD_RSP_TYPE_R1,\n\t\t\t\t     NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tudelay(chip->sd_voltage_switch_delay);\n\n\tretval = rtsx_read_register(chip, SD_BUS_STAT, &stat);\n\tif (retval)\n\t\treturn retval;\n\tif (stat & (SD_CMD_STATUS | SD_DAT3_STATUS | SD_DAT2_STATUS |\n\t\t\t\tSD_DAT1_STATUS | SD_DAT0_STATUS)) {\n\t\treturn STATUS_FAIL;\n\t}\n\n\tretval = rtsx_write_register(chip, SD_BUS_STAT, 0xFF,\n\t\t\t\t     SD_CLK_FORCE_STOP);\n\tif (retval)\n\t\treturn retval;\n\tretval = sd_change_bank_voltage(chip, SD_IO_1V8);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\twait_timeout(50);\n\n\tretval = rtsx_write_register(chip, SD_BUS_STAT, 0xFF,\n\t\t\t\t     SD_CLK_TOGGLE_EN);\n\tif (retval)\n\t\treturn retval;\n\twait_timeout(10);\n\n\tretval = rtsx_read_register(chip, SD_BUS_STAT, &stat);\n\tif (retval)\n\t\treturn retval;\n\tif ((stat & (SD_CMD_STATUS | SD_DAT3_STATUS | SD_DAT2_STATUS |\n\t\t\t\tSD_DAT1_STATUS | SD_DAT0_STATUS)) !=\n\t\t\t(SD_CMD_STATUS | SD_DAT3_STATUS | SD_DAT2_STATUS |\n\t\t\t\tSD_DAT1_STATUS | SD_DAT0_STATUS)) {\n\t\tdev_dbg(rtsx_dev(chip), \"SD_BUS_STAT: 0x%x\\n\", stat);\n\t\trtsx_write_register(chip, SD_BUS_STAT, SD_CLK_TOGGLE_EN |\n\t\t\t\t    SD_CLK_FORCE_STOP, 0);\n\t\trtsx_write_register(chip, CARD_CLK_EN, 0xFF, 0);\n\t\treturn STATUS_FAIL;\n\t}\n\n\tretval = rtsx_write_register(chip, SD_BUS_STAT,\n\t\t\t\t     SD_CLK_TOGGLE_EN | SD_CLK_FORCE_STOP, 0);\n\tif (retval)\n\t\treturn retval;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_reset_dcm(struct rtsx_chip *chip, u8 tune_dir)\n{\n\tint retval;\n\n\tif (tune_dir == TUNE_RX) {\n\t\tretval = rtsx_write_register(chip, DCM_DRP_CTL, 0xFF,\n\t\t\t\t\t     DCM_RESET | DCM_RX);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, DCM_DRP_CTL, 0xFF, DCM_RX);\n\t\tif (retval)\n\t\t\treturn retval;\n\t} else {\n\t\tretval = rtsx_write_register(chip, DCM_DRP_CTL, 0xFF,\n\t\t\t\t\t     DCM_RESET | DCM_TX);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, DCM_DRP_CTL, 0xFF, DCM_TX);\n\t\tif (retval)\n\t\t\treturn retval;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_change_phase(struct rtsx_chip *chip, u8 sample_point, u8 tune_dir)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tu16 SD_VP_CTL, SD_DCMPS_CTL;\n\tu8 val;\n\tint retval;\n\tbool ddr_rx = false;\n\n\tdev_dbg(rtsx_dev(chip), \"%s (sample_point = %d, tune_dir = %d)\\n\",\n\t\t__func__, sample_point, tune_dir);\n\n\tif (tune_dir == TUNE_RX) {\n\t\tSD_VP_CTL = SD_VPRX_CTL;\n\t\tSD_DCMPS_CTL = SD_DCMPS_RX_CTL;\n\t\tif (CHK_SD_DDR50(sd_card))\n\t\t\tddr_rx = true;\n\t} else {\n\t\tSD_VP_CTL = SD_VPTX_CTL;\n\t\tSD_DCMPS_CTL = SD_DCMPS_TX_CTL;\n\t}\n\n\tif (chip->asic_code) {\n\t\tretval = rtsx_write_register(chip, CLK_CTL, CHANGE_CLK,\n\t\t\t\t\t     CHANGE_CLK);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, SD_VP_CTL, 0x1F,\n\t\t\t\t\t     sample_point);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, SD_VPCLK0_CTL,\n\t\t\t\t\t     PHASE_NOT_RESET, 0);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, SD_VPCLK0_CTL,\n\t\t\t\t\t     PHASE_NOT_RESET, PHASE_NOT_RESET);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, CLK_CTL, CHANGE_CLK, 0);\n\t\tif (retval)\n\t\t\treturn retval;\n\t} else {\n\t\trtsx_read_register(chip, SD_VP_CTL, &val);\n\t\tdev_dbg(rtsx_dev(chip), \"SD_VP_CTL: 0x%x\\n\", val);\n\t\trtsx_read_register(chip, SD_DCMPS_CTL, &val);\n\t\tdev_dbg(rtsx_dev(chip), \"SD_DCMPS_CTL: 0x%x\\n\", val);\n\n\t\tif (ddr_rx) {\n\t\t\tretval = rtsx_write_register(chip, SD_VP_CTL,\n\t\t\t\t\t\t     PHASE_CHANGE,\n\t\t\t\t\t\t     PHASE_CHANGE);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t\tudelay(50);\n\t\t\tretval = rtsx_write_register(chip, SD_VP_CTL, 0xFF,\n\t\t\t\t\t\t     PHASE_CHANGE |\n\t\t\t\t\t\t     PHASE_NOT_RESET |\n\t\t\t\t\t\t     sample_point);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t} else {\n\t\t\tretval = rtsx_write_register(chip, CLK_CTL,\n\t\t\t\t\t\t     CHANGE_CLK, CHANGE_CLK);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t\tudelay(50);\n\t\t\tretval = rtsx_write_register(chip, SD_VP_CTL, 0xFF,\n\t\t\t\t\t\t     PHASE_NOT_RESET |\n\t\t\t\t\t\t     sample_point);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t}\n\t\tudelay(100);\n\n\t\trtsx_init_cmd(chip);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, SD_DCMPS_CTL, DCMPS_CHANGE,\n\t\t\t     DCMPS_CHANGE);\n\t\trtsx_add_cmd(chip, CHECK_REG_CMD, SD_DCMPS_CTL,\n\t\t\t     DCMPS_CHANGE_DONE, DCMPS_CHANGE_DONE);\n\t\tretval = rtsx_send_cmd(chip, SD_CARD, 100);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto fail;\n\n\t\tval = *rtsx_get_cmd_data(chip);\n\t\tif (val & DCMPS_ERROR)\n\t\t\tgoto fail;\n\n\t\tif ((val & DCMPS_CURRENT_PHASE) != sample_point)\n\t\t\tgoto fail;\n\n\t\tretval = rtsx_write_register(chip, SD_DCMPS_CTL,\n\t\t\t\t\t     DCMPS_CHANGE, 0);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tif (ddr_rx) {\n\t\t\tretval = rtsx_write_register(chip, SD_VP_CTL,\n\t\t\t\t\t\t     PHASE_CHANGE, 0);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t} else {\n\t\t\tretval = rtsx_write_register(chip, CLK_CTL,\n\t\t\t\t\t\t     CHANGE_CLK, 0);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t}\n\n\t\tudelay(50);\n\t}\n\n\tretval = rtsx_write_register(chip, SD_CFG1, SD_ASYNC_FIFO_NOT_RST, 0);\n\tif (retval)\n\t\treturn retval;\n\n\treturn STATUS_SUCCESS;\n\nfail:\n\trtsx_read_register(chip, SD_VP_CTL, &val);\n\tdev_dbg(rtsx_dev(chip), \"SD_VP_CTL: 0x%x\\n\", val);\n\trtsx_read_register(chip, SD_DCMPS_CTL, &val);\n\tdev_dbg(rtsx_dev(chip), \"SD_DCMPS_CTL: 0x%x\\n\", val);\n\n\trtsx_write_register(chip, SD_DCMPS_CTL, DCMPS_CHANGE, 0);\n\trtsx_write_register(chip, SD_VP_CTL, PHASE_CHANGE, 0);\n\tmdelay(10);\n\tsd_reset_dcm(chip, tune_dir);\n\treturn STATUS_FAIL;\n}\n\nstatic int sd_check_spec(struct rtsx_chip *chip, u8 bus_width)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 cmd[5], buf[8];\n\n\tretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\n\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tcmd[0] = 0x40 | SEND_SCR;\n\tcmd[1] = 0;\n\tcmd[2] = 0;\n\tcmd[3] = 0;\n\tcmd[4] = 0;\n\n\tretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 8, 1, bus_width,\n\t\t\t      buf, 8, 250);\n\tif (retval != STATUS_SUCCESS) {\n\t\trtsx_clear_sd_error(chip);\n\t\treturn STATUS_FAIL;\n\t}\n\n\tmemcpy(sd_card->raw_scr, buf, 8);\n\n\tif ((buf[0] & 0x0F) == 0)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_query_switch_result(struct rtsx_chip *chip, u8 func_group,\n\t\t\t\t  u8 func_to_switch, u8 *buf, int buf_len)\n{\n\tu8 support_mask = 0, query_switch = 0, switch_busy = 0;\n\tint support_offset = 0, query_switch_offset = 0, check_busy_offset = 0;\n\n\tif (func_group == SD_FUNC_GROUP_1) {\n\t\tsupport_offset = FUNCTION_GROUP1_SUPPORT_OFFSET;\n\t\tquery_switch_offset = FUNCTION_GROUP1_QUERY_SWITCH_OFFSET;\n\t\tcheck_busy_offset = FUNCTION_GROUP1_CHECK_BUSY_OFFSET;\n\n\t\tswitch (func_to_switch) {\n\t\tcase HS_SUPPORT:\n\t\t\tsupport_mask = HS_SUPPORT_MASK;\n\t\t\tquery_switch = HS_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = HS_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tcase SDR50_SUPPORT:\n\t\t\tsupport_mask = SDR50_SUPPORT_MASK;\n\t\t\tquery_switch = SDR50_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = SDR50_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tcase SDR104_SUPPORT:\n\t\t\tsupport_mask = SDR104_SUPPORT_MASK;\n\t\t\tquery_switch = SDR104_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = SDR104_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tcase DDR50_SUPPORT:\n\t\t\tsupport_mask = DDR50_SUPPORT_MASK;\n\t\t\tquery_switch = DDR50_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = DDR50_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\t} else if (func_group == SD_FUNC_GROUP_3) {\n\t\tsupport_offset = FUNCTION_GROUP3_SUPPORT_OFFSET;\n\t\tquery_switch_offset = FUNCTION_GROUP3_QUERY_SWITCH_OFFSET;\n\t\tcheck_busy_offset = FUNCTION_GROUP3_CHECK_BUSY_OFFSET;\n\n\t\tswitch (func_to_switch) {\n\t\tcase DRIVING_TYPE_A:\n\t\t\tsupport_mask = DRIVING_TYPE_A_MASK;\n\t\t\tquery_switch = TYPE_A_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = TYPE_A_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tcase DRIVING_TYPE_C:\n\t\t\tsupport_mask = DRIVING_TYPE_C_MASK;\n\t\t\tquery_switch = TYPE_C_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = TYPE_C_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tcase DRIVING_TYPE_D:\n\t\t\tsupport_mask = DRIVING_TYPE_D_MASK;\n\t\t\tquery_switch = TYPE_D_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = TYPE_D_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\t} else if (func_group == SD_FUNC_GROUP_4) {\n\t\tsupport_offset = FUNCTION_GROUP4_SUPPORT_OFFSET;\n\t\tquery_switch_offset = FUNCTION_GROUP4_QUERY_SWITCH_OFFSET;\n\t\tcheck_busy_offset = FUNCTION_GROUP4_CHECK_BUSY_OFFSET;\n\n\t\tswitch (func_to_switch) {\n\t\tcase CURRENT_LIMIT_400:\n\t\t\tsupport_mask = CURRENT_LIMIT_400_MASK;\n\t\t\tquery_switch = CURRENT_LIMIT_400_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = CURRENT_LIMIT_400_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tcase CURRENT_LIMIT_600:\n\t\t\tsupport_mask = CURRENT_LIMIT_600_MASK;\n\t\t\tquery_switch = CURRENT_LIMIT_600_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = CURRENT_LIMIT_600_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tcase CURRENT_LIMIT_800:\n\t\t\tsupport_mask = CURRENT_LIMIT_800_MASK;\n\t\t\tquery_switch = CURRENT_LIMIT_800_QUERY_SWITCH_OK;\n\t\t\tswitch_busy = CURRENT_LIMIT_800_SWITCH_BUSY;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\t} else {\n\t\treturn STATUS_FAIL;\n\t}\n\n\tif (func_group == SD_FUNC_GROUP_1) {\n\t\tif (!(buf[support_offset] & support_mask) ||\n\t\t    ((buf[query_switch_offset] & 0x0F) != query_switch)) {\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\t}\n\n\t \n\tif (buf[DATA_STRUCTURE_VER_OFFSET] == 0x01 &&\n\t    ((buf[check_busy_offset] & switch_busy) == switch_busy)) {\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_check_switch_mode(struct rtsx_chip *chip, u8 mode, u8 func_group,\n\t\t\t\tu8 func_to_switch, u8 bus_width)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 cmd[5], buf[64];\n\n\tdev_dbg(rtsx_dev(chip), \"%s (mode = %d, func_group = %d, func_to_switch = %d)\\n\",\n\t\t__func__, mode, func_group, func_to_switch);\n\n\tcmd[0] = 0x40 | SWITCH;\n\tcmd[1] = mode;\n\n\tif (func_group == SD_FUNC_GROUP_1) {\n\t\tcmd[2] = 0xFF;\n\t\tcmd[3] = 0xFF;\n\t\tcmd[4] = 0xF0 + func_to_switch;\n\t} else if (func_group == SD_FUNC_GROUP_3) {\n\t\tcmd[2] = 0xFF;\n\t\tcmd[3] = 0xF0 + func_to_switch;\n\t\tcmd[4] = 0xFF;\n\t} else if (func_group == SD_FUNC_GROUP_4) {\n\t\tcmd[2] = 0xFF;\n\t\tcmd[3] = 0x0F + (func_to_switch << 4);\n\t\tcmd[4] = 0xFF;\n\t} else {\n\t\tcmd[1] = SD_CHECK_MODE;\n\t\tcmd[2] = 0xFF;\n\t\tcmd[3] = 0xFF;\n\t\tcmd[4] = 0xFF;\n\t}\n\n\tretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 64, 1, bus_width,\n\t\t\t      buf, 64, 250);\n\tif (retval != STATUS_SUCCESS) {\n\t\trtsx_clear_sd_error(chip);\n\t\treturn STATUS_FAIL;\n\t}\n\n\tdev_dbg(rtsx_dev(chip), \"%*ph\\n\", 64, buf);\n\n\tif (func_group == NO_ARGUMENT) {\n\t\tsd_card->func_group1_mask = buf[0x0D];\n\t\tsd_card->func_group2_mask = buf[0x0B];\n\t\tsd_card->func_group3_mask = buf[0x09];\n\t\tsd_card->func_group4_mask = buf[0x07];\n\n\t\tdev_dbg(rtsx_dev(chip), \"func_group1_mask = 0x%02x\\n\",\n\t\t\tbuf[0x0D]);\n\t\tdev_dbg(rtsx_dev(chip), \"func_group2_mask = 0x%02x\\n\",\n\t\t\tbuf[0x0B]);\n\t\tdev_dbg(rtsx_dev(chip), \"func_group3_mask = 0x%02x\\n\",\n\t\t\tbuf[0x09]);\n\t\tdev_dbg(rtsx_dev(chip), \"func_group4_mask = 0x%02x\\n\",\n\t\t\tbuf[0x07]);\n\t} else {\n\t\t \n\t\tu16 cc = ((u16)buf[0] << 8) | buf[1];\n\n\t\tdev_dbg(rtsx_dev(chip), \"Maximum current consumption: %dmA\\n\",\n\t\t\tcc);\n\t\tif (cc == 0 || cc > 800)\n\t\t\treturn STATUS_FAIL;\n\n\t\tretval = sd_query_switch_result(chip, func_group,\n\t\t\t\t\t\tfunc_to_switch, buf, 64);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\n\t\tif (cc > 400 || func_to_switch > CURRENT_LIMIT_400) {\n\t\t\tretval = rtsx_write_register(chip, OCPPARA2,\n\t\t\t\t\t\t     SD_OCP_THD_MASK,\n\t\t\t\t\t\t     chip->sd_800mA_ocp_thd);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t\tretval = rtsx_write_register(chip, CARD_PWR_CTL,\n\t\t\t\t\t\t     PMOS_STRG_MASK,\n\t\t\t\t\t\t     PMOS_STRG_800mA);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t}\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic u8 downgrade_switch_mode(u8 func_group, u8 func_to_switch)\n{\n\tif (func_group == SD_FUNC_GROUP_1) {\n\t\tif (func_to_switch > HS_SUPPORT)\n\t\t\tfunc_to_switch--;\n\n\t} else if (func_group == SD_FUNC_GROUP_4) {\n\t\tif (func_to_switch > CURRENT_LIMIT_200)\n\t\t\tfunc_to_switch--;\n\t}\n\n\treturn func_to_switch;\n}\n\nstatic int sd_check_switch(struct rtsx_chip *chip,\n\t\t\t   u8 func_group, u8 func_to_switch, u8 bus_width)\n{\n\tint retval;\n\tint i;\n\tbool switch_good = false;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\tsd_set_err_code(chip, SD_NO_CARD);\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\n\t\tretval = sd_check_switch_mode(chip, SD_CHECK_MODE, func_group,\n\t\t\t\t\t      func_to_switch, bus_width);\n\t\tif (retval == STATUS_SUCCESS) {\n\t\t\tu8 stat;\n\n\t\t\tretval = sd_check_switch_mode(chip, SD_SWITCH_MODE,\n\t\t\t\t\t\t      func_group,\n\t\t\t\t\t\t      func_to_switch,\n\t\t\t\t\t\t      bus_width);\n\t\t\tif (retval == STATUS_SUCCESS) {\n\t\t\t\tswitch_good = true;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tretval = rtsx_read_register(chip, SD_STAT1, &stat);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t\tif (stat & SD_CRC16_ERR) {\n\t\t\t\tdev_dbg(rtsx_dev(chip), \"SD CRC16 error when switching mode\\n\");\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\t\t}\n\n\t\tfunc_to_switch = downgrade_switch_mode(func_group,\n\t\t\t\t\t\t       func_to_switch);\n\n\t\twait_timeout(20);\n\t}\n\n\tif (!switch_good)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_switch_function(struct rtsx_chip *chip, u8 bus_width)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tint i;\n\tu8 func_to_switch = 0;\n\n\t \n\tretval = sd_check_switch_mode(chip, SD_CHECK_MODE, NO_ARGUMENT,\n\t\t\t\t      NO_ARGUMENT, bus_width);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tsd_card->func_group1_mask &= ~(sd_card->sd_switch_fail);\n\n\t \n\tfor (i = 0; i < 4; i++) {\n\t\tswitch ((u8)(chip->sd_speed_prior >> (i * 8))) {\n\t\tcase SDR104_SUPPORT:\n\t\t\tif ((sd_card->func_group1_mask & SDR104_SUPPORT_MASK) &&\n\t\t\t    chip->sdr104_en) {\n\t\t\t\tfunc_to_switch = SDR104_SUPPORT;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase DDR50_SUPPORT:\n\t\t\tif ((sd_card->func_group1_mask & DDR50_SUPPORT_MASK) &&\n\t\t\t    chip->ddr50_en) {\n\t\t\t\tfunc_to_switch = DDR50_SUPPORT;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase SDR50_SUPPORT:\n\t\t\tif ((sd_card->func_group1_mask & SDR50_SUPPORT_MASK) &&\n\t\t\t    chip->sdr50_en) {\n\t\t\t\tfunc_to_switch = SDR50_SUPPORT;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase HS_SUPPORT:\n\t\t\tif (sd_card->func_group1_mask & HS_SUPPORT_MASK)\n\t\t\t\tfunc_to_switch = HS_SUPPORT;\n\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (func_to_switch)\n\t\t\tbreak;\n\t}\n\tdev_dbg(rtsx_dev(chip), \"SD_FUNC_GROUP_1: func_to_switch = 0x%02x\",\n\t\tfunc_to_switch);\n\n#ifdef SUPPORT_SD_LOCK\n\tif ((sd_card->sd_lock_status & SD_SDR_RST) &&\n\t    func_to_switch == DDR50_SUPPORT &&\n\t    (sd_card->func_group1_mask & SDR50_SUPPORT_MASK)) {\n\t\tfunc_to_switch = SDR50_SUPPORT;\n\t\tdev_dbg(rtsx_dev(chip), \"Using SDR50 instead of DDR50 for SD Lock\\n\");\n\t}\n#endif\n\n\tif (func_to_switch) {\n\t\tretval = sd_check_switch(chip, SD_FUNC_GROUP_1, func_to_switch,\n\t\t\t\t\t bus_width);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tif (func_to_switch == SDR104_SUPPORT) {\n\t\t\t\tsd_card->sd_switch_fail = SDR104_SUPPORT_MASK;\n\t\t\t} else if (func_to_switch == DDR50_SUPPORT) {\n\t\t\t\tsd_card->sd_switch_fail = SDR104_SUPPORT_MASK |\n\t\t\t\t\tDDR50_SUPPORT_MASK;\n\t\t\t} else if (func_to_switch == SDR50_SUPPORT) {\n\t\t\t\tsd_card->sd_switch_fail = SDR104_SUPPORT_MASK |\n\t\t\t\t\tDDR50_SUPPORT_MASK | SDR50_SUPPORT_MASK;\n\t\t\t}\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\n\t\tif (func_to_switch == SDR104_SUPPORT)\n\t\t\tSET_SD_SDR104(sd_card);\n\t\telse if (func_to_switch == DDR50_SUPPORT)\n\t\t\tSET_SD_DDR50(sd_card);\n\t\telse if (func_to_switch == SDR50_SUPPORT)\n\t\t\tSET_SD_SDR50(sd_card);\n\t\telse\n\t\t\tSET_SD_HS(sd_card);\n\t}\n\n\tif (CHK_SD_DDR50(sd_card)) {\n\t\tretval = rtsx_write_register(chip, SD_PUSH_POINT_CTL, 0x06,\n\t\t\t\t\t     0x04);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = sd_set_sample_push_timing(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\tif (!func_to_switch || func_to_switch == HS_SUPPORT) {\n\t\t \n\t\treturn STATUS_SUCCESS;\n\t}\n\n\t \n\tfunc_to_switch = 0xFF;\n\n\tfor (i = 0; i < 4; i++) {\n\t\tswitch ((u8)(chip->sd_current_prior >> (i * 8))) {\n\t\tcase CURRENT_LIMIT_800:\n\t\t\tif (sd_card->func_group4_mask & CURRENT_LIMIT_800_MASK)\n\t\t\t\tfunc_to_switch = CURRENT_LIMIT_800;\n\n\t\t\tbreak;\n\n\t\tcase CURRENT_LIMIT_600:\n\t\t\tif (sd_card->func_group4_mask & CURRENT_LIMIT_600_MASK)\n\t\t\t\tfunc_to_switch = CURRENT_LIMIT_600;\n\n\t\t\tbreak;\n\n\t\tcase CURRENT_LIMIT_400:\n\t\t\tif (sd_card->func_group4_mask & CURRENT_LIMIT_400_MASK)\n\t\t\t\tfunc_to_switch = CURRENT_LIMIT_400;\n\n\t\t\tbreak;\n\n\t\tcase CURRENT_LIMIT_200:\n\t\t\tif (sd_card->func_group4_mask & CURRENT_LIMIT_200_MASK)\n\t\t\t\tfunc_to_switch = CURRENT_LIMIT_200;\n\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (func_to_switch != 0xFF)\n\t\t\tbreak;\n\t}\n\n\tdev_dbg(rtsx_dev(chip), \"SD_FUNC_GROUP_4: func_to_switch = 0x%02x\",\n\t\tfunc_to_switch);\n\n\tif (func_to_switch <= CURRENT_LIMIT_800) {\n\t\tretval = sd_check_switch(chip, SD_FUNC_GROUP_4, func_to_switch,\n\t\t\t\t\t bus_width);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tif (sd_check_err_code(chip, SD_NO_CARD))\n\t\t\t\treturn STATUS_FAIL;\n\t\t}\n\t\tdev_dbg(rtsx_dev(chip), \"Switch current limit finished! (%d)\\n\",\n\t\t\tretval);\n\t}\n\n\tif (CHK_SD_DDR50(sd_card)) {\n\t\tretval = rtsx_write_register(chip, SD_PUSH_POINT_CTL, 0x06, 0);\n\t\tif (retval)\n\t\t\treturn retval;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_wait_data_idle(struct rtsx_chip *chip)\n{\n\tint retval = STATUS_TIMEDOUT;\n\tint i;\n\tu8 val = 0;\n\n\tfor (i = 0; i < 100; i++) {\n\t\tretval = rtsx_read_register(chip, SD_DATA_STATE, &val);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tif (val & SD_DATA_IDLE) {\n\t\t\tretval = STATUS_SUCCESS;\n\t\t\tbreak;\n\t\t}\n\t\tudelay(100);\n\t}\n\tdev_dbg(rtsx_dev(chip), \"SD_DATA_STATE: 0x%02x\\n\", val);\n\n\treturn retval;\n}\n\nstatic int sd_sdr_tuning_rx_cmd(struct rtsx_chip *chip, u8 sample_point)\n{\n\tint retval;\n\tu8 cmd[5];\n\n\tretval = sd_change_phase(chip, sample_point, TUNE_RX);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tcmd[0] = 0x40 | SEND_TUNING_PATTERN;\n\tcmd[1] = 0;\n\tcmd[2] = 0;\n\tcmd[3] = 0;\n\tcmd[4] = 0;\n\n\tretval = sd_read_data(chip, SD_TM_AUTO_TUNING, cmd, 5, 0x40, 1,\n\t\t\t      SD_BUS_WIDTH_4, NULL, 0, 100);\n\tif (retval != STATUS_SUCCESS) {\n\t\t(void)sd_wait_data_idle(chip);\n\n\t\trtsx_clear_sd_error(chip);\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_ddr_tuning_rx_cmd(struct rtsx_chip *chip, u8 sample_point)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 cmd[5];\n\n\tretval = sd_change_phase(chip, sample_point, TUNE_RX);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tdev_dbg(rtsx_dev(chip), \"sd ddr tuning rx\\n\");\n\n\tretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\n\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tcmd[0] = 0x40 | SD_STATUS;\n\tcmd[1] = 0;\n\tcmd[2] = 0;\n\tcmd[3] = 0;\n\tcmd[4] = 0;\n\n\tretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 64, 1,\n\t\t\t      SD_BUS_WIDTH_4, NULL, 0, 100);\n\tif (retval != STATUS_SUCCESS) {\n\t\t(void)sd_wait_data_idle(chip);\n\n\t\trtsx_clear_sd_error(chip);\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int mmc_ddr_tuning_rx_cmd(struct rtsx_chip *chip, u8 sample_point)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 cmd[5], bus_width;\n\n\tif (CHK_MMC_8BIT(sd_card))\n\t\tbus_width = SD_BUS_WIDTH_8;\n\telse if (CHK_MMC_4BIT(sd_card))\n\t\tbus_width = SD_BUS_WIDTH_4;\n\telse\n\t\tbus_width = SD_BUS_WIDTH_1;\n\n\tretval = sd_change_phase(chip, sample_point, TUNE_RX);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tdev_dbg(rtsx_dev(chip), \"mmc ddr tuning rx\\n\");\n\n\tcmd[0] = 0x40 | SEND_EXT_CSD;\n\tcmd[1] = 0;\n\tcmd[2] = 0;\n\tcmd[3] = 0;\n\tcmd[4] = 0;\n\n\tretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 0x200, 1,\n\t\t\t      bus_width, NULL, 0, 100);\n\tif (retval != STATUS_SUCCESS) {\n\t\t(void)sd_wait_data_idle(chip);\n\n\t\trtsx_clear_sd_error(chip);\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_sdr_tuning_tx_cmd(struct rtsx_chip *chip, u8 sample_point)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\n\tretval = sd_change_phase(chip, sample_point, TUNE_TX);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\n\t\t\t\t     SD_RSP_80CLK_TIMEOUT_EN);\n\tif (retval)\n\t\treturn retval;\n\n\tretval = sd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\tif (retval != STATUS_SUCCESS) {\n\t\tif (sd_check_err_code(chip, SD_RSP_TIMEOUT)) {\n\t\t\trtsx_write_register(chip, SD_CFG3,\n\t\t\t\t\t    SD_RSP_80CLK_TIMEOUT_EN, 0);\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\t}\n\n\tretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\n\t\t\t\t     0);\n\tif (retval)\n\t\treturn retval;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_ddr_tuning_tx_cmd(struct rtsx_chip *chip, u8 sample_point)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 cmd[5], bus_width;\n\n\tretval = sd_change_phase(chip, sample_point, TUNE_TX);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (CHK_SD(sd_card)) {\n\t\tbus_width = SD_BUS_WIDTH_4;\n\t} else {\n\t\tif (CHK_MMC_8BIT(sd_card))\n\t\t\tbus_width = SD_BUS_WIDTH_8;\n\t\telse if (CHK_MMC_4BIT(sd_card))\n\t\t\tbus_width = SD_BUS_WIDTH_4;\n\t\telse\n\t\t\tbus_width = SD_BUS_WIDTH_1;\n\t}\n\n\tretval = sd_wait_state_data_ready(chip, 0x08, 1, 1000);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\n\t\t\t\t     SD_RSP_80CLK_TIMEOUT_EN);\n\tif (retval)\n\t\treturn retval;\n\n\tcmd[0] = 0x40 | PROGRAM_CSD;\n\tcmd[1] = 0;\n\tcmd[2] = 0;\n\tcmd[3] = 0;\n\tcmd[4] = 0;\n\n\tretval = sd_write_data(chip, SD_TM_AUTO_WRITE_2, cmd, 5, 16, 1,\n\t\t\t       bus_width, sd_card->raw_csd, 16, 100);\n\tif (retval != STATUS_SUCCESS) {\n\t\trtsx_clear_sd_error(chip);\n\t\trtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN, 0);\n\t\treturn STATUS_FAIL;\n\t}\n\n\tretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\n\t\t\t\t     0);\n\tif (retval)\n\t\treturn retval;\n\n\tsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr, SD_RSP_TYPE_R1,\n\t\t\t    NULL, 0);\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic u8 sd_search_final_phase(struct rtsx_chip *chip, u32 phase_map,\n\t\t\t\tu8 tune_dir)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tstruct timing_phase_path path[MAX_PHASE + 1];\n\tint i, j, cont_path_cnt;\n\tbool new_block;\n\tint max_len, final_path_idx;\n\tu8 final_phase = 0xFF;\n\n\tif (phase_map == 0xFFFFFFFF) {\n\t\tif (tune_dir == TUNE_RX)\n\t\t\tfinal_phase = (u8)chip->sd_default_rx_phase;\n\t\telse\n\t\t\tfinal_phase = (u8)chip->sd_default_tx_phase;\n\n\t\tgoto search_finish;\n\t}\n\n\tcont_path_cnt = 0;\n\tnew_block = true;\n\tj = 0;\n\tfor (i = 0; i < MAX_PHASE + 1; i++) {\n\t\tif (phase_map & (1 << i)) {\n\t\t\tif (new_block) {\n\t\t\t\tnew_block = false;\n\t\t\t\tj = cont_path_cnt++;\n\t\t\t\tpath[j].start = i;\n\t\t\t\tpath[j].end = i;\n\t\t\t} else {\n\t\t\t\tpath[j].end = i;\n\t\t\t}\n\t\t} else {\n\t\t\tnew_block = true;\n\t\t\tif (cont_path_cnt) {\n\t\t\t\tint idx = cont_path_cnt - 1;\n\n\t\t\t\tpath[idx].len = path[idx].end -\n\t\t\t\t\tpath[idx].start + 1;\n\t\t\t\tpath[idx].mid = path[idx].start +\n\t\t\t\t\tpath[idx].len / 2;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (cont_path_cnt == 0) {\n\t\tdev_dbg(rtsx_dev(chip), \"No continuous phase path\\n\");\n\t\tgoto search_finish;\n\t} else {\n\t\tint idx = cont_path_cnt - 1;\n\n\t\tpath[idx].len = path[idx].end - path[idx].start + 1;\n\t\tpath[idx].mid = path[idx].start + path[idx].len / 2;\n\t}\n\n\tif (path[0].start == 0 &&\n\t    path[cont_path_cnt - 1].end == MAX_PHASE) {\n\t\tpath[0].start = path[cont_path_cnt - 1].start - MAX_PHASE - 1;\n\t\tpath[0].len += path[cont_path_cnt - 1].len;\n\t\tpath[0].mid = path[0].start + path[0].len / 2;\n\t\tif (path[0].mid < 0)\n\t\t\tpath[0].mid += MAX_PHASE + 1;\n\n\t\tcont_path_cnt--;\n\t}\n\n\tmax_len = 0;\n\tfinal_phase = 0;\n\tfinal_path_idx = 0;\n\tfor (i = 0; i < cont_path_cnt; i++) {\n\t\tif (path[i].len > max_len) {\n\t\t\tmax_len = path[i].len;\n\t\t\tfinal_phase = (u8)path[i].mid;\n\t\t\tfinal_path_idx = i;\n\t\t}\n\n\t\tdev_dbg(rtsx_dev(chip), \"path[%d].start = %d\\n\",\n\t\t\ti, path[i].start);\n\t\tdev_dbg(rtsx_dev(chip), \"path[%d].end = %d\\n\", i, path[i].end);\n\t\tdev_dbg(rtsx_dev(chip), \"path[%d].len = %d\\n\", i, path[i].len);\n\t\tdev_dbg(rtsx_dev(chip), \"path[%d].mid = %d\\n\", i, path[i].mid);\n\t\tdev_dbg(rtsx_dev(chip), \"\\n\");\n\t}\n\n\tif (tune_dir == TUNE_TX) {\n\t\tif (CHK_SD_SDR104(sd_card)) {\n\t\t\tif (max_len > 15) {\n\t\t\t\tint temp_mid = (max_len - 16) / 2;\n\t\t\t\tint temp_final_phase =\n\t\t\t\t\tpath[final_path_idx].end -\n\t\t\t\t\t(max_len - (6 + temp_mid));\n\n\t\t\t\tif (temp_final_phase < 0)\n\t\t\t\t\tfinal_phase = (u8)(temp_final_phase +\n\t\t\t\t\t\t\tMAX_PHASE + 1);\n\t\t\t\telse\n\t\t\t\t\tfinal_phase = (u8)temp_final_phase;\n\t\t\t}\n\t\t} else if (CHK_SD_SDR50(sd_card)) {\n\t\t\tif (max_len > 12) {\n\t\t\t\tint temp_mid = (max_len - 13) / 2;\n\t\t\t\tint temp_final_phase =\n\t\t\t\t\tpath[final_path_idx].end -\n\t\t\t\t\t(max_len - (3 + temp_mid));\n\n\t\t\t\tif (temp_final_phase < 0)\n\t\t\t\t\tfinal_phase = (u8)(temp_final_phase +\n\t\t\t\t\t\t\tMAX_PHASE + 1);\n\t\t\t\telse\n\t\t\t\t\tfinal_phase = (u8)temp_final_phase;\n\t\t\t}\n\t\t}\n\t}\n\nsearch_finish:\n\tdev_dbg(rtsx_dev(chip), \"Final chosen phase: %d\\n\", final_phase);\n\treturn final_phase;\n}\n\nstatic int sd_tuning_rx(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tint i, j;\n\tu32 raw_phase_map[3], phase_map;\n\tu8 final_phase;\n\tint (*tuning_cmd)(struct rtsx_chip *chip, u8 sample_point);\n\n\tif (CHK_SD(sd_card)) {\n\t\tif (CHK_SD_DDR50(sd_card))\n\t\t\ttuning_cmd = sd_ddr_tuning_rx_cmd;\n\t\telse\n\t\t\ttuning_cmd = sd_sdr_tuning_rx_cmd;\n\n\t} else {\n\t\tif (CHK_MMC_DDR52(sd_card))\n\t\t\ttuning_cmd = mmc_ddr_tuning_rx_cmd;\n\t\telse\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\tfor (i = 0; i < 3; i++) {\n\t\traw_phase_map[i] = 0;\n\t\tfor (j = MAX_PHASE; j >= 0; j--) {\n\t\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\t\tsd_set_err_code(chip, SD_NO_CARD);\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\n\t\t\tretval = tuning_cmd(chip, (u8)j);\n\t\t\tif (retval == STATUS_SUCCESS)\n\t\t\t\traw_phase_map[i] |= 1 << j;\n\t\t}\n\t}\n\n\tphase_map = raw_phase_map[0] & raw_phase_map[1] & raw_phase_map[2];\n\tfor (i = 0; i < 3; i++)\n\t\tdev_dbg(rtsx_dev(chip), \"RX raw_phase_map[%d] = 0x%08x\\n\",\n\t\t\ti, raw_phase_map[i]);\n\n\tdev_dbg(rtsx_dev(chip), \"RX phase_map = 0x%08x\\n\", phase_map);\n\n\tfinal_phase = sd_search_final_phase(chip, phase_map, TUNE_RX);\n\tif (final_phase == 0xFF)\n\t\treturn STATUS_FAIL;\n\n\tretval = sd_change_phase(chip, final_phase, TUNE_RX);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_ddr_pre_tuning_tx(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tint i;\n\tu32 phase_map;\n\tu8 final_phase;\n\n\tretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\n\t\t\t\t     SD_RSP_80CLK_TIMEOUT_EN);\n\tif (retval)\n\t\treturn retval;\n\n\tphase_map = 0;\n\tfor (i = MAX_PHASE; i >= 0; i--) {\n\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\tsd_set_err_code(chip, SD_NO_CARD);\n\t\t\trtsx_write_register(chip, SD_CFG3,\n\t\t\t\t\t    SD_RSP_80CLK_TIMEOUT_EN, 0);\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\n\t\tretval = sd_change_phase(chip, (u8)i, TUNE_TX);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tcontinue;\n\n\t\tretval = sd_send_cmd_get_rsp(chip, SEND_STATUS,\n\t\t\t\t\t     sd_card->sd_addr, SD_RSP_TYPE_R1,\n\t\t\t\t\t     NULL, 0);\n\t\tif (retval == STATUS_SUCCESS ||\n\t\t    !sd_check_err_code(chip, SD_RSP_TIMEOUT))\n\t\t\tphase_map |= 1 << i;\n\t}\n\n\tretval = rtsx_write_register(chip, SD_CFG3, SD_RSP_80CLK_TIMEOUT_EN,\n\t\t\t\t     0);\n\tif (retval)\n\t\treturn retval;\n\n\tdev_dbg(rtsx_dev(chip), \"DDR TX pre tune phase_map = 0x%08x\\n\",\n\t\tphase_map);\n\n\tfinal_phase = sd_search_final_phase(chip, phase_map, TUNE_TX);\n\tif (final_phase == 0xFF)\n\t\treturn STATUS_FAIL;\n\n\tretval = sd_change_phase(chip, final_phase, TUNE_TX);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tdev_dbg(rtsx_dev(chip), \"DDR TX pre tune phase: %d\\n\",\n\t\t(int)final_phase);\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_tuning_tx(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tint i, j;\n\tu32 raw_phase_map[3], phase_map;\n\tu8 final_phase;\n\tint (*tuning_cmd)(struct rtsx_chip *chip, u8 sample_point);\n\n\tif (CHK_SD(sd_card)) {\n\t\tif (CHK_SD_DDR50(sd_card))\n\t\t\ttuning_cmd = sd_ddr_tuning_tx_cmd;\n\t\telse\n\t\t\ttuning_cmd = sd_sdr_tuning_tx_cmd;\n\n\t} else {\n\t\tif (CHK_MMC_DDR52(sd_card))\n\t\t\ttuning_cmd = sd_ddr_tuning_tx_cmd;\n\t\telse\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\tfor (i = 0; i < 3; i++) {\n\t\traw_phase_map[i] = 0;\n\t\tfor (j = MAX_PHASE; j >= 0; j--) {\n\t\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\t\tsd_set_err_code(chip, SD_NO_CARD);\n\t\t\t\trtsx_write_register(chip, SD_CFG3,\n\t\t\t\t\t\t    SD_RSP_80CLK_TIMEOUT_EN, 0);\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\n\t\t\tretval = tuning_cmd(chip, (u8)j);\n\t\t\tif (retval == STATUS_SUCCESS)\n\t\t\t\traw_phase_map[i] |= 1 << j;\n\t\t}\n\t}\n\n\tphase_map = raw_phase_map[0] & raw_phase_map[1] & raw_phase_map[2];\n\tfor (i = 0; i < 3; i++)\n\t\tdev_dbg(rtsx_dev(chip), \"TX raw_phase_map[%d] = 0x%08x\\n\",\n\t\t\ti, raw_phase_map[i]);\n\n\tdev_dbg(rtsx_dev(chip), \"TX phase_map = 0x%08x\\n\", phase_map);\n\n\tfinal_phase = sd_search_final_phase(chip, phase_map, TUNE_TX);\n\tif (final_phase == 0xFF)\n\t\treturn STATUS_FAIL;\n\n\tretval = sd_change_phase(chip, final_phase, TUNE_TX);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_sdr_tuning(struct rtsx_chip *chip)\n{\n\tint retval;\n\n\tretval = sd_tuning_tx(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = sd_tuning_rx(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_ddr_tuning(struct rtsx_chip *chip)\n{\n\tint retval;\n\n\tif (!(chip->sd_ctl & SD_DDR_TX_PHASE_SET_BY_USER)) {\n\t\tretval = sd_ddr_pre_tuning_tx(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t} else {\n\t\tretval = sd_change_phase(chip, (u8)chip->sd_ddr_tx_phase,\n\t\t\t\t\t TUNE_TX);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\tretval = sd_tuning_rx(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (!(chip->sd_ctl & SD_DDR_TX_PHASE_SET_BY_USER)) {\n\t\tretval = sd_tuning_tx(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int mmc_ddr_tuning(struct rtsx_chip *chip)\n{\n\tint retval;\n\n\tif (!(chip->sd_ctl & MMC_DDR_TX_PHASE_SET_BY_USER)) {\n\t\tretval = sd_ddr_pre_tuning_tx(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t} else {\n\t\tretval = sd_change_phase(chip, (u8)chip->mmc_ddr_tx_phase,\n\t\t\t\t\t TUNE_TX);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\tretval = sd_tuning_rx(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (!(chip->sd_ctl & MMC_DDR_TX_PHASE_SET_BY_USER)) {\n\t\tretval = sd_tuning_tx(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nint sd_switch_clock(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tint re_tuning = 0;\n\n\tretval = select_card(chip, SD_CARD);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = switch_clock(chip, sd_card->sd_clock);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (re_tuning) {\n\t\tif (CHK_SD(sd_card)) {\n\t\t\tif (CHK_SD_DDR50(sd_card))\n\t\t\t\tretval = sd_ddr_tuning(chip);\n\t\t\telse\n\t\t\t\tretval = sd_sdr_tuning(chip);\n\t\t} else {\n\t\t\tif (CHK_MMC_DDR52(sd_card))\n\t\t\t\tretval = mmc_ddr_tuning(chip);\n\t\t}\n\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_prepare_reset(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\n\tif (chip->asic_code)\n\t\tsd_card->sd_clock = 29;\n\telse\n\t\tsd_card->sd_clock = CLK_30;\n\n\tsd_card->sd_type = 0;\n\tsd_card->seq_mode = 0;\n\tsd_card->sd_data_buf_ready = 0;\n\tsd_card->capacity = 0;\n\n#ifdef SUPPORT_SD_LOCK\n\tsd_card->sd_lock_status = 0;\n\tsd_card->sd_erase_status = 0;\n#endif\n\n\tchip->capacity[chip->card2lun[SD_CARD]] = 0;\n\tchip->sd_io = 0;\n\n\tretval = sd_set_init_para(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn retval;\n\n\tretval = rtsx_write_register(chip, REG_SD_CFG1, 0xFF, 0x40);\n\tif (retval)\n\t\treturn retval;\n\n\tretval = rtsx_write_register(chip, CARD_STOP, SD_STOP | SD_CLR_ERR,\n\t\t\t\t     SD_STOP | SD_CLR_ERR);\n\tif (retval)\n\t\treturn retval;\n\n\tretval = select_card(chip, SD_CARD);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_pull_ctl_disable(struct rtsx_chip *chip)\n{\n\tint retval;\n\n\tif (CHECK_PID(chip, 0x5208)) {\n\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL1, 0xFF,\n\t\t\t\t\t     XD_D3_PD | SD_D7_PD | SD_CLK_PD |\n\t\t\t\t\t     SD_D5_PD);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL2, 0xFF,\n\t\t\t\t\t     SD_D6_PD | SD_D0_PD | SD_D1_PD |\n\t\t\t\t\t     XD_D5_PD);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL3, 0xFF,\n\t\t\t\t\t     SD_D4_PD | XD_CE_PD | XD_CLE_PD |\n\t\t\t\t\t     XD_CD_PU);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL4, 0xFF,\n\t\t\t\t\t     XD_RDY_PD | SD_D3_PD | SD_D2_PD |\n\t\t\t\t\t     XD_ALE_PD);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL5, 0xFF,\n\t\t\t\t\t     MS_INS_PU | SD_WP_PD | SD_CD_PU |\n\t\t\t\t\t     SD_CMD_PD);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL6, 0xFF,\n\t\t\t\t\t     MS_D5_PD | MS_D4_PD);\n\t\tif (retval)\n\t\t\treturn retval;\n\t} else if (CHECK_PID(chip, 0x5288)) {\n\t\tif (CHECK_BARO_PKG(chip, QFN)) {\n\t\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL1,\n\t\t\t\t\t\t     0xFF, 0x55);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL2,\n\t\t\t\t\t\t     0xFF, 0x55);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL3,\n\t\t\t\t\t\t     0xFF, 0x4B);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t\tretval = rtsx_write_register(chip, CARD_PULL_CTL4,\n\t\t\t\t\t\t     0xFF, 0x69);\n\t\t\tif (retval)\n\t\t\t\treturn retval;\n\t\t}\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nint sd_pull_ctl_enable(struct rtsx_chip *chip)\n{\n\tint retval;\n\n\trtsx_init_cmd(chip);\n\n\tif (CHECK_PID(chip, 0x5208)) {\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL1, 0xFF,\n\t\t\t     XD_D3_PD | SD_DAT7_PU | SD_CLK_NP | SD_D5_PU);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL2, 0xFF,\n\t\t\t     SD_D6_PU | SD_D0_PU | SD_D1_PU | XD_D5_PD);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL3, 0xFF,\n\t\t\t     SD_D4_PU | XD_CE_PD | XD_CLE_PD | XD_CD_PU);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL4, 0xFF,\n\t\t\t     XD_RDY_PD | SD_D3_PU | SD_D2_PU | XD_ALE_PD);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL5, 0xFF,\n\t\t\t     MS_INS_PU | SD_WP_PU | SD_CD_PU | SD_CMD_PU);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL6, 0xFF,\n\t\t\t     MS_D5_PD | MS_D4_PD);\n\t} else if (CHECK_PID(chip, 0x5288)) {\n\t\tif (CHECK_BARO_PKG(chip, QFN)) {\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL1, 0xFF,\n\t\t\t\t     0xA8);\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL2, 0xFF,\n\t\t\t\t     0x5A);\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL3, 0xFF,\n\t\t\t\t     0x95);\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL4, 0xFF,\n\t\t\t\t     0xAA);\n\t\t}\n\t}\n\n\tretval = rtsx_send_cmd(chip, SD_CARD, 100);\n\tif (retval < 0)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_init_power(struct rtsx_chip *chip)\n{\n\tint retval;\n\n\tretval = sd_power_off_card3v3(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (!chip->ft2_fast_mode)\n\t\twait_timeout(250);\n\n\tretval = enable_card_clock(chip, SD_CARD);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (chip->asic_code) {\n\t\tretval = sd_pull_ctl_enable(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t} else {\n\t\tretval = rtsx_write_register(chip, FPGA_PULL_CTL,\n\t\t\t\t\t     FPGA_SD_PULL_CTL_BIT | 0x20, 0);\n\t\tif (retval)\n\t\t\treturn retval;\n\t}\n\n\tif (!chip->ft2_fast_mode) {\n\t\tretval = card_power_on(chip, SD_CARD);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\n\t\twait_timeout(260);\n\n#ifdef SUPPORT_OCP\n\t\tif (chip->ocp_stat & (SD_OC_NOW | SD_OC_EVER)) {\n\t\t\tdev_dbg(rtsx_dev(chip), \"Over current, OCPSTAT is 0x%x\\n\",\n\t\t\t\tchip->ocp_stat);\n\t\t\treturn STATUS_FAIL;\n\t\t}\n#endif\n\t}\n\n\tretval = rtsx_write_register(chip, CARD_OE, SD_OUTPUT_EN,\n\t\t\t\t     SD_OUTPUT_EN);\n\tif (retval)\n\t\treturn retval;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_dummy_clock(struct rtsx_chip *chip)\n{\n\tint retval;\n\n\tretval = rtsx_write_register(chip, REG_SD_CFG3, 0x01, 0x01);\n\tif (retval)\n\t\treturn retval;\n\twait_timeout(5);\n\tretval = rtsx_write_register(chip, REG_SD_CFG3, 0x01, 0);\n\tif (retval)\n\t\treturn retval;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_read_lba0(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 cmd[5], bus_width;\n\n\tcmd[0] = 0x40 | READ_SINGLE_BLOCK;\n\tcmd[1] = 0;\n\tcmd[2] = 0;\n\tcmd[3] = 0;\n\tcmd[4] = 0;\n\n\tif (CHK_SD(sd_card)) {\n\t\tbus_width = SD_BUS_WIDTH_4;\n\t} else {\n\t\tif (CHK_MMC_8BIT(sd_card))\n\t\t\tbus_width = SD_BUS_WIDTH_8;\n\t\telse if (CHK_MMC_4BIT(sd_card))\n\t\t\tbus_width = SD_BUS_WIDTH_4;\n\t\telse\n\t\t\tbus_width = SD_BUS_WIDTH_1;\n\t}\n\n\tretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 512, 1,\n\t\t\t      bus_width, NULL, 0, 100);\n\tif (retval != STATUS_SUCCESS) {\n\t\trtsx_clear_sd_error(chip);\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int sd_check_wp_state(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu32 val;\n\tu16 sd_card_type;\n\tu8 cmd[5], buf[64];\n\n\tretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\n\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tcmd[0] = 0x40 | SD_STATUS;\n\tcmd[1] = 0;\n\tcmd[2] = 0;\n\tcmd[3] = 0;\n\tcmd[4] = 0;\n\n\tretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, 64, 1,\n\t\t\t      SD_BUS_WIDTH_4, buf, 64, 250);\n\tif (retval != STATUS_SUCCESS) {\n\t\trtsx_clear_sd_error(chip);\n\n\t\tsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t    SD_RSP_TYPE_R1, NULL, 0);\n\t\treturn STATUS_FAIL;\n\t}\n\n\tdev_dbg(rtsx_dev(chip), \"ACMD13:\\n\");\n\tdev_dbg(rtsx_dev(chip), \"%*ph\\n\", 64, buf);\n\n\tsd_card_type = ((u16)buf[2] << 8) | buf[3];\n\tdev_dbg(rtsx_dev(chip), \"sd_card_type = 0x%04x\\n\", sd_card_type);\n\tif (sd_card_type == 0x0001 || sd_card_type == 0x0002) {\n\t\t \n\t\tchip->card_wp |= SD_CARD;\n\t}\n\n\t \n\tval = rtsx_readl(chip, RTSX_BIPR);\n\tif (val & SD_WRITE_PROTECT)\n\t\tchip->card_wp |= SD_CARD;\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int reset_sd(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tbool hi_cap_flow = false;\n\tint retval, i = 0, j = 0, k = 0;\n\tbool sd_dont_switch = false;\n\tbool support_1v8 = false;\n\tbool try_sdio = true;\n\tu8 rsp[16];\n\tu8 switch_bus_width;\n\tu32 voltage = 0;\n\tbool sd20_mode = false;\n\n\tSET_SD(sd_card);\n\nswitch_fail:\n\n\ti = 0;\n\tj = 0;\n\tk = 0;\n\thi_cap_flow = false;\n\n#ifdef SUPPORT_SD_LOCK\n\tif (sd_card->sd_lock_status & SD_UNLOCK_POW_ON)\n\t\tgoto SD_UNLOCK_ENTRY;\n#endif\n\n\tretval = sd_prepare_reset(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tretval = sd_dummy_clock(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tif (CHK_SDIO_EXIST(chip) && !CHK_SDIO_IGNORED(chip) && try_sdio) {\n\t\tint rty_cnt = 0;\n\n\t\tfor (; rty_cnt < chip->sdio_retry_cnt; rty_cnt++) {\n\t\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\t\tsd_set_err_code(chip, SD_NO_CARD);\n\t\t\t\tgoto status_fail;\n\t\t\t}\n\n\t\t\tretval = sd_send_cmd_get_rsp(chip, IO_SEND_OP_COND, 0,\n\t\t\t\t\t\t     SD_RSP_TYPE_R4, rsp, 5);\n\t\t\tif (retval == STATUS_SUCCESS) {\n\t\t\t\tint func_num = (rsp[1] >> 4) & 0x07;\n\n\t\t\t\tif (func_num) {\n\t\t\t\t\tdev_dbg(rtsx_dev(chip), \"SD_IO card (Function number: %d)!\\n\",\n\t\t\t\t\t\tfunc_num);\n\t\t\t\t\tchip->sd_io = 1;\n\t\t\t\t\tgoto status_fail;\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tsd_init_power(chip);\n\n\t\t\tsd_dummy_clock(chip);\n\t\t}\n\n\t\tdev_dbg(rtsx_dev(chip), \"Normal card!\\n\");\n\t}\n\n\t \nRTY_SD_RST:\n\tretval = sd_send_cmd_get_rsp(chip, GO_IDLE_STATE, 0, SD_RSP_TYPE_R0,\n\t\t\t\t     NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\twait_timeout(20);\n\n\tretval = sd_send_cmd_get_rsp(chip, SEND_IF_COND, 0x000001AA,\n\t\t\t\t     SD_RSP_TYPE_R7, rsp, 5);\n\tif (retval == STATUS_SUCCESS) {\n\t\tif (rsp[4] == 0xAA && ((rsp[3] & 0x0f) == 0x01)) {\n\t\t\thi_cap_flow = true;\n\t\t\tvoltage = SUPPORT_VOLTAGE | 0x40000000;\n\t\t}\n\t}\n\n\tif (!hi_cap_flow) {\n\t\tvoltage = SUPPORT_VOLTAGE;\n\n\t\tretval = sd_send_cmd_get_rsp(chip, GO_IDLE_STATE, 0,\n\t\t\t\t\t     SD_RSP_TYPE_R0, NULL, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto status_fail;\n\n\t\twait_timeout(20);\n\t}\n\n\tdo {\n\t\tretval = sd_send_cmd_get_rsp(chip, APP_CMD, 0, SD_RSP_TYPE_R1,\n\t\t\t\t\t     NULL, 0);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\t\tsd_set_err_code(chip, SD_NO_CARD);\n\t\t\t\tgoto status_fail;\n\t\t\t}\n\n\t\t\tj++;\n\t\t\tif (j < 3)\n\t\t\t\tgoto RTY_SD_RST;\n\t\t\telse\n\t\t\t\tgoto status_fail;\n\t\t}\n\n\t\tretval = sd_send_cmd_get_rsp(chip, SD_APP_OP_COND, voltage,\n\t\t\t\t\t     SD_RSP_TYPE_R3, rsp, 5);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tk++;\n\t\t\tif (k < 3)\n\t\t\t\tgoto RTY_SD_RST;\n\t\t\telse\n\t\t\t\tgoto status_fail;\n\t\t}\n\n\t\ti++;\n\t\twait_timeout(20);\n\t} while (!(rsp[1] & 0x80) && (i < 255));\n\n\tif (i == 255)\n\t\tgoto status_fail;\n\n\tif (hi_cap_flow) {\n\t\tif (rsp[1] & 0x40)\n\t\t\tSET_SD_HCXC(sd_card);\n\t\telse\n\t\t\tCLR_SD_HCXC(sd_card);\n\n\t\tsupport_1v8 = false;\n\t} else {\n\t\tCLR_SD_HCXC(sd_card);\n\t\tsupport_1v8 = false;\n\t}\n\tdev_dbg(rtsx_dev(chip), \"support_1v8 = %d\\n\", support_1v8);\n\n\tif (support_1v8) {\n\t\tretval = sd_voltage_switch(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto status_fail;\n\t}\n\n\tretval = sd_send_cmd_get_rsp(chip, ALL_SEND_CID, 0, SD_RSP_TYPE_R2,\n\t\t\t\t     NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tretval = sd_send_cmd_get_rsp(chip, SEND_RELATIVE_ADDR, 0,\n\t\t\t\t\t     SD_RSP_TYPE_R6, rsp, 5);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto status_fail;\n\n\t\tsd_card->sd_addr = (u32)rsp[1] << 24;\n\t\tsd_card->sd_addr += (u32)rsp[2] << 16;\n\n\t\tif (sd_card->sd_addr)\n\t\t\tbreak;\n\t}\n\n\tretval = sd_check_csd(chip, 1);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tretval = sd_select_card(chip, 1);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n#ifdef SUPPORT_SD_LOCK\nSD_UNLOCK_ENTRY:\n\tretval = sd_update_lock_status(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tif (sd_card->sd_lock_status & SD_LOCKED) {\n\t\tsd_card->sd_lock_status |= (SD_LOCK_1BIT_MODE | SD_PWD_EXIST);\n\t\treturn STATUS_SUCCESS;\n\t} else if (!(sd_card->sd_lock_status & SD_UNLOCK_POW_ON)) {\n\t\tsd_card->sd_lock_status &= ~SD_PWD_EXIST;\n\t}\n#endif\n\n\tretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\n\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tretval = sd_send_cmd_get_rsp(chip, SET_CLR_CARD_DETECT, 0,\n\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tif (support_1v8) {\n\t\tretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\n\t\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto status_fail;\n\n\t\tretval = sd_send_cmd_get_rsp(chip, SET_BUS_WIDTH, 2,\n\t\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto status_fail;\n\n\t\tswitch_bus_width = SD_BUS_WIDTH_4;\n\t} else {\n\t\tswitch_bus_width = SD_BUS_WIDTH_1;\n\t}\n\n\tretval = sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200, SD_RSP_TYPE_R1,\n\t\t\t\t     NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tretval = sd_set_clock_divider(chip, SD_CLK_DIVIDE_0);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tif (!(sd_card->raw_csd[4] & 0x40))\n\t\tsd_dont_switch = true;\n\n\tif (!sd_dont_switch) {\n\t\tif (sd20_mode) {\n\t\t\t \n\t\t\tsd_card->sd_switch_fail = SDR104_SUPPORT_MASK |\n\t\t\t\tDDR50_SUPPORT_MASK | SDR50_SUPPORT_MASK;\n\t\t}\n\n\t\t \n\t\tretval = sd_check_spec(chip, switch_bus_width);\n\t\tif (retval == STATUS_SUCCESS) {\n\t\t\tretval = sd_switch_function(chip, switch_bus_width);\n\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\tsd_init_power(chip);\n\t\t\t\tsd_dont_switch = true;\n\t\t\t\ttry_sdio = false;\n\n\t\t\t\tgoto switch_fail;\n\t\t\t}\n\t\t} else {\n\t\t\tif (support_1v8) {\n\t\t\t\tsd_init_power(chip);\n\t\t\t\tsd_dont_switch = true;\n\t\t\t\ttry_sdio = false;\n\n\t\t\t\tgoto switch_fail;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (!support_1v8) {\n\t\tretval = sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\n\t\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto status_fail;\n\n\t\tretval = sd_send_cmd_get_rsp(chip, SET_BUS_WIDTH, 2,\n\t\t\t\t\t     SD_RSP_TYPE_R1, NULL, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto status_fail;\n\t}\n\n#ifdef SUPPORT_SD_LOCK\n\tsd_card->sd_lock_status &= ~SD_LOCK_1BIT_MODE;\n#endif\n\n\tif (!sd20_mode && CHK_SD30_SPEED(sd_card)) {\n\t\tint read_lba0 = 1;\n\n\t\tretval = rtsx_write_register(chip, SD30_DRIVE_SEL, 0x07,\n\t\t\t\t\t     chip->sd30_drive_sel_1v8);\n\t\tif (retval)\n\t\t\treturn retval;\n\n\t\tretval = sd_set_init_para(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto status_fail;\n\n\t\tif (CHK_SD_DDR50(sd_card))\n\t\t\tretval = sd_ddr_tuning(chip);\n\t\telse\n\t\t\tretval = sd_sdr_tuning(chip);\n\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tretval = sd_init_power(chip);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\tgoto status_fail;\n\n\t\t\ttry_sdio = false;\n\t\t\tsd20_mode = true;\n\t\t\tgoto switch_fail;\n\t\t}\n\n\t\tsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t    SD_RSP_TYPE_R1, NULL, 0);\n\n\t\tif (CHK_SD_DDR50(sd_card)) {\n\t\t\tretval = sd_wait_state_data_ready(chip, 0x08, 1, 1000);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\tread_lba0 = 0;\n\t\t}\n\n\t\tif (read_lba0) {\n\t\t\tretval = sd_read_lba0(chip);\n\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\tretval = sd_init_power(chip);\n\t\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\t\tgoto status_fail;\n\n\t\t\t\ttry_sdio = false;\n\t\t\t\tsd20_mode = true;\n\t\t\t\tgoto switch_fail;\n\t\t\t}\n\t\t}\n\t}\n\n\tretval = sd_check_wp_state(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto status_fail;\n\n\tchip->card_bus_width[chip->card2lun[SD_CARD]] = 4;\n\n#ifdef SUPPORT_SD_LOCK\n\tif (sd_card->sd_lock_status & SD_UNLOCK_POW_ON) {\n\t\tretval = rtsx_write_register(chip, REG_SD_BLOCK_CNT_H, 0xFF,\n\t\t\t\t\t     0x02);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, REG_SD_BLOCK_CNT_L, 0xFF,\n\t\t\t\t\t     0x00);\n\t\tif (retval)\n\t\t\treturn retval;\n\t}\n#endif\n\n\treturn STATUS_SUCCESS;\n\nstatus_fail:\n\treturn STATUS_FAIL;\n}\n\nstatic int mmc_test_switch_bus(struct rtsx_chip *chip, u8 width)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 buf[8] = {0}, bus_width, *ptr;\n\tu16 byte_cnt;\n\tint len;\n\n\tretval = sd_send_cmd_get_rsp(chip, BUSTEST_W, 0, SD_RSP_TYPE_R1, NULL,\n\t\t\t\t     0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn SWITCH_FAIL;\n\n\tif (width == MMC_8BIT_BUS) {\n\t\tbuf[0] = 0x55;\n\t\tbuf[1] = 0xAA;\n\t\tlen = 8;\n\t\tbyte_cnt = 8;\n\t\tbus_width = SD_BUS_WIDTH_8;\n\t} else {\n\t\tbuf[0] = 0x5A;\n\t\tlen = 4;\n\t\tbyte_cnt = 4;\n\t\tbus_width = SD_BUS_WIDTH_4;\n\t}\n\n\tretval = rtsx_write_register(chip, REG_SD_CFG3, 0x02, 0x02);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn SWITCH_ERR;\n\n\tretval = sd_write_data(chip, SD_TM_AUTO_WRITE_3, NULL, 0, byte_cnt, 1,\n\t\t\t       bus_width, buf, len, 100);\n\tif (retval != STATUS_SUCCESS) {\n\t\trtsx_clear_sd_error(chip);\n\t\trtsx_write_register(chip, REG_SD_CFG3, 0x02, 0);\n\t\treturn SWITCH_ERR;\n\t}\n\n\tretval = rtsx_write_register(chip, REG_SD_CFG3, 0x02, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn SWITCH_ERR;\n\n\tdev_dbg(rtsx_dev(chip), \"SD/MMC CMD %d\\n\", BUSTEST_R);\n\n\trtsx_init_cmd(chip);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF, 0x40 | BUSTEST_R);\n\n\tif (width == MMC_8BIT_BUS)\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L,\n\t\t\t     0xFF, 0x08);\n\telse\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L,\n\t\t\t     0xFF, 0x04);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF, 1);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF, 0);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF, SD_CALCULATE_CRC7 |\n\t\t     SD_NO_CHECK_CRC16 | SD_NO_WAIT_BUSY_END |\n\t\t     SD_CHECK_CRC7 | SD_RSP_LEN_6);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01,\n\t\t     PINGPONG_BUFFER);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t     SD_TM_NORMAL_READ | SD_TRANSFER_START);\n\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER, SD_TRANSFER_END,\n\t\t     SD_TRANSFER_END);\n\n\trtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2, 0, 0);\n\tif (width == MMC_8BIT_BUS)\n\t\trtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 1, 0, 0);\n\n\tretval = rtsx_send_cmd(chip, SD_CARD, 100);\n\tif (retval < 0) {\n\t\trtsx_clear_sd_error(chip);\n\t\treturn SWITCH_ERR;\n\t}\n\n\tptr = rtsx_get_cmd_data(chip) + 1;\n\n\tif (width == MMC_8BIT_BUS) {\n\t\tdev_dbg(rtsx_dev(chip), \"BUSTEST_R [8bits]: 0x%02x 0x%02x\\n\",\n\t\t\tptr[0], ptr[1]);\n\t\tif (ptr[0] == 0xAA && ptr[1] == 0x55) {\n\t\t\tu8 rsp[5];\n\t\t\tu32 arg;\n\n\t\t\tif (CHK_MMC_DDR52(sd_card))\n\t\t\t\targ = 0x03B70600;\n\t\t\telse\n\t\t\t\targ = 0x03B70200;\n\n\t\t\tretval = sd_send_cmd_get_rsp(chip, SWITCH, arg,\n\t\t\t\t\t\t     SD_RSP_TYPE_R1b, rsp, 5);\n\t\t\tif (retval == STATUS_SUCCESS &&\n\t\t\t    !(rsp[4] & MMC_SWITCH_ERR))\n\t\t\t\treturn SWITCH_SUCCESS;\n\t\t}\n\t} else {\n\t\tdev_dbg(rtsx_dev(chip), \"BUSTEST_R [4bits]: 0x%02x\\n\", ptr[0]);\n\t\tif (ptr[0] == 0xA5) {\n\t\t\tu8 rsp[5];\n\t\t\tu32 arg;\n\n\t\t\tif (CHK_MMC_DDR52(sd_card))\n\t\t\t\targ = 0x03B70500;\n\t\t\telse\n\t\t\t\targ = 0x03B70100;\n\n\t\t\tretval = sd_send_cmd_get_rsp(chip, SWITCH, arg,\n\t\t\t\t\t\t     SD_RSP_TYPE_R1b, rsp, 5);\n\t\t\tif (retval == STATUS_SUCCESS &&\n\t\t\t    !(rsp[4] & MMC_SWITCH_ERR))\n\t\t\t\treturn SWITCH_SUCCESS;\n\t\t}\n\t}\n\n\treturn SWITCH_FAIL;\n}\n\nstatic int mmc_switch_timing_bus(struct rtsx_chip *chip, bool switch_ddr)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\tu8 *ptr, card_type, card_type_mask = 0;\n\n\tCLR_MMC_HS(sd_card);\n\n\tdev_dbg(rtsx_dev(chip), \"SD/MMC CMD %d\\n\", SEND_EXT_CSD);\n\n\trtsx_init_cmd(chip);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF,\n\t\t     0x40 | SEND_EXT_CSD);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD1, 0xFF, 0);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD2, 0xFF, 0);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD3, 0xFF, 0);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD4, 0xFF, 0);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF, 0);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF, 2);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF, 1);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF, 0);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\n\t\t     SD_CALCULATE_CRC7 | SD_CHECK_CRC16 | SD_NO_WAIT_BUSY_END |\n\t\t     SD_CHECK_CRC7 | SD_RSP_LEN_6);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01,\n\t\t     PINGPONG_BUFFER);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t     SD_TM_NORMAL_READ | SD_TRANSFER_START);\n\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER, SD_TRANSFER_END,\n\t\t     SD_TRANSFER_END);\n\n\trtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 196, 0xFF, 0);\n\trtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 212, 0xFF, 0);\n\trtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 213, 0xFF, 0);\n\trtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 214, 0xFF, 0);\n\trtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 215, 0xFF, 0);\n\n\tretval = rtsx_send_cmd(chip, SD_CARD, 1000);\n\tif (retval < 0) {\n\t\tif (retval == -ETIMEDOUT) {\n\t\t\trtsx_clear_sd_error(chip);\n\t\t\tsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t\t    SD_RSP_TYPE_R1, NULL, 0);\n\t\t}\n\t\treturn STATUS_FAIL;\n\t}\n\n\tptr = rtsx_get_cmd_data(chip);\n\tif (ptr[0] & SD_TRANSFER_ERR) {\n\t\tsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t    SD_RSP_TYPE_R1, NULL, 0);\n\t\treturn STATUS_FAIL;\n\t}\n\n\tif (CHK_MMC_SECTOR_MODE(sd_card)) {\n\t\tsd_card->capacity = ((u32)ptr[5] << 24) | ((u32)ptr[4] << 16) |\n\t\t\t((u32)ptr[3] << 8) | ((u32)ptr[2]);\n\t}\n\n\tcard_type_mask = 0x03;\n\tcard_type = ptr[1] & card_type_mask;\n\tif (card_type) {\n\t\tu8 rsp[5];\n\n\t\tif (card_type & 0x04) {\n\t\t\tif (switch_ddr)\n\t\t\t\tSET_MMC_DDR52(sd_card);\n\t\t\telse\n\t\t\t\tSET_MMC_52M(sd_card);\n\t\t} else if (card_type & 0x02) {\n\t\t\tSET_MMC_52M(sd_card);\n\t\t} else {\n\t\t\tSET_MMC_26M(sd_card);\n\t\t}\n\n\t\tretval = sd_send_cmd_get_rsp(chip, SWITCH, 0x03B90100,\n\t\t\t\t\t     SD_RSP_TYPE_R1b, rsp, 5);\n\t\tif (retval != STATUS_SUCCESS || (rsp[4] & MMC_SWITCH_ERR))\n\t\t\tCLR_MMC_HS(sd_card);\n\t}\n\n\tsd_choose_proper_clock(chip);\n\tretval = switch_clock(chip, sd_card->sd_clock);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\t \n\tretval = mmc_test_switch_bus(chip, MMC_8BIT_BUS);\n\tif (retval == SWITCH_SUCCESS) {\n\t\tSET_MMC_8BIT(sd_card);\n\t\tchip->card_bus_width[chip->card2lun[SD_CARD]] = 8;\n#ifdef SUPPORT_SD_LOCK\n\t\tsd_card->sd_lock_status &= ~SD_LOCK_1BIT_MODE;\n#endif\n\t} else if (retval == SWITCH_FAIL) {\n\t\tretval = mmc_test_switch_bus(chip, MMC_4BIT_BUS);\n\t\tif (retval == SWITCH_SUCCESS) {\n\t\t\tSET_MMC_4BIT(sd_card);\n\t\t\tchip->card_bus_width[chip->card2lun[SD_CARD]] = 4;\n#ifdef SUPPORT_SD_LOCK\n\t\t\tsd_card->sd_lock_status &= ~SD_LOCK_1BIT_MODE;\n#endif\n\t\t} else if (retval == SWITCH_FAIL) {\n\t\t\tCLR_MMC_8BIT(sd_card);\n\t\t\tCLR_MMC_4BIT(sd_card);\n\t\t} else {\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\t} else {\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int reset_mmc(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval, i = 0, j = 0, k = 0;\n\tbool switch_ddr = true;\n\tu8 rsp[16];\n\tu8 spec_ver = 0;\n\tu32 temp;\n\n#ifdef SUPPORT_SD_LOCK\n\tif (sd_card->sd_lock_status & SD_UNLOCK_POW_ON)\n\t\tgoto MMC_UNLOCK_ENTRY;\n#endif\n\nswitch_fail:\n\tretval = sd_prepare_reset(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn retval;\n\n\tSET_MMC(sd_card);\n\nRTY_MMC_RST:\n\tretval = sd_send_cmd_get_rsp(chip, GO_IDLE_STATE, 0, SD_RSP_TYPE_R0,\n\t\t\t\t     NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tdo {\n\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\tsd_set_err_code(chip, SD_NO_CARD);\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\n\t\tretval = sd_send_cmd_get_rsp(chip, SEND_OP_COND,\n\t\t\t\t\t     (SUPPORT_VOLTAGE | 0x40000000),\n\t\t\t\t\t     SD_RSP_TYPE_R3, rsp, 5);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tif (sd_check_err_code(chip, SD_BUSY) ||\n\t\t\t    sd_check_err_code(chip, SD_TO_ERR)) {\n\t\t\t\tk++;\n\t\t\t\tif (k < 20) {\n\t\t\t\t\tsd_clr_err_code(chip);\n\t\t\t\t\tgoto RTY_MMC_RST;\n\t\t\t\t} else {\n\t\t\t\t\treturn STATUS_FAIL;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tj++;\n\t\t\t\tif (j < 100) {\n\t\t\t\t\tsd_clr_err_code(chip);\n\t\t\t\t\tgoto RTY_MMC_RST;\n\t\t\t\t} else {\n\t\t\t\t\treturn STATUS_FAIL;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\twait_timeout(20);\n\t\ti++;\n\t} while (!(rsp[1] & 0x80) && (i < 255));\n\n\tif (i == 255)\n\t\treturn STATUS_FAIL;\n\n\tif ((rsp[1] & 0x60) == 0x40)\n\t\tSET_MMC_SECTOR_MODE(sd_card);\n\telse\n\t\tCLR_MMC_SECTOR_MODE(sd_card);\n\n\tretval = sd_send_cmd_get_rsp(chip, ALL_SEND_CID, 0, SD_RSP_TYPE_R2,\n\t\t\t\t     NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tsd_card->sd_addr = 0x00100000;\n\tretval = sd_send_cmd_get_rsp(chip, SET_RELATIVE_ADDR, sd_card->sd_addr,\n\t\t\t\t     SD_RSP_TYPE_R6, rsp, 5);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = sd_check_csd(chip, 1);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tspec_ver = (sd_card->raw_csd[0] & 0x3C) >> 2;\n\n\tretval = sd_select_card(chip, 1);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200, SD_RSP_TYPE_R1,\n\t\t\t\t     NULL, 0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n#ifdef SUPPORT_SD_LOCK\nMMC_UNLOCK_ENTRY:\n\tretval = sd_update_lock_status(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n#endif\n\n\tretval = sd_set_clock_divider(chip, SD_CLK_DIVIDE_0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tchip->card_bus_width[chip->card2lun[SD_CARD]] = 1;\n\n\tif (!sd_card->mmc_dont_switch_bus) {\n\t\tif (spec_ver == 4) {\n\t\t\t \n\t\t\tretval = mmc_switch_timing_bus(chip, switch_ddr);\n\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\tretval = sd_init_power(chip);\n\t\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\t\treturn STATUS_FAIL;\n\t\t\t\tsd_card->mmc_dont_switch_bus = 1;\n\t\t\t\tgoto switch_fail;\n\t\t\t}\n\t\t}\n\n\t\tif (CHK_MMC_SECTOR_MODE(sd_card) && sd_card->capacity == 0)\n\t\t\treturn STATUS_FAIL;\n\n\t\tif (switch_ddr && CHK_MMC_DDR52(sd_card)) {\n\t\t\tretval = sd_set_init_para(chip);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn STATUS_FAIL;\n\n\t\t\tretval = mmc_ddr_tuning(chip);\n\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\tretval = sd_init_power(chip);\n\t\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\t\treturn STATUS_FAIL;\n\n\t\t\t\tswitch_ddr = false;\n\t\t\t\tgoto switch_fail;\n\t\t\t}\n\n\t\t\tretval = sd_wait_state_data_ready(chip, 0x08, 1, 1000);\n\t\t\tif (retval == STATUS_SUCCESS) {\n\t\t\t\tretval = sd_read_lba0(chip);\n\t\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\t\tretval = sd_init_power(chip);\n\t\t\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\t\t\treturn STATUS_FAIL;\n\n\t\t\t\t\tswitch_ddr = false;\n\t\t\t\t\tgoto switch_fail;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n#ifdef SUPPORT_SD_LOCK\n\tif (sd_card->sd_lock_status & SD_UNLOCK_POW_ON) {\n\t\tretval = rtsx_write_register(chip, REG_SD_BLOCK_CNT_H, 0xFF,\n\t\t\t\t\t     0x02);\n\t\tif (retval)\n\t\t\treturn retval;\n\t\tretval = rtsx_write_register(chip, REG_SD_BLOCK_CNT_L, 0xFF,\n\t\t\t\t\t     0x00);\n\t\tif (retval)\n\t\t\treturn retval;\n\t}\n#endif\n\n\ttemp = rtsx_readl(chip, RTSX_BIPR);\n\tif (temp & SD_WRITE_PROTECT)\n\t\tchip->card_wp |= SD_CARD;\n\n\treturn STATUS_SUCCESS;\n}\n\nint reset_sd_card(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\n\tsd_init_reg_addr(chip);\n\n\tmemset(sd_card, 0, sizeof(struct sd_info));\n\tchip->capacity[chip->card2lun[SD_CARD]] = 0;\n\n\tretval = enable_card_clock(chip, SD_CARD);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (chip->ignore_sd && CHK_SDIO_EXIST(chip) &&\n\t    !CHK_SDIO_IGNORED(chip)) {\n\t\tif (chip->asic_code) {\n\t\t\tretval = sd_pull_ctl_enable(chip);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn STATUS_FAIL;\n\t\t} else {\n\t\t\tretval = rtsx_write_register(chip, FPGA_PULL_CTL,\n\t\t\t\t\t\t     FPGA_SD_PULL_CTL_BIT |\n\t\t\t\t\t\t     0x20, 0);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn STATUS_FAIL;\n\t\t}\n\t\tretval = card_share_mode(chip, SD_CARD);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\n\t\tchip->sd_io = 1;\n\t\treturn STATUS_FAIL;\n\t}\n\n\tretval = sd_init_power(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (chip->sd_ctl & RESET_MMC_FIRST) {\n\t\tretval = reset_mmc(chip);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tif (sd_check_err_code(chip, SD_NO_CARD))\n\t\t\t\treturn STATUS_FAIL;\n\n\t\t\tretval = reset_sd(chip);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn STATUS_FAIL;\n\t\t}\n\t} else {\n\t\tretval = reset_sd(chip);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tif (sd_check_err_code(chip, SD_NO_CARD))\n\t\t\t\treturn STATUS_FAIL;\n\n\t\t\tif (chip->sd_io)\n\t\t\t\treturn STATUS_FAIL;\n\t\t\tretval = reset_mmc(chip);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn STATUS_FAIL;\n\t\t}\n\t}\n\n\tretval = sd_set_clock_divider(chip, SD_CLK_DIVIDE_0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = rtsx_write_register(chip, REG_SD_BYTE_CNT_L, 0xFF, 0);\n\tif (retval)\n\t\treturn retval;\n\tretval = rtsx_write_register(chip, REG_SD_BYTE_CNT_H, 0xFF, 2);\n\tif (retval)\n\t\treturn retval;\n\n\tchip->capacity[chip->card2lun[SD_CARD]] = sd_card->capacity;\n\n\tretval = sd_set_init_para(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tdev_dbg(rtsx_dev(chip), \"sd_card->sd_type = 0x%x\\n\", sd_card->sd_type);\n\n\treturn STATUS_SUCCESS;\n}\n\nstatic int reset_mmc_only(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\n\tsd_card->sd_type = 0;\n\tsd_card->seq_mode = 0;\n\tsd_card->sd_data_buf_ready = 0;\n\tsd_card->capacity = 0;\n\tsd_card->sd_switch_fail = 0;\n\n#ifdef SUPPORT_SD_LOCK\n\tsd_card->sd_lock_status = 0;\n\tsd_card->sd_erase_status = 0;\n#endif\n\n\tchip->capacity[chip->card2lun[SD_CARD]] = sd_card->capacity = 0;\n\n\tretval = enable_card_clock(chip, SD_CARD);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = sd_init_power(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = reset_mmc(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = sd_set_clock_divider(chip, SD_CLK_DIVIDE_0);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = rtsx_write_register(chip, REG_SD_BYTE_CNT_L, 0xFF, 0);\n\tif (retval)\n\t\treturn retval;\n\tretval = rtsx_write_register(chip, REG_SD_BYTE_CNT_H, 0xFF, 2);\n\tif (retval)\n\t\treturn retval;\n\n\tchip->capacity[chip->card2lun[SD_CARD]] = sd_card->capacity;\n\n\tretval = sd_set_init_para(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tdev_dbg(rtsx_dev(chip), \"In %s, sd_card->sd_type = 0x%x\\n\",\n\t\t__func__, sd_card->sd_type);\n\n\treturn STATUS_SUCCESS;\n}\n\n#define WAIT_DATA_READY_RTY_CNT\t\t255\n\nstatic int wait_data_buf_ready(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint i, retval;\n\n\tfor (i = 0; i < WAIT_DATA_READY_RTY_CNT; i++) {\n\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\tsd_set_err_code(chip, SD_NO_CARD);\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\n\t\tsd_card->sd_data_buf_ready = 0;\n\n\t\tretval = sd_send_cmd_get_rsp(chip, SEND_STATUS,\n\t\t\t\t\t     sd_card->sd_addr, SD_RSP_TYPE_R1,\n\t\t\t\t\t     NULL, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\n\t\tif (sd_card->sd_data_buf_ready) {\n\t\t\treturn sd_send_cmd_get_rsp(chip, SEND_STATUS,\n\t\t\t\tsd_card->sd_addr, SD_RSP_TYPE_R1, NULL, 0);\n\t\t}\n\t}\n\n\tsd_set_err_code(chip, SD_TO_ERR);\n\n\treturn STATUS_FAIL;\n}\n\nvoid sd_stop_seq_mode(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\n\tif (sd_card->seq_mode) {\n\t\tretval = sd_switch_clock(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn;\n\n\t\tretval = sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\n\t\t\t\t\t     SD_RSP_TYPE_R1b, NULL, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tsd_set_err_code(chip, SD_STS_ERR);\n\n\t\tretval = sd_wait_state_data_ready(chip, 0x08, 1, 1000);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tsd_set_err_code(chip, SD_STS_ERR);\n\n\t\tsd_card->seq_mode = 0;\n\n\t\trtsx_write_register(chip, RBCTL, RB_FLUSH, RB_FLUSH);\n\t}\n}\n\nstatic inline int sd_auto_tune_clock(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\n\tif (chip->asic_code) {\n\t\tif (sd_card->sd_clock > 30)\n\t\t\tsd_card->sd_clock -= 20;\n\t} else {\n\t\tswitch (sd_card->sd_clock) {\n\t\tcase CLK_200:\n\t\t\tsd_card->sd_clock = CLK_150;\n\t\t\tbreak;\n\n\t\tcase CLK_150:\n\t\t\tsd_card->sd_clock = CLK_120;\n\t\t\tbreak;\n\n\t\tcase CLK_120:\n\t\t\tsd_card->sd_clock = CLK_100;\n\t\t\tbreak;\n\n\t\tcase CLK_100:\n\t\t\tsd_card->sd_clock = CLK_80;\n\t\t\tbreak;\n\n\t\tcase CLK_80:\n\t\t\tsd_card->sd_clock = CLK_60;\n\t\t\tbreak;\n\n\t\tcase CLK_60:\n\t\t\tsd_card->sd_clock = CLK_50;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tretval = sd_switch_clock(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n\nint sd_rw(struct scsi_cmnd *srb, struct rtsx_chip *chip, u32 start_sector,\n\t  u16 sector_cnt)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tu32 data_addr;\n\tu8 cfg2;\n\tint retval;\n\n\tif (srb->sc_data_direction == DMA_FROM_DEVICE) {\n\t\tdev_dbg(rtsx_dev(chip), \"%s: Read %d %s from 0x%x\\n\", __func__,\n\t\t\tsector_cnt, (sector_cnt > 1) ? \"sectors\" : \"sector\",\n\t\t\tstart_sector);\n\t} else {\n\t\tdev_dbg(rtsx_dev(chip), \"%s: Write %d %s to 0x%x\\n\", __func__,\n\t\t\tsector_cnt, (sector_cnt > 1) ? \"sectors\" : \"sector\",\n\t\t\tstart_sector);\n\t}\n\n\tsd_card->cleanup_counter = 0;\n\n\tif (!(chip->card_ready & SD_CARD)) {\n\t\tsd_card->seq_mode = 0;\n\n\t\tretval = reset_sd_card(chip);\n\t\tif (retval == STATUS_SUCCESS) {\n\t\t\tchip->card_ready |= SD_CARD;\n\t\t\tchip->card_fail &= ~SD_CARD;\n\t\t} else {\n\t\t\tchip->card_ready &= ~SD_CARD;\n\t\t\tchip->card_fail |= SD_CARD;\n\t\t\tchip->capacity[chip->card2lun[SD_CARD]] = 0;\n\t\t\tchip->rw_need_retry = 1;\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\t}\n\n\tif (!CHK_SD_HCXC(sd_card) && !CHK_MMC_SECTOR_MODE(sd_card))\n\t\tdata_addr = start_sector << 9;\n\telse\n\t\tdata_addr = start_sector;\n\n\tsd_clr_err_code(chip);\n\n\tretval = sd_switch_clock(chip);\n\tif (retval != STATUS_SUCCESS) {\n\t\tsd_set_err_code(chip, SD_IO_ERR);\n\t\tgoto RW_FAIL;\n\t}\n\n\tif (sd_card->seq_mode &&\n\t    (sd_card->pre_dir != srb->sc_data_direction ||\n\t    ((sd_card->pre_sec_addr + sd_card->pre_sec_cnt) !=\n\t    start_sector))) {\n\t\tif (sd_card->pre_sec_cnt < 0x80 &&\n\t\t    sd_card->pre_dir == DMA_FROM_DEVICE &&\n\t\t    !CHK_SD30_SPEED(sd_card) &&\n\t\t    !CHK_SD_HS(sd_card) &&\n\t\t    !CHK_MMC_HS(sd_card)) {\n\t\t\tsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t\t    SD_RSP_TYPE_R1, NULL, 0);\n\t\t}\n\n\t\tretval = sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\n\t\t\t\t\t     SD_RSP_TYPE_R1b, NULL, 0);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tchip->rw_need_retry = 1;\n\t\t\tsd_set_err_code(chip, SD_STS_ERR);\n\t\t\tgoto RW_FAIL;\n\t\t}\n\n\t\tsd_card->seq_mode = 0;\n\n\t\tretval = rtsx_write_register(chip, RBCTL, RB_FLUSH, RB_FLUSH);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tsd_set_err_code(chip, SD_IO_ERR);\n\t\t\tgoto RW_FAIL;\n\t\t}\n\n\t\tif (sd_card->pre_sec_cnt < 0x80 &&\n\t\t    !CHK_SD30_SPEED(sd_card) &&\n\t\t    !CHK_SD_HS(sd_card) &&\n\t\t    !CHK_MMC_HS(sd_card)) {\n\t\t\tsd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\n\t\t\t\t\t    SD_RSP_TYPE_R1, NULL, 0);\n\t\t}\n\t}\n\n\trtsx_init_cmd(chip);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF, 0x00);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF, 0x02);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF,\n\t\t     (u8)sector_cnt);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF,\n\t\t     (u8)(sector_cnt >> 8));\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01, RING_BUFFER);\n\n\tif (CHK_MMC_8BIT(sd_card))\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1,\n\t\t\t     0x03, SD_BUS_WIDTH_8);\n\telse if (CHK_MMC_4BIT(sd_card) || CHK_SD(sd_card))\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1,\n\t\t\t     0x03, SD_BUS_WIDTH_4);\n\telse\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1,\n\t\t\t     0x03, SD_BUS_WIDTH_1);\n\n\tif (sd_card->seq_mode) {\n\t\tcfg2 = SD_NO_CALCULATE_CRC7 | SD_CHECK_CRC16 |\n\t\t\tSD_NO_WAIT_BUSY_END | SD_NO_CHECK_CRC7 |\n\t\t\tSD_RSP_LEN_0;\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF, cfg2);\n\n\t\ttrans_dma_enable(srb->sc_data_direction, chip, sector_cnt * 512,\n\t\t\t\t DMA_512);\n\n\t\tif (srb->sc_data_direction == DMA_FROM_DEVICE) {\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t\t\t     SD_TM_AUTO_READ_3 | SD_TRANSFER_START);\n\t\t} else {\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t\t\t     SD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\n\t\t}\n\n\t\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\n\t\t\t     SD_TRANSFER_END, SD_TRANSFER_END);\n\n\t\trtsx_send_cmd_no_wait(chip);\n\t} else {\n\t\tif (srb->sc_data_direction == DMA_FROM_DEVICE) {\n\t\t\tdev_dbg(rtsx_dev(chip), \"SD/MMC CMD %d\\n\",\n\t\t\t\tREAD_MULTIPLE_BLOCK);\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF,\n\t\t\t\t     0x40 | READ_MULTIPLE_BLOCK);\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD1, 0xFF,\n\t\t\t\t     (u8)(data_addr >> 24));\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD2, 0xFF,\n\t\t\t\t     (u8)(data_addr >> 16));\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD3, 0xFF,\n\t\t\t\t     (u8)(data_addr >> 8));\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD4, 0xFF,\n\t\t\t\t     (u8)data_addr);\n\n\t\t\tcfg2 = SD_CALCULATE_CRC7 | SD_CHECK_CRC16 |\n\t\t\t\tSD_NO_WAIT_BUSY_END | SD_CHECK_CRC7 |\n\t\t\t\tSD_RSP_LEN_6;\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\n\t\t\t\t     cfg2);\n\n\t\t\ttrans_dma_enable(srb->sc_data_direction, chip,\n\t\t\t\t\t sector_cnt * 512, DMA_512);\n\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t\t\t     SD_TM_AUTO_READ_2 | SD_TRANSFER_START);\n\t\t\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\n\t\t\t\t     SD_TRANSFER_END, SD_TRANSFER_END);\n\n\t\t\trtsx_send_cmd_no_wait(chip);\n\t\t} else {\n\t\t\tretval = rtsx_send_cmd(chip, SD_CARD, 50);\n\t\t\tif (retval < 0) {\n\t\t\t\trtsx_clear_sd_error(chip);\n\n\t\t\t\tchip->rw_need_retry = 1;\n\t\t\t\tsd_set_err_code(chip, SD_TO_ERR);\n\t\t\t\tgoto RW_FAIL;\n\t\t\t}\n\n\t\t\tretval = wait_data_buf_ready(chip);\n\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\tchip->rw_need_retry = 1;\n\t\t\t\tsd_set_err_code(chip, SD_TO_ERR);\n\t\t\t\tgoto RW_FAIL;\n\t\t\t}\n\n\t\t\tretval = sd_send_cmd_get_rsp(chip, WRITE_MULTIPLE_BLOCK,\n\t\t\t\t\t\t     data_addr, SD_RSP_TYPE_R1,\n\t\t\t\t\t\t     NULL, 0);\n\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\tchip->rw_need_retry = 1;\n\t\t\t\tgoto RW_FAIL;\n\t\t\t}\n\n\t\t\trtsx_init_cmd(chip);\n\n\t\t\tcfg2 = SD_NO_CALCULATE_CRC7 | SD_CHECK_CRC16 |\n\t\t\t\tSD_NO_WAIT_BUSY_END |\n\t\t\t\tSD_NO_CHECK_CRC7 | SD_RSP_LEN_0;\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF,\n\t\t\t\t     cfg2);\n\n\t\t\ttrans_dma_enable(srb->sc_data_direction, chip,\n\t\t\t\t\t sector_cnt * 512, DMA_512);\n\n\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t\t\t     SD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\n\t\t\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\n\t\t\t\t     SD_TRANSFER_END, SD_TRANSFER_END);\n\n\t\t\trtsx_send_cmd_no_wait(chip);\n\t\t}\n\n\t\tsd_card->seq_mode = 1;\n\t}\n\n\tretval = rtsx_transfer_data(chip, SD_CARD, scsi_sglist(srb),\n\t\t\t\t    scsi_bufflen(srb), scsi_sg_count(srb),\n\t\t\t\tsrb->sc_data_direction, chip->sd_timeout);\n\tif (retval < 0) {\n\t\tu8 stat = 0;\n\t\tint err;\n\n\t\tsd_card->seq_mode = 0;\n\n\t\tif (retval == -ETIMEDOUT)\n\t\t\terr = STATUS_TIMEDOUT;\n\t\telse\n\t\t\terr = STATUS_FAIL;\n\n\t\trtsx_read_register(chip, REG_SD_STAT1, &stat);\n\t\trtsx_clear_sd_error(chip);\n\t\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\t\tchip->rw_need_retry = 0;\n\t\t\tdev_dbg(rtsx_dev(chip), \"No card exist, exit %s\\n\",\n\t\t\t\t__func__);\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\n\t\tchip->rw_need_retry = 1;\n\n\t\tretval = sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\n\t\t\t\t\t     SD_RSP_TYPE_R1b, NULL, 0);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tsd_set_err_code(chip, SD_STS_ERR);\n\t\t\tgoto RW_FAIL;\n\t\t}\n\n\t\tif (stat & (SD_CRC7_ERR | SD_CRC16_ERR | SD_CRC_WRITE_ERR)) {\n\t\t\tdev_dbg(rtsx_dev(chip), \"SD CRC error, tune clock!\\n\");\n\t\t\tsd_set_err_code(chip, SD_CRC_ERR);\n\t\t\tgoto RW_FAIL;\n\t\t}\n\n\t\tif (err == STATUS_TIMEDOUT) {\n\t\t\tsd_set_err_code(chip, SD_TO_ERR);\n\t\t\tgoto RW_FAIL;\n\t\t}\n\n\t\treturn err;\n\t}\n\n\tsd_card->pre_sec_addr = start_sector;\n\tsd_card->pre_sec_cnt = sector_cnt;\n\tsd_card->pre_dir = srb->sc_data_direction;\n\n\treturn STATUS_SUCCESS;\n\nRW_FAIL:\n\tsd_card->seq_mode = 0;\n\n\tif (detect_card_cd(chip, SD_CARD) != STATUS_SUCCESS) {\n\t\tchip->rw_need_retry = 0;\n\t\tdev_dbg(rtsx_dev(chip), \"No card exist, exit %s\\n\", __func__);\n\t\treturn STATUS_FAIL;\n\t}\n\n\tif (sd_check_err_code(chip, SD_CRC_ERR)) {\n\t\tif (CHK_MMC_4BIT(sd_card) || CHK_MMC_8BIT(sd_card)) {\n\t\t\tsd_card->mmc_dont_switch_bus = 1;\n\t\t\treset_mmc_only(chip);\n\t\t\tsd_card->mmc_dont_switch_bus = 0;\n\t\t} else {\n\t\t\tsd_card->need_retune = 1;\n\t\t\tsd_auto_tune_clock(chip);\n\t\t}\n\t} else if (sd_check_err_code(chip, SD_TO_ERR | SD_STS_ERR)) {\n\t\tretval = reset_sd_card(chip);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tchip->card_ready &= ~SD_CARD;\n\t\t\tchip->card_fail |= SD_CARD;\n\t\t\tchip->capacity[chip->card2lun[SD_CARD]] = 0;\n\t\t}\n\t}\n\n\treturn STATUS_FAIL;\n}\n\n#ifdef SUPPORT_CPRM\nint ext_sd_send_cmd_get_rsp(struct rtsx_chip *chip, u8 cmd_idx, u32 arg,\n\t\t\t    u8 rsp_type, u8 *rsp, int rsp_len,\n\t\t\t    bool special_check)\n{\n\tint retval;\n\tint timeout = 100;\n\tu16 reg_addr;\n\tu8 *ptr;\n\tint stat_idx = 0;\n\tint rty_cnt = 0;\n\n\tdev_dbg(rtsx_dev(chip), \"EXT SD/MMC CMD %d\\n\", cmd_idx);\n\n\tif (rsp_type == SD_RSP_TYPE_R1b)\n\t\ttimeout = 3000;\n\nRTY_SEND_CMD:\n\n\trtsx_init_cmd(chip);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF, 0x40 | cmd_idx);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD1, 0xFF, (u8)(arg >> 24));\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD2, 0xFF, (u8)(arg >> 16));\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD3, 0xFF, (u8)(arg >> 8));\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD4, 0xFF, (u8)arg);\n\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF, rsp_type);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE,\n\t\t     0x01, PINGPONG_BUFFER);\n\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER,\n\t\t     0xFF, SD_TM_CMD_RSP | SD_TRANSFER_START);\n\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER, SD_TRANSFER_END,\n\t\t     SD_TRANSFER_END);\n\n\tif (rsp_type == SD_RSP_TYPE_R2) {\n\t\tfor (reg_addr = PPBUF_BASE2; reg_addr < PPBUF_BASE2 + 16;\n\t\t     reg_addr++)\n\t\t\trtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0, 0);\n\n\t\tstat_idx = 17;\n\t} else if (rsp_type != SD_RSP_TYPE_R0) {\n\t\tfor (reg_addr = REG_SD_CMD0; reg_addr <= REG_SD_CMD4;\n\t\t     reg_addr++)\n\t\t\trtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0, 0);\n\n\t\tstat_idx = 6;\n\t}\n\trtsx_add_cmd(chip, READ_REG_CMD, REG_SD_CMD5, 0, 0);\n\n\trtsx_add_cmd(chip, READ_REG_CMD, REG_SD_STAT1, 0, 0);\n\n\tretval = rtsx_send_cmd(chip, SD_CARD, timeout);\n\tif (retval < 0) {\n\t\tif (retval == -ETIMEDOUT) {\n\t\t\trtsx_clear_sd_error(chip);\n\n\t\t\tif (rsp_type & SD_WAIT_BUSY_END) {\n\t\t\t\tretval = sd_check_data0_status(chip);\n\t\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\t\treturn retval;\n\t\t\t} else {\n\t\t\t\tsd_set_err_code(chip, SD_TO_ERR);\n\t\t\t}\n\t\t}\n\t\treturn STATUS_FAIL;\n\t}\n\n\tif (rsp_type == SD_RSP_TYPE_R0)\n\t\treturn STATUS_SUCCESS;\n\n\tptr = rtsx_get_cmd_data(chip) + 1;\n\n\tif ((ptr[0] & 0xC0) != 0) {\n\t\tsd_set_err_code(chip, SD_STS_ERR);\n\t\treturn STATUS_FAIL;\n\t}\n\n\tif (!(rsp_type & SD_NO_CHECK_CRC7)) {\n\t\tif (ptr[stat_idx] & SD_CRC7_ERR) {\n\t\t\tif (cmd_idx == WRITE_MULTIPLE_BLOCK) {\n\t\t\t\tsd_set_err_code(chip, SD_CRC_ERR);\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\t\t\tif (rty_cnt < SD_MAX_RETRY_COUNT) {\n\t\t\t\twait_timeout(20);\n\t\t\t\trty_cnt++;\n\t\t\t\tgoto RTY_SEND_CMD;\n\t\t\t} else {\n\t\t\t\tsd_set_err_code(chip, SD_CRC_ERR);\n\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (cmd_idx == SELECT_CARD || cmd_idx == APP_CMD ||\n\t    cmd_idx == SEND_STATUS || cmd_idx == STOP_TRANSMISSION) {\n\t\tif (cmd_idx != STOP_TRANSMISSION && !special_check) {\n\t\t\tif (ptr[1] & 0x80)\n\t\t\t\treturn STATUS_FAIL;\n\t\t}\n#ifdef SUPPORT_SD_LOCK\n\t\tif (ptr[1] & 0x7D) {\n#else\n\t\tif (ptr[1] & 0x7F) {\n#endif\n\t\t\treturn STATUS_FAIL;\n\t\t}\n\t\tif (ptr[2] & 0xF8)\n\t\t\treturn STATUS_FAIL;\n\n\t\tif (cmd_idx == SELECT_CARD) {\n\t\t\tif (rsp_type == SD_RSP_TYPE_R2) {\n\t\t\t\tif ((ptr[3] & 0x1E) != 0x04)\n\t\t\t\t\treturn STATUS_FAIL;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (rsp && rsp_len)\n\t\tmemcpy(rsp, ptr, rsp_len);\n\n\treturn STATUS_SUCCESS;\n}\n\nint ext_sd_get_rsp(struct rtsx_chip *chip, int len, u8 *rsp, u8 rsp_type)\n{\n\tint retval, rsp_len;\n\tu16 reg_addr;\n\n\tif (rsp_type == SD_RSP_TYPE_R0)\n\t\treturn STATUS_SUCCESS;\n\n\trtsx_init_cmd(chip);\n\n\tif (rsp_type == SD_RSP_TYPE_R2) {\n\t\tfor (reg_addr = PPBUF_BASE2; reg_addr < PPBUF_BASE2 + 16;\n\t\t     reg_addr++)\n\t\t\trtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0xFF, 0);\n\n\t\trsp_len = 17;\n\t} else if (rsp_type != SD_RSP_TYPE_R0) {\n\t\tfor (reg_addr = REG_SD_CMD0; reg_addr <= REG_SD_CMD4;\n\t\t     reg_addr++)\n\t\t\trtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0xFF, 0);\n\n\t\trsp_len = 6;\n\t}\n\trtsx_add_cmd(chip, READ_REG_CMD, REG_SD_CMD5, 0xFF, 0);\n\n\tretval = rtsx_send_cmd(chip, SD_CARD, 100);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tif (rsp) {\n\t\tint min_len = (rsp_len < len) ? rsp_len : len;\n\n\t\tmemcpy(rsp, rtsx_get_cmd_data(chip), min_len);\n\n\t\tdev_dbg(rtsx_dev(chip), \"min_len = %d\\n\", min_len);\n\t\tdev_dbg(rtsx_dev(chip), \"Response in cmd buf: 0x%x 0x%x 0x%x 0x%x\\n\",\n\t\t\trsp[0], rsp[1], rsp[2], rsp[3]);\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nint sd_pass_thru_mode(struct scsi_cmnd *srb, struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tunsigned int lun = SCSI_LUN(srb);\n\tint len;\n\tu8 buf[18] = {\n\t\t0x00,\n\t\t0x00,\n\t\t0x00,\n\t\t0x0E,\n\t\t0x00,\n\t\t0x00,\n\t\t0x00,\n\t\t0x00,\n\t\t0x53,\n\t\t0x44,\n\t\t0x20,\n\t\t0x43,\n\t\t0x61,\n\t\t0x72,\n\t\t0x64,\n\t\t0x00,\n\t\t0x00,\n\t\t0x00,\n\t};\n\n\tsd_card->pre_cmd_err = 0;\n\n\tif (!(CHK_BIT(chip->lun_mc, lun))) {\n\t\tSET_BIT(chip->lun_mc, lun);\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tif (srb->cmnd[2] != 0x53 || srb->cmnd[3] != 0x44 ||\n\t    srb->cmnd[4] != 0x20 || srb->cmnd[5] != 0x43 ||\n\t    srb->cmnd[6] != 0x61 || srb->cmnd[7] != 0x72 ||\n\t    srb->cmnd[8] != 0x64) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tswitch (srb->cmnd[1] & 0x0F) {\n\tcase 0:\n\t\tsd_card->sd_pass_thru_en = 0;\n\t\tbreak;\n\n\tcase 1:\n\t\tsd_card->sd_pass_thru_en = 1;\n\t\tbreak;\n\n\tdefault:\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tbuf[5] = (CHK_SD(sd_card) == 1) ? 0x01 : 0x02;\n\tif (chip->card_wp & SD_CARD)\n\t\tbuf[5] |= 0x80;\n\n\tbuf[6] = (u8)(sd_card->sd_addr >> 16);\n\tbuf[7] = (u8)(sd_card->sd_addr >> 24);\n\n\tbuf[15] = chip->max_lun;\n\n\tlen = min_t(int, 18, scsi_bufflen(srb));\n\trtsx_stor_set_xfer_buf(buf, len, srb);\n\n\treturn TRANSPORT_GOOD;\n}\n\nstatic inline int get_rsp_type(struct scsi_cmnd *srb, u8 *rsp_type,\n\t\t\t       int *rsp_len)\n{\n\tif (!rsp_type || !rsp_len)\n\t\treturn STATUS_FAIL;\n\n\tswitch (srb->cmnd[10]) {\n\tcase 0x03:\n\t\t*rsp_type = SD_RSP_TYPE_R0;\n\t\t*rsp_len = 0;\n\t\tbreak;\n\n\tcase 0x04:\n\t\t*rsp_type = SD_RSP_TYPE_R1;\n\t\t*rsp_len = 6;\n\t\tbreak;\n\n\tcase 0x05:\n\t\t*rsp_type = SD_RSP_TYPE_R1b;\n\t\t*rsp_len = 6;\n\t\tbreak;\n\n\tcase 0x06:\n\t\t*rsp_type = SD_RSP_TYPE_R2;\n\t\t*rsp_len = 17;\n\t\tbreak;\n\n\tcase 0x07:\n\t\t*rsp_type = SD_RSP_TYPE_R3;\n\t\t*rsp_len = 6;\n\t\tbreak;\n\n\tdefault:\n\t\treturn STATUS_FAIL;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nint sd_execute_no_data(struct scsi_cmnd *srb, struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tunsigned int lun = SCSI_LUN(srb);\n\tint retval, rsp_len;\n\tu8 cmd_idx, rsp_type;\n\tbool standby = false, acmd = false;\n\tu32 arg;\n\n\tif (!sd_card->sd_pass_thru_en) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tretval = sd_switch_clock(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn TRANSPORT_FAILED;\n\n\tif (sd_card->pre_cmd_err) {\n\t\tsd_card->pre_cmd_err = 0;\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tcmd_idx = srb->cmnd[2] & 0x3F;\n\tif (srb->cmnd[1] & 0x02)\n\t\tstandby = true;\n\n\tif (srb->cmnd[1] & 0x01)\n\t\tacmd = true;\n\n\targ = ((u32)srb->cmnd[3] << 24) | ((u32)srb->cmnd[4] << 16) |\n\t\t((u32)srb->cmnd[5] << 8) | srb->cmnd[6];\n\n\tretval = get_rsp_type(srb, &rsp_type, &rsp_len);\n\tif (retval != STATUS_SUCCESS) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\tsd_card->last_rsp_type = rsp_type;\n\n\tretval = sd_switch_clock(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn TRANSPORT_FAILED;\n\n#ifdef SUPPORT_SD_LOCK\n\tif ((sd_card->sd_lock_status & SD_LOCK_1BIT_MODE) == 0) {\n\t\tif (CHK_MMC_8BIT(sd_card)) {\n\t\t\tretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03,\n\t\t\t\t\t\t     SD_BUS_WIDTH_8);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn TRANSPORT_FAILED;\n\n\t\t} else if (CHK_SD(sd_card) || CHK_MMC_4BIT(sd_card)) {\n\t\t\tretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03,\n\t\t\t\t\t\t     SD_BUS_WIDTH_4);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn TRANSPORT_FAILED;\n\t\t}\n\t}\n#else\n\tretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03, SD_BUS_WIDTH_4);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn TRANSPORT_FAILED;\n#endif\n\n\tif (standby) {\n\t\tretval = sd_select_card(chip, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_cmd_failed;\n\t}\n\n\tif (acmd) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, APP_CMD,\n\t\t\t\t\t\t sd_card->sd_addr,\n\t\t\t\t\t\t SD_RSP_TYPE_R1, NULL, 0,\n\t\t\t\t\t\t false);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_cmd_failed;\n\t}\n\n\tretval = ext_sd_send_cmd_get_rsp(chip, cmd_idx, arg, rsp_type,\n\t\t\t\t\t sd_card->rsp, rsp_len, false);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto sd_execute_cmd_failed;\n\n\tif (standby) {\n\t\tretval = sd_select_card(chip, 1);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_cmd_failed;\n\t}\n\n#ifdef SUPPORT_SD_LOCK\n\tretval = sd_update_lock_status(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto sd_execute_cmd_failed;\n#endif\n\n\tscsi_set_resid(srb, 0);\n\treturn TRANSPORT_GOOD;\n\nsd_execute_cmd_failed:\n\tsd_card->pre_cmd_err = 1;\n\tset_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\n\trelease_sd_card(chip);\n\tdo_reset_sd_card(chip);\n\tif (!(chip->card_ready & SD_CARD))\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\n\n\treturn TRANSPORT_FAILED;\n}\n\nint sd_execute_read_data(struct scsi_cmnd *srb, struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tunsigned int lun = SCSI_LUN(srb);\n\tint retval, rsp_len, i;\n\tbool read_err = false, cmd13_checkbit = false;\n\tu8 cmd_idx, rsp_type, bus_width;\n\tbool standby = false, send_cmd12 = false, acmd = false;\n\tu32 data_len;\n\n\tif (!sd_card->sd_pass_thru_en) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tif (sd_card->pre_cmd_err) {\n\t\tsd_card->pre_cmd_err = 0;\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tretval = sd_switch_clock(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn TRANSPORT_FAILED;\n\n\tcmd_idx = srb->cmnd[2] & 0x3F;\n\tif (srb->cmnd[1] & 0x04)\n\t\tsend_cmd12 = true;\n\n\tif (srb->cmnd[1] & 0x02)\n\t\tstandby = true;\n\n\tif (srb->cmnd[1] & 0x01)\n\t\tacmd = true;\n\n\tdata_len = ((u32)srb->cmnd[7] << 16) | ((u32)srb->cmnd[8]\n\t\t\t\t\t\t<< 8) | srb->cmnd[9];\n\n\tretval = get_rsp_type(srb, &rsp_type, &rsp_len);\n\tif (retval != STATUS_SUCCESS) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\tsd_card->last_rsp_type = rsp_type;\n\n\tretval = sd_switch_clock(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn TRANSPORT_FAILED;\n\n#ifdef SUPPORT_SD_LOCK\n\tif ((sd_card->sd_lock_status & SD_LOCK_1BIT_MODE) == 0) {\n\t\tif (CHK_MMC_8BIT(sd_card))\n\t\t\tbus_width = SD_BUS_WIDTH_8;\n\t\telse if (CHK_SD(sd_card) || CHK_MMC_4BIT(sd_card))\n\t\t\tbus_width = SD_BUS_WIDTH_4;\n\t\telse\n\t\t\tbus_width = SD_BUS_WIDTH_1;\n\t} else {\n\t\tbus_width = SD_BUS_WIDTH_4;\n\t}\n\tdev_dbg(rtsx_dev(chip), \"bus_width = %d\\n\", bus_width);\n#else\n\tbus_width = SD_BUS_WIDTH_4;\n#endif\n\n\tif (data_len < 512) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, data_len,\n\t\t\t\t\t\t SD_RSP_TYPE_R1, NULL, 0,\n\t\t\t\t\t\t false);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_read_cmd_failed;\n\t}\n\n\tif (standby) {\n\t\tretval = sd_select_card(chip, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_read_cmd_failed;\n\t}\n\n\tif (acmd) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, APP_CMD,\n\t\t\t\t\t\t sd_card->sd_addr,\n\t\t\t\t\t\t SD_RSP_TYPE_R1, NULL, 0,\n\t\t\t\t\t\t false);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_read_cmd_failed;\n\t}\n\n\tif (data_len <= 512) {\n\t\tint min_len;\n\t\tu8 *buf;\n\t\tu16 byte_cnt, blk_cnt;\n\t\tu8 cmd[5];\n\n\t\tbyte_cnt = ((u16)(srb->cmnd[8] & 0x03) << 8) | srb->cmnd[9];\n\t\tblk_cnt = 1;\n\n\t\tcmd[0] = 0x40 | cmd_idx;\n\t\tcmd[1] = srb->cmnd[3];\n\t\tcmd[2] = srb->cmnd[4];\n\t\tcmd[3] = srb->cmnd[5];\n\t\tcmd[4] = srb->cmnd[6];\n\n\t\tbuf = kmalloc(data_len, GFP_KERNEL);\n\t\tif (!buf)\n\t\t\treturn TRANSPORT_ERROR;\n\n\t\tretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, byte_cnt,\n\t\t\t\t      blk_cnt, bus_width, buf, data_len, 2000);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tread_err = true;\n\t\t\tkfree(buf);\n\t\t\trtsx_clear_sd_error(chip);\n\t\t\tgoto sd_execute_read_cmd_failed;\n\t\t}\n\n\t\tmin_len = min(data_len, scsi_bufflen(srb));\n\t\trtsx_stor_set_xfer_buf(buf, min_len, srb);\n\n\t\tkfree(buf);\n\t} else if (!(data_len & 0x1FF)) {\n\t\trtsx_init_cmd(chip);\n\n\t\ttrans_dma_enable(DMA_FROM_DEVICE, chip, data_len, DMA_512);\n\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\n\t\t\t     0x02);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\n\t\t\t     0x00);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H,\n\t\t\t     0xFF, (srb->cmnd[7] & 0xFE) >> 1);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L,\n\t\t\t     0xFF, (u8)((data_len & 0x0001FE00) >> 9));\n\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD0, 0xFF,\n\t\t\t     0x40 | cmd_idx);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD1, 0xFF,\n\t\t\t     srb->cmnd[3]);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD2, 0xFF,\n\t\t\t     srb->cmnd[4]);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD3, 0xFF,\n\t\t\t     srb->cmnd[5]);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CMD4, 0xFF,\n\t\t\t     srb->cmnd[6]);\n\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG1, 0x03, bus_width);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_CFG2, 0xFF, rsp_type);\n\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER,\n\t\t\t     0xFF, SD_TM_AUTO_READ_2 | SD_TRANSFER_START);\n\t\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\n\t\t\t     SD_TRANSFER_END, SD_TRANSFER_END);\n\n\t\trtsx_send_cmd_no_wait(chip);\n\n\t\tretval = rtsx_transfer_data(chip, SD_CARD, scsi_sglist(srb),\n\t\t\t\t\t    scsi_bufflen(srb),\n\t\t\t\t\t    scsi_sg_count(srb),\n\t\t\t\t\t    DMA_FROM_DEVICE, 10000);\n\t\tif (retval < 0) {\n\t\t\tread_err = true;\n\t\t\trtsx_clear_sd_error(chip);\n\t\t\tgoto sd_execute_read_cmd_failed;\n\t\t}\n\n\t} else {\n\t\tgoto sd_execute_read_cmd_failed;\n\t}\n\n\tretval = ext_sd_get_rsp(chip, rsp_len, sd_card->rsp, rsp_type);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto sd_execute_read_cmd_failed;\n\n\tif (standby) {\n\t\tretval = sd_select_card(chip, 1);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_read_cmd_failed;\n\t}\n\n\tif (send_cmd12) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\n\t\t\t\t\t\t SD_RSP_TYPE_R1b, NULL, 0,\n\t\t\t\t\t\t false);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_read_cmd_failed;\n\t}\n\n\tif (data_len < 512) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200,\n\t\t\t\t\t\t SD_RSP_TYPE_R1, NULL, 0,\n\t\t\t\t\t\t false);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_read_cmd_failed;\n\n\t\tretval = rtsx_write_register(chip, SD_BYTE_CNT_H, 0xFF, 0x02);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_read_cmd_failed;\n\n\t\tretval = rtsx_write_register(chip, SD_BYTE_CNT_L, 0xFF, 0x00);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_read_cmd_failed;\n\t}\n\n\tif ((srb->cmnd[1] & 0x02) || (srb->cmnd[1] & 0x04))\n\t\tcmd13_checkbit = true;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, SEND_STATUS,\n\t\t\t\t\t\t sd_card->sd_addr,\n\t\t\t\t\t\tSD_RSP_TYPE_R1, NULL, 0,\n\t\t\t\t\t\tcmd13_checkbit);\n\t\tif (retval == STATUS_SUCCESS)\n\t\t\tbreak;\n\t}\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto sd_execute_read_cmd_failed;\n\n\tscsi_set_resid(srb, 0);\n\treturn TRANSPORT_GOOD;\n\nsd_execute_read_cmd_failed:\n\tsd_card->pre_cmd_err = 1;\n\tset_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\n\tif (read_err)\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\n\n\trelease_sd_card(chip);\n\tdo_reset_sd_card(chip);\n\tif (!(chip->card_ready & SD_CARD))\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\n\n\treturn TRANSPORT_FAILED;\n}\n\nint sd_execute_write_data(struct scsi_cmnd *srb, struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tunsigned int lun = SCSI_LUN(srb);\n\tint retval, rsp_len, i;\n\tbool write_err = false, cmd13_checkbit = false;\n\tu8 cmd_idx, rsp_type;\n\tbool standby = false, send_cmd12 = false, acmd = false;\n\tu32 data_len, arg;\n#ifdef SUPPORT_SD_LOCK\n\tint lock_cmd_fail = 0;\n\tu8 sd_lock_state = 0;\n\tu8 lock_cmd_type = 0;\n#endif\n\n\tif (!sd_card->sd_pass_thru_en) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tif (sd_card->pre_cmd_err) {\n\t\tsd_card->pre_cmd_err = 0;\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tretval = sd_switch_clock(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn TRANSPORT_FAILED;\n\n\tcmd_idx = srb->cmnd[2] & 0x3F;\n\tif (srb->cmnd[1] & 0x04)\n\t\tsend_cmd12 = true;\n\n\tif (srb->cmnd[1] & 0x02)\n\t\tstandby = true;\n\n\tif (srb->cmnd[1] & 0x01)\n\t\tacmd = true;\n\n\tdata_len = ((u32)srb->cmnd[7] << 16) | ((u32)srb->cmnd[8]\n\t\t\t\t\t\t<< 8) | srb->cmnd[9];\n\targ = ((u32)srb->cmnd[3] << 24) | ((u32)srb->cmnd[4] << 16) |\n\t\t((u32)srb->cmnd[5] << 8) | srb->cmnd[6];\n\n#ifdef SUPPORT_SD_LOCK\n\tif (cmd_idx == LOCK_UNLOCK) {\n\t\tsd_lock_state = sd_card->sd_lock_status;\n\t\tsd_lock_state &= SD_LOCKED;\n\t}\n#endif\n\n\tretval = get_rsp_type(srb, &rsp_type, &rsp_len);\n\tif (retval != STATUS_SUCCESS) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\tsd_card->last_rsp_type = rsp_type;\n\n\tretval = sd_switch_clock(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn TRANSPORT_FAILED;\n\n#ifdef SUPPORT_SD_LOCK\n\tif ((sd_card->sd_lock_status & SD_LOCK_1BIT_MODE) == 0) {\n\t\tif (CHK_MMC_8BIT(sd_card)) {\n\t\t\tretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03,\n\t\t\t\t\t\t     SD_BUS_WIDTH_8);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn TRANSPORT_FAILED;\n\n\t\t} else if (CHK_SD(sd_card) || CHK_MMC_4BIT(sd_card)) {\n\t\t\tretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03,\n\t\t\t\t\t\t     SD_BUS_WIDTH_4);\n\t\t\tif (retval != STATUS_SUCCESS)\n\t\t\t\treturn TRANSPORT_FAILED;\n\t\t}\n\t}\n#else\n\tretval = rtsx_write_register(chip, REG_SD_CFG1, 0x03, SD_BUS_WIDTH_4);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn TRANSPORT_FAILED;\n#endif\n\n\tif (data_len < 512) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, data_len,\n\t\t\t\t\t\t SD_RSP_TYPE_R1, NULL, 0,\n\t\t\t\t\t\t false);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_write_cmd_failed;\n\t}\n\n\tif (standby) {\n\t\tretval = sd_select_card(chip, 0);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_write_cmd_failed;\n\t}\n\n\tif (acmd) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, APP_CMD,\n\t\t\t\t\t\t sd_card->sd_addr,\n\t\t\t\t\t\t SD_RSP_TYPE_R1, NULL, 0,\n\t\t\t\t\t\t false);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_write_cmd_failed;\n\t}\n\n\tretval = ext_sd_send_cmd_get_rsp(chip, cmd_idx, arg, rsp_type,\n\t\t\t\t\t sd_card->rsp, rsp_len, false);\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto sd_execute_write_cmd_failed;\n\n\tif (data_len <= 512) {\n\t\tu16 i;\n\t\tu8 *buf;\n\n\t\tbuf = kmalloc(data_len, GFP_KERNEL);\n\t\tif (!buf)\n\t\t\treturn TRANSPORT_ERROR;\n\n\t\trtsx_stor_get_xfer_buf(buf, data_len, srb);\n\n#ifdef SUPPORT_SD_LOCK\n\t\tif (cmd_idx == LOCK_UNLOCK)\n\t\t\tlock_cmd_type = buf[0] & 0x0F;\n#endif\n\n\t\tif (data_len > 256) {\n\t\t\trtsx_init_cmd(chip);\n\t\t\tfor (i = 0; i < 256; i++) {\n\t\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD,\n\t\t\t\t\t     PPBUF_BASE2 + i, 0xFF, buf[i]);\n\t\t\t}\n\t\t\tretval = rtsx_send_cmd(chip, 0, 250);\n\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\tkfree(buf);\n\t\t\t\tgoto sd_execute_write_cmd_failed;\n\t\t\t}\n\n\t\t\trtsx_init_cmd(chip);\n\t\t\tfor (i = 256; i < data_len; i++) {\n\t\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD,\n\t\t\t\t\t     PPBUF_BASE2 + i, 0xFF, buf[i]);\n\t\t\t}\n\t\t\tretval = rtsx_send_cmd(chip, 0, 250);\n\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\tkfree(buf);\n\t\t\t\tgoto sd_execute_write_cmd_failed;\n\t\t\t}\n\t\t} else {\n\t\t\trtsx_init_cmd(chip);\n\t\t\tfor (i = 0; i < data_len; i++) {\n\t\t\t\trtsx_add_cmd(chip, WRITE_REG_CMD,\n\t\t\t\t\t     PPBUF_BASE2 + i, 0xFF, buf[i]);\n\t\t\t}\n\t\t\tretval = rtsx_send_cmd(chip, 0, 250);\n\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\tkfree(buf);\n\t\t\t\tgoto sd_execute_write_cmd_failed;\n\t\t\t}\n\t\t}\n\n\t\tkfree(buf);\n\n\t\trtsx_init_cmd(chip);\n\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\n\t\t\t     srb->cmnd[8] & 0x03);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\n\t\t\t     srb->cmnd[9]);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H, 0xFF,\n\t\t\t     0x00);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L, 0xFF,\n\t\t\t     0x01);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01,\n\t\t\t     PINGPONG_BUFFER);\n\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t\t     SD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\n\t\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\n\t\t\t     SD_TRANSFER_END, SD_TRANSFER_END);\n\n\t\tretval = rtsx_send_cmd(chip, SD_CARD, 250);\n\t} else if (!(data_len & 0x1FF)) {\n\t\trtsx_init_cmd(chip);\n\n\t\ttrans_dma_enable(DMA_TO_DEVICE, chip, data_len, DMA_512);\n\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_H, 0xFF,\n\t\t\t     0x02);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BYTE_CNT_L, 0xFF,\n\t\t\t     0x00);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_H,\n\t\t\t     0xFF, (srb->cmnd[7] & 0xFE) >> 1);\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_BLOCK_CNT_L,\n\t\t\t     0xFF, (u8)((data_len & 0x0001FE00) >> 9));\n\n\t\trtsx_add_cmd(chip, WRITE_REG_CMD, REG_SD_TRANSFER, 0xFF,\n\t\t\t     SD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\n\t\trtsx_add_cmd(chip, CHECK_REG_CMD, REG_SD_TRANSFER,\n\t\t\t     SD_TRANSFER_END, SD_TRANSFER_END);\n\n\t\trtsx_send_cmd_no_wait(chip);\n\n\t\tretval = rtsx_transfer_data(chip, SD_CARD, scsi_sglist(srb),\n\t\t\t\t\t    scsi_bufflen(srb),\n\t\t\t\t\t    scsi_sg_count(srb),\n\t\t\t\t\t    DMA_TO_DEVICE, 10000);\n\n\t} else {\n\t\tgoto sd_execute_write_cmd_failed;\n\t}\n\n\tif (retval < 0) {\n\t\twrite_err = true;\n\t\trtsx_clear_sd_error(chip);\n\t\tgoto sd_execute_write_cmd_failed;\n\t}\n\n#ifdef SUPPORT_SD_LOCK\n\tif (cmd_idx == LOCK_UNLOCK) {\n\t\tif (lock_cmd_type == SD_ERASE) {\n\t\t\tsd_card->sd_erase_status = SD_UNDER_ERASING;\n\t\t\tscsi_set_resid(srb, 0);\n\t\t\treturn TRANSPORT_GOOD;\n\t\t}\n\n\t\trtsx_init_cmd(chip);\n\t\trtsx_add_cmd(chip, CHECK_REG_CMD, 0xFD30, 0x02, 0x02);\n\n\t\tretval = rtsx_send_cmd(chip, SD_CARD, 250);\n\t\tif (retval < 0) {\n\t\t\twrite_err = true;\n\t\t\trtsx_clear_sd_error(chip);\n\t\t\tgoto sd_execute_write_cmd_failed;\n\t\t}\n\n\t\tretval = sd_update_lock_status(chip);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tdev_dbg(rtsx_dev(chip), \"Lock command fail!\\n\");\n\t\t\tlock_cmd_fail = 1;\n\t\t}\n\t}\n#endif  \n\n\tif (standby) {\n\t\tretval = sd_select_card(chip, 1);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_write_cmd_failed;\n\t}\n\n\tif (send_cmd12) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION, 0,\n\t\t\t\t\t\t SD_RSP_TYPE_R1b, NULL, 0,\n\t\t\t\t\t\t false);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_write_cmd_failed;\n\t}\n\n\tif (data_len < 512) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200,\n\t\t\t\t\t\t SD_RSP_TYPE_R1, NULL, 0,\n\t\t\t\t\t\t false);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_write_cmd_failed;\n\n\t\tretval = rtsx_write_register(chip, SD_BYTE_CNT_H, 0xFF, 0x02);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_write_cmd_failed;\n\n\t\tretval = rtsx_write_register(chip, SD_BYTE_CNT_L, 0xFF, 0x00);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\tgoto sd_execute_write_cmd_failed;\n\t}\n\n\tif ((srb->cmnd[1] & 0x02) || (srb->cmnd[1] & 0x04))\n\t\tcmd13_checkbit = true;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tretval = ext_sd_send_cmd_get_rsp(chip, SEND_STATUS,\n\t\t\t\t\t\t sd_card->sd_addr,\n\t\t\t\t\t\t SD_RSP_TYPE_R1, NULL, 0,\n\t\t\t\t\t\t cmd13_checkbit);\n\t\tif (retval == STATUS_SUCCESS)\n\t\t\tbreak;\n\t}\n\tif (retval != STATUS_SUCCESS)\n\t\tgoto sd_execute_write_cmd_failed;\n\n#ifdef SUPPORT_SD_LOCK\n\tif (cmd_idx == LOCK_UNLOCK) {\n\t\tif (!lock_cmd_fail) {\n\t\t\tdev_dbg(rtsx_dev(chip), \"lock_cmd_type = 0x%x\\n\",\n\t\t\t\tlock_cmd_type);\n\t\t\tif (lock_cmd_type & SD_CLR_PWD)\n\t\t\t\tsd_card->sd_lock_status &= ~SD_PWD_EXIST;\n\n\t\t\tif (lock_cmd_type & SD_SET_PWD)\n\t\t\t\tsd_card->sd_lock_status |= SD_PWD_EXIST;\n\t\t}\n\n\t\tdev_dbg(rtsx_dev(chip), \"sd_lock_state = 0x%x, sd_card->sd_lock_status = 0x%x\\n\",\n\t\t\tsd_lock_state, sd_card->sd_lock_status);\n\t\tif (sd_lock_state ^ (sd_card->sd_lock_status & SD_LOCKED)) {\n\t\t\tsd_card->sd_lock_notify = 1;\n\t\t\tif (sd_lock_state &&\n\t\t\t    (sd_card->sd_lock_status & SD_LOCK_1BIT_MODE)) {\n\t\t\t\tsd_card->sd_lock_status |= (SD_UNLOCK_POW_ON | SD_SDR_RST);\n\t\t\t\tif (CHK_SD(sd_card)) {\n\t\t\t\t\tretval = reset_sd(chip);\n\t\t\t\t\tif (retval != STATUS_SUCCESS) {\n\t\t\t\t\t\tsd_card->sd_lock_status &=\n\t\t\t\t\t\t\t~(SD_UNLOCK_POW_ON | SD_SDR_RST);\n\t\t\t\t\t\tgoto sd_execute_write_cmd_failed;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tsd_card->sd_lock_status &= ~(SD_UNLOCK_POW_ON | SD_SDR_RST);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (lock_cmd_fail) {\n\t\tscsi_set_resid(srb, 0);\n\t\tset_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\n\t\treturn TRANSPORT_FAILED;\n\t}\n#endif   \n\n\tscsi_set_resid(srb, 0);\n\treturn TRANSPORT_GOOD;\n\nsd_execute_write_cmd_failed:\n\tsd_card->pre_cmd_err = 1;\n\tset_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\n\tif (write_err)\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_ERR);\n\n\trelease_sd_card(chip);\n\tdo_reset_sd_card(chip);\n\tif (!(chip->card_ready & SD_CARD))\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\n\n\treturn TRANSPORT_FAILED;\n}\n\nint sd_get_cmd_rsp(struct scsi_cmnd *srb, struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tunsigned int lun = SCSI_LUN(srb);\n\tint count;\n\tu16 data_len;\n\n\tif (!sd_card->sd_pass_thru_en) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tif (sd_card->pre_cmd_err) {\n\t\tsd_card->pre_cmd_err = 0;\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tdata_len = ((u16)srb->cmnd[7] << 8) | srb->cmnd[8];\n\n\tif (sd_card->last_rsp_type == SD_RSP_TYPE_R0) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t} else if (sd_card->last_rsp_type == SD_RSP_TYPE_R2) {\n\t\tcount = (data_len < 17) ? data_len : 17;\n\t} else {\n\t\tcount = (data_len < 6) ? data_len : 6;\n\t}\n\trtsx_stor_set_xfer_buf(sd_card->rsp, count, srb);\n\n\tdev_dbg(rtsx_dev(chip), \"Response length: %d\\n\", data_len);\n\tdev_dbg(rtsx_dev(chip), \"Response: 0x%x 0x%x 0x%x 0x%x\\n\",\n\t\tsd_card->rsp[0], sd_card->rsp[1],\n\t\tsd_card->rsp[2], sd_card->rsp[3]);\n\n\tscsi_set_resid(srb, 0);\n\treturn TRANSPORT_GOOD;\n}\n\nint sd_hw_rst(struct scsi_cmnd *srb, struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tunsigned int lun = SCSI_LUN(srb);\n\tint retval;\n\n\tif (!sd_card->sd_pass_thru_en) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tif (sd_card->pre_cmd_err) {\n\t\tsd_card->pre_cmd_err = 0;\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tif (srb->cmnd[2] != 0x53 || srb->cmnd[3] != 0x44 ||\n\t    srb->cmnd[4] != 0x20 || srb->cmnd[5] != 0x43 ||\n\t    srb->cmnd[6] != 0x61 || srb->cmnd[7] != 0x72 ||\n\t    srb->cmnd[8] != 0x64) {\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tswitch (srb->cmnd[1] & 0x0F) {\n\tcase 0:\n#ifdef SUPPORT_SD_LOCK\n\t\tif (srb->cmnd[9] == 0x64)\n\t\t\tsd_card->sd_lock_status |= SD_SDR_RST;\n#endif\n\t\tretval = reset_sd_card(chip);\n\t\tif (retval != STATUS_SUCCESS) {\n#ifdef SUPPORT_SD_LOCK\n\t\t\tsd_card->sd_lock_status &= ~SD_SDR_RST;\n#endif\n\t\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\n\t\t\tsd_card->pre_cmd_err = 1;\n\t\t\treturn TRANSPORT_FAILED;\n\t\t}\n#ifdef SUPPORT_SD_LOCK\n\t\tsd_card->sd_lock_status &= ~SD_SDR_RST;\n#endif\n\t\tbreak;\n\n\tcase 1:\n\t\tretval = reset_sd(chip);\n\t\tif (retval != STATUS_SUCCESS) {\n\t\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\n\t\t\tsd_card->pre_cmd_err = 1;\n\t\t\treturn TRANSPORT_FAILED;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\n\t\treturn TRANSPORT_FAILED;\n\t}\n\n\tscsi_set_resid(srb, 0);\n\treturn TRANSPORT_GOOD;\n}\n#endif\n\nvoid sd_cleanup_work(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\n\tif (sd_card->seq_mode) {\n\t\tdev_dbg(rtsx_dev(chip), \"SD: stop transmission\\n\");\n\t\tsd_stop_seq_mode(chip);\n\t\tsd_card->cleanup_counter = 0;\n\t}\n}\n\nint sd_power_off_card3v3(struct rtsx_chip *chip)\n{\n\tint retval;\n\n\tretval = disable_card_clock(chip, SD_CARD);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\tretval = rtsx_write_register(chip, CARD_OE, SD_OUTPUT_EN, 0);\n\tif (retval)\n\t\treturn retval;\n\n\tif (!chip->ft2_fast_mode) {\n\t\tretval = card_power_off(chip, SD_CARD);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\n\t\tmdelay(50);\n\t}\n\n\tif (chip->asic_code) {\n\t\tretval = sd_pull_ctl_disable(chip);\n\t\tif (retval != STATUS_SUCCESS)\n\t\t\treturn STATUS_FAIL;\n\t} else {\n\t\tretval = rtsx_write_register(chip, FPGA_PULL_CTL,\n\t\t\t\t\t     FPGA_SD_PULL_CTL_BIT | 0x20,\n\t\t\t\t\t     FPGA_SD_PULL_CTL_BIT);\n\t\tif (retval)\n\t\t\treturn retval;\n\t}\n\n\treturn STATUS_SUCCESS;\n}\n\nint release_sd_card(struct rtsx_chip *chip)\n{\n\tstruct sd_info *sd_card = &chip->sd_card;\n\tint retval;\n\n\tchip->card_ready &= ~SD_CARD;\n\tchip->card_fail &= ~SD_CARD;\n\tchip->card_wp &= ~SD_CARD;\n\n\tchip->sd_io = 0;\n\tchip->sd_int = 0;\n\n#ifdef SUPPORT_SD_LOCK\n\tsd_card->sd_lock_status = 0;\n\tsd_card->sd_erase_status = 0;\n#endif\n\n\tmemset(sd_card->raw_csd, 0, 16);\n\tmemset(sd_card->raw_scr, 0, 8);\n\n\tretval = sd_power_off_card3v3(chip);\n\tif (retval != STATUS_SUCCESS)\n\t\treturn STATUS_FAIL;\n\n\treturn STATUS_SUCCESS;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}