{
  "module_name": "nvec_ps2.c",
  "hash_id": "374a8c1b9fd266bb7eb6cc3da0b42127a765f9571bc5214ee6ecce62b9938f11",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/nvec/nvec_ps2.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/serio.h>\n#include <linux/delay.h>\n#include <linux/platform_device.h>\n\n#include \"nvec.h\"\n\n#define PACKET_SIZE\t6\n\n#define ENABLE_MOUSE\t0xf4\n#define DISABLE_MOUSE\t0xf5\n#define PSMOUSE_RST\t0xff\n\n#ifdef NVEC_PS2_DEBUG\n#define NVEC_PHD(str, buf, len) \\\n\tprint_hex_dump(KERN_DEBUG, str, DUMP_PREFIX_NONE, \\\n\t\t\t16, 1, buf, len, false)\n#else\n#define NVEC_PHD(str, buf, len) do { } while (0)\n#endif\n\nenum ps2_subcmds {\n\tSEND_COMMAND = 1,\n\tRECEIVE_N,\n\tAUTO_RECEIVE_N,\n\tCANCEL_AUTO_RECEIVE,\n};\n\nstruct nvec_ps2 {\n\tstruct serio *ser_dev;\n\tstruct notifier_block notifier;\n\tstruct nvec_chip *nvec;\n};\n\nstatic struct nvec_ps2 ps2_dev;\n\nstatic int ps2_startstreaming(struct serio *ser_dev)\n{\n\tunsigned char buf[] = { NVEC_PS2, AUTO_RECEIVE_N, PACKET_SIZE };\n\n\treturn nvec_write_async(ps2_dev.nvec, buf, sizeof(buf));\n}\n\nstatic void ps2_stopstreaming(struct serio *ser_dev)\n{\n\tunsigned char buf[] = { NVEC_PS2, CANCEL_AUTO_RECEIVE };\n\n\tnvec_write_async(ps2_dev.nvec, buf, sizeof(buf));\n}\n\nstatic int ps2_sendcommand(struct serio *ser_dev, unsigned char cmd)\n{\n\tunsigned char buf[] = { NVEC_PS2, SEND_COMMAND, ENABLE_MOUSE, 1 };\n\n\tbuf[2] = cmd & 0xff;\n\n\tdev_dbg(&ser_dev->dev, \"Sending ps2 cmd %02x\\n\", cmd);\n\treturn nvec_write_async(ps2_dev.nvec, buf, sizeof(buf));\n}\n\nstatic int nvec_ps2_notifier(struct notifier_block *nb,\n\t\t\t     unsigned long event_type, void *data)\n{\n\tint i;\n\tunsigned char *msg = data;\n\n\tswitch (event_type) {\n\tcase NVEC_PS2_EVT:\n\t\tfor (i = 0; i < msg[1]; i++)\n\t\t\tserio_interrupt(ps2_dev.ser_dev, msg[2 + i], 0);\n\t\tNVEC_PHD(\"ps/2 mouse event: \", &msg[2], msg[1]);\n\t\treturn NOTIFY_STOP;\n\n\tcase NVEC_PS2:\n\t\tif (msg[2] == 1) {\n\t\t\tfor (i = 0; i < (msg[1] - 2); i++)\n\t\t\t\tserio_interrupt(ps2_dev.ser_dev, msg[i + 4], 0);\n\t\t\tNVEC_PHD(\"ps/2 mouse reply: \", &msg[4], msg[1] - 2);\n\t\t}\n\n\t\telse if (msg[1] != 2)  \n\t\t\tNVEC_PHD(\"unhandled mouse event: \", msg, msg[1] + 2);\n\t\treturn NOTIFY_STOP;\n\t}\n\n\treturn NOTIFY_DONE;\n}\n\nstatic int nvec_mouse_probe(struct platform_device *pdev)\n{\n\tstruct nvec_chip *nvec = dev_get_drvdata(pdev->dev.parent);\n\tstruct serio *ser_dev;\n\n\tser_dev = kzalloc(sizeof(*ser_dev), GFP_KERNEL);\n\tif (!ser_dev)\n\t\treturn -ENOMEM;\n\n\tser_dev->id.type = SERIO_8042;\n\tser_dev->write = ps2_sendcommand;\n\tser_dev->start = ps2_startstreaming;\n\tser_dev->stop = ps2_stopstreaming;\n\n\tstrscpy(ser_dev->name, \"nvec mouse\", sizeof(ser_dev->name));\n\tstrscpy(ser_dev->phys, \"nvec\", sizeof(ser_dev->phys));\n\n\tps2_dev.ser_dev = ser_dev;\n\tps2_dev.notifier.notifier_call = nvec_ps2_notifier;\n\tps2_dev.nvec = nvec;\n\tnvec_register_notifier(nvec, &ps2_dev.notifier, 0);\n\n\tserio_register_port(ser_dev);\n\n\treturn 0;\n}\n\nstatic void nvec_mouse_remove(struct platform_device *pdev)\n{\n\tstruct nvec_chip *nvec = dev_get_drvdata(pdev->dev.parent);\n\n\tps2_sendcommand(ps2_dev.ser_dev, DISABLE_MOUSE);\n\tps2_stopstreaming(ps2_dev.ser_dev);\n\tnvec_unregister_notifier(nvec, &ps2_dev.notifier);\n\tserio_unregister_port(ps2_dev.ser_dev);\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int nvec_mouse_suspend(struct device *dev)\n{\n\t \n\tps2_sendcommand(ps2_dev.ser_dev, DISABLE_MOUSE);\n\n\t \n\tps2_stopstreaming(ps2_dev.ser_dev);\n\n\treturn 0;\n}\n\nstatic int nvec_mouse_resume(struct device *dev)\n{\n\t \n\tps2_startstreaming(ps2_dev.ser_dev);\n\n\t \n\tps2_sendcommand(ps2_dev.ser_dev, ENABLE_MOUSE);\n\n\treturn 0;\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(nvec_mouse_pm_ops, nvec_mouse_suspend,\n\t\t\t nvec_mouse_resume);\n\nstatic struct platform_driver nvec_mouse_driver = {\n\t.probe  = nvec_mouse_probe,\n\t.remove_new = nvec_mouse_remove,\n\t.driver = {\n\t\t.name = \"nvec-mouse\",\n\t\t.pm = &nvec_mouse_pm_ops,\n\t},\n};\n\nmodule_platform_driver(nvec_mouse_driver);\n\nMODULE_DESCRIPTION(\"NVEC mouse driver\");\nMODULE_AUTHOR(\"Marc Dietrich <marvin24@gmx.de>\");\nMODULE_ALIAS(\"platform:nvec-mouse\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}