{
  "module_name": "rtw_ieee80211.c",
  "hash_id": "c1df915ae930db725fea6593e85d1601049923c83c8a35f1a69752ef42b1fdb0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8723bs/core/rtw_ieee80211.c",
  "human_readable_source": "\n \n\n#include <drv_types.h>\n#include <rtw_debug.h>\n#include <linux/of.h>\n#include <asm/unaligned.h>\n\nu8 RTW_WPA_OUI_TYPE[] = { 0x00, 0x50, 0xf2, 1 };\nu16 RTW_WPA_VERSION = 1;\nu8 WPA_AUTH_KEY_MGMT_NONE[] = { 0x00, 0x50, 0xf2, 0 };\nu8 WPA_AUTH_KEY_MGMT_UNSPEC_802_1X[] = { 0x00, 0x50, 0xf2, 1 };\nu8 WPA_AUTH_KEY_MGMT_PSK_OVER_802_1X[] = { 0x00, 0x50, 0xf2, 2 };\nu8 WPA_CIPHER_SUITE_NONE[] = { 0x00, 0x50, 0xf2, 0 };\nu8 WPA_CIPHER_SUITE_WEP40[] = { 0x00, 0x50, 0xf2, 1 };\nu8 WPA_CIPHER_SUITE_TKIP[] = { 0x00, 0x50, 0xf2, 2 };\nu8 WPA_CIPHER_SUITE_WRAP[] = { 0x00, 0x50, 0xf2, 3 };\nu8 WPA_CIPHER_SUITE_CCMP[] = { 0x00, 0x50, 0xf2, 4 };\nu8 WPA_CIPHER_SUITE_WEP104[] = { 0x00, 0x50, 0xf2, 5 };\n\nu16 RSN_VERSION_BSD = 1;\nu8 RSN_AUTH_KEY_MGMT_UNSPEC_802_1X[] = { 0x00, 0x0f, 0xac, 1 };\nu8 RSN_AUTH_KEY_MGMT_PSK_OVER_802_1X[] = { 0x00, 0x0f, 0xac, 2 };\nu8 RSN_CIPHER_SUITE_NONE[] = { 0x00, 0x0f, 0xac, 0 };\nu8 RSN_CIPHER_SUITE_WEP40[] = { 0x00, 0x0f, 0xac, 1 };\nu8 RSN_CIPHER_SUITE_TKIP[] = { 0x00, 0x0f, 0xac, 2 };\nu8 RSN_CIPHER_SUITE_WRAP[] = { 0x00, 0x0f, 0xac, 3 };\nu8 RSN_CIPHER_SUITE_CCMP[] = { 0x00, 0x0f, 0xac, 4 };\nu8 RSN_CIPHER_SUITE_WEP104[] = { 0x00, 0x0f, 0xac, 5 };\n \n \n \n\nstatic u8 WIFI_CCKRATES[] = {\n\t\t(IEEE80211_CCK_RATE_1MB | IEEE80211_BASIC_RATE_MASK),\n\t\t(IEEE80211_CCK_RATE_2MB | IEEE80211_BASIC_RATE_MASK),\n\t\t(IEEE80211_CCK_RATE_5MB | IEEE80211_BASIC_RATE_MASK),\n\t\t(IEEE80211_CCK_RATE_11MB | IEEE80211_BASIC_RATE_MASK)\n};\n\nstatic u8 WIFI_OFDMRATES[] = {\n\t\t(IEEE80211_OFDM_RATE_6MB),\n\t\t(IEEE80211_OFDM_RATE_9MB),\n\t\t(IEEE80211_OFDM_RATE_12MB),\n\t\t(IEEE80211_OFDM_RATE_18MB),\n\t\t(IEEE80211_OFDM_RATE_24MB),\n\t\tIEEE80211_OFDM_RATE_36MB,\n\t\tIEEE80211_OFDM_RATE_48MB,\n\t\tIEEE80211_OFDM_RATE_54MB\n};\n\nint rtw_get_bit_value_from_ieee_value(u8 val)\n{\n\tunsigned char dot11_rate_table[] = {2, 4, 11, 22, 12, 18, 24, 36, 48, 72, 96, 108, 0};  \n\tint i = 0;\n\n\twhile (dot11_rate_table[i] != 0) {\n\t\tif (dot11_rate_table[i] == val)\n\t\t\treturn BIT(i);\n\t\ti++;\n\t}\n\treturn 0;\n}\n\nbool rtw_is_cckrates_included(u8 *rate)\n{\n\twhile (*rate) {\n\t\tu8 r = *rate & 0x7f;\n\n\t\tif (r == 2 || r == 4 || r == 11 || r == 22)\n\t\t\treturn true;\n\t\trate++;\n\t}\n\n\treturn false;\n}\n\nbool rtw_is_cckratesonly_included(u8 *rate)\n{\n\twhile (*rate) {\n\t\tu8 r = *rate & 0x7f;\n\n\t\tif (r != 2 && r != 4 && r != 11 && r != 22)\n\t\t\treturn false;\n\t\trate++;\n\t}\n\n\treturn true;\n}\n\nint rtw_check_network_type(unsigned char *rate, int ratelen, int channel)\n{\n\tif (channel > 14)\n\t\treturn WIRELESS_INVALID;\n\t \n\tif (rtw_is_cckratesonly_included(rate))\n\t\treturn WIRELESS_11B;\n\tif (rtw_is_cckrates_included(rate))\n\t\treturn WIRELESS_11BG;\n\treturn WIRELESS_11G;\n}\n\nu8 *rtw_set_fixed_ie(unsigned char *pbuf, unsigned int len, unsigned char *source,\n\t\t\t\tunsigned int *frlen)\n{\n\tmemcpy((void *)pbuf, (void *)source, len);\n\t*frlen = *frlen + len;\n\treturn pbuf + len;\n}\n\n \nu8 *rtw_set_ie(u8 *pbuf,\n\t       signed int index,\n\t       uint len,\n\t       u8 *source,\n\t       uint *frlen)  \n{\n\t*pbuf = (u8)index;\n\n\t*(pbuf + 1) = (u8)len;\n\n\tif (len > 0)\n\t\tmemcpy((void *)(pbuf + 2), (void *)source, len);\n\n\t*frlen = *frlen + (len + 2);\n\n\treturn pbuf + len + 2;\n}\n\n \nu8 *rtw_get_ie(u8 *pbuf, signed int index, signed int *len, signed int limit)\n{\n\tsigned int tmp, i;\n\tu8 *p;\n\n\tif (limit < 1)\n\t\treturn NULL;\n\n\tp = pbuf;\n\ti = 0;\n\t*len = 0;\n\twhile (1) {\n\t\tif (*p == index) {\n\t\t\t*len = *(p + 1);\n\t\t\treturn p;\n\t\t}\n\t\ttmp = *(p + 1);\n\t\tp += (tmp + 2);\n\t\ti += (tmp + 2);\n\t\tif (i >= limit)\n\t\t\tbreak;\n\t}\n\treturn NULL;\n}\n\n \nu8 *rtw_get_ie_ex(u8 *in_ie, uint in_len, u8 eid, u8 *oui, u8 oui_len, u8 *ie, uint *ielen)\n{\n\tuint cnt;\n\tu8 *target_ie = NULL;\n\n\tif (ielen)\n\t\t*ielen = 0;\n\n\tif (!in_ie || in_len <= 0)\n\t\treturn target_ie;\n\n\tcnt = 0;\n\n\twhile (cnt < in_len) {\n\t\tif (eid == in_ie[cnt]\n\t\t\t&& (!oui || !memcmp(&in_ie[cnt+2], oui, oui_len))) {\n\t\t\ttarget_ie = &in_ie[cnt];\n\n\t\t\tif (ie)\n\t\t\t\tmemcpy(ie, &in_ie[cnt], in_ie[cnt+1]+2);\n\n\t\t\tif (ielen)\n\t\t\t\t*ielen = in_ie[cnt+1]+2;\n\n\t\t\tbreak;\n\t\t}\n\t\tcnt += in_ie[cnt+1]+2;  \n\t}\n\n\treturn target_ie;\n}\n\n \nint rtw_ies_remove_ie(u8 *ies, uint *ies_len, uint offset, u8 eid, u8 *oui, u8 oui_len)\n{\n\tint ret = _FAIL;\n\tu8 *target_ie;\n\tu32 target_ielen;\n\tu8 *start;\n\tuint search_len;\n\n\tif (!ies || !ies_len || *ies_len <= offset)\n\t\tgoto exit;\n\n\tstart = ies + offset;\n\tsearch_len = *ies_len - offset;\n\n\twhile (1) {\n\t\ttarget_ie = rtw_get_ie_ex(start, search_len, eid, oui, oui_len, NULL, &target_ielen);\n\t\tif (target_ie && target_ielen) {\n\t\t\tu8 *remain_ies = target_ie + target_ielen;\n\t\t\tuint remain_len = search_len - (remain_ies - start);\n\n\t\t\tmemcpy(target_ie, remain_ies, remain_len);\n\t\t\t*ies_len = *ies_len - target_ielen;\n\t\t\tret = _SUCCESS;\n\n\t\t\tstart = target_ie;\n\t\t\tsearch_len = remain_len;\n\t\t} else {\n\t\t\tbreak;\n\t\t}\n\t}\nexit:\n\treturn ret;\n}\n\nvoid rtw_set_supported_rate(u8 *supported_rates, uint mode)\n{\n\tmemset(supported_rates, 0, NDIS_802_11_LENGTH_RATES_EX);\n\n\tswitch (mode) {\n\tcase WIRELESS_11B:\n\t\tmemcpy(supported_rates, WIFI_CCKRATES, IEEE80211_CCK_RATE_LEN);\n\t\tbreak;\n\n\tcase WIRELESS_11G:\n\t\tmemcpy(supported_rates, WIFI_OFDMRATES, IEEE80211_NUM_OFDM_RATESLEN);\n\t\tbreak;\n\n\tcase WIRELESS_11BG:\n\tcase WIRELESS_11G_24N:\n\tcase WIRELESS_11_24N:\n\tcase WIRELESS_11BG_24N:\n\t\tmemcpy(supported_rates, WIFI_CCKRATES, IEEE80211_CCK_RATE_LEN);\n\t\tmemcpy(supported_rates + IEEE80211_CCK_RATE_LEN, WIFI_OFDMRATES, IEEE80211_NUM_OFDM_RATESLEN);\n\t\tbreak;\n\t}\n}\n\nuint rtw_get_rateset_len(u8 *rateset)\n{\n\tuint i;\n\n\tfor (i = 0; i < 13; i++)\n\t\tif (rateset[i] == 0)\n\t\t\tbreak;\n\treturn i;\n}\n\nint rtw_generate_ie(struct registry_priv *pregistrypriv)\n{\n\tu8 wireless_mode;\n\tint\tsz = 0, rateLen;\n\tstruct wlan_bssid_ex *pdev_network = &pregistrypriv->dev_network;\n\tu8 *ie = pdev_network->ies;\n\n\t \n\tsz += 8;\n\tie += sz;\n\n\t \n\t*(__le16 *)ie = cpu_to_le16((u16)pdev_network->configuration.beacon_period); \n\tsz += 2;\n\tie += 2;\n\n\t \n\t*(u16 *)ie = 0;\n\n\t*(__le16 *)ie |= cpu_to_le16(WLAN_CAPABILITY_IBSS);\n\n\tif (pregistrypriv->preamble == PREAMBLE_SHORT)\n\t\t*(__le16 *)ie |= cpu_to_le16(WLAN_CAPABILITY_SHORT_PREAMBLE);\n\n\tif (pdev_network->privacy)\n\t\t*(__le16 *)ie |= cpu_to_le16(WLAN_CAPABILITY_PRIVACY);\n\n\tsz += 2;\n\tie += 2;\n\n\t \n\tie = rtw_set_ie(ie, WLAN_EID_SSID, pdev_network->ssid.ssid_length, pdev_network->ssid.ssid, &sz);\n\n\t \n\twireless_mode = pregistrypriv->wireless_mode;\n\n\trtw_set_supported_rate(pdev_network->supported_rates, wireless_mode);\n\n\trateLen = rtw_get_rateset_len(pdev_network->supported_rates);\n\n\tif (rateLen > 8) {\n\t\tie = rtw_set_ie(ie, WLAN_EID_SUPP_RATES, 8, pdev_network->supported_rates, &sz);\n\t\t \n\t} else {\n\t\tie = rtw_set_ie(ie, WLAN_EID_SUPP_RATES, rateLen, pdev_network->supported_rates, &sz);\n\t}\n\n\t \n\tie = rtw_set_ie(ie, WLAN_EID_DS_PARAMS, 1, (u8 *)&(pdev_network->configuration.ds_config), &sz);\n\n\t \n\n\tie = rtw_set_ie(ie, WLAN_EID_IBSS_PARAMS, 2, (u8 *)&(pdev_network->configuration.atim_window), &sz);\n\n\tif (rateLen > 8)\n\t\tie = rtw_set_ie(ie, WLAN_EID_EXT_SUPP_RATES, (rateLen - 8), (pdev_network->supported_rates + 8), &sz);\n\n\t \n\tif ((pregistrypriv->wireless_mode & WIRELESS_11_24N) &&\n\t    (pregistrypriv->ht_enable == true)) {\n\t\t \n\t}\n\n\t \n\n\t \n\n\treturn sz;\n}\n\nunsigned char *rtw_get_wpa_ie(unsigned char *pie, int *wpa_ie_len, int limit)\n{\n\tint len;\n\tu16 val16;\n\tunsigned char wpa_oui_type[] = {0x00, 0x50, 0xf2, 0x01};\n\tu8 *pbuf = pie;\n\tint limit_new = limit;\n\t__le16 le_tmp;\n\n\twhile (1) {\n\t\tpbuf = rtw_get_ie(pbuf, WLAN_EID_VENDOR_SPECIFIC, &len, limit_new);\n\n\t\tif (pbuf) {\n\t\t\t \n\t\t\tif (memcmp((pbuf + 2), wpa_oui_type, sizeof(wpa_oui_type)))\n\t\t\t\tgoto check_next_ie;\n\n\t\t\t \n\t\t\tmemcpy((u8 *)&le_tmp, (pbuf + 6), sizeof(val16));\n\n\t\t\tval16 = le16_to_cpu(le_tmp);\n\t\t\tif (val16 != 0x0001)\n\t\t\t\tgoto check_next_ie;\n\n\t\t\t*wpa_ie_len = *(pbuf + 1);\n\n\t\t\treturn pbuf;\n\n\t\t} else {\n\t\t\t*wpa_ie_len = 0;\n\t\t\treturn NULL;\n\t\t}\n\ncheck_next_ie:\n\n\t\tlimit_new = limit - (pbuf - pie) - 2 - len;\n\n\t\tif (limit_new <= 0)\n\t\t\tbreak;\n\n\t\tpbuf += (2 + len);\n\t}\n\n\t*wpa_ie_len = 0;\n\n\treturn NULL;\n}\n\nunsigned char *rtw_get_wpa2_ie(unsigned char *pie, int *rsn_ie_len, int limit)\n{\n\treturn rtw_get_ie(pie, WLAN_EID_RSN, rsn_ie_len, limit);\n}\n\nint rtw_get_wpa_cipher_suite(u8 *s)\n{\n\tif (!memcmp(s, WPA_CIPHER_SUITE_NONE, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_NONE;\n\tif (!memcmp(s, WPA_CIPHER_SUITE_WEP40, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_WEP40;\n\tif (!memcmp(s, WPA_CIPHER_SUITE_TKIP, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_TKIP;\n\tif (!memcmp(s, WPA_CIPHER_SUITE_CCMP, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_CCMP;\n\tif (!memcmp(s, WPA_CIPHER_SUITE_WEP104, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_WEP104;\n\n\treturn 0;\n}\n\nint rtw_get_wpa2_cipher_suite(u8 *s)\n{\n\tif (!memcmp(s, RSN_CIPHER_SUITE_NONE, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_NONE;\n\tif (!memcmp(s, RSN_CIPHER_SUITE_WEP40, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_WEP40;\n\tif (!memcmp(s, RSN_CIPHER_SUITE_TKIP, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_TKIP;\n\tif (!memcmp(s, RSN_CIPHER_SUITE_CCMP, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_CCMP;\n\tif (!memcmp(s, RSN_CIPHER_SUITE_WEP104, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_WEP104;\n\n\treturn 0;\n}\n\nint rtw_parse_wpa_ie(u8 *wpa_ie, int wpa_ie_len, int *group_cipher, int *pairwise_cipher, int *is_8021x)\n{\n\tint i, ret = _SUCCESS;\n\tint left, count;\n\tu8 *pos;\n\tu8 SUITE_1X[4] = {0x00, 0x50, 0xf2, 1};\n\n\tif (wpa_ie_len <= 0) {\n\t\t \n\t\treturn _FAIL;\n\t}\n\n\tif ((*wpa_ie != WLAN_EID_VENDOR_SPECIFIC) || (*(wpa_ie+1) != (u8)(wpa_ie_len - 2)) ||\n\t   (memcmp(wpa_ie+2, RTW_WPA_OUI_TYPE, WPA_SELECTOR_LEN))) {\n\t\treturn _FAIL;\n\t}\n\n\tpos = wpa_ie;\n\n\tpos += 8;\n\tleft = wpa_ie_len - 8;\n\n\t \n\tif (left >= WPA_SELECTOR_LEN) {\n\t\t*group_cipher = rtw_get_wpa_cipher_suite(pos);\n\n\t\tpos += WPA_SELECTOR_LEN;\n\t\tleft -= WPA_SELECTOR_LEN;\n\n\t} else if (left > 0)\n\t\treturn _FAIL;\n\n\t \n\tif (left >= 2) {\n\t\t \n\t\tcount = get_unaligned_le16(pos);\n\t\tpos += 2;\n\t\tleft -= 2;\n\n\t\tif (count == 0 || left < count * WPA_SELECTOR_LEN)\n\t\t\treturn _FAIL;\n\n\t\tfor (i = 0; i < count; i++) {\n\t\t\t*pairwise_cipher |= rtw_get_wpa_cipher_suite(pos);\n\n\t\t\tpos += WPA_SELECTOR_LEN;\n\t\t\tleft -= WPA_SELECTOR_LEN;\n\t\t}\n\n\t} else if (left == 1)\n\t\treturn _FAIL;\n\n\tif (is_8021x) {\n\t\tif (left >= 6) {\n\t\t\tpos += 2;\n\t\t\tif (!memcmp(pos, SUITE_1X, 4))\n\t\t\t\t*is_8021x = 1;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nint rtw_parse_wpa2_ie(u8 *rsn_ie, int rsn_ie_len, int *group_cipher, int *pairwise_cipher, int *is_8021x)\n{\n\tint i, ret = _SUCCESS;\n\tint left, count;\n\tu8 *pos;\n\tu8 SUITE_1X[4] = {0x00, 0x0f, 0xac, 0x01};\n\n\tif (rsn_ie_len <= 0) {\n\t\t \n\t\treturn _FAIL;\n\t}\n\n\tif ((*rsn_ie != WLAN_EID_RSN) || (*(rsn_ie+1) != (u8)(rsn_ie_len - 2)))\n\t\treturn _FAIL;\n\n\tpos = rsn_ie;\n\tpos += 4;\n\tleft = rsn_ie_len - 4;\n\n\t \n\tif (left >= RSN_SELECTOR_LEN) {\n\t\t*group_cipher = rtw_get_wpa2_cipher_suite(pos);\n\n\t\tpos += RSN_SELECTOR_LEN;\n\t\tleft -= RSN_SELECTOR_LEN;\n\n\t} else if (left > 0)\n\t\treturn _FAIL;\n\n\t \n\tif (left >= 2) {\n\t   \n\t\tcount = get_unaligned_le16(pos);\n\t\tpos += 2;\n\t\tleft -= 2;\n\n\t\tif (count == 0 || left < count * RSN_SELECTOR_LEN)\n\t\t\treturn _FAIL;\n\n\t\tfor (i = 0; i < count; i++) {\n\t\t\t*pairwise_cipher |= rtw_get_wpa2_cipher_suite(pos);\n\n\t\t\tpos += RSN_SELECTOR_LEN;\n\t\t\tleft -= RSN_SELECTOR_LEN;\n\t\t}\n\n\t} else if (left == 1)\n\t\treturn _FAIL;\n\n\tif (is_8021x) {\n\t\tif (left >= 6) {\n\t\t\tpos += 2;\n\t\t\tif (!memcmp(pos, SUITE_1X, 4))\n\t\t\t\t*is_8021x = 1;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\n \nint rtw_get_wapi_ie(u8 *in_ie, uint in_len, u8 *wapi_ie, u16 *wapi_len)\n{\n\tint len = 0;\n\tu8 authmode;\n\tuint\tcnt;\n\tu8 wapi_oui1[4] = {0x0, 0x14, 0x72, 0x01};\n\tu8 wapi_oui2[4] = {0x0, 0x14, 0x72, 0x02};\n\n\tif (wapi_len)\n\t\t*wapi_len = 0;\n\n\tif (!in_ie || in_len <= 0)\n\t\treturn len;\n\n\tcnt = (_TIMESTAMP_ + _BEACON_ITERVAL_ + _CAPABILITY_);\n\n\twhile (cnt < in_len) {\n\t\tauthmode = in_ie[cnt];\n\n\t\t \n\t\tif (authmode == WLAN_EID_BSS_AC_ACCESS_DELAY && (!memcmp(&in_ie[cnt+6], wapi_oui1, 4) ||\n\t\t\t\t\t!memcmp(&in_ie[cnt+6], wapi_oui2, 4))) {\n\t\t\tif (wapi_ie)\n\t\t\t\tmemcpy(wapi_ie, &in_ie[cnt], in_ie[cnt+1]+2);\n\n\t\t\tif (wapi_len)\n\t\t\t\t*wapi_len = in_ie[cnt+1]+2;\n\n\t\t\tcnt += in_ie[cnt+1]+2;   \n\t\t} else {\n\t\t\tcnt += in_ie[cnt+1]+2;    \n\t\t}\n\t}\n\n\tif (wapi_len)\n\t\tlen = *wapi_len;\n\n\treturn len;\n}\n \n\nvoid rtw_get_sec_ie(u8 *in_ie, uint in_len, u8 *rsn_ie, u16 *rsn_len, u8 *wpa_ie, u16 *wpa_len)\n{\n\tu8 authmode;\n\tu8 wpa_oui[4] = {0x0, 0x50, 0xf2, 0x01};\n\tuint\tcnt;\n\n\t \n\n\tcnt = (_TIMESTAMP_ + _BEACON_ITERVAL_ + _CAPABILITY_);\n\n\twhile (cnt < in_len) {\n\t\tauthmode = in_ie[cnt];\n\n\t\tif ((authmode == WLAN_EID_VENDOR_SPECIFIC) && (!memcmp(&in_ie[cnt+2], &wpa_oui[0], 4))) {\n\t\t\tif (wpa_ie)\n\t\t\t\tmemcpy(wpa_ie, &in_ie[cnt], in_ie[cnt+1]+2);\n\n\t\t\t*wpa_len = in_ie[cnt + 1] + 2;\n\t\t\tcnt += in_ie[cnt + 1] + 2;   \n\t\t} else {\n\t\t\tif (authmode == WLAN_EID_RSN) {\n\t\t\t\tif (rsn_ie)\n\t\t\t\t\tmemcpy(rsn_ie, &in_ie[cnt], in_ie[cnt + 1] + 2);\n\n\t\t\t\t*rsn_len = in_ie[cnt+1]+2;\n\t\t\t\tcnt += in_ie[cnt+1]+2;   \n\t\t\t} else {\n\t\t\t\tcnt += in_ie[cnt+1]+2;    \n\t\t\t}\n\t\t}\n\t}\n}\n\n \nu8 *rtw_get_wps_ie(u8 *in_ie, uint in_len, u8 *wps_ie, uint *wps_ielen)\n{\n\tuint cnt;\n\tu8 *wpsie_ptr = NULL;\n\tu8 eid, wps_oui[4] = {0x0, 0x50, 0xf2, 0x04};\n\n\tif (wps_ielen)\n\t\t*wps_ielen = 0;\n\n\tif (!in_ie || in_len <= 0)\n\t\treturn wpsie_ptr;\n\n\tcnt = 0;\n\n\twhile (cnt < in_len) {\n\t\teid = in_ie[cnt];\n\n\t\tif ((eid == WLAN_EID_VENDOR_SPECIFIC) && (!memcmp(&in_ie[cnt+2], wps_oui, 4))) {\n\t\t\twpsie_ptr = &in_ie[cnt];\n\n\t\t\tif (wps_ie)\n\t\t\t\tmemcpy(wps_ie, &in_ie[cnt], in_ie[cnt+1]+2);\n\n\t\t\tif (wps_ielen)\n\t\t\t\t*wps_ielen = in_ie[cnt+1]+2;\n\n\t\t\tcnt += in_ie[cnt+1]+2;\n\n\t\t\tbreak;\n\t\t}\n\t\tcnt += in_ie[cnt+1]+2;  \n\t}\n\n\treturn wpsie_ptr;\n}\n\n \nu8 *rtw_get_wps_attr(u8 *wps_ie, uint wps_ielen, u16 target_attr_id, u8 *buf_attr, u32 *len_attr)\n{\n\tu8 *attr_ptr = NULL;\n\tu8 *target_attr_ptr = NULL;\n\tu8 wps_oui[4] = {0x00, 0x50, 0xF2, 0x04};\n\n\tif (len_attr)\n\t\t*len_attr = 0;\n\n\tif ((wps_ie[0] != WLAN_EID_VENDOR_SPECIFIC) ||\n\t\t(memcmp(wps_ie + 2, wps_oui, 4))) {\n\t\treturn attr_ptr;\n\t}\n\n\t \n\tattr_ptr = wps_ie + 6;  \n\n\twhile (attr_ptr - wps_ie < wps_ielen) {\n\t\t \n\t\tu16 attr_id = get_unaligned_be16(attr_ptr);\n\t\tu16 attr_data_len = get_unaligned_be16(attr_ptr + 2);\n\t\tu16 attr_len = attr_data_len + 4;\n\n\t\tif (attr_id == target_attr_id) {\n\t\t\ttarget_attr_ptr = attr_ptr;\n\n\t\t\tif (buf_attr)\n\t\t\t\tmemcpy(buf_attr, attr_ptr, attr_len);\n\n\t\t\tif (len_attr)\n\t\t\t\t*len_attr = attr_len;\n\n\t\t\tbreak;\n\t\t}\n\t\tattr_ptr += attr_len;  \n\t}\n\n\treturn target_attr_ptr;\n}\n\n \nu8 *rtw_get_wps_attr_content(u8 *wps_ie, uint wps_ielen, u16 target_attr_id, u8 *buf_content, uint *len_content)\n{\n\tu8 *attr_ptr;\n\tu32 attr_len;\n\n\tif (len_content)\n\t\t*len_content = 0;\n\n\tattr_ptr = rtw_get_wps_attr(wps_ie, wps_ielen, target_attr_id, NULL, &attr_len);\n\n\tif (attr_ptr && attr_len) {\n\t\tif (buf_content)\n\t\t\tmemcpy(buf_content, attr_ptr+4, attr_len-4);\n\n\t\tif (len_content)\n\t\t\t*len_content = attr_len-4;\n\n\t\treturn attr_ptr+4;\n\t}\n\n\treturn NULL;\n}\n\nstatic int rtw_ieee802_11_parse_vendor_specific(u8 *pos, uint elen,\n\t\t\t\t\t    struct rtw_ieee802_11_elems *elems,\n\t\t\t\t\t    int show_errors)\n{\n\tunsigned int oui;\n\n\t \n\tif (elen < 4)\n\t\treturn -1;\n\n\toui = get_unaligned_be24(pos);\n\tswitch (oui) {\n\tcase OUI_MICROSOFT:\n\t\t \n\t\tswitch (pos[3]) {\n\t\tcase 1:\n\t\t\t \n\t\t\telems->wpa_ie = pos;\n\t\t\telems->wpa_ie_len = elen;\n\t\t\tbreak;\n\t\tcase WME_OUI_TYPE:  \n\t\t\tif (elen < 5)\n\t\t\t\treturn -1;\n\n\t\t\tswitch (pos[4]) {\n\t\t\tcase WME_OUI_SUBTYPE_INFORMATION_ELEMENT:\n\t\t\tcase WME_OUI_SUBTYPE_PARAMETER_ELEMENT:\n\t\t\t\telems->wme = pos;\n\t\t\t\telems->wme_len = elen;\n\t\t\t\tbreak;\n\t\t\tcase WME_OUI_SUBTYPE_TSPEC_ELEMENT:\n\t\t\t\telems->wme_tspec = pos;\n\t\t\t\telems->wme_tspec_len = elen;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\t \n\t\t\telems->wps_ie = pos;\n\t\t\telems->wps_ie_len = elen;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -1;\n\t\t}\n\t\tbreak;\n\n\tcase OUI_BROADCOM:\n\t\tswitch (pos[3]) {\n\t\tcase VENDOR_HT_CAPAB_OUI_TYPE:\n\t\t\telems->vendor_ht_cap = pos;\n\t\t\telems->vendor_ht_cap_len = elen;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -1;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\n \nenum ParseRes rtw_ieee802_11_parse_elems(u8 *start, uint len,\n\t\t\t\tstruct rtw_ieee802_11_elems *elems,\n\t\t\t\tint show_errors)\n{\n\tuint left = len;\n\tu8 *pos = start;\n\tint unknown = 0;\n\n\tmemset(elems, 0, sizeof(*elems));\n\n\twhile (left >= 2) {\n\t\tu8 id, elen;\n\n\t\tid = *pos++;\n\t\telen = *pos++;\n\t\tleft -= 2;\n\n\t\tif (elen > left)\n\t\t\treturn ParseFailed;\n\n\t\tswitch (id) {\n\t\tcase WLAN_EID_SSID:\n\t\t\telems->ssid = pos;\n\t\t\telems->ssid_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_SUPP_RATES:\n\t\t\telems->supp_rates = pos;\n\t\t\telems->supp_rates_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_FH_PARAMS:\n\t\t\telems->fh_params = pos;\n\t\t\telems->fh_params_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_DS_PARAMS:\n\t\t\telems->ds_params = pos;\n\t\t\telems->ds_params_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_CF_PARAMS:\n\t\t\telems->cf_params = pos;\n\t\t\telems->cf_params_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_TIM:\n\t\t\telems->tim = pos;\n\t\t\telems->tim_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_IBSS_PARAMS:\n\t\t\telems->ibss_params = pos;\n\t\t\telems->ibss_params_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_CHALLENGE:\n\t\t\telems->challenge = pos;\n\t\t\telems->challenge_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_ERP_INFO:\n\t\t\telems->erp_info = pos;\n\t\t\telems->erp_info_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_EXT_SUPP_RATES:\n\t\t\telems->ext_supp_rates = pos;\n\t\t\telems->ext_supp_rates_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_VENDOR_SPECIFIC:\n\t\t\tif (rtw_ieee802_11_parse_vendor_specific(pos, elen,\n\t\t\t\t\t\t\t     elems,\n\t\t\t\t\t\t\t     show_errors))\n\t\t\t\tunknown++;\n\t\t\tbreak;\n\t\tcase WLAN_EID_RSN:\n\t\t\telems->rsn_ie = pos;\n\t\t\telems->rsn_ie_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_PWR_CAPABILITY:\n\t\t\telems->power_cap = pos;\n\t\t\telems->power_cap_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_SUPPORTED_CHANNELS:\n\t\t\telems->supp_channels = pos;\n\t\t\telems->supp_channels_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_MOBILITY_DOMAIN:\n\t\t\telems->mdie = pos;\n\t\t\telems->mdie_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_FAST_BSS_TRANSITION:\n\t\t\telems->ftie = pos;\n\t\t\telems->ftie_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_TIMEOUT_INTERVAL:\n\t\t\telems->timeout_int = pos;\n\t\t\telems->timeout_int_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_HT_CAPABILITY:\n\t\t\telems->ht_capabilities = pos;\n\t\t\telems->ht_capabilities_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_HT_OPERATION:\n\t\t\telems->ht_operation = pos;\n\t\t\telems->ht_operation_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_VHT_CAPABILITY:\n\t\t\telems->vht_capabilities = pos;\n\t\t\telems->vht_capabilities_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_VHT_OPERATION:\n\t\t\telems->vht_operation = pos;\n\t\t\telems->vht_operation_len = elen;\n\t\t\tbreak;\n\t\tcase WLAN_EID_OPMODE_NOTIF:\n\t\t\telems->vht_op_mode_notify = pos;\n\t\t\telems->vht_op_mode_notify_len = elen;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tunknown++;\n\t\t\tbreak;\n\t\t}\n\n\t\tleft -= elen;\n\t\tpos += elen;\n\t}\n\n\tif (left)\n\t\treturn ParseFailed;\n\n\treturn unknown ? ParseUnknown : ParseOK;\n}\n\nvoid rtw_macaddr_cfg(struct device *dev, u8 *mac_addr)\n{\n\tu8 mac[ETH_ALEN];\n\tstruct device_node *np = dev->of_node;\n\tconst unsigned char *addr;\n\tint len;\n\n\tif (!mac_addr)\n\t\treturn;\n\n\tif (rtw_initmac && mac_pton(rtw_initmac, mac)) {\n\t\t \n\t\tether_addr_copy(mac_addr, mac);\n\t} else {\n\t\t \n\t\tether_addr_copy(mac, mac_addr);\n\t}\n\n\tif (is_broadcast_ether_addr(mac) || is_zero_ether_addr(mac)) {\n\t\taddr = of_get_property(np, \"local-mac-address\", &len);\n\n\t\tif (addr && len == ETH_ALEN) {\n\t\t\tether_addr_copy(mac_addr, addr);\n\t\t} else {\n\t\t\teth_random_addr(mac_addr);\n\t\t}\n\t}\n}\n\nstatic int rtw_get_cipher_info(struct wlan_network *pnetwork)\n{\n\tu32 wpa_ielen;\n\tunsigned char *pbuf;\n\tint group_cipher = 0, pairwise_cipher = 0, is8021x = 0;\n\tint ret = _FAIL;\n\n\tpbuf = rtw_get_wpa_ie(&pnetwork->network.ies[12], &wpa_ielen, pnetwork->network.ie_length-12);\n\n\tif (pbuf && (wpa_ielen > 0)) {\n\t\tif (_SUCCESS == rtw_parse_wpa_ie(pbuf, wpa_ielen+2, &group_cipher, &pairwise_cipher, &is8021x)) {\n\t\t\tpnetwork->bcn_info.pairwise_cipher = pairwise_cipher;\n\t\t\tpnetwork->bcn_info.group_cipher = group_cipher;\n\t\t\tpnetwork->bcn_info.is_8021x = is8021x;\n\t\t\tret = _SUCCESS;\n\t\t}\n\t} else {\n\t\tpbuf = rtw_get_wpa2_ie(&pnetwork->network.ies[12], &wpa_ielen, pnetwork->network.ie_length-12);\n\n\t\tif (pbuf && (wpa_ielen > 0)) {\n\t\t\tif (_SUCCESS == rtw_parse_wpa2_ie(pbuf, wpa_ielen+2, &group_cipher, &pairwise_cipher, &is8021x)) {\n\t\t\t\tpnetwork->bcn_info.pairwise_cipher = pairwise_cipher;\n\t\t\t\tpnetwork->bcn_info.group_cipher = group_cipher;\n\t\t\t\tpnetwork->bcn_info.is_8021x = is8021x;\n\t\t\t\tret = _SUCCESS;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nvoid rtw_get_bcn_info(struct wlan_network *pnetwork)\n{\n\tunsigned short cap = 0;\n\tu8 bencrypt = 0;\n\t \n\tu16 wpa_len = 0, rsn_len = 0;\n\tstruct HT_info_element *pht_info = NULL;\n\tstruct ieee80211_ht_cap *pht_cap = NULL;\n\tunsigned int\t\tlen;\n\tunsigned char \t*p;\n\t__le16 le_cap;\n\n\tmemcpy((u8 *)&le_cap, rtw_get_capability_from_ie(pnetwork->network.ies), 2);\n\tcap = le16_to_cpu(le_cap);\n\tif (cap & WLAN_CAPABILITY_PRIVACY) {\n\t\tbencrypt = 1;\n\t\tpnetwork->network.privacy = 1;\n\t} else {\n\t\tpnetwork->bcn_info.encryp_protocol = ENCRYP_PROTOCOL_OPENSYS;\n\t}\n\trtw_get_sec_ie(pnetwork->network.ies, pnetwork->network.ie_length, NULL, &rsn_len, NULL, &wpa_len);\n\n\tif (rsn_len > 0) {\n\t\tpnetwork->bcn_info.encryp_protocol = ENCRYP_PROTOCOL_WPA2;\n\t} else if (wpa_len > 0) {\n\t\tpnetwork->bcn_info.encryp_protocol = ENCRYP_PROTOCOL_WPA;\n\t} else {\n\t\tif (bencrypt)\n\t\t\tpnetwork->bcn_info.encryp_protocol = ENCRYP_PROTOCOL_WEP;\n\t}\n\trtw_get_cipher_info(pnetwork);\n\n\t \n\t \n\tp = rtw_get_ie(pnetwork->network.ies + _FIXED_IE_LENGTH_, WLAN_EID_HT_CAPABILITY, &len, pnetwork->network.ie_length - _FIXED_IE_LENGTH_);\n\tif (p && len > 0) {\n\t\tpht_cap = (struct ieee80211_ht_cap *)(p + 2);\n\t\tpnetwork->bcn_info.ht_cap_info = le16_to_cpu(pht_cap->cap_info);\n\t} else {\n\t\tpnetwork->bcn_info.ht_cap_info = 0;\n\t}\n\t \n\tp = rtw_get_ie(pnetwork->network.ies + _FIXED_IE_LENGTH_, WLAN_EID_HT_OPERATION, &len, pnetwork->network.ie_length - _FIXED_IE_LENGTH_);\n\tif (p && len > 0) {\n\t\tpht_info = (struct HT_info_element *)(p + 2);\n\t\tpnetwork->bcn_info.ht_info_infos_0 = pht_info->infos[0];\n\t} else {\n\t\tpnetwork->bcn_info.ht_info_infos_0 = 0;\n\t}\n}\n\n \nu16 rtw_mcs_rate(u8 bw_40MHz, u8 short_GI, unsigned char *MCS_rate)\n{\n\tu16 max_rate = 0;\n\n\tif (MCS_rate[0] & BIT(7))\n\t\tmax_rate = (bw_40MHz) ? ((short_GI)?1500:1350):((short_GI)?722:650);\n\telse if (MCS_rate[0] & BIT(6))\n\t\tmax_rate = (bw_40MHz) ? ((short_GI)?1350:1215):((short_GI)?650:585);\n\telse if (MCS_rate[0] & BIT(5))\n\t\tmax_rate = (bw_40MHz) ? ((short_GI)?1200:1080):((short_GI)?578:520);\n\telse if (MCS_rate[0] & BIT(4))\n\t\tmax_rate = (bw_40MHz) ? ((short_GI)?900:810):((short_GI)?433:390);\n\telse if (MCS_rate[0] & BIT(3))\n\t\tmax_rate = (bw_40MHz) ? ((short_GI)?600:540):((short_GI)?289:260);\n\telse if (MCS_rate[0] & BIT(2))\n\t\tmax_rate = (bw_40MHz) ? ((short_GI)?450:405):((short_GI)?217:195);\n\telse if (MCS_rate[0] & BIT(1))\n\t\tmax_rate = (bw_40MHz) ? ((short_GI)?300:270):((short_GI)?144:130);\n\telse if (MCS_rate[0] & BIT(0))\n\t\tmax_rate = (bw_40MHz) ? ((short_GI)?150:135):((short_GI)?72:65);\n\n\treturn max_rate;\n}\n\nint rtw_action_frame_parse(const u8 *frame, u32 frame_len, u8 *category, u8 *action)\n{\n\tconst u8 *frame_body = frame + sizeof(struct ieee80211_hdr_3addr);\n\tu16 fc;\n\tu8 c;\n\tu8 a = ACT_PUBLIC_MAX;\n\n\tfc = le16_to_cpu(((struct ieee80211_hdr_3addr *)frame)->frame_control);\n\n\tif ((fc & (IEEE80211_FCTL_FTYPE|IEEE80211_FCTL_STYPE))\n\t\t!= (IEEE80211_FTYPE_MGMT|IEEE80211_STYPE_ACTION)\n\t) {\n\t\treturn false;\n\t}\n\n\tc = frame_body[0];\n\n\tswitch (c) {\n\tcase RTW_WLAN_CATEGORY_P2P:  \n\t\tbreak;\n\tdefault:\n\t\ta = frame_body[1];\n\t}\n\n\tif (category)\n\t\t*category = c;\n\tif (action)\n\t\t*action = a;\n\n\treturn true;\n}\n\nstatic const char *_action_public_str[] = {\n\t\"ACT_PUB_BSSCOEXIST\",\n\t\"ACT_PUB_DSE_ENABLE\",\n\t\"ACT_PUB_DSE_DEENABLE\",\n\t\"ACT_PUB_DSE_REG_LOCATION\",\n\t\"ACT_PUB_EXT_CHL_SWITCH\",\n\t\"ACT_PUB_DSE_MSR_REQ\",\n\t\"ACT_PUB_DSE_MSR_RPRT\",\n\t\"ACT_PUB_MP\",\n\t\"ACT_PUB_DSE_PWR_CONSTRAINT\",\n\t\"ACT_PUB_VENDOR\",\n\t\"ACT_PUB_GAS_INITIAL_REQ\",\n\t\"ACT_PUB_GAS_INITIAL_RSP\",\n\t\"ACT_PUB_GAS_COMEBACK_REQ\",\n\t\"ACT_PUB_GAS_COMEBACK_RSP\",\n\t\"ACT_PUB_TDLS_DISCOVERY_RSP\",\n\t\"ACT_PUB_LOCATION_TRACK\",\n\t\"ACT_PUB_RSVD\",\n};\n\nconst char *action_public_str(u8 action)\n{\n\taction = (action >= ACT_PUBLIC_MAX) ? ACT_PUBLIC_MAX : action;\n\treturn _action_public_str[action];\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}