{
  "module_name": "rtl8723b_dm.c",
  "hash_id": "ee9179399562f14af60ee094fcc95453642a71e81a4829c00bea2eb0503aa466",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8723bs/hal/rtl8723b_dm.c",
  "human_readable_source": "\n \n \n \n\n#include <drv_types.h>\n#include <rtw_debug.h>\n#include <rtl8723b_hal.h>\n\n \n\nstatic void dm_CheckStatistics(struct adapter *Adapter)\n{\n}\n \n \n \nstatic void Init_ODM_ComInfo_8723b(struct adapter *Adapter)\n{\n\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\n\tstruct dm_odm_t *pDM_Odm = &pHalData->odmpriv;\n\tstruct dm_priv *pdmpriv = &pHalData->dmpriv;\n\tu8 cut_ver, fab_ver;\n\n\t \n\t \n\t \n\tmemset(pDM_Odm, 0, sizeof(*pDM_Odm));\n\n\tpDM_Odm->Adapter = Adapter;\n#define ODM_CE 0x04\n\tODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_PLATFORM, ODM_CE);\n\tODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_INTERFACE, RTW_SDIO);\n\tODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_PACKAGE_TYPE, pHalData->PackageType);\n\tODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_IC_TYPE, ODM_RTL8723B);\n\n\tfab_ver = ODM_TSMC;\n\tcut_ver = ODM_CUT_A;\n\n\tODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_FAB_VER, fab_ver);\n\tODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_CUT_VER, cut_ver);\n\n\tODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_PATCH_ID, pHalData->CustomerID);\n\t \n\tODM_CmnInfoInit(pDM_Odm, ODM_CMNINFO_BWIFI_TEST, Adapter->registrypriv.wifi_spec);\n\n\tpdmpriv->InitODMFlag = ODM_RF_CALIBRATION|ODM_RF_TX_PWR_TRACK;\n\n\tODM_CmnInfoUpdate(pDM_Odm, ODM_CMNINFO_ABILITY, pdmpriv->InitODMFlag);\n}\n\nstatic void Update_ODM_ComInfo_8723b(struct adapter *Adapter)\n{\n\tstruct mlme_ext_priv *pmlmeext = &Adapter->mlmeextpriv;\n\tstruct mlme_priv *pmlmepriv = &Adapter->mlmepriv;\n\tstruct dvobj_priv *dvobj = adapter_to_dvobj(Adapter);\n\tstruct pwrctrl_priv *pwrctrlpriv = adapter_to_pwrctl(Adapter);\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\n\tstruct dm_odm_t *pDM_Odm = &pHalData->odmpriv;\n\tstruct dm_priv *pdmpriv = &pHalData->dmpriv;\n\tint i;\n\tu8 zero = 0;\n\n\tpdmpriv->InitODMFlag = 0\n\t\t| ODM_BB_DIG\n\t\t| ODM_BB_RA_MASK\n\t\t| ODM_BB_DYNAMIC_TXPWR\n\t\t| ODM_BB_FA_CNT\n\t\t| ODM_BB_RSSI_MONITOR\n\t\t| ODM_BB_CCK_PD\n\t\t| ODM_BB_PWR_SAVE\n\t\t| ODM_BB_CFO_TRACKING\n\t\t| ODM_MAC_EDCA_TURBO\n\t\t| ODM_RF_TX_PWR_TRACK\n\t\t| ODM_RF_CALIBRATION\n\t\t;\n\n\t \n\t \n\t \n\t \n\t \n\n\tODM_CmnInfoUpdate(pDM_Odm, ODM_CMNINFO_ABILITY, pdmpriv->InitODMFlag);\n\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_TX_UNI, &(dvobj->traffic_stat.tx_bytes));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_RX_UNI, &(dvobj->traffic_stat.rx_bytes));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_WM_MODE, &(pmlmeext->cur_wireless_mode));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_SEC_CHNL_OFFSET, &(pHalData->nCur40MhzPrimeSC));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_SEC_MODE, &(Adapter->securitypriv.dot11PrivacyAlgrthm));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_BW, &(pHalData->CurrentChannelBW));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_CHNL, &(pHalData->CurrentChannel));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_NET_CLOSED, &(Adapter->net_closed));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_MP_MODE, &zero);\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_FORCED_IGI_LB, &(pHalData->u1ForcedIgiLb));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_FORCED_RATE, &(pHalData->ForcedDataRate));\n\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_SCAN, &(pmlmepriv->bScanInProcess));\n\tODM_CmnInfoHook(pDM_Odm, ODM_CMNINFO_POWER_SAVING, &(pwrctrlpriv->bpower_saving));\n\n\n\tfor (i = 0; i < NUM_STA; i++)\n\t\tODM_CmnInfoPtrArrayHook(pDM_Odm, ODM_CMNINFO_STA_STATUS, i, NULL);\n}\n\nvoid rtl8723b_InitHalDm(struct adapter *Adapter)\n{\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\n\tstruct dm_priv *pdmpriv = &pHalData->dmpriv;\n\tstruct dm_odm_t *pDM_Odm = &pHalData->odmpriv;\n\n\tpdmpriv->DM_Type = DM_Type_ByDriver;\n\tpdmpriv->DMFlag = DYNAMIC_FUNC_DISABLE;\n\n\tpdmpriv->DMFlag |= DYNAMIC_FUNC_BT;\n\n\tpdmpriv->InitDMFlag = pdmpriv->DMFlag;\n\n\tUpdate_ODM_ComInfo_8723b(Adapter);\n\n\tODM_DMInit(pDM_Odm);\n}\n\nvoid rtl8723b_HalDmWatchDog(struct adapter *Adapter)\n{\n\tbool fw_current_in_ps_mode = false;\n\tbool bFwPSAwake = true;\n\tu8 hw_init_completed = false;\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\n\n\thw_init_completed = Adapter->hw_init_completed;\n\n\tif (hw_init_completed == false)\n\t\tgoto skip_dm;\n\n\tfw_current_in_ps_mode = adapter_to_pwrctl(Adapter)->fw_current_in_ps_mode;\n\trtw_hal_get_hwreg(Adapter, HW_VAR_FWLPS_RF_ON, (u8 *)(&bFwPSAwake));\n\n\tif (\n\t\t(hw_init_completed == true) &&\n\t\t((!fw_current_in_ps_mode) && bFwPSAwake)\n\t) {\n\t\t \n\t\t \n\t\t \n\t\tdm_CheckStatistics(Adapter);\n\t\trtw_hal_check_rxfifo_full(Adapter);\n\t}\n\n\t \n\tif (hw_init_completed == true) {\n\t\tu8 bLinked = false;\n\t\tu8 bsta_state = false;\n\t\tbool bBtDisabled = true;\n\n\t\tif (rtw_linked_check(Adapter)) {\n\t\t\tbLinked = true;\n\t\t\tif (check_fwstate(&Adapter->mlmepriv, WIFI_STATION_STATE))\n\t\t\t\tbsta_state = true;\n\t\t}\n\n\t\tODM_CmnInfoUpdate(&pHalData->odmpriv, ODM_CMNINFO_LINK, bLinked);\n\t\tODM_CmnInfoUpdate(&pHalData->odmpriv, ODM_CMNINFO_STATION_STATE, bsta_state);\n\n\t\t \n\n\t\tbBtDisabled = hal_btcoex_IsBtDisabled(Adapter);\n\n\t\tODM_CmnInfoUpdate(&pHalData->odmpriv, ODM_CMNINFO_BT_ENABLED,\n\t\t\t\t  !bBtDisabled);\n\n\t\tODM_DMWatchdog(&pHalData->odmpriv);\n\t}\n\nskip_dm:\n\treturn;\n}\n\nvoid rtl8723b_hal_dm_in_lps(struct adapter *padapter)\n{\n\tu32 PWDB_rssi = 0;\n\tstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(padapter);\n\tstruct dm_odm_t *pDM_Odm = &pHalData->odmpriv;\n\tstruct sta_priv *pstapriv = &padapter->stapriv;\n\tstruct sta_info *psta = NULL;\n\n\t \n\tODM_Write_DIG(pDM_Odm, pDM_Odm->RSSI_Min);\n\n\n\t \n\tpsta = rtw_get_stainfo(pstapriv, get_bssid(pmlmepriv));\n\tif (psta && (psta->rssi_stat.UndecoratedSmoothedPWDB > 0)) {\n\t\tPWDB_rssi = (psta->mac_id | (psta->rssi_stat.UndecoratedSmoothedPWDB<<16));\n\n\t\trtl8723b_set_rssi_cmd(padapter, (u8 *)&PWDB_rssi);\n\t}\n\n}\n\nvoid rtl8723b_HalDmWatchDog_in_LPS(struct adapter *Adapter)\n{\n\tu8 bLinked = false;\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\n\tstruct mlme_priv *pmlmepriv = &Adapter->mlmepriv;\n\tstruct dm_priv *pdmpriv = &pHalData->dmpriv;\n\tstruct dm_odm_t *pDM_Odm = &pHalData->odmpriv;\n\tstruct dig_t *pDM_DigTable = &pDM_Odm->DM_DigTable;\n\tstruct sta_priv *pstapriv = &Adapter->stapriv;\n\tstruct sta_info *psta = NULL;\n\n\tif (Adapter->hw_init_completed == false)\n\t\tgoto skip_lps_dm;\n\n\n\tif (rtw_linked_check(Adapter))\n\t\tbLinked = true;\n\n\tODM_CmnInfoUpdate(&pHalData->odmpriv, ODM_CMNINFO_LINK, bLinked);\n\n\tif (bLinked == false)\n\t\tgoto skip_lps_dm;\n\n\tif (!(pDM_Odm->SupportAbility & ODM_BB_RSSI_MONITOR))\n\t\tgoto skip_lps_dm;\n\n\n\t \n\t \n\n       \n\tpsta = rtw_get_stainfo(pstapriv, get_bssid(pmlmepriv));\n\tif (!psta)\n\t\tgoto skip_lps_dm;\n\n\tpdmpriv->EntryMinUndecoratedSmoothedPWDB = psta->rssi_stat.UndecoratedSmoothedPWDB;\n\n\tif (pdmpriv->EntryMinUndecoratedSmoothedPWDB <= 0)\n\t\tgoto skip_lps_dm;\n\n\tpdmpriv->MinUndecoratedPWDBForDM = pdmpriv->EntryMinUndecoratedSmoothedPWDB;\n\n\tpDM_Odm->RSSI_Min = pdmpriv->MinUndecoratedPWDBForDM;\n\n\t \n\tif (\n\t\t(pDM_DigTable->CurIGValue > pDM_Odm->RSSI_Min + 5) ||\n\t\t(pDM_DigTable->CurIGValue < pDM_Odm->RSSI_Min - 5)\n\t)\n\t\trtw_dm_in_lps_wk_cmd(Adapter);\n\n\nskip_lps_dm:\n\n\treturn;\n\n}\n\nvoid rtl8723b_init_dm_priv(struct adapter *Adapter)\n{\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\n\tstruct dm_priv *pdmpriv = &pHalData->dmpriv;\n\n\tmemset(pdmpriv, 0, sizeof(struct dm_priv));\n\tInit_ODM_ComInfo_8723b(Adapter);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}