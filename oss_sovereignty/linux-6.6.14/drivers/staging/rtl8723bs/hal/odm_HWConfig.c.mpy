{
  "module_name": "odm_HWConfig.c",
  "hash_id": "c0aa52f86891e19366a8546572037654332de37c96743ced92df632798794349",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8723bs/hal/odm_HWConfig.c",
  "human_readable_source": "\n \n\n#include \"odm_precomp.h\"\n\n#define READ_AND_CONFIG_MP(ic, txt) (ODM_ReadAndConfig_MP_##ic##txt(pDM_Odm))\n#define READ_AND_CONFIG     READ_AND_CONFIG_MP\n\nstatic u8 odm_query_rx_pwr_percentage(s8 ant_power)\n{\n\tif ((ant_power <= -100) || (ant_power >= 20))\n\t\treturn\t0;\n\telse if (ant_power >= 0)\n\t\treturn\t100;\n\telse\n\t\treturn 100 + ant_power;\n\n}\n\ns32 odm_signal_scale_mapping(struct dm_odm_t *dm_odm, s32 curr_sig)\n{\n\ts32 ret_sig = 0;\n\n\tif (dm_odm->SupportInterface  == ODM_ITRF_SDIO) {\n\t\tif (curr_sig >= 51 && curr_sig <= 100)\n\t\t\tret_sig = 100;\n\t\telse if (curr_sig >= 41 && curr_sig <= 50)\n\t\t\tret_sig = 80 + ((curr_sig - 40)*2);\n\t\telse if (curr_sig >= 31 && curr_sig <= 40)\n\t\t\tret_sig = 66 + (curr_sig - 30);\n\t\telse if (curr_sig >= 21 && curr_sig <= 30)\n\t\t\tret_sig = 54 + (curr_sig - 20);\n\t\telse if (curr_sig >= 10 && curr_sig <= 20)\n\t\t\tret_sig = 42 + (((curr_sig - 10) * 2) / 3);\n\t\telse if (curr_sig >= 5 && curr_sig <= 9)\n\t\t\tret_sig = 22 + (((curr_sig - 5) * 3) / 2);\n\t\telse if (curr_sig >= 1 && curr_sig <= 4)\n\t\t\tret_sig = 6 + (((curr_sig - 1) * 3) / 2);\n\t\telse\n\t\t\tret_sig = curr_sig;\n\t}\n\n\treturn ret_sig;\n}\n\nstatic u8 odm_evm_db_to_percentage(s8 value)\n{\n\t \n\t \n\t \n\ts8 ret_val;\n\n\tret_val = value;\n\tret_val /= 2;\n\n\tif (ret_val >= 0)\n\t\tret_val = 0;\n\tif (ret_val <= -33)\n\t\tret_val = -33;\n\n\tret_val = 0 - ret_val;\n\tret_val *= 3;\n\n\tif (ret_val == 99)\n\t\tret_val = 100;\n\n\treturn ret_val;\n}\n\nstatic s8 odm_cck_rssi(u8 lna_idx, u8 vga_idx)\n{\n\ts8 rx_pwr_all = 0x00;\n\n\tswitch (lna_idx) {\n\t \n\t \n\n\tcase 6:\n\t\trx_pwr_all = -34 - (2 * vga_idx);\n\t\tbreak;\n\tcase 4:\n\t\trx_pwr_all = -14 - (2 * vga_idx);\n\t\tbreak;\n\tcase 1:\n\t\trx_pwr_all = 6 - (2 * vga_idx);\n\t\tbreak;\n\tcase 0:\n\t\trx_pwr_all = 16 - (2 * vga_idx);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tbreak;\n\t}\n\treturn rx_pwr_all;\n}\n\nstatic void odm_rx_phy_status_parsing(struct dm_odm_t *dm_odm,\n\t\t\t\t      struct odm_phy_info *phy_info,\n\t\t\t\t      u8 *phy_status,\n\t\t\t\t      struct odm_packet_info *pkt_info)\n{\n\tu8 i;\n\ts8 rx_pwr[4], rx_pwr_all = 0;\n\tu8 evm, pwdb_all = 0, pwdb_all_bt;\n\tu8 rssi, total_rssi = 0;\n\tbool is_cck_rate = false;\n\tu8 rf_rx_num = 0;\n\tu8 lna_idx, vga_idx;\n\tstruct phy_status_rpt_8192cd_t *phy_sta_rpt = (struct phy_status_rpt_8192cd_t *)phy_status;\n\n\tis_cck_rate = pkt_info->data_rate <= DESC_RATE11M;\n\tphy_info->rx_mimo_signal_quality[RF_PATH_A] = -1;\n\tphy_info->rx_mimo_signal_quality[RF_PATH_B] = -1;\n\n\n\tif (is_cck_rate) {\n\t\tu8 cck_agc_rpt;\n\n\t\tdm_odm->PhyDbgInfo.NumQryPhyStatusCCK++;\n\n\t\t \n\n\t\tcck_agc_rpt = phy_sta_rpt->cck_agc_rpt_ofdm_cfosho_a;\n\n\t\t \n\t\tlna_idx = ((cck_agc_rpt & 0xE0)>>5);\n\t\tvga_idx = (cck_agc_rpt & 0x1F);\n\t\trx_pwr_all = odm_cck_rssi(lna_idx, vga_idx);\n\t\tpwdb_all = odm_query_rx_pwr_percentage(rx_pwr_all);\n\t\tif (pwdb_all > 100)\n\t\t\tpwdb_all = 100;\n\n\t\tphy_info->rx_pwd_ba11 = pwdb_all;\n\t\tphy_info->bt_rx_rssi_percentage = pwdb_all;\n\t\tphy_info->recv_signal_power = rx_pwr_all;\n\n\t\t \n\n\t\t \n\t\t{\n\t\t\tu8 sq, sq_rpt;\n\n\t\t\tif (phy_info->rx_pwd_ba11 > 40 && !dm_odm->bInHctTest)\n\t\t\t\tsq = 100;\n\t\t\telse {\n\t\t\t\tsq_rpt = phy_sta_rpt->cck_sig_qual_ofdm_pwdb_all;\n\n\t\t\t\tif (sq_rpt > 64)\n\t\t\t\t\tsq = 0;\n\t\t\t\telse if (sq_rpt < 20)\n\t\t\t\t\tsq = 100;\n\t\t\t\telse\n\t\t\t\t\tsq = ((64-sq_rpt) * 100) / 44;\n\n\t\t\t}\n\n\t\t\tphy_info->signal_quality = sq;\n\t\t\tphy_info->rx_mimo_signal_quality[RF_PATH_A] = sq;\n\t\t\tphy_info->rx_mimo_signal_quality[RF_PATH_B] = -1;\n\t\t}\n\t} else {  \n\t\tdm_odm->PhyDbgInfo.NumQryPhyStatusOFDM++;\n\n\t\t \n\n\t\tfor (i = RF_PATH_A; i < RF_PATH_MAX; i++) {\n\t\t\t \n\t\t\tif (dm_odm->RFPathRxEnable & BIT(i))\n\t\t\t\trf_rx_num++;\n\t\t\t \n\t\t\t\t \n\n\t\t\trx_pwr[i] = ((phy_sta_rpt->path_agc[i].gain & 0x3F) * 2) - 110;\n\n\t\t\tphy_info->rx_pwr[i] = rx_pwr[i];\n\n\t\t\t \n\t\t\trssi = odm_query_rx_pwr_percentage(rx_pwr[i]);\n\t\t\ttotal_rssi += rssi;\n\n\t\t\tphy_info->rx_mimo_signal_strength[i] = (u8)rssi;\n\n\t\t\t \n\t\t\tphy_info->rx_snr[i] = dm_odm->PhyDbgInfo.RxSNRdB[i] = (s32)(phy_sta_rpt->path_rxsnr[i]/2);\n\t\t}\n\n\t\t \n\t\trx_pwr_all = ((phy_sta_rpt->cck_sig_qual_ofdm_pwdb_all >> 1) & 0x7f) - 110;\n\n\t\tpwdb_all_bt = pwdb_all = odm_query_rx_pwr_percentage(rx_pwr_all);\n\n\t\tphy_info->rx_pwd_ba11 = pwdb_all;\n\t\tphy_info->bt_rx_rssi_percentage = pwdb_all_bt;\n\t\tphy_info->rx_power = rx_pwr_all;\n\t\tphy_info->recv_signal_power = rx_pwr_all;\n\n\t\t \n\t\tevm = odm_evm_db_to_percentage(phy_sta_rpt->stream_rxevm[0]);  \n\n\t\t \n\t\tphy_info->signal_quality = (u8)(evm & 0xff);\n\n\t\tphy_info->rx_mimo_signal_quality[RF_PATH_A] = (u8)(evm & 0xff);\n\n\t\todm_parsing_cfo(dm_odm, pkt_info, phy_sta_rpt->path_cfotail);\n\t}\n\n\t \n\tif (is_cck_rate) {\n\t\tphy_info->signal_strength = (u8)(odm_signal_scale_mapping(dm_odm, pwdb_all));\n\t} else {\n\t\tif (rf_rx_num != 0) {\n\t\t\tphy_info->signal_strength = (u8)(odm_signal_scale_mapping(dm_odm, total_rssi /= rf_rx_num));\n\t\t}\n\t}\n}\n\nstatic void odm_Process_RSSIForDM(\n\tstruct dm_odm_t *pDM_Odm, struct odm_phy_info *pPhyInfo, struct odm_packet_info *pPktinfo\n)\n{\n\n\ts32 UndecoratedSmoothedPWDB, UndecoratedSmoothedCCK, UndecoratedSmoothedOFDM, RSSI_Ave;\n\tu8 isCCKrate = 0;\n\tu8 RSSI_max, RSSI_min, i;\n\tu32 OFDM_pkt = 0;\n\tu32 Weighting = 0;\n\tPSTA_INFO_T pEntry;\n\n\n\tif (pPktinfo->station_id == 0xFF)\n\t\treturn;\n\n\tpEntry = pDM_Odm->pODM_StaInfo[pPktinfo->station_id];\n\n\tif (!IS_STA_VALID(pEntry))\n\t\treturn;\n\n\tif ((!pPktinfo->bssid_match))\n\t\treturn;\n\n\tif (pPktinfo->is_beacon)\n\t\tpDM_Odm->PhyDbgInfo.NumQryBeaconPkt++;\n\n\tisCCKrate = ((pPktinfo->data_rate <= DESC_RATE11M)) ? true : false;\n\tpDM_Odm->RxRate = pPktinfo->data_rate;\n\n\t \n\tif (pDM_Odm->SupportAbility & ODM_BB_ANT_DIV) {\n\n\t}\n\n\t \n\n\tUndecoratedSmoothedCCK = pEntry->rssi_stat.UndecoratedSmoothedCCK;\n\tUndecoratedSmoothedOFDM = pEntry->rssi_stat.UndecoratedSmoothedOFDM;\n\tUndecoratedSmoothedPWDB = pEntry->rssi_stat.UndecoratedSmoothedPWDB;\n\n\tif (pPktinfo->to_self || pPktinfo->is_beacon) {\n\n\t\tif (!isCCKrate) {  \n\t\t\tif (pPhyInfo->rx_mimo_signal_strength[RF_PATH_B] == 0) {\n\t\t\t\tRSSI_Ave = pPhyInfo->rx_mimo_signal_strength[RF_PATH_A];\n\t\t\t\tpDM_Odm->RSSI_A = pPhyInfo->rx_mimo_signal_strength[RF_PATH_A];\n\t\t\t\tpDM_Odm->RSSI_B = 0;\n\t\t\t} else {\n\t\t\t\tpDM_Odm->RSSI_A =  pPhyInfo->rx_mimo_signal_strength[RF_PATH_A];\n\t\t\t\tpDM_Odm->RSSI_B = pPhyInfo->rx_mimo_signal_strength[RF_PATH_B];\n\n\t\t\t\tif (\n\t\t\t\t\tpPhyInfo->rx_mimo_signal_strength[RF_PATH_A] >\n\t\t\t\t\tpPhyInfo->rx_mimo_signal_strength[RF_PATH_B]\n\t\t\t\t) {\n\t\t\t\t\tRSSI_max = pPhyInfo->rx_mimo_signal_strength[RF_PATH_A];\n\t\t\t\t\tRSSI_min = pPhyInfo->rx_mimo_signal_strength[RF_PATH_B];\n\t\t\t\t} else {\n\t\t\t\t\tRSSI_max = pPhyInfo->rx_mimo_signal_strength[RF_PATH_B];\n\t\t\t\t\tRSSI_min = pPhyInfo->rx_mimo_signal_strength[RF_PATH_A];\n\t\t\t\t}\n\n\t\t\t\tif ((RSSI_max-RSSI_min) < 3)\n\t\t\t\t\tRSSI_Ave = RSSI_max;\n\t\t\t\telse if ((RSSI_max-RSSI_min) < 6)\n\t\t\t\t\tRSSI_Ave = RSSI_max - 1;\n\t\t\t\telse if ((RSSI_max-RSSI_min) < 10)\n\t\t\t\t\tRSSI_Ave = RSSI_max - 2;\n\t\t\t\telse\n\t\t\t\t\tRSSI_Ave = RSSI_max - 3;\n\t\t\t}\n\n\t\t\t \n\t\t\tif (UndecoratedSmoothedOFDM <= 0)\t \n\t\t\t\tUndecoratedSmoothedOFDM = pPhyInfo->rx_pwd_ba11;\n\t\t\telse {\n\t\t\t\tif (pPhyInfo->rx_pwd_ba11 > (u32)UndecoratedSmoothedOFDM) {\n\t\t\t\t\tUndecoratedSmoothedOFDM =\n\t\t\t\t\t\t\t((UndecoratedSmoothedOFDM*(Rx_Smooth_Factor-1)) +\n\t\t\t\t\t\t\tRSSI_Ave)/Rx_Smooth_Factor;\n\t\t\t\t\tUndecoratedSmoothedOFDM = UndecoratedSmoothedOFDM + 1;\n\t\t\t\t} else {\n\t\t\t\t\tUndecoratedSmoothedOFDM =\n\t\t\t\t\t\t\t((UndecoratedSmoothedOFDM*(Rx_Smooth_Factor-1)) +\n\t\t\t\t\t\t\tRSSI_Ave)/Rx_Smooth_Factor;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tpEntry->rssi_stat.PacketMap = (pEntry->rssi_stat.PacketMap<<1) | BIT0;\n\n\t\t} else {\n\t\t\tRSSI_Ave = pPhyInfo->rx_pwd_ba11;\n\t\t\tpDM_Odm->RSSI_A = (u8) pPhyInfo->rx_pwd_ba11;\n\t\t\tpDM_Odm->RSSI_B = 0;\n\n\t\t\t \n\t\t\tif (UndecoratedSmoothedCCK <= 0)\t \n\t\t\t\tUndecoratedSmoothedCCK = pPhyInfo->rx_pwd_ba11;\n\t\t\telse {\n\t\t\t\tif (pPhyInfo->rx_pwd_ba11 > (u32)UndecoratedSmoothedCCK) {\n\t\t\t\t\tUndecoratedSmoothedCCK =\n\t\t\t\t\t\t\t((UndecoratedSmoothedCCK*(Rx_Smooth_Factor-1)) +\n\t\t\t\t\t\t\tpPhyInfo->rx_pwd_ba11)/Rx_Smooth_Factor;\n\t\t\t\t\tUndecoratedSmoothedCCK = UndecoratedSmoothedCCK + 1;\n\t\t\t\t} else {\n\t\t\t\t\tUndecoratedSmoothedCCK =\n\t\t\t\t\t\t\t((UndecoratedSmoothedCCK*(Rx_Smooth_Factor-1)) +\n\t\t\t\t\t\t\tpPhyInfo->rx_pwd_ba11)/Rx_Smooth_Factor;\n\t\t\t\t}\n\t\t\t}\n\t\t\tpEntry->rssi_stat.PacketMap = pEntry->rssi_stat.PacketMap<<1;\n\t\t}\n\n\t\t \n\t\t{\n\t\t\t \n\t\t\tif (pEntry->rssi_stat.ValidBit >= 64)\n\t\t\t\tpEntry->rssi_stat.ValidBit = 64;\n\t\t\telse\n\t\t\t\tpEntry->rssi_stat.ValidBit++;\n\n\t\t\tfor (i = 0; i < pEntry->rssi_stat.ValidBit; i++)\n\t\t\t\tOFDM_pkt += (u8)(pEntry->rssi_stat.PacketMap>>i)&BIT0;\n\n\t\t\tif (pEntry->rssi_stat.ValidBit == 64) {\n\t\t\t\tWeighting = ((OFDM_pkt<<4) > 64)?64:(OFDM_pkt<<4);\n\t\t\t\tUndecoratedSmoothedPWDB = (Weighting*UndecoratedSmoothedOFDM+(64-Weighting)*UndecoratedSmoothedCCK)>>6;\n\t\t\t} else {\n\t\t\t\tif (pEntry->rssi_stat.ValidBit != 0)\n\t\t\t\t\tUndecoratedSmoothedPWDB = (OFDM_pkt*UndecoratedSmoothedOFDM+(pEntry->rssi_stat.ValidBit-OFDM_pkt)*UndecoratedSmoothedCCK)/pEntry->rssi_stat.ValidBit;\n\t\t\t\telse\n\t\t\t\t\tUndecoratedSmoothedPWDB = 0;\n\t\t\t}\n\n\t\t\tpEntry->rssi_stat.UndecoratedSmoothedCCK = UndecoratedSmoothedCCK;\n\t\t\tpEntry->rssi_stat.UndecoratedSmoothedOFDM = UndecoratedSmoothedOFDM;\n\t\t\tpEntry->rssi_stat.UndecoratedSmoothedPWDB = UndecoratedSmoothedPWDB;\n\t\t}\n\n\t}\n}\n\n\n \n \n \nvoid odm_phy_status_query(struct dm_odm_t *dm_odm, struct odm_phy_info *phy_info,\n\t\t\t  u8 *phy_status, struct odm_packet_info *pkt_info)\n{\n\n\todm_rx_phy_status_parsing(dm_odm, phy_info, phy_status, pkt_info);\n\n\tif (!dm_odm->RSSI_test)\n\t\todm_Process_RSSIForDM(dm_odm, phy_info, pkt_info);\n}\n\n \n \n \n \n\nenum hal_status ODM_ConfigRFWithHeaderFile(\n\tstruct dm_odm_t *pDM_Odm,\n\tenum ODM_RF_Config_Type ConfigType,\n\tenum rf_path eRFPath\n)\n{\n\tif (ConfigType == CONFIG_RF_RADIO)\n\t\tREAD_AND_CONFIG(8723B, _RadioA);\n\telse if (ConfigType == CONFIG_RF_TXPWR_LMT)\n\t\tREAD_AND_CONFIG(8723B, _TXPWR_LMT);\n\n\treturn HAL_STATUS_SUCCESS;\n}\n\nenum hal_status ODM_ConfigRFWithTxPwrTrackHeaderFile(struct dm_odm_t *pDM_Odm)\n{\n\tif (pDM_Odm->SupportInterface == ODM_ITRF_SDIO)\n\t\tREAD_AND_CONFIG(8723B, _TxPowerTrack_SDIO);\n\n\treturn HAL_STATUS_SUCCESS;\n}\n\nenum hal_status ODM_ConfigBBWithHeaderFile(\n\tstruct dm_odm_t *pDM_Odm, enum ODM_BB_Config_Type ConfigType\n)\n{\n\tif (ConfigType == CONFIG_BB_PHY_REG)\n\t\tREAD_AND_CONFIG(8723B, _PHY_REG);\n\telse if (ConfigType == CONFIG_BB_AGC_TAB)\n\t\tREAD_AND_CONFIG(8723B, _AGC_TAB);\n\telse if (ConfigType == CONFIG_BB_PHY_REG_PG)\n\t\tREAD_AND_CONFIG(8723B, _PHY_REG_PG);\n\n\treturn HAL_STATUS_SUCCESS;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}