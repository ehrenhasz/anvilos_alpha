{
  "module_name": "odm_CfoTracking.c",
  "hash_id": "7d998792efb1fb587cd3fc26ca8d3ba1a344c865cd2d6fa915c58bd1574b1203",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8723bs/hal/odm_CfoTracking.c",
  "human_readable_source": "\n \n\n#include \"odm_precomp.h\"\n\nstatic void odm_SetCrystalCap(void *pDM_VOID, u8 CrystalCap)\n{\n\tstruct dm_odm_t *pDM_Odm = (struct dm_odm_t *)pDM_VOID;\n\tstruct cfo_tracking *pCfoTrack = &pDM_Odm->DM_CfoTrack;\n\n\tif (pCfoTrack->CrystalCap == CrystalCap)\n\t\treturn;\n\n\tpCfoTrack->CrystalCap = CrystalCap;\n\n\t \n\tCrystalCap = CrystalCap & 0x3F;\n\tPHY_SetBBReg(\n\t\tpDM_Odm->Adapter,\n\t\tREG_MAC_PHY_CTRL,\n\t\t0x00FFF000,\n\t\t(CrystalCap | (CrystalCap << 6))\n\t);\n}\n\nstatic u8 odm_GetDefaultCrytaltalCap(void *pDM_VOID)\n{\n\tstruct dm_odm_t *pDM_Odm = (struct dm_odm_t *)pDM_VOID;\n\n\tstruct adapter *Adapter = pDM_Odm->Adapter;\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\n\n\treturn pHalData->CrystalCap & 0x3f;\n}\n\nstatic void odm_SetATCStatus(void *pDM_VOID, bool ATCStatus)\n{\n\tstruct dm_odm_t *pDM_Odm = (struct dm_odm_t *)pDM_VOID;\n\tstruct cfo_tracking *pCfoTrack = &pDM_Odm->DM_CfoTrack;\n\n\tif (pCfoTrack->bATCStatus == ATCStatus)\n\t\treturn;\n\n\tPHY_SetBBReg(\n\t\tpDM_Odm->Adapter,\n\t\tODM_REG(BB_ATC, pDM_Odm),\n\t\tODM_BIT(BB_ATC, pDM_Odm),\n\t\tATCStatus\n\t);\n\tpCfoTrack->bATCStatus = ATCStatus;\n}\n\nstatic bool odm_GetATCStatus(void *pDM_VOID)\n{\n\tbool ATCStatus;\n\tstruct dm_odm_t *pDM_Odm = (struct dm_odm_t *)pDM_VOID;\n\n\tATCStatus = (bool)PHY_QueryBBReg(\n\t\tpDM_Odm->Adapter,\n\t\tODM_REG(BB_ATC, pDM_Odm),\n\t\tODM_BIT(BB_ATC, pDM_Odm)\n\t);\n\treturn ATCStatus;\n}\n\nvoid ODM_CfoTrackingReset(void *pDM_VOID)\n{\n\tstruct dm_odm_t *pDM_Odm = (struct dm_odm_t *)pDM_VOID;\n\tstruct cfo_tracking *pCfoTrack = &pDM_Odm->DM_CfoTrack;\n\n\tpCfoTrack->DefXCap = odm_GetDefaultCrytaltalCap(pDM_Odm);\n\tpCfoTrack->bAdjust = true;\n\n\todm_SetCrystalCap(pDM_Odm, pCfoTrack->DefXCap);\n\todm_SetATCStatus(pDM_Odm, true);\n}\n\nvoid ODM_CfoTrackingInit(void *pDM_VOID)\n{\n\tstruct dm_odm_t *pDM_Odm = (struct dm_odm_t *)pDM_VOID;\n\tstruct cfo_tracking *pCfoTrack = &pDM_Odm->DM_CfoTrack;\n\n\tpCfoTrack->DefXCap =\n\t\tpCfoTrack->CrystalCap = odm_GetDefaultCrytaltalCap(pDM_Odm);\n\tpCfoTrack->bATCStatus = odm_GetATCStatus(pDM_Odm);\n\tpCfoTrack->bAdjust = true;\n}\n\nvoid ODM_CfoTracking(void *pDM_VOID)\n{\n\tstruct dm_odm_t *pDM_Odm = (struct dm_odm_t *)pDM_VOID;\n\tstruct cfo_tracking *pCfoTrack = &pDM_Odm->DM_CfoTrack;\n\tint CFO_kHz_A, CFO_ave = 0;\n\tint CFO_ave_diff;\n\tint CrystalCap = (int)pCfoTrack->CrystalCap;\n\tu8 Adjust_Xtal = 1;\n\n\t \n\tif (!(pDM_Odm->SupportAbility & ODM_BB_CFO_TRACKING)) {\n\t\treturn;\n\t}\n\n\tif (!pDM_Odm->bLinked || !pDM_Odm->bOneEntryOnly) {\n\t\t \n\t\tODM_CfoTrackingReset(pDM_Odm);\n\t} else {\n\t\t \n\t\t \n\t\tif (pCfoTrack->packetCount == pCfoTrack->packetCount_pre) {\n\t\t\treturn;\n\t\t}\n\t\tpCfoTrack->packetCount_pre = pCfoTrack->packetCount;\n\n\t\t \n\t\tCFO_kHz_A =  (int)(pCfoTrack->CFO_tail[0] * 3125)  / 1280;\n\n\t\tCFO_ave = CFO_kHz_A;\n\n\t\t \n\t\tCFO_ave_diff =\n\t\t\t(pCfoTrack->CFO_ave_pre >= CFO_ave) ?\n\t\t\t(pCfoTrack->CFO_ave_pre-CFO_ave) :\n\t\t\t(CFO_ave-pCfoTrack->CFO_ave_pre);\n\n\t\tif (\n\t\t\tCFO_ave_diff > 20 &&\n\t\t\tpCfoTrack->largeCFOHit == 0 &&\n\t\t\t!pCfoTrack->bAdjust\n\t\t) {\n\t\t\tpCfoTrack->largeCFOHit = 1;\n\t\t\treturn;\n\t\t} else\n\t\t\tpCfoTrack->largeCFOHit = 0;\n\t\tpCfoTrack->CFO_ave_pre = CFO_ave;\n\n\t\t \n\t\tif (pCfoTrack->bAdjust == false) {\n\t\t\tif (CFO_ave > CFO_TH_XTAL_HIGH || CFO_ave < (-CFO_TH_XTAL_HIGH))\n\t\t\t\tpCfoTrack->bAdjust = true;\n\t\t} else {\n\t\t\tif (CFO_ave < CFO_TH_XTAL_LOW && CFO_ave > (-CFO_TH_XTAL_LOW))\n\t\t\t\tpCfoTrack->bAdjust = false;\n\t\t}\n\n\t\t \n\t\tif (pDM_Odm->bBtEnabled) {\n\t\t\tpCfoTrack->bAdjust = false;\n\t\t\todm_SetCrystalCap(pDM_Odm, pCfoTrack->DefXCap);\n\t\t}\n\n\t\t \n\t\tif (pCfoTrack->bAdjust) {\n\t\t\tif (CFO_ave > CFO_TH_XTAL_LOW)\n\t\t\t\tAdjust_Xtal = Adjust_Xtal+((CFO_ave-CFO_TH_XTAL_LOW)>>2);\n\t\t\telse if (CFO_ave < (-CFO_TH_XTAL_LOW))\n\t\t\t\tAdjust_Xtal = Adjust_Xtal+((CFO_TH_XTAL_LOW-CFO_ave)>>2);\n\t\t}\n\n\t\t \n\t\tif (pCfoTrack->bAdjust) {\n\t\t\tif (CFO_ave > CFO_TH_XTAL_LOW)\n\t\t\t\tCrystalCap = CrystalCap + Adjust_Xtal;\n\t\t\telse if (CFO_ave < (-CFO_TH_XTAL_LOW))\n\t\t\t\tCrystalCap = CrystalCap - Adjust_Xtal;\n\n\t\t\tif (CrystalCap > 0x3f)\n\t\t\t\tCrystalCap = 0x3f;\n\t\t\telse if (CrystalCap < 0)\n\t\t\t\tCrystalCap = 0;\n\n\t\t\todm_SetCrystalCap(pDM_Odm, (u8)CrystalCap);\n\t\t}\n\n\t\t \n\t\tif (CFO_ave < CFO_TH_ATC && CFO_ave > -CFO_TH_ATC) {\n\t\t\todm_SetATCStatus(pDM_Odm, false);\n\t\t} else {\n\t\t\todm_SetATCStatus(pDM_Odm, true);\n\t\t}\n\t}\n}\n\nvoid odm_parsing_cfo(void *dm_void, void *pkt_info_void, s8 *cfotail)\n{\n\tstruct dm_odm_t *dm_odm = (struct dm_odm_t *)dm_void;\n\tstruct odm_packet_info *pkt_info = pkt_info_void;\n\tstruct cfo_tracking *cfo_track = &dm_odm->DM_CfoTrack;\n\tu8 i;\n\n\tif (!(dm_odm->SupportAbility & ODM_BB_CFO_TRACKING))\n\t\treturn;\n\n\tif (pkt_info->station_id != 0) {\n\t\t \n\t\tfor (i = RF_PATH_A; i <= RF_PATH_B; i++)\n\t\t\tcfo_track->CFO_tail[i] = (int)cfotail[i];\n\n\t\t \n\t\tif (cfo_track->packetCount == 0xffffffff)\n\t\t\tcfo_track->packetCount = 0;\n\t\telse\n\t\t\tcfo_track->packetCount++;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}