{
  "module_name": "HalPhyRf.c",
  "hash_id": "f8580c2f83661888e4a0496de90f782d766431fd91fee1b900a9bca38c6e2ae6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8723bs/hal/HalPhyRf.c",
  "human_readable_source": "\n \n\n \n#include \"odm_precomp.h\"\n\nvoid ConfigureTxpowerTrack(struct dm_odm_t *pDM_Odm, struct txpwrtrack_cfg *pConfig)\n{\n\tConfigureTxpowerTrack_8723B(pConfig);\n}\n\n \n \n \n \n \n \n \n \nvoid ODM_ClearTxPowerTrackingState(struct dm_odm_t *pDM_Odm)\n{\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(pDM_Odm->Adapter);\n\tu8 p = 0;\n\n\tpDM_Odm->BbSwingIdxCckBase = pDM_Odm->DefaultCckIndex;\n\tpDM_Odm->BbSwingIdxCck = pDM_Odm->DefaultCckIndex;\n\tpDM_Odm->RFCalibrateInfo.CCK_index = 0;\n\n\tfor (p = RF_PATH_A; p < MAX_RF_PATH; ++p) {\n\t\tpDM_Odm->BbSwingIdxOfdmBase[p] = pDM_Odm->DefaultOfdmIndex;\n\t\tpDM_Odm->BbSwingIdxOfdm[p] = pDM_Odm->DefaultOfdmIndex;\n\t\tpDM_Odm->RFCalibrateInfo.OFDM_index[p] = pDM_Odm->DefaultOfdmIndex;\n\n\t\tpDM_Odm->RFCalibrateInfo.PowerIndexOffset[p] = 0;\n\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[p] = 0;\n\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndexLast[p] = 0;\n\t\tpDM_Odm->RFCalibrateInfo.PowerIndexOffset[p] = 0;\n\n\t\t \n\t\tpDM_Odm->Absolute_OFDMSwingIdx[p] = 0;\n\t\tpDM_Odm->Remnant_OFDMSwingIdx[p] = 0;\n\t}\n\n\t \n\tpDM_Odm->Modify_TxAGC_Flag_PathA = false;\n\t \n\tpDM_Odm->Modify_TxAGC_Flag_PathB = false;\n\tpDM_Odm->Remnant_CCKSwingIdx = 0;\n\tpDM_Odm->RFCalibrateInfo.ThermalValue = pHalData->EEPROMThermalMeter;\n\tpDM_Odm->RFCalibrateInfo.ThermalValue_IQK = pHalData->EEPROMThermalMeter;\n\tpDM_Odm->RFCalibrateInfo.ThermalValue_LCK = pHalData->EEPROMThermalMeter;\n}\n\nvoid ODM_TXPowerTrackingCallback_ThermalMeter(struct adapter *Adapter)\n{\n\n\tstruct hal_com_data *pHalData = GET_HAL_DATA(Adapter);\n\tstruct dm_odm_t *pDM_Odm = &pHalData->odmpriv;\n\n\tu8 ThermalValue = 0, delta, delta_LCK, p = 0, i = 0;\n\tu8 ThermalValue_AVG_count = 0;\n\tu32 ThermalValue_AVG = 0;\n\n\tu8 OFDM_min_index = 0;   \n\tu8 Indexforchannel = 0;  \n\n\tstruct txpwrtrack_cfg c;\n\n\n\t \n\tu8 *deltaSwingTableIdx_TUP_A;\n\tu8 *deltaSwingTableIdx_TDOWN_A;\n\tu8 *deltaSwingTableIdx_TUP_B;\n\tu8 *deltaSwingTableIdx_TDOWN_B;\n\n\t \n\n\tConfigureTxpowerTrack(pDM_Odm, &c);\n\n\t(*c.GetDeltaSwingTable)(\n\t\tpDM_Odm,\n\t\t(u8 **)&deltaSwingTableIdx_TUP_A,\n\t\t(u8 **)&deltaSwingTableIdx_TDOWN_A,\n\t\t(u8 **)&deltaSwingTableIdx_TUP_B,\n\t\t(u8 **)&deltaSwingTableIdx_TDOWN_B\n\t);\n\n\t \n\tpDM_Odm->RFCalibrateInfo.TXPowerTrackingCallbackCnt++;\n\tpDM_Odm->RFCalibrateInfo.bTXPowerTrackingInit = true;\n\n\tThermalValue = (u8)PHY_QueryRFReg(pDM_Odm->Adapter, RF_PATH_A, c.ThermalRegAddr, 0xfc00);\t \n\tif (\n\t\t!pDM_Odm->RFCalibrateInfo.TxPowerTrackControl ||\n\t\tpHalData->EEPROMThermalMeter == 0 ||\n\t\tpHalData->EEPROMThermalMeter == 0xFF\n\t)\n\t\treturn;\n\n\t \n\n\t \n\n\tpDM_Odm->RFCalibrateInfo.ThermalValue_AVG[pDM_Odm->RFCalibrateInfo.ThermalValue_AVG_index] = ThermalValue;\n\tpDM_Odm->RFCalibrateInfo.ThermalValue_AVG_index++;\n\tif (pDM_Odm->RFCalibrateInfo.ThermalValue_AVG_index == c.AverageThermalNum)    \n\t\tpDM_Odm->RFCalibrateInfo.ThermalValue_AVG_index = 0;\n\n\tfor (i = 0; i < c.AverageThermalNum; i++) {\n\t\tif (pDM_Odm->RFCalibrateInfo.ThermalValue_AVG[i]) {\n\t\t\tThermalValue_AVG += pDM_Odm->RFCalibrateInfo.ThermalValue_AVG[i];\n\t\t\tThermalValue_AVG_count++;\n\t\t}\n\t}\n\n\t \n\tif (ThermalValue_AVG_count) {\n\t\tThermalValue = (u8)(ThermalValue_AVG / ThermalValue_AVG_count);\n\t}\n\n\t \n\t \n\tdelta =\n\t\t(ThermalValue > pDM_Odm->RFCalibrateInfo.ThermalValue) ?\n\t\t(ThermalValue - pDM_Odm->RFCalibrateInfo.ThermalValue) :\n\t\t(pDM_Odm->RFCalibrateInfo.ThermalValue - ThermalValue);\n\tdelta_LCK =\n\t\t(ThermalValue > pDM_Odm->RFCalibrateInfo.ThermalValue_LCK) ?\n\t\t(ThermalValue - pDM_Odm->RFCalibrateInfo.ThermalValue_LCK) :\n\t\t(pDM_Odm->RFCalibrateInfo.ThermalValue_LCK - ThermalValue);\n\n\t \n\t \n\tif (delta_LCK >= c.Threshold_IQK) {\n\t\tpDM_Odm->RFCalibrateInfo.ThermalValue_LCK = ThermalValue;\n\t\tif (c.PHY_LCCalibrate)\n\t\t\t(*c.PHY_LCCalibrate)(pDM_Odm);\n\t}\n\n\t \n\tif (delta > 0 && pDM_Odm->RFCalibrateInfo.TxPowerTrackControl) {\n\t\t \n\t\tdelta =\n\t\t\tThermalValue > pHalData->EEPROMThermalMeter ?\n\t\t\t(ThermalValue - pHalData->EEPROMThermalMeter) :\n\t\t\t(pHalData->EEPROMThermalMeter - ThermalValue);\n\n\t\tif (delta >= TXPWR_TRACK_TABLE_SIZE)\n\t\t\tdelta = TXPWR_TRACK_TABLE_SIZE - 1;\n\n\t\t \n\t\tif (ThermalValue > pHalData->EEPROMThermalMeter) {\n\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndexLast[RF_PATH_A] =\n\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[RF_PATH_A];\n\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[RF_PATH_A] =\n\t\t\t\tdeltaSwingTableIdx_TUP_A[delta];\n\n\t\t\t \n\t\t\tpDM_Odm->Absolute_OFDMSwingIdx[RF_PATH_A] =\n\t\t\t\tdeltaSwingTableIdx_TUP_A[delta];\n\n\t\t\tif (c.RfPathCount > 1) {\n\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndexLast[RF_PATH_B] =\n\t\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[RF_PATH_B];\n\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[RF_PATH_B] =\n\t\t\t\t\tdeltaSwingTableIdx_TUP_B[delta];\n\n\t\t\t\t \n\t\t\t\tpDM_Odm->Absolute_OFDMSwingIdx[RF_PATH_B] =\n\t\t\t\t\tdeltaSwingTableIdx_TUP_B[delta];\n\t\t\t}\n\n\t\t} else {\n\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndexLast[RF_PATH_A] =\n\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[RF_PATH_A];\n\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[RF_PATH_A] =\n\t\t\t\t-1 * deltaSwingTableIdx_TDOWN_A[delta];\n\n\t\t\t \n\t\t\tpDM_Odm->Absolute_OFDMSwingIdx[RF_PATH_A] =\n\t\t\t\t-1 * deltaSwingTableIdx_TDOWN_A[delta];\n\n\t\t\tif (c.RfPathCount > 1) {\n\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndexLast[RF_PATH_B] =\n\t\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[RF_PATH_B];\n\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[RF_PATH_B] =\n\t\t\t\t\t-1 * deltaSwingTableIdx_TDOWN_B[delta];\n\n\t\t\t\t  \n\t\t\t\tpDM_Odm->Absolute_OFDMSwingIdx[RF_PATH_B] =\n\t\t\t\t\t-1 * deltaSwingTableIdx_TDOWN_B[delta];\n\t\t\t}\n\t\t}\n\n\t\tfor (p = RF_PATH_A; p < c.RfPathCount; p++) {\n\t\t\tif (\n\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndex[p] ==\n\t\t\t\tpDM_Odm->RFCalibrateInfo.DeltaPowerIndexLast[p]\n\t\t\t)  \n\t\t\t\tpDM_Odm->RFCalibrateInfo.PowerIndexOffset[p] = 0;\n\t\t\telse\n\t\t\t\tpDM_Odm->RFCalibrateInfo.PowerIndexOffset[p] = pDM_Odm->RFCalibrateInfo.DeltaPowerIndex[p] - pDM_Odm->RFCalibrateInfo.DeltaPowerIndexLast[p];       \n\n\t\t\tpDM_Odm->RFCalibrateInfo.OFDM_index[p] =\n\t\t\t\tpDM_Odm->BbSwingIdxOfdmBase[p] +\n\t\t\t\tpDM_Odm->RFCalibrateInfo.PowerIndexOffset[p];\n\n\t\t\tpDM_Odm->RFCalibrateInfo.CCK_index =\n\t\t\t\tpDM_Odm->BbSwingIdxCckBase +\n\t\t\t\tpDM_Odm->RFCalibrateInfo.PowerIndexOffset[p];\n\n\t\t\tpDM_Odm->BbSwingIdxCck =\n\t\t\t\tpDM_Odm->RFCalibrateInfo.CCK_index;\n\n\t\t\tpDM_Odm->BbSwingIdxOfdm[p] =\n\t\t\t\tpDM_Odm->RFCalibrateInfo.OFDM_index[p];\n\n\t\t\t \n\t\t\tif (pDM_Odm->RFCalibrateInfo.OFDM_index[p] > c.SwingTableSize_OFDM-1)\n\t\t\t\tpDM_Odm->RFCalibrateInfo.OFDM_index[p] = c.SwingTableSize_OFDM-1;\n\t\t\telse if (pDM_Odm->RFCalibrateInfo.OFDM_index[p] < OFDM_min_index)\n\t\t\t\tpDM_Odm->RFCalibrateInfo.OFDM_index[p] = OFDM_min_index;\n\t\t}\n\t\tif (pDM_Odm->RFCalibrateInfo.CCK_index > c.SwingTableSize_CCK-1)\n\t\t\tpDM_Odm->RFCalibrateInfo.CCK_index = c.SwingTableSize_CCK-1;\n\t\t \n\t\t\t \n\t} else {\n\t\t\tfor (p = RF_PATH_A; p < c.RfPathCount; p++)\n\t\t\t\tpDM_Odm->RFCalibrateInfo.PowerIndexOffset[p] = 0;\n\t}\n\n\t \n\tfor (p = RF_PATH_A; p < c.RfPathCount; p++) {\n\t}\n\n\tif (\n\t\t(pDM_Odm->RFCalibrateInfo.PowerIndexOffset[RF_PATH_A] != 0 ||\n\t\t pDM_Odm->RFCalibrateInfo.PowerIndexOffset[RF_PATH_B] != 0) &&\n\t\t pDM_Odm->RFCalibrateInfo.TxPowerTrackControl\n\t ) {\n\t\t \n\n\t\tpDM_Odm->RFCalibrateInfo.bTxPowerChanged = true;  \n\t\t \n\t\t \n\t\t \n\t\t \n\t\t \n\n\t\tif (ThermalValue > pHalData->EEPROMThermalMeter) {\n\t\t\tfor (p = RF_PATH_A; p < c.RfPathCount; p++)\n\t\t\t\t\t(*c.ODM_TxPwrTrackSetPwr)(pDM_Odm, MIX_MODE, p, 0);\n\t\t} else {\n\t\t\tfor (p = RF_PATH_A; p < c.RfPathCount; p++)\n\t\t\t\t(*c.ODM_TxPwrTrackSetPwr)(pDM_Odm, MIX_MODE, p, Indexforchannel);\n\t\t}\n\n\t\t \n\t\tpDM_Odm->BbSwingIdxCckBase = pDM_Odm->BbSwingIdxCck;\n\t\tfor (p = RF_PATH_A; p < c.RfPathCount; p++)\n\t\t\tpDM_Odm->BbSwingIdxOfdmBase[p] = pDM_Odm->BbSwingIdxOfdm[p];\n\n\t\t \n\t\tpDM_Odm->RFCalibrateInfo.ThermalValue = ThermalValue;\n\t}\n\n\tpDM_Odm->RFCalibrateInfo.TXPowercount = 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}