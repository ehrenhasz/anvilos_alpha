{
  "module_name": "HalBtc8723b1Ant.c",
  "hash_id": "02a404f6cf24b96e28f9b0c6b7310affc690c98e04282ceb9e6036522eab5df6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8723bs/hal/HalBtc8723b1Ant.c",
  "human_readable_source": "\n \n\n#include \"Mp_Precomp.h\"\n\n \nstatic struct coex_dm_8723b_1ant GLCoexDm8723b1Ant;\nstatic struct coex_dm_8723b_1ant *pCoexDm = &GLCoexDm8723b1Ant;\nstatic struct coex_sta_8723b_1ant GLCoexSta8723b1Ant;\nstatic struct coex_sta_8723b_1ant *pCoexSta = &GLCoexSta8723b1Ant;\n\n \n \nstatic u8 halbtc8723b1ant_BtRssiState(\n\tu8 levelNum, u8 rssiThresh, u8 rssiThresh1\n)\n{\n\ts32 btRssi = 0;\n\tu8 btRssiState = pCoexSta->preBtRssiState;\n\n\tbtRssi = pCoexSta->btRssi;\n\n\tif (levelNum == 2) {\n\t\tif (\n\t\t\t(pCoexSta->preBtRssiState == BTC_RSSI_STATE_LOW) ||\n\t\t\t(pCoexSta->preBtRssiState == BTC_RSSI_STATE_STAY_LOW)\n\t\t) {\n\t\t\tif (btRssi >= (rssiThresh + BTC_RSSI_COEX_THRESH_TOL_8723B_1ANT))\n\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_HIGH;\n\t\t\telse\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_STAY_LOW;\n\t\t} else {\n\t\t\tif (btRssi < rssiThresh)\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_LOW;\n\t\t\telse\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_STAY_HIGH;\n\t\t}\n\t} else if (levelNum == 3) {\n\t\tif (rssiThresh > rssiThresh1)\n\t\t\treturn pCoexSta->preBtRssiState;\n\n\t\tif (\n\t\t\t(pCoexSta->preBtRssiState == BTC_RSSI_STATE_LOW) ||\n\t\t\t(pCoexSta->preBtRssiState == BTC_RSSI_STATE_STAY_LOW)\n\t\t) {\n\t\t\tif (btRssi >= (rssiThresh + BTC_RSSI_COEX_THRESH_TOL_8723B_1ANT))\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_MEDIUM;\n\t\t\telse\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_STAY_LOW;\n\t\t} else if (\n\t\t\t(pCoexSta->preBtRssiState == BTC_RSSI_STATE_MEDIUM) ||\n\t\t\t(pCoexSta->preBtRssiState == BTC_RSSI_STATE_STAY_MEDIUM)\n\t\t) {\n\t\t\tif (btRssi >= (rssiThresh1 + BTC_RSSI_COEX_THRESH_TOL_8723B_1ANT))\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_HIGH;\n\t\t\telse if (btRssi < rssiThresh)\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_LOW;\n\t\t\telse\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_STAY_MEDIUM;\n\t\t} else {\n\t\t\tif (btRssi < rssiThresh1)\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_MEDIUM;\n\t\t\telse\n\t\t\t\tbtRssiState = BTC_RSSI_STATE_STAY_HIGH;\n\t\t}\n\t}\n\n\tpCoexSta->preBtRssiState = btRssiState;\n\n\treturn btRssiState;\n}\n\nstatic void halbtc8723b1ant_UpdateRaMask(\n\tstruct btc_coexist *pBtCoexist, bool bForceExec, u32 disRateMask\n)\n{\n\tpCoexDm->curRaMask = disRateMask;\n\n\tif (bForceExec || (pCoexDm->preRaMask != pCoexDm->curRaMask))\n\t\tpBtCoexist->fBtcSet(\n\t\t\tpBtCoexist,\n\t\t\tBTC_SET_ACT_UPDATE_RAMASK,\n\t\t\t&pCoexDm->curRaMask\n\t\t);\n\tpCoexDm->preRaMask = pCoexDm->curRaMask;\n}\n\nstatic void halbtc8723b1ant_AutoRateFallbackRetry(\n\tstruct btc_coexist *pBtCoexist, bool bForceExec, u8 type\n)\n{\n\tbool bWifiUnderBMode = false;\n\n\tpCoexDm->curArfrType = type;\n\n\tif (bForceExec || (pCoexDm->preArfrType != pCoexDm->curArfrType)) {\n\t\tswitch (pCoexDm->curArfrType) {\n\t\tcase 0:\t \n\t\t\tpBtCoexist->fBtcWrite4Byte(\n\t\t\t\tpBtCoexist, 0x430, pCoexDm->backupArfrCnt1\n\t\t\t);\n\t\t\tpBtCoexist->fBtcWrite4Byte(\n\t\t\t\tpBtCoexist, 0x434, pCoexDm->backupArfrCnt2\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tpBtCoexist->fBtcGet(\n\t\t\t\tpBtCoexist, BTC_GET_BL_WIFI_UNDER_B_MODE, &bWifiUnderBMode\n\t\t\t);\n\t\t\tif (bWifiUnderBMode) {\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x430, 0x0);\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x434, 0x01010101);\n\t\t\t} else {\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x430, 0x0);\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x434, 0x04030201);\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tpCoexDm->preArfrType = pCoexDm->curArfrType;\n}\n\nstatic void halbtc8723b1ant_RetryLimit(\n\tstruct btc_coexist *pBtCoexist, bool bForceExec, u8 type\n)\n{\n\tpCoexDm->curRetryLimitType = type;\n\n\tif (\n\t\tbForceExec ||\n\t\t(pCoexDm->preRetryLimitType != pCoexDm->curRetryLimitType)\n\t) {\n\t\tswitch (pCoexDm->curRetryLimitType) {\n\t\tcase 0:\t \n\t\t\tpBtCoexist->fBtcWrite2Byte(\n\t\t\t\tpBtCoexist, 0x42a, pCoexDm->backupRetryLimit\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 1:\t \n\t\t\tpBtCoexist->fBtcWrite2Byte(pBtCoexist, 0x42a, 0x0808);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tpCoexDm->preRetryLimitType = pCoexDm->curRetryLimitType;\n}\n\nstatic void halbtc8723b1ant_AmpduMaxTime(\n\tstruct btc_coexist *pBtCoexist, bool bForceExec, u8 type\n)\n{\n\tpCoexDm->curAmpduTimeType = type;\n\n\tif (\n\t\tbForceExec || (pCoexDm->preAmpduTimeType != pCoexDm->curAmpduTimeType)\n\t) {\n\t\tswitch (pCoexDm->curAmpduTimeType) {\n\t\tcase 0:\t \n\t\t\tpBtCoexist->fBtcWrite1Byte(\n\t\t\t\tpBtCoexist, 0x456, pCoexDm->backupAmpduMaxTime\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 1:\t \n\t\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x456, 0x38);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tpCoexDm->preAmpduTimeType = pCoexDm->curAmpduTimeType;\n}\n\nstatic void halbtc8723b1ant_LimitedTx(\n\tstruct btc_coexist *pBtCoexist,\n\tbool bForceExec,\n\tu8 raMaskType,\n\tu8 arfrType,\n\tu8 retryLimitType,\n\tu8 ampduTimeType\n)\n{\n\tswitch (raMaskType) {\n\tcase 0:\t \n\t\thalbtc8723b1ant_UpdateRaMask(pBtCoexist, bForceExec, 0x0);\n\t\tbreak;\n\tcase 1:\t \n\t\thalbtc8723b1ant_UpdateRaMask(pBtCoexist, bForceExec, 0x00000003);\n\t\tbreak;\n\tcase 2:\t \n\t\thalbtc8723b1ant_UpdateRaMask(pBtCoexist, bForceExec, 0x0001f1f7);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\thalbtc8723b1ant_AutoRateFallbackRetry(pBtCoexist, bForceExec, arfrType);\n\thalbtc8723b1ant_RetryLimit(pBtCoexist, bForceExec, retryLimitType);\n\thalbtc8723b1ant_AmpduMaxTime(pBtCoexist, bForceExec, ampduTimeType);\n}\n\nstatic void halbtc8723b1ant_LimitedRx(\n\tstruct btc_coexist *pBtCoexist,\n\tbool bForceExec,\n\tbool bRejApAggPkt,\n\tbool bBtCtrlAggBufSize,\n\tu8 aggBufSize\n)\n{\n\tbool bRejectRxAgg = bRejApAggPkt;\n\tbool bBtCtrlRxAggSize = bBtCtrlAggBufSize;\n\tu8 rxAggSize = aggBufSize;\n\n\t \n\t \n\t \n\tpBtCoexist->fBtcSet(\n\t\tpBtCoexist, BTC_SET_BL_TO_REJ_AP_AGG_PKT, &bRejectRxAgg\n\t);\n\t \n\tpBtCoexist->fBtcSet(\n\t\tpBtCoexist, BTC_SET_BL_BT_CTRL_AGG_SIZE, &bBtCtrlRxAggSize\n\t);\n\t \n\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_U1_AGG_BUF_SIZE, &rxAggSize);\n\t \n\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_ACT_AGGREGATE_CTRL, NULL);\n\n\n}\n\nstatic void halbtc8723b1ant_QueryBtInfo(struct btc_coexist *pBtCoexist)\n{\n\tu8 H2C_Parameter[1] = {0};\n\n\tpCoexSta->bC2hBtInfoReqSent = true;\n\n\tH2C_Parameter[0] |= BIT0;\t \n\n\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x61, 1, H2C_Parameter);\n}\n\nstatic void halbtc8723b1ant_MonitorBtCtr(struct btc_coexist *pBtCoexist)\n{\n\tu32 regHPTxRx, regLPTxRx, u4Tmp;\n\tu32 regHPTx = 0, regHPRx = 0, regLPTx = 0, regLPRx = 0;\n\tstatic u8 NumOfBtCounterChk;\n\n        \n\t \n\n\tif (pCoexSta->bUnderIps) {\n\t\tpCoexSta->highPriorityTx = 65535;\n\t\tpCoexSta->highPriorityRx = 65535;\n\t\tpCoexSta->lowPriorityTx = 65535;\n\t\tpCoexSta->lowPriorityRx = 65535;\n\t\treturn;\n\t}\n\n\tregHPTxRx = 0x770;\n\tregLPTxRx = 0x774;\n\n\tu4Tmp = pBtCoexist->fBtcRead4Byte(pBtCoexist, regHPTxRx);\n\tregHPTx = u4Tmp & bMaskLWord;\n\tregHPRx = (u4Tmp & bMaskHWord) >> 16;\n\n\tu4Tmp = pBtCoexist->fBtcRead4Byte(pBtCoexist, regLPTxRx);\n\tregLPTx = u4Tmp & bMaskLWord;\n\tregLPRx = (u4Tmp & bMaskHWord) >> 16;\n\n\tpCoexSta->highPriorityTx = regHPTx;\n\tpCoexSta->highPriorityRx = regHPRx;\n\tpCoexSta->lowPriorityTx = regLPTx;\n\tpCoexSta->lowPriorityRx = regLPRx;\n\n\tif ((pCoexSta->lowPriorityTx >= 1050) && (!pCoexSta->bC2hBtInquiryPage))\n\t\tpCoexSta->popEventCnt++;\n\n\t \n\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x76e, 0xc);\n\n\tif ((regHPTx == 0) && (regHPRx == 0) && (regLPTx == 0) && (regLPRx == 0)) {\n\t\tNumOfBtCounterChk++;\n\t\tif (NumOfBtCounterChk >= 3) {\n\t\t\thalbtc8723b1ant_QueryBtInfo(pBtCoexist);\n\t\t\tNumOfBtCounterChk = 0;\n\t\t}\n\t}\n}\n\n\nstatic void halbtc8723b1ant_MonitorWiFiCtr(struct btc_coexist *pBtCoexist)\n{\n\ts32\twifiRssi = 0;\n\tbool bWifiBusy = false, bWifiUnderBMode = false;\n\tstatic u8 nCCKLockCounter;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_S4_WIFI_RSSI, &wifiRssi);\n\tpBtCoexist->fBtcGet(\n\t\tpBtCoexist, BTC_GET_BL_WIFI_UNDER_B_MODE, &bWifiUnderBMode\n\t);\n\n\tif (pCoexSta->bUnderIps) {\n\t\tpCoexSta->nCRCOK_CCK = 0;\n\t\tpCoexSta->nCRCOK_11g = 0;\n\t\tpCoexSta->nCRCOK_11n = 0;\n\t\tpCoexSta->nCRCOK_11nAgg = 0;\n\n\t\tpCoexSta->nCRCErr_CCK = 0;\n\t\tpCoexSta->nCRCErr_11g = 0;\n\t\tpCoexSta->nCRCErr_11n = 0;\n\t\tpCoexSta->nCRCErr_11nAgg = 0;\n\t} else {\n\t\tpCoexSta->nCRCOK_CCK\t= pBtCoexist->fBtcRead4Byte(pBtCoexist, 0xf88);\n\t\tpCoexSta->nCRCOK_11g\t= pBtCoexist->fBtcRead2Byte(pBtCoexist, 0xf94);\n\t\tpCoexSta->nCRCOK_11n\t= pBtCoexist->fBtcRead2Byte(pBtCoexist, 0xf90);\n\t\tpCoexSta->nCRCOK_11nAgg = pBtCoexist->fBtcRead2Byte(pBtCoexist, 0xfb8);\n\n\t\tpCoexSta->nCRCErr_CCK\t = pBtCoexist->fBtcRead4Byte(pBtCoexist, 0xf84);\n\t\tpCoexSta->nCRCErr_11g\t = pBtCoexist->fBtcRead2Byte(pBtCoexist, 0xf96);\n\t\tpCoexSta->nCRCErr_11n\t = pBtCoexist->fBtcRead2Byte(pBtCoexist, 0xf92);\n\t\tpCoexSta->nCRCErr_11nAgg = pBtCoexist->fBtcRead2Byte(pBtCoexist, 0xfba);\n\t}\n\n\n\t \n\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0xf16, 0x1, 0x1);\n\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0xf16, 0x1, 0x0);\n\n\tif (bWifiBusy && (wifiRssi >= 30) && !bWifiUnderBMode) {\n\t\tif (\n\t\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) ||\n\t\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY) ||\n\t\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_SCO_BUSY)\n\t\t) {\n\t\t\tif (\n\t\t\t\tpCoexSta->nCRCOK_CCK > (\n\t\t\t\t\tpCoexSta->nCRCOK_11g +\n\t\t\t\t\tpCoexSta->nCRCOK_11n +\n\t\t\t\t\tpCoexSta->nCRCOK_11nAgg\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tif (nCCKLockCounter < 5)\n\t\t\t\t\tnCCKLockCounter++;\n\t\t\t} else {\n\t\t\t\tif (nCCKLockCounter > 0)\n\t\t\t\t\tnCCKLockCounter--;\n\t\t\t}\n\n\t\t} else {\n\t\t\tif (nCCKLockCounter > 0)\n\t\t\t\tnCCKLockCounter--;\n\t\t}\n\t} else {\n\t\tif (nCCKLockCounter > 0)\n\t\t\tnCCKLockCounter--;\n\t}\n\n\tif (!pCoexSta->bPreCCKLock) {\n\n\t\tif (nCCKLockCounter >= 5)\n\t\t\tpCoexSta->bCCKLock = true;\n\t\telse\n\t\t\tpCoexSta->bCCKLock = false;\n\t} else {\n\t\tif (nCCKLockCounter == 0)\n\t\t\tpCoexSta->bCCKLock = false;\n\t\telse\n\t\t\tpCoexSta->bCCKLock = true;\n\t}\n\n\tpCoexSta->bPreCCKLock =  pCoexSta->bCCKLock;\n\n\n}\n\nstatic bool halbtc8723b1ant_IsWifiStatusChanged(struct btc_coexist *pBtCoexist)\n{\n\tstatic bool\tbPreWifiBusy, bPreUnder4way, bPreBtHsOn;\n\tbool bWifiBusy = false, bUnder4way = false, bBtHsOn = false;\n\tbool bWifiConnected = false;\n\n\tpBtCoexist->fBtcGet(\n\t\tpBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected\n\t);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\n\tpBtCoexist->fBtcGet(\n\t\tpBtCoexist, BTC_GET_BL_WIFI_4_WAY_PROGRESS, &bUnder4way\n\t);\n\n\tif (bWifiConnected) {\n\t\tif (bWifiBusy != bPreWifiBusy) {\n\t\t\tbPreWifiBusy = bWifiBusy;\n\t\t\treturn true;\n\t\t}\n\n\t\tif (bUnder4way != bPreUnder4way) {\n\t\t\tbPreUnder4way = bUnder4way;\n\t\t\treturn true;\n\t\t}\n\n\t\tif (bBtHsOn != bPreBtHsOn) {\n\t\t\tbPreBtHsOn = bBtHsOn;\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\nstatic void halbtc8723b1ant_UpdateBtLinkInfo(struct btc_coexist *pBtCoexist)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\tbool bBtHsOn = false;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\n\n\tpBtLinkInfo->bBtLinkExist = pCoexSta->bBtLinkExist;\n\tpBtLinkInfo->bScoExist = pCoexSta->bScoExist;\n\tpBtLinkInfo->bA2dpExist = pCoexSta->bA2dpExist;\n\tpBtLinkInfo->bPanExist = pCoexSta->bPanExist;\n\tpBtLinkInfo->bHidExist = pCoexSta->bHidExist;\n\n\t \n\tif (bBtHsOn) {\n\t\tpBtLinkInfo->bPanExist = true;\n\t\tpBtLinkInfo->bBtLinkExist = true;\n\t}\n\n\t \n\tif (\n\t\tpBtLinkInfo->bScoExist &&\n\t\t!pBtLinkInfo->bA2dpExist &&\n\t\t!pBtLinkInfo->bPanExist &&\n\t\t!pBtLinkInfo->bHidExist\n\t)\n\t\tpBtLinkInfo->bScoOnly = true;\n\telse\n\t\tpBtLinkInfo->bScoOnly = false;\n\n\t \n\tif (\n\t\t!pBtLinkInfo->bScoExist &&\n\t\tpBtLinkInfo->bA2dpExist &&\n\t\t!pBtLinkInfo->bPanExist &&\n\t\t!pBtLinkInfo->bHidExist\n\t)\n\t\tpBtLinkInfo->bA2dpOnly = true;\n\telse\n\t\tpBtLinkInfo->bA2dpOnly = false;\n\n\t \n\tif (\n\t\t!pBtLinkInfo->bScoExist &&\n\t\t!pBtLinkInfo->bA2dpExist &&\n\t\tpBtLinkInfo->bPanExist &&\n\t\t!pBtLinkInfo->bHidExist\n\t)\n\t\tpBtLinkInfo->bPanOnly = true;\n\telse\n\t\tpBtLinkInfo->bPanOnly = false;\n\n\t \n\tif (\n\t\t!pBtLinkInfo->bScoExist &&\n\t\t!pBtLinkInfo->bA2dpExist &&\n\t\t!pBtLinkInfo->bPanExist &&\n\t\tpBtLinkInfo->bHidExist\n\t)\n\t\tpBtLinkInfo->bHidOnly = true;\n\telse\n\t\tpBtLinkInfo->bHidOnly = false;\n}\n\nstatic u8 halbtc8723b1ant_ActionAlgorithm(struct btc_coexist *pBtCoexist)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\tbool bBtHsOn = false;\n\tu8 algorithm = BT_8723B_1ANT_COEX_ALGO_UNDEFINED;\n\tu8 numOfDiffProfile = 0;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\n\n\tif (!pBtLinkInfo->bBtLinkExist)\n\t\treturn algorithm;\n\n\tif (pBtLinkInfo->bScoExist)\n\t\tnumOfDiffProfile++;\n\tif (pBtLinkInfo->bHidExist)\n\t\tnumOfDiffProfile++;\n\tif (pBtLinkInfo->bPanExist)\n\t\tnumOfDiffProfile++;\n\tif (pBtLinkInfo->bA2dpExist)\n\t\tnumOfDiffProfile++;\n\n\tif (numOfDiffProfile == 1) {\n\t\tif (pBtLinkInfo->bScoExist) {\n\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_SCO;\n\t\t} else {\n\t\t\tif (pBtLinkInfo->bHidExist) {\n\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_HID;\n\t\t\t} else if (pBtLinkInfo->bA2dpExist) {\n\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_A2DP;\n\t\t\t} else if (pBtLinkInfo->bPanExist) {\n\t\t\t\tif (bBtHsOn)\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_PANHS;\n\t\t\t\telse\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_PANEDR;\n\t\t\t}\n\t\t}\n\t} else if (numOfDiffProfile == 2) {\n\t\tif (pBtLinkInfo->bScoExist) {\n\t\t\tif (pBtLinkInfo->bHidExist) {\n\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_HID;\n\t\t\t} else if (pBtLinkInfo->bA2dpExist) {\n\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_SCO;\n\t\t\t} else if (pBtLinkInfo->bPanExist) {\n\t\t\t\tif (bBtHsOn)\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_SCO;\n\t\t\t\telse\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_PANEDR_HID;\n\t\t\t}\n\t\t} else {\n\t\t\tif (pBtLinkInfo->bHidExist && pBtLinkInfo->bA2dpExist) {\n\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_HID_A2DP;\n\t\t\t} else if (pBtLinkInfo->bHidExist && pBtLinkInfo->bPanExist) {\n\t\t\t\tif (bBtHsOn)\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_HID_A2DP;\n\t\t\t\telse\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_PANEDR_HID;\n\t\t\t} else if (pBtLinkInfo->bPanExist && pBtLinkInfo->bA2dpExist) {\n\t\t\t\tif (bBtHsOn)\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_A2DP_PANHS;\n\t\t\t\telse\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_PANEDR_A2DP;\n\t\t\t}\n\t\t}\n\t} else if (numOfDiffProfile == 3) {\n\t\tif (pBtLinkInfo->bScoExist) {\n\t\t\tif (pBtLinkInfo->bHidExist && pBtLinkInfo->bA2dpExist) {\n\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_HID;\n\t\t\t} else if (\n\t\t\t\tpBtLinkInfo->bHidExist && pBtLinkInfo->bPanExist\n\t\t\t) {\n\t\t\t\tif (bBtHsOn)\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_HID_A2DP;\n\t\t\t\telse\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_PANEDR_HID;\n\t\t\t} else if (pBtLinkInfo->bPanExist && pBtLinkInfo->bA2dpExist) {\n\t\t\t\tif (bBtHsOn)\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_SCO;\n\t\t\t\telse\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_PANEDR_HID;\n\t\t\t}\n\t\t} else {\n\t\t\tif (\n\t\t\t\tpBtLinkInfo->bHidExist &&\n\t\t\t\tpBtLinkInfo->bPanExist &&\n\t\t\t\tpBtLinkInfo->bA2dpExist\n\t\t\t) {\n\t\t\t\tif (bBtHsOn)\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_HID_A2DP;\n\t\t\t\telse\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_HID_A2DP_PANEDR;\n\t\t\t}\n\t\t}\n\t} else if (numOfDiffProfile >= 3) {\n\t\tif (pBtLinkInfo->bScoExist) {\n\t\t\tif (\n\t\t\t\tpBtLinkInfo->bHidExist &&\n\t\t\t\tpBtLinkInfo->bPanExist &&\n\t\t\t\tpBtLinkInfo->bA2dpExist\n\t\t\t) {\n\t\t\t\tif (!bBtHsOn)\n\t\t\t\t\talgorithm = BT_8723B_1ANT_COEX_ALGO_PANEDR_HID;\n\n\t\t\t}\n\t\t}\n\t}\n\n\treturn algorithm;\n}\n\nstatic void halbtc8723b1ant_SetSwPenaltyTxRateAdaptive(\n\tstruct btc_coexist *pBtCoexist, bool bLowPenaltyRa\n)\n{\n\tu8 H2C_Parameter[6] = {0};\n\n\tH2C_Parameter[0] = 0x6;\t \n\n\tif (bLowPenaltyRa) {\n\t\tH2C_Parameter[1] |= BIT0;\n\t\tH2C_Parameter[2] = 0x00;   \n\t\tH2C_Parameter[3] = 0xf7;   \n\t\tH2C_Parameter[4] = 0xf8;   \n\t\tH2C_Parameter[5] = 0xf9;\t \n\t}\n\n\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x69, 6, H2C_Parameter);\n}\n\nstatic void halbtc8723b1ant_LowPenaltyRa(\n\tstruct btc_coexist *pBtCoexist, bool bForceExec, bool bLowPenaltyRa\n)\n{\n\tpCoexDm->bCurLowPenaltyRa = bLowPenaltyRa;\n\n\tif (!bForceExec) {\n\t\tif (pCoexDm->bPreLowPenaltyRa == pCoexDm->bCurLowPenaltyRa)\n\t\t\treturn;\n\t}\n\thalbtc8723b1ant_SetSwPenaltyTxRateAdaptive(\n\t\tpBtCoexist, pCoexDm->bCurLowPenaltyRa\n\t);\n\n\tpCoexDm->bPreLowPenaltyRa = pCoexDm->bCurLowPenaltyRa;\n}\n\nstatic void halbtc8723b1ant_SetCoexTable(\n\tstruct btc_coexist *pBtCoexist,\n\tu32 val0x6c0,\n\tu32 val0x6c4,\n\tu32 val0x6c8,\n\tu8 val0x6cc\n)\n{\n\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x6c0, val0x6c0);\n\n\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x6c4, val0x6c4);\n\n\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x6c8, val0x6c8);\n\n\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x6cc, val0x6cc);\n}\n\nstatic void halbtc8723b1ant_CoexTable(\n\tstruct btc_coexist *pBtCoexist,\n\tbool bForceExec,\n\tu32 val0x6c0,\n\tu32 val0x6c4,\n\tu32 val0x6c8,\n\tu8 val0x6cc\n)\n{\n\tpCoexDm->curVal0x6c0 = val0x6c0;\n\tpCoexDm->curVal0x6c4 = val0x6c4;\n\tpCoexDm->curVal0x6c8 = val0x6c8;\n\tpCoexDm->curVal0x6cc = val0x6cc;\n\n\tif (!bForceExec) {\n\t\tif (\n\t\t\t(pCoexDm->preVal0x6c0 == pCoexDm->curVal0x6c0) &&\n\t\t    (pCoexDm->preVal0x6c4 == pCoexDm->curVal0x6c4) &&\n\t\t    (pCoexDm->preVal0x6c8 == pCoexDm->curVal0x6c8) &&\n\t\t    (pCoexDm->preVal0x6cc == pCoexDm->curVal0x6cc)\n\t\t)\n\t\t\treturn;\n\t}\n\n\thalbtc8723b1ant_SetCoexTable(\n\t\tpBtCoexist, val0x6c0, val0x6c4, val0x6c8, val0x6cc\n\t);\n\n\tpCoexDm->preVal0x6c0 = pCoexDm->curVal0x6c0;\n\tpCoexDm->preVal0x6c4 = pCoexDm->curVal0x6c4;\n\tpCoexDm->preVal0x6c8 = pCoexDm->curVal0x6c8;\n\tpCoexDm->preVal0x6cc = pCoexDm->curVal0x6cc;\n}\n\nstatic void halbtc8723b1ant_CoexTableWithType(\n\tstruct btc_coexist *pBtCoexist, bool bForceExec, u8 type\n)\n{\n\tpCoexSta->nCoexTableType = type;\n\n\tswitch (type) {\n\tcase 0:\n\t\thalbtc8723b1ant_CoexTable(\n\t\t\tpBtCoexist, bForceExec, 0x55555555, 0x55555555, 0xffffff, 0x3\n\t\t);\n\t\tbreak;\n\tcase 1:\n\t\thalbtc8723b1ant_CoexTable(\n\t\t\tpBtCoexist, bForceExec, 0x55555555, 0x5a5a5a5a, 0xffffff, 0x3\n\t\t);\n\t\tbreak;\n\tcase 2:\n\t\thalbtc8723b1ant_CoexTable(\n\t\t\tpBtCoexist, bForceExec, 0x5a5a5a5a, 0x5a5a5a5a, 0xffffff, 0x3\n\t\t);\n\t\tbreak;\n\tcase 3:\n\t\thalbtc8723b1ant_CoexTable(\n\t\t\tpBtCoexist, bForceExec, 0xaaaa5555, 0xaaaa5a5a, 0xffffff, 0x3\n\t\t);\n\t\tbreak;\n\tcase 4:\n\t\thalbtc8723b1ant_CoexTable(\n\t\t\tpBtCoexist, bForceExec, 0x55555555, 0xaaaa5a5a, 0xffffff, 0x3\n\t\t);\n\t\tbreak;\n\tcase 5:\n\t\thalbtc8723b1ant_CoexTable(\n\t\t\tpBtCoexist, bForceExec, 0x5a5a5a5a, 0xaaaa5a5a, 0xffffff, 0x3\n\t\t);\n\t\tbreak;\n\tcase 6:\n\t\thalbtc8723b1ant_CoexTable(\n\t\t\tpBtCoexist, bForceExec, 0x55555555, 0xaaaaaaaa, 0xffffff, 0x3\n\t\t);\n\t\tbreak;\n\tcase 7:\n\t\thalbtc8723b1ant_CoexTable(\n\t\t\tpBtCoexist, bForceExec, 0xaaaaaaaa, 0xaaaaaaaa, 0xffffff, 0x3\n\t\t);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void halbtc8723b1ant_SetFwIgnoreWlanAct(\n\tstruct btc_coexist *pBtCoexist, bool bEnable\n)\n{\n\tu8 H2C_Parameter[1] = {0};\n\n\tif (bEnable)\n\t\tH2C_Parameter[0] |= BIT0;  \n\n\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x63, 1, H2C_Parameter);\n}\n\nstatic void halbtc8723b1ant_IgnoreWlanAct(\n\tstruct btc_coexist *pBtCoexist, bool bForceExec, bool bEnable\n)\n{\n\tpCoexDm->bCurIgnoreWlanAct = bEnable;\n\n\tif (!bForceExec) {\n\t\tif (pCoexDm->bPreIgnoreWlanAct == pCoexDm->bCurIgnoreWlanAct)\n\t\t\treturn;\n\t}\n\thalbtc8723b1ant_SetFwIgnoreWlanAct(pBtCoexist, bEnable);\n\n\tpCoexDm->bPreIgnoreWlanAct = pCoexDm->bCurIgnoreWlanAct;\n}\n\nstatic void halbtc8723b1ant_SetLpsRpwm(\n\tstruct btc_coexist *pBtCoexist, u8 lpsVal, u8 rpwmVal\n)\n{\n\tu8 lps = lpsVal;\n\tu8 rpwm = rpwmVal;\n\n\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_U1_LPS_VAL, &lps);\n\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_U1_RPWM_VAL, &rpwm);\n}\n\nstatic void halbtc8723b1ant_LpsRpwm(\n\tstruct btc_coexist *pBtCoexist, bool bForceExec, u8 lpsVal, u8 rpwmVal\n)\n{\n\tpCoexDm->curLps = lpsVal;\n\tpCoexDm->curRpwm = rpwmVal;\n\n\tif (!bForceExec) {\n\t\tif (\n\t\t\t(pCoexDm->preLps == pCoexDm->curLps) &&\n\t\t\t(pCoexDm->preRpwm == pCoexDm->curRpwm)\n\t\t) {\n\t\t\treturn;\n\t\t}\n\t}\n\thalbtc8723b1ant_SetLpsRpwm(pBtCoexist, lpsVal, rpwmVal);\n\n\tpCoexDm->preLps = pCoexDm->curLps;\n\tpCoexDm->preRpwm = pCoexDm->curRpwm;\n}\n\nstatic void halbtc8723b1ant_SwMechanism(\n\tstruct btc_coexist *pBtCoexist, bool bLowPenaltyRA\n)\n{\n\thalbtc8723b1ant_LowPenaltyRa(pBtCoexist, NORMAL_EXEC, bLowPenaltyRA);\n}\n\nstatic void halbtc8723b1ant_SetAntPath(\n\tstruct btc_coexist *pBtCoexist, u8 antPosType, bool bInitHwCfg, bool bWifiOff\n)\n{\n\tstruct btc_board_info *pBoardInfo = &pBtCoexist->boardInfo;\n\tu32 fwVer = 0, u4Tmp = 0, cntBtCalChk = 0;\n\tbool bPgExtSwitch = false;\n\tbool bUseExtSwitch = false;\n\tbool bIsInMpMode = false;\n\tu8 H2C_Parameter[2] = {0}, u1Tmp = 0;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_EXT_SWITCH, &bPgExtSwitch);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_U4_WIFI_FW_VER, &fwVer);  \n\n\tif ((fwVer > 0 && fwVer < 0xc0000) || bPgExtSwitch)\n\t\tbUseExtSwitch = true;\n\n\tif (bInitHwCfg) {\n\t\tpBtCoexist->fBtcSetRfReg(pBtCoexist, BTC_RF_A, 0x1, 0xfffff, 0x780);  \n\t\tpBtCoexist->fBtcSetBtReg(pBtCoexist, BTC_BT_REG_RF, 0x3c, 0x15);  \n\n\t\tif (fwVer >= 0x180000) {\n\t\t\t \n\t\t\tH2C_Parameter[0] = 1;\n\t\t\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x6E, 1, H2C_Parameter);\n\t\t} else  \n\t\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x765, 0x18);\n\n\t\t \n\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x76e, 0x4);\n\n\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x67, 0x20, 0x1);  \n\n\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x39, 0x8, 0x1);\n\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x974, 0xff);\n\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x944, 0x3, 0x3);\n\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x930, 0x77);\n\t} else if (bWifiOff) {\n\t\tif (fwVer >= 0x180000) {\n\t\t\t \n\t\t\tH2C_Parameter[0] = 1;\n\t\t\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x6E, 1, H2C_Parameter);\n\t\t} else  \n\t\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x765, 0x18);\n\n\t\t \n\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x76e, 0x4);\n\n\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_IS_IN_MP_MODE, &bIsInMpMode);\n\t\tif (!bIsInMpMode)\n\t\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x67, 0x20, 0x0);  \n\t\telse\n\t\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x67, 0x20, 0x1);  \n\n\t\t \n\t\tu4Tmp = pBtCoexist->fBtcRead4Byte(pBtCoexist, 0x4c);\n\t\tu4Tmp &= ~BIT23;\n\t\tu4Tmp &= ~BIT24;\n\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x4c, u4Tmp);\n\t} else {\n\t\t \n\t\tif (fwVer >= 0x180000) {\n\t\t\tif (pBtCoexist->fBtcRead1Byte(pBtCoexist, 0x765) != 0) {\n\t\t\t\tH2C_Parameter[0] = 0;\n\t\t\t\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x6E, 1, H2C_Parameter);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\twhile (cntBtCalChk <= 20) {\n\t\t\t\tu1Tmp = pBtCoexist->fBtcRead1Byte(pBtCoexist, 0x49d);\n\t\t\t\tcntBtCalChk++;\n\n\t\t\t\tif (u1Tmp & BIT0)\n\t\t\t\t\tmdelay(50);\n\t\t\t\telse\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t \n\t\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x765, 0x0);\n\t\t}\n\n\t\tif (pBtCoexist->fBtcRead1Byte(pBtCoexist, 0x76e) != 0xc)\n\t\t\t \n\t\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x76e, 0xc);\n\t}\n\n\tif (bUseExtSwitch) {\n\t\tif (bInitHwCfg) {\n\t\t\t \n\t\t\tu4Tmp = pBtCoexist->fBtcRead4Byte(pBtCoexist, 0x4c);\n\t\t\tu4Tmp &= ~BIT23;\n\t\t\tu4Tmp |= BIT24;\n\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x4c, u4Tmp);\n\n\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x0);  \n\n\t\t\tif (pBoardInfo->btdmAntPos == BTC_ANTENNA_AT_MAIN_PORT) {\n\t\t\t\t \n\t\t\t\tH2C_Parameter[0] = 0;\n\t\t\t\tH2C_Parameter[1] = 1;   \n\t\t\t\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x65, 2, H2C_Parameter);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tH2C_Parameter[0] = 1;\n\t\t\t\tH2C_Parameter[1] = 1;   \n\t\t\t\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x65, 2, H2C_Parameter);\n\t\t\t}\n\t\t}\n\n\n\t\t \n\t\tswitch (antPosType) {\n\t\tcase BTC_ANT_PATH_WIFI:\n\t\t\tif (pBoardInfo->btdmAntPos == BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x92c, 0x3, 0x1);\n\t\t\telse\n\t\t\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x92c, 0x3, 0x2);\n\t\t\tbreak;\n\t\tcase BTC_ANT_PATH_BT:\n\t\t\tif (pBoardInfo->btdmAntPos == BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x92c, 0x3, 0x2);\n\t\t\telse\n\t\t\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x92c, 0x3, 0x1);\n\t\t\tbreak;\n\t\tdefault:\n\t\tcase BTC_ANT_PATH_PTA:\n\t\t\tif (pBoardInfo->btdmAntPos == BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x92c, 0x3, 0x1);\n\t\t\telse\n\t\t\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x92c, 0x3, 0x2);\n\t\t\tbreak;\n\t\t}\n\n\t} else {\n\t\tif (bInitHwCfg) {\n\t\t\t \n\t\t\tu4Tmp = pBtCoexist->fBtcRead4Byte(pBtCoexist, 0x4c);\n\t\t\tu4Tmp |= BIT23;\n\t\t\tu4Tmp &= ~BIT24;\n\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x4c, u4Tmp);\n\n\t\t\t \n\t\t\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x64, 0x1, 0x0);\n\n\t\t\tif (pBoardInfo->btdmAntPos == BTC_ANTENNA_AT_MAIN_PORT) {\n\n\t\t\t\t \n\t\t\t\tH2C_Parameter[0] = 0;\n\t\t\t\tH2C_Parameter[1] = 0;   \n\t\t\t\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x65, 2, H2C_Parameter);\n\t\t\t} else {\n\n\t\t\t\t \n\t\t\t\tH2C_Parameter[0] = 1;\n\t\t\t\tH2C_Parameter[1] = 0;   \n\t\t\t\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x65, 2, H2C_Parameter);\n\t\t\t}\n\t\t}\n\n\n\t\t \n\t\tswitch (antPosType) {\n\t\tcase BTC_ANT_PATH_WIFI:\n\t\t\tif (pBoardInfo->btdmAntPos == BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x0);\n\t\t\telse\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x280);\n\t\t\tbreak;\n\t\tcase BTC_ANT_PATH_BT:\n\t\t\tif (pBoardInfo->btdmAntPos == BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x280);\n\t\t\telse\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x0);\n\t\t\tbreak;\n\t\tdefault:\n\t\tcase BTC_ANT_PATH_PTA:\n\t\t\tif (pBoardInfo->btdmAntPos == BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x200);\n\t\t\telse\n\t\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x80);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic void halbtc8723b1ant_SetFwPstdma(\n\tstruct btc_coexist *pBtCoexist, u8 byte1, u8 byte2, u8 byte3, u8 byte4, u8 byte5\n)\n{\n\tu8 H2C_Parameter[5] = {0};\n\tu8 realByte1 = byte1, realByte5 = byte5;\n\tbool bApEnable = false;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_AP_MODE_ENABLE, &bApEnable);\n\n\tif (bApEnable) {\n\t\tif (byte1 & BIT4 && !(byte1 & BIT5)) {\n\t\t\trealByte1 &= ~BIT4;\n\t\t\trealByte1 |= BIT5;\n\n\t\t\trealByte5 |= BIT5;\n\t\t\trealByte5 &= ~BIT6;\n\t\t}\n\t}\n\n\tH2C_Parameter[0] = realByte1;\n\tH2C_Parameter[1] = byte2;\n\tH2C_Parameter[2] = byte3;\n\tH2C_Parameter[3] = byte4;\n\tH2C_Parameter[4] = realByte5;\n\n\tpCoexDm->psTdmaPara[0] = realByte1;\n\tpCoexDm->psTdmaPara[1] = byte2;\n\tpCoexDm->psTdmaPara[2] = byte3;\n\tpCoexDm->psTdmaPara[3] = byte4;\n\tpCoexDm->psTdmaPara[4] = realByte5;\n\n\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x60, 5, H2C_Parameter);\n}\n\n\nstatic void halbtc8723b1ant_PsTdma(\n\tstruct btc_coexist *pBtCoexist, bool bForceExec, bool bTurnOn, u8 type\n)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\tbool bWifiBusy = false;\n\tu8 rssiAdjustVal = 0;\n\tu8 psTdmaByte4Val = 0x50, psTdmaByte0Val = 0x51, psTdmaByte3Val =  0x10;\n\ts8 nWiFiDurationAdjust = 0x0;\n\t \n\n\tpCoexDm->bCurPsTdmaOn = bTurnOn;\n\tpCoexDm->curPsTdma = type;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\n\n\tif (!bForceExec) {\n\t\tif (\n\t\t\t(pCoexDm->bPrePsTdmaOn == pCoexDm->bCurPsTdmaOn) &&\n\t\t\t(pCoexDm->prePsTdma == pCoexDm->curPsTdma)\n\t\t)\n\t\t\treturn;\n\t}\n\n\tif (pCoexSta->nScanAPNum <= 5)\n\t\tnWiFiDurationAdjust = 5;\n\telse if  (pCoexSta->nScanAPNum >= 40)\n\t\tnWiFiDurationAdjust = -15;\n\telse if  (pCoexSta->nScanAPNum >= 20)\n\t\tnWiFiDurationAdjust = -10;\n\n\tif (!pCoexSta->bForceLpsOn) {  \n\t\tpsTdmaByte0Val = 0x61;   \n\t\tpsTdmaByte3Val = 0x11;  \n\t\tpsTdmaByte4Val = 0x10;  \n\t}\n\n\n\tif (bTurnOn) {\n\t\tif (pBtLinkInfo->bSlaveRole)\n\t\t\tpsTdmaByte4Val = psTdmaByte4Val | 0x1;   \n\n\n\t\tswitch (type) {\n\t\tdefault:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x51, 0x1a, 0x1a, 0x0, psTdmaByte4Val\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist,\n\t\t\t\tpsTdmaByte0Val,\n\t\t\t\t0x3a + nWiFiDurationAdjust,\n\t\t\t\t0x03,\n\t\t\t\tpsTdmaByte3Val,\n\t\t\t\tpsTdmaByte4Val\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist,\n\t\t\t\tpsTdmaByte0Val,\n\t\t\t\t0x2d + nWiFiDurationAdjust,\n\t\t\t\t0x03,\n\t\t\t\tpsTdmaByte3Val,\n\t\t\t\tpsTdmaByte4Val\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x51, 0x1d, 0x1d, 0x0, 0x10\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x93, 0x15, 0x3, 0x14, 0x0\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 5:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x61, 0x15, 0x3, 0x11, 0x10\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 6:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x61, 0x20, 0x3, 0x11, 0x11\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 7:\n\t\t\thalbtc8723b1ant_SetFwPstdma(pBtCoexist, 0x13, 0xc, 0x5, 0x0, 0x0);\n\t\t\tbreak;\n\t\tcase 8:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x93, 0x25, 0x3, 0x10, 0x0\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 9:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist,\n\t\t\t\tpsTdmaByte0Val,\n\t\t\t\t0x21,\n\t\t\t\t0x3,\n\t\t\t\tpsTdmaByte3Val,\n\t\t\t\tpsTdmaByte4Val\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 10:\n\t\t\thalbtc8723b1ant_SetFwPstdma(pBtCoexist, 0x13, 0xa, 0xa, 0x0, 0x40);\n\t\t\tbreak;\n\t\tcase 11:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist,\n\t\t\t\tpsTdmaByte0Val,\n\t\t\t\t0x21,\n\t\t\t\t0x03,\n\t\t\t\tpsTdmaByte3Val,\n\t\t\t\tpsTdmaByte4Val\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 12:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x51, 0x0a, 0x0a, 0x0, 0x50\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 13:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x51, 0x12, 0x12, 0x0, 0x10\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 14:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x51, 0x21, 0x3, 0x10, psTdmaByte4Val\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 15:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x13, 0xa, 0x3, 0x8, 0x0\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 16:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x93, 0x15, 0x3, 0x10, 0x0\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 18:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x93, 0x25, 0x3, 0x10, 0x0\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 20:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x61, 0x3f, 0x03, 0x11, 0x10\n\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 21:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x61, 0x25, 0x03, 0x11, 0x11\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 22:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x61, 0x25, 0x03, 0x11, 0x10\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 23:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0xe3, 0x25, 0x3, 0x31, 0x18\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 24:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0xe3, 0x15, 0x3, 0x31, 0x18\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 25:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0xe3, 0xa, 0x3, 0x31, 0x18\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 26:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0xe3, 0xa, 0x3, 0x31, 0x18\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 27:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0xe3, 0x25, 0x3, 0x31, 0x98\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 28:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x69, 0x25, 0x3, 0x31, 0x0\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 29:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0xab, 0x1a, 0x1a, 0x1, 0x10\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 30:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x51, 0x30, 0x3, 0x10, 0x10\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 31:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0xd3, 0x1a, 0x1a, 0x0, 0x58\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 32:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x61, 0x35, 0x3, 0x11, 0x11\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 33:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0xa3, 0x25, 0x3, 0x30, 0x90\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 34:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x53, 0x1a, 0x1a, 0x0, 0x10\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 35:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x63, 0x1a, 0x1a, 0x0, 0x10\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 36:\n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0xd3, 0x12, 0x3, 0x14, 0x50\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 40:  \n\t\t\t \n\t\t\thalbtc8723b1ant_SetFwPstdma(\n\t\t\t\tpBtCoexist, 0x23, 0x18, 0x00, 0x10, 0x24\n\t\t\t);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\n\t\t \n\t\tswitch (type) {\n\t\tcase 8:  \n\t\t\thalbtc8723b1ant_SetFwPstdma(pBtCoexist, 0x8, 0x0, 0x0, 0x0, 0x0);\n\t\t\thalbtc8723b1ant_SetAntPath(\n\t\t\t\tpBtCoexist, BTC_ANT_PATH_PTA, false, false\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 0:\n\t\tdefault:   \n\t\t\thalbtc8723b1ant_SetFwPstdma(pBtCoexist, 0x0, 0x0, 0x0, 0x0, 0x0);\n\t\t\thalbtc8723b1ant_SetAntPath(\n\t\t\t\tpBtCoexist, BTC_ANT_PATH_BT, false, false\n\t\t\t);\n\t\t\tbreak;\n\t\tcase 9:    \n\t\t\thalbtc8723b1ant_SetFwPstdma(pBtCoexist, 0x0, 0x0, 0x0, 0x0, 0x0);\n\t\t\thalbtc8723b1ant_SetAntPath(\n\t\t\t\tpBtCoexist, BTC_ANT_PATH_WIFI, false, false\n\t\t\t);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\trssiAdjustVal = 0;\n\tpBtCoexist->fBtcSet(\n\t\tpBtCoexist, BTC_SET_U1_RSSI_ADJ_VAL_FOR_1ANT_COEX_TYPE, &rssiAdjustVal\n\t);\n\n\t \n\tpCoexDm->bPrePsTdmaOn = pCoexDm->bCurPsTdmaOn;\n\tpCoexDm->prePsTdma = pCoexDm->curPsTdma;\n}\n\nstatic bool halbtc8723b1ant_IsCommonAction(struct btc_coexist *pBtCoexist)\n{\n\tbool bCommon = false, bWifiConnected = false, bWifiBusy = false;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\n\n\tif (\n\t\t!bWifiConnected &&\n\t\tpCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_NON_CONNECTED_IDLE\n\t) {\n\t\t \n\n\t\tbCommon = true;\n\t} else if (\n\t\tbWifiConnected &&\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_NON_CONNECTED_IDLE)\n\t) {\n\t\t \n\n\t\tbCommon = true;\n\t} else if (\n\t\t!bWifiConnected &&\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_CONNECTED_IDLE)\n\t) {\n\t\t \n\n\t\tbCommon = true;\n\t} else if (\n\t\tbWifiConnected &&\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_CONNECTED_IDLE)\n\t) {\n\t\t \n\n\t\tbCommon = true;\n\t} else if (\n\t\t!bWifiConnected &&\n\t\t(pCoexDm->btStatus != BT_8723B_1ANT_BT_STATUS_CONNECTED_IDLE)\n\t) {\n\t\t \n\n\t\tbCommon = true;\n\t} else {\n\t\tbCommon = false;\n\t}\n\n\treturn bCommon;\n}\n\n\nstatic void halbtc8723b1ant_TdmaDurationAdjustForAcl(\n\tstruct btc_coexist *pBtCoexist, u8 wifiStatus\n)\n{\n\tstatic s32 up, dn, m, n, WaitCount;\n\ts32 result;    \n\tu8 retryCount = 0, btInfoExt;\n\n\tif (\n\t\t(wifiStatus == BT_8723B_1ANT_WIFI_STATUS_NON_CONNECTED_ASSO_AUTH_SCAN) ||\n\t\t(wifiStatus == BT_8723B_1ANT_WIFI_STATUS_CONNECTED_SCAN) ||\n\t\t(wifiStatus == BT_8723B_1ANT_WIFI_STATUS_CONNECTED_SPECIAL_PKT)\n\t) {\n\t\tif (\n\t\t\tpCoexDm->curPsTdma != 1 &&\n\t\t\tpCoexDm->curPsTdma != 2 &&\n\t\t\tpCoexDm->curPsTdma != 3 &&\n\t\t\tpCoexDm->curPsTdma != 9\n\t\t) {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\n\t\t\tpCoexDm->psTdmaDuAdjType = 9;\n\n\t\t\tup = 0;\n\t\t\tdn = 0;\n\t\t\tm = 1;\n\t\t\tn = 3;\n\t\t\tresult = 0;\n\t\t\tWaitCount = 0;\n\t\t}\n\t\treturn;\n\t}\n\n\tif (!pCoexDm->bAutoTdmaAdjust) {\n\t\tpCoexDm->bAutoTdmaAdjust = true;\n\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 2);\n\t\tpCoexDm->psTdmaDuAdjType = 2;\n\t\t \n\t\tup = 0;\n\t\tdn = 0;\n\t\tm = 1;\n\t\tn = 3;\n\t\tresult = 0;\n\t\tWaitCount = 0;\n\t} else {\n\t\t \n\t\tretryCount = pCoexSta->btRetryCnt;\n\t\tbtInfoExt = pCoexSta->btInfoExt;\n\n\t\tif (pCoexSta->lowPriorityTx > 1050 || pCoexSta->lowPriorityRx > 1250)\n\t\t\tretryCount++;\n\n\t\tresult = 0;\n\t\tWaitCount++;\n\n\t\tif (retryCount == 0) {  \n\t\t\tup++;\n\t\t\tdn--;\n\n\t\t\tif (dn <= 0)\n\t\t\t\tdn = 0;\n\n\t\t\tif (up >= n) {  \n\t\t\t\tWaitCount = 0;\n\t\t\t\tn = 3;\n\t\t\t\tup = 0;\n\t\t\t\tdn = 0;\n\t\t\t\tresult = 1;\n\t\t\t}\n\t\t} else if (retryCount <= 3) {  \n\t\t\tup--;\n\t\t\tdn++;\n\n\t\t\tif (up <= 0)\n\t\t\t\tup = 0;\n\n\t\t\tif (dn == 2) {  \n\t\t\t\tif (WaitCount <= 2)\n\t\t\t\t\tm++;  \n\t\t\t\telse\n\t\t\t\t\tm = 1;\n\n\t\t\t\tif (m >= 20)  \n\t\t\t\t\tm = 20;\n\n\t\t\t\tn = 3 * m;\n\t\t\t\tup = 0;\n\t\t\t\tdn = 0;\n\t\t\t\tWaitCount = 0;\n\t\t\t\tresult = -1;\n\t\t\t}\n\t\t} else {  \n\t\t\tif (WaitCount == 1)\n\t\t\t\tm++;  \n\t\t\telse\n\t\t\t\tm = 1;\n\n\t\t\tif (m >= 20)  \n\t\t\t\tm = 20;\n\n\t\t\tn = 3 * m;\n\t\t\tup = 0;\n\t\t\tdn = 0;\n\t\t\tWaitCount = 0;\n\t\t\tresult = -1;\n\t\t}\n\n\t\tif (result == -1) {\n\t\t\tif (\n\t\t\t\tBT_INFO_8723B_1ANT_A2DP_BASIC_RATE(btInfoExt) &&\n\t\t\t\t((pCoexDm->curPsTdma == 1) || (pCoexDm->curPsTdma == 2))\n\t\t\t) {\n\t\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\n\t\t\t\tpCoexDm->psTdmaDuAdjType = 9;\n\t\t\t} else if (pCoexDm->curPsTdma == 1) {\n\t\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 2);\n\t\t\t\tpCoexDm->psTdmaDuAdjType = 2;\n\t\t\t} else if (pCoexDm->curPsTdma == 2) {\n\t\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\n\t\t\t\tpCoexDm->psTdmaDuAdjType = 9;\n\t\t\t} else if (pCoexDm->curPsTdma == 9) {\n\t\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 11);\n\t\t\t\tpCoexDm->psTdmaDuAdjType = 11;\n\t\t\t}\n\t\t} else if (result == 1) {\n\t\t\tif (\n\t\t\t\tBT_INFO_8723B_1ANT_A2DP_BASIC_RATE(btInfoExt) &&\n\t\t\t\t((pCoexDm->curPsTdma == 1) || (pCoexDm->curPsTdma == 2))\n\t\t\t) {\n\t\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\n\t\t\t\tpCoexDm->psTdmaDuAdjType = 9;\n\t\t\t} else if (pCoexDm->curPsTdma == 11) {\n\t\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\n\t\t\t\tpCoexDm->psTdmaDuAdjType = 9;\n\t\t\t} else if (pCoexDm->curPsTdma == 9) {\n\t\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 2);\n\t\t\t\tpCoexDm->psTdmaDuAdjType = 2;\n\t\t\t} else if (pCoexDm->curPsTdma == 2) {\n\t\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 1);\n\t\t\t\tpCoexDm->psTdmaDuAdjType = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (\n\t\t\tpCoexDm->curPsTdma != 1 &&\n\t\t\tpCoexDm->curPsTdma != 2 &&\n\t\t\tpCoexDm->curPsTdma != 9 &&\n\t\t\tpCoexDm->curPsTdma != 11\n\t\t)  \n\t\t\thalbtc8723b1ant_PsTdma(\n\t\t\t\tpBtCoexist, NORMAL_EXEC, true, pCoexDm->psTdmaDuAdjType\n\t\t\t);\n\t}\n}\n\nstatic void halbtc8723b1ant_PsTdmaCheckForPowerSaveState(\n\tstruct btc_coexist *pBtCoexist, bool bNewPsState\n)\n{\n\tu8 lpsMode = 0x0;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_U1_LPS_MODE, &lpsMode);\n\n\tif (lpsMode) {\t \n\t\tif (bNewPsState) {\n\t\t\t \n\t\t} else  \n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 0);\n\t} else {\t\t\t\t\t\t \n\t\tif (bNewPsState)  \n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 0);\n\t\telse {\n\t\t\t \n\t\t}\n\t}\n}\n\nstatic void halbtc8723b1ant_PowerSaveState(\n\tstruct btc_coexist *pBtCoexist, u8 psType, u8 lpsVal, u8 rpwmVal\n)\n{\n\tbool bLowPwrDisable = false;\n\n\tswitch (psType) {\n\tcase BTC_PS_WIFI_NATIVE:\n\t\t \n\t\tbLowPwrDisable = false;\n\t\tpBtCoexist->fBtcSet(\n\t\t\tpBtCoexist, BTC_SET_ACT_DISABLE_LOW_POWER, &bLowPwrDisable\n\t\t);\n\t\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_ACT_NORMAL_LPS, NULL);\n\t\tpCoexSta->bForceLpsOn = false;\n\t\tbreak;\n\tcase BTC_PS_LPS_ON:\n\t\thalbtc8723b1ant_PsTdmaCheckForPowerSaveState(pBtCoexist, true);\n\t\thalbtc8723b1ant_LpsRpwm(pBtCoexist, NORMAL_EXEC, lpsVal, rpwmVal);\n\t\t \n\t\tbLowPwrDisable = true;\n\t\tpBtCoexist->fBtcSet(\n\t\t\tpBtCoexist, BTC_SET_ACT_DISABLE_LOW_POWER, &bLowPwrDisable\n\t\t);\n\t\t \n\t\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_ACT_ENTER_LPS, NULL);\n\t\tpCoexSta->bForceLpsOn = true;\n\t\tbreak;\n\tcase BTC_PS_LPS_OFF:\n\t\thalbtc8723b1ant_PsTdmaCheckForPowerSaveState(pBtCoexist, false);\n\t\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\n\t\tpCoexSta->bForceLpsOn = false;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n \n \n \n \n \n\n \n \n \n \n \nstatic void halbtc8723b1ant_ActionWifiMultiPort(struct btc_coexist *pBtCoexist)\n{\n\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\n\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 8);\n\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\n}\n\nstatic void halbtc8723b1ant_ActionHs(struct btc_coexist *pBtCoexist)\n{\n\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 5);\n\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\n}\n\nstatic void halbtc8723b1ant_ActionBtInquiry(struct btc_coexist *pBtCoexist)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\tbool bWifiConnected = false;\n\tbool bApEnable = false;\n\tbool bWifiBusy = false;\n\tbool bBtBusy = false;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_AP_MODE_ENABLE, &bApEnable);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\n\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_BL_BT_TRAFFIC_BUSY, &bBtBusy);\n\n\tif (!bWifiConnected && !pCoexSta->bWiFiIsHighPriTask) {\n\t\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 8);\n\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\n\t} else if (\n\t\tpBtLinkInfo->bScoExist ||\n\t\tpBtLinkInfo->bHidExist ||\n\t\tpBtLinkInfo->bA2dpExist\n\t) {\n\t\t \n\t\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 32);\n\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t} else if (pBtLinkInfo->bPanExist || bWifiBusy) {\n\t\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 20);\n\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t} else {\n\t\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 8);\n\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 7);\n\t}\n}\n\nstatic void halbtc8723b1ant_ActionBtScoHidOnlyBusy(\n\tstruct btc_coexist *pBtCoexist, u8 wifiStatus\n)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\tbool bWifiConnected = false;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\n\n\t \n\n\tif (pBtLinkInfo->bScoExist) {\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 5);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 5);\n\t} else {  \n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 6);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 5);\n\t}\n}\n\nstatic void halbtc8723b1ant_ActionWifiConnectedBtAclBusy(\n\tstruct btc_coexist *pBtCoexist, u8 wifiStatus\n)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\n\thalbtc8723b1ant_BtRssiState(2, 28, 0);\n\n\tif ((pCoexSta->lowPriorityRx >= 1000) && (pCoexSta->lowPriorityRx != 65535))\n\t\tpBtLinkInfo->bSlaveRole = true;\n\telse\n\t\tpBtLinkInfo->bSlaveRole = false;\n\n\tif (pBtLinkInfo->bHidOnly) {  \n\t\thalbtc8723b1ant_ActionBtScoHidOnlyBusy(pBtCoexist, wifiStatus);\n\t\tpCoexDm->bAutoTdmaAdjust = false;\n\t\treturn;\n\t} else if (pBtLinkInfo->bA2dpOnly) {  \n\t\tif (wifiStatus == BT_8723B_1ANT_WIFI_STATUS_CONNECTED_IDLE) {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 32);\n\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\t\tpCoexDm->bAutoTdmaAdjust = false;\n\t\t} else {\n\t\t\thalbtc8723b1ant_TdmaDurationAdjustForAcl(pBtCoexist, wifiStatus);\n\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\t\tpCoexDm->bAutoTdmaAdjust = true;\n\t\t}\n\t} else if (pBtLinkInfo->bHidExist && pBtLinkInfo->bA2dpExist) {  \n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 14);\n\t\tpCoexDm->bAutoTdmaAdjust = false;\n\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t} else if (\n\t\tpBtLinkInfo->bPanOnly ||\n\t\t(pBtLinkInfo->bHidExist && pBtLinkInfo->bPanExist)\n\t) {  \n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 3);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\tpCoexDm->bAutoTdmaAdjust = false;\n\t} else if (\n\t\t(pBtLinkInfo->bA2dpExist && pBtLinkInfo->bPanExist) ||\n\t\t(pBtLinkInfo->bHidExist && pBtLinkInfo->bA2dpExist && pBtLinkInfo->bPanExist)\n\t) {  \n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 13);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\tpCoexDm->bAutoTdmaAdjust = false;\n\t} else {\n\t\t \n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 32);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\tpCoexDm->bAutoTdmaAdjust = false;\n\t}\n}\n\nstatic void halbtc8723b1ant_ActionWifiNotConnected(struct btc_coexist *pBtCoexist)\n{\n\t \n\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\n\t \n\thalbtc8723b1ant_PsTdma(pBtCoexist, FORCE_EXEC, false, 8);\n\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\n}\n\nstatic void halbtc8723b1ant_ActionWifiNotConnectedScan(\n\tstruct btc_coexist *pBtCoexist\n)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\n\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\n\t \n\tif (pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) {\n\t\tif (pBtLinkInfo->bA2dpExist) {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 32);\n\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\t} else if (pBtLinkInfo->bA2dpExist && pBtLinkInfo->bPanExist) {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 22);\n\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\t} else {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 20);\n\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\t}\n\t} else if (\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_SCO_BUSY) ||\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY)\n\t) {\n\t\thalbtc8723b1ant_ActionBtScoHidOnlyBusy(\n\t\t\tpBtCoexist, BT_8723B_1ANT_WIFI_STATUS_CONNECTED_SCAN\n\t\t);\n\t} else {\n\t\t \n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\n\t}\n}\n\nstatic void halbtc8723b1ant_ActionWifiNotConnectedAssoAuth(\n\tstruct btc_coexist *pBtCoexist\n)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\n\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\n\t \n\tif (\n\t\t(pBtLinkInfo->bScoExist) ||\n\t\t(pBtLinkInfo->bHidExist) ||\n\t\t(pBtLinkInfo->bA2dpExist)\n\t) {\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 32);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t} else if (pBtLinkInfo->bPanExist) {\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 20);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t} else {\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\n\t}\n}\n\nstatic void halbtc8723b1ant_ActionWifiConnectedScan(struct btc_coexist *pBtCoexist)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\n\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\n\t \n\tif (pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) {\n\t\tif (pBtLinkInfo->bA2dpExist) {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 32);\n\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\t} else if (pBtLinkInfo->bA2dpExist && pBtLinkInfo->bPanExist) {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 22);\n\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\t} else {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 20);\n\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t\t}\n\t} else if (\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_SCO_BUSY) ||\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY)\n\t) {\n\t\thalbtc8723b1ant_ActionBtScoHidOnlyBusy(\n\t\t\tpBtCoexist, BT_8723B_1ANT_WIFI_STATUS_CONNECTED_SCAN\n\t\t);\n\t} else {\n\t\t \n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\n\t}\n}\n\nstatic void halbtc8723b1ant_ActionWifiConnectedSpecialPacket(\n\tstruct btc_coexist *pBtCoexist\n)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\n\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\n\t \n\tif (\n\t\t(pBtLinkInfo->bScoExist) ||\n\t\t(pBtLinkInfo->bHidExist) ||\n\t\t(pBtLinkInfo->bA2dpExist)\n\t) {\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 32);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t} else if (pBtLinkInfo->bPanExist) {\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 20);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 4);\n\t} else {\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\n\t}\n}\n\nstatic void halbtc8723b1ant_ActionWifiConnected(struct btc_coexist *pBtCoexist)\n{\n\tbool bWifiBusy = false;\n\tbool bScan = false, bLink = false, bRoam = false;\n\tbool bUnder4way = false, bApEnable = false;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_4_WAY_PROGRESS, &bUnder4way);\n\tif (bUnder4way) {\n\t\thalbtc8723b1ant_ActionWifiConnectedSpecialPacket(pBtCoexist);\n\t\treturn;\n\t}\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_SCAN, &bScan);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_LINK, &bLink);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_ROAM, &bRoam);\n\tif (bScan || bLink || bRoam) {\n\t\tif (bScan)\n\t\t\thalbtc8723b1ant_ActionWifiConnectedScan(pBtCoexist);\n\t\telse\n\t\t\thalbtc8723b1ant_ActionWifiConnectedSpecialPacket(pBtCoexist);\n\t\treturn;\n\t}\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_AP_MODE_ENABLE, &bApEnable);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\n\n\t \n\tif (\n\t\t!bApEnable &&\n\t\tpCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_BUSY &&\n\t\t!pBtCoexist->btLinkInfo.bHidOnly\n\t) {\n\t\tif (pBtCoexist->btLinkInfo.bA2dpOnly) {  \n\t\t\tif (!bWifiBusy)\n\t\t\t\thalbtc8723b1ant_PowerSaveState(\n\t\t\t\t\tpBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0\n\t\t\t\t);\n\t\t\telse {  \n\t\t\t\tif  (pCoexSta->nScanAPNum >= BT_8723B_1ANT_WIFI_NOISY_THRESH)   \n\t\t\t\t\thalbtc8723b1ant_PowerSaveState(\n\t\t\t\t\t\tpBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0\n\t\t\t\t\t);\n\t\t\t\telse\n\t\t\t\t\thalbtc8723b1ant_PowerSaveState(\n\t\t\t\t\t\tpBtCoexist, BTC_PS_LPS_ON, 0x50, 0x4\n\t\t\t\t\t);\n\t\t\t}\n\t\t} else if (\n\t\t\t(!pCoexSta->bPanExist) &&\n\t\t\t(!pCoexSta->bA2dpExist) &&\n\t\t\t(!pCoexSta->bHidExist)\n\t\t)\n\t\t\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\t\telse\n\t\t\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_LPS_ON, 0x50, 0x4);\n\t} else\n\t\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\n\t \n\tif (!bWifiBusy) {\n\t\tif (pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) {\n\t\t\thalbtc8723b1ant_ActionWifiConnectedBtAclBusy(\n\t\t\t\tpBtCoexist,\n\t\t\t\tBT_8723B_1ANT_WIFI_STATUS_CONNECTED_IDLE\n\t\t\t);\n\t\t} else if (\n\t\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_SCO_BUSY) ||\n\t\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY)\n\t\t) {\n\t\t\thalbtc8723b1ant_ActionBtScoHidOnlyBusy(pBtCoexist,\n\t\t\t\tBT_8723B_1ANT_WIFI_STATUS_CONNECTED_IDLE);\n\t\t} else {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 8);\n\n\t\t\tif ((pCoexSta->highPriorityTx) + (pCoexSta->highPriorityRx) <= 60)\n\t\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\n\t\t\telse\n\t\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 7);\n\t\t}\n\t} else {\n\t\tif (pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) {\n\t\t\thalbtc8723b1ant_ActionWifiConnectedBtAclBusy(\n\t\t\t\tpBtCoexist,\n\t\t\t\tBT_8723B_1ANT_WIFI_STATUS_CONNECTED_BUSY\n\t\t\t);\n\t\t} else if (\n\t\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_SCO_BUSY) ||\n\t\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY)\n\t\t) {\n\t\t\thalbtc8723b1ant_ActionBtScoHidOnlyBusy(\n\t\t\t\tpBtCoexist,\n\t\t\t\tBT_8723B_1ANT_WIFI_STATUS_CONNECTED_BUSY\n\t\t\t);\n\t\t} else {\n\t\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 8);\n\n\t\t\tif ((pCoexSta->highPriorityTx) + (pCoexSta->highPriorityRx) <= 60)\n\t\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\n\t\t\telse\n\t\t\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 7);\n\t\t}\n\t}\n}\n\nstatic void halbtc8723b1ant_RunSwCoexistMechanism(struct btc_coexist *pBtCoexist)\n{\n\tu8 algorithm = 0;\n\n\talgorithm = halbtc8723b1ant_ActionAlgorithm(pBtCoexist);\n\tpCoexDm->curAlgorithm = algorithm;\n\n\tif (halbtc8723b1ant_IsCommonAction(pBtCoexist)) {\n\n\t} else {\n\t\tswitch (pCoexDm->curAlgorithm) {\n\t\tcase BT_8723B_1ANT_COEX_ALGO_SCO:\n\t\t\t \n\t\t\tbreak;\n\t\tcase BT_8723B_1ANT_COEX_ALGO_HID:\n\t\t\t \n\t\t\tbreak;\n\t\tcase BT_8723B_1ANT_COEX_ALGO_A2DP:\n\t\t\t \n\t\t\tbreak;\n\t\tcase BT_8723B_1ANT_COEX_ALGO_A2DP_PANHS:\n\t\t\t \n\t\t\tbreak;\n\t\tcase BT_8723B_1ANT_COEX_ALGO_PANEDR:\n\t\t\t \n\t\t\tbreak;\n\t\tcase BT_8723B_1ANT_COEX_ALGO_PANHS:\n\t\t\t \n\t\t\tbreak;\n\t\tcase BT_8723B_1ANT_COEX_ALGO_PANEDR_A2DP:\n\t\t\t \n\t\t\tbreak;\n\t\tcase BT_8723B_1ANT_COEX_ALGO_PANEDR_HID:\n\t\t\t \n\t\t\tbreak;\n\t\tcase BT_8723B_1ANT_COEX_ALGO_HID_A2DP_PANEDR:\n\t\t\t \n\t\t\tbreak;\n\t\tcase BT_8723B_1ANT_COEX_ALGO_HID_A2DP:\n\t\t\t \n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tpCoexDm->preAlgorithm = pCoexDm->curAlgorithm;\n\t}\n}\n\nstatic void halbtc8723b1ant_RunCoexistMechanism(struct btc_coexist *pBtCoexist)\n{\n\tstruct btc_bt_link_info *pBtLinkInfo = &pBtCoexist->btLinkInfo;\n\tbool bWifiConnected = false, bBtHsOn = false;\n\tbool bIncreaseScanDevNum = false;\n\tbool bBtCtrlAggBufSize = false;\n\tu8 aggBufSize = 5;\n\tu32 wifiLinkStatus = 0;\n\tu32 numOfWifiLink = 0;\n\n\tif (pBtCoexist->bManualControl)\n\t\treturn;\n\n\tif (pBtCoexist->bStopCoexDm)\n\t\treturn;\n\n\tif (pCoexSta->bUnderIps)\n\t\treturn;\n\n\tif (\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) ||\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_SCO_BUSY) ||\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY)\n\t){\n\t\tbIncreaseScanDevNum = true;\n\t}\n\n\tpBtCoexist->fBtcSet(\n\t\tpBtCoexist,\n\t\tBTC_SET_BL_INC_SCAN_DEV_NUM,\n\t\t&bIncreaseScanDevNum\n\t);\n\tpBtCoexist->fBtcGet(\n\t\tpBtCoexist,\n\t\tBTC_GET_BL_WIFI_CONNECTED,\n\t\t&bWifiConnected\n\t);\n\n\tpBtCoexist->fBtcGet(\n\t\tpBtCoexist,\n\t\tBTC_GET_U4_WIFI_LINK_STATUS,\n\t\t&wifiLinkStatus\n\t);\n\tnumOfWifiLink = wifiLinkStatus >> 16;\n\n\tif ((numOfWifiLink >= 2) || (wifiLinkStatus & WIFI_P2P_GO_CONNECTED)) {\n\t\thalbtc8723b1ant_LimitedTx(pBtCoexist, NORMAL_EXEC, 0, 0, 0, 0);\n\t\thalbtc8723b1ant_LimitedRx(pBtCoexist, NORMAL_EXEC, false, bBtCtrlAggBufSize, aggBufSize);\n\n\t\tif ((pBtLinkInfo->bA2dpExist) && (pCoexSta->bC2hBtInquiryPage))\n\t\t\thalbtc8723b1ant_ActionBtInquiry(pBtCoexist);\n\t\telse\n\t\t\thalbtc8723b1ant_ActionWifiMultiPort(pBtCoexist);\n\n\t\treturn;\n\t}\n\n\tif ((pBtLinkInfo->bBtLinkExist) && (bWifiConnected)) {\n\t\thalbtc8723b1ant_LimitedTx(pBtCoexist, NORMAL_EXEC, 1, 1, 0, 1);\n\n\t\tif (pBtLinkInfo->bScoExist)\n\t\t\thalbtc8723b1ant_LimitedRx(pBtCoexist, NORMAL_EXEC, false, true, 0x5);\n\t\telse\n\t\t\thalbtc8723b1ant_LimitedRx(pBtCoexist, NORMAL_EXEC, false, true, 0x8);\n\n\t\thalbtc8723b1ant_SwMechanism(pBtCoexist, true);\n\t\thalbtc8723b1ant_RunSwCoexistMechanism(pBtCoexist);   \n\t} else {\n\t\thalbtc8723b1ant_LimitedTx(pBtCoexist, NORMAL_EXEC, 0, 0, 0, 0);\n\n\t\thalbtc8723b1ant_LimitedRx(pBtCoexist, NORMAL_EXEC, false, false, 0x5);\n\n\t\thalbtc8723b1ant_SwMechanism(pBtCoexist, false);\n\t\thalbtc8723b1ant_RunSwCoexistMechanism(pBtCoexist);  \n\t}\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\n\tif (pCoexSta->bC2hBtInquiryPage) {\n\t\thalbtc8723b1ant_ActionBtInquiry(pBtCoexist);\n\t\treturn;\n\t} else if (bBtHsOn) {\n\t\thalbtc8723b1ant_ActionHs(pBtCoexist);\n\t\treturn;\n\t}\n\n\n\tif (!bWifiConnected) {\n\t\tbool bScan = false, bLink = false, bRoam = false;\n\n\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_SCAN, &bScan);\n\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_LINK, &bLink);\n\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_ROAM, &bRoam);\n\n\t\tif (bScan || bLink || bRoam) {\n\t\t\tif (bScan)\n\t\t\t\thalbtc8723b1ant_ActionWifiNotConnectedScan(pBtCoexist);\n\t\t\telse\n\t\t\t\thalbtc8723b1ant_ActionWifiNotConnectedAssoAuth(pBtCoexist);\n\t\t} else\n\t\t\thalbtc8723b1ant_ActionWifiNotConnected(pBtCoexist);\n\t} else  \n\t\thalbtc8723b1ant_ActionWifiConnected(pBtCoexist);\n}\n\nstatic void halbtc8723b1ant_InitCoexDm(struct btc_coexist *pBtCoexist)\n{\n\t \n\n\t \n\thalbtc8723b1ant_SwMechanism(pBtCoexist, false);\n\n\t \n\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, FORCE_EXEC, 0);\n\n\tpCoexSta->popEventCnt = 0;\n}\n\nstatic void halbtc8723b1ant_InitHwConfig(\n\tstruct btc_coexist *pBtCoexist,\n\tbool bBackUp,\n\tbool bWifiOnly\n)\n{\n\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x550, 0x8, 0x1);   \n\n\t \n\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x790, 0x5);\n\n\t \n\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x778, 0x1);\n\tpBtCoexist->fBtcWrite1ByteBitMask(pBtCoexist, 0x40, 0x20, 0x1);\n\n\t \n\tif (bWifiOnly) {\n\t\thalbtc8723b1ant_SetAntPath(pBtCoexist, BTC_ANT_PATH_WIFI, true, false);\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, FORCE_EXEC, false, 9);\n\t} else\n\t\thalbtc8723b1ant_SetAntPath(pBtCoexist, BTC_ANT_PATH_BT, true, false);\n\n\t \n\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, FORCE_EXEC, 0);\n\n\tpBtCoexist->fBtcRead4Byte(pBtCoexist, 0x948);\n\tpBtCoexist->fBtcRead1Byte(pBtCoexist, 0x765);\n\tpBtCoexist->fBtcRead1Byte(pBtCoexist, 0x67);\n}\n\n \n \n \n \n \n \nvoid EXhalbtc8723b1ant_PowerOnSetting(struct btc_coexist *pBtCoexist)\n{\n\tstruct btc_board_info *pBoardInfo = &pBtCoexist->boardInfo;\n\tu8 u1Tmp = 0x0;\n\tu16 u2Tmp = 0x0;\n\n\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x67, 0x20);\n\n\t \n\tu2Tmp = pBtCoexist->fBtcRead2Byte(pBtCoexist, 0x2);\n\tpBtCoexist->fBtcWrite2Byte(pBtCoexist, 0x2, u2Tmp | BIT0 | BIT1);\n\n\t \n\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x765, 0x18);\n\t \n\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x76e, 0x4);\n\n\t \n\t \n\t \n\t \n\t \n\t \n\t \n\tif (pBtCoexist->chipInterface == BTC_INTF_USB) {\n\t\t \n\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x0);\n\n\t\tu1Tmp |= 0x1;\t \n\t\tpBtCoexist->fBtcWriteLocalReg1Byte(pBtCoexist, 0xfe08, u1Tmp);\n\n\t\tpBoardInfo->btdmAntPos = BTC_ANTENNA_AT_AUX_PORT;\n\t} else {\n\t\t \n\t\tif (pBoardInfo->singleAntPath == 0) {\n\t\t\t \n\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x280);\n\t\t\tpBoardInfo->btdmAntPos = BTC_ANTENNA_AT_MAIN_PORT;\n\t\t} else if (pBoardInfo->singleAntPath == 1) {\n\t\t\t \n\t\t\tpBtCoexist->fBtcWrite4Byte(pBtCoexist, 0x948, 0x0);\n\t\t\tu1Tmp |= 0x1;\t \n\t\t\tpBoardInfo->btdmAntPos = BTC_ANTENNA_AT_AUX_PORT;\n\t\t}\n\n\t\tif (pBtCoexist->chipInterface == BTC_INTF_PCI)\n\t\t\tpBtCoexist->fBtcWriteLocalReg1Byte(pBtCoexist, 0x384, u1Tmp);\n\t\telse if (pBtCoexist->chipInterface == BTC_INTF_SDIO)\n\t\t\tpBtCoexist->fBtcWriteLocalReg1Byte(pBtCoexist, 0x60, u1Tmp);\n\t}\n}\n\nvoid EXhalbtc8723b1ant_InitHwConfig(struct btc_coexist *pBtCoexist, bool bWifiOnly)\n{\n\thalbtc8723b1ant_InitHwConfig(pBtCoexist, true, bWifiOnly);\n}\n\nvoid EXhalbtc8723b1ant_InitCoexDm(struct btc_coexist *pBtCoexist)\n{\n\tpBtCoexist->bStopCoexDm = false;\n\n\thalbtc8723b1ant_InitCoexDm(pBtCoexist);\n\n\thalbtc8723b1ant_QueryBtInfo(pBtCoexist);\n}\n\nvoid EXhalbtc8723b1ant_IpsNotify(struct btc_coexist *pBtCoexist, u8 type)\n{\n\tif (pBtCoexist->bManualControl ||\tpBtCoexist->bStopCoexDm)\n\t\treturn;\n\n\tif (type == BTC_IPS_ENTER) {\n\t\tpCoexSta->bUnderIps = true;\n\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 0);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\n\t\thalbtc8723b1ant_SetAntPath(pBtCoexist, BTC_ANT_PATH_BT, false, true);\n\t} else if (type == BTC_IPS_LEAVE) {\n\t\tpCoexSta->bUnderIps = false;\n\n\t\thalbtc8723b1ant_InitHwConfig(pBtCoexist, false, false);\n\t\thalbtc8723b1ant_InitCoexDm(pBtCoexist);\n\t\thalbtc8723b1ant_QueryBtInfo(pBtCoexist);\n\t}\n}\n\nvoid EXhalbtc8723b1ant_LpsNotify(struct btc_coexist *pBtCoexist, u8 type)\n{\n\tif (pBtCoexist->bManualControl || pBtCoexist->bStopCoexDm)\n\t\treturn;\n\n\tif (type == BTC_LPS_ENABLE)\n\t\tpCoexSta->bUnderLps = true;\n\telse if (type == BTC_LPS_DISABLE)\n\t\tpCoexSta->bUnderLps = false;\n}\n\nvoid EXhalbtc8723b1ant_ScanNotify(struct btc_coexist *pBtCoexist, u8 type)\n{\n\tbool bWifiConnected = false, bBtHsOn = false;\n\tu32 wifiLinkStatus = 0;\n\tu32 numOfWifiLink = 0;\n\tbool bBtCtrlAggBufSize = false;\n\tu8 aggBufSize = 5;\n\n\tif (pBtCoexist->bManualControl || pBtCoexist->bStopCoexDm)\n\t\treturn;\n\n\tif (type == BTC_SCAN_START) {\n\t\tpCoexSta->bWiFiIsHighPriTask = true;\n\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, FORCE_EXEC, false, 8);   \n\t\tpBtCoexist->fBtcRead4Byte(pBtCoexist, 0x948);\n\t\tpBtCoexist->fBtcRead1Byte(pBtCoexist, 0x765);\n\t\tpBtCoexist->fBtcRead1Byte(pBtCoexist, 0x67);\n\t} else {\n\t\tpCoexSta->bWiFiIsHighPriTask = false;\n\n\t\tpBtCoexist->fBtcGet(\n\t\t\tpBtCoexist, BTC_GET_U1_AP_NUM, &pCoexSta->nScanAPNum\n\t\t);\n\t}\n\n\tif (pBtCoexist->btInfo.bBtDisabled)\n\t\treturn;\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\n\n\thalbtc8723b1ant_QueryBtInfo(pBtCoexist);\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_U4_WIFI_LINK_STATUS, &wifiLinkStatus);\n\tnumOfWifiLink = wifiLinkStatus >> 16;\n\n\tif (numOfWifiLink >= 2) {\n\t\thalbtc8723b1ant_LimitedTx(pBtCoexist, NORMAL_EXEC, 0, 0, 0, 0);\n\t\thalbtc8723b1ant_LimitedRx(\n\t\t\tpBtCoexist, NORMAL_EXEC, false, bBtCtrlAggBufSize, aggBufSize\n\t\t);\n\t\thalbtc8723b1ant_ActionWifiMultiPort(pBtCoexist);\n\t\treturn;\n\t}\n\n\tif (pCoexSta->bC2hBtInquiryPage) {\n\t\thalbtc8723b1ant_ActionBtInquiry(pBtCoexist);\n\t\treturn;\n\t} else if (bBtHsOn) {\n\t\thalbtc8723b1ant_ActionHs(pBtCoexist);\n\t\treturn;\n\t}\n\n\tif (type == BTC_SCAN_START) {\n\t\tif (!bWifiConnected)\t \n\t\t\thalbtc8723b1ant_ActionWifiNotConnectedScan(pBtCoexist);\n\t\telse\t \n\t\t\thalbtc8723b1ant_ActionWifiConnectedScan(pBtCoexist);\n\t} else if (type == BTC_SCAN_FINISH) {\n\t\tif (!bWifiConnected)\t \n\t\t\thalbtc8723b1ant_ActionWifiNotConnected(pBtCoexist);\n\t\telse\n\t\t\thalbtc8723b1ant_ActionWifiConnected(pBtCoexist);\n\t}\n}\n\nvoid EXhalbtc8723b1ant_ConnectNotify(struct btc_coexist *pBtCoexist, u8 type)\n{\n\tbool bWifiConnected = false, bBtHsOn = false;\n\tu32 wifiLinkStatus = 0;\n\tu32 numOfWifiLink = 0;\n\tbool bBtCtrlAggBufSize = false;\n\tu8 aggBufSize = 5;\n\n\tif (\n\t\tpBtCoexist->bManualControl ||\n\t\tpBtCoexist->bStopCoexDm ||\n\t\tpBtCoexist->btInfo.bBtDisabled\n\t)\n\t\treturn;\n\n\tif (type == BTC_ASSOCIATE_START) {\n\t\tpCoexSta->bWiFiIsHighPriTask = true;\n\t\t pCoexDm->nArpCnt = 0;\n\t} else {\n\t\tpCoexSta->bWiFiIsHighPriTask = false;\n\t\t \n\t}\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_U4_WIFI_LINK_STATUS, &wifiLinkStatus);\n\tnumOfWifiLink = wifiLinkStatus >> 16;\n\tif (numOfWifiLink >= 2) {\n\t\thalbtc8723b1ant_LimitedTx(pBtCoexist, NORMAL_EXEC, 0, 0, 0, 0);\n\t\thalbtc8723b1ant_LimitedRx(pBtCoexist, NORMAL_EXEC, false, bBtCtrlAggBufSize, aggBufSize);\n\t\thalbtc8723b1ant_ActionWifiMultiPort(pBtCoexist);\n\t\treturn;\n\t}\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\n\tif (pCoexSta->bC2hBtInquiryPage) {\n\t\thalbtc8723b1ant_ActionBtInquiry(pBtCoexist);\n\t\treturn;\n\t} else if (bBtHsOn) {\n\t\thalbtc8723b1ant_ActionHs(pBtCoexist);\n\t\treturn;\n\t}\n\n\tif (type == BTC_ASSOCIATE_START) {\n\t\thalbtc8723b1ant_ActionWifiNotConnectedAssoAuth(pBtCoexist);\n\t} else if (type == BTC_ASSOCIATE_FINISH) {\n\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\n\t\tif (!bWifiConnected)  \n\t\t\thalbtc8723b1ant_ActionWifiNotConnected(pBtCoexist);\n\t\telse\n\t\t\thalbtc8723b1ant_ActionWifiConnected(pBtCoexist);\n\t}\n}\n\nvoid EXhalbtc8723b1ant_MediaStatusNotify(struct btc_coexist *pBtCoexist, u8 type)\n{\n\tu8 H2C_Parameter[3] = {0};\n\tu32 wifiBw;\n\tu8 wifiCentralChnl;\n\tbool bWifiUnderBMode = false;\n\n\tif (\n\t\tpBtCoexist->bManualControl ||\n\t\tpBtCoexist->bStopCoexDm ||\n\t\tpBtCoexist->btInfo.bBtDisabled\n\t)\n\t\treturn;\n\n\tif (type == BTC_MEDIA_CONNECT) {\n\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_UNDER_B_MODE, &bWifiUnderBMode);\n\n\t\t \n\t\tif (bWifiUnderBMode) {\n\t\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x6cd, 0x00);  \n\t\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x6cf, 0x00);  \n\t\t} else {\n\t\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x6cd, 0x10);  \n\t\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x6cf, 0x10);  \n\t\t}\n\n\t\tpCoexDm->backupArfrCnt1 = pBtCoexist->fBtcRead4Byte(pBtCoexist, 0x430);\n\t\tpCoexDm->backupArfrCnt2 = pBtCoexist->fBtcRead4Byte(pBtCoexist, 0x434);\n\t\tpCoexDm->backupRetryLimit = pBtCoexist->fBtcRead2Byte(pBtCoexist, 0x42a);\n\t\tpCoexDm->backupAmpduMaxTime = pBtCoexist->fBtcRead1Byte(pBtCoexist, 0x456);\n\t} else {\n\t\tpCoexDm->nArpCnt = 0;\n\n\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x6cd, 0x0);  \n\t\tpBtCoexist->fBtcWrite1Byte(pBtCoexist, 0x6cf, 0x0);  \n\t}\n\n\t \n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_U1_WIFI_CENTRAL_CHNL, &wifiCentralChnl);\n\tif ((type == BTC_MEDIA_CONNECT) && (wifiCentralChnl <= 14)) {\n\t\t \n\t\tH2C_Parameter[0] = 0x0;\n\t\tH2C_Parameter[1] = wifiCentralChnl;\n\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\n\n\t\tif (wifiBw == BTC_WIFI_BW_HT40)\n\t\t\tH2C_Parameter[2] = 0x30;\n\t\telse\n\t\t\tH2C_Parameter[2] = 0x20;\n\t}\n\n\tpCoexDm->wifiChnlInfo[0] = H2C_Parameter[0];\n\tpCoexDm->wifiChnlInfo[1] = H2C_Parameter[1];\n\tpCoexDm->wifiChnlInfo[2] = H2C_Parameter[2];\n\n\tpBtCoexist->fBtcFillH2c(pBtCoexist, 0x66, 3, H2C_Parameter);\n}\n\nvoid EXhalbtc8723b1ant_SpecialPacketNotify(struct btc_coexist *pBtCoexist, u8 type)\n{\n\tbool bBtHsOn = false;\n\tu32 wifiLinkStatus = 0;\n\tu32 numOfWifiLink = 0;\n\tbool bBtCtrlAggBufSize = false;\n\tu8 aggBufSize = 5;\n\n\tif (\n\t\tpBtCoexist->bManualControl ||\n\t\tpBtCoexist->bStopCoexDm ||\n\t\tpBtCoexist->btInfo.bBtDisabled\n\t)\n\t\treturn;\n\n\tif (\n\t\ttype == BTC_PACKET_DHCP ||\n\t\ttype == BTC_PACKET_EAPOL ||\n\t\ttype == BTC_PACKET_ARP\n\t) {\n\t\tif (type == BTC_PACKET_ARP) {\n\t\t\tpCoexDm->nArpCnt++;\n\n\t\t\tif (pCoexDm->nArpCnt >= 10)  \n\t\t\t\tpCoexSta->bWiFiIsHighPriTask = false;\n\t\t\telse\n\t\t\t\tpCoexSta->bWiFiIsHighPriTask = true;\n\t\t} else {\n\t\t\tpCoexSta->bWiFiIsHighPriTask = true;\n\t\t}\n\t} else {\n\t\tpCoexSta->bWiFiIsHighPriTask = false;\n\t}\n\n\tpCoexSta->specialPktPeriodCnt = 0;\n\n\tpBtCoexist->fBtcGet(\n\t\tpBtCoexist, BTC_GET_U4_WIFI_LINK_STATUS, &wifiLinkStatus\n\t);\n\tnumOfWifiLink = wifiLinkStatus >> 16;\n\n\tif (numOfWifiLink >= 2) {\n\t\thalbtc8723b1ant_LimitedTx(pBtCoexist, NORMAL_EXEC, 0, 0, 0, 0);\n\t\thalbtc8723b1ant_LimitedRx(\n\t\t\tpBtCoexist, NORMAL_EXEC, false, bBtCtrlAggBufSize, aggBufSize\n\t\t);\n\t\thalbtc8723b1ant_ActionWifiMultiPort(pBtCoexist);\n\t\treturn;\n\t}\n\n\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\n\tif (pCoexSta->bC2hBtInquiryPage) {\n\t\thalbtc8723b1ant_ActionBtInquiry(pBtCoexist);\n\t\treturn;\n\t} else if (bBtHsOn) {\n\t\thalbtc8723b1ant_ActionHs(pBtCoexist);\n\t\treturn;\n\t}\n\n\tif (\n\t\ttype == BTC_PACKET_DHCP ||\n\t\ttype == BTC_PACKET_EAPOL ||\n\t\t((type == BTC_PACKET_ARP) && (pCoexSta->bWiFiIsHighPriTask))\n\t)\n\t\thalbtc8723b1ant_ActionWifiConnectedSpecialPacket(pBtCoexist);\n}\n\nvoid EXhalbtc8723b1ant_BtInfoNotify(\n\tstruct btc_coexist *pBtCoexist, u8 *tmpBuf, u8 length\n)\n{\n\tu8 btInfo = 0;\n\tu8 i, rspSource = 0;\n\tbool bWifiConnected = false;\n\tbool bBtBusy = false;\n\n\tpCoexSta->bC2hBtInfoReqSent = false;\n\n\trspSource = tmpBuf[0] & 0xf;\n\tif (rspSource >= BT_INFO_SRC_8723B_1ANT_MAX)\n\t\trspSource = BT_INFO_SRC_8723B_1ANT_WIFI_FW;\n\tpCoexSta->btInfoC2hCnt[rspSource]++;\n\n\tfor (i = 0; i < length; i++) {\n\t\tpCoexSta->btInfoC2h[rspSource][i] = tmpBuf[i];\n\t\tif (i == 1)\n\t\t\tbtInfo = tmpBuf[i];\n\t}\n\n\tif (rspSource != BT_INFO_SRC_8723B_1ANT_WIFI_FW) {\n\t\tpCoexSta->btRetryCnt = pCoexSta->btInfoC2h[rspSource][2] & 0xf;\n\n\t\tif (pCoexSta->btRetryCnt >= 1)\n\t\t\tpCoexSta->popEventCnt++;\n\n\t\tif (pCoexSta->btInfoC2h[rspSource][2] & 0x20)\n\t\t\tpCoexSta->bC2hBtPage = true;\n\t\telse\n\t\t\tpCoexSta->bC2hBtPage = false;\n\n\t\tpCoexSta->btRssi = pCoexSta->btInfoC2h[rspSource][3] * 2 - 90;\n\t\t \n\n\t\tpCoexSta->btInfoExt = pCoexSta->btInfoC2h[rspSource][4];\n\n\t\tpCoexSta->bBtTxRxMask = (pCoexSta->btInfoC2h[rspSource][2] & 0x40);\n\t\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_BL_BT_TX_RX_MASK, &pCoexSta->bBtTxRxMask);\n\n\t\tif (!pCoexSta->bBtTxRxMask) {\n\t\t\t \n\t\t\tpBtCoexist->fBtcSetBtReg(pBtCoexist, BTC_BT_REG_RF, 0x3c, 0x15);\n\t\t}\n\n\t\t \n\t\t \n\t\tif (pCoexSta->btInfoExt & BIT1) {\n\t\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\n\t\t\tif (bWifiConnected)\n\t\t\t\tEXhalbtc8723b1ant_MediaStatusNotify(pBtCoexist, BTC_MEDIA_CONNECT);\n\t\t\telse\n\t\t\t\tEXhalbtc8723b1ant_MediaStatusNotify(pBtCoexist, BTC_MEDIA_DISCONNECT);\n\t\t}\n\n\t\tif (pCoexSta->btInfoExt & BIT3) {\n\t\t\tif (!pBtCoexist->bManualControl && !pBtCoexist->bStopCoexDm)\n\t\t\t\thalbtc8723b1ant_IgnoreWlanAct(pBtCoexist, FORCE_EXEC, false);\n\t\t} else {\n\t\t\t \n\t\t}\n\t}\n\n\t \n\tif (btInfo & BT_INFO_8723B_1ANT_B_INQ_PAGE)\n\t\tpCoexSta->bC2hBtInquiryPage = true;\n\telse\n\t\tpCoexSta->bC2hBtInquiryPage = false;\n\n\t \n\tif (!(btInfo & BT_INFO_8723B_1ANT_B_CONNECTION)) {\n\t\tpCoexSta->bBtLinkExist = false;\n\t\tpCoexSta->bPanExist = false;\n\t\tpCoexSta->bA2dpExist = false;\n\t\tpCoexSta->bHidExist = false;\n\t\tpCoexSta->bScoExist = false;\n\t} else {\t \n\t\tpCoexSta->bBtLinkExist = true;\n\t\tif (btInfo & BT_INFO_8723B_1ANT_B_FTP)\n\t\t\tpCoexSta->bPanExist = true;\n\t\telse\n\t\t\tpCoexSta->bPanExist = false;\n\n\t\tif (btInfo & BT_INFO_8723B_1ANT_B_A2DP)\n\t\t\tpCoexSta->bA2dpExist = true;\n\t\telse\n\t\t\tpCoexSta->bA2dpExist = false;\n\n\t\tif (btInfo & BT_INFO_8723B_1ANT_B_HID)\n\t\t\tpCoexSta->bHidExist = true;\n\t\telse\n\t\t\tpCoexSta->bHidExist = false;\n\n\t\tif (btInfo & BT_INFO_8723B_1ANT_B_SCO_ESCO)\n\t\t\tpCoexSta->bScoExist = true;\n\t\telse\n\t\t\tpCoexSta->bScoExist = false;\n\t}\n\n\thalbtc8723b1ant_UpdateBtLinkInfo(pBtCoexist);\n\n\tbtInfo = btInfo & 0x1f;   \n\n\tif (!(btInfo & BT_INFO_8723B_1ANT_B_CONNECTION)) {\n\t\tpCoexDm->btStatus = BT_8723B_1ANT_BT_STATUS_NON_CONNECTED_IDLE;\n\t} else if (btInfo == BT_INFO_8723B_1ANT_B_CONNECTION)\t{\n\t\t \n\t\tpCoexDm->btStatus = BT_8723B_1ANT_BT_STATUS_CONNECTED_IDLE;\n\t} else if (\n\t\t(btInfo & BT_INFO_8723B_1ANT_B_SCO_ESCO) ||\n\t\t(btInfo & BT_INFO_8723B_1ANT_B_SCO_BUSY)\n\t) {\n\t\tpCoexDm->btStatus = BT_8723B_1ANT_BT_STATUS_SCO_BUSY;\n\t} else if (btInfo & BT_INFO_8723B_1ANT_B_ACL_BUSY) {\n\t\tif (pCoexDm->btStatus != BT_8723B_1ANT_BT_STATUS_ACL_BUSY)\n\t\t\tpCoexDm->bAutoTdmaAdjust = false;\n\n\t\tpCoexDm->btStatus = BT_8723B_1ANT_BT_STATUS_ACL_BUSY;\n\t} else {\n\t\tpCoexDm->btStatus = BT_8723B_1ANT_BT_STATUS_MAX;\n\t}\n\n\tif (\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) ||\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_SCO_BUSY) ||\n\t\t(pCoexDm->btStatus == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY)\n\t)\n\t\tbBtBusy = true;\n\telse\n\t\tbBtBusy = false;\n\tpBtCoexist->fBtcSet(pBtCoexist, BTC_SET_BL_BT_TRAFFIC_BUSY, &bBtBusy);\n\n\thalbtc8723b1ant_RunCoexistMechanism(pBtCoexist);\n}\n\nvoid EXhalbtc8723b1ant_HaltNotify(struct btc_coexist *pBtCoexist)\n{\n\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\thalbtc8723b1ant_PsTdma(pBtCoexist, FORCE_EXEC, false, 0);\n\thalbtc8723b1ant_SetAntPath(pBtCoexist, BTC_ANT_PATH_BT, false, true);\n\n\thalbtc8723b1ant_IgnoreWlanAct(pBtCoexist, FORCE_EXEC, true);\n\n\tEXhalbtc8723b1ant_MediaStatusNotify(pBtCoexist, BTC_MEDIA_DISCONNECT);\n\n\tpBtCoexist->bStopCoexDm = true;\n}\n\nvoid EXhalbtc8723b1ant_PnpNotify(struct btc_coexist *pBtCoexist, u8 pnpState)\n{\n\tif (pnpState == BTC_WIFI_PNP_SLEEP) {\n\t\thalbtc8723b1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\t\thalbtc8723b1ant_PsTdma(pBtCoexist, NORMAL_EXEC, false, 0);\n\t\thalbtc8723b1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\n\t\thalbtc8723b1ant_SetAntPath(pBtCoexist, BTC_ANT_PATH_BT, false, true);\n\n\t\tpBtCoexist->bStopCoexDm = true;\n\t} else if (pnpState == BTC_WIFI_PNP_WAKE_UP) {\n\t\tpBtCoexist->bStopCoexDm = false;\n\t\thalbtc8723b1ant_InitHwConfig(pBtCoexist, false, false);\n\t\thalbtc8723b1ant_InitCoexDm(pBtCoexist);\n\t\thalbtc8723b1ant_QueryBtInfo(pBtCoexist);\n\t}\n}\n\nvoid EXhalbtc8723b1ant_Periodical(struct btc_coexist *pBtCoexist)\n{\n\tstatic u8 disVerInfoCnt;\n\tu32 fwVer = 0, btPatchVer = 0;\n\n\tif (disVerInfoCnt <= 5) {\n\t\tdisVerInfoCnt += 1;\n\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_U4_BT_PATCH_VER, &btPatchVer);\n\t\tpBtCoexist->fBtcGet(pBtCoexist, BTC_GET_U4_WIFI_FW_VER, &fwVer);\n\t}\n\n\thalbtc8723b1ant_MonitorBtCtr(pBtCoexist);\n\thalbtc8723b1ant_MonitorWiFiCtr(pBtCoexist);\n\n\tif (\n\t\thalbtc8723b1ant_IsWifiStatusChanged(pBtCoexist) ||\n\t\tpCoexDm->bAutoTdmaAdjust\n\t)\n\t\thalbtc8723b1ant_RunCoexistMechanism(pBtCoexist);\n\n\tpCoexSta->specialPktPeriodCnt++;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}