{
  "module_name": "sdio_ops_linux.c",
  "hash_id": "8a535e8bf768c520e924ed6c3b8d1addf97d2d45426c0384954adb1befdb18d3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8723bs/os_dep/sdio_ops_linux.c",
  "human_readable_source": "\n \n\n#include <drv_types.h>\n#include <rtw_debug.h>\n\nstatic bool rtw_sdio_claim_host_needed(struct sdio_func *func)\n{\n\tstruct dvobj_priv *dvobj = sdio_get_drvdata(func);\n\tstruct sdio_data *sdio_data = &dvobj->intf_data;\n\n\tif (sdio_data->sys_sdio_irq_thd && sdio_data->sys_sdio_irq_thd == current)\n\t\treturn false;\n\treturn true;\n}\n\ninline void rtw_sdio_set_irq_thd(struct dvobj_priv *dvobj, void *thd_hdl)\n{\n\tstruct sdio_data *sdio_data = &dvobj->intf_data;\n\n\tsdio_data->sys_sdio_irq_thd = thd_hdl;\n}\n\n \ns32 _sd_cmd52_read(struct intf_hdl *pintfhdl, u32 addr, u32 cnt, u8 *pdata)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\n\tint err = 0, i;\n\tstruct sdio_func *func;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn err;\n\n\tfunc = psdio->func;\n\n\tfor (i = 0; i < cnt; i++) {\n\t\tpdata[i] = sdio_readb(func, addr + i, &err);\n\t\tif (err)\n\t\t\tbreak;\n\t}\n\treturn err;\n}\n\n \ns32 sd_cmd52_read(struct intf_hdl *pintfhdl, u32 addr, u32 cnt, u8 *pdata)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\n\tint err = 0;\n\tstruct sdio_func *func;\n\tbool claim_needed;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn err;\n\n\tfunc = psdio->func;\n\tclaim_needed = rtw_sdio_claim_host_needed(func);\n\n\tif (claim_needed)\n\t\tsdio_claim_host(func);\n\terr = _sd_cmd52_read(pintfhdl, addr, cnt, pdata);\n\tif (claim_needed)\n\t\tsdio_release_host(func);\n\treturn err;\n}\n\n \ns32 _sd_cmd52_write(struct intf_hdl *pintfhdl, u32 addr, u32 cnt, u8 *pdata)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\n\tint err = 0, i;\n\tstruct sdio_func *func;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn err;\n\n\tfunc = psdio->func;\n\n\tfor (i = 0; i < cnt; i++) {\n\t\tsdio_writeb(func, pdata[i], addr + i, &err);\n\t\tif (err)\n\t\t\tbreak;\n\t}\n\treturn err;\n}\n\n \ns32 sd_cmd52_write(struct intf_hdl *pintfhdl, u32 addr, u32 cnt, u8 *pdata)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\n\tint err = 0;\n\tstruct sdio_func *func;\n\tbool claim_needed;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn err;\n\n\tfunc = psdio->func;\n\tclaim_needed = rtw_sdio_claim_host_needed(func);\n\n\tif (claim_needed)\n\t\tsdio_claim_host(func);\n\terr = _sd_cmd52_write(pintfhdl, addr, cnt, pdata);\n\tif (claim_needed)\n\t\tsdio_release_host(func);\n\treturn err;\n}\n\nu8 sd_read8(struct intf_hdl *pintfhdl, u32 addr, s32 *err)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\n\tu8 v = 0;\n\tstruct sdio_func *func;\n\tbool claim_needed;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn v;\n\n\tfunc = psdio->func;\n\tclaim_needed = rtw_sdio_claim_host_needed(func);\n\n\tif (claim_needed)\n\t\tsdio_claim_host(func);\n\tv = sdio_readb(func, addr, err);\n\tif (claim_needed)\n\t\tsdio_release_host(func);\n\treturn v;\n}\n\nu32 sd_read32(struct intf_hdl *pintfhdl, u32 addr, s32 *err)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\tu32 v = 0;\n\tstruct sdio_func *func;\n\tbool claim_needed;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn v;\n\n\tfunc = psdio->func;\n\tclaim_needed = rtw_sdio_claim_host_needed(func);\n\n\tif (claim_needed)\n\t\tsdio_claim_host(func);\n\tv = sdio_readl(func, addr, err);\n\tif (claim_needed)\n\t\tsdio_release_host(func);\n\n\tif (err && *err) {\n\t\tint i;\n\n\t\t*err = 0;\n\t\tfor (i = 0; i < SD_IO_TRY_CNT; i++) {\n\t\t\tif (claim_needed)\n\t\t\t\tsdio_claim_host(func);\n\t\t\tv = sdio_readl(func, addr, err);\n\t\t\tif (claim_needed)\n\t\t\t\tsdio_release_host(func);\n\n\t\t\tif (*err == 0) {\n\t\t\t\trtw_reset_continual_io_error(psdiodev);\n\t\t\t\tbreak;\n\t\t\t} else {\n\t\t\t\tif ((-ESHUTDOWN == *err) || (-ENODEV == *err))\n\t\t\t\t\tpadapter->bSurpriseRemoved = true;\n\n\t\t\t\tif (rtw_inc_and_chk_continual_io_error(psdiodev) == true) {\n\t\t\t\t\tpadapter->bSurpriseRemoved = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn  v;\n}\n\nvoid sd_write8(struct intf_hdl *pintfhdl, u32 addr, u8 v, s32 *err)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\tstruct sdio_func *func;\n\tbool claim_needed;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn;\n\n\tfunc = psdio->func;\n\tclaim_needed = rtw_sdio_claim_host_needed(func);\n\n\tif (claim_needed)\n\t\tsdio_claim_host(func);\n\tsdio_writeb(func, v, addr, err);\n\tif (claim_needed)\n\t\tsdio_release_host(func);\n}\n\nvoid sd_write32(struct intf_hdl *pintfhdl, u32 addr, u32 v, s32 *err)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\tstruct sdio_func *func;\n\tbool claim_needed;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn;\n\n\tfunc = psdio->func;\n\tclaim_needed = rtw_sdio_claim_host_needed(func);\n\n\tif (claim_needed)\n\t\tsdio_claim_host(func);\n\tsdio_writel(func, v, addr, err);\n\tif (claim_needed)\n\t\tsdio_release_host(func);\n\n\tif (err && *err) {\n\t\tint i;\n\n\t\t*err = 0;\n\t\tfor (i = 0; i < SD_IO_TRY_CNT; i++) {\n\t\t\tif (claim_needed)\n\t\t\t\tsdio_claim_host(func);\n\t\t\tsdio_writel(func, v, addr, err);\n\t\t\tif (claim_needed)\n\t\t\t\tsdio_release_host(func);\n\t\t\tif (*err == 0) {\n\t\t\t\trtw_reset_continual_io_error(psdiodev);\n\t\t\t\tbreak;\n\t\t\t} else {\n\t\t\t\tif ((-ESHUTDOWN == *err) || (-ENODEV == *err))\n\t\t\t\t\tpadapter->bSurpriseRemoved = true;\n\n\t\t\t\tif (rtw_inc_and_chk_continual_io_error(psdiodev) == true) {\n\t\t\t\t\tpadapter->bSurpriseRemoved = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t}\n}\n\n \ns32 _sd_read(struct intf_hdl *pintfhdl, u32 addr, u32 cnt, void *pdata)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\n\tint err = -EPERM;\n\tstruct sdio_func *func;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn err;\n\n\tfunc = psdio->func;\n\n\tif (unlikely((cnt == 1) || (cnt == 2))) {\n\t\tint i;\n\t\tu8 *pbuf = pdata;\n\n\t\tfor (i = 0; i < cnt; i++) {\n\t\t\t*(pbuf + i) = sdio_readb(func, addr + i, &err);\n\n\t\t\tif (err)\n\t\t\t\tbreak;\n\t\t}\n\t\treturn err;\n\t}\n\n\terr = sdio_memcpy_fromio(func, pdata, addr, cnt);\n\n\treturn err;\n}\n\n \ns32 sd_read(struct intf_hdl *pintfhdl, u32 addr, u32 cnt, void *pdata)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\n\tstruct sdio_func *func;\n\tbool claim_needed;\n\ts32 err = -EPERM;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn err;\n\n\tfunc = psdio->func;\n\tclaim_needed = rtw_sdio_claim_host_needed(func);\n\n\tif (claim_needed)\n\t\tsdio_claim_host(func);\n\terr = _sd_read(pintfhdl, addr, cnt, pdata);\n\tif (claim_needed)\n\t\tsdio_release_host(func);\n\treturn err;\n}\n\n \ns32 _sd_write(struct intf_hdl *pintfhdl, u32 addr, u32 cnt, void *pdata)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\n\tstruct sdio_func *func;\n\tu32 size;\n\ts32 err =  -EPERM;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn err;\n\n\tfunc = psdio->func;\n \n\n\tif (unlikely((cnt == 1) || (cnt == 2))) {\n\t\tint i;\n\t\tu8 *pbuf = pdata;\n\n\t\tfor (i = 0; i < cnt; i++) {\n\t\t\tsdio_writeb(func, *(pbuf + i), addr + i, &err);\n\t\t\tif (err)\n\t\t\t\tbreak;\n\t\t}\n\n\t\treturn err;\n\t}\n\n\tsize = cnt;\n\terr = sdio_memcpy_toio(func, addr, pdata, size);\n\n\treturn err;\n}\n\n \ns32 sd_write(struct intf_hdl *pintfhdl, u32 addr, u32 cnt, void *pdata)\n{\n\tstruct adapter *padapter;\n\tstruct dvobj_priv *psdiodev;\n\tstruct sdio_data *psdio;\n\tstruct sdio_func *func;\n\tbool claim_needed;\n\ts32 err =  -EPERM;\n\n\tpadapter = pintfhdl->padapter;\n\tpsdiodev = pintfhdl->pintf_dev;\n\tpsdio = &psdiodev->intf_data;\n\n\tif (padapter->bSurpriseRemoved)\n\t\treturn err;\n\n\tfunc = psdio->func;\n\tclaim_needed = rtw_sdio_claim_host_needed(func);\n\n\tif (claim_needed)\n\t\tsdio_claim_host(func);\n\terr = _sd_write(pintfhdl, addr, cnt, pdata);\n\tif (claim_needed)\n\t\tsdio_release_host(func);\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}