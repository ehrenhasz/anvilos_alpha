{
  "module_name": "key.c",
  "hash_id": "e0a28efe90b2678d2e34df6c0ba8bc2107b9cdb1c996648d421c5aed02491354",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/vt6655/key.c",
  "human_readable_source": "\n \n\n#include \"key.h\"\n#include \"mac.h\"\n\nstatic int vnt_set_keymode(struct ieee80211_hw *hw, u8 *mac_addr,\n\t\t\t   struct ieee80211_key_conf *key, u32 key_type,\n\t\t\t   u32 mode, bool onfly_latch)\n{\n\tstruct vnt_private *priv = hw->priv;\n\tu8 broadcast[6] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff};\n\tu16 key_mode = 0;\n\tu32 entry = 0;\n\tu8 *bssid;\n\tu8 key_inx = key->keyidx;\n\tu8 i;\n\n\tif (mac_addr)\n\t\tbssid = mac_addr;\n\telse\n\t\tbssid = &broadcast[0];\n\n\tif (key_type != VNT_KEY_DEFAULTKEY) {\n\t\tfor (i = 0; i < (MAX_KEY_TABLE - 1); i++) {\n\t\t\tif (!test_bit(i, &priv->key_entry_inuse)) {\n\t\t\t\tset_bit(i, &priv->key_entry_inuse);\n\n\t\t\t\tkey->hw_key_idx = i;\n\t\t\t\tentry = key->hw_key_idx;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tswitch (key_type) {\n\tcase VNT_KEY_DEFAULTKEY:\n\t\t \n\t\tentry = MAX_KEY_TABLE - 1;\n\t\tkey->hw_key_idx = entry;\n\t\tfallthrough;\n\tcase VNT_KEY_ALLGROUP:\n\t\tkey_mode |= VNT_KEY_ALLGROUP;\n\t\tif (onfly_latch)\n\t\t\tkey_mode |= VNT_KEY_ONFLY_ALL;\n\t\tfallthrough;\n\tcase VNT_KEY_GROUP_ADDRESS:\n\t\tkey_mode |= mode;\n\t\tfallthrough;\n\tcase VNT_KEY_GROUP:\n\t\tkey_mode |= (mode << 4);\n\t\tkey_mode |= VNT_KEY_GROUP;\n\t\tbreak;\n\tcase  VNT_KEY_PAIRWISE:\n\t\tkey_mode |= mode;\n\t\tkey_inx = 4;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (onfly_latch)\n\t\tkey_mode |= VNT_KEY_ONFLY;\n\n\tif (mode == KEY_CTL_WEP) {\n\t\tif (key->keylen == WLAN_KEY_LEN_WEP40)\n\t\t\tkey->key[15] &= 0x7f;\n\t\tif (key->keylen == WLAN_KEY_LEN_WEP104)\n\t\t\tkey->key[15] |= 0x80;\n\t}\n\n\tMACvSetKeyEntry(priv, key_mode, entry, key_inx,\n\t\t\tbssid, (u32 *)key->key, priv->local_id);\n\n\treturn 0;\n}\n\nint vnt_set_keys(struct ieee80211_hw *hw, struct ieee80211_sta *sta,\n\t\t struct ieee80211_vif *vif, struct ieee80211_key_conf *key)\n{\n\tstruct ieee80211_bss_conf *conf = &vif->bss_conf;\n\tstruct vnt_private *priv = hw->priv;\n\tu8 *mac_addr = NULL;\n\tu8 key_dec_mode = 0;\n\tint ret = 0;\n\tu32 u;\n\n\tif (sta)\n\t\tmac_addr = &sta->addr[0];\n\n\tswitch (key->cipher) {\n\tcase 0:\n\t\tfor (u = 0 ; u < MAX_KEY_TABLE; u++)\n\t\t\tMACvDisableKeyEntry(priv, u);\n\t\treturn ret;\n\n\tcase WLAN_CIPHER_SUITE_WEP40:\n\tcase WLAN_CIPHER_SUITE_WEP104:\n\t\tfor (u = 0; u < MAX_KEY_TABLE; u++)\n\t\t\tMACvDisableKeyEntry(priv, u);\n\n\t\tvnt_set_keymode(hw, mac_addr,\n\t\t\t\tkey, VNT_KEY_DEFAULTKEY, KEY_CTL_WEP, true);\n\n\t\tkey->flags |= IEEE80211_KEY_FLAG_GENERATE_IV;\n\n\t\treturn ret;\n\tcase WLAN_CIPHER_SUITE_TKIP:\n\t\tkey->flags |= IEEE80211_KEY_FLAG_GENERATE_MMIC;\n\t\tkey->flags |= IEEE80211_KEY_FLAG_GENERATE_IV;\n\n\t\tkey_dec_mode = KEY_CTL_TKIP;\n\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_CCMP:\n\t\tkey_dec_mode = KEY_CTL_CCMP;\n\n\t\tkey->flags |= IEEE80211_KEY_FLAG_GENERATE_IV;\n\t}\n\n\tif (key->flags & IEEE80211_KEY_FLAG_PAIRWISE) {\n\t\tvnt_set_keymode(hw, mac_addr,\n\t\t\t\tkey, VNT_KEY_PAIRWISE, key_dec_mode, true);\n\t} else {\n\t\tvnt_set_keymode(hw, mac_addr,\n\t\t\t\tkey, VNT_KEY_DEFAULTKEY, key_dec_mode, true);\n\n\t\tvnt_set_keymode(hw, (u8 *)conf->bssid,\n\t\t\t\tkey, VNT_KEY_GROUP_ADDRESS, key_dec_mode, true);\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}