{
  "module_name": "rxtx.c",
  "hash_id": "8a278628d91ad775af5296016f35d0470bd12bc5cf1166c87c2790fd9d8c89e9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/vt6655/rxtx.c",
  "human_readable_source": "\n \n\n#include \"device.h\"\n#include \"rxtx.h\"\n#include \"card.h\"\n#include \"mac.h\"\n#include \"baseband.h\"\n#include \"rf.h\"\n\n \n\n \n\n \n\n \n\n \n \n#define CRITICAL_PACKET_LEN      256\n\nstatic const unsigned short time_stamp_off[2][MAX_RATE] = {\n\t{384, 288, 226, 209, 54, 43, 37, 31, 28, 25, 24, 23},  \n\t{384, 192, 130, 113, 54, 43, 37, 31, 28, 25, 24, 23},  \n};\n\nstatic const unsigned short fb_opt0[2][5] = {\n\t{RATE_12M, RATE_18M, RATE_24M, RATE_36M, RATE_48M},  \n\t{RATE_12M, RATE_12M, RATE_18M, RATE_24M, RATE_36M},  \n};\n\nstatic const unsigned short fb_opt1[2][5] = {\n\t{RATE_12M, RATE_18M, RATE_24M, RATE_24M, RATE_36M},  \n\t{RATE_6M,  RATE_6M,  RATE_12M, RATE_12M, RATE_18M},  \n};\n\n#define RTSDUR_BB       0\n#define RTSDUR_BA       1\n#define RTSDUR_AA       2\n#define CTSDUR_BA       3\n#define RTSDUR_BA_F0    4\n#define RTSDUR_AA_F0    5\n#define RTSDUR_BA_F1    6\n#define RTSDUR_AA_F1    7\n#define CTSDUR_BA_F0    8\n#define CTSDUR_BA_F1    9\n#define DATADUR_B       10\n#define DATADUR_A       11\n#define DATADUR_A_F0    12\n#define DATADUR_A_F1    13\n\n \nstatic\nvoid\ns_vFillRTSHead(\n\tstruct vnt_private *pDevice,\n\tunsigned char byPktType,\n\tvoid *pvRTS,\n\tunsigned int\tcbFrameLength,\n\tbool bNeedAck,\n\tbool bDisCRC,\n\tstruct ieee80211_hdr *hdr,\n\tunsigned short wCurrentRate,\n\tunsigned char byFBOption\n);\n\nstatic\nvoid\ns_vGenerateTxParameter(\n\tstruct vnt_private *pDevice,\n\tunsigned char byPktType,\n\tstruct vnt_tx_fifo_head *,\n\tvoid *pvRrvTime,\n\tvoid *pvRTS,\n\tvoid *pvCTS,\n\tunsigned int\tcbFrameSize,\n\tbool bNeedACK,\n\tunsigned int\tuDMAIdx,\n\tvoid *psEthHeader,\n\tunsigned short wCurrentRate\n);\n\nstatic unsigned int\ns_cbFillTxBufHead(struct vnt_private *pDevice, unsigned char byPktType,\n\t\t  unsigned char *pbyTxBufferAddr,\n\t\t  unsigned int uDMAIdx, struct vnt_tx_desc *pHeadTD,\n\t\t  unsigned int uNodeIndex);\n\nstatic\n__le16\ns_uFillDataHead(\n\tstruct vnt_private *pDevice,\n\tunsigned char byPktType,\n\tvoid *pTxDataHead,\n\tunsigned int cbFrameLength,\n\tunsigned int uDMAIdx,\n\tbool bNeedAck,\n\tunsigned int uFragIdx,\n\tunsigned int cbLastFragmentSize,\n\tunsigned int uMACfragNum,\n\tunsigned char byFBOption,\n\tunsigned short wCurrentRate,\n\tbool is_pspoll\n);\n\n \n\nstatic __le16 vnt_time_stamp_off(struct vnt_private *priv, u16 rate)\n{\n\treturn cpu_to_le16(time_stamp_off[priv->preamble_type % 2]\n\t\t\t\t\t\t\t[rate % MAX_RATE]);\n}\n\n \nstatic\nunsigned int\ns_uGetTxRsvTime(\n\tstruct vnt_private *pDevice,\n\tunsigned char byPktType,\n\tunsigned int cbFrameLength,\n\tunsigned short wRate,\n\tbool bNeedAck\n)\n{\n\tunsigned int uDataTime, uAckTime;\n\n\tuDataTime = bb_get_frame_time(pDevice->preamble_type, byPktType, cbFrameLength, wRate);\n\n\tif (!bNeedAck)\n\t\treturn uDataTime;\n\n\t \n\tuAckTime = bb_get_frame_time(pDevice->preamble_type, byPktType, 14,\n\t\t\t\t     byPktType == PK_TYPE_11B ?\n\t\t\t\t     pDevice->byTopCCKBasicRate :\n\t\t\t\t     pDevice->byTopOFDMBasicRate);\n\n\treturn uDataTime + pDevice->uSIFS + uAckTime;\n}\n\nstatic __le16 vnt_rxtx_rsvtime_le16(struct vnt_private *priv, u8 pkt_type,\n\t\t\t\t    u32 frame_length, u16 rate, bool need_ack)\n{\n\treturn cpu_to_le16((u16)s_uGetTxRsvTime(priv, pkt_type,\n\t\t\t\t\t\tframe_length, rate, need_ack));\n}\n\n \nstatic __le16 get_rtscts_time(struct vnt_private *priv,\n\t\t\t      unsigned char rts_rsvtype,\n\t\t\t      unsigned char pkt_type,\n\t\t\t      unsigned int frame_length,\n\t\t\t      unsigned short current_rate)\n{\n\tunsigned int rrv_time = 0;\n\tunsigned int rts_time = 0;\n\tunsigned int cts_time = 0;\n\tunsigned int ack_time = 0;\n\tunsigned int data_time = 0;\n\n\tdata_time = bb_get_frame_time(priv->preamble_type, pkt_type, frame_length, current_rate);\n\tif (rts_rsvtype == 0) {  \n\t\trts_time = bb_get_frame_time(priv->preamble_type, pkt_type, 20, priv->byTopCCKBasicRate);\n\t\tack_time = bb_get_frame_time(priv->preamble_type, pkt_type, 14, priv->byTopCCKBasicRate);\n\t\tcts_time = ack_time;\n\t} else if (rts_rsvtype == 1) {  \n\t\trts_time = bb_get_frame_time(priv->preamble_type, pkt_type, 20, priv->byTopCCKBasicRate);\n\t\tcts_time = bb_get_frame_time(priv->preamble_type, pkt_type, 14, priv->byTopCCKBasicRate);\n\t\tack_time = bb_get_frame_time(priv->preamble_type, pkt_type, 14, priv->byTopOFDMBasicRate);\n\t} else if (rts_rsvtype == 2) {  \n\t\trts_time = bb_get_frame_time(priv->preamble_type, pkt_type, 20, priv->byTopOFDMBasicRate);\n\t\tack_time = bb_get_frame_time(priv->preamble_type, pkt_type, 14, priv->byTopOFDMBasicRate);\n\t\tcts_time = ack_time;\n\t} else if (rts_rsvtype == 3) {  \n\t\tcts_time = bb_get_frame_time(priv->preamble_type, pkt_type, 14, priv->byTopCCKBasicRate);\n\t\tack_time = bb_get_frame_time(priv->preamble_type, pkt_type, 14, priv->byTopOFDMBasicRate);\n\t\trrv_time = cts_time + ack_time + data_time + 2 * priv->uSIFS;\n\t\treturn cpu_to_le16((u16)rrv_time);\n\t}\n\n\t \n\trrv_time = rts_time + cts_time + ack_time + data_time + 3 * priv->uSIFS;\n\treturn cpu_to_le16((u16)rrv_time);\n}\n\n \nstatic\nunsigned int\ns_uGetDataDuration(\n\tstruct vnt_private *pDevice,\n\tunsigned char byDurType,\n\tunsigned int cbFrameLength,\n\tunsigned char byPktType,\n\tunsigned short wRate,\n\tbool bNeedAck,\n\tunsigned int uFragIdx,\n\tunsigned int cbLastFragmentSize,\n\tunsigned int uMACfragNum,\n\tunsigned char byFBOption\n)\n{\n\tbool bLastFrag = false;\n\tunsigned int uAckTime = 0, uNextPktTime = 0, len;\n\n\tif (uFragIdx == (uMACfragNum - 1))\n\t\tbLastFrag = true;\n\n\tif (uFragIdx == (uMACfragNum - 2))\n\t\tlen = cbLastFragmentSize;\n\telse\n\t\tlen = cbFrameLength;\n\n\tswitch (byDurType) {\n\tcase DATADUR_B:     \n\t\tif (bNeedAck) {\n\t\t\tuAckTime = bb_get_frame_time(pDevice->preamble_type,\n\t\t\t\t\t\t     byPktType, 14,\n\t\t\t\t\t\t     pDevice->byTopCCKBasicRate);\n\t\t}\n\t\t \n\t\tif ((uMACfragNum == 1) || bLastFrag) {\n\t\t\tif (!bNeedAck)\n\t\t\t\treturn 0;\n\t\t} else {\n\t\t\t \n\t\t\tuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType,\n\t\t\t\t\t\t       len, wRate, bNeedAck);\n\t\t}\n\n\t\treturn pDevice->uSIFS + uAckTime + uNextPktTime;\n\n\tcase DATADUR_A:     \n\t\tif (bNeedAck) {\n\t\t\tuAckTime = bb_get_frame_time(pDevice->preamble_type,\n\t\t\t\t\t\t     byPktType, 14,\n\t\t\t\t\t\t     pDevice->byTopOFDMBasicRate);\n\t\t}\n\t\t \n\t\tif ((uMACfragNum == 1) || bLastFrag) {\n\t\t\tif (!bNeedAck)\n\t\t\t\treturn 0;\n\t\t} else {\n\t\t\t \n\t\t\tuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType,\n\t\t\t\t\t\t       len, wRate, bNeedAck);\n\t\t}\n\n\t\treturn pDevice->uSIFS + uAckTime + uNextPktTime;\n\n\tcase DATADUR_A_F0:     \n\tcase DATADUR_A_F1:     \n\t\tif (bNeedAck) {\n\t\t\tuAckTime = bb_get_frame_time(pDevice->preamble_type,\n\t\t\t\t\t\t     byPktType, 14,\n\t\t\t\t\t\t     pDevice->byTopOFDMBasicRate);\n\t\t}\n\t\t \n\t\tif ((uMACfragNum == 1) || bLastFrag) {\n\t\t\tif (!bNeedAck)\n\t\t\t\treturn 0;\n\t\t} else {\n\t\t\t \n\t\t\tif (wRate < RATE_18M)\n\t\t\t\twRate = RATE_18M;\n\t\t\telse if (wRate > RATE_54M)\n\t\t\t\twRate = RATE_54M;\n\n\t\t\twRate -= RATE_18M;\n\n\t\t\tif (byFBOption == AUTO_FB_0)\n\t\t\t\twRate = fb_opt0[FB_RATE0][wRate];\n\t\t\telse\n\t\t\t\twRate = fb_opt1[FB_RATE0][wRate];\n\n\t\t\tuNextPktTime = s_uGetTxRsvTime(pDevice, byPktType,\n\t\t\t\t\t\t       len, wRate, bNeedAck);\n\t\t}\n\n\t\treturn pDevice->uSIFS + uAckTime + uNextPktTime;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n \nstatic\n__le16\ns_uGetRTSCTSDuration(\n\tstruct vnt_private *pDevice,\n\tunsigned char byDurType,\n\tunsigned int cbFrameLength,\n\tunsigned char byPktType,\n\tunsigned short wRate,\n\tbool bNeedAck,\n\tunsigned char byFBOption\n)\n{\n\tunsigned int uCTSTime = 0, uDurTime = 0;\n\n\tswitch (byDurType) {\n\tcase RTSDUR_BB:     \n\t\tuCTSTime = bb_get_frame_time(pDevice->preamble_type, byPktType, 14, pDevice->byTopCCKBasicRate);\n\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\n\t\tbreak;\n\n\tcase RTSDUR_BA:     \n\t\tuCTSTime = bb_get_frame_time(pDevice->preamble_type, byPktType, 14, pDevice->byTopCCKBasicRate);\n\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\n\t\tbreak;\n\n\tcase RTSDUR_AA:     \n\t\tuCTSTime = bb_get_frame_time(pDevice->preamble_type, byPktType, 14, pDevice->byTopOFDMBasicRate);\n\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\n\t\tbreak;\n\n\tcase CTSDUR_BA:     \n\t\tuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, wRate, bNeedAck);\n\t\tbreak;\n\n\tcase RTSDUR_BA_F0:  \n\t\tuCTSTime = bb_get_frame_time(pDevice->preamble_type, byPktType, 14, pDevice->byTopCCKBasicRate);\n\t\tif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt0[FB_RATE0][wRate - RATE_18M], bNeedAck);\n\t\telse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt1[FB_RATE0][wRate - RATE_18M], bNeedAck);\n\n\t\tbreak;\n\n\tcase RTSDUR_AA_F0:  \n\t\tuCTSTime = bb_get_frame_time(pDevice->preamble_type, byPktType, 14, pDevice->byTopOFDMBasicRate);\n\t\tif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt0[FB_RATE0][wRate - RATE_18M], bNeedAck);\n\t\telse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt1[FB_RATE0][wRate - RATE_18M], bNeedAck);\n\n\t\tbreak;\n\n\tcase RTSDUR_BA_F1:  \n\t\tuCTSTime = bb_get_frame_time(pDevice->preamble_type, byPktType, 14, pDevice->byTopCCKBasicRate);\n\t\tif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt0[FB_RATE1][wRate - RATE_18M], bNeedAck);\n\t\telse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt1[FB_RATE1][wRate - RATE_18M], bNeedAck);\n\n\t\tbreak;\n\n\tcase RTSDUR_AA_F1:  \n\t\tuCTSTime = bb_get_frame_time(pDevice->preamble_type, byPktType, 14, pDevice->byTopOFDMBasicRate);\n\t\tif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt0[FB_RATE1][wRate - RATE_18M], bNeedAck);\n\t\telse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = uCTSTime + 2 * pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt1[FB_RATE1][wRate - RATE_18M], bNeedAck);\n\n\t\tbreak;\n\n\tcase CTSDUR_BA_F0:  \n\t\tif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt0[FB_RATE0][wRate - RATE_18M], bNeedAck);\n\t\telse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt1[FB_RATE0][wRate - RATE_18M], bNeedAck);\n\n\t\tbreak;\n\n\tcase CTSDUR_BA_F1:  \n\t\tif ((byFBOption == AUTO_FB_0) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt0[FB_RATE1][wRate - RATE_18M], bNeedAck);\n\t\telse if ((byFBOption == AUTO_FB_1) && (wRate >= RATE_18M) && (wRate <= RATE_54M))\n\t\t\tuDurTime = pDevice->uSIFS + s_uGetTxRsvTime(pDevice, byPktType, cbFrameLength, fb_opt1[FB_RATE1][wRate - RATE_18M], bNeedAck);\n\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn cpu_to_le16((u16)uDurTime);\n}\n\nstatic\n__le16\ns_uFillDataHead(\n\tstruct vnt_private *pDevice,\n\tunsigned char byPktType,\n\tvoid *pTxDataHead,\n\tunsigned int cbFrameLength,\n\tunsigned int uDMAIdx,\n\tbool bNeedAck,\n\tunsigned int uFragIdx,\n\tunsigned int cbLastFragmentSize,\n\tunsigned int uMACfragNum,\n\tunsigned char byFBOption,\n\tunsigned short wCurrentRate,\n\tbool is_pspoll\n)\n{\n\tstruct vnt_tx_datahead_ab *buf = pTxDataHead;\n\n\tif (!pTxDataHead)\n\t\treturn 0;\n\n\tif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) {\n\t\t \n\t\tstruct vnt_tx_datahead_g_fb *buf = pTxDataHead;\n\n\t\tif (byFBOption == AUTO_FB_NONE) {\n\t\t\tstruct vnt_tx_datahead_g *buf = pTxDataHead;\n\t\t\t \n\t\t\tvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\n\t\t\t\t\t  byPktType, &buf->a);\n\n\t\t\tvnt_get_phy_field(pDevice, cbFrameLength,\n\t\t\t\t\t  pDevice->byTopCCKBasicRate,\n\t\t\t\t\t  PK_TYPE_11B, &buf->b);\n\n\t\t\tif (is_pspoll) {\n\t\t\t\t__le16 dur = cpu_to_le16(pDevice->current_aid | BIT(14) | BIT(15));\n\n\t\t\t\tbuf->duration_a = dur;\n\t\t\t\tbuf->duration_b = dur;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tbuf->duration_a =\n\t\t\t\t\tcpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A, cbFrameLength,\n\t\t\t\t\t\t\t\t\t    byPktType, wCurrentRate, bNeedAck, uFragIdx,\n\t\t\t\t\t\t\t\t\t    cbLastFragmentSize, uMACfragNum,\n\t\t\t\t\t\t\t\t\t    byFBOption));\n\t\t\t\tbuf->duration_b =\n\t\t\t\t\tcpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_B, cbFrameLength,\n\t\t\t\t\t\t\t\t\t    PK_TYPE_11B, pDevice->byTopCCKBasicRate,\n\t\t\t\t\t\t\t\t\t    bNeedAck, uFragIdx, cbLastFragmentSize,\n\t\t\t\t\t\t\t\t\t    uMACfragNum, byFBOption));\n\t\t\t}\n\n\t\t\tbuf->time_stamp_off_a = vnt_time_stamp_off(pDevice, wCurrentRate);\n\t\t\tbuf->time_stamp_off_b = vnt_time_stamp_off(pDevice, pDevice->byTopCCKBasicRate);\n\n\t\t\treturn buf->duration_a;\n\t\t}\n\n\t\t \n\t\tvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\n\t\t\t\t  byPktType, &buf->a);\n\n\t\tvnt_get_phy_field(pDevice, cbFrameLength,\n\t\t\t\t  pDevice->byTopCCKBasicRate,\n\t\t\t\t  PK_TYPE_11B, &buf->b);\n\t\t \n\t\tbuf->duration_a = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A, cbFrameLength, byPktType,\n\t\t\t\t\t\t\t\t      wCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\n\t\tbuf->duration_b = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_B, cbFrameLength, PK_TYPE_11B,\n\t\t\t\t\t\t\t\t       pDevice->byTopCCKBasicRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\n\t\tbuf->duration_a_f0 = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A_F0, cbFrameLength, byPktType,\n\t\t\t\t\t\t\t\t\t  wCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\n\t\tbuf->duration_a_f1 = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A_F1, cbFrameLength, byPktType,\n\t\t\t\t\t\t\t\t\t wCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\n\n\t\tbuf->time_stamp_off_a = vnt_time_stamp_off(pDevice, wCurrentRate);\n\t\tbuf->time_stamp_off_b = vnt_time_stamp_off(pDevice, pDevice->byTopCCKBasicRate);\n\n\t\treturn buf->duration_a;\n\t\t   \n\t} else if (byPktType == PK_TYPE_11A) {\n\t\tstruct vnt_tx_datahead_ab *buf = pTxDataHead;\n\n\t\tif (byFBOption != AUTO_FB_NONE) {\n\t\t\t \n\t\t\tstruct vnt_tx_datahead_a_fb *buf = pTxDataHead;\n\t\t\t \n\t\t\tvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\n\t\t\t\t\t  byPktType, &buf->a);\n\n\t\t\t \n\t\t\tbuf->duration = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A, cbFrameLength, byPktType,\n\t\t\t\t\t\t\t\t\t    wCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\n\t\t\tbuf->duration_f0 = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A_F0, cbFrameLength, byPktType,\n\t\t\t\t\t\t\t\t\t       wCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\n\t\t\tbuf->duration_f1 = cpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A_F1, cbFrameLength, byPktType,\n\t\t\t\t\t\t\t\t\t\twCurrentRate, bNeedAck, uFragIdx, cbLastFragmentSize, uMACfragNum, byFBOption));\n\t\t\tbuf->time_stamp_off = vnt_time_stamp_off(pDevice, wCurrentRate);\n\t\t\treturn buf->duration;\n\t\t}\n\n\t\t \n\t\tvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\n\t\t\t\t  byPktType, &buf->ab);\n\n\t\tif (is_pspoll) {\n\t\t\t__le16 dur = cpu_to_le16(pDevice->current_aid | BIT(14) | BIT(15));\n\n\t\t\tbuf->duration = dur;\n\t\t} else {\n\t\t\t \n\t\t\tbuf->duration =\n\t\t\t\tcpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_A, cbFrameLength, byPktType,\n\t\t\t\t\t\t\t\t    wCurrentRate, bNeedAck, uFragIdx,\n\t\t\t\t\t\t\t\t    cbLastFragmentSize, uMACfragNum,\n\t\t\t\t\t\t\t\t    byFBOption));\n\t\t}\n\n\t\tbuf->time_stamp_off = vnt_time_stamp_off(pDevice, wCurrentRate);\n\t\treturn buf->duration;\n\t}\n\n\t \n\tvnt_get_phy_field(pDevice, cbFrameLength, wCurrentRate,\n\t\t\t  byPktType, &buf->ab);\n\n\tif (is_pspoll) {\n\t\t__le16 dur = cpu_to_le16(pDevice->current_aid | BIT(14) | BIT(15));\n\n\t\tbuf->duration = dur;\n\t} else {\n\t\t \n\t\tbuf->duration =\n\t\t\tcpu_to_le16((u16)s_uGetDataDuration(pDevice, DATADUR_B, cbFrameLength, byPktType,\n\t\t\t\t\t\t\t    wCurrentRate, bNeedAck, uFragIdx,\n\t\t\t\t\t\t\t    cbLastFragmentSize, uMACfragNum,\n\t\t\t\t\t\t\t    byFBOption));\n\t}\n\n\tbuf->time_stamp_off = vnt_time_stamp_off(pDevice, wCurrentRate);\n\treturn buf->duration;\n}\n\nstatic\nvoid\ns_vFillRTSHead(\n\tstruct vnt_private *pDevice,\n\tunsigned char byPktType,\n\tvoid *pvRTS,\n\tunsigned int cbFrameLength,\n\tbool bNeedAck,\n\tbool bDisCRC,\n\tstruct ieee80211_hdr *hdr,\n\tunsigned short wCurrentRate,\n\tunsigned char byFBOption\n)\n{\n\tunsigned int uRTSFrameLen = 20;\n\n\tif (!pvRTS)\n\t\treturn;\n\n\tif (bDisCRC) {\n\t\t \n\t\tuRTSFrameLen -= 4;\n\t}\n\n\t \n\tif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) {\n\t\tif (byFBOption == AUTO_FB_NONE) {\n\t\t\tstruct vnt_rts_g *buf = pvRTS;\n\t\t\t \n\t\t\tvnt_get_phy_field(pDevice, uRTSFrameLen,\n\t\t\t\t\t  pDevice->byTopCCKBasicRate,\n\t\t\t\t\t  PK_TYPE_11B, &buf->b);\n\n\t\t\tvnt_get_phy_field(pDevice, uRTSFrameLen,\n\t\t\t\t\t  pDevice->byTopOFDMBasicRate,\n\t\t\t\t\t  byPktType, &buf->a);\n\t\t\t \n\t\t\tbuf->duration_bb =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_BB,\n\t\t\t\t\t\t     cbFrameLength, PK_TYPE_11B,\n\t\t\t\t\t\t     pDevice->byTopCCKBasicRate,\n\t\t\t\t\t\t     bNeedAck, byFBOption);\n\t\t\tbuf->duration_aa =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_AA,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->duration_ba =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_BA,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\n\t\t\tbuf->data.duration = buf->duration_aa;\n\t\t\t \n\t\t\tbuf->data.frame_control =\n\t\t\t\t\tcpu_to_le16(IEEE80211_FTYPE_CTL |\n\t\t\t\t\t\t    IEEE80211_STYPE_RTS);\n\n\t\t\tether_addr_copy(buf->data.ra, hdr->addr1);\n\t\t\tether_addr_copy(buf->data.ta, hdr->addr2);\n\t\t} else {\n\t\t\tstruct vnt_rts_g_fb *buf = pvRTS;\n\t\t\t \n\t\t\tvnt_get_phy_field(pDevice, uRTSFrameLen,\n\t\t\t\t\t  pDevice->byTopCCKBasicRate,\n\t\t\t\t\t  PK_TYPE_11B, &buf->b);\n\n\t\t\tvnt_get_phy_field(pDevice, uRTSFrameLen,\n\t\t\t\t\t  pDevice->byTopOFDMBasicRate,\n\t\t\t\t\t  byPktType, &buf->a);\n\t\t\t \n\t\t\tbuf->duration_bb =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_BB,\n\t\t\t\t\t\t     cbFrameLength, PK_TYPE_11B,\n\t\t\t\t\t\t     pDevice->byTopCCKBasicRate,\n\t\t\t\t\t\t     bNeedAck, byFBOption);\n\t\t\tbuf->duration_aa =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_AA,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->duration_ba =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_BA,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->rts_duration_ba_f0 =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_BA_F0,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->rts_duration_aa_f0 =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_AA_F0,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->rts_duration_ba_f1 =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_BA_F1,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->rts_duration_aa_f1 =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_AA_F1,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->data.duration = buf->duration_aa;\n\t\t\t \n\t\t\tbuf->data.frame_control =\n\t\t\t\t\tcpu_to_le16(IEEE80211_FTYPE_CTL |\n\t\t\t\t\t\t    IEEE80211_STYPE_RTS);\n\n\t\t\tether_addr_copy(buf->data.ra, hdr->addr1);\n\t\t\tether_addr_copy(buf->data.ta, hdr->addr2);\n\t\t}  \n\t} else if (byPktType == PK_TYPE_11A) {\n\t\tif (byFBOption == AUTO_FB_NONE) {\n\t\t\tstruct vnt_rts_ab *buf = pvRTS;\n\t\t\t \n\t\t\tvnt_get_phy_field(pDevice, uRTSFrameLen,\n\t\t\t\t\t  pDevice->byTopOFDMBasicRate,\n\t\t\t\t\t  byPktType, &buf->ab);\n\t\t\t \n\t\t\tbuf->duration =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_AA,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->data.duration = buf->duration;\n\t\t\t \n\t\t\tbuf->data.frame_control =\n\t\t\t\t\tcpu_to_le16(IEEE80211_FTYPE_CTL |\n\t\t\t\t\t\t    IEEE80211_STYPE_RTS);\n\n\t\t\tether_addr_copy(buf->data.ra, hdr->addr1);\n\t\t\tether_addr_copy(buf->data.ta, hdr->addr2);\n\t\t} else {\n\t\t\tstruct vnt_rts_a_fb *buf = pvRTS;\n\t\t\t \n\t\t\tvnt_get_phy_field(pDevice, uRTSFrameLen,\n\t\t\t\t\t  pDevice->byTopOFDMBasicRate,\n\t\t\t\t\t  byPktType, &buf->a);\n\t\t\t \n\t\t\tbuf->duration =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_AA,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->rts_duration_f0 =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_AA_F0,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->rts_duration_f1 =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_AA_F1,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\t\t\tbuf->data.duration = buf->duration;\n\t\t\t \n\t\t\tbuf->data.frame_control =\n\t\t\t\t\tcpu_to_le16(IEEE80211_FTYPE_CTL |\n\t\t\t\t\t\t    IEEE80211_STYPE_RTS);\n\n\t\t\tether_addr_copy(buf->data.ra, hdr->addr1);\n\t\t\tether_addr_copy(buf->data.ta, hdr->addr2);\n\t\t}\n\t} else if (byPktType == PK_TYPE_11B) {\n\t\tstruct vnt_rts_ab *buf = pvRTS;\n\t\t \n\t\tvnt_get_phy_field(pDevice, uRTSFrameLen,\n\t\t\t\t  pDevice->byTopCCKBasicRate,\n\t\t\t\t  PK_TYPE_11B, &buf->ab);\n\t\t \n\t\tbuf->duration =\n\t\t\ts_uGetRTSCTSDuration(pDevice, RTSDUR_BB, cbFrameLength,\n\t\t\t\t\t     byPktType, wCurrentRate, bNeedAck,\n\t\t\t\t\t     byFBOption);\n\n\t\tbuf->data.duration = buf->duration;\n\t\t \n\t\tbuf->data.frame_control =\n\t\t\tcpu_to_le16(IEEE80211_FTYPE_CTL | IEEE80211_STYPE_RTS);\n\n\t\tether_addr_copy(buf->data.ra, hdr->addr1);\n\t\tether_addr_copy(buf->data.ta, hdr->addr2);\n\t}\n}\n\nstatic\nvoid\ns_vFillCTSHead(\n\tstruct vnt_private *pDevice,\n\tunsigned int uDMAIdx,\n\tunsigned char byPktType,\n\tvoid *pvCTS,\n\tunsigned int cbFrameLength,\n\tbool bNeedAck,\n\tbool bDisCRC,\n\tunsigned short wCurrentRate,\n\tunsigned char byFBOption\n)\n{\n\tunsigned int uCTSFrameLen = 14;\n\n\tif (!pvCTS)\n\t\treturn;\n\n\tif (bDisCRC) {\n\t\t \n\t\tuCTSFrameLen -= 4;\n\t}\n\n\tif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) {\n\t\tif (byFBOption != AUTO_FB_NONE && uDMAIdx != TYPE_ATIMDMA && uDMAIdx != TYPE_BEACONDMA) {\n\t\t\t \n\t\t\tstruct vnt_cts_fb *buf = pvCTS;\n\t\t\t \n\t\t\tvnt_get_phy_field(pDevice, uCTSFrameLen,\n\t\t\t\t\t  pDevice->byTopCCKBasicRate,\n\t\t\t\t\t  PK_TYPE_11B, &buf->b);\n\n\t\t\tbuf->duration_ba =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, CTSDUR_BA,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\n\t\t\t \n\t\t\tbuf->cts_duration_ba_f0 =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, CTSDUR_BA_F0,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\n\t\t\t \n\t\t\tbuf->cts_duration_ba_f1 =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, CTSDUR_BA_F1,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\n\t\t\t \n\t\t\tbuf->data.duration = buf->duration_ba;\n\n\t\t\tbuf->data.frame_control =\n\t\t\t\tcpu_to_le16(IEEE80211_FTYPE_CTL |\n\t\t\t\t\t    IEEE80211_STYPE_CTS);\n\n\t\t\tbuf->reserved2 = 0x0;\n\n\t\t\tether_addr_copy(buf->data.ra,\n\t\t\t\t\tpDevice->abyCurrentNetAddr);\n\t\t} else {  \n\t\t\tstruct vnt_cts *buf = pvCTS;\n\t\t\t \n\t\t\tvnt_get_phy_field(pDevice, uCTSFrameLen,\n\t\t\t\t\t  pDevice->byTopCCKBasicRate,\n\t\t\t\t\t  PK_TYPE_11B, &buf->b);\n\n\t\t\t \n\t\t\tbuf->duration_ba =\n\t\t\t\ts_uGetRTSCTSDuration(pDevice, CTSDUR_BA,\n\t\t\t\t\t\t     cbFrameLength, byPktType,\n\t\t\t\t\t\t     wCurrentRate, bNeedAck,\n\t\t\t\t\t\t     byFBOption);\n\n\t\t\t \n\t\t\tbuf->data.duration = buf->duration_ba;\n\n\t\t\tbuf->data.frame_control =\n\t\t\t\tcpu_to_le16(IEEE80211_FTYPE_CTL |\n\t\t\t\t\t    IEEE80211_STYPE_CTS);\n\n\t\t\tbuf->reserved2 = 0x0;\n\t\t\tether_addr_copy(buf->data.ra,\n\t\t\t\t\tpDevice->abyCurrentNetAddr);\n\t\t}\n\t}\n}\n\n \nstatic\nvoid\ns_vGenerateTxParameter(\n\tstruct vnt_private *pDevice,\n\tunsigned char byPktType,\n\tstruct vnt_tx_fifo_head *tx_buffer_head,\n\tvoid *pvRrvTime,\n\tvoid *pvRTS,\n\tvoid *pvCTS,\n\tunsigned int cbFrameSize,\n\tbool bNeedACK,\n\tunsigned int uDMAIdx,\n\tvoid *psEthHeader,\n\tunsigned short wCurrentRate\n)\n{\n\tu16 fifo_ctl = le16_to_cpu(tx_buffer_head->fifo_ctl);\n\tbool bDisCRC = false;\n\tunsigned char byFBOption = AUTO_FB_NONE;\n\n\ttx_buffer_head->current_rate = cpu_to_le16(wCurrentRate);\n\n\tif (fifo_ctl & FIFOCTL_CRCDIS)\n\t\tbDisCRC = true;\n\n\tif (fifo_ctl & FIFOCTL_AUTO_FB_0)\n\t\tbyFBOption = AUTO_FB_0;\n\telse if (fifo_ctl & FIFOCTL_AUTO_FB_1)\n\t\tbyFBOption = AUTO_FB_1;\n\n\tif (!pvRrvTime)\n\t\treturn;\n\n\tif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) {\n\t\tif (pvRTS) {  \n\t\t\t \n\t\t\tstruct vnt_rrv_time_rts *buf = pvRrvTime;\n\n\t\t\tbuf->rts_rrv_time_aa = get_rtscts_time(pDevice, 2, byPktType, cbFrameSize, wCurrentRate);\n\t\t\tbuf->rts_rrv_time_ba = get_rtscts_time(pDevice, 1, byPktType, cbFrameSize, wCurrentRate);\n\t\t\tbuf->rts_rrv_time_bb = get_rtscts_time(pDevice, 0, byPktType, cbFrameSize, wCurrentRate);\n\t\t\tbuf->rrv_time_a = vnt_rxtx_rsvtime_le16(pDevice, byPktType, cbFrameSize, wCurrentRate, bNeedACK);\n\t\t\tbuf->rrv_time_b = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11B, cbFrameSize, pDevice->byTopCCKBasicRate, bNeedACK);\n\n\t\t\ts_vFillRTSHead(pDevice, byPktType, pvRTS, cbFrameSize, bNeedACK, bDisCRC, psEthHeader, wCurrentRate, byFBOption);\n\t\t} else { \n\t\t\tstruct vnt_rrv_time_cts *buf = pvRrvTime;\n\n\t\t\tbuf->rrv_time_a = vnt_rxtx_rsvtime_le16(pDevice, byPktType, cbFrameSize, wCurrentRate, bNeedACK);\n\t\t\tbuf->rrv_time_b = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11B, cbFrameSize, pDevice->byTopCCKBasicRate, bNeedACK);\n\t\t\tbuf->cts_rrv_time_ba = get_rtscts_time(pDevice, 3, byPktType, cbFrameSize, wCurrentRate);\n\n\t\t\t \n\t\t\ts_vFillCTSHead(pDevice, uDMAIdx, byPktType, pvCTS, cbFrameSize, bNeedACK, bDisCRC, wCurrentRate, byFBOption);\n\t\t}\n\t} else if (byPktType == PK_TYPE_11A) {\n\t\tif (pvRTS) { \n\t\t\tstruct vnt_rrv_time_ab *buf = pvRrvTime;\n\n\t\t\tbuf->rts_rrv_time = get_rtscts_time(pDevice, 2, byPktType, cbFrameSize, wCurrentRate);\n\t\t\tbuf->rrv_time = vnt_rxtx_rsvtime_le16(pDevice, byPktType, cbFrameSize, wCurrentRate, bNeedACK);\n\n\t\t\t \n\t\t\ts_vFillRTSHead(pDevice, byPktType, pvRTS, cbFrameSize, bNeedACK, bDisCRC, psEthHeader, wCurrentRate, byFBOption);\n\t\t} else if (!pvRTS) { \n\t\t\tstruct vnt_rrv_time_ab *buf = pvRrvTime;\n\n\t\t\tbuf->rrv_time = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11A, cbFrameSize, wCurrentRate, bNeedACK);\n\t\t}\n\t} else if (byPktType == PK_TYPE_11B) {\n\t\tif (pvRTS) { \n\t\t\tstruct vnt_rrv_time_ab *buf = pvRrvTime;\n\n\t\t\tbuf->rts_rrv_time = get_rtscts_time(pDevice, 0, byPktType, cbFrameSize, wCurrentRate);\n\t\t\tbuf->rrv_time = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11B, cbFrameSize, wCurrentRate, bNeedACK);\n\n\t\t\t \n\t\t\ts_vFillRTSHead(pDevice, byPktType, pvRTS, cbFrameSize, bNeedACK, bDisCRC, psEthHeader, wCurrentRate, byFBOption);\n\t\t} else {  \n\t\t\tstruct vnt_rrv_time_ab *buf = pvRrvTime;\n\n\t\t\tbuf->rrv_time = vnt_rxtx_rsvtime_le16(pDevice, PK_TYPE_11B, cbFrameSize, wCurrentRate, bNeedACK);\n\t\t}\n\t}\n}\n\nstatic unsigned int\ns_cbFillTxBufHead(struct vnt_private *pDevice, unsigned char byPktType,\n\t\t  unsigned char *pbyTxBufferAddr,\n\t\t  unsigned int uDMAIdx, struct vnt_tx_desc *pHeadTD,\n\t\t  unsigned int is_pspoll)\n{\n\tstruct vnt_td_info *td_info = pHeadTD->td_info;\n\tstruct sk_buff *skb = td_info->skb;\n\tstruct ieee80211_tx_info *info = IEEE80211_SKB_CB(skb);\n\tstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)skb->data;\n\tstruct vnt_tx_fifo_head *tx_buffer_head =\n\t\t\t(struct vnt_tx_fifo_head *)td_info->buf;\n\tu16 fifo_ctl = le16_to_cpu(tx_buffer_head->fifo_ctl);\n\tunsigned int cbFrameSize;\n\t__le16 uDuration;\n\tunsigned char *pbyBuffer;\n\tunsigned int uLength = 0;\n\tunsigned int cbMICHDR = 0;\n\tunsigned int uMACfragNum = 1;\n\tunsigned int uPadding = 0;\n\tunsigned int cbReqCount = 0;\n\tbool bNeedACK = (bool)(fifo_ctl & FIFOCTL_NEEDACK);\n\tbool bRTS = (bool)(fifo_ctl & FIFOCTL_RTS);\n\tstruct vnt_tx_desc *ptdCurr;\n\tunsigned int cbHeaderLength = 0;\n\tvoid *pvRrvTime = NULL;\n\tstruct vnt_mic_hdr *pMICHDR = NULL;\n\tvoid *pvRTS = NULL;\n\tvoid *pvCTS = NULL;\n\tvoid *pvTxDataHd = NULL;\n\tunsigned short wTxBufSize;    \n\tunsigned char byFBOption = AUTO_FB_NONE;\n\n\tcbFrameSize = skb->len + 4;\n\n\tif (info->control.hw_key) {\n\t\tswitch (info->control.hw_key->cipher) {\n\t\tcase WLAN_CIPHER_SUITE_CCMP:\n\t\t\tcbMICHDR = sizeof(struct vnt_mic_hdr);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tcbFrameSize += info->control.hw_key->icv_len;\n\n\t\tif (pDevice->local_id > REV_ID_VT3253_A1) {\n\t\t\t \n\t\t\tuPadding = 4 - (ieee80211_get_hdrlen_from_skb(skb) % 4);\n\t\t\tuPadding %= 4;\n\t\t}\n\t}\n\n\t \n\tif (fifo_ctl & FIFOCTL_AUTO_FB_0)\n\t\tbyFBOption = AUTO_FB_0;\n\telse if (fifo_ctl & FIFOCTL_AUTO_FB_1)\n\t\tbyFBOption = AUTO_FB_1;\n\n\t \n\twTxBufSize = sizeof(struct vnt_tx_fifo_head);\n\tif (byPktType == PK_TYPE_11GB || byPktType == PK_TYPE_11GA) { \n\n\t\tif (byFBOption == AUTO_FB_NONE) {\n\t\t\tif (bRTS) { \n\t\t\t\tpvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\n\t\t\t\tpMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts));\n\t\t\t\tpvRTS = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts) + cbMICHDR);\n\t\t\t\tpvCTS = NULL;\n\t\t\t\tpvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts) +\n\t\t\t\t\t\t\tcbMICHDR + sizeof(struct vnt_rts_g));\n\t\t\t\tcbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_rts) +\n\t\t\t\t\t\t\tcbMICHDR + sizeof(struct vnt_rts_g) +\n\t\t\t\t\t\t\tsizeof(struct vnt_tx_datahead_g);\n\t\t\t} else {  \n\t\t\t\tpvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\n\t\t\t\tpMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts));\n\t\t\t\tpvRTS = NULL;\n\t\t\t\tpvCTS = (void *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts) + cbMICHDR);\n\t\t\t\tpvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize +\n\t\t\t\t\t\tsizeof(struct vnt_rrv_time_cts) + cbMICHDR + sizeof(struct vnt_cts));\n\t\t\t\tcbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_cts) +\n\t\t\t\t\t\t\tcbMICHDR + sizeof(struct vnt_cts) + sizeof(struct vnt_tx_datahead_g);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tif (bRTS) { \n\t\t\t\tpvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\n\t\t\t\tpMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts));\n\t\t\t\tpvRTS = (void *) (pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts) + cbMICHDR);\n\t\t\t\tpvCTS = NULL;\n\t\t\t\tpvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_rts) +\n\t\t\t\t\tcbMICHDR + sizeof(struct vnt_rts_g_fb));\n\t\t\t\tcbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_rts) +\n\t\t\t\t\tcbMICHDR + sizeof(struct vnt_rts_g_fb) + sizeof(struct vnt_tx_datahead_g_fb);\n\t\t\t} else {  \n\t\t\t\tpvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\n\t\t\t\tpMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts));\n\t\t\t\tpvRTS = NULL;\n\t\t\t\tpvCTS = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts) + cbMICHDR);\n\t\t\t\tpvTxDataHd = (void  *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_cts) +\n\t\t\t\t\tcbMICHDR + sizeof(struct vnt_cts_fb));\n\t\t\t\tcbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_cts) +\n\t\t\t\t\tcbMICHDR + sizeof(struct vnt_cts_fb) + sizeof(struct vnt_tx_datahead_g_fb);\n\t\t\t}\n\t\t}  \n\t} else { \n\n\t\tif (byFBOption == AUTO_FB_NONE) {\n\t\t\tif (bRTS) {\n\t\t\t\tpvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\n\t\t\t\tpMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab));\n\t\t\t\tpvRTS = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab) + cbMICHDR);\n\t\t\t\tpvCTS = NULL;\n\t\t\t\tpvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize +\n\t\t\t\t\tsizeof(struct vnt_rrv_time_ab) + cbMICHDR + sizeof(struct vnt_rts_ab));\n\t\t\t\tcbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_ab) +\n\t\t\t\t\tcbMICHDR + sizeof(struct vnt_rts_ab) + sizeof(struct vnt_tx_datahead_ab);\n\t\t\t} else {  \n\t\t\t\tpvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\n\t\t\t\tpMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab));\n\t\t\t\tpvRTS = NULL;\n\t\t\t\tpvCTS = NULL;\n\t\t\t\tpvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab) + cbMICHDR);\n\t\t\t\tcbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_ab) +\n\t\t\t\t\tcbMICHDR + sizeof(struct vnt_tx_datahead_ab);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tif (bRTS) {  \n\t\t\t\tpvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\n\t\t\t\tpMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab));\n\t\t\t\tpvRTS = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab) + cbMICHDR);\n\t\t\t\tpvCTS = NULL;\n\t\t\t\tpvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize +\n\t\t\t\t\tsizeof(struct vnt_rrv_time_ab) + cbMICHDR + sizeof(struct vnt_rts_a_fb));\n\t\t\t\tcbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_ab) +\n\t\t\t\t\tcbMICHDR + sizeof(struct vnt_rts_a_fb) + sizeof(struct vnt_tx_datahead_a_fb);\n\t\t\t} else {  \n\t\t\t\tpvRrvTime = (void *)(pbyTxBufferAddr + wTxBufSize);\n\t\t\t\tpMICHDR = (struct vnt_mic_hdr *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab));\n\t\t\t\tpvRTS = NULL;\n\t\t\t\tpvCTS = NULL;\n\t\t\t\tpvTxDataHd = (void *)(pbyTxBufferAddr + wTxBufSize + sizeof(struct vnt_rrv_time_ab) + cbMICHDR);\n\t\t\t\tcbHeaderLength = wTxBufSize + sizeof(struct vnt_rrv_time_ab) +\n\t\t\t\t\tcbMICHDR + sizeof(struct vnt_tx_datahead_a_fb);\n\t\t\t}\n\t\t}  \n\t}\n\n\ttd_info->mic_hdr = pMICHDR;\n\n\tmemset((void *)(pbyTxBufferAddr + wTxBufSize), 0, (cbHeaderLength - wTxBufSize));\n\n\t \n\ts_vGenerateTxParameter(pDevice, byPktType, tx_buffer_head, pvRrvTime, pvRTS, pvCTS,\n\t\t\t       cbFrameSize, bNeedACK, uDMAIdx, hdr, pDevice->wCurrentRate);\n\t \n\tuDuration = s_uFillDataHead(pDevice, byPktType, pvTxDataHd, cbFrameSize, uDMAIdx, bNeedACK,\n\t\t\t\t    0, 0, uMACfragNum, byFBOption, pDevice->wCurrentRate, is_pspoll);\n\n\thdr->duration_id = uDuration;\n\n\tcbReqCount = cbHeaderLength + uPadding + skb->len;\n\tpbyBuffer = (unsigned char *)pHeadTD->td_info->buf;\n\tuLength = cbHeaderLength + uPadding;\n\n\t \n\tmemcpy((pbyBuffer + uLength), skb->data, skb->len);\n\n\tptdCurr = pHeadTD;\n\n\tptdCurr->td_info->req_count = (u16)cbReqCount;\n\n\treturn cbHeaderLength;\n}\n\nstatic void vnt_fill_txkey(struct ieee80211_hdr *hdr, u8 *key_buffer,\n\t\t\t   struct ieee80211_key_conf *tx_key,\n\t\t\t   struct sk_buff *skb,\tu16 payload_len,\n\t\t\t   struct vnt_mic_hdr *mic_hdr)\n{\n\tu64 pn64;\n\tu8 *iv = ((u8 *)hdr + ieee80211_get_hdrlen_from_skb(skb));\n\n\t \n\tpayload_len -= ieee80211_get_hdrlen_from_skb(skb);\n\tpayload_len -= tx_key->icv_len;\n\n\tswitch (tx_key->cipher) {\n\tcase WLAN_CIPHER_SUITE_WEP40:\n\tcase WLAN_CIPHER_SUITE_WEP104:\n\t\tmemcpy(key_buffer, iv, 3);\n\t\tmemcpy(key_buffer + 3, tx_key->key, tx_key->keylen);\n\n\t\tif (tx_key->keylen == WLAN_KEY_LEN_WEP40) {\n\t\t\tmemcpy(key_buffer + 8, iv, 3);\n\t\t\tmemcpy(key_buffer + 11,\n\t\t\t       tx_key->key, WLAN_KEY_LEN_WEP40);\n\t\t}\n\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_TKIP:\n\t\tieee80211_get_tkip_p2k(tx_key, skb, key_buffer);\n\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_CCMP:\n\n\t\tif (!mic_hdr)\n\t\t\treturn;\n\n\t\tmic_hdr->id = 0x59;\n\t\tmic_hdr->payload_len = cpu_to_be16(payload_len);\n\t\tether_addr_copy(mic_hdr->mic_addr2, hdr->addr2);\n\n\t\tpn64 = atomic64_read(&tx_key->tx_pn);\n\t\tmic_hdr->ccmp_pn[5] = pn64;\n\t\tmic_hdr->ccmp_pn[4] = pn64 >> 8;\n\t\tmic_hdr->ccmp_pn[3] = pn64 >> 16;\n\t\tmic_hdr->ccmp_pn[2] = pn64 >> 24;\n\t\tmic_hdr->ccmp_pn[1] = pn64 >> 32;\n\t\tmic_hdr->ccmp_pn[0] = pn64 >> 40;\n\n\t\tif (ieee80211_has_a4(hdr->frame_control))\n\t\t\tmic_hdr->hlen = cpu_to_be16(28);\n\t\telse\n\t\t\tmic_hdr->hlen = cpu_to_be16(22);\n\n\t\tether_addr_copy(mic_hdr->addr1, hdr->addr1);\n\t\tether_addr_copy(mic_hdr->addr2, hdr->addr2);\n\t\tether_addr_copy(mic_hdr->addr3, hdr->addr3);\n\n\t\tmic_hdr->frame_control = cpu_to_le16(\n\t\t\tle16_to_cpu(hdr->frame_control) & 0xc78f);\n\t\tmic_hdr->seq_ctrl = cpu_to_le16(\n\t\t\t\tle16_to_cpu(hdr->seq_ctrl) & 0xf);\n\n\t\tif (ieee80211_has_a4(hdr->frame_control))\n\t\t\tether_addr_copy(mic_hdr->addr4, hdr->addr4);\n\n\t\tmemcpy(key_buffer, tx_key->key, WLAN_KEY_LEN_CCMP);\n\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nint vnt_generate_fifo_header(struct vnt_private *priv, u32 dma_idx,\n\t\t\t     struct vnt_tx_desc *head_td, struct sk_buff *skb)\n{\n\tstruct vnt_td_info *td_info = head_td->td_info;\n\tstruct ieee80211_tx_info *info = IEEE80211_SKB_CB(skb);\n\tstruct ieee80211_tx_rate *tx_rate = &info->control.rates[0];\n\tstruct ieee80211_rate *rate;\n\tstruct ieee80211_key_conf *tx_key;\n\tstruct ieee80211_hdr *hdr;\n\tstruct vnt_tx_fifo_head *tx_buffer_head =\n\t\t\t(struct vnt_tx_fifo_head *)td_info->buf;\n\tu16 tx_body_size = skb->len, current_rate;\n\tu8 pkt_type;\n\tbool is_pspoll = false;\n\n\tmemset(tx_buffer_head, 0, sizeof(*tx_buffer_head));\n\n\thdr = (struct ieee80211_hdr *)(skb->data);\n\n\trate = ieee80211_get_tx_rate(priv->hw, info);\n\n\tcurrent_rate = rate->hw_value;\n\tif (priv->wCurrentRate != current_rate &&\n\t    !(priv->hw->conf.flags & IEEE80211_CONF_OFFCHANNEL)) {\n\t\tpriv->wCurrentRate = current_rate;\n\n\t\tRFbSetPower(priv, priv->wCurrentRate,\n\t\t\t    priv->hw->conf.chandef.chan->hw_value);\n\t}\n\n\tif (current_rate > RATE_11M) {\n\t\tif (info->band == NL80211_BAND_5GHZ) {\n\t\t\tpkt_type = PK_TYPE_11A;\n\t\t} else {\n\t\t\tif (tx_rate->flags & IEEE80211_TX_RC_USE_CTS_PROTECT)\n\t\t\t\tpkt_type = PK_TYPE_11GB;\n\t\t\telse\n\t\t\t\tpkt_type = PK_TYPE_11GA;\n\t\t}\n\t} else {\n\t\tpkt_type = PK_TYPE_11B;\n\t}\n\n\t \n\tif (pkt_type == PK_TYPE_11A)\n\t\ttx_buffer_head->fifo_ctl = 0;\n\telse if (pkt_type == PK_TYPE_11B)\n\t\ttx_buffer_head->fifo_ctl = cpu_to_le16(FIFOCTL_11B);\n\telse if (pkt_type == PK_TYPE_11GB)\n\t\ttx_buffer_head->fifo_ctl = cpu_to_le16(FIFOCTL_11GB);\n\telse if (pkt_type == PK_TYPE_11GA)\n\t\ttx_buffer_head->fifo_ctl = cpu_to_le16(FIFOCTL_11GA);\n\n\t \n\ttx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_GENINT);\n\n\tif (!ieee80211_is_data(hdr->frame_control)) {\n\t\ttx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_TMOEN);\n\t\ttx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_ISDMA0);\n\t\ttx_buffer_head->time_stamp =\n\t\t\tcpu_to_le16(DEFAULT_MGN_LIFETIME_RES_64us);\n\t} else {\n\t\ttx_buffer_head->time_stamp =\n\t\t\tcpu_to_le16(DEFAULT_MSDU_LIFETIME_RES_64us);\n\t}\n\n\tif (!(info->flags & IEEE80211_TX_CTL_NO_ACK))\n\t\ttx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_NEEDACK);\n\n\tif (ieee80211_has_retry(hdr->frame_control))\n\t\ttx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_LRETRY);\n\n\tif (tx_rate->flags & IEEE80211_TX_RC_USE_SHORT_PREAMBLE)\n\t\tpriv->preamble_type = PREAMBLE_SHORT;\n\telse\n\t\tpriv->preamble_type = PREAMBLE_LONG;\n\n\tif (tx_rate->flags & IEEE80211_TX_RC_USE_RTS_CTS)\n\t\ttx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_RTS);\n\n\tif (ieee80211_has_a4(hdr->frame_control)) {\n\t\ttx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_LHEAD);\n\t\tpriv->bLongHeader = true;\n\t}\n\n\tif (info->flags & IEEE80211_TX_CTL_NO_PS_BUFFER)\n\t\tis_pspoll = true;\n\n\ttx_buffer_head->frag_ctl =\n\t\t\tcpu_to_le16(ieee80211_get_hdrlen_from_skb(skb) << 10);\n\n\tif (info->control.hw_key) {\n\t\tswitch (info->control.hw_key->cipher) {\n\t\tcase WLAN_CIPHER_SUITE_WEP40:\n\t\tcase WLAN_CIPHER_SUITE_WEP104:\n\t\t\ttx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_LEGACY);\n\t\t\tbreak;\n\t\tcase WLAN_CIPHER_SUITE_TKIP:\n\t\t\ttx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_TKIP);\n\t\t\tbreak;\n\t\tcase WLAN_CIPHER_SUITE_CCMP:\n\t\t\ttx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_AES);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\ttx_buffer_head->current_rate = cpu_to_le16(current_rate);\n\n\t \n\tif (current_rate >= RATE_18M && ieee80211_is_data(hdr->frame_control)) {\n\t\tif (priv->byAutoFBCtrl == AUTO_FB_0)\n\t\t\ttx_buffer_head->fifo_ctl |=\n\t\t\t\t\t\tcpu_to_le16(FIFOCTL_AUTO_FB_0);\n\t\telse if (priv->byAutoFBCtrl == AUTO_FB_1)\n\t\t\ttx_buffer_head->fifo_ctl |=\n\t\t\t\t\t\tcpu_to_le16(FIFOCTL_AUTO_FB_1);\n\t}\n\n\ttx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_NONFRAG);\n\n\ts_cbFillTxBufHead(priv, pkt_type, (u8 *)tx_buffer_head,\n\t\t\t  dma_idx, head_td, is_pspoll);\n\n\tif (info->control.hw_key) {\n\t\ttx_key = info->control.hw_key;\n\t\tif (tx_key->keylen > 0)\n\t\t\tvnt_fill_txkey(hdr, tx_buffer_head->tx_key,\n\t\t\t\t       tx_key, skb, tx_body_size,\n\t\t\t\t       td_info->mic_hdr);\n\t}\n\n\treturn 0;\n}\n\nstatic int vnt_beacon_xmit(struct vnt_private *priv,\n\t\t\t   struct sk_buff *skb)\n{\n\tstruct vnt_tx_short_buf_head *short_head =\n\t\t(struct vnt_tx_short_buf_head *)priv->tx_beacon_bufs;\n\tstruct ieee80211_mgmt *mgmt_hdr = (struct ieee80211_mgmt *)\n\t\t\t\t(priv->tx_beacon_bufs + sizeof(*short_head));\n\tstruct ieee80211_tx_info *info;\n\tu32 frame_size = skb->len + 4;\n\tu16 current_rate;\n\n\tmemset(priv->tx_beacon_bufs, 0, sizeof(*short_head));\n\n\tif (priv->byBBType == BB_TYPE_11A) {\n\t\tcurrent_rate = RATE_6M;\n\n\t\t \n\t\tvnt_get_phy_field(priv, frame_size, current_rate,\n\t\t\t\t  PK_TYPE_11A, &short_head->ab);\n\n\t\t \n\t\tshort_head->duration =\n\t\t\tcpu_to_le16((u16)s_uGetDataDuration(priv, DATADUR_B,\n\t\t\t\t    frame_size, PK_TYPE_11A, current_rate,\n\t\t\t\t    false, 0, 0, 1, AUTO_FB_NONE));\n\n\t\tshort_head->time_stamp_off =\n\t\t\t\tvnt_time_stamp_off(priv, current_rate);\n\t} else {\n\t\tcurrent_rate = RATE_1M;\n\t\tshort_head->fifo_ctl |= cpu_to_le16(FIFOCTL_11B);\n\n\t\t \n\t\tvnt_get_phy_field(priv, frame_size, current_rate,\n\t\t\t\t  PK_TYPE_11B, &short_head->ab);\n\n\t\t \n\t\tshort_head->duration =\n\t\t\tcpu_to_le16((u16)s_uGetDataDuration(priv, DATADUR_B,\n\t\t\t\t    frame_size, PK_TYPE_11B, current_rate,\n\t\t\t\t    false, 0, 0, 1, AUTO_FB_NONE));\n\n\t\tshort_head->time_stamp_off =\n\t\t\tvnt_time_stamp_off(priv, current_rate);\n\t}\n\n\tshort_head->fifo_ctl |= cpu_to_le16(FIFOCTL_GENINT);\n\n\t \n\tmemcpy(mgmt_hdr, skb->data, skb->len);\n\n\t \n\tmgmt_hdr->u.beacon.timestamp = 0;\n\n\tinfo = IEEE80211_SKB_CB(skb);\n\tif (info->flags & IEEE80211_TX_CTL_ASSIGN_SEQ) {\n\t\tstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)mgmt_hdr;\n\n\t\thdr->duration_id = 0;\n\t\thdr->seq_ctrl = cpu_to_le16(priv->wSeqCounter << 4);\n\t}\n\n\tpriv->wSeqCounter++;\n\tif (priv->wSeqCounter > 0x0fff)\n\t\tpriv->wSeqCounter = 0;\n\n\tpriv->wBCNBufLen = sizeof(*short_head) + skb->len;\n\n\tiowrite32((u32)priv->tx_beacon_dma, priv->port_offset + MAC_REG_BCNDMAPTR);\n\n\tiowrite16(priv->wBCNBufLen, priv->port_offset + MAC_REG_BCNDMACTL + 2);\n\t \n\tvt6655_mac_reg_bits_on(priv->port_offset, MAC_REG_TCR, TCR_AUTOBCNTX);\n\t \n\tiowrite8(BEACON_READY, priv->port_offset + MAC_REG_BCNDMACTL);\n\n\treturn 0;\n}\n\nint vnt_beacon_make(struct vnt_private *priv, struct ieee80211_vif *vif)\n{\n\tstruct sk_buff *beacon;\n\n\tbeacon = ieee80211_beacon_get(priv->hw, vif, 0);\n\tif (!beacon)\n\t\treturn -ENOMEM;\n\n\tif (vnt_beacon_xmit(priv, beacon)) {\n\t\tieee80211_free_txskb(priv->hw, beacon);\n\t\treturn -ENODEV;\n\t}\n\n\treturn 0;\n}\n\nint vnt_beacon_enable(struct vnt_private *priv, struct ieee80211_vif *vif,\n\t\t      struct ieee80211_bss_conf *conf)\n{\n\tiowrite8(TFTCTL_TSFCNTRST, priv->port_offset + MAC_REG_TFTCTL);\n\n\tiowrite8(TFTCTL_TSFCNTREN, priv->port_offset + MAC_REG_TFTCTL);\n\n\tCARDvSetFirstNextTBTT(priv, conf->beacon_int);\n\n\tCARDbSetBeaconPeriod(priv, conf->beacon_int);\n\n\treturn vnt_beacon_make(priv, vif);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}