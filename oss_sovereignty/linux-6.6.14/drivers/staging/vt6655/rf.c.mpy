{
  "module_name": "rf.c",
  "hash_id": "d9aa77d30369b6e387cf3ee466073f2cff81b7b08c274176135c6d6443fcb221",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/vt6655/rf.c",
  "human_readable_source": "\n \n\n#include \"mac.h\"\n#include \"srom.h\"\n#include \"rf.h\"\n#include \"baseband.h\"\n\n#define BY_AL2230_REG_LEN     23  \n#define CB_AL2230_INIT_SEQ    15\n#define SWITCH_CHANNEL_DELAY_AL2230 200  \n#define AL2230_PWR_IDX_LEN    64\n\n#define BY_AL7230_REG_LEN     23  \n#define CB_AL7230_INIT_SEQ    16\n#define SWITCH_CHANNEL_DELAY_AL7230 200  \n#define AL7230_PWR_IDX_LEN    64\n\nstatic const unsigned long al2230_init_table[CB_AL2230_INIT_SEQ] = {\n\t0x03F79000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x03333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x01A00200 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x00FFF300 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0005A400 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0F4DC500 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0805B600 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0146C700 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x00068800 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0403B900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x00DBBA00 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x00099B00 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0BDFFC00 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x00000D00 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x00580F00 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW\n};\n\nstatic const unsigned long al2230_channel_table0[CB_MAX_CHANNEL] = {\n\t0x03F79000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03F79000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03E79000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03E79000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03F7A000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03F7A000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03E7A000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03E7A000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03F7B000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03F7B000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03E7B000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03E7B000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03F7C000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03E7C000 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW   \n};\n\nstatic const unsigned long al2230_channel_table1[CB_MAX_CHANNEL] = {\n\t0x03333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x0B333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x0B333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x0B333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x0B333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x0B333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x0B333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x03333100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,  \n\t0x06666100 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW   \n};\n\nstatic unsigned long al2230_power_table[AL2230_PWR_IDX_LEN] = {\n\t0x04040900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04041900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04042900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04043900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04044900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04045900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04046900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04047900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04048900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04049900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0404A900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0404B900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0404C900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0404D900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0404E900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0404F900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04050900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04051900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04052900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04053900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04054900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04055900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04056900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04057900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04058900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04059900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0405A900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0405B900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0405C900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0405D900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0405E900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0405F900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04060900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04061900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04062900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04063900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04064900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04065900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04066900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04067900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04068900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04069900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0406A900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0406B900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0406C900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0406D900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0406E900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0406F900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04070900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04071900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04072900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04073900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04074900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04075900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04076900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04077900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04078900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x04079900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0407A900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0407B900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0407C900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0407D900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0407E900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW,\n\t0x0407F900 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW\n};\n\n \nbool IFRFbWriteEmbedded(struct vnt_private *priv, unsigned long dwData)\n{\n\tvoid __iomem *iobase = priv->port_offset;\n\tunsigned short ww;\n\tunsigned long dwValue;\n\n\tiowrite32((u32)dwData, iobase + MAC_REG_IFREGCTL);\n\n\t \n\tfor (ww = 0; ww < W_MAX_TIMEOUT; ww++) {\n\t\tdwValue = ioread32(iobase + MAC_REG_IFREGCTL);\n\t\tif (dwValue & IFREGCTL_DONE)\n\t\t\tbreak;\n\t}\n\n\tif (ww == W_MAX_TIMEOUT)\n\t\treturn false;\n\n\treturn true;\n}\n\n \nstatic bool RFbAL2230Init(struct vnt_private *priv)\n{\n\tvoid __iomem *iobase = priv->port_offset;\n\tint     ii;\n\tbool ret;\n\n\tret = true;\n\n\t \n\tiowrite8(0, iobase + MAC_REG_SOFTPWRCTL);\n\n\tvt6655_mac_word_reg_bits_on(iobase, MAC_REG_SOFTPWRCTL,\n\t\t\t\t    (SOFTPWRCTL_SWPECTI | SOFTPWRCTL_TXPEINV));\n\t \n\tvt6655_mac_word_reg_bits_off(iobase, MAC_REG_SOFTPWRCTL, SOFTPWRCTL_SWPE3);\n\n\t \n\tIFRFbWriteEmbedded(priv, (0x07168700 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW));\n\n\tfor (ii = 0; ii < CB_AL2230_INIT_SEQ; ii++)\n\t\tret &= IFRFbWriteEmbedded(priv, al2230_init_table[ii]);\n\tMACvTimer0MicroSDelay(priv, 30);  \n\n\t \n\tvt6655_mac_word_reg_bits_on(iobase, MAC_REG_SOFTPWRCTL, SOFTPWRCTL_SWPE3);\n\n\tMACvTimer0MicroSDelay(priv, 150); \n\tret &= IFRFbWriteEmbedded(priv, (0x00d80f00 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW));\n\tMACvTimer0MicroSDelay(priv, 30); \n\tret &= IFRFbWriteEmbedded(priv, (0x00780f00 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW));\n\tMACvTimer0MicroSDelay(priv, 30); \n\tret &= IFRFbWriteEmbedded(priv,\n\t\t\t\t  al2230_init_table[CB_AL2230_INIT_SEQ - 1]);\n\n\tvt6655_mac_word_reg_bits_on(iobase, MAC_REG_SOFTPWRCTL, (SOFTPWRCTL_SWPE3    |\n\t\t\t\t\t\t\t\t SOFTPWRCTL_SWPE2    |\n\t\t\t\t\t\t\t\t SOFTPWRCTL_SWPECTI  |\n\t\t\t\t\t\t\t\t SOFTPWRCTL_TXPEINV));\n\n\t \n\tiowrite8(PSSIG_WPE3 | PSSIG_WPE2, iobase + MAC_REG_PSPWRSIG);\n\n\treturn ret;\n}\n\nstatic bool RFbAL2230SelectChannel(struct vnt_private *priv, unsigned char byChannel)\n{\n\tvoid __iomem *iobase = priv->port_offset;\n\tbool ret;\n\n\tret = true;\n\n\tret &= IFRFbWriteEmbedded(priv, al2230_channel_table0[byChannel - 1]);\n\tret &= IFRFbWriteEmbedded(priv, al2230_channel_table1[byChannel - 1]);\n\n\t \n\tiowrite8(byChannel & 0x7F, iobase + MAC_REG_CHANNEL);\n\tMACvTimer0MicroSDelay(priv, SWITCH_CHANNEL_DELAY_AL2230);\n\t \n\tiowrite8(byChannel | 0x80, iobase + MAC_REG_CHANNEL);\n\n\treturn ret;\n}\n\n \nbool RFbInit(struct vnt_private *priv)\n{\n\tbool ret = true;\n\n\tswitch (priv->byRFType) {\n\tcase RF_AIROHA:\n\tcase RF_AL2230S:\n\t\tpriv->max_pwr_level = AL2230_PWR_IDX_LEN;\n\t\tret = RFbAL2230Init(priv);\n\t\tbreak;\n\tcase RF_NOTHING:\n\t\tret = true;\n\t\tbreak;\n\tdefault:\n\t\tret = false;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\n \nbool RFbSelectChannel(struct vnt_private *priv, unsigned char byRFType,\n\t\t      u16 byChannel)\n{\n\tbool ret = true;\n\n\tswitch (byRFType) {\n\tcase RF_AIROHA:\n\tcase RF_AL2230S:\n\t\tret = RFbAL2230SelectChannel(priv, byChannel);\n\t\tbreak;\n\t\t \n\tcase RF_NOTHING:\n\t\tret = true;\n\t\tbreak;\n\tdefault:\n\t\tret = false;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\n \nbool rf_write_wake_prog_syn(struct vnt_private *priv, unsigned char rf_type,\n\t\t\t    u16 channel)\n{\n\tvoid __iomem *iobase = priv->port_offset;\n\tint i;\n\tunsigned char init_count = 0;\n\tunsigned char sleep_count = 0;\n\tunsigned short idx = MISCFIFO_SYNDATA_IDX;\n\n\tiowrite16(0, iobase + MAC_REG_MISCFFNDEX);\n\tswitch (rf_type) {\n\tcase RF_AIROHA:\n\tcase RF_AL2230S:\n\n\t\tif (channel > CB_MAX_CHANNEL_24G)\n\t\t\treturn false;\n\n\t\t  \n\t\tinit_count = CB_AL2230_INIT_SEQ + 2;\n\t\tsleep_count = 0;\n\n\t\tfor (i = 0; i < CB_AL2230_INIT_SEQ; i++)\n\t\t\tMACvSetMISCFifo(priv, idx++, al2230_init_table[i]);\n\n\t\tMACvSetMISCFifo(priv, idx++, al2230_channel_table0[channel - 1]);\n\t\tMACvSetMISCFifo(priv, idx++, al2230_channel_table1[channel - 1]);\n\t\tbreak;\n\n\t\t \n\n\tcase RF_NOTHING:\n\t\treturn true;\n\n\tdefault:\n\t\treturn false;\n\t}\n\n\tMACvSetMISCFifo(priv, MISCFIFO_SYNINFO_IDX, (unsigned long)MAKEWORD(sleep_count, init_count));\n\n\treturn true;\n}\n\n \nbool RFbSetPower(struct vnt_private *priv, unsigned int rate, u16 uCH)\n{\n\tbool ret;\n\tunsigned char byPwr = 0;\n\tunsigned char byDec = 0;\n\n\tif (priv->dwDiagRefCount != 0)\n\t\treturn true;\n\n\tif ((uCH < 1) || (uCH > CB_MAX_CHANNEL))\n\t\treturn false;\n\n\tswitch (rate) {\n\tcase RATE_1M:\n\tcase RATE_2M:\n\tcase RATE_5M:\n\tcase RATE_11M:\n\t\tif (uCH > CB_MAX_CHANNEL_24G)\n\t\t\treturn false;\n\n\t\tbyPwr = priv->abyCCKPwrTbl[uCH];\n\t\tbreak;\n\tcase RATE_6M:\n\tcase RATE_9M:\n\tcase RATE_12M:\n\tcase RATE_18M:\n\t\tbyPwr = priv->abyOFDMPwrTbl[uCH];\n\t\tbyDec = byPwr + 10;\n\n\t\tif (byDec >= priv->max_pwr_level)\n\t\t\tbyDec = priv->max_pwr_level - 1;\n\n\t\tbyPwr = byDec;\n\t\tbreak;\n\tcase RATE_24M:\n\tcase RATE_36M:\n\tcase RATE_48M:\n\tcase RATE_54M:\n\t\tbyPwr = priv->abyOFDMPwrTbl[uCH];\n\t\tbreak;\n\t}\n\n\tif (priv->byCurPwr == byPwr)\n\t\treturn true;\n\n\tret = RFbRawSetPower(priv, byPwr, rate);\n\tif (ret)\n\t\tpriv->byCurPwr = byPwr;\n\n\treturn ret;\n}\n\n \n\nbool RFbRawSetPower(struct vnt_private *priv, unsigned char byPwr,\n\t\t    unsigned int rate)\n{\n\tbool ret = true;\n\n\tif (byPwr >= priv->max_pwr_level)\n\t\treturn false;\n\n\tswitch (priv->byRFType) {\n\tcase RF_AIROHA:\n\t\tret &= IFRFbWriteEmbedded(priv, al2230_power_table[byPwr]);\n\t\tif (rate <= RATE_11M)\n\t\t\tret &= IFRFbWriteEmbedded(priv, 0x0001B400 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\n\t\telse\n\t\t\tret &= IFRFbWriteEmbedded(priv, 0x0005A400 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\n\n\t\tbreak;\n\n\tcase RF_AL2230S:\n\t\tret &= IFRFbWriteEmbedded(priv, al2230_power_table[byPwr]);\n\t\tif (rate <= RATE_11M) {\n\t\t\tret &= IFRFbWriteEmbedded(priv, 0x040C1400 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\n\t\t\tret &= IFRFbWriteEmbedded(priv, 0x00299B00 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\n\t\t} else {\n\t\t\tret &= IFRFbWriteEmbedded(priv, 0x0005A400 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\n\t\t\tret &= IFRFbWriteEmbedded(priv, 0x00099B00 + (BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\n\t\t}\n\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\n \nvoid\nRFvRSSITodBm(struct vnt_private *priv, unsigned char byCurrRSSI, long *pldBm)\n{\n\tunsigned char byIdx = (((byCurrRSSI & 0xC0) >> 6) & 0x03);\n\tlong b = (byCurrRSSI & 0x3F);\n\tlong a = 0;\n\tunsigned char abyAIROHARF[4] = {0, 18, 0, 40};\n\n\tswitch (priv->byRFType) {\n\tcase RF_AIROHA:\n\tcase RF_AL2230S:\n\t\ta = abyAIROHARF[byIdx];\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\t*pldBm = -1 * (a + b * 2);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}