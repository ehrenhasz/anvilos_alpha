{
  "module_name": "codec_mpeg12.c",
  "hash_id": "8ef4d22da70f1bbea8f61ce6ce8ca9d838d97e146f499cb0fb498070e5bc7887",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/meson/vdec/codec_mpeg12.c",
  "human_readable_source": "\n \n\n#include <media/v4l2-mem2mem.h>\n#include <media/videobuf2-dma-contig.h>\n\n#include \"codec_mpeg12.h\"\n#include \"dos_regs.h\"\n#include \"vdec_helpers.h\"\n\n#define SIZE_WORKSPACE\t\tSZ_128K\n \n#define WORKSPACE_OFFSET\t(5 * SZ_1K)\n\n \n#define MREG_SEQ_INFO\t\tAV_SCRATCH_4\n\t#define MPEG2_SEQ_DAR_MASK\tGENMASK(3, 0)\n\t#define MPEG2_DAR_4_3\t\t2\n\t#define MPEG2_DAR_16_9\t\t3\n\t#define MPEG2_DAR_221_100\t4\n#define MREG_PIC_INFO\t\tAV_SCRATCH_5\n#define MREG_PIC_WIDTH\t\tAV_SCRATCH_6\n#define MREG_PIC_HEIGHT\t\tAV_SCRATCH_7\n#define MREG_BUFFERIN\t\tAV_SCRATCH_8\n#define MREG_BUFFEROUT\t\tAV_SCRATCH_9\n#define MREG_CMD\t\tAV_SCRATCH_A\n#define MREG_CO_MV_START\tAV_SCRATCH_B\n#define MREG_ERROR_COUNT\tAV_SCRATCH_C\n#define MREG_FRAME_OFFSET\tAV_SCRATCH_D\n#define MREG_WAIT_BUFFER\tAV_SCRATCH_E\n#define MREG_FATAL_ERROR\tAV_SCRATCH_F\n\n#define PICINFO_PROG\t\t0x00008000\n#define PICINFO_TOP_FIRST\t0x00002000\n\nstruct codec_mpeg12 {\n\t \n\tvoid\t  *workspace_vaddr;\n\tdma_addr_t workspace_paddr;\n};\n\nstatic const u8 eos_sequence[SZ_1K] = { 0x00, 0x00, 0x01, 0xB7 };\n\nstatic const u8 *codec_mpeg12_eos_sequence(u32 *len)\n{\n\t*len = ARRAY_SIZE(eos_sequence);\n\treturn eos_sequence;\n}\n\nstatic int codec_mpeg12_can_recycle(struct amvdec_core *core)\n{\n\treturn !amvdec_read_dos(core, MREG_BUFFERIN);\n}\n\nstatic void codec_mpeg12_recycle(struct amvdec_core *core, u32 buf_idx)\n{\n\tamvdec_write_dos(core, MREG_BUFFERIN, buf_idx + 1);\n}\n\nstatic int codec_mpeg12_start(struct amvdec_session *sess)\n{\n\tstruct amvdec_core *core = sess->core;\n\tstruct codec_mpeg12 *mpeg12;\n\tint ret;\n\n\tmpeg12 = kzalloc(sizeof(*mpeg12), GFP_KERNEL);\n\tif (!mpeg12)\n\t\treturn -ENOMEM;\n\n\t \n\tmpeg12->workspace_vaddr = dma_alloc_coherent(core->dev, SIZE_WORKSPACE,\n\t\t\t\t\t\t     &mpeg12->workspace_paddr,\n\t\t\t\t\t\t     GFP_KERNEL);\n\tif (!mpeg12->workspace_vaddr) {\n\t\tdev_err(core->dev, \"Failed to request MPEG 1/2 Workspace\\n\");\n\t\tret = -ENOMEM;\n\t\tgoto free_mpeg12;\n\t}\n\n\tret = amvdec_set_canvases(sess, (u32[]){ AV_SCRATCH_0, 0 },\n\t\t\t\t\t(u32[]){ 8, 0 });\n\tif (ret)\n\t\tgoto free_workspace;\n\n\tamvdec_write_dos(core, POWER_CTL_VLD, BIT(4));\n\tamvdec_write_dos(core, MREG_CO_MV_START,\n\t\t\t mpeg12->workspace_paddr + WORKSPACE_OFFSET);\n\n\tamvdec_write_dos(core, MPEG1_2_REG, 0);\n\tamvdec_write_dos(core, PSCALE_CTRL, 0);\n\tamvdec_write_dos(core, PIC_HEAD_INFO, 0x380);\n\tamvdec_write_dos(core, M4_CONTROL_REG, 0);\n\tamvdec_write_dos(core, MREG_BUFFERIN, 0);\n\tamvdec_write_dos(core, MREG_BUFFEROUT, 0);\n\tamvdec_write_dos(core, MREG_CMD, (sess->width << 16) | sess->height);\n\tamvdec_write_dos(core, MREG_ERROR_COUNT, 0);\n\tamvdec_write_dos(core, MREG_FATAL_ERROR, 0);\n\tamvdec_write_dos(core, MREG_WAIT_BUFFER, 0);\n\n\tsess->keyframe_found = 1;\n\tsess->priv = mpeg12;\n\n\treturn 0;\n\nfree_workspace:\n\tdma_free_coherent(core->dev, SIZE_WORKSPACE, mpeg12->workspace_vaddr,\n\t\t\t  mpeg12->workspace_paddr);\nfree_mpeg12:\n\tkfree(mpeg12);\n\n\treturn ret;\n}\n\nstatic int codec_mpeg12_stop(struct amvdec_session *sess)\n{\n\tstruct codec_mpeg12 *mpeg12 = sess->priv;\n\tstruct amvdec_core *core = sess->core;\n\n\tif (mpeg12->workspace_vaddr)\n\t\tdma_free_coherent(core->dev, SIZE_WORKSPACE,\n\t\t\t\t  mpeg12->workspace_vaddr,\n\t\t\t\t  mpeg12->workspace_paddr);\n\n\treturn 0;\n}\n\nstatic void codec_mpeg12_update_dar(struct amvdec_session *sess)\n{\n\tstruct amvdec_core *core = sess->core;\n\tu32 seq = amvdec_read_dos(core, MREG_SEQ_INFO);\n\tu32 ar = seq & MPEG2_SEQ_DAR_MASK;\n\n\tswitch (ar) {\n\tcase MPEG2_DAR_4_3:\n\t\tamvdec_set_par_from_dar(sess, 4, 3);\n\t\tbreak;\n\tcase MPEG2_DAR_16_9:\n\t\tamvdec_set_par_from_dar(sess, 16, 9);\n\t\tbreak;\n\tcase MPEG2_DAR_221_100:\n\t\tamvdec_set_par_from_dar(sess, 221, 100);\n\t\tbreak;\n\tdefault:\n\t\tsess->pixelaspect.numerator = 1;\n\t\tsess->pixelaspect.denominator = 1;\n\t\tbreak;\n\t}\n}\n\nstatic irqreturn_t codec_mpeg12_threaded_isr(struct amvdec_session *sess)\n{\n\tstruct amvdec_core *core = sess->core;\n\tu32 reg;\n\tu32 pic_info;\n\tu32 is_progressive;\n\tu32 buffer_index;\n\tu32 field = V4L2_FIELD_NONE;\n\tu32 offset;\n\n\tamvdec_write_dos(core, ASSIST_MBOX1_CLR_REG, 1);\n\treg = amvdec_read_dos(core, MREG_FATAL_ERROR);\n\tif (reg == 1) {\n\t\tdev_err(core->dev, \"MPEG1/2 fatal error\\n\");\n\t\tamvdec_abort(sess);\n\t\treturn IRQ_HANDLED;\n\t}\n\n\treg = amvdec_read_dos(core, MREG_BUFFEROUT);\n\tif (!reg)\n\t\treturn IRQ_HANDLED;\n\n\t \n\tif ((reg & GENMASK(23, 17)) == GENMASK(23, 17))\n\t\tgoto end;\n\n\tpic_info = amvdec_read_dos(core, MREG_PIC_INFO);\n\tis_progressive = pic_info & PICINFO_PROG;\n\n\tif (!is_progressive)\n\t\tfield = (pic_info & PICINFO_TOP_FIRST) ?\n\t\t\tV4L2_FIELD_INTERLACED_TB :\n\t\t\tV4L2_FIELD_INTERLACED_BT;\n\n\tcodec_mpeg12_update_dar(sess);\n\tbuffer_index = ((reg & 0xf) - 1) & 7;\n\toffset = amvdec_read_dos(core, MREG_FRAME_OFFSET);\n\tamvdec_dst_buf_done_idx(sess, buffer_index, offset, field);\n\nend:\n\tamvdec_write_dos(core, MREG_BUFFEROUT, 0);\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t codec_mpeg12_isr(struct amvdec_session *sess)\n{\n\treturn IRQ_WAKE_THREAD;\n}\n\nstruct amvdec_codec_ops codec_mpeg12_ops = {\n\t.start = codec_mpeg12_start,\n\t.stop = codec_mpeg12_stop,\n\t.isr = codec_mpeg12_isr,\n\t.threaded_isr = codec_mpeg12_threaded_isr,\n\t.can_recycle = codec_mpeg12_can_recycle,\n\t.recycle = codec_mpeg12_recycle,\n\t.eos_sequence = codec_mpeg12_eos_sequence,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}