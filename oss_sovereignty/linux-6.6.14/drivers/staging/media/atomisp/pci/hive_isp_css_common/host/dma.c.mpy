{
  "module_name": "dma.c",
  "hash_id": "62663d3535172eda0912eec113bdef583bd9877d418168724ec22322e799b3e7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/hive_isp_css_common/host/dma.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n\n#include \"dma.h\"\n\n#include \"assert_support.h\"\n\n#ifndef __INLINE_DMA__\n#include \"dma_private.h\"\n#endif  \n\nvoid dma_get_state(const dma_ID_t ID, dma_state_t *state)\n{\n\tint\t\t\ti;\n\thrt_data\ttmp;\n\n\tassert(ID < N_DMA_ID);\n\tassert(state);\n\n\ttmp = dma_reg_load(ID, DMA_COMMAND_FSM_REG_IDX);\n\t\n\t\n\t\n\t\n\tstate->fsm_command_idle = tmp & 0x1;\n\tstate->fsm_command_run = tmp & 0x2;\n\tstate->fsm_command_stalling = tmp & 0x4;\n\tstate->fsm_command_error    = tmp & 0x8;\n\tstate->last_command_channel = (tmp >> 10 & 0x1F);\n\tstate->last_command_param =  (tmp >> 15 & 0x0F);\n\ttmp = (tmp >> 4) & 0x3F;\n\t \n\t \n\t \n\t \n\t \n\tstate->last_command = tmp;\n\n\t \n\n\t \n\tstate->current_command = dma_reg_load(ID,\n\t\t\t\t\t      DMA_CG_INFO_REG_IDX(0, _DMA_FSM_GROUP_CMD_IDX));\n\tstate->current_addr_a = dma_reg_load(ID,\n\t\t\t\t\t     DMA_CG_INFO_REG_IDX(0, _DMA_FSM_GROUP_ADDR_A_IDX));\n\tstate->current_addr_b = dma_reg_load(ID,\n\t\t\t\t\t     DMA_CG_INFO_REG_IDX(0, _DMA_FSM_GROUP_ADDR_B_IDX));\n\n\ttmp =  dma_reg_load(ID,\n\t\t\t    DMA_CG_INFO_REG_IDX(\n\t\t\t\t_DMA_FSM_GROUP_FSM_CTRL_STATE_IDX,\n\t\t\t\t_DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_idle = tmp & 0x1;\n\tstate->fsm_ctrl_run = tmp & 0x2;\n\tstate->fsm_ctrl_stalling = tmp & 0x4;\n\tstate->fsm_ctrl_error = tmp & 0x8;\n\ttmp = tmp >> 4;\n\t \n\tif (tmp == 0)\n\t\tstate->fsm_ctrl_state = DMA_CTRL_STATE_IDLE;\n\tif (tmp == 1)\n\t\tstate->fsm_ctrl_state = DMA_CTRL_STATE_REQ_RCV;\n\tif (tmp == 2)\n\t\tstate->fsm_ctrl_state = DMA_CTRL_STATE_RCV;\n\tif (tmp == 3)\n\t\tstate->fsm_ctrl_state = DMA_CTRL_STATE_RCV_REQ;\n\tif (tmp == 4)\n\t\tstate->fsm_ctrl_state = DMA_CTRL_STATE_INIT;\n\tstate->fsm_ctrl_source_dev = dma_reg_load(ID,\n\t\t\t\t     DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t _DMA_FSM_GROUP_FSM_CTRL_REQ_DEV_IDX,\n\t\t\t\t\t _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_source_addr = dma_reg_load(ID,\n\t\t\t\t      DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t  _DMA_FSM_GROUP_FSM_CTRL_REQ_ADDR_IDX,\n\t\t\t\t\t  _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_source_stride = dma_reg_load(ID,\n\t\t\t\t\tDMA_CG_INFO_REG_IDX(\n\t\t\t\t\t    _DMA_FSM_GROUP_FSM_CTRL_REQ_STRIDE_IDX,\n\t\t\t\t\t    _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_source_width = dma_reg_load(ID,\n\t\t\t\t       DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t   _DMA_FSM_GROUP_FSM_CTRL_REQ_XB_IDX,\n\t\t\t\t\t   _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_source_height = dma_reg_load(ID,\n\t\t\t\t\tDMA_CG_INFO_REG_IDX(\n\t\t\t\t\t    _DMA_FSM_GROUP_FSM_CTRL_REQ_YB_IDX,\n\t\t\t\t\t    _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_pack_source_dev = dma_reg_load(ID,\n\t\t\t\t\t  DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t      _DMA_FSM_GROUP_FSM_CTRL_PACK_REQ_DEV_IDX,\n\t\t\t\t\t      _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_pack_dest_dev = dma_reg_load(ID,\n\t\t\t\t\tDMA_CG_INFO_REG_IDX(\n\t\t\t\t\t    _DMA_FSM_GROUP_FSM_CTRL_PACK_WR_DEV_IDX,\n\t\t\t\t\t    _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_dest_addr = dma_reg_load(ID,\n\t\t\t\t    DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t_DMA_FSM_GROUP_FSM_CTRL_WR_ADDR_IDX,\n\t\t\t\t\t_DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_dest_stride = dma_reg_load(ID,\n\t\t\t\t      DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t  _DMA_FSM_GROUP_FSM_CTRL_WR_STRIDE_IDX,\n\t\t\t\t\t  _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_pack_source_width = dma_reg_load(ID,\n\t\t\t\t\t    DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t\t_DMA_FSM_GROUP_FSM_CTRL_PACK_REQ_XB_IDX,\n\t\t\t\t\t\t_DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_pack_dest_height = dma_reg_load(ID,\n\t\t\t\t\t   DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t       _DMA_FSM_GROUP_FSM_CTRL_PACK_WR_YB_IDX,\n\t\t\t\t\t       _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_pack_dest_width = dma_reg_load(ID,\n\t\t\t\t\t  DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t      _DMA_FSM_GROUP_FSM_CTRL_PACK_WR_XB_IDX,\n\t\t\t\t\t      _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_pack_source_elems = dma_reg_load(ID,\n\t\t\t\t\t    DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t\t_DMA_FSM_GROUP_FSM_CTRL_PACK_ELEM_REQ_IDX,\n\t\t\t\t\t\t_DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_pack_dest_elems = dma_reg_load(ID,\n\t\t\t\t\t  DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t      _DMA_FSM_GROUP_FSM_CTRL_PACK_ELEM_WR_IDX,\n\t\t\t\t\t      _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\tstate->fsm_ctrl_pack_extension = dma_reg_load(ID,\n\t\t\t\t\t DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t     _DMA_FSM_GROUP_FSM_CTRL_PACK_S_Z_IDX,\n\t\t\t\t\t     _DMA_FSM_GROUP_FSM_CTRL_IDX));\n\n\ttmp = dma_reg_load(ID,\n\t\t\t   DMA_CG_INFO_REG_IDX(\n\t\t\t       _DMA_FSM_GROUP_FSM_PACK_STATE_IDX,\n\t\t\t       _DMA_FSM_GROUP_FSM_PACK_IDX));\n\tstate->pack_idle     = tmp & 0x1;\n\tstate->pack_run      = tmp & 0x2;\n\tstate->pack_stalling = tmp & 0x4;\n\tstate->pack_error    = tmp & 0x8;\n\tstate->pack_cnt_height = dma_reg_load(ID,\n\t\t\t\t\t      DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t\t      _DMA_FSM_GROUP_FSM_PACK_CNT_YB_IDX,\n\t\t\t\t\t\t      _DMA_FSM_GROUP_FSM_PACK_IDX));\n\tstate->pack_src_cnt_width = dma_reg_load(ID,\n\t\t\t\t    DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t_DMA_FSM_GROUP_FSM_PACK_CNT_XB_REQ_IDX,\n\t\t\t\t\t_DMA_FSM_GROUP_FSM_PACK_IDX));\n\tstate->pack_dest_cnt_width = dma_reg_load(ID,\n\t\t\t\t     DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t _DMA_FSM_GROUP_FSM_PACK_CNT_XB_WR_IDX,\n\t\t\t\t\t _DMA_FSM_GROUP_FSM_PACK_IDX));\n\n\ttmp = dma_reg_load(ID,\n\t\t\t   DMA_CG_INFO_REG_IDX(\n\t\t\t       _DMA_FSM_GROUP_FSM_REQ_STATE_IDX,\n\t\t\t       _DMA_FSM_GROUP_FSM_REQ_IDX));\n\t \n\tif (tmp == 0)\n\t\tstate->read_state = DMA_RW_STATE_IDLE;\n\tif (tmp == 1)\n\t\tstate->read_state = DMA_RW_STATE_REQ;\n\tif (tmp == 2)\n\t\tstate->read_state = DMA_RW_STATE_NEXT_LINE;\n\tif (tmp == 3)\n\t\tstate->read_state = DMA_RW_STATE_UNLOCK_CHANNEL;\n\tstate->read_cnt_height = dma_reg_load(ID,\n\t\t\t\t\t      DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t\t      _DMA_FSM_GROUP_FSM_REQ_CNT_YB_IDX,\n\t\t\t\t\t\t      _DMA_FSM_GROUP_FSM_REQ_IDX));\n\tstate->read_cnt_width = dma_reg_load(ID,\n\t\t\t\t\t     DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t\t     _DMA_FSM_GROUP_FSM_REQ_CNT_XB_IDX,\n\t\t\t\t\t\t     _DMA_FSM_GROUP_FSM_REQ_IDX));\n\n\ttmp = dma_reg_load(ID,\n\t\t\t   DMA_CG_INFO_REG_IDX(\n\t\t\t       _DMA_FSM_GROUP_FSM_WR_STATE_IDX,\n\t\t\t       _DMA_FSM_GROUP_FSM_WR_IDX));\n\t \n\tif (tmp == 0)\n\t\tstate->write_state = DMA_RW_STATE_IDLE;\n\tif (tmp == 1)\n\t\tstate->write_state = DMA_RW_STATE_REQ;\n\tif (tmp == 2)\n\t\tstate->write_state = DMA_RW_STATE_NEXT_LINE;\n\tif (tmp == 3)\n\t\tstate->write_state = DMA_RW_STATE_UNLOCK_CHANNEL;\n\tstate->write_height = dma_reg_load(ID,\n\t\t\t\t\t   DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t       _DMA_FSM_GROUP_FSM_WR_CNT_YB_IDX,\n\t\t\t\t\t       _DMA_FSM_GROUP_FSM_WR_IDX));\n\tstate->write_width = dma_reg_load(ID,\n\t\t\t\t\t  DMA_CG_INFO_REG_IDX(\n\t\t\t\t\t      _DMA_FSM_GROUP_FSM_WR_CNT_XB_IDX,\n\t\t\t\t\t      _DMA_FSM_GROUP_FSM_WR_IDX));\n\n\tfor (i = 0; i < HIVE_ISP_NUM_DMA_CONNS; i++) {\n\t\tdma_port_state_t *port = &state->port_states[i];\n\n\t\ttmp = dma_reg_load(ID, DMA_DEV_INFO_REG_IDX(0, i));\n\t\tport->req_cs   = ((tmp & 0x1) != 0);\n\t\tport->req_we_n = ((tmp & 0x2) != 0);\n\t\tport->req_run  = ((tmp & 0x4) != 0);\n\t\tport->req_ack  = ((tmp & 0x8) != 0);\n\n\t\ttmp = dma_reg_load(ID, DMA_DEV_INFO_REG_IDX(1, i));\n\t\tport->send_cs   = ((tmp & 0x1) != 0);\n\t\tport->send_we_n = ((tmp & 0x2) != 0);\n\t\tport->send_run  = ((tmp & 0x4) != 0);\n\t\tport->send_ack  = ((tmp & 0x8) != 0);\n\n\t\ttmp = dma_reg_load(ID, DMA_DEV_INFO_REG_IDX(2, i));\n\t\tif (tmp & 0x1)\n\t\t\tport->fifo_state = DMA_FIFO_STATE_WILL_BE_FULL;\n\t\tif (tmp & 0x2)\n\t\t\tport->fifo_state = DMA_FIFO_STATE_FULL;\n\t\tif (tmp & 0x4)\n\t\t\tport->fifo_state = DMA_FIFO_STATE_EMPTY;\n\t\tport->fifo_counter = tmp >> 3;\n\t}\n\n\tfor (i = 0; i < HIVE_DMA_NUM_CHANNELS; i++) {\n\t\tdma_channel_state_t *ch = &state->channel_states[i];\n\n\t\tch->connection = DMA_GET_CONNECTION(dma_reg_load(ID,\n\t\t\t\t\t\t    DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t\t    _DMA_PACKING_SETUP_PARAM)));\n\t\tch->sign_extend = DMA_GET_EXTENSION(dma_reg_load(ID,\n\t\t\t\t\t\t    DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t\t    _DMA_PACKING_SETUP_PARAM)));\n\t\tch->height = dma_reg_load(ID,\n\t\t\t\t\t  DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t  _DMA_HEIGHT_PARAM));\n\t\tch->stride_a = dma_reg_load(ID,\n\t\t\t\t\t    DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t    _DMA_STRIDE_A_PARAM));\n\t\tch->elems_a = DMA_GET_ELEMENTS(dma_reg_load(ID,\n\t\t\t\t\t       DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t       _DMA_ELEM_CROPPING_A_PARAM)));\n\t\tch->cropping_a = DMA_GET_CROPPING(dma_reg_load(ID,\n\t\t\t\t\t\t  DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t\t  _DMA_ELEM_CROPPING_A_PARAM)));\n\t\tch->width_a = dma_reg_load(ID,\n\t\t\t\t\t   DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t   _DMA_WIDTH_A_PARAM));\n\t\tch->stride_b = dma_reg_load(ID,\n\t\t\t\t\t    DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t    _DMA_STRIDE_B_PARAM));\n\t\tch->elems_b = DMA_GET_ELEMENTS(dma_reg_load(ID,\n\t\t\t\t\t       DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t       _DMA_ELEM_CROPPING_B_PARAM)));\n\t\tch->cropping_b = DMA_GET_CROPPING(dma_reg_load(ID,\n\t\t\t\t\t\t  DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t\t  _DMA_ELEM_CROPPING_B_PARAM)));\n\t\tch->width_b = dma_reg_load(ID,\n\t\t\t\t\t   DMA_CHANNEL_PARAM_REG_IDX(i,\n\t\t\t\t\t\t   _DMA_WIDTH_B_PARAM));\n\t}\n}\n\nvoid\ndma_set_max_burst_size(const dma_ID_t ID, dma_connection conn,\n\t\t       uint32_t max_burst_size)\n{\n\tassert(ID < N_DMA_ID);\n\tassert(max_burst_size > 0);\n\tdma_reg_store(ID, DMA_DEV_INFO_REG_IDX(_DMA_DEV_INTERF_MAX_BURST_IDX, conn),\n\t\t      max_burst_size - 1);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}