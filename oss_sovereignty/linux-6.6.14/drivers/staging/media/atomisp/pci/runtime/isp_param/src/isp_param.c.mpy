{
  "module_name": "isp_param.c",
  "hash_id": "26f5913499602349266e507319217a3e4e9bbba7a04048f48138234c31b3d552",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/runtime/isp_param/src/isp_param.c",
  "human_readable_source": "\n \n\n#include \"hmm.h\"\n\n#include \"ia_css_pipeline.h\"\n#include \"ia_css_isp_param.h\"\n\n \n\nvoid\nia_css_isp_param_set_mem_init(\n    struct ia_css_isp_param_host_segments *mem_init,\n    enum ia_css_param_class pclass,\n    enum ia_css_isp_memories mem,\n    char *address, size_t size)\n{\n\tmem_init->params[pclass][mem].address = address;\n\tmem_init->params[pclass][mem].size = (uint32_t)size;\n}\n\nvoid\nia_css_isp_param_set_css_mem_init(\n    struct ia_css_isp_param_css_segments *mem_init,\n    enum ia_css_param_class pclass,\n    enum ia_css_isp_memories mem,\n    ia_css_ptr address, size_t size)\n{\n\tmem_init->params[pclass][mem].address = address;\n\tmem_init->params[pclass][mem].size = (uint32_t)size;\n}\n\nvoid\nia_css_isp_param_set_isp_mem_init(\n    struct ia_css_isp_param_isp_segments *mem_init,\n    enum ia_css_param_class pclass,\n    enum ia_css_isp_memories mem,\n    u32 address, size_t size)\n{\n\tmem_init->params[pclass][mem].address = address;\n\tmem_init->params[pclass][mem].size = (uint32_t)size;\n}\n\n \nconst struct ia_css_host_data *\nia_css_isp_param_get_mem_init(\n    const struct ia_css_isp_param_host_segments *mem_init,\n    enum ia_css_param_class pclass,\n    enum ia_css_isp_memories mem)\n{\n\treturn &mem_init->params[pclass][mem];\n}\n\nconst struct ia_css_data *\nia_css_isp_param_get_css_mem_init(\n    const struct ia_css_isp_param_css_segments *mem_init,\n    enum ia_css_param_class pclass,\n    enum ia_css_isp_memories mem)\n{\n\treturn &mem_init->params[pclass][mem];\n}\n\nconst struct ia_css_isp_data *\nia_css_isp_param_get_isp_mem_init(\n    const struct ia_css_isp_param_isp_segments *mem_init,\n    enum ia_css_param_class pclass,\n    enum ia_css_isp_memories mem)\n{\n\treturn &mem_init->params[pclass][mem];\n}\n\nvoid\nia_css_init_memory_interface(\n    struct ia_css_isp_param_css_segments *isp_mem_if,\n    const struct ia_css_isp_param_host_segments *mem_params,\n    const struct ia_css_isp_param_css_segments *css_params)\n{\n\tunsigned int pclass, mem;\n\n\tfor (pclass = 0; pclass < IA_CSS_NUM_PARAM_CLASSES; pclass++) {\n\t\tmemset(isp_mem_if->params[pclass], 0, sizeof(isp_mem_if->params[pclass]));\n\t\tfor (mem = 0; mem < IA_CSS_NUM_MEMORIES; mem++) {\n\t\t\tif (!mem_params->params[pclass][mem].address)\n\t\t\t\tcontinue;\n\t\t\tisp_mem_if->params[pclass][mem].size = mem_params->params[pclass][mem].size;\n\t\t\tif (pclass != IA_CSS_PARAM_CLASS_PARAM)\n\t\t\t\tisp_mem_if->params[pclass][mem].address =\n\t\t\t\t    css_params->params[pclass][mem].address;\n\t\t}\n\t}\n}\n\nint\nia_css_isp_param_allocate_isp_parameters(\n    struct ia_css_isp_param_host_segments *mem_params,\n    struct ia_css_isp_param_css_segments *css_params,\n    const struct ia_css_isp_param_isp_segments *mem_initializers) {\n\tint err = 0;\n\tunsigned int mem, pclass;\n\n\tpclass = IA_CSS_PARAM_CLASS_PARAM;\n\tfor (mem = 0; mem < IA_CSS_NUM_MEMORIES; mem++)\n\t{\n\t\tfor (pclass = 0; pclass < IA_CSS_NUM_PARAM_CLASSES; pclass++) {\n\t\t\tu32 size = 0;\n\n\t\t\tif (mem_initializers)\n\t\t\t\tsize = mem_initializers->params[pclass][mem].size;\n\t\t\tmem_params->params[pclass][mem].size = size;\n\t\t\tmem_params->params[pclass][mem].address = NULL;\n\t\t\tcss_params->params[pclass][mem].size = size;\n\t\t\tcss_params->params[pclass][mem].address = 0x0;\n\t\t\tif (size) {\n\t\t\t\tmem_params->params[pclass][mem].address = kvcalloc(1,\n\t\t\t\t\t\t\t\t\t\t   size,\n\t\t\t\t\t\t\t\t\t\t   GFP_KERNEL);\n\t\t\t\tif (!mem_params->params[pclass][mem].address) {\n\t\t\t\t\terr = -ENOMEM;\n\t\t\t\t\tgoto cleanup;\n\t\t\t\t}\n\t\t\t\tif (pclass != IA_CSS_PARAM_CLASS_PARAM) {\n\t\t\t\t\tcss_params->params[pclass][mem].address = hmm_alloc(size);\n\t\t\t\t\tif (!css_params->params[pclass][mem].address) {\n\t\t\t\t\t\terr = -ENOMEM;\n\t\t\t\t\t\tgoto cleanup;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn err;\ncleanup:\n\tia_css_isp_param_destroy_isp_parameters(mem_params, css_params);\n\treturn err;\n}\n\nvoid\nia_css_isp_param_destroy_isp_parameters(\n    struct ia_css_isp_param_host_segments *mem_params,\n    struct ia_css_isp_param_css_segments *css_params)\n{\n\tunsigned int mem, pclass;\n\n\tfor (mem = 0; mem < IA_CSS_NUM_MEMORIES; mem++) {\n\t\tfor (pclass = 0; pclass < IA_CSS_NUM_PARAM_CLASSES; pclass++) {\n\t\t\tkvfree(mem_params->params[pclass][mem].address);\n\t\t\tif (css_params->params[pclass][mem].address)\n\t\t\t\thmm_free(css_params->params[pclass][mem].address);\n\t\t\tmem_params->params[pclass][mem].address = NULL;\n\t\t\tcss_params->params[pclass][mem].address = 0x0;\n\t\t}\n\t}\n}\n\nvoid\nia_css_isp_param_load_fw_params(\n    const char *fw,\n    union ia_css_all_memory_offsets *mem_offsets,\n    const struct ia_css_isp_param_memory_offsets *memory_offsets,\n    bool init)\n{\n\tunsigned int pclass;\n\n\tfor (pclass = 0; pclass < IA_CSS_NUM_PARAM_CLASSES; pclass++) {\n\t\tmem_offsets->array[pclass].ptr = NULL;\n\t\tif (init)\n\t\t\tmem_offsets->array[pclass].ptr = (void *)(fw + memory_offsets->offsets[pclass]);\n\t}\n}\n\nint\nia_css_isp_param_copy_isp_mem_if_to_ddr(\n    struct ia_css_isp_param_css_segments *ddr,\n    const struct ia_css_isp_param_host_segments *host,\n    enum ia_css_param_class pclass) {\n\tunsigned int mem;\n\n\tfor (mem = 0; mem < N_IA_CSS_ISP_MEMORIES; mem++)\n\t{\n\t\tsize_t       size\t  = host->params[pclass][mem].size;\n\t\tia_css_ptr ddr_mem_ptr  = ddr->params[pclass][mem].address;\n\t\tchar\t    *host_mem_ptr = host->params[pclass][mem].address;\n\n\t\tif (size != ddr->params[pclass][mem].size)\n\t\t\treturn -EINVAL;\n\t\tif (!size)\n\t\t\tcontinue;\n\t\thmm_store(ddr_mem_ptr, host_mem_ptr, size);\n\t}\n\treturn 0;\n}\n\nvoid\nia_css_isp_param_enable_pipeline(\n    const struct ia_css_isp_param_host_segments *mem_params)\n{\n\t \n\tshort dmem_offset = 0;\n\n\tif (mem_params->params[IA_CSS_PARAM_CLASS_PARAM][IA_CSS_ISP_DMEM0].size == 0)\n\t\treturn;\n\n\t*(uint32_t *)\n\t&mem_params->params[IA_CSS_PARAM_CLASS_PARAM][IA_CSS_ISP_DMEM0].address[dmem_offset]\n\t    = 0x0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}