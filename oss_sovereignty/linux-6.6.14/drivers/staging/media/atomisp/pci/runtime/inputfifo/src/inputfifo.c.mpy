{
  "module_name": "inputfifo.c",
  "hash_id": "2bb2e05826f5ef5643956712561a0b51279a1f33c755a81b3f2e7711bdec2963",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/runtime/inputfifo/src/inputfifo.c",
  "human_readable_source": "\n \n\n#include \"platform_support.h\"\n\n#include \"ia_css_inputfifo.h\"\n\n#include \"device_access.h\"\n\n#define __INLINE_SP__\n#include \"sp.h\"\n#define __INLINE_ISP__\n#include \"isp.h\"\n#define __INLINE_IRQ__\n#include \"irq.h\"\n#define __INLINE_FIFO_MONITOR__\n#include \"fifo_monitor.h\"\n\n#define __INLINE_EVENT__\n#include \"event_fifo.h\"\n#define __INLINE_SP__\n\n#include \"input_system.h\"\t \n\n#include \"assert_support.h\"\n\n \n#include \"sh_css_internal.h\"\n#include \"ia_css_isys.h\"\n\n#define HBLANK_CYCLES (187)\n#define MARKER_CYCLES (6)\n\n#include <hive_isp_css_streaming_to_mipi_types_hrt.h>\n\n \nenum inputfifo_mipi_data_type {\n\tinputfifo_mipi_data_type_regular,\n\tinputfifo_mipi_data_type_yuv420,\n\tinputfifo_mipi_data_type_yuv420_legacy,\n\tinputfifo_mipi_data_type_rgb,\n};\n\nstatic unsigned int inputfifo_curr_ch_id, inputfifo_curr_fmt_type;\nstruct inputfifo_instance {\n\tunsigned int\t\t\t\tch_id;\n\tenum atomisp_input_format\tinput_format;\n\tbool\t\t\t\t\t\ttwo_ppc;\n\tbool\t\t\t\t\t\tstreaming;\n\tunsigned int\t\t\t\thblank_cycles;\n\tunsigned int\t\t\t\tmarker_cycles;\n\tunsigned int\t\t\t\tfmt_type;\n\tenum inputfifo_mipi_data_type\ttype;\n};\n\n \n#define INPUTFIFO_NR_OF_S2M_CHANNELS\t(4)\nstatic struct inputfifo_instance\n\tinputfifo_inst_admin[INPUTFIFO_NR_OF_S2M_CHANNELS];\n\n \nstatic unsigned int inputfifo_wrap_marker(\n     \n    unsigned int marker)\n{\n\treturn marker |\n\t       (inputfifo_curr_ch_id << HIVE_STR_TO_MIPI_CH_ID_LSB) |\n\t       (inputfifo_curr_fmt_type << _HIVE_STR_TO_MIPI_FMT_TYPE_LSB);\n}\n\nstatic inline void\n_sh_css_fifo_snd(unsigned int token)\n{\n\twhile (!can_event_send_token(STR2MIPI_EVENT_ID))\n\t\tudelay(1);\n\tevent_send_token(STR2MIPI_EVENT_ID, token);\n\treturn;\n}\n\nstatic void inputfifo_send_data_a(\n     \n    unsigned int data)\n{\n\tunsigned int token = (1 << HIVE_STR_TO_MIPI_VALID_A_BIT) |\n\t\t\t     (data << HIVE_STR_TO_MIPI_DATA_A_LSB);\n\t_sh_css_fifo_snd(token);\n\treturn;\n}\n\nstatic void inputfifo_send_data_b(\n     \n    unsigned int data)\n{\n\tunsigned int token = (1 << HIVE_STR_TO_MIPI_VALID_B_BIT) |\n\t\t\t     (data << _HIVE_STR_TO_MIPI_DATA_B_LSB);\n\t_sh_css_fifo_snd(token);\n\treturn;\n}\n\nstatic void inputfifo_send_data(\n     \n    unsigned int a,\n    unsigned int b)\n{\n\tunsigned int token = ((1 << HIVE_STR_TO_MIPI_VALID_A_BIT) |\n\t\t\t      (1 << HIVE_STR_TO_MIPI_VALID_B_BIT) |\n\t\t\t      (a << HIVE_STR_TO_MIPI_DATA_A_LSB) |\n\t\t\t      (b << _HIVE_STR_TO_MIPI_DATA_B_LSB));\n\t_sh_css_fifo_snd(token);\n\treturn;\n}\n\nstatic void inputfifo_send_sol(void)\n \n{\n\thrt_data\ttoken = inputfifo_wrap_marker(\n\t\t\t\t1 << HIVE_STR_TO_MIPI_SOL_BIT);\n\n\t_sh_css_fifo_snd(token);\n\treturn;\n}\n\nstatic void inputfifo_send_eol(void)\n \n{\n\thrt_data\ttoken = inputfifo_wrap_marker(\n\t\t\t\t1 << HIVE_STR_TO_MIPI_EOL_BIT);\n\t_sh_css_fifo_snd(token);\n\treturn;\n}\n\nstatic void inputfifo_send_sof(void)\n \n{\n\thrt_data\ttoken = inputfifo_wrap_marker(\n\t\t\t\t1 << HIVE_STR_TO_MIPI_SOF_BIT);\n\n\t_sh_css_fifo_snd(token);\n\treturn;\n}\n\nstatic void inputfifo_send_eof(void)\n \n{\n\thrt_data\ttoken = inputfifo_wrap_marker(\n\t\t\t\t1 << HIVE_STR_TO_MIPI_EOF_BIT);\n\t_sh_css_fifo_snd(token);\n\treturn;\n}\n\nstatic void inputfifo_send_ch_id_and_fmt_type(\n     \n    unsigned int ch_id,\n    unsigned int fmt_type)\n{\n\thrt_data\ttoken;\n\n\tinputfifo_curr_ch_id = ch_id & _HIVE_ISP_CH_ID_MASK;\n\tinputfifo_curr_fmt_type = fmt_type & _HIVE_ISP_FMT_TYPE_MASK;\n\t \n\ttoken = inputfifo_wrap_marker(0);\n\t_sh_css_fifo_snd(token);\n\treturn;\n}\n\nstatic void inputfifo_send_empty_token(void)\n \n{\n\thrt_data\ttoken = inputfifo_wrap_marker(0);\n\n\t_sh_css_fifo_snd(token);\n\treturn;\n}\n\nstatic void inputfifo_start_frame(\n     \n    unsigned int ch_id,\n    unsigned int fmt_type)\n{\n\tinputfifo_send_ch_id_and_fmt_type(ch_id, fmt_type);\n\tinputfifo_send_sof();\n\treturn;\n}\n\nstatic void inputfifo_end_frame(\n    unsigned int marker_cycles)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < marker_cycles; i++)\n\t\tinputfifo_send_empty_token();\n\tinputfifo_send_eof();\n\treturn;\n}\n\nstatic void inputfifo_send_line2(\n    const unsigned short *data,\n    unsigned int width,\n    const unsigned short *data2,\n    unsigned int width2,\n    unsigned int hblank_cycles,\n    unsigned int marker_cycles,\n    unsigned int two_ppc,\n    enum inputfifo_mipi_data_type type)\n{\n\tunsigned int i, is_rgb = 0, is_legacy = 0;\n\n\tassert(data);\n\tassert((data2) || (width2 == 0));\n\tif (type == inputfifo_mipi_data_type_rgb)\n\t\tis_rgb = 1;\n\n\tif (type == inputfifo_mipi_data_type_yuv420_legacy)\n\t\tis_legacy = 1;\n\n\tfor (i = 0; i < hblank_cycles; i++)\n\t\tinputfifo_send_empty_token();\n\tinputfifo_send_sol();\n\tfor (i = 0; i < marker_cycles; i++)\n\t\tinputfifo_send_empty_token();\n\tfor (i = 0; i < width; i++, data++) {\n\t\t \n\t\tunsigned int send_two_pixels = two_ppc;\n\n\t\tif ((is_rgb || is_legacy) && (i % 3 == 2))\n\t\t\tsend_two_pixels = 0;\n\t\tif (send_two_pixels) {\n\t\t\tif (i + 1 == width) {\n\t\t\t\t \n\t\t\t\tinputfifo_send_data(\n\t\t\t\t    data[0], 0);\n\t\t\t} else {\n\t\t\t\tinputfifo_send_data(\n\t\t\t\t    data[0], data[1]);\n\t\t\t}\n\t\t\t \n\t\t\tdata++;\n\t\t\ti++;\n\t\t} else if (two_ppc && is_legacy) {\n\t\t\tinputfifo_send_data_b(data[0]);\n\t\t} else {\n\t\t\tinputfifo_send_data_a(data[0]);\n\t\t}\n\t}\n\n\tfor (i = 0; i < width2; i++, data2++) {\n\t\t \n\t\tunsigned int send_two_pixels = two_ppc;\n\n\t\tif ((is_rgb || is_legacy) && (i % 3 == 2))\n\t\t\tsend_two_pixels = 0;\n\t\tif (send_two_pixels) {\n\t\t\tif (i + 1 == width2) {\n\t\t\t\t \n\t\t\t\tinputfifo_send_data(\n\t\t\t\t    data2[0], 0);\n\t\t\t} else {\n\t\t\t\tinputfifo_send_data(\n\t\t\t\t    data2[0], data2[1]);\n\t\t\t}\n\t\t\t \n\t\t\tdata2++;\n\t\t\ti++;\n\t\t} else if (two_ppc && is_legacy) {\n\t\t\tinputfifo_send_data_b(data2[0]);\n\t\t} else {\n\t\t\tinputfifo_send_data_a(data2[0]);\n\t\t}\n\t}\n\tfor (i = 0; i < hblank_cycles; i++)\n\t\tinputfifo_send_empty_token();\n\tinputfifo_send_eol();\n\treturn;\n}\n\nstatic void\ninputfifo_send_line(const unsigned short *data,\n\t\t    unsigned int width,\n\t\t    unsigned int hblank_cycles,\n\t\t    unsigned int marker_cycles,\n\t\t    unsigned int two_ppc,\n\t\t    enum inputfifo_mipi_data_type type)\n{\n\tassert(data);\n\tinputfifo_send_line2(data, width, NULL, 0,\n\t\t\t     hblank_cycles,\n\t\t\t     marker_cycles,\n\t\t\t     two_ppc,\n\t\t\t     type);\n}\n\n \n\nstatic void inputfifo_send_frame(\n    const unsigned short *data,\n    unsigned int width,\n    unsigned int height,\n    unsigned int ch_id,\n    unsigned int fmt_type,\n    unsigned int hblank_cycles,\n    unsigned int marker_cycles,\n    unsigned int two_ppc,\n    enum inputfifo_mipi_data_type type)\n{\n\tunsigned int i;\n\n\tassert(data);\n\tinputfifo_start_frame(ch_id, fmt_type);\n\n\tfor (i = 0; i < height; i++) {\n\t\tif ((type == inputfifo_mipi_data_type_yuv420) &&\n\t\t    (i & 1) == 1) {\n\t\t\tinputfifo_send_line(data, 2 * width,\n\t\t\t\t\t    hblank_cycles,\n\t\t\t\t\t    marker_cycles,\n\t\t\t\t\t    two_ppc, type);\n\t\t\tdata += 2 * width;\n\t\t} else {\n\t\t\tinputfifo_send_line(data, width,\n\t\t\t\t\t    hblank_cycles,\n\t\t\t\t\t    marker_cycles,\n\t\t\t\t\t    two_ppc, type);\n\t\t\tdata += width;\n\t\t}\n\t}\n\tinputfifo_end_frame(marker_cycles);\n\treturn;\n}\n\nstatic enum inputfifo_mipi_data_type inputfifo_determine_type(\n    enum atomisp_input_format input_format)\n{\n\tenum inputfifo_mipi_data_type type;\n\n\ttype = inputfifo_mipi_data_type_regular;\n\tif (input_format == ATOMISP_INPUT_FORMAT_YUV420_8_LEGACY) {\n\t\ttype =\n\t\t    inputfifo_mipi_data_type_yuv420_legacy;\n\t} else if (input_format == ATOMISP_INPUT_FORMAT_YUV420_8  ||\n\t\t   input_format == ATOMISP_INPUT_FORMAT_YUV420_10 ||\n\t\t   input_format == ATOMISP_INPUT_FORMAT_YUV420_16) {\n\t\ttype =\n\t\t    inputfifo_mipi_data_type_yuv420;\n\t} else if (input_format >= ATOMISP_INPUT_FORMAT_RGB_444 &&\n\t\t   input_format <= ATOMISP_INPUT_FORMAT_RGB_888) {\n\t\ttype =\n\t\t    inputfifo_mipi_data_type_rgb;\n\t}\n\treturn type;\n}\n\nstatic struct inputfifo_instance *inputfifo_get_inst(\n    unsigned int ch_id)\n{\n\treturn &inputfifo_inst_admin[ch_id];\n}\n\nvoid ia_css_inputfifo_send_input_frame(\n    const unsigned short *data,\n    unsigned int width,\n    unsigned int height,\n    unsigned int ch_id,\n    enum atomisp_input_format input_format,\n    bool two_ppc)\n{\n\tunsigned int fmt_type, hblank_cycles, marker_cycles;\n\tenum inputfifo_mipi_data_type type;\n\n\tassert(data);\n\thblank_cycles = HBLANK_CYCLES;\n\tmarker_cycles = MARKER_CYCLES;\n\tia_css_isys_convert_stream_format_to_mipi_format(input_format,\n\t\tMIPI_PREDICTOR_NONE,\n\t\t&fmt_type);\n\n\ttype = inputfifo_determine_type(input_format);\n\n\tinputfifo_send_frame(data, width, height,\n\t\t\t     ch_id, fmt_type, hblank_cycles, marker_cycles,\n\t\t\t     two_ppc, type);\n}\n\nvoid ia_css_inputfifo_start_frame(\n    unsigned int ch_id,\n    enum atomisp_input_format input_format,\n    bool two_ppc)\n{\n\tstruct inputfifo_instance *s2mi;\n\n\ts2mi = inputfifo_get_inst(ch_id);\n\n\ts2mi->ch_id = ch_id;\n\tia_css_isys_convert_stream_format_to_mipi_format(input_format,\n\t\tMIPI_PREDICTOR_NONE,\n\t\t&s2mi->fmt_type);\n\ts2mi->two_ppc = two_ppc;\n\ts2mi->type = inputfifo_determine_type(input_format);\n\ts2mi->hblank_cycles = HBLANK_CYCLES;\n\ts2mi->marker_cycles = MARKER_CYCLES;\n\ts2mi->streaming = true;\n\n\tinputfifo_start_frame(ch_id, s2mi->fmt_type);\n\treturn;\n}\n\nvoid ia_css_inputfifo_send_line(\n    unsigned int ch_id,\n    const unsigned short *data,\n    unsigned int width,\n    const unsigned short *data2,\n    unsigned int width2)\n{\n\tstruct inputfifo_instance *s2mi;\n\n\tassert(data);\n\tassert((data2) || (width2 == 0));\n\ts2mi = inputfifo_get_inst(ch_id);\n\n\t \n\tinputfifo_curr_ch_id = (s2mi->ch_id) & _HIVE_ISP_CH_ID_MASK;\n\tinputfifo_curr_fmt_type = (s2mi->fmt_type) & _HIVE_ISP_FMT_TYPE_MASK;\n\n\tinputfifo_send_line2(data, width, data2, width2,\n\t\t\t     s2mi->hblank_cycles,\n\t\t\t     s2mi->marker_cycles,\n\t\t\t     s2mi->two_ppc,\n\t\t\t     s2mi->type);\n}\n\nvoid ia_css_inputfifo_send_embedded_line(\n    unsigned int\tch_id,\n    enum atomisp_input_format\tdata_type,\n    const unsigned short\t*data,\n    unsigned int\twidth)\n{\n\tstruct inputfifo_instance *s2mi;\n\tunsigned int fmt_type;\n\n\tassert(data);\n\ts2mi = inputfifo_get_inst(ch_id);\n\tia_css_isys_convert_stream_format_to_mipi_format(data_type,\n\t\tMIPI_PREDICTOR_NONE, &fmt_type);\n\n\t \n\tinputfifo_curr_fmt_type = fmt_type & _HIVE_ISP_FMT_TYPE_MASK;\n\n\tinputfifo_send_line(data, width, s2mi->hblank_cycles, s2mi->marker_cycles,\n\t\t\t    s2mi->two_ppc, inputfifo_mipi_data_type_regular);\n}\n\nvoid ia_css_inputfifo_end_frame(\n    unsigned int\tch_id)\n{\n\tstruct inputfifo_instance *s2mi;\n\n\ts2mi = inputfifo_get_inst(ch_id);\n\n\t \n\tinputfifo_curr_ch_id = (s2mi->ch_id) & _HIVE_ISP_CH_ID_MASK;\n\tinputfifo_curr_fmt_type = (s2mi->fmt_type) & _HIVE_ISP_FMT_TYPE_MASK;\n\n\t \n\tinputfifo_end_frame(s2mi->marker_cycles);\n\n\ts2mi->streaming = false;\n\treturn;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}