{
  "module_name": "csi_rx_rmgr.c",
  "hash_id": "97e1e754275b573a655cc87801464bee175e88fa3f1d907733cb4c746743fa1c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/runtime/isys/src/csi_rx_rmgr.c",
  "human_readable_source": "\n \n\n#include \"system_global.h\"\n\n#ifdef ISP2401\n\n#include \"assert_support.h\"\n#include \"platform_support.h\"\n#include \"ia_css_isys.h\"\n#include \"bitop_support.h\"\n#include \"ia_css_pipeline.h\"\t \n#include \"sh_css_internal.h\"\t \n#include \"csi_rx_rmgr.h\"\n\nstatic isys_csi_rx_rsrc_t  isys_csi_rx_rsrc[N_CSI_RX_BACKEND_ID];\n\nvoid ia_css_isys_csi_rx_lut_rmgr_init(void)\n{\n\tmemset(isys_csi_rx_rsrc, 0, sizeof(isys_csi_rx_rsrc));\n}\n\nvoid ia_css_isys_csi_rx_lut_rmgr_uninit(void)\n{\n\tmemset(isys_csi_rx_rsrc, 0, sizeof(isys_csi_rx_rsrc));\n}\n\nbool ia_css_isys_csi_rx_lut_rmgr_acquire(\n    csi_rx_backend_ID_t\t\tbackend,\n    csi_mipi_packet_type_t\t\tpacket_type,\n    csi_rx_backend_lut_entry_t\t*entry)\n{\n\tbool retval = false;\n\tu32 max_num_packets_of_type;\n\tu32 num_active_of_type;\n\tisys_csi_rx_rsrc_t *cur_rsrc = NULL;\n\tu16 i;\n\n\tassert(backend < N_CSI_RX_BACKEND_ID);\n\tassert((packet_type == CSI_MIPI_PACKET_TYPE_LONG) ||\n\t       (packet_type == CSI_MIPI_PACKET_TYPE_SHORT));\n\tassert(entry);\n\n\tif ((backend < N_CSI_RX_BACKEND_ID) && (entry)) {\n\t\tcur_rsrc = &isys_csi_rx_rsrc[backend];\n\t\tif (packet_type == CSI_MIPI_PACKET_TYPE_LONG) {\n\t\t\tmax_num_packets_of_type = N_LONG_PACKET_LUT_ENTRIES[backend];\n\t\t\tnum_active_of_type = cur_rsrc->num_long_packets;\n\t\t} else {\n\t\t\tmax_num_packets_of_type = N_SHORT_PACKET_LUT_ENTRIES[backend];\n\t\t\tnum_active_of_type = cur_rsrc->num_short_packets;\n\t\t}\n\n\t\tif (num_active_of_type < max_num_packets_of_type) {\n\t\t\tfor (i = 0; i < max_num_packets_of_type; i++) {\n\t\t\t\tif (bitop_getbit(cur_rsrc->active_table, i) == 0) {\n\t\t\t\t\tbitop_setbit(cur_rsrc->active_table, i);\n\n\t\t\t\t\tif (packet_type == CSI_MIPI_PACKET_TYPE_LONG) {\n\t\t\t\t\t\tentry->long_packet_entry = i;\n\t\t\t\t\t\tentry->short_packet_entry = 0;\n\t\t\t\t\t\tcur_rsrc->num_long_packets++;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tentry->long_packet_entry = 0;\n\t\t\t\t\t\tentry->short_packet_entry = i;\n\t\t\t\t\t\tcur_rsrc->num_short_packets++;\n\t\t\t\t\t}\n\t\t\t\t\tcur_rsrc->num_active++;\n\t\t\t\t\tretval = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn retval;\n}\n\nvoid ia_css_isys_csi_rx_lut_rmgr_release(\n    csi_rx_backend_ID_t\t\tbackend,\n    csi_mipi_packet_type_t\t\tpacket_type,\n    csi_rx_backend_lut_entry_t\t*entry)\n{\n\tu32 max_num_packets;\n\tisys_csi_rx_rsrc_t *cur_rsrc = NULL;\n\tu32 packet_entry = 0;\n\n\tassert(backend < N_CSI_RX_BACKEND_ID);\n\tassert(entry);\n\tassert((packet_type >= CSI_MIPI_PACKET_TYPE_LONG) ||\n\t       (packet_type <= CSI_MIPI_PACKET_TYPE_SHORT));\n\n\tif ((backend < N_CSI_RX_BACKEND_ID) && (entry)) {\n\t\tif (packet_type == CSI_MIPI_PACKET_TYPE_LONG) {\n\t\t\tmax_num_packets = N_LONG_PACKET_LUT_ENTRIES[backend];\n\t\t\tpacket_entry = entry->long_packet_entry;\n\t\t} else {\n\t\t\tmax_num_packets = N_SHORT_PACKET_LUT_ENTRIES[backend];\n\t\t\tpacket_entry = entry->short_packet_entry;\n\t\t}\n\n\t\tcur_rsrc = &isys_csi_rx_rsrc[backend];\n\t\tif ((packet_entry < max_num_packets) && (cur_rsrc->num_active > 0)) {\n\t\t\tif (bitop_getbit(cur_rsrc->active_table, packet_entry) == 1) {\n\t\t\t\tbitop_clearbit(cur_rsrc->active_table, packet_entry);\n\n\t\t\t\tif (packet_type == CSI_MIPI_PACKET_TYPE_LONG)\n\t\t\t\t\tcur_rsrc->num_long_packets--;\n\t\t\t\telse\n\t\t\t\t\tcur_rsrc->num_short_packets--;\n\t\t\t\tcur_rsrc->num_active--;\n\t\t\t}\n\t\t}\n\t}\n}\n\nint ia_css_isys_csi_rx_register_stream(\n    enum mipi_port_id port,\n    uint32_t isys_stream_id)\n{\n\tint retval = -EINVAL;\n\n\tif ((port < N_INPUT_SYSTEM_CSI_PORT) &&\n\t    (isys_stream_id < SH_CSS_MAX_ISYS_CHANNEL_NODES)) {\n\t\tstruct sh_css_sp_pipeline_io_status *pipe_io_status;\n\n\t\tpipe_io_status = ia_css_pipeline_get_pipe_io_status();\n\t\tif (bitop_getbit(pipe_io_status->active[port], isys_stream_id) == 0) {\n\t\t\tbitop_setbit(pipe_io_status->active[port], isys_stream_id);\n\t\t\tpipe_io_status->running[port] = 0;\n\t\t\tretval = 0;\n\t\t}\n\t}\n\treturn retval;\n}\n\nint ia_css_isys_csi_rx_unregister_stream(\n    enum mipi_port_id port,\n    uint32_t isys_stream_id)\n{\n\tint retval = -EINVAL;\n\n\tif ((port < N_INPUT_SYSTEM_CSI_PORT) &&\n\t    (isys_stream_id < SH_CSS_MAX_ISYS_CHANNEL_NODES)) {\n\t\tstruct sh_css_sp_pipeline_io_status *pipe_io_status;\n\n\t\tpipe_io_status = ia_css_pipeline_get_pipe_io_status();\n\t\tif (bitop_getbit(pipe_io_status->active[port], isys_stream_id) == 1) {\n\t\t\tbitop_clearbit(pipe_io_status->active[port], isys_stream_id);\n\t\t\tretval = 0;\n\t\t}\n\t}\n\treturn retval;\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}