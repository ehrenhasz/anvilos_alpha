{
  "module_name": "virtual_isys.c",
  "hash_id": "55b1b891b4a670d7527e5b6c56b5abd42632103c2956353c31759862af74d103",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/runtime/isys/src/virtual_isys.c",
  "human_readable_source": "\n \n\n#include <linux/string.h>  \n\n#include \"system_global.h\"\n\n#ifdef ISP2401\n\n#include \"ia_css_isys.h\"\n#include \"ia_css_debug.h\"\n#include \"math_support.h\"\n#include \"virtual_isys.h\"\n#include \"isp.h\"\n#include \"sh_css_defs.h\"\n\n \n\nstatic bool create_input_system_channel(\n    isp2401_input_system_cfg_t\t*cfg,\n    bool\t\t\tmetadata,\n    input_system_channel_t\t*channel);\n\nstatic void destroy_input_system_channel(\n    input_system_channel_t\t*channel);\n\nstatic bool create_input_system_input_port(\n    isp2401_input_system_cfg_t\t\t*cfg,\n    input_system_input_port_t\t*input_port);\n\nstatic void destroy_input_system_input_port(\n    input_system_input_port_t\t*input_port);\n\nstatic bool calculate_input_system_channel_cfg(\n    input_system_channel_t\t\t*channel,\n    input_system_input_port_t\t*input_port,\n    isp2401_input_system_cfg_t\t\t*isys_cfg,\n    input_system_channel_cfg_t\t*channel_cfg,\n    bool metadata);\n\nstatic bool calculate_input_system_input_port_cfg(\n    input_system_channel_t\t\t*channel,\n    input_system_input_port_t\t*input_port,\n    isp2401_input_system_cfg_t\t\t*isys_cfg,\n    input_system_input_port_cfg_t\t*input_port_cfg);\n\nstatic bool acquire_sid(\n    stream2mmio_ID_t\tstream2mmio,\n    stream2mmio_sid_ID_t\t*sid);\n\nstatic void release_sid(\n    stream2mmio_ID_t\tstream2mmio,\n    stream2mmio_sid_ID_t\t*sid);\n\nstatic bool acquire_ib_buffer(\n    s32 bits_per_pixel,\n    s32 pixels_per_line,\n    s32 lines_per_frame,\n    s32 align_in_bytes,\n    bool online,\n    isp2401_ib_buffer_t *buf);\n\nstatic void release_ib_buffer(\n    isp2401_ib_buffer_t *buf);\n\nstatic bool acquire_dma_channel(\n    isys2401_dma_ID_t\tdma_id,\n    isys2401_dma_channel\t*channel);\n\nstatic void release_dma_channel(\n    isys2401_dma_ID_t\tdma_id,\n    isys2401_dma_channel\t*channel);\n\nstatic bool acquire_be_lut_entry(\n    csi_rx_backend_ID_t\t\tbackend,\n    csi_mipi_packet_type_t\t\tpacket_type,\n    csi_rx_backend_lut_entry_t\t*entry);\n\nstatic void release_be_lut_entry(\n    csi_rx_backend_ID_t\t\tbackend,\n    csi_mipi_packet_type_t\t\tpacket_type,\n    csi_rx_backend_lut_entry_t\t*entry);\n\nstatic bool calculate_tpg_cfg(\n    input_system_channel_t\t\t*channel,\n    input_system_input_port_t\t*input_port,\n    isp2401_input_system_cfg_t\t\t*isys_cfg,\n    pixelgen_tpg_cfg_t\t\t*cfg);\n\nstatic bool calculate_prbs_cfg(\n    input_system_channel_t\t\t*channel,\n    input_system_input_port_t\t*input_port,\n    isp2401_input_system_cfg_t\t\t*isys_cfg,\n    pixelgen_prbs_cfg_t\t\t*cfg);\n\nstatic bool calculate_fe_cfg(\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    csi_rx_frontend_cfg_t\t\t*cfg);\n\nstatic bool calculate_be_cfg(\n    const input_system_input_port_t\t*input_port,\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    bool\t\t\t\tmetadata,\n    csi_rx_backend_cfg_t\t\t*cfg);\n\nstatic bool calculate_stream2mmio_cfg(\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    bool\t\t\t\tmetadata,\n    stream2mmio_cfg_t\t\t*cfg);\n\nstatic bool calculate_ibuf_ctrl_cfg(\n    const input_system_channel_t\t*channel,\n    const input_system_input_port_t\t*input_port,\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    ibuf_ctrl_cfg_t\t\t\t*cfg);\n\nstatic bool calculate_isys2401_dma_cfg(\n    const input_system_channel_t\t*channel,\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    isys2401_dma_cfg_t\t\t*cfg);\n\nstatic bool calculate_isys2401_dma_port_cfg(\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    bool\t\t\t\traw_packed,\n    bool\t\t\t\tmetadata,\n    isys2401_dma_port_cfg_t\t\t*cfg);\n\nstatic csi_mipi_packet_type_t get_csi_mipi_packet_type(\n    int32_t data_type);\n\nstatic int32_t calculate_stride(\n    s32 bits_per_pixel,\n    s32 pixels_per_line,\n    bool\traw_packed,\n    int32_t\talign_in_bytes);\n\n \n\n \nia_css_isys_error_t ia_css_isys_stream_create(\n    ia_css_isys_descr_t\t*isys_stream_descr,\n    ia_css_isys_stream_h\tisys_stream,\n    uint32_t isys_stream_id)\n{\n\tia_css_isys_error_t rc;\n\n\tif (!isys_stream_descr || !isys_stream ||\n\t    isys_stream_id >= SH_CSS_MAX_ISYS_CHANNEL_NODES)\n\t\treturn\tfalse;\n\n\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE_PRIVATE,\n\t\t\t    \"ia_css_isys_stream_create() enter:\\n\");\n\n\t \n\tmemset(isys_stream, 0, sizeof(*isys_stream));\n\tisys_stream->enable_metadata = isys_stream_descr->metadata.enable;\n\tisys_stream->id = isys_stream_id;\n\n\tisys_stream->linked_isys_stream_id = isys_stream_descr->linked_isys_stream_id;\n\trc = create_input_system_input_port(isys_stream_descr,\n\t\t\t\t\t    &isys_stream->input_port);\n\tif (!rc)\n\t\treturn false;\n\n\trc = create_input_system_channel(isys_stream_descr, false,\n\t\t\t\t\t &isys_stream->channel);\n\tif (!rc) {\n\t\tdestroy_input_system_input_port(&isys_stream->input_port);\n\t\treturn false;\n\t}\n\n\t \n\tif (isys_stream_descr->metadata.enable) {\n\t\trc = create_input_system_channel(isys_stream_descr, true,\n\t\t\t\t\t\t &isys_stream->md_channel);\n\t\tif (!rc) {\n\t\t\tdestroy_input_system_input_port(&isys_stream->input_port);\n\t\t\tdestroy_input_system_channel(&isys_stream->channel);\n\t\t\treturn false;\n\t\t}\n\t}\n\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE_PRIVATE,\n\t\t\t    \"ia_css_isys_stream_create() leave:\\n\");\n\n\treturn true;\n}\n\nvoid ia_css_isys_stream_destroy(\n    ia_css_isys_stream_h\tisys_stream)\n{\n\tdestroy_input_system_input_port(&isys_stream->input_port);\n\tdestroy_input_system_channel(&isys_stream->channel);\n\tif (isys_stream->enable_metadata) {\n\t\t \n\t\tdestroy_input_system_channel(&isys_stream->md_channel);\n\t}\n}\n\nia_css_isys_error_t ia_css_isys_stream_calculate_cfg(\n    ia_css_isys_stream_h\t\tisys_stream,\n    ia_css_isys_descr_t\t\t*isys_stream_descr,\n    ia_css_isys_stream_cfg_t\t*isys_stream_cfg)\n{\n\tia_css_isys_error_t rc;\n\n\tif (!isys_stream_cfg\t\t||\n\t    !isys_stream_descr\t||\n\t    !isys_stream)\n\t\treturn false;\n\n\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE_PRIVATE,\n\t\t\t    \"ia_css_isys_stream_calculate_cfg() enter:\\n\");\n\n\trc  = calculate_input_system_channel_cfg(\n\t\t  &isys_stream->channel,\n\t\t  &isys_stream->input_port,\n\t\t  isys_stream_descr,\n\t\t  &isys_stream_cfg->channel_cfg,\n\t\t  false);\n\tif (!rc)\n\t\treturn false;\n\n\t \n\tif (isys_stream_descr->metadata.enable) {\n\t\tisys_stream_cfg->enable_metadata = true;\n\t\trc  = calculate_input_system_channel_cfg(\n\t\t\t  &isys_stream->md_channel,\n\t\t\t  &isys_stream->input_port,\n\t\t\t  isys_stream_descr,\n\t\t\t  &isys_stream_cfg->md_channel_cfg,\n\t\t\t  true);\n\t\tif (!rc)\n\t\t\treturn false;\n\t}\n\n\trc = calculate_input_system_input_port_cfg(\n\t\t &isys_stream->channel,\n\t\t &isys_stream->input_port,\n\t\t isys_stream_descr,\n\t\t &isys_stream_cfg->input_port_cfg);\n\tif (!rc)\n\t\treturn false;\n\n\tisys_stream->valid = 1;\n\tisys_stream_cfg->valid = 1;\n\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE_PRIVATE,\n\t\t\t    \"ia_css_isys_stream_calculate_cfg() leave:\\n\");\n\treturn rc;\n}\n\n \n\n \nstatic bool create_input_system_channel(\n    isp2401_input_system_cfg_t\t*cfg,\n    bool\t\t\tmetadata,\n    input_system_channel_t\t*me)\n{\n\tbool rc = true;\n\n\tme->dma_id = ISYS2401_DMA0_ID;\n\n\tswitch (cfg->input_port_id) {\n\tcase INPUT_SYSTEM_CSI_PORT0_ID:\n\tcase INPUT_SYSTEM_PIXELGEN_PORT0_ID:\n\t\tme->stream2mmio_id = STREAM2MMIO0_ID;\n\t\tme->ibuf_ctrl_id = IBUF_CTRL0_ID;\n\t\tbreak;\n\n\tcase INPUT_SYSTEM_CSI_PORT1_ID:\n\tcase INPUT_SYSTEM_PIXELGEN_PORT1_ID:\n\t\tme->stream2mmio_id = STREAM2MMIO1_ID;\n\t\tme->ibuf_ctrl_id = IBUF_CTRL1_ID;\n\t\tbreak;\n\n\tcase INPUT_SYSTEM_CSI_PORT2_ID:\n\tcase INPUT_SYSTEM_PIXELGEN_PORT2_ID:\n\t\tme->stream2mmio_id = STREAM2MMIO2_ID;\n\t\tme->ibuf_ctrl_id = IBUF_CTRL2_ID;\n\t\tbreak;\n\tdefault:\n\t\trc = false;\n\t\tbreak;\n\t}\n\n\tif (!rc)\n\t\treturn false;\n\n\tif (!acquire_sid(me->stream2mmio_id, &me->stream2mmio_sid_id)) {\n\t\treturn false;\n\t}\n\n\tif (!acquire_ib_buffer(\n\t\tmetadata ? cfg->metadata.bits_per_pixel :\n\t\tcfg->input_port_resolution.bits_per_pixel,\n\t\tmetadata ? cfg->metadata.pixels_per_line :\n\t\tcfg->input_port_resolution.pixels_per_line,\n\t\tmetadata ? cfg->metadata.lines_per_frame :\n\t\tcfg->input_port_resolution.lines_per_frame,\n\t\tmetadata ? cfg->metadata.align_req_in_bytes :\n\t\tcfg->input_port_resolution.align_req_in_bytes,\n\t\tcfg->online,\n\t\t&me->ib_buffer)) {\n\t\trelease_sid(me->stream2mmio_id, &me->stream2mmio_sid_id);\n\t\treturn false;\n\t}\n\n\tif (!acquire_dma_channel(me->dma_id, &me->dma_channel)) {\n\t\trelease_sid(me->stream2mmio_id, &me->stream2mmio_sid_id);\n\t\trelease_ib_buffer(&me->ib_buffer);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic void destroy_input_system_channel(\n    input_system_channel_t\t*me)\n{\n\trelease_sid(me->stream2mmio_id,\n\t\t    &me->stream2mmio_sid_id);\n\n\trelease_ib_buffer(&me->ib_buffer);\n\n\trelease_dma_channel(me->dma_id, &me->dma_channel);\n}\n\nstatic bool create_input_system_input_port(\n    isp2401_input_system_cfg_t\t\t*cfg,\n    input_system_input_port_t\t*me)\n{\n\tcsi_mipi_packet_type_t packet_type;\n\tbool rc = true;\n\n\tswitch (cfg->input_port_id) {\n\tcase INPUT_SYSTEM_CSI_PORT0_ID:\n\t\tme->csi_rx.frontend_id = CSI_RX_FRONTEND0_ID;\n\t\tme->csi_rx.backend_id = CSI_RX_BACKEND0_ID;\n\n\t\tpacket_type = get_csi_mipi_packet_type(cfg->csi_port_attr.fmt_type);\n\t\tme->csi_rx.packet_type = packet_type;\n\n\t\trc = acquire_be_lut_entry(\n\t\t\t me->csi_rx.backend_id,\n\t\t\t packet_type,\n\t\t\t &me->csi_rx.backend_lut_entry);\n\t\tbreak;\n\tcase INPUT_SYSTEM_PIXELGEN_PORT0_ID:\n\t\tme->pixelgen.pixelgen_id = PIXELGEN0_ID;\n\t\tbreak;\n\tcase INPUT_SYSTEM_CSI_PORT1_ID:\n\t\tme->csi_rx.frontend_id = CSI_RX_FRONTEND1_ID;\n\t\tme->csi_rx.backend_id = CSI_RX_BACKEND1_ID;\n\n\t\tpacket_type = get_csi_mipi_packet_type(cfg->csi_port_attr.fmt_type);\n\t\tme->csi_rx.packet_type = packet_type;\n\n\t\trc = acquire_be_lut_entry(\n\t\t\t me->csi_rx.backend_id,\n\t\t\t packet_type,\n\t\t\t &me->csi_rx.backend_lut_entry);\n\t\tbreak;\n\tcase INPUT_SYSTEM_PIXELGEN_PORT1_ID:\n\t\tme->pixelgen.pixelgen_id = PIXELGEN1_ID;\n\n\t\tbreak;\n\tcase INPUT_SYSTEM_CSI_PORT2_ID:\n\t\tme->csi_rx.frontend_id = CSI_RX_FRONTEND2_ID;\n\t\tme->csi_rx.backend_id = CSI_RX_BACKEND2_ID;\n\n\t\tpacket_type = get_csi_mipi_packet_type(cfg->csi_port_attr.fmt_type);\n\t\tme->csi_rx.packet_type = packet_type;\n\n\t\trc = acquire_be_lut_entry(\n\t\t\t me->csi_rx.backend_id,\n\t\t\t packet_type,\n\t\t\t &me->csi_rx.backend_lut_entry);\n\t\tbreak;\n\tcase INPUT_SYSTEM_PIXELGEN_PORT2_ID:\n\t\tme->pixelgen.pixelgen_id = PIXELGEN2_ID;\n\t\tbreak;\n\tdefault:\n\t\trc = false;\n\t\tbreak;\n\t}\n\n\tme->source_type = cfg->mode;\n\n\t \n\tme->metadata.packet_type = CSI_MIPI_PACKET_TYPE_UNDEFINED;\n\tif (rc && cfg->metadata.enable) {\n\t\tme->metadata.packet_type = get_csi_mipi_packet_type(\n\t\t\t\t\t       cfg->metadata.fmt_type);\n\t\trc = acquire_be_lut_entry(\n\t\t\t me->csi_rx.backend_id,\n\t\t\t me->metadata.packet_type,\n\t\t\t &me->metadata.backend_lut_entry);\n\t}\n\n\treturn rc;\n}\n\nstatic void destroy_input_system_input_port(\n    input_system_input_port_t\t*me)\n{\n\tif (me->source_type == INPUT_SYSTEM_SOURCE_TYPE_SENSOR) {\n\t\trelease_be_lut_entry(\n\t\t    me->csi_rx.backend_id,\n\t\t    me->csi_rx.packet_type,\n\t\t    &me->csi_rx.backend_lut_entry);\n\t}\n\n\tif (me->metadata.packet_type != CSI_MIPI_PACKET_TYPE_UNDEFINED) {\n\t\t \n\t\trelease_be_lut_entry(\n\t\t    me->csi_rx.backend_id,\n\t\t    me->metadata.packet_type,\n\t\t    &me->metadata.backend_lut_entry);\n\t}\n}\n\nstatic bool calculate_input_system_channel_cfg(\n    input_system_channel_t\t\t*channel,\n    input_system_input_port_t\t*input_port,\n    isp2401_input_system_cfg_t\t\t*isys_cfg,\n    input_system_channel_cfg_t\t*channel_cfg,\n    bool metadata)\n{\n\tbool rc;\n\n\trc = calculate_stream2mmio_cfg(isys_cfg, metadata,\n\t\t\t\t       &channel_cfg->stream2mmio_cfg);\n\tif (!rc)\n\t\treturn false;\n\n\trc = calculate_ibuf_ctrl_cfg(\n\t\t channel,\n\t\t input_port,\n\t\t isys_cfg,\n\t\t &channel_cfg->ibuf_ctrl_cfg);\n\tif (!rc)\n\t\treturn false;\n\tif (metadata)\n\t\tchannel_cfg->ibuf_ctrl_cfg.stores_per_frame =\n\t\t    isys_cfg->metadata.lines_per_frame;\n\n\trc = calculate_isys2401_dma_cfg(\n\t\t channel,\n\t\t isys_cfg,\n\t\t &channel_cfg->dma_cfg);\n\tif (!rc)\n\t\treturn false;\n\n\trc = calculate_isys2401_dma_port_cfg(\n\t\t isys_cfg,\n\t\t false,\n\t\t metadata,\n\t\t &channel_cfg->dma_src_port_cfg);\n\tif (!rc)\n\t\treturn false;\n\n\trc = calculate_isys2401_dma_port_cfg(\n\t\t isys_cfg,\n\t\t isys_cfg->raw_packed,\n\t\t metadata,\n\t\t &channel_cfg->dma_dest_port_cfg);\n\tif (!rc)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic bool calculate_input_system_input_port_cfg(\n    input_system_channel_t\t\t*channel,\n    input_system_input_port_t\t*input_port,\n    isp2401_input_system_cfg_t\t\t*isys_cfg,\n    input_system_input_port_cfg_t\t*input_port_cfg)\n{\n\tbool rc;\n\n\tswitch (input_port->source_type) {\n\tcase INPUT_SYSTEM_SOURCE_TYPE_SENSOR:\n\t\trc  = calculate_fe_cfg(\n\t\t\t  isys_cfg,\n\t\t\t  &input_port_cfg->csi_rx_cfg.frontend_cfg);\n\n\t\trc &= calculate_be_cfg(\n\t\t\t  input_port,\n\t\t\t  isys_cfg,\n\t\t\t  false,\n\t\t\t  &input_port_cfg->csi_rx_cfg.backend_cfg);\n\n\t\tif (rc && isys_cfg->metadata.enable)\n\t\t\trc &= calculate_be_cfg(input_port, isys_cfg, true,\n\t\t\t\t\t       &input_port_cfg->csi_rx_cfg.md_backend_cfg);\n\t\tbreak;\n\tcase INPUT_SYSTEM_SOURCE_TYPE_TPG:\n\t\trc = calculate_tpg_cfg(\n\t\t\t channel,\n\t\t\t input_port,\n\t\t\t isys_cfg,\n\t\t\t &input_port_cfg->pixelgen_cfg.tpg_cfg);\n\t\tbreak;\n\tcase INPUT_SYSTEM_SOURCE_TYPE_PRBS:\n\t\trc = calculate_prbs_cfg(\n\t\t\t channel,\n\t\t\t input_port,\n\t\t\t isys_cfg,\n\t\t\t &input_port_cfg->pixelgen_cfg.prbs_cfg);\n\t\tbreak;\n\tdefault:\n\t\trc = false;\n\t\tbreak;\n\t}\n\n\treturn rc;\n}\n\nstatic bool acquire_sid(\n    stream2mmio_ID_t\tstream2mmio,\n    stream2mmio_sid_ID_t\t*sid)\n{\n\treturn ia_css_isys_stream2mmio_sid_rmgr_acquire(stream2mmio, sid);\n}\n\nstatic void release_sid(\n    stream2mmio_ID_t\tstream2mmio,\n    stream2mmio_sid_ID_t\t*sid)\n{\n\tia_css_isys_stream2mmio_sid_rmgr_release(stream2mmio, sid);\n}\n\n \nstatic int32_t calculate_stride(\n    s32 bits_per_pixel,\n    s32 pixels_per_line,\n    bool\traw_packed,\n    int32_t align_in_bytes)\n{\n\ts32 bytes_per_line;\n\ts32 pixels_per_word;\n\ts32 words_per_line;\n\ts32 pixels_per_line_padded;\n\n\tpixels_per_line_padded = CEIL_MUL(pixels_per_line, align_in_bytes);\n\n\tif (!raw_packed)\n\t\tbits_per_pixel = CEIL_MUL(bits_per_pixel, 8);\n\n\tpixels_per_word = HIVE_ISP_DDR_WORD_BITS / bits_per_pixel;\n\twords_per_line  = ceil_div(pixels_per_line_padded, pixels_per_word);\n\tbytes_per_line  = HIVE_ISP_DDR_WORD_BYTES * words_per_line;\n\n\treturn bytes_per_line;\n}\n\nstatic bool acquire_ib_buffer(\n    s32 bits_per_pixel,\n    s32 pixels_per_line,\n    s32 lines_per_frame,\n    s32 align_in_bytes,\n    bool online,\n    isp2401_ib_buffer_t *buf)\n{\n\tbuf->stride = calculate_stride(bits_per_pixel, pixels_per_line, false,\n\t\t\t\t       align_in_bytes);\n\tif (online)\n\t\tbuf->lines = 4;  \n\telse\n\t\tbuf->lines = 2;\n\n\t(void)(lines_per_frame);\n\treturn ia_css_isys_ibuf_rmgr_acquire(buf->stride * buf->lines,\n\t\t\t\t\t     &buf->start_addr);\n}\n\nstatic void release_ib_buffer(\n    isp2401_ib_buffer_t *buf)\n{\n\tia_css_isys_ibuf_rmgr_release(&buf->start_addr);\n}\n\nstatic bool acquire_dma_channel(\n    isys2401_dma_ID_t\tdma_id,\n    isys2401_dma_channel\t*channel)\n{\n\treturn ia_css_isys_dma_channel_rmgr_acquire(dma_id, channel);\n}\n\nstatic void release_dma_channel(\n    isys2401_dma_ID_t\tdma_id,\n    isys2401_dma_channel\t*channel)\n{\n\tia_css_isys_dma_channel_rmgr_release(dma_id, channel);\n}\n\nstatic bool acquire_be_lut_entry(\n    csi_rx_backend_ID_t\t\tbackend,\n    csi_mipi_packet_type_t\t\tpacket_type,\n    csi_rx_backend_lut_entry_t\t*entry)\n{\n\treturn ia_css_isys_csi_rx_lut_rmgr_acquire(backend, packet_type, entry);\n}\n\nstatic void release_be_lut_entry(\n    csi_rx_backend_ID_t\t\tbackend,\n    csi_mipi_packet_type_t\t\tpacket_type,\n    csi_rx_backend_lut_entry_t\t*entry)\n{\n\tia_css_isys_csi_rx_lut_rmgr_release(backend, packet_type, entry);\n}\n\nstatic bool calculate_tpg_cfg(\n    input_system_channel_t\t\t*channel,\n    input_system_input_port_t\t*input_port,\n    isp2401_input_system_cfg_t\t\t*isys_cfg,\n    pixelgen_tpg_cfg_t\t\t*cfg)\n{\n\tmemcpy(cfg, &isys_cfg->tpg_port_attr, sizeof(pixelgen_tpg_cfg_t));\n\n\treturn true;\n}\n\nstatic bool calculate_prbs_cfg(\n    input_system_channel_t\t\t*channel,\n    input_system_input_port_t\t*input_port,\n    isp2401_input_system_cfg_t\t\t*isys_cfg,\n    pixelgen_prbs_cfg_t\t\t*cfg)\n{\n\tmemcpy(cfg, &isys_cfg->prbs_port_attr, sizeof(pixelgen_prbs_cfg_t));\n\n\treturn true;\n}\n\nstatic bool calculate_fe_cfg(\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    csi_rx_frontend_cfg_t\t\t*cfg)\n{\n\tcfg->active_lanes = isys_cfg->csi_port_attr.active_lanes;\n\treturn true;\n}\n\nstatic bool calculate_be_cfg(\n    const input_system_input_port_t\t*input_port,\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    bool\t\t\t\tmetadata,\n    csi_rx_backend_cfg_t\t\t*cfg)\n{\n\tmemcpy(&cfg->lut_entry,\n\t      metadata ? &input_port->metadata.backend_lut_entry :\n\t\t\t &input_port->csi_rx.backend_lut_entry,\n\t      sizeof(csi_rx_backend_lut_entry_t));\n\n\tcfg->csi_mipi_cfg.virtual_channel = isys_cfg->csi_port_attr.ch_id;\n\tif (metadata) {\n\t\tcfg->csi_mipi_packet_type = get_csi_mipi_packet_type(\n\t\t\t\t\t\tisys_cfg->metadata.fmt_type);\n\t\tcfg->csi_mipi_cfg.comp_enable = false;\n\t\tcfg->csi_mipi_cfg.data_type = isys_cfg->metadata.fmt_type;\n\t} else {\n\t\tcfg->csi_mipi_packet_type = get_csi_mipi_packet_type(\n\t\t\t\t\t\tisys_cfg->csi_port_attr.fmt_type);\n\t\tcfg->csi_mipi_cfg.data_type = isys_cfg->csi_port_attr.fmt_type;\n\t\tcfg->csi_mipi_cfg.comp_enable = isys_cfg->csi_port_attr.comp_enable;\n\t\tcfg->csi_mipi_cfg.comp_scheme = isys_cfg->csi_port_attr.comp_scheme;\n\t\tcfg->csi_mipi_cfg.comp_predictor = isys_cfg->csi_port_attr.comp_predictor;\n\t\tcfg->csi_mipi_cfg.comp_bit_idx = cfg->csi_mipi_cfg.data_type -\n\t\t\t\t\t\t MIPI_FORMAT_CUSTOM0;\n\t}\n\n\treturn true;\n}\n\nstatic bool calculate_stream2mmio_cfg(\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    bool\t\t\t\tmetadata,\n    stream2mmio_cfg_t\t\t*cfg\n)\n{\n\tcfg->bits_per_pixel = metadata ? isys_cfg->metadata.bits_per_pixel :\n\t\t\t      isys_cfg->input_port_resolution.bits_per_pixel;\n\n\tcfg->enable_blocking =\n\t    ((isys_cfg->mode == INPUT_SYSTEM_SOURCE_TYPE_TPG) ||\n\t     (isys_cfg->mode == INPUT_SYSTEM_SOURCE_TYPE_PRBS));\n\n\treturn true;\n}\n\nstatic bool calculate_ibuf_ctrl_cfg(\n    const input_system_channel_t\t*channel,\n    const input_system_input_port_t\t*input_port,\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    ibuf_ctrl_cfg_t\t\t\t*cfg)\n{\n\tconst s32 bits_per_byte = 8;\n\ts32 bits_per_pixel;\n\ts32 bytes_per_pixel;\n\ts32 left_padding;\n\n\t(void)input_port;\n\n\tbits_per_pixel = isys_cfg->input_port_resolution.bits_per_pixel;\n\tbytes_per_pixel = ceil_div(bits_per_pixel, bits_per_byte);\n\n\tleft_padding = CEIL_MUL(isys_cfg->output_port_attr.left_padding, ISP_VEC_NELEMS)\n\t\t       * bytes_per_pixel;\n\n\tcfg->online\t= isys_cfg->online;\n\n\tcfg->dma_cfg.channel\t= channel->dma_channel;\n\tcfg->dma_cfg.cmd\t= _DMA_V2_MOVE_A2B_NO_SYNC_CHK_COMMAND;\n\n\tcfg->dma_cfg.shift_returned_items\t= 0;\n\tcfg->dma_cfg.elems_per_word_in_ibuf\t= 0;\n\tcfg->dma_cfg.elems_per_word_in_dest\t= 0;\n\n\tcfg->ib_buffer.start_addr\t\t= channel->ib_buffer.start_addr;\n\tcfg->ib_buffer.stride\t\t\t= channel->ib_buffer.stride;\n\tcfg->ib_buffer.lines\t\t\t= channel->ib_buffer.lines;\n\n\t \n\n\t \n\tif (cfg->online) {\n\t\tcfg->dest_buf_cfg.start_addr\t= ISP_INPUT_BUF_START_ADDR + left_padding;\n\t\tcfg->dest_buf_cfg.stride\t= bytes_per_pixel\n\t\t\t\t\t      * isys_cfg->output_port_attr.max_isp_input_width;\n\t\tcfg->dest_buf_cfg.lines\t\t= LINES_OF_ISP_INPUT_BUF;\n\t} else if (isys_cfg->raw_packed) {\n\t\tcfg->dest_buf_cfg.stride\t= calculate_stride(bits_per_pixel,\n\t\t\t\t\t      isys_cfg->input_port_resolution.pixels_per_line,\n\t\t\t\t\t      isys_cfg->raw_packed,\n\t\t\t\t\t      isys_cfg->input_port_resolution.align_req_in_bytes);\n\t} else {\n\t\tcfg->dest_buf_cfg.stride\t= channel->ib_buffer.stride;\n\t}\n\n\t \n\tcfg->items_per_store\t\t= 1;\n\n\tcfg->stores_per_frame\t\t= isys_cfg->input_port_resolution.lines_per_frame;\n\n\tcfg->stream2mmio_cfg.sync_cmd\t= _STREAM2MMIO_CMD_TOKEN_SYNC_FRAME;\n\n\t \n\tcfg->stream2mmio_cfg.store_cmd\t= _STREAM2MMIO_CMD_TOKEN_STORE_PACKETS;\n\n\treturn true;\n}\n\nstatic bool calculate_isys2401_dma_cfg(\n    const input_system_channel_t\t*channel,\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    isys2401_dma_cfg_t\t\t*cfg)\n{\n\tcfg->channel\t= channel->dma_channel;\n\n\t \n\tif (isys_cfg->online)\n\t\tcfg->connection = isys2401_dma_ibuf_to_vmem_connection;\n\telse\n\t\tcfg->connection = isys2401_dma_ibuf_to_ddr_connection;\n\n\tcfg->extension\t= isys2401_dma_zero_extension;\n\tcfg->height\t= 1;\n\n\treturn true;\n}\n\n \nstatic bool calculate_isys2401_dma_port_cfg(\n    const isp2401_input_system_cfg_t\t*isys_cfg,\n    bool\t\t\t\traw_packed,\n    bool\t\t\t\tmetadata,\n    isys2401_dma_port_cfg_t\t\t*cfg)\n{\n\ts32 bits_per_pixel;\n\ts32 pixels_per_line;\n\ts32 align_req_in_bytes;\n\n\t \n\tif (metadata) {\n\t\tbits_per_pixel = isys_cfg->metadata.bits_per_pixel;\n\t\tpixels_per_line = isys_cfg->metadata.pixels_per_line;\n\t\talign_req_in_bytes = isys_cfg->metadata.align_req_in_bytes;\n\t} else {\n\t\tbits_per_pixel = isys_cfg->input_port_resolution.bits_per_pixel;\n\t\tpixels_per_line = isys_cfg->input_port_resolution.pixels_per_line;\n\t\talign_req_in_bytes = isys_cfg->input_port_resolution.align_req_in_bytes;\n\t}\n\n\tcfg->stride\t= calculate_stride(bits_per_pixel, pixels_per_line, raw_packed,\n\t\t\t\t       align_req_in_bytes);\n\n\tif (!raw_packed)\n\t\tbits_per_pixel = CEIL_MUL(bits_per_pixel, 8);\n\n\tcfg->elements\t= HIVE_ISP_DDR_WORD_BITS / bits_per_pixel;\n\tcfg->cropping\t= 0;\n\tcfg->width\t= CEIL_DIV(cfg->stride, HIVE_ISP_DDR_WORD_BYTES);\n\n\treturn true;\n}\n\nstatic csi_mipi_packet_type_t get_csi_mipi_packet_type(\n    int32_t data_type)\n{\n\tcsi_mipi_packet_type_t packet_type;\n\n\tpacket_type = CSI_MIPI_PACKET_TYPE_RESERVED;\n\n\tif (data_type >= 0 && data_type <= MIPI_FORMAT_SHORT8)\n\t\tpacket_type = CSI_MIPI_PACKET_TYPE_SHORT;\n\n\tif (data_type > MIPI_FORMAT_SHORT8 && data_type <= N_MIPI_FORMAT)\n\t\tpacket_type = CSI_MIPI_PACKET_TYPE_LONG;\n\n\treturn packet_type;\n}\n\n \n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}