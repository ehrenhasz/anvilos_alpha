{
  "module_name": "binary.c",
  "hash_id": "8425c3a5eaa5c564d65e7416533e2f0debe2c64575a2315d829a17bd0fbd9d1d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/runtime/binary/src/binary.c",
  "human_readable_source": "\n \n\n#include <linux/math.h>\n\n#include <math_support.h>\n#include <gdc_device.h>\t \n\n#include \"hmm.h\"\n\n#include \"isp.h\"\t \n\n#include \"ia_css_binary.h\"\n#include \"ia_css_debug.h\"\n#include \"ia_css_util.h\"\n#include \"ia_css_isp_param.h\"\n#include \"sh_css_internal.h\"\n#include \"sh_css_sp.h\"\n#include \"sh_css_firmware.h\"\n#include \"sh_css_defs.h\"\n#include \"sh_css_legacy.h\"\n\n#include \"atomisp_internal.h\"\n\n#include \"vf/vf_1.0/ia_css_vf.host.h\"\n#include \"sc/sc_1.0/ia_css_sc.host.h\"\n#include \"sdis/sdis_1.0/ia_css_sdis.host.h\"\n#include \"fixedbds/fixedbds_1.0/ia_css_fixedbds_param.h\"\t \n\n#include \"camera/pipe/interface/ia_css_pipe_binarydesc.h\"\n\n#include \"assert_support.h\"\n\n#define IMPLIES(a, b)           (!(a) || (b))    \n\nstatic struct ia_css_binary_xinfo *all_binaries;  \nstatic struct ia_css_binary_xinfo\n\t*binary_infos[IA_CSS_BINARY_NUM_MODES] = { NULL, };\n\nstatic void\nia_css_binary_dvs_env(const struct ia_css_binary_info *info,\n\t\t      const struct ia_css_resolution *dvs_env,\n\t\t      struct ia_css_resolution *binary_dvs_env)\n{\n\tif (info->enable.dvs_envelope) {\n\t\tassert(dvs_env);\n\t\tbinary_dvs_env->width  = max(dvs_env->width, SH_CSS_MIN_DVS_ENVELOPE);\n\t\tbinary_dvs_env->height = max(dvs_env->height, SH_CSS_MIN_DVS_ENVELOPE);\n\t}\n}\n\nstatic void\nia_css_binary_internal_res(const struct ia_css_frame_info *in_info,\n\t\t\t   const struct ia_css_frame_info *bds_out_info,\n\t\t\t   const struct ia_css_frame_info *out_info,\n\t\t\t   const struct ia_css_resolution *dvs_env,\n\t\t\t   const struct ia_css_binary_info *info,\n\t\t\t   struct ia_css_resolution *internal_res)\n{\n\tunsigned int isp_tmp_internal_width = 0,\n\t\t     isp_tmp_internal_height = 0;\n\tbool binary_supports_yuv_ds = info->enable.ds & 2;\n\tstruct ia_css_resolution binary_dvs_env;\n\n\tbinary_dvs_env.width = 0;\n\tbinary_dvs_env.height = 0;\n\tia_css_binary_dvs_env(info, dvs_env, &binary_dvs_env);\n\n\tif (binary_supports_yuv_ds) {\n\t\tif (in_info) {\n\t\t\tisp_tmp_internal_width = in_info->res.width\n\t\t\t\t\t\t + info->pipeline.left_cropping + binary_dvs_env.width;\n\t\t\tisp_tmp_internal_height = in_info->res.height\n\t\t\t\t\t\t  + info->pipeline.top_cropping + binary_dvs_env.height;\n\t\t}\n\t} else if ((bds_out_info) && (out_info) &&\n\t\t    \n\t\t   (bds_out_info->res.width >= out_info->res.width)) {\n\t\tisp_tmp_internal_width = bds_out_info->padded_width;\n\t\tisp_tmp_internal_height = bds_out_info->res.height;\n\t} else {\n\t\tif (out_info) {\n\t\t\tisp_tmp_internal_width = out_info->padded_width;\n\t\t\tisp_tmp_internal_height = out_info->res.height;\n\t\t}\n\t}\n\n\t \n\tinternal_res->width = __ISP_INTERNAL_WIDTH(isp_tmp_internal_width,\n\t\t\t      (int)binary_dvs_env.width,\n\t\t\t      info->pipeline.left_cropping, info->pipeline.mode,\n\t\t\t      info->pipeline.c_subsampling,\n\t\t\t      info->output.num_chunks, info->pipeline.pipelining);\n\tinternal_res->height = __ISP_INTERNAL_HEIGHT(isp_tmp_internal_height,\n\t\t\t       info->pipeline.top_cropping,\n\t\t\t       binary_dvs_env.height);\n}\n\n \nstruct sh_css_shading_table_bayer_origin_compute_results {\n\tu32 bayer_scale_hor_ratio_in;\t \n\tu32 bayer_scale_hor_ratio_out;\t \n\tu32 bayer_scale_ver_ratio_in;\t \n\tu32 bayer_scale_ver_ratio_out;\t \n\tu32 sc_bayer_origin_x_bqs_on_shading_table;  \n\tu32 sc_bayer_origin_y_bqs_on_shading_table;  \n};\n\n \nstatic int\nia_css_binary_compute_shading_table_bayer_origin(\n    const struct ia_css_binary *binary,\t\t\t\t \n    unsigned int required_bds_factor,\t\t\t\t \n    const struct ia_css_stream_config *stream_config,\t\t \n    struct sh_css_shading_table_bayer_origin_compute_results *res)\t \n{\n\tint err;\n\n\t \n\tstruct u32_fract bds;\n\n\t \n\tunsigned int left_padding_bqs;\t\t\t \n\n\t \n\tunsigned int need_bds_factor_2_00;\n\n\t \n\tunsigned int left_padding_adjusted_bqs;\t\t \n\n\t \n\tunsigned int bad_bqs_on_left_before_bs;\t \n\tunsigned int bad_bqs_on_left_after_bs;\t \n\tunsigned int bad_bqs_on_top_before_bs;\t \n\tunsigned int bad_bqs_on_top_after_bs;\t \n\n\t \n\terr = sh_css_bds_factor_get_fract(required_bds_factor, &bds);\n\tif (err)\n\t\treturn err;\n\n\t \n\tif (stream_config->left_padding == -1)\n\t\tleft_padding_bqs = _ISP_BQS(binary->left_padding);\n\telse\n\t\tleft_padding_bqs = (unsigned int)((int)ISP_VEC_NELEMS\n\t\t\t\t   - _ISP_BQS(stream_config->left_padding));\n\n\t \n\tneed_bds_factor_2_00 = ((binary->info->sp.bds.supported_bds_factors &\n\t\t\t\t(PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_2_00) |\n\t\t\t\t PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_2_50) |\n\t\t\t\t PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_3_00) |\n\t\t\t\t PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_4_00) |\n\t\t\t\t PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_4_50) |\n\t\t\t\t PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_5_00) |\n\t\t\t\t PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_6_00) |\n\t\t\t\t PACK_BDS_FACTOR(SH_CSS_BDS_FACTOR_8_00))) != 0);\n\n\tif (need_bds_factor_2_00 && binary->info->sp.pipeline.left_cropping > 0)\n\t\tleft_padding_adjusted_bqs = left_padding_bqs + ISP_VEC_NELEMS;\n\telse\n\t\tleft_padding_adjusted_bqs = left_padding_bqs;\n\n\t \n\tbad_bqs_on_left_before_bs = 0;\n\tbad_bqs_on_top_before_bs = 0;\n\n\t \n\tbad_bqs_on_left_after_bs = 0;\n\tbad_bqs_on_top_after_bs = 0;\n\n\t \n\tres->sc_bayer_origin_x_bqs_on_shading_table =\n\t\t((left_padding_adjusted_bqs + bad_bqs_on_left_before_bs)\n\t\t* bds.denominator + bds.numerator / 2) / bds.numerator\n\t\t+ bad_bqs_on_left_after_bs;\n\t \n\tres->sc_bayer_origin_y_bqs_on_shading_table =\n\t\t(bad_bqs_on_top_before_bs * bds.denominator + bds.numerator / 2) / bds.numerator\n\t\t+ bad_bqs_on_top_after_bs;\n\t \n\n\tres->bayer_scale_hor_ratio_in  = bds.numerator;\n\tres->bayer_scale_hor_ratio_out = bds.denominator;\n\tres->bayer_scale_ver_ratio_in  = bds.numerator;\n\tres->bayer_scale_ver_ratio_out = bds.denominator;\n\n\treturn err;\n}\n\n \nstatic int\nbinary_get_shading_info_type_1(const struct ia_css_binary *binary,\t \n\t\t\t       unsigned int required_bds_factor,\t\t\t \n\t\t\t       const struct ia_css_stream_config *stream_config,\t \n\t\t\t       struct ia_css_shading_info *info)\t\t\t \n{\n\tint err;\n\tstruct sh_css_shading_table_bayer_origin_compute_results res;\n\n\tassert(binary);\n\tassert(info);\n\n\tinfo->type = IA_CSS_SHADING_CORRECTION_TYPE_1;\n\n\tinfo->info.type_1.enable\t    = binary->info->sp.enable.sc;\n\tinfo->info.type_1.num_hor_grids\t    = binary->sctbl_width_per_color;\n\tinfo->info.type_1.num_ver_grids\t    = binary->sctbl_height;\n\tinfo->info.type_1.bqs_per_grid_cell = (1 << binary->deci_factor_log2);\n\n\t \n\tinfo->info.type_1.bayer_scale_hor_ratio_in\t= 1;\n\tinfo->info.type_1.bayer_scale_hor_ratio_out\t= 1;\n\tinfo->info.type_1.bayer_scale_ver_ratio_in\t= 1;\n\tinfo->info.type_1.bayer_scale_ver_ratio_out\t= 1;\n\tinfo->info.type_1.sc_bayer_origin_x_bqs_on_shading_table = 0;\n\tinfo->info.type_1.sc_bayer_origin_y_bqs_on_shading_table = 0;\n\n\terr = ia_css_binary_compute_shading_table_bayer_origin(\n\t    binary,\n\t    required_bds_factor,\n\t    stream_config,\n\t    &res);\n\tif (err)\n\t\treturn err;\n\n\tinfo->info.type_1.bayer_scale_hor_ratio_in\t= res.bayer_scale_hor_ratio_in;\n\tinfo->info.type_1.bayer_scale_hor_ratio_out\t= res.bayer_scale_hor_ratio_out;\n\tinfo->info.type_1.bayer_scale_ver_ratio_in\t= res.bayer_scale_ver_ratio_in;\n\tinfo->info.type_1.bayer_scale_ver_ratio_out\t= res.bayer_scale_ver_ratio_out;\n\tinfo->info.type_1.sc_bayer_origin_x_bqs_on_shading_table = res.sc_bayer_origin_x_bqs_on_shading_table;\n\tinfo->info.type_1.sc_bayer_origin_y_bqs_on_shading_table = res.sc_bayer_origin_y_bqs_on_shading_table;\n\n\treturn err;\n}\n\n\nint\nia_css_binary_get_shading_info(const struct ia_css_binary *binary,\t\t\t \n\t\t\t       enum ia_css_shading_correction_type type,\t\t \n\t\t\t       unsigned int required_bds_factor,\t\t\t \n\t\t\t       const struct ia_css_stream_config *stream_config,\t \n\t\t\t       struct ia_css_shading_info *shading_info,\t\t \n\t\t\t       struct ia_css_pipe_config *pipe_config)\t\t\t \n{\n\tint err;\n\n\tassert(binary);\n\tassert(shading_info);\n\n\tIA_CSS_ENTER_PRIVATE(\"binary=%p, type=%d, required_bds_factor=%d, stream_config=%p\",\n\t\t\t     binary, type, required_bds_factor, stream_config);\n\n\tif (type == IA_CSS_SHADING_CORRECTION_TYPE_1)\n\t\terr = binary_get_shading_info_type_1(binary,\n\t\t\t\t\t\t     required_bds_factor,\n\t\t\t\t\t\t     stream_config,\n\t\t\t\t\t\t     shading_info);\n\telse\n\t\terr = -ENOTSUPP;\n\n\tIA_CSS_LEAVE_ERR_PRIVATE(err);\n\treturn err;\n}\n\nstatic void sh_css_binary_common_grid_info(const struct ia_css_binary *binary,\n\tstruct ia_css_grid_info *info)\n{\n\tassert(binary);\n\tassert(info);\n\n\tinfo->isp_in_width = binary->internal_frame_info.res.width;\n\tinfo->isp_in_height = binary->internal_frame_info.res.height;\n\n\tinfo->vamem_type = IA_CSS_VAMEM_TYPE_2;\n}\n\nvoid\nia_css_binary_dvs_grid_info(const struct ia_css_binary *binary,\n\t\t\t    struct ia_css_grid_info *info,\n\t\t\t    struct ia_css_pipe *pipe)\n{\n\tstruct ia_css_dvs_grid_info *dvs_info;\n\n\t(void)pipe;\n\tassert(binary);\n\tassert(info);\n\n\tdvs_info = &info->dvs_grid.dvs_grid_info;\n\n\t \n\tdvs_info->enable            = binary->info->sp.enable.dis;\n\tdvs_info->width             = binary->dis.grid.dim.width;\n\tdvs_info->height            = binary->dis.grid.dim.height;\n\tdvs_info->aligned_width     = binary->dis.grid.pad.width;\n\tdvs_info->aligned_height    = binary->dis.grid.pad.height;\n\tdvs_info->bqs_per_grid_cell = 1 << binary->dis.deci_factor_log2;\n\tdvs_info->num_hor_coefs     = binary->dis.coef.dim.width;\n\tdvs_info->num_ver_coefs     = binary->dis.coef.dim.height;\n\n\tsh_css_binary_common_grid_info(binary, info);\n}\n\nvoid\nia_css_binary_dvs_stat_grid_info(\n    const struct ia_css_binary *binary,\n    struct ia_css_grid_info *info,\n    struct ia_css_pipe *pipe)\n{\n\t(void)pipe;\n\tsh_css_binary_common_grid_info(binary, info);\n\treturn;\n}\n\nint\nia_css_binary_3a_grid_info(const struct ia_css_binary *binary,\n\t\t\t   struct ia_css_grid_info *info,\n\t\t\t   struct ia_css_pipe *pipe) {\n\tstruct ia_css_3a_grid_info *s3a_info;\n\tint err = 0;\n\n\tIA_CSS_ENTER_PRIVATE(\"binary=%p, info=%p, pipe=%p\",\n\t\t\t     binary, info, pipe);\n\n\tassert(binary);\n\tassert(info);\n\ts3a_info = &info->s3a_grid;\n\n\t \n\ts3a_info->enable            = binary->info->sp.enable.s3a;\n\ts3a_info->width             = binary->s3atbl_width;\n\ts3a_info->height            = binary->s3atbl_height;\n\ts3a_info->aligned_width     = binary->s3atbl_isp_width;\n\ts3a_info->aligned_height    = binary->s3atbl_isp_height;\n\ts3a_info->bqs_per_grid_cell = (1 << binary->deci_factor_log2);\n\ts3a_info->deci_factor_log2  = binary->deci_factor_log2;\n\ts3a_info->elem_bit_depth    = SH_CSS_BAYER_BITS;\n\ts3a_info->use_dmem          = binary->info->sp.s3a.s3atbl_use_dmem;\n\ts3a_info->has_histogram     = 0;\n\tIA_CSS_LEAVE_ERR_PRIVATE(err);\n\treturn err;\n}\n\nstatic void\nbinary_init_pc_histogram(struct sh_css_pc_histogram *histo)\n{\n\tassert(histo);\n\n\thisto->length = 0;\n\thisto->run = NULL;\n\thisto->stall = NULL;\n}\n\nstatic void\nbinary_init_metrics(struct sh_css_binary_metrics *metrics,\n\t\t    const struct ia_css_binary_info *info)\n{\n\tassert(metrics);\n\tassert(info);\n\n\tmetrics->mode = info->pipeline.mode;\n\tmetrics->id   = info->id;\n\tmetrics->next = NULL;\n\tbinary_init_pc_histogram(&metrics->isp_histogram);\n\tbinary_init_pc_histogram(&metrics->sp_histogram);\n}\n\n \nstatic bool\nbinary_supports_output_format(const struct ia_css_binary_xinfo *info,\n\t\t\t      enum ia_css_frame_format format)\n{\n\tint i;\n\n\tassert(info);\n\n\tfor (i = 0; i < info->num_output_formats; i++) {\n\t\tif (info->output_formats[i] == format)\n\t\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool\nbinary_supports_vf_format(const struct ia_css_binary_xinfo *info,\n\t\t\t  enum ia_css_frame_format format)\n{\n\tint i;\n\n\tassert(info);\n\n\tfor (i = 0; i < info->num_vf_formats; i++) {\n\t\tif (info->vf_formats[i] == format)\n\t\t\treturn true;\n\t}\n\treturn false;\n}\n\n \nstatic bool\nsupports_bds_factor(u32 supported_factors,\n\t\t    uint32_t bds_factor)\n{\n\treturn ((supported_factors & PACK_BDS_FACTOR(bds_factor)) != 0);\n}\n\nstatic int\nbinary_init_info(struct ia_css_binary_xinfo *info, unsigned int i,\n\t\t bool *binary_found) {\n\tconst unsigned char *blob = sh_css_blob_info[i].blob;\n\tunsigned int size = sh_css_blob_info[i].header.blob.size;\n\n\tif ((!info) || (!binary_found))\n\t\treturn -EINVAL;\n\n\t*info = sh_css_blob_info[i].header.info.isp;\n\t*binary_found = blob;\n\tinfo->blob_index = i;\n\t \n\tif (!size)\n\t\treturn 0;\n\n\tinfo->xmem_addr = sh_css_load_blob(blob, size);\n\tif (!info->xmem_addr)\n\t\treturn -ENOMEM;\n\treturn 0;\n}\n\n \nint\nia_css_binary_init_infos(void) {\n\tunsigned int i;\n\tunsigned int num_of_isp_binaries = sh_css_num_binaries - NUM_OF_SPS - NUM_OF_BLS;\n\n\tif (num_of_isp_binaries == 0)\n\t\treturn 0;\n\n\tall_binaries = kvmalloc(num_of_isp_binaries * sizeof(*all_binaries),\n\t\t\t\tGFP_KERNEL);\n\tif (!all_binaries)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < num_of_isp_binaries; i++)\n\t{\n\t\tint ret;\n\t\tstruct ia_css_binary_xinfo *binary = &all_binaries[i];\n\t\tbool binary_found;\n\n\t\tret = binary_init_info(binary, i, &binary_found);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tif (!binary_found)\n\t\t\tcontinue;\n\t\t \n\t\tbinary->next = binary_infos[binary->sp.pipeline.mode];\n\t\tbinary_infos[binary->sp.pipeline.mode] = binary;\n\t\tbinary->blob = &sh_css_blob_info[i];\n\t\tbinary->mem_offsets = sh_css_blob_info[i].mem_offsets;\n\t}\n\treturn 0;\n}\n\nint\nia_css_binary_uninit(void) {\n\tunsigned int i;\n\tstruct ia_css_binary_xinfo *b;\n\n\tfor (i = 0; i < IA_CSS_BINARY_NUM_MODES; i++)\n\t{\n\t\tfor (b = binary_infos[i]; b; b = b->next) {\n\t\t\tif (b->xmem_addr)\n\t\t\t\thmm_free(b->xmem_addr);\n\t\t\tb->xmem_addr = mmgr_NULL;\n\t\t}\n\t\tbinary_infos[i] = NULL;\n\t}\n\tkvfree(all_binaries);\n\treturn 0;\n}\n\n \nstatic int\nbinary_grid_deci_factor_log2(int width, int height)\n{\n\t \n\t \n#define MAX_SPEC_DECI_FACT_LOG2\t\t5\n#define MIN_SPEC_DECI_FACT_LOG2\t\t3\n\t \n#define DECI_FACT_LOG2_5_SMALLEST_FRAME_WIDTH_BQ\t1280\n#define DECI_FACT_LOG2_4_SMALLEST_FRAME_WIDTH_BQ\t640\n\n\tint smallest_factor;  \n\tint spec_factor;      \n\n\t \n\tassert(ISP_BQ_GRID_WIDTH(width,\n\t\t\t\t MAX_SPEC_DECI_FACT_LOG2) <= SH_CSS_MAX_BQ_GRID_WIDTH);\n\tassert(ISP_BQ_GRID_HEIGHT(height,\n\t\t\t\t  MAX_SPEC_DECI_FACT_LOG2) <= SH_CSS_MAX_BQ_GRID_HEIGHT);\n\n\t \n\tsmallest_factor = MAX_SPEC_DECI_FACT_LOG2;\n\twhile (ISP_BQ_GRID_WIDTH(width,\n\t\t\t\t smallest_factor - 1) <= SH_CSS_MAX_BQ_GRID_WIDTH &&\n\t       ISP_BQ_GRID_HEIGHT(height, smallest_factor - 1) <= SH_CSS_MAX_BQ_GRID_HEIGHT\n\t       && smallest_factor > MIN_SPEC_DECI_FACT_LOG2)\n\t\tsmallest_factor--;\n\n\t \n\tif (_ISP_BQS(width) >= DECI_FACT_LOG2_5_SMALLEST_FRAME_WIDTH_BQ)\n\t\tspec_factor = 5;\n\telse if (_ISP_BQS(width) >= DECI_FACT_LOG2_4_SMALLEST_FRAME_WIDTH_BQ)\n\t\tspec_factor = 4;\n\telse\n\t\tspec_factor = 3;\n\n\t \n\treturn max(smallest_factor, spec_factor);\n\n#undef MAX_SPEC_DECI_FACT_LOG2\n#undef MIN_SPEC_DECI_FACT_LOG2\n#undef DECI_FACT_LOG2_5_SMALLEST_FRAME_WIDTH_BQ\n#undef DECI_FACT_LOG2_4_SMALLEST_FRAME_WIDTH_BQ\n}\n\nstatic int\nbinary_in_frame_padded_width(int in_frame_width,\n\t\t\t     int isp_internal_width,\n\t\t\t     int dvs_env_width,\n\t\t\t     int stream_config_left_padding,\n\t\t\t     int left_cropping,\n\t\t\t     bool need_scaling)\n{\n\tint rval;\n\tint nr_of_left_paddings;\t \n\n#if defined(ISP2401)\n\t \n\tnr_of_left_paddings = 0;\n#else\n\t \n\tnr_of_left_paddings = 2 * ISP_VEC_NELEMS;\n#endif\n\tif (need_scaling) {\n\t\t \n\t\tif (stream_config_left_padding != -1) {\n\t\t\t \n\t\t\trval =\n\t\t\t    CEIL_MUL(in_frame_width + nr_of_left_paddings,\n\t\t\t\t     2 * ISP_VEC_NELEMS);\n\t\t} else {\n\t\t\t \n\t\t\tin_frame_width += dvs_env_width;\n\t\t\trval =\n\t\t\t    CEIL_MUL(in_frame_width +\n\t\t\t\t     (left_cropping ? nr_of_left_paddings : 0),\n\t\t\t\t     2 * ISP_VEC_NELEMS);\n\t\t}\n\t} else {\n\t\trval = isp_internal_width;\n\t}\n\n\treturn rval;\n}\n\nint\nia_css_binary_fill_info(const struct ia_css_binary_xinfo *xinfo,\n\t\t\tbool online,\n\t\t\tbool two_ppc,\n\t\t\tenum atomisp_input_format stream_format,\n\t\t\tconst struct ia_css_frame_info *in_info,  \n\t\t\tconst struct ia_css_frame_info *bds_out_info,  \n\t\t\tconst struct ia_css_frame_info *out_info[],  \n\t\t\tconst struct ia_css_frame_info *vf_info,  \n\t\t\tstruct ia_css_binary *binary,\n\t\t\tstruct ia_css_resolution *dvs_env,\n\t\t\tint stream_config_left_padding,\n\t\t\tbool accelerator) {\n\tconst struct ia_css_binary_info *info = &xinfo->sp;\n\tunsigned int dvs_env_width = 0,\n\tdvs_env_height = 0,\n\tvf_log_ds = 0,\n\ts3a_log_deci = 0,\n\tbits_per_pixel = 0,\n\t \n\tsc_3a_dis_width = 0,\n\t \n\tsc_3a_dis_padded_width = 0,\n\t \n\tsc_3a_dis_height = 0,\n\tisp_internal_width = 0,\n\tisp_internal_height = 0,\n\ts3a_isp_width = 0;\n\n\tbool need_scaling = false;\n\tstruct ia_css_resolution binary_dvs_env, internal_res;\n\tint err;\n\tunsigned int i;\n\tconst struct ia_css_frame_info *bin_out_info = NULL;\n\n\tassert(info);\n\tassert(binary);\n\n\tbinary->info = xinfo;\n\tif (!accelerator)\n\t{\n\t\t \n\t\terr = ia_css_isp_param_allocate_isp_parameters(\n\t\t    &binary->mem_params, &binary->css_params,\n\t\t    &info->mem_initializers);\n\t\tif (err) {\n\t\t\treturn err;\n\t\t}\n\t}\n\tfor (i = 0; i < IA_CSS_BINARY_MAX_OUTPUT_PORTS; i++)\n\t{\n\t\tif (out_info[i] && (out_info[i]->res.width != 0)) {\n\t\t\tbin_out_info = out_info[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (in_info && bin_out_info)\n\t{\n\t\tneed_scaling = (in_info->res.width != bin_out_info->res.width) ||\n\t\t\t       (in_info->res.height != bin_out_info->res.height);\n\t}\n\n\t \n\tbinary_dvs_env.width = 0;\n\tbinary_dvs_env.height = 0;\n\tia_css_binary_dvs_env(info, dvs_env, &binary_dvs_env);\n\tdvs_env_width = binary_dvs_env.width;\n\tdvs_env_height = binary_dvs_env.height;\n\tbinary->dvs_envelope.width  = dvs_env_width;\n\tbinary->dvs_envelope.height = dvs_env_height;\n\n\t \n\tinternal_res.width = 0;\n\tinternal_res.height = 0;\n\tia_css_binary_internal_res(in_info, bds_out_info, bin_out_info, dvs_env,\n\t\t\t\t   info, &internal_res);\n\tisp_internal_width = internal_res.width;\n\tisp_internal_height = internal_res.height;\n\n\t \n\tif (bin_out_info)  \n\t\tbinary->internal_frame_info.format = bin_out_info->format;\n\t \n\tbinary->internal_frame_info.res.width       = isp_internal_width;\n\tbinary->internal_frame_info.padded_width    = CEIL_MUL(isp_internal_width, 2 * ISP_VEC_NELEMS);\n\tbinary->internal_frame_info.res.height      = isp_internal_height;\n\tbinary->internal_frame_info.raw_bit_depth   = bits_per_pixel;\n\n\tif (in_info)\n\t{\n\t\tbinary->effective_in_frame_res.width = in_info->res.width;\n\t\tbinary->effective_in_frame_res.height = in_info->res.height;\n\n\t\tbits_per_pixel = in_info->raw_bit_depth;\n\n\t\t \n\t\tbinary->in_frame_info.res.width = in_info->res.width +\n\t\t\t\t\t\t  info->pipeline.left_cropping;\n\t\tbinary->in_frame_info.res.height = in_info->res.height +\n\t\t\t\t\t\t   info->pipeline.top_cropping;\n\n\t\tbinary->in_frame_info.res.width += dvs_env_width;\n\t\tbinary->in_frame_info.res.height += dvs_env_height;\n\n\t\tbinary->in_frame_info.padded_width =\n\t\t    binary_in_frame_padded_width(in_info->res.width,\n\t\t\t\t\t\t isp_internal_width,\n\t\t\t\t\t\t dvs_env_width,\n\t\t\t\t\t\t stream_config_left_padding,\n\t\t\t\t\t\t info->pipeline.left_cropping,\n\t\t\t\t\t\t need_scaling);\n\n\t\tbinary->in_frame_info.format = in_info->format;\n\t\tbinary->in_frame_info.raw_bayer_order = in_info->raw_bayer_order;\n\t\tbinary->in_frame_info.crop_info = in_info->crop_info;\n\t}\n\n\tif (online)\n\t{\n\t\tbits_per_pixel = ia_css_util_input_format_bpp(\n\t\t\t\t     stream_format, two_ppc);\n\t}\n\tbinary->in_frame_info.raw_bit_depth = bits_per_pixel;\n\n\tfor (i = 0; i < IA_CSS_BINARY_MAX_OUTPUT_PORTS; i++)\n\t{\n\t\tif (out_info[i]) {\n\t\t\tbinary->out_frame_info[i].res.width     = out_info[i]->res.width;\n\t\t\tbinary->out_frame_info[i].res.height    = out_info[i]->res.height;\n\t\t\tbinary->out_frame_info[i].padded_width  = out_info[i]->padded_width;\n\t\t\tif (info->pipeline.mode == IA_CSS_BINARY_MODE_COPY) {\n\t\t\t\tbinary->out_frame_info[i].raw_bit_depth = bits_per_pixel;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tbinary->out_frame_info[i].raw_bit_depth = 16;\n\t\t\t}\n\t\t\tbinary->out_frame_info[i].format        = out_info[i]->format;\n\t\t}\n\t}\n\n\tif (vf_info && (vf_info->res.width != 0))\n\t{\n\t\terr = ia_css_vf_configure(binary, bin_out_info,\n\t\t\t\t\t  (struct ia_css_frame_info *)vf_info, &vf_log_ds);\n\t\tif (err) {\n\t\t\tif (!accelerator) {\n\t\t\t\tia_css_isp_param_destroy_isp_parameters(\n\t\t\t\t    &binary->mem_params,\n\t\t\t\t    &binary->css_params);\n\t\t\t}\n\t\t\treturn err;\n\t\t}\n\t}\n\tbinary->vf_downscale_log2 = vf_log_ds;\n\n\tbinary->online            = online;\n\tbinary->input_format      = stream_format;\n\n\t \n\tif ((vf_info) && (vf_info->res.width != 0))\n\t{\n\t\tunsigned int vf_out_vecs, vf_out_width, vf_out_height;\n\n\t\tbinary->vf_frame_info.format = vf_info->format;\n\t\tif (!bin_out_info)\n\t\t\treturn -EINVAL;\n\t\tvf_out_vecs = __ISP_VF_OUTPUT_WIDTH_VECS(bin_out_info->padded_width,\n\t\t\t      vf_log_ds);\n\t\tvf_out_width = _ISP_VF_OUTPUT_WIDTH(vf_out_vecs);\n\t\tvf_out_height = _ISP_VF_OUTPUT_HEIGHT(bin_out_info->res.height,\n\t\t\t\t\t\t      vf_log_ds);\n\n\t\t \n\t\tif (info->pipeline.mode == IA_CSS_BINARY_MODE_PREVIEW) {\n\t\t\tbinary->out_frame_info[0].res.width =\n\t\t\t    (bin_out_info->res.width >> vf_log_ds);\n\t\t\tbinary->out_frame_info[0].padded_width = vf_out_width;\n\t\t\tbinary->out_frame_info[0].res.height   = vf_out_height;\n\n\t\t\tbinary->vf_frame_info.res.width    = 0;\n\t\t\tbinary->vf_frame_info.padded_width = 0;\n\t\t\tbinary->vf_frame_info.res.height   = 0;\n\t\t} else {\n\t\t\t \n\t\t\tbinary->vf_frame_info.res.width =\n\t\t\t    (bin_out_info->res.width >> vf_log_ds);\n\t\t\tbinary->vf_frame_info.padded_width = vf_out_width;\n\t\t\tbinary->vf_frame_info.res.height   = vf_out_height;\n\t\t}\n\t} else\n\t{\n\t\tbinary->vf_frame_info.res.width    = 0;\n\t\tbinary->vf_frame_info.padded_width = 0;\n\t\tbinary->vf_frame_info.res.height   = 0;\n\t}\n\n\tif (info->enable.ca_gdc)\n\t{\n\t\tbinary->morph_tbl_width =\n\t\t    _ISP_MORPH_TABLE_WIDTH(isp_internal_width);\n\t\tbinary->morph_tbl_aligned_width  =\n\t\t    _ISP_MORPH_TABLE_ALIGNED_WIDTH(isp_internal_width);\n\t\tbinary->morph_tbl_height =\n\t\t    _ISP_MORPH_TABLE_HEIGHT(isp_internal_height);\n\t} else\n\t{\n\t\tbinary->morph_tbl_width  = 0;\n\t\tbinary->morph_tbl_aligned_width  = 0;\n\t\tbinary->morph_tbl_height = 0;\n\t}\n\n\tsc_3a_dis_width = binary->in_frame_info.res.width;\n\tsc_3a_dis_padded_width = binary->in_frame_info.padded_width;\n\tsc_3a_dis_height = binary->in_frame_info.res.height;\n\tif (bds_out_info && in_info &&\n\t    bds_out_info->res.width != in_info->res.width)\n\t{\n\t\t \n\t\tsc_3a_dis_width = bds_out_info->res.width + info->pipeline.left_cropping;\n\t\tsc_3a_dis_padded_width = isp_internal_width;\n\t\tsc_3a_dis_height = isp_internal_height;\n\t}\n\n\ts3a_isp_width = _ISP_S3A_ELEMS_ISP_WIDTH(sc_3a_dis_padded_width,\n\t\t\tinfo->pipeline.left_cropping);\n\tif (info->s3a.fixed_s3a_deci_log)\n\t{\n\t\ts3a_log_deci = info->s3a.fixed_s3a_deci_log;\n\t} else\n\t{\n\t\ts3a_log_deci = binary_grid_deci_factor_log2(s3a_isp_width,\n\t\t\t       sc_3a_dis_height);\n\t}\n\tbinary->deci_factor_log2  = s3a_log_deci;\n\n\tif (info->enable.s3a)\n\t{\n\t\tbinary->s3atbl_width  =\n\t\t    _ISP_S3ATBL_WIDTH(sc_3a_dis_width,\n\t\t\t\t      s3a_log_deci);\n\t\tbinary->s3atbl_height =\n\t\t    _ISP_S3ATBL_HEIGHT(sc_3a_dis_height,\n\t\t\t\t       s3a_log_deci);\n\t\tbinary->s3atbl_isp_width =\n\t\t    _ISP_S3ATBL_ISP_WIDTH(s3a_isp_width,\n\t\t\t\t\t  s3a_log_deci);\n\t\tbinary->s3atbl_isp_height =\n\t\t    _ISP_S3ATBL_ISP_HEIGHT(sc_3a_dis_height,\n\t\t\t\t\t   s3a_log_deci);\n\t} else\n\t{\n\t\tbinary->s3atbl_width  = 0;\n\t\tbinary->s3atbl_height = 0;\n\t\tbinary->s3atbl_isp_width  = 0;\n\t\tbinary->s3atbl_isp_height = 0;\n\t}\n\n\tif (info->enable.sc)\n\t{\n\t\tbinary->sctbl_width_per_color = _ISP_SCTBL_WIDTH_PER_COLOR(sc_3a_dis_padded_width, s3a_log_deci);\n\t\tbinary->sctbl_aligned_width_per_color = SH_CSS_MAX_SCTBL_ALIGNED_WIDTH_PER_COLOR;\n\t\tbinary->sctbl_height = _ISP_SCTBL_HEIGHT(sc_3a_dis_height, s3a_log_deci);\n\t} else\n\t{\n\t\tbinary->sctbl_width_per_color         = 0;\n\t\tbinary->sctbl_aligned_width_per_color = 0;\n\t\tbinary->sctbl_height                  = 0;\n\t}\n\tia_css_sdis_init_info(&binary->dis,\n\t\t\t      sc_3a_dis_width,\n\t\t\t      sc_3a_dis_padded_width,\n\t\t\t      sc_3a_dis_height,\n\t\t\t      info->pipeline.isp_pipe_version,\n\t\t\t      info->enable.dis);\n\tif (info->pipeline.left_cropping)\n\t\tbinary->left_padding = 2 * ISP_VEC_NELEMS - info->pipeline.left_cropping;\n\telse\n\t\tbinary->left_padding = 0;\n\n\treturn 0;\n}\n\nstatic int __ia_css_binary_find(struct ia_css_binary_descr *descr,\n\t\t\t\tstruct ia_css_binary *binary) {\n\tint mode;\n\tbool online;\n\tbool two_ppc;\n\tenum atomisp_input_format stream_format;\n\tconst struct ia_css_frame_info *req_in_info,\n\t\t*req_bds_out_info,\n\t\t*req_out_info[IA_CSS_BINARY_MAX_OUTPUT_PORTS],\n\t\t*req_bin_out_info = NULL,\n\t\t*req_vf_info;\n\n\tstruct ia_css_binary_xinfo *xcandidate;\n\tbool need_ds, need_dz, need_dvs, need_xnr, need_dpc;\n\tbool striped;\n\tbool enable_yuv_ds;\n\tbool enable_high_speed;\n\tbool enable_dvs_6axis;\n\tbool enable_reduced_pipe;\n\tbool enable_capture_pp_bli;\n\tint err = -EINVAL;\n\tbool continuous;\n\tunsigned int isp_pipe_version;\n\tstruct ia_css_resolution dvs_env, internal_res;\n\tunsigned int i;\n\n\tassert(descr);\n\t \n\tassert(binary);\n\n\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t    \"ia_css_binary_find() enter: descr=%p, (mode=%d), binary=%p\\n\",\n\t\t\t    descr, descr->mode,\n\t\t\t    binary);\n\n\tmode = descr->mode;\n\tonline = descr->online;\n\ttwo_ppc = descr->two_ppc;\n\tstream_format = descr->stream_format;\n\treq_in_info = descr->in_info;\n\treq_bds_out_info = descr->bds_out_info;\n\tfor (i = 0; i < IA_CSS_BINARY_MAX_OUTPUT_PORTS; i++) {\n\t\treq_out_info[i] = descr->out_info[i];\n\t\tif (req_out_info[i] && (req_out_info[i]->res.width != 0))\n\t\t\treq_bin_out_info = req_out_info[i];\n\t}\n\tif (!req_bin_out_info)\n\t\treturn -EINVAL;\n\treq_vf_info = descr->vf_info;\n\n\tneed_xnr = descr->enable_xnr;\n\tneed_ds = descr->enable_fractional_ds;\n\tneed_dz = false;\n\tneed_dvs = false;\n\tneed_dpc = descr->enable_dpc;\n\n\tenable_yuv_ds = descr->enable_yuv_ds;\n\tenable_high_speed = descr->enable_high_speed;\n\tenable_dvs_6axis  = descr->enable_dvs_6axis;\n\tenable_reduced_pipe = descr->enable_reduced_pipe;\n\tenable_capture_pp_bli = descr->enable_capture_pp_bli;\n\tcontinuous = descr->continuous;\n\tstriped = descr->striped;\n\tisp_pipe_version = descr->isp_pipe_version;\n\n\tdvs_env.width = 0;\n\tdvs_env.height = 0;\n\tinternal_res.width = 0;\n\tinternal_res.height = 0;\n\n\tif (mode == IA_CSS_BINARY_MODE_VIDEO) {\n\t\tdvs_env = descr->dvs_env;\n\t\tneed_dz = descr->enable_dz;\n\t\t \n\t\tneed_dvs = dvs_env.width || dvs_env.height;\n\t}\n\n\t \n\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\t\"BINARY INFO:\\n\");\n\tfor (i = 0; i < IA_CSS_BINARY_NUM_MODES; i++) {\n\t\txcandidate = binary_infos[i];\n\t\tif (xcandidate) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\t\"%d:\\n\", i);\n\t\t\twhile (xcandidate) {\n\t\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE, \" Name:%s Type:%d Cont:%d\\n\",\n\t\t\t\t\t\t    xcandidate->blob->name, xcandidate->type,\n\t\t\t\t\t\t    xcandidate->sp.enable.continuous);\n\t\t\t\txcandidate = xcandidate->next;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tfor (xcandidate = binary_infos[mode]; xcandidate;\n\t     xcandidate = xcandidate->next) {\n\t\tstruct ia_css_binary_info *candidate = &xcandidate->sp;\n\t\t \n\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t    \"ia_css_binary_find() candidate = %p, mode = %d ID = %d\\n\",\n\t\t\t\t    candidate, candidate->pipeline.mode, candidate->id);\n\n\t\t \n\t\tif (!candidate->enable.continuous &&\n\t\t    continuous && (mode != IA_CSS_BINARY_MODE_COPY)) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: !%d && %d && (%d != %d)\\n\",\n\t\t\t\t\t    __LINE__, candidate->enable.continuous,\n\t\t\t\t\t    continuous, mode,\n\t\t\t\t\t    IA_CSS_BINARY_MODE_COPY);\n\t\t\tcontinue;\n\t\t}\n\t\tif (striped && candidate->iterator.num_stripes == 1) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: binary is not striped\\n\",\n\t\t\t\t\t    __LINE__);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (candidate->pipeline.isp_pipe_version != isp_pipe_version &&\n\t\t    (mode != IA_CSS_BINARY_MODE_COPY) &&\n\t\t    (mode != IA_CSS_BINARY_MODE_CAPTURE_PP) &&\n\t\t    (mode != IA_CSS_BINARY_MODE_VF_PP)) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%d != %d)\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    candidate->pipeline.isp_pipe_version, isp_pipe_version);\n\t\t\tcontinue;\n\t\t}\n\t\tif (!candidate->enable.reduced_pipe && enable_reduced_pipe) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: !%d && %d\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    candidate->enable.reduced_pipe,\n\t\t\t\t\t    enable_reduced_pipe);\n\t\t\tcontinue;\n\t\t}\n\t\tif (!candidate->enable.dvs_6axis && enable_dvs_6axis) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: !%d && %d\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    candidate->enable.dvs_6axis,\n\t\t\t\t\t    enable_dvs_6axis);\n\t\t\tcontinue;\n\t\t}\n\t\tif (candidate->enable.high_speed && !enable_high_speed) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: %d && !%d\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    candidate->enable.high_speed,\n\t\t\t\t\t    enable_high_speed);\n\t\t\tcontinue;\n\t\t}\n\t\tif (!candidate->enable.xnr && need_xnr) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: %d && !%d\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    candidate->enable.xnr,\n\t\t\t\t\t    need_xnr);\n\t\t\tcontinue;\n\t\t}\n\t\tif (!(candidate->enable.ds & 2) && enable_yuv_ds) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: !%d && %d\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    ((candidate->enable.ds & 2) != 0),\n\t\t\t\t\t    enable_yuv_ds);\n\t\t\tcontinue;\n\t\t}\n\t\tif ((candidate->enable.ds & 2) && !enable_yuv_ds) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: %d && !%d\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    ((candidate->enable.ds & 2) != 0),\n\t\t\t\t\t    enable_yuv_ds);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (mode == IA_CSS_BINARY_MODE_VIDEO &&\n\t\t    candidate->enable.ds && need_ds)\n\t\t\tneed_dz = false;\n\n\t\t \n\t\tif ((req_vf_info) && !(candidate->enable.vf_veceven ||\n\t\t\t\t        \n\t\t\t\t       candidate->vf_dec.is_variable ||\n\t\t\t\t        \n\t\t\t\t       xcandidate->num_output_pins > 1)) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%p != NULL) && !(%d || %d || (%d >%d))\\n\",\n\t\t\t\t\t    __LINE__, req_vf_info,\n\t\t\t\t\t    candidate->enable.vf_veceven,\n\t\t\t\t\t    candidate->vf_dec.is_variable,\n\t\t\t\t\t    xcandidate->num_output_pins, 1);\n\t\t\tcontinue;\n\t\t}\n\t\tif (!candidate->enable.dvs_envelope && need_dvs) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: !%d && %d\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    candidate->enable.dvs_envelope, (int)need_dvs);\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tia_css_binary_internal_res(req_in_info, req_bds_out_info,\n\t\t\t\t\t   req_bin_out_info, &dvs_env, candidate, &internal_res);\n\t\tif (internal_res.width > candidate->internal.max_width) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%d > %d)\\n\",\n\t\t\t\t\t    __LINE__, internal_res.width,\n\t\t\t\t\t    candidate->internal.max_width);\n\t\t\tcontinue;\n\t\t}\n\t\tif (internal_res.height > candidate->internal.max_height) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%d > %d)\\n\",\n\t\t\t\t\t    __LINE__, internal_res.height,\n\t\t\t\t\t    candidate->internal.max_height);\n\t\t\tcontinue;\n\t\t}\n\t\tif (!candidate->enable.ds && need_ds && !(xcandidate->num_output_pins > 1)) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: !%d && %d\\n\",\n\t\t\t\t\t    __LINE__, candidate->enable.ds, (int)need_ds);\n\t\t\tcontinue;\n\t\t}\n\t\tif (!candidate->enable.uds && !candidate->enable.dvs_6axis && need_dz) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: !%d && !%d && %d\\n\",\n\t\t\t\t\t    __LINE__, candidate->enable.uds,\n\t\t\t\t\t    candidate->enable.dvs_6axis, (int)need_dz);\n\t\t\tcontinue;\n\t\t}\n\t\tif (online && candidate->input.source == IA_CSS_BINARY_INPUT_MEMORY) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: %d && (%d == %d)\\n\",\n\t\t\t\t\t    __LINE__, online, candidate->input.source,\n\t\t\t\t\t    IA_CSS_BINARY_INPUT_MEMORY);\n\t\t\tcontinue;\n\t\t}\n\t\tif (!online && candidate->input.source == IA_CSS_BINARY_INPUT_SENSOR) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: !%d && (%d == %d)\\n\",\n\t\t\t\t\t    __LINE__, online, candidate->input.source,\n\t\t\t\t\t    IA_CSS_BINARY_INPUT_SENSOR);\n\t\t\tcontinue;\n\t\t}\n\t\tif (req_bin_out_info->res.width < candidate->output.min_width ||\n\t\t    req_bin_out_info->res.width > candidate->output.max_width) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%d > %d) || (%d < %d)\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    req_bin_out_info->padded_width,\n\t\t\t\t\t    candidate->output.min_width,\n\t\t\t\t\t    req_bin_out_info->padded_width,\n\t\t\t\t\t    candidate->output.max_width);\n\t\t\tcontinue;\n\t\t}\n\t\tif (xcandidate->num_output_pins > 1 &&\n\t\t     \n\t\t    req_vf_info) {  \n\t\t\tif (req_vf_info->res.width > candidate->output.max_width) {\n\t\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%d < %d)\\n\",\n\t\t\t\t\t\t    __LINE__,\n\t\t\t\t\t\t    req_vf_info->res.width,\n\t\t\t\t\t\t    candidate->output.max_width);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\t\tif (req_in_info->padded_width > candidate->input.max_width) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%d > %d)\\n\",\n\t\t\t\t\t    __LINE__, req_in_info->padded_width,\n\t\t\t\t\t    candidate->input.max_width);\n\t\t\tcontinue;\n\t\t}\n\t\tif (!binary_supports_output_format(xcandidate, req_bin_out_info->format)) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: !%d\\n\",\n\t\t\t\t\t    __LINE__,\n\t\t\t\t\t    binary_supports_output_format(xcandidate, req_bin_out_info->format));\n\t\t\tcontinue;\n\t\t}\n\t\tif (xcandidate->num_output_pins > 1 &&\n\t\t     \n\t\t    req_vf_info                   &&  \n\t\t     \n\t\t    !binary_supports_output_format(xcandidate, req_vf_info->format)) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%d > %d) && (%p != NULL) && !%d\\n\",\n\t\t\t\t\t    __LINE__, xcandidate->num_output_pins, 1,\n\t\t\t\t\t    req_vf_info,\n\t\t\t\t\t    binary_supports_output_format(xcandidate, req_vf_info->format));\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif (xcandidate->num_output_pins == 1 &&\n\t\t    req_vf_info && candidate->enable.vf_veceven &&\n\t\t    !binary_supports_vf_format(xcandidate, req_vf_info->format)) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%d == %d) && (%p != NULL) && %d && !%d\\n\",\n\t\t\t\t\t    __LINE__, xcandidate->num_output_pins, 1,\n\t\t\t\t\t    req_vf_info, candidate->enable.vf_veceven,\n\t\t\t\t\t    binary_supports_vf_format(xcandidate, req_vf_info->format));\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif (xcandidate->num_output_pins == 1 &&\n\t\t    req_vf_info && candidate->enable.vf_veceven) {  \n\t\t\tif (req_vf_info->res.width > candidate->output.max_width) {\n\t\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: (%d < %d)\\n\",\n\t\t\t\t\t\t    __LINE__,\n\t\t\t\t\t\t    req_vf_info->res.width,\n\t\t\t\t\t\t    candidate->output.max_width);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\tif (!supports_bds_factor(candidate->bds.supported_bds_factors,\n\t\t\t\t\t descr->required_bds_factor)) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: 0x%x & 0x%x)\\n\",\n\t\t\t\t\t    __LINE__, candidate->bds.supported_bds_factors,\n\t\t\t\t\t    descr->required_bds_factor);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (!candidate->enable.dpc && need_dpc) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: 0x%x & 0x%x)\\n\",\n\t\t\t\t\t    __LINE__, candidate->enable.dpc,\n\t\t\t\t\t    descr->enable_dpc);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (candidate->uds.use_bci && enable_capture_pp_bli) {\n\t\t\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t\t\t    \"ia_css_binary_find() [%d] continue: 0x%x & 0x%x)\\n\",\n\t\t\t\t\t    __LINE__, candidate->uds.use_bci,\n\t\t\t\t\t    descr->enable_capture_pp_bli);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\terr = ia_css_binary_fill_info(xcandidate, online, two_ppc,\n\t\t\t\t\t      stream_format, req_in_info,\n\t\t\t\t\t      req_bds_out_info,\n\t\t\t\t\t      req_out_info, req_vf_info,\n\t\t\t\t\t      binary, &dvs_env,\n\t\t\t\t\t      descr->stream_config_left_padding,\n\t\t\t\t\t      false);\n\n\t\tif (err)\n\t\t\tbreak;\n\t\tbinary_init_metrics(&binary->metrics, &binary->info->sp);\n\t\tbreak;\n\t}\n\n\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t    \"ia_css_binary_find() selected = %p, mode = %d ID = %d\\n\",\n\t\t\t    xcandidate, xcandidate ? xcandidate->sp.pipeline.mode : 0, xcandidate ? xcandidate->sp.id : 0);\n\n\tia_css_debug_dtrace(IA_CSS_DEBUG_TRACE,\n\t\t\t    \"ia_css_binary_find() leave: return_err=%d\\n\", err);\n\n\tif (!err && xcandidate)\n\t\tdev_dbg(atomisp_dev,\n\t\t\t\"Using binary %s (id %d), type %d, mode %d, continuous %s\\n\",\n\t\t\txcandidate->blob->name,\n\t\t\txcandidate->sp.id,\n\t\t\txcandidate->type,\n\t\t\txcandidate->sp.pipeline.mode,\n\t\t\txcandidate->sp.enable.continuous ? \"true\" : \"false\");\n\n\n\treturn err;\n}\n\nint ia_css_binary_find(struct ia_css_binary_descr *descr,\n\t\t       struct ia_css_binary *binary)\n{\n\tint ret = __ia_css_binary_find(descr, binary);\n\n\tif (unlikely(ret)) {\n\t\tdev_dbg(atomisp_dev, \"Seeking for binary failed at:\");\n\t\tdump_stack();\n\t}\n\n\treturn ret;\n}\n\nunsigned\nia_css_binary_max_vf_width(void)\n{\n\t \n\t \n\tif (binary_infos[IA_CSS_BINARY_MODE_VF_PP])\n\t\treturn binary_infos[IA_CSS_BINARY_MODE_VF_PP]->sp.output.max_width;\n\treturn 0;\n}\n\nvoid\nia_css_binary_destroy_isp_parameters(struct ia_css_binary *binary)\n{\n\tif (binary) {\n\t\tia_css_isp_param_destroy_isp_parameters(&binary->mem_params,\n\t\t\t\t\t\t\t&binary->css_params);\n\t}\n}\n\nvoid\nia_css_binary_get_isp_binaries(struct ia_css_binary_xinfo **binaries,\n\t\t\t       uint32_t *num_isp_binaries)\n{\n\tassert(binaries);\n\n\tif (num_isp_binaries)\n\t\t*num_isp_binaries = 0;\n\n\t*binaries = all_binaries;\n\tif (all_binaries && num_isp_binaries) {\n\t\t \n\t\tif (sh_css_num_binaries > 0)\n\t\t\t*num_isp_binaries = sh_css_num_binaries - 1;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}