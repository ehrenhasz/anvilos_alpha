{
  "module_name": "atomisp_drvfs.c",
  "hash_id": "bab3694360a77980c5d65bb1ed73a1da72a642dfad9427bb0510f4dd59431a4b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/atomisp_drvfs.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/kernel.h>\n\n#include \"atomisp_compat.h\"\n#include \"atomisp_internal.h\"\n#include \"atomisp_ioctl.h\"\n#include \"atomisp_drvfs.h\"\n#include \"hmm/hmm.h\"\n#include \"ia_css_debug.h\"\n\n \nstruct _iunit_debug {\n\tstruct device_driver\t*drv;\n\tstruct atomisp_device\t*isp;\n\tunsigned int\t\tdbglvl;\n\tunsigned int\t\tdbgfun;\n\tunsigned int\t\tdbgopt;\n};\n\n#define OPTION_BIN_LIST\t\t\tBIT(0)\n#define OPTION_BIN_RUN\t\t\tBIT(1)\n#define OPTION_VALID\t\t\t(OPTION_BIN_LIST \\\n\t\t\t\t\t| OPTION_BIN_RUN)\n\nstatic struct _iunit_debug iunit_debug = {\n\t.dbglvl = 0,\n\t.dbgopt = OPTION_BIN_LIST,\n};\n\nstatic inline int iunit_dump_dbgopt(struct atomisp_device *isp,\n\t\t\t\t    unsigned int opt)\n{\n\tint ret = 0;\n\n\tif (opt & OPTION_VALID) {\n\t\tif (opt & OPTION_BIN_LIST) {\n\t\t\tret = atomisp_css_dump_blob_infor(isp);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(isp->dev, \"%s dump blob infor err[ret:%d]\\n\",\n\t\t\t\t\t__func__, ret);\n\t\t\t\tgoto opt_err;\n\t\t\t}\n\t\t}\n\n\t\tif (opt & OPTION_BIN_RUN) {\n\t\t\tif (isp->asd.streaming) {\n\t\t\t\tatomisp_css_dump_sp_raw_copy_linecount(true);\n\t\t\t\tatomisp_css_debug_dump_isp_binary();\n\t\t\t} else {\n\t\t\t\tret = -EPERM;\n\t\t\t\tdev_err(isp->dev, \"%s dump running bin err[ret:%d]\\n\",\n\t\t\t\t\t__func__, ret);\n\t\t\t\tgoto opt_err;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tret = -EINVAL;\n\t\tdev_err(isp->dev, \"%s dump nothing[ret=%d]\\n\", __func__, ret);\n\t}\n\nopt_err:\n\treturn ret;\n}\n\nstatic ssize_t iunit_dbglvl_show(struct device_driver *drv, char *buf)\n{\n\tiunit_debug.dbglvl = dbg_level;\n\treturn sysfs_emit(buf, \"dtrace level:%u\\n\", iunit_debug.dbglvl);\n}\n\nstatic ssize_t iunit_dbglvl_store(struct device_driver *drv, const char *buf,\n\t\t\t\t  size_t size)\n{\n\tif (kstrtouint(buf, 10, &iunit_debug.dbglvl)\n\t    || iunit_debug.dbglvl < 1\n\t    || iunit_debug.dbglvl > 9) {\n\t\treturn -ERANGE;\n\t}\n\tia_css_debug_set_dtrace_level(iunit_debug.dbglvl);\n\n\treturn size;\n}\n\nstatic ssize_t iunit_dbgfun_show(struct device_driver *drv, char *buf)\n{\n\tiunit_debug.dbgfun = atomisp_get_css_dbgfunc();\n\treturn sysfs_emit(buf, \"dbgfun opt:%u\\n\", iunit_debug.dbgfun);\n}\n\nstatic ssize_t iunit_dbgfun_store(struct device_driver *drv, const char *buf,\n\t\t\t\t  size_t size)\n{\n\tunsigned int opt;\n\tint ret;\n\n\tret = kstrtouint(buf, 10, &opt);\n\tif (ret)\n\t\treturn ret;\n\n\tret = atomisp_set_css_dbgfunc(iunit_debug.isp, opt);\n\tif (ret)\n\t\treturn ret;\n\n\tiunit_debug.dbgfun = opt;\n\n\treturn size;\n}\n\nstatic ssize_t iunit_dbgopt_show(struct device_driver *drv, char *buf)\n{\n\treturn sysfs_emit(buf, \"option:0x%x\\n\", iunit_debug.dbgopt);\n}\n\nstatic ssize_t iunit_dbgopt_store(struct device_driver *drv, const char *buf,\n\t\t\t\t  size_t size)\n{\n\tunsigned int opt;\n\tint ret;\n\n\tret = kstrtouint(buf, 10, &opt);\n\tif (ret)\n\t\treturn ret;\n\n\tiunit_debug.dbgopt = opt;\n\tret = iunit_dump_dbgopt(iunit_debug.isp, iunit_debug.dbgopt);\n\tif (ret)\n\t\treturn ret;\n\n\treturn size;\n}\n\nstatic const struct driver_attribute iunit_drvfs_attrs[] = {\n\t__ATTR(dbglvl, 0644, iunit_dbglvl_show, iunit_dbglvl_store),\n\t__ATTR(dbgfun, 0644, iunit_dbgfun_show, iunit_dbgfun_store),\n\t__ATTR(dbgopt, 0644, iunit_dbgopt_show, iunit_dbgopt_store),\n};\n\nstatic int iunit_drvfs_create_files(struct device_driver *drv)\n{\n\tint i, ret = 0;\n\n\tfor (i = 0; i < ARRAY_SIZE(iunit_drvfs_attrs); i++)\n\t\tret |= driver_create_file(drv, &iunit_drvfs_attrs[i]);\n\n\treturn ret;\n}\n\nstatic void iunit_drvfs_remove_files(struct device_driver *drv)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(iunit_drvfs_attrs); i++)\n\t\tdriver_remove_file(drv, &iunit_drvfs_attrs[i]);\n}\n\nint atomisp_drvfs_init(struct atomisp_device *isp)\n{\n\tstruct device_driver *drv = isp->dev->driver;\n\tint ret;\n\n\tiunit_debug.isp = isp;\n\tiunit_debug.drv = drv;\n\n\tret = iunit_drvfs_create_files(iunit_debug.drv);\n\tif (ret) {\n\t\tdev_err(isp->dev, \"drvfs_create_files error: %d\\n\", ret);\n\t\tiunit_drvfs_remove_files(iunit_debug.drv);\n\t}\n\n\treturn ret;\n}\n\nvoid atomisp_drvfs_exit(void)\n{\n\tiunit_drvfs_remove_files(iunit_debug.drv);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}