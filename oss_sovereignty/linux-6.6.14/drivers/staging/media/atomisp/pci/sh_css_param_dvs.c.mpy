{
  "module_name": "sh_css_param_dvs.c",
  "hash_id": "a1f63647a7d15f74c0f1b60bf07f1b5886e8dc4c8351c273d53fea133fc51130",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/sh_css_param_dvs.c",
  "human_readable_source": "\n \n\n#include \"sh_css_param_dvs.h\"\n#include <assert_support.h>\n#include <type_support.h>\n#include <ia_css_err.h>\n#include <ia_css_types.h>\n#include \"ia_css_debug.h\"\n\nstatic struct ia_css_dvs_6axis_config *\nalloc_dvs_6axis_table(const struct ia_css_resolution *frame_res,\n\t\t      struct ia_css_dvs_6axis_config  *dvs_config_src)\n{\n\tunsigned int width_y = 0;\n\tunsigned int height_y = 0;\n\tunsigned int width_uv = 0;\n\tunsigned int height_uv = 0;\n\tint err = 0;\n\tstruct ia_css_dvs_6axis_config  *dvs_config = NULL;\n\n\tdvs_config = kvmalloc(sizeof(struct ia_css_dvs_6axis_config),\n\t\t\t      GFP_KERNEL);\n\tif (!dvs_config)\t{\n\t\tIA_CSS_ERROR(\"out of memory\");\n\t\terr = -ENOMEM;\n\t} else {\n\t\t \n\t\tif (dvs_config_src) {\n\t\t\tdvs_config->width_y = width_y = dvs_config_src->width_y;\n\t\t\tdvs_config->height_y = height_y = dvs_config_src->height_y;\n\t\t\tdvs_config->width_uv = width_uv = dvs_config_src->width_uv;\n\t\t\tdvs_config->height_uv = height_uv = dvs_config_src->height_uv;\n\t\t\tIA_CSS_LOG(\"alloc_dvs_6axis_table Y: W %d H %d\", width_y, height_y);\n\t\t} else if (frame_res) {\n\t\t\tdvs_config->width_y = width_y = DVS_TABLE_IN_BLOCKDIM_X_LUMA(frame_res->width);\n\t\t\tdvs_config->height_y = height_y = DVS_TABLE_IN_BLOCKDIM_Y_LUMA(\n\t\t\t\t\t\t\t      frame_res->height);\n\t\t\tdvs_config->width_uv = width_uv = DVS_TABLE_IN_BLOCKDIM_X_CHROMA(\n\t\t\t\t\t\t\t      frame_res->width /\n\t\t\t\t\t\t\t      2);  \n\t\t\tdvs_config->height_uv = height_uv = DVS_TABLE_IN_BLOCKDIM_Y_CHROMA(\n\t\t\t\t\t\t\t\tframe_res->height /\n\t\t\t\t\t\t\t\t2); \n\t\t\tIA_CSS_LOG(\"alloc_dvs_6axis_table Y: W %d H %d\", width_y, height_y);\n\t\t}\n\n\t\t \n\t\tdvs_config->xcoords_y = kvmalloc(width_y * height_y * sizeof(uint32_t),\n\t\t\t\t\t\t GFP_KERNEL);\n\t\tif (!dvs_config->xcoords_y) {\n\t\t\tIA_CSS_ERROR(\"out of memory\");\n\t\t\terr = -ENOMEM;\n\t\t\tgoto exit;\n\t\t}\n\n\t\tdvs_config->ycoords_y = kvmalloc(width_y * height_y * sizeof(uint32_t),\n\t\t\t\t\t\t GFP_KERNEL);\n\t\tif (!dvs_config->ycoords_y) {\n\t\t\tIA_CSS_ERROR(\"out of memory\");\n\t\t\terr = -ENOMEM;\n\t\t\tgoto exit;\n\t\t}\n\n\t\t \n\t\tIA_CSS_LOG(\"UV W %d H %d\", width_uv, height_uv);\n\n\t\tdvs_config->xcoords_uv = kvmalloc(width_uv * height_uv * sizeof(uint32_t),\n\t\t\t\t\t\t  GFP_KERNEL);\n\t\tif (!dvs_config->xcoords_uv) {\n\t\t\tIA_CSS_ERROR(\"out of memory\");\n\t\t\terr = -ENOMEM;\n\t\t\tgoto exit;\n\t\t}\n\n\t\tdvs_config->ycoords_uv = kvmalloc(width_uv * height_uv * sizeof(uint32_t),\n\t\t\t\t\t\t  GFP_KERNEL);\n\t\tif (!dvs_config->ycoords_uv) {\n\t\t\tIA_CSS_ERROR(\"out of memory\");\n\t\t\terr = -ENOMEM;\n\t\t}\nexit:\n\t\tif (err) {\n\t\t\tfree_dvs_6axis_table(\n\t\t\t    &dvs_config);  \n\t\t\tdvs_config = NULL;\n\t\t}\n\t}\n\n\tIA_CSS_LEAVE(\"dvs_config=%p\", dvs_config);\n\treturn dvs_config;\n}\n\nstatic void\ninit_dvs_6axis_table_from_default(struct ia_css_dvs_6axis_config *dvs_config,\n\t\t\t\t  const struct ia_css_resolution *dvs_offset)\n{\n\tunsigned int x, y;\n\tunsigned int width_y = dvs_config->width_y;\n\tunsigned int height_y = dvs_config->height_y;\n\tunsigned int width_uv = dvs_config->width_uv;\n\tunsigned int height_uv = dvs_config->height_uv;\n\n\tIA_CSS_LOG(\"Env_X=%d, Env_Y=%d, width_y=%d, height_y=%d\",\n\t\t   dvs_offset->width, dvs_offset->height, width_y, height_y);\n\tfor (y = 0; y < height_y; y++) {\n\t\tfor (x = 0; x < width_y; x++) {\n\t\t\tdvs_config->xcoords_y[y * width_y + x] =  (dvs_offset->width + x *\n\t\t\t\tDVS_BLOCKDIM_X) << DVS_COORD_FRAC_BITS;\n\t\t}\n\t}\n\n\tfor (y = 0; y < height_y; y++) {\n\t\tfor (x = 0; x < width_y; x++) {\n\t\t\tdvs_config->ycoords_y[y * width_y + x] =  (dvs_offset->height + y *\n\t\t\t\tDVS_BLOCKDIM_Y_LUMA) << DVS_COORD_FRAC_BITS;\n\t\t}\n\t}\n\n\tfor (y = 0; y < height_uv; y++) {\n\t\tfor (x = 0; x < width_uv;\n\t\t     x++) {  \n\t\t\tdvs_config->xcoords_uv[y * width_uv + x] =  ((dvs_offset->width / 2) + x *\n\t\t\t\tDVS_BLOCKDIM_X) << DVS_COORD_FRAC_BITS;\n\t\t}\n\t}\n\n\tfor (y = 0; y < height_uv; y++) {\n\t\tfor (x = 0; x < width_uv;\n\t\t     x++) {  \n\t\t\tdvs_config->ycoords_uv[y * width_uv + x] =  ((dvs_offset->height / 2) + y *\n\t\t\t\tDVS_BLOCKDIM_Y_CHROMA) <<\n\t\t\t\tDVS_COORD_FRAC_BITS;\n\t\t}\n\t}\n}\n\nstatic void\ninit_dvs_6axis_table_from_config(struct ia_css_dvs_6axis_config *dvs_config,\n\t\t\t\t struct ia_css_dvs_6axis_config  *dvs_config_src)\n{\n\tunsigned int width_y = dvs_config->width_y;\n\tunsigned int height_y = dvs_config->height_y;\n\tunsigned int width_uv = dvs_config->width_uv;\n\tunsigned int height_uv = dvs_config->height_uv;\n\n\tmemcpy(dvs_config->xcoords_y, dvs_config_src->xcoords_y,\n\t       (width_y * height_y * sizeof(uint32_t)));\n\tmemcpy(dvs_config->ycoords_y, dvs_config_src->ycoords_y,\n\t       (width_y * height_y * sizeof(uint32_t)));\n\tmemcpy(dvs_config->xcoords_uv, dvs_config_src->xcoords_uv,\n\t       (width_uv * height_uv * sizeof(uint32_t)));\n\tmemcpy(dvs_config->ycoords_uv, dvs_config_src->ycoords_uv,\n\t       (width_uv * height_uv * sizeof(uint32_t)));\n}\n\nstruct ia_css_dvs_6axis_config *\ngenerate_dvs_6axis_table(const struct ia_css_resolution *frame_res,\n\t\t\t const struct ia_css_resolution *dvs_offset)\n{\n\tstruct ia_css_dvs_6axis_config *dvs_6axis_table;\n\n\tassert(frame_res);\n\tassert(dvs_offset);\n\n\tdvs_6axis_table = alloc_dvs_6axis_table(frame_res, NULL);\n\tif (dvs_6axis_table) {\n\t\tinit_dvs_6axis_table_from_default(dvs_6axis_table, dvs_offset);\n\t\treturn dvs_6axis_table;\n\t}\n\treturn NULL;\n}\n\nstruct ia_css_dvs_6axis_config *\ngenerate_dvs_6axis_table_from_config(struct ia_css_dvs_6axis_config\n\t\t\t\t     *dvs_config_src)\n{\n\tstruct ia_css_dvs_6axis_config *dvs_6axis_table;\n\n\tassert(dvs_config_src);\n\n\tdvs_6axis_table = alloc_dvs_6axis_table(NULL, dvs_config_src);\n\tif (dvs_6axis_table) {\n\t\tinit_dvs_6axis_table_from_config(dvs_6axis_table, dvs_config_src);\n\t\treturn dvs_6axis_table;\n\t}\n\treturn NULL;\n}\n\nvoid\nfree_dvs_6axis_table(struct ia_css_dvs_6axis_config  **dvs_6axis_config)\n{\n\tif ((dvs_6axis_config) && (*dvs_6axis_config)) {\n\t\tIA_CSS_ENTER_PRIVATE(\"dvs_6axis_config %p\", (*dvs_6axis_config));\n\t\tif ((*dvs_6axis_config)->xcoords_y) {\n\t\t\tkvfree((*dvs_6axis_config)->xcoords_y);\n\t\t\t(*dvs_6axis_config)->xcoords_y = NULL;\n\t\t}\n\n\t\tif ((*dvs_6axis_config)->ycoords_y) {\n\t\t\tkvfree((*dvs_6axis_config)->ycoords_y);\n\t\t\t(*dvs_6axis_config)->ycoords_y = NULL;\n\t\t}\n\n\t\t \n\t\tif ((*dvs_6axis_config)->xcoords_uv) {\n\t\t\tkvfree((*dvs_6axis_config)->xcoords_uv);\n\t\t\t(*dvs_6axis_config)->xcoords_uv = NULL;\n\t\t}\n\n\t\tif ((*dvs_6axis_config)->ycoords_uv) {\n\t\t\tkvfree((*dvs_6axis_config)->ycoords_uv);\n\t\t\t(*dvs_6axis_config)->ycoords_uv = NULL;\n\t\t}\n\n\t\tIA_CSS_LEAVE_PRIVATE(\"dvs_6axis_config %p\", (*dvs_6axis_config));\n\t\tkvfree(*dvs_6axis_config);\n\t\t*dvs_6axis_config = NULL;\n\t}\n}\n\nvoid copy_dvs_6axis_table(struct ia_css_dvs_6axis_config *dvs_config_dst,\n\t\t\t  const struct ia_css_dvs_6axis_config *dvs_config_src)\n{\n\tunsigned int width_y;\n\tunsigned int height_y;\n\tunsigned int width_uv;\n\tunsigned int height_uv;\n\n\tassert(dvs_config_src);\n\tassert(dvs_config_dst);\n\tassert(dvs_config_src->xcoords_y);\n\tassert(dvs_config_src->xcoords_uv);\n\tassert(dvs_config_src->ycoords_y);\n\tassert(dvs_config_src->ycoords_uv);\n\tassert(dvs_config_src->width_y == dvs_config_dst->width_y);\n\tassert(dvs_config_src->width_uv == dvs_config_dst->width_uv);\n\tassert(dvs_config_src->height_y == dvs_config_dst->height_y);\n\tassert(dvs_config_src->height_uv == dvs_config_dst->height_uv);\n\n\twidth_y = dvs_config_src->width_y;\n\theight_y = dvs_config_src->height_y;\n\twidth_uv =\n\t    dvs_config_src->width_uv;  \n\theight_uv = dvs_config_src->height_uv;\n\n\tmemcpy(dvs_config_dst->xcoords_y, dvs_config_src->xcoords_y,\n\t       (width_y * height_y * sizeof(uint32_t)));\n\tmemcpy(dvs_config_dst->ycoords_y, dvs_config_src->ycoords_y,\n\t       (width_y * height_y * sizeof(uint32_t)));\n\n\tmemcpy(dvs_config_dst->xcoords_uv, dvs_config_src->xcoords_uv,\n\t       (width_uv * height_uv * sizeof(uint32_t)));\n\tmemcpy(dvs_config_dst->ycoords_uv, dvs_config_src->ycoords_uv,\n\t       (width_uv * height_uv * sizeof(uint32_t)));\n}\n\nvoid\nia_css_dvs_statistics_get(enum dvs_statistics_type type,\n\t\t\t  union ia_css_dvs_statistics_host  *host_stats,\n\t\t\t  const union ia_css_dvs_statistics_isp *isp_stats)\n{\n\tif (type == DVS_STATISTICS) {\n\t\tia_css_get_dvs_statistics(host_stats->p_dvs_statistics_host,\n\t\t\t\t\t  isp_stats->p_dvs_statistics_isp);\n\t} else if (type == DVS2_STATISTICS) {\n\t\tia_css_get_dvs2_statistics(host_stats->p_dvs2_statistics_host,\n\t\t\t\t\t   isp_stats->p_dvs_statistics_isp);\n\t}\n\treturn;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}