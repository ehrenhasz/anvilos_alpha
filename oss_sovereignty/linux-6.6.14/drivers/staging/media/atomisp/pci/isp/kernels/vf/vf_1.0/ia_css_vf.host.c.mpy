{
  "module_name": "ia_css_vf.host.c",
  "hash_id": "da6564601a35690a962e2ec6d96588022344f09fbd1f7c0ad9aa74e2af72ef55",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/isp/kernels/vf/vf_1.0/ia_css_vf.host.c",
  "human_readable_source": "\n \n\n#include \"atomisp_internal.h\"\n\n#include \"ia_css_vf.host.h\"\n#include <assert_support.h>\n#include <ia_css_err.h>\n#include <ia_css_frame.h>\n#include <ia_css_frame_public.h>\n#include <ia_css_pipeline.h>\n#define IA_CSS_INCLUDE_CONFIGURATIONS\n#include \"ia_css_isp_configs.h\"\n\n#include \"isp.h\"\n\nint ia_css_vf_config(struct sh_css_isp_vf_isp_config      *to,\n\t\t    const struct ia_css_vf_configuration *from,\n\t\t    unsigned int size)\n{\n\tunsigned int elems_a = ISP_VEC_NELEMS;\n\tint ret;\n\n\tto->vf_downscale_bits = from->vf_downscale_bits;\n\tto->enable = from->info != NULL;\n\n\tif (from->info) {\n\t\tia_css_frame_info_to_frame_sp_info(&to->info, from->info);\n\t\tret = ia_css_dma_configure_from_info(&to->dma.port_b, from->info);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tto->dma.width_a_over_b = elems_a / to->dma.port_b.elems;\n\n\t\t \n\t\tif (elems_a % to->dma.port_b.elems != 0)\n\t\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\n \nint\nsh_css_vf_downscale_log2(\n    const struct ia_css_frame_info *out_info,\n    const struct ia_css_frame_info *vf_info,\n    unsigned int *downscale_log2) {\n\tunsigned int ds_log2 = 0;\n\tunsigned int out_width;\n\n\tif ((!out_info) || (!vf_info))\n\t\treturn -EINVAL;\n\n\tout_width = out_info->res.width;\n\n\tif (out_width == 0)\n\t\treturn -EINVAL;\n\n\t \n\twhile (out_width >= vf_info->res.width)\n\t{\n\t\tds_log2++;\n\t\tout_width /= 2;\n\t}\n\t \n\tif ((ds_log2 > 0) && (out_width < ia_css_binary_max_vf_width()))\n\t\tds_log2--;\n\t \n\tif ((out_info->res.width >> ds_log2) >= 2 * ia_css_binary_max_vf_width())\n\t\treturn -EINVAL;\n\t*downscale_log2 = ds_log2;\n\treturn 0;\n}\n\nstatic int\nconfigure_kernel(\n    const struct ia_css_binary_info *info,\n    const struct ia_css_frame_info *out_info,\n    const struct ia_css_frame_info *vf_info,\n    unsigned int *downscale_log2,\n    struct ia_css_vf_configuration *config) {\n\tint err;\n\tunsigned int vf_log_ds = 0;\n\n\t \n\tif (vf_info)\n\t{\n\t\terr = sh_css_vf_downscale_log2(out_info, vf_info, &vf_log_ds);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\tvf_log_ds = min(vf_log_ds, info->vf_dec.max_log_downscale);\n\t*downscale_log2 = vf_log_ds;\n\n\t \n\tconfig->vf_downscale_bits = vf_log_ds;\n\treturn 0;\n}\n\nstatic void\nconfigure_dma(\n    struct ia_css_vf_configuration *config,\n    const struct ia_css_frame_info *vf_info)\n{\n\tconfig->info = vf_info;\n}\n\nint ia_css_vf_configure(const struct ia_css_binary *binary,\n\t\t        const struct ia_css_frame_info *out_info,\n\t\t\tstruct ia_css_frame_info *vf_info,\n\t\t\tunsigned int *downscale_log2)\n{\n\tint err;\n\tstruct ia_css_vf_configuration config;\n\tconst struct ia_css_binary_info *info = &binary->info->sp;\n\n\terr = configure_kernel(info, out_info, vf_info, downscale_log2, &config);\n\tif (err)\n\t\tdev_warn(atomisp_dev, \"Couldn't setup downscale\\n\");\n\n\tconfigure_dma(&config, vf_info);\n\n\tif (vf_info)\n\t\tvf_info->raw_bit_depth = info->dma.vfdec_bits_per_pixel;\n\n\treturn ia_css_configure_vf(binary, &config);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}