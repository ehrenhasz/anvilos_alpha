{
  "module_name": "ia_css_sdis.host.c",
  "hash_id": "68e22b34d58430e0ce1bde9dd1e4014e9bda033f4333e4052eef0f6bbffeb3d9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/isp/kernels/sdis/sdis_1.0/ia_css_sdis.host.c",
  "human_readable_source": "\n \n\n#include \"hmm.h\"\n\n#include \"assert_support.h\"\n#include \"ia_css_debug.h\"\n#include \"ia_css_sdis_types.h\"\n#include \"sdis/common/ia_css_sdis_common.host.h\"\n#include \"ia_css_sdis.host.h\"\n\nconst struct ia_css_dvs_coefficients default_sdis_config = {\n\t.grid = { 0, 0, 0, 0, 0, 0, 0, 0 },\n\t.hor_coefs = NULL,\n\t.ver_coefs = NULL\n};\n\nstatic void\nfill_row(short *private, const short *public, unsigned int width,\n\t unsigned int padding)\n{\n\tassert((int)width >= 0);\n\tassert((int)padding >= 0);\n\tmemcpy(private, public, width * sizeof(short));\n\tmemset(&private[width], 0, padding * sizeof(short));\n}\n\nvoid ia_css_sdis_horicoef_vmem_encode(\n    struct sh_css_isp_sdis_hori_coef_tbl *to,\n    const struct ia_css_dvs_coefficients *from,\n    unsigned int size)\n{\n\tunsigned int aligned_width = from->grid.aligned_width *\n\t\t\t\t     from->grid.bqs_per_grid_cell;\n\tunsigned int width         = from->grid.num_hor_coefs;\n\tint      padding       = aligned_width - width;\n\tunsigned int stride        = size / IA_CSS_DVS_NUM_COEF_TYPES / sizeof(short);\n\tunsigned int total_bytes   = aligned_width * IA_CSS_DVS_NUM_COEF_TYPES * sizeof(\n\t\t\t\t\t short);\n\tshort   *public        = from->hor_coefs;\n\tshort   *private       = (short *)to;\n\tunsigned int type;\n\n\t \n\tassert(padding >= 0);\n\tassert(total_bytes <= size);\n\tassert(size % (IA_CSS_DVS_NUM_COEF_TYPES * ISP_VEC_NELEMS * sizeof(\n\t\t\t   short)) == 0);\n\n\tfor (type = 0; type < IA_CSS_DVS_NUM_COEF_TYPES; type++) {\n\t\tfill_row(&private[type * stride], &public[type * width], width, padding);\n\t}\n}\n\nvoid ia_css_sdis_vertcoef_vmem_encode(\n    struct sh_css_isp_sdis_vert_coef_tbl *to,\n    const struct ia_css_dvs_coefficients *from,\n    unsigned int size)\n{\n\tunsigned int aligned_height = from->grid.aligned_height *\n\t\t\t\t      from->grid.bqs_per_grid_cell;\n\tunsigned int height         = from->grid.num_ver_coefs;\n\tint      padding        = aligned_height - height;\n\tunsigned int stride         = size / IA_CSS_DVS_NUM_COEF_TYPES / sizeof(short);\n\tunsigned int total_bytes    = aligned_height * IA_CSS_DVS_NUM_COEF_TYPES *\n\t\t\t\t      sizeof(short);\n\tshort   *public         = from->ver_coefs;\n\tshort   *private        = (short *)to;\n\tunsigned int type;\n\n\t \n\tassert(padding >= 0);\n\tassert(total_bytes <= size);\n\tassert(size % (IA_CSS_DVS_NUM_COEF_TYPES * ISP_VEC_NELEMS * sizeof(\n\t\t\t   short)) == 0);\n\n\tfor (type = 0; type < IA_CSS_DVS_NUM_COEF_TYPES; type++) {\n\t\tfill_row(&private[type * stride], &public[type * height], height, padding);\n\t}\n}\n\nvoid ia_css_sdis_horiproj_encode(\n    struct sh_css_isp_sdis_hori_proj_tbl *to,\n    const struct ia_css_dvs_coefficients *from,\n    unsigned int size)\n{\n\t(void)to;\n\t(void)from;\n\t(void)size;\n}\n\nvoid ia_css_sdis_vertproj_encode(\n    struct sh_css_isp_sdis_vert_proj_tbl *to,\n    const struct ia_css_dvs_coefficients *from,\n    unsigned int size)\n{\n\t(void)to;\n\t(void)from;\n\t(void)size;\n}\n\nvoid ia_css_get_isp_dis_coefficients(\n    struct ia_css_stream *stream,\n    short *horizontal_coefficients,\n    short *vertical_coefficients)\n{\n\tstruct ia_css_isp_parameters *params;\n\tunsigned int hor_num_isp, ver_num_isp;\n\tunsigned int hor_num_3a,  ver_num_3a;\n\tint i;\n\tstruct ia_css_binary *dvs_binary;\n\n\tIA_CSS_ENTER(\"void\");\n\n\tassert(horizontal_coefficients);\n\tassert(vertical_coefficients);\n\n\tparams = stream->isp_params_configs;\n\n\t \n\tdvs_binary = ia_css_stream_get_dvs_binary(stream);\n\tif (!dvs_binary)\n\t\treturn;\n\n\thor_num_isp = dvs_binary->dis.coef.pad.width;\n\tver_num_isp = dvs_binary->dis.coef.pad.height;\n\thor_num_3a  = dvs_binary->dis.coef.dim.width;\n\tver_num_3a  = dvs_binary->dis.coef.dim.height;\n\n\tfor (i = 0; i < IA_CSS_DVS_NUM_COEF_TYPES; i++) {\n\t\tfill_row(&horizontal_coefficients[i * hor_num_isp],\n\t\t\t &params->dvs_coefs.hor_coefs[i * hor_num_3a], hor_num_3a,\n\t\t\t hor_num_isp - hor_num_3a);\n\t}\n\tfor (i = 0; i < SH_CSS_DIS_VER_NUM_COEF_TYPES(dvs_binary); i++) {\n\t\tfill_row(&vertical_coefficients[i * ver_num_isp],\n\t\t\t &params->dvs_coefs.ver_coefs[i * ver_num_3a], ver_num_3a,\n\t\t\t ver_num_isp - ver_num_3a);\n\t}\n\n\tIA_CSS_LEAVE(\"void\");\n}\n\nsize_t\nia_css_sdis_hor_coef_tbl_bytes(\n    const struct ia_css_binary *binary)\n{\n\tif (binary->info->sp.pipeline.isp_pipe_version == 1)\n\t\treturn sizeof(short) * IA_CSS_DVS_NUM_COEF_TYPES  * binary->dis.coef.pad.width;\n\telse\n\t\treturn sizeof(short) * IA_CSS_DVS2_NUM_COEF_TYPES * binary->dis.coef.pad.width;\n}\n\nsize_t\nia_css_sdis_ver_coef_tbl_bytes(\n    const struct ia_css_binary *binary)\n{\n\treturn sizeof(short) * SH_CSS_DIS_VER_NUM_COEF_TYPES(binary) *\n\t       binary->dis.coef.pad.height;\n}\n\nvoid\nia_css_sdis_init_info(\n    struct ia_css_sdis_info *dis,\n    unsigned int sc_3a_dis_width,\n    unsigned int sc_3a_dis_padded_width,\n    unsigned int sc_3a_dis_height,\n    unsigned int isp_pipe_version,\n    unsigned int enabled)\n{\n\tif (!enabled) {\n\t\t*dis = (struct ia_css_sdis_info) { };\n\t\treturn;\n\t}\n\n\tdis->deci_factor_log2 = SH_CSS_DIS_DECI_FACTOR_LOG2;\n\n\tdis->grid.dim.width  =\n\t    _ISP_BQS(sc_3a_dis_width) >> SH_CSS_DIS_DECI_FACTOR_LOG2;\n\tdis->grid.dim.height =\n\t    _ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2;\n\tdis->grid.pad.width  =\n\t    CEIL_SHIFT(_ISP_BQS(sc_3a_dis_padded_width), SH_CSS_DIS_DECI_FACTOR_LOG2);\n\tdis->grid.pad.height =\n\t    CEIL_SHIFT(_ISP_BQS(sc_3a_dis_height), SH_CSS_DIS_DECI_FACTOR_LOG2);\n\n\tdis->coef.dim.width  =\n\t    (_ISP_BQS(sc_3a_dis_width)  >> SH_CSS_DIS_DECI_FACTOR_LOG2) <<\n\t    SH_CSS_DIS_DECI_FACTOR_LOG2;\n\tdis->coef.dim.height =\n\t    (_ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2) <<\n\t    SH_CSS_DIS_DECI_FACTOR_LOG2;\n\tdis->coef.pad.width  =\n\t    __ISP_SDIS_HOR_COEF_NUM_VECS(sc_3a_dis_padded_width) * ISP_VEC_NELEMS;\n\tdis->coef.pad.height =\n\t    __ISP_SDIS_VER_COEF_NUM_VECS(sc_3a_dis_height) * ISP_VEC_NELEMS;\n\tif (isp_pipe_version == 1) {\n\t\tdis->proj.dim.width  =\n\t\t    _ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2;\n\t\tdis->proj.dim.height =\n\t\t    _ISP_BQS(sc_3a_dis_width)  >> SH_CSS_DIS_DECI_FACTOR_LOG2;\n\t} else {\n\t\tdis->proj.dim.width  =\n\t\t    (_ISP_BQS(sc_3a_dis_width)  >> SH_CSS_DIS_DECI_FACTOR_LOG2) *\n\t\t    (_ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2);\n\t\tdis->proj.dim.height =\n\t\t    (_ISP_BQS(sc_3a_dis_width)  >> SH_CSS_DIS_DECI_FACTOR_LOG2) *\n\t\t    (_ISP_BQS(sc_3a_dis_height) >> SH_CSS_DIS_DECI_FACTOR_LOG2);\n\t}\n\tdis->proj.pad.width  =\n\t    __ISP_SDIS_HOR_PROJ_NUM_ISP(sc_3a_dis_padded_width,\n\t\t\t\t\tsc_3a_dis_height,\n\t\t\t\t\tSH_CSS_DIS_DECI_FACTOR_LOG2,\n\t\t\t\t\tisp_pipe_version);\n\tdis->proj.pad.height =\n\t    __ISP_SDIS_VER_PROJ_NUM_ISP(sc_3a_dis_padded_width,\n\t\t\t\t\tSH_CSS_DIS_DECI_FACTOR_LOG2);\n}\n\nvoid ia_css_sdis_clear_coefficients(\n    struct ia_css_dvs_coefficients *dvs_coefs)\n{\n\tdvs_coefs->hor_coefs = NULL;\n\tdvs_coefs->ver_coefs = NULL;\n}\n\nint\nia_css_get_dvs_statistics(\n    struct ia_css_dvs_statistics\t       *host_stats,\n    const struct ia_css_isp_dvs_statistics *isp_stats) {\n\tstruct ia_css_isp_dvs_statistics_map *map;\n\tint ret = 0;\n\n\tIA_CSS_ENTER(\"host_stats=%p, isp_stats=%p\", host_stats, isp_stats);\n\n\tassert(host_stats);\n\tassert(isp_stats);\n\n\tmap = ia_css_isp_dvs_statistics_map_allocate(isp_stats, NULL);\n\tif (map)\n\t{\n\t\thmm_load(isp_stats->data_ptr, map->data_ptr, isp_stats->size);\n\t\tia_css_translate_dvs_statistics(host_stats, map);\n\t\tia_css_isp_dvs_statistics_map_free(map);\n\t} else\n\t{\n\t\tIA_CSS_ERROR(\"out of memory\");\n\t\tret = -ENOMEM;\n\t}\n\n\tIA_CSS_LEAVE_ERR(ret);\n\treturn ret;\n}\n\nvoid\nia_css_translate_dvs_statistics(\n    struct ia_css_dvs_statistics               *host_stats,\n    const struct ia_css_isp_dvs_statistics_map *isp_stats)\n{\n\tunsigned int hor_num_isp, ver_num_isp, hor_num_dvs, ver_num_dvs, i;\n\ts32 *hor_ptr_dvs, *ver_ptr_dvs, *hor_ptr_isp, *ver_ptr_isp;\n\n\tassert(host_stats);\n\tassert(host_stats->hor_proj);\n\tassert(host_stats->ver_proj);\n\tassert(isp_stats);\n\tassert(isp_stats->hor_proj);\n\tassert(isp_stats->ver_proj);\n\n\tIA_CSS_ENTER(\"hproj=%p, vproj=%p, haddr=%p, vaddr=%p\",\n\t\t     host_stats->hor_proj, host_stats->ver_proj,\n\t\t     isp_stats->hor_proj, isp_stats->ver_proj);\n\n\thor_num_isp = host_stats->grid.aligned_height;\n\tver_num_isp = host_stats->grid.aligned_width;\n\thor_ptr_isp = isp_stats->hor_proj;\n\tver_ptr_isp = isp_stats->ver_proj;\n\thor_num_dvs = host_stats->grid.height;\n\tver_num_dvs = host_stats->grid.width;\n\thor_ptr_dvs = host_stats->hor_proj;\n\tver_ptr_dvs = host_stats->ver_proj;\n\n\tfor (i = 0; i < IA_CSS_DVS_NUM_COEF_TYPES; i++) {\n\t\tmemcpy(hor_ptr_dvs, hor_ptr_isp, hor_num_dvs * sizeof(int32_t));\n\t\thor_ptr_isp += hor_num_isp;\n\t\thor_ptr_dvs += hor_num_dvs;\n\n\t\tmemcpy(ver_ptr_dvs, ver_ptr_isp, ver_num_dvs * sizeof(int32_t));\n\t\tver_ptr_isp += ver_num_isp;\n\t\tver_ptr_dvs += ver_num_dvs;\n\t}\n\n\tIA_CSS_LEAVE(\"void\");\n}\n\nstruct ia_css_isp_dvs_statistics *\nia_css_isp_dvs_statistics_allocate(\n    const struct ia_css_dvs_grid_info *grid)\n{\n\tstruct ia_css_isp_dvs_statistics *me;\n\tint hor_size, ver_size;\n\n\tassert(grid);\n\n\tIA_CSS_ENTER(\"grid=%p\", grid);\n\n\tif (!grid->enable)\n\t\treturn NULL;\n\n\tme = kvcalloc(1, sizeof(*me), GFP_KERNEL);\n\tif (!me)\n\t\tgoto err;\n\n\thor_size = CEIL_MUL(sizeof(int) * IA_CSS_DVS_NUM_COEF_TYPES *\n\t\t\t    grid->aligned_height,\n\t\t\t    HIVE_ISP_DDR_WORD_BYTES);\n\tver_size = CEIL_MUL(sizeof(int) * IA_CSS_DVS_NUM_COEF_TYPES *\n\t\t\t    grid->aligned_width,\n\t\t\t    HIVE_ISP_DDR_WORD_BYTES);\n\n\tme->size = hor_size + ver_size;\n\tme->data_ptr = hmm_alloc(me->size);\n\tif (me->data_ptr == mmgr_NULL)\n\t\tgoto err;\n\tme->hor_size = hor_size;\n\tme->hor_proj = me->data_ptr;\n\tme->ver_size = ver_size;\n\tme->ver_proj = me->data_ptr + hor_size;\n\n\tIA_CSS_LEAVE(\"return=%p\", me);\n\n\treturn me;\nerr:\n\tia_css_isp_dvs_statistics_free(me);\n\n\tIA_CSS_LEAVE(\"return=%p\", NULL);\n\n\treturn NULL;\n}\n\nstruct ia_css_isp_dvs_statistics_map *\nia_css_isp_dvs_statistics_map_allocate(\n    const struct ia_css_isp_dvs_statistics *isp_stats,\n    void *data_ptr)\n{\n\tstruct ia_css_isp_dvs_statistics_map *me;\n\t \n\tchar *base_ptr;\n\n\tme = kvmalloc(sizeof(*me), GFP_KERNEL);\n\tif (!me) {\n\t\tIA_CSS_LOG(\"cannot allocate memory\");\n\t\tgoto err;\n\t}\n\n\tme->data_ptr = data_ptr;\n\tme->data_allocated = !data_ptr;\n\n\tif (!me->data_ptr) {\n\t\tme->data_ptr = kvmalloc(isp_stats->size, GFP_KERNEL);\n\t\tif (!me->data_ptr) {\n\t\t\tIA_CSS_LOG(\"cannot allocate memory\");\n\t\t\tgoto err;\n\t\t}\n\t}\n\tbase_ptr = me->data_ptr;\n\n\tme->size = isp_stats->size;\n\t \n\tme->hor_proj = (void *)base_ptr;\n\tme->ver_proj = (void *)(base_ptr + isp_stats->hor_size);\n\n\treturn me;\nerr:\n\tkvfree(me);\n\treturn NULL;\n}\n\nvoid\nia_css_isp_dvs_statistics_map_free(struct ia_css_isp_dvs_statistics_map *me)\n{\n\tif (me) {\n\t\tif (me->data_allocated)\n\t\t\tkvfree(me->data_ptr);\n\t\tkvfree(me);\n\t}\n}\n\nvoid\nia_css_isp_dvs_statistics_free(struct ia_css_isp_dvs_statistics *me)\n{\n\tif (me) {\n\t\thmm_free(me->data_ptr);\n\t\tkvfree(me);\n\t}\n}\n\nvoid ia_css_sdis_horicoef_debug_dtrace(\n    const struct ia_css_dvs_coefficients *config, unsigned int level)\n{\n\t(void)config;\n\t(void)level;\n}\n\nvoid ia_css_sdis_vertcoef_debug_dtrace(\n    const struct ia_css_dvs_coefficients *config, unsigned int level)\n{\n\t(void)config;\n\t(void)level;\n}\n\nvoid ia_css_sdis_horiproj_debug_dtrace(\n    const struct ia_css_dvs_coefficients *config, unsigned int level)\n{\n\t(void)config;\n\t(void)level;\n}\n\nvoid ia_css_sdis_vertproj_debug_dtrace(\n    const struct ia_css_dvs_coefficients *config, unsigned int level)\n{\n\t(void)config;\n\t(void)level;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}