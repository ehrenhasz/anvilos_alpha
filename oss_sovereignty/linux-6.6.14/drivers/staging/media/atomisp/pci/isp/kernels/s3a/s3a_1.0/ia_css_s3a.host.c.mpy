{
  "module_name": "ia_css_s3a.host.c",
  "hash_id": "aa77afe1e93e65ac19e8a6e2015c0de1dd6980547b5aedd1efb5dcb5a5ebd513",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/atomisp/pci/isp/kernels/s3a/s3a_1.0/ia_css_s3a.host.c",
  "human_readable_source": "\n \n\n#include \"ia_css_types.h\"\n#include \"sh_css_defs.h\"\n#ifndef IA_CSS_NO_DEBUG\n#include \"ia_css_debug.h\"\n#endif\n#include \"sh_css_frac.h\"\n#include \"assert_support.h\"\n\n#include \"bh/bh_2/ia_css_bh.host.h\"\n#include \"ia_css_s3a.host.h\"\n\nconst struct ia_css_3a_config default_3a_config = {\n\t25559,\n\t32768,\n\t7209,\n\t65535,\n\t0,\n\t65535,\n\t{-3344, -6104, -19143, 19143, 6104, 3344, 0},\n\t{1027, 0, -9219, 16384, -9219, 1027, 0}\n};\n\nstatic unsigned int s3a_raw_bit_depth;\n\nvoid\nia_css_s3a_configure(unsigned int raw_bit_depth)\n{\n\ts3a_raw_bit_depth = raw_bit_depth;\n}\n\nstatic void\nia_css_ae_encode(\n    struct sh_css_isp_ae_params *to,\n    const struct ia_css_3a_config *from,\n    unsigned int size)\n{\n\t(void)size;\n\t \n\tto->y_coef_r =\n\t    uDIGIT_FITTING(from->ae_y_coef_r, 16, SH_CSS_AE_YCOEF_SHIFT);\n\tto->y_coef_g =\n\t    uDIGIT_FITTING(from->ae_y_coef_g, 16, SH_CSS_AE_YCOEF_SHIFT);\n\tto->y_coef_b =\n\t    uDIGIT_FITTING(from->ae_y_coef_b, 16, SH_CSS_AE_YCOEF_SHIFT);\n}\n\nstatic void\nia_css_awb_encode(\n    struct sh_css_isp_awb_params *to,\n    const struct ia_css_3a_config *from,\n    unsigned int size)\n{\n\t(void)size;\n\t \n\tto->lg_high_raw =\n\t    uDIGIT_FITTING(from->awb_lg_high_raw, 16, s3a_raw_bit_depth);\n\tto->lg_low =\n\t    uDIGIT_FITTING(from->awb_lg_low, 16, SH_CSS_BAYER_BITS);\n\tto->lg_high =\n\t    uDIGIT_FITTING(from->awb_lg_high, 16, SH_CSS_BAYER_BITS);\n}\n\nstatic void\nia_css_af_encode(\n    struct sh_css_isp_af_params *to,\n    const struct ia_css_3a_config *from,\n    unsigned int size)\n{\n\tunsigned int i;\n\t(void)size;\n\n\t \n\tfor (i = 0; i < 7; ++i) {\n\t\tto->fir1[i] =\n\t\t    sDIGIT_FITTING(from->af_fir1_coef[i], 15,\n\t\t\t\t   SH_CSS_AF_FIR_SHIFT);\n\t\tto->fir2[i] =\n\t\t    sDIGIT_FITTING(from->af_fir2_coef[i], 15,\n\t\t\t\t   SH_CSS_AF_FIR_SHIFT);\n\t}\n}\n\nvoid\nia_css_s3a_encode(\n    struct sh_css_isp_s3a_params *to,\n    const struct ia_css_3a_config *from,\n    unsigned int size)\n{\n\t(void)size;\n\n\tia_css_ae_encode(&to->ae,   from, sizeof(to->ae));\n\tia_css_awb_encode(&to->awb, from, sizeof(to->awb));\n\tia_css_af_encode(&to->af,   from, sizeof(to->af));\n}\n\n#if 0\nvoid\nia_css_process_s3a(\n    unsigned int pipe_id,\n    const struct ia_css_pipeline_stage *stage,\n    struct ia_css_isp_parameters *params)\n{\n\tshort dmem_offset = stage->binary->info->mem_offsets->dmem.s3a;\n\n\tassert(params);\n\n\tif (dmem_offset >= 0) {\n\t\tia_css_s3a_encode((struct sh_css_isp_s3a_params *)\n\t\t\t\t  &stage->isp_mem_params[IA_CSS_ISP_DMEM0].address[dmem_offset],\n\t\t\t\t  &params->s3a_config);\n\t\tia_css_bh_encode((struct sh_css_isp_bh_params *)\n\t\t\t\t &stage->isp_mem_params[IA_CSS_ISP_DMEM0].address[dmem_offset],\n\t\t\t\t &params->s3a_config);\n\t\tparams->isp_params_changed = true;\n\t\tparams->isp_mem_params_changed[pipe_id][stage->stage_num][IA_CSS_ISP_DMEM0] =\n\t\t    true;\n\t}\n\n\tparams->isp_params_changed = true;\n}\n#endif\n\n#ifndef IA_CSS_NO_DEBUG\nvoid\nia_css_ae_dump(\n    const struct sh_css_isp_ae_params *ae,\n    unsigned int level)\n{\n\tif (!ae) return;\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"ae_y_coef_r\", ae->y_coef_r);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"ae_y_coef_g\", ae->y_coef_g);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"ae_y_coef_b\", ae->y_coef_b);\n}\n\nvoid\nia_css_awb_dump(\n    const struct sh_css_isp_awb_params *awb,\n    unsigned int level)\n{\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"awb_lg_high_raw\", awb->lg_high_raw);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"awb_lg_low\", awb->lg_low);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"awb_lg_high\", awb->lg_high);\n}\n\nvoid\nia_css_af_dump(\n    const struct sh_css_isp_af_params *af,\n    unsigned int level)\n{\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir1[0]\", af->fir1[0]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir1[1]\", af->fir1[1]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir1[2]\", af->fir1[2]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir1[3]\", af->fir1[3]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir1[4]\", af->fir1[4]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir1[5]\", af->fir1[5]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir1[6]\", af->fir1[6]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir2[0]\", af->fir2[0]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir2[1]\", af->fir2[1]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir2[2]\", af->fir2[2]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir2[3]\", af->fir2[3]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir2[4]\", af->fir2[4]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir2[5]\", af->fir2[5]);\n\tia_css_debug_dtrace(level, \"\\t%-32s = %d\\n\",\n\t\t\t    \"af_fir2[6]\", af->fir2[6]);\n}\n\nvoid\nia_css_s3a_dump(\n    const struct sh_css_isp_s3a_params *s3a,\n    unsigned int level)\n{\n\tia_css_debug_dtrace(level, \"S3A Support:\\n\");\n\tia_css_ae_dump(&s3a->ae, level);\n\tia_css_awb_dump(&s3a->awb, level);\n\tia_css_af_dump(&s3a->af, level);\n}\n\nvoid\nia_css_s3a_debug_dtrace(\n    const struct ia_css_3a_config *config,\n    unsigned int level)\n{\n\tia_css_debug_dtrace(level,\n\t\t\t    \"config.ae_y_coef_r=%d, config.ae_y_coef_g=%d, config.ae_y_coef_b=%d, config.awb_lg_high_raw=%d, config.awb_lg_low=%d, config.awb_lg_high=%d\\n\",\n\t\t\t    config->ae_y_coef_r, config->ae_y_coef_g,\n\t\t\t    config->ae_y_coef_b, config->awb_lg_high_raw,\n\t\t\t    config->awb_lg_low, config->awb_lg_high);\n}\n#endif\n\nvoid\nia_css_s3a_hmem_decode(\n    struct ia_css_3a_statistics *host_stats,\n    const struct ia_css_bh_table *hmem_buf)\n{\n\tstruct ia_css_3a_rgby_output\t*out_ptr;\n\tint\t\t\ti;\n\n\t \n\tint count_for_3a;\n\tint sum_r, diff;\n\n\tassert(host_stats);\n\tassert(host_stats->rgby_data);\n\tassert(hmem_buf);\n\n\tcount_for_3a = host_stats->grid.width * host_stats->grid.height\n\t\t       * host_stats->grid.bqs_per_grid_cell\n\t\t       * host_stats->grid.bqs_per_grid_cell;\n\n\tout_ptr = host_stats->rgby_data;\n\n\tia_css_bh_hmem_decode(out_ptr, hmem_buf);\n\n\t \n\tsum_r = 0;\n\tfor (i = 0; i < HMEM_UNIT_SIZE; i++) {\n\t\tsum_r += out_ptr[i].r;\n\t}\n\tif (sum_r < count_for_3a) {\n\t\t \n\t\treturn;\n\t}\n\n\t \n#if 0\n\t{\n\t\tint sum_g = 0;\n\t\tint sum_b = 0;\n\t\tint sum_y = 0;\n\n\t\tfor (i = 0; i < HMEM_UNIT_SIZE; i++) {\n\t\t\tsum_g += out_ptr[i].g;\n\t\t\tsum_b += out_ptr[i].b;\n\t\t\tsum_y += out_ptr[i].y;\n\t\t}\n\t\tif (sum_g != sum_r || sum_b != sum_r || sum_y != sum_r) {\n\t\t\t \n\t\t\treturn;\n\t\t}\n\t}\n#endif\n\n\t \n\tdiff = sum_r - count_for_3a;\n\tout_ptr[0].r -= diff;\n\tout_ptr[0].g -= diff;\n\tout_ptr[0].b -= diff;\n\tout_ptr[0].y -= diff;\n}\n\nvoid\nia_css_s3a_dmem_decode(\n    struct ia_css_3a_statistics *host_stats,\n    const struct ia_css_3a_output *isp_stats)\n{\n\tint isp_width, host_width, height, i;\n\tstruct ia_css_3a_output *host_ptr;\n\n\tassert(host_stats);\n\tassert(host_stats->data);\n\tassert(isp_stats);\n\n\tisp_width  = host_stats->grid.aligned_width;\n\thost_width = host_stats->grid.width;\n\theight     = host_stats->grid.height;\n\thost_ptr   = host_stats->data;\n\n\t \n\tfor (i = 0; i < height; i++) {\n\t\tmemcpy(host_ptr, isp_stats, host_width * sizeof(*host_ptr));\n\t\tisp_stats += isp_width;\n\t\thost_ptr += host_width;\n\t}\n}\n\n \nstatic inline int\nmerge_hi_lo_14(unsigned short hi, unsigned short lo)\n{\n\tint val = (int)((((unsigned int)hi << 14) & 0xfffc000) |\n\t\t\t((unsigned int)lo & 0x3fff));\n\treturn val;\n}\n\nvoid\nia_css_s3a_vmem_decode(\n    struct ia_css_3a_statistics *host_stats,\n    const u16 *isp_stats_hi,\n    const uint16_t *isp_stats_lo)\n{\n\tint out_width, out_height, chunk, rest, kmax, y, x, k, elm_start, elm, ofs;\n\tconst u16 *hi, *lo;\n\tstruct ia_css_3a_output *output;\n\n\tassert(host_stats);\n\tassert(host_stats->data);\n\tassert(isp_stats_hi);\n\tassert(isp_stats_lo);\n\n\toutput = host_stats->data;\n\tout_width  = host_stats->grid.width;\n\tout_height = host_stats->grid.height;\n\thi = isp_stats_hi;\n\tlo = isp_stats_lo;\n\n\tchunk = ISP_VEC_NELEMS >> host_stats->grid.deci_factor_log2;\n\tchunk = max(chunk, 1);\n\n\tfor (y = 0; y < out_height; y++) {\n\t\telm_start = y * ISP_S3ATBL_HI_LO_STRIDE;\n\t\trest = out_width;\n\t\tx = 0;\n\t\twhile (x < out_width) {\n\t\t\tkmax = (rest > chunk) ? chunk : rest;\n\t\t\tofs = y * out_width + x;\n\t\t\telm = elm_start + x * sizeof(*output) / sizeof(int32_t);\n\t\t\tfor (k = 0; k < kmax; k++, elm++) {\n\t\t\t\toutput[ofs + k].ae_y    = merge_hi_lo_14(\n\t\t\t\t\t\t\t      hi[elm + chunk * 0], lo[elm + chunk * 0]);\n\t\t\t\toutput[ofs + k].awb_cnt = merge_hi_lo_14(\n\t\t\t\t\t\t\t      hi[elm + chunk * 1], lo[elm + chunk * 1]);\n\t\t\t\toutput[ofs + k].awb_gr  = merge_hi_lo_14(\n\t\t\t\t\t\t\t      hi[elm + chunk * 2], lo[elm + chunk * 2]);\n\t\t\t\toutput[ofs + k].awb_r   = merge_hi_lo_14(\n\t\t\t\t\t\t\t      hi[elm + chunk * 3], lo[elm + chunk * 3]);\n\t\t\t\toutput[ofs + k].awb_b   = merge_hi_lo_14(\n\t\t\t\t\t\t\t      hi[elm + chunk * 4], lo[elm + chunk * 4]);\n\t\t\t\toutput[ofs + k].awb_gb  = merge_hi_lo_14(\n\t\t\t\t\t\t\t      hi[elm + chunk * 5], lo[elm + chunk * 5]);\n\t\t\t\toutput[ofs + k].af_hpf1 = merge_hi_lo_14(\n\t\t\t\t\t\t\t      hi[elm + chunk * 6], lo[elm + chunk * 6]);\n\t\t\t\toutput[ofs + k].af_hpf2 = merge_hi_lo_14(\n\t\t\t\t\t\t\t      hi[elm + chunk * 7], lo[elm + chunk * 7]);\n\t\t\t}\n\t\t\tx += chunk;\n\t\t\trest -= chunk;\n\t\t}\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}