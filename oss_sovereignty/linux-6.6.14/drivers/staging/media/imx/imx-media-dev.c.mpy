{
  "module_name": "imx-media-dev.c",
  "hash_id": "90d54cc805fdf6ce3899c076c664653541c835abf3bb6705b9dd84f012002637",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/imx/imx-media-dev.c",
  "human_readable_source": "\n \n#include <linux/fs.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <media/v4l2-async.h>\n#include <media/v4l2-event.h>\n#include <media/imx.h>\n#include \"imx-media.h\"\n\nstatic inline struct imx_media_dev *notifier2dev(struct v4l2_async_notifier *n)\n{\n\treturn container_of(n, struct imx_media_dev, notifier);\n}\n\n \nstatic int imx_media_subdev_bound(struct v4l2_async_notifier *notifier,\n\t\t\t\t  struct v4l2_subdev *sd,\n\t\t\t\t  struct v4l2_async_connection *asd)\n{\n\tstruct imx_media_dev *imxmd = notifier2dev(notifier);\n\tint ret;\n\n\tif (sd->grp_id & IMX_MEDIA_GRP_ID_IPU_CSI) {\n\t\t \n\t\tret = imx_media_register_ipu_internal_subdevs(imxmd, sd);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tdev_dbg(imxmd->md.dev, \"subdev %s bound\\n\", sd->name);\n\n\treturn 0;\n}\n\n \nstatic int imx6_media_probe_complete(struct v4l2_async_notifier *notifier)\n{\n\tstruct imx_media_dev *imxmd = notifier2dev(notifier);\n\tint ret;\n\n\t \n\tret = imx_media_probe_complete(notifier);\n\tif (ret)\n\t\treturn ret;\n\n\tmutex_lock(&imxmd->mutex);\n\n\timxmd->m2m_vdev = imx_media_csc_scaler_device_init(imxmd);\n\tif (IS_ERR(imxmd->m2m_vdev)) {\n\t\tret = PTR_ERR(imxmd->m2m_vdev);\n\t\timxmd->m2m_vdev = NULL;\n\t\tgoto unlock;\n\t}\n\n\tret = imx_media_csc_scaler_device_register(imxmd->m2m_vdev);\nunlock:\n\tmutex_unlock(&imxmd->mutex);\n\treturn ret;\n}\n\n \nstatic const struct v4l2_async_notifier_operations imx_media_notifier_ops = {\n\t.bound = imx_media_subdev_bound,\n\t.complete = imx6_media_probe_complete,\n};\n\nstatic int imx_media_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *node = dev->of_node;\n\tstruct imx_media_dev *imxmd;\n\tint ret;\n\n\timxmd = imx_media_dev_init(dev, NULL);\n\tif (IS_ERR(imxmd))\n\t\treturn PTR_ERR(imxmd);\n\n\tret = imx_media_add_of_subdevs(imxmd, node);\n\tif (ret) {\n\t\tv4l2_err(&imxmd->v4l2_dev,\n\t\t\t \"add_of_subdevs failed with %d\\n\", ret);\n\t\tgoto cleanup;\n\t}\n\n\tret = imx_media_dev_notifier_register(imxmd, &imx_media_notifier_ops);\n\tif (ret)\n\t\tgoto cleanup;\n\n\treturn 0;\n\ncleanup:\n\tv4l2_async_nf_cleanup(&imxmd->notifier);\n\tv4l2_device_unregister(&imxmd->v4l2_dev);\n\tmedia_device_cleanup(&imxmd->md);\n\n\treturn ret;\n}\n\nstatic void imx_media_remove(struct platform_device *pdev)\n{\n\tstruct imx_media_dev *imxmd =\n\t\t(struct imx_media_dev *)platform_get_drvdata(pdev);\n\n\tv4l2_info(&imxmd->v4l2_dev, \"Removing imx-media\\n\");\n\n\tif (imxmd->m2m_vdev) {\n\t\timx_media_csc_scaler_device_unregister(imxmd->m2m_vdev);\n\t\timxmd->m2m_vdev = NULL;\n\t}\n\n\tv4l2_async_nf_unregister(&imxmd->notifier);\n\timx_media_unregister_ipu_internal_subdevs(imxmd);\n\tv4l2_async_nf_cleanup(&imxmd->notifier);\n\tmedia_device_unregister(&imxmd->md);\n\tv4l2_device_unregister(&imxmd->v4l2_dev);\n\tmedia_device_cleanup(&imxmd->md);\n}\n\nstatic const struct of_device_id imx_media_dt_ids[] = {\n\t{ .compatible = \"fsl,imx-capture-subsystem\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, imx_media_dt_ids);\n\nstatic struct platform_driver imx_media_pdrv = {\n\t.probe\t\t= imx_media_probe,\n\t.remove_new\t= imx_media_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"imx-media\",\n\t\t.of_match_table\t= imx_media_dt_ids,\n\t},\n};\n\nmodule_platform_driver(imx_media_pdrv);\n\nMODULE_DESCRIPTION(\"i.MX5/6 v4l2 media controller driver\");\nMODULE_AUTHOR(\"Steve Longerbeam <steve_longerbeam@mentor.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}