{
  "module_name": "imx-media-utils.c",
  "hash_id": "a29d2482f1abb65571ade7047bd33c64789c71709ae7cc6baa9281123db2c8ea",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/imx/imx-media-utils.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include \"imx-media.h\"\n\n#define IMX_BUS_FMTS(fmt...) ((const u32[]) {fmt, 0})\n\n \nstatic const struct imx_media_pixfmt pixel_formats[] = {\n\t \n\t{\n\t\t.fourcc\t= V4L2_PIX_FMT_UYVY,\n\t\t.codes  = IMX_BUS_FMTS(\n\t\t\tMEDIA_BUS_FMT_UYVY8_2X8,\n\t\t\tMEDIA_BUS_FMT_UYVY8_1X16\n\t\t),\n\t\t.cs     = IPUV3_COLORSPACE_YUV,\n\t\t.bpp    = 16,\n\t}, {\n\t\t.fourcc\t= V4L2_PIX_FMT_YUYV,\n\t\t.codes  = IMX_BUS_FMTS(\n\t\t\tMEDIA_BUS_FMT_YUYV8_2X8,\n\t\t\tMEDIA_BUS_FMT_YUYV8_1X16\n\t\t),\n\t\t.cs     = IPUV3_COLORSPACE_YUV,\n\t\t.bpp    = 16,\n\t}, {\n\t\t.fourcc\t= V4L2_PIX_FMT_YUV420,\n\t\t.cs     = IPUV3_COLORSPACE_YUV,\n\t\t.bpp    = 12,\n\t\t.planar = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_YVU420,\n\t\t.cs     = IPUV3_COLORSPACE_YUV,\n\t\t.bpp    = 12,\n\t\t.planar = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_YUV422P,\n\t\t.cs     = IPUV3_COLORSPACE_YUV,\n\t\t.bpp    = 16,\n\t\t.planar = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_NV12,\n\t\t.cs     = IPUV3_COLORSPACE_YUV,\n\t\t.bpp    = 12,\n\t\t.planar = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_NV16,\n\t\t.cs     = IPUV3_COLORSPACE_YUV,\n\t\t.bpp    = 16,\n\t\t.planar = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_YUV32,\n\t\t.codes  = IMX_BUS_FMTS(MEDIA_BUS_FMT_AYUV8_1X32),\n\t\t.cs     = IPUV3_COLORSPACE_YUV,\n\t\t.bpp    = 32,\n\t\t.ipufmt = true,\n\t},\n\t \n\t{\n\t\t.fourcc\t= V4L2_PIX_FMT_RGB565,\n\t\t.codes  = IMX_BUS_FMTS(MEDIA_BUS_FMT_RGB565_2X8_LE),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 16,\n\t\t.cycles = 2,\n\t}, {\n\t\t.fourcc\t= V4L2_PIX_FMT_RGB24,\n\t\t.codes  = IMX_BUS_FMTS(\n\t\t\tMEDIA_BUS_FMT_RGB888_1X24,\n\t\t\tMEDIA_BUS_FMT_RGB888_2X12_LE\n\t\t),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 24,\n\t}, {\n\t\t.fourcc\t= V4L2_PIX_FMT_BGR24,\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 24,\n\t}, {\n\t\t.fourcc\t= V4L2_PIX_FMT_XRGB32,\n\t\t.codes  = IMX_BUS_FMTS(MEDIA_BUS_FMT_ARGB8888_1X32),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 32,\n\t}, {\n\t\t.fourcc\t= V4L2_PIX_FMT_XRGB32,\n\t\t.codes  = IMX_BUS_FMTS(MEDIA_BUS_FMT_ARGB8888_1X32),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 32,\n\t\t.ipufmt = true,\n\t}, {\n\t\t.fourcc\t= V4L2_PIX_FMT_XBGR32,\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 32,\n\t}, {\n\t\t.fourcc\t= V4L2_PIX_FMT_BGRX32,\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 32,\n\t}, {\n\t\t.fourcc\t= V4L2_PIX_FMT_RGBX32,\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 32,\n\t},\n\t \n\t{\n\t\t.fourcc = V4L2_PIX_FMT_SBGGR8,\n\t\t.codes  = IMX_BUS_FMTS(MEDIA_BUS_FMT_SBGGR8_1X8),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 8,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_SGBRG8,\n\t\t.codes  = IMX_BUS_FMTS(MEDIA_BUS_FMT_SGBRG8_1X8),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 8,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_SGRBG8,\n\t\t.codes  = IMX_BUS_FMTS(MEDIA_BUS_FMT_SGRBG8_1X8),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 8,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_SRGGB8,\n\t\t.codes  = IMX_BUS_FMTS(MEDIA_BUS_FMT_SRGGB8_1X8),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 8,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_SBGGR16,\n\t\t.codes  = IMX_BUS_FMTS(\n\t\t\tMEDIA_BUS_FMT_SBGGR10_1X10,\n\t\t\tMEDIA_BUS_FMT_SBGGR12_1X12,\n\t\t\tMEDIA_BUS_FMT_SBGGR14_1X14,\n\t\t\tMEDIA_BUS_FMT_SBGGR16_1X16\n\t\t),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 16,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_SGBRG16,\n\t\t.codes  = IMX_BUS_FMTS(\n\t\t\tMEDIA_BUS_FMT_SGBRG10_1X10,\n\t\t\tMEDIA_BUS_FMT_SGBRG12_1X12,\n\t\t\tMEDIA_BUS_FMT_SGBRG14_1X14,\n\t\t\tMEDIA_BUS_FMT_SGBRG16_1X16\n\t\t),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 16,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_SGRBG16,\n\t\t.codes  = IMX_BUS_FMTS(\n\t\t\tMEDIA_BUS_FMT_SGRBG10_1X10,\n\t\t\tMEDIA_BUS_FMT_SGRBG12_1X12,\n\t\t\tMEDIA_BUS_FMT_SGRBG14_1X14,\n\t\t\tMEDIA_BUS_FMT_SGRBG16_1X16\n\t\t),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 16,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_SRGGB16,\n\t\t.codes  = IMX_BUS_FMTS(\n\t\t\tMEDIA_BUS_FMT_SRGGB10_1X10,\n\t\t\tMEDIA_BUS_FMT_SRGGB12_1X12,\n\t\t\tMEDIA_BUS_FMT_SRGGB14_1X14,\n\t\t\tMEDIA_BUS_FMT_SRGGB16_1X16\n\t\t),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 16,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_GREY,\n\t\t.codes = IMX_BUS_FMTS(\n\t\t\tMEDIA_BUS_FMT_Y8_1X8,\n\t\t\tMEDIA_BUS_FMT_Y10_1X10,\n\t\t\tMEDIA_BUS_FMT_Y12_1X12\n\t\t),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 8,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_Y10,\n\t\t.codes = IMX_BUS_FMTS(MEDIA_BUS_FMT_Y10_1X10),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 16,\n\t\t.bayer  = true,\n\t}, {\n\t\t.fourcc = V4L2_PIX_FMT_Y12,\n\t\t.codes = IMX_BUS_FMTS(MEDIA_BUS_FMT_Y12_1X12),\n\t\t.cs     = IPUV3_COLORSPACE_RGB,\n\t\t.bpp    = 16,\n\t\t.bayer  = true,\n\t},\n};\n\n \nconst struct imx_media_pixfmt *\nimx_media_find_pixel_format(u32 fourcc, enum imx_pixfmt_sel fmt_sel)\n{\n\tbool sel_ipu = fmt_sel & PIXFMT_SEL_IPU;\n\tunsigned int i;\n\n\tfmt_sel &= ~PIXFMT_SEL_IPU;\n\n\tfor (i = 0; i < ARRAY_SIZE(pixel_formats); i++) {\n\t\tconst struct imx_media_pixfmt *fmt = &pixel_formats[i];\n\t\tenum imx_pixfmt_sel sel;\n\n\t\tif (sel_ipu != fmt->ipufmt)\n\t\t\tcontinue;\n\n\t\tsel = fmt->bayer ? PIXFMT_SEL_BAYER :\n\t\t\t((fmt->cs == IPUV3_COLORSPACE_YUV) ?\n\t\t\t PIXFMT_SEL_YUV : PIXFMT_SEL_RGB);\n\n\t\tif ((fmt_sel & sel) && fmt->fourcc == fourcc)\n\t\t\treturn fmt;\n\t}\n\n\treturn NULL;\n}\nEXPORT_SYMBOL_GPL(imx_media_find_pixel_format);\n\n \nconst struct imx_media_pixfmt *\nimx_media_find_mbus_format(u32 code, enum imx_pixfmt_sel fmt_sel)\n{\n\tbool sel_ipu = fmt_sel & PIXFMT_SEL_IPU;\n\tunsigned int i;\n\n\tfmt_sel &= ~PIXFMT_SEL_IPU;\n\n\tfor (i = 0; i < ARRAY_SIZE(pixel_formats); i++) {\n\t\tconst struct imx_media_pixfmt *fmt = &pixel_formats[i];\n\t\tenum imx_pixfmt_sel sel;\n\t\tunsigned int j;\n\n\t\tif (sel_ipu != fmt->ipufmt)\n\t\t\tcontinue;\n\n\t\tsel = fmt->bayer ? PIXFMT_SEL_BAYER :\n\t\t\t((fmt->cs == IPUV3_COLORSPACE_YUV) ?\n\t\t\t PIXFMT_SEL_YUV : PIXFMT_SEL_RGB);\n\n\t\tif (!(fmt_sel & sel) || !fmt->codes)\n\t\t\tcontinue;\n\n\t\tfor (j = 0; fmt->codes[j]; j++) {\n\t\t\tif (code == fmt->codes[j])\n\t\t\t\treturn fmt;\n\t\t}\n\t}\n\n\treturn NULL;\n}\nEXPORT_SYMBOL_GPL(imx_media_find_mbus_format);\n\n \nint imx_media_enum_pixel_formats(u32 *fourcc, u32 index,\n\t\t\t\t enum imx_pixfmt_sel fmt_sel, u32 code)\n{\n\tbool sel_ipu = fmt_sel & PIXFMT_SEL_IPU;\n\tunsigned int i;\n\n\tfmt_sel &= ~PIXFMT_SEL_IPU;\n\n\tfor (i = 0; i < ARRAY_SIZE(pixel_formats); i++) {\n\t\tconst struct imx_media_pixfmt *fmt = &pixel_formats[i];\n\t\tenum imx_pixfmt_sel sel;\n\n\t\tif (sel_ipu != fmt->ipufmt)\n\t\t\tcontinue;\n\n\t\tsel = fmt->bayer ? PIXFMT_SEL_BAYER :\n\t\t\t((fmt->cs == IPUV3_COLORSPACE_YUV) ?\n\t\t\t PIXFMT_SEL_YUV : PIXFMT_SEL_RGB);\n\n\t\tif (!(fmt_sel & sel))\n\t\t\tcontinue;\n\n\t\t \n\t\tif (code) {\n\t\t\tunsigned int j;\n\n\t\t\tif (!fmt->codes)\n\t\t\t\tcontinue;\n\n\t\t\tfor (j = 0; fmt->codes[j]; j++) {\n\t\t\t\tif (code == fmt->codes[j])\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!fmt->codes[j])\n\t\t\t\tcontinue;\n\t\t}\n\n\t\tif (index == 0) {\n\t\t\t*fourcc = fmt->fourcc;\n\t\t\treturn 0;\n\t\t}\n\n\t\tindex--;\n\t}\n\n\treturn -EINVAL;\n}\nEXPORT_SYMBOL_GPL(imx_media_enum_pixel_formats);\n\n \nint imx_media_enum_mbus_formats(u32 *code, u32 index,\n\t\t\t\tenum imx_pixfmt_sel fmt_sel)\n{\n\tbool sel_ipu = fmt_sel & PIXFMT_SEL_IPU;\n\tunsigned int i;\n\n\tfmt_sel &= ~PIXFMT_SEL_IPU;\n\n\tfor (i = 0; i < ARRAY_SIZE(pixel_formats); i++) {\n\t\tconst struct imx_media_pixfmt *fmt = &pixel_formats[i];\n\t\tenum imx_pixfmt_sel sel;\n\t\tunsigned int j;\n\n\t\tif (sel_ipu != fmt->ipufmt)\n\t\t\tcontinue;\n\n\t\tsel = fmt->bayer ? PIXFMT_SEL_BAYER :\n\t\t\t((fmt->cs == IPUV3_COLORSPACE_YUV) ?\n\t\t\t PIXFMT_SEL_YUV : PIXFMT_SEL_RGB);\n\n\t\tif (!(fmt_sel & sel) || !fmt->codes)\n\t\t\tcontinue;\n\n\t\tfor (j = 0; fmt->codes[j]; j++) {\n\t\t\tif (index == 0) {\n\t\t\t\t*code = fmt->codes[j];\n\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\tindex--;\n\t\t}\n\t}\n\n\treturn -EINVAL;\n}\nEXPORT_SYMBOL_GPL(imx_media_enum_mbus_formats);\n\nint imx_media_init_mbus_fmt(struct v4l2_mbus_framefmt *mbus,\n\t\t\t    u32 width, u32 height, u32 code, u32 field,\n\t\t\t    const struct imx_media_pixfmt **cc)\n{\n\tconst struct imx_media_pixfmt *lcc;\n\n\tmbus->width = width;\n\tmbus->height = height;\n\tmbus->field = field;\n\n\tif (code == 0)\n\t\timx_media_enum_mbus_formats(&code, 0, PIXFMT_SEL_YUV);\n\n\tlcc = imx_media_find_mbus_format(code, PIXFMT_SEL_ANY);\n\tif (!lcc) {\n\t\tlcc = imx_media_find_ipu_format(code, PIXFMT_SEL_YUV_RGB);\n\t\tif (!lcc)\n\t\t\treturn -EINVAL;\n\t}\n\n\tmbus->code = code;\n\n\tmbus->colorspace = V4L2_COLORSPACE_SRGB;\n\tmbus->xfer_func = V4L2_MAP_XFER_FUNC_DEFAULT(mbus->colorspace);\n\tmbus->ycbcr_enc = V4L2_MAP_YCBCR_ENC_DEFAULT(mbus->colorspace);\n\tmbus->quantization =\n\t\tV4L2_MAP_QUANTIZATION_DEFAULT(lcc->cs == IPUV3_COLORSPACE_RGB,\n\t\t\t\t\t      mbus->colorspace,\n\t\t\t\t\t      mbus->ycbcr_enc);\n\n\tif (cc)\n\t\t*cc = lcc;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(imx_media_init_mbus_fmt);\n\n \nint imx_media_init_cfg(struct v4l2_subdev *sd,\n\t\t       struct v4l2_subdev_state *sd_state)\n{\n\tstruct v4l2_mbus_framefmt *mf_try;\n\tunsigned int pad;\n\tint ret;\n\n\tfor (pad = 0; pad < sd->entity.num_pads; pad++) {\n\t\tstruct v4l2_subdev_format format = {\n\t\t\t.pad = pad,\n\t\t\t.which = V4L2_SUBDEV_FORMAT_ACTIVE,\n\t\t};\n\n\t\tret = v4l2_subdev_call(sd, pad, get_fmt, NULL, &format);\n\t\tif (ret)\n\t\t\tcontinue;\n\n\t\tmf_try = v4l2_subdev_get_try_format(sd, sd_state, pad);\n\t\t*mf_try = format.format;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(imx_media_init_cfg);\n\n \nvoid imx_media_try_colorimetry(struct v4l2_mbus_framefmt *tryfmt,\n\t\t\t       bool ic_route)\n{\n\tconst struct imx_media_pixfmt *cc;\n\tbool is_rgb = false;\n\n\tcc = imx_media_find_mbus_format(tryfmt->code, PIXFMT_SEL_ANY);\n\tif (!cc)\n\t\tcc = imx_media_find_ipu_format(tryfmt->code,\n\t\t\t\t\t       PIXFMT_SEL_YUV_RGB);\n\n\tif (cc && cc->cs == IPUV3_COLORSPACE_RGB)\n\t\tis_rgb = true;\n\n\tswitch (tryfmt->colorspace) {\n\tcase V4L2_COLORSPACE_SMPTE170M:\n\tcase V4L2_COLORSPACE_REC709:\n\tcase V4L2_COLORSPACE_JPEG:\n\tcase V4L2_COLORSPACE_SRGB:\n\tcase V4L2_COLORSPACE_BT2020:\n\tcase V4L2_COLORSPACE_OPRGB:\n\tcase V4L2_COLORSPACE_DCI_P3:\n\tcase V4L2_COLORSPACE_RAW:\n\t\tbreak;\n\tdefault:\n\t\ttryfmt->colorspace = V4L2_COLORSPACE_SRGB;\n\t\tbreak;\n\t}\n\n\tif (tryfmt->xfer_func == V4L2_XFER_FUNC_DEFAULT)\n\t\ttryfmt->xfer_func =\n\t\t\tV4L2_MAP_XFER_FUNC_DEFAULT(tryfmt->colorspace);\n\n\tif (ic_route) {\n\t\tif (tryfmt->ycbcr_enc != V4L2_YCBCR_ENC_601 &&\n\t\t    tryfmt->ycbcr_enc != V4L2_YCBCR_ENC_709)\n\t\t\ttryfmt->ycbcr_enc = V4L2_YCBCR_ENC_601;\n\t} else {\n\t\tif (tryfmt->ycbcr_enc == V4L2_YCBCR_ENC_DEFAULT) {\n\t\t\ttryfmt->ycbcr_enc =\n\t\t\t\tV4L2_MAP_YCBCR_ENC_DEFAULT(tryfmt->colorspace);\n\t\t}\n\t}\n\n\tif (tryfmt->quantization == V4L2_QUANTIZATION_DEFAULT)\n\t\ttryfmt->quantization =\n\t\t\tV4L2_MAP_QUANTIZATION_DEFAULT(is_rgb,\n\t\t\t\t\t\t      tryfmt->colorspace,\n\t\t\t\t\t\t      tryfmt->ycbcr_enc);\n}\nEXPORT_SYMBOL_GPL(imx_media_try_colorimetry);\n\nint imx_media_mbus_fmt_to_pix_fmt(struct v4l2_pix_format *pix,\n\t\t\t\t  const struct v4l2_mbus_framefmt *mbus,\n\t\t\t\t  const struct imx_media_pixfmt *cc)\n{\n\tu32 width;\n\tu32 stride;\n\n\tif (!cc) {\n\t\tcc = imx_media_find_ipu_format(mbus->code,\n\t\t\t\t\t       PIXFMT_SEL_YUV_RGB);\n\t\tif (!cc)\n\t\t\tcc = imx_media_find_mbus_format(mbus->code,\n\t\t\t\t\t\t\tPIXFMT_SEL_ANY);\n\t\tif (!cc)\n\t\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (cc->ipufmt && cc->cs == IPUV3_COLORSPACE_YUV) {\n\t\tu32 code;\n\n\t\timx_media_enum_mbus_formats(&code, 0, PIXFMT_SEL_YUV);\n\t\tcc = imx_media_find_mbus_format(code, PIXFMT_SEL_YUV);\n\t}\n\n\t \n\twidth = round_up(mbus->width, 8);\n\n\t \n\tif (cc->planar)\n\t\tstride = round_up(width, 16);\n\telse\n\t\tstride = round_up((width * cc->bpp) >> 3, 8);\n\n\tpix->width = width;\n\tpix->height = mbus->height;\n\tpix->pixelformat = cc->fourcc;\n\tpix->colorspace = mbus->colorspace;\n\tpix->xfer_func = mbus->xfer_func;\n\tpix->ycbcr_enc = mbus->ycbcr_enc;\n\tpix->quantization = mbus->quantization;\n\tpix->field = mbus->field;\n\tpix->bytesperline = stride;\n\tpix->sizeimage = cc->planar ? ((stride * pix->height * cc->bpp) >> 3) :\n\t\t\t stride * pix->height;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(imx_media_mbus_fmt_to_pix_fmt);\n\nvoid imx_media_free_dma_buf(struct device *dev,\n\t\t\t    struct imx_media_dma_buf *buf)\n{\n\tif (buf->virt)\n\t\tdma_free_coherent(dev, buf->len, buf->virt, buf->phys);\n\n\tbuf->virt = NULL;\n\tbuf->phys = 0;\n}\nEXPORT_SYMBOL_GPL(imx_media_free_dma_buf);\n\nint imx_media_alloc_dma_buf(struct device *dev,\n\t\t\t    struct imx_media_dma_buf *buf,\n\t\t\t    int size)\n{\n\timx_media_free_dma_buf(dev, buf);\n\n\tbuf->len = PAGE_ALIGN(size);\n\tbuf->virt = dma_alloc_coherent(dev, buf->len, &buf->phys,\n\t\t\t\t       GFP_DMA | GFP_KERNEL);\n\tif (!buf->virt) {\n\t\tdev_err(dev, \"%s: failed\\n\", __func__);\n\t\treturn -ENOMEM;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(imx_media_alloc_dma_buf);\n\n \nvoid imx_media_grp_id_to_sd_name(char *sd_name, int sz, u32 grp_id, int ipu_id)\n{\n\tint id;\n\n\tswitch (grp_id) {\n\tcase IMX_MEDIA_GRP_ID_IPU_CSI0...IMX_MEDIA_GRP_ID_IPU_CSI1:\n\t\tid = (grp_id >> IMX_MEDIA_GRP_ID_IPU_CSI_BIT) - 1;\n\t\tsnprintf(sd_name, sz, \"ipu%d_csi%d\", ipu_id + 1, id);\n\t\tbreak;\n\tcase IMX_MEDIA_GRP_ID_IPU_VDIC:\n\t\tsnprintf(sd_name, sz, \"ipu%d_vdic\", ipu_id + 1);\n\t\tbreak;\n\tcase IMX_MEDIA_GRP_ID_IPU_IC_PRP:\n\t\tsnprintf(sd_name, sz, \"ipu%d_ic_prp\", ipu_id + 1);\n\t\tbreak;\n\tcase IMX_MEDIA_GRP_ID_IPU_IC_PRPENC:\n\t\tsnprintf(sd_name, sz, \"ipu%d_ic_prpenc\", ipu_id + 1);\n\t\tbreak;\n\tcase IMX_MEDIA_GRP_ID_IPU_IC_PRPVF:\n\t\tsnprintf(sd_name, sz, \"ipu%d_ic_prpvf\", ipu_id + 1);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_GPL(imx_media_grp_id_to_sd_name);\n\n \nvoid imx_media_add_video_device(struct imx_media_dev *imxmd,\n\t\t\t\tstruct imx_media_video_dev *vdev)\n{\n\tmutex_lock(&imxmd->mutex);\n\n\tlist_add_tail(&vdev->list, &imxmd->vdev_list);\n\n\tmutex_unlock(&imxmd->mutex);\n}\nEXPORT_SYMBOL_GPL(imx_media_add_video_device);\n\n \nstruct media_pad *\nimx_media_pipeline_pad(struct media_entity *start_entity, u32 grp_id,\n\t\t       enum v4l2_buf_type buftype, bool upstream)\n{\n\tstruct media_entity *me = start_entity;\n\tstruct media_pad *pad = NULL;\n\tstruct video_device *vfd;\n\tstruct v4l2_subdev *sd;\n\tint i;\n\n\tfor (i = 0; i < me->num_pads; i++) {\n\t\tstruct media_pad *spad = &me->pads[i];\n\n\t\tif ((upstream && !(spad->flags & MEDIA_PAD_FL_SINK)) ||\n\t\t    (!upstream && !(spad->flags & MEDIA_PAD_FL_SOURCE)))\n\t\t\tcontinue;\n\n\t\tpad = media_pad_remote_pad_first(spad);\n\t\tif (!pad)\n\t\t\tcontinue;\n\n\t\tif (grp_id) {\n\t\t\tif (is_media_entity_v4l2_subdev(pad->entity)) {\n\t\t\t\tsd = media_entity_to_v4l2_subdev(pad->entity);\n\t\t\t\tif (sd->grp_id & grp_id)\n\t\t\t\t\treturn pad;\n\t\t\t}\n\n\t\t\treturn imx_media_pipeline_pad(pad->entity, grp_id,\n\t\t\t\t\t\t      buftype, upstream);\n\t\t} else if (buftype) {\n\t\t\tif (is_media_entity_v4l2_video_device(pad->entity)) {\n\t\t\t\tvfd = media_entity_to_video_device(pad->entity);\n\t\t\t\tif (buftype == vfd->queue->type)\n\t\t\t\t\treturn pad;\n\t\t\t}\n\n\t\t\treturn imx_media_pipeline_pad(pad->entity, grp_id,\n\t\t\t\t\t\t      buftype, upstream);\n\t\t} else {\n\t\t\treturn pad;\n\t\t}\n\t}\n\n\treturn NULL;\n}\nEXPORT_SYMBOL_GPL(imx_media_pipeline_pad);\n\n \nstatic struct media_entity *\nfind_pipeline_entity(struct media_entity *start, u32 grp_id,\n\t\t     enum v4l2_buf_type buftype, bool upstream)\n{\n\tstruct media_pad *pad = NULL;\n\tstruct video_device *vfd;\n\tstruct v4l2_subdev *sd;\n\n\tif (grp_id && is_media_entity_v4l2_subdev(start)) {\n\t\tsd = media_entity_to_v4l2_subdev(start);\n\t\tif (sd->grp_id & grp_id)\n\t\t\treturn &sd->entity;\n\t} else if (buftype && is_media_entity_v4l2_video_device(start)) {\n\t\tvfd = media_entity_to_video_device(start);\n\t\tif (buftype == vfd->queue->type)\n\t\t\treturn &vfd->entity;\n\t}\n\n\tpad = imx_media_pipeline_pad(start, grp_id, buftype, upstream);\n\n\treturn pad ? pad->entity : NULL;\n}\n\n \nstruct v4l2_subdev *\nimx_media_pipeline_subdev(struct media_entity *start_entity, u32 grp_id,\n\t\t\t  bool upstream)\n{\n\tstruct media_entity *me;\n\n\tme = find_pipeline_entity(start_entity, grp_id, 0, upstream);\n\tif (!me)\n\t\treturn ERR_PTR(-ENODEV);\n\n\treturn media_entity_to_v4l2_subdev(me);\n}\nEXPORT_SYMBOL_GPL(imx_media_pipeline_subdev);\n\n \nint imx_media_pipeline_set_stream(struct imx_media_dev *imxmd,\n\t\t\t\t  struct media_entity *entity,\n\t\t\t\t  bool on)\n{\n\tstruct v4l2_subdev *sd;\n\tint ret = 0;\n\n\tif (!is_media_entity_v4l2_subdev(entity))\n\t\treturn -EINVAL;\n\tsd = media_entity_to_v4l2_subdev(entity);\n\n\tmutex_lock(&imxmd->md.graph_mutex);\n\n\tif (on) {\n\t\tret = __media_pipeline_start(entity->pads, &imxmd->pipe);\n\t\tif (ret)\n\t\t\tgoto out;\n\t\tret = v4l2_subdev_call(sd, video, s_stream, 1);\n\t\tif (ret)\n\t\t\t__media_pipeline_stop(entity->pads);\n\t} else {\n\t\tv4l2_subdev_call(sd, video, s_stream, 0);\n\t\tif (media_pad_pipeline(entity->pads))\n\t\t\t__media_pipeline_stop(entity->pads);\n\t}\n\nout:\n\tmutex_unlock(&imxmd->md.graph_mutex);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(imx_media_pipeline_set_stream);\n\nMODULE_DESCRIPTION(\"i.MX5/6 v4l2 media controller driver\");\nMODULE_AUTHOR(\"Steve Longerbeam <steve_longerbeam@mentor.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}