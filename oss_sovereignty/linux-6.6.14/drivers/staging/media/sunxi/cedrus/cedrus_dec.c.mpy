{
  "module_name": "cedrus_dec.c",
  "hash_id": "07d72605718b0be2d682d807845e5c2a4b6af691ef2683e9c15774c1a99f1e69",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/sunxi/cedrus/cedrus_dec.c",
  "human_readable_source": "\n \n\n#include <media/v4l2-device.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-event.h>\n#include <media/v4l2-mem2mem.h>\n\n#include \"cedrus.h\"\n#include \"cedrus_dec.h\"\n#include \"cedrus_hw.h\"\n\nvoid cedrus_device_run(void *priv)\n{\n\tstruct cedrus_ctx *ctx = priv;\n\tstruct cedrus_dev *dev = ctx->dev;\n\tstruct cedrus_run run = {};\n\tstruct media_request *src_req;\n\tint error;\n\n\trun.src = v4l2_m2m_next_src_buf(ctx->fh.m2m_ctx);\n\trun.dst = v4l2_m2m_next_dst_buf(ctx->fh.m2m_ctx);\n\n\t \n\tsrc_req = run.src->vb2_buf.req_obj.req;\n\n\tif (src_req)\n\t\tv4l2_ctrl_request_setup(src_req, &ctx->hdl);\n\n\tswitch (ctx->src_fmt.pixelformat) {\n\tcase V4L2_PIX_FMT_MPEG2_SLICE:\n\t\trun.mpeg2.sequence = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_MPEG2_SEQUENCE);\n\t\trun.mpeg2.picture = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_MPEG2_PICTURE);\n\t\trun.mpeg2.quantisation = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_MPEG2_QUANTISATION);\n\t\tbreak;\n\n\tcase V4L2_PIX_FMT_H264_SLICE:\n\t\trun.h264.decode_params = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_H264_DECODE_PARAMS);\n\t\trun.h264.pps = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_H264_PPS);\n\t\trun.h264.scaling_matrix = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_H264_SCALING_MATRIX);\n\t\trun.h264.slice_params = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_H264_SLICE_PARAMS);\n\t\trun.h264.sps = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_H264_SPS);\n\t\trun.h264.pred_weights = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_H264_PRED_WEIGHTS);\n\t\tbreak;\n\n\tcase V4L2_PIX_FMT_HEVC_SLICE:\n\t\trun.h265.sps = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_HEVC_SPS);\n\t\trun.h265.pps = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_HEVC_PPS);\n\t\trun.h265.slice_params = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_HEVC_SLICE_PARAMS);\n\t\trun.h265.decode_params = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_HEVC_DECODE_PARAMS);\n\t\trun.h265.scaling_matrix = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_HEVC_SCALING_MATRIX);\n\t\trun.h265.entry_points = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_HEVC_ENTRY_POINT_OFFSETS);\n\t\trun.h265.entry_points_count = cedrus_get_num_of_controls(ctx,\n\t\t\tV4L2_CID_STATELESS_HEVC_ENTRY_POINT_OFFSETS);\n\t\tbreak;\n\n\tcase V4L2_PIX_FMT_VP8_FRAME:\n\t\trun.vp8.frame_params = cedrus_find_control_data(ctx,\n\t\t\tV4L2_CID_STATELESS_VP8_FRAME);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tv4l2_m2m_buf_copy_metadata(run.src, run.dst, true);\n\n\tcedrus_dst_format_set(dev, &ctx->dst_fmt);\n\n\terror = ctx->current_codec->setup(ctx, &run);\n\tif (error)\n\t\tv4l2_err(&ctx->dev->v4l2_dev,\n\t\t\t \"Failed to setup decoding job: %d\\n\", error);\n\n\t \n\n\tif (src_req)\n\t\tv4l2_ctrl_request_complete(src_req, &ctx->hdl);\n\n\t \n\tif (!error) {\n\t\t \n\t\tschedule_delayed_work(&dev->watchdog_work,\n\t\t\t\t      msecs_to_jiffies(2000));\n\n\t\tctx->current_codec->trigger(ctx);\n\t} else {\n\t\tv4l2_m2m_buf_done_and_job_finish(ctx->dev->m2m_dev,\n\t\t\t\t\t\t ctx->fh.m2m_ctx,\n\t\t\t\t\t\t VB2_BUF_STATE_ERROR);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}