{
  "module_name": "cedrus_mpeg2.c",
  "hash_id": "1da1c66fd01a9263940dacf45c206f2d324d194d31628b0dba5e8f3f6e6d6f23",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/sunxi/cedrus/cedrus_mpeg2.c",
  "human_readable_source": "\n \n\n#include <media/videobuf2-dma-contig.h>\n\n#include \"cedrus.h\"\n#include \"cedrus_hw.h\"\n#include \"cedrus_regs.h\"\n\nstatic enum cedrus_irq_status cedrus_mpeg2_irq_status(struct cedrus_ctx *ctx)\n{\n\tstruct cedrus_dev *dev = ctx->dev;\n\tu32 reg;\n\n\treg = cedrus_read(dev, VE_DEC_MPEG_STATUS);\n\treg &= VE_DEC_MPEG_STATUS_CHECK_MASK;\n\n\tif (!reg)\n\t\treturn CEDRUS_IRQ_NONE;\n\n\tif (reg & VE_DEC_MPEG_STATUS_CHECK_ERROR ||\n\t    !(reg & VE_DEC_MPEG_STATUS_SUCCESS))\n\t\treturn CEDRUS_IRQ_ERROR;\n\n\treturn CEDRUS_IRQ_OK;\n}\n\nstatic void cedrus_mpeg2_irq_clear(struct cedrus_ctx *ctx)\n{\n\tstruct cedrus_dev *dev = ctx->dev;\n\n\tcedrus_write(dev, VE_DEC_MPEG_STATUS, VE_DEC_MPEG_STATUS_CHECK_MASK);\n}\n\nstatic void cedrus_mpeg2_irq_disable(struct cedrus_ctx *ctx)\n{\n\tstruct cedrus_dev *dev = ctx->dev;\n\tu32 reg = cedrus_read(dev, VE_DEC_MPEG_CTRL);\n\n\treg &= ~VE_DEC_MPEG_CTRL_IRQ_MASK;\n\n\tcedrus_write(dev, VE_DEC_MPEG_CTRL, reg);\n}\n\nstatic int cedrus_mpeg2_setup(struct cedrus_ctx *ctx, struct cedrus_run *run)\n{\n\tconst struct v4l2_ctrl_mpeg2_sequence *seq;\n\tconst struct v4l2_ctrl_mpeg2_picture *pic;\n\tconst struct v4l2_ctrl_mpeg2_quantisation *quantisation;\n\tdma_addr_t src_buf_addr, dst_luma_addr, dst_chroma_addr;\n\tstruct cedrus_dev *dev = ctx->dev;\n\tstruct vb2_queue *vq;\n\tconst u8 *matrix;\n\tunsigned int i;\n\tu32 reg;\n\n\tseq = run->mpeg2.sequence;\n\tpic = run->mpeg2.picture;\n\n\tquantisation = run->mpeg2.quantisation;\n\n\t \n\tcedrus_engine_enable(ctx);\n\n\t \n\tmatrix = quantisation->intra_quantiser_matrix;\n\tfor (i = 0; i < 64; i++) {\n\t\treg = VE_DEC_MPEG_IQMINPUT_WEIGHT(i, matrix[i]);\n\t\treg |= VE_DEC_MPEG_IQMINPUT_FLAG_INTRA;\n\n\t\tcedrus_write(dev, VE_DEC_MPEG_IQMINPUT, reg);\n\t}\n\n\t \n\tmatrix = quantisation->non_intra_quantiser_matrix;\n\tfor (i = 0; i < 64; i++) {\n\t\treg = VE_DEC_MPEG_IQMINPUT_WEIGHT(i, matrix[i]);\n\t\treg |= VE_DEC_MPEG_IQMINPUT_FLAG_NON_INTRA;\n\n\t\tcedrus_write(dev, VE_DEC_MPEG_IQMINPUT, reg);\n\t}\n\n\t \n\n\treg = VE_DEC_MPEG_MP12HDR_SLICE_TYPE(pic->picture_coding_type);\n\treg |= VE_DEC_MPEG_MP12HDR_F_CODE(0, 0, pic->f_code[0][0]);\n\treg |= VE_DEC_MPEG_MP12HDR_F_CODE(0, 1, pic->f_code[0][1]);\n\treg |= VE_DEC_MPEG_MP12HDR_F_CODE(1, 0, pic->f_code[1][0]);\n\treg |= VE_DEC_MPEG_MP12HDR_F_CODE(1, 1, pic->f_code[1][1]);\n\treg |= VE_DEC_MPEG_MP12HDR_INTRA_DC_PRECISION(pic->intra_dc_precision);\n\treg |= VE_DEC_MPEG_MP12HDR_INTRA_PICTURE_STRUCTURE(pic->picture_structure);\n\treg |= VE_DEC_MPEG_MP12HDR_TOP_FIELD_FIRST(pic->flags & V4L2_MPEG2_PIC_FLAG_TOP_FIELD_FIRST);\n\treg |= VE_DEC_MPEG_MP12HDR_FRAME_PRED_FRAME_DCT(pic->flags & V4L2_MPEG2_PIC_FLAG_FRAME_PRED_DCT);\n\treg |= VE_DEC_MPEG_MP12HDR_CONCEALMENT_MOTION_VECTORS(pic->flags & V4L2_MPEG2_PIC_FLAG_CONCEALMENT_MV);\n\treg |= VE_DEC_MPEG_MP12HDR_Q_SCALE_TYPE(pic->flags & V4L2_MPEG2_PIC_FLAG_Q_SCALE_TYPE);\n\treg |= VE_DEC_MPEG_MP12HDR_INTRA_VLC_FORMAT(pic->flags & V4L2_MPEG2_PIC_FLAG_INTRA_VLC);\n\treg |= VE_DEC_MPEG_MP12HDR_ALTERNATE_SCAN(pic->flags & V4L2_MPEG2_PIC_FLAG_ALT_SCAN);\n\treg |= VE_DEC_MPEG_MP12HDR_FULL_PEL_FORWARD_VECTOR(0);\n\treg |= VE_DEC_MPEG_MP12HDR_FULL_PEL_BACKWARD_VECTOR(0);\n\n\tcedrus_write(dev, VE_DEC_MPEG_MP12HDR, reg);\n\n\t \n\n\treg = VE_DEC_MPEG_PICCODEDSIZE_WIDTH(seq->horizontal_size);\n\treg |= VE_DEC_MPEG_PICCODEDSIZE_HEIGHT(seq->vertical_size);\n\n\tcedrus_write(dev, VE_DEC_MPEG_PICCODEDSIZE, reg);\n\n\treg = VE_DEC_MPEG_PICBOUNDSIZE_WIDTH(ctx->src_fmt.width);\n\treg |= VE_DEC_MPEG_PICBOUNDSIZE_HEIGHT(ctx->src_fmt.height);\n\n\tcedrus_write(dev, VE_DEC_MPEG_PICBOUNDSIZE, reg);\n\n\t \n\tvq = v4l2_m2m_get_vq(ctx->fh.m2m_ctx, V4L2_BUF_TYPE_VIDEO_CAPTURE);\n\n\tcedrus_write_ref_buf_addr(ctx, vq, pic->forward_ref_ts,\n\t\t\t\t  VE_DEC_MPEG_FWD_REF_LUMA_ADDR,\n\t\t\t\t  VE_DEC_MPEG_FWD_REF_CHROMA_ADDR);\n\tcedrus_write_ref_buf_addr(ctx, vq, pic->backward_ref_ts,\n\t\t\t\t  VE_DEC_MPEG_BWD_REF_LUMA_ADDR,\n\t\t\t\t  VE_DEC_MPEG_BWD_REF_CHROMA_ADDR);\n\n\t \n\n\tdst_luma_addr = cedrus_dst_buf_addr(ctx, &run->dst->vb2_buf, 0);\n\tdst_chroma_addr = cedrus_dst_buf_addr(ctx, &run->dst->vb2_buf, 1);\n\n\tcedrus_write(dev, VE_DEC_MPEG_REC_LUMA, dst_luma_addr);\n\tcedrus_write(dev, VE_DEC_MPEG_REC_CHROMA, dst_chroma_addr);\n\n\t \n\n\tcedrus_write(dev, VE_DEC_MPEG_VLD_OFFSET, 0);\n\n\treg = vb2_get_plane_payload(&run->src->vb2_buf, 0) * 8;\n\tcedrus_write(dev, VE_DEC_MPEG_VLD_LEN, reg);\n\n\t \n\n\tsrc_buf_addr = vb2_dma_contig_plane_dma_addr(&run->src->vb2_buf, 0);\n\n\treg = VE_DEC_MPEG_VLD_ADDR_BASE(src_buf_addr);\n\treg |= VE_DEC_MPEG_VLD_ADDR_VALID_PIC_DATA;\n\treg |= VE_DEC_MPEG_VLD_ADDR_LAST_PIC_DATA;\n\treg |= VE_DEC_MPEG_VLD_ADDR_FIRST_PIC_DATA;\n\n\tcedrus_write(dev, VE_DEC_MPEG_VLD_ADDR, reg);\n\n\treg = src_buf_addr + vb2_get_plane_payload(&run->src->vb2_buf, 0);\n\tcedrus_write(dev, VE_DEC_MPEG_VLD_END_ADDR, reg);\n\n\t \n\treg = VE_DEC_MPEG_MBADDR_Y(0) | VE_DEC_MPEG_MBADDR_X(0);\n\tcedrus_write(dev, VE_DEC_MPEG_MBADDR, reg);\n\n\t \n\tcedrus_write(dev, VE_DEC_MPEG_ERROR, 0);\n\n\t \n\tcedrus_write(dev, VE_DEC_MPEG_CRTMBADDR, 0);\n\n\t \n\n\treg = VE_DEC_MPEG_CTRL_IRQ_MASK | VE_DEC_MPEG_CTRL_MC_NO_WRITEBACK |\n\t      VE_DEC_MPEG_CTRL_MC_CACHE_EN;\n\n\tcedrus_write(dev, VE_DEC_MPEG_CTRL, reg);\n\n\treturn 0;\n}\n\nstatic void cedrus_mpeg2_trigger(struct cedrus_ctx *ctx)\n{\n\tstruct cedrus_dev *dev = ctx->dev;\n\tu32 reg;\n\n\t \n\treg = VE_DEC_MPEG_TRIGGER_HW_MPEG_VLD | VE_DEC_MPEG_TRIGGER_MPEG2 |\n\t      VE_DEC_MPEG_TRIGGER_MB_BOUNDARY;\n\n\tcedrus_write(dev, VE_DEC_MPEG_TRIGGER, reg);\n}\n\nstruct cedrus_dec_ops cedrus_dec_ops_mpeg2 = {\n\t.irq_clear\t= cedrus_mpeg2_irq_clear,\n\t.irq_disable\t= cedrus_mpeg2_irq_disable,\n\t.irq_status\t= cedrus_mpeg2_irq_status,\n\t.setup\t\t= cedrus_mpeg2_setup,\n\t.trigger\t= cedrus_mpeg2_trigger,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}