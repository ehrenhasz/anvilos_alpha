{
  "module_name": "sun6i_isp_params.c",
  "hash_id": "5d6aaafc9d23298a6d62918770b298ec2a5576f2dd3c9064a961a2b547822fea",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/sunxi/sun6i-isp/sun6i_isp_params.c",
  "human_readable_source": "\n \n\n#include <media/v4l2-device.h>\n#include <media/v4l2-event.h>\n#include <media/v4l2-ioctl.h>\n#include <media/v4l2-mc.h>\n#include <media/videobuf2-vmalloc.h>\n#include <media/videobuf2-v4l2.h>\n\n#include \"sun6i_isp.h\"\n#include \"sun6i_isp_params.h\"\n#include \"sun6i_isp_reg.h\"\n#include \"uapi/sun6i-isp-config.h\"\n\n \n\nstatic const struct sun6i_isp_params_config sun6i_isp_params_config_default = {\n\t.modules_used = SUN6I_ISP_MODULE_BAYER,\n\n\t.bayer = {\n\t\t.offset_r\t= 32,\n\t\t.offset_gr\t= 32,\n\t\t.offset_gb\t= 32,\n\t\t.offset_b\t= 32,\n\n\t\t.gain_r\t\t= 256,\n\t\t.gain_gr\t= 256,\n\t\t.gain_gb\t= 256,\n\t\t.gain_b\t\t= 256,\n\n\t},\n\n\t.bdnf = {\n\t\t.in_dis_min\t\t= 8,\n\t\t.in_dis_max\t\t= 16,\n\n\t\t.coefficients_g\t\t= { 15, 4, 1 },\n\t\t.coefficients_rb\t= { 15, 4 },\n\t},\n};\n\nstatic void sun6i_isp_params_configure_ob(struct sun6i_isp_device *isp_dev)\n{\n\tunsigned int width, height;\n\n\tsun6i_isp_proc_dimensions(isp_dev, &width, &height);\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_OB_SIZE_REG,\n\t\t\t     SUN6I_ISP_OB_SIZE_WIDTH(width) |\n\t\t\t     SUN6I_ISP_OB_SIZE_HEIGHT(height));\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_OB_VALID_REG,\n\t\t\t     SUN6I_ISP_OB_VALID_WIDTH(width) |\n\t\t\t     SUN6I_ISP_OB_VALID_HEIGHT(height));\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_OB_SRC0_VALID_START_REG,\n\t\t\t     SUN6I_ISP_OB_SRC0_VALID_START_HORZ(0) |\n\t\t\t     SUN6I_ISP_OB_SRC0_VALID_START_VERT(0));\n}\n\nstatic void sun6i_isp_params_configure_ae(struct sun6i_isp_device *isp_dev)\n{\n\t \n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_AE_CFG_REG,\n\t\t\t     SUN6I_ISP_AE_CFG_LOW_BRI_TH(0xff) |\n\t\t\t     SUN6I_ISP_AE_CFG_HORZ_NUM(8) |\n\t\t\t     SUN6I_ISP_AE_CFG_HIGH_BRI_TH(0xf00) |\n\t\t\t     SUN6I_ISP_AE_CFG_VERT_NUM(8));\n}\n\nstatic void\nsun6i_isp_params_configure_bayer(struct sun6i_isp_device *isp_dev,\n\t\t\t\t const struct sun6i_isp_params_config *config)\n{\n\tconst struct sun6i_isp_params_config_bayer *bayer = &config->bayer;\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_BAYER_OFFSET0_REG,\n\t\t\t     SUN6I_ISP_BAYER_OFFSET0_R(bayer->offset_r) |\n\t\t\t     SUN6I_ISP_BAYER_OFFSET0_GR(bayer->offset_gr));\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_BAYER_OFFSET1_REG,\n\t\t\t     SUN6I_ISP_BAYER_OFFSET1_GB(bayer->offset_gb) |\n\t\t\t     SUN6I_ISP_BAYER_OFFSET1_B(bayer->offset_b));\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_BAYER_GAIN0_REG,\n\t\t\t     SUN6I_ISP_BAYER_GAIN0_R(bayer->gain_r) |\n\t\t\t     SUN6I_ISP_BAYER_GAIN0_GR(bayer->gain_gr));\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_BAYER_GAIN1_REG,\n\t\t\t     SUN6I_ISP_BAYER_GAIN1_GB(bayer->gain_gb) |\n\t\t\t     SUN6I_ISP_BAYER_GAIN1_B(bayer->gain_b));\n}\n\nstatic void sun6i_isp_params_configure_wb(struct sun6i_isp_device *isp_dev)\n{\n\t \n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_WB_GAIN0_REG,\n\t\t\t     SUN6I_ISP_WB_GAIN0_R(256) |\n\t\t\t     SUN6I_ISP_WB_GAIN0_GR(256));\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_WB_GAIN1_REG,\n\t\t\t     SUN6I_ISP_WB_GAIN1_GB(256) |\n\t\t\t     SUN6I_ISP_WB_GAIN1_B(256));\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_WB_CFG_REG,\n\t\t\t     SUN6I_ISP_WB_CFG_CLIP(0xfff));\n}\n\nstatic void sun6i_isp_params_configure_base(struct sun6i_isp_device *isp_dev)\n{\n\tsun6i_isp_params_configure_ae(isp_dev);\n\tsun6i_isp_params_configure_ob(isp_dev);\n\tsun6i_isp_params_configure_wb(isp_dev);\n}\n\nstatic void\nsun6i_isp_params_configure_bdnf(struct sun6i_isp_device *isp_dev,\n\t\t\t\tconst struct sun6i_isp_params_config *config)\n{\n\tconst struct sun6i_isp_params_config_bdnf *bdnf = &config->bdnf;\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_BDNF_CFG_REG,\n\t\t\t     SUN6I_ISP_BDNF_CFG_IN_DIS_MIN(bdnf->in_dis_min) |\n\t\t\t     SUN6I_ISP_BDNF_CFG_IN_DIS_MAX(bdnf->in_dis_max));\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_BDNF_COEF_RB_REG,\n\t\t\t     SUN6I_ISP_BDNF_COEF_RB(0, bdnf->coefficients_rb[0]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_RB(1, bdnf->coefficients_rb[1]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_RB(2, bdnf->coefficients_rb[2]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_RB(3, bdnf->coefficients_rb[3]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_RB(4, bdnf->coefficients_rb[4]));\n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_BDNF_COEF_G_REG,\n\t\t\t     SUN6I_ISP_BDNF_COEF_G(0, bdnf->coefficients_g[0]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_G(1, bdnf->coefficients_g[1]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_G(2, bdnf->coefficients_g[2]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_G(3, bdnf->coefficients_g[3]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_G(4, bdnf->coefficients_g[4]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_G(5, bdnf->coefficients_g[5]) |\n\t\t\t     SUN6I_ISP_BDNF_COEF_G(6, bdnf->coefficients_g[6]));\n}\n\nstatic void\nsun6i_isp_params_configure_modules(struct sun6i_isp_device *isp_dev,\n\t\t\t\t   const struct sun6i_isp_params_config *config)\n{\n\tu32 value;\n\n\tif (config->modules_used & SUN6I_ISP_MODULE_BDNF)\n\t\tsun6i_isp_params_configure_bdnf(isp_dev, config);\n\n\tif (config->modules_used & SUN6I_ISP_MODULE_BAYER)\n\t\tsun6i_isp_params_configure_bayer(isp_dev, config);\n\n\tvalue = sun6i_isp_load_read(isp_dev, SUN6I_ISP_MODULE_EN_REG);\n\t \n\tvalue &= SUN6I_ISP_MODULE_EN_SRC0 | SUN6I_ISP_MODULE_EN_SRC1;\n\n\tif (config->modules_used & SUN6I_ISP_MODULE_BDNF)\n\t\tvalue |= SUN6I_ISP_MODULE_EN_BDNF;\n\n\t \n\n\tsun6i_isp_load_write(isp_dev, SUN6I_ISP_MODULE_EN_REG, value);\n}\n\nvoid sun6i_isp_params_configure(struct sun6i_isp_device *isp_dev)\n{\n\tstruct sun6i_isp_params_state *state = &isp_dev->params.state;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&state->lock, flags);\n\n\tsun6i_isp_params_configure_base(isp_dev);\n\n\t \n\tif (state->configured)\n\t\tgoto complete;\n\n\tsun6i_isp_params_configure_modules(isp_dev,\n\t\t\t\t\t   &sun6i_isp_params_config_default);\n\n\tstate->configured = true;\n\ncomplete:\n\tspin_unlock_irqrestore(&state->lock, flags);\n}\n\n \n\nstatic void sun6i_isp_params_state_cleanup(struct sun6i_isp_device *isp_dev,\n\t\t\t\t\t   bool error)\n{\n\tstruct sun6i_isp_params_state *state = &isp_dev->params.state;\n\tstruct sun6i_isp_buffer *isp_buffer;\n\tstruct vb2_buffer *vb2_buffer;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&state->lock, flags);\n\n\tif (state->pending) {\n\t\tvb2_buffer = &state->pending->v4l2_buffer.vb2_buf;\n\t\tvb2_buffer_done(vb2_buffer, error ? VB2_BUF_STATE_ERROR :\n\t\t\t\tVB2_BUF_STATE_QUEUED);\n\n\t\tstate->pending = NULL;\n\t}\n\n\tlist_for_each_entry(isp_buffer, &state->queue, list) {\n\t\tvb2_buffer = &isp_buffer->v4l2_buffer.vb2_buf;\n\t\tvb2_buffer_done(vb2_buffer, error ? VB2_BUF_STATE_ERROR :\n\t\t\t\tVB2_BUF_STATE_QUEUED);\n\t}\n\n\tINIT_LIST_HEAD(&state->queue);\n\n\tspin_unlock_irqrestore(&state->lock, flags);\n}\n\nvoid sun6i_isp_params_state_update(struct sun6i_isp_device *isp_dev,\n\t\t\t\t   bool *update)\n{\n\tstruct sun6i_isp_params_state *state = &isp_dev->params.state;\n\tstruct sun6i_isp_buffer *isp_buffer;\n\tstruct vb2_buffer *vb2_buffer;\n\tconst struct sun6i_isp_params_config *config;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&state->lock, flags);\n\n\tif (list_empty(&state->queue))\n\t\tgoto complete;\n\n\tif (state->pending)\n\t\tgoto complete;\n\n\tisp_buffer = list_first_entry(&state->queue, struct sun6i_isp_buffer,\n\t\t\t\t      list);\n\n\tvb2_buffer = &isp_buffer->v4l2_buffer.vb2_buf;\n\tconfig = vb2_plane_vaddr(vb2_buffer, 0);\n\n\tsun6i_isp_params_configure_modules(isp_dev, config);\n\n\tlist_del(&isp_buffer->list);\n\n\tstate->pending = isp_buffer;\n\n\tif (update)\n\t\t*update = true;\n\ncomplete:\n\tspin_unlock_irqrestore(&state->lock, flags);\n}\n\nvoid sun6i_isp_params_state_complete(struct sun6i_isp_device *isp_dev)\n{\n\tstruct sun6i_isp_params_state *state = &isp_dev->params.state;\n\tstruct sun6i_isp_buffer *isp_buffer;\n\tstruct vb2_buffer *vb2_buffer;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&state->lock, flags);\n\n\tif (!state->pending)\n\t\tgoto complete;\n\n\tisp_buffer = state->pending;\n\tvb2_buffer = &isp_buffer->v4l2_buffer.vb2_buf;\n\n\tvb2_buffer->timestamp = ktime_get_ns();\n\n\t \n\tisp_buffer->v4l2_buffer.sequence = isp_dev->capture.state.sequence + 1;\n\n\tvb2_buffer_done(vb2_buffer, VB2_BUF_STATE_DONE);\n\n\tstate->pending = NULL;\n\ncomplete:\n\tspin_unlock_irqrestore(&state->lock, flags);\n}\n\n \n\nstatic int sun6i_isp_params_queue_setup(struct vb2_queue *queue,\n\t\t\t\t\tunsigned int *buffers_count,\n\t\t\t\t\tunsigned int *planes_count,\n\t\t\t\t\tunsigned int sizes[],\n\t\t\t\t\tstruct device *alloc_devs[])\n{\n\tstruct sun6i_isp_device *isp_dev = vb2_get_drv_priv(queue);\n\tunsigned int size = isp_dev->params.format.fmt.meta.buffersize;\n\n\tif (*planes_count)\n\t\treturn sizes[0] < size ? -EINVAL : 0;\n\n\t*planes_count = 1;\n\tsizes[0] = size;\n\n\treturn 0;\n}\n\nstatic int sun6i_isp_params_buffer_prepare(struct vb2_buffer *vb2_buffer)\n{\n\tstruct sun6i_isp_device *isp_dev =\n\t\tvb2_get_drv_priv(vb2_buffer->vb2_queue);\n\tstruct v4l2_device *v4l2_dev = &isp_dev->v4l2.v4l2_dev;\n\tunsigned int size = isp_dev->params.format.fmt.meta.buffersize;\n\n\tif (vb2_plane_size(vb2_buffer, 0) < size) {\n\t\tv4l2_err(v4l2_dev, \"buffer too small (%lu < %u)\\n\",\n\t\t\t vb2_plane_size(vb2_buffer, 0), size);\n\t\treturn -EINVAL;\n\t}\n\n\tvb2_set_plane_payload(vb2_buffer, 0, size);\n\n\treturn 0;\n}\n\nstatic void sun6i_isp_params_buffer_queue(struct vb2_buffer *vb2_buffer)\n{\n\tstruct sun6i_isp_device *isp_dev =\n\t\tvb2_get_drv_priv(vb2_buffer->vb2_queue);\n\tstruct sun6i_isp_params_state *state = &isp_dev->params.state;\n\tstruct vb2_v4l2_buffer *v4l2_buffer = to_vb2_v4l2_buffer(vb2_buffer);\n\tstruct sun6i_isp_buffer *isp_buffer =\n\t\tcontainer_of(v4l2_buffer, struct sun6i_isp_buffer, v4l2_buffer);\n\tbool capture_streaming = isp_dev->capture.state.streaming;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&state->lock, flags);\n\tlist_add_tail(&isp_buffer->list, &state->queue);\n\tspin_unlock_irqrestore(&state->lock, flags);\n\n\tif (state->streaming && capture_streaming)\n\t\tsun6i_isp_state_update(isp_dev, false);\n}\n\nstatic int sun6i_isp_params_start_streaming(struct vb2_queue *queue,\n\t\t\t\t\t    unsigned int count)\n{\n\tstruct sun6i_isp_device *isp_dev = vb2_get_drv_priv(queue);\n\tstruct sun6i_isp_params_state *state = &isp_dev->params.state;\n\tbool capture_streaming = isp_dev->capture.state.streaming;\n\n\tstate->streaming = true;\n\n\t \n\n\tif (capture_streaming)\n\t\tsun6i_isp_state_update(isp_dev, false);\n\n\treturn 0;\n}\n\nstatic void sun6i_isp_params_stop_streaming(struct vb2_queue *queue)\n{\n\tstruct sun6i_isp_device *isp_dev = vb2_get_drv_priv(queue);\n\tstruct sun6i_isp_params_state *state = &isp_dev->params.state;\n\n\tstate->streaming = false;\n\tsun6i_isp_params_state_cleanup(isp_dev, true);\n}\n\nstatic const struct vb2_ops sun6i_isp_params_queue_ops = {\n\t.queue_setup\t\t= sun6i_isp_params_queue_setup,\n\t.buf_prepare\t\t= sun6i_isp_params_buffer_prepare,\n\t.buf_queue\t\t= sun6i_isp_params_buffer_queue,\n\t.start_streaming\t= sun6i_isp_params_start_streaming,\n\t.stop_streaming\t\t= sun6i_isp_params_stop_streaming,\n\t.wait_prepare\t\t= vb2_ops_wait_prepare,\n\t.wait_finish\t\t= vb2_ops_wait_finish,\n};\n\n \n\nstatic int sun6i_isp_params_querycap(struct file *file, void *private,\n\t\t\t\t     struct v4l2_capability *capability)\n{\n\tstruct sun6i_isp_device *isp_dev = video_drvdata(file);\n\tstruct video_device *video_dev = &isp_dev->params.video_dev;\n\n\tstrscpy(capability->driver, SUN6I_ISP_NAME, sizeof(capability->driver));\n\tstrscpy(capability->card, video_dev->name, sizeof(capability->card));\n\tsnprintf(capability->bus_info, sizeof(capability->bus_info),\n\t\t \"platform:%s\", dev_name(isp_dev->dev));\n\n\treturn 0;\n}\n\nstatic int sun6i_isp_params_enum_fmt(struct file *file, void *private,\n\t\t\t\t     struct v4l2_fmtdesc *fmtdesc)\n{\n\tstruct sun6i_isp_device *isp_dev = video_drvdata(file);\n\tstruct v4l2_meta_format *params_format =\n\t\t&isp_dev->params.format.fmt.meta;\n\n\tif (fmtdesc->index > 0)\n\t\treturn -EINVAL;\n\n\tfmtdesc->pixelformat = params_format->dataformat;\n\n\treturn 0;\n}\n\nstatic int sun6i_isp_params_g_fmt(struct file *file, void *private,\n\t\t\t\t  struct v4l2_format *format)\n{\n\tstruct sun6i_isp_device *isp_dev = video_drvdata(file);\n\n\t*format = isp_dev->params.format;\n\n\treturn 0;\n}\n\nstatic const struct v4l2_ioctl_ops sun6i_isp_params_ioctl_ops = {\n\t.vidioc_querycap\t\t= sun6i_isp_params_querycap,\n\n\t.vidioc_enum_fmt_meta_out\t= sun6i_isp_params_enum_fmt,\n\t.vidioc_g_fmt_meta_out\t\t= sun6i_isp_params_g_fmt,\n\t.vidioc_s_fmt_meta_out\t\t= sun6i_isp_params_g_fmt,\n\t.vidioc_try_fmt_meta_out\t= sun6i_isp_params_g_fmt,\n\n\t.vidioc_create_bufs\t\t= vb2_ioctl_create_bufs,\n\t.vidioc_prepare_buf\t\t= vb2_ioctl_prepare_buf,\n\t.vidioc_reqbufs\t\t\t= vb2_ioctl_reqbufs,\n\t.vidioc_querybuf\t\t= vb2_ioctl_querybuf,\n\t.vidioc_expbuf\t\t\t= vb2_ioctl_expbuf,\n\t.vidioc_qbuf\t\t\t= vb2_ioctl_qbuf,\n\t.vidioc_dqbuf\t\t\t= vb2_ioctl_dqbuf,\n\t.vidioc_streamon\t\t= vb2_ioctl_streamon,\n\t.vidioc_streamoff\t\t= vb2_ioctl_streamoff,\n};\n\nstatic const struct v4l2_file_operations sun6i_isp_params_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.unlocked_ioctl\t= video_ioctl2,\n\t.open\t\t= v4l2_fh_open,\n\t.release\t= vb2_fop_release,\n\t.mmap\t\t= vb2_fop_mmap,\n\t.poll\t\t= vb2_fop_poll,\n};\n\n \n\nint sun6i_isp_params_setup(struct sun6i_isp_device *isp_dev)\n{\n\tstruct sun6i_isp_params *params = &isp_dev->params;\n\tstruct sun6i_isp_params_state *state = &params->state;\n\tstruct v4l2_device *v4l2_dev = &isp_dev->v4l2.v4l2_dev;\n\tstruct v4l2_subdev *proc_subdev = &isp_dev->proc.subdev;\n\tstruct video_device *video_dev = &params->video_dev;\n\tstruct vb2_queue *queue = &isp_dev->params.queue;\n\tstruct media_pad *pad = &isp_dev->params.pad;\n\tstruct v4l2_format *format = &isp_dev->params.format;\n\tstruct v4l2_meta_format *params_format = &format->fmt.meta;\n\tint ret;\n\n\t \n\n\tINIT_LIST_HEAD(&state->queue);\n\tspin_lock_init(&state->lock);\n\n\t \n\n\tpad->flags = MEDIA_PAD_FL_SOURCE | MEDIA_PAD_FL_MUST_CONNECT;\n\n\tret = media_entity_pads_init(&video_dev->entity, 1, pad);\n\tif (ret)\n\t\tgoto error_mutex;\n\n\t \n\n\tmutex_init(&params->lock);\n\n\tqueue->type = V4L2_BUF_TYPE_META_OUTPUT;\n\tqueue->io_modes = VB2_MMAP | VB2_USERPTR | VB2_DMABUF;\n\tqueue->buf_struct_size = sizeof(struct sun6i_isp_buffer);\n\tqueue->ops = &sun6i_isp_params_queue_ops;\n\tqueue->mem_ops = &vb2_vmalloc_memops;\n\tqueue->min_buffers_needed = 1;\n\tqueue->timestamp_flags = V4L2_BUF_FLAG_TIMESTAMP_MONOTONIC;\n\tqueue->lock = &params->lock;\n\tqueue->dev = isp_dev->dev;\n\tqueue->drv_priv = isp_dev;\n\n\tret = vb2_queue_init(queue);\n\tif (ret) {\n\t\tv4l2_err(v4l2_dev, \"failed to initialize vb2 queue: %d\\n\", ret);\n\t\tgoto error_media_entity;\n\t}\n\n\t \n\n\tformat->type = queue->type;\n\tparams_format->dataformat = V4L2_META_FMT_SUN6I_ISP_PARAMS;\n\tparams_format->buffersize = sizeof(struct sun6i_isp_params_config);\n\n\t \n\n\tstrscpy(video_dev->name, SUN6I_ISP_PARAMS_NAME,\n\t\tsizeof(video_dev->name));\n\tvideo_dev->device_caps = V4L2_CAP_META_OUTPUT | V4L2_CAP_STREAMING;\n\tvideo_dev->vfl_dir = VFL_DIR_TX;\n\tvideo_dev->release = video_device_release_empty;\n\tvideo_dev->fops = &sun6i_isp_params_fops;\n\tvideo_dev->ioctl_ops = &sun6i_isp_params_ioctl_ops;\n\tvideo_dev->v4l2_dev = v4l2_dev;\n\tvideo_dev->queue = queue;\n\tvideo_dev->lock = &params->lock;\n\n\tvideo_set_drvdata(video_dev, isp_dev);\n\n\tret = video_register_device(video_dev, VFL_TYPE_VIDEO, -1);\n\tif (ret) {\n\t\tv4l2_err(v4l2_dev, \"failed to register video device: %d\\n\",\n\t\t\t ret);\n\t\tgoto error_media_entity;\n\t}\n\n\t \n\n\tret = media_create_pad_link(&video_dev->entity, 0,\n\t\t\t\t    &proc_subdev->entity,\n\t\t\t\t    SUN6I_ISP_PROC_PAD_SINK_PARAMS,\n\t\t\t\t    MEDIA_LNK_FL_ENABLED |\n\t\t\t\t    MEDIA_LNK_FL_IMMUTABLE);\n\tif (ret < 0) {\n\t\tv4l2_err(v4l2_dev, \"failed to create %s:%u -> %s:%u link\\n\",\n\t\t\t video_dev->entity.name, 0, proc_subdev->entity.name,\n\t\t\t SUN6I_ISP_PROC_PAD_SINK_PARAMS);\n\t\tgoto error_video_device;\n\t}\n\n\treturn 0;\n\nerror_video_device:\n\tvb2_video_unregister_device(video_dev);\n\nerror_media_entity:\n\tmedia_entity_cleanup(&video_dev->entity);\n\nerror_mutex:\n\tmutex_destroy(&params->lock);\n\n\treturn ret;\n}\n\nvoid sun6i_isp_params_cleanup(struct sun6i_isp_device *isp_dev)\n{\n\tstruct sun6i_isp_params *params = &isp_dev->params;\n\tstruct video_device *video_dev = &params->video_dev;\n\n\tvb2_video_unregister_device(video_dev);\n\tmedia_entity_cleanup(&video_dev->entity);\n\tmutex_destroy(&params->lock);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}