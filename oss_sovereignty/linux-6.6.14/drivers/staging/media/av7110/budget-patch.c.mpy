{
  "module_name": "budget-patch.c",
  "hash_id": "ba9cb15c30c0cd01c6934ba2201c654da64bf859df842a74ac99ef88ab6e38ca",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/av7110/budget-patch.c",
  "human_readable_source": "\n \n\n#include \"av7110.h\"\n#include \"av7110_hw.h\"\n#include \"budget.h\"\n#include \"stv0299.h\"\n#include \"ves1x93.h\"\n#include \"tda8083.h\"\n\n#include \"bsru6.h\"\n\nDVB_DEFINE_MOD_OPT_ADAPTER_NR(adapter_nr);\n\n#define budget_patch budget\n\nstatic struct saa7146_extension budget_extension;\n\nMAKE_BUDGET_INFO(ttbp, \"TT-Budget/Patch DVB-S 1.x PCI\", BUDGET_PATCH);\n \n\nstatic const struct pci_device_id pci_tbl[] = {\n\tMAKE_EXTENSION_PCI(ttbp,0x13c2, 0x0000),\n \n\t{\n\t\t.vendor    = 0,\n\t}\n};\n\n \nstatic void gpio_Set22K (struct budget *budget, int state)\n{\n\tstruct saa7146_dev *dev=budget->dev;\n\tdprintk(2, \"budget: %p\\n\", budget);\n\tsaa7146_setgpio(dev, 3, (state ? SAA7146_GPIO_OUTHI : SAA7146_GPIO_OUTLO));\n}\n\n \n \n\nstatic void DiseqcSendBit (struct budget *budget, int data)\n{\n\tstruct saa7146_dev *dev=budget->dev;\n\tdprintk(2, \"budget: %p\\n\", budget);\n\n\tsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTHI);\n\tudelay(data ? 500 : 1000);\n\tsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\n\tudelay(data ? 1000 : 500);\n}\n\nstatic void DiseqcSendByte (struct budget *budget, int data)\n{\n\tint i, par=1, d;\n\n\tdprintk(2, \"budget: %p\\n\", budget);\n\n\tfor (i=7; i>=0; i--) {\n\t\td = (data>>i)&1;\n\t\tpar ^= d;\n\t\tDiseqcSendBit(budget, d);\n\t}\n\n\tDiseqcSendBit(budget, par);\n}\n\nstatic int SendDiSEqCMsg (struct budget *budget, int len, u8 *msg, unsigned long burst)\n{\n\tstruct saa7146_dev *dev=budget->dev;\n\tint i;\n\n\tdprintk(2, \"budget: %p\\n\", budget);\n\n\tsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\n\tmdelay(16);\n\n\tfor (i=0; i<len; i++)\n\t\tDiseqcSendByte(budget, msg[i]);\n\n\tmdelay(16);\n\n\tif (burst!=-1) {\n\t\tif (burst)\n\t\t\tDiseqcSendByte(budget, 0xff);\n\t\telse {\n\t\t\tsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTHI);\n\t\t\tmdelay(12);\n\t\t\tudelay(500);\n\t\t\tsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\n\t\t}\n\t\tmsleep(20);\n\t}\n\n\treturn 0;\n}\n\n \nstatic int budget_set_tone(struct dvb_frontend *fe,\n\t\t\t   enum fe_sec_tone_mode tone)\n{\n\tstruct budget* budget = (struct budget*) fe->dvb->priv;\n\n\tswitch (tone) {\n\tcase SEC_TONE_ON:\n\t\tgpio_Set22K (budget, 1);\n\t\tbreak;\n\n\tcase SEC_TONE_OFF:\n\t\tgpio_Set22K (budget, 0);\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int budget_diseqc_send_master_cmd(struct dvb_frontend* fe, struct dvb_diseqc_master_cmd* cmd)\n{\n\tstruct budget* budget = (struct budget*) fe->dvb->priv;\n\n\tSendDiSEqCMsg (budget, cmd->msg_len, cmd->msg, 0);\n\n\treturn 0;\n}\n\nstatic int budget_diseqc_send_burst(struct dvb_frontend *fe,\n\t\t\t\t    enum fe_sec_mini_cmd minicmd)\n{\n\tstruct budget* budget = (struct budget*) fe->dvb->priv;\n\n\tSendDiSEqCMsg (budget, 0, NULL, minicmd);\n\n\treturn 0;\n}\n\nstatic int budget_av7110_send_fw_cmd(struct budget_patch *budget, u16* buf, int length)\n{\n\tint i;\n\n\tdprintk(2, \"budget: %p\\n\", budget);\n\n\tfor (i = 2; i < length; i++)\n\t{\n\t\t  ttpci_budget_debiwrite(budget, DEBINOSWAP, COMMAND + 2*i, 2, (u32) buf[i], 0,0);\n\t\t  msleep(5);\n\t}\n\tif (length)\n\t\t  ttpci_budget_debiwrite(budget, DEBINOSWAP, COMMAND + 2, 2, (u32) buf[1], 0,0);\n\telse\n\t\t  ttpci_budget_debiwrite(budget, DEBINOSWAP, COMMAND + 2, 2, 0, 0,0);\n\tmsleep(5);\n\tttpci_budget_debiwrite(budget, DEBINOSWAP, COMMAND, 2, (u32) buf[0], 0,0);\n\tmsleep(5);\n\treturn 0;\n}\n\nstatic void av7110_set22k(struct budget_patch *budget, int state)\n{\n\tu16 buf[2] = {( COMTYPE_AUDIODAC << 8) | (state ? ON22K : OFF22K), 0};\n\n\tdprintk(2, \"budget: %p\\n\", budget);\n\tbudget_av7110_send_fw_cmd(budget, buf, 2);\n}\n\nstatic int av7110_send_diseqc_msg(struct budget_patch *budget, int len, u8 *msg, int burst)\n{\n\tint i;\n\tu16 buf[18] = { ((COMTYPE_AUDIODAC << 8) | SendDiSEqC),\n\t\t16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };\n\n\tdprintk(2, \"budget: %p\\n\", budget);\n\n\tif (len>10)\n\t\tlen=10;\n\n\tbuf[1] = len+2;\n\tbuf[2] = len;\n\n\tif (burst != -1)\n\t\tbuf[3]=burst ? 0x01 : 0x00;\n\telse\n\t\tbuf[3]=0xffff;\n\n\tfor (i=0; i<len; i++)\n\t\tbuf[i+4]=msg[i];\n\n\tbudget_av7110_send_fw_cmd(budget, buf, 18);\n\treturn 0;\n}\n\nstatic int budget_patch_set_tone(struct dvb_frontend *fe,\n\t\t\t\t enum fe_sec_tone_mode tone)\n{\n\tstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\n\n\tswitch (tone) {\n\tcase SEC_TONE_ON:\n\t\tav7110_set22k (budget, 1);\n\t\tbreak;\n\n\tcase SEC_TONE_OFF:\n\t\tav7110_set22k (budget, 0);\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int budget_patch_diseqc_send_master_cmd(struct dvb_frontend* fe, struct dvb_diseqc_master_cmd* cmd)\n{\n\tstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\n\n\tav7110_send_diseqc_msg (budget, cmd->msg_len, cmd->msg, 0);\n\n\treturn 0;\n}\n\nstatic int budget_patch_diseqc_send_burst(struct dvb_frontend *fe,\n\t\t\t\t\t  enum fe_sec_mini_cmd minicmd)\n{\n\tstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\n\n\tav7110_send_diseqc_msg (budget, 0, NULL, minicmd);\n\n\treturn 0;\n}\n\nstatic int alps_bsrv2_tuner_set_params(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\tstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\n\tu8 pwr = 0;\n\tu8 buf[4];\n\tstruct i2c_msg msg = { .addr = 0x61, .flags = 0, .buf = buf, .len = sizeof(buf) };\n\tu32 div = (p->frequency + 479500) / 125;\n\n\tif (p->frequency > 2000000)\n\t\tpwr = 3;\n\telse if (p->frequency > 1800000)\n\t\tpwr = 2;\n\telse if (p->frequency > 1600000)\n\t\tpwr = 1;\n\telse if (p->frequency > 1200000)\n\t\tpwr = 0;\n\telse if (p->frequency >= 1100000)\n\t\tpwr = 1;\n\telse pwr = 2;\n\n\tbuf[0] = (div >> 8) & 0x7f;\n\tbuf[1] = div & 0xff;\n\tbuf[2] = ((div & 0x18000) >> 10) | 0x95;\n\tbuf[3] = (pwr << 6) | 0x30;\n\n\t \n\t\n\n\tif (fe->ops.i2c_gate_ctrl)\n\t\tfe->ops.i2c_gate_ctrl(fe, 1);\n\tif (i2c_transfer (&budget->i2c_adap, &msg, 1) != 1)\n\t\treturn -EIO;\n\treturn 0;\n}\n\nstatic struct ves1x93_config alps_bsrv2_config = {\n\t.demod_address = 0x08,\n\t.xin = 90100000UL,\n\t.invert_pwm = 0,\n};\n\nstatic int grundig_29504_451_tuner_set_params(struct dvb_frontend *fe)\n{\n\tstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\n\tstruct budget_patch* budget = (struct budget_patch*) fe->dvb->priv;\n\tu32 div;\n\tu8 data[4];\n\tstruct i2c_msg msg = { .addr = 0x61, .flags = 0, .buf = data, .len = sizeof(data) };\n\n\tdiv = p->frequency / 125;\n\tdata[0] = (div >> 8) & 0x7f;\n\tdata[1] = div & 0xff;\n\tdata[2] = 0x8e;\n\tdata[3] = 0x00;\n\n\tif (fe->ops.i2c_gate_ctrl)\n\t\tfe->ops.i2c_gate_ctrl(fe, 1);\n\tif (i2c_transfer (&budget->i2c_adap, &msg, 1) != 1)\n\t\treturn -EIO;\n\treturn 0;\n}\n\nstatic struct tda8083_config grundig_29504_451_config = {\n\t.demod_address = 0x68,\n};\n\nstatic void frontend_init(struct budget_patch* budget)\n{\n\tswitch(budget->dev->pci->subsystem_device) {\n\tcase 0x0000: \n\tcase 0x1013: \n\n\t\t\n\t\tbudget->dvb_frontend = dvb_attach(ves1x93_attach, &alps_bsrv2_config, &budget->i2c_adap);\n\t\tif (budget->dvb_frontend) {\n\t\t\tbudget->dvb_frontend->ops.tuner_ops.set_params = alps_bsrv2_tuner_set_params;\n\t\t\tbudget->dvb_frontend->ops.diseqc_send_master_cmd = budget_patch_diseqc_send_master_cmd;\n\t\t\tbudget->dvb_frontend->ops.diseqc_send_burst = budget_patch_diseqc_send_burst;\n\t\t\tbudget->dvb_frontend->ops.set_tone = budget_patch_set_tone;\n\t\t\tbreak;\n\t\t}\n\n\t\t\n\t\tbudget->dvb_frontend = dvb_attach(stv0299_attach, &alps_bsru6_config, &budget->i2c_adap);\n\t\tif (budget->dvb_frontend) {\n\t\t\tbudget->dvb_frontend->ops.tuner_ops.set_params = alps_bsru6_tuner_set_params;\n\t\t\tbudget->dvb_frontend->tuner_priv = &budget->i2c_adap;\n\n\t\t\tbudget->dvb_frontend->ops.diseqc_send_master_cmd = budget_diseqc_send_master_cmd;\n\t\t\tbudget->dvb_frontend->ops.diseqc_send_burst = budget_diseqc_send_burst;\n\t\t\tbudget->dvb_frontend->ops.set_tone = budget_set_tone;\n\t\t\tbreak;\n\t\t}\n\n\t\t\n\t\tbudget->dvb_frontend = dvb_attach(tda8083_attach, &grundig_29504_451_config, &budget->i2c_adap);\n\t\tif (budget->dvb_frontend) {\n\t\t\tbudget->dvb_frontend->ops.tuner_ops.set_params = grundig_29504_451_tuner_set_params;\n\t\t\tbudget->dvb_frontend->ops.diseqc_send_master_cmd = budget_diseqc_send_master_cmd;\n\t\t\tbudget->dvb_frontend->ops.diseqc_send_burst = budget_diseqc_send_burst;\n\t\t\tbudget->dvb_frontend->ops.set_tone = budget_set_tone;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\t}\n\n\tif (budget->dvb_frontend == NULL) {\n\t\tprintk(\"dvb-ttpci: A frontend driver was not found for device [%04x:%04x] subsystem [%04x:%04x]\\n\",\n\t\t       budget->dev->pci->vendor,\n\t\t       budget->dev->pci->device,\n\t\t       budget->dev->pci->subsystem_vendor,\n\t\t       budget->dev->pci->subsystem_device);\n\t} else {\n\t\tif (dvb_register_frontend(&budget->dvb_adapter, budget->dvb_frontend)) {\n\t\t\tprintk(\"budget-av: Frontend registration failed!\\n\");\n\t\t\tdvb_frontend_detach(budget->dvb_frontend);\n\t\t\tbudget->dvb_frontend = NULL;\n\t\t}\n\t}\n}\n\n \nstatic int budget_patch_attach (struct saa7146_dev* dev, struct saa7146_pci_extension_data *info)\n{\n\tstruct budget_patch *budget;\n\tint err;\n\tint count = 0;\n\tint detected = 0;\n\n#define PATCH_RESET 0\n#define RPS_IRQ 0\n#define HPS_SETUP 0\n#if PATCH_RESET\n\tsaa7146_write(dev, MC1, MASK_31);\n\tmsleep(40);\n#endif\n#if HPS_SETUP\n\t\n\t\n\tsaa7146_write(dev, DD1_STREAM_B, 0);\n\t\n\tsaa7146_write(dev, DD1_INIT, 0x00000200);  \n\tsaa7146_write(dev, BRS_CTRL, 0x00000000);  \n\n\t\n\t\n\n\t\n\tsaa7146_write(dev, HPS_H_PRESCALE, 0);                  \n\tsaa7146_write(dev, HPS_H_SCALE, 0);                     \n\tsaa7146_write(dev, BCS_CTRL, 0);                        \n\tsaa7146_write(dev, HPS_V_SCALE, 0);                     \n\tsaa7146_write(dev, HPS_V_GAIN, 0);                      \n\tsaa7146_write(dev, CHROMA_KEY_RANGE, 0);                \n\tsaa7146_write(dev, CLIP_FORMAT_CTRL, 0);                \n\t\n\tsaa7146_write(dev, HPS_CTRL, (1<<30) | (0<<29) | (1<<28) | (0<<12) );\n\tsaa7146_write(dev, MC2,\n\t  0 * (MASK_08 | MASK_24)  |   \n\t  0 * (MASK_09 | MASK_25)  |   \n\t  0 * (MASK_10 | MASK_26)  |   \n\t  1 * (MASK_06 | MASK_22)  |   \n\t  1 * (MASK_05 | MASK_21)  |   \n\t  0 * (MASK_01 | MASK_15)      \n\t   );\n#endif\n\t\n\tsaa7146_write(dev, MC1, ( MASK_29 | MASK_28));\n\t\n\tsaa7146_write(dev, RPS_TOV1, 0);\n\n\t\n\t\n\t\n\t\n\t\n\t\n\tcount = 0;\n#if 0\n\tWRITE_RPS1(CMD_UPLOAD |\n\t  MASK_10 | MASK_09 | MASK_08 | MASK_06 | MASK_05 | MASK_04 | MASK_03 | MASK_02 );\n#endif\n\tWRITE_RPS1(CMD_PAUSE | EVT_VBI_B);\n\tWRITE_RPS1(CMD_WR_REG_MASK | (GPIO_CTRL>>2));\n\tWRITE_RPS1(GPIO3_MSK);\n\tWRITE_RPS1(SAA7146_GPIO_OUTLO<<24);\n#if RPS_IRQ\n\t\n\tWRITE_RPS1(CMD_INTERRUPT);\n\t\n\tWRITE_RPS1(CMD_NOP);\n\t\n\tWRITE_RPS1(CMD_INTERRUPT);\n#endif\n\tWRITE_RPS1(CMD_STOP);\n\n#if RPS_IRQ\n\t\n\t\n\t\n\tsaa7146_write(dev, EC1SSR, (0x03<<2) | 3 );\n\t\n\tsaa7146_write(dev, ECT1R,  0x3fff );\n#endif\n\t\n\tsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\n\t\n\tsaa7146_write(dev, RPS_ADDR1, dev->d_rps1.dma_handle);\n\t\n\tsaa7146_write(dev, MC1, (MASK_13 | MASK_29 ));\n\n\n\tmdelay(50);\n\tsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTHI);\n\tmdelay(150);\n\n\n\tif( (saa7146_read(dev, GPIO_CTRL) & 0x10000000) == 0)\n\t\tdetected = 1;\n\n#if RPS_IRQ\n\tprintk(\"Event Counter 1 0x%04x\\n\", saa7146_read(dev, EC1R) & 0x3fff );\n#endif\n\t\n\tsaa7146_write(dev, MC1, ( MASK_29 ));\n\n\tif(detected == 0)\n\t\tprintk(\"budget-patch not detected or saa7146 in non-default state.\\n\"\n\t\t       \"try enabling resetting of 7146 with MASK_31 in MC1 register\\n\");\n\n\telse\n\t\tprintk(\"BUDGET-PATCH DETECTED.\\n\");\n\n\n \n\n \n\n\t\n\tcount = 0;\n\n\n\t\n\tWRITE_RPS1(CMD_PAUSE | EVT_HS);\n\t\n\tWRITE_RPS1(CMD_WR_REG_MASK | (GPIO_CTRL>>2));\n\tWRITE_RPS1(GPIO3_MSK);\n\tWRITE_RPS1(SAA7146_GPIO_OUTHI<<24);\n#if RPS_IRQ\n\t\n\tWRITE_RPS1(CMD_INTERRUPT);\n#endif\n\t\n\tWRITE_RPS1(CMD_PAUSE | RPS_INV | EVT_HS);\n\t\n\tWRITE_RPS1(CMD_WR_REG_MASK | (GPIO_CTRL>>2));\n\tWRITE_RPS1(GPIO3_MSK);\n\tWRITE_RPS1(SAA7146_GPIO_OUTLO<<24);\n#if RPS_IRQ\n\t\n\tWRITE_RPS1(CMD_INTERRUPT);\n#endif\n\t\n\tWRITE_RPS1(CMD_JUMP);\n\tWRITE_RPS1(dev->d_rps1.dma_handle);\n\n\t\n\tsaa7146_setgpio(dev, 3, SAA7146_GPIO_OUTLO);\n\t\n\tsaa7146_write(dev, RPS_ADDR1, dev->d_rps1.dma_handle);\n\n\tif (!(budget = kmalloc (sizeof(struct budget_patch), GFP_KERNEL)))\n\t\treturn -ENOMEM;\n\n\tdprintk(2, \"budget: %p\\n\", budget);\n\n\terr = ttpci_budget_init(budget, dev, info, THIS_MODULE, adapter_nr);\n\tif (err) {\n\t\tkfree(budget);\n\t\treturn err;\n\t}\n\n\t\n\t\n\t\n\t\n\t\n\t\n\t\n\t\n\tsaa7146_write(dev, RPS_THRESH1, budget->buffer_height | MASK_12 );\n\n\t\n\t\n\tsaa7146_write(dev, MC1, (MASK_13 | MASK_29));\n\n\n\tdev->ext_priv = budget;\n\n\tbudget->dvb_adapter.priv = budget;\n\tfrontend_init(budget);\n\n\tttpci_budget_init_hooks(budget);\n\n\treturn 0;\n}\n\nstatic int budget_patch_detach (struct saa7146_dev* dev)\n{\n\tstruct budget_patch *budget = (struct budget_patch*) dev->ext_priv;\n\tint err;\n\n\tif (budget->dvb_frontend) {\n\t\tdvb_unregister_frontend(budget->dvb_frontend);\n\t\tdvb_frontend_detach(budget->dvb_frontend);\n\t}\n\terr = ttpci_budget_deinit (budget);\n\n\tkfree (budget);\n\n\treturn err;\n}\n\nstatic int __init budget_patch_init(void)\n{\n\treturn saa7146_register_extension(&budget_extension);\n}\n\nstatic void __exit budget_patch_exit(void)\n{\n\tsaa7146_unregister_extension(&budget_extension);\n}\n\nstatic struct saa7146_extension budget_extension = {\n\t.name           = \"budget_patch dvb\",\n\t.flags          = 0,\n\n\t.module         = THIS_MODULE,\n\t.pci_tbl        = pci_tbl,\n\t.attach         = budget_patch_attach,\n\t.detach         = budget_patch_detach,\n\n\t.irq_mask       = MASK_10,\n\t.irq_func       = ttpci_budget_irq10_handler,\n};\n\nmodule_init(budget_patch_init);\nmodule_exit(budget_patch_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Emard, Roberto Deza, Holger Waechtler, Michael Hunold, others\");\nMODULE_DESCRIPTION(\"Driver for full TS modified DVB-S SAA7146+AV7110 based so-called Budget Patch cards\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}