{
  "module_name": "dvb_filter.c",
  "hash_id": "a0d6460d8cc2be8b59668677de98a33af970bdc708a362fee8e88bda0af18f3d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/av7110/dvb_filter.c",
  "human_readable_source": "\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/string.h>\n#include \"dvb_filter.h\"\n\nstatic u32 freq[4] = {480, 441, 320, 0};\n\nstatic unsigned int ac3_bitrates[32] =\n    {32,40,48,56,64,80,96,112,128,160,192,224,256,320,384,448,512,576,640,\n     0,0,0,0,0,0,0,0,0,0,0,0,0};\n\nstatic u32 ac3_frames[3][32] =\n    {{64,80,96,112,128,160,192,224,256,320,384,448,512,640,768,896,1024,\n      1152,1280,0,0,0,0,0,0,0,0,0,0,0,0,0},\n     {69,87,104,121,139,174,208,243,278,348,417,487,557,696,835,975,1114,\n      1253,1393,0,0,0,0,0,0,0,0,0,0,0,0,0},\n     {96,120,144,168,192,240,288,336,384,480,576,672,768,960,1152,1344,\n      1536,1728,1920,0,0,0,0,0,0,0,0,0,0,0,0,0}};\n\nint dvb_filter_get_ac3info(u8 *mbuf, int count, struct dvb_audio_info *ai, int pr)\n{\n\tu8 *headr;\n\tint found = 0;\n\tint c = 0;\n\tu8 frame = 0;\n\tint fr = 0;\n\n\twhile ( !found  && c < count){\n\t\tu8 *b = mbuf+c;\n\n\t\tif ( b[0] == 0x0b &&  b[1] == 0x77 )\n\t\t\tfound = 1;\n\t\telse {\n\t\t\tc++;\n\t\t}\n\t}\n\n\tif (!found) return -1;\n\tif (pr)\n\t\tprintk(KERN_DEBUG \"Audiostream: AC3\");\n\n\tai->off = c;\n\tif (c+5 >= count) return -1;\n\n\tai->layer = 0;  \n\theadr = mbuf+c+2;\n\n\tframe = (headr[2]&0x3f);\n\tai->bit_rate = ac3_bitrates[frame >> 1]*1000;\n\n\tif (pr)\n\t\tprintk(KERN_CONT \"  BRate: %d kb/s\", (int) ai->bit_rate/1000);\n\n\tai->frequency = (headr[2] & 0xc0 ) >> 6;\n\tfr = (headr[2] & 0xc0 ) >> 6;\n\tai->frequency = freq[fr]*100;\n\tif (pr)\n\t\tprintk(KERN_CONT \"  Freq: %d Hz\\n\", (int) ai->frequency);\n\n\tai->framesize = ac3_frames[fr][frame >> 1];\n\tif ((frame & 1) &&  (fr == 1)) ai->framesize++;\n\tai->framesize = ai->framesize << 1;\n\tif (pr)\n\t\tprintk(KERN_DEBUG \"  Framesize %d\\n\", (int) ai->framesize);\n\n\treturn 0;\n}\n\nvoid dvb_filter_pes2ts_init(struct dvb_filter_pes2ts *p2ts, unsigned short pid,\n\t\t\t    dvb_filter_pes2ts_cb_t *cb, void *priv)\n{\n\tunsigned char *buf=p2ts->buf;\n\n\tbuf[0]=0x47;\n\tbuf[1]=(pid>>8);\n\tbuf[2]=pid&0xff;\n\tp2ts->cc=0;\n\tp2ts->cb=cb;\n\tp2ts->priv=priv;\n}\n\nint dvb_filter_pes2ts(struct dvb_filter_pes2ts *p2ts, unsigned char *pes,\n\t\t      int len, int payload_start)\n{\n\tunsigned char *buf=p2ts->buf;\n\tint ret=0, rest;\n\n\t\n\n\tif (payload_start)\n\t\tbuf[1]|=0x40;\n\telse\n\t\tbuf[1]&=~0x40;\n\twhile (len>=184) {\n\t\tbuf[3]=0x10|((p2ts->cc++)&0x0f);\n\t\tmemcpy(buf+4, pes, 184);\n\t\tif ((ret=p2ts->cb(p2ts->priv, buf)))\n\t\t\treturn ret;\n\t\tlen-=184; pes+=184;\n\t\tbuf[1]&=~0x40;\n\t}\n\tif (!len)\n\t\treturn 0;\n\tbuf[3]=0x30|((p2ts->cc++)&0x0f);\n\trest=183-len;\n\tif (rest) {\n\t\tbuf[5]=0x00;\n\t\tif (rest-1)\n\t\t\tmemset(buf+6, 0xff, rest-1);\n\t}\n\tbuf[4]=rest;\n\tmemcpy(buf+5+rest, pes, len);\n\treturn p2ts->cb(p2ts->priv, buf);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}