{
  "module_name": "ipu3-css-pool.c",
  "hash_id": "7fe1776874105c6a140b80db568414b04be6cba3b71cb0a2eb6e7e81d4260d66",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/ipu3/ipu3-css-pool.c",
  "human_readable_source": "\n\n\n#include <linux/device.h>\n\n#include \"ipu3.h\"\n#include \"ipu3-css-pool.h\"\n#include \"ipu3-dmamap.h\"\n\nint imgu_css_dma_buffer_resize(struct imgu_device *imgu,\n\t\t\t       struct imgu_css_map *map, size_t size)\n{\n\tif (map->size < size && map->vaddr) {\n\t\tdev_warn(&imgu->pci_dev->dev, \"dma buf resized from %zu to %zu\",\n\t\t\t map->size, size);\n\n\t\timgu_dmamap_free(imgu, map);\n\t\tif (!imgu_dmamap_alloc(imgu, map, size))\n\t\t\treturn -ENOMEM;\n\t}\n\n\treturn 0;\n}\n\nvoid imgu_css_pool_cleanup(struct imgu_device *imgu, struct imgu_css_pool *pool)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < IPU3_CSS_POOL_SIZE; i++)\n\t\timgu_dmamap_free(imgu, &pool->entry[i].param);\n}\n\nint imgu_css_pool_init(struct imgu_device *imgu, struct imgu_css_pool *pool,\n\t\t       size_t size)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < IPU3_CSS_POOL_SIZE; i++) {\n\t\tpool->entry[i].valid = false;\n\t\tif (size == 0) {\n\t\t\tpool->entry[i].param.vaddr = NULL;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (!imgu_dmamap_alloc(imgu, &pool->entry[i].param, size))\n\t\t\tgoto fail;\n\t}\n\n\tpool->last = IPU3_CSS_POOL_SIZE;\n\n\treturn 0;\n\nfail:\n\timgu_css_pool_cleanup(imgu, pool);\n\treturn -ENOMEM;\n}\n\n \nvoid imgu_css_pool_get(struct imgu_css_pool *pool)\n{\n\t \n\tu32 n = (pool->last + 1) % IPU3_CSS_POOL_SIZE;\n\n\tpool->entry[n].valid = true;\n\tpool->last = n;\n}\n\n \nvoid imgu_css_pool_put(struct imgu_css_pool *pool)\n{\n\tpool->entry[pool->last].valid = false;\n\tpool->last = (pool->last + IPU3_CSS_POOL_SIZE - 1) % IPU3_CSS_POOL_SIZE;\n}\n\n \nconst struct imgu_css_map *\nimgu_css_pool_last(struct imgu_css_pool *pool, unsigned int n)\n{\n\tstatic const struct imgu_css_map null_map = { 0 };\n\tint i = (pool->last + IPU3_CSS_POOL_SIZE - n) % IPU3_CSS_POOL_SIZE;\n\n\tWARN_ON(n >= IPU3_CSS_POOL_SIZE);\n\n\tif (!pool->entry[i].valid)\n\t\treturn &null_map;\n\n\treturn &pool->entry[i].param;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}