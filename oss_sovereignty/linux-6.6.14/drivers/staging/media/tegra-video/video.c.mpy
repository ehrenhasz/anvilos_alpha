{
  "module_name": "video.c",
  "hash_id": "71bbdd8b89991ffe2d94823470c39fe8e0f04065042db2ce79f257592e5cfce0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/media/tegra-video/video.c",
  "human_readable_source": "\n \n\n#include <linux/host1x.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\n#include <media/v4l2-event.h>\n\n#include \"video.h\"\n\nstatic void tegra_v4l2_dev_release(struct v4l2_device *v4l2_dev)\n{\n\tstruct tegra_video_device *vid;\n\n\tvid = container_of(v4l2_dev, struct tegra_video_device, v4l2_dev);\n\n\t \n\ttegra_channels_cleanup(vid->vi);\n\n\tv4l2_device_unregister(v4l2_dev);\n\tmedia_device_unregister(&vid->media_dev);\n\tmedia_device_cleanup(&vid->media_dev);\n\tkfree(vid);\n}\n\nstatic void tegra_v4l2_dev_notify(struct v4l2_subdev *sd,\n\t\t\t\t  unsigned int notification, void *arg)\n{\n\tstruct tegra_vi_channel *chan;\n\tconst struct v4l2_event *ev = arg;\n\n\tif (notification != V4L2_DEVICE_NOTIFY_EVENT)\n\t\treturn;\n\n\tchan = v4l2_get_subdev_hostdata(sd);\n\tv4l2_event_queue(&chan->video, arg);\n\tif (ev->type == V4L2_EVENT_SOURCE_CHANGE && vb2_is_streaming(&chan->queue))\n\t\tvb2_queue_error(&chan->queue);\n}\n\nstatic int host1x_video_probe(struct host1x_device *dev)\n{\n\tstruct tegra_video_device *vid;\n\tint ret;\n\n\tvid = kzalloc(sizeof(*vid), GFP_KERNEL);\n\tif (!vid)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(&dev->dev, vid);\n\n\tvid->media_dev.dev = &dev->dev;\n\tstrscpy(vid->media_dev.model, \"NVIDIA Tegra Video Input Device\",\n\t\tsizeof(vid->media_dev.model));\n\n\tmedia_device_init(&vid->media_dev);\n\tret = media_device_register(&vid->media_dev);\n\tif (ret < 0) {\n\t\tdev_err(&dev->dev,\n\t\t\t\"failed to register media device: %d\\n\", ret);\n\t\tgoto cleanup;\n\t}\n\n\tvid->v4l2_dev.mdev = &vid->media_dev;\n\tvid->v4l2_dev.release = tegra_v4l2_dev_release;\n\tvid->v4l2_dev.notify = tegra_v4l2_dev_notify;\n\tret = v4l2_device_register(&dev->dev, &vid->v4l2_dev);\n\tif (ret < 0) {\n\t\tdev_err(&dev->dev,\n\t\t\t\"V4L2 device registration failed: %d\\n\", ret);\n\t\tgoto unregister_media;\n\t}\n\n\tret = host1x_device_init(dev);\n\tif (ret < 0)\n\t\tgoto unregister_v4l2;\n\n\tif (IS_ENABLED(CONFIG_VIDEO_TEGRA_TPG)) {\n\t\t \n\t\tret = tegra_v4l2_nodes_setup_tpg(vid);\n\t\tif (ret < 0) {\n\t\t\tdev_err(&dev->dev,\n\t\t\t\t\"failed to setup tpg graph: %d\\n\", ret);\n\t\t\tgoto device_exit;\n\t\t}\n\t}\n\n\treturn 0;\n\ndevice_exit:\n\thost1x_device_exit(dev);\n\t \n\ttegra_channels_cleanup(vid->vi);\nunregister_v4l2:\n\tv4l2_device_unregister(&vid->v4l2_dev);\nunregister_media:\n\tmedia_device_unregister(&vid->media_dev);\ncleanup:\n\tmedia_device_cleanup(&vid->media_dev);\n\tkfree(vid);\n\treturn ret;\n}\n\nstatic int host1x_video_remove(struct host1x_device *dev)\n{\n\tstruct tegra_video_device *vid = dev_get_drvdata(&dev->dev);\n\n\tif (IS_ENABLED(CONFIG_VIDEO_TEGRA_TPG))\n\t\ttegra_v4l2_nodes_cleanup_tpg(vid);\n\n\thost1x_device_exit(dev);\n\n\t \n\tv4l2_device_put(&vid->v4l2_dev);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id host1x_video_subdevs[] = {\n#if defined(CONFIG_ARCH_TEGRA_2x_SOC)\n\t{ .compatible = \"nvidia,tegra20-vip\", },\n\t{ .compatible = \"nvidia,tegra20-vi\", },\n#endif\n#if defined(CONFIG_ARCH_TEGRA_210_SOC)\n\t{ .compatible = \"nvidia,tegra210-csi\", },\n\t{ .compatible = \"nvidia,tegra210-vi\", },\n#endif\n\t{ }\n};\n\nstatic struct host1x_driver host1x_video_driver = {\n\t.driver = {\n\t\t.name = \"tegra-video\",\n\t},\n\t.probe = host1x_video_probe,\n\t.remove = host1x_video_remove,\n\t.subdevs = host1x_video_subdevs,\n};\n\nstatic struct platform_driver * const drivers[] = {\n\t&tegra_csi_driver,\n\t&tegra_vip_driver,\n\t&tegra_vi_driver,\n};\n\nstatic int __init host1x_video_init(void)\n{\n\tint err;\n\n\terr = host1x_driver_register(&host1x_video_driver);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = platform_register_drivers(drivers, ARRAY_SIZE(drivers));\n\tif (err < 0)\n\t\tgoto unregister_host1x;\n\n\treturn 0;\n\nunregister_host1x:\n\thost1x_driver_unregister(&host1x_video_driver);\n\treturn err;\n}\nmodule_init(host1x_video_init);\n\nstatic void __exit host1x_video_exit(void)\n{\n\tplatform_unregister_drivers(drivers, ARRAY_SIZE(drivers));\n\thost1x_driver_unregister(&host1x_video_driver);\n}\nmodule_exit(host1x_video_exit);\n\nMODULE_AUTHOR(\"Sowjanya Komatineni <skomatineni@nvidia.com>\");\nMODULE_DESCRIPTION(\"NVIDIA Tegra Host1x Video driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}