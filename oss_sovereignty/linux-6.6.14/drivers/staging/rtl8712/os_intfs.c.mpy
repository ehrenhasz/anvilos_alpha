{
  "module_name": "os_intfs.c",
  "hash_id": "6d0b41eee0304910a7f5c25cb07d794d3169bdee94d0e0367393ee86882068aa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8712/os_intfs.c",
  "human_readable_source": "\n \n\n#define _OS_INTFS_C_\n\n#include <linux/module.h>\n#include <linux/kthread.h>\n#include <linux/firmware.h>\n#include \"osdep_service.h\"\n#include \"drv_types.h\"\n#include \"xmit_osdep.h\"\n#include \"recv_osdep.h\"\n#include \"rtl871x_ioctl.h\"\n#include \"usb_osintf.h\"\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"rtl871x wireless lan driver\");\nMODULE_AUTHOR(\"Larry Finger\");\n\nstatic char ifname[IFNAMSIZ] = \"wlan%d\";\n\n \nstatic int chip_version = RTL8712_2ndCUT;\nstatic int rfintfs = HWPI;\nstatic int lbkmode = RTL8712_AIR_TRX;\nstatic int hci = RTL8712_USB;\nstatic int ampdu_enable = 1; \n\n \n \nstatic int video_mode = 1;    \n\n \nstatic int network_mode = Ndis802_11IBSS;\nstatic int channel = 1; \nstatic int wireless_mode = WIRELESS_11BG;\nstatic int vrtl_carrier_sense = AUTO_VCS;\nstatic int vcs_type = RTS_CTS;\nstatic int frag_thresh = 2346;\nstatic int preamble = PREAMBLE_LONG; \nstatic int scan_mode = 1; \nstatic int adhoc_tx_pwr = 1;\nstatic int soft_ap;\nstatic int smart_ps = 1;\nstatic int power_mgnt = PS_MODE_ACTIVE;\nstatic int radio_enable = 1;\nstatic int long_retry_lmt = 7;\nstatic int short_retry_lmt = 7;\nstatic int busy_thresh = 40;\nstatic int ack_policy = NORMAL_ACK;\nstatic int mp_mode;\nstatic int software_encrypt;\nstatic int software_decrypt;\n\nstatic int wmm_enable; \nstatic int uapsd_enable;\nstatic int uapsd_max_sp = NO_LIMIT;\nstatic int uapsd_acbk_en;\nstatic int uapsd_acbe_en;\nstatic int uapsd_acvi_en;\nstatic int uapsd_acvo_en;\n\nstatic int ht_enable = 1;\nstatic int cbw40_enable = 1;\nstatic int rf_config = RTL8712_RF_1T2R;   \nstatic int low_power;\n \nchar *r8712_initmac;\nstatic char *initmac;\n \nstatic int wifi_test;\n\nmodule_param_string(ifname, ifname, sizeof(ifname), 0644);\nmodule_param(wifi_test, int, 0644);\nmodule_param(initmac, charp, 0644);\nmodule_param(video_mode, int, 0644);\nmodule_param(chip_version, int, 0644);\nmodule_param(rfintfs, int, 0644);\nmodule_param(lbkmode, int, 0644);\nmodule_param(hci, int, 0644);\nmodule_param(network_mode, int, 0644);\nmodule_param(channel, int, 0644);\nmodule_param(mp_mode, int, 0644);\nmodule_param(wmm_enable, int, 0644);\nmodule_param(vrtl_carrier_sense, int, 0644);\nmodule_param(vcs_type, int, 0644);\nmodule_param(busy_thresh, int, 0644);\nmodule_param(ht_enable, int, 0644);\nmodule_param(cbw40_enable, int, 0644);\nmodule_param(ampdu_enable, int, 0644);\nmodule_param(rf_config, int, 0644);\nmodule_param(power_mgnt, int, 0644);\nmodule_param(low_power, int, 0644);\n\nMODULE_PARM_DESC(ifname, \" Net interface name, wlan%d=default\");\nMODULE_PARM_DESC(initmac, \"MAC-Address, default: use FUSE\");\n\nstatic int netdev_open(struct net_device *pnetdev);\nstatic int netdev_close(struct net_device *pnetdev);\n\nstatic void loadparam(struct _adapter *padapter, struct  net_device *pnetdev)\n{\n\tstruct registry_priv  *registry_par = &padapter->registrypriv;\n\n\tregistry_par->chip_version = (u8)chip_version;\n\tregistry_par->rfintfs = (u8)rfintfs;\n\tregistry_par->lbkmode = (u8)lbkmode;\n\tregistry_par->hci = (u8)hci;\n\tregistry_par->network_mode  = (u8)network_mode;\n\tmemcpy(registry_par->ssid.Ssid, \"ANY\", 3);\n\tregistry_par->ssid.SsidLength = 3;\n\tregistry_par->channel = (u8)channel;\n\tregistry_par->wireless_mode = (u8)wireless_mode;\n\tregistry_par->vrtl_carrier_sense = (u8)vrtl_carrier_sense;\n\tregistry_par->vcs_type = (u8)vcs_type;\n\tregistry_par->frag_thresh = (u16)frag_thresh;\n\tregistry_par->preamble = (u8)preamble;\n\tregistry_par->scan_mode = (u8)scan_mode;\n\tregistry_par->adhoc_tx_pwr = (u8)adhoc_tx_pwr;\n\tregistry_par->soft_ap = (u8)soft_ap;\n\tregistry_par->smart_ps = (u8)smart_ps;\n\tregistry_par->power_mgnt = (u8)power_mgnt;\n\tregistry_par->radio_enable = (u8)radio_enable;\n\tregistry_par->long_retry_lmt = (u8)long_retry_lmt;\n\tregistry_par->short_retry_lmt = (u8)short_retry_lmt;\n\tregistry_par->busy_thresh = (u16)busy_thresh;\n\tregistry_par->ack_policy = (u8)ack_policy;\n\tregistry_par->mp_mode = (u8)mp_mode;\n\tregistry_par->software_encrypt = (u8)software_encrypt;\n\tregistry_par->software_decrypt = (u8)software_decrypt;\n\t \n\tregistry_par->wmm_enable = (u8)wmm_enable;\n\tregistry_par->uapsd_enable = (u8)uapsd_enable;\n\tregistry_par->uapsd_max_sp = (u8)uapsd_max_sp;\n\tregistry_par->uapsd_acbk_en = (u8)uapsd_acbk_en;\n\tregistry_par->uapsd_acbe_en = (u8)uapsd_acbe_en;\n\tregistry_par->uapsd_acvi_en = (u8)uapsd_acvi_en;\n\tregistry_par->uapsd_acvo_en = (u8)uapsd_acvo_en;\n\tregistry_par->ht_enable = (u8)ht_enable;\n\tregistry_par->cbw40_enable = (u8)cbw40_enable;\n\tregistry_par->ampdu_enable = (u8)ampdu_enable;\n\tregistry_par->rf_config = (u8)rf_config;\n\tregistry_par->low_power = (u8)low_power;\n\tregistry_par->wifi_test = (u8)wifi_test;\n\tr8712_initmac = initmac;\n}\n\nstatic int r871x_net_set_mac_address(struct net_device *pnetdev, void *p)\n{\n\tstruct _adapter *padapter = netdev_priv(pnetdev);\n\tstruct sockaddr *addr = p;\n\n\tif (!padapter->bup)\n\t\teth_hw_addr_set(pnetdev, addr->sa_data);\n\treturn 0;\n}\n\nstatic struct net_device_stats *r871x_net_get_stats(struct net_device *pnetdev)\n{\n\tstruct _adapter *padapter = netdev_priv(pnetdev);\n\tstruct xmit_priv *pxmitpriv = &padapter->xmitpriv;\n\tstruct recv_priv *precvpriv = &padapter->recvpriv;\n\n\tpadapter->stats.tx_packets = pxmitpriv->tx_pkts;\n\tpadapter->stats.rx_packets = precvpriv->rx_pkts;\n\tpadapter->stats.tx_dropped = pxmitpriv->tx_drop;\n\tpadapter->stats.rx_dropped = precvpriv->rx_drop;\n\tpadapter->stats.tx_bytes = pxmitpriv->tx_bytes;\n\tpadapter->stats.rx_bytes = precvpriv->rx_bytes;\n\treturn &padapter->stats;\n}\n\nstatic const struct net_device_ops rtl8712_netdev_ops = {\n\t.ndo_open = netdev_open,\n\t.ndo_stop = netdev_close,\n\t.ndo_start_xmit = r8712_xmit_entry,\n\t.ndo_set_mac_address = r871x_net_set_mac_address,\n\t.ndo_get_stats = r871x_net_get_stats,\n\t.ndo_do_ioctl = r871x_ioctl,\n};\n\nstruct net_device *r8712_init_netdev(void)\n{\n\tstruct _adapter *padapter;\n\tstruct net_device *pnetdev;\n\n\tpnetdev = alloc_etherdev(sizeof(struct _adapter));\n\tif (!pnetdev)\n\t\treturn NULL;\n\tif (dev_alloc_name(pnetdev, ifname) < 0) {\n\t\tstrscpy(ifname, \"wlan%d\", sizeof(ifname));\n\t\tdev_alloc_name(pnetdev, ifname);\n\t}\n\tpadapter = netdev_priv(pnetdev);\n\tpadapter->pnetdev = pnetdev;\n\tpr_info(\"r8712u: register rtl8712_netdev_ops to netdev_ops\\n\");\n\tpnetdev->netdev_ops = &rtl8712_netdev_ops;\n\tpnetdev->watchdog_timeo = HZ;  \n\tpnetdev->wireless_handlers = (struct iw_handler_def *)\n\t\t\t\t     &r871x_handlers_def;\n\tloadparam(padapter, pnetdev);\n\tnetif_carrier_off(pnetdev);\n\tpadapter->pid = 0;   \n\treturn pnetdev;\n}\n\nstatic u32 start_drv_threads(struct _adapter *padapter)\n{\n\tpadapter->cmd_thread = kthread_run(r8712_cmd_thread, padapter, \"%s\",\n\t\t\t\t\t  padapter->pnetdev->name);\n\tif (IS_ERR(padapter->cmd_thread))\n\t\treturn _FAIL;\n\treturn _SUCCESS;\n}\n\nvoid r8712_stop_drv_threads(struct _adapter *padapter)\n{\n\tstruct completion *completion =\n\t\t&padapter->cmdpriv.terminate_cmdthread_comp;\n\n\t \n\tcomplete(&padapter->cmdpriv.cmd_queue_comp);\n\tif (padapter->cmd_thread)\n\t\twait_for_completion_interruptible(completion);\n\tpadapter->cmdpriv.cmd_seq = 1;\n}\n\nstatic void start_drv_timers(struct _adapter *padapter)\n{\n\tmod_timer(&padapter->mlmepriv.sitesurveyctrl.sitesurvey_ctrl_timer,\n\t\t  jiffies + msecs_to_jiffies(5000));\n\tmod_timer(&padapter->mlmepriv.wdg_timer,\n\t\t  jiffies + msecs_to_jiffies(2000));\n}\n\nvoid r8712_stop_drv_timers(struct _adapter *padapter)\n{\n\tdel_timer_sync(&padapter->mlmepriv.assoc_timer);\n\tdel_timer_sync(&padapter->securitypriv.tkip_timer);\n\tdel_timer_sync(&padapter->mlmepriv.scan_to_timer);\n\tdel_timer_sync(&padapter->mlmepriv.dhcp_timer);\n\tdel_timer_sync(&padapter->mlmepriv.wdg_timer);\n\tdel_timer_sync(&padapter->mlmepriv.sitesurveyctrl.sitesurvey_ctrl_timer);\n}\n\nstatic void init_default_value(struct _adapter *padapter)\n{\n\tstruct registry_priv *pregistrypriv = &padapter->registrypriv;\n\tstruct xmit_priv *pxmitpriv = &padapter->xmitpriv;\n\tstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\n\tstruct security_priv *psecuritypriv = &padapter->securitypriv;\n\n\t \n\tpxmitpriv->vcs_setting = pregistrypriv->vrtl_carrier_sense;\n\tpxmitpriv->vcs = pregistrypriv->vcs_type;\n\tpxmitpriv->vcs_type = pregistrypriv->vcs_type;\n\tpxmitpriv->rts_thresh = pregistrypriv->rts_thresh;\n\tpxmitpriv->frag_len = pregistrypriv->frag_thresh;\n\t \n\t \n\tpmlmepriv->passive_mode = 1;  \n\t \n\t{\n\t\tint i;\n\t\tstruct ht_priv\t *phtpriv = &pmlmepriv->htpriv;\n\n\t\tphtpriv->ampdu_enable = false; \n\t\tfor (i = 0; i < 16; i++)\n\t\t\tphtpriv->baddbareq_issued[i] = false;\n\t}\n\t \n\tpsecuritypriv->sw_encrypt = pregistrypriv->software_encrypt;\n\tpsecuritypriv->sw_decrypt = pregistrypriv->software_decrypt;\n\tpsecuritypriv->binstallGrpkey = _FAIL;\n\t \n\t \n\tr8712_init_registrypriv_dev_network(padapter);\n\tr8712_update_registrypriv_dev_network(padapter);\n\t \n}\n\nint r8712_init_drv_sw(struct _adapter *padapter)\n{\n\tint ret;\n\n\tret = r8712_init_cmd_priv(&padapter->cmdpriv);\n\tif (ret)\n\t\treturn ret;\n\tpadapter->cmdpriv.padapter = padapter;\n\tret = r8712_init_evt_priv(&padapter->evtpriv);\n\tif (ret)\n\t\tgoto free_cmd;\n\tret = r8712_init_mlme_priv(padapter);\n\tif (ret)\n\t\tgoto free_evt;\n\tret = _r8712_init_xmit_priv(&padapter->xmitpriv, padapter);\n\tif (ret)\n\t\tgoto free_mlme;\n\tret = _r8712_init_recv_priv(&padapter->recvpriv, padapter);\n\tif (ret)\n\t\tgoto free_xmit;\n\tmemset((unsigned char *)&padapter->securitypriv, 0,\n\t       sizeof(struct security_priv));\n\ttimer_setup(&padapter->securitypriv.tkip_timer,\n\t\t    r8712_use_tkipkey_handler, 0);\n\tret = _r8712_init_sta_priv(&padapter->stapriv);\n\tif (ret)\n\t\tgoto free_recv;\n\tpadapter->stapriv.padapter = padapter;\n\tr8712_init_bcmc_stainfo(padapter);\n\tr8712_init_pwrctrl_priv(padapter);\n\tmp871xinit(padapter);\n\tinit_default_value(padapter);\n\tr8712_InitSwLeds(padapter);\n\tmutex_init(&padapter->mutex_start);\n\n\treturn 0;\n\nfree_recv:\n\t_r8712_free_recv_priv(&padapter->recvpriv);\nfree_xmit:\n\t_free_xmit_priv(&padapter->xmitpriv);\nfree_mlme:\n\tr8712_free_mlme_priv(&padapter->mlmepriv);\nfree_evt:\n\tr8712_free_evt_priv(&padapter->evtpriv);\nfree_cmd:\n\tr8712_free_cmd_priv(&padapter->cmdpriv);\n\treturn ret;\n}\n\nvoid r8712_free_drv_sw(struct _adapter *padapter)\n{\n\tr8712_free_cmd_priv(&padapter->cmdpriv);\n\tr8712_free_evt_priv(&padapter->evtpriv);\n\tr8712_DeInitSwLeds(padapter);\n\tr8712_free_mlme_priv(&padapter->mlmepriv);\n\t_free_xmit_priv(&padapter->xmitpriv);\n\t_r8712_free_sta_priv(&padapter->stapriv);\n\t_r8712_free_recv_priv(&padapter->recvpriv);\n\tmp871xdeinit(padapter);\n}\n\nstatic void enable_video_mode(struct _adapter *padapter, int cbw40_value)\n{\n\t \n\tu32  intcmd = 0xf4000500;    \n\n\tif (cbw40_value) {\n\t\t \n\t\tintcmd |= 0x200;\n\t}\n\tr8712_fw_cmd(padapter, intcmd);\n}\n\n \nstatic int netdev_open(struct net_device *pnetdev)\n{\n\tstruct _adapter *padapter = netdev_priv(pnetdev);\n\n\tmutex_lock(&padapter->mutex_start);\n\tif (!padapter->bup) {\n\t\tpadapter->driver_stopped = false;\n\t\tpadapter->surprise_removed = false;\n\t\tpadapter->bup = true;\n\t\tif (rtl871x_hal_init(padapter) != _SUCCESS)\n\t\t\tgoto netdev_open_error;\n\t\tif (!r8712_initmac) {\n\t\t\t \n\t\t\teth_hw_addr_set(pnetdev,\n\t\t\t\t\tpadapter->eeprompriv.mac_addr);\n\t\t} else {\n\t\t\t \n\t\t\tmsleep(200);\n\t\t\tr8712_setMacAddr_cmd(padapter,\n\t\t\t\t\t     (const u8 *)pnetdev->dev_addr);\n\t\t\t \n\t\t\tmemcpy(padapter->eeprompriv.mac_addr,\n\t\t\t       pnetdev->dev_addr, ETH_ALEN);\n\t\t}\n\t\tif (start_drv_threads(padapter) != _SUCCESS)\n\t\t\tgoto netdev_open_error;\n\t\tif (!padapter->dvobjpriv.inirp_init)\n\t\t\tgoto netdev_open_error;\n\t\telse\n\t\t\tpadapter->dvobjpriv.inirp_init(padapter);\n\t\tr8712_set_ps_mode(padapter, padapter->registrypriv.power_mgnt,\n\t\t\t\t  padapter->registrypriv.smart_ps);\n\t}\n\tif (!netif_queue_stopped(pnetdev))\n\t\tnetif_start_queue(pnetdev);\n\telse\n\t\tnetif_wake_queue(pnetdev);\n\n\tif (video_mode)\n\t\tenable_video_mode(padapter, cbw40_enable);\n\t \n\tstart_drv_timers(padapter);\n\tpadapter->ledpriv.LedControlHandler(padapter, LED_CTL_NO_LINK);\n\tmutex_unlock(&padapter->mutex_start);\n\treturn 0;\nnetdev_open_error:\n\tpadapter->bup = false;\n\tnetif_carrier_off(pnetdev);\n\tnetif_stop_queue(pnetdev);\n\tmutex_unlock(&padapter->mutex_start);\n\treturn -1;\n}\n\n \nstatic int netdev_close(struct net_device *pnetdev)\n{\n\tstruct _adapter *padapter = netdev_priv(pnetdev);\n\n\t \n\tpadapter->ledpriv.LedControlHandler(padapter, LED_CTL_POWER_OFF);\n\tmsleep(200);\n\n\t \n\tif (pnetdev) {\n\t\tif (!netif_queue_stopped(pnetdev))\n\t\t\tnetif_stop_queue(pnetdev);\n\t}\n\t \n\t \n\tr8712_disassoc_cmd(padapter);\n\t \n\tr8712_ind_disconnect(padapter);\n\t \n\tr8712_free_assoc_resources(padapter);\n\t \n\tr8712_free_network_queue(padapter);\n\treturn 0;\n}\n\n#include \"mlme_osdep.h\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}