{
  "module_name": "rtl871x_eeprom.c",
  "hash_id": "dc104b8bbf3ebf3a8c070e71212b33b401f3205b3f1db9d0b89d8a49be45fd5c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8712/rtl871x_eeprom.c",
  "human_readable_source": "\n \n\n#define _RTL871X_EEPROM_C_\n\n#include \"osdep_service.h\"\n#include \"drv_types.h\"\n\nstatic void up_clk(struct _adapter *padapter, u16 *x)\n{\n\t*x = *x | _EESK;\n\tr8712_write8(padapter, EE_9346CR, (u8)*x);\n\tudelay(CLOCK_RATE);\n}\n\nstatic void down_clk(struct _adapter *padapter, u16 *x)\n{\n\t*x = *x & ~_EESK;\n\tr8712_write8(padapter, EE_9346CR, (u8)*x);\n\tudelay(CLOCK_RATE);\n}\n\nstatic void shift_out_bits(struct _adapter *padapter, u16 data, u16 count)\n{\n\tu16 x, mask;\n\n\tif (padapter->surprise_removed)\n\t\tgoto out;\n\tmask = 0x01 << (count - 1);\n\tx = r8712_read8(padapter, EE_9346CR);\n\tx &= ~(_EEDO | _EEDI);\n\tdo {\n\t\tx &= ~_EEDI;\n\t\tif (data & mask)\n\t\t\tx |= _EEDI;\n\t\tif (padapter->surprise_removed)\n\t\t\tgoto out;\n\t\tr8712_write8(padapter, EE_9346CR, (u8)x);\n\t\tudelay(CLOCK_RATE);\n\t\tup_clk(padapter, &x);\n\t\tdown_clk(padapter, &x);\n\t\tmask >>= 1;\n\t} while (mask);\n\tif (padapter->surprise_removed)\n\t\tgoto out;\n\tx &= ~_EEDI;\n\tr8712_write8(padapter, EE_9346CR, (u8)x);\nout:;\n}\n\nstatic u16 shift_in_bits(struct _adapter *padapter)\n{\n\tu16 x, d = 0, i;\n\n\tif (padapter->surprise_removed)\n\t\tgoto out;\n\tx = r8712_read8(padapter, EE_9346CR);\n\tx &= ~(_EEDO | _EEDI);\n\td = 0;\n\tfor (i = 0; i < 16; i++) {\n\t\td <<= 1;\n\t\tup_clk(padapter, &x);\n\t\tif (padapter->surprise_removed)\n\t\t\tgoto out;\n\t\tx = r8712_read8(padapter, EE_9346CR);\n\t\tx &= ~(_EEDI);\n\t\tif (x & _EEDO)\n\t\t\td |= 1;\n\t\tdown_clk(padapter, &x);\n\t}\nout:\n\treturn d;\n}\n\nstatic void standby(struct _adapter *padapter)\n{\n\tu8   x;\n\n\tx = r8712_read8(padapter, EE_9346CR);\n\tx &= ~(_EECS | _EESK);\n\tr8712_write8(padapter, EE_9346CR, x);\n\tudelay(CLOCK_RATE);\n\tx |= _EECS;\n\tr8712_write8(padapter, EE_9346CR, x);\n\tudelay(CLOCK_RATE);\n}\n\nstatic u16 wait_eeprom_cmd_done(struct _adapter *padapter)\n{\n\tu8\tx;\n\tu16\ti;\n\n\tstandby(padapter);\n\tfor (i = 0; i < 200; i++) {\n\t\tx = r8712_read8(padapter, EE_9346CR);\n\t\tif (x & _EEDO)\n\t\t\treturn true;\n\t\tudelay(CLOCK_RATE);\n\t}\n\treturn false;\n}\n\nstatic void eeprom_clean(struct _adapter *padapter)\n{\n\tu16 x;\n\n\tif (padapter->surprise_removed)\n\t\treturn;\n\tx = r8712_read8(padapter, EE_9346CR);\n\tif (padapter->surprise_removed)\n\t\treturn;\n\tx &= ~(_EECS | _EEDI);\n\tr8712_write8(padapter, EE_9346CR, (u8)x);\n\tif (padapter->surprise_removed)\n\t\treturn;\n\tup_clk(padapter, &x);\n\tif (padapter->surprise_removed)\n\t\treturn;\n\tdown_clk(padapter, &x);\n}\n\nvoid r8712_eeprom_write16(struct _adapter *padapter, u16 reg, u16 data)\n{\n\tu8 x;\n\tu8 tmp8_ori, tmp8_new, tmp8_clk_ori, tmp8_clk_new;\n\n\ttmp8_ori = r8712_read8(padapter, 0x102502f1);\n\ttmp8_new = tmp8_ori & 0xf7;\n\tif (tmp8_ori != tmp8_new)\n\t\tr8712_write8(padapter, 0x102502f1, tmp8_new);\n\ttmp8_clk_ori = r8712_read8(padapter, 0x10250003);\n\ttmp8_clk_new = tmp8_clk_ori | 0x20;\n\tif (tmp8_clk_new != tmp8_clk_ori)\n\t\tr8712_write8(padapter, 0x10250003, tmp8_clk_new);\n\tx = r8712_read8(padapter, EE_9346CR);\n\tx &= ~(_EEDI | _EEDO | _EESK | _EEM0);\n\tx |= _EEM1 | _EECS;\n\tr8712_write8(padapter, EE_9346CR, x);\n\tshift_out_bits(padapter, EEPROM_EWEN_OPCODE, 5);\n\tif (padapter->eeprom_address_size == 8)\t \n\t\tshift_out_bits(padapter, 0, 6);\n\telse\t \n\t\tshift_out_bits(padapter, 0, 4);\n\tstandby(padapter);\n\t \n\tstandby(padapter);\n\t \n\tshift_out_bits(padapter, EEPROM_WRITE_OPCODE, 3);\n\t \n\tshift_out_bits(padapter, reg, padapter->eeprom_address_size);\n\t \n\tshift_out_bits(padapter, data, 16);\n\tif (wait_eeprom_cmd_done(padapter)) {\n\t\tstandby(padapter);\n\t\tshift_out_bits(padapter, EEPROM_EWDS_OPCODE, 5);\n\t\tshift_out_bits(padapter, reg, 4);\n\t\teeprom_clean(padapter);\n\t}\n\tif (tmp8_clk_new != tmp8_clk_ori)\n\t\tr8712_write8(padapter, 0x10250003, tmp8_clk_ori);\n\tif (tmp8_new != tmp8_ori)\n\t\tr8712_write8(padapter, 0x102502f1, tmp8_ori);\n}\n\nu16 r8712_eeprom_read16(struct _adapter *padapter, u16 reg)  \n{\n\tu16 x;\n\tu16 data = 0;\n\tu8 tmp8_ori, tmp8_new, tmp8_clk_ori, tmp8_clk_new;\n\n\ttmp8_ori = r8712_read8(padapter, 0x102502f1);\n\ttmp8_new = tmp8_ori & 0xf7;\n\tif (tmp8_ori != tmp8_new)\n\t\tr8712_write8(padapter, 0x102502f1, tmp8_new);\n\ttmp8_clk_ori = r8712_read8(padapter, 0x10250003);\n\ttmp8_clk_new = tmp8_clk_ori | 0x20;\n\tif (tmp8_clk_new != tmp8_clk_ori)\n\t\tr8712_write8(padapter, 0x10250003, tmp8_clk_new);\n\tif (padapter->surprise_removed)\n\t\tgoto out;\n\t \n\tx = r8712_read8(padapter, EE_9346CR);\n\tif (padapter->surprise_removed)\n\t\tgoto out;\n\tx &= ~(_EEDI | _EEDO | _EESK | _EEM0);\n\tx |= _EEM1 | _EECS;\n\tr8712_write8(padapter, EE_9346CR, (unsigned char)x);\n\t \n\tshift_out_bits(padapter, EEPROM_READ_OPCODE, 3);\n\tshift_out_bits(padapter, reg, padapter->eeprom_address_size);\n\t \n\tdata = shift_in_bits(padapter);\n\teeprom_clean(padapter);\nout:\n\tif (tmp8_clk_new != tmp8_clk_ori)\n\t\tr8712_write8(padapter, 0x10250003, tmp8_clk_ori);\n\tif (tmp8_new != tmp8_ori)\n\t\tr8712_write8(padapter, 0x102502f1, tmp8_ori);\n\treturn data;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}