{
  "module_name": "usb_halinit.c",
  "hash_id": "9f9ecb7bbce25ab3e968ded1f27331c52d5fd2323ba221e0c31746c43689a27e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8712/usb_halinit.c",
  "human_readable_source": "\n \n\n#define _HCI_HAL_INIT_C_\n\n#include \"osdep_service.h\"\n#include \"drv_types.h\"\n#include \"usb_ops.h\"\n#include \"usb_osintf.h\"\n\nu8 r8712_usb_hal_bus_init(struct _adapter *adapter)\n{\n\tu8 val8 = 0;\n\tu8 ret = _SUCCESS;\n\tint PollingCnt = 20;\n\tstruct registry_priv *registrypriv = &adapter->registrypriv;\n\n\tif (registrypriv->chip_version == RTL8712_FPGA) {\n\t\tval8 = 0x01;\n\t\t \n\t\tr8712_write8(adapter, SYS_CLKR, val8);\n\t\tval8 = r8712_read8(adapter, SPS1_CTRL);\n\t\tval8 = val8 | 0x01;\n\t\t \n\t\tr8712_write8(adapter, SPS1_CTRL, val8);\n\t\tval8 = r8712_read8(adapter, AFE_MISC);\n\t\tval8 = val8 | 0x01;\n\t\t \n\t\tr8712_write8(adapter, AFE_MISC, val8);\n\t\tval8 = r8712_read8(adapter, LDOA15_CTRL);\n\t\tval8 = val8 | 0x01;\n\t\t \n\t\tr8712_write8(adapter, LDOA15_CTRL, val8);\n\t\tval8 = r8712_read8(adapter, SPS1_CTRL);\n\t\tval8 = val8 | 0x02;\n\t\t \n\t\tr8712_write8(adapter, SPS1_CTRL, val8);\n\t\tval8 = r8712_read8(adapter, AFE_MISC);\n\t\tval8 = val8 | 0x02;\n\t\t \n\t\tr8712_write8(adapter, AFE_MISC, val8);\n\t\tval8 = r8712_read8(adapter, SYS_ISO_CTRL + 1);\n\t\tval8 = val8 | 0x08;\n\t\t \n\t\tr8712_write8(adapter, SYS_ISO_CTRL + 1, val8);\n\t\tval8 = r8712_read8(adapter, SYS_ISO_CTRL + 1);\n\t\tval8 = val8 & 0xEF;\n\t\t \n\t\tr8712_write8(adapter, SYS_ISO_CTRL + 1, val8);\n\t\tval8 = r8712_read8(adapter, AFE_XTAL_CTRL + 1);\n\t\tval8 = val8 & 0xFB;\n\t\t \n\t\tr8712_write8(adapter, AFE_XTAL_CTRL + 1, val8);\n\t\tval8 = r8712_read8(adapter, AFE_PLL_CTRL);\n\t\tval8 = val8 | 0x01;\n\t\t \n\t\tr8712_write8(adapter, AFE_PLL_CTRL, val8);\n\t\tval8 = 0xEE;\n\t\t \n\t\tr8712_write8(adapter, SYS_ISO_CTRL, val8);\n\t\tval8 = r8712_read8(adapter, SYS_CLKR + 1);\n\t\tval8 = val8 | 0x08;\n\t\t \n\t\tr8712_write8(adapter, SYS_CLKR + 1, val8);\n\t\tval8 = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tval8 = val8 | 0x08;\n\t\t \n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, val8);\n\t\tval8 = val8 | 0x80;\n\t\t \n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, val8);\n\t\tval8 = r8712_read8(adapter, SYS_CLKR + 1);\n\t\tval8 = (val8 | 0x80) & 0xBF;\n\t\t \n\t\tr8712_write8(adapter, SYS_CLKR + 1, val8);\n\t\tval8 = 0xFC;\n\t\tr8712_write8(adapter, CR, val8);\n\t\tval8 = 0x37;\n\t\tr8712_write8(adapter, CR + 1, val8);\n\t\t \n\t\tr8712_write8(adapter, 0x102500ab, r8712_read8(adapter,\n\t\t\t     0x102500ab) | BIT(6) | BIT(7));\n\t\t \n\t\tr8712_write8(adapter, 0x10250008, r8712_read8(adapter,\n\t\t\t     0x10250008) & 0xfffffffb);\n\t} else if (registrypriv->chip_version == RTL8712_1stCUT) {\n\t\t \n\t\tr8712_write8(adapter, SPS0_CTRL + 1, 0x53);\n\t\tr8712_write8(adapter, SPS0_CTRL, 0x57);\n\t\t \n\t\tval8 = r8712_read8(adapter, AFE_MISC);\n\t\tr8712_write8(adapter, AFE_MISC, (val8 | AFE_MISC_BGEN |\n\t\t\t     AFE_MISC_MBEN));\n\t\t \n\t\tval8 = r8712_read8(adapter, LDOA15_CTRL);\n\t\tr8712_write8(adapter, LDOA15_CTRL, (val8 | LDA15_EN));\n\t\tval8 = r8712_read8(adapter, SPS1_CTRL);\n\t\tr8712_write8(adapter, SPS1_CTRL, (val8 | SPS1_LDEN));\n\t\tmsleep(20);\n\t\t \n\t\tval8 = r8712_read8(adapter, SPS1_CTRL);\n\t\tr8712_write8(adapter, SPS1_CTRL, (val8 | SPS1_SWEN));\n\t\tr8712_write32(adapter, SPS1_CTRL, 0x00a7b267);\n\t\tval8 = r8712_read8(adapter, SYS_ISO_CTRL + 1);\n\t\tr8712_write8(adapter, SYS_ISO_CTRL + 1, (val8 | 0x08));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, (val8 | 0x20));\n\t\tval8 = r8712_read8(adapter, SYS_ISO_CTRL + 1);\n\t\tr8712_write8(adapter, SYS_ISO_CTRL + 1, (val8 & 0x6F));\n\t\t \n\t\tval8 = r8712_read8(adapter, AFE_XTAL_CTRL + 1);\n\t\tr8712_write8(adapter, AFE_XTAL_CTRL + 1, (val8 & 0xfb));\n\t\t \n\t\tval8 = r8712_read8(adapter, AFE_PLL_CTRL);\n\t\tr8712_write8(adapter, AFE_PLL_CTRL, (val8 | 0x11));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_ISO_CTRL);\n\t\tr8712_write8(adapter, SYS_ISO_CTRL, (val8 & 0xEE));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR);\n\t\tr8712_write8(adapter, SYS_CLKR, val8 & (~SYS_CLKSEL));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR);\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR + 1);\n\t\tr8712_write8(adapter, SYS_CLKR + 1, (val8 | 0x18));\n\t\t \n\t\tr8712_write8(adapter, PMC_FSM, 0x02);\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, (val8 | 0x08));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, (val8 | 0x80));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR + 1);\n\t\tr8712_write8(adapter, SYS_CLKR + 1, (val8 | 0x80) & 0xBF);\n\t\tr8712_write8(adapter, CR, 0xFC);\n\t\tr8712_write8(adapter, CR + 1, 0x37);\n\t\t \n\t\tval8 = r8712_read8(adapter, 0x1025FE5c);\n\t\tr8712_write8(adapter, 0x1025FE5c, (val8 | BIT(7)));\n\t\tval8 = r8712_read8(adapter, 0x102500ab);\n\t\tr8712_write8(adapter, 0x102500ab, (val8 | BIT(6) | BIT(7)));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR);\n\t\tr8712_write8(adapter, SYS_CLKR, val8 & (~CPU_CLKSEL));\n\t} else if (registrypriv->chip_version == RTL8712_2ndCUT ||\n\t\t   registrypriv->chip_version == RTL8712_3rdCUT) {\n\t\t \n\t\tr8712_write8(adapter, 0x37, 0xb0);\n\t\tmsleep(20);\n\t\tr8712_write8(adapter, 0x37, 0x30);\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR + 1);\n\t\tif (val8 & 0x80) {\n\t\t\tval8 &= 0x3f;\n\t\t\tr8712_write8(adapter, SYS_CLKR + 1, val8);\n\t\t}\n\t\tval8 = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tval8 &= 0x73;\n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, val8);\n\t\tmsleep(20);\n\t\t \n\t\t \n\t\tr8712_write8(adapter, SPS0_CTRL + 1, 0x53);\n\t\tr8712_write8(adapter, SPS0_CTRL, 0x57);\n\t\tval8 = r8712_read8(adapter, AFE_MISC);\n\t\t \n\t\tr8712_write8(adapter, AFE_MISC, (val8 | AFE_MISC_BGEN));\n\t\tr8712_write8(adapter, AFE_MISC, (val8 | AFE_MISC_BGEN |\n\t\t\t     AFE_MISC_MBEN | AFE_MISC_I32_EN));\n\t\t \n\t\tval8 = r8712_read8(adapter, LDOA15_CTRL);\n\t\tr8712_write8(adapter, LDOA15_CTRL, (val8 | LDA15_EN));\n\t\t \n\t\tval8 = r8712_read8(adapter, LDOV12D_CTRL);\n\t\tr8712_write8(adapter, LDOV12D_CTRL, (val8 | LDV12_EN));\n\t\tval8 = r8712_read8(adapter, SYS_ISO_CTRL + 1);\n\t\tr8712_write8(adapter, SYS_ISO_CTRL + 1, (val8 | 0x08));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, (val8 | 0x20));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_ISO_CTRL + 1);\n\t\tr8712_write8(adapter, SYS_ISO_CTRL + 1, (val8 & 0x68));\n\t\t \n\t\tval8 = r8712_read8(adapter, AFE_XTAL_CTRL + 1);\n\t\tr8712_write8(adapter, AFE_XTAL_CTRL + 1, (val8 & 0xfb));\n\t\t \n\t\tval8 = r8712_read8(adapter, AFE_PLL_CTRL);\n\t\tr8712_write8(adapter, AFE_PLL_CTRL, (val8 | 0x11));\n\t\t \n\t\tudelay(500);\n\t\tr8712_write8(adapter, AFE_PLL_CTRL, (val8 | 0x51));\n\t\tudelay(500);\n\t\tr8712_write8(adapter, AFE_PLL_CTRL, (val8 | 0x11));\n\t\tudelay(500);\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_ISO_CTRL);\n\t\tr8712_write8(adapter, SYS_ISO_CTRL, (val8 & 0xEE));\n\t\t \n\t\tr8712_write8(adapter, SYS_CLKR, 0x00);\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR);\n\t\tr8712_write8(adapter, SYS_CLKR, (val8 | 0xa0));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR + 1);\n\t\tr8712_write8(adapter, SYS_CLKR + 1, (val8 | 0x18));\n\t\t \n\t\tr8712_write8(adapter, PMC_FSM, 0x02);\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, (val8 | 0x08));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, (val8 | 0x80));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR + 1);\n\t\tr8712_write8(adapter, SYS_CLKR + 1, (val8 | 0x80) & 0xBF);\n\t\tr8712_write8(adapter, CR, 0xFC);\n\t\tr8712_write8(adapter, CR + 1, 0x37);\n\t\t \n\t\tval8 = r8712_read8(adapter, 0x1025FE5c);\n\t\tr8712_write8(adapter, 0x1025FE5c, (val8 | BIT(7)));\n\t\t \n\t\tval8 = r8712_read8(adapter, SYS_CLKR);\n\t\tr8712_write8(adapter, SYS_CLKR, val8 & (~CPU_CLKSEL));\n\t\t \n\t\tr8712_write8(adapter, 0x1025fe1c, 0x80);\n\t\t \n\t\tdo {\n\t\t\tval8 = r8712_read8(adapter, TCR);\n\t\t\tif ((val8 & _TXDMA_INIT_VALUE) == _TXDMA_INIT_VALUE)\n\t\t\t\tbreak;\n\t\t\tudelay(5);  \n\t\t} while (PollingCnt--);\t \n\n\t\tif (PollingCnt <= 0) {\n\t\t\tval8 = r8712_read8(adapter, CR);\n\t\t\tr8712_write8(adapter, CR, val8 & (~_TXDMA_EN));\n\t\t\tudelay(2);  \n\t\t\t \n\t\t\tr8712_write8(adapter, CR, val8 | _TXDMA_EN);\n\t\t}\n\t} else {\n\t\tret = _FAIL;\n\t}\n\treturn ret;\n}\n\nunsigned int r8712_usb_inirp_init(struct _adapter *adapter)\n{\n\tu8 i;\n\tstruct recv_buf *recvbuf;\n\tstruct intf_hdl *intfhdl = &adapter->pio_queue->intf;\n\tstruct recv_priv *recvpriv = &(adapter->recvpriv);\n\n\trecvpriv->ff_hwaddr = RTL8712_DMA_RX0FF;  \n\t \n\trecvbuf = (struct recv_buf *)recvpriv->precv_buf;\n\tfor (i = 0; i < NR_RECVBUFF; i++) {\n\t\tif (r8712_usb_read_port(intfhdl, recvpriv->ff_hwaddr, 0,\n\t\t\t\t\t(unsigned char *)recvbuf) == false)\n\t\t\treturn _FAIL;\n\t\trecvbuf++;\n\t\trecvpriv->free_recv_buf_queue_cnt--;\n\t}\n\treturn _SUCCESS;\n}\n\nunsigned int r8712_usb_inirp_deinit(struct _adapter *adapter)\n{\n\tr8712_usb_read_port_cancel(adapter);\n\treturn _SUCCESS;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}