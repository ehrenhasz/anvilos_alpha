{
  "module_name": "rtl871x_ioctl_set.c",
  "hash_id": "ea724d6f539fde6d4d0468421b88ae24373071d000624b89262d441e1b5d74b3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8712/rtl871x_ioctl_set.c",
  "human_readable_source": "\n \n\n#define _RTL871X_IOCTL_SET_C_\n\n#include \"osdep_service.h\"\n#include \"drv_types.h\"\n#include \"rtl871x_ioctl_set.h\"\n#include \"usb_osintf.h\"\n#include \"usb_ops.h\"\n\nstatic u8 validate_ssid(struct ndis_802_11_ssid *ssid)\n{\n\tu8 i;\n\n\tif (ssid->SsidLength > 32)\n\t\treturn false;\n\tfor (i = 0; i < ssid->SsidLength; i++) {\n\t\t \n\t\tif (!((ssid->Ssid[i] >= 0x20) && (ssid->Ssid[i] <= 0x7e)))\n\t\t\treturn false;\n\t}\n\treturn true;\n}\n\nstatic u8 do_join(struct _adapter *padapter)\n{\n\tstruct list_head *plist, *phead;\n\tu8 *pibss = NULL;\n\tstruct\tmlme_priv\t*pmlmepriv = &(padapter->mlmepriv);\n\tstruct  __queue\t*queue\t= &(pmlmepriv->scanned_queue);\n\tint ret;\n\n\tphead = &queue->queue;\n\tplist = phead->next;\n\tpmlmepriv->cur_network.join_res = -2;\n\tpmlmepriv->fw_state |= _FW_UNDER_LINKING;\n\tpmlmepriv->pscanned = plist;\n\tpmlmepriv->to_join = true;\n\n\t \n\tif (!check_fwstate(pmlmepriv, WIFI_ADHOC_STATE) &&\n\t    list_empty(&queue->queue)) {\n\t\tif (pmlmepriv->fw_state & _FW_UNDER_LINKING)\n\t\t\tpmlmepriv->fw_state ^= _FW_UNDER_LINKING;\n\t\t \n\t\tif (!pmlmepriv->sitesurveyctrl.traffic_busy)\n\t\t\tr8712_sitesurvey_cmd(padapter, &pmlmepriv->assoc_ssid);\n\t\treturn true;\n\t}\n\n\tret = r8712_select_and_join_from_scan(pmlmepriv);\n\tif (!ret) {\n\t\tmod_timer(&pmlmepriv->assoc_timer,\n\t\t\t  jiffies + msecs_to_jiffies(MAX_JOIN_TIMEOUT));\n\t} else {\n\t\tif (check_fwstate(pmlmepriv, WIFI_ADHOC_STATE)) {\n\t\t\t \n\t\t\tstruct wlan_bssid_ex *pdev_network =\n\t\t\t\t&padapter->registrypriv.dev_network;\n\t\t\tpmlmepriv->fw_state = WIFI_ADHOC_MASTER_STATE;\n\t\t\tpibss = padapter->registrypriv.dev_network.MacAddress;\n\t\t\tmemcpy(&pdev_network->Ssid,\n\t\t\t       &pmlmepriv->assoc_ssid,\n\t\t\t       sizeof(struct ndis_802_11_ssid));\n\t\t\tr8712_update_registrypriv_dev_network(padapter);\n\t\t\tr8712_generate_random_ibss(pibss);\n\t\t\tif (r8712_createbss_cmd(padapter))\n\t\t\t\treturn false;\n\t\t\tpmlmepriv->to_join = false;\n\t\t} else {\n\t\t\t \n\t\t\tif (pmlmepriv->fw_state & _FW_UNDER_LINKING)\n\t\t\t\tpmlmepriv->fw_state ^=\n\t\t\t\t\t_FW_UNDER_LINKING;\n\t\t\t \n\t\t\tif (!pmlmepriv->sitesurveyctrl.traffic_busy)\n\t\t\t\tr8712_sitesurvey_cmd(padapter,\n\t\t\t\t\t\t     &pmlmepriv->assoc_ssid);\n\t\t}\n\t}\n\treturn true;\n}\n\nu8 r8712_set_802_11_bssid(struct _adapter *padapter, u8 *bssid)\n{\n\tunsigned long irqL;\n\tu8 status = true;\n\tstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\n\n\tif (is_zero_ether_addr(bssid) || is_broadcast_ether_addr(bssid)) {\n\t\tstatus = false;\n\t\treturn status;\n\t}\n\tspin_lock_irqsave(&pmlmepriv->lock, irqL);\n\tif (check_fwstate(pmlmepriv, _FW_UNDER_SURVEY |\n\t    _FW_UNDER_LINKING)) {\n\t\tstatus = check_fwstate(pmlmepriv, _FW_UNDER_LINKING);\n\t\tgoto _Abort_Set_BSSID;\n\t}\n\tif (check_fwstate(pmlmepriv,\n\t    _FW_LINKED | WIFI_ADHOC_MASTER_STATE)) {\n\t\tif (!memcmp(&pmlmepriv->cur_network.network.MacAddress, bssid,\n\t\t    ETH_ALEN)) {\n\t\t\tif (!check_fwstate(pmlmepriv, WIFI_STATION_STATE))\n\t\t\t\t \n\t\t\t\tgoto _Abort_Set_BSSID;\n\t\t} else {\n\t\t\tr8712_disassoc_cmd(padapter);\n\t\t\tif (check_fwstate(pmlmepriv, _FW_LINKED))\n\t\t\t\tr8712_ind_disconnect(padapter);\n\t\t\tr8712_free_assoc_resources(padapter);\n\t\t\tif ((check_fwstate(pmlmepriv,\n\t\t\t     WIFI_ADHOC_MASTER_STATE))) {\n\t\t\t\t_clr_fwstate_(pmlmepriv,\n\t\t\t\t\t      WIFI_ADHOC_MASTER_STATE);\n\t\t\t\tset_fwstate(pmlmepriv, WIFI_ADHOC_STATE);\n\t\t\t}\n\t\t}\n\t}\n\tmemcpy(&pmlmepriv->assoc_bssid, bssid, ETH_ALEN);\n\tpmlmepriv->assoc_by_bssid = true;\n\tstatus = do_join(padapter);\n\tgoto done;\n_Abort_Set_BSSID:\ndone:\n\tspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\n\treturn status;\n}\n\nvoid r8712_set_802_11_ssid(struct _adapter *padapter,\n\t\t\t   struct ndis_802_11_ssid *ssid)\n{\n\tunsigned long irqL;\n\tstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\n\tstruct wlan_network *pnetwork = &pmlmepriv->cur_network;\n\n\tif (!padapter->hw_init_completed)\n\t\treturn;\n\tspin_lock_irqsave(&pmlmepriv->lock, irqL);\n\tif (check_fwstate(pmlmepriv, _FW_UNDER_SURVEY | _FW_UNDER_LINKING)) {\n\t\tcheck_fwstate(pmlmepriv, _FW_UNDER_LINKING);\n\t\tgoto _Abort_Set_SSID;\n\t}\n\tif (check_fwstate(pmlmepriv, _FW_LINKED | WIFI_ADHOC_MASTER_STATE)) {\n\t\tif ((pmlmepriv->assoc_ssid.SsidLength == ssid->SsidLength) &&\n\t\t    (!memcmp(&pmlmepriv->assoc_ssid.Ssid, ssid->Ssid,\n\t\t    ssid->SsidLength))) {\n\t\t\tif (!check_fwstate(pmlmepriv, WIFI_STATION_STATE)) {\n\t\t\t\tif (!r8712_is_same_ibss(padapter,\n\t\t\t\t     pnetwork)) {\n\t\t\t\t\t \n\t\t\t\t\tr8712_disassoc_cmd(padapter);\n\t\t\t\t\tif (check_fwstate(pmlmepriv,\n\t\t\t\t\t    _FW_LINKED))\n\t\t\t\t\t\tr8712_ind_disconnect(padapter);\n\t\t\t\t\tr8712_free_assoc_resources(padapter);\n\t\t\t\t\tif (check_fwstate(pmlmepriv,\n\t\t\t\t\t     WIFI_ADHOC_MASTER_STATE)) {\n\t\t\t\t\t\t_clr_fwstate_(pmlmepriv,\n\t\t\t\t\t\t    WIFI_ADHOC_MASTER_STATE);\n\t\t\t\t\t\tset_fwstate(pmlmepriv,\n\t\t\t\t\t\t\t    WIFI_ADHOC_STATE);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t \n\t\t\t\t\tgoto _Abort_Set_SSID;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tr8712_disassoc_cmd(padapter);\n\t\t\tif (check_fwstate(pmlmepriv, _FW_LINKED))\n\t\t\t\tr8712_ind_disconnect(padapter);\n\t\t\tr8712_free_assoc_resources(padapter);\n\t\t\tif (check_fwstate(pmlmepriv,\n\t\t\t    WIFI_ADHOC_MASTER_STATE)) {\n\t\t\t\t_clr_fwstate_(pmlmepriv,\n\t\t\t\t\t      WIFI_ADHOC_MASTER_STATE);\n\t\t\t\tset_fwstate(pmlmepriv, WIFI_ADHOC_STATE);\n\t\t\t}\n\t\t}\n\t}\n\tif (padapter->securitypriv.btkip_countermeasure)\n\t\tgoto _Abort_Set_SSID;\n\tif (!validate_ssid(ssid))\n\t\tgoto _Abort_Set_SSID;\n\tmemcpy(&pmlmepriv->assoc_ssid, ssid, sizeof(struct ndis_802_11_ssid));\n\tpmlmepriv->assoc_by_bssid = false;\n\tdo_join(padapter);\n\tgoto done;\n_Abort_Set_SSID:\ndone:\n\tspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\n}\n\nvoid r8712_set_802_11_infrastructure_mode(struct _adapter *padapter,\n\tenum NDIS_802_11_NETWORK_INFRASTRUCTURE networktype)\n{\n\tunsigned long irqL;\n\tstruct mlme_priv\t*pmlmepriv = &padapter->mlmepriv;\n\tstruct wlan_network\t*cur_network = &pmlmepriv->cur_network;\n\tenum NDIS_802_11_NETWORK_INFRASTRUCTURE *pold_state =\n\t\t\t\t&(cur_network->network.InfrastructureMode);\n\n\tif (*pold_state != networktype) {\n\t\tspin_lock_irqsave(&pmlmepriv->lock, irqL);\n\t\tif (check_fwstate(pmlmepriv, _FW_LINKED) ||\n\t\t    (*pold_state == Ndis802_11IBSS))\n\t\t\tr8712_disassoc_cmd(padapter);\n\t\tif (check_fwstate(pmlmepriv,\n\t\t    _FW_LINKED | WIFI_ADHOC_MASTER_STATE))\n\t\t\tr8712_free_assoc_resources(padapter);\n\t\tif (check_fwstate(pmlmepriv, _FW_LINKED) ||\n\t\t    (*pold_state == Ndis802_11Infrastructure) ||\n\t\t    (*pold_state == Ndis802_11IBSS)) {\n\t\t\t \n\t\t\tr8712_ind_disconnect(padapter);\n\t\t}\n\t\t*pold_state = networktype;\n\t\t \n\t\t_clr_fwstate_(pmlmepriv, WIFI_STATION_STATE | WIFI_AP_STATE |\n\t\t\t      WIFI_ADHOC_STATE | WIFI_ADHOC_MASTER_STATE);\n\t\tswitch (networktype) {\n\t\tcase Ndis802_11IBSS:\n\t\t\tset_fwstate(pmlmepriv, WIFI_ADHOC_STATE);\n\t\t\tbreak;\n\t\tcase Ndis802_11Infrastructure:\n\t\t\tset_fwstate(pmlmepriv, WIFI_STATION_STATE);\n\t\t\tbreak;\n\t\tcase Ndis802_11APMode:\n\t\t\tset_fwstate(pmlmepriv, WIFI_AP_STATE);\n\t\t\tbreak;\n\t\tcase Ndis802_11AutoUnknown:\n\t\tcase Ndis802_11InfrastructureMax:\n\t\t\tbreak;\n\t\t}\n\t\tspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\n\t}\n}\n\nu8 r8712_set_802_11_disassociate(struct _adapter *padapter)\n{\n\tunsigned long irqL;\n\tstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\n\n\tspin_lock_irqsave(&pmlmepriv->lock, irqL);\n\tif (check_fwstate(pmlmepriv, _FW_LINKED)) {\n\t\tr8712_disassoc_cmd(padapter);\n\t\tr8712_ind_disconnect(padapter);\n\t\tr8712_free_assoc_resources(padapter);\n\t}\n\tspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\n\treturn true;\n}\n\nu8 r8712_set_802_11_bssid_list_scan(struct _adapter *padapter)\n{\n\tstruct mlme_priv *pmlmepriv = NULL;\n\tunsigned long irqL;\n\tu8 ret = true;\n\n\tif (!padapter)\n\t\treturn false;\n\tpmlmepriv = &padapter->mlmepriv;\n\tif (!padapter->hw_init_completed)\n\t\treturn false;\n\tspin_lock_irqsave(&pmlmepriv->lock, irqL);\n\tif (check_fwstate(pmlmepriv, _FW_UNDER_SURVEY | _FW_UNDER_LINKING) ||\n\t    pmlmepriv->sitesurveyctrl.traffic_busy) {\n\t\t \n\t\tret = (u8)check_fwstate(pmlmepriv, _FW_UNDER_SURVEY);\n\t} else {\n\t\tr8712_free_network_queue(padapter);\n\t\tret = r8712_sitesurvey_cmd(padapter, NULL);\n\t}\n\tspin_unlock_irqrestore(&pmlmepriv->lock, irqL);\n\treturn ret;\n}\n\nu8 r8712_set_802_11_authentication_mode(struct _adapter *padapter,\n\t\t\t\tenum NDIS_802_11_AUTHENTICATION_MODE authmode)\n{\n\tstruct security_priv *psecuritypriv = &padapter->securitypriv;\n\tu8 ret;\n\n\tpsecuritypriv->ndisauthtype = authmode;\n\tif (psecuritypriv->ndisauthtype > 3)\n\t\tpsecuritypriv->AuthAlgrthm = 2;  \n\tif (r8712_set_auth(padapter, psecuritypriv))\n\t\tret = false;\n\telse\n\t\tret = true;\n\treturn ret;\n}\n\nint r8712_set_802_11_add_wep(struct _adapter *padapter,\n\t\t\t     struct NDIS_802_11_WEP *wep)\n{\n\tsint\tkeyid;\n\tstruct security_priv *psecuritypriv = &padapter->securitypriv;\n\n\tkeyid = wep->KeyIndex & 0x3fffffff;\n\tif (keyid >= WEP_KEYS)\n\t\treturn -EINVAL;\n\tswitch (wep->KeyLength) {\n\tcase 5:\n\t\tpsecuritypriv->PrivacyAlgrthm = _WEP40_;\n\t\tbreak;\n\tcase 13:\n\t\tpsecuritypriv->PrivacyAlgrthm = _WEP104_;\n\t\tbreak;\n\tdefault:\n\t\tpsecuritypriv->PrivacyAlgrthm = _NO_PRIVACY_;\n\t\tbreak;\n\t}\n\tmemcpy(psecuritypriv->DefKey[keyid].skey, &wep->KeyMaterial,\n\t\twep->KeyLength);\n\tpsecuritypriv->DefKeylen[keyid] = wep->KeyLength;\n\tpsecuritypriv->PrivacyKeyIndex = keyid;\n\treturn r8712_set_key(padapter, psecuritypriv, keyid);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}