{
  "module_name": "hal_init.c",
  "hash_id": "2773584f5cc700ec526d7536db2e616690b11e1f5cda3427c500e37dc8de0f40",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8712/hal_init.c",
  "human_readable_source": "\n \n\n#define _HAL_INIT_C_\n\n#include <linux/usb.h>\n#include <linux/device.h>\n#include <linux/usb/ch9.h>\n#include <linux/firmware.h>\n#include <linux/module.h>\n\n#include \"osdep_service.h\"\n#include \"drv_types.h\"\n#include \"usb_osintf.h\"\n\n#define FWBUFF_ALIGN_SZ 512\n#define MAX_DUMP_FWSZ (48 * 1024)\n\nstatic void rtl871x_load_fw_fail(struct _adapter *adapter)\n{\n\tstruct usb_device *udev = adapter->dvobjpriv.pusbdev;\n\tstruct device *dev = &udev->dev;\n\tstruct device *parent = dev->parent;\n\n\tcomplete(&adapter->rtl8712_fw_ready);\n\n\tdev_err(&udev->dev, \"r8712u: Firmware request failed\\n\");\n\n\tif (parent)\n\t\tdevice_lock(parent);\n\n\tdevice_release_driver(dev);\n\n\tif (parent)\n\t\tdevice_unlock(parent);\n}\n\nstatic void rtl871x_load_fw_cb(const struct firmware *firmware, void *context)\n{\n\tstruct _adapter *adapter = context;\n\n\tif (!firmware) {\n\t\trtl871x_load_fw_fail(adapter);\n\t\treturn;\n\t}\n\tadapter->fw = firmware;\n\t \n\tregister_netdev(adapter->pnetdev);\n\tcomplete(&adapter->rtl8712_fw_ready);\n}\n\nstatic const char firmware_file[] = \"rtlwifi/rtl8712u.bin\";\n\nint rtl871x_load_fw(struct _adapter *padapter)\n{\n\tstruct device *dev = &padapter->dvobjpriv.pusbdev->dev;\n\tint rc;\n\n\tinit_completion(&padapter->rtl8712_fw_ready);\n\tdev_info(dev, \"r8712u: Loading firmware from \\\"%s\\\"\\n\", firmware_file);\n\trc = request_firmware_nowait(THIS_MODULE, 1, firmware_file, dev,\n\t\t\t\t     GFP_KERNEL, padapter, rtl871x_load_fw_cb);\n\tif (rc)\n\t\tdev_err(dev, \"r8712u: Firmware request error %d\\n\", rc);\n\treturn rc;\n}\nMODULE_FIRMWARE(\"rtlwifi/rtl8712u.bin\");\n\nstatic u32 rtl871x_open_fw(struct _adapter *adapter, const u8 **mappedfw)\n{\n\tif (adapter->fw->size > 200000) {\n\t\tdev_err(&adapter->pnetdev->dev, \"r8712u: Bad fw->size of %zu\\n\",\n\t\t\tadapter->fw->size);\n\t\treturn 0;\n\t}\n\t*mappedfw = adapter->fw->data;\n\treturn adapter->fw->size;\n}\n\nstatic void fill_fwpriv(struct _adapter *adapter, struct fw_priv *fwpriv)\n{\n\tstruct dvobj_priv *dvobj = &adapter->dvobjpriv;\n\tstruct registry_priv *regpriv = &adapter->registrypriv;\n\n\tmemset(fwpriv, 0, sizeof(struct fw_priv));\n\t \n\tfwpriv->hci_sel =  RTL8712_HCI_TYPE_72USB;\n\tfwpriv->usb_ep_num = (u8)dvobj->nr_endpoint;\n\tfwpriv->bw_40MHz_en = regpriv->cbw40_enable;\n\tswitch (regpriv->rf_config) {\n\tcase RTL8712_RF_1T1R:\n\t\tfwpriv->rf_config = RTL8712_RFC_1T1R;\n\t\tbreak;\n\tcase RTL8712_RF_2T2R:\n\t\tfwpriv->rf_config = RTL8712_RFC_2T2R;\n\t\tbreak;\n\tcase RTL8712_RF_1T2R:\n\tdefault:\n\t\tfwpriv->rf_config = RTL8712_RFC_1T2R;\n\t}\n\tfwpriv->mp_mode = (regpriv->mp_mode == 1);\n\t \n\tfwpriv->vcs_type = regpriv->vrtl_carrier_sense;\n\tfwpriv->vcs_mode = regpriv->vcs_type;  \n\t \n\tfwpriv->turbo_mode = (regpriv->wifi_test != 1);\n\tfwpriv->low_power_mode = regpriv->low_power;\n}\n\nstatic void update_fwhdr(struct fw_hdr\t*pfwhdr, const u8 *pmappedfw)\n{\n\tpfwhdr->signature = le16_to_cpu(*(__le16 *)pmappedfw);\n\tpfwhdr->version = le16_to_cpu(*(__le16 *)(pmappedfw + 2));\n\t \n\tpfwhdr->dmem_size = le32_to_cpu(*(__le32 *)(pmappedfw + 4));\n\t \n\tpfwhdr->img_IMEM_size = le32_to_cpu(*(__le32 *)(pmappedfw + 8));\n\t \n\tpfwhdr->img_SRAM_size = le32_to_cpu(*(__le32 *)(pmappedfw + 12));\n\t \n\tpfwhdr->fw_priv_sz = le32_to_cpu(*(__le32 *)(pmappedfw + 16));\n}\n\nstatic u8 chk_fwhdr(struct fw_hdr *pfwhdr, u32 ulfilelength)\n{\n\tu32\tfwhdrsz, fw_sz;\n\n\t \n\tif ((pfwhdr->signature != 0x8712) && (pfwhdr->signature != 0x8192))\n\t\treturn _FAIL;\n\t \n\tif (pfwhdr->fw_priv_sz != sizeof(struct fw_priv))\n\t\treturn _FAIL;\n\t \n\tfwhdrsz = offsetof(struct fw_hdr, fwpriv) + pfwhdr->fw_priv_sz;\n\tfw_sz =  fwhdrsz + pfwhdr->img_IMEM_size + pfwhdr->img_SRAM_size +\n\t\t pfwhdr->dmem_size;\n\tif (fw_sz != ulfilelength)\n\t\treturn _FAIL;\n\treturn _SUCCESS;\n}\n\nstatic u8 rtl8712_dl_fw(struct _adapter *adapter)\n{\n\tsint i;\n\tu8 tmp8, tmp8_a;\n\tu16 tmp16;\n\tu32 maxlen = 0;  \n\tuint dump_imem_sz, imem_sz, dump_emem_sz, emem_sz;  \n\tstruct fw_hdr fwhdr;\n\tu32 ulfilelength;\t \n\tconst u8 *mappedfw = NULL;\n\tu8 *tmpchar = NULL, *payload, *ptr;\n\tstruct tx_desc *txdesc;\n\tu32 txdscp_sz = sizeof(struct tx_desc);\n\tu8 ret = _FAIL;\n\n\tulfilelength = rtl871x_open_fw(adapter, &mappedfw);\n\tif (mappedfw && (ulfilelength > 0)) {\n\t\tupdate_fwhdr(&fwhdr, mappedfw);\n\t\tif (chk_fwhdr(&fwhdr, ulfilelength) == _FAIL)\n\t\t\treturn ret;\n\t\tfill_fwpriv(adapter, &fwhdr.fwpriv);\n\t\t \n\t\tmaxlen = (fwhdr.img_IMEM_size > fwhdr.img_SRAM_size) ?\n\t\t\t  fwhdr.img_IMEM_size : fwhdr.img_SRAM_size;\n\t\tmaxlen += txdscp_sz;\n\t\ttmpchar = kmalloc(maxlen + FWBUFF_ALIGN_SZ, GFP_KERNEL);\n\t\tif (!tmpchar)\n\t\t\treturn ret;\n\n\t\ttxdesc = (struct tx_desc *)(tmpchar + FWBUFF_ALIGN_SZ -\n\t\t\t    ((addr_t)(tmpchar) & (FWBUFF_ALIGN_SZ - 1)));\n\t\tpayload = (u8 *)(txdesc) + txdscp_sz;\n\t\tptr = (u8 *)mappedfw + offsetof(struct fw_hdr, fwpriv) +\n\t\t      fwhdr.fw_priv_sz;\n\t\t \n\t\t \n\t\timem_sz = fwhdr.img_IMEM_size;\n\t\tdo {\n\t\t\tmemset(txdesc, 0, TXDESC_SIZE);\n\t\t\tif (imem_sz >  MAX_DUMP_FWSZ ) {\n\t\t\t\tdump_imem_sz = MAX_DUMP_FWSZ;\n\t\t\t} else {\n\t\t\t\tdump_imem_sz = imem_sz;\n\t\t\t\ttxdesc->txdw0 |= cpu_to_le32(BIT(28));\n\t\t\t}\n\t\t\ttxdesc->txdw0 |= cpu_to_le32(dump_imem_sz &\n\t\t\t\t\t\t       0x0000ffff);\n\t\t\tmemcpy(payload, ptr, dump_imem_sz);\n\t\t\tr8712_write_mem(adapter, RTL8712_DMA_VOQ,\n\t\t\t\t\tdump_imem_sz + TXDESC_SIZE,\n\t\t\t\t\t(u8 *)txdesc);\n\t\t\tptr += dump_imem_sz;\n\t\t\timem_sz -= dump_imem_sz;\n\t\t} while (imem_sz > 0);\n\t\ti = 10;\n\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\twhile (((tmp16 & _IMEM_CODE_DONE) == 0) && (i > 0)) {\n\t\t\tusleep_range(10, 1000);\n\t\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\t\ti--;\n\t\t}\n\t\tif (i == 0 || (tmp16 & _IMEM_CHK_RPT) == 0)\n\t\t\tgoto exit_fail;\n\n\t\t \n\t\temem_sz = fwhdr.img_SRAM_size;\n\t\tdo {\n\t\t\tmemset(txdesc, 0, TXDESC_SIZE);\n\t\t\tif (emem_sz >  MAX_DUMP_FWSZ) {  \n\t\t\t\tdump_emem_sz = MAX_DUMP_FWSZ;\n\t\t\t} else {\n\t\t\t\tdump_emem_sz = emem_sz;\n\t\t\t\ttxdesc->txdw0 |= cpu_to_le32(BIT(28));\n\t\t\t}\n\t\t\ttxdesc->txdw0 |= cpu_to_le32(dump_emem_sz &\n\t\t\t\t\t\t       0x0000ffff);\n\t\t\tmemcpy(payload, ptr, dump_emem_sz);\n\t\t\tr8712_write_mem(adapter, RTL8712_DMA_VOQ,\n\t\t\t\t\tdump_emem_sz + TXDESC_SIZE,\n\t\t\t\t\t(u8 *)txdesc);\n\t\t\tptr += dump_emem_sz;\n\t\t\temem_sz -= dump_emem_sz;\n\t\t} while (emem_sz > 0);\n\t\ti = 5;\n\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\twhile (((tmp16 & _EMEM_CODE_DONE) == 0) && (i > 0)) {\n\t\t\tusleep_range(10, 1000);\n\t\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\t\ti--;\n\t\t}\n\t\tif (i == 0 || (tmp16 & _EMEM_CHK_RPT) == 0)\n\t\t\tgoto exit_fail;\n\n\t\t \n\t\ttmp8 = r8712_read8(adapter, SYS_CLKR);\n\t\tr8712_write8(adapter, SYS_CLKR, tmp8 | BIT(2));\n\t\ttmp8_a = r8712_read8(adapter, SYS_CLKR);\n\t\tif (tmp8_a != (tmp8 | BIT(2)))\n\t\t\tgoto exit_fail;\n\n\t\ttmp8 = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tr8712_write8(adapter, SYS_FUNC_EN + 1, tmp8 | BIT(2));\n\t\ttmp8_a = r8712_read8(adapter, SYS_FUNC_EN + 1);\n\t\tif (tmp8_a != (tmp8 | BIT(2)))\n\t\t\tgoto exit_fail;\n\n\t\tr8712_read32(adapter, TCR);\n\n\t\t \n\t\ti = 100;\n\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\twhile (((tmp16 & _IMEM_RDY) == 0) && (i > 0)) {\n\t\t\tmsleep(20);\n\t\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\t\ti--;\n\t\t}\n\t\tif (i == 0) {\n\t\t\tr8712_write16(adapter, 0x10250348, 0xc000);\n\t\t\tr8712_write16(adapter, 0x10250348, 0xc001);\n\t\t\tr8712_write16(adapter, 0x10250348, 0x2000);\n\t\t\tr8712_write16(adapter, 0x10250348, 0x2001);\n\t\t\tr8712_write16(adapter, 0x10250348, 0x2002);\n\t\t\tr8712_write16(adapter, 0x10250348, 0x2003);\n\t\t\tgoto exit_fail;\n\t\t}\n\t\t \n\t\tmemset(txdesc, 0, TXDESC_SIZE);\n\t\ttxdesc->txdw0 |= cpu_to_le32(fwhdr.fw_priv_sz & 0x0000ffff);\n\t\ttxdesc->txdw0 |= cpu_to_le32(BIT(28));\n\t\tmemcpy(payload, &fwhdr.fwpriv, fwhdr.fw_priv_sz);\n\t\tr8712_write_mem(adapter, RTL8712_DMA_VOQ,\n\t\t\t\tfwhdr.fw_priv_sz + TXDESC_SIZE, (u8 *)txdesc);\n\n\t\t \n\t\ti = 100;\n\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\twhile (((tmp16 & _DMEM_CODE_DONE) == 0) && (i > 0)) {\n\t\t\tmsleep(20);\n\t\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\t\ti--;\n\t\t}\n\t\tif (i == 0)\n\t\t\tgoto exit_fail;\n\n\t\ttmp8 = r8712_read8(adapter, 0x1025000A);\n\t\tif (tmp8 & BIT(4))  \n\t\t\ti = 60;\n\t\telse\t\t\t \n\t\t\ti = 30;\n\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\twhile (((tmp16 & _FWRDY) == 0) && (i > 0)) {\n\t\t\tmsleep(100);\n\t\t\ttmp16 = r8712_read16(adapter, TCR);\n\t\t\ti--;\n\t\t}\n\t\tif (i == 0)\n\t\t\tgoto exit_fail;\n\t} else {\n\t\tgoto exit_fail;\n\t}\n\tret = _SUCCESS;\n\nexit_fail:\n\tkfree(tmpchar);\n\treturn ret;\n}\n\nuint rtl8712_hal_init(struct _adapter *padapter)\n{\n\tu32 val32;\n\tint i;\n\n\t \n\tif (rtl8712_dl_fw(padapter) != _SUCCESS)\n\t\treturn _FAIL;\n\n\tnetdev_info(padapter->pnetdev, \"1 RCR=0x%x\\n\",\n\t\t    r8712_read32(padapter, RCR));\n\tval32 = r8712_read32(padapter, RCR);\n\tr8712_write32(padapter, RCR, (val32 | BIT(26)));  \n\tnetdev_info(padapter->pnetdev, \"2 RCR=0x%x\\n\",\n\t\t    r8712_read32(padapter, RCR));\n\tval32 = r8712_read32(padapter, RCR);\n\tr8712_write32(padapter, RCR, (val32 | BIT(25)));  \n\tval32 = r8712_read32(padapter, 0x10250040);\n\tr8712_write32(padapter,  0x10250040, (val32 & 0x00FFFFFF));\n\t \n\tr8712_write8(padapter, 0x102500B5, r8712_read8(padapter, 0x102500B5) |\n\t       BIT(0));  \n\tr8712_write8(padapter, 0x102500BD, r8712_read8(padapter, 0x102500BD) |\n\t       BIT(7));  \n\tr8712_write8(padapter, 0x102500D9, 1);  \n\tr8712_write8(padapter, 0x1025FE5B, 0x04);  \n\t \n\tr8712_write8(padapter, 0x1025fe5C, r8712_read8(padapter, 0x1025fe5C)\n\t\t     | BIT(7));\n\tfor (i = 0; i < ETH_ALEN; i++)\n\t\tpadapter->eeprompriv.mac_addr[i] = r8712_read8(padapter,\n\t\t\t\t\t\t\t       MACID + i);\n\treturn _SUCCESS;\n}\n\nuint rtl8712_hal_deinit(struct _adapter *padapter)\n{\n\tr8712_write8(padapter, RF_CTRL, 0x00);\n\t \n\tmsleep(20);\n\t \n\tr8712_write8(padapter, SYS_CLKR + 1, 0x38);  \n\tr8712_write8(padapter, SYS_FUNC_EN + 1, 0x70);\n\tr8712_write8(padapter, PMC_FSM, 0x06);   \n\tr8712_write8(padapter, SYS_ISO_CTRL, 0xF9);  \n\tr8712_write8(padapter, SYS_ISO_CTRL + 1, 0xe8);  \n\tr8712_write8(padapter, AFE_PLL_CTRL, 0x00);  \n\tr8712_write8(padapter, LDOA15_CTRL, 0x54);   \n\tr8712_write8(padapter, SYS_FUNC_EN + 1, 0x50);  \n\tr8712_write8(padapter, LDOV12D_CTRL, 0x24);  \n\tr8712_write8(padapter, AFE_MISC, 0x30);  \n\t \n\tr8712_write8(padapter, SPS0_CTRL, 0x56);  \n\tr8712_write8(padapter, SPS0_CTRL + 1, 0x43);   \n\treturn _SUCCESS;\n}\n\nuint rtl871x_hal_init(struct _adapter *padapter)\n{\n\tpadapter->hw_init_completed = false;\n\tif (!padapter->halpriv.hal_bus_init)\n\t\treturn _FAIL;\n\tif (padapter->halpriv.hal_bus_init(padapter) != _SUCCESS)\n\t\treturn _FAIL;\n\tif (rtl8712_hal_init(padapter) == _SUCCESS) {\n\t\tpadapter->hw_init_completed = true;\n\t} else {\n\t\tpadapter->hw_init_completed = false;\n\t\treturn _FAIL;\n\t}\n\treturn _SUCCESS;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}