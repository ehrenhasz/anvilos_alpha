{
  "module_name": "ieee80211.c",
  "hash_id": "ae8823858432bc6d2b4a820960ba7be65e00d4f3f27778e6726240e339109b68",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8712/ieee80211.c",
  "human_readable_source": "\n \n\n#define _IEEE80211_C\n\n#include \"drv_types.h\"\n#include \"ieee80211.h\"\n#include \"wifi.h\"\n#include \"osdep_service.h\"\n#include \"wlan_bssdef.h\"\n\nstatic const u8 WPA_OUI_TYPE[] = {0x00, 0x50, 0xf2, 1};\nstatic const u8 WPA_CIPHER_SUITE_NONE[] = {0x00, 0x50, 0xf2, 0};\nstatic const u8 WPA_CIPHER_SUITE_WEP40[] = {0x00, 0x50, 0xf2, 1};\nstatic const u8 WPA_CIPHER_SUITE_TKIP[] = {0x00, 0x50, 0xf2, 2};\nstatic const u8 WPA_CIPHER_SUITE_CCMP[] = {0x00, 0x50, 0xf2, 4};\nstatic const u8 WPA_CIPHER_SUITE_WEP104[] = {0x00, 0x50, 0xf2, 5};\n\nstatic const u8 RSN_CIPHER_SUITE_NONE[] = {0x00, 0x0f, 0xac, 0};\nstatic const u8 RSN_CIPHER_SUITE_WEP40[] = {0x00, 0x0f, 0xac, 1};\nstatic const u8 RSN_CIPHER_SUITE_TKIP[] = {0x00, 0x0f, 0xac, 2};\nstatic const u8 RSN_CIPHER_SUITE_CCMP[] = {0x00, 0x0f, 0xac, 4};\nstatic const u8 RSN_CIPHER_SUITE_WEP104[] = {0x00, 0x0f, 0xac, 5};\n\n \n\nstatic u8 WIFI_CCKRATES[] =  {\n\t(IEEE80211_CCK_RATE_1MB | IEEE80211_BASIC_RATE_MASK),\n\t(IEEE80211_CCK_RATE_2MB | IEEE80211_BASIC_RATE_MASK),\n\t(IEEE80211_CCK_RATE_5MB | IEEE80211_BASIC_RATE_MASK),\n\t(IEEE80211_CCK_RATE_11MB | IEEE80211_BASIC_RATE_MASK)\n};\n\nstatic u8 WIFI_OFDMRATES[] = {\n\t(IEEE80211_OFDM_RATE_6MB),\n\t(IEEE80211_OFDM_RATE_9MB),\n\t(IEEE80211_OFDM_RATE_12MB),\n\t(IEEE80211_OFDM_RATE_18MB),\n\t(IEEE80211_OFDM_RATE_24MB),\n\t(IEEE80211_OFDM_RATE_36MB),\n\t(IEEE80211_OFDM_RATE_48MB),\n\t(IEEE80211_OFDM_RATE_54MB)\n};\n\nuint r8712_is_cckrates_included(u8 *rate)\n{\n\tu32 i = 0;\n\n\twhile (rate[i] != 0) {\n\t\tif ((((rate[i]) & 0x7f) == 2) || (((rate[i]) & 0x7f) == 4) ||\n\t\t    (((rate[i]) & 0x7f) == 11) || (((rate[i]) & 0x7f) == 22))\n\t\t\treturn true;\n\t\ti++;\n\t}\n\treturn false;\n}\n\nuint r8712_is_cckratesonly_included(u8 *rate)\n{\n\tu32 i = 0;\n\n\twhile (rate[i] != 0) {\n\t\tif ((((rate[i]) & 0x7f) != 2) && (((rate[i]) & 0x7f) != 4) &&\n\t\t    (((rate[i]) & 0x7f) != 11)  && (((rate[i]) & 0x7f) != 22))\n\t\t\treturn false;\n\t\ti++;\n\t}\n\treturn true;\n}\n\n \nu8 *r8712_set_ie(u8 *pbuf, sint index, uint len, u8 *source, uint *frlen)\n{\n\t*pbuf = (u8)index;\n\t*(pbuf + 1) = (u8)len;\n\tif (len > 0)\n\t\tmemcpy((void *)(pbuf + 2), (void *)source, len);\n\t*frlen = *frlen + (len + 2);\n\treturn pbuf + len + 2;\n}\n\n \nu8 *r8712_get_ie(u8 *pbuf, sint index, uint *len, sint limit)\n{\n\tsint tmp, i;\n\tu8 *p;\n\n\tif (limit < 1)\n\t\treturn NULL;\n\tp = pbuf;\n\ti = 0;\n\t*len = 0;\n\twhile (1) {\n\t\tif (*p == index) {\n\t\t\t*len = *(p + 1);\n\t\t\treturn p;\n\t\t}\n\t\ttmp = *(p + 1);\n\t\tp += (tmp + 2);\n\t\ti += (tmp + 2);\n\t\tif (i >= limit)\n\t\t\tbreak;\n\t}\n\treturn NULL;\n}\n\nstatic void set_supported_rate(u8 *rates, uint mode)\n{\n\tmemset(rates, 0, NDIS_802_11_LENGTH_RATES_EX);\n\tswitch (mode) {\n\tcase WIRELESS_11B:\n\t\tmemcpy(rates, WIFI_CCKRATES, IEEE80211_CCK_RATE_LEN);\n\t\tbreak;\n\tcase WIRELESS_11G:\n\tcase WIRELESS_11A:\n\t\tmemcpy(rates, WIFI_OFDMRATES, IEEE80211_NUM_OFDM_RATESLEN);\n\t\tbreak;\n\tcase WIRELESS_11BG:\n\t\tmemcpy(rates, WIFI_CCKRATES, IEEE80211_CCK_RATE_LEN);\n\t\tmemcpy(rates + IEEE80211_CCK_RATE_LEN, WIFI_OFDMRATES,\n\t\t       IEEE80211_NUM_OFDM_RATESLEN);\n\t\tbreak;\n\t}\n}\n\nstatic uint r8712_get_rateset_len(u8 *rateset)\n{\n\tuint i = 0;\n\n\twhile (1) {\n\t\tif ((rateset[i]) == 0)\n\t\t\tbreak;\n\t\tif (i > 12)\n\t\t\tbreak;\n\t\ti++;\n\t}\n\treturn i;\n}\n\nint r8712_generate_ie(struct registry_priv *registrypriv)\n{\n\tint rate_len;\n\tuint sz = 0;\n\tstruct wlan_bssid_ex *dev_network = &registrypriv->dev_network;\n\tu8 *ie = dev_network->IEs;\n\tu16 beacon_period = (u16)dev_network->Configuration.BeaconPeriod;\n\n\t \n\tsz += 8;\n\tie += sz;\n\t \n\t*(__le16 *)ie = cpu_to_le16(beacon_period);\n\tsz += 2;\n\tie += 2;\n\t \n\t*(u16 *)ie = 0;\n\t*(__le16 *)ie |= cpu_to_le16(WLAN_CAPABILITY_IBSS);\n\tif (registrypriv->preamble == PREAMBLE_SHORT)\n\t\t*(__le16 *)ie |= cpu_to_le16(WLAN_CAPABILITY_SHORT_PREAMBLE);\n\tif (dev_network->Privacy)\n\t\t*(__le16 *)ie |= cpu_to_le16(WLAN_CAPABILITY_PRIVACY);\n\tsz += 2;\n\tie += 2;\n\t \n\tie = r8712_set_ie(ie, WLAN_EID_SSID, dev_network->Ssid.SsidLength,\n\t\t\t  dev_network->Ssid.Ssid, &sz);\n\t \n\tset_supported_rate(dev_network->rates, registrypriv->wireless_mode);\n\trate_len = r8712_get_rateset_len(dev_network->rates);\n\tif (rate_len > 8) {\n\t\tie = r8712_set_ie(ie, WLAN_EID_SUPP_RATES, 8,\n\t\t\t\t  dev_network->rates, &sz);\n\t\tie = r8712_set_ie(ie, WLAN_EID_EXT_SUPP_RATES, (rate_len - 8),\n\t\t\t\t  (dev_network->rates + 8), &sz);\n\t} else {\n\t\tie = r8712_set_ie(ie, WLAN_EID_SUPP_RATES,\n\t\t\t\t  rate_len, dev_network->rates, &sz);\n\t}\n\t \n\tie = r8712_set_ie(ie, WLAN_EID_DS_PARAMS, 1,\n\t\t\t  (u8 *)&dev_network->Configuration.DSConfig, &sz);\n\t \n\tie = r8712_set_ie(ie, WLAN_EID_IBSS_PARAMS, 2,\n\t\t\t  (u8 *)&dev_network->Configuration.ATIMWindow, &sz);\n\treturn sz;\n}\n\nunsigned char *r8712_get_wpa_ie(unsigned char *ie, uint *wpa_ie_len, int limit)\n{\n\tu32 len;\n\tu16 val16;\n\tunsigned char wpa_oui_type[] = {0x00, 0x50, 0xf2, 0x01};\n\tu8 *buf = ie;\n\n\twhile (1) {\n\t\tbuf = r8712_get_ie(buf, _WPA_IE_ID_, &len, limit);\n\t\tif (buf) {\n\t\t\t \n\t\t\tif (memcmp((buf + 2), wpa_oui_type,\n\t\t\t\t   sizeof(wpa_oui_type)))\n\t\t\t\tgoto check_next_ie;\n\t\t\t \n\t\t\tmemcpy((u8 *)&val16, (buf + 6), sizeof(val16));\n\t\t\tle16_to_cpus(&val16);\n\t\t\tif (val16 != 0x0001)\n\t\t\t\tgoto check_next_ie;\n\t\t\t*wpa_ie_len = *(buf + 1);\n\t\t\treturn buf;\n\t\t}\n\t\t*wpa_ie_len = 0;\n\t\treturn NULL;\ncheck_next_ie:\n\t\tlimit = limit - (buf - ie) - 2 - len;\n\t\tif (limit <= 0)\n\t\t\tbreak;\n\t\tbuf += (2 + len);\n\t}\n\t*wpa_ie_len = 0;\n\treturn NULL;\n}\n\nunsigned char *r8712_get_wpa2_ie(unsigned char *pie, uint *rsn_ie_len,\n\t\t\t\t int limit)\n{\n\treturn r8712_get_ie(pie, _WPA2_IE_ID_, rsn_ie_len, limit);\n}\n\nstatic int r8712_get_wpa_cipher_suite(u8 *s)\n{\n\tif (!memcmp(s, (void *)WPA_CIPHER_SUITE_NONE, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_NONE;\n\tif (!memcmp(s, (void *)WPA_CIPHER_SUITE_WEP40, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_WEP40;\n\tif (!memcmp(s, (void *)WPA_CIPHER_SUITE_TKIP, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_TKIP;\n\tif (!memcmp(s, (void *)WPA_CIPHER_SUITE_CCMP, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_CCMP;\n\tif (!memcmp(s, (void *)WPA_CIPHER_SUITE_WEP104, WPA_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_WEP104;\n\treturn 0;\n}\n\nstatic int r8712_get_wpa2_cipher_suite(u8 *s)\n{\n\tif (!memcmp(s, (void *)RSN_CIPHER_SUITE_NONE, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_NONE;\n\tif (!memcmp(s, (void *)RSN_CIPHER_SUITE_WEP40, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_WEP40;\n\tif (!memcmp(s, (void *)RSN_CIPHER_SUITE_TKIP, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_TKIP;\n\tif (!memcmp(s, (void *)RSN_CIPHER_SUITE_CCMP, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_CCMP;\n\tif (!memcmp(s, (void *)RSN_CIPHER_SUITE_WEP104, RSN_SELECTOR_LEN))\n\t\treturn WPA_CIPHER_WEP104;\n\treturn 0;\n}\n\nint r8712_parse_wpa_ie(u8 *wpa_ie, int wpa_ie_len, int *group_cipher,\n\t\t       int *pairwise_cipher)\n{\n\tint i;\n\tint left, count;\n\tu8 *pos;\n\n\tif (wpa_ie_len <= 0) {\n\t\t \n\t\treturn -EINVAL;\n\t}\n\tif ((*wpa_ie != _WPA_IE_ID_) ||\n\t    (*(wpa_ie + 1) != (u8)(wpa_ie_len - 2)) ||\n\t    (memcmp(wpa_ie + 2, (void *)WPA_OUI_TYPE, WPA_SELECTOR_LEN)))\n\t\treturn -EINVAL;\n\tpos = wpa_ie;\n\tpos += 8;\n\tleft = wpa_ie_len - 8;\n\t \n\tif (left >= WPA_SELECTOR_LEN) {\n\t\t*group_cipher = r8712_get_wpa_cipher_suite(pos);\n\t\tpos += WPA_SELECTOR_LEN;\n\t\tleft -= WPA_SELECTOR_LEN;\n\t} else if (left > 0) {\n\t\treturn -EINVAL;\n\t}\n\t \n\tif (left >= 2) {\n\t\tcount = le16_to_cpu(*(__le16 *)pos);\n\t\tpos += 2;\n\t\tleft -= 2;\n\t\tif (count == 0 || left < count * WPA_SELECTOR_LEN)\n\t\t\treturn -EINVAL;\n\t\tfor (i = 0; i < count; i++) {\n\t\t\t*pairwise_cipher |= r8712_get_wpa_cipher_suite(pos);\n\t\t\tpos += WPA_SELECTOR_LEN;\n\t\t\tleft -= WPA_SELECTOR_LEN;\n\t\t}\n\t} else if (left == 1) {\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nint r8712_parse_wpa2_ie(u8 *rsn_ie, int rsn_ie_len, int *group_cipher,\n\t\t\tint *pairwise_cipher)\n{\n\tint i;\n\tint left, count;\n\tu8 *pos;\n\n\tif (rsn_ie_len <= 0) {\n\t\t \n\t\treturn -EINVAL;\n\t}\n\tif ((*rsn_ie != _WPA2_IE_ID_) ||\n\t    (*(rsn_ie + 1) != (u8)(rsn_ie_len - 2)))\n\t\treturn -EINVAL;\n\tpos = rsn_ie;\n\tpos += 4;\n\tleft = rsn_ie_len - 4;\n\t \n\tif (left >= RSN_SELECTOR_LEN) {\n\t\t*group_cipher = r8712_get_wpa2_cipher_suite(pos);\n\t\tpos += RSN_SELECTOR_LEN;\n\t\tleft -= RSN_SELECTOR_LEN;\n\t} else if (left > 0) {\n\t\treturn -EINVAL;\n\t}\n\t \n\tif (left >= 2) {\n\t\tcount = le16_to_cpu(*(__le16 *)pos);\n\t\tpos += 2;\n\t\tleft -= 2;\n\t\tif (count == 0 || left < count * RSN_SELECTOR_LEN)\n\t\t\treturn -EINVAL;\n\t\tfor (i = 0; i < count; i++) {\n\t\t\t*pairwise_cipher |= r8712_get_wpa2_cipher_suite(pos);\n\t\t\tpos += RSN_SELECTOR_LEN;\n\t\t\tleft -= RSN_SELECTOR_LEN;\n\t\t}\n\t} else if (left == 1) {\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nint r8712_get_sec_ie(u8 *in_ie, uint in_len, u8 *rsn_ie, u16 *rsn_len,\n\t\t     u8 *wpa_ie, u16 *wpa_len)\n{\n\tu8 authmode;\n\tu8 wpa_oui[4] = {0x0, 0x50, 0xf2, 0x01};\n\tuint cnt;\n\n\t \n\tcnt = _TIMESTAMP_ + _BEACON_ITERVAL_ + _CAPABILITY_;\n\twhile (cnt < in_len) {\n\t\tauthmode = in_ie[cnt];\n\t\tif ((authmode == _WPA_IE_ID_) &&\n\t\t    (!memcmp(&in_ie[cnt + 2], &wpa_oui[0], 4))) {\n\t\t\tmemcpy(wpa_ie, &in_ie[cnt], in_ie[cnt + 1] + 2);\n\t\t\t*wpa_len = in_ie[cnt + 1] + 2;\n\t\t\tcnt += in_ie[cnt + 1] + 2;   \n\t\t} else {\n\t\t\tif (authmode == _WPA2_IE_ID_) {\n\t\t\t\tmemcpy(rsn_ie, &in_ie[cnt],\n\t\t\t\t       in_ie[cnt + 1] + 2);\n\t\t\t\t*rsn_len = in_ie[cnt + 1] + 2;\n\t\t\t\tcnt += in_ie[cnt + 1] + 2;   \n\t\t\t} else {\n\t\t\t\tcnt += in_ie[cnt + 1] + 2;    \n\t\t\t}\n\t\t}\n\t}\n\treturn *rsn_len + *wpa_len;\n}\n\nint r8712_get_wps_ie(u8 *in_ie, uint in_len, u8 *wps_ie, uint *wps_ielen)\n{\n\tint match;\n\tuint cnt;\n\tu8 eid, wps_oui[4] = {0x0, 0x50, 0xf2, 0x04};\n\n\tcnt = 12;\n\tmatch = false;\n\twhile (cnt < in_len) {\n\t\teid = in_ie[cnt];\n\t\tif ((eid == _WPA_IE_ID_) &&\n\t\t    (!memcmp(&in_ie[cnt + 2], wps_oui, 4))) {\n\t\t\tmemcpy(wps_ie, &in_ie[cnt], in_ie[cnt + 1] + 2);\n\t\t\t*wps_ielen = in_ie[cnt + 1] + 2;\n\t\t\tcnt += in_ie[cnt + 1] + 2;\n\t\t\tmatch = true;\n\t\t\tbreak;\n\t\t}\n\t\tcnt += in_ie[cnt + 1] + 2;  \n\t}\n\treturn match;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}