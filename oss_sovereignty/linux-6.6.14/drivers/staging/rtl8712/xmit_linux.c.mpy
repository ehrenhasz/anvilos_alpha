{
  "module_name": "xmit_linux.c",
  "hash_id": "33d0e1da498557af0337d0576c1bda77f8c6f8d4ed552da1bb7210c277ea9281",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8712/xmit_linux.c",
  "human_readable_source": "\n \n\n#define _XMIT_OSDEP_C_\n\n#include <linux/usb.h>\n#include <linux/ip.h>\n#include <linux/if_ether.h>\n#include <linux/kmemleak.h>\n\n#include \"osdep_service.h\"\n#include \"drv_types.h\"\n\n#include \"wifi.h\"\n#include \"mlme_osdep.h\"\n#include \"xmit_osdep.h\"\n#include \"osdep_intf.h\"\n\nstatic uint remainder_len(struct pkt_file *pfile)\n{\n\treturn (uint)(pfile->buf_len - ((addr_t)(pfile->cur_addr) -\n\t       (addr_t)(pfile->buf_start)));\n}\n\nvoid _r8712_open_pktfile(_pkt *pktptr, struct pkt_file *pfile)\n{\n\tpfile->pkt = pktptr;\n\tpfile->cur_addr = pfile->buf_start = pktptr->data;\n\tpfile->pkt_len = pfile->buf_len = pktptr->len;\n\tpfile->cur_buffer = pfile->buf_start;\n}\n\nuint _r8712_pktfile_read(struct pkt_file *pfile, u8 *rmem, uint rlen)\n{\n\tuint len;\n\n\tlen = remainder_len(pfile);\n\tlen = (rlen > len) ? len : rlen;\n\tif (rmem)\n\t\tskb_copy_bits(pfile->pkt, pfile->buf_len - pfile->pkt_len,\n\t\t\t      rmem, len);\n\tpfile->cur_addr += len;\n\tpfile->pkt_len -= len;\n\treturn len;\n}\n\nsint r8712_endofpktfile(struct pkt_file *pfile)\n{\n\treturn (pfile->pkt_len == 0);\n}\n\nvoid r8712_set_qos(struct pkt_file *ppktfile, struct pkt_attrib *pattrib)\n{\n\tstruct ethhdr etherhdr;\n\tstruct iphdr ip_hdr;\n\tu16 user_priority = 0;\n\n\t_r8712_open_pktfile(ppktfile->pkt, ppktfile);\n\t_r8712_pktfile_read(ppktfile, (unsigned char *)&etherhdr, ETH_HLEN);\n\n\t \n\tif (pattrib->ether_type == 0x0800) {\n\t\t_r8712_pktfile_read(ppktfile, (u8 *)&ip_hdr, sizeof(ip_hdr));\n\t\t \n\t\tuser_priority = ip_hdr.tos >> 5;\n\t} else {\n\t\t \n\n\t\tif (pattrib->ether_type == 0x888e)\n\t\t\tuser_priority = 7;\n\t}\n\tpattrib->priority = user_priority;\n\tpattrib->hdrlen = WLAN_HDR_A3_QOS_LEN;\n\tpattrib->subtype = WIFI_QOS_DATA_TYPE;\n}\n\nvoid r8712_SetFilter(struct work_struct *work)\n{\n\tstruct _adapter *adapter = container_of(work, struct _adapter,\n\t\t\t\t\t\twk_filter_rx_ff0);\n\tu8  oldvalue = 0x00, newvalue = 0x00;\n\n\toldvalue = r8712_read8(adapter, 0x117);\n\tnewvalue = oldvalue & 0xfe;\n\tr8712_write8(adapter, 0x117, newvalue);\n\n\twait_for_completion(&adapter->rx_filter_ready);\n\tr8712_write8(adapter, 0x117, oldvalue);\n}\n\nint r8712_xmit_resource_alloc(struct _adapter *padapter,\n\t\t\t      struct xmit_buf *pxmitbuf)\n{\n\tint i;\n\n\tfor (i = 0; i < 8; i++) {\n\t\tpxmitbuf->pxmit_urb[i] = usb_alloc_urb(0, GFP_KERNEL);\n\t\tif (!pxmitbuf->pxmit_urb[i]) {\n\t\t\tint k;\n\n\t\t\tfor (k = i - 1; k >= 0; k--) {\n\t\t\t\t \n\t\t\t\tusb_free_urb(pxmitbuf->pxmit_urb[k]);\n\t\t\t}\n\t\t\tnetdev_err(padapter->pnetdev, \"pxmitbuf->pxmit_urb[i] == NULL\\n\");\n\t\t\treturn -ENOMEM;\n\t\t}\n\t\tkmemleak_not_leak(pxmitbuf->pxmit_urb[i]);\n\t}\n\treturn 0;\n}\n\nvoid r8712_xmit_resource_free(struct _adapter *padapter,\n\t\t\t      struct xmit_buf *pxmitbuf)\n{\n\tint i;\n\n\tfor (i = 0; i < 8; i++) {\n\t\tif (pxmitbuf->pxmit_urb[i]) {\n\t\t\tusb_kill_urb(pxmitbuf->pxmit_urb[i]);\n\t\t\tusb_free_urb(pxmitbuf->pxmit_urb[i]);\n\t\t}\n\t}\n}\n\nvoid r8712_xmit_complete(struct _adapter *padapter, struct xmit_frame *pxframe)\n{\n\tif (pxframe->pkt)\n\t\tdev_kfree_skb_any(pxframe->pkt);\n\tpxframe->pkt = NULL;\n}\n\nnetdev_tx_t r8712_xmit_entry(_pkt *pkt, struct  net_device *netdev)\n{\n\tstruct xmit_frame *xmitframe = NULL;\n\tstruct _adapter *adapter = netdev_priv(netdev);\n\tstruct xmit_priv *xmitpriv = &(adapter->xmitpriv);\n\n\tif (!r8712_if_up(adapter))\n\t\tgoto _xmit_entry_drop;\n\n\txmitframe = r8712_alloc_xmitframe(xmitpriv);\n\tif (!xmitframe)\n\t\tgoto _xmit_entry_drop;\n\n\tif (r8712_update_attrib(adapter, pkt, &xmitframe->attrib))\n\t\tgoto _xmit_entry_drop;\n\n\tadapter->ledpriv.LedControlHandler(adapter, LED_CTL_TX);\n\txmitframe->pkt = pkt;\n\tif (r8712_pre_xmit(adapter, xmitframe)) {\n\t\t \n\t\tdev_kfree_skb_any(pkt);\n\t\txmitframe->pkt = NULL;\n\t}\n\txmitpriv->tx_pkts++;\n\txmitpriv->tx_bytes += xmitframe->attrib.last_txcmdsz;\n\treturn NETDEV_TX_OK;\n_xmit_entry_drop:\n\tif (xmitframe)\n\t\tr8712_free_xmitframe(xmitpriv, xmitframe);\n\txmitpriv->tx_drop++;\n\tdev_kfree_skb_any(pkt);\n\treturn NETDEV_TX_OK;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}