{
  "module_name": "rtl871x_mp.c",
  "hash_id": "eea3fcddf7a5dc9c72c62a7f4a3fd6cc7dd1956b1ffbfee554ad5cac399d1cd0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/rtl8712/rtl871x_mp.c",
  "human_readable_source": "\n \n#define _RTL871X_MP_C_\n\n#include \"osdep_service.h\"\n#include \"drv_types.h\"\n#include \"rtl871x_mp_phy_regdef.h\"\n#include \"rtl8712_cmd.h\"\n\nstatic void _init_mp_priv_(struct mp_priv *pmp_priv)\n{\n\tpmp_priv->mode = _LOOPBOOK_MODE_;\n\tpmp_priv->curr_ch = 1;\n\tpmp_priv->curr_modem = MIXED_PHY;\n\tpmp_priv->curr_rateidx = 0;\n\tpmp_priv->curr_txpoweridx = 0x14;\n\tpmp_priv->antenna_tx = ANTENNA_A;\n\tpmp_priv->antenna_rx = ANTENNA_AB;\n\tpmp_priv->check_mp_pkt = 0;\n\tpmp_priv->tx_pktcount = 0;\n\tpmp_priv->rx_pktcount = 0;\n\tpmp_priv->rx_crcerrpktcount = 0;\n}\n\nstatic int init_mp_priv(struct mp_priv *pmp_priv)\n{\n\tint i;\n\tstruct mp_xmit_frame *pmp_xmitframe;\n\n\t_init_mp_priv_(pmp_priv);\n\t_init_queue(&pmp_priv->free_mp_xmitqueue);\n\tpmp_priv->pallocated_mp_xmitframe_buf = NULL;\n\tpmp_priv->pallocated_mp_xmitframe_buf = kmalloc(NR_MP_XMITFRAME *\n\t\t\t\tsizeof(struct mp_xmit_frame) + 4,\n\t\t\t\tGFP_ATOMIC);\n\tif (!pmp_priv->pallocated_mp_xmitframe_buf)\n\t\treturn -ENOMEM;\n\n\tpmp_priv->pmp_xmtframe_buf = pmp_priv->pallocated_mp_xmitframe_buf +\n\t\t\t 4 -\n\t\t\t ((addr_t)(pmp_priv->pallocated_mp_xmitframe_buf) & 3);\n\tpmp_xmitframe = (struct mp_xmit_frame *)pmp_priv->pmp_xmtframe_buf;\n\tfor (i = 0; i < NR_MP_XMITFRAME; i++) {\n\t\tINIT_LIST_HEAD(&(pmp_xmitframe->list));\n\t\tlist_add_tail(&(pmp_xmitframe->list),\n\t\t\t\t &(pmp_priv->free_mp_xmitqueue.queue));\n\t\tpmp_xmitframe->pkt = NULL;\n\t\tpmp_xmitframe->frame_tag = MP_FRAMETAG;\n\t\tpmp_xmitframe->padapter = pmp_priv->papdater;\n\t\tpmp_xmitframe++;\n\t}\n\tpmp_priv->free_mp_xmitframe_cnt = NR_MP_XMITFRAME;\n\treturn 0;\n}\n\nstatic int free_mp_priv(struct mp_priv *pmp_priv)\n{\n\tkfree(pmp_priv->pallocated_mp_xmitframe_buf);\n\treturn 0;\n}\n\nvoid mp871xinit(struct _adapter *padapter)\n{\n\tstruct mp_priv *pmppriv = &padapter->mppriv;\n\n\tpmppriv->papdater = padapter;\n\tinit_mp_priv(pmppriv);\n}\n\nvoid mp871xdeinit(struct _adapter *padapter)\n{\n\tstruct mp_priv *pmppriv = &padapter->mppriv;\n\n\tfree_mp_priv(pmppriv);\n}\n\n \nstatic u32 fw_iocmd_read(struct _adapter *pAdapter, struct IOCMD_STRUCT iocmd)\n{\n\tu32 cmd32 = 0, val32 = 0;\n\tu8 iocmd_class\t= iocmd.cmdclass;\n\tu16 iocmd_value\t= iocmd.value;\n\tu8 iocmd_idx\t= iocmd.index;\n\n\tcmd32 = (iocmd_class << 24) | (iocmd_value << 8) | iocmd_idx;\n\tif (r8712_fw_cmd(pAdapter, cmd32))\n\t\tr8712_fw_cmd_data(pAdapter, &val32, 1);\n\telse\n\t\tval32 = 0;\n\treturn val32;\n}\n\nstatic u8 fw_iocmd_write(struct _adapter *pAdapter,\n\t\t\t struct IOCMD_STRUCT iocmd, u32 value)\n{\n\tu32 cmd32 = 0;\n\tu8 iocmd_class\t= iocmd.cmdclass;\n\tu32 iocmd_value\t= iocmd.value;\n\tu8 iocmd_idx\t= iocmd.index;\n\n\tr8712_fw_cmd_data(pAdapter, &value, 0);\n\tmsleep(100);\n\tcmd32 = (iocmd_class << 24) | (iocmd_value << 8) | iocmd_idx;\n\treturn r8712_fw_cmd(pAdapter, cmd32);\n}\n\n \nu32 r8712_bb_reg_read(struct _adapter *pAdapter, u16 offset)\n{\n\tu8 shift = offset & 0x0003;\t \n\tu16 bb_addr = offset & 0x0FFC;\t \n\tu32 bb_val = 0;\n\tstruct IOCMD_STRUCT iocmd;\n\n\tiocmd.cmdclass\t= IOCMD_CLASS_BB_RF;\n\tiocmd.value\t= bb_addr;\n\tiocmd.index\t= IOCMD_BB_READ_IDX;\n\tbb_val = fw_iocmd_read(pAdapter, iocmd);\n\tif (shift != 0) {\n\t\tu32 bb_val2 = 0;\n\n\t\tbb_val >>= (shift * 8);\n\t\tiocmd.value += 4;\n\t\tbb_val2 = fw_iocmd_read(pAdapter, iocmd);\n\t\tbb_val2 <<= ((4 - shift) * 8);\n\t\tbb_val |= bb_val2;\n\t}\n\treturn bb_val;\n}\n\n \nu8 r8712_bb_reg_write(struct _adapter *pAdapter, u16 offset, u32 value)\n{\n\tu8 shift = offset & 0x0003;\t \n\tu16 bb_addr = offset & 0x0FFC;\t \n\tstruct IOCMD_STRUCT iocmd;\n\n\tiocmd.cmdclass\t= IOCMD_CLASS_BB_RF;\n\tiocmd.value\t= bb_addr;\n\tiocmd.index\t= IOCMD_BB_WRITE_IDX;\n\tif (shift != 0) {\n\t\tu32 oldValue = 0;\n\t\tu32 newValue = value;\n\n\t\toldValue = r8712_bb_reg_read(pAdapter, iocmd.value);\n\t\toldValue &= (0xFFFFFFFF >> ((4 - shift) * 8));\n\t\tvalue = oldValue | (newValue << (shift * 8));\n\t\tif (!fw_iocmd_write(pAdapter, iocmd, value))\n\t\t\treturn false;\n\t\tiocmd.value += 4;\n\t\toldValue = r8712_bb_reg_read(pAdapter, iocmd.value);\n\t\toldValue &= (0xFFFFFFFF << (shift * 8));\n\t\tvalue = oldValue | (newValue >> ((4 - shift) * 8));\n\t}\n\treturn fw_iocmd_write(pAdapter, iocmd, value);\n}\n\n \nu32 r8712_rf_reg_read(struct _adapter *pAdapter, u8 path, u8 offset)\n{\n\tu16 rf_addr = (path << 8) | offset;\n\tstruct IOCMD_STRUCT iocmd;\n\n\tiocmd.cmdclass\t= IOCMD_CLASS_BB_RF;\n\tiocmd.value\t= rf_addr;\n\tiocmd.index\t= IOCMD_RF_READ_IDX;\n\treturn fw_iocmd_read(pAdapter, iocmd);\n}\n\nu8 r8712_rf_reg_write(struct _adapter *pAdapter, u8 path, u8 offset, u32 value)\n{\n\tu16 rf_addr = (path << 8) | offset;\n\tstruct IOCMD_STRUCT iocmd;\n\n\tiocmd.cmdclass\t= IOCMD_CLASS_BB_RF;\n\tiocmd.value\t= rf_addr;\n\tiocmd.index\t= IOCMD_RF_WRIT_IDX;\n\treturn fw_iocmd_write(pAdapter, iocmd, value);\n}\n\nstatic u32 bitshift(u32 bitmask)\n{\n\tu32 i;\n\n\tfor (i = 0; i <= 31; i++)\n\t\tif (((bitmask >> i) &  0x1) == 1)\n\t\t\tbreak;\n\treturn i;\n}\n\nstatic u32 get_bb_reg(struct _adapter *pAdapter, u16 offset, u32 bitmask)\n{\n\tu32 org_value, bit_shift;\n\n\torg_value = r8712_bb_reg_read(pAdapter, offset);\n\tbit_shift = bitshift(bitmask);\n\treturn (org_value & bitmask) >> bit_shift;\n}\n\nstatic u8 set_bb_reg(struct _adapter *pAdapter,\n\t\t     u16 offset,\n\t\t     u32 bitmask,\n\t\t     u32 value)\n{\n\tu32 org_value, bit_shift, new_value;\n\n\tif (bitmask != bMaskDWord) {\n\t\torg_value = r8712_bb_reg_read(pAdapter, offset);\n\t\tbit_shift = bitshift(bitmask);\n\t\tnew_value = (org_value & (~bitmask)) | (value << bit_shift);\n\t} else {\n\t\tnew_value = value;\n\t}\n\treturn r8712_bb_reg_write(pAdapter, offset, new_value);\n}\n\nstatic u32 get_rf_reg(struct _adapter *pAdapter, u8 path, u8 offset,\n\t\t      u32 bitmask)\n{\n\tu32 org_value, bit_shift;\n\n\torg_value = r8712_rf_reg_read(pAdapter, path, offset);\n\tbit_shift = bitshift(bitmask);\n\treturn (org_value & bitmask) >> bit_shift;\n}\n\nstatic u8 set_rf_reg(struct _adapter *pAdapter, u8 path, u8 offset, u32 bitmask,\n\t      u32 value)\n{\n\tu32 org_value, bit_shift, new_value;\n\n\tif (bitmask != bMaskDWord) {\n\t\torg_value = r8712_rf_reg_read(pAdapter, path, offset);\n\t\tbit_shift = bitshift(bitmask);\n\t\tnew_value = (org_value & (~bitmask)) | (value << bit_shift);\n\t} else {\n\t\tnew_value = value;\n\t}\n\treturn r8712_rf_reg_write(pAdapter, path, offset, new_value);\n}\n\n \nvoid r8712_SetChannel(struct _adapter *pAdapter)\n{\n\tstruct cmd_priv *pcmdpriv = &pAdapter->cmdpriv;\n\tstruct cmd_obj *pcmd = NULL;\n\tstruct SetChannel_parm *pparm = NULL;\n\tu16 code = GEN_CMD_CODE(_SetChannel);\n\n\tpcmd = kmalloc(sizeof(*pcmd), GFP_ATOMIC);\n\tif (!pcmd)\n\t\treturn;\n\tpparm = kmalloc(sizeof(*pparm), GFP_ATOMIC);\n\tif (!pparm) {\n\t\tkfree(pcmd);\n\t\treturn;\n\t}\n\tpparm->curr_ch = pAdapter->mppriv.curr_ch;\n\tinit_h2fwcmd_w_parm_no_rsp(pcmd, pparm, code);\n\tr8712_enqueue_cmd(pcmdpriv, pcmd);\n}\n\nstatic void SetCCKTxPower(struct _adapter *pAdapter, u8 TxPower)\n{\n\tu16 TxAGC = 0;\n\n\tTxAGC = TxPower;\n\tset_bb_reg(pAdapter, rTxAGC_CCK_Mcs32, bTxAGCRateCCK, TxAGC);\n}\n\nstatic void SetOFDMTxPower(struct _adapter *pAdapter, u8 TxPower)\n{\n\tu32 TxAGC = 0;\n\n\tTxAGC |= ((TxPower << 24) | (TxPower << 16) | (TxPower << 8) |\n\t\t  TxPower);\n\tset_bb_reg(pAdapter, rTxAGC_Rate18_06, bTxAGCRate18_06, TxAGC);\n\tset_bb_reg(pAdapter, rTxAGC_Rate54_24, bTxAGCRate54_24, TxAGC);\n\tset_bb_reg(pAdapter, rTxAGC_Mcs03_Mcs00, bTxAGCRateMCS3_MCS0, TxAGC);\n\tset_bb_reg(pAdapter, rTxAGC_Mcs07_Mcs04, bTxAGCRateMCS7_MCS4, TxAGC);\n\tset_bb_reg(pAdapter, rTxAGC_Mcs11_Mcs08, bTxAGCRateMCS11_MCS8, TxAGC);\n\tset_bb_reg(pAdapter, rTxAGC_Mcs15_Mcs12, bTxAGCRateMCS15_MCS12, TxAGC);\n}\n\nvoid r8712_SetTxPower(struct _adapter *pAdapter)\n{\n\tu8 TxPower = pAdapter->mppriv.curr_txpoweridx;\n\n\tSetCCKTxPower(pAdapter, TxPower);\n\tSetOFDMTxPower(pAdapter, TxPower);\n}\n\nvoid r8712_SetTxAGCOffset(struct _adapter *pAdapter, u32 ulTxAGCOffset)\n{\n\tu32 TxAGCOffset_B, TxAGCOffset_C, TxAGCOffset_D, tmpAGC;\n\n\tTxAGCOffset_B = ulTxAGCOffset & 0x000000ff;\n\tTxAGCOffset_C = (ulTxAGCOffset & 0x0000ff00) >> 8;\n\tTxAGCOffset_D = (ulTxAGCOffset & 0x00ff0000) >> 16;\n\ttmpAGC = TxAGCOffset_D << 8 | TxAGCOffset_C << 4 | TxAGCOffset_B;\n\tset_bb_reg(pAdapter, rFPGA0_TxGainStage,\n\t\t\t(bXBTxAGC | bXCTxAGC | bXDTxAGC), tmpAGC);\n}\n\nvoid r8712_SetDataRate(struct _adapter *pAdapter)\n{\n\tu8 path = RF_PATH_A;\n\tu8 offset = RF_SYN_G2;\n\tu32 value;\n\n\tvalue = (pAdapter->mppriv.curr_rateidx < 4) ? 0x4440 : 0xF200;\n\tr8712_rf_reg_write(pAdapter, path, offset, value);\n}\n\nvoid r8712_SwitchBandwidth(struct _adapter *pAdapter)\n{\n\t \n\tu8 regBwOpMode = 0;\n\tu8 Bandwidth = pAdapter->mppriv.curr_bandwidth;\n\n\tregBwOpMode = r8712_read8(pAdapter, 0x10250203);\n\tif (Bandwidth == HT_CHANNEL_WIDTH_20)\n\t\tregBwOpMode |= BIT(2);\n\telse\n\t\tregBwOpMode &= ~(BIT(2));\n\tr8712_write8(pAdapter, 0x10250203, regBwOpMode);\n\t \n\tswitch (Bandwidth) {\n\t \n\tcase HT_CHANNEL_WIDTH_20:\n\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bRFMOD, 0x0);\n\t\tset_bb_reg(pAdapter, rFPGA1_RFMOD, bRFMOD, 0x0);\n\t\t \n\t\tset_bb_reg(pAdapter, rFPGA0_AnalogParameter2, bMaskDWord, 0x58);\n\t\tbreak;\n\t \n\tcase HT_CHANNEL_WIDTH_40:\n\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bRFMOD, 0x1);\n\t\tset_bb_reg(pAdapter, rFPGA1_RFMOD, bRFMOD, 0x1);\n\t\t \n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKSideBand,\n\t\t\t   (HAL_PRIME_CHNL_OFFSET_DONT_CARE >> 1));\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, 0xC00,\n\t\t\t   HAL_PRIME_CHNL_OFFSET_DONT_CARE);\n\t\tset_bb_reg(pAdapter, rFPGA0_AnalogParameter2, bMaskDWord, 0x18);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\t \n\tswitch (Bandwidth) {\n\tcase HT_CHANNEL_WIDTH_20:\n\t\tset_rf_reg(pAdapter, RF_PATH_A, RF_CHNLBW,\n\t\t\t   BIT(10) | BIT(11), 0x01);\n\t\tbreak;\n\tcase HT_CHANNEL_WIDTH_40:\n\t\tset_rf_reg(pAdapter, RF_PATH_A, RF_CHNLBW,\n\t\t\t   BIT(10) | BIT(11), 0x00);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n \nstruct R_ANTENNA_SELECT_OFDM {\n\tu32\tr_tx_antenna:4;\n\tu32\tr_ant_l:4;\n\tu32\tr_ant_non_ht:4;\n\tu32\tr_ant_ht1:4;\n\tu32\tr_ant_ht2:4;\n\tu32\tr_ant_ht_s1:4;\n\tu32\tr_ant_non_ht_s1:4;\n\tu32\tOFDM_TXSC:2;\n\tu32\tReserved:2;\n};\n\nstruct R_ANTENNA_SELECT_CCK {\n\tu8\tr_cckrx_enable_2:2;\n\tu8\tr_cckrx_enable:2;\n\tu8\tr_ccktx_enable:4;\n};\n\nvoid r8712_SwitchAntenna(struct _adapter *pAdapter)\n{\n\tu32\tofdm_tx_en_val = 0, ofdm_tx_ant_sel_val = 0;\n\tu8\tofdm_rx_ant_sel_val = 0;\n\tu8\tcck_ant_select_val = 0;\n\tu32\tcck_ant_sel_val = 0;\n\tstruct R_ANTENNA_SELECT_CCK *p_cck_txrx;\n\n\tp_cck_txrx = (struct R_ANTENNA_SELECT_CCK *)&cck_ant_select_val;\n\n\tswitch (pAdapter->mppriv.antenna_tx) {\n\tcase ANTENNA_A:\n\t\t \n\t\tset_bb_reg(pAdapter, rFPGA0_XA_HSSIParameter2, 0xe, 2);\n\t\tset_bb_reg(pAdapter, rFPGA0_XB_HSSIParameter2, 0xe, 1);\n\t\tofdm_tx_en_val = 0x3;\n\t\tofdm_tx_ant_sel_val = 0x11111111; \n\t\tp_cck_txrx->r_ccktx_enable = 0x8;\n\t\tbreak;\n\tcase ANTENNA_B:\n\t\tset_bb_reg(pAdapter, rFPGA0_XA_HSSIParameter2, 0xe, 1);\n\t\tset_bb_reg(pAdapter, rFPGA0_XB_HSSIParameter2, 0xe, 2);\n\t\tofdm_tx_en_val = 0x3;\n\t\tofdm_tx_ant_sel_val = 0x22222222; \n\t\tp_cck_txrx->r_ccktx_enable = 0x4;\n\t\tbreak;\n\tcase ANTENNA_AB:\t \n\t\tset_bb_reg(pAdapter, rFPGA0_XA_HSSIParameter2, 0xe, 2);\n\t\tset_bb_reg(pAdapter, rFPGA0_XB_HSSIParameter2, 0xe, 2);\n\t\tofdm_tx_en_val = 0x3;\n\t\tofdm_tx_ant_sel_val = 0x3321333;  \n\t\tp_cck_txrx->r_ccktx_enable = 0xC;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\t \n\tset_bb_reg(pAdapter, rFPGA1_TxInfo, 0xffffffff, ofdm_tx_ant_sel_val);\n\t \n\tset_bb_reg(pAdapter, rFPGA0_TxInfo, 0x0000000f, ofdm_tx_en_val);\n\tswitch (pAdapter->mppriv.antenna_rx) {\n\tcase ANTENNA_A:\n\t\tofdm_rx_ant_sel_val = 0x1;\t \n\t\tp_cck_txrx->r_cckrx_enable = 0x0;  \n\t\tp_cck_txrx->r_cckrx_enable_2 = 0x0;  \n\t\tbreak;\n\tcase ANTENNA_B:\n\t\tofdm_rx_ant_sel_val = 0x2;\t \n\t\tp_cck_txrx->r_cckrx_enable = 0x1;  \n\t\tp_cck_txrx->r_cckrx_enable_2 = 0x1;  \n\t\tbreak;\n\tcase ANTENNA_AB:\n\t\tofdm_rx_ant_sel_val = 0x3;  \n\t\tp_cck_txrx->r_cckrx_enable = 0x0;  \n\t\tp_cck_txrx->r_cckrx_enable_2 = 0x1;  \n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\t \n\tset_bb_reg(pAdapter, rOFDM0_TRxPathEnable, 0x0000000f,\n\t\t   ofdm_rx_ant_sel_val);\n\t \n\tset_bb_reg(pAdapter, rOFDM1_TRxPathEnable, 0x0000000f,\n\t\t   ofdm_rx_ant_sel_val);\n\n\tcck_ant_sel_val = cck_ant_select_val;\n\t \n\tset_bb_reg(pAdapter, rCCK0_AFESetting, bMaskByte3, cck_ant_sel_val);\n}\n\nstatic void TriggerRFThermalMeter(struct _adapter *pAdapter)\n{\n\t \n\tset_rf_reg(pAdapter, RF_PATH_A, RF_T_METER, bRFRegOffsetMask, 0x60);\n}\n\nstatic u32 ReadRFThermalMeter(struct _adapter *pAdapter)\n{\n\t \n\treturn get_rf_reg(pAdapter, RF_PATH_A, RF_T_METER, 0x1F);\n}\n\nvoid r8712_GetThermalMeter(struct _adapter *pAdapter, u32 *value)\n{\n\tTriggerRFThermalMeter(pAdapter);\n\tmsleep(1000);\n\t*value = ReadRFThermalMeter(pAdapter);\n}\n\nvoid r8712_SetSingleCarrierTx(struct _adapter *pAdapter, u8 bStart)\n{\n\tif (bStart) {  \n\t\t \n\t\tif (!get_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn))\n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bEnable);\n\t\t \n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, bDisable);\n\t\t \n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\n\t\t \n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bEnable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\n\t} else {  \n\t\t \n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier,\n\t\t\t   bDisable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\n\t\tmsleep(20);\n\t\t \n\t\tset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\n\t\tset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\n\t}\n}\n\nvoid r8712_SetSingleToneTx(struct _adapter *pAdapter, u8 bStart)\n{\n\tu8 rfPath;\n\n\tswitch (pAdapter->mppriv.antenna_tx) {\n\tcase ANTENNA_B:\n\t\trfPath = RF_PATH_B;\n\t\tbreak;\n\tcase ANTENNA_A:\n\tdefault:\n\t\trfPath = RF_PATH_A;\n\t\tbreak;\n\t}\n\tif (bStart) {  \n\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn, bDisable);\n\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bDisable);\n\t\tset_rf_reg(pAdapter, rfPath, RF_TX_G2, bRFRegOffsetMask,\n\t\t\t   0xd4000);\n\t\tmsleep(100);\n\t\t \n\t\tset_rf_reg(pAdapter, rfPath, RF_AC, bRFRegOffsetMask, 0x2001f);\n\t\tmsleep(100);\n\t} else {  \n\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn, bEnable);\n\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bEnable);\n\t\tset_rf_reg(pAdapter, rfPath, RF_TX_G2, bRFRegOffsetMask,\n\t\t\t   0x54000);\n\t\tmsleep(100);\n\t\t \n\t\tset_rf_reg(pAdapter, rfPath, RF_AC, bRFRegOffsetMask, 0x30000);\n\t\tmsleep(100);\n\t}\n}\n\nvoid r8712_SetCarrierSuppressionTx(struct _adapter *pAdapter, u8 bStart)\n{\n\tif (bStart) {  \n\t\tif (pAdapter->mppriv.curr_rateidx <= MPT_RATE_11M) {\n\t\t\t \n\t\t\tif (!get_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn)) {\n\t\t\t\t \n\t\t\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn,\n\t\t\t\t\t   bEnable);\n\t\t\t}\n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx,\n\t\t\t\t   bDisable);\n\t\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier,\n\t\t\t\t   bDisable);\n\t\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone,\n\t\t\t\t   bDisable);\n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, 0x2);\n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKScramble,\n\t\t\t\t   bDisable);\n\t\t\t \n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKTxRate, 0x0);\n\t\t}\n\t} else {  \n\t\tif (pAdapter->mppriv.curr_rateidx <= MPT_RATE_11M) {\n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, 0x0);\n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKScramble,\n\t\t\t\t   bEnable);\n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\n\t\t\tset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\n\t\t}\n\t}\n}\n\nstatic void SetCCKContinuousTx(struct _adapter *pAdapter, u8 bStart)\n{\n\tu32 cckrate;\n\n\tif (bStart) {\n\t\t \n\t\tif (!get_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn)) {\n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn, bEnable);\n\t\t}\n\t\t \n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bDisable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\n\t\t \n\t\tcckrate  = pAdapter->mppriv.curr_rateidx;\n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKTxRate, cckrate);\n\t\t \n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, 0x2);\n\t\t \n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\n\t} else {\n\t\t \n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, 0x0);\n\t\t \n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\n\t\t \n\t\tset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\n\t\tset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\n\t}\n}  \n\nstatic void SetOFDMContinuousTx(struct _adapter *pAdapter, u8 bStart)\n{\n\tif (bStart) {\n\t\t \n\t\tif (!get_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn)) {\n\t\t\t \n\t\t\tset_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bEnable);\n\t\t}\n\t\t \n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, bDisable);\n\t\t \n\t\tset_bb_reg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\n\t\t \n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bEnable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bDisable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\n\t} else {\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier,\n\t\t\t   bDisable);\n\t\tset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\n\t\tmsleep(20);\n\t\t \n\t\tset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\n\t\tset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\n\t}\n}  \n\nvoid r8712_SetContinuousTx(struct _adapter *pAdapter, u8 bStart)\n{\n\t \n\tif (bStart) {\n\t\tr8712_bb_reg_write(pAdapter, rRx_Wait_CCCA,\n\t\t\t\t   r8712_bb_reg_read(pAdapter,\n\t\t\t\t   rRx_Wait_CCCA) & 0xFE1FFFFF);\n\t\tmsleep(100);\n\t}\n\tif (pAdapter->mppriv.curr_rateidx <= MPT_RATE_11M)\n\t\tSetCCKContinuousTx(pAdapter, bStart);\n\telse if ((pAdapter->mppriv.curr_rateidx >= MPT_RATE_6M) &&\n\t\t (pAdapter->mppriv.curr_rateidx <= MPT_RATE_MCS15))\n\t\tSetOFDMContinuousTx(pAdapter, bStart);\n\t \n\tif (!bStart)\n\t\tr8712_bb_reg_write(pAdapter, rRx_Wait_CCCA,\n\t\t\t\t   r8712_bb_reg_read(pAdapter,\n\t\t\t\t   rRx_Wait_CCCA) | 0x01E00000);\n}\n\nvoid r8712_ResetPhyRxPktCount(struct _adapter *pAdapter)\n{\n\tu32 i, phyrx_set = 0;\n\n\tfor (i = OFDM_PPDU_BIT; i <= HT_MPDU_FAIL_BIT; i++) {\n\t\tphyrx_set = 0;\n\t\tphyrx_set |= (i << 28);\t\t \n\t\tphyrx_set |= 0x08000000;\t \n\t\tr8712_write32(pAdapter, RXERR_RPT, phyrx_set);\n\t}\n}\n\nstatic u32 GetPhyRxPktCounts(struct _adapter *pAdapter, u32 selbit)\n{\n\t \n\tu32 phyrx_set = 0;\n\tu32 SelectBit;\n\n\tSelectBit = selbit << 28;\n\tphyrx_set |= (SelectBit & 0xF0000000);\n\tr8712_write32(pAdapter, RXERR_RPT, phyrx_set);\n\t \n\treturn r8712_read32(pAdapter, RXERR_RPT) & RPTMaxCount;\n}\n\nu32 r8712_GetPhyRxPktReceived(struct _adapter *pAdapter)\n{\n\tu32 OFDM_cnt = GetPhyRxPktCounts(pAdapter, OFDM_MPDU_OK_BIT);\n\tu32 CCK_cnt  = GetPhyRxPktCounts(pAdapter, CCK_MPDU_OK_BIT);\n\tu32 HT_cnt   = GetPhyRxPktCounts(pAdapter, HT_MPDU_OK_BIT);\n\n\treturn OFDM_cnt + CCK_cnt + HT_cnt;\n}\n\nu32 r8712_GetPhyRxPktCRC32Error(struct _adapter *pAdapter)\n{\n\tu32 OFDM_cnt = GetPhyRxPktCounts(pAdapter, OFDM_MPDU_FAIL_BIT);\n\tu32 CCK_cnt  = GetPhyRxPktCounts(pAdapter, CCK_MPDU_FAIL_BIT);\n\tu32 HT_cnt   = GetPhyRxPktCounts(pAdapter, HT_MPDU_FAIL_BIT);\n\n\treturn OFDM_cnt + CCK_cnt + HT_cnt;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}