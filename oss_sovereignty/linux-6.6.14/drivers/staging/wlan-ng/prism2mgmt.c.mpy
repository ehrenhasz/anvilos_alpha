{
  "module_name": "prism2mgmt.c",
  "hash_id": "6f6930527c3ab913776fab7a5a970d637ed87150e6fc984104a436894c9e8138",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/wlan-ng/prism2mgmt.c",
  "human_readable_source": "\n \n\n#include <linux/if_arp.h>\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/wait.h>\n#include <linux/sched.h>\n#include <linux/types.h>\n#include <linux/wireless.h>\n#include <linux/netdevice.h>\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <asm/byteorder.h>\n#include <linux/random.h>\n#include <linux/usb.h>\n#include <linux/bitops.h>\n\n#include \"p80211types.h\"\n#include \"p80211hdr.h\"\n#include \"p80211mgmt.h\"\n#include \"p80211conv.h\"\n#include \"p80211msg.h\"\n#include \"p80211netdev.h\"\n#include \"p80211metadef.h\"\n#include \"p80211metastruct.h\"\n#include \"hfa384x.h\"\n#include \"prism2mgmt.h\"\n\n \nstatic inline u16 p80211rate_to_p2bit(u32 rate)\n{\n\tswitch (rate & ~BIT(7)) {\n\tcase 2:\n\t\treturn BIT(0);\n\tcase 4:\n\t\treturn BIT(1);\n\tcase 11:\n\t\treturn BIT(2);\n\tcase 22:\n\t\treturn BIT(3);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\n \nint prism2mgmt_scan(struct wlandevice *wlandev, void *msgp)\n{\n\tint result = 0;\n\tstruct hfa384x *hw = wlandev->priv;\n\tstruct p80211msg_dot11req_scan *msg = msgp;\n\tu16 roamingmode, word;\n\tint i, timeout;\n\tint istmpenable = 0;\n\n\tstruct hfa384x_host_scan_request_data scanreq;\n\n\t \n\tif (HFA384x_FIRMWARE_VERSION(hw->ident_sta_fw.major,\n\t\t\t\t     hw->ident_sta_fw.minor,\n\t\t\t\t     hw->ident_sta_fw.variant) <\n\t    HFA384x_FIRMWARE_VERSION(1, 3, 2)) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"HostScan not supported with current firmware (<1.3.2).\\n\");\n\t\tresult = 1;\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_not_supported;\n\t\tgoto exit;\n\t}\n\n\tmemset(&scanreq, 0, sizeof(scanreq));\n\n\t \n\tresult = hfa384x_drvr_getconfig16(hw,\n\t\t\t\t\t  HFA384x_RID_CNFROAMINGMODE,\n\t\t\t\t\t  &roamingmode);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"getconfig(ROAMMODE) failed. result=%d\\n\", result);\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tgoto exit;\n\t}\n\n\t \n\tresult = hfa384x_drvr_setconfig16(hw,\n\t\t\t\t\t  HFA384x_RID_CNFROAMINGMODE,\n\t\t\t\t\t  HFA384x_ROAMMODE_HOSTSCAN_HOSTROAM);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"setconfig(ROAMINGMODE) failed. result=%d\\n\",\n\t\t\t   result);\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tgoto exit;\n\t}\n\n\t \n\tif (HFA384x_FIRMWARE_VERSION(hw->ident_sta_fw.major,\n\t\t\t\t     hw->ident_sta_fw.minor,\n\t\t\t\t     hw->ident_sta_fw.variant) >\n\t    HFA384x_FIRMWARE_VERSION(1, 5, 0)) {\n\t\tif (msg->scantype.data != P80211ENUM_scantype_active)\n\t\t\tword = msg->maxchanneltime.data;\n\t\telse\n\t\t\tword = 0;\n\n\t\tresult =\n\t\t    hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFPASSIVESCANCTRL,\n\t\t\t\t\t     word);\n\t\tif (result) {\n\t\t\tnetdev_warn(wlandev->netdev,\n\t\t\t\t    \"Passive scan not supported with current firmware.  (<1.5.1)\\n\");\n\t\t}\n\t}\n\n\t \n\tword = HFA384x_RATEBIT_2;\n\tscanreq.tx_rate = cpu_to_le16(word);\n\n\t \n\tword = 0;\n\tfor (i = 0; i < msg->channellist.data.len; i++) {\n\t\tu8 channel = msg->channellist.data.data[i];\n\n\t\tif (channel > 14)\n\t\t\tcontinue;\n\t\t \n\t\tword |= (1 << (channel - 1));\n\t}\n\tscanreq.channel_list = cpu_to_le16(word);\n\n\t \n\tscanreq.ssid.len = cpu_to_le16(msg->ssid.data.len);\n\tmemcpy(scanreq.ssid.data, msg->ssid.data.data, msg->ssid.data.len);\n\n\t \n\tresult = hfa384x_drvr_getconfig16(hw, HFA384x_RID_PORTSTATUS, &word);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"getconfig(PORTSTATUS) failed. result=%d\\n\", result);\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tgoto exit;\n\t}\n\tif (word == HFA384x_PORTSTATUS_DISABLED) {\n\t\t__le16 wordbuf[17];\n\n\t\tresult = hfa384x_drvr_setconfig16(hw,\n\t\t\t\t\t\t  HFA384x_RID_CNFROAMINGMODE,\n\t\t\t\t\t\t  HFA384x_ROAMMODE_HOSTSCAN_HOSTROAM);\n\t\tif (result) {\n\t\t\tnetdev_err(wlandev->netdev,\n\t\t\t\t   \"setconfig(ROAMINGMODE) failed. result=%d\\n\",\n\t\t\t\t   result);\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t\tgoto exit;\n\t\t}\n\t\t \n\t\twordbuf[0] = cpu_to_le16(WLAN_SSID_MAXLEN);\n\t\tget_random_bytes(&wordbuf[1], WLAN_SSID_MAXLEN);\n\t\tresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFOWNSSID,\n\t\t\t\t\t\twordbuf,\n\t\t\t\t\t\tHFA384x_RID_CNFOWNSSID_LEN);\n\t\tif (result) {\n\t\t\tnetdev_err(wlandev->netdev, \"Failed to set OwnSSID.\\n\");\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t\tgoto exit;\n\t\t}\n\t\tresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFDESIREDSSID,\n\t\t\t\t\t\twordbuf,\n\t\t\t\t\t\tHFA384x_RID_CNFDESIREDSSID_LEN);\n\t\tif (result) {\n\t\t\tnetdev_err(wlandev->netdev,\n\t\t\t\t   \"Failed to set DesiredSSID.\\n\");\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t\tgoto exit;\n\t\t}\n\t\t \n\t\tresult = hfa384x_drvr_setconfig16(hw,\n\t\t\t\t\t\t  HFA384x_RID_CNFPORTTYPE,\n\t\t\t\t\t\t  HFA384x_PORTTYPE_IBSS);\n\t\tif (result) {\n\t\t\tnetdev_err(wlandev->netdev,\n\t\t\t\t   \"Failed to set CNFPORTTYPE.\\n\");\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t\tgoto exit;\n\t\t}\n\t\t \n\t\tresult = hfa384x_drvr_setconfig16(hw,\n\t\t\t\t\t\t  HFA384x_RID_CREATEIBSS,\n\t\t\t\t\t\t  HFA384x_CREATEIBSS_JOINCREATEIBSS);\n\t\tif (result) {\n\t\t\tnetdev_err(wlandev->netdev,\n\t\t\t\t   \"Failed to set CREATEIBSS.\\n\");\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t\tgoto exit;\n\t\t}\n\t\tresult = hfa384x_drvr_enable(hw, 0);\n\t\tif (result) {\n\t\t\tnetdev_err(wlandev->netdev,\n\t\t\t\t   \"drvr_enable(0) failed. result=%d\\n\",\n\t\t\t\t   result);\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t\tgoto exit;\n\t\t}\n\t\tistmpenable = 1;\n\t}\n\n\t \n\ttimeout = msg->channellist.data.len * msg->maxchanneltime.data;\n\ttimeout = (timeout * HZ) / 1000;\n\n\t \n\thw->scanflag = 0;\n\n\tresult = hfa384x_drvr_setconfig(hw,\n\t\t\t\t\tHFA384x_RID_HOSTSCAN, &scanreq,\n\t\t\t\t\tsizeof(scanreq));\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"setconfig(SCANREQUEST) failed. result=%d\\n\",\n\t\t\t   result);\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tgoto exit;\n\t}\n\n\t \n\twait_event_interruptible_timeout(hw->cmdq, hw->scanflag, timeout);\n\n\tmsg->numbss.status = P80211ENUM_msgitem_status_data_ok;\n\tif (hw->scanflag == -1)\n\t\thw->scanflag = 0;\n\n\tmsg->numbss.data = hw->scanflag;\n\n\thw->scanflag = 0;\n\n\t \n\tif (istmpenable) {\n\t\tresult = hfa384x_drvr_disable(hw, 0);\n\t\tif (result) {\n\t\t\tnetdev_err(wlandev->netdev,\n\t\t\t\t   \"drvr_disable(0) failed. result=%d\\n\",\n\t\t\t\t   result);\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t\tgoto exit;\n\t\t}\n\t}\n\n\t \n\tresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFROAMINGMODE,\n\t\t\t\t\t  roamingmode);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"setconfig(ROAMMODE) failed. result=%d\\n\", result);\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tgoto exit;\n\t}\n\n\tresult = 0;\n\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\nexit:\n\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\n\treturn result;\n}\n\n \nint prism2mgmt_scan_results(struct wlandevice *wlandev, void *msgp)\n{\n\tint result = 0;\n\tstruct p80211msg_dot11req_scan_results *req;\n\tstruct hfa384x *hw = wlandev->priv;\n\tstruct hfa384x_hscan_result_sub *item = NULL;\n\n\tint count;\n\n\treq = msgp;\n\n\treq->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\n\tif (!hw->scanresults) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"dot11req_scan_results can only be used after a successful dot11req_scan.\\n\");\n\t\tresult = 2;\n\t\treq->resultcode.data = P80211ENUM_resultcode_invalid_parameters;\n\t\tgoto exit;\n\t}\n\n\tcount = (hw->scanresults->framelen - 3) / 32;\n\tif (count > HFA384x_SCANRESULT_MAX)\n\t\tcount = HFA384x_SCANRESULT_MAX;\n\n\tif (req->bssindex.data >= count) {\n\t\tnetdev_dbg(wlandev->netdev,\n\t\t\t   \"requested index (%d) out of range (%d)\\n\",\n\t\t\t   req->bssindex.data, count);\n\t\tresult = 2;\n\t\treq->resultcode.data = P80211ENUM_resultcode_invalid_parameters;\n\t\tgoto exit;\n\t}\n\n\titem = &hw->scanresults->info.hscanresult.result[req->bssindex.data];\n\t \n\treq->signal.status = P80211ENUM_msgitem_status_data_ok;\n\treq->noise.status = P80211ENUM_msgitem_status_data_ok;\n\treq->signal.data = le16_to_cpu(item->sl);\n\treq->noise.data = le16_to_cpu(item->anl);\n\n\t \n\treq->bssid.status = P80211ENUM_msgitem_status_data_ok;\n\treq->bssid.data.len = WLAN_BSSID_LEN;\n\tmemcpy(req->bssid.data.data, item->bssid, WLAN_BSSID_LEN);\n\n\t \n\treq->ssid.status = P80211ENUM_msgitem_status_data_ok;\n\treq->ssid.data.len = le16_to_cpu(item->ssid.len);\n\treq->ssid.data.len = min_t(u16, req->ssid.data.len, WLAN_SSID_MAXLEN);\n\tmemcpy(req->ssid.data.data, item->ssid.data, req->ssid.data.len);\n\n\t \n\tfor (count = 0; count < 10; count++)\n\t\tif (item->supprates[count] == 0)\n\t\t\tbreak;\n\n\tfor (int i = 0; i < 8; i++) {\n\t\tif (count > i &&\n\t\t    DOT11_RATE5_ISBASIC_GET(item->supprates[i])) {\n\t\t\treq->basicrate[i].data = item->supprates[i];\n\t\t\treq->basicrate[i].status =\n\t\t\t\tP80211ENUM_msgitem_status_data_ok;\n\t\t}\n\t}\n\n\tfor (int i = 0; i < 8; i++) {\n\t\tif (count > i) {\n\t\t\treq->supprate[i].data = item->supprates[i];\n\t\t\treq->supprate[i].status =\n\t\t\t\tP80211ENUM_msgitem_status_data_ok;\n\t\t}\n\t}\n\n\t \n\treq->beaconperiod.status = P80211ENUM_msgitem_status_data_ok;\n\treq->beaconperiod.data = le16_to_cpu(item->bcnint);\n\n\t \n\treq->timestamp.status = P80211ENUM_msgitem_status_data_ok;\n\treq->timestamp.data = jiffies;\n\treq->localtime.status = P80211ENUM_msgitem_status_data_ok;\n\treq->localtime.data = jiffies;\n\n\t \n\treq->ibssatimwindow.status = P80211ENUM_msgitem_status_data_ok;\n\treq->ibssatimwindow.data = le16_to_cpu(item->atim);\n\n\t \n\treq->dschannel.status = P80211ENUM_msgitem_status_data_ok;\n\treq->dschannel.data = le16_to_cpu(item->chid);\n\n\t \n\tcount = le16_to_cpu(item->capinfo);\n\treq->capinfo.status = P80211ENUM_msgitem_status_data_ok;\n\treq->capinfo.data = count;\n\n\t \n\treq->privacy.status = P80211ENUM_msgitem_status_data_ok;\n\treq->privacy.data = WLAN_GET_MGMT_CAP_INFO_PRIVACY(count);\n\n\t \n\treq->cfpollable.status = P80211ENUM_msgitem_status_data_ok;\n\treq->cfpollable.data = WLAN_GET_MGMT_CAP_INFO_CFPOLLABLE(count);\n\n\t \n\treq->cfpollreq.status = P80211ENUM_msgitem_status_data_ok;\n\treq->cfpollreq.data = WLAN_GET_MGMT_CAP_INFO_CFPOLLREQ(count);\n\n\t \n\treq->bsstype.status = P80211ENUM_msgitem_status_data_ok;\n\treq->bsstype.data = (WLAN_GET_MGMT_CAP_INFO_ESS(count)) ?\n\t    P80211ENUM_bsstype_infrastructure : P80211ENUM_bsstype_independent;\n\n\tresult = 0;\n\treq->resultcode.data = P80211ENUM_resultcode_success;\n\nexit:\n\treturn result;\n}\n\n \nint prism2mgmt_start(struct wlandevice *wlandev, void *msgp)\n{\n\tint result = 0;\n\tstruct hfa384x *hw = wlandev->priv;\n\tstruct p80211msg_dot11req_start *msg = msgp;\n\n\tstruct p80211pstrd *pstr;\n\tu8 bytebuf[80];\n\tstruct hfa384x_bytestr *p2bytestr = (struct hfa384x_bytestr *)bytebuf;\n\tu16 word;\n\n\twlandev->macmode = WLAN_MACMODE_NONE;\n\n\t \n\tmemcpy(&wlandev->ssid, &msg->ssid.data, sizeof(msg->ssid.data));\n\n\t \n\t \n\tif (HFA384x_FIRMWARE_VERSION(hw->ident_sta_fw.major,\n\t\t\t\t     hw->ident_sta_fw.minor,\n\t\t\t\t     hw->ident_sta_fw.variant) <\n\t    HFA384x_FIRMWARE_VERSION(0, 8, 3)) {\n\t\t \n\t\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_not_supported;\n\t\tgoto done;\n\t}\n\n\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\n\t \n\t \n\t \n\tpstr = (struct p80211pstrd *)&msg->ssid.data;\n\tprism2mgmt_pstr2bytestr(p2bytestr, pstr);\n\tresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFOWNSSID,\n\t\t\t\t\tbytebuf, HFA384x_RID_CNFOWNSSID_LEN);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev, \"Failed to set CnfOwnSSID\\n\");\n\t\tgoto failed;\n\t}\n\tresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFDESIREDSSID,\n\t\t\t\t\tbytebuf,\n\t\t\t\t\tHFA384x_RID_CNFDESIREDSSID_LEN);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev, \"Failed to set CnfDesiredSSID\\n\");\n\t\tgoto failed;\n\t}\n\n\t \n\t \n\thfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFPORTTYPE, 0);\n\n\t \n\tword = msg->beaconperiod.data;\n\tresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFAPBCNINT, word);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"Failed to set beacon period=%d.\\n\", word);\n\t\tgoto failed;\n\t}\n\n\t \n\tword = msg->dschannel.data;\n\tresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFOWNCHANNEL, word);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"Failed to set channel=%d.\\n\", word);\n\t\tgoto failed;\n\t}\n\t \n\tword = p80211rate_to_p2bit(msg->basicrate1.data);\n\tif (msg->basicrate2.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->basicrate2.data);\n\n\tif (msg->basicrate3.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->basicrate3.data);\n\n\tif (msg->basicrate4.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->basicrate4.data);\n\n\tif (msg->basicrate5.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->basicrate5.data);\n\n\tif (msg->basicrate6.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->basicrate6.data);\n\n\tif (msg->basicrate7.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->basicrate7.data);\n\n\tif (msg->basicrate8.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->basicrate8.data);\n\n\tresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFBASICRATES, word);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"Failed to set basicrates=%d.\\n\", word);\n\t\tgoto failed;\n\t}\n\n\t \n\tword = p80211rate_to_p2bit(msg->operationalrate1.data);\n\tif (msg->operationalrate2.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->operationalrate2.data);\n\n\tif (msg->operationalrate3.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->operationalrate3.data);\n\n\tif (msg->operationalrate4.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->operationalrate4.data);\n\n\tif (msg->operationalrate5.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->operationalrate5.data);\n\n\tif (msg->operationalrate6.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->operationalrate6.data);\n\n\tif (msg->operationalrate7.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->operationalrate7.data);\n\n\tif (msg->operationalrate8.status == P80211ENUM_msgitem_status_data_ok)\n\t\tword |= p80211rate_to_p2bit(msg->operationalrate8.data);\n\n\tresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFSUPPRATES, word);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"Failed to set supprates=%d.\\n\", word);\n\t\tgoto failed;\n\t}\n\n\tresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_TXRATECNTL, word);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev, \"Failed to set txrates=%d.\\n\",\n\t\t\t   word);\n\t\tgoto failed;\n\t}\n\n\t \n\tif (msg->bsstype.data == P80211ENUM_bsstype_independent) {\n\t\twlandev->macmode = WLAN_MACMODE_IBSS_STA;\n\t\t \n\t\thfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFMAXDATALEN, 2304);\n\t}\n\n\t \n\tresult = hfa384x_drvr_enable(hw, 0);\n\tif (result) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"Enable macport failed, result=%d.\\n\", result);\n\t\tgoto failed;\n\t}\n\n\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\n\tgoto done;\nfailed:\n\tnetdev_dbg(wlandev->netdev,\n\t\t   \"Failed to set a config option, result=%d\\n\", result);\n\tmsg->resultcode.data = P80211ENUM_resultcode_invalid_parameters;\n\ndone:\n\treturn 0;\n}\n\n \nint prism2mgmt_readpda(struct wlandevice *wlandev, void *msgp)\n{\n\tstruct hfa384x *hw = wlandev->priv;\n\tstruct p80211msg_p2req_readpda *msg = msgp;\n\tint result;\n\n\t \n\tif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"PDA may only be read in the fwload state.\\n\");\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\t} else {\n\t\t \n\t\tresult = hfa384x_drvr_readpda(hw,\n\t\t\t\t\t      msg->pda.data,\n\t\t\t\t\t      HFA384x_PDA_LEN_MAX);\n\t\tif (result) {\n\t\t\tnetdev_err(wlandev->netdev,\n\t\t\t\t   \"hfa384x_drvr_readpda() failed, result=%d\\n\",\n\t\t\t\t   result);\n\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t\tmsg->resultcode.status =\n\t\t\t    P80211ENUM_msgitem_status_data_ok;\n\t\t\treturn 0;\n\t\t}\n\t\tmsg->pda.status = P80211ENUM_msgitem_status_data_ok;\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\t\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\t}\n\n\treturn 0;\n}\n\n \nint prism2mgmt_ramdl_state(struct wlandevice *wlandev, void *msgp)\n{\n\tstruct hfa384x *hw = wlandev->priv;\n\tstruct p80211msg_p2req_ramdl_state *msg = msgp;\n\n\tif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"ramdl_state(): may only be called in the fwload state.\\n\");\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\t\treturn 0;\n\t}\n\n\t \n\n\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\tif (msg->enable.data == P80211ENUM_truth_true) {\n\t\tif (hfa384x_drvr_ramdl_enable(hw, msg->exeaddr.data)) {\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t} else {\n\t\t\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\t\t}\n\t} else {\n\t\thfa384x_drvr_ramdl_disable(hw);\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\t}\n\n\treturn 0;\n}\n\n \nint prism2mgmt_ramdl_write(struct wlandevice *wlandev, void *msgp)\n{\n\tstruct hfa384x *hw = wlandev->priv;\n\tstruct p80211msg_p2req_ramdl_write *msg = msgp;\n\tu32 addr;\n\tu32 len;\n\tu8 *buf;\n\n\tif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"ramdl_write(): may only be called in the fwload state.\\n\");\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\t\treturn 0;\n\t}\n\n\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\t \n\tif (msg->len.data > sizeof(msg->data.data)) {\n\t\tmsg->resultcode.status =\n\t\t    P80211ENUM_resultcode_invalid_parameters;\n\t\treturn 0;\n\t}\n\t \n\taddr = msg->addr.data;\n\tlen = msg->len.data;\n\tbuf = msg->data.data;\n\tif (hfa384x_drvr_ramdl_write(hw, addr, buf, len))\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_refused;\n\n\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\n\treturn 0;\n}\n\n \nint prism2mgmt_flashdl_state(struct wlandevice *wlandev, void *msgp)\n{\n\tint result = 0;\n\tstruct hfa384x *hw = wlandev->priv;\n\tstruct p80211msg_p2req_flashdl_state *msg = msgp;\n\n\tif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"flashdl_state(): may only be called in the fwload state.\\n\");\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\t\treturn 0;\n\t}\n\n\t \n\n\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\tif (msg->enable.data == P80211ENUM_truth_true) {\n\t\tif (hfa384x_drvr_flashdl_enable(hw)) {\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t} else {\n\t\t\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\t\t}\n\t} else {\n\t\thfa384x_drvr_flashdl_disable(hw);\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\t\t \n\t\twlandev->msdstate = WLAN_MSD_HWPRESENT;\n\t\tresult = prism2sta_ifstate(wlandev, P80211ENUM_ifstate_fwload);\n\t\tif (result != P80211ENUM_resultcode_success) {\n\t\t\tnetdev_err(wlandev->netdev,\n\t\t\t\t   \"prism2sta_ifstate(fwload) failed, P80211ENUM_resultcode=%d\\n\",\n\t\t\t\t   result);\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\t\tresult = -1;\n\t\t}\n\t}\n\n\treturn result;\n}\n\n \nint prism2mgmt_flashdl_write(struct wlandevice *wlandev, void *msgp)\n{\n\tstruct hfa384x *hw = wlandev->priv;\n\tstruct p80211msg_p2req_flashdl_write *msg = msgp;\n\tu32 addr;\n\tu32 len;\n\tu8 *buf;\n\n\tif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\n\t\tnetdev_err(wlandev->netdev,\n\t\t\t   \"flashdl_write(): may only be called in the fwload state.\\n\");\n\t\tmsg->resultcode.data =\n\t\t    P80211ENUM_resultcode_implementation_failure;\n\t\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\t\treturn 0;\n\t}\n\n\t \n\n\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\t \n\tif (msg->len.data > sizeof(msg->data.data)) {\n\t\tmsg->resultcode.status =\n\t\t    P80211ENUM_resultcode_invalid_parameters;\n\t\treturn 0;\n\t}\n\t \n\taddr = msg->addr.data;\n\tlen = msg->len.data;\n\tbuf = msg->data.data;\n\tif (hfa384x_drvr_flashdl_write(hw, addr, buf, len))\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_refused;\n\n\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\n\treturn 0;\n}\n\n \nint prism2mgmt_autojoin(struct wlandevice *wlandev, void *msgp)\n{\n\tstruct hfa384x *hw = wlandev->priv;\n\tint result = 0;\n\tu16 reg;\n\tu16 port_type;\n\tstruct p80211msg_lnxreq_autojoin *msg = msgp;\n\tstruct p80211pstrd *pstr;\n\tu8 bytebuf[256];\n\tstruct hfa384x_bytestr *p2bytestr = (struct hfa384x_bytestr *)bytebuf;\n\n\twlandev->macmode = WLAN_MACMODE_NONE;\n\n\t \n\tmemcpy(&wlandev->ssid, &msg->ssid.data, sizeof(msg->ssid.data));\n\n\t \n\thfa384x_drvr_disable(hw, 0);\n\n\t \n\t \n\thfa384x_drvr_setconfig16(hw, HFA384x_RID_TXRATECNTL, 0x000f);\n\n\t \n\tif (msg->authtype.data == P80211ENUM_authalg_sharedkey)\n\t\treg = HFA384x_CNFAUTHENTICATION_SHAREDKEY;\n\telse\n\t\treg = HFA384x_CNFAUTHENTICATION_OPENSYSTEM;\n\n\thfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFAUTHENTICATION, reg);\n\n\t \n\tmemset(bytebuf, 0, 256);\n\tpstr = (struct p80211pstrd *)&msg->ssid.data;\n\tprism2mgmt_pstr2bytestr(p2bytestr, pstr);\n\tresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFDESIREDSSID,\n\t\t\t\t\tbytebuf,\n\t\t\t\t\tHFA384x_RID_CNFDESIREDSSID_LEN);\n\tport_type = HFA384x_PORTTYPE_BSS;\n\t \n\thfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFPORTTYPE, port_type);\n\n\t \n\thfa384x_drvr_enable(hw, 0);\n\n\t \n\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\n\treturn result;\n}\n\n \nint prism2mgmt_wlansniff(struct wlandevice *wlandev, void *msgp)\n{\n\tint result = 0;\n\tstruct p80211msg_lnxreq_wlansniff *msg = msgp;\n\n\tstruct hfa384x *hw = wlandev->priv;\n\tu16 word;\n\n\tmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\n\tswitch (msg->enable.data) {\n\tcase P80211ENUM_truth_false:\n\t\t \n\t\tif (wlandev->netdev->type == ARPHRD_ETHER) {\n\t\t\tmsg->resultcode.data =\n\t\t\t    P80211ENUM_resultcode_invalid_parameters;\n\t\t\treturn 0;\n\t\t}\n\t\t \n\t\tresult = hfa384x_cmd_monitor(hw, HFA384x_MONITOR_DISABLE);\n\t\tif (result) {\n\t\t\tnetdev_dbg(wlandev->netdev,\n\t\t\t\t   \"failed to disable monitor mode, result=%d\\n\",\n\t\t\t\t   result);\n\t\t\tgoto failed;\n\t\t}\n\t\t \n\t\tresult = hfa384x_drvr_disable(hw, 0);\n\t\tif (result) {\n\t\t\tnetdev_dbg\n\t\t\t(wlandev->netdev,\n\t\t\t     \"failed to disable port 0 after sniffing, result=%d\\n\",\n\t\t\t     result);\n\t\t\tgoto failed;\n\t\t}\n\t\t \n\t\twlandev->netdev->type = ARPHRD_ETHER;\n\n\t\t \n\t\tresult = hfa384x_drvr_setconfig16(hw,\n\t\t\t\t\t\t  HFA384x_RID_CNFWEPFLAGS,\n\t\t\t\t\t\t  hw->presniff_wepflags);\n\t\tif (result) {\n\t\t\tnetdev_dbg\n\t\t\t    (wlandev->netdev,\n\t\t\t     \"failed to restore wepflags=0x%04x, result=%d\\n\",\n\t\t\t     hw->presniff_wepflags, result);\n\t\t\tgoto failed;\n\t\t}\n\n\t\t \n\t\tif (hw->presniff_port_type != 0) {\n\t\t\tword = hw->presniff_port_type;\n\t\t\tresult = hfa384x_drvr_setconfig16(hw,\n\t\t\t\t\t\t\t  HFA384x_RID_CNFPORTTYPE,\n\t\t\t\t\t\t\t  word);\n\t\t\tif (result) {\n\t\t\t\tnetdev_dbg\n\t\t\t\t    (wlandev->netdev,\n\t\t\t\t     \"failed to restore porttype, result=%d\\n\",\n\t\t\t\t     result);\n\t\t\t\tgoto failed;\n\t\t\t}\n\n\t\t\t \n\t\t\tresult = hfa384x_drvr_enable(hw, 0);\n\t\t\tif (result) {\n\t\t\t\tnetdev_dbg(wlandev->netdev,\n\t\t\t\t\t   \"failed to enable port to presniff setting, result=%d\\n\",\n\t\t\t\t\t   result);\n\t\t\t\tgoto failed;\n\t\t\t}\n\t\t} else {\n\t\t\tresult = hfa384x_drvr_disable(hw, 0);\n\t\t}\n\n\t\tnetdev_info(wlandev->netdev, \"monitor mode disabled\\n\");\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\t\treturn 0;\n\tcase P80211ENUM_truth_true:\n\t\t \n\t\tif (hw->port_enabled[0]) {\n\t\t\tif (wlandev->netdev->type == ARPHRD_ETHER) {\n\t\t\t\t \n\t\t\t\tresult = hfa384x_drvr_getconfig16(hw,\n\t\t\t\t\t\t\t\t  HFA384x_RID_CNFPORTTYPE,\n\t\t\t\t\t\t\t\t  &hw->presniff_port_type);\n\t\t\t\tif (result) {\n\t\t\t\t\tnetdev_dbg\n\t\t\t\t\t(wlandev->netdev,\n\t\t\t\t\t     \"failed to read porttype, result=%d\\n\",\n\t\t\t\t\t     result);\n\t\t\t\t\tgoto failed;\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\tresult = hfa384x_drvr_getconfig16(hw,\n\t\t\t\t\t\t\t\t  HFA384x_RID_CNFWEPFLAGS,\n\t\t\t\t\t\t\t\t  &hw->presniff_wepflags);\n\t\t\t\tif (result) {\n\t\t\t\t\tnetdev_dbg\n\t\t\t\t\t(wlandev->netdev,\n\t\t\t\t\t     \"failed to read wepflags, result=%d\\n\",\n\t\t\t\t\t     result);\n\t\t\t\t\tgoto failed;\n\t\t\t\t}\n\t\t\t\thfa384x_drvr_stop(hw);\n\t\t\t\tresult = hfa384x_drvr_start(hw);\n\t\t\t\tif (result) {\n\t\t\t\t\tnetdev_dbg(wlandev->netdev,\n\t\t\t\t\t\t   \"failed to restart the card for sniffing, result=%d\\n\",\n\t\t\t\t\t\t   result);\n\t\t\t\t\tgoto failed;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tresult = hfa384x_drvr_disable(hw, 0);\n\t\t\t\tif (result) {\n\t\t\t\t\tnetdev_dbg(wlandev->netdev,\n\t\t\t\t\t\t   \"failed to enable port for sniffing, result=%d\\n\",\n\t\t\t\t\t\t   result);\n\t\t\t\t\tgoto failed;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\thw->presniff_port_type = 0;\n\t\t}\n\n\t\t \n\t\tword = msg->channel.data;\n\t\tresult = hfa384x_drvr_setconfig16(hw,\n\t\t\t\t\t\t  HFA384x_RID_CNFOWNCHANNEL,\n\t\t\t\t\t\t  word);\n\t\thw->sniff_channel = word;\n\n\t\tif (result) {\n\t\t\tnetdev_dbg(wlandev->netdev,\n\t\t\t\t   \"failed to set channel %d, result=%d\\n\",\n\t\t\t\t   word, result);\n\t\t\tgoto failed;\n\t\t}\n\n\t\t \n\t\tif (wlandev->netdev->type != ARPHRD_ETHER) {\n\t\t\t \n\t\t\tword = HFA384x_PORTTYPE_PSUEDOIBSS;\n\t\t\tresult = hfa384x_drvr_setconfig16(hw,\n\t\t\t\t\t\t\t  HFA384x_RID_CNFPORTTYPE,\n\t\t\t\t\t\t\t  word);\n\t\t\tif (result) {\n\t\t\t\tnetdev_dbg\n\t\t\t\t    (wlandev->netdev,\n\t\t\t\t     \"failed to set porttype %d, result=%d\\n\",\n\t\t\t\t     word, result);\n\t\t\t\tgoto failed;\n\t\t\t}\n\t\t\tif ((msg->keepwepflags.status ==\n\t\t\t     P80211ENUM_msgitem_status_data_ok) &&\n\t\t\t    (msg->keepwepflags.data != P80211ENUM_truth_true)) {\n\t\t\t\t \n\t\t\t\tword = HFA384x_WEPFLAGS_DISABLE_TXCRYPT |\n\t\t\t\t    HFA384x_WEPFLAGS_DISABLE_RXCRYPT;\n\t\t\t\tresult =\n\t\t\t\t    hfa384x_drvr_setconfig16(hw,\n\t\t\t\t\t\t\t     HFA384x_RID_CNFWEPFLAGS,\n\t\t\t\t\t\t\t     word);\n\t\t\t}\n\n\t\t\tif (result) {\n\t\t\t\tnetdev_dbg\n\t\t\t\t  (wlandev->netdev,\n\t\t\t\t   \"failed to set wepflags=0x%04x, result=%d\\n\",\n\t\t\t\t   word, result);\n\t\t\t\tgoto failed;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tif ((msg->stripfcs.status ==\n\t\t     P80211ENUM_msgitem_status_data_ok) &&\n\t\t    (msg->stripfcs.data == P80211ENUM_truth_true)) {\n\t\t\thw->sniff_fcs = 0;\n\t\t} else {\n\t\t\thw->sniff_fcs = 1;\n\t\t}\n\n\t\t \n\t\tif (msg->packet_trunc.status ==\n\t\t    P80211ENUM_msgitem_status_data_ok) {\n\t\t\thw->sniff_truncate = msg->packet_trunc.data;\n\t\t} else {\n\t\t\thw->sniff_truncate = 0;\n\t\t}\n\n\t\t \n\t\tresult = hfa384x_drvr_enable(hw, 0);\n\t\tif (result) {\n\t\t\tnetdev_dbg\n\t\t\t    (wlandev->netdev,\n\t\t\t     \"failed to enable port for sniffing, result=%d\\n\",\n\t\t\t     result);\n\t\t\tgoto failed;\n\t\t}\n\t\t \n\t\tresult = hfa384x_cmd_monitor(hw, HFA384x_MONITOR_ENABLE);\n\t\tif (result) {\n\t\t\tnetdev_dbg(wlandev->netdev,\n\t\t\t\t   \"failed to enable monitor mode, result=%d\\n\",\n\t\t\t\t   result);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (wlandev->netdev->type == ARPHRD_ETHER)\n\t\t\tnetdev_info(wlandev->netdev, \"monitor mode enabled\\n\");\n\n\t\t \n\t\t \n\t\tif ((msg->prismheader.status ==\n\t\t     P80211ENUM_msgitem_status_data_ok) &&\n\t\t    (msg->prismheader.data == P80211ENUM_truth_true)) {\n\t\t\thw->sniffhdr = 0;\n\t\t\twlandev->netdev->type = ARPHRD_IEEE80211_PRISM;\n\t\t} else if ((msg->wlanheader.status ==\n\t\t\t    P80211ENUM_msgitem_status_data_ok) &&\n\t\t\t   (msg->wlanheader.data == P80211ENUM_truth_true)) {\n\t\t\thw->sniffhdr = 1;\n\t\t\twlandev->netdev->type = ARPHRD_IEEE80211_PRISM;\n\t\t} else {\n\t\t\twlandev->netdev->type = ARPHRD_IEEE80211;\n\t\t}\n\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_success;\n\t\treturn 0;\n\tdefault:\n\t\tmsg->resultcode.data = P80211ENUM_resultcode_invalid_parameters;\n\t\treturn 0;\n\t}\n\nfailed:\n\tmsg->resultcode.data = P80211ENUM_resultcode_refused;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}