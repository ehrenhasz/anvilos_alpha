{
  "module_name": "adt7316.c",
  "hash_id": "745ca9cec064cc814b9a473d8c34a95b777b0df6cbea81b0caa166494d98b168",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/iio/addac/adt7316.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/gpio/consumer.h>\n#include <linux/irq.h>\n#include <linux/workqueue.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/sysfs.h>\n#include <linux/list.h>\n#include <linux/i2c.h>\n#include <linux/rtc.h>\n#include <linux/module.h>\n\n#include <linux/iio/iio.h>\n#include <linux/iio/events.h>\n#include <linux/iio/sysfs.h>\n#include \"adt7316.h\"\n\n \n#define ADT7316_INT_STAT1\t\t0x0\n#define ADT7316_INT_STAT2\t\t0x1\n#define ADT7316_LSB_IN_TEMP_VDD\t\t0x3\n#define ADT7316_LSB_IN_TEMP_MASK\t0x3\n#define ADT7316_LSB_VDD_MASK\t\t0xC\n#define ADT7316_LSB_VDD_OFFSET\t\t2\n#define ADT7316_LSB_EX_TEMP_AIN\t\t0x4\n#define ADT7316_LSB_EX_TEMP_MASK\t0x3\n#define ADT7516_LSB_AIN_SHIFT\t\t2\n#define ADT7316_AD_MSB_DATA_BASE        0x6\n#define ADT7316_AD_MSB_DATA_REGS        3\n#define ADT7516_AD_MSB_DATA_REGS        6\n#define ADT7316_MSB_VDD\t\t\t0x6\n#define ADT7316_MSB_IN_TEMP\t\t0x7\n#define ADT7316_MSB_EX_TEMP\t\t0x8\n#define ADT7516_MSB_AIN1\t\t0x8\n#define ADT7516_MSB_AIN2\t\t0x9\n#define ADT7516_MSB_AIN3\t\t0xA\n#define ADT7516_MSB_AIN4\t\t0xB\n#define ADT7316_DA_DATA_BASE\t\t0x10\n#define ADT7316_DA_10_BIT_LSB_SHIFT\t6\n#define ADT7316_DA_12_BIT_LSB_SHIFT\t4\n#define ADT7316_DA_MSB_DATA_REGS\t4\n#define ADT7316_LSB_DAC_A\t\t0x10\n#define ADT7316_MSB_DAC_A\t\t0x11\n#define ADT7316_LSB_DAC_B\t\t0x12\n#define ADT7316_MSB_DAC_B\t\t0x13\n#define ADT7316_LSB_DAC_C\t\t0x14\n#define ADT7316_MSB_DAC_C\t\t0x15\n#define ADT7316_LSB_DAC_D\t\t0x16\n#define ADT7316_MSB_DAC_D\t\t0x17\n#define ADT7316_CONFIG1\t\t\t0x18\n#define ADT7316_CONFIG2\t\t\t0x19\n#define ADT7316_CONFIG3\t\t\t0x1A\n#define ADT7316_DAC_CONFIG\t\t0x1B\n#define ADT7316_LDAC_CONFIG\t\t0x1C\n#define ADT7316_INT_MASK1\t\t0x1D\n#define ADT7316_INT_MASK2\t\t0x1E\n#define ADT7316_IN_TEMP_OFFSET\t\t0x1F\n#define ADT7316_EX_TEMP_OFFSET\t\t0x20\n#define ADT7316_IN_ANALOG_TEMP_OFFSET\t0x21\n#define ADT7316_EX_ANALOG_TEMP_OFFSET\t0x22\n#define ADT7316_VDD_HIGH\t\t0x23\n#define ADT7316_VDD_LOW\t\t\t0x24\n#define ADT7316_IN_TEMP_HIGH\t\t0x25\n#define ADT7316_IN_TEMP_LOW\t\t0x26\n#define ADT7316_EX_TEMP_HIGH\t\t0x27\n#define ADT7316_EX_TEMP_LOW\t\t0x28\n#define ADT7516_AIN2_HIGH\t\t0x2B\n#define ADT7516_AIN2_LOW\t\t0x2C\n#define ADT7516_AIN3_HIGH\t\t0x2D\n#define ADT7516_AIN3_LOW\t\t0x2E\n#define ADT7516_AIN4_HIGH\t\t0x2F\n#define ADT7516_AIN4_LOW\t\t0x30\n#define ADT7316_DEVICE_ID\t\t0x4D\n#define ADT7316_MANUFACTURE_ID\t\t0x4E\n#define ADT7316_DEVICE_REV\t\t0x4F\n#define ADT7316_SPI_LOCK_STAT\t\t0x7F\n\n \n#define ADT7316_EN\t\t\t0x1\n#define ADT7516_SEL_EX_TEMP\t\t0x4\n#define ADT7516_SEL_AIN1_2_EX_TEMP_MASK\t0x6\n#define ADT7516_SEL_AIN3\t\t0x8\n#define ADT7316_INT_EN\t\t\t0x20\n#define ADT7316_INT_POLARITY\t\t0x40\n#define ADT7316_PD\t\t\t0x80\n\n \n#define ADT7316_AD_SINGLE_CH_MASK\t0x3\n#define ADT7516_AD_SINGLE_CH_MASK\t0x7\n#define ADT7316_AD_SINGLE_CH_VDD\t0\n#define ADT7316_AD_SINGLE_CH_IN\t\t1\n#define ADT7316_AD_SINGLE_CH_EX\t\t2\n#define ADT7516_AD_SINGLE_CH_AIN1\t2\n#define ADT7516_AD_SINGLE_CH_AIN2\t3\n#define ADT7516_AD_SINGLE_CH_AIN3\t4\n#define ADT7516_AD_SINGLE_CH_AIN4\t5\n#define ADT7316_AD_SINGLE_CH_MODE\t0x10\n#define ADT7316_DISABLE_AVERAGING\t0x20\n#define ADT7316_EN_SMBUS_TIMEOUT\t0x40\n#define ADT7316_RESET\t\t\t0x80\n\n \n#define ADT7316_ADCLK_22_5\t\t0x1\n#define ADT7316_DA_HIGH_RESOLUTION\t0x2\n#define ADT7316_DA_EN_VIA_DAC_LDAC\t0x8\n#define ADT7516_AIN_IN_VREF\t\t0x10\n#define ADT7316_EN_IN_TEMP_PROP_DACA\t0x20\n#define ADT7316_EN_EX_TEMP_PROP_DACB\t0x40\n\n \n#define ADT7316_DA_2VREF_CH_MASK\t0xF\n#define ADT7316_DA_EN_MODE_MASK\t\t0x30\n#define ADT7316_DA_EN_MODE_SHIFT\t4\n#define ADT7316_DA_EN_MODE_SINGLE\t0x00\n#define ADT7316_DA_EN_MODE_AB_CD\t0x10\n#define ADT7316_DA_EN_MODE_ABCD\t\t0x20\n#define ADT7316_DA_EN_MODE_LDAC\t\t0x30\n#define ADT7316_VREF_BYPASS_DAC_AB\t0x40\n#define ADT7316_VREF_BYPASS_DAC_CD\t0x80\n\n \n#define ADT7316_LDAC_EN_DA_MASK\t\t0xF\n#define ADT7316_DAC_IN_VREF\t\t0x10\n#define ADT7516_DAC_AB_IN_VREF\t\t0x10\n#define ADT7516_DAC_CD_IN_VREF\t\t0x20\n#define ADT7516_DAC_IN_VREF_OFFSET\t4\n#define ADT7516_DAC_IN_VREF_MASK\t0x30\n\n \n#define ADT7316_INT_MASK2_VDD\t\t0x10\n\n \n#define ADT7316_VALUE_MASK\t\t0xfff\n#define ADT7316_T_VALUE_SIGN\t\t0x400\n#define ADT7316_T_VALUE_FLOAT_OFFSET\t2\n#define ADT7316_T_VALUE_FLOAT_MASK\t0x2\n\n \n#define ID_ADT7316\t\t0x1\n#define ID_ADT7317\t\t0x2\n#define ID_ADT7318\t\t0x3\n#define ID_ADT7516\t\t0x11\n#define ID_ADT7517\t\t0x12\n#define ID_ADT7519\t\t0x14\n\n#define ID_FAMILY_MASK\t\t0xF0\n#define ID_ADT73XX\t\t0x0\n#define ID_ADT75XX\t\t0x10\n\n \n\nstruct adt7316_chip_info {\n\tstruct adt7316_bus\tbus;\n\tstruct gpio_desc\t*ldac_pin;\n\tu16\t\t\tint_mask;\t \n\tu8\t\t\tconfig1;\n\tu8\t\t\tconfig2;\n\tu8\t\t\tconfig3;\n\tu8\t\t\tdac_config;\t \n\tu8\t\t\tldac_config;\t \n\tu8\t\t\tdac_bits;\t \n\tu8\t\t\tid;\t\t \n};\n\n \n#define ADT7316_IN_TEMP_HIGH_INT_MASK\t0x1\n#define ADT7316_IN_TEMP_LOW_INT_MASK\t0x2\n#define ADT7316_EX_TEMP_HIGH_INT_MASK\t0x4\n#define ADT7316_EX_TEMP_LOW_INT_MASK\t0x8\n#define ADT7316_EX_TEMP_FAULT_INT_MASK\t0x10\n#define ADT7516_AIN1_INT_MASK\t\t0x4\n#define ADT7516_AIN2_INT_MASK\t\t0x20\n#define ADT7516_AIN3_INT_MASK\t\t0x40\n#define ADT7516_AIN4_INT_MASK\t\t0x80\n#define ADT7316_VDD_INT_MASK\t\t0x100\n#define ADT7316_TEMP_INT_MASK\t\t0x1F\n#define ADT7516_AIN_INT_MASK\t\t0xE0\n#define ADT7316_TEMP_AIN_INT_MASK\t\\\n\t(ADT7316_TEMP_INT_MASK)\n\n \n\nstruct adt7316_limit_regs {\n\tu16\tdata_high;\n\tu16\tdata_low;\n};\n\nstatic ssize_t adt7316_show_enabled(struct device *dev,\n\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t    char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\", !!(chip->config1 & ADT7316_EN));\n}\n\nstatic ssize_t _adt7316_store_enabled(struct adt7316_chip_info *chip,\n\t\t\t\t      int enable)\n{\n\tu8 config1;\n\tint ret;\n\n\tif (enable)\n\t\tconfig1 = chip->config1 | ADT7316_EN;\n\telse\n\t\tconfig1 = chip->config1 & ~ADT7316_EN;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, config1);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config1 = config1;\n\n\treturn ret;\n}\n\nstatic ssize_t adt7316_store_enabled(struct device *dev,\n\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t     const char *buf,\n\t\t\t\t     size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tint enable;\n\n\tif (buf[0] == '1')\n\t\tenable = 1;\n\telse\n\t\tenable = 0;\n\n\tif (_adt7316_store_enabled(chip, enable) < 0)\n\t\treturn -EIO;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(enabled, 0644,\n\t\tadt7316_show_enabled,\n\t\tadt7316_store_enabled,\n\t\t0);\n\nstatic ssize_t adt7316_show_select_ex_temp(struct device *dev,\n\t\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t\t   char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\tif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\n\t\treturn -EPERM;\n\n\treturn sprintf(buf, \"%d\\n\", !!(chip->config1 & ADT7516_SEL_EX_TEMP));\n}\n\nstatic ssize_t adt7316_store_select_ex_temp(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    const char *buf,\n\t\t\t\t\t    size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config1;\n\tint ret;\n\n\tif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\n\t\treturn -EPERM;\n\n\tconfig1 = chip->config1 & (~ADT7516_SEL_EX_TEMP);\n\tif (buf[0] == '1')\n\t\tconfig1 |= ADT7516_SEL_EX_TEMP;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, config1);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config1 = config1;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(select_ex_temp, 0644,\n\t\tadt7316_show_select_ex_temp,\n\t\tadt7316_store_select_ex_temp,\n\t\t0);\n\nstatic ssize_t adt7316_show_mode(struct device *dev,\n\t\t\t\t struct device_attribute *attr,\n\t\t\t\t char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\tif (chip->config2 & ADT7316_AD_SINGLE_CH_MODE)\n\t\treturn sprintf(buf, \"single_channel\\n\");\n\n\treturn sprintf(buf, \"round_robin\\n\");\n}\n\nstatic ssize_t adt7316_store_mode(struct device *dev,\n\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t  const char *buf,\n\t\t\t\t  size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config2;\n\tint ret;\n\n\tconfig2 = chip->config2 & (~ADT7316_AD_SINGLE_CH_MODE);\n\tif (!memcmp(buf, \"single_channel\", 14))\n\t\tconfig2 |= ADT7316_AD_SINGLE_CH_MODE;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG2, config2);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config2 = config2;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(mode, 0644,\n\t\tadt7316_show_mode,\n\t\tadt7316_store_mode,\n\t\t0);\n\nstatic ssize_t adt7316_show_all_modes(struct device *dev,\n\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t      char *buf)\n{\n\treturn sprintf(buf, \"single_channel\\nround_robin\\n\");\n}\n\nstatic IIO_DEVICE_ATTR(all_modes, 0444, adt7316_show_all_modes, NULL, 0);\n\nstatic ssize_t adt7316_show_ad_channel(struct device *dev,\n\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t       char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\tif (!(chip->config2 & ADT7316_AD_SINGLE_CH_MODE))\n\t\treturn -EPERM;\n\n\tswitch (chip->config2 & ADT7516_AD_SINGLE_CH_MASK) {\n\tcase ADT7316_AD_SINGLE_CH_VDD:\n\t\treturn sprintf(buf, \"0 - VDD\\n\");\n\tcase ADT7316_AD_SINGLE_CH_IN:\n\t\treturn sprintf(buf, \"1 - Internal Temperature\\n\");\n\tcase ADT7316_AD_SINGLE_CH_EX:\n\t\tif (((chip->id & ID_FAMILY_MASK) == ID_ADT75XX) &&\n\t\t    (chip->config1 & ADT7516_SEL_AIN1_2_EX_TEMP_MASK) == 0)\n\t\t\treturn sprintf(buf, \"2 - AIN1\\n\");\n\n\t\treturn sprintf(buf, \"2 - External Temperature\\n\");\n\tcase ADT7516_AD_SINGLE_CH_AIN2:\n\t\tif ((chip->config1 & ADT7516_SEL_AIN1_2_EX_TEMP_MASK) == 0)\n\t\t\treturn sprintf(buf, \"3 - AIN2\\n\");\n\n\t\treturn sprintf(buf, \"N/A\\n\");\n\tcase ADT7516_AD_SINGLE_CH_AIN3:\n\t\tif (chip->config1 & ADT7516_SEL_AIN3)\n\t\t\treturn sprintf(buf, \"4 - AIN3\\n\");\n\n\t\treturn sprintf(buf, \"N/A\\n\");\n\tcase ADT7516_AD_SINGLE_CH_AIN4:\n\t\treturn sprintf(buf, \"5 - AIN4\\n\");\n\tdefault:\n\t\treturn sprintf(buf, \"N/A\\n\");\n\t}\n}\n\nstatic ssize_t adt7316_store_ad_channel(struct device *dev,\n\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\tconst char *buf,\n\t\t\t\t\tsize_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config2;\n\tu8 data;\n\tint ret;\n\n\tif (!(chip->config2 & ADT7316_AD_SINGLE_CH_MODE))\n\t\treturn -EPERM;\n\n\tret = kstrtou8(buf, 10, &data);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX) {\n\t\tif (data > 5)\n\t\t\treturn -EINVAL;\n\n\t\tconfig2 = chip->config2 & (~ADT7516_AD_SINGLE_CH_MASK);\n\t} else {\n\t\tif (data > 2)\n\t\t\treturn -EINVAL;\n\n\t\tconfig2 = chip->config2 & (~ADT7316_AD_SINGLE_CH_MASK);\n\t}\n\n\tconfig2 |= data;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG2, config2);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config2 = config2;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(ad_channel, 0644,\n\t\tadt7316_show_ad_channel,\n\t\tadt7316_store_ad_channel,\n\t\t0);\n\nstatic ssize_t adt7316_show_all_ad_channels(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\tif (!(chip->config2 & ADT7316_AD_SINGLE_CH_MODE))\n\t\treturn -EPERM;\n\n\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\n\t\treturn sprintf(buf, \"0 - VDD\\n1 - Internal Temperature\\n\"\n\t\t\t\t\"2 - External Temperature or AIN1\\n\"\n\t\t\t\t\"3 - AIN2\\n4 - AIN3\\n5 - AIN4\\n\");\n\treturn sprintf(buf, \"0 - VDD\\n1 - Internal Temperature\\n\"\n\t\t\t\"2 - External Temperature\\n\");\n}\n\nstatic IIO_DEVICE_ATTR(all_ad_channels, 0444,\n\t\tadt7316_show_all_ad_channels, NULL, 0);\n\nstatic ssize_t adt7316_show_disable_averaging(struct device *dev,\n\t\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t\t      char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\",\n\t\t!!(chip->config2 & ADT7316_DISABLE_AVERAGING));\n}\n\nstatic ssize_t adt7316_store_disable_averaging(struct device *dev,\n\t\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t\t       const char *buf,\n\t\t\t\t\t       size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config2;\n\tint ret;\n\n\tconfig2 = chip->config2 & (~ADT7316_DISABLE_AVERAGING);\n\tif (buf[0] == '1')\n\t\tconfig2 |= ADT7316_DISABLE_AVERAGING;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG2, config2);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config2 = config2;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(disable_averaging, 0644,\n\t\tadt7316_show_disable_averaging,\n\t\tadt7316_store_disable_averaging,\n\t\t0);\n\nstatic ssize_t adt7316_show_enable_smbus_timeout(struct device *dev,\n\t\t\t\t\t\t struct device_attribute *attr,\n\t\t\t\t\t\t char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\",\n\t\t!!(chip->config2 & ADT7316_EN_SMBUS_TIMEOUT));\n}\n\nstatic ssize_t adt7316_store_enable_smbus_timeout(struct device *dev,\n\t\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t\t  const char *buf,\n\t\t\t\t\t\t  size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config2;\n\tint ret;\n\n\tconfig2 = chip->config2 & (~ADT7316_EN_SMBUS_TIMEOUT);\n\tif (buf[0] == '1')\n\t\tconfig2 |= ADT7316_EN_SMBUS_TIMEOUT;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG2, config2);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config2 = config2;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(enable_smbus_timeout, 0644,\n\t\tadt7316_show_enable_smbus_timeout,\n\t\tadt7316_store_enable_smbus_timeout,\n\t\t0);\n\nstatic ssize_t adt7316_show_powerdown(struct device *dev,\n\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t      char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\", !!(chip->config1 & ADT7316_PD));\n}\n\nstatic ssize_t adt7316_store_powerdown(struct device *dev,\n\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t       const char *buf,\n\t\t\t\t       size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config1;\n\tint ret;\n\n\tconfig1 = chip->config1 & (~ADT7316_PD);\n\tif (buf[0] == '1')\n\t\tconfig1 |= ADT7316_PD;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, config1);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config1 = config1;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(powerdown, 0644,\n\t\tadt7316_show_powerdown,\n\t\tadt7316_store_powerdown,\n\t\t0);\n\nstatic ssize_t adt7316_show_fast_ad_clock(struct device *dev,\n\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t  char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\", !!(chip->config3 & ADT7316_ADCLK_22_5));\n}\n\nstatic ssize_t adt7316_store_fast_ad_clock(struct device *dev,\n\t\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t\t   const char *buf,\n\t\t\t\t\t   size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config3;\n\tint ret;\n\n\tconfig3 = chip->config3 & (~ADT7316_ADCLK_22_5);\n\tif (buf[0] == '1')\n\t\tconfig3 |= ADT7316_ADCLK_22_5;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config3 = config3;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(fast_ad_clock, 0644,\n\t\tadt7316_show_fast_ad_clock,\n\t\tadt7316_store_fast_ad_clock,\n\t\t0);\n\nstatic ssize_t adt7316_show_da_high_resolution(struct device *dev,\n\t\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t\t       char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\tif (chip->config3 & ADT7316_DA_HIGH_RESOLUTION) {\n\t\tif (chip->id != ID_ADT7318 && chip->id != ID_ADT7519)\n\t\t\treturn sprintf(buf, \"1 (10 bits)\\n\");\n\t}\n\n\treturn sprintf(buf, \"0 (8 bits)\\n\");\n}\n\nstatic ssize_t adt7316_store_da_high_resolution(struct device *dev,\n\t\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\t\tconst char *buf,\n\t\t\t\t\t\tsize_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config3;\n\tint ret;\n\n\tif (chip->id == ID_ADT7318 || chip->id == ID_ADT7519)\n\t\treturn -EPERM;\n\n\tconfig3 = chip->config3 & (~ADT7316_DA_HIGH_RESOLUTION);\n\tif (buf[0] == '1')\n\t\tconfig3 |= ADT7316_DA_HIGH_RESOLUTION;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config3 = config3;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(da_high_resolution, 0644,\n\t\tadt7316_show_da_high_resolution,\n\t\tadt7316_store_da_high_resolution,\n\t\t0);\n\nstatic ssize_t adt7316_show_AIN_internal_Vref(struct device *dev,\n\t\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t\t      char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\tif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\n\t\treturn -EPERM;\n\n\treturn sprintf(buf, \"%d\\n\",\n\t\t!!(chip->config3 & ADT7516_AIN_IN_VREF));\n}\n\nstatic ssize_t adt7316_store_AIN_internal_Vref(struct device *dev,\n\t\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t\t       const char *buf,\n\t\t\t\t\t       size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config3;\n\tint ret;\n\n\tif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\n\t\treturn -EPERM;\n\n\tif (buf[0] != '1')\n\t\tconfig3 = chip->config3 & (~ADT7516_AIN_IN_VREF);\n\telse\n\t\tconfig3 = chip->config3 | ADT7516_AIN_IN_VREF;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config3 = config3;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(AIN_internal_Vref, 0644,\n\t\tadt7316_show_AIN_internal_Vref,\n\t\tadt7316_store_AIN_internal_Vref,\n\t\t0);\n\nstatic ssize_t adt7316_show_enable_prop_DACA(struct device *dev,\n\t\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t\t     char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\",\n\t\t!!(chip->config3 & ADT7316_EN_IN_TEMP_PROP_DACA));\n}\n\nstatic ssize_t adt7316_store_enable_prop_DACA(struct device *dev,\n\t\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t\t      const char *buf,\n\t\t\t\t\t      size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config3;\n\tint ret;\n\n\tconfig3 = chip->config3 & (~ADT7316_EN_IN_TEMP_PROP_DACA);\n\tif (buf[0] == '1')\n\t\tconfig3 |= ADT7316_EN_IN_TEMP_PROP_DACA;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config3 = config3;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(enable_proportion_DACA, 0644,\n\t\t       adt7316_show_enable_prop_DACA,\n\t\t       adt7316_store_enable_prop_DACA,\n\t\t       0);\n\nstatic ssize_t adt7316_show_enable_prop_DACB(struct device *dev,\n\t\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t\t     char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\",\n\t\t!!(chip->config3 & ADT7316_EN_EX_TEMP_PROP_DACB));\n}\n\nstatic ssize_t adt7316_store_enable_prop_DACB(struct device *dev,\n\t\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t\t      const char *buf,\n\t\t\t\t\t      size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config3;\n\tint ret;\n\n\tconfig3 = chip->config3 & (~ADT7316_EN_EX_TEMP_PROP_DACB);\n\tif (buf[0] == '1')\n\t\tconfig3 |= ADT7316_EN_EX_TEMP_PROP_DACB;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config3 = config3;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(enable_proportion_DACB, 0644,\n\t\t       adt7316_show_enable_prop_DACB,\n\t\t       adt7316_store_enable_prop_DACB,\n\t\t       0);\n\nstatic ssize_t adt7316_show_DAC_2Vref_ch_mask(struct device *dev,\n\t\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t\t      char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"0x%x\\n\",\n\t\tchip->dac_config & ADT7316_DA_2VREF_CH_MASK);\n}\n\nstatic ssize_t adt7316_store_DAC_2Vref_ch_mask(struct device *dev,\n\t\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t\t       const char *buf,\n\t\t\t\t\t       size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 dac_config;\n\tu8 data;\n\tint ret;\n\n\tret = kstrtou8(buf, 16, &data);\n\tif (ret || data > ADT7316_DA_2VREF_CH_MASK)\n\t\treturn -EINVAL;\n\n\tdac_config = chip->dac_config & (~ADT7316_DA_2VREF_CH_MASK);\n\tdac_config |= data;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_DAC_CONFIG, dac_config);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->dac_config = dac_config;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(DAC_2Vref_channels_mask, 0644,\n\t\t       adt7316_show_DAC_2Vref_ch_mask,\n\t\t       adt7316_store_DAC_2Vref_ch_mask,\n\t\t       0);\n\nstatic ssize_t adt7316_show_DAC_update_mode(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\tif (!(chip->config3 & ADT7316_DA_EN_VIA_DAC_LDAC))\n\t\treturn sprintf(buf, \"manual\\n\");\n\n\tswitch (chip->dac_config & ADT7316_DA_EN_MODE_MASK) {\n\tcase ADT7316_DA_EN_MODE_SINGLE:\n\t\treturn sprintf(buf,\n\t\t\t\"0 - auto at any MSB DAC writing\\n\");\n\tcase ADT7316_DA_EN_MODE_AB_CD:\n\t\treturn sprintf(buf,\n\t\t\t\"1 - auto at MSB DAC AB and CD writing\\n\");\n\tcase ADT7316_DA_EN_MODE_ABCD:\n\t\treturn sprintf(buf,\n\t\t\t\"2 - auto at MSB DAC ABCD writing\\n\");\n\tdefault:  \n\t\treturn sprintf(buf, \"3 - manual\\n\");\n\t}\n}\n\nstatic ssize_t adt7316_store_DAC_update_mode(struct device *dev,\n\t\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t\t     const char *buf,\n\t\t\t\t\t     size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 dac_config;\n\tu8 data;\n\tint ret;\n\n\tif (!(chip->config3 & ADT7316_DA_EN_VIA_DAC_LDAC))\n\t\treturn -EPERM;\n\n\tret = kstrtou8(buf, 10, &data);\n\tif (ret || data > (ADT7316_DA_EN_MODE_MASK >> ADT7316_DA_EN_MODE_SHIFT))\n\t\treturn -EINVAL;\n\n\tdac_config = chip->dac_config & (~ADT7316_DA_EN_MODE_MASK);\n\tdac_config |= data << ADT7316_DA_EN_MODE_SHIFT;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_DAC_CONFIG, dac_config);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->dac_config = dac_config;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(DAC_update_mode, 0644,\n\t\t       adt7316_show_DAC_update_mode,\n\t\t       adt7316_store_DAC_update_mode,\n\t\t       0);\n\nstatic ssize_t adt7316_show_all_DAC_update_modes(struct device *dev,\n\t\t\t\t\t\t struct device_attribute *attr,\n\t\t\t\t\t\t char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\tif (chip->config3 & ADT7316_DA_EN_VIA_DAC_LDAC)\n\t\treturn sprintf(buf, \"0 - auto at any MSB DAC writing\\n\"\n\t\t\t\t\"1 - auto at MSB DAC AB and CD writing\\n\"\n\t\t\t\t\"2 - auto at MSB DAC ABCD writing\\n\"\n\t\t\t\t\"3 - manual\\n\");\n\treturn sprintf(buf, \"manual\\n\");\n}\n\nstatic IIO_DEVICE_ATTR(all_DAC_update_modes, 0444,\n\t\t       adt7316_show_all_DAC_update_modes, NULL, 0);\n\nstatic ssize_t adt7316_store_update_DAC(struct device *dev,\n\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\tconst char *buf,\n\t\t\t\t\tsize_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 ldac_config;\n\tu8 data;\n\tint ret;\n\n\tif (chip->config3 & ADT7316_DA_EN_VIA_DAC_LDAC) {\n\t\tif ((chip->dac_config & ADT7316_DA_EN_MODE_MASK) !=\n\t\t\tADT7316_DA_EN_MODE_LDAC)\n\t\t\treturn -EPERM;\n\n\t\tret = kstrtou8(buf, 16, &data);\n\t\tif (ret || data > ADT7316_LDAC_EN_DA_MASK)\n\t\t\treturn -EINVAL;\n\n\t\tldac_config = chip->ldac_config & (~ADT7316_LDAC_EN_DA_MASK);\n\t\tldac_config |= data;\n\n\t\tret = chip->bus.write(chip->bus.client, ADT7316_LDAC_CONFIG,\n\t\t\tldac_config);\n\t\tif (ret)\n\t\t\treturn -EIO;\n\t} else {\n\t\tgpiod_set_value(chip->ldac_pin, 0);\n\t\tgpiod_set_value(chip->ldac_pin, 1);\n\t}\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(update_DAC, 0644,\n\t\t       NULL,\n\t\t       adt7316_store_update_DAC,\n\t\t       0);\n\nstatic ssize_t adt7316_show_DA_AB_Vref_bypass(struct device *dev,\n\t\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t\t      char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\",\n\t\t!!(chip->dac_config & ADT7316_VREF_BYPASS_DAC_AB));\n}\n\nstatic ssize_t adt7316_store_DA_AB_Vref_bypass(struct device *dev,\n\t\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t\t       const char *buf,\n\t\t\t\t\t       size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 dac_config;\n\tint ret;\n\n\tdac_config = chip->dac_config & (~ADT7316_VREF_BYPASS_DAC_AB);\n\tif (buf[0] == '1')\n\t\tdac_config |= ADT7316_VREF_BYPASS_DAC_AB;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_DAC_CONFIG, dac_config);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->dac_config = dac_config;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(DA_AB_Vref_bypass, 0644,\n\t\t       adt7316_show_DA_AB_Vref_bypass,\n\t\t       adt7316_store_DA_AB_Vref_bypass,\n\t\t       0);\n\nstatic ssize_t adt7316_show_DA_CD_Vref_bypass(struct device *dev,\n\t\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t\t      char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\",\n\t\t!!(chip->dac_config & ADT7316_VREF_BYPASS_DAC_CD));\n}\n\nstatic ssize_t adt7316_store_DA_CD_Vref_bypass(struct device *dev,\n\t\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t\t       const char *buf,\n\t\t\t\t\t       size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 dac_config;\n\tint ret;\n\n\tdac_config = chip->dac_config & (~ADT7316_VREF_BYPASS_DAC_CD);\n\tif (buf[0] == '1')\n\t\tdac_config |= ADT7316_VREF_BYPASS_DAC_CD;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_DAC_CONFIG, dac_config);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->dac_config = dac_config;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(DA_CD_Vref_bypass, 0644,\n\t\t       adt7316_show_DA_CD_Vref_bypass,\n\t\t       adt7316_store_DA_CD_Vref_bypass,\n\t\t       0);\n\nstatic ssize_t adt7316_show_DAC_internal_Vref(struct device *dev,\n\t\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t\t      char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\n\t\treturn sprintf(buf, \"0x%x\\n\",\n\t\t\t(chip->ldac_config & ADT7516_DAC_IN_VREF_MASK) >>\n\t\t\tADT7516_DAC_IN_VREF_OFFSET);\n\treturn sprintf(buf, \"%d\\n\",\n\t\t       !!(chip->ldac_config & ADT7316_DAC_IN_VREF));\n}\n\nstatic ssize_t adt7316_store_DAC_internal_Vref(struct device *dev,\n\t\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t\t       const char *buf,\n\t\t\t\t\t       size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 ldac_config;\n\tu8 data;\n\tint ret;\n\n\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX) {\n\t\tret = kstrtou8(buf, 16, &data);\n\t\tif (ret || data > 3)\n\t\t\treturn -EINVAL;\n\n\t\tldac_config = chip->ldac_config & (~ADT7516_DAC_IN_VREF_MASK);\n\t\tif (data & 0x1)\n\t\t\tldac_config |= ADT7516_DAC_AB_IN_VREF;\n\t\tif (data & 0x2)\n\t\t\tldac_config |= ADT7516_DAC_CD_IN_VREF;\n\t} else {\n\t\tret = kstrtou8(buf, 16, &data);\n\t\tif (ret)\n\t\t\treturn -EINVAL;\n\n\t\tldac_config = chip->ldac_config & (~ADT7316_DAC_IN_VREF);\n\t\tif (data)\n\t\t\tldac_config = chip->ldac_config | ADT7316_DAC_IN_VREF;\n\t}\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_LDAC_CONFIG,\n\t\t\tldac_config);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->ldac_config = ldac_config;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(DAC_internal_Vref, 0644,\n\t\t       adt7316_show_DAC_internal_Vref,\n\t\t       adt7316_store_DAC_internal_Vref,\n\t\t       0);\n\nstatic ssize_t adt7316_show_ad(struct adt7316_chip_info *chip,\n\t\t\t       int channel, char *buf)\n{\n\tu16 data;\n\tu8 msb, lsb;\n\tchar sign = ' ';\n\tint ret;\n\n\tif ((chip->config2 & ADT7316_AD_SINGLE_CH_MODE) &&\n\t    channel != (chip->config2 & ADT7516_AD_SINGLE_CH_MASK))\n\t\treturn -EPERM;\n\n\tswitch (channel) {\n\tcase ADT7316_AD_SINGLE_CH_IN:\n\t\tret = chip->bus.read(chip->bus.client,\n\t\t\tADT7316_LSB_IN_TEMP_VDD, &lsb);\n\t\tif (ret)\n\t\t\treturn -EIO;\n\n\t\tret = chip->bus.read(chip->bus.client,\n\t\t\tADT7316_AD_MSB_DATA_BASE + channel, &msb);\n\t\tif (ret)\n\t\t\treturn -EIO;\n\n\t\tdata = msb << ADT7316_T_VALUE_FLOAT_OFFSET;\n\t\tdata |= lsb & ADT7316_LSB_IN_TEMP_MASK;\n\t\tbreak;\n\tcase ADT7316_AD_SINGLE_CH_VDD:\n\t\tret = chip->bus.read(chip->bus.client,\n\t\t\tADT7316_LSB_IN_TEMP_VDD, &lsb);\n\t\tif (ret)\n\t\t\treturn -EIO;\n\n\t\tret = chip->bus.read(chip->bus.client,\n\n\t\t\tADT7316_AD_MSB_DATA_BASE + channel, &msb);\n\t\tif (ret)\n\t\t\treturn -EIO;\n\n\t\tdata = msb << ADT7316_T_VALUE_FLOAT_OFFSET;\n\t\tdata |= (lsb & ADT7316_LSB_VDD_MASK) >> ADT7316_LSB_VDD_OFFSET;\n\t\treturn sprintf(buf, \"%d\\n\", data);\n\tdefault:  \n\t\tret = chip->bus.read(chip->bus.client,\n\t\t\tADT7316_LSB_EX_TEMP_AIN, &lsb);\n\t\tif (ret)\n\t\t\treturn -EIO;\n\n\t\tret = chip->bus.read(chip->bus.client,\n\t\t\tADT7316_AD_MSB_DATA_BASE + channel, &msb);\n\t\tif (ret)\n\t\t\treturn -EIO;\n\n\t\tdata = msb << ADT7316_T_VALUE_FLOAT_OFFSET;\n\t\tdata |= lsb & (ADT7316_LSB_EX_TEMP_MASK <<\n\t\t\t(ADT7516_LSB_AIN_SHIFT * (channel -\n\t\t\t(ADT7316_MSB_EX_TEMP - ADT7316_AD_MSB_DATA_BASE))));\n\n\t\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\n\t\t\treturn sprintf(buf, \"%d\\n\", data);\n\n\t\tbreak;\n\t}\n\n\tif (data & ADT7316_T_VALUE_SIGN) {\n\t\t \n\t\tdata = (ADT7316_T_VALUE_SIGN << 1) - data;\n\t\tsign = '-';\n\t}\n\n\treturn sprintf(buf, \"%c%d.%.2d\\n\", sign,\n\t\t(data >> ADT7316_T_VALUE_FLOAT_OFFSET),\n\t\t(data & ADT7316_T_VALUE_FLOAT_MASK) * 25);\n}\n\nstatic ssize_t adt7316_show_VDD(struct device *dev,\n\t\t\t\tstruct device_attribute *attr,\n\t\t\t\tchar *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_ad(chip, ADT7316_AD_SINGLE_CH_VDD, buf);\n}\nstatic IIO_DEVICE_ATTR(VDD, 0444, adt7316_show_VDD, NULL, 0);\n\nstatic ssize_t adt7316_show_in_temp(struct device *dev,\n\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t    char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_ad(chip, ADT7316_AD_SINGLE_CH_IN, buf);\n}\n\nstatic IIO_DEVICE_ATTR(in_temp, 0444, adt7316_show_in_temp, NULL, 0);\n\nstatic ssize_t adt7316_show_ex_temp_AIN1(struct device *dev,\n\t\t\t\t\t struct device_attribute *attr,\n\t\t\t\t\t char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_ad(chip, ADT7316_AD_SINGLE_CH_EX, buf);\n}\n\nstatic IIO_DEVICE_ATTR(ex_temp_AIN1, 0444, adt7316_show_ex_temp_AIN1,\n\t\t       NULL, 0);\nstatic IIO_DEVICE_ATTR(ex_temp, 0444, adt7316_show_ex_temp_AIN1, NULL, 0);\n\nstatic ssize_t adt7316_show_AIN2(struct device *dev,\n\t\t\t\t struct device_attribute *attr,\n\t\t\t\t char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_ad(chip, ADT7516_AD_SINGLE_CH_AIN2, buf);\n}\nstatic IIO_DEVICE_ATTR(AIN2, 0444, adt7316_show_AIN2, NULL, 0);\n\nstatic ssize_t adt7316_show_AIN3(struct device *dev,\n\t\t\t\t struct device_attribute *attr,\n\t\t\t\t char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_ad(chip, ADT7516_AD_SINGLE_CH_AIN3, buf);\n}\nstatic IIO_DEVICE_ATTR(AIN3, 0444, adt7316_show_AIN3, NULL, 0);\n\nstatic ssize_t adt7316_show_AIN4(struct device *dev,\n\t\t\t\t struct device_attribute *attr,\n\t\t\t\t char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_ad(chip, ADT7516_AD_SINGLE_CH_AIN4, buf);\n}\nstatic IIO_DEVICE_ATTR(AIN4, 0444, adt7316_show_AIN4, NULL, 0);\n\nstatic ssize_t adt7316_show_temp_offset(struct adt7316_chip_info *chip,\n\t\t\t\t\tint offset_addr, char *buf)\n{\n\tint data;\n\tu8 val;\n\tint ret;\n\n\tret = chip->bus.read(chip->bus.client, offset_addr, &val);\n\tif (ret)\n\t\treturn -EIO;\n\n\tdata = (int)val;\n\tif (val & 0x80)\n\t\tdata -= 256;\n\n\treturn sprintf(buf, \"%d\\n\", data);\n}\n\nstatic ssize_t adt7316_store_temp_offset(struct adt7316_chip_info *chip,\n\t\t\t\t\t int offset_addr,\n\t\t\t\t\t const char *buf,\n\t\t\t\t\t size_t len)\n{\n\tint data;\n\tu8 val;\n\tint ret;\n\n\tret = kstrtoint(buf, 10, &data);\n\tif (ret || data > 127 || data < -128)\n\t\treturn -EINVAL;\n\n\tif (data < 0)\n\t\tdata += 256;\n\n\tval = (u8)data;\n\n\tret = chip->bus.write(chip->bus.client, offset_addr, val);\n\tif (ret)\n\t\treturn -EIO;\n\n\treturn len;\n}\n\nstatic ssize_t adt7316_show_in_temp_offset(struct device *dev,\n\t\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t\t   char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_temp_offset(chip, ADT7316_IN_TEMP_OFFSET, buf);\n}\n\nstatic ssize_t adt7316_store_in_temp_offset(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    const char *buf,\n\t\t\t\t\t    size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_store_temp_offset(chip, ADT7316_IN_TEMP_OFFSET, buf,\n\t\t\tlen);\n}\n\nstatic IIO_DEVICE_ATTR(in_temp_offset, 0644,\n\t\t       adt7316_show_in_temp_offset,\n\t\t       adt7316_store_in_temp_offset, 0);\n\nstatic ssize_t adt7316_show_ex_temp_offset(struct device *dev,\n\t\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t\t   char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_temp_offset(chip, ADT7316_EX_TEMP_OFFSET, buf);\n}\n\nstatic ssize_t adt7316_store_ex_temp_offset(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    const char *buf,\n\t\t\t\t\t    size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_store_temp_offset(chip, ADT7316_EX_TEMP_OFFSET, buf,\n\t\t\tlen);\n}\n\nstatic IIO_DEVICE_ATTR(ex_temp_offset, 0644,\n\t\t       adt7316_show_ex_temp_offset,\n\t\t       adt7316_store_ex_temp_offset, 0);\n\nstatic ssize_t adt7316_show_in_analog_temp_offset(struct device *dev,\n\t\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t\t  char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_temp_offset(chip,\n\t\t\tADT7316_IN_ANALOG_TEMP_OFFSET, buf);\n}\n\nstatic ssize_t adt7316_store_in_analog_temp_offset(struct device *dev,\n\t\t\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t\t\t   const char *buf,\n\t\t\t\t\t\t   size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_store_temp_offset(chip,\n\t\t\tADT7316_IN_ANALOG_TEMP_OFFSET, buf, len);\n}\n\nstatic IIO_DEVICE_ATTR(in_analog_temp_offset, 0644,\n\t\t       adt7316_show_in_analog_temp_offset,\n\t\t       adt7316_store_in_analog_temp_offset, 0);\n\nstatic ssize_t adt7316_show_ex_analog_temp_offset(struct device *dev,\n\t\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t\t  char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_temp_offset(chip,\n\t\t\tADT7316_EX_ANALOG_TEMP_OFFSET, buf);\n}\n\nstatic ssize_t adt7316_store_ex_analog_temp_offset(struct device *dev,\n\t\t\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t\t\t   const char *buf,\n\t\t\t\t\t\t   size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_store_temp_offset(chip,\n\t\t\tADT7316_EX_ANALOG_TEMP_OFFSET, buf, len);\n}\n\nstatic IIO_DEVICE_ATTR(ex_analog_temp_offset, 0644,\n\t\t       adt7316_show_ex_analog_temp_offset,\n\t\t       adt7316_store_ex_analog_temp_offset, 0);\n\nstatic ssize_t adt7316_show_DAC(struct adt7316_chip_info *chip,\n\t\t\t\tint channel, char *buf)\n{\n\tu16 data = 0;\n\tu8 msb, lsb, offset;\n\tint ret;\n\n\tif (channel >= ADT7316_DA_MSB_DATA_REGS ||\n\t    (channel == 0 &&\n\t    (chip->config3 & ADT7316_EN_IN_TEMP_PROP_DACA)) ||\n\t    (channel == 1 &&\n\t    (chip->config3 & ADT7316_EN_EX_TEMP_PROP_DACB)))\n\t\treturn -EPERM;\n\n\toffset = chip->dac_bits - 8;\n\n\tif (chip->dac_bits > 8) {\n\t\tret = chip->bus.read(chip->bus.client,\n\t\t\tADT7316_DA_DATA_BASE + channel * 2, &lsb);\n\t\tif (ret)\n\t\t\treturn -EIO;\n\t}\n\n\tret = chip->bus.read(chip->bus.client,\n\t\tADT7316_DA_DATA_BASE + 1 + channel * 2, &msb);\n\tif (ret)\n\t\treturn -EIO;\n\n\tif (chip->dac_bits == 12)\n\t\tdata = lsb >> ADT7316_DA_12_BIT_LSB_SHIFT;\n\telse if (chip->dac_bits == 10)\n\t\tdata = lsb >> ADT7316_DA_10_BIT_LSB_SHIFT;\n\tdata |= msb << offset;\n\n\treturn sprintf(buf, \"%d\\n\", data);\n}\n\nstatic ssize_t adt7316_store_DAC(struct adt7316_chip_info *chip,\n\t\t\t\t int channel, const char *buf, size_t len)\n{\n\tu8 msb, lsb, lsb_reg, offset;\n\tu16 data;\n\tint ret;\n\n\tif (channel >= ADT7316_DA_MSB_DATA_REGS ||\n\t    (channel == 0 &&\n\t    (chip->config3 & ADT7316_EN_IN_TEMP_PROP_DACA)) ||\n\t    (channel == 1 &&\n\t    (chip->config3 & ADT7316_EN_EX_TEMP_PROP_DACB)))\n\t\treturn -EPERM;\n\n\toffset = chip->dac_bits - 8;\n\n\tret = kstrtou16(buf, 10, &data);\n\tif (ret || data >= (1 << chip->dac_bits))\n\t\treturn -EINVAL;\n\n\tif (chip->dac_bits > 8) {\n\t\tlsb = data & ((1 << offset) - 1);\n\t\tif (chip->dac_bits == 12)\n\t\t\tlsb_reg = lsb << ADT7316_DA_12_BIT_LSB_SHIFT;\n\t\telse\n\t\t\tlsb_reg = lsb << ADT7316_DA_10_BIT_LSB_SHIFT;\n\t\tret = chip->bus.write(chip->bus.client,\n\t\t\tADT7316_DA_DATA_BASE + channel * 2, lsb_reg);\n\t\tif (ret)\n\t\t\treturn -EIO;\n\t}\n\n\tmsb = data >> offset;\n\tret = chip->bus.write(chip->bus.client,\n\t\tADT7316_DA_DATA_BASE + 1 + channel * 2, msb);\n\tif (ret)\n\t\treturn -EIO;\n\n\treturn len;\n}\n\nstatic ssize_t adt7316_show_DAC_A(struct device *dev,\n\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t  char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_DAC(chip, 0, buf);\n}\n\nstatic ssize_t adt7316_store_DAC_A(struct device *dev,\n\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t   const char *buf,\n\t\t\t\t   size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_store_DAC(chip, 0, buf, len);\n}\n\nstatic IIO_DEVICE_ATTR(DAC_A, 0644, adt7316_show_DAC_A,\n\t\t       adt7316_store_DAC_A, 0);\n\nstatic ssize_t adt7316_show_DAC_B(struct device *dev,\n\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t  char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_DAC(chip, 1, buf);\n}\n\nstatic ssize_t adt7316_store_DAC_B(struct device *dev,\n\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t   const char *buf,\n\t\t\t\t   size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_store_DAC(chip, 1, buf, len);\n}\n\nstatic IIO_DEVICE_ATTR(DAC_B, 0644, adt7316_show_DAC_B,\n\t\t       adt7316_store_DAC_B, 0);\n\nstatic ssize_t adt7316_show_DAC_C(struct device *dev,\n\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t  char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_DAC(chip, 2, buf);\n}\n\nstatic ssize_t adt7316_store_DAC_C(struct device *dev,\n\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t   const char *buf,\n\t\t\t\t   size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_store_DAC(chip, 2, buf, len);\n}\n\nstatic IIO_DEVICE_ATTR(DAC_C, 0644, adt7316_show_DAC_C,\n\t\t       adt7316_store_DAC_C, 0);\n\nstatic ssize_t adt7316_show_DAC_D(struct device *dev,\n\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t  char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_show_DAC(chip, 3, buf);\n}\n\nstatic ssize_t adt7316_store_DAC_D(struct device *dev,\n\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t   const char *buf,\n\t\t\t\t   size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn adt7316_store_DAC(chip, 3, buf, len);\n}\n\nstatic IIO_DEVICE_ATTR(DAC_D, 0644, adt7316_show_DAC_D,\n\t\t       adt7316_store_DAC_D, 0);\n\nstatic ssize_t adt7316_show_device_id(struct device *dev,\n\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t      char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 id;\n\tint ret;\n\n\tret = chip->bus.read(chip->bus.client, ADT7316_DEVICE_ID, &id);\n\tif (ret)\n\t\treturn -EIO;\n\n\treturn sprintf(buf, \"%d\\n\", id);\n}\n\nstatic IIO_DEVICE_ATTR(device_id, 0444, adt7316_show_device_id, NULL, 0);\n\nstatic ssize_t adt7316_show_manufactorer_id(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 id;\n\tint ret;\n\n\tret = chip->bus.read(chip->bus.client, ADT7316_MANUFACTURE_ID, &id);\n\tif (ret)\n\t\treturn -EIO;\n\n\treturn sprintf(buf, \"%d\\n\", id);\n}\n\nstatic IIO_DEVICE_ATTR(manufactorer_id, 0444,\n\t\t       adt7316_show_manufactorer_id, NULL, 0);\n\nstatic ssize_t adt7316_show_device_rev(struct device *dev,\n\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t       char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 rev;\n\tint ret;\n\n\tret = chip->bus.read(chip->bus.client, ADT7316_DEVICE_REV, &rev);\n\tif (ret)\n\t\treturn -EIO;\n\n\treturn sprintf(buf, \"%d\\n\", rev);\n}\n\nstatic IIO_DEVICE_ATTR(device_rev, 0444, adt7316_show_device_rev, NULL, 0);\n\nstatic ssize_t adt7316_show_bus_type(struct device *dev,\n\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t     char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 stat;\n\tint ret;\n\n\tret = chip->bus.read(chip->bus.client, ADT7316_SPI_LOCK_STAT, &stat);\n\tif (ret)\n\t\treturn -EIO;\n\n\tif (stat)\n\t\treturn sprintf(buf, \"spi\\n\");\n\n\treturn sprintf(buf, \"i2c\\n\");\n}\n\nstatic IIO_DEVICE_ATTR(bus_type, 0444, adt7316_show_bus_type, NULL, 0);\n\nstatic struct attribute *adt7316_attributes[] = {\n\t&iio_dev_attr_all_modes.dev_attr.attr,\n\t&iio_dev_attr_mode.dev_attr.attr,\n\t&iio_dev_attr_enabled.dev_attr.attr,\n\t&iio_dev_attr_ad_channel.dev_attr.attr,\n\t&iio_dev_attr_all_ad_channels.dev_attr.attr,\n\t&iio_dev_attr_disable_averaging.dev_attr.attr,\n\t&iio_dev_attr_enable_smbus_timeout.dev_attr.attr,\n\t&iio_dev_attr_powerdown.dev_attr.attr,\n\t&iio_dev_attr_fast_ad_clock.dev_attr.attr,\n\t&iio_dev_attr_da_high_resolution.dev_attr.attr,\n\t&iio_dev_attr_enable_proportion_DACA.dev_attr.attr,\n\t&iio_dev_attr_enable_proportion_DACB.dev_attr.attr,\n\t&iio_dev_attr_DAC_2Vref_channels_mask.dev_attr.attr,\n\t&iio_dev_attr_DAC_update_mode.dev_attr.attr,\n\t&iio_dev_attr_all_DAC_update_modes.dev_attr.attr,\n\t&iio_dev_attr_update_DAC.dev_attr.attr,\n\t&iio_dev_attr_DA_AB_Vref_bypass.dev_attr.attr,\n\t&iio_dev_attr_DA_CD_Vref_bypass.dev_attr.attr,\n\t&iio_dev_attr_DAC_internal_Vref.dev_attr.attr,\n\t&iio_dev_attr_VDD.dev_attr.attr,\n\t&iio_dev_attr_in_temp.dev_attr.attr,\n\t&iio_dev_attr_ex_temp.dev_attr.attr,\n\t&iio_dev_attr_in_temp_offset.dev_attr.attr,\n\t&iio_dev_attr_ex_temp_offset.dev_attr.attr,\n\t&iio_dev_attr_in_analog_temp_offset.dev_attr.attr,\n\t&iio_dev_attr_ex_analog_temp_offset.dev_attr.attr,\n\t&iio_dev_attr_DAC_A.dev_attr.attr,\n\t&iio_dev_attr_DAC_B.dev_attr.attr,\n\t&iio_dev_attr_DAC_C.dev_attr.attr,\n\t&iio_dev_attr_DAC_D.dev_attr.attr,\n\t&iio_dev_attr_device_id.dev_attr.attr,\n\t&iio_dev_attr_manufactorer_id.dev_attr.attr,\n\t&iio_dev_attr_device_rev.dev_attr.attr,\n\t&iio_dev_attr_bus_type.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group adt7316_attribute_group = {\n\t.attrs = adt7316_attributes,\n};\n\nstatic struct attribute *adt7516_attributes[] = {\n\t&iio_dev_attr_all_modes.dev_attr.attr,\n\t&iio_dev_attr_mode.dev_attr.attr,\n\t&iio_dev_attr_select_ex_temp.dev_attr.attr,\n\t&iio_dev_attr_enabled.dev_attr.attr,\n\t&iio_dev_attr_ad_channel.dev_attr.attr,\n\t&iio_dev_attr_all_ad_channels.dev_attr.attr,\n\t&iio_dev_attr_disable_averaging.dev_attr.attr,\n\t&iio_dev_attr_enable_smbus_timeout.dev_attr.attr,\n\t&iio_dev_attr_powerdown.dev_attr.attr,\n\t&iio_dev_attr_fast_ad_clock.dev_attr.attr,\n\t&iio_dev_attr_AIN_internal_Vref.dev_attr.attr,\n\t&iio_dev_attr_da_high_resolution.dev_attr.attr,\n\t&iio_dev_attr_enable_proportion_DACA.dev_attr.attr,\n\t&iio_dev_attr_enable_proportion_DACB.dev_attr.attr,\n\t&iio_dev_attr_DAC_2Vref_channels_mask.dev_attr.attr,\n\t&iio_dev_attr_DAC_update_mode.dev_attr.attr,\n\t&iio_dev_attr_all_DAC_update_modes.dev_attr.attr,\n\t&iio_dev_attr_update_DAC.dev_attr.attr,\n\t&iio_dev_attr_DAC_internal_Vref.dev_attr.attr,\n\t&iio_dev_attr_VDD.dev_attr.attr,\n\t&iio_dev_attr_in_temp.dev_attr.attr,\n\t&iio_dev_attr_ex_temp_AIN1.dev_attr.attr,\n\t&iio_dev_attr_AIN2.dev_attr.attr,\n\t&iio_dev_attr_AIN3.dev_attr.attr,\n\t&iio_dev_attr_AIN4.dev_attr.attr,\n\t&iio_dev_attr_in_temp_offset.dev_attr.attr,\n\t&iio_dev_attr_ex_temp_offset.dev_attr.attr,\n\t&iio_dev_attr_in_analog_temp_offset.dev_attr.attr,\n\t&iio_dev_attr_ex_analog_temp_offset.dev_attr.attr,\n\t&iio_dev_attr_DAC_A.dev_attr.attr,\n\t&iio_dev_attr_DAC_B.dev_attr.attr,\n\t&iio_dev_attr_DAC_C.dev_attr.attr,\n\t&iio_dev_attr_DAC_D.dev_attr.attr,\n\t&iio_dev_attr_device_id.dev_attr.attr,\n\t&iio_dev_attr_manufactorer_id.dev_attr.attr,\n\t&iio_dev_attr_device_rev.dev_attr.attr,\n\t&iio_dev_attr_bus_type.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group adt7516_attribute_group = {\n\t.attrs = adt7516_attributes,\n};\n\nstatic irqreturn_t adt7316_event_handler(int irq, void *private)\n{\n\tstruct iio_dev *indio_dev = private;\n\tstruct adt7316_chip_info *chip = iio_priv(indio_dev);\n\tu8 stat1, stat2;\n\tint ret;\n\ts64 time;\n\n\tret = chip->bus.read(chip->bus.client, ADT7316_INT_STAT1, &stat1);\n\tif (!ret) {\n\t\tif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\n\t\t\tstat1 &= 0x1F;\n\n\t\ttime = iio_get_time_ns(indio_dev);\n\t\tif (stat1 & BIT(0))\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_UNMOD_EVENT_CODE(IIO_TEMP, 0,\n\t\t\t\t\t\t\t    IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t\t    IIO_EV_DIR_RISING),\n\t\t\t\t       time);\n\t\tif (stat1 & BIT(1))\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_UNMOD_EVENT_CODE(IIO_TEMP, 0,\n\t\t\t\t\t\t\t    IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t\t    IIO_EV_DIR_FALLING),\n\t\t\t\t       time);\n\t\tif (stat1 & BIT(2))\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_UNMOD_EVENT_CODE(IIO_TEMP, 1,\n\t\t\t\t\t\t\t    IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t\t    IIO_EV_DIR_RISING),\n\t\t\t\t       time);\n\t\tif (stat1 & BIT(3))\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_UNMOD_EVENT_CODE(IIO_TEMP, 1,\n\t\t\t\t\t\t\t    IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t\t    IIO_EV_DIR_FALLING),\n\t\t\t\t       time);\n\t\tif (stat1 & BIT(5))\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 1,\n\t\t\t\t\t\t\t    IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t\t    IIO_EV_DIR_EITHER),\n\t\t\t\t       time);\n\t\tif (stat1 & BIT(6))\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 2,\n\t\t\t\t\t\t\t    IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t\t    IIO_EV_DIR_EITHER),\n\t\t\t\t       time);\n\t\tif (stat1 & BIT(7))\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 3,\n\t\t\t\t\t\t\t    IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t\t    IIO_EV_DIR_EITHER),\n\t\t\t\t       time);\n\t\t}\n\tret = chip->bus.read(chip->bus.client, ADT7316_INT_STAT2, &stat2);\n\tif (!ret) {\n\t\tif (stat2 & ADT7316_INT_MASK2_VDD)\n\t\t\tiio_push_event(indio_dev,\n\t\t\t\t       IIO_UNMOD_EVENT_CODE(IIO_VOLTAGE,\n\t\t\t\t\t\t\t    0,\n\t\t\t\t\t\t\t    IIO_EV_TYPE_THRESH,\n\t\t\t\t\t\t\t    IIO_EV_DIR_RISING),\n\t\t\t\t       iio_get_time_ns(indio_dev));\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int adt7316_setup_irq(struct iio_dev *indio_dev)\n{\n\tstruct adt7316_chip_info *chip = iio_priv(indio_dev);\n\tint irq_type, ret;\n\n\tirq_type = irqd_get_trigger_type(irq_get_irq_data(chip->bus.irq));\n\n\tswitch (irq_type) {\n\tcase IRQF_TRIGGER_HIGH:\n\tcase IRQF_TRIGGER_RISING:\n\t\tbreak;\n\tcase IRQF_TRIGGER_LOW:\n\tcase IRQF_TRIGGER_FALLING:\n\t\tbreak;\n\tdefault:\n\t\tdev_info(&indio_dev->dev, \"mode %d unsupported, using IRQF_TRIGGER_LOW\\n\",\n\t\t\t irq_type);\n\t\tirq_type = IRQF_TRIGGER_LOW;\n\t\tbreak;\n\t}\n\n\tret = devm_request_threaded_irq(&indio_dev->dev, chip->bus.irq,\n\t\t\t\t\tNULL, adt7316_event_handler,\n\t\t\t\t\tirq_type | IRQF_ONESHOT,\n\t\t\t\t\tindio_dev->name, indio_dev);\n\tif (ret) {\n\t\tdev_err(&indio_dev->dev, \"failed to request irq %d\\n\",\n\t\t\tchip->bus.irq);\n\t\treturn ret;\n\t}\n\n\tif (irq_type & IRQF_TRIGGER_HIGH)\n\t\tchip->config1 |= ADT7316_INT_POLARITY;\n\n\treturn 0;\n}\n\n \nstatic ssize_t adt7316_show_int_mask(struct device *dev,\n\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t     char *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"0x%x\\n\", chip->int_mask);\n}\n\n \nstatic ssize_t adt7316_set_int_mask(struct device *dev,\n\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t    const char *buf,\n\t\t\t\t    size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu16 data;\n\tint ret;\n\tu8 mask;\n\n\tret = kstrtou16(buf, 16, &data);\n\tif (ret || data >= ADT7316_VDD_INT_MASK + 1)\n\t\treturn -EINVAL;\n\n\tif (data & ADT7316_VDD_INT_MASK)\n\t\tmask = 0;\t\t\t \n\telse\n\t\tmask = ADT7316_INT_MASK2_VDD;\t \n\n\tret = chip->bus.write(chip->bus.client, ADT7316_INT_MASK2, mask);\n\tif (!ret) {\n\t\tchip->int_mask &= ~ADT7316_VDD_INT_MASK;\n\t\tchip->int_mask |= data & ADT7316_VDD_INT_MASK;\n\t}\n\n\tif (data & ADT7316_TEMP_AIN_INT_MASK) {\n\t\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT73XX)\n\t\t\t \n\t\t\tmask = (~data) & ADT7316_TEMP_INT_MASK;\n\t\telse\n\t\t\t \n\t\t\tmask = (~data) & ADT7316_TEMP_AIN_INT_MASK;\n\t}\n\tret = chip->bus.write(chip->bus.client, ADT7316_INT_MASK1, mask);\n\n\tchip->int_mask = mask;\n\n\treturn len;\n}\n\nstatic inline ssize_t adt7316_show_ad_bound(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    char *buf)\n{\n\tstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 val;\n\tint data;\n\tint ret;\n\n\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT73XX &&\n\t    this_attr->address > ADT7316_EX_TEMP_LOW)\n\t\treturn -EPERM;\n\n\tret = chip->bus.read(chip->bus.client, this_attr->address, &val);\n\tif (ret)\n\t\treturn -EIO;\n\n\tdata = (int)val;\n\n\tif (!((chip->id & ID_FAMILY_MASK) == ID_ADT75XX &&\n\t      (chip->config1 & ADT7516_SEL_AIN1_2_EX_TEMP_MASK) == 0)) {\n\t\tif (data & 0x80)\n\t\t\tdata -= 256;\n\t}\n\n\treturn sprintf(buf, \"%d\\n\", data);\n}\n\nstatic inline ssize_t adt7316_set_ad_bound(struct device *dev,\n\t\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t\t   const char *buf,\n\t\t\t\t\t   size_t len)\n{\n\tstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tint data;\n\tu8 val;\n\tint ret;\n\n\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT73XX &&\n\t    this_attr->address > ADT7316_EX_TEMP_LOW)\n\t\treturn -EPERM;\n\n\tret = kstrtoint(buf, 10, &data);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX &&\n\t    (chip->config1 & ADT7516_SEL_AIN1_2_EX_TEMP_MASK) == 0) {\n\t\tif (data > 255 || data < 0)\n\t\t\treturn -EINVAL;\n\t} else {\n\t\tif (data > 127 || data < -128)\n\t\t\treturn -EINVAL;\n\n\t\tif (data < 0)\n\t\t\tdata += 256;\n\t}\n\n\tval = (u8)data;\n\n\tret = chip->bus.write(chip->bus.client, this_attr->address, val);\n\tif (ret)\n\t\treturn -EIO;\n\n\treturn len;\n}\n\nstatic ssize_t adt7316_show_int_enabled(struct device *dev,\n\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\tchar *buf)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn sprintf(buf, \"%d\\n\", !!(chip->config1 & ADT7316_INT_EN));\n}\n\nstatic ssize_t adt7316_set_int_enabled(struct device *dev,\n\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t       const char *buf,\n\t\t\t\t       size_t len)\n{\n\tstruct iio_dev *dev_info = dev_to_iio_dev(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\tu8 config1;\n\tint ret;\n\n\tconfig1 = chip->config1 & (~ADT7316_INT_EN);\n\tif (buf[0] == '1')\n\t\tconfig1 |= ADT7316_INT_EN;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, config1);\n\tif (ret)\n\t\treturn -EIO;\n\n\tchip->config1 = config1;\n\n\treturn len;\n}\n\nstatic IIO_DEVICE_ATTR(int_mask,\n\t\t       0644,\n\t\t       adt7316_show_int_mask, adt7316_set_int_mask,\n\t\t       0);\nstatic IIO_DEVICE_ATTR(in_temp_high_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7316_IN_TEMP_HIGH);\nstatic IIO_DEVICE_ATTR(in_temp_low_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7316_IN_TEMP_LOW);\nstatic IIO_DEVICE_ATTR(ex_temp_high_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7316_EX_TEMP_HIGH);\nstatic IIO_DEVICE_ATTR(ex_temp_low_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7316_EX_TEMP_LOW);\n\n \nstatic IIO_DEVICE_ATTR(ex_temp_ain1_high_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7316_EX_TEMP_HIGH);\nstatic IIO_DEVICE_ATTR(ex_temp_ain1_low_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7316_EX_TEMP_LOW);\nstatic IIO_DEVICE_ATTR(ain2_high_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7516_AIN2_HIGH);\nstatic IIO_DEVICE_ATTR(ain2_low_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7516_AIN2_LOW);\nstatic IIO_DEVICE_ATTR(ain3_high_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7516_AIN3_HIGH);\nstatic IIO_DEVICE_ATTR(ain3_low_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7516_AIN3_LOW);\nstatic IIO_DEVICE_ATTR(ain4_high_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7516_AIN4_HIGH);\nstatic IIO_DEVICE_ATTR(ain4_low_value,\n\t\t       0644,\n\t\t       adt7316_show_ad_bound, adt7316_set_ad_bound,\n\t\t       ADT7516_AIN4_LOW);\nstatic IIO_DEVICE_ATTR(int_enabled,\n\t\t       0644,\n\t\t       adt7316_show_int_enabled,\n\t\t       adt7316_set_int_enabled, 0);\n\nstatic struct attribute *adt7316_event_attributes[] = {\n\t&iio_dev_attr_int_mask.dev_attr.attr,\n\t&iio_dev_attr_in_temp_high_value.dev_attr.attr,\n\t&iio_dev_attr_in_temp_low_value.dev_attr.attr,\n\t&iio_dev_attr_ex_temp_high_value.dev_attr.attr,\n\t&iio_dev_attr_ex_temp_low_value.dev_attr.attr,\n\t&iio_dev_attr_int_enabled.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group adt7316_event_attribute_group = {\n\t.attrs = adt7316_event_attributes,\n\t.name = \"events\",\n};\n\nstatic struct attribute *adt7516_event_attributes[] = {\n\t&iio_dev_attr_int_mask.dev_attr.attr,\n\t&iio_dev_attr_in_temp_high_value.dev_attr.attr,\n\t&iio_dev_attr_in_temp_low_value.dev_attr.attr,\n\t&iio_dev_attr_ex_temp_ain1_high_value.dev_attr.attr,\n\t&iio_dev_attr_ex_temp_ain1_low_value.dev_attr.attr,\n\t&iio_dev_attr_ain2_high_value.dev_attr.attr,\n\t&iio_dev_attr_ain2_low_value.dev_attr.attr,\n\t&iio_dev_attr_ain3_high_value.dev_attr.attr,\n\t&iio_dev_attr_ain3_low_value.dev_attr.attr,\n\t&iio_dev_attr_ain4_high_value.dev_attr.attr,\n\t&iio_dev_attr_ain4_low_value.dev_attr.attr,\n\t&iio_dev_attr_int_enabled.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group adt7516_event_attribute_group = {\n\t.attrs = adt7516_event_attributes,\n\t.name = \"events\",\n};\n\n#ifdef CONFIG_PM_SLEEP\nstatic int adt7316_disable(struct device *dev)\n{\n\tstruct iio_dev *dev_info = dev_get_drvdata(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn _adt7316_store_enabled(chip, 0);\n}\n\nstatic int adt7316_enable(struct device *dev)\n{\n\tstruct iio_dev *dev_info = dev_get_drvdata(dev);\n\tstruct adt7316_chip_info *chip = iio_priv(dev_info);\n\n\treturn _adt7316_store_enabled(chip, 1);\n}\nEXPORT_SYMBOL_GPL(adt7316_pm_ops);\nSIMPLE_DEV_PM_OPS(adt7316_pm_ops, adt7316_disable, adt7316_enable);\n#endif\n\nstatic const struct iio_info adt7316_info = {\n\t.attrs = &adt7316_attribute_group,\n\t.event_attrs = &adt7316_event_attribute_group,\n};\n\nstatic const struct iio_info adt7516_info = {\n\t.attrs = &adt7516_attribute_group,\n\t.event_attrs = &adt7516_event_attribute_group,\n};\n\n \nint adt7316_probe(struct device *dev, struct adt7316_bus *bus,\n\t\t  const char *name)\n{\n\tstruct adt7316_chip_info *chip;\n\tstruct iio_dev *indio_dev;\n\tint ret;\n\n\tindio_dev = devm_iio_device_alloc(dev, sizeof(*chip));\n\tif (!indio_dev)\n\t\treturn -ENOMEM;\n\tchip = iio_priv(indio_dev);\n\t \n\tdev_set_drvdata(dev, indio_dev);\n\n\tchip->bus = *bus;\n\n\tif (name[4] == '3')\n\t\tchip->id = ID_ADT7316 + (name[6] - '6');\n\telse if (name[4] == '5')\n\t\tchip->id = ID_ADT7516 + (name[6] - '6');\n\telse\n\t\treturn -ENODEV;\n\n\tif (chip->id == ID_ADT7316 || chip->id == ID_ADT7516)\n\t\tchip->dac_bits = 12;\n\telse if (chip->id == ID_ADT7317 || chip->id == ID_ADT7517)\n\t\tchip->dac_bits = 10;\n\telse\n\t\tchip->dac_bits = 8;\n\n\tchip->ldac_pin = devm_gpiod_get_optional(dev, \"adi,ldac\",\n\t\t\t\t\t\t GPIOD_OUT_LOW);\n\tif (IS_ERR(chip->ldac_pin)) {\n\t\tret = PTR_ERR(chip->ldac_pin);\n\t\tdev_err(dev, \"Failed to request ldac GPIO: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (!chip->ldac_pin) {\n\t\tchip->config3 |= ADT7316_DA_EN_VIA_DAC_LDAC;\n\t\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\n\t\t\tchip->config1 |= ADT7516_SEL_AIN3;\n\t}\n\tchip->int_mask = ADT7316_TEMP_INT_MASK | ADT7316_VDD_INT_MASK;\n\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\n\t\tchip->int_mask |= ADT7516_AIN_INT_MASK;\n\n\tif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\n\t\tindio_dev->info = &adt7516_info;\n\telse\n\t\tindio_dev->info = &adt7316_info;\n\tindio_dev->name = name;\n\tindio_dev->modes = INDIO_DIRECT_MODE;\n\n\tif (chip->bus.irq > 0) {\n\t\tret = adt7316_setup_irq(indio_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, chip->config1);\n\tif (ret)\n\t\treturn -EIO;\n\n\tret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, chip->config3);\n\tif (ret)\n\t\treturn -EIO;\n\n\tret = devm_iio_device_register(dev, indio_dev);\n\tif (ret)\n\t\treturn ret;\n\n\tdev_info(dev, \"%s temperature sensor, ADC and DAC registered.\\n\",\n\t\t indio_dev->name);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(adt7316_probe);\n\nMODULE_AUTHOR(\"Sonic Zhang <sonic.zhang@analog.com>\");\nMODULE_DESCRIPTION(\"Analog Devices ADT7316/7/8 and ADT7516/7/9 digital temperature sensor, ADC and DAC driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}