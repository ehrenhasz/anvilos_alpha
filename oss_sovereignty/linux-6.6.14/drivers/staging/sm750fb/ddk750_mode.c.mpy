{
  "module_name": "ddk750_mode.c",
  "hash_id": "804c22c6d3e138546f9f7a4df3d8de29465b1d5c889e1b477b853d554d7d0b03",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/sm750fb/ddk750_mode.c",
  "human_readable_source": "\n\n#include \"ddk750_reg.h\"\n#include \"ddk750_mode.h\"\n#include \"ddk750_chip.h\"\n\n \nstatic unsigned long\ndisplayControlAdjust_SM750LE(struct mode_parameter *pModeParam,\n\t\t\t     unsigned long dispControl)\n{\n\tunsigned long x, y;\n\n\tx = pModeParam->horizontal_display_end;\n\ty = pModeParam->vertical_display_end;\n\n\t \n\tpoke32(CRT_AUTO_CENTERING_TL, 0);\n\n\tpoke32(CRT_AUTO_CENTERING_BR,\n\t       (((y - 1) << CRT_AUTO_CENTERING_BR_BOTTOM_SHIFT) &\n\t\tCRT_AUTO_CENTERING_BR_BOTTOM_MASK) |\n\t       ((x - 1) & CRT_AUTO_CENTERING_BR_RIGHT_MASK));\n\n\t \n\n\t \n\tdispControl &= ~CRT_DISPLAY_CTRL_CLK_MASK;\n\n\t \n\t \n\tif (x == 800 && y == 600)\n\t\tdispControl |= CRT_DISPLAY_CTRL_CLK_PLL41;\n\telse if (x == 1024 && y == 768)\n\t\tdispControl |= CRT_DISPLAY_CTRL_CLK_PLL65;\n\telse if (x == 1152 && y == 864)\n\t\tdispControl |= CRT_DISPLAY_CTRL_CLK_PLL80;\n\telse if (x == 1280 && y == 768)\n\t\tdispControl |= CRT_DISPLAY_CTRL_CLK_PLL80;\n\telse if (x == 1280 && y == 720)\n\t\tdispControl |= CRT_DISPLAY_CTRL_CLK_PLL74;\n\telse if (x == 1280 && y == 960)\n\t\tdispControl |= CRT_DISPLAY_CTRL_CLK_PLL108;\n\telse if (x == 1280 && y == 1024)\n\t\tdispControl |= CRT_DISPLAY_CTRL_CLK_PLL108;\n\telse  \n\t\tdispControl |= CRT_DISPLAY_CTRL_CLK_PLL25;\n\n\t \n\tdispControl |= (CRT_DISPLAY_CTRL_CRTSELECT | CRT_DISPLAY_CTRL_RGBBIT);\n\n\t \n\tdispControl |= DISPLAY_CTRL_CLOCK_PHASE;\n\n\tpoke32(CRT_DISPLAY_CTRL, dispControl);\n\n\treturn dispControl;\n}\n\n \nstatic int programModeRegisters(struct mode_parameter *pModeParam,\n\t\t\t\tstruct pll_value *pll)\n{\n\tint ret = 0;\n\tint cnt = 0;\n\tunsigned int tmp, reg;\n\n\tif (pll->clock_type == SECONDARY_PLL) {\n\t\t \n\t\tpoke32(CRT_PLL_CTRL, sm750_format_pll_reg(pll));\n\n\t\ttmp = ((pModeParam->horizontal_total - 1) <<\n\t\t       CRT_HORIZONTAL_TOTAL_TOTAL_SHIFT) &\n\t\t     CRT_HORIZONTAL_TOTAL_TOTAL_MASK;\n\t\ttmp |= (pModeParam->horizontal_display_end - 1) &\n\t\t      CRT_HORIZONTAL_TOTAL_DISPLAY_END_MASK;\n\n\t\tpoke32(CRT_HORIZONTAL_TOTAL, tmp);\n\n\t\ttmp = (pModeParam->horizontal_sync_width <<\n\t\t       CRT_HORIZONTAL_SYNC_WIDTH_SHIFT) &\n\t\t     CRT_HORIZONTAL_SYNC_WIDTH_MASK;\n\t\ttmp |= (pModeParam->horizontal_sync_start - 1) &\n\t\t      CRT_HORIZONTAL_SYNC_START_MASK;\n\n\t\tpoke32(CRT_HORIZONTAL_SYNC, tmp);\n\n\t\ttmp = ((pModeParam->vertical_total - 1) <<\n\t\t       CRT_VERTICAL_TOTAL_TOTAL_SHIFT) &\n\t\t     CRT_VERTICAL_TOTAL_TOTAL_MASK;\n\t\ttmp |= (pModeParam->vertical_display_end - 1) &\n\t\t      CRT_VERTICAL_TOTAL_DISPLAY_END_MASK;\n\n\t\tpoke32(CRT_VERTICAL_TOTAL, tmp);\n\n\t\ttmp = ((pModeParam->vertical_sync_height <<\n\t\t       CRT_VERTICAL_SYNC_HEIGHT_SHIFT)) &\n\t\t     CRT_VERTICAL_SYNC_HEIGHT_MASK;\n\t\ttmp |= (pModeParam->vertical_sync_start - 1) &\n\t\t      CRT_VERTICAL_SYNC_START_MASK;\n\n\t\tpoke32(CRT_VERTICAL_SYNC, tmp);\n\n\t\ttmp = DISPLAY_CTRL_TIMING | DISPLAY_CTRL_PLANE;\n\t\tif (pModeParam->vertical_sync_polarity)\n\t\t\ttmp |= DISPLAY_CTRL_VSYNC_PHASE;\n\t\tif (pModeParam->horizontal_sync_polarity)\n\t\t\ttmp |= DISPLAY_CTRL_HSYNC_PHASE;\n\n\t\tif (sm750_get_chip_type() == SM750LE) {\n\t\t\tdisplayControlAdjust_SM750LE(pModeParam, tmp);\n\t\t} else {\n\t\t\treg = peek32(CRT_DISPLAY_CTRL) &\n\t\t\t\t~(DISPLAY_CTRL_VSYNC_PHASE |\n\t\t\t\t  DISPLAY_CTRL_HSYNC_PHASE |\n\t\t\t\t  DISPLAY_CTRL_TIMING | DISPLAY_CTRL_PLANE);\n\n\t\t\tpoke32(CRT_DISPLAY_CTRL, tmp | reg);\n\t\t}\n\n\t} else if (pll->clock_type == PRIMARY_PLL) {\n\t\tunsigned int reserved;\n\n\t\tpoke32(PANEL_PLL_CTRL, sm750_format_pll_reg(pll));\n\n\t\treg = ((pModeParam->horizontal_total - 1) <<\n\t\t\tPANEL_HORIZONTAL_TOTAL_TOTAL_SHIFT) &\n\t\t\tPANEL_HORIZONTAL_TOTAL_TOTAL_MASK;\n\t\treg |= ((pModeParam->horizontal_display_end - 1) &\n\t\t\tPANEL_HORIZONTAL_TOTAL_DISPLAY_END_MASK);\n\t\tpoke32(PANEL_HORIZONTAL_TOTAL, reg);\n\n\t\tpoke32(PANEL_HORIZONTAL_SYNC,\n\t\t       ((pModeParam->horizontal_sync_width <<\n\t\t\t PANEL_HORIZONTAL_SYNC_WIDTH_SHIFT) &\n\t\t\tPANEL_HORIZONTAL_SYNC_WIDTH_MASK) |\n\t\t       ((pModeParam->horizontal_sync_start - 1) &\n\t\t\tPANEL_HORIZONTAL_SYNC_START_MASK));\n\n\t\tpoke32(PANEL_VERTICAL_TOTAL,\n\t\t       (((pModeParam->vertical_total - 1) <<\n\t\t\t PANEL_VERTICAL_TOTAL_TOTAL_SHIFT) &\n\t\t\tPANEL_VERTICAL_TOTAL_TOTAL_MASK) |\n\t\t       ((pModeParam->vertical_display_end - 1) &\n\t\t\tPANEL_VERTICAL_TOTAL_DISPLAY_END_MASK));\n\n\t\tpoke32(PANEL_VERTICAL_SYNC,\n\t\t       ((pModeParam->vertical_sync_height <<\n\t\t\t PANEL_VERTICAL_SYNC_HEIGHT_SHIFT) &\n\t\t\tPANEL_VERTICAL_SYNC_HEIGHT_MASK) |\n\t\t       ((pModeParam->vertical_sync_start - 1) &\n\t\t\tPANEL_VERTICAL_SYNC_START_MASK));\n\n\t\ttmp = DISPLAY_CTRL_TIMING | DISPLAY_CTRL_PLANE;\n\t\tif (pModeParam->vertical_sync_polarity)\n\t\t\ttmp |= DISPLAY_CTRL_VSYNC_PHASE;\n\t\tif (pModeParam->horizontal_sync_polarity)\n\t\t\ttmp |= DISPLAY_CTRL_HSYNC_PHASE;\n\t\tif (pModeParam->clock_phase_polarity)\n\t\t\ttmp |= DISPLAY_CTRL_CLOCK_PHASE;\n\n\t\treserved = PANEL_DISPLAY_CTRL_RESERVED_MASK |\n\t\t\tPANEL_DISPLAY_CTRL_VSYNC;\n\n\t\treg = (peek32(PANEL_DISPLAY_CTRL) & ~reserved) &\n\t\t\t~(DISPLAY_CTRL_CLOCK_PHASE | DISPLAY_CTRL_VSYNC_PHASE |\n\t\t\t  DISPLAY_CTRL_HSYNC_PHASE | DISPLAY_CTRL_TIMING |\n\t\t\t  DISPLAY_CTRL_PLANE);\n\n\t\t \n\t\tpoke32(PANEL_DISPLAY_CTRL, tmp | reg);\n\n\t\twhile ((peek32(PANEL_DISPLAY_CTRL) & ~reserved) !=\n\t\t\t(tmp | reg)) {\n\t\t\tcnt++;\n\t\t\tif (cnt > 1000)\n\t\t\t\tbreak;\n\t\t\tpoke32(PANEL_DISPLAY_CTRL, tmp | reg);\n\t\t}\n\t} else {\n\t\tret = -1;\n\t}\n\treturn ret;\n}\n\nint ddk750_setModeTiming(struct mode_parameter *parm, enum clock_type clock)\n{\n\tstruct pll_value pll;\n\n\tpll.input_freq = DEFAULT_INPUT_CLOCK;\n\tpll.clock_type = clock;\n\n\tsm750_calc_pll_value(parm->pixel_clock, &pll);\n\tif (sm750_get_chip_type() == SM750LE) {\n\t\t \n\t\toutb_p(0x88, 0x3d4);\n\t\toutb_p(0x06, 0x3d5);\n\t}\n\tprogramModeRegisters(parm, &pll);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}