{
  "module_name": "ddk750_swi2c.c",
  "hash_id": "39ffe2e827741758dbf03293b664406c92a000622192ff954d7c1005fe0e0194",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/sm750fb/ddk750_swi2c.c",
  "human_readable_source": "\n \n\n#include \"ddk750_chip.h\"\n#include \"ddk750_reg.h\"\n#include \"ddk750_swi2c.h\"\n#include \"ddk750_power.h\"\n\n \n\n \nstatic unsigned char sw_i2c_clk_gpio = DEFAULT_I2C_SCL;\nstatic unsigned char sw_i2c_data_gpio = DEFAULT_I2C_SDA;\n\n \n\n \nstatic unsigned long sw_i2c_clk_gpio_mux_reg = GPIO_MUX;\nstatic unsigned long sw_i2c_clk_gpio_data_reg = GPIO_DATA;\nstatic unsigned long sw_i2c_clk_gpio_data_dir_reg = GPIO_DATA_DIRECTION;\n\n \nstatic unsigned long sw_i2c_data_gpio_mux_reg = GPIO_MUX;\nstatic unsigned long sw_i2c_data_gpio_data_reg = GPIO_DATA;\nstatic unsigned long sw_i2c_data_gpio_data_dir_reg = GPIO_DATA_DIRECTION;\n\n \nstatic void sw_i2c_wait(void)\n{\n\t \n\n     \n\tint i, tmp;\n\n\tfor (i = 0; i < 600; i++) {\n\t\ttmp = i;\n\t\ttmp += i;\n\t}\n}\n\n \nstatic void sw_i2c_scl(unsigned char value)\n{\n\tunsigned long gpio_data;\n\tunsigned long gpio_dir;\n\n\tgpio_dir = peek32(sw_i2c_clk_gpio_data_dir_reg);\n\tif (value) {     \n\t\t \n\t\tgpio_dir &= ~(1 << sw_i2c_clk_gpio);\n\t\tpoke32(sw_i2c_clk_gpio_data_dir_reg, gpio_dir);\n\t} else {         \n\t\t \n\t\tgpio_data = peek32(sw_i2c_clk_gpio_data_reg);\n\t\tgpio_data &= ~(1 << sw_i2c_clk_gpio);\n\t\tpoke32(sw_i2c_clk_gpio_data_reg, gpio_data);\n\n\t\t \n\t\tgpio_dir |= (1 << sw_i2c_clk_gpio);\n\t\tpoke32(sw_i2c_clk_gpio_data_dir_reg, gpio_dir);\n\t}\n}\n\n \nstatic void sw_i2c_sda(unsigned char value)\n{\n\tunsigned long gpio_data;\n\tunsigned long gpio_dir;\n\n\tgpio_dir = peek32(sw_i2c_data_gpio_data_dir_reg);\n\tif (value) {     \n\t\t \n\t\tgpio_dir &= ~(1 << sw_i2c_data_gpio);\n\t\tpoke32(sw_i2c_data_gpio_data_dir_reg, gpio_dir);\n\t} else {         \n\t\t \n\t\tgpio_data = peek32(sw_i2c_data_gpio_data_reg);\n\t\tgpio_data &= ~(1 << sw_i2c_data_gpio);\n\t\tpoke32(sw_i2c_data_gpio_data_reg, gpio_data);\n\n\t\t \n\t\tgpio_dir |= (1 << sw_i2c_data_gpio);\n\t\tpoke32(sw_i2c_data_gpio_data_dir_reg, gpio_dir);\n\t}\n}\n\n \nstatic unsigned char sw_i2c_read_sda(void)\n{\n\tunsigned long gpio_dir;\n\tunsigned long gpio_data;\n\tunsigned long dir_mask = 1 << sw_i2c_data_gpio;\n\n\t \n\tgpio_dir = peek32(sw_i2c_data_gpio_data_dir_reg);\n\tif ((gpio_dir & dir_mask) != ~dir_mask) {\n\t\tgpio_dir &= ~(1 << sw_i2c_data_gpio);\n\t\tpoke32(sw_i2c_data_gpio_data_dir_reg, gpio_dir);\n\t}\n\n\t \n\tgpio_data = peek32(sw_i2c_data_gpio_data_reg);\n\tif (gpio_data & (1 << sw_i2c_data_gpio))\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\n \nstatic void sw_i2c_ack(void)\n{\n\treturn;   \n}\n\n \nstatic void sw_i2c_start(void)\n{\n\t \n\tsw_i2c_sda(1);\n\tsw_i2c_scl(1);\n\tsw_i2c_sda(0);\n}\n\n \nstatic void sw_i2c_stop(void)\n{\n\t \n\tsw_i2c_scl(1);\n\tsw_i2c_sda(0);\n\tsw_i2c_sda(1);\n}\n\n \nstatic long sw_i2c_write_byte(unsigned char data)\n{\n\tunsigned char value = data;\n\tint i;\n\n\t \n\tfor (i = 0; i < 8; i++) {\n\t\t \n\t\tsw_i2c_scl(0);\n\n\t\t \n\t\tif ((value & 0x80) != 0)\n\t\t\tsw_i2c_sda(1);\n\t\telse\n\t\t\tsw_i2c_sda(0);\n\n\t\tsw_i2c_wait();\n\n\t\t \n\t\tsw_i2c_scl(1);\n\t\tsw_i2c_wait();\n\n\t\t \n\t\tvalue = value << 1;\n\t}\n\n\t \n\tsw_i2c_scl(0);\n\tsw_i2c_sda(1);\n\n\t \n\tsw_i2c_wait();\n\tsw_i2c_scl(1);\n\tsw_i2c_wait();\n\n\t \n\tfor (i = 0; i < 0xff; i++) {\n\t\tif (!sw_i2c_read_sda())\n\t\t\tbreak;\n\n\t\tsw_i2c_scl(0);\n\t\tsw_i2c_wait();\n\t\tsw_i2c_scl(1);\n\t\tsw_i2c_wait();\n\t}\n\n\t \n\tsw_i2c_scl(0);\n\tsw_i2c_sda(1);\n\n\tif (i < 0xff)\n\t\treturn 0;\n\telse\n\t\treturn -1;\n}\n\n \nstatic unsigned char sw_i2c_read_byte(unsigned char ack)\n{\n\tint i;\n\tunsigned char data = 0;\n\n\tfor (i = 7; i >= 0; i--) {\n\t\t \n\t\tsw_i2c_scl(0);\n\t\tsw_i2c_sda(1);\n\t\tsw_i2c_wait();\n\n\t\t \n\t\tsw_i2c_scl(1);\n\t\tsw_i2c_wait();\n\n\t\t \n\t\tdata |= (sw_i2c_read_sda() << i);\n\t}\n\n\tif (ack)\n\t\tsw_i2c_ack();\n\n\t \n\tsw_i2c_scl(0);\n\tsw_i2c_sda(1);\n\n\treturn data;\n}\n\n \nstatic long sm750le_i2c_init(unsigned char clk_gpio, unsigned char data_gpio)\n{\n\tint i;\n\n\t \n\tsw_i2c_clk_gpio_data_reg = GPIO_DATA_SM750LE;\n\tsw_i2c_clk_gpio_data_dir_reg = GPIO_DATA_DIRECTION_SM750LE;\n\n\t \n\tsw_i2c_clk_gpio = clk_gpio;\n\n\t \n\tsw_i2c_data_gpio_data_reg = GPIO_DATA_SM750LE;\n\tsw_i2c_data_gpio_data_dir_reg = GPIO_DATA_DIRECTION_SM750LE;\n\n\t \n\tsw_i2c_data_gpio = data_gpio;\n\n\t \n\n\t \n\tfor (i = 0; i < 9; i++)\n\t\tsw_i2c_stop();\n\n\treturn 0;\n}\n\n \nlong sm750_sw_i2c_init(unsigned char clk_gpio, unsigned char data_gpio)\n{\n\tint i;\n\n\t \n\tif ((clk_gpio > 31) || (data_gpio > 31))\n\t\treturn -1;\n\n\tif (sm750_get_chip_type() == SM750LE)\n\t\treturn sm750le_i2c_init(clk_gpio, data_gpio);\n\n\t \n\tsw_i2c_clk_gpio_mux_reg = GPIO_MUX;\n\tsw_i2c_clk_gpio_data_reg = GPIO_DATA;\n\tsw_i2c_clk_gpio_data_dir_reg = GPIO_DATA_DIRECTION;\n\n\t \n\tsw_i2c_clk_gpio = clk_gpio;\n\n\t \n\tsw_i2c_data_gpio_mux_reg = GPIO_MUX;\n\tsw_i2c_data_gpio_data_reg = GPIO_DATA;\n\tsw_i2c_data_gpio_data_dir_reg = GPIO_DATA_DIRECTION;\n\n\t \n\tsw_i2c_data_gpio = data_gpio;\n\n\t \n\tpoke32(sw_i2c_clk_gpio_mux_reg,\n\t       peek32(sw_i2c_clk_gpio_mux_reg) & ~(1 << sw_i2c_clk_gpio));\n\tpoke32(sw_i2c_data_gpio_mux_reg,\n\t       peek32(sw_i2c_data_gpio_mux_reg) & ~(1 << sw_i2c_data_gpio));\n\n\t \n\tsm750_enable_gpio(1);\n\n\t \n\tfor (i = 0; i < 9; i++)\n\t\tsw_i2c_stop();\n\n\treturn 0;\n}\n\n \nunsigned char sm750_sw_i2c_read_reg(unsigned char addr, unsigned char reg)\n{\n\tunsigned char data;\n\n\t \n\tsw_i2c_start();\n\n\t \n\tsw_i2c_write_byte(addr);\n\n\t \n\tsw_i2c_write_byte(reg);\n\n\t \n\tsw_i2c_start();\n\tsw_i2c_write_byte(addr + 1);\n\tdata = sw_i2c_read_byte(1);\n\n\t \n\tsw_i2c_stop();\n\n\treturn data;\n}\n\n \nlong sm750_sw_i2c_write_reg(unsigned char addr,\n\t\t\t    unsigned char reg,\n\t\t\t    unsigned char data)\n{\n\tlong ret = 0;\n\n\t \n\tsw_i2c_start();\n\n\t \n\tif ((sw_i2c_write_byte(addr) != 0) ||\n\t    (sw_i2c_write_byte(reg) != 0) ||\n\t    (sw_i2c_write_byte(data) != 0)) {\n\t\tret = -1;\n\t}\n\n\t \n\tsw_i2c_stop();\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}