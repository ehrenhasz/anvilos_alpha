{
  "module_name": "qlge_devlink.c",
  "hash_id": "a0670a80ac83ce71499be1f1d195566e635b00116e38ade84fbafe6f16b4e5ab",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/qlge/qlge_devlink.c",
  "human_readable_source": "\n#include \"qlge.h\"\n#include \"qlge_devlink.h\"\n\nstatic int qlge_fill_seg_(struct devlink_fmsg *fmsg,\n\t\t\t  struct mpi_coredump_segment_header *seg_header,\n\t\t\t  u32 *reg_data)\n{\n\tint regs_num = (seg_header->seg_size\n\t\t\t- sizeof(struct mpi_coredump_segment_header)) / sizeof(u32);\n\tint err;\n\tint i;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, seg_header->description);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_obj_nest_start(fmsg);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"segment\", seg_header->seg_num);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_arr_pair_nest_start(fmsg, \"values\");\n\tif (err)\n\t\treturn err;\n\tfor (i = 0; i < regs_num; i++) {\n\t\terr = devlink_fmsg_u32_put(fmsg, *reg_data);\n\t\tif (err)\n\t\t\treturn err;\n\t\treg_data++;\n\t}\n\terr = devlink_fmsg_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_arr_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_pair_nest_end(fmsg);\n\treturn err;\n}\n\n#define FILL_SEG(seg_hdr, seg_regs)\t\t\t                    \\\n\tdo {                                                                \\\n\t\terr = qlge_fill_seg_(fmsg, &dump->seg_hdr, dump->seg_regs); \\\n\t\tif (err) {\t\t\t\t\t            \\\n\t\t\tkvfree(dump);                                       \\\n\t\t\treturn err;\t\t\t\t            \\\n\t\t}                                                           \\\n\t} while (0)\n\nstatic int qlge_reporter_coredump(struct devlink_health_reporter *reporter,\n\t\t\t\t  struct devlink_fmsg *fmsg, void *priv_ctx,\n\t\t\t\t  struct netlink_ext_ack *extack)\n{\n\tint err = 0;\n\n\tstruct qlge_adapter *qdev = devlink_health_reporter_priv(reporter);\n\tstruct qlge_mpi_coredump *dump;\n\twait_queue_head_t wait;\n\n\tif (!netif_running(qdev->ndev))\n\t\treturn 0;\n\n\tif (test_bit(QL_FRC_COREDUMP, &qdev->flags)) {\n\t\tif (qlge_own_firmware(qdev)) {\n\t\t\tqlge_queue_fw_error(qdev);\n\t\t\tinit_waitqueue_head(&wait);\n\t\t\twait_event_timeout(wait, 0, 5 * HZ);\n\t\t} else {\n\t\t\tnetif_err(qdev, ifup, qdev->ndev,\n\t\t\t\t  \"Force Coredump failed because this NIC function doesn't own the firmware\\n\");\n\t\t\treturn -EPERM;\n\t\t}\n\t}\n\n\tdump = kvmalloc(sizeof(*dump), GFP_KERNEL);\n\tif (!dump)\n\t\treturn -ENOMEM;\n\n\terr = qlge_core_dump(qdev, dump);\n\tif (err) {\n\t\tkvfree(dump);\n\t\treturn err;\n\t}\n\n\tqlge_soft_reset_mpi_risc(qdev);\n\n\tFILL_SEG(core_regs_seg_hdr, mpi_core_regs);\n\tFILL_SEG(test_logic_regs_seg_hdr, test_logic_regs);\n\tFILL_SEG(rmii_regs_seg_hdr, rmii_regs);\n\tFILL_SEG(fcmac1_regs_seg_hdr, fcmac1_regs);\n\tFILL_SEG(fcmac2_regs_seg_hdr, fcmac2_regs);\n\tFILL_SEG(fc1_mbx_regs_seg_hdr, fc1_mbx_regs);\n\tFILL_SEG(ide_regs_seg_hdr, ide_regs);\n\tFILL_SEG(nic1_mbx_regs_seg_hdr, nic1_mbx_regs);\n\tFILL_SEG(smbus_regs_seg_hdr, smbus_regs);\n\tFILL_SEG(fc2_mbx_regs_seg_hdr, fc2_mbx_regs);\n\tFILL_SEG(nic2_mbx_regs_seg_hdr, nic2_mbx_regs);\n\tFILL_SEG(i2c_regs_seg_hdr, i2c_regs);\n\tFILL_SEG(memc_regs_seg_hdr, memc_regs);\n\tFILL_SEG(pbus_regs_seg_hdr, pbus_regs);\n\tFILL_SEG(mde_regs_seg_hdr, mde_regs);\n\tFILL_SEG(nic_regs_seg_hdr, nic_regs);\n\tFILL_SEG(nic2_regs_seg_hdr, nic2_regs);\n\tFILL_SEG(xgmac1_seg_hdr, xgmac1);\n\tFILL_SEG(xgmac2_seg_hdr, xgmac2);\n\tFILL_SEG(code_ram_seg_hdr, code_ram);\n\tFILL_SEG(memc_ram_seg_hdr, memc_ram);\n\tFILL_SEG(xaui_an_hdr, serdes_xaui_an);\n\tFILL_SEG(xaui_hss_pcs_hdr, serdes_xaui_hss_pcs);\n\tFILL_SEG(xfi_an_hdr, serdes_xfi_an);\n\tFILL_SEG(xfi_train_hdr, serdes_xfi_train);\n\tFILL_SEG(xfi_hss_pcs_hdr, serdes_xfi_hss_pcs);\n\tFILL_SEG(xfi_hss_tx_hdr, serdes_xfi_hss_tx);\n\tFILL_SEG(xfi_hss_rx_hdr, serdes_xfi_hss_rx);\n\tFILL_SEG(xfi_hss_pll_hdr, serdes_xfi_hss_pll);\n\n\terr = qlge_fill_seg_(fmsg, &dump->misc_nic_seg_hdr,\n\t\t\t     (u32 *)&dump->misc_nic_info);\n\tif (err) {\n\t\tkvfree(dump);\n\t\treturn err;\n\t}\n\n\tFILL_SEG(intr_states_seg_hdr, intr_states);\n\tFILL_SEG(cam_entries_seg_hdr, cam_entries);\n\tFILL_SEG(nic_routing_words_seg_hdr, nic_routing_words);\n\tFILL_SEG(ets_seg_hdr, ets);\n\tFILL_SEG(probe_dump_seg_hdr, probe_dump);\n\tFILL_SEG(routing_reg_seg_hdr, routing_regs);\n\tFILL_SEG(mac_prot_reg_seg_hdr, mac_prot_regs);\n\tFILL_SEG(xaui2_an_hdr, serdes2_xaui_an);\n\tFILL_SEG(xaui2_hss_pcs_hdr, serdes2_xaui_hss_pcs);\n\tFILL_SEG(xfi2_an_hdr, serdes2_xfi_an);\n\tFILL_SEG(xfi2_train_hdr, serdes2_xfi_train);\n\tFILL_SEG(xfi2_hss_pcs_hdr, serdes2_xfi_hss_pcs);\n\tFILL_SEG(xfi2_hss_tx_hdr, serdes2_xfi_hss_tx);\n\tFILL_SEG(xfi2_hss_rx_hdr, serdes2_xfi_hss_rx);\n\tFILL_SEG(xfi2_hss_pll_hdr, serdes2_xfi_hss_pll);\n\tFILL_SEG(sem_regs_seg_hdr, sem_regs);\n\n\tkvfree(dump);\n\treturn err;\n}\n\nstatic const struct devlink_health_reporter_ops qlge_reporter_ops = {\n\t.name = \"coredump\",\n\t.dump = qlge_reporter_coredump,\n};\n\nlong qlge_health_create_reporters(struct qlge_adapter *priv)\n{\n\tstruct devlink *devlink;\n\tlong err = 0;\n\n\tdevlink = priv_to_devlink(priv);\n\tpriv->reporter =\n\t\tdevlink_health_reporter_create(devlink, &qlge_reporter_ops,\n\t\t\t\t\t       0, priv);\n\tif (IS_ERR(priv->reporter)) {\n\t\terr = PTR_ERR(priv->reporter);\n\t\tnetdev_warn(priv->ndev,\n\t\t\t    \"Failed to create reporter, err = %ld\\n\",\n\t\t\t    err);\n\t}\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}