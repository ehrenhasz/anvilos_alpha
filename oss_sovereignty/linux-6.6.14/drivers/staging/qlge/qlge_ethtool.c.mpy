{
  "module_name": "qlge_ethtool.c",
  "hash_id": "bf6c936086a21837447244e8335616ef6873af79b1b52d833fb037fd551cf7f6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/qlge/qlge_ethtool.c",
  "human_readable_source": "\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/module.h>\n#include <linux/list.h>\n#include <linux/pci.h>\n#include <linux/dma-mapping.h>\n#include <linux/pagemap.h>\n#include <linux/sched.h>\n#include <linux/dmapool.h>\n#include <linux/mempool.h>\n#include <linux/spinlock.h>\n#include <linux/kthread.h>\n#include <linux/interrupt.h>\n#include <linux/errno.h>\n#include <linux/ioport.h>\n#include <linux/in.h>\n#include <linux/ip.h>\n#include <linux/ipv6.h>\n#include <net/ipv6.h>\n#include <linux/tcp.h>\n#include <linux/udp.h>\n#include <linux/if_arp.h>\n#include <linux/if_ether.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/ethtool.h>\n#include <linux/skbuff.h>\n#include <linux/rtnetlink.h>\n#include <linux/if_vlan.h>\n#include <linux/delay.h>\n#include <linux/mm.h>\n#include <linux/vmalloc.h>\n\n#include \"qlge.h\"\n\nstruct qlge_stats {\n\tchar stat_string[ETH_GSTRING_LEN];\n\tint sizeof_stat;\n\tint stat_offset;\n};\n\n#define QL_SIZEOF(m) sizeof_field(struct qlge_adapter, m)\n#define QL_OFF(m) offsetof(struct qlge_adapter, m)\n\nstatic const struct qlge_stats qlge_gstrings_stats[] = {\n\t{\"tx_pkts\", QL_SIZEOF(nic_stats.tx_pkts), QL_OFF(nic_stats.tx_pkts)},\n\t{\"tx_bytes\", QL_SIZEOF(nic_stats.tx_bytes), QL_OFF(nic_stats.tx_bytes)},\n\t{\"tx_mcast_pkts\", QL_SIZEOF(nic_stats.tx_mcast_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.tx_mcast_pkts)},\n\t{\"tx_bcast_pkts\", QL_SIZEOF(nic_stats.tx_bcast_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.tx_bcast_pkts)},\n\t{\"tx_ucast_pkts\", QL_SIZEOF(nic_stats.tx_ucast_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.tx_ucast_pkts)},\n\t{\"tx_ctl_pkts\", QL_SIZEOF(nic_stats.tx_ctl_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.tx_ctl_pkts)},\n\t{\"tx_pause_pkts\", QL_SIZEOF(nic_stats.tx_pause_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.tx_pause_pkts)},\n\t{\"tx_64_pkts\", QL_SIZEOF(nic_stats.tx_64_pkt),\n\t\t\t\t\tQL_OFF(nic_stats.tx_64_pkt)},\n\t{\"tx_65_to_127_pkts\", QL_SIZEOF(nic_stats.tx_65_to_127_pkt),\n\t\t\t\t\tQL_OFF(nic_stats.tx_65_to_127_pkt)},\n\t{\"tx_128_to_255_pkts\", QL_SIZEOF(nic_stats.tx_128_to_255_pkt),\n\t\t\t\t\tQL_OFF(nic_stats.tx_128_to_255_pkt)},\n\t{\"tx_256_511_pkts\", QL_SIZEOF(nic_stats.tx_256_511_pkt),\n\t\t\t\t\tQL_OFF(nic_stats.tx_256_511_pkt)},\n\t{\"tx_512_to_1023_pkts\",\tQL_SIZEOF(nic_stats.tx_512_to_1023_pkt),\n\t\t\t\t\tQL_OFF(nic_stats.tx_512_to_1023_pkt)},\n\t{\"tx_1024_to_1518_pkts\", QL_SIZEOF(nic_stats.tx_1024_to_1518_pkt),\n\t\t\t\t\tQL_OFF(nic_stats.tx_1024_to_1518_pkt)},\n\t{\"tx_1519_to_max_pkts\",\tQL_SIZEOF(nic_stats.tx_1519_to_max_pkt),\n\t\t\t\t\tQL_OFF(nic_stats.tx_1519_to_max_pkt)},\n\t{\"tx_undersize_pkts\", QL_SIZEOF(nic_stats.tx_undersize_pkt),\n\t\t\t\t\tQL_OFF(nic_stats.tx_undersize_pkt)},\n\t{\"tx_oversize_pkts\", QL_SIZEOF(nic_stats.tx_oversize_pkt),\n\t\t\t\t\tQL_OFF(nic_stats.tx_oversize_pkt)},\n\t{\"rx_bytes\", QL_SIZEOF(nic_stats.rx_bytes), QL_OFF(nic_stats.rx_bytes)},\n\t{\"rx_bytes_ok\",\tQL_SIZEOF(nic_stats.rx_bytes_ok),\n\t\t\t\t\tQL_OFF(nic_stats.rx_bytes_ok)},\n\t{\"rx_pkts\", QL_SIZEOF(nic_stats.rx_pkts), QL_OFF(nic_stats.rx_pkts)},\n\t{\"rx_pkts_ok\", QL_SIZEOF(nic_stats.rx_pkts_ok),\n\t\t\t\t\tQL_OFF(nic_stats.rx_pkts_ok)},\n\t{\"rx_bcast_pkts\", QL_SIZEOF(nic_stats.rx_bcast_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_bcast_pkts)},\n\t{\"rx_mcast_pkts\", QL_SIZEOF(nic_stats.rx_mcast_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_mcast_pkts)},\n\t{\"rx_ucast_pkts\", QL_SIZEOF(nic_stats.rx_ucast_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_ucast_pkts)},\n\t{\"rx_undersize_pkts\", QL_SIZEOF(nic_stats.rx_undersize_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_undersize_pkts)},\n\t{\"rx_oversize_pkts\", QL_SIZEOF(nic_stats.rx_oversize_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_oversize_pkts)},\n\t{\"rx_jabber_pkts\", QL_SIZEOF(nic_stats.rx_jabber_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_jabber_pkts)},\n\t{\"rx_undersize_fcerr_pkts\",\n\t\tQL_SIZEOF(nic_stats.rx_undersize_fcerr_pkts),\n\t\t\t\tQL_OFF(nic_stats.rx_undersize_fcerr_pkts)},\n\t{\"rx_drop_events\", QL_SIZEOF(nic_stats.rx_drop_events),\n\t\t\t\t\tQL_OFF(nic_stats.rx_drop_events)},\n\t{\"rx_fcerr_pkts\", QL_SIZEOF(nic_stats.rx_fcerr_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_fcerr_pkts)},\n\t{\"rx_align_err\", QL_SIZEOF(nic_stats.rx_align_err),\n\t\t\t\t\tQL_OFF(nic_stats.rx_align_err)},\n\t{\"rx_symbol_err\", QL_SIZEOF(nic_stats.rx_symbol_err),\n\t\t\t\t\tQL_OFF(nic_stats.rx_symbol_err)},\n\t{\"rx_mac_err\", QL_SIZEOF(nic_stats.rx_mac_err),\n\t\t\t\t\tQL_OFF(nic_stats.rx_mac_err)},\n\t{\"rx_ctl_pkts\",\tQL_SIZEOF(nic_stats.rx_ctl_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_ctl_pkts)},\n\t{\"rx_pause_pkts\", QL_SIZEOF(nic_stats.rx_pause_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_pause_pkts)},\n\t{\"rx_64_pkts\", QL_SIZEOF(nic_stats.rx_64_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_64_pkts)},\n\t{\"rx_65_to_127_pkts\", QL_SIZEOF(nic_stats.rx_65_to_127_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_65_to_127_pkts)},\n\t{\"rx_128_255_pkts\", QL_SIZEOF(nic_stats.rx_128_255_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_128_255_pkts)},\n\t{\"rx_256_511_pkts\", QL_SIZEOF(nic_stats.rx_256_511_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_256_511_pkts)},\n\t{\"rx_512_to_1023_pkts\",\tQL_SIZEOF(nic_stats.rx_512_to_1023_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_512_to_1023_pkts)},\n\t{\"rx_1024_to_1518_pkts\", QL_SIZEOF(nic_stats.rx_1024_to_1518_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_1024_to_1518_pkts)},\n\t{\"rx_1519_to_max_pkts\",\tQL_SIZEOF(nic_stats.rx_1519_to_max_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_1519_to_max_pkts)},\n\t{\"rx_len_err_pkts\", QL_SIZEOF(nic_stats.rx_len_err_pkts),\n\t\t\t\t\tQL_OFF(nic_stats.rx_len_err_pkts)},\n\t{\"rx_code_err\",\tQL_SIZEOF(nic_stats.rx_code_err),\n\t\t\t\t\tQL_OFF(nic_stats.rx_code_err)},\n\t{\"rx_oversize_err\", QL_SIZEOF(nic_stats.rx_oversize_err),\n\t\t\t\t\tQL_OFF(nic_stats.rx_oversize_err)},\n\t{\"rx_undersize_err\", QL_SIZEOF(nic_stats.rx_undersize_err),\n\t\t\t\t\tQL_OFF(nic_stats.rx_undersize_err)},\n\t{\"rx_preamble_err\", QL_SIZEOF(nic_stats.rx_preamble_err),\n\t\t\t\t\tQL_OFF(nic_stats.rx_preamble_err)},\n\t{\"rx_frame_len_err\", QL_SIZEOF(nic_stats.rx_frame_len_err),\n\t\t\t\t\tQL_OFF(nic_stats.rx_frame_len_err)},\n\t{\"rx_crc_err\", QL_SIZEOF(nic_stats.rx_crc_err),\n\t\t\t\t\tQL_OFF(nic_stats.rx_crc_err)},\n\t{\"rx_err_count\", QL_SIZEOF(nic_stats.rx_err_count),\n\t\t\t\t\tQL_OFF(nic_stats.rx_err_count)},\n\t{\"tx_cbfc_pause_frames0\", QL_SIZEOF(nic_stats.tx_cbfc_pause_frames0),\n\t\t\t\tQL_OFF(nic_stats.tx_cbfc_pause_frames0)},\n\t{\"tx_cbfc_pause_frames1\", QL_SIZEOF(nic_stats.tx_cbfc_pause_frames1),\n\t\t\t\tQL_OFF(nic_stats.tx_cbfc_pause_frames1)},\n\t{\"tx_cbfc_pause_frames2\", QL_SIZEOF(nic_stats.tx_cbfc_pause_frames2),\n\t\t\t\tQL_OFF(nic_stats.tx_cbfc_pause_frames2)},\n\t{\"tx_cbfc_pause_frames3\", QL_SIZEOF(nic_stats.tx_cbfc_pause_frames3),\n\t\t\t\tQL_OFF(nic_stats.tx_cbfc_pause_frames3)},\n\t{\"tx_cbfc_pause_frames4\", QL_SIZEOF(nic_stats.tx_cbfc_pause_frames4),\n\t\t\t\tQL_OFF(nic_stats.tx_cbfc_pause_frames4)},\n\t{\"tx_cbfc_pause_frames5\", QL_SIZEOF(nic_stats.tx_cbfc_pause_frames5),\n\t\t\t\tQL_OFF(nic_stats.tx_cbfc_pause_frames5)},\n\t{\"tx_cbfc_pause_frames6\", QL_SIZEOF(nic_stats.tx_cbfc_pause_frames6),\n\t\t\t\tQL_OFF(nic_stats.tx_cbfc_pause_frames6)},\n\t{\"tx_cbfc_pause_frames7\", QL_SIZEOF(nic_stats.tx_cbfc_pause_frames7),\n\t\t\t\tQL_OFF(nic_stats.tx_cbfc_pause_frames7)},\n\t{\"rx_cbfc_pause_frames0\", QL_SIZEOF(nic_stats.rx_cbfc_pause_frames0),\n\t\t\t\tQL_OFF(nic_stats.rx_cbfc_pause_frames0)},\n\t{\"rx_cbfc_pause_frames1\", QL_SIZEOF(nic_stats.rx_cbfc_pause_frames1),\n\t\t\t\tQL_OFF(nic_stats.rx_cbfc_pause_frames1)},\n\t{\"rx_cbfc_pause_frames2\", QL_SIZEOF(nic_stats.rx_cbfc_pause_frames2),\n\t\t\t\tQL_OFF(nic_stats.rx_cbfc_pause_frames2)},\n\t{\"rx_cbfc_pause_frames3\", QL_SIZEOF(nic_stats.rx_cbfc_pause_frames3),\n\t\t\t\tQL_OFF(nic_stats.rx_cbfc_pause_frames3)},\n\t{\"rx_cbfc_pause_frames4\", QL_SIZEOF(nic_stats.rx_cbfc_pause_frames4),\n\t\t\t\tQL_OFF(nic_stats.rx_cbfc_pause_frames4)},\n\t{\"rx_cbfc_pause_frames5\", QL_SIZEOF(nic_stats.rx_cbfc_pause_frames5),\n\t\t\t\tQL_OFF(nic_stats.rx_cbfc_pause_frames5)},\n\t{\"rx_cbfc_pause_frames6\", QL_SIZEOF(nic_stats.rx_cbfc_pause_frames6),\n\t\t\t\tQL_OFF(nic_stats.rx_cbfc_pause_frames6)},\n\t{\"rx_cbfc_pause_frames7\", QL_SIZEOF(nic_stats.rx_cbfc_pause_frames7),\n\t\t\t\tQL_OFF(nic_stats.rx_cbfc_pause_frames7)},\n\t{\"rx_nic_fifo_drop\", QL_SIZEOF(nic_stats.rx_nic_fifo_drop),\n\t\t\t\t\tQL_OFF(nic_stats.rx_nic_fifo_drop)},\n};\n\nstatic const char qlge_gstrings_test[][ETH_GSTRING_LEN] = {\n\t\"Loopback test  (offline)\"\n};\n\n#define QLGE_TEST_LEN (sizeof(qlge_gstrings_test) / ETH_GSTRING_LEN)\n#define QLGE_STATS_LEN ARRAY_SIZE(qlge_gstrings_stats)\n#define QLGE_RCV_MAC_ERR_STATS\t7\n\nstatic int qlge_update_ring_coalescing(struct qlge_adapter *qdev)\n{\n\tint i, status = 0;\n\tstruct rx_ring *rx_ring;\n\tstruct cqicb *cqicb;\n\n\tif (!netif_running(qdev->ndev))\n\t\treturn status;\n\n\t \n\tcqicb = (struct cqicb *)&qdev->rx_ring[qdev->rss_ring_count];\n\tif (le16_to_cpu(cqicb->irq_delay) != qdev->tx_coalesce_usecs ||\n\t    le16_to_cpu(cqicb->pkt_delay) != qdev->tx_max_coalesced_frames) {\n\t\tfor (i = qdev->rss_ring_count; i < qdev->rx_ring_count; i++) {\n\t\t\trx_ring = &qdev->rx_ring[i];\n\t\t\tcqicb = (struct cqicb *)rx_ring;\n\t\t\tcqicb->irq_delay = cpu_to_le16(qdev->tx_coalesce_usecs);\n\t\t\tcqicb->pkt_delay =\n\t\t\t\tcpu_to_le16(qdev->tx_max_coalesced_frames);\n\t\t\tcqicb->flags = FLAGS_LI;\n\t\t\tstatus = qlge_write_cfg(qdev, cqicb, sizeof(*cqicb),\n\t\t\t\t\t\tCFG_LCQ, rx_ring->cq_id);\n\t\t\tif (status) {\n\t\t\t\tnetif_err(qdev, ifup, qdev->ndev,\n\t\t\t\t\t  \"Failed to load CQICB.\\n\");\n\t\t\t\tgoto exit;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tcqicb = (struct cqicb *)&qdev->rx_ring[0];\n\tif (le16_to_cpu(cqicb->irq_delay) != qdev->rx_coalesce_usecs ||\n\t    le16_to_cpu(cqicb->pkt_delay) != qdev->rx_max_coalesced_frames) {\n\t\tfor (i = 0; i < qdev->rss_ring_count; i++, rx_ring++) {\n\t\t\trx_ring = &qdev->rx_ring[i];\n\t\t\tcqicb = (struct cqicb *)rx_ring;\n\t\t\tcqicb->irq_delay = cpu_to_le16(qdev->rx_coalesce_usecs);\n\t\t\tcqicb->pkt_delay =\n\t\t\t\tcpu_to_le16(qdev->rx_max_coalesced_frames);\n\t\t\tcqicb->flags = FLAGS_LI;\n\t\t\tstatus = qlge_write_cfg(qdev, cqicb, sizeof(*cqicb),\n\t\t\t\t\t\tCFG_LCQ, rx_ring->cq_id);\n\t\t\tif (status) {\n\t\t\t\tnetif_err(qdev, ifup, qdev->ndev,\n\t\t\t\t\t  \"Failed to load CQICB.\\n\");\n\t\t\t\tgoto exit;\n\t\t\t}\n\t\t}\n\t}\nexit:\n\treturn status;\n}\n\nstatic void qlge_update_stats(struct qlge_adapter *qdev)\n{\n\tu32 i;\n\tu64 data;\n\tu64 *iter = &qdev->nic_stats.tx_pkts;\n\n\tspin_lock(&qdev->stats_lock);\n\tif (qlge_sem_spinlock(qdev, qdev->xg_sem_mask)) {\n\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t  \"Couldn't get xgmac sem.\\n\");\n\t\tgoto quit;\n\t}\n\t \n\tfor (i = 0x200; i < 0x280; i += 8) {\n\t\tif (qlge_read_xgmac_reg64(qdev, i, &data)) {\n\t\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t\t  \"Error reading status register 0x%.04x.\\n\",\n\t\t\t\t  i);\n\t\t\tgoto end;\n\t\t} else {\n\t\t\t*iter = data;\n\t\t}\n\t\titer++;\n\t}\n\n\t \n\tfor (i = 0x300; i < 0x3d0; i += 8) {\n\t\tif (qlge_read_xgmac_reg64(qdev, i, &data)) {\n\t\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t\t  \"Error reading status register 0x%.04x.\\n\",\n\t\t\t\t  i);\n\t\t\tgoto end;\n\t\t} else {\n\t\t\t*iter = data;\n\t\t}\n\t\titer++;\n\t}\n\n\t \n\titer += QLGE_RCV_MAC_ERR_STATS;\n\n\t \n\tfor (i = 0x500; i < 0x540; i += 8) {\n\t\tif (qlge_read_xgmac_reg64(qdev, i, &data)) {\n\t\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t\t  \"Error reading status register 0x%.04x.\\n\",\n\t\t\t\t  i);\n\t\t\tgoto end;\n\t\t} else {\n\t\t\t*iter = data;\n\t\t}\n\t\titer++;\n\t}\n\n\t \n\tfor (i = 0x568; i < 0x5a8; i += 8) {\n\t\tif (qlge_read_xgmac_reg64(qdev, i, &data)) {\n\t\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t\t  \"Error reading status register 0x%.04x.\\n\",\n\t\t\t\t  i);\n\t\t\tgoto end;\n\t\t} else {\n\t\t\t*iter = data;\n\t\t}\n\t\titer++;\n\t}\n\n\t \n\tif (qlge_read_xgmac_reg64(qdev, 0x5b8, &data)) {\n\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t  \"Error reading status register 0x%.04x.\\n\", i);\n\t\tgoto end;\n\t} else {\n\t\t*iter = data;\n\t}\nend:\n\tqlge_sem_unlock(qdev, qdev->xg_sem_mask);\nquit:\n\tspin_unlock(&qdev->stats_lock);\n}\n\nstatic void qlge_get_strings(struct net_device *dev, u32 stringset, u8 *buf)\n{\n\tint index;\n\n\tswitch (stringset) {\n\tcase ETH_SS_TEST:\n\t\tmemcpy(buf, *qlge_gstrings_test, QLGE_TEST_LEN * ETH_GSTRING_LEN);\n\t\tbreak;\n\tcase ETH_SS_STATS:\n\t\tfor (index = 0; index < QLGE_STATS_LEN; index++) {\n\t\t\tmemcpy(buf + index * ETH_GSTRING_LEN,\n\t\t\t       qlge_gstrings_stats[index].stat_string,\n\t\t\t       ETH_GSTRING_LEN);\n\t\t}\n\t\tbreak;\n\t}\n}\n\nstatic int qlge_get_sset_count(struct net_device *dev, int sset)\n{\n\tswitch (sset) {\n\tcase ETH_SS_TEST:\n\t\treturn QLGE_TEST_LEN;\n\tcase ETH_SS_STATS:\n\t\treturn QLGE_STATS_LEN;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic void\nqlge_get_ethtool_stats(struct net_device *ndev,\n\t\t       struct ethtool_stats *stats, u64 *data)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\tint index, length;\n\n\tlength = QLGE_STATS_LEN;\n\tqlge_update_stats(qdev);\n\n\tfor (index = 0; index < length; index++) {\n\t\tchar *p = (char *)qdev +\n\t\t\tqlge_gstrings_stats[index].stat_offset;\n\t\t*data++ = (qlge_gstrings_stats[index].sizeof_stat ==\n\t\t\t   sizeof(u64)) ? *(u64 *)p : (*(u32 *)p);\n\t}\n}\n\nstatic int qlge_get_link_ksettings(struct net_device *ndev,\n\t\t\t\t   struct ethtool_link_ksettings *ecmd)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\tu32 supported, advertising;\n\n\tsupported = SUPPORTED_10000baseT_Full;\n\tadvertising = ADVERTISED_10000baseT_Full;\n\n\tif ((qdev->link_status & STS_LINK_TYPE_MASK) ==\n\t    STS_LINK_TYPE_10GBASET) {\n\t\tsupported |= (SUPPORTED_TP | SUPPORTED_Autoneg);\n\t\tadvertising |= (ADVERTISED_TP | ADVERTISED_Autoneg);\n\t\tecmd->base.port = PORT_TP;\n\t\tecmd->base.autoneg = AUTONEG_ENABLE;\n\t} else {\n\t\tsupported |= SUPPORTED_FIBRE;\n\t\tadvertising |= ADVERTISED_FIBRE;\n\t\tecmd->base.port = PORT_FIBRE;\n\t}\n\n\tecmd->base.speed = SPEED_10000;\n\tecmd->base.duplex = DUPLEX_FULL;\n\n\tethtool_convert_legacy_u32_to_link_mode(ecmd->link_modes.supported,\n\t\t\t\t\t\tsupported);\n\tethtool_convert_legacy_u32_to_link_mode(ecmd->link_modes.advertising,\n\t\t\t\t\t\tadvertising);\n\n\treturn 0;\n}\n\nstatic void qlge_get_drvinfo(struct net_device *ndev,\n\t\t\t     struct ethtool_drvinfo *drvinfo)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\tstrscpy(drvinfo->driver, qlge_driver_name, sizeof(drvinfo->driver));\n\tstrscpy(drvinfo->version, qlge_driver_version,\n\t\tsizeof(drvinfo->version));\n\tsnprintf(drvinfo->fw_version, sizeof(drvinfo->fw_version),\n\t\t \"v%d.%d.%d\",\n\t\t (qdev->fw_rev_id & 0x00ff0000) >> 16,\n\t\t (qdev->fw_rev_id & 0x0000ff00) >> 8,\n\t\t (qdev->fw_rev_id & 0x000000ff));\n\tstrscpy(drvinfo->bus_info, pci_name(qdev->pdev),\n\t\tsizeof(drvinfo->bus_info));\n}\n\nstatic void qlge_get_wol(struct net_device *ndev, struct ethtool_wolinfo *wol)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\tunsigned short ssys_dev = qdev->pdev->subsystem_device;\n\n\t \n\tif (ssys_dev == QLGE_MEZZ_SSYS_ID_068 ||\n\t    ssys_dev == QLGE_MEZZ_SSYS_ID_180) {\n\t\twol->supported = WAKE_MAGIC;\n\t\twol->wolopts = qdev->wol;\n\t}\n}\n\nstatic int qlge_set_wol(struct net_device *ndev, struct ethtool_wolinfo *wol)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\tunsigned short ssys_dev = qdev->pdev->subsystem_device;\n\n\t \n\tif (ssys_dev != QLGE_MEZZ_SSYS_ID_068 &&\n\t    ssys_dev != QLGE_MEZZ_SSYS_ID_180) {\n\t\tnetif_info(qdev, drv, qdev->ndev,\n\t\t\t   \"WOL is only supported for mezz card\\n\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\tif (wol->wolopts & ~WAKE_MAGIC)\n\t\treturn -EINVAL;\n\tqdev->wol = wol->wolopts;\n\n\tnetif_info(qdev, drv, qdev->ndev, \"Set wol option 0x%x\\n\", qdev->wol);\n\treturn 0;\n}\n\nstatic int qlge_set_phys_id(struct net_device *ndev,\n\t\t\t    enum ethtool_phys_id_state state)\n\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\tswitch (state) {\n\tcase ETHTOOL_ID_ACTIVE:\n\t\t \n\t\tif (qlge_mb_get_led_cfg(qdev))\n\t\t\treturn -EIO;\n\n\t\t \n\t\tqlge_mb_set_led_cfg(qdev, QL_LED_BLINK);\n\t\treturn 0;\n\n\tcase ETHTOOL_ID_INACTIVE:\n\t\t \n\t\tif (qlge_mb_set_led_cfg(qdev, qdev->led_config))\n\t\t\treturn -EIO;\n\t\treturn 0;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int qlge_start_loopback(struct qlge_adapter *qdev)\n{\n\tif (netif_carrier_ok(qdev->ndev)) {\n\t\tset_bit(QL_LB_LINK_UP, &qdev->flags);\n\t\tnetif_carrier_off(qdev->ndev);\n\t} else {\n\t\tclear_bit(QL_LB_LINK_UP, &qdev->flags);\n\t}\n\tqdev->link_config |= CFG_LOOPBACK_PCS;\n\treturn qlge_mb_set_port_cfg(qdev);\n}\n\nstatic void qlge_stop_loopback(struct qlge_adapter *qdev)\n{\n\tqdev->link_config &= ~CFG_LOOPBACK_PCS;\n\tqlge_mb_set_port_cfg(qdev);\n\tif (test_bit(QL_LB_LINK_UP, &qdev->flags)) {\n\t\tnetif_carrier_on(qdev->ndev);\n\t\tclear_bit(QL_LB_LINK_UP, &qdev->flags);\n\t}\n}\n\nstatic void qlge_create_lb_frame(struct sk_buff *skb,\n\t\t\t\t unsigned int frame_size)\n{\n\tmemset(skb->data, 0xFF, frame_size);\n\tframe_size &= ~1;\n\tmemset(&skb->data[frame_size / 2], 0xAA, frame_size / 2 - 1);\n\tskb->data[frame_size / 2 + 10] = (unsigned char)0xBE;\n\tskb->data[frame_size / 2 + 12] = (unsigned char)0xAF;\n}\n\nvoid qlge_check_lb_frame(struct qlge_adapter *qdev,\n\t\t\t struct sk_buff *skb)\n{\n\tunsigned int frame_size = skb->len;\n\n\tif ((*(skb->data + 3) == 0xFF) &&\n\t    (*(skb->data + frame_size / 2 + 10) == 0xBE) &&\n\t    (*(skb->data + frame_size / 2 + 12) == 0xAF)) {\n\t\tatomic_dec(&qdev->lb_count);\n\t\treturn;\n\t}\n}\n\nstatic int qlge_run_loopback_test(struct qlge_adapter *qdev)\n{\n\tint i;\n\tnetdev_tx_t rc;\n\tstruct sk_buff *skb;\n\tunsigned int size = SMALL_BUF_MAP_SIZE;\n\n\tfor (i = 0; i < 64; i++) {\n\t\tskb = netdev_alloc_skb(qdev->ndev, size);\n\t\tif (!skb)\n\t\t\treturn -ENOMEM;\n\n\t\tskb->queue_mapping = 0;\n\t\tskb_put(skb, size);\n\t\tqlge_create_lb_frame(skb, size);\n\t\trc = qlge_lb_send(skb, qdev->ndev);\n\t\tif (rc != NETDEV_TX_OK)\n\t\t\treturn -EPIPE;\n\t\tatomic_inc(&qdev->lb_count);\n\t}\n\t \n\tusleep_range(2000, 2100);\n\tqlge_clean_lb_rx_ring(&qdev->rx_ring[0], 128);\n\treturn atomic_read(&qdev->lb_count) ? -EIO : 0;\n}\n\nstatic int qlge_loopback_test(struct qlge_adapter *qdev, u64 *data)\n{\n\t*data = qlge_start_loopback(qdev);\n\tif (*data)\n\t\tgoto out;\n\t*data = qlge_run_loopback_test(qdev);\nout:\n\tqlge_stop_loopback(qdev);\n\treturn *data;\n}\n\nstatic void qlge_self_test(struct net_device *ndev,\n\t\t\t   struct ethtool_test *eth_test, u64 *data)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\tmemset(data, 0, sizeof(u64) * QLGE_TEST_LEN);\n\n\tif (netif_running(ndev)) {\n\t\tset_bit(QL_SELFTEST, &qdev->flags);\n\t\tif (eth_test->flags == ETH_TEST_FL_OFFLINE) {\n\t\t\t \n\t\t\tif (qlge_loopback_test(qdev, &data[0]))\n\t\t\t\teth_test->flags |= ETH_TEST_FL_FAILED;\n\n\t\t} else {\n\t\t\t \n\t\t\tdata[0] = 0;\n\t\t}\n\t\tclear_bit(QL_SELFTEST, &qdev->flags);\n\t\t \n\t\tmsleep_interruptible(4 * 1000);\n\t} else {\n\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t  \"is down, Loopback test will fail.\\n\");\n\t\teth_test->flags |= ETH_TEST_FL_FAILED;\n\t}\n}\n\nstatic int qlge_get_regs_len(struct net_device *ndev)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\tif (!test_bit(QL_FRC_COREDUMP, &qdev->flags))\n\t\treturn sizeof(struct qlge_mpi_coredump);\n\telse\n\t\treturn sizeof(struct qlge_reg_dump);\n}\n\nstatic void qlge_get_regs(struct net_device *ndev,\n\t\t\t  struct ethtool_regs *regs, void *p)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\tqlge_get_dump(qdev, p);\n\tif (!test_bit(QL_FRC_COREDUMP, &qdev->flags))\n\t\tregs->len = sizeof(struct qlge_mpi_coredump);\n\telse\n\t\tregs->len = sizeof(struct qlge_reg_dump);\n}\n\nstatic int qlge_get_coalesce(struct net_device *ndev,\n\t\t\t     struct ethtool_coalesce *c,\n\t\t\t     struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\tc->rx_coalesce_usecs = qdev->rx_coalesce_usecs;\n\tc->tx_coalesce_usecs = qdev->tx_coalesce_usecs;\n\n\t \n\tc->rx_max_coalesced_frames = qdev->rx_max_coalesced_frames;\n\tc->tx_max_coalesced_frames = qdev->tx_max_coalesced_frames;\n\n\treturn 0;\n}\n\nstatic int qlge_set_coalesce(struct net_device *ndev,\n\t\t\t     struct ethtool_coalesce *c,\n\t\t\t     struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\t \n\tif (c->rx_coalesce_usecs > qdev->rx_ring_size / 2)\n\t\treturn -EINVAL;\n\t \n\tif (c->rx_max_coalesced_frames > MAX_INTER_FRAME_WAIT)\n\t\treturn -EINVAL;\n\tif (c->tx_coalesce_usecs > qdev->tx_ring_size / 2)\n\t\treturn -EINVAL;\n\tif (c->tx_max_coalesced_frames > MAX_INTER_FRAME_WAIT)\n\t\treturn -EINVAL;\n\n\t \n\tif (qdev->rx_coalesce_usecs == c->rx_coalesce_usecs &&\n\t    qdev->tx_coalesce_usecs == c->tx_coalesce_usecs &&\n\t    qdev->rx_max_coalesced_frames == c->rx_max_coalesced_frames &&\n\t    qdev->tx_max_coalesced_frames == c->tx_max_coalesced_frames)\n\t\treturn 0;\n\n\tqdev->rx_coalesce_usecs = c->rx_coalesce_usecs;\n\tqdev->tx_coalesce_usecs = c->tx_coalesce_usecs;\n\tqdev->rx_max_coalesced_frames = c->rx_max_coalesced_frames;\n\tqdev->tx_max_coalesced_frames = c->tx_max_coalesced_frames;\n\n\treturn qlge_update_ring_coalescing(qdev);\n}\n\nstatic void qlge_get_pauseparam(struct net_device *ndev,\n\t\t\t\tstruct ethtool_pauseparam *pause)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\tqlge_mb_get_port_cfg(qdev);\n\tif (qdev->link_config & CFG_PAUSE_STD) {\n\t\tpause->rx_pause = 1;\n\t\tpause->tx_pause = 1;\n\t}\n}\n\nstatic int qlge_set_pauseparam(struct net_device *ndev,\n\t\t\t       struct ethtool_pauseparam *pause)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\tif ((pause->rx_pause) && (pause->tx_pause))\n\t\tqdev->link_config |= CFG_PAUSE_STD;\n\telse if (!pause->rx_pause && !pause->tx_pause)\n\t\tqdev->link_config &= ~CFG_PAUSE_STD;\n\telse\n\t\treturn -EINVAL;\n\n\treturn qlge_mb_set_port_cfg(qdev);\n}\n\nstatic u32 qlge_get_msglevel(struct net_device *ndev)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\treturn qdev->msg_enable;\n}\n\nstatic void qlge_set_msglevel(struct net_device *ndev, u32 value)\n{\n\tstruct qlge_adapter *qdev = netdev_to_qdev(ndev);\n\n\tqdev->msg_enable = value;\n}\n\nconst struct ethtool_ops qlge_ethtool_ops = {\n\t.supported_coalesce_params = ETHTOOL_COALESCE_USECS |\n\t\t\t\t     ETHTOOL_COALESCE_MAX_FRAMES,\n\t.get_drvinfo = qlge_get_drvinfo,\n\t.get_wol = qlge_get_wol,\n\t.set_wol = qlge_set_wol,\n\t.get_regs_len\t= qlge_get_regs_len,\n\t.get_regs = qlge_get_regs,\n\t.get_msglevel = qlge_get_msglevel,\n\t.set_msglevel = qlge_set_msglevel,\n\t.get_link = ethtool_op_get_link,\n\t.set_phys_id\t\t = qlge_set_phys_id,\n\t.self_test\t\t = qlge_self_test,\n\t.get_pauseparam\t\t = qlge_get_pauseparam,\n\t.set_pauseparam\t\t = qlge_set_pauseparam,\n\t.get_coalesce = qlge_get_coalesce,\n\t.set_coalesce = qlge_set_coalesce,\n\t.get_sset_count = qlge_get_sset_count,\n\t.get_strings = qlge_get_strings,\n\t.get_ethtool_stats = qlge_get_ethtool_stats,\n\t.get_link_ksettings = qlge_get_link_ksettings,\n};\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}