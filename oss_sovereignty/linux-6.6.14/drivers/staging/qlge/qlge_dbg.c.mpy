{
  "module_name": "qlge_dbg.c",
  "hash_id": "b257b00354963aab9f549c7d00b12571ace7ecf0ba489badab47737b4d571405",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/qlge/qlge_dbg.c",
  "human_readable_source": "\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/slab.h>\n\n#include \"qlge.h\"\n\n \nstatic u32 qlge_read_other_func_reg(struct qlge_adapter *qdev,\n\t\t\t\t    u32 reg)\n{\n\tu32 register_to_read;\n\tu32 reg_val;\n\tunsigned int status = 0;\n\n\tregister_to_read = MPI_NIC_REG_BLOCK\n\t\t\t\t| MPI_NIC_READ\n\t\t\t\t| (qdev->alt_func << MPI_NIC_FUNCTION_SHIFT)\n\t\t\t\t| reg;\n\tstatus = qlge_read_mpi_reg(qdev, register_to_read, &reg_val);\n\tif (status != 0)\n\t\treturn 0xffffffff;\n\n\treturn reg_val;\n}\n\n \nstatic int qlge_write_other_func_reg(struct qlge_adapter *qdev,\n\t\t\t\t     u32 reg, u32 reg_val)\n{\n\tu32 register_to_read;\n\n\tregister_to_read = MPI_NIC_REG_BLOCK\n\t\t\t\t| MPI_NIC_READ\n\t\t\t\t| (qdev->alt_func << MPI_NIC_FUNCTION_SHIFT)\n\t\t\t\t| reg;\n\n\treturn qlge_write_mpi_reg(qdev, register_to_read, reg_val);\n}\n\nstatic int qlge_wait_other_func_reg_rdy(struct qlge_adapter *qdev, u32 reg,\n\t\t\t\t\tu32 bit, u32 err_bit)\n{\n\tu32 temp;\n\tint count;\n\n\tfor (count = 10; count; count--) {\n\t\ttemp = qlge_read_other_func_reg(qdev, reg);\n\n\t\t \n\t\tif (temp & err_bit)\n\t\t\treturn -1;\n\t\telse if (temp & bit)\n\t\t\treturn 0;\n\t\tmdelay(10);\n\t}\n\treturn -1;\n}\n\nstatic int qlge_read_other_func_serdes_reg(struct qlge_adapter *qdev, u32 reg,\n\t\t\t\t\t   u32 *data)\n{\n\tint status;\n\n\t \n\tstatus = qlge_wait_other_func_reg_rdy(qdev, XG_SERDES_ADDR / 4,\n\t\t\t\t\t      XG_SERDES_ADDR_RDY, 0);\n\tif (status)\n\t\tgoto exit;\n\n\t \n\tqlge_write_other_func_reg(qdev, XG_SERDES_ADDR / 4, reg | PROC_ADDR_R);\n\n\t \n\tstatus = qlge_wait_other_func_reg_rdy(qdev, XG_SERDES_ADDR / 4,\n\t\t\t\t\t      XG_SERDES_ADDR_RDY, 0);\n\tif (status)\n\t\tgoto exit;\n\n\t \n\t*data = qlge_read_other_func_reg(qdev, (XG_SERDES_DATA / 4));\nexit:\n\treturn status;\n}\n\n \nstatic int qlge_read_serdes_reg(struct qlge_adapter *qdev, u32 reg, u32 *data)\n{\n\tint status;\n\n\t \n\tstatus = qlge_wait_reg_rdy(qdev, XG_SERDES_ADDR, XG_SERDES_ADDR_RDY, 0);\n\tif (status)\n\t\tgoto exit;\n\n\t \n\tqlge_write32(qdev, XG_SERDES_ADDR, reg | PROC_ADDR_R);\n\n\t \n\tstatus = qlge_wait_reg_rdy(qdev, XG_SERDES_ADDR, XG_SERDES_ADDR_RDY, 0);\n\tif (status)\n\t\tgoto exit;\n\n\t \n\t*data = qlge_read32(qdev, XG_SERDES_DATA);\nexit:\n\treturn status;\n}\n\nstatic void qlge_get_both_serdes(struct qlge_adapter *qdev, u32 addr,\n\t\t\t\t u32 *direct_ptr, u32 *indirect_ptr,\n\t\t\t\t bool direct_valid, bool indirect_valid)\n{\n\tunsigned int status;\n\n\tstatus = 1;\n\tif (direct_valid)\n\t\tstatus = qlge_read_serdes_reg(qdev, addr, direct_ptr);\n\t \n\tif (status)\n\t\t*direct_ptr = 0xDEADBEEF;\n\n\tstatus = 1;\n\tif (indirect_valid)\n\t\tstatus = qlge_read_other_func_serdes_reg(qdev, addr,\n\t\t\t\t\t\t\t indirect_ptr);\n\t \n\tif (status)\n\t\t*indirect_ptr = 0xDEADBEEF;\n}\n\nstatic int qlge_get_serdes_regs(struct qlge_adapter *qdev,\n\t\t\t\tstruct qlge_mpi_coredump *mpi_coredump)\n{\n\tint status;\n\tbool xfi_direct_valid = false, xfi_indirect_valid = false;\n\tbool xaui_direct_valid = true, xaui_indirect_valid = true;\n\tunsigned int i;\n\tu32 *direct_ptr, temp;\n\tu32 *indirect_ptr;\n\n\t \n\tstatus = qlge_read_other_func_serdes_reg(qdev,\n\t\t\t\t\t\t XG_SERDES_XAUI_HSS_PCS_START,\n\t\t\t\t\t\t &temp);\n\tif (status)\n\t\ttemp = XG_SERDES_ADDR_XAUI_PWR_DOWN;\n\n\tif ((temp & XG_SERDES_ADDR_XAUI_PWR_DOWN) ==\n\t\t\t\tXG_SERDES_ADDR_XAUI_PWR_DOWN)\n\t\txaui_indirect_valid = false;\n\n\tstatus = qlge_read_serdes_reg(qdev, XG_SERDES_XAUI_HSS_PCS_START, &temp);\n\n\tif (status)\n\t\ttemp = XG_SERDES_ADDR_XAUI_PWR_DOWN;\n\n\tif ((temp & XG_SERDES_ADDR_XAUI_PWR_DOWN) ==\n\t\t\t\tXG_SERDES_ADDR_XAUI_PWR_DOWN)\n\t\txaui_direct_valid = false;\n\n\t \n\tstatus = qlge_read_serdes_reg(qdev, XG_SERDES_ADDR_STS, &temp);\n\tif (status)\n\t\ttemp = 0;\n\n\tif ((temp & XG_SERDES_ADDR_XFI1_PWR_UP) ==\n\t\t\t\t\tXG_SERDES_ADDR_XFI1_PWR_UP) {\n\t\t \n\t\tif (qdev->func & 1)\n\t\t\t \n\t\t\txfi_indirect_valid = true;\n\t\telse\n\t\t\txfi_direct_valid = true;\n\t}\n\tif ((temp & XG_SERDES_ADDR_XFI2_PWR_UP) ==\n\t\t\t\t\tXG_SERDES_ADDR_XFI2_PWR_UP) {\n\t\t \n\t\tif (qdev->func & 1)\n\t\t\t \n\t\t\txfi_direct_valid = true;\n\t\telse\n\t\t\txfi_indirect_valid = true;\n\t}\n\n\t \n\tif (qdev->func & 1) {\n\t\t \n\t\tdirect_ptr = mpi_coredump->serdes2_xaui_an;\n\t\tindirect_ptr = mpi_coredump->serdes_xaui_an;\n\t} else {\n\t\t \n\t\tdirect_ptr = mpi_coredump->serdes_xaui_an;\n\t\tindirect_ptr = mpi_coredump->serdes2_xaui_an;\n\t}\n\n\tfor (i = 0; i <= 0x000000034; i += 4, direct_ptr++, indirect_ptr++)\n\t\tqlge_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\n\t\t\t\t     xaui_direct_valid, xaui_indirect_valid);\n\n\t \n\tif (qdev->func & 1) {\n\t\tdirect_ptr =\n\t\t\tmpi_coredump->serdes2_xaui_hss_pcs;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes_xaui_hss_pcs;\n\t} else {\n\t\tdirect_ptr =\n\t\t\tmpi_coredump->serdes_xaui_hss_pcs;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes2_xaui_hss_pcs;\n\t}\n\n\tfor (i = 0x800; i <= 0x880; i += 4, direct_ptr++, indirect_ptr++)\n\t\tqlge_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\n\t\t\t\t     xaui_direct_valid, xaui_indirect_valid);\n\n\t \n\tif (qdev->func & 1) {\n\t\tdirect_ptr = mpi_coredump->serdes2_xfi_an;\n\t\tindirect_ptr = mpi_coredump->serdes_xfi_an;\n\t} else {\n\t\tdirect_ptr = mpi_coredump->serdes_xfi_an;\n\t\tindirect_ptr = mpi_coredump->serdes2_xfi_an;\n\t}\n\n\tfor (i = 0x1000; i <= 0x1034; i += 4, direct_ptr++, indirect_ptr++)\n\t\tqlge_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\n\t\t\t\t     xfi_direct_valid, xfi_indirect_valid);\n\n\t \n\tif (qdev->func & 1) {\n\t\tdirect_ptr = mpi_coredump->serdes2_xfi_train;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes_xfi_train;\n\t} else {\n\t\tdirect_ptr = mpi_coredump->serdes_xfi_train;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes2_xfi_train;\n\t}\n\n\tfor (i = 0x1050; i <= 0x107c; i += 4, direct_ptr++, indirect_ptr++)\n\t\tqlge_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\n\t\t\t\t     xfi_direct_valid, xfi_indirect_valid);\n\n\t \n\tif (qdev->func & 1) {\n\t\tdirect_ptr =\n\t\t\tmpi_coredump->serdes2_xfi_hss_pcs;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes_xfi_hss_pcs;\n\t} else {\n\t\tdirect_ptr =\n\t\t\tmpi_coredump->serdes_xfi_hss_pcs;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes2_xfi_hss_pcs;\n\t}\n\n\tfor (i = 0x1800; i <= 0x1838; i += 4, direct_ptr++, indirect_ptr++)\n\t\tqlge_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\n\t\t\t\t     xfi_direct_valid, xfi_indirect_valid);\n\n\t \n\tif (qdev->func & 1) {\n\t\tdirect_ptr =\n\t\t\tmpi_coredump->serdes2_xfi_hss_tx;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes_xfi_hss_tx;\n\t} else {\n\t\tdirect_ptr = mpi_coredump->serdes_xfi_hss_tx;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes2_xfi_hss_tx;\n\t}\n\tfor (i = 0x1c00; i <= 0x1c1f; i++, direct_ptr++, indirect_ptr++)\n\t\tqlge_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\n\t\t\t\t     xfi_direct_valid, xfi_indirect_valid);\n\n\t \n\tif (qdev->func & 1) {\n\t\tdirect_ptr =\n\t\t\tmpi_coredump->serdes2_xfi_hss_rx;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes_xfi_hss_rx;\n\t} else {\n\t\tdirect_ptr = mpi_coredump->serdes_xfi_hss_rx;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes2_xfi_hss_rx;\n\t}\n\n\tfor (i = 0x1c40; i <= 0x1c5f; i++, direct_ptr++, indirect_ptr++)\n\t\tqlge_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\n\t\t\t\t     xfi_direct_valid, xfi_indirect_valid);\n\n\t \n\tif (qdev->func & 1) {\n\t\tdirect_ptr =\n\t\t\tmpi_coredump->serdes2_xfi_hss_pll;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes_xfi_hss_pll;\n\t} else {\n\t\tdirect_ptr =\n\t\t\tmpi_coredump->serdes_xfi_hss_pll;\n\t\tindirect_ptr =\n\t\t\tmpi_coredump->serdes2_xfi_hss_pll;\n\t}\n\tfor (i = 0x1e00; i <= 0x1e1f; i++, direct_ptr++, indirect_ptr++)\n\t\tqlge_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\n\t\t\t\t     xfi_direct_valid, xfi_indirect_valid);\n\treturn 0;\n}\n\nstatic int qlge_read_other_func_xgmac_reg(struct qlge_adapter *qdev, u32 reg,\n\t\t\t\t\t  u32 *data)\n{\n\tint status = 0;\n\n\t \n\tstatus = qlge_wait_other_func_reg_rdy(qdev, XGMAC_ADDR / 4,\n\t\t\t\t\t      XGMAC_ADDR_RDY, XGMAC_ADDR_XME);\n\tif (status)\n\t\tgoto exit;\n\n\t \n\tqlge_write_other_func_reg(qdev, XGMAC_ADDR / 4, reg | XGMAC_ADDR_R);\n\n\t \n\tstatus = qlge_wait_other_func_reg_rdy(qdev, XGMAC_ADDR / 4,\n\t\t\t\t\t      XGMAC_ADDR_RDY, XGMAC_ADDR_XME);\n\tif (status)\n\t\tgoto exit;\n\n\t \n\t*data = qlge_read_other_func_reg(qdev, XGMAC_DATA / 4);\nexit:\n\treturn status;\n}\n\n \nstatic int qlge_get_xgmac_regs(struct qlge_adapter *qdev, u32 *buf,\n\t\t\t       unsigned int other_function)\n{\n\tint status = 0;\n\tint i;\n\n\tfor (i = PAUSE_SRC_LO; i < XGMAC_REGISTER_END; i += 4, buf++) {\n\t\t \n\t\tif ((i == 0x00000114) || (i == 0x00000118) ||\n\t\t    (i == 0x0000013c) || (i == 0x00000140) ||\n\t\t    (i > 0x00000150 && i < 0x000001fc) ||\n\t\t    (i > 0x00000278 && i < 0x000002a0) ||\n\t\t    (i > 0x000002c0 && i < 0x000002cf) ||\n\t\t    (i > 0x000002dc && i < 0x000002f0) ||\n\t\t    (i > 0x000003c8 && i < 0x00000400) ||\n\t\t    (i > 0x00000400 && i < 0x00000410) ||\n\t\t    (i > 0x00000410 && i < 0x00000420) ||\n\t\t    (i > 0x00000420 && i < 0x00000430) ||\n\t\t    (i > 0x00000430 && i < 0x00000440) ||\n\t\t    (i > 0x00000440 && i < 0x00000450) ||\n\t\t    (i > 0x00000450 && i < 0x00000500) ||\n\t\t    (i > 0x0000054c && i < 0x00000568) ||\n\t\t    (i > 0x000005c8 && i < 0x00000600)) {\n\t\t\tif (other_function)\n\t\t\t\tstatus = qlge_read_other_func_xgmac_reg(qdev, i, buf);\n\t\t\telse\n\t\t\t\tstatus = qlge_read_xgmac_reg(qdev, i, buf);\n\n\t\t\tif (status)\n\t\t\t\t*buf = 0xdeadbeef;\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn status;\n}\n\nstatic int qlge_get_ets_regs(struct qlge_adapter *qdev, u32 *buf)\n{\n\tint i;\n\n\tfor (i = 0; i < 8; i++, buf++) {\n\t\tqlge_write32(qdev, NIC_ETS, i << 29 | 0x08000000);\n\t\t*buf = qlge_read32(qdev, NIC_ETS);\n\t}\n\n\tfor (i = 0; i < 2; i++, buf++) {\n\t\tqlge_write32(qdev, CNA_ETS, i << 29 | 0x08000000);\n\t\t*buf = qlge_read32(qdev, CNA_ETS);\n\t}\n\n\treturn 0;\n}\n\nstatic void qlge_get_intr_states(struct qlge_adapter *qdev, u32 *buf)\n{\n\tint i;\n\n\tfor (i = 0; i < qdev->rx_ring_count; i++, buf++) {\n\t\tqlge_write32(qdev, INTR_EN,\n\t\t\t     qdev->intr_context[i].intr_read_mask);\n\t\t*buf = qlge_read32(qdev, INTR_EN);\n\t}\n}\n\nstatic int qlge_get_cam_entries(struct qlge_adapter *qdev, u32 *buf)\n{\n\tint i, status;\n\tu32 value[3];\n\n\tstatus = qlge_sem_spinlock(qdev, SEM_MAC_ADDR_MASK);\n\tif (status)\n\t\treturn status;\n\n\tfor (i = 0; i < 16; i++) {\n\t\tstatus = qlge_get_mac_addr_reg(qdev,\n\t\t\t\t\t       MAC_ADDR_TYPE_CAM_MAC, i, value);\n\t\tif (status) {\n\t\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t\t  \"Failed read of mac index register\\n\");\n\t\t\tgoto err;\n\t\t}\n\t\t*buf++ = value[0];\t \n\t\t*buf++ = value[1];\t \n\t\t*buf++ = value[2];\t \n\t}\n\tfor (i = 0; i < 32; i++) {\n\t\tstatus = qlge_get_mac_addr_reg(qdev, MAC_ADDR_TYPE_MULTI_MAC,\n\t\t\t\t\t       i, value);\n\t\tif (status) {\n\t\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t\t  \"Failed read of mac index register\\n\");\n\t\t\tgoto err;\n\t\t}\n\t\t*buf++ = value[0];\t \n\t\t*buf++ = value[1];\t \n\t}\nerr:\n\tqlge_sem_unlock(qdev, SEM_MAC_ADDR_MASK);\n\treturn status;\n}\n\nstatic int qlge_get_routing_entries(struct qlge_adapter *qdev, u32 *buf)\n{\n\tint status;\n\tu32 value, i;\n\n\tstatus = qlge_sem_spinlock(qdev, SEM_RT_IDX_MASK);\n\tif (status)\n\t\treturn status;\n\n\tfor (i = 0; i < 16; i++) {\n\t\tstatus = qlge_get_routing_reg(qdev, i, &value);\n\t\tif (status) {\n\t\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t\t  \"Failed read of routing index register\\n\");\n\t\t\tgoto err;\n\t\t} else {\n\t\t\t*buf++ = value;\n\t\t}\n\t}\nerr:\n\tqlge_sem_unlock(qdev, SEM_RT_IDX_MASK);\n\treturn status;\n}\n\n \nstatic int qlge_get_mpi_shadow_regs(struct qlge_adapter *qdev, u32 *buf)\n{\n\tu32 i;\n\tint status;\n\n\tfor (i = 0; i < MPI_CORE_SH_REGS_CNT; i++, buf++) {\n\t\tstatus = qlge_write_mpi_reg(qdev,\n\t\t\t\t\t    RISC_124,\n\t\t\t\t\t    (SHADOW_OFFSET | i << SHADOW_REG_SHIFT));\n\t\tif (status)\n\t\t\tgoto end;\n\t\tstatus = qlge_read_mpi_reg(qdev, RISC_127, buf);\n\t\tif (status)\n\t\t\tgoto end;\n\t}\nend:\n\treturn status;\n}\n\n \nstatic int qlge_get_mpi_regs(struct qlge_adapter *qdev, u32 *buf,\n\t\t\t     u32 offset, u32 count)\n{\n\tint i, status = 0;\n\n\tfor (i = 0; i < count; i++, buf++) {\n\t\tstatus = qlge_read_mpi_reg(qdev, offset + i, buf);\n\t\tif (status)\n\t\t\treturn status;\n\t}\n\treturn status;\n}\n\n \nstatic unsigned int *qlge_get_probe(struct qlge_adapter *qdev, u32 clock,\n\t\t\t\t    u32 valid, u32 *buf)\n{\n\tu32 module, mux_sel, probe, lo_val, hi_val;\n\n\tfor (module = 0; module < PRB_MX_ADDR_MAX_MODS; module++) {\n\t\tif (!((valid >> module) & 1))\n\t\t\tcontinue;\n\t\tfor (mux_sel = 0; mux_sel < PRB_MX_ADDR_MAX_MUX; mux_sel++) {\n\t\t\tprobe = clock\n\t\t\t\t| PRB_MX_ADDR_ARE\n\t\t\t\t| mux_sel\n\t\t\t\t| (module << PRB_MX_ADDR_MOD_SEL_SHIFT);\n\t\t\tqlge_write32(qdev, PRB_MX_ADDR, probe);\n\t\t\tlo_val = qlge_read32(qdev, PRB_MX_DATA);\n\t\t\tif (mux_sel == 0) {\n\t\t\t\t*buf = probe;\n\t\t\t\tbuf++;\n\t\t\t}\n\t\t\tprobe |= PRB_MX_ADDR_UP;\n\t\t\tqlge_write32(qdev, PRB_MX_ADDR, probe);\n\t\t\thi_val = qlge_read32(qdev, PRB_MX_DATA);\n\t\t\t*buf = lo_val;\n\t\t\tbuf++;\n\t\t\t*buf = hi_val;\n\t\t\tbuf++;\n\t\t}\n\t}\n\treturn buf;\n}\n\nstatic int qlge_get_probe_dump(struct qlge_adapter *qdev, unsigned int *buf)\n{\n\t \n\tqlge_write_mpi_reg(qdev, MPI_TEST_FUNC_PRB_CTL, MPI_TEST_FUNC_PRB_EN);\n\tbuf = qlge_get_probe(qdev, PRB_MX_ADDR_SYS_CLOCK,\n\t\t\t     PRB_MX_ADDR_VALID_SYS_MOD, buf);\n\tbuf = qlge_get_probe(qdev, PRB_MX_ADDR_PCI_CLOCK,\n\t\t\t     PRB_MX_ADDR_VALID_PCI_MOD, buf);\n\tbuf = qlge_get_probe(qdev, PRB_MX_ADDR_XGM_CLOCK,\n\t\t\t     PRB_MX_ADDR_VALID_XGM_MOD, buf);\n\tbuf = qlge_get_probe(qdev, PRB_MX_ADDR_FC_CLOCK,\n\t\t\t     PRB_MX_ADDR_VALID_FC_MOD, buf);\n\treturn 0;\n}\n\n \nstatic int qlge_get_routing_index_registers(struct qlge_adapter *qdev, u32 *buf)\n{\n\tint status;\n\tu32 type, index, index_max;\n\tu32 result_index;\n\tu32 result_data;\n\tu32 val;\n\n\tstatus = qlge_sem_spinlock(qdev, SEM_RT_IDX_MASK);\n\tif (status)\n\t\treturn status;\n\n\tfor (type = 0; type < 4; type++) {\n\t\tif (type < 2)\n\t\t\tindex_max = 8;\n\t\telse\n\t\t\tindex_max = 16;\n\t\tfor (index = 0; index < index_max; index++) {\n\t\t\tval = RT_IDX_RS\n\t\t\t\t| (type << RT_IDX_TYPE_SHIFT)\n\t\t\t\t| (index << RT_IDX_IDX_SHIFT);\n\t\t\tqlge_write32(qdev, RT_IDX, val);\n\t\t\tresult_index = 0;\n\t\t\twhile ((result_index & RT_IDX_MR) == 0)\n\t\t\t\tresult_index = qlge_read32(qdev, RT_IDX);\n\t\t\tresult_data = qlge_read32(qdev, RT_DATA);\n\t\t\t*buf = type;\n\t\t\tbuf++;\n\t\t\t*buf = index;\n\t\t\tbuf++;\n\t\t\t*buf = result_index;\n\t\t\tbuf++;\n\t\t\t*buf = result_data;\n\t\t\tbuf++;\n\t\t}\n\t}\n\tqlge_sem_unlock(qdev, SEM_RT_IDX_MASK);\n\treturn status;\n}\n\n \nstatic void qlge_get_mac_protocol_registers(struct qlge_adapter *qdev, u32 *buf)\n{\n\tu32 result_index, result_data;\n\tu32 type;\n\tu32 index;\n\tu32 offset;\n\tu32 val;\n\tu32 initial_val = MAC_ADDR_RS;\n\tu32 max_index;\n\tu32 max_offset;\n\n\tfor (type = 0; type < MAC_ADDR_TYPE_COUNT; type++) {\n\t\tswitch (type) {\n\t\tcase 0:  \n\t\t\tinitial_val |= MAC_ADDR_ADR;\n\t\t\tmax_index = MAC_ADDR_MAX_CAM_ENTRIES;\n\t\t\tmax_offset = MAC_ADDR_MAX_CAM_WCOUNT;\n\t\t\tbreak;\n\t\tcase 1:  \n\t\t\tmax_index = MAC_ADDR_MAX_CAM_WCOUNT;\n\t\t\tmax_offset = MAC_ADDR_MAX_CAM_WCOUNT;\n\t\t\tbreak;\n\t\tcase 2:  \n\t\tcase 3:  \n\t\t\tmax_index = MAC_ADDR_MAX_CAM_WCOUNT;\n\t\t\tmax_offset = MAC_ADDR_MAX_CAM_WCOUNT;\n\t\t\tbreak;\n\t\tcase 4:  \n\t\t\tmax_index = MAC_ADDR_MAX_FC_MAC_ENTRIES;\n\t\t\tmax_offset = MAC_ADDR_MAX_FC_MAC_WCOUNT;\n\t\t\tbreak;\n\t\tcase 5:  \n\t\t\tmax_index = MAC_ADDR_MAX_MGMT_MAC_ENTRIES;\n\t\t\tmax_offset = MAC_ADDR_MAX_MGMT_MAC_WCOUNT;\n\t\t\tbreak;\n\t\tcase 6:  \n\t\t\tmax_index = MAC_ADDR_MAX_MGMT_VLAN_ENTRIES;\n\t\t\tmax_offset = MAC_ADDR_MAX_MGMT_VLAN_WCOUNT;\n\t\t\tbreak;\n\t\tcase 7:  \n\t\t\tmax_index = MAC_ADDR_MAX_MGMT_V4_ENTRIES;\n\t\t\tmax_offset = MAC_ADDR_MAX_MGMT_V4_WCOUNT;\n\t\t\tbreak;\n\t\tcase 8:  \n\t\t\tmax_index = MAC_ADDR_MAX_MGMT_V6_ENTRIES;\n\t\t\tmax_offset = MAC_ADDR_MAX_MGMT_V6_WCOUNT;\n\t\t\tbreak;\n\t\tcase 9:  \n\t\t\tmax_index = MAC_ADDR_MAX_MGMT_TU_DP_ENTRIES;\n\t\t\tmax_offset = MAC_ADDR_MAX_MGMT_TU_DP_WCOUNT;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tnetdev_err(qdev->ndev, \"Bad type!!! 0x%08x\\n\", type);\n\t\t\tmax_index = 0;\n\t\t\tmax_offset = 0;\n\t\t\tbreak;\n\t\t}\n\t\tfor (index = 0; index < max_index; index++) {\n\t\t\tfor (offset = 0; offset < max_offset; offset++) {\n\t\t\t\tval = initial_val\n\t\t\t\t\t| (type << MAC_ADDR_TYPE_SHIFT)\n\t\t\t\t\t| (index << MAC_ADDR_IDX_SHIFT)\n\t\t\t\t\t| (offset);\n\t\t\t\tqlge_write32(qdev, MAC_ADDR_IDX, val);\n\t\t\t\tresult_index = 0;\n\t\t\t\twhile ((result_index & MAC_ADDR_MR) == 0) {\n\t\t\t\t\tresult_index = qlge_read32(qdev,\n\t\t\t\t\t\t\t\t   MAC_ADDR_IDX);\n\t\t\t\t}\n\t\t\t\tresult_data = qlge_read32(qdev, MAC_ADDR_DATA);\n\t\t\t\t*buf = result_index;\n\t\t\t\tbuf++;\n\t\t\t\t*buf = result_data;\n\t\t\t\tbuf++;\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void qlge_get_sem_registers(struct qlge_adapter *qdev, u32 *buf)\n{\n\tu32 func_num, reg, reg_val;\n\tint status;\n\n\tfor (func_num = 0; func_num < MAX_SEMAPHORE_FUNCTIONS ; func_num++) {\n\t\treg = MPI_NIC_REG_BLOCK\n\t\t\t| (func_num << MPI_NIC_FUNCTION_SHIFT)\n\t\t\t| (SEM / 4);\n\t\tstatus = qlge_read_mpi_reg(qdev, reg, &reg_val);\n\t\t*buf = reg_val;\n\t\t \n\t\tif (!status)\n\t\t\t*buf = 0xdeadbeef;\n\t\tbuf++;\n\t}\n}\n\n \nstatic void qlge_build_coredump_seg_header(struct mpi_coredump_segment_header *seg_hdr,\n\t\t\t\t\t   u32 seg_number, u32 seg_size, u8 *desc)\n{\n\tmemset(seg_hdr, 0, sizeof(struct mpi_coredump_segment_header));\n\tseg_hdr->cookie = MPI_COREDUMP_COOKIE;\n\tseg_hdr->seg_num = seg_number;\n\tseg_hdr->seg_size = seg_size;\n\tstrncpy(seg_hdr->description, desc, (sizeof(seg_hdr->description)) - 1);\n}\n\n \nint qlge_core_dump(struct qlge_adapter *qdev, struct qlge_mpi_coredump *mpi_coredump)\n{\n\tint status;\n\tint i;\n\n\tif (!mpi_coredump) {\n\t\tnetif_err(qdev, drv, qdev->ndev, \"No memory allocated\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tqlge_sem_spinlock(qdev, SEM_PROC_REG_MASK);\n\n\tstatus = qlge_pause_mpi_risc(qdev);\n\tif (status) {\n\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t  \"Failed RISC pause. Status = 0x%.08x\\n\", status);\n\t\tgoto err;\n\t}\n\n\t \n\tmemset(&mpi_coredump->mpi_global_header, 0,\n\t       sizeof(struct mpi_coredump_global_header));\n\tmpi_coredump->mpi_global_header.cookie = MPI_COREDUMP_COOKIE;\n\tmpi_coredump->mpi_global_header.header_size =\n\t\tsizeof(struct mpi_coredump_global_header);\n\tmpi_coredump->mpi_global_header.image_size =\n\t\tsizeof(struct qlge_mpi_coredump);\n\tstrncpy(mpi_coredump->mpi_global_header.id_string, \"MPI Coredump\",\n\t\tsizeof(mpi_coredump->mpi_global_header.id_string));\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->nic_regs_seg_hdr,\n\t\t\t\t       NIC1_CONTROL_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->nic_regs), \"NIC1 Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->nic2_regs_seg_hdr,\n\t\t\t\t       NIC2_CONTROL_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->nic2_regs), \"NIC2 Registers\");\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->xgmac1_seg_hdr,\n\t\t\t\t       NIC1_XGMAC_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->xgmac1), \"NIC1 XGMac Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xgmac2_seg_hdr,\n\t\t\t\t       NIC2_XGMAC_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->xgmac2), \"NIC2 XGMac Registers\");\n\n\tif (qdev->func & 1) {\n\t\t \n\t\tfor (i = 0; i < NIC_REGS_DUMP_WORD_COUNT; i++)\n\t\t\tmpi_coredump->nic2_regs[i] =\n\t\t\t\tqlge_read32(qdev, i * sizeof(u32));\n\n\t\tfor (i = 0; i < NIC_REGS_DUMP_WORD_COUNT; i++)\n\t\t\tmpi_coredump->nic_regs[i] =\n\t\t\t\tqlge_read_other_func_reg(qdev, (i * sizeof(u32)) / 4);\n\n\t\tqlge_get_xgmac_regs(qdev, &mpi_coredump->xgmac2[0], 0);\n\t\tqlge_get_xgmac_regs(qdev, &mpi_coredump->xgmac1[0], 1);\n\t} else {\n\t\t \n\t\tfor (i = 0; i < NIC_REGS_DUMP_WORD_COUNT; i++)\n\t\t\tmpi_coredump->nic_regs[i] =\n\t\t\t\tqlge_read32(qdev, i * sizeof(u32));\n\t\tfor (i = 0; i < NIC_REGS_DUMP_WORD_COUNT; i++)\n\t\t\tmpi_coredump->nic2_regs[i] =\n\t\t\t\tqlge_read_other_func_reg(qdev, (i * sizeof(u32)) / 4);\n\n\t\tqlge_get_xgmac_regs(qdev, &mpi_coredump->xgmac1[0], 0);\n\t\tqlge_get_xgmac_regs(qdev, &mpi_coredump->xgmac2[0], 1);\n\t}\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->xaui_an_hdr,\n\t\t\t\t       XAUI_AN_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes_xaui_an),\n\t\t\t\t       \"XAUI AN Registers\");\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->xaui_hss_pcs_hdr,\n\t\t\t\t       XAUI_HSS_PCS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes_xaui_hss_pcs),\n\t\t\t\t       \"XAUI HSS PCS Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi_an_hdr, XFI_AN_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes_xfi_an),\n\t\t\t\t       \"XFI AN Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi_train_hdr,\n\t\t\t\t       XFI_TRAIN_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes_xfi_train),\n\t\t\t\t       \"XFI TRAIN Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi_hss_pcs_hdr,\n\t\t\t\t       XFI_HSS_PCS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes_xfi_hss_pcs),\n\t\t\t\t       \"XFI HSS PCS Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi_hss_tx_hdr,\n\t\t\t\t       XFI_HSS_TX_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes_xfi_hss_tx),\n\t\t\t\t       \"XFI HSS TX Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi_hss_rx_hdr,\n\t\t\t\t       XFI_HSS_RX_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes_xfi_hss_rx),\n\t\t\t\t       \"XFI HSS RX Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi_hss_pll_hdr,\n\t\t\t\t       XFI_HSS_PLL_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes_xfi_hss_pll),\n\t\t\t\t       \"XFI HSS PLL Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xaui2_an_hdr,\n\t\t\t\t       XAUI2_AN_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes2_xaui_an),\n\t\t\t\t       \"XAUI2 AN Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xaui2_hss_pcs_hdr,\n\t\t\t\t       XAUI2_HSS_PCS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes2_xaui_hss_pcs),\n\t\t\t\t       \"XAUI2 HSS PCS Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi2_an_hdr,\n\t\t\t\t       XFI2_AN_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes2_xfi_an),\n\t\t\t\t       \"XFI2 AN Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi2_train_hdr,\n\t\t\t\t       XFI2_TRAIN_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes2_xfi_train),\n\t\t\t\t       \"XFI2 TRAIN Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi2_hss_pcs_hdr,\n\t\t\t\t       XFI2_HSS_PCS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes2_xfi_hss_pcs),\n\t\t\t\t       \"XFI2 HSS PCS Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi2_hss_tx_hdr,\n\t\t\t\t       XFI2_HSS_TX_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes2_xfi_hss_tx),\n\t\t\t\t       \"XFI2 HSS TX Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi2_hss_rx_hdr,\n\t\t\t\t       XFI2_HSS_RX_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes2_xfi_hss_rx),\n\t\t\t\t       \"XFI2 HSS RX Registers\");\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->xfi2_hss_pll_hdr,\n\t\t\t\t       XFI2_HSS_PLL_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->serdes2_xfi_hss_pll),\n\t\t\t\t       \"XFI2 HSS PLL Registers\");\n\n\tstatus = qlge_get_serdes_regs(qdev, mpi_coredump);\n\tif (status) {\n\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t  \"Failed Dump of Serdes Registers. Status = 0x%.08x\\n\",\n\t\t\t  status);\n\t\tgoto err;\n\t}\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->core_regs_seg_hdr,\n\t\t\t\t       CORE_SEG_NUM,\n\t\t\t\t       sizeof(mpi_coredump->core_regs_seg_hdr) +\n\t\t\t\t       sizeof(mpi_coredump->mpi_core_regs) +\n\t\t\t\t       sizeof(mpi_coredump->mpi_core_sh_regs),\n\t\t\t\t       \"Core Registers\");\n\n\t \n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->mpi_core_regs[0],\n\t\t\t\t   MPI_CORE_REGS_ADDR, MPI_CORE_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\t \n\tstatus = qlge_get_mpi_shadow_regs(qdev,\n\t\t\t\t\t  &mpi_coredump->mpi_core_sh_regs[0]);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->test_logic_regs_seg_hdr,\n\t\t\t\t       TEST_LOGIC_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->test_logic_regs),\n\t\t\t\t       \"Test Logic Regs\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->test_logic_regs[0],\n\t\t\t\t   TEST_REGS_ADDR, TEST_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->rmii_regs_seg_hdr,\n\t\t\t\t       RMII_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->rmii_regs),\n\t\t\t\t       \"RMII Registers\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->rmii_regs[0],\n\t\t\t\t   RMII_REGS_ADDR, RMII_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->fcmac1_regs_seg_hdr,\n\t\t\t\t       FCMAC1_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->fcmac1_regs),\n\t\t\t\t       \"FCMAC1 Registers\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->fcmac1_regs[0],\n\t\t\t\t   FCMAC1_REGS_ADDR, FCMAC_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\n\tqlge_build_coredump_seg_header(&mpi_coredump->fcmac2_regs_seg_hdr,\n\t\t\t\t       FCMAC2_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->fcmac2_regs),\n\t\t\t\t       \"FCMAC2 Registers\");\n\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->fcmac2_regs[0],\n\t\t\t\t   FCMAC2_REGS_ADDR, FCMAC_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->fc1_mbx_regs_seg_hdr,\n\t\t\t\t       FC1_MBOX_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->fc1_mbx_regs),\n\t\t\t\t       \"FC1 MBox Regs\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->fc1_mbx_regs[0],\n\t\t\t\t   FC1_MBX_REGS_ADDR, FC_MBX_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->ide_regs_seg_hdr,\n\t\t\t\t       IDE_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->ide_regs),\n\t\t\t\t       \"IDE Registers\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->ide_regs[0],\n\t\t\t\t   IDE_REGS_ADDR, IDE_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->nic1_mbx_regs_seg_hdr,\n\t\t\t\t       NIC1_MBOX_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->nic1_mbx_regs),\n\t\t\t\t       \"NIC1 MBox Regs\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->nic1_mbx_regs[0],\n\t\t\t\t   NIC1_MBX_REGS_ADDR, NIC_MBX_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->smbus_regs_seg_hdr,\n\t\t\t\t       SMBUS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->smbus_regs),\n\t\t\t\t       \"SMBus Registers\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->smbus_regs[0],\n\t\t\t\t   SMBUS_REGS_ADDR, SMBUS_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->fc2_mbx_regs_seg_hdr,\n\t\t\t\t       FC2_MBOX_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->fc2_mbx_regs),\n\t\t\t\t       \"FC2 MBox Regs\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->fc2_mbx_regs[0],\n\t\t\t\t   FC2_MBX_REGS_ADDR, FC_MBX_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->nic2_mbx_regs_seg_hdr,\n\t\t\t\t       NIC2_MBOX_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->nic2_mbx_regs),\n\t\t\t\t       \"NIC2 MBox Regs\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->nic2_mbx_regs[0],\n\t\t\t\t   NIC2_MBX_REGS_ADDR, NIC_MBX_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->i2c_regs_seg_hdr,\n\t\t\t\t       I2C_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->i2c_regs),\n\t\t\t\t       \"I2C Registers\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->i2c_regs[0],\n\t\t\t\t   I2C_REGS_ADDR, I2C_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->memc_regs_seg_hdr,\n\t\t\t\t       MEMC_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->memc_regs),\n\t\t\t\t       \"MEMC Registers\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->memc_regs[0],\n\t\t\t\t   MEMC_REGS_ADDR, MEMC_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->pbus_regs_seg_hdr,\n\t\t\t\t       PBUS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->pbus_regs),\n\t\t\t\t       \"PBUS Registers\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->pbus_regs[0],\n\t\t\t\t   PBUS_REGS_ADDR, PBUS_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->mde_regs_seg_hdr,\n\t\t\t\t       MDE_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->mde_regs),\n\t\t\t\t       \"MDE Registers\");\n\tstatus = qlge_get_mpi_regs(qdev, &mpi_coredump->mde_regs[0],\n\t\t\t\t   MDE_REGS_ADDR, MDE_REGS_CNT);\n\tif (status)\n\t\tgoto err;\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->misc_nic_seg_hdr,\n\t\t\t\t       MISC_NIC_INFO_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->misc_nic_info),\n\t\t\t\t       \"MISC NIC INFO\");\n\tmpi_coredump->misc_nic_info.rx_ring_count = qdev->rx_ring_count;\n\tmpi_coredump->misc_nic_info.tx_ring_count = qdev->tx_ring_count;\n\tmpi_coredump->misc_nic_info.intr_count = qdev->intr_count;\n\tmpi_coredump->misc_nic_info.function = qdev->func;\n\n\t \n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->intr_states_seg_hdr,\n\t\t\t\t       INTR_STATES_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->intr_states),\n\t\t\t\t       \"INTR States\");\n\tqlge_get_intr_states(qdev, &mpi_coredump->intr_states[0]);\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->cam_entries_seg_hdr,\n\t\t\t\t       CAM_ENTRIES_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->cam_entries),\n\t\t\t\t       \"CAM Entries\");\n\tstatus = qlge_get_cam_entries(qdev, &mpi_coredump->cam_entries[0]);\n\tif (status)\n\t\tgoto err;\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->nic_routing_words_seg_hdr,\n\t\t\t\t       ROUTING_WORDS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->nic_routing_words),\n\t\t\t\t       \"Routing Words\");\n\tstatus = qlge_get_routing_entries(qdev,\n\t\t\t\t\t  &mpi_coredump->nic_routing_words[0]);\n\tif (status)\n\t\tgoto err;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->ets_seg_hdr,\n\t\t\t\t       ETS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->ets),\n\t\t\t\t       \"ETS Registers\");\n\tstatus = qlge_get_ets_regs(qdev, &mpi_coredump->ets[0]);\n\tif (status)\n\t\tgoto err;\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->probe_dump_seg_hdr,\n\t\t\t\t       PROBE_DUMP_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->probe_dump),\n\t\t\t\t       \"Probe Dump\");\n\tqlge_get_probe_dump(qdev, &mpi_coredump->probe_dump[0]);\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->routing_reg_seg_hdr,\n\t\t\t\t       ROUTING_INDEX_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->routing_regs),\n\t\t\t\t       \"Routing Regs\");\n\tstatus = qlge_get_routing_index_registers(qdev,\n\t\t\t\t\t\t  &mpi_coredump->routing_regs[0]);\n\tif (status)\n\t\tgoto err;\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->mac_prot_reg_seg_hdr,\n\t\t\t\t       MAC_PROTOCOL_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->mac_prot_regs),\n\t\t\t\t       \"MAC Prot Regs\");\n\tqlge_get_mac_protocol_registers(qdev, &mpi_coredump->mac_prot_regs[0]);\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->sem_regs_seg_hdr,\n\t\t\t\t       SEM_REGS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header) +\n\t\t\t\t       sizeof(mpi_coredump->sem_regs),\t\"Sem Registers\");\n\n\tqlge_get_sem_registers(qdev, &mpi_coredump->sem_regs[0]);\n\n\t \n\tqlge_write_mpi_reg(qdev, MPI_TEST_FUNC_RST_STS, MPI_TEST_FUNC_RST_FRC);\n\n\t \n\tstatus = qlge_unpause_mpi_risc(qdev);\n\tif (status) {\n\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t  \"Failed RISC unpause. Status = 0x%.08x\\n\", status);\n\t\tgoto err;\n\t}\n\n\t \n\tstatus = qlge_hard_reset_mpi_risc(qdev);\n\tif (status) {\n\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t  \"Failed RISC reset. Status = 0x%.08x\\n\", status);\n\t\tgoto err;\n\t}\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->code_ram_seg_hdr,\n\t\t\t\t       WCS_RAM_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->code_ram),\n\t\t\t\t       \"WCS RAM\");\n\tstatus = qlge_dump_risc_ram_area(qdev, &mpi_coredump->code_ram[0],\n\t\t\t\t\t CODE_RAM_ADDR, CODE_RAM_CNT);\n\tif (status) {\n\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t  \"Failed Dump of CODE RAM. Status = 0x%.08x\\n\",\n\t\t\t  status);\n\t\tgoto err;\n\t}\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->memc_ram_seg_hdr,\n\t\t\t\t       MEMC_RAM_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->memc_ram),\n\t\t\t\t       \"MEMC RAM\");\n\tstatus = qlge_dump_risc_ram_area(qdev, &mpi_coredump->memc_ram[0],\n\t\t\t\t\t MEMC_RAM_ADDR, MEMC_RAM_CNT);\n\tif (status) {\n\t\tnetif_err(qdev, drv, qdev->ndev,\n\t\t\t  \"Failed Dump of MEMC RAM. Status = 0x%.08x\\n\",\n\t\t\t  status);\n\t\tgoto err;\n\t}\nerr:\n\tqlge_sem_unlock(qdev, SEM_PROC_REG_MASK);  \n\treturn status;\n}\n\nstatic void qlge_get_core_dump(struct qlge_adapter *qdev)\n{\n\tif (!qlge_own_firmware(qdev)) {\n\t\tnetif_err(qdev, drv, qdev->ndev, \"Don't own firmware!\\n\");\n\t\treturn;\n\t}\n\n\tif (!netif_running(qdev->ndev)) {\n\t\tnetif_err(qdev, ifup, qdev->ndev,\n\t\t\t  \"Force Coredump can only be done from interface that is up\\n\");\n\t\treturn;\n\t}\n\tqlge_queue_fw_error(qdev);\n}\n\nstatic void qlge_gen_reg_dump(struct qlge_adapter *qdev,\n\t\t\t      struct qlge_reg_dump *mpi_coredump)\n{\n\tint i, status;\n\n\tmemset(&mpi_coredump->mpi_global_header, 0,\n\t       sizeof(struct mpi_coredump_global_header));\n\tmpi_coredump->mpi_global_header.cookie = MPI_COREDUMP_COOKIE;\n\tmpi_coredump->mpi_global_header.header_size =\n\t\tsizeof(struct mpi_coredump_global_header);\n\tmpi_coredump->mpi_global_header.image_size =\n\t\tsizeof(struct qlge_reg_dump);\n\tstrncpy(mpi_coredump->mpi_global_header.id_string, \"MPI Coredump\",\n\t\tsizeof(mpi_coredump->mpi_global_header.id_string));\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->misc_nic_seg_hdr,\n\t\t\t\t       MISC_NIC_INFO_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->misc_nic_info),\n\t\t\t\t       \"MISC NIC INFO\");\n\tmpi_coredump->misc_nic_info.rx_ring_count = qdev->rx_ring_count;\n\tmpi_coredump->misc_nic_info.tx_ring_count = qdev->tx_ring_count;\n\tmpi_coredump->misc_nic_info.intr_count = qdev->intr_count;\n\tmpi_coredump->misc_nic_info.function = qdev->func;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->nic_regs_seg_hdr,\n\t\t\t\t       NIC1_CONTROL_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->nic_regs),\n\t\t\t\t       \"NIC Registers\");\n\t \n\tfor (i = 0; i < 64; i++)\n\t\tmpi_coredump->nic_regs[i] = qlge_read32(qdev, i * sizeof(u32));\n\n\t \n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->intr_states_seg_hdr,\n\t\t\t\t       INTR_STATES_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->intr_states),\n\t\t\t\t       \"INTR States\");\n\tqlge_get_intr_states(qdev, &mpi_coredump->intr_states[0]);\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->cam_entries_seg_hdr,\n\t\t\t\t       CAM_ENTRIES_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->cam_entries),\n\t\t\t\t       \"CAM Entries\");\n\tstatus = qlge_get_cam_entries(qdev, &mpi_coredump->cam_entries[0]);\n\tif (status)\n\t\treturn;\n\n\tqlge_build_coredump_seg_header(&mpi_coredump->nic_routing_words_seg_hdr,\n\t\t\t\t       ROUTING_WORDS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->nic_routing_words),\n\t\t\t\t       \"Routing Words\");\n\tstatus = qlge_get_routing_entries(qdev,\n\t\t\t\t\t  &mpi_coredump->nic_routing_words[0]);\n\tif (status)\n\t\treturn;\n\n\t \n\tqlge_build_coredump_seg_header(&mpi_coredump->ets_seg_hdr,\n\t\t\t\t       ETS_SEG_NUM,\n\t\t\t\t       sizeof(struct mpi_coredump_segment_header)\n\t\t\t\t       + sizeof(mpi_coredump->ets),\n\t\t\t\t       \"ETS Registers\");\n\tstatus = qlge_get_ets_regs(qdev, &mpi_coredump->ets[0]);\n\tif (status)\n\t\treturn;\n}\n\nvoid qlge_get_dump(struct qlge_adapter *qdev, void *buff)\n{\n\t \n\n\tif (!test_bit(QL_FRC_COREDUMP, &qdev->flags)) {\n\t\tif (!qlge_core_dump(qdev, buff))\n\t\t\tqlge_soft_reset_mpi_risc(qdev);\n\t\telse\n\t\t\tnetif_err(qdev, drv, qdev->ndev, \"coredump failed!\\n\");\n\t} else {\n\t\tqlge_gen_reg_dump(qdev, buff);\n\t\tqlge_get_core_dump(qdev);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}