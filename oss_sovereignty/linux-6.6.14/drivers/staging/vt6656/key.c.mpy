{
  "module_name": "key.c",
  "hash_id": "5494387ada2b9f678a5d5ec7ae94aab2b51f2aae0074b4710982b4dc42324e28",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/vt6656/key.c",
  "human_readable_source": "\n \n\n#include \"mac.h\"\n#include \"key.h\"\n#include \"usbpipe.h\"\n\nint vnt_key_init_table(struct vnt_private *priv)\n{\n\tu8 i;\n\tu8 data[MAX_KEY_TABLE];\n\n\tfor (i = 0; i < MAX_KEY_TABLE; i++)\n\t\tdata[i] = i;\n\n\treturn vnt_control_out(priv, MESSAGE_TYPE_CLRKEYENTRY,\n\t\t\t0, 0, ARRAY_SIZE(data), data);\n}\n\nstatic int vnt_set_keymode(struct ieee80211_hw *hw, u8 *mac_addr,\n\t\t\t   struct ieee80211_key_conf *key, u32 key_type,\n\t\t\t   u32 mode)\n{\n\tstruct vnt_private *priv = hw->priv;\n\tu8 broadcast[6] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff};\n\tu16 key_mode = 0;\n\tu32 entry = 0;\n\tu8 *bssid;\n\tu8 key_inx = key->keyidx;\n\tu8 i;\n\n\tif (mac_addr)\n\t\tbssid = mac_addr;\n\telse\n\t\tbssid = &broadcast[0];\n\n\tif (key_type != VNT_KEY_DEFAULTKEY) {\n\t\tfor (i = 0; i < (MAX_KEY_TABLE - 1); i++) {\n\t\t\tif (!test_bit(i, &priv->key_entry_inuse)) {\n\t\t\t\tset_bit(i, &priv->key_entry_inuse);\n\n\t\t\t\tkey->hw_key_idx = i;\n\t\t\t\tentry = key->hw_key_idx;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tswitch (key_type) {\n\tcase VNT_KEY_DEFAULTKEY:\n\t\t \n\t\tentry = MAX_KEY_TABLE - 1;\n\t\tkey->hw_key_idx = entry;\n\t\tfallthrough;\n\tcase VNT_KEY_GROUP_ADDRESS:\n\t\tkey_mode = mode | (mode << 4);\n\t\tbreak;\n\tcase VNT_KEY_GROUP:\n\t\tkey_mode = mode << 4;\n\t\tbreak;\n\tcase  VNT_KEY_PAIRWISE:\n\t\tkey_mode |= mode;\n\t\tkey_inx = 4;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tkey_mode |= key_type;\n\n\tif (mode == KEY_CTL_WEP) {\n\t\tif (key->keylen == WLAN_KEY_LEN_WEP40)\n\t\t\tkey->key[15] &= 0x7f;\n\t\tif (key->keylen == WLAN_KEY_LEN_WEP104)\n\t\t\tkey->key[15] |= 0x80;\n\t}\n\n\treturn vnt_mac_set_keyentry(priv, key_mode, entry,\n\t\t\t\t    key_inx, bssid, key->key);\n}\n\nint vnt_set_keys(struct ieee80211_hw *hw, struct ieee80211_sta *sta,\n\t\t struct ieee80211_vif *vif, struct ieee80211_key_conf *key)\n{\n\tstruct vnt_private *priv = hw->priv;\n\tu8 *mac_addr = NULL;\n\tu8 key_dec_mode = 0;\n\n\tif (sta)\n\t\tmac_addr = &sta->addr[0];\n\n\tswitch (key->cipher) {\n\tcase WLAN_CIPHER_SUITE_WEP40:\n\tcase WLAN_CIPHER_SUITE_WEP104:\n\t\tvnt_set_keymode(hw, mac_addr, key, VNT_KEY_DEFAULTKEY,\n\t\t\t\tKEY_CTL_WEP);\n\n\t\tkey->flags |= IEEE80211_KEY_FLAG_GENERATE_IV;\n\n\t\treturn vnt_set_keymode(hw, mac_addr, key, VNT_KEY_DEFAULTKEY,\n\t\t\t\t       KEY_CTL_WEP);\n\n\tcase WLAN_CIPHER_SUITE_TKIP:\n\t\tkey->flags |= IEEE80211_KEY_FLAG_GENERATE_MMIC;\n\t\tkey->flags |= IEEE80211_KEY_FLAG_GENERATE_IV;\n\n\t\tkey_dec_mode = KEY_CTL_TKIP;\n\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_CCMP:\n\t\tif (priv->local_id <= MAC_REVISION_A1)\n\t\t\treturn -EOPNOTSUPP;\n\n\t\tkey_dec_mode = KEY_CTL_CCMP;\n\n\t\tkey->flags |= IEEE80211_KEY_FLAG_GENERATE_IV;\n\t\tbreak;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif (key->flags & IEEE80211_KEY_FLAG_PAIRWISE)\n\t\treturn vnt_set_keymode(hw, mac_addr, key, VNT_KEY_PAIRWISE,\n\t\t\t\t       key_dec_mode);\n\n\treturn vnt_set_keymode(hw, mac_addr, key,\n\t\t\t\tVNT_KEY_GROUP_ADDRESS, key_dec_mode);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}