{
  "module_name": "wcmd.c",
  "hash_id": "f6a42208de009ce87c533927fe240b0b71396a65a7cefa6905bcd659ae8241e2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/vt6656/wcmd.c",
  "human_readable_source": "\n \n\n#include \"device.h\"\n#include \"mac.h\"\n#include \"wcmd.h\"\n#include \"power.h\"\n#include \"usbpipe.h\"\n#include \"rxtx.h\"\n#include \"rf.h\"\n\nstatic void vnt_cmd_timer_wait(struct vnt_private *priv, unsigned long msecs)\n{\n\tschedule_delayed_work(&priv->run_command_work, msecs_to_jiffies(msecs));\n}\n\nstatic u32 add_one_with_wrap_around(u32 var, u8 modulo)\n{\n\tif (var >= (modulo - 1))\n\t\tvar = 0;\n\telse\n\t\tvar++;\n\treturn var;\n}\n\nstatic int vnt_cmd_complete(struct vnt_private *priv)\n{\n\tpriv->command_state = WLAN_CMD_IDLE;\n\tif (priv->free_cmd_queue == CMD_Q_SIZE) {\n\t\t \n\t\tpriv->cmd_running = false;\n\t\treturn true;\n\t}\n\n\tpriv->command = priv->cmd_queue[priv->cmd_dequeue_idx];\n\n\tpriv->cmd_dequeue_idx = add_one_with_wrap_around(priv->cmd_dequeue_idx, CMD_Q_SIZE);\n\tpriv->free_cmd_queue++;\n\tpriv->cmd_running = true;\n\n\tswitch (priv->command) {\n\tcase WLAN_CMD_INIT_MAC80211:\n\t\tpriv->command_state = WLAN_CMD_INIT_MAC80211_START;\n\t\tbreak;\n\n\tcase WLAN_CMD_TBTT_WAKEUP:\n\t\tpriv->command_state = WLAN_CMD_TBTT_WAKEUP_START;\n\t\tbreak;\n\n\tcase WLAN_CMD_BECON_SEND:\n\t\tpriv->command_state = WLAN_CMD_BECON_SEND_START;\n\t\tbreak;\n\n\tcase WLAN_CMD_SETPOWER:\n\t\tpriv->command_state = WLAN_CMD_SETPOWER_START;\n\t\tbreak;\n\n\tcase WLAN_CMD_CHANGE_ANTENNA:\n\t\tpriv->command_state = WLAN_CMD_CHANGE_ANTENNA_START;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tvnt_cmd_timer_wait(priv, 0);\n\n\treturn true;\n}\n\nvoid vnt_run_command(struct work_struct *work)\n{\n\tstruct vnt_private *priv =\n\t\tcontainer_of(work, struct vnt_private, run_command_work.work);\n\n\tif (test_bit(DEVICE_FLAGS_DISCONNECTED, &priv->flags))\n\t\treturn;\n\n\tif (!priv->cmd_running)\n\t\treturn;\n\n\tswitch (priv->command_state) {\n\tcase WLAN_CMD_INIT_MAC80211_START:\n\t\tif (priv->mac_hw)\n\t\t\tbreak;\n\n\t\tdev_info(&priv->usb->dev, \"Starting mac80211\\n\");\n\n\t\tif (vnt_init(priv)) {\n\t\t\t \n\t\t\tdev_err(&priv->usb->dev, \"failed to start\\n\");\n\t\t\tusb_set_intfdata(priv->intf, NULL);\n\t\t\tieee80211_free_hw(priv->hw);\n\t\t\treturn;\n\t\t}\n\n\t\tbreak;\n\n\tcase WLAN_CMD_TBTT_WAKEUP_START:\n\t\tvnt_next_tbtt_wakeup(priv);\n\t\tbreak;\n\n\tcase WLAN_CMD_BECON_SEND_START:\n\t\tif (!priv->vif)\n\t\t\tbreak;\n\n\t\tvnt_beacon_make(priv, priv->vif);\n\n\t\tvnt_mac_reg_bits_on(priv, MAC_REG_TCR, TCR_AUTOBCNTX);\n\n\t\tbreak;\n\n\tcase WLAN_CMD_SETPOWER_START:\n\n\t\tvnt_rf_setpower(priv, priv->hw->conf.chandef.chan);\n\n\t\tbreak;\n\n\tcase WLAN_CMD_CHANGE_ANTENNA_START:\n\t\tdev_dbg(&priv->usb->dev, \"Change from Antenna%d to\",\n\t\t\tpriv->rx_antenna_sel);\n\n\t\tif (priv->rx_antenna_sel == 0) {\n\t\t\tpriv->rx_antenna_sel = 1;\n\t\t\tif (priv->tx_rx_ant_inv)\n\t\t\t\tvnt_set_antenna_mode(priv, ANT_RXA);\n\t\t\telse\n\t\t\t\tvnt_set_antenna_mode(priv, ANT_RXB);\n\t\t} else {\n\t\t\tpriv->rx_antenna_sel = 0;\n\t\t\tif (priv->tx_rx_ant_inv)\n\t\t\t\tvnt_set_antenna_mode(priv, ANT_RXB);\n\t\t\telse\n\t\t\t\tvnt_set_antenna_mode(priv, ANT_RXA);\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\tvnt_cmd_complete(priv);\n}\n\nint vnt_schedule_command(struct vnt_private *priv, enum vnt_cmd command)\n{\n\tif (priv->free_cmd_queue == 0)\n\t\treturn false;\n\n\tpriv->cmd_queue[priv->cmd_enqueue_idx] = command;\n\n\tpriv->cmd_enqueue_idx = add_one_with_wrap_around(priv->cmd_enqueue_idx, CMD_Q_SIZE);\n\tpriv->free_cmd_queue--;\n\n\tif (!priv->cmd_running)\n\t\tvnt_cmd_complete(priv);\n\n\treturn true;\n}\n\nvoid vnt_reset_command_timer(struct vnt_private *priv)\n{\n\tpriv->free_cmd_queue = CMD_Q_SIZE;\n\tpriv->cmd_dequeue_idx = 0;\n\tpriv->cmd_enqueue_idx = 0;\n\tpriv->command_state = WLAN_CMD_IDLE;\n\tpriv->cmd_running = false;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}