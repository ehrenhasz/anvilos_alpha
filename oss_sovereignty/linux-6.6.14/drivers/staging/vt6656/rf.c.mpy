{
  "module_name": "rf.c",
  "hash_id": "2d0460c05be34935688c3d0fb20e2515c4ecb73e8dabef52fd95fb89d757eb8b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/vt6656/rf.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include \"mac.h\"\n#include \"rf.h\"\n#include \"baseband.h\"\n#include \"usbpipe.h\"\n\n#define CB_AL2230_INIT_SEQ    15\n#define CB_AL7230_INIT_SEQ    16\n#define CB_VT3226_INIT_SEQ    11\n#define CB_VT3342_INIT_SEQ    13\n\nstatic u8 al2230_init_table[CB_AL2230_INIT_SEQ][3] = {\n\t{0x03, 0xf7, 0x90},\n\t{0x03, 0x33, 0x31},\n\t{0x01, 0xb8, 0x02},\n\t{0x00, 0xff, 0xf3},\n\t{0x00, 0x05, 0xa4},\n\t{0x0f, 0x4d, 0xc5},\n\t{0x08, 0x05, 0xb6},\n\t{0x01, 0x47, 0xc7},\n\t{0x00, 0x06, 0x88},\n\t{0x04, 0x03, 0xb9},\n\t{0x00, 0xdb, 0xba},\n\t{0x00, 0x09, 0x9b},\n\t{0x0b, 0xdf, 0xfc},\n\t{0x00, 0x00, 0x0d},\n\t{0x00, 0x58, 0x0f}\n};\n\nstatic u8 al2230_channel_table0[CB_MAX_CHANNEL_24G][3] = {\n\t{0x03, 0xf7, 0x90},\n\t{0x03, 0xf7, 0x90},\n\t{0x03, 0xe7, 0x90},\n\t{0x03, 0xe7, 0x90},\n\t{0x03, 0xf7, 0xa0},\n\t{0x03, 0xf7, 0xa0},\n\t{0x03, 0xe7, 0xa0},\n\t{0x03, 0xe7, 0xa0},\n\t{0x03, 0xf7, 0xb0},\n\t{0x03, 0xf7, 0xb0},\n\t{0x03, 0xe7, 0xb0},\n\t{0x03, 0xe7, 0xb0},\n\t{0x03, 0xf7, 0xc0},\n\t{0x03, 0xe7, 0xc0}\n};\n\nstatic u8 al2230_channel_table1[CB_MAX_CHANNEL_24G][3] = {\n\t{0x03, 0x33, 0x31},\n\t{0x0b, 0x33, 0x31},\n\t{0x03, 0x33, 0x31},\n\t{0x0b, 0x33, 0x31},\n\t{0x03, 0x33, 0x31},\n\t{0x0b, 0x33, 0x31},\n\t{0x03, 0x33, 0x31},\n\t{0x0b, 0x33, 0x31},\n\t{0x03, 0x33, 0x31},\n\t{0x0b, 0x33, 0x31},\n\t{0x03, 0x33, 0x31},\n\t{0x0b, 0x33, 0x31},\n\t{0x03, 0x33, 0x31},\n\t{0x06, 0x66, 0x61}\n};\n\nstatic u8 vt3226_init_table[CB_VT3226_INIT_SEQ][3] = {\n\t{0x03, 0xff, 0x80},\n\t{0x02, 0x82, 0xa1},\n\t{0x03, 0xc6, 0xa2},\n\t{0x01, 0x97, 0x93},\n\t{0x03, 0x66, 0x64},\n\t{0x00, 0x61, 0xa5},\n\t{0x01, 0x7b, 0xd6},\n\t{0x00, 0x80, 0x17},\n\t{0x03, 0xf8, 0x08},\n\t{0x00, 0x02, 0x39},\n\t{0x02, 0x00, 0x2a}\n};\n\nstatic u8 vt3226d0_init_table[CB_VT3226_INIT_SEQ][3] = {\n\t{0x03, 0xff, 0x80},\n\t{0x03, 0x02, 0x21},\n\t{0x03, 0xc6, 0xa2},\n\t{0x01, 0x97, 0x93},\n\t{0x03, 0x66, 0x64},\n\t{0x00, 0x71, 0xa5},\n\t{0x01, 0x15, 0xc6},\n\t{0x01, 0x2e, 0x07},\n\t{0x00, 0x58, 0x08},\n\t{0x00, 0x02, 0x79},\n\t{0x02, 0x01, 0xaa}\n};\n\nstatic u8 vt3226_channel_table0[CB_MAX_CHANNEL_24G][3] = {\n\t{0x01, 0x97, 0x83},\n\t{0x01, 0x97, 0x83},\n\t{0x01, 0x97, 0x93},\n\t{0x01, 0x97, 0x93},\n\t{0x01, 0x97, 0x93},\n\t{0x01, 0x97, 0x93},\n\t{0x01, 0x97, 0xa3},\n\t{0x01, 0x97, 0xa3},\n\t{0x01, 0x97, 0xa3},\n\t{0x01, 0x97, 0xa3},\n\t{0x01, 0x97, 0xb3},\n\t{0x01, 0x97, 0xb3},\n\t{0x01, 0x97, 0xb3},\n\t{0x03, 0x37, 0xc3}\n};\n\nstatic u8 vt3226_channel_table1[CB_MAX_CHANNEL_24G][3] = {\n\t{0x02, 0x66, 0x64},\n\t{0x03, 0x66, 0x64},\n\t{0x00, 0x66, 0x64},\n\t{0x01, 0x66, 0x64},\n\t{0x02, 0x66, 0x64},\n\t{0x03, 0x66, 0x64},\n\t{0x00, 0x66, 0x64},\n\t{0x01, 0x66, 0x64},\n\t{0x02, 0x66, 0x64},\n\t{0x03, 0x66, 0x64},\n\t{0x00, 0x66, 0x64},\n\t{0x01, 0x66, 0x64},\n\t{0x02, 0x66, 0x64},\n\t{0x00, 0xcc, 0xc4}\n};\n\nstatic const u32 vt3226d0_lo_current_table[CB_MAX_CHANNEL_24G] = {\n\t0x0135c600,\n\t0x0135c600,\n\t0x0235c600,\n\t0x0235c600,\n\t0x0235c600,\n\t0x0335c600,\n\t0x0335c600,\n\t0x0335c600,\n\t0x0335c600,\n\t0x0335c600,\n\t0x0335c600,\n\t0x0335c600,\n\t0x0335c600,\n\t0x0135c600\n};\n\nenum {\n\tVNT_TABLE_INIT = 0,\n\tVNT_TABLE_INIT_2 = 0,\n\tVNT_TABLE_0 = 1,\n\tVNT_TABLE_1 = 2,\n\tVNT_TABLE_2 = 1\n};\n\nstruct vnt_table_info {\n\tu8 *addr;\n\tint length;\n};\n\nstatic const struct vnt_table_info vnt_table_seq[][3] = {\n\t{\t \n\t\t{&al2230_init_table[0][0], CB_AL2230_INIT_SEQ * 3},\n\t\t{&al2230_channel_table0[0][0], CB_MAX_CHANNEL_24G * 3},\n\t\t{&al2230_channel_table1[0][0], CB_MAX_CHANNEL_24G * 3}\n\t}, {\t \n\t\t{&vt3226_init_table[0][0], CB_VT3226_INIT_SEQ * 3},\n\t\t{&vt3226_channel_table0[0][0], CB_MAX_CHANNEL_24G * 3},\n\t\t{&vt3226_channel_table1[0][0], CB_MAX_CHANNEL_24G * 3}\n\t}, {\t \n\t\t{&vt3226d0_init_table[0][0], CB_VT3226_INIT_SEQ * 3},\n\t\t{&vt3226_channel_table0[0][0], CB_MAX_CHANNEL_24G * 3},\n\t\t{&vt3226_channel_table1[0][0], CB_MAX_CHANNEL_24G * 3}\n\t}\n};\n\n \nint vnt_rf_write_embedded(struct vnt_private *priv, u32 data)\n{\n\tu8 reg_data[4];\n\n\tdata |= (VNT_RF_REG_LEN << 3) | IFREGCTL_REGW;\n\n\treg_data[0] = (u8)data;\n\treg_data[1] = (u8)(data >> 8);\n\treg_data[2] = (u8)(data >> 16);\n\treg_data[3] = (u8)(data >> 24);\n\n\treturn vnt_control_out(priv, MESSAGE_TYPE_WRITE_IFRF, 0, 0,\n\t\t\t       ARRAY_SIZE(reg_data), reg_data);\n}\n\nstatic u8 vnt_rf_addpower(struct vnt_private *priv)\n{\n\tint base;\n\ts32 rssi = -priv->current_rssi;\n\n\tif (!rssi)\n\t\treturn 7;\n\n\tif (priv->rf_type == RF_VT3226D0)\n\t\tbase = -60;\n\telse\n\t\tbase = -70;\n\n\tif (rssi < base)\n\t\treturn ((rssi - base + 1) / -5) * 2 + 5;\n\n\treturn 0;\n}\n\n \nstatic int vnt_rf_set_txpower(struct vnt_private *priv, u8 power,\n\t\t\t      struct ieee80211_channel *ch)\n{\n\tu32 power_setting = 0;\n\tint ret = 0;\n\n\tpower += vnt_rf_addpower(priv);\n\tif (power > VNT_RF_MAX_POWER)\n\t\tpower = VNT_RF_MAX_POWER;\n\n\tif (priv->power == power)\n\t\treturn 0;\n\n\tpriv->power = power;\n\n\tswitch (priv->rf_type) {\n\tcase RF_AL2230:\n\t\tpower_setting = 0x0404090 | (power << 12);\n\n\t\tret = vnt_rf_write_embedded(priv, power_setting);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (ch->flags & IEEE80211_CHAN_NO_OFDM)\n\t\t\tret = vnt_rf_write_embedded(priv, 0x0001b400);\n\t\telse\n\t\t\tret = vnt_rf_write_embedded(priv, 0x0005a400);\n\n\t\tbreak;\n\tcase RF_AL2230S:\n\t\tpower_setting = 0x0404090 | (power << 12);\n\n\t\tret = vnt_rf_write_embedded(priv, power_setting);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (ch->flags & IEEE80211_CHAN_NO_OFDM) {\n\t\t\tret = vnt_rf_write_embedded(priv, 0x040c1400);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tret = vnt_rf_write_embedded(priv, 0x00299b00);\n\t\t} else {\n\t\t\tret = vnt_rf_write_embedded(priv, 0x0005a400);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tret = vnt_rf_write_embedded(priv, 0x00099b00);\n\t\t}\n\n\t\tbreak;\n\n\tcase RF_VT3226:\n\t\tpower_setting = ((0x3f - power) << 20) | (0x17 << 8);\n\n\t\tret = vnt_rf_write_embedded(priv, power_setting);\n\t\tbreak;\n\tcase RF_VT3226D0:\n\t\tif (ch->flags & IEEE80211_CHAN_NO_OFDM) {\n\t\t\tu16 hw_value = ch->hw_value;\n\n\t\t\tpower_setting = ((0x3f - power) << 20) | (0xe07 << 8);\n\n\t\t\tret = vnt_rf_write_embedded(priv, power_setting);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tret = vnt_rf_write_embedded(priv, 0x03c6a200);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tdev_dbg(&priv->usb->dev,\n\t\t\t\t\"%s 11b channel [%d]\\n\", __func__, hw_value);\n\n\t\t\thw_value--;\n\n\t\t\tif (hw_value < ARRAY_SIZE(vt3226d0_lo_current_table)) {\n\t\t\t\tret = vnt_rf_write_embedded(priv,\n\t\t\t\t\t\t\t    vt3226d0_lo_current_table[hw_value]);\n\t\t\t\tif (ret)\n\t\t\t\t\treturn ret;\n\t\t\t}\n\n\t\t\tret = vnt_rf_write_embedded(priv, 0x015C0800);\n\t\t} else {\n\t\t\tdev_dbg(&priv->usb->dev,\n\t\t\t\t\"@@@@ %s> 11G mode\\n\", __func__);\n\n\t\t\tpower_setting = ((0x3f - power) << 20) | (0x7 << 8);\n\n\t\t\tret = vnt_rf_write_embedded(priv, power_setting);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tret = vnt_rf_write_embedded(priv, 0x00C6A200);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tret = vnt_rf_write_embedded(priv, 0x016BC600);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tret = vnt_rf_write_embedded(priv, 0x00900800);\n\t\t}\n\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\n \nint vnt_rf_setpower(struct vnt_private *priv,\n\t\t    struct ieee80211_channel *ch)\n{\n\tu16 channel;\n\tu8 power = priv->cck_pwr;\n\n\tif (!ch)\n\t\treturn -EINVAL;\n\n\t \n\tchannel = ch->hw_value - 1;\n\n\tif (ch->flags & IEEE80211_CHAN_NO_OFDM) {\n\t\tif (channel < ARRAY_SIZE(priv->cck_pwr_tbl))\n\t\t\tpower = priv->cck_pwr_tbl[channel];\n\t} else if (ch->band == NL80211_BAND_5GHZ) {\n\t\t \n\t\tchannel -= 14;\n\n\t\tif (channel < ARRAY_SIZE(priv->ofdm_a_pwr_tbl))\n\t\t\tpower = priv->ofdm_a_pwr_tbl[channel];\n\t} else {\n\t\tif (channel < ARRAY_SIZE(priv->ofdm_pwr_tbl))\n\t\t\tpower = priv->ofdm_pwr_tbl[channel];\n\t}\n\n\treturn vnt_rf_set_txpower(priv, power, ch);\n}\n\n \nvoid vnt_rf_rssi_to_dbm(struct vnt_private *priv, u8 rssi, long *dbm)\n{\n\tu8 idx = ((rssi & 0xc0) >> 6) & 0x03;\n\tlong b = rssi & 0x3f;\n\tlong a = 0;\n\tu8 airoharf[4] = {0, 18, 0, 40};\n\n\tswitch (priv->rf_type) {\n\tcase RF_AL2230:\n\tcase RF_AL2230S:\n\tcase RF_VT3226:\n\tcase RF_VT3226D0:\n\t\ta = airoharf[idx];\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\t*dbm = -1 * (a + b * 2);\n}\n\nint vnt_rf_table_download(struct vnt_private *priv)\n{\n\tint ret;\n\tint idx = -1;\n\tconst struct vnt_table_info *table_seq;\n\n\tswitch (priv->rf_type) {\n\tcase RF_AL2230:\n\tcase RF_AL2230S:\n\t\tidx = 0;\n\t\tbreak;\n\tcase RF_VT3226:\n\t\tidx = 1;\n\t\tbreak;\n\tcase RF_VT3226D0:\n\t\tidx = 2;\n\t\tbreak;\n\t}\n\n\tif (idx < 0)\n\t\treturn 0;\n\n\ttable_seq = &vnt_table_seq[idx][0];\n\n\t \n\tret = vnt_control_out(priv, MESSAGE_TYPE_WRITE, 0,\n\t\t\t      MESSAGE_REQUEST_RF_INIT,\n\t\t\t      table_seq[VNT_TABLE_INIT].length,\n\t\t\t      table_seq[VNT_TABLE_INIT].addr);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = vnt_control_out_blocks(priv, VNT_REG_BLOCK_SIZE,\n\t\t\t\t     MESSAGE_REQUEST_RF_CH0,\n\t\t\t\t     table_seq[VNT_TABLE_0].length,\n\t\t\t\t     table_seq[VNT_TABLE_0].addr);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = vnt_control_out_blocks(priv, VNT_REG_BLOCK_SIZE,\n\t\t\t\t     MESSAGE_REQUEST_RF_CH1,\n\t\t\t\t     table_seq[VNT_TABLE_1].length,\n\t\t\t\t     table_seq[VNT_TABLE_1].addr);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}