{
  "module_name": "ethernet-rgmii.c",
  "hash_id": "1157ce0f4d5af79668b8f7b391cfeda001d50fee06590bb64c38697f11d91071",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/octeon/ethernet-rgmii.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/netdevice.h>\n#include <linux/interrupt.h>\n#include <linux/phy.h>\n#include <linux/ratelimit.h>\n#include <net/dst.h>\n\n#include \"octeon-ethernet.h\"\n#include \"ethernet-defines.h\"\n#include \"ethernet-util.h\"\n#include \"ethernet-mdio.h\"\n\nstatic DEFINE_SPINLOCK(global_register_lock);\n\nstatic void cvm_oct_set_hw_preamble(struct octeon_ethernet *priv, bool enable)\n{\n\tunion cvmx_gmxx_rxx_frm_ctl gmxx_rxx_frm_ctl;\n\tunion cvmx_ipd_sub_port_fcs ipd_sub_port_fcs;\n\tunion cvmx_gmxx_rxx_int_reg gmxx_rxx_int_reg;\n\tint interface = INTERFACE(priv->port);\n\tint index = INDEX(priv->port);\n\n\t \n\tgmxx_rxx_frm_ctl.u64 = cvmx_read_csr(CVMX_GMXX_RXX_FRM_CTL(index,\n\t\t\t\t\t\t\t\t   interface));\n\tgmxx_rxx_frm_ctl.s.pre_chk = enable;\n\tcvmx_write_csr(CVMX_GMXX_RXX_FRM_CTL(index, interface),\n\t\t       gmxx_rxx_frm_ctl.u64);\n\n\t \n\tipd_sub_port_fcs.u64 = cvmx_read_csr(CVMX_IPD_SUB_PORT_FCS);\n\tif (enable)\n\t\tipd_sub_port_fcs.s.port_bit |= 1ull << priv->port;\n\telse\n\t\tipd_sub_port_fcs.s.port_bit &=\n\t\t\t\t\t0xffffffffull ^ (1ull << priv->port);\n\tcvmx_write_csr(CVMX_IPD_SUB_PORT_FCS, ipd_sub_port_fcs.u64);\n\n\t \n\tgmxx_rxx_int_reg.u64 = cvmx_read_csr(CVMX_GMXX_RXX_INT_REG(index,\n\t\t\t\t\t\t\t\t   interface));\n\tcvmx_write_csr(CVMX_GMXX_RXX_INT_REG(index, interface),\n\t\t       gmxx_rxx_int_reg.u64);\n}\n\nstatic void cvm_oct_check_preamble_errors(struct net_device *dev)\n{\n\tstruct octeon_ethernet *priv = netdev_priv(dev);\n\tunion cvmx_helper_link_info link_info;\n\tunsigned long flags;\n\n\tlink_info.u64 = priv->link_info;\n\n\t \n\tspin_lock_irqsave(&global_register_lock, flags);\n\n\tif (link_info.s.speed == 10 && priv->last_speed == 10) {\n\t\t \n\t\tint interface = INTERFACE(priv->port);\n\t\tint index = INDEX(priv->port);\n\t\tunion cvmx_gmxx_rxx_int_reg gmxx_rxx_int_reg;\n\n\t\tgmxx_rxx_int_reg.u64 = cvmx_read_csr(CVMX_GMXX_RXX_INT_REG\n\t\t\t\t\t\t\t(index, interface));\n\t\tif (gmxx_rxx_int_reg.s.pcterr) {\n\t\t\t \n\t\t\tcvm_oct_set_hw_preamble(priv, false);\n\t\t\tprintk_ratelimited(\"%s: Using 10Mbps with software preamble removal\\n\",\n\t\t\t\t\t   dev->name);\n\t\t}\n\t} else {\n\t\t \n\t\tif (priv->last_speed != link_info.s.speed)\n\t\t\tcvm_oct_set_hw_preamble(priv, true);\n\t\tpriv->last_speed = link_info.s.speed;\n\t}\n\tspin_unlock_irqrestore(&global_register_lock, flags);\n}\n\nstatic void cvm_oct_rgmii_poll(struct net_device *dev)\n{\n\tstruct octeon_ethernet *priv = netdev_priv(dev);\n\tunion cvmx_helper_link_info link_info;\n\tbool status_change;\n\n\tlink_info = cvmx_helper_link_get(priv->port);\n\tif (priv->link_info != link_info.u64 &&\n\t    cvmx_helper_link_set(priv->port, link_info))\n\t\tlink_info.u64 = priv->link_info;\n\tstatus_change = priv->link_info != link_info.u64;\n\tpriv->link_info = link_info.u64;\n\n\tcvm_oct_check_preamble_errors(dev);\n\n\tif (likely(!status_change))\n\t\treturn;\n\n\t \n\tif (link_info.s.link_up) {\n\t\tif (!netif_carrier_ok(dev))\n\t\t\tnetif_carrier_on(dev);\n\t} else if (netif_carrier_ok(dev)) {\n\t\tnetif_carrier_off(dev);\n\t}\n\tcvm_oct_note_carrier(priv, link_info);\n}\n\nint cvm_oct_rgmii_open(struct net_device *dev)\n{\n\tstruct octeon_ethernet *priv = netdev_priv(dev);\n\tint ret;\n\n\tret = cvm_oct_common_open(dev, cvm_oct_rgmii_poll);\n\tif (ret)\n\t\treturn ret;\n\n\tif (dev->phydev) {\n\t\t \n\t\tif ((priv->imode == CVMX_HELPER_INTERFACE_MODE_GMII &&\n\t\t     priv->port  == 0) ||\n\t\t    (priv->imode == CVMX_HELPER_INTERFACE_MODE_RGMII)) {\n\t\t\tpriv->poll = cvm_oct_check_preamble_errors;\n\t\t\tcvm_oct_check_preamble_errors(dev);\n\t\t}\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}