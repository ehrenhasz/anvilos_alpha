{
  "module_name": "ethernet-mdio.c",
  "hash_id": "495b06797cd94fdb19f9073cc332649559e16e62bae0d9d6bec39e42c653393b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/octeon/ethernet-mdio.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/ethtool.h>\n#include <linux/phy.h>\n#include <linux/ratelimit.h>\n#include <linux/of_mdio.h>\n#include <generated/utsrelease.h>\n#include <net/dst.h>\n\n#include \"octeon-ethernet.h\"\n#include \"ethernet-defines.h\"\n#include \"ethernet-mdio.h\"\n#include \"ethernet-util.h\"\n\nstatic void cvm_oct_get_drvinfo(struct net_device *dev,\n\t\t\t\tstruct ethtool_drvinfo *info)\n{\n\tstrscpy(info->driver, KBUILD_MODNAME, sizeof(info->driver));\n\tstrscpy(info->version, UTS_RELEASE, sizeof(info->version));\n\tstrscpy(info->bus_info, \"Builtin\", sizeof(info->bus_info));\n}\n\nstatic int cvm_oct_nway_reset(struct net_device *dev)\n{\n\tif (!capable(CAP_NET_ADMIN))\n\t\treturn -EPERM;\n\n\tif (dev->phydev)\n\t\treturn phy_start_aneg(dev->phydev);\n\n\treturn -EINVAL;\n}\n\nconst struct ethtool_ops cvm_oct_ethtool_ops = {\n\t.get_drvinfo = cvm_oct_get_drvinfo,\n\t.nway_reset = cvm_oct_nway_reset,\n\t.get_link = ethtool_op_get_link,\n\t.get_link_ksettings = phy_ethtool_get_link_ksettings,\n\t.set_link_ksettings = phy_ethtool_set_link_ksettings,\n};\n\n \nint cvm_oct_ioctl(struct net_device *dev, struct ifreq *rq, int cmd)\n{\n\tif (!netif_running(dev))\n\t\treturn -EINVAL;\n\n\tif (!dev->phydev)\n\t\treturn -EINVAL;\n\n\treturn phy_mii_ioctl(dev->phydev, rq, cmd);\n}\n\nvoid cvm_oct_note_carrier(struct octeon_ethernet *priv,\n\t\t\t  union cvmx_helper_link_info li)\n{\n\tif (li.s.link_up) {\n\t\tpr_notice_ratelimited(\"%s: %u Mbps %s duplex, port %d, queue %d\\n\",\n\t\t\t\t      netdev_name(priv->netdev), li.s.speed,\n\t\t\t\t      (li.s.full_duplex) ? \"Full\" : \"Half\",\n\t\t\t\t      priv->port, priv->queue);\n\t} else {\n\t\tpr_notice_ratelimited(\"%s: Link down\\n\",\n\t\t\t\t      netdev_name(priv->netdev));\n\t}\n}\n\nvoid cvm_oct_adjust_link(struct net_device *dev)\n{\n\tstruct octeon_ethernet *priv = netdev_priv(dev);\n\tunion cvmx_helper_link_info link_info;\n\n\tlink_info.u64\t\t= 0;\n\tlink_info.s.link_up\t= dev->phydev->link ? 1 : 0;\n\tlink_info.s.full_duplex = dev->phydev->duplex ? 1 : 0;\n\tlink_info.s.speed\t= dev->phydev->speed;\n\tpriv->link_info\t\t= link_info.u64;\n\n\t \n\tif (priv->poll)\n\t\tpriv->poll(dev);\n\n\tif (priv->last_link != dev->phydev->link) {\n\t\tpriv->last_link = dev->phydev->link;\n\t\tcvmx_helper_link_set(priv->port, link_info);\n\t\tcvm_oct_note_carrier(priv, link_info);\n\t}\n}\n\nint cvm_oct_common_stop(struct net_device *dev)\n{\n\tstruct octeon_ethernet *priv = netdev_priv(dev);\n\tint interface = INTERFACE(priv->port);\n\tunion cvmx_helper_link_info link_info;\n\tunion cvmx_gmxx_prtx_cfg gmx_cfg;\n\tint index = INDEX(priv->port);\n\n\tgmx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(index, interface));\n\tgmx_cfg.s.en = 0;\n\tcvmx_write_csr(CVMX_GMXX_PRTX_CFG(index, interface), gmx_cfg.u64);\n\n\tpriv->poll = NULL;\n\n\tif (dev->phydev)\n\t\tphy_disconnect(dev->phydev);\n\n\tif (priv->last_link) {\n\t\tlink_info.u64 = 0;\n\t\tpriv->last_link = 0;\n\n\t\tcvmx_helper_link_set(priv->port, link_info);\n\t\tcvm_oct_note_carrier(priv, link_info);\n\t}\n\treturn 0;\n}\n\n \nint cvm_oct_phy_setup_device(struct net_device *dev)\n{\n\tstruct octeon_ethernet *priv = netdev_priv(dev);\n\tstruct device_node *phy_node;\n\tstruct phy_device *phydev = NULL;\n\n\tif (!priv->of_node)\n\t\tgoto no_phy;\n\n\tphy_node = of_parse_phandle(priv->of_node, \"phy-handle\", 0);\n\tif (!phy_node && of_phy_is_fixed_link(priv->of_node))\n\t\tphy_node = of_node_get(priv->of_node);\n\tif (!phy_node)\n\t\tgoto no_phy;\n\n\tphydev = of_phy_connect(dev, phy_node, cvm_oct_adjust_link, 0,\n\t\t\t\tpriv->phy_mode);\n\tof_node_put(phy_node);\n\n\tif (!phydev)\n\t\treturn -EPROBE_DEFER;\n\n\tpriv->last_link = 0;\n\tphy_start(phydev);\n\n\treturn 0;\nno_phy:\n\t \n\tnetif_carrier_on(dev);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}