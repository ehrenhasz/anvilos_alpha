{
  "module_name": "firmware.c",
  "hash_id": "5fd6ace5ce8307751096a65ca52ed8255ee388dde87ee2418d3eae16ca193069",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/greybus/Documentation/firmware/firmware.c",
  "human_readable_source": "\n \n\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#include <sys/ioctl.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n\n#include \"../../greybus_firmware.h\"\n\n#define FW_DEV_DEFAULT\t\t\"/dev/gb-fw-mgmt-0\"\n#define FW_TAG_INT_DEFAULT\t\"s3f\"\n#define FW_TAG_BCND_DEFAULT\t\"bf_01\"\n#define FW_UPDATE_TYPE_DEFAULT\t0\n#define FW_TIMEOUT_DEFAULT\t10000\n\nstatic const char *firmware_tag;\nstatic const char *fwdev = FW_DEV_DEFAULT;\nstatic unsigned int fw_update_type = FW_UPDATE_TYPE_DEFAULT;\nstatic unsigned int fw_timeout = FW_TIMEOUT_DEFAULT;\n\nstatic struct fw_mgmt_ioc_get_intf_version intf_fw_info;\nstatic struct fw_mgmt_ioc_get_backend_version backend_fw_info;\nstatic struct fw_mgmt_ioc_intf_load_and_validate intf_load;\nstatic struct fw_mgmt_ioc_backend_fw_update backend_update;\n\nstatic void usage(void)\n{\n\tprintf(\"\\nUsage: ./firmware <gb-fw-mgmt-X (default: gb-fw-mgmt-0)> <interface: 0, backend: 1 (default: 0)> <firmware-tag> (default: \\\"s3f\\\"/\\\"bf_01\\\") <timeout (default: 10000 ms)>\\n\");\n}\n\nstatic int update_intf_firmware(int fd)\n{\n\tint ret;\n\n\t \n\tprintf(\"Get Interface Firmware Version\\n\");\n\n\tret = ioctl(fd, FW_MGMT_IOC_GET_INTF_FW, &intf_fw_info);\n\tif (ret < 0) {\n\t\tprintf(\"Failed to get interface firmware version: %s (%d)\\n\",\n\t\t\tfwdev, ret);\n\t\treturn -1;\n\t}\n\n\tprintf(\"Interface Firmware tag (%s), major (%d), minor (%d)\\n\",\n\t\tintf_fw_info.firmware_tag, intf_fw_info.major,\n\t\tintf_fw_info.minor);\n\n\t \n\tprintf(\"Loading Interface Firmware\\n\");\n\n\tintf_load.load_method = GB_FW_U_LOAD_METHOD_UNIPRO;\n\tintf_load.status = 0;\n\tintf_load.major = 0;\n\tintf_load.minor = 0;\n\n\tstrncpy((char *)&intf_load.firmware_tag, firmware_tag,\n\t\tGB_FIRMWARE_U_TAG_MAX_SIZE);\n\n\tret = ioctl(fd, FW_MGMT_IOC_INTF_LOAD_AND_VALIDATE, &intf_load);\n\tif (ret < 0) {\n\t\tprintf(\"Failed to load interface firmware: %s (%d)\\n\", fwdev,\n\t\t\tret);\n\t\treturn -1;\n\t}\n\n\tif (intf_load.status != GB_FW_U_LOAD_STATUS_VALIDATED &&\n\t    intf_load.status != GB_FW_U_LOAD_STATUS_UNVALIDATED) {\n\t\tprintf(\"Load status says loading failed: %d\\n\",\n\t\t\tintf_load.status);\n\t\treturn -1;\n\t}\n\n\tprintf(\"Interface Firmware (%s) Load done: major: %d, minor: %d, status: %d\\n\",\n\t\tfirmware_tag, intf_load.major, intf_load.minor,\n\t\tintf_load.status);\n\n\t \n\tprintf(\"Initiate Mode switch\\n\");\n\n\tret = ioctl(fd, FW_MGMT_IOC_MODE_SWITCH);\n\tif (ret < 0)\n\t\tprintf(\"Failed to initiate mode-switch (%d)\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int update_backend_firmware(int fd)\n{\n\tint ret;\n\n\t \n\tprintf(\"Getting Backend Firmware Version\\n\");\n\n\tstrncpy((char *)&backend_fw_info.firmware_tag, firmware_tag,\n\t\tGB_FIRMWARE_U_TAG_MAX_SIZE);\n\nretry_fw_version:\n\tret = ioctl(fd, FW_MGMT_IOC_GET_BACKEND_FW, &backend_fw_info);\n\tif (ret < 0) {\n\t\tprintf(\"Failed to get backend firmware version: %s (%d)\\n\",\n\t\t\tfwdev, ret);\n\t\treturn -1;\n\t}\n\n\tprintf(\"Backend Firmware tag (%s), major (%d), minor (%d), status (%d)\\n\",\n\t\tbackend_fw_info.firmware_tag, backend_fw_info.major,\n\t\tbackend_fw_info.minor, backend_fw_info.status);\n\n\tif (backend_fw_info.status == GB_FW_U_BACKEND_VERSION_STATUS_RETRY)\n\t\tgoto retry_fw_version;\n\n\tif ((backend_fw_info.status != GB_FW_U_BACKEND_VERSION_STATUS_SUCCESS)\n\t    && (backend_fw_info.status != GB_FW_U_BACKEND_VERSION_STATUS_NOT_AVAILABLE)) {\n\t\tprintf(\"Failed to get backend firmware version: %s (%d)\\n\",\n\t\t\tfwdev, backend_fw_info.status);\n\t\treturn -1;\n\t}\n\n\t \n\tprintf(\"Updating Backend Firmware\\n\");\n\n\tstrncpy((char *)&backend_update.firmware_tag, firmware_tag,\n\t\tGB_FIRMWARE_U_TAG_MAX_SIZE);\n\nretry_fw_update:\n\tbackend_update.status = 0;\n\n\tret = ioctl(fd, FW_MGMT_IOC_INTF_BACKEND_FW_UPDATE, &backend_update);\n\tif (ret < 0) {\n\t\tprintf(\"Failed to load backend firmware: %s (%d)\\n\", fwdev, ret);\n\t\treturn -1;\n\t}\n\n\tif (backend_update.status == GB_FW_U_BACKEND_FW_STATUS_RETRY) {\n\t\tprintf(\"Retrying firmware update: %d\\n\", backend_update.status);\n\t\tgoto retry_fw_update;\n\t}\n\n\tif (backend_update.status != GB_FW_U_BACKEND_FW_STATUS_SUCCESS) {\n\t\tprintf(\"Load status says loading failed: %d\\n\",\n\t\t\tbackend_update.status);\n\t} else {\n\t\tprintf(\"Backend Firmware (%s) Load done: status: %d\\n\",\n\t\t\t\tfirmware_tag, backend_update.status);\n\t}\n\n\treturn 0;\n}\n\nint main(int argc, char *argv[])\n{\n\tint fd, ret;\n\tchar *endptr;\n\n\tif (argc > 1 &&\n\t    (!strcmp(argv[1], \"-h\") || !strcmp(argv[1], \"--help\"))) {\n\t\tusage();\n\t\treturn -1;\n\t}\n\n\tif (argc > 1)\n\t\tfwdev = argv[1];\n\n\tif (argc > 2)\n\t\tfw_update_type = strtoul(argv[2], &endptr, 10);\n\n\tif (argc > 3)\n\t\tfirmware_tag = argv[3];\n\telse if (!fw_update_type)\n\t\tfirmware_tag = FW_TAG_INT_DEFAULT;\n\telse\n\t\tfirmware_tag = FW_TAG_BCND_DEFAULT;\n\n\tif (argc > 4)\n\t\tfw_timeout = strtoul(argv[4], &endptr, 10);\n\n\tprintf(\"Trying Firmware update: fwdev: %s, type: %s, tag: %s, timeout: %u\\n\",\n\t\tfwdev, fw_update_type == 0 ? \"interface\" : \"backend\",\n\t\tfirmware_tag, fw_timeout);\n\n\tprintf(\"Opening %s firmware management device\\n\", fwdev);\n\n\tfd = open(fwdev, O_RDWR);\n\tif (fd < 0) {\n\t\tprintf(\"Failed to open: %s\\n\", fwdev);\n\t\treturn -1;\n\t}\n\n\t \n\tprintf(\"Setting timeout to %u ms\\n\", fw_timeout);\n\n\tret = ioctl(fd, FW_MGMT_IOC_SET_TIMEOUT_MS, &fw_timeout);\n\tif (ret < 0) {\n\t\tprintf(\"Failed to set timeout: %s (%d)\\n\", fwdev, ret);\n\t\tret = -1;\n\t\tgoto close_fd;\n\t}\n\n\tif (!fw_update_type)\n\t\tret = update_intf_firmware(fd);\n\telse\n\t\tret = update_backend_firmware(fd);\n\nclose_fd:\n\tclose(fd);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}