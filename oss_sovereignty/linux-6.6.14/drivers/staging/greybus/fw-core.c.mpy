{
  "module_name": "fw-core.c",
  "hash_id": "ac03b667351c4071e7683034ed79e3eaf814f4ee54a4c5ea8ab5db66337c22e6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/greybus/fw-core.c",
  "human_readable_source": "\n \n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/firmware.h>\n#include <linux/greybus.h>\n#include \"firmware.h\"\n#include \"spilib.h\"\n\nstruct gb_fw_core {\n\tstruct gb_connection\t*download_connection;\n\tstruct gb_connection\t*mgmt_connection;\n\tstruct gb_connection\t*spi_connection;\n\tstruct gb_connection\t*cap_connection;\n};\n\nstatic struct spilib_ops *spilib_ops;\n\nstruct gb_connection *to_fw_mgmt_connection(struct device *dev)\n{\n\tstruct gb_fw_core *fw_core = dev_get_drvdata(dev);\n\n\treturn fw_core->mgmt_connection;\n}\n\nstatic int gb_fw_spi_connection_init(struct gb_connection *connection)\n{\n\tint ret;\n\n\tif (!connection)\n\t\treturn 0;\n\n\tret = gb_connection_enable(connection);\n\tif (ret)\n\t\treturn ret;\n\n\tret = gb_spilib_master_init(connection, &connection->bundle->dev,\n\t\t\t\t    spilib_ops);\n\tif (ret) {\n\t\tgb_connection_disable(connection);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic void gb_fw_spi_connection_exit(struct gb_connection *connection)\n{\n\tif (!connection)\n\t\treturn;\n\n\tgb_spilib_master_exit(connection);\n\tgb_connection_disable(connection);\n}\n\nstatic int gb_fw_core_probe(struct gb_bundle *bundle,\n\t\t\t    const struct greybus_bundle_id *id)\n{\n\tstruct greybus_descriptor_cport *cport_desc;\n\tstruct gb_connection *connection;\n\tstruct gb_fw_core *fw_core;\n\tint ret, i;\n\tu16 cport_id;\n\tu8 protocol_id;\n\n\tfw_core = kzalloc(sizeof(*fw_core), GFP_KERNEL);\n\tif (!fw_core)\n\t\treturn -ENOMEM;\n\n\t \n\tfor (i = 0; i < bundle->num_cports; i++) {\n\t\tcport_desc = &bundle->cport_desc[i];\n\t\tcport_id = le16_to_cpu(cport_desc->id);\n\t\tprotocol_id = cport_desc->protocol_id;\n\n\t\tswitch (protocol_id) {\n\t\tcase GREYBUS_PROTOCOL_FW_MANAGEMENT:\n\t\t\t \n\t\t\tif (fw_core->mgmt_connection) {\n\t\t\t\tdev_err(&bundle->dev,\n\t\t\t\t\t\"multiple management CPorts found\\n\");\n\t\t\t\tret = -EINVAL;\n\t\t\t\tgoto err_destroy_connections;\n\t\t\t}\n\n\t\t\tconnection = gb_connection_create(bundle, cport_id,\n\t\t\t\t\t\t\t  gb_fw_mgmt_request_handler);\n\t\t\tif (IS_ERR(connection)) {\n\t\t\t\tret = PTR_ERR(connection);\n\t\t\t\tdev_err(&bundle->dev,\n\t\t\t\t\t\"failed to create management connection (%d)\\n\",\n\t\t\t\t\tret);\n\t\t\t\tgoto err_destroy_connections;\n\t\t\t}\n\n\t\t\tfw_core->mgmt_connection = connection;\n\t\t\tbreak;\n\t\tcase GREYBUS_PROTOCOL_FW_DOWNLOAD:\n\t\t\t \n\t\t\tif (fw_core->download_connection) {\n\t\t\t\tdev_err(&bundle->dev,\n\t\t\t\t\t\"multiple download CPorts found\\n\");\n\t\t\t\tret = -EINVAL;\n\t\t\t\tgoto err_destroy_connections;\n\t\t\t}\n\n\t\t\tconnection = gb_connection_create(bundle, cport_id,\n\t\t\t\t\t\t\t  gb_fw_download_request_handler);\n\t\t\tif (IS_ERR(connection)) {\n\t\t\t\tdev_err(&bundle->dev, \"failed to create download connection (%ld)\\n\",\n\t\t\t\t\tPTR_ERR(connection));\n\t\t\t} else {\n\t\t\t\tfw_core->download_connection = connection;\n\t\t\t}\n\n\t\t\tbreak;\n\t\tcase GREYBUS_PROTOCOL_SPI:\n\t\t\t \n\t\t\tif (fw_core->spi_connection) {\n\t\t\t\tdev_err(&bundle->dev,\n\t\t\t\t\t\"multiple SPI CPorts found\\n\");\n\t\t\t\tret = -EINVAL;\n\t\t\t\tgoto err_destroy_connections;\n\t\t\t}\n\n\t\t\tconnection = gb_connection_create(bundle, cport_id,\n\t\t\t\t\t\t\t  NULL);\n\t\t\tif (IS_ERR(connection)) {\n\t\t\t\tdev_err(&bundle->dev, \"failed to create SPI connection (%ld)\\n\",\n\t\t\t\t\tPTR_ERR(connection));\n\t\t\t} else {\n\t\t\t\tfw_core->spi_connection = connection;\n\t\t\t}\n\n\t\t\tbreak;\n\t\tcase GREYBUS_PROTOCOL_AUTHENTICATION:\n\t\t\t \n\t\t\tif (fw_core->cap_connection) {\n\t\t\t\tdev_err(&bundle->dev, \"multiple Authentication CPorts found\\n\");\n\t\t\t\tret = -EINVAL;\n\t\t\t\tgoto err_destroy_connections;\n\t\t\t}\n\n\t\t\tconnection = gb_connection_create(bundle, cport_id,\n\t\t\t\t\t\t\t  NULL);\n\t\t\tif (IS_ERR(connection)) {\n\t\t\t\tdev_err(&bundle->dev, \"failed to create Authentication connection (%ld)\\n\",\n\t\t\t\t\tPTR_ERR(connection));\n\t\t\t} else {\n\t\t\t\tfw_core->cap_connection = connection;\n\t\t\t}\n\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(&bundle->dev, \"invalid protocol id (0x%02x)\\n\",\n\t\t\t\tprotocol_id);\n\t\t\tret = -EINVAL;\n\t\t\tgoto err_destroy_connections;\n\t\t}\n\t}\n\n\t \n\tif (!fw_core->mgmt_connection) {\n\t\tdev_err(&bundle->dev, \"missing management connection\\n\");\n\t\tret = -ENODEV;\n\t\tgoto err_destroy_connections;\n\t}\n\n\tret = gb_fw_download_connection_init(fw_core->download_connection);\n\tif (ret) {\n\t\t \n\t\tdev_err(&bundle->dev, \"failed to initialize firmware download connection, disable it (%d)\\n\",\n\t\t\tret);\n\t\tgb_connection_destroy(fw_core->download_connection);\n\t\tfw_core->download_connection = NULL;\n\t}\n\n\tret = gb_fw_spi_connection_init(fw_core->spi_connection);\n\tif (ret) {\n\t\t \n\t\tdev_err(&bundle->dev, \"failed to initialize SPI connection, disable it (%d)\\n\",\n\t\t\tret);\n\t\tgb_connection_destroy(fw_core->spi_connection);\n\t\tfw_core->spi_connection = NULL;\n\t}\n\n\tret = gb_cap_connection_init(fw_core->cap_connection);\n\tif (ret) {\n\t\t \n\t\tdev_err(&bundle->dev, \"failed to initialize CAP connection, disable it (%d)\\n\",\n\t\t\tret);\n\t\tgb_connection_destroy(fw_core->cap_connection);\n\t\tfw_core->cap_connection = NULL;\n\t}\n\n\tret = gb_fw_mgmt_connection_init(fw_core->mgmt_connection);\n\tif (ret) {\n\t\t \n\t\tdev_err(&bundle->dev, \"failed to initialize firmware management connection, disable it (%d)\\n\",\n\t\t\tret);\n\t\tgoto err_exit_connections;\n\t}\n\n\tgreybus_set_drvdata(bundle, fw_core);\n\n\t \n\tif (!(bundle->intf->quirks & GB_INTERFACE_QUIRK_NO_PM))\n\t\tgb_pm_runtime_put_autosuspend(bundle);\n\n\treturn 0;\n\nerr_exit_connections:\n\tgb_cap_connection_exit(fw_core->cap_connection);\n\tgb_fw_spi_connection_exit(fw_core->spi_connection);\n\tgb_fw_download_connection_exit(fw_core->download_connection);\nerr_destroy_connections:\n\tgb_connection_destroy(fw_core->mgmt_connection);\n\tgb_connection_destroy(fw_core->cap_connection);\n\tgb_connection_destroy(fw_core->spi_connection);\n\tgb_connection_destroy(fw_core->download_connection);\n\tkfree(fw_core);\n\n\treturn ret;\n}\n\nstatic void gb_fw_core_disconnect(struct gb_bundle *bundle)\n{\n\tstruct gb_fw_core *fw_core = greybus_get_drvdata(bundle);\n\tint ret;\n\n\t \n\tif (!(bundle->intf->quirks & GB_INTERFACE_QUIRK_NO_PM)) {\n\t\tret = gb_pm_runtime_get_sync(bundle);\n\t\tif (ret)\n\t\t\tgb_pm_runtime_get_noresume(bundle);\n\t}\n\n\tgb_fw_mgmt_connection_exit(fw_core->mgmt_connection);\n\tgb_cap_connection_exit(fw_core->cap_connection);\n\tgb_fw_spi_connection_exit(fw_core->spi_connection);\n\tgb_fw_download_connection_exit(fw_core->download_connection);\n\n\tgb_connection_destroy(fw_core->mgmt_connection);\n\tgb_connection_destroy(fw_core->cap_connection);\n\tgb_connection_destroy(fw_core->spi_connection);\n\tgb_connection_destroy(fw_core->download_connection);\n\n\tkfree(fw_core);\n}\n\nstatic const struct greybus_bundle_id gb_fw_core_id_table[] = {\n\t{ GREYBUS_DEVICE_CLASS(GREYBUS_CLASS_FW_MANAGEMENT) },\n\t{ }\n};\n\nstatic struct greybus_driver gb_fw_core_driver = {\n\t.name\t\t= \"gb-firmware\",\n\t.probe\t\t= gb_fw_core_probe,\n\t.disconnect\t= gb_fw_core_disconnect,\n\t.id_table\t= gb_fw_core_id_table,\n};\n\nstatic int fw_core_init(void)\n{\n\tint ret;\n\n\tret = fw_mgmt_init();\n\tif (ret) {\n\t\tpr_err(\"Failed to initialize fw-mgmt core (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = cap_init();\n\tif (ret) {\n\t\tpr_err(\"Failed to initialize component authentication core (%d)\\n\",\n\t\t       ret);\n\t\tgoto fw_mgmt_exit;\n\t}\n\n\tret = greybus_register(&gb_fw_core_driver);\n\tif (ret)\n\t\tgoto cap_exit;\n\n\treturn 0;\n\ncap_exit:\n\tcap_exit();\nfw_mgmt_exit:\n\tfw_mgmt_exit();\n\n\treturn ret;\n}\nmodule_init(fw_core_init);\n\nstatic void __exit fw_core_exit(void)\n{\n\tgreybus_deregister(&gb_fw_core_driver);\n\tcap_exit();\n\tfw_mgmt_exit();\n}\nmodule_exit(fw_core_exit);\n\nMODULE_ALIAS(\"greybus:firmware\");\nMODULE_AUTHOR(\"Viresh Kumar <viresh.kumar@linaro.org>\");\nMODULE_DESCRIPTION(\"Greybus Firmware Bundle Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}