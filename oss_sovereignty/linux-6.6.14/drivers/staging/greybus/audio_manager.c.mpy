{
  "module_name": "audio_manager.c",
  "hash_id": "5e9bfd7a3e7a304b652183d2d74a046bb27a2fc65d32e39c2ca8345597ce11f1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/greybus/audio_manager.c",
  "human_readable_source": "\n \n\n#include <linux/string.h>\n#include <linux/sysfs.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/spinlock.h>\n#include <linux/idr.h>\n\n#include \"audio_manager.h\"\n#include \"audio_manager_private.h\"\n\nstatic struct kset *manager_kset;\n\nstatic LIST_HEAD(modules_list);\nstatic DECLARE_RWSEM(modules_rwsem);\nstatic DEFINE_IDA(module_id);\n\n \nstatic struct gb_audio_manager_module *gb_audio_manager_get_locked(int id)\n{\n\tstruct gb_audio_manager_module *module;\n\n\tif (id < 0)\n\t\treturn NULL;\n\n\tlist_for_each_entry(module, &modules_list, list) {\n\t\tif (module->id == id)\n\t\t\treturn module;\n\t}\n\n\treturn NULL;\n}\n\n \nint gb_audio_manager_add(struct gb_audio_manager_module_descriptor *desc)\n{\n\tstruct gb_audio_manager_module *module;\n\tint id;\n\tint err;\n\n\tid = ida_simple_get(&module_id, 0, 0, GFP_KERNEL);\n\tif (id < 0)\n\t\treturn id;\n\n\terr = gb_audio_manager_module_create(&module, manager_kset,\n\t\t\t\t\t     id, desc);\n\tif (err) {\n\t\tida_simple_remove(&module_id, id);\n\t\treturn err;\n\t}\n\n\t \n\tdown_write(&modules_rwsem);\n\tlist_add_tail(&module->list, &modules_list);\n\tup_write(&modules_rwsem);\n\n\treturn module->id;\n}\nEXPORT_SYMBOL_GPL(gb_audio_manager_add);\n\nint gb_audio_manager_remove(int id)\n{\n\tstruct gb_audio_manager_module *module;\n\n\tdown_write(&modules_rwsem);\n\n\tmodule = gb_audio_manager_get_locked(id);\n\tif (!module) {\n\t\tup_write(&modules_rwsem);\n\t\treturn -EINVAL;\n\t}\n\tlist_del(&module->list);\n\tkobject_put(&module->kobj);\n\tup_write(&modules_rwsem);\n\tida_simple_remove(&module_id, id);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(gb_audio_manager_remove);\n\nvoid gb_audio_manager_remove_all(void)\n{\n\tstruct gb_audio_manager_module *module, *next;\n\tint is_empty;\n\n\tdown_write(&modules_rwsem);\n\n\tlist_for_each_entry_safe(module, next, &modules_list, list) {\n\t\tlist_del(&module->list);\n\t\tida_simple_remove(&module_id, module->id);\n\t\tkobject_put(&module->kobj);\n\t}\n\n\tis_empty = list_empty(&modules_list);\n\n\tup_write(&modules_rwsem);\n\n\tif (!is_empty)\n\t\tpr_warn(\"Not all nodes were deleted\\n\");\n}\nEXPORT_SYMBOL_GPL(gb_audio_manager_remove_all);\n\nstruct gb_audio_manager_module *gb_audio_manager_get_module(int id)\n{\n\tstruct gb_audio_manager_module *module;\n\n\tdown_read(&modules_rwsem);\n\tmodule = gb_audio_manager_get_locked(id);\n\tkobject_get(&module->kobj);\n\tup_read(&modules_rwsem);\n\treturn module;\n}\nEXPORT_SYMBOL_GPL(gb_audio_manager_get_module);\n\nvoid gb_audio_manager_put_module(struct gb_audio_manager_module *module)\n{\n\tkobject_put(&module->kobj);\n}\nEXPORT_SYMBOL_GPL(gb_audio_manager_put_module);\n\nint gb_audio_manager_dump_module(int id)\n{\n\tstruct gb_audio_manager_module *module;\n\n\tdown_read(&modules_rwsem);\n\tmodule = gb_audio_manager_get_locked(id);\n\tup_read(&modules_rwsem);\n\n\tif (!module)\n\t\treturn -EINVAL;\n\n\tgb_audio_manager_module_dump(module);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(gb_audio_manager_dump_module);\n\nvoid gb_audio_manager_dump_all(void)\n{\n\tstruct gb_audio_manager_module *module;\n\tint count = 0;\n\n\tdown_read(&modules_rwsem);\n\tlist_for_each_entry(module, &modules_list, list) {\n\t\tgb_audio_manager_module_dump(module);\n\t\tcount++;\n\t}\n\tup_read(&modules_rwsem);\n\n\tpr_info(\"Number of connected modules: %d\\n\", count);\n}\nEXPORT_SYMBOL_GPL(gb_audio_manager_dump_all);\n\n \nstatic int __init manager_init(void)\n{\n\tmanager_kset = kset_create_and_add(GB_AUDIO_MANAGER_NAME, NULL,\n\t\t\t\t\t   kernel_kobj);\n\tif (!manager_kset)\n\t\treturn -ENOMEM;\n\n#ifdef GB_AUDIO_MANAGER_SYSFS\n\tgb_audio_manager_sysfs_init(&manager_kset->kobj);\n#endif\n\n\treturn 0;\n}\n\nstatic void __exit manager_exit(void)\n{\n\tgb_audio_manager_remove_all();\n\tkset_unregister(manager_kset);\n\tida_destroy(&module_id);\n}\n\nmodule_init(manager_init);\nmodule_exit(manager_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Svetlin Ankov <ankov_svetlin@projectara.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}