{
  "module_name": "fb_hx8347d.c",
  "hash_id": "13af5148029433681473801f2a710237cc386e3ef8db33488eca9d74f778609b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/fbtft/fb_hx8347d.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n\n#include \"fbtft.h\"\n\n#define DRVNAME\t\t\"fb_hx8347d\"\n#define WIDTH\t\t320\n#define HEIGHT\t\t240\n#define DEFAULT_GAMMA\t\"0 0 0 0 0 0 0 0 0 0 0 0 0 0\\n\" \\\n\t\t\t\"0 0 0 0 0 0 0 0 0 0 0 0 0 0\"\n\nstatic int init_display(struct fbtft_par *par)\n{\n\tpar->fbtftops.reset(par);\n\n\t \n\twrite_reg(par, 0xEA, 0x00);\n\twrite_reg(par, 0xEB, 0x20);\n\twrite_reg(par, 0xEC, 0x0C);\n\twrite_reg(par, 0xED, 0xC4);\n\twrite_reg(par, 0xE8, 0x40);\n\twrite_reg(par, 0xE9, 0x38);\n\twrite_reg(par, 0xF1, 0x01);\n\twrite_reg(par, 0xF2, 0x10);\n\twrite_reg(par, 0x27, 0xA3);\n\n\t \n\twrite_reg(par, 0x1B, 0x1B);\n\twrite_reg(par, 0x1A, 0x01);\n\twrite_reg(par, 0x24, 0x2F);\n\twrite_reg(par, 0x25, 0x57);\n\n\t \n\twrite_reg(par, 0x23, 0x8D);  \n\n\t \n\twrite_reg(par, 0x18, 0x36);\n\twrite_reg(par, 0x19, 0x01);  \n\twrite_reg(par, 0x01, 0x00);  \n\twrite_reg(par, 0x1F, 0x88);\n\tmdelay(5);\n\twrite_reg(par, 0x1F, 0x80);\n\tmdelay(5);\n\twrite_reg(par, 0x1F, 0x90);\n\tmdelay(5);\n\twrite_reg(par, 0x1F, 0xD0);\n\tmdelay(5);\n\n\t \n\twrite_reg(par, 0x17, 0x05);  \n\n\t \n\twrite_reg(par, 0x36, 0x00);\n\n\t \n\twrite_reg(par, 0x28, 0x38);\n\tmdelay(40);\n\twrite_reg(par, 0x28, 0x3C);\n\n\treturn 0;\n}\n\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys, int xe, int ye)\n{\n\twrite_reg(par, 0x02, (xs >> 8) & 0xFF);\n\twrite_reg(par, 0x03, xs & 0xFF);\n\twrite_reg(par, 0x04, (xe >> 8) & 0xFF);\n\twrite_reg(par, 0x05, xe & 0xFF);\n\twrite_reg(par, 0x06, (ys >> 8) & 0xFF);\n\twrite_reg(par, 0x07, ys & 0xFF);\n\twrite_reg(par, 0x08, (ye >> 8) & 0xFF);\n\twrite_reg(par, 0x09, ye & 0xFF);\n\twrite_reg(par, 0x22);\n}\n\n#define MEM_Y   BIT(7)  \n#define MEM_X   BIT(6)  \n#define MEM_V   BIT(5)  \n#define MEM_L   BIT(4)  \n#define MEM_BGR (3)  \nstatic int set_var(struct fbtft_par *par)\n{\n\tswitch (par->info->var.rotate) {\n\tcase 0:\n\t\twrite_reg(par, 0x16, MEM_V | MEM_X | (par->bgr << MEM_BGR));\n\t\tbreak;\n\tcase 270:\n\t\twrite_reg(par, 0x16, par->bgr << MEM_BGR);\n\t\tbreak;\n\tcase 180:\n\t\twrite_reg(par, 0x16, MEM_V | MEM_Y | (par->bgr << MEM_BGR));\n\t\tbreak;\n\tcase 90:\n\t\twrite_reg(par, 0x16, MEM_X | MEM_Y | (par->bgr << MEM_BGR));\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n \n#define CURVE(num, idx)  curves[(num) * par->gamma.num_values + (idx)]\nstatic int set_gamma(struct fbtft_par *par, u32 *curves)\n{\n\tstatic const unsigned long mask[] = {\n\t\t0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0x7f, 0x7f, 0x1f, 0x1f,\n\t\t0x1f, 0x1f, 0x1f, 0x0f,\n\t};\n\tint i, j;\n\tint acc = 0;\n\n\t \n\tfor (i = 0; i < par->gamma.num_curves; i++)\n\t\tfor (j = 0; j < par->gamma.num_values; j++) {\n\t\t\tacc += CURVE(i, j);\n\t\t\tCURVE(i, j) &= mask[j];\n\t\t}\n\n\tif (acc == 0)  \n\t\treturn 0;\n\n\tfor (i = 0; i < par->gamma.num_curves; i++) {\n\t\twrite_reg(par, 0x40 + (i * 0x10), CURVE(i, 0));\n\t\twrite_reg(par, 0x41 + (i * 0x10), CURVE(i, 1));\n\t\twrite_reg(par, 0x42 + (i * 0x10), CURVE(i, 2));\n\t\twrite_reg(par, 0x43 + (i * 0x10), CURVE(i, 3));\n\t\twrite_reg(par, 0x44 + (i * 0x10), CURVE(i, 4));\n\t\twrite_reg(par, 0x45 + (i * 0x10), CURVE(i, 5));\n\t\twrite_reg(par, 0x46 + (i * 0x10), CURVE(i, 6));\n\t\twrite_reg(par, 0x47 + (i * 0x10), CURVE(i, 7));\n\t\twrite_reg(par, 0x48 + (i * 0x10), CURVE(i, 8));\n\t\twrite_reg(par, 0x49 + (i * 0x10), CURVE(i, 9));\n\t\twrite_reg(par, 0x4A + (i * 0x10), CURVE(i, 10));\n\t\twrite_reg(par, 0x4B + (i * 0x10), CURVE(i, 11));\n\t\twrite_reg(par, 0x4C + (i * 0x10), CURVE(i, 12));\n\t}\n\twrite_reg(par, 0x5D, (CURVE(1, 0) << 4) | CURVE(0, 0));\n\n\treturn 0;\n}\n\n#undef CURVE\n\nstatic struct fbtft_display display = {\n\t.regwidth = 8,\n\t.width = WIDTH,\n\t.height = HEIGHT,\n\t.gamma_num = 2,\n\t.gamma_len = 14,\n\t.gamma = DEFAULT_GAMMA,\n\t.fbtftops = {\n\t\t.init_display = init_display,\n\t\t.set_addr_win = set_addr_win,\n\t\t.set_var = set_var,\n\t\t.set_gamma = set_gamma,\n\t},\n};\n\nFBTFT_REGISTER_DRIVER(DRVNAME, \"himax,hx8347d\", &display);\n\nMODULE_ALIAS(\"spi:\" DRVNAME);\nMODULE_ALIAS(\"platform:\" DRVNAME);\nMODULE_ALIAS(\"spi:hx8347d\");\nMODULE_ALIAS(\"platform:hx8347d\");\n\nMODULE_DESCRIPTION(\"FB driver for the HX8347D LCD Controller\");\nMODULE_AUTHOR(\"Christian Vogelgsang\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}