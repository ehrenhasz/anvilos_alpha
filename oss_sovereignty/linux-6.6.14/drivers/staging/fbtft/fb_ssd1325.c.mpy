{
  "module_name": "fb_ssd1325.c",
  "hash_id": "23c1b6840ae0ffba7d6aa52c53c505e3a5126f26e54a16c7a54d094974f4ca6b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/fbtft/fb_ssd1325.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/gpio/consumer.h>\n#include <linux/delay.h>\n\n#include \"fbtft.h\"\n\n#define DRVNAME\t\t\"fb_ssd1325\"\n\n#define WIDTH 128\n#define HEIGHT 64\n#define GAMMA_NUM   1\n#define GAMMA_LEN   15\n#define DEFAULT_GAMMA \"7 1 1 1 1 2 2 3 3 4 4 5 5 6 6\"\n\n \n\n \nstatic int init_display(struct fbtft_par *par)\n{\n\tpar->fbtftops.reset(par);\n\n\twrite_reg(par, 0xb3);\n\twrite_reg(par, 0xf0);\n\twrite_reg(par, 0xae);\n\twrite_reg(par, 0xa1);\n\twrite_reg(par, 0x00);\n\twrite_reg(par, 0xa8);\n\twrite_reg(par, 0x3f);\n\twrite_reg(par, 0xa0);\n\twrite_reg(par, 0x45);\n\twrite_reg(par, 0xa2);\n\twrite_reg(par, 0x40);\n\twrite_reg(par, 0x75);\n\twrite_reg(par, 0x00);\n\twrite_reg(par, 0x3f);\n\twrite_reg(par, 0x15);\n\twrite_reg(par, 0x00);\n\twrite_reg(par, 0x7f);\n\twrite_reg(par, 0xa4);\n\twrite_reg(par, 0xaf);\n\n\treturn 0;\n}\n\nstatic uint8_t rgb565_to_g16(u16 pixel)\n{\n\tu16 b = pixel & 0x1f;\n\tu16 g = (pixel & (0x3f << 5)) >> 5;\n\tu16 r = (pixel & (0x1f << (5 + 6))) >> (5 + 6);\n\n\tpixel = (299 * r + 587 * g + 114 * b) / 195;\n\tif (pixel > 255)\n\t\tpixel = 255;\n\treturn (uint8_t)pixel / 16;\n}\n\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys, int xe, int ye)\n{\n\tfbtft_par_dbg(DEBUG_SET_ADDR_WIN, par,\n\t\t      \"%s(xs=%d, ys=%d, xe=%d, ye=%d)\\n\", __func__, xs, ys, xe,\n\t\t      ye);\n\n\twrite_reg(par, 0x75);\n\twrite_reg(par, 0x00);\n\twrite_reg(par, 0x3f);\n\twrite_reg(par, 0x15);\n\twrite_reg(par, 0x00);\n\twrite_reg(par, 0x7f);\n}\n\nstatic int blank(struct fbtft_par *par, bool on)\n{\n\tfbtft_par_dbg(DEBUG_BLANK, par, \"(%s=%s)\\n\",\n\t\t      __func__, on ? \"true\" : \"false\");\n\n\tif (on)\n\t\twrite_reg(par, 0xAE);\n\telse\n\t\twrite_reg(par, 0xAF);\n\treturn 0;\n}\n\n \nstatic int set_gamma(struct fbtft_par *par, u32 *curves)\n{\n\tint i;\n\n\tfbtft_par_dbg(DEBUG_INIT_DISPLAY, par, \"%s()\\n\", __func__);\n\n\tfor (i = 0; i < GAMMA_LEN; i++) {\n\t\tif (i > 0 && curves[i] < 1) {\n\t\t\tdev_err(par->info->device,\n\t\t\t\t\"Illegal value in Grayscale Lookup Table at index %d.\\n\"\n\t\t\t\t\"Must be greater than 0\\n\", i);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tif (curves[i] > 7) {\n\t\t\tdev_err(par->info->device,\n\t\t\t\t\"Illegal value(s) in Grayscale Lookup Table.\\n\"\n\t\t\t\t\"At index=%d, the accumulated value has exceeded 7\\n\",\n\t\t\t\ti);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\twrite_reg(par, 0xB8);\n\tfor (i = 0; i < 8; i++)\n\t\twrite_reg(par, (curves[i] & 0xFF));\n\treturn 0;\n}\n\nstatic int write_vmem(struct fbtft_par *par, size_t offset, size_t len)\n{\n\tu16 *vmem16 = (u16 *)par->info->screen_buffer;\n\tu8 *buf = par->txbuf.buf;\n\tu8 n1;\n\tu8 n2;\n\tint y, x;\n\tint ret;\n\n\tfor (x = 0; x < par->info->var.xres; x++) {\n\t\tif (x % 2)\n\t\t\tcontinue;\n\t\tfor (y = 0; y < par->info->var.yres; y++) {\n\t\t\tn1 = rgb565_to_g16(vmem16[y * par->info->var.xres + x]);\n\t\t\tn2 = rgb565_to_g16(vmem16\n\t\t\t\t\t   [y * par->info->var.xres + x + 1]);\n\t\t\t*buf = (n1 << 4) | n2;\n\t\t\tbuf++;\n\t\t}\n\t}\n\n\tgpiod_set_value(par->gpio.dc, 1);\n\n\t \n\tret = par->fbtftops.write(par, par->txbuf.buf,\n\t\t\t\tpar->info->var.xres * par->info->var.yres / 2);\n\tif (ret < 0)\n\t\tdev_err(par->info->device,\n\t\t\t\"%s: write failed and returned: %d\\n\", __func__, ret);\n\n\treturn ret;\n}\n\nstatic struct fbtft_display display = {\n\t.regwidth = 8,\n\t.width = WIDTH,\n\t.height = HEIGHT,\n\t.txbuflen = WIDTH * HEIGHT / 2,\n\t.gamma_num = GAMMA_NUM,\n\t.gamma_len = GAMMA_LEN,\n\t.gamma = DEFAULT_GAMMA,\n\t.fbtftops = {\n\t\t.write_vmem = write_vmem,\n\t\t.init_display = init_display,\n\t\t.set_addr_win = set_addr_win,\n\t\t.blank = blank,\n\t\t.set_gamma = set_gamma,\n\t},\n};\n\nFBTFT_REGISTER_DRIVER(DRVNAME, \"solomon,ssd1325\", &display);\n\nMODULE_ALIAS(\"spi:\" DRVNAME);\nMODULE_ALIAS(\"platform:\" DRVNAME);\nMODULE_ALIAS(\"spi:ssd1325\");\nMODULE_ALIAS(\"platform:ssd1325\");\n\nMODULE_DESCRIPTION(\"SSD1325 OLED Driver\");\nMODULE_AUTHOR(\"Alexey Mednyy\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}