{
  "module_name": "fb_hx8340bn.c",
  "hash_id": "713b2b524618b86aedea9d4a48469a635f835463acc3d6ffc4b2f4cb759af4d0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/fbtft/fb_hx8340bn.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/vmalloc.h>\n#include <linux/spi/spi.h>\n#include <linux/delay.h>\n#include <video/mipi_display.h>\n\n#include \"fbtft.h\"\n\n#define DRVNAME\t\t\"fb_hx8340bn\"\n#define WIDTH\t\t176\n#define HEIGHT\t\t220\n#define TXBUFLEN\t(4 * PAGE_SIZE)\n#define DEFAULT_GAMMA\t\"1 3 0E 5 0 2 09 0 6 1 7 1 0 2 2\\n\" \\\n\t\t\t\"3 3 17 8 4 7 05 7 6 0 3 1 6 0 0 \"\n\nstatic bool emulate;\nmodule_param(emulate, bool, 0000);\nMODULE_PARM_DESC(emulate, \"Force emulation in 9-bit mode\");\n\nstatic int init_display(struct fbtft_par *par)\n{\n\tpar->fbtftops.reset(par);\n\n\t \n\n\t \n\twrite_reg(par, 0xC1, 0xFF, 0x83, 0x40);\n\n\t \n\twrite_reg(par, 0x11);\n\tmdelay(150);\n\n\t \n\twrite_reg(par, 0xCA, 0x70, 0x00, 0xD9);\n\n\t \n\twrite_reg(par, 0xB0, 0x01, 0x11);\n\n\t \n\twrite_reg(par, 0xC9, 0x90, 0x49, 0x10, 0x28, 0x28, 0x10, 0x00, 0x06);\n\tmdelay(20);\n\n\t \n\twrite_reg(par, 0xB5, 0x35, 0x20, 0x45);\n\n\t \n\twrite_reg(par, 0xB4, 0x33, 0x25, 0x4C);\n\tmdelay(10);\n\n\t \n\twrite_reg(par, MIPI_DCS_SET_PIXEL_FORMAT, MIPI_DCS_PIXEL_FMT_16BIT);\n\n\t \n\twrite_reg(par, MIPI_DCS_SET_DISPLAY_ON);\n\tmdelay(10);\n\n\treturn 0;\n}\n\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys, int xe, int ye)\n{\n\twrite_reg(par, MIPI_DCS_SET_COLUMN_ADDRESS, 0x00, xs, 0x00, xe);\n\twrite_reg(par, MIPI_DCS_SET_PAGE_ADDRESS, 0x00, ys, 0x00, ye);\n\twrite_reg(par, MIPI_DCS_WRITE_MEMORY_START);\n}\n\nstatic int set_var(struct fbtft_par *par)\n{\n\t \n\t \n#define MY BIT(7)\n#define MX BIT(6)\n#define MV BIT(5)\n\tswitch (par->info->var.rotate) {\n\tcase 0:\n\t\twrite_reg(par, MIPI_DCS_SET_ADDRESS_MODE, par->bgr << 3);\n\t\tbreak;\n\tcase 270:\n\t\twrite_reg(par, MIPI_DCS_SET_ADDRESS_MODE,\n\t\t\t  MX | MV | (par->bgr << 3));\n\t\tbreak;\n\tcase 180:\n\t\twrite_reg(par, MIPI_DCS_SET_ADDRESS_MODE,\n\t\t\t  MX | MY | (par->bgr << 3));\n\t\tbreak;\n\tcase 90:\n\t\twrite_reg(par, MIPI_DCS_SET_ADDRESS_MODE,\n\t\t\t  MY | MV | (par->bgr << 3));\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n \n#define CURVE(num, idx)  curves[(num) * par->gamma.num_values + (idx)]\nstatic int set_gamma(struct fbtft_par *par, u32 *curves)\n{\n\tstatic const unsigned long mask[] = {\n\t\t0x0f, 0x0f, 0x1f, 0x0f, 0x0f, 0x0f, 0x1f, 0x07, 0x07, 0x07,\n\t\t0x07, 0x07, 0x07, 0x03, 0x03, 0x0f, 0x0f, 0x1f, 0x0f, 0x0f,\n\t\t0x0f, 0x1f, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x00, 0x00,\n\t};\n\tint i, j;\n\n\t \n\tfor (i = 0; i < par->gamma.num_curves; i++)\n\t\tfor (j = 0; j < par->gamma.num_values; j++)\n\t\t\tCURVE(i, j) &= mask[i * par->gamma.num_values + j];\n\n\t \n\twrite_reg(par, MIPI_DCS_SET_GAMMA_CURVE, 1 << CURVE(1, 14));\n\n\tif (CURVE(1, 14))\n\t\treturn 0;  \n\n\twrite_reg(par, 0xC2,\n\t\t  (CURVE(0, 8) << 4) | CURVE(0, 7),\n\t\t  (CURVE(0, 10) << 4) | CURVE(0, 9),\n\t\t  (CURVE(0, 12) << 4) | CURVE(0, 11),\n\t\t  CURVE(0, 2),\n\t\t  (CURVE(0, 4) << 4) | CURVE(0, 3),\n\t\t  CURVE(0, 5),\n\t\t  CURVE(0, 6),\n\t\t  (CURVE(0, 1) << 4) | CURVE(0, 0),\n\t\t  (CURVE(0, 14) << 2) | CURVE(0, 13));\n\n\twrite_reg(par, 0xC3,\n\t\t  (CURVE(1, 8) << 4) | CURVE(1, 7),\n\t\t  (CURVE(1, 10) << 4) | CURVE(1, 9),\n\t\t  (CURVE(1, 12) << 4) | CURVE(1, 11),\n\t\t  CURVE(1, 2),\n\t\t  (CURVE(1, 4) << 4) | CURVE(1, 3),\n\t\t  CURVE(1, 5),\n\t\t  CURVE(1, 6),\n\t\t  (CURVE(1, 1) << 4) | CURVE(1, 0));\n\n\tmdelay(10);\n\n\treturn 0;\n}\n\n#undef CURVE\n\nstatic struct fbtft_display display = {\n\t.regwidth = 8,\n\t.width = WIDTH,\n\t.height = HEIGHT,\n\t.txbuflen = TXBUFLEN,\n\t.gamma_num = 2,\n\t.gamma_len = 15,\n\t.gamma = DEFAULT_GAMMA,\n\t.fbtftops = {\n\t\t.init_display = init_display,\n\t\t.set_addr_win = set_addr_win,\n\t\t.set_var = set_var,\n\t\t.set_gamma = set_gamma,\n\t},\n};\n\nFBTFT_REGISTER_DRIVER(DRVNAME, \"himax,hx8340bn\", &display);\n\nMODULE_ALIAS(\"spi:\" DRVNAME);\nMODULE_ALIAS(\"platform:\" DRVNAME);\nMODULE_ALIAS(\"spi:hx8340bn\");\nMODULE_ALIAS(\"platform:hx8340bn\");\n\nMODULE_DESCRIPTION(\"FB driver for the HX8340BN LCD Controller\");\nMODULE_AUTHOR(\"Noralf Tronnes\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}