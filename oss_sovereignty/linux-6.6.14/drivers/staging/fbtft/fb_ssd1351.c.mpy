{
  "module_name": "fb_ssd1351.c",
  "hash_id": "f2366aaf307768eed54c95fa494f3e06e1d00cce4b2f4eac883f419e97937dec",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/fbtft/fb_ssd1351.c",
  "human_readable_source": "\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/spi/spi.h>\n#include <linux/delay.h>\n\n#include \"fbtft.h\"\n\n#define DRVNAME\t\t\"fb_ssd1351\"\n#define WIDTH\t\t128\n#define HEIGHT\t\t128\n#define GAMMA_NUM\t1\n#define GAMMA_LEN\t63\n#define DEFAULT_GAMMA\t\"0 2 2 2 2 2 2 2 \" \\\n\t\t\t\"2 2 2 2 2 2 2 2 \" \\\n\t\t\t\"2 2 2 2 2 2 2 2 \" \\\n\t\t\t\"2 2 2 2 2 2 2 2 \" \\\n\t\t\t\"2 2 2 2 2 2 2 2 \" \\\n\t\t\t\"2 2 2 2 2 2 2 2 \" \\\n\t\t\t\"2 2 2 2 2 2 2 2 \" \\\n\t\t\t\"2 2 2 2 2 2 2\" \\\n\nstatic void register_onboard_backlight(struct fbtft_par *par);\n\nstatic int init_display(struct fbtft_par *par)\n{\n\tif (par->pdata &&\n\t    par->pdata->display.backlight == FBTFT_ONBOARD_BACKLIGHT) {\n\t\t \n\t\tpar->fbtftops.register_backlight = register_onboard_backlight;\n\t}\n\n\tpar->fbtftops.reset(par);\n\n\twrite_reg(par, 0xfd, 0x12);  \n\twrite_reg(par, 0xfd, 0xb1);  \n\twrite_reg(par, 0xae);  \n\twrite_reg(par, 0xb3, 0xf1);  \n\twrite_reg(par, 0xca, 0x7f);  \n\twrite_reg(par, 0x15, 0x00, 0x7f);  \n\twrite_reg(par, 0x75, 0x00, 0x7f);  \n\twrite_reg(par, 0xa1, 0x00);  \n\twrite_reg(par, 0xa2, 0x00);  \n\twrite_reg(par, 0xb5, 0x00);  \n\twrite_reg(par, 0xab, 0x01);  \n\twrite_reg(par, 0xb1, 0x32);  \n\twrite_reg(par, 0xb4, 0xa0, 0xb5, 0x55);  \n\twrite_reg(par, 0xbb, 0x17);  \n\twrite_reg(par, 0xbe, 0x05);  \n\twrite_reg(par, 0xc1, 0xc8, 0x80, 0xc8);  \n\twrite_reg(par, 0xc7, 0x0f);  \n\twrite_reg(par, 0xb6, 0x01);  \n\twrite_reg(par, 0xa6);  \n\twrite_reg(par, 0xaf);  \n\n\treturn 0;\n}\n\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys, int xe, int ye)\n{\n\twrite_reg(par, 0x15, xs, xe);\n\twrite_reg(par, 0x75, ys, ye);\n\twrite_reg(par, 0x5c);\n}\n\nstatic int set_var(struct fbtft_par *par)\n{\n\tunsigned int remap;\n\n\tif (par->fbtftops.init_display != init_display) {\n\t\t \n\t\tfbtft_par_dbg(DEBUG_INIT_DISPLAY, par,\n\t\t\t      \"%s: skipping since custom init_display() is used\\n\",\n\t\t\t       __func__);\n\t\treturn 0;\n\t}\n\n\tremap = 0x60 | (par->bgr << 2);  \n\n\tswitch (par->info->var.rotate) {\n\tcase 0:\n\t\twrite_reg(par, 0xA0, remap | 0x00 | BIT(4));\n\t\tbreak;\n\tcase 270:\n\t\twrite_reg(par, 0xA0, remap | 0x03 | BIT(4));\n\t\tbreak;\n\tcase 180:\n\t\twrite_reg(par, 0xA0, remap | 0x02);\n\t\tbreak;\n\tcase 90:\n\t\twrite_reg(par, 0xA0, remap | 0x01);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int set_gamma(struct fbtft_par *par, u32 *curves)\n{\n\tunsigned long tmp[GAMMA_NUM * GAMMA_LEN];\n\tint i, acc = 0;\n\n\tfor (i = 0; i < 63; i++) {\n\t\tif (i > 0 && curves[i] < 2) {\n\t\t\tdev_err(par->info->device,\n\t\t\t\t\"Illegal value in Grayscale Lookup Table at index %d : %d. Must be greater than 1\\n\",\n\t\t\t\ti, curves[i]);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tacc += curves[i];\n\t\ttmp[i] = acc;\n\t\tif (acc > 180) {\n\t\t\tdev_err(par->info->device,\n\t\t\t\t\"Illegal value(s) in Grayscale Lookup Table. At index=%d : %d, the accumulated value has exceeded 180\\n\",\n\t\t\t\ti, acc);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\twrite_reg(par, 0xB8,\n\t\t  tmp[0],  tmp[1],  tmp[2],  tmp[3],\n\t\t  tmp[4],  tmp[5],  tmp[6],  tmp[7],\n\t\t  tmp[8],  tmp[9],  tmp[10], tmp[11],\n\t\t  tmp[12], tmp[13], tmp[14], tmp[15],\n\t\t  tmp[16], tmp[17], tmp[18], tmp[19],\n\t\t  tmp[20], tmp[21], tmp[22], tmp[23],\n\t\t  tmp[24], tmp[25], tmp[26], tmp[27],\n\t\t  tmp[28], tmp[29], tmp[30], tmp[31],\n\t\t  tmp[32], tmp[33], tmp[34], tmp[35],\n\t\t  tmp[36], tmp[37], tmp[38], tmp[39],\n\t\t  tmp[40], tmp[41], tmp[42], tmp[43],\n\t\t  tmp[44], tmp[45], tmp[46], tmp[47],\n\t\t  tmp[48], tmp[49], tmp[50], tmp[51],\n\t\t  tmp[52], tmp[53], tmp[54], tmp[55],\n\t\t  tmp[56], tmp[57], tmp[58], tmp[59],\n\t\t  tmp[60], tmp[61], tmp[62]);\n\n\treturn 0;\n}\n\nstatic int blank(struct fbtft_par *par, bool on)\n{\n\tfbtft_par_dbg(DEBUG_BLANK, par, \"(%s=%s)\\n\",\n\t\t      __func__, on ? \"true\" : \"false\");\n\tif (on)\n\t\twrite_reg(par, 0xAE);\n\telse\n\t\twrite_reg(par, 0xAF);\n\treturn 0;\n}\n\nstatic struct fbtft_display display = {\n\t.regwidth = 8,\n\t.width = WIDTH,\n\t.height = HEIGHT,\n\t.gamma_num = GAMMA_NUM,\n\t.gamma_len = GAMMA_LEN,\n\t.gamma = DEFAULT_GAMMA,\n\t.fbtftops = {\n\t\t.init_display = init_display,\n\t\t.set_addr_win = set_addr_win,\n\t\t.set_var = set_var,\n\t\t.set_gamma = set_gamma,\n\t\t.blank = blank,\n\t},\n};\n\nstatic int update_onboard_backlight(struct backlight_device *bd)\n{\n\tstruct fbtft_par *par = bl_get_data(bd);\n\tbool on;\n\n\tfbtft_par_dbg(DEBUG_BACKLIGHT, par,\n\t\t      \"%s: power=%d, fb_blank=%d\\n\",\n\t\t      __func__, bd->props.power, bd->props.fb_blank);\n\n\ton = !backlight_is_blank(bd);\n\t \n\twrite_reg(par, 0xB5, on ? 0x03 : 0x02);\n\n\treturn 0;\n}\n\nstatic const struct backlight_ops bl_ops = {\n\t.update_status = update_onboard_backlight,\n};\n\nstatic void register_onboard_backlight(struct fbtft_par *par)\n{\n\tstruct backlight_device *bd;\n\tstruct backlight_properties bl_props = { 0, };\n\n\tbl_props.type = BACKLIGHT_RAW;\n\tbl_props.power = FB_BLANK_POWERDOWN;\n\n\tbd = backlight_device_register(dev_driver_string(par->info->device),\n\t\t\t\t       par->info->device, par, &bl_ops,\n\t\t\t\t       &bl_props);\n\tif (IS_ERR(bd)) {\n\t\tdev_err(par->info->device,\n\t\t\t\"cannot register backlight device (%ld)\\n\",\n\t\t\tPTR_ERR(bd));\n\t\treturn;\n\t}\n\tpar->info->bl_dev = bd;\n\n\tif (!par->fbtftops.unregister_backlight)\n\t\tpar->fbtftops.unregister_backlight = fbtft_unregister_backlight;\n}\n\nFBTFT_REGISTER_DRIVER(DRVNAME, \"solomon,ssd1351\", &display);\n\nMODULE_ALIAS(\"spi:\" DRVNAME);\nMODULE_ALIAS(\"platform:\" DRVNAME);\nMODULE_ALIAS(\"spi:ssd1351\");\nMODULE_ALIAS(\"platform:ssd1351\");\n\nMODULE_DESCRIPTION(\"SSD1351 OLED Driver\");\nMODULE_AUTHOR(\"James Davies\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}