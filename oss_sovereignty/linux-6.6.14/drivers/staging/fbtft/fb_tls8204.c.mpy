{
  "module_name": "fb_tls8204.c",
  "hash_id": "38e0cf9a1093e0556da76e9706e8d4bc45f91f8ff71ae6c810e3779729328ea3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/fbtft/fb_tls8204.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/gpio/consumer.h>\n#include <linux/spi/spi.h>\n#include <linux/delay.h>\n\n#include \"fbtft.h\"\n\n#define DRVNAME\t\t\"fb_tls8204\"\n#define WIDTH\t\t84\n#define HEIGHT\t\t48\n#define TXBUFLEN\tWIDTH\n\n \n#define DEFAULT_GAMMA\t\"40\"\n\nstatic unsigned int bs = 4;\nmodule_param(bs, uint, 0000);\nMODULE_PARM_DESC(bs, \"BS[2:0] Bias voltage level: 0-7 (default: 4)\");\n\nstatic int init_display(struct fbtft_par *par)\n{\n\tpar->fbtftops.reset(par);\n\n\t \n\twrite_reg(par, 0x21);\t \n\n\t \n\twrite_reg(par, 0x10 | (bs & 0x7));\n\t\t\t\t \n\n\t \n\twrite_reg(par, 0x04 | (64 >> 6));\n\twrite_reg(par, 0x40 | (64 & 0x3F));\n\n\t \n\twrite_reg(par, 0x20);\n\n\t \n\twrite_reg(par, 0x08 | 4);\n\t\t\t\t \n\n\treturn 0;\n}\n\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys, int xe, int ye)\n{\n\t \n\twrite_reg(par, 0x80);\t \n\n\t \n\twrite_reg(par, 0x40);\t \n}\n\nstatic int write_vmem(struct fbtft_par *par, size_t offset, size_t len)\n{\n\tu16 *vmem16 = (u16 *)par->info->screen_buffer;\n\tint x, y, i;\n\tint ret = 0;\n\n\tfor (y = 0; y < HEIGHT / 8; y++) {\n\t\tu8 *buf = par->txbuf.buf;\n\t\t \n\t\tgpiod_set_value(par->gpio.dc, 0);\n\t\twrite_reg(par, 0x80 | 0);\n\t\twrite_reg(par, 0x40 | y);\n\n\t\tfor (x = 0; x < WIDTH; x++) {\n\t\t\tu8 ch = 0;\n\n\t\t\tfor (i = 0; i < 8 * WIDTH; i += WIDTH) {\n\t\t\t\tch >>= 1;\n\t\t\t\tif (vmem16[(y * 8 * WIDTH) + i + x])\n\t\t\t\t\tch |= 0x80;\n\t\t\t}\n\t\t\t*buf++ = ch;\n\t\t}\n\t\t \n\t\tgpiod_set_value(par->gpio.dc, 1);\n\t\tret = par->fbtftops.write(par, par->txbuf.buf, WIDTH);\n\t\tif (ret < 0) {\n\t\t\tdev_err(par->info->device,\n\t\t\t\t\"write failed and returned: %d\\n\", ret);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic int set_gamma(struct fbtft_par *par, u32 *curves)\n{\n\t \n\tcurves[0] &= 0x7F;\n\n\twrite_reg(par, 0x21);  \n\twrite_reg(par, 0x80 | curves[0]);\n\twrite_reg(par, 0x20);  \n\n\treturn 0;\n}\n\nstatic struct fbtft_display display = {\n\t.regwidth = 8,\n\t.width = WIDTH,\n\t.height = HEIGHT,\n\t.txbuflen = TXBUFLEN,\n\t.gamma_num = 1,\n\t.gamma_len = 1,\n\t.gamma = DEFAULT_GAMMA,\n\t.fbtftops = {\n\t\t.init_display = init_display,\n\t\t.set_addr_win = set_addr_win,\n\t\t.write_vmem = write_vmem,\n\t\t.set_gamma = set_gamma,\n\t},\n\t.backlight = 1,\n};\n\nFBTFT_REGISTER_DRIVER(DRVNAME, \"teralane,tls8204\", &display);\n\nMODULE_ALIAS(\"spi:\" DRVNAME);\nMODULE_ALIAS(\"spi:tls8204\");\n\nMODULE_DESCRIPTION(\"FB driver for the TLS8204 LCD Controller\");\nMODULE_AUTHOR(\"Michael Hope\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}