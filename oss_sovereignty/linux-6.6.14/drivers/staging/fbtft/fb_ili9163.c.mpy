{
  "module_name": "fb_ili9163.c",
  "hash_id": "52292aa233a31de4a430e85dd0620bcccec6229ce96087045a64ba1ac3d1d66f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/fbtft/fb_ili9163.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n#include <video/mipi_display.h>\n\n#include \"fbtft.h\"\n\n#define DRVNAME\t\t\"fb_ili9163\"\n#define WIDTH\t\t128\n#define HEIGHT\t\t128\n#define BPP\t\t16\n#define FPS\t\t30\n\n#ifdef GAMMA_ADJ\n#define GAMMA_LEN\t15\n#define GAMMA_NUM\t1\n#define DEFAULT_GAMMA\t\"36 29 12 22 1C 15 42 B7 2F 13 12 0A 11 0B 06\\n\"\n#endif\n\n \n#define CMD_FRMCTR1\t0xB1  \n\t\t\t      \n#define CMD_FRMCTR2\t0xB2  \n#define CMD_FRMCTR3\t0xB3  \n\t\t\t      \n#define CMD_DINVCTR\t0xB4  \n#define CMD_RGBBLK\t0xB5  \n#define CMD_DFUNCTR\t0xB6  \n#define CMD_SDRVDIR\t0xB7  \n#define CMD_GDRVDIR\t0xB8  \n\n#define CMD_PWCTR1\t0xC0  \n#define CMD_PWCTR2\t0xC1  \n#define CMD_PWCTR3\t0xC2  \n#define CMD_PWCTR4\t0xC3  \n#define CMD_PWCTR5\t0xC4  \n#define CMD_VCOMCTR1\t0xC5  \n#define CMD_VCOMCTR2\t0xC6  \n#define CMD_VCOMOFFS\t0xC7  \n#define CMD_PGAMMAC\t0xE0  \n#define CMD_NGAMMAC\t0xE1  \n#define CMD_GAMRSEL\t0xF2  \n\n \n\n#ifdef RED\n#define __OFFSET\t\t32  \n#else\n#define __OFFSET\t\t0   \n#endif\n\nstatic int init_display(struct fbtft_par *par)\n{\n\tpar->fbtftops.reset(par);\n\n\twrite_reg(par, MIPI_DCS_SOFT_RESET);  \n\tmdelay(500);\n\twrite_reg(par, MIPI_DCS_EXIT_SLEEP_MODE);  \n\tmdelay(5);\n\twrite_reg(par, MIPI_DCS_SET_PIXEL_FORMAT, MIPI_DCS_PIXEL_FMT_16BIT);\n\t \n\twrite_reg(par, MIPI_DCS_SET_GAMMA_CURVE, 0x02);\n#ifdef GAMMA_ADJ\n\twrite_reg(par, CMD_GAMRSEL, 0x01);  \n#endif\n\twrite_reg(par, MIPI_DCS_ENTER_NORMAL_MODE);\n\twrite_reg(par, CMD_DFUNCTR, 0xff, 0x06);\n\t \n\twrite_reg(par, CMD_FRMCTR1, 0x08, 0x02);\n\twrite_reg(par, CMD_DINVCTR, 0x07);  \n\t \n\twrite_reg(par, CMD_PWCTR1, 0x0A, 0x02);\n\t \n\twrite_reg(par, CMD_PWCTR2, 0x02);\n\t \n\twrite_reg(par, CMD_VCOMCTR1, 0x50, 0x63);\n\twrite_reg(par, CMD_VCOMOFFS, 0);\n\n\twrite_reg(par, MIPI_DCS_SET_COLUMN_ADDRESS, 0, 0, 0, WIDTH);\n\twrite_reg(par, MIPI_DCS_SET_PAGE_ADDRESS, 0, 0, 0, HEIGHT);\n\n\twrite_reg(par, MIPI_DCS_SET_DISPLAY_ON);  \n\twrite_reg(par, MIPI_DCS_WRITE_MEMORY_START);  \n\n\treturn 0;\n}\n\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys,\n\t\t\t int xe, int ye)\n{\n\tswitch (par->info->var.rotate) {\n\tcase 0:\n\t\twrite_reg(par, MIPI_DCS_SET_COLUMN_ADDRESS,\n\t\t\t  xs >> 8, xs & 0xff, xe >> 8, xe & 0xff);\n\t\twrite_reg(par, MIPI_DCS_SET_PAGE_ADDRESS,\n\t\t\t  (ys + __OFFSET) >> 8, (ys + __OFFSET) & 0xff,\n\t\t\t  (ye + __OFFSET) >> 8, (ye + __OFFSET) & 0xff);\n\t\tbreak;\n\tcase 90:\n\t\twrite_reg(par, MIPI_DCS_SET_COLUMN_ADDRESS,\n\t\t\t  (xs + __OFFSET) >> 8, (xs + __OFFSET) & 0xff,\n\t\t\t  (xe + __OFFSET) >> 8, (xe + __OFFSET) & 0xff);\n\t\twrite_reg(par, MIPI_DCS_SET_PAGE_ADDRESS,\n\t\t\t  ys >> 8, ys & 0xff, ye >> 8, ye & 0xff);\n\t\tbreak;\n\tcase 180:\n\tcase 270:\n\t\twrite_reg(par, MIPI_DCS_SET_COLUMN_ADDRESS,\n\t\t\t  xs >> 8, xs & 0xff, xe >> 8, xe & 0xff);\n\t\twrite_reg(par, MIPI_DCS_SET_PAGE_ADDRESS,\n\t\t\t  ys >> 8, ys & 0xff, ye >> 8, ye & 0xff);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tpar->info->var.rotate = 0;\n\t}\n\twrite_reg(par, MIPI_DCS_WRITE_MEMORY_START);\n}\n\n \nstatic int set_var(struct fbtft_par *par)\n{\n\tu8 mactrl_data = 0;  \n\n\tswitch (par->info->var.rotate) {\n\tcase 0:\n\t\tmactrl_data = 0x08;\n\t\tbreak;\n\tcase 180:\n\t\tmactrl_data = 0xC8;\n\t\tbreak;\n\tcase 270:\n\t\tmactrl_data = 0xA8;\n\t\tbreak;\n\tcase 90:\n\t\tmactrl_data = 0x68;\n\t\tbreak;\n\t}\n\n\t \n\tif (par->bgr)\n\t\tmactrl_data |= BIT(2);\n\twrite_reg(par, MIPI_DCS_SET_ADDRESS_MODE, mactrl_data);\n\twrite_reg(par, MIPI_DCS_WRITE_MEMORY_START);\n\treturn 0;\n}\n\n#ifdef GAMMA_ADJ\n#define CURVE(num, idx)  curves[(num) * par->gamma.num_values + (idx)]\nstatic int gamma_adj(struct fbtft_par *par, u32 *curves)\n{\n\tstatic const unsigned long mask[] = {\n\t\t0x3F, 0x3F, 0x3F, 0x3F, 0x3F,\n\t\t0x1f, 0x3f, 0x0f, 0x0f, 0x7f, 0x1f,\n\t\t0x3F, 0x3F, 0x3F, 0x3F, 0x3F};\n\tint i, j;\n\n\tfor (i = 0; i < GAMMA_NUM; i++)\n\t\tfor (j = 0; j < GAMMA_LEN; j++)\n\t\t\tCURVE(i, j) &= mask[i * par->gamma.num_values + j];\n\n\twrite_reg(par, CMD_PGAMMAC,\n\t\t  CURVE(0, 0),\n\t\t  CURVE(0, 1),\n\t\t  CURVE(0, 2),\n\t\t  CURVE(0, 3),\n\t\t  CURVE(0, 4),\n\t\t  CURVE(0, 5),\n\t\t  CURVE(0, 6),\n\t\t  (CURVE(0, 7) << 4) | CURVE(0, 8),\n\t\t  CURVE(0, 9),\n\t\t  CURVE(0, 10),\n\t\t  CURVE(0, 11),\n\t\t  CURVE(0, 12),\n\t\t  CURVE(0, 13),\n\t\t  CURVE(0, 14),\n\t\t  CURVE(0, 15));\n\n\t \n\twrite_reg(par, MIPI_DCS_WRITE_MEMORY_START);\n\n\treturn 0;\n}\n\n#undef CURVE\n#endif\n\nstatic struct fbtft_display display = {\n\t.regwidth = 8,\n\t.width = WIDTH,\n\t.height = HEIGHT,\n\t.bpp = BPP,\n\t.fps = FPS,\n#ifdef GAMMA_ADJ\n\t.gamma_num = GAMMA_NUM,\n\t.gamma_len = GAMMA_LEN,\n\t.gamma = DEFAULT_GAMMA,\n#endif\n\t.fbtftops = {\n\t\t.init_display = init_display,\n\t\t.set_addr_win = set_addr_win,\n\t\t.set_var = set_var,\n#ifdef GAMMA_ADJ\n\t\t.set_gamma = gamma_adj,\n#endif\n\t},\n};\n\nFBTFT_REGISTER_DRIVER(DRVNAME, \"ilitek,ili9163\", &display);\n\nMODULE_ALIAS(\"spi:\" DRVNAME);\nMODULE_ALIAS(\"platform:\" DRVNAME);\nMODULE_ALIAS(\"spi:ili9163\");\nMODULE_ALIAS(\"platform:ili9163\");\n\nMODULE_DESCRIPTION(\"FB driver for the ILI9163 LCD Controller\");\nMODULE_AUTHOR(\"Kozhevnikov Anatoly\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}