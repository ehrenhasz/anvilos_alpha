{
  "module_name": "fb_ili9341.c",
  "hash_id": "a234b4c2c06da497b447a36fae666befa54cc0530bb85670044c8277568c4a3d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/fbtft/fb_ili9341.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n#include <video/mipi_display.h>\n\n#include \"fbtft.h\"\n\n#define DRVNAME\t\t\"fb_ili9341\"\n#define WIDTH\t\t240\n#define HEIGHT\t\t320\n#define TXBUFLEN\t(4 * PAGE_SIZE)\n#define DEFAULT_GAMMA\t\"1F 1A 18 0A 0F 06 45 87 32 0A 07 02 07 05 00\\n\" \\\n\t\t\t\"00 25 27 05 10 09 3A 78 4D 05 18 0D 38 3A 1F\"\n\nstatic int init_display(struct fbtft_par *par)\n{\n\tpar->fbtftops.reset(par);\n\n\t \n\twrite_reg(par, MIPI_DCS_SOFT_RESET);\n\tmdelay(5);\n\twrite_reg(par, MIPI_DCS_SET_DISPLAY_OFF);\n\t \n\twrite_reg(par, 0xCF, 0x00, 0x83, 0x30);\n\twrite_reg(par, 0xED, 0x64, 0x03, 0x12, 0x81);\n\twrite_reg(par, 0xE8, 0x85, 0x01, 0x79);\n\twrite_reg(par, 0xCB, 0x39, 0X2C, 0x00, 0x34, 0x02);\n\twrite_reg(par, 0xF7, 0x20);\n\twrite_reg(par, 0xEA, 0x00, 0x00);\n\t \n\twrite_reg(par, 0xC0, 0x26);\n\twrite_reg(par, 0xC1, 0x11);\n\t \n\twrite_reg(par, 0xC5, 0x35, 0x3E);\n\twrite_reg(par, 0xC7, 0xBE);\n\t \n\twrite_reg(par, MIPI_DCS_SET_PIXEL_FORMAT, 0x55);  \n\t \n\twrite_reg(par, 0xB1, 0x00, 0x1B);\n\t \n\t   \n\twrite_reg(par, MIPI_DCS_SET_GAMMA_CURVE, 0x01);\n\t \n\twrite_reg(par, 0xB7, 0x07);  \n\twrite_reg(par, 0xB6, 0x0A, 0x82, 0x27, 0x00);\n\twrite_reg(par, MIPI_DCS_EXIT_SLEEP_MODE);\n\tmdelay(100);\n\twrite_reg(par, MIPI_DCS_SET_DISPLAY_ON);\n\tmdelay(20);\n\n\treturn 0;\n}\n\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys, int xe, int ye)\n{\n\twrite_reg(par, MIPI_DCS_SET_COLUMN_ADDRESS,\n\t\t  (xs >> 8) & 0xFF, xs & 0xFF, (xe >> 8) & 0xFF, xe & 0xFF);\n\n\twrite_reg(par, MIPI_DCS_SET_PAGE_ADDRESS,\n\t\t  (ys >> 8) & 0xFF, ys & 0xFF, (ye >> 8) & 0xFF, ye & 0xFF);\n\n\twrite_reg(par, MIPI_DCS_WRITE_MEMORY_START);\n}\n\n#define MEM_Y   BIT(7)  \n#define MEM_X   BIT(6)  \n#define MEM_V   BIT(5)  \n#define MEM_L   BIT(4)  \n#define MEM_H   BIT(2)  \n#define MEM_BGR (3)  \nstatic int set_var(struct fbtft_par *par)\n{\n\tswitch (par->info->var.rotate) {\n\tcase 0:\n\t\twrite_reg(par, MIPI_DCS_SET_ADDRESS_MODE,\n\t\t\t  MEM_X | (par->bgr << MEM_BGR));\n\t\tbreak;\n\tcase 270:\n\t\twrite_reg(par, MIPI_DCS_SET_ADDRESS_MODE,\n\t\t\t  MEM_V | MEM_L | (par->bgr << MEM_BGR));\n\t\tbreak;\n\tcase 180:\n\t\twrite_reg(par, MIPI_DCS_SET_ADDRESS_MODE,\n\t\t\t  MEM_Y | (par->bgr << MEM_BGR));\n\t\tbreak;\n\tcase 90:\n\t\twrite_reg(par, MIPI_DCS_SET_ADDRESS_MODE,\n\t\t\t  MEM_Y | MEM_X | MEM_V | (par->bgr << MEM_BGR));\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n \n#define CURVE(num, idx)  curves[(num) * par->gamma.num_values + (idx)]\nstatic int set_gamma(struct fbtft_par *par, u32 *curves)\n{\n\tint i;\n\n\tfor (i = 0; i < par->gamma.num_curves; i++)\n\t\twrite_reg(par, 0xE0 + i,\n\t\t\t  CURVE(i, 0), CURVE(i, 1), CURVE(i, 2),\n\t\t\t  CURVE(i, 3), CURVE(i, 4), CURVE(i, 5),\n\t\t\t  CURVE(i, 6), CURVE(i, 7), CURVE(i, 8),\n\t\t\t  CURVE(i, 9), CURVE(i, 10), CURVE(i, 11),\n\t\t\t  CURVE(i, 12), CURVE(i, 13), CURVE(i, 14));\n\n\treturn 0;\n}\n\n#undef CURVE\n\nstatic struct fbtft_display display = {\n\t.regwidth = 8,\n\t.width = WIDTH,\n\t.height = HEIGHT,\n\t.txbuflen = TXBUFLEN,\n\t.gamma_num = 2,\n\t.gamma_len = 15,\n\t.gamma = DEFAULT_GAMMA,\n\t.fbtftops = {\n\t\t.init_display = init_display,\n\t\t.set_addr_win = set_addr_win,\n\t\t.set_var = set_var,\n\t\t.set_gamma = set_gamma,\n\t},\n};\n\nFBTFT_REGISTER_SPI_DRIVER(DRVNAME, \"ilitek\", \"ili9341\", &display);\n\nMODULE_ALIAS(\"spi:\" DRVNAME);\nMODULE_ALIAS(\"platform:\" DRVNAME);\nMODULE_ALIAS(\"spi:ili9341\");\nMODULE_ALIAS(\"platform:ili9341\");\n\nMODULE_DESCRIPTION(\"FB driver for the ILI9341 LCD display controller\");\nMODULE_AUTHOR(\"Christian Vogelgsang\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}