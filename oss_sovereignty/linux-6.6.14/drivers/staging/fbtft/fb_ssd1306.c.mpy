{
  "module_name": "fb_ssd1306.c",
  "hash_id": "a8ee2d726097a003f80b7cc8fc848bd209e3edc5e028b20bc9785b830ff3b048",
  "original_prompt": "Ingested from linux-6.6.14/drivers/staging/fbtft/fb_ssd1306.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/gpio/consumer.h>\n#include <linux/delay.h>\n\n#include \"fbtft.h\"\n\n#define DRVNAME\t\t\"fb_ssd1306\"\n#define WIDTH\t\t128\n#define HEIGHT\t\t64\n\n \n\n \nstatic int init_display(struct fbtft_par *par)\n{\n\tpar->fbtftops.reset(par);\n\n\tif (par->gamma.curves[0] == 0) {\n\t\tmutex_lock(&par->gamma.lock);\n\t\tif (par->info->var.yres == 64)\n\t\t\tpar->gamma.curves[0] = 0xCF;\n\t\telse\n\t\t\tpar->gamma.curves[0] = 0x8F;\n\t\tmutex_unlock(&par->gamma.lock);\n\t}\n\n\t \n\twrite_reg(par, 0xAE);\n\n\t \n\twrite_reg(par, 0xD5);\n\twrite_reg(par, 0x80);\n\n\t \n\twrite_reg(par, 0xA8);\n\tif (par->info->var.yres == 64)\n\t\twrite_reg(par, 0x3F);\n\telse if (par->info->var.yres == 48)\n\t\twrite_reg(par, 0x2F);\n\telse\n\t\twrite_reg(par, 0x1F);\n\n\t \n\twrite_reg(par, 0xD3);\n\twrite_reg(par, 0x0);\n\n\t \n\twrite_reg(par, 0x40 | 0x0);\n\n\t \n\twrite_reg(par, 0x8D);\n\t \n\twrite_reg(par, 0x14);\n\n\t \n\twrite_reg(par, 0x20);\n\t \n\twrite_reg(par, 0x01);\n\n\t \n\t \n\twrite_reg(par, 0xA0 | 0x1);\n\n\t \n\t \n\twrite_reg(par, 0xC8);\n\n\t \n\twrite_reg(par, 0xDA);\n\tif (par->info->var.yres == 64)\n\t\t \n\t\twrite_reg(par, 0x12);\n\telse if (par->info->var.yres == 48)\n\t\t \n\t\twrite_reg(par, 0x12);\n\telse\n\t\t \n\t\twrite_reg(par, 0x02);\n\n\t \n\twrite_reg(par, 0xD9);\n\twrite_reg(par, 0xF1);\n\n\t \n\twrite_reg(par, 0xDB);\n\t \n\twrite_reg(par, 0x40);\n\n\t \n\t \n\twrite_reg(par, 0xA4);\n\n\t \n\twrite_reg(par, 0xA6);\n\n\t \n\twrite_reg(par, 0xAF);\n\n\treturn 0;\n}\n\nstatic void set_addr_win_64x48(struct fbtft_par *par)\n{\n\t \n\twrite_reg(par, 0x21);\n\twrite_reg(par, 0x20);\n\twrite_reg(par, 0x5F);\n\n\t \n\twrite_reg(par, 0x22);\n\twrite_reg(par, 0x0);\n\twrite_reg(par, 0x5);\n}\n\nstatic void set_addr_win(struct fbtft_par *par, int xs, int ys, int xe, int ye)\n{\n\t \n\twrite_reg(par, 0x00 | 0x0);\n\t \n\twrite_reg(par, 0x10 | 0x0);\n\t \n\twrite_reg(par, 0x40 | 0x0);\n\n\tif (par->info->var.xres == 64 && par->info->var.yres == 48)\n\t\tset_addr_win_64x48(par);\n}\n\nstatic int blank(struct fbtft_par *par, bool on)\n{\n\tfbtft_par_dbg(DEBUG_BLANK, par, \"(%s=%s)\\n\",\n\t\t      __func__, on ? \"true\" : \"false\");\n\n\tif (on)\n\t\twrite_reg(par, 0xAE);\n\telse\n\t\twrite_reg(par, 0xAF);\n\treturn 0;\n}\n\n \nstatic int set_gamma(struct fbtft_par *par, u32 *curves)\n{\n\t \n\tcurves[0] &= 0xFF;\n\n\t \n\twrite_reg(par, 0x81);\n\twrite_reg(par, curves[0]);\n\n\treturn 0;\n}\n\nstatic int write_vmem(struct fbtft_par *par, size_t offset, size_t len)\n{\n\tu16 *vmem16 = (u16 *)par->info->screen_buffer;\n\tu32 xres = par->info->var.xres;\n\tu32 yres = par->info->var.yres;\n\tu8 *buf = par->txbuf.buf;\n\tint x, y, i;\n\tint ret = 0;\n\n\tfor (x = 0; x < xres; x++) {\n\t\tfor (y = 0; y < yres / 8; y++) {\n\t\t\t*buf = 0x00;\n\t\t\tfor (i = 0; i < 8; i++)\n\t\t\t\tif (vmem16[(y * 8 + i) * xres + x])\n\t\t\t\t\t*buf |= BIT(i);\n\t\t\tbuf++;\n\t\t}\n\t}\n\n\t \n\tgpiod_set_value(par->gpio.dc, 1);\n\tret = par->fbtftops.write(par, par->txbuf.buf, xres * yres / 8);\n\tif (ret < 0)\n\t\tdev_err(par->info->device, \"write failed and returned: %d\\n\",\n\t\t\tret);\n\n\treturn ret;\n}\n\nstatic struct fbtft_display display = {\n\t.regwidth = 8,\n\t.width = WIDTH,\n\t.height = HEIGHT,\n\t.gamma_num = 1,\n\t.gamma_len = 1,\n\t.gamma = \"00\",\n\t.fbtftops = {\n\t\t.write_vmem = write_vmem,\n\t\t.init_display = init_display,\n\t\t.set_addr_win = set_addr_win,\n\t\t.blank = blank,\n\t\t.set_gamma = set_gamma,\n\t},\n};\n\nFBTFT_REGISTER_DRIVER(DRVNAME, \"solomon,ssd1306\", &display);\n\nMODULE_ALIAS(\"spi:\" DRVNAME);\nMODULE_ALIAS(\"platform:\" DRVNAME);\nMODULE_ALIAS(\"spi:ssd1306\");\nMODULE_ALIAS(\"platform:ssd1306\");\n\nMODULE_DESCRIPTION(\"SSD1306 OLED Driver\");\nMODULE_AUTHOR(\"Noralf Tronnes\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}