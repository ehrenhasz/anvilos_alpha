{
  "module_name": "sierra_ms.c",
  "hash_id": "ac154c03b0fa5adfe9bdd0c69f496579b38139977c0b576544d0a4b0102bfd73",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/storage/sierra_ms.c",
  "human_readable_source": "\n#include <scsi/scsi.h>\n#include <scsi/scsi_host.h>\n#include <scsi/scsi_cmnd.h>\n#include <scsi/scsi_device.h>\n#include <linux/usb.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n\n#include \"usb.h\"\n#include \"transport.h\"\n#include \"protocol.h\"\n#include \"scsiglue.h\"\n#include \"sierra_ms.h\"\n#include \"debug.h\"\n\n#define SWIMS_USB_REQUEST_SetSwocMode\t0x0B\n#define SWIMS_USB_REQUEST_GetSwocInfo\t0x0A\n#define SWIMS_USB_INDEX_SetMode\t\t0x0000\n#define SWIMS_SET_MODE_Modem\t\t0x0001\n\n#define TRU_NORMAL \t\t\t0x01\n#define TRU_FORCE_MS \t\t\t0x02\n#define TRU_FORCE_MODEM \t\t0x03\n\nstatic unsigned int swi_tru_install = 1;\nmodule_param(swi_tru_install, uint, S_IRUGO | S_IWUSR);\nMODULE_PARM_DESC(swi_tru_install, \"TRU-Install mode (1=Full Logic (def),\"\n\t\t \" 2=Force CD-Rom, 3=Force Modem)\");\n\nstruct swoc_info {\n\t__u8 rev;\n\t__u8 reserved[8];\n\t__u16 LinuxSKU;\n\t__u16 LinuxVer;\n\t__u8 reserved2[47];\n} __attribute__((__packed__));\n\nstatic bool containsFullLinuxPackage(struct swoc_info *swocInfo)\n{\n\tif ((swocInfo->LinuxSKU >= 0x2100 && swocInfo->LinuxSKU <= 0x2FFF) ||\n\t   (swocInfo->LinuxSKU >= 0x7100 && swocInfo->LinuxSKU <= 0x7FFF))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nstatic int sierra_set_ms_mode(struct usb_device *udev, __u16 eSWocMode)\n{\n\tint result;\n\tdev_dbg(&udev->dev, \"SWIMS: %s\", \"DEVICE MODE SWITCH\\n\");\n\tresult = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\n\t\t\tSWIMS_USB_REQUEST_SetSwocMode,\t \n\t\t\tUSB_TYPE_VENDOR | USB_DIR_OUT,\t \n\t\t\teSWocMode,\t\t\t \n\t\t\t0x0000,\t\t\t\t \n\t\t\tNULL,\t\t\t\t \n\t\t\t0,\t\t\t\t \n\t\t\tUSB_CTRL_SET_TIMEOUT);\t\t \n\treturn result;\n}\n\n\nstatic int sierra_get_swoc_info(struct usb_device *udev,\n\t\t\t\tstruct swoc_info *swocInfo)\n{\n\tint result;\n\n\tdev_dbg(&udev->dev, \"SWIMS: Attempting to get TRU-Install info\\n\");\n\n\tresult = usb_control_msg(udev, usb_rcvctrlpipe(udev, 0),\n\t\t\tSWIMS_USB_REQUEST_GetSwocInfo,\t \n\t\t\tUSB_TYPE_VENDOR | USB_DIR_IN,\t \n\t\t\t0,\t\t\t\t \n\t\t\t0,\t\t\t\t \n\t\t\t(void *) swocInfo,\t\t \n\t\t\tsizeof(struct swoc_info),\t \n\t\t\tUSB_CTRL_SET_TIMEOUT);\t\t \n\n\tswocInfo->LinuxSKU = le16_to_cpu(swocInfo->LinuxSKU);\n\tswocInfo->LinuxVer = le16_to_cpu(swocInfo->LinuxVer);\n\treturn result;\n}\n\nstatic void debug_swoc(const struct device *dev, struct swoc_info *swocInfo)\n{\n\tdev_dbg(dev, \"SWIMS: SWoC Rev: %02d\\n\", swocInfo->rev);\n\tdev_dbg(dev, \"SWIMS: Linux SKU: %04X\\n\", swocInfo->LinuxSKU);\n\tdev_dbg(dev, \"SWIMS: Linux Version: %04X\\n\", swocInfo->LinuxVer);\n}\n\n\nstatic ssize_t truinst_show(struct device *dev, struct device_attribute *attr,\n\t\t\tchar *buf)\n{\n\tstruct swoc_info *swocInfo;\n\tstruct usb_interface *intf = to_usb_interface(dev);\n\tstruct usb_device *udev = interface_to_usbdev(intf);\n\tint result;\n\tif (swi_tru_install == TRU_FORCE_MS) {\n\t\tresult = snprintf(buf, PAGE_SIZE, \"Forced Mass Storage\\n\");\n\t} else {\n\t\tswocInfo = kmalloc(sizeof(struct swoc_info), GFP_KERNEL);\n\t\tif (!swocInfo) {\n\t\t\tsnprintf(buf, PAGE_SIZE, \"Error\\n\");\n\t\t\treturn -ENOMEM;\n\t\t}\n\t\tresult = sierra_get_swoc_info(udev, swocInfo);\n\t\tif (result < 0) {\n\t\t\tdev_dbg(dev, \"SWIMS: failed SWoC query\\n\");\n\t\t\tkfree(swocInfo);\n\t\t\tsnprintf(buf, PAGE_SIZE, \"Error\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t\tdebug_swoc(dev, swocInfo);\n\t\tresult = snprintf(buf, PAGE_SIZE,\n\t\t\t\"REV=%02d SKU=%04X VER=%04X\\n\",\n\t\t\tswocInfo->rev,\n\t\t\tswocInfo->LinuxSKU,\n\t\t\tswocInfo->LinuxVer);\n\t\tkfree(swocInfo);\n\t}\n\treturn result;\n}\nstatic DEVICE_ATTR_RO(truinst);\n\nint sierra_ms_init(struct us_data *us)\n{\n\tint result, retries;\n\tstruct swoc_info *swocInfo;\n\tstruct usb_device *udev;\n\n\tudev = us->pusb_dev;\n\n\t \n\tif (swi_tru_install == TRU_FORCE_MODEM) {\n\t\tusb_stor_dbg(us, \"SWIMS: Forcing Modem Mode\\n\");\n\t\tresult = sierra_set_ms_mode(udev, SWIMS_SET_MODE_Modem);\n\t\tif (result < 0)\n\t\t\tusb_stor_dbg(us, \"SWIMS: Failed to switch to modem mode\\n\");\n\t\treturn -EIO;\n\t}\n\t \n\telse if (swi_tru_install == TRU_FORCE_MS) {\n\t\tusb_stor_dbg(us, \"SWIMS: Forcing Mass Storage Mode\\n\");\n\t\tgoto complete;\n\t}\n\t \n\telse {\n\t\tusb_stor_dbg(us, \"SWIMS: Normal SWoC Logic\\n\");\n\n\t\tswocInfo = kmalloc(sizeof(struct swoc_info),\n\t\t\t\tGFP_KERNEL);\n\t\tif (!swocInfo)\n\t\t\treturn -ENOMEM;\n\n\t\tretries = 3;\n\t\tdo {\n\t\t\tretries--;\n\t\t\tresult = sierra_get_swoc_info(udev, swocInfo);\n\t\t\tif (result < 0) {\n\t\t\t\tusb_stor_dbg(us, \"SWIMS: Failed SWoC query\\n\");\n\t\t\t\tschedule_timeout_uninterruptible(2*HZ);\n\t\t\t}\n\t\t} while (retries && result < 0);\n\n\t\tif (result < 0) {\n\t\t\tusb_stor_dbg(us, \"SWIMS: Completely failed SWoC query\\n\");\n\t\t\tkfree(swocInfo);\n\t\t\treturn -EIO;\n\t\t}\n\n\t\tdebug_swoc(&us->pusb_dev->dev, swocInfo);\n\n\t\t \n\t\tif (!containsFullLinuxPackage(swocInfo)) {\n\t\t\tusb_stor_dbg(us, \"SWIMS: Switching to Modem Mode\\n\");\n\t\t\tresult = sierra_set_ms_mode(udev,\n\t\t\t\tSWIMS_SET_MODE_Modem);\n\t\t\tif (result < 0)\n\t\t\t\tusb_stor_dbg(us, \"SWIMS: Failed to switch modem\\n\");\n\t\t\tkfree(swocInfo);\n\t\t\treturn -EIO;\n\t\t}\n\t\tkfree(swocInfo);\n\t}\ncomplete:\n\treturn device_create_file(&us->pusb_intf->dev, &dev_attr_truinst);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}