{
  "module_name": "usbip_common.h",
  "hash_id": "470a2e34182ad5860c5cc2540c755a617c7e7544fd21ef6c9f41b07947d1cea6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/usbip/usbip_common.h",
  "human_readable_source": "\n \n\n#ifndef __USBIP_COMMON_H\n#define __USBIP_COMMON_H\n\n#include <linux/compiler.h>\n#include <linux/device.h>\n#include <linux/interrupt.h>\n#include <linux/net.h>\n#include <linux/printk.h>\n#include <linux/spinlock.h>\n#include <linux/types.h>\n#include <linux/usb.h>\n#include <linux/wait.h>\n#include <linux/sched/task.h>\n#include <linux/kcov.h>\n#include <uapi/linux/usbip.h>\n\n#undef pr_fmt\n\n#ifdef DEBUG\n#define pr_fmt(fmt)     KBUILD_MODNAME \": %s:%d: \" fmt, __func__, __LINE__\n#else\n#define pr_fmt(fmt)     KBUILD_MODNAME \": \" fmt\n#endif\n\nenum {\n\tusbip_debug_xmit\t= (1 << 0),\n\tusbip_debug_sysfs\t= (1 << 1),\n\tusbip_debug_urb\t\t= (1 << 2),\n\tusbip_debug_eh\t\t= (1 << 3),\n\n\tusbip_debug_stub_cmp\t= (1 << 8),\n\tusbip_debug_stub_dev\t= (1 << 9),\n\tusbip_debug_stub_rx\t= (1 << 10),\n\tusbip_debug_stub_tx\t= (1 << 11),\n\n\tusbip_debug_vhci_rh\t= (1 << 8),\n\tusbip_debug_vhci_hc\t= (1 << 9),\n\tusbip_debug_vhci_rx\t= (1 << 10),\n\tusbip_debug_vhci_tx\t= (1 << 11),\n\tusbip_debug_vhci_sysfs  = (1 << 12)\n};\n\n#define usbip_dbg_flag_xmit\t(usbip_debug_flag & usbip_debug_xmit)\n#define usbip_dbg_flag_vhci_rh\t(usbip_debug_flag & usbip_debug_vhci_rh)\n#define usbip_dbg_flag_vhci_hc\t(usbip_debug_flag & usbip_debug_vhci_hc)\n#define usbip_dbg_flag_vhci_rx\t(usbip_debug_flag & usbip_debug_vhci_rx)\n#define usbip_dbg_flag_vhci_tx\t(usbip_debug_flag & usbip_debug_vhci_tx)\n#define usbip_dbg_flag_stub_rx\t(usbip_debug_flag & usbip_debug_stub_rx)\n#define usbip_dbg_flag_stub_tx\t(usbip_debug_flag & usbip_debug_stub_tx)\n#define usbip_dbg_flag_vhci_sysfs  (usbip_debug_flag & usbip_debug_vhci_sysfs)\n\nextern unsigned long usbip_debug_flag;\nextern struct device_attribute dev_attr_usbip_debug;\n\n#define usbip_dbg_with_flag(flag, fmt, args...)\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\tif (flag & usbip_debug_flag)\t\t\\\n\t\t\tpr_debug(fmt, ##args);\t\t\\\n\t} while (0)\n\n#define usbip_dbg_sysfs(fmt, args...) \\\n\tusbip_dbg_with_flag(usbip_debug_sysfs, fmt , ##args)\n#define usbip_dbg_xmit(fmt, args...) \\\n\tusbip_dbg_with_flag(usbip_debug_xmit, fmt , ##args)\n#define usbip_dbg_urb(fmt, args...) \\\n\tusbip_dbg_with_flag(usbip_debug_urb, fmt , ##args)\n#define usbip_dbg_eh(fmt, args...) \\\n\tusbip_dbg_with_flag(usbip_debug_eh, fmt , ##args)\n\n#define usbip_dbg_vhci_rh(fmt, args...)\t\\\n\tusbip_dbg_with_flag(usbip_debug_vhci_rh, fmt , ##args)\n#define usbip_dbg_vhci_hc(fmt, args...)\t\\\n\tusbip_dbg_with_flag(usbip_debug_vhci_hc, fmt , ##args)\n#define usbip_dbg_vhci_rx(fmt, args...)\t\\\n\tusbip_dbg_with_flag(usbip_debug_vhci_rx, fmt , ##args)\n#define usbip_dbg_vhci_tx(fmt, args...)\t\\\n\tusbip_dbg_with_flag(usbip_debug_vhci_tx, fmt , ##args)\n#define usbip_dbg_vhci_sysfs(fmt, args...) \\\n\tusbip_dbg_with_flag(usbip_debug_vhci_sysfs, fmt , ##args)\n\n#define usbip_dbg_stub_cmp(fmt, args...) \\\n\tusbip_dbg_with_flag(usbip_debug_stub_cmp, fmt , ##args)\n#define usbip_dbg_stub_rx(fmt, args...) \\\n\tusbip_dbg_with_flag(usbip_debug_stub_rx, fmt , ##args)\n#define usbip_dbg_stub_tx(fmt, args...) \\\n\tusbip_dbg_with_flag(usbip_debug_stub_tx, fmt , ##args)\n\n \n#define USBIP_CMD_SUBMIT\t0x0001\n#define USBIP_CMD_UNLINK\t0x0002\n#define USBIP_RET_SUBMIT\t0x0003\n#define USBIP_RET_UNLINK\t0x0004\n\n#define USBIP_DIR_OUT\t0x00\n#define USBIP_DIR_IN\t0x01\n\n \n#define USBIP_MAX_ISO_PACKETS 1024\n\n \nstruct usbip_header_basic {\n\t__u32 command;\n\t__u32 seqnum;\n\t__u32 devid;\n\t__u32 direction;\n\t__u32 ep;\n} __packed;\n\n \nstruct usbip_header_cmd_submit {\n\t__u32 transfer_flags;\n\t__s32 transfer_buffer_length;\n\n\t \n\t__s32 start_frame;\n\t__s32 number_of_packets;\n\t__s32 interval;\n\n\tunsigned char setup[8];\n} __packed;\n\n \nstruct usbip_header_ret_submit {\n\t__s32 status;\n\t__s32 actual_length;\n\t__s32 start_frame;\n\t__s32 number_of_packets;\n\t__s32 error_count;\n} __packed;\n\n \nstruct usbip_header_cmd_unlink {\n\t__u32 seqnum;\n} __packed;\n\n \nstruct usbip_header_ret_unlink {\n\t__s32 status;\n} __packed;\n\n \nstruct usbip_header {\n\tstruct usbip_header_basic base;\n\n\tunion {\n\t\tstruct usbip_header_cmd_submit\tcmd_submit;\n\t\tstruct usbip_header_ret_submit\tret_submit;\n\t\tstruct usbip_header_cmd_unlink\tcmd_unlink;\n\t\tstruct usbip_header_ret_unlink\tret_unlink;\n\t} u;\n} __packed;\n\n \nstruct usbip_iso_packet_descriptor {\n\t__u32 offset;\n\t__u32 length;\t\t\t \n\t__u32 actual_length;\n\t__u32 status;\n} __packed;\n\nenum usbip_side {\n\tUSBIP_VHCI,\n\tUSBIP_STUB,\n\tUSBIP_VUDC,\n};\n\n \n#define USBIP_EH_SHUTDOWN\t(1 << 0)\n#define USBIP_EH_BYE\t\t(1 << 1)\n#define USBIP_EH_RESET\t\t(1 << 2)\n#define USBIP_EH_UNUSABLE\t(1 << 3)\n\n#define\tSDEV_EVENT_REMOVED\t(USBIP_EH_SHUTDOWN | USBIP_EH_BYE)\n#define\tSDEV_EVENT_DOWN\t\t(USBIP_EH_SHUTDOWN | USBIP_EH_RESET)\n#define\tSDEV_EVENT_ERROR_TCP\t(USBIP_EH_SHUTDOWN | USBIP_EH_RESET)\n#define\tSDEV_EVENT_ERROR_SUBMIT\t(USBIP_EH_SHUTDOWN | USBIP_EH_RESET)\n#define\tSDEV_EVENT_ERROR_MALLOC\t(USBIP_EH_SHUTDOWN | USBIP_EH_UNUSABLE)\n\n#define VUDC_EVENT_REMOVED   (USBIP_EH_SHUTDOWN | USBIP_EH_RESET | USBIP_EH_BYE)\n#define\tVUDC_EVENT_DOWN\t\t(USBIP_EH_SHUTDOWN | USBIP_EH_RESET)\n#define\tVUDC_EVENT_ERROR_TCP\t(USBIP_EH_SHUTDOWN | USBIP_EH_RESET)\n \n#define\tVUDC_EVENT_ERROR_USB\t(USBIP_EH_SHUTDOWN | USBIP_EH_UNUSABLE)\n#define\tVUDC_EVENT_ERROR_MALLOC\t(USBIP_EH_SHUTDOWN | USBIP_EH_UNUSABLE)\n\n#define\tVDEV_EVENT_REMOVED (USBIP_EH_SHUTDOWN | USBIP_EH_RESET | USBIP_EH_BYE)\n#define\tVDEV_EVENT_DOWN\t\t(USBIP_EH_SHUTDOWN | USBIP_EH_RESET)\n#define\tVDEV_EVENT_ERROR_TCP\t(USBIP_EH_SHUTDOWN | USBIP_EH_RESET)\n#define\tVDEV_EVENT_ERROR_MALLOC\t(USBIP_EH_SHUTDOWN | USBIP_EH_UNUSABLE)\n\n \nstruct usbip_device {\n\tenum usbip_side side;\n\tenum usbip_device_status status;\n\n\t \n\tspinlock_t lock;\n\n\t \n\tstruct mutex sysfs_lock;\n\n\tint sockfd;\n\tstruct socket *tcp_socket;\n\n\tstruct task_struct *tcp_rx;\n\tstruct task_struct *tcp_tx;\n\n\tunsigned long event;\n\twait_queue_head_t eh_waitq;\n\n\tstruct eh_ops {\n\t\tvoid (*shutdown)(struct usbip_device *);\n\t\tvoid (*reset)(struct usbip_device *);\n\t\tvoid (*unusable)(struct usbip_device *);\n\t} eh_ops;\n\n#ifdef CONFIG_KCOV\n\tu64 kcov_handle;\n#endif\n};\n\n#define kthread_get_run(threadfn, data, namefmt, ...)\t\t\t   \\\n({\t\t\t\t\t\t\t\t\t   \\\n\tstruct task_struct *__k\t\t\t\t\t\t   \\\n\t\t= kthread_create(threadfn, data, namefmt, ## __VA_ARGS__); \\\n\tif (!IS_ERR(__k)) {\t\t\t\t\t\t   \\\n\t\tget_task_struct(__k);\t\t\t\t\t   \\\n\t\twake_up_process(__k);\t\t\t\t\t   \\\n\t}\t\t\t\t\t\t\t\t   \\\n\t__k;\t\t\t\t\t\t\t\t   \\\n})\n\n#define kthread_stop_put(k)\t\t\\\n\tdo {\t\t\t\t\\\n\t\tkthread_stop(k);\t\\\n\t\tput_task_struct(k);\t\\\n\t} while (0)\n\n \nvoid usbip_dump_urb(struct urb *purb);\nvoid usbip_dump_header(struct usbip_header *pdu);\n\nint usbip_recv(struct socket *sock, void *buf, int size);\n\nvoid usbip_pack_pdu(struct usbip_header *pdu, struct urb *urb, int cmd,\n\t\t    int pack);\nvoid usbip_header_correct_endian(struct usbip_header *pdu, int send);\n\nstruct usbip_iso_packet_descriptor*\nusbip_alloc_iso_desc_pdu(struct urb *urb, ssize_t *bufflen);\n\n \nint usbip_recv_iso(struct usbip_device *ud, struct urb *urb);\nvoid usbip_pad_iso(struct usbip_device *ud, struct urb *urb);\nint usbip_recv_xbuff(struct usbip_device *ud, struct urb *urb);\n\n \nint usbip_init_eh(void);\nvoid usbip_finish_eh(void);\nint usbip_start_eh(struct usbip_device *ud);\nvoid usbip_stop_eh(struct usbip_device *ud);\nvoid usbip_event_add(struct usbip_device *ud, unsigned long event);\nint usbip_event_happened(struct usbip_device *ud);\nint usbip_in_eh(struct task_struct *task);\n\nstatic inline int interface_to_busnum(struct usb_interface *interface)\n{\n\tstruct usb_device *udev = interface_to_usbdev(interface);\n\n\treturn udev->bus->busnum;\n}\n\nstatic inline int interface_to_devnum(struct usb_interface *interface)\n{\n\tstruct usb_device *udev = interface_to_usbdev(interface);\n\n\treturn udev->devnum;\n}\n\n#ifdef CONFIG_KCOV\n\nstatic inline void usbip_kcov_handle_init(struct usbip_device *ud)\n{\n\tud->kcov_handle = kcov_common_handle();\n}\n\nstatic inline void usbip_kcov_remote_start(struct usbip_device *ud)\n{\n\tkcov_remote_start_common(ud->kcov_handle);\n}\n\nstatic inline void usbip_kcov_remote_stop(void)\n{\n\tkcov_remote_stop();\n}\n\n#else  \n\nstatic inline void usbip_kcov_handle_init(struct usbip_device *ud) { }\nstatic inline void usbip_kcov_remote_start(struct usbip_device *ud) { }\nstatic inline void usbip_kcov_remote_stop(void) { }\n\n#endif  \n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}