{
  "module_name": "phy.c",
  "hash_id": "2711919728f08df3d47065c4f3d25789abb7414abf2fa234eb300660cffe2f64",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/core/phy.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/list.h>\n#include <linux/phy/phy.h>\n#include <linux/of.h>\n\n#include \"phy.h\"\n\nstruct usb_phy_roothub {\n\tstruct phy\t\t*phy;\n\tstruct list_head\tlist;\n};\n\nstatic int usb_phy_roothub_add_phy(struct device *dev, int index,\n\t\t\t\t   struct list_head *list)\n{\n\tstruct usb_phy_roothub *roothub_entry;\n\tstruct phy *phy;\n\n\tphy = devm_of_phy_get_by_index(dev, dev->of_node, index);\n\tif (IS_ERR(phy)) {\n\t\tif (PTR_ERR(phy) == -ENODEV)\n\t\t\treturn 0;\n\t\telse\n\t\t\treturn PTR_ERR(phy);\n\t}\n\n\troothub_entry = devm_kzalloc(dev, sizeof(*roothub_entry), GFP_KERNEL);\n\tif (!roothub_entry)\n\t\treturn -ENOMEM;\n\n\tINIT_LIST_HEAD(&roothub_entry->list);\n\n\troothub_entry->phy = phy;\n\n\tlist_add_tail(&roothub_entry->list, list);\n\n\treturn 0;\n}\n\nstruct usb_phy_roothub *usb_phy_roothub_alloc(struct device *dev)\n{\n\tstruct usb_phy_roothub *phy_roothub;\n\tint i, num_phys, err;\n\n\tif (!IS_ENABLED(CONFIG_GENERIC_PHY))\n\t\treturn NULL;\n\n\tnum_phys = of_count_phandle_with_args(dev->of_node, \"phys\",\n\t\t\t\t\t      \"#phy-cells\");\n\tif (num_phys <= 0)\n\t\treturn NULL;\n\n\tphy_roothub = devm_kzalloc(dev, sizeof(*phy_roothub), GFP_KERNEL);\n\tif (!phy_roothub)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tINIT_LIST_HEAD(&phy_roothub->list);\n\n\tfor (i = 0; i < num_phys; i++) {\n\t\terr = usb_phy_roothub_add_phy(dev, i, &phy_roothub->list);\n\t\tif (err)\n\t\t\treturn ERR_PTR(err);\n\t}\n\n\treturn phy_roothub;\n}\nEXPORT_SYMBOL_GPL(usb_phy_roothub_alloc);\n\nint usb_phy_roothub_init(struct usb_phy_roothub *phy_roothub)\n{\n\tstruct usb_phy_roothub *roothub_entry;\n\tstruct list_head *head;\n\tint err;\n\n\tif (!phy_roothub)\n\t\treturn 0;\n\n\thead = &phy_roothub->list;\n\n\tlist_for_each_entry(roothub_entry, head, list) {\n\t\terr = phy_init(roothub_entry->phy);\n\t\tif (err)\n\t\t\tgoto err_exit_phys;\n\t}\n\n\treturn 0;\n\nerr_exit_phys:\n\tlist_for_each_entry_continue_reverse(roothub_entry, head, list)\n\t\tphy_exit(roothub_entry->phy);\n\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(usb_phy_roothub_init);\n\nint usb_phy_roothub_exit(struct usb_phy_roothub *phy_roothub)\n{\n\tstruct usb_phy_roothub *roothub_entry;\n\tstruct list_head *head;\n\tint err, ret = 0;\n\n\tif (!phy_roothub)\n\t\treturn 0;\n\n\thead = &phy_roothub->list;\n\n\tlist_for_each_entry(roothub_entry, head, list) {\n\t\terr = phy_exit(roothub_entry->phy);\n\t\tif (err)\n\t\t\tret = err;\n\t}\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(usb_phy_roothub_exit);\n\nint usb_phy_roothub_set_mode(struct usb_phy_roothub *phy_roothub,\n\t\t\t     enum phy_mode mode)\n{\n\tstruct usb_phy_roothub *roothub_entry;\n\tstruct list_head *head;\n\tint err;\n\n\tif (!phy_roothub)\n\t\treturn 0;\n\n\thead = &phy_roothub->list;\n\n\tlist_for_each_entry(roothub_entry, head, list) {\n\t\terr = phy_set_mode(roothub_entry->phy, mode);\n\t\tif (err)\n\t\t\tgoto err_out;\n\t}\n\n\treturn 0;\n\nerr_out:\n\tlist_for_each_entry_continue_reverse(roothub_entry, head, list)\n\t\tphy_power_off(roothub_entry->phy);\n\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(usb_phy_roothub_set_mode);\n\nint usb_phy_roothub_calibrate(struct usb_phy_roothub *phy_roothub)\n{\n\tstruct usb_phy_roothub *roothub_entry;\n\tstruct list_head *head;\n\tint err;\n\n\tif (!phy_roothub)\n\t\treturn 0;\n\n\thead = &phy_roothub->list;\n\n\tlist_for_each_entry(roothub_entry, head, list) {\n\t\terr = phy_calibrate(roothub_entry->phy);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(usb_phy_roothub_calibrate);\n\nint usb_phy_roothub_power_on(struct usb_phy_roothub *phy_roothub)\n{\n\tstruct usb_phy_roothub *roothub_entry;\n\tstruct list_head *head;\n\tint err;\n\n\tif (!phy_roothub)\n\t\treturn 0;\n\n\thead = &phy_roothub->list;\n\n\tlist_for_each_entry(roothub_entry, head, list) {\n\t\terr = phy_power_on(roothub_entry->phy);\n\t\tif (err)\n\t\t\tgoto err_out;\n\t}\n\n\treturn 0;\n\nerr_out:\n\tlist_for_each_entry_continue_reverse(roothub_entry, head, list)\n\t\tphy_power_off(roothub_entry->phy);\n\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(usb_phy_roothub_power_on);\n\nvoid usb_phy_roothub_power_off(struct usb_phy_roothub *phy_roothub)\n{\n\tstruct usb_phy_roothub *roothub_entry;\n\n\tif (!phy_roothub)\n\t\treturn;\n\n\tlist_for_each_entry_reverse(roothub_entry, &phy_roothub->list, list)\n\t\tphy_power_off(roothub_entry->phy);\n}\nEXPORT_SYMBOL_GPL(usb_phy_roothub_power_off);\n\nint usb_phy_roothub_suspend(struct device *controller_dev,\n\t\t\t    struct usb_phy_roothub *phy_roothub)\n{\n\tusb_phy_roothub_power_off(phy_roothub);\n\n\t \n\tif (device_may_wakeup(controller_dev))\n\t\treturn 0;\n\n\treturn usb_phy_roothub_exit(phy_roothub);\n}\nEXPORT_SYMBOL_GPL(usb_phy_roothub_suspend);\n\nint usb_phy_roothub_resume(struct device *controller_dev,\n\t\t\t   struct usb_phy_roothub *phy_roothub)\n{\n\tint err;\n\n\t \n\tif (!device_may_wakeup(controller_dev)) {\n\t\terr = usb_phy_roothub_init(phy_roothub);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\terr = usb_phy_roothub_power_on(phy_roothub);\n\n\t \n\tif (err && !device_may_wakeup(controller_dev))\n\t\tusb_phy_roothub_exit(phy_roothub);\n\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(usb_phy_roothub_resume);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}