{
  "module_name": "debugfs.c",
  "hash_id": "f173bef7170f1b7c5942bf476a0c53713afd1c31fe10160a19e7957386808137",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/dwc3/debugfs.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/ptrace.h>\n#include <linux/types.h>\n#include <linux/spinlock.h>\n#include <linux/debugfs.h>\n#include <linux/seq_file.h>\n#include <linux/delay.h>\n#include <linux/uaccess.h>\n\n#include <linux/usb/ch9.h>\n\n#include \"core.h\"\n#include \"gadget.h\"\n#include \"io.h\"\n#include \"debug.h\"\n\n#define DWC3_LSP_MUX_UNSELECTED 0xfffff\n\n#define dump_register(nm)\t\t\t\t\\\n{\t\t\t\t\t\t\t\\\n\t.name\t= __stringify(nm),\t\t\t\\\n\t.offset\t= DWC3_ ##nm,\t\t\t\t\\\n}\n\n#define dump_ep_register_set(n)\t\t\t\\\n\t{\t\t\t\t\t\\\n\t\t.name = \"DEPCMDPAR2(\"__stringify(n)\")\",\t\\\n\t\t.offset = DWC3_DEP_BASE(n) +\t\\\n\t\t\tDWC3_DEPCMDPAR2,\t\\\n\t},\t\t\t\t\t\\\n\t{\t\t\t\t\t\\\n\t\t.name = \"DEPCMDPAR1(\"__stringify(n)\")\",\t\\\n\t\t.offset = DWC3_DEP_BASE(n) +\t\\\n\t\t\tDWC3_DEPCMDPAR1,\t\\\n\t},\t\t\t\t\t\\\n\t{\t\t\t\t\t\\\n\t\t.name = \"DEPCMDPAR0(\"__stringify(n)\")\",\t\\\n\t\t.offset = DWC3_DEP_BASE(n) +\t\\\n\t\t\tDWC3_DEPCMDPAR0,\t\\\n\t},\t\t\t\t\t\\\n\t{\t\t\t\t\t\\\n\t\t.name = \"DEPCMD(\"__stringify(n)\")\",\t\\\n\t\t.offset = DWC3_DEP_BASE(n) +\t\\\n\t\t\tDWC3_DEPCMD,\t\t\\\n\t}\n\n\nstatic const struct debugfs_reg32 dwc3_regs[] = {\n\tdump_register(GSBUSCFG0),\n\tdump_register(GSBUSCFG1),\n\tdump_register(GTXTHRCFG),\n\tdump_register(GRXTHRCFG),\n\tdump_register(GCTL),\n\tdump_register(GEVTEN),\n\tdump_register(GSTS),\n\tdump_register(GUCTL1),\n\tdump_register(GSNPSID),\n\tdump_register(GGPIO),\n\tdump_register(GUID),\n\tdump_register(GUCTL),\n\tdump_register(GBUSERRADDR0),\n\tdump_register(GBUSERRADDR1),\n\tdump_register(GPRTBIMAP0),\n\tdump_register(GPRTBIMAP1),\n\tdump_register(GHWPARAMS0),\n\tdump_register(GHWPARAMS1),\n\tdump_register(GHWPARAMS2),\n\tdump_register(GHWPARAMS3),\n\tdump_register(GHWPARAMS4),\n\tdump_register(GHWPARAMS5),\n\tdump_register(GHWPARAMS6),\n\tdump_register(GHWPARAMS7),\n\tdump_register(GDBGFIFOSPACE),\n\tdump_register(GDBGLTSSM),\n\tdump_register(GDBGBMU),\n\tdump_register(GPRTBIMAP_HS0),\n\tdump_register(GPRTBIMAP_HS1),\n\tdump_register(GPRTBIMAP_FS0),\n\tdump_register(GPRTBIMAP_FS1),\n\tdump_register(GUCTL2),\n\tdump_register(VER_NUMBER),\n\tdump_register(VER_TYPE),\n\n\tdump_register(GUSB2PHYCFG(0)),\n\tdump_register(GUSB2PHYCFG(1)),\n\tdump_register(GUSB2PHYCFG(2)),\n\tdump_register(GUSB2PHYCFG(3)),\n\tdump_register(GUSB2PHYCFG(4)),\n\tdump_register(GUSB2PHYCFG(5)),\n\tdump_register(GUSB2PHYCFG(6)),\n\tdump_register(GUSB2PHYCFG(7)),\n\tdump_register(GUSB2PHYCFG(8)),\n\tdump_register(GUSB2PHYCFG(9)),\n\tdump_register(GUSB2PHYCFG(10)),\n\tdump_register(GUSB2PHYCFG(11)),\n\tdump_register(GUSB2PHYCFG(12)),\n\tdump_register(GUSB2PHYCFG(13)),\n\tdump_register(GUSB2PHYCFG(14)),\n\tdump_register(GUSB2PHYCFG(15)),\n\n\tdump_register(GUSB2I2CCTL(0)),\n\tdump_register(GUSB2I2CCTL(1)),\n\tdump_register(GUSB2I2CCTL(2)),\n\tdump_register(GUSB2I2CCTL(3)),\n\tdump_register(GUSB2I2CCTL(4)),\n\tdump_register(GUSB2I2CCTL(5)),\n\tdump_register(GUSB2I2CCTL(6)),\n\tdump_register(GUSB2I2CCTL(7)),\n\tdump_register(GUSB2I2CCTL(8)),\n\tdump_register(GUSB2I2CCTL(9)),\n\tdump_register(GUSB2I2CCTL(10)),\n\tdump_register(GUSB2I2CCTL(11)),\n\tdump_register(GUSB2I2CCTL(12)),\n\tdump_register(GUSB2I2CCTL(13)),\n\tdump_register(GUSB2I2CCTL(14)),\n\tdump_register(GUSB2I2CCTL(15)),\n\n\tdump_register(GUSB2PHYACC(0)),\n\tdump_register(GUSB2PHYACC(1)),\n\tdump_register(GUSB2PHYACC(2)),\n\tdump_register(GUSB2PHYACC(3)),\n\tdump_register(GUSB2PHYACC(4)),\n\tdump_register(GUSB2PHYACC(5)),\n\tdump_register(GUSB2PHYACC(6)),\n\tdump_register(GUSB2PHYACC(7)),\n\tdump_register(GUSB2PHYACC(8)),\n\tdump_register(GUSB2PHYACC(9)),\n\tdump_register(GUSB2PHYACC(10)),\n\tdump_register(GUSB2PHYACC(11)),\n\tdump_register(GUSB2PHYACC(12)),\n\tdump_register(GUSB2PHYACC(13)),\n\tdump_register(GUSB2PHYACC(14)),\n\tdump_register(GUSB2PHYACC(15)),\n\n\tdump_register(GUSB3PIPECTL(0)),\n\tdump_register(GUSB3PIPECTL(1)),\n\tdump_register(GUSB3PIPECTL(2)),\n\tdump_register(GUSB3PIPECTL(3)),\n\tdump_register(GUSB3PIPECTL(4)),\n\tdump_register(GUSB3PIPECTL(5)),\n\tdump_register(GUSB3PIPECTL(6)),\n\tdump_register(GUSB3PIPECTL(7)),\n\tdump_register(GUSB3PIPECTL(8)),\n\tdump_register(GUSB3PIPECTL(9)),\n\tdump_register(GUSB3PIPECTL(10)),\n\tdump_register(GUSB3PIPECTL(11)),\n\tdump_register(GUSB3PIPECTL(12)),\n\tdump_register(GUSB3PIPECTL(13)),\n\tdump_register(GUSB3PIPECTL(14)),\n\tdump_register(GUSB3PIPECTL(15)),\n\n\tdump_register(GTXFIFOSIZ(0)),\n\tdump_register(GTXFIFOSIZ(1)),\n\tdump_register(GTXFIFOSIZ(2)),\n\tdump_register(GTXFIFOSIZ(3)),\n\tdump_register(GTXFIFOSIZ(4)),\n\tdump_register(GTXFIFOSIZ(5)),\n\tdump_register(GTXFIFOSIZ(6)),\n\tdump_register(GTXFIFOSIZ(7)),\n\tdump_register(GTXFIFOSIZ(8)),\n\tdump_register(GTXFIFOSIZ(9)),\n\tdump_register(GTXFIFOSIZ(10)),\n\tdump_register(GTXFIFOSIZ(11)),\n\tdump_register(GTXFIFOSIZ(12)),\n\tdump_register(GTXFIFOSIZ(13)),\n\tdump_register(GTXFIFOSIZ(14)),\n\tdump_register(GTXFIFOSIZ(15)),\n\tdump_register(GTXFIFOSIZ(16)),\n\tdump_register(GTXFIFOSIZ(17)),\n\tdump_register(GTXFIFOSIZ(18)),\n\tdump_register(GTXFIFOSIZ(19)),\n\tdump_register(GTXFIFOSIZ(20)),\n\tdump_register(GTXFIFOSIZ(21)),\n\tdump_register(GTXFIFOSIZ(22)),\n\tdump_register(GTXFIFOSIZ(23)),\n\tdump_register(GTXFIFOSIZ(24)),\n\tdump_register(GTXFIFOSIZ(25)),\n\tdump_register(GTXFIFOSIZ(26)),\n\tdump_register(GTXFIFOSIZ(27)),\n\tdump_register(GTXFIFOSIZ(28)),\n\tdump_register(GTXFIFOSIZ(29)),\n\tdump_register(GTXFIFOSIZ(30)),\n\tdump_register(GTXFIFOSIZ(31)),\n\n\tdump_register(GRXFIFOSIZ(0)),\n\tdump_register(GRXFIFOSIZ(1)),\n\tdump_register(GRXFIFOSIZ(2)),\n\tdump_register(GRXFIFOSIZ(3)),\n\tdump_register(GRXFIFOSIZ(4)),\n\tdump_register(GRXFIFOSIZ(5)),\n\tdump_register(GRXFIFOSIZ(6)),\n\tdump_register(GRXFIFOSIZ(7)),\n\tdump_register(GRXFIFOSIZ(8)),\n\tdump_register(GRXFIFOSIZ(9)),\n\tdump_register(GRXFIFOSIZ(10)),\n\tdump_register(GRXFIFOSIZ(11)),\n\tdump_register(GRXFIFOSIZ(12)),\n\tdump_register(GRXFIFOSIZ(13)),\n\tdump_register(GRXFIFOSIZ(14)),\n\tdump_register(GRXFIFOSIZ(15)),\n\tdump_register(GRXFIFOSIZ(16)),\n\tdump_register(GRXFIFOSIZ(17)),\n\tdump_register(GRXFIFOSIZ(18)),\n\tdump_register(GRXFIFOSIZ(19)),\n\tdump_register(GRXFIFOSIZ(20)),\n\tdump_register(GRXFIFOSIZ(21)),\n\tdump_register(GRXFIFOSIZ(22)),\n\tdump_register(GRXFIFOSIZ(23)),\n\tdump_register(GRXFIFOSIZ(24)),\n\tdump_register(GRXFIFOSIZ(25)),\n\tdump_register(GRXFIFOSIZ(26)),\n\tdump_register(GRXFIFOSIZ(27)),\n\tdump_register(GRXFIFOSIZ(28)),\n\tdump_register(GRXFIFOSIZ(29)),\n\tdump_register(GRXFIFOSIZ(30)),\n\tdump_register(GRXFIFOSIZ(31)),\n\n\tdump_register(GEVNTADRLO(0)),\n\tdump_register(GEVNTADRHI(0)),\n\tdump_register(GEVNTSIZ(0)),\n\tdump_register(GEVNTCOUNT(0)),\n\n\tdump_register(GHWPARAMS8),\n\tdump_register(GUCTL3),\n\tdump_register(GFLADJ),\n\tdump_register(DCFG),\n\tdump_register(DCTL),\n\tdump_register(DEVTEN),\n\tdump_register(DSTS),\n\tdump_register(DGCMDPAR),\n\tdump_register(DGCMD),\n\tdump_register(DALEPENA),\n\n\tdump_ep_register_set(0),\n\tdump_ep_register_set(1),\n\tdump_ep_register_set(2),\n\tdump_ep_register_set(3),\n\tdump_ep_register_set(4),\n\tdump_ep_register_set(5),\n\tdump_ep_register_set(6),\n\tdump_ep_register_set(7),\n\tdump_ep_register_set(8),\n\tdump_ep_register_set(9),\n\tdump_ep_register_set(10),\n\tdump_ep_register_set(11),\n\tdump_ep_register_set(12),\n\tdump_ep_register_set(13),\n\tdump_ep_register_set(14),\n\tdump_ep_register_set(15),\n\tdump_ep_register_set(16),\n\tdump_ep_register_set(17),\n\tdump_ep_register_set(18),\n\tdump_ep_register_set(19),\n\tdump_ep_register_set(20),\n\tdump_ep_register_set(21),\n\tdump_ep_register_set(22),\n\tdump_ep_register_set(23),\n\tdump_ep_register_set(24),\n\tdump_ep_register_set(25),\n\tdump_ep_register_set(26),\n\tdump_ep_register_set(27),\n\tdump_ep_register_set(28),\n\tdump_ep_register_set(29),\n\tdump_ep_register_set(30),\n\tdump_ep_register_set(31),\n\n\tdump_register(OCFG),\n\tdump_register(OCTL),\n\tdump_register(OEVT),\n\tdump_register(OEVTEN),\n\tdump_register(OSTS),\n};\n\nstatic void dwc3_host_lsp(struct seq_file *s)\n{\n\tstruct dwc3\t\t*dwc = s->private;\n\tbool\t\t\tdbc_enabled;\n\tu32\t\t\tsel;\n\tu32\t\t\treg;\n\tu32\t\t\tval;\n\n\tdbc_enabled = !!(dwc->hwparams.hwparams1 & DWC3_GHWPARAMS1_ENDBC);\n\n\tsel = dwc->dbg_lsp_select;\n\tif (sel == DWC3_LSP_MUX_UNSELECTED) {\n\t\tseq_puts(s, \"Write LSP selection to print for host\\n\");\n\t\treturn;\n\t}\n\n\treg = DWC3_GDBGLSPMUX_HOSTSELECT(sel);\n\n\tdwc3_writel(dwc->regs, DWC3_GDBGLSPMUX, reg);\n\tval = dwc3_readl(dwc->regs, DWC3_GDBGLSP);\n\tseq_printf(s, \"GDBGLSP[%d] = 0x%08x\\n\", sel, val);\n\n\tif (dbc_enabled && sel < 256) {\n\t\treg |= DWC3_GDBGLSPMUX_ENDBC;\n\t\tdwc3_writel(dwc->regs, DWC3_GDBGLSPMUX, reg);\n\t\tval = dwc3_readl(dwc->regs, DWC3_GDBGLSP);\n\t\tseq_printf(s, \"GDBGLSP_DBC[%d] = 0x%08x\\n\", sel, val);\n\t}\n}\n\nstatic void dwc3_gadget_lsp(struct seq_file *s)\n{\n\tstruct dwc3\t\t*dwc = s->private;\n\tint\t\t\ti;\n\tu32\t\t\treg;\n\n\tfor (i = 0; i < 16; i++) {\n\t\treg = DWC3_GDBGLSPMUX_DEVSELECT(i);\n\t\tdwc3_writel(dwc->regs, DWC3_GDBGLSPMUX, reg);\n\t\treg = dwc3_readl(dwc->regs, DWC3_GDBGLSP);\n\t\tseq_printf(s, \"GDBGLSP[%d] = 0x%08x\\n\", i, reg);\n\t}\n}\n\nstatic int dwc3_lsp_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3\t\t*dwc = s->private;\n\tunsigned int\t\tcurrent_mode;\n\tunsigned long\t\tflags;\n\tu32\t\t\treg;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\treg = dwc3_readl(dwc->regs, DWC3_GSTS);\n\tcurrent_mode = DWC3_GSTS_CURMOD(reg);\n\n\tswitch (current_mode) {\n\tcase DWC3_GSTS_CURMOD_HOST:\n\t\tdwc3_host_lsp(s);\n\t\tbreak;\n\tcase DWC3_GSTS_CURMOD_DEVICE:\n\t\tdwc3_gadget_lsp(s);\n\t\tbreak;\n\tdefault:\n\t\tseq_puts(s, \"Mode is unknown, no LSP register printed\\n\");\n\t\tbreak;\n\t}\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_lsp_open(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, dwc3_lsp_show, inode->i_private);\n}\n\nstatic ssize_t dwc3_lsp_write(struct file *file, const char __user *ubuf,\n\t\t\t      size_t count, loff_t *ppos)\n{\n\tstruct seq_file\t\t*s = file->private_data;\n\tstruct dwc3\t\t*dwc = s->private;\n\tunsigned long\t\tflags;\n\tchar\t\t\tbuf[32] = { 0 };\n\tu32\t\t\tsel;\n\tint\t\t\tret;\n\n\tif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\n\t\treturn -EFAULT;\n\n\tret = kstrtouint(buf, 0, &sel);\n\tif (ret)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tdwc->dbg_lsp_select = sel;\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\treturn count;\n}\n\nstatic const struct file_operations dwc3_lsp_fops = {\n\t.open\t\t\t= dwc3_lsp_open,\n\t.write\t\t\t= dwc3_lsp_write,\n\t.read\t\t\t= seq_read,\n\t.llseek\t\t\t= seq_lseek,\n\t.release\t\t= single_release,\n};\n\nstatic int dwc3_mode_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3\t\t*dwc = s->private;\n\tunsigned long\t\tflags;\n\tu32\t\t\treg;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\treg = dwc3_readl(dwc->regs, DWC3_GCTL);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tswitch (DWC3_GCTL_PRTCAP(reg)) {\n\tcase DWC3_GCTL_PRTCAP_HOST:\n\t\tseq_puts(s, \"host\\n\");\n\t\tbreak;\n\tcase DWC3_GCTL_PRTCAP_DEVICE:\n\t\tseq_puts(s, \"device\\n\");\n\t\tbreak;\n\tcase DWC3_GCTL_PRTCAP_OTG:\n\t\tseq_puts(s, \"otg\\n\");\n\t\tbreak;\n\tdefault:\n\t\tseq_printf(s, \"UNKNOWN %08x\\n\", DWC3_GCTL_PRTCAP(reg));\n\t}\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_mode_open(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, dwc3_mode_show, inode->i_private);\n}\n\nstatic ssize_t dwc3_mode_write(struct file *file,\n\t\tconst char __user *ubuf, size_t count, loff_t *ppos)\n{\n\tstruct seq_file\t\t*s = file->private_data;\n\tstruct dwc3\t\t*dwc = s->private;\n\tu32\t\t\tmode = 0;\n\tchar\t\t\tbuf[32];\n\n\tif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\n\t\treturn -EFAULT;\n\n\tif (dwc->dr_mode != USB_DR_MODE_OTG)\n\t\treturn count;\n\n\tif (!strncmp(buf, \"host\", 4))\n\t\tmode = DWC3_GCTL_PRTCAP_HOST;\n\n\tif (!strncmp(buf, \"device\", 6))\n\t\tmode = DWC3_GCTL_PRTCAP_DEVICE;\n\n\tif (!strncmp(buf, \"otg\", 3))\n\t\tmode = DWC3_GCTL_PRTCAP_OTG;\n\n\tdwc3_set_mode(dwc, mode);\n\n\treturn count;\n}\n\nstatic const struct file_operations dwc3_mode_fops = {\n\t.open\t\t\t= dwc3_mode_open,\n\t.write\t\t\t= dwc3_mode_write,\n\t.read\t\t\t= seq_read,\n\t.llseek\t\t\t= seq_lseek,\n\t.release\t\t= single_release,\n};\n\nstatic int dwc3_testmode_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3\t\t*dwc = s->private;\n\tunsigned long\t\tflags;\n\tu32\t\t\treg;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\treg = dwc3_readl(dwc->regs, DWC3_DCTL);\n\treg &= DWC3_DCTL_TSTCTRL_MASK;\n\treg >>= 1;\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tswitch (reg) {\n\tcase 0:\n\t\tseq_puts(s, \"no test\\n\");\n\t\tbreak;\n\tcase USB_TEST_J:\n\t\tseq_puts(s, \"test_j\\n\");\n\t\tbreak;\n\tcase USB_TEST_K:\n\t\tseq_puts(s, \"test_k\\n\");\n\t\tbreak;\n\tcase USB_TEST_SE0_NAK:\n\t\tseq_puts(s, \"test_se0_nak\\n\");\n\t\tbreak;\n\tcase USB_TEST_PACKET:\n\t\tseq_puts(s, \"test_packet\\n\");\n\t\tbreak;\n\tcase USB_TEST_FORCE_ENABLE:\n\t\tseq_puts(s, \"test_force_enable\\n\");\n\t\tbreak;\n\tdefault:\n\t\tseq_printf(s, \"UNKNOWN %d\\n\", reg);\n\t}\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_testmode_open(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, dwc3_testmode_show, inode->i_private);\n}\n\nstatic ssize_t dwc3_testmode_write(struct file *file,\n\t\tconst char __user *ubuf, size_t count, loff_t *ppos)\n{\n\tstruct seq_file\t\t*s = file->private_data;\n\tstruct dwc3\t\t*dwc = s->private;\n\tunsigned long\t\tflags;\n\tu32\t\t\ttestmode = 0;\n\tchar\t\t\tbuf[32];\n\tint\t\t\tret;\n\n\tif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\n\t\treturn -EFAULT;\n\n\tif (!strncmp(buf, \"test_j\", 6))\n\t\ttestmode = USB_TEST_J;\n\telse if (!strncmp(buf, \"test_k\", 6))\n\t\ttestmode = USB_TEST_K;\n\telse if (!strncmp(buf, \"test_se0_nak\", 12))\n\t\ttestmode = USB_TEST_SE0_NAK;\n\telse if (!strncmp(buf, \"test_packet\", 11))\n\t\ttestmode = USB_TEST_PACKET;\n\telse if (!strncmp(buf, \"test_force_enable\", 17))\n\t\ttestmode = USB_TEST_FORCE_ENABLE;\n\telse\n\t\ttestmode = 0;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tdwc3_gadget_set_test_mode(dwc, testmode);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn count;\n}\n\nstatic const struct file_operations dwc3_testmode_fops = {\n\t.open\t\t\t= dwc3_testmode_open,\n\t.write\t\t\t= dwc3_testmode_write,\n\t.read\t\t\t= seq_read,\n\t.llseek\t\t\t= seq_lseek,\n\t.release\t\t= single_release,\n};\n\nstatic int dwc3_link_state_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3\t\t*dwc = s->private;\n\tunsigned long\t\tflags;\n\tenum dwc3_link_state\tstate;\n\tu32\t\t\treg;\n\tu8\t\t\tspeed;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\treg = dwc3_readl(dwc->regs, DWC3_GSTS);\n\tif (DWC3_GSTS_CURMOD(reg) != DWC3_GSTS_CURMOD_DEVICE) {\n\t\tseq_puts(s, \"Not available\\n\");\n\t\tspin_unlock_irqrestore(&dwc->lock, flags);\n\t\tpm_runtime_put_sync(dwc->dev);\n\t\treturn 0;\n\t}\n\n\treg = dwc3_readl(dwc->regs, DWC3_DSTS);\n\tstate = DWC3_DSTS_USBLNKST(reg);\n\tspeed = reg & DWC3_DSTS_CONNECTSPD;\n\n\tseq_printf(s, \"%s\\n\", (speed >= DWC3_DSTS_SUPERSPEED) ?\n\t\t   dwc3_gadget_link_string(state) :\n\t\t   dwc3_gadget_hs_link_string(state));\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_link_state_open(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, dwc3_link_state_show, inode->i_private);\n}\n\nstatic ssize_t dwc3_link_state_write(struct file *file,\n\t\tconst char __user *ubuf, size_t count, loff_t *ppos)\n{\n\tstruct seq_file\t\t*s = file->private_data;\n\tstruct dwc3\t\t*dwc = s->private;\n\tunsigned long\t\tflags;\n\tenum dwc3_link_state\tstate = 0;\n\tchar\t\t\tbuf[32];\n\tu32\t\t\treg;\n\tu8\t\t\tspeed;\n\tint\t\t\tret;\n\n\tif (copy_from_user(&buf, ubuf, min_t(size_t, sizeof(buf) - 1, count)))\n\t\treturn -EFAULT;\n\n\tif (!strncmp(buf, \"SS.Disabled\", 11))\n\t\tstate = DWC3_LINK_STATE_SS_DIS;\n\telse if (!strncmp(buf, \"Rx.Detect\", 9))\n\t\tstate = DWC3_LINK_STATE_RX_DET;\n\telse if (!strncmp(buf, \"SS.Inactive\", 11))\n\t\tstate = DWC3_LINK_STATE_SS_INACT;\n\telse if (!strncmp(buf, \"Recovery\", 8))\n\t\tstate = DWC3_LINK_STATE_RECOV;\n\telse if (!strncmp(buf, \"Compliance\", 10))\n\t\tstate = DWC3_LINK_STATE_CMPLY;\n\telse if (!strncmp(buf, \"Loopback\", 8))\n\t\tstate = DWC3_LINK_STATE_LPBK;\n\telse\n\t\treturn -EINVAL;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\treg = dwc3_readl(dwc->regs, DWC3_GSTS);\n\tif (DWC3_GSTS_CURMOD(reg) != DWC3_GSTS_CURMOD_DEVICE) {\n\t\tspin_unlock_irqrestore(&dwc->lock, flags);\n\t\tpm_runtime_put_sync(dwc->dev);\n\t\treturn -EINVAL;\n\t}\n\n\treg = dwc3_readl(dwc->regs, DWC3_DSTS);\n\tspeed = reg & DWC3_DSTS_CONNECTSPD;\n\n\tif (speed < DWC3_DSTS_SUPERSPEED &&\n\t    state != DWC3_LINK_STATE_RECOV) {\n\t\tspin_unlock_irqrestore(&dwc->lock, flags);\n\t\tpm_runtime_put_sync(dwc->dev);\n\t\treturn -EINVAL;\n\t}\n\n\tdwc3_gadget_set_link_state(dwc, state);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn count;\n}\n\nstatic const struct file_operations dwc3_link_state_fops = {\n\t.open\t\t\t= dwc3_link_state_open,\n\t.write\t\t\t= dwc3_link_state_write,\n\t.read\t\t\t= seq_read,\n\t.llseek\t\t\t= seq_lseek,\n\t.release\t\t= single_release,\n};\n\nstruct dwc3_ep_file_map {\n\tconst char name[25];\n\tconst struct file_operations *const fops;\n};\n\nstatic int dwc3_tx_fifo_size_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\tu32\t\t\tmdwidth;\n\tu32\t\t\tval;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tval = dwc3_core_fifo_space(dep, DWC3_TXFIFO);\n\n\t \n\tmdwidth = dwc3_mdwidth(dwc);\n\n\tval *= mdwidth;\n\tval >>= 3;\n\tseq_printf(s, \"%u\\n\", val);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_rx_fifo_size_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\tu32\t\t\tmdwidth;\n\tu32\t\t\tval;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tval = dwc3_core_fifo_space(dep, DWC3_RXFIFO);\n\n\t \n\tmdwidth = dwc3_mdwidth(dwc);\n\n\tval *= mdwidth;\n\tval >>= 3;\n\tseq_printf(s, \"%u\\n\", val);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_tx_request_queue_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\tu32\t\t\tval;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tval = dwc3_core_fifo_space(dep, DWC3_TXREQQ);\n\tseq_printf(s, \"%u\\n\", val);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_rx_request_queue_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\tu32\t\t\tval;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tval = dwc3_core_fifo_space(dep, DWC3_RXREQQ);\n\tseq_printf(s, \"%u\\n\", val);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_rx_info_queue_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\tu32\t\t\tval;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tval = dwc3_core_fifo_space(dep, DWC3_RXINFOQ);\n\tseq_printf(s, \"%u\\n\", val);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_descriptor_fetch_queue_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\tu32\t\t\tval;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tval = dwc3_core_fifo_space(dep, DWC3_DESCFETCHQ);\n\tseq_printf(s, \"%u\\n\", val);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_event_queue_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\tu32\t\t\tval;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tval = dwc3_core_fifo_space(dep, DWC3_EVENTQ);\n\tseq_printf(s, \"%u\\n\", val);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_transfer_type_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tif (!(dep->flags & DWC3_EP_ENABLED) || !dep->endpoint.desc) {\n\t\tseq_puts(s, \"--\\n\");\n\t\tgoto out;\n\t}\n\n\tswitch (usb_endpoint_type(dep->endpoint.desc)) {\n\tcase USB_ENDPOINT_XFER_CONTROL:\n\t\tseq_puts(s, \"control\\n\");\n\t\tbreak;\n\tcase USB_ENDPOINT_XFER_ISOC:\n\t\tseq_puts(s, \"isochronous\\n\");\n\t\tbreak;\n\tcase USB_ENDPOINT_XFER_BULK:\n\t\tseq_puts(s, \"bulk\\n\");\n\t\tbreak;\n\tcase USB_ENDPOINT_XFER_INT:\n\t\tseq_puts(s, \"interrupt\\n\");\n\t\tbreak;\n\tdefault:\n\t\tseq_puts(s, \"--\\n\");\n\t}\n\nout:\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\treturn 0;\n}\n\nstatic int dwc3_trb_ring_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\tint\t\t\ti;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\tif (dep->number <= 1) {\n\t\tseq_puts(s, \"--\\n\");\n\t\tgoto out;\n\t}\n\n\tseq_puts(s, \"buffer_addr,size,type,ioc,isp_imi,csp,chn,lst,hwo\\n\");\n\n\tfor (i = 0; i < DWC3_TRB_NUM; i++) {\n\t\tstruct dwc3_trb *trb = &dep->trb_pool[i];\n\t\tunsigned int type = DWC3_TRBCTL_TYPE(trb->ctrl);\n\n\t\tseq_printf(s, \"%08x%08x,%d,%s,%d,%d,%d,%d,%d,%d       %c%c\\n\",\n\t\t\t\ttrb->bph, trb->bpl, trb->size,\n\t\t\t\tdwc3_trb_type_string(type),\n\t\t\t\t!!(trb->ctrl & DWC3_TRB_CTRL_IOC),\n\t\t\t\t!!(trb->ctrl & DWC3_TRB_CTRL_ISP_IMI),\n\t\t\t\t!!(trb->ctrl & DWC3_TRB_CTRL_CSP),\n\t\t\t\t!!(trb->ctrl & DWC3_TRB_CTRL_CHN),\n\t\t\t\t!!(trb->ctrl & DWC3_TRB_CTRL_LST),\n\t\t\t\t!!(trb->ctrl & DWC3_TRB_CTRL_HWO),\n\t\t\t\tdep->trb_enqueue == i ? 'E' : ' ',\n\t\t\t\tdep->trb_dequeue == i ? 'D' : ' ');\n\t}\n\nout:\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nstatic int dwc3_ep_info_register_show(struct seq_file *s, void *unused)\n{\n\tstruct dwc3_ep\t\t*dep = s->private;\n\tstruct dwc3\t\t*dwc = dep->dwc;\n\tunsigned long\t\tflags;\n\tu64\t\t\tep_info;\n\tu32\t\t\tlower_32_bits;\n\tu32\t\t\tupper_32_bits;\n\tu32\t\t\treg;\n\tint\t\t\tret;\n\n\tret = pm_runtime_resume_and_get(dwc->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tspin_lock_irqsave(&dwc->lock, flags);\n\treg = DWC3_GDBGLSPMUX_EPSELECT(dep->number);\n\tdwc3_writel(dwc->regs, DWC3_GDBGLSPMUX, reg);\n\n\tlower_32_bits = dwc3_readl(dwc->regs, DWC3_GDBGEPINFO0);\n\tupper_32_bits = dwc3_readl(dwc->regs, DWC3_GDBGEPINFO1);\n\n\tep_info = ((u64)upper_32_bits << 32) | lower_32_bits;\n\tseq_printf(s, \"0x%016llx\\n\", ep_info);\n\tspin_unlock_irqrestore(&dwc->lock, flags);\n\n\tpm_runtime_put_sync(dwc->dev);\n\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(dwc3_tx_fifo_size);\nDEFINE_SHOW_ATTRIBUTE(dwc3_rx_fifo_size);\nDEFINE_SHOW_ATTRIBUTE(dwc3_tx_request_queue);\nDEFINE_SHOW_ATTRIBUTE(dwc3_rx_request_queue);\nDEFINE_SHOW_ATTRIBUTE(dwc3_rx_info_queue);\nDEFINE_SHOW_ATTRIBUTE(dwc3_descriptor_fetch_queue);\nDEFINE_SHOW_ATTRIBUTE(dwc3_event_queue);\nDEFINE_SHOW_ATTRIBUTE(dwc3_transfer_type);\nDEFINE_SHOW_ATTRIBUTE(dwc3_trb_ring);\nDEFINE_SHOW_ATTRIBUTE(dwc3_ep_info_register);\n\nstatic const struct dwc3_ep_file_map dwc3_ep_file_map[] = {\n\t{ \"tx_fifo_size\", &dwc3_tx_fifo_size_fops, },\n\t{ \"rx_fifo_size\", &dwc3_rx_fifo_size_fops, },\n\t{ \"tx_request_queue\", &dwc3_tx_request_queue_fops, },\n\t{ \"rx_request_queue\", &dwc3_rx_request_queue_fops, },\n\t{ \"rx_info_queue\", &dwc3_rx_info_queue_fops, },\n\t{ \"descriptor_fetch_queue\", &dwc3_descriptor_fetch_queue_fops, },\n\t{ \"event_queue\", &dwc3_event_queue_fops, },\n\t{ \"transfer_type\", &dwc3_transfer_type_fops, },\n\t{ \"trb_ring\", &dwc3_trb_ring_fops, },\n\t{ \"GDBGEPINFO\", &dwc3_ep_info_register_fops, },\n};\n\nvoid dwc3_debugfs_create_endpoint_dir(struct dwc3_ep *dep)\n{\n\tstruct dentry\t\t*dir;\n\tint\t\t\ti;\n\n\tdir = debugfs_create_dir(dep->name, dep->dwc->debug_root);\n\tfor (i = 0; i < ARRAY_SIZE(dwc3_ep_file_map); i++) {\n\t\tconst struct file_operations *fops = dwc3_ep_file_map[i].fops;\n\t\tconst char *name = dwc3_ep_file_map[i].name;\n\n\t\tdebugfs_create_file(name, 0444, dir, dep, fops);\n\t}\n}\n\nvoid dwc3_debugfs_remove_endpoint_dir(struct dwc3_ep *dep)\n{\n\tdebugfs_lookup_and_remove(dep->name, dep->dwc->debug_root);\n}\n\nvoid dwc3_debugfs_init(struct dwc3 *dwc)\n{\n\tstruct dentry\t\t*root;\n\n\tdwc->regset = kzalloc(sizeof(*dwc->regset), GFP_KERNEL);\n\tif (!dwc->regset)\n\t\treturn;\n\n\tdwc->dbg_lsp_select = DWC3_LSP_MUX_UNSELECTED;\n\n\tdwc->regset->regs = dwc3_regs;\n\tdwc->regset->nregs = ARRAY_SIZE(dwc3_regs);\n\tdwc->regset->base = dwc->regs - DWC3_GLOBALS_REGS_START;\n\tdwc->regset->dev = dwc->dev;\n\n\troot = debugfs_create_dir(dev_name(dwc->dev), usb_debug_root);\n\tdwc->debug_root = root;\n\tdebugfs_create_regset32(\"regdump\", 0444, root, dwc->regset);\n\tdebugfs_create_file(\"lsp_dump\", 0644, root, dwc, &dwc3_lsp_fops);\n\n\tif (IS_ENABLED(CONFIG_USB_DWC3_DUAL_ROLE))\n\t\tdebugfs_create_file(\"mode\", 0644, root, dwc,\n\t\t\t\t    &dwc3_mode_fops);\n\n\tif (IS_ENABLED(CONFIG_USB_DWC3_DUAL_ROLE) ||\n\t\t\tIS_ENABLED(CONFIG_USB_DWC3_GADGET)) {\n\t\tdebugfs_create_file(\"testmode\", 0644, root, dwc,\n\t\t\t\t&dwc3_testmode_fops);\n\t\tdebugfs_create_file(\"link_state\", 0644, root, dwc,\n\t\t\t\t    &dwc3_link_state_fops);\n\t}\n}\n\nvoid dwc3_debugfs_exit(struct dwc3 *dwc)\n{\n\tdebugfs_lookup_and_remove(dev_name(dwc->dev), usb_debug_root);\n\tkfree(dwc->regset);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}