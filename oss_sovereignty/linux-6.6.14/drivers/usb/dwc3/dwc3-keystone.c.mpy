{
  "module_name": "dwc3-keystone.c",
  "hash_id": "ad98b8831c1d7e6f5d46234dad27e1e86826261e04284f078b56a579d50c8f9c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/dwc3/dwc3-keystone.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n#include <linux/dma-mapping.h>\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/phy/phy.h>\n#include <linux/pm_runtime.h>\n\n \n#define USBSS_REVISION\t\t0x0000\n#define USBSS_SYSCONFIG\t\t0x0010\n#define USBSS_IRQ_EOI\t\t0x0018\n#define USBSS_IRQSTATUS_RAW_0\t0x0020\n#define USBSS_IRQSTATUS_0\t0x0024\n#define USBSS_IRQENABLE_SET_0\t0x0028\n#define USBSS_IRQENABLE_CLR_0\t0x002c\n\n \n#define USBSS_IRQ_EOI_LINE(n)\tBIT(n)\n#define USBSS_IRQ_EVENT_ST\tBIT(0)\n#define USBSS_IRQ_COREIRQ_EN\tBIT(0)\n#define USBSS_IRQ_COREIRQ_CLR\tBIT(0)\n\nstruct dwc3_keystone {\n\tstruct device\t\t\t*dev;\n\tvoid __iomem\t\t\t*usbss;\n\tstruct phy\t\t\t*usb3_phy;\n};\n\nstatic inline u32 kdwc3_readl(void __iomem *base, u32 offset)\n{\n\treturn readl(base + offset);\n}\n\nstatic inline void kdwc3_writel(void __iomem *base, u32 offset, u32 value)\n{\n\twritel(value, base + offset);\n}\n\nstatic void kdwc3_enable_irqs(struct dwc3_keystone *kdwc)\n{\n\tu32 val;\n\n\tval = kdwc3_readl(kdwc->usbss, USBSS_IRQENABLE_SET_0);\n\tval |= USBSS_IRQ_COREIRQ_EN;\n\tkdwc3_writel(kdwc->usbss, USBSS_IRQENABLE_SET_0, val);\n}\n\nstatic void kdwc3_disable_irqs(struct dwc3_keystone *kdwc)\n{\n\tu32 val;\n\n\tval = kdwc3_readl(kdwc->usbss, USBSS_IRQENABLE_SET_0);\n\tval &= ~USBSS_IRQ_COREIRQ_EN;\n\tkdwc3_writel(kdwc->usbss, USBSS_IRQENABLE_SET_0, val);\n}\n\nstatic irqreturn_t dwc3_keystone_interrupt(int irq, void *_kdwc)\n{\n\tstruct dwc3_keystone\t*kdwc = _kdwc;\n\n\tkdwc3_writel(kdwc->usbss, USBSS_IRQENABLE_CLR_0, USBSS_IRQ_COREIRQ_CLR);\n\tkdwc3_writel(kdwc->usbss, USBSS_IRQSTATUS_0, USBSS_IRQ_EVENT_ST);\n\tkdwc3_writel(kdwc->usbss, USBSS_IRQENABLE_SET_0, USBSS_IRQ_COREIRQ_EN);\n\tkdwc3_writel(kdwc->usbss, USBSS_IRQ_EOI, USBSS_IRQ_EOI_LINE(0));\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int kdwc3_probe(struct platform_device *pdev)\n{\n\tstruct device\t\t*dev = &pdev->dev;\n\tstruct device_node\t*node = pdev->dev.of_node;\n\tstruct dwc3_keystone\t*kdwc;\n\tint\t\t\terror, irq;\n\n\tkdwc = devm_kzalloc(dev, sizeof(*kdwc), GFP_KERNEL);\n\tif (!kdwc)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, kdwc);\n\n\tkdwc->dev = dev;\n\n\tkdwc->usbss = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(kdwc->usbss))\n\t\treturn PTR_ERR(kdwc->usbss);\n\n\t \n\tkdwc->usb3_phy = devm_phy_optional_get(dev, \"usb3-phy\");\n\tif (IS_ERR(kdwc->usb3_phy))\n\t\treturn dev_err_probe(dev, PTR_ERR(kdwc->usb3_phy), \"couldn't get usb3 phy\\n\");\n\n\tphy_pm_runtime_get_sync(kdwc->usb3_phy);\n\n\terror = phy_reset(kdwc->usb3_phy);\n\tif (error < 0) {\n\t\tdev_err(dev, \"usb3 phy reset failed: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\terror = phy_init(kdwc->usb3_phy);\n\tif (error < 0) {\n\t\tdev_err(dev, \"usb3 phy init failed: %d\\n\", error);\n\t\treturn error;\n\t}\n\n\terror = phy_power_on(kdwc->usb3_phy);\n\tif (error < 0) {\n\t\tdev_err(dev, \"usb3 phy power on failed: %d\\n\", error);\n\t\tphy_exit(kdwc->usb3_phy);\n\t\treturn error;\n\t}\n\n\tpm_runtime_enable(kdwc->dev);\n\terror = pm_runtime_get_sync(kdwc->dev);\n\tif (error < 0) {\n\t\tdev_err(kdwc->dev, \"pm_runtime_get_sync failed, error %d\\n\",\n\t\t\terror);\n\t\tgoto err_irq;\n\t}\n\n\t \n\tif (of_device_is_compatible(node, \"ti,am654-dwc3\"))\n\t\tgoto skip_irq;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0) {\n\t\terror = irq;\n\t\tgoto err_irq;\n\t}\n\n\terror = devm_request_irq(dev, irq, dwc3_keystone_interrupt, IRQF_SHARED,\n\t\t\tdev_name(dev), kdwc);\n\tif (error) {\n\t\tdev_err(dev, \"failed to request IRQ #%d --> %d\\n\",\n\t\t\t\tirq, error);\n\t\tgoto err_irq;\n\t}\n\n\tkdwc3_enable_irqs(kdwc);\n\nskip_irq:\n\terror = of_platform_populate(node, NULL, NULL, dev);\n\tif (error) {\n\t\tdev_err(&pdev->dev, \"failed to create dwc3 core\\n\");\n\t\tgoto err_core;\n\t}\n\n\treturn 0;\n\nerr_core:\n\tkdwc3_disable_irqs(kdwc);\nerr_irq:\n\tpm_runtime_put_sync(kdwc->dev);\n\tpm_runtime_disable(kdwc->dev);\n\tphy_power_off(kdwc->usb3_phy);\n\tphy_exit(kdwc->usb3_phy);\n\tphy_pm_runtime_put_sync(kdwc->usb3_phy);\n\n\treturn error;\n}\n\nstatic int kdwc3_remove_core(struct device *dev, void *c)\n{\n\tstruct platform_device *pdev = to_platform_device(dev);\n\n\tplatform_device_unregister(pdev);\n\n\treturn 0;\n}\n\nstatic void kdwc3_remove(struct platform_device *pdev)\n{\n\tstruct dwc3_keystone *kdwc = platform_get_drvdata(pdev);\n\tstruct device_node *node = pdev->dev.of_node;\n\n\tif (!of_device_is_compatible(node, \"ti,am654-dwc3\"))\n\t\tkdwc3_disable_irqs(kdwc);\n\n\tdevice_for_each_child(&pdev->dev, NULL, kdwc3_remove_core);\n\tpm_runtime_put_sync(kdwc->dev);\n\tpm_runtime_disable(kdwc->dev);\n\n\tphy_power_off(kdwc->usb3_phy);\n\tphy_exit(kdwc->usb3_phy);\n\tphy_pm_runtime_put_sync(kdwc->usb3_phy);\n}\n\nstatic const struct of_device_id kdwc3_of_match[] = {\n\t{ .compatible = \"ti,keystone-dwc3\", },\n\t{ .compatible = \"ti,am654-dwc3\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, kdwc3_of_match);\n\nstatic struct platform_driver kdwc3_driver = {\n\t.probe\t\t= kdwc3_probe,\n\t.remove_new\t= kdwc3_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"keystone-dwc3\",\n\t\t.of_match_table\t= kdwc3_of_match,\n\t},\n};\n\nmodule_platform_driver(kdwc3_driver);\n\nMODULE_ALIAS(\"platform:keystone-dwc3\");\nMODULE_AUTHOR(\"WingMan Kwok <w-kwok2@ti.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"DesignWare USB3 KEYSTONE Glue Layer\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}