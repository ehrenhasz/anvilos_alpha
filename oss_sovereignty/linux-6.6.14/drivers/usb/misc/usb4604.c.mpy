{
  "module_name": "usb4604.c",
  "hash_id": "eeab4efce6790f85f4b33ccc9954b3c59bdb38a8f6c34c1dd180079cc855ef44",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/misc/usb4604.c",
  "human_readable_source": "\n \n\n#include <linux/i2c.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/gpio/consumer.h>\n\nenum usb4604_mode {\n\tUSB4604_MODE_UNKNOWN,\n\tUSB4604_MODE_HUB,\n\tUSB4604_MODE_STANDBY,\n};\n\nstruct usb4604 {\n\tenum usb4604_mode\tmode;\n\tstruct device\t\t*dev;\n\tstruct gpio_desc\t*gpio_reset;\n};\n\nstatic void usb4604_reset(struct usb4604 *hub, int state)\n{\n\tgpiod_set_value_cansleep(hub->gpio_reset, state);\n\n\t \n\tif (state)\n\t\tmsleep(250);\n}\n\nstatic int usb4604_connect(struct usb4604 *hub)\n{\n\tstruct device *dev = hub->dev;\n\tstruct i2c_client *client = to_i2c_client(dev);\n\tint err;\n\tu8 connect_cmd[] = { 0xaa, 0x55, 0x00 };\n\n\tusb4604_reset(hub, 1);\n\n\terr = i2c_master_send(client, connect_cmd, ARRAY_SIZE(connect_cmd));\n\tif (err < 0) {\n\t\tusb4604_reset(hub, 0);\n\t\treturn err;\n\t}\n\n\thub->mode = USB4604_MODE_HUB;\n\tdev_dbg(dev, \"switched to HUB mode\\n\");\n\n\treturn 0;\n}\n\nstatic int usb4604_switch_mode(struct usb4604 *hub, enum usb4604_mode mode)\n{\n\tstruct device *dev = hub->dev;\n\tint err = 0;\n\n\tswitch (mode) {\n\tcase USB4604_MODE_HUB:\n\t\terr = usb4604_connect(hub);\n\t\tbreak;\n\n\tcase USB4604_MODE_STANDBY:\n\t\tusb4604_reset(hub, 0);\n\t\tdev_dbg(dev, \"switched to STANDBY mode\\n\");\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(dev, \"unknown mode is requested\\n\");\n\t\terr = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn err;\n}\n\nstatic int usb4604_probe(struct usb4604 *hub)\n{\n\tstruct device *dev = hub->dev;\n\tstruct device_node *np = dev->of_node;\n\tstruct gpio_desc *gpio;\n\tu32 mode = USB4604_MODE_HUB;\n\n\tgpio = devm_gpiod_get_optional(dev, \"reset\", GPIOD_OUT_LOW);\n\tif (IS_ERR(gpio))\n\t\treturn PTR_ERR(gpio);\n\thub->gpio_reset = gpio;\n\n\tif (of_property_read_u32(np, \"initial-mode\", &hub->mode))\n\t\thub->mode = mode;\n\n\treturn usb4604_switch_mode(hub, hub->mode);\n}\n\nstatic int usb4604_i2c_probe(struct i2c_client *i2c)\n{\n\tstruct usb4604 *hub;\n\n\thub = devm_kzalloc(&i2c->dev, sizeof(*hub), GFP_KERNEL);\n\tif (!hub)\n\t\treturn -ENOMEM;\n\n\ti2c_set_clientdata(i2c, hub);\n\thub->dev = &i2c->dev;\n\n\treturn usb4604_probe(hub);\n}\n\nstatic int __maybe_unused usb4604_i2c_suspend(struct device *dev)\n{\n\tstruct i2c_client *client = to_i2c_client(dev);\n\tstruct usb4604 *hub = i2c_get_clientdata(client);\n\n\tusb4604_switch_mode(hub, USB4604_MODE_STANDBY);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused usb4604_i2c_resume(struct device *dev)\n{\n\tstruct i2c_client *client = to_i2c_client(dev);\n\tstruct usb4604 *hub = i2c_get_clientdata(client);\n\n\tusb4604_switch_mode(hub, hub->mode);\n\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(usb4604_i2c_pm_ops, usb4604_i2c_suspend,\n\t\tusb4604_i2c_resume);\n\nstatic const struct i2c_device_id usb4604_id[] = {\n\t{ \"usb4604\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, usb4604_id);\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id usb4604_of_match[] = {\n\t{ .compatible = \"smsc,usb4604\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, usb4604_of_match);\n#endif\n\nstatic struct i2c_driver usb4604_i2c_driver = {\n\t.driver = {\n\t\t.name = \"usb4604\",\n\t\t.pm = pm_ptr(&usb4604_i2c_pm_ops),\n\t\t.of_match_table = of_match_ptr(usb4604_of_match),\n\t},\n\t.probe\t\t= usb4604_i2c_probe,\n\t.id_table\t= usb4604_id,\n};\nmodule_i2c_driver(usb4604_i2c_driver);\n\nMODULE_DESCRIPTION(\"USB4604 USB HUB driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}