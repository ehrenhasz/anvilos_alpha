{
  "module_name": "apple-mfi-fastcharge.c",
  "hash_id": "9c29df13c517fcaef22b74893c7d07c1240ba8ed8ad2af51ae70c01031ca2062",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/misc/apple-mfi-fastcharge.c",
  "human_readable_source": "\n \n\n \n#include <linux/module.h>\n#include <linux/power_supply.h>\n#include <linux/slab.h>\n#include <linux/usb.h>\n\nMODULE_AUTHOR(\"Bastien Nocera <hadess@hadess.net>\");\nMODULE_DESCRIPTION(\"Fast-charge control for Apple \\\"MFi\\\" devices\");\nMODULE_LICENSE(\"GPL\");\n\n#define TRICKLE_CURRENT_MA\t\t0\n#define FAST_CURRENT_MA\t\t\t2500\n\n#define APPLE_VENDOR_ID\t\t\t0x05ac\t \n\n \n\nstatic const struct usb_device_id mfi_fc_id_table[] = {\n\t{ .idVendor = APPLE_VENDOR_ID,\n\t  .match_flags = USB_DEVICE_ID_MATCH_VENDOR },\n\t{},\n};\n\nMODULE_DEVICE_TABLE(usb, mfi_fc_id_table);\n\n \nstruct mfi_device {\n\tstruct usb_device *udev;\n\tstruct power_supply *battery;\n\tint charge_type;\n};\n\nstatic int apple_mfi_fc_set_charge_type(struct mfi_device *mfi,\n\t\t\t\t\tconst union power_supply_propval *val)\n{\n\tint current_ma;\n\tint retval;\n\t__u8 request_type;\n\n\tif (mfi->charge_type == val->intval) {\n\t\tdev_dbg(&mfi->udev->dev, \"charge type %d already set\\n\",\n\t\t\t\tmfi->charge_type);\n\t\treturn 0;\n\t}\n\n\tswitch (val->intval) {\n\tcase POWER_SUPPLY_CHARGE_TYPE_TRICKLE:\n\t\tcurrent_ma = TRICKLE_CURRENT_MA;\n\t\tbreak;\n\tcase POWER_SUPPLY_CHARGE_TYPE_FAST:\n\t\tcurrent_ma = FAST_CURRENT_MA;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\trequest_type = USB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE;\n\tretval = usb_control_msg(mfi->udev, usb_sndctrlpipe(mfi->udev, 0),\n\t\t\t\t 0x40,  \n\t\t\t\t request_type,\n\t\t\t\t current_ma,  \n\t\t\t\t current_ma,  \n\t\t\t\t NULL, 0, USB_CTRL_GET_TIMEOUT);\n\tif (retval) {\n\t\tdev_dbg(&mfi->udev->dev, \"retval = %d\\n\", retval);\n\t\treturn retval;\n\t}\n\n\tmfi->charge_type = val->intval;\n\n\treturn 0;\n}\n\nstatic int apple_mfi_fc_get_property(struct power_supply *psy,\n\t\tenum power_supply_property psp,\n\t\tunion power_supply_propval *val)\n{\n\tstruct mfi_device *mfi = power_supply_get_drvdata(psy);\n\n\tdev_dbg(&mfi->udev->dev, \"prop: %d\\n\", psp);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tval->intval = mfi->charge_type;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_SCOPE:\n\t\tval->intval = POWER_SUPPLY_SCOPE_DEVICE;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODATA;\n\t}\n\n\treturn 0;\n}\n\nstatic int apple_mfi_fc_set_property(struct power_supply *psy,\n\t\tenum power_supply_property psp,\n\t\tconst union power_supply_propval *val)\n{\n\tstruct mfi_device *mfi = power_supply_get_drvdata(psy);\n\tint ret;\n\n\tdev_dbg(&mfi->udev->dev, \"prop: %d\\n\", psp);\n\n\tret = pm_runtime_get_sync(&mfi->udev->dev);\n\tif (ret < 0) {\n\t\tpm_runtime_put_noidle(&mfi->udev->dev);\n\t\treturn ret;\n\t}\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tret = apple_mfi_fc_set_charge_type(mfi, val);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\n\tpm_runtime_mark_last_busy(&mfi->udev->dev);\n\tpm_runtime_put_autosuspend(&mfi->udev->dev);\n\n\treturn ret;\n}\n\nstatic int apple_mfi_fc_property_is_writeable(struct power_supply *psy,\n\t\t\t\t\t      enum power_supply_property psp)\n{\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\treturn 1;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic enum power_supply_property apple_mfi_fc_properties[] = {\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE,\n\tPOWER_SUPPLY_PROP_SCOPE\n};\n\nstatic const struct power_supply_desc apple_mfi_fc_desc = {\n\t.name                   = \"apple_mfi_fastcharge\",\n\t.type                   = POWER_SUPPLY_TYPE_BATTERY,\n\t.properties             = apple_mfi_fc_properties,\n\t.num_properties         = ARRAY_SIZE(apple_mfi_fc_properties),\n\t.get_property           = apple_mfi_fc_get_property,\n\t.set_property           = apple_mfi_fc_set_property,\n\t.property_is_writeable  = apple_mfi_fc_property_is_writeable\n};\n\nstatic bool mfi_fc_match(struct usb_device *udev)\n{\n\tint idProduct;\n\n\tidProduct = le16_to_cpu(udev->descriptor.idProduct);\n\t \n\treturn (idProduct >= 0x1200 && idProduct <= 0x12ff);\n}\n\nstatic int mfi_fc_probe(struct usb_device *udev)\n{\n\tstruct power_supply_config battery_cfg = {};\n\tstruct mfi_device *mfi = NULL;\n\tint err;\n\n\tif (!mfi_fc_match(udev))\n\t\treturn -ENODEV;\n\n\tmfi = kzalloc(sizeof(struct mfi_device), GFP_KERNEL);\n\tif (!mfi)\n\t\treturn -ENOMEM;\n\n\tbattery_cfg.drv_data = mfi;\n\n\tmfi->charge_type = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n\tmfi->battery = power_supply_register(&udev->dev,\n\t\t\t\t\t\t&apple_mfi_fc_desc,\n\t\t\t\t\t\t&battery_cfg);\n\tif (IS_ERR(mfi->battery)) {\n\t\tdev_err(&udev->dev, \"Can't register battery\\n\");\n\t\terr = PTR_ERR(mfi->battery);\n\t\tkfree(mfi);\n\t\treturn err;\n\t}\n\n\tmfi->udev = usb_get_dev(udev);\n\tdev_set_drvdata(&udev->dev, mfi);\n\n\treturn 0;\n}\n\nstatic void mfi_fc_disconnect(struct usb_device *udev)\n{\n\tstruct mfi_device *mfi;\n\n\tmfi = dev_get_drvdata(&udev->dev);\n\tif (mfi->battery)\n\t\tpower_supply_unregister(mfi->battery);\n\tdev_set_drvdata(&udev->dev, NULL);\n\tusb_put_dev(mfi->udev);\n\tkfree(mfi);\n}\n\nstatic struct usb_device_driver mfi_fc_driver = {\n\t.name =\t\t\"apple-mfi-fastcharge\",\n\t.probe =\tmfi_fc_probe,\n\t.disconnect =\tmfi_fc_disconnect,\n\t.id_table =\tmfi_fc_id_table,\n\t.match =\tmfi_fc_match,\n\t.generic_subclass = 1,\n};\n\nstatic int __init mfi_fc_driver_init(void)\n{\n\treturn usb_register_device_driver(&mfi_fc_driver, THIS_MODULE);\n}\n\nstatic void __exit mfi_fc_driver_exit(void)\n{\n\tusb_deregister_device_driver(&mfi_fc_driver);\n}\n\nmodule_init(mfi_fc_driver_init);\nmodule_exit(mfi_fc_driver_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}