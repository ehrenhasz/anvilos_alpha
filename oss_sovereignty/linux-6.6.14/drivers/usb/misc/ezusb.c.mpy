{
  "module_name": "ezusb.c",
  "hash_id": "ec4fd73f315d8431d0b035174d0036f346aad432f2f4b67095ef3fab74fcc4b9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/misc/ezusb.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/usb.h>\n#include <linux/firmware.h>\n#include <linux/ihex.h>\n#include <linux/usb/ezusb.h>\n\nstruct ezusb_fx_type {\n\t \n\tunsigned short cpucs_reg;\n\tunsigned short max_internal_adress;\n};\n\nstatic const struct ezusb_fx_type ezusb_fx1 = {\n\t.cpucs_reg = 0x7F92,\n\t.max_internal_adress = 0x1B3F,\n};\n\n \n#define WRITE_INT_RAM 0xA0\n#define WRITE_EXT_RAM 0xA3\n\nstatic int ezusb_writememory(struct usb_device *dev, int address,\n\t\t\t\tunsigned char *data, int length, __u8 request)\n{\n\tif (!dev)\n\t\treturn -ENODEV;\n\n\treturn usb_control_msg_send(dev, 0, request,\n\t\t\t\t USB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\n\t\t\t\t address, 0, data, length, 3000, GFP_KERNEL);\n}\n\nstatic int ezusb_set_reset(struct usb_device *dev, unsigned short cpucs_reg,\n\t\t\t   unsigned char reset_bit)\n{\n\tint response = ezusb_writememory(dev, cpucs_reg, &reset_bit, 1, WRITE_INT_RAM);\n\tif (response < 0)\n\t\tdev_err(&dev->dev, \"%s-%d failed: %d\\n\",\n\t\t\t\t\t\t__func__, reset_bit, response);\n\treturn response;\n}\n\nint ezusb_fx1_set_reset(struct usb_device *dev, unsigned char reset_bit)\n{\n\treturn ezusb_set_reset(dev, ezusb_fx1.cpucs_reg, reset_bit);\n}\nEXPORT_SYMBOL_GPL(ezusb_fx1_set_reset);\n\nstatic int ezusb_ihex_firmware_download(struct usb_device *dev,\n\t\t\t\t\tstruct ezusb_fx_type fx,\n\t\t\t\t\tconst char *firmware_path)\n{\n\tint ret = -ENOENT;\n\tconst struct firmware *firmware = NULL;\n\tconst struct ihex_binrec *record;\n\n\tif (request_ihex_firmware(&firmware, firmware_path,\n\t\t\t\t  &dev->dev)) {\n\t\tdev_err(&dev->dev,\n\t\t\t\"%s - request \\\"%s\\\" failed\\n\",\n\t\t\t__func__, firmware_path);\n\t\tgoto out;\n\t}\n\n\tret = ezusb_set_reset(dev, fx.cpucs_reg, 0);\n\tif (ret < 0)\n\t\tgoto out;\n\n\trecord = (const struct ihex_binrec *)firmware->data;\n\tfor (; record; record = ihex_next_binrec(record)) {\n\t\tif (be32_to_cpu(record->addr) > fx.max_internal_adress) {\n\t\t\tret = ezusb_writememory(dev, be32_to_cpu(record->addr),\n\t\t\t\t\t\t(unsigned char *)record->data,\n\t\t\t\t\t\tbe16_to_cpu(record->len), WRITE_EXT_RAM);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(&dev->dev, \"%s - ezusb_writememory \"\n\t\t\t\t\t\"failed writing internal memory \"\n\t\t\t\t\t\"(%d %04X %p %d)\\n\", __func__, ret,\n\t\t\t\t\tbe32_to_cpu(record->addr), record->data,\n\t\t\t\t\tbe16_to_cpu(record->len));\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t}\n\t}\n\n\tret = ezusb_set_reset(dev, fx.cpucs_reg, 1);\n\tif (ret < 0)\n\t\tgoto out;\n\trecord = (const struct ihex_binrec *)firmware->data;\n\tfor (; record; record = ihex_next_binrec(record)) {\n\t\tif (be32_to_cpu(record->addr) <= fx.max_internal_adress) {\n\t\t\tret = ezusb_writememory(dev, be32_to_cpu(record->addr),\n\t\t\t\t\t\t(unsigned char *)record->data,\n\t\t\t\t\t\tbe16_to_cpu(record->len), WRITE_INT_RAM);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(&dev->dev, \"%s - ezusb_writememory \"\n\t\t\t\t\t\"failed writing external memory \"\n\t\t\t\t\t\"(%d %04X %p %d)\\n\", __func__, ret,\n\t\t\t\t\tbe32_to_cpu(record->addr), record->data,\n\t\t\t\t\tbe16_to_cpu(record->len));\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t}\n\t}\n\tret = ezusb_set_reset(dev, fx.cpucs_reg, 0);\nout:\n\trelease_firmware(firmware);\n\treturn ret;\n}\n\nint ezusb_fx1_ihex_firmware_download(struct usb_device *dev,\n\t\t\t\t     const char *firmware_path)\n{\n\treturn ezusb_ihex_firmware_download(dev, ezusb_fx1, firmware_path);\n}\nEXPORT_SYMBOL_GPL(ezusb_fx1_ihex_firmware_download);\n\n#if 0\n \nstatic struct ezusb_fx_type ezusb_fx2 = {\n\t.cpucs_reg = 0xE600,\n\t.max_internal_adress = 0x3FFF,\n};\n\nint ezusb_fx2_set_reset(struct usb_device *dev, unsigned char reset_bit)\n{\n\treturn ezusb_set_reset(dev, ezusb_fx2.cpucs_reg, reset_bit);\n}\nEXPORT_SYMBOL_GPL(ezusb_fx2_set_reset);\n\nint ezusb_fx2_ihex_firmware_download(struct usb_device *dev,\n\t\t\t\t     const char *firmware_path)\n{\n\treturn ezusb_ihex_firmware_download(dev, ezusb_fx2, firmware_path);\n}\nEXPORT_SYMBOL_GPL(ezusb_fx2_ihex_firmware_download);\n#endif\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}