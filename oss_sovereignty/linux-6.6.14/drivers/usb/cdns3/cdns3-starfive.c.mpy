{
  "module_name": "cdns3-starfive.c",
  "hash_id": "2315acc8f120a649bbc58b01335da2f3ea5000180788319225e8d51eac564eda",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/cdns3/cdns3-starfive.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/clk.h>\n#include <linux/module.h>\n#include <linux/mfd/syscon.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/io.h>\n#include <linux/of_platform.h>\n#include <linux/reset.h>\n#include <linux/regmap.h>\n#include <linux/usb/otg.h>\n#include \"core.h\"\n\n#define USB_STRAP_HOST\t\t\tBIT(17)\n#define USB_STRAP_DEVICE\t\tBIT(18)\n#define USB_STRAP_MASK\t\t\tGENMASK(18, 16)\n\n#define USB_SUSPENDM_HOST\t\tBIT(19)\n#define USB_SUSPENDM_MASK\t\tBIT(19)\n\n#define USB_MISC_CFG_MASK\t\tGENMASK(23, 20)\n#define USB_SUSPENDM_BYPS\t\tBIT(20)\n#define USB_PLL_EN\t\t\tBIT(22)\n#define USB_REFCLK_MODE\t\t\tBIT(23)\n\nstruct cdns_starfive {\n\tstruct device *dev;\n\tstruct regmap *stg_syscon;\n\tstruct reset_control *resets;\n\tstruct clk_bulk_data *clks;\n\tint num_clks;\n\tu32 stg_usb_mode;\n};\n\nstatic void cdns_mode_init(struct platform_device *pdev,\n\t\t\t   struct cdns_starfive *data)\n{\n\tenum usb_dr_mode mode;\n\n\tregmap_update_bits(data->stg_syscon, data->stg_usb_mode,\n\t\t\t   USB_MISC_CFG_MASK,\n\t\t\t   USB_SUSPENDM_BYPS | USB_PLL_EN | USB_REFCLK_MODE);\n\n\t \n\tmode = usb_get_dr_mode(&pdev->dev);\n\n\tswitch (mode) {\n\tcase USB_DR_MODE_HOST:\n\t\tregmap_update_bits(data->stg_syscon,\n\t\t\t\t   data->stg_usb_mode,\n\t\t\t\t   USB_STRAP_MASK,\n\t\t\t\t   USB_STRAP_HOST);\n\t\tregmap_update_bits(data->stg_syscon,\n\t\t\t\t   data->stg_usb_mode,\n\t\t\t\t   USB_SUSPENDM_MASK,\n\t\t\t\t   USB_SUSPENDM_HOST);\n\t\tbreak;\n\n\tcase USB_DR_MODE_PERIPHERAL:\n\t\tregmap_update_bits(data->stg_syscon, data->stg_usb_mode,\n\t\t\t\t   USB_STRAP_MASK, USB_STRAP_DEVICE);\n\t\tregmap_update_bits(data->stg_syscon, data->stg_usb_mode,\n\t\t\t\t   USB_SUSPENDM_MASK, 0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic int cdns_clk_rst_init(struct cdns_starfive *data)\n{\n\tint ret;\n\n\tret = clk_bulk_prepare_enable(data->num_clks, data->clks);\n\tif (ret)\n\t\treturn dev_err_probe(data->dev, ret,\n\t\t\t\t     \"failed to enable clocks\\n\");\n\n\tret = reset_control_deassert(data->resets);\n\tif (ret) {\n\t\tdev_err(data->dev, \"failed to reset clocks\\n\");\n\t\tgoto err_clk_init;\n\t}\n\n\treturn ret;\n\nerr_clk_init:\n\tclk_bulk_disable_unprepare(data->num_clks, data->clks);\n\treturn ret;\n}\n\nstatic void cdns_clk_rst_deinit(struct cdns_starfive *data)\n{\n\treset_control_assert(data->resets);\n\tclk_bulk_disable_unprepare(data->num_clks, data->clks);\n}\n\nstatic int cdns_starfive_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct cdns_starfive *data;\n\tunsigned int args;\n\tint ret;\n\n\tdata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdata->dev = dev;\n\n\tdata->stg_syscon =\n\t\tsyscon_regmap_lookup_by_phandle_args(pdev->dev.of_node,\n\t\t\t\t\t\t     \"starfive,stg-syscon\", 1, &args);\n\n\tif (IS_ERR(data->stg_syscon))\n\t\treturn dev_err_probe(dev, PTR_ERR(data->stg_syscon),\n\t\t\t\t     \"Failed to parse starfive,stg-syscon\\n\");\n\n\tdata->stg_usb_mode = args;\n\n\tdata->num_clks = devm_clk_bulk_get_all(data->dev, &data->clks);\n\tif (data->num_clks < 0)\n\t\treturn dev_err_probe(data->dev, -ENODEV,\n\t\t\t\t     \"Failed to get clocks\\n\");\n\n\tdata->resets = devm_reset_control_array_get_exclusive(data->dev);\n\tif (IS_ERR(data->resets))\n\t\treturn dev_err_probe(data->dev, PTR_ERR(data->resets),\n\t\t\t\t     \"Failed to get resets\");\n\n\tcdns_mode_init(pdev, data);\n\tret = cdns_clk_rst_init(data);\n\tif (ret)\n\t\treturn ret;\n\n\tret = of_platform_populate(dev->of_node, NULL, NULL, dev);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to create children\\n\");\n\t\tcdns_clk_rst_deinit(data);\n\t\treturn ret;\n\t}\n\n\tdevice_set_wakeup_capable(dev, true);\n\tpm_runtime_set_active(dev);\n\tpm_runtime_enable(dev);\n\tplatform_set_drvdata(pdev, data);\n\n\treturn 0;\n}\n\nstatic int cdns_starfive_remove_core(struct device *dev, void *c)\n{\n\tstruct platform_device *pdev = to_platform_device(dev);\n\n\tplatform_device_unregister(pdev);\n\n\treturn 0;\n}\n\nstatic void cdns_starfive_remove(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct cdns_starfive *data = dev_get_drvdata(dev);\n\n\tpm_runtime_get_sync(dev);\n\tdevice_for_each_child(dev, NULL, cdns_starfive_remove_core);\n\n\tpm_runtime_disable(dev);\n\tpm_runtime_put_noidle(dev);\n\tcdns_clk_rst_deinit(data);\n\tplatform_set_drvdata(pdev, NULL);\n}\n\n#ifdef CONFIG_PM\nstatic int cdns_starfive_runtime_resume(struct device *dev)\n{\n\tstruct cdns_starfive *data = dev_get_drvdata(dev);\n\n\treturn clk_bulk_prepare_enable(data->num_clks, data->clks);\n}\n\nstatic int cdns_starfive_runtime_suspend(struct device *dev)\n{\n\tstruct cdns_starfive *data = dev_get_drvdata(dev);\n\n\tclk_bulk_disable_unprepare(data->num_clks, data->clks);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int cdns_starfive_resume(struct device *dev)\n{\n\tstruct cdns_starfive *data = dev_get_drvdata(dev);\n\n\treturn cdns_clk_rst_init(data);\n}\n\nstatic int cdns_starfive_suspend(struct device *dev)\n{\n\tstruct cdns_starfive *data = dev_get_drvdata(dev);\n\n\tcdns_clk_rst_deinit(data);\n\n\treturn 0;\n}\n#endif\n#endif\n\nstatic const struct dev_pm_ops cdns_starfive_pm_ops = {\n\tSET_RUNTIME_PM_OPS(cdns_starfive_runtime_suspend,\n\t\t\t   cdns_starfive_runtime_resume, NULL)\n\tSET_SYSTEM_SLEEP_PM_OPS(cdns_starfive_suspend, cdns_starfive_resume)\n};\n\nstatic const struct of_device_id cdns_starfive_of_match[] = {\n\t{ .compatible = \"starfive,jh7110-usb\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, cdns_starfive_of_match);\n\nstatic struct platform_driver cdns_starfive_driver = {\n\t.probe\t\t= cdns_starfive_probe,\n\t.remove_new\t= cdns_starfive_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"cdns3-starfive\",\n\t\t.of_match_table\t= cdns_starfive_of_match,\n\t\t.pm\t= &cdns_starfive_pm_ops,\n\t},\n};\nmodule_platform_driver(cdns_starfive_driver);\n\nMODULE_ALIAS(\"platform:cdns3-starfive\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Cadence USB3 StarFive Glue Layer\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}