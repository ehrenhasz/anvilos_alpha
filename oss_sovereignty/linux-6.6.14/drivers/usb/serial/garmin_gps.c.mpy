{
  "module_name": "garmin_gps.c",
  "hash_id": "5d9b639516a96b5b7bd417674871e42200886550a87717edf6edfcc9747e4b48",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/serial/garmin_gps.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/slab.h>\n#include <linux/timer.h>\n#include <linux/tty.h>\n#include <linux/tty_driver.h>\n#include <linux/tty_flip.h>\n#include <linux/module.h>\n#include <linux/spinlock.h>\n#include <linux/uaccess.h>\n#include <linux/atomic.h>\n#include <linux/usb.h>\n#include <linux/usb/serial.h>\n\n \nstatic int initial_mode = 1;\n\n#define GARMIN_VENDOR_ID             0x091E\n\n \n\n#define VERSION_MAJOR\t0\n#define VERSION_MINOR\t36\n\n#define _STR(s) #s\n#define _DRIVER_VERSION(a, b) \"v\" _STR(a) \".\" _STR(b)\n#define DRIVER_VERSION _DRIVER_VERSION(VERSION_MAJOR, VERSION_MINOR)\n#define DRIVER_AUTHOR \"hermann kneissel\"\n#define DRIVER_DESC \"garmin gps driver\"\n\n \n#define EINVPKT\t1000\t \n\n\n \n#define GARMIN_PKTHDR_LENGTH\t12\n\n \n#define MAX_SERIAL_PKT_SIZ (3 + 255 + 3)\n\n \n#define MAX_SERIAL_PKT_SIZ_STUFFED (MAX_SERIAL_PKT_SIZ + 256)\n\n \n#define GPS_IN_BUFSIZ  (GARMIN_PKTHDR_LENGTH+MAX_SERIAL_PKT_SIZ)\n\n \n#define GPS_OUT_BUFSIZ (GARMIN_PKTHDR_LENGTH+MAX_SERIAL_PKT_SIZ_STUFFED)\n\n \n#define GSP_INITIAL_OFFSET (GARMIN_PKTHDR_LENGTH-2)\n\n \n#define PRIVPKTSIZ (GARMIN_PKTHDR_LENGTH+4)\n\n#define GARMIN_LAYERID_TRANSPORT  0\n#define GARMIN_LAYERID_APPL      20\n \n#define GARMIN_LAYERID_PRIVATE\t0x01106E4B\n\n#define GARMIN_PKTID_PVT_DATA\t51\n#define GARMIN_PKTID_L001_COMMAND_DATA 10\n\n#define CMND_ABORT_TRANSFER 0\n\n \n#define PRIV_PKTID_SET_DEBUG\t1\n#define PRIV_PKTID_SET_MODE\t2\n#define PRIV_PKTID_INFO_REQ\t3\n#define PRIV_PKTID_INFO_RESP\t4\n#define PRIV_PKTID_RESET_REQ\t5\n#define PRIV_PKTID_SET_DEF_MODE\t6\n\n\n#define ETX\t0x03\n#define DLE\t0x10\n#define ACK\t0x06\n#define NAK\t0x15\n\n \nstruct garmin_packet {\n\tstruct list_head  list;\n\tint               seq;\n\t \n\tint               size;\n\t__u8              data[];\n};\n\n \nstruct garmin_data {\n\t__u8   state;\n\t__u16  flags;\n\t__u8   mode;\n\t__u8   count;\n\t__u8   pkt_id;\n\t__u32  serial_num;\n\tstruct timer_list timer;\n\tstruct usb_serial_port *port;\n\tint    seq_counter;\n\tint    insize;\n\tint    outsize;\n\t__u8   inbuffer [GPS_IN_BUFSIZ];   \n\t__u8   outbuffer[GPS_OUT_BUFSIZ];  \n\t__u8   privpkt[4*6];\n\tspinlock_t lock;\n\tstruct list_head pktlist;\n\tstruct usb_anchor write_urbs;\n};\n\n\n#define STATE_NEW            0\n#define STATE_INITIAL_DELAY  1\n#define STATE_TIMEOUT        2\n#define STATE_SESSION_REQ1   3\n#define STATE_SESSION_REQ2   4\n#define STATE_ACTIVE         5\n\n#define STATE_RESET\t     8\n#define STATE_DISCONNECTED   9\n#define STATE_WAIT_TTY_ACK  10\n#define STATE_GSP_WAIT_DATA 11\n\n#define MODE_NATIVE          0\n#define MODE_GARMIN_SERIAL   1\n\n \n#define FLAGS_SESSION_REPLY_MASK  0x00C0\n#define FLAGS_SESSION_REPLY1_SEEN 0x0080\n#define FLAGS_SESSION_REPLY2_SEEN 0x0040\n#define FLAGS_BULK_IN_ACTIVE      0x0020\n#define FLAGS_BULK_IN_RESTART     0x0010\n#define FLAGS_THROTTLED           0x0008\n#define APP_REQ_SEEN              0x0004\n#define APP_RESP_SEEN             0x0002\n#define CLEAR_HALT_REQUIRED       0x0001\n\n#define FLAGS_QUEUING             0x0100\n#define FLAGS_DROP_DATA           0x0800\n\n#define FLAGS_GSP_SKIP            0x1000\n#define FLAGS_GSP_DLESEEN         0x2000\n\n\n\n\n\n\n \nstatic int gsp_next_packet(struct garmin_data *garmin_data_p);\nstatic int garmin_write_bulk(struct usb_serial_port *port,\n\t\t\t     const unsigned char *buf, int count,\n\t\t\t     int dismiss_ack);\n\n \nstatic unsigned char const GARMIN_START_SESSION_REQ[]\n\t= { 0, 0, 0, 0,  5, 0, 0, 0, 0, 0, 0, 0 };\nstatic unsigned char const GARMIN_START_SESSION_REPLY[]\n\t= { 0, 0, 0, 0,  6, 0, 0, 0, 4, 0, 0, 0 };\nstatic unsigned char const GARMIN_BULK_IN_AVAIL_REPLY[]\n\t= { 0, 0, 0, 0,  2, 0, 0, 0, 0, 0, 0, 0 };\nstatic unsigned char const GARMIN_STOP_TRANSFER_REQ[]\n\t= { 20, 0, 0, 0,  10, 0, 0, 0, 2, 0, 0, 0, 0, 0 };\nstatic unsigned char const GARMIN_STOP_TRANSFER_REQ_V2[]\n\t= { 20, 0, 0, 0,  10, 0, 0, 0, 1, 0, 0, 0, 0 };\n\n \n#if 0\nstatic unsigned char const GARMIN_APP_LAYER_REPLY[]\n\t= { 0x14, 0, 0, 0 };\nstatic unsigned char const GARMIN_START_PVT_REQ[]\n\t= { 20, 0, 0, 0,  10, 0, 0, 0, 2, 0, 0, 0, 49, 0 };\nstatic unsigned char const GARMIN_STOP_PVT_REQ[]\n\t= { 20, 0, 0, 0,  10, 0, 0, 0, 2, 0, 0, 0, 50, 0 };\nstatic unsigned char const PRIVATE_REQ[]\n\t=    { 0x4B, 0x6E, 0x10, 0x01,  0xFF, 0, 0, 0, 0xFF, 0, 0, 0 };\n#endif\n\n\nstatic const struct usb_device_id id_table[] = {\n\t \n\t{ USB_DEVICE(GARMIN_VENDOR_ID, 3) },\n\t{ }\t\t\t\t\t \n};\nMODULE_DEVICE_TABLE(usb, id_table);\n\n\nstatic inline int getLayerId(const __u8 *usbPacket)\n{\n\treturn __le32_to_cpup((__le32 *)(usbPacket));\n}\n\nstatic inline int getPacketId(const __u8 *usbPacket)\n{\n\treturn __le32_to_cpup((__le32 *)(usbPacket+4));\n}\n\nstatic inline int getDataLength(const __u8 *usbPacket)\n{\n\treturn __le32_to_cpup((__le32 *)(usbPacket+8));\n}\n\n\n \nstatic inline int isAbortTrfCmnd(const unsigned char *buf)\n{\n\tif (memcmp(buf, GARMIN_STOP_TRANSFER_REQ,\n\t\t\tsizeof(GARMIN_STOP_TRANSFER_REQ)) == 0 ||\n\t    memcmp(buf, GARMIN_STOP_TRANSFER_REQ_V2,\n\t\t\tsizeof(GARMIN_STOP_TRANSFER_REQ_V2)) == 0)\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\n\n\nstatic void send_to_tty(struct usb_serial_port *port,\n\t\t\tchar *data, unsigned int actual_length)\n{\n\tif (actual_length) {\n\t\tusb_serial_debug_data(&port->dev, __func__, actual_length, data);\n\t\ttty_insert_flip_string(&port->port, data, actual_length);\n\t\ttty_flip_buffer_push(&port->port);\n\t}\n}\n\n\n \n\n \nstatic int pkt_add(struct garmin_data *garmin_data_p,\n\t\t   unsigned char *data, unsigned int data_length)\n{\n\tint state = 0;\n\tint result = 0;\n\tunsigned long flags;\n\tstruct garmin_packet *pkt;\n\n\t \n\tif (data_length) {\n\t\tpkt = kmalloc(sizeof(struct garmin_packet)+data_length,\n\t\t\t\t\t\t\t\tGFP_ATOMIC);\n\t\tif (!pkt)\n\t\t\treturn 0;\n\n\t\tpkt->size = data_length;\n\t\tmemcpy(pkt->data, data, data_length);\n\n\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\tgarmin_data_p->flags |= FLAGS_QUEUING;\n\t\tresult = list_empty(&garmin_data_p->pktlist);\n\t\tpkt->seq = garmin_data_p->seq_counter++;\n\t\tlist_add_tail(&pkt->list, &garmin_data_p->pktlist);\n\t\tstate = garmin_data_p->state;\n\t\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\t\tdev_dbg(&garmin_data_p->port->dev,\n\t\t\t\"%s - added: pkt: %d - %d bytes\\n\", __func__,\n\t\t\tpkt->seq, data_length);\n\n\t\t \n\t\tif (result && (state == STATE_GSP_WAIT_DATA))\n\t\t\tgsp_next_packet(garmin_data_p);\n\t}\n\treturn result;\n}\n\n\n \nstatic struct garmin_packet *pkt_pop(struct garmin_data *garmin_data_p)\n{\n\tunsigned long flags;\n\tstruct garmin_packet *result = NULL;\n\n\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\tif (!list_empty(&garmin_data_p->pktlist)) {\n\t\tresult = (struct garmin_packet *)garmin_data_p->pktlist.next;\n\t\tlist_del(&result->list);\n\t}\n\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\treturn result;\n}\n\n\n \nstatic void pkt_clear(struct garmin_data *garmin_data_p)\n{\n\tunsigned long flags;\n\tstruct garmin_packet *result = NULL;\n\n\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\twhile (!list_empty(&garmin_data_p->pktlist)) {\n\t\tresult = (struct garmin_packet *)garmin_data_p->pktlist.next;\n\t\tlist_del(&result->list);\n\t\tkfree(result);\n\t}\n\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n}\n\n\n \n\n \nstatic int gsp_send_ack(struct garmin_data *garmin_data_p, __u8 pkt_id)\n{\n\t__u8 pkt[10];\n\t__u8 cksum = 0;\n\t__u8 *ptr = pkt;\n\tunsigned  l = 0;\n\n\tdev_dbg(&garmin_data_p->port->dev, \"%s - pkt-id: 0x%X.\\n\", __func__,\n\t\t\tpkt_id);\n\n\t*ptr++ = DLE;\n\t*ptr++ = ACK;\n\tcksum += ACK;\n\n\t*ptr++ = 2;\n\tcksum += 2;\n\n\t*ptr++ = pkt_id;\n\tcksum += pkt_id;\n\n\tif (pkt_id == DLE)\n\t\t*ptr++ = DLE;\n\n\t*ptr++ = 0;\n\t*ptr++ = (-cksum) & 0xFF;\n\t*ptr++ = DLE;\n\t*ptr++ = ETX;\n\n\tl = ptr-pkt;\n\n\tsend_to_tty(garmin_data_p->port, pkt, l);\n\treturn 0;\n}\n\n\n\n \nstatic int gsp_rec_packet(struct garmin_data *garmin_data_p, int count)\n{\n\tstruct device *dev = &garmin_data_p->port->dev;\n\tunsigned long flags;\n\tconst __u8 *recpkt = garmin_data_p->inbuffer+GSP_INITIAL_OFFSET;\n\t__le32 *usbdata = (__le32 *) garmin_data_p->inbuffer;\n\tint cksum = 0;\n\tint n = 0;\n\tint pktid = recpkt[0];\n\tint size = recpkt[1];\n\n\tusb_serial_debug_data(&garmin_data_p->port->dev, __func__,\n\t\t\t      count-GSP_INITIAL_OFFSET, recpkt);\n\n\tif (size != (count-GSP_INITIAL_OFFSET-3)) {\n\t\tdev_dbg(dev, \"%s - invalid size, expected %d bytes, got %d\\n\",\n\t\t\t__func__, size, (count-GSP_INITIAL_OFFSET-3));\n\t\treturn -EINVPKT;\n\t}\n\n\tcksum += *recpkt++;\n\tcksum += *recpkt++;\n\n\t \n\tif ((__u8 *)&(usbdata[3]) != recpkt) {\n\t\tdev_dbg(dev, \"%s - ptr mismatch %p - %p\\n\", __func__,\n\t\t\t&(usbdata[4]), recpkt);\n\t\treturn -EINVPKT;\n\t}\n\n\twhile (n < size) {\n\t\tcksum += *recpkt++;\n\t\tn++;\n\t}\n\n\tif (((cksum + *recpkt) & 0xff) != 0) {\n\t\tdev_dbg(dev, \"%s - invalid checksum, expected %02x, got %02x\\n\",\n\t\t\t__func__, -cksum & 0xff, *recpkt);\n\t\treturn -EINVPKT;\n\t}\n\n\tusbdata[0] = __cpu_to_le32(GARMIN_LAYERID_APPL);\n\tusbdata[1] = __cpu_to_le32(pktid);\n\tusbdata[2] = __cpu_to_le32(size);\n\n\tgarmin_write_bulk(garmin_data_p->port, garmin_data_p->inbuffer,\n\t\t\t   GARMIN_PKTHDR_LENGTH+size, 0);\n\n\t \n\tif (isAbortTrfCmnd(garmin_data_p->inbuffer)) {\n\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\tgarmin_data_p->flags |= FLAGS_DROP_DATA;\n\t\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\t\tpkt_clear(garmin_data_p);\n\t}\n\n\treturn count;\n}\n\n\n\n \n\nstatic int gsp_receive(struct garmin_data *garmin_data_p,\n\t\t       const unsigned char *buf, int count)\n{\n\tstruct device *dev = &garmin_data_p->port->dev;\n\tunsigned long flags;\n\tint offs = 0;\n\tint ack_or_nak_seen = 0;\n\t__u8 *dest;\n\tint size;\n\t \n\tint dleSeen;\n\t \n\tint skip;\n\t__u8 data;\n\n\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\tdest = garmin_data_p->inbuffer;\n\tsize = garmin_data_p->insize;\n\tdleSeen = garmin_data_p->flags & FLAGS_GSP_DLESEEN;\n\tskip = garmin_data_p->flags & FLAGS_GSP_SKIP;\n\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\t \n\n\tif (size == 0)\n\t\tsize = GSP_INITIAL_OFFSET;\n\n\twhile (offs < count) {\n\n\t\tdata = *(buf+offs);\n\t\toffs++;\n\n\t\tif (data == DLE) {\n\t\t\tif (skip) {  \n\t\t\t\tskip = 0;\n\t\t\t\tsize = GSP_INITIAL_OFFSET;\n\t\t\t\tdleSeen = 1;\n\t\t\t} else if (dleSeen) {\n\t\t\t\tdest[size++] = data;\n\t\t\t\tdleSeen = 0;\n\t\t\t} else {\n\t\t\t\tdleSeen = 1;\n\t\t\t}\n\t\t} else if (data == ETX) {\n\t\t\tif (dleSeen) {\n\t\t\t\t \n\n\t\t\t\tdata = dest[GSP_INITIAL_OFFSET];\n\n\t\t\t\tif (data == ACK) {\n\t\t\t\t\tack_or_nak_seen = ACK;\n\t\t\t\t\tdev_dbg(dev, \"ACK packet complete.\\n\");\n\t\t\t\t} else if (data == NAK) {\n\t\t\t\t\tack_or_nak_seen = NAK;\n\t\t\t\t\tdev_dbg(dev, \"NAK packet complete.\\n\");\n\t\t\t\t} else {\n\t\t\t\t\tdev_dbg(dev, \"packet complete - id=0x%X.\\n\",\n\t\t\t\t\t\t\tdata);\n\t\t\t\t\tgsp_rec_packet(garmin_data_p, size);\n\t\t\t\t}\n\n\t\t\t\tskip = 1;\n\t\t\t\tsize = GSP_INITIAL_OFFSET;\n\t\t\t\tdleSeen = 0;\n\t\t\t} else {\n\t\t\t\tdest[size++] = data;\n\t\t\t}\n\t\t} else if (!skip) {\n\n\t\t\tif (dleSeen) {\n\t\t\t\tsize = GSP_INITIAL_OFFSET;\n\t\t\t\tdleSeen = 0;\n\t\t\t}\n\n\t\t\tdest[size++] = data;\n\t\t}\n\n\t\tif (size >= GPS_IN_BUFSIZ) {\n\t\t\tdev_dbg(dev, \"%s - packet too large.\\n\", __func__);\n\t\t\tskip = 1;\n\t\t\tsize = GSP_INITIAL_OFFSET;\n\t\t\tdleSeen = 0;\n\t\t}\n\t}\n\n\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\n\tgarmin_data_p->insize = size;\n\n\t \n\tif (skip)\n\t\tgarmin_data_p->flags |= FLAGS_GSP_SKIP;\n\telse\n\t\tgarmin_data_p->flags &= ~FLAGS_GSP_SKIP;\n\n\tif (dleSeen)\n\t\tgarmin_data_p->flags |= FLAGS_GSP_DLESEEN;\n\telse\n\t\tgarmin_data_p->flags &= ~FLAGS_GSP_DLESEEN;\n\n\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\tif (ack_or_nak_seen) {\n\t\tif (gsp_next_packet(garmin_data_p) > 0)\n\t\t\tgarmin_data_p->state = STATE_ACTIVE;\n\t\telse\n\t\t\tgarmin_data_p->state = STATE_GSP_WAIT_DATA;\n\t}\n\treturn count;\n}\n\n\n\n \nstatic int gsp_send(struct garmin_data *garmin_data_p,\n\t\t    const unsigned char *buf, int count)\n{\n\tstruct device *dev = &garmin_data_p->port->dev;\n\tconst unsigned char *src;\n\tunsigned char *dst;\n\tint pktid = 0;\n\tint datalen = 0;\n\tint cksum = 0;\n\tint i = 0;\n\tint k;\n\n\tdev_dbg(dev, \"%s - state %d - %d bytes.\\n\", __func__,\n\t\tgarmin_data_p->state, count);\n\n\tk = garmin_data_p->outsize;\n\tif ((k+count) > GPS_OUT_BUFSIZ) {\n\t\tdev_dbg(dev, \"packet too large\\n\");\n\t\tgarmin_data_p->outsize = 0;\n\t\treturn -4;\n\t}\n\n\tmemcpy(garmin_data_p->outbuffer+k, buf, count);\n\tk += count;\n\tgarmin_data_p->outsize = k;\n\n\tif (k >= GARMIN_PKTHDR_LENGTH) {\n\t\tpktid  = getPacketId(garmin_data_p->outbuffer);\n\t\tdatalen = getDataLength(garmin_data_p->outbuffer);\n\t\ti = GARMIN_PKTHDR_LENGTH + datalen;\n\t\tif (k < i)\n\t\t\treturn 0;\n\t} else {\n\t\treturn 0;\n\t}\n\n\tdev_dbg(dev, \"%s - %d bytes in buffer, %d bytes in pkt.\\n\", __func__, k, i);\n\n\t \n\n\tusb_serial_debug_data(&garmin_data_p->port->dev, __func__, k,\n\t\t\t      garmin_data_p->outbuffer);\n\n\tgarmin_data_p->outsize = 0;\n\n\tif (getLayerId(garmin_data_p->outbuffer) != GARMIN_LAYERID_APPL) {\n\t\tdev_dbg(dev, \"not an application packet (%d)\\n\",\n\t\t\t\tgetLayerId(garmin_data_p->outbuffer));\n\t\treturn -1;\n\t}\n\n\tif (pktid > 255) {\n\t\tdev_dbg(dev, \"packet-id %d too large\\n\", pktid);\n\t\treturn -2;\n\t}\n\n\tif (datalen > 255) {\n\t\tdev_dbg(dev, \"packet-size %d too large\\n\", datalen);\n\t\treturn -3;\n\t}\n\n\t \n\n\tk = 0;\n\tsrc = garmin_data_p->outbuffer+GARMIN_PKTHDR_LENGTH;\n\tfor (i = 0; i < datalen; i++) {\n\t\tif (*src++ == DLE)\n\t\t\tk++;\n\t}\n\n\tsrc = garmin_data_p->outbuffer+GARMIN_PKTHDR_LENGTH;\n\tif (k > (GARMIN_PKTHDR_LENGTH-2)) {\n\t\t \n\t\tdst = garmin_data_p->outbuffer+GPS_OUT_BUFSIZ-datalen;\n\t\tmemcpy(dst, src, datalen);\n\t\tsrc = dst;\n\t}\n\n\tdst = garmin_data_p->outbuffer;\n\n\t*dst++ = DLE;\n\t*dst++ = pktid;\n\tcksum += pktid;\n\t*dst++ = datalen;\n\tcksum += datalen;\n\tif (datalen == DLE)\n\t\t*dst++ = DLE;\n\n\tfor (i = 0; i < datalen; i++) {\n\t\t__u8 c = *src++;\n\t\t*dst++ = c;\n\t\tcksum += c;\n\t\tif (c == DLE)\n\t\t\t*dst++ = DLE;\n\t}\n\n\tcksum = -cksum & 0xFF;\n\t*dst++ = cksum;\n\tif (cksum == DLE)\n\t\t*dst++ = DLE;\n\t*dst++ = DLE;\n\t*dst++ = ETX;\n\n\ti = dst-garmin_data_p->outbuffer;\n\n\tsend_to_tty(garmin_data_p->port, garmin_data_p->outbuffer, i);\n\n\tgarmin_data_p->pkt_id = pktid;\n\tgarmin_data_p->state  = STATE_WAIT_TTY_ACK;\n\n\treturn i;\n}\n\n\n \nstatic int gsp_next_packet(struct garmin_data *garmin_data_p)\n{\n\tint result = 0;\n\tstruct garmin_packet *pkt = NULL;\n\n\twhile ((pkt = pkt_pop(garmin_data_p)) != NULL) {\n\t\tdev_dbg(&garmin_data_p->port->dev, \"%s - next pkt: %d\\n\", __func__, pkt->seq);\n\t\tresult = gsp_send(garmin_data_p, pkt->data, pkt->size);\n\t\tif (result > 0) {\n\t\t\tkfree(pkt);\n\t\t\treturn result;\n\t\t}\n\t\tkfree(pkt);\n\t}\n\treturn result;\n}\n\n\n\n \n\n\n \nstatic int nat_receive(struct garmin_data *garmin_data_p,\n\t\t       const unsigned char *buf, int count)\n{\n\tunsigned long flags;\n\t__u8 *dest;\n\tint offs = 0;\n\tint result = count;\n\tint len;\n\n\twhile (offs < count) {\n\t\t \n\t\tif (garmin_data_p->insize >= GARMIN_PKTHDR_LENGTH)\n\t\t\tlen = GARMIN_PKTHDR_LENGTH\n\t\t\t      +getDataLength(garmin_data_p->inbuffer);\n\t\telse\n\t\t\tlen = GARMIN_PKTHDR_LENGTH;\n\n\t\tif (len >= GPS_IN_BUFSIZ) {\n\t\t\t \n\t\t\tdev_dbg(&garmin_data_p->port->dev,\n\t\t\t\t\"%s - packet size too large: %d\\n\",\n\t\t\t\t__func__, len);\n\t\t\tgarmin_data_p->insize = 0;\n\t\t\tcount = 0;\n\t\t\tresult = -EINVPKT;\n\t\t} else {\n\t\t\tlen -= garmin_data_p->insize;\n\t\t\tif (len > (count-offs))\n\t\t\t\tlen = (count-offs);\n\t\t\tif (len > 0) {\n\t\t\t\tdest = garmin_data_p->inbuffer\n\t\t\t\t\t\t+ garmin_data_p->insize;\n\t\t\t\tmemcpy(dest, buf+offs, len);\n\t\t\t\tgarmin_data_p->insize += len;\n\t\t\t\toffs += len;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tif (garmin_data_p->insize >= GARMIN_PKTHDR_LENGTH) {\n\t\t\tlen = GARMIN_PKTHDR_LENGTH+\n\t\t\t   getDataLength(garmin_data_p->inbuffer);\n\t\t\tif (garmin_data_p->insize >= len) {\n\t\t\t\tgarmin_write_bulk(garmin_data_p->port,\n\t\t\t\t\t\t   garmin_data_p->inbuffer,\n\t\t\t\t\t\t   len, 0);\n\t\t\t\tgarmin_data_p->insize = 0;\n\n\t\t\t\t \n\t\t\t\tif (isAbortTrfCmnd(garmin_data_p->inbuffer)) {\n\t\t\t\t\tspin_lock_irqsave(&garmin_data_p->lock,\n\t\t\t\t\t\t\t\t\tflags);\n\t\t\t\t\tgarmin_data_p->flags |= FLAGS_DROP_DATA;\n\t\t\t\t\tspin_unlock_irqrestore(\n\t\t\t\t\t\t&garmin_data_p->lock, flags);\n\t\t\t\t\tpkt_clear(garmin_data_p);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn result;\n}\n\n\n \n\nstatic void priv_status_resp(struct usb_serial_port *port)\n{\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\t__le32 *pkt = (__le32 *)garmin_data_p->privpkt;\n\n\tpkt[0] = __cpu_to_le32(GARMIN_LAYERID_PRIVATE);\n\tpkt[1] = __cpu_to_le32(PRIV_PKTID_INFO_RESP);\n\tpkt[2] = __cpu_to_le32(12);\n\tpkt[3] = __cpu_to_le32(VERSION_MAJOR << 16 | VERSION_MINOR);\n\tpkt[4] = __cpu_to_le32(garmin_data_p->mode);\n\tpkt[5] = __cpu_to_le32(garmin_data_p->serial_num);\n\n\tsend_to_tty(port, (__u8 *)pkt, 6 * 4);\n}\n\n\n \n\nstatic int process_resetdev_request(struct usb_serial_port *port)\n{\n\tunsigned long flags;\n\tint status;\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\n\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\tgarmin_data_p->flags &= ~(CLEAR_HALT_REQUIRED);\n\tgarmin_data_p->state = STATE_RESET;\n\tgarmin_data_p->serial_num = 0;\n\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\tusb_kill_urb(port->interrupt_in_urb);\n\tdev_dbg(&port->dev, \"%s - usb_reset_device\\n\", __func__);\n\tstatus = usb_reset_device(port->serial->dev);\n\tif (status)\n\t\tdev_dbg(&port->dev, \"%s - usb_reset_device failed: %d\\n\",\n\t\t\t__func__, status);\n\treturn status;\n}\n\n\n\n \nstatic int garmin_clear(struct garmin_data *garmin_data_p)\n{\n\tunsigned long flags;\n\n\t \n\tpkt_clear(garmin_data_p);\n\n\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\tgarmin_data_p->insize = 0;\n\tgarmin_data_p->outsize = 0;\n\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\treturn 0;\n}\n\n\nstatic int garmin_init_session(struct usb_serial_port *port)\n{\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\tint status;\n\tint i;\n\n\tusb_kill_urb(port->interrupt_in_urb);\n\n\tstatus = usb_submit_urb(port->interrupt_in_urb, GFP_KERNEL);\n\tif (status) {\n\t\tdev_err(&port->dev, \"failed to submit interrupt urb: %d\\n\",\n\t\t\t\tstatus);\n\t\treturn status;\n\t}\n\n\t \n\tdev_dbg(&port->dev, \"%s - starting session ...\\n\", __func__);\n\tgarmin_data_p->state = STATE_ACTIVE;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tstatus = garmin_write_bulk(port, GARMIN_START_SESSION_REQ,\n\t\t\t\tsizeof(GARMIN_START_SESSION_REQ), 0);\n\t\tif (status < 0)\n\t\t\tgoto err_kill_urbs;\n\t}\n\n\treturn 0;\n\nerr_kill_urbs:\n\tusb_kill_anchored_urbs(&garmin_data_p->write_urbs);\n\tusb_kill_urb(port->interrupt_in_urb);\n\n\treturn status;\n}\n\n\n\nstatic int garmin_open(struct tty_struct *tty, struct usb_serial_port *port)\n{\n\tunsigned long flags;\n\tint status = 0;\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\n\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\tgarmin_data_p->mode  = initial_mode;\n\tgarmin_data_p->count = 0;\n\tgarmin_data_p->flags &= FLAGS_SESSION_REPLY1_SEEN;\n\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\t \n\tusb_kill_urb(port->read_urb);\n\n\tif (garmin_data_p->state == STATE_RESET)\n\t\tstatus = garmin_init_session(port);\n\n\tgarmin_data_p->state = STATE_ACTIVE;\n\treturn status;\n}\n\n\nstatic void garmin_close(struct usb_serial_port *port)\n{\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\n\tdev_dbg(&port->dev, \"%s - mode=%d state=%d flags=0x%X\\n\",\n\t\t__func__, garmin_data_p->mode, garmin_data_p->state,\n\t\tgarmin_data_p->flags);\n\n\tgarmin_clear(garmin_data_p);\n\n\t \n\tusb_kill_urb(port->read_urb);\n\tusb_kill_anchored_urbs(&garmin_data_p->write_urbs);\n\n\t \n\tif (garmin_data_p->state != STATE_RESET)\n\t\tgarmin_data_p->state = STATE_DISCONNECTED;\n}\n\n\nstatic void garmin_write_bulk_callback(struct urb *urb)\n{\n\tstruct usb_serial_port *port = urb->context;\n\n\tif (port) {\n\t\tstruct garmin_data *garmin_data_p =\n\t\t\t\t\tusb_get_serial_port_data(port);\n\n\t\tif (getLayerId(urb->transfer_buffer) == GARMIN_LAYERID_APPL) {\n\n\t\t\tif (garmin_data_p->mode == MODE_GARMIN_SERIAL) {\n\t\t\t\tgsp_send_ack(garmin_data_p,\n\t\t\t\t\t((__u8 *)urb->transfer_buffer)[4]);\n\t\t\t}\n\t\t}\n\t\tusb_serial_port_softint(port);\n\t}\n\n\t \n\n\t \n\tkfree(urb->transfer_buffer);\n}\n\n\nstatic int garmin_write_bulk(struct usb_serial_port *port,\n\t\t\t      const unsigned char *buf, int count,\n\t\t\t      int dismiss_ack)\n{\n\tunsigned long flags;\n\tstruct usb_serial *serial = port->serial;\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\tstruct urb *urb;\n\tunsigned char *buffer;\n\tint status;\n\n\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\tgarmin_data_p->flags &= ~FLAGS_DROP_DATA;\n\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\tbuffer = kmemdup(buf, count, GFP_ATOMIC);\n\tif (!buffer)\n\t\treturn -ENOMEM;\n\n\turb = usb_alloc_urb(0, GFP_ATOMIC);\n\tif (!urb) {\n\t\tkfree(buffer);\n\t\treturn -ENOMEM;\n\t}\n\n\tusb_serial_debug_data(&port->dev, __func__, count, buffer);\n\n\tusb_fill_bulk_urb(urb, serial->dev,\n\t\t\t\tusb_sndbulkpipe(serial->dev,\n\t\t\t\t\tport->bulk_out_endpointAddress),\n\t\t\t\tbuffer, count,\n\t\t\t\tgarmin_write_bulk_callback,\n\t\t\t\tdismiss_ack ? NULL : port);\n\turb->transfer_flags |= URB_ZERO_PACKET;\n\n\tif (getLayerId(buffer) == GARMIN_LAYERID_APPL) {\n\n\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\tgarmin_data_p->flags |= APP_REQ_SEEN;\n\t\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\t\tif (garmin_data_p->mode == MODE_GARMIN_SERIAL)  {\n\t\t\tpkt_clear(garmin_data_p);\n\t\t\tgarmin_data_p->state = STATE_GSP_WAIT_DATA;\n\t\t}\n\t}\n\n\t \n\tusb_anchor_urb(urb, &garmin_data_p->write_urbs);\n\tstatus = usb_submit_urb(urb, GFP_ATOMIC);\n\tif (status) {\n\t\tdev_err(&port->dev,\n\t\t   \"%s - usb_submit_urb(write bulk) failed with status = %d\\n\",\n\t\t\t\t__func__, status);\n\t\tcount = status;\n\t\tusb_unanchor_urb(urb);\n\t\tkfree(buffer);\n\t}\n\n\t \n\tusb_free_urb(urb);\n\n\treturn count;\n}\n\nstatic int garmin_write(struct tty_struct *tty, struct usb_serial_port *port,\n\t\t\t\t\t const unsigned char *buf, int count)\n{\n\tstruct device *dev = &port->dev;\n\tint pktid, pktsiz, len;\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\t__le32 *privpkt = (__le32 *)garmin_data_p->privpkt;\n\n\tusb_serial_debug_data(dev, __func__, count, buf);\n\n\tif (garmin_data_p->state == STATE_RESET)\n\t\treturn -EIO;\n\n\t \n\tif (count >= GARMIN_PKTHDR_LENGTH) {\n\t\tlen = PRIVPKTSIZ;\n\t\tif (count < len)\n\t\t\tlen = count;\n\n\t\tmemcpy(garmin_data_p->privpkt, buf, len);\n\n\t\tpktsiz = getDataLength(garmin_data_p->privpkt);\n\t\tpktid  = getPacketId(garmin_data_p->privpkt);\n\n\t\tif (count == (GARMIN_PKTHDR_LENGTH + pktsiz) &&\n\t\t\t\tgetLayerId(garmin_data_p->privpkt) ==\n\t\t\t\t\t\tGARMIN_LAYERID_PRIVATE) {\n\n\t\t\tdev_dbg(dev, \"%s - processing private request %d\\n\",\n\t\t\t\t__func__, pktid);\n\n\t\t\t \n\t\t\tgarmin_clear(garmin_data_p);\n\n\t\t\tswitch (pktid) {\n\t\t\tcase PRIV_PKTID_SET_MODE:\n\t\t\t\tif (pktsiz != 4)\n\t\t\t\t\treturn -EINVPKT;\n\t\t\t\tgarmin_data_p->mode = __le32_to_cpu(privpkt[3]);\n\t\t\t\tdev_dbg(dev, \"%s - mode set to %d\\n\",\n\t\t\t\t\t__func__, garmin_data_p->mode);\n\t\t\t\tbreak;\n\n\t\t\tcase PRIV_PKTID_INFO_REQ:\n\t\t\t\tpriv_status_resp(port);\n\t\t\t\tbreak;\n\n\t\t\tcase PRIV_PKTID_RESET_REQ:\n\t\t\t\tprocess_resetdev_request(port);\n\t\t\t\tbreak;\n\n\t\t\tcase PRIV_PKTID_SET_DEF_MODE:\n\t\t\t\tif (pktsiz != 4)\n\t\t\t\t\treturn -EINVPKT;\n\t\t\t\tinitial_mode = __le32_to_cpu(privpkt[3]);\n\t\t\t\tdev_dbg(dev, \"%s - initial_mode set to %d\\n\",\n\t\t\t\t\t__func__,\n\t\t\t\t\tgarmin_data_p->mode);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\treturn count;\n\t\t}\n\t}\n\n\tif (garmin_data_p->mode == MODE_GARMIN_SERIAL) {\n\t\treturn gsp_receive(garmin_data_p, buf, count);\n\t} else {\t \n\t\treturn nat_receive(garmin_data_p, buf, count);\n\t}\n}\n\n\nstatic unsigned int garmin_write_room(struct tty_struct *tty)\n{\n\tstruct usb_serial_port *port = tty->driver_data;\n\t \n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\treturn GPS_OUT_BUFSIZ-garmin_data_p->outsize;\n}\n\n\nstatic void garmin_read_process(struct garmin_data *garmin_data_p,\n\t\t\t\t unsigned char *data, unsigned data_length,\n\t\t\t\t int bulk_data)\n{\n\tunsigned long flags;\n\n\tif (garmin_data_p->flags & FLAGS_DROP_DATA) {\n\t\t \n\t\tdev_dbg(&garmin_data_p->port->dev, \"%s - pkt dropped\\n\", __func__);\n\t} else if (garmin_data_p->state != STATE_DISCONNECTED &&\n\t\tgarmin_data_p->state != STATE_RESET) {\n\n\t\t \n\t\tif (garmin_data_p->flags & FLAGS_QUEUING) {\n\t\t\tpkt_add(garmin_data_p, data, data_length);\n\t\t} else if (bulk_data || (data_length >= sizeof(u32) &&\n\t\t\t\tgetLayerId(data) == GARMIN_LAYERID_APPL)) {\n\n\t\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\t\tgarmin_data_p->flags |= APP_RESP_SEEN;\n\t\t\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\t\t\tif (garmin_data_p->mode == MODE_GARMIN_SERIAL) {\n\t\t\t\tpkt_add(garmin_data_p, data, data_length);\n\t\t\t} else {\n\t\t\t\tsend_to_tty(garmin_data_p->port, data,\n\t\t\t\t\t\tdata_length);\n\t\t\t}\n\t\t}\n\t\t \n\t}\n}\n\n\nstatic void garmin_read_bulk_callback(struct urb *urb)\n{\n\tunsigned long flags;\n\tstruct usb_serial_port *port = urb->context;\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\tunsigned char *data = urb->transfer_buffer;\n\tint status = urb->status;\n\tint retval;\n\n\tif (status) {\n\t\tdev_dbg(&urb->dev->dev, \"%s - nonzero read bulk status received: %d\\n\",\n\t\t\t__func__, status);\n\t\treturn;\n\t}\n\n\tusb_serial_debug_data(&port->dev, __func__, urb->actual_length, data);\n\n\tgarmin_read_process(garmin_data_p, data, urb->actual_length, 1);\n\n\tif (urb->actual_length == 0 &&\n\t\t\t(garmin_data_p->flags & FLAGS_BULK_IN_RESTART) != 0) {\n\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\tgarmin_data_p->flags &= ~FLAGS_BULK_IN_RESTART;\n\t\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\t\tretval = usb_submit_urb(port->read_urb, GFP_ATOMIC);\n\t\tif (retval)\n\t\t\tdev_err(&port->dev,\n\t\t\t\t\"%s - failed resubmitting read urb, error %d\\n\",\n\t\t\t\t__func__, retval);\n\t} else if (urb->actual_length > 0) {\n\t\t \n\t\tif ((garmin_data_p->flags & FLAGS_THROTTLED) == 0) {\n\t\t\tretval = usb_submit_urb(port->read_urb, GFP_ATOMIC);\n\t\t\tif (retval)\n\t\t\t\tdev_err(&port->dev,\n\t\t\t\t\t\"%s - failed resubmitting read urb, error %d\\n\",\n\t\t\t\t\t__func__, retval);\n\t\t}\n\t} else {\n\t\tdev_dbg(&port->dev, \"%s - end of bulk data\\n\", __func__);\n\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\tgarmin_data_p->flags &= ~FLAGS_BULK_IN_ACTIVE;\n\t\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\t}\n}\n\n\nstatic void garmin_read_int_callback(struct urb *urb)\n{\n\tunsigned long flags;\n\tint retval;\n\tstruct usb_serial_port *port = urb->context;\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\tunsigned char *data = urb->transfer_buffer;\n\tint status = urb->status;\n\n\tswitch (status) {\n\tcase 0:\n\t\t \n\t\tbreak;\n\tcase -ECONNRESET:\n\tcase -ENOENT:\n\tcase -ESHUTDOWN:\n\t\t \n\t\tdev_dbg(&urb->dev->dev, \"%s - urb shutting down with status: %d\\n\",\n\t\t\t__func__, status);\n\t\treturn;\n\tdefault:\n\t\tdev_dbg(&urb->dev->dev, \"%s - nonzero urb status received: %d\\n\",\n\t\t\t__func__, status);\n\t\treturn;\n\t}\n\n\tusb_serial_debug_data(&port->dev, __func__, urb->actual_length,\n\t\t\t      urb->transfer_buffer);\n\n\tif (urb->actual_length == sizeof(GARMIN_BULK_IN_AVAIL_REPLY) &&\n\t\tmemcmp(data, GARMIN_BULK_IN_AVAIL_REPLY,\n\t\t\t\tsizeof(GARMIN_BULK_IN_AVAIL_REPLY)) == 0) {\n\n\t\tdev_dbg(&port->dev, \"%s - bulk data available.\\n\", __func__);\n\n\t\tif ((garmin_data_p->flags & FLAGS_BULK_IN_ACTIVE) == 0) {\n\n\t\t\t \n\t\t\tretval = usb_submit_urb(port->read_urb, GFP_ATOMIC);\n\t\t\tif (retval) {\n\t\t\t\tdev_err(&port->dev,\n\t\t\t\t \"%s - failed submitting read urb, error %d\\n\",\n\t\t\t\t\t\t\t__func__, retval);\n\t\t\t} else {\n\t\t\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\t\t\tgarmin_data_p->flags |= FLAGS_BULK_IN_ACTIVE;\n\t\t\t\tspin_unlock_irqrestore(&garmin_data_p->lock,\n\t\t\t\t\t\t\t\t\tflags);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\t\tgarmin_data_p->flags |= FLAGS_BULK_IN_RESTART;\n\t\t\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\t\t}\n\n\t} else if (urb->actual_length == (4+sizeof(GARMIN_START_SESSION_REPLY))\n\t\t\t && memcmp(data, GARMIN_START_SESSION_REPLY,\n\t\t\t\t sizeof(GARMIN_START_SESSION_REPLY)) == 0) {\n\n\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\tgarmin_data_p->flags |= FLAGS_SESSION_REPLY1_SEEN;\n\t\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\n\t\t \n\t\tgarmin_data_p->serial_num = __le32_to_cpup(\n\t\t\t\t\t(__le32 *)(data+GARMIN_PKTHDR_LENGTH));\n\n\t\tdev_dbg(&port->dev, \"%s - start-of-session reply seen - serial %u.\\n\",\n\t\t\t__func__, garmin_data_p->serial_num);\n\t}\n\n\tgarmin_read_process(garmin_data_p, data, urb->actual_length, 0);\n\n\tretval = usb_submit_urb(urb, GFP_ATOMIC);\n\tif (retval)\n\t\tdev_err(&urb->dev->dev,\n\t\t\t\"%s - Error %d submitting interrupt urb\\n\",\n\t\t\t__func__, retval);\n}\n\n\n \nstatic int garmin_flush_queue(struct garmin_data *garmin_data_p)\n{\n\tunsigned long flags;\n\tstruct garmin_packet *pkt;\n\n\tif ((garmin_data_p->flags & FLAGS_THROTTLED) == 0) {\n\t\tpkt = pkt_pop(garmin_data_p);\n\t\tif (pkt != NULL) {\n\t\t\tsend_to_tty(garmin_data_p->port, pkt->data, pkt->size);\n\t\t\tkfree(pkt);\n\t\t\tmod_timer(&garmin_data_p->timer, (1)+jiffies);\n\n\t\t} else {\n\t\t\tspin_lock_irqsave(&garmin_data_p->lock, flags);\n\t\t\tgarmin_data_p->flags &= ~FLAGS_QUEUING;\n\t\t\tspin_unlock_irqrestore(&garmin_data_p->lock, flags);\n\t\t}\n\t}\n\treturn 0;\n}\n\n\nstatic void garmin_throttle(struct tty_struct *tty)\n{\n\tstruct usb_serial_port *port = tty->driver_data;\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\n\t \n\tspin_lock_irq(&garmin_data_p->lock);\n\tgarmin_data_p->flags |= FLAGS_QUEUING|FLAGS_THROTTLED;\n\tspin_unlock_irq(&garmin_data_p->lock);\n}\n\n\nstatic void garmin_unthrottle(struct tty_struct *tty)\n{\n\tstruct usb_serial_port *port = tty->driver_data;\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\tint status;\n\n\tspin_lock_irq(&garmin_data_p->lock);\n\tgarmin_data_p->flags &= ~FLAGS_THROTTLED;\n\tspin_unlock_irq(&garmin_data_p->lock);\n\n\t \n\tif (garmin_data_p->mode == MODE_NATIVE)\n\t\tgarmin_flush_queue(garmin_data_p);\n\n\tif ((garmin_data_p->flags & FLAGS_BULK_IN_ACTIVE) != 0) {\n\t\tstatus = usb_submit_urb(port->read_urb, GFP_KERNEL);\n\t\tif (status)\n\t\t\tdev_err(&port->dev,\n\t\t\t\t\"%s - failed resubmitting read urb, error %d\\n\",\n\t\t\t\t__func__, status);\n\t}\n}\n\n \nstatic void timeout_handler(struct timer_list *t)\n{\n\tstruct garmin_data *garmin_data_p = from_timer(garmin_data_p, t, timer);\n\n\t \n\tif (garmin_data_p->mode == MODE_NATIVE)\n\t\tif (garmin_data_p->flags & FLAGS_QUEUING)\n\t\t\tgarmin_flush_queue(garmin_data_p);\n}\n\n\n\nstatic int garmin_port_probe(struct usb_serial_port *port)\n{\n\tint status;\n\tstruct garmin_data *garmin_data_p;\n\n\tgarmin_data_p = kzalloc(sizeof(struct garmin_data), GFP_KERNEL);\n\tif (!garmin_data_p)\n\t\treturn -ENOMEM;\n\n\ttimer_setup(&garmin_data_p->timer, timeout_handler, 0);\n\tspin_lock_init(&garmin_data_p->lock);\n\tINIT_LIST_HEAD(&garmin_data_p->pktlist);\n\tgarmin_data_p->port = port;\n\tgarmin_data_p->state = 0;\n\tgarmin_data_p->flags = 0;\n\tgarmin_data_p->count = 0;\n\tinit_usb_anchor(&garmin_data_p->write_urbs);\n\tusb_set_serial_port_data(port, garmin_data_p);\n\n\tstatus = garmin_init_session(port);\n\tif (status)\n\t\tgoto err_free;\n\n\treturn 0;\nerr_free:\n\tkfree(garmin_data_p);\n\n\treturn status;\n}\n\n\nstatic void garmin_port_remove(struct usb_serial_port *port)\n{\n\tstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\n\n\tusb_kill_anchored_urbs(&garmin_data_p->write_urbs);\n\tusb_kill_urb(port->interrupt_in_urb);\n\ttimer_shutdown_sync(&garmin_data_p->timer);\n\tkfree(garmin_data_p);\n}\n\n\n \nstatic struct usb_serial_driver garmin_device = {\n\t.driver = {\n\t\t.owner       = THIS_MODULE,\n\t\t.name        = \"garmin_gps\",\n\t},\n\t.description         = \"Garmin GPS usb/tty\",\n\t.id_table            = id_table,\n\t.num_ports           = 1,\n\t.open                = garmin_open,\n\t.close               = garmin_close,\n\t.throttle            = garmin_throttle,\n\t.unthrottle          = garmin_unthrottle,\n\t.port_probe\t\t= garmin_port_probe,\n\t.port_remove\t\t= garmin_port_remove,\n\t.write               = garmin_write,\n\t.write_room          = garmin_write_room,\n\t.write_bulk_callback = garmin_write_bulk_callback,\n\t.read_bulk_callback  = garmin_read_bulk_callback,\n\t.read_int_callback   = garmin_read_int_callback,\n};\n\nstatic struct usb_serial_driver * const serial_drivers[] = {\n\t&garmin_device, NULL\n};\n\nmodule_usb_serial_driver(serial_drivers, id_table);\n\nMODULE_AUTHOR(DRIVER_AUTHOR);\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL\");\n\nmodule_param(initial_mode, int, 0444);\nMODULE_PARM_DESC(initial_mode, \"Initial mode\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}