{
  "module_name": "qcserial.c",
  "hash_id": "982e76e438bd8be48a9f5e53f6e2fc1fdac0ddd5444c3da9e6ac86156a6e1438",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/serial/qcserial.c",
  "human_readable_source": "\n \n\n#include <linux/tty.h>\n#include <linux/tty_flip.h>\n#include <linux/module.h>\n#include <linux/usb.h>\n#include <linux/usb/serial.h>\n#include <linux/slab.h>\n#include \"usb-wwan.h\"\n\n#define DRIVER_AUTHOR \"Qualcomm Inc\"\n#define DRIVER_DESC \"Qualcomm USB Serial driver\"\n\n#define QUECTEL_EC20_PID\t0x9215\n\n \nenum qcserial_layouts {\n\tQCSERIAL_G2K = 0,\t \n\tQCSERIAL_G1K = 1,\t \n\tQCSERIAL_SWI = 2,\t \n\tQCSERIAL_HWI = 3,\t \n};\n\n#define DEVICE_G1K(v, p) \\\n\tUSB_DEVICE(v, p), .driver_info = QCSERIAL_G1K\n#define DEVICE_SWI(v, p) \\\n\tUSB_DEVICE(v, p), .driver_info = QCSERIAL_SWI\n#define DEVICE_HWI(v, p) \\\n\tUSB_DEVICE(v, p), .driver_info = QCSERIAL_HWI\n\nstatic const struct usb_device_id id_table[] = {\n\t \n\t{DEVICE_G1K(0x05c6, 0x9211)},\t \n\t{DEVICE_G1K(0x05c6, 0x9212)},\t \n\t{DEVICE_G1K(0x03f0, 0x1f1d)},\t \n\t{DEVICE_G1K(0x03f0, 0x201d)},\t \n\t{DEVICE_G1K(0x04da, 0x250d)},\t \n\t{DEVICE_G1K(0x04da, 0x250c)},\t \n\t{DEVICE_G1K(0x413c, 0x8172)},\t \n\t{DEVICE_G1K(0x413c, 0x8171)},\t \n\t{DEVICE_G1K(0x1410, 0xa001)},\t \n\t{DEVICE_G1K(0x1410, 0xa002)},\t \n\t{DEVICE_G1K(0x1410, 0xa003)},\t \n\t{DEVICE_G1K(0x1410, 0xa004)},\t \n\t{DEVICE_G1K(0x1410, 0xa005)},\t \n\t{DEVICE_G1K(0x1410, 0xa006)},\t \n\t{DEVICE_G1K(0x1410, 0xa007)},\t \n\t{DEVICE_G1K(0x1410, 0xa008)},\t \n\t{DEVICE_G1K(0x0b05, 0x1776)},\t \n\t{DEVICE_G1K(0x0b05, 0x1774)},\t \n\t{DEVICE_G1K(0x19d2, 0xfff3)},\t \n\t{DEVICE_G1K(0x19d2, 0xfff2)},\t \n\t{DEVICE_G1K(0x1557, 0x0a80)},\t \n\t{DEVICE_G1K(0x05c6, 0x9001)},    \n\t{DEVICE_G1K(0x05c6, 0x9002)},\t \n\t{DEVICE_G1K(0x05c6, 0x9202)},\t \n\t{DEVICE_G1K(0x05c6, 0x9203)},\t \n\t{DEVICE_G1K(0x05c6, 0x9222)},\t \n\t{DEVICE_G1K(0x05c6, 0x9008)},\t \n\t{DEVICE_G1K(0x05c6, 0x9009)},\t \n\t{DEVICE_G1K(0x05c6, 0x9201)},\t \n\t{DEVICE_G1K(0x05c6, 0x9221)},\t \n\t{DEVICE_G1K(0x05c6, 0x9231)},\t \n\t{DEVICE_G1K(0x1f45, 0x0001)},\t \n\t{DEVICE_G1K(0x1bc7, 0x900e)},\t \n\n\t \n\t{USB_DEVICE(0x1410, 0xa010)},\t \n\t{USB_DEVICE(0x1410, 0xa011)},\t \n\t{USB_DEVICE(0x1410, 0xa012)},\t \n\t{USB_DEVICE(0x1410, 0xa013)},\t \n\t{USB_DEVICE(0x1410, 0xa014)},\t \n\t{USB_DEVICE(0x413c, 0x8185)},\t \n\t{USB_DEVICE(0x413c, 0x8186)},\t \n\t{USB_DEVICE(0x05c6, 0x9208)},\t \n\t{USB_DEVICE(0x05c6, 0x920b)},\t \n\t{USB_DEVICE(0x05c6, 0x9224)},\t \n\t{USB_DEVICE(0x05c6, 0x9225)},\t \n\t{USB_DEVICE(0x05c6, 0x9244)},\t \n\t{USB_DEVICE(0x05c6, 0x9245)},\t \n\t{USB_DEVICE(0x03f0, 0x241d)},\t \n\t{USB_DEVICE(0x03f0, 0x251d)},\t \n\t{USB_DEVICE(0x05c6, 0x9214)},\t \n\t{USB_DEVICE(0x05c6, 0x9215)},\t \n\t{USB_DEVICE(0x05c6, 0x9264)},\t \n\t{USB_DEVICE(0x05c6, 0x9265)},\t \n\t{USB_DEVICE(0x05c6, 0x9234)},\t \n\t{USB_DEVICE(0x05c6, 0x9235)},\t \n\t{USB_DEVICE(0x05c6, 0x9274)},\t \n\t{USB_DEVICE(0x05c6, 0x9275)},\t \n\t{USB_DEVICE(0x1199, 0x9000)},\t \n\t{USB_DEVICE(0x1199, 0x9001)},\t \n\t{USB_DEVICE(0x1199, 0x9002)},\t \n\t{USB_DEVICE(0x1199, 0x9003)},\t \n\t{USB_DEVICE(0x1199, 0x9004)},\t \n\t{USB_DEVICE(0x1199, 0x9005)},\t \n\t{USB_DEVICE(0x1199, 0x9006)},\t \n\t{USB_DEVICE(0x1199, 0x9007)},\t \n\t{USB_DEVICE(0x1199, 0x9008)},\t \n\t{USB_DEVICE(0x1199, 0x9009)},\t \n\t{USB_DEVICE(0x1199, 0x900a)},\t \n\t{USB_DEVICE(0x1199, 0x9011)},    \n\t{USB_DEVICE(0x16d8, 0x8001)},\t \n\t{USB_DEVICE(0x16d8, 0x8002)},\t \n\t{USB_DEVICE(0x05c6, 0x9204)},\t \n\t{USB_DEVICE(0x05c6, 0x9205)},\t \n\n\t \n\t{USB_DEVICE(0x03f0, 0x371d)},\t \n\t{USB_DEVICE(0x05c6, 0x920c)},\t \n\t{USB_DEVICE(0x05c6, 0x920d)},\t \n\t{USB_DEVICE(0x1410, 0xa020)},    \n\t{USB_DEVICE(0x1410, 0xa021)},\t \n\t{USB_DEVICE(0x413c, 0x8193)},\t \n\t{USB_DEVICE(0x413c, 0x8194)},\t \n\t{USB_DEVICE(0x413c, 0x81a6)},\t \n\t{USB_DEVICE(0x1199, 0x68a4)},\t \n\t{USB_DEVICE(0x1199, 0x68a5)},\t \n\t{USB_DEVICE(0x1199, 0x68a8)},\t \n\t{USB_DEVICE(0x1199, 0x68a9)},\t \n\t{USB_DEVICE(0x1199, 0x9010)},\t \n\t{USB_DEVICE(0x1199, 0x9012)},\t \n\t{USB_DEVICE(0x1199, 0x9013)},\t \n\t{USB_DEVICE(0x1199, 0x9014)},\t \n\t{USB_DEVICE(0x1199, 0x9015)},\t \n\t{USB_DEVICE(0x1199, 0x9018)},\t \n\t{USB_DEVICE(0x1199, 0x9019)},\t \n\t{USB_DEVICE(0x1199, 0x901b)},\t \n\t{USB_DEVICE(0x12D1, 0x14F0)},\t \n\t{USB_DEVICE(0x12D1, 0x14F1)},\t \n\t{USB_DEVICE(0x0AF0, 0x8120)},\t \n\n\t \n\t{DEVICE_SWI(0x03f0, 0x4e1d)},\t \n\t{DEVICE_SWI(0x0f3d, 0x68a2)},\t \n\t{DEVICE_SWI(0x114f, 0x68a2)},\t \n\t{DEVICE_SWI(0x1199, 0x68a2)},\t \n\t{DEVICE_SWI(0x1199, 0x68c0)},\t \n\t{DEVICE_SWI(0x1199, 0x901c)},\t \n\t{DEVICE_SWI(0x1199, 0x901e)},\t \n\t{DEVICE_SWI(0x1199, 0x901f)},\t \n\t{DEVICE_SWI(0x1199, 0x9040)},\t \n\t{DEVICE_SWI(0x1199, 0x9041)},\t \n\t{DEVICE_SWI(0x1199, 0x9051)},\t \n\t{DEVICE_SWI(0x1199, 0x9053)},\t \n\t{DEVICE_SWI(0x1199, 0x9054)},\t \n\t{DEVICE_SWI(0x1199, 0x9055)},\t \n\t{DEVICE_SWI(0x1199, 0x9056)},\t \n\t{DEVICE_SWI(0x1199, 0x9060)},\t \n\t{DEVICE_SWI(0x1199, 0x9061)},\t \n\t{DEVICE_SWI(0x1199, 0x9062)},\t \n\t{DEVICE_SWI(0x1199, 0x9063)},\t \n\t{DEVICE_SWI(0x1199, 0x9070)},\t \n\t{DEVICE_SWI(0x1199, 0x9071)},\t \n\t{DEVICE_SWI(0x1199, 0x9078)},\t \n\t{DEVICE_SWI(0x1199, 0x9079)},\t \n\t{DEVICE_SWI(0x1199, 0x907a)},\t \n\t{DEVICE_SWI(0x1199, 0x907b)},\t \n\t{DEVICE_SWI(0x1199, 0x9090)},\t \n\t{DEVICE_SWI(0x1199, 0x9091)},\t \n\t{DEVICE_SWI(0x1199, 0x90d2)},\t \n\t{DEVICE_SWI(0x1199, 0xc080)},\t \n\t{DEVICE_SWI(0x1199, 0xc081)},\t \n\t{DEVICE_SWI(0x413c, 0x81a2)},\t \n\t{DEVICE_SWI(0x413c, 0x81a3)},\t \n\t{DEVICE_SWI(0x413c, 0x81a4)},\t \n\t{DEVICE_SWI(0x413c, 0x81a8)},\t \n\t{DEVICE_SWI(0x413c, 0x81a9)},\t \n\t{DEVICE_SWI(0x413c, 0x81b1)},\t \n\t{DEVICE_SWI(0x413c, 0x81b3)},\t \n\t{DEVICE_SWI(0x413c, 0x81b5)},\t \n\t{DEVICE_SWI(0x413c, 0x81b6)},\t \n\t{DEVICE_SWI(0x413c, 0x81c2)},\t \n\t{DEVICE_SWI(0x413c, 0x81cb)},\t \n\t{DEVICE_SWI(0x413c, 0x81cc)},\t \n\t{DEVICE_SWI(0x413c, 0x81cf)},    \n\t{DEVICE_SWI(0x413c, 0x81d0)},    \n\t{DEVICE_SWI(0x413c, 0x81d1)},    \n\t{DEVICE_SWI(0x413c, 0x81d2)},    \n\n\t \n\t{DEVICE_HWI(0x03f0, 0x581d)},\t \n\n\t{ }\t\t\t\t \n};\nMODULE_DEVICE_TABLE(usb, id_table);\n\nstatic int handle_quectel_ec20(struct device *dev, int ifnum)\n{\n\tint altsetting = 0;\n\n\t \n\tswitch (ifnum) {\n\tcase 0:\n\t\tdev_dbg(dev, \"Quectel EC20 DM/DIAG interface found\\n\");\n\t\tbreak;\n\tcase 1:\n\t\tdev_dbg(dev, \"Quectel EC20 NMEA GPS interface found\\n\");\n\t\tbreak;\n\tcase 2:\n\tcase 3:\n\t\tdev_dbg(dev, \"Quectel EC20 Modem port found\\n\");\n\t\tbreak;\n\tcase 4:\n\t\t \n\t\taltsetting = -1;\n\t\tbreak;\n\t}\n\n\treturn altsetting;\n}\n\nstatic int qcprobe(struct usb_serial *serial, const struct usb_device_id *id)\n{\n\tstruct usb_host_interface *intf = serial->interface->cur_altsetting;\n\tstruct device *dev = &serial->dev->dev;\n\tint retval = -ENODEV;\n\t__u8 nintf;\n\t__u8 ifnum;\n\tint altsetting = -1;\n\tbool sendsetup = false;\n\n\t \n\tif (intf->desc.bInterfaceClass != USB_CLASS_VENDOR_SPEC)\n\t\tgoto done;\n\n\tnintf = serial->dev->actconfig->desc.bNumInterfaces;\n\tdev_dbg(dev, \"Num Interfaces = %d\\n\", nintf);\n\tifnum = intf->desc.bInterfaceNumber;\n\tdev_dbg(dev, \"This Interface = %d\\n\", ifnum);\n\n\tif (nintf == 1) {\n\t\t \n\t\t \n\t\tif (serial->interface->num_altsetting == 2)\n\t\t\tintf = usb_altnum_to_altsetting(serial->interface, 1);\n\t\telse if (serial->interface->num_altsetting > 2)\n\t\t\tgoto done;\n\n\t\tif (intf && intf->desc.bNumEndpoints == 2 &&\n\t\t    usb_endpoint_is_bulk_in(&intf->endpoint[0].desc) &&\n\t\t    usb_endpoint_is_bulk_out(&intf->endpoint[1].desc)) {\n\t\t\tdev_dbg(dev, \"QDL port found\\n\");\n\n\t\t\tif (serial->interface->num_altsetting == 1)\n\t\t\t\tretval = 0;  \n\t\t\telse\n\t\t\t\taltsetting = 1;\n\t\t}\n\t\tgoto done;\n\n\t}\n\n\t \n\taltsetting = 0;\n\n\t \n\n\tswitch (id->driver_info) {\n\tcase QCSERIAL_G1K:\n\t\t \n\t\tif (nintf < 3 || nintf > 4) {\n\t\t\tdev_err(dev, \"unknown number of interfaces: %d\\n\", nintf);\n\t\t\taltsetting = -1;\n\t\t\tgoto done;\n\t\t}\n\n\t\tif (ifnum == 0) {\n\t\t\tdev_dbg(dev, \"Gobi 1K DM/DIAG interface found\\n\");\n\t\t\taltsetting = 1;\n\t\t} else if (ifnum == 2)\n\t\t\tdev_dbg(dev, \"Modem port found\\n\");\n\t\telse\n\t\t\taltsetting = -1;\n\t\tbreak;\n\tcase QCSERIAL_G2K:\n\t\t \n\t\tif (nintf == 5 && id->idProduct == QUECTEL_EC20_PID) {\n\t\t\taltsetting = handle_quectel_ec20(dev, ifnum);\n\t\t\tgoto done;\n\t\t}\n\n\t\t \n\t\tif (nintf < 3 || nintf > 4) {\n\t\t\tdev_err(dev, \"unknown number of interfaces: %d\\n\", nintf);\n\t\t\taltsetting = -1;\n\t\t\tgoto done;\n\t\t}\n\n\t\tswitch (ifnum) {\n\t\tcase 0:\n\t\t\t \n\t\t\taltsetting = -1;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tdev_dbg(dev, \"Gobi 2K+ DM/DIAG interface found\\n\");\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tdev_dbg(dev, \"Modem port found\\n\");\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\t \n\t\t\tdev_dbg(dev, \"Gobi 2K+ NMEA GPS interface found\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase QCSERIAL_SWI:\n\t\t \n\t\tswitch (ifnum) {\n\t\tcase 0:\n\t\t\tdev_dbg(dev, \"DM/DIAG interface found\\n\");\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tdev_dbg(dev, \"NMEA GPS interface found\\n\");\n\t\t\tsendsetup = true;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tdev_dbg(dev, \"Modem port found\\n\");\n\t\t\tsendsetup = true;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\taltsetting = -1;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase QCSERIAL_HWI:\n\t\t \n\t\tswitch (intf->desc.bInterfaceProtocol) {\n\t\t\t \n\t\tcase 0x07:\n\t\tcase 0x37:\n\t\tcase 0x67:\n\t\t\t \n\t\tcase 0x08:\n\t\tcase 0x38:\n\t\tcase 0x68:\n\t\t\t \n\t\tcase 0x09:\n\t\tcase 0x39:\n\t\tcase 0x69:\n\t\t\t \n\t\tcase 0x16:\n\t\tcase 0x46:\n\t\tcase 0x76:\n\t\t\taltsetting = -1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_dbg(dev, \"Huawei type serial port found (%02x/%02x/%02x)\\n\",\n\t\t\t\tintf->desc.bInterfaceClass,\n\t\t\t\tintf->desc.bInterfaceSubClass,\n\t\t\t\tintf->desc.bInterfaceProtocol);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"unsupported device layout type: %lu\\n\",\n\t\t\tid->driver_info);\n\t\tbreak;\n\t}\n\ndone:\n\tif (altsetting >= 0) {\n\t\tretval = usb_set_interface(serial->dev, ifnum, altsetting);\n\t\tif (retval < 0) {\n\t\t\tdev_err(dev,\n\t\t\t\t\"Could not set interface, error %d\\n\",\n\t\t\t\tretval);\n\t\t\tretval = -ENODEV;\n\t\t}\n\t}\n\n\tif (!retval)\n\t\tusb_set_serial_data(serial, (void *)(unsigned long)sendsetup);\n\n\treturn retval;\n}\n\nstatic int qc_attach(struct usb_serial *serial)\n{\n\tstruct usb_wwan_intf_private *data;\n\tbool sendsetup;\n\n\tdata = kzalloc(sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tsendsetup = !!(unsigned long)(usb_get_serial_data(serial));\n\tif (sendsetup)\n\t\tdata->use_send_setup = 1;\n\n\tspin_lock_init(&data->susp_lock);\n\n\tusb_set_serial_data(serial, data);\n\n\treturn 0;\n}\n\nstatic void qc_release(struct usb_serial *serial)\n{\n\tstruct usb_wwan_intf_private *priv = usb_get_serial_data(serial);\n\n\tusb_set_serial_data(serial, NULL);\n\tkfree(priv);\n}\n\nstatic struct usb_serial_driver qcdevice = {\n\t.driver = {\n\t\t.owner     = THIS_MODULE,\n\t\t.name      = \"qcserial\",\n\t},\n\t.description         = \"Qualcomm USB modem\",\n\t.id_table            = id_table,\n\t.num_ports           = 1,\n\t.probe               = qcprobe,\n\t.open\t\t     = usb_wwan_open,\n\t.close\t\t     = usb_wwan_close,\n\t.dtr_rts\t     = usb_wwan_dtr_rts,\n\t.write\t\t     = usb_wwan_write,\n\t.write_room\t     = usb_wwan_write_room,\n\t.chars_in_buffer     = usb_wwan_chars_in_buffer,\n\t.tiocmget            = usb_wwan_tiocmget,\n\t.tiocmset            = usb_wwan_tiocmset,\n\t.attach              = qc_attach,\n\t.release\t     = qc_release,\n\t.port_probe          = usb_wwan_port_probe,\n\t.port_remove\t     = usb_wwan_port_remove,\n#ifdef CONFIG_PM\n\t.suspend\t     = usb_wwan_suspend,\n\t.resume\t\t     = usb_wwan_resume,\n#endif\n};\n\nstatic struct usb_serial_driver * const serial_drivers[] = {\n\t&qcdevice, NULL\n};\n\nmodule_usb_serial_driver(serial_drivers, id_table);\n\nMODULE_AUTHOR(DRIVER_AUTHOR);\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}