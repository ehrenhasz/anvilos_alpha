{
  "module_name": "ucsi.h",
  "hash_id": "b68f0d0934a55e40c8104ef569ca4bf4d12f7800dff3e0a588bcc6dfd1aae04b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/typec/ucsi/ucsi.h",
  "human_readable_source": " \n\n#ifndef __DRIVER_USB_TYPEC_UCSI_H\n#define __DRIVER_USB_TYPEC_UCSI_H\n\n#include <linux/bitops.h>\n#include <linux/device.h>\n#include <linux/power_supply.h>\n#include <linux/types.h>\n#include <linux/usb/typec.h>\n#include <linux/usb/pd.h>\n#include <linux/usb/role.h>\n\n \n\nstruct ucsi;\nstruct ucsi_altmode;\nstruct dentry;\n\n \n#define UCSI_VERSION\t\t\t0\n#define UCSI_CCI\t\t\t4\n#define UCSI_CONTROL\t\t\t8\n#define UCSI_MESSAGE_IN\t\t\t16\n#define UCSI_MESSAGE_OUT\t\t32\n\n \n#define UCSI_CCI_CONNECTOR(_c_)\t\t(((_c_) & GENMASK(7, 1)) >> 1)\n#define UCSI_CCI_LENGTH(_c_)\t\t(((_c_) & GENMASK(15, 8)) >> 8)\n#define UCSI_CCI_NOT_SUPPORTED\t\tBIT(25)\n#define UCSI_CCI_CANCEL_COMPLETE\tBIT(26)\n#define UCSI_CCI_RESET_COMPLETE\t\tBIT(27)\n#define UCSI_CCI_BUSY\t\t\tBIT(28)\n#define UCSI_CCI_ACK_COMPLETE\t\tBIT(29)\n#define UCSI_CCI_ERROR\t\t\tBIT(30)\n#define UCSI_CCI_COMMAND_COMPLETE\tBIT(31)\n\n \nstruct ucsi_operations {\n\tint (*read)(struct ucsi *ucsi, unsigned int offset,\n\t\t    void *val, size_t val_len);\n\tint (*sync_write)(struct ucsi *ucsi, unsigned int offset,\n\t\t\t  const void *val, size_t val_len);\n\tint (*async_write)(struct ucsi *ucsi, unsigned int offset,\n\t\t\t   const void *val, size_t val_len);\n\tbool (*update_altmodes)(struct ucsi *ucsi, struct ucsi_altmode *orig,\n\t\t\t\tstruct ucsi_altmode *updated);\n};\n\nstruct ucsi *ucsi_create(struct device *dev, const struct ucsi_operations *ops);\nvoid ucsi_destroy(struct ucsi *ucsi);\nint ucsi_register(struct ucsi *ucsi);\nvoid ucsi_unregister(struct ucsi *ucsi);\nvoid *ucsi_get_drvdata(struct ucsi *ucsi);\nvoid ucsi_set_drvdata(struct ucsi *ucsi, void *data);\n\nvoid ucsi_connector_change(struct ucsi *ucsi, u8 num);\n\n \n\n \n#define UCSI_PPM_RESET\t\t\t0x01\n#define UCSI_CANCEL\t\t\t0x02\n#define UCSI_CONNECTOR_RESET\t\t0x03\n#define UCSI_ACK_CC_CI\t\t\t0x04\n#define UCSI_SET_NOTIFICATION_ENABLE\t0x05\n#define UCSI_GET_CAPABILITY\t\t0x06\n#define UCSI_GET_CONNECTOR_CAPABILITY\t0x07\n#define UCSI_SET_UOM\t\t\t0x08\n#define UCSI_SET_UOR\t\t\t0x09\n#define UCSI_SET_PDM\t\t\t0x0a\n#define UCSI_SET_PDR\t\t\t0x0b\n#define UCSI_GET_ALTERNATE_MODES\t0x0c\n#define UCSI_GET_CAM_SUPPORTED\t\t0x0d\n#define UCSI_GET_CURRENT_CAM\t\t0x0e\n#define UCSI_SET_NEW_CAM\t\t0x0f\n#define UCSI_GET_PDOS\t\t\t0x10\n#define UCSI_GET_CABLE_PROPERTY\t\t0x11\n#define UCSI_GET_CONNECTOR_STATUS\t0x12\n#define UCSI_GET_ERROR_STATUS\t\t0x13\n\n#define UCSI_CONNECTOR_NUMBER(_num_)\t\t((u64)(_num_) << 16)\n#define UCSI_COMMAND(_cmd_)\t\t\t((_cmd_) & 0xff)\n\n \n#define UCSI_CONNECTOR_RESET_HARD\t\tBIT(23)  \n\n \n#define UCSI_ACK_CONNECTOR_CHANGE\t\tBIT(16)\n#define UCSI_ACK_COMMAND_COMPLETE\t\tBIT(17)\n\n \n#define UCSI_ENABLE_NTFY_CMD_COMPLETE\t\tBIT(16)\n#define UCSI_ENABLE_NTFY_EXT_PWR_SRC_CHANGE\tBIT(17)\n#define UCSI_ENABLE_NTFY_PWR_OPMODE_CHANGE\tBIT(18)\n#define UCSI_ENABLE_NTFY_CAP_CHANGE\t\tBIT(21)\n#define UCSI_ENABLE_NTFY_PWR_LEVEL_CHANGE\tBIT(22)\n#define UCSI_ENABLE_NTFY_PD_RESET_COMPLETE\tBIT(23)\n#define UCSI_ENABLE_NTFY_CAM_CHANGE\t\tBIT(24)\n#define UCSI_ENABLE_NTFY_BAT_STATUS_CHANGE\tBIT(25)\n#define UCSI_ENABLE_NTFY_PARTNER_CHANGE\t\tBIT(27)\n#define UCSI_ENABLE_NTFY_PWR_DIR_CHANGE\t\tBIT(28)\n#define UCSI_ENABLE_NTFY_CONNECTOR_CHANGE\tBIT(30)\n#define UCSI_ENABLE_NTFY_ERROR\t\t\tBIT(31)\n#define UCSI_ENABLE_NTFY_ALL\t\t\t0xdbe70000\n\n \n#define UCSI_SET_UOR_ROLE(_r_)\t\t(((_r_) == TYPEC_HOST ? 1 : 2) << 23)\n#define UCSI_SET_UOR_ACCEPT_ROLE_SWAPS\t\tBIT(25)\n\n \n#define UCSI_SET_PDR_ROLE(_r_)\t\t(((_r_) == TYPEC_SOURCE ? 1 : 2) << 23)\n#define UCSI_SET_PDR_ACCEPT_ROLE_SWAPS\t\tBIT(25)\n\n \n#define UCSI_ALTMODE_RECIPIENT(_r_)\t\t(((_r_) >> 16) & 0x7)\n#define UCSI_GET_ALTMODE_RECIPIENT(_r_)\t\t((u64)(_r_) << 16)\n#define   UCSI_RECIPIENT_CON\t\t\t0\n#define   UCSI_RECIPIENT_SOP\t\t\t1\n#define   UCSI_RECIPIENT_SOP_P\t\t\t2\n#define   UCSI_RECIPIENT_SOP_PP\t\t\t3\n#define UCSI_GET_ALTMODE_CONNECTOR_NUMBER(_r_)\t((u64)(_r_) << 24)\n#define UCSI_ALTMODE_OFFSET(_r_)\t\t(((_r_) >> 32) & 0xff)\n#define UCSI_GET_ALTMODE_OFFSET(_r_)\t\t((u64)(_r_) << 32)\n#define UCSI_GET_ALTMODE_NUM_ALTMODES(_r_)\t((u64)(_r_) << 40)\n\n \n#define UCSI_GET_PDOS_PARTNER_PDO(_r_)\t\t((u64)(_r_) << 23)\n#define UCSI_GET_PDOS_PDO_OFFSET(_r_)\t\t((u64)(_r_) << 24)\n#define UCSI_GET_PDOS_NUM_PDOS(_r_)\t\t((u64)(_r_) << 32)\n#define UCSI_MAX_PDOS\t\t\t\t(4)\n#define UCSI_GET_PDOS_SRC_PDOS\t\t\t((u64)1 << 34)\n\n \n\n \n#define UCSI_ERROR_UNREGONIZED_CMD\t\tBIT(0)\n#define UCSI_ERROR_INVALID_CON_NUM\t\tBIT(1)\n#define UCSI_ERROR_INVALID_CMD_ARGUMENT\t\tBIT(2)\n#define UCSI_ERROR_INCOMPATIBLE_PARTNER\t\tBIT(3)\n#define UCSI_ERROR_CC_COMMUNICATION_ERR\t\tBIT(4)\n#define UCSI_ERROR_DEAD_BATTERY\t\t\tBIT(5)\n#define UCSI_ERROR_CONTRACT_NEGOTIATION_FAIL\tBIT(6)\n#define UCSI_ERROR_OVERCURRENT\t\t\tBIT(7)\n#define UCSI_ERROR_UNDEFINED\t\t\tBIT(8)\n#define UCSI_ERROR_PARTNER_REJECTED_SWAP\tBIT(9)\n#define UCSI_ERROR_HARD_RESET\t\t\tBIT(10)\n#define UCSI_ERROR_PPM_POLICY_CONFLICT\t\tBIT(11)\n#define UCSI_ERROR_SWAP_REJECTED\t\tBIT(12)\n\n#define UCSI_SET_NEW_CAM_ENTER(x)\t\t(((x) >> 23) & 0x1)\n#define UCSI_SET_NEW_CAM_GET_AM(x)\t\t(((x) >> 24) & 0xff)\n#define UCSI_SET_NEW_CAM_AM_MASK\t\t(0xff << 24)\n#define UCSI_SET_NEW_CAM_SET_AM(x)\t\t(((x) & 0xff) << 24)\n#define UCSI_CMD_CONNECTOR_MASK\t\t\t(0x7)\n\n \nstruct ucsi_capability {\n\tu32 attributes;\n#define UCSI_CAP_ATTR_DISABLE_STATE\t\tBIT(0)\n#define UCSI_CAP_ATTR_BATTERY_CHARGING\t\tBIT(1)\n#define UCSI_CAP_ATTR_USB_PD\t\t\tBIT(2)\n#define UCSI_CAP_ATTR_TYPEC_CURRENT\t\tBIT(6)\n#define UCSI_CAP_ATTR_POWER_AC_SUPPLY\t\tBIT(8)\n#define UCSI_CAP_ATTR_POWER_OTHER\t\tBIT(10)\n#define UCSI_CAP_ATTR_POWER_VBUS\t\tBIT(14)\n\tu8 num_connectors;\n\tu8 features;\n#define UCSI_CAP_SET_UOM\t\t\tBIT(0)\n#define UCSI_CAP_SET_PDM\t\t\tBIT(1)\n#define UCSI_CAP_ALT_MODE_DETAILS\t\tBIT(2)\n#define UCSI_CAP_ALT_MODE_OVERRIDE\t\tBIT(3)\n#define UCSI_CAP_PDO_DETAILS\t\t\tBIT(4)\n#define UCSI_CAP_CABLE_DETAILS\t\t\tBIT(5)\n#define UCSI_CAP_EXT_SUPPLY_NOTIFICATIONS\tBIT(6)\n#define UCSI_CAP_PD_RESET\t\t\tBIT(7)\n\tu16 reserved_1;\n\tu8 num_alt_modes;\n\tu8 reserved_2;\n\tu16 bc_version;\n\tu16 pd_version;\n\tu16 typec_version;\n} __packed;\n\n \nstruct ucsi_connector_capability {\n\tu8 op_mode;\n#define UCSI_CONCAP_OPMODE_DFP\t\t\tBIT(0)\n#define UCSI_CONCAP_OPMODE_UFP\t\t\tBIT(1)\n#define UCSI_CONCAP_OPMODE_DRP\t\t\tBIT(2)\n#define UCSI_CONCAP_OPMODE_AUDIO_ACCESSORY\tBIT(3)\n#define UCSI_CONCAP_OPMODE_DEBUG_ACCESSORY\tBIT(4)\n#define UCSI_CONCAP_OPMODE_USB2\t\t\tBIT(5)\n#define UCSI_CONCAP_OPMODE_USB3\t\t\tBIT(6)\n#define UCSI_CONCAP_OPMODE_ALT_MODE\t\tBIT(7)\n\tu8 flags;\n#define UCSI_CONCAP_FLAG_PROVIDER\t\tBIT(0)\n#define UCSI_CONCAP_FLAG_CONSUMER\t\tBIT(1)\n} __packed;\n\nstruct ucsi_altmode {\n\tu16 svid;\n\tu32 mid;\n} __packed;\n\n \nstruct ucsi_cable_property {\n\tu16 speed_supported;\n\tu8 current_capability;\n\tu8 flags;\n#define UCSI_CABLE_PROP_FLAG_VBUS_IN_CABLE\tBIT(0)\n#define UCSI_CABLE_PROP_FLAG_ACTIVE_CABLE\tBIT(1)\n#define UCSI_CABLE_PROP_FLAG_DIRECTIONALITY\tBIT(2)\n#define UCSI_CABLE_PROP_FLAG_PLUG_TYPE(_f_)\t((_f_) & GENMASK(3, 0))\n#define   UCSI_CABLE_PROPERTY_PLUG_TYPE_A\t0\n#define   UCSI_CABLE_PROPERTY_PLUG_TYPE_B\t1\n#define   UCSI_CABLE_PROPERTY_PLUG_TYPE_C\t2\n#define   UCSI_CABLE_PROPERTY_PLUG_OTHER\t3\n#define UCSI_CABLE_PROP_MODE_SUPPORT\t\tBIT(5)\n\tu8 latency;\n} __packed;\n\n \nstruct ucsi_connector_status {\n\tu16 change;\n#define UCSI_CONSTAT_EXT_SUPPLY_CHANGE\t\tBIT(1)\n#define UCSI_CONSTAT_POWER_OPMODE_CHANGE\tBIT(2)\n#define UCSI_CONSTAT_PDOS_CHANGE\t\tBIT(5)\n#define UCSI_CONSTAT_POWER_LEVEL_CHANGE\t\tBIT(6)\n#define UCSI_CONSTAT_PD_RESET_COMPLETE\t\tBIT(7)\n#define UCSI_CONSTAT_CAM_CHANGE\t\t\tBIT(8)\n#define UCSI_CONSTAT_BC_CHANGE\t\t\tBIT(9)\n#define UCSI_CONSTAT_PARTNER_CHANGE\t\tBIT(11)\n#define UCSI_CONSTAT_POWER_DIR_CHANGE\t\tBIT(12)\n#define UCSI_CONSTAT_CONNECT_CHANGE\t\tBIT(14)\n#define UCSI_CONSTAT_ERROR\t\t\tBIT(15)\n\tu16 flags;\n#define UCSI_CONSTAT_PWR_OPMODE(_f_)\t\t((_f_) & GENMASK(2, 0))\n#define   UCSI_CONSTAT_PWR_OPMODE_NONE\t\t0\n#define   UCSI_CONSTAT_PWR_OPMODE_DEFAULT\t1\n#define   UCSI_CONSTAT_PWR_OPMODE_BC\t\t2\n#define   UCSI_CONSTAT_PWR_OPMODE_PD\t\t3\n#define   UCSI_CONSTAT_PWR_OPMODE_TYPEC1_5\t4\n#define   UCSI_CONSTAT_PWR_OPMODE_TYPEC3_0\t5\n#define UCSI_CONSTAT_CONNECTED\t\t\tBIT(3)\n#define UCSI_CONSTAT_PWR_DIR\t\t\tBIT(4)\n#define UCSI_CONSTAT_PARTNER_FLAGS(_f_)\t\t(((_f_) & GENMASK(12, 5)) >> 5)\n#define   UCSI_CONSTAT_PARTNER_FLAG_USB\t\t1\n#define   UCSI_CONSTAT_PARTNER_FLAG_ALT_MODE\t2\n#define UCSI_CONSTAT_PARTNER_TYPE(_f_)\t\t(((_f_) & GENMASK(15, 13)) >> 13)\n#define   UCSI_CONSTAT_PARTNER_TYPE_DFP\t\t1\n#define   UCSI_CONSTAT_PARTNER_TYPE_UFP\t\t2\n#define   UCSI_CONSTAT_PARTNER_TYPE_CABLE\t3  \n#define   UCSI_CONSTAT_PARTNER_TYPE_CABLE_AND_UFP\t4  \n#define   UCSI_CONSTAT_PARTNER_TYPE_DEBUG\t5\n#define   UCSI_CONSTAT_PARTNER_TYPE_AUDIO\t6\n\tu32 request_data_obj;\n\tu8 pwr_status;\n#define UCSI_CONSTAT_BC_STATUS(_p_)\t\t((_p_) & GENMASK(2, 0))\n#define   UCSI_CONSTAT_BC_NOT_CHARGING\t\t0\n#define   UCSI_CONSTAT_BC_NOMINAL_CHARGING\t1\n#define   UCSI_CONSTAT_BC_SLOW_CHARGING\t\t2\n#define   UCSI_CONSTAT_BC_TRICKLE_CHARGING\t3\n#define UCSI_CONSTAT_PROVIDER_CAP_LIMIT(_p_)\t(((_p_) & GENMASK(6, 3)) >> 3)\n#define   UCSI_CONSTAT_CAP_PWR_LOWERED\t\t0\n#define   UCSI_CONSTAT_CAP_PWR_BUDGET_LIMIT\t1\n} __packed;\n\n \n\nstruct ucsi_debugfs_entry {\n\tu64 command;\n\tstruct ucsi_data {\n\t\tu64 low;\n\t\tu64 high;\n\t} response;\n\tu32 status;\n\tstruct dentry *dentry;\n};\n\nstruct ucsi {\n\tu16 version;\n\tstruct device *dev;\n\tstruct driver_data *driver_data;\n\n\tconst struct ucsi_operations *ops;\n\n\tstruct ucsi_capability cap;\n\tstruct ucsi_connector *connector;\n\tstruct ucsi_debugfs_entry *debugfs;\n\n\tstruct work_struct resume_work;\n\tstruct delayed_work work;\n\tint work_count;\n#define UCSI_ROLE_SWITCH_RETRY_PER_HZ\t10\n#define UCSI_ROLE_SWITCH_INTERVAL\t(HZ / UCSI_ROLE_SWITCH_RETRY_PER_HZ)\n#define UCSI_ROLE_SWITCH_WAIT_COUNT\t(10 * UCSI_ROLE_SWITCH_RETRY_PER_HZ)\n\n\t \n\tstruct mutex ppm_lock;\n\n\t \n\tu64 ntfy;\n\n\t \n\tunsigned long flags;\n#define EVENT_PENDING\t0\n#define COMMAND_PENDING\t1\n#define ACK_PENDING\t2\n};\n\n#define UCSI_MAX_SVID\t\t5\n#define UCSI_MAX_ALTMODES\t(UCSI_MAX_SVID * 6)\n\n#define UCSI_TYPEC_VSAFE5V\t5000\n#define UCSI_TYPEC_1_5_CURRENT\t1500\n#define UCSI_TYPEC_3_0_CURRENT\t3000\n\nstruct ucsi_connector {\n\tint num;\n\n\tstruct ucsi *ucsi;\n\tstruct mutex lock;  \n\tstruct work_struct work;\n\tstruct completion complete;\n\tstruct workqueue_struct *wq;\n\tstruct list_head partner_tasks;\n\n\tstruct typec_port *port;\n\tstruct typec_partner *partner;\n\n\tstruct typec_altmode *port_altmode[UCSI_MAX_ALTMODES];\n\tstruct typec_altmode *partner_altmode[UCSI_MAX_ALTMODES];\n\n\tstruct typec_capability typec_cap;\n\n\tstruct ucsi_connector_status status;\n\tstruct ucsi_connector_capability cap;\n\tstruct power_supply *psy;\n\tstruct power_supply_desc psy_desc;\n\tu32 rdo;\n\tu32 src_pdos[PDO_MAX_OBJECTS];\n\tint num_pdos;\n\n\t \n\tstruct usb_power_delivery *pd;\n\tstruct usb_power_delivery_capabilities *port_source_caps;\n\tstruct usb_power_delivery_capabilities *port_sink_caps;\n\tstruct usb_power_delivery *partner_pd;\n\tstruct usb_power_delivery_capabilities *partner_source_caps;\n\tstruct usb_power_delivery_capabilities *partner_sink_caps;\n\n\tstruct usb_role_switch *usb_role_sw;\n};\n\nint ucsi_send_command(struct ucsi *ucsi, u64 command,\n\t\t      void *retval, size_t size);\n\nvoid ucsi_altmode_update_active(struct ucsi_connector *con);\nint ucsi_resume(struct ucsi *ucsi);\n\n#if IS_ENABLED(CONFIG_POWER_SUPPLY)\nint ucsi_register_port_psy(struct ucsi_connector *con);\nvoid ucsi_unregister_port_psy(struct ucsi_connector *con);\nvoid ucsi_port_psy_changed(struct ucsi_connector *con);\n#else\nstatic inline int ucsi_register_port_psy(struct ucsi_connector *con) { return 0; }\nstatic inline void ucsi_unregister_port_psy(struct ucsi_connector *con) { }\nstatic inline void ucsi_port_psy_changed(struct ucsi_connector *con) { }\n#endif  \n\n#if IS_ENABLED(CONFIG_TYPEC_DP_ALTMODE)\nstruct typec_altmode *\nucsi_register_displayport(struct ucsi_connector *con,\n\t\t\t  bool override, int offset,\n\t\t\t  struct typec_altmode_desc *desc);\n\nvoid ucsi_displayport_remove_partner(struct typec_altmode *adev);\n\n#else\nstatic inline struct typec_altmode *\nucsi_register_displayport(struct ucsi_connector *con,\n\t\t\t  bool override, int offset,\n\t\t\t  struct typec_altmode_desc *desc)\n{\n\treturn NULL;\n}\n\nstatic inline void\nucsi_displayport_remove_partner(struct typec_altmode *adev) { }\n#endif  \n\n#ifdef CONFIG_DEBUG_FS\nvoid ucsi_debugfs_init(void);\nvoid ucsi_debugfs_exit(void);\nvoid ucsi_debugfs_register(struct ucsi *ucsi);\nvoid ucsi_debugfs_unregister(struct ucsi *ucsi);\n#else\nstatic inline void ucsi_debugfs_init(void) { }\nstatic inline void ucsi_debugfs_exit(void) { }\nstatic inline void ucsi_debugfs_register(struct ucsi *ucsi) { }\nstatic inline void ucsi_debugfs_unregister(struct ucsi *ucsi) { }\n#endif  \n\n \n#define USB_TYPEC_NVIDIA_VLINK_DP_VDO\t0x1\n#define USB_TYPEC_NVIDIA_VLINK_DBG_VDO\t0x3\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}