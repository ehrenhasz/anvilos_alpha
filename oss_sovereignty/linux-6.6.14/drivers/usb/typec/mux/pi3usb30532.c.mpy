{
  "module_name": "pi3usb30532.c",
  "hash_id": "977a09a1d39c85597cd88277c9f4f4154df21c59494117972cabe4a5030d73fc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/typec/mux/pi3usb30532.c",
  "human_readable_source": "\n \n\n#include <linux/i2c.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/usb/typec_dp.h>\n#include <linux/usb/typec_mux.h>\n\n#define PI3USB30532_CONF\t\t\t0x00\n\n#define PI3USB30532_CONF_OPEN\t\t\t0x00\n#define PI3USB30532_CONF_SWAP\t\t\t0x01\n#define PI3USB30532_CONF_4LANE_DP\t\t0x02\n#define PI3USB30532_CONF_USB3\t\t\t0x04\n#define PI3USB30532_CONF_USB3_AND_2LANE_DP\t0x06\n\nstruct pi3usb30532 {\n\tstruct i2c_client *client;\n\tstruct mutex lock;  \n\tstruct typec_switch_dev *sw;\n\tstruct typec_mux_dev *mux;\n\tu8 conf;\n};\n\nstatic int pi3usb30532_set_conf(struct pi3usb30532 *pi, u8 new_conf)\n{\n\tint ret = 0;\n\n\tif (pi->conf == new_conf)\n\t\treturn 0;\n\n\tret = i2c_smbus_write_byte_data(pi->client, PI3USB30532_CONF, new_conf);\n\tif (ret) {\n\t\tdev_err(&pi->client->dev, \"Error writing conf: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tpi->conf = new_conf;\n\treturn 0;\n}\n\nstatic int pi3usb30532_sw_set(struct typec_switch_dev *sw,\n\t\t\t      enum typec_orientation orientation)\n{\n\tstruct pi3usb30532 *pi = typec_switch_get_drvdata(sw);\n\tu8 new_conf;\n\tint ret;\n\n\tmutex_lock(&pi->lock);\n\tnew_conf = pi->conf;\n\n\tswitch (orientation) {\n\tcase TYPEC_ORIENTATION_NONE:\n\t\tnew_conf = PI3USB30532_CONF_OPEN;\n\t\tbreak;\n\tcase TYPEC_ORIENTATION_NORMAL:\n\t\tnew_conf &= ~PI3USB30532_CONF_SWAP;\n\t\tbreak;\n\tcase TYPEC_ORIENTATION_REVERSE:\n\t\tnew_conf |= PI3USB30532_CONF_SWAP;\n\t\tbreak;\n\t}\n\n\tret = pi3usb30532_set_conf(pi, new_conf);\n\tmutex_unlock(&pi->lock);\n\n\treturn ret;\n}\n\nstatic int\npi3usb30532_mux_set(struct typec_mux_dev *mux, struct typec_mux_state *state)\n{\n\tstruct pi3usb30532 *pi = typec_mux_get_drvdata(mux);\n\tu8 new_conf;\n\tint ret;\n\n\tmutex_lock(&pi->lock);\n\tnew_conf = pi->conf;\n\n\tswitch (state->mode) {\n\tcase TYPEC_STATE_SAFE:\n\t\tnew_conf = (new_conf & PI3USB30532_CONF_SWAP) |\n\t\t\t   PI3USB30532_CONF_OPEN;\n\t\tbreak;\n\tcase TYPEC_STATE_USB:\n\t\tnew_conf = (new_conf & PI3USB30532_CONF_SWAP) |\n\t\t\t   PI3USB30532_CONF_USB3;\n\t\tbreak;\n\tcase TYPEC_DP_STATE_C:\n\tcase TYPEC_DP_STATE_E:\n\t\tnew_conf = (new_conf & PI3USB30532_CONF_SWAP) |\n\t\t\t   PI3USB30532_CONF_4LANE_DP;\n\t\tbreak;\n\tcase TYPEC_DP_STATE_D:\n\t\tnew_conf = (new_conf & PI3USB30532_CONF_SWAP) |\n\t\t\t   PI3USB30532_CONF_USB3_AND_2LANE_DP;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tret = pi3usb30532_set_conf(pi, new_conf);\n\tmutex_unlock(&pi->lock);\n\n\treturn ret;\n}\n\nstatic int pi3usb30532_probe(struct i2c_client *client)\n{\n\tstruct device *dev = &client->dev;\n\tstruct typec_switch_desc sw_desc = { };\n\tstruct typec_mux_desc mux_desc = { };\n\tstruct pi3usb30532 *pi;\n\tint ret;\n\n\tpi = devm_kzalloc(dev, sizeof(*pi), GFP_KERNEL);\n\tif (!pi)\n\t\treturn -ENOMEM;\n\n\tpi->client = client;\n\tmutex_init(&pi->lock);\n\n\tret = i2c_smbus_read_byte_data(client, PI3USB30532_CONF);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Error reading config register %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tpi->conf = ret;\n\n\tsw_desc.drvdata = pi;\n\tsw_desc.fwnode = dev->fwnode;\n\tsw_desc.set = pi3usb30532_sw_set;\n\n\tpi->sw = typec_switch_register(dev, &sw_desc);\n\tif (IS_ERR(pi->sw)) {\n\t\tdev_err(dev, \"Error registering typec switch: %ld\\n\",\n\t\t\tPTR_ERR(pi->sw));\n\t\treturn PTR_ERR(pi->sw);\n\t}\n\n\tmux_desc.drvdata = pi;\n\tmux_desc.fwnode = dev->fwnode;\n\tmux_desc.set = pi3usb30532_mux_set;\n\n\tpi->mux = typec_mux_register(dev, &mux_desc);\n\tif (IS_ERR(pi->mux)) {\n\t\ttypec_switch_unregister(pi->sw);\n\t\tdev_err(dev, \"Error registering typec mux: %ld\\n\",\n\t\t\tPTR_ERR(pi->mux));\n\t\treturn PTR_ERR(pi->mux);\n\t}\n\n\ti2c_set_clientdata(client, pi);\n\treturn 0;\n}\n\nstatic void pi3usb30532_remove(struct i2c_client *client)\n{\n\tstruct pi3usb30532 *pi = i2c_get_clientdata(client);\n\n\ttypec_mux_unregister(pi->mux);\n\ttypec_switch_unregister(pi->sw);\n}\n\nstatic const struct i2c_device_id pi3usb30532_table[] = {\n\t{ \"pi3usb30532\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, pi3usb30532_table);\n\nstatic struct i2c_driver pi3usb30532_driver = {\n\t.driver = {\n\t\t.name = \"pi3usb30532\",\n\t},\n\t.probe\t\t= pi3usb30532_probe,\n\t.remove\t\t= pi3usb30532_remove,\n\t.id_table\t= pi3usb30532_table,\n};\n\nmodule_i2c_driver(pi3usb30532_driver);\n\nMODULE_AUTHOR(\"Hans de Goede <hdegoede@redhat.com>\");\nMODULE_DESCRIPTION(\"Pericom PI3USB30532 Type-C mux driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}