{
  "module_name": "tcpci_mt6360.c",
  "hash_id": "c9e18a1cdb8b90a90cc5f817cf8ec532aeda471b619991b80d93481ab1f91697",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/typec/tcpm/tcpci_mt6360.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/usb/tcpci.h>\n#include <linux/usb/tcpm.h>\n\n#define MT6360_REG_PHYCTRL1\t0x80\n#define MT6360_REG_PHYCTRL3\t0x82\n#define MT6360_REG_PHYCTRL7\t0x86\n#define MT6360_REG_VCONNCTRL1\t0x8C\n#define MT6360_REG_MODECTRL2\t0x8F\n#define MT6360_REG_SWRESET\t0xA0\n#define MT6360_REG_DEBCTRL1\t0xA1\n#define MT6360_REG_DRPCTRL1\t0xA2\n#define MT6360_REG_DRPCTRL2\t0xA3\n#define MT6360_REG_I2CTORST\t0xBF\n#define MT6360_REG_PHYCTRL11\t0xCA\n#define MT6360_REG_RXCTRL1\t0xCE\n#define MT6360_REG_RXCTRL2\t0xCF\n#define MT6360_REG_CTDCTRL2\t0xEC\n\n \n#define MT6360_VCONNCL_ENABLE\tBIT(0)\n \n#define MT6360_OPEN40M_ENABLE\tBIT(7)\n \n#define MT6360_RPONESHOT_ENABLE\tBIT(6)\n\nstruct mt6360_tcpc_info {\n\tstruct tcpci_data tdata;\n\tstruct tcpci *tcpci;\n\tstruct device *dev;\n\tint irq;\n};\n\nstatic inline int mt6360_tcpc_write16(struct regmap *regmap,\n\t\t\t\t      unsigned int reg, u16 val)\n{\n\treturn regmap_raw_write(regmap, reg, &val, sizeof(u16));\n}\n\nstatic int mt6360_tcpc_init(struct tcpci *tcpci, struct tcpci_data *tdata)\n{\n\tstruct regmap *regmap = tdata->regmap;\n\tint ret;\n\n\tret = regmap_write(regmap, MT6360_REG_SWRESET, 0x01);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tusleep_range(1000, 2000);\n\n\t \n\tret = mt6360_tcpc_write16(regmap, TCPC_ALERT_MASK, 0);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = regmap_write(regmap, MT6360_REG_I2CTORST, 0x8F);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = regmap_write(regmap, MT6360_REG_DEBCTRL1, 0x10);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = regmap_write(regmap, MT6360_REG_DRPCTRL1, 4);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt6360_tcpc_write16(regmap, MT6360_REG_DRPCTRL2, 330);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = regmap_update_bits(regmap, MT6360_REG_VCONNCTRL1, MT6360_VCONNCL_ENABLE,\n\t\t\t\t MT6360_VCONNCL_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = regmap_update_bits(regmap, MT6360_REG_RXCTRL2, MT6360_OPEN40M_ENABLE,\n\t\t\t\t MT6360_OPEN40M_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = regmap_update_bits(regmap, MT6360_REG_CTDCTRL2, MT6360_RPONESHOT_ENABLE,\n\t\t\t\t MT6360_RPONESHOT_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt6360_tcpc_write16(regmap, MT6360_REG_PHYCTRL1, 0x3A70);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_write(regmap, MT6360_REG_PHYCTRL3,  0x82);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_write(regmap, MT6360_REG_PHYCTRL7, 0x36);\n\tif (ret)\n\t\treturn ret;\n\n\tret = mt6360_tcpc_write16(regmap, MT6360_REG_PHYCTRL11, 0x3C60);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_write(regmap, MT6360_REG_RXCTRL1, 0xE8);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\treturn regmap_write(regmap, MT6360_REG_MODECTRL2, 0x7A);\n}\n\nstatic irqreturn_t mt6360_irq(int irq, void *dev_id)\n{\n\tstruct mt6360_tcpc_info *mti = dev_id;\n\n\treturn tcpci_irq(mti->tcpci);\n}\n\nstatic int mt6360_tcpc_probe(struct platform_device *pdev)\n{\n\tstruct mt6360_tcpc_info *mti;\n\tint ret;\n\n\tmti = devm_kzalloc(&pdev->dev, sizeof(*mti), GFP_KERNEL);\n\tif (!mti)\n\t\treturn -ENOMEM;\n\n\tmti->dev = &pdev->dev;\n\n\tmti->tdata.regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!mti->tdata.regmap) {\n\t\tdev_err(&pdev->dev, \"Failed to get parent regmap\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tmti->irq = platform_get_irq_byname(pdev, \"PD_IRQB\");\n\tif (mti->irq < 0)\n\t\treturn mti->irq;\n\n\tmti->tdata.init = mt6360_tcpc_init;\n\tmti->tcpci = tcpci_register_port(&pdev->dev, &mti->tdata);\n\tif (IS_ERR(mti->tcpci)) {\n\t\tdev_err(&pdev->dev, \"Failed to register tcpci port\\n\");\n\t\treturn PTR_ERR(mti->tcpci);\n\t}\n\n\tret = devm_request_threaded_irq(mti->dev, mti->irq, NULL, mt6360_irq, IRQF_ONESHOT,\n\t\t\t\t\tdev_name(&pdev->dev), mti);\n\tif (ret) {\n\t\tdev_err(mti->dev, \"Failed to register irq\\n\");\n\t\ttcpci_unregister_port(mti->tcpci);\n\t\treturn ret;\n\t}\n\n\tdevice_init_wakeup(&pdev->dev, true);\n\tplatform_set_drvdata(pdev, mti);\n\n\treturn 0;\n}\n\nstatic void mt6360_tcpc_remove(struct platform_device *pdev)\n{\n\tstruct mt6360_tcpc_info *mti = platform_get_drvdata(pdev);\n\n\tdisable_irq(mti->irq);\n\ttcpci_unregister_port(mti->tcpci);\n}\n\nstatic int __maybe_unused mt6360_tcpc_suspend(struct device *dev)\n{\n\tstruct mt6360_tcpc_info *mti = dev_get_drvdata(dev);\n\n\tif (device_may_wakeup(dev))\n\t\tenable_irq_wake(mti->irq);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused mt6360_tcpc_resume(struct device *dev)\n{\n\tstruct mt6360_tcpc_info *mti = dev_get_drvdata(dev);\n\n\tif (device_may_wakeup(dev))\n\t\tdisable_irq_wake(mti->irq);\n\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(mt6360_tcpc_pm_ops, mt6360_tcpc_suspend, mt6360_tcpc_resume);\n\nstatic const struct of_device_id __maybe_unused mt6360_tcpc_of_id[] = {\n\t{ .compatible = \"mediatek,mt6360-tcpc\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, mt6360_tcpc_of_id);\n\nstatic struct platform_driver mt6360_tcpc_driver = {\n\t.driver = {\n\t\t.name = \"mt6360-tcpc\",\n\t\t.pm = &mt6360_tcpc_pm_ops,\n\t\t.of_match_table = mt6360_tcpc_of_id,\n\t},\n\t.probe = mt6360_tcpc_probe,\n\t.remove_new = mt6360_tcpc_remove,\n};\nmodule_platform_driver(mt6360_tcpc_driver);\n\nMODULE_AUTHOR(\"ChiYuan Huang <cy_huang@richtek.com>\");\nMODULE_DESCRIPTION(\"MT6360 USB Type-C Port Controller Interface Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}