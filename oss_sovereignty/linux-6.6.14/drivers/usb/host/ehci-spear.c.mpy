{
  "module_name": "ehci-spear.c",
  "hash_id": "f09e9504d25dc4323bec53b1a7026e6c1920264e0ed0456f424c80fe9dc8e911",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/ehci-spear.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/dma-mapping.h>\n#include <linux/io.h>\n#include <linux/jiffies.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/pm.h>\n#include <linux/usb.h>\n#include <linux/usb/hcd.h>\n\n#include \"ehci.h\"\n\n#define DRIVER_DESC \"EHCI SPEAr driver\"\n\nstruct spear_ehci {\n\tstruct clk *clk;\n};\n\n#define to_spear_ehci(hcd)\t(struct spear_ehci *)(hcd_to_ehci(hcd)->priv)\n\nstatic struct hc_driver __read_mostly ehci_spear_hc_driver;\n\nstatic int __maybe_unused ehci_spear_drv_suspend(struct device *dev)\n{\n\tstruct usb_hcd *hcd = dev_get_drvdata(dev);\n\tbool do_wakeup = device_may_wakeup(dev);\n\n\treturn ehci_suspend(hcd, do_wakeup);\n}\n\nstatic int __maybe_unused ehci_spear_drv_resume(struct device *dev)\n{\n\tstruct usb_hcd *hcd = dev_get_drvdata(dev);\n\n\tehci_resume(hcd, false);\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(ehci_spear_pm_ops, ehci_spear_drv_suspend,\n\t\tehci_spear_drv_resume);\n\nstatic int spear_ehci_hcd_drv_probe(struct platform_device *pdev)\n{\n\tstruct usb_hcd *hcd ;\n\tstruct spear_ehci *sehci;\n\tstruct resource *res;\n\tstruct clk *usbh_clk;\n\tconst struct hc_driver *driver = &ehci_spear_hc_driver;\n\tint irq, retval;\n\n\tif (usb_disabled())\n\t\treturn -ENODEV;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0) {\n\t\tretval = irq;\n\t\tgoto fail;\n\t}\n\n\t \n\tretval = dma_coerce_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(32));\n\tif (retval)\n\t\tgoto fail;\n\n\tusbh_clk = devm_clk_get(&pdev->dev, NULL);\n\tif (IS_ERR(usbh_clk)) {\n\t\tdev_err(&pdev->dev, \"Error getting interface clock\\n\");\n\t\tretval = PTR_ERR(usbh_clk);\n\t\tgoto fail;\n\t}\n\n\thcd = usb_create_hcd(driver, &pdev->dev, dev_name(&pdev->dev));\n\tif (!hcd) {\n\t\tretval = -ENOMEM;\n\t\tgoto fail;\n\t}\n\n\thcd->regs = devm_platform_get_and_ioremap_resource(pdev, 0, &res);\n\tif (IS_ERR(hcd->regs)) {\n\t\tretval = PTR_ERR(hcd->regs);\n\t\tgoto err_put_hcd;\n\t}\n\thcd->rsrc_start = res->start;\n\thcd->rsrc_len = resource_size(res);\n\n\tsehci = to_spear_ehci(hcd);\n\tsehci->clk = usbh_clk;\n\n\t \n\thcd_to_ehci(hcd)->caps = hcd->regs;\n\n\tclk_prepare_enable(sehci->clk);\n\tretval = usb_add_hcd(hcd, irq, IRQF_SHARED);\n\tif (retval)\n\t\tgoto err_stop_ehci;\n\n\tdevice_wakeup_enable(hcd->self.controller);\n\treturn retval;\n\nerr_stop_ehci:\n\tclk_disable_unprepare(sehci->clk);\nerr_put_hcd:\n\tusb_put_hcd(hcd);\nfail:\n\tdev_err(&pdev->dev, \"init fail, %d\\n\", retval);\n\n\treturn retval ;\n}\n\nstatic void spear_ehci_hcd_drv_remove(struct platform_device *pdev)\n{\n\tstruct usb_hcd *hcd = platform_get_drvdata(pdev);\n\tstruct spear_ehci *sehci = to_spear_ehci(hcd);\n\n\tusb_remove_hcd(hcd);\n\n\tif (sehci->clk)\n\t\tclk_disable_unprepare(sehci->clk);\n\tusb_put_hcd(hcd);\n}\n\nstatic const struct of_device_id spear_ehci_id_table[] = {\n\t{ .compatible = \"st,spear600-ehci\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, spear_ehci_id_table);\n\nstatic struct platform_driver spear_ehci_hcd_driver = {\n\t.probe\t\t= spear_ehci_hcd_drv_probe,\n\t.remove_new\t= spear_ehci_hcd_drv_remove,\n\t.shutdown\t= usb_hcd_platform_shutdown,\n\t.driver\t\t= {\n\t\t.name = \"spear-ehci\",\n\t\t.bus = &platform_bus_type,\n\t\t.pm = pm_ptr(&ehci_spear_pm_ops),\n\t\t.of_match_table = spear_ehci_id_table,\n\t}\n};\n\nstatic const struct ehci_driver_overrides spear_overrides __initconst = {\n\t.extra_priv_size = sizeof(struct spear_ehci),\n};\n\nstatic int __init ehci_spear_init(void)\n{\n\tif (usb_disabled())\n\t\treturn -ENODEV;\n\n\tehci_init_driver(&ehci_spear_hc_driver, &spear_overrides);\n\treturn platform_driver_register(&spear_ehci_hcd_driver);\n}\nmodule_init(ehci_spear_init);\n\nstatic void __exit ehci_spear_cleanup(void)\n{\n\tplatform_driver_unregister(&spear_ehci_hcd_driver);\n}\nmodule_exit(ehci_spear_cleanup);\n\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_ALIAS(\"platform:spear-ehci\");\nMODULE_AUTHOR(\"Deepak Sikri\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}