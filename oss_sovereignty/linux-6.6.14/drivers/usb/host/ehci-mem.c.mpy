{
  "module_name": "ehci-mem.c",
  "hash_id": "d97b6f39d8b54643216b5a337160dcf6775a4497882c0de0727c171578c1411d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/ehci-mem.c",
  "human_readable_source": "\n \n\n \n\n \n\n \n\n \n\n \n\nstatic inline void ehci_qtd_init(struct ehci_hcd *ehci, struct ehci_qtd *qtd,\n\t\t\t\t  dma_addr_t dma)\n{\n\tmemset (qtd, 0, sizeof *qtd);\n\tqtd->qtd_dma = dma;\n\tqtd->hw_token = cpu_to_hc32(ehci, QTD_STS_HALT);\n\tqtd->hw_next = EHCI_LIST_END(ehci);\n\tqtd->hw_alt_next = EHCI_LIST_END(ehci);\n\tINIT_LIST_HEAD (&qtd->qtd_list);\n}\n\nstatic struct ehci_qtd *ehci_qtd_alloc (struct ehci_hcd *ehci, gfp_t flags)\n{\n\tstruct ehci_qtd\t\t*qtd;\n\tdma_addr_t\t\tdma;\n\n\tqtd = dma_pool_alloc (ehci->qtd_pool, flags, &dma);\n\tif (qtd != NULL) {\n\t\tehci_qtd_init(ehci, qtd, dma);\n\t}\n\treturn qtd;\n}\n\nstatic inline void ehci_qtd_free (struct ehci_hcd *ehci, struct ehci_qtd *qtd)\n{\n\tdma_pool_free (ehci->qtd_pool, qtd, qtd->qtd_dma);\n}\n\n\nstatic void qh_destroy(struct ehci_hcd *ehci, struct ehci_qh *qh)\n{\n\t \n\tif (!list_empty (&qh->qtd_list) || qh->qh_next.ptr) {\n\t\tehci_dbg (ehci, \"unused qh not empty!\\n\");\n\t\tBUG ();\n\t}\n\tif (qh->dummy)\n\t\tehci_qtd_free (ehci, qh->dummy);\n\tdma_pool_free(ehci->qh_pool, qh->hw, qh->qh_dma);\n\tkfree(qh);\n}\n\nstatic struct ehci_qh *ehci_qh_alloc (struct ehci_hcd *ehci, gfp_t flags)\n{\n\tstruct ehci_qh\t\t*qh;\n\tdma_addr_t\t\tdma;\n\n\tqh = kzalloc(sizeof *qh, GFP_ATOMIC);\n\tif (!qh)\n\t\tgoto done;\n\tqh->hw = (struct ehci_qh_hw *)\n\t\tdma_pool_zalloc(ehci->qh_pool, flags, &dma);\n\tif (!qh->hw)\n\t\tgoto fail;\n\tqh->qh_dma = dma;\n\t\n\tINIT_LIST_HEAD (&qh->qtd_list);\n\tINIT_LIST_HEAD(&qh->unlink_node);\n\n\t \n\tqh->dummy = ehci_qtd_alloc (ehci, flags);\n\tif (qh->dummy == NULL) {\n\t\tehci_dbg (ehci, \"no dummy td\\n\");\n\t\tgoto fail1;\n\t}\ndone:\n\treturn qh;\nfail1:\n\tdma_pool_free(ehci->qh_pool, qh->hw, qh->qh_dma);\nfail:\n\tkfree(qh);\n\treturn NULL;\n}\n\n \n\n \n\nstatic void ehci_mem_cleanup (struct ehci_hcd *ehci)\n{\n\tif (ehci->async)\n\t\tqh_destroy(ehci, ehci->async);\n\tehci->async = NULL;\n\n\tif (ehci->dummy)\n\t\tqh_destroy(ehci, ehci->dummy);\n\tehci->dummy = NULL;\n\n\t \n\tdma_pool_destroy(ehci->qtd_pool);\n\tehci->qtd_pool = NULL;\n\tdma_pool_destroy(ehci->qh_pool);\n\tehci->qh_pool = NULL;\n\tdma_pool_destroy(ehci->itd_pool);\n\tehci->itd_pool = NULL;\n\tdma_pool_destroy(ehci->sitd_pool);\n\tehci->sitd_pool = NULL;\n\n\tif (ehci->periodic)\n\t\tdma_free_coherent(ehci_to_hcd(ehci)->self.sysdev,\n\t\t\tehci->periodic_size * sizeof (u32),\n\t\t\tehci->periodic, ehci->periodic_dma);\n\tehci->periodic = NULL;\n\n\t \n\tkfree(ehci->pshadow);\n\tehci->pshadow = NULL;\n}\n\n \nstatic int ehci_mem_init (struct ehci_hcd *ehci, gfp_t flags)\n{\n\tint i;\n\n\t \n\tehci->qtd_pool = dma_pool_create (\"ehci_qtd\",\n\t\t\tehci_to_hcd(ehci)->self.sysdev,\n\t\t\tsizeof (struct ehci_qtd),\n\t\t\t32  ,\n\t\t\t4096  );\n\tif (!ehci->qtd_pool) {\n\t\tgoto fail;\n\t}\n\n\t \n\tehci->qh_pool = dma_pool_create (\"ehci_qh\",\n\t\t\tehci_to_hcd(ehci)->self.sysdev,\n\t\t\tsizeof(struct ehci_qh_hw),\n\t\t\t32  ,\n\t\t\t4096  );\n\tif (!ehci->qh_pool) {\n\t\tgoto fail;\n\t}\n\tehci->async = ehci_qh_alloc (ehci, flags);\n\tif (!ehci->async) {\n\t\tgoto fail;\n\t}\n\n\t \n\tehci->itd_pool = dma_pool_create (\"ehci_itd\",\n\t\t\tehci_to_hcd(ehci)->self.sysdev,\n\t\t\tsizeof (struct ehci_itd),\n\t\t\t32  ,\n\t\t\t4096  );\n\tif (!ehci->itd_pool) {\n\t\tgoto fail;\n\t}\n\n\t \n\tehci->sitd_pool = dma_pool_create (\"ehci_sitd\",\n\t\t\tehci_to_hcd(ehci)->self.sysdev,\n\t\t\tsizeof (struct ehci_sitd),\n\t\t\t32  ,\n\t\t\t4096  );\n\tif (!ehci->sitd_pool) {\n\t\tgoto fail;\n\t}\n\n\t \n\tehci->periodic = (__le32 *)\n\t\tdma_alloc_coherent(ehci_to_hcd(ehci)->self.sysdev,\n\t\t\tehci->periodic_size * sizeof(__le32),\n\t\t\t&ehci->periodic_dma, flags);\n\tif (ehci->periodic == NULL) {\n\t\tgoto fail;\n\t}\n\n\tif (ehci->use_dummy_qh) {\n\t\tstruct ehci_qh_hw\t*hw;\n\t\tehci->dummy = ehci_qh_alloc(ehci, flags);\n\t\tif (!ehci->dummy)\n\t\t\tgoto fail;\n\n\t\thw = ehci->dummy->hw;\n\t\thw->hw_next = EHCI_LIST_END(ehci);\n\t\thw->hw_qtd_next = EHCI_LIST_END(ehci);\n\t\thw->hw_alt_next = EHCI_LIST_END(ehci);\n\t\tehci->dummy->hw = hw;\n\n\t\tfor (i = 0; i < ehci->periodic_size; i++)\n\t\t\tehci->periodic[i] = cpu_to_hc32(ehci,\n\t\t\t\t\tehci->dummy->qh_dma);\n\t} else {\n\t\tfor (i = 0; i < ehci->periodic_size; i++)\n\t\t\tehci->periodic[i] = EHCI_LIST_END(ehci);\n\t}\n\n\t \n\tehci->pshadow = kcalloc(ehci->periodic_size, sizeof(void *), flags);\n\tif (ehci->pshadow != NULL)\n\t\treturn 0;\n\nfail:\n\tehci_dbg (ehci, \"couldn't init memory\\n\");\n\tehci_mem_cleanup (ehci);\n\treturn -ENOMEM;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}