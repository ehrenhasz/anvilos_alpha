{
  "module_name": "xhci-rcar.c",
  "hash_id": "3894ce14597b3dd97ce2082822a6020aceb8a32d4c1ac3bed128a25575269d4a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/xhci-rcar.c",
  "human_readable_source": "\n \n\n#include <linux/firmware.h>\n#include <linux/iopoll.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/of.h>\n#include <linux/usb/phy.h>\n\n#include \"xhci.h\"\n#include \"xhci-plat.h\"\n#include \"xhci-rzv2m.h\"\n\n#define XHCI_RCAR_FIRMWARE_NAME_V1\t\"r8a779x_usb3_v1.dlmem\"\n#define XHCI_RCAR_FIRMWARE_NAME_V3\t\"r8a779x_usb3_v3.dlmem\"\n\n \nMODULE_FIRMWARE(XHCI_RCAR_FIRMWARE_NAME_V1);\nMODULE_FIRMWARE(XHCI_RCAR_FIRMWARE_NAME_V3);\n\n \n#define RCAR_USB3_AXH_STA\t0x104\t \n#define RCAR_USB3_INT_ENA\t0x224\t \n#define RCAR_USB3_DL_CTRL\t0x250\t \n#define RCAR_USB3_FW_DATA0\t0x258\t \n\n#define RCAR_USB3_LCLK\t\t0xa44\t \n#define RCAR_USB3_CONF1\t\t0xa48\t \n#define RCAR_USB3_CONF2\t\t0xa5c\t \n#define RCAR_USB3_CONF3\t\t0xaa8\t \n#define RCAR_USB3_RX_POL\t0xab0\t \n#define RCAR_USB3_TX_POL\t0xab8\t \n\n \n \n#define RCAR_USB3_AXH_STA_B3_PLL_ACTIVE\t\t0x00010000\n#define RCAR_USB3_AXH_STA_B2_PLL_ACTIVE\t\t0x00000001\n#define RCAR_USB3_AXH_STA_PLL_ACTIVE_MASK (RCAR_USB3_AXH_STA_B3_PLL_ACTIVE | \\\n\t\t\t\t\t   RCAR_USB3_AXH_STA_B2_PLL_ACTIVE)\n\n \n#define RCAR_USB3_INT_XHC_ENA\t0x00000001\n#define RCAR_USB3_INT_PME_ENA\t0x00000002\n#define RCAR_USB3_INT_HSE_ENA\t0x00000004\n#define RCAR_USB3_INT_ENA_VAL\t(RCAR_USB3_INT_XHC_ENA | \\\n\t\t\t\tRCAR_USB3_INT_PME_ENA | RCAR_USB3_INT_HSE_ENA)\n\n \n#define RCAR_USB3_DL_CTRL_ENABLE\t0x00000001\n#define RCAR_USB3_DL_CTRL_FW_SUCCESS\t0x00000010\n#define RCAR_USB3_DL_CTRL_FW_SET_DATA0\t0x00000100\n\n \n#define RCAR_USB3_LCLK_ENA_VAL\t0x01030001\n\n \n#define RCAR_USB3_CONF1_VAL\t0x00030204\n#define RCAR_USB3_CONF2_VAL\t0x00030300\n#define RCAR_USB3_CONF3_VAL\t0x13802007\n\n \n#define RCAR_USB3_RX_POL_VAL\tBIT(21)\n#define RCAR_USB3_TX_POL_VAL\tBIT(4)\n\nstatic void xhci_rcar_start_gen2(struct usb_hcd *hcd)\n{\n\t \n\twritel(RCAR_USB3_LCLK_ENA_VAL, hcd->regs + RCAR_USB3_LCLK);\n\t \n\twritel(RCAR_USB3_CONF1_VAL, hcd->regs + RCAR_USB3_CONF1);\n\twritel(RCAR_USB3_CONF2_VAL, hcd->regs + RCAR_USB3_CONF2);\n\twritel(RCAR_USB3_CONF3_VAL, hcd->regs + RCAR_USB3_CONF3);\n\t \n\twritel(RCAR_USB3_RX_POL_VAL, hcd->regs + RCAR_USB3_RX_POL);\n\twritel(RCAR_USB3_TX_POL_VAL, hcd->regs + RCAR_USB3_TX_POL);\n}\n\nstatic int xhci_rcar_is_gen2(struct device *dev)\n{\n\tstruct device_node *node = dev->of_node;\n\n\treturn of_device_is_compatible(node, \"renesas,xhci-r8a7790\") ||\n\t\tof_device_is_compatible(node, \"renesas,xhci-r8a7791\") ||\n\t\tof_device_is_compatible(node, \"renesas,xhci-r8a7793\") ||\n\t\tof_device_is_compatible(node, \"renesas,rcar-gen2-xhci\");\n}\n\nstatic void xhci_rcar_start(struct usb_hcd *hcd)\n{\n\tu32 temp;\n\n\tif (hcd->regs != NULL) {\n\t\t \n\t\ttemp = readl(hcd->regs + RCAR_USB3_INT_ENA);\n\t\ttemp |= RCAR_USB3_INT_ENA_VAL;\n\t\twritel(temp, hcd->regs + RCAR_USB3_INT_ENA);\n\t\tif (xhci_rcar_is_gen2(hcd->self.controller))\n\t\t\txhci_rcar_start_gen2(hcd);\n\t}\n}\n\nstatic int xhci_rcar_download_firmware(struct usb_hcd *hcd)\n{\n\tstruct device *dev = hcd->self.controller;\n\tvoid __iomem *regs = hcd->regs;\n\tstruct xhci_plat_priv *priv = hcd_to_xhci_priv(hcd);\n\tconst struct firmware *fw;\n\tint retval, index, j;\n\tu32 data, val, temp;\n\n\t \n\tif (readl(regs + RCAR_USB3_DL_CTRL) & RCAR_USB3_DL_CTRL_FW_SUCCESS)\n\t\treturn 0;\n\n\t \n\tretval = request_firmware(&fw, priv->firmware_name, dev);\n\tif (retval)\n\t\treturn retval;\n\n\t \n\ttemp = readl(regs + RCAR_USB3_DL_CTRL);\n\ttemp |= RCAR_USB3_DL_CTRL_ENABLE;\n\twritel(temp, regs + RCAR_USB3_DL_CTRL);\n\n\tfor (index = 0; index < fw->size; index += 4) {\n\t\t \n\t\tfor (data = 0, j = 3; j >= 0; j--) {\n\t\t\tif ((j + index) < fw->size)\n\t\t\t\tdata |= fw->data[index + j] << (8 * j);\n\t\t}\n\t\twritel(data, regs + RCAR_USB3_FW_DATA0);\n\t\ttemp = readl(regs + RCAR_USB3_DL_CTRL);\n\t\ttemp |= RCAR_USB3_DL_CTRL_FW_SET_DATA0;\n\t\twritel(temp, regs + RCAR_USB3_DL_CTRL);\n\n\t\tretval = readl_poll_timeout_atomic(regs + RCAR_USB3_DL_CTRL,\n\t\t\t\tval, !(val & RCAR_USB3_DL_CTRL_FW_SET_DATA0),\n\t\t\t\t1, 10000);\n\t\tif (retval < 0)\n\t\t\tbreak;\n\t}\n\n\ttemp = readl(regs + RCAR_USB3_DL_CTRL);\n\ttemp &= ~RCAR_USB3_DL_CTRL_ENABLE;\n\twritel(temp, regs + RCAR_USB3_DL_CTRL);\n\n\tretval = readl_poll_timeout_atomic((regs + RCAR_USB3_DL_CTRL),\n\t\t\tval, val & RCAR_USB3_DL_CTRL_FW_SUCCESS, 1, 10000);\n\n\trelease_firmware(fw);\n\n\treturn retval;\n}\n\nstatic bool xhci_rcar_wait_for_pll_active(struct usb_hcd *hcd)\n{\n\tint retval;\n\tu32 val, mask = RCAR_USB3_AXH_STA_PLL_ACTIVE_MASK;\n\n\tretval = readl_poll_timeout_atomic(hcd->regs + RCAR_USB3_AXH_STA,\n\t\t\tval, (val & mask) == mask, 1, 1000);\n\treturn !retval;\n}\n\n \nstatic int xhci_rcar_init_quirk(struct usb_hcd *hcd)\n{\n\t \n\tif (!hcd->regs)\n\t\treturn 0;\n\n\tif (!xhci_rcar_wait_for_pll_active(hcd))\n\t\treturn -ETIMEDOUT;\n\n\treturn xhci_rcar_download_firmware(hcd);\n}\n\nstatic int xhci_rcar_resume_quirk(struct usb_hcd *hcd)\n{\n\tint ret;\n\n\tret = xhci_rcar_download_firmware(hcd);\n\tif (!ret)\n\t\txhci_rcar_start(hcd);\n\n\treturn ret;\n}\n\n \n#define SET_XHCI_PLAT_PRIV_FOR_RCAR(firmware)\t\t\t\t\\\n\t.firmware_name = firmware,\t\t\t\t\t\\\n\t.quirks = XHCI_NO_64BIT_SUPPORT | XHCI_TRUST_TX_LENGTH |\t\\\n\t\t  XHCI_SLOW_SUSPEND,\t\t\t\t\t\\\n\t.init_quirk = xhci_rcar_init_quirk,\t\t\t\t\\\n\t.plat_start = xhci_rcar_start,\t\t\t\t\t\\\n\t.resume_quirk = xhci_rcar_resume_quirk,\n\nstatic const struct xhci_plat_priv xhci_plat_renesas_rcar_gen2 = {\n\tSET_XHCI_PLAT_PRIV_FOR_RCAR(XHCI_RCAR_FIRMWARE_NAME_V1)\n};\n\nstatic const struct xhci_plat_priv xhci_plat_renesas_rcar_gen3 = {\n\tSET_XHCI_PLAT_PRIV_FOR_RCAR(XHCI_RCAR_FIRMWARE_NAME_V3)\n};\n\nstatic const struct xhci_plat_priv xhci_plat_renesas_rzv2m = {\n\t.quirks = XHCI_NO_64BIT_SUPPORT | XHCI_TRUST_TX_LENGTH |\n\t\t  XHCI_SLOW_SUSPEND,\n\t.init_quirk = xhci_rzv2m_init_quirk,\n\t.plat_start = xhci_rzv2m_start,\n};\n\nstatic const struct of_device_id usb_xhci_of_match[] = {\n\t{\n\t\t.compatible = \"renesas,xhci-r8a7790\",\n\t\t.data = &xhci_plat_renesas_rcar_gen2,\n\t}, {\n\t\t.compatible = \"renesas,xhci-r8a7791\",\n\t\t.data = &xhci_plat_renesas_rcar_gen2,\n\t}, {\n\t\t.compatible = \"renesas,xhci-r8a7793\",\n\t\t.data = &xhci_plat_renesas_rcar_gen2,\n\t}, {\n\t\t.compatible = \"renesas,xhci-r8a7795\",\n\t\t.data = &xhci_plat_renesas_rcar_gen3,\n\t}, {\n\t\t.compatible = \"renesas,xhci-r8a7796\",\n\t\t.data = &xhci_plat_renesas_rcar_gen3,\n\t}, {\n\t\t.compatible = \"renesas,rcar-gen2-xhci\",\n\t\t.data = &xhci_plat_renesas_rcar_gen2,\n\t}, {\n\t\t.compatible = \"renesas,rcar-gen3-xhci\",\n\t\t.data = &xhci_plat_renesas_rcar_gen3,\n\t}, {\n\t\t.compatible = \"renesas,rzv2m-xhci\",\n\t\t.data = &xhci_plat_renesas_rzv2m,\n\t},\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, usb_xhci_of_match);\n\nstatic int xhci_renesas_probe(struct platform_device *pdev)\n{\n\tconst struct xhci_plat_priv *priv_match;\n\n\tpriv_match = of_device_get_match_data(&pdev->dev);\n\n\treturn xhci_plat_probe(pdev, NULL, priv_match);\n}\n\nstatic struct platform_driver usb_xhci_renesas_driver = {\n\t.probe = xhci_renesas_probe,\n\t.remove_new = xhci_plat_remove,\n\t.shutdown = usb_hcd_platform_shutdown,\n\t.driver = {\n\t\t.name = \"xhci-renesas-hcd\",\n\t\t.pm = &xhci_plat_pm_ops,\n\t\t.of_match_table = usb_xhci_of_match,\n\t},\n};\nmodule_platform_driver(usb_xhci_renesas_driver);\n\nMODULE_DESCRIPTION(\"xHCI Platform Host Controller Driver for Renesas R-Car and RZ\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}