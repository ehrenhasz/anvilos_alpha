{
  "module_name": "ohci-spear.c",
  "hash_id": "ba9bafa6376a3bdf1ef5e7b16689cc9412c741fc07a2b9591d44904928fe704f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/ohci-spear.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/dma-mapping.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/signal.h>\n#include <linux/usb.h>\n#include <linux/usb/hcd.h>\n\n#include \"ohci.h\"\n\n#define DRIVER_DESC \"OHCI SPEAr driver\"\n\nstruct spear_ohci {\n\tstruct clk *clk;\n};\n\n#define to_spear_ohci(hcd)     (struct spear_ohci *)(hcd_to_ohci(hcd)->priv)\n\nstatic struct hc_driver __read_mostly ohci_spear_hc_driver;\n\nstatic int spear_ohci_hcd_drv_probe(struct platform_device *pdev)\n{\n\tconst struct hc_driver *driver = &ohci_spear_hc_driver;\n\tstruct usb_hcd *hcd = NULL;\n\tstruct clk *usbh_clk;\n\tstruct spear_ohci *sohci_p;\n\tstruct resource *res;\n\tint retval, irq;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0) {\n\t\tretval = irq;\n\t\tgoto fail;\n\t}\n\n\t \n\tretval = dma_coerce_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(32));\n\tif (retval)\n\t\tgoto fail;\n\n\tusbh_clk = devm_clk_get(&pdev->dev, NULL);\n\tif (IS_ERR(usbh_clk)) {\n\t\tdev_err(&pdev->dev, \"Error getting interface clock\\n\");\n\t\tretval = PTR_ERR(usbh_clk);\n\t\tgoto fail;\n\t}\n\n\thcd = usb_create_hcd(driver, &pdev->dev, dev_name(&pdev->dev));\n\tif (!hcd) {\n\t\tretval = -ENOMEM;\n\t\tgoto fail;\n\t}\n\n\thcd->regs = devm_platform_get_and_ioremap_resource(pdev, 0, &res);\n\tif (IS_ERR(hcd->regs)) {\n\t\tretval = PTR_ERR(hcd->regs);\n\t\tgoto err_put_hcd;\n\t}\n\n\thcd->rsrc_start = res->start;\n\thcd->rsrc_len = resource_size(res);\n\n\tsohci_p = to_spear_ohci(hcd);\n\tsohci_p->clk = usbh_clk;\n\n\tclk_prepare_enable(sohci_p->clk);\n\n\tretval = usb_add_hcd(hcd, irq, 0);\n\tif (retval == 0) {\n\t\tdevice_wakeup_enable(hcd->self.controller);\n\t\treturn retval;\n\t}\n\n\tclk_disable_unprepare(sohci_p->clk);\nerr_put_hcd:\n\tusb_put_hcd(hcd);\nfail:\n\tdev_err(&pdev->dev, \"init fail, %d\\n\", retval);\n\n\treturn retval;\n}\n\nstatic void spear_ohci_hcd_drv_remove(struct platform_device *pdev)\n{\n\tstruct usb_hcd *hcd = platform_get_drvdata(pdev);\n\tstruct spear_ohci *sohci_p = to_spear_ohci(hcd);\n\n\tusb_remove_hcd(hcd);\n\tif (sohci_p->clk)\n\t\tclk_disable_unprepare(sohci_p->clk);\n\n\tusb_put_hcd(hcd);\n}\n\n#if defined(CONFIG_PM)\nstatic int spear_ohci_hcd_drv_suspend(struct platform_device *pdev,\n\t\tpm_message_t message)\n{\n\tstruct usb_hcd *hcd = platform_get_drvdata(pdev);\n\tstruct ohci_hcd\t*ohci = hcd_to_ohci(hcd);\n\tstruct spear_ohci *sohci_p = to_spear_ohci(hcd);\n\tbool do_wakeup = device_may_wakeup(&pdev->dev);\n\tint ret;\n\n\tif (time_before(jiffies, ohci->next_statechange))\n\t\tmsleep(5);\n\tohci->next_statechange = jiffies;\n\n\tret = ohci_suspend(hcd, do_wakeup);\n\tif (ret)\n\t\treturn ret;\n\n\tclk_disable_unprepare(sohci_p->clk);\n\n\treturn ret;\n}\n\nstatic int spear_ohci_hcd_drv_resume(struct platform_device *dev)\n{\n\tstruct usb_hcd *hcd = platform_get_drvdata(dev);\n\tstruct ohci_hcd\t*ohci = hcd_to_ohci(hcd);\n\tstruct spear_ohci *sohci_p = to_spear_ohci(hcd);\n\n\tif (time_before(jiffies, ohci->next_statechange))\n\t\tmsleep(5);\n\tohci->next_statechange = jiffies;\n\n\tclk_prepare_enable(sohci_p->clk);\n\tohci_resume(hcd, false);\n\treturn 0;\n}\n#endif\n\nstatic const struct of_device_id spear_ohci_id_table[] = {\n\t{ .compatible = \"st,spear600-ohci\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, spear_ohci_id_table);\n\n \nstatic struct platform_driver spear_ohci_hcd_driver = {\n\t.probe =\tspear_ohci_hcd_drv_probe,\n\t.remove_new =\tspear_ohci_hcd_drv_remove,\n#ifdef CONFIG_PM\n\t.suspend =\tspear_ohci_hcd_drv_suspend,\n\t.resume =\tspear_ohci_hcd_drv_resume,\n#endif\n\t.driver = {\n\t\t.name = \"spear-ohci\",\n\t\t.of_match_table = spear_ohci_id_table,\n\t},\n};\n\nstatic const struct ohci_driver_overrides spear_overrides __initconst = {\n\t.extra_priv_size = sizeof(struct spear_ohci),\n};\nstatic int __init ohci_spear_init(void)\n{\n\tif (usb_disabled())\n\t\treturn -ENODEV;\n\n\tohci_init_driver(&ohci_spear_hc_driver, &spear_overrides);\n\treturn platform_driver_register(&spear_ohci_hcd_driver);\n}\nmodule_init(ohci_spear_init);\n\nstatic void __exit ohci_spear_cleanup(void)\n{\n\tplatform_driver_unregister(&spear_ohci_hcd_driver);\n}\nmodule_exit(ohci_spear_cleanup);\n\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_AUTHOR(\"Deepak Sikri\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:spear-ohci\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}