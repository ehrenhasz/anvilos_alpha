{
  "module_name": "ohci-mem.c",
  "hash_id": "a3530cf5419069a8e7d3868bdef48988726a761cec8ed06435184293e4581845",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/ohci-mem.c",
  "human_readable_source": "\n \n\n \n\n \n\n \n\nstatic void ohci_hcd_init (struct ohci_hcd *ohci)\n{\n\tohci->next_statechange = jiffies;\n\tspin_lock_init (&ohci->lock);\n\tINIT_LIST_HEAD (&ohci->pending);\n\tINIT_LIST_HEAD(&ohci->eds_in_use);\n}\n\n \n\nstatic int ohci_mem_init (struct ohci_hcd *ohci)\n{\n\t \n\tif (ohci_to_hcd(ohci)->localmem_pool)\n\t\treturn 0;\n\n\tohci->td_cache = dma_pool_create (\"ohci_td\",\n\t\tohci_to_hcd(ohci)->self.controller,\n\t\tsizeof (struct td),\n\t\t32  ,\n\t\t0  );\n\tif (!ohci->td_cache)\n\t\treturn -ENOMEM;\n\tohci->ed_cache = dma_pool_create (\"ohci_ed\",\n\t\tohci_to_hcd(ohci)->self.controller,\n\t\tsizeof (struct ed),\n\t\t16  ,\n\t\t0  );\n\tif (!ohci->ed_cache) {\n\t\tdma_pool_destroy (ohci->td_cache);\n\t\treturn -ENOMEM;\n\t}\n\treturn 0;\n}\n\nstatic void ohci_mem_cleanup (struct ohci_hcd *ohci)\n{\n\tdma_pool_destroy(ohci->td_cache);\n\tohci->td_cache = NULL;\n\tdma_pool_destroy(ohci->ed_cache);\n\tohci->ed_cache = NULL;\n}\n\n \n\n \nstatic inline struct td *\ndma_to_td (struct ohci_hcd *hc, dma_addr_t td_dma)\n{\n\tstruct td *td;\n\n\ttd_dma &= TD_MASK;\n\ttd = hc->td_hash [TD_HASH_FUNC(td_dma)];\n\twhile (td && td->td_dma != td_dma)\n\t\ttd = td->td_hash;\n\treturn td;\n}\n\n \nstatic struct td *\ntd_alloc (struct ohci_hcd *hc, gfp_t mem_flags)\n{\n\tdma_addr_t\tdma;\n\tstruct td\t*td;\n\tstruct usb_hcd\t*hcd = ohci_to_hcd(hc);\n\n\tif (hcd->localmem_pool)\n\t\ttd = gen_pool_dma_zalloc_align(hcd->localmem_pool,\n\t\t\t\tsizeof(*td), &dma, 32);\n\telse\n\t\ttd = dma_pool_zalloc(hc->td_cache, mem_flags, &dma);\n\tif (td) {\n\t\t \n\t\ttd->hwNextTD = cpu_to_hc32 (hc, dma);\n\t\ttd->td_dma = dma;\n\t\t \n\t}\n\treturn td;\n}\n\nstatic void\ntd_free (struct ohci_hcd *hc, struct td *td)\n{\n\tstruct td\t**prev = &hc->td_hash [TD_HASH_FUNC (td->td_dma)];\n\tstruct usb_hcd\t*hcd = ohci_to_hcd(hc);\n\n\twhile (*prev && *prev != td)\n\t\tprev = &(*prev)->td_hash;\n\tif (*prev)\n\t\t*prev = td->td_hash;\n\telse if ((td->hwINFO & cpu_to_hc32(hc, TD_DONE)) != 0)\n\t\tohci_dbg (hc, \"no hash for td %p\\n\", td);\n\n\tif (hcd->localmem_pool)\n\t\tgen_pool_free(hcd->localmem_pool, (unsigned long)td,\n\t\t\t      sizeof(*td));\n\telse\n\t\tdma_pool_free(hc->td_cache, td, td->td_dma);\n}\n\n \n\n \nstatic struct ed *\ned_alloc (struct ohci_hcd *hc, gfp_t mem_flags)\n{\n\tdma_addr_t\tdma;\n\tstruct ed\t*ed;\n\tstruct usb_hcd\t*hcd = ohci_to_hcd(hc);\n\n\tif (hcd->localmem_pool)\n\t\ted = gen_pool_dma_zalloc_align(hcd->localmem_pool,\n\t\t\t\tsizeof(*ed), &dma, 16);\n\telse\n\t\ted = dma_pool_zalloc(hc->ed_cache, mem_flags, &dma);\n\tif (ed) {\n\t\tINIT_LIST_HEAD (&ed->td_list);\n\t\ted->dma = dma;\n\t}\n\treturn ed;\n}\n\nstatic void\ned_free (struct ohci_hcd *hc, struct ed *ed)\n{\n\tstruct usb_hcd\t*hcd = ohci_to_hcd(hc);\n\n\tif (hcd->localmem_pool)\n\t\tgen_pool_free(hcd->localmem_pool, (unsigned long)ed,\n\t\t\t      sizeof(*ed));\n\telse\n\t\tdma_pool_free(hc->ed_cache, ed, ed->dma);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}