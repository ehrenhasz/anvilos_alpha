{
  "module_name": "fhci-hub.c",
  "hash_id": "5c9dc8432db3c0326fa73f3293ea5d5ef98dc24c32e7bf12cde31724e239ef34",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/fhci-hub.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/spinlock.h>\n#include <linux/delay.h>\n#include <linux/errno.h>\n#include <linux/io.h>\n#include <linux/usb.h>\n#include <linux/usb/hcd.h>\n#include <linux/gpio/consumer.h>\n#include <soc/fsl/qe/qe.h>\n#include \"fhci.h\"\n\n \nstatic u8 root_hub_des[] = {\n\t0x09,  \n\tUSB_DT_HUB,  \n\t0x01,  \n\tHUB_CHAR_INDV_PORT_LPSM | HUB_CHAR_NO_OCPM,  \n\t0x00,  \n\t0x01,  \n\t0x00,  \n\t0x00,  \n\t0xff,  \n};\n\nstatic void fhci_gpio_set_value(struct fhci_hcd *fhci, int gpio_nr, bool on)\n{\n\tstruct gpio_desc *gpiod = fhci->gpiods[gpio_nr];\n\n\tif (!gpiod)\n\t\treturn;\n\n\tgpiod_set_value(gpiod, on);\n\tmdelay(5);\n}\n\nvoid fhci_config_transceiver(struct fhci_hcd *fhci,\n\t\t\t     enum fhci_port_status status)\n{\n\tfhci_dbg(fhci, \"-> %s: %d\\n\", __func__, status);\n\n\tswitch (status) {\n\tcase FHCI_PORT_POWER_OFF:\n\t\tfhci_gpio_set_value(fhci, GPIO_POWER, false);\n\t\tbreak;\n\tcase FHCI_PORT_DISABLED:\n\tcase FHCI_PORT_WAITING:\n\t\tfhci_gpio_set_value(fhci, GPIO_POWER, true);\n\t\tbreak;\n\tcase FHCI_PORT_LOW:\n\t\tfhci_gpio_set_value(fhci, GPIO_SPEED, false);\n\t\tbreak;\n\tcase FHCI_PORT_FULL:\n\t\tfhci_gpio_set_value(fhci, GPIO_SPEED, true);\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON(1);\n\t\tbreak;\n\t}\n\n\tfhci_dbg(fhci, \"<- %s: %d\\n\", __func__, status);\n}\n\n \nvoid fhci_port_disable(struct fhci_hcd *fhci)\n{\n\tstruct fhci_usb *usb = (struct fhci_usb *)fhci->usb_lld;\n\tenum fhci_port_status port_status;\n\n\tfhci_dbg(fhci, \"-> %s\\n\", __func__);\n\n\tfhci_stop_sof_timer(fhci);\n\n\tfhci_flush_all_transmissions(usb);\n\n\tfhci_usb_disable_interrupt((struct fhci_usb *)fhci->usb_lld);\n\tport_status = usb->port_status;\n\tusb->port_status = FHCI_PORT_DISABLED;\n\n\t \n\tusb->saved_msk |= USB_E_IDLE_MASK;\n\tout_be16(&usb->fhci->regs->usb_usbmr, usb->saved_msk);\n\n\t \n\tif (port_status == FHCI_PORT_WAITING)\n\t\tfhci_device_connected_interrupt(fhci);\n\tusb->vroot_hub->port.wPortStatus &= ~USB_PORT_STAT_ENABLE;\n\tusb->vroot_hub->port.wPortChange |= USB_PORT_STAT_C_ENABLE;\n\tfhci_usb_enable_interrupt((struct fhci_usb *)fhci->usb_lld);\n\n\tfhci_dbg(fhci, \"<- %s\\n\", __func__);\n}\n\n \nvoid fhci_port_enable(void *lld)\n{\n\tstruct fhci_usb *usb = (struct fhci_usb *)lld;\n\tstruct fhci_hcd *fhci = usb->fhci;\n\n\tfhci_dbg(fhci, \"-> %s\\n\", __func__);\n\n\tfhci_config_transceiver(fhci, usb->port_status);\n\n\tif ((usb->port_status != FHCI_PORT_FULL) &&\n\t\t\t(usb->port_status != FHCI_PORT_LOW))\n\t\tfhci_start_sof_timer(fhci);\n\n\tusb->vroot_hub->port.wPortStatus |= USB_PORT_STAT_ENABLE;\n\tusb->vroot_hub->port.wPortChange |= USB_PORT_STAT_C_ENABLE;\n\n\tfhci_dbg(fhci, \"<- %s\\n\", __func__);\n}\n\nvoid fhci_io_port_generate_reset(struct fhci_hcd *fhci)\n{\n\tfhci_dbg(fhci, \"-> %s\\n\", __func__);\n\n\tgpiod_direction_output(fhci->gpiods[GPIO_USBOE], 0);\n\tgpiod_direction_output(fhci->gpiods[GPIO_USBTP], 0);\n\tgpiod_direction_output(fhci->gpiods[GPIO_USBTN], 0);\n\n\tmdelay(5);\n\n\tqe_pin_set_dedicated(fhci->pins[PIN_USBOE]);\n\tqe_pin_set_dedicated(fhci->pins[PIN_USBTP]);\n\tqe_pin_set_dedicated(fhci->pins[PIN_USBTN]);\n\n\tfhci_dbg(fhci, \"<- %s\\n\", __func__);\n}\n\n \nvoid fhci_port_reset(void *lld)\n{\n\tstruct fhci_usb *usb = (struct fhci_usb *)lld;\n\tstruct fhci_hcd *fhci = usb->fhci;\n\tu8 mode;\n\tu16 mask;\n\n\tfhci_dbg(fhci, \"-> %s\\n\", __func__);\n\n\tfhci_stop_sof_timer(fhci);\n\t \n\tmode = in_8(&fhci->regs->usb_usmod);\n\tout_8(&fhci->regs->usb_usmod, mode & (~USB_MODE_EN));\n\n\t \n\tmask = in_be16(&fhci->regs->usb_usbmr);\n\tout_be16(&fhci->regs->usb_usbmr, mask & (~USB_E_IDLE_MASK));\n\n\tfhci_io_port_generate_reset(fhci);\n\n\t \n\tout_be16(&fhci->regs->usb_usbmr, mask);\n\n\t \n\tmode = in_8(&fhci->regs->usb_usmod);\n\tout_8(&fhci->regs->usb_usmod, mode | USB_MODE_EN);\n\tfhci_start_sof_timer(fhci);\n\n\tfhci_dbg(fhci, \"<- %s\\n\", __func__);\n}\n\nint fhci_hub_status_data(struct usb_hcd *hcd, char *buf)\n{\n\tstruct fhci_hcd *fhci = hcd_to_fhci(hcd);\n\tint ret = 0;\n\tunsigned long flags;\n\n\tfhci_dbg(fhci, \"-> %s\\n\", __func__);\n\n\tspin_lock_irqsave(&fhci->lock, flags);\n\n\tif (fhci->vroot_hub->port.wPortChange & (USB_PORT_STAT_C_CONNECTION |\n\t\t\tUSB_PORT_STAT_C_ENABLE | USB_PORT_STAT_C_SUSPEND |\n\t\t\tUSB_PORT_STAT_C_RESET | USB_PORT_STAT_C_OVERCURRENT)) {\n\t\t*buf = 1 << 1;\n\t\tret = 1;\n\t\tfhci_dbg(fhci, \"-- %s\\n\", __func__);\n\t}\n\n\tspin_unlock_irqrestore(&fhci->lock, flags);\n\n\tfhci_dbg(fhci, \"<- %s\\n\", __func__);\n\n\treturn ret;\n}\n\nint fhci_hub_control(struct usb_hcd *hcd, u16 typeReq, u16 wValue,\n\t\t\t    u16 wIndex, char *buf, u16 wLength)\n{\n\tstruct fhci_hcd *fhci = hcd_to_fhci(hcd);\n\tint retval = 0;\n\tstruct usb_hub_status *hub_status;\n\tstruct usb_port_status *port_status;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&fhci->lock, flags);\n\n\tfhci_dbg(fhci, \"-> %s\\n\", __func__);\n\n\tswitch (typeReq) {\n\tcase ClearHubFeature:\n\t\tswitch (wValue) {\n\t\tcase C_HUB_LOCAL_POWER:\n\t\tcase C_HUB_OVER_CURRENT:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tgoto error;\n\t\t}\n\t\tbreak;\n\tcase ClearPortFeature:\n\t\tfhci->vroot_hub->feature &= (1 << wValue);\n\n\t\tswitch (wValue) {\n\t\tcase USB_PORT_FEAT_ENABLE:\n\t\t\tfhci->vroot_hub->port.wPortStatus &=\n\t\t\t    ~USB_PORT_STAT_ENABLE;\n\t\t\tfhci_port_disable(fhci);\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_C_ENABLE:\n\t\t\tfhci->vroot_hub->port.wPortChange &=\n\t\t\t    ~USB_PORT_STAT_C_ENABLE;\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_SUSPEND:\n\t\t\tfhci->vroot_hub->port.wPortStatus &=\n\t\t\t    ~USB_PORT_STAT_SUSPEND;\n\t\t\tfhci_stop_sof_timer(fhci);\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_C_SUSPEND:\n\t\t\tfhci->vroot_hub->port.wPortChange &=\n\t\t\t    ~USB_PORT_STAT_C_SUSPEND;\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_POWER:\n\t\t\tfhci->vroot_hub->port.wPortStatus &=\n\t\t\t    ~USB_PORT_STAT_POWER;\n\t\t\tfhci_config_transceiver(fhci, FHCI_PORT_POWER_OFF);\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_C_CONNECTION:\n\t\t\tfhci->vroot_hub->port.wPortChange &=\n\t\t\t    ~USB_PORT_STAT_C_CONNECTION;\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_C_OVER_CURRENT:\n\t\t\tfhci->vroot_hub->port.wPortChange &=\n\t\t\t    ~USB_PORT_STAT_C_OVERCURRENT;\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_C_RESET:\n\t\t\tfhci->vroot_hub->port.wPortChange &=\n\t\t\t    ~USB_PORT_STAT_C_RESET;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tgoto error;\n\t\t}\n\t\tbreak;\n\tcase GetHubDescriptor:\n\t\tmemcpy(buf, root_hub_des, sizeof(root_hub_des));\n\t\tbreak;\n\tcase GetHubStatus:\n\t\thub_status = (struct usb_hub_status *)buf;\n\t\thub_status->wHubStatus =\n\t\t    cpu_to_le16(fhci->vroot_hub->hub.wHubStatus);\n\t\thub_status->wHubChange =\n\t\t    cpu_to_le16(fhci->vroot_hub->hub.wHubChange);\n\t\tbreak;\n\tcase GetPortStatus:\n\t\tport_status = (struct usb_port_status *)buf;\n\t\tport_status->wPortStatus =\n\t\t    cpu_to_le16(fhci->vroot_hub->port.wPortStatus);\n\t\tport_status->wPortChange =\n\t\t    cpu_to_le16(fhci->vroot_hub->port.wPortChange);\n\t\tbreak;\n\tcase SetHubFeature:\n\t\tswitch (wValue) {\n\t\tcase C_HUB_OVER_CURRENT:\n\t\tcase C_HUB_LOCAL_POWER:\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tgoto error;\n\t\t}\n\t\tbreak;\n\tcase SetPortFeature:\n\t\tfhci->vroot_hub->feature |= (1 << wValue);\n\n\t\tswitch (wValue) {\n\t\tcase USB_PORT_FEAT_ENABLE:\n\t\t\tfhci->vroot_hub->port.wPortStatus |=\n\t\t\t    USB_PORT_STAT_ENABLE;\n\t\t\tfhci_port_enable(fhci->usb_lld);\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_SUSPEND:\n\t\t\tfhci->vroot_hub->port.wPortStatus |=\n\t\t\t    USB_PORT_STAT_SUSPEND;\n\t\t\tfhci_stop_sof_timer(fhci);\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_RESET:\n\t\t\tfhci->vroot_hub->port.wPortStatus |=\n\t\t\t    USB_PORT_STAT_RESET;\n\t\t\tfhci_port_reset(fhci->usb_lld);\n\t\t\tfhci->vroot_hub->port.wPortStatus |=\n\t\t\t    USB_PORT_STAT_ENABLE;\n\t\t\tfhci->vroot_hub->port.wPortStatus &=\n\t\t\t    ~USB_PORT_STAT_RESET;\n\t\t\tbreak;\n\t\tcase USB_PORT_FEAT_POWER:\n\t\t\tfhci->vroot_hub->port.wPortStatus |=\n\t\t\t    USB_PORT_STAT_POWER;\n\t\t\tfhci_config_transceiver(fhci, FHCI_PORT_WAITING);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tgoto error;\n\t\t}\n\t\tbreak;\n\tdefault:\nerror:\n\t\tretval = -EPIPE;\n\t}\n\n\tfhci_dbg(fhci, \"<- %s\\n\", __func__);\n\n\tspin_unlock_irqrestore(&fhci->lock, flags);\n\n\treturn retval;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}