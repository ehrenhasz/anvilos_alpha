{
  "module_name": "uhci-platform.c",
  "hash_id": "07f563e9e8bf719e1ba82812a0c02d7b3570088da3331e897cee6325ccd56223",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/uhci-platform.c",
  "human_readable_source": "\n \n\n#include <linux/of.h>\n#include <linux/device.h>\n#include <linux/platform_device.h>\n\nstatic int uhci_platform_init(struct usb_hcd *hcd)\n{\n\tstruct uhci_hcd *uhci = hcd_to_uhci(hcd);\n\n\t \n\tif (!uhci->rh_numports)\n\t\tuhci->rh_numports = uhci_count_ports(hcd);\n\n\t \n\tuhci->reset_hc = uhci_generic_reset_hc;\n\tuhci->check_and_reset_hc = uhci_generic_check_and_reset_hc;\n\n\t \n\tuhci->configure_hc = NULL;\n\tuhci->resume_detect_interrupts_are_broken = NULL;\n\tuhci->global_suspend_mode_is_broken = NULL;\n\n\t \n\tcheck_and_reset_hc(uhci);\n\treturn 0;\n}\n\nstatic const struct hc_driver uhci_platform_hc_driver = {\n\t.description =\t\thcd_name,\n\t.product_desc =\t\t\"Generic UHCI Host Controller\",\n\t.hcd_priv_size =\tsizeof(struct uhci_hcd),\n\n\t \n\t.irq =\t\t\tuhci_irq,\n\t.flags =\t\tHCD_MEMORY | HCD_DMA | HCD_USB11,\n\n\t \n\t.reset =\t\tuhci_platform_init,\n\t.start =\t\tuhci_start,\n#ifdef CONFIG_PM\n\t.pci_suspend =\t\tNULL,\n\t.pci_resume =\t\tNULL,\n\t.bus_suspend =\t\tuhci_rh_suspend,\n\t.bus_resume =\t\tuhci_rh_resume,\n#endif\n\t.stop =\t\t\tuhci_stop,\n\n\t.urb_enqueue =\t\tuhci_urb_enqueue,\n\t.urb_dequeue =\t\tuhci_urb_dequeue,\n\n\t.endpoint_disable =\tuhci_hcd_endpoint_disable,\n\t.get_frame_number =\tuhci_hcd_get_frame_number,\n\n\t.hub_status_data =\tuhci_hub_status_data,\n\t.hub_control =\t\tuhci_hub_control,\n};\n\nstatic int uhci_hcd_platform_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct usb_hcd *hcd;\n\tstruct uhci_hcd\t*uhci;\n\tstruct resource *res;\n\tint ret;\n\n\tif (usb_disabled())\n\t\treturn -ENODEV;\n\n\t \n\tret = dma_coerce_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(32));\n\tif (ret)\n\t\treturn ret;\n\n\thcd = usb_create_hcd(&uhci_platform_hc_driver, &pdev->dev,\n\t\t\tpdev->name);\n\tif (!hcd)\n\t\treturn -ENOMEM;\n\n\tuhci = hcd_to_uhci(hcd);\n\n\thcd->regs = devm_platform_get_and_ioremap_resource(pdev, 0, &res);\n\tif (IS_ERR(hcd->regs)) {\n\t\tret = PTR_ERR(hcd->regs);\n\t\tgoto err_rmr;\n\t}\n\thcd->rsrc_start = res->start;\n\thcd->rsrc_len = resource_size(res);\n\n\tuhci->regs = hcd->regs;\n\n\t \n\tif (np) {\n\t\tu32 num_ports;\n\n\t\tif (of_property_read_u32(np, \"#ports\", &num_ports) == 0) {\n\t\t\tuhci->rh_numports = num_ports;\n\t\t\tdev_info(&pdev->dev,\n\t\t\t\t\"Detected %d ports from device-tree\\n\",\n\t\t\t\tnum_ports);\n\t\t}\n\t\tif (of_device_is_compatible(np, \"aspeed,ast2400-uhci\") ||\n\t\t    of_device_is_compatible(np, \"aspeed,ast2500-uhci\") ||\n\t\t    of_device_is_compatible(np, \"aspeed,ast2600-uhci\")) {\n\t\t\tuhci->is_aspeed = 1;\n\t\t\tdev_info(&pdev->dev,\n\t\t\t\t \"Enabled Aspeed implementation workarounds\\n\");\n\t\t}\n\t}\n\n\t \n\tuhci->clk = devm_clk_get(&pdev->dev, NULL);\n\tif (IS_ERR(uhci->clk)) {\n\t\tret = PTR_ERR(uhci->clk);\n\t\tgoto err_rmr;\n\t}\n\tret = clk_prepare_enable(uhci->clk);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Error couldn't enable clock (%d)\\n\", ret);\n\t\tgoto err_rmr;\n\t}\n\n\tret = platform_get_irq(pdev, 0);\n\tif (ret < 0)\n\t\tgoto err_clk;\n\n\tret = usb_add_hcd(hcd, ret, IRQF_SHARED);\n\tif (ret)\n\t\tgoto err_clk;\n\n\tdevice_wakeup_enable(hcd->self.controller);\n\treturn 0;\n\nerr_clk:\n\tclk_disable_unprepare(uhci->clk);\nerr_rmr:\n\tusb_put_hcd(hcd);\n\n\treturn ret;\n}\n\nstatic void uhci_hcd_platform_remove(struct platform_device *pdev)\n{\n\tstruct usb_hcd *hcd = platform_get_drvdata(pdev);\n\tstruct uhci_hcd *uhci = hcd_to_uhci(hcd);\n\n\tclk_disable_unprepare(uhci->clk);\n\tusb_remove_hcd(hcd);\n\tusb_put_hcd(hcd);\n}\n\n \nstatic void uhci_hcd_platform_shutdown(struct platform_device *op)\n{\n\tstruct usb_hcd *hcd = platform_get_drvdata(op);\n\n\tuhci_hc_died(hcd_to_uhci(hcd));\n}\n\nstatic const struct of_device_id platform_uhci_ids[] = {\n\t{ .compatible = \"generic-uhci\", },\n\t{ .compatible = \"platform-uhci\", },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, platform_uhci_ids);\n\nstatic struct platform_driver uhci_platform_driver = {\n\t.probe\t\t= uhci_hcd_platform_probe,\n\t.remove_new\t= uhci_hcd_platform_remove,\n\t.shutdown\t= uhci_hcd_platform_shutdown,\n\t.driver = {\n\t\t.name = \"platform-uhci\",\n\t\t.of_match_table = platform_uhci_ids,\n\t},\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}