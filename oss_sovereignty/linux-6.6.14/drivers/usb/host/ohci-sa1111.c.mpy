{
  "module_name": "ohci-sa1111.c",
  "hash_id": "85910fafe5a58105e59180657201d69592283add4b504261a4d1f169f52634c0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/ohci-sa1111.c",
  "human_readable_source": "\n \n\n#include <asm/mach-types.h>\n#include <asm/hardware/sa1111.h>\n\n#ifndef CONFIG_SA1111\n#error \"This file is SA-1111 bus glue.  CONFIG_SA1111 must be defined.\"\n#endif\n\n#define USB_STATUS\t0x0118\n#define USB_RESET\t0x011c\n#define USB_IRQTEST\t0x0120\n\n#define USB_RESET_FORCEIFRESET\t(1 << 0)\n#define USB_RESET_FORCEHCRESET\t(1 << 1)\n#define USB_RESET_CLKGENRESET\t(1 << 2)\n#define USB_RESET_SIMSCALEDOWN\t(1 << 3)\n#define USB_RESET_USBINTTEST\t(1 << 4)\n#define USB_RESET_SLEEPSTBYEN\t(1 << 5)\n#define USB_RESET_PWRSENSELOW\t(1 << 6)\n#define USB_RESET_PWRCTRLLOW\t(1 << 7)\n\n#define USB_STATUS_IRQHCIRMTWKUP  (1 <<  7)\n#define USB_STATUS_IRQHCIBUFFACC  (1 <<  8)\n#define USB_STATUS_NIRQHCIM       (1 <<  9)\n#define USB_STATUS_NHCIMFCLR      (1 << 10)\n#define USB_STATUS_USBPWRSENSE    (1 << 11)\n\n#if 0\nstatic void dump_hci_status(struct usb_hcd *hcd, const char *label)\n{\n\tunsigned long status = readl_relaxed(hcd->regs + USB_STATUS);\n\n\tprintk(KERN_DEBUG \"%s USB_STATUS = { %s%s%s%s%s}\\n\", label,\n\t     ((status & USB_STATUS_IRQHCIRMTWKUP) ? \"IRQHCIRMTWKUP \" : \"\"),\n\t     ((status & USB_STATUS_IRQHCIBUFFACC) ? \"IRQHCIBUFFACC \" : \"\"),\n\t     ((status & USB_STATUS_NIRQHCIM) ? \"\" : \"IRQHCIM \"),\n\t     ((status & USB_STATUS_NHCIMFCLR) ? \"\" : \"HCIMFCLR \"),\n\t     ((status & USB_STATUS_USBPWRSENSE) ? \"USBPWRSENSE \" : \"\"));\n}\n#endif\n\nstatic int ohci_sa1111_reset(struct usb_hcd *hcd)\n{\n\tstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\n\n\tohci_hcd_init(ohci);\n\treturn ohci_init(ohci);\n}\n\nstatic int ohci_sa1111_start(struct usb_hcd *hcd)\n{\n\tstruct ohci_hcd\t*ohci = hcd_to_ohci(hcd);\n\tint ret;\n\n\tret = ohci_run(ohci);\n\tif (ret < 0) {\n\t\tohci_err(ohci, \"can't start\\n\");\n\t\tohci_stop(hcd);\n\t}\n\treturn ret;\n}\n\nstatic const struct hc_driver ohci_sa1111_hc_driver = {\n\t.description =\t\thcd_name,\n\t.product_desc =\t\t\"SA-1111 OHCI\",\n\t.hcd_priv_size =\tsizeof(struct ohci_hcd),\n\n\t \n\t.irq =\t\t\tohci_irq,\n\t.flags =\t\tHCD_USB11 | HCD_DMA | HCD_MEMORY,\n\n\t \n\t.reset =\t\tohci_sa1111_reset,\n\t.start =\t\tohci_sa1111_start,\n\t.stop =\t\t\tohci_stop,\n\t.shutdown =\t\tohci_shutdown,\n\n\t \n\t.urb_enqueue =\t\tohci_urb_enqueue,\n\t.urb_dequeue =\t\tohci_urb_dequeue,\n\t.endpoint_disable =\tohci_endpoint_disable,\n\n\t \n\t.get_frame_number =\tohci_get_frame,\n\n\t \n\t.hub_status_data =\tohci_hub_status_data,\n\t.hub_control =\t\tohci_hub_control,\n#ifdef\tCONFIG_PM\n\t.bus_suspend =\t\tohci_bus_suspend,\n\t.bus_resume =\t\tohci_bus_resume,\n#endif\n\t.start_port_reset =\tohci_start_port_reset,\n};\n\nstatic int sa1111_start_hc(struct sa1111_dev *dev)\n{\n\tunsigned int usb_rst = 0;\n\tint ret;\n\n\tdev_dbg(&dev->dev, \"starting SA-1111 OHCI USB Controller\\n\");\n\n\tif (machine_is_assabet())\n\t\tusb_rst = USB_RESET_PWRSENSELOW | USB_RESET_PWRCTRLLOW;\n\n\t \n\twritel_relaxed(usb_rst | USB_RESET_FORCEIFRESET | USB_RESET_FORCEHCRESET,\n\t\t      dev->mapbase + USB_RESET);\n\n\t \n\tret = sa1111_enable_device(dev);\n\tif (ret == 0) {\n\t\tudelay(11);\n\t\twritel_relaxed(usb_rst, dev->mapbase + USB_RESET);\n\t}\n\n\treturn ret;\n}\n\nstatic void sa1111_stop_hc(struct sa1111_dev *dev)\n{\n\tunsigned int usb_rst;\n\n\tdev_dbg(&dev->dev, \"stopping SA-1111 OHCI USB Controller\\n\");\n\n\t \n\tusb_rst = readl_relaxed(dev->mapbase + USB_RESET);\n\twritel_relaxed(usb_rst | USB_RESET_FORCEIFRESET | USB_RESET_FORCEHCRESET,\n\t\t      dev->mapbase + USB_RESET);\n\n\t \n\tsa1111_disable_device(dev);\n}\n\n \nstatic int ohci_hcd_sa1111_probe(struct sa1111_dev *dev)\n{\n\tstruct usb_hcd *hcd;\n\tint ret, irq;\n\n\tif (usb_disabled())\n\t\treturn -ENODEV;\n\n\t \n\n\thcd = usb_create_hcd(&ohci_sa1111_hc_driver, &dev->dev, \"sa1111\");\n\tif (!hcd)\n\t\treturn -ENOMEM;\n\n\thcd->rsrc_start = dev->res.start;\n\thcd->rsrc_len = resource_size(&dev->res);\n\n\tirq = sa1111_get_irq(dev, 1);\n\tif (irq <= 0) {\n\t\tret = irq ? : -ENXIO;\n\t\tgoto err1;\n\t}\n\n\t \n\tret = usb_hcd_setup_local_mem(hcd, 0, 0, SZ_64K);\n\tif (ret)\n\t\tgoto err1;\n\n\tif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\n\t\tdev_dbg(&dev->dev, \"request_mem_region failed\\n\");\n\t\tret = -EBUSY;\n\t\tgoto err1;\n\t}\n\n\thcd->regs = dev->mapbase;\n\n\tret = sa1111_start_hc(dev);\n\tif (ret)\n\t\tgoto err2;\n\n\tret = usb_add_hcd(hcd, irq, 0);\n\tif (ret == 0) {\n\t\tdevice_wakeup_enable(hcd->self.controller);\n\t\treturn ret;\n\t}\n\n\tsa1111_stop_hc(dev);\n err2:\n\trelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\n err1:\n\tusb_put_hcd(hcd);\n\treturn ret;\n}\n\n \nstatic void ohci_hcd_sa1111_remove(struct sa1111_dev *dev)\n{\n\tstruct usb_hcd *hcd = sa1111_get_drvdata(dev);\n\n\tusb_remove_hcd(hcd);\n\tsa1111_stop_hc(dev);\n\trelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\n\tusb_put_hcd(hcd);\n}\n\nstatic void ohci_hcd_sa1111_shutdown(struct device *_dev)\n{\n\tstruct sa1111_dev *dev = to_sa1111_device(_dev);\n\tstruct usb_hcd *hcd = sa1111_get_drvdata(dev);\n\n\tif (test_bit(HCD_FLAG_HW_ACCESSIBLE, &hcd->flags)) {\n\t\thcd->driver->shutdown(hcd);\n\t\tsa1111_stop_hc(dev);\n\t}\n}\n\nstatic struct sa1111_driver ohci_hcd_sa1111_driver = {\n\t.drv = {\n\t\t.name\t= \"sa1111-ohci\",\n\t\t.owner\t= THIS_MODULE,\n\t\t.shutdown = ohci_hcd_sa1111_shutdown,\n\t},\n\t.devid\t\t= SA1111_DEVID_USB,\n\t.probe\t\t= ohci_hcd_sa1111_probe,\n\t.remove\t\t= ohci_hcd_sa1111_remove,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}