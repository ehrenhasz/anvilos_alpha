{
  "module_name": "fhci.h",
  "hash_id": "824674b7b970e9ef812cbf8f9a72b4573aff337145f9b79a0868fe059be7e6b7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/fhci.h",
  "human_readable_source": " \n \n\n#ifndef __FHCI_H\n#define __FHCI_H\n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/bug.h>\n#include <linux/spinlock.h>\n#include <linux/interrupt.h>\n#include <linux/kfifo.h>\n#include <linux/io.h>\n#include <linux/usb.h>\n#include <linux/usb/hcd.h>\n#include <linux/gpio/consumer.h>\n#include <soc/fsl/qe/qe.h>\n#include <soc/fsl/qe/immap_qe.h>\n\n#define USB_CLOCK\t48000000\n\n#define FHCI_PRAM_SIZE 0x100\n\n#define MAX_EDS\t\t32\n#define MAX_TDS\t\t32\n\n\n \n#define CRC_SIZE 2\n\n \n#define PROTOCOL_OVERHEAD 7\n\n \n#define PKT_PID_DATA0\t\t0x80000000  \n#define PKT_PID_DATA1\t\t0x40000000  \n#define PKT_PID_SETUP\t\t0x20000000  \n#define PKT_SETUP_STATUS\t0x10000000  \n#define PKT_SETADDR_STATUS\t0x08000000  \n#define PKT_SET_HOST_LAST\t0x04000000  \n#define PKT_HOST_DATA\t\t0x02000000  \n#define PKT_FIRST_IN_FRAME\t0x01000000  \n#define PKT_TOKEN_FRAME\t\t0x00800000  \n#define PKT_ZLP\t\t\t0x00400000  \n#define PKT_IN_TOKEN_FRAME\t0x00200000  \n#define PKT_OUT_TOKEN_FRAME\t0x00100000  \n#define PKT_SETUP_TOKEN_FRAME\t0x00080000  \n#define PKT_STALL_FRAME\t\t0x00040000  \n#define PKT_NACK_FRAME\t\t0x00020000  \n#define PKT_NO_PID\t\t0x00010000  \n#define PKT_NO_CRC\t\t0x00008000  \n#define PKT_HOST_COMMAND\t0x00004000  \n#define PKT_DUMMY_PACKET\t0x00002000  \n#define PKT_LOW_SPEED_PACKET\t0x00001000  \n\n#define TRANS_OK\t\t(0)\n#define TRANS_INPROGRESS\t(-1)\n#define TRANS_DISCARD\t\t(-2)\n#define TRANS_FAIL\t\t(-3)\n\n#define PS_INT\t\t0\n#define PS_DISCONNECTED\t1\n#define PS_CONNECTED\t2\n#define PS_READY\t3\n#define PS_MISSING\t4\n\n \n#define USB_TD_OK\t\t0x00000000  \n#define USB_TD_INPROGRESS\t0x80000000  \n#define USB_TD_RX_ER_NONOCT\t0x40000000  \n#define USB_TD_RX_ER_BITSTUFF\t0x20000000  \n#define USB_TD_RX_ER_CRC\t0x10000000  \n#define USB_TD_RX_ER_OVERUN\t0x08000000  \n#define USB_TD_RX_ER_PID\t0x04000000  \n#define USB_TD_RX_DATA_UNDERUN\t0x02000000  \n#define USB_TD_RX_DATA_OVERUN\t0x01000000  \n#define USB_TD_TX_ER_NAK\t0x00800000  \n#define USB_TD_TX_ER_STALL\t0x00400000  \n#define USB_TD_TX_ER_TIMEOUT\t0x00200000  \n#define USB_TD_TX_ER_UNDERUN\t0x00100000  \n\n#define USB_TD_ERROR (USB_TD_RX_ER_NONOCT | USB_TD_RX_ER_BITSTUFF | \\\n\t\tUSB_TD_RX_ER_CRC | USB_TD_RX_ER_OVERUN | USB_TD_RX_ER_PID | \\\n\t\tUSB_TD_RX_DATA_UNDERUN | USB_TD_RX_DATA_OVERUN | \\\n\t\tUSB_TD_TX_ER_NAK | USB_TD_TX_ER_STALL | \\\n\t\tUSB_TD_TX_ER_TIMEOUT | USB_TD_TX_ER_UNDERUN)\n\n \n#define USB_TD_TOGGLE_DATA0\t0\n#define USB_TD_TOGGLE_DATA1\t1\n#define USB_TD_TOGGLE_CARRY\t2\n\n \n\n \n#define BUS_MODE_GBL\t0x20\t \n#define BUS_MODE_BO\t0x18\t \n#define BUS_MODE_BO_BE\t0x10\t \n#define BUS_MODE_DTB\t0x02\t \n\n \n\n \n#define USB_MODE_EN\t\t0x01\n#define USB_MODE_HOST\t\t0x02\n#define USB_MODE_TEST\t\t0x04\n#define USB_MODE_SFTE\t\t0x08\n#define USB_MODE_RESUME\t\t0x40\n#define USB_MODE_LSS\t\t0x80\n\n \n#define USB_SLVADDR_MASK\t0x7F\n\n \n#define USB_EPNUM_MASK\t\t0xF000\n#define USB_EPNUM_SHIFT\t\t12\n\n#define USB_TRANS_MODE_SHIFT\t8\n#define USB_TRANS_CTR\t\t0x0000\n#define USB_TRANS_INT\t\t0x0100\n#define USB_TRANS_BULK\t\t0x0200\n#define USB_TRANS_ISO\t\t0x0300\n\n#define USB_EP_MF\t\t0x0020\n#define USB_EP_RTE\t\t0x0010\n\n#define USB_THS_SHIFT\t\t2\n#define USB_THS_MASK\t\t0x000c\n#define USB_THS_NORMAL\t\t0x0\n#define USB_THS_IGNORE_IN\t0x0004\n#define USB_THS_NACK\t\t0x0008\n#define USB_THS_STALL\t\t0x000c\n\n#define USB_RHS_SHIFT   \t0\n#define USB_RHS_MASK\t\t0x0003\n#define USB_RHS_NORMAL  \t0x0\n#define USB_RHS_IGNORE_OUT\t0x0001\n#define USB_RHS_NACK\t\t0x0002\n#define USB_RHS_STALL\t\t0x0003\n\n#define USB_RTHS_MASK\t\t0x000f\n\n \n#define USB_CMD_STR_FIFO\t0x80\n#define USB_CMD_FLUSH_FIFO\t0x40\n#define USB_CMD_ISFT\t\t0x20\n#define USB_CMD_DSFT\t\t0x10\n#define USB_CMD_EP_MASK\t\t0x03\n\n \n#define USB_E_MSF_MASK\t\t0x0800\n#define USB_E_SFT_MASK\t\t0x0400\n#define USB_E_RESET_MASK\t0x0200\n#define USB_E_IDLE_MASK\t\t0x0100\n#define USB_E_TXE4_MASK\t\t0x0080\n#define USB_E_TXE3_MASK\t\t0x0040\n#define USB_E_TXE2_MASK\t\t0x0020\n#define USB_E_TXE1_MASK\t\t0x0010\n#define USB_E_SOF_MASK\t\t0x0008\n#define USB_E_BSY_MASK\t\t0x0004\n#define USB_E_TXB_MASK\t\t0x0002\n#define USB_E_RXB_MASK\t\t0x0001\n\n \nstruct fhci_pram {\n\t__be16 ep_ptr[4];\t \n\t__be32 rx_state;\t \n\t__be32 rx_ptr;\t\t \n\t__be16 frame_num;\t \n\t__be16 rx_cnt;\t\t \n\t__be32 rx_temp;\t\t \n\t__be32 rx_data_temp;\t \n\t__be16 rx_u_ptr;\t \n\tu8 reserved1[2];\t \n\t__be32 sof_tbl;\t\t \n\tu8 sof_u_crc_temp;\t \n\tu8 reserved2[0xdb];\n};\n\n \nstruct fhci_ep_pram {\n\t__be16 rx_base;\t\t \n\t__be16 tx_base;\t\t \n\tu8 rx_func_code;\t \n\tu8 tx_func_code;\t \n\t__be16 rx_buff_len;\t \n\t__be16 rx_bd_ptr;\t \n\t__be16 tx_bd_ptr;\t \n\t__be32 tx_state;\t \n\t__be32 tx_ptr;\t\t \n\t__be16 tx_crc;\t\t \n\t__be16 tx_cnt;\t\t \n\t__be32 tx_temp;\t\t \n\t__be16 tx_u_ptr;\t \n\t__be16 reserved;\n};\n\nstruct fhci_controller_list {\n\tstruct list_head ctrl_list;\t \n\tstruct list_head bulk_list;\t \n\tstruct list_head iso_list;\t \n\tstruct list_head intr_list;\t \n\tstruct list_head done_list;\t \n};\n\nstruct virtual_root_hub {\n\tint dev_num;\t \n\tu32 feature;\t \n\tstruct usb_hub_status hub;\n\tstruct usb_port_status port;\n};\n\nenum fhci_gpios {\n\tGPIO_USBOE = 0,\n\tGPIO_USBTP,\n\tGPIO_USBTN,\n\tGPIO_USBRP,\n\tGPIO_USBRN,\n\t \n\tGPIO_SPEED,\n\tGPIO_POWER,\n\tNUM_GPIOS,\n};\n\nenum fhci_pins {\n\tPIN_USBOE = 0,\n\tPIN_USBTP,\n\tPIN_USBTN,\n\tNUM_PINS,\n};\n\nstruct fhci_hcd {\n\tenum qe_clock fullspeed_clk;\n\tenum qe_clock lowspeed_clk;\n\tstruct qe_pin *pins[NUM_PINS];\n\tstruct gpio_desc *gpiods[NUM_GPIOS];\n\n\tstruct qe_usb_ctlr __iomem *regs;  \n\tstruct fhci_pram __iomem *pram;\t \n\tstruct gtm_timer *timer;\n\n\tspinlock_t lock;\n\tstruct fhci_usb *usb_lld;  \n\tstruct virtual_root_hub *vroot_hub;  \n\tint active_urbs;\n\tstruct fhci_controller_list *hc_list;\n\tstruct tasklet_struct *process_done_task;  \n\n\tstruct list_head empty_eds;\n\tstruct list_head empty_tds;\n\n#ifdef CONFIG_FHCI_DEBUG\n\tint usb_irq_stat[13];\n\tstruct dentry *dfs_root;\n#endif\n};\n\n#define USB_FRAME_USAGE 90\n#define FRAME_TIME_USAGE (USB_FRAME_USAGE*10)\t \n#define SW_FIX_TIME_BETWEEN_TRANSACTION 150\t \n#define MAX_BYTES_PER_FRAME (USB_FRAME_USAGE*15)\n#define MAX_PERIODIC_FRAME_USAGE 90\n\n \nenum fhci_ta_type {\n\tFHCI_TA_IN = 0,\t \n\tFHCI_TA_OUT,\t \n\tFHCI_TA_SETUP,\t \n};\n\n \nenum fhci_tf_mode {\n\tFHCI_TF_CTRL = 0,\n\tFHCI_TF_ISO,\n\tFHCI_TF_BULK,\n\tFHCI_TF_INTR,\n};\n\nenum fhci_speed {\n\tFHCI_FULL_SPEED,\n\tFHCI_LOW_SPEED,\n};\n\n \nenum fhci_ed_state {\n\tFHCI_ED_NEW = 0,  \n\tFHCI_ED_OPER,     \n\tFHCI_ED_URB_DEL,  \n\tFHCI_ED_SKIP,     \n\tFHCI_ED_HALTED,   \n};\n\nenum fhci_port_status {\n\tFHCI_PORT_POWER_OFF = 0,\n\tFHCI_PORT_DISABLED,\n\tFHCI_PORT_DISCONNECTING,\n\tFHCI_PORT_WAITING,\t \n\tFHCI_PORT_FULL,\t\t \n\tFHCI_PORT_LOW,\t\t \n};\n\nenum fhci_mem_alloc {\n\tMEM_CACHABLE_SYS = 0x00000001,\t \n\tMEM_NOCACHE_SYS = 0x00000004,\t \n\tMEM_SECONDARY = 0x00000002,\t \n\tMEM_PRAM = 0x00000008,\t\t \n};\n\n \n#define DEFAULT_RING_LEN\t8\n#define DEFAULT_DATA_MEM\tMEM_CACHABLE_SYS\n\nstruct ed {\n\tu8 dev_addr;\t\t \n\tu8 ep_addr;\t\t \n\tenum fhci_tf_mode mode;\t \n\tenum fhci_speed speed;\n\tunsigned int max_pkt_size;\n\tenum fhci_ed_state state;\n\tstruct list_head td_list;  \n\tstruct list_head node;\n\n\t \n\tu8 toggle_carry;\t \n\tu16 next_iso;\t\t \n\tstruct td *td_head;\t \n};\n\nstruct td {\n\tvoid *data;\t\t  \n\tunsigned int len;\t  \n\tunsigned int actual_len;  \n\tenum fhci_ta_type type;\t  \n\tu8 toggle;\t\t  \n\tu16 iso_index;\t\t  \n\tu16 start_frame;\t  \n\tu16 interval;\t\t  \n\tu32 status;\t\t  \n\tstruct ed *ed;\t\t  \n\tstruct urb *urb;\t  \n\tbool ioc;\t\t  \n\tstruct list_head node;\n\n\t \n\tstruct packet *pkt;\n\tint nak_cnt;\n\tint error_cnt;\n\tstruct list_head frame_lh;\n};\n\nstruct packet {\n\tu8 *data;\t \n\tu32 len;\t \n\tu32 status;\t \n\tu32 info;\t \n\tvoid __iomem *priv_data;  \n};\n\n \n#define URB_INPROGRESS\t0\n#define URB_DEL\t\t1\n\n \n#define US_BULK\t\t0\n#define US_BULK0\t1\n\n \n#define US_CTRL_SETUP\t2\n#define US_CTRL_DATA\t1\n#define US_CTRL_ACK\t0\n\n#define EP_ZERO\t0\n\nstruct urb_priv {\n\tint num_of_tds;\n\tint tds_cnt;\n\tint state;\n\n\tstruct td **tds;\n\tstruct ed *ed;\n\tstruct timer_list time_out;\n};\n\nstruct endpoint {\n\t \n\tstruct fhci_ep_pram __iomem *ep_pram_ptr;\n\n\t \n\tstruct usb_td __iomem *td_base;  \n\tstruct usb_td __iomem *conf_td;  \n\tstruct usb_td __iomem *empty_td; \n\tstruct kfifo empty_frame_Q;   \n\tstruct kfifo conf_frame_Q;    \n\tstruct kfifo dummy_packets_Q; \n\n\tbool already_pushed_dummy_bd;\n};\n\n \n#define FRAME_IS_TRANSMITTED\t\t0x00\n#define FRAME_TIMER_END_TRANSMISSION\t0x01\n#define FRAME_DATA_END_TRANSMISSION\t0x02\n#define FRAME_END_TRANSMISSION\t\t0x03\n#define FRAME_IS_PREPARED\t\t0x04\n\nstruct fhci_time_frame {\n\tu16 frame_num;\t  \n\tu16 total_bytes;  \n\tu8 frame_status;  \n\tstruct list_head tds_list;  \n};\n\n \nstruct fhci_usb {\n\tu16 saved_msk;\t\t  \n\tstruct endpoint *ep0;\t  \n\tint intr_nesting_cnt;\t  \n\tu16 max_frame_usage;\t  \n\tu16 max_bytes_per_frame;  \n\tu32 sw_transaction_time;  \n\tstruct fhci_time_frame *actual_frame;\n\tstruct fhci_controller_list *hc_list;\t \n\tstruct virtual_root_hub *vroot_hub;\n\tenum fhci_port_status port_status;\t \n\n\tu32 (*transfer_confirm)(struct fhci_hcd *fhci);\n\n\tstruct fhci_hcd *fhci;\n};\n\n \n\nstatic inline u16 get_frame_num(struct fhci_hcd *fhci)\n{\n\treturn in_be16(&fhci->pram->frame_num) & 0x07ff;\n}\n\n#define fhci_dbg(fhci, fmt, args...) \\\n\t\tdev_dbg(fhci_to_hcd(fhci)->self.controller, fmt, ##args)\n#define fhci_vdbg(fhci, fmt, args...) \\\n\t\tdev_vdbg(fhci_to_hcd(fhci)->self.controller, fmt, ##args)\n#define fhci_err(fhci, fmt, args...) \\\n\t\tdev_err(fhci_to_hcd(fhci)->self.controller, fmt, ##args)\n#define fhci_info(fhci, fmt, args...) \\\n\t\tdev_info(fhci_to_hcd(fhci)->self.controller, fmt, ##args)\n#define fhci_warn(fhci, fmt, args...) \\\n\t\tdev_warn(fhci_to_hcd(fhci)->self.controller, fmt, ##args)\n\nstatic inline struct fhci_hcd *hcd_to_fhci(struct usb_hcd *hcd)\n{\n\treturn (struct fhci_hcd *)hcd->hcd_priv;\n}\n\nstatic inline struct usb_hcd *fhci_to_hcd(struct fhci_hcd *fhci)\n{\n\treturn container_of((void *)fhci, struct usb_hcd, hcd_priv);\n}\n\n \nstatic inline int cq_new(struct kfifo *fifo, int size)\n{\n\treturn kfifo_alloc(fifo, size * sizeof(void *), GFP_KERNEL);\n}\n\nstatic inline void cq_delete(struct kfifo *kfifo)\n{\n\tkfifo_free(kfifo);\n}\n\nstatic inline unsigned int cq_howmany(struct kfifo *kfifo)\n{\n\treturn kfifo_len(kfifo) / sizeof(void *);\n}\n\nstatic inline int cq_put(struct kfifo *kfifo, void *p)\n{\n\treturn kfifo_in(kfifo, (void *)&p, sizeof(p));\n}\n\nstatic inline void *cq_get(struct kfifo *kfifo)\n{\n\tunsigned int sz;\n\tvoid *p;\n\n\tsz = kfifo_out(kfifo, (void *)&p, sizeof(p));\n\tif (sz != sizeof(p))\n\t\treturn NULL;\n\n\treturn p;\n}\n\n \nvoid fhci_start_sof_timer(struct fhci_hcd *fhci);\nvoid fhci_stop_sof_timer(struct fhci_hcd *fhci);\nu16 fhci_get_sof_timer_count(struct fhci_usb *usb);\nvoid fhci_usb_enable_interrupt(struct fhci_usb *usb);\nvoid fhci_usb_disable_interrupt(struct fhci_usb *usb);\nint fhci_ioports_check_bus_state(struct fhci_hcd *fhci);\n\n \nvoid fhci_recycle_empty_td(struct fhci_hcd *fhci, struct td *td);\nvoid fhci_recycle_empty_ed(struct fhci_hcd *fhci, struct ed *ed);\nstruct ed *fhci_get_empty_ed(struct fhci_hcd *fhci);\nstruct td *fhci_td_fill(struct fhci_hcd *fhci, struct urb *urb,\n\t\t\tstruct urb_priv *urb_priv, struct ed *ed, u16 index,\n\t\t\tenum fhci_ta_type type, int toggle, u8 *data, u32 len,\n\t\t\tu16 interval, u16 start_frame, bool ioc);\nvoid fhci_add_tds_to_ed(struct ed *ed, struct td **td_list, int number);\n\n \nvoid fhci_config_transceiver(struct fhci_hcd *fhci,\n\t\t\tenum fhci_port_status status);\nvoid fhci_port_disable(struct fhci_hcd *fhci);\nvoid fhci_port_enable(void *lld);\nvoid fhci_io_port_generate_reset(struct fhci_hcd *fhci);\nvoid fhci_port_reset(void *lld);\nint fhci_hub_status_data(struct usb_hcd *hcd, char *buf);\nint fhci_hub_control(struct usb_hcd *hcd, u16 typeReq, u16 wValue,\n\t\t     u16 wIndex, char *buf, u16 wLength);\n\n \nvoid fhci_flush_bds(struct fhci_usb *usb);\nvoid fhci_flush_actual_frame(struct fhci_usb *usb);\nu32 fhci_host_transaction(struct fhci_usb *usb, struct packet *pkt,\n\t\t\t  enum fhci_ta_type trans_type, u8 dest_addr,\n\t\t\t  u8 dest_ep, enum fhci_tf_mode trans_mode,\n\t\t\t  enum fhci_speed dest_speed, u8 data_toggle);\nvoid fhci_host_transmit_actual_frame(struct fhci_usb *usb);\nvoid fhci_tx_conf_interrupt(struct fhci_usb *usb);\nvoid fhci_push_dummy_bd(struct endpoint *ep);\nu32 fhci_create_ep(struct fhci_usb *usb, enum fhci_mem_alloc data_mem,\n\t\t   u32 ring_len);\nvoid fhci_init_ep_registers(struct fhci_usb *usb,\n\t\t\t    struct endpoint *ep,\n\t\t\t    enum fhci_mem_alloc data_mem);\nvoid fhci_ep0_free(struct fhci_usb *usb);\n\n \nextern struct tasklet_struct fhci_tasklet;\nvoid fhci_transaction_confirm(struct fhci_usb *usb, struct packet *pkt);\nvoid fhci_flush_all_transmissions(struct fhci_usb *usb);\nvoid fhci_schedule_transactions(struct fhci_usb *usb);\nvoid fhci_device_connected_interrupt(struct fhci_hcd *fhci);\nvoid fhci_device_disconnected_interrupt(struct fhci_hcd *fhci);\nvoid fhci_queue_urb(struct fhci_hcd *fhci, struct urb *urb);\nu32 fhci_transfer_confirm_callback(struct fhci_hcd *fhci);\nirqreturn_t fhci_irq(struct usb_hcd *hcd);\nirqreturn_t fhci_frame_limit_timer_irq(int irq, void *_hcd);\n\n \nvoid fhci_urb_complete_free(struct fhci_hcd *fhci, struct urb *urb);\nstruct td *fhci_remove_td_from_ed(struct ed *ed);\nstruct td *fhci_remove_td_from_frame(struct fhci_time_frame *frame);\nvoid fhci_move_td_from_ed_to_done_list(struct fhci_usb *usb, struct ed *ed);\nstruct td *fhci_peek_td_from_frame(struct fhci_time_frame *frame);\nvoid fhci_add_td_to_frame(struct fhci_time_frame *frame, struct td *td);\nstruct td *fhci_remove_td_from_done_list(struct fhci_controller_list *p_list);\nvoid fhci_done_td(struct urb *urb, struct td *td);\nvoid fhci_del_ed_list(struct fhci_hcd *fhci, struct ed *ed);\n\n#ifdef CONFIG_FHCI_DEBUG\n\nvoid fhci_dbg_isr(struct fhci_hcd *fhci, int usb_er);\nvoid fhci_dfs_destroy(struct fhci_hcd *fhci);\nvoid fhci_dfs_create(struct fhci_hcd *fhci);\n\n#else\n\nstatic inline void fhci_dbg_isr(struct fhci_hcd *fhci, int usb_er) {}\nstatic inline void fhci_dfs_destroy(struct fhci_hcd *fhci) {}\nstatic inline void fhci_dfs_create(struct fhci_hcd *fhci) {}\n\n#endif  \n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}