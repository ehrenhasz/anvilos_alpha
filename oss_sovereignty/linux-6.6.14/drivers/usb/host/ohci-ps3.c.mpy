{
  "module_name": "ohci-ps3.c",
  "hash_id": "60b445be68555c185b7a4e23339e27cf18cba47ecbde298bfb8263d8025f705b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/host/ohci-ps3.c",
  "human_readable_source": "\n \n\n#include <asm/firmware.h>\n#include <asm/ps3.h>\n\nstatic int ps3_ohci_hc_reset(struct usb_hcd *hcd)\n{\n\tstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\n\n\tohci->flags |= OHCI_QUIRK_BE_MMIO;\n\tohci_hcd_init(ohci);\n\treturn ohci_init(ohci);\n}\n\nstatic int ps3_ohci_hc_start(struct usb_hcd *hcd)\n{\n\tint result;\n\tstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\n\n\t \n\t \n\n\tohci_writel(ohci, 0x7f000000 | RH_A_PSM | RH_A_OCPM,\n\t\t&ohci->regs->roothub.a);\n\tohci_writel(ohci, 0x00060000, &ohci->regs->roothub.b);\n\n\tresult = ohci_run(ohci);\n\n\tif (result < 0) {\n\t\tdev_err(hcd->self.controller, \"can't start %s\\n\",\n\t\t\thcd->self.bus_name);\n\t\tohci_stop(hcd);\n\t}\n\n\treturn result;\n}\n\nstatic const struct hc_driver ps3_ohci_hc_driver = {\n\t.description\t\t= hcd_name,\n\t.product_desc\t\t= \"PS3 OHCI Host Controller\",\n\t.hcd_priv_size\t\t= sizeof(struct ohci_hcd),\n\t.irq\t\t\t= ohci_irq,\n\t.flags\t\t\t= HCD_MEMORY | HCD_DMA | HCD_USB11,\n\t.reset\t\t\t= ps3_ohci_hc_reset,\n\t.start\t\t\t= ps3_ohci_hc_start,\n\t.stop\t\t\t= ohci_stop,\n\t.shutdown\t\t= ohci_shutdown,\n\t.urb_enqueue\t\t= ohci_urb_enqueue,\n\t.urb_dequeue\t\t= ohci_urb_dequeue,\n\t.endpoint_disable\t= ohci_endpoint_disable,\n\t.get_frame_number\t= ohci_get_frame,\n\t.hub_status_data\t= ohci_hub_status_data,\n\t.hub_control\t\t= ohci_hub_control,\n\t.start_port_reset\t= ohci_start_port_reset,\n#if defined(CONFIG_PM)\n\t.bus_suspend \t\t= ohci_bus_suspend,\n\t.bus_resume \t\t= ohci_bus_resume,\n#endif\n};\n\nstatic int ps3_ohci_probe(struct ps3_system_bus_device *dev)\n{\n\tint result;\n\tstruct usb_hcd *hcd;\n\tunsigned int virq;\n\tstatic u64 dummy_mask;\n\n\tif (usb_disabled()) {\n\t\tresult = -ENODEV;\n\t\tgoto fail_start;\n\t}\n\n\tresult = ps3_open_hv_device(dev);\n\n\tif (result) {\n\t\tdev_dbg(&dev->core, \"%s:%d: ps3_open_hv_device failed: %s\\n\",\n\t\t\t__func__, __LINE__, ps3_result(result));\n\t\tresult = -EPERM;\n\t\tgoto fail_open;\n\t}\n\n\tresult = ps3_dma_region_create(dev->d_region);\n\n\tif (result) {\n\t\tdev_dbg(&dev->core, \"%s:%d: ps3_dma_region_create failed: \"\n\t\t\t\"(%d)\\n\", __func__, __LINE__, result);\n\t\tBUG_ON(\"check region type\");\n\t\tgoto fail_dma_region;\n\t}\n\n\tresult = ps3_mmio_region_create(dev->m_region);\n\n\tif (result) {\n\t\tdev_dbg(&dev->core, \"%s:%d: ps3_map_mmio_region failed\\n\",\n\t\t\t__func__, __LINE__);\n\t\tresult = -EPERM;\n\t\tgoto fail_mmio_region;\n\t}\n\n\tdev_dbg(&dev->core, \"%s:%d: mmio mapped_addr %lxh\\n\", __func__,\n\t\t__LINE__, dev->m_region->lpar_addr);\n\n\tresult = ps3_io_irq_setup(PS3_BINDING_CPU_ANY, dev->interrupt_id, &virq);\n\n\tif (result) {\n\t\tdev_dbg(&dev->core, \"%s:%d: ps3_construct_io_irq(%d) failed.\\n\",\n\t\t\t__func__, __LINE__, virq);\n\t\tresult = -EPERM;\n\t\tgoto fail_irq;\n\t}\n\n\tdummy_mask = DMA_BIT_MASK(32);\n\tdev->core.dma_mask = &dummy_mask;\n\tdma_set_coherent_mask(&dev->core, dummy_mask);\n\n\thcd = usb_create_hcd(&ps3_ohci_hc_driver, &dev->core, dev_name(&dev->core));\n\n\tif (!hcd) {\n\t\tdev_dbg(&dev->core, \"%s:%d: usb_create_hcd failed\\n\", __func__,\n\t\t\t__LINE__);\n\t\tresult = -ENOMEM;\n\t\tgoto fail_create_hcd;\n\t}\n\n\thcd->rsrc_start = dev->m_region->lpar_addr;\n\thcd->rsrc_len = dev->m_region->len;\n\n\tif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name))\n\t\tdev_dbg(&dev->core, \"%s:%d: request_mem_region failed\\n\",\n\t\t\t__func__, __LINE__);\n\n\thcd->regs = ioremap(dev->m_region->lpar_addr, dev->m_region->len);\n\n\tif (!hcd->regs) {\n\t\tdev_dbg(&dev->core, \"%s:%d: ioremap failed\\n\", __func__,\n\t\t\t__LINE__);\n\t\tresult = -EPERM;\n\t\tgoto fail_ioremap;\n\t}\n\n\tdev_dbg(&dev->core, \"%s:%d: hcd->rsrc_start %lxh\\n\", __func__, __LINE__,\n\t\t(unsigned long)hcd->rsrc_start);\n\tdev_dbg(&dev->core, \"%s:%d: hcd->rsrc_len   %lxh\\n\", __func__, __LINE__,\n\t\t(unsigned long)hcd->rsrc_len);\n\tdev_dbg(&dev->core, \"%s:%d: hcd->regs       %lxh\\n\", __func__, __LINE__,\n\t\t(unsigned long)hcd->regs);\n\tdev_dbg(&dev->core, \"%s:%d: virq            %lu\\n\", __func__, __LINE__,\n\t\t(unsigned long)virq);\n\n\tps3_system_bus_set_drvdata(dev, hcd);\n\n\tresult = usb_add_hcd(hcd, virq, 0);\n\n\tif (result) {\n\t\tdev_dbg(&dev->core, \"%s:%d: usb_add_hcd failed (%d)\\n\",\n\t\t\t__func__, __LINE__, result);\n\t\tgoto fail_add_hcd;\n\t}\n\n\tdevice_wakeup_enable(hcd->self.controller);\n\treturn result;\n\nfail_add_hcd:\n\tiounmap(hcd->regs);\nfail_ioremap:\n\trelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\n\tusb_put_hcd(hcd);\nfail_create_hcd:\n\tps3_io_irq_destroy(virq);\nfail_irq:\n\tps3_free_mmio_region(dev->m_region);\nfail_mmio_region:\n\tps3_dma_region_free(dev->d_region);\nfail_dma_region:\n\tps3_close_hv_device(dev);\nfail_open:\nfail_start:\n\treturn result;\n}\n\nstatic void ps3_ohci_remove(struct ps3_system_bus_device *dev)\n{\n\tunsigned int tmp;\n\tstruct usb_hcd *hcd = ps3_system_bus_get_drvdata(dev);\n\n\tBUG_ON(!hcd);\n\n\tdev_dbg(&dev->core, \"%s:%d: regs %p\\n\", __func__, __LINE__, hcd->regs);\n\tdev_dbg(&dev->core, \"%s:%d: irq %u\\n\", __func__, __LINE__, hcd->irq);\n\n\ttmp = hcd->irq;\n\n\tohci_shutdown(hcd);\n\tusb_remove_hcd(hcd);\n\n\tps3_system_bus_set_drvdata(dev, NULL);\n\n\tBUG_ON(!hcd->regs);\n\tiounmap(hcd->regs);\n\n\trelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\n\tusb_put_hcd(hcd);\n\n\tps3_io_irq_destroy(tmp);\n\tps3_free_mmio_region(dev->m_region);\n\n\tps3_dma_region_free(dev->d_region);\n\tps3_close_hv_device(dev);\n}\n\nstatic int __init ps3_ohci_driver_register(struct ps3_system_bus_driver *drv)\n{\n\treturn firmware_has_feature(FW_FEATURE_PS3_LV1)\n\t\t? ps3_system_bus_driver_register(drv)\n\t\t: 0;\n}\n\nstatic void ps3_ohci_driver_unregister(struct ps3_system_bus_driver *drv)\n{\n\tif (firmware_has_feature(FW_FEATURE_PS3_LV1))\n\t\tps3_system_bus_driver_unregister(drv);\n}\n\nMODULE_ALIAS(PS3_MODULE_ALIAS_OHCI);\n\nstatic struct ps3_system_bus_driver ps3_ohci_driver = {\n\t.core.name = \"ps3-ohci-driver\",\n\t.core.owner = THIS_MODULE,\n\t.match_id = PS3_MATCH_ID_OHCI,\n\t.probe = ps3_ohci_probe,\n\t.remove = ps3_ohci_remove,\n\t.shutdown = ps3_ohci_remove,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}