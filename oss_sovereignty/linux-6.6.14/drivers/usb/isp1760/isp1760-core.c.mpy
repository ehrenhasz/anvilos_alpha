{
  "module_name": "isp1760-core.c",
  "hash_id": "ef5875f9aa766150a673cebe2e845c10fe7d5993653d733159694f2934f9c7bf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/isp1760/isp1760-core.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/gpio/consumer.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n#include <linux/usb.h>\n\n#include \"isp1760-core.h\"\n#include \"isp1760-hcd.h\"\n#include \"isp1760-regs.h\"\n#include \"isp1760-udc.h\"\n\nstatic int isp1760_init_core(struct isp1760_device *isp)\n{\n\tstruct isp1760_hcd *hcd = &isp->hcd;\n\tstruct isp1760_udc *udc = &isp->udc;\n\tu32 otg_ctrl;\n\n\t \n\tif (isp->rst_gpio) {\n\t\tgpiod_set_value_cansleep(isp->rst_gpio, 1);\n\t\tmsleep(50);\n\t\tgpiod_set_value_cansleep(isp->rst_gpio, 0);\n\t}\n\n\t \n\tisp1760_field_set(hcd->fields, SW_RESET_RESET_ALL);\n\tmsleep(100);\n\n\t \n\tif ((isp->devflags & ISP1760_FLAG_ANALOG_OC) && hcd->is_isp1763) {\n\t\tdev_err(isp->dev, \"isp1763 analog overcurrent not available\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (isp->devflags & ISP1760_FLAG_BUS_WIDTH_16)\n\t\tisp1760_field_clear(hcd->fields, HW_DATA_BUS_WIDTH);\n\tif (isp->devflags & ISP1760_FLAG_BUS_WIDTH_8)\n\t\tisp1760_field_set(hcd->fields, HW_DATA_BUS_WIDTH);\n\tif (isp->devflags & ISP1760_FLAG_ANALOG_OC)\n\t\tisp1760_field_set(hcd->fields, HW_ANA_DIGI_OC);\n\tif (isp->devflags & ISP1760_FLAG_DACK_POL_HIGH)\n\t\tisp1760_field_set(hcd->fields, HW_DACK_POL_HIGH);\n\tif (isp->devflags & ISP1760_FLAG_DREQ_POL_HIGH)\n\t\tisp1760_field_set(hcd->fields, HW_DREQ_POL_HIGH);\n\tif (isp->devflags & ISP1760_FLAG_INTR_POL_HIGH)\n\t\tisp1760_field_set(hcd->fields, HW_INTR_HIGH_ACT);\n\tif (isp->devflags & ISP1760_FLAG_INTR_EDGE_TRIG)\n\t\tisp1760_field_set(hcd->fields, HW_INTR_EDGE_TRIG);\n\n\t \n\tif (isp->devflags & ISP1760_FLAG_ISP1761) {\n\t\tisp1760_reg_write(udc->regs, ISP176x_DC_MODE, 0);\n\t\tisp1760_field_set(hcd->fields, HW_COMN_IRQ);\n\t}\n\n\t \n\tif (isp->devflags & ISP1760_FLAG_ISP1761) {\n\t\tif (isp->devflags & ISP1760_FLAG_PERIPHERAL_EN) {\n\t\t\totg_ctrl = (ISP176x_HW_DM_PULLDOWN_CLEAR |\n\t\t\t\t    ISP176x_HW_DP_PULLDOWN_CLEAR |\n\t\t\t\t    ISP176x_HW_OTG_DISABLE);\n\t\t} else {\n\t\t\totg_ctrl = (ISP176x_HW_SW_SEL_HC_DC_CLEAR |\n\t\t\t\t    ISP176x_HW_VBUS_DRV |\n\t\t\t\t    ISP176x_HW_SEL_CP_EXT);\n\t\t}\n\t\tisp1760_reg_write(hcd->regs, ISP176x_HC_OTG_CTRL, otg_ctrl);\n\t}\n\n\tdev_info(isp->dev, \"%s bus width: %u, oc: %s\\n\",\n\t\t hcd->is_isp1763 ? \"isp1763\" : \"isp1760\",\n\t\t isp->devflags & ISP1760_FLAG_BUS_WIDTH_8 ? 8 :\n\t\t isp->devflags & ISP1760_FLAG_BUS_WIDTH_16 ? 16 : 32,\n\t\t hcd->is_isp1763 ? \"not available\" :\n\t\t isp->devflags & ISP1760_FLAG_ANALOG_OC ? \"analog\" : \"digital\");\n\n\treturn 0;\n}\n\nvoid isp1760_set_pullup(struct isp1760_device *isp, bool enable)\n{\n\tstruct isp1760_udc *udc = &isp->udc;\n\n\tif (enable)\n\t\tisp1760_field_set(udc->fields, HW_DP_PULLUP);\n\telse\n\t\tisp1760_field_set(udc->fields, HW_DP_PULLUP_CLEAR);\n}\n\n \nstatic const struct isp1760_memory_layout isp176x_memory_conf = {\n\t.blocks[0]\t\t= 32,\n\t.blocks_size[0]\t\t= 256,\n\t.blocks[1]\t\t= 20,\n\t.blocks_size[1]\t\t= 1024,\n\t.blocks[2]\t\t= 4,\n\t.blocks_size[2]\t\t= 8192,\n\n\t.slot_num\t\t= 32,\n\t.payload_blocks\t\t= 32 + 20 + 4,\n\t.payload_area_size\t= 0xf000,\n};\n\n \nstatic const struct isp1760_memory_layout isp1763_memory_conf = {\n\t.blocks[0]\t\t= 8,\n\t.blocks_size[0]\t\t= 256,\n\t.blocks[1]\t\t= 2,\n\t.blocks_size[1]\t\t= 1024,\n\t.blocks[2]\t\t= 4,\n\t.blocks_size[2]\t\t= 4096,\n\n\t.slot_num\t\t= 16,\n\t.payload_blocks\t\t= 8 + 2 + 4,\n\t.payload_area_size\t= 0x5000,\n};\n\nstatic const struct regmap_range isp176x_hc_volatile_ranges[] = {\n\tregmap_reg_range(ISP176x_HC_USBCMD, ISP176x_HC_ATL_PTD_LASTPTD),\n\tregmap_reg_range(ISP176x_HC_BUFFER_STATUS, ISP176x_HC_MEMORY),\n\tregmap_reg_range(ISP176x_HC_INTERRUPT, ISP176x_HC_OTG_CTRL_CLEAR),\n};\n\nstatic const struct regmap_access_table isp176x_hc_volatile_table = {\n\t.yes_ranges\t= isp176x_hc_volatile_ranges,\n\t.n_yes_ranges\t= ARRAY_SIZE(isp176x_hc_volatile_ranges),\n};\n\nstatic const struct regmap_config isp1760_hc_regmap_conf = {\n\t.name = \"isp1760-hc\",\n\t.reg_bits = 16,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.fast_io = true,\n\t.max_register = ISP176x_HC_OTG_CTRL_CLEAR,\n\t.volatile_table = &isp176x_hc_volatile_table,\n};\n\nstatic const struct reg_field isp1760_hc_reg_fields[] = {\n\t[HCS_PPC]\t\t= REG_FIELD(ISP176x_HC_HCSPARAMS, 4, 4),\n\t[HCS_N_PORTS]\t\t= REG_FIELD(ISP176x_HC_HCSPARAMS, 0, 3),\n\t[HCC_ISOC_CACHE]\t= REG_FIELD(ISP176x_HC_HCCPARAMS, 7, 7),\n\t[HCC_ISOC_THRES]\t= REG_FIELD(ISP176x_HC_HCCPARAMS, 4, 6),\n\t[CMD_LRESET]\t\t= REG_FIELD(ISP176x_HC_USBCMD, 7, 7),\n\t[CMD_RESET]\t\t= REG_FIELD(ISP176x_HC_USBCMD, 1, 1),\n\t[CMD_RUN]\t\t= REG_FIELD(ISP176x_HC_USBCMD, 0, 0),\n\t[STS_PCD]\t\t= REG_FIELD(ISP176x_HC_USBSTS, 2, 2),\n\t[HC_FRINDEX]\t\t= REG_FIELD(ISP176x_HC_FRINDEX, 0, 13),\n\t[FLAG_CF]\t\t= REG_FIELD(ISP176x_HC_CONFIGFLAG, 0, 0),\n\t[HC_ISO_PTD_DONEMAP]\t= REG_FIELD(ISP176x_HC_ISO_PTD_DONEMAP, 0, 31),\n\t[HC_ISO_PTD_SKIPMAP]\t= REG_FIELD(ISP176x_HC_ISO_PTD_SKIPMAP, 0, 31),\n\t[HC_ISO_PTD_LASTPTD]\t= REG_FIELD(ISP176x_HC_ISO_PTD_LASTPTD, 0, 31),\n\t[HC_INT_PTD_DONEMAP]\t= REG_FIELD(ISP176x_HC_INT_PTD_DONEMAP, 0, 31),\n\t[HC_INT_PTD_SKIPMAP]\t= REG_FIELD(ISP176x_HC_INT_PTD_SKIPMAP, 0, 31),\n\t[HC_INT_PTD_LASTPTD]\t= REG_FIELD(ISP176x_HC_INT_PTD_LASTPTD, 0, 31),\n\t[HC_ATL_PTD_DONEMAP]\t= REG_FIELD(ISP176x_HC_ATL_PTD_DONEMAP, 0, 31),\n\t[HC_ATL_PTD_SKIPMAP]\t= REG_FIELD(ISP176x_HC_ATL_PTD_SKIPMAP, 0, 31),\n\t[HC_ATL_PTD_LASTPTD]\t= REG_FIELD(ISP176x_HC_ATL_PTD_LASTPTD, 0, 31),\n\t[PORT_OWNER]\t\t= REG_FIELD(ISP176x_HC_PORTSC1, 13, 13),\n\t[PORT_POWER]\t\t= REG_FIELD(ISP176x_HC_PORTSC1, 12, 12),\n\t[PORT_LSTATUS]\t\t= REG_FIELD(ISP176x_HC_PORTSC1, 10, 11),\n\t[PORT_RESET]\t\t= REG_FIELD(ISP176x_HC_PORTSC1, 8, 8),\n\t[PORT_SUSPEND]\t\t= REG_FIELD(ISP176x_HC_PORTSC1, 7, 7),\n\t[PORT_RESUME]\t\t= REG_FIELD(ISP176x_HC_PORTSC1, 6, 6),\n\t[PORT_PE]\t\t= REG_FIELD(ISP176x_HC_PORTSC1, 2, 2),\n\t[PORT_CSC]\t\t= REG_FIELD(ISP176x_HC_PORTSC1, 1, 1),\n\t[PORT_CONNECT]\t\t= REG_FIELD(ISP176x_HC_PORTSC1, 0, 0),\n\t[ALL_ATX_RESET]\t\t= REG_FIELD(ISP176x_HC_HW_MODE_CTRL, 31, 31),\n\t[HW_ANA_DIGI_OC]\t= REG_FIELD(ISP176x_HC_HW_MODE_CTRL, 15, 15),\n\t[HW_COMN_IRQ]\t\t= REG_FIELD(ISP176x_HC_HW_MODE_CTRL, 10, 10),\n\t[HW_DATA_BUS_WIDTH]\t= REG_FIELD(ISP176x_HC_HW_MODE_CTRL, 8, 8),\n\t[HW_DACK_POL_HIGH]\t= REG_FIELD(ISP176x_HC_HW_MODE_CTRL, 6, 6),\n\t[HW_DREQ_POL_HIGH]\t= REG_FIELD(ISP176x_HC_HW_MODE_CTRL, 5, 5),\n\t[HW_INTR_HIGH_ACT]\t= REG_FIELD(ISP176x_HC_HW_MODE_CTRL, 2, 2),\n\t[HW_INTR_EDGE_TRIG]\t= REG_FIELD(ISP176x_HC_HW_MODE_CTRL, 1, 1),\n\t[HW_GLOBAL_INTR_EN]\t= REG_FIELD(ISP176x_HC_HW_MODE_CTRL, 0, 0),\n\t[HC_CHIP_REV]\t\t= REG_FIELD(ISP176x_HC_CHIP_ID, 16, 31),\n\t[HC_CHIP_ID_HIGH]\t= REG_FIELD(ISP176x_HC_CHIP_ID, 8, 15),\n\t[HC_CHIP_ID_LOW]\t= REG_FIELD(ISP176x_HC_CHIP_ID, 0, 7),\n\t[HC_SCRATCH]\t\t= REG_FIELD(ISP176x_HC_SCRATCH, 0, 31),\n\t[SW_RESET_RESET_ALL]\t= REG_FIELD(ISP176x_HC_RESET, 0, 0),\n\t[ISO_BUF_FILL]\t\t= REG_FIELD(ISP176x_HC_BUFFER_STATUS, 2, 2),\n\t[INT_BUF_FILL]\t\t= REG_FIELD(ISP176x_HC_BUFFER_STATUS, 1, 1),\n\t[ATL_BUF_FILL]\t\t= REG_FIELD(ISP176x_HC_BUFFER_STATUS, 0, 0),\n\t[MEM_BANK_SEL]\t\t= REG_FIELD(ISP176x_HC_MEMORY, 16, 17),\n\t[MEM_START_ADDR]\t= REG_FIELD(ISP176x_HC_MEMORY, 0, 15),\n\t[HC_INTERRUPT]\t\t= REG_FIELD(ISP176x_HC_INTERRUPT, 0, 9),\n\t[HC_ATL_IRQ_ENABLE]\t= REG_FIELD(ISP176x_HC_INTERRUPT_ENABLE, 8, 8),\n\t[HC_INT_IRQ_ENABLE]\t= REG_FIELD(ISP176x_HC_INTERRUPT_ENABLE, 7, 7),\n\t[HC_ISO_IRQ_MASK_OR]\t= REG_FIELD(ISP176x_HC_ISO_IRQ_MASK_OR, 0, 31),\n\t[HC_INT_IRQ_MASK_OR]\t= REG_FIELD(ISP176x_HC_INT_IRQ_MASK_OR, 0, 31),\n\t[HC_ATL_IRQ_MASK_OR]\t= REG_FIELD(ISP176x_HC_ATL_IRQ_MASK_OR, 0, 31),\n\t[HC_ISO_IRQ_MASK_AND]\t= REG_FIELD(ISP176x_HC_ISO_IRQ_MASK_AND, 0, 31),\n\t[HC_INT_IRQ_MASK_AND]\t= REG_FIELD(ISP176x_HC_INT_IRQ_MASK_AND, 0, 31),\n\t[HC_ATL_IRQ_MASK_AND]\t= REG_FIELD(ISP176x_HC_ATL_IRQ_MASK_AND, 0, 31),\n\t[HW_OTG_DISABLE_CLEAR]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 26, 26),\n\t[HW_SW_SEL_HC_DC_CLEAR]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 23, 23),\n\t[HW_VBUS_DRV_CLEAR]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 20, 20),\n\t[HW_SEL_CP_EXT_CLEAR]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 19, 19),\n\t[HW_DM_PULLDOWN_CLEAR]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 18, 18),\n\t[HW_DP_PULLDOWN_CLEAR]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 17, 17),\n\t[HW_DP_PULLUP_CLEAR]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 16, 16),\n\t[HW_OTG_DISABLE]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 10, 10),\n\t[HW_SW_SEL_HC_DC]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 7, 7),\n\t[HW_VBUS_DRV]\t\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 4, 4),\n\t[HW_SEL_CP_EXT]\t\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 3, 3),\n\t[HW_DM_PULLDOWN]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 2, 2),\n\t[HW_DP_PULLDOWN]\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 1, 1),\n\t[HW_DP_PULLUP]\t\t= REG_FIELD(ISP176x_HC_OTG_CTRL, 0, 0),\n\t \n\t[HC_FIELD_MAX]\t\t= {},\n};\n\nstatic const struct reg_field isp1763_hc_reg_fields[] = {\n\t[CMD_LRESET]\t\t= REG_FIELD(ISP1763_HC_USBCMD, 7, 7),\n\t[CMD_RESET]\t\t= REG_FIELD(ISP1763_HC_USBCMD, 1, 1),\n\t[CMD_RUN]\t\t= REG_FIELD(ISP1763_HC_USBCMD, 0, 0),\n\t[STS_PCD]\t\t= REG_FIELD(ISP1763_HC_USBSTS, 2, 2),\n\t[HC_FRINDEX]\t\t= REG_FIELD(ISP1763_HC_FRINDEX, 0, 13),\n\t[FLAG_CF]\t\t= REG_FIELD(ISP1763_HC_CONFIGFLAG, 0, 0),\n\t[HC_ISO_PTD_DONEMAP]\t= REG_FIELD(ISP1763_HC_ISO_PTD_DONEMAP, 0, 15),\n\t[HC_ISO_PTD_SKIPMAP]\t= REG_FIELD(ISP1763_HC_ISO_PTD_SKIPMAP, 0, 15),\n\t[HC_ISO_PTD_LASTPTD]\t= REG_FIELD(ISP1763_HC_ISO_PTD_LASTPTD, 0, 15),\n\t[HC_INT_PTD_DONEMAP]\t= REG_FIELD(ISP1763_HC_INT_PTD_DONEMAP, 0, 15),\n\t[HC_INT_PTD_SKIPMAP]\t= REG_FIELD(ISP1763_HC_INT_PTD_SKIPMAP, 0, 15),\n\t[HC_INT_PTD_LASTPTD]\t= REG_FIELD(ISP1763_HC_INT_PTD_LASTPTD, 0, 15),\n\t[HC_ATL_PTD_DONEMAP]\t= REG_FIELD(ISP1763_HC_ATL_PTD_DONEMAP, 0, 15),\n\t[HC_ATL_PTD_SKIPMAP]\t= REG_FIELD(ISP1763_HC_ATL_PTD_SKIPMAP, 0, 15),\n\t[HC_ATL_PTD_LASTPTD]\t= REG_FIELD(ISP1763_HC_ATL_PTD_LASTPTD, 0, 15),\n\t[PORT_OWNER]\t\t= REG_FIELD(ISP1763_HC_PORTSC1, 13, 13),\n\t[PORT_POWER]\t\t= REG_FIELD(ISP1763_HC_PORTSC1, 12, 12),\n\t[PORT_LSTATUS]\t\t= REG_FIELD(ISP1763_HC_PORTSC1, 10, 11),\n\t[PORT_RESET]\t\t= REG_FIELD(ISP1763_HC_PORTSC1, 8, 8),\n\t[PORT_SUSPEND]\t\t= REG_FIELD(ISP1763_HC_PORTSC1, 7, 7),\n\t[PORT_RESUME]\t\t= REG_FIELD(ISP1763_HC_PORTSC1, 6, 6),\n\t[PORT_PE]\t\t= REG_FIELD(ISP1763_HC_PORTSC1, 2, 2),\n\t[PORT_CSC]\t\t= REG_FIELD(ISP1763_HC_PORTSC1, 1, 1),\n\t[PORT_CONNECT]\t\t= REG_FIELD(ISP1763_HC_PORTSC1, 0, 0),\n\t[HW_DATA_BUS_WIDTH]\t= REG_FIELD(ISP1763_HC_HW_MODE_CTRL, 4, 4),\n\t[HW_DACK_POL_HIGH]\t= REG_FIELD(ISP1763_HC_HW_MODE_CTRL, 6, 6),\n\t[HW_DREQ_POL_HIGH]\t= REG_FIELD(ISP1763_HC_HW_MODE_CTRL, 5, 5),\n\t[HW_INTF_LOCK]\t\t= REG_FIELD(ISP1763_HC_HW_MODE_CTRL, 3, 3),\n\t[HW_INTR_HIGH_ACT]\t= REG_FIELD(ISP1763_HC_HW_MODE_CTRL, 2, 2),\n\t[HW_INTR_EDGE_TRIG]\t= REG_FIELD(ISP1763_HC_HW_MODE_CTRL, 1, 1),\n\t[HW_GLOBAL_INTR_EN]\t= REG_FIELD(ISP1763_HC_HW_MODE_CTRL, 0, 0),\n\t[SW_RESET_RESET_ATX]\t= REG_FIELD(ISP1763_HC_RESET, 3, 3),\n\t[SW_RESET_RESET_ALL]\t= REG_FIELD(ISP1763_HC_RESET, 0, 0),\n\t[HC_CHIP_ID_HIGH]\t= REG_FIELD(ISP1763_HC_CHIP_ID, 0, 15),\n\t[HC_CHIP_ID_LOW]\t= REG_FIELD(ISP1763_HC_CHIP_REV, 8, 15),\n\t[HC_CHIP_REV]\t\t= REG_FIELD(ISP1763_HC_CHIP_REV, 0, 7),\n\t[HC_SCRATCH]\t\t= REG_FIELD(ISP1763_HC_SCRATCH, 0, 15),\n\t[ISO_BUF_FILL]\t\t= REG_FIELD(ISP1763_HC_BUFFER_STATUS, 2, 2),\n\t[INT_BUF_FILL]\t\t= REG_FIELD(ISP1763_HC_BUFFER_STATUS, 1, 1),\n\t[ATL_BUF_FILL]\t\t= REG_FIELD(ISP1763_HC_BUFFER_STATUS, 0, 0),\n\t[MEM_START_ADDR]\t= REG_FIELD(ISP1763_HC_MEMORY, 0, 15),\n\t[HC_DATA]\t\t= REG_FIELD(ISP1763_HC_DATA, 0, 15),\n\t[HC_INTERRUPT]\t\t= REG_FIELD(ISP1763_HC_INTERRUPT, 0, 10),\n\t[HC_ATL_IRQ_ENABLE]\t= REG_FIELD(ISP1763_HC_INTERRUPT_ENABLE, 8, 8),\n\t[HC_INT_IRQ_ENABLE]\t= REG_FIELD(ISP1763_HC_INTERRUPT_ENABLE, 7, 7),\n\t[HC_ISO_IRQ_MASK_OR]\t= REG_FIELD(ISP1763_HC_ISO_IRQ_MASK_OR, 0, 15),\n\t[HC_INT_IRQ_MASK_OR]\t= REG_FIELD(ISP1763_HC_INT_IRQ_MASK_OR, 0, 15),\n\t[HC_ATL_IRQ_MASK_OR]\t= REG_FIELD(ISP1763_HC_ATL_IRQ_MASK_OR, 0, 15),\n\t[HC_ISO_IRQ_MASK_AND]\t= REG_FIELD(ISP1763_HC_ISO_IRQ_MASK_AND, 0, 15),\n\t[HC_INT_IRQ_MASK_AND]\t= REG_FIELD(ISP1763_HC_INT_IRQ_MASK_AND, 0, 15),\n\t[HC_ATL_IRQ_MASK_AND]\t= REG_FIELD(ISP1763_HC_ATL_IRQ_MASK_AND, 0, 15),\n\t[HW_HC_2_DIS]\t\t= REG_FIELD(ISP1763_HC_OTG_CTRL_SET, 15, 15),\n\t[HW_OTG_DISABLE]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_SET, 10, 10),\n\t[HW_SW_SEL_HC_DC]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_SET, 7, 7),\n\t[HW_VBUS_DRV]\t\t= REG_FIELD(ISP1763_HC_OTG_CTRL_SET, 4, 4),\n\t[HW_SEL_CP_EXT]\t\t= REG_FIELD(ISP1763_HC_OTG_CTRL_SET, 3, 3),\n\t[HW_DM_PULLDOWN]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_SET, 2, 2),\n\t[HW_DP_PULLDOWN]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_SET, 1, 1),\n\t[HW_DP_PULLUP]\t\t= REG_FIELD(ISP1763_HC_OTG_CTRL_SET, 0, 0),\n\t[HW_HC_2_DIS_CLEAR]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_CLEAR, 15, 15),\n\t[HW_OTG_DISABLE_CLEAR]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_CLEAR, 10, 10),\n\t[HW_SW_SEL_HC_DC_CLEAR]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_CLEAR, 7, 7),\n\t[HW_VBUS_DRV_CLEAR]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_CLEAR, 4, 4),\n\t[HW_SEL_CP_EXT_CLEAR]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_CLEAR, 3, 3),\n\t[HW_DM_PULLDOWN_CLEAR]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_CLEAR, 2, 2),\n\t[HW_DP_PULLDOWN_CLEAR]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_CLEAR, 1, 1),\n\t[HW_DP_PULLUP_CLEAR]\t= REG_FIELD(ISP1763_HC_OTG_CTRL_CLEAR, 0, 0),\n\t \n\t[HC_FIELD_MAX]\t\t= {},\n};\n\nstatic const struct regmap_range isp1763_hc_volatile_ranges[] = {\n\tregmap_reg_range(ISP1763_HC_USBCMD, ISP1763_HC_ATL_PTD_LASTPTD),\n\tregmap_reg_range(ISP1763_HC_BUFFER_STATUS, ISP1763_HC_DATA),\n\tregmap_reg_range(ISP1763_HC_INTERRUPT, ISP1763_HC_OTG_CTRL_CLEAR),\n};\n\nstatic const struct regmap_access_table isp1763_hc_volatile_table = {\n\t.yes_ranges\t= isp1763_hc_volatile_ranges,\n\t.n_yes_ranges\t= ARRAY_SIZE(isp1763_hc_volatile_ranges),\n};\n\nstatic const struct regmap_config isp1763_hc_regmap_conf = {\n\t.name = \"isp1763-hc\",\n\t.reg_bits = 8,\n\t.reg_stride = 2,\n\t.val_bits = 16,\n\t.fast_io = true,\n\t.max_register = ISP1763_HC_OTG_CTRL_CLEAR,\n\t.volatile_table = &isp1763_hc_volatile_table,\n};\n\nstatic const struct regmap_range isp176x_dc_volatile_ranges[] = {\n\tregmap_reg_range(ISP176x_DC_EPMAXPKTSZ, ISP176x_DC_EPTYPE),\n\tregmap_reg_range(ISP176x_DC_BUFLEN, ISP176x_DC_EPINDEX),\n};\n\nstatic const struct regmap_access_table isp176x_dc_volatile_table = {\n\t.yes_ranges\t= isp176x_dc_volatile_ranges,\n\t.n_yes_ranges\t= ARRAY_SIZE(isp176x_dc_volatile_ranges),\n};\n\nstatic const struct regmap_config isp1761_dc_regmap_conf = {\n\t.name = \"isp1761-dc\",\n\t.reg_bits = 16,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.fast_io = true,\n\t.max_register = ISP176x_DC_TESTMODE,\n\t.volatile_table = &isp176x_dc_volatile_table,\n};\n\nstatic const struct reg_field isp1761_dc_reg_fields[] = {\n\t[DC_DEVEN]\t\t= REG_FIELD(ISP176x_DC_ADDRESS, 7, 7),\n\t[DC_DEVADDR]\t\t= REG_FIELD(ISP176x_DC_ADDRESS, 0, 6),\n\t[DC_VBUSSTAT]\t\t= REG_FIELD(ISP176x_DC_MODE, 8, 8),\n\t[DC_SFRESET]\t\t= REG_FIELD(ISP176x_DC_MODE, 4, 4),\n\t[DC_GLINTENA]\t\t= REG_FIELD(ISP176x_DC_MODE, 3, 3),\n\t[DC_CDBGMOD_ACK]\t= REG_FIELD(ISP176x_DC_INTCONF, 6, 6),\n\t[DC_DDBGMODIN_ACK]\t= REG_FIELD(ISP176x_DC_INTCONF, 4, 4),\n\t[DC_DDBGMODOUT_ACK]\t= REG_FIELD(ISP176x_DC_INTCONF, 2, 2),\n\t[DC_INTPOL]\t\t= REG_FIELD(ISP176x_DC_INTCONF, 0, 0),\n\t[DC_IEPRXTX_7]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 25, 25),\n\t[DC_IEPRXTX_6]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 23, 23),\n\t[DC_IEPRXTX_5]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 21, 21),\n\t[DC_IEPRXTX_4]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 19, 19),\n\t[DC_IEPRXTX_3]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 17, 17),\n\t[DC_IEPRXTX_2]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 15, 15),\n\t[DC_IEPRXTX_1]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 13, 13),\n\t[DC_IEPRXTX_0]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 11, 11),\n\t[DC_IEP0SETUP]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 8, 8),\n\t[DC_IEVBUS]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 7, 7),\n\t[DC_IEHS_STA]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 5, 5),\n\t[DC_IERESM]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 4, 4),\n\t[DC_IESUSP]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 3, 3),\n\t[DC_IEBRST]\t\t= REG_FIELD(ISP176x_DC_INTENABLE, 0, 0),\n\t[DC_EP0SETUP]\t\t= REG_FIELD(ISP176x_DC_EPINDEX, 5, 5),\n\t[DC_ENDPIDX]\t\t= REG_FIELD(ISP176x_DC_EPINDEX, 1, 4),\n\t[DC_EPDIR]\t\t= REG_FIELD(ISP176x_DC_EPINDEX, 0, 0),\n\t[DC_CLBUF]\t\t= REG_FIELD(ISP176x_DC_CTRLFUNC, 4, 4),\n\t[DC_VENDP]\t\t= REG_FIELD(ISP176x_DC_CTRLFUNC, 3, 3),\n\t[DC_DSEN]\t\t= REG_FIELD(ISP176x_DC_CTRLFUNC, 2, 2),\n\t[DC_STATUS]\t\t= REG_FIELD(ISP176x_DC_CTRLFUNC, 1, 1),\n\t[DC_STALL]\t\t= REG_FIELD(ISP176x_DC_CTRLFUNC, 0, 0),\n\t[DC_BUFLEN]\t\t= REG_FIELD(ISP176x_DC_BUFLEN, 0, 15),\n\t[DC_FFOSZ]\t\t= REG_FIELD(ISP176x_DC_EPMAXPKTSZ, 0, 10),\n\t[DC_EPENABLE]\t\t= REG_FIELD(ISP176x_DC_EPTYPE, 3, 3),\n\t[DC_ENDPTYP]\t\t= REG_FIELD(ISP176x_DC_EPTYPE, 0, 1),\n\t[DC_UFRAMENUM]\t\t= REG_FIELD(ISP176x_DC_FRAMENUM, 11, 13),\n\t[DC_FRAMENUM]\t\t= REG_FIELD(ISP176x_DC_FRAMENUM, 0, 10),\n\t[DC_CHIP_ID_HIGH]\t= REG_FIELD(ISP176x_DC_CHIPID, 16, 31),\n\t[DC_CHIP_ID_LOW]\t= REG_FIELD(ISP176x_DC_CHIPID, 0, 15),\n\t[DC_SCRATCH]\t\t= REG_FIELD(ISP176x_DC_SCRATCH, 0, 15),\n\t \n\t[DC_FIELD_MAX]\t\t= {},\n};\n\nstatic const struct regmap_range isp1763_dc_volatile_ranges[] = {\n\tregmap_reg_range(ISP1763_DC_EPMAXPKTSZ, ISP1763_DC_EPTYPE),\n\tregmap_reg_range(ISP1763_DC_BUFLEN, ISP1763_DC_EPINDEX),\n};\n\nstatic const struct regmap_access_table isp1763_dc_volatile_table = {\n\t.yes_ranges\t= isp1763_dc_volatile_ranges,\n\t.n_yes_ranges\t= ARRAY_SIZE(isp1763_dc_volatile_ranges),\n};\n\nstatic const struct reg_field isp1763_dc_reg_fields[] = {\n\t[DC_DEVEN]\t\t= REG_FIELD(ISP1763_DC_ADDRESS, 7, 7),\n\t[DC_DEVADDR]\t\t= REG_FIELD(ISP1763_DC_ADDRESS, 0, 6),\n\t[DC_VBUSSTAT]\t\t= REG_FIELD(ISP1763_DC_MODE, 8, 8),\n\t[DC_SFRESET]\t\t= REG_FIELD(ISP1763_DC_MODE, 4, 4),\n\t[DC_GLINTENA]\t\t= REG_FIELD(ISP1763_DC_MODE, 3, 3),\n\t[DC_CDBGMOD_ACK]\t= REG_FIELD(ISP1763_DC_INTCONF, 6, 6),\n\t[DC_DDBGMODIN_ACK]\t= REG_FIELD(ISP1763_DC_INTCONF, 4, 4),\n\t[DC_DDBGMODOUT_ACK]\t= REG_FIELD(ISP1763_DC_INTCONF, 2, 2),\n\t[DC_INTPOL]\t\t= REG_FIELD(ISP1763_DC_INTCONF, 0, 0),\n\t[DC_IEPRXTX_7]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 25, 25),\n\t[DC_IEPRXTX_6]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 23, 23),\n\t[DC_IEPRXTX_5]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 21, 21),\n\t[DC_IEPRXTX_4]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 19, 19),\n\t[DC_IEPRXTX_3]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 17, 17),\n\t[DC_IEPRXTX_2]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 15, 15),\n\t[DC_IEPRXTX_1]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 13, 13),\n\t[DC_IEPRXTX_0]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 11, 11),\n\t[DC_IEP0SETUP]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 8, 8),\n\t[DC_IEVBUS]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 7, 7),\n\t[DC_IEHS_STA]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 5, 5),\n\t[DC_IERESM]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 4, 4),\n\t[DC_IESUSP]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 3, 3),\n\t[DC_IEBRST]\t\t= REG_FIELD(ISP1763_DC_INTENABLE, 0, 0),\n\t[DC_EP0SETUP]\t\t= REG_FIELD(ISP1763_DC_EPINDEX, 5, 5),\n\t[DC_ENDPIDX]\t\t= REG_FIELD(ISP1763_DC_EPINDEX, 1, 4),\n\t[DC_EPDIR]\t\t= REG_FIELD(ISP1763_DC_EPINDEX, 0, 0),\n\t[DC_CLBUF]\t\t= REG_FIELD(ISP1763_DC_CTRLFUNC, 4, 4),\n\t[DC_VENDP]\t\t= REG_FIELD(ISP1763_DC_CTRLFUNC, 3, 3),\n\t[DC_DSEN]\t\t= REG_FIELD(ISP1763_DC_CTRLFUNC, 2, 2),\n\t[DC_STATUS]\t\t= REG_FIELD(ISP1763_DC_CTRLFUNC, 1, 1),\n\t[DC_STALL]\t\t= REG_FIELD(ISP1763_DC_CTRLFUNC, 0, 0),\n\t[DC_BUFLEN]\t\t= REG_FIELD(ISP1763_DC_BUFLEN, 0, 15),\n\t[DC_FFOSZ]\t\t= REG_FIELD(ISP1763_DC_EPMAXPKTSZ, 0, 10),\n\t[DC_EPENABLE]\t\t= REG_FIELD(ISP1763_DC_EPTYPE, 3, 3),\n\t[DC_ENDPTYP]\t\t= REG_FIELD(ISP1763_DC_EPTYPE, 0, 1),\n\t[DC_UFRAMENUM]\t\t= REG_FIELD(ISP1763_DC_FRAMENUM, 11, 13),\n\t[DC_FRAMENUM]\t\t= REG_FIELD(ISP1763_DC_FRAMENUM, 0, 10),\n\t[DC_CHIP_ID_HIGH]\t= REG_FIELD(ISP1763_DC_CHIPID_HIGH, 0, 15),\n\t[DC_CHIP_ID_LOW]\t= REG_FIELD(ISP1763_DC_CHIPID_LOW, 0, 15),\n\t[DC_SCRATCH]\t\t= REG_FIELD(ISP1763_DC_SCRATCH, 0, 15),\n\t \n\t[DC_FIELD_MAX]\t\t= {},\n};\n\nstatic const struct regmap_config isp1763_dc_regmap_conf = {\n\t.name = \"isp1763-dc\",\n\t.reg_bits = 8,\n\t.reg_stride = 2,\n\t.val_bits = 16,\n\t.fast_io = true,\n\t.max_register = ISP1763_DC_TESTMODE,\n\t.volatile_table = &isp1763_dc_volatile_table,\n};\n\nint isp1760_register(struct resource *mem, int irq, unsigned long irqflags,\n\t\t     struct device *dev, unsigned int devflags)\n{\n\tconst struct regmap_config *hc_regmap;\n\tconst struct reg_field *hc_reg_fields;\n\tconst struct regmap_config *dc_regmap;\n\tconst struct reg_field *dc_reg_fields;\n\tstruct isp1760_device *isp;\n\tstruct isp1760_hcd *hcd;\n\tstruct isp1760_udc *udc;\n\tstruct regmap_field *f;\n\tbool udc_enabled;\n\tint ret;\n\tint i;\n\n\t \n\tudc_enabled = ((devflags & ISP1760_FLAG_ISP1763) ||\n\t\t       (devflags & ISP1760_FLAG_ISP1761));\n\n\tif ((!IS_ENABLED(CONFIG_USB_ISP1760_HCD) || usb_disabled()) &&\n\t    (!udc_enabled || !IS_ENABLED(CONFIG_USB_ISP1761_UDC)))\n\t\treturn -ENODEV;\n\n\tisp = devm_kzalloc(dev, sizeof(*isp), GFP_KERNEL);\n\tif (!isp)\n\t\treturn -ENOMEM;\n\n\tisp->dev = dev;\n\tisp->devflags = devflags;\n\thcd = &isp->hcd;\n\tudc = &isp->udc;\n\n\thcd->is_isp1763 = !!(devflags & ISP1760_FLAG_ISP1763);\n\tudc->is_isp1763 = !!(devflags & ISP1760_FLAG_ISP1763);\n\n\tif (!hcd->is_isp1763 && (devflags & ISP1760_FLAG_BUS_WIDTH_8)) {\n\t\tdev_err(dev, \"isp1760/61 do not support data width 8\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (hcd->is_isp1763) {\n\t\thc_regmap = &isp1763_hc_regmap_conf;\n\t\thc_reg_fields = &isp1763_hc_reg_fields[0];\n\t\tdc_regmap = &isp1763_dc_regmap_conf;\n\t\tdc_reg_fields = &isp1763_dc_reg_fields[0];\n\t} else {\n\t\thc_regmap = &isp1760_hc_regmap_conf;\n\t\thc_reg_fields = &isp1760_hc_reg_fields[0];\n\t\tdc_regmap = &isp1761_dc_regmap_conf;\n\t\tdc_reg_fields = &isp1761_dc_reg_fields[0];\n\t}\n\n\tisp->rst_gpio = devm_gpiod_get_optional(dev, NULL, GPIOD_OUT_HIGH);\n\tif (IS_ERR(isp->rst_gpio))\n\t\treturn PTR_ERR(isp->rst_gpio);\n\n\thcd->base = devm_ioremap_resource(dev, mem);\n\tif (IS_ERR(hcd->base))\n\t\treturn PTR_ERR(hcd->base);\n\n\thcd->regs = devm_regmap_init_mmio(dev, hcd->base, hc_regmap);\n\tif (IS_ERR(hcd->regs))\n\t\treturn PTR_ERR(hcd->regs);\n\n\tfor (i = 0; i < HC_FIELD_MAX; i++) {\n\t\tf = devm_regmap_field_alloc(dev, hcd->regs, hc_reg_fields[i]);\n\t\tif (IS_ERR(f))\n\t\t\treturn PTR_ERR(f);\n\n\t\thcd->fields[i] = f;\n\t}\n\n\tudc->regs = devm_regmap_init_mmio(dev, hcd->base, dc_regmap);\n\tif (IS_ERR(udc->regs))\n\t\treturn PTR_ERR(udc->regs);\n\n\tfor (i = 0; i < DC_FIELD_MAX; i++) {\n\t\tf = devm_regmap_field_alloc(dev, udc->regs, dc_reg_fields[i]);\n\t\tif (IS_ERR(f))\n\t\t\treturn PTR_ERR(f);\n\n\t\tudc->fields[i] = f;\n\t}\n\n\tif (hcd->is_isp1763)\n\t\thcd->memory_layout = &isp1763_memory_conf;\n\telse\n\t\thcd->memory_layout = &isp176x_memory_conf;\n\n\tret = isp1760_init_core(isp);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (IS_ENABLED(CONFIG_USB_ISP1760_HCD) && !usb_disabled()) {\n\t\tret = isp1760_hcd_register(hcd, mem, irq,\n\t\t\t\t\t   irqflags | IRQF_SHARED, dev);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (udc_enabled && IS_ENABLED(CONFIG_USB_ISP1761_UDC)) {\n\t\tret = isp1760_udc_register(isp, irq, irqflags);\n\t\tif (ret < 0) {\n\t\t\tisp1760_hcd_unregister(hcd);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tdev_set_drvdata(dev, isp);\n\n\treturn 0;\n}\n\nvoid isp1760_unregister(struct device *dev)\n{\n\tstruct isp1760_device *isp = dev_get_drvdata(dev);\n\n\tisp1760_udc_unregister(isp);\n\tisp1760_hcd_unregister(&isp->hcd);\n}\n\nMODULE_DESCRIPTION(\"Driver for the ISP1760 USB-controller from NXP\");\nMODULE_AUTHOR(\"Sebastian Siewior <bigeasy@linuxtronix.de>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}