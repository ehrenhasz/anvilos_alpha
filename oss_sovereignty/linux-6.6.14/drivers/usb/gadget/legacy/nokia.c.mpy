{
  "module_name": "nokia.c",
  "hash_id": "1ec4a60076350af5a0bcd7ef1e8778118698eca62f927224239aaf32b9122684",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/gadget/legacy/nokia.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/device.h>\n\n#include \"u_serial.h\"\n#include \"u_ether.h\"\n#include \"u_phonet.h\"\n#include \"u_ecm.h\"\n#include \"f_mass_storage.h\"\n\n \n\n#define NOKIA_VERSION_NUM\t\t0x0211\n#define NOKIA_LONG_NAME\t\t\t\"N900 (PC-Suite Mode)\"\n\nUSB_GADGET_COMPOSITE_OPTIONS();\n\nUSB_ETHERNET_MODULE_PARAMETERS();\n\nstatic struct fsg_module_parameters fsg_mod_data = {\n\t.stall = 0,\n\t.luns = 2,\n\t.removable_count = 2,\n\t.removable = { 1, 1, },\n};\n\n#ifdef CONFIG_USB_GADGET_DEBUG_FILES\n\nstatic unsigned int fsg_num_buffers = CONFIG_USB_GADGET_STORAGE_NUM_BUFFERS;\n\n#else\n\n \n#define fsg_num_buffers\tCONFIG_USB_GADGET_STORAGE_NUM_BUFFERS\n\n#endif  \n\nFSG_MODULE_PARAMETERS( , fsg_mod_data);\n\n#define NOKIA_VENDOR_ID\t\t\t0x0421\t \n#define NOKIA_PRODUCT_ID\t\t0x01c8\t \n\n \n\n#define STRING_DESCRIPTION_IDX\t\tUSB_GADGET_FIRST_AVAIL_IDX\n\nstatic char manufacturer_nokia[] = \"Nokia\";\nstatic const char description_nokia[] = \"PC-Suite Configuration\";\n\nstatic struct usb_string strings_dev[] = {\n\t[USB_GADGET_MANUFACTURER_IDX].s = manufacturer_nokia,\n\t[USB_GADGET_PRODUCT_IDX].s = NOKIA_LONG_NAME,\n\t[USB_GADGET_SERIAL_IDX].s = \"\",\n\t[STRING_DESCRIPTION_IDX].s = description_nokia,\n\t{  }  \n};\n\nstatic struct usb_gadget_strings stringtab_dev = {\n\t.language\t= 0x0409,\t \n\t.strings\t= strings_dev,\n};\n\nstatic struct usb_gadget_strings *dev_strings[] = {\n\t&stringtab_dev,\n\tNULL,\n};\n\nstatic struct usb_device_descriptor device_desc = {\n\t.bLength\t\t= USB_DT_DEVICE_SIZE,\n\t.bDescriptorType\t= USB_DT_DEVICE,\n\t \n\t.bDeviceClass\t\t= USB_CLASS_COMM,\n\t.idVendor\t\t= cpu_to_le16(NOKIA_VENDOR_ID),\n\t.idProduct\t\t= cpu_to_le16(NOKIA_PRODUCT_ID),\n\t.bcdDevice\t\t= cpu_to_le16(NOKIA_VERSION_NUM),\n\t \n\t \n\t.bNumConfigurations =\t1,\n};\n\n \n\n \nMODULE_DESCRIPTION(\"Nokia composite gadget driver for N900\");\nMODULE_AUTHOR(\"Felipe Balbi\");\nMODULE_LICENSE(\"GPL\");\n\n \nstatic struct usb_function *f_acm_cfg1;\nstatic struct usb_function *f_acm_cfg2;\nstatic struct usb_function *f_ecm_cfg1;\nstatic struct usb_function *f_ecm_cfg2;\nstatic struct usb_function *f_obex1_cfg1;\nstatic struct usb_function *f_obex2_cfg1;\nstatic struct usb_function *f_obex1_cfg2;\nstatic struct usb_function *f_obex2_cfg2;\nstatic struct usb_function *f_phonet_cfg1;\nstatic struct usb_function *f_phonet_cfg2;\nstatic struct usb_function *f_msg_cfg1;\nstatic struct usb_function *f_msg_cfg2;\n\n\nstatic struct usb_configuration nokia_config_500ma_driver = {\n\t.label\t\t= \"Bus Powered\",\n\t.bConfigurationValue = 1,\n\t \n\t.bmAttributes\t= USB_CONFIG_ATT_ONE,\n\t.MaxPower\t= 500,\n};\n\nstatic struct usb_configuration nokia_config_100ma_driver = {\n\t.label\t\t= \"Self Powered\",\n\t.bConfigurationValue = 2,\n\t \n\t.bmAttributes\t= USB_CONFIG_ATT_ONE | USB_CONFIG_ATT_SELFPOWER,\n\t.MaxPower\t= 100,\n};\n\nstatic struct usb_function_instance *fi_acm;\nstatic struct usb_function_instance *fi_ecm;\nstatic struct usb_function_instance *fi_obex1;\nstatic struct usb_function_instance *fi_obex2;\nstatic struct usb_function_instance *fi_phonet;\nstatic struct usb_function_instance *fi_msg;\n\nstatic int nokia_bind_config(struct usb_configuration *c)\n{\n\tstruct usb_function *f_acm;\n\tstruct usb_function *f_phonet = NULL;\n\tstruct usb_function *f_obex1 = NULL;\n\tstruct usb_function *f_ecm;\n\tstruct usb_function *f_obex2 = NULL;\n\tstruct usb_function *f_msg;\n\tint status = 0;\n\tint obex1_stat = -1;\n\tint obex2_stat = -1;\n\tint phonet_stat = -1;\n\n\tif (!IS_ERR(fi_phonet)) {\n\t\tf_phonet = usb_get_function(fi_phonet);\n\t\tif (IS_ERR(f_phonet))\n\t\t\tpr_debug(\"could not get phonet function\\n\");\n\t}\n\n\tif (!IS_ERR(fi_obex1)) {\n\t\tf_obex1 = usb_get_function(fi_obex1);\n\t\tif (IS_ERR(f_obex1))\n\t\t\tpr_debug(\"could not get obex function 0\\n\");\n\t}\n\n\tif (!IS_ERR(fi_obex2)) {\n\t\tf_obex2 = usb_get_function(fi_obex2);\n\t\tif (IS_ERR(f_obex2))\n\t\t\tpr_debug(\"could not get obex function 1\\n\");\n\t}\n\n\tf_acm = usb_get_function(fi_acm);\n\tif (IS_ERR(f_acm)) {\n\t\tstatus = PTR_ERR(f_acm);\n\t\tgoto err_get_acm;\n\t}\n\n\tf_ecm = usb_get_function(fi_ecm);\n\tif (IS_ERR(f_ecm)) {\n\t\tstatus = PTR_ERR(f_ecm);\n\t\tgoto err_get_ecm;\n\t}\n\n\tf_msg = usb_get_function(fi_msg);\n\tif (IS_ERR(f_msg)) {\n\t\tstatus = PTR_ERR(f_msg);\n\t\tgoto err_get_msg;\n\t}\n\n\tif (!IS_ERR_OR_NULL(f_phonet)) {\n\t\tphonet_stat = usb_add_function(c, f_phonet);\n\t\tif (phonet_stat)\n\t\t\tpr_debug(\"could not add phonet function\\n\");\n\t}\n\n\tif (!IS_ERR_OR_NULL(f_obex1)) {\n\t\tobex1_stat = usb_add_function(c, f_obex1);\n\t\tif (obex1_stat)\n\t\t\tpr_debug(\"could not add obex function 0\\n\");\n\t}\n\n\tif (!IS_ERR_OR_NULL(f_obex2)) {\n\t\tobex2_stat = usb_add_function(c, f_obex2);\n\t\tif (obex2_stat)\n\t\t\tpr_debug(\"could not add obex function 1\\n\");\n\t}\n\n\tstatus = usb_add_function(c, f_acm);\n\tif (status)\n\t\tgoto err_conf;\n\n\tstatus = usb_add_function(c, f_ecm);\n\tif (status) {\n\t\tpr_debug(\"could not bind ecm config %d\\n\", status);\n\t\tgoto err_ecm;\n\t}\n\n\tstatus = usb_add_function(c, f_msg);\n\tif (status)\n\t\tgoto err_msg;\n\n\tif (c == &nokia_config_500ma_driver) {\n\t\tf_acm_cfg1 = f_acm;\n\t\tf_ecm_cfg1 = f_ecm;\n\t\tf_phonet_cfg1 = f_phonet;\n\t\tf_obex1_cfg1 = f_obex1;\n\t\tf_obex2_cfg1 = f_obex2;\n\t\tf_msg_cfg1 = f_msg;\n\t} else {\n\t\tf_acm_cfg2 = f_acm;\n\t\tf_ecm_cfg2 = f_ecm;\n\t\tf_phonet_cfg2 = f_phonet;\n\t\tf_obex1_cfg2 = f_obex1;\n\t\tf_obex2_cfg2 = f_obex2;\n\t\tf_msg_cfg2 = f_msg;\n\t}\n\n\treturn status;\nerr_msg:\n\tusb_remove_function(c, f_ecm);\nerr_ecm:\n\tusb_remove_function(c, f_acm);\nerr_conf:\n\tif (!obex2_stat)\n\t\tusb_remove_function(c, f_obex2);\n\tif (!obex1_stat)\n\t\tusb_remove_function(c, f_obex1);\n\tif (!phonet_stat)\n\t\tusb_remove_function(c, f_phonet);\n\tusb_put_function(f_msg);\nerr_get_msg:\n\tusb_put_function(f_ecm);\nerr_get_ecm:\n\tusb_put_function(f_acm);\nerr_get_acm:\n\tif (!IS_ERR_OR_NULL(f_obex2))\n\t\tusb_put_function(f_obex2);\n\tif (!IS_ERR_OR_NULL(f_obex1))\n\t\tusb_put_function(f_obex1);\n\tif (!IS_ERR_OR_NULL(f_phonet))\n\t\tusb_put_function(f_phonet);\n\treturn status;\n}\n\nstatic int nokia_bind(struct usb_composite_dev *cdev)\n{\n\tstruct usb_gadget\t*gadget = cdev->gadget;\n\tstruct fsg_opts\t\t*fsg_opts;\n\tstruct fsg_config\tfsg_config;\n\tint\t\t\tstatus;\n\n\tstatus = usb_string_ids_tab(cdev, strings_dev);\n\tif (status < 0)\n\t\tgoto err_usb;\n\tdevice_desc.iManufacturer = strings_dev[USB_GADGET_MANUFACTURER_IDX].id;\n\tdevice_desc.iProduct = strings_dev[USB_GADGET_PRODUCT_IDX].id;\n\tstatus = strings_dev[STRING_DESCRIPTION_IDX].id;\n\tnokia_config_500ma_driver.iConfiguration = status;\n\tnokia_config_100ma_driver.iConfiguration = status;\n\n\tif (!gadget_is_altset_supported(gadget)) {\n\t\tstatus = -ENODEV;\n\t\tgoto err_usb;\n\t}\n\n\tfi_phonet = usb_get_function_instance(\"phonet\");\n\tif (IS_ERR(fi_phonet))\n\t\tpr_debug(\"could not find phonet function\\n\");\n\n\tfi_obex1 = usb_get_function_instance(\"obex\");\n\tif (IS_ERR(fi_obex1))\n\t\tpr_debug(\"could not find obex function 1\\n\");\n\n\tfi_obex2 = usb_get_function_instance(\"obex\");\n\tif (IS_ERR(fi_obex2))\n\t\tpr_debug(\"could not find obex function 2\\n\");\n\n\tfi_acm = usb_get_function_instance(\"acm\");\n\tif (IS_ERR(fi_acm)) {\n\t\tstatus = PTR_ERR(fi_acm);\n\t\tgoto err_obex2_inst;\n\t}\n\n\tfi_ecm = usb_get_function_instance(\"ecm\");\n\tif (IS_ERR(fi_ecm)) {\n\t\tstatus = PTR_ERR(fi_ecm);\n\t\tgoto err_acm_inst;\n\t}\n\n\tfi_msg = usb_get_function_instance(\"mass_storage\");\n\tif (IS_ERR(fi_msg)) {\n\t\tstatus = PTR_ERR(fi_msg);\n\t\tgoto err_ecm_inst;\n\t}\n\n\t \n\tfsg_config_from_params(&fsg_config, &fsg_mod_data, fsg_num_buffers);\n\tfsg_config.vendor_name = \"Nokia\";\n\tfsg_config.product_name = \"N900\";\n\n\tfsg_opts = fsg_opts_from_func_inst(fi_msg);\n\tfsg_opts->no_configfs = true;\n\n\tstatus = fsg_common_set_num_buffers(fsg_opts->common, fsg_num_buffers);\n\tif (status)\n\t\tgoto err_msg_inst;\n\n\tstatus = fsg_common_set_cdev(fsg_opts->common, cdev, fsg_config.can_stall);\n\tif (status)\n\t\tgoto err_msg_buf;\n\n\tfsg_common_set_sysfs(fsg_opts->common, true);\n\n\tstatus = fsg_common_create_luns(fsg_opts->common, &fsg_config);\n\tif (status)\n\t\tgoto err_msg_buf;\n\n\tfsg_common_set_inquiry_string(fsg_opts->common, fsg_config.vendor_name,\n\t\t\t\t      fsg_config.product_name);\n\n\t \n\tstatus = usb_add_config(cdev, &nokia_config_500ma_driver,\n\t\t\tnokia_bind_config);\n\tif (status < 0)\n\t\tgoto err_msg_luns;\n\n\tstatus = usb_add_config(cdev, &nokia_config_100ma_driver,\n\t\t\tnokia_bind_config);\n\tif (status < 0)\n\t\tgoto err_put_cfg1;\n\n\tusb_composite_overwrite_options(cdev, &coverwrite);\n\tdev_info(&gadget->dev, \"%s\\n\", NOKIA_LONG_NAME);\n\n\treturn 0;\n\nerr_put_cfg1:\n\tusb_put_function(f_acm_cfg1);\n\tif (!IS_ERR_OR_NULL(f_obex1_cfg1))\n\t\tusb_put_function(f_obex1_cfg1);\n\tif (!IS_ERR_OR_NULL(f_obex2_cfg1))\n\t\tusb_put_function(f_obex2_cfg1);\n\tif (!IS_ERR_OR_NULL(f_phonet_cfg1))\n\t\tusb_put_function(f_phonet_cfg1);\n\tusb_put_function(f_ecm_cfg1);\nerr_msg_luns:\n\tfsg_common_remove_luns(fsg_opts->common);\nerr_msg_buf:\n\tfsg_common_free_buffers(fsg_opts->common);\nerr_msg_inst:\n\tusb_put_function_instance(fi_msg);\nerr_ecm_inst:\n\tusb_put_function_instance(fi_ecm);\nerr_acm_inst:\n\tusb_put_function_instance(fi_acm);\nerr_obex2_inst:\n\tif (!IS_ERR(fi_obex2))\n\t\tusb_put_function_instance(fi_obex2);\n\tif (!IS_ERR(fi_obex1))\n\t\tusb_put_function_instance(fi_obex1);\n\tif (!IS_ERR(fi_phonet))\n\t\tusb_put_function_instance(fi_phonet);\nerr_usb:\n\treturn status;\n}\n\nstatic int nokia_unbind(struct usb_composite_dev *cdev)\n{\n\tif (!IS_ERR_OR_NULL(f_obex1_cfg2))\n\t\tusb_put_function(f_obex1_cfg2);\n\tif (!IS_ERR_OR_NULL(f_obex2_cfg2))\n\t\tusb_put_function(f_obex2_cfg2);\n\tif (!IS_ERR_OR_NULL(f_obex1_cfg1))\n\t\tusb_put_function(f_obex1_cfg1);\n\tif (!IS_ERR_OR_NULL(f_obex2_cfg1))\n\t\tusb_put_function(f_obex2_cfg1);\n\tif (!IS_ERR_OR_NULL(f_phonet_cfg1))\n\t\tusb_put_function(f_phonet_cfg1);\n\tif (!IS_ERR_OR_NULL(f_phonet_cfg2))\n\t\tusb_put_function(f_phonet_cfg2);\n\tusb_put_function(f_acm_cfg1);\n\tusb_put_function(f_acm_cfg2);\n\tusb_put_function(f_ecm_cfg1);\n\tusb_put_function(f_ecm_cfg2);\n\tusb_put_function(f_msg_cfg1);\n\tusb_put_function(f_msg_cfg2);\n\n\tusb_put_function_instance(fi_msg);\n\tusb_put_function_instance(fi_ecm);\n\tif (!IS_ERR(fi_obex2))\n\t\tusb_put_function_instance(fi_obex2);\n\tif (!IS_ERR(fi_obex1))\n\t\tusb_put_function_instance(fi_obex1);\n\tif (!IS_ERR(fi_phonet))\n\t\tusb_put_function_instance(fi_phonet);\n\tusb_put_function_instance(fi_acm);\n\n\treturn 0;\n}\n\nstatic struct usb_composite_driver nokia_driver = {\n\t.name\t\t= \"g_nokia\",\n\t.dev\t\t= &device_desc,\n\t.strings\t= dev_strings,\n\t.max_speed\t= USB_SPEED_HIGH,\n\t.bind\t\t= nokia_bind,\n\t.unbind\t\t= nokia_unbind,\n};\n\nmodule_usb_composite_driver(nokia_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}