{
  "module_name": "mass_storage.c",
  "hash_id": "304379d81fc2bd7cfdfc96a799921dab486fc5204b4f88864b329ca417a6e7bc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/gadget/legacy/mass_storage.c",
  "human_readable_source": "\n \n\n\n \n\n\n#include <linux/kernel.h>\n#include <linux/usb/ch9.h>\n#include <linux/module.h>\n\n \n\n#define DRIVER_DESC\t\t\"Mass Storage Gadget\"\n#define DRIVER_VERSION\t\t\"2009/09/11\"\n\n \n#define FSG_VENDOR_ID\t0x0525\t \n#define FSG_PRODUCT_ID\t0xa4a5\t \n\n#include \"f_mass_storage.h\"\n\n \nUSB_GADGET_COMPOSITE_OPTIONS();\n\nstatic struct usb_device_descriptor msg_device_desc = {\n\t.bLength =\t\tsizeof msg_device_desc,\n\t.bDescriptorType =\tUSB_DT_DEVICE,\n\n\t \n\t.bDeviceClass =\t\tUSB_CLASS_PER_INTERFACE,\n\n\t \n\t.idVendor =\t\tcpu_to_le16(FSG_VENDOR_ID),\n\t.idProduct =\t\tcpu_to_le16(FSG_PRODUCT_ID),\n\t.bNumConfigurations =\t1,\n};\n\nstatic const struct usb_descriptor_header *otg_desc[2];\n\nstatic struct usb_string strings_dev[] = {\n\t[USB_GADGET_MANUFACTURER_IDX].s = \"\",\n\t[USB_GADGET_PRODUCT_IDX].s = DRIVER_DESC,\n\t[USB_GADGET_SERIAL_IDX].s = \"\",\n\t{  }  \n};\n\nstatic struct usb_gadget_strings stringtab_dev = {\n\t.language       = 0x0409,        \n\t.strings        = strings_dev,\n};\n\nstatic struct usb_gadget_strings *dev_strings[] = {\n\t&stringtab_dev,\n\tNULL,\n};\n\nstatic struct usb_function_instance *fi_msg;\nstatic struct usb_function *f_msg;\n\n \n\nstatic struct fsg_module_parameters mod_data = {\n\t.stall = 1\n};\n#ifdef CONFIG_USB_GADGET_DEBUG_FILES\n\nstatic unsigned int fsg_num_buffers = CONFIG_USB_GADGET_STORAGE_NUM_BUFFERS;\n\n#else\n\n \n#define fsg_num_buffers\tCONFIG_USB_GADGET_STORAGE_NUM_BUFFERS\n\n#endif  \n\nFSG_MODULE_PARAMETERS( , mod_data);\n\nstatic int msg_do_config(struct usb_configuration *c)\n{\n\tint ret;\n\n\tif (gadget_is_otg(c->cdev->gadget)) {\n\t\tc->descriptors = otg_desc;\n\t\tc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\n\t}\n\n\tf_msg = usb_get_function(fi_msg);\n\tif (IS_ERR(f_msg))\n\t\treturn PTR_ERR(f_msg);\n\n\tret = usb_add_function(c, f_msg);\n\tif (ret)\n\t\tgoto put_func;\n\n\treturn 0;\n\nput_func:\n\tusb_put_function(f_msg);\n\treturn ret;\n}\n\nstatic struct usb_configuration msg_config_driver = {\n\t.label\t\t\t= \"Linux File-Backed Storage\",\n\t.bConfigurationValue\t= 1,\n\t.bmAttributes\t\t= USB_CONFIG_ATT_SELFPOWER,\n};\n\n\n \n\nstatic int msg_bind(struct usb_composite_dev *cdev)\n{\n\tstruct fsg_opts *opts;\n\tstruct fsg_config config;\n\tint status;\n\n\tfi_msg = usb_get_function_instance(\"mass_storage\");\n\tif (IS_ERR(fi_msg))\n\t\treturn PTR_ERR(fi_msg);\n\n\tfsg_config_from_params(&config, &mod_data, fsg_num_buffers);\n\topts = fsg_opts_from_func_inst(fi_msg);\n\n\topts->no_configfs = true;\n\tstatus = fsg_common_set_num_buffers(opts->common, fsg_num_buffers);\n\tif (status)\n\t\tgoto fail;\n\n\tstatus = fsg_common_set_cdev(opts->common, cdev, config.can_stall);\n\tif (status)\n\t\tgoto fail_set_cdev;\n\n\tfsg_common_set_sysfs(opts->common, true);\n\tstatus = fsg_common_create_luns(opts->common, &config);\n\tif (status)\n\t\tgoto fail_set_cdev;\n\n\tfsg_common_set_inquiry_string(opts->common, config.vendor_name,\n\t\t\t\t      config.product_name);\n\n\tstatus = usb_string_ids_tab(cdev, strings_dev);\n\tif (status < 0)\n\t\tgoto fail_string_ids;\n\tmsg_device_desc.iProduct = strings_dev[USB_GADGET_PRODUCT_IDX].id;\n\n\tif (gadget_is_otg(cdev->gadget) && !otg_desc[0]) {\n\t\tstruct usb_descriptor_header *usb_desc;\n\n\t\tusb_desc = usb_otg_descriptor_alloc(cdev->gadget);\n\t\tif (!usb_desc) {\n\t\t\tstatus = -ENOMEM;\n\t\t\tgoto fail_string_ids;\n\t\t}\n\t\tusb_otg_descriptor_init(cdev->gadget, usb_desc);\n\t\totg_desc[0] = usb_desc;\n\t\totg_desc[1] = NULL;\n\t}\n\n\tstatus = usb_add_config(cdev, &msg_config_driver, msg_do_config);\n\tif (status < 0)\n\t\tgoto fail_otg_desc;\n\n\tusb_composite_overwrite_options(cdev, &coverwrite);\n\tdev_info(&cdev->gadget->dev,\n\t\t DRIVER_DESC \", version: \" DRIVER_VERSION \"\\n\");\n\treturn 0;\n\nfail_otg_desc:\n\tkfree(otg_desc[0]);\n\totg_desc[0] = NULL;\nfail_string_ids:\n\tfsg_common_remove_luns(opts->common);\nfail_set_cdev:\n\tfsg_common_free_buffers(opts->common);\nfail:\n\tusb_put_function_instance(fi_msg);\n\treturn status;\n}\n\nstatic int msg_unbind(struct usb_composite_dev *cdev)\n{\n\tif (!IS_ERR(f_msg))\n\t\tusb_put_function(f_msg);\n\n\tif (!IS_ERR(fi_msg))\n\t\tusb_put_function_instance(fi_msg);\n\n\tkfree(otg_desc[0]);\n\totg_desc[0] = NULL;\n\n\treturn 0;\n}\n\n \n\nstatic struct usb_composite_driver msg_driver = {\n\t.name\t\t= \"g_mass_storage\",\n\t.dev\t\t= &msg_device_desc,\n\t.max_speed\t= USB_SPEED_SUPER_PLUS,\n\t.needs_serial\t= 1,\n\t.strings\t= dev_strings,\n\t.bind\t\t= msg_bind,\n\t.unbind\t\t= msg_unbind,\n};\n\nmodule_usb_composite_driver(msg_driver);\n\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_AUTHOR(\"Michal Nazarewicz\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}