{
  "module_name": "webcam.c",
  "hash_id": "82cf56eb6f10bbc13d427543c64a20baa9943a520c62d06b2a8b24e0c767dc4d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/gadget/legacy/webcam.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/usb/video.h>\n\n#include \"u_uvc.h\"\n#include \"uvc_configfs.h\"\n\nUSB_GADGET_COMPOSITE_OPTIONS();\n\n \n\n \nstatic unsigned int streaming_interval = 1;\nmodule_param(streaming_interval, uint, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(streaming_interval, \"1 - 16\");\n\nstatic unsigned int streaming_maxpacket = 1024;\nmodule_param(streaming_maxpacket, uint, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(streaming_maxpacket, \"1 - 1023 (FS), 1 - 3072 (hs/ss)\");\n\nstatic unsigned int streaming_maxburst;\nmodule_param(streaming_maxburst, uint, S_IRUGO|S_IWUSR);\nMODULE_PARM_DESC(streaming_maxburst, \"0 - 15 (ss only)\");\n\n \n\n#define WEBCAM_VENDOR_ID\t\t0x1d6b\t \n#define WEBCAM_PRODUCT_ID\t\t0x0102\t \n#define WEBCAM_DEVICE_BCD\t\t0x0010\t \n\nstatic char webcam_vendor_label[] = \"Linux Foundation\";\nstatic char webcam_product_label[] = \"Webcam gadget\";\nstatic char webcam_config_label[] = \"Video\";\n\n \n\n#define STRING_DESCRIPTION_IDX\t\tUSB_GADGET_FIRST_AVAIL_IDX\n\nstatic struct usb_string webcam_strings[] = {\n\t[USB_GADGET_MANUFACTURER_IDX].s = webcam_vendor_label,\n\t[USB_GADGET_PRODUCT_IDX].s = webcam_product_label,\n\t[USB_GADGET_SERIAL_IDX].s = \"\",\n\t[STRING_DESCRIPTION_IDX].s = webcam_config_label,\n\t{  }\n};\n\nstatic struct usb_gadget_strings webcam_stringtab = {\n\t.language = 0x0409,\t \n\t.strings = webcam_strings,\n};\n\nstatic struct usb_gadget_strings *webcam_device_strings[] = {\n\t&webcam_stringtab,\n\tNULL,\n};\n\nstatic struct usb_function_instance *fi_uvc;\nstatic struct usb_function *f_uvc;\n\nstatic struct usb_device_descriptor webcam_device_descriptor = {\n\t.bLength\t\t= USB_DT_DEVICE_SIZE,\n\t.bDescriptorType\t= USB_DT_DEVICE,\n\t \n\t.bDeviceClass\t\t= USB_CLASS_MISC,\n\t.bDeviceSubClass\t= 0x02,\n\t.bDeviceProtocol\t= 0x01,\n\t.bMaxPacketSize0\t= 0,  \n\t.idVendor\t\t= cpu_to_le16(WEBCAM_VENDOR_ID),\n\t.idProduct\t\t= cpu_to_le16(WEBCAM_PRODUCT_ID),\n\t.bcdDevice\t\t= cpu_to_le16(WEBCAM_DEVICE_BCD),\n\t.iManufacturer\t\t= 0,  \n\t.iProduct\t\t= 0,  \n\t.iSerialNumber\t\t= 0,  \n\t.bNumConfigurations\t= 0,  \n};\n\nstatic const struct UVC_HEADER_DESCRIPTOR(1) uvc_control_header = {\n\t.bLength\t\t= UVC_DT_HEADER_SIZE(1),\n\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t.bDescriptorSubType\t= UVC_VC_HEADER,\n\t.bcdUVC\t\t\t= cpu_to_le16(0x0110),\n\t.wTotalLength\t\t= 0,  \n\t.dwClockFrequency\t= cpu_to_le32(48000000),\n\t.bInCollection\t\t= 0,  \n\t.baInterfaceNr[0]\t= 0,  \n};\n\nstatic const struct uvc_camera_terminal_descriptor uvc_camera_terminal = {\n\t.bLength\t\t= UVC_DT_CAMERA_TERMINAL_SIZE(3),\n\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t.bDescriptorSubType\t= UVC_VC_INPUT_TERMINAL,\n\t.bTerminalID\t\t= 1,\n\t.wTerminalType\t\t= cpu_to_le16(0x0201),\n\t.bAssocTerminal\t\t= 0,\n\t.iTerminal\t\t= 0,\n\t.wObjectiveFocalLengthMin\t= cpu_to_le16(0),\n\t.wObjectiveFocalLengthMax\t= cpu_to_le16(0),\n\t.wOcularFocalLength\t\t= cpu_to_le16(0),\n\t.bControlSize\t\t= 3,\n\t.bmControls[0]\t\t= 2,\n\t.bmControls[1]\t\t= 0,\n\t.bmControls[2]\t\t= 0,\n};\n\nstatic const struct uvc_processing_unit_descriptor uvc_processing = {\n\t.bLength\t\t= UVC_DT_PROCESSING_UNIT_SIZE(2),\n\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t.bDescriptorSubType\t= UVC_VC_PROCESSING_UNIT,\n\t.bUnitID\t\t= 2,\n\t.bSourceID\t\t= 1,\n\t.wMaxMultiplier\t\t= cpu_to_le16(16*1024),\n\t.bControlSize\t\t= 2,\n\t.bmControls[0]\t\t= 1,\n\t.bmControls[1]\t\t= 0,\n\t.iProcessing\t\t= 0,\n\t.bmVideoStandards\t= 0,\n};\n\nstatic const struct uvc_output_terminal_descriptor uvc_output_terminal = {\n\t.bLength\t\t= UVC_DT_OUTPUT_TERMINAL_SIZE,\n\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t.bDescriptorSubType\t= UVC_VC_OUTPUT_TERMINAL,\n\t.bTerminalID\t\t= 3,\n\t.wTerminalType\t\t= cpu_to_le16(0x0101),\n\t.bAssocTerminal\t\t= 0,\n\t.bSourceID\t\t= 2,\n\t.iTerminal\t\t= 0,\n};\n\nDECLARE_UVC_INPUT_HEADER_DESCRIPTOR(1, 2);\n\nstatic const struct UVC_INPUT_HEADER_DESCRIPTOR(1, 2) uvc_input_header = {\n\t.bLength\t\t= UVC_DT_INPUT_HEADER_SIZE(1, 2),\n\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t.bDescriptorSubType\t= UVC_VS_INPUT_HEADER,\n\t.bNumFormats\t\t= 2,\n\t.wTotalLength\t\t= 0,  \n\t.bEndpointAddress\t= 0,  \n\t.bmInfo\t\t\t= 0,\n\t.bTerminalLink\t\t= 3,\n\t.bStillCaptureMethod\t= 0,\n\t.bTriggerSupport\t= 0,\n\t.bTriggerUsage\t\t= 0,\n\t.bControlSize\t\t= 1,\n\t.bmaControls[0][0]\t= 0,\n\t.bmaControls[1][0]\t= 4,\n};\n\nstatic const struct uvcg_color_matching uvcg_color_matching = {\n\t.desc = {\n\t\t.bLength\t\t= UVC_DT_COLOR_MATCHING_SIZE,\n\t\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t\t.bDescriptorSubType\t= UVC_VS_COLORFORMAT,\n\t\t.bColorPrimaries\t= 1,\n\t\t.bTransferCharacteristics\t= 1,\n\t\t.bMatrixCoefficients\t= 4,\n\t},\n};\n\nstatic struct uvcg_uncompressed uvcg_format_yuv = {\n\t.fmt = {\n\t\t.type\t\t\t= UVCG_UNCOMPRESSED,\n\t\t \n\t\t.color_matching\t\t= (struct uvcg_color_matching *)&uvcg_color_matching,\n\t},\n\t.desc = {\n\t\t.bLength\t\t= UVC_DT_FORMAT_UNCOMPRESSED_SIZE,\n\t\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t\t.bDescriptorSubType\t= UVC_VS_FORMAT_UNCOMPRESSED,\n\t\t.bFormatIndex\t\t= 1,\n\t\t.bNumFrameDescriptors\t= 2,\n\t\t.guidFormat\t\t= {\n\t\t\t'Y',  'U',  'Y',  '2', 0x00, 0x00, 0x10, 0x00,\n\t\t\t 0x80, 0x00, 0x00, 0xaa, 0x00, 0x38, 0x9b, 0x71\n\t\t},\n\t\t.bBitsPerPixel\t\t= 16,\n\t\t.bDefaultFrameIndex\t= 1,\n\t\t.bAspectRatioX\t\t= 0,\n\t\t.bAspectRatioY\t\t= 0,\n\t\t.bmInterlaceFlags\t= 0,\n\t\t.bCopyProtect\t\t= 0,\n\t},\n};\n\nstatic struct uvcg_format_ptr uvcg_format_ptr_yuv = {\n\t.fmt = &uvcg_format_yuv.fmt,\n};\n\nDECLARE_UVC_FRAME_UNCOMPRESSED(1);\nDECLARE_UVC_FRAME_UNCOMPRESSED(3);\n\n#define UVCG_WIDTH_360P\t\t\t640\n#define UVCG_HEIGHT_360P\t\t360\n#define UVCG_MIN_BITRATE_360P\t\t18432000\n#define UVCG_MAX_BITRATE_360P\t\t55296000\n#define UVCG_MAX_VIDEO_FB_SZ_360P\t460800\n#define UVCG_FRM_INTERV_0_360P\t\t666666\n#define UVCG_FRM_INTERV_1_360P\t\t1000000\n#define UVCG_FRM_INTERV_2_360P\t\t5000000\n#define UVCG_DEFAULT_FRM_INTERV_360P\tUVCG_FRM_INTERV_0_360P\n\nstatic const struct UVC_FRAME_UNCOMPRESSED(3) uvc_frame_yuv_360p = {\n\t.bLength\t\t= UVC_DT_FRAME_UNCOMPRESSED_SIZE(3),\n\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t.bDescriptorSubType\t= UVC_VS_FRAME_UNCOMPRESSED,\n\t.bFrameIndex\t\t= 1,\n\t.bmCapabilities\t\t= 0,\n\t.wWidth\t\t\t= cpu_to_le16(UVCG_WIDTH_360P),\n\t.wHeight\t\t= cpu_to_le16(UVCG_HEIGHT_360P),\n\t.dwMinBitRate\t\t= cpu_to_le32(UVCG_MIN_BITRATE_360P),\n\t.dwMaxBitRate\t\t= cpu_to_le32(UVCG_MAX_BITRATE_360P),\n\t.dwMaxVideoFrameBufferSize\t= cpu_to_le32(UVCG_MAX_VIDEO_FB_SZ_360P),\n\t.dwDefaultFrameInterval\t= cpu_to_le32(UVCG_DEFAULT_FRM_INTERV_360P),\n\t.bFrameIntervalType\t= 3,\n\t.dwFrameInterval[0]\t= cpu_to_le32(UVCG_FRM_INTERV_0_360P),\n\t.dwFrameInterval[1]\t= cpu_to_le32(UVCG_FRM_INTERV_1_360P),\n\t.dwFrameInterval[2]\t= cpu_to_le32(UVCG_FRM_INTERV_2_360P),\n};\n\nstatic u32 uvcg_frame_yuv_360p_dw_frame_interval[] = {\n\t[0] = UVCG_FRM_INTERV_0_360P,\n\t[1] = UVCG_FRM_INTERV_1_360P,\n\t[2] = UVCG_FRM_INTERV_2_360P,\n};\n\nstatic const struct uvcg_frame uvcg_frame_yuv_360p = {\n\t.fmt_type\t\t= UVCG_UNCOMPRESSED,\n\t.frame = {\n\t\t.b_length\t\t\t= UVC_DT_FRAME_UNCOMPRESSED_SIZE(3),\n\t\t.b_descriptor_type\t\t= USB_DT_CS_INTERFACE,\n\t\t.b_descriptor_subtype\t\t= UVC_VS_FRAME_UNCOMPRESSED,\n\t\t.b_frame_index\t\t\t= 1,\n\t\t.bm_capabilities\t\t= 0,\n\t\t.w_width\t\t\t= UVCG_WIDTH_360P,\n\t\t.w_height\t\t\t= UVCG_HEIGHT_360P,\n\t\t.dw_min_bit_rate\t\t= UVCG_MIN_BITRATE_360P,\n\t\t.dw_max_bit_rate\t\t= UVCG_MAX_BITRATE_360P,\n\t\t.dw_max_video_frame_buffer_size\t= UVCG_MAX_VIDEO_FB_SZ_360P,\n\t\t.dw_default_frame_interval\t= UVCG_DEFAULT_FRM_INTERV_360P,\n\t\t.b_frame_interval_type\t\t= 3,\n\t},\n\t.dw_frame_interval\t= uvcg_frame_yuv_360p_dw_frame_interval,\n};\n\nstatic struct uvcg_frame_ptr uvcg_frame_ptr_yuv_360p = {\n\t.frm = (struct uvcg_frame *)&uvcg_frame_yuv_360p,\n};\n#define UVCG_WIDTH_720P\t\t\t1280\n#define UVCG_HEIGHT_720P\t\t720\n#define UVCG_MIN_BITRATE_720P\t\t29491200\n#define UVCG_MAX_BITRATE_720P\t\t29491200\n#define UVCG_MAX_VIDEO_FB_SZ_720P\t1843200\n#define UVCG_FRM_INTERV_0_720P\t\t5000000\n#define UVCG_DEFAULT_FRM_INTERV_720P\tUVCG_FRM_INTERV_0_720P\n\nstatic const struct UVC_FRAME_UNCOMPRESSED(1) uvc_frame_yuv_720p = {\n\t.bLength\t\t= UVC_DT_FRAME_UNCOMPRESSED_SIZE(1),\n\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t.bDescriptorSubType\t= UVC_VS_FRAME_UNCOMPRESSED,\n\t.bFrameIndex\t\t= 2,\n\t.bmCapabilities\t\t= 0,\n\t.wWidth\t\t\t= cpu_to_le16(UVCG_WIDTH_720P),\n\t.wHeight\t\t= cpu_to_le16(UVCG_HEIGHT_720P),\n\t.dwMinBitRate\t\t= cpu_to_le32(UVCG_MIN_BITRATE_720P),\n\t.dwMaxBitRate\t\t= cpu_to_le32(UVCG_MAX_BITRATE_720P),\n\t.dwMaxVideoFrameBufferSize\t= cpu_to_le32(UVCG_MAX_VIDEO_FB_SZ_720P),\n\t.dwDefaultFrameInterval\t= cpu_to_le32(UVCG_DEFAULT_FRM_INTERV_720P),\n\t.bFrameIntervalType\t= 1,\n\t.dwFrameInterval[0]\t= cpu_to_le32(UVCG_FRM_INTERV_0_720P),\n};\n\nstatic u32 uvcg_frame_yuv_720p_dw_frame_interval[] = {\n\t[0] = UVCG_FRM_INTERV_0_720P,\n};\n\nstatic const struct uvcg_frame uvcg_frame_yuv_720p = {\n\t.fmt_type\t\t= UVCG_UNCOMPRESSED,\n\t.frame = {\n\t\t.b_length\t\t\t= UVC_DT_FRAME_UNCOMPRESSED_SIZE(1),\n\t\t.b_descriptor_type\t\t= USB_DT_CS_INTERFACE,\n\t\t.b_descriptor_subtype\t\t= UVC_VS_FRAME_UNCOMPRESSED,\n\t\t.b_frame_index\t\t\t= 2,\n\t\t.bm_capabilities\t\t= 0,\n\t\t.w_width\t\t\t= UVCG_WIDTH_720P,\n\t\t.w_height\t\t\t= UVCG_HEIGHT_720P,\n\t\t.dw_min_bit_rate\t\t= UVCG_MIN_BITRATE_720P,\n\t\t.dw_max_bit_rate\t\t= UVCG_MAX_BITRATE_720P,\n\t\t.dw_max_video_frame_buffer_size\t= UVCG_MAX_VIDEO_FB_SZ_720P,\n\t\t.dw_default_frame_interval\t= UVCG_DEFAULT_FRM_INTERV_720P,\n\t\t.b_frame_interval_type\t\t= 1,\n\t},\n\t.dw_frame_interval\t= uvcg_frame_yuv_720p_dw_frame_interval,\n};\n\nstatic struct uvcg_frame_ptr uvcg_frame_ptr_yuv_720p = {\n\t.frm = (struct uvcg_frame *)&uvcg_frame_yuv_720p,\n};\n\nstatic struct uvcg_mjpeg uvcg_format_mjpeg = {\n\t.fmt = {\n\t\t.type\t\t\t= UVCG_MJPEG,\n\t\t \n\t\t.color_matching\t\t= (struct uvcg_color_matching *)&uvcg_color_matching,\n\t},\n\t.desc = {\n\t\t.bLength\t\t= UVC_DT_FORMAT_MJPEG_SIZE,\n\t\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t\t.bDescriptorSubType\t= UVC_VS_FORMAT_MJPEG,\n\t\t.bFormatIndex\t\t= 2,\n\t\t.bNumFrameDescriptors\t= 2,\n\t\t.bmFlags\t\t= 0,\n\t\t.bDefaultFrameIndex\t= 1,\n\t\t.bAspectRatioX\t\t= 0,\n\t\t.bAspectRatioY\t\t= 0,\n\t\t.bmInterlaceFlags\t= 0,\n\t\t.bCopyProtect\t\t= 0,\n\t},\n};\n\nstatic struct uvcg_format_ptr uvcg_format_ptr_mjpeg = {\n\t.fmt = &uvcg_format_mjpeg.fmt,\n};\n\nDECLARE_UVC_FRAME_MJPEG(1);\nDECLARE_UVC_FRAME_MJPEG(3);\n\nstatic const struct UVC_FRAME_MJPEG(3) uvc_frame_mjpg_360p = {\n\t.bLength\t\t= UVC_DT_FRAME_MJPEG_SIZE(3),\n\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t.bDescriptorSubType\t= UVC_VS_FRAME_MJPEG,\n\t.bFrameIndex\t\t= 1,\n\t.bmCapabilities\t\t= 0,\n\t.wWidth\t\t\t= cpu_to_le16(UVCG_WIDTH_360P),\n\t.wHeight\t\t= cpu_to_le16(UVCG_HEIGHT_360P),\n\t.dwMinBitRate\t\t= cpu_to_le32(UVCG_MIN_BITRATE_360P),\n\t.dwMaxBitRate\t\t= cpu_to_le32(UVCG_MAX_BITRATE_360P),\n\t.dwMaxVideoFrameBufferSize\t= cpu_to_le32(UVCG_MAX_VIDEO_FB_SZ_360P),\n\t.dwDefaultFrameInterval\t= cpu_to_le32(UVCG_DEFAULT_FRM_INTERV_360P),\n\t.bFrameIntervalType\t= 3,\n\t.dwFrameInterval[0]\t= cpu_to_le32(UVCG_FRM_INTERV_0_360P),\n\t.dwFrameInterval[1]\t= cpu_to_le32(UVCG_FRM_INTERV_1_360P),\n\t.dwFrameInterval[2]\t= cpu_to_le32(UVCG_FRM_INTERV_2_360P),\n};\n\nstatic u32 uvcg_frame_mjpeg_360p_dw_frame_interval[] = {\n\t[0] = UVCG_FRM_INTERV_0_360P,\n\t[1] = UVCG_FRM_INTERV_1_360P,\n\t[2] = UVCG_FRM_INTERV_2_360P,\n};\n\nstatic const struct uvcg_frame uvcg_frame_mjpeg_360p = {\n\t.fmt_type\t\t= UVCG_MJPEG,\n\t.frame = {\n\t\t.b_length\t\t\t= UVC_DT_FRAME_MJPEG_SIZE(3),\n\t\t.b_descriptor_type\t\t= USB_DT_CS_INTERFACE,\n\t\t.b_descriptor_subtype\t\t= UVC_VS_FRAME_MJPEG,\n\t\t.b_frame_index\t\t\t= 1,\n\t\t.bm_capabilities\t\t= 0,\n\t\t.w_width\t\t\t= UVCG_WIDTH_360P,\n\t\t.w_height\t\t\t= UVCG_HEIGHT_360P,\n\t\t.dw_min_bit_rate\t\t= UVCG_MIN_BITRATE_360P,\n\t\t.dw_max_bit_rate\t\t= UVCG_MAX_BITRATE_360P,\n\t\t.dw_max_video_frame_buffer_size\t= UVCG_MAX_VIDEO_FB_SZ_360P,\n\t\t.dw_default_frame_interval\t= UVCG_DEFAULT_FRM_INTERV_360P,\n\t\t.b_frame_interval_type\t\t= 3,\n\t},\n\t.dw_frame_interval\t= uvcg_frame_mjpeg_360p_dw_frame_interval,\n};\n\nstatic struct uvcg_frame_ptr uvcg_frame_ptr_mjpeg_360p = {\n\t.frm = (struct uvcg_frame *)&uvcg_frame_mjpeg_360p,\n};\n\nstatic const struct UVC_FRAME_MJPEG(1) uvc_frame_mjpg_720p = {\n\t.bLength\t\t= UVC_DT_FRAME_MJPEG_SIZE(1),\n\t.bDescriptorType\t= USB_DT_CS_INTERFACE,\n\t.bDescriptorSubType\t= UVC_VS_FRAME_MJPEG,\n\t.bFrameIndex\t\t= 2,\n\t.bmCapabilities\t\t= 0,\n\t.wWidth\t\t\t= cpu_to_le16(UVCG_WIDTH_720P),\n\t.wHeight\t\t= cpu_to_le16(UVCG_HEIGHT_720P),\n\t.dwMinBitRate\t\t= cpu_to_le32(UVCG_MIN_BITRATE_720P),\n\t.dwMaxBitRate\t\t= cpu_to_le32(UVCG_MAX_BITRATE_720P),\n\t.dwMaxVideoFrameBufferSize\t= cpu_to_le32(UVCG_MAX_VIDEO_FB_SZ_720P),\n\t.dwDefaultFrameInterval\t= cpu_to_le32(UVCG_DEFAULT_FRM_INTERV_720P),\n\t.bFrameIntervalType\t= 1,\n\t.dwFrameInterval[0]\t= cpu_to_le32(UVCG_FRM_INTERV_0_720P),\n};\n\nstatic u32 uvcg_frame_mjpeg_720p_dw_frame_interval[] = {\n\t[0] = UVCG_FRM_INTERV_0_720P,\n};\n\nstatic const struct uvcg_frame uvcg_frame_mjpeg_720p = {\n\t.fmt_type\t\t= UVCG_MJPEG,\n\t.frame = {\n\t\t.b_length\t\t\t= UVC_DT_FRAME_MJPEG_SIZE(1),\n\t\t.b_descriptor_type\t\t= USB_DT_CS_INTERFACE,\n\t\t.b_descriptor_subtype\t\t= UVC_VS_FRAME_MJPEG,\n\t\t.b_frame_index\t\t\t= 2,\n\t\t.bm_capabilities\t\t= 0,\n\t\t.w_width\t\t\t= UVCG_WIDTH_720P,\n\t\t.w_height\t\t\t= UVCG_HEIGHT_720P,\n\t\t.dw_min_bit_rate\t\t= UVCG_MIN_BITRATE_720P,\n\t\t.dw_max_bit_rate\t\t= UVCG_MAX_BITRATE_720P,\n\t\t.dw_max_video_frame_buffer_size\t= UVCG_MAX_VIDEO_FB_SZ_720P,\n\t\t.dw_default_frame_interval\t= UVCG_DEFAULT_FRM_INTERV_720P,\n\t\t.b_frame_interval_type\t\t= 1,\n\t},\n\t.dw_frame_interval\t= uvcg_frame_mjpeg_720p_dw_frame_interval,\n};\n\nstatic struct uvcg_frame_ptr uvcg_frame_ptr_mjpeg_720p = {\n\t.frm = (struct uvcg_frame *)&uvcg_frame_mjpeg_720p,\n};\n\nstatic struct uvcg_streaming_header uvcg_streaming_header = {\n};\n\nstatic const struct uvc_descriptor_header * const uvc_fs_control_cls[] = {\n\t(const struct uvc_descriptor_header *) &uvc_control_header,\n\t(const struct uvc_descriptor_header *) &uvc_camera_terminal,\n\t(const struct uvc_descriptor_header *) &uvc_processing,\n\t(const struct uvc_descriptor_header *) &uvc_output_terminal,\n\tNULL,\n};\n\nstatic const struct uvc_descriptor_header * const uvc_ss_control_cls[] = {\n\t(const struct uvc_descriptor_header *) &uvc_control_header,\n\t(const struct uvc_descriptor_header *) &uvc_camera_terminal,\n\t(const struct uvc_descriptor_header *) &uvc_processing,\n\t(const struct uvc_descriptor_header *) &uvc_output_terminal,\n\tNULL,\n};\n\nstatic const struct uvc_descriptor_header * const uvc_fs_streaming_cls[] = {\n\t(const struct uvc_descriptor_header *) &uvc_input_header,\n\t(const struct uvc_descriptor_header *) &uvcg_format_yuv.desc,\n\t(const struct uvc_descriptor_header *) &uvc_frame_yuv_360p,\n\t(const struct uvc_descriptor_header *) &uvc_frame_yuv_720p,\n\t(const struct uvc_descriptor_header *) &uvcg_color_matching.desc,\n\t(const struct uvc_descriptor_header *) &uvcg_format_mjpeg.desc,\n\t(const struct uvc_descriptor_header *) &uvc_frame_mjpg_360p,\n\t(const struct uvc_descriptor_header *) &uvc_frame_mjpg_720p,\n\t(const struct uvc_descriptor_header *) &uvcg_color_matching.desc,\n\tNULL,\n};\n\nstatic const struct uvc_descriptor_header * const uvc_hs_streaming_cls[] = {\n\t(const struct uvc_descriptor_header *) &uvc_input_header,\n\t(const struct uvc_descriptor_header *) &uvcg_format_yuv.desc,\n\t(const struct uvc_descriptor_header *) &uvc_frame_yuv_360p,\n\t(const struct uvc_descriptor_header *) &uvc_frame_yuv_720p,\n\t(const struct uvc_descriptor_header *) &uvcg_color_matching.desc,\n\t(const struct uvc_descriptor_header *) &uvcg_format_mjpeg.desc,\n\t(const struct uvc_descriptor_header *) &uvc_frame_mjpg_360p,\n\t(const struct uvc_descriptor_header *) &uvc_frame_mjpg_720p,\n\t(const struct uvc_descriptor_header *) &uvcg_color_matching.desc,\n\tNULL,\n};\n\nstatic const struct uvc_descriptor_header * const uvc_ss_streaming_cls[] = {\n\t(const struct uvc_descriptor_header *) &uvc_input_header,\n\t(const struct uvc_descriptor_header *) &uvcg_format_yuv.desc,\n\t(const struct uvc_descriptor_header *) &uvc_frame_yuv_360p,\n\t(const struct uvc_descriptor_header *) &uvc_frame_yuv_720p,\n\t(const struct uvc_descriptor_header *) &uvcg_color_matching.desc,\n\t(const struct uvc_descriptor_header *) &uvcg_format_mjpeg.desc,\n\t(const struct uvc_descriptor_header *) &uvc_frame_mjpg_360p,\n\t(const struct uvc_descriptor_header *) &uvc_frame_mjpg_720p,\n\t(const struct uvc_descriptor_header *) &uvcg_color_matching.desc,\n\tNULL,\n};\n\n \n\nstatic int\nwebcam_config_bind(struct usb_configuration *c)\n{\n\tint status = 0;\n\n\tf_uvc = usb_get_function(fi_uvc);\n\tif (IS_ERR(f_uvc))\n\t\treturn PTR_ERR(f_uvc);\n\n\tstatus = usb_add_function(c, f_uvc);\n\tif (status < 0)\n\t\tusb_put_function(f_uvc);\n\n\treturn status;\n}\n\nstatic struct usb_configuration webcam_config_driver = {\n\t.label\t\t\t= webcam_config_label,\n\t.bConfigurationValue\t= 1,\n\t.iConfiguration\t\t= 0,  \n\t.bmAttributes\t\t= USB_CONFIG_ATT_SELFPOWER,\n\t.MaxPower\t\t= CONFIG_USB_GADGET_VBUS_DRAW,\n};\n\nstatic int\nwebcam_unbind(struct usb_composite_dev *cdev)\n{\n\tif (!IS_ERR_OR_NULL(f_uvc))\n\t\tusb_put_function(f_uvc);\n\tif (!IS_ERR_OR_NULL(fi_uvc))\n\t\tusb_put_function_instance(fi_uvc);\n\treturn 0;\n}\n\nstatic int\nwebcam_bind(struct usb_composite_dev *cdev)\n{\n\tstruct f_uvc_opts *uvc_opts;\n\tint ret;\n\n\tfi_uvc = usb_get_function_instance(\"uvc\");\n\tif (IS_ERR(fi_uvc))\n\t\treturn PTR_ERR(fi_uvc);\n\n\tuvc_opts = container_of(fi_uvc, struct f_uvc_opts, func_inst);\n\n\tuvc_opts->streaming_interval = streaming_interval;\n\tuvc_opts->streaming_maxpacket = streaming_maxpacket;\n\tuvc_opts->streaming_maxburst = streaming_maxburst;\n\n\tuvc_opts->fs_control = uvc_fs_control_cls;\n\tuvc_opts->ss_control = uvc_ss_control_cls;\n\tuvc_opts->fs_streaming = uvc_fs_streaming_cls;\n\tuvc_opts->hs_streaming = uvc_hs_streaming_cls;\n\tuvc_opts->ss_streaming = uvc_ss_streaming_cls;\n\n\tINIT_LIST_HEAD(&uvcg_format_yuv.fmt.frames);\n\tlist_add_tail(&uvcg_frame_ptr_yuv_360p.entry, &uvcg_format_yuv.fmt.frames);\n\tlist_add_tail(&uvcg_frame_ptr_yuv_720p.entry, &uvcg_format_yuv.fmt.frames);\n\tuvcg_format_yuv.fmt.num_frames = 2;\n\n\tINIT_LIST_HEAD(&uvcg_format_mjpeg.fmt.frames);\n\tlist_add_tail(&uvcg_frame_ptr_mjpeg_360p.entry, &uvcg_format_mjpeg.fmt.frames);\n\tlist_add_tail(&uvcg_frame_ptr_mjpeg_720p.entry, &uvcg_format_mjpeg.fmt.frames);\n\tuvcg_format_mjpeg.fmt.num_frames = 2;\n\n\tINIT_LIST_HEAD(&uvcg_streaming_header.formats);\n\tlist_add_tail(&uvcg_format_ptr_yuv.entry, &uvcg_streaming_header.formats);\n\tlist_add_tail(&uvcg_format_ptr_mjpeg.entry, &uvcg_streaming_header.formats);\n\tuvcg_streaming_header.num_fmt = 2;\n\n\tuvc_opts->header = &uvcg_streaming_header;\n\n\t \n\tret = usb_string_ids_tab(cdev, webcam_strings);\n\tif (ret < 0)\n\t\tgoto error;\n\twebcam_device_descriptor.iManufacturer =\n\t\twebcam_strings[USB_GADGET_MANUFACTURER_IDX].id;\n\twebcam_device_descriptor.iProduct =\n\t\twebcam_strings[USB_GADGET_PRODUCT_IDX].id;\n\twebcam_config_driver.iConfiguration =\n\t\twebcam_strings[STRING_DESCRIPTION_IDX].id;\n\n\t \n\tif ((ret = usb_add_config(cdev, &webcam_config_driver,\n\t\t\t\t\twebcam_config_bind)) < 0)\n\t\tgoto error;\n\n\tusb_composite_overwrite_options(cdev, &coverwrite);\n\tINFO(cdev, \"Webcam Video Gadget\\n\");\n\treturn 0;\n\nerror:\n\tusb_put_function_instance(fi_uvc);\n\treturn ret;\n}\n\n \n\nstatic struct usb_composite_driver webcam_driver = {\n\t.name\t\t= \"g_webcam\",\n\t.dev\t\t= &webcam_device_descriptor,\n\t.strings\t= webcam_device_strings,\n\t.max_speed\t= USB_SPEED_SUPER,\n\t.bind\t\t= webcam_bind,\n\t.unbind\t\t= webcam_unbind,\n};\n\nmodule_usb_composite_driver(webcam_driver);\n\nMODULE_AUTHOR(\"Laurent Pinchart\");\nMODULE_DESCRIPTION(\"Webcam Video Gadget\");\nMODULE_LICENSE(\"GPL\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}