{
  "module_name": "fsl_qe_udc.h",
  "hash_id": "98d9456bde771652bba564c58acfd03f273db413d2c48c9a27b51d2e22637c5d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/gadget/udc/fsl_qe_udc.h",
  "human_readable_source": "\n \n\n#ifndef __FSL_QE_UDC_H\n#define __FSL_QE_UDC_H\n\n \n#define PORT_CPM\t0\n#define PORT_QE\t\t1\n\n#define USB_MAX_ENDPOINTS               4\n#define USB_MAX_PIPES                   USB_MAX_ENDPOINTS\n#define USB_EP0_MAX_SIZE\t\t64\n#define USB_MAX_CTRL_PAYLOAD            0x4000\n#define USB_BDRING_LEN\t\t\t16\n#define USB_BDRING_LEN_RX\t\t256\n#define USB_BDRING_LEN_TX\t\t16\n#define MIN_EMPTY_BDS\t\t\t128\n#define MAX_DATA_BDS\t\t\t8\n#define USB_CRC_SIZE\t\t\t2\n#define USB_DIR_BOTH\t\t\t0x88\n#define R_BUF_MAXSIZE\t\t\t0x800\n#define USB_EP_PARA_ALIGNMENT\t\t32\n\n \n#define USB_MODE_EN\t\t0x01\n#define USB_MODE_HOST\t\t0x02\n#define USB_MODE_TEST\t\t0x04\n#define USB_MODE_SFTE\t\t0x08\n#define USB_MODE_RESUME\t\t0x40\n#define USB_MODE_LSS\t\t0x80\n\n \n#define USB_SLVADDR_MASK\t0x7F\n\n \n#define USB_EPNUM_MASK\t\t0xF000\n#define USB_EPNUM_SHIFT\t\t12\n\n#define USB_TRANS_MODE_SHIFT\t8\n#define USB_TRANS_CTR\t\t0x0000\n#define USB_TRANS_INT\t\t0x0100\n#define USB_TRANS_BULK\t\t0x0200\n#define USB_TRANS_ISO\t\t0x0300\n\n#define USB_EP_MF\t\t0x0020\n#define USB_EP_RTE\t\t0x0010\n\n#define USB_THS_SHIFT\t\t2\n#define USB_THS_MASK\t\t0x000c\n#define USB_THS_NORMAL\t\t0x0\n#define USB_THS_IGNORE_IN\t0x0004\n#define USB_THS_NACK\t\t0x0008\n#define USB_THS_STALL\t\t0x000c\n\n#define USB_RHS_SHIFT   \t0\n#define USB_RHS_MASK\t\t0x0003\n#define USB_RHS_NORMAL  \t0x0\n#define USB_RHS_IGNORE_OUT\t0x0001\n#define USB_RHS_NACK\t\t0x0002\n#define USB_RHS_STALL\t\t0x0003\n\n#define USB_RTHS_MASK\t\t0x000f\n\n \n#define USB_CMD_STR_FIFO\t0x80\n#define USB_CMD_FLUSH_FIFO\t0x40\n#define USB_CMD_ISFT\t\t0x20\n#define USB_CMD_DSFT\t\t0x10\n#define USB_CMD_EP_MASK\t\t0x03\n\n \n#define USB_E_MSF_MASK\t\t0x0800\n#define USB_E_SFT_MASK\t\t0x0400\n#define USB_E_RESET_MASK\t0x0200\n#define USB_E_IDLE_MASK\t\t0x0100\n#define USB_E_TXE4_MASK\t\t0x0080\n#define USB_E_TXE3_MASK\t\t0x0040\n#define USB_E_TXE2_MASK\t\t0x0020\n#define USB_E_TXE1_MASK\t\t0x0010\n#define USB_E_SOF_MASK\t\t0x0008\n#define USB_E_BSY_MASK\t\t0x0004\n#define USB_E_TXB_MASK\t\t0x0002\n#define USB_E_RXB_MASK\t\t0x0001\n#define USBER_ALL_CLEAR \t0x0fff\n\n#define USB_E_DEFAULT_DEVICE   (USB_E_RESET_MASK | USB_E_TXE4_MASK | \\\n\t\t\t\tUSB_E_TXE3_MASK | USB_E_TXE2_MASK | \\\n\t\t\t\tUSB_E_TXE1_MASK | USB_E_BSY_MASK | \\\n\t\t\t\tUSB_E_TXB_MASK | USB_E_RXB_MASK)\n\n#define USB_E_TXE_MASK         (USB_E_TXE4_MASK | USB_E_TXE3_MASK|\\\n\t\t\t\t USB_E_TXE2_MASK | USB_E_TXE1_MASK)\n \n#define USB_IDLE_STATUS_MASK\t0x01\n\n \n#define USB_USSFT_MASK\t\t0x3FFF\n\n \n#define USB_USFRN_MASK\t\t0xFFFF\n\nstruct usb_device_para{\n\tu16\tepptr[4];\n\tu32\trstate;\n\tu32\trptr;\n\tu16\tframe_n;\n\tu16\trbcnt;\n\tu32\trtemp;\n\tu32\trxusb_data;\n\tu16\trxuptr;\n\tu8\treso[2];\n\tu32\tsoftbl;\n\tu8\tsofucrctemp;\n};\n\nstruct usb_ep_para{\n\tu16\trbase;\n\tu16\ttbase;\n\tu8\trbmr;\n\tu8\ttbmr;\n\tu16\tmrblr;\n\tu16\trbptr;\n\tu16\ttbptr;\n\tu32\ttstate;\n\tu32\ttptr;\n\tu16\ttcrc;\n\tu16\ttbcnt;\n\tu32\tttemp;\n\tu16\ttxusbu_ptr;\n\tu8\treserve[2];\n};\n\n#define USB_BUSMODE_GBL\t\t0x20\n#define USB_BUSMODE_BO_MASK\t0x18\n#define USB_BUSMODE_BO_SHIFT\t0x3\n#define USB_BUSMODE_BE\t\t0x2\n#define USB_BUSMODE_CETM\t0x04\n#define USB_BUSMODE_DTB\t\t0x02\n\n \n#define ep_index(EP)\t\t((EP)->ep.desc->bEndpointAddress & 0xF)\n#define ep_maxpacket(EP)\t((EP)->ep.maxpacket)\n#define ep_is_in(EP)\t((ep_index(EP) == 0) ? (EP->udc->ep0_dir == \\\n\t\t\tUSB_DIR_IN) : ((EP)->ep.desc->bEndpointAddress \\\n\t\t\t& USB_DIR_IN) == USB_DIR_IN)\n\n \n#define WAIT_FOR_SETUP          0\n#define DATA_STATE_XMIT         1\n#define DATA_STATE_NEED_ZLP     2\n#define WAIT_FOR_OUT_STATUS     3\n#define DATA_STATE_RECV         4\n\n \n#define USBP_TM_CTL\t0\n#define USBP_TM_ISO\t1\n#define USBP_TM_BULK\t2\n#define USBP_TM_INT\t3\n\n \nstruct qe_frame{\n\tu8 *data;\n\tu32 len;\n\tu32 status;\n\tu32 info;\n\n\tvoid *privdata;\n\tstruct list_head node;\n};\n\n \n#define PID_DATA0              0x80000000  \n#define PID_DATA1              0x40000000  \n#define PID_SETUP              0x20000000  \n#define SETUP_STATUS           0x10000000  \n#define SETADDR_STATUS         0x08000000  \n#define NO_REQ                 0x04000000  \n#define HOST_DATA              0x02000000  \n#define FIRST_PACKET_IN_FRAME  0x01000000  \n#define TOKEN_FRAME            0x00800000  \n#define ZLP                    0x00400000  \n#define IN_TOKEN_FRAME         0x00200000  \n#define OUT_TOKEN_FRAME        0x00100000  \n#define SETUP_TOKEN_FRAME      0x00080000  \n#define STALL_FRAME            0x00040000  \n#define NACK_FRAME             0x00020000  \n#define NO_PID                 0x00010000  \n#define NO_CRC                 0x00008000  \n#define HOST_COMMAND           0x00004000  \n\n \n \n#define FRAME_OK               0x00000000  \n#define FRAME_ERROR            0x80000000  \n#define START_FRAME_LOST       0x40000000  \n#define END_FRAME_LOST         0x20000000  \n#define RX_ER_NONOCT           0x10000000  \n#define RX_ER_BITSTUFF         0x08000000  \n#define RX_ER_CRC              0x04000000  \n#define RX_ER_OVERUN           0x02000000  \n#define RX_ER_PID              0x01000000  \n \n#define TX_ER_NAK              0x00800000  \n#define TX_ER_STALL            0x00400000  \n#define TX_ER_TIMEOUT          0x00200000  \n#define TX_ER_UNDERUN          0x00100000  \n#define FRAME_INPROGRESS       0x00080000  \n#define ER_DATA_UNDERUN        0x00040000  \n#define ER_DATA_OVERUN         0x00020000  \n\n \n#define frame_get_length(frm) (frm->len)\n#define frame_set_length(frm, leng) (frm->len = leng)\n#define frame_get_data(frm) (frm->data)\n#define frame_set_data(frm, dat) (frm->data = dat)\n#define frame_get_info(frm) (frm->info)\n#define frame_set_info(frm, inf) (frm->info = inf)\n#define frame_get_status(frm) (frm->status)\n#define frame_set_status(frm, stat) (frm->status = stat)\n#define frame_get_privdata(frm) (frm->privdata)\n#define frame_set_privdata(frm, dat) (frm->privdata = dat)\n\nstatic inline void qe_frame_clean(struct qe_frame *frm)\n{\n\tframe_set_data(frm, NULL);\n\tframe_set_length(frm, 0);\n\tframe_set_status(frm, FRAME_OK);\n\tframe_set_info(frm, 0);\n\tframe_set_privdata(frm, NULL);\n}\n\nstatic inline void qe_frame_init(struct qe_frame *frm)\n{\n\tqe_frame_clean(frm);\n\tINIT_LIST_HEAD(&(frm->node));\n}\n\nstruct qe_req {\n\tstruct usb_request req;\n\tstruct list_head queue;\n\t \n\tstruct qe_ep *ep;\n\tunsigned mapped:1;\n};\n\nstruct qe_ep {\n\tstruct usb_ep ep;\n\tstruct list_head queue;\n\tstruct qe_udc *udc;\n\tstruct usb_gadget *gadget;\n\n\tu8 state;\n\n\tstruct qe_bd __iomem *rxbase;\n\tstruct qe_bd __iomem *n_rxbd;\n\tstruct qe_bd __iomem *e_rxbd;\n\n\tstruct qe_bd __iomem *txbase;\n\tstruct qe_bd __iomem *n_txbd;\n\tstruct qe_bd __iomem *c_txbd;\n\n\tstruct qe_frame *rxframe;\n\tu8 *rxbuffer;\n\tdma_addr_t rxbuf_d;\n\tu8 rxbufmap;\n\tunsigned char localnack;\n\tint has_data;\n\n\tstruct qe_frame *txframe;\n\tstruct qe_req *tx_req;\n\tint sent;   \n\tint last;   \n\n\tu8 dir;\n\tu8 epnum;\n\tu8 tm;  \n\tu8 data01;\n\tu8 init;\n\n\tu8 already_seen;\n\tu8 enable_tasklet;\n\tu8 setup_stage;\n\tu32 last_io;             \n\n\tchar name[14];\n\n\tunsigned double_buf:1;\n\tunsigned stopped:1;\n\tunsigned fnf:1;\n\tunsigned has_dma:1;\n\n\tu8 ackwait;\n\tu8 dma_channel;\n\tu16 dma_counter;\n\tint lch;\n\n\tstruct timer_list timer;\n};\n\nstruct qe_udc {\n\tstruct usb_gadget gadget;\n\tstruct usb_gadget_driver *driver;\n\tstruct device *dev;\n\tstruct qe_ep eps[USB_MAX_ENDPOINTS];\n\tstruct usb_ctrlrequest local_setup_buff;\n\tspinlock_t lock;\t \n\tunsigned long soc_type;\t\t \n\n\tstruct qe_req *status_req;\t \n\n\t \n\tstruct usb_device_para __iomem *usb_param;\n\tstruct usb_ep_para __iomem *ep_param[4];\n\n\tu32 max_pipes;           \n\tu32 max_use_endpts;      \n\tu32 bus_reset;           \n\tu32 resume_state;        \n\tu32 usb_state;           \n\tu32 usb_next_state;      \n\tu32 ep0_state;           \n\tu32 ep0_dir;             \n\tu32 usb_sof_count;       \n\tu32 errors;              \n\n\tu8 *tmpbuf;\n\tu32 c_start;\n\tu32 c_end;\n\n\tu8 *nullbuf;\n\tu8 *statusbuf;\n\tdma_addr_t nullp;\n\tu8 nullmap;\n\tu8 device_address;\t \n\n\tunsigned int usb_clock;\n\tunsigned int usb_irq;\n\tstruct usb_ctlr __iomem *usb_regs;\n\n\tstruct tasklet_struct rx_tasklet;\n\n\tstruct completion *done;\t \n};\n\n#define EP_STATE_IDLE\t0\n#define EP_STATE_NACK\t1\n#define EP_STATE_STALL\t2\n\n \n#define T_R           0x80000000          \n#define T_W           0x20000000          \n#define T_I           0x10000000          \n#define T_L           0x08000000          \n#define T_TC          0x04000000          \n#define T_CNF         0x02000000          \n#define T_LSP         0x01000000          \n#define T_PID         0x00c00000          \n#define T_NAK         0x00100000          \n#define T_STAL        0x00080000          \n#define T_TO          0x00040000          \n#define T_UN          0x00020000          \n\n#define DEVICE_T_ERROR    (T_UN | T_TO)\n#define HOST_T_ERROR      (T_UN | T_TO | T_NAK | T_STAL)\n#define DEVICE_T_BD_MASK  DEVICE_T_ERROR\n#define HOST_T_BD_MASK    HOST_T_ERROR\n\n#define T_PID_SHIFT   6\n#define T_PID_DATA0   0x00800000          \n#define T_PID_DATA1   0x00c00000          \n\n \n#define R_E           0x80000000          \n#define R_W           0x20000000          \n#define R_I           0x10000000          \n#define R_L           0x08000000          \n#define R_F           0x04000000          \n#define R_PID         0x00c00000          \n#define R_NO          0x00100000          \n#define R_AB          0x00080000          \n#define R_CR          0x00040000          \n#define R_OV          0x00020000          \n\n#define R_ERROR       (R_NO | R_AB | R_CR | R_OV)\n#define R_BD_MASK     R_ERROR\n\n#define R_PID_DATA0   0x00000000\n#define R_PID_DATA1   0x00400000\n#define R_PID_SETUP   0x00800000\n\n#define CPM_USB_STOP_TX 0x2e600000\n#define CPM_USB_RESTART_TX 0x2e600000\n#define CPM_USB_STOP_TX_OPCODE 0x0a\n#define CPM_USB_RESTART_TX_OPCODE 0x0b\n#define CPM_USB_EP_SHIFT 5\n\n#endif   \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}