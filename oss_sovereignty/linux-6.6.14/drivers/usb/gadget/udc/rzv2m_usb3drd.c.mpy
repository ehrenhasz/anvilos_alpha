{
  "module_name": "rzv2m_usb3drd.c",
  "hash_id": "38831f4c17de7a1642bd09ad921a47247697011f323e058b709c7c511e4c397b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/gadget/udc/rzv2m_usb3drd.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <linux/reset.h>\n#include <linux/usb/rzv2m_usb3drd.h>\n\n#define USB_PERI_DRD_CON\t0x000\n\n#define USB_PERI_DRD_CON_PERI_RST\tBIT(31)\n#define USB_PERI_DRD_CON_HOST_RST\tBIT(30)\n#define USB_PERI_DRD_CON_PERI_CON\tBIT(24)\n\nstatic void rzv2m_usb3drd_set_bit(struct rzv2m_usb3drd *usb3, u32 bits,\n\t\t\t\t  u32 offs)\n{\n\tu32 val = readl(usb3->reg + offs);\n\n\tval |= bits;\n\twritel(val, usb3->reg + offs);\n}\n\nstatic void rzv2m_usb3drd_clear_bit(struct rzv2m_usb3drd *usb3, u32 bits,\n\t\t\t\t    u32 offs)\n{\n\tu32 val = readl(usb3->reg + offs);\n\n\tval &= ~bits;\n\twritel(val, usb3->reg + offs);\n}\n\nvoid rzv2m_usb3drd_reset(struct device *dev, bool host)\n{\n\tstruct rzv2m_usb3drd *usb3 = dev_get_drvdata(dev);\n\n\tif (host) {\n\t\trzv2m_usb3drd_clear_bit(usb3, USB_PERI_DRD_CON_PERI_CON,\n\t\t\t\t\tUSB_PERI_DRD_CON);\n\t\trzv2m_usb3drd_clear_bit(usb3, USB_PERI_DRD_CON_HOST_RST,\n\t\t\t\t\tUSB_PERI_DRD_CON);\n\t\trzv2m_usb3drd_set_bit(usb3, USB_PERI_DRD_CON_PERI_RST,\n\t\t\t\t      USB_PERI_DRD_CON);\n\t} else {\n\t\trzv2m_usb3drd_set_bit(usb3, USB_PERI_DRD_CON_PERI_CON,\n\t\t\t\t      USB_PERI_DRD_CON);\n\t\trzv2m_usb3drd_set_bit(usb3, USB_PERI_DRD_CON_HOST_RST,\n\t\t\t\t      USB_PERI_DRD_CON);\n\t\trzv2m_usb3drd_clear_bit(usb3, USB_PERI_DRD_CON_PERI_RST,\n\t\t\t\t\tUSB_PERI_DRD_CON);\n\t}\n}\nEXPORT_SYMBOL_GPL(rzv2m_usb3drd_reset);\n\nstatic void rzv2m_usb3drd_remove(struct platform_device *pdev)\n{\n\tstruct rzv2m_usb3drd *usb3 = platform_get_drvdata(pdev);\n\n\tof_platform_depopulate(usb3->dev);\n\tpm_runtime_put(usb3->dev);\n\tpm_runtime_disable(&pdev->dev);\n\treset_control_assert(usb3->drd_rstc);\n}\n\nstatic int rzv2m_usb3drd_probe(struct platform_device *pdev)\n{\n\tstruct rzv2m_usb3drd *usb3;\n\tint ret;\n\n\tusb3 = devm_kzalloc(&pdev->dev, sizeof(*usb3), GFP_KERNEL);\n\tif (!usb3)\n\t\treturn -ENOMEM;\n\n\tusb3->dev = &pdev->dev;\n\n\tusb3->drd_irq = platform_get_irq_byname(pdev, \"drd\");\n\tif (usb3->drd_irq < 0)\n\t\treturn usb3->drd_irq;\n\n\tusb3->reg = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(usb3->reg))\n\t\treturn PTR_ERR(usb3->reg);\n\n\tplatform_set_drvdata(pdev, usb3);\n\n\tusb3->drd_rstc = devm_reset_control_get_exclusive(&pdev->dev, NULL);\n\tif (IS_ERR(usb3->drd_rstc))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(usb3->drd_rstc),\n\t\t\t\t     \"failed to get drd reset\");\n\n\treset_control_deassert(usb3->drd_rstc);\n\tpm_runtime_enable(&pdev->dev);\n\tret = pm_runtime_resume_and_get(usb3->dev);\n\tif (ret)\n\t\tgoto err_rst;\n\n\tret = of_platform_populate(usb3->dev->of_node, NULL, NULL, usb3->dev);\n\tif (ret)\n\t\tgoto err_pm;\n\n\treturn 0;\n\nerr_pm:\n\tpm_runtime_put(usb3->dev);\n\nerr_rst:\n\tpm_runtime_disable(&pdev->dev);\n\treset_control_assert(usb3->drd_rstc);\n\treturn ret;\n}\n\nstatic const struct of_device_id rzv2m_usb3drd_of_match[] = {\n\t{ .compatible = \"renesas,rzv2m-usb3drd\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, rzv2m_usb3drd_of_match);\n\nstatic struct platform_driver rzv2m_usb3drd_driver = {\n\t.driver = {\n\t\t.name = \"rzv2m-usb3drd\",\n\t\t.of_match_table = rzv2m_usb3drd_of_match,\n\t},\n\t.probe = rzv2m_usb3drd_probe,\n\t.remove_new = rzv2m_usb3drd_remove,\n};\nmodule_platform_driver(rzv2m_usb3drd_driver);\n\nMODULE_AUTHOR(\"Biju Das <biju.das.jz@bp.renesas.com>\");\nMODULE_DESCRIPTION(\"Renesas RZ/V2M USB3DRD driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:rzv2m_usb3drd\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}