{
  "module_name": "vhub.h",
  "hash_id": "0110944f37b0a1b0c2d64a85f0ad7bb1eb07d4bf9b363c1d1c94d45ad3b5c4b6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/gadget/udc/aspeed-vhub/vhub.h",
  "human_readable_source": " \n#ifndef __ASPEED_VHUB_H\n#define __ASPEED_VHUB_H\n\n#include <linux/usb.h>\n#include <linux/usb/ch11.h>\n\n \n\n#define\tAST_VHUB_CTRL\t\t0x00\t \n#define\tAST_VHUB_CONF\t\t0x04\t \n#define\tAST_VHUB_IER\t\t0x08\t \n#define\tAST_VHUB_ISR\t\t0x0C\t \n#define\tAST_VHUB_EP_ACK_IER\t0x10\t \n#define\tAST_VHUB_EP_NACK_IER\t0x14\t \n#define AST_VHUB_EP_ACK_ISR\t0x18\t \n#define AST_VHUB_EP_NACK_ISR\t0x1C\t \n#define AST_VHUB_SW_RESET\t0x20\t \n#define AST_VHUB_USBSTS\t\t0x24\t \n#define AST_VHUB_EP_TOGGLE\t0x28\t \n#define AST_VHUB_ISO_FAIL_ACC\t0x2C\t \n#define AST_VHUB_EP0_CTRL\t0x30\t \n#define AST_VHUB_EP0_DATA\t0x34\t \n#define AST_VHUB_EP1_CTRL\t0x38\t \n#define AST_VHUB_EP1_STS_CHG\t0x3C\t \n#define AST_VHUB_SETUP0\t\t0x80\t \n#define AST_VHUB_SETUP1\t\t0x84\t \n\n \n#define VHUB_CTRL_PHY_CLK\t\t\t(1 << 31)\n#define VHUB_CTRL_PHY_LOOP_TEST\t\t\t(1 << 25)\n#define VHUB_CTRL_DN_PWN\t\t\t(1 << 24)\n#define VHUB_CTRL_DP_PWN\t\t\t(1 << 23)\n#define VHUB_CTRL_LONG_DESC\t\t\t(1 << 18)\n#define VHUB_CTRL_ISO_RSP_CTRL\t\t\t(1 << 17)\n#define VHUB_CTRL_SPLIT_IN\t\t\t(1 << 16)\n#define VHUB_CTRL_LOOP_T_RESULT\t\t\t(1 << 15)\n#define VHUB_CTRL_LOOP_T_STS\t\t\t(1 << 14)\n#define VHUB_CTRL_PHY_BIST_RESULT\t\t(1 << 13)\n#define VHUB_CTRL_PHY_BIST_CTRL\t\t\t(1 << 12)\n#define VHUB_CTRL_PHY_RESET_DIS\t\t\t(1 << 11)\n#define VHUB_CTRL_SET_TEST_MODE(x)\t\t((x) << 8)\n#define VHUB_CTRL_MANUAL_REMOTE_WAKEUP\t\t(1 << 4)\n#define VHUB_CTRL_AUTO_REMOTE_WAKEUP\t\t(1 << 3)\n#define VHUB_CTRL_CLK_STOP_SUSPEND\t\t(1 << 2)\n#define VHUB_CTRL_FULL_SPEED_ONLY\t\t(1 << 1)\n#define VHUB_CTRL_UPSTREAM_CONNECT\t\t(1 << 0)\n\n \n#define VHUB_IRQ_DEV1_BIT\t\t\t9\n#define VHUB_IRQ_USB_CMD_DEADLOCK\t\t(1 << 18)\n#define VHUB_IRQ_EP_POOL_NAK\t\t\t(1 << 17)\n#define VHUB_IRQ_EP_POOL_ACK_STALL\t\t(1 << 16)\n#define VHUB_IRQ_DEVICE1\t\t\t(1 << (VHUB_IRQ_DEV1_BIT))\n#define VHUB_IRQ_BUS_RESUME\t\t\t(1 << 8)\n#define VHUB_IRQ_BUS_SUSPEND \t\t\t(1 << 7)\n#define VHUB_IRQ_BUS_RESET \t\t\t(1 << 6)\n#define VHUB_IRQ_HUB_EP1_IN_DATA_ACK\t\t(1 << 5)\n#define VHUB_IRQ_HUB_EP0_IN_DATA_NAK\t\t(1 << 4)\n#define VHUB_IRQ_HUB_EP0_IN_ACK_STALL\t\t(1 << 3)\n#define VHUB_IRQ_HUB_EP0_OUT_NAK\t\t(1 << 2)\n#define VHUB_IRQ_HUB_EP0_OUT_ACK_STALL\t\t(1 << 1)\n#define VHUB_IRQ_HUB_EP0_SETUP\t\t\t(1 << 0)\n#define VHUB_IRQ_ACK_ALL\t\t\t0x1ff\n\n \n#define VHUB_DEV_IRQ(n)\t\t\t\t(VHUB_IRQ_DEVICE1 << (n))\n\n \n#define VHUB_SW_RESET_EP_POOL\t\t\t(1 << 9)\n#define VHUB_SW_RESET_DMA_CONTROLLER\t\t(1 << 8)\n#define VHUB_SW_RESET_DEVICE5\t\t\t(1 << 5)\n#define VHUB_SW_RESET_DEVICE4\t\t\t(1 << 4)\n#define VHUB_SW_RESET_DEVICE3\t\t\t(1 << 3)\n#define VHUB_SW_RESET_DEVICE2\t\t\t(1 << 2)\n#define VHUB_SW_RESET_DEVICE1\t\t\t(1 << 1)\n#define VHUB_SW_RESET_ROOT_HUB\t\t\t(1 << 0)\n\n \n#define VHUB_EP_IRQ(n)\t\t\t\t(1 << (n))\n\n \n#define VHUB_USBSTS_HISPEED\t\t\t(1 << 27)\n\n \n#define VHUB_EP_TOGGLE_VALUE\t\t\t(1 << 8)\n#define VHUB_EP_TOGGLE_SET_EPNUM(x)\t\t((x) & 0x1f)\n\n \n#define VHUB_EP0_CTRL_STALL\t\t\t(1 << 0)\n#define VHUB_EP0_TX_BUFF_RDY\t\t\t(1 << 1)\n#define VHUB_EP0_RX_BUFF_RDY\t\t\t(1 << 2)\n#define VHUB_EP0_RX_LEN(x)\t\t\t(((x) >> 16) & 0x7f)\n#define VHUB_EP0_SET_TX_LEN(x)\t\t\t(((x) & 0x7f) << 8)\n\n \n#define VHUB_EP1_CTRL_RESET_TOGGLE\t\t(1 << 2)\n#define VHUB_EP1_CTRL_STALL\t\t\t(1 << 1)\n#define VHUB_EP1_CTRL_ENABLE\t\t\t(1 << 0)\n\n \n#define AST_VHUB_DEV_EN_CTRL\t\t0x00\n#define AST_VHUB_DEV_ISR\t\t0x04\n#define AST_VHUB_DEV_EP0_CTRL\t\t0x08\n#define AST_VHUB_DEV_EP0_DATA\t\t0x0c\n\n \n#define VHUB_DEV_EN_SET_ADDR(x)\t\t\t((x) << 8)\n#define VHUB_DEV_EN_ADDR_MASK\t\t\t((0xff) << 8)\n#define VHUB_DEV_EN_EP0_NAK_IRQEN\t\t(1 << 6)\n#define VHUB_DEV_EN_EP0_IN_ACK_IRQEN\t\t(1 << 5)\n#define VHUB_DEV_EN_EP0_OUT_NAK_IRQEN\t\t(1 << 4)\n#define VHUB_DEV_EN_EP0_OUT_ACK_IRQEN\t\t(1 << 3)\n#define VHUB_DEV_EN_EP0_SETUP_IRQEN\t\t(1 << 2)\n#define VHUB_DEV_EN_SPEED_SEL_HIGH\t\t(1 << 1)\n#define VHUB_DEV_EN_ENABLE_PORT\t\t\t(1 << 0)\n\n \n#define VHUV_DEV_IRQ_EP0_IN_DATA_NACK\t\t(1 << 4)\n#define VHUV_DEV_IRQ_EP0_IN_ACK_STALL\t\t(1 << 3)\n#define VHUV_DEV_IRQ_EP0_OUT_DATA_NACK\t\t(1 << 2)\n#define VHUV_DEV_IRQ_EP0_OUT_ACK_STALL\t\t(1 << 1)\n#define VHUV_DEV_IRQ_EP0_SETUP\t\t\t(1 << 0)\n\n \n#define VHUB_DEV_EP0_CTRL_STALL\t\t\tVHUB_EP0_CTRL_STALL\n#define VHUB_DEV_EP0_TX_BUFF_RDY\t\tVHUB_EP0_TX_BUFF_RDY\n#define VHUB_DEV_EP0_RX_BUFF_RDY\t\tVHUB_EP0_RX_BUFF_RDY\n#define VHUB_DEV_EP0_RX_LEN(x)\t\t\tVHUB_EP0_RX_LEN(x)\n#define VHUB_DEV_EP0_SET_TX_LEN(x)\t\tVHUB_EP0_SET_TX_LEN(x)\n\n \n\n#define AST_VHUB_EP_CONFIG\t\t0x00\n#define AST_VHUB_EP_DMA_CTLSTAT\t\t0x04\n#define AST_VHUB_EP_DESC_BASE\t\t0x08\n#define AST_VHUB_EP_DESC_STATUS\t\t0x0C\n\n \n#define VHUB_EP_CFG_SET_MAX_PKT(x)\t(((x) & 0x3ff) << 16)\n#define VHUB_EP_CFG_AUTO_DATA_DISABLE\t(1 << 13)\n#define VHUB_EP_CFG_STALL_CTRL\t\t(1 << 12)\n#define VHUB_EP_CFG_SET_EP_NUM(x)\t(((x) & 0xf) << 8)\n#define VHUB_EP_CFG_SET_TYPE(x)\t\t((x) << 5)\n#define   EP_TYPE_OFF\t\t\t0\n#define   EP_TYPE_BULK\t\t\t1\n#define   EP_TYPE_INT\t\t\t2\n#define   EP_TYPE_ISO\t\t\t3\n#define VHUB_EP_CFG_DIR_OUT\t\t(1 << 4)\n#define VHUB_EP_CFG_SET_DEV(x)\t\t((x) << 1)\n#define VHUB_EP_CFG_ENABLE\t\t(1 << 0)\n\n \n#define VHUB_EP_DMA_PROC_STATUS(x)\t(((x) >> 4) & 0xf)\n#define   EP_DMA_PROC_RX_IDLE\t\t0\n#define   EP_DMA_PROC_TX_IDLE\t\t8\n#define VHUB_EP_DMA_IN_LONG_MODE\t(1 << 3)\n#define VHUB_EP_DMA_OUT_CONTIG_MODE\t(1 << 3)\n#define VHUB_EP_DMA_CTRL_RESET\t\t(1 << 2)\n#define VHUB_EP_DMA_SINGLE_STAGE\t(1 << 1)\n#define VHUB_EP_DMA_DESC_MODE\t\t(1 << 0)\n\n \n#define VHUB_EP_DMA_SET_TX_SIZE(x)\t((x) << 16)\n#define VHUB_EP_DMA_TX_SIZE(x)\t\t(((x) >> 16) & 0x7ff)\n#define VHUB_EP_DMA_RPTR(x)\t\t(((x) >> 8) & 0xff)\n#define VHUB_EP_DMA_SET_RPTR(x)\t\t(((x) & 0xff) << 8)\n#define VHUB_EP_DMA_SET_CPU_WPTR(x)\t(x)\n#define VHUB_EP_DMA_SINGLE_KICK\t\t(1 << 0)  \n\n \n\n \n#define VHUB_DSC1_IN_INTERRUPT\t\t(1 << 31)\n#define VHUB_DSC1_IN_SPID_DATA0\t\t(0 << 14)\n#define VHUB_DSC1_IN_SPID_DATA2\t\t(1 << 14)\n#define VHUB_DSC1_IN_SPID_DATA1\t\t(2 << 14)\n#define VHUB_DSC1_IN_SPID_MDATA\t\t(3 << 14)\n#define VHUB_DSC1_IN_SET_LEN(x)\t\t((x) & 0xfff)\n#define VHUB_DSC1_IN_LEN(x)\t\t((x) & 0xfff)\n\n \n\n \n#define AST_VHUB_NUM_GEN_EPs\t15\t \n#define AST_VHUB_NUM_PORTS\t5\t \n#define AST_VHUB_EP0_MAX_PACKET\t64\t \n#define AST_VHUB_EPn_MAX_PACKET\t1024\t \n#define AST_VHUB_DESCS_COUNT\t256\t \n\nstruct ast_vhub;\nstruct ast_vhub_dev;\n\n \nstruct ast_vhub_desc {\n\t__le32\tw0;\n\t__le32\tw1;\n};\n\n \nstruct ast_vhub_req {\n\tstruct usb_request\treq;\n\tstruct list_head\tqueue;\n\n\t \n\tunsigned int\t\tact_count;\n\n\t \n\tint\t\t\tlast_desc;\n\n\t \n\tbool\t\t\tactive  : 1;\n\n\t \n\tbool\t\t\tinternal : 1;\n};\n#define to_ast_req(__ureq) container_of(__ureq, struct ast_vhub_req, req)\n\n \nenum ep0_state {\n\tep0_state_token,\n\tep0_state_data,\n\tep0_state_status,\n\tep0_state_stall,\n};\n\n \nstruct ast_vhub_ep {\n\tstruct usb_ep\t\tep;\n\n\t \n\tstruct list_head\tqueue;\n\n\t \n\tunsigned int\t\td_idx;\n\n\t \n\tstruct ast_vhub_dev\t*dev;\n\n\t \n\tstruct ast_vhub\t\t*vhub;\n\n\t \n\tvoid\t\t\t*buf;\n\tdma_addr_t\t\tbuf_dma;\n\n\t \n\tunion {\n\t\t \n\t\tstruct {\n\t\t\t \n\t\t\tvoid __iomem\t\t*ctlstat;\n\t\t\tvoid __iomem\t\t*setup;\n\n\t\t\t \n\t\t\tenum ep0_state\t\tstate;\n\t\t\tbool\t\t\tdir_in;\n\n\t\t\t \n\t\t\tstruct ast_vhub_req\treq;\n\t\t} ep0;\n\n\t\t \n\t\tstruct {\n\t\t\t \n\t\t\tvoid __iomem   \t\t*regs;\n\n\t\t\t \n\t\t\tunsigned int\t\tg_idx;\n\n\t\t\t \n\t\t\tstruct ast_vhub_desc\t*descs;\n\t\t\tdma_addr_t\t\tdescs_dma;\n\t\t\tunsigned int\t\td_next;\n\t\t\tunsigned int\t\td_last;\n\t\t\tunsigned int\t\tdma_conf;\n\n\t\t\t \n\t\t\tunsigned int\t\tchunk_max;\n\n\t\t\t \n\t\t\tbool\t\t\tis_in :  1;\n\t\t\tbool\t\t\tis_iso : 1;\n\t\t\tbool\t\t\tstalled : 1;\n\t\t\tbool\t\t\twedged : 1;\n\t\t\tbool\t\t\tenabled : 1;\n\t\t\tbool\t\t\tdesc_mode : 1;\n\t\t} epn;\n\t};\n};\n#define to_ast_ep(__uep) container_of(__uep, struct ast_vhub_ep, ep)\n\n \nstruct ast_vhub_dev {\n\tstruct ast_vhub\t\t\t*vhub;\n\tvoid __iomem\t\t\t*regs;\n\n\t \n\tunsigned int\t\t\tindex;\n\tconst char\t\t\t*name;\n\n\t \n\tstruct device\t\t\t*port_dev;\n\n\t \n\tstruct usb_gadget\t\tgadget;\n\tstruct usb_gadget_driver\t*driver;\n\tbool\t\t\t\tregistered : 1;\n\tbool\t\t\t\twakeup_en : 1;\n\tbool\t\t\t\tenabled : 1;\n\n\t \n\tstruct ast_vhub_ep\t\tep0;\n\tstruct ast_vhub_ep\t\t**epns;\n\tu32\t\t\t\tmax_epns;\n\n};\n#define to_ast_dev(__g) container_of(__g, struct ast_vhub_dev, gadget)\n\n \nstruct ast_vhub_port {\n\t \n\tu16\t\t\tstatus;\n\tu16\t\t\tchange;\n\n\t \n\tstruct ast_vhub_dev\tdev;\n};\n\nstruct ast_vhub_full_cdesc {\n\tstruct usb_config_descriptor\tcfg;\n\tstruct usb_interface_descriptor intf;\n\tstruct usb_endpoint_descriptor\tep;\n} __packed;\n\n \nstruct ast_vhub {\n\tstruct platform_device\t\t*pdev;\n\tvoid __iomem\t\t\t*regs;\n\tint\t\t\t\tirq;\n\tspinlock_t\t\t\tlock;\n\tstruct work_struct\t\twake_work;\n\tstruct clk\t\t\t*clk;\n\n\t \n\tvoid\t\t\t\t*ep0_bufs;\n\tdma_addr_t\t\t\tep0_bufs_dma;\n\n\t \n\tstruct ast_vhub_ep\t\tep0;\n\n\t \n\tbool\t\t\t\tep1_stalled : 1;\n\n\t \n\tstruct ast_vhub_port\t\t*ports;\n\tu32\t\t\t\tmax_ports;\n\tu32\t\t\t\tport_irq_mask;\n\n\t \n\tstruct ast_vhub_ep\t\t*epns;\n\tu32\t\t\t\tmax_epns;\n\n\t \n\tbool\t\t\t\tsuspended : 1;\n\n\t \n\tbool\t\t\t\twakeup_en : 1;\n\n\t \n\tbool\t\t\t\tforce_usb1 : 1;\n\n\t \n\tunsigned int\t\t\tspeed;\n\n\t \n\tstruct usb_device_descriptor\tvhub_dev_desc;\n\tstruct ast_vhub_full_cdesc\tvhub_conf_desc;\n\tstruct usb_hub_descriptor\tvhub_hub_desc;\n\tstruct list_head\t\tvhub_str_desc;\n\tstruct usb_qualifier_descriptor\tvhub_qual_desc;\n};\n\n \nenum std_req_rc {\n\tstd_req_stall = -1,\t \n\tstd_req_complete = 0,\t \n\tstd_req_data = 1,\t \n\tstd_req_driver = 2,\t \n};\n\n#ifdef CONFIG_USB_GADGET_VERBOSE\n#define UDCVDBG(u, fmt...)\tdev_dbg(&(u)->pdev->dev, fmt)\n\n#define EPVDBG(ep, fmt, ...)\tdo {\t\t\t\\\n\tdev_dbg(&(ep)->vhub->pdev->dev,\t\t\t\\\n\t\t\"%s:EP%d \" fmt,\t\t\t\t\\\n\t\t(ep)->dev ? (ep)->dev->name : \"hub\",\t\\\n\t\t(ep)->d_idx, ##__VA_ARGS__);\t\t\\\n\t} while(0)\n\n#define DVDBG(d, fmt, ...)\tdo {\t\t\t\\\n\tdev_dbg(&(d)->vhub->pdev->dev,\t\t\t\\\n\t\t\"%s \" fmt, (d)->name,\t\t\t\\\n\t\t##__VA_ARGS__);\t\t\t\t\\\n\t} while(0)\n\n#else\n#define UDCVDBG(u, fmt...)\tdo { } while(0)\n#define EPVDBG(ep, fmt, ...)\tdo { } while(0)\n#define DVDBG(d, fmt, ...)\tdo { } while(0)\n#endif\n\n#ifdef CONFIG_USB_GADGET_DEBUG\n#define UDCDBG(u, fmt...)\tdev_dbg(&(u)->pdev->dev, fmt)\n\n#define EPDBG(ep, fmt, ...)\tdo {\t\t\t\\\n\tdev_dbg(&(ep)->vhub->pdev->dev,\t\t\t\\\n\t\t\"%s:EP%d \" fmt,\t\t\t\t\\\n\t\t(ep)->dev ? (ep)->dev->name : \"hub\",\t\\\n\t\t(ep)->d_idx, ##__VA_ARGS__);\t\t\\\n\t} while(0)\n\n#define DDBG(d, fmt, ...)\tdo {\t\t\t\\\n\tdev_dbg(&(d)->vhub->pdev->dev,\t\t\t\\\n\t\t\"%s \" fmt, (d)->name,\t\t\t\\\n\t\t##__VA_ARGS__);\t\t\t\t\\\n\t} while(0)\n#else\n#define UDCDBG(u, fmt...)\tdo { } while(0)\n#define EPDBG(ep, fmt, ...)\tdo { } while(0)\n#define DDBG(d, fmt, ...)\tdo { } while(0)\n#endif\n\nstatic inline void vhub_dma_workaround(void *addr)\n{\n\t \n\tmb();\n\t(void)__raw_readl((void __iomem *)addr);\n}\n\n \nvoid ast_vhub_done(struct ast_vhub_ep *ep, struct ast_vhub_req *req,\n\t\t   int status);\nvoid ast_vhub_nuke(struct ast_vhub_ep *ep, int status);\nstruct usb_request *ast_vhub_alloc_request(struct usb_ep *u_ep,\n\t\t\t\t\t   gfp_t gfp_flags);\nvoid ast_vhub_free_request(struct usb_ep *u_ep, struct usb_request *u_req);\nvoid ast_vhub_init_hw(struct ast_vhub *vhub);\n\n \nvoid ast_vhub_ep0_handle_ack(struct ast_vhub_ep *ep, bool in_ack);\nvoid ast_vhub_ep0_handle_setup(struct ast_vhub_ep *ep);\nvoid ast_vhub_reset_ep0(struct ast_vhub_dev *dev);\nvoid ast_vhub_init_ep0(struct ast_vhub *vhub, struct ast_vhub_ep *ep,\n\t\t       struct ast_vhub_dev *dev);\nint ast_vhub_reply(struct ast_vhub_ep *ep, char *ptr, int len);\nint __ast_vhub_simple_reply(struct ast_vhub_ep *ep, int len, ...);\n#define ast_vhub_simple_reply(udc, ...)\t\t\t\t\t       \\\n\t__ast_vhub_simple_reply((udc),\t\t\t\t\t       \\\n\t\t\t       sizeof((u8[]) { __VA_ARGS__ })/sizeof(u8),      \\\n\t\t\t       __VA_ARGS__)\n\n \nint ast_vhub_init_hub(struct ast_vhub *vhub);\nenum std_req_rc ast_vhub_std_hub_request(struct ast_vhub_ep *ep,\n\t\t\t\t\t struct usb_ctrlrequest *crq);\nenum std_req_rc ast_vhub_class_hub_request(struct ast_vhub_ep *ep,\n\t\t\t\t\t   struct usb_ctrlrequest *crq);\nvoid ast_vhub_device_connect(struct ast_vhub *vhub, unsigned int port,\n\t\t\t     bool on);\nvoid ast_vhub_hub_suspend(struct ast_vhub *vhub);\nvoid ast_vhub_hub_resume(struct ast_vhub *vhub);\nvoid ast_vhub_hub_reset(struct ast_vhub *vhub);\nvoid ast_vhub_hub_wake_all(struct ast_vhub *vhub);\n\n \nint ast_vhub_init_dev(struct ast_vhub *vhub, unsigned int idx);\nvoid ast_vhub_del_dev(struct ast_vhub_dev *d);\nvoid ast_vhub_dev_irq(struct ast_vhub_dev *d);\nint ast_vhub_std_dev_request(struct ast_vhub_ep *ep,\n\t\t\t     struct usb_ctrlrequest *crq);\n\n \nvoid ast_vhub_epn_ack_irq(struct ast_vhub_ep *ep);\nvoid ast_vhub_update_epn_stall(struct ast_vhub_ep *ep);\nstruct ast_vhub_ep *ast_vhub_alloc_epn(struct ast_vhub_dev *d, u8 addr);\nvoid ast_vhub_dev_suspend(struct ast_vhub_dev *d);\nvoid ast_vhub_dev_resume(struct ast_vhub_dev *d);\nvoid ast_vhub_dev_reset(struct ast_vhub_dev *d);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}