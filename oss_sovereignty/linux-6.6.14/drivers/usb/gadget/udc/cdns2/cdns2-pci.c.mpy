{
  "module_name": "cdns2-pci.c",
  "hash_id": "6310db4666e3492bcc518d52e93769e769c3cc5127f359c9113d6499d39ad744",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/gadget/udc/cdns2/cdns2-pci.c",
  "human_readable_source": "\n \n\n#include <linux/pm_runtime.h>\n#include <linux/slab.h>\n#include <linux/pci.h>\n\n#include \"cdns2-gadget.h\"\n\n#define PCI_DRIVER_NAME\t\t\"cdns-pci-usbhs\"\n#define CDNS_VENDOR_ID\t\t0x17cd\n#define CDNS_DEVICE_ID\t\t0x0120\n#define PCI_BAR_DEV\t\t0\n#define PCI_DEV_FN_DEVICE\t0\n\nstatic int cdns2_pci_probe(struct pci_dev *pdev,\n\t\t\t   const struct pci_device_id *id)\n{\n\tresource_size_t rsrc_start, rsrc_len;\n\tstruct device *dev = &pdev->dev;\n\tstruct cdns2_device *priv_dev;\n\tstruct resource *res;\n\tint ret;\n\n\t \n\tif (!id || pdev->devfn != PCI_DEV_FN_DEVICE ||\n\t    pdev->class != PCI_CLASS_SERIAL_USB_DEVICE)\n\t\treturn -EINVAL;\n\n\tret = pcim_enable_device(pdev);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Enabling PCI device has failed %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tpci_set_master(pdev);\n\n\tpriv_dev = devm_kzalloc(&pdev->dev, sizeof(*priv_dev), GFP_KERNEL);\n\tif (!priv_dev)\n\t\treturn -ENOMEM;\n\n\tdev_dbg(dev, \"Initialize resources\\n\");\n\trsrc_start = pci_resource_start(pdev, PCI_BAR_DEV);\n\trsrc_len = pci_resource_len(pdev, PCI_BAR_DEV);\n\n\tres = devm_request_mem_region(dev, rsrc_start, rsrc_len, \"dev\");\n\tif (!res) {\n\t\tdev_dbg(dev, \"controller already in use\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tpriv_dev->regs = devm_ioremap(dev, rsrc_start, rsrc_len);\n\tif (!priv_dev->regs) {\n\t\tdev_dbg(dev, \"error mapping memory\\n\");\n\t\treturn -EFAULT;\n\t}\n\n\tpriv_dev->irq = pdev->irq;\n\tdev_dbg(dev, \"USBSS-DEV physical base addr: %pa\\n\",\n\t\t&rsrc_start);\n\n\tpriv_dev->dev = dev;\n\n\tpriv_dev->eps_supported = 0x000f000f;\n\tpriv_dev->onchip_tx_buf = 16;\n\tpriv_dev->onchip_rx_buf = 16;\n\n\tret = cdns2_gadget_init(priv_dev);\n\tif (ret)\n\t\treturn ret;\n\n\tpci_set_drvdata(pdev, priv_dev);\n\n\tdevice_wakeup_enable(&pdev->dev);\n\tif (pci_dev_run_wake(pdev))\n\t\tpm_runtime_put_noidle(&pdev->dev);\n\n\treturn 0;\n}\n\nstatic void cdns2_pci_remove(struct pci_dev *pdev)\n{\n\tstruct cdns2_device *priv_dev = pci_get_drvdata(pdev);\n\n\tif (pci_dev_run_wake(pdev))\n\t\tpm_runtime_get_noresume(&pdev->dev);\n\n\tcdns2_gadget_remove(priv_dev);\n}\n\nstatic int cdns2_pci_suspend(struct device *dev)\n{\n\tstruct cdns2_device *priv_dev = dev_get_drvdata(dev);\n\n\treturn cdns2_gadget_suspend(priv_dev);\n}\n\nstatic int cdns2_pci_resume(struct device *dev)\n{\n\tstruct cdns2_device *priv_dev = dev_get_drvdata(dev);\n\n\treturn cdns2_gadget_resume(priv_dev, 1);\n}\n\nstatic const struct dev_pm_ops cdns2_pci_pm_ops = {\n\tSYSTEM_SLEEP_PM_OPS(cdns2_pci_suspend, cdns2_pci_resume)\n};\n\nstatic const struct pci_device_id cdns2_pci_ids[] = {\n\t{ PCI_VENDOR_ID_CDNS, CDNS_DEVICE_ID, PCI_ANY_ID, PCI_ANY_ID,\n\t  PCI_CLASS_SERIAL_USB_DEVICE, PCI_ANY_ID },\n\t{ 0, }\n};\n\nstatic struct pci_driver cdns2_pci_driver = {\n\t.name = \"cdns2-pci\",\n\t.id_table = &cdns2_pci_ids[0],\n\t.probe = cdns2_pci_probe,\n\t.remove = cdns2_pci_remove,\n\t.driver = {\n\t\t.pm = pm_ptr(&cdns2_pci_pm_ops),\n\t}\n};\n\nmodule_pci_driver(cdns2_pci_driver);\nMODULE_DEVICE_TABLE(pci, cdns2_pci_ids);\n\nMODULE_ALIAS(\"pci:cdns2\");\nMODULE_AUTHOR(\"Pawel Laszczak <pawell@cadence.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"Cadence CDNS2 PCI driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}