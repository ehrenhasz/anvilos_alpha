{
  "module_name": "phy-am335x.c",
  "hash_id": "07cbb840c7da1a15a59c1cb2f7867cf23cad182402b7c649c456e766227ebbe9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/phy/phy-am335x.c",
  "human_readable_source": "\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/dma-mapping.h>\n#include <linux/usb/otg.h>\n#include <linux/usb/usb_phy_generic.h>\n#include <linux/slab.h>\n#include <linux/clk.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/usb/of.h>\n\n#include \"phy-am335x-control.h\"\n#include \"phy-generic.h\"\n\nstruct am335x_phy {\n\tstruct usb_phy_generic usb_phy_gen;\n\tstruct phy_control *phy_ctrl;\n\tint id;\n\tenum usb_dr_mode dr_mode;\n};\n\nstatic int am335x_init(struct usb_phy *phy)\n{\n\tstruct am335x_phy *am_phy = dev_get_drvdata(phy->dev);\n\n\tphy_ctrl_power(am_phy->phy_ctrl, am_phy->id, am_phy->dr_mode, true);\n\treturn 0;\n}\n\nstatic void am335x_shutdown(struct usb_phy *phy)\n{\n\tstruct am335x_phy *am_phy = dev_get_drvdata(phy->dev);\n\n\tphy_ctrl_power(am_phy->phy_ctrl, am_phy->id, am_phy->dr_mode, false);\n}\n\nstatic int am335x_phy_probe(struct platform_device *pdev)\n{\n\tstruct am335x_phy *am_phy;\n\tstruct device *dev = &pdev->dev;\n\tint ret;\n\n\tam_phy = devm_kzalloc(dev, sizeof(*am_phy), GFP_KERNEL);\n\tif (!am_phy)\n\t\treturn -ENOMEM;\n\n\tam_phy->phy_ctrl = am335x_get_phy_control(dev);\n\tif (!am_phy->phy_ctrl)\n\t\treturn -EPROBE_DEFER;\n\n\tam_phy->id = of_alias_get_id(pdev->dev.of_node, \"phy\");\n\tif (am_phy->id < 0) {\n\t\tdev_err(&pdev->dev, \"Missing PHY id: %d\\n\", am_phy->id);\n\t\treturn am_phy->id;\n\t}\n\n\tam_phy->dr_mode = of_usb_get_dr_mode_by_phy(pdev->dev.of_node, -1);\n\n\tret = usb_phy_gen_create_phy(dev, &am_phy->usb_phy_gen);\n\tif (ret)\n\t\treturn ret;\n\n\tam_phy->usb_phy_gen.phy.init = am335x_init;\n\tam_phy->usb_phy_gen.phy.shutdown = am335x_shutdown;\n\n\tplatform_set_drvdata(pdev, am_phy);\n\tdevice_init_wakeup(dev, true);\n\n\t \n\n\tdevice_set_wakeup_enable(dev, false);\n\tphy_ctrl_power(am_phy->phy_ctrl, am_phy->id, am_phy->dr_mode, false);\n\n\treturn usb_add_phy_dev(&am_phy->usb_phy_gen.phy);\n}\n\nstatic void am335x_phy_remove(struct platform_device *pdev)\n{\n\tstruct am335x_phy *am_phy = platform_get_drvdata(pdev);\n\n\tusb_remove_phy(&am_phy->usb_phy_gen.phy);\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int am335x_phy_suspend(struct device *dev)\n{\n\tstruct am335x_phy *am_phy = dev_get_drvdata(dev);\n\n\t \n\n\tif (device_may_wakeup(dev))\n\t\tphy_ctrl_wkup(am_phy->phy_ctrl, am_phy->id, true);\n\n\tphy_ctrl_power(am_phy->phy_ctrl, am_phy->id, am_phy->dr_mode, false);\n\n\treturn 0;\n}\n\nstatic int am335x_phy_resume(struct device *dev)\n{\n\tstruct am335x_phy\t*am_phy = dev_get_drvdata(dev);\n\n\tphy_ctrl_power(am_phy->phy_ctrl, am_phy->id, am_phy->dr_mode, true);\n\n\tif (device_may_wakeup(dev))\n\t\tphy_ctrl_wkup(am_phy->phy_ctrl, am_phy->id, false);\n\n\treturn 0;\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(am335x_pm_ops, am335x_phy_suspend, am335x_phy_resume);\n\nstatic const struct of_device_id am335x_phy_ids[] = {\n\t{ .compatible = \"ti,am335x-usb-phy\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, am335x_phy_ids);\n\nstatic struct platform_driver am335x_phy_driver = {\n\t.probe          = am335x_phy_probe,\n\t.remove_new     = am335x_phy_remove,\n\t.driver         = {\n\t\t.name   = \"am335x-phy-driver\",\n\t\t.pm = &am335x_pm_ops,\n\t\t.of_match_table = am335x_phy_ids,\n\t},\n};\n\nmodule_platform_driver(am335x_phy_driver);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}