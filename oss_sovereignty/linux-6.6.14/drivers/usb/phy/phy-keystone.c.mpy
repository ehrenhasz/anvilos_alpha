{
  "module_name": "phy-keystone.c",
  "hash_id": "791fa5bf973504eb55bffd34f446e42f6bffaaef07f63be3b3adf32fdacacaab",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/phy/phy-keystone.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/usb/usb_phy_generic.h>\n#include <linux/io.h>\n#include <linux/of.h>\n\n#include \"phy-generic.h\"\n\n \n#define USB_PHY_CTL_UTMI\t\t0x0000\n#define USB_PHY_CTL_PIPE\t\t0x0004\n#define USB_PHY_CTL_PARAM_1\t\t0x0008\n#define USB_PHY_CTL_PARAM_2\t\t0x000c\n#define USB_PHY_CTL_CLOCK\t\t0x0010\n#define USB_PHY_CTL_PLL\t\t\t0x0014\n\n#define PHY_REF_SSP_EN\t\t\tBIT(29)\n\nstruct keystone_usbphy {\n\tstruct usb_phy_generic\tusb_phy_gen;\n\tvoid __iomem\t\t\t*phy_ctrl;\n};\n\nstatic inline u32 keystone_usbphy_readl(void __iomem *base, u32 offset)\n{\n\treturn readl(base + offset);\n}\n\nstatic inline void keystone_usbphy_writel(void __iomem *base,\n\t\t\t\t\t  u32 offset, u32 value)\n{\n\twritel(value, base + offset);\n}\n\nstatic int keystone_usbphy_init(struct usb_phy *phy)\n{\n\tstruct keystone_usbphy *k_phy = dev_get_drvdata(phy->dev);\n\tu32 val;\n\n\tval  = keystone_usbphy_readl(k_phy->phy_ctrl, USB_PHY_CTL_CLOCK);\n\tkeystone_usbphy_writel(k_phy->phy_ctrl, USB_PHY_CTL_CLOCK,\n\t\t\t\tval | PHY_REF_SSP_EN);\n\treturn 0;\n}\n\nstatic void keystone_usbphy_shutdown(struct usb_phy *phy)\n{\n\tstruct keystone_usbphy *k_phy = dev_get_drvdata(phy->dev);\n\tu32 val;\n\n\tval  = keystone_usbphy_readl(k_phy->phy_ctrl, USB_PHY_CTL_CLOCK);\n\tkeystone_usbphy_writel(k_phy->phy_ctrl, USB_PHY_CTL_CLOCK,\n\t\t\t\tval & ~PHY_REF_SSP_EN);\n}\n\nstatic int keystone_usbphy_probe(struct platform_device *pdev)\n{\n\tstruct device\t\t*dev = &pdev->dev;\n\tstruct keystone_usbphy\t*k_phy;\n\tint ret;\n\n\tk_phy = devm_kzalloc(dev, sizeof(*k_phy), GFP_KERNEL);\n\tif (!k_phy)\n\t\treturn -ENOMEM;\n\n\tk_phy->phy_ctrl = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(k_phy->phy_ctrl))\n\t\treturn PTR_ERR(k_phy->phy_ctrl);\n\n\tret = usb_phy_gen_create_phy(dev, &k_phy->usb_phy_gen);\n\tif (ret)\n\t\treturn ret;\n\n\tk_phy->usb_phy_gen.phy.init = keystone_usbphy_init;\n\tk_phy->usb_phy_gen.phy.shutdown = keystone_usbphy_shutdown;\n\n\tplatform_set_drvdata(pdev, k_phy);\n\n\treturn usb_add_phy_dev(&k_phy->usb_phy_gen.phy);\n}\n\nstatic void keystone_usbphy_remove(struct platform_device *pdev)\n{\n\tstruct keystone_usbphy *k_phy = platform_get_drvdata(pdev);\n\n\tusb_remove_phy(&k_phy->usb_phy_gen.phy);\n}\n\nstatic const struct of_device_id keystone_usbphy_ids[] = {\n\t{ .compatible = \"ti,keystone-usbphy\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, keystone_usbphy_ids);\n\nstatic struct platform_driver keystone_usbphy_driver = {\n\t.probe          = keystone_usbphy_probe,\n\t.remove_new     = keystone_usbphy_remove,\n\t.driver         = {\n\t\t.name   = \"keystone-usbphy\",\n\t\t.of_match_table = keystone_usbphy_ids,\n\t},\n};\n\nmodule_platform_driver(keystone_usbphy_driver);\n\nMODULE_ALIAS(\"platform:keystone-usbphy\");\nMODULE_AUTHOR(\"Texas Instruments Inc.\");\nMODULE_DESCRIPTION(\"Keystone USB phy driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}