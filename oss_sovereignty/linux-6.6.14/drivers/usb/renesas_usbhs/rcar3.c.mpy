{
  "module_name": "rcar3.c",
  "hash_id": "6a390a83f18535745d42db91bda8da0558aaf19abb07833ff90dc27ce0c9c4f9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/usb/renesas_usbhs/rcar3.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include \"common.h\"\n#include \"rcar3.h\"\n\n#define LPSTS\t\t0x102\n#define UGCTRL\t\t0x180\t \n#define UGCTRL2\t\t0x184\t \n#define UGSTS\t\t0x188\t \n\n \n#define LPSTS_SUSPM\t0x4000\n\n \n#define UGCTRL_PLLRESET\t\t0x00000001\n#define UGCTRL_CONNECT\t\t0x00000004\n\n \n#define UGCTRL2_RESERVED_3\t0x00000001\t \n#define UGCTRL2_USB0SEL_HSUSB\t0x00000020\n#define UGCTRL2_USB0SEL_OTG\t0x00000030\n#define UGCTRL2_VBUSSEL\t\t0x00000400\n\n \n#define UGSTS_LOCK\t\t0x00000100\n\nstatic void usbhs_write32(struct usbhs_priv *priv, u32 reg, u32 data)\n{\n\tiowrite32(data, priv->base + reg);\n}\n\nstatic u32 usbhs_read32(struct usbhs_priv *priv, u32 reg)\n{\n\treturn ioread32(priv->base + reg);\n}\n\nstatic void usbhs_rcar3_set_ugctrl2(struct usbhs_priv *priv, u32 val)\n{\n\tusbhs_write32(priv, UGCTRL2, val | UGCTRL2_RESERVED_3);\n}\n\nstatic int usbhs_rcar3_power_ctrl(struct platform_device *pdev,\n\t\t\t\tvoid __iomem *base, int enable)\n{\n\tstruct usbhs_priv *priv = usbhs_pdev_to_priv(pdev);\n\n\tusbhs_rcar3_set_ugctrl2(priv, UGCTRL2_USB0SEL_OTG | UGCTRL2_VBUSSEL);\n\n\tif (enable) {\n\t\tusbhs_bset(priv, LPSTS, LPSTS_SUSPM, LPSTS_SUSPM);\n\t\t \n\t\tusleep_range(45, 90);\n\t} else {\n\t\tusbhs_bset(priv, LPSTS, LPSTS_SUSPM, 0);\n\t}\n\n\treturn 0;\n}\n\n \nstatic int usbhs_rcar3_power_and_pll_ctrl(struct platform_device *pdev,\n\t\t\t\t\t  void __iomem *base, int enable)\n{\n\tstruct usbhs_priv *priv = usbhs_pdev_to_priv(pdev);\n\tu32 val;\n\tint timeout = 1000;\n\n\tif (enable) {\n\t\tusbhs_write32(priv, UGCTRL, 0);\t \n\t\tusbhs_rcar3_set_ugctrl2(priv,\n\t\t\t\t\tUGCTRL2_USB0SEL_OTG | UGCTRL2_VBUSSEL);\n\n\t\tusbhs_bset(priv, LPSTS, LPSTS_SUSPM, LPSTS_SUSPM);\n\t\tdo {\n\t\t\tval = usbhs_read32(priv, UGSTS);\n\t\t\tudelay(1);\n\t\t} while (!(val & UGSTS_LOCK) && timeout--);\n\t\tusbhs_write32(priv, UGCTRL, UGCTRL_CONNECT);\n\t} else {\n\t\tusbhs_write32(priv, UGCTRL, 0);\n\t\tusbhs_bset(priv, LPSTS, LPSTS_SUSPM, 0);\n\t\tusbhs_write32(priv, UGCTRL, UGCTRL_PLLRESET);\n\t}\n\n\treturn 0;\n}\n\nconst struct renesas_usbhs_platform_info usbhs_rcar_gen3_plat_info = {\n\t.platform_callback = {\n\t\t.power_ctrl = usbhs_rcar3_power_ctrl,\n\t\t.get_id = usbhs_get_id_as_gadget,\n\t},\n\t.driver_param = {\n\t\t.has_usb_dmac = 1,\n\t\t.multi_clks = 1,\n\t\t.has_new_pipe_configs = 1,\n\t},\n};\n\nconst struct renesas_usbhs_platform_info usbhs_rcar_gen3_with_pll_plat_info = {\n\t.platform_callback = {\n\t\t.power_ctrl = usbhs_rcar3_power_and_pll_ctrl,\n\t\t.get_id = usbhs_get_id_as_gadget,\n\t},\n\t.driver_param = {\n\t\t.has_usb_dmac = 1,\n\t\t.multi_clks = 1,\n\t\t.has_new_pipe_configs = 1,\n\t},\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}