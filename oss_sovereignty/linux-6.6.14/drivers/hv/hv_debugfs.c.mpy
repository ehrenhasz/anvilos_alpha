{
  "module_name": "hv_debugfs.c",
  "hash_id": "3363196e82b2d826ff0226bfe21afb54ecb3546fdf1af49fa693593efdfd5e32",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hv/hv_debugfs.c",
  "human_readable_source": "\n \n\n#include <linux/hyperv.h>\n#include <linux/debugfs.h>\n#include <linux/delay.h>\n#include <linux/err.h>\n\n#include \"hyperv_vmbus.h\"\n\nstatic struct dentry *hv_debug_root;\n\nstatic int hv_debugfs_delay_get(void *data, u64 *val)\n{\n\t*val = *(u32 *)data;\n\treturn 0;\n}\n\nstatic int hv_debugfs_delay_set(void *data, u64 val)\n{\n\tif (val > 1000)\n\t\treturn -EINVAL;\n\t*(u32 *)data = val;\n\treturn 0;\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(hv_debugfs_delay_fops, hv_debugfs_delay_get,\n\t\t\t hv_debugfs_delay_set, \"%llu\\n\");\n\nstatic int hv_debugfs_state_get(void *data, u64 *val)\n{\n\t*val = *(bool *)data;\n\treturn 0;\n}\n\nstatic int hv_debugfs_state_set(void *data, u64 val)\n{\n\tif (val == 1)\n\t\t*(bool *)data = true;\n\telse if (val == 0)\n\t\t*(bool *)data = false;\n\telse\n\t\treturn -EINVAL;\n\treturn 0;\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(hv_debugfs_state_fops, hv_debugfs_state_get,\n\t\t\t hv_debugfs_state_set, \"%llu\\n\");\n\n \nstatic int hv_debug_delay_files(struct hv_device *dev, struct dentry *root)\n{\n\tstruct vmbus_channel *channel = dev->channel;\n\tchar *buffer = \"fuzz_test_buffer_interrupt_delay\";\n\tchar *message = \"fuzz_test_message_delay\";\n\tint *buffer_val = &channel->fuzz_testing_interrupt_delay;\n\tint *message_val = &channel->fuzz_testing_message_delay;\n\tstruct dentry *buffer_file, *message_file;\n\n\tbuffer_file = debugfs_create_file(buffer, 0644, root,\n\t\t\t\t\t  buffer_val,\n\t\t\t\t\t  &hv_debugfs_delay_fops);\n\tif (IS_ERR(buffer_file)) {\n\t\tpr_debug(\"debugfs_hyperv: file %s not created\\n\", buffer);\n\t\treturn PTR_ERR(buffer_file);\n\t}\n\n\tmessage_file = debugfs_create_file(message, 0644, root,\n\t\t\t\t\t   message_val,\n\t\t\t\t\t   &hv_debugfs_delay_fops);\n\tif (IS_ERR(message_file)) {\n\t\tpr_debug(\"debugfs_hyperv: file %s not created\\n\", message);\n\t\treturn PTR_ERR(message_file);\n\t}\n\n\treturn 0;\n}\n\n \nstatic int hv_debug_set_test_state(struct hv_device *dev, struct dentry *root)\n{\n\tstruct vmbus_channel *channel = dev->channel;\n\tbool *state = &channel->fuzz_testing_state;\n\tchar *status = \"fuzz_test_state\";\n\tstruct dentry *test_state;\n\n\ttest_state = debugfs_create_file(status, 0644, root,\n\t\t\t\t\t state,\n\t\t\t\t\t &hv_debugfs_state_fops);\n\tif (IS_ERR(test_state)) {\n\t\tpr_debug(\"debugfs_hyperv: file %s not created\\n\", status);\n\t\treturn PTR_ERR(test_state);\n\t}\n\n\treturn 0;\n}\n\n \nstatic void hv_debug_set_dir_dentry(struct hv_device *dev, struct dentry *root)\n{\n\tif (hv_debug_root)\n\t\tdev->debug_dir = root;\n}\n\n \nint hv_debug_add_dev_dir(struct hv_device *dev)\n{\n\tconst char *device = dev_name(&dev->device);\n\tchar *delay_name = \"delay\";\n\tstruct dentry *delay, *dev_root;\n\tint ret;\n\n\tif (!IS_ERR(hv_debug_root)) {\n\t\tdev_root = debugfs_create_dir(device, hv_debug_root);\n\t\tif (IS_ERR(dev_root)) {\n\t\t\tpr_debug(\"debugfs_hyperv: hyperv/%s/ not created\\n\",\n\t\t\t\t device);\n\t\t\treturn PTR_ERR(dev_root);\n\t\t}\n\t\thv_debug_set_test_state(dev, dev_root);\n\t\thv_debug_set_dir_dentry(dev, dev_root);\n\t\tdelay = debugfs_create_dir(delay_name, dev_root);\n\n\t\tif (IS_ERR(delay)) {\n\t\t\tpr_debug(\"debugfs_hyperv: hyperv/%s/%s/ not created\\n\",\n\t\t\t\t device, delay_name);\n\t\t\treturn PTR_ERR(delay);\n\t\t}\n\t\tret = hv_debug_delay_files(dev, delay);\n\n\t\treturn ret;\n\t}\n\tpr_debug(\"debugfs_hyperv: hyperv/ not in root debugfs path\\n\");\n\treturn PTR_ERR(hv_debug_root);\n}\n\n \nvoid hv_debug_rm_dev_dir(struct hv_device *dev)\n{\n\tif (!IS_ERR(hv_debug_root))\n\t\tdebugfs_remove_recursive(dev->debug_dir);\n}\n\n \nvoid hv_debug_rm_all_dir(void)\n{\n\tdebugfs_remove_recursive(hv_debug_root);\n}\n\n \nvoid hv_debug_delay_test(struct vmbus_channel *channel, enum delay delay_type)\n{\n\tstruct vmbus_channel *test_channel =    channel->primary_channel ?\n\t\t\t\t\t\tchannel->primary_channel :\n\t\t\t\t\t\tchannel;\n\tbool state = test_channel->fuzz_testing_state;\n\n\tif (state) {\n\t\tif (delay_type == 0)\n\t\t\tudelay(test_channel->fuzz_testing_interrupt_delay);\n\t\telse\n\t\t\tudelay(test_channel->fuzz_testing_message_delay);\n\t}\n}\n\n \nint hv_debug_init(void)\n{\n\thv_debug_root = debugfs_create_dir(\"hyperv\", NULL);\n\tif (IS_ERR(hv_debug_root)) {\n\t\tpr_debug(\"debugfs_hyperv: hyperv/ not created\\n\");\n\t\treturn PTR_ERR(hv_debug_root);\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}