{
  "module_name": "mvme16x_scsi.c",
  "hash_id": "54ba64e871d2e5b023fbe5a7acac443f7ff9f85520d8f959ad83de0d3c2f4f1d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/mvme16x_scsi.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/blkdev.h>\n#include <linux/device.h>\n#include <linux/platform_device.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/slab.h>\n#include <asm/mvme16xhw.h>\n#include <scsi/scsi_host.h>\n#include <scsi/scsi_device.h>\n#include <scsi/scsi_transport.h>\n#include <scsi/scsi_transport_spi.h>\n\n#include \"53c700.h\"\n\nMODULE_AUTHOR(\"Kars de Jong <jongk@linux-m68k.org>\");\nMODULE_DESCRIPTION(\"MVME16x NCR53C710 driver\");\nMODULE_LICENSE(\"GPL\");\n\nstatic struct scsi_host_template mvme16x_scsi_driver_template = {\n\t.name\t\t\t= \"MVME16x NCR53c710 SCSI\",\n\t.proc_name\t\t= \"MVME16x\",\n\t.this_id\t\t= 7,\n\t.module\t\t\t= THIS_MODULE,\n};\n\nstatic struct platform_device *mvme16x_scsi_device;\n\nstatic int mvme16x_probe(struct platform_device *dev)\n{\n\tstruct Scsi_Host * host = NULL;\n\tstruct NCR_700_Host_Parameters *hostdata;\n\n\tif (!MACH_IS_MVME16x)\n\t\tgoto out;\n\n\tif (mvme16x_config & MVME16x_CONFIG_NO_SCSICHIP) {\n\t\tprintk(KERN_INFO \"mvme16x-scsi: detection disabled, \"\n\t\t\t\t \"SCSI chip not present\\n\");\n\t\tgoto out;\n\t}\n\n\thostdata = kzalloc(sizeof(struct NCR_700_Host_Parameters), GFP_KERNEL);\n\tif (hostdata == NULL) {\n\t\tprintk(KERN_ERR \"mvme16x-scsi: \"\n\t\t\t\t\"Failed to allocate host data\\n\");\n\t\tgoto out;\n\t}\n\n\t \n\thostdata->base = (void __iomem *)0xfff47000UL;\n\thostdata->clock = 50;\t \n\thostdata->chip710 = 1;\n\thostdata->dmode_extra = DMODE_FC2;\n\thostdata->dcntl_extra = EA_710;\n\thostdata->ctest7_extra = CTEST7_TT1;\n\n\t \n\thost = NCR_700_detect(&mvme16x_scsi_driver_template, hostdata,\n\t\t\t      &dev->dev);\n\tif (!host) {\n\t\tprintk(KERN_ERR \"mvme16x-scsi: No host detected; \"\n\t\t\t\t\"board configuration problem?\\n\");\n\t\tgoto out_free;\n\t}\n\thost->this_id = 7;\n\thost->base = 0xfff47000UL;\n\thost->irq = MVME16x_IRQ_SCSI;\n\tif (request_irq(host->irq, NCR_700_intr, 0, \"mvme16x-scsi\", host)) {\n\t\tprintk(KERN_ERR \"mvme16x-scsi: request_irq failed\\n\");\n\t\tgoto out_put_host;\n\t}\n\n\t \n\t{\n\t\tvolatile unsigned long v;\n\n\t\t \n\t\tv = in_be32(0xfff4202c);\n\t\tv = (v & ~0xff) | 0x10 | 4;\n\t\tout_be32(0xfff4202c, v);\n\t}\n\n\tplatform_set_drvdata(dev, host);\n\tscsi_scan_host(host);\n\n\treturn 0;\n\n out_put_host:\n\tscsi_host_put(host);\n out_free:\n\tkfree(hostdata);\n out:\n\treturn -ENODEV;\n}\n\nstatic int mvme16x_device_remove(struct platform_device *dev)\n{\n\tstruct Scsi_Host *host = platform_get_drvdata(dev);\n\tstruct NCR_700_Host_Parameters *hostdata = shost_priv(host);\n\n\t \n\t{\n\t\tvolatile unsigned long v;\n\n\t\tv = in_be32(0xfff4202c);\n\t\tv &= ~0x10;\n\t\tout_be32(0xfff4202c, v);\n\t}\n\tscsi_remove_host(host);\n\tNCR_700_release(host);\n\tkfree(hostdata);\n\tfree_irq(host->irq, host);\n\n\treturn 0;\n}\n\nstatic struct platform_driver mvme16x_scsi_driver = {\n\t.driver = {\n\t\t.name           = \"mvme16x-scsi\",\n\t},\n\t.probe          = mvme16x_probe,\n\t.remove         = mvme16x_device_remove,\n};\n\nstatic int __init mvme16x_scsi_init(void)\n{\n\tint err;\n\n\terr = platform_driver_register(&mvme16x_scsi_driver);\n\tif (err)\n\t\treturn err;\n\n\tmvme16x_scsi_device = platform_device_register_simple(\"mvme16x-scsi\",\n\t\t\t\t\t\t\t      -1, NULL, 0);\n\tif (IS_ERR(mvme16x_scsi_device)) {\n\t\tplatform_driver_unregister(&mvme16x_scsi_driver);\n\t\treturn PTR_ERR(mvme16x_scsi_device);\n\t}\n\n\treturn 0;\n}\n\nstatic void __exit mvme16x_scsi_exit(void)\n{\n\tplatform_device_unregister(mvme16x_scsi_device);\n\tplatform_driver_unregister(&mvme16x_scsi_driver);\n}\n\nmodule_init(mvme16x_scsi_init);\nmodule_exit(mvme16x_scsi_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}