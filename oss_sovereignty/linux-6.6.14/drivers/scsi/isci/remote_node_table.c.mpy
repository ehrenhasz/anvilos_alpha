{
  "module_name": "remote_node_table.c",
  "hash_id": "fb42f944b9cded035d1191a4bc3851b1251254563670b93f54148c38c6841baa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/isci/remote_node_table.c",
  "human_readable_source": " \n\n \n#include \"remote_node_table.h\"\n#include \"remote_node_context.h\"\n\n \nstatic u32 sci_remote_node_table_get_group_index(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 group_table_index)\n{\n\tu32 dword_index;\n\tu32 *group_table;\n\tu32 bit_index;\n\n\tgroup_table = remote_node_table->remote_node_groups[group_table_index];\n\n\tfor (dword_index = 0; dword_index < remote_node_table->group_array_size; dword_index++) {\n\t\tif (group_table[dword_index] != 0) {\n\t\t\tfor (bit_index = 0; bit_index < 32; bit_index++) {\n\t\t\t\tif ((group_table[dword_index] & (1 << bit_index)) != 0) {\n\t\t\t\t\treturn (dword_index * 32) + bit_index;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn SCIC_SDS_REMOTE_NODE_TABLE_INVALID_INDEX;\n}\n\n \nstatic void sci_remote_node_table_clear_group_index(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 group_table_index,\n\tu32 group_index)\n{\n\tu32 dword_index;\n\tu32 bit_index;\n\tu32 *group_table;\n\n\tBUG_ON(group_table_index >= SCU_STP_REMOTE_NODE_COUNT);\n\tBUG_ON(group_index >= (u32)(remote_node_table->group_array_size * 32));\n\n\tdword_index = group_index / 32;\n\tbit_index   = group_index % 32;\n\tgroup_table = remote_node_table->remote_node_groups[group_table_index];\n\n\tgroup_table[dword_index] = group_table[dword_index] & ~(1 << bit_index);\n}\n\n \nstatic void sci_remote_node_table_set_group_index(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 group_table_index,\n\tu32 group_index)\n{\n\tu32 dword_index;\n\tu32 bit_index;\n\tu32 *group_table;\n\n\tBUG_ON(group_table_index >= SCU_STP_REMOTE_NODE_COUNT);\n\tBUG_ON(group_index >= (u32)(remote_node_table->group_array_size * 32));\n\n\tdword_index = group_index / 32;\n\tbit_index   = group_index % 32;\n\tgroup_table = remote_node_table->remote_node_groups[group_table_index];\n\n\tgroup_table[dword_index] = group_table[dword_index] | (1 << bit_index);\n}\n\n \nstatic void sci_remote_node_table_set_node_index(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 remote_node_index)\n{\n\tu32 dword_location;\n\tu32 dword_remainder;\n\tu32 slot_normalized;\n\tu32 slot_position;\n\n\tBUG_ON(\n\t\t(remote_node_table->available_nodes_array_size * SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD)\n\t\t<= (remote_node_index / SCU_STP_REMOTE_NODE_COUNT)\n\t\t);\n\n\tdword_location  = remote_node_index / SCIC_SDS_REMOTE_NODES_PER_DWORD;\n\tdword_remainder = remote_node_index % SCIC_SDS_REMOTE_NODES_PER_DWORD;\n\tslot_normalized = (dword_remainder / SCU_STP_REMOTE_NODE_COUNT) * sizeof(u32);\n\tslot_position   = remote_node_index % SCU_STP_REMOTE_NODE_COUNT;\n\n\tremote_node_table->available_remote_nodes[dword_location] |=\n\t\t1 << (slot_normalized + slot_position);\n}\n\n \nstatic void sci_remote_node_table_clear_node_index(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 remote_node_index)\n{\n\tu32 dword_location;\n\tu32 dword_remainder;\n\tu32 slot_position;\n\tu32 slot_normalized;\n\n\tBUG_ON(\n\t\t(remote_node_table->available_nodes_array_size * SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD)\n\t\t<= (remote_node_index / SCU_STP_REMOTE_NODE_COUNT)\n\t\t);\n\n\tdword_location  = remote_node_index / SCIC_SDS_REMOTE_NODES_PER_DWORD;\n\tdword_remainder = remote_node_index % SCIC_SDS_REMOTE_NODES_PER_DWORD;\n\tslot_normalized = (dword_remainder / SCU_STP_REMOTE_NODE_COUNT) * sizeof(u32);\n\tslot_position   = remote_node_index % SCU_STP_REMOTE_NODE_COUNT;\n\n\tremote_node_table->available_remote_nodes[dword_location] &=\n\t\t~(1 << (slot_normalized + slot_position));\n}\n\n \nstatic void sci_remote_node_table_clear_group(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 group_index)\n{\n\tu32 dword_location;\n\tu32 dword_remainder;\n\tu32 dword_value;\n\n\tBUG_ON(\n\t\t(remote_node_table->available_nodes_array_size * SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD)\n\t\t<= (group_index / SCU_STP_REMOTE_NODE_COUNT)\n\t\t);\n\n\tdword_location  = group_index / SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\n\tdword_remainder = group_index % SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\n\n\tdword_value = remote_node_table->available_remote_nodes[dword_location];\n\tdword_value &= ~(SCIC_SDS_REMOTE_NODE_TABLE_FULL_SLOT_VALUE << (dword_remainder * 4));\n\tremote_node_table->available_remote_nodes[dword_location] = dword_value;\n}\n\n \nstatic void sci_remote_node_table_set_group(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 group_index)\n{\n\tu32 dword_location;\n\tu32 dword_remainder;\n\tu32 dword_value;\n\n\tBUG_ON(\n\t\t(remote_node_table->available_nodes_array_size * SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD)\n\t\t<= (group_index / SCU_STP_REMOTE_NODE_COUNT)\n\t\t);\n\n\tdword_location  = group_index / SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\n\tdword_remainder = group_index % SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\n\n\tdword_value = remote_node_table->available_remote_nodes[dword_location];\n\tdword_value |= (SCIC_SDS_REMOTE_NODE_TABLE_FULL_SLOT_VALUE << (dword_remainder * 4));\n\tremote_node_table->available_remote_nodes[dword_location] = dword_value;\n}\n\n \nstatic u8 sci_remote_node_table_get_group_value(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 group_index)\n{\n\tu32 dword_location;\n\tu32 dword_remainder;\n\tu32 dword_value;\n\n\tdword_location  = group_index / SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\n\tdword_remainder = group_index % SCIC_SDS_REMOTE_NODE_SETS_PER_DWORD;\n\n\tdword_value = remote_node_table->available_remote_nodes[dword_location];\n\tdword_value &= (SCIC_SDS_REMOTE_NODE_TABLE_FULL_SLOT_VALUE << (dword_remainder * 4));\n\tdword_value = dword_value >> (dword_remainder * 4);\n\n\treturn (u8)dword_value;\n}\n\n \nvoid sci_remote_node_table_initialize(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 remote_node_entries)\n{\n\tu32 index;\n\n\t \n\tmemset(\n\t\tremote_node_table->available_remote_nodes,\n\t\t0x00,\n\t\tsizeof(remote_node_table->available_remote_nodes)\n\t\t);\n\n\tmemset(\n\t\tremote_node_table->remote_node_groups,\n\t\t0x00,\n\t\tsizeof(remote_node_table->remote_node_groups)\n\t\t);\n\n\t \n\tremote_node_table->available_nodes_array_size = (u16)\n\t\t\t\t\t\t\t(remote_node_entries / SCIC_SDS_REMOTE_NODES_PER_DWORD)\n\t\t\t\t\t\t\t+ ((remote_node_entries % SCIC_SDS_REMOTE_NODES_PER_DWORD) != 0);\n\n\n\t \n\tfor (index = 0; index < remote_node_entries; index++) {\n\t\tsci_remote_node_table_set_node_index(remote_node_table, index);\n\t}\n\n\tremote_node_table->group_array_size = (u16)\n\t\t\t\t\t      (remote_node_entries / (SCU_STP_REMOTE_NODE_COUNT * 32))\n\t\t\t\t\t      + ((remote_node_entries % (SCU_STP_REMOTE_NODE_COUNT * 32)) != 0);\n\n\tfor (index = 0; index < (remote_node_entries / SCU_STP_REMOTE_NODE_COUNT); index++) {\n\t\t \n\t\tsci_remote_node_table_set_group_index(remote_node_table, 2, index);\n\t}\n\n\t \n\tif ((remote_node_entries % SCU_STP_REMOTE_NODE_COUNT) == 2) {\n\t\tsci_remote_node_table_set_group_index(remote_node_table, 1, index);\n\t} else if ((remote_node_entries % SCU_STP_REMOTE_NODE_COUNT) == 1) {\n\t\tsci_remote_node_table_set_group_index(remote_node_table, 0, index);\n\t}\n}\n\n \nstatic u16 sci_remote_node_table_allocate_single_remote_node(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 group_table_index)\n{\n\tu8 index;\n\tu8 group_value;\n\tu32 group_index;\n\tu16 remote_node_index = SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX;\n\n\tgroup_index = sci_remote_node_table_get_group_index(\n\t\tremote_node_table, group_table_index);\n\n\t \n\tif (group_index != SCIC_SDS_REMOTE_NODE_TABLE_INVALID_INDEX) {\n\t\tgroup_value = sci_remote_node_table_get_group_value(\n\t\t\tremote_node_table, group_index);\n\n\t\tfor (index = 0; index < SCU_STP_REMOTE_NODE_COUNT; index++) {\n\t\t\tif (((1 << index) & group_value) != 0) {\n\t\t\t\t \n\t\t\t\tremote_node_index = (u16)(group_index * SCU_STP_REMOTE_NODE_COUNT\n\t\t\t\t\t\t\t  + index);\n\n\t\t\t\tsci_remote_node_table_clear_group_index(\n\t\t\t\t\tremote_node_table, group_table_index, group_index\n\t\t\t\t\t);\n\n\t\t\t\tsci_remote_node_table_clear_node_index(\n\t\t\t\t\tremote_node_table, remote_node_index\n\t\t\t\t\t);\n\n\t\t\t\tif (group_table_index > 0) {\n\t\t\t\t\tsci_remote_node_table_set_group_index(\n\t\t\t\t\t\tremote_node_table, group_table_index - 1, group_index\n\t\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn remote_node_index;\n}\n\n \nstatic u16 sci_remote_node_table_allocate_triple_remote_node(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 group_table_index)\n{\n\tu32 group_index;\n\tu16 remote_node_index = SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX;\n\n\tgroup_index = sci_remote_node_table_get_group_index(\n\t\tremote_node_table, group_table_index);\n\n\tif (group_index != SCIC_SDS_REMOTE_NODE_TABLE_INVALID_INDEX) {\n\t\tremote_node_index = (u16)group_index * SCU_STP_REMOTE_NODE_COUNT;\n\n\t\tsci_remote_node_table_clear_group_index(\n\t\t\tremote_node_table, group_table_index, group_index\n\t\t\t);\n\n\t\tsci_remote_node_table_clear_group(\n\t\t\tremote_node_table, group_index\n\t\t\t);\n\t}\n\n\treturn remote_node_index;\n}\n\n \nu16 sci_remote_node_table_allocate_remote_node(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 remote_node_count)\n{\n\tu16 remote_node_index = SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX;\n\n\tif (remote_node_count == SCU_SSP_REMOTE_NODE_COUNT) {\n\t\tremote_node_index =\n\t\t\tsci_remote_node_table_allocate_single_remote_node(\n\t\t\t\tremote_node_table, 0);\n\n\t\tif (remote_node_index == SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX) {\n\t\t\tremote_node_index =\n\t\t\t\tsci_remote_node_table_allocate_single_remote_node(\n\t\t\t\t\tremote_node_table, 1);\n\t\t}\n\n\t\tif (remote_node_index == SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX) {\n\t\t\tremote_node_index =\n\t\t\t\tsci_remote_node_table_allocate_single_remote_node(\n\t\t\t\t\tremote_node_table, 2);\n\t\t}\n\t} else if (remote_node_count == SCU_STP_REMOTE_NODE_COUNT) {\n\t\tremote_node_index =\n\t\t\tsci_remote_node_table_allocate_triple_remote_node(\n\t\t\t\tremote_node_table, 2);\n\t}\n\n\treturn remote_node_index;\n}\n\n \nstatic void sci_remote_node_table_release_single_remote_node(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu16 remote_node_index)\n{\n\tu32 group_index;\n\tu8 group_value;\n\n\tgroup_index = remote_node_index / SCU_STP_REMOTE_NODE_COUNT;\n\n\tgroup_value = sci_remote_node_table_get_group_value(remote_node_table, group_index);\n\n\t \n\tBUG_ON(group_value == SCIC_SDS_REMOTE_NODE_TABLE_FULL_SLOT_VALUE);\n\n\tif (group_value == 0x00) {\n\t\t \n\t\tsci_remote_node_table_set_group_index(remote_node_table, 0, group_index);\n\t} else if ((group_value & (group_value - 1)) == 0) {\n\t\t \n\t\tsci_remote_node_table_clear_group_index(remote_node_table, 0, group_index);\n\t\tsci_remote_node_table_set_group_index(remote_node_table, 1, group_index);\n\t} else {\n\t\t \n\t\tsci_remote_node_table_clear_group_index(remote_node_table, 1, group_index);\n\t\tsci_remote_node_table_set_group_index(remote_node_table, 2, group_index);\n\t}\n\n\tsci_remote_node_table_set_node_index(remote_node_table, remote_node_index);\n}\n\n \nstatic void sci_remote_node_table_release_triple_remote_node(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu16 remote_node_index)\n{\n\tu32 group_index;\n\n\tgroup_index = remote_node_index / SCU_STP_REMOTE_NODE_COUNT;\n\n\tsci_remote_node_table_set_group_index(\n\t\tremote_node_table, 2, group_index\n\t\t);\n\n\tsci_remote_node_table_set_group(remote_node_table, group_index);\n}\n\n \nvoid sci_remote_node_table_release_remote_node_index(\n\tstruct sci_remote_node_table *remote_node_table,\n\tu32 remote_node_count,\n\tu16 remote_node_index)\n{\n\tif (remote_node_count == SCU_SSP_REMOTE_NODE_COUNT) {\n\t\tsci_remote_node_table_release_single_remote_node(\n\t\t\tremote_node_table, remote_node_index);\n\t} else if (remote_node_count == SCU_STP_REMOTE_NODE_COUNT) {\n\t\tsci_remote_node_table_release_triple_remote_node(\n\t\t\tremote_node_table, remote_node_index);\n\t}\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}