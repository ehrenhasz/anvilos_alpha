{
  "module_name": "snic_isr.c",
  "hash_id": "fe658bf4461ccc727b47fa7ecdb7f4de51a039d9d9fbac48b9ec66bda3817207",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/snic/snic_isr.c",
  "human_readable_source": "\n\n\n#include <linux/string.h>\n#include <linux/errno.h>\n#include <linux/pci.h>\n#include <linux/interrupt.h>\n\n#include \"vnic_dev.h\"\n#include \"vnic_intr.h\"\n#include \"vnic_stats.h\"\n#include \"snic_io.h\"\n#include \"snic.h\"\n\n\n \n\nstatic irqreturn_t\nsnic_isr_msix_wq(int irq, void *data)\n{\n\tstruct snic *snic = data;\n\tunsigned long wq_work_done = 0;\n\n\tsnic->s_stats.misc.last_isr_time = jiffies;\n\tatomic64_inc(&snic->s_stats.misc.ack_isr_cnt);\n\n\twq_work_done = snic_wq_cmpl_handler(snic, -1);\n\tsvnic_intr_return_credits(&snic->intr[SNIC_MSIX_WQ],\n\t\t\t\t  wq_work_done,\n\t\t\t\t  1  ,\n\t\t\t\t  1  );\n\n\treturn IRQ_HANDLED;\n}  \n\nstatic irqreturn_t\nsnic_isr_msix_io_cmpl(int irq, void *data)\n{\n\tstruct snic *snic = data;\n\tunsigned long iocmpl_work_done = 0;\n\n\tsnic->s_stats.misc.last_isr_time = jiffies;\n\tatomic64_inc(&snic->s_stats.misc.cmpl_isr_cnt);\n\n\tiocmpl_work_done = snic_fwcq_cmpl_handler(snic, -1);\n\tsvnic_intr_return_credits(&snic->intr[SNIC_MSIX_IO_CMPL],\n\t\t\t\t  iocmpl_work_done,\n\t\t\t\t  1  ,\n\t\t\t\t  1  );\n\n\treturn IRQ_HANDLED;\n}  \n\nstatic irqreturn_t\nsnic_isr_msix_err_notify(int irq, void *data)\n{\n\tstruct snic *snic = data;\n\n\tsnic->s_stats.misc.last_isr_time = jiffies;\n\tatomic64_inc(&snic->s_stats.misc.errnotify_isr_cnt);\n\n\tsvnic_intr_return_all_credits(&snic->intr[SNIC_MSIX_ERR_NOTIFY]);\n\tsnic_log_q_error(snic);\n\n\t \n\tsnic_handle_link_event(snic);\n\n\treturn IRQ_HANDLED;\n}  \n\n\nvoid\nsnic_free_intr(struct snic *snic)\n{\n\tint i;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(snic->msix); i++) {\n\t\tif (snic->msix[i].requested) {\n\t\t\tfree_irq(pci_irq_vector(snic->pdev, i),\n\t\t\t\t snic->msix[i].devid);\n\t\t}\n\t}\n}  \n\nint\nsnic_request_intr(struct snic *snic)\n{\n\tint ret = 0, i;\n\tenum vnic_dev_intr_mode intr_mode;\n\n\tintr_mode = svnic_dev_get_intr_mode(snic->vdev);\n\tSNIC_BUG_ON(intr_mode != VNIC_DEV_INTR_MODE_MSIX);\n\n\t \n\tsprintf(snic->msix[SNIC_MSIX_WQ].devname,\n\t\t\"%.11s-scsi-wq\",\n\t\tsnic->name);\n\tsnic->msix[SNIC_MSIX_WQ].isr = snic_isr_msix_wq;\n\tsnic->msix[SNIC_MSIX_WQ].devid = snic;\n\n\tsprintf(snic->msix[SNIC_MSIX_IO_CMPL].devname,\n\t\t\"%.11s-io-cmpl\",\n\t\tsnic->name);\n\tsnic->msix[SNIC_MSIX_IO_CMPL].isr = snic_isr_msix_io_cmpl;\n\tsnic->msix[SNIC_MSIX_IO_CMPL].devid = snic;\n\n\tsprintf(snic->msix[SNIC_MSIX_ERR_NOTIFY].devname,\n\t\t\"%.11s-err-notify\",\n\t\tsnic->name);\n\tsnic->msix[SNIC_MSIX_ERR_NOTIFY].isr = snic_isr_msix_err_notify;\n\tsnic->msix[SNIC_MSIX_ERR_NOTIFY].devid = snic;\n\n\tfor (i = 0; i < ARRAY_SIZE(snic->msix); i++) {\n\t\tret = request_irq(pci_irq_vector(snic->pdev, i),\n\t\t\t\t  snic->msix[i].isr,\n\t\t\t\t  0,\n\t\t\t\t  snic->msix[i].devname,\n\t\t\t\t  snic->msix[i].devid);\n\t\tif (ret) {\n\t\t\tSNIC_HOST_ERR(snic->shost,\n\t\t\t\t      \"MSI-X: request_irq(%d) failed %d\\n\",\n\t\t\t\t      i,\n\t\t\t\t      ret);\n\t\t\tsnic_free_intr(snic);\n\t\t\tbreak;\n\t\t}\n\t\tsnic->msix[i].requested = 1;\n\t}\n\n\treturn ret;\n}  \n\nint\nsnic_set_intr_mode(struct snic *snic)\n{\n\tunsigned int n = ARRAY_SIZE(snic->wq);\n\tunsigned int m = SNIC_CQ_IO_CMPL_MAX;\n\tunsigned int vecs = n + m + 1;\n\n\t \n\tBUILD_BUG_ON((ARRAY_SIZE(snic->wq) + SNIC_CQ_IO_CMPL_MAX) >\n\t\t\tARRAY_SIZE(snic->intr));\n\n\tif (snic->wq_count < n || snic->cq_count < n + m)\n\t\tgoto fail;\n\n\tif (pci_alloc_irq_vectors(snic->pdev, vecs, vecs, PCI_IRQ_MSIX) < 0)\n\t\tgoto fail;\n\n\tsnic->wq_count = n;\n\tsnic->cq_count = n + m;\n\tsnic->intr_count = vecs;\n\tsnic->err_intr_offset = SNIC_MSIX_ERR_NOTIFY;\n\n\tSNIC_ISR_DBG(snic->shost, \"Using MSI-X Interrupts\\n\");\n\tsvnic_dev_set_intr_mode(snic->vdev, VNIC_DEV_INTR_MODE_MSIX);\n\treturn 0;\nfail:\n\tsvnic_dev_set_intr_mode(snic->vdev, VNIC_DEV_INTR_MODE_UNKNOWN);\n\treturn -EINVAL;\n}  \n\nvoid\nsnic_clear_intr_mode(struct snic *snic)\n{\n\tpci_free_irq_vectors(snic->pdev);\n\tsvnic_dev_set_intr_mode(snic->vdev, VNIC_DEV_INTR_MODE_INTX);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}