{
  "module_name": "snic_trc.c",
  "hash_id": "6c364460d0ae6b9bbfd8458938cc8248ec14637c0129081c4e8a08431a5bd77f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/snic/snic_trc.c",
  "human_readable_source": "\n\n\n#include <linux/module.h>\n#include <linux/mempool.h>\n#include <linux/errno.h>\n#include <linux/vmalloc.h>\n\n#include \"snic_io.h\"\n#include \"snic.h\"\n\n \nstruct snic_trc_data *\nsnic_get_trc_buf(void)\n{\n\tstruct snic_trc *trc = &snic_glob->trc;\n\tstruct snic_trc_data *td = NULL;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&trc->lock, flags);\n\ttd = &trc->buf[trc->wr_idx];\n\ttrc->wr_idx++;\n\n\tif (trc->wr_idx == trc->max_idx)\n\t\ttrc->wr_idx = 0;\n\n\tif (trc->wr_idx != trc->rd_idx) {\n\t\tspin_unlock_irqrestore(&trc->lock, flags);\n\n\t\tgoto end;\n\t}\n\n\ttrc->rd_idx++;\n\tif (trc->rd_idx == trc->max_idx)\n\t\ttrc->rd_idx = 0;\n\n\ttd->ts = 0;\t \n\tspin_unlock_irqrestore(&trc->lock, flags);\n\nend:\n\n\treturn td;\n}  \n\n \nstatic int\nsnic_fmt_trc_data(struct snic_trc_data *td, char *buf, int buf_sz)\n{\n\tint len = 0;\n\tstruct timespec64 tmspec;\n\n\tjiffies_to_timespec64(td->ts, &tmspec);\n\n\tlen += snprintf(buf, buf_sz,\n\t\t\t\"%llu.%09lu %-25s %3d %4x %16llx %16llx %16llx %16llx %16llx\\n\",\n\t\t\ttmspec.tv_sec,\n\t\t\ttmspec.tv_nsec,\n\t\t\ttd->fn,\n\t\t\ttd->hno,\n\t\t\ttd->tag,\n\t\t\ttd->data[0], td->data[1], td->data[2], td->data[3],\n\t\t\ttd->data[4]);\n\n\treturn len;\n}  \n\n \nint\nsnic_get_trc_data(char *buf, int buf_sz)\n{\n\tstruct snic_trc_data *td = NULL;\n\tstruct snic_trc *trc = &snic_glob->trc;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&trc->lock, flags);\n\tif (trc->rd_idx == trc->wr_idx) {\n\t\tspin_unlock_irqrestore(&trc->lock, flags);\n\n\t\treturn -1;\n\t}\n\ttd = &trc->buf[trc->rd_idx];\n\n\tif (td->ts == 0) {\n\t\t \n\t\tspin_unlock_irqrestore(&trc->lock, flags);\n\n\t\treturn -1;\n\t}\n\n\ttrc->rd_idx++;\n\tif (trc->rd_idx == trc->max_idx)\n\t\ttrc->rd_idx = 0;\n\tspin_unlock_irqrestore(&trc->lock, flags);\n\n\treturn snic_fmt_trc_data(td, buf, buf_sz);\n}  \n\n \nint\nsnic_trc_init(void)\n{\n\tstruct snic_trc *trc = &snic_glob->trc;\n\tvoid *tbuf = NULL;\n\tint tbuf_sz = 0, ret;\n\n\ttbuf_sz = (snic_trace_max_pages * PAGE_SIZE);\n\ttbuf = vzalloc(tbuf_sz);\n\tif (!tbuf) {\n\t\tSNIC_ERR(\"Failed to Allocate Trace Buffer Size. %d\\n\", tbuf_sz);\n\t\tSNIC_ERR(\"Trace Facility not enabled.\\n\");\n\t\tret = -ENOMEM;\n\n\t\treturn ret;\n\t}\n\n\ttrc->buf = (struct snic_trc_data *) tbuf;\n\tspin_lock_init(&trc->lock);\n\n\tsnic_trc_debugfs_init();\n\n\ttrc->max_idx = (tbuf_sz / SNIC_TRC_ENTRY_SZ);\n\ttrc->rd_idx = trc->wr_idx = 0;\n\ttrc->enable = true;\n\tSNIC_INFO(\"Trace Facility Enabled.\\n Trace Buffer SZ %lu Pages.\\n\",\n\t\t  tbuf_sz / PAGE_SIZE);\n\tret = 0;\n\n\treturn ret;\n}  \n\n \nvoid\nsnic_trc_free(void)\n{\n\tstruct snic_trc *trc = &snic_glob->trc;\n\n\ttrc->enable = false;\n\tsnic_trc_debugfs_term();\n\n\tif (trc->buf) {\n\t\tvfree(trc->buf);\n\t\ttrc->buf = NULL;\n\t}\n\n\tSNIC_INFO(\"Trace Facility Disabled.\\n\");\n}  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}