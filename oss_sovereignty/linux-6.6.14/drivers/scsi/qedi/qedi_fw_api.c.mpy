{
  "module_name": "qedi_fw_api.c",
  "hash_id": "8196c9a8617e23cb27db97044097d4c1fe0d4a63f267f6d419bf3b3186cf26e5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/qedi/qedi_fw_api.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <asm/byteorder.h>\n#include \"qedi_hsi.h\"\n#include <linux/qed/qed_if.h>\n\n#include \"qedi_fw_iscsi.h\"\n#include \"qedi_fw_scsi.h\"\n\n#define SCSI_NUM_SGES_IN_CACHE 0x4\n\nstatic bool scsi_is_slow_sgl(u16 num_sges, bool small_mid_sge)\n{\n\treturn (num_sges > SCSI_NUM_SGES_SLOW_SGL_THR && small_mid_sge);\n}\n\nstatic\nvoid init_scsi_sgl_context(struct scsi_sgl_params *ctx_sgl_params,\n\t\t\t   struct scsi_cached_sges *ctx_data_desc,\n\t\t\t   struct scsi_sgl_task_params *sgl_task_params)\n{\n\tu8 sge_index;\n\tu8 num_sges;\n\tu32 val;\n\n\tnum_sges = (sgl_task_params->num_sges > SCSI_NUM_SGES_IN_CACHE) ?\n\t\t\t     SCSI_NUM_SGES_IN_CACHE : sgl_task_params->num_sges;\n\n\t \n\tval = cpu_to_le32(sgl_task_params->sgl_phys_addr.lo);\n\tctx_sgl_params->sgl_addr.lo = val;\n\tval = cpu_to_le32(sgl_task_params->sgl_phys_addr.hi);\n\tctx_sgl_params->sgl_addr.hi = val;\n\tval = cpu_to_le32(sgl_task_params->total_buffer_size);\n\tctx_sgl_params->sgl_total_length = val;\n\tctx_sgl_params->sgl_num_sges = cpu_to_le16(sgl_task_params->num_sges);\n\n\tfor (sge_index = 0; sge_index < num_sges; sge_index++) {\n\t\tval = cpu_to_le32(sgl_task_params->sgl[sge_index].sge_addr.lo);\n\t\tctx_data_desc->sge[sge_index].sge_addr.lo = val;\n\t\tval = cpu_to_le32(sgl_task_params->sgl[sge_index].sge_addr.hi);\n\t\tctx_data_desc->sge[sge_index].sge_addr.hi = val;\n\t\tval = cpu_to_le32(sgl_task_params->sgl[sge_index].sge_len);\n\t\tctx_data_desc->sge[sge_index].sge_len = val;\n\t}\n}\n\nstatic u32 calc_rw_task_size(struct iscsi_task_params *task_params,\n\t\t\t     enum iscsi_task_type task_type,\n\t\t\t     struct scsi_sgl_task_params *sgl_task_params,\n\t\t\t     struct scsi_dif_task_params *dif_task_params)\n{\n\tu32 io_size;\n\n\tif (task_type == ISCSI_TASK_TYPE_INITIATOR_WRITE ||\n\t    task_type == ISCSI_TASK_TYPE_TARGET_READ)\n\t\tio_size = task_params->tx_io_size;\n\telse\n\t\tio_size = task_params->rx_io_size;\n\n\tif (!io_size)\n\t\treturn 0;\n\n\tif (!dif_task_params)\n\t\treturn io_size;\n\n\treturn !dif_task_params->dif_on_network ?\n\t       io_size : sgl_task_params->total_buffer_size;\n}\n\nstatic void\ninit_dif_context_flags(struct iscsi_dif_flags *ctx_dif_flags,\n\t\t       struct scsi_dif_task_params *dif_task_params)\n{\n\tif (!dif_task_params)\n\t\treturn;\n\n\tSET_FIELD(ctx_dif_flags->flags, ISCSI_DIF_FLAGS_PROT_INTERVAL_SIZE_LOG,\n\t\t  dif_task_params->dif_block_size_log);\n\tSET_FIELD(ctx_dif_flags->flags, ISCSI_DIF_FLAGS_DIF_TO_PEER,\n\t\t  dif_task_params->dif_on_network ? 1 : 0);\n\tSET_FIELD(ctx_dif_flags->flags, ISCSI_DIF_FLAGS_HOST_INTERFACE,\n\t\t  dif_task_params->dif_on_host ? 1 : 0);\n}\n\nstatic void init_sqe(struct iscsi_task_params *task_params,\n\t\t     struct scsi_sgl_task_params *sgl_task_params,\n\t\t     struct scsi_dif_task_params *dif_task_params,\n\t\t     struct iscsi_common_hdr *pdu_header,\n\t\t     struct scsi_initiator_cmd_params *cmd_params,\n\t\t     enum iscsi_task_type task_type,\n\t\t     bool is_cleanup)\n{\n\tif (!task_params->sqe)\n\t\treturn;\n\n\tmemset(task_params->sqe, 0, sizeof(*task_params->sqe));\n\ttask_params->sqe->task_id = cpu_to_le16(task_params->itid);\n\tif (is_cleanup) {\n\t\tSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\n\t\t\t  ISCSI_WQE_TYPE_TASK_CLEANUP);\n\t\treturn;\n\t}\n\n\tswitch (task_type) {\n\tcase ISCSI_TASK_TYPE_INITIATOR_WRITE:\n\t{\n\t\tu32 buf_size = 0;\n\t\tu32 num_sges = 0;\n\n\t\tinit_dif_context_flags(&task_params->sqe->prot_flags,\n\t\t\t\t       dif_task_params);\n\n\t\tSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\n\t\t\t  ISCSI_WQE_TYPE_NORMAL);\n\n\t\tif (task_params->tx_io_size) {\n\t\t\tbuf_size = calc_rw_task_size(task_params, task_type,\n\t\t\t\t\t\t     sgl_task_params,\n\t\t\t\t\t\t     dif_task_params);\n\n\t\t\tif (scsi_is_slow_sgl(sgl_task_params->num_sges,\n\t\t\t\t\t     sgl_task_params->small_mid_sge))\n\t\t\t\tnum_sges = ISCSI_WQE_NUM_SGES_SLOWIO;\n\t\t\telse\n\t\t\t\tnum_sges = min(sgl_task_params->num_sges,\n\t\t\t\t\t       (u16)SCSI_NUM_SGES_SLOW_SGL_THR);\n\t\t}\n\n\t\tSET_FIELD(task_params->sqe->flags, ISCSI_WQE_NUM_SGES,\n\t\t\t  num_sges);\n\t\tSET_FIELD(task_params->sqe->contlen_cdbsize, ISCSI_WQE_CONT_LEN,\n\t\t\t  buf_size);\n\n\t\tif (GET_FIELD(pdu_header->hdr_second_dword,\n\t\t\t      ISCSI_CMD_HDR_TOTAL_AHS_LEN))\n\t\t\tSET_FIELD(task_params->sqe->contlen_cdbsize,\n\t\t\t\t  ISCSI_WQE_CDB_SIZE,\n\t\t\t\t  cmd_params->extended_cdb_sge.sge_len);\n\t}\n\t\tbreak;\n\tcase ISCSI_TASK_TYPE_INITIATOR_READ:\n\t\tSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\n\t\t\t  ISCSI_WQE_TYPE_NORMAL);\n\n\t\tif (GET_FIELD(pdu_header->hdr_second_dword,\n\t\t\t      ISCSI_CMD_HDR_TOTAL_AHS_LEN))\n\t\t\tSET_FIELD(task_params->sqe->contlen_cdbsize,\n\t\t\t\t  ISCSI_WQE_CDB_SIZE,\n\t\t\t\t  cmd_params->extended_cdb_sge.sge_len);\n\t\tbreak;\n\tcase ISCSI_TASK_TYPE_LOGIN_RESPONSE:\n\tcase ISCSI_TASK_TYPE_MIDPATH:\n\t{\n\t\tbool advance_statsn = true;\n\n\t\tif (task_type == ISCSI_TASK_TYPE_LOGIN_RESPONSE)\n\t\t\tSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\n\t\t\t\t  ISCSI_WQE_TYPE_LOGIN);\n\t\telse\n\t\t\tSET_FIELD(task_params->sqe->flags, ISCSI_WQE_WQE_TYPE,\n\t\t\t\t  ISCSI_WQE_TYPE_MIDDLE_PATH);\n\n\t\tif (task_type == ISCSI_TASK_TYPE_MIDPATH) {\n\t\t\tu8 opcode = GET_FIELD(pdu_header->hdr_first_byte,\n\t\t\t\t\t      ISCSI_COMMON_HDR_OPCODE);\n\n\t\t\tif (opcode != ISCSI_OPCODE_TEXT_RESPONSE &&\n\t\t\t    (opcode != ISCSI_OPCODE_NOP_IN ||\n\t\t\t    pdu_header->itt == ISCSI_TTT_ALL_ONES))\n\t\t\t\tadvance_statsn = false;\n\t\t}\n\n\t\tSET_FIELD(task_params->sqe->flags, ISCSI_WQE_RESPONSE,\n\t\t\t  advance_statsn ? 1 : 0);\n\n\t\tif (task_params->tx_io_size) {\n\t\t\tSET_FIELD(task_params->sqe->contlen_cdbsize,\n\t\t\t\t  ISCSI_WQE_CONT_LEN, task_params->tx_io_size);\n\n\t\tif (scsi_is_slow_sgl(sgl_task_params->num_sges,\n\t\t\t\t     sgl_task_params->small_mid_sge))\n\t\t\tSET_FIELD(task_params->sqe->flags, ISCSI_WQE_NUM_SGES,\n\t\t\t\t  ISCSI_WQE_NUM_SGES_SLOWIO);\n\t\telse\n\t\t\tSET_FIELD(task_params->sqe->flags, ISCSI_WQE_NUM_SGES,\n\t\t\t\t  min(sgl_task_params->num_sges,\n\t\t\t\t      (u16)SCSI_NUM_SGES_SLOW_SGL_THR));\n\t\t}\n\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void init_default_iscsi_task(struct iscsi_task_params *task_params,\n\t\t\t\t    struct data_hdr *pdu_header,\n\t\t\t\t    enum iscsi_task_type task_type)\n{\n\tstruct iscsi_task_context *context;\n\tu32 val;\n\tu16 index;\n\tu8 val_byte;\n\n\tcontext = task_params->context;\n\tval_byte = context->mstorm_ag_context.cdu_validation;\n\tmemset(context, 0, sizeof(*context));\n\tcontext->mstorm_ag_context.cdu_validation = val_byte;\n\n\tfor (index = 0; index <\n\t     ARRAY_SIZE(context->ystorm_st_context.pdu_hdr.data.data);\n\t     index++) {\n\t\tval = cpu_to_le32(pdu_header->data[index]);\n\t\tcontext->ystorm_st_context.pdu_hdr.data.data[index] = val;\n\t}\n\n\tcontext->mstorm_st_context.task_type = task_type;\n\tcontext->mstorm_ag_context.task_cid =\n\t\t\t\t\t    cpu_to_le16(task_params->conn_icid);\n\n\tSET_FIELD(context->ustorm_ag_context.flags1,\n\t\t  USTORM_ISCSI_TASK_AG_CTX_R2T2RECV, 1);\n\n\tcontext->ustorm_st_context.task_type = task_type;\n\tcontext->ustorm_st_context.cq_rss_number = task_params->cq_rss_number;\n\tcontext->ustorm_ag_context.icid = cpu_to_le16(task_params->conn_icid);\n}\n\nstatic\nvoid init_initiator_rw_cdb_ystorm_context(struct ystorm_iscsi_task_st_ctx *ystc,\n\t\t\t\t\t  struct scsi_initiator_cmd_params *cmd)\n{\n\tunion iscsi_task_hdr *ctx_pdu_hdr = &ystc->pdu_hdr;\n\tu32 val;\n\n\tif (!cmd->extended_cdb_sge.sge_len)\n\t\treturn;\n\n\tSET_FIELD(ctx_pdu_hdr->ext_cdb_cmd.hdr_second_dword,\n\t\t  ISCSI_EXT_CDB_CMD_HDR_CDB_SIZE,\n\t\t  cmd->extended_cdb_sge.sge_len);\n\tval = cpu_to_le32(cmd->extended_cdb_sge.sge_addr.lo);\n\tctx_pdu_hdr->ext_cdb_cmd.cdb_sge.sge_addr.lo = val;\n\tval = cpu_to_le32(cmd->extended_cdb_sge.sge_addr.hi);\n\tctx_pdu_hdr->ext_cdb_cmd.cdb_sge.sge_addr.hi = val;\n\tval = cpu_to_le32(cmd->extended_cdb_sge.sge_len);\n\tctx_pdu_hdr->ext_cdb_cmd.cdb_sge.sge_len  = val;\n}\n\nstatic\nvoid init_ustorm_task_contexts(struct ustorm_iscsi_task_st_ctx *ustorm_st_cxt,\n\t\t\tstruct ustorm_iscsi_task_ag_ctx *ustorm_ag_cxt,\n\t\t\tu32 remaining_recv_len, u32 expected_data_transfer_len,\n\t\t\tu8 num_sges, bool tx_dif_conn_err_en)\n{\n\tu32 val;\n\n\tustorm_st_cxt->rem_rcv_len = cpu_to_le32(remaining_recv_len);\n\tustorm_ag_cxt->exp_data_acked = cpu_to_le32(expected_data_transfer_len);\n\tval = cpu_to_le32(expected_data_transfer_len);\n\tustorm_st_cxt->exp_data_transfer_len = val;\n\tSET_FIELD(ustorm_st_cxt->reg1.reg1_map, ISCSI_REG1_NUM_SGES, num_sges);\n\tSET_FIELD(ustorm_ag_cxt->flags2,\n\t\t  USTORM_ISCSI_TASK_AG_CTX_DIF_ERROR_CF_EN,\n\t\t  tx_dif_conn_err_en ? 1 : 0);\n}\n\nstatic\nvoid set_rw_exp_data_acked_and_cont_len(struct iscsi_task_context *context,\n\t\t\t\t\tstruct iscsi_conn_params  *conn_params,\n\t\t\t\t\tenum iscsi_task_type task_type,\n\t\t\t\t\tu32 task_size,\n\t\t\t\t\tu32 exp_data_transfer_len,\n\t\t\t\t\tu8 total_ahs_length)\n{\n\tu32 max_unsolicited_data = 0, val;\n\n\tif (total_ahs_length &&\n\t    (task_type == ISCSI_TASK_TYPE_INITIATOR_WRITE ||\n\t     task_type == ISCSI_TASK_TYPE_INITIATOR_READ))\n\t\tSET_FIELD(context->ustorm_st_context.flags2,\n\t\t\t  USTORM_ISCSI_TASK_ST_CTX_AHS_EXIST, 1);\n\n\tswitch (task_type) {\n\tcase ISCSI_TASK_TYPE_INITIATOR_WRITE:\n\t\tif (!conn_params->initial_r2t)\n\t\t\tmax_unsolicited_data = conn_params->first_burst_length;\n\t\telse if (conn_params->immediate_data)\n\t\t\tmax_unsolicited_data =\n\t\t\t\t\t  min(conn_params->first_burst_length,\n\t\t\t\t\t      conn_params->max_send_pdu_length);\n\n\t\tcontext->ustorm_ag_context.exp_data_acked =\n\t\t\t\t   cpu_to_le32(total_ahs_length == 0 ?\n\t\t\t\t\t\tmin(exp_data_transfer_len,\n\t\t\t\t\t\t    max_unsolicited_data) :\n\t\t\t\t\t\t((u32)(total_ahs_length +\n\t\t\t\t\t\t       ISCSI_AHS_CNTL_SIZE)));\n\t\tbreak;\n\tcase ISCSI_TASK_TYPE_TARGET_READ:\n\t\tval = cpu_to_le32(exp_data_transfer_len);\n\t\tcontext->ustorm_ag_context.exp_data_acked = val;\n\t\tbreak;\n\tcase ISCSI_TASK_TYPE_INITIATOR_READ:\n\t\tcontext->ustorm_ag_context.exp_data_acked =\n\t\t\t\t\tcpu_to_le32((total_ahs_length == 0 ? 0 :\n\t\t\t\t\t\t     total_ahs_length +\n\t\t\t\t\t\t     ISCSI_AHS_CNTL_SIZE));\n\t\tbreak;\n\tcase ISCSI_TASK_TYPE_TARGET_WRITE:\n\t\tval = cpu_to_le32(task_size);\n\t\tcontext->ustorm_ag_context.exp_cont_len = val;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic\nvoid init_rtdif_task_context(struct rdif_task_context *rdif_context,\n\t\t\t     struct tdif_task_context *tdif_context,\n\t\t\t     struct scsi_dif_task_params *dif_task_params,\n\t\t\t     enum iscsi_task_type task_type)\n{\n\tu32 val;\n\n\tif (!dif_task_params->dif_on_network || !dif_task_params->dif_on_host)\n\t\treturn;\n\n\tif (task_type == ISCSI_TASK_TYPE_TARGET_WRITE ||\n\t    task_type == ISCSI_TASK_TYPE_INITIATOR_READ) {\n\t\trdif_context->app_tag_value =\n\t\t\t\t  cpu_to_le16(dif_task_params->application_tag);\n\t\trdif_context->partial_crc_value = cpu_to_le16(0xffff);\n\t\tval = cpu_to_le32(dif_task_params->initial_ref_tag);\n\t\trdif_context->initial_ref_tag = val;\n\t\trdif_context->app_tag_mask =\n\t\t\t     cpu_to_le16(dif_task_params->application_tag_mask);\n\t\tSET_FIELD(rdif_context->flags0, RDIF_TASK_CONTEXT_CRC_SEED,\n\t\t\t  dif_task_params->crc_seed ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags0,\n\t\t\t  RDIF_TASK_CONTEXT_HOST_GUARD_TYPE,\n\t\t\t  dif_task_params->host_guard_type);\n\t\tSET_FIELD(rdif_context->flags0,\n\t\t\t  RDIF_TASK_CONTEXT_PROTECTION_TYPE,\n\t\t\t  dif_task_params->protection_type);\n\t\tSET_FIELD(rdif_context->flags0,\n\t\t\t  RDIF_TASK_CONTEXT_INITIAL_REF_TAG_VALID, 1);\n\t\tSET_FIELD(rdif_context->flags0,\n\t\t\t  RDIF_TASK_CONTEXT_KEEP_REF_TAG_CONST,\n\t\t\t  dif_task_params->keep_ref_tag_const ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_VALIDATE_APP_TAG,\n\t\t\t  (dif_task_params->validate_app_tag &&\n\t\t\t  dif_task_params->dif_on_network) ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_VALIDATE_GUARD,\n\t\t\t  (dif_task_params->validate_guard &&\n\t\t\t  dif_task_params->dif_on_network) ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_VALIDATE_REF_TAG,\n\t\t\t  (dif_task_params->validate_ref_tag &&\n\t\t\t  dif_task_params->dif_on_network) ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_HOST_INTERFACE,\n\t\t\t  dif_task_params->dif_on_host ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_NETWORK_INTERFACE,\n\t\t\t  dif_task_params->dif_on_network ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_FORWARD_GUARD,\n\t\t\t  dif_task_params->forward_guard ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_FORWARD_APP_TAG,\n\t\t\t  dif_task_params->forward_app_tag ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_FORWARD_REF_TAG,\n\t\t\t  dif_task_params->forward_ref_tag ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_FORWARD_APP_TAG_WITH_MASK,\n\t\t\t  dif_task_params->forward_app_tag_with_mask ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_FORWARD_REF_TAG_WITH_MASK,\n\t\t\t  dif_task_params->forward_ref_tag_with_mask ? 1 : 0);\n\t\tSET_FIELD(rdif_context->flags1,\n\t\t\t  RDIF_TASK_CONTEXT_INTERVAL_SIZE,\n\t\t\t  dif_task_params->dif_block_size_log - 9);\n\t\tSET_FIELD(rdif_context->state,\n\t\t\t  RDIF_TASK_CONTEXT_REF_TAG_MASK,\n\t\t\t  dif_task_params->ref_tag_mask);\n\t\tSET_FIELD(rdif_context->state, RDIF_TASK_CONTEXT_IGNORE_APP_TAG,\n\t\t\t  dif_task_params->ignore_app_tag);\n\t}\n\n\tif (task_type == ISCSI_TASK_TYPE_TARGET_READ ||\n\t    task_type == ISCSI_TASK_TYPE_INITIATOR_WRITE) {\n\t\ttdif_context->app_tag_value =\n\t\t\t\t  cpu_to_le16(dif_task_params->application_tag);\n\t\ttdif_context->partial_crc_value_b =\n\t\t       cpu_to_le16(dif_task_params->crc_seed ? 0xffff : 0x0000);\n\t\ttdif_context->partial_crc_value_a =\n\t\t       cpu_to_le16(dif_task_params->crc_seed ? 0xffff : 0x0000);\n\t\tSET_FIELD(tdif_context->flags0, TDIF_TASK_CONTEXT_CRC_SEED,\n\t\t\t  dif_task_params->crc_seed ? 1 : 0);\n\n\t\tSET_FIELD(tdif_context->flags0,\n\t\t\t  TDIF_TASK_CONTEXT_SET_ERROR_WITH_EOP,\n\t\t\t  dif_task_params->tx_dif_conn_err_en ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1, TDIF_TASK_CONTEXT_FORWARD_GUARD,\n\t\t\t  dif_task_params->forward_guard   ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_FORWARD_APP_TAG,\n\t\t\t  dif_task_params->forward_app_tag ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_FORWARD_REF_TAG,\n\t\t\t  dif_task_params->forward_ref_tag ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1, TDIF_TASK_CONTEXT_INTERVAL_SIZE,\n\t\t\t  dif_task_params->dif_block_size_log - 9);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_HOST_INTERFACE,\n\t\t\t  dif_task_params->dif_on_host    ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_NETWORK_INTERFACE,\n\t\t\t  dif_task_params->dif_on_network ? 1 : 0);\n\t\tval = cpu_to_le32(dif_task_params->initial_ref_tag);\n\t\ttdif_context->initial_ref_tag = val;\n\t\ttdif_context->app_tag_mask =\n\t\t\t     cpu_to_le16(dif_task_params->application_tag_mask);\n\t\tSET_FIELD(tdif_context->flags0,\n\t\t\t  TDIF_TASK_CONTEXT_HOST_GUARD_TYPE,\n\t\t\t  dif_task_params->host_guard_type);\n\t\tSET_FIELD(tdif_context->flags0,\n\t\t\t  TDIF_TASK_CONTEXT_PROTECTION_TYPE,\n\t\t\t  dif_task_params->protection_type);\n\t\tSET_FIELD(tdif_context->flags0,\n\t\t\t  TDIF_TASK_CONTEXT_INITIAL_REF_TAG_VALID,\n\t\t\t  dif_task_params->initial_ref_tag_is_valid ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags0,\n\t\t\t  TDIF_TASK_CONTEXT_KEEP_REF_TAG_CONST,\n\t\t\t  dif_task_params->keep_ref_tag_const ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_VALIDATE_GUARD,\n\t\t\t  (dif_task_params->validate_guard &&\n\t\t\t   dif_task_params->dif_on_host) ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_VALIDATE_APP_TAG,\n\t\t\t  (dif_task_params->validate_app_tag &&\n\t\t\t  dif_task_params->dif_on_host) ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_VALIDATE_REF_TAG,\n\t\t\t  (dif_task_params->validate_ref_tag &&\n\t\t\t   dif_task_params->dif_on_host) ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_FORWARD_APP_TAG_WITH_MASK,\n\t\t\t  dif_task_params->forward_app_tag_with_mask ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_FORWARD_REF_TAG_WITH_MASK,\n\t\t\t  dif_task_params->forward_ref_tag_with_mask ? 1 : 0);\n\t\tSET_FIELD(tdif_context->flags1,\n\t\t\t  TDIF_TASK_CONTEXT_REF_TAG_MASK,\n\t\t\t  dif_task_params->ref_tag_mask);\n\t\tSET_FIELD(tdif_context->flags0,\n\t\t\t  TDIF_TASK_CONTEXT_IGNORE_APP_TAG,\n\t\t\t  dif_task_params->ignore_app_tag ? 1 : 0);\n\t}\n}\n\nstatic void set_local_completion_context(struct iscsi_task_context *context)\n{\n\tSET_FIELD(context->ystorm_st_context.state.flags,\n\t\t  YSTORM_ISCSI_TASK_STATE_LOCAL_COMP, 1);\n\tSET_FIELD(context->ustorm_st_context.flags,\n\t\t  USTORM_ISCSI_TASK_ST_CTX_LOCAL_COMP, 1);\n}\n\nstatic int init_rw_iscsi_task(struct iscsi_task_params *task_params,\n\t\t\t      enum iscsi_task_type task_type,\n\t\t\t      struct iscsi_conn_params *conn_params,\n\t\t\t      struct iscsi_common_hdr *pdu_header,\n\t\t\t      struct scsi_sgl_task_params *sgl_task_params,\n\t\t\t      struct scsi_initiator_cmd_params *cmd_params,\n\t\t\t      struct scsi_dif_task_params *dif_task_params)\n{\n\tu32 exp_data_transfer_len = conn_params->max_burst_length;\n\tstruct iscsi_task_context *cxt;\n\tbool slow_io = false;\n\tu32 task_size, val;\n\tu8 num_sges = 0;\n\n\ttask_size = calc_rw_task_size(task_params, task_type, sgl_task_params,\n\t\t\t\t      dif_task_params);\n\n\tinit_default_iscsi_task(task_params, (struct data_hdr *)pdu_header,\n\t\t\t\ttask_type);\n\n\tcxt = task_params->context;\n\n\n\tif (task_type == ISCSI_TASK_TYPE_TARGET_READ) {\n\t\tset_local_completion_context(cxt);\n\t} else if (task_type == ISCSI_TASK_TYPE_TARGET_WRITE) {\n\t\tval = cpu_to_le32(task_size +\n\t\t\t   ((struct iscsi_r2t_hdr *)pdu_header)->buffer_offset);\n\t\tcxt->ystorm_st_context.pdu_hdr.r2t.desired_data_trns_len = val;\n\t\tcxt->mstorm_st_context.expected_itt =\n\t\t\t\t\t\t   cpu_to_le32(pdu_header->itt);\n\t} else {\n\t\tval = cpu_to_le32(task_size);\n\t\tcxt->ystorm_st_context.pdu_hdr.cmd.expected_transfer_length =\n\t\t\t\t\t\t\t\t\t    val;\n\t\tinit_initiator_rw_cdb_ystorm_context(&cxt->ystorm_st_context,\n\t\t\t\t\t\t     cmd_params);\n\t\tval = cpu_to_le32(cmd_params->sense_data_buffer_phys_addr.lo);\n\t\tcxt->mstorm_st_context.sense_db.lo = val;\n\n\t\tval = cpu_to_le32(cmd_params->sense_data_buffer_phys_addr.hi);\n\t\tcxt->mstorm_st_context.sense_db.hi = val;\n\t}\n\n\tif (task_params->tx_io_size) {\n\t\tinit_dif_context_flags(&cxt->ystorm_st_context.state.dif_flags,\n\t\t\t\t       dif_task_params);\n\t\tinit_dif_context_flags(&cxt->ustorm_st_context.dif_flags,\n\t\t\t\t       dif_task_params);\n\t\tinit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\n\t\t\t\t      &cxt->ystorm_st_context.state.data_desc,\n\t\t\t\t      sgl_task_params);\n\n\t\tslow_io = scsi_is_slow_sgl(sgl_task_params->num_sges,\n\t\t\t\t\t   sgl_task_params->small_mid_sge);\n\n\t\tnum_sges = !slow_io ? min_t(u16, sgl_task_params->num_sges,\n\t\t\t\t\t    (u16)SCSI_NUM_SGES_SLOW_SGL_THR) :\n\t\t\t\t      ISCSI_WQE_NUM_SGES_SLOWIO;\n\n\t\tif (slow_io) {\n\t\t\tSET_FIELD(cxt->ystorm_st_context.state.flags,\n\t\t\t\t  YSTORM_ISCSI_TASK_STATE_SLOW_IO, 1);\n\t\t}\n\t} else if (task_params->rx_io_size) {\n\t\tinit_dif_context_flags(&cxt->mstorm_st_context.dif_flags,\n\t\t\t\t       dif_task_params);\n\t\tinit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\n\t\t\t\t      &cxt->mstorm_st_context.data_desc,\n\t\t\t\t      sgl_task_params);\n\t\tnum_sges = !scsi_is_slow_sgl(sgl_task_params->num_sges,\n\t\t\t\tsgl_task_params->small_mid_sge) ?\n\t\t\t\tmin_t(u16, sgl_task_params->num_sges,\n\t\t\t\t      (u16)SCSI_NUM_SGES_SLOW_SGL_THR) :\n\t\t\t\tISCSI_WQE_NUM_SGES_SLOWIO;\n\t\tcxt->mstorm_st_context.rem_task_size = cpu_to_le32(task_size);\n\t}\n\n\tif (exp_data_transfer_len > task_size  ||\n\t    task_type != ISCSI_TASK_TYPE_TARGET_WRITE)\n\t\texp_data_transfer_len = task_size;\n\n\tinit_ustorm_task_contexts(&task_params->context->ustorm_st_context,\n\t\t\t\t  &task_params->context->ustorm_ag_context,\n\t\t\t\t  task_size, exp_data_transfer_len, num_sges,\n\t\t\t\t  dif_task_params ?\n\t\t\t\t  dif_task_params->tx_dif_conn_err_en : false);\n\n\tset_rw_exp_data_acked_and_cont_len(task_params->context, conn_params,\n\t\t\t\t\t   task_type, task_size,\n\t\t\t\t\t   exp_data_transfer_len,\n\t\t\t\t\tGET_FIELD(pdu_header->hdr_second_dword,\n\t\t\t\t\t\t  ISCSI_CMD_HDR_TOTAL_AHS_LEN));\n\n\tif (dif_task_params)\n\t\tinit_rtdif_task_context(&task_params->context->rdif_context,\n\t\t\t\t\t&task_params->context->tdif_context,\n\t\t\t\t\tdif_task_params, task_type);\n\n\tinit_sqe(task_params, sgl_task_params, dif_task_params, pdu_header,\n\t\t cmd_params, task_type, false);\n\n\treturn 0;\n}\n\nint init_initiator_rw_iscsi_task(struct iscsi_task_params *task_params,\n\t\t\t\t struct iscsi_conn_params *conn_params,\n\t\t\t\t struct scsi_initiator_cmd_params *cmd_params,\n\t\t\t\t struct iscsi_cmd_hdr *cmd_header,\n\t\t\t\t struct scsi_sgl_task_params *tx_sgl_params,\n\t\t\t\t struct scsi_sgl_task_params *rx_sgl_params,\n\t\t\t\t struct scsi_dif_task_params *dif_task_params)\n{\n\tif (GET_FIELD(cmd_header->flags_attr, ISCSI_CMD_HDR_WRITE))\n\t\treturn init_rw_iscsi_task(task_params,\n\t\t\t\t\t  ISCSI_TASK_TYPE_INITIATOR_WRITE,\n\t\t\t\t\t  conn_params,\n\t\t\t\t\t  (struct iscsi_common_hdr *)cmd_header,\n\t\t\t\t\t  tx_sgl_params, cmd_params,\n\t\t\t\t\t  dif_task_params);\n\telse if (GET_FIELD(cmd_header->flags_attr, ISCSI_CMD_HDR_READ) ||\n\t\t (task_params->rx_io_size == 0 && task_params->tx_io_size == 0))\n\t\treturn init_rw_iscsi_task(task_params,\n\t\t\t\t\t  ISCSI_TASK_TYPE_INITIATOR_READ,\n\t\t\t\t\t  conn_params,\n\t\t\t\t\t  (struct iscsi_common_hdr *)cmd_header,\n\t\t\t\t\t  rx_sgl_params, cmd_params,\n\t\t\t\t\t  dif_task_params);\n\telse\n\t\treturn -1;\n}\n\nint init_initiator_login_request_task(struct iscsi_task_params *task_params,\n\t\t\t\t      struct iscsi_login_req_hdr  *login_header,\n\t\t\t\t      struct scsi_sgl_task_params *tx_params,\n\t\t\t\t      struct scsi_sgl_task_params *rx_params)\n{\n\tstruct iscsi_task_context *cxt;\n\n\tcxt = task_params->context;\n\n\tinit_default_iscsi_task(task_params,\n\t\t\t\t(struct data_hdr *)login_header,\n\t\t\t\tISCSI_TASK_TYPE_MIDPATH);\n\n\tinit_ustorm_task_contexts(&cxt->ustorm_st_context,\n\t\t\t\t  &cxt->ustorm_ag_context,\n\t\t\t\t  task_params->rx_io_size ?\n\t\t\t\t  rx_params->total_buffer_size : 0,\n\t\t\t\t  task_params->tx_io_size ?\n\t\t\t\t  tx_params->total_buffer_size : 0, 0,\n\t\t\t\t  0);\n\n\tif (task_params->tx_io_size)\n\t\tinit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\n\t\t\t\t      &cxt->ystorm_st_context.state.data_desc,\n\t\t\t\t      tx_params);\n\n\tif (task_params->rx_io_size)\n\t\tinit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\n\t\t\t\t      &cxt->mstorm_st_context.data_desc,\n\t\t\t\t      rx_params);\n\n\tcxt->mstorm_st_context.rem_task_size =\n\t\t\tcpu_to_le32(task_params->rx_io_size ?\n\t\t\t\t    rx_params->total_buffer_size : 0);\n\n\tinit_sqe(task_params, tx_params, NULL,\n\t\t (struct iscsi_common_hdr *)login_header, NULL,\n\t\t ISCSI_TASK_TYPE_MIDPATH, false);\n\n\treturn 0;\n}\n\nint init_initiator_nop_out_task(struct iscsi_task_params *task_params,\n\t\t\t\tstruct iscsi_nop_out_hdr *nop_out_pdu_header,\n\t\t\t\tstruct scsi_sgl_task_params *tx_sgl_task_params,\n\t\t\t\tstruct scsi_sgl_task_params *rx_sgl_task_params)\n{\n\tstruct iscsi_task_context *cxt;\n\n\tcxt = task_params->context;\n\n\tinit_default_iscsi_task(task_params,\n\t\t\t\t(struct data_hdr *)nop_out_pdu_header,\n\t\t\t\tISCSI_TASK_TYPE_MIDPATH);\n\n\tif (nop_out_pdu_header->itt == ISCSI_ITT_ALL_ONES)\n\t\tset_local_completion_context(task_params->context);\n\n\tif (task_params->tx_io_size)\n\t\tinit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\n\t\t\t\t      &cxt->ystorm_st_context.state.data_desc,\n\t\t\t\t      tx_sgl_task_params);\n\n\tif (task_params->rx_io_size)\n\t\tinit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\n\t\t\t\t      &cxt->mstorm_st_context.data_desc,\n\t\t\t\t      rx_sgl_task_params);\n\n\tinit_ustorm_task_contexts(&cxt->ustorm_st_context,\n\t\t\t\t  &cxt->ustorm_ag_context,\n\t\t\t\t  task_params->rx_io_size ?\n\t\t\t\t  rx_sgl_task_params->total_buffer_size : 0,\n\t\t\t\t  task_params->tx_io_size ?\n\t\t\t\t  tx_sgl_task_params->total_buffer_size : 0,\n\t\t\t\t  0, 0);\n\n\tcxt->mstorm_st_context.rem_task_size =\n\t\t\t\tcpu_to_le32(task_params->rx_io_size ?\n\t\t\t\t\trx_sgl_task_params->total_buffer_size :\n\t\t\t\t\t0);\n\n\tinit_sqe(task_params, tx_sgl_task_params, NULL,\n\t\t (struct iscsi_common_hdr *)nop_out_pdu_header, NULL,\n\t\t ISCSI_TASK_TYPE_MIDPATH, false);\n\n\treturn 0;\n}\n\nint init_initiator_logout_request_task(struct iscsi_task_params *task_params,\n\t\t\t\t       struct iscsi_logout_req_hdr *logout_hdr,\n\t\t\t\t       struct scsi_sgl_task_params *tx_params,\n\t\t\t\t       struct scsi_sgl_task_params *rx_params)\n{\n\tstruct iscsi_task_context *cxt;\n\n\tcxt = task_params->context;\n\n\tinit_default_iscsi_task(task_params,\n\t\t\t\t(struct data_hdr *)logout_hdr,\n\t\t\t\tISCSI_TASK_TYPE_MIDPATH);\n\n\tif (task_params->tx_io_size)\n\t\tinit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\n\t\t\t\t      &cxt->ystorm_st_context.state.data_desc,\n\t\t\t\t      tx_params);\n\n\tif (task_params->rx_io_size)\n\t\tinit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\n\t\t\t\t      &cxt->mstorm_st_context.data_desc,\n\t\t\t\t      rx_params);\n\n\tinit_ustorm_task_contexts(&cxt->ustorm_st_context,\n\t\t\t\t  &cxt->ustorm_ag_context,\n\t\t\t\t  task_params->rx_io_size ?\n\t\t\t\t  rx_params->total_buffer_size : 0,\n\t\t\t\t  task_params->tx_io_size ?\n\t\t\t\t  tx_params->total_buffer_size : 0,\n\t\t\t\t  0, 0);\n\n\tcxt->mstorm_st_context.rem_task_size =\n\t\t\t\t\tcpu_to_le32(task_params->rx_io_size ?\n\t\t\t\t\trx_params->total_buffer_size : 0);\n\n\tinit_sqe(task_params, tx_params, NULL,\n\t\t (struct iscsi_common_hdr *)logout_hdr, NULL,\n\t\t ISCSI_TASK_TYPE_MIDPATH, false);\n\n\treturn 0;\n}\n\nint init_initiator_tmf_request_task(struct iscsi_task_params *task_params,\n\t\t\t\t    struct iscsi_tmf_request_hdr *tmf_header)\n{\n\tinit_default_iscsi_task(task_params, (struct data_hdr *)tmf_header,\n\t\t\t\tISCSI_TASK_TYPE_MIDPATH);\n\n\tinit_sqe(task_params, NULL, NULL,\n\t\t (struct iscsi_common_hdr *)tmf_header, NULL,\n\t\t ISCSI_TASK_TYPE_MIDPATH, false);\n\n\treturn 0;\n}\n\nint init_initiator_text_request_task(struct iscsi_task_params *task_params,\n\t\t\t\t     struct iscsi_text_request_hdr *text_header,\n\t\t\t\t     struct scsi_sgl_task_params *tx_params,\n\t\t\t\t     struct scsi_sgl_task_params *rx_params)\n{\n\tstruct iscsi_task_context *cxt;\n\n\tcxt = task_params->context;\n\n\tinit_default_iscsi_task(task_params,\n\t\t\t\t(struct data_hdr *)text_header,\n\t\t\t\tISCSI_TASK_TYPE_MIDPATH);\n\n\tif (task_params->tx_io_size)\n\t\tinit_scsi_sgl_context(&cxt->ystorm_st_context.state.sgl_params,\n\t\t\t\t      &cxt->ystorm_st_context.state.data_desc,\n\t\t\t\t      tx_params);\n\n\tif (task_params->rx_io_size)\n\t\tinit_scsi_sgl_context(&cxt->mstorm_st_context.sgl_params,\n\t\t\t\t      &cxt->mstorm_st_context.data_desc,\n\t\t\t\t      rx_params);\n\n\tcxt->mstorm_st_context.rem_task_size =\n\t\t\t\tcpu_to_le32(task_params->rx_io_size ?\n\t\t\t\t\trx_params->total_buffer_size : 0);\n\n\tinit_ustorm_task_contexts(&cxt->ustorm_st_context,\n\t\t\t\t  &cxt->ustorm_ag_context,\n\t\t\t\t  task_params->rx_io_size ?\n\t\t\t\t  rx_params->total_buffer_size : 0,\n\t\t\t\t  task_params->tx_io_size ?\n\t\t\t\t  tx_params->total_buffer_size : 0, 0, 0);\n\n\tinit_sqe(task_params, tx_params, NULL,\n\t\t (struct iscsi_common_hdr *)text_header, NULL,\n\t\t ISCSI_TASK_TYPE_MIDPATH, false);\n\n\treturn 0;\n}\n\nint init_cleanup_task(struct iscsi_task_params *task_params)\n{\n\tinit_sqe(task_params, NULL, NULL, NULL, NULL, ISCSI_TASK_TYPE_MIDPATH,\n\t\t true);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}