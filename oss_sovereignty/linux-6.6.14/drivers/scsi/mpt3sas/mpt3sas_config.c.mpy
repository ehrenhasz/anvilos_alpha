{
  "module_name": "mpt3sas_config.c",
  "hash_id": "1b0dde09550d9074ceb4c82d9d88ce93354372e369ba0f064257f054a6f4fbfa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/mpt3sas/mpt3sas_config.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/errno.h>\n#include <linux/blkdev.h>\n#include <linux/sched.h>\n#include <linux/workqueue.h>\n#include <linux/delay.h>\n#include <linux/pci.h>\n\n#include \"mpt3sas_base.h\"\n\n \n\n \n#define MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT 15\n\n \n#define MPT3_CONFIG_COMMON_SGLFLAGS ((MPI2_SGE_FLAGS_SIMPLE_ELEMENT | \\\n\tMPI2_SGE_FLAGS_LAST_ELEMENT | MPI2_SGE_FLAGS_END_OF_BUFFER \\\n\t| MPI2_SGE_FLAGS_END_OF_LIST) << MPI2_SGE_FLAGS_SHIFT)\n\n \n#define MPT3_CONFIG_COMMON_WRITE_SGLFLAGS ((MPI2_SGE_FLAGS_SIMPLE_ELEMENT | \\\n\tMPI2_SGE_FLAGS_LAST_ELEMENT | MPI2_SGE_FLAGS_END_OF_BUFFER \\\n\t| MPI2_SGE_FLAGS_END_OF_LIST | MPI2_SGE_FLAGS_HOST_TO_IOC) \\\n\t<< MPI2_SGE_FLAGS_SHIFT)\n\n \nstruct config_request {\n\tu16\t\t\tsz;\n\tvoid\t\t\t*page;\n\tdma_addr_t\t\tpage_dma;\n};\n\n \nstatic void\n_config_display_some_debug(struct MPT3SAS_ADAPTER *ioc, u16 smid,\n\tchar *calling_function_name, MPI2DefaultReply_t *mpi_reply)\n{\n\tMpi2ConfigRequest_t *mpi_request;\n\tchar *desc = NULL;\n\n\tmpi_request = mpt3sas_base_get_msg_frame(ioc, smid);\n\tswitch (mpi_request->Header.PageType & MPI2_CONFIG_PAGETYPE_MASK) {\n\tcase MPI2_CONFIG_PAGETYPE_IO_UNIT:\n\t\tdesc = \"io_unit\";\n\t\tbreak;\n\tcase MPI2_CONFIG_PAGETYPE_IOC:\n\t\tdesc = \"ioc\";\n\t\tbreak;\n\tcase MPI2_CONFIG_PAGETYPE_BIOS:\n\t\tdesc = \"bios\";\n\t\tbreak;\n\tcase MPI2_CONFIG_PAGETYPE_RAID_VOLUME:\n\t\tdesc = \"raid_volume\";\n\t\tbreak;\n\tcase MPI2_CONFIG_PAGETYPE_MANUFACTURING:\n\t\tdesc = \"manufacturing\";\n\t\tbreak;\n\tcase MPI2_CONFIG_PAGETYPE_RAID_PHYSDISK:\n\t\tdesc = \"physdisk\";\n\t\tbreak;\n\tcase MPI2_CONFIG_PAGETYPE_EXTENDED:\n\t\tswitch (mpi_request->ExtPageType) {\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT:\n\t\t\tdesc = \"sas_io_unit\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_SAS_EXPANDER:\n\t\t\tdesc = \"sas_expander\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_SAS_DEVICE:\n\t\t\tdesc = \"sas_device\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_SAS_PHY:\n\t\t\tdesc = \"sas_phy\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_LOG:\n\t\t\tdesc = \"log\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_ENCLOSURE:\n\t\t\tdesc = \"enclosure\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_RAID_CONFIG:\n\t\t\tdesc = \"raid_config\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_DRIVER_MAPPING:\n\t\t\tdesc = \"driver_mapping\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_SAS_PORT:\n\t\t\tdesc = \"sas_port\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_EXT_MANUFACTURING:\n\t\t\tdesc = \"ext_manufacturing\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_PCIE_IO_UNIT:\n\t\t\tdesc = \"pcie_io_unit\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_PCIE_SWITCH:\n\t\t\tdesc = \"pcie_switch\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_PCIE_DEVICE:\n\t\t\tdesc = \"pcie_device\";\n\t\t\tbreak;\n\t\tcase MPI2_CONFIG_EXTPAGETYPE_PCIE_LINK:\n\t\t\tdesc = \"pcie_link\";\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\t}\n\n\tif (!desc)\n\t\treturn;\n\n\tioc_info(ioc, \"%s: %s(%d), action(%d), form(0x%08x), smid(%d)\\n\",\n\t\t calling_function_name, desc,\n\t\t mpi_request->Header.PageNumber, mpi_request->Action,\n\t\t le32_to_cpu(mpi_request->PageAddress), smid);\n\n\tif (!mpi_reply)\n\t\treturn;\n\n\tif (mpi_reply->IOCStatus || mpi_reply->IOCLogInfo)\n\t\tioc_info(ioc, \"\\tiocstatus(0x%04x), loginfo(0x%08x)\\n\",\n\t\t\t le16_to_cpu(mpi_reply->IOCStatus),\n\t\t\t le32_to_cpu(mpi_reply->IOCLogInfo));\n}\n\n \nstatic int\n_config_alloc_config_dma_memory(struct MPT3SAS_ADAPTER *ioc,\n\tstruct config_request *mem)\n{\n\tint r = 0;\n\n\tif (mem->sz > ioc->config_page_sz) {\n\t\tmem->page = dma_alloc_coherent(&ioc->pdev->dev, mem->sz,\n\t\t    &mem->page_dma, GFP_KERNEL);\n\t\tif (!mem->page) {\n\t\t\tioc_err(ioc, \"%s: dma_alloc_coherent failed asking for (%d) bytes!!\\n\",\n\t\t\t\t__func__, mem->sz);\n\t\t\tr = -ENOMEM;\n\t\t}\n\t} else {  \n\t\tmem->page = ioc->config_page;\n\t\tmem->page_dma = ioc->config_page_dma;\n\t}\n\tioc->config_vaddr = mem->page;\n\treturn r;\n}\n\n \nstatic void\n_config_free_config_dma_memory(struct MPT3SAS_ADAPTER *ioc,\n\tstruct config_request *mem)\n{\n\tif (mem->sz > ioc->config_page_sz)\n\t\tdma_free_coherent(&ioc->pdev->dev, mem->sz, mem->page,\n\t\t    mem->page_dma);\n}\n\n \nu8\nmpt3sas_config_done(struct MPT3SAS_ADAPTER *ioc, u16 smid, u8 msix_index,\n\tu32 reply)\n{\n\tMPI2DefaultReply_t *mpi_reply;\n\n\tif (ioc->config_cmds.status == MPT3_CMD_NOT_USED)\n\t\treturn 1;\n\tif (ioc->config_cmds.smid != smid)\n\t\treturn 1;\n\tioc->config_cmds.status |= MPT3_CMD_COMPLETE;\n\tmpi_reply =  mpt3sas_base_get_reply_virt_addr(ioc, reply);\n\tif (mpi_reply) {\n\t\tioc->config_cmds.status |= MPT3_CMD_REPLY_VALID;\n\t\tmemcpy(ioc->config_cmds.reply, mpi_reply,\n\t\t    mpi_reply->MsgLength*4);\n\t}\n\tioc->config_cmds.status &= ~MPT3_CMD_PENDING;\n\tif (ioc->logging_level & MPT_DEBUG_CONFIG)\n\t\t_config_display_some_debug(ioc, smid, \"config_done\", mpi_reply);\n\tioc->config_cmds.smid = USHRT_MAX;\n\tcomplete(&ioc->config_cmds.done);\n\treturn 1;\n}\n\n \nstatic int\n_config_request(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigRequest_t\n\t*mpi_request, Mpi2ConfigReply_t *mpi_reply, int timeout,\n\tvoid *config_page, u16 config_page_sz)\n{\n\tu16 smid;\n\tMpi2ConfigRequest_t *config_request;\n\tint r;\n\tu8 retry_count, issue_host_reset = 0;\n\tstruct config_request mem;\n\tu32 ioc_status = UINT_MAX;\n\n\tmutex_lock(&ioc->config_cmds.mutex);\n\tif (ioc->config_cmds.status != MPT3_CMD_NOT_USED) {\n\t\tioc_err(ioc, \"%s: config_cmd in use\\n\", __func__);\n\t\tmutex_unlock(&ioc->config_cmds.mutex);\n\t\treturn -EAGAIN;\n\t}\n\n\tretry_count = 0;\n\tmemset(&mem, 0, sizeof(struct config_request));\n\n\tmpi_request->VF_ID = 0;  \n\tmpi_request->VP_ID = 0;\n\n\tif (config_page) {\n\t\tmpi_request->Header.PageVersion = mpi_reply->Header.PageVersion;\n\t\tmpi_request->Header.PageNumber = mpi_reply->Header.PageNumber;\n\t\tmpi_request->Header.PageType = mpi_reply->Header.PageType;\n\t\tmpi_request->Header.PageLength = mpi_reply->Header.PageLength;\n\t\tmpi_request->ExtPageLength = mpi_reply->ExtPageLength;\n\t\tmpi_request->ExtPageType = mpi_reply->ExtPageType;\n\t\tif (mpi_request->Header.PageLength)\n\t\t\tmem.sz = mpi_request->Header.PageLength * 4;\n\t\telse\n\t\t\tmem.sz = le16_to_cpu(mpi_reply->ExtPageLength) * 4;\n\t\tr = _config_alloc_config_dma_memory(ioc, &mem);\n\t\tif (r != 0)\n\t\t\tgoto out;\n\t\tif (mpi_request->Action ==\n\t\t    MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT ||\n\t\t    mpi_request->Action ==\n\t\t    MPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM) {\n\t\t\tioc->base_add_sg_single(&mpi_request->PageBufferSGE,\n\t\t\t    MPT3_CONFIG_COMMON_WRITE_SGLFLAGS | mem.sz,\n\t\t\t    mem.page_dma);\n\t\t\tmemcpy(mem.page, config_page, min_t(u16, mem.sz,\n\t\t\t    config_page_sz));\n\t\t} else {\n\t\t\tmemset(config_page, 0, config_page_sz);\n\t\t\tioc->base_add_sg_single(&mpi_request->PageBufferSGE,\n\t\t\t    MPT3_CONFIG_COMMON_SGLFLAGS | mem.sz, mem.page_dma);\n\t\t\tmemset(mem.page, 0, min_t(u16, mem.sz, config_page_sz));\n\t\t}\n\t}\n\n retry_config:\n\tif (retry_count) {\n\t\tif (retry_count > 2) {  \n\t\t\tr = -EFAULT;\n\t\t\tgoto free_mem;\n\t\t}\n\t\tioc_info(ioc, \"%s: attempting retry (%d)\\n\",\n\t\t\t __func__, retry_count);\n\t}\n\n\tr = mpt3sas_wait_for_ioc(ioc, MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT);\n\tif (r) {\n\t\tif (r == -ETIME)\n\t\t\tissue_host_reset = 1;\n\t\tgoto free_mem;\n\t}\n\n\tsmid = mpt3sas_base_get_smid(ioc, ioc->config_cb_idx);\n\tif (!smid) {\n\t\tioc_err(ioc, \"%s: failed obtaining a smid\\n\", __func__);\n\t\tioc->config_cmds.status = MPT3_CMD_NOT_USED;\n\t\tr = -EAGAIN;\n\t\tgoto free_mem;\n\t}\n\n\tr = 0;\n\tmemset(ioc->config_cmds.reply, 0, sizeof(Mpi2ConfigReply_t));\n\tioc->config_cmds.status = MPT3_CMD_PENDING;\n\tconfig_request = mpt3sas_base_get_msg_frame(ioc, smid);\n\tioc->config_cmds.smid = smid;\n\tmemcpy(config_request, mpi_request, sizeof(Mpi2ConfigRequest_t));\n\tif (ioc->logging_level & MPT_DEBUG_CONFIG)\n\t\t_config_display_some_debug(ioc, smid, \"config_request\", NULL);\n\tinit_completion(&ioc->config_cmds.done);\n\tioc->put_smid_default(ioc, smid);\n\twait_for_completion_timeout(&ioc->config_cmds.done, timeout*HZ);\n\tif (!(ioc->config_cmds.status & MPT3_CMD_COMPLETE)) {\n\t\tif (!(ioc->logging_level & MPT_DEBUG_CONFIG))\n\t\t\t_config_display_some_debug(ioc,\n\t\t\t    smid, \"config_request\", NULL);\n\t\tioc_err(ioc, \"%s: command timeout\\n\", __func__);\n\t\tmpt3sas_base_check_cmd_timeout(ioc, ioc->config_cmds.status,\n\t\t\t\tmpi_request, sizeof(Mpi2ConfigRequest_t) / 4);\n\t\tretry_count++;\n\t\tif (ioc->config_cmds.smid == smid)\n\t\t\tmpt3sas_base_free_smid(ioc, smid);\n\t\tif (ioc->config_cmds.status & MPT3_CMD_RESET)\n\t\t\tgoto retry_config;\n\t\tif (ioc->shost_recovery || ioc->pci_error_recovery) {\n\t\t\tissue_host_reset = 0;\n\t\t\tr = -EFAULT;\n\t\t} else\n\t\t\tissue_host_reset = 1;\n\t\tgoto free_mem;\n\t}\n\n\tif (ioc->config_cmds.status & MPT3_CMD_REPLY_VALID) {\n\t\tmemcpy(mpi_reply, ioc->config_cmds.reply,\n\t\t    sizeof(Mpi2ConfigReply_t));\n\n\t\t \n\t\tif ((mpi_request->Header.PageType & 0xF) !=\n\t\t    (mpi_reply->Header.PageType & 0xF)) {\n\t\t\tif (!(ioc->logging_level & MPT_DEBUG_CONFIG))\n\t\t\t\t_config_display_some_debug(ioc,\n\t\t\t\t    smid, \"config_request\", NULL);\n\t\t\t_debug_dump_mf(mpi_request, ioc->request_sz/4);\n\t\t\t_debug_dump_reply(mpi_reply, ioc->reply_sz/4);\n\t\t\tpanic(\"%s: %s: Firmware BUG: mpi_reply mismatch: Requested PageType(0x%02x) Reply PageType(0x%02x)\\n\",\n\t\t\t      ioc->name, __func__,\n\t\t\t      mpi_request->Header.PageType & 0xF,\n\t\t\t      mpi_reply->Header.PageType & 0xF);\n\t\t}\n\n\t\tif (((mpi_request->Header.PageType & 0xF) ==\n\t\t    MPI2_CONFIG_PAGETYPE_EXTENDED) &&\n\t\t    mpi_request->ExtPageType != mpi_reply->ExtPageType) {\n\t\t\tif (!(ioc->logging_level & MPT_DEBUG_CONFIG))\n\t\t\t\t_config_display_some_debug(ioc,\n\t\t\t\t    smid, \"config_request\", NULL);\n\t\t\t_debug_dump_mf(mpi_request, ioc->request_sz/4);\n\t\t\t_debug_dump_reply(mpi_reply, ioc->reply_sz/4);\n\t\t\tpanic(\"%s: %s: Firmware BUG: mpi_reply mismatch: Requested ExtPageType(0x%02x) Reply ExtPageType(0x%02x)\\n\",\n\t\t\t      ioc->name, __func__,\n\t\t\t      mpi_request->ExtPageType,\n\t\t\t      mpi_reply->ExtPageType);\n\t\t}\n\t\tioc_status = le16_to_cpu(mpi_reply->IOCStatus)\n\t\t    & MPI2_IOCSTATUS_MASK;\n\t}\n\n\tif (retry_count)\n\t\tioc_info(ioc, \"%s: retry (%d) completed!!\\n\",\n\t\t\t __func__, retry_count);\n\n\tif ((ioc_status == MPI2_IOCSTATUS_SUCCESS) &&\n\t    config_page && mpi_request->Action ==\n\t    MPI2_CONFIG_ACTION_PAGE_READ_CURRENT) {\n\t\tu8 *p = (u8 *)mem.page;\n\n\t\t \n\t\tif (p) {\n\t\t\tif ((mpi_request->Header.PageType & 0xF) !=\n\t\t\t    (p[3] & 0xF)) {\n\t\t\t\tif (!(ioc->logging_level & MPT_DEBUG_CONFIG))\n\t\t\t\t\t_config_display_some_debug(ioc,\n\t\t\t\t\t    smid, \"config_request\", NULL);\n\t\t\t\t_debug_dump_mf(mpi_request, ioc->request_sz/4);\n\t\t\t\t_debug_dump_reply(mpi_reply, ioc->reply_sz/4);\n\t\t\t\t_debug_dump_config(p, min_t(u16, mem.sz,\n\t\t\t\t    config_page_sz)/4);\n\t\t\t\tpanic(\"%s: %s: Firmware BUG: config page mismatch: Requested PageType(0x%02x) Reply PageType(0x%02x)\\n\",\n\t\t\t\t      ioc->name, __func__,\n\t\t\t\t      mpi_request->Header.PageType & 0xF,\n\t\t\t\t      p[3] & 0xF);\n\t\t\t}\n\n\t\t\tif (((mpi_request->Header.PageType & 0xF) ==\n\t\t\t    MPI2_CONFIG_PAGETYPE_EXTENDED) &&\n\t\t\t    (mpi_request->ExtPageType != p[6])) {\n\t\t\t\tif (!(ioc->logging_level & MPT_DEBUG_CONFIG))\n\t\t\t\t\t_config_display_some_debug(ioc,\n\t\t\t\t\t    smid, \"config_request\", NULL);\n\t\t\t\t_debug_dump_mf(mpi_request, ioc->request_sz/4);\n\t\t\t\t_debug_dump_reply(mpi_reply, ioc->reply_sz/4);\n\t\t\t\t_debug_dump_config(p, min_t(u16, mem.sz,\n\t\t\t\t    config_page_sz)/4);\n\t\t\t\tpanic(\"%s: %s: Firmware BUG: config page mismatch: Requested ExtPageType(0x%02x) Reply ExtPageType(0x%02x)\\n\",\n\t\t\t\t      ioc->name, __func__,\n\t\t\t\t      mpi_request->ExtPageType, p[6]);\n\t\t\t}\n\t\t}\n\t\tmemcpy(config_page, mem.page, min_t(u16, mem.sz,\n\t\t    config_page_sz));\n\t}\n\n free_mem:\n\tif (config_page)\n\t\t_config_free_config_dma_memory(ioc, &mem);\n out:\n\tioc->config_cmds.status = MPT3_CMD_NOT_USED;\n\tmutex_unlock(&ioc->config_cmds.mutex);\n\n\tif (issue_host_reset) {\n\t\tif (ioc->drv_internal_flags & MPT_DRV_INTERNAL_FIRST_PE_ISSUED) {\n\t\t\tmpt3sas_base_hard_reset_handler(ioc, FORCE_BIG_HAMMER);\n\t\t\tr = -EFAULT;\n\t\t} else {\n\t\t\tif (mpt3sas_base_check_for_fault_and_issue_reset(ioc))\n\t\t\t\treturn -EFAULT;\n\t\t\tr = -EAGAIN;\n\t\t}\n\t}\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_manufacturing_pg0(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2ManufacturingPage0_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_MANUFACTURING0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_manufacturing_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2ManufacturingPage1_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_MANUFACTURING1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t\tsizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_manufacturing_pg7(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2ManufacturingPage7_t *config_page,\n\tu16 sz)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\n\tmpi_request.Header.PageNumber = 7;\n\tmpi_request.Header.PageVersion = MPI2_MANUFACTURING7_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sz);\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_manufacturing_pg10(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply,\n\tstruct Mpi2ManufacturingPage10_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\n\tmpi_request.Header.PageNumber = 10;\n\tmpi_request.Header.PageVersion = MPI2_MANUFACTURING0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_manufacturing_pg11(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply,\n\tstruct Mpi2ManufacturingPage11_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\n\tmpi_request.Header.PageNumber = 11;\n\tmpi_request.Header.PageVersion = MPI2_MANUFACTURING0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_set_manufacturing_pg11(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply,\n\tstruct Mpi2ManufacturingPage11_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\n\tmpi_request.Header.PageNumber = 11;\n\tmpi_request.Header.PageVersion = MPI2_MANUFACTURING0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_bios_pg2(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2BiosPage2_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_BIOS;\n\tmpi_request.Header.PageNumber = 2;\n\tmpi_request.Header.PageVersion = MPI2_BIOSPAGE2_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_bios_pg3(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\n\t*mpi_reply, Mpi2BiosPage3_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_BIOS;\n\tmpi_request.Header.PageNumber = 3;\n\tmpi_request.Header.PageVersion = MPI2_BIOSPAGE3_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_set_bios_pg4(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2BiosPage4_t *config_page,\n\tint sz_config_pg)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_BIOS;\n\tmpi_request.Header.PageNumber = 4;\n\tmpi_request.Header.PageVersion = MPI2_BIOSPAGE4_PAGEVERSION;\n\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t\tsz_config_pg);\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_bios_pg4(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2BiosPage4_t *config_page,\n\tint sz_config_pg)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_BIOS;\n\tmpi_request.Header.PageNumber = 4;\n\tmpi_request.Header.PageVersion =  MPI2_BIOSPAGE4_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\t \n\tif (config_page && sz_config_pg) {\n\t\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\n\t\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t\t\tsz_config_pg);\n\t}\n\nout:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_iounit_pg0(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2IOUnitPage0_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IO_UNIT;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_IOUNITPAGE0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_iounit_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2IOUnitPage1_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IO_UNIT;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_IOUNITPAGE1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_set_iounit_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2IOUnitPage1_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IO_UNIT;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_IOUNITPAGE1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_iounit_pg3(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2IOUnitPage3_t *config_page, u16 sz)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IO_UNIT;\n\tmpi_request.Header.PageNumber = 3;\n\tmpi_request.Header.PageVersion = MPI2_IOUNITPAGE3_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_iounit_pg8(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2IOUnitPage8_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IO_UNIT;\n\tmpi_request.Header.PageNumber = 8;\n\tmpi_request.Header.PageVersion = MPI2_IOUNITPAGE8_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_ioc_pg8(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2IOCPage8_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IOC;\n\tmpi_request.Header.PageNumber = 8;\n\tmpi_request.Header.PageVersion = MPI2_IOCPAGE8_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n \nint\nmpt3sas_config_get_ioc_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2IOCPage1_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IOC;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_IOCPAGE8_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_set_ioc_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2IOCPage1_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IOC;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_IOCPAGE8_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_sas_device_pg0(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2SasDevicePage0_t *config_page,\n\tu32 form, u32 handle)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_DEVICE;\n\tmpi_request.Header.PageVersion = MPI2_SASDEVICE0_PAGEVERSION;\n\tmpi_request.Header.PageNumber = 0;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress = cpu_to_le32(form | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_sas_device_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2SasDevicePage1_t *config_page,\n\tu32 form, u32 handle)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_DEVICE;\n\tmpi_request.Header.PageVersion = MPI2_SASDEVICE1_PAGEVERSION;\n\tmpi_request.Header.PageNumber = 1;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress = cpu_to_le32(form | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_pcie_device_pg0(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26PCIeDevicePage0_t *config_page,\n\tu32 form, u32 handle)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_PCIE_DEVICE;\n\tmpi_request.Header.PageVersion = MPI26_PCIEDEVICE0_PAGEVERSION;\n\tmpi_request.Header.PageNumber = 0;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress = cpu_to_le32(form | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t\t\tsizeof(*config_page));\nout:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_pcie_iounit_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26PCIeIOUnitPage1_t *config_page,\n\tu16 sz)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_PCIE_IO_UNIT;\n\tmpi_request.Header.PageVersion = MPI26_PCIEIOUNITPAGE1_PAGEVERSION;\n\tmpi_request.Header.PageNumber = 1;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\nout:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_pcie_device_pg2(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26PCIeDevicePage2_t *config_page,\n\tu32 form, u32 handle)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_PCIE_DEVICE;\n\tmpi_request.Header.PageVersion = MPI26_PCIEDEVICE2_PAGEVERSION;\n\tmpi_request.Header.PageNumber = 2;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress = cpu_to_le32(form | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t\t\tMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t\t\tsizeof(*config_page));\nout:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_number_hba_phys(struct MPT3SAS_ADAPTER *ioc, u8 *num_phys)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\tu16 ioc_status;\n\tMpi2ConfigReply_t mpi_reply;\n\tMpi2SasIOUnitPage0_t config_page;\n\n\t*num_phys = 0;\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_SASIOUNITPAGE0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, &mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, &mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, &config_page,\n\t    sizeof(Mpi2SasIOUnitPage0_t));\n\tif (!r) {\n\t\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t\t    MPI2_IOCSTATUS_MASK;\n\t\tif (ioc_status == MPI2_IOCSTATUS_SUCCESS)\n\t\t\t*num_phys = config_page.NumPhys;\n\t}\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_sas_iounit_pg0(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2SasIOUnitPage0_t *config_page,\n\tu16 sz)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_SASIOUNITPAGE0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_sas_iounit_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2SasIOUnitPage1_t *config_page,\n\tu16 sz)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_SASIOUNITPAGE1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_set_sas_iounit_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2SasIOUnitPage1_t *config_page,\n\tu16 sz)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_SASIOUNITPAGE1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\t_config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_expander_pg0(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\n\t*mpi_reply, Mpi2ExpanderPage0_t *config_page, u32 form, u32 handle)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_EXPANDER;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_SASEXPANDER0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress = cpu_to_le32(form | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_expander_pg1(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\n\t*mpi_reply, Mpi2ExpanderPage1_t *config_page, u32 phy_number,\n\tu16 handle)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_EXPANDER;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_SASEXPANDER1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress =\n\t    cpu_to_le32(MPI2_SAS_EXPAND_PGAD_FORM_HNDL_PHY_NUM |\n\t    (phy_number << MPI2_SAS_EXPAND_PGAD_PHYNUM_SHIFT) | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_enclosure_pg0(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\n\t*mpi_reply, Mpi2SasEnclosurePage0_t *config_page, u32 form, u32 handle)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_ENCLOSURE;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_SASENCLOSURE0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress = cpu_to_le32(form | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_phy_pg0(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\n\t*mpi_reply, Mpi2SasPhyPage0_t *config_page, u32 phy_number)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_PHY;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_SASPHY0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress =\n\t    cpu_to_le32(MPI2_SAS_PHY_PGAD_FORM_PHY_NUMBER | phy_number);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_phy_pg1(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\n\t*mpi_reply, Mpi2SasPhyPage1_t *config_page, u32 phy_number)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_PHY;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_SASPHY1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress =\n\t    cpu_to_le32(MPI2_SAS_PHY_PGAD_FORM_PHY_NUMBER | phy_number);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_raid_volume_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2RaidVolPage1_t *config_page, u32 form,\n\tu32 handle)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_RAID_VOLUME;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI2_RAIDVOLPAGE1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress = cpu_to_le32(form | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_number_pds(struct MPT3SAS_ADAPTER *ioc, u16 handle,\n\tu8 *num_pds)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tMpi2RaidVolPage0_t config_page;\n\tMpi2ConfigReply_t mpi_reply;\n\tint r;\n\tu16 ioc_status;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\t*num_pds = 0;\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_RAID_VOLUME;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_RAIDVOLPAGE0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, &mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress =\n\t    cpu_to_le32(MPI2_RAID_VOLUME_PGAD_FORM_HANDLE | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, &mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, &config_page,\n\t    sizeof(Mpi2RaidVolPage0_t));\n\tif (!r) {\n\t\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t\t    MPI2_IOCSTATUS_MASK;\n\t\tif (ioc_status == MPI2_IOCSTATUS_SUCCESS)\n\t\t\t*num_pds = config_page.NumPhysDisks;\n\t}\n\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_raid_volume_pg0(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi2RaidVolPage0_t *config_page, u32 form,\n\tu32 handle, u16 sz)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_RAID_VOLUME;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_RAIDVOLPAGE0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress = cpu_to_le32(form | handle);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_phys_disk_pg0(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\n\t*mpi_reply, Mpi2RaidPhysDiskPage0_t *config_page, u32 form,\n\tu32 form_specific)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_RAID_PHYSDISK;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI2_RAIDPHYSDISKPAGE0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.PageAddress = cpu_to_le32(form | form_specific);\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_driver_trigger_pg0(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage0_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nstatic int\n_config_set_driver_trigger_pg0(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage0_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 0;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE0_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\t_config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nstatic int\nmpt3sas_config_update_driver_trigger_pg0(struct MPT3SAS_ADAPTER *ioc,\n\tu16 trigger_flag, bool set)\n{\n\tMpi26DriverTriggerPage0_t tg_pg0;\n\tMpi2ConfigReply_t mpi_reply;\n\tint rc;\n\tu16 flags, ioc_status;\n\n\trc = mpt3sas_config_get_driver_trigger_pg0(ioc, &mpi_reply, &tg_pg0);\n\tif (rc)\n\t\treturn rc;\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to get trigger pg0, ioc_status(0x%04x)\\n\",\n\t\t    __func__, ioc_status));\n\t\treturn -EFAULT;\n\t}\n\n\tif (set)\n\t\tflags = le16_to_cpu(tg_pg0.TriggerFlags) | trigger_flag;\n\telse\n\t\tflags = le16_to_cpu(tg_pg0.TriggerFlags) & ~trigger_flag;\n\n\ttg_pg0.TriggerFlags = cpu_to_le16(flags);\n\n\trc = _config_set_driver_trigger_pg0(ioc, &mpi_reply, &tg_pg0);\n\tif (rc)\n\t\treturn rc;\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to update trigger pg0, ioc_status(0x%04x)\\n\",\n\t\t    __func__, ioc_status));\n\t\treturn -EFAULT;\n\t}\n\n\treturn 0;\n}\n\n \nint\nmpt3sas_config_get_driver_trigger_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage1_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nstatic int\n_config_set_driver_trigger_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage1_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 1;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE1_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\t_config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_update_driver_trigger_pg1(struct MPT3SAS_ADAPTER *ioc,\n\tstruct SL_WH_MASTER_TRIGGER_T *master_tg, bool set)\n{\n\tMpi26DriverTriggerPage1_t tg_pg1;\n\tMpi2ConfigReply_t mpi_reply;\n\tint rc;\n\tu16 ioc_status;\n\n\trc = mpt3sas_config_update_driver_trigger_pg0(ioc,\n\t    MPI26_DRIVER_TRIGGER0_FLAG_MASTER_TRIGGER_VALID, set);\n\tif (rc)\n\t\treturn rc;\n\n\trc = mpt3sas_config_get_driver_trigger_pg1(ioc, &mpi_reply, &tg_pg1);\n\tif (rc)\n\t\tgoto out;\n\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to get trigger pg1, ioc_status(0x%04x)\\n\",\n\t\t    __func__, ioc_status));\n\t\trc = -EFAULT;\n\t\tgoto out;\n\t}\n\n\tif (set) {\n\t\ttg_pg1.NumMasterTrigger = cpu_to_le16(1);\n\t\ttg_pg1.MasterTriggers[0].MasterTriggerFlags = cpu_to_le32(\n\t\t    master_tg->MasterData);\n\t} else {\n\t\ttg_pg1.NumMasterTrigger = 0;\n\t\ttg_pg1.MasterTriggers[0].MasterTriggerFlags = 0;\n\t}\n\n\trc = _config_set_driver_trigger_pg1(ioc, &mpi_reply, &tg_pg1);\n\tif (rc)\n\t\tgoto out;\n\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to get trigger pg1, ioc_status(0x%04x)\\n\",\n\t\t    __func__, ioc_status));\n\t\trc = -EFAULT;\n\t\tgoto out;\n\t}\n\n\treturn 0;\n\nout:\n\tmpt3sas_config_update_driver_trigger_pg0(ioc,\n\t    MPI26_DRIVER_TRIGGER0_FLAG_MASTER_TRIGGER_VALID, !set);\n\n\treturn rc;\n}\n\n \nint\nmpt3sas_config_get_driver_trigger_pg2(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage2_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 2;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE2_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nstatic int\n_config_set_driver_trigger_pg2(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage2_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 2;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE2_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\t_config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_update_driver_trigger_pg2(struct MPT3SAS_ADAPTER *ioc,\n\tstruct SL_WH_EVENT_TRIGGERS_T *event_tg, bool set)\n{\n\tMpi26DriverTriggerPage2_t tg_pg2;\n\tMpi2ConfigReply_t mpi_reply;\n\tint rc, i, count;\n\tu16 ioc_status;\n\n\trc = mpt3sas_config_update_driver_trigger_pg0(ioc,\n\t    MPI26_DRIVER_TRIGGER0_FLAG_MPI_EVENT_TRIGGER_VALID, set);\n\tif (rc)\n\t\treturn rc;\n\n\trc = mpt3sas_config_get_driver_trigger_pg2(ioc, &mpi_reply, &tg_pg2);\n\tif (rc)\n\t\tgoto out;\n\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to get trigger pg2, ioc_status(0x%04x)\\n\",\n\t\t    __func__, ioc_status));\n\t\trc = -EFAULT;\n\t\tgoto out;\n\t}\n\n\tif (set) {\n\t\tcount = event_tg->ValidEntries;\n\t\ttg_pg2.NumMPIEventTrigger = cpu_to_le16(count);\n\t\tfor (i = 0; i < count; i++) {\n\t\t\ttg_pg2.MPIEventTriggers[i].MPIEventCode =\n\t\t\t    cpu_to_le16(\n\t\t\t    event_tg->EventTriggerEntry[i].EventValue);\n\t\t\ttg_pg2.MPIEventTriggers[i].MPIEventCodeSpecific =\n\t\t\t    cpu_to_le16(\n\t\t\t    event_tg->EventTriggerEntry[i].LogEntryQualifier);\n\t\t}\n\t} else {\n\t\ttg_pg2.NumMPIEventTrigger = 0;\n\t\tmemset(&tg_pg2.MPIEventTriggers[0], 0,\n\t\t    NUM_VALID_ENTRIES * sizeof(\n\t\t    MPI26_DRIVER_MPI_EVENT_TIGGER_ENTRY));\n\t}\n\n\trc = _config_set_driver_trigger_pg2(ioc, &mpi_reply, &tg_pg2);\n\tif (rc)\n\t\tgoto out;\n\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to get trigger pg2, ioc_status(0x%04x)\\n\",\n\t\t    __func__, ioc_status));\n\t\trc = -EFAULT;\n\t\tgoto out;\n\t}\n\n\treturn 0;\n\nout:\n\tmpt3sas_config_update_driver_trigger_pg0(ioc,\n\t    MPI26_DRIVER_TRIGGER0_FLAG_MPI_EVENT_TRIGGER_VALID, !set);\n\n\treturn rc;\n}\n\n \nint\nmpt3sas_config_get_driver_trigger_pg3(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage3_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 3;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE3_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nstatic int\n_config_set_driver_trigger_pg3(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage3_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 3;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE3_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\t_config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_update_driver_trigger_pg3(struct MPT3SAS_ADAPTER *ioc,\n\tstruct SL_WH_SCSI_TRIGGERS_T *scsi_tg, bool set)\n{\n\tMpi26DriverTriggerPage3_t tg_pg3;\n\tMpi2ConfigReply_t mpi_reply;\n\tint rc, i, count;\n\tu16 ioc_status;\n\n\trc = mpt3sas_config_update_driver_trigger_pg0(ioc,\n\t    MPI26_DRIVER_TRIGGER0_FLAG_SCSI_SENSE_TRIGGER_VALID, set);\n\tif (rc)\n\t\treturn rc;\n\n\trc = mpt3sas_config_get_driver_trigger_pg3(ioc, &mpi_reply, &tg_pg3);\n\tif (rc)\n\t\tgoto out;\n\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to get trigger pg3, ioc_status(0x%04x)\\n\",\n\t\t    __func__, ioc_status));\n\t\treturn -EFAULT;\n\t}\n\n\tif (set) {\n\t\tcount = scsi_tg->ValidEntries;\n\t\ttg_pg3.NumSCSISenseTrigger = cpu_to_le16(count);\n\t\tfor (i = 0; i < count; i++) {\n\t\t\ttg_pg3.SCSISenseTriggers[i].ASCQ =\n\t\t\t    scsi_tg->SCSITriggerEntry[i].ASCQ;\n\t\t\ttg_pg3.SCSISenseTriggers[i].ASC =\n\t\t\t    scsi_tg->SCSITriggerEntry[i].ASC;\n\t\t\ttg_pg3.SCSISenseTriggers[i].SenseKey =\n\t\t\t    scsi_tg->SCSITriggerEntry[i].SenseKey;\n\t\t}\n\t} else {\n\t\ttg_pg3.NumSCSISenseTrigger = 0;\n\t\tmemset(&tg_pg3.SCSISenseTriggers[0], 0,\n\t\t    NUM_VALID_ENTRIES * sizeof(\n\t\t    MPI26_DRIVER_SCSI_SENSE_TIGGER_ENTRY));\n\t}\n\n\trc = _config_set_driver_trigger_pg3(ioc, &mpi_reply, &tg_pg3);\n\tif (rc)\n\t\tgoto out;\n\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to get trigger pg3, ioc_status(0x%04x)\\n\",\n\t\t     __func__, ioc_status));\n\t\treturn -EFAULT;\n\t}\n\n\treturn 0;\nout:\n\tmpt3sas_config_update_driver_trigger_pg0(ioc,\n\t    MPI26_DRIVER_TRIGGER0_FLAG_SCSI_SENSE_TRIGGER_VALID, !set);\n\n\treturn rc;\n}\n\n \nint\nmpt3sas_config_get_driver_trigger_pg4(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage4_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 4;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE4_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nstatic int\n_config_set_driver_trigger_pg4(struct MPT3SAS_ADAPTER *ioc,\n\tMpi2ConfigReply_t *mpi_reply, Mpi26DriverTriggerPage4_t *config_page)\n{\n\tMpi2ConfigRequest_t mpi_request;\n\tint r;\n\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType =\n\t    MPI2_CONFIG_EXTPAGETYPE_DRIVER_PERSISTENT_TRIGGER;\n\tmpi_request.Header.PageNumber = 4;\n\tmpi_request.Header.PageVersion = MPI26_DRIVER_TRIGGER_PAGE4_PAGEVERSION;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\n\t_config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM;\n\tr = _config_request(ioc, &mpi_request, mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t    sizeof(*config_page));\n out:\n\treturn r;\n}\n\n \nint\nmpt3sas_config_update_driver_trigger_pg4(struct MPT3SAS_ADAPTER *ioc,\n\tstruct SL_WH_MPI_TRIGGERS_T *mpi_tg, bool set)\n{\n\tMpi26DriverTriggerPage4_t tg_pg4;\n\tMpi2ConfigReply_t mpi_reply;\n\tint rc, i, count;\n\tu16 ioc_status;\n\n\trc = mpt3sas_config_update_driver_trigger_pg0(ioc,\n\t    MPI26_DRIVER_TRIGGER0_FLAG_LOGINFO_TRIGGER_VALID, set);\n\tif (rc)\n\t\treturn rc;\n\n\trc = mpt3sas_config_get_driver_trigger_pg4(ioc, &mpi_reply, &tg_pg4);\n\tif (rc)\n\t\tgoto out;\n\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to get trigger pg4, ioc_status(0x%04x)\\n\",\n\t\t    __func__, ioc_status));\n\t\trc = -EFAULT;\n\t\tgoto out;\n\t}\n\n\tif (set) {\n\t\tcount = mpi_tg->ValidEntries;\n\t\ttg_pg4.NumIOCStatusLogInfoTrigger = cpu_to_le16(count);\n\t\tfor (i = 0; i < count; i++) {\n\t\t\ttg_pg4.IOCStatusLoginfoTriggers[i].IOCStatus =\n\t\t\t    cpu_to_le16(mpi_tg->MPITriggerEntry[i].IOCStatus);\n\t\t\ttg_pg4.IOCStatusLoginfoTriggers[i].LogInfo =\n\t\t\t    cpu_to_le32(mpi_tg->MPITriggerEntry[i].IocLogInfo);\n\t\t}\n\t} else {\n\t\ttg_pg4.NumIOCStatusLogInfoTrigger = 0;\n\t\tmemset(&tg_pg4.IOCStatusLoginfoTriggers[0], 0,\n\t\t    NUM_VALID_ENTRIES * sizeof(\n\t\t    MPI26_DRIVER_IOCSTATUS_LOGINFO_TIGGER_ENTRY));\n\t}\n\n\trc = _config_set_driver_trigger_pg4(ioc, &mpi_reply, &tg_pg4);\n\tif (rc)\n\t\tgoto out;\n\n\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t    MPI2_IOCSTATUS_MASK;\n\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS) {\n\t\tdcprintk(ioc,\n\t\t    ioc_err(ioc,\n\t\t    \"%s: Failed to get trigger pg4, ioc_status(0x%04x)\\n\",\n\t\t    __func__, ioc_status));\n\t\trc = -EFAULT;\n\t\tgoto out;\n\t}\n\n\treturn 0;\n\nout:\n\tmpt3sas_config_update_driver_trigger_pg0(ioc,\n\t    MPI26_DRIVER_TRIGGER0_FLAG_LOGINFO_TRIGGER_VALID, !set);\n\n\treturn rc;\n}\n\n \nint\nmpt3sas_config_get_volume_handle(struct MPT3SAS_ADAPTER *ioc, u16 pd_handle,\n\tu16 *volume_handle)\n{\n\tMpi2RaidConfigurationPage0_t *config_page = NULL;\n\tMpi2ConfigRequest_t mpi_request;\n\tMpi2ConfigReply_t mpi_reply;\n\tint r, i, config_page_sz;\n\tu16 ioc_status;\n\tint config_num;\n\tu16 element_type;\n\tu16 phys_disk_dev_handle;\n\n\t*volume_handle = 0;\n\tmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\n\tmpi_request.Function = MPI2_FUNCTION_CONFIG;\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\n\tmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\n\tmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_RAID_CONFIG;\n\tmpi_request.Header.PageVersion = MPI2_RAIDCONFIG0_PAGEVERSION;\n\tmpi_request.Header.PageNumber = 0;\n\tioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\n\tr = _config_request(ioc, &mpi_request, &mpi_reply,\n\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\n\tif (r)\n\t\tgoto out;\n\n\tmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\n\tconfig_page_sz = (le16_to_cpu(mpi_reply.ExtPageLength) * 4);\n\tconfig_page = kmalloc(config_page_sz, GFP_KERNEL);\n\tif (!config_page) {\n\t\tr = -1;\n\t\tgoto out;\n\t}\n\n\tconfig_num = 0xff;\n\twhile (1) {\n\t\tmpi_request.PageAddress = cpu_to_le32(config_num +\n\t\t    MPI2_RAID_PGAD_FORM_GET_NEXT_CONFIGNUM);\n\t\tr = _config_request(ioc, &mpi_request, &mpi_reply,\n\t\t    MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\n\t\t    config_page_sz);\n\t\tif (r)\n\t\t\tgoto out;\n\t\tr = -1;\n\t\tioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\n\t\t    MPI2_IOCSTATUS_MASK;\n\t\tif (ioc_status != MPI2_IOCSTATUS_SUCCESS)\n\t\t\tgoto out;\n\t\tfor (i = 0; i < config_page->NumElements; i++) {\n\t\t\telement_type = le16_to_cpu(config_page->\n\t\t\t    ConfigElement[i].ElementFlags) &\n\t\t\t    MPI2_RAIDCONFIG0_EFLAGS_MASK_ELEMENT_TYPE;\n\t\t\tif (element_type ==\n\t\t\t    MPI2_RAIDCONFIG0_EFLAGS_VOL_PHYS_DISK_ELEMENT ||\n\t\t\t    element_type ==\n\t\t\t    MPI2_RAIDCONFIG0_EFLAGS_OCE_ELEMENT) {\n\t\t\t\tphys_disk_dev_handle =\n\t\t\t\t    le16_to_cpu(config_page->ConfigElement[i].\n\t\t\t\t    PhysDiskDevHandle);\n\t\t\t\tif (phys_disk_dev_handle == pd_handle) {\n\t\t\t\t\t*volume_handle =\n\t\t\t\t\t    le16_to_cpu(config_page->\n\t\t\t\t\t    ConfigElement[i].VolDevHandle);\n\t\t\t\t\tr = 0;\n\t\t\t\t\tgoto out;\n\t\t\t\t}\n\t\t\t} else if (element_type ==\n\t\t\t    MPI2_RAIDCONFIG0_EFLAGS_HOT_SPARE_ELEMENT) {\n\t\t\t\t*volume_handle = 0;\n\t\t\t\tr = 0;\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t}\n\t\tconfig_num = config_page->ConfigNum;\n\t}\n out:\n\tkfree(config_page);\n\treturn r;\n}\n\n \nint\nmpt3sas_config_get_volume_wwid(struct MPT3SAS_ADAPTER *ioc, u16 volume_handle,\n\tu64 *wwid)\n{\n\tMpi2ConfigReply_t mpi_reply;\n\tMpi2RaidVolPage1_t raid_vol_pg1;\n\n\t*wwid = 0;\n\tif (!(mpt3sas_config_get_raid_volume_pg1(ioc, &mpi_reply,\n\t    &raid_vol_pg1, MPI2_RAID_VOLUME_PGAD_FORM_HANDLE,\n\t    volume_handle))) {\n\t\t*wwid = le64_to_cpu(raid_vol_pg1.WWID);\n\t\treturn 0;\n\t} else\n\t\treturn -1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}