{
  "module_name": "sim710.c",
  "hash_id": "f27a104cb55a169a9c2d547fbd97c048996951b2facb7d7d000f65dbd446446a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/sim710.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n\n#include <linux/blkdev.h>\n#include <linux/device.h>\n#include <linux/init.h>\n#include <linux/eisa.h>\n#include <linux/interrupt.h>\n#include <scsi/scsi_host.h>\n#include <scsi/scsi_device.h>\n#include <scsi/scsi_transport.h>\n#include <scsi/scsi_transport_spi.h>\n\n#include \"53c700.h\"\n\n\n \n#define MAX_SLOTS 8\nstatic __u8 __initdata id_array[MAX_SLOTS] = { [0 ... MAX_SLOTS-1] = 7 };\n\nstatic char *sim710;\t\t \n\nMODULE_AUTHOR(\"Richard Hirst\");\nMODULE_DESCRIPTION(\"Simple NCR53C710 driver\");\nMODULE_LICENSE(\"GPL\");\n\nmodule_param(sim710, charp, 0);\n\n#ifdef MODULE\n#define ARG_SEP ' '\n#else\n#define ARG_SEP ','\n#endif\n\nstatic __init int\nparam_setup(char *str)\n{\n\tchar *pos = str, *next;\n\tint slot = -1;\n\n\twhile(pos != NULL && (next = strchr(pos, ':')) != NULL) {\n\t\tint val = (int)simple_strtoul(++next, NULL, 0);\n\n\t\tif(!strncmp(pos, \"slot:\", 5))\n\t\t\tslot = val;\n\t\telse if(!strncmp(pos, \"id:\", 3)) {\n\t\t\tif(slot == -1) {\n\t\t\t\tprintk(KERN_WARNING \"sim710: Must specify slot for id parameter\\n\");\n\t\t\t} else if(slot >= MAX_SLOTS) {\n\t\t\t\tprintk(KERN_WARNING \"sim710: Illegal slot %d for id %d\\n\", slot, val);\n\t\t\t} else {\n\t\t\t\tid_array[slot] = val;\n\t\t\t}\n\t\t}\n\t\tif((pos = strchr(pos, ARG_SEP)) != NULL)\n\t\t\tpos++;\n\t}\n\treturn 1;\n}\n__setup(\"sim710=\", param_setup);\n\nstatic struct scsi_host_template sim710_driver_template = {\n\t.name\t\t\t= \"LSI (Symbios) 710 EISA\",\n\t.proc_name\t\t= \"sim710\",\n\t.this_id\t\t= 7,\n\t.module\t\t\t= THIS_MODULE,\n};\n\nstatic int sim710_probe_common(struct device *dev, unsigned long base_addr,\n\t\t\t       int irq, int clock, int differential,\n\t\t\t       int scsi_id)\n{\n\tstruct Scsi_Host * host = NULL;\n\tstruct NCR_700_Host_Parameters *hostdata =\n\t\tkzalloc(sizeof(struct NCR_700_Host_Parameters),\tGFP_KERNEL);\n\n\tprintk(KERN_NOTICE \"sim710: %s\\n\", dev_name(dev));\n\tprintk(KERN_NOTICE \"sim710: irq = %d, clock = %d, base = 0x%lx, scsi_id = %d\\n\",\n\t       irq, clock, base_addr, scsi_id);\n\n\tif(hostdata == NULL) {\n\t\tprintk(KERN_ERR \"sim710: Failed to allocate host data\\n\");\n\t\tgoto out;\n\t}\n\n\tif(request_region(base_addr, 64, \"sim710\") == NULL) {\n\t\tprintk(KERN_ERR \"sim710: Failed to reserve IO region 0x%lx\\n\",\n\t\t       base_addr);\n\t\tgoto out_free;\n\t}\n\n\t \n\thostdata->base = ioport_map(base_addr, 64);\n\thostdata->differential = differential;\n\thostdata->clock = clock;\n\thostdata->chip710 = 1;\n\thostdata->burst_length = 8;\n\n\t \n\tif((host = NCR_700_detect(&sim710_driver_template, hostdata, dev))\n\t   == NULL) {\n\t\tprintk(KERN_ERR \"sim710: No host detected; card configuration problem?\\n\");\n\t\tgoto out_release;\n\t}\n\thost->this_id = scsi_id;\n\thost->base = base_addr;\n\thost->irq = irq;\n\tif (request_irq(irq, NCR_700_intr, IRQF_SHARED, \"sim710\", host)) {\n\t\tprintk(KERN_ERR \"sim710: request_irq failed\\n\");\n\t\tgoto out_put_host;\n\t}\n\n\tdev_set_drvdata(dev, host);\n\tscsi_scan_host(host);\n\n\treturn 0;\n\n out_put_host:\n\tscsi_host_put(host);\n out_release:\n\trelease_region(base_addr, 64);\n out_free:\n\tkfree(hostdata);\n out:\n\treturn -ENODEV;\n}\n\nstatic int sim710_device_remove(struct device *dev)\n{\n\tstruct Scsi_Host *host = dev_get_drvdata(dev);\n\tstruct NCR_700_Host_Parameters *hostdata =\n\t\t(struct NCR_700_Host_Parameters *)host->hostdata[0];\n\n\tscsi_remove_host(host);\n\tNCR_700_release(host);\n\tkfree(hostdata);\n\tfree_irq(host->irq, host);\n\trelease_region(host->base, 64);\n\treturn 0;\n}\n\n#ifdef CONFIG_EISA\nstatic struct eisa_device_id sim710_eisa_ids[] = {\n\t{ \"CPQ4410\" },\n\t{ \"CPQ4411\" },\n\t{ \"HWP0C80\" },\n\t{ \"\" }\n};\nMODULE_DEVICE_TABLE(eisa, sim710_eisa_ids);\n\nstatic int sim710_eisa_probe(struct device *dev)\n{\n\tstruct eisa_device *edev = to_eisa_device(dev);\n\tunsigned long io_addr = edev->base_addr;\n\tchar eisa_cpq_irqs[] = { 11, 14, 15, 10, 9, 0 };\n\tchar eisa_hwp_irqs[] = { 3, 4, 5, 7, 12, 10, 11, 0};\n\tchar *eisa_irqs;\n\tunsigned char irq_index;\n\tunsigned char irq, differential = 0, scsi_id = 7;\n\n\tif(strcmp(edev->id.sig, \"HWP0C80\") == 0) {\n\t\t__u8 val;\n\t\teisa_irqs =  eisa_hwp_irqs;\n\t\tirq_index = (inb(io_addr + 0xc85) & 0x7) - 1;\n\n\t\tval = inb(io_addr + 0x4);\n\t\tscsi_id = ffs(val) - 1;\n\n\t\tif(scsi_id > 7 || (val & ~(1<<scsi_id)) != 0) {\n\t\t\tprintk(KERN_ERR \"sim710.c, EISA card %s has incorrect scsi_id, setting to 7\\n\", dev_name(dev));\n\t\t\tscsi_id = 7;\n\t\t}\n\t} else {\n\t\teisa_irqs = eisa_cpq_irqs;\n\t\tirq_index = inb(io_addr + 0xc88) & 0x07;\n\t}\n\n\tif(irq_index >= strlen(eisa_irqs)) {\n\t\tprintk(\"sim710.c: irq nasty\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tirq = eisa_irqs[irq_index];\n\t\t\n\treturn sim710_probe_common(dev, io_addr, irq, 50,\n\t\t\t\t   differential, scsi_id);\n}\n\nstatic struct eisa_driver sim710_eisa_driver = {\n\t.id_table\t\t= sim710_eisa_ids,\n\t.driver = {\n\t\t.name\t\t= \"sim710\",\n\t\t.probe\t\t= sim710_eisa_probe,\n\t\t.remove\t\t= sim710_device_remove,\n\t},\n};\n#endif  \n\nstatic int __init sim710_init(void)\n{\n#ifdef MODULE\n\tif (sim710)\n\t\tparam_setup(sim710);\n#endif\n\n#ifdef CONFIG_EISA\n\t \n\teisa_driver_register(&sim710_eisa_driver);\n#endif\n\treturn 0;\n}\n\nstatic void __exit sim710_exit(void)\n{\n#ifdef CONFIG_EISA\n\teisa_driver_unregister(&sim710_eisa_driver);\n#endif\n}\n\nmodule_init(sim710_init);\nmodule_exit(sim710_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}