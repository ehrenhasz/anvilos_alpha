{
  "module_name": "csio_hw_t5.c",
  "hash_id": "9d4486df9f21f59c650d949956863c78482d1fd48dc9f997cde27e3e5273f99c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/csiostor/csio_hw_t5.c",
  "human_readable_source": " \n\n#include \"csio_hw.h\"\n#include \"csio_init.h\"\n\nstatic int\ncsio_t5_set_mem_win(struct csio_hw *hw, uint32_t win)\n{\n\tu32 mem_win_base;\n\t \n\n\t \n\tmem_win_base = MEMWIN_BASE;\n\n\t \n\tcsio_wr_reg32(hw, mem_win_base | BIR_V(0) |\n\t\t\t  WINDOW_V(ilog2(MEMWIN_APERTURE) - 10),\n\t\t\t  PCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_BASE_WIN_A, win));\n\tcsio_rd_reg32(hw,\n\t\t      PCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_BASE_WIN_A, win));\n\n\treturn 0;\n}\n\n \nstatic void\ncsio_t5_pcie_intr_handler(struct csio_hw *hw)\n{\n\tstatic struct intr_info pcie_intr_info[] = {\n\t\t{ MSTGRPPERR_F, \"Master Response Read Queue parity error\",\n\t\t-1, 1 },\n\t\t{ MSTTIMEOUTPERR_F, \"Master Timeout FIFO parity error\", -1, 1 },\n\t\t{ MSIXSTIPERR_F, \"MSI-X STI SRAM parity error\", -1, 1 },\n\t\t{ MSIXADDRLPERR_F, \"MSI-X AddrL parity error\", -1, 1 },\n\t\t{ MSIXADDRHPERR_F, \"MSI-X AddrH parity error\", -1, 1 },\n\t\t{ MSIXDATAPERR_F, \"MSI-X data parity error\", -1, 1 },\n\t\t{ MSIXDIPERR_F, \"MSI-X DI parity error\", -1, 1 },\n\t\t{ PIOCPLGRPPERR_F, \"PCI PIO completion Group FIFO parity error\",\n\t\t-1, 1 },\n\t\t{ PIOREQGRPPERR_F, \"PCI PIO request Group FIFO parity error\",\n\t\t-1, 1 },\n\t\t{ TARTAGPERR_F, \"PCI PCI target tag FIFO parity error\", -1, 1 },\n\t\t{ MSTTAGQPERR_F, \"PCI master tag queue parity error\", -1, 1 },\n\t\t{ CREQPERR_F, \"PCI CMD channel request parity error\", -1, 1 },\n\t\t{ CRSPPERR_F, \"PCI CMD channel response parity error\", -1, 1 },\n\t\t{ DREQWRPERR_F, \"PCI DMA channel write request parity error\",\n\t\t-1, 1 },\n\t\t{ DREQPERR_F, \"PCI DMA channel request parity error\", -1, 1 },\n\t\t{ DRSPPERR_F, \"PCI DMA channel response parity error\", -1, 1 },\n\t\t{ HREQWRPERR_F, \"PCI HMA channel count parity error\", -1, 1 },\n\t\t{ HREQPERR_F, \"PCI HMA channel request parity error\", -1, 1 },\n\t\t{ HRSPPERR_F, \"PCI HMA channel response parity error\", -1, 1 },\n\t\t{ CFGSNPPERR_F, \"PCI config snoop FIFO parity error\", -1, 1 },\n\t\t{ FIDPERR_F, \"PCI FID parity error\", -1, 1 },\n\t\t{ VFIDPERR_F, \"PCI INTx clear parity error\", -1, 1 },\n\t\t{ MAGRPPERR_F, \"PCI MA group FIFO parity error\", -1, 1 },\n\t\t{ PIOTAGPERR_F, \"PCI PIO tag parity error\", -1, 1 },\n\t\t{ IPRXHDRGRPPERR_F, \"PCI IP Rx header group parity error\",\n\t\t-1, 1 },\n\t\t{ IPRXDATAGRPPERR_F, \"PCI IP Rx data group parity error\",\n\t\t-1, 1 },\n\t\t{ RPLPERR_F, \"PCI IP replay buffer parity error\", -1, 1 },\n\t\t{ IPSOTPERR_F, \"PCI IP SOT buffer parity error\", -1, 1 },\n\t\t{ TRGT1GRPPERR_F, \"PCI TRGT1 group FIFOs parity error\", -1, 1 },\n\t\t{ READRSPERR_F, \"Outbound read error\", -1, 0 },\n\t\t{ 0, NULL, 0, 0 }\n\t};\n\n\tint fat;\n\tfat = csio_handle_intr_status(hw, PCIE_INT_CAUSE_A, pcie_intr_info);\n\tif (fat)\n\t\tcsio_hw_fatal_err(hw);\n}\n\n \nstatic unsigned int\ncsio_t5_flash_cfg_addr(struct csio_hw *hw)\n{\n\treturn FLASH_CFG_START;\n}\n\n \nstatic int\ncsio_t5_mc_read(struct csio_hw *hw, int idx, uint32_t addr, __be32 *data,\n\t\tuint64_t *ecc)\n{\n\tint i;\n\tuint32_t mc_bist_cmd_reg, mc_bist_cmd_addr_reg, mc_bist_cmd_len_reg;\n\tuint32_t mc_bist_data_pattern_reg;\n\n\tmc_bist_cmd_reg = MC_REG(MC_P_BIST_CMD_A, idx);\n\tmc_bist_cmd_addr_reg = MC_REG(MC_P_BIST_CMD_ADDR_A, idx);\n\tmc_bist_cmd_len_reg = MC_REG(MC_P_BIST_CMD_LEN_A, idx);\n\tmc_bist_data_pattern_reg = MC_REG(MC_P_BIST_DATA_PATTERN_A, idx);\n\n\tif (csio_rd_reg32(hw, mc_bist_cmd_reg) & START_BIST_F)\n\t\treturn -EBUSY;\n\tcsio_wr_reg32(hw, addr & ~0x3fU, mc_bist_cmd_addr_reg);\n\tcsio_wr_reg32(hw, 64, mc_bist_cmd_len_reg);\n\tcsio_wr_reg32(hw, 0xc, mc_bist_data_pattern_reg);\n\tcsio_wr_reg32(hw, BIST_OPCODE_V(1) | START_BIST_F |  BIST_CMD_GAP_V(1),\n\t\t      mc_bist_cmd_reg);\n\ti = csio_hw_wait_op_done_val(hw, mc_bist_cmd_reg, START_BIST_F,\n\t\t\t\t     0, 10, 1, NULL);\n\tif (i)\n\t\treturn i;\n\n#define MC_DATA(i) MC_BIST_STATUS_REG(MC_BIST_STATUS_RDATA_A, i)\n\n\tfor (i = 15; i >= 0; i--)\n\t\t*data++ = htonl(csio_rd_reg32(hw, MC_DATA(i)));\n\tif (ecc)\n\t\t*ecc = csio_rd_reg64(hw, MC_DATA(16));\n#undef MC_DATA\n\treturn 0;\n}\n\n \nstatic int\ncsio_t5_edc_read(struct csio_hw *hw, int idx, uint32_t addr, __be32 *data,\n\t\tuint64_t *ecc)\n{\n\tint i;\n\tuint32_t edc_bist_cmd_reg, edc_bist_cmd_addr_reg, edc_bist_cmd_len_reg;\n\tuint32_t edc_bist_cmd_data_pattern;\n\n \n#define EDC_STRIDE_T5 (EDC_T51_BASE_ADDR - EDC_T50_BASE_ADDR)\n#define EDC_REG_T5(reg, idx) (reg + EDC_STRIDE_T5 * idx)\n\n\tedc_bist_cmd_reg = EDC_REG_T5(EDC_H_BIST_CMD_A, idx);\n\tedc_bist_cmd_addr_reg = EDC_REG_T5(EDC_H_BIST_CMD_ADDR_A, idx);\n\tedc_bist_cmd_len_reg = EDC_REG_T5(EDC_H_BIST_CMD_LEN_A, idx);\n\tedc_bist_cmd_data_pattern = EDC_REG_T5(EDC_H_BIST_DATA_PATTERN_A, idx);\n#undef EDC_REG_T5\n#undef EDC_STRIDE_T5\n\n\tif (csio_rd_reg32(hw, edc_bist_cmd_reg) & START_BIST_F)\n\t\treturn -EBUSY;\n\tcsio_wr_reg32(hw, addr & ~0x3fU, edc_bist_cmd_addr_reg);\n\tcsio_wr_reg32(hw, 64, edc_bist_cmd_len_reg);\n\tcsio_wr_reg32(hw, 0xc, edc_bist_cmd_data_pattern);\n\tcsio_wr_reg32(hw, BIST_OPCODE_V(1) | START_BIST_F |  BIST_CMD_GAP_V(1),\n\t\t      edc_bist_cmd_reg);\n\ti = csio_hw_wait_op_done_val(hw, edc_bist_cmd_reg, START_BIST_F,\n\t\t\t\t     0, 10, 1, NULL);\n\tif (i)\n\t\treturn i;\n\n#define EDC_DATA(i) (EDC_BIST_STATUS_REG(EDC_BIST_STATUS_RDATA_A, i) + idx)\n\n\tfor (i = 15; i >= 0; i--)\n\t\t*data++ = htonl(csio_rd_reg32(hw, EDC_DATA(i)));\n\tif (ecc)\n\t\t*ecc = csio_rd_reg64(hw, EDC_DATA(16));\n#undef EDC_DATA\n\treturn 0;\n}\n\n \nstatic int\ncsio_t5_memory_rw(struct csio_hw *hw, u32 win, int mtype, u32 addr,\n\t\tu32 len, uint32_t *buf, int dir)\n{\n\tu32 pos, start, offset, memoffset;\n\tu32 edc_size, mc_size, win_pf, mem_reg, mem_aperture, mem_base;\n\n\t \n\tif ((addr & 0x3) || (len & 0x3))\n\t\treturn -EINVAL;\n\n\t \n\tedc_size  = EDRAM0_SIZE_G(csio_rd_reg32(hw, MA_EDRAM0_BAR_A));\n\tif (mtype != MEM_MC1)\n\t\tmemoffset = (mtype * (edc_size * 1024 * 1024));\n\telse {\n\t\tmc_size = EXT_MEM_SIZE_G(csio_rd_reg32(hw,\n\t\t\t\t\t\t       MA_EXT_MEMORY_BAR_A));\n\t\tmemoffset = (MEM_MC0 * edc_size + mc_size) * 1024 * 1024;\n\t}\n\n\t \n\taddr = addr + memoffset;\n\n\t \n\tmem_reg = csio_rd_reg32(hw,\n\t\t\tPCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_BASE_WIN_A, win));\n\tmem_aperture = 1 << (WINDOW_V(mem_reg) + 10);\n\tmem_base = PCIEOFST_G(mem_reg) << 10;\n\n\tstart = addr & ~(mem_aperture-1);\n\toffset = addr - start;\n\twin_pf = PFNUM_V(hw->pfn);\n\n\tcsio_dbg(hw, \"csio_t5_memory_rw: mem_reg: 0x%x, mem_aperture: 0x%x\\n\",\n\t\t mem_reg, mem_aperture);\n\tcsio_dbg(hw, \"csio_t5_memory_rw: mem_base: 0x%x, mem_offset: 0x%x\\n\",\n\t\t mem_base, memoffset);\n\tcsio_dbg(hw, \"csio_t5_memory_rw: start:0x%x, offset:0x%x, win_pf:%d\\n\",\n\t\t start, offset, win_pf);\n\tcsio_dbg(hw, \"csio_t5_memory_rw: mtype: %d, addr: 0x%x, len: %d\\n\",\n\t\t mtype, addr, len);\n\n\tfor (pos = start; len > 0; pos += mem_aperture, offset = 0) {\n\t\t \n\t\tcsio_wr_reg32(hw, pos | win_pf,\n\t\t\tPCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_OFFSET_A, win));\n\t\tcsio_rd_reg32(hw,\n\t\t\tPCIE_MEM_ACCESS_REG(PCIE_MEM_ACCESS_OFFSET_A, win));\n\n\t\twhile (offset < mem_aperture && len > 0) {\n\t\t\tif (dir)\n\t\t\t\t*buf++ = csio_rd_reg32(hw, mem_base + offset);\n\t\t\telse\n\t\t\t\tcsio_wr_reg32(hw, *buf++, mem_base + offset);\n\n\t\t\toffset += sizeof(__be32);\n\t\t\tlen -= sizeof(__be32);\n\t\t}\n\t}\n\treturn 0;\n}\n\n \nstatic void\ncsio_t5_dfs_create_ext_mem(struct csio_hw *hw)\n{\n\tu32 size;\n\tint i = csio_rd_reg32(hw, MA_TARGET_MEM_ENABLE_A);\n\n\tif (i & EXT_MEM_ENABLE_F) {\n\t\tsize = csio_rd_reg32(hw, MA_EXT_MEMORY_BAR_A);\n\t\tcsio_add_debugfs_mem(hw, \"mc0\", MEM_MC0,\n\t\t\t\t     EXT_MEM_SIZE_G(size));\n\t}\n\tif (i & EXT_MEM1_ENABLE_F) {\n\t\tsize = csio_rd_reg32(hw, MA_EXT_MEMORY1_BAR_A);\n\t\tcsio_add_debugfs_mem(hw, \"mc1\", MEM_MC1,\n\t\t\t\t     EXT_MEM_SIZE_G(size));\n\t}\n}\n\n \nstruct csio_hw_chip_ops t5_ops = {\n\t.chip_set_mem_win\t\t= csio_t5_set_mem_win,\n\t.chip_pcie_intr_handler\t\t= csio_t5_pcie_intr_handler,\n\t.chip_flash_cfg_addr\t\t= csio_t5_flash_cfg_addr,\n\t.chip_mc_read\t\t\t= csio_t5_mc_read,\n\t.chip_edc_read\t\t\t= csio_t5_edc_read,\n\t.chip_memory_rw\t\t\t= csio_t5_memory_rw,\n\t.chip_dfs_create_ext_mem\t= csio_t5_dfs_create_ext_mem,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}