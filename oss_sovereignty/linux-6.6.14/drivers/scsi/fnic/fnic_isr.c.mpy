{
  "module_name": "fnic_isr.c",
  "hash_id": "11f860e1eab9a730f759d862135fff83541843dcbe612d0480ed07455a59afa4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/fnic/fnic_isr.c",
  "human_readable_source": "\n \n#include <linux/string.h>\n#include <linux/errno.h>\n#include <linux/pci.h>\n#include <linux/interrupt.h>\n#include <scsi/libfc.h>\n#include <scsi/fc_frame.h>\n#include \"vnic_dev.h\"\n#include \"vnic_intr.h\"\n#include \"vnic_stats.h\"\n#include \"fnic_io.h\"\n#include \"fnic.h\"\n\nstatic irqreturn_t fnic_isr_legacy(int irq, void *data)\n{\n\tstruct fnic *fnic = data;\n\tu32 pba;\n\tunsigned long work_done = 0;\n\n\tpba = vnic_intr_legacy_pba(fnic->legacy_pba);\n\tif (!pba)\n\t\treturn IRQ_NONE;\n\n\tfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\n\tatomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\n\n\tif (pba & (1 << FNIC_INTX_NOTIFY)) {\n\t\tvnic_intr_return_all_credits(&fnic->intr[FNIC_INTX_NOTIFY]);\n\t\tfnic_handle_link_event(fnic);\n\t}\n\n\tif (pba & (1 << FNIC_INTX_ERR)) {\n\t\tvnic_intr_return_all_credits(&fnic->intr[FNIC_INTX_ERR]);\n\t\tfnic_log_q_error(fnic);\n\t}\n\n\tif (pba & (1 << FNIC_INTX_WQ_RQ_COPYWQ)) {\n\t\twork_done += fnic_wq_copy_cmpl_handler(fnic, io_completions);\n\t\twork_done += fnic_wq_cmpl_handler(fnic, -1);\n\t\twork_done += fnic_rq_cmpl_handler(fnic, -1);\n\n\t\tvnic_intr_return_credits(&fnic->intr[FNIC_INTX_WQ_RQ_COPYWQ],\n\t\t\t\t\t work_done,\n\t\t\t\t\t 1  ,\n\t\t\t\t\t 1  );\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t fnic_isr_msi(int irq, void *data)\n{\n\tstruct fnic *fnic = data;\n\tunsigned long work_done = 0;\n\n\tfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\n\tatomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\n\n\twork_done += fnic_wq_copy_cmpl_handler(fnic, io_completions);\n\twork_done += fnic_wq_cmpl_handler(fnic, -1);\n\twork_done += fnic_rq_cmpl_handler(fnic, -1);\n\n\tvnic_intr_return_credits(&fnic->intr[0],\n\t\t\t\t work_done,\n\t\t\t\t 1  ,\n\t\t\t\t 1  );\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t fnic_isr_msix_rq(int irq, void *data)\n{\n\tstruct fnic *fnic = data;\n\tunsigned long rq_work_done = 0;\n\n\tfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\n\tatomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\n\n\trq_work_done = fnic_rq_cmpl_handler(fnic, -1);\n\tvnic_intr_return_credits(&fnic->intr[FNIC_MSIX_RQ],\n\t\t\t\t rq_work_done,\n\t\t\t\t 1  ,\n\t\t\t\t 1  );\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t fnic_isr_msix_wq(int irq, void *data)\n{\n\tstruct fnic *fnic = data;\n\tunsigned long wq_work_done = 0;\n\n\tfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\n\tatomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\n\n\twq_work_done = fnic_wq_cmpl_handler(fnic, -1);\n\tvnic_intr_return_credits(&fnic->intr[FNIC_MSIX_WQ],\n\t\t\t\t wq_work_done,\n\t\t\t\t 1  ,\n\t\t\t\t 1  );\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t fnic_isr_msix_wq_copy(int irq, void *data)\n{\n\tstruct fnic *fnic = data;\n\tunsigned long wq_copy_work_done = 0;\n\n\tfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\n\tatomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\n\n\twq_copy_work_done = fnic_wq_copy_cmpl_handler(fnic, io_completions);\n\tvnic_intr_return_credits(&fnic->intr[FNIC_MSIX_WQ_COPY],\n\t\t\t\t wq_copy_work_done,\n\t\t\t\t 1  ,\n\t\t\t\t 1  );\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t fnic_isr_msix_err_notify(int irq, void *data)\n{\n\tstruct fnic *fnic = data;\n\n\tfnic->fnic_stats.misc_stats.last_isr_time = jiffies;\n\tatomic64_inc(&fnic->fnic_stats.misc_stats.isr_count);\n\n\tvnic_intr_return_all_credits(&fnic->intr[FNIC_MSIX_ERR_NOTIFY]);\n\tfnic_log_q_error(fnic);\n\tfnic_handle_link_event(fnic);\n\n\treturn IRQ_HANDLED;\n}\n\nvoid fnic_free_intr(struct fnic *fnic)\n{\n\tint i;\n\n\tswitch (vnic_dev_get_intr_mode(fnic->vdev)) {\n\tcase VNIC_DEV_INTR_MODE_INTX:\n\tcase VNIC_DEV_INTR_MODE_MSI:\n\t\tfree_irq(pci_irq_vector(fnic->pdev, 0), fnic);\n\t\tbreak;\n\n\tcase VNIC_DEV_INTR_MODE_MSIX:\n\t\tfor (i = 0; i < ARRAY_SIZE(fnic->msix); i++)\n\t\t\tif (fnic->msix[i].requested)\n\t\t\t\tfree_irq(pci_irq_vector(fnic->pdev, i),\n\t\t\t\t\t fnic->msix[i].devid);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nint fnic_request_intr(struct fnic *fnic)\n{\n\tint err = 0;\n\tint i;\n\n\tswitch (vnic_dev_get_intr_mode(fnic->vdev)) {\n\n\tcase VNIC_DEV_INTR_MODE_INTX:\n\t\terr = request_irq(pci_irq_vector(fnic->pdev, 0),\n\t\t\t\t&fnic_isr_legacy, IRQF_SHARED, DRV_NAME, fnic);\n\t\tbreak;\n\n\tcase VNIC_DEV_INTR_MODE_MSI:\n\t\terr = request_irq(pci_irq_vector(fnic->pdev, 0), &fnic_isr_msi,\n\t\t\t\t  0, fnic->name, fnic);\n\t\tbreak;\n\n\tcase VNIC_DEV_INTR_MODE_MSIX:\n\n\t\tsprintf(fnic->msix[FNIC_MSIX_RQ].devname,\n\t\t\t\"%.11s-fcs-rq\", fnic->name);\n\t\tfnic->msix[FNIC_MSIX_RQ].isr = fnic_isr_msix_rq;\n\t\tfnic->msix[FNIC_MSIX_RQ].devid = fnic;\n\n\t\tsprintf(fnic->msix[FNIC_MSIX_WQ].devname,\n\t\t\t\"%.11s-fcs-wq\", fnic->name);\n\t\tfnic->msix[FNIC_MSIX_WQ].isr = fnic_isr_msix_wq;\n\t\tfnic->msix[FNIC_MSIX_WQ].devid = fnic;\n\n\t\tsprintf(fnic->msix[FNIC_MSIX_WQ_COPY].devname,\n\t\t\t\"%.11s-scsi-wq\", fnic->name);\n\t\tfnic->msix[FNIC_MSIX_WQ_COPY].isr = fnic_isr_msix_wq_copy;\n\t\tfnic->msix[FNIC_MSIX_WQ_COPY].devid = fnic;\n\n\t\tsprintf(fnic->msix[FNIC_MSIX_ERR_NOTIFY].devname,\n\t\t\t\"%.11s-err-notify\", fnic->name);\n\t\tfnic->msix[FNIC_MSIX_ERR_NOTIFY].isr =\n\t\t\tfnic_isr_msix_err_notify;\n\t\tfnic->msix[FNIC_MSIX_ERR_NOTIFY].devid = fnic;\n\n\t\tfor (i = 0; i < ARRAY_SIZE(fnic->msix); i++) {\n\t\t\terr = request_irq(pci_irq_vector(fnic->pdev, i),\n\t\t\t\t\t  fnic->msix[i].isr, 0,\n\t\t\t\t\t  fnic->msix[i].devname,\n\t\t\t\t\t  fnic->msix[i].devid);\n\t\t\tif (err) {\n\t\t\t\tshost_printk(KERN_ERR, fnic->lport->host,\n\t\t\t\t\t     \"MSIX: request_irq\"\n\t\t\t\t\t     \" failed %d\\n\", err);\n\t\t\t\tfnic_free_intr(fnic);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tfnic->msix[i].requested = 1;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn err;\n}\n\nint fnic_set_intr_mode(struct fnic *fnic)\n{\n\tunsigned int n = ARRAY_SIZE(fnic->rq);\n\tunsigned int m = ARRAY_SIZE(fnic->wq);\n\tunsigned int o = ARRAY_SIZE(fnic->wq_copy);\n\n\t \n\tif (fnic->rq_count >= n &&\n\t    fnic->raw_wq_count >= m &&\n\t    fnic->wq_copy_count >= o &&\n\t    fnic->cq_count >= n + m + o) {\n\t\tint vecs = n + m + o + 1;\n\n\t\tif (pci_alloc_irq_vectors(fnic->pdev, vecs, vecs,\n\t\t\t\tPCI_IRQ_MSIX) == vecs) {\n\t\t\tfnic->rq_count = n;\n\t\t\tfnic->raw_wq_count = m;\n\t\t\tfnic->wq_copy_count = o;\n\t\t\tfnic->wq_count = m + o;\n\t\t\tfnic->cq_count = n + m + o;\n\t\t\tfnic->intr_count = vecs;\n\t\t\tfnic->err_intr_offset = FNIC_MSIX_ERR_NOTIFY;\n\n\t\t\tFNIC_ISR_DBG(KERN_DEBUG, fnic->lport->host,\n\t\t\t\t     \"Using MSI-X Interrupts\\n\");\n\t\t\tvnic_dev_set_intr_mode(fnic->vdev,\n\t\t\t\t\t       VNIC_DEV_INTR_MODE_MSIX);\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\t \n\tif (fnic->rq_count >= 1 &&\n\t    fnic->raw_wq_count >= 1 &&\n\t    fnic->wq_copy_count >= 1 &&\n\t    fnic->cq_count >= 3 &&\n\t    fnic->intr_count >= 1 &&\n\t    pci_alloc_irq_vectors(fnic->pdev, 1, 1, PCI_IRQ_MSI) == 1) {\n\t\tfnic->rq_count = 1;\n\t\tfnic->raw_wq_count = 1;\n\t\tfnic->wq_copy_count = 1;\n\t\tfnic->wq_count = 2;\n\t\tfnic->cq_count = 3;\n\t\tfnic->intr_count = 1;\n\t\tfnic->err_intr_offset = 0;\n\n\t\tFNIC_ISR_DBG(KERN_DEBUG, fnic->lport->host,\n\t\t\t     \"Using MSI Interrupts\\n\");\n\t\tvnic_dev_set_intr_mode(fnic->vdev, VNIC_DEV_INTR_MODE_MSI);\n\n\t\treturn 0;\n\t}\n\n\t \n\n\tif (fnic->rq_count >= 1 &&\n\t    fnic->raw_wq_count >= 1 &&\n\t    fnic->wq_copy_count >= 1 &&\n\t    fnic->cq_count >= 3 &&\n\t    fnic->intr_count >= 3) {\n\n\t\tfnic->rq_count = 1;\n\t\tfnic->raw_wq_count = 1;\n\t\tfnic->wq_copy_count = 1;\n\t\tfnic->cq_count = 3;\n\t\tfnic->intr_count = 3;\n\n\t\tFNIC_ISR_DBG(KERN_DEBUG, fnic->lport->host,\n\t\t\t     \"Using Legacy Interrupts\\n\");\n\t\tvnic_dev_set_intr_mode(fnic->vdev, VNIC_DEV_INTR_MODE_INTX);\n\n\t\treturn 0;\n\t}\n\n\tvnic_dev_set_intr_mode(fnic->vdev, VNIC_DEV_INTR_MODE_UNKNOWN);\n\n\treturn -EINVAL;\n}\n\nvoid fnic_clear_intr_mode(struct fnic *fnic)\n{\n\tpci_free_irq_vectors(fnic->pdev);\n\tvnic_dev_set_intr_mode(fnic->vdev, VNIC_DEV_INTR_MODE_INTX);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}