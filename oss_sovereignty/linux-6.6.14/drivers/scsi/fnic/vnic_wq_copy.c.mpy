{
  "module_name": "vnic_wq_copy.c",
  "hash_id": "09f776096746cda65e8da777fb9457e3ab3c19eeb0d56c26d5a9bf75d55926e1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/fnic/vnic_wq_copy.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include <linux/types.h>\n#include <linux/pci.h>\n#include <linux/delay.h>\n#include \"vnic_wq_copy.h\"\n\nvoid vnic_wq_copy_enable(struct vnic_wq_copy *wq)\n{\n\tiowrite32(1, &wq->ctrl->enable);\n}\n\nint vnic_wq_copy_disable(struct vnic_wq_copy *wq)\n{\n\tunsigned int wait;\n\n\tiowrite32(0, &wq->ctrl->enable);\n\n\t \n\tfor (wait = 0; wait < 100; wait++) {\n\t\tif (!(ioread32(&wq->ctrl->running)))\n\t\t\treturn 0;\n\t\tudelay(1);\n\t}\n\n\tprintk(KERN_ERR \"Failed to disable Copy WQ[%d],\"\n\t       \" fetch index=%d, posted_index=%d\\n\",\n\t       wq->index, ioread32(&wq->ctrl->fetch_index),\n\t       ioread32(&wq->ctrl->posted_index));\n\n\treturn -ENODEV;\n}\n\nvoid vnic_wq_copy_clean(struct vnic_wq_copy *wq,\n\tvoid (*q_clean)(struct vnic_wq_copy *wq,\n\tstruct fcpio_host_req *wq_desc))\n{\n\tBUG_ON(ioread32(&wq->ctrl->enable));\n\n\tif (vnic_wq_copy_desc_in_use(wq))\n\t\tvnic_wq_copy_service(wq, -1, q_clean);\n\n\twq->to_use_index = wq->to_clean_index = 0;\n\n\tiowrite32(0, &wq->ctrl->fetch_index);\n\tiowrite32(0, &wq->ctrl->posted_index);\n\tiowrite32(0, &wq->ctrl->error_status);\n\n\tvnic_dev_clear_desc_ring(&wq->ring);\n}\n\nvoid vnic_wq_copy_free(struct vnic_wq_copy *wq)\n{\n\tstruct vnic_dev *vdev;\n\n\tvdev = wq->vdev;\n\tvnic_dev_free_desc_ring(vdev, &wq->ring);\n\twq->ctrl = NULL;\n}\n\nint vnic_wq_copy_alloc(struct vnic_dev *vdev, struct vnic_wq_copy *wq,\n\t\t       unsigned int index, unsigned int desc_count,\n\t\t       unsigned int desc_size)\n{\n\twq->index = index;\n\twq->vdev = vdev;\n\twq->to_use_index = wq->to_clean_index = 0;\n\twq->ctrl = vnic_dev_get_res(vdev, RES_TYPE_WQ, index);\n\tif (!wq->ctrl) {\n\t\tprintk(KERN_ERR \"Failed to hook COPY WQ[%d] resource\\n\", index);\n\t\treturn -EINVAL;\n\t}\n\n\tvnic_wq_copy_disable(wq);\n\n\treturn vnic_dev_alloc_desc_ring(vdev, &wq->ring, desc_count, desc_size);\n}\n\nvoid vnic_wq_copy_init(struct vnic_wq_copy *wq, unsigned int cq_index,\n\tunsigned int error_interrupt_enable,\n\tunsigned int error_interrupt_offset)\n{\n\tu64 paddr;\n\n\tpaddr = (u64)wq->ring.base_addr | VNIC_PADDR_TARGET;\n\twriteq(paddr, &wq->ctrl->ring_base);\n\tiowrite32(wq->ring.desc_count, &wq->ctrl->ring_size);\n\tiowrite32(0, &wq->ctrl->fetch_index);\n\tiowrite32(0, &wq->ctrl->posted_index);\n\tiowrite32(cq_index, &wq->ctrl->cq_index);\n\tiowrite32(error_interrupt_enable, &wq->ctrl->error_interrupt_enable);\n\tiowrite32(error_interrupt_offset, &wq->ctrl->error_interrupt_offset);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}