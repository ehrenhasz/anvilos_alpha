{
  "module_name": "fnic.h",
  "hash_id": "b0efe91c31dd2fc4ee4486e19858bb6fd26904e8e31562171ba2d81d6c8e268e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/fnic/fnic.h",
  "human_readable_source": " \n \n#ifndef _FNIC_H_\n#define _FNIC_H_\n\n#include <linux/interrupt.h>\n#include <linux/netdevice.h>\n#include <linux/workqueue.h>\n#include <linux/bitops.h>\n#include <scsi/libfc.h>\n#include <scsi/libfcoe.h>\n#include \"fnic_io.h\"\n#include \"fnic_res.h\"\n#include \"fnic_trace.h\"\n#include \"fnic_stats.h\"\n#include \"vnic_dev.h\"\n#include \"vnic_wq.h\"\n#include \"vnic_rq.h\"\n#include \"vnic_cq.h\"\n#include \"vnic_wq_copy.h\"\n#include \"vnic_intr.h\"\n#include \"vnic_stats.h\"\n#include \"vnic_scsi.h\"\n\n#define DRV_NAME\t\t\"fnic\"\n#define DRV_DESCRIPTION\t\t\"Cisco FCoE HBA Driver\"\n#define DRV_VERSION\t\t\"1.6.0.57\"\n#define PFX\t\t\tDRV_NAME \": \"\n#define DFX                     DRV_NAME \"%d: \"\n\n#define DESC_CLEAN_LOW_WATERMARK 8\n#define FNIC_UCSM_DFLT_THROTTLE_CNT_BLD\t16  \n#define FNIC_MIN_IO_REQ\t\t\t256  \n#define FNIC_MAX_IO_REQ\t\t1024  \n#define FNIC_DFLT_IO_REQ        256  \n#define\tFNIC_IO_LOCKS\t\t64  \n#define FNIC_DFLT_QUEUE_DEPTH\t256\n#define\tFNIC_STATS_RATE_LIMIT\t4  \n\n \n#define FNIC_TAG_ABORT\t\tBIT(30)\t\t \n#define FNIC_TAG_DEV_RST\tBIT(29)\t\t \n#define FNIC_TAG_MASK\t\t(BIT(24) - 1)\t \n#define FNIC_NO_TAG             -1\n\n \n#define FNIC_NO_FLAGS                   0\n#define FNIC_IO_INITIALIZED             BIT(0)\n#define FNIC_IO_ISSUED                  BIT(1)\n#define FNIC_IO_DONE                    BIT(2)\n#define FNIC_IO_REQ_NULL                BIT(3)\n#define FNIC_IO_ABTS_PENDING            BIT(4)\n#define FNIC_IO_ABORTED                 BIT(5)\n#define FNIC_IO_ABTS_ISSUED             BIT(6)\n#define FNIC_IO_TERM_ISSUED             BIT(7)\n#define FNIC_IO_INTERNAL_TERM_ISSUED    BIT(8)\n#define FNIC_IO_ABT_TERM_DONE           BIT(9)\n#define FNIC_IO_ABT_TERM_REQ_NULL       BIT(10)\n#define FNIC_IO_ABT_TERM_TIMED_OUT      BIT(11)\n#define FNIC_DEVICE_RESET               BIT(12)   \n#define FNIC_DEV_RST_ISSUED             BIT(13)\n#define FNIC_DEV_RST_TIMED_OUT          BIT(14)\n#define FNIC_DEV_RST_ABTS_ISSUED        BIT(15)\n#define FNIC_DEV_RST_TERM_ISSUED        BIT(16)\n#define FNIC_DEV_RST_DONE               BIT(17)\n#define FNIC_DEV_RST_REQ_NULL           BIT(18)\n#define FNIC_DEV_RST_ABTS_DONE          BIT(19)\n#define FNIC_DEV_RST_TERM_DONE          BIT(20)\n#define FNIC_DEV_RST_ABTS_PENDING       BIT(21)\n\n \nstruct fnic_cmd_priv {\n\tstruct fnic_io_req *io_req;\n\tenum fnic_ioreq_state state;\n\tu32 flags;\n\tu16 abts_status;\n\tu16 lr_status;\n};\n\nstatic inline struct fnic_cmd_priv *fnic_priv(struct scsi_cmnd *cmd)\n{\n\treturn scsi_cmd_priv(cmd);\n}\n\nstatic inline u64 fnic_flags_and_state(struct scsi_cmnd *cmd)\n{\n\tstruct fnic_cmd_priv *fcmd = fnic_priv(cmd);\n\n\treturn ((u64)fcmd->flags << 32) | fcmd->state;\n}\n\n#define FCPIO_INVALID_CODE 0x100  \n\n#define FNIC_LUN_RESET_TIMEOUT\t     10000\t \n#define FNIC_HOST_RESET_TIMEOUT\t     10000\t \n#define FNIC_RMDEVICE_TIMEOUT        1000        \n#define FNIC_HOST_RESET_SETTLE_TIME  30          \n#define FNIC_ABT_TERM_DELAY_TIMEOUT  500         \n\n#define FNIC_MAX_FCP_TARGET     256\n\n \n#define __FNIC_FLAGS_FWRESET\t\tBIT(0)  \n#define __FNIC_FLAGS_BLOCK_IO\t\tBIT(1)  \n\n#define FNIC_FLAGS_NONE\t\t\t(0)\n#define FNIC_FLAGS_FWRESET\t\t(__FNIC_FLAGS_FWRESET | \\\n\t\t\t\t\t__FNIC_FLAGS_BLOCK_IO)\n\n#define FNIC_FLAGS_IO_BLOCKED\t\t(__FNIC_FLAGS_BLOCK_IO)\n\n#define fnic_set_state_flags(fnicp, st_flags)\t\\\n\t__fnic_set_state_flags(fnicp, st_flags, 0)\n\n#define fnic_clear_state_flags(fnicp, st_flags)  \\\n\t__fnic_set_state_flags(fnicp, st_flags, 1)\n\nextern unsigned int fnic_log_level;\nextern unsigned int io_completions;\n\n#define FNIC_MAIN_LOGGING 0x01\n#define FNIC_FCS_LOGGING 0x02\n#define FNIC_SCSI_LOGGING 0x04\n#define FNIC_ISR_LOGGING 0x08\n\n#define FNIC_CHECK_LOGGING(LEVEL, CMD)\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tif (unlikely(fnic_log_level & LEVEL))\t\t\t\\\n\t\tdo {\t\t\t\t\t\t\\\n\t\t\tCMD;\t\t\t\t\t\\\n\t\t} while (0);\t\t\t\t\t\\\n} while (0)\n\n#define FNIC_MAIN_DBG(kern_level, host, fmt, args...)\t\t\\\n\tFNIC_CHECK_LOGGING(FNIC_MAIN_LOGGING,\t\t\t\\\n\t\t\t shost_printk(kern_level, host, fmt, ##args);)\n\n#define FNIC_FCS_DBG(kern_level, host, fmt, args...)\t\t\\\n\tFNIC_CHECK_LOGGING(FNIC_FCS_LOGGING,\t\t\t\\\n\t\t\t shost_printk(kern_level, host, fmt, ##args);)\n\n#define FNIC_SCSI_DBG(kern_level, host, fmt, args...)\t\t\\\n\tFNIC_CHECK_LOGGING(FNIC_SCSI_LOGGING,\t\t\t\\\n\t\t\t shost_printk(kern_level, host, fmt, ##args);)\n\n#define FNIC_ISR_DBG(kern_level, host, fmt, args...)\t\t\\\n\tFNIC_CHECK_LOGGING(FNIC_ISR_LOGGING,\t\t\t\\\n\t\t\t shost_printk(kern_level, host, fmt, ##args);)\n\n#define FNIC_MAIN_NOTE(kern_level, host, fmt, args...)          \\\n\tshost_printk(kern_level, host, fmt, ##args)\n\nextern const char *fnic_state_str[];\n\nenum fnic_intx_intr_index {\n\tFNIC_INTX_WQ_RQ_COPYWQ,\n\tFNIC_INTX_ERR,\n\tFNIC_INTX_NOTIFY,\n\tFNIC_INTX_INTR_MAX,\n};\n\nenum fnic_msix_intr_index {\n\tFNIC_MSIX_RQ,\n\tFNIC_MSIX_WQ,\n\tFNIC_MSIX_WQ_COPY,\n\tFNIC_MSIX_ERR_NOTIFY,\n\tFNIC_MSIX_INTR_MAX,\n};\n\nstruct fnic_msix_entry {\n\tint requested;\n\tchar devname[IFNAMSIZ + 11];\n\tirqreturn_t (*isr)(int, void *);\n\tvoid *devid;\n};\n\nenum fnic_state {\n\tFNIC_IN_FC_MODE = 0,\n\tFNIC_IN_FC_TRANS_ETH_MODE,\n\tFNIC_IN_ETH_MODE,\n\tFNIC_IN_ETH_TRANS_FC_MODE,\n};\n\n#define FNIC_WQ_COPY_MAX 1\n#define FNIC_WQ_MAX 1\n#define FNIC_RQ_MAX 1\n#define FNIC_CQ_MAX (FNIC_WQ_COPY_MAX + FNIC_WQ_MAX + FNIC_RQ_MAX)\n#define FNIC_DFLT_IO_COMPLETIONS 256\n\nstruct mempool;\n\nenum fnic_evt {\n\tFNIC_EVT_START_VLAN_DISC = 1,\n\tFNIC_EVT_START_FCF_DISC = 2,\n\tFNIC_EVT_MAX,\n};\n\nstruct fnic_event {\n\tstruct list_head list;\n\tstruct fnic *fnic;\n\tenum fnic_evt event;\n};\n\n \nstruct fnic {\n\tstruct fc_lport *lport;\n\tstruct fcoe_ctlr ctlr;\t\t \n\tstruct vnic_dev_bar bar0;\n\n\tstruct fnic_msix_entry msix[FNIC_MSIX_INTR_MAX];\n\n\tstruct vnic_stats *stats;\n\tunsigned long stats_time;\t \n\tunsigned long stats_reset_time;  \n\tstruct vnic_nic_cfg *nic_cfg;\n\tchar name[IFNAMSIZ];\n\tstruct timer_list notify_timer;  \n\n\tunsigned int fnic_max_tag_id;\n\tunsigned int err_intr_offset;\n\tunsigned int link_intr_offset;\n\n\tunsigned int wq_count;\n\tunsigned int cq_count;\n\n\tstruct mutex sgreset_mutex;\n\tspinlock_t sgreset_lock;  \n\tstruct scsi_cmnd *sgreset_sc;\n\tstruct dentry *fnic_stats_debugfs_host;\n\tstruct dentry *fnic_stats_debugfs_file;\n\tstruct dentry *fnic_reset_debugfs_file;\n\tunsigned int reset_stats;\n\tatomic64_t io_cmpl_skip;\n\tstruct fnic_stats fnic_stats;\n\n\tu32 vlan_hw_insert:1;\t         \n\tu32 in_remove:1;                 \n\tu32 stop_rx_link_events:1;       \n\tu32 link_events:1;               \n\n\tstruct completion *remove_wait;  \n\n\tatomic_t in_flight;\t\t \n\tbool internal_reset_inprogress;\n\tu32 _reserved;\t\t\t \n\tunsigned long state_flags;\t \n\tenum fnic_state state;\n\tspinlock_t fnic_lock;\n\n\tu16 vlan_id;\t                 \n\tu8 data_src_addr[ETH_ALEN];\n\tu64 fcp_input_bytes;\t\t \n\tu64 fcp_output_bytes;\t\t \n\tu32 link_down_cnt;\n\tint link_status;\n\n\tstruct list_head list;\n\tstruct pci_dev *pdev;\n\tstruct vnic_fc_config config;\n\tstruct vnic_dev *vdev;\n\tunsigned int raw_wq_count;\n\tunsigned int wq_copy_count;\n\tunsigned int rq_count;\n\tint fw_ack_index[FNIC_WQ_COPY_MAX];\n\tunsigned short fw_ack_recd[FNIC_WQ_COPY_MAX];\n\tunsigned short wq_copy_desc_low[FNIC_WQ_COPY_MAX];\n\tunsigned int intr_count;\n\tu32 __iomem *legacy_pba;\n\tstruct fnic_host_tag *tags;\n\tmempool_t *io_req_pool;\n\tmempool_t *io_sgl_pool[FNIC_SGL_NUM_CACHES];\n\tspinlock_t io_req_lock[FNIC_IO_LOCKS];\t \n\n\tstruct work_struct link_work;\n\tstruct work_struct frame_work;\n\tstruct sk_buff_head frame_queue;\n\tstruct sk_buff_head tx_queue;\n\n\t \n\tvoid (*set_vlan)(struct fnic *, u16 vlan);\n\tstruct work_struct      fip_frame_work;\n\tstruct sk_buff_head     fip_frame_queue;\n\tstruct timer_list       fip_timer;\n\tstruct list_head        vlans;\n\tspinlock_t              vlans_lock;\n\n\tstruct work_struct      event_work;\n\tstruct list_head        evlist;\n\t \n\n\t \n\t____cacheline_aligned struct vnic_wq_copy wq_copy[FNIC_WQ_COPY_MAX];\n\t \n\t____cacheline_aligned struct vnic_cq cq[FNIC_CQ_MAX];\n\n\tspinlock_t wq_copy_lock[FNIC_WQ_COPY_MAX];\n\n\t \n\t____cacheline_aligned struct vnic_wq wq[FNIC_WQ_MAX];\n\tspinlock_t wq_lock[FNIC_WQ_MAX];\n\n\t \n\t____cacheline_aligned struct vnic_rq rq[FNIC_RQ_MAX];\n\n\t \n\t____cacheline_aligned struct vnic_intr intr[FNIC_MSIX_INTR_MAX];\n};\n\nstatic inline struct fnic *fnic_from_ctlr(struct fcoe_ctlr *fip)\n{\n\treturn container_of(fip, struct fnic, ctlr);\n}\n\nextern struct workqueue_struct *fnic_event_queue;\nextern struct workqueue_struct *fnic_fip_queue;\nextern const struct attribute_group *fnic_host_groups[];\n\nvoid fnic_clear_intr_mode(struct fnic *fnic);\nint fnic_set_intr_mode(struct fnic *fnic);\nvoid fnic_free_intr(struct fnic *fnic);\nint fnic_request_intr(struct fnic *fnic);\n\nint fnic_send(struct fc_lport *, struct fc_frame *);\nvoid fnic_free_wq_buf(struct vnic_wq *wq, struct vnic_wq_buf *buf);\nvoid fnic_handle_frame(struct work_struct *work);\nvoid fnic_handle_link(struct work_struct *work);\nvoid fnic_handle_event(struct work_struct *work);\nint fnic_rq_cmpl_handler(struct fnic *fnic, int);\nint fnic_alloc_rq_frame(struct vnic_rq *rq);\nvoid fnic_free_rq_buf(struct vnic_rq *rq, struct vnic_rq_buf *buf);\nvoid fnic_flush_tx(struct fnic *);\nvoid fnic_eth_send(struct fcoe_ctlr *, struct sk_buff *skb);\nvoid fnic_set_port_id(struct fc_lport *, u32, struct fc_frame *);\nvoid fnic_update_mac(struct fc_lport *, u8 *new);\nvoid fnic_update_mac_locked(struct fnic *, u8 *new);\n\nint fnic_queuecommand(struct Scsi_Host *, struct scsi_cmnd *);\nint fnic_abort_cmd(struct scsi_cmnd *);\nint fnic_device_reset(struct scsi_cmnd *);\nint fnic_host_reset(struct scsi_cmnd *);\nint fnic_reset(struct Scsi_Host *);\nvoid fnic_scsi_cleanup(struct fc_lport *);\nvoid fnic_scsi_abort_io(struct fc_lport *);\nvoid fnic_empty_scsi_cleanup(struct fc_lport *);\nvoid fnic_exch_mgr_reset(struct fc_lport *, u32, u32);\nint fnic_wq_copy_cmpl_handler(struct fnic *fnic, int);\nint fnic_wq_cmpl_handler(struct fnic *fnic, int);\nint fnic_flogi_reg_handler(struct fnic *fnic, u32);\nvoid fnic_wq_copy_cleanup_handler(struct vnic_wq_copy *wq,\n\t\t\t\t  struct fcpio_host_req *desc);\nint fnic_fw_reset_handler(struct fnic *fnic);\nvoid fnic_terminate_rport_io(struct fc_rport *);\nconst char *fnic_state_to_str(unsigned int state);\n\nvoid fnic_log_q_error(struct fnic *fnic);\nvoid fnic_handle_link_event(struct fnic *fnic);\n\nint fnic_is_abts_pending(struct fnic *, struct scsi_cmnd *);\n\nvoid fnic_handle_fip_frame(struct work_struct *work);\nvoid fnic_handle_fip_event(struct fnic *fnic);\nvoid fnic_fcoe_reset_vlans(struct fnic *fnic);\nvoid fnic_fcoe_evlist_free(struct fnic *fnic);\nextern void fnic_handle_fip_timer(struct fnic *fnic);\n\nstatic inline int\nfnic_chk_state_flags_locked(struct fnic *fnic, unsigned long st_flags)\n{\n\treturn ((fnic->state_flags & st_flags) == st_flags);\n}\nvoid __fnic_set_state_flags(struct fnic *, unsigned long, unsigned long);\nvoid fnic_dump_fchost_stats(struct Scsi_Host *, struct fc_host_statistics *);\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}