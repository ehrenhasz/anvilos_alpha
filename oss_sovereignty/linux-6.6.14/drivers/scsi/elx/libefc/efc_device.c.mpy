{
  "module_name": "efc_device.c",
  "hash_id": "1c5239679c18cad78343f970ca0adac44ab02f95fab61afccf0909381f065f6f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/elx/libefc/efc_device.c",
  "human_readable_source": "\n \n\n \n\n#include \"efc.h\"\n#include \"efc_device.h\"\n#include \"efc_fabric.h\"\n\nvoid\nefc_d_send_prli_rsp(struct efc_node *node, u16 ox_id)\n{\n\tint rc = EFC_SCSI_CALL_COMPLETE;\n\tstruct efc *efc = node->efc;\n\n\tnode->ls_acc_oxid = ox_id;\n\tnode->send_ls_acc = EFC_NODE_SEND_LS_ACC_PRLI;\n\n\t \n\n\tif (node->init) {\n\t\tefc_log_info(efc, \"[%s] found(initiator) WWPN:%s WWNN:%s\\n\",\n\t\t\t     node->display_name, node->wwpn, node->wwnn);\n\t\tif (node->nport->enable_tgt)\n\t\t\trc = efc->tt.scsi_new_node(efc, node);\n\t}\n\n\tif (rc < 0)\n\t\tefc_node_post_event(node, EFC_EVT_NODE_SESS_REG_FAIL, NULL);\n\n\tif (rc == EFC_SCSI_CALL_COMPLETE)\n\t\tefc_node_post_event(node, EFC_EVT_NODE_SESS_REG_OK, NULL);\n}\n\nstatic void\n__efc_d_common(const char *funcname, struct efc_sm_ctx *ctx,\n\t       enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = NULL;\n\tstruct efc *efc = NULL;\n\n\tnode = ctx->app;\n\tefc = node->efc;\n\n\tswitch (evt) {\n\t \n\tcase EFC_EVT_SHUTDOWN:\n\t\tefc_log_debug(efc, \"[%s] %-20s %-20s\\n\", node->display_name,\n\t\t\t      funcname, efc_sm_event_name(evt));\n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_DEFAULT;\n\t\tefc_node_transition(node, __efc_d_initiate_shutdown, NULL);\n\t\tbreak;\n\tcase EFC_EVT_SHUTDOWN_EXPLICIT_LOGO:\n\t\tefc_log_debug(efc, \"[%s] %-20s %-20s\\n\",\n\t\t\t      node->display_name, funcname,\n\t\t\t\tefc_sm_event_name(evt));\n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_EXPLICIT_LOGO;\n\t\tefc_node_transition(node, __efc_d_initiate_shutdown, NULL);\n\t\tbreak;\n\tcase EFC_EVT_SHUTDOWN_IMPLICIT_LOGO:\n\t\tefc_log_debug(efc, \"[%s] %-20s %-20s\\n\", node->display_name,\n\t\t\t      funcname, efc_sm_event_name(evt));\n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_IMPLICIT_LOGO;\n\t\tefc_node_transition(node, __efc_d_initiate_shutdown, NULL);\n\t\tbreak;\n\n\tdefault:\n\t\t \n\t\t__efc_node_common(funcname, ctx, evt, arg);\n\t}\n}\n\nstatic void\n__efc_d_wait_del_node(struct efc_sm_ctx *ctx,\n\t\t      enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\t \n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tfallthrough;\n\n\tcase EFC_EVT_NODE_ACTIVE_IO_LIST_EMPTY:\n\tcase EFC_EVT_ALL_CHILD_NODES_FREE:\n\t\t \n\t\tbreak;\n\n\tcase EFC_EVT_NODE_DEL_INI_COMPLETE:\n\tcase EFC_EVT_NODE_DEL_TGT_COMPLETE:\n\t\t \n\t\tefc_node_initiate_cleanup(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_REQ_FAIL:\n\t\t \n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\tbreak;\n\n\t \n\tcase EFC_EVT_SHUTDOWN:\n\t\t \n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_DEFAULT;\n\t\tfallthrough;\n\n\tcase EFC_EVT_SHUTDOWN_EXPLICIT_LOGO:\n\tcase EFC_EVT_SHUTDOWN_IMPLICIT_LOGO:\n\t\tnode_printf(node, \"%s received\\n\", efc_sm_event_name(evt));\n\t\tbreak;\n\tcase EFC_EVT_DOMAIN_ATTACH_OK:\n\t\t \n\t\tbreak;\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nstatic void\n__efc_d_wait_del_ini_tgt(struct efc_sm_ctx *ctx,\n\t\t\t enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tfallthrough;\n\n\tcase EFC_EVT_NODE_ACTIVE_IO_LIST_EMPTY:\n\tcase EFC_EVT_ALL_CHILD_NODES_FREE:\n\t\t \n\t\tbreak;\n\n\tcase EFC_EVT_NODE_DEL_INI_COMPLETE:\n\tcase EFC_EVT_NODE_DEL_TGT_COMPLETE:\n\t\tefc_node_transition(node, __efc_d_wait_del_node, NULL);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_REQ_FAIL:\n\t\t \n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\tbreak;\n\n\t \n\tcase EFC_EVT_SHUTDOWN:\n\t\t \n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_DEFAULT;\n\t\tfallthrough;\n\n\tcase EFC_EVT_SHUTDOWN_EXPLICIT_LOGO:\n\tcase EFC_EVT_SHUTDOWN_IMPLICIT_LOGO:\n\t\tnode_printf(node, \"%s received\\n\", efc_sm_event_name(evt));\n\t\tbreak;\n\tcase EFC_EVT_DOMAIN_ATTACH_OK:\n\t\t \n\t\tbreak;\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_initiate_shutdown(struct efc_sm_ctx *ctx,\n\t\t\t  enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = ctx->app;\n\tstruct efc *efc = node->efc;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER: {\n\t\tint rc = EFC_SCSI_CALL_COMPLETE;\n\n\t\t \n\t\tnode->els_io_enabled = false;\n\n\t\t \n\t\tif (node->init && !node->targ) {\n\t\t\tefc_log_info(node->efc,\n\t\t\t\t     \"[%s] delete (initiator) WWPN %s WWNN %s\\n\",\n\t\t\t\tnode->display_name,\n\t\t\t\tnode->wwpn, node->wwnn);\n\t\t\tefc_node_transition(node,\n\t\t\t\t\t    __efc_d_wait_del_node,\n\t\t\t\t\t     NULL);\n\t\t\tif (node->nport->enable_tgt)\n\t\t\t\trc = efc->tt.scsi_del_node(efc, node,\n\t\t\t\t\tEFC_SCSI_INITIATOR_DELETED);\n\n\t\t\tif (rc == EFC_SCSI_CALL_COMPLETE || rc < 0)\n\t\t\t\tefc_node_post_event(node,\n\t\t\t\t\tEFC_EVT_NODE_DEL_INI_COMPLETE, NULL);\n\n\t\t} else if (node->targ && !node->init) {\n\t\t\tefc_log_info(node->efc,\n\t\t\t\t     \"[%s] delete (target) WWPN %s WWNN %s\\n\",\n\t\t\t\tnode->display_name,\n\t\t\t\tnode->wwpn, node->wwnn);\n\t\t\tefc_node_transition(node,\n\t\t\t\t\t    __efc_d_wait_del_node,\n\t\t\t\t\t     NULL);\n\t\t\tif (node->nport->enable_ini)\n\t\t\t\trc = efc->tt.scsi_del_node(efc, node,\n\t\t\t\t\tEFC_SCSI_TARGET_DELETED);\n\n\t\t\tif (rc == EFC_SCSI_CALL_COMPLETE)\n\t\t\t\tefc_node_post_event(node,\n\t\t\t\t\tEFC_EVT_NODE_DEL_TGT_COMPLETE, NULL);\n\n\t\t} else if (node->init && node->targ) {\n\t\t\tefc_log_info(node->efc,\n\t\t\t\t     \"[%s] delete (I+T) WWPN %s WWNN %s\\n\",\n\t\t\t\tnode->display_name, node->wwpn, node->wwnn);\n\t\t\tefc_node_transition(node, __efc_d_wait_del_ini_tgt,\n\t\t\t\t\t    NULL);\n\t\t\tif (node->nport->enable_tgt)\n\t\t\t\trc = efc->tt.scsi_del_node(efc, node,\n\t\t\t\t\t\tEFC_SCSI_INITIATOR_DELETED);\n\n\t\t\tif (rc == EFC_SCSI_CALL_COMPLETE)\n\t\t\t\tefc_node_post_event(node,\n\t\t\t\t\tEFC_EVT_NODE_DEL_INI_COMPLETE, NULL);\n\t\t\t \n\t\t\trc = EFC_SCSI_CALL_COMPLETE;\n\t\t\tif (node->nport->enable_ini)\n\t\t\t\trc = efc->tt.scsi_del_node(efc, node,\n\t\t\t\t\t\tEFC_SCSI_TARGET_DELETED);\n\n\t\t\tif (rc == EFC_SCSI_CALL_COMPLETE)\n\t\t\t\tefc_node_post_event(node,\n\t\t\t\t\tEFC_EVT_NODE_DEL_TGT_COMPLETE, NULL);\n\t\t}\n\n\t\t \n\t\tif (node->attached) {\n\t\t\t \n\t\t\trc = efc_cmd_node_detach(efc, &node->rnode);\n\t\t\tif (rc < 0)\n\t\t\t\tnode_printf(node,\n\t\t\t\t\t    \"Failed freeing HW node, rc=%d\\n\",\n\t\t\t\t\trc);\n\t\t}\n\n\t\t \n\t\tif (!node->init && !node->targ) {\n\t\t\t \n\t\t\tefc_node_initiate_cleanup(node);\n\t\t}\n\t\tbreak;\n\t}\n\tcase EFC_EVT_ALL_CHILD_NODES_FREE:\n\t\t \n\t\tbreak;\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_loop(struct efc_sm_ctx *ctx,\n\t\t  enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_DOMAIN_ATTACH_OK: {\n\t\t \n\t\tefc_node_init_device(node, true);\n\t\tbreak;\n\t}\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\nefc_send_ls_acc_after_attach(struct efc_node *node,\n\t\t\t     struct fc_frame_header *hdr,\n\t\t\t     enum efc_node_send_ls_acc ls)\n{\n\tu16 ox_id = be16_to_cpu(hdr->fh_ox_id);\n\n\t \n\tWARN_ON(node->send_ls_acc != EFC_NODE_SEND_LS_ACC_NONE);\n\n\tnode->ls_acc_oxid = ox_id;\n\tnode->send_ls_acc = ls;\n\tnode->ls_acc_did = ntoh24(hdr->fh_d_id);\n}\n\nvoid\nefc_process_prli_payload(struct efc_node *node, void *prli)\n{\n\tstruct {\n\t\tstruct fc_els_prli prli;\n\t\tstruct fc_els_spp sp;\n\t} *pp;\n\n\tpp = prli;\n\tnode->init = (pp->sp.spp_flags & FCP_SPPF_INIT_FCN) != 0;\n\tnode->targ = (pp->sp.spp_flags & FCP_SPPF_TARG_FCN) != 0;\n}\n\nvoid\n__efc_d_wait_plogi_acc_cmpl(struct efc_sm_ctx *ctx,\n\t\t\t    enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_CMPL_FAIL:\n\t\tWARN_ON(!node->els_cmpl_cnt);\n\t\tnode->els_cmpl_cnt--;\n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_DEFAULT;\n\t\tefc_node_transition(node, __efc_d_initiate_shutdown, NULL);\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_CMPL_OK:\t \n\t\tWARN_ON(!node->els_cmpl_cnt);\n\t\tnode->els_cmpl_cnt--;\n\t\tefc_node_transition(node, __efc_d_port_logged_in, NULL);\n\t\tbreak;\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_logo_rsp(struct efc_sm_ctx *ctx,\n\t\t      enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_REQ_OK:\n\tcase EFC_EVT_SRRS_ELS_REQ_RJT:\n\tcase EFC_EVT_SRRS_ELS_REQ_FAIL:\n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_LOGO,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\tnode_printf(node,\n\t\t\t    \"LOGO sent (evt=%s), shutdown node\\n\",\n\t\t\tefc_sm_event_name(evt));\n\t\t \n\t\tefc_node_post_event(node, EFC_EVT_SHUTDOWN_EXPLICIT_LOGO,\n\t\t\t\t    NULL);\n\t\tbreak;\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\nefc_node_init_device(struct efc_node *node, bool send_plogi)\n{\n\tnode->send_plogi = send_plogi;\n\tif ((node->efc->nodedb_mask & EFC_NODEDB_PAUSE_NEW_NODES) &&\n\t    (node->rnode.fc_id != FC_FID_DOM_MGR)) {\n\t\tnode->nodedb_state = __efc_d_init;\n\t\tefc_node_transition(node, __efc_node_paused, NULL);\n\t} else {\n\t\tefc_node_transition(node, __efc_d_init, NULL);\n\t}\n}\n\nstatic void\nefc_d_check_plogi_topology(struct efc_node *node, u32 d_id)\n{\n\tswitch (node->nport->topology) {\n\tcase EFC_NPORT_TOPO_P2P:\n\t\t \n\t\tefc_domain_attach(node->nport->domain, d_id);\n\t\tefc_node_transition(node, __efc_d_wait_domain_attach, NULL);\n\t\tbreak;\n\tcase EFC_NPORT_TOPO_FABRIC:\n\t\t \n\t\tefc_node_transition(node, __efc_d_wait_domain_attach, NULL);\n\t\tbreak;\n\tcase EFC_NPORT_TOPO_UNKNOWN:\n\t\t \n\t\tnode_printf(node, \"received PLOGI, unknown topology did=0x%x\\n\",\n\t\t\t    d_id);\n\t\tefc_node_transition(node, __efc_d_wait_topology_notify, NULL);\n\t\tbreak;\n\tdefault:\n\t\tnode_printf(node, \"received PLOGI, unexpected topology %d\\n\",\n\t\t\t    node->nport->topology);\n\t}\n}\n\nvoid\n__efc_d_init(struct efc_sm_ctx *ctx, enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node_cb *cbdata = arg;\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\t \n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tif (!node->send_plogi)\n\t\t\tbreak;\n\t\t \n\t\tif (node->nport->enable_ini &&\n\t\t    node->nport->domain->attached) {\n\t\t\tefc_send_plogi(node);\n\n\t\t\tefc_node_transition(node, __efc_d_wait_plogi_rsp, NULL);\n\t\t} else {\n\t\t\tnode_printf(node, \"not sending plogi nport.ini=%d,\",\n\t\t\t\t    node->nport->enable_ini);\n\t\t\tnode_printf(node, \"domain attached=%d\\n\",\n\t\t\t\t    node->nport->domain->attached);\n\t\t}\n\t\tbreak;\n\tcase EFC_EVT_PLOGI_RCVD: {\n\t\t \n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\t\tint rc;\n\n\t\tefc_node_save_sparms(node, cbdata->payload->dma.virt);\n\t\tefc_send_ls_acc_after_attach(node,\n\t\t\t\t\t     cbdata->header->dma.virt,\n\t\t\t\t\t     EFC_NODE_SEND_LS_ACC_PLOGI);\n\n\t\t \n\t\tif (!node->nport->domain->attached) {\n\t\t\tefc_d_check_plogi_topology(node, ntoh24(hdr->fh_d_id));\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\trc = efc_node_attach(node);\n\t\tefc_node_transition(node, __efc_d_wait_node_attach, NULL);\n\t\tif (rc < 0)\n\t\t\tefc_node_post_event(node, EFC_EVT_NODE_ATTACH_FAIL, NULL);\n\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_FDISC_RCVD: {\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_FLOGI_RCVD: {\n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\t\tu32 d_id = ntoh24(hdr->fh_d_id);\n\n\t\t \n\t\tmemcpy(node->nport->domain->flogi_service_params,\n\t\t       cbdata->payload->dma.virt,\n\t\t       sizeof(struct fc_els_flogi));\n\n\t\t \n\t\tefc_fabric_set_topology(node, EFC_NPORT_TOPO_P2P);\n\n\t\tefc_send_flogi_p2p_acc(node, be16_to_cpu(hdr->fh_ox_id), d_id);\n\n\t\tif (efc_p2p_setup(node->nport)) {\n\t\t\tnode_printf(node, \"p2p failed, shutting down node\\n\");\n\t\t\tefc_node_post_event(node, EFC_EVT_SHUTDOWN, NULL);\n\t\t\tbreak;\n\t\t}\n\n\t\tefc_node_transition(node,  __efc_p2p_wait_flogi_acc_cmpl, NULL);\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_LOGO_RCVD: {\n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\n\t\tif (!node->nport->domain->attached) {\n\t\t\t \n\t\t\tnode_printf(node, \"%s domain not attached, dropping\\n\",\n\t\t\t\t    efc_sm_event_name(evt));\n\t\t\tefc_node_post_event(node,\n\t\t\t\t\tEFC_EVT_SHUTDOWN_EXPLICIT_LOGO, NULL);\n\t\t\tbreak;\n\t\t}\n\n\t\tefc_send_logo_acc(node, be16_to_cpu(hdr->fh_ox_id));\n\t\tefc_node_transition(node, __efc_d_wait_logo_acc_cmpl, NULL);\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_PRLI_RCVD:\n\tcase EFC_EVT_PRLO_RCVD:\n\tcase EFC_EVT_PDISC_RCVD:\n\tcase EFC_EVT_ADISC_RCVD:\n\tcase EFC_EVT_RSCN_RCVD: {\n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\n\t\tif (!node->nport->domain->attached) {\n\t\t\t \n\t\t\tnode_printf(node, \"%s domain not attached, dropping\\n\",\n\t\t\t\t    efc_sm_event_name(evt));\n\n\t\t\tefc_node_post_event(node,\n\t\t\t\t\t    EFC_EVT_SHUTDOWN_EXPLICIT_LOGO,\n\t\t\t\t\t    NULL);\n\t\t\tbreak;\n\t\t}\n\t\tnode_printf(node, \"%s received, sending reject\\n\",\n\t\t\t    efc_sm_event_name(evt));\n\n\t\tefc_send_ls_rjt(node, be16_to_cpu(hdr->fh_ox_id),\n\t\t\t\tELS_RJT_UNAB, ELS_EXPL_PLOGI_REQD, 0);\n\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_FCP_CMD_RCVD: {\n\t\t \n\t\tif (!node->nport->domain->attached) {\n\t\t\t \n\t\t\tnode_printf(node, \"%s domain not attached, dropping\\n\",\n\t\t\t\t    efc_sm_event_name(evt));\n\t\t\tefc_node_post_event(node,\n\t\t\t\t\t    EFC_EVT_SHUTDOWN_EXPLICIT_LOGO,\n\t\t\t\t\t    NULL);\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tnode_printf(node, \"FCP_CMND received, send LOGO\\n\");\n\t\tif (efc_send_logo(node)) {\n\t\t\t \n\t\t\tnode_printf(node, \"Failed to send LOGO\\n\");\n\t\t\tefc_node_post_event(node,\n\t\t\t\t\t    EFC_EVT_SHUTDOWN_EXPLICIT_LOGO,\n\t\t\t\t\t    NULL);\n\t\t} else {\n\t\t\t \n\t\t\tefc_node_transition(node,\n\t\t\t\t\t    __efc_d_wait_logo_rsp, NULL);\n\t\t}\n\t\tbreak;\n\t}\n\tcase EFC_EVT_DOMAIN_ATTACH_OK:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_plogi_rsp(struct efc_sm_ctx *ctx,\n\t\t       enum efc_sm_event evt, void *arg)\n{\n\tint rc;\n\tstruct efc_node_cb *cbdata = arg;\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_PLOGI_RCVD: {\n\t\t \n\t\t \n\t\tefc_node_save_sparms(node, cbdata->payload->dma.virt);\n\t\tefc_send_ls_acc_after_attach(node,\n\t\t\t\t\t     cbdata->header->dma.virt,\n\t\t\t\tEFC_NODE_SEND_LS_ACC_PLOGI);\n\t\t \n\t\trc = efc_node_attach(node);\n\t\tefc_node_transition(node, __efc_d_wait_node_attach, NULL);\n\t\tif (rc < 0)\n\t\t\tefc_node_post_event(node,\n\t\t\t\t\t    EFC_EVT_NODE_ATTACH_FAIL, NULL);\n\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_PRLI_RCVD:\n\t\t \n\t\t \n\t\tefc_process_prli_payload(node, cbdata->payload->dma.virt);\n\t\tefc_send_ls_acc_after_attach(node,\n\t\t\t\t\t     cbdata->header->dma.virt,\n\t\t\t\tEFC_NODE_SEND_LS_ACC_PRLI);\n\t\tefc_node_transition(node, __efc_d_wait_plogi_rsp_recvd_prli,\n\t\t\t\t    NULL);\n\t\tbreak;\n\n\tcase EFC_EVT_LOGO_RCVD:  \n\tcase EFC_EVT_PRLO_RCVD:\n\tcase EFC_EVT_PDISC_RCVD:\n\tcase EFC_EVT_FDISC_RCVD:\n\tcase EFC_EVT_ADISC_RCVD:\n\tcase EFC_EVT_RSCN_RCVD:\n\tcase EFC_EVT_SCR_RCVD: {\n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\n\t\tnode_printf(node, \"%s received, sending reject\\n\",\n\t\t\t    efc_sm_event_name(evt));\n\n\t\tefc_send_ls_rjt(node, be16_to_cpu(hdr->fh_ox_id),\n\t\t\t\tELS_RJT_UNAB, ELS_EXPL_PLOGI_REQD, 0);\n\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_SRRS_ELS_REQ_OK:\t \n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_PLOGI,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\t \n\t\tefc_node_save_sparms(node, cbdata->els_rsp.virt);\n\t\trc = efc_node_attach(node);\n\t\tefc_node_transition(node, __efc_d_wait_node_attach, NULL);\n\t\tif (rc < 0)\n\t\t\tefc_node_post_event(node,\n\t\t\t\t\t    EFC_EVT_NODE_ATTACH_FAIL, NULL);\n\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_REQ_FAIL:\t \n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_PLOGI,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\tefc_node_post_event(node, EFC_EVT_SHUTDOWN, NULL);\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_REQ_RJT:\n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_PLOGI,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\tbreak;\n\n\tcase EFC_EVT_FCP_CMD_RCVD: {\n\t\t \n\t\tnode_printf(node, \"FCP_CMND received, drop\\n\");\n\t\tbreak;\n\t}\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_plogi_rsp_recvd_prli(struct efc_sm_ctx *ctx,\n\t\t\t\t  enum efc_sm_event evt, void *arg)\n{\n\tint rc;\n\tstruct efc_node_cb *cbdata = arg;\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\t \n\t\tefc_node_hold_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_REQ_OK:\t \n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_PLOGI,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\t \n\t\tefc_node_save_sparms(node, cbdata->els_rsp.virt);\n\t\trc = efc_node_attach(node);\n\t\tefc_node_transition(node, __efc_d_wait_node_attach, NULL);\n\t\tif (rc < 0)\n\t\t\tefc_node_post_event(node, EFC_EVT_NODE_ATTACH_FAIL,\n\t\t\t\t\t    NULL);\n\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_REQ_FAIL:\t \n\tcase EFC_EVT_SRRS_ELS_REQ_RJT:\n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_PLOGI,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\tefc_node_post_event(node, EFC_EVT_SHUTDOWN, NULL);\n\t\tbreak;\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_domain_attach(struct efc_sm_ctx *ctx,\n\t\t\t   enum efc_sm_event evt, void *arg)\n{\n\tint rc;\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_DOMAIN_ATTACH_OK:\n\t\tWARN_ON(!node->nport->domain->attached);\n\t\t \n\t\trc = efc_node_attach(node);\n\t\tefc_node_transition(node, __efc_d_wait_node_attach, NULL);\n\t\tif (rc < 0)\n\t\t\tefc_node_post_event(node, EFC_EVT_NODE_ATTACH_FAIL,\n\t\t\t\t\t    NULL);\n\n\t\tbreak;\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_topology_notify(struct efc_sm_ctx *ctx,\n\t\t\t     enum efc_sm_event evt, void *arg)\n{\n\tint rc;\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_NPORT_TOPOLOGY_NOTIFY: {\n\t\tenum efc_nport_topology *topology = arg;\n\n\t\tWARN_ON(node->nport->domain->attached);\n\n\t\tWARN_ON(node->send_ls_acc != EFC_NODE_SEND_LS_ACC_PLOGI);\n\n\t\tnode_printf(node, \"topology notification, topology=%d\\n\",\n\t\t\t    *topology);\n\n\t\t \n\t\tif (*topology == EFC_NPORT_TOPO_P2P) {\n\t\t\t \n\t\t\tefc_domain_attach(node->nport->domain,\n\t\t\t\t\t  node->ls_acc_did);\n\t\t}\n\t\t \n\n\t\tefc_node_transition(node, __efc_d_wait_domain_attach, NULL);\n\t\tbreak;\n\t}\n\tcase EFC_EVT_DOMAIN_ATTACH_OK:\n\t\tWARN_ON(!node->nport->domain->attached);\n\t\tnode_printf(node, \"domain attach ok\\n\");\n\t\t \n\t\trc = efc_node_attach(node);\n\t\tefc_node_transition(node, __efc_d_wait_node_attach, NULL);\n\t\tif (rc < 0)\n\t\t\tefc_node_post_event(node,\n\t\t\t\t\t    EFC_EVT_NODE_ATTACH_FAIL, NULL);\n\n\t\tbreak;\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_node_attach(struct efc_sm_ctx *ctx,\n\t\t\t enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_NODE_ATTACH_OK:\n\t\tnode->attached = true;\n\t\tswitch (node->send_ls_acc) {\n\t\tcase EFC_NODE_SEND_LS_ACC_PLOGI: {\n\t\t\t \n\t\t\t \n\t\t\tefc_send_plogi_acc(node, node->ls_acc_oxid);\n\t\t\tefc_node_transition(node, __efc_d_wait_plogi_acc_cmpl,\n\t\t\t\t\t    NULL);\n\t\t\tnode->send_ls_acc = EFC_NODE_SEND_LS_ACC_NONE;\n\t\t\tnode->ls_acc_io = NULL;\n\t\t\tbreak;\n\t\t}\n\t\tcase EFC_NODE_SEND_LS_ACC_PRLI: {\n\t\t\tefc_d_send_prli_rsp(node, node->ls_acc_oxid);\n\t\t\tnode->send_ls_acc = EFC_NODE_SEND_LS_ACC_NONE;\n\t\t\tnode->ls_acc_io = NULL;\n\t\t\tbreak;\n\t\t}\n\t\tcase EFC_NODE_SEND_LS_ACC_NONE:\n\t\tdefault:\n\t\t\t \n\t\t\t \n\t\t\tefc_node_transition(node,\n\t\t\t\t\t    __efc_d_port_logged_in, NULL);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\n\tcase EFC_EVT_NODE_ATTACH_FAIL:\n\t\t \n\t\tnode->attached = false;\n\t\tnode_printf(node, \"node attach failed\\n\");\n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_DEFAULT;\n\t\tefc_node_transition(node, __efc_d_initiate_shutdown, NULL);\n\t\tbreak;\n\n\t \n\tcase EFC_EVT_SHUTDOWN:\n\t\tnode_printf(node, \"%s received\\n\", efc_sm_event_name(evt));\n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_DEFAULT;\n\t\tefc_node_transition(node, __efc_d_wait_attach_evt_shutdown,\n\t\t\t\t    NULL);\n\t\tbreak;\n\tcase EFC_EVT_SHUTDOWN_EXPLICIT_LOGO:\n\t\tnode_printf(node, \"%s received\\n\", efc_sm_event_name(evt));\n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_EXPLICIT_LOGO;\n\t\tefc_node_transition(node, __efc_d_wait_attach_evt_shutdown,\n\t\t\t\t    NULL);\n\t\tbreak;\n\tcase EFC_EVT_SHUTDOWN_IMPLICIT_LOGO:\n\t\tnode_printf(node, \"%s received\\n\", efc_sm_event_name(evt));\n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_IMPLICIT_LOGO;\n\t\tefc_node_transition(node,\n\t\t\t\t    __efc_d_wait_attach_evt_shutdown, NULL);\n\t\tbreak;\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_attach_evt_shutdown(struct efc_sm_ctx *ctx,\n\t\t\t\t enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\t \n\tcase EFC_EVT_NODE_ATTACH_OK:\n\t\tnode->attached = true;\n\t\tnode_printf(node, \"Attach evt=%s, proceed to shutdown\\n\",\n\t\t\t    efc_sm_event_name(evt));\n\t\tefc_node_transition(node, __efc_d_initiate_shutdown, NULL);\n\t\tbreak;\n\n\tcase EFC_EVT_NODE_ATTACH_FAIL:\n\t\t \n\t\tnode->attached = false;\n\t\tnode_printf(node, \"Attach evt=%s, proceed to shutdown\\n\",\n\t\t\t    efc_sm_event_name(evt));\n\t\tefc_node_transition(node, __efc_d_initiate_shutdown, NULL);\n\t\tbreak;\n\n\t \n\tcase EFC_EVT_SHUTDOWN:\n\t\t \n\t\tnode->shutdown_reason = EFC_NODE_SHUTDOWN_DEFAULT;\n\t\tfallthrough;\n\n\tcase EFC_EVT_SHUTDOWN_EXPLICIT_LOGO:\n\tcase EFC_EVT_SHUTDOWN_IMPLICIT_LOGO:\n\t\tnode_printf(node, \"%s received\\n\", efc_sm_event_name(evt));\n\t\tbreak;\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_port_logged_in(struct efc_sm_ctx *ctx,\n\t\t       enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node_cb *cbdata = arg;\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\t \n\t\tif (node->nport->enable_ini &&\n\t\t    !(node->rnode.fc_id != FC_FID_DOM_MGR)) {\n\t\t\t \n\t\t\tefc_send_prli(node);\n\t\t\t \n\t\t}\n\t\tbreak;\n\n\tcase EFC_EVT_FCP_CMD_RCVD: {\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_PRLI_RCVD: {\n\t\t \n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\t\tstruct {\n\t\t\tstruct fc_els_prli prli;\n\t\t\tstruct fc_els_spp sp;\n\t\t} *pp;\n\n\t\tpp = cbdata->payload->dma.virt;\n\t\tif (pp->sp.spp_type != FC_TYPE_FCP) {\n\t\t\t \n\t\t\tefc_send_ls_rjt(node, be16_to_cpu(hdr->fh_ox_id),\n\t\t\t\t\tELS_RJT_UNAB, ELS_EXPL_UNSUPR, 0);\n\t\t\tbreak;\n\t\t}\n\n\t\tefc_process_prli_payload(node, cbdata->payload->dma.virt);\n\t\tefc_d_send_prli_rsp(node, be16_to_cpu(hdr->fh_ox_id));\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_NODE_SESS_REG_OK:\n\t\tif (node->send_ls_acc == EFC_NODE_SEND_LS_ACC_PRLI)\n\t\t\tefc_send_prli_acc(node, node->ls_acc_oxid);\n\n\t\tnode->send_ls_acc = EFC_NODE_SEND_LS_ACC_NONE;\n\t\tefc_node_transition(node, __efc_d_device_ready, NULL);\n\t\tbreak;\n\n\tcase EFC_EVT_NODE_SESS_REG_FAIL:\n\t\tefc_send_ls_rjt(node, node->ls_acc_oxid, ELS_RJT_UNAB,\n\t\t\t\tELS_EXPL_UNSUPR, 0);\n\t\tnode->send_ls_acc = EFC_NODE_SEND_LS_ACC_NONE;\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_REQ_OK: {\t \n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_PRLI,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\t \n\t\tefc_process_prli_payload(node, cbdata->els_rsp.virt);\n\t\tefc_node_transition(node, __efc_d_device_ready, NULL);\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_SRRS_ELS_REQ_FAIL: {\t \n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_PRLI,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\tefc_node_post_event(node, EFC_EVT_SHUTDOWN, NULL);\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_SRRS_ELS_REQ_RJT: {\n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_PRLI,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_SRRS_ELS_CMPL_OK: {\n\t\t \n\t\t \n\t\tWARN_ON(!node->els_cmpl_cnt);\n\t\tnode->els_cmpl_cnt--;\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_PLOGI_RCVD: {\n\t\t \n\t\tefc_node_save_sparms(node, cbdata->payload->dma.virt);\n\t\tefc_send_ls_acc_after_attach(node,\n\t\t\t\t\t     cbdata->header->dma.virt,\n\t\t\t\tEFC_NODE_SEND_LS_ACC_PLOGI);\n\n\t\t \n\t\tefc_node_post_event(node, EFC_EVT_SHUTDOWN_IMPLICIT_LOGO,\n\t\t\t\t    NULL);\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_LOGO_RCVD: {\n\t\t \n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\n\t\tnode_printf(node, \"%s received attached=%d\\n\",\n\t\t\t    efc_sm_event_name(evt),\n\t\t\t\t\tnode->attached);\n\t\t \n\t\tefc_send_logo_acc(node, be16_to_cpu(hdr->fh_ox_id));\n\t\tefc_node_transition(node, __efc_d_wait_logo_acc_cmpl, NULL);\n\t\tbreak;\n\t}\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_logo_acc_cmpl(struct efc_sm_ctx *ctx,\n\t\t\t   enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tefc_node_hold_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tefc_node_accept_frames(node);\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_CMPL_OK:\n\tcase EFC_EVT_SRRS_ELS_CMPL_FAIL:\n\t\t \n\t\tWARN_ON(!node->els_cmpl_cnt);\n\t\tnode->els_cmpl_cnt--;\n\t\tefc_node_post_event(node,\n\t\t\t\t    EFC_EVT_SHUTDOWN_EXPLICIT_LOGO, NULL);\n\t\tbreak;\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_device_ready(struct efc_sm_ctx *ctx,\n\t\t     enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node_cb *cbdata = arg;\n\tstruct efc_node *node = ctx->app;\n\tstruct efc *efc = node->efc;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tif (evt != EFC_EVT_FCP_CMD_RCVD)\n\t\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER:\n\t\tnode->fcp_enabled = true;\n\t\tif (node->targ) {\n\t\t\tefc_log_info(efc,\n\t\t\t\t     \"[%s] found (target) WWPN %s WWNN %s\\n\",\n\t\t\t\tnode->display_name,\n\t\t\t\tnode->wwpn, node->wwnn);\n\t\t\tif (node->nport->enable_ini)\n\t\t\t\tefc->tt.scsi_new_node(efc, node);\n\t\t}\n\t\tbreak;\n\n\tcase EFC_EVT_EXIT:\n\t\tnode->fcp_enabled = false;\n\t\tbreak;\n\n\tcase EFC_EVT_PLOGI_RCVD: {\n\t\t \n\t\tefc_node_save_sparms(node, cbdata->payload->dma.virt);\n\t\tefc_send_ls_acc_after_attach(node,\n\t\t\t\t\t     cbdata->header->dma.virt,\n\t\t\t\tEFC_NODE_SEND_LS_ACC_PLOGI);\n\n\t\t \n\t\tefc_node_post_event(node,\n\t\t\t\t    EFC_EVT_SHUTDOWN_IMPLICIT_LOGO, NULL);\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_PRLI_RCVD: {\n\t\t \n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\t\tstruct {\n\t\t\tstruct fc_els_prli prli;\n\t\t\tstruct fc_els_spp sp;\n\t\t} *pp;\n\n\t\tpp = cbdata->payload->dma.virt;\n\t\tif (pp->sp.spp_type != FC_TYPE_FCP) {\n\t\t\t \n\t\t\tefc_send_ls_rjt(node, be16_to_cpu(hdr->fh_ox_id),\n\t\t\t\t\tELS_RJT_UNAB, ELS_EXPL_UNSUPR, 0);\n\t\t\tbreak;\n\t\t}\n\n\t\tefc_process_prli_payload(node, cbdata->payload->dma.virt);\n\t\tefc_send_prli_acc(node, be16_to_cpu(hdr->fh_ox_id));\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_PRLO_RCVD: {\n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\t\t \n\t\tefc_send_prlo_acc(node, be16_to_cpu(hdr->fh_ox_id));\n\t\t \n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_LOGO_RCVD: {\n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\n\t\tnode_printf(node, \"%s received attached=%d\\n\",\n\t\t\t    efc_sm_event_name(evt), node->attached);\n\t\t \n\t\tefc_send_logo_acc(node, be16_to_cpu(hdr->fh_ox_id));\n\t\tefc_node_transition(node, __efc_d_wait_logo_acc_cmpl, NULL);\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_ADISC_RCVD: {\n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\t\t \n\t\tefc_send_adisc_acc(node, be16_to_cpu(hdr->fh_ox_id));\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_ABTS_RCVD:\n\t\t \n\t\tefc_log_err(efc, \"Unexpected event:%s\\n\",\n\t\t\t    efc_sm_event_name(evt));\n\t\tbreak;\n\n\tcase EFC_EVT_NODE_ACTIVE_IO_LIST_EMPTY:\n\t\tbreak;\n\n\tcase EFC_EVT_NODE_REFOUND:\n\t\tbreak;\n\n\tcase EFC_EVT_NODE_MISSING:\n\t\tif (node->nport->enable_rscn)\n\t\t\tefc_node_transition(node, __efc_d_device_gone, NULL);\n\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_CMPL_OK:\n\t\t \n\t\tWARN_ON(!node->els_cmpl_cnt);\n\t\tnode->els_cmpl_cnt--;\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_CMPL_FAIL:\n\t\t \n\t\tWARN_ON(!node->els_cmpl_cnt);\n\t\tnode->els_cmpl_cnt--;\n\t\tnode_printf(node, \"Failed to send PRLI LS_ACC\\n\");\n\t\tbreak;\n\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_device_gone(struct efc_sm_ctx *ctx,\n\t\t    enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node_cb *cbdata = arg;\n\tstruct efc_node *node = ctx->app;\n\tstruct efc *efc = node->efc;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_ENTER: {\n\t\tint rc = EFC_SCSI_CALL_COMPLETE;\n\t\tint rc_2 = EFC_SCSI_CALL_COMPLETE;\n\t\tstatic const char * const labels[] = {\n\t\t\t\"none\", \"initiator\", \"target\", \"initiator+target\"\n\t\t};\n\n\t\tefc_log_info(efc, \"[%s] missing (%s)    WWPN %s WWNN %s\\n\",\n\t\t\t     node->display_name,\n\t\t\t\tlabels[(node->targ << 1) | (node->init)],\n\t\t\t\t\t\tnode->wwpn, node->wwnn);\n\n\t\tswitch (efc_node_get_enable(node)) {\n\t\tcase EFC_NODE_ENABLE_T_TO_T:\n\t\tcase EFC_NODE_ENABLE_I_TO_T:\n\t\tcase EFC_NODE_ENABLE_IT_TO_T:\n\t\t\trc = efc->tt.scsi_del_node(efc, node,\n\t\t\t\tEFC_SCSI_TARGET_MISSING);\n\t\t\tbreak;\n\n\t\tcase EFC_NODE_ENABLE_T_TO_I:\n\t\tcase EFC_NODE_ENABLE_I_TO_I:\n\t\tcase EFC_NODE_ENABLE_IT_TO_I:\n\t\t\trc = efc->tt.scsi_del_node(efc, node,\n\t\t\t\tEFC_SCSI_INITIATOR_MISSING);\n\t\t\tbreak;\n\n\t\tcase EFC_NODE_ENABLE_T_TO_IT:\n\t\t\trc = efc->tt.scsi_del_node(efc, node,\n\t\t\t\tEFC_SCSI_INITIATOR_MISSING);\n\t\t\tbreak;\n\n\t\tcase EFC_NODE_ENABLE_I_TO_IT:\n\t\t\trc = efc->tt.scsi_del_node(efc, node,\n\t\t\t\t\t\t  EFC_SCSI_TARGET_MISSING);\n\t\t\tbreak;\n\n\t\tcase EFC_NODE_ENABLE_IT_TO_IT:\n\t\t\trc = efc->tt.scsi_del_node(efc, node,\n\t\t\t\tEFC_SCSI_INITIATOR_MISSING);\n\t\t\trc_2 = efc->tt.scsi_del_node(efc, node,\n\t\t\t\tEFC_SCSI_TARGET_MISSING);\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\trc = EFC_SCSI_CALL_COMPLETE;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (rc == EFC_SCSI_CALL_COMPLETE &&\n\t\t    rc_2 == EFC_SCSI_CALL_COMPLETE)\n\t\t\tefc_node_post_event(node, EFC_EVT_SHUTDOWN, NULL);\n\n\t\tbreak;\n\t}\n\tcase EFC_EVT_NODE_REFOUND:\n\t\t \n\n\t\t \n\t\t \n\n\t\t \n\t\t \n\t\tefc_send_adisc(node);\n\t\tefc_node_transition(node, __efc_d_wait_adisc_rsp, NULL);\n\t\tbreak;\n\n\tcase EFC_EVT_PLOGI_RCVD: {\n\t\t \n\t\tefc_node_save_sparms(node, cbdata->payload->dma.virt);\n\t\tefc_send_ls_acc_after_attach(node,\n\t\t\t\t\t     cbdata->header->dma.virt,\n\t\t\t\tEFC_NODE_SEND_LS_ACC_PLOGI);\n\n\t\t \n\t\tefc_node_post_event(node, EFC_EVT_SHUTDOWN_IMPLICIT_LOGO,\n\t\t\t\t    NULL);\n\t\tbreak;\n\t}\n\n\tcase EFC_EVT_FCP_CMD_RCVD: {\n\t\t \n\t\tnode_printf(node, \"FCP_CMND received, drop\\n\");\n\t\tbreak;\n\t}\n\tcase EFC_EVT_LOGO_RCVD: {\n\t\t \n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\n\t\tnode_printf(node, \"%s received attached=%d\\n\",\n\t\t\t    efc_sm_event_name(evt), node->attached);\n\t\t \n\t\tefc_send_logo_acc(node, be16_to_cpu(hdr->fh_ox_id));\n\t\tefc_node_transition(node, __efc_d_wait_logo_acc_cmpl, NULL);\n\t\tbreak;\n\t}\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n\nvoid\n__efc_d_wait_adisc_rsp(struct efc_sm_ctx *ctx,\n\t\t       enum efc_sm_event evt, void *arg)\n{\n\tstruct efc_node_cb *cbdata = arg;\n\tstruct efc_node *node = ctx->app;\n\n\tefc_node_evt_set(ctx, evt, __func__);\n\n\tnode_sm_trace();\n\n\tswitch (evt) {\n\tcase EFC_EVT_SRRS_ELS_REQ_OK:\n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_ADISC,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\tefc_node_transition(node, __efc_d_device_ready, NULL);\n\t\tbreak;\n\n\tcase EFC_EVT_SRRS_ELS_REQ_RJT:\n\t\t \n\t\tif (efc_node_check_els_req(ctx, evt, arg, ELS_ADISC,\n\t\t\t\t\t   __efc_d_common, __func__))\n\t\t\treturn;\n\n\t\tWARN_ON(!node->els_req_cnt);\n\t\tnode->els_req_cnt--;\n\t\t \n\t\tefc_node_post_event(node,\n\t\t\t\t    EFC_EVT_SHUTDOWN_EXPLICIT_LOGO,\n\t\t\t\t     NULL);\n\t\tbreak;\n\n\tcase EFC_EVT_LOGO_RCVD: {\n\t\t \n\t\t \n\t\tstruct fc_frame_header *hdr = cbdata->header->dma.virt;\n\n\t\tnode_printf(node, \"%s received attached=%d\\n\",\n\t\t\t    efc_sm_event_name(evt), node->attached);\n\n\t\tefc_send_logo_acc(node, be16_to_cpu(hdr->fh_ox_id));\n\t\tefc_node_transition(node, __efc_d_wait_logo_acc_cmpl, NULL);\n\t\tbreak;\n\t}\n\tdefault:\n\t\t__efc_d_common(__func__, ctx, evt, arg);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}