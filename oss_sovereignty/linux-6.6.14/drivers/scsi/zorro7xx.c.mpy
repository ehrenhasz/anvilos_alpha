{
  "module_name": "zorro7xx.c",
  "hash_id": "c48a87c685f59e5df494ae66d67f68b2832ae4343cb548ae9354f42f36b479cf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/zorro7xx.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/zorro.h>\n#include <linux/slab.h>\n\n#include <asm/amigahw.h>\n#include <asm/amigaints.h>\n\n#include <scsi/scsi_host.h>\n#include <scsi/scsi_transport_spi.h>\n\n#include \"53c700.h\"\n\nMODULE_AUTHOR(\"Alan Hourihane <alanh@fairlite.demon.co.uk> / Kars de Jong <jongk@linux-m68k.org>\");\nMODULE_DESCRIPTION(\"Amiga Zorro NCR53C710 driver\");\nMODULE_LICENSE(\"GPL\");\n\n\nstatic struct scsi_host_template zorro7xx_scsi_driver_template = {\n\t.proc_name\t= \"zorro7xx\",\n\t.this_id\t= 7,\n\t.module\t\t= THIS_MODULE,\n};\n\nstatic struct zorro_driver_data {\n\tconst char *name;\n\tunsigned long offset;\n\tint absolute;\t \n} zorro7xx_driver_data[] = {\n\t{ .name = \"PowerUP 603e+\", .offset = 0xf40000, .absolute = 1 },\n\t{ .name = \"WarpEngine 40xx\", .offset = 0x40000 },\n\t{ .name = \"A4091\", .offset = 0x800000 },\n\t{ .name = \"GForce 040/060\", .offset = 0x40000 },\n\t{ 0 }\n};\n\nstatic struct zorro_device_id zorro7xx_zorro_tbl[] = {\n\t{\n\t\t.id = ZORRO_PROD_PHASE5_BLIZZARD_603E_PLUS,\n\t\t.driver_data = (unsigned long)&zorro7xx_driver_data[0],\n\t},\n\t{\n\t\t.id = ZORRO_PROD_MACROSYSTEMS_WARP_ENGINE_40xx,\n\t\t.driver_data = (unsigned long)&zorro7xx_driver_data[1],\n\t},\n\t{\n\t\t.id = ZORRO_PROD_CBM_A4091_1,\n\t\t.driver_data = (unsigned long)&zorro7xx_driver_data[2],\n\t},\n\t{\n\t\t.id = ZORRO_PROD_CBM_A4091_2,\n\t\t.driver_data = (unsigned long)&zorro7xx_driver_data[2],\n\t},\n\t{\n\t\t.id = ZORRO_PROD_GVP_GFORCE_040_060,\n\t\t.driver_data = (unsigned long)&zorro7xx_driver_data[3],\n\t},\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(zorro, zorro7xx_zorro_tbl);\n\nstatic int zorro7xx_init_one(struct zorro_dev *z,\n\t\t\t     const struct zorro_device_id *ent)\n{\n\tstruct Scsi_Host *host;\n\tstruct NCR_700_Host_Parameters *hostdata;\n\tstruct zorro_driver_data *zdd;\n\tunsigned long board, ioaddr;\n\n\tboard = zorro_resource_start(z);\n\tzdd = (struct zorro_driver_data *)ent->driver_data;\n\n\tif (zdd->absolute) {\n\t\tioaddr = zdd->offset;\n\t} else {\n\t\tioaddr = board + zdd->offset;\n\t}\n\n\tif (!zorro_request_device(z, zdd->name)) {\n\t\tprintk(KERN_ERR \"zorro7xx: cannot reserve region 0x%lx, abort\\n\",\n\t\t       board);\n\t\treturn -EBUSY;\n\t}\n\n\thostdata = kzalloc(sizeof(struct NCR_700_Host_Parameters), GFP_KERNEL);\n\tif (!hostdata) {\n\t\tprintk(KERN_ERR \"zorro7xx: Failed to allocate host data\\n\");\n\t\tgoto out_release;\n\t}\n\n\t \n\tif (ioaddr > 0x01000000)\n\t\thostdata->base = ioremap(ioaddr, zorro_resource_len(z));\n\telse\n\t\thostdata->base = ZTWO_VADDR(ioaddr);\n\n\thostdata->clock = 50;\n\thostdata->chip710 = 1;\n\n\t \n\thostdata->ctest7_extra = CTEST7_TT1;\n\n\tzorro7xx_scsi_driver_template.name = zdd->name;\n\n\t \n\thost = NCR_700_detect(&zorro7xx_scsi_driver_template, hostdata,\n\t\t\t      &z->dev);\n\tif (!host) {\n\t\tprintk(KERN_ERR \"zorro7xx: No host detected; \"\n\t\t\t\t\"board configuration problem?\\n\");\n\t\tgoto out_free;\n\t}\n\n\thost->this_id = 7;\n\thost->base = ioaddr;\n\thost->irq = IRQ_AMIGA_PORTS;\n\n\tif (request_irq(host->irq, NCR_700_intr, IRQF_SHARED, \"zorro7xx-scsi\",\n\t\t\thost)) {\n\t\tprintk(KERN_ERR \"zorro7xx: request_irq failed\\n\");\n\t\tgoto out_put_host;\n\t}\n\n\tzorro_set_drvdata(z, host);\n\tscsi_scan_host(host);\n\n\treturn 0;\n\n out_put_host:\n\tscsi_host_put(host);\n out_free:\n\tif (ioaddr > 0x01000000)\n\t\tiounmap(hostdata->base);\n\tkfree(hostdata);\n out_release:\n\tzorro_release_device(z);\n\n\treturn -ENODEV;\n}\n\nstatic void zorro7xx_remove_one(struct zorro_dev *z)\n{\n\tstruct Scsi_Host *host = zorro_get_drvdata(z);\n\tstruct NCR_700_Host_Parameters *hostdata = shost_priv(host);\n\n\tscsi_remove_host(host);\n\n\tNCR_700_release(host);\n\tif (host->base > 0x01000000)\n\t\tiounmap(hostdata->base);\n\tkfree(hostdata);\n\tfree_irq(host->irq, host);\n\tzorro_release_device(z);\n}\n\nstatic struct zorro_driver zorro7xx_driver = {\n\t.name\t  = \"zorro7xx-scsi\",\n\t.id_table = zorro7xx_zorro_tbl,\n\t.probe\t  = zorro7xx_init_one,\n\t.remove\t  = zorro7xx_remove_one,\n};\n\nstatic int __init zorro7xx_scsi_init(void)\n{\n\treturn zorro_register_driver(&zorro7xx_driver);\n}\n\nstatic void __exit zorro7xx_scsi_exit(void)\n{\n\tzorro_unregister_driver(&zorro7xx_driver);\n}\n\nmodule_init(zorro7xx_scsi_init);\nmodule_exit(zorro7xx_scsi_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}