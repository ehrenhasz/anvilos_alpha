{
  "module_name": "bfad_bsg.c",
  "hash_id": "c0f4e5f1cae4aea52733225a4d57eaf19f478f43e7dd2dd1fe4cf62b76e33ffb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/bfa/bfad_bsg.c",
  "human_readable_source": "\n \n\n#include <linux/uaccess.h>\n#include \"bfad_drv.h\"\n#include \"bfad_im.h\"\n#include \"bfad_bsg.h\"\n\nBFA_TRC_FILE(LDRV, BSG);\n\nstatic int\nbfad_iocmd_ioc_enable(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\t \n\tif (!bfa_ioc_is_disabled(&bfad->bfa.ioc)) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_OK;\n\t\treturn 0;\n\t}\n\n\tinit_completion(&bfad->enable_comp);\n\tbfa_iocfc_enable(&bfad->bfa);\n\tiocmd->status = BFA_STATUS_OK;\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\twait_for_completion(&bfad->enable_comp);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ioc_disable(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif (bfa_ioc_is_disabled(&bfad->bfa.ioc)) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_OK;\n\t\treturn 0;\n\t}\n\n\tif (bfad->disable_active) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\treturn -EBUSY;\n\t}\n\n\tbfad->disable_active = BFA_TRUE;\n\tinit_completion(&bfad->disable_comp);\n\tbfa_iocfc_disable(&bfad->bfa);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\twait_for_completion(&bfad->disable_comp);\n\tbfad->disable_active = BFA_FALSE;\n\tiocmd->status = BFA_STATUS_OK;\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ioc_get_info(struct bfad_s *bfad, void *cmd)\n{\n\tint\ti;\n\tstruct bfa_bsg_ioc_info_s *iocmd = (struct bfa_bsg_ioc_info_s *)cmd;\n\tstruct bfad_im_port_s\t*im_port;\n\tstruct bfa_port_attr_s\tpattr;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tbfa_fcport_get_attr(&bfad->bfa, &pattr);\n\tiocmd->nwwn = pattr.nwwn;\n\tiocmd->pwwn = pattr.pwwn;\n\tiocmd->ioc_type = bfa_get_type(&bfad->bfa);\n\tiocmd->mac = bfa_get_mac(&bfad->bfa);\n\tiocmd->factory_mac = bfa_get_mfg_mac(&bfad->bfa);\n\tbfa_get_adapter_serial_num(&bfad->bfa, iocmd->serialnum);\n\tiocmd->factorynwwn = pattr.factorynwwn;\n\tiocmd->factorypwwn = pattr.factorypwwn;\n\tiocmd->bfad_num = bfad->inst_no;\n\tim_port = bfad->pport.im_port;\n\tiocmd->host = im_port->shost->host_no;\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tstrcpy(iocmd->name, bfad->adapter_name);\n\tstrcpy(iocmd->port_name, bfad->port_name);\n\tstrcpy(iocmd->hwpath, bfad->pci_name);\n\n\t \n\tstrcpy(iocmd->adapter_hwpath, bfad->pci_name);\n\tfor (i = 0; iocmd->adapter_hwpath[i] != ':' && i < BFA_STRING_32; i++)\n\t\t;\n\tfor (; iocmd->adapter_hwpath[++i] != ':' && i < BFA_STRING_32; )\n\t\t;\n\tiocmd->adapter_hwpath[i] = '\\0';\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ioc_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_ioc_attr_s *iocmd = (struct bfa_bsg_ioc_attr_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tbfa_ioc_get_attr(&bfad->bfa.ioc, &iocmd->ioc_attr);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\t \n\tstrcpy(iocmd->ioc_attr.driver_attr.driver, BFAD_DRIVER_NAME);\n\tstrscpy(iocmd->ioc_attr.driver_attr.driver_ver,\n\t\tBFAD_DRIVER_VERSION, BFA_VERSION_LEN);\n\tstrcpy(iocmd->ioc_attr.driver_attr.fw_ver,\n\t\tiocmd->ioc_attr.adapter_attr.fw_ver);\n\tstrcpy(iocmd->ioc_attr.driver_attr.bios_ver,\n\t\tiocmd->ioc_attr.adapter_attr.optrom_ver);\n\n\t \n\tmemcpy(bfad->pci_attr.chip_rev, iocmd->ioc_attr.pci_attr.chip_rev,\n\t\tsizeof(bfad->pci_attr.chip_rev));\n\tmemcpy(&iocmd->ioc_attr.pci_attr, &bfad->pci_attr,\n\t\tsizeof(struct bfa_ioc_pci_attr_s));\n\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ioc_get_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_ioc_stats_s *iocmd = (struct bfa_bsg_ioc_stats_s *)cmd;\n\n\tbfa_ioc_get_stats(&bfad->bfa, &iocmd->ioc_stats);\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ioc_get_fwstats(struct bfad_s *bfad, void *cmd,\n\t\t\tunsigned int payload_len)\n{\n\tstruct bfa_bsg_ioc_fwstats_s *iocmd =\n\t\t\t(struct bfa_bsg_ioc_fwstats_s *)cmd;\n\tvoid\t*iocmd_bufptr;\n\tunsigned long\tflags;\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\t\tsizeof(struct bfa_bsg_ioc_fwstats_s),\n\t\t\tsizeof(struct bfa_fw_stats_s)) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\tgoto out;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_ioc_fwstats_s);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_ioc_fw_stats_get(&bfad->bfa.ioc, iocmd_bufptr);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t\tgoto out;\n\t}\nout:\n\tbfa_trc(bfad, 0x6666);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ioc_reset_stats(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tunsigned long\tflags;\n\n\tif (v_cmd == IOCMD_IOC_RESET_STATS) {\n\t\tbfa_ioc_clear_stats(&bfad->bfa);\n\t\tiocmd->status = BFA_STATUS_OK;\n\t} else if (v_cmd == IOCMD_IOC_RESET_FWSTATS) {\n\t\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\t\tiocmd->status = bfa_ioc_fw_stats_clear(&bfad->bfa.ioc);\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t}\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ioc_set_name(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\n{\n\tstruct bfa_bsg_ioc_name_s *iocmd = (struct bfa_bsg_ioc_name_s *) cmd;\n\n\tif (v_cmd == IOCMD_IOC_SET_ADAPTER_NAME)\n\t\tstrcpy(bfad->adapter_name, iocmd->name);\n\telse if (v_cmd == IOCMD_IOC_SET_PORT_NAME)\n\t\tstrcpy(bfad->port_name, iocmd->name);\n\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_iocfc_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_iocfc_attr_s *iocmd = (struct bfa_bsg_iocfc_attr_s *)cmd;\n\n\tiocmd->status = BFA_STATUS_OK;\n\tbfa_iocfc_get_attr(&bfad->bfa, &iocmd->iocfc_attr);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ioc_fw_sig_inv(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_ioc_fwsig_invalidate(&bfad->bfa.ioc);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_iocfc_set_intr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_iocfc_intr_s *iocmd = (struct bfa_bsg_iocfc_intr_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_iocfc_israttr_set(&bfad->bfa, &iocmd->attr);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_port_enable(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_port_enable(&bfad->bfa.modules.port,\n\t\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t\treturn 0;\n\t}\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_port_disable(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_port_disable(&bfad->bfa.modules.port,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t\treturn 0;\n\t}\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_port_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_port_attr_s *iocmd = (struct bfa_bsg_port_attr_s *)cmd;\n\tstruct bfa_lport_attr_s\tport_attr;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tbfa_fcport_get_attr(&bfad->bfa, &iocmd->attr);\n\tbfa_fcs_lport_get_attr(&bfad->bfa_fcs.fabric.bport, &port_attr);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tif (iocmd->attr.topology != BFA_PORT_TOPOLOGY_NONE)\n\t\tiocmd->attr.pid = port_attr.pid;\n\telse\n\t\tiocmd->attr.pid = 0;\n\n\tiocmd->attr.port_type = port_attr.port_type;\n\tiocmd->attr.loopback = port_attr.loopback;\n\tiocmd->attr.authfail = port_attr.authfail;\n\tstrscpy(iocmd->attr.port_symname.symname,\n\t\tport_attr.port_cfg.sym_name.symname,\n\t\tsizeof(iocmd->attr.port_symname.symname));\n\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_port_get_stats(struct bfad_s *bfad, void *cmd,\n\t\t\tunsigned int payload_len)\n{\n\tstruct bfa_bsg_port_stats_s *iocmd = (struct bfa_bsg_port_stats_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tvoid\t*iocmd_bufptr;\n\tunsigned long\tflags;\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\t\tsizeof(struct bfa_bsg_port_stats_s),\n\t\t\tsizeof(union bfa_port_stats_u)) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\treturn 0;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_port_stats_s);\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_port_get_stats(&bfad->bfa.modules.port,\n\t\t\t\tiocmd_bufptr, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t\tgoto out;\n\t}\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_port_reset_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_port_clear_stats(&bfad->bfa.modules.port,\n\t\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t\treturn 0;\n\t}\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_set_port_cfg(struct bfad_s *bfad, void *iocmd, unsigned int v_cmd)\n{\n\tstruct bfa_bsg_port_cfg_s *cmd = (struct bfa_bsg_port_cfg_s *)iocmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif (v_cmd == IOCMD_PORT_CFG_TOPO)\n\t\tcmd->status = bfa_fcport_cfg_topology(&bfad->bfa, cmd->param);\n\telse if (v_cmd == IOCMD_PORT_CFG_SPEED)\n\t\tcmd->status = bfa_fcport_cfg_speed(&bfad->bfa, cmd->param);\n\telse if (v_cmd == IOCMD_PORT_CFG_ALPA)\n\t\tcmd->status = bfa_fcport_cfg_hardalpa(&bfad->bfa, cmd->param);\n\telse if (v_cmd == IOCMD_PORT_CLR_ALPA)\n\t\tcmd->status = bfa_fcport_clr_hardalpa(&bfad->bfa);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_port_cfg_maxfrsize(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_port_cfg_maxfrsize_s *iocmd =\n\t\t\t\t(struct bfa_bsg_port_cfg_maxfrsize_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcport_cfg_maxfrsize(&bfad->bfa, iocmd->maxfrsize);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_port_cfg_bbcr(struct bfad_s *bfad, unsigned int cmd, void *pcmd)\n{\n\tstruct bfa_bsg_bbcr_enable_s *iocmd =\n\t\t\t(struct bfa_bsg_bbcr_enable_s *)pcmd;\n\tunsigned long flags;\n\tint rc;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif (cmd == IOCMD_PORT_BBCR_ENABLE)\n\t\trc = bfa_fcport_cfg_bbcr(&bfad->bfa, BFA_TRUE, iocmd->bb_scn);\n\telse if (cmd == IOCMD_PORT_BBCR_DISABLE)\n\t\trc = bfa_fcport_cfg_bbcr(&bfad->bfa, BFA_FALSE, 0);\n\telse {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\treturn -EINVAL;\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tiocmd->status = rc;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_port_get_bbcr_attr(struct bfad_s *bfad, void *pcmd)\n{\n\tstruct bfa_bsg_bbcr_attr_s *iocmd = (struct bfa_bsg_bbcr_attr_s *) pcmd;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status =\n\t\tbfa_fcport_get_bbcr_attr(&bfad->bfa, &iocmd->attr);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\n\nstatic int\nbfad_iocmd_lport_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_fcs_lport_s\t*fcs_port;\n\tstruct bfa_bsg_lport_attr_s *iocmd = (struct bfa_bsg_lport_attr_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (fcs_port == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tbfa_fcs_lport_get_attr(fcs_port, &iocmd->port_attr);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_lport_get_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_bsg_lport_stats_s *iocmd =\n\t\t\t(struct bfa_bsg_lport_stats_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (fcs_port == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tbfa_fcs_lport_get_stats(fcs_port, &iocmd->port_stats);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_lport_reset_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_bsg_reset_stats_s *iocmd =\n\t\t\t(struct bfa_bsg_reset_stats_s *)cmd;\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(&bfad->bfa);\n\tstruct list_head *qe, *qen;\n\tstruct bfa_itnim_s *itnim;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->vpwwn);\n\tif (fcs_port == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tbfa_fcs_lport_clear_stats(fcs_port);\n\t \n\tlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\n\t\titnim = (struct bfa_itnim_s *) qe;\n\t\tif (itnim->rport->rport_info.lp_tag != fcs_port->lp_tag)\n\t\t\tcontinue;\n\t\tbfa_itnim_clear_stats(itnim);\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_lport_get_iostats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_bsg_lport_iostats_s *iocmd =\n\t\t\t(struct bfa_bsg_lport_iostats_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (fcs_port == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tbfa_fcpim_port_iostats(&bfad->bfa, &iocmd->iostats,\n\t\t\tfcs_port->lp_tag);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_lport_get_rports(struct bfad_s *bfad, void *cmd,\n\t\t\tunsigned int payload_len)\n{\n\tstruct bfa_bsg_lport_get_rports_s *iocmd =\n\t\t\t(struct bfa_bsg_lport_get_rports_s *)cmd;\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tunsigned long\tflags;\n\tvoid\t*iocmd_bufptr;\n\n\tif (iocmd->nrports == 0)\n\t\treturn -EINVAL;\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\t\tsizeof(struct bfa_bsg_lport_get_rports_s),\n\t\t\tsizeof(struct bfa_rport_qualifier_s) * iocmd->nrports)\n\t\t\t!= BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\treturn 0;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd +\n\t\t\tsizeof(struct bfa_bsg_lport_get_rports_s);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (fcs_port == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tbfa_trc(bfad, 0);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tbfa_fcs_lport_get_rport_quals(fcs_port,\n\t\t\t(struct bfa_rport_qualifier_s *)iocmd_bufptr,\n\t\t\t&iocmd->nrports);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_rport_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_rport_attr_s *iocmd = (struct bfa_bsg_rport_attr_s *)cmd;\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_fcs_rport_s *fcs_rport;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (fcs_port == NULL) {\n\t\tbfa_trc(bfad, 0);\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tif (iocmd->pid)\n\t\tfcs_rport = bfa_fcs_lport_get_rport_by_qualifier(fcs_port,\n\t\t\t\t\t\tiocmd->rpwwn, iocmd->pid);\n\telse\n\t\tfcs_rport = bfa_fcs_rport_lookup(fcs_port, iocmd->rpwwn);\n\tif (fcs_rport == NULL) {\n\t\tbfa_trc(bfad, 0);\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\tgoto out;\n\t}\n\n\tbfa_fcs_rport_get_attr(fcs_rport, &iocmd->attr);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_rport_get_addr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_rport_scsi_addr_s *iocmd =\n\t\t\t(struct bfa_bsg_rport_scsi_addr_s *)cmd;\n\tstruct bfa_fcs_lport_s\t*fcs_port;\n\tstruct bfa_fcs_itnim_s\t*fcs_itnim;\n\tstruct bfad_itnim_s\t*drv_itnim;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (fcs_port == NULL) {\n\t\tbfa_trc(bfad, 0);\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tfcs_itnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\n\tif (fcs_itnim == NULL) {\n\t\tbfa_trc(bfad, 0);\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\tgoto out;\n\t}\n\n\tdrv_itnim = fcs_itnim->itnim_drv;\n\n\tif (drv_itnim && drv_itnim->im_port)\n\t\tiocmd->host = drv_itnim->im_port->shost->host_no;\n\telse {\n\t\tbfa_trc(bfad, 0);\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\tgoto out;\n\t}\n\n\tiocmd->target = drv_itnim->scsi_tgt_id;\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tiocmd->bus = 0;\n\tiocmd->lun = 0;\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_rport_get_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_rport_stats_s *iocmd =\n\t\t\t(struct bfa_bsg_rport_stats_s *)cmd;\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_fcs_rport_s *fcs_rport;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (fcs_port == NULL) {\n\t\tbfa_trc(bfad, 0);\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tfcs_rport = bfa_fcs_rport_lookup(fcs_port, iocmd->rpwwn);\n\tif (fcs_rport == NULL) {\n\t\tbfa_trc(bfad, 0);\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\tgoto out;\n\t}\n\n\tmemcpy((void *)&iocmd->stats, (void *)&fcs_rport->stats,\n\t\tsizeof(struct bfa_rport_stats_s));\n\tif (bfa_fcs_rport_get_halrport(fcs_rport)) {\n\t\tmemcpy((void *)&iocmd->stats.hal_stats,\n\t\t       (void *)&(bfa_fcs_rport_get_halrport(fcs_rport)->stats),\n\t\t\tsizeof(struct bfa_rport_hal_stats_s));\n\t}\n\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_rport_clr_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_rport_reset_stats_s *iocmd =\n\t\t\t\t(struct bfa_bsg_rport_reset_stats_s *)cmd;\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_fcs_rport_s *fcs_rport;\n\tstruct bfa_rport_s *rport;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (fcs_port == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tfcs_rport = bfa_fcs_rport_lookup(fcs_port, iocmd->rpwwn);\n\tif (fcs_rport == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\tgoto out;\n\t}\n\n\tmemset((char *)&fcs_rport->stats, 0, sizeof(struct bfa_rport_stats_s));\n\trport = bfa_fcs_rport_get_halrport(fcs_rport);\n\tif (rport)\n\t\tmemset(&rport->stats, 0, sizeof(rport->stats));\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_rport_set_speed(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_rport_set_speed_s *iocmd =\n\t\t\t\t(struct bfa_bsg_rport_set_speed_s *)cmd;\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_fcs_rport_s *fcs_rport;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (fcs_port == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tgoto out;\n\t}\n\n\tfcs_rport = bfa_fcs_rport_lookup(fcs_port, iocmd->rpwwn);\n\tif (fcs_rport == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\tgoto out;\n\t}\n\n\tfcs_rport->rpf.assigned_speed  = iocmd->speed;\n\t \n\tif (fcs_rport->rpf.rpsc_speed == BFA_PORT_SPEED_UNKNOWN)\n\t\tif (fcs_rport->bfa_rport)\n\t\t\tbfa_rport_speed(fcs_rport->bfa_rport, iocmd->speed);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_vport_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_fcs_vport_s *fcs_vport;\n\tstruct bfa_bsg_vport_attr_s *iocmd = (struct bfa_bsg_vport_attr_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_vport = bfa_fcs_vport_lookup(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->vpwwn);\n\tif (fcs_vport == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_VWWN;\n\t\tgoto out;\n\t}\n\n\tbfa_fcs_vport_get_attr(fcs_vport, &iocmd->vport_attr);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_vport_get_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_fcs_vport_s *fcs_vport;\n\tstruct bfa_bsg_vport_stats_s *iocmd =\n\t\t\t\t(struct bfa_bsg_vport_stats_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_vport = bfa_fcs_vport_lookup(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->vpwwn);\n\tif (fcs_vport == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_VWWN;\n\t\tgoto out;\n\t}\n\n\tmemcpy((void *)&iocmd->vport_stats, (void *)&fcs_vport->vport_stats,\n\t\tsizeof(struct bfa_vport_stats_s));\n\tmemcpy((void *)&iocmd->vport_stats.port_stats,\n\t       (void *)&fcs_vport->lport.stats,\n\t\tsizeof(struct bfa_lport_stats_s));\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_vport_clr_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_fcs_vport_s *fcs_vport;\n\tstruct bfa_bsg_reset_stats_s *iocmd =\n\t\t\t\t(struct bfa_bsg_reset_stats_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_vport = bfa_fcs_vport_lookup(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->vpwwn);\n\tif (fcs_vport == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_VWWN;\n\t\tgoto out;\n\t}\n\n\tmemset(&fcs_vport->vport_stats, 0, sizeof(struct bfa_vport_stats_s));\n\tmemset(&fcs_vport->lport.stats, 0, sizeof(struct bfa_lport_stats_s));\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fabric_get_lports(struct bfad_s *bfad, void *cmd,\n\t\t\tunsigned int payload_len)\n{\n\tstruct bfa_bsg_fabric_get_lports_s *iocmd =\n\t\t\t(struct bfa_bsg_fabric_get_lports_s *)cmd;\n\tbfa_fcs_vf_t\t*fcs_vf;\n\tuint32_t\tnports = iocmd->nports;\n\tunsigned long\tflags;\n\tvoid\t*iocmd_bufptr;\n\n\tif (nports == 0) {\n\t\tiocmd->status = BFA_STATUS_EINVAL;\n\t\tgoto out;\n\t}\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\tsizeof(struct bfa_bsg_fabric_get_lports_s),\n\t\tsizeof(wwn_t) * iocmd->nports) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\tgoto out;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd +\n\t\t\tsizeof(struct bfa_bsg_fabric_get_lports_s);\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_vf = bfa_fcs_vf_lookup(&bfad->bfa_fcs, iocmd->vf_id);\n\tif (fcs_vf == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_VFID;\n\t\tgoto out;\n\t}\n\tbfa_fcs_vf_get_ports(fcs_vf, (wwn_t *)iocmd_bufptr, &nports);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tiocmd->nports = nports;\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_qos_set_bw(struct bfad_s *bfad, void *pcmd)\n{\n\tstruct bfa_bsg_qos_bw_s *iocmd = (struct bfa_bsg_qos_bw_s *)pcmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcport_set_qos_bw(&bfad->bfa, &iocmd->qos_bw);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ratelim(struct bfad_s *bfad, unsigned int cmd, void *pcmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)pcmd;\n\tstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\n\tif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\n\t\t(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\n\t\tiocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\n\telse {\n\t\tif (cmd == IOCMD_RATELIM_ENABLE)\n\t\t\tfcport->cfg.ratelimit = BFA_TRUE;\n\t\telse if (cmd == IOCMD_RATELIM_DISABLE)\n\t\t\tfcport->cfg.ratelimit = BFA_FALSE;\n\n\t\tif (fcport->cfg.trl_def_speed == BFA_PORT_SPEED_UNKNOWN)\n\t\t\tfcport->cfg.trl_def_speed = BFA_PORT_SPEED_1GBPS;\n\n\t\tiocmd->status = BFA_STATUS_OK;\n\t}\n\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ratelim_speed(struct bfad_s *bfad, unsigned int cmd, void *pcmd)\n{\n\tstruct bfa_bsg_trl_speed_s *iocmd = (struct bfa_bsg_trl_speed_s *)pcmd;\n\tstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\n\t \n\tif ((iocmd->speed == BFA_PORT_SPEED_AUTO) ||\n\t    (iocmd->speed > fcport->speed_sup)) {\n\t\tiocmd->status = BFA_STATUS_UNSUPP_SPEED;\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\treturn 0;\n\t}\n\n\tif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\n\t\t(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\n\t\tiocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\n\telse {\n\t\tfcport->cfg.trl_def_speed = iocmd->speed;\n\t\tiocmd->status = BFA_STATUS_OK;\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_cfg_fcpim(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fcpim_s *iocmd = (struct bfa_bsg_fcpim_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tbfa_fcpim_path_tov_set(&bfad->bfa, iocmd->param);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcpim_get_modstats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fcpim_modstats_s *iocmd =\n\t\t\t(struct bfa_bsg_fcpim_modstats_s *)cmd;\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(&bfad->bfa);\n\tstruct list_head *qe, *qen;\n\tstruct bfa_itnim_s *itnim;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\t \n\tmemset((void *)&iocmd->modstats, 0, sizeof(struct bfa_itnim_iostats_s));\n\tlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\n\t\titnim = (struct bfa_itnim_s *) qe;\n\t\tbfa_fcpim_add_stats(&iocmd->modstats, &(itnim->stats));\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcpim_clr_modstats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fcpim_modstatsclr_s *iocmd =\n\t\t\t\t(struct bfa_bsg_fcpim_modstatsclr_s *)cmd;\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(&bfad->bfa);\n\tstruct list_head *qe, *qen;\n\tstruct bfa_itnim_s *itnim;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\n\t\titnim = (struct bfa_itnim_s *) qe;\n\t\tbfa_itnim_clear_stats(itnim);\n\t}\n\tmemset(&fcpim->del_itn_stats, 0,\n\t\tsizeof(struct bfa_fcpim_del_itn_stats_s));\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcpim_get_del_itn_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fcpim_del_itn_stats_s *iocmd =\n\t\t\t(struct bfa_bsg_fcpim_del_itn_stats_s *)cmd;\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(&bfad->bfa);\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tmemcpy((void *)&iocmd->modstats, (void *)&fcpim->del_itn_stats,\n\t\tsizeof(struct bfa_fcpim_del_itn_stats_s));\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_itnim_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_itnim_attr_s *iocmd = (struct bfa_bsg_itnim_attr_s *)cmd;\n\tstruct bfa_fcs_lport_s\t*fcs_port;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->lpwwn);\n\tif (!fcs_port)\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\telse\n\t\tiocmd->status = bfa_fcs_itnim_attr_get(fcs_port,\n\t\t\t\t\tiocmd->rpwwn, &iocmd->attr);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_itnim_get_iostats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_itnim_iostats_s *iocmd =\n\t\t\t(struct bfa_bsg_itnim_iostats_s *)cmd;\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_fcs_itnim_s *itnim;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->lpwwn);\n\tif (!fcs_port) {\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tbfa_trc(bfad, 0);\n\t} else {\n\t\titnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\n\t\tif (itnim == NULL)\n\t\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\telse {\n\t\t\tiocmd->status = BFA_STATUS_OK;\n\t\t\tif (bfa_fcs_itnim_get_halitn(itnim))\n\t\t\t\tmemcpy((void *)&iocmd->iostats, (void *)\n\t\t\t\t&(bfa_fcs_itnim_get_halitn(itnim)->stats),\n\t\t\t\t       sizeof(struct bfa_itnim_iostats_s));\n\t\t}\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_itnim_reset_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_rport_reset_stats_s *iocmd =\n\t\t\t(struct bfa_bsg_rport_reset_stats_s *)cmd;\n\tstruct bfa_fcs_lport_s\t*fcs_port;\n\tstruct bfa_fcs_itnim_s\t*itnim;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->pwwn);\n\tif (!fcs_port)\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\telse {\n\t\titnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\n\t\tif (itnim == NULL)\n\t\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\telse {\n\t\t\tiocmd->status = BFA_STATUS_OK;\n\t\t\tbfa_fcs_itnim_stats_clear(fcs_port, iocmd->rpwwn);\n\t\t\tbfa_itnim_clear_stats(bfa_fcs_itnim_get_halitn(itnim));\n\t\t}\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_itnim_get_itnstats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_itnim_itnstats_s *iocmd =\n\t\t\t(struct bfa_bsg_itnim_itnstats_s *)cmd;\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_fcs_itnim_s *itnim;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->lpwwn);\n\tif (!fcs_port) {\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tbfa_trc(bfad, 0);\n\t} else {\n\t\titnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\n\t\tif (itnim == NULL)\n\t\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\telse {\n\t\t\tiocmd->status = BFA_STATUS_OK;\n\t\t\tbfa_fcs_itnim_stats_get(fcs_port, iocmd->rpwwn,\n\t\t\t\t\t&iocmd->itnstats);\n\t\t}\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcport_enable(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcport_enable(&bfad->bfa);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcport_disable(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcport_disable(&bfad->bfa);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ioc_get_pcifn_cfg(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_pcifn_cfg_s *iocmd = (struct bfa_bsg_pcifn_cfg_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_ablk_query(&bfad->bfa.modules.ablk,\n\t\t\t\t&iocmd->pcifn_cfg,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_pcifn_create(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_pcifn_s *iocmd = (struct bfa_bsg_pcifn_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_ablk_pf_create(&bfad->bfa.modules.ablk,\n\t\t\t\t&iocmd->pcifn_id, iocmd->port,\n\t\t\t\tiocmd->pcifn_class, iocmd->bw_min,\n\t\t\t\tiocmd->bw_max, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_pcifn_delete(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_pcifn_s *iocmd = (struct bfa_bsg_pcifn_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_ablk_pf_delete(&bfad->bfa.modules.ablk,\n\t\t\t\tiocmd->pcifn_id,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_pcifn_bw(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_pcifn_s *iocmd = (struct bfa_bsg_pcifn_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_ablk_pf_update(&bfad->bfa.modules.ablk,\n\t\t\t\tiocmd->pcifn_id, iocmd->bw_min,\n\t\t\t\tiocmd->bw_max, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tbfa_trc(bfad, iocmd->status);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\n\tbfa_trc(bfad, iocmd->status);\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_adapter_cfg_mode(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_adapter_cfg_mode_s *iocmd =\n\t\t\t(struct bfa_bsg_adapter_cfg_mode_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags = 0;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_ablk_adapter_config(&bfad->bfa.modules.ablk,\n\t\t\t\tiocmd->cfg.mode, iocmd->cfg.max_pf,\n\t\t\t\tiocmd->cfg.max_vf, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_port_cfg_mode(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_port_cfg_mode_s *iocmd =\n\t\t\t(struct bfa_bsg_port_cfg_mode_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags = 0;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_ablk_port_config(&bfad->bfa.modules.ablk,\n\t\t\t\tiocmd->instance, iocmd->cfg.mode,\n\t\t\t\tiocmd->cfg.max_pf, iocmd->cfg.max_vf,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ablk_optrom(struct bfad_s *bfad, unsigned int cmd, void *pcmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)pcmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long   flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif (cmd == IOCMD_FLASH_ENABLE_OPTROM)\n\t\tiocmd->status = bfa_ablk_optrom_en(&bfad->bfa.modules.ablk,\n\t\t\t\t\tbfad_hcb_comp, &fcomp);\n\telse\n\t\tiocmd->status = bfa_ablk_optrom_dis(&bfad->bfa.modules.ablk,\n\t\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_faa_query(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_faa_attr_s *iocmd = (struct bfa_bsg_faa_attr_s *)cmd;\n\tstruct bfad_hal_comp    fcomp;\n\tunsigned long   flags;\n\n\tinit_completion(&fcomp.comp);\n\tiocmd->status = BFA_STATUS_OK;\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_faa_query(&bfad->bfa, &iocmd->faa_attr,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_cee_attr(struct bfad_s *bfad, void *cmd, unsigned int payload_len)\n{\n\tstruct bfa_bsg_cee_attr_s *iocmd =\n\t\t\t\t(struct bfa_bsg_cee_attr_s *)cmd;\n\tvoid\t*iocmd_bufptr;\n\tstruct bfad_hal_comp\tcee_comp;\n\tunsigned long\tflags;\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\t\tsizeof(struct bfa_bsg_cee_attr_s),\n\t\t\tsizeof(struct bfa_cee_attr_s)) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\treturn 0;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_cee_attr_s);\n\n\tcee_comp.status = 0;\n\tinit_completion(&cee_comp.comp);\n\tmutex_lock(&bfad_mutex);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_cee_get_attr(&bfad->bfa.modules.cee, iocmd_bufptr,\n\t\t\t\t\t bfad_hcb_comp, &cee_comp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tmutex_unlock(&bfad_mutex);\n\t\tbfa_trc(bfad, 0x5555);\n\t\tgoto out;\n\t}\n\twait_for_completion(&cee_comp.comp);\n\tmutex_unlock(&bfad_mutex);\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_cee_get_stats(struct bfad_s *bfad, void *cmd,\n\t\t\tunsigned int payload_len)\n{\n\tstruct bfa_bsg_cee_stats_s *iocmd =\n\t\t\t\t(struct bfa_bsg_cee_stats_s *)cmd;\n\tvoid\t*iocmd_bufptr;\n\tstruct bfad_hal_comp\tcee_comp;\n\tunsigned long\tflags;\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\t\tsizeof(struct bfa_bsg_cee_stats_s),\n\t\t\tsizeof(struct bfa_cee_stats_s)) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\treturn 0;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_cee_stats_s);\n\n\tcee_comp.status = 0;\n\tinit_completion(&cee_comp.comp);\n\tmutex_lock(&bfad_mutex);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_cee_get_stats(&bfad->bfa.modules.cee, iocmd_bufptr,\n\t\t\t\t\tbfad_hcb_comp, &cee_comp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tmutex_unlock(&bfad_mutex);\n\t\tbfa_trc(bfad, 0x5555);\n\t\tgoto out;\n\t}\n\twait_for_completion(&cee_comp.comp);\n\tmutex_unlock(&bfad_mutex);\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_cee_reset_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_cee_reset_stats(&bfad->bfa.modules.cee, NULL, NULL);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tbfa_trc(bfad, 0x5555);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_sfp_media(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_sfp_media_s *iocmd = (struct bfa_bsg_sfp_media_s *)cmd;\n\tstruct bfad_hal_comp\tfcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_sfp_media(BFA_SFP_MOD(&bfad->bfa), &iocmd->media,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tbfa_trc(bfad, iocmd->status);\n\tif (iocmd->status != BFA_STATUS_SFP_NOT_READY)\n\t\tgoto out;\n\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_sfp_speed(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_sfp_speed_s *iocmd = (struct bfa_bsg_sfp_speed_s *)cmd;\n\tstruct bfad_hal_comp\tfcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_sfp_speed(BFA_SFP_MOD(&bfad->bfa), iocmd->speed,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tbfa_trc(bfad, iocmd->status);\n\tif (iocmd->status != BFA_STATUS_SFP_NOT_READY)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_flash_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_flash_attr_s *iocmd =\n\t\t\t(struct bfa_bsg_flash_attr_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_flash_get_attr(BFA_FLASH(&bfad->bfa), &iocmd->attr,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_flash_erase_part(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_flash_s *iocmd = (struct bfa_bsg_flash_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_flash_erase_part(BFA_FLASH(&bfad->bfa), iocmd->type,\n\t\t\t\tiocmd->instance, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_flash_update_part(struct bfad_s *bfad, void *cmd,\n\t\t\tunsigned int payload_len)\n{\n\tstruct bfa_bsg_flash_s *iocmd = (struct bfa_bsg_flash_s *)cmd;\n\tvoid\t*iocmd_bufptr;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\t\tsizeof(struct bfa_bsg_flash_s),\n\t\t\tiocmd->bufsz) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\treturn 0;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_flash_s);\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_flash_update_part(BFA_FLASH(&bfad->bfa),\n\t\t\t\tiocmd->type, iocmd->instance, iocmd_bufptr,\n\t\t\t\tiocmd->bufsz, 0, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_flash_read_part(struct bfad_s *bfad, void *cmd,\n\t\t\tunsigned int payload_len)\n{\n\tstruct bfa_bsg_flash_s *iocmd = (struct bfa_bsg_flash_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tvoid\t*iocmd_bufptr;\n\tunsigned long\tflags;\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\t\tsizeof(struct bfa_bsg_flash_s),\n\t\t\tiocmd->bufsz) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\treturn 0;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_flash_s);\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_flash_read_part(BFA_FLASH(&bfad->bfa), iocmd->type,\n\t\t\t\tiocmd->instance, iocmd_bufptr, iocmd->bufsz, 0,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_temp(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_diag_get_temp_s *iocmd =\n\t\t\t(struct bfa_bsg_diag_get_temp_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_diag_tsensor_query(BFA_DIAG_MOD(&bfad->bfa),\n\t\t\t\t&iocmd->result, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tbfa_trc(bfad, iocmd->status);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_memtest(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_diag_memtest_s *iocmd =\n\t\t\t(struct bfa_bsg_diag_memtest_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long   flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_diag_memtest(BFA_DIAG_MOD(&bfad->bfa),\n\t\t\t\t&iocmd->memtest, iocmd->pat,\n\t\t\t\t&iocmd->result, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tbfa_trc(bfad, iocmd->status);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_loopback(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_diag_loopback_s *iocmd =\n\t\t\t(struct bfa_bsg_diag_loopback_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long   flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcdiag_loopback(&bfad->bfa, iocmd->opmode,\n\t\t\t\tiocmd->speed, iocmd->lpcnt, iocmd->pat,\n\t\t\t\t&iocmd->result, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tbfa_trc(bfad, iocmd->status);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_fwping(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_diag_fwping_s *iocmd =\n\t\t\t(struct bfa_bsg_diag_fwping_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long   flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_diag_fwping(BFA_DIAG_MOD(&bfad->bfa), iocmd->cnt,\n\t\t\t\tiocmd->pattern, &iocmd->result,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tbfa_trc(bfad, iocmd->status);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\tbfa_trc(bfad, 0x77771);\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_queuetest(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_diag_qtest_s *iocmd = (struct bfa_bsg_diag_qtest_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long   flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcdiag_queuetest(&bfad->bfa, iocmd->force,\n\t\t\t\tiocmd->queue, &iocmd->result,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_sfp(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_sfp_show_s *iocmd =\n\t\t\t(struct bfa_bsg_sfp_show_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long   flags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_sfp_show(BFA_SFP_MOD(&bfad->bfa), &iocmd->sfp,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tbfa_trc(bfad, iocmd->status);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\n\tbfa_trc(bfad, iocmd->status);\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_led(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_diag_led_s *iocmd = (struct bfa_bsg_diag_led_s *)cmd;\n\tunsigned long   flags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_diag_ledtest(BFA_DIAG_MOD(&bfad->bfa),\n\t\t\t\t&iocmd->ledtest);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_beacon_lport(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_diag_beacon_s *iocmd =\n\t\t\t(struct bfa_bsg_diag_beacon_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_diag_beacon_port(BFA_DIAG_MOD(&bfad->bfa),\n\t\t\t\tiocmd->beacon, iocmd->link_e2e_beacon,\n\t\t\t\tiocmd->second);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_lb_stat(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_diag_lb_stat_s *iocmd =\n\t\t\t(struct bfa_bsg_diag_lb_stat_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcdiag_lb_is_running(&bfad->bfa);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tbfa_trc(bfad, iocmd->status);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_dport_enable(struct bfad_s *bfad, void *pcmd)\n{\n\tstruct bfa_bsg_dport_enable_s *iocmd =\n\t\t\t\t(struct bfa_bsg_dport_enable_s *)pcmd;\n\tunsigned long\tflags;\n\tstruct bfad_hal_comp fcomp;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_dport_enable(&bfad->bfa, iocmd->lpcnt,\n\t\t\t\t\tiocmd->pat, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tbfa_trc(bfad, iocmd->status);\n\telse {\n\t\twait_for_completion(&fcomp.comp);\n\t\tiocmd->status = fcomp.status;\n\t}\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_dport_disable(struct bfad_s *bfad, void *pcmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)pcmd;\n\tunsigned long\tflags;\n\tstruct bfad_hal_comp fcomp;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_dport_disable(&bfad->bfa, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tbfa_trc(bfad, iocmd->status);\n\telse {\n\t\twait_for_completion(&fcomp.comp);\n\t\tiocmd->status = fcomp.status;\n\t}\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_dport_start(struct bfad_s *bfad, void *pcmd)\n{\n\tstruct bfa_bsg_dport_enable_s *iocmd =\n\t\t\t\t(struct bfa_bsg_dport_enable_s *)pcmd;\n\tunsigned long   flags;\n\tstruct bfad_hal_comp fcomp;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_dport_start(&bfad->bfa, iocmd->lpcnt,\n\t\t\t\t\tiocmd->pat, bfad_hcb_comp,\n\t\t\t\t\t&fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t} else {\n\t\twait_for_completion(&fcomp.comp);\n\t\tiocmd->status = fcomp.status;\n\t}\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_diag_dport_show(struct bfad_s *bfad, void *pcmd)\n{\n\tstruct bfa_bsg_diag_dport_show_s *iocmd =\n\t\t\t\t(struct bfa_bsg_diag_dport_show_s *)pcmd;\n\tunsigned long   flags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_dport_show(&bfad->bfa, &iocmd->result);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\n\nstatic int\nbfad_iocmd_phy_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_phy_attr_s *iocmd =\n\t\t\t(struct bfa_bsg_phy_attr_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_phy_get_attr(BFA_PHY(&bfad->bfa), iocmd->instance,\n\t\t\t\t&iocmd->attr, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_phy_get_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_phy_stats_s *iocmd =\n\t\t\t(struct bfa_bsg_phy_stats_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_phy_get_stats(BFA_PHY(&bfad->bfa), iocmd->instance,\n\t\t\t\t&iocmd->stats, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_phy_read(struct bfad_s *bfad, void *cmd, unsigned int payload_len)\n{\n\tstruct bfa_bsg_phy_s *iocmd = (struct bfa_bsg_phy_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tvoid\t*iocmd_bufptr;\n\tunsigned long\tflags;\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\t\tsizeof(struct bfa_bsg_phy_s),\n\t\t\tiocmd->bufsz) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\treturn 0;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_phy_s);\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_phy_read(BFA_PHY(&bfad->bfa),\n\t\t\t\tiocmd->instance, iocmd_bufptr, iocmd->bufsz,\n\t\t\t\t0, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_vhba_query(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_vhba_attr_s *iocmd =\n\t\t\t(struct bfa_bsg_vhba_attr_s *)cmd;\n\tstruct bfa_vhba_attr_s *attr = &iocmd->attr;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tattr->pwwn =  bfad->bfa.ioc.attr->pwwn;\n\tattr->nwwn =  bfad->bfa.ioc.attr->nwwn;\n\tattr->plog_enabled = (bfa_boolean_t)bfad->bfa.plog->plog_enabled;\n\tattr->io_profile = bfa_fcpim_get_io_profile(&bfad->bfa);\n\tattr->path_tov  = bfa_fcpim_path_tov_get(&bfad->bfa);\n\tiocmd->status = BFA_STATUS_OK;\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_phy_update(struct bfad_s *bfad, void *cmd, unsigned int payload_len)\n{\n\tstruct bfa_bsg_phy_s *iocmd = (struct bfa_bsg_phy_s *)cmd;\n\tvoid\t*iocmd_bufptr;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tif (bfad_chk_iocmd_sz(payload_len,\n\t\t\tsizeof(struct bfa_bsg_phy_s),\n\t\t\tiocmd->bufsz) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\treturn 0;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_phy_s);\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_phy_update(BFA_PHY(&bfad->bfa),\n\t\t\t\tiocmd->instance, iocmd_bufptr, iocmd->bufsz,\n\t\t\t\t0, bfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_porglog_get(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_debug_s *iocmd = (struct bfa_bsg_debug_s *)cmd;\n\tvoid *iocmd_bufptr;\n\n\tif (iocmd->bufsz < sizeof(struct bfa_plog_s)) {\n\t\tbfa_trc(bfad, sizeof(struct bfa_plog_s));\n\t\tiocmd->status = BFA_STATUS_EINVAL;\n\t\tgoto out;\n\t}\n\n\tiocmd->status = BFA_STATUS_OK;\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_debug_s);\n\tmemcpy(iocmd_bufptr, (u8 *) &bfad->plog_buf, sizeof(struct bfa_plog_s));\nout:\n\treturn 0;\n}\n\n#define BFA_DEBUG_FW_CORE_CHUNK_SZ\t0x4000U  \nstatic int\nbfad_iocmd_debug_fw_core(struct bfad_s *bfad, void *cmd,\n\t\t\tunsigned int payload_len)\n{\n\tstruct bfa_bsg_debug_s *iocmd = (struct bfa_bsg_debug_s *)cmd;\n\tvoid\t*iocmd_bufptr;\n\tunsigned long\tflags;\n\tu32 offset;\n\n\tif (bfad_chk_iocmd_sz(payload_len, sizeof(struct bfa_bsg_debug_s),\n\t\t\tBFA_DEBUG_FW_CORE_CHUNK_SZ) != BFA_STATUS_OK) {\n\t\tiocmd->status = BFA_STATUS_VERSION_FAIL;\n\t\treturn 0;\n\t}\n\n\tif (iocmd->bufsz < BFA_DEBUG_FW_CORE_CHUNK_SZ ||\n\t\t\t!IS_ALIGNED(iocmd->bufsz, sizeof(u16)) ||\n\t\t\t!IS_ALIGNED(iocmd->offset, sizeof(u32))) {\n\t\tbfa_trc(bfad, BFA_DEBUG_FW_CORE_CHUNK_SZ);\n\t\tiocmd->status = BFA_STATUS_EINVAL;\n\t\tgoto out;\n\t}\n\n\tiocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_debug_s);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\toffset = iocmd->offset;\n\tiocmd->status = bfa_ioc_debug_fwcore(&bfad->bfa.ioc, iocmd_bufptr,\n\t\t\t\t&offset, &iocmd->bufsz);\n\tiocmd->offset = offset;\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_debug_ctl(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tunsigned long\tflags;\n\n\tif (v_cmd == IOCMD_DEBUG_FW_STATE_CLR) {\n\t\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\t\tbfad->bfa.ioc.dbg_fwsave_once = BFA_TRUE;\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t} else if (v_cmd == IOCMD_DEBUG_PORTLOG_CLR)\n\t\tbfad->plog_buf.head = bfad->plog_buf.tail = 0;\n\telse if (v_cmd == IOCMD_DEBUG_START_DTRC)\n\t\tbfa_trc_init(bfad->trcmod);\n\telse if (v_cmd == IOCMD_DEBUG_STOP_DTRC)\n\t\tbfa_trc_stop(bfad->trcmod);\n\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_porglog_ctl(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_portlogctl_s *iocmd = (struct bfa_bsg_portlogctl_s *)cmd;\n\n\tif (iocmd->ctl == BFA_TRUE)\n\t\tbfad->plog_buf.plog_enabled = 1;\n\telse\n\t\tbfad->plog_buf.plog_enabled = 0;\n\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcpim_cfg_profile(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\n{\n\tstruct bfa_bsg_fcpim_profile_s *iocmd =\n\t\t\t\t(struct bfa_bsg_fcpim_profile_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif (v_cmd == IOCMD_FCPIM_PROFILE_ON)\n\t\tiocmd->status = bfa_fcpim_profile_on(&bfad->bfa, ktime_get_real_seconds());\n\telse if (v_cmd == IOCMD_FCPIM_PROFILE_OFF)\n\t\tiocmd->status = bfa_fcpim_profile_off(&bfad->bfa);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_itnim_get_ioprofile(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_itnim_ioprofile_s *iocmd =\n\t\t\t\t(struct bfa_bsg_itnim_ioprofile_s *)cmd;\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_fcs_itnim_s *itnim;\n\tunsigned long   flags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\n\t\t\t\tiocmd->vf_id, iocmd->lpwwn);\n\tif (!fcs_port)\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_LWWN;\n\telse {\n\t\titnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\n\t\tif (itnim == NULL)\n\t\t\tiocmd->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\telse\n\t\t\tiocmd->status = bfa_itnim_get_ioprofile(\n\t\t\t\t\t\tbfa_fcs_itnim_get_halitn(itnim),\n\t\t\t\t\t\t&iocmd->ioprofile);\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcport_get_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fcport_stats_s *iocmd =\n\t\t\t\t(struct bfa_bsg_fcport_stats_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\tstruct bfa_cb_pending_q_s cb_qe;\n\n\tinit_completion(&fcomp.comp);\n\tbfa_pending_q_init(&cb_qe, (bfa_cb_cbfn_t)bfad_hcb_comp,\n\t\t\t   &fcomp, &iocmd->stats);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcport_get_stats(&bfad->bfa, &cb_qe);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t\tgoto out;\n\t}\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcport_reset_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\tstruct bfa_cb_pending_q_s cb_qe;\n\n\tinit_completion(&fcomp.comp);\n\tbfa_pending_q_init(&cb_qe, (bfa_cb_cbfn_t)bfad_hcb_comp, &fcomp, NULL);\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcport_clear_stats(&bfad->bfa, &cb_qe);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t\tgoto out;\n\t}\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_boot_cfg(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_boot_s *iocmd = (struct bfa_bsg_boot_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_flash_update_part(BFA_FLASH(&bfad->bfa),\n\t\t\tBFA_FLASH_PART_BOOT, bfad->bfa.ioc.port_id,\n\t\t\t&iocmd->cfg, sizeof(struct bfa_boot_cfg_s), 0,\n\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_boot_query(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_boot_s *iocmd = (struct bfa_bsg_boot_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_flash_read_part(BFA_FLASH(&bfad->bfa),\n\t\t\tBFA_FLASH_PART_BOOT, bfad->bfa.ioc.port_id,\n\t\t\t&iocmd->cfg, sizeof(struct bfa_boot_cfg_s), 0,\n\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_preboot_query(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_preboot_s *iocmd = (struct bfa_bsg_preboot_s *)cmd;\n\tstruct bfi_iocfc_cfgrsp_s *cfgrsp = bfad->bfa.iocfc.cfgrsp;\n\tstruct bfa_boot_pbc_s *pbcfg = &iocmd->cfg;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tpbcfg->enable = cfgrsp->pbc_cfg.boot_enabled;\n\tpbcfg->nbluns = cfgrsp->pbc_cfg.nbluns;\n\tpbcfg->speed = cfgrsp->pbc_cfg.port_speed;\n\tmemcpy(pbcfg->pblun, cfgrsp->pbc_cfg.blun, sizeof(pbcfg->pblun));\n\tiocmd->status = BFA_STATUS_OK;\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ethboot_cfg(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_ethboot_s *iocmd = (struct bfa_bsg_ethboot_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_flash_update_part(BFA_FLASH(&bfad->bfa),\n\t\t\t\tBFA_FLASH_PART_PXECFG,\n\t\t\t\tbfad->bfa.ioc.port_id, &iocmd->cfg,\n\t\t\t\tsizeof(struct bfa_ethboot_cfg_s), 0,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_ethboot_query(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_ethboot_s *iocmd = (struct bfa_bsg_ethboot_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_flash_read_part(BFA_FLASH(&bfad->bfa),\n\t\t\t\tBFA_FLASH_PART_PXECFG,\n\t\t\t\tbfad->bfa.ioc.port_id, &iocmd->cfg,\n\t\t\t\tsizeof(struct bfa_ethboot_cfg_s), 0,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK)\n\t\tgoto out;\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_cfg_trunk(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\n\tstruct bfa_fcport_trunk_s *trunk = &fcport->trunk;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\n\tif (bfa_fcport_is_dport(&bfad->bfa)) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\treturn BFA_STATUS_DPORT_ERR;\n\t}\n\n\tif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) ||\n\t\t(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\n\t\tiocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\n\telse {\n\t\tif (v_cmd == IOCMD_TRUNK_ENABLE) {\n\t\t\ttrunk->attr.state = BFA_TRUNK_OFFLINE;\n\t\t\tbfa_fcport_disable(&bfad->bfa);\n\t\t\tfcport->cfg.trunked = BFA_TRUE;\n\t\t} else if (v_cmd == IOCMD_TRUNK_DISABLE) {\n\t\t\ttrunk->attr.state = BFA_TRUNK_DISABLED;\n\t\t\tbfa_fcport_disable(&bfad->bfa);\n\t\t\tfcport->cfg.trunked = BFA_FALSE;\n\t\t}\n\n\t\tif (!bfa_fcport_is_disabled(&bfad->bfa))\n\t\t\tbfa_fcport_enable(&bfad->bfa);\n\n\t\tiocmd->status = BFA_STATUS_OK;\n\t}\n\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_trunk_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_trunk_attr_s *iocmd = (struct bfa_bsg_trunk_attr_s *)cmd;\n\tstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\n\tstruct bfa_fcport_trunk_s *trunk = &fcport->trunk;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) ||\n\t\t(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\n\t\tiocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\n\telse {\n\t\tmemcpy((void *)&iocmd->attr, (void *)&trunk->attr,\n\t\t\tsizeof(struct bfa_trunk_attr_s));\n\t\tiocmd->attr.port_id = bfa_lps_get_base_pid(&bfad->bfa);\n\t\tiocmd->status = BFA_STATUS_OK;\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_qos(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif (bfa_ioc_get_type(&bfad->bfa.ioc) == BFA_IOC_TYPE_FC) {\n\t\tif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\n\t\t(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\n\t\t\tiocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\n\t\telse {\n\t\t\tif (v_cmd == IOCMD_QOS_ENABLE)\n\t\t\t\tfcport->cfg.qos_enabled = BFA_TRUE;\n\t\t\telse if (v_cmd == IOCMD_QOS_DISABLE) {\n\t\t\t\tfcport->cfg.qos_enabled = BFA_FALSE;\n\t\t\t\tfcport->cfg.qos_bw.high = BFA_QOS_BW_HIGH;\n\t\t\t\tfcport->cfg.qos_bw.med = BFA_QOS_BW_MED;\n\t\t\t\tfcport->cfg.qos_bw.low = BFA_QOS_BW_LOW;\n\t\t\t}\n\t\t}\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_qos_get_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_qos_attr_s *iocmd = (struct bfa_bsg_qos_attr_s *)cmd;\n\tstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\n\t\t(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\n\t\tiocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\n\telse {\n\t\tiocmd->attr.state = fcport->qos_attr.state;\n\t\tiocmd->attr.total_bb_cr =\n\t\t\tbe32_to_cpu(fcport->qos_attr.total_bb_cr);\n\t\tiocmd->attr.qos_bw.high = fcport->cfg.qos_bw.high;\n\t\tiocmd->attr.qos_bw.med = fcport->cfg.qos_bw.med;\n\t\tiocmd->attr.qos_bw.low = fcport->cfg.qos_bw.low;\n\t\tiocmd->attr.qos_bw_op = fcport->qos_attr.qos_bw_op;\n\t\tiocmd->status = BFA_STATUS_OK;\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_qos_get_vc_attr(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_qos_vc_attr_s *iocmd =\n\t\t\t\t(struct bfa_bsg_qos_vc_attr_s *)cmd;\n\tstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\n\tstruct bfa_qos_vc_attr_s *bfa_vc_attr = &fcport->qos_vc_attr;\n\tunsigned long\tflags;\n\tu32\ti = 0;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->attr.total_vc_count = be16_to_cpu(bfa_vc_attr->total_vc_count);\n\tiocmd->attr.shared_credit  = be16_to_cpu(bfa_vc_attr->shared_credit);\n\tiocmd->attr.elp_opmode_flags  =\n\t\t\t\tbe32_to_cpu(bfa_vc_attr->elp_opmode_flags);\n\n\t \n\twhile (i < iocmd->attr.total_vc_count) {\n\t\tiocmd->attr.vc_info[i].vc_credit =\n\t\t\t\tbfa_vc_attr->vc_info[i].vc_credit;\n\t\tiocmd->attr.vc_info[i].borrow_credit =\n\t\t\t\tbfa_vc_attr->vc_info[i].borrow_credit;\n\t\tiocmd->attr.vc_info[i].priority =\n\t\t\t\tbfa_vc_attr->vc_info[i].priority;\n\t\ti++;\n\t}\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\tiocmd->status = BFA_STATUS_OK;\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_qos_get_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fcport_stats_s *iocmd =\n\t\t\t\t(struct bfa_bsg_fcport_stats_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\tstruct bfa_cb_pending_q_s cb_qe;\n\tstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\n\n\tinit_completion(&fcomp.comp);\n\tbfa_pending_q_init(&cb_qe, (bfa_cb_cbfn_t)bfad_hcb_comp,\n\t\t\t   &fcomp, &iocmd->stats);\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tWARN_ON(!bfa_ioc_get_fcmode(&bfad->bfa.ioc));\n\tif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\n\t\t(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\n\t\tiocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\n\telse\n\t\tiocmd->status = bfa_fcport_get_stats(&bfad->bfa, &cb_qe);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t\tgoto out;\n\t}\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_qos_reset_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long\tflags;\n\tstruct bfa_cb_pending_q_s cb_qe;\n\tstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\n\n\tinit_completion(&fcomp.comp);\n\tbfa_pending_q_init(&cb_qe, (bfa_cb_cbfn_t)bfad_hcb_comp,\n\t\t\t   &fcomp, NULL);\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tWARN_ON(!bfa_ioc_get_fcmode(&bfad->bfa.ioc));\n\tif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\n\t\t(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\n\t\tiocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\n\telse\n\t\tiocmd->status = bfa_fcport_clear_stats(&bfad->bfa, &cb_qe);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status != BFA_STATUS_OK) {\n\t\tbfa_trc(bfad, iocmd->status);\n\t\tgoto out;\n\t}\n\twait_for_completion(&fcomp.comp);\n\tiocmd->status = fcomp.status;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_vf_get_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_vf_stats_s *iocmd =\n\t\t\t(struct bfa_bsg_vf_stats_s *)cmd;\n\tstruct bfa_fcs_fabric_s\t*fcs_vf;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_vf = bfa_fcs_vf_lookup(&bfad->bfa_fcs, iocmd->vf_id);\n\tif (fcs_vf == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_VFID;\n\t\tgoto out;\n\t}\n\tmemcpy((void *)&iocmd->stats, (void *)&fcs_vf->stats,\n\t\tsizeof(struct bfa_vf_stats_s));\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_vf_clr_stats(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_vf_reset_stats_s *iocmd =\n\t\t\t(struct bfa_bsg_vf_reset_stats_s *)cmd;\n\tstruct bfa_fcs_fabric_s\t*fcs_vf;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_vf = bfa_fcs_vf_lookup(&bfad->bfa_fcs, iocmd->vf_id);\n\tif (fcs_vf == NULL) {\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tiocmd->status = BFA_STATUS_UNKNOWN_VFID;\n\t\tgoto out;\n\t}\n\tmemset((void *)&fcs_vf->stats, 0, sizeof(struct bfa_vf_stats_s));\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tiocmd->status = BFA_STATUS_OK;\nout:\n\treturn 0;\n}\n\n \nstatic void bfad_reset_sdev_bflags(struct bfad_im_port_s *im_port,\n\t\t\t\t   int lunmask_cfg)\n{\n\tconst blist_flags_t scan_flags = BLIST_NOREPORTLUN | BLIST_SPARSELUN;\n\tstruct bfad_itnim_s *itnim;\n\tstruct scsi_device *sdev;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(im_port->shost->host_lock, flags);\n\tlist_for_each_entry(itnim, &im_port->itnim_mapped_list, list_entry) {\n\t\tsdev = __scsi_device_lookup(im_port->shost, itnim->channel,\n\t\t\t\t\t    itnim->scsi_tgt_id, 0);\n\t\tif (sdev) {\n\t\t\tif (lunmask_cfg == BFA_TRUE)\n\t\t\t\tsdev->sdev_bflags |= scan_flags;\n\t\t\telse\n\t\t\t\tsdev->sdev_bflags &= ~scan_flags;\n\t\t}\n\t}\n\tspin_unlock_irqrestore(im_port->shost->host_lock, flags);\n}\n\n \nstatic void\nbfad_iocmd_lunmask_reset_lunscan_mode(struct bfad_s *bfad, int lunmask_cfg)\n{\n\tstruct bfad_im_port_s *pport_im = bfad->pport.im_port;\n\tstruct bfad_vport_s *vport = NULL;\n\n\t \n\tbfad_reset_sdev_bflags(pport_im, lunmask_cfg);\n\n\t \n\tlist_for_each_entry(vport, &bfad->vport_list, list_entry)\n\t\tbfad_reset_sdev_bflags(vport->drv_port.im_port, lunmask_cfg);\n}\n\nstatic int\nbfad_iocmd_lunmask(struct bfad_s *bfad, void *pcmd, unsigned int v_cmd)\n{\n\tstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)pcmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif (v_cmd == IOCMD_FCPIM_LUNMASK_ENABLE) {\n\t\tiocmd->status = bfa_fcpim_lunmask_update(&bfad->bfa, BFA_TRUE);\n\t\t \n\t\tif (iocmd->status == BFA_STATUS_OK)\n\t\t\tbfad_iocmd_lunmask_reset_lunscan_mode(bfad, BFA_TRUE);\n\t} else if (v_cmd == IOCMD_FCPIM_LUNMASK_DISABLE) {\n\t\tiocmd->status = bfa_fcpim_lunmask_update(&bfad->bfa, BFA_FALSE);\n\t\t \n\t\tif (iocmd->status == BFA_STATUS_OK)\n\t\t\tbfad_iocmd_lunmask_reset_lunscan_mode(bfad, BFA_FALSE);\n\t} else if (v_cmd == IOCMD_FCPIM_LUNMASK_CLEAR)\n\t\tiocmd->status = bfa_fcpim_lunmask_clear(&bfad->bfa);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcpim_lunmask_query(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fcpim_lunmask_query_s *iocmd =\n\t\t\t(struct bfa_bsg_fcpim_lunmask_query_s *)cmd;\n\tstruct bfa_lunmask_cfg_s *lun_mask = &iocmd->lun_mask;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcpim_lunmask_query(&bfad->bfa, lun_mask);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcpim_cfg_lunmask(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\n{\n\tstruct bfa_bsg_fcpim_lunmask_s *iocmd =\n\t\t\t\t(struct bfa_bsg_fcpim_lunmask_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tif (v_cmd == IOCMD_FCPIM_LUNMASK_ADD)\n\t\tiocmd->status = bfa_fcpim_lunmask_add(&bfad->bfa, iocmd->vf_id,\n\t\t\t\t\t&iocmd->pwwn, iocmd->rpwwn, iocmd->lun);\n\telse if (v_cmd == IOCMD_FCPIM_LUNMASK_DELETE)\n\t\tiocmd->status = bfa_fcpim_lunmask_delete(&bfad->bfa,\n\t\t\t\t\tiocmd->vf_id, &iocmd->pwwn,\n\t\t\t\t\tiocmd->rpwwn, iocmd->lun);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcpim_throttle_query(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fcpim_throttle_s *iocmd =\n\t\t\t(struct bfa_bsg_fcpim_throttle_s *)cmd;\n\tunsigned long   flags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcpim_throttle_get(&bfad->bfa,\n\t\t\t\t(void *)&iocmd->throttle);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fcpim_throttle_set(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fcpim_throttle_s *iocmd =\n\t\t\t(struct bfa_bsg_fcpim_throttle_s *)cmd;\n\tunsigned long\tflags;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fcpim_throttle_set(&bfad->bfa,\n\t\t\t\tiocmd->throttle.cfg_value);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_tfru_read(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_tfru_s *iocmd =\n\t\t\t(struct bfa_bsg_tfru_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags = 0;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_tfru_read(BFA_FRU(&bfad->bfa),\n\t\t\t\t&iocmd->data, iocmd->len, iocmd->offset,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status == BFA_STATUS_OK) {\n\t\twait_for_completion(&fcomp.comp);\n\t\tiocmd->status = fcomp.status;\n\t}\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_tfru_write(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_tfru_s *iocmd =\n\t\t\t(struct bfa_bsg_tfru_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags = 0;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_tfru_write(BFA_FRU(&bfad->bfa),\n\t\t\t\t&iocmd->data, iocmd->len, iocmd->offset,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status == BFA_STATUS_OK) {\n\t\twait_for_completion(&fcomp.comp);\n\t\tiocmd->status = fcomp.status;\n\t}\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fruvpd_read(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fruvpd_s *iocmd =\n\t\t\t(struct bfa_bsg_fruvpd_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags = 0;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fruvpd_read(BFA_FRU(&bfad->bfa),\n\t\t\t\t&iocmd->data, iocmd->len, iocmd->offset,\n\t\t\t\tbfad_hcb_comp, &fcomp);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status == BFA_STATUS_OK) {\n\t\twait_for_completion(&fcomp.comp);\n\t\tiocmd->status = fcomp.status;\n\t}\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fruvpd_update(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fruvpd_s *iocmd =\n\t\t\t(struct bfa_bsg_fruvpd_s *)cmd;\n\tstruct bfad_hal_comp fcomp;\n\tunsigned long flags = 0;\n\n\tinit_completion(&fcomp.comp);\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fruvpd_update(BFA_FRU(&bfad->bfa),\n\t\t\t\t&iocmd->data, iocmd->len, iocmd->offset,\n\t\t\t\tbfad_hcb_comp, &fcomp, iocmd->trfr_cmpl);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\tif (iocmd->status == BFA_STATUS_OK) {\n\t\twait_for_completion(&fcomp.comp);\n\t\tiocmd->status = fcomp.status;\n\t}\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_fruvpd_get_max_size(struct bfad_s *bfad, void *cmd)\n{\n\tstruct bfa_bsg_fruvpd_max_size_s *iocmd =\n\t\t\t(struct bfa_bsg_fruvpd_max_size_s *)cmd;\n\tunsigned long flags = 0;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tiocmd->status = bfa_fruvpd_get_max_size(BFA_FRU(&bfad->bfa),\n\t\t\t\t\t\t&iocmd->max_size);\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn 0;\n}\n\nstatic int\nbfad_iocmd_handler(struct bfad_s *bfad, unsigned int cmd, void *iocmd,\n\t\tunsigned int payload_len)\n{\n\tint rc = -EINVAL;\n\n\tswitch (cmd) {\n\tcase IOCMD_IOC_ENABLE:\n\t\trc = bfad_iocmd_ioc_enable(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_IOC_DISABLE:\n\t\trc = bfad_iocmd_ioc_disable(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_IOC_GET_INFO:\n\t\trc = bfad_iocmd_ioc_get_info(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_IOC_GET_ATTR:\n\t\trc = bfad_iocmd_ioc_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_IOC_GET_STATS:\n\t\trc = bfad_iocmd_ioc_get_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_IOC_GET_FWSTATS:\n\t\trc = bfad_iocmd_ioc_get_fwstats(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_IOC_RESET_STATS:\n\tcase IOCMD_IOC_RESET_FWSTATS:\n\t\trc = bfad_iocmd_ioc_reset_stats(bfad, iocmd, cmd);\n\t\tbreak;\n\tcase IOCMD_IOC_SET_ADAPTER_NAME:\n\tcase IOCMD_IOC_SET_PORT_NAME:\n\t\trc = bfad_iocmd_ioc_set_name(bfad, iocmd, cmd);\n\t\tbreak;\n\tcase IOCMD_IOCFC_GET_ATTR:\n\t\trc = bfad_iocmd_iocfc_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_IOCFC_SET_INTR:\n\t\trc = bfad_iocmd_iocfc_set_intr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PORT_ENABLE:\n\t\trc = bfad_iocmd_port_enable(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PORT_DISABLE:\n\t\trc = bfad_iocmd_port_disable(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PORT_GET_ATTR:\n\t\trc = bfad_iocmd_port_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PORT_GET_STATS:\n\t\trc = bfad_iocmd_port_get_stats(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_PORT_RESET_STATS:\n\t\trc = bfad_iocmd_port_reset_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PORT_CFG_TOPO:\n\tcase IOCMD_PORT_CFG_SPEED:\n\tcase IOCMD_PORT_CFG_ALPA:\n\tcase IOCMD_PORT_CLR_ALPA:\n\t\trc = bfad_iocmd_set_port_cfg(bfad, iocmd, cmd);\n\t\tbreak;\n\tcase IOCMD_PORT_CFG_MAXFRSZ:\n\t\trc = bfad_iocmd_port_cfg_maxfrsize(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PORT_BBCR_ENABLE:\n\tcase IOCMD_PORT_BBCR_DISABLE:\n\t\trc = bfad_iocmd_port_cfg_bbcr(bfad, cmd, iocmd);\n\t\tbreak;\n\tcase IOCMD_PORT_BBCR_GET_ATTR:\n\t\trc = bfad_iocmd_port_get_bbcr_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_LPORT_GET_ATTR:\n\t\trc = bfad_iocmd_lport_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_LPORT_GET_STATS:\n\t\trc = bfad_iocmd_lport_get_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_LPORT_RESET_STATS:\n\t\trc = bfad_iocmd_lport_reset_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_LPORT_GET_IOSTATS:\n\t\trc = bfad_iocmd_lport_get_iostats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_LPORT_GET_RPORTS:\n\t\trc = bfad_iocmd_lport_get_rports(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_RPORT_GET_ATTR:\n\t\trc = bfad_iocmd_rport_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_RPORT_GET_ADDR:\n\t\trc = bfad_iocmd_rport_get_addr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_RPORT_GET_STATS:\n\t\trc = bfad_iocmd_rport_get_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_RPORT_RESET_STATS:\n\t\trc = bfad_iocmd_rport_clr_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_RPORT_SET_SPEED:\n\t\trc = bfad_iocmd_rport_set_speed(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_VPORT_GET_ATTR:\n\t\trc = bfad_iocmd_vport_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_VPORT_GET_STATS:\n\t\trc = bfad_iocmd_vport_get_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_VPORT_RESET_STATS:\n\t\trc = bfad_iocmd_vport_clr_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FABRIC_GET_LPORTS:\n\t\trc = bfad_iocmd_fabric_get_lports(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_RATELIM_ENABLE:\n\tcase IOCMD_RATELIM_DISABLE:\n\t\trc = bfad_iocmd_ratelim(bfad, cmd, iocmd);\n\t\tbreak;\n\tcase IOCMD_RATELIM_DEF_SPEED:\n\t\trc = bfad_iocmd_ratelim_speed(bfad, cmd, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_FAILOVER:\n\t\trc = bfad_iocmd_cfg_fcpim(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_MODSTATS:\n\t\trc = bfad_iocmd_fcpim_get_modstats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_MODSTATSCLR:\n\t\trc = bfad_iocmd_fcpim_clr_modstats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_DEL_ITN_STATS:\n\t\trc = bfad_iocmd_fcpim_get_del_itn_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_ITNIM_GET_ATTR:\n\t\trc = bfad_iocmd_itnim_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_ITNIM_GET_IOSTATS:\n\t\trc = bfad_iocmd_itnim_get_iostats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_ITNIM_RESET_STATS:\n\t\trc = bfad_iocmd_itnim_reset_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_ITNIM_GET_ITNSTATS:\n\t\trc = bfad_iocmd_itnim_get_itnstats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPORT_ENABLE:\n\t\trc = bfad_iocmd_fcport_enable(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPORT_DISABLE:\n\t\trc = bfad_iocmd_fcport_disable(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_IOC_PCIFN_CFG:\n\t\trc = bfad_iocmd_ioc_get_pcifn_cfg(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_IOC_FW_SIG_INV:\n\t\trc = bfad_iocmd_ioc_fw_sig_inv(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PCIFN_CREATE:\n\t\trc = bfad_iocmd_pcifn_create(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PCIFN_DELETE:\n\t\trc = bfad_iocmd_pcifn_delete(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PCIFN_BW:\n\t\trc = bfad_iocmd_pcifn_bw(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_ADAPTER_CFG_MODE:\n\t\trc = bfad_iocmd_adapter_cfg_mode(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PORT_CFG_MODE:\n\t\trc = bfad_iocmd_port_cfg_mode(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FLASH_ENABLE_OPTROM:\n\tcase IOCMD_FLASH_DISABLE_OPTROM:\n\t\trc = bfad_iocmd_ablk_optrom(bfad, cmd, iocmd);\n\t\tbreak;\n\tcase IOCMD_FAA_QUERY:\n\t\trc = bfad_iocmd_faa_query(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_CEE_GET_ATTR:\n\t\trc = bfad_iocmd_cee_attr(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_CEE_GET_STATS:\n\t\trc = bfad_iocmd_cee_get_stats(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_CEE_RESET_STATS:\n\t\trc = bfad_iocmd_cee_reset_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_SFP_MEDIA:\n\t\trc = bfad_iocmd_sfp_media(bfad, iocmd);\n\t\t break;\n\tcase IOCMD_SFP_SPEED:\n\t\trc = bfad_iocmd_sfp_speed(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FLASH_GET_ATTR:\n\t\trc = bfad_iocmd_flash_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FLASH_ERASE_PART:\n\t\trc = bfad_iocmd_flash_erase_part(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FLASH_UPDATE_PART:\n\t\trc = bfad_iocmd_flash_update_part(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_FLASH_READ_PART:\n\t\trc = bfad_iocmd_flash_read_part(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_DIAG_TEMP:\n\t\trc = bfad_iocmd_diag_temp(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_MEMTEST:\n\t\trc = bfad_iocmd_diag_memtest(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_LOOPBACK:\n\t\trc = bfad_iocmd_diag_loopback(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_FWPING:\n\t\trc = bfad_iocmd_diag_fwping(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_QUEUETEST:\n\t\trc = bfad_iocmd_diag_queuetest(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_SFP:\n\t\trc = bfad_iocmd_diag_sfp(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_LED:\n\t\trc = bfad_iocmd_diag_led(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_BEACON_LPORT:\n\t\trc = bfad_iocmd_diag_beacon_lport(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_LB_STAT:\n\t\trc = bfad_iocmd_diag_lb_stat(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_DPORT_ENABLE:\n\t\trc = bfad_iocmd_diag_dport_enable(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_DPORT_DISABLE:\n\t\trc = bfad_iocmd_diag_dport_disable(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_DPORT_SHOW:\n\t\trc = bfad_iocmd_diag_dport_show(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DIAG_DPORT_START:\n\t\trc = bfad_iocmd_diag_dport_start(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PHY_GET_ATTR:\n\t\trc = bfad_iocmd_phy_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PHY_GET_STATS:\n\t\trc = bfad_iocmd_phy_get_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PHY_UPDATE_FW:\n\t\trc = bfad_iocmd_phy_update(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_PHY_READ_FW:\n\t\trc = bfad_iocmd_phy_read(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_VHBA_QUERY:\n\t\trc = bfad_iocmd_vhba_query(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DEBUG_PORTLOG:\n\t\trc = bfad_iocmd_porglog_get(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_DEBUG_FW_CORE:\n\t\trc = bfad_iocmd_debug_fw_core(bfad, iocmd, payload_len);\n\t\tbreak;\n\tcase IOCMD_DEBUG_FW_STATE_CLR:\n\tcase IOCMD_DEBUG_PORTLOG_CLR:\n\tcase IOCMD_DEBUG_START_DTRC:\n\tcase IOCMD_DEBUG_STOP_DTRC:\n\t\trc = bfad_iocmd_debug_ctl(bfad, iocmd, cmd);\n\t\tbreak;\n\tcase IOCMD_DEBUG_PORTLOG_CTL:\n\t\trc = bfad_iocmd_porglog_ctl(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_PROFILE_ON:\n\tcase IOCMD_FCPIM_PROFILE_OFF:\n\t\trc = bfad_iocmd_fcpim_cfg_profile(bfad, iocmd, cmd);\n\t\tbreak;\n\tcase IOCMD_ITNIM_GET_IOPROFILE:\n\t\trc = bfad_iocmd_itnim_get_ioprofile(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPORT_GET_STATS:\n\t\trc = bfad_iocmd_fcport_get_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPORT_RESET_STATS:\n\t\trc = bfad_iocmd_fcport_reset_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_BOOT_CFG:\n\t\trc = bfad_iocmd_boot_cfg(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_BOOT_QUERY:\n\t\trc = bfad_iocmd_boot_query(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_PREBOOT_QUERY:\n\t\trc = bfad_iocmd_preboot_query(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_ETHBOOT_CFG:\n\t\trc = bfad_iocmd_ethboot_cfg(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_ETHBOOT_QUERY:\n\t\trc = bfad_iocmd_ethboot_query(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_TRUNK_ENABLE:\n\tcase IOCMD_TRUNK_DISABLE:\n\t\trc = bfad_iocmd_cfg_trunk(bfad, iocmd, cmd);\n\t\tbreak;\n\tcase IOCMD_TRUNK_GET_ATTR:\n\t\trc = bfad_iocmd_trunk_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_QOS_ENABLE:\n\tcase IOCMD_QOS_DISABLE:\n\t\trc = bfad_iocmd_qos(bfad, iocmd, cmd);\n\t\tbreak;\n\tcase IOCMD_QOS_GET_ATTR:\n\t\trc = bfad_iocmd_qos_get_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_QOS_GET_VC_ATTR:\n\t\trc = bfad_iocmd_qos_get_vc_attr(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_QOS_GET_STATS:\n\t\trc = bfad_iocmd_qos_get_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_QOS_RESET_STATS:\n\t\trc = bfad_iocmd_qos_reset_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_QOS_SET_BW:\n\t\trc = bfad_iocmd_qos_set_bw(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_VF_GET_STATS:\n\t\trc = bfad_iocmd_vf_get_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_VF_RESET_STATS:\n\t\trc = bfad_iocmd_vf_clr_stats(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_LUNMASK_ENABLE:\n\tcase IOCMD_FCPIM_LUNMASK_DISABLE:\n\tcase IOCMD_FCPIM_LUNMASK_CLEAR:\n\t\trc = bfad_iocmd_lunmask(bfad, iocmd, cmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_LUNMASK_QUERY:\n\t\trc = bfad_iocmd_fcpim_lunmask_query(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_LUNMASK_ADD:\n\tcase IOCMD_FCPIM_LUNMASK_DELETE:\n\t\trc = bfad_iocmd_fcpim_cfg_lunmask(bfad, iocmd, cmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_THROTTLE_QUERY:\n\t\trc = bfad_iocmd_fcpim_throttle_query(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FCPIM_THROTTLE_SET:\n\t\trc = bfad_iocmd_fcpim_throttle_set(bfad, iocmd);\n\t\tbreak;\n\t \n\tcase IOCMD_TFRU_READ:\n\t\trc = bfad_iocmd_tfru_read(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_TFRU_WRITE:\n\t\trc = bfad_iocmd_tfru_write(bfad, iocmd);\n\t\tbreak;\n\t \n\tcase IOCMD_FRUVPD_READ:\n\t\trc = bfad_iocmd_fruvpd_read(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FRUVPD_UPDATE:\n\t\trc = bfad_iocmd_fruvpd_update(bfad, iocmd);\n\t\tbreak;\n\tcase IOCMD_FRUVPD_GET_MAX_SIZE:\n\t\trc = bfad_iocmd_fruvpd_get_max_size(bfad, iocmd);\n\t\tbreak;\n\tdefault:\n\t\trc = -EINVAL;\n\t\tbreak;\n\t}\n\treturn rc;\n}\n\nstatic int\nbfad_im_bsg_vendor_request(struct bsg_job *job)\n{\n\tstruct fc_bsg_request *bsg_request = job->request;\n\tstruct fc_bsg_reply *bsg_reply = job->reply;\n\tuint32_t vendor_cmd = bsg_request->rqst_data.h_vendor.vendor_cmd[0];\n\tstruct Scsi_Host *shost = fc_bsg_to_shost(job);\n\tstruct bfad_im_port_s *im_port = bfad_get_im_port(shost);\n\tstruct bfad_s *bfad = im_port->bfad;\n\tvoid *payload_kbuf;\n\tint rc = -EINVAL;\n\n\t \n\tpayload_kbuf = kzalloc(job->request_payload.payload_len, GFP_KERNEL);\n\tif (!payload_kbuf) {\n\t\trc = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\t \n\tsg_copy_to_buffer(job->request_payload.sg_list,\n\t\t\t  job->request_payload.sg_cnt, payload_kbuf,\n\t\t\t  job->request_payload.payload_len);\n\n\t \n\trc = bfad_iocmd_handler(bfad, vendor_cmd, payload_kbuf,\n\t\t\t\tjob->request_payload.payload_len);\n\tif (rc != BFA_STATUS_OK)\n\t\tgoto error;\n\n\t \n\tsg_copy_from_buffer(job->reply_payload.sg_list,\n\t\t\t    job->reply_payload.sg_cnt,\n\t\t\t    payload_kbuf,\n\t\t\t    job->reply_payload.payload_len);\n\n\t \n\tkfree(payload_kbuf);\n\n\t \n\tjob->reply_len = job->reply_payload.payload_len;\n\tbsg_reply->reply_payload_rcv_len = job->reply_payload.payload_len;\n\tbsg_reply->result = rc;\n\n\tbsg_job_done(job, bsg_reply->result,\n\t\t       bsg_reply->reply_payload_rcv_len);\n\treturn rc;\nerror:\n\t \n\tkfree(payload_kbuf);\nout:\n\tbsg_reply->result = rc;\n\tjob->reply_len = sizeof(uint32_t);\n\tbsg_reply->reply_payload_rcv_len = 0;\n\treturn rc;\n}\n\n \nstatic u64\nbfad_fcxp_get_req_sgaddr_cb(void *bfad_fcxp, int sgeid)\n{\n\tstruct bfad_fcxp\t*drv_fcxp = bfad_fcxp;\n\tstruct bfa_sge_s  *sge;\n\tu64\taddr;\n\n\tsge = drv_fcxp->req_sge + sgeid;\n\taddr = (u64)(size_t) sge->sg_addr;\n\treturn addr;\n}\n\nstatic u32\nbfad_fcxp_get_req_sglen_cb(void *bfad_fcxp, int sgeid)\n{\n\tstruct bfad_fcxp\t*drv_fcxp = bfad_fcxp;\n\tstruct bfa_sge_s\t*sge;\n\n\tsge = drv_fcxp->req_sge + sgeid;\n\treturn sge->sg_len;\n}\n\nstatic u64\nbfad_fcxp_get_rsp_sgaddr_cb(void *bfad_fcxp, int sgeid)\n{\n\tstruct bfad_fcxp\t*drv_fcxp = bfad_fcxp;\n\tstruct bfa_sge_s\t*sge;\n\tu64\taddr;\n\n\tsge = drv_fcxp->rsp_sge + sgeid;\n\taddr = (u64)(size_t) sge->sg_addr;\n\treturn addr;\n}\n\nstatic u32\nbfad_fcxp_get_rsp_sglen_cb(void *bfad_fcxp, int sgeid)\n{\n\tstruct bfad_fcxp\t*drv_fcxp = bfad_fcxp;\n\tstruct bfa_sge_s\t*sge;\n\n\tsge = drv_fcxp->rsp_sge + sgeid;\n\treturn sge->sg_len;\n}\n\nstatic void\nbfad_send_fcpt_cb(void *bfad_fcxp, struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\tbfa_status_t req_status, u32 rsp_len, u32 resid_len,\n\t\tstruct fchs_s *rsp_fchs)\n{\n\tstruct bfad_fcxp *drv_fcxp = bfad_fcxp;\n\n\tdrv_fcxp->req_status = req_status;\n\tdrv_fcxp->rsp_len = rsp_len;\n\n\t \n\tdrv_fcxp->bfa_fcxp = NULL;\n\tcomplete(&drv_fcxp->comp);\n}\n\nstatic struct bfad_buf_info *\nbfad_fcxp_map_sg(struct bfad_s *bfad, void *payload_kbuf,\n\t\t uint32_t payload_len, uint32_t *num_sgles)\n{\n\tstruct bfad_buf_info\t*buf_base, *buf_info;\n\tstruct bfa_sge_s\t*sg_table;\n\tint sge_num = 1;\n\n\tbuf_base = kcalloc(sizeof(struct bfad_buf_info) +\n\t\t\t\tsizeof(struct bfa_sge_s),\n\t\t\t   sge_num, GFP_KERNEL);\n\tif (!buf_base)\n\t\treturn NULL;\n\n\tsg_table = (struct bfa_sge_s *) (((uint8_t *)buf_base) +\n\t\t\t(sizeof(struct bfad_buf_info) * sge_num));\n\n\t \n\tbuf_info = buf_base;\n\tbuf_info->size = payload_len;\n\tbuf_info->virt = dma_alloc_coherent(&bfad->pcidev->dev,\n\t\t\t\t\t    buf_info->size, &buf_info->phys,\n\t\t\t\t\t    GFP_KERNEL);\n\tif (!buf_info->virt)\n\t\tgoto out_free_mem;\n\n\t \n\tmemcpy(buf_info->virt, payload_kbuf, buf_info->size);\n\n\t \n\tsg_table->sg_len = buf_info->size;\n\tsg_table->sg_addr = (void *)(size_t) buf_info->phys;\n\n\t*num_sgles = sge_num;\n\n\treturn buf_base;\n\nout_free_mem:\n\tkfree(buf_base);\n\treturn NULL;\n}\n\nstatic void\nbfad_fcxp_free_mem(struct bfad_s *bfad, struct bfad_buf_info *buf_base,\n\t\t   uint32_t num_sgles)\n{\n\tint i;\n\tstruct bfad_buf_info *buf_info = buf_base;\n\n\tif (buf_base) {\n\t\tfor (i = 0; i < num_sgles; buf_info++, i++) {\n\t\t\tif (buf_info->virt != NULL)\n\t\t\t\tdma_free_coherent(&bfad->pcidev->dev,\n\t\t\t\t\tbuf_info->size, buf_info->virt,\n\t\t\t\t\tbuf_info->phys);\n\t\t}\n\t\tkfree(buf_base);\n\t}\n}\n\nstatic int\nbfad_fcxp_bsg_send(struct bsg_job *job, struct bfad_fcxp *drv_fcxp,\n\t\t   bfa_bsg_fcpt_t *bsg_fcpt)\n{\n\tstruct bfa_fcxp_s *hal_fcxp;\n\tstruct bfad_s\t*bfad = drv_fcxp->port->bfad;\n\tunsigned long\tflags;\n\tuint8_t\tlp_tag;\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\n\t \n\thal_fcxp = bfa_fcxp_req_rsp_alloc(drv_fcxp, &bfad->bfa,\n\t\t\t\t  drv_fcxp->num_req_sgles,\n\t\t\t\t  drv_fcxp->num_rsp_sgles,\n\t\t\t\t  bfad_fcxp_get_req_sgaddr_cb,\n\t\t\t\t  bfad_fcxp_get_req_sglen_cb,\n\t\t\t\t  bfad_fcxp_get_rsp_sgaddr_cb,\n\t\t\t\t  bfad_fcxp_get_rsp_sglen_cb, BFA_TRUE);\n\tif (!hal_fcxp) {\n\t\tbfa_trc(bfad, 0);\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\treturn BFA_STATUS_ENOMEM;\n\t}\n\n\tdrv_fcxp->bfa_fcxp = hal_fcxp;\n\n\tlp_tag = bfa_lps_get_tag_from_pid(&bfad->bfa, bsg_fcpt->fchs.s_id);\n\n\tbfa_fcxp_send(hal_fcxp, drv_fcxp->bfa_rport, bsg_fcpt->vf_id, lp_tag,\n\t\t      bsg_fcpt->cts, bsg_fcpt->cos,\n\t\t      job->request_payload.payload_len,\n\t\t      &bsg_fcpt->fchs, bfad_send_fcpt_cb, bfad,\n\t\t      job->reply_payload.payload_len, bsg_fcpt->tsecs);\n\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\treturn BFA_STATUS_OK;\n}\n\nstatic int\nbfad_im_bsg_els_ct_request(struct bsg_job *job)\n{\n\tstruct bfa_bsg_data *bsg_data;\n\tstruct Scsi_Host *shost = fc_bsg_to_shost(job);\n\tstruct bfad_im_port_s *im_port = bfad_get_im_port(shost);\n\tstruct bfad_s *bfad = im_port->bfad;\n\tbfa_bsg_fcpt_t *bsg_fcpt;\n\tstruct bfad_fcxp    *drv_fcxp;\n\tstruct bfa_fcs_lport_s *fcs_port;\n\tstruct bfa_fcs_rport_s *fcs_rport;\n\tstruct fc_bsg_request *bsg_request = job->request;\n\tstruct fc_bsg_reply *bsg_reply = job->reply;\n\tuint32_t command_type = bsg_request->msgcode;\n\tunsigned long flags;\n\tstruct bfad_buf_info *rsp_buf_info;\n\tvoid *req_kbuf = NULL, *rsp_kbuf = NULL;\n\tint rc = -EINVAL;\n\n\tjob->reply_len  = sizeof(uint32_t);\t \n\tbsg_reply->reply_payload_rcv_len = 0;\n\n\t \n\tbsg_data = (struct bfa_bsg_data *) (((char *)bsg_request) +\n\t\t\t\t\t    sizeof(struct fc_bsg_request));\n\tif (bsg_data == NULL)\n\t\tgoto out;\n\n\t \n\tbsg_fcpt = kzalloc(bsg_data->payload_len, GFP_KERNEL);\n\tif (!bsg_fcpt) {\n\t\trc = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tif (copy_from_user((uint8_t *)bsg_fcpt,\n\t\t\t\t(void *)(unsigned long)bsg_data->payload,\n\t\t\t\tbsg_data->payload_len)) {\n\t\tkfree(bsg_fcpt);\n\t\trc = -EIO;\n\t\tgoto out;\n\t}\n\n\tdrv_fcxp = kzalloc(sizeof(struct bfad_fcxp), GFP_KERNEL);\n\tif (drv_fcxp == NULL) {\n\t\tkfree(bsg_fcpt);\n\t\trc = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tspin_lock_irqsave(&bfad->bfad_lock, flags);\n\tfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs, bsg_fcpt->vf_id,\n\t\t\t\t\tbsg_fcpt->lpwwn);\n\tif (fcs_port == NULL) {\n\t\tbsg_fcpt->status = BFA_STATUS_UNKNOWN_LWWN;\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tgoto out_free_mem;\n\t}\n\n\t \n\tif (!bfa_fcs_lport_is_online(fcs_port)) {\n\t\tbsg_fcpt->status = BFA_STATUS_PORT_OFFLINE;\n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tgoto out_free_mem;\n\t}\n\n\tdrv_fcxp->port = fcs_port->bfad_port;\n\n\tif (!drv_fcxp->port->bfad)\n\t\tdrv_fcxp->port->bfad = bfad;\n\n\t \n\tif (command_type == FC_BSG_HST_ELS_NOLOGIN ||\n\t    command_type == FC_BSG_HST_CT) {\n\t\t \n\t\tdrv_fcxp->bfa_rport = NULL;\n\n\t} else if (command_type == FC_BSG_RPT_ELS ||\n\t\t   command_type == FC_BSG_RPT_CT) {\n\t\t \n\t\tfcs_rport = bfa_fcs_lport_get_rport_by_pwwn(fcs_port,\n\t\t\t\t\t\t\t    bsg_fcpt->dpwwn);\n\t\tif (fcs_rport == NULL) {\n\t\t\tbsg_fcpt->status = BFA_STATUS_UNKNOWN_RWWN;\n\t\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\t\tgoto out_free_mem;\n\t\t}\n\n\t\tdrv_fcxp->bfa_rport = fcs_rport->bfa_rport;\n\n\t} else {  \n\t\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\t\tgoto out_free_mem;\n\t}\n\n\tspin_unlock_irqrestore(&bfad->bfad_lock, flags);\n\n\t \n\treq_kbuf = kzalloc(job->request_payload.payload_len, GFP_KERNEL);\n\tif (!req_kbuf) {\n\t\tprintk(KERN_INFO \"bfa %s: fcpt request buffer alloc failed\\n\",\n\t\t\t\tbfad->pci_name);\n\t\trc = -ENOMEM;\n\t\tgoto out_free_mem;\n\t}\n\n\trsp_kbuf = kzalloc(job->reply_payload.payload_len, GFP_KERNEL);\n\tif (!rsp_kbuf) {\n\t\tprintk(KERN_INFO \"bfa %s: fcpt response buffer alloc failed\\n\",\n\t\t\t\tbfad->pci_name);\n\t\trc = -ENOMEM;\n\t\tgoto out_free_mem;\n\t}\n\n\t \n\tsg_copy_to_buffer(job->request_payload.sg_list,\n\t\t\t  job->request_payload.sg_cnt, req_kbuf,\n\t\t\t  job->request_payload.payload_len);\n\n\tdrv_fcxp->reqbuf_info = bfad_fcxp_map_sg(bfad, req_kbuf,\n\t\t\t\t\tjob->request_payload.payload_len,\n\t\t\t\t\t&drv_fcxp->num_req_sgles);\n\tif (!drv_fcxp->reqbuf_info) {\n\t\tprintk(KERN_INFO \"bfa %s: fcpt request fcxp_map_sg failed\\n\",\n\t\t\t\tbfad->pci_name);\n\t\trc = -ENOMEM;\n\t\tgoto out_free_mem;\n\t}\n\n\tdrv_fcxp->req_sge = (struct bfa_sge_s *)\n\t\t\t    (((uint8_t *)drv_fcxp->reqbuf_info) +\n\t\t\t    (sizeof(struct bfad_buf_info) *\n\t\t\t\t\tdrv_fcxp->num_req_sgles));\n\n\t \n\tdrv_fcxp->rspbuf_info = bfad_fcxp_map_sg(bfad, rsp_kbuf,\n\t\t\t\t\tjob->reply_payload.payload_len,\n\t\t\t\t\t&drv_fcxp->num_rsp_sgles);\n\tif (!drv_fcxp->rspbuf_info) {\n\t\tprintk(KERN_INFO \"bfa %s: fcpt response fcxp_map_sg failed\\n\",\n\t\t\t\tbfad->pci_name);\n\t\trc = -ENOMEM;\n\t\tgoto out_free_mem;\n\t}\n\n\trsp_buf_info = (struct bfad_buf_info *)drv_fcxp->rspbuf_info;\n\tdrv_fcxp->rsp_sge = (struct bfa_sge_s  *)\n\t\t\t    (((uint8_t *)drv_fcxp->rspbuf_info) +\n\t\t\t    (sizeof(struct bfad_buf_info) *\n\t\t\t\t\tdrv_fcxp->num_rsp_sgles));\n\n\t \n\tinit_completion(&drv_fcxp->comp);\n\trc = bfad_fcxp_bsg_send(job, drv_fcxp, bsg_fcpt);\n\tif (rc == BFA_STATUS_OK) {\n\t\twait_for_completion(&drv_fcxp->comp);\n\t\tbsg_fcpt->status = drv_fcxp->req_status;\n\t} else {\n\t\tbsg_fcpt->status = rc;\n\t\tgoto out_free_mem;\n\t}\n\n\t \n\tif (drv_fcxp->req_status == BFA_STATUS_OK) {\n\t\tjob->reply_len = drv_fcxp->rsp_len;\n\t\tbsg_reply->reply_payload_rcv_len = drv_fcxp->rsp_len;\n\t\tbsg_reply->reply_data.ctels_reply.status = FC_CTELS_STATUS_OK;\n\t} else {\n\t\tbsg_reply->reply_payload_rcv_len =\n\t\t\t\t\tsizeof(struct fc_bsg_ctels_reply);\n\t\tjob->reply_len = sizeof(uint32_t);\n\t\tbsg_reply->reply_data.ctels_reply.status =\n\t\t\t\t\t\tFC_CTELS_STATUS_REJECT;\n\t}\n\n\t \n\tsg_copy_from_buffer(job->reply_payload.sg_list,\n\t\t\t    job->reply_payload.sg_cnt,\n\t\t\t    (uint8_t *)rsp_buf_info->virt,\n\t\t\t    job->reply_payload.payload_len);\n\nout_free_mem:\n\tbfad_fcxp_free_mem(bfad, drv_fcxp->rspbuf_info,\n\t\t\t   drv_fcxp->num_rsp_sgles);\n\tbfad_fcxp_free_mem(bfad, drv_fcxp->reqbuf_info,\n\t\t\t   drv_fcxp->num_req_sgles);\n\tkfree(req_kbuf);\n\tkfree(rsp_kbuf);\n\n\t \n\tif (copy_to_user((void *)(unsigned long)bsg_data->payload,\n\t\t\t(void *)bsg_fcpt, bsg_data->payload_len))\n\t\trc = -EIO;\n\n\tkfree(bsg_fcpt);\n\tkfree(drv_fcxp);\nout:\n\tbsg_reply->result = rc;\n\n\tif (rc == BFA_STATUS_OK)\n\t\tbsg_job_done(job, bsg_reply->result,\n\t\t\t       bsg_reply->reply_payload_rcv_len);\n\n\treturn rc;\n}\n\nint\nbfad_im_bsg_request(struct bsg_job *job)\n{\n\tstruct fc_bsg_request *bsg_request = job->request;\n\tstruct fc_bsg_reply *bsg_reply = job->reply;\n\tuint32_t rc = BFA_STATUS_OK;\n\n\tswitch (bsg_request->msgcode) {\n\tcase FC_BSG_HST_VENDOR:\n\t\t \n\t\trc = bfad_im_bsg_vendor_request(job);\n\t\tbreak;\n\tcase FC_BSG_HST_ELS_NOLOGIN:\n\tcase FC_BSG_RPT_ELS:\n\tcase FC_BSG_HST_CT:\n\tcase FC_BSG_RPT_CT:\n\t\t \n\t\trc = bfad_im_bsg_els_ct_request(job);\n\t\tbreak;\n\tdefault:\n\t\tbsg_reply->result = rc = -EINVAL;\n\t\tbsg_reply->reply_payload_rcv_len = 0;\n\t\tbreak;\n\t}\n\n\treturn rc;\n}\n\nint\nbfad_im_bsg_timeout(struct bsg_job *job)\n{\n\t \n\treturn -EAGAIN;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}