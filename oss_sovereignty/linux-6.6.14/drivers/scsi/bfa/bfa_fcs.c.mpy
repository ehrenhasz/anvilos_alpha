{
  "module_name": "bfa_fcs.c",
  "hash_id": "d74193b2e4cab453a476a6d086feaf4aacb6e96c90d8f4d6d4c80359022f7595",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/bfa/bfa_fcs.c",
  "human_readable_source": "\n \n\n \n\n#include \"bfad_drv.h\"\n#include \"bfad_im.h\"\n#include \"bfa_fcs.h\"\n#include \"bfa_fcbuild.h\"\n\nBFA_TRC_FILE(FCS, FCS);\n\n \n\nstatic void\nbfa_fcs_exit_comp(void *fcs_cbarg)\n{\n\tstruct bfa_fcs_s      *fcs = fcs_cbarg;\n\tstruct bfad_s         *bfad = fcs->bfad;\n\n\tcomplete(&bfad->comp);\n}\n\n \nvoid\nbfa_fcs_init(struct bfa_fcs_s *fcs)\n{\n\tbfa_sm_send_event(&fcs->fabric, BFA_FCS_FABRIC_SM_CREATE);\n\tbfa_trc(fcs, 0);\n}\n\n \n\n \nvoid\nbfa_fcs_update_cfg(struct bfa_fcs_s *fcs)\n{\n\tstruct bfa_fcs_fabric_s *fabric = &fcs->fabric;\n\tstruct bfa_lport_cfg_s *port_cfg = &fabric->bport.port_cfg;\n\tstruct bfa_ioc_s *ioc = &fabric->fcs->bfa->ioc;\n\n\tport_cfg->nwwn = ioc->attr->nwwn;\n\tport_cfg->pwwn = ioc->attr->pwwn;\n}\n\n \nvoid\nbfa_fcs_stop(struct bfa_fcs_s *fcs)\n{\n\tbfa_wc_init(&fcs->wc, bfa_fcs_exit_comp, fcs);\n\tbfa_wc_up(&fcs->wc);\n\tbfa_fcs_fabric_modstop(fcs);\n\tbfa_wc_wait(&fcs->wc);\n}\n\n \nvoid\nbfa_fcs_pbc_vport_init(struct bfa_fcs_s *fcs)\n{\n\tint i, npbc_vports;\n\tstruct bfi_pbc_vport_s pbc_vports[BFI_PBC_MAX_VPORTS];\n\n\t \n\tif (!fcs->min_cfg) {\n\t\tnpbc_vports =\n\t\t\tbfa_iocfc_get_pbc_vports(fcs->bfa, pbc_vports);\n\t\tfor (i = 0; i < npbc_vports; i++)\n\t\t\tbfa_fcb_pbc_vport_create(fcs->bfa->bfad, pbc_vports[i]);\n\t}\n}\n\n \nvoid\nbfa_fcs_driver_info_init(struct bfa_fcs_s *fcs,\n\t\t\tstruct bfa_fcs_driver_info_s *driver_info)\n{\n\n\tfcs->driver_info = *driver_info;\n\n\tbfa_fcs_fabric_psymb_init(&fcs->fabric);\n\tbfa_fcs_fabric_nsymb_init(&fcs->fabric);\n}\n\n \nvoid\nbfa_fcs_exit(struct bfa_fcs_s *fcs)\n{\n\tbfa_wc_init(&fcs->wc, bfa_fcs_exit_comp, fcs);\n\tbfa_wc_up(&fcs->wc);\n\tbfa_trc(fcs, 0);\n\tbfa_lps_delete(fcs->fabric.lps);\n\tbfa_sm_send_event(&fcs->fabric, BFA_FCS_FABRIC_SM_DELETE);\n\tbfa_wc_wait(&fcs->wc);\n}\n\n \n\n#define BFA_FCS_FABRIC_RETRY_DELAY\t(2000)\t \n#define BFA_FCS_FABRIC_CLEANUP_DELAY\t(10000)\t \n\n#define bfa_fcs_fabric_set_opertype(__fabric) do {\t\t\t\\\n\tif (bfa_fcport_get_topology((__fabric)->fcs->bfa)\t\t\\\n\t\t\t\t== BFA_PORT_TOPOLOGY_P2P) {\t\t\\\n\t\tif (fabric->fab_type == BFA_FCS_FABRIC_SWITCHED)\t\\\n\t\t\t(__fabric)->oper_type = BFA_PORT_TYPE_NPORT;\t\\\n\t\telse\t\t\t\t\t\t\t\\\n\t\t\t(__fabric)->oper_type = BFA_PORT_TYPE_P2P;\t\\\n\t} else\t\t\t\t\t\t\t\t\\\n\t\t(__fabric)->oper_type = BFA_PORT_TYPE_NLPORT;\t\t\\\n} while (0)\n\n \nstatic void bfa_fcs_fabric_init(struct bfa_fcs_fabric_s *fabric);\nstatic void bfa_fcs_fabric_login(struct bfa_fcs_fabric_s *fabric);\nstatic void bfa_fcs_fabric_notify_online(struct bfa_fcs_fabric_s *fabric);\nstatic void bfa_fcs_fabric_notify_offline(struct bfa_fcs_fabric_s *fabric);\nstatic void bfa_fcs_fabric_delay(void *cbarg);\nstatic void bfa_fcs_fabric_delete(struct bfa_fcs_fabric_s *fabric);\nstatic void bfa_fcs_fabric_delete_comp(void *cbarg);\nstatic void bfa_fcs_fabric_stop(struct bfa_fcs_fabric_s *fabric);\nstatic void bfa_fcs_fabric_stop_comp(void *cbarg);\nstatic void bfa_fcs_fabric_process_uf(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t      struct fchs_s *fchs, u16 len);\nstatic void bfa_fcs_fabric_process_flogi(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t struct fchs_s *fchs, u16 len);\nstatic void bfa_fcs_fabric_send_flogi_acc(struct bfa_fcs_fabric_s *fabric);\nstatic void bfa_fcs_fabric_flogiacc_comp(void *fcsarg,\n\t\t\t\t\t struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t\t\t bfa_status_t status,\n\t\t\t\t\t u32 rsp_len,\n\t\t\t\t\t u32 resid_len,\n\t\t\t\t\t struct fchs_s *rspfchs);\n\nstatic void\tbfa_fcs_fabric_sm_uninit(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_created(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t  enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_linkdown(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t   enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_flogi(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\tenum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_flogi_retry(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t      enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_auth(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t       enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_nofabric(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t   enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_evfp(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t       enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_evfp_done(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t    enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_isolated(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t   enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_deleting(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t   enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_stopping(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t   enum bfa_fcs_fabric_event event);\nstatic void\tbfa_fcs_fabric_sm_cleanup(struct bfa_fcs_fabric_s *fabric,\n\t\t\t\t\t  enum bfa_fcs_fabric_event event);\n \nstatic void\nbfa_fcs_fabric_sm_uninit(struct bfa_fcs_fabric_s *fabric,\n\t\t\t enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_CREATE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_created);\n\t\tbfa_fcs_fabric_init(fabric);\n\t\tbfa_fcs_lport_init(&fabric->bport, &fabric->bport.port_cfg);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_UP:\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_created(struct bfa_fcs_fabric_s *fabric,\n\t\t\t  enum bfa_fcs_fabric_event event)\n{\n\tstruct bfa_s\t*bfa = fabric->fcs->bfa;\n\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_START:\n\t\tif (!bfa_fcport_is_linkup(fabric->fcs->bfa)) {\n\t\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\n\t\t\tbreak;\n\t\t}\n\t\tif (bfa_fcport_get_topology(bfa) ==\n\t\t\t\tBFA_PORT_TOPOLOGY_LOOP) {\n\t\t\tfabric->fab_type = BFA_FCS_FABRIC_LOOP;\n\t\t\tfabric->bport.pid = bfa_fcport_get_myalpa(bfa);\n\t\t\tfabric->bport.pid = bfa_hton3b(fabric->bport.pid);\n\t\t\tbfa_sm_set_state(fabric,\n\t\t\t\t\tbfa_fcs_fabric_sm_online);\n\t\t\tbfa_fcs_fabric_set_opertype(fabric);\n\t\t\tbfa_fcs_lport_online(&fabric->bport);\n\t\t} else {\n\t\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_flogi);\n\t\t\tbfa_fcs_fabric_login(fabric);\n\t\t}\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_UP:\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_DELETE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\n\t\tbfa_fcs_fabric_delete(fabric);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_linkdown(struct bfa_fcs_fabric_s *fabric,\n\t\t\t   enum bfa_fcs_fabric_event event)\n{\n\tstruct bfa_s\t*bfa = fabric->fcs->bfa;\n\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_LINK_UP:\n\t\tif (bfa_fcport_get_topology(bfa) != BFA_PORT_TOPOLOGY_LOOP) {\n\t\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_flogi);\n\t\t\tbfa_fcs_fabric_login(fabric);\n\t\t\tbreak;\n\t\t}\n\t\tfabric->fab_type = BFA_FCS_FABRIC_LOOP;\n\t\tfabric->bport.pid = bfa_fcport_get_myalpa(bfa);\n\t\tfabric->bport.pid = bfa_hton3b(fabric->bport.pid);\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_online);\n\t\tbfa_fcs_fabric_set_opertype(fabric);\n\t\tbfa_fcs_lport_online(&fabric->bport);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_RETRY_OP:\n\tcase BFA_FCS_FABRIC_SM_LOOPBACK:\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_DELETE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\n\t\tbfa_fcs_fabric_delete(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_STOP:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_cleanup);\n\t\tbfa_fcs_fabric_stop(fabric);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_flogi(struct bfa_fcs_fabric_s *fabric,\n\t\t\tenum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_CONT_OP:\n\n\t\tbfa_fcport_set_tx_bbcredit(fabric->fcs->bfa,\n\t\t\t\t\t   fabric->bb_credit);\n\t\tfabric->fab_type = BFA_FCS_FABRIC_SWITCHED;\n\n\t\tif (fabric->auth_reqd && fabric->is_auth) {\n\t\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_auth);\n\t\t\tbfa_trc(fabric->fcs, event);\n\t\t} else {\n\t\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_online);\n\t\t\tbfa_fcs_fabric_notify_online(fabric);\n\t\t}\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_RETRY_OP:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_flogi_retry);\n\t\tbfa_timer_start(fabric->fcs->bfa, &fabric->delay_timer,\n\t\t\t\tbfa_fcs_fabric_delay, fabric,\n\t\t\t\tBFA_FCS_FABRIC_RETRY_DELAY);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LOOPBACK:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_loopback);\n\t\tbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\n\t\tbfa_fcs_fabric_set_opertype(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_NO_FABRIC:\n\t\tfabric->fab_type = BFA_FCS_FABRIC_N2N;\n\t\tbfa_fcport_set_tx_bbcredit(fabric->fcs->bfa,\n\t\t\t\t\t   fabric->bb_credit);\n\t\tbfa_fcs_fabric_notify_online(fabric);\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_nofabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\n\t\tbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_DELETE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\n\t\tbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\n\t\tbfa_fcs_fabric_delete(fabric);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n\nstatic void\nbfa_fcs_fabric_sm_flogi_retry(struct bfa_fcs_fabric_s *fabric,\n\t\t\t      enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_DELAYED:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_flogi);\n\t\tbfa_fcs_fabric_login(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\n\t\tbfa_timer_stop(&fabric->delay_timer);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_DELETE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\n\t\tbfa_timer_stop(&fabric->delay_timer);\n\t\tbfa_fcs_fabric_delete(fabric);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_auth(struct bfa_fcs_fabric_s *fabric,\n\t\t       enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_AUTH_FAILED:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_auth_failed);\n\t\tbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_AUTH_SUCCESS:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_online);\n\t\tbfa_fcs_fabric_notify_online(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_PERF_EVFP:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_evfp);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\n\t\tbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_DELETE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\n\t\tbfa_fcs_fabric_delete(fabric);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nvoid\nbfa_fcs_fabric_sm_auth_failed(struct bfa_fcs_fabric_s *fabric,\n\t\t\t      enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\n\t\tbfa_fcs_fabric_notify_offline(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_DELETE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\n\t\tbfa_fcs_fabric_delete(fabric);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nvoid\nbfa_fcs_fabric_sm_loopback(struct bfa_fcs_fabric_s *fabric,\n\t\t\t   enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\n\t\tbfa_fcs_fabric_notify_offline(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_DELETE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\n\t\tbfa_fcs_fabric_delete(fabric);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_nofabric(struct bfa_fcs_fabric_s *fabric,\n\t\t\t   enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\n\t\tbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\n\t\tbfa_fcs_fabric_notify_offline(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_DELETE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\n\t\tbfa_fcs_fabric_delete(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_NO_FABRIC:\n\t\tbfa_trc(fabric->fcs, fabric->bb_credit);\n\t\tbfa_fcport_set_tx_bbcredit(fabric->fcs->bfa,\n\t\t\t\t\t   fabric->bb_credit);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_RETRY_OP:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nvoid\nbfa_fcs_fabric_sm_online(struct bfa_fcs_fabric_s *fabric,\n\t\t\t enum bfa_fcs_fabric_event event)\n{\n\tstruct bfa_s\t*bfa = fabric->fcs->bfa;\n\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_linkdown);\n\t\tif (bfa_fcport_get_topology(bfa) == BFA_PORT_TOPOLOGY_LOOP) {\n\t\t\tbfa_fcs_lport_offline(&fabric->bport);\n\t\t} else {\n\t\t\tbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\n\t\t\tbfa_fcs_fabric_notify_offline(fabric);\n\t\t}\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_DELETE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_deleting);\n\t\tbfa_fcs_fabric_delete(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_STOP:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_stopping);\n\t\tbfa_fcs_fabric_stop(fabric);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_AUTH_FAILED:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_auth_failed);\n\t\tbfa_sm_send_event(fabric->lps, BFA_LPS_SM_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_AUTH_SUCCESS:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_evfp(struct bfa_fcs_fabric_s *fabric,\n\t\t       enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_CONT_OP:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_evfp_done);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_ISOLATE:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_isolated);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_evfp_done(struct bfa_fcs_fabric_s *fabric,\n\t\t\t    enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_isolated(struct bfa_fcs_fabric_s *fabric,\n\t\t\t   enum bfa_fcs_fabric_event event)\n{\n\tstruct bfad_s *bfad = (struct bfad_s *)fabric->fcs->bfad;\n\tchar\tpwwn_ptr[BFA_STRING_32];\n\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\twwn2str(pwwn_ptr, fabric->bport.port_cfg.pwwn);\n\n\tBFA_LOG(KERN_INFO, bfad, bfa_log_level,\n\t\t\"Port is isolated due to VF_ID mismatch. \"\n\t\t\"PWWN: %s Port VF_ID: %04x switch port VF_ID: %04x.\",\n\t\tpwwn_ptr, fabric->fcs->port_vfid,\n\t\tfabric->event_arg.swp_vfid);\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_deleting(struct bfa_fcs_fabric_s *fabric,\n\t\t\t   enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_DELCOMP:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_uninit);\n\t\tbfa_wc_down(&fabric->fcs->wc);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_UP:\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tbfa_fcs_fabric_notify_offline(fabric);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_stopping(struct bfa_fcs_fabric_s *fabric,\n\t\t\t   enum bfa_fcs_fabric_event event)\n{\n\tstruct bfa_s\t*bfa = fabric->fcs->bfa;\n\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_STOPCOMP:\n\t\tif (bfa_fcport_get_topology(bfa) == BFA_PORT_TOPOLOGY_LOOP) {\n\t\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_created);\n\t\t} else {\n\t\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_cleanup);\n\t\t\tbfa_sm_send_event(fabric->lps, BFA_LPS_SM_LOGOUT);\n\t\t}\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_UP:\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\tif (bfa_fcport_get_topology(bfa) == BFA_PORT_TOPOLOGY_LOOP)\n\t\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_created);\n\t\telse\n\t\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_cleanup);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_sm_cleanup(struct bfa_fcs_fabric_s *fabric,\n\t\t\t  enum bfa_fcs_fabric_event event)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_FABRIC_SM_STOPCOMP:\n\tcase BFA_FCS_FABRIC_SM_LOGOCOMP:\n\t\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_created);\n\t\tbfa_wc_down(&(fabric->fcs)->wc);\n\t\tbreak;\n\n\tcase BFA_FCS_FABRIC_SM_LINK_DOWN:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(fabric->fcs, event);\n\t}\n}\n\n \n\nstatic void\nbfa_fcs_fabric_init(struct bfa_fcs_fabric_s *fabric)\n{\n\tstruct bfa_lport_cfg_s *port_cfg = &fabric->bport.port_cfg;\n\n\tport_cfg->roles = BFA_LPORT_ROLE_FCP_IM;\n\tport_cfg->nwwn = fabric->fcs->bfa->ioc.attr->nwwn;\n\tport_cfg->pwwn = fabric->fcs->bfa->ioc.attr->pwwn;\n}\n\n \nvoid\nbfa_fcs_fabric_psymb_init(struct bfa_fcs_fabric_s *fabric)\n{\n\tstruct bfa_lport_cfg_s *port_cfg = &fabric->bport.port_cfg;\n\tchar model[BFA_ADAPTER_MODEL_NAME_LEN] = {0};\n\tstruct bfa_fcs_driver_info_s *driver_info = &fabric->fcs->driver_info;\n\n\tbfa_ioc_get_adapter_model(&fabric->fcs->bfa->ioc, model);\n\n\t \n\tstrscpy(port_cfg->sym_name.symname, model,\n\t\tBFA_SYMNAME_MAXLEN);\n\tstrlcat(port_cfg->sym_name.symname, BFA_FCS_PORT_SYMBNAME_SEPARATOR,\n\t\tBFA_SYMNAME_MAXLEN);\n\n\t \n\tstrlcat(port_cfg->sym_name.symname, driver_info->version,\n\t\tBFA_SYMNAME_MAXLEN);\n\tstrlcat(port_cfg->sym_name.symname, BFA_FCS_PORT_SYMBNAME_SEPARATOR,\n\t\tBFA_SYMNAME_MAXLEN);\n\n\t \n\tstrlcat(port_cfg->sym_name.symname,\n\t\tdriver_info->host_machine_name,\n\t\tBFA_SYMNAME_MAXLEN);\n\tstrlcat(port_cfg->sym_name.symname, BFA_FCS_PORT_SYMBNAME_SEPARATOR,\n\t\tBFA_SYMNAME_MAXLEN);\n\n\t \n\tif (driver_info->host_os_patch[0] == '\\0') {\n\t\tstrlcat(port_cfg->sym_name.symname,\n\t\t\tdriver_info->host_os_name,\n\t\t\tBFA_SYMNAME_MAXLEN);\n\t\tstrlcat(port_cfg->sym_name.symname,\n\t\t\tBFA_FCS_PORT_SYMBNAME_SEPARATOR,\n\t\t\tBFA_SYMNAME_MAXLEN);\n\t} else {\n\t\tstrlcat(port_cfg->sym_name.symname,\n\t\t\tdriver_info->host_os_name,\n\t\t\tBFA_SYMNAME_MAXLEN);\n\t\tstrlcat(port_cfg->sym_name.symname,\n\t\t\tBFA_FCS_PORT_SYMBNAME_SEPARATOR,\n\t\t\tBFA_SYMNAME_MAXLEN);\n\n\t\t \n\t\tstrlcat(port_cfg->sym_name.symname,\n\t\t\tdriver_info->host_os_patch,\n\t\t\tBFA_SYMNAME_MAXLEN);\n\t}\n\n\t \n\tport_cfg->sym_name.symname[BFA_SYMNAME_MAXLEN - 1] = 0;\n}\n\n \nvoid\nbfa_fcs_fabric_nsymb_init(struct bfa_fcs_fabric_s *fabric)\n{\n\tstruct bfa_lport_cfg_s *port_cfg = &fabric->bport.port_cfg;\n\tchar model[BFA_ADAPTER_MODEL_NAME_LEN] = {0};\n\tstruct bfa_fcs_driver_info_s *driver_info = &fabric->fcs->driver_info;\n\n\tbfa_ioc_get_adapter_model(&fabric->fcs->bfa->ioc, model);\n\n\t \n\tstrscpy(port_cfg->node_sym_name.symname, model,\n\t\tBFA_SYMNAME_MAXLEN);\n\tstrlcat(port_cfg->node_sym_name.symname,\n\t\t\tBFA_FCS_PORT_SYMBNAME_SEPARATOR,\n\t\t\tBFA_SYMNAME_MAXLEN);\n\n\t \n\tstrlcat(port_cfg->node_sym_name.symname, (char *)driver_info->version,\n\t\tBFA_SYMNAME_MAXLEN);\n\tstrlcat(port_cfg->node_sym_name.symname,\n\t\t\tBFA_FCS_PORT_SYMBNAME_SEPARATOR,\n\t\t\tBFA_SYMNAME_MAXLEN);\n\n\t \n\tstrlcat(port_cfg->node_sym_name.symname,\n\t\tdriver_info->host_machine_name,\n\t\tBFA_SYMNAME_MAXLEN);\n\tstrlcat(port_cfg->node_sym_name.symname,\n\t\t\tBFA_FCS_PORT_SYMBNAME_SEPARATOR,\n\t\t\tBFA_SYMNAME_MAXLEN);\n\n\t \n\tport_cfg->node_sym_name.symname[BFA_SYMNAME_MAXLEN - 1] = 0;\n}\n\n \nvoid\nbfa_cb_lps_flogi_comp(void *bfad, void *uarg, bfa_status_t status)\n{\n\tstruct bfa_fcs_fabric_s *fabric = uarg;\n\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_trc(fabric->fcs, status);\n\n\tswitch (status) {\n\tcase BFA_STATUS_OK:\n\t\tfabric->stats.flogi_accepts++;\n\t\tbreak;\n\n\tcase BFA_STATUS_INVALID_MAC:\n\t\t \n\t\tfabric->stats.flogi_acc_err++;\n\t\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_RETRY_OP);\n\n\t\treturn;\n\n\tcase BFA_STATUS_EPROTOCOL:\n\t\tswitch (fabric->lps->ext_status) {\n\t\tcase BFA_EPROTO_BAD_ACCEPT:\n\t\t\tfabric->stats.flogi_acc_err++;\n\t\t\tbreak;\n\n\t\tcase BFA_EPROTO_UNKNOWN_RSP:\n\t\t\tfabric->stats.flogi_unknown_rsp++;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_RETRY_OP);\n\n\t\treturn;\n\n\tcase BFA_STATUS_FABRIC_RJT:\n\t\tfabric->stats.flogi_rejects++;\n\t\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_RETRY_OP);\n\t\treturn;\n\n\tdefault:\n\t\tfabric->stats.flogi_rsp_err++;\n\t\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_RETRY_OP);\n\t\treturn;\n\t}\n\n\tfabric->bb_credit = fabric->lps->pr_bbcred;\n\tbfa_trc(fabric->fcs, fabric->bb_credit);\n\n\tif (!(fabric->lps->brcd_switch))\n\t\tfabric->fabric_name =  fabric->lps->pr_nwwn;\n\n\t \n\tif (fabric->lps->fport) {\n\t\tfabric->bport.pid = fabric->lps->lp_pid;\n\t\tfabric->is_npiv = fabric->lps->npiv_en;\n\t\tfabric->is_auth = fabric->lps->auth_req;\n\t\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_CONT_OP);\n\t} else {\n\t\t \n\t\tfabric->bport.port_topo.pn2n.rem_port_wwn =\n\t\t\tfabric->lps->pr_pwwn;\n\t\tfabric->fab_type = BFA_FCS_FABRIC_N2N;\n\t\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_NO_FABRIC);\n\t}\n\n\tbfa_trc(fabric->fcs, fabric->bport.pid);\n\tbfa_trc(fabric->fcs, fabric->is_npiv);\n\tbfa_trc(fabric->fcs, fabric->is_auth);\n}\n \nstatic void\nbfa_fcs_fabric_login(struct bfa_fcs_fabric_s *fabric)\n{\n\tstruct bfa_s\t\t*bfa = fabric->fcs->bfa;\n\tstruct bfa_lport_cfg_s\t*pcfg = &fabric->bport.port_cfg;\n\tu8\t\t\talpa = 0;\n\n\n\tbfa_lps_flogi(fabric->lps, fabric, alpa, bfa_fcport_get_maxfrsize(bfa),\n\t\t      pcfg->pwwn, pcfg->nwwn, fabric->auth_reqd);\n\n\tfabric->stats.flogi_sent++;\n}\n\nstatic void\nbfa_fcs_fabric_notify_online(struct bfa_fcs_fabric_s *fabric)\n{\n\tstruct bfa_fcs_vport_s *vport;\n\tstruct list_head\t      *qe, *qen;\n\n\tbfa_trc(fabric->fcs, fabric->fabric_name);\n\n\tbfa_fcs_fabric_set_opertype(fabric);\n\tfabric->stats.fabric_onlines++;\n\n\t \n\tbfa_fcs_lport_online(&fabric->bport);\n\n\tlist_for_each_safe(qe, qen, &fabric->vport_q) {\n\t\tvport = (struct bfa_fcs_vport_s *) qe;\n\t\tbfa_fcs_vport_online(vport);\n\t}\n}\n\nstatic void\nbfa_fcs_fabric_notify_offline(struct bfa_fcs_fabric_s *fabric)\n{\n\tstruct bfa_fcs_vport_s *vport;\n\tstruct list_head\t      *qe, *qen;\n\n\tbfa_trc(fabric->fcs, fabric->fabric_name);\n\tfabric->stats.fabric_offlines++;\n\n\t \n\tlist_for_each_safe(qe, qen, &fabric->vport_q) {\n\t\tvport = (struct bfa_fcs_vport_s *) qe;\n\t\tbfa_fcs_vport_offline(vport);\n\t}\n\n\tbfa_fcs_lport_offline(&fabric->bport);\n\n\tfabric->fabric_name = 0;\n\tfabric->fabric_ip_addr[0] = 0;\n}\n\nstatic void\nbfa_fcs_fabric_delay(void *cbarg)\n{\n\tstruct bfa_fcs_fabric_s *fabric = cbarg;\n\n\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_DELAYED);\n}\n\n \nstatic void\nbfa_fcs_fabric_stop(struct bfa_fcs_fabric_s *fabric)\n{\n\tstruct bfa_fcs_vport_s *vport;\n\tstruct list_head\t*qe, *qen;\n\n\tbfa_wc_init(&fabric->stop_wc, bfa_fcs_fabric_stop_comp, fabric);\n\n\tlist_for_each_safe(qe, qen, &fabric->vport_q) {\n\t\tvport = (struct bfa_fcs_vport_s *) qe;\n\t\tbfa_wc_up(&fabric->stop_wc);\n\t\tbfa_fcs_vport_fcs_stop(vport);\n\t}\n\n\tbfa_wc_up(&fabric->stop_wc);\n\tbfa_fcs_lport_stop(&fabric->bport);\n\tbfa_wc_wait(&fabric->stop_wc);\n}\n\n \nstatic void\nbfa_fcs_fabric_delete(struct bfa_fcs_fabric_s *fabric)\n{\n\tstruct bfa_fcs_vport_s *vport;\n\tstruct list_head\t      *qe, *qen;\n\n\tlist_for_each_safe(qe, qen, &fabric->vport_q) {\n\t\tvport = (struct bfa_fcs_vport_s *) qe;\n\t\tbfa_fcs_vport_fcs_delete(vport);\n\t}\n\n\tbfa_fcs_lport_delete(&fabric->bport);\n\tbfa_wc_wait(&fabric->wc);\n}\n\nstatic void\nbfa_fcs_fabric_delete_comp(void *cbarg)\n{\n\tstruct bfa_fcs_fabric_s *fabric = cbarg;\n\n\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_DELCOMP);\n}\n\nstatic void\nbfa_fcs_fabric_stop_comp(void *cbarg)\n{\n\tstruct bfa_fcs_fabric_s *fabric = cbarg;\n\n\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_STOPCOMP);\n}\n\n \n\n \nvoid\nbfa_fcs_fabric_modstop(struct bfa_fcs_s *fcs)\n{\n\tstruct bfa_fcs_fabric_s *fabric;\n\n\tbfa_trc(fcs, 0);\n\tfabric = &fcs->fabric;\n\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_STOP);\n}\n\n \nvoid\nbfa_fcs_fabric_modstart(struct bfa_fcs_s *fcs)\n{\n\tstruct bfa_fcs_fabric_s *fabric;\n\n\tbfa_trc(fcs, 0);\n\tfabric = &fcs->fabric;\n\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_START);\n}\n\n\n \nvoid\nbfa_fcs_fabric_link_up(struct bfa_fcs_fabric_s *fabric)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_LINK_UP);\n}\n\n \nvoid\nbfa_fcs_fabric_link_down(struct bfa_fcs_fabric_s *fabric)\n{\n\tbfa_trc(fabric->fcs, fabric->bport.port_cfg.pwwn);\n\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_LINK_DOWN);\n}\n\n \nvoid\nbfa_fcs_fabric_addvport(struct bfa_fcs_fabric_s *fabric,\n\t\t\tstruct bfa_fcs_vport_s *vport)\n{\n\t \n\tbfa_trc(fabric->fcs, fabric->vf_id);\n\n\tlist_add_tail(&vport->qe, &fabric->vport_q);\n\tfabric->num_vports++;\n\tbfa_wc_up(&fabric->wc);\n}\n\n \nvoid\nbfa_fcs_fabric_delvport(struct bfa_fcs_fabric_s *fabric,\n\t\t\tstruct bfa_fcs_vport_s *vport)\n{\n\tlist_del(&vport->qe);\n\tfabric->num_vports--;\n\tbfa_wc_down(&fabric->wc);\n}\n\n\n \nstruct bfa_fcs_vport_s *\nbfa_fcs_fabric_vport_lookup(struct bfa_fcs_fabric_s *fabric, wwn_t pwwn)\n{\n\tstruct bfa_fcs_vport_s *vport;\n\tstruct list_head\t      *qe;\n\n\tlist_for_each(qe, &fabric->vport_q) {\n\t\tvport = (struct bfa_fcs_vport_s *) qe;\n\t\tif (bfa_fcs_lport_get_pwwn(&vport->lport) == pwwn)\n\t\t\treturn vport;\n\t}\n\n\treturn NULL;\n}\n\n\n \n\nu16\nbfa_fcs_fabric_get_switch_oui(struct bfa_fcs_fabric_s *fabric)\n{\n\twwn_t fab_nwwn;\n\tu8 *tmp;\n\tu16 oui;\n\n\tfab_nwwn = fabric->lps->pr_nwwn;\n\n\ttmp = (u8 *)&fab_nwwn;\n\toui = (tmp[3] << 8) | tmp[4];\n\n\treturn oui;\n}\n \nvoid\nbfa_fcs_fabric_uf_recv(struct bfa_fcs_fabric_s *fabric, struct fchs_s *fchs,\n\t\t       u16 len)\n{\n\tu32\tpid = fchs->d_id;\n\tstruct bfa_fcs_vport_s *vport;\n\tstruct list_head\t      *qe;\n\tstruct fc_els_cmd_s *els_cmd = (struct fc_els_cmd_s *) (fchs + 1);\n\tstruct fc_logi_s *flogi = (struct fc_logi_s *) els_cmd;\n\n\tbfa_trc(fabric->fcs, len);\n\tbfa_trc(fabric->fcs, pid);\n\n\t \n\tif ((pid == bfa_ntoh3b(FC_FABRIC_PORT)) &&\n\t    (els_cmd->els_code == FC_ELS_FLOGI) &&\n\t    (flogi->port_name == bfa_fcs_lport_get_pwwn(&fabric->bport))) {\n\t\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_LOOPBACK);\n\t\treturn;\n\t}\n\n\t \n\tif (fchs->d_id == bfa_hton3b(FC_FABRIC_PORT)) {\n\t\tbfa_trc(fabric->fcs, pid);\n\t\tbfa_fcs_fabric_process_uf(fabric, fchs, len);\n\t\treturn;\n\t}\n\n\tif (fabric->bport.pid == pid) {\n\t\t \n\t\tbfa_trc(fabric->fcs, els_cmd->els_code);\n\t\tif (els_cmd->els_code == FC_ELS_AUTH) {\n\t\t\tbfa_trc(fabric->fcs, els_cmd->els_code);\n\t\t\treturn;\n\t\t}\n\n\t\tbfa_trc(fabric->fcs, *(u8 *) ((u8 *) fchs));\n\t\tbfa_fcs_lport_uf_recv(&fabric->bport, fchs, len);\n\t\treturn;\n\t}\n\n\t \n\tlist_for_each(qe, &fabric->vport_q) {\n\t\tvport = (struct bfa_fcs_vport_s *) qe;\n\t\tif (vport->lport.pid == pid) {\n\t\t\tbfa_fcs_lport_uf_recv(&vport->lport, fchs, len);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif (!bfa_fcs_fabric_is_switched(fabric))\n\t\tbfa_fcs_lport_uf_recv(&fabric->bport, fchs, len);\n\n\tbfa_trc(fabric->fcs, fchs->type);\n}\n\n \nstatic void\nbfa_fcs_fabric_process_uf(struct bfa_fcs_fabric_s *fabric, struct fchs_s *fchs,\n\t\t\t  u16 len)\n{\n\tstruct fc_els_cmd_s *els_cmd = (struct fc_els_cmd_s *) (fchs + 1);\n\n\tbfa_trc(fabric->fcs, els_cmd->els_code);\n\n\tswitch (els_cmd->els_code) {\n\tcase FC_ELS_FLOGI:\n\t\tbfa_fcs_fabric_process_flogi(fabric, fchs, len);\n\t\tbreak;\n\n\tdefault:\n\t\t \n\t\tbreak;\n\t}\n}\n\n \nstatic void\nbfa_fcs_fabric_process_flogi(struct bfa_fcs_fabric_s *fabric,\n\t\t\tstruct fchs_s *fchs, u16 len)\n{\n\tstruct fc_logi_s *flogi = (struct fc_logi_s *) (fchs + 1);\n\tstruct bfa_fcs_lport_s *bport = &fabric->bport;\n\n\tbfa_trc(fabric->fcs, fchs->s_id);\n\n\tfabric->stats.flogi_rcvd++;\n\t \n\tif (flogi->csp.port_type) {\n\t\t \n\t\tbfa_trc(fabric->fcs, flogi->port_name);\n\t\tfabric->stats.flogi_rejected++;\n\t\treturn;\n\t}\n\n\tfabric->bb_credit = be16_to_cpu(flogi->csp.bbcred);\n\tbport->port_topo.pn2n.rem_port_wwn = flogi->port_name;\n\tbport->port_topo.pn2n.reply_oxid = fchs->ox_id;\n\n\t \n\tbfa_fcs_fabric_send_flogi_acc(fabric);\n\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_NO_FABRIC);\n}\n\nstatic void\nbfa_fcs_fabric_send_flogi_acc(struct bfa_fcs_fabric_s *fabric)\n{\n\tstruct bfa_lport_cfg_s *pcfg = &fabric->bport.port_cfg;\n\tstruct bfa_fcs_lport_n2n_s *n2n_port = &fabric->bport.port_topo.pn2n;\n\tstruct bfa_s\t  *bfa = fabric->fcs->bfa;\n\tstruct bfa_fcxp_s *fcxp;\n\tu16\treqlen;\n\tstruct fchs_s\tfchs;\n\n\tfcxp = bfa_fcs_fcxp_alloc(fabric->fcs, BFA_FALSE);\n\t \n\tif (!fcxp)\n\t\treturn;\n\n\treqlen = fc_flogi_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t\t    bfa_hton3b(FC_FABRIC_PORT),\n\t\t\t\t    n2n_port->reply_oxid, pcfg->pwwn,\n\t\t\t\t    pcfg->nwwn,\n\t\t\t\t    bfa_fcport_get_maxfrsize(bfa),\n\t\t\t\t    bfa_fcport_get_rx_bbcredit(bfa), 0);\n\n\tbfa_fcxp_send(fcxp, NULL, fabric->vf_id, fabric->lps->bfa_tag,\n\t\t      BFA_FALSE, FC_CLASS_3,\n\t\t      reqlen, &fchs, bfa_fcs_fabric_flogiacc_comp, fabric,\n\t\t      FC_MAX_PDUSZ, 0);\n}\n\n \nstatic void\nbfa_fcs_fabric_flogiacc_comp(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t     bfa_status_t status, u32 rsp_len,\n\t\t\t     u32 resid_len, struct fchs_s *rspfchs)\n{\n\tstruct bfa_fcs_fabric_s *fabric = cbarg;\n\n\tbfa_trc(fabric->fcs, status);\n}\n\n\n \nstatic void\nbfa_fcs_fabric_aen_post(struct bfa_fcs_lport_s *port,\n\t\t\tenum bfa_port_aen_event event)\n{\n\tstruct bfad_s *bfad = (struct bfad_s *)port->fabric->fcs->bfad;\n\tstruct bfa_aen_entry_s  *aen_entry;\n\n\tbfad_get_aen_entry(bfad, aen_entry);\n\tif (!aen_entry)\n\t\treturn;\n\n\taen_entry->aen_data.port.pwwn = bfa_fcs_lport_get_pwwn(port);\n\taen_entry->aen_data.port.fwwn = bfa_fcs_lport_get_fabric_name(port);\n\n\t \n\tbfad_im_post_vendor_event(aen_entry, bfad, ++port->fcs->fcs_aen_seq,\n\t\t\t\t  BFA_AEN_CAT_PORT, event);\n}\n\n \nvoid\nbfa_fcs_fabric_set_fabric_name(struct bfa_fcs_fabric_s *fabric,\n\t\t\t       wwn_t fabric_name)\n{\n\tstruct bfad_s *bfad = (struct bfad_s *)fabric->fcs->bfad;\n\tchar\tpwwn_ptr[BFA_STRING_32];\n\tchar\tfwwn_ptr[BFA_STRING_32];\n\n\tbfa_trc(fabric->fcs, fabric_name);\n\n\tif (fabric->fabric_name == 0) {\n\t\t \n\t\tfabric->fabric_name = fabric_name;\n\t} else {\n\t\tfabric->fabric_name = fabric_name;\n\t\twwn2str(pwwn_ptr, bfa_fcs_lport_get_pwwn(&fabric->bport));\n\t\twwn2str(fwwn_ptr,\n\t\t\tbfa_fcs_lport_get_fabric_name(&fabric->bport));\n\t\tBFA_LOG(KERN_WARNING, bfad, bfa_log_level,\n\t\t\t\"Base port WWN = %s Fabric WWN = %s\\n\",\n\t\t\tpwwn_ptr, fwwn_ptr);\n\t\tbfa_fcs_fabric_aen_post(&fabric->bport,\n\t\t\t\tBFA_PORT_AEN_FABRIC_NAME_CHANGE);\n\t}\n}\n\nvoid\nbfa_cb_lps_flogo_comp(void *bfad, void *uarg)\n{\n\tstruct bfa_fcs_fabric_s *fabric = uarg;\n\tbfa_sm_send_event(fabric, BFA_FCS_FABRIC_SM_LOGOCOMP);\n}\n\n \nbfa_fcs_vf_t   *\nbfa_fcs_vf_lookup(struct bfa_fcs_s *fcs, u16 vf_id)\n{\n\tbfa_trc(fcs, vf_id);\n\tif (vf_id == FC_VF_ID_NULL)\n\t\treturn &fcs->fabric;\n\n\treturn NULL;\n}\n\n \nvoid\nbfa_fcs_vf_get_ports(bfa_fcs_vf_t *vf, wwn_t lpwwn[], int *nlports)\n{\n\tstruct list_head *qe;\n\tstruct bfa_fcs_vport_s *vport;\n\tint\ti = 0;\n\tstruct bfa_fcs_s\t*fcs;\n\n\tif (vf == NULL || lpwwn == NULL || *nlports == 0)\n\t\treturn;\n\n\tfcs = vf->fcs;\n\n\tbfa_trc(fcs, vf->vf_id);\n\tbfa_trc(fcs, (uint32_t) *nlports);\n\n\tlpwwn[i++] = vf->bport.port_cfg.pwwn;\n\n\tlist_for_each(qe, &vf->vport_q) {\n\t\tif (i >= *nlports)\n\t\t\tbreak;\n\n\t\tvport = (struct bfa_fcs_vport_s *) qe;\n\t\tlpwwn[i++] = vport->lport.port_cfg.pwwn;\n\t}\n\n\tbfa_trc(fcs, i);\n\t*nlports = i;\n}\n\n \nstatic void\nbfa_fcs_port_event_handler(void *cbarg, enum bfa_port_linkstate event)\n{\n\tstruct bfa_fcs_s      *fcs = cbarg;\n\n\tbfa_trc(fcs, event);\n\n\tswitch (event) {\n\tcase BFA_PORT_LINKUP:\n\t\tbfa_fcs_fabric_link_up(&fcs->fabric);\n\t\tbreak;\n\n\tcase BFA_PORT_LINKDOWN:\n\t\tbfa_fcs_fabric_link_down(&fcs->fabric);\n\t\tbreak;\n\n\tdefault:\n\t\tWARN_ON(1);\n\t}\n}\n\n \n\n \nstatic void\nbfa_fcs_uf_recv(void *cbarg, struct bfa_uf_s *uf)\n{\n\tstruct bfa_fcs_s\t*fcs = (struct bfa_fcs_s *) cbarg;\n\tstruct fchs_s\t*fchs = bfa_uf_get_frmbuf(uf);\n\tu16\tlen = bfa_uf_get_frmlen(uf);\n\tstruct fc_vft_s *vft;\n\tstruct bfa_fcs_fabric_s *fabric;\n\n\t \n\tif (fchs->routing == FC_RTG_EXT_HDR &&\n\t    fchs->cat_info == FC_CAT_VFT_HDR) {\n\t\tbfa_stats(fcs, uf.tagged);\n\t\tvft = bfa_uf_get_frmbuf(uf);\n\t\tif (fcs->port_vfid == vft->vf_id)\n\t\t\tfabric = &fcs->fabric;\n\t\telse\n\t\t\tfabric = bfa_fcs_vf_lookup(fcs, (u16) vft->vf_id);\n\n\t\t \n\t\tif (!fabric) {\n\t\t\tWARN_ON(1);\n\t\t\tbfa_stats(fcs, uf.vfid_unknown);\n\t\t\tbfa_uf_free(uf);\n\t\t\treturn;\n\t\t}\n\n\t\t \n\t\tfchs = (struct fchs_s *) (vft + 1);\n\t\tlen -= sizeof(struct fc_vft_s);\n\n\t\tbfa_trc(fcs, vft->vf_id);\n\t} else {\n\t\tbfa_stats(fcs, uf.untagged);\n\t\tfabric = &fcs->fabric;\n\t}\n\n\tbfa_trc(fcs, ((u32 *) fchs)[0]);\n\tbfa_trc(fcs, ((u32 *) fchs)[1]);\n\tbfa_trc(fcs, ((u32 *) fchs)[2]);\n\tbfa_trc(fcs, ((u32 *) fchs)[3]);\n\tbfa_trc(fcs, ((u32 *) fchs)[4]);\n\tbfa_trc(fcs, ((u32 *) fchs)[5]);\n\tbfa_trc(fcs, len);\n\n\tbfa_fcs_fabric_uf_recv(fabric, fchs, len);\n\tbfa_uf_free(uf);\n}\n\n \nvoid\nbfa_fcs_attach(struct bfa_fcs_s *fcs, struct bfa_s *bfa, struct bfad_s *bfad,\n\t       bfa_boolean_t min_cfg)\n{\n\tstruct bfa_fcs_fabric_s *fabric = &fcs->fabric;\n\n\tfcs->bfa = bfa;\n\tfcs->bfad = bfad;\n\tfcs->min_cfg = min_cfg;\n\tfcs->num_rport_logins = 0;\n\n\tbfa->fcs = BFA_TRUE;\n\tfcbuild_init();\n\n\tbfa_fcport_event_register(fcs->bfa, bfa_fcs_port_event_handler, fcs);\n\tbfa_uf_recv_register(fcs->bfa, bfa_fcs_uf_recv, fcs);\n\n\tmemset(fabric, 0, sizeof(struct bfa_fcs_fabric_s));\n\n\t \n\tfabric->fcs = fcs;\n\tINIT_LIST_HEAD(&fabric->vport_q);\n\tINIT_LIST_HEAD(&fabric->vf_q);\n\tfabric->lps = bfa_lps_alloc(fcs->bfa);\n\tWARN_ON(!fabric->lps);\n\n\t \n\tbfa_wc_init(&fabric->wc, bfa_fcs_fabric_delete_comp, fabric);\n\tbfa_wc_up(&fabric->wc);  \n\n\tbfa_sm_set_state(fabric, bfa_fcs_fabric_sm_uninit);\n\tbfa_fcs_lport_attach(&fabric->bport, fabric->fcs, FC_VF_ID_NULL, NULL);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}