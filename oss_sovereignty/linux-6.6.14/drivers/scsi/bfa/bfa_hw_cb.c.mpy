{
  "module_name": "bfa_hw_cb.c",
  "hash_id": "605cb2d7147e30f1bf0d59437b9371c70fcc53ec941f6af696abce0ee907d0a1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/bfa/bfa_hw_cb.c",
  "human_readable_source": "\n \n\n#include \"bfad_drv.h\"\n#include \"bfa_modules.h\"\n#include \"bfi_reg.h\"\n\nvoid\nbfa_hwcb_reginit(struct bfa_s *bfa)\n{\n\tstruct bfa_iocfc_regs_s\t*bfa_regs = &bfa->iocfc.bfa_regs;\n\tvoid __iomem *kva = bfa_ioc_bar0(&bfa->ioc);\n\tint\tfn = bfa_ioc_pcifn(&bfa->ioc);\n\n\tif (fn == 0) {\n\t\tbfa_regs->intr_status = (kva + HOSTFN0_INT_STATUS);\n\t\tbfa_regs->intr_mask   = (kva + HOSTFN0_INT_MSK);\n\t} else {\n\t\tbfa_regs->intr_status = (kva + HOSTFN1_INT_STATUS);\n\t\tbfa_regs->intr_mask   = (kva + HOSTFN1_INT_MSK);\n\t}\n}\n\nstatic void\nbfa_hwcb_reqq_ack_msix(struct bfa_s *bfa, int reqq)\n{\n\twritel(__HFN_INT_CPE_Q0 << CPE_Q_NUM(bfa_ioc_pcifn(&bfa->ioc), reqq),\n\t\t\tbfa->iocfc.bfa_regs.intr_status);\n}\n\n \nstatic void\nbfa_hwcb_rspq_ack_msix(struct bfa_s *bfa, int rspq, u32 ci)\n{\n\twritel(__HFN_INT_RME_Q0 << RME_Q_NUM(bfa_ioc_pcifn(&bfa->ioc), rspq),\n\t\tbfa->iocfc.bfa_regs.intr_status);\n\n\tif (bfa_rspq_ci(bfa, rspq) == ci)\n\t\treturn;\n\n\tbfa_rspq_ci(bfa, rspq) = ci;\n\twritel(ci, bfa->iocfc.bfa_regs.rme_q_ci[rspq]);\n}\n\nvoid\nbfa_hwcb_rspq_ack(struct bfa_s *bfa, int rspq, u32 ci)\n{\n\tif (bfa_rspq_ci(bfa, rspq) == ci)\n\t\treturn;\n\n\tbfa_rspq_ci(bfa, rspq) = ci;\n\twritel(ci, bfa->iocfc.bfa_regs.rme_q_ci[rspq]);\n}\n\nvoid\nbfa_hwcb_msix_getvecs(struct bfa_s *bfa, u32 *msix_vecs_bmap,\n\t\t u32 *num_vecs, u32 *max_vec_bit)\n{\n#define __HFN_NUMINTS\t13\n\tif (bfa_ioc_pcifn(&bfa->ioc) == 0) {\n\t\t*msix_vecs_bmap = (__HFN_INT_CPE_Q0 | __HFN_INT_CPE_Q1 |\n\t\t\t\t   __HFN_INT_CPE_Q2 | __HFN_INT_CPE_Q3 |\n\t\t\t\t   __HFN_INT_RME_Q0 | __HFN_INT_RME_Q1 |\n\t\t\t\t   __HFN_INT_RME_Q2 | __HFN_INT_RME_Q3 |\n\t\t\t\t   __HFN_INT_MBOX_LPU0);\n\t\t*max_vec_bit = __HFN_INT_MBOX_LPU0;\n\t} else {\n\t\t*msix_vecs_bmap = (__HFN_INT_CPE_Q4 | __HFN_INT_CPE_Q5 |\n\t\t\t\t   __HFN_INT_CPE_Q6 | __HFN_INT_CPE_Q7 |\n\t\t\t\t   __HFN_INT_RME_Q4 | __HFN_INT_RME_Q5 |\n\t\t\t\t   __HFN_INT_RME_Q6 | __HFN_INT_RME_Q7 |\n\t\t\t\t   __HFN_INT_MBOX_LPU1);\n\t\t*max_vec_bit = __HFN_INT_MBOX_LPU1;\n\t}\n\n\t*msix_vecs_bmap |= (__HFN_INT_ERR_EMC | __HFN_INT_ERR_LPU0 |\n\t\t\t    __HFN_INT_ERR_LPU1 | __HFN_INT_ERR_PSS);\n\t*num_vecs = __HFN_NUMINTS;\n}\n\n \nstatic void\nbfa_hwcb_msix_dummy(struct bfa_s *bfa, int vec)\n{\n}\n\n \nvoid\nbfa_hwcb_msix_init(struct bfa_s *bfa, int nvecs)\n{\n\tWARN_ON((nvecs != 1) && (nvecs != __HFN_NUMINTS));\n\n\tbfa->msix.nvecs = nvecs;\n\tbfa_hwcb_msix_uninstall(bfa);\n}\n\nvoid\nbfa_hwcb_msix_ctrl_install(struct bfa_s *bfa)\n{\n\tint i;\n\n\tif (bfa->msix.nvecs == 0)\n\t\treturn;\n\n\tif (bfa->msix.nvecs == 1) {\n\t\tfor (i = BFI_MSIX_CPE_QMIN_CB; i < BFI_MSIX_CB_MAX; i++)\n\t\t\tbfa->msix.handler[i] = bfa_msix_all;\n\t\treturn;\n\t}\n\n\tfor (i = BFI_MSIX_RME_QMAX_CB+1; i < BFI_MSIX_CB_MAX; i++)\n\t\tbfa->msix.handler[i] = bfa_msix_lpu_err;\n}\n\nvoid\nbfa_hwcb_msix_queue_install(struct bfa_s *bfa)\n{\n\tint i;\n\n\tif (bfa->msix.nvecs == 0)\n\t\treturn;\n\n\tif (bfa->msix.nvecs == 1) {\n\t\tfor (i = BFI_MSIX_CPE_QMIN_CB; i <= BFI_MSIX_RME_QMAX_CB; i++)\n\t\t\tbfa->msix.handler[i] = bfa_msix_all;\n\t\treturn;\n\t}\n\n\tfor (i = BFI_MSIX_CPE_QMIN_CB; i <= BFI_MSIX_CPE_QMAX_CB; i++)\n\t\tbfa->msix.handler[i] = bfa_msix_reqq;\n\n\tfor (i = BFI_MSIX_RME_QMIN_CB; i <= BFI_MSIX_RME_QMAX_CB; i++)\n\t\tbfa->msix.handler[i] = bfa_msix_rspq;\n}\n\nvoid\nbfa_hwcb_msix_uninstall(struct bfa_s *bfa)\n{\n\tint i;\n\n\tfor (i = 0; i < BFI_MSIX_CB_MAX; i++)\n\t\tbfa->msix.handler[i] = bfa_hwcb_msix_dummy;\n}\n\n \nvoid\nbfa_hwcb_isr_mode_set(struct bfa_s *bfa, bfa_boolean_t msix)\n{\n\tif (msix) {\n\t\tbfa->iocfc.hwif.hw_reqq_ack = bfa_hwcb_reqq_ack_msix;\n\t\tbfa->iocfc.hwif.hw_rspq_ack = bfa_hwcb_rspq_ack_msix;\n\t} else {\n\t\tbfa->iocfc.hwif.hw_reqq_ack = NULL;\n\t\tbfa->iocfc.hwif.hw_rspq_ack = bfa_hwcb_rspq_ack;\n\t}\n}\n\nvoid\nbfa_hwcb_msix_get_rme_range(struct bfa_s *bfa, u32 *start, u32 *end)\n{\n\t*start = BFI_MSIX_RME_QMIN_CB;\n\t*end = BFI_MSIX_RME_QMAX_CB;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}