{
  "module_name": "bfa_fcpim.c",
  "hash_id": "7a7694aa2d69ee4b1ed6cc9ed0ed115933666b52280052fc9e455c3dde25249c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/bfa/bfa_fcpim.c",
  "human_readable_source": "\n \n\n#include \"bfad_drv.h\"\n#include \"bfa_modules.h\"\n\nBFA_TRC_FILE(HAL, FCPIM);\n\n \nstatic void bfa_itnim_update_del_itn_stats(struct bfa_itnim_s *itnim);\n\n#define BFA_ITNIM_FROM_TAG(_fcpim, _tag)                                \\\n\t(((_fcpim)->itnim_arr + ((_tag) & ((_fcpim)->num_itnims - 1))))\n\n#define bfa_fcpim_additn(__itnim)\t\t\t\t\t\\\n\tlist_add_tail(&(__itnim)->qe, &(__itnim)->fcpim->itnim_q)\n#define bfa_fcpim_delitn(__itnim)\tdo {\t\t\t\t\\\n\tWARN_ON(!bfa_q_is_on_q(&(__itnim)->fcpim->itnim_q, __itnim));   \\\n\tbfa_itnim_update_del_itn_stats(__itnim);      \\\n\tlist_del(&(__itnim)->qe);      \\\n\tWARN_ON(!list_empty(&(__itnim)->io_q));\t\t\t\t\\\n\tWARN_ON(!list_empty(&(__itnim)->io_cleanup_q));\t\t\t\\\n\tWARN_ON(!list_empty(&(__itnim)->pending_q));\t\t\t\\\n} while (0)\n\n#define bfa_itnim_online_cb(__itnim) do {\t\t\t\t\\\n\tif ((__itnim)->bfa->fcs)\t\t\t\t\t\\\n\t\tbfa_cb_itnim_online((__itnim)->ditn);      \\\n\telse {\t\t\t\t\t\t\t\t\\\n\t\tbfa_cb_queue((__itnim)->bfa, &(__itnim)->hcb_qe,\t\\\n\t\t__bfa_cb_itnim_online, (__itnim));      \\\n\t}\t\t\t\t\t\t\t\t\\\n} while (0)\n\n#define bfa_itnim_offline_cb(__itnim) do {\t\t\t\t\\\n\tif ((__itnim)->bfa->fcs)\t\t\t\t\t\\\n\t\tbfa_cb_itnim_offline((__itnim)->ditn);      \\\n\telse {\t\t\t\t\t\t\t\t\\\n\t\tbfa_cb_queue((__itnim)->bfa, &(__itnim)->hcb_qe,\t\\\n\t\t__bfa_cb_itnim_offline, (__itnim));      \\\n\t}\t\t\t\t\t\t\t\t\\\n} while (0)\n\n#define bfa_itnim_sler_cb(__itnim) do {\t\t\t\t\t\\\n\tif ((__itnim)->bfa->fcs)\t\t\t\t\t\\\n\t\tbfa_cb_itnim_sler((__itnim)->ditn);      \\\n\telse {\t\t\t\t\t\t\t\t\\\n\t\tbfa_cb_queue((__itnim)->bfa, &(__itnim)->hcb_qe,\t\\\n\t\t__bfa_cb_itnim_sler, (__itnim));      \\\n\t}\t\t\t\t\t\t\t\t\\\n} while (0)\n\nenum bfa_ioim_lm_ua_status {\n\tBFA_IOIM_LM_UA_RESET = 0,\n\tBFA_IOIM_LM_UA_SET = 1,\n};\n\n \nenum bfa_itnim_event {\n\tBFA_ITNIM_SM_CREATE = 1,\t \n\tBFA_ITNIM_SM_ONLINE = 2,\t \n\tBFA_ITNIM_SM_OFFLINE = 3,\t \n\tBFA_ITNIM_SM_FWRSP = 4,\t\t \n\tBFA_ITNIM_SM_DELETE = 5,\t \n\tBFA_ITNIM_SM_CLEANUP = 6,\t \n\tBFA_ITNIM_SM_SLER = 7,\t\t \n\tBFA_ITNIM_SM_HWFAIL = 8,\t \n\tBFA_ITNIM_SM_QRESUME = 9,\t \n};\n\n \n#define bfa_ioim_move_to_comp_q(__ioim) do {\t\t\t\t\\\n\tlist_del(&(__ioim)->qe);\t\t\t\t\t\\\n\tlist_add_tail(&(__ioim)->qe, &(__ioim)->fcpim->ioim_comp_q);\t\\\n} while (0)\n\n\n#define bfa_ioim_cb_profile_comp(__fcpim, __ioim) do {\t\t\t\\\n\tif ((__fcpim)->profile_comp)\t\t\t\t\t\\\n\t\t(__fcpim)->profile_comp(__ioim);\t\t\t\\\n} while (0)\n\n#define bfa_ioim_cb_profile_start(__fcpim, __ioim) do {\t\t\t\\\n\tif ((__fcpim)->profile_start)\t\t\t\t\t\\\n\t\t(__fcpim)->profile_start(__ioim);\t\t\t\\\n} while (0)\n\n \nenum bfa_ioim_event {\n\tBFA_IOIM_SM_START\t= 1,\t \n\tBFA_IOIM_SM_COMP_GOOD\t= 2,\t \n\tBFA_IOIM_SM_COMP\t= 3,\t \n\tBFA_IOIM_SM_COMP_UTAG\t= 4,\t \n\tBFA_IOIM_SM_DONE\t= 5,\t \n\tBFA_IOIM_SM_FREE\t= 6,\t \n\tBFA_IOIM_SM_ABORT\t= 7,\t \n\tBFA_IOIM_SM_ABORT_COMP\t= 8,\t \n\tBFA_IOIM_SM_ABORT_DONE\t= 9,\t \n\tBFA_IOIM_SM_QRESUME\t= 10,\t \n\tBFA_IOIM_SM_SGALLOCED\t= 11,\t \n\tBFA_IOIM_SM_SQRETRY\t= 12,\t \n\tBFA_IOIM_SM_HCB\t\t= 13,\t \n\tBFA_IOIM_SM_CLEANUP\t= 14,\t \n\tBFA_IOIM_SM_TMSTART\t= 15,\t \n\tBFA_IOIM_SM_TMDONE\t= 16,\t \n\tBFA_IOIM_SM_HWFAIL\t= 17,\t \n\tBFA_IOIM_SM_IOTOV\t= 18,\t \n};\n\n\n \n\n \n#define bfa_tskim_qcomp(__tskim, __cbfn) do {\t\t\t\t\\\n\tbfa_cb_queue((__tskim)->bfa, &(__tskim)->hcb_qe, __cbfn, (__tskim));\\\n\tbfa_tskim_notify_comp(__tskim);      \\\n} while (0)\n\n#define bfa_tskim_notify_comp(__tskim) do {\t\t\t\t\\\n\tif ((__tskim)->notify)\t\t\t\t\t\t\\\n\t\tbfa_itnim_tskdone((__tskim)->itnim);      \\\n} while (0)\n\n\nenum bfa_tskim_event {\n\tBFA_TSKIM_SM_START\t= 1,\t \n\tBFA_TSKIM_SM_DONE\t= 2,\t \n\tBFA_TSKIM_SM_QRESUME\t= 3,\t \n\tBFA_TSKIM_SM_HWFAIL\t= 5,\t \n\tBFA_TSKIM_SM_HCB\t= 6,\t \n\tBFA_TSKIM_SM_IOS_DONE\t= 7,\t \n\tBFA_TSKIM_SM_CLEANUP\t= 8,\t \n\tBFA_TSKIM_SM_CLEANUP_DONE = 9,\t \n\tBFA_TSKIM_SM_UTAG\t= 10,\t \n};\n\n \nstatic void     bfa_itnim_iocdisable_cleanup(struct bfa_itnim_s *itnim);\nstatic bfa_boolean_t bfa_itnim_send_fwcreate(struct bfa_itnim_s *itnim);\nstatic bfa_boolean_t bfa_itnim_send_fwdelete(struct bfa_itnim_s *itnim);\nstatic void     bfa_itnim_cleanp_comp(void *itnim_cbarg);\nstatic void     bfa_itnim_cleanup(struct bfa_itnim_s *itnim);\nstatic void     __bfa_cb_itnim_online(void *cbarg, bfa_boolean_t complete);\nstatic void     __bfa_cb_itnim_offline(void *cbarg, bfa_boolean_t complete);\nstatic void     __bfa_cb_itnim_sler(void *cbarg, bfa_boolean_t complete);\nstatic void     bfa_itnim_iotov_online(struct bfa_itnim_s *itnim);\nstatic void     bfa_itnim_iotov_cleanup(struct bfa_itnim_s *itnim);\nstatic void     bfa_itnim_iotov(void *itnim_arg);\nstatic void     bfa_itnim_iotov_start(struct bfa_itnim_s *itnim);\nstatic void     bfa_itnim_iotov_stop(struct bfa_itnim_s *itnim);\nstatic void     bfa_itnim_iotov_delete(struct bfa_itnim_s *itnim);\n\n \nstatic void     bfa_itnim_sm_uninit(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_created(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_fwcreate(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_delete_pending(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_online(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_sler(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_cleanup_offline(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_cleanup_delete(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_fwdelete(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_offline(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_iocdisable(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_deleting(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_fwcreate_qfull(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_fwdelete_qfull(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\nstatic void     bfa_itnim_sm_deleting_qfull(struct bfa_itnim_s *itnim,\n\t\t\t\t\tenum bfa_itnim_event event);\n\n \nstatic bfa_boolean_t\tbfa_ioim_send_ioreq(struct bfa_ioim_s *ioim);\nstatic bfa_boolean_t\tbfa_ioim_sgpg_alloc(struct bfa_ioim_s *ioim);\nstatic bfa_boolean_t\tbfa_ioim_send_abort(struct bfa_ioim_s *ioim);\nstatic void\t\tbfa_ioim_notify_cleanup(struct bfa_ioim_s *ioim);\nstatic void __bfa_cb_ioim_good_comp(void *cbarg, bfa_boolean_t complete);\nstatic void __bfa_cb_ioim_comp(void *cbarg, bfa_boolean_t complete);\nstatic void __bfa_cb_ioim_abort(void *cbarg, bfa_boolean_t complete);\nstatic void __bfa_cb_ioim_failed(void *cbarg, bfa_boolean_t complete);\nstatic void __bfa_cb_ioim_pathtov(void *cbarg, bfa_boolean_t complete);\nstatic bfa_boolean_t    bfa_ioim_is_abortable(struct bfa_ioim_s *ioim);\n\n \nstatic void     bfa_ioim_sm_uninit(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_sgalloc(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_active(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_abort(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_cleanup(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_qfull(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_abort_qfull(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_cleanup_qfull(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_hcb(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_hcb_free(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void     bfa_ioim_sm_resfree(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\nstatic void\tbfa_ioim_sm_cmnd_retry(struct bfa_ioim_s *ioim,\n\t\t\t\t\tenum bfa_ioim_event event);\n \nstatic void     __bfa_cb_tskim_done(void *cbarg, bfa_boolean_t complete);\nstatic void     __bfa_cb_tskim_failed(void *cbarg, bfa_boolean_t complete);\nstatic bfa_boolean_t bfa_tskim_match_scope(struct bfa_tskim_s *tskim,\n\t\t\t\t\tstruct scsi_lun lun);\nstatic void     bfa_tskim_gather_ios(struct bfa_tskim_s *tskim);\nstatic void     bfa_tskim_cleanp_comp(void *tskim_cbarg);\nstatic void     bfa_tskim_cleanup_ios(struct bfa_tskim_s *tskim);\nstatic bfa_boolean_t bfa_tskim_send(struct bfa_tskim_s *tskim);\nstatic bfa_boolean_t bfa_tskim_send_abort(struct bfa_tskim_s *tskim);\nstatic void     bfa_tskim_iocdisable_ios(struct bfa_tskim_s *tskim);\n\n \nstatic void     bfa_tskim_sm_uninit(struct bfa_tskim_s *tskim,\n\t\t\t\t\tenum bfa_tskim_event event);\nstatic void     bfa_tskim_sm_active(struct bfa_tskim_s *tskim,\n\t\t\t\t\tenum bfa_tskim_event event);\nstatic void     bfa_tskim_sm_cleanup(struct bfa_tskim_s *tskim,\n\t\t\t\t\tenum bfa_tskim_event event);\nstatic void     bfa_tskim_sm_iocleanup(struct bfa_tskim_s *tskim,\n\t\t\t\t\tenum bfa_tskim_event event);\nstatic void     bfa_tskim_sm_qfull(struct bfa_tskim_s *tskim,\n\t\t\t\t\tenum bfa_tskim_event event);\nstatic void     bfa_tskim_sm_cleanup_qfull(struct bfa_tskim_s *tskim,\n\t\t\t\t\tenum bfa_tskim_event event);\nstatic void     bfa_tskim_sm_hcb(struct bfa_tskim_s *tskim,\n\t\t\t\t\tenum bfa_tskim_event event);\n \n\n \nstatic void\nbfa_fcpim_meminfo(struct bfa_iocfc_cfg_s *cfg, u32 *km_len)\n{\n\tbfa_itnim_meminfo(cfg, km_len);\n\n\t \n\t*km_len += cfg->fwcfg.num_ioim_reqs *\n\t  (sizeof(struct bfa_ioim_s) + sizeof(struct bfa_ioim_sp_s));\n\n\t \n\tif (cfg->fwcfg.num_tskim_reqs < BFA_TSKIM_MIN)\n\t\tcfg->fwcfg.num_tskim_reqs = BFA_TSKIM_MIN;\n\t*km_len += cfg->fwcfg.num_tskim_reqs * sizeof(struct bfa_tskim_s);\n}\n\n\nstatic void\nbfa_fcpim_attach(struct bfa_fcp_mod_s *fcp, void *bfad,\n\t\tstruct bfa_iocfc_cfg_s *cfg, struct bfa_pcidev_s *pcidev)\n{\n\tstruct bfa_fcpim_s *fcpim = &fcp->fcpim;\n\tstruct bfa_s *bfa = fcp->bfa;\n\n\tbfa_trc(bfa, cfg->drvcfg.path_tov);\n\tbfa_trc(bfa, cfg->fwcfg.num_rports);\n\tbfa_trc(bfa, cfg->fwcfg.num_ioim_reqs);\n\tbfa_trc(bfa, cfg->fwcfg.num_tskim_reqs);\n\n\tfcpim->fcp\t\t= fcp;\n\tfcpim->bfa\t\t= bfa;\n\tfcpim->num_itnims\t= cfg->fwcfg.num_rports;\n\tfcpim->num_tskim_reqs = cfg->fwcfg.num_tskim_reqs;\n\tfcpim->path_tov\t\t= cfg->drvcfg.path_tov;\n\tfcpim->delay_comp\t= cfg->drvcfg.delay_comp;\n\tfcpim->profile_comp = NULL;\n\tfcpim->profile_start = NULL;\n\n\tbfa_itnim_attach(fcpim);\n\tbfa_tskim_attach(fcpim);\n\tbfa_ioim_attach(fcpim);\n}\n\nvoid\nbfa_fcpim_iocdisable(struct bfa_fcp_mod_s *fcp)\n{\n\tstruct bfa_fcpim_s *fcpim = &fcp->fcpim;\n\tstruct bfa_itnim_s *itnim;\n\tstruct list_head *qe, *qen;\n\n\t \n\tlist_splice_tail_init(&fcpim->tskim_unused_q, &fcpim->tskim_free_q);\n\n\tlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\n\t\titnim = (struct bfa_itnim_s *) qe;\n\t\tbfa_itnim_iocdisable(itnim);\n\t}\n}\n\nvoid\nbfa_fcpim_path_tov_set(struct bfa_s *bfa, u16 path_tov)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\n\tfcpim->path_tov = path_tov * 1000;\n\tif (fcpim->path_tov > BFA_FCPIM_PATHTOV_MAX)\n\t\tfcpim->path_tov = BFA_FCPIM_PATHTOV_MAX;\n}\n\nu16\nbfa_fcpim_path_tov_get(struct bfa_s *bfa)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\n\treturn fcpim->path_tov / 1000;\n}\n\n#define bfa_fcpim_add_iostats(__l, __r, __stats)\t\\\n\t(__l->__stats += __r->__stats)\n\nvoid\nbfa_fcpim_add_stats(struct bfa_itnim_iostats_s *lstats,\n\t\tstruct bfa_itnim_iostats_s *rstats)\n{\n\tbfa_fcpim_add_iostats(lstats, rstats, total_ios);\n\tbfa_fcpim_add_iostats(lstats, rstats, qresumes);\n\tbfa_fcpim_add_iostats(lstats, rstats, no_iotags);\n\tbfa_fcpim_add_iostats(lstats, rstats, io_aborts);\n\tbfa_fcpim_add_iostats(lstats, rstats, no_tskims);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocomp_ok);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocomp_underrun);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocomp_overrun);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocomp_aborted);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocomp_timedout);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocom_nexus_abort);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocom_proto_err);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocom_dif_err);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocom_sqer_needed);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocom_res_free);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocom_hostabrts);\n\tbfa_fcpim_add_iostats(lstats, rstats, iocom_utags);\n\tbfa_fcpim_add_iostats(lstats, rstats, io_cleanups);\n\tbfa_fcpim_add_iostats(lstats, rstats, io_tmaborts);\n\tbfa_fcpim_add_iostats(lstats, rstats, onlines);\n\tbfa_fcpim_add_iostats(lstats, rstats, offlines);\n\tbfa_fcpim_add_iostats(lstats, rstats, creates);\n\tbfa_fcpim_add_iostats(lstats, rstats, deletes);\n\tbfa_fcpim_add_iostats(lstats, rstats, create_comps);\n\tbfa_fcpim_add_iostats(lstats, rstats, delete_comps);\n\tbfa_fcpim_add_iostats(lstats, rstats, sler_events);\n\tbfa_fcpim_add_iostats(lstats, rstats, fw_create);\n\tbfa_fcpim_add_iostats(lstats, rstats, fw_delete);\n\tbfa_fcpim_add_iostats(lstats, rstats, ioc_disabled);\n\tbfa_fcpim_add_iostats(lstats, rstats, cleanup_comps);\n\tbfa_fcpim_add_iostats(lstats, rstats, tm_cmnds);\n\tbfa_fcpim_add_iostats(lstats, rstats, tm_fw_rsps);\n\tbfa_fcpim_add_iostats(lstats, rstats, tm_success);\n\tbfa_fcpim_add_iostats(lstats, rstats, tm_failures);\n\tbfa_fcpim_add_iostats(lstats, rstats, tm_io_comps);\n\tbfa_fcpim_add_iostats(lstats, rstats, tm_qresumes);\n\tbfa_fcpim_add_iostats(lstats, rstats, tm_iocdowns);\n\tbfa_fcpim_add_iostats(lstats, rstats, tm_cleanups);\n\tbfa_fcpim_add_iostats(lstats, rstats, tm_cleanup_comps);\n\tbfa_fcpim_add_iostats(lstats, rstats, io_comps);\n\tbfa_fcpim_add_iostats(lstats, rstats, input_reqs);\n\tbfa_fcpim_add_iostats(lstats, rstats, output_reqs);\n\tbfa_fcpim_add_iostats(lstats, rstats, rd_throughput);\n\tbfa_fcpim_add_iostats(lstats, rstats, wr_throughput);\n}\n\nbfa_status_t\nbfa_fcpim_port_iostats(struct bfa_s *bfa,\n\t\tstruct bfa_itnim_iostats_s *stats, u8 lp_tag)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tstruct list_head *qe, *qen;\n\tstruct bfa_itnim_s *itnim;\n\n\t \n\tmemset(stats, 0, sizeof(struct bfa_itnim_iostats_s));\n\tlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\n\t\titnim = (struct bfa_itnim_s *) qe;\n\t\tif (itnim->rport->rport_info.lp_tag != lp_tag)\n\t\t\tcontinue;\n\t\tbfa_fcpim_add_stats(stats, &(itnim->stats));\n\t}\n\treturn BFA_STATUS_OK;\n}\n\nstatic void\nbfa_ioim_profile_comp(struct bfa_ioim_s *ioim)\n{\n\tstruct bfa_itnim_latency_s *io_lat =\n\t\t\t&(ioim->itnim->ioprofile.io_latency);\n\tu32 val, idx;\n\n\tval = (u32)(jiffies - ioim->start_time);\n\tidx = bfa_ioim_get_index(scsi_bufflen((struct scsi_cmnd *)ioim->dio));\n\tbfa_itnim_ioprofile_update(ioim->itnim, idx);\n\n\tio_lat->count[idx]++;\n\tio_lat->min[idx] = (io_lat->min[idx] < val) ? io_lat->min[idx] : val;\n\tio_lat->max[idx] = (io_lat->max[idx] > val) ? io_lat->max[idx] : val;\n\tio_lat->avg[idx] += val;\n}\n\nstatic void\nbfa_ioim_profile_start(struct bfa_ioim_s *ioim)\n{\n\tioim->start_time = jiffies;\n}\n\nbfa_status_t\nbfa_fcpim_profile_on(struct bfa_s *bfa, time64_t time)\n{\n\tstruct bfa_itnim_s *itnim;\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tstruct list_head *qe, *qen;\n\n\t \n\tlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\n\t\titnim = (struct bfa_itnim_s *) qe;\n\t\tbfa_itnim_clear_stats(itnim);\n\t}\n\tfcpim->io_profile = BFA_TRUE;\n\tfcpim->io_profile_start_time = time;\n\tfcpim->profile_comp = bfa_ioim_profile_comp;\n\tfcpim->profile_start = bfa_ioim_profile_start;\n\treturn BFA_STATUS_OK;\n}\n\nbfa_status_t\nbfa_fcpim_profile_off(struct bfa_s *bfa)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tfcpim->io_profile = BFA_FALSE;\n\tfcpim->io_profile_start_time = 0;\n\tfcpim->profile_comp = NULL;\n\tfcpim->profile_start = NULL;\n\treturn BFA_STATUS_OK;\n}\n\nu16\nbfa_fcpim_qdepth_get(struct bfa_s *bfa)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\n\treturn fcpim->q_depth;\n}\n\n \n\n \nstatic void\nbfa_itnim_sm_uninit(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_CREATE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_created);\n\t\titnim->is_online = BFA_FALSE;\n\t\tbfa_fcpim_additn(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_created(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_ONLINE:\n\t\tif (bfa_itnim_send_fwcreate(itnim))\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate);\n\t\telse\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate_qfull);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\n\t\tbfa_fcpim_delitn(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_fwcreate(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_FWRSP:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_online);\n\t\titnim->is_online = BFA_TRUE;\n\t\tbfa_itnim_iotov_online(itnim);\n\t\tbfa_itnim_online_cb(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_delete_pending);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_OFFLINE:\n\t\tif (bfa_itnim_send_fwdelete(itnim))\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete);\n\t\telse\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete_qfull);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\nstatic void\nbfa_itnim_sm_fwcreate_qfull(struct bfa_itnim_s *itnim,\n\t\t\tenum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_QRESUME:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate);\n\t\tbfa_itnim_send_fwcreate(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\n\t\tbfa_reqq_wcancel(&itnim->reqq_wait);\n\t\tbfa_fcpim_delitn(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_offline);\n\t\tbfa_reqq_wcancel(&itnim->reqq_wait);\n\t\tbfa_itnim_offline_cb(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\tbfa_reqq_wcancel(&itnim->reqq_wait);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_delete_pending(struct bfa_itnim_s *itnim,\n\t\t\t\tenum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_FWRSP:\n\t\tif (bfa_itnim_send_fwdelete(itnim))\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_deleting);\n\t\telse\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_deleting_qfull);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\n\t\tbfa_fcpim_delitn(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_online(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_offline);\n\t\titnim->is_online = BFA_FALSE;\n\t\tbfa_itnim_iotov_start(itnim);\n\t\tbfa_itnim_cleanup(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_delete);\n\t\titnim->is_online = BFA_FALSE;\n\t\tbfa_itnim_cleanup(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_SLER:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_sler);\n\t\titnim->is_online = BFA_FALSE;\n\t\tbfa_itnim_iotov_start(itnim);\n\t\tbfa_itnim_sler_cb(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\titnim->is_online = BFA_FALSE;\n\t\tbfa_itnim_iotov_start(itnim);\n\t\tbfa_itnim_iocdisable_cleanup(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_sler(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_offline);\n\t\tbfa_itnim_cleanup(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_delete);\n\t\tbfa_itnim_cleanup(itnim);\n\t\tbfa_itnim_iotov_delete(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\tbfa_itnim_iocdisable_cleanup(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_cleanup_offline(struct bfa_itnim_s *itnim,\n\t\t\t\t enum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_CLEANUP:\n\t\tif (bfa_itnim_send_fwdelete(itnim))\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete);\n\t\telse\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete_qfull);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_cleanup_delete);\n\t\tbfa_itnim_iotov_delete(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\tbfa_itnim_iocdisable_cleanup(itnim);\n\t\tbfa_itnim_offline_cb(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_SLER:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_cleanup_delete(struct bfa_itnim_s *itnim,\n\t\t\t\tenum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_CLEANUP:\n\t\tif (bfa_itnim_send_fwdelete(itnim))\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_deleting);\n\t\telse\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_deleting_qfull);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\tbfa_itnim_iocdisable_cleanup(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_fwdelete(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_FWRSP:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_offline);\n\t\tbfa_itnim_offline_cb(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_deleting);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\tbfa_itnim_offline_cb(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\nstatic void\nbfa_itnim_sm_fwdelete_qfull(struct bfa_itnim_s *itnim,\n\t\t\tenum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_QRESUME:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwdelete);\n\t\tbfa_itnim_send_fwdelete(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_deleting_qfull);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\tbfa_reqq_wcancel(&itnim->reqq_wait);\n\t\tbfa_itnim_offline_cb(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_offline(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\n\t\tbfa_itnim_iotov_delete(itnim);\n\t\tbfa_fcpim_delitn(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_ONLINE:\n\t\tif (bfa_itnim_send_fwcreate(itnim))\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate);\n\t\telse\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate_qfull);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_iocdisable);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\nstatic void\nbfa_itnim_sm_iocdisable(struct bfa_itnim_s *itnim,\n\t\t\t\tenum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\n\t\tbfa_itnim_iotov_delete(itnim);\n\t\tbfa_fcpim_delitn(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_OFFLINE:\n\t\tbfa_itnim_offline_cb(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_ONLINE:\n\t\tif (bfa_itnim_send_fwcreate(itnim))\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate);\n\t\telse\n\t\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_fwcreate_qfull);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_sm_deleting(struct bfa_itnim_s *itnim, enum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_FWRSP:\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\n\t\tbfa_fcpim_delitn(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\nstatic void\nbfa_itnim_sm_deleting_qfull(struct bfa_itnim_s *itnim,\n\t\tenum bfa_itnim_event event)\n{\n\tbfa_trc(itnim->bfa, itnim->rport->rport_tag);\n\tbfa_trc(itnim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_ITNIM_SM_QRESUME:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_deleting);\n\t\tbfa_itnim_send_fwdelete(itnim);\n\t\tbreak;\n\n\tcase BFA_ITNIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\n\t\tbfa_reqq_wcancel(&itnim->reqq_wait);\n\t\tbfa_fcpim_delitn(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_itnim_iocdisable_cleanup(struct bfa_itnim_s *itnim)\n{\n\tstruct bfa_tskim_s *tskim;\n\tstruct bfa_ioim_s *ioim;\n\tstruct list_head\t*qe, *qen;\n\n\tlist_for_each_safe(qe, qen, &itnim->tsk_q) {\n\t\ttskim = (struct bfa_tskim_s *) qe;\n\t\tbfa_tskim_iocdisable(tskim);\n\t}\n\n\tlist_for_each_safe(qe, qen, &itnim->io_q) {\n\t\tioim = (struct bfa_ioim_s *) qe;\n\t\tbfa_ioim_iocdisable(ioim);\n\t}\n\n\t \n\tlist_for_each_safe(qe, qen, &itnim->pending_q) {\n\t\tioim = (struct bfa_ioim_s *) qe;\n\t\tbfa_ioim_tov(ioim);\n\t}\n\n\tlist_for_each_safe(qe, qen, &itnim->io_cleanup_q) {\n\t\tioim = (struct bfa_ioim_s *) qe;\n\t\tbfa_ioim_iocdisable(ioim);\n\t}\n}\n\n \nstatic void\nbfa_itnim_cleanp_comp(void *itnim_cbarg)\n{\n\tstruct bfa_itnim_s *itnim = itnim_cbarg;\n\n\tbfa_stats(itnim, cleanup_comps);\n\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_CLEANUP);\n}\n\n \nstatic void\nbfa_itnim_cleanup(struct bfa_itnim_s *itnim)\n{\n\tstruct bfa_ioim_s  *ioim;\n\tstruct bfa_tskim_s *tskim;\n\tstruct list_head\t*qe, *qen;\n\n\tbfa_wc_init(&itnim->wc, bfa_itnim_cleanp_comp, itnim);\n\n\tlist_for_each_safe(qe, qen, &itnim->io_q) {\n\t\tioim = (struct bfa_ioim_s *) qe;\n\n\t\t \n\t\tlist_del(&ioim->qe);\n\t\tlist_add_tail(&ioim->qe, &itnim->io_cleanup_q);\n\n\t\tbfa_wc_up(&itnim->wc);\n\t\tbfa_ioim_cleanup(ioim);\n\t}\n\n\tlist_for_each_safe(qe, qen, &itnim->tsk_q) {\n\t\ttskim = (struct bfa_tskim_s *) qe;\n\t\tbfa_wc_up(&itnim->wc);\n\t\tbfa_tskim_cleanup(tskim);\n\t}\n\n\tbfa_wc_wait(&itnim->wc);\n}\n\nstatic void\n__bfa_cb_itnim_online(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_itnim_s *itnim = cbarg;\n\n\tif (complete)\n\t\tbfa_cb_itnim_online(itnim->ditn);\n}\n\nstatic void\n__bfa_cb_itnim_offline(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_itnim_s *itnim = cbarg;\n\n\tif (complete)\n\t\tbfa_cb_itnim_offline(itnim->ditn);\n}\n\nstatic void\n__bfa_cb_itnim_sler(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_itnim_s *itnim = cbarg;\n\n\tif (complete)\n\t\tbfa_cb_itnim_sler(itnim->ditn);\n}\n\n \nstatic void\nbfa_itnim_qresume(void *cbarg)\n{\n\tstruct bfa_itnim_s *itnim = cbarg;\n\n\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_QRESUME);\n}\n\n \n\nvoid\nbfa_itnim_iodone(struct bfa_itnim_s *itnim)\n{\n\tbfa_wc_down(&itnim->wc);\n}\n\nvoid\nbfa_itnim_tskdone(struct bfa_itnim_s *itnim)\n{\n\tbfa_wc_down(&itnim->wc);\n}\n\nvoid\nbfa_itnim_meminfo(struct bfa_iocfc_cfg_s *cfg, u32 *km_len)\n{\n\t \n\t*km_len += cfg->fwcfg.num_rports * sizeof(struct bfa_itnim_s);\n}\n\nvoid\nbfa_itnim_attach(struct bfa_fcpim_s *fcpim)\n{\n\tstruct bfa_s\t*bfa = fcpim->bfa;\n\tstruct bfa_fcp_mod_s\t*fcp = fcpim->fcp;\n\tstruct bfa_itnim_s *itnim;\n\tint\ti, j;\n\n\tINIT_LIST_HEAD(&fcpim->itnim_q);\n\n\titnim = (struct bfa_itnim_s *) bfa_mem_kva_curp(fcp);\n\tfcpim->itnim_arr = itnim;\n\n\tfor (i = 0; i < fcpim->num_itnims; i++, itnim++) {\n\t\tmemset(itnim, 0, sizeof(struct bfa_itnim_s));\n\t\titnim->bfa = bfa;\n\t\titnim->fcpim = fcpim;\n\t\titnim->reqq = BFA_REQQ_QOS_LO;\n\t\titnim->rport = BFA_RPORT_FROM_TAG(bfa, i);\n\t\titnim->iotov_active = BFA_FALSE;\n\t\tbfa_reqq_winit(&itnim->reqq_wait, bfa_itnim_qresume, itnim);\n\n\t\tINIT_LIST_HEAD(&itnim->io_q);\n\t\tINIT_LIST_HEAD(&itnim->io_cleanup_q);\n\t\tINIT_LIST_HEAD(&itnim->pending_q);\n\t\tINIT_LIST_HEAD(&itnim->tsk_q);\n\t\tINIT_LIST_HEAD(&itnim->delay_comp_q);\n\t\tfor (j = 0; j < BFA_IOBUCKET_MAX; j++)\n\t\t\titnim->ioprofile.io_latency.min[j] = ~0;\n\t\tbfa_sm_set_state(itnim, bfa_itnim_sm_uninit);\n\t}\n\n\tbfa_mem_kva_curp(fcp) = (u8 *) itnim;\n}\n\nvoid\nbfa_itnim_iocdisable(struct bfa_itnim_s *itnim)\n{\n\tbfa_stats(itnim, ioc_disabled);\n\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_HWFAIL);\n}\n\nstatic bfa_boolean_t\nbfa_itnim_send_fwcreate(struct bfa_itnim_s *itnim)\n{\n\tstruct bfi_itn_create_req_s *m;\n\n\titnim->msg_no++;\n\n\t \n\tm = bfa_reqq_next(itnim->bfa, itnim->reqq);\n\tif (!m) {\n\t\tbfa_reqq_wait(itnim->bfa, itnim->reqq, &itnim->reqq_wait);\n\t\treturn BFA_FALSE;\n\t}\n\n\tbfi_h2i_set(m->mh, BFI_MC_ITN, BFI_ITN_H2I_CREATE_REQ,\n\t\t\tbfa_fn_lpu(itnim->bfa));\n\tm->fw_handle = itnim->rport->fw_handle;\n\tm->class = FC_CLASS_3;\n\tm->seq_rec = itnim->seq_rec;\n\tm->msg_no = itnim->msg_no;\n\tbfa_stats(itnim, fw_create);\n\n\t \n\tbfa_reqq_produce(itnim->bfa, itnim->reqq, m->mh);\n\treturn BFA_TRUE;\n}\n\nstatic bfa_boolean_t\nbfa_itnim_send_fwdelete(struct bfa_itnim_s *itnim)\n{\n\tstruct bfi_itn_delete_req_s *m;\n\n\t \n\tm = bfa_reqq_next(itnim->bfa, itnim->reqq);\n\tif (!m) {\n\t\tbfa_reqq_wait(itnim->bfa, itnim->reqq, &itnim->reqq_wait);\n\t\treturn BFA_FALSE;\n\t}\n\n\tbfi_h2i_set(m->mh, BFI_MC_ITN, BFI_ITN_H2I_DELETE_REQ,\n\t\t\tbfa_fn_lpu(itnim->bfa));\n\tm->fw_handle = itnim->rport->fw_handle;\n\tbfa_stats(itnim, fw_delete);\n\n\t \n\tbfa_reqq_produce(itnim->bfa, itnim->reqq, m->mh);\n\treturn BFA_TRUE;\n}\n\n \nstatic void\nbfa_itnim_delayed_comp(struct bfa_itnim_s *itnim, bfa_boolean_t iotov)\n{\n\tstruct bfa_ioim_s *ioim;\n\tstruct list_head *qe, *qen;\n\n\tlist_for_each_safe(qe, qen, &itnim->delay_comp_q) {\n\t\tioim = (struct bfa_ioim_s *)qe;\n\t\tbfa_ioim_delayed_comp(ioim, iotov);\n\t}\n}\n\n \nstatic void\nbfa_itnim_iotov_online(struct bfa_itnim_s *itnim)\n{\n\tstruct bfa_ioim_s *ioim;\n\n\tbfa_itnim_iotov_stop(itnim);\n\n\t \n\tbfa_itnim_delayed_comp(itnim, BFA_FALSE);\n\n\t \n\twhile (!list_empty(&itnim->pending_q)) {\n\t\tbfa_q_deq(&itnim->pending_q, &ioim);\n\t\tlist_add_tail(&ioim->qe, &itnim->io_q);\n\t\tbfa_ioim_start(ioim);\n\t}\n}\n\n \nstatic void\nbfa_itnim_iotov_cleanup(struct bfa_itnim_s *itnim)\n{\n\tstruct bfa_ioim_s *ioim;\n\n\t \n\tbfa_itnim_delayed_comp(itnim, BFA_TRUE);\n\n\t \n\twhile (!list_empty(&itnim->pending_q)) {\n\t\tbfa_q_deq(&itnim->pending_q, &ioim);\n\t\tlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_comp_q);\n\t\tbfa_ioim_tov(ioim);\n\t}\n}\n\n \nstatic void\nbfa_itnim_iotov(void *itnim_arg)\n{\n\tstruct bfa_itnim_s *itnim = itnim_arg;\n\n\titnim->iotov_active = BFA_FALSE;\n\n\tbfa_cb_itnim_tov_begin(itnim->ditn);\n\tbfa_itnim_iotov_cleanup(itnim);\n\tbfa_cb_itnim_tov(itnim->ditn);\n}\n\n \nstatic void\nbfa_itnim_iotov_start(struct bfa_itnim_s *itnim)\n{\n\tif (itnim->fcpim->path_tov > 0) {\n\n\t\titnim->iotov_active = BFA_TRUE;\n\t\tWARN_ON(!bfa_itnim_hold_io(itnim));\n\t\tbfa_timer_start(itnim->bfa, &itnim->timer,\n\t\t\tbfa_itnim_iotov, itnim, itnim->fcpim->path_tov);\n\t}\n}\n\n \nstatic void\nbfa_itnim_iotov_stop(struct bfa_itnim_s *itnim)\n{\n\tif (itnim->iotov_active) {\n\t\titnim->iotov_active = BFA_FALSE;\n\t\tbfa_timer_stop(&itnim->timer);\n\t}\n}\n\n \nstatic void\nbfa_itnim_iotov_delete(struct bfa_itnim_s *itnim)\n{\n\tbfa_boolean_t pathtov_active = BFA_FALSE;\n\n\tif (itnim->iotov_active)\n\t\tpathtov_active = BFA_TRUE;\n\n\tbfa_itnim_iotov_stop(itnim);\n\tif (pathtov_active)\n\t\tbfa_cb_itnim_tov_begin(itnim->ditn);\n\tbfa_itnim_iotov_cleanup(itnim);\n\tif (pathtov_active)\n\t\tbfa_cb_itnim_tov(itnim->ditn);\n}\n\nstatic void\nbfa_itnim_update_del_itn_stats(struct bfa_itnim_s *itnim)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(itnim->bfa);\n\tfcpim->del_itn_stats.del_itn_iocomp_aborted +=\n\t\titnim->stats.iocomp_aborted;\n\tfcpim->del_itn_stats.del_itn_iocomp_timedout +=\n\t\titnim->stats.iocomp_timedout;\n\tfcpim->del_itn_stats.del_itn_iocom_sqer_needed +=\n\t\titnim->stats.iocom_sqer_needed;\n\tfcpim->del_itn_stats.del_itn_iocom_res_free +=\n\t\titnim->stats.iocom_res_free;\n\tfcpim->del_itn_stats.del_itn_iocom_hostabrts +=\n\t\titnim->stats.iocom_hostabrts;\n\tfcpim->del_itn_stats.del_itn_total_ios += itnim->stats.total_ios;\n\tfcpim->del_itn_stats.del_io_iocdowns += itnim->stats.io_iocdowns;\n\tfcpim->del_itn_stats.del_tm_iocdowns += itnim->stats.tm_iocdowns;\n}\n\n \n\n \nvoid\nbfa_itnim_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tunion bfi_itn_i2h_msg_u msg;\n\tstruct bfa_itnim_s *itnim;\n\n\tbfa_trc(bfa, m->mhdr.msg_id);\n\n\tmsg.msg = m;\n\n\tswitch (m->mhdr.msg_id) {\n\tcase BFI_ITN_I2H_CREATE_RSP:\n\t\titnim = BFA_ITNIM_FROM_TAG(fcpim,\n\t\t\t\t\t\tmsg.create_rsp->bfa_handle);\n\t\tWARN_ON(msg.create_rsp->status != BFA_STATUS_OK);\n\t\tbfa_stats(itnim, create_comps);\n\t\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_FWRSP);\n\t\tbreak;\n\n\tcase BFI_ITN_I2H_DELETE_RSP:\n\t\titnim = BFA_ITNIM_FROM_TAG(fcpim,\n\t\t\t\t\t\tmsg.delete_rsp->bfa_handle);\n\t\tWARN_ON(msg.delete_rsp->status != BFA_STATUS_OK);\n\t\tbfa_stats(itnim, delete_comps);\n\t\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_FWRSP);\n\t\tbreak;\n\n\tcase BFI_ITN_I2H_SLER_EVENT:\n\t\titnim = BFA_ITNIM_FROM_TAG(fcpim,\n\t\t\t\t\t\tmsg.sler_event->bfa_handle);\n\t\tbfa_stats(itnim, sler_events);\n\t\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_SLER);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_trc(bfa, m->mhdr.msg_id);\n\t\tWARN_ON(1);\n\t}\n}\n\n \n\nstruct bfa_itnim_s *\nbfa_itnim_create(struct bfa_s *bfa, struct bfa_rport_s *rport, void *ditn)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tstruct bfa_itnim_s *itnim;\n\n\tbfa_itn_create(bfa, rport, bfa_itnim_isr);\n\n\titnim = BFA_ITNIM_FROM_TAG(fcpim, rport->rport_tag);\n\tWARN_ON(itnim->rport != rport);\n\n\titnim->ditn = ditn;\n\n\tbfa_stats(itnim, creates);\n\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_CREATE);\n\n\treturn itnim;\n}\n\nvoid\nbfa_itnim_delete(struct bfa_itnim_s *itnim)\n{\n\tbfa_stats(itnim, deletes);\n\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_DELETE);\n}\n\nvoid\nbfa_itnim_online(struct bfa_itnim_s *itnim, bfa_boolean_t seq_rec)\n{\n\titnim->seq_rec = seq_rec;\n\tbfa_stats(itnim, onlines);\n\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_ONLINE);\n}\n\nvoid\nbfa_itnim_offline(struct bfa_itnim_s *itnim)\n{\n\tbfa_stats(itnim, offlines);\n\tbfa_sm_send_event(itnim, BFA_ITNIM_SM_OFFLINE);\n}\n\n \nbfa_boolean_t\nbfa_itnim_hold_io(struct bfa_itnim_s *itnim)\n{\n\treturn itnim->fcpim->path_tov && itnim->iotov_active &&\n\t\t(bfa_sm_cmp_state(itnim, bfa_itnim_sm_fwcreate) ||\n\t\t bfa_sm_cmp_state(itnim, bfa_itnim_sm_sler) ||\n\t\t bfa_sm_cmp_state(itnim, bfa_itnim_sm_cleanup_offline) ||\n\t\t bfa_sm_cmp_state(itnim, bfa_itnim_sm_fwdelete) ||\n\t\t bfa_sm_cmp_state(itnim, bfa_itnim_sm_offline) ||\n\t\t bfa_sm_cmp_state(itnim, bfa_itnim_sm_iocdisable));\n}\n\n#define bfa_io_lat_clock_res_div\tHZ\n#define bfa_io_lat_clock_res_mul\t1000\nbfa_status_t\nbfa_itnim_get_ioprofile(struct bfa_itnim_s *itnim,\n\t\t\tstruct bfa_itnim_ioprofile_s *ioprofile)\n{\n\tstruct bfa_fcpim_s *fcpim;\n\n\tif (!itnim)\n\t\treturn BFA_STATUS_NO_FCPIM_NEXUS;\n\n\tfcpim = BFA_FCPIM(itnim->bfa);\n\n\tif (!fcpim->io_profile)\n\t\treturn BFA_STATUS_IOPROFILE_OFF;\n\n\titnim->ioprofile.index = BFA_IOBUCKET_MAX;\n\t \n\titnim->ioprofile.io_profile_start_time =\n\t\t\t\tbfa_io_profile_start_time(itnim->bfa);\n\titnim->ioprofile.clock_res_mul = bfa_io_lat_clock_res_mul;\n\titnim->ioprofile.clock_res_div = bfa_io_lat_clock_res_div;\n\t*ioprofile = itnim->ioprofile;\n\n\treturn BFA_STATUS_OK;\n}\n\nvoid\nbfa_itnim_clear_stats(struct bfa_itnim_s *itnim)\n{\n\tint j;\n\n\tif (!itnim)\n\t\treturn;\n\n\tmemset(&itnim->stats, 0, sizeof(itnim->stats));\n\tmemset(&itnim->ioprofile, 0, sizeof(itnim->ioprofile));\n\tfor (j = 0; j < BFA_IOBUCKET_MAX; j++)\n\t\titnim->ioprofile.io_latency.min[j] = ~0;\n}\n\n \n\n \nstatic void\nbfa_ioim_sm_uninit(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tswitch (event) {\n\tcase BFA_IOIM_SM_START:\n\t\tif (!bfa_itnim_is_online(ioim->itnim)) {\n\t\t\tif (!bfa_itnim_hold_io(ioim->itnim)) {\n\t\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\t\t\tlist_del(&ioim->qe);\n\t\t\t\tlist_add_tail(&ioim->qe,\n\t\t\t\t\t&ioim->fcpim->ioim_comp_q);\n\t\t\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\n\t\t\t\t\t\t__bfa_cb_ioim_pathtov, ioim);\n\t\t\t} else {\n\t\t\t\tlist_del(&ioim->qe);\n\t\t\t\tlist_add_tail(&ioim->qe,\n\t\t\t\t\t&ioim->itnim->pending_q);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tif (ioim->nsges > BFI_SGE_INLINE) {\n\t\t\tif (!bfa_ioim_sgpg_alloc(ioim)) {\n\t\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_sgalloc);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (!bfa_ioim_send_ioreq(ioim)) {\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_qfull);\n\t\t\tbreak;\n\t\t}\n\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_active);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_IOTOV:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\n\t\t\t\t__bfa_cb_ioim_pathtov, ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT:\n\t\t \n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tWARN_ON(!bfa_q_is_on_q(&ioim->itnim->pending_q, ioim));\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\n\t\t\t__bfa_cb_ioim_abort, ioim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_sgalloc(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_trc(ioim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_IOIM_SM_SGALLOCED:\n\t\tif (!bfa_ioim_send_ioreq(ioim)) {\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_qfull);\n\t\t\tbreak;\n\t\t}\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_active);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_sgpg_wcancel(ioim->bfa, &ioim->iosp->sgpg_wqe);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\n\t\t\t      ioim);\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_sgpg_wcancel(ioim->bfa, &ioim->iosp->sgpg_wqe);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_sgpg_wcancel(ioim->bfa, &ioim->iosp->sgpg_wqe);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_active(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tswitch (event) {\n\tcase BFA_IOIM_SM_COMP_GOOD:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\n\t\t\t      __bfa_cb_ioim_good_comp, ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_COMP:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_comp,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_DONE:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_comp,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT:\n\t\tioim->iosp->abort_explicit = BFA_TRUE;\n\t\tioim->io_cbfn = __bfa_cb_ioim_abort;\n\n\t\tif (bfa_ioim_send_abort(ioim))\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_abort);\n\t\telse {\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_abort_qfull);\n\t\t\tbfa_stats(ioim->itnim, qwait);\n\t\t\tbfa_reqq_wait(ioim->bfa, ioim->reqq,\n\t\t\t\t\t  &ioim->iosp->reqq_wait);\n\t\t}\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\tioim->iosp->abort_explicit = BFA_FALSE;\n\t\tioim->io_cbfn = __bfa_cb_ioim_failed;\n\n\t\tif (bfa_ioim_send_abort(ioim))\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup);\n\t\telse {\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup_qfull);\n\t\t\tbfa_stats(ioim->itnim, qwait);\n\t\t\tbfa_reqq_wait(ioim->bfa, ioim->reqq,\n\t\t\t\t\t  &ioim->iosp->reqq_wait);\n\t\t}\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_SQRETRY:\n\t\tif (bfa_ioim_maxretry_reached(ioim)) {\n\t\t\t \n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\n\t\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\n\t\t\t\t\t__bfa_cb_ioim_failed, ioim);\n\t\t\tbreak;\n\t\t}\n\t\t \n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_cmnd_retry);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_cmnd_retry(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tswitch (event) {\n\tcase BFA_IOIM_SM_FREE:\n\t\t \n\t\tbfa_ioim_update_iotag(ioim);\n\t\tif (!bfa_ioim_send_ioreq(ioim)) {\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_qfull);\n\t\t\tbreak;\n\t\t}\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_active);\n\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\tioim->iosp->abort_explicit = BFA_FALSE;\n\t\tioim->io_cbfn = __bfa_cb_ioim_failed;\n\n\t\tif (bfa_ioim_send_abort(ioim))\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup);\n\t\telse {\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup_qfull);\n\t\t\tbfa_stats(ioim->itnim, qwait);\n\t\t\tbfa_reqq_wait(ioim->bfa, ioim->reqq,\n\t\t\t\t\t  &ioim->iosp->reqq_wait);\n\t\t}\n\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe,\n\t\t\t __bfa_cb_ioim_failed, ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT:\n\t\t \n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_abort(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_trc(ioim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_IOIM_SM_COMP_GOOD:\n\tcase BFA_IOIM_SM_COMP:\n\tcase BFA_IOIM_SM_DONE:\n\tcase BFA_IOIM_SM_FREE:\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT_DONE:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT_COMP:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_COMP_UTAG:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\tWARN_ON(ioim->iosp->abort_explicit != BFA_TRUE);\n\t\tioim->iosp->abort_explicit = BFA_FALSE;\n\n\t\tif (bfa_ioim_send_abort(ioim))\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup);\n\t\telse {\n\t\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup_qfull);\n\t\t\tbfa_stats(ioim->itnim, qwait);\n\t\t\tbfa_reqq_wait(ioim->bfa, ioim->reqq,\n\t\t\t\t\t  &ioim->iosp->reqq_wait);\n\t\t}\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_cleanup(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_trc(ioim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_IOIM_SM_COMP_GOOD:\n\tcase BFA_IOIM_SM_COMP:\n\tcase BFA_IOIM_SM_DONE:\n\tcase BFA_IOIM_SM_FREE:\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT:\n\t\t \n\t\tioim->io_cbfn = __bfa_cb_ioim_abort;\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT_DONE:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT_COMP:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_COMP_UTAG:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_qfull(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_trc(ioim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_IOIM_SM_QRESUME:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_active);\n\t\tbfa_ioim_send_ioreq(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\n\t\t\t      ioim);\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_abort_qfull(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_trc(ioim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_IOIM_SM_QRESUME:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_abort);\n\t\tbfa_ioim_send_abort(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\tWARN_ON(ioim->iosp->abort_explicit != BFA_TRUE);\n\t\tioim->iosp->abort_explicit = BFA_FALSE;\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup_qfull);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_COMP_GOOD:\n\tcase BFA_IOIM_SM_COMP:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_DONE:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\n\t\tbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_abort,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_cleanup_qfull(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_trc(ioim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_IOIM_SM_QRESUME:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_cleanup);\n\t\tbfa_ioim_send_abort(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_ABORT:\n\t\t \n\t\tioim->io_cbfn = __bfa_cb_ioim_abort;\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_COMP_GOOD:\n\tcase BFA_IOIM_SM_COMP:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_DONE:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb_free);\n\t\tbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbfa_reqq_wcancel(&ioim->iosp->reqq_wait);\n\t\tbfa_ioim_move_to_comp_q(ioim);\n\t\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, __bfa_cb_ioim_failed,\n\t\t\t      ioim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_hcb(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tswitch (event) {\n\tcase BFA_IOIM_SM_HCB:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_uninit);\n\t\tbfa_ioim_free(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_hcb_free(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_trc(ioim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_IOIM_SM_HCB:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_resfree);\n\t\tlist_del(&ioim->qe);\n\t\tlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_resfree_q);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_FREE:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_hcb);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_ioim_sm_resfree(struct bfa_ioim_s *ioim, enum bfa_ioim_event event)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_trc(ioim->bfa, event);\n\n\tswitch (event) {\n\tcase BFA_IOIM_SM_FREE:\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_uninit);\n\t\tbfa_ioim_free(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_CLEANUP:\n\t\tbfa_ioim_notify_cleanup(ioim);\n\t\tbreak;\n\n\tcase BFA_IOIM_SM_HWFAIL:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(ioim->bfa, event);\n\t}\n}\n\n \nvoid\nbfa_ioim_lm_init(struct bfa_s *bfa)\n{\n\tstruct bfa_lun_mask_s *lunm_list;\n\tint\ti;\n\n\tif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\n\t\treturn;\n\n\tlunm_list = bfa_get_lun_mask_list(bfa);\n\tfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\n\t\tlunm_list[i].ua = BFA_IOIM_LM_UA_RESET;\n\t\tlunm_list[i].lp_tag = BFA_LP_TAG_INVALID;\n\t\tlunm_list[i].rp_tag = BFA_RPORT_TAG_INVALID;\n\t}\n}\n\nstatic void\n__bfa_cb_ioim_good_comp(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_ioim_s *ioim = cbarg;\n\n\tif (!complete) {\n\t\tbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\n\t\treturn;\n\t}\n\n\tbfa_cb_ioim_good_comp(ioim->bfa->bfad, ioim->dio);\n}\n\nstatic void\n__bfa_cb_ioim_comp(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_ioim_s\t*ioim = cbarg;\n\tstruct bfi_ioim_rsp_s *m;\n\tu8\t*snsinfo = NULL;\n\tu8\tsns_len = 0;\n\ts32\tresidue = 0;\n\n\tif (!complete) {\n\t\tbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\n\t\treturn;\n\t}\n\n\tm = (struct bfi_ioim_rsp_s *) &ioim->iosp->comp_rspmsg;\n\tif (m->io_status == BFI_IOIM_STS_OK) {\n\t\t \n\t\tif ((m->scsi_status == SAM_STAT_CHECK_CONDITION) &&\n\t\t\t\t\tm->sns_len) {\n\t\t\tsns_len = m->sns_len;\n\t\t\tsnsinfo = BFA_SNSINFO_FROM_TAG(ioim->fcpim->fcp,\n\t\t\t\t\t\tioim->iotag);\n\t\t}\n\n\t\t \n\t\tif (m->resid_flags == FCP_RESID_UNDER) {\n\t\t\tresidue = be32_to_cpu(m->residue);\n\t\t\tbfa_stats(ioim->itnim, iocomp_underrun);\n\t\t}\n\t\tif (m->resid_flags == FCP_RESID_OVER) {\n\t\t\tresidue = be32_to_cpu(m->residue);\n\t\t\tresidue = -residue;\n\t\t\tbfa_stats(ioim->itnim, iocomp_overrun);\n\t\t}\n\t}\n\n\tbfa_cb_ioim_done(ioim->bfa->bfad, ioim->dio, m->io_status,\n\t\t\t  m->scsi_status, sns_len, snsinfo, residue);\n}\n\nvoid\nbfa_fcpim_lunmask_rp_update(struct bfa_s *bfa, wwn_t lp_wwn, wwn_t rp_wwn,\n\t\t\tu16 rp_tag, u8 lp_tag)\n{\n\tstruct bfa_lun_mask_s *lun_list;\n\tu8\ti;\n\n\tif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\n\t\treturn;\n\n\tlun_list = bfa_get_lun_mask_list(bfa);\n\tfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\n\t\tif (lun_list[i].state == BFA_IOIM_LUN_MASK_ACTIVE) {\n\t\t\tif ((lun_list[i].lp_wwn == lp_wwn) &&\n\t\t\t    (lun_list[i].rp_wwn == rp_wwn)) {\n\t\t\t\tlun_list[i].rp_tag = rp_tag;\n\t\t\t\tlun_list[i].lp_tag = lp_tag;\n\t\t\t}\n\t\t}\n\t}\n}\n\n \nstatic void\nbfa_ioim_lm_set_ua(struct bfa_s *bfa)\n{\n\tstruct bfa_lun_mask_s\t*lunm_list;\n\tint\ti;\n\n\tlunm_list = bfa_get_lun_mask_list(bfa);\n\tfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\n\t\tif (lunm_list[i].state != BFA_IOIM_LUN_MASK_ACTIVE)\n\t\t\tcontinue;\n\t\tlunm_list[i].ua = BFA_IOIM_LM_UA_SET;\n\t}\n}\n\nbfa_status_t\nbfa_fcpim_lunmask_update(struct bfa_s *bfa, u32 update)\n{\n\tstruct bfa_lunmask_cfg_s\t*lun_mask;\n\n\tbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\n\tif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\n\t\treturn BFA_STATUS_FAILED;\n\n\tif (bfa_get_lun_mask_status(bfa) == update)\n\t\treturn BFA_STATUS_NO_CHANGE;\n\n\tlun_mask = bfa_get_lun_mask(bfa);\n\tlun_mask->status = update;\n\n\tif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_ENABLED)\n\t\tbfa_ioim_lm_set_ua(bfa);\n\n\treturn  bfa_dconf_update(bfa);\n}\n\nbfa_status_t\nbfa_fcpim_lunmask_clear(struct bfa_s *bfa)\n{\n\tint i;\n\tstruct bfa_lun_mask_s\t*lunm_list;\n\n\tbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\n\tif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\n\t\treturn BFA_STATUS_FAILED;\n\n\tlunm_list = bfa_get_lun_mask_list(bfa);\n\tfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\n\t\tif (lunm_list[i].state == BFA_IOIM_LUN_MASK_ACTIVE) {\n\t\t\tif (lunm_list[i].rp_tag != BFA_RPORT_TAG_INVALID)\n\t\t\t\tbfa_rport_unset_lunmask(bfa,\n\t\t\t\t  BFA_RPORT_FROM_TAG(bfa, lunm_list[i].rp_tag));\n\t\t}\n\t}\n\n\tmemset(lunm_list, 0, sizeof(struct bfa_lun_mask_s) * MAX_LUN_MASK_CFG);\n\treturn bfa_dconf_update(bfa);\n}\n\nbfa_status_t\nbfa_fcpim_lunmask_query(struct bfa_s *bfa, void *buf)\n{\n\tstruct bfa_lunmask_cfg_s *lun_mask;\n\n\tbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\n\tif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\n\t\treturn BFA_STATUS_FAILED;\n\n\tlun_mask = bfa_get_lun_mask(bfa);\n\tmemcpy(buf, lun_mask, sizeof(struct bfa_lunmask_cfg_s));\n\treturn BFA_STATUS_OK;\n}\n\nbfa_status_t\nbfa_fcpim_lunmask_add(struct bfa_s *bfa, u16 vf_id, wwn_t *pwwn,\n\t\t      wwn_t rpwwn, struct scsi_lun lun)\n{\n\tstruct bfa_lun_mask_s *lunm_list;\n\tstruct bfa_rport_s *rp = NULL;\n\tint i, free_index = MAX_LUN_MASK_CFG + 1;\n\tstruct bfa_fcs_lport_s *port = NULL;\n\tstruct bfa_fcs_rport_s *rp_fcs;\n\n\tbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\n\tif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\n\t\treturn BFA_STATUS_FAILED;\n\n\tport = bfa_fcs_lookup_port(&((struct bfad_s *)bfa->bfad)->bfa_fcs,\n\t\t\t\t   vf_id, *pwwn);\n\tif (port) {\n\t\t*pwwn = port->port_cfg.pwwn;\n\t\trp_fcs = bfa_fcs_lport_get_rport_by_pwwn(port, rpwwn);\n\t\tif (rp_fcs)\n\t\t\trp = rp_fcs->bfa_rport;\n\t}\n\n\tlunm_list = bfa_get_lun_mask_list(bfa);\n\t \n\tfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\n\t\tif (lunm_list[i].state != BFA_IOIM_LUN_MASK_ACTIVE)\n\t\t\tfree_index = i;\n\t\tif ((lunm_list[i].lp_wwn == *pwwn) &&\n\t\t    (lunm_list[i].rp_wwn == rpwwn) &&\n\t\t    (scsilun_to_int((struct scsi_lun *)&lunm_list[i].lun) ==\n\t\t     scsilun_to_int((struct scsi_lun *)&lun)))\n\t\t\treturn  BFA_STATUS_ENTRY_EXISTS;\n\t}\n\n\tif (free_index > MAX_LUN_MASK_CFG)\n\t\treturn BFA_STATUS_MAX_ENTRY_REACHED;\n\n\tif (rp) {\n\t\tlunm_list[free_index].lp_tag = bfa_lps_get_tag_from_pid(bfa,\n\t\t\t\t\t\t   rp->rport_info.local_pid);\n\t\tlunm_list[free_index].rp_tag = rp->rport_tag;\n\t} else {\n\t\tlunm_list[free_index].lp_tag = BFA_LP_TAG_INVALID;\n\t\tlunm_list[free_index].rp_tag = BFA_RPORT_TAG_INVALID;\n\t}\n\n\tlunm_list[free_index].lp_wwn = *pwwn;\n\tlunm_list[free_index].rp_wwn = rpwwn;\n\tlunm_list[free_index].lun = lun;\n\tlunm_list[free_index].state = BFA_IOIM_LUN_MASK_ACTIVE;\n\n\t \n\tfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\n\t\tif ((lunm_list[i].lp_wwn == *pwwn) &&\n\t\t    (lunm_list[i].rp_wwn == rpwwn))\n\t\t\tlunm_list[i].ua = BFA_IOIM_LM_UA_SET;\n\t}\n\n\treturn bfa_dconf_update(bfa);\n}\n\nbfa_status_t\nbfa_fcpim_lunmask_delete(struct bfa_s *bfa, u16 vf_id, wwn_t *pwwn,\n\t\t\t wwn_t rpwwn, struct scsi_lun lun)\n{\n\tstruct bfa_lun_mask_s\t*lunm_list;\n\tstruct bfa_fcs_lport_s *port = NULL;\n\tint\ti;\n\n\t \n\tif (bfa_get_lun_mask_status(bfa) == BFA_LUNMASK_MINCFG)\n\t\treturn BFA_STATUS_FAILED;\n\n\tbfa_trc(bfa, bfa_get_lun_mask_status(bfa));\n\tbfa_trc(bfa, *pwwn);\n\tbfa_trc(bfa, rpwwn);\n\tbfa_trc(bfa, scsilun_to_int((struct scsi_lun *)&lun));\n\n\tif (*pwwn == 0) {\n\t\tport = bfa_fcs_lookup_port(\n\t\t\t\t&((struct bfad_s *)bfa->bfad)->bfa_fcs,\n\t\t\t\tvf_id, *pwwn);\n\t\tif (port)\n\t\t\t*pwwn = port->port_cfg.pwwn;\n\t}\n\n\tlunm_list = bfa_get_lun_mask_list(bfa);\n\tfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\n\t\tif ((lunm_list[i].lp_wwn == *pwwn) &&\n\t\t    (lunm_list[i].rp_wwn == rpwwn) &&\n\t\t    (scsilun_to_int((struct scsi_lun *)&lunm_list[i].lun) ==\n\t\t     scsilun_to_int((struct scsi_lun *)&lun))) {\n\t\t\tlunm_list[i].lp_wwn = 0;\n\t\t\tlunm_list[i].rp_wwn = 0;\n\t\t\tint_to_scsilun(0, &lunm_list[i].lun);\n\t\t\tlunm_list[i].state = BFA_IOIM_LUN_MASK_INACTIVE;\n\t\t\tif (lunm_list[i].rp_tag != BFA_RPORT_TAG_INVALID) {\n\t\t\t\tlunm_list[i].rp_tag = BFA_RPORT_TAG_INVALID;\n\t\t\t\tlunm_list[i].lp_tag = BFA_LP_TAG_INVALID;\n\t\t\t}\n\t\t\treturn bfa_dconf_update(bfa);\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; i < MAX_LUN_MASK_CFG; i++) {\n\t\tif ((lunm_list[i].lp_wwn == *pwwn) &&\n\t\t    (lunm_list[i].rp_wwn == rpwwn))\n\t\t\tlunm_list[i].ua = BFA_IOIM_LM_UA_SET;\n\t}\n\n\treturn BFA_STATUS_ENTRY_NOT_EXISTS;\n}\n\nstatic void\n__bfa_cb_ioim_failed(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_ioim_s *ioim = cbarg;\n\n\tif (!complete) {\n\t\tbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\n\t\treturn;\n\t}\n\n\tbfa_cb_ioim_done(ioim->bfa->bfad, ioim->dio, BFI_IOIM_STS_ABORTED,\n\t\t\t  0, 0, NULL, 0);\n}\n\nstatic void\n__bfa_cb_ioim_pathtov(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_ioim_s *ioim = cbarg;\n\n\tbfa_stats(ioim->itnim, path_tov_expired);\n\tif (!complete) {\n\t\tbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\n\t\treturn;\n\t}\n\n\tbfa_cb_ioim_done(ioim->bfa->bfad, ioim->dio, BFI_IOIM_STS_PATHTOV,\n\t\t\t  0, 0, NULL, 0);\n}\n\nstatic void\n__bfa_cb_ioim_abort(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_ioim_s *ioim = cbarg;\n\n\tif (!complete) {\n\t\tbfa_sm_send_event(ioim, BFA_IOIM_SM_HCB);\n\t\treturn;\n\t}\n\n\tbfa_cb_ioim_abort(ioim->bfa->bfad, ioim->dio);\n}\n\nstatic void\nbfa_ioim_sgpg_alloced(void *cbarg)\n{\n\tstruct bfa_ioim_s *ioim = cbarg;\n\n\tioim->nsgpgs = BFA_SGPG_NPAGE(ioim->nsges);\n\tlist_splice_tail_init(&ioim->iosp->sgpg_wqe.sgpg_q, &ioim->sgpg_q);\n\tioim->sgpg = bfa_q_first(&ioim->sgpg_q);\n\tbfa_sm_send_event(ioim, BFA_IOIM_SM_SGALLOCED);\n}\n\n \nstatic\tbfa_boolean_t\nbfa_ioim_send_ioreq(struct bfa_ioim_s *ioim)\n{\n\tstruct bfa_itnim_s *itnim = ioim->itnim;\n\tstruct bfi_ioim_req_s *m;\n\tstatic struct fcp_cmnd_s cmnd_z0 = { { { 0 } } };\n\tstruct bfi_sge_s *sge, *sgpge;\n\tu32\tpgdlen = 0;\n\tu32\tfcp_dl;\n\tu64 addr;\n\tstruct scatterlist *sg;\n\tstruct bfa_sgpg_s *sgpg;\n\tstruct scsi_cmnd *cmnd = (struct scsi_cmnd *) ioim->dio;\n\tu32 i, sge_id, pgcumsz;\n\tenum dma_data_direction dmadir;\n\n\t \n\tm = bfa_reqq_next(ioim->bfa, ioim->reqq);\n\tif (!m) {\n\t\tbfa_stats(ioim->itnim, qwait);\n\t\tbfa_reqq_wait(ioim->bfa, ioim->reqq,\n\t\t\t\t  &ioim->iosp->reqq_wait);\n\t\treturn BFA_FALSE;\n\t}\n\n\t \n\tm->io_tag = cpu_to_be16(ioim->iotag);\n\tm->rport_hdl = ioim->itnim->rport->fw_handle;\n\tm->io_timeout = 0;\n\n\tsge = &m->sges[0];\n\tsgpg = ioim->sgpg;\n\tsge_id = 0;\n\tsgpge = NULL;\n\tpgcumsz = 0;\n\tscsi_for_each_sg(cmnd, sg, ioim->nsges, i) {\n\t\tif (i == 0) {\n\t\t\t \n\t\t\taddr = bfa_sgaddr_le(sg_dma_address(sg));\n\t\t\tsge->sga = *(union bfi_addr_u *) &addr;\n\t\t\tpgdlen = sg_dma_len(sg);\n\t\t\tsge->sg_len = pgdlen;\n\t\t\tsge->flags = (ioim->nsges > BFI_SGE_INLINE) ?\n\t\t\t\t\tBFI_SGE_DATA_CPL : BFI_SGE_DATA_LAST;\n\t\t\tbfa_sge_to_be(sge);\n\t\t\tsge++;\n\t\t} else {\n\t\t\tif (sge_id == 0)\n\t\t\t\tsgpge = sgpg->sgpg->sges;\n\n\t\t\taddr = bfa_sgaddr_le(sg_dma_address(sg));\n\t\t\tsgpge->sga = *(union bfi_addr_u *) &addr;\n\t\t\tsgpge->sg_len = sg_dma_len(sg);\n\t\t\tpgcumsz += sgpge->sg_len;\n\n\t\t\t \n\t\t\tif (i < (ioim->nsges - 1) &&\n\t\t\t\t\tsge_id < (BFI_SGPG_DATA_SGES - 1))\n\t\t\t\tsgpge->flags = BFI_SGE_DATA;\n\t\t\telse if (i < (ioim->nsges - 1))\n\t\t\t\tsgpge->flags = BFI_SGE_DATA_CPL;\n\t\t\telse\n\t\t\t\tsgpge->flags = BFI_SGE_DATA_LAST;\n\n\t\t\tbfa_sge_to_le(sgpge);\n\n\t\t\tsgpge++;\n\t\t\tif (i == (ioim->nsges - 1)) {\n\t\t\t\tsgpge->flags = BFI_SGE_PGDLEN;\n\t\t\t\tsgpge->sga.a32.addr_lo = 0;\n\t\t\t\tsgpge->sga.a32.addr_hi = 0;\n\t\t\t\tsgpge->sg_len = pgcumsz;\n\t\t\t\tbfa_sge_to_le(sgpge);\n\t\t\t} else if (++sge_id == BFI_SGPG_DATA_SGES) {\n\t\t\t\tsgpg = (struct bfa_sgpg_s *) bfa_q_next(sgpg);\n\t\t\t\tsgpge->flags = BFI_SGE_LINK;\n\t\t\t\tsgpge->sga = sgpg->sgpg_pa;\n\t\t\t\tsgpge->sg_len = pgcumsz;\n\t\t\t\tbfa_sge_to_le(sgpge);\n\t\t\t\tsge_id = 0;\n\t\t\t\tpgcumsz = 0;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (ioim->nsges > BFI_SGE_INLINE) {\n\t\tsge->sga = ioim->sgpg->sgpg_pa;\n\t} else {\n\t\tsge->sga.a32.addr_lo = 0;\n\t\tsge->sga.a32.addr_hi = 0;\n\t}\n\tsge->sg_len = pgdlen;\n\tsge->flags = BFI_SGE_PGDLEN;\n\tbfa_sge_to_be(sge);\n\n\t \n\tm->cmnd = cmnd_z0;\n\tint_to_scsilun(cmnd->device->lun, &m->cmnd.lun);\n\tdmadir = cmnd->sc_data_direction;\n\tif (dmadir == DMA_TO_DEVICE)\n\t\tm->cmnd.iodir = FCP_IODIR_WRITE;\n\telse if (dmadir == DMA_FROM_DEVICE)\n\t\tm->cmnd.iodir = FCP_IODIR_READ;\n\telse\n\t\tm->cmnd.iodir = FCP_IODIR_NONE;\n\n\tm->cmnd.cdb = *(struct scsi_cdb_s *) cmnd->cmnd;\n\tfcp_dl = scsi_bufflen(cmnd);\n\tm->cmnd.fcp_dl = cpu_to_be32(fcp_dl);\n\n\t \n\tswitch (m->cmnd.iodir) {\n\tcase FCP_IODIR_READ:\n\t\tbfi_h2i_set(m->mh, BFI_MC_IOIM_READ, 0, bfa_fn_lpu(ioim->bfa));\n\t\tbfa_stats(itnim, input_reqs);\n\t\tioim->itnim->stats.rd_throughput += fcp_dl;\n\t\tbreak;\n\tcase FCP_IODIR_WRITE:\n\t\tbfi_h2i_set(m->mh, BFI_MC_IOIM_WRITE, 0, bfa_fn_lpu(ioim->bfa));\n\t\tbfa_stats(itnim, output_reqs);\n\t\tioim->itnim->stats.wr_throughput += fcp_dl;\n\t\tbreak;\n\tcase FCP_IODIR_RW:\n\t\tbfa_stats(itnim, input_reqs);\n\t\tbfa_stats(itnim, output_reqs);\n\t\tfallthrough;\n\tdefault:\n\t\tbfi_h2i_set(m->mh, BFI_MC_IOIM_IO, 0, bfa_fn_lpu(ioim->bfa));\n\t}\n\tif (itnim->seq_rec ||\n\t    (scsi_bufflen(cmnd) & (sizeof(u32) - 1)))\n\t\tbfi_h2i_set(m->mh, BFI_MC_IOIM_IO, 0, bfa_fn_lpu(ioim->bfa));\n\n\t \n\tbfa_reqq_produce(ioim->bfa, ioim->reqq, m->mh);\n\treturn BFA_TRUE;\n}\n\n \nstatic bfa_boolean_t\nbfa_ioim_sgpg_alloc(struct bfa_ioim_s *ioim)\n{\n\tu16\tnsgpgs;\n\n\tWARN_ON(ioim->nsges <= BFI_SGE_INLINE);\n\n\t \n\tnsgpgs = BFA_SGPG_NPAGE(ioim->nsges);\n\tif (!nsgpgs)\n\t\treturn BFA_TRUE;\n\n\tif (bfa_sgpg_malloc(ioim->bfa, &ioim->sgpg_q, nsgpgs)\n\t    != BFA_STATUS_OK) {\n\t\tbfa_sgpg_wait(ioim->bfa, &ioim->iosp->sgpg_wqe, nsgpgs);\n\t\treturn BFA_FALSE;\n\t}\n\n\tioim->nsgpgs = nsgpgs;\n\tioim->sgpg = bfa_q_first(&ioim->sgpg_q);\n\n\treturn BFA_TRUE;\n}\n\n \nstatic\tbfa_boolean_t\nbfa_ioim_send_abort(struct bfa_ioim_s *ioim)\n{\n\tstruct bfi_ioim_abort_req_s *m;\n\tenum bfi_ioim_h2i\tmsgop;\n\n\t \n\tm = bfa_reqq_next(ioim->bfa, ioim->reqq);\n\tif (!m)\n\t\treturn BFA_FALSE;\n\n\t \n\tif (ioim->iosp->abort_explicit)\n\t\tmsgop = BFI_IOIM_H2I_IOABORT_REQ;\n\telse\n\t\tmsgop = BFI_IOIM_H2I_IOCLEANUP_REQ;\n\n\tbfi_h2i_set(m->mh, BFI_MC_IOIM, msgop, bfa_fn_lpu(ioim->bfa));\n\tm->io_tag    = cpu_to_be16(ioim->iotag);\n\tm->abort_tag = ++ioim->abort_tag;\n\n\t \n\tbfa_reqq_produce(ioim->bfa, ioim->reqq, m->mh);\n\treturn BFA_TRUE;\n}\n\n \nstatic void\nbfa_ioim_qresume(void *cbarg)\n{\n\tstruct bfa_ioim_s *ioim = cbarg;\n\n\tbfa_stats(ioim->itnim, qresumes);\n\tbfa_sm_send_event(ioim, BFA_IOIM_SM_QRESUME);\n}\n\n\nstatic void\nbfa_ioim_notify_cleanup(struct bfa_ioim_s *ioim)\n{\n\t \n\tlist_del(&ioim->qe);\n\tlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_comp_q);\n\n\tif (!ioim->iosp->tskim) {\n\t\tif (ioim->fcpim->delay_comp && ioim->itnim->iotov_active) {\n\t\t\tbfa_cb_dequeue(&ioim->hcb_qe);\n\t\t\tlist_del(&ioim->qe);\n\t\t\tlist_add_tail(&ioim->qe, &ioim->itnim->delay_comp_q);\n\t\t}\n\t\tbfa_itnim_iodone(ioim->itnim);\n\t} else\n\t\tbfa_wc_down(&ioim->iosp->tskim->wc);\n}\n\nstatic bfa_boolean_t\nbfa_ioim_is_abortable(struct bfa_ioim_s *ioim)\n{\n\tif ((bfa_sm_cmp_state(ioim, bfa_ioim_sm_uninit) &&\n\t    (!bfa_q_is_on_q(&ioim->itnim->pending_q, ioim)))\t||\n\t    (bfa_sm_cmp_state(ioim, bfa_ioim_sm_abort))\t\t||\n\t    (bfa_sm_cmp_state(ioim, bfa_ioim_sm_abort_qfull))\t||\n\t    (bfa_sm_cmp_state(ioim, bfa_ioim_sm_hcb))\t\t||\n\t    (bfa_sm_cmp_state(ioim, bfa_ioim_sm_hcb_free))\t||\n\t    (bfa_sm_cmp_state(ioim, bfa_ioim_sm_resfree)))\n\t\treturn BFA_FALSE;\n\n\treturn BFA_TRUE;\n}\n\nvoid\nbfa_ioim_delayed_comp(struct bfa_ioim_s *ioim, bfa_boolean_t iotov)\n{\n\t \n\tif (iotov)\n\t\tioim->io_cbfn = __bfa_cb_ioim_pathtov;\n\telse {\n\t\tioim->io_cbfn = __bfa_cb_ioim_failed;\n\t\tbfa_stats(ioim->itnim, iocom_nexus_abort);\n\t}\n\tbfa_cb_queue(ioim->bfa, &ioim->hcb_qe, ioim->io_cbfn, ioim);\n\n\t \n\tlist_del(&ioim->qe);\n\tlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_comp_q);\n}\n\n\n \nvoid\nbfa_ioim_attach(struct bfa_fcpim_s *fcpim)\n{\n\tstruct bfa_ioim_s\t\t*ioim;\n\tstruct bfa_fcp_mod_s\t*fcp = fcpim->fcp;\n\tstruct bfa_ioim_sp_s\t*iosp;\n\tu16\t\ti;\n\n\t \n\tioim = (struct bfa_ioim_s *) bfa_mem_kva_curp(fcp);\n\tfcpim->ioim_arr = ioim;\n\tbfa_mem_kva_curp(fcp) = (u8 *) (ioim + fcpim->fcp->num_ioim_reqs);\n\n\tiosp = (struct bfa_ioim_sp_s *) bfa_mem_kva_curp(fcp);\n\tfcpim->ioim_sp_arr = iosp;\n\tbfa_mem_kva_curp(fcp) = (u8 *) (iosp + fcpim->fcp->num_ioim_reqs);\n\n\t \n\tINIT_LIST_HEAD(&fcpim->ioim_resfree_q);\n\tINIT_LIST_HEAD(&fcpim->ioim_comp_q);\n\n\tfor (i = 0; i < fcpim->fcp->num_ioim_reqs;\n\t     i++, ioim++, iosp++) {\n\t\t \n\t\tmemset(ioim, 0, sizeof(struct bfa_ioim_s));\n\t\tioim->iotag   = i;\n\t\tioim->bfa     = fcpim->bfa;\n\t\tioim->fcpim   = fcpim;\n\t\tioim->iosp    = iosp;\n\t\tINIT_LIST_HEAD(&ioim->sgpg_q);\n\t\tbfa_reqq_winit(&ioim->iosp->reqq_wait,\n\t\t\t\t   bfa_ioim_qresume, ioim);\n\t\tbfa_sgpg_winit(&ioim->iosp->sgpg_wqe,\n\t\t\t\t   bfa_ioim_sgpg_alloced, ioim);\n\t\tbfa_sm_set_state(ioim, bfa_ioim_sm_uninit);\n\t}\n}\n\nvoid\nbfa_ioim_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tstruct bfi_ioim_rsp_s *rsp = (struct bfi_ioim_rsp_s *) m;\n\tstruct bfa_ioim_s *ioim;\n\tu16\tiotag;\n\tenum bfa_ioim_event evt = BFA_IOIM_SM_COMP;\n\n\tiotag = be16_to_cpu(rsp->io_tag);\n\n\tioim = BFA_IOIM_FROM_TAG(fcpim, iotag);\n\tWARN_ON(ioim->iotag != iotag);\n\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_trc(ioim->bfa, rsp->io_status);\n\tbfa_trc(ioim->bfa, rsp->reuse_io_tag);\n\n\tif (bfa_sm_cmp_state(ioim, bfa_ioim_sm_active))\n\t\tioim->iosp->comp_rspmsg = *m;\n\n\tswitch (rsp->io_status) {\n\tcase BFI_IOIM_STS_OK:\n\t\tbfa_stats(ioim->itnim, iocomp_ok);\n\t\tif (rsp->reuse_io_tag == 0)\n\t\t\tevt = BFA_IOIM_SM_DONE;\n\t\telse\n\t\t\tevt = BFA_IOIM_SM_COMP;\n\t\tbreak;\n\n\tcase BFI_IOIM_STS_TIMEDOUT:\n\t\tbfa_stats(ioim->itnim, iocomp_timedout);\n\t\tfallthrough;\n\tcase BFI_IOIM_STS_ABORTED:\n\t\trsp->io_status = BFI_IOIM_STS_ABORTED;\n\t\tbfa_stats(ioim->itnim, iocomp_aborted);\n\t\tif (rsp->reuse_io_tag == 0)\n\t\t\tevt = BFA_IOIM_SM_DONE;\n\t\telse\n\t\t\tevt = BFA_IOIM_SM_COMP;\n\t\tbreak;\n\n\tcase BFI_IOIM_STS_PROTO_ERR:\n\t\tbfa_stats(ioim->itnim, iocom_proto_err);\n\t\tWARN_ON(!rsp->reuse_io_tag);\n\t\tevt = BFA_IOIM_SM_COMP;\n\t\tbreak;\n\n\tcase BFI_IOIM_STS_SQER_NEEDED:\n\t\tbfa_stats(ioim->itnim, iocom_sqer_needed);\n\t\tWARN_ON(rsp->reuse_io_tag != 0);\n\t\tevt = BFA_IOIM_SM_SQRETRY;\n\t\tbreak;\n\n\tcase BFI_IOIM_STS_RES_FREE:\n\t\tbfa_stats(ioim->itnim, iocom_res_free);\n\t\tevt = BFA_IOIM_SM_FREE;\n\t\tbreak;\n\n\tcase BFI_IOIM_STS_HOST_ABORTED:\n\t\tbfa_stats(ioim->itnim, iocom_hostabrts);\n\t\tif (rsp->abort_tag != ioim->abort_tag) {\n\t\t\tbfa_trc(ioim->bfa, rsp->abort_tag);\n\t\t\tbfa_trc(ioim->bfa, ioim->abort_tag);\n\t\t\treturn;\n\t\t}\n\n\t\tif (rsp->reuse_io_tag)\n\t\t\tevt = BFA_IOIM_SM_ABORT_COMP;\n\t\telse\n\t\t\tevt = BFA_IOIM_SM_ABORT_DONE;\n\t\tbreak;\n\n\tcase BFI_IOIM_STS_UTAG:\n\t\tbfa_stats(ioim->itnim, iocom_utags);\n\t\tevt = BFA_IOIM_SM_COMP_UTAG;\n\t\tbreak;\n\n\tdefault:\n\t\tWARN_ON(1);\n\t}\n\n\tbfa_sm_send_event(ioim, evt);\n}\n\nvoid\nbfa_ioim_good_comp_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tstruct bfi_ioim_rsp_s *rsp = (struct bfi_ioim_rsp_s *) m;\n\tstruct bfa_ioim_s *ioim;\n\tu16\tiotag;\n\n\tiotag = be16_to_cpu(rsp->io_tag);\n\n\tioim = BFA_IOIM_FROM_TAG(fcpim, iotag);\n\tWARN_ON(ioim->iotag != iotag);\n\n\tbfa_ioim_cb_profile_comp(fcpim, ioim);\n\n\tbfa_sm_send_event(ioim, BFA_IOIM_SM_COMP_GOOD);\n}\n\n \nvoid\nbfa_ioim_cleanup(struct bfa_ioim_s *ioim)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_stats(ioim->itnim, io_cleanups);\n\n\tioim->iosp->tskim = NULL;\n\tbfa_sm_send_event(ioim, BFA_IOIM_SM_CLEANUP);\n}\n\nvoid\nbfa_ioim_cleanup_tm(struct bfa_ioim_s *ioim, struct bfa_tskim_s *tskim)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_stats(ioim->itnim, io_tmaborts);\n\n\tioim->iosp->tskim = tskim;\n\tbfa_sm_send_event(ioim, BFA_IOIM_SM_CLEANUP);\n}\n\n \nvoid\nbfa_ioim_iocdisable(struct bfa_ioim_s *ioim)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_stats(ioim->itnim, io_iocdowns);\n\tbfa_sm_send_event(ioim, BFA_IOIM_SM_HWFAIL);\n}\n\n \nvoid\nbfa_ioim_tov(struct bfa_ioim_s *ioim)\n{\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\tbfa_sm_send_event(ioim, BFA_IOIM_SM_IOTOV);\n}\n\n\n \nstruct bfa_ioim_s *\nbfa_ioim_alloc(struct bfa_s *bfa, struct bfad_ioim_s *dio,\n\t\tstruct bfa_itnim_s *itnim, u16 nsges)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tstruct bfa_ioim_s *ioim;\n\tstruct bfa_iotag_s *iotag = NULL;\n\n\t \n\tbfa_q_deq(&fcpim->fcp->iotag_ioim_free_q, &iotag);\n\tif (!iotag) {\n\t\tbfa_stats(itnim, no_iotags);\n\t\treturn NULL;\n\t}\n\n\tioim = BFA_IOIM_FROM_TAG(fcpim, iotag->tag);\n\n\tioim->dio = dio;\n\tioim->itnim = itnim;\n\tioim->nsges = nsges;\n\tioim->nsgpgs = 0;\n\n\tbfa_stats(itnim, total_ios);\n\tfcpim->ios_active++;\n\n\tlist_add_tail(&ioim->qe, &itnim->io_q);\n\n\treturn ioim;\n}\n\nvoid\nbfa_ioim_free(struct bfa_ioim_s *ioim)\n{\n\tstruct bfa_fcpim_s *fcpim = ioim->fcpim;\n\tstruct bfa_iotag_s *iotag;\n\n\tif (ioim->nsgpgs > 0)\n\t\tbfa_sgpg_mfree(ioim->bfa, &ioim->sgpg_q, ioim->nsgpgs);\n\n\tbfa_stats(ioim->itnim, io_comps);\n\tfcpim->ios_active--;\n\n\tioim->iotag &= BFA_IOIM_IOTAG_MASK;\n\n\tWARN_ON(!(ioim->iotag <\n\t\t(fcpim->fcp->num_ioim_reqs + fcpim->fcp->num_fwtio_reqs)));\n\tiotag = BFA_IOTAG_FROM_TAG(fcpim->fcp, ioim->iotag);\n\n\tif (ioim->iotag < fcpim->fcp->num_ioim_reqs)\n\t\tlist_add_tail(&iotag->qe, &fcpim->fcp->iotag_ioim_free_q);\n\telse\n\t\tlist_add_tail(&iotag->qe, &fcpim->fcp->iotag_tio_free_q);\n\n\tlist_del(&ioim->qe);\n}\n\nvoid\nbfa_ioim_start(struct bfa_ioim_s *ioim)\n{\n\tbfa_ioim_cb_profile_start(ioim->fcpim, ioim);\n\n\t \n\tioim->reqq = bfa_fcpim_ioredirect_enabled(ioim->bfa) ?\n\t\t\tBFA_FALSE : bfa_itnim_get_reqq(ioim);\n\n\tbfa_sm_send_event(ioim, BFA_IOIM_SM_START);\n}\n\n \nbfa_status_t\nbfa_ioim_abort(struct bfa_ioim_s *ioim)\n{\n\n\tbfa_trc(ioim->bfa, ioim->iotag);\n\n\tif (!bfa_ioim_is_abortable(ioim))\n\t\treturn BFA_STATUS_FAILED;\n\n\tbfa_stats(ioim->itnim, io_aborts);\n\tbfa_sm_send_event(ioim, BFA_IOIM_SM_ABORT);\n\n\treturn BFA_STATUS_OK;\n}\n\n \n\n \nstatic void\nbfa_tskim_sm_uninit(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\n{\n\tbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\n\n\tswitch (event) {\n\tcase BFA_TSKIM_SM_START:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_active);\n\t\tbfa_tskim_gather_ios(tskim);\n\n\t\t \n\t\tif (!bfa_itnim_is_online(tskim->itnim)) {\n\t\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_iocleanup);\n\t\t\ttskim->tsk_status = BFI_TSKIM_STS_OK;\n\t\t\tbfa_tskim_cleanup_ios(tskim);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!bfa_tskim_send(tskim)) {\n\t\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_qfull);\n\t\t\tbfa_stats(tskim->itnim, tm_qwait);\n\t\t\tbfa_reqq_wait(tskim->bfa, tskim->itnim->reqq,\n\t\t\t\t\t  &tskim->reqq_wait);\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(tskim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_tskim_sm_active(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\n{\n\tbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\n\n\tswitch (event) {\n\tcase BFA_TSKIM_SM_DONE:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_iocleanup);\n\t\tbfa_tskim_cleanup_ios(tskim);\n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_CLEANUP:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_cleanup);\n\t\tif (!bfa_tskim_send_abort(tskim)) {\n\t\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_cleanup_qfull);\n\t\t\tbfa_stats(tskim->itnim, tm_qwait);\n\t\t\tbfa_reqq_wait(tskim->bfa, tskim->itnim->reqq,\n\t\t\t\t&tskim->reqq_wait);\n\t\t}\n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\n\t\tbfa_tskim_iocdisable_ios(tskim);\n\t\tbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(tskim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_tskim_sm_cleanup(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\n{\n\tbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\n\n\tswitch (event) {\n\tcase BFA_TSKIM_SM_DONE:\n\t\t \n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_UTAG:\n\tcase BFA_TSKIM_SM_CLEANUP_DONE:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_iocleanup);\n\t\tbfa_tskim_cleanup_ios(tskim);\n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\n\t\tbfa_tskim_iocdisable_ios(tskim);\n\t\tbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(tskim->bfa, event);\n\t}\n}\n\nstatic void\nbfa_tskim_sm_iocleanup(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\n{\n\tbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\n\n\tswitch (event) {\n\tcase BFA_TSKIM_SM_IOS_DONE:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\n\t\tbfa_tskim_qcomp(tskim, __bfa_cb_tskim_done);\n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_CLEANUP:\n\t\t \n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\n\t\tbfa_tskim_iocdisable_ios(tskim);\n\t\tbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(tskim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_tskim_sm_qfull(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\n{\n\tbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\n\n\tswitch (event) {\n\tcase BFA_TSKIM_SM_QRESUME:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_active);\n\t\tbfa_tskim_send(tskim);\n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_CLEANUP:\n\t\t \n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_iocleanup);\n\t\tbfa_reqq_wcancel(&tskim->reqq_wait);\n\t\tbfa_tskim_cleanup_ios(tskim);\n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\n\t\tbfa_reqq_wcancel(&tskim->reqq_wait);\n\t\tbfa_tskim_iocdisable_ios(tskim);\n\t\tbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(tskim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_tskim_sm_cleanup_qfull(struct bfa_tskim_s *tskim,\n\t\tenum bfa_tskim_event event)\n{\n\tbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\n\n\tswitch (event) {\n\tcase BFA_TSKIM_SM_DONE:\n\t\tbfa_reqq_wcancel(&tskim->reqq_wait);\n\t\tfallthrough;\n\tcase BFA_TSKIM_SM_QRESUME:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_cleanup);\n\t\tbfa_tskim_send_abort(tskim);\n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_HWFAIL:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_hcb);\n\t\tbfa_reqq_wcancel(&tskim->reqq_wait);\n\t\tbfa_tskim_iocdisable_ios(tskim);\n\t\tbfa_tskim_qcomp(tskim, __bfa_cb_tskim_failed);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(tskim->bfa, event);\n\t}\n}\n\n \nstatic void\nbfa_tskim_sm_hcb(struct bfa_tskim_s *tskim, enum bfa_tskim_event event)\n{\n\tbfa_trc(tskim->bfa, tskim->tsk_tag << 16 | event);\n\n\tswitch (event) {\n\tcase BFA_TSKIM_SM_HCB:\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_uninit);\n\t\tbfa_tskim_free(tskim);\n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_CLEANUP:\n\t\tbfa_tskim_notify_comp(tskim);\n\t\tbreak;\n\n\tcase BFA_TSKIM_SM_HWFAIL:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(tskim->bfa, event);\n\t}\n}\n\nstatic void\n__bfa_cb_tskim_done(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_tskim_s *tskim = cbarg;\n\n\tif (!complete) {\n\t\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_HCB);\n\t\treturn;\n\t}\n\n\tbfa_stats(tskim->itnim, tm_success);\n\tbfa_cb_tskim_done(tskim->bfa->bfad, tskim->dtsk, tskim->tsk_status);\n}\n\nstatic void\n__bfa_cb_tskim_failed(void *cbarg, bfa_boolean_t complete)\n{\n\tstruct bfa_tskim_s *tskim = cbarg;\n\n\tif (!complete) {\n\t\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_HCB);\n\t\treturn;\n\t}\n\n\tbfa_stats(tskim->itnim, tm_failures);\n\tbfa_cb_tskim_done(tskim->bfa->bfad, tskim->dtsk,\n\t\t\t\tBFI_TSKIM_STS_FAILED);\n}\n\nstatic bfa_boolean_t\nbfa_tskim_match_scope(struct bfa_tskim_s *tskim, struct scsi_lun lun)\n{\n\tswitch (tskim->tm_cmnd) {\n\tcase FCP_TM_TARGET_RESET:\n\t\treturn BFA_TRUE;\n\n\tcase FCP_TM_ABORT_TASK_SET:\n\tcase FCP_TM_CLEAR_TASK_SET:\n\tcase FCP_TM_LUN_RESET:\n\tcase FCP_TM_CLEAR_ACA:\n\t\treturn !memcmp(&tskim->lun, &lun, sizeof(lun));\n\n\tdefault:\n\t\tWARN_ON(1);\n\t}\n\n\treturn BFA_FALSE;\n}\n\n \nstatic void\nbfa_tskim_gather_ios(struct bfa_tskim_s *tskim)\n{\n\tstruct bfa_itnim_s *itnim = tskim->itnim;\n\tstruct bfa_ioim_s *ioim;\n\tstruct list_head *qe, *qen;\n\tstruct scsi_cmnd *cmnd;\n\tstruct scsi_lun scsilun;\n\n\tINIT_LIST_HEAD(&tskim->io_q);\n\n\t \n\tlist_for_each_safe(qe, qen, &itnim->io_q) {\n\t\tioim = (struct bfa_ioim_s *) qe;\n\t\tcmnd = (struct scsi_cmnd *) ioim->dio;\n\t\tint_to_scsilun(cmnd->device->lun, &scsilun);\n\t\tif (bfa_tskim_match_scope(tskim, scsilun)) {\n\t\t\tlist_del(&ioim->qe);\n\t\t\tlist_add_tail(&ioim->qe, &tskim->io_q);\n\t\t}\n\t}\n\n\t \n\tlist_for_each_safe(qe, qen, &itnim->pending_q) {\n\t\tioim = (struct bfa_ioim_s *) qe;\n\t\tcmnd = (struct scsi_cmnd *) ioim->dio;\n\t\tint_to_scsilun(cmnd->device->lun, &scsilun);\n\t\tif (bfa_tskim_match_scope(tskim, scsilun)) {\n\t\t\tlist_del(&ioim->qe);\n\t\t\tlist_add_tail(&ioim->qe, &ioim->fcpim->ioim_comp_q);\n\t\t\tbfa_ioim_tov(ioim);\n\t\t}\n\t}\n}\n\n \nstatic void\nbfa_tskim_cleanp_comp(void *tskim_cbarg)\n{\n\tstruct bfa_tskim_s *tskim = tskim_cbarg;\n\n\tbfa_stats(tskim->itnim, tm_io_comps);\n\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_IOS_DONE);\n}\n\n \nstatic void\nbfa_tskim_cleanup_ios(struct bfa_tskim_s *tskim)\n{\n\tstruct bfa_ioim_s *ioim;\n\tstruct list_head\t*qe, *qen;\n\n\tbfa_wc_init(&tskim->wc, bfa_tskim_cleanp_comp, tskim);\n\n\tlist_for_each_safe(qe, qen, &tskim->io_q) {\n\t\tioim = (struct bfa_ioim_s *) qe;\n\t\tbfa_wc_up(&tskim->wc);\n\t\tbfa_ioim_cleanup_tm(ioim, tskim);\n\t}\n\n\tbfa_wc_wait(&tskim->wc);\n}\n\n \nstatic bfa_boolean_t\nbfa_tskim_send(struct bfa_tskim_s *tskim)\n{\n\tstruct bfa_itnim_s *itnim = tskim->itnim;\n\tstruct bfi_tskim_req_s *m;\n\n\t \n\tm = bfa_reqq_next(tskim->bfa, itnim->reqq);\n\tif (!m)\n\t\treturn BFA_FALSE;\n\n\t \n\tbfi_h2i_set(m->mh, BFI_MC_TSKIM, BFI_TSKIM_H2I_TM_REQ,\n\t\t\tbfa_fn_lpu(tskim->bfa));\n\n\tm->tsk_tag = cpu_to_be16(tskim->tsk_tag);\n\tm->itn_fhdl = tskim->itnim->rport->fw_handle;\n\tm->t_secs = tskim->tsecs;\n\tm->lun = tskim->lun;\n\tm->tm_flags = tskim->tm_cmnd;\n\n\t \n\tbfa_reqq_produce(tskim->bfa, itnim->reqq, m->mh);\n\treturn BFA_TRUE;\n}\n\n \nstatic bfa_boolean_t\nbfa_tskim_send_abort(struct bfa_tskim_s *tskim)\n{\n\tstruct bfa_itnim_s\t*itnim = tskim->itnim;\n\tstruct bfi_tskim_abortreq_s\t*m;\n\n\t \n\tm = bfa_reqq_next(tskim->bfa, itnim->reqq);\n\tif (!m)\n\t\treturn BFA_FALSE;\n\n\t \n\tbfi_h2i_set(m->mh, BFI_MC_TSKIM, BFI_TSKIM_H2I_ABORT_REQ,\n\t\t\tbfa_fn_lpu(tskim->bfa));\n\n\tm->tsk_tag  = cpu_to_be16(tskim->tsk_tag);\n\n\t \n\tbfa_reqq_produce(tskim->bfa, itnim->reqq, m->mh);\n\treturn BFA_TRUE;\n}\n\n \nstatic void\nbfa_tskim_qresume(void *cbarg)\n{\n\tstruct bfa_tskim_s *tskim = cbarg;\n\n\tbfa_stats(tskim->itnim, tm_qresumes);\n\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_QRESUME);\n}\n\n \nstatic void\nbfa_tskim_iocdisable_ios(struct bfa_tskim_s *tskim)\n{\n\tstruct bfa_ioim_s *ioim;\n\tstruct list_head\t*qe, *qen;\n\n\tlist_for_each_safe(qe, qen, &tskim->io_q) {\n\t\tioim = (struct bfa_ioim_s *) qe;\n\t\tbfa_ioim_iocdisable(ioim);\n\t}\n}\n\n \nvoid\nbfa_tskim_iodone(struct bfa_tskim_s *tskim)\n{\n\tbfa_wc_down(&tskim->wc);\n}\n\n \nvoid\nbfa_tskim_iocdisable(struct bfa_tskim_s *tskim)\n{\n\ttskim->notify = BFA_FALSE;\n\tbfa_stats(tskim->itnim, tm_iocdowns);\n\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_HWFAIL);\n}\n\n \nvoid\nbfa_tskim_cleanup(struct bfa_tskim_s *tskim)\n{\n\ttskim->notify = BFA_TRUE;\n\tbfa_stats(tskim->itnim, tm_cleanups);\n\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_CLEANUP);\n}\n\n \nvoid\nbfa_tskim_attach(struct bfa_fcpim_s *fcpim)\n{\n\tstruct bfa_tskim_s *tskim;\n\tstruct bfa_fcp_mod_s\t*fcp = fcpim->fcp;\n\tu16\ti;\n\n\tINIT_LIST_HEAD(&fcpim->tskim_free_q);\n\tINIT_LIST_HEAD(&fcpim->tskim_unused_q);\n\n\ttskim = (struct bfa_tskim_s *) bfa_mem_kva_curp(fcp);\n\tfcpim->tskim_arr = tskim;\n\n\tfor (i = 0; i < fcpim->num_tskim_reqs; i++, tskim++) {\n\t\t \n\t\tmemset(tskim, 0, sizeof(struct bfa_tskim_s));\n\t\ttskim->tsk_tag = i;\n\t\ttskim->bfa\t= fcpim->bfa;\n\t\ttskim->fcpim\t= fcpim;\n\t\ttskim->notify  = BFA_FALSE;\n\t\tbfa_reqq_winit(&tskim->reqq_wait, bfa_tskim_qresume,\n\t\t\t\t\ttskim);\n\t\tbfa_sm_set_state(tskim, bfa_tskim_sm_uninit);\n\n\t\tlist_add_tail(&tskim->qe, &fcpim->tskim_free_q);\n\t}\n\n\tbfa_mem_kva_curp(fcp) = (u8 *) tskim;\n}\n\nvoid\nbfa_tskim_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tstruct bfi_tskim_rsp_s *rsp = (struct bfi_tskim_rsp_s *) m;\n\tstruct bfa_tskim_s *tskim;\n\tu16\ttsk_tag = be16_to_cpu(rsp->tsk_tag);\n\n\ttskim = BFA_TSKIM_FROM_TAG(fcpim, tsk_tag);\n\tWARN_ON(tskim->tsk_tag != tsk_tag);\n\n\ttskim->tsk_status = rsp->tsk_status;\n\n\t \n\tif (rsp->tsk_status == BFI_TSKIM_STS_ABORTED) {\n\t\tbfa_stats(tskim->itnim, tm_cleanup_comps);\n\t\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_CLEANUP_DONE);\n\t} else if (rsp->tsk_status == BFI_TSKIM_STS_UTAG) {\n\t\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_UTAG);\n\t} else {\n\t\tbfa_stats(tskim->itnim, tm_fw_rsps);\n\t\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_DONE);\n\t}\n}\n\n\nstruct bfa_tskim_s *\nbfa_tskim_alloc(struct bfa_s *bfa, struct bfad_tskim_s *dtsk)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tstruct bfa_tskim_s *tskim;\n\n\tbfa_q_deq(&fcpim->tskim_free_q, &tskim);\n\n\tif (tskim)\n\t\ttskim->dtsk = dtsk;\n\n\treturn tskim;\n}\n\nvoid\nbfa_tskim_free(struct bfa_tskim_s *tskim)\n{\n\tWARN_ON(!bfa_q_is_on_q_func(&tskim->itnim->tsk_q, &tskim->qe));\n\tlist_del(&tskim->qe);\n\tlist_add_tail(&tskim->qe, &tskim->fcpim->tskim_free_q);\n}\n\n \nvoid\nbfa_tskim_start(struct bfa_tskim_s *tskim, struct bfa_itnim_s *itnim,\n\t\t\tstruct scsi_lun lun,\n\t\t\tenum fcp_tm_cmnd tm_cmnd, u8 tsecs)\n{\n\ttskim->itnim\t= itnim;\n\ttskim->lun\t= lun;\n\ttskim->tm_cmnd = tm_cmnd;\n\ttskim->tsecs\t= tsecs;\n\ttskim->notify  = BFA_FALSE;\n\tbfa_stats(itnim, tm_cmnds);\n\n\tlist_add_tail(&tskim->qe, &itnim->tsk_q);\n\tbfa_sm_send_event(tskim, BFA_TSKIM_SM_START);\n}\n\nvoid\nbfa_tskim_res_recfg(struct bfa_s *bfa, u16 num_tskim_fw)\n{\n\tstruct bfa_fcpim_s\t*fcpim = BFA_FCPIM(bfa);\n\tstruct list_head\t*qe;\n\tint\ti;\n\n\tfor (i = 0; i < (fcpim->num_tskim_reqs - num_tskim_fw); i++) {\n\t\tbfa_q_deq_tail(&fcpim->tskim_free_q, &qe);\n\t\tlist_add_tail(qe, &fcpim->tskim_unused_q);\n\t}\n}\n\nvoid\nbfa_fcp_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *minfo,\n\t\tstruct bfa_s *bfa)\n{\n\tstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\n\tstruct bfa_mem_kva_s *fcp_kva = BFA_MEM_FCP_KVA(bfa);\n\tstruct bfa_mem_dma_s *seg_ptr;\n\tu16\tnsegs, idx, per_seg_ios, num_io_req;\n\tu32\tkm_len = 0;\n\n\t \n\tif (cfg->fwcfg.num_ioim_reqs &&\n\t    cfg->fwcfg.num_ioim_reqs < BFA_IOIM_MIN)\n\t\tcfg->fwcfg.num_ioim_reqs = BFA_IOIM_MIN;\n\telse if (cfg->fwcfg.num_ioim_reqs > BFA_IOIM_MAX)\n\t\tcfg->fwcfg.num_ioim_reqs = BFA_IOIM_MAX;\n\n\tif (cfg->fwcfg.num_fwtio_reqs > BFA_FWTIO_MAX)\n\t\tcfg->fwcfg.num_fwtio_reqs = BFA_FWTIO_MAX;\n\n\tnum_io_req = (cfg->fwcfg.num_ioim_reqs + cfg->fwcfg.num_fwtio_reqs);\n\tif (num_io_req > BFA_IO_MAX) {\n\t\tif (cfg->fwcfg.num_ioim_reqs && cfg->fwcfg.num_fwtio_reqs) {\n\t\t\tcfg->fwcfg.num_ioim_reqs = BFA_IO_MAX/2;\n\t\t\tcfg->fwcfg.num_fwtio_reqs = BFA_IO_MAX/2;\n\t\t} else if (cfg->fwcfg.num_fwtio_reqs)\n\t\t\tcfg->fwcfg.num_fwtio_reqs = BFA_FWTIO_MAX;\n\t\telse\n\t\t\tcfg->fwcfg.num_ioim_reqs = BFA_IOIM_MAX;\n\t}\n\n\tbfa_fcpim_meminfo(cfg, &km_len);\n\n\tnum_io_req = (cfg->fwcfg.num_ioim_reqs + cfg->fwcfg.num_fwtio_reqs);\n\tkm_len += num_io_req * sizeof(struct bfa_iotag_s);\n\tkm_len += cfg->fwcfg.num_rports * sizeof(struct bfa_itn_s);\n\n\t \n\tnsegs = BFI_MEM_DMA_NSEGS(num_io_req, BFI_IOIM_SNSLEN);\n\tper_seg_ios = BFI_MEM_NREQS_SEG(BFI_IOIM_SNSLEN);\n\n\tbfa_mem_dma_seg_iter(fcp, seg_ptr, nsegs, idx) {\n\t\tif (num_io_req >= per_seg_ios) {\n\t\t\tnum_io_req -= per_seg_ios;\n\t\t\tbfa_mem_dma_setup(minfo, seg_ptr,\n\t\t\t\tper_seg_ios * BFI_IOIM_SNSLEN);\n\t\t} else\n\t\t\tbfa_mem_dma_setup(minfo, seg_ptr,\n\t\t\t\tnum_io_req * BFI_IOIM_SNSLEN);\n\t}\n\n\t \n\tbfa_mem_kva_setup(minfo, fcp_kva, km_len);\n}\n\nvoid\nbfa_fcp_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\n\t\tstruct bfa_pcidev_s *pcidev)\n{\n\tstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\n\tstruct bfa_mem_dma_s *seg_ptr;\n\tu16\tidx, nsegs, num_io_req;\n\n\tfcp->max_ioim_reqs = cfg->fwcfg.num_ioim_reqs;\n\tfcp->num_ioim_reqs = cfg->fwcfg.num_ioim_reqs;\n\tfcp->num_fwtio_reqs  = cfg->fwcfg.num_fwtio_reqs;\n\tfcp->num_itns   = cfg->fwcfg.num_rports;\n\tfcp->bfa = bfa;\n\n\t \n\tnum_io_req = (cfg->fwcfg.num_ioim_reqs + cfg->fwcfg.num_fwtio_reqs);\n\tnsegs = BFI_MEM_DMA_NSEGS(num_io_req, BFI_IOIM_SNSLEN);\n\n\tbfa_mem_dma_seg_iter(fcp, seg_ptr, nsegs, idx) {\n\n\t\tif (!bfa_mem_dma_virt(seg_ptr))\n\t\t\tbreak;\n\n\t\tfcp->snsbase[idx].pa = bfa_mem_dma_phys(seg_ptr);\n\t\tfcp->snsbase[idx].kva = bfa_mem_dma_virt(seg_ptr);\n\t\tbfa_iocfc_set_snsbase(bfa, idx, fcp->snsbase[idx].pa);\n\t}\n\n\tfcp->throttle_update_required = 1;\n\tbfa_fcpim_attach(fcp, bfad, cfg, pcidev);\n\n\tbfa_iotag_attach(fcp);\n\n\tfcp->itn_arr = (struct bfa_itn_s *) bfa_mem_kva_curp(fcp);\n\tbfa_mem_kva_curp(fcp) = (u8 *)fcp->itn_arr +\n\t\t\t(fcp->num_itns * sizeof(struct bfa_itn_s));\n\tmemset(fcp->itn_arr, 0,\n\t\t\t(fcp->num_itns * sizeof(struct bfa_itn_s)));\n}\n\nvoid\nbfa_fcp_iocdisable(struct bfa_s *bfa)\n{\n\tstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\n\n\tbfa_fcpim_iocdisable(fcp);\n}\n\nvoid\nbfa_fcp_res_recfg(struct bfa_s *bfa, u16 num_ioim_fw, u16 max_ioim_fw)\n{\n\tstruct bfa_fcp_mod_s\t*mod = BFA_FCP_MOD(bfa);\n\tstruct list_head\t*qe;\n\tint\ti;\n\n\t \n\tif (!mod->throttle_update_required)\n\t\treturn;\n\n\tfor (i = 0; i < (mod->num_ioim_reqs - num_ioim_fw); i++) {\n\t\tbfa_q_deq_tail(&mod->iotag_ioim_free_q, &qe);\n\t\tlist_add_tail(qe, &mod->iotag_unused_q);\n\t}\n\n\tif (mod->num_ioim_reqs != num_ioim_fw) {\n\t\tbfa_trc(bfa, mod->num_ioim_reqs);\n\t\tbfa_trc(bfa, num_ioim_fw);\n\t}\n\n\tmod->max_ioim_reqs = max_ioim_fw;\n\tmod->num_ioim_reqs = num_ioim_fw;\n\tmod->throttle_update_required = 0;\n}\n\nvoid\nbfa_itn_create(struct bfa_s *bfa, struct bfa_rport_s *rport,\n\t\tvoid (*isr)(struct bfa_s *bfa, struct bfi_msg_s *m))\n{\n\tstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\n\tstruct bfa_itn_s *itn;\n\n\titn =  BFA_ITN_FROM_TAG(fcp, rport->rport_tag);\n\titn->isr = isr;\n}\n\n \nvoid\nbfa_itn_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\n{\n\tstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\n\tunion bfi_itn_i2h_msg_u msg;\n\tstruct bfa_itn_s *itn;\n\n\tmsg.msg = m;\n\titn =  BFA_ITN_FROM_TAG(fcp, msg.create_rsp->bfa_handle);\n\n\tif (itn->isr)\n\t\titn->isr(bfa, m);\n\telse\n\t\tWARN_ON(1);\n}\n\nvoid\nbfa_iotag_attach(struct bfa_fcp_mod_s *fcp)\n{\n\tstruct bfa_iotag_s *iotag;\n\tu16\tnum_io_req, i;\n\n\tiotag = (struct bfa_iotag_s *) bfa_mem_kva_curp(fcp);\n\tfcp->iotag_arr = iotag;\n\n\tINIT_LIST_HEAD(&fcp->iotag_ioim_free_q);\n\tINIT_LIST_HEAD(&fcp->iotag_tio_free_q);\n\tINIT_LIST_HEAD(&fcp->iotag_unused_q);\n\n\tnum_io_req = fcp->num_ioim_reqs + fcp->num_fwtio_reqs;\n\tfor (i = 0; i < num_io_req; i++, iotag++) {\n\t\tmemset(iotag, 0, sizeof(struct bfa_iotag_s));\n\t\tiotag->tag = i;\n\t\tif (i < fcp->num_ioim_reqs)\n\t\t\tlist_add_tail(&iotag->qe, &fcp->iotag_ioim_free_q);\n\t\telse\n\t\t\tlist_add_tail(&iotag->qe, &fcp->iotag_tio_free_q);\n\t}\n\n\tbfa_mem_kva_curp(fcp) = (u8 *) iotag;\n}\n\n\n \nu16\nbfa_fcpim_get_throttle_cfg(struct bfa_s *bfa, u16 drv_cfg_param)\n{\n\tu16 tmp;\n\tstruct bfa_fcp_mod_s *fcp = BFA_FCP_MOD(bfa);\n\n\t \n\tif (!fcp->throttle_update_required)\n\t\treturn (u16)fcp->num_ioim_reqs;\n\n\ttmp = bfa_dconf_read_data_valid(bfa) ? bfa_fcpim_read_throttle(bfa) : 0;\n\tif (!tmp || (tmp > drv_cfg_param))\n\t\ttmp = drv_cfg_param;\n\n\treturn tmp;\n}\n\nbfa_status_t\nbfa_fcpim_write_throttle(struct bfa_s *bfa, u16 value)\n{\n\tif (!bfa_dconf_get_min_cfg(bfa)) {\n\t\tBFA_DCONF_MOD(bfa)->dconf->throttle_cfg.value = value;\n\t\tBFA_DCONF_MOD(bfa)->dconf->throttle_cfg.is_valid = 1;\n\t\treturn BFA_STATUS_OK;\n\t}\n\n\treturn BFA_STATUS_FAILED;\n}\n\nu16\nbfa_fcpim_read_throttle(struct bfa_s *bfa)\n{\n\tstruct bfa_throttle_cfg_s *throttle_cfg =\n\t\t\t&(BFA_DCONF_MOD(bfa)->dconf->throttle_cfg);\n\n\treturn ((!bfa_dconf_get_min_cfg(bfa)) ?\n\t       ((throttle_cfg->is_valid == 1) ? (throttle_cfg->value) : 0) : 0);\n}\n\nbfa_status_t\nbfa_fcpim_throttle_set(struct bfa_s *bfa, u16 value)\n{\n\t \n\tif ((bfa_dconf_get_min_cfg(bfa) == BFA_TRUE) ||\n\t    (!bfa_dconf_read_data_valid(bfa)))\n\t\treturn BFA_STATUS_FAILED;\n\n\tbfa_fcpim_write_throttle(bfa, value);\n\n\treturn bfa_dconf_update(bfa);\n}\n\nbfa_status_t\nbfa_fcpim_throttle_get(struct bfa_s *bfa, void *buf)\n{\n\tstruct bfa_fcpim_s *fcpim = BFA_FCPIM(bfa);\n\tstruct bfa_defs_fcpim_throttle_s throttle;\n\n\tif ((bfa_dconf_get_min_cfg(bfa) == BFA_TRUE) ||\n\t    (!bfa_dconf_read_data_valid(bfa)))\n\t\treturn BFA_STATUS_FAILED;\n\n\tmemset(&throttle, 0, sizeof(struct bfa_defs_fcpim_throttle_s));\n\n\tthrottle.cur_value = (u16)(fcpim->fcp->num_ioim_reqs);\n\tthrottle.cfg_value = bfa_fcpim_read_throttle(bfa);\n\tif (!throttle.cfg_value)\n\t\tthrottle.cfg_value = throttle.cur_value;\n\tthrottle.max_value = (u16)(fcpim->fcp->max_ioim_reqs);\n\tmemcpy(buf, &throttle, sizeof(struct bfa_defs_fcpim_throttle_s));\n\n\treturn BFA_STATUS_OK;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}