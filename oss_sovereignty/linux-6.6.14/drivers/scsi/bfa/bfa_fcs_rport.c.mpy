{
  "module_name": "bfa_fcs_rport.c",
  "hash_id": "2a26e59c3e70e137b6858462d54c8ce9fb899c817433d25f60412dace54e728e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/bfa/bfa_fcs_rport.c",
  "human_readable_source": "\n \n\n \n\n#include \"bfad_drv.h\"\n#include \"bfad_im.h\"\n#include \"bfa_fcs.h\"\n#include \"bfa_fcbuild.h\"\n\nBFA_TRC_FILE(FCS, RPORT);\n\nstatic u32\nbfa_fcs_rport_del_timeout = BFA_FCS_RPORT_DEF_DEL_TIMEOUT * 1000;\n\t  \n \nstatic u32 bfa_fcs_rport_max_logins = BFA_FCS_MAX_RPORT_LOGINS;\n\n \nstatic struct bfa_fcs_rport_s *bfa_fcs_rport_alloc(\n\t\tstruct bfa_fcs_lport_s *port, wwn_t pwwn, u32 rpid);\nstatic void\tbfa_fcs_rport_free(struct bfa_fcs_rport_s *rport);\nstatic void\tbfa_fcs_rport_hal_online(struct bfa_fcs_rport_s *rport);\nstatic void\tbfa_fcs_rport_fcs_online_action(struct bfa_fcs_rport_s *rport);\nstatic void\tbfa_fcs_rport_hal_online_action(struct bfa_fcs_rport_s *rport);\nstatic void\tbfa_fcs_rport_fcs_offline_action(struct bfa_fcs_rport_s *rport);\nstatic void\tbfa_fcs_rport_hal_offline_action(struct bfa_fcs_rport_s *rport);\nstatic void\tbfa_fcs_rport_update(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\tstruct fc_logi_s *plogi);\nstatic void\tbfa_fcs_rport_timeout(void *arg);\nstatic void\tbfa_fcs_rport_send_plogi(void *rport_cbarg,\n\t\t\t\t\t struct bfa_fcxp_s *fcxp_alloced);\nstatic void\tbfa_fcs_rport_send_plogiacc(void *rport_cbarg,\n\t\t\t\t\tstruct bfa_fcxp_s *fcxp_alloced);\nstatic void\tbfa_fcs_rport_plogi_response(void *fcsarg,\n\t\t\t\tstruct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t\tbfa_status_t req_status, u32 rsp_len,\n\t\t\t\tu32 resid_len, struct fchs_s *rsp_fchs);\nstatic void\tbfa_fcs_rport_send_adisc(void *rport_cbarg,\n\t\t\t\t\t struct bfa_fcxp_s *fcxp_alloced);\nstatic void\tbfa_fcs_rport_adisc_response(void *fcsarg,\n\t\t\t\tstruct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t\tbfa_status_t req_status, u32 rsp_len,\n\t\t\t\tu32 resid_len, struct fchs_s *rsp_fchs);\nstatic void\tbfa_fcs_rport_send_nsdisc(void *rport_cbarg,\n\t\t\t\t\t struct bfa_fcxp_s *fcxp_alloced);\nstatic void\tbfa_fcs_rport_gidpn_response(void *fcsarg,\n\t\t\t\tstruct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t\tbfa_status_t req_status, u32 rsp_len,\n\t\t\t\tu32 resid_len, struct fchs_s *rsp_fchs);\nstatic void\tbfa_fcs_rport_gpnid_response(void *fcsarg,\n\t\t\t\tstruct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t\tbfa_status_t req_status, u32 rsp_len,\n\t\t\t\tu32 resid_len, struct fchs_s *rsp_fchs);\nstatic void\tbfa_fcs_rport_send_logo(void *rport_cbarg,\n\t\t\t\t\tstruct bfa_fcxp_s *fcxp_alloced);\nstatic void\tbfa_fcs_rport_send_logo_acc(void *rport_cbarg);\nstatic void\tbfa_fcs_rport_process_prli(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\tstruct fchs_s *rx_fchs, u16 len);\nstatic void\tbfa_fcs_rport_send_ls_rjt(struct bfa_fcs_rport_s *rport,\n\t\t\t\tstruct fchs_s *rx_fchs, u8 reason_code,\n\t\t\t\t\t  u8 reason_code_expl);\nstatic void\tbfa_fcs_rport_process_adisc(struct bfa_fcs_rport_s *rport,\n\t\t\t\tstruct fchs_s *rx_fchs, u16 len);\nstatic void bfa_fcs_rport_send_prlo_acc(struct bfa_fcs_rport_s *rport);\nstatic void\tbfa_fcs_rport_hal_offline(struct bfa_fcs_rport_s *rport);\n\nstatic void\tbfa_fcs_rport_sm_uninit(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_plogi_sending(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_plogiacc_sending(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\t  enum rport_event event);\nstatic void\tbfa_fcs_rport_sm_plogi_retry(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_plogi(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_fc4_fcs_online(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_hal_online(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_online(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_nsquery_sending(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\t enum rport_event event);\nstatic void\tbfa_fcs_rport_sm_nsquery(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t enum rport_event event);\nstatic void\tbfa_fcs_rport_sm_adisc_online_sending(\n\t\t\tstruct bfa_fcs_rport_s *rport, enum rport_event event);\nstatic void\tbfa_fcs_rport_sm_adisc_online(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_adisc_offline_sending(struct bfa_fcs_rport_s\n\t\t\t\t\t*rport, enum rport_event event);\nstatic void\tbfa_fcs_rport_sm_adisc_offline(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_fc4_logorcv(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_fc4_logosend(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_fc4_offline(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_hcb_offline(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_hcb_logorcv(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_hcb_logosend(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_logo_sending(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_offline(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t enum rport_event event);\nstatic void\tbfa_fcs_rport_sm_nsdisc_sending(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_nsdisc_retry(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_nsdisc_sent(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_nsdisc_sent(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_fc4_off_delete(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\nstatic void\tbfa_fcs_rport_sm_delete_pending(struct bfa_fcs_rport_s *rport,\n\t\t\t\t\t\tenum rport_event event);\n\nstatic struct bfa_sm_table_s rport_sm_table[] = {\n\t{BFA_SM(bfa_fcs_rport_sm_uninit), BFA_RPORT_UNINIT},\n\t{BFA_SM(bfa_fcs_rport_sm_plogi_sending), BFA_RPORT_PLOGI},\n\t{BFA_SM(bfa_fcs_rport_sm_plogiacc_sending), BFA_RPORT_ONLINE},\n\t{BFA_SM(bfa_fcs_rport_sm_plogi_retry), BFA_RPORT_PLOGI_RETRY},\n\t{BFA_SM(bfa_fcs_rport_sm_plogi), BFA_RPORT_PLOGI},\n\t{BFA_SM(bfa_fcs_rport_sm_fc4_fcs_online), BFA_RPORT_ONLINE},\n\t{BFA_SM(bfa_fcs_rport_sm_hal_online), BFA_RPORT_ONLINE},\n\t{BFA_SM(bfa_fcs_rport_sm_online), BFA_RPORT_ONLINE},\n\t{BFA_SM(bfa_fcs_rport_sm_nsquery_sending), BFA_RPORT_NSQUERY},\n\t{BFA_SM(bfa_fcs_rport_sm_nsquery), BFA_RPORT_NSQUERY},\n\t{BFA_SM(bfa_fcs_rport_sm_adisc_online_sending), BFA_RPORT_ADISC},\n\t{BFA_SM(bfa_fcs_rport_sm_adisc_online), BFA_RPORT_ADISC},\n\t{BFA_SM(bfa_fcs_rport_sm_adisc_offline_sending), BFA_RPORT_ADISC},\n\t{BFA_SM(bfa_fcs_rport_sm_adisc_offline), BFA_RPORT_ADISC},\n\t{BFA_SM(bfa_fcs_rport_sm_fc4_logorcv), BFA_RPORT_LOGORCV},\n\t{BFA_SM(bfa_fcs_rport_sm_fc4_logosend), BFA_RPORT_LOGO},\n\t{BFA_SM(bfa_fcs_rport_sm_fc4_offline), BFA_RPORT_OFFLINE},\n\t{BFA_SM(bfa_fcs_rport_sm_hcb_offline), BFA_RPORT_OFFLINE},\n\t{BFA_SM(bfa_fcs_rport_sm_hcb_logorcv), BFA_RPORT_LOGORCV},\n\t{BFA_SM(bfa_fcs_rport_sm_hcb_logosend), BFA_RPORT_LOGO},\n\t{BFA_SM(bfa_fcs_rport_sm_logo_sending), BFA_RPORT_LOGO},\n\t{BFA_SM(bfa_fcs_rport_sm_offline), BFA_RPORT_OFFLINE},\n\t{BFA_SM(bfa_fcs_rport_sm_nsdisc_sending), BFA_RPORT_NSDISC},\n\t{BFA_SM(bfa_fcs_rport_sm_nsdisc_retry), BFA_RPORT_NSDISC},\n\t{BFA_SM(bfa_fcs_rport_sm_nsdisc_sent), BFA_RPORT_NSDISC},\n};\n\n \nstatic void\nbfa_fcs_rport_sm_uninit(struct bfa_fcs_rport_s *rport, enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_PLOGI_SEND:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\n\t\trport->plogi_retries = 0;\n\t\tbfa_fcs_rport_send_plogi(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_hal_online);\n\t\tbfa_fcs_rport_hal_online(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\tcase RPSM_EVENT_ADDRESS_DISC:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\n\t\trport->ns_retries = 0;\n\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_plogi_sending(struct bfa_fcs_rport_s *rport,\n\t enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FCXP_SENT:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\tcase RPSM_EVENT_FAB_SCN:\n\t\t \n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tWARN_ON(!(bfa_fcport_get_topology(rport->port->fcs->bfa) !=\n\t\t\t\t\tBFA_PORT_TOPOLOGY_LOOP));\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\n\t\trport->ns_retries = 0;\n\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\trport->pid = 0;\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_plogiacc_sending(struct bfa_fcs_rport_s *rport,\n\t enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FCXP_SENT:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\n\t\tbfa_fcs_rport_fcs_online_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\tcase RPSM_EVENT_PLOGI_COMP:\n\tcase RPSM_EVENT_FAB_SCN:\n\t\t \n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\n\t\trport->ns_retries = 0;\n\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\trport->pid = 0;\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_HCB_OFFLINE:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_plogi_retry(struct bfa_fcs_rport_s *rport,\n\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_TIMEOUT:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\n\t\tbfa_fcs_rport_send_plogi(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PRLO_RCVD:\n\tcase RPSM_EVENT_LOGO_RCVD:\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\tcase RPSM_EVENT_FAB_SCN:\n\t\tbfa_timer_stop(&rport->timer);\n\t\tWARN_ON(!(bfa_fcport_get_topology(rport->port->fcs->bfa) !=\n\t\t\t\t\tBFA_PORT_TOPOLOGY_LOOP));\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\n\t\trport->ns_retries = 0;\n\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\trport->pid = 0;\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_fcs_rport_fcs_online_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_plogi(struct bfa_fcs_rport_s *rport, enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_ACCEPTED:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\n\t\trport->plogi_retries = 0;\n\t\tbfa_fcs_rport_fcs_online_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\t\tbfa_fcs_rport_send_logo_acc(rport);\n\t\tfallthrough;\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tif (rport->prlo == BFA_TRUE)\n\t\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tfallthrough;\n\tcase RPSM_EVENT_FAILED:\n\t\tif (rport->plogi_retries < BFA_FCS_RPORT_MAX_RETRIES) {\n\t\t\trport->plogi_retries++;\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_retry);\n\t\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\t\tBFA_FCS_RETRY_TIMEOUT);\n\t\t} else {\n\t\t\tbfa_stats(rport->port, rport_del_max_plogi_retry);\n\t\t\trport->old_pid = rport->pid;\n\t\t\trport->pid = 0;\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\t}\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_ONLINE:\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RETRY:\n\t\trport->plogi_retries = 0;\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_retry);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\t(FC_RA_TOV * 1000));\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\trport->pid = 0;\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\tcase RPSM_EVENT_FAB_SCN:\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tWARN_ON(!(bfa_fcport_get_topology(rport->port->fcs->bfa) !=\n\t\t\t\t\tBFA_PORT_TOPOLOGY_LOOP));\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\n\t\trport->ns_retries = 0;\n\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_fcs_online_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_fc4_fcs_online(struct bfa_fcs_rport_s *rport,\n\t\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FC4_FCS_ONLINE:\n\t\tif (rport->scsi_function == BFA_RPORT_INITIATOR) {\n\t\t\tif (!BFA_FCS_PID_IS_WKA(rport->pid))\n\t\t\t\tbfa_fcs_rpf_rport_online(rport);\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_online);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!rport->bfa_rport)\n\t\t\trport->bfa_rport =\n\t\t\t\tbfa_rport_create(rport->fcs->bfa, rport);\n\n\t\tif (rport->bfa_rport) {\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_hal_online);\n\t\t\tbfa_fcs_rport_hal_online(rport);\n\t\t} else {\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\n\t\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\t}\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\trport->plogi_pending = BFA_TRUE;\n\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\tcase RPSM_EVENT_FAB_SCN:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\n\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\n\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t\tbreak;\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_hal_online(struct bfa_fcs_rport_s *rport,\n\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_HCB_ONLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_online);\n\t\tbfa_fcs_rport_hal_online_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbreak;\n\n\tcase RPSM_EVENT_PRLO_RCVD:\n\tcase RPSM_EVENT_LOGO_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\n\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAB_SCN:\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\trport->plogi_pending = BFA_TRUE;\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\n\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_online(struct bfa_fcs_rport_s *rport, enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FAB_SCN:\n\t\tif (bfa_fcs_fabric_is_switched(rport->port->fabric)) {\n\t\t\tbfa_sm_set_state(rport,\n\t\t\t\t\t bfa_fcs_rport_sm_nsquery_sending);\n\t\t\trport->ns_retries = 0;\n\t\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\t} else {\n\t\t\tbfa_sm_set_state(rport,\n\t\t\t\tbfa_fcs_rport_sm_adisc_online_sending);\n\t\t\tbfa_fcs_rport_send_adisc(rport, NULL);\n\t\t}\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_ONLINE:\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_nsquery_sending(struct bfa_fcs_rport_s *rport,\n\t enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FCXP_SENT:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsquery);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAB_SCN:\n\t\t \n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_nsquery(struct bfa_fcs_rport_s *rport, enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_ACCEPTED:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_adisc_online_sending);\n\t\tbfa_fcs_rport_send_adisc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAILED:\n\t\trport->ns_retries++;\n\t\tif (rport->ns_retries < BFA_FCS_RPORT_MAX_RETRIES) {\n\t\t\tbfa_sm_set_state(rport,\n\t\t\t\t\t bfa_fcs_rport_sm_nsquery_sending);\n\t\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\t} else {\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\t}\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAB_SCN:\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_adisc_online_sending(struct bfa_fcs_rport_s *rport,\n\t enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FCXP_SENT:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_adisc_online);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAB_SCN:\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_adisc_online(struct bfa_fcs_rport_s *rport,\n\t\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_ACCEPTED:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_online);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\t \n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tfallthrough;\n\n\tcase RPSM_EVENT_FAILED:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAB_SCN:\n\t\t \n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_hal_offline_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_adisc_offline_sending(struct bfa_fcs_rport_s *rport,\n\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FCXP_SENT:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_adisc_offline);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa,\n\t\t\t&rport->fcxp_wqe);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_adisc_offline(struct bfa_fcs_rport_s *rport,\n\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_ACCEPTED:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_hal_online);\n\t\tbfa_fcs_rport_hal_online(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAILED:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_fc4_logorcv(struct bfa_fcs_rport_s *rport,\n\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FC4_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_hcb_logorcv);\n\t\tbfa_fcs_rport_hal_offline(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tif (rport->pid && (rport->prlo == BFA_TRUE))\n\t\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\t\tif (rport->pid && (rport->prlo == BFA_FALSE))\n\t\t\tbfa_fcs_rport_send_logo_acc(rport);\n\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_off_delete);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_ONLINE:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\tcase RPSM_EVENT_HCB_ONLINE:\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_fc4_logosend(struct bfa_fcs_rport_s *rport,\n\t enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FC4_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_hcb_logosend);\n\t\tbfa_fcs_rport_hal_offline(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\t\tbfa_fcs_rport_send_logo_acc(rport);\n\t\tfallthrough;\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tif (rport->prlo == BFA_TRUE)\n\t\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_off_delete);\n\t\tbreak;\n\n\tcase RPSM_EVENT_HCB_ONLINE:\n\tcase RPSM_EVENT_DELETE:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_fc4_offline(struct bfa_fcs_rport_s *rport,\n\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FC4_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_hcb_offline);\n\t\tbfa_fcs_rport_hal_offline(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_ONLINE:\n\t\tbreak;\n\tcase RPSM_EVENT_LOGO_RCVD:\n\t\t \n\t\tbfa_fcs_rport_send_logo_acc(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\tcase RPSM_EVENT_HCB_ONLINE:\n\tcase RPSM_EVENT_FAB_SCN:\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\t \n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_hcb_offline(struct bfa_fcs_rport_s *rport,\n\t\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_HCB_OFFLINE:\n\t\tif (bfa_fcs_lport_is_online(rport->port) &&\n\t\t    (rport->plogi_pending)) {\n\t\t\trport->plogi_pending = BFA_FALSE;\n\t\t\tbfa_sm_set_state(rport,\n\t\t\t\tbfa_fcs_rport_sm_plogiacc_sending);\n\t\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\t\tbreak;\n\t\t}\n\t\tfallthrough;\n\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tif (!bfa_fcs_lport_is_online(rport->port)) {\n\t\t\trport->pid = 0;\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\t\tbreak;\n\t\t}\n\t\tif (bfa_fcs_fabric_is_switched(rport->port->fabric)) {\n\t\t\tbfa_sm_set_state(rport,\n\t\t\t\tbfa_fcs_rport_sm_nsdisc_sending);\n\t\t\trport->ns_retries = 0;\n\t\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\t} else if (bfa_fcport_get_topology(rport->port->fcs->bfa) ==\n\t\t\t\t\tBFA_PORT_TOPOLOGY_LOOP) {\n\t\t\tif (rport->scn_online) {\n\t\t\t\tbfa_sm_set_state(rport,\n\t\t\t\t\tbfa_fcs_rport_sm_adisc_offline_sending);\n\t\t\t\tbfa_fcs_rport_send_adisc(rport, NULL);\n\t\t\t} else {\n\t\t\t\tbfa_sm_set_state(rport,\n\t\t\t\t\tbfa_fcs_rport_sm_offline);\n\t\t\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\t\t}\n\t\t} else {\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\n\t\t\trport->plogi_retries = 0;\n\t\t\tbfa_fcs_rport_send_plogi(rport, NULL);\n\t\t}\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_ONLINE:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\tcase RPSM_EVENT_FAB_SCN:\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_hcb_logorcv(struct bfa_fcs_rport_s *rport,\n\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_HCB_OFFLINE:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tif (rport->pid && (rport->prlo == BFA_TRUE))\n\t\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\t\tif (rport->pid && (rport->prlo == BFA_FALSE))\n\t\t\tbfa_fcs_rport_send_logo_acc(rport);\n\t\t \n\t\tif (bfa_fcs_lport_is_online(rport->port) &&\n\t\t\t(!BFA_FCS_PID_IS_WKA(rport->pid))) {\n\t\t\tif (bfa_fcs_fabric_is_switched(rport->port->fabric)) {\n\t\t\t\tbfa_sm_set_state(rport,\n\t\t\t\t\tbfa_fcs_rport_sm_nsdisc_sending);\n\t\t\t\trport->ns_retries = 0;\n\t\t\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tbfa_sm_set_state(rport,\n\t\t\t\t\tbfa_fcs_rport_sm_plogi_sending);\n\t\t\t\trport->plogi_retries = 0;\n\t\t\t\tbfa_fcs_rport_send_plogi(rport, NULL);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tif (!BFA_FCS_PID_IS_WKA(rport->pid))\n\t\t\t\trport->pid = 0;\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\t}\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_delete_pending);\n\t\tif (rport->pid && (rport->prlo == BFA_TRUE))\n\t\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\t\tif (rport->pid && (rport->prlo == BFA_FALSE))\n\t\t\tbfa_fcs_rport_send_logo_acc(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_hcb_offline);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_ONLINE:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_hcb_logosend(struct bfa_fcs_rport_s *rport,\n\t\t enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_HCB_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_logo_sending);\n\t\tbfa_fcs_rport_send_logo(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\t\tbfa_fcs_rport_send_logo_acc(rport);\n\t\tfallthrough;\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tif (rport->prlo == BFA_TRUE)\n\t\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_delete_pending);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_ONLINE:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_logo_sending(struct bfa_fcs_rport_s *rport,\n\t enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FCXP_SENT:\n\t\t \n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_ONLINE:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\tcase RPSM_EVENT_FAB_SCN:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\t\tbfa_fcs_rport_send_logo_acc(rport);\n\t\tfallthrough;\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tif (rport->prlo == BFA_TRUE)\n\t\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_offline(struct bfa_fcs_rport_s *rport, enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_TIMEOUT:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAB_SCN:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tbfa_timer_stop(&rport->timer);\n\t\tWARN_ON(!(bfa_fcport_get_topology(rport->port->fcs->bfa) !=\n\t\t\t\t\tBFA_PORT_TOPOLOGY_LOOP));\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\n\t\trport->ns_retries = 0;\n\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_SCN_OFFLINE:\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_fcs_rport_fcs_online_action(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_SCN_ONLINE:\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\n\t\tbfa_fcs_rport_send_plogi(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_SEND:\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\n\t\trport->plogi_retries = 0;\n\t\tbfa_fcs_rport_send_plogi(rport, NULL);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_nsdisc_sending(struct bfa_fcs_rport_s *rport,\n\t enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FCXP_SENT:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sent);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAB_SCN:\n\tcase RPSM_EVENT_LOGO_RCVD:\n\tcase RPSM_EVENT_PRLO_RCVD:\n\tcase RPSM_EVENT_PLOGI_SEND:\n\t\tbreak;\n\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\trport->ns_retries = 0;  \n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\n\t\tbfa_fcs_rport_fcs_online_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_nsdisc_retry(struct bfa_fcs_rport_s *rport,\n\t enum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_TIMEOUT:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\n\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAB_SCN:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\n\t\tbfa_timer_stop(&rport->timer);\n\t\trport->ns_retries = 0;\n\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\trport->pid = 0;\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\t\tbfa_fcs_rport_send_logo_acc(rport);\n\t\tbreak;\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\n\t\tbfa_timer_stop(&rport->timer);\n\t\tbfa_fcs_rport_fcs_online_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_nsdisc_sent(struct bfa_fcs_rport_s *rport,\n\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_ACCEPTED:\n\tcase RPSM_EVENT_ADDRESS_CHANGE:\n\t\tif (rport->pid) {\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\n\t\t\tbfa_fcs_rport_send_plogi(rport, NULL);\n\t\t} else {\n\t\t\tbfa_sm_set_state(rport,\n\t\t\t\t bfa_fcs_rport_sm_nsdisc_sending);\n\t\t\trport->ns_retries = 0;\n\t\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\t}\n\t\tbreak;\n\n\tcase RPSM_EVENT_FAILED:\n\t\trport->ns_retries++;\n\t\tif (rport->ns_retries < BFA_FCS_RPORT_MAX_RETRIES) {\n\t\t\tbfa_sm_set_state(rport,\n\t\t\t\t bfa_fcs_rport_sm_nsdisc_sending);\n\t\t\tbfa_fcs_rport_send_nsdisc(rport, NULL);\n\t\t} else {\n\t\t\trport->old_pid = rport->pid;\n\t\t\trport->pid = 0;\n\t\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\t}\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_send_plogiacc(rport, NULL);\n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_IMP:\n\t\trport->pid = 0;\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_timer_start(rport->fcs->bfa, &rport->timer,\n\t\t\t\tbfa_fcs_rport_timeout, rport,\n\t\t\t\tbfa_fcs_rport_del_timeout);\n\t\tbreak;\n\n\n\tcase RPSM_EVENT_PRLO_RCVD:\n\t\tbfa_fcs_rport_send_prlo_acc(rport);\n\t\tbreak;\n\tcase RPSM_EVENT_FAB_SCN:\n\t\t \n\t\tbreak;\n\n\tcase RPSM_EVENT_LOGO_RCVD:\n\t\t \n\t\tbfa_fcs_rport_send_logo_acc(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_PLOGI_COMP:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\n\t\tbfa_fcxp_discard(rport->fcxp);\n\t\tbfa_fcs_rport_fcs_online_action(rport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_fc4_off_delete(struct bfa_fcs_rport_s *rport,\n\t\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_FC4_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_delete_pending);\n\t\tbfa_fcs_rport_hal_offline(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t\tbreak;\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_sm_delete_pending(struct bfa_fcs_rport_s *rport,\n\t\t\t\tenum rport_event event)\n{\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPSM_EVENT_HCB_OFFLINE:\n\t\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\t\tbfa_fcs_rport_free(rport);\n\t\tbreak;\n\n\tcase RPSM_EVENT_DELETE:\n\tcase RPSM_EVENT_LOGO_IMP:\n\tcase RPSM_EVENT_PLOGI_RCVD:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\n \n\nstatic void\nbfa_fcs_rport_send_plogi(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\n{\n\tstruct bfa_fcs_rport_s *rport = rport_cbarg;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fchs_s\tfchs;\n\tint\t\tlen;\n\tstruct bfa_fcxp_s *fcxp;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\n\tfcxp = fcxp_alloced ? fcxp_alloced :\n\t       bfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\n\tif (!fcxp) {\n\t\tbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\n\t\t\t\tbfa_fcs_rport_send_plogi, rport, BFA_TRUE);\n\t\treturn;\n\t}\n\trport->fcxp = fcxp;\n\n\tlen = fc_plogi_build(&fchs, bfa_fcxp_get_reqbuf(fcxp), rport->pid,\n\t\t\t\tbfa_fcs_lport_get_fcid(port), 0,\n\t\t\t\tport->port_cfg.pwwn, port->port_cfg.nwwn,\n\t\t\t\tbfa_fcport_get_maxfrsize(port->fcs->bfa),\n\t\t\t\tbfa_fcport_get_rx_bbcredit(port->fcs->bfa));\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\n\t\t\tFC_CLASS_3, len, &fchs, bfa_fcs_rport_plogi_response,\n\t\t\t(void *)rport, FC_MAX_PDUSZ, FC_ELS_TOV);\n\n\trport->stats.plogis++;\n\tbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\n}\n\nstatic void\nbfa_fcs_rport_plogi_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t\tbfa_status_t req_status, u32 rsp_len,\n\t\t\t\tu32 resid_len, struct fchs_s *rsp_fchs)\n{\n\tstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\n\tstruct fc_logi_s\t*plogi_rsp;\n\tstruct fc_ls_rjt_s\t*ls_rjt;\n\tstruct bfa_fcs_rport_s *twin;\n\tstruct list_head\t*qe;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\n\t \n\tif (req_status != BFA_STATUS_OK) {\n\t\tbfa_trc(rport->fcs, req_status);\n\t\trport->stats.plogi_failed++;\n\t\tbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\n\t\treturn;\n\t}\n\n\tplogi_rsp = (struct fc_logi_s *) BFA_FCXP_RSP_PLD(fcxp);\n\n\t \n\tif (plogi_rsp->els_cmd.els_code != FC_ELS_ACC) {\n\t\tls_rjt = (struct fc_ls_rjt_s *) BFA_FCXP_RSP_PLD(fcxp);\n\n\t\tbfa_trc(rport->fcs, ls_rjt->reason_code);\n\t\tbfa_trc(rport->fcs, ls_rjt->reason_code_expl);\n\n\t\tif ((ls_rjt->reason_code == FC_LS_RJT_RSN_UNABLE_TO_PERF_CMD) &&\n\t\t (ls_rjt->reason_code_expl == FC_LS_RJT_EXP_INSUFF_RES)) {\n\t\t\trport->stats.rjt_insuff_res++;\n\t\t\tbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_RETRY);\n\t\t\treturn;\n\t\t}\n\n\t\trport->stats.plogi_rejects++;\n\t\tbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\n\t\treturn;\n\t}\n\n\t \n\tlist_for_each(qe, &rport->port->rport_q) {\n\t\ttwin = (struct bfa_fcs_rport_s *) qe;\n\t\tif (twin == rport)\n\t\t\tcontinue;\n\t\tif (!rport->pwwn && (plogi_rsp->port_name == twin->pwwn)) {\n\t\t\tbfa_trc(rport->fcs, twin->pid);\n\t\t\tbfa_trc(rport->fcs, rport->pid);\n\n\t\t\t \n\t\t\ttwin->stats.plogis  += rport->stats.plogis;\n\t\t\ttwin->stats.plogi_rejects  +=\n\t\t\t\t rport->stats.plogi_rejects;\n\t\t\ttwin->stats.plogi_timeouts  +=\n\t\t\t\t rport->stats.plogi_timeouts;\n\t\t\ttwin->stats.plogi_failed +=\n\t\t\t\t rport->stats.plogi_failed;\n\t\t\ttwin->stats.plogi_rcvd\t  += rport->stats.plogi_rcvd;\n\t\t\ttwin->stats.plogi_accs++;\n\n\t\t\tbfa_sm_send_event(rport, RPSM_EVENT_DELETE);\n\n\t\t\tbfa_fcs_rport_update(twin, plogi_rsp);\n\t\t\ttwin->pid = rsp_fchs->s_id;\n\t\t\tbfa_sm_send_event(twin, RPSM_EVENT_PLOGI_COMP);\n\t\t\treturn;\n\t\t}\n\t}\n\n\t \n\trport->stats.plogi_accs++;\n\tbfa_fcs_rport_update(rport, plogi_rsp);\n\tbfa_sm_send_event(rport, RPSM_EVENT_ACCEPTED);\n}\n\nstatic void\nbfa_fcs_rport_send_plogiacc(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\n{\n\tstruct bfa_fcs_rport_s *rport = rport_cbarg;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fchs_s\t\tfchs;\n\tint\t\tlen;\n\tstruct bfa_fcxp_s *fcxp;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->reply_oxid);\n\n\tfcxp = fcxp_alloced ? fcxp_alloced :\n\t       bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\n\tif (!fcxp) {\n\t\tbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\n\t\t\t\tbfa_fcs_rport_send_plogiacc, rport, BFA_FALSE);\n\t\treturn;\n\t}\n\trport->fcxp = fcxp;\n\n\tlen = fc_plogi_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t\t rport->pid, bfa_fcs_lport_get_fcid(port),\n\t\t\t\t rport->reply_oxid, port->port_cfg.pwwn,\n\t\t\t\t port->port_cfg.nwwn,\n\t\t\t\t bfa_fcport_get_maxfrsize(port->fcs->bfa),\n\t\t\t\t bfa_fcport_get_rx_bbcredit(port->fcs->bfa));\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\n\t\t\tFC_CLASS_3, len, &fchs, NULL, NULL, FC_MAX_PDUSZ, 0);\n\n\tbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\n}\n\nstatic void\nbfa_fcs_rport_send_adisc(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\n{\n\tstruct bfa_fcs_rport_s *rport = rport_cbarg;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fchs_s\t\tfchs;\n\tint\t\tlen;\n\tstruct bfa_fcxp_s *fcxp;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\n\tfcxp = fcxp_alloced ? fcxp_alloced :\n\t       bfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\n\tif (!fcxp) {\n\t\tbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\n\t\t\t\tbfa_fcs_rport_send_adisc, rport, BFA_TRUE);\n\t\treturn;\n\t}\n\trport->fcxp = fcxp;\n\n\tlen = fc_adisc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp), rport->pid,\n\t\t\t\tbfa_fcs_lport_get_fcid(port), 0,\n\t\t\t\tport->port_cfg.pwwn, port->port_cfg.nwwn);\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\n\t\t\tFC_CLASS_3, len, &fchs, bfa_fcs_rport_adisc_response,\n\t\t\trport, FC_MAX_PDUSZ, FC_ELS_TOV);\n\n\trport->stats.adisc_sent++;\n\tbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\n}\n\nstatic void\nbfa_fcs_rport_adisc_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t\tbfa_status_t req_status, u32 rsp_len,\n\t\t\t\tu32 resid_len, struct fchs_s *rsp_fchs)\n{\n\tstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\n\tvoid\t\t*pld = bfa_fcxp_get_rspbuf(fcxp);\n\tstruct fc_ls_rjt_s\t*ls_rjt;\n\n\tif (req_status != BFA_STATUS_OK) {\n\t\tbfa_trc(rport->fcs, req_status);\n\t\trport->stats.adisc_failed++;\n\t\tbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\n\t\treturn;\n\t}\n\n\tif (fc_adisc_rsp_parse((struct fc_adisc_s *)pld, rsp_len, rport->pwwn,\n\t\t\t\trport->nwwn)  == FC_PARSE_OK) {\n\t\trport->stats.adisc_accs++;\n\t\tbfa_sm_send_event(rport, RPSM_EVENT_ACCEPTED);\n\t\treturn;\n\t}\n\n\trport->stats.adisc_rejects++;\n\tls_rjt = pld;\n\tbfa_trc(rport->fcs, ls_rjt->els_cmd.els_code);\n\tbfa_trc(rport->fcs, ls_rjt->reason_code);\n\tbfa_trc(rport->fcs, ls_rjt->reason_code_expl);\n\tbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\n}\n\nstatic void\nbfa_fcs_rport_send_nsdisc(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\n{\n\tstruct bfa_fcs_rport_s *rport = rport_cbarg;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fchs_s\tfchs;\n\tstruct bfa_fcxp_s *fcxp;\n\tint\t\tlen;\n\tbfa_cb_fcxp_send_t cbfn;\n\n\tbfa_trc(rport->fcs, rport->pid);\n\n\tfcxp = fcxp_alloced ? fcxp_alloced :\n\t       bfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\n\tif (!fcxp) {\n\t\tbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\n\t\t\t\tbfa_fcs_rport_send_nsdisc, rport, BFA_TRUE);\n\t\treturn;\n\t}\n\trport->fcxp = fcxp;\n\n\tif (rport->pwwn) {\n\t\tlen = fc_gidpn_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t\tbfa_fcs_lport_get_fcid(port), 0, rport->pwwn);\n\t\tcbfn = bfa_fcs_rport_gidpn_response;\n\t} else {\n\t\tlen = fc_gpnid_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t\tbfa_fcs_lport_get_fcid(port), 0, rport->pid);\n\t\tcbfn = bfa_fcs_rport_gpnid_response;\n\t}\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\n\t\t\tFC_CLASS_3, len, &fchs, cbfn,\n\t\t\t(void *)rport, FC_MAX_PDUSZ, FC_FCCT_TOV);\n\n\tbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\n}\n\nstatic void\nbfa_fcs_rport_gidpn_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t\tbfa_status_t req_status, u32 rsp_len,\n\t\t\t\tu32 resid_len, struct fchs_s *rsp_fchs)\n{\n\tstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\n\tstruct ct_hdr_s\t*cthdr;\n\tstruct fcgs_gidpn_resp_s\t*gidpn_rsp;\n\tstruct bfa_fcs_rport_s\t*twin;\n\tstruct list_head\t*qe;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\n\tcthdr = (struct ct_hdr_s *) BFA_FCXP_RSP_PLD(fcxp);\n\tcthdr->cmd_rsp_code = be16_to_cpu(cthdr->cmd_rsp_code);\n\n\tif (cthdr->cmd_rsp_code == CT_RSP_ACCEPT) {\n\t\t \n\t\tgidpn_rsp = (struct fcgs_gidpn_resp_s *) (cthdr + 1);\n\n\t\tif (gidpn_rsp->dap == rport->pid) {\n\t\t\t \n\t\t\tbfa_sm_send_event(rport, RPSM_EVENT_ACCEPTED);\n\t\t} else {\n\t\t\t \n\t\t\tlist_for_each(qe, &rport->port->rport_q) {\n\t\t\t\ttwin = (struct bfa_fcs_rport_s *) qe;\n\t\t\t\tif (twin == rport)\n\t\t\t\t\tcontinue;\n\t\t\t\tif (gidpn_rsp->dap == twin->pid) {\n\t\t\t\t\tbfa_trc(rport->fcs, twin->pid);\n\t\t\t\t\tbfa_trc(rport->fcs, rport->pid);\n\n\t\t\t\t\ttwin->pid = 0;\n\t\t\t\t\tbfa_sm_send_event(twin,\n\t\t\t\t\t RPSM_EVENT_ADDRESS_CHANGE);\n\t\t\t\t}\n\t\t\t}\n\t\t\trport->pid = gidpn_rsp->dap;\n\t\t\tbfa_sm_send_event(rport, RPSM_EVENT_ADDRESS_CHANGE);\n\t\t}\n\t\treturn;\n\t}\n\n\t \n\tswitch (cthdr->reason_code) {\n\tcase CT_RSN_LOGICAL_BUSY:\n\t\t \n\t\tbfa_sm_send_event(rport, RPSM_EVENT_TIMEOUT);\n\t\tbreak;\n\n\tcase CT_RSN_UNABLE_TO_PERF:\n\t\t \n\t\tbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_fcs_rport_gpnid_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t\tbfa_status_t req_status, u32 rsp_len,\n\t\t\t\tu32 resid_len, struct fchs_s *rsp_fchs)\n{\n\tstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\n\tstruct ct_hdr_s\t*cthdr;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\n\tcthdr = (struct ct_hdr_s *) BFA_FCXP_RSP_PLD(fcxp);\n\tcthdr->cmd_rsp_code = be16_to_cpu(cthdr->cmd_rsp_code);\n\n\tif (cthdr->cmd_rsp_code == CT_RSP_ACCEPT) {\n\t\tbfa_sm_send_event(rport, RPSM_EVENT_ACCEPTED);\n\t\treturn;\n\t}\n\n\t \n\tswitch (cthdr->reason_code) {\n\tcase CT_RSN_LOGICAL_BUSY:\n\t\t \n\t\tbfa_sm_send_event(rport, RPSM_EVENT_TIMEOUT);\n\t\tbreak;\n\n\tcase CT_RSN_UNABLE_TO_PERF:\n\t\t \n\t\tbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\n\t\tbreak;\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_send_logo(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\n{\n\tstruct bfa_fcs_rport_s *rport = rport_cbarg;\n\tstruct bfa_fcs_lport_s *port;\n\tstruct fchs_s\tfchs;\n\tstruct bfa_fcxp_s *fcxp;\n\tu16\tlen;\n\n\tbfa_trc(rport->fcs, rport->pid);\n\n\tport = rport->port;\n\n\tfcxp = fcxp_alloced ? fcxp_alloced :\n\t       bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\n\tif (!fcxp) {\n\t\tbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\n\t\t\t\tbfa_fcs_rport_send_logo, rport, BFA_FALSE);\n\t\treturn;\n\t}\n\trport->fcxp = fcxp;\n\n\tlen = fc_logo_build(&fchs, bfa_fcxp_get_reqbuf(fcxp), rport->pid,\n\t\t\t\tbfa_fcs_lport_get_fcid(port), 0,\n\t\t\t\tbfa_fcs_lport_get_pwwn(port));\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\n\t\t\tFC_CLASS_3, len, &fchs, NULL,\n\t\t\trport, FC_MAX_PDUSZ, FC_ELS_TOV);\n\n\trport->stats.logos++;\n\tbfa_fcxp_discard(rport->fcxp);\n\tbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\n}\n\n \nstatic void\nbfa_fcs_rport_send_logo_acc(void *rport_cbarg)\n{\n\tstruct bfa_fcs_rport_s *rport = rport_cbarg;\n\tstruct bfa_fcs_lport_s *port;\n\tstruct fchs_s\tfchs;\n\tstruct bfa_fcxp_s *fcxp;\n\tu16\tlen;\n\n\tbfa_trc(rport->fcs, rport->pid);\n\n\tport = rport->port;\n\n\tfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\n\tif (!fcxp)\n\t\treturn;\n\n\trport->stats.logo_rcvd++;\n\tlen = fc_logo_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t\trport->pid, bfa_fcs_lport_get_fcid(port),\n\t\t\t\trport->reply_oxid);\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\n\t\t\tFC_CLASS_3, len, &fchs, NULL, NULL, FC_MAX_PDUSZ, 0);\n}\n\n \nstatic void\nbfa_fcs_rport_timeout(void *arg)\n{\n\tstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) arg;\n\n\trport->stats.plogi_timeouts++;\n\tbfa_stats(rport->port, rport_plogi_timeouts);\n\tbfa_sm_send_event(rport, RPSM_EVENT_TIMEOUT);\n}\n\nstatic void\nbfa_fcs_rport_process_prli(struct bfa_fcs_rport_s *rport,\n\t\t\tstruct fchs_s *rx_fchs, u16 len)\n{\n\tstruct bfa_fcxp_s *fcxp;\n\tstruct fchs_s\tfchs;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fc_prli_s\t*prli;\n\n\tbfa_trc(port->fcs, rx_fchs->s_id);\n\tbfa_trc(port->fcs, rx_fchs->d_id);\n\n\trport->stats.prli_rcvd++;\n\n\t \n\tprli = (struct fc_prli_s *) (rx_fchs + 1);\n\n\tif (prli->parampage.servparams.target) {\n\t\t \n\t\tbfa_trc(port->fcs, rx_fchs->s_id);\n\t\trport->scsi_function = BFA_RPORT_TARGET;\n\t} else {\n\t\tbfa_trc(rport->fcs, prli->parampage.type);\n\t\trport->scsi_function = BFA_RPORT_INITIATOR;\n\t\tbfa_fcs_itnim_is_initiator(rport->itnim);\n\t}\n\n\tfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\n\tif (!fcxp)\n\t\treturn;\n\n\tlen = fc_prli_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t\trx_fchs->s_id, bfa_fcs_lport_get_fcid(port),\n\t\t\t\trx_fchs->ox_id, port->port_cfg.roles);\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\n\t\t\tFC_CLASS_3, len, &fchs, NULL, NULL, FC_MAX_PDUSZ, 0);\n}\n\nstatic void\nbfa_fcs_rport_process_rpsc(struct bfa_fcs_rport_s *rport,\n\t\t\tstruct fchs_s *rx_fchs, u16 len)\n{\n\tstruct bfa_fcxp_s *fcxp;\n\tstruct fchs_s\tfchs;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fc_rpsc_speed_info_s speeds;\n\tstruct bfa_port_attr_s pport_attr;\n\n\tbfa_trc(port->fcs, rx_fchs->s_id);\n\tbfa_trc(port->fcs, rx_fchs->d_id);\n\n\trport->stats.rpsc_rcvd++;\n\tspeeds.port_speed_cap =\n\t\tRPSC_SPEED_CAP_1G | RPSC_SPEED_CAP_2G | RPSC_SPEED_CAP_4G |\n\t\tRPSC_SPEED_CAP_8G;\n\n\t \n\tbfa_fcport_get_attr(port->fcs->bfa, &pport_attr);\n\n\tspeeds.port_op_speed = fc_bfa_speed_to_rpsc_operspeed(pport_attr.speed);\n\n\tfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\n\tif (!fcxp)\n\t\treturn;\n\n\tlen = fc_rpsc_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t\trx_fchs->s_id, bfa_fcs_lport_get_fcid(port),\n\t\t\t\trx_fchs->ox_id, &speeds);\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\n\t\t\tFC_CLASS_3, len, &fchs, NULL, NULL, FC_MAX_PDUSZ, 0);\n}\n\nstatic void\nbfa_fcs_rport_process_adisc(struct bfa_fcs_rport_s *rport,\n\t\t\tstruct fchs_s *rx_fchs, u16 len)\n{\n\tstruct bfa_fcxp_s *fcxp;\n\tstruct fchs_s\tfchs;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\n\tbfa_trc(port->fcs, rx_fchs->s_id);\n\tbfa_trc(port->fcs, rx_fchs->d_id);\n\n\trport->stats.adisc_rcvd++;\n\n\t \n\tif (bfa_fcs_itnim_get_online_state(rport->itnim) == BFA_STATUS_OK) {\n\n\t\tfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\n\t\tif (!fcxp)\n\t\t\treturn;\n\n\t\tlen = fc_adisc_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t rx_fchs->s_id, bfa_fcs_lport_get_fcid(port),\n\t\t\t rx_fchs->ox_id, port->port_cfg.pwwn,\n\t\t\t port->port_cfg.nwwn);\n\n\t\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag,\n\t\t\t\tBFA_FALSE, FC_CLASS_3, len, &fchs, NULL, NULL,\n\t\t\t\tFC_MAX_PDUSZ, 0);\n\t} else {\n\t\trport->stats.adisc_rejected++;\n\t\tbfa_fcs_rport_send_ls_rjt(rport, rx_fchs,\n\t\t\t\t\t  FC_LS_RJT_RSN_UNABLE_TO_PERF_CMD,\n\t\t\t\t\t  FC_LS_RJT_EXP_LOGIN_REQUIRED);\n\t}\n}\n\nstatic void\nbfa_fcs_rport_hal_online(struct bfa_fcs_rport_s *rport)\n{\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct bfa_rport_info_s rport_info;\n\n\trport_info.pid = rport->pid;\n\trport_info.local_pid = port->pid;\n\trport_info.lp_tag = port->lp_tag;\n\trport_info.vf_id = port->fabric->vf_id;\n\trport_info.vf_en = port->fabric->is_vf;\n\trport_info.fc_class = rport->fc_cos;\n\trport_info.cisc = rport->cisc;\n\trport_info.max_frmsz = rport->maxfrsize;\n\tbfa_rport_online(rport->bfa_rport, &rport_info);\n}\n\nstatic void\nbfa_fcs_rport_hal_offline(struct bfa_fcs_rport_s *rport)\n{\n\tif (rport->bfa_rport)\n\t\tbfa_sm_send_event(rport->bfa_rport, BFA_RPORT_SM_OFFLINE);\n\telse\n\t\tbfa_cb_rport_offline(rport);\n}\n\nstatic struct bfa_fcs_rport_s *\nbfa_fcs_rport_alloc(struct bfa_fcs_lport_s *port, wwn_t pwwn, u32 rpid)\n{\n\tstruct bfa_fcs_s\t*fcs = port->fcs;\n\tstruct bfa_fcs_rport_s *rport;\n\tstruct bfad_rport_s\t*rport_drv;\n\n\t \n\tif (fcs->num_rport_logins >= bfa_fcs_rport_max_logins) {\n\t\tbfa_trc(fcs, rpid);\n\t\treturn NULL;\n\t}\n\n\tif (bfa_fcb_rport_alloc(fcs->bfad, &rport, &rport_drv)\n\t\t!= BFA_STATUS_OK) {\n\t\tbfa_trc(fcs, rpid);\n\t\treturn NULL;\n\t}\n\n\t \n\trport->port = port;\n\trport->fcs = fcs;\n\trport->rp_drv = rport_drv;\n\trport->pid = rpid;\n\trport->pwwn = pwwn;\n\trport->old_pid = 0;\n\n\trport->bfa_rport = NULL;\n\n\t \n\tWARN_ON(!bfa_fcs_lport_is_initiator(port));\n\n\tif (bfa_fcs_lport_is_initiator(port)) {\n\t\trport->itnim = bfa_fcs_itnim_create(rport);\n\t\tif (!rport->itnim) {\n\t\t\tbfa_trc(fcs, rpid);\n\t\t\tkfree(rport_drv);\n\t\t\treturn NULL;\n\t\t}\n\t}\n\n\tbfa_fcs_lport_add_rport(port, rport);\n\tfcs->num_rport_logins++;\n\n\tbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\n\n\t \n\tif (!BFA_FCS_PID_IS_WKA(rport->pid))\n\t\tbfa_fcs_rpf_init(rport);\n\n\treturn rport;\n}\n\n\nstatic void\nbfa_fcs_rport_free(struct bfa_fcs_rport_s *rport)\n{\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct bfa_fcs_s *fcs = port->fcs;\n\n\t \n\trport->plogi_pending = BFA_FALSE;\n\n\tif (bfa_fcs_lport_is_initiator(port)) {\n\t\tbfa_fcs_itnim_delete(rport->itnim);\n\t\tif (rport->pid != 0 && !BFA_FCS_PID_IS_WKA(rport->pid))\n\t\t\tbfa_fcs_rpf_rport_offline(rport);\n\t}\n\n\tif (rport->bfa_rport) {\n\t\tbfa_sm_send_event(rport->bfa_rport, BFA_RPORT_SM_DELETE);\n\t\trport->bfa_rport = NULL;\n\t}\n\n\tbfa_fcs_lport_del_rport(port, rport);\n\tfcs->num_rport_logins--;\n\tkfree(rport->rp_drv);\n}\n\nstatic void\nbfa_fcs_rport_aen_post(struct bfa_fcs_rport_s *rport,\n\t\t\tenum bfa_rport_aen_event event,\n\t\t\tstruct bfa_rport_aen_data_s *data)\n{\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct bfad_s *bfad = (struct bfad_s *)port->fcs->bfad;\n\tstruct bfa_aen_entry_s  *aen_entry;\n\n\tbfad_get_aen_entry(bfad, aen_entry);\n\tif (!aen_entry)\n\t\treturn;\n\n\tif (event == BFA_RPORT_AEN_QOS_PRIO)\n\t\taen_entry->aen_data.rport.priv.qos = data->priv.qos;\n\telse if (event == BFA_RPORT_AEN_QOS_FLOWID)\n\t\taen_entry->aen_data.rport.priv.qos = data->priv.qos;\n\n\taen_entry->aen_data.rport.vf_id = rport->port->fabric->vf_id;\n\taen_entry->aen_data.rport.ppwwn = bfa_fcs_lport_get_pwwn(\n\t\t\t\t\tbfa_fcs_get_base_port(rport->fcs));\n\taen_entry->aen_data.rport.lpwwn = bfa_fcs_lport_get_pwwn(rport->port);\n\taen_entry->aen_data.rport.rpwwn = rport->pwwn;\n\n\t \n\tbfad_im_post_vendor_event(aen_entry, bfad, ++rport->fcs->fcs_aen_seq,\n\t\t\t\t  BFA_AEN_CAT_RPORT, event);\n}\n\nstatic void\nbfa_fcs_rport_fcs_online_action(struct bfa_fcs_rport_s *rport)\n{\n\tif ((!rport->pid) || (!rport->pwwn)) {\n\t\tbfa_trc(rport->fcs, rport->pid);\n\t\tbfa_sm_fault(rport->fcs, rport->pid);\n\t}\n\n\tbfa_sm_send_event(rport->itnim, BFA_FCS_ITNIM_SM_FCS_ONLINE);\n}\n\nstatic void\nbfa_fcs_rport_hal_online_action(struct bfa_fcs_rport_s *rport)\n{\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct bfad_s *bfad = (struct bfad_s *)port->fcs->bfad;\n\tchar\tlpwwn_buf[BFA_STRING_32];\n\tchar\trpwwn_buf[BFA_STRING_32];\n\n\trport->stats.onlines++;\n\n\tif ((!rport->pid) || (!rport->pwwn)) {\n\t\tbfa_trc(rport->fcs, rport->pid);\n\t\tbfa_sm_fault(rport->fcs, rport->pid);\n\t}\n\n\tif (bfa_fcs_lport_is_initiator(port)) {\n\t\tbfa_fcs_itnim_brp_online(rport->itnim);\n\t\tif (!BFA_FCS_PID_IS_WKA(rport->pid))\n\t\t\tbfa_fcs_rpf_rport_online(rport);\n\t}\n\n\twwn2str(lpwwn_buf, bfa_fcs_lport_get_pwwn(port));\n\twwn2str(rpwwn_buf, rport->pwwn);\n\tif (!BFA_FCS_PID_IS_WKA(rport->pid)) {\n\t\tBFA_LOG(KERN_INFO, bfad, bfa_log_level,\n\t\t\"Remote port (WWN = %s) online for logical port (WWN = %s)\\n\",\n\t\trpwwn_buf, lpwwn_buf);\n\t\tbfa_fcs_rport_aen_post(rport, BFA_RPORT_AEN_ONLINE, NULL);\n\t}\n}\n\nstatic void\nbfa_fcs_rport_fcs_offline_action(struct bfa_fcs_rport_s *rport)\n{\n\tif (!BFA_FCS_PID_IS_WKA(rport->pid))\n\t\tbfa_fcs_rpf_rport_offline(rport);\n\n\tbfa_fcs_itnim_rport_offline(rport->itnim);\n}\n\nstatic void\nbfa_fcs_rport_hal_offline_action(struct bfa_fcs_rport_s *rport)\n{\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct bfad_s *bfad = (struct bfad_s *)port->fcs->bfad;\n\tchar\tlpwwn_buf[BFA_STRING_32];\n\tchar\trpwwn_buf[BFA_STRING_32];\n\n\tif (!rport->bfa_rport) {\n\t\tbfa_fcs_rport_fcs_offline_action(rport);\n\t\treturn;\n\t}\n\n\trport->stats.offlines++;\n\n\twwn2str(lpwwn_buf, bfa_fcs_lport_get_pwwn(port));\n\twwn2str(rpwwn_buf, rport->pwwn);\n\tif (!BFA_FCS_PID_IS_WKA(rport->pid)) {\n\t\tif (bfa_fcs_lport_is_online(rport->port) == BFA_TRUE) {\n\t\t\tBFA_LOG(KERN_ERR, bfad, bfa_log_level,\n\t\t\t\t\"Remote port (WWN = %s) connectivity lost for \"\n\t\t\t\t\"logical port (WWN = %s)\\n\",\n\t\t\t\trpwwn_buf, lpwwn_buf);\n\t\t\tbfa_fcs_rport_aen_post(rport,\n\t\t\t\tBFA_RPORT_AEN_DISCONNECT, NULL);\n\t\t} else {\n\t\t\tBFA_LOG(KERN_INFO, bfad, bfa_log_level,\n\t\t\t\t\"Remote port (WWN = %s) offlined by \"\n\t\t\t\t\"logical port (WWN = %s)\\n\",\n\t\t\t\trpwwn_buf, lpwwn_buf);\n\t\t\tbfa_fcs_rport_aen_post(rport,\n\t\t\t\tBFA_RPORT_AEN_OFFLINE, NULL);\n\t\t}\n\t}\n\n\tif (bfa_fcs_lport_is_initiator(port)) {\n\t\tbfa_fcs_itnim_rport_offline(rport->itnim);\n\t\tif (!BFA_FCS_PID_IS_WKA(rport->pid))\n\t\t\tbfa_fcs_rpf_rport_offline(rport);\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_update(struct bfa_fcs_rport_s *rport, struct fc_logi_s *plogi)\n{\n\tbfa_fcs_lport_t *port = rport->port;\n\n\t \n\trport->pwwn = plogi->port_name;\n\trport->nwwn = plogi->node_name;\n\n\t \n\trport->fc_cos = 0;\n\tif (plogi->class3.class_valid)\n\t\trport->fc_cos = FC_CLASS_3;\n\n\tif (plogi->class2.class_valid)\n\t\trport->fc_cos |= FC_CLASS_2;\n\n\t \n\trport->cisc = plogi->csp.cisc;\n\tif (be16_to_cpu(plogi->class3.rxsz) < be16_to_cpu(plogi->csp.rxsz))\n\t\trport->maxfrsize = be16_to_cpu(plogi->class3.rxsz);\n\telse\n\t\trport->maxfrsize = be16_to_cpu(plogi->csp.rxsz);\n\n\tbfa_trc(port->fcs, be16_to_cpu(plogi->csp.bbcred));\n\tbfa_trc(port->fcs, port->fabric->bb_credit);\n\t \n\tif ((!bfa_fcs_fabric_is_switched(port->fabric))\t &&\n\t\t(be16_to_cpu(plogi->csp.bbcred) < port->fabric->bb_credit)) {\n\n\t\tbfa_trc(port->fcs, be16_to_cpu(plogi->csp.bbcred));\n\t\tbfa_trc(port->fcs, port->fabric->bb_credit);\n\n\t\tport->fabric->bb_credit = be16_to_cpu(plogi->csp.bbcred);\n\t\tbfa_fcport_set_tx_bbcredit(port->fcs->bfa,\n\t\t\t\t\t  port->fabric->bb_credit);\n\t}\n\n}\n\n \nstatic void\nbfa_fcs_rport_process_logo(struct bfa_fcs_rport_s *rport, struct fchs_s *fchs)\n{\n\trport->reply_oxid = fchs->ox_id;\n\tbfa_trc(rport->fcs, rport->reply_oxid);\n\n\trport->prlo = BFA_FALSE;\n\trport->stats.logo_rcvd++;\n\tbfa_sm_send_event(rport, RPSM_EVENT_LOGO_RCVD);\n}\n\n\n\n \n\n \nstruct bfa_fcs_rport_s *\nbfa_fcs_rport_create(struct bfa_fcs_lport_s *port, u32 rpid)\n{\n\tstruct bfa_fcs_rport_s *rport;\n\n\tbfa_trc(port->fcs, rpid);\n\trport = bfa_fcs_rport_alloc(port, WWN_NULL, rpid);\n\tif (!rport)\n\t\treturn NULL;\n\n\tbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_SEND);\n\treturn rport;\n}\n\n \nstruct bfa_fcs_rport_s *\nbfa_fcs_rport_create_by_wwn(struct bfa_fcs_lport_s *port, wwn_t rpwwn)\n{\n\tstruct bfa_fcs_rport_s *rport;\n\tbfa_trc(port->fcs, rpwwn);\n\trport = bfa_fcs_rport_alloc(port, rpwwn, 0);\n\tif (!rport)\n\t\treturn NULL;\n\n\tbfa_sm_send_event(rport, RPSM_EVENT_ADDRESS_DISC);\n\treturn rport;\n}\n \nvoid\nbfa_fcs_rport_start(struct bfa_fcs_lport_s *port, struct fchs_s *fchs,\n\t struct fc_logi_s *plogi)\n{\n\tstruct bfa_fcs_rport_s *rport;\n\n\trport = bfa_fcs_rport_alloc(port, WWN_NULL, fchs->s_id);\n\tif (!rport)\n\t\treturn;\n\n\tbfa_fcs_rport_update(rport, plogi);\n\n\tbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_COMP);\n}\n\n \nvoid\nbfa_fcs_rport_plogi_create(struct bfa_fcs_lport_s *port, struct fchs_s *fchs,\n\t\t\t\tstruct fc_logi_s *plogi)\n{\n\tstruct bfa_fcs_rport_s *rport;\n\n\trport = bfa_fcs_rport_alloc(port, plogi->port_name, fchs->s_id);\n\tif (!rport)\n\t\treturn;\n\n\tbfa_fcs_rport_update(rport, plogi);\n\n\trport->reply_oxid = fchs->ox_id;\n\tbfa_trc(rport->fcs, rport->reply_oxid);\n\n\trport->stats.plogi_rcvd++;\n\tbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_RCVD);\n}\n\n \nvoid\nbfa_fcs_rport_plogi(struct bfa_fcs_rport_s *rport, struct fchs_s *rx_fchs,\n\t\t\tstruct fc_logi_s *plogi)\n{\n\t \n\n\tbfa_fcs_rport_update(rport, plogi);\n\n\trport->reply_oxid = rx_fchs->ox_id;\n\tbfa_trc(rport->fcs, rport->reply_oxid);\n\n\trport->pid = rx_fchs->s_id;\n\tbfa_trc(rport->fcs, rport->pid);\n\n\trport->stats.plogi_rcvd++;\n\tbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_RCVD);\n}\n\n\n \nvoid\nbfa_fcs_rport_scn(struct bfa_fcs_rport_s *rport)\n{\n\trport->stats.rscns++;\n\tbfa_sm_send_event(rport, RPSM_EVENT_FAB_SCN);\n}\n\n \nvoid\nbfa_cb_rport_online(void *cbarg)\n{\n\n\tstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_sm_send_event(rport, RPSM_EVENT_HCB_ONLINE);\n}\n\n \nvoid\nbfa_cb_rport_offline(void *cbarg)\n{\n\tstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_sm_send_event(rport, RPSM_EVENT_HCB_OFFLINE);\n}\n\n \nvoid\nbfa_cb_rport_qos_scn_flowid(void *cbarg,\n\t\tstruct bfa_rport_qos_attr_s old_qos_attr,\n\t\tstruct bfa_rport_qos_attr_s new_qos_attr)\n{\n\tstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\n\tstruct bfa_rport_aen_data_s aen_data;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\taen_data.priv.qos = new_qos_attr;\n\tbfa_fcs_rport_aen_post(rport, BFA_RPORT_AEN_QOS_FLOWID, &aen_data);\n}\n\nvoid\nbfa_cb_rport_scn_online(struct bfa_s *bfa)\n{\n\tstruct bfa_fcs_s *fcs = &((struct bfad_s *)bfa->bfad)->bfa_fcs;\n\tstruct bfa_fcs_lport_s *port = bfa_fcs_get_base_port(fcs);\n\tstruct bfa_fcs_rport_s *rp;\n\tstruct list_head *qe;\n\n\tlist_for_each(qe, &port->rport_q) {\n\t\trp = (struct bfa_fcs_rport_s *) qe;\n\t\tbfa_sm_send_event(rp, RPSM_EVENT_SCN_ONLINE);\n\t\trp->scn_online = BFA_TRUE;\n\t}\n\n\tif (bfa_fcs_lport_is_online(port))\n\t\tbfa_fcs_lport_lip_scn_online(port);\n}\n\nvoid\nbfa_cb_rport_scn_no_dev(void *rport)\n{\n\tstruct bfa_fcs_rport_s *rp = rport;\n\n\tbfa_sm_send_event(rp, RPSM_EVENT_SCN_OFFLINE);\n\trp->scn_online = BFA_FALSE;\n}\n\nvoid\nbfa_cb_rport_scn_offline(struct bfa_s *bfa)\n{\n\tstruct bfa_fcs_s *fcs = &((struct bfad_s *)bfa->bfad)->bfa_fcs;\n\tstruct bfa_fcs_lport_s *port = bfa_fcs_get_base_port(fcs);\n\tstruct bfa_fcs_rport_s *rp;\n\tstruct list_head *qe;\n\n\tlist_for_each(qe, &port->rport_q) {\n\t\trp = (struct bfa_fcs_rport_s *) qe;\n\t\tbfa_sm_send_event(rp, RPSM_EVENT_SCN_OFFLINE);\n\t\trp->scn_online = BFA_FALSE;\n\t}\n}\n\n \nvoid\nbfa_cb_rport_qos_scn_prio(void *cbarg,\n\t\tstruct bfa_rport_qos_attr_s old_qos_attr,\n\t\tstruct bfa_rport_qos_attr_s new_qos_attr)\n{\n\tstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\n\tstruct bfa_rport_aen_data_s aen_data;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\taen_data.priv.qos = new_qos_attr;\n\tbfa_fcs_rport_aen_post(rport, BFA_RPORT_AEN_QOS_PRIO, &aen_data);\n}\n\n \nvoid\nbfa_fcs_rport_uf_recv(struct bfa_fcs_rport_s *rport,\n\t\t\tstruct fchs_s *fchs, u16 len)\n{\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fc_els_cmd_s\t*els_cmd;\n\n\tbfa_trc(rport->fcs, fchs->s_id);\n\tbfa_trc(rport->fcs, fchs->d_id);\n\tbfa_trc(rport->fcs, fchs->type);\n\n\tif (fchs->type != FC_TYPE_ELS)\n\t\treturn;\n\n\tels_cmd = (struct fc_els_cmd_s *) (fchs + 1);\n\n\tbfa_trc(rport->fcs, els_cmd->els_code);\n\n\tswitch (els_cmd->els_code) {\n\tcase FC_ELS_LOGO:\n\t\tbfa_stats(port, plogi_rcvd);\n\t\tbfa_fcs_rport_process_logo(rport, fchs);\n\t\tbreak;\n\n\tcase FC_ELS_ADISC:\n\t\tbfa_stats(port, adisc_rcvd);\n\t\tbfa_fcs_rport_process_adisc(rport, fchs, len);\n\t\tbreak;\n\n\tcase FC_ELS_PRLO:\n\t\tbfa_stats(port, prlo_rcvd);\n\t\tif (bfa_fcs_lport_is_initiator(port))\n\t\t\tbfa_fcs_fcpim_uf_recv(rport->itnim, fchs, len);\n\t\tbreak;\n\n\tcase FC_ELS_PRLI:\n\t\tbfa_stats(port, prli_rcvd);\n\t\tbfa_fcs_rport_process_prli(rport, fchs, len);\n\t\tbreak;\n\n\tcase FC_ELS_RPSC:\n\t\tbfa_stats(port, rpsc_rcvd);\n\t\tbfa_fcs_rport_process_rpsc(rport, fchs, len);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_stats(port, un_handled_els_rcvd);\n\t\tbfa_fcs_rport_send_ls_rjt(rport, fchs,\n\t\t\t\t\t  FC_LS_RJT_RSN_CMD_NOT_SUPP,\n\t\t\t\t\t  FC_LS_RJT_EXP_NO_ADDL_INFO);\n\t\tbreak;\n\t}\n}\n\n \nstatic void\nbfa_fcs_rport_send_prlo_acc(struct bfa_fcs_rport_s *rport)\n{\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fchs_s\tfchs;\n\tstruct bfa_fcxp_s *fcxp;\n\tint\t\tlen;\n\n\tbfa_trc(rport->fcs, rport->pid);\n\n\tfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\n\tif (!fcxp)\n\t\treturn;\n\tlen = fc_prlo_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\trport->pid, bfa_fcs_lport_get_fcid(port),\n\t\t\trport->reply_oxid, 0);\n\n\tbfa_fcxp_send(fcxp, rport->bfa_rport, port->fabric->vf_id,\n\t\tport->lp_tag, BFA_FALSE, FC_CLASS_3, len, &fchs,\n\t\tNULL, NULL, FC_MAX_PDUSZ, 0);\n}\n\n \nstatic void\nbfa_fcs_rport_send_ls_rjt(struct bfa_fcs_rport_s *rport, struct fchs_s *rx_fchs,\n\t\t\t  u8 reason_code, u8 reason_code_expl)\n{\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fchs_s\tfchs;\n\tstruct bfa_fcxp_s *fcxp;\n\tint\t\tlen;\n\n\tbfa_trc(rport->fcs, rx_fchs->s_id);\n\n\tfcxp = bfa_fcs_fcxp_alloc(rport->fcs, BFA_FALSE);\n\tif (!fcxp)\n\t\treturn;\n\n\tlen = fc_ls_rjt_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t\trx_fchs->s_id, bfa_fcs_lport_get_fcid(port),\n\t\t\t\trx_fchs->ox_id, reason_code, reason_code_expl);\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag,\n\t\t\tBFA_FALSE, FC_CLASS_3, len, &fchs, NULL, NULL,\n\t\t\tFC_MAX_PDUSZ, 0);\n}\n\n \nint\nbfa_fcs_rport_get_state(struct bfa_fcs_rport_s *rport)\n{\n\treturn bfa_sm_to_state(rport_sm_table, rport->sm);\n}\n\n\n \nvoid\nbfa_fcs_rport_set_del_timeout(u8 rport_tmo)\n{\n\t \n\tif (rport_tmo > 0)\n\t\tbfa_fcs_rport_del_timeout = rport_tmo * 1000;\n}\nvoid\nbfa_fcs_rport_prlo(struct bfa_fcs_rport_s *rport, __be16 ox_id)\n{\n\tbfa_trc(rport->fcs, rport->pid);\n\n\trport->prlo = BFA_TRUE;\n\trport->reply_oxid = ox_id;\n\tbfa_sm_send_event(rport, RPSM_EVENT_PRLO_RCVD);\n}\n\n \nvoid\nbfa_fcs_rport_set_max_logins(u32 max_logins)\n{\n\tif (max_logins > 0)\n\t\tbfa_fcs_rport_max_logins = max_logins;\n}\n\nvoid\nbfa_fcs_rport_get_attr(struct bfa_fcs_rport_s *rport,\n\t\tstruct bfa_rport_attr_s *rport_attr)\n{\n\tstruct bfa_rport_qos_attr_s qos_attr;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tbfa_port_speed_t rport_speed = rport->rpf.rpsc_speed;\n\tstruct bfa_port_attr_s port_attr;\n\n\tbfa_fcport_get_attr(rport->fcs->bfa, &port_attr);\n\n\tmemset(rport_attr, 0, sizeof(struct bfa_rport_attr_s));\n\tmemset(&qos_attr, 0, sizeof(struct bfa_rport_qos_attr_s));\n\n\trport_attr->pid = rport->pid;\n\trport_attr->pwwn = rport->pwwn;\n\trport_attr->nwwn = rport->nwwn;\n\trport_attr->cos_supported = rport->fc_cos;\n\trport_attr->df_sz = rport->maxfrsize;\n\trport_attr->state = bfa_fcs_rport_get_state(rport);\n\trport_attr->fc_cos = rport->fc_cos;\n\trport_attr->cisc = rport->cisc;\n\trport_attr->scsi_function = rport->scsi_function;\n\trport_attr->curr_speed  = rport->rpf.rpsc_speed;\n\trport_attr->assigned_speed  = rport->rpf.assigned_speed;\n\n\tif (rport->bfa_rport) {\n\t\tqos_attr.qos_priority = rport->bfa_rport->qos_attr.qos_priority;\n\t\tqos_attr.qos_flow_id =\n\t\t\tcpu_to_be32(rport->bfa_rport->qos_attr.qos_flow_id);\n\t}\n\trport_attr->qos_attr = qos_attr;\n\n\trport_attr->trl_enforced = BFA_FALSE;\n\tif (bfa_fcport_is_ratelim(port->fcs->bfa) &&\n\t    (rport->scsi_function == BFA_RPORT_TARGET)) {\n\t\tif (rport_speed == BFA_PORT_SPEED_UNKNOWN)\n\t\t\trport_speed =\n\t\t\t\tbfa_fcport_get_ratelim_speed(rport->fcs->bfa);\n\n\t\tif ((bfa_fcs_lport_get_rport_max_speed(port) !=\n\t\t    BFA_PORT_SPEED_UNKNOWN) && (rport_speed < port_attr.speed))\n\t\t\trport_attr->trl_enforced = BFA_TRUE;\n\t}\n}\n\n \n\n \n\nstruct bfa_fcs_rport_s *\nbfa_fcs_rport_lookup(struct bfa_fcs_lport_s *port, wwn_t rpwwn)\n{\n\tstruct bfa_fcs_rport_s *rport;\n\n\trport = bfa_fcs_lport_get_rport_by_pwwn(port, rpwwn);\n\tif (rport == NULL) {\n\t\t \n\t}\n\n\treturn rport;\n}\n\nstruct bfa_fcs_rport_s *\nbfa_fcs_rport_lookup_by_nwwn(struct bfa_fcs_lport_s *port, wwn_t rnwwn)\n{\n\tstruct bfa_fcs_rport_s *rport;\n\n\trport = bfa_fcs_lport_get_rport_by_nwwn(port, rnwwn);\n\tif (rport == NULL) {\n\t\t \n\t}\n\n\treturn rport;\n}\n\n \n\n#define BFA_FCS_RPF_RETRIES\t(3)\n#define BFA_FCS_RPF_RETRY_TIMEOUT  (1000)  \n\nstatic void     bfa_fcs_rpf_send_rpsc2(void *rport_cbarg,\n\t\t\t\tstruct bfa_fcxp_s *fcxp_alloced);\nstatic void     bfa_fcs_rpf_rpsc2_response(void *fcsarg,\n\t\t\tstruct bfa_fcxp_s *fcxp,\n\t\t\tvoid *cbarg,\n\t\t\tbfa_status_t req_status,\n\t\t\tu32 rsp_len,\n\t\t\tu32 resid_len,\n\t\t\tstruct fchs_s *rsp_fchs);\n\nstatic void     bfa_fcs_rpf_timeout(void *arg);\n\n \n\nenum rpf_event {\n\tRPFSM_EVENT_RPORT_OFFLINE  = 1,  \n\tRPFSM_EVENT_RPORT_ONLINE   = 2,\t \n\tRPFSM_EVENT_FCXP_SENT      = 3,\t \n\tRPFSM_EVENT_TIMEOUT\t   = 4,  \n\tRPFSM_EVENT_RPSC_COMP      = 5,\n\tRPFSM_EVENT_RPSC_FAIL      = 6,\n\tRPFSM_EVENT_RPSC_ERROR     = 7,\n};\n\nstatic void\tbfa_fcs_rpf_sm_uninit(struct bfa_fcs_rpf_s *rpf,\n\t\t\t\t\tenum rpf_event event);\nstatic void     bfa_fcs_rpf_sm_rpsc_sending(struct bfa_fcs_rpf_s *rpf,\n\t\t\t\t       enum rpf_event event);\nstatic void     bfa_fcs_rpf_sm_rpsc(struct bfa_fcs_rpf_s *rpf,\n\t\t\t\t       enum rpf_event event);\nstatic void\tbfa_fcs_rpf_sm_rpsc_retry(struct bfa_fcs_rpf_s *rpf,\n\t\t\t\t\tenum rpf_event event);\nstatic void     bfa_fcs_rpf_sm_offline(struct bfa_fcs_rpf_s *rpf,\n\t\t\t\t\tenum rpf_event event);\nstatic void     bfa_fcs_rpf_sm_online(struct bfa_fcs_rpf_s *rpf,\n\t\t\t\t\tenum rpf_event event);\n\nstatic void\nbfa_fcs_rpf_sm_uninit(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\n{\n\tstruct bfa_fcs_rport_s *rport = rpf->rport;\n\tstruct bfa_fcs_fabric_s *fabric = &rport->fcs->fabric;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPFSM_EVENT_RPORT_ONLINE:\n\t\t \n\t\tif ((!BFA_FCS_PID_IS_WKA(rport->pid)) &&\n\t\t\t((rport->port->fabric->lps->brcd_switch) ||\n\t\t\t(bfa_fcs_fabric_get_switch_oui(fabric) ==\n\t\t\t\t\t\tBFA_FCS_BRCD_SWITCH_OUI))) {\n\t\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc_sending);\n\t\t\trpf->rpsc_retries = 0;\n\t\t\tbfa_fcs_rpf_send_rpsc2(rpf, NULL);\n\t\t}\n\t\tbreak;\n\n\tcase RPFSM_EVENT_RPORT_OFFLINE:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_rpf_sm_rpsc_sending(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\n{\n\tstruct bfa_fcs_rport_s *rport = rpf->rport;\n\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPFSM_EVENT_FCXP_SENT:\n\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc);\n\t\tbreak;\n\n\tcase RPFSM_EVENT_RPORT_OFFLINE:\n\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_offline);\n\t\tbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rpf->fcxp_wqe);\n\t\trpf->rpsc_retries = 0;\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_rpf_sm_rpsc(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\n{\n\tstruct bfa_fcs_rport_s *rport = rpf->rport;\n\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPFSM_EVENT_RPSC_COMP:\n\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_online);\n\t\t \n\t\tif (rpf->rpsc_speed != BFA_PORT_SPEED_UNKNOWN)\n\t\t\tbfa_rport_speed(rport->bfa_rport, rpf->rpsc_speed);\n\t\telse if (rpf->assigned_speed != BFA_PORT_SPEED_UNKNOWN)\n\t\t\tbfa_rport_speed(rport->bfa_rport, rpf->assigned_speed);\n\t\tbreak;\n\n\tcase RPFSM_EVENT_RPSC_FAIL:\n\t\t \n\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_online);\n\t\tbreak;\n\n\tcase RPFSM_EVENT_RPSC_ERROR:\n\t\t \n\t\tif (rpf->rpsc_retries++ < BFA_FCS_RPF_RETRIES) {\n\t\t\tbfa_timer_start(rport->fcs->bfa, &rpf->timer,\n\t\t\t\t    bfa_fcs_rpf_timeout, rpf,\n\t\t\t\t    BFA_FCS_RPF_RETRY_TIMEOUT);\n\t\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc_retry);\n\t\t} else {\n\t\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_online);\n\t\t}\n\t\tbreak;\n\n\tcase RPFSM_EVENT_RPORT_OFFLINE:\n\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_offline);\n\t\tbfa_fcxp_discard(rpf->fcxp);\n\t\trpf->rpsc_retries = 0;\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_rpf_sm_rpsc_retry(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\n{\n\tstruct bfa_fcs_rport_s *rport = rpf->rport;\n\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPFSM_EVENT_TIMEOUT:\n\t\t \n\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc_sending);\n\t\tbfa_fcs_rpf_send_rpsc2(rpf, NULL);\n\t\tbreak;\n\n\tcase RPFSM_EVENT_RPORT_OFFLINE:\n\t\tbfa_timer_stop(&rpf->timer);\n\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_offline);\n\t\trpf->rpsc_retries = 0;\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_rpf_sm_online(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\n{\n\tstruct bfa_fcs_rport_s *rport = rpf->rport;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPFSM_EVENT_RPORT_OFFLINE:\n\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_offline);\n\t\trpf->rpsc_retries = 0;\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_rpf_sm_offline(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\n{\n\tstruct bfa_fcs_rport_s *rport = rpf->rport;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_trc(rport->fcs, event);\n\n\tswitch (event) {\n\tcase RPFSM_EVENT_RPORT_ONLINE:\n\t\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc_sending);\n\t\tbfa_fcs_rpf_send_rpsc2(rpf, NULL);\n\t\tbreak;\n\n\tcase RPFSM_EVENT_RPORT_OFFLINE:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(rport->fcs, event);\n\t}\n}\n \nvoid\nbfa_fcs_rpf_init(struct bfa_fcs_rport_s *rport)\n{\n\tstruct bfa_fcs_rpf_s *rpf = &rport->rpf;\n\n\tbfa_trc(rport->fcs, rport->pid);\n\trpf->rport = rport;\n\n\tbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_uninit);\n}\n\n \nvoid\nbfa_fcs_rpf_rport_online(struct bfa_fcs_rport_s *rport)\n{\n\tbfa_trc(rport->fcs, rport->pid);\n\n\tif (__fcs_min_cfg(rport->port->fcs))\n\t\treturn;\n\n\tif (bfa_fcs_fabric_is_switched(rport->port->fabric))\n\t\tbfa_sm_send_event(&rport->rpf, RPFSM_EVENT_RPORT_ONLINE);\n}\n\n \nvoid\nbfa_fcs_rpf_rport_offline(struct bfa_fcs_rport_s *rport)\n{\n\tbfa_trc(rport->fcs, rport->pid);\n\n\tif (__fcs_min_cfg(rport->port->fcs))\n\t\treturn;\n\n\trport->rpf.rpsc_speed = 0;\n\tbfa_sm_send_event(&rport->rpf, RPFSM_EVENT_RPORT_OFFLINE);\n}\n\nstatic void\nbfa_fcs_rpf_timeout(void *arg)\n{\n\tstruct bfa_fcs_rpf_s *rpf = (struct bfa_fcs_rpf_s *) arg;\n\tstruct bfa_fcs_rport_s *rport = rpf->rport;\n\n\tbfa_trc(rport->fcs, rport->pid);\n\tbfa_sm_send_event(rpf, RPFSM_EVENT_TIMEOUT);\n}\n\nstatic void\nbfa_fcs_rpf_send_rpsc2(void *rpf_cbarg, struct bfa_fcxp_s *fcxp_alloced)\n{\n\tstruct bfa_fcs_rpf_s *rpf = (struct bfa_fcs_rpf_s *)rpf_cbarg;\n\tstruct bfa_fcs_rport_s *rport = rpf->rport;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fchs_s\tfchs;\n\tint\t\tlen;\n\tstruct bfa_fcxp_s *fcxp;\n\n\tbfa_trc(rport->fcs, rport->pwwn);\n\n\tfcxp = fcxp_alloced ? fcxp_alloced :\n\t       bfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\n\tif (!fcxp) {\n\t\tbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rpf->fcxp_wqe,\n\t\t\t\tbfa_fcs_rpf_send_rpsc2, rpf, BFA_TRUE);\n\t\treturn;\n\t}\n\trpf->fcxp = fcxp;\n\n\tlen = fc_rpsc2_build(&fchs, bfa_fcxp_get_reqbuf(fcxp), rport->pid,\n\t\t\t    bfa_fcs_lport_get_fcid(port), &rport->pid, 1);\n\n\tbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\n\t\t\t  FC_CLASS_3, len, &fchs, bfa_fcs_rpf_rpsc2_response,\n\t\t\t  rpf, FC_MAX_PDUSZ, FC_ELS_TOV);\n\trport->stats.rpsc_sent++;\n\tbfa_sm_send_event(rpf, RPFSM_EVENT_FCXP_SENT);\n\n}\n\nstatic void\nbfa_fcs_rpf_rpsc2_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t    bfa_status_t req_status, u32 rsp_len,\n\t\t\t    u32 resid_len, struct fchs_s *rsp_fchs)\n{\n\tstruct bfa_fcs_rpf_s *rpf = (struct bfa_fcs_rpf_s *) cbarg;\n\tstruct bfa_fcs_rport_s *rport = rpf->rport;\n\tstruct fc_ls_rjt_s *ls_rjt;\n\tstruct fc_rpsc2_acc_s *rpsc2_acc;\n\tu16\tnum_ents;\n\n\tbfa_trc(rport->fcs, req_status);\n\n\tif (req_status != BFA_STATUS_OK) {\n\t\tbfa_trc(rport->fcs, req_status);\n\t\tif (req_status == BFA_STATUS_ETIMER)\n\t\t\trport->stats.rpsc_failed++;\n\t\tbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_ERROR);\n\t\treturn;\n\t}\n\n\trpsc2_acc = (struct fc_rpsc2_acc_s *) BFA_FCXP_RSP_PLD(fcxp);\n\tif (rpsc2_acc->els_cmd == FC_ELS_ACC) {\n\t\trport->stats.rpsc_accs++;\n\t\tnum_ents = be16_to_cpu(rpsc2_acc->num_pids);\n\t\tbfa_trc(rport->fcs, num_ents);\n\t\tif (num_ents > 0) {\n\t\t\tWARN_ON(be32_to_cpu(rpsc2_acc->port_info[0].pid) !=\n\t\t\t\t\t\tbfa_ntoh3b(rport->pid));\n\t\t\tbfa_trc(rport->fcs,\n\t\t\t\tbe32_to_cpu(rpsc2_acc->port_info[0].pid));\n\t\t\tbfa_trc(rport->fcs,\n\t\t\t\tbe16_to_cpu(rpsc2_acc->port_info[0].speed));\n\t\t\tbfa_trc(rport->fcs,\n\t\t\t\tbe16_to_cpu(rpsc2_acc->port_info[0].index));\n\t\t\tbfa_trc(rport->fcs,\n\t\t\t\trpsc2_acc->port_info[0].type);\n\n\t\t\tif (rpsc2_acc->port_info[0].speed == 0) {\n\t\t\t\tbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_ERROR);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\trpf->rpsc_speed = fc_rpsc_operspeed_to_bfa_speed(\n\t\t\t\tbe16_to_cpu(rpsc2_acc->port_info[0].speed));\n\n\t\t\tbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_COMP);\n\t\t}\n\t} else {\n\t\tls_rjt = (struct fc_ls_rjt_s *) BFA_FCXP_RSP_PLD(fcxp);\n\t\tbfa_trc(rport->fcs, ls_rjt->reason_code);\n\t\tbfa_trc(rport->fcs, ls_rjt->reason_code_expl);\n\t\trport->stats.rpsc_rejects++;\n\t\tif (ls_rjt->reason_code == FC_LS_RJT_RSN_CMD_NOT_SUPP)\n\t\t\tbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_FAIL);\n\t\telse\n\t\t\tbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_ERROR);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}