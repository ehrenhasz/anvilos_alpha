{
  "module_name": "bfa_fcpim.h",
  "hash_id": "a6fb02a60632a0b8305b295630489c8bcb462d91e62458c3c080e9657e23d34a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/bfa/bfa_fcpim.h",
  "human_readable_source": " \n \n\n#ifndef __BFA_FCPIM_H__\n#define __BFA_FCPIM_H__\n\n#include \"bfa.h\"\n#include \"bfa_svc.h\"\n#include \"bfi_ms.h\"\n#include \"bfa_defs_svc.h\"\n#include \"bfa_cs.h\"\n\n \n#define BFA_IO_MAX\tBFI_IO_MAX\n#define BFA_FWTIO_MAX\t2000\n\nstruct bfa_fcp_mod_s;\nstruct bfa_iotag_s {\n\tstruct list_head\tqe;\t \n\tu16\ttag;\t\t\t \n};\n\nstruct bfa_itn_s {\n\tbfa_isr_func_t isr;\n};\n\nvoid bfa_itn_create(struct bfa_s *bfa, struct bfa_rport_s *rport,\n\t\tvoid (*isr)(struct bfa_s *bfa, struct bfi_msg_s *m));\nvoid bfa_itn_isr(struct bfa_s *bfa, struct bfi_msg_s *m);\nvoid bfa_iotag_attach(struct bfa_fcp_mod_s *fcp);\nvoid bfa_fcp_res_recfg(struct bfa_s *bfa, u16 num_ioim_fw, u16 max_ioim_fw);\n\n#define BFA_FCP_MOD(_hal)\t(&(_hal)->modules.fcp_mod)\n#define BFA_MEM_FCP_KVA(__bfa)\t(&(BFA_FCP_MOD(__bfa)->kva_seg))\n#define BFA_IOTAG_FROM_TAG(_fcp, _tag)\t\\\n\t(&(_fcp)->iotag_arr[(_tag & BFA_IOIM_IOTAG_MASK)])\n#define BFA_ITN_FROM_TAG(_fcp, _tag)\t\\\n\t((_fcp)->itn_arr + ((_tag) & ((_fcp)->num_itns - 1)))\n#define BFA_SNSINFO_FROM_TAG(_fcp, _tag) \\\n\tbfa_mem_get_dmabuf_kva(_fcp, (_tag & BFA_IOIM_IOTAG_MASK),\t\\\n\tBFI_IOIM_SNSLEN)\n\n\n#define BFA_ITNIM_MIN   32\n#define BFA_ITNIM_MAX   1024\n\n#define BFA_IOIM_MIN\t8\n#define BFA_IOIM_MAX\t2000\n\n#define BFA_TSKIM_MIN   4\n#define BFA_TSKIM_MAX   512\n#define BFA_FCPIM_PATHTOV_DEF\t(30 * 1000)\t \n#define BFA_FCPIM_PATHTOV_MAX\t(90 * 1000)\t \n\n\n#define bfa_itnim_ioprofile_update(__itnim, __index)\t\t\t\\\n\t(__itnim->ioprofile.iocomps[__index]++)\n\n#define BFA_IOIM_RETRY_TAG_OFFSET 11\n#define BFA_IOIM_IOTAG_MASK 0x07ff  \n#define BFA_IOIM_RETRY_MAX 7\n\n \nstatic inline u32\nbfa_ioim_get_index(u32 n) {\n\tint pos = 0;\n\tif (n >= (1UL)<<22)\n\t\treturn BFA_IOBUCKET_MAX - 1;\n\tn >>= 8;\n\tif (n >= (1UL)<<16) {\n\t\tn >>= 16;\n\t\tpos += 16;\n\t}\n\tif (n >= 1 << 8) {\n\t\tn >>= 8;\n\t\tpos += 8;\n\t}\n\tif (n >= 1 << 4) {\n\t\tn >>= 4;\n\t\tpos += 4;\n\t}\n\tif (n >= 1 << 2) {\n\t\tn >>= 2;\n\t\tpos += 2;\n\t}\n\tif (n >= 1 << 1)\n\t\tpos += 1;\n\n\treturn (n == 0) ? (0) : pos;\n}\n\n \nstruct bfa_ioim_s;\nstruct bfa_tskim_s;\nstruct bfad_ioim_s;\nstruct bfad_tskim_s;\n\ntypedef void    (*bfa_fcpim_profile_t) (struct bfa_ioim_s *ioim);\n\nstruct bfa_fcpim_s {\n\tstruct bfa_s\t\t*bfa;\n\tstruct bfa_fcp_mod_s\t*fcp;\n\tstruct bfa_itnim_s\t*itnim_arr;\n\tstruct bfa_ioim_s\t*ioim_arr;\n\tstruct bfa_ioim_sp_s\t*ioim_sp_arr;\n\tstruct bfa_tskim_s\t*tskim_arr;\n\tint\t\t\tnum_itnims;\n\tint\t\t\tnum_tskim_reqs;\n\tu32\t\t\tpath_tov;\n\tu16\t\t\tq_depth;\n\tu8\t\t\treqq;\t\t \n\tstruct list_head\titnim_q;\t \n\tstruct list_head\tioim_resfree_q;  \n\tstruct list_head\tioim_comp_q;\t \n\tstruct list_head\ttskim_free_q;\n\tstruct list_head\ttskim_unused_q;\t \n\tu32\t\t\tios_active;\t \n\tu32\t\t\tdelay_comp;\n\tstruct bfa_fcpim_del_itn_stats_s del_itn_stats;\n\tbfa_boolean_t\t\tioredirect;\n\tbfa_boolean_t\t\tio_profile;\n\ttime64_t\t\tio_profile_start_time;\n\tbfa_fcpim_profile_t     profile_comp;\n\tbfa_fcpim_profile_t     profile_start;\n};\n\n \n#define BFA_FCP_DMA_SEGS\tBFI_IOIM_SNSBUF_SEGS\n\nstruct bfa_fcp_mod_s {\n\tstruct bfa_s\t\t*bfa;\n\tstruct list_head\tiotag_ioim_free_q;\t \n\tstruct list_head\tiotag_tio_free_q;\t \n\tstruct list_head\tiotag_unused_q;\t \n\tstruct bfa_iotag_s\t*iotag_arr;\n\tstruct bfa_itn_s\t*itn_arr;\n\tint\t\t\tmax_ioim_reqs;\n\tint\t\t\tnum_ioim_reqs;\n\tint\t\t\tnum_fwtio_reqs;\n\tint\t\t\tnum_itns;\n\tstruct bfa_dma_s\tsnsbase[BFA_FCP_DMA_SEGS];\n\tstruct bfa_fcpim_s\tfcpim;\n\tstruct bfa_mem_dma_s\tdma_seg[BFA_FCP_DMA_SEGS];\n\tstruct bfa_mem_kva_s\tkva_seg;\n\tint\t\t\tthrottle_update_required;\n};\n\n \nstruct bfa_ioim_s {\n\tstruct list_head\tqe;\t\t \n\tbfa_sm_t\t\tsm;\t\t \n\tstruct bfa_s\t\t*bfa;\t\t \n\tstruct bfa_fcpim_s\t*fcpim;\t\t \n\tstruct bfa_itnim_s\t*itnim;\t\t \n\tstruct bfad_ioim_s\t*dio;\t\t \n\tu16\t\t\tiotag;\t\t \n\tu16\t\t\tabort_tag;\t \n\tu16\t\t\tnsges;\t\t \n\tu16\t\t\tnsgpgs;\t\t \n\tstruct bfa_sgpg_s\t*sgpg;\t\t \n\tstruct list_head\tsgpg_q;\t\t \n\tstruct bfa_cb_qe_s\thcb_qe;\t\t \n\tbfa_cb_cbfn_t\t\tio_cbfn;\t \n\tstruct bfa_ioim_sp_s\t*iosp;\t\t \n\tu8\t\t\treqq;\t\t \n\tu8\t\t\tmode;\t\t \n\tu64\t\t\tstart_time;\t \n};\n\nstruct bfa_ioim_sp_s {\n\tstruct bfi_msg_s\tcomp_rspmsg;\t \n\tstruct bfa_sgpg_wqe_s\tsgpg_wqe;\t \n\tstruct bfa_reqq_wait_s\treqq_wait;\t \n\tbfa_boolean_t\t\tabort_explicit;\t \n\tstruct bfa_tskim_s\t*tskim;\t\t \n};\n\n \nstruct bfa_tskim_s {\n\tstruct list_head\tqe;\n\tbfa_sm_t\t\tsm;\n\tstruct bfa_s\t\t*bfa;\t \n\tstruct bfa_fcpim_s\t*fcpim;\t \n\tstruct bfa_itnim_s\t*itnim;\t \n\tstruct bfad_tskim_s\t*dtsk;   \n\tbfa_boolean_t\t\tnotify;\t \n\tstruct scsi_lun\t\tlun;\t \n\tenum fcp_tm_cmnd\ttm_cmnd;  \n\tu16\t\t\ttsk_tag;  \n\tu8\t\t\ttsecs;\t \n\tstruct bfa_reqq_wait_s  reqq_wait;    \n\tstruct list_head\tio_q;\t \n\tstruct bfa_wc_s\t\twc;\t \n\tstruct bfa_cb_qe_s\thcb_qe;\t \n\tenum bfi_tskim_status   tsk_status;   \n};\n\n \nstruct bfa_itnim_s {\n\tstruct list_head\tqe;\t \n\tbfa_sm_t\t\tsm;\t \n\tstruct bfa_s\t\t*bfa;\t \n\tstruct bfa_rport_s\t*rport;\t \n\tvoid\t\t\t*ditn;\t \n\tstruct bfi_mhdr_s\tmhdr;\t \n\tu8\t\t\tmsg_no;\t \n\tu8\t\t\treqq;\t \n\tstruct bfa_cb_qe_s\thcb_qe;\t \n\tstruct list_head pending_q;\t \n\tstruct list_head io_q;\t\t \n\tstruct list_head io_cleanup_q;\t \n\tstruct list_head tsk_q;\t\t \n\tstruct list_head  delay_comp_q;  \n\tbfa_boolean_t   seq_rec;\t \n\tbfa_boolean_t   is_online;\t \n\tbfa_boolean_t   iotov_active;\t \n\tstruct bfa_wc_s\twc;\t\t \n\tstruct bfa_timer_s timer;\t \n\tstruct bfa_reqq_wait_s reqq_wait;  \n\tstruct bfa_fcpim_s *fcpim;\t \n\tstruct bfa_itnim_iostats_s\tstats;\n\tstruct bfa_itnim_ioprofile_s  ioprofile;\n};\n\n#define bfa_itnim_is_online(_itnim) ((_itnim)->is_online)\n#define BFA_FCPIM(_hal)\t(&(_hal)->modules.fcp_mod.fcpim)\n#define BFA_IOIM_TAG_2_ID(_iotag)\t((_iotag) & BFA_IOIM_IOTAG_MASK)\n#define BFA_IOIM_FROM_TAG(_fcpim, _iotag)\t\\\n\t(&fcpim->ioim_arr[(_iotag & BFA_IOIM_IOTAG_MASK)])\n#define BFA_TSKIM_FROM_TAG(_fcpim, _tmtag)\t\\\n\t(&fcpim->tskim_arr[_tmtag & (fcpim->num_tskim_reqs - 1)])\n\n#define bfa_io_profile_start_time(_bfa)\t\\\n\t((_bfa)->modules.fcp_mod.fcpim.io_profile_start_time)\n#define bfa_fcpim_get_io_profile(_bfa)\t\\\n\t((_bfa)->modules.fcp_mod.fcpim.io_profile)\n#define bfa_ioim_update_iotag(__ioim) do {\t\t\t\t\\\n\tuint16_t k = (__ioim)->iotag >> BFA_IOIM_RETRY_TAG_OFFSET;\t\\\n\tk++; (__ioim)->iotag &= BFA_IOIM_IOTAG_MASK;\t\t\t\\\n\t(__ioim)->iotag |= k << BFA_IOIM_RETRY_TAG_OFFSET;\t\t\\\n} while (0)\n\nstatic inline bfa_boolean_t\nbfa_ioim_maxretry_reached(struct bfa_ioim_s *ioim)\n{\n\tuint16_t k = ioim->iotag >> BFA_IOIM_RETRY_TAG_OFFSET;\n\tif (k < BFA_IOIM_RETRY_MAX)\n\t\treturn BFA_FALSE;\n\treturn BFA_TRUE;\n}\n\n \nvoid\tbfa_ioim_attach(struct bfa_fcpim_s *fcpim);\nvoid\tbfa_ioim_isr(struct bfa_s *bfa, struct bfi_msg_s *msg);\nvoid\tbfa_ioim_good_comp_isr(struct bfa_s *bfa,\n\t\t\t\t\tstruct bfi_msg_s *msg);\nvoid\tbfa_ioim_cleanup(struct bfa_ioim_s *ioim);\nvoid\tbfa_ioim_cleanup_tm(struct bfa_ioim_s *ioim,\n\t\t\t\t\tstruct bfa_tskim_s *tskim);\nvoid\tbfa_ioim_iocdisable(struct bfa_ioim_s *ioim);\nvoid\tbfa_ioim_tov(struct bfa_ioim_s *ioim);\n\nvoid\tbfa_tskim_attach(struct bfa_fcpim_s *fcpim);\nvoid\tbfa_tskim_isr(struct bfa_s *bfa, struct bfi_msg_s *msg);\nvoid\tbfa_tskim_iodone(struct bfa_tskim_s *tskim);\nvoid\tbfa_tskim_iocdisable(struct bfa_tskim_s *tskim);\nvoid\tbfa_tskim_cleanup(struct bfa_tskim_s *tskim);\nvoid\tbfa_tskim_res_recfg(struct bfa_s *bfa, u16 num_tskim_fw);\n\nvoid\tbfa_itnim_meminfo(struct bfa_iocfc_cfg_s *cfg, u32 *km_len);\nvoid\tbfa_itnim_attach(struct bfa_fcpim_s *fcpim);\nvoid\tbfa_itnim_iocdisable(struct bfa_itnim_s *itnim);\nvoid\tbfa_itnim_isr(struct bfa_s *bfa, struct bfi_msg_s *msg);\nvoid\tbfa_itnim_iodone(struct bfa_itnim_s *itnim);\nvoid\tbfa_itnim_tskdone(struct bfa_itnim_s *itnim);\nbfa_boolean_t   bfa_itnim_hold_io(struct bfa_itnim_s *itnim);\n\n \nvoid\tbfa_fcpim_path_tov_set(struct bfa_s *bfa, u16 path_tov);\nu16\tbfa_fcpim_path_tov_get(struct bfa_s *bfa);\nu16\tbfa_fcpim_qdepth_get(struct bfa_s *bfa);\nbfa_status_t bfa_fcpim_port_iostats(struct bfa_s *bfa,\n\t\t\tstruct bfa_itnim_iostats_s *stats, u8 lp_tag);\nvoid bfa_fcpim_add_stats(struct bfa_itnim_iostats_s *fcpim_stats,\n\t\t\tstruct bfa_itnim_iostats_s *itnim_stats);\nbfa_status_t bfa_fcpim_profile_on(struct bfa_s *bfa, time64_t time);\nbfa_status_t bfa_fcpim_profile_off(struct bfa_s *bfa);\n\n#define bfa_fcpim_ioredirect_enabled(__bfa)\t\t\t\t\\\n\t(((struct bfa_fcpim_s *)(BFA_FCPIM(__bfa)))->ioredirect)\n\n#define bfa_fcpim_get_next_reqq(__bfa, __qid)\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tstruct bfa_fcpim_s *__fcpim = BFA_FCPIM(__bfa);      \\\n\t__fcpim->reqq++;\t\t\t\t\t\t\\\n\t__fcpim->reqq &= (BFI_IOC_MAX_CQS - 1);      \\\n\t*(__qid) = __fcpim->reqq;\t\t\t\t\t\\\n}\n\n#define bfa_iocfc_map_msg_to_qid(__msg, __qid)\t\t\t\t\\\n\t*(__qid) = (u8)((__msg) & (BFI_IOC_MAX_CQS - 1));\n \nstruct bfa_itnim_s *bfa_itnim_create(struct bfa_s *bfa,\n\t\tstruct bfa_rport_s *rport, void *itnim);\nvoid bfa_itnim_delete(struct bfa_itnim_s *itnim);\nvoid bfa_itnim_online(struct bfa_itnim_s *itnim, bfa_boolean_t seq_rec);\nvoid bfa_itnim_offline(struct bfa_itnim_s *itnim);\nvoid bfa_itnim_clear_stats(struct bfa_itnim_s *itnim);\nbfa_status_t bfa_itnim_get_ioprofile(struct bfa_itnim_s *itnim,\n\t\t\tstruct bfa_itnim_ioprofile_s *ioprofile);\n\n#define bfa_itnim_get_reqq(__ioim) (((struct bfa_ioim_s *)__ioim)->itnim->reqq)\n\n \nvoid\tbfa_cb_itnim_online(void *itnim);\n\n \nvoid\tbfa_cb_itnim_offline(void *itnim);\nvoid\tbfa_cb_itnim_tov_begin(void *itnim);\nvoid\tbfa_cb_itnim_tov(void *itnim);\n\n \nvoid\tbfa_cb_itnim_sler(void *itnim);\n\n \nstruct bfa_ioim_s\t*bfa_ioim_alloc(struct bfa_s *bfa,\n\t\t\t\t\tstruct bfad_ioim_s *dio,\n\t\t\t\t\tstruct bfa_itnim_s *itnim,\n\t\t\t\t\tu16 nsgles);\n\nvoid\t\tbfa_ioim_free(struct bfa_ioim_s *ioim);\nvoid\t\tbfa_ioim_start(struct bfa_ioim_s *ioim);\nbfa_status_t\tbfa_ioim_abort(struct bfa_ioim_s *ioim);\nvoid\t\tbfa_ioim_delayed_comp(struct bfa_ioim_s *ioim,\n\t\t\t\t      bfa_boolean_t iotov);\n \nvoid bfa_cb_ioim_done(void *bfad, struct bfad_ioim_s *dio,\n\t\t\tenum bfi_ioim_status io_status,\n\t\t\tu8 scsi_status, int sns_len,\n\t\t\tu8 *sns_info, s32 residue);\n\n \nvoid bfa_cb_ioim_good_comp(void *bfad, struct bfad_ioim_s *dio);\n\n \nvoid bfa_cb_ioim_abort(void *bfad, struct bfad_ioim_s *dio);\n\n \nstruct bfa_tskim_s *bfa_tskim_alloc(struct bfa_s *bfa,\n\t\t\tstruct bfad_tskim_s *dtsk);\nvoid bfa_tskim_free(struct bfa_tskim_s *tskim);\nvoid bfa_tskim_start(struct bfa_tskim_s *tskim,\n\t\t\tstruct bfa_itnim_s *itnim, struct scsi_lun lun,\n\t\t\tenum fcp_tm_cmnd tm, u8 t_secs);\nvoid bfa_cb_tskim_done(void *bfad, struct bfad_tskim_s *dtsk,\n\t\t\tenum bfi_tskim_status tsk_status);\n\nvoid\tbfa_fcpim_lunmask_rp_update(struct bfa_s *bfa, wwn_t lp_wwn,\n\t\t\twwn_t rp_wwn, u16 rp_tag, u8 lp_tag);\nbfa_status_t\tbfa_fcpim_lunmask_update(struct bfa_s *bfa, u32 on_off);\nbfa_status_t\tbfa_fcpim_lunmask_query(struct bfa_s *bfa, void *buf);\nbfa_status_t\tbfa_fcpim_lunmask_delete(struct bfa_s *bfa, u16 vf_id,\n\t\t\t\twwn_t *pwwn, wwn_t rpwwn, struct scsi_lun lun);\nbfa_status_t\tbfa_fcpim_lunmask_add(struct bfa_s *bfa, u16 vf_id,\n\t\t\t\twwn_t *pwwn, wwn_t rpwwn, struct scsi_lun lun);\nbfa_status_t\tbfa_fcpim_lunmask_clear(struct bfa_s *bfa);\nu16\t\tbfa_fcpim_read_throttle(struct bfa_s *bfa);\nbfa_status_t\tbfa_fcpim_write_throttle(struct bfa_s *bfa, u16 value);\nbfa_status_t\tbfa_fcpim_throttle_set(struct bfa_s *bfa, u16 value);\nbfa_status_t\tbfa_fcpim_throttle_get(struct bfa_s *bfa, void *buf);\nu16     bfa_fcpim_get_throttle_cfg(struct bfa_s *bfa, u16 drv_cfg_param);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}