{
  "module_name": "bfa_fcs_fcpim.c",
  "hash_id": "2b53010b7ba468e10ea27da250265cf77c5500165e41de4f87072425382b08e9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/bfa/bfa_fcs_fcpim.c",
  "human_readable_source": "\n \n\n \n\n#include \"bfad_drv.h\"\n#include \"bfa_fcs.h\"\n#include \"bfa_fcbuild.h\"\n#include \"bfad_im.h\"\n\nBFA_TRC_FILE(FCS, FCPIM);\n\n \nstatic void\tbfa_fcs_itnim_timeout(void *arg);\nstatic void\tbfa_fcs_itnim_free(struct bfa_fcs_itnim_s *itnim);\nstatic void\tbfa_fcs_itnim_send_prli(void *itnim_cbarg,\n\t\t\t\t\tstruct bfa_fcxp_s *fcxp_alloced);\nstatic void\tbfa_fcs_itnim_prli_response(void *fcsarg,\n\t\t\t struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t    bfa_status_t req_status, u32 rsp_len,\n\t\t\t    u32 resid_len, struct fchs_s *rsp_fchs);\nstatic void\tbfa_fcs_itnim_aen_post(struct bfa_fcs_itnim_s *itnim,\n\t\t\tenum bfa_itnim_aen_event event);\n\nstatic void\tbfa_fcs_itnim_sm_offline(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\t\t enum bfa_fcs_itnim_event event);\nstatic void\tbfa_fcs_itnim_sm_prli_send(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\t\t   enum bfa_fcs_itnim_event event);\nstatic void\tbfa_fcs_itnim_sm_prli(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\t      enum bfa_fcs_itnim_event event);\nstatic void\tbfa_fcs_itnim_sm_prli_retry(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\t\t    enum bfa_fcs_itnim_event event);\nstatic void\tbfa_fcs_itnim_sm_hcb_online(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\t\t    enum bfa_fcs_itnim_event event);\nstatic void\tbfa_fcs_itnim_sm_hal_rport_online(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\t\tenum bfa_fcs_itnim_event event);\nstatic void\tbfa_fcs_itnim_sm_online(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\t\tenum bfa_fcs_itnim_event event);\nstatic void\tbfa_fcs_itnim_sm_hcb_offline(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\t\t     enum bfa_fcs_itnim_event event);\nstatic void\tbfa_fcs_itnim_sm_initiator(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\t\t   enum bfa_fcs_itnim_event event);\n\nstatic struct bfa_sm_table_s itnim_sm_table[] = {\n\t{BFA_SM(bfa_fcs_itnim_sm_offline), BFA_ITNIM_OFFLINE},\n\t{BFA_SM(bfa_fcs_itnim_sm_prli_send), BFA_ITNIM_PRLI_SEND},\n\t{BFA_SM(bfa_fcs_itnim_sm_prli), BFA_ITNIM_PRLI_SENT},\n\t{BFA_SM(bfa_fcs_itnim_sm_prli_retry), BFA_ITNIM_PRLI_RETRY},\n\t{BFA_SM(bfa_fcs_itnim_sm_hcb_online), BFA_ITNIM_HCB_ONLINE},\n\t{BFA_SM(bfa_fcs_itnim_sm_online), BFA_ITNIM_ONLINE},\n\t{BFA_SM(bfa_fcs_itnim_sm_hcb_offline), BFA_ITNIM_HCB_OFFLINE},\n\t{BFA_SM(bfa_fcs_itnim_sm_initiator), BFA_ITNIM_INITIATIOR},\n};\n\n \n\nstatic void\nbfa_fcs_itnim_sm_offline(struct bfa_fcs_itnim_s *itnim,\n\t\t enum bfa_fcs_itnim_event event)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_trc(itnim->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_ITNIM_SM_FCS_ONLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_prli_send);\n\t\titnim->prli_retries = 0;\n\t\tbfa_fcs_itnim_send_prli(itnim, NULL);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_INITIATOR:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_DELETE:\n\t\tbfa_fcs_itnim_free(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->fcs, event);\n\t}\n\n}\n\nstatic void\nbfa_fcs_itnim_sm_prli_send(struct bfa_fcs_itnim_s *itnim,\n\t\t enum bfa_fcs_itnim_event event)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_trc(itnim->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_ITNIM_SM_FRMSENT:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_prli);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_INITIATOR:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\n\t\tbfa_fcxp_walloc_cancel(itnim->fcs->bfa, &itnim->fcxp_wqe);\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_fcxp_walloc_cancel(itnim->fcs->bfa, &itnim->fcxp_wqe);\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_fcxp_walloc_cancel(itnim->fcs->bfa, &itnim->fcxp_wqe);\n\t\tbfa_fcs_itnim_free(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_itnim_sm_prli(struct bfa_fcs_itnim_s *itnim,\n\t\t enum bfa_fcs_itnim_event event)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_trc(itnim->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_ITNIM_SM_RSP_OK:\n\t\tif (itnim->rport->scsi_function == BFA_RPORT_INITIATOR)\n\t\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\n\t\telse\n\t\t\tbfa_sm_set_state(itnim,\n\t\t\t\tbfa_fcs_itnim_sm_hal_rport_online);\n\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_RSP_ERROR:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_prli_retry);\n\t\tbfa_timer_start(itnim->fcs->bfa, &itnim->timer,\n\t\t\t\tbfa_fcs_itnim_timeout, itnim,\n\t\t\t\tBFA_FCS_RETRY_TIMEOUT);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_RSP_NOT_SUPP:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_fcxp_discard(itnim->fcxp);\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_INITIATOR:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\n\t\tbfa_fcxp_discard(itnim->fcxp);\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_fcxp_discard(itnim->fcxp);\n\t\tbfa_fcs_itnim_free(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_itnim_sm_hal_rport_online(struct bfa_fcs_itnim_s *itnim,\n\t\t\t\tenum bfa_fcs_itnim_event event)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_trc(itnim->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_ITNIM_SM_HAL_ONLINE:\n\t\tif (!itnim->bfa_itnim)\n\t\t\titnim->bfa_itnim = bfa_itnim_create(itnim->fcs->bfa,\n\t\t\t\t\titnim->rport->bfa_rport, itnim);\n\n\t\tif (itnim->bfa_itnim) {\n\t\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_hcb_online);\n\t\t\tbfa_itnim_online(itnim->bfa_itnim, itnim->seq_rec);\n\t\t} else {\n\t\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_DELETE);\n\t\t}\n\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_fcs_itnim_free(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_itnim_sm_prli_retry(struct bfa_fcs_itnim_s *itnim,\n\t\t\t    enum bfa_fcs_itnim_event event)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_trc(itnim->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_ITNIM_SM_TIMEOUT:\n\t\tif (itnim->prli_retries < BFA_FCS_RPORT_MAX_RETRIES) {\n\t\t\titnim->prli_retries++;\n\t\t\tbfa_trc(itnim->fcs, itnim->prli_retries);\n\t\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_prli_send);\n\t\t\tbfa_fcs_itnim_send_prli(itnim, NULL);\n\t\t} else {\n\t\t\t \n\t\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_LOGO_IMP);\n\t\t}\n\t\tbreak;\n\n\n\tcase BFA_FCS_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_timer_stop(&itnim->timer);\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_INITIATOR:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_initiator);\n\t\tbfa_timer_stop(&itnim->timer);\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_timer_stop(&itnim->timer);\n\t\tbfa_fcs_itnim_free(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_itnim_sm_hcb_online(struct bfa_fcs_itnim_s *itnim,\n\t\t\t    enum bfa_fcs_itnim_event event)\n{\n\tstruct bfad_s *bfad = (struct bfad_s *)itnim->fcs->bfad;\n\tchar\tlpwwn_buf[BFA_STRING_32];\n\tchar\trpwwn_buf[BFA_STRING_32];\n\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_trc(itnim->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_ITNIM_SM_HCB_ONLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_online);\n\t\tbfa_fcb_itnim_online(itnim->itnim_drv);\n\t\twwn2str(lpwwn_buf, bfa_fcs_lport_get_pwwn(itnim->rport->port));\n\t\twwn2str(rpwwn_buf, itnim->rport->pwwn);\n\t\tBFA_LOG(KERN_INFO, bfad, bfa_log_level,\n\t\t\"Target (WWN = %s) is online for initiator (WWN = %s)\\n\",\n\t\trpwwn_buf, lpwwn_buf);\n\t\tbfa_fcs_itnim_aen_post(itnim, BFA_ITNIM_AEN_ONLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_hcb_offline);\n\t\tbfa_itnim_offline(itnim->bfa_itnim);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_fcs_itnim_free(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_itnim_sm_online(struct bfa_fcs_itnim_s *itnim,\n\t\t enum bfa_fcs_itnim_event event)\n{\n\tstruct bfad_s *bfad = (struct bfad_s *)itnim->fcs->bfad;\n\tchar\tlpwwn_buf[BFA_STRING_32];\n\tchar\trpwwn_buf[BFA_STRING_32];\n\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_trc(itnim->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_hcb_offline);\n\t\tbfa_fcb_itnim_offline(itnim->itnim_drv);\n\t\tbfa_itnim_offline(itnim->bfa_itnim);\n\t\twwn2str(lpwwn_buf, bfa_fcs_lport_get_pwwn(itnim->rport->port));\n\t\twwn2str(rpwwn_buf, itnim->rport->pwwn);\n\t\tif (bfa_fcs_lport_is_online(itnim->rport->port) == BFA_TRUE) {\n\t\t\tBFA_LOG(KERN_ERR, bfad, bfa_log_level,\n\t\t\t\"Target (WWN = %s) connectivity lost for \"\n\t\t\t\"initiator (WWN = %s)\\n\", rpwwn_buf, lpwwn_buf);\n\t\t\tbfa_fcs_itnim_aen_post(itnim, BFA_ITNIM_AEN_DISCONNECT);\n\t\t} else {\n\t\t\tBFA_LOG(KERN_INFO, bfad, bfa_log_level,\n\t\t\t\"Target (WWN = %s) offlined by initiator (WWN = %s)\\n\",\n\t\t\trpwwn_buf, lpwwn_buf);\n\t\t\tbfa_fcs_itnim_aen_post(itnim, BFA_ITNIM_AEN_OFFLINE);\n\t\t}\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_fcs_itnim_free(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_itnim_sm_hcb_offline(struct bfa_fcs_itnim_s *itnim,\n\t\t\t     enum bfa_fcs_itnim_event event)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_trc(itnim->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_ITNIM_SM_HCB_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_fcs_itnim_free(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->fcs, event);\n\t}\n}\n\n \nstatic void\nbfa_fcs_itnim_sm_initiator(struct bfa_fcs_itnim_s *itnim,\n\t\t enum bfa_fcs_itnim_event event)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_trc(itnim->fcs, event);\n\n\tswitch (event) {\n\tcase BFA_FCS_ITNIM_SM_OFFLINE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_OFFLINE);\n\t\tbreak;\n\n\t \n\tcase BFA_FCS_ITNIM_SM_FCS_ONLINE:\n\t\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_FC4_FCS_ONLINE);\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_RSP_ERROR:\n\tcase BFA_FCS_ITNIM_SM_INITIATOR:\n\t\tbreak;\n\n\tcase BFA_FCS_ITNIM_SM_DELETE:\n\t\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\t\tbfa_fcs_itnim_free(itnim);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(itnim->fcs, event);\n\t}\n}\n\nstatic void\nbfa_fcs_itnim_aen_post(struct bfa_fcs_itnim_s *itnim,\n\t\t\tenum bfa_itnim_aen_event event)\n{\n\tstruct bfa_fcs_rport_s *rport = itnim->rport;\n\tstruct bfad_s *bfad = (struct bfad_s *)itnim->fcs->bfad;\n\tstruct bfa_aen_entry_s\t*aen_entry;\n\n\t \n\tif (BFA_FCS_PID_IS_WKA(rport->pid))\n\t\treturn;\n\n\tbfad_get_aen_entry(bfad, aen_entry);\n\tif (!aen_entry)\n\t\treturn;\n\n\taen_entry->aen_data.itnim.vf_id = rport->port->fabric->vf_id;\n\taen_entry->aen_data.itnim.ppwwn = bfa_fcs_lport_get_pwwn(\n\t\t\t\t\tbfa_fcs_get_base_port(itnim->fcs));\n\taen_entry->aen_data.itnim.lpwwn = bfa_fcs_lport_get_pwwn(rport->port);\n\taen_entry->aen_data.itnim.rpwwn = rport->pwwn;\n\n\t \n\tbfad_im_post_vendor_event(aen_entry, bfad, ++rport->fcs->fcs_aen_seq,\n\t\t\t\t  BFA_AEN_CAT_ITNIM, event);\n}\n\nstatic void\nbfa_fcs_itnim_send_prli(void *itnim_cbarg, struct bfa_fcxp_s *fcxp_alloced)\n{\n\tstruct bfa_fcs_itnim_s *itnim = itnim_cbarg;\n\tstruct bfa_fcs_rport_s *rport = itnim->rport;\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct fchs_s\tfchs;\n\tstruct bfa_fcxp_s *fcxp;\n\tint\t\tlen;\n\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\n\tfcxp = fcxp_alloced ? fcxp_alloced :\n\t       bfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\n\tif (!fcxp) {\n\t\titnim->stats.fcxp_alloc_wait++;\n\t\tbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &itnim->fcxp_wqe,\n\t\t\t\tbfa_fcs_itnim_send_prli, itnim, BFA_TRUE);\n\t\treturn;\n\t}\n\titnim->fcxp = fcxp;\n\n\tlen = fc_prli_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\n\t\t\t    itnim->rport->pid, bfa_fcs_lport_get_fcid(port), 0);\n\n\tbfa_fcxp_send(fcxp, rport->bfa_rport, port->fabric->vf_id, port->lp_tag,\n\t\t      BFA_FALSE, FC_CLASS_3, len, &fchs,\n\t\t      bfa_fcs_itnim_prli_response, (void *)itnim,\n\t\t      FC_MAX_PDUSZ, FC_ELS_TOV);\n\n\titnim->stats.prli_sent++;\n\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_FRMSENT);\n}\n\nstatic void\nbfa_fcs_itnim_prli_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\n\t\t\t    bfa_status_t req_status, u32 rsp_len,\n\t\t\t    u32 resid_len, struct fchs_s *rsp_fchs)\n{\n\tstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cbarg;\n\tstruct fc_els_cmd_s *els_cmd;\n\tstruct fc_prli_s *prli_resp;\n\tstruct fc_ls_rjt_s *ls_rjt;\n\tstruct fc_prli_params_s *sparams;\n\n\tbfa_trc(itnim->fcs, req_status);\n\n\t \n\tif (req_status != BFA_STATUS_OK) {\n\t\titnim->stats.prli_rsp_err++;\n\t\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_RSP_ERROR);\n\t\treturn;\n\t}\n\n\tels_cmd = (struct fc_els_cmd_s *) BFA_FCXP_RSP_PLD(fcxp);\n\n\tif (els_cmd->els_code == FC_ELS_ACC) {\n\t\tprli_resp = (struct fc_prli_s *) els_cmd;\n\n\t\tif (fc_prli_rsp_parse(prli_resp, rsp_len) != FC_PARSE_OK) {\n\t\t\tbfa_trc(itnim->fcs, rsp_len);\n\t\t\t \n\t\t\tif (prli_resp->parampage.servparams.initiator) {\n\t\t\t\tbfa_trc(itnim->fcs, prli_resp->parampage.type);\n\t\t\t\titnim->rport->scsi_function =\n\t\t\t\t\t\tBFA_RPORT_INITIATOR;\n\t\t\t\titnim->stats.prli_rsp_acc++;\n\t\t\t\titnim->stats.initiator++;\n\t\t\t\tbfa_sm_send_event(itnim,\n\t\t\t\t\t\t  BFA_FCS_ITNIM_SM_RSP_OK);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\titnim->stats.prli_rsp_parse_err++;\n\t\t\treturn;\n\t\t}\n\t\titnim->rport->scsi_function = BFA_RPORT_TARGET;\n\n\t\tsparams = &prli_resp->parampage.servparams;\n\t\titnim->seq_rec\t     = sparams->retry;\n\t\titnim->rec_support   = sparams->rec_support;\n\t\titnim->task_retry_id = sparams->task_retry_id;\n\t\titnim->conf_comp     = sparams->confirm;\n\n\t\titnim->stats.prli_rsp_acc++;\n\t\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_RSP_OK);\n\t} else {\n\t\tls_rjt = (struct fc_ls_rjt_s *) BFA_FCXP_RSP_PLD(fcxp);\n\n\t\tbfa_trc(itnim->fcs, ls_rjt->reason_code);\n\t\tbfa_trc(itnim->fcs, ls_rjt->reason_code_expl);\n\n\t\titnim->stats.prli_rsp_rjt++;\n\t\tif (ls_rjt->reason_code == FC_LS_RJT_RSN_CMD_NOT_SUPP) {\n\t\t\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_RSP_NOT_SUPP);\n\t\t\treturn;\n\t\t}\n\t\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_RSP_ERROR);\n\t}\n}\n\nstatic void\nbfa_fcs_itnim_timeout(void *arg)\n{\n\tstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) arg;\n\n\titnim->stats.timeout++;\n\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_TIMEOUT);\n}\n\nstatic void\nbfa_fcs_itnim_free(struct bfa_fcs_itnim_s *itnim)\n{\n\tif (itnim->bfa_itnim) {\n\t\tbfa_itnim_delete(itnim->bfa_itnim);\n\t\titnim->bfa_itnim = NULL;\n\t}\n\n\tbfa_fcb_itnim_free(itnim->fcs->bfad, itnim->itnim_drv);\n}\n\n\n\n \n\n \nstruct bfa_fcs_itnim_s *\nbfa_fcs_itnim_create(struct bfa_fcs_rport_s *rport)\n{\n\tstruct bfa_fcs_lport_s *port = rport->port;\n\tstruct bfa_fcs_itnim_s *itnim;\n\tstruct bfad_itnim_s   *itnim_drv;\n\tint ret;\n\n\t \n\tret = bfa_fcb_itnim_alloc(port->fcs->bfad, &itnim, &itnim_drv);\n\tif (ret) {\n\t\tbfa_trc(port->fcs, rport->pwwn);\n\t\treturn NULL;\n\t}\n\n\t \n\titnim->rport = rport;\n\titnim->fcs = rport->fcs;\n\titnim->itnim_drv = itnim_drv;\n\n\titnim->bfa_itnim     = NULL;\n\titnim->seq_rec\t     = BFA_FALSE;\n\titnim->rec_support   = BFA_FALSE;\n\titnim->conf_comp     = BFA_FALSE;\n\titnim->task_retry_id = BFA_FALSE;\n\n\t \n\tbfa_sm_set_state(itnim, bfa_fcs_itnim_sm_offline);\n\n\treturn itnim;\n}\n\n \nvoid\nbfa_fcs_itnim_delete(struct bfa_fcs_itnim_s *itnim)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pid);\n\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_DELETE);\n}\n\n \nvoid\nbfa_fcs_itnim_brp_online(struct bfa_fcs_itnim_s *itnim)\n{\n\titnim->stats.onlines++;\n\n\tif (!BFA_FCS_PID_IS_WKA(itnim->rport->pid))\n\t\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_HAL_ONLINE);\n}\n\n \nvoid\nbfa_fcs_itnim_rport_offline(struct bfa_fcs_itnim_s *itnim)\n{\n\titnim->stats.offlines++;\n\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_OFFLINE);\n}\n\n \nvoid\nbfa_fcs_itnim_is_initiator(struct bfa_fcs_itnim_s *itnim)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pid);\n\titnim->stats.initiator++;\n\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_INITIATOR);\n}\n\n \nbfa_status_t\nbfa_fcs_itnim_get_online_state(struct bfa_fcs_itnim_s *itnim)\n{\n\tbfa_trc(itnim->fcs, itnim->rport->pid);\n\tswitch (bfa_sm_to_state(itnim_sm_table, itnim->sm)) {\n\tcase BFA_ITNIM_ONLINE:\n\tcase BFA_ITNIM_INITIATIOR:\n\t\treturn BFA_STATUS_OK;\n\n\tdefault:\n\t\treturn BFA_STATUS_NO_FCPIM_NEXUS;\n\t}\n}\n\n \nvoid\nbfa_cb_itnim_online(void *cbarg)\n{\n\tstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cbarg;\n\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_HCB_ONLINE);\n}\n\n \nvoid\nbfa_cb_itnim_offline(void *cb_arg)\n{\n\tstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cb_arg;\n\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_sm_send_event(itnim, BFA_FCS_ITNIM_SM_HCB_OFFLINE);\n}\n\n \nvoid\nbfa_cb_itnim_tov_begin(void *cb_arg)\n{\n\tstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cb_arg;\n\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n}\n\n \nvoid\nbfa_cb_itnim_tov(void *cb_arg)\n{\n\tstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cb_arg;\n\tstruct bfad_itnim_s *itnim_drv = itnim->itnim_drv;\n\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\titnim_drv->state = ITNIM_STATE_TIMEOUT;\n}\n\n \nvoid\nbfa_cb_itnim_sler(void *cb_arg)\n{\n\tstruct bfa_fcs_itnim_s *itnim = (struct bfa_fcs_itnim_s *) cb_arg;\n\n\titnim->stats.sler++;\n\tbfa_trc(itnim->fcs, itnim->rport->pwwn);\n\tbfa_sm_send_event(itnim->rport, RPSM_EVENT_LOGO_IMP);\n}\n\nstruct bfa_fcs_itnim_s *\nbfa_fcs_itnim_lookup(struct bfa_fcs_lport_s *port, wwn_t rpwwn)\n{\n\tstruct bfa_fcs_rport_s *rport;\n\trport = bfa_fcs_rport_lookup(port, rpwwn);\n\n\tif (!rport)\n\t\treturn NULL;\n\n\tWARN_ON(rport->itnim == NULL);\n\treturn rport->itnim;\n}\n\nbfa_status_t\nbfa_fcs_itnim_attr_get(struct bfa_fcs_lport_s *port, wwn_t rpwwn,\n\t\t       struct bfa_itnim_attr_s *attr)\n{\n\tstruct bfa_fcs_itnim_s *itnim = NULL;\n\n\titnim = bfa_fcs_itnim_lookup(port, rpwwn);\n\n\tif (itnim == NULL)\n\t\treturn BFA_STATUS_NO_FCPIM_NEXUS;\n\n\tattr->state\t    = bfa_sm_to_state(itnim_sm_table, itnim->sm);\n\tattr->retry\t    = itnim->seq_rec;\n\tattr->rec_support   = itnim->rec_support;\n\tattr->conf_comp\t    = itnim->conf_comp;\n\tattr->task_retry_id = itnim->task_retry_id;\n\treturn BFA_STATUS_OK;\n}\n\nbfa_status_t\nbfa_fcs_itnim_stats_get(struct bfa_fcs_lport_s *port, wwn_t rpwwn,\n\t\t\tstruct bfa_itnim_stats_s *stats)\n{\n\tstruct bfa_fcs_itnim_s *itnim = NULL;\n\n\tWARN_ON(port == NULL);\n\n\titnim = bfa_fcs_itnim_lookup(port, rpwwn);\n\n\tif (itnim == NULL)\n\t\treturn BFA_STATUS_NO_FCPIM_NEXUS;\n\n\tmemcpy(stats, &itnim->stats, sizeof(struct bfa_itnim_stats_s));\n\n\treturn BFA_STATUS_OK;\n}\n\nbfa_status_t\nbfa_fcs_itnim_stats_clear(struct bfa_fcs_lport_s *port, wwn_t rpwwn)\n{\n\tstruct bfa_fcs_itnim_s *itnim = NULL;\n\n\tWARN_ON(port == NULL);\n\n\titnim = bfa_fcs_itnim_lookup(port, rpwwn);\n\n\tif (itnim == NULL)\n\t\treturn BFA_STATUS_NO_FCPIM_NEXUS;\n\n\tmemset(&itnim->stats, 0, sizeof(struct bfa_itnim_stats_s));\n\treturn BFA_STATUS_OK;\n}\n\nvoid\nbfa_fcs_fcpim_uf_recv(struct bfa_fcs_itnim_s *itnim,\n\t\t\tstruct fchs_s *fchs, u16 len)\n{\n\tstruct fc_els_cmd_s *els_cmd;\n\n\tbfa_trc(itnim->fcs, fchs->type);\n\n\tif (fchs->type != FC_TYPE_ELS)\n\t\treturn;\n\n\tels_cmd = (struct fc_els_cmd_s *) (fchs + 1);\n\n\tbfa_trc(itnim->fcs, els_cmd->els_code);\n\n\tswitch (els_cmd->els_code) {\n\tcase FC_ELS_PRLO:\n\t\tbfa_fcs_rport_prlo(itnim->rport, fchs->ox_id);\n\t\tbreak;\n\n\tdefault:\n\t\tWARN_ON(1);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}