{
  "module_name": "bfa_core.c",
  "hash_id": "cb6e5209bc4c0157881e797524d312aad80898d6cdbfe4fae746f45b1412a885",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/bfa/bfa_core.c",
  "human_readable_source": "\n \n\n#include \"bfad_drv.h\"\n#include \"bfa_modules.h\"\n#include \"bfi_reg.h\"\n\nBFA_TRC_FILE(HAL, CORE);\n\n \nstatic bfa_isr_func_t  bfa_isrs[BFI_MC_MAX] = {\n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_fcdiag_intr,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_fcport_isr,\t\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_uf_isr,\t\t \n\tbfa_fcxp_isr,\t\t \n\tbfa_lps_isr,\t\t \n\tbfa_rport_isr,\t\t \n\tbfa_itn_isr,\t\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_ioim_isr,\t\t \n\tbfa_ioim_good_comp_isr,\t \n\tbfa_tskim_isr,\t\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n\tbfa_isr_unhandled,\t \n};\n \nstatic bfa_ioc_mbox_mcfunc_t  bfa_mbox_isrs[BFI_MC_MAX] = {\n\tNULL,\n\tNULL,\t\t \n\tNULL,\t\t \n\tNULL,\t\t \n\tNULL,\t\t \n\tNULL,\t\t \n\tbfa_iocfc_isr,\t \n\tNULL,\n};\n\n\n\nvoid\n__bfa_trc(struct bfa_trc_mod_s *trcm, int fileno, int line, u64 data)\n{\n\tint\t\ttail = trcm->tail;\n\tstruct bfa_trc_s\t*trc = &trcm->trc[tail];\n\n\tif (trcm->stopped)\n\t\treturn;\n\n\ttrc->fileno = (u16) fileno;\n\ttrc->line = (u16) line;\n\ttrc->data.u64 = data;\n\ttrc->timestamp = BFA_TRC_TS(trcm);\n\n\ttrcm->tail = (trcm->tail + 1) & (BFA_TRC_MAX - 1);\n\tif (trcm->tail == trcm->head)\n\t\ttrcm->head = (trcm->head + 1) & (BFA_TRC_MAX - 1);\n}\n\nstatic void\nbfa_com_port_attach(struct bfa_s *bfa)\n{\n\tstruct bfa_port_s\t*port = &bfa->modules.port;\n\tstruct bfa_mem_dma_s\t*port_dma = BFA_MEM_PORT_DMA(bfa);\n\n\tbfa_port_attach(port, &bfa->ioc, bfa, bfa->trcmod);\n\tbfa_port_mem_claim(port, port_dma->kva_curp, port_dma->dma_curp);\n}\n\n \nstatic void\nbfa_com_ablk_attach(struct bfa_s *bfa)\n{\n\tstruct bfa_ablk_s\t*ablk = &bfa->modules.ablk;\n\tstruct bfa_mem_dma_s\t*ablk_dma = BFA_MEM_ABLK_DMA(bfa);\n\n\tbfa_ablk_attach(ablk, &bfa->ioc);\n\tbfa_ablk_memclaim(ablk, ablk_dma->kva_curp, ablk_dma->dma_curp);\n}\n\nstatic void\nbfa_com_cee_attach(struct bfa_s *bfa)\n{\n\tstruct bfa_cee_s\t*cee = &bfa->modules.cee;\n\tstruct bfa_mem_dma_s\t*cee_dma = BFA_MEM_CEE_DMA(bfa);\n\n\tcee->trcmod = bfa->trcmod;\n\tbfa_cee_attach(cee, &bfa->ioc, bfa);\n\tbfa_cee_mem_claim(cee, cee_dma->kva_curp, cee_dma->dma_curp);\n}\n\nstatic void\nbfa_com_sfp_attach(struct bfa_s *bfa)\n{\n\tstruct bfa_sfp_s\t*sfp = BFA_SFP_MOD(bfa);\n\tstruct bfa_mem_dma_s\t*sfp_dma = BFA_MEM_SFP_DMA(bfa);\n\n\tbfa_sfp_attach(sfp, &bfa->ioc, bfa, bfa->trcmod);\n\tbfa_sfp_memclaim(sfp, sfp_dma->kva_curp, sfp_dma->dma_curp);\n}\n\nstatic void\nbfa_com_flash_attach(struct bfa_s *bfa, bfa_boolean_t mincfg)\n{\n\tstruct bfa_flash_s\t*flash = BFA_FLASH(bfa);\n\tstruct bfa_mem_dma_s\t*flash_dma = BFA_MEM_FLASH_DMA(bfa);\n\n\tbfa_flash_attach(flash, &bfa->ioc, bfa, bfa->trcmod, mincfg);\n\tbfa_flash_memclaim(flash, flash_dma->kva_curp,\n\t\t\t   flash_dma->dma_curp, mincfg);\n}\n\nstatic void\nbfa_com_diag_attach(struct bfa_s *bfa)\n{\n\tstruct bfa_diag_s\t*diag = BFA_DIAG_MOD(bfa);\n\tstruct bfa_mem_dma_s\t*diag_dma = BFA_MEM_DIAG_DMA(bfa);\n\n\tbfa_diag_attach(diag, &bfa->ioc, bfa, bfa_fcport_beacon, bfa->trcmod);\n\tbfa_diag_memclaim(diag, diag_dma->kva_curp, diag_dma->dma_curp);\n}\n\nstatic void\nbfa_com_phy_attach(struct bfa_s *bfa, bfa_boolean_t mincfg)\n{\n\tstruct bfa_phy_s\t*phy = BFA_PHY(bfa);\n\tstruct bfa_mem_dma_s\t*phy_dma = BFA_MEM_PHY_DMA(bfa);\n\n\tbfa_phy_attach(phy, &bfa->ioc, bfa, bfa->trcmod, mincfg);\n\tbfa_phy_memclaim(phy, phy_dma->kva_curp, phy_dma->dma_curp, mincfg);\n}\n\nstatic void\nbfa_com_fru_attach(struct bfa_s *bfa, bfa_boolean_t mincfg)\n{\n\tstruct bfa_fru_s\t*fru = BFA_FRU(bfa);\n\tstruct bfa_mem_dma_s\t*fru_dma = BFA_MEM_FRU_DMA(bfa);\n\n\tbfa_fru_attach(fru, &bfa->ioc, bfa, bfa->trcmod, mincfg);\n\tbfa_fru_memclaim(fru, fru_dma->kva_curp, fru_dma->dma_curp, mincfg);\n}\n\n \n\n \n#define BFA_IOCFC_TOV\t\t5000\t \n\nenum {\n\tBFA_IOCFC_ACT_NONE\t= 0,\n\tBFA_IOCFC_ACT_INIT\t= 1,\n\tBFA_IOCFC_ACT_STOP\t= 2,\n\tBFA_IOCFC_ACT_DISABLE\t= 3,\n\tBFA_IOCFC_ACT_ENABLE\t= 4,\n};\n\n#define DEF_CFG_NUM_FABRICS\t\t1\n#define DEF_CFG_NUM_LPORTS\t\t256\n#define DEF_CFG_NUM_CQS\t\t\t4\n#define DEF_CFG_NUM_IOIM_REQS\t\t(BFA_IOIM_MAX)\n#define DEF_CFG_NUM_TSKIM_REQS\t\t128\n#define DEF_CFG_NUM_FCXP_REQS\t\t64\n#define DEF_CFG_NUM_UF_BUFS\t\t64\n#define DEF_CFG_NUM_RPORTS\t\t1024\n#define DEF_CFG_NUM_ITNIMS\t\t(DEF_CFG_NUM_RPORTS)\n#define DEF_CFG_NUM_TINS\t\t256\n\n#define DEF_CFG_NUM_SGPGS\t\t2048\n#define DEF_CFG_NUM_REQQ_ELEMS\t\t256\n#define DEF_CFG_NUM_RSPQ_ELEMS\t\t64\n#define DEF_CFG_NUM_SBOOT_TGTS\t\t16\n#define DEF_CFG_NUM_SBOOT_LUNS\t\t16\n\n \nbfa_fsm_state_decl(bfa_iocfc, stopped, struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, initing, struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, dconf_read, struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, init_cfg_wait,\n\t\t   struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, init_cfg_done,\n\t\t   struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, operational,\n\t\t   struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, dconf_write,\n\t\t   struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, stopping, struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, enabling, struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, cfg_wait, struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, disabling, struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, disabled, struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, failed, struct bfa_iocfc_s, enum iocfc_event);\nbfa_fsm_state_decl(bfa_iocfc, init_failed,\n\t\t   struct bfa_iocfc_s, enum iocfc_event);\n\n \nstatic void bfa_iocfc_start_submod(struct bfa_s *bfa);\nstatic void bfa_iocfc_disable_submod(struct bfa_s *bfa);\nstatic void bfa_iocfc_send_cfg(void *bfa_arg);\nstatic void bfa_iocfc_enable_cbfn(void *bfa_arg, enum bfa_status status);\nstatic void bfa_iocfc_disable_cbfn(void *bfa_arg);\nstatic void bfa_iocfc_hbfail_cbfn(void *bfa_arg);\nstatic void bfa_iocfc_reset_cbfn(void *bfa_arg);\nstatic struct bfa_ioc_cbfn_s bfa_iocfc_cbfn;\nstatic void bfa_iocfc_init_cb(void *bfa_arg, bfa_boolean_t complete);\nstatic void bfa_iocfc_stop_cb(void *bfa_arg, bfa_boolean_t compl);\nstatic void bfa_iocfc_enable_cb(void *bfa_arg, bfa_boolean_t compl);\nstatic void bfa_iocfc_disable_cb(void *bfa_arg, bfa_boolean_t compl);\n\nstatic void\nbfa_iocfc_sm_stopped_entry(struct bfa_iocfc_s *iocfc)\n{\n}\n\nstatic void\nbfa_iocfc_sm_stopped(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_INIT:\n\tcase IOCFC_E_ENABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_initing);\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_initing_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_ioc_enable(&iocfc->bfa->ioc);\n}\n\nstatic void\nbfa_iocfc_sm_initing(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_IOC_ENABLED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_dconf_read);\n\t\tbreak;\n\n\tcase IOCFC_E_DISABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_disabling);\n\t\tbreak;\n\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_stopping);\n\t\tbreak;\n\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_init_failed);\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_dconf_read_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_dconf_modinit(iocfc->bfa);\n}\n\nstatic void\nbfa_iocfc_sm_dconf_read(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_DCONF_DONE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_init_cfg_wait);\n\t\tbreak;\n\n\tcase IOCFC_E_DISABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_disabling);\n\t\tbreak;\n\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_stopping);\n\t\tbreak;\n\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_init_failed);\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_init_cfg_wait_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_iocfc_send_cfg(iocfc->bfa);\n}\n\nstatic void\nbfa_iocfc_sm_init_cfg_wait(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_CFG_DONE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_init_cfg_done);\n\t\tbreak;\n\n\tcase IOCFC_E_DISABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_disabling);\n\t\tbreak;\n\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_stopping);\n\t\tbreak;\n\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_init_failed);\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_init_cfg_done_entry(struct bfa_iocfc_s *iocfc)\n{\n\tiocfc->bfa->iocfc.op_status = BFA_STATUS_OK;\n\tbfa_cb_queue(iocfc->bfa, &iocfc->bfa->iocfc.init_hcb_qe,\n\t\t     bfa_iocfc_init_cb, iocfc->bfa);\n}\n\nstatic void\nbfa_iocfc_sm_init_cfg_done(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_START:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_operational);\n\t\tbreak;\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_stopping);\n\t\tbreak;\n\tcase IOCFC_E_DISABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_disabling);\n\t\tbreak;\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_failed);\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_operational_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_fcport_init(iocfc->bfa);\n\tbfa_iocfc_start_submod(iocfc->bfa);\n}\n\nstatic void\nbfa_iocfc_sm_operational(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_dconf_write);\n\t\tbreak;\n\tcase IOCFC_E_DISABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_disabling);\n\t\tbreak;\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_failed);\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_dconf_write_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_dconf_modexit(iocfc->bfa);\n}\n\nstatic void\nbfa_iocfc_sm_dconf_write(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_DCONF_DONE:\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_stopping);\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_stopping_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_ioc_disable(&iocfc->bfa->ioc);\n}\n\nstatic void\nbfa_iocfc_sm_stopping(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_IOC_DISABLED:\n\t\tbfa_isr_disable(iocfc->bfa);\n\t\tbfa_iocfc_disable_submod(iocfc->bfa);\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_stopped);\n\t\tiocfc->bfa->iocfc.op_status = BFA_STATUS_OK;\n\t\tbfa_cb_queue(iocfc->bfa, &iocfc->bfa->iocfc.stop_hcb_qe,\n\t\t\t     bfa_iocfc_stop_cb, iocfc->bfa);\n\t\tbreak;\n\n\tcase IOCFC_E_IOC_ENABLED:\n\tcase IOCFC_E_DCONF_DONE:\n\tcase IOCFC_E_CFG_DONE:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_enabling_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_ioc_enable(&iocfc->bfa->ioc);\n}\n\nstatic void\nbfa_iocfc_sm_enabling(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_IOC_ENABLED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_cfg_wait);\n\t\tbreak;\n\n\tcase IOCFC_E_DISABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_disabling);\n\t\tbreak;\n\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_dconf_write);\n\t\tbreak;\n\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_failed);\n\n\t\tif (iocfc->bfa->iocfc.cb_reqd == BFA_FALSE)\n\t\t\tbreak;\n\n\t\tiocfc->bfa->iocfc.op_status = BFA_STATUS_FAILED;\n\t\tbfa_cb_queue(iocfc->bfa, &iocfc->bfa->iocfc.en_hcb_qe,\n\t\t\t     bfa_iocfc_enable_cb, iocfc->bfa);\n\t\tiocfc->bfa->iocfc.cb_reqd = BFA_FALSE;\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_cfg_wait_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_iocfc_send_cfg(iocfc->bfa);\n}\n\nstatic void\nbfa_iocfc_sm_cfg_wait(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_CFG_DONE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_operational);\n\t\tif (iocfc->bfa->iocfc.cb_reqd == BFA_FALSE)\n\t\t\tbreak;\n\n\t\tiocfc->bfa->iocfc.op_status = BFA_STATUS_OK;\n\t\tbfa_cb_queue(iocfc->bfa, &iocfc->bfa->iocfc.en_hcb_qe,\n\t\t\t     bfa_iocfc_enable_cb, iocfc->bfa);\n\t\tiocfc->bfa->iocfc.cb_reqd = BFA_FALSE;\n\t\tbreak;\n\tcase IOCFC_E_DISABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_disabling);\n\t\tbreak;\n\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_dconf_write);\n\t\tbreak;\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_failed);\n\t\tif (iocfc->bfa->iocfc.cb_reqd == BFA_FALSE)\n\t\t\tbreak;\n\n\t\tiocfc->bfa->iocfc.op_status = BFA_STATUS_FAILED;\n\t\tbfa_cb_queue(iocfc->bfa, &iocfc->bfa->iocfc.en_hcb_qe,\n\t\t\t     bfa_iocfc_enable_cb, iocfc->bfa);\n\t\tiocfc->bfa->iocfc.cb_reqd = BFA_FALSE;\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_disabling_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_ioc_disable(&iocfc->bfa->ioc);\n}\n\nstatic void\nbfa_iocfc_sm_disabling(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_IOC_DISABLED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_disabled);\n\t\tbreak;\n\tcase IOCFC_E_IOC_ENABLED:\n\tcase IOCFC_E_DCONF_DONE:\n\tcase IOCFC_E_CFG_DONE:\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_disabled_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_isr_disable(iocfc->bfa);\n\tbfa_iocfc_disable_submod(iocfc->bfa);\n\tiocfc->bfa->iocfc.op_status = BFA_STATUS_OK;\n\tbfa_cb_queue(iocfc->bfa, &iocfc->bfa->iocfc.dis_hcb_qe,\n\t\t     bfa_iocfc_disable_cb, iocfc->bfa);\n}\n\nstatic void\nbfa_iocfc_sm_disabled(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_dconf_write);\n\t\tbreak;\n\tcase IOCFC_E_ENABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_enabling);\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_failed_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_isr_disable(iocfc->bfa);\n\tbfa_iocfc_disable_submod(iocfc->bfa);\n}\n\nstatic void\nbfa_iocfc_sm_failed(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_dconf_write);\n\t\tbreak;\n\tcase IOCFC_E_DISABLE:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_disabling);\n\t\tbreak;\n\tcase IOCFC_E_IOC_ENABLED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_cfg_wait);\n\t\tbreak;\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbfa_iocfc_sm_init_failed_entry(struct bfa_iocfc_s *iocfc)\n{\n\tbfa_isr_disable(iocfc->bfa);\n\tiocfc->bfa->iocfc.op_status = BFA_STATUS_FAILED;\n\tbfa_cb_queue(iocfc->bfa, &iocfc->bfa->iocfc.init_hcb_qe,\n\t\t     bfa_iocfc_init_cb, iocfc->bfa);\n}\n\nstatic void\nbfa_iocfc_sm_init_failed(struct bfa_iocfc_s *iocfc, enum iocfc_event event)\n{\n\tbfa_trc(iocfc->bfa, event);\n\n\tswitch (event) {\n\tcase IOCFC_E_STOP:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_stopping);\n\t\tbreak;\n\tcase IOCFC_E_DISABLE:\n\t\tbfa_ioc_disable(&iocfc->bfa->ioc);\n\t\tbreak;\n\tcase IOCFC_E_IOC_ENABLED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_dconf_read);\n\t\tbreak;\n\tcase IOCFC_E_IOC_DISABLED:\n\t\tbfa_fsm_set_state(iocfc, bfa_iocfc_sm_stopped);\n\t\tiocfc->bfa->iocfc.op_status = BFA_STATUS_OK;\n\t\tbfa_cb_queue(iocfc->bfa, &iocfc->bfa->iocfc.dis_hcb_qe,\n\t\t\t     bfa_iocfc_disable_cb, iocfc->bfa);\n\t\tbreak;\n\tcase IOCFC_E_IOC_FAILED:\n\t\tbreak;\n\tdefault:\n\t\tbfa_sm_fault(iocfc->bfa, event);\n\t\tbreak;\n\t}\n}\n\n \nstatic void\nbfa_reqq_resume(struct bfa_s *bfa, int qid)\n{\n\tstruct list_head *waitq, *qe, *qen;\n\tstruct bfa_reqq_wait_s *wqe;\n\n\twaitq = bfa_reqq(bfa, qid);\n\tlist_for_each_safe(qe, qen, waitq) {\n\t\t \n\t\tif (bfa_reqq_full(bfa, qid))\n\t\t\tbreak;\n\n\t\tlist_del(qe);\n\t\twqe = (struct bfa_reqq_wait_s *) qe;\n\t\twqe->qresume(wqe->cbarg);\n\t}\n}\n\nstatic bfa_boolean_t\nbfa_isr_rspq(struct bfa_s *bfa, int qid)\n{\n\tstruct bfi_msg_s *m;\n\tu32\tpi, ci;\n\tstruct list_head *waitq;\n\tbfa_boolean_t ret;\n\n\tci = bfa_rspq_ci(bfa, qid);\n\tpi = bfa_rspq_pi(bfa, qid);\n\n\tret = (ci != pi);\n\n\twhile (ci != pi) {\n\t\tm = bfa_rspq_elem(bfa, qid, ci);\n\t\tWARN_ON(m->mhdr.msg_class >= BFI_MC_MAX);\n\n\t\tbfa_isrs[m->mhdr.msg_class] (bfa, m);\n\t\tCQ_INCR(ci, bfa->iocfc.cfg.drvcfg.num_rspq_elems);\n\t}\n\n\t \n\tbfa_isr_rspq_ack(bfa, qid, ci);\n\n\t \n\twaitq = bfa_reqq(bfa, qid);\n\tif (!list_empty(waitq))\n\t\tbfa_reqq_resume(bfa, qid);\n\n\treturn ret;\n}\n\nstatic inline void\nbfa_isr_reqq(struct bfa_s *bfa, int qid)\n{\n\tstruct list_head *waitq;\n\n\tbfa_isr_reqq_ack(bfa, qid);\n\n\t \n\twaitq = bfa_reqq(bfa, qid);\n\tif (!list_empty(waitq))\n\t\tbfa_reqq_resume(bfa, qid);\n}\n\nvoid\nbfa_msix_all(struct bfa_s *bfa, int vec)\n{\n\tu32\tintr, qintr;\n\tint\tqueue;\n\n\tintr = readl(bfa->iocfc.bfa_regs.intr_status);\n\tif (!intr)\n\t\treturn;\n\n\t \n\tqintr = intr & __HFN_INT_RME_MASK;\n\tif (qintr && bfa->queue_process) {\n\t\tfor (queue = 0; queue < BFI_IOC_MAX_CQS; queue++)\n\t\t\tbfa_isr_rspq(bfa, queue);\n\t}\n\n\tintr &= ~qintr;\n\tif (!intr)\n\t\treturn;\n\n\t \n\tqintr = intr & __HFN_INT_CPE_MASK;\n\tif (qintr && bfa->queue_process) {\n\t\tfor (queue = 0; queue < BFI_IOC_MAX_CQS; queue++)\n\t\t\tbfa_isr_reqq(bfa, queue);\n\t}\n\tintr &= ~qintr;\n\tif (!intr)\n\t\treturn;\n\n\tbfa_msix_lpu_err(bfa, intr);\n}\n\nbfa_boolean_t\nbfa_intx(struct bfa_s *bfa)\n{\n\tu32 intr, qintr;\n\tint queue;\n\tbfa_boolean_t rspq_comp = BFA_FALSE;\n\n\tintr = readl(bfa->iocfc.bfa_regs.intr_status);\n\n\tqintr = intr & (__HFN_INT_RME_MASK | __HFN_INT_CPE_MASK);\n\tif (qintr)\n\t\twritel(qintr, bfa->iocfc.bfa_regs.intr_status);\n\n\t \n\tif (bfa->queue_process) {\n\t\tfor (queue = 0; queue < BFI_IOC_MAX_CQS; queue++)\n\t\t\tif (bfa_isr_rspq(bfa, queue))\n\t\t\t\trspq_comp = BFA_TRUE;\n\t}\n\n\tif (!intr)\n\t\treturn (qintr | rspq_comp) ? BFA_TRUE : BFA_FALSE;\n\n\t \n\tqintr = intr & __HFN_INT_CPE_MASK;\n\tif (qintr && bfa->queue_process) {\n\t\tfor (queue = 0; queue < BFI_IOC_MAX_CQS; queue++)\n\t\t\tbfa_isr_reqq(bfa, queue);\n\t}\n\tintr &= ~qintr;\n\tif (!intr)\n\t\treturn BFA_TRUE;\n\n\tif (bfa->intr_enabled)\n\t\tbfa_msix_lpu_err(bfa, intr);\n\n\treturn BFA_TRUE;\n}\n\nvoid\nbfa_isr_enable(struct bfa_s *bfa)\n{\n\tu32 umsk;\n\tint port_id = bfa_ioc_portid(&bfa->ioc);\n\n\tbfa_trc(bfa, bfa_ioc_pcifn(&bfa->ioc));\n\tbfa_trc(bfa, port_id);\n\n\tbfa_msix_ctrl_install(bfa);\n\n\tif (bfa_asic_id_ct2(bfa->ioc.pcidev.device_id)) {\n\t\tumsk = __HFN_INT_ERR_MASK_CT2;\n\t\tumsk |= port_id == 0 ?\n\t\t\t__HFN_INT_FN0_MASK_CT2 : __HFN_INT_FN1_MASK_CT2;\n\t} else {\n\t\tumsk = __HFN_INT_ERR_MASK;\n\t\tumsk |= port_id == 0 ? __HFN_INT_FN0_MASK : __HFN_INT_FN1_MASK;\n\t}\n\n\twritel(umsk, bfa->iocfc.bfa_regs.intr_status);\n\twritel(~umsk, bfa->iocfc.bfa_regs.intr_mask);\n\tbfa->iocfc.intr_mask = ~umsk;\n\tbfa_isr_mode_set(bfa, bfa->msix.nvecs != 0);\n\n\t \n\tbfa->intr_enabled = BFA_TRUE;\n}\n\nvoid\nbfa_isr_disable(struct bfa_s *bfa)\n{\n\tbfa->intr_enabled = BFA_FALSE;\n\tbfa_isr_mode_set(bfa, BFA_FALSE);\n\twritel(-1L, bfa->iocfc.bfa_regs.intr_mask);\n\tbfa_msix_uninstall(bfa);\n}\n\nvoid\nbfa_msix_reqq(struct bfa_s *bfa, int vec)\n{\n\tbfa_isr_reqq(bfa, vec - bfa->iocfc.hwif.cpe_vec_q0);\n}\n\nvoid\nbfa_isr_unhandled(struct bfa_s *bfa, struct bfi_msg_s *m)\n{\n\tbfa_trc(bfa, m->mhdr.msg_class);\n\tbfa_trc(bfa, m->mhdr.msg_id);\n\tbfa_trc(bfa, m->mhdr.mtag.i2htok);\n\tWARN_ON(1);\n\tbfa_trc_stop(bfa->trcmod);\n}\n\nvoid\nbfa_msix_rspq(struct bfa_s *bfa, int vec)\n{\n\tbfa_isr_rspq(bfa, vec - bfa->iocfc.hwif.rme_vec_q0);\n}\n\nvoid\nbfa_msix_lpu_err(struct bfa_s *bfa, int vec)\n{\n\tu32 intr, curr_value;\n\tbfa_boolean_t lpu_isr, halt_isr, pss_isr;\n\n\tintr = readl(bfa->iocfc.bfa_regs.intr_status);\n\n\tif (bfa_asic_id_ct2(bfa->ioc.pcidev.device_id)) {\n\t\thalt_isr = intr & __HFN_INT_CPQ_HALT_CT2;\n\t\tpss_isr  = intr & __HFN_INT_ERR_PSS_CT2;\n\t\tlpu_isr  = intr & (__HFN_INT_MBOX_LPU0_CT2 |\n\t\t\t\t   __HFN_INT_MBOX_LPU1_CT2);\n\t\tintr    &= __HFN_INT_ERR_MASK_CT2;\n\t} else {\n\t\thalt_isr = bfa_asic_id_ct(bfa->ioc.pcidev.device_id) ?\n\t\t\t\t\t  (intr & __HFN_INT_LL_HALT) : 0;\n\t\tpss_isr  = intr & __HFN_INT_ERR_PSS;\n\t\tlpu_isr  = intr & (__HFN_INT_MBOX_LPU0 | __HFN_INT_MBOX_LPU1);\n\t\tintr    &= __HFN_INT_ERR_MASK;\n\t}\n\n\tif (lpu_isr)\n\t\tbfa_ioc_mbox_isr(&bfa->ioc);\n\n\tif (intr) {\n\t\tif (halt_isr) {\n\t\t\t \n\t\t\tcurr_value = readl(bfa->ioc.ioc_regs.ll_halt);\n\t\t\tcurr_value &= ~__FW_INIT_HALT_P;\n\t\t\twritel(curr_value, bfa->ioc.ioc_regs.ll_halt);\n\t\t}\n\n\t\tif (pss_isr) {\n\t\t\t \n\t\t\tcurr_value = readl(\n\t\t\t\t\tbfa->ioc.ioc_regs.pss_err_status_reg);\n\t\t\twritel(curr_value,\n\t\t\t\tbfa->ioc.ioc_regs.pss_err_status_reg);\n\t\t}\n\n\t\twritel(intr, bfa->iocfc.bfa_regs.intr_status);\n\t\tbfa_ioc_error_isr(&bfa->ioc);\n\t}\n}\n\n \n\n \n\n \nstatic void\nbfa_iocfc_send_cfg(void *bfa_arg)\n{\n\tstruct bfa_s *bfa = bfa_arg;\n\tstruct bfa_iocfc_s *iocfc = &bfa->iocfc;\n\tstruct bfi_iocfc_cfg_req_s cfg_req;\n\tstruct bfi_iocfc_cfg_s *cfg_info = iocfc->cfginfo;\n\tstruct bfa_iocfc_cfg_s\t*cfg = &iocfc->cfg;\n\tint\t\ti;\n\n\tWARN_ON(cfg->fwcfg.num_cqs > BFI_IOC_MAX_CQS);\n\tbfa_trc(bfa, cfg->fwcfg.num_cqs);\n\n\tbfa_iocfc_reset_queues(bfa);\n\n\t \n\tcfg_info->single_msix_vec = 0;\n\tif (bfa->msix.nvecs == 1)\n\t\tcfg_info->single_msix_vec = 1;\n\tcfg_info->endian_sig = BFI_IOC_ENDIAN_SIG;\n\tcfg_info->num_cqs = cfg->fwcfg.num_cqs;\n\tcfg_info->num_ioim_reqs = cpu_to_be16(bfa_fcpim_get_throttle_cfg(bfa,\n\t\t\t\t\t       cfg->fwcfg.num_ioim_reqs));\n\tcfg_info->num_fwtio_reqs = cpu_to_be16(cfg->fwcfg.num_fwtio_reqs);\n\n\tbfa_dma_be_addr_set(cfg_info->cfgrsp_addr, iocfc->cfgrsp_dma.pa);\n\t \n\tfor (i = 0; i < cfg->fwcfg.num_cqs; i++) {\n\t\tbfa_dma_be_addr_set(cfg_info->req_cq_ba[i],\n\t\t\t\t    iocfc->req_cq_ba[i].pa);\n\t\tbfa_dma_be_addr_set(cfg_info->req_shadow_ci[i],\n\t\t\t\t    iocfc->req_cq_shadow_ci[i].pa);\n\t\tcfg_info->req_cq_elems[i] =\n\t\t\tcpu_to_be16(cfg->drvcfg.num_reqq_elems);\n\n\t\tbfa_dma_be_addr_set(cfg_info->rsp_cq_ba[i],\n\t\t\t\t    iocfc->rsp_cq_ba[i].pa);\n\t\tbfa_dma_be_addr_set(cfg_info->rsp_shadow_pi[i],\n\t\t\t\t    iocfc->rsp_cq_shadow_pi[i].pa);\n\t\tcfg_info->rsp_cq_elems[i] =\n\t\t\tcpu_to_be16(cfg->drvcfg.num_rspq_elems);\n\t}\n\n\t \n\tif (bfa_fsm_cmp_state(iocfc, bfa_iocfc_sm_init_cfg_wait))\n\t\tcfg_info->intr_attr.coalesce = BFA_TRUE;\n\n\t \n\tbfi_h2i_set(cfg_req.mh, BFI_MC_IOCFC, BFI_IOCFC_H2I_CFG_REQ,\n\t\t    bfa_fn_lpu(bfa));\n\tbfa_dma_be_addr_set(cfg_req.ioc_cfg_dma_addr, iocfc->cfg_info.pa);\n\n\tbfa_ioc_mbox_send(&bfa->ioc, &cfg_req,\n\t\t\t  sizeof(struct bfi_iocfc_cfg_req_s));\n}\n\nstatic void\nbfa_iocfc_init_mem(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\n\t\t   struct bfa_pcidev_s *pcidev)\n{\n\tstruct bfa_iocfc_s\t*iocfc = &bfa->iocfc;\n\n\tbfa->bfad = bfad;\n\tiocfc->bfa = bfa;\n\tiocfc->cfg = *cfg;\n\n\t \n\tif (bfa_asic_id_ctc(bfa_ioc_devid(&bfa->ioc))) {\n\t\tiocfc->hwif.hw_reginit = bfa_hwct_reginit;\n\t\tiocfc->hwif.hw_reqq_ack = bfa_hwct_reqq_ack;\n\t\tiocfc->hwif.hw_rspq_ack = bfa_hwct_rspq_ack;\n\t\tiocfc->hwif.hw_msix_init = bfa_hwct_msix_init;\n\t\tiocfc->hwif.hw_msix_ctrl_install = bfa_hwct_msix_ctrl_install;\n\t\tiocfc->hwif.hw_msix_queue_install = bfa_hwct_msix_queue_install;\n\t\tiocfc->hwif.hw_msix_uninstall = bfa_hwct_msix_uninstall;\n\t\tiocfc->hwif.hw_isr_mode_set = bfa_hwct_isr_mode_set;\n\t\tiocfc->hwif.hw_msix_getvecs = bfa_hwct_msix_getvecs;\n\t\tiocfc->hwif.hw_msix_get_rme_range = bfa_hwct_msix_get_rme_range;\n\t\tiocfc->hwif.rme_vec_q0 = BFI_MSIX_RME_QMIN_CT;\n\t\tiocfc->hwif.cpe_vec_q0 = BFI_MSIX_CPE_QMIN_CT;\n\t} else {\n\t\tiocfc->hwif.hw_reginit = bfa_hwcb_reginit;\n\t\tiocfc->hwif.hw_reqq_ack = NULL;\n\t\tiocfc->hwif.hw_rspq_ack = bfa_hwcb_rspq_ack;\n\t\tiocfc->hwif.hw_msix_init = bfa_hwcb_msix_init;\n\t\tiocfc->hwif.hw_msix_ctrl_install = bfa_hwcb_msix_ctrl_install;\n\t\tiocfc->hwif.hw_msix_queue_install = bfa_hwcb_msix_queue_install;\n\t\tiocfc->hwif.hw_msix_uninstall = bfa_hwcb_msix_uninstall;\n\t\tiocfc->hwif.hw_isr_mode_set = bfa_hwcb_isr_mode_set;\n\t\tiocfc->hwif.hw_msix_getvecs = bfa_hwcb_msix_getvecs;\n\t\tiocfc->hwif.hw_msix_get_rme_range = bfa_hwcb_msix_get_rme_range;\n\t\tiocfc->hwif.rme_vec_q0 = BFI_MSIX_RME_QMIN_CB +\n\t\t\tbfa_ioc_pcifn(&bfa->ioc) * BFI_IOC_MAX_CQS;\n\t\tiocfc->hwif.cpe_vec_q0 = BFI_MSIX_CPE_QMIN_CB +\n\t\t\tbfa_ioc_pcifn(&bfa->ioc) * BFI_IOC_MAX_CQS;\n\t}\n\n\tif (bfa_asic_id_ct2(bfa_ioc_devid(&bfa->ioc))) {\n\t\tiocfc->hwif.hw_reginit = bfa_hwct2_reginit;\n\t\tiocfc->hwif.hw_isr_mode_set = NULL;\n\t\tiocfc->hwif.hw_rspq_ack = bfa_hwct2_rspq_ack;\n\t}\n\n\tiocfc->hwif.hw_reginit(bfa);\n\tbfa->msix.nvecs = 0;\n}\n\nstatic void\nbfa_iocfc_mem_claim(struct bfa_s *bfa, struct bfa_iocfc_cfg_s *cfg)\n{\n\tu8\t*dm_kva = NULL;\n\tu64\tdm_pa = 0;\n\tint\ti, per_reqq_sz, per_rspq_sz;\n\tstruct bfa_iocfc_s  *iocfc = &bfa->iocfc;\n\tstruct bfa_mem_dma_s *ioc_dma = BFA_MEM_IOC_DMA(bfa);\n\tstruct bfa_mem_dma_s *iocfc_dma = BFA_MEM_IOCFC_DMA(bfa);\n\tstruct bfa_mem_dma_s *reqq_dma, *rspq_dma;\n\n\t \n\tbfa_ioc_mem_claim(&bfa->ioc, bfa_mem_dma_virt(ioc_dma),\n\t\t\tbfa_mem_dma_phys(ioc_dma));\n\n\t \n\tper_reqq_sz = BFA_ROUNDUP((cfg->drvcfg.num_reqq_elems * BFI_LMSG_SZ),\n\t\t\t\tBFA_DMA_ALIGN_SZ);\n\tper_rspq_sz = BFA_ROUNDUP((cfg->drvcfg.num_rspq_elems * BFI_LMSG_SZ),\n\t\t\t\tBFA_DMA_ALIGN_SZ);\n\n\tfor (i = 0; i < cfg->fwcfg.num_cqs; i++) {\n\t\treqq_dma = BFA_MEM_REQQ_DMA(bfa, i);\n\t\tiocfc->req_cq_ba[i].kva = bfa_mem_dma_virt(reqq_dma);\n\t\tiocfc->req_cq_ba[i].pa = bfa_mem_dma_phys(reqq_dma);\n\t\tmemset(iocfc->req_cq_ba[i].kva, 0, per_reqq_sz);\n\n\t\trspq_dma = BFA_MEM_RSPQ_DMA(bfa, i);\n\t\tiocfc->rsp_cq_ba[i].kva = bfa_mem_dma_virt(rspq_dma);\n\t\tiocfc->rsp_cq_ba[i].pa = bfa_mem_dma_phys(rspq_dma);\n\t\tmemset(iocfc->rsp_cq_ba[i].kva, 0, per_rspq_sz);\n\t}\n\n\t \n\tdm_kva = bfa_mem_dma_virt(iocfc_dma);\n\tdm_pa  = bfa_mem_dma_phys(iocfc_dma);\n\n\tfor (i = 0; i < cfg->fwcfg.num_cqs; i++) {\n\t\tiocfc->req_cq_shadow_ci[i].kva = dm_kva;\n\t\tiocfc->req_cq_shadow_ci[i].pa = dm_pa;\n\t\tdm_kva += BFA_CACHELINE_SZ;\n\t\tdm_pa += BFA_CACHELINE_SZ;\n\n\t\tiocfc->rsp_cq_shadow_pi[i].kva = dm_kva;\n\t\tiocfc->rsp_cq_shadow_pi[i].pa = dm_pa;\n\t\tdm_kva += BFA_CACHELINE_SZ;\n\t\tdm_pa += BFA_CACHELINE_SZ;\n\t}\n\n\t \n\tbfa->iocfc.cfg_info.kva = dm_kva;\n\tbfa->iocfc.cfg_info.pa = dm_pa;\n\tbfa->iocfc.cfginfo = (struct bfi_iocfc_cfg_s *) dm_kva;\n\tdm_kva += BFA_ROUNDUP(sizeof(struct bfi_iocfc_cfg_s), BFA_CACHELINE_SZ);\n\tdm_pa += BFA_ROUNDUP(sizeof(struct bfi_iocfc_cfg_s), BFA_CACHELINE_SZ);\n\n\t \n\tbfa->iocfc.cfgrsp_dma.kva = dm_kva;\n\tbfa->iocfc.cfgrsp_dma.pa = dm_pa;\n\tbfa->iocfc.cfgrsp = (struct bfi_iocfc_cfgrsp_s *) dm_kva;\n\tdm_kva += BFA_ROUNDUP(sizeof(struct bfi_iocfc_cfgrsp_s),\n\t\t\tBFA_CACHELINE_SZ);\n\tdm_pa += BFA_ROUNDUP(sizeof(struct bfi_iocfc_cfgrsp_s),\n\t\t\tBFA_CACHELINE_SZ);\n\n\t \n\tbfa_ioc_debug_memclaim(&bfa->ioc, bfa_mem_kva_curp(iocfc));\n\tbfa_mem_kva_curp(iocfc) += BFA_DBG_FWTRC_LEN;\n}\n\n \nstatic void\nbfa_iocfc_start_submod(struct bfa_s *bfa)\n{\n\tint\t\ti;\n\n\tbfa->queue_process = BFA_TRUE;\n\tfor (i = 0; i < BFI_IOC_MAX_CQS; i++)\n\t\tbfa_isr_rspq_ack(bfa, i, bfa_rspq_ci(bfa, i));\n\n\tbfa_fcport_start(bfa);\n\tbfa_uf_start(bfa);\n\t \n\tbfa_ioim_lm_init(BFA_FCP_MOD(bfa)->bfa);\n\n\tbfa->iocfc.submod_enabled = BFA_TRUE;\n}\n\n \nstatic void\nbfa_iocfc_disable_submod(struct bfa_s *bfa)\n{\n\tif (bfa->iocfc.submod_enabled == BFA_FALSE)\n\t\treturn;\n\n\tbfa_fcdiag_iocdisable(bfa);\n\tbfa_fcport_iocdisable(bfa);\n\tbfa_fcxp_iocdisable(bfa);\n\tbfa_lps_iocdisable(bfa);\n\tbfa_rport_iocdisable(bfa);\n\tbfa_fcp_iocdisable(bfa);\n\tbfa_dconf_iocdisable(bfa);\n\n\tbfa->iocfc.submod_enabled = BFA_FALSE;\n}\n\nstatic void\nbfa_iocfc_init_cb(void *bfa_arg, bfa_boolean_t complete)\n{\n\tstruct bfa_s\t*bfa = bfa_arg;\n\n\tif (complete)\n\t\tbfa_cb_init(bfa->bfad, bfa->iocfc.op_status);\n}\n\nstatic void\nbfa_iocfc_stop_cb(void *bfa_arg, bfa_boolean_t compl)\n{\n\tstruct bfa_s  *bfa = bfa_arg;\n\tstruct bfad_s *bfad = bfa->bfad;\n\n\tif (compl)\n\t\tcomplete(&bfad->comp);\n}\n\nstatic void\nbfa_iocfc_enable_cb(void *bfa_arg, bfa_boolean_t compl)\n{\n\tstruct bfa_s\t*bfa = bfa_arg;\n\tstruct bfad_s *bfad = bfa->bfad;\n\n\tif (compl)\n\t\tcomplete(&bfad->enable_comp);\n}\n\nstatic void\nbfa_iocfc_disable_cb(void *bfa_arg, bfa_boolean_t compl)\n{\n\tstruct bfa_s  *bfa = bfa_arg;\n\tstruct bfad_s *bfad = bfa->bfad;\n\n\tif (compl)\n\t\tcomplete(&bfad->disable_comp);\n}\n\n \nstatic void\nbfa_iocfc_qreg(struct bfa_s *bfa, struct bfi_iocfc_qreg_s *qreg)\n{\n\tint     i;\n\tstruct bfa_iocfc_regs_s *r = &bfa->iocfc.bfa_regs;\n\tvoid __iomem *kva = bfa_ioc_bar0(&bfa->ioc);\n\n\tfor (i = 0; i < BFI_IOC_MAX_CQS; i++) {\n\t\tbfa->iocfc.hw_qid[i] = qreg->hw_qid[i];\n\t\tr->cpe_q_ci[i] = kva + be32_to_cpu(qreg->cpe_q_ci_off[i]);\n\t\tr->cpe_q_pi[i] = kva + be32_to_cpu(qreg->cpe_q_pi_off[i]);\n\t\tr->cpe_q_ctrl[i] = kva + be32_to_cpu(qreg->cpe_qctl_off[i]);\n\t\tr->rme_q_ci[i] = kva + be32_to_cpu(qreg->rme_q_ci_off[i]);\n\t\tr->rme_q_pi[i] = kva + be32_to_cpu(qreg->rme_q_pi_off[i]);\n\t\tr->rme_q_ctrl[i] = kva + be32_to_cpu(qreg->rme_qctl_off[i]);\n\t}\n}\n\nstatic void\nbfa_iocfc_res_recfg(struct bfa_s *bfa, struct bfa_iocfc_fwcfg_s *fwcfg)\n{\n\tstruct bfa_iocfc_s\t*iocfc   = &bfa->iocfc;\n\tstruct bfi_iocfc_cfg_s\t*cfg_info = iocfc->cfginfo;\n\n\tbfa_fcxp_res_recfg(bfa, fwcfg->num_fcxp_reqs);\n\tbfa_uf_res_recfg(bfa, fwcfg->num_uf_bufs);\n\tbfa_rport_res_recfg(bfa, fwcfg->num_rports);\n\tbfa_fcp_res_recfg(bfa, cpu_to_be16(cfg_info->num_ioim_reqs),\n\t\t\t  fwcfg->num_ioim_reqs);\n\tbfa_tskim_res_recfg(bfa, fwcfg->num_tskim_reqs);\n}\n\n \nstatic void\nbfa_iocfc_cfgrsp(struct bfa_s *bfa)\n{\n\tstruct bfa_iocfc_s\t\t*iocfc\t = &bfa->iocfc;\n\tstruct bfi_iocfc_cfgrsp_s\t*cfgrsp\t = iocfc->cfgrsp;\n\tstruct bfa_iocfc_fwcfg_s\t*fwcfg\t = &cfgrsp->fwcfg;\n\n\tfwcfg->num_cqs\t      = fwcfg->num_cqs;\n\tfwcfg->num_ioim_reqs  = be16_to_cpu(fwcfg->num_ioim_reqs);\n\tfwcfg->num_fwtio_reqs = be16_to_cpu(fwcfg->num_fwtio_reqs);\n\tfwcfg->num_tskim_reqs = be16_to_cpu(fwcfg->num_tskim_reqs);\n\tfwcfg->num_fcxp_reqs  = be16_to_cpu(fwcfg->num_fcxp_reqs);\n\tfwcfg->num_uf_bufs    = be16_to_cpu(fwcfg->num_uf_bufs);\n\tfwcfg->num_rports     = be16_to_cpu(fwcfg->num_rports);\n\n\t \n\tbfa_iocfc_qreg(bfa, &cfgrsp->qreg);\n\n\t \n\tbfa_iocfc_res_recfg(bfa, fwcfg);\n\n\t \n\tbfa_msix_queue_install(bfa);\n\n\tif (bfa->iocfc.cfgrsp->pbc_cfg.pbc_pwwn != 0) {\n\t\tbfa->ioc.attr->pwwn = bfa->iocfc.cfgrsp->pbc_cfg.pbc_pwwn;\n\t\tbfa->ioc.attr->nwwn = bfa->iocfc.cfgrsp->pbc_cfg.pbc_nwwn;\n\t\tbfa_fsm_send_event(iocfc, IOCFC_E_CFG_DONE);\n\t}\n}\n\nvoid\nbfa_iocfc_reset_queues(struct bfa_s *bfa)\n{\n\tint\t\tq;\n\n\tfor (q = 0; q < BFI_IOC_MAX_CQS; q++) {\n\t\tbfa_reqq_ci(bfa, q) = 0;\n\t\tbfa_reqq_pi(bfa, q) = 0;\n\t\tbfa_rspq_ci(bfa, q) = 0;\n\t\tbfa_rspq_pi(bfa, q) = 0;\n\t}\n}\n\n \nstatic void\nbfa_iocfc_process_faa_addr(struct bfa_s *bfa, struct bfi_faa_addr_msg_s *msg)\n{\n\tstruct bfa_iocfc_s\t\t*iocfc   = &bfa->iocfc;\n\tstruct bfi_iocfc_cfgrsp_s\t*cfgrsp  = iocfc->cfgrsp;\n\n\tcfgrsp->pbc_cfg.pbc_pwwn = msg->pwwn;\n\tcfgrsp->pbc_cfg.pbc_nwwn = msg->nwwn;\n\n\tbfa->ioc.attr->pwwn = msg->pwwn;\n\tbfa->ioc.attr->nwwn = msg->nwwn;\n\tbfa_fsm_send_event(iocfc, IOCFC_E_CFG_DONE);\n}\n\n \n\n \nstatic bfa_status_t\nbfa_faa_validate_request(struct bfa_s *bfa)\n{\n\tenum bfa_ioc_type_e\tioc_type = bfa_get_type(bfa);\n\tu32\tcard_type = bfa->ioc.attr->card_type;\n\n\tif (bfa_ioc_is_operational(&bfa->ioc)) {\n\t\tif ((ioc_type != BFA_IOC_TYPE_FC) || bfa_mfg_is_mezz(card_type))\n\t\t\treturn BFA_STATUS_FEATURE_NOT_SUPPORTED;\n\t} else {\n\t\treturn BFA_STATUS_IOC_NON_OP;\n\t}\n\n\treturn BFA_STATUS_OK;\n}\n\nbfa_status_t\nbfa_faa_query(struct bfa_s *bfa, struct bfa_faa_attr_s *attr,\n\t\tbfa_cb_iocfc_t cbfn, void *cbarg)\n{\n\tstruct bfi_faa_query_s  faa_attr_req;\n\tstruct bfa_iocfc_s      *iocfc = &bfa->iocfc;\n\tbfa_status_t            status;\n\n\tstatus = bfa_faa_validate_request(bfa);\n\tif (status != BFA_STATUS_OK)\n\t\treturn status;\n\n\tif (iocfc->faa_args.busy == BFA_TRUE)\n\t\treturn BFA_STATUS_DEVBUSY;\n\n\tiocfc->faa_args.faa_attr = attr;\n\tiocfc->faa_args.faa_cb.faa_cbfn = cbfn;\n\tiocfc->faa_args.faa_cb.faa_cbarg = cbarg;\n\n\tiocfc->faa_args.busy = BFA_TRUE;\n\tmemset(&faa_attr_req, 0, sizeof(struct bfi_faa_query_s));\n\tbfi_h2i_set(faa_attr_req.mh, BFI_MC_IOCFC,\n\t\tBFI_IOCFC_H2I_FAA_QUERY_REQ, bfa_fn_lpu(bfa));\n\n\tbfa_ioc_mbox_send(&bfa->ioc, &faa_attr_req,\n\t\tsizeof(struct bfi_faa_query_s));\n\n\treturn BFA_STATUS_OK;\n}\n\n \nstatic void\nbfa_faa_query_reply(struct bfa_iocfc_s *iocfc,\n\t\tbfi_faa_query_rsp_t *rsp)\n{\n\tvoid\t*cbarg = iocfc->faa_args.faa_cb.faa_cbarg;\n\n\tif (iocfc->faa_args.faa_attr) {\n\t\tiocfc->faa_args.faa_attr->faa = rsp->faa;\n\t\tiocfc->faa_args.faa_attr->faa_state = rsp->faa_status;\n\t\tiocfc->faa_args.faa_attr->pwwn_source = rsp->addr_source;\n\t}\n\n\tWARN_ON(!iocfc->faa_args.faa_cb.faa_cbfn);\n\n\tiocfc->faa_args.faa_cb.faa_cbfn(cbarg, BFA_STATUS_OK);\n\tiocfc->faa_args.busy = BFA_FALSE;\n}\n\n \nstatic void\nbfa_iocfc_enable_cbfn(void *bfa_arg, enum bfa_status status)\n{\n\tstruct bfa_s\t*bfa = bfa_arg;\n\n\tif (status == BFA_STATUS_OK)\n\t\tbfa_fsm_send_event(&bfa->iocfc, IOCFC_E_IOC_ENABLED);\n\telse\n\t\tbfa_fsm_send_event(&bfa->iocfc, IOCFC_E_IOC_FAILED);\n}\n\n \nstatic void\nbfa_iocfc_disable_cbfn(void *bfa_arg)\n{\n\tstruct bfa_s\t*bfa = bfa_arg;\n\n\tbfa->queue_process = BFA_FALSE;\n\tbfa_fsm_send_event(&bfa->iocfc, IOCFC_E_IOC_DISABLED);\n}\n\n \nstatic void\nbfa_iocfc_hbfail_cbfn(void *bfa_arg)\n{\n\tstruct bfa_s\t*bfa = bfa_arg;\n\n\tbfa->queue_process = BFA_FALSE;\n\tbfa_fsm_send_event(&bfa->iocfc, IOCFC_E_IOC_FAILED);\n}\n\n \nstatic void\nbfa_iocfc_reset_cbfn(void *bfa_arg)\n{\n\tstruct bfa_s\t*bfa = bfa_arg;\n\n\tbfa_iocfc_reset_queues(bfa);\n\tbfa_isr_enable(bfa);\n}\n\n \nvoid\nbfa_iocfc_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *meminfo,\n\t\t  struct bfa_s *bfa)\n{\n\tint q, per_reqq_sz, per_rspq_sz;\n\tstruct bfa_mem_dma_s *ioc_dma = BFA_MEM_IOC_DMA(bfa);\n\tstruct bfa_mem_dma_s *iocfc_dma = BFA_MEM_IOCFC_DMA(bfa);\n\tstruct bfa_mem_kva_s *iocfc_kva = BFA_MEM_IOCFC_KVA(bfa);\n\tu32\tdm_len = 0;\n\n\t \n\tbfa_mem_dma_setup(meminfo, ioc_dma,\n\t\tBFA_ROUNDUP(sizeof(struct bfi_ioc_attr_s), BFA_DMA_ALIGN_SZ));\n\n\t \n\tper_reqq_sz = BFA_ROUNDUP((cfg->drvcfg.num_reqq_elems * BFI_LMSG_SZ),\n\t\t\t\tBFA_DMA_ALIGN_SZ);\n\tper_rspq_sz = BFA_ROUNDUP((cfg->drvcfg.num_rspq_elems * BFI_LMSG_SZ),\n\t\t\t\tBFA_DMA_ALIGN_SZ);\n\n\tfor (q = 0; q < cfg->fwcfg.num_cqs; q++) {\n\t\tbfa_mem_dma_setup(meminfo, BFA_MEM_REQQ_DMA(bfa, q),\n\t\t\t\tper_reqq_sz);\n\t\tbfa_mem_dma_setup(meminfo, BFA_MEM_RSPQ_DMA(bfa, q),\n\t\t\t\tper_rspq_sz);\n\t}\n\n\t \n\tfor (q = 0; q < cfg->fwcfg.num_cqs; q++)\n\t\tdm_len += (2 * BFA_CACHELINE_SZ);\n\n\t \n\tdm_len += BFA_ROUNDUP(sizeof(struct bfi_iocfc_cfg_s), BFA_CACHELINE_SZ);\n\tdm_len += BFA_ROUNDUP(sizeof(struct bfi_iocfc_cfgrsp_s),\n\t\t\tBFA_CACHELINE_SZ);\n\n\t \n\tbfa_mem_dma_setup(meminfo, iocfc_dma, dm_len);\n\n\t \n\tbfa_mem_kva_setup(meminfo, iocfc_kva, BFA_DBG_FWTRC_LEN);\n}\n\n \nvoid\nbfa_iocfc_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\n\t\t struct bfa_pcidev_s *pcidev)\n{\n\tint\t\ti;\n\tstruct bfa_ioc_s *ioc = &bfa->ioc;\n\n\tbfa_iocfc_cbfn.enable_cbfn = bfa_iocfc_enable_cbfn;\n\tbfa_iocfc_cbfn.disable_cbfn = bfa_iocfc_disable_cbfn;\n\tbfa_iocfc_cbfn.hbfail_cbfn = bfa_iocfc_hbfail_cbfn;\n\tbfa_iocfc_cbfn.reset_cbfn = bfa_iocfc_reset_cbfn;\n\n\tioc->trcmod = bfa->trcmod;\n\tbfa_ioc_attach(&bfa->ioc, bfa, &bfa_iocfc_cbfn, &bfa->timer_mod);\n\n\tbfa_ioc_pci_init(&bfa->ioc, pcidev, BFI_PCIFN_CLASS_FC);\n\tbfa_ioc_mbox_register(&bfa->ioc, bfa_mbox_isrs);\n\n\tbfa_iocfc_init_mem(bfa, bfad, cfg, pcidev);\n\tbfa_iocfc_mem_claim(bfa, cfg);\n\tINIT_LIST_HEAD(&bfa->timer_mod.timer_q);\n\n\tINIT_LIST_HEAD(&bfa->comp_q);\n\tfor (i = 0; i < BFI_IOC_MAX_CQS; i++)\n\t\tINIT_LIST_HEAD(&bfa->reqq_waitq[i]);\n\n\tbfa->iocfc.cb_reqd = BFA_FALSE;\n\tbfa->iocfc.op_status = BFA_STATUS_OK;\n\tbfa->iocfc.submod_enabled = BFA_FALSE;\n\n\tbfa_fsm_set_state(&bfa->iocfc, bfa_iocfc_sm_stopped);\n}\n\n \nvoid\nbfa_iocfc_init(struct bfa_s *bfa)\n{\n\tbfa_fsm_send_event(&bfa->iocfc, IOCFC_E_INIT);\n}\n\n \nvoid\nbfa_iocfc_start(struct bfa_s *bfa)\n{\n\tbfa_fsm_send_event(&bfa->iocfc, IOCFC_E_START);\n}\n\n \nvoid\nbfa_iocfc_stop(struct bfa_s *bfa)\n{\n\tbfa_fsm_send_event(&bfa->iocfc, IOCFC_E_STOP);\n}\n\nvoid\nbfa_iocfc_isr(void *bfaarg, struct bfi_mbmsg_s *m)\n{\n\tstruct bfa_s\t\t*bfa = bfaarg;\n\tstruct bfa_iocfc_s\t*iocfc = &bfa->iocfc;\n\tunion bfi_iocfc_i2h_msg_u\t*msg;\n\n\tmsg = (union bfi_iocfc_i2h_msg_u *) m;\n\tbfa_trc(bfa, msg->mh.msg_id);\n\n\tswitch (msg->mh.msg_id) {\n\tcase BFI_IOCFC_I2H_CFG_REPLY:\n\t\tbfa_iocfc_cfgrsp(bfa);\n\t\tbreak;\n\tcase BFI_IOCFC_I2H_UPDATEQ_RSP:\n\t\tiocfc->updateq_cbfn(iocfc->updateq_cbarg, BFA_STATUS_OK);\n\t\tbreak;\n\tcase BFI_IOCFC_I2H_ADDR_MSG:\n\t\tbfa_iocfc_process_faa_addr(bfa,\n\t\t\t\t(struct bfi_faa_addr_msg_s *)msg);\n\t\tbreak;\n\tcase BFI_IOCFC_I2H_FAA_QUERY_RSP:\n\t\tbfa_faa_query_reply(iocfc, (bfi_faa_query_rsp_t *)msg);\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON(1);\n\t}\n}\n\nvoid\nbfa_iocfc_get_attr(struct bfa_s *bfa, struct bfa_iocfc_attr_s *attr)\n{\n\tstruct bfa_iocfc_s\t*iocfc = &bfa->iocfc;\n\n\tattr->intr_attr.coalesce = iocfc->cfginfo->intr_attr.coalesce;\n\n\tattr->intr_attr.delay = iocfc->cfginfo->intr_attr.delay ?\n\t\t\t\tbe16_to_cpu(iocfc->cfginfo->intr_attr.delay) :\n\t\t\t\tbe16_to_cpu(iocfc->cfgrsp->intr_attr.delay);\n\n\tattr->intr_attr.latency = iocfc->cfginfo->intr_attr.latency ?\n\t\t\tbe16_to_cpu(iocfc->cfginfo->intr_attr.latency) :\n\t\t\tbe16_to_cpu(iocfc->cfgrsp->intr_attr.latency);\n\n\tattr->config\t= iocfc->cfg;\n}\n\nbfa_status_t\nbfa_iocfc_israttr_set(struct bfa_s *bfa, struct bfa_iocfc_intr_attr_s *attr)\n{\n\tstruct bfa_iocfc_s\t\t*iocfc = &bfa->iocfc;\n\tstruct bfi_iocfc_set_intr_req_s *m;\n\n\tiocfc->cfginfo->intr_attr.coalesce = attr->coalesce;\n\tiocfc->cfginfo->intr_attr.delay = cpu_to_be16(attr->delay);\n\tiocfc->cfginfo->intr_attr.latency = cpu_to_be16(attr->latency);\n\n\tif (!bfa_iocfc_is_operational(bfa))\n\t\treturn BFA_STATUS_OK;\n\n\tm = bfa_reqq_next(bfa, BFA_REQQ_IOC);\n\tif (!m)\n\t\treturn BFA_STATUS_DEVBUSY;\n\n\tbfi_h2i_set(m->mh, BFI_MC_IOCFC, BFI_IOCFC_H2I_SET_INTR_REQ,\n\t\t    bfa_fn_lpu(bfa));\n\tm->coalesce = iocfc->cfginfo->intr_attr.coalesce;\n\tm->delay    = iocfc->cfginfo->intr_attr.delay;\n\tm->latency  = iocfc->cfginfo->intr_attr.latency;\n\n\tbfa_trc(bfa, attr->delay);\n\tbfa_trc(bfa, attr->latency);\n\n\tbfa_reqq_produce(bfa, BFA_REQQ_IOC, m->mh);\n\treturn BFA_STATUS_OK;\n}\n\nvoid\nbfa_iocfc_set_snsbase(struct bfa_s *bfa, int seg_no, u64 snsbase_pa)\n{\n\tstruct bfa_iocfc_s\t*iocfc = &bfa->iocfc;\n\n\tiocfc->cfginfo->sense_buf_len = (BFI_IOIM_SNSLEN - 1);\n\tbfa_dma_be_addr_set(iocfc->cfginfo->ioim_snsbase[seg_no], snsbase_pa);\n}\n \nvoid\nbfa_iocfc_enable(struct bfa_s *bfa)\n{\n\tbfa_plog_str(bfa->plog, BFA_PL_MID_HAL, BFA_PL_EID_MISC, 0,\n\t\t     \"IOC Enable\");\n\tbfa->iocfc.cb_reqd = BFA_TRUE;\n\tbfa_fsm_send_event(&bfa->iocfc, IOCFC_E_ENABLE);\n}\n\nvoid\nbfa_iocfc_disable(struct bfa_s *bfa)\n{\n\tbfa_plog_str(bfa->plog, BFA_PL_MID_HAL, BFA_PL_EID_MISC, 0,\n\t\t     \"IOC Disable\");\n\n\tbfa_fsm_send_event(&bfa->iocfc, IOCFC_E_DISABLE);\n}\n\nbfa_boolean_t\nbfa_iocfc_is_operational(struct bfa_s *bfa)\n{\n\treturn bfa_ioc_is_operational(&bfa->ioc) &&\n\t\tbfa_fsm_cmp_state(&bfa->iocfc, bfa_iocfc_sm_operational);\n}\n\n \nvoid\nbfa_iocfc_get_bootwwns(struct bfa_s *bfa, u8 *nwwns, wwn_t *wwns)\n{\n\tstruct bfa_iocfc_s *iocfc = &bfa->iocfc;\n\tstruct bfi_iocfc_cfgrsp_s *cfgrsp = iocfc->cfgrsp;\n\tint i;\n\n\tif (cfgrsp->pbc_cfg.boot_enabled && cfgrsp->pbc_cfg.nbluns) {\n\t\tbfa_trc(bfa, cfgrsp->pbc_cfg.nbluns);\n\t\t*nwwns = cfgrsp->pbc_cfg.nbluns;\n\t\tfor (i = 0; i < cfgrsp->pbc_cfg.nbluns; i++)\n\t\t\twwns[i] = cfgrsp->pbc_cfg.blun[i].tgt_pwwn;\n\n\t\treturn;\n\t}\n\n\t*nwwns = cfgrsp->bootwwns.nwwns;\n\tmemcpy(wwns, cfgrsp->bootwwns.wwn, sizeof(cfgrsp->bootwwns.wwn));\n}\n\nint\nbfa_iocfc_get_pbc_vports(struct bfa_s *bfa, struct bfi_pbc_vport_s *pbc_vport)\n{\n\tstruct bfa_iocfc_s *iocfc = &bfa->iocfc;\n\tstruct bfi_iocfc_cfgrsp_s *cfgrsp = iocfc->cfgrsp;\n\n\tmemcpy(pbc_vport, cfgrsp->pbc_cfg.vport, sizeof(cfgrsp->pbc_cfg.vport));\n\treturn cfgrsp->pbc_cfg.nvports;\n}\n\n\n \nvoid\nbfa_cfg_get_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *meminfo,\n\t\tstruct bfa_s *bfa)\n{\n\tstruct bfa_mem_dma_s *port_dma = BFA_MEM_PORT_DMA(bfa);\n\tstruct bfa_mem_dma_s *ablk_dma = BFA_MEM_ABLK_DMA(bfa);\n\tstruct bfa_mem_dma_s *cee_dma = BFA_MEM_CEE_DMA(bfa);\n\tstruct bfa_mem_dma_s *sfp_dma = BFA_MEM_SFP_DMA(bfa);\n\tstruct bfa_mem_dma_s *flash_dma = BFA_MEM_FLASH_DMA(bfa);\n\tstruct bfa_mem_dma_s *diag_dma = BFA_MEM_DIAG_DMA(bfa);\n\tstruct bfa_mem_dma_s *phy_dma = BFA_MEM_PHY_DMA(bfa);\n\tstruct bfa_mem_dma_s *fru_dma = BFA_MEM_FRU_DMA(bfa);\n\n\tWARN_ON((cfg == NULL) || (meminfo == NULL));\n\n\tmemset((void *)meminfo, 0, sizeof(struct bfa_meminfo_s));\n\n\t \n\tINIT_LIST_HEAD(&meminfo->dma_info.qe);\n\tINIT_LIST_HEAD(&meminfo->kva_info.qe);\n\n\tbfa_iocfc_meminfo(cfg, meminfo, bfa);\n\tbfa_sgpg_meminfo(cfg, meminfo, bfa);\n\tbfa_fcport_meminfo(cfg, meminfo, bfa);\n\tbfa_fcxp_meminfo(cfg, meminfo, bfa);\n\tbfa_lps_meminfo(cfg, meminfo, bfa);\n\tbfa_uf_meminfo(cfg, meminfo, bfa);\n\tbfa_rport_meminfo(cfg, meminfo, bfa);\n\tbfa_fcp_meminfo(cfg, meminfo, bfa);\n\tbfa_dconf_meminfo(cfg, meminfo, bfa);\n\n\t \n\tbfa_mem_dma_setup(meminfo, port_dma, bfa_port_meminfo());\n\tbfa_mem_dma_setup(meminfo, ablk_dma, bfa_ablk_meminfo());\n\tbfa_mem_dma_setup(meminfo, cee_dma, bfa_cee_meminfo());\n\tbfa_mem_dma_setup(meminfo, sfp_dma, bfa_sfp_meminfo());\n\tbfa_mem_dma_setup(meminfo, flash_dma,\n\t\t\t  bfa_flash_meminfo(cfg->drvcfg.min_cfg));\n\tbfa_mem_dma_setup(meminfo, diag_dma, bfa_diag_meminfo());\n\tbfa_mem_dma_setup(meminfo, phy_dma,\n\t\t\t  bfa_phy_meminfo(cfg->drvcfg.min_cfg));\n\tbfa_mem_dma_setup(meminfo, fru_dma,\n\t\t\t  bfa_fru_meminfo(cfg->drvcfg.min_cfg));\n}\n\n \nvoid\nbfa_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\n\t       struct bfa_meminfo_s *meminfo, struct bfa_pcidev_s *pcidev)\n{\n\tstruct bfa_mem_dma_s *dma_info, *dma_elem;\n\tstruct bfa_mem_kva_s *kva_info, *kva_elem;\n\tstruct list_head *dm_qe, *km_qe;\n\n\tbfa->fcs = BFA_FALSE;\n\n\tWARN_ON((cfg == NULL) || (meminfo == NULL));\n\n\t \n\tdma_info = &meminfo->dma_info;\n\tdma_info->kva_curp = dma_info->kva;\n\tdma_info->dma_curp = dma_info->dma;\n\n\tkva_info = &meminfo->kva_info;\n\tkva_info->kva_curp = kva_info->kva;\n\n\tlist_for_each(dm_qe, &dma_info->qe) {\n\t\tdma_elem = (struct bfa_mem_dma_s *) dm_qe;\n\t\tdma_elem->kva_curp = dma_elem->kva;\n\t\tdma_elem->dma_curp = dma_elem->dma;\n\t}\n\n\tlist_for_each(km_qe, &kva_info->qe) {\n\t\tkva_elem = (struct bfa_mem_kva_s *) km_qe;\n\t\tkva_elem->kva_curp = kva_elem->kva;\n\t}\n\n\tbfa_iocfc_attach(bfa, bfad, cfg, pcidev);\n\tbfa_fcdiag_attach(bfa, bfad, cfg, pcidev);\n\tbfa_sgpg_attach(bfa, bfad, cfg, pcidev);\n\tbfa_fcport_attach(bfa, bfad, cfg, pcidev);\n\tbfa_fcxp_attach(bfa, bfad, cfg, pcidev);\n\tbfa_lps_attach(bfa, bfad, cfg, pcidev);\n\tbfa_uf_attach(bfa, bfad, cfg, pcidev);\n\tbfa_rport_attach(bfa, bfad, cfg, pcidev);\n\tbfa_fcp_attach(bfa, bfad, cfg, pcidev);\n\tbfa_dconf_attach(bfa, bfad, cfg);\n\tbfa_com_port_attach(bfa);\n\tbfa_com_ablk_attach(bfa);\n\tbfa_com_cee_attach(bfa);\n\tbfa_com_sfp_attach(bfa);\n\tbfa_com_flash_attach(bfa, cfg->drvcfg.min_cfg);\n\tbfa_com_diag_attach(bfa);\n\tbfa_com_phy_attach(bfa, cfg->drvcfg.min_cfg);\n\tbfa_com_fru_attach(bfa, cfg->drvcfg.min_cfg);\n}\n\n \nvoid\nbfa_detach(struct bfa_s *bfa)\n{\n\tbfa_ioc_detach(&bfa->ioc);\n}\n\nvoid\nbfa_comp_deq(struct bfa_s *bfa, struct list_head *comp_q)\n{\n\tINIT_LIST_HEAD(comp_q);\n\tlist_splice_tail_init(&bfa->comp_q, comp_q);\n}\n\nvoid\nbfa_comp_process(struct bfa_s *bfa, struct list_head *comp_q)\n{\n\tstruct list_head\t\t*qe;\n\tstruct list_head\t\t*qen;\n\tstruct bfa_cb_qe_s\t*hcb_qe;\n\tbfa_cb_cbfn_status_t\tcbfn;\n\n\tlist_for_each_safe(qe, qen, comp_q) {\n\t\thcb_qe = (struct bfa_cb_qe_s *) qe;\n\t\tif (hcb_qe->pre_rmv) {\n\t\t\t \n\t\t\tlist_del(qe);\n\t\t\tcbfn = (bfa_cb_cbfn_status_t)(hcb_qe->cbfn);\n\t\t\tcbfn(hcb_qe->cbarg, hcb_qe->fw_status);\n\t\t} else\n\t\t\thcb_qe->cbfn(hcb_qe->cbarg, BFA_TRUE);\n\t}\n}\n\nvoid\nbfa_comp_free(struct bfa_s *bfa, struct list_head *comp_q)\n{\n\tstruct list_head\t\t*qe;\n\tstruct bfa_cb_qe_s\t*hcb_qe;\n\n\twhile (!list_empty(comp_q)) {\n\t\tbfa_q_deq(comp_q, &qe);\n\t\thcb_qe = (struct bfa_cb_qe_s *) qe;\n\t\tWARN_ON(hcb_qe->pre_rmv);\n\t\thcb_qe->cbfn(hcb_qe->cbarg, BFA_FALSE);\n\t}\n}\n\n \nvoid\nbfa_get_pciids(struct bfa_pciid_s **pciids, int *npciids)\n{\n\tstatic struct bfa_pciid_s __pciids[] = {\n\t\t{BFA_PCI_VENDOR_ID_BROCADE, BFA_PCI_DEVICE_ID_FC_8G2P},\n\t\t{BFA_PCI_VENDOR_ID_BROCADE, BFA_PCI_DEVICE_ID_FC_8G1P},\n\t\t{BFA_PCI_VENDOR_ID_BROCADE, BFA_PCI_DEVICE_ID_CT},\n\t\t{BFA_PCI_VENDOR_ID_BROCADE, BFA_PCI_DEVICE_ID_CT_FC},\n\t};\n\n\t*npciids = ARRAY_SIZE(__pciids);\n\t*pciids = __pciids;\n}\n\n \nvoid\nbfa_cfg_get_default(struct bfa_iocfc_cfg_s *cfg)\n{\n\tcfg->fwcfg.num_fabrics = DEF_CFG_NUM_FABRICS;\n\tcfg->fwcfg.num_lports = DEF_CFG_NUM_LPORTS;\n\tcfg->fwcfg.num_rports = DEF_CFG_NUM_RPORTS;\n\tcfg->fwcfg.num_ioim_reqs = DEF_CFG_NUM_IOIM_REQS;\n\tcfg->fwcfg.num_tskim_reqs = DEF_CFG_NUM_TSKIM_REQS;\n\tcfg->fwcfg.num_fcxp_reqs = DEF_CFG_NUM_FCXP_REQS;\n\tcfg->fwcfg.num_uf_bufs = DEF_CFG_NUM_UF_BUFS;\n\tcfg->fwcfg.num_cqs = DEF_CFG_NUM_CQS;\n\tcfg->fwcfg.num_fwtio_reqs = 0;\n\n\tcfg->drvcfg.num_reqq_elems = DEF_CFG_NUM_REQQ_ELEMS;\n\tcfg->drvcfg.num_rspq_elems = DEF_CFG_NUM_RSPQ_ELEMS;\n\tcfg->drvcfg.num_sgpgs = DEF_CFG_NUM_SGPGS;\n\tcfg->drvcfg.num_sboot_tgts = DEF_CFG_NUM_SBOOT_TGTS;\n\tcfg->drvcfg.num_sboot_luns = DEF_CFG_NUM_SBOOT_LUNS;\n\tcfg->drvcfg.path_tov = BFA_FCPIM_PATHTOV_DEF;\n\tcfg->drvcfg.ioc_recover = BFA_FALSE;\n\tcfg->drvcfg.delay_comp = BFA_FALSE;\n\n}\n\nvoid\nbfa_cfg_get_min(struct bfa_iocfc_cfg_s *cfg)\n{\n\tbfa_cfg_get_default(cfg);\n\tcfg->fwcfg.num_ioim_reqs   = BFA_IOIM_MIN;\n\tcfg->fwcfg.num_tskim_reqs  = BFA_TSKIM_MIN;\n\tcfg->fwcfg.num_fcxp_reqs   = BFA_FCXP_MIN;\n\tcfg->fwcfg.num_uf_bufs     = BFA_UF_MIN;\n\tcfg->fwcfg.num_rports      = BFA_RPORT_MIN;\n\tcfg->fwcfg.num_fwtio_reqs = 0;\n\n\tcfg->drvcfg.num_sgpgs      = BFA_SGPG_MIN;\n\tcfg->drvcfg.num_reqq_elems = BFA_REQQ_NELEMS_MIN;\n\tcfg->drvcfg.num_rspq_elems = BFA_RSPQ_NELEMS_MIN;\n\tcfg->drvcfg.min_cfg\t   = BFA_TRUE;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}