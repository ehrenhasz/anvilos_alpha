{
  "module_name": "fc_npiv.c",
  "hash_id": "02bc3e7ed7a4ef136389c2535b696bb680173d547f186c17b255c314a9380206",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/libfc/fc_npiv.c",
  "human_readable_source": "\n \n\n \n\n#include <scsi/libfc.h>\n#include <linux/export.h>\n\n \n\nstruct fc_lport *libfc_vport_create(struct fc_vport *vport, int privsize)\n{\n\tstruct Scsi_Host *shost = vport_to_shost(vport);\n\tstruct fc_lport *n_port = shost_priv(shost);\n\tstruct fc_lport *vn_port;\n\n\tvn_port = libfc_host_alloc(shost->hostt, privsize);\n\tif (!vn_port)\n\t\treturn vn_port;\n\n\tvn_port->vport = vport;\n\tvport->dd_data = vn_port;\n\n\tmutex_lock(&n_port->lp_mutex);\n\tlist_add_tail(&vn_port->list, &n_port->vports);\n\tmutex_unlock(&n_port->lp_mutex);\n\n\treturn vn_port;\n}\nEXPORT_SYMBOL(libfc_vport_create);\n\n \nstruct fc_lport *fc_vport_id_lookup(struct fc_lport *n_port, u32 port_id)\n{\n\tstruct fc_lport *lport = NULL;\n\tstruct fc_lport *vn_port;\n\n\tif (n_port->port_id == port_id)\n\t\treturn n_port;\n\n\tif (port_id == FC_FID_FLOGI)\n\t\treturn n_port;\t\t \n\n\tmutex_lock(&n_port->lp_mutex);\n\tlist_for_each_entry(vn_port, &n_port->vports, list) {\n\t\tif (vn_port->port_id == port_id) {\n\t\t\tlport = vn_port;\n\t\t\tbreak;\n\t\t}\n\t}\n\tmutex_unlock(&n_port->lp_mutex);\n\n\treturn lport;\n}\nEXPORT_SYMBOL(fc_vport_id_lookup);\n\n \nenum libfc_lport_mutex_class {\n\tLPORT_MUTEX_NORMAL = 0,\n\tLPORT_MUTEX_VN_PORT = 1,\n};\n\n \nstatic void __fc_vport_setlink(struct fc_lport *n_port,\n\t\t\t       struct fc_lport *vn_port)\n{\n\tstruct fc_vport *vport = vn_port->vport;\n\n\tif (vn_port->state == LPORT_ST_DISABLED)\n\t\treturn;\n\n\tif (n_port->state == LPORT_ST_READY) {\n\t\tif (n_port->npiv_enabled) {\n\t\t\tfc_vport_set_state(vport, FC_VPORT_INITIALIZING);\n\t\t\t__fc_linkup(vn_port);\n\t\t} else {\n\t\t\tfc_vport_set_state(vport, FC_VPORT_NO_FABRIC_SUPP);\n\t\t\t__fc_linkdown(vn_port);\n\t\t}\n\t} else {\n\t\tfc_vport_set_state(vport, FC_VPORT_LINKDOWN);\n\t\t__fc_linkdown(vn_port);\n\t}\n}\n\n \nvoid fc_vport_setlink(struct fc_lport *vn_port)\n{\n\tstruct fc_vport *vport = vn_port->vport;\n\tstruct Scsi_Host *shost = vport_to_shost(vport);\n\tstruct fc_lport *n_port = shost_priv(shost);\n\n\tmutex_lock(&n_port->lp_mutex);\n\tmutex_lock_nested(&vn_port->lp_mutex, LPORT_MUTEX_VN_PORT);\n\t__fc_vport_setlink(n_port, vn_port);\n\tmutex_unlock(&vn_port->lp_mutex);\n\tmutex_unlock(&n_port->lp_mutex);\n}\nEXPORT_SYMBOL(fc_vport_setlink);\n\n \nvoid fc_vports_linkchange(struct fc_lport *n_port)\n{\n\tstruct fc_lport *vn_port;\n\n\tlist_for_each_entry(vn_port, &n_port->vports, list) {\n\t\tmutex_lock_nested(&vn_port->lp_mutex, LPORT_MUTEX_VN_PORT);\n\t\t__fc_vport_setlink(n_port, vn_port);\n\t\tmutex_unlock(&vn_port->lp_mutex);\n\t}\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}