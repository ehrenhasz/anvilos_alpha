{
  "module_name": "3w-xxxx.c",
  "hash_id": "1afaabd605a0ed5dfca170a89a9493ce659123f6465b588fc41b469b3471a352",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/3w-xxxx.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/reboot.h>\n#include <linux/spinlock.h>\n#include <linux/interrupt.h>\n#include <linux/moduleparam.h>\n#include <linux/errno.h>\n#include <linux/types.h>\n#include <linux/delay.h>\n#include <linux/gfp.h>\n#include <linux/pci.h>\n#include <linux/time.h>\n#include <linux/mutex.h>\n#include <asm/io.h>\n#include <asm/irq.h>\n#include <linux/uaccess.h>\n#include <scsi/scsi.h>\n#include <scsi/scsi_host.h>\n#include <scsi/scsi_tcq.h>\n#include <scsi/scsi_cmnd.h>\n#include <scsi/scsi_eh.h>\n#include \"3w-xxxx.h\"\n\n \n#define TW_DRIVER_VERSION \"1.26.02.003\"\nstatic DEFINE_MUTEX(tw_mutex);\nstatic TW_Device_Extension *tw_device_extension_list[TW_MAX_SLOT];\nstatic int tw_device_extension_count = 0;\nstatic int twe_major = -1;\n\n \nMODULE_AUTHOR(\"LSI\");\nMODULE_DESCRIPTION(\"3ware Storage Controller Linux Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_VERSION(TW_DRIVER_VERSION);\n\n \nstatic int tw_reset_device_extension(TW_Device_Extension *tw_dev);\n\n \n\n \nstatic int tw_check_bits(u32 status_reg_value)\n{\n\tif ((status_reg_value & TW_STATUS_EXPECTED_BITS) != TW_STATUS_EXPECTED_BITS) {\n\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_check_bits(): No expected bits (0x%x).\\n\", status_reg_value);\n\t\treturn 1;\n\t}\n\tif ((status_reg_value & TW_STATUS_UNEXPECTED_BITS) != 0) {\n\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_check_bits(): Found unexpected bits (0x%x).\\n\", status_reg_value);\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}  \n\n \nstatic int tw_decode_bits(TW_Device_Extension *tw_dev, u32 status_reg_value, int print_host)\n{\n\tchar host[16];\n\n\tdprintk(KERN_WARNING \"3w-xxxx: tw_decode_bits()\\n\");\n\n\tif (print_host)\n\t\tsprintf(host, \" scsi%d:\", tw_dev->host->host_no);\n\telse\n\t\thost[0] = '\\0';\n\n\tif (status_reg_value & TW_STATUS_PCI_PARITY_ERROR) {\n\t\tprintk(KERN_WARNING \"3w-xxxx:%s PCI Parity Error: clearing.\\n\", host);\n\t\toutl(TW_CONTROL_CLEAR_PARITY_ERROR, TW_CONTROL_REG_ADDR(tw_dev));\n\t}\n\n\tif (status_reg_value & TW_STATUS_PCI_ABORT) {\n\t\tprintk(KERN_WARNING \"3w-xxxx:%s PCI Abort: clearing.\\n\", host);\n\t\toutl(TW_CONTROL_CLEAR_PCI_ABORT, TW_CONTROL_REG_ADDR(tw_dev));\n\t\tpci_write_config_word(tw_dev->tw_pci_dev, PCI_STATUS, TW_PCI_CLEAR_PCI_ABORT);\n\t}\n\n\tif (status_reg_value & TW_STATUS_QUEUE_ERROR) {\n\t\tprintk(KERN_WARNING \"3w-xxxx:%s Controller Queue Error: clearing.\\n\", host);\n\t\toutl(TW_CONTROL_CLEAR_QUEUE_ERROR, TW_CONTROL_REG_ADDR(tw_dev));\n\t}\n\n\tif (status_reg_value & TW_STATUS_SBUF_WRITE_ERROR) {\n\t\tprintk(KERN_WARNING \"3w-xxxx:%s SBUF Write Error: clearing.\\n\", host);\n\t\toutl(TW_CONTROL_CLEAR_SBUF_WRITE_ERROR, TW_CONTROL_REG_ADDR(tw_dev));\n\t}\n\n\tif (status_reg_value & TW_STATUS_MICROCONTROLLER_ERROR) {\n\t\tif (tw_dev->reset_print == 0) {\n\t\t\tprintk(KERN_WARNING \"3w-xxxx:%s Microcontroller Error: clearing.\\n\", host);\n\t\t\ttw_dev->reset_print = 1;\n\t\t}\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}  \n\n \nstatic int tw_poll_status(TW_Device_Extension *tw_dev, u32 flag, int seconds)\n{\n\tu32 status_reg_value;\n\tunsigned long before;\n\tint retval = 1;\n\n\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\tbefore = jiffies;\n\n\tif (tw_check_bits(status_reg_value))\n\t\ttw_decode_bits(tw_dev, status_reg_value, 0);\n\n\twhile ((status_reg_value & flag) != flag) {\n\t\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\n\t\tif (tw_check_bits(status_reg_value))\n\t\t\ttw_decode_bits(tw_dev, status_reg_value, 0);\n\n\t\tif (time_after(jiffies, before + HZ * seconds))\n\t\t\tgoto out;\n\n\t\tmsleep(50);\n\t}\n\tretval = 0;\nout:\n\treturn retval;\n}  \n\n \nstatic int tw_poll_status_gone(TW_Device_Extension *tw_dev, u32 flag, int seconds)\n{\n\tu32 status_reg_value;\n\tunsigned long before;\n\tint retval = 1;\n\n\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\tbefore = jiffies;\n\n\tif (tw_check_bits(status_reg_value))\n\t\ttw_decode_bits(tw_dev, status_reg_value, 0);\n\n\twhile ((status_reg_value & flag) != 0) {\n\t\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\n\t\tif (tw_check_bits(status_reg_value))\n\t\t\ttw_decode_bits(tw_dev, status_reg_value, 0);\n\n\t\tif (time_after(jiffies, before + HZ * seconds))\n\t\t\tgoto out;\n\n\t\tmsleep(50);\n\t}\n\tretval = 0;\nout:\n\treturn retval;\n}  \n\n \nstatic int tw_post_command_packet(TW_Device_Extension *tw_dev, int request_id)\n{\n\tu32 status_reg_value;\n\tunsigned long command_que_value;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_post_command_packet()\\n\");\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\n\tif (tw_check_bits(status_reg_value)) {\n\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_post_command_packet(): Unexpected bits.\\n\");\n\t\ttw_decode_bits(tw_dev, status_reg_value, 1);\n\t}\n\n\tif ((status_reg_value & TW_STATUS_COMMAND_QUEUE_FULL) == 0) {\n\t\t \n\t\toutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\n\t\ttw_dev->state[request_id] = TW_S_POSTED;\n\t\ttw_dev->posted_request_count++;\n\t\tif (tw_dev->posted_request_count > tw_dev->max_posted_request_count) {\n\t\t\ttw_dev->max_posted_request_count = tw_dev->posted_request_count;\n\t\t}\n\t} else {\n\t\t \n\t\tif (tw_dev->state[request_id] != TW_S_PENDING) {\n\t\t\ttw_dev->state[request_id] = TW_S_PENDING;\n\t\t\ttw_dev->pending_request_count++;\n\t\t\tif (tw_dev->pending_request_count > tw_dev->max_pending_request_count) {\n\t\t\t\ttw_dev->max_pending_request_count = tw_dev->pending_request_count;\n\t\t\t}\n\t\t\ttw_dev->pending_queue[tw_dev->pending_tail] = request_id;\n\t\t\tif (tw_dev->pending_tail == TW_Q_LENGTH-1) {\n\t\t\t\ttw_dev->pending_tail = TW_Q_START;\n\t\t\t} else {\n\t\t\t\ttw_dev->pending_tail = tw_dev->pending_tail + 1;\n\t\t\t}\n\t\t}\n\t\tTW_UNMASK_COMMAND_INTERRUPT(tw_dev);\n\t\treturn 1;\n\t}\n\treturn 0;\n}  \n\n \nstatic int tw_decode_sense(TW_Device_Extension *tw_dev, int request_id, int fill_sense)\n{\n\tint i;\n\tTW_Command *command;\n\n\tdprintk(KERN_WARNING \"3w-xxxx: tw_decode_sense()\\n\");\n\tcommand = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\n\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Command failed: status = 0x%x, flags = 0x%x, unit #%d.\\n\", tw_dev->host->host_no, command->status, command->flags, TW_UNIT_OUT(command->unit__hostid));\n\n\t \n\tif (fill_sense) {\n\t\tif ((command->status == 0xc7) || (command->status == 0xcb)) {\n\t\t\tfor (i = 0; i < ARRAY_SIZE(tw_sense_table); i++) {\n\t\t\t\tif (command->flags == tw_sense_table[i][0]) {\n\n\t\t\t\t\t \n\t\t\t\t\ttw_dev->srb[request_id]->sense_buffer[0] = (0x1 << 7 | 0x70);\n\n\t\t\t\t\t \n\t\t\t\t\ttw_dev->srb[request_id]->sense_buffer[2] = tw_sense_table[i][1];\n\n\t\t\t\t\t \n\t\t\t\t\ttw_dev->srb[request_id]->sense_buffer[7] = 0xa;  \n\n\t\t\t\t\t \n\t\t\t\t\ttw_dev->srb[request_id]->sense_buffer[12] = tw_sense_table[i][2];\n\n\t\t\t\t\t \n\t\t\t\t\ttw_dev->srb[request_id]->sense_buffer[13] = tw_sense_table[i][3];\n\n\t\t\t\t\ttw_dev->srb[request_id]->result = (DID_OK << 16) | SAM_STAT_CHECK_CONDITION;\n\t\t\t\t\treturn TW_ISR_DONT_RESULT;  \n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t \n\t\treturn 1;\n\t}\n\n\treturn 0;\n}  \n\n \nstatic int tw_check_errors(TW_Device_Extension *tw_dev)\n{\n\tu32 status_reg_value;\n\n\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\n\tif (TW_STATUS_ERRORS(status_reg_value) || tw_check_bits(status_reg_value)) {\n\t\ttw_decode_bits(tw_dev, status_reg_value, 0);\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}  \n\n \nstatic void tw_empty_response_que(TW_Device_Extension *tw_dev)\n{\n\tu32 status_reg_value;\n\n\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\n\twhile ((status_reg_value & TW_STATUS_RESPONSE_QUEUE_EMPTY) == 0) {\n\t\tinl(TW_RESPONSE_QUEUE_REG_ADDR(tw_dev));\n\t\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\t}\n}  \n\n \nstatic void tw_state_request_finish(TW_Device_Extension *tw_dev, int request_id)\n{\n\ttw_dev->free_queue[tw_dev->free_tail] = request_id;\n\ttw_dev->state[request_id] = TW_S_FINISHED;\n\ttw_dev->free_tail = (tw_dev->free_tail + 1) % TW_Q_LENGTH;\n}  \n\n \nstatic void tw_state_request_start(TW_Device_Extension *tw_dev, int *request_id)\n{\n\t*request_id = tw_dev->free_queue[tw_dev->free_head];\n\ttw_dev->free_head = (tw_dev->free_head + 1) % TW_Q_LENGTH;\n\ttw_dev->state[*request_id] = TW_S_STARTED;\n}  \n\n \nstatic ssize_t tw_show_stats(struct device *dev, struct device_attribute *attr,\n\t\t\t     char *buf)\n{\n\tstruct Scsi_Host *host = class_to_shost(dev);\n\tTW_Device_Extension *tw_dev = (TW_Device_Extension *)host->hostdata;\n\tunsigned long flags = 0;\n\tssize_t len;\n\n\tspin_lock_irqsave(tw_dev->host->host_lock, flags);\n\tlen = snprintf(buf, PAGE_SIZE, \"3w-xxxx Driver version: %s\\n\"\n\t\t       \"Current commands posted:   %4d\\n\"\n\t\t       \"Max commands posted:       %4d\\n\"\n\t\t       \"Current pending commands:  %4d\\n\"\n\t\t       \"Max pending commands:      %4d\\n\"\n\t\t       \"Last sgl length:           %4d\\n\"\n\t\t       \"Max sgl length:            %4d\\n\"\n\t\t       \"Last sector count:         %4d\\n\"\n\t\t       \"Max sector count:          %4d\\n\"\n\t\t       \"SCSI Host Resets:          %4d\\n\"\n\t\t       \"AEN's:                     %4d\\n\", \n\t\t       TW_DRIVER_VERSION,\n\t\t       tw_dev->posted_request_count,\n\t\t       tw_dev->max_posted_request_count,\n\t\t       tw_dev->pending_request_count,\n\t\t       tw_dev->max_pending_request_count,\n\t\t       tw_dev->sgl_entries,\n\t\t       tw_dev->max_sgl_entries,\n\t\t       tw_dev->sector_count,\n\t\t       tw_dev->max_sector_count,\n\t\t       tw_dev->num_resets,\n\t\t       tw_dev->aen_count);\n\tspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\n\treturn len;\n}  \n\n \nstatic struct device_attribute tw_host_stats_attr = {\n\t.attr = {\n\t\t.name =\t\t\"stats\",\n\t\t.mode =\t\tS_IRUGO,\n\t},\n\t.show = tw_show_stats\n};\n\n \nstatic struct attribute *tw_host_attrs[] = {\n\t&tw_host_stats_attr.attr,\n\tNULL,\n};\n\nATTRIBUTE_GROUPS(tw_host);\n\n \nstatic int tw_aen_read_queue(TW_Device_Extension *tw_dev, int request_id)\n{\n\tTW_Command *command_packet;\n\tTW_Param *param;\n\tunsigned long command_que_value;\n\tu32 status_reg_value;\n\tunsigned long param_value = 0;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_aen_read_queue()\\n\");\n\n\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\tif (tw_check_bits(status_reg_value)) {\n\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_aen_read_queue(): Unexpected bits.\\n\");\n\t\ttw_decode_bits(tw_dev, status_reg_value, 1);\n\t\treturn 1;\n\t}\n\tif (tw_dev->command_packet_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_read_queue(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\tmemset(command_packet, 0, sizeof(TW_Sector));\n\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\n\tcommand_packet->size = 4;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->status = 0;\n\tcommand_packet->flags = 0;\n\tcommand_packet->byte6.parameter_count = 1;\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tif (command_que_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_read_queue(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\t \n\tif (tw_dev->alignment_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_read_queue(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tmemset(param, 0, sizeof(TW_Sector));\n\tparam->table_id = 0x401;  \n\tparam->parameter_id = 2;  \n\tparam->parameter_size_bytes = 2;\n\tparam_value = tw_dev->alignment_physical_address[request_id];\n\tif (param_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_read_queue(): Bad alignment physical address.\\n\");\n\t\treturn 1;\n\t}\n\tcommand_packet->byte8.param.sgl[0].address = param_value;\n\tcommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\n\n\t \n\tif ((status_reg_value & TW_STATUS_COMMAND_QUEUE_FULL) == 0) {\n\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_aen_read_queue(): Post succeeded.\\n\");\n\t\ttw_dev->srb[request_id] = NULL;  \n\t\ttw_dev->state[request_id] = TW_S_POSTED;\n\t\toutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\n\t} else {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_read_queue(): Post failed, will retry.\\n\");\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}  \n\n \nstatic int tw_aen_complete(TW_Device_Extension *tw_dev, int request_id)\n{\n\tTW_Param *param;\n\tunsigned short aen;\n\tint error = 0, table_max = 0;\n\n\tdprintk(KERN_WARNING \"3w-xxxx: tw_aen_complete()\\n\");\n\tif (tw_dev->alignment_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_complete(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\taen = *(unsigned short *)(param->data);\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_aen_complete(): Queue'd code 0x%x\\n\", aen);\n\n\t \n\tif (aen == 0x0ff) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: AEN: INFO: AEN queue overflow.\\n\", tw_dev->host->host_no);\n\t} else {\n\t\ttable_max = ARRAY_SIZE(tw_aen_string);\n\t\tif ((aen & 0x0ff) < table_max) {\n\t\t\tif ((tw_aen_string[aen & 0xff][strlen(tw_aen_string[aen & 0xff])-1]) == '#') {\n\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: AEN: %s%d.\\n\", tw_dev->host->host_no, tw_aen_string[aen & 0xff], aen >> 8);\n\t\t\t} else {\n\t\t\t\tif (aen != 0x0)\n\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: AEN: %s.\\n\", tw_dev->host->host_no, tw_aen_string[aen & 0xff]);\n\t\t\t}\n\t\t} else {\n\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Received AEN %d.\\n\", tw_dev->host->host_no, aen);\n\t\t}\n\t}\n\tif (aen != TW_AEN_QUEUE_EMPTY) {\n\t\ttw_dev->aen_count++;\n\n\t\t \n\t\ttw_dev->aen_queue[tw_dev->aen_tail] = aen;\n\t\tif (tw_dev->aen_tail == TW_Q_LENGTH - 1) {\n\t\t\ttw_dev->aen_tail = TW_Q_START;\n\t\t} else {\n\t\t\ttw_dev->aen_tail = tw_dev->aen_tail + 1;\n\t\t}\n\t\tif (tw_dev->aen_head == tw_dev->aen_tail) {\n\t\t\tif (tw_dev->aen_head == TW_Q_LENGTH - 1) {\n\t\t\t\ttw_dev->aen_head = TW_Q_START;\n\t\t\t} else {\n\t\t\t\ttw_dev->aen_head = tw_dev->aen_head + 1;\n\t\t\t}\n\t\t}\n\n\t\terror = tw_aen_read_queue(tw_dev, request_id);\n\t\tif (error) {\n\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Error completing AEN.\\n\", tw_dev->host->host_no);\n\t\t\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\t\t\ttw_state_request_finish(tw_dev, request_id);\n\t\t}\n\t} else {\n\t\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\t\ttw_state_request_finish(tw_dev, request_id);\n\t}\n\n\treturn 0;\n}  \n\n \nstatic int tw_aen_drain_queue(TW_Device_Extension *tw_dev)\n{\n\tTW_Command *command_packet;\n\tTW_Param *param;\n\tint request_id = 0;\n\tunsigned long command_que_value;\n\tunsigned long param_value;\n\tTW_Response_Queue response_queue;\n\tunsigned short aen;\n\tunsigned short aen_code;\n\tint finished = 0;\n\tint first_reset = 0;\n\tint queue = 0;\n\tint found = 0, table_max = 0;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_aen_drain_queue()\\n\");\n\n\tif (tw_poll_status(tw_dev, TW_STATUS_ATTENTION_INTERRUPT | TW_STATUS_MICROCONTROLLER_READY, 30)) {\n\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_aen_drain_queue(): No attention interrupt for card %d.\\n\", tw_device_extension_count);\n\t\treturn 1;\n\t}\n\tTW_CLEAR_ATTENTION_INTERRUPT(tw_dev);\n\n\t \n\ttw_empty_response_que(tw_dev);\n\n\t \n\tif (tw_dev->command_packet_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_drain_queue(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\tmemset(command_packet, 0, sizeof(TW_Sector));\n\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\n\tcommand_packet->size = 4;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->status = 0;\n\tcommand_packet->flags = 0;\n\tcommand_packet->byte6.parameter_count = 1;\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tif (command_que_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_drain_queue(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\tif (tw_dev->alignment_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_drain_queue(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tmemset(param, 0, sizeof(TW_Sector));\n\tparam->table_id = 0x401;  \n\tparam->parameter_id = 2;  \n\tparam->parameter_size_bytes = 2;\n\tparam_value = tw_dev->alignment_physical_address[request_id];\n\tif (param_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_drain_queue(): Bad alignment physical address.\\n\");\n\t\treturn 1;\n\t}\n\tcommand_packet->byte8.param.sgl[0].address = param_value;\n\tcommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\n\n\t \n\tdo {\n\t\t \n\t\toutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\n\n\t\t \n\t\tif (tw_poll_status_gone(tw_dev, TW_STATUS_RESPONSE_QUEUE_EMPTY, 30) == 0) {\n\t\t\tresponse_queue.value = inl(TW_RESPONSE_QUEUE_REG_ADDR(tw_dev));\n\t\t\trequest_id = TW_RESID_OUT(response_queue.response_id);\n\n\t\t\tif (request_id != 0) {\n\t\t\t\t \n\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_drain_queue(): Unexpected request id.\\n\");\n\t\t\t\treturn 1;\n\t\t\t}\n\n\t\t\tif (command_packet->status != 0) {\n\t\t\t\tif (command_packet->flags != TW_AEN_TABLE_UNDEFINED) {\n\t\t\t\t\t \n\t\t\t\t\ttw_decode_sense(tw_dev, request_id, 0);\n\t\t\t\t\treturn 1;\n\t\t\t\t} else {\n\t\t\t\t\t \n\t\t\t\t\treturn 0;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t \n\t\t\taen = *(unsigned short *)(param->data);\n\t\t\taen_code = (aen & 0x0ff);\n\t\t\tqueue = 0;\n\t\t\tswitch (aen_code) {\n\t\t\t\tcase TW_AEN_QUEUE_EMPTY:\n\t\t\t\t\tdprintk(KERN_WARNING \"3w-xxxx: AEN: %s.\\n\", tw_aen_string[aen & 0xff]);\n\t\t\t\t\tif (first_reset != 1) {\n\t\t\t\t\t\treturn 1;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfinished = 1;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase TW_AEN_SOFT_RESET:\n\t\t\t\t\tif (first_reset == 0) {\n\t\t\t\t\t\tfirst_reset = 1;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: AEN: %s.\\n\", tw_aen_string[aen & 0xff]);\n\t\t\t\t\t\ttw_dev->aen_count++;\n\t\t\t\t\t\tqueue = 1;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tif (aen == 0x0ff) {\n\t\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: AEN: INFO: AEN queue overflow.\\n\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttable_max = ARRAY_SIZE(tw_aen_string);\n\t\t\t\t\t\tif ((aen & 0x0ff) < table_max) {\n\t\t\t\t\t\t\tif ((tw_aen_string[aen & 0xff][strlen(tw_aen_string[aen & 0xff])-1]) == '#') {\n\t\t\t\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: AEN: %s%d.\\n\", tw_aen_string[aen & 0xff], aen >> 8);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: AEN: %s.\\n\", tw_aen_string[aen & 0xff]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else\n\t\t\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: Received AEN %d.\\n\", aen);\n\t\t\t\t\t}\n\t\t\t\t\ttw_dev->aen_count++;\n\t\t\t\t\tqueue = 1;\n\t\t\t}\n\n\t\t\t \n\t\t\tif (queue == 1) {\n\t\t\t\ttw_dev->aen_queue[tw_dev->aen_tail] = aen;\n\t\t\t\tif (tw_dev->aen_tail == TW_Q_LENGTH - 1) {\n\t\t\t\t\ttw_dev->aen_tail = TW_Q_START;\n\t\t\t\t} else {\n\t\t\t\t\ttw_dev->aen_tail = tw_dev->aen_tail + 1;\n\t\t\t\t}\n\t\t\t\tif (tw_dev->aen_head == tw_dev->aen_tail) {\n\t\t\t\t\tif (tw_dev->aen_head == TW_Q_LENGTH - 1) {\n\t\t\t\t\t\ttw_dev->aen_head = TW_Q_START;\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttw_dev->aen_head = tw_dev->aen_head + 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfound = 1;\n\t\t}\n\t\tif (found == 0) {\n\t\t\tprintk(KERN_WARNING \"3w-xxxx: tw_aen_drain_queue(): Response never received.\\n\");\n\t\t\treturn 1;\n\t\t}\n\t} while (finished == 0);\n\n\treturn 0;\n}  \n\n \nstatic int tw_allocate_memory(TW_Device_Extension *tw_dev, int size, int which)\n{\n\tint i;\n\tdma_addr_t dma_handle;\n\tunsigned long *cpu_addr = NULL;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_allocate_memory()\\n\");\n\n\tcpu_addr = dma_alloc_coherent(&tw_dev->tw_pci_dev->dev,\n\t\t\tsize * TW_Q_LENGTH, &dma_handle, GFP_KERNEL);\n\tif (cpu_addr == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: dma_alloc_coherent() failed.\\n\");\n\t\treturn 1;\n\t}\n\n\tif ((unsigned long)cpu_addr % (tw_dev->tw_pci_dev->device == TW_DEVICE_ID ? TW_ALIGNMENT_6000 : TW_ALIGNMENT_7000)) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Couldn't allocate correctly aligned memory.\\n\");\n\t\tdma_free_coherent(&tw_dev->tw_pci_dev->dev, size * TW_Q_LENGTH,\n\t\t\t\tcpu_addr, dma_handle);\n\t\treturn 1;\n\t}\n\n\tmemset(cpu_addr, 0, size*TW_Q_LENGTH);\n\n\tfor (i=0;i<TW_Q_LENGTH;i++) {\n\t\tswitch(which) {\n\t\tcase 0:\n\t\t\ttw_dev->command_packet_physical_address[i] = dma_handle+(i*size);\n\t\t\ttw_dev->command_packet_virtual_address[i] = (unsigned long *)((unsigned char *)cpu_addr + (i*size));\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\ttw_dev->alignment_physical_address[i] = dma_handle+(i*size);\n\t\t\ttw_dev->alignment_virtual_address[i] = (unsigned long *)((unsigned char *)cpu_addr + (i*size));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tprintk(KERN_WARNING \"3w-xxxx: tw_allocate_memory(): case slip in tw_allocate_memory()\\n\");\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\treturn 0;\n}  \n\n \nstatic long tw_chrdev_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\n{\n\tint request_id;\n\tdma_addr_t dma_handle;\n\tunsigned short tw_aen_code;\n\tunsigned long flags;\n\tunsigned int data_buffer_length = 0;\n\tunsigned long data_buffer_length_adjusted = 0;\n\tstruct inode *inode = file_inode(file);\n\tunsigned long *cpu_addr;\n\tlong timeout;\n\tTW_New_Ioctl *tw_ioctl;\n\tTW_Passthru *passthru;\n\tTW_Device_Extension *tw_dev = tw_device_extension_list[iminor(inode)];\n\tint retval = -EFAULT;\n\tvoid __user *argp = (void __user *)arg;\n\n\tdprintk(KERN_WARNING \"3w-xxxx: tw_chrdev_ioctl()\\n\");\n\n\tmutex_lock(&tw_mutex);\n\t \n\tif (mutex_lock_interruptible(&tw_dev->ioctl_lock)) {\n\t\tmutex_unlock(&tw_mutex);\n\t\treturn -EINTR;\n\t}\n\n\t \n\tif (copy_from_user(&data_buffer_length, argp, sizeof(unsigned int)))\n\t\tgoto out;\n\n\t \n\tif (data_buffer_length > TW_MAX_IOCTL_SECTORS * 512) {\n\t\tretval = -EINVAL;\n\t\tgoto out;\n\t}\n\n\t \n\tdata_buffer_length_adjusted = (data_buffer_length + 511) & ~511;\n\n\t \n\tcpu_addr = dma_alloc_coherent(&tw_dev->tw_pci_dev->dev, data_buffer_length_adjusted + sizeof(TW_New_Ioctl), &dma_handle, GFP_KERNEL);\n\tif (cpu_addr == NULL) {\n\t\tretval = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\ttw_ioctl = (TW_New_Ioctl *)cpu_addr;\n\n\t \n\tif (copy_from_user(tw_ioctl, argp, data_buffer_length + sizeof(TW_New_Ioctl)))\n\t\tgoto out2;\n\n\tpassthru = (TW_Passthru *)&tw_ioctl->firmware_command;\n\n\t \n\tswitch (cmd) {\n\t\tcase TW_OP_NOP:\n\t\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_chrdev_ioctl(): caught TW_OP_NOP.\\n\");\n\t\t\tbreak;\n\t\tcase TW_OP_AEN_LISTEN:\n\t\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_chrdev_ioctl(): caught TW_AEN_LISTEN.\\n\");\n\t\t\tmemset(tw_ioctl->data_buffer, 0, data_buffer_length);\n\n\t\t\tspin_lock_irqsave(tw_dev->host->host_lock, flags);\n\t\t\tif (tw_dev->aen_head == tw_dev->aen_tail) {\n\t\t\t\ttw_aen_code = TW_AEN_QUEUE_EMPTY;\n\t\t\t} else {\n\t\t\t\ttw_aen_code = tw_dev->aen_queue[tw_dev->aen_head];\n\t\t\t\tif (tw_dev->aen_head == TW_Q_LENGTH - 1) {\n\t\t\t\t\ttw_dev->aen_head = TW_Q_START;\n\t\t\t\t} else {\n\t\t\t\t\ttw_dev->aen_head = tw_dev->aen_head + 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\tspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\n\t\t\tmemcpy(tw_ioctl->data_buffer, &tw_aen_code, sizeof(tw_aen_code));\n\t\t\tbreak;\n\t\tcase TW_CMD_PACKET_WITH_DATA:\n\t\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_chrdev_ioctl(): caught TW_CMD_PACKET_WITH_DATA.\\n\");\n\t\t\tspin_lock_irqsave(tw_dev->host->host_lock, flags);\n\n\t\t\ttw_state_request_start(tw_dev, &request_id);\n\n\t\t\t \n\t\t\ttw_dev->srb[request_id] = NULL;\n\n\t\t\t \n\t\t\ttw_dev->chrdev_request_id = request_id;\n\n\t\t\ttw_ioctl->firmware_command.request_id = request_id;\n\n\t\t\t \n\t\t\tswitch (TW_SGL_OUT(tw_ioctl->firmware_command.opcode__sgloffset)) {\n\t\t\tcase 2:\n\t\t\t\ttw_ioctl->firmware_command.byte8.param.sgl[0].address = dma_handle + sizeof(TW_New_Ioctl);\n\t\t\t\ttw_ioctl->firmware_command.byte8.param.sgl[0].length = data_buffer_length_adjusted;\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\ttw_ioctl->firmware_command.byte8.io.sgl[0].address = dma_handle + sizeof(TW_New_Ioctl);\n\t\t\t\ttw_ioctl->firmware_command.byte8.io.sgl[0].length = data_buffer_length_adjusted;\n\t\t\t\tbreak;\n\t\t\tcase 5:\n\t\t\t\tpassthru->sg_list[0].address = dma_handle + sizeof(TW_New_Ioctl);\n\t\t\t\tpassthru->sg_list[0].length = data_buffer_length_adjusted;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tmemcpy(tw_dev->command_packet_virtual_address[request_id], &(tw_ioctl->firmware_command), sizeof(TW_Command));\n\n\t\t\t \n\t\t\ttw_post_command_packet(tw_dev, request_id);\n\t\t\tspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\n\n\t\t\ttimeout = TW_IOCTL_CHRDEV_TIMEOUT*HZ;\n\n\t\t\t \n\t\t\ttimeout = wait_event_timeout(tw_dev->ioctl_wqueue, tw_dev->chrdev_request_id == TW_IOCTL_CHRDEV_FREE, timeout);\n\n\t\t\t \n\t\t\tif (tw_dev->chrdev_request_id != TW_IOCTL_CHRDEV_FREE) {\n\t\t\t\t \n\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Character ioctl (0x%x) timed out, resetting card.\\n\", tw_dev->host->host_no, cmd);\n\t\t\t\tretval = -EIO;\n\t\t\t\tif (tw_reset_device_extension(tw_dev)) {\n\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: tw_chrdev_ioctl(): Reset failed for card %d.\\n\", tw_dev->host->host_no);\n\t\t\t\t}\n\t\t\t\tgoto out2;\n\t\t\t}\n\n\t\t\t \n\t\t\tmemcpy(&(tw_ioctl->firmware_command), tw_dev->command_packet_virtual_address[request_id], sizeof(TW_Command));\n\n\t\t\t \n\t\t\tspin_lock_irqsave(tw_dev->host->host_lock, flags);\n\t\t\ttw_dev->posted_request_count--;\n\t\t\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\t\t\ttw_state_request_finish(tw_dev, request_id);\n\t\t\tspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tretval = -ENOTTY;\n\t\t\tgoto out2;\n\t}\n\n\t \n\tif (copy_to_user(argp, tw_ioctl, sizeof(TW_New_Ioctl) + data_buffer_length))\n\t\tgoto out2;\n\tretval = 0;\nout2:\n\t \n\tdma_free_coherent(&tw_dev->tw_pci_dev->dev, data_buffer_length_adjusted + sizeof(TW_New_Ioctl), cpu_addr, dma_handle);\nout:\n\tmutex_unlock(&tw_dev->ioctl_lock);\n\tmutex_unlock(&tw_mutex);\n\treturn retval;\n}  \n\n \n \nstatic int tw_chrdev_open(struct inode *inode, struct file *file)\n{\n\tunsigned int minor_number;\n\n\tdprintk(KERN_WARNING \"3w-xxxx: tw_ioctl_open()\\n\");\n\n\tif (!capable(CAP_SYS_ADMIN))\n\t\treturn -EACCES;\n\n\tminor_number = iminor(inode);\n\tif (minor_number >= tw_device_extension_count)\n\t\treturn -ENODEV;\n\n\treturn 0;\n}  \n\n \nstatic const struct file_operations tw_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.unlocked_ioctl\t= tw_chrdev_ioctl,\n\t.compat_ioctl   = compat_ptr_ioctl,\n\t.open\t\t= tw_chrdev_open,\n\t.release\t= NULL,\n\t.llseek\t\t= noop_llseek,\n};\n\n \nstatic void tw_free_device_extension(TW_Device_Extension *tw_dev)\n{\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_free_device_extension()\\n\");\n\n\t \n\tif (tw_dev->command_packet_virtual_address[0])\n\t\tdma_free_coherent(&tw_dev->tw_pci_dev->dev,\n\t\t\t\tsizeof(TW_Command) * TW_Q_LENGTH,\n\t\t\t\ttw_dev->command_packet_virtual_address[0],\n\t\t\t\ttw_dev->command_packet_physical_address[0]);\n\n\tif (tw_dev->alignment_virtual_address[0])\n\t\tdma_free_coherent(&tw_dev->tw_pci_dev->dev,\n\t\t\t\tsizeof(TW_Sector) * TW_Q_LENGTH,\n\t\t\t\ttw_dev->alignment_virtual_address[0],\n\t\t\t\ttw_dev->alignment_physical_address[0]);\n}  \n\n \nstatic int tw_initconnection(TW_Device_Extension *tw_dev, int message_credits)\n{\n\tunsigned long command_que_value;\n\tTW_Command  *command_packet;\n\tTW_Response_Queue response_queue;\n\tint request_id = 0;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_initconnection()\\n\");\n\n\t \n\tif (tw_dev->command_packet_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_initconnection(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\tmemset(command_packet, 0, sizeof(TW_Sector));\n\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(0, TW_OP_INIT_CONNECTION);\n\tcommand_packet->size = TW_INIT_COMMAND_PACKET_SIZE;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->status = 0x0;\n\tcommand_packet->flags = 0x0;\n\tcommand_packet->byte6.message_credits = message_credits; \n\tcommand_packet->byte8.init_connection.response_queue_pointer = 0x0;\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\n\tif (command_que_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_initconnection(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\toutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\n\n\t \n\tif (tw_poll_status_gone(tw_dev, TW_STATUS_RESPONSE_QUEUE_EMPTY, 30) == 0) {\n\t\tresponse_queue.value = inl(TW_RESPONSE_QUEUE_REG_ADDR(tw_dev));\n\t\trequest_id = TW_RESID_OUT(response_queue.response_id);\n\n\t\tif (request_id != 0) {\n\t\t\t \n\t\t\tprintk(KERN_WARNING \"3w-xxxx: tw_initconnection(): Unexpected request id.\\n\");\n\t\t\treturn 1;\n\t\t}\n\t\tif (command_packet->status != 0) {\n\t\t\t \n\t\t\ttw_decode_sense(tw_dev, request_id, 0);\n\t\t\treturn 1;\n\t\t}\n\t}\n\treturn 0;\n}  \n\n \nstatic int tw_setfeature(TW_Device_Extension *tw_dev, int parm, int param_size,\n\t\t\t unsigned char *val)\n{\n\tTW_Param *param;\n\tTW_Command  *command_packet;\n\tTW_Response_Queue response_queue;\n\tint request_id = 0;\n\tunsigned long command_que_value;\n\tunsigned long param_value;\n\n\t \n\tif (tw_dev->command_packet_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_setfeature(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\tmemset(command_packet, 0, sizeof(TW_Sector));\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\n\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_SET_PARAM);\n\tparam->table_id = 0x404;   \n\tparam->parameter_id = parm;\n\tparam->parameter_size_bytes = param_size;\n\tmemcpy(param->data, val, param_size);\n\n\tparam_value = tw_dev->alignment_physical_address[request_id];\n\tif (param_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_setfeature(): Bad alignment physical address.\\n\");\n\t\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\t\ttw_state_request_finish(tw_dev, request_id);\n\t\ttw_dev->srb[request_id]->result = (DID_OK << 16);\n\t\tscsi_done(tw_dev->srb[request_id]);\n\t}\n\tcommand_packet->byte8.param.sgl[0].address = param_value;\n\tcommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\n\n\tcommand_packet->size = 4;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->byte6.parameter_count = 1;\n\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tif (command_que_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_setfeature(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\toutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\n\n\t \n\tif (tw_poll_status_gone(tw_dev, TW_STATUS_RESPONSE_QUEUE_EMPTY, 30) == 0) {\n\t\tresponse_queue.value = inl(TW_RESPONSE_QUEUE_REG_ADDR(tw_dev));\n\t\trequest_id = TW_RESID_OUT(response_queue.response_id);\n\n\t\tif (request_id != 0) {\n\t\t\t \n\t\t\tprintk(KERN_WARNING \"3w-xxxx: tw_setfeature(): Unexpected request id.\\n\");\n\t\t\treturn 1;\n\t\t}\n\t\tif (command_packet->status != 0) {\n\t\t\t \n\t\t\ttw_decode_sense(tw_dev, request_id, 0);\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\treturn 0;\n}  \n\n \nstatic int tw_reset_sequence(TW_Device_Extension *tw_dev)\n{\n\tint error = 0;\n\tint tries = 0;\n\tunsigned char c = 1;\n\n\t \n\twhile (tries < TW_MAX_RESET_TRIES) {\n\t\tTW_SOFT_RESET(tw_dev);\n\n\t\terror = tw_aen_drain_queue(tw_dev);\n\t\tif (error) {\n\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: AEN drain failed, retrying.\\n\", tw_dev->host->host_no);\n\t\t\ttries++;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif (tw_check_errors(tw_dev)) {\n\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Controller errors found, retrying.\\n\", tw_dev->host->host_no);\n\t\t\ttries++;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tbreak;\n\t}\n\n\tif (tries >= TW_MAX_RESET_TRIES) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Controller errors, card not responding, check all cabling.\\n\", tw_dev->host->host_no);\n\t\treturn 1;\n\t}\n\n\terror = tw_initconnection(tw_dev, TW_INIT_MESSAGE_CREDITS);\n\tif (error) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Connection initialization failed.\\n\", tw_dev->host->host_no);\n\t\treturn 1;\n\t}\n\n\terror = tw_setfeature(tw_dev, 2, 1, &c);\n\tif (error) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Unable to set features for card, probable old firmware or card.\\n\");\n\t}\n\n\treturn 0;\n}  \n\n \nstatic int tw_initialize_device_extension(TW_Device_Extension *tw_dev)\n{\n\tint i, error=0;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_initialize_device_extension()\\n\");\n\n\t \n\terror = tw_allocate_memory(tw_dev, sizeof(TW_Command), 0);\n\tif (error) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Command packet memory allocation failed.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\terror = tw_allocate_memory(tw_dev, sizeof(TW_Sector), 1);\n\tif (error) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Generic memory allocation failed.\\n\");\n\t\treturn 1;\n\t}\n\n\tfor (i=0;i<TW_Q_LENGTH;i++) {\n\t\ttw_dev->free_queue[i] = i;\n\t\ttw_dev->state[i] = TW_S_INITIAL;\n\t}\n\n\ttw_dev->pending_head = TW_Q_START;\n\ttw_dev->pending_tail = TW_Q_START;\n\ttw_dev->chrdev_request_id = TW_IOCTL_CHRDEV_FREE;\n\n\tmutex_init(&tw_dev->ioctl_lock);\n\tinit_waitqueue_head(&tw_dev->ioctl_wqueue);\n\n\treturn 0;\n}  \n\n \nstatic int tw_reset_device_extension(TW_Device_Extension *tw_dev)\n{\n\tint i = 0;\n\tstruct scsi_cmnd *srb;\n\tunsigned long flags = 0;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_reset_device_extension()\\n\");\n\n\tset_bit(TW_IN_RESET, &tw_dev->flags);\n\tTW_DISABLE_INTERRUPTS(tw_dev);\n\tTW_MASK_COMMAND_INTERRUPT(tw_dev);\n\tspin_lock_irqsave(tw_dev->host->host_lock, flags);\n\n\t \n\tfor (i=0;i<TW_Q_LENGTH;i++) {\n\t\tif ((tw_dev->state[i] != TW_S_FINISHED) &&\n\t\t    (tw_dev->state[i] != TW_S_INITIAL) &&\n\t\t    (tw_dev->state[i] != TW_S_COMPLETED)) {\n\t\t\tsrb = tw_dev->srb[i];\n\t\t\tif (srb != NULL) {\n\t\t\t\tsrb->result = (DID_RESET << 16);\n\t\t\t\tscsi_dma_unmap(srb);\n\t\t\t\tscsi_done(srb);\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tfor (i=0;i<TW_Q_LENGTH;i++) {\n\t\ttw_dev->free_queue[i] = i;\n\t\ttw_dev->state[i] = TW_S_INITIAL;\n\t}\n\ttw_dev->free_head = TW_Q_START;\n\ttw_dev->free_tail = TW_Q_START;\n\ttw_dev->posted_request_count = 0;\n\ttw_dev->pending_request_count = 0;\n\ttw_dev->pending_head = TW_Q_START;\n\ttw_dev->pending_tail = TW_Q_START;\n\ttw_dev->reset_print = 0;\n\n\tspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\n\n\tif (tw_reset_sequence(tw_dev)) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Reset sequence failed.\\n\", tw_dev->host->host_no);\n\t\treturn 1;\n\t}\n\n\tTW_ENABLE_AND_CLEAR_INTERRUPTS(tw_dev);\n\tclear_bit(TW_IN_RESET, &tw_dev->flags);\n\ttw_dev->chrdev_request_id = TW_IOCTL_CHRDEV_FREE;\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsi_biosparam(struct scsi_device *sdev, struct block_device *bdev,\n\t\t\t     sector_t capacity, int geom[])\n{\n\tint heads, sectors, cylinders;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsi_biosparam()\\n\");\n\n\theads = 64;\n\tsectors = 32;\n\tcylinders = sector_div(capacity, heads * sectors);\n\n\tif (capacity >= 0x200000) {\n\t\theads = 255;\n\t\tsectors = 63;\n\t\tcylinders = sector_div(capacity, heads * sectors);\n\t}\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsi_biosparam(): heads = %d, sectors = %d, cylinders = %d\\n\", heads, sectors, cylinders);\n\tgeom[0] = heads;\n\tgeom[1] = sectors;\n\tgeom[2] = cylinders;\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsi_eh_reset(struct scsi_cmnd *SCpnt)\n{\n\tTW_Device_Extension *tw_dev=NULL;\n\tint retval = FAILED;\n\n\ttw_dev = (TW_Device_Extension *)SCpnt->device->host->hostdata;\n\n\ttw_dev->num_resets++;\n\n\tsdev_printk(KERN_WARNING, SCpnt->device,\n\t\t\"WARNING: Command (0x%x) timed out, resetting card.\\n\",\n\t\tSCpnt->cmnd[0]);\n\n\t \n\tmutex_lock(&tw_dev->ioctl_lock);\n\n\t \n\tif (tw_reset_device_extension(tw_dev)) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Reset failed.\\n\", tw_dev->host->host_no);\n\t\tgoto out;\n\t}\n\n\tretval = SUCCESS;\nout:\n\tmutex_unlock(&tw_dev->ioctl_lock);\n\treturn retval;\n}  \n\n \nstatic int tw_scsiop_inquiry(TW_Device_Extension *tw_dev, int request_id)\n{\n\tTW_Param *param;\n\tTW_Command *command_packet;\n\tunsigned long command_que_value;\n\tunsigned long param_value;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_inquiry()\\n\");\n\n\t \n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\tif (command_packet == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_inquiry(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tmemset(command_packet, 0, sizeof(TW_Sector));\n\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\n\tcommand_packet->size = 4;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->status = 0;\n\tcommand_packet->flags = 0;\n\tcommand_packet->byte6.parameter_count = 1;\n\n\t \n\tif (tw_dev->alignment_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_inquiry(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tmemset(param, 0, sizeof(TW_Sector));\n\tparam->table_id = 3;\t  \n\tparam->parameter_id = 3;  \n\tparam->parameter_size_bytes = TW_MAX_UNITS;\n\tparam_value = tw_dev->alignment_physical_address[request_id];\n\tif (param_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_inquiry(): Bad alignment physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\tcommand_packet->byte8.param.sgl[0].address = param_value;\n\tcommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tif (command_que_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_inquiry(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\ttw_post_command_packet(tw_dev, request_id);\n\n\treturn 0;\n}  \n\nstatic void tw_transfer_internal(TW_Device_Extension *tw_dev, int request_id,\n\t\t\t\t void *data, unsigned int len)\n{\n\tscsi_sg_copy_from_buffer(tw_dev->srb[request_id], data, len);\n}\n\n \nstatic int tw_scsiop_inquiry_complete(TW_Device_Extension *tw_dev, int request_id)\n{\n\tunsigned char *is_unit_present;\n\tunsigned char request_buffer[36];\n\tTW_Param *param;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_inquiry_complete()\\n\");\n\n\tmemset(request_buffer, 0, sizeof(request_buffer));\n\trequest_buffer[0] = TYPE_DISK;  \n\trequest_buffer[1] = 0;\t        \n\trequest_buffer[2] = 0;\t        \n\trequest_buffer[4] = 31;\t        \n\tmemcpy(&request_buffer[8], \"3ware   \", 8);\t  \n\tsprintf(&request_buffer[16], \"Logical Disk %-2d \", tw_dev->srb[request_id]->device->id);\n\tmemcpy(&request_buffer[32], TW_DRIVER_VERSION, 3);\n\ttw_transfer_internal(tw_dev, request_id, request_buffer,\n\t\t\t     sizeof(request_buffer));\n\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tif (param == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_inquiry_complete(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tis_unit_present = &(param->data[0]);\n\n\tif (is_unit_present[tw_dev->srb[request_id]->device->id] & TW_UNIT_ONLINE) {\n\t\ttw_dev->is_unit_present[tw_dev->srb[request_id]->device->id] = 1;\n\t} else {\n\t\ttw_dev->is_unit_present[tw_dev->srb[request_id]->device->id] = 0;\n\t\ttw_dev->srb[request_id]->result = (DID_BAD_TARGET << 16);\n\t\treturn TW_ISR_DONT_RESULT;\n\t}\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsiop_mode_sense(TW_Device_Extension *tw_dev, int request_id)\n{\n\tTW_Param *param;\n\tTW_Command *command_packet;\n\tunsigned long command_que_value;\n\tunsigned long param_value;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_mode_sense()\\n\");\n\n\t \n\tif (tw_dev->srb[request_id]->cmnd[2] != 0x8) {\n\t\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\t\ttw_state_request_finish(tw_dev, request_id);\n\t\ttw_dev->srb[request_id]->result = (DID_OK << 16);\n\t\tscsi_done(tw_dev->srb[request_id]);\n\t\treturn 0;\n\t}\n\n\t \n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\tif (command_packet == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_mode_sense(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\tmemset(command_packet, 0, sizeof(TW_Sector));\n\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\n\tcommand_packet->size = 4;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->status = 0;\n\tcommand_packet->flags = 0;\n\tcommand_packet->byte6.parameter_count = 1;\n\n\t \n\tif (tw_dev->alignment_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_mode_sense(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tmemset(param, 0, sizeof(TW_Sector));\n\tparam->table_id = TW_UNIT_INFORMATION_TABLE_BASE + tw_dev->srb[request_id]->device->id;\n\tparam->parameter_id = 7;  \n\tparam->parameter_size_bytes = 1;\n\tparam_value = tw_dev->alignment_physical_address[request_id];\n\tif (param_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_mode_sense(): Bad alignment physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\tcommand_packet->byte8.param.sgl[0].address = param_value;\n\tcommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tif (command_que_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_mode_sense(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\ttw_post_command_packet(tw_dev, request_id);\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsiop_mode_sense_complete(TW_Device_Extension *tw_dev, int request_id)\n{\n\tTW_Param *param;\n\tunsigned char *flags;\n\tunsigned char request_buffer[8];\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_mode_sense_complete()\\n\");\n\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tif (param == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_mode_sense_complete(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tflags = (char *)&(param->data[0]);\n\tmemset(request_buffer, 0, sizeof(request_buffer));\n\n\trequest_buffer[0] = 0xf;\t \n\trequest_buffer[1] = 0;\t\t \n\trequest_buffer[2] = 0x10;\t \n\trequest_buffer[3] = 0;\t\t \n\trequest_buffer[4] = 0x8;\t \n\trequest_buffer[5] = 0xa;\t \n\tif (*flags & 0x1)\n\t\trequest_buffer[6] = 0x5;\t \n\telse\n\t\trequest_buffer[6] = 0x1;\t \n\ttw_transfer_internal(tw_dev, request_id, request_buffer,\n\t\t\t     sizeof(request_buffer));\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsiop_read_capacity(TW_Device_Extension *tw_dev, int request_id)\n{\n\tTW_Param *param;\n\tTW_Command *command_packet;\n\tunsigned long command_que_value;\n\tunsigned long param_value;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_capacity()\\n\");\n\n\t \n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\n\tif (command_packet == NULL) {\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_capacity(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tmemset(command_packet, 0, sizeof(TW_Sector));\n\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\n\tcommand_packet->size = 4;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->unit__hostid = TW_UNITHOST_IN(0, tw_dev->srb[request_id]->device->id);\n\tcommand_packet->status = 0;\n\tcommand_packet->flags = 0;\n\tcommand_packet->byte6.block_count = 1;\n\n\t \n\tif (tw_dev->alignment_virtual_address[request_id] == NULL) {\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_capacity(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tmemset(param, 0, sizeof(TW_Sector));\n\tparam->table_id = TW_UNIT_INFORMATION_TABLE_BASE +\n\t\ttw_dev->srb[request_id]->device->id;\n\tparam->parameter_id = 4;\t \n\tparam->parameter_size_bytes = 4;\n\tparam_value = tw_dev->alignment_physical_address[request_id];\n\tif (param_value == 0) {\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_capacity(): Bad alignment physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\tcommand_packet->byte8.param.sgl[0].address = param_value;\n\tcommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tif (command_que_value == 0) {\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_capacity(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\ttw_post_command_packet(tw_dev, request_id);\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsiop_read_capacity_complete(TW_Device_Extension *tw_dev, int request_id)\n{\n\tunsigned char *param_data;\n\tu32 capacity;\n\tchar buff[8];\n\tTW_Param *param;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_capacity_complete()\\n\");\n\n\tmemset(buff, 0, sizeof(buff));\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tif (param == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_read_capacity_complete(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tparam_data = &(param->data[0]);\n\n\tcapacity = (param_data[3] << 24) | (param_data[2] << 16) |\n\t\t   (param_data[1] << 8) | param_data[0];\n\n\t \n\tcapacity -= 1;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_capacity_complete(): Capacity = 0x%x.\\n\", capacity);\n\n\t \n\tbuff[0] = (capacity >> 24);\n\tbuff[1] = (capacity >> 16) & 0xff;\n\tbuff[2] = (capacity >> 8) & 0xff;\n\tbuff[3] = capacity & 0xff;\n\n\t \n\tbuff[4] = (TW_BLOCK_SIZE >> 24);\n\tbuff[5] = (TW_BLOCK_SIZE >> 16) & 0xff;\n\tbuff[6] = (TW_BLOCK_SIZE >> 8) & 0xff;\n\tbuff[7] = TW_BLOCK_SIZE & 0xff;\n\n\ttw_transfer_internal(tw_dev, request_id, buff, sizeof(buff));\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsiop_read_write(TW_Device_Extension *tw_dev, int request_id)\n{\n\tTW_Command *command_packet;\n\tunsigned long command_que_value;\n\tu32 lba = 0x0, num_sectors = 0x0;\n\tint i, use_sg;\n\tstruct scsi_cmnd *srb;\n\tstruct scatterlist *sglist, *sg;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_write()\\n\");\n\n\tsrb = tw_dev->srb[request_id];\n\n\tsglist = scsi_sglist(srb);\n\tif (!sglist) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_read_write(): Request buffer NULL.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\tif (command_packet == NULL) {\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_write(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\n\tif (srb->cmnd[0] == READ_6 || srb->cmnd[0] == READ_10) {\n\t\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(3, TW_OP_READ);\n\t} else {\n\t\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(3, TW_OP_WRITE);\n\t}\n\n\tcommand_packet->size = 3;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->unit__hostid = TW_UNITHOST_IN(0, srb->device->id);\n\tcommand_packet->status = 0;\n\tcommand_packet->flags = 0;\n\n\tif (srb->cmnd[0] == WRITE_10) {\n\t\tif ((srb->cmnd[1] & 0x8) || (srb->cmnd[1] & 0x10))\n\t\t\tcommand_packet->flags = 1;\n\t}\n\n\tif (srb->cmnd[0] == READ_6 || srb->cmnd[0] == WRITE_6) {\n\t\tlba = ((u32)srb->cmnd[1] << 16) | ((u32)srb->cmnd[2] << 8) | (u32)srb->cmnd[3];\n\t\tnum_sectors = (u32)srb->cmnd[4];\n\t} else {\n\t\tlba = ((u32)srb->cmnd[2] << 24) | ((u32)srb->cmnd[3] << 16) | ((u32)srb->cmnd[4] << 8) | (u32)srb->cmnd[5];\n\t\tnum_sectors = (u32)srb->cmnd[8] | ((u32)srb->cmnd[7] << 8);\n\t}\n\n\t \n\ttw_dev->sector_count = num_sectors;\n\tif (tw_dev->sector_count > tw_dev->max_sector_count)\n\t\ttw_dev->max_sector_count = tw_dev->sector_count;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_read_write(): lba = 0x%x num_sectors = 0x%x\\n\", lba, num_sectors);\n\tcommand_packet->byte8.io.lba = lba;\n\tcommand_packet->byte6.block_count = num_sectors;\n\n\tuse_sg = scsi_dma_map(srb);\n\tif (use_sg <= 0)\n\t\treturn 1;\n\n\tscsi_for_each_sg(tw_dev->srb[request_id], sg, use_sg, i) {\n\t\tcommand_packet->byte8.io.sgl[i].address = sg_dma_address(sg);\n\t\tcommand_packet->byte8.io.sgl[i].length = sg_dma_len(sg);\n\t\tcommand_packet->size+=2;\n\t}\n\n\t \n\ttw_dev->sgl_entries = scsi_sg_count(tw_dev->srb[request_id]);\n\tif (tw_dev->sgl_entries > tw_dev->max_sgl_entries)\n\t\ttw_dev->max_sgl_entries = tw_dev->sgl_entries;\n\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tif (command_que_value == 0) {\n\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_read_write(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\ttw_post_command_packet(tw_dev, request_id);\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsiop_request_sense(TW_Device_Extension *tw_dev, int request_id)\n{\n\tchar request_buffer[18];\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_request_sense()\\n\");\n\n\tmemset(request_buffer, 0, sizeof(request_buffer));\n\trequest_buffer[0] = 0x70;  \n\trequest_buffer[7] = 10;\t \n\t \n\ttw_transfer_internal(tw_dev, request_id, request_buffer,\n\t\t\t     sizeof(request_buffer));\n\n\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\ttw_state_request_finish(tw_dev, request_id);\n\n\t \n\ttw_dev->srb[request_id]->result = (DID_ERROR << 16);\n\tscsi_done(tw_dev->srb[request_id]);\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsiop_synchronize_cache(TW_Device_Extension *tw_dev, int request_id)\n{\n\tTW_Command *command_packet;\n\tunsigned long command_que_value;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_synchronize_cache()\\n\");\n\n\t \n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\tif (command_packet == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_synchronize_cache(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\tmemset(command_packet, 0, sizeof(TW_Sector));\n\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(0, TW_OP_FLUSH_CACHE);\n\tcommand_packet->size = 2;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->unit__hostid = TW_UNITHOST_IN(0, tw_dev->srb[request_id]->device->id);\n\tcommand_packet->status = 0;\n\tcommand_packet->flags = 0;\n\tcommand_packet->byte6.parameter_count = 1;\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tif (command_que_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_synchronize_cache(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\ttw_post_command_packet(tw_dev, request_id);\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsiop_test_unit_ready(TW_Device_Extension *tw_dev, int request_id)\n{\n\tTW_Param *param;\n\tTW_Command *command_packet;\n\tunsigned long command_que_value;\n\tunsigned long param_value;\n\n\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsiop_test_unit_ready()\\n\");\n\n\t \n\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\tif (command_packet == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_test_unit_ready(): Bad command packet virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tmemset(command_packet, 0, sizeof(TW_Sector));\n\tcommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\n\tcommand_packet->size = 4;\n\tcommand_packet->request_id = request_id;\n\tcommand_packet->status = 0;\n\tcommand_packet->flags = 0;\n\tcommand_packet->byte6.parameter_count = 1;\n\n\t \n\tif (tw_dev->alignment_virtual_address[request_id] == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_test_unit_ready(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tmemset(param, 0, sizeof(TW_Sector));\n\tparam->table_id = 3;\t  \n\tparam->parameter_id = 3;  \n\tparam->parameter_size_bytes = TW_MAX_UNITS;\n\tparam_value = tw_dev->alignment_physical_address[request_id];\n\tif (param_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_test_unit_ready(): Bad alignment physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\tcommand_packet->byte8.param.sgl[0].address = param_value;\n\tcommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\n\tcommand_que_value = tw_dev->command_packet_physical_address[request_id];\n\tif (command_que_value == 0) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_test_unit_ready(): Bad command packet physical address.\\n\");\n\t\treturn 1;\n\t}\n\n\t \n\ttw_post_command_packet(tw_dev, request_id);\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsiop_test_unit_ready_complete(TW_Device_Extension *tw_dev, int request_id)\n{\n\tunsigned char *is_unit_present;\n\tTW_Param *param;\n\n\tdprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_test_unit_ready_complete()\\n\");\n\n\tparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\n\tif (param == NULL) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: tw_scsiop_test_unit_ready_complete(): Bad alignment virtual address.\\n\");\n\t\treturn 1;\n\t}\n\tis_unit_present = &(param->data[0]);\n\n\tif (is_unit_present[tw_dev->srb[request_id]->device->id] & TW_UNIT_ONLINE) {\n\t\ttw_dev->is_unit_present[tw_dev->srb[request_id]->device->id] = 1;\n\t} else {\n\t\ttw_dev->is_unit_present[tw_dev->srb[request_id]->device->id] = 0;\n\t\ttw_dev->srb[request_id]->result = (DID_BAD_TARGET << 16);\n\t\treturn TW_ISR_DONT_RESULT;\n\t}\n\n\treturn 0;\n}  \n\n \nstatic int tw_scsi_queue_lck(struct scsi_cmnd *SCpnt)\n{\n\tvoid (*done)(struct scsi_cmnd *) = scsi_done;\n\tunsigned char *command = SCpnt->cmnd;\n\tint request_id = 0;\n\tint retval = 1;\n\tTW_Device_Extension *tw_dev = (TW_Device_Extension *)SCpnt->device->host->hostdata;\n\n\t \n\tif (test_bit(TW_IN_RESET, &tw_dev->flags))\n\t\treturn SCSI_MLQUEUE_HOST_BUSY;\n\n\t \n\ttw_state_request_start(tw_dev, &request_id);\n\n\t \n\ttw_dev->srb[request_id] = SCpnt;\n\n\tswitch (*command) {\n\tcase READ_10:\n\tcase READ_6:\n\tcase WRITE_10:\n\tcase WRITE_6:\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsi_queue(): caught READ/WRITE.\\n\");\n\t\tretval = tw_scsiop_read_write(tw_dev, request_id);\n\t\tbreak;\n\tcase TEST_UNIT_READY:\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsi_queue(): caught TEST_UNIT_READY.\\n\");\n\t\tretval = tw_scsiop_test_unit_ready(tw_dev, request_id);\n\t\tbreak;\n\tcase INQUIRY:\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsi_queue(): caught INQUIRY.\\n\");\n\t\tretval = tw_scsiop_inquiry(tw_dev, request_id);\n\t\tbreak;\n\tcase READ_CAPACITY:\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsi_queue(): caught READ_CAPACITY.\\n\");\n\t\tretval = tw_scsiop_read_capacity(tw_dev, request_id);\n\t\tbreak;\n\tcase REQUEST_SENSE:\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsi_queue(): caught REQUEST_SENSE.\\n\");\n\t\tretval = tw_scsiop_request_sense(tw_dev, request_id);\n\t\tbreak;\n\tcase MODE_SENSE:\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsi_queue(): caught MODE_SENSE.\\n\");\n\t\tretval = tw_scsiop_mode_sense(tw_dev, request_id);\n\t\tbreak;\n\tcase SYNCHRONIZE_CACHE:\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_scsi_queue(): caught SYNCHRONIZE_CACHE.\\n\");\n\t\tretval = tw_scsiop_synchronize_cache(tw_dev, request_id);\n\t\tbreak;\n\tcase TW_IOCTL:\n\t\tprintk(KERN_WARNING \"3w-xxxx: SCSI_IOCTL_SEND_COMMAND deprecated, please update your 3ware tools.\\n\");\n\t\tbreak;\n\tdefault:\n\t\tprintk(KERN_NOTICE \"3w-xxxx: scsi%d: Unknown scsi opcode: 0x%x\\n\", tw_dev->host->host_no, *command);\n\t\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\t\ttw_state_request_finish(tw_dev, request_id);\n\t\tscsi_build_sense(SCpnt, 1, ILLEGAL_REQUEST, 0x20, 0);\n\t\tdone(SCpnt);\n\t\tretval = 0;\n\t}\n\tif (retval) {\n\t\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\t\ttw_state_request_finish(tw_dev, request_id);\n\t\tSCpnt->result = (DID_ERROR << 16);\n\t\tdone(SCpnt);\n\t\tretval = 0;\n\t}\n\treturn retval;\n}  \n\nstatic DEF_SCSI_QCMD(tw_scsi_queue)\n\n \nstatic irqreturn_t tw_interrupt(int irq, void *dev_instance)\n{\n\tint request_id;\n\tu32 status_reg_value;\n\tTW_Device_Extension *tw_dev = (TW_Device_Extension *)dev_instance;\n\tTW_Response_Queue response_que;\n\tint error = 0, retval = 0;\n\tTW_Command *command_packet;\n\tint handled = 0;\n\n\t \n\tspin_lock(tw_dev->host->host_lock);\n\n\t \n\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\n\t \n\tif (!(status_reg_value & TW_STATUS_VALID_INTERRUPT))\n\t\tgoto tw_interrupt_bail;\n\n\thandled = 1;\n\n\t \n\tif (test_bit(TW_IN_RESET, &tw_dev->flags))\n\t\tgoto tw_interrupt_bail;\n\n\t \n\tif (tw_check_bits(status_reg_value)) {\n\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_interrupt(): Unexpected bits.\\n\");\n\t\tif (tw_decode_bits(tw_dev, status_reg_value, 1)) {\n\t\t\tTW_CLEAR_ALL_INTERRUPTS(tw_dev);\n\t\t\tgoto tw_interrupt_bail;\n\t\t}\n\t}\n\n\t \n\tif (status_reg_value & TW_STATUS_HOST_INTERRUPT) {\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): Received host interrupt.\\n\");\n\t\tTW_CLEAR_HOST_INTERRUPT(tw_dev);\n\t}\n\n\t \n\tif (status_reg_value & TW_STATUS_ATTENTION_INTERRUPT) {\n\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): Received attention interrupt.\\n\");\n\t\tTW_CLEAR_ATTENTION_INTERRUPT(tw_dev);\n\t\ttw_state_request_start(tw_dev, &request_id);\n\t\terror = tw_aen_read_queue(tw_dev, request_id);\n\t\tif (error) {\n\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Error reading aen queue.\\n\", tw_dev->host->host_no);\n\t\t\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\t\t\ttw_state_request_finish(tw_dev, request_id);\n\t\t}\n\t}\n\n\t \n\tif (status_reg_value & TW_STATUS_COMMAND_INTERRUPT) {\n\t\t \n\t\twhile (tw_dev->pending_request_count > 0) {\n\t\t\trequest_id = tw_dev->pending_queue[tw_dev->pending_head];\n\t\t\tif (tw_dev->state[request_id] != TW_S_PENDING) {\n\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Found request id that wasn't pending.\\n\", tw_dev->host->host_no);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (tw_post_command_packet(tw_dev, request_id)==0) {\n\t\t\t\tif (tw_dev->pending_head == TW_Q_LENGTH-1) {\n\t\t\t\t\ttw_dev->pending_head = TW_Q_START;\n\t\t\t\t} else {\n\t\t\t\t\ttw_dev->pending_head = tw_dev->pending_head + 1;\n\t\t\t\t}\n\t\t\t\ttw_dev->pending_request_count--;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\t \n\t\tif (tw_dev->pending_request_count == 0)\n\t\t\tTW_MASK_COMMAND_INTERRUPT(tw_dev);\n\t}\n\n\t \n\tif (status_reg_value & TW_STATUS_RESPONSE_INTERRUPT) {\n\t\t \n\t\twhile ((status_reg_value & TW_STATUS_RESPONSE_QUEUE_EMPTY) == 0) {\n\t\t\t \n\t\t\tresponse_que.value = inl(TW_RESPONSE_QUEUE_REG_ADDR(tw_dev));\n\t\t\trequest_id = TW_RESID_OUT(response_que.response_id);\n\t\t\tcommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\n\t\t\terror = 0;\n\n\t\t\t \n\t\t\tif (command_packet->status != 0) {\n\t\t\t\t \n\t\t\t\tif (tw_dev->srb[request_id] == NULL) {\n\t\t\t\t\ttw_decode_sense(tw_dev, request_id, 0);\n\t\t\t\t} else {\n\t\t\t\t\terror = tw_decode_sense(tw_dev, request_id, 1);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t \n\t\t\tif (tw_dev->state[request_id] != TW_S_POSTED) {\n\t\t\t\tif (tw_dev->srb[request_id] != NULL) {\n\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Received a request id that wasn't posted.\\n\", tw_dev->host->host_no);\n\t\t\t\t\terror = 1;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): Response queue request id: %d.\\n\", request_id);\n\n\t\t\t \n\t\t\tif (tw_dev->srb[request_id] == NULL) {\n\t\t\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_interrupt(): Found internally posted command.\\n\");\n\t\t\t\t \n\t\t\t\tif (request_id != tw_dev->chrdev_request_id) {\n\t\t\t\t\tretval = tw_aen_complete(tw_dev, request_id);\n\t\t\t\t\tif (retval) {\n\t\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Error completing aen.\\n\", tw_dev->host->host_no);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\ttw_dev->chrdev_request_id = TW_IOCTL_CHRDEV_FREE;\n\t\t\t\t\twake_up(&tw_dev->ioctl_wqueue);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tswitch (tw_dev->srb[request_id]->cmnd[0]) {\n\t\t\t\tcase READ_10:\n\t\t\t\tcase READ_6:\n\t\t\t\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): caught READ_10/READ_6\\n\");\n\t\t\t\t\tbreak;\n\t\t\t\tcase WRITE_10:\n\t\t\t\tcase WRITE_6:\n\t\t\t\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): caught WRITE_10/WRITE_6\\n\");\n\t\t\t\t\tbreak;\n\t\t\t\tcase TEST_UNIT_READY:\n\t\t\t\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): caught TEST_UNIT_READY\\n\");\n\t\t\t\t\terror = tw_scsiop_test_unit_ready_complete(tw_dev, request_id);\n\t\t\t\t\tbreak;\n\t\t\t\tcase INQUIRY:\n\t\t\t\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): caught INQUIRY\\n\");\n\t\t\t\t\terror = tw_scsiop_inquiry_complete(tw_dev, request_id);\n\t\t\t\t\tbreak;\n\t\t\t\tcase READ_CAPACITY:\n\t\t\t\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): caught READ_CAPACITY\\n\");\n\t\t\t\t\terror = tw_scsiop_read_capacity_complete(tw_dev, request_id);\n\t\t\t\t\tbreak;\n\t\t\t\tcase MODE_SENSE:\n\t\t\t\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): caught MODE_SENSE\\n\");\n\t\t\t\t\terror = tw_scsiop_mode_sense_complete(tw_dev, request_id);\n\t\t\t\t\tbreak;\n\t\t\t\tcase SYNCHRONIZE_CACHE:\n\t\t\t\t\tdprintk(KERN_NOTICE \"3w-xxxx: tw_interrupt(): caught SYNCHRONIZE_CACHE\\n\");\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tprintk(KERN_WARNING \"3w-xxxx: case slip in tw_interrupt()\\n\");\n\t\t\t\t\terror = 1;\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\tif (error == 0) {\n\t\t\t\t\ttw_dev->srb[request_id]->result = (DID_OK << 16);\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\tif (error == 1) {\n\t\t\t\t\t \n\t\t\t\t\ttw_dev->srb[request_id]->result = (DID_OK << 16) | SAM_STAT_CHECK_CONDITION;\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\tif ((error != TW_ISR_DONT_COMPLETE)) {\n\t\t\t\t\tscsi_dma_unmap(tw_dev->srb[request_id]);\n\t\t\t\t\tscsi_done(tw_dev->srb[request_id]);\n\t\t\t\t\ttw_dev->state[request_id] = TW_S_COMPLETED;\n\t\t\t\t\ttw_state_request_finish(tw_dev, request_id);\n\t\t\t\t\ttw_dev->posted_request_count--;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t \n\t\t\tstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\n\t\t\tif (tw_check_bits(status_reg_value)) {\n\t\t\t\tdprintk(KERN_WARNING \"3w-xxxx: tw_interrupt(): Unexpected bits.\\n\");\n\t\t\t\tif (tw_decode_bits(tw_dev, status_reg_value, 1)) {\n\t\t\t\t\tTW_CLEAR_ALL_INTERRUPTS(tw_dev);\n\t\t\t\t\tgoto tw_interrupt_bail;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\ntw_interrupt_bail:\n\tspin_unlock(tw_dev->host->host_lock);\n\treturn IRQ_RETVAL(handled);\n}  \n\n \nstatic void __tw_shutdown(TW_Device_Extension *tw_dev)\n{\n\t \n\tTW_DISABLE_INTERRUPTS(tw_dev);\n\n\t \n\tfree_irq(tw_dev->tw_pci_dev->irq, tw_dev);\n\n\tprintk(KERN_WARNING \"3w-xxxx: Shutting down host %d.\\n\", tw_dev->host->host_no);\n\n\t \n\tif (tw_initconnection(tw_dev, 1)) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Connection shutdown failed.\\n\");\n\t} else {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Shutdown complete.\\n\");\n\t}\n\n\t \n\tTW_ENABLE_AND_CLEAR_INTERRUPTS(tw_dev);\n}  \n\n \nstatic void tw_shutdown(struct pci_dev *pdev)\n{\n\tstruct Scsi_Host *host = pci_get_drvdata(pdev);\n\tTW_Device_Extension *tw_dev = (TW_Device_Extension *)host->hostdata;\n\n\t__tw_shutdown(tw_dev);\n}  \n\n \nstatic int tw_slave_configure(struct scsi_device *sdev)\n{\n\t \n\tblk_queue_rq_timeout(sdev->request_queue, 60 * HZ);\n\n\treturn 0;\n}  \n\nstatic const struct scsi_host_template driver_template = {\n\t.module\t\t\t= THIS_MODULE,\n\t.name\t\t\t= \"3ware Storage Controller\",\n\t.queuecommand\t\t= tw_scsi_queue,\n\t.eh_host_reset_handler\t= tw_scsi_eh_reset,\n\t.bios_param\t\t= tw_scsi_biosparam,\n\t.change_queue_depth\t= scsi_change_queue_depth,\n\t.can_queue\t\t= TW_Q_LENGTH-2,\n\t.slave_configure\t= tw_slave_configure,\n\t.this_id\t\t= -1,\n\t.sg_tablesize\t\t= TW_MAX_SGL_LENGTH,\n\t.max_sectors\t\t= TW_MAX_SECTORS,\n\t.cmd_per_lun\t\t= TW_MAX_CMDS_PER_LUN,\n\t.shost_groups\t\t= tw_host_groups,\n\t.emulated\t\t= 1,\n\t.no_write_same\t\t= 1,\n};\n\n \nstatic int tw_probe(struct pci_dev *pdev, const struct pci_device_id *dev_id)\n{\n\tstruct Scsi_Host *host = NULL;\n\tTW_Device_Extension *tw_dev;\n\tint retval;\n\n\tretval = pci_enable_device(pdev);\n\tif (retval) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Failed to enable pci device.\");\n\t\tgoto out_disable_device;\n\t}\n\n\tpci_set_master(pdev);\n\n\tretval = dma_set_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(32));\n\tif (retval) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Failed to set dma mask.\");\n\t\tgoto out_disable_device;\n\t}\n\n\thost = scsi_host_alloc(&driver_template, sizeof(TW_Device_Extension));\n\tif (!host) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Failed to allocate memory for device extension.\");\n\t\tretval = -ENOMEM;\n\t\tgoto out_disable_device;\n\t}\n\ttw_dev = (TW_Device_Extension *)host->hostdata;\n\n\t \n\ttw_dev->host = host;\n\ttw_dev->tw_pci_dev = pdev;\n\n\tif (tw_initialize_device_extension(tw_dev)) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Failed to initialize device extension.\");\n\t\tretval = -ENOMEM;\n\t\tgoto out_free_device_extension;\n\t}\n\n\t \n\tretval = pci_request_regions(pdev, \"3w-xxxx\");\n\tif (retval) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Failed to get mem region.\");\n\t\tgoto out_free_device_extension;\n\t}\n\n\t \n\ttw_dev->base_addr = pci_resource_start(pdev, 0);\n\tif (!tw_dev->base_addr) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Failed to get io address.\");\n\t\tretval = -ENOMEM;\n\t\tgoto out_release_mem_region;\n\t}\n\n\t \n\tTW_DISABLE_INTERRUPTS(tw_dev);\n\n\t \n\tif (tw_reset_sequence(tw_dev)) {\n\t\tretval = -EINVAL;\n\t\tgoto out_release_mem_region;\n\t}\n\n\t \n\thost->max_id = TW_MAX_UNITS;\n\thost->max_cmd_len = TW_MAX_CDB_LEN;\n\n\t \n\thost->max_lun = 0;\n\thost->max_channel = 0;\n\n\t \n\tretval = scsi_add_host(host, &pdev->dev);\n\tif (retval) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: scsi add host failed\");\n\t\tgoto out_release_mem_region;\n\t}\n\n\tpci_set_drvdata(pdev, host);\n\n\tprintk(KERN_WARNING \"3w-xxxx: scsi%d: Found a 3ware Storage Controller at 0x%x, IRQ: %d.\\n\", host->host_no, tw_dev->base_addr, pdev->irq);\n\n\t \n\tretval = request_irq(pdev->irq, tw_interrupt, IRQF_SHARED, \"3w-xxxx\", tw_dev);\n\tif (retval) {\n\t\tprintk(KERN_WARNING \"3w-xxxx: Error requesting IRQ.\");\n\t\tgoto out_remove_host;\n\t}\n\n\ttw_device_extension_list[tw_device_extension_count] = tw_dev;\n\ttw_device_extension_count++;\n\n\t \n\tTW_ENABLE_AND_CLEAR_INTERRUPTS(tw_dev);\n\n\t \n\tscsi_scan_host(host);\n\n\tif (twe_major == -1) {\n\t\tif ((twe_major = register_chrdev (0, \"twe\", &tw_fops)) < 0)\n\t\t\tprintk(KERN_WARNING \"3w-xxxx: Failed to register character device.\");\n\t}\n\treturn 0;\n\nout_remove_host:\n\tscsi_remove_host(host);\nout_release_mem_region:\n\tpci_release_regions(pdev);\nout_free_device_extension:\n\ttw_free_device_extension(tw_dev);\n\tscsi_host_put(host);\nout_disable_device:\n\tpci_disable_device(pdev);\n\n\treturn retval;\n}  \n\n \nstatic void tw_remove(struct pci_dev *pdev)\n{\n\tstruct Scsi_Host *host = pci_get_drvdata(pdev);\n\tTW_Device_Extension *tw_dev = (TW_Device_Extension *)host->hostdata;\n\n\tscsi_remove_host(tw_dev->host);\n\n\t \n\tif (twe_major >= 0) {\n\t\tunregister_chrdev(twe_major, \"twe\");\n\t\ttwe_major = -1;\n\t}\n\n\t \n\t__tw_shutdown(tw_dev);\n\n\t \n\tpci_release_regions(pdev);\n\n\t \n\ttw_free_device_extension(tw_dev);\n\n\tscsi_host_put(tw_dev->host);\n\tpci_disable_device(pdev);\n\ttw_device_extension_count--;\n}  \n\n \nstatic struct pci_device_id tw_pci_tbl[] = {\n\t{ PCI_VENDOR_ID_3WARE, PCI_DEVICE_ID_3WARE_1000,\n\t  PCI_ANY_ID, PCI_ANY_ID, 0, 0, 0},\n\t{ PCI_VENDOR_ID_3WARE, PCI_DEVICE_ID_3WARE_7000,\n\t  PCI_ANY_ID, PCI_ANY_ID, 0, 0, 0},\n\t{ }\n};\nMODULE_DEVICE_TABLE(pci, tw_pci_tbl);\n\n \nstatic struct pci_driver tw_driver = {\n\t.name\t\t= \"3w-xxxx\",\n\t.id_table\t= tw_pci_tbl,\n\t.probe\t\t= tw_probe,\n\t.remove\t\t= tw_remove,\n\t.shutdown\t= tw_shutdown,\n};\n\n \nstatic int __init tw_init(void)\n{\n\tprintk(KERN_WARNING \"3ware Storage Controller device driver for Linux v%s.\\n\", TW_DRIVER_VERSION);\n\n\treturn pci_register_driver(&tw_driver);\n}  \n\n \nstatic void __exit tw_exit(void)\n{\n\tpci_unregister_driver(&tw_driver);\n}  \n\nmodule_init(tw_init);\nmodule_exit(tw_exit);\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}