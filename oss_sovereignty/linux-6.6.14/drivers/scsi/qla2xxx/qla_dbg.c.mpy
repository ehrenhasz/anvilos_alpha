{
  "module_name": "qla_dbg.c",
  "hash_id": "38a39fdde9271d8e979ca7778c8d7b4b98c6920d1312271cf1a33fb9f61d1903",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/qla2xxx/qla_dbg.c",
  "human_readable_source": "\n \n\n \n\n#include \"qla_def.h\"\n\n#include <linux/delay.h>\n#define CREATE_TRACE_POINTS\n#include <trace/events/qla.h>\n\nstatic uint32_t ql_dbg_offset = 0x800;\n\nstatic inline void\nqla2xxx_prep_dump(struct qla_hw_data *ha, struct qla2xxx_fw_dump *fw_dump)\n{\n\tfw_dump->fw_major_version = htonl(ha->fw_major_version);\n\tfw_dump->fw_minor_version = htonl(ha->fw_minor_version);\n\tfw_dump->fw_subminor_version = htonl(ha->fw_subminor_version);\n\tfw_dump->fw_attributes = htonl(ha->fw_attributes);\n\n\tfw_dump->vendor = htonl(ha->pdev->vendor);\n\tfw_dump->device = htonl(ha->pdev->device);\n\tfw_dump->subsystem_vendor = htonl(ha->pdev->subsystem_vendor);\n\tfw_dump->subsystem_device = htonl(ha->pdev->subsystem_device);\n}\n\nstatic inline void *\nqla2xxx_copy_queues(struct qla_hw_data *ha, void *ptr)\n{\n\tstruct req_que *req = ha->req_q_map[0];\n\tstruct rsp_que *rsp = ha->rsp_q_map[0];\n\t \n\tmemcpy(ptr, req->ring, req->length *\n\t    sizeof(request_t));\n\n\t \n\tptr += req->length * sizeof(request_t);\n\tmemcpy(ptr, rsp->ring, rsp->length  *\n\t    sizeof(response_t));\n\n\treturn ptr + (rsp->length * sizeof(response_t));\n}\n\nint\nqla27xx_dump_mpi_ram(struct qla_hw_data *ha, uint32_t addr, uint32_t *ram,\n\tuint32_t ram_dwords, void **nxt)\n{\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\tdma_addr_t dump_dma = ha->gid_list_dma;\n\tuint32_t *chunk = (uint32_t *)ha->gid_list;\n\tuint32_t dwords = qla2x00_gid_list_size(ha) / 4;\n\tuint32_t stat;\n\tulong i, j, timer = 6000000;\n\tint rval = QLA_FUNCTION_FAILED;\n\tscsi_qla_host_t *vha = pci_get_drvdata(ha->pdev);\n\n\tclear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\n\n\tif (qla_pci_disconnected(vha, reg))\n\t\treturn rval;\n\n\tfor (i = 0; i < ram_dwords; i += dwords, addr += dwords) {\n\t\tif (i + dwords > ram_dwords)\n\t\t\tdwords = ram_dwords - i;\n\n\t\twrt_reg_word(&reg->mailbox0, MBC_LOAD_DUMP_MPI_RAM);\n\t\twrt_reg_word(&reg->mailbox1, LSW(addr));\n\t\twrt_reg_word(&reg->mailbox8, MSW(addr));\n\n\t\twrt_reg_word(&reg->mailbox2, MSW(LSD(dump_dma)));\n\t\twrt_reg_word(&reg->mailbox3, LSW(LSD(dump_dma)));\n\t\twrt_reg_word(&reg->mailbox6, MSW(MSD(dump_dma)));\n\t\twrt_reg_word(&reg->mailbox7, LSW(MSD(dump_dma)));\n\n\t\twrt_reg_word(&reg->mailbox4, MSW(dwords));\n\t\twrt_reg_word(&reg->mailbox5, LSW(dwords));\n\n\t\twrt_reg_word(&reg->mailbox9, 0);\n\t\twrt_reg_dword(&reg->hccr, HCCRX_SET_HOST_INT);\n\n\t\tha->flags.mbox_int = 0;\n\t\twhile (timer--) {\n\t\t\tudelay(5);\n\n\t\t\tif (qla_pci_disconnected(vha, reg))\n\t\t\t\treturn rval;\n\n\t\t\tstat = rd_reg_dword(&reg->host_status);\n\t\t\t \n\t\t\tif (!(stat & HSRX_RISC_INT))\n\t\t\t\tcontinue;\n\n\t\t\tstat &= 0xff;\n\t\t\tif (stat != 0x1 && stat != 0x2 &&\n\t\t\t    stat != 0x10 && stat != 0x11) {\n\n\t\t\t\t \n\t\t\t\twrt_reg_dword(&reg->hccr, HCCRX_CLR_RISC_INT);\n\t\t\t\trd_reg_dword(&reg->hccr);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tset_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\n\t\t\trval = rd_reg_word(&reg->mailbox0) & MBS_MASK;\n\t\t\twrt_reg_dword(&reg->hccr, HCCRX_CLR_RISC_INT);\n\t\t\trd_reg_dword(&reg->hccr);\n\t\t\tbreak;\n\t\t}\n\t\tha->flags.mbox_int = 1;\n\t\t*nxt = ram + i;\n\n\t\tif (!test_and_clear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags)) {\n\t\t\t \n\t\t\treturn rval;\n\t\t}\n\t\tif (rval) {\n\t\t\t \n\t\t\treturn rval;\n\t\t}\n\t\tfor (j = 0; j < dwords; j++) {\n\t\t\tram[i + j] =\n\t\t\t    (IS_QLA27XX(ha) || IS_QLA28XX(ha)) ?\n\t\t\t    chunk[j] : swab32(chunk[j]);\n\t\t}\n\t}\n\n\t*nxt = ram + i;\n\treturn QLA_SUCCESS;\n}\n\nint\nqla24xx_dump_ram(struct qla_hw_data *ha, uint32_t addr, __be32 *ram,\n\t\t uint32_t ram_dwords, void **nxt)\n{\n\tint rval = QLA_FUNCTION_FAILED;\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\tdma_addr_t dump_dma = ha->gid_list_dma;\n\tuint32_t *chunk = (uint32_t *)ha->gid_list;\n\tuint32_t dwords = qla2x00_gid_list_size(ha) / 4;\n\tuint32_t stat;\n\tulong i, j, timer = 6000000;\n\tscsi_qla_host_t *vha = pci_get_drvdata(ha->pdev);\n\n\tclear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\n\n\tif (qla_pci_disconnected(vha, reg))\n\t\treturn rval;\n\n\tfor (i = 0; i < ram_dwords; i += dwords, addr += dwords) {\n\t\tif (i + dwords > ram_dwords)\n\t\t\tdwords = ram_dwords - i;\n\n\t\twrt_reg_word(&reg->mailbox0, MBC_DUMP_RISC_RAM_EXTENDED);\n\t\twrt_reg_word(&reg->mailbox1, LSW(addr));\n\t\twrt_reg_word(&reg->mailbox8, MSW(addr));\n\t\twrt_reg_word(&reg->mailbox10, 0);\n\n\t\twrt_reg_word(&reg->mailbox2, MSW(LSD(dump_dma)));\n\t\twrt_reg_word(&reg->mailbox3, LSW(LSD(dump_dma)));\n\t\twrt_reg_word(&reg->mailbox6, MSW(MSD(dump_dma)));\n\t\twrt_reg_word(&reg->mailbox7, LSW(MSD(dump_dma)));\n\n\t\twrt_reg_word(&reg->mailbox4, MSW(dwords));\n\t\twrt_reg_word(&reg->mailbox5, LSW(dwords));\n\t\twrt_reg_dword(&reg->hccr, HCCRX_SET_HOST_INT);\n\n\t\tha->flags.mbox_int = 0;\n\t\twhile (timer--) {\n\t\t\tudelay(5);\n\t\t\tif (qla_pci_disconnected(vha, reg))\n\t\t\t\treturn rval;\n\n\t\t\tstat = rd_reg_dword(&reg->host_status);\n\t\t\t \n\t\t\tif (!(stat & HSRX_RISC_INT))\n\t\t\t\tcontinue;\n\n\t\t\tstat &= 0xff;\n\t\t\tif (stat != 0x1 && stat != 0x2 &&\n\t\t\t    stat != 0x10 && stat != 0x11) {\n\t\t\t\twrt_reg_dword(&reg->hccr, HCCRX_CLR_RISC_INT);\n\t\t\t\trd_reg_dword(&reg->hccr);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tset_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\n\t\t\trval = rd_reg_word(&reg->mailbox0) & MBS_MASK;\n\t\t\twrt_reg_dword(&reg->hccr, HCCRX_CLR_RISC_INT);\n\t\t\trd_reg_dword(&reg->hccr);\n\t\t\tbreak;\n\t\t}\n\t\tha->flags.mbox_int = 1;\n\t\t*nxt = ram + i;\n\n\t\tif (!test_and_clear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags)) {\n\t\t\t \n\t\t\treturn rval;\n\t\t}\n\t\tif (rval) {\n\t\t\t \n\t\t\treturn rval;\n\t\t}\n\t\tfor (j = 0; j < dwords; j++) {\n\t\t\tram[i + j] = (__force __be32)\n\t\t\t\t((IS_QLA27XX(ha) || IS_QLA28XX(ha)) ?\n\t\t\t\t chunk[j] : swab32(chunk[j]));\n\t\t}\n\t}\n\n\t*nxt = ram + i;\n\treturn QLA_SUCCESS;\n}\n\nstatic int\nqla24xx_dump_memory(struct qla_hw_data *ha, __be32 *code_ram,\n\t\t    uint32_t cram_size, void **nxt)\n{\n\tint rval;\n\n\t \n\trval = qla24xx_dump_ram(ha, 0x20000, code_ram, cram_size / 4, nxt);\n\tif (rval != QLA_SUCCESS)\n\t\treturn rval;\n\n\tset_bit(RISC_SRAM_DUMP_CMPL, &ha->fw_dump_cap_flags);\n\n\t \n\trval = qla24xx_dump_ram(ha, 0x100000, *nxt,\n\t    ha->fw_memory_size - 0x100000 + 1, nxt);\n\tif (rval == QLA_SUCCESS)\n\t\tset_bit(RISC_EXT_MEM_DUMP_CMPL, &ha->fw_dump_cap_flags);\n\n\treturn rval;\n}\n\nstatic __be32 *\nqla24xx_read_window(struct device_reg_24xx __iomem *reg, uint32_t iobase,\n\t\t    uint32_t count, __be32 *buf)\n{\n\t__le32 __iomem *dmp_reg;\n\n\twrt_reg_dword(&reg->iobase_addr, iobase);\n\tdmp_reg = &reg->iobase_window;\n\tfor ( ; count--; dmp_reg++)\n\t\t*buf++ = htonl(rd_reg_dword(dmp_reg));\n\n\treturn buf;\n}\n\nvoid\nqla24xx_pause_risc(struct device_reg_24xx __iomem *reg, struct qla_hw_data *ha)\n{\n\twrt_reg_dword(&reg->hccr, HCCRX_SET_RISC_PAUSE);\n\n\t \n\tudelay(100);\n\tif (rd_reg_dword(&reg->host_status) & HSRX_RISC_PAUSED)\n\t\tset_bit(RISC_PAUSE_CMPL, &ha->fw_dump_cap_flags);\n}\n\nint\nqla24xx_soft_reset(struct qla_hw_data *ha)\n{\n\tint rval = QLA_SUCCESS;\n\tuint32_t cnt;\n\tuint16_t wd;\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\n\t \n\twrt_reg_dword(&reg->ctrl_status, CSRX_DMA_SHUTDOWN|MWB_4096_BYTES);\n\tfor (cnt = 0; cnt < 30000; cnt++) {\n\t\tif ((rd_reg_dword(&reg->ctrl_status) & CSRX_DMA_ACTIVE) == 0)\n\t\t\tbreak;\n\n\t\tudelay(10);\n\t}\n\tif (!(rd_reg_dword(&reg->ctrl_status) & CSRX_DMA_ACTIVE))\n\t\tset_bit(DMA_SHUTDOWN_CMPL, &ha->fw_dump_cap_flags);\n\n\twrt_reg_dword(&reg->ctrl_status,\n\t    CSRX_ISP_SOFT_RESET|CSRX_DMA_SHUTDOWN|MWB_4096_BYTES);\n\tpci_read_config_word(ha->pdev, PCI_COMMAND, &wd);\n\n\tudelay(100);\n\n\t \n\tfor (cnt = 0; cnt < 30000; cnt++) {\n\t\tif ((rd_reg_dword(&reg->ctrl_status) &\n\t\t    CSRX_ISP_SOFT_RESET) == 0)\n\t\t\tbreak;\n\n\t\tudelay(10);\n\t}\n\tif (!(rd_reg_dword(&reg->ctrl_status) & CSRX_ISP_SOFT_RESET))\n\t\tset_bit(ISP_RESET_CMPL, &ha->fw_dump_cap_flags);\n\n\twrt_reg_dword(&reg->hccr, HCCRX_CLR_RISC_RESET);\n\trd_reg_dword(&reg->hccr);              \n\n\tfor (cnt = 10000; rd_reg_word(&reg->mailbox0) != 0 &&\n\t    rval == QLA_SUCCESS; cnt--) {\n\t\tif (cnt)\n\t\t\tudelay(10);\n\t\telse\n\t\t\trval = QLA_FUNCTION_TIMEOUT;\n\t}\n\tif (rval == QLA_SUCCESS)\n\t\tset_bit(RISC_RDY_AFT_RESET, &ha->fw_dump_cap_flags);\n\n\treturn rval;\n}\n\nstatic int\nqla2xxx_dump_ram(struct qla_hw_data *ha, uint32_t addr, __be16 *ram,\n    uint32_t ram_words, void **nxt)\n{\n\tint rval;\n\tuint32_t cnt, stat, timer, words, idx;\n\tuint16_t mb0;\n\tstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\n\tdma_addr_t dump_dma = ha->gid_list_dma;\n\t__le16 *dump = (__force __le16 *)ha->gid_list;\n\n\trval = QLA_SUCCESS;\n\tmb0 = 0;\n\n\tWRT_MAILBOX_REG(ha, reg, 0, MBC_DUMP_RISC_RAM_EXTENDED);\n\tclear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\n\n\twords = qla2x00_gid_list_size(ha) / 2;\n\tfor (cnt = 0; cnt < ram_words && rval == QLA_SUCCESS;\n\t    cnt += words, addr += words) {\n\t\tif (cnt + words > ram_words)\n\t\t\twords = ram_words - cnt;\n\n\t\tWRT_MAILBOX_REG(ha, reg, 1, LSW(addr));\n\t\tWRT_MAILBOX_REG(ha, reg, 8, MSW(addr));\n\n\t\tWRT_MAILBOX_REG(ha, reg, 2, MSW(dump_dma));\n\t\tWRT_MAILBOX_REG(ha, reg, 3, LSW(dump_dma));\n\t\tWRT_MAILBOX_REG(ha, reg, 6, MSW(MSD(dump_dma)));\n\t\tWRT_MAILBOX_REG(ha, reg, 7, LSW(MSD(dump_dma)));\n\n\t\tWRT_MAILBOX_REG(ha, reg, 4, words);\n\t\twrt_reg_word(&reg->hccr, HCCR_SET_HOST_INT);\n\n\t\tfor (timer = 6000000; timer; timer--) {\n\t\t\t \n\t\t\tstat = rd_reg_dword(&reg->u.isp2300.host_status);\n\t\t\tif (stat & HSR_RISC_INT) {\n\t\t\t\tstat &= 0xff;\n\n\t\t\t\tif (stat == 0x1 || stat == 0x2) {\n\t\t\t\t\tset_bit(MBX_INTERRUPT,\n\t\t\t\t\t    &ha->mbx_cmd_flags);\n\n\t\t\t\t\tmb0 = RD_MAILBOX_REG(ha, reg, 0);\n\n\t\t\t\t\t \n\t\t\t\t\twrt_reg_word(&reg->semaphore, 0);\n\t\t\t\t\twrt_reg_word(&reg->hccr,\n\t\t\t\t\t    HCCR_CLR_RISC_INT);\n\t\t\t\t\trd_reg_word(&reg->hccr);\n\t\t\t\t\tbreak;\n\t\t\t\t} else if (stat == 0x10 || stat == 0x11) {\n\t\t\t\t\tset_bit(MBX_INTERRUPT,\n\t\t\t\t\t    &ha->mbx_cmd_flags);\n\n\t\t\t\t\tmb0 = RD_MAILBOX_REG(ha, reg, 0);\n\n\t\t\t\t\twrt_reg_word(&reg->hccr,\n\t\t\t\t\t    HCCR_CLR_RISC_INT);\n\t\t\t\t\trd_reg_word(&reg->hccr);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\twrt_reg_word(&reg->hccr, HCCR_CLR_RISC_INT);\n\t\t\t\trd_reg_word(&reg->hccr);\n\t\t\t}\n\t\t\tudelay(5);\n\t\t}\n\n\t\tif (test_and_clear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags)) {\n\t\t\trval = mb0 & MBS_MASK;\n\t\t\tfor (idx = 0; idx < words; idx++)\n\t\t\t\tram[cnt + idx] =\n\t\t\t\t\tcpu_to_be16(le16_to_cpu(dump[idx]));\n\t\t} else {\n\t\t\trval = QLA_FUNCTION_FAILED;\n\t\t}\n\t}\n\n\t*nxt = rval == QLA_SUCCESS ? &ram[cnt] : NULL;\n\treturn rval;\n}\n\nstatic inline void\nqla2xxx_read_window(struct device_reg_2xxx __iomem *reg, uint32_t count,\n\t\t    __be16 *buf)\n{\n\t__le16 __iomem *dmp_reg = &reg->u.isp2300.fb_cmd;\n\n\tfor ( ; count--; dmp_reg++)\n\t\t*buf++ = htons(rd_reg_word(dmp_reg));\n}\n\nstatic inline void *\nqla24xx_copy_eft(struct qla_hw_data *ha, void *ptr)\n{\n\tif (!ha->eft)\n\t\treturn ptr;\n\n\tmemcpy(ptr, ha->eft, ntohl(ha->fw_dump->eft_size));\n\treturn ptr + ntohl(ha->fw_dump->eft_size);\n}\n\nstatic inline void *\nqla25xx_copy_fce(struct qla_hw_data *ha, void *ptr, __be32 **last_chain)\n{\n\tuint32_t cnt;\n\t__be32 *iter_reg;\n\tstruct qla2xxx_fce_chain *fcec = ptr;\n\n\tif (!ha->fce)\n\t\treturn ptr;\n\n\t*last_chain = &fcec->type;\n\tfcec->type = htonl(DUMP_CHAIN_FCE);\n\tfcec->chain_size = htonl(sizeof(struct qla2xxx_fce_chain) +\n\t    fce_calc_size(ha->fce_bufs));\n\tfcec->size = htonl(fce_calc_size(ha->fce_bufs));\n\tfcec->addr_l = htonl(LSD(ha->fce_dma));\n\tfcec->addr_h = htonl(MSD(ha->fce_dma));\n\n\titer_reg = fcec->eregs;\n\tfor (cnt = 0; cnt < 8; cnt++)\n\t\t*iter_reg++ = htonl(ha->fce_mb[cnt]);\n\n\tmemcpy(iter_reg, ha->fce, ntohl(fcec->size));\n\n\treturn (char *)iter_reg + ntohl(fcec->size);\n}\n\nstatic inline void *\nqla25xx_copy_exlogin(struct qla_hw_data *ha, void *ptr, __be32 **last_chain)\n{\n\tstruct qla2xxx_offld_chain *c = ptr;\n\n\tif (!ha->exlogin_buf)\n\t\treturn ptr;\n\n\t*last_chain = &c->type;\n\n\tc->type = cpu_to_be32(DUMP_CHAIN_EXLOGIN);\n\tc->chain_size = cpu_to_be32(sizeof(struct qla2xxx_offld_chain) +\n\t    ha->exlogin_size);\n\tc->size = cpu_to_be32(ha->exlogin_size);\n\tc->addr = cpu_to_be64(ha->exlogin_buf_dma);\n\n\tptr += sizeof(struct qla2xxx_offld_chain);\n\tmemcpy(ptr, ha->exlogin_buf, ha->exlogin_size);\n\n\treturn (char *)ptr + be32_to_cpu(c->size);\n}\n\nstatic inline void *\nqla81xx_copy_exchoffld(struct qla_hw_data *ha, void *ptr, __be32 **last_chain)\n{\n\tstruct qla2xxx_offld_chain *c = ptr;\n\n\tif (!ha->exchoffld_buf)\n\t\treturn ptr;\n\n\t*last_chain = &c->type;\n\n\tc->type = cpu_to_be32(DUMP_CHAIN_EXCHG);\n\tc->chain_size = cpu_to_be32(sizeof(struct qla2xxx_offld_chain) +\n\t    ha->exchoffld_size);\n\tc->size = cpu_to_be32(ha->exchoffld_size);\n\tc->addr = cpu_to_be64(ha->exchoffld_buf_dma);\n\n\tptr += sizeof(struct qla2xxx_offld_chain);\n\tmemcpy(ptr, ha->exchoffld_buf, ha->exchoffld_size);\n\n\treturn (char *)ptr + be32_to_cpu(c->size);\n}\n\nstatic inline void *\nqla2xxx_copy_atioqueues(struct qla_hw_data *ha, void *ptr,\n\t\t\t__be32 **last_chain)\n{\n\tstruct qla2xxx_mqueue_chain *q;\n\tstruct qla2xxx_mqueue_header *qh;\n\tuint32_t num_queues;\n\tint que;\n\tstruct {\n\t\tint length;\n\t\tvoid *ring;\n\t} aq, *aqp;\n\n\tif (!ha->tgt.atio_ring)\n\t\treturn ptr;\n\n\tnum_queues = 1;\n\taqp = &aq;\n\taqp->length = ha->tgt.atio_q_length;\n\taqp->ring = ha->tgt.atio_ring;\n\n\tfor (que = 0; que < num_queues; que++) {\n\t\t \n\t\tq = ptr;\n\t\t*last_chain = &q->type;\n\t\tq->type = htonl(DUMP_CHAIN_QUEUE);\n\t\tq->chain_size = htonl(\n\t\t    sizeof(struct qla2xxx_mqueue_chain) +\n\t\t    sizeof(struct qla2xxx_mqueue_header) +\n\t\t    (aqp->length * sizeof(request_t)));\n\t\tptr += sizeof(struct qla2xxx_mqueue_chain);\n\n\t\t \n\t\tqh = ptr;\n\t\tqh->queue = htonl(TYPE_ATIO_QUEUE);\n\t\tqh->number = htonl(que);\n\t\tqh->size = htonl(aqp->length * sizeof(request_t));\n\t\tptr += sizeof(struct qla2xxx_mqueue_header);\n\n\t\t \n\t\tmemcpy(ptr, aqp->ring, aqp->length * sizeof(request_t));\n\n\t\tptr += aqp->length * sizeof(request_t);\n\t}\n\n\treturn ptr;\n}\n\nstatic inline void *\nqla25xx_copy_mqueues(struct qla_hw_data *ha, void *ptr, __be32 **last_chain)\n{\n\tstruct qla2xxx_mqueue_chain *q;\n\tstruct qla2xxx_mqueue_header *qh;\n\tstruct req_que *req;\n\tstruct rsp_que *rsp;\n\tint que;\n\n\tif (!ha->mqenable)\n\t\treturn ptr;\n\n\t \n\tfor (que = 1; que < ha->max_req_queues; que++) {\n\t\treq = ha->req_q_map[que];\n\t\tif (!req)\n\t\t\tbreak;\n\n\t\t \n\t\tq = ptr;\n\t\t*last_chain = &q->type;\n\t\tq->type = htonl(DUMP_CHAIN_QUEUE);\n\t\tq->chain_size = htonl(\n\t\t    sizeof(struct qla2xxx_mqueue_chain) +\n\t\t    sizeof(struct qla2xxx_mqueue_header) +\n\t\t    (req->length * sizeof(request_t)));\n\t\tptr += sizeof(struct qla2xxx_mqueue_chain);\n\n\t\t \n\t\tqh = ptr;\n\t\tqh->queue = htonl(TYPE_REQUEST_QUEUE);\n\t\tqh->number = htonl(que);\n\t\tqh->size = htonl(req->length * sizeof(request_t));\n\t\tptr += sizeof(struct qla2xxx_mqueue_header);\n\n\t\t \n\t\tmemcpy(ptr, req->ring, req->length * sizeof(request_t));\n\t\tptr += req->length * sizeof(request_t);\n\t}\n\n\t \n\tfor (que = 1; que < ha->max_rsp_queues; que++) {\n\t\trsp = ha->rsp_q_map[que];\n\t\tif (!rsp)\n\t\t\tbreak;\n\n\t\t \n\t\tq = ptr;\n\t\t*last_chain = &q->type;\n\t\tq->type = htonl(DUMP_CHAIN_QUEUE);\n\t\tq->chain_size = htonl(\n\t\t    sizeof(struct qla2xxx_mqueue_chain) +\n\t\t    sizeof(struct qla2xxx_mqueue_header) +\n\t\t    (rsp->length * sizeof(response_t)));\n\t\tptr += sizeof(struct qla2xxx_mqueue_chain);\n\n\t\t \n\t\tqh = ptr;\n\t\tqh->queue = htonl(TYPE_RESPONSE_QUEUE);\n\t\tqh->number = htonl(que);\n\t\tqh->size = htonl(rsp->length * sizeof(response_t));\n\t\tptr += sizeof(struct qla2xxx_mqueue_header);\n\n\t\t \n\t\tmemcpy(ptr, rsp->ring, rsp->length * sizeof(response_t));\n\t\tptr += rsp->length * sizeof(response_t);\n\t}\n\n\treturn ptr;\n}\n\nstatic inline void *\nqla25xx_copy_mq(struct qla_hw_data *ha, void *ptr, __be32 **last_chain)\n{\n\tuint32_t cnt, que_idx;\n\tuint8_t que_cnt;\n\tstruct qla2xxx_mq_chain *mq = ptr;\n\tdevice_reg_t *reg;\n\n\tif (!ha->mqenable || IS_QLA83XX(ha) || IS_QLA27XX(ha) ||\n\t    IS_QLA28XX(ha))\n\t\treturn ptr;\n\n\tmq = ptr;\n\t*last_chain = &mq->type;\n\tmq->type = htonl(DUMP_CHAIN_MQ);\n\tmq->chain_size = htonl(sizeof(struct qla2xxx_mq_chain));\n\n\tque_cnt = ha->max_req_queues > ha->max_rsp_queues ?\n\t\tha->max_req_queues : ha->max_rsp_queues;\n\tmq->count = htonl(que_cnt);\n\tfor (cnt = 0; cnt < que_cnt; cnt++) {\n\t\treg = ISP_QUE_REG(ha, cnt);\n\t\tque_idx = cnt * 4;\n\t\tmq->qregs[que_idx] =\n\t\t    htonl(rd_reg_dword(&reg->isp25mq.req_q_in));\n\t\tmq->qregs[que_idx+1] =\n\t\t    htonl(rd_reg_dword(&reg->isp25mq.req_q_out));\n\t\tmq->qregs[que_idx+2] =\n\t\t    htonl(rd_reg_dword(&reg->isp25mq.rsp_q_in));\n\t\tmq->qregs[que_idx+3] =\n\t\t    htonl(rd_reg_dword(&reg->isp25mq.rsp_q_out));\n\t}\n\n\treturn ptr + sizeof(struct qla2xxx_mq_chain);\n}\n\nvoid\nqla2xxx_dump_post_process(scsi_qla_host_t *vha, int rval)\n{\n\tstruct qla_hw_data *ha = vha->hw;\n\n\tif (rval != QLA_SUCCESS) {\n\t\tql_log(ql_log_warn, vha, 0xd000,\n\t\t    \"Failed to dump firmware (%x), dump status flags (0x%lx).\\n\",\n\t\t    rval, ha->fw_dump_cap_flags);\n\t\tha->fw_dumped = false;\n\t} else {\n\t\tql_log(ql_log_info, vha, 0xd001,\n\t\t    \"Firmware dump saved to temp buffer (%ld/%p), dump status flags (0x%lx).\\n\",\n\t\t    vha->host_no, ha->fw_dump, ha->fw_dump_cap_flags);\n\t\tha->fw_dumped = true;\n\t\tqla2x00_post_uevent_work(vha, QLA_UEVENT_CODE_FW_DUMP);\n\t}\n}\n\nvoid qla2xxx_dump_fw(scsi_qla_host_t *vha)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&vha->hw->hardware_lock, flags);\n\tvha->hw->isp_ops->fw_dump(vha);\n\tspin_unlock_irqrestore(&vha->hw->hardware_lock, flags);\n}\n\n \nvoid\nqla2300_fw_dump(scsi_qla_host_t *vha)\n{\n\tint\t\trval;\n\tuint32_t\tcnt;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\n\t__le16 __iomem *dmp_reg;\n\tstruct qla2300_fw_dump\t*fw;\n\tvoid\t\t*nxt;\n\tstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\n\n\tlockdep_assert_held(&ha->hardware_lock);\n\n\tif (!ha->fw_dump) {\n\t\tql_log(ql_log_warn, vha, 0xd002,\n\t\t    \"No buffer available for dump.\\n\");\n\t\treturn;\n\t}\n\n\tif (ha->fw_dumped) {\n\t\tql_log(ql_log_warn, vha, 0xd003,\n\t\t    \"Firmware has been previously dumped (%p) \"\n\t\t    \"-- ignoring request.\\n\",\n\t\t    ha->fw_dump);\n\t\treturn;\n\t}\n\tfw = &ha->fw_dump->isp.isp23;\n\tqla2xxx_prep_dump(ha, ha->fw_dump);\n\n\trval = QLA_SUCCESS;\n\tfw->hccr = htons(rd_reg_word(&reg->hccr));\n\n\t \n\twrt_reg_word(&reg->hccr, HCCR_PAUSE_RISC);\n\tif (IS_QLA2300(ha)) {\n\t\tfor (cnt = 30000;\n\t\t    (rd_reg_word(&reg->hccr) & HCCR_RISC_PAUSE) == 0 &&\n\t\t\trval == QLA_SUCCESS; cnt--) {\n\t\t\tif (cnt)\n\t\t\t\tudelay(100);\n\t\t\telse\n\t\t\t\trval = QLA_FUNCTION_TIMEOUT;\n\t\t}\n\t} else {\n\t\trd_reg_word(&reg->hccr);\t\t \n\t\tudelay(10);\n\t}\n\n\tif (rval == QLA_SUCCESS) {\n\t\tdmp_reg = &reg->flash_address;\n\t\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->pbiu_reg); cnt++, dmp_reg++)\n\t\t\tfw->pbiu_reg[cnt] = htons(rd_reg_word(dmp_reg));\n\n\t\tdmp_reg = &reg->u.isp2300.req_q_in;\n\t\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->risc_host_reg);\n\t\t    cnt++, dmp_reg++)\n\t\t\tfw->risc_host_reg[cnt] = htons(rd_reg_word(dmp_reg));\n\n\t\tdmp_reg = &reg->u.isp2300.mailbox0;\n\t\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->mailbox_reg);\n\t\t    cnt++, dmp_reg++)\n\t\t\tfw->mailbox_reg[cnt] = htons(rd_reg_word(dmp_reg));\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x40);\n\t\tqla2xxx_read_window(reg, 32, fw->resp_dma_reg);\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x50);\n\t\tqla2xxx_read_window(reg, 48, fw->dma_reg);\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x00);\n\t\tdmp_reg = &reg->risc_hw;\n\t\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->risc_hdw_reg);\n\t\t    cnt++, dmp_reg++)\n\t\t\tfw->risc_hdw_reg[cnt] = htons(rd_reg_word(dmp_reg));\n\n\t\twrt_reg_word(&reg->pcr, 0x2000);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp0_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2200);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp1_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2400);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp2_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2600);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp3_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2800);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp4_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2A00);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp5_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2C00);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp6_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2E00);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp7_reg);\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x10);\n\t\tqla2xxx_read_window(reg, 64, fw->frame_buf_hdw_reg);\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x20);\n\t\tqla2xxx_read_window(reg, 64, fw->fpm_b0_reg);\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x30);\n\t\tqla2xxx_read_window(reg, 64, fw->fpm_b1_reg);\n\n\t\t \n\t\twrt_reg_word(&reg->ctrl_status, CSR_ISP_SOFT_RESET);\n\t\tfor (cnt = 0; cnt < 30000; cnt++) {\n\t\t\tif ((rd_reg_word(&reg->ctrl_status) &\n\t\t\t    CSR_ISP_SOFT_RESET) == 0)\n\t\t\t\tbreak;\n\n\t\t\tudelay(10);\n\t\t}\n\t}\n\n\tif (!IS_QLA2300(ha)) {\n\t\tfor (cnt = 30000; RD_MAILBOX_REG(ha, reg, 0) != 0 &&\n\t\t    rval == QLA_SUCCESS; cnt--) {\n\t\t\tif (cnt)\n\t\t\t\tudelay(100);\n\t\t\telse\n\t\t\t\trval = QLA_FUNCTION_TIMEOUT;\n\t\t}\n\t}\n\n\t \n\tif (rval == QLA_SUCCESS)\n\t\trval = qla2xxx_dump_ram(ha, 0x800, fw->risc_ram,\n\t\t\t\t\tARRAY_SIZE(fw->risc_ram), &nxt);\n\n\t \n\tif (rval == QLA_SUCCESS)\n\t\trval = qla2xxx_dump_ram(ha, 0x10000, fw->stack_ram,\n\t\t\t\t\tARRAY_SIZE(fw->stack_ram), &nxt);\n\n\t \n\tif (rval == QLA_SUCCESS)\n\t\trval = qla2xxx_dump_ram(ha, 0x11000, fw->data_ram,\n\t\t    ha->fw_memory_size - 0x11000 + 1, &nxt);\n\n\tif (rval == QLA_SUCCESS)\n\t\tqla2xxx_copy_queues(ha, nxt);\n\n\tqla2xxx_dump_post_process(base_vha, rval);\n}\n\n \nvoid\nqla2100_fw_dump(scsi_qla_host_t *vha)\n{\n\tint\t\trval;\n\tuint32_t\tcnt, timer;\n\tuint16_t\trisc_address = 0;\n\tuint16_t\tmb0 = 0, mb2 = 0;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\n\t__le16 __iomem *dmp_reg;\n\tstruct qla2100_fw_dump\t*fw;\n\tstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\n\n\tlockdep_assert_held(&ha->hardware_lock);\n\n\tif (!ha->fw_dump) {\n\t\tql_log(ql_log_warn, vha, 0xd004,\n\t\t    \"No buffer available for dump.\\n\");\n\t\treturn;\n\t}\n\n\tif (ha->fw_dumped) {\n\t\tql_log(ql_log_warn, vha, 0xd005,\n\t\t    \"Firmware has been previously dumped (%p) \"\n\t\t    \"-- ignoring request.\\n\",\n\t\t    ha->fw_dump);\n\t\treturn;\n\t}\n\tfw = &ha->fw_dump->isp.isp21;\n\tqla2xxx_prep_dump(ha, ha->fw_dump);\n\n\trval = QLA_SUCCESS;\n\tfw->hccr = htons(rd_reg_word(&reg->hccr));\n\n\t \n\twrt_reg_word(&reg->hccr, HCCR_PAUSE_RISC);\n\tfor (cnt = 30000; (rd_reg_word(&reg->hccr) & HCCR_RISC_PAUSE) == 0 &&\n\t    rval == QLA_SUCCESS; cnt--) {\n\t\tif (cnt)\n\t\t\tudelay(100);\n\t\telse\n\t\t\trval = QLA_FUNCTION_TIMEOUT;\n\t}\n\tif (rval == QLA_SUCCESS) {\n\t\tdmp_reg = &reg->flash_address;\n\t\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->pbiu_reg); cnt++, dmp_reg++)\n\t\t\tfw->pbiu_reg[cnt] = htons(rd_reg_word(dmp_reg));\n\n\t\tdmp_reg = &reg->u.isp2100.mailbox0;\n\t\tfor (cnt = 0; cnt < ha->mbx_count; cnt++, dmp_reg++) {\n\t\t\tif (cnt == 8)\n\t\t\t\tdmp_reg = &reg->u_end.isp2200.mailbox8;\n\n\t\t\tfw->mailbox_reg[cnt] = htons(rd_reg_word(dmp_reg));\n\t\t}\n\n\t\tdmp_reg = &reg->u.isp2100.unused_2[0];\n\t\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->dma_reg); cnt++, dmp_reg++)\n\t\t\tfw->dma_reg[cnt] = htons(rd_reg_word(dmp_reg));\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x00);\n\t\tdmp_reg = &reg->risc_hw;\n\t\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->risc_hdw_reg); cnt++, dmp_reg++)\n\t\t\tfw->risc_hdw_reg[cnt] = htons(rd_reg_word(dmp_reg));\n\n\t\twrt_reg_word(&reg->pcr, 0x2000);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp0_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2100);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp1_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2200);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp2_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2300);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp3_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2400);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp4_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2500);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp5_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2600);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp6_reg);\n\n\t\twrt_reg_word(&reg->pcr, 0x2700);\n\t\tqla2xxx_read_window(reg, 16, fw->risc_gp7_reg);\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x10);\n\t\tqla2xxx_read_window(reg, 16, fw->frame_buf_hdw_reg);\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x20);\n\t\tqla2xxx_read_window(reg, 64, fw->fpm_b0_reg);\n\n\t\twrt_reg_word(&reg->ctrl_status, 0x30);\n\t\tqla2xxx_read_window(reg, 64, fw->fpm_b1_reg);\n\n\t\t \n\t\twrt_reg_word(&reg->ctrl_status, CSR_ISP_SOFT_RESET);\n\t}\n\n\tfor (cnt = 30000; RD_MAILBOX_REG(ha, reg, 0) != 0 &&\n\t    rval == QLA_SUCCESS; cnt--) {\n\t\tif (cnt)\n\t\t\tudelay(100);\n\t\telse\n\t\t\trval = QLA_FUNCTION_TIMEOUT;\n\t}\n\n\t \n\tif (rval == QLA_SUCCESS && (IS_QLA2200(ha) || (IS_QLA2100(ha) &&\n\t    (rd_reg_word(&reg->mctr) & (BIT_1 | BIT_0)) != 0))) {\n\n\t\twrt_reg_word(&reg->hccr, HCCR_PAUSE_RISC);\n\t\tfor (cnt = 30000;\n\t\t    (rd_reg_word(&reg->hccr) & HCCR_RISC_PAUSE) == 0 &&\n\t\t    rval == QLA_SUCCESS; cnt--) {\n\t\t\tif (cnt)\n\t\t\t\tudelay(100);\n\t\t\telse\n\t\t\t\trval = QLA_FUNCTION_TIMEOUT;\n\t\t}\n\t\tif (rval == QLA_SUCCESS) {\n\t\t\t \n\t\t\tif (IS_QLA2100(ha))\n\t\t\t\twrt_reg_word(&reg->mctr, 0xf1);\n\t\t\telse\n\t\t\t\twrt_reg_word(&reg->mctr, 0xf2);\n\t\t\trd_reg_word(&reg->mctr);\t \n\n\t\t\t \n\t\t\twrt_reg_word(&reg->hccr, HCCR_RELEASE_RISC);\n\t\t}\n\t}\n\n\tif (rval == QLA_SUCCESS) {\n\t\t \n\t\trisc_address = 0x1000;\n \t\tWRT_MAILBOX_REG(ha, reg, 0, MBC_READ_RAM_WORD);\n\t\tclear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\n\t}\n\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->risc_ram) && rval == QLA_SUCCESS;\n\t    cnt++, risc_address++) {\n \t\tWRT_MAILBOX_REG(ha, reg, 1, risc_address);\n\t\twrt_reg_word(&reg->hccr, HCCR_SET_HOST_INT);\n\n\t\tfor (timer = 6000000; timer != 0; timer--) {\n\t\t\t \n\t\t\tif (rd_reg_word(&reg->istatus) & ISR_RISC_INT) {\n\t\t\t\tif (rd_reg_word(&reg->semaphore) & BIT_0) {\n\t\t\t\t\tset_bit(MBX_INTERRUPT,\n\t\t\t\t\t    &ha->mbx_cmd_flags);\n\n\t\t\t\t\tmb0 = RD_MAILBOX_REG(ha, reg, 0);\n\t\t\t\t\tmb2 = RD_MAILBOX_REG(ha, reg, 2);\n\n\t\t\t\t\twrt_reg_word(&reg->semaphore, 0);\n\t\t\t\t\twrt_reg_word(&reg->hccr,\n\t\t\t\t\t    HCCR_CLR_RISC_INT);\n\t\t\t\t\trd_reg_word(&reg->hccr);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\twrt_reg_word(&reg->hccr, HCCR_CLR_RISC_INT);\n\t\t\t\trd_reg_word(&reg->hccr);\n\t\t\t}\n\t\t\tudelay(5);\n\t\t}\n\n\t\tif (test_and_clear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags)) {\n\t\t\trval = mb0 & MBS_MASK;\n\t\t\tfw->risc_ram[cnt] = htons(mb2);\n\t\t} else {\n\t\t\trval = QLA_FUNCTION_FAILED;\n\t\t}\n\t}\n\n\tif (rval == QLA_SUCCESS)\n\t\tqla2xxx_copy_queues(ha, &fw->queue_dump[0]);\n\n\tqla2xxx_dump_post_process(base_vha, rval);\n}\n\nvoid\nqla24xx_fw_dump(scsi_qla_host_t *vha)\n{\n\tint\t\trval;\n\tuint32_t\tcnt;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\t__le32 __iomem *dmp_reg;\n\t__be32\t\t*iter_reg;\n\t__le16 __iomem *mbx_reg;\n\tstruct qla24xx_fw_dump *fw;\n\tvoid\t\t*nxt;\n\tvoid\t\t*nxt_chain;\n\t__be32\t\t*last_chain = NULL;\n\tstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\n\n\tlockdep_assert_held(&ha->hardware_lock);\n\n\tif (IS_P3P_TYPE(ha))\n\t\treturn;\n\n\tha->fw_dump_cap_flags = 0;\n\n\tif (!ha->fw_dump) {\n\t\tql_log(ql_log_warn, vha, 0xd006,\n\t\t    \"No buffer available for dump.\\n\");\n\t\treturn;\n\t}\n\n\tif (ha->fw_dumped) {\n\t\tql_log(ql_log_warn, vha, 0xd007,\n\t\t    \"Firmware has been previously dumped (%p) \"\n\t\t    \"-- ignoring request.\\n\",\n\t\t    ha->fw_dump);\n\t\treturn;\n\t}\n\tQLA_FW_STOPPED(ha);\n\tfw = &ha->fw_dump->isp.isp24;\n\tqla2xxx_prep_dump(ha, ha->fw_dump);\n\n\tfw->host_status = htonl(rd_reg_dword(&reg->host_status));\n\n\t \n\tqla24xx_pause_risc(reg, ha);\n\n\t \n\tdmp_reg = &reg->flash_addr;\n\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->host_reg); cnt++, dmp_reg++)\n\t\tfw->host_reg[cnt] = htonl(rd_reg_dword(dmp_reg));\n\n\t \n\twrt_reg_dword(&reg->ictrl, 0);\n\trd_reg_dword(&reg->ictrl);\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x0F70);\n\trd_reg_dword(&reg->iobase_addr);\n\twrt_reg_dword(&reg->iobase_select, 0xB0000000);\n\tfw->shadow_reg[0] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0100000);\n\tfw->shadow_reg[1] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0200000);\n\tfw->shadow_reg[2] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0300000);\n\tfw->shadow_reg[3] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0400000);\n\tfw->shadow_reg[4] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0500000);\n\tfw->shadow_reg[5] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0600000);\n\tfw->shadow_reg[6] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\t \n\tmbx_reg = &reg->mailbox0;\n\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->mailbox_reg); cnt++, mbx_reg++)\n\t\tfw->mailbox_reg[cnt] = htons(rd_reg_word(mbx_reg));\n\n\t \n\titer_reg = fw->xseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xBF00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xBF70, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xBFE0, 16, fw->xseq_0_reg);\n\tqla24xx_read_window(reg, 0xBFF0, 16, fw->xseq_1_reg);\n\n\t \n\titer_reg = fw->rseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xFF00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xFF70, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xFFD0, 16, fw->rseq_0_reg);\n\tqla24xx_read_window(reg, 0xFFE0, 16, fw->rseq_1_reg);\n\tqla24xx_read_window(reg, 0xFFF0, 16, fw->rseq_2_reg);\n\n\t \n\tqla24xx_read_window(reg, 0x7100, 16, fw->cmd_dma_reg);\n\n\t \n\titer_reg = fw->req0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7200, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\titer_reg = fw->resp0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7300, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\titer_reg = fw->req1_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7400, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\t \n\titer_reg = fw->xmt0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7600, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7610, 16, iter_reg);\n\n\titer_reg = fw->xmt1_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7620, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7630, 16, iter_reg);\n\n\titer_reg = fw->xmt2_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7640, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7650, 16, iter_reg);\n\n\titer_reg = fw->xmt3_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7660, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7670, 16, iter_reg);\n\n\titer_reg = fw->xmt4_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7680, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7690, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0x76A0, 16, fw->xmt_data_dma_reg);\n\n\t \n\titer_reg = fw->rcvt0_data_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7700, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7710, 16, iter_reg);\n\n\titer_reg = fw->rcvt1_data_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7720, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7730, 16, iter_reg);\n\n\t \n\titer_reg = fw->risc_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0x0F00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x0F70, 16, iter_reg);\n\n\t \n\titer_reg = fw->lmc_reg;\n\titer_reg = qla24xx_read_window(reg, 0x3000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3050, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x3060, 16, iter_reg);\n\n\t \n\titer_reg = fw->fpm_hdw_reg;\n\titer_reg = qla24xx_read_window(reg, 0x4000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4060, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4070, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4080, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4090, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40A0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x40B0, 16, iter_reg);\n\n\t \n\titer_reg = fw->fb_hdw_reg;\n\titer_reg = qla24xx_read_window(reg, 0x6000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6100, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6130, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6150, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6170, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6190, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x61B0, 16, iter_reg);\n\n\trval = qla24xx_soft_reset(ha);\n\tif (rval != QLA_SUCCESS)\n\t\tgoto qla24xx_fw_dump_failed_0;\n\n\trval = qla24xx_dump_memory(ha, fw->code_ram, sizeof(fw->code_ram),\n\t    &nxt);\n\tif (rval != QLA_SUCCESS)\n\t\tgoto qla24xx_fw_dump_failed_0;\n\n\tnxt = qla2xxx_copy_queues(ha, nxt);\n\n\tqla24xx_copy_eft(ha, nxt);\n\n\tnxt_chain = (void *)ha->fw_dump + ha->chain_offset;\n\tnxt_chain = qla2xxx_copy_atioqueues(ha, nxt_chain, &last_chain);\n\tif (last_chain) {\n\t\tha->fw_dump->version |= htonl(DUMP_CHAIN_VARIANT);\n\t\t*last_chain |= htonl(DUMP_CHAIN_LAST);\n\t}\n\n\t \n\tha->fw_dump_len = (nxt_chain - (void *)ha->fw_dump);\n\nqla24xx_fw_dump_failed_0:\n\tqla2xxx_dump_post_process(base_vha, rval);\n}\n\nvoid\nqla25xx_fw_dump(scsi_qla_host_t *vha)\n{\n\tint\t\trval;\n\tuint32_t\tcnt;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\t__le32 __iomem *dmp_reg;\n\t__be32\t\t*iter_reg;\n\t__le16 __iomem *mbx_reg;\n\tstruct qla25xx_fw_dump *fw;\n\tvoid\t\t*nxt, *nxt_chain;\n\t__be32\t\t*last_chain = NULL;\n\tstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\n\n\tlockdep_assert_held(&ha->hardware_lock);\n\n\tha->fw_dump_cap_flags = 0;\n\n\tif (!ha->fw_dump) {\n\t\tql_log(ql_log_warn, vha, 0xd008,\n\t\t    \"No buffer available for dump.\\n\");\n\t\treturn;\n\t}\n\n\tif (ha->fw_dumped) {\n\t\tql_log(ql_log_warn, vha, 0xd009,\n\t\t    \"Firmware has been previously dumped (%p) \"\n\t\t    \"-- ignoring request.\\n\",\n\t\t    ha->fw_dump);\n\t\treturn;\n\t}\n\tQLA_FW_STOPPED(ha);\n\tfw = &ha->fw_dump->isp.isp25;\n\tqla2xxx_prep_dump(ha, ha->fw_dump);\n\tha->fw_dump->version = htonl(2);\n\n\tfw->host_status = htonl(rd_reg_dword(&reg->host_status));\n\n\t \n\tqla24xx_pause_risc(reg, ha);\n\n\t \n\titer_reg = fw->host_risc_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7000, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7010, 16, iter_reg);\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x7C00);\n\trd_reg_dword(&reg->iobase_addr);\n\twrt_reg_dword(&reg->iobase_window, 0x01);\n\tdmp_reg = &reg->iobase_c4;\n\tfw->pcie_regs[0] = htonl(rd_reg_dword(dmp_reg));\n\tdmp_reg++;\n\tfw->pcie_regs[1] = htonl(rd_reg_dword(dmp_reg));\n\tdmp_reg++;\n\tfw->pcie_regs[2] = htonl(rd_reg_dword(dmp_reg));\n\tfw->pcie_regs[3] = htonl(rd_reg_dword(&reg->iobase_window));\n\n\twrt_reg_dword(&reg->iobase_window, 0x00);\n\trd_reg_dword(&reg->iobase_window);\n\n\t \n\tdmp_reg = &reg->flash_addr;\n\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->host_reg); cnt++, dmp_reg++)\n\t\tfw->host_reg[cnt] = htonl(rd_reg_dword(dmp_reg));\n\n\t \n\twrt_reg_dword(&reg->ictrl, 0);\n\trd_reg_dword(&reg->ictrl);\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x0F70);\n\trd_reg_dword(&reg->iobase_addr);\n\twrt_reg_dword(&reg->iobase_select, 0xB0000000);\n\tfw->shadow_reg[0] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0100000);\n\tfw->shadow_reg[1] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0200000);\n\tfw->shadow_reg[2] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0300000);\n\tfw->shadow_reg[3] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0400000);\n\tfw->shadow_reg[4] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0500000);\n\tfw->shadow_reg[5] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0600000);\n\tfw->shadow_reg[6] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0700000);\n\tfw->shadow_reg[7] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0800000);\n\tfw->shadow_reg[8] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0900000);\n\tfw->shadow_reg[9] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0A00000);\n\tfw->shadow_reg[10] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x0010);\n\tfw->risc_io_reg = htonl(rd_reg_dword(&reg->iobase_window));\n\n\t \n\tmbx_reg = &reg->mailbox0;\n\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->mailbox_reg); cnt++, mbx_reg++)\n\t\tfw->mailbox_reg[cnt] = htons(rd_reg_word(mbx_reg));\n\n\t \n\titer_reg = fw->xseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xBF00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xBF70, 16, iter_reg);\n\n\titer_reg = fw->xseq_0_reg;\n\titer_reg = qla24xx_read_window(reg, 0xBFC0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBFD0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xBFE0, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xBFF0, 16, fw->xseq_1_reg);\n\n\t \n\titer_reg = fw->rseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xFF00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xFF70, 16, iter_reg);\n\n\titer_reg = fw->rseq_0_reg;\n\titer_reg = qla24xx_read_window(reg, 0xFFC0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xFFD0, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xFFE0, 16, fw->rseq_1_reg);\n\tqla24xx_read_window(reg, 0xFFF0, 16, fw->rseq_2_reg);\n\n\t \n\titer_reg = fw->aseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xB000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB060, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xB070, 16, iter_reg);\n\n\titer_reg = fw->aseq_0_reg;\n\titer_reg = qla24xx_read_window(reg, 0xB0C0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xB0D0, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xB0E0, 16, fw->aseq_1_reg);\n\tqla24xx_read_window(reg, 0xB0F0, 16, fw->aseq_2_reg);\n\n\t \n\tqla24xx_read_window(reg, 0x7100, 16, fw->cmd_dma_reg);\n\n\t \n\titer_reg = fw->req0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7200, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\titer_reg = fw->resp0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7300, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\titer_reg = fw->req1_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7400, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\t \n\titer_reg = fw->xmt0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7600, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7610, 16, iter_reg);\n\n\titer_reg = fw->xmt1_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7620, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7630, 16, iter_reg);\n\n\titer_reg = fw->xmt2_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7640, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7650, 16, iter_reg);\n\n\titer_reg = fw->xmt3_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7660, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7670, 16, iter_reg);\n\n\titer_reg = fw->xmt4_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7680, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7690, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0x76A0, 16, fw->xmt_data_dma_reg);\n\n\t \n\titer_reg = fw->rcvt0_data_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7700, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7710, 16, iter_reg);\n\n\titer_reg = fw->rcvt1_data_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7720, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7730, 16, iter_reg);\n\n\t \n\titer_reg = fw->risc_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0x0F00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x0F70, 16, iter_reg);\n\n\t \n\titer_reg = fw->lmc_reg;\n\titer_reg = qla24xx_read_window(reg, 0x3000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3060, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x3070, 16, iter_reg);\n\n\t \n\titer_reg = fw->fpm_hdw_reg;\n\titer_reg = qla24xx_read_window(reg, 0x4000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4060, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4070, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4080, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4090, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40A0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x40B0, 16, iter_reg);\n\n\t \n\titer_reg = fw->fb_hdw_reg;\n\titer_reg = qla24xx_read_window(reg, 0x6000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6100, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6130, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6150, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6170, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6190, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x61B0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x6F00, 16, iter_reg);\n\n\t \n\tnxt_chain = qla25xx_copy_mq(ha, (void *)ha->fw_dump + ha->chain_offset,\n\t    &last_chain);\n\n\trval = qla24xx_soft_reset(ha);\n\tif (rval != QLA_SUCCESS)\n\t\tgoto qla25xx_fw_dump_failed_0;\n\n\trval = qla24xx_dump_memory(ha, fw->code_ram, sizeof(fw->code_ram),\n\t    &nxt);\n\tif (rval != QLA_SUCCESS)\n\t\tgoto qla25xx_fw_dump_failed_0;\n\n\tnxt = qla2xxx_copy_queues(ha, nxt);\n\n\tqla24xx_copy_eft(ha, nxt);\n\n\t \n\tnxt_chain = qla25xx_copy_fce(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla25xx_copy_mqueues(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla2xxx_copy_atioqueues(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla25xx_copy_exlogin(ha, nxt_chain, &last_chain);\n\tif (last_chain) {\n\t\tha->fw_dump->version |= htonl(DUMP_CHAIN_VARIANT);\n\t\t*last_chain |= htonl(DUMP_CHAIN_LAST);\n\t}\n\n\t \n\tha->fw_dump_len = (nxt_chain - (void *)ha->fw_dump);\n\nqla25xx_fw_dump_failed_0:\n\tqla2xxx_dump_post_process(base_vha, rval);\n}\n\nvoid\nqla81xx_fw_dump(scsi_qla_host_t *vha)\n{\n\tint\t\trval;\n\tuint32_t\tcnt;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\t__le32 __iomem *dmp_reg;\n\t__be32\t\t*iter_reg;\n\t__le16 __iomem *mbx_reg;\n\tstruct qla81xx_fw_dump *fw;\n\tvoid\t\t*nxt, *nxt_chain;\n\t__be32\t\t*last_chain = NULL;\n\tstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\n\n\tlockdep_assert_held(&ha->hardware_lock);\n\n\tha->fw_dump_cap_flags = 0;\n\n\tif (!ha->fw_dump) {\n\t\tql_log(ql_log_warn, vha, 0xd00a,\n\t\t    \"No buffer available for dump.\\n\");\n\t\treturn;\n\t}\n\n\tif (ha->fw_dumped) {\n\t\tql_log(ql_log_warn, vha, 0xd00b,\n\t\t    \"Firmware has been previously dumped (%p) \"\n\t\t    \"-- ignoring request.\\n\",\n\t\t    ha->fw_dump);\n\t\treturn;\n\t}\n\tfw = &ha->fw_dump->isp.isp81;\n\tqla2xxx_prep_dump(ha, ha->fw_dump);\n\n\tfw->host_status = htonl(rd_reg_dword(&reg->host_status));\n\n\t \n\tqla24xx_pause_risc(reg, ha);\n\n\t \n\titer_reg = fw->host_risc_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7000, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7010, 16, iter_reg);\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x7C00);\n\trd_reg_dword(&reg->iobase_addr);\n\twrt_reg_dword(&reg->iobase_window, 0x01);\n\tdmp_reg = &reg->iobase_c4;\n\tfw->pcie_regs[0] = htonl(rd_reg_dword(dmp_reg));\n\tdmp_reg++;\n\tfw->pcie_regs[1] = htonl(rd_reg_dword(dmp_reg));\n\tdmp_reg++;\n\tfw->pcie_regs[2] = htonl(rd_reg_dword(dmp_reg));\n\tfw->pcie_regs[3] = htonl(rd_reg_dword(&reg->iobase_window));\n\n\twrt_reg_dword(&reg->iobase_window, 0x00);\n\trd_reg_dword(&reg->iobase_window);\n\n\t \n\tdmp_reg = &reg->flash_addr;\n\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->host_reg); cnt++, dmp_reg++)\n\t\tfw->host_reg[cnt] = htonl(rd_reg_dword(dmp_reg));\n\n\t \n\twrt_reg_dword(&reg->ictrl, 0);\n\trd_reg_dword(&reg->ictrl);\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x0F70);\n\trd_reg_dword(&reg->iobase_addr);\n\twrt_reg_dword(&reg->iobase_select, 0xB0000000);\n\tfw->shadow_reg[0] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0100000);\n\tfw->shadow_reg[1] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0200000);\n\tfw->shadow_reg[2] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0300000);\n\tfw->shadow_reg[3] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0400000);\n\tfw->shadow_reg[4] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0500000);\n\tfw->shadow_reg[5] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0600000);\n\tfw->shadow_reg[6] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0700000);\n\tfw->shadow_reg[7] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0800000);\n\tfw->shadow_reg[8] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0900000);\n\tfw->shadow_reg[9] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0A00000);\n\tfw->shadow_reg[10] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x0010);\n\tfw->risc_io_reg = htonl(rd_reg_dword(&reg->iobase_window));\n\n\t \n\tmbx_reg = &reg->mailbox0;\n\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->mailbox_reg); cnt++, mbx_reg++)\n\t\tfw->mailbox_reg[cnt] = htons(rd_reg_word(mbx_reg));\n\n\t \n\titer_reg = fw->xseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xBF00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xBF70, 16, iter_reg);\n\n\titer_reg = fw->xseq_0_reg;\n\titer_reg = qla24xx_read_window(reg, 0xBFC0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBFD0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xBFE0, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xBFF0, 16, fw->xseq_1_reg);\n\n\t \n\titer_reg = fw->rseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xFF00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xFF70, 16, iter_reg);\n\n\titer_reg = fw->rseq_0_reg;\n\titer_reg = qla24xx_read_window(reg, 0xFFC0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xFFD0, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xFFE0, 16, fw->rseq_1_reg);\n\tqla24xx_read_window(reg, 0xFFF0, 16, fw->rseq_2_reg);\n\n\t \n\titer_reg = fw->aseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xB000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB060, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xB070, 16, iter_reg);\n\n\titer_reg = fw->aseq_0_reg;\n\titer_reg = qla24xx_read_window(reg, 0xB0C0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xB0D0, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xB0E0, 16, fw->aseq_1_reg);\n\tqla24xx_read_window(reg, 0xB0F0, 16, fw->aseq_2_reg);\n\n\t \n\tqla24xx_read_window(reg, 0x7100, 16, fw->cmd_dma_reg);\n\n\t \n\titer_reg = fw->req0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7200, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\titer_reg = fw->resp0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7300, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\titer_reg = fw->req1_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7400, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\t \n\titer_reg = fw->xmt0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7600, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7610, 16, iter_reg);\n\n\titer_reg = fw->xmt1_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7620, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7630, 16, iter_reg);\n\n\titer_reg = fw->xmt2_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7640, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7650, 16, iter_reg);\n\n\titer_reg = fw->xmt3_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7660, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7670, 16, iter_reg);\n\n\titer_reg = fw->xmt4_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7680, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7690, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0x76A0, 16, fw->xmt_data_dma_reg);\n\n\t \n\titer_reg = fw->rcvt0_data_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7700, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7710, 16, iter_reg);\n\n\titer_reg = fw->rcvt1_data_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7720, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7730, 16, iter_reg);\n\n\t \n\titer_reg = fw->risc_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0x0F00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x0F70, 16, iter_reg);\n\n\t \n\titer_reg = fw->lmc_reg;\n\titer_reg = qla24xx_read_window(reg, 0x3000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3060, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x3070, 16, iter_reg);\n\n\t \n\titer_reg = fw->fpm_hdw_reg;\n\titer_reg = qla24xx_read_window(reg, 0x4000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4060, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4070, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4080, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4090, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40A0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40B0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40C0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x40D0, 16, iter_reg);\n\n\t \n\titer_reg = fw->fb_hdw_reg;\n\titer_reg = qla24xx_read_window(reg, 0x6000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6100, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6130, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6150, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6170, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6190, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x61B0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x61C0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x6F00, 16, iter_reg);\n\n\t \n\tnxt_chain = qla25xx_copy_mq(ha, (void *)ha->fw_dump + ha->chain_offset,\n\t    &last_chain);\n\n\trval = qla24xx_soft_reset(ha);\n\tif (rval != QLA_SUCCESS)\n\t\tgoto qla81xx_fw_dump_failed_0;\n\n\trval = qla24xx_dump_memory(ha, fw->code_ram, sizeof(fw->code_ram),\n\t    &nxt);\n\tif (rval != QLA_SUCCESS)\n\t\tgoto qla81xx_fw_dump_failed_0;\n\n\tnxt = qla2xxx_copy_queues(ha, nxt);\n\n\tqla24xx_copy_eft(ha, nxt);\n\n\t \n\tnxt_chain = qla25xx_copy_fce(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla25xx_copy_mqueues(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla2xxx_copy_atioqueues(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla25xx_copy_exlogin(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla81xx_copy_exchoffld(ha, nxt_chain, &last_chain);\n\tif (last_chain) {\n\t\tha->fw_dump->version |= htonl(DUMP_CHAIN_VARIANT);\n\t\t*last_chain |= htonl(DUMP_CHAIN_LAST);\n\t}\n\n\t \n\tha->fw_dump_len = (nxt_chain - (void *)ha->fw_dump);\n\nqla81xx_fw_dump_failed_0:\n\tqla2xxx_dump_post_process(base_vha, rval);\n}\n\nvoid\nqla83xx_fw_dump(scsi_qla_host_t *vha)\n{\n\tint\t\trval;\n\tuint32_t\tcnt;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\n\t__le32 __iomem *dmp_reg;\n\t__be32\t\t*iter_reg;\n\t__le16 __iomem *mbx_reg;\n\tstruct qla83xx_fw_dump *fw;\n\tvoid\t\t*nxt, *nxt_chain;\n\t__be32\t\t*last_chain = NULL;\n\tstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\n\n\tlockdep_assert_held(&ha->hardware_lock);\n\n\tha->fw_dump_cap_flags = 0;\n\n\tif (!ha->fw_dump) {\n\t\tql_log(ql_log_warn, vha, 0xd00c,\n\t\t    \"No buffer available for dump!!!\\n\");\n\t\treturn;\n\t}\n\n\tif (ha->fw_dumped) {\n\t\tql_log(ql_log_warn, vha, 0xd00d,\n\t\t    \"Firmware has been previously dumped (%p) -- ignoring \"\n\t\t    \"request...\\n\", ha->fw_dump);\n\t\treturn;\n\t}\n\tQLA_FW_STOPPED(ha);\n\tfw = &ha->fw_dump->isp.isp83;\n\tqla2xxx_prep_dump(ha, ha->fw_dump);\n\n\tfw->host_status = htonl(rd_reg_dword(&reg->host_status));\n\n\t \n\tqla24xx_pause_risc(reg, ha);\n\n\twrt_reg_dword(&reg->iobase_addr, 0x6000);\n\tdmp_reg = &reg->iobase_window;\n\trd_reg_dword(dmp_reg);\n\twrt_reg_dword(dmp_reg, 0);\n\n\tdmp_reg = &reg->unused_4_1[0];\n\trd_reg_dword(dmp_reg);\n\twrt_reg_dword(dmp_reg, 0);\n\n\twrt_reg_dword(&reg->iobase_addr, 0x6010);\n\tdmp_reg = &reg->unused_4_1[2];\n\trd_reg_dword(dmp_reg);\n\twrt_reg_dword(dmp_reg, 0);\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x0F70);\n\trd_reg_dword(&reg->iobase_addr);\n\twrt_reg_dword(&reg->iobase_select, 0x60000000);\t \n\n\t \n\titer_reg = fw->host_risc_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x7010, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7040, 16, iter_reg);\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x7C00);\n\trd_reg_dword(&reg->iobase_addr);\n\twrt_reg_dword(&reg->iobase_window, 0x01);\n\tdmp_reg = &reg->iobase_c4;\n\tfw->pcie_regs[0] = htonl(rd_reg_dword(dmp_reg));\n\tdmp_reg++;\n\tfw->pcie_regs[1] = htonl(rd_reg_dword(dmp_reg));\n\tdmp_reg++;\n\tfw->pcie_regs[2] = htonl(rd_reg_dword(dmp_reg));\n\tfw->pcie_regs[3] = htonl(rd_reg_dword(&reg->iobase_window));\n\n\twrt_reg_dword(&reg->iobase_window, 0x00);\n\trd_reg_dword(&reg->iobase_window);\n\n\t \n\tdmp_reg = &reg->flash_addr;\n\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->host_reg); cnt++, dmp_reg++)\n\t\tfw->host_reg[cnt] = htonl(rd_reg_dword(dmp_reg));\n\n\t \n\twrt_reg_dword(&reg->ictrl, 0);\n\trd_reg_dword(&reg->ictrl);\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x0F70);\n\trd_reg_dword(&reg->iobase_addr);\n\twrt_reg_dword(&reg->iobase_select, 0xB0000000);\n\tfw->shadow_reg[0] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0100000);\n\tfw->shadow_reg[1] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0200000);\n\tfw->shadow_reg[2] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0300000);\n\tfw->shadow_reg[3] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0400000);\n\tfw->shadow_reg[4] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0500000);\n\tfw->shadow_reg[5] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0600000);\n\tfw->shadow_reg[6] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0700000);\n\tfw->shadow_reg[7] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0800000);\n\tfw->shadow_reg[8] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0900000);\n\tfw->shadow_reg[9] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\twrt_reg_dword(&reg->iobase_select, 0xB0A00000);\n\tfw->shadow_reg[10] = htonl(rd_reg_dword(&reg->iobase_sdata));\n\n\t \n\twrt_reg_dword(&reg->iobase_addr, 0x0010);\n\tfw->risc_io_reg = htonl(rd_reg_dword(&reg->iobase_window));\n\n\t \n\tmbx_reg = &reg->mailbox0;\n\tfor (cnt = 0; cnt < ARRAY_SIZE(fw->mailbox_reg); cnt++, mbx_reg++)\n\t\tfw->mailbox_reg[cnt] = htons(rd_reg_word(mbx_reg));\n\n\t \n\titer_reg = fw->xseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xBE00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBE10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBE20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBE30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBE40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBE50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBE60, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBE70, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBF60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xBF70, 16, iter_reg);\n\n\titer_reg = fw->xseq_0_reg;\n\titer_reg = qla24xx_read_window(reg, 0xBFC0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xBFD0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xBFE0, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xBFF0, 16, fw->xseq_1_reg);\n\n\tqla24xx_read_window(reg, 0xBEF0, 16, fw->xseq_2_reg);\n\n\t \n\titer_reg = fw->rseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xFE00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFE10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFE20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFE30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFE40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFE50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFE60, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFE70, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xFF60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xFF70, 16, iter_reg);\n\n\titer_reg = fw->rseq_0_reg;\n\titer_reg = qla24xx_read_window(reg, 0xFFC0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xFFD0, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xFFE0, 16, fw->rseq_1_reg);\n\tqla24xx_read_window(reg, 0xFFF0, 16, fw->rseq_2_reg);\n\tqla24xx_read_window(reg, 0xFEF0, 16, fw->rseq_3_reg);\n\n\t \n\titer_reg = fw->aseq_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0xB000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB060, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB070, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB100, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB110, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB120, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB130, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB140, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB150, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0xB160, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xB170, 16, iter_reg);\n\n\titer_reg = fw->aseq_0_reg;\n\titer_reg = qla24xx_read_window(reg, 0xB0C0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0xB0D0, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0xB0E0, 16, fw->aseq_1_reg);\n\tqla24xx_read_window(reg, 0xB0F0, 16, fw->aseq_2_reg);\n\tqla24xx_read_window(reg, 0xB1F0, 16, fw->aseq_3_reg);\n\n\t \n\titer_reg = fw->cmd_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7100, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x7120, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x7130, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x71F0, 16, iter_reg);\n\n\t \n\titer_reg = fw->req0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7200, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\titer_reg = fw->resp0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7300, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\titer_reg = fw->req1_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7400, 8, iter_reg);\n\tdmp_reg = &reg->iobase_q;\n\tfor (cnt = 0; cnt < 7; cnt++, dmp_reg++)\n\t\t*iter_reg++ = htonl(rd_reg_dword(dmp_reg));\n\n\t \n\titer_reg = fw->xmt0_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7600, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7610, 16, iter_reg);\n\n\titer_reg = fw->xmt1_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7620, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7630, 16, iter_reg);\n\n\titer_reg = fw->xmt2_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7640, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7650, 16, iter_reg);\n\n\titer_reg = fw->xmt3_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7660, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7670, 16, iter_reg);\n\n\titer_reg = fw->xmt4_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7680, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7690, 16, iter_reg);\n\n\tqla24xx_read_window(reg, 0x76A0, 16, fw->xmt_data_dma_reg);\n\n\t \n\titer_reg = fw->rcvt0_data_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7700, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7710, 16, iter_reg);\n\n\titer_reg = fw->rcvt1_data_dma_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7720, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x7730, 16, iter_reg);\n\n\t \n\titer_reg = fw->risc_gp_reg;\n\titer_reg = qla24xx_read_window(reg, 0x0F00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x0F60, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x0F70, 16, iter_reg);\n\n\t \n\titer_reg = fw->lmc_reg;\n\titer_reg = qla24xx_read_window(reg, 0x3000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x3060, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x3070, 16, iter_reg);\n\n\t \n\titer_reg = fw->fpm_hdw_reg;\n\titer_reg = qla24xx_read_window(reg, 0x4000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4050, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4060, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4070, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4080, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x4090, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40A0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40B0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40C0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40D0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x40E0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x40F0, 16, iter_reg);\n\n\t \n\titer_reg = fw->rq0_array_reg;\n\titer_reg = qla24xx_read_window(reg, 0x5C00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5C10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5C20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5C30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5C40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5C50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5C60, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5C70, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5C80, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5C90, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5CA0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5CB0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5CC0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5CD0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5CE0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x5CF0, 16, iter_reg);\n\n\t \n\titer_reg = fw->rq1_array_reg;\n\titer_reg = qla24xx_read_window(reg, 0x5D00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5D10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5D20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5D30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5D40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5D50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5D60, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5D70, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5D80, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5D90, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5DA0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5DB0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5DC0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5DD0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5DE0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x5DF0, 16, iter_reg);\n\n\t \n\titer_reg = fw->rp0_array_reg;\n\titer_reg = qla24xx_read_window(reg, 0x5E00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5E10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5E20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5E30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5E40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5E50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5E60, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5E70, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5E80, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5E90, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5EA0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5EB0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5EC0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5ED0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5EE0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x5EF0, 16, iter_reg);\n\n\t \n\titer_reg = fw->rp1_array_reg;\n\titer_reg = qla24xx_read_window(reg, 0x5F00, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5F10, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5F20, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5F30, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5F40, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5F50, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5F60, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5F70, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5F80, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5F90, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5FA0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5FB0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5FC0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5FD0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x5FE0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x5FF0, 16, iter_reg);\n\n\titer_reg = fw->at0_array_reg;\n\titer_reg = qla24xx_read_window(reg, 0x7080, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x7090, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x70A0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x70B0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x70C0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x70D0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x70E0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x70F0, 16, iter_reg);\n\n\t \n\tqla24xx_read_window(reg, 0x7800, 16, fw->queue_control_reg);\n\n\t \n\titer_reg = fw->fb_hdw_reg;\n\titer_reg = qla24xx_read_window(reg, 0x6000, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6010, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6020, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6030, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6040, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6060, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6070, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6100, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6130, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6150, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6170, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6190, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x61B0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x61C0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6530, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6540, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6550, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6560, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6570, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6580, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x6590, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x65A0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x65B0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x65C0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x65D0, 16, iter_reg);\n\titer_reg = qla24xx_read_window(reg, 0x65E0, 16, iter_reg);\n\tqla24xx_read_window(reg, 0x6F00, 16, iter_reg);\n\n\t \n\tnxt_chain = qla25xx_copy_mq(ha, (void *)ha->fw_dump + ha->chain_offset,\n\t    &last_chain);\n\n\trval = qla24xx_soft_reset(ha);\n\tif (rval != QLA_SUCCESS) {\n\t\tql_log(ql_log_warn, vha, 0xd00e,\n\t\t    \"SOFT RESET FAILED, forcing continuation of dump!!!\\n\");\n\t\trval = QLA_SUCCESS;\n\n\t\tql_log(ql_log_warn, vha, 0xd00f, \"try a bigger hammer!!!\\n\");\n\n\t\twrt_reg_dword(&reg->hccr, HCCRX_SET_RISC_RESET);\n\t\trd_reg_dword(&reg->hccr);\n\n\t\twrt_reg_dword(&reg->hccr, HCCRX_REL_RISC_PAUSE);\n\t\trd_reg_dword(&reg->hccr);\n\n\t\twrt_reg_dword(&reg->hccr, HCCRX_CLR_RISC_RESET);\n\t\trd_reg_dword(&reg->hccr);\n\n\t\tfor (cnt = 30000; cnt && (rd_reg_word(&reg->mailbox0)); cnt--)\n\t\t\tudelay(5);\n\n\t\tif (!cnt) {\n\t\t\tnxt = fw->code_ram;\n\t\t\tnxt += sizeof(fw->code_ram);\n\t\t\tnxt += (ha->fw_memory_size - 0x100000 + 1);\n\t\t\tgoto copy_queue;\n\t\t} else {\n\t\t\tset_bit(RISC_RDY_AFT_RESET, &ha->fw_dump_cap_flags);\n\t\t\tql_log(ql_log_warn, vha, 0xd010,\n\t\t\t    \"bigger hammer success?\\n\");\n\t\t}\n\t}\n\n\trval = qla24xx_dump_memory(ha, fw->code_ram, sizeof(fw->code_ram),\n\t    &nxt);\n\tif (rval != QLA_SUCCESS)\n\t\tgoto qla83xx_fw_dump_failed_0;\n\ncopy_queue:\n\tnxt = qla2xxx_copy_queues(ha, nxt);\n\n\tqla24xx_copy_eft(ha, nxt);\n\n\t \n\tnxt_chain = qla25xx_copy_fce(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla25xx_copy_mqueues(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla2xxx_copy_atioqueues(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla25xx_copy_exlogin(ha, nxt_chain, &last_chain);\n\tnxt_chain = qla81xx_copy_exchoffld(ha, nxt_chain, &last_chain);\n\tif (last_chain) {\n\t\tha->fw_dump->version |= htonl(DUMP_CHAIN_VARIANT);\n\t\t*last_chain |= htonl(DUMP_CHAIN_LAST);\n\t}\n\n\t \n\tha->fw_dump_len = (nxt_chain - (void *)ha->fw_dump);\n\nqla83xx_fw_dump_failed_0:\n\tqla2xxx_dump_post_process(base_vha, rval);\n}\n\n \n \n \n\n \nstatic void ql_dbg_prefix(char *pbuf, int pbuf_size, struct pci_dev *pdev,\n\t\t\t  const scsi_qla_host_t *vha, uint msg_id)\n{\n\tif (vha) {\n\t\tconst struct pci_dev *pdev = vha->hw->pdev;\n\n\t\t \n\t\tsnprintf(pbuf, pbuf_size, \"%s [%s]-%04x:%lu: \", QL_MSGHDR,\n\t\t\t dev_name(&(pdev->dev)), msg_id, vha->host_no);\n\t} else if (pdev) {\n\t\tsnprintf(pbuf, pbuf_size, \"%s [%s]-%04x: : \", QL_MSGHDR,\n\t\t\t dev_name(&pdev->dev), msg_id);\n\t} else {\n\t\t \n\t\tsnprintf(pbuf, pbuf_size, \"%s [%s]-%04x: : \", QL_MSGHDR,\n\t\t\t \"0000:00:00.0\", msg_id);\n\t}\n}\n\n \nvoid\nql_dbg(uint level, scsi_qla_host_t *vha, uint id, const char *fmt, ...)\n{\n\tva_list va;\n\tstruct va_format vaf;\n\tchar pbuf[64];\n\n\tql_ktrace(1, level, pbuf, NULL, vha, id, fmt);\n\n\tif (!ql_mask_match(level))\n\t\treturn;\n\n\tif (!pbuf[0])  \n\t\tql_dbg_prefix(pbuf, ARRAY_SIZE(pbuf), NULL, vha, id);\n\n\tva_start(va, fmt);\n\n\tvaf.fmt = fmt;\n\tvaf.va = &va;\n\n\tpr_warn(\"%s%pV\", pbuf, &vaf);\n\n\tva_end(va);\n\n}\n\n \nvoid\nql_dbg_pci(uint level, struct pci_dev *pdev, uint id, const char *fmt, ...)\n{\n\tva_list va;\n\tstruct va_format vaf;\n\tchar pbuf[128];\n\n\tif (pdev == NULL)\n\t\treturn;\n\n\tql_ktrace(1, level, pbuf, pdev, NULL, id, fmt);\n\n\tif (!ql_mask_match(level))\n\t\treturn;\n\n\tva_start(va, fmt);\n\n\tvaf.fmt = fmt;\n\tvaf.va = &va;\n\n\tif (!pbuf[0])  \n\t\tql_dbg_prefix(pbuf, ARRAY_SIZE(pbuf), pdev, NULL,\n\t\t\t      id + ql_dbg_offset);\n\tpr_warn(\"%s%pV\", pbuf, &vaf);\n\n\tva_end(va);\n}\n\n \nvoid\nql_log(uint level, scsi_qla_host_t *vha, uint id, const char *fmt, ...)\n{\n\tva_list va;\n\tstruct va_format vaf;\n\tchar pbuf[128];\n\n\tif (level > ql_errlev)\n\t\treturn;\n\n\tql_ktrace(0, level, pbuf, NULL, vha, id, fmt);\n\n\tif (!pbuf[0])  \n\t\tql_dbg_prefix(pbuf, ARRAY_SIZE(pbuf), NULL, vha, id);\n\n\tva_start(va, fmt);\n\n\tvaf.fmt = fmt;\n\tvaf.va = &va;\n\n\tswitch (level) {\n\tcase ql_log_fatal:  \n\t\tpr_crit(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\tcase ql_log_warn:\n\t\tpr_err(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\tcase ql_log_info:\n\t\tpr_warn(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\tdefault:\n\t\tpr_info(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\t}\n\n\tva_end(va);\n}\n\n \nvoid\nql_log_pci(uint level, struct pci_dev *pdev, uint id, const char *fmt, ...)\n{\n\tva_list va;\n\tstruct va_format vaf;\n\tchar pbuf[128];\n\n\tif (pdev == NULL)\n\t\treturn;\n\tif (level > ql_errlev)\n\t\treturn;\n\n\tql_ktrace(0, level, pbuf, pdev, NULL, id, fmt);\n\n\tif (!pbuf[0])  \n\t\tql_dbg_prefix(pbuf, ARRAY_SIZE(pbuf), pdev, NULL, id);\n\n\tva_start(va, fmt);\n\n\tvaf.fmt = fmt;\n\tvaf.va = &va;\n\n\tswitch (level) {\n\tcase ql_log_fatal:  \n\t\tpr_crit(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\tcase ql_log_warn:\n\t\tpr_err(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\tcase ql_log_info:\n\t\tpr_warn(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\tdefault:\n\t\tpr_info(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\t}\n\n\tva_end(va);\n}\n\nvoid\nql_dump_regs(uint level, scsi_qla_host_t *vha, uint id)\n{\n\tint i;\n\tstruct qla_hw_data *ha = vha->hw;\n\tstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\n\tstruct device_reg_24xx __iomem *reg24 = &ha->iobase->isp24;\n\tstruct device_reg_82xx __iomem *reg82 = &ha->iobase->isp82;\n\t__le16 __iomem *mbx_reg;\n\n\tif (!ql_mask_match(level))\n\t\treturn;\n\n\tif (IS_P3P_TYPE(ha))\n\t\tmbx_reg = &reg82->mailbox_in[0];\n\telse if (IS_FWI2_CAPABLE(ha))\n\t\tmbx_reg = &reg24->mailbox0;\n\telse\n\t\tmbx_reg = MAILBOX_REG(ha, reg, 0);\n\n\tql_dbg(level, vha, id, \"Mailbox registers:\\n\");\n\tfor (i = 0; i < 6; i++, mbx_reg++)\n\t\tql_dbg(level, vha, id,\n\t\t    \"mbox[%d] %#04x\\n\", i, rd_reg_word(mbx_reg));\n}\n\nvoid\nql_dump_buffer(uint level, scsi_qla_host_t *vha, uint id, const void *buf,\n\t       uint size)\n{\n\tuint cnt;\n\n\tif (!ql_mask_match(level))\n\t\treturn;\n\n\tql_dbg(level, vha, id,\n\t    \"%-+5d  0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F\\n\", size);\n\tql_dbg(level, vha, id,\n\t    \"----- -----------------------------------------------\\n\");\n\tfor (cnt = 0; cnt < size; cnt += 16) {\n\t\tql_dbg(level, vha, id, \"%04x: \", cnt);\n\t\tprint_hex_dump(KERN_CONT, \"\", DUMP_PREFIX_NONE, 16, 1,\n\t\t\t       buf + cnt, min(16U, size - cnt), false);\n\t}\n}\n\n \nvoid\nql_log_qp(uint32_t level, struct qla_qpair *qpair, int32_t id,\n    const char *fmt, ...)\n{\n\tva_list va;\n\tstruct va_format vaf;\n\tchar pbuf[128];\n\n\tif (level > ql_errlev)\n\t\treturn;\n\n\tql_ktrace(0, level, pbuf, NULL, qpair ? qpair->vha : NULL, id, fmt);\n\n\tif (!pbuf[0])  \n\t\tql_dbg_prefix(pbuf, ARRAY_SIZE(pbuf), NULL,\n\t\t\t      qpair ? qpair->vha : NULL, id);\n\n\tva_start(va, fmt);\n\n\tvaf.fmt = fmt;\n\tvaf.va = &va;\n\n\tswitch (level) {\n\tcase ql_log_fatal:  \n\t\tpr_crit(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\tcase ql_log_warn:\n\t\tpr_err(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\tcase ql_log_info:\n\t\tpr_warn(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\tdefault:\n\t\tpr_info(\"%s%pV\", pbuf, &vaf);\n\t\tbreak;\n\t}\n\n\tva_end(va);\n}\n\n \nvoid\nql_dbg_qp(uint32_t level, struct qla_qpair *qpair, int32_t id,\n    const char *fmt, ...)\n{\n\tva_list va;\n\tstruct va_format vaf;\n\tchar pbuf[128];\n\n\tql_ktrace(1, level, pbuf, NULL, qpair ? qpair->vha : NULL, id, fmt);\n\n\tif (!ql_mask_match(level))\n\t\treturn;\n\n\tva_start(va, fmt);\n\n\tvaf.fmt = fmt;\n\tvaf.va = &va;\n\n\tif (!pbuf[0])  \n\t\tql_dbg_prefix(pbuf, ARRAY_SIZE(pbuf), NULL,\n\t\t\t      qpair ? qpair->vha : NULL, id + ql_dbg_offset);\n\n\tpr_warn(\"%s%pV\", pbuf, &vaf);\n\n\tva_end(va);\n\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}