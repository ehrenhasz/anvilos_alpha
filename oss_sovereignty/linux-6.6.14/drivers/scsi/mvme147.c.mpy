{
  "module_name": "mvme147.c",
  "hash_id": "2324b743a6787de917f6128a47e322737960a0f111fef5b2006fe16564f2b4de",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/mvme147.c",
  "human_readable_source": "\n#include <linux/types.h>\n#include <linux/mm.h>\n#include <linux/blkdev.h>\n#include <linux/interrupt.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n\n#include <asm/page.h>\n#include <asm/mvme147hw.h>\n#include <asm/irq.h>\n\n#include <scsi/scsi.h>\n#include <scsi/scsi_cmnd.h>\n#include <scsi/scsi_device.h>\n#include <scsi/scsi_eh.h>\n#include <scsi/scsi_host.h>\n#include <scsi/scsi_tcq.h>\n#include \"wd33c93.h\"\n#include \"mvme147.h\"\n\nstatic irqreturn_t mvme147_intr(int irq, void *data)\n{\n\tstruct Scsi_Host *instance = data;\n\n\tif (irq == MVME147_IRQ_SCSI_PORT)\n\t\twd33c93_intr(instance);\n\telse\n\t\tm147_pcc->dma_intr = 0x89;\t \n\treturn IRQ_HANDLED;\n}\n\nstatic int dma_setup(struct scsi_cmnd *cmd, int dir_in)\n{\n\tstruct scsi_pointer *scsi_pointer = WD33C93_scsi_pointer(cmd);\n\tstruct Scsi_Host *instance = cmd->device->host;\n\tstruct WD33C93_hostdata *hdata = shost_priv(instance);\n\tunsigned char flags = 0x01;\n\tunsigned long addr = virt_to_bus(scsi_pointer->ptr);\n\n\t \n\tif (!dir_in)\n\t\tflags |= 0x04;\n\n\t \n\thdata->dma_dir = dir_in;\n\n\tif (dir_in) {\n\t\t \n\t\tcache_clear(addr, scsi_pointer->this_residual);\n\t} else {\n\t\t \n\t\tcache_push(addr, scsi_pointer->this_residual);\n\t}\n\n\t \n\tm147_pcc->dma_bcr = scsi_pointer->this_residual | (1 << 24);\n\tm147_pcc->dma_dadr = addr;\n\tm147_pcc->dma_cntrl = flags;\n\n\t \n\treturn 0;\n}\n\nstatic void dma_stop(struct Scsi_Host *instance, struct scsi_cmnd *SCpnt,\n\t\t     int status)\n{\n\tm147_pcc->dma_cntrl = 0;\n}\n\nstatic const struct scsi_host_template mvme147_host_template = {\n\t.module\t\t\t= THIS_MODULE,\n\t.proc_name\t\t= \"MVME147\",\n\t.name\t\t\t= \"MVME147 built-in SCSI\",\n\t.queuecommand\t\t= wd33c93_queuecommand,\n\t.eh_abort_handler\t= wd33c93_abort,\n\t.eh_host_reset_handler\t= wd33c93_host_reset,\n\t.show_info\t\t= wd33c93_show_info,\n\t.write_info\t\t= wd33c93_write_info,\n\t.can_queue\t\t= CAN_QUEUE,\n\t.this_id\t\t= 7,\n\t.sg_tablesize\t\t= SG_ALL,\n\t.cmd_per_lun\t\t= CMD_PER_LUN,\n\t.cmd_size\t\t= sizeof(struct scsi_pointer),\n};\n\nstatic struct Scsi_Host *mvme147_shost;\n\nstatic int __init mvme147_init(void)\n{\n\twd33c93_regs regs;\n\tstruct WD33C93_hostdata *hdata;\n\tint error = -ENOMEM;\n\n\tif (!MACH_IS_MVME147)\n\t\treturn 0;\n\n\tmvme147_shost = scsi_host_alloc(&mvme147_host_template,\n\t\t\tsizeof(struct WD33C93_hostdata));\n\tif (!mvme147_shost)\n\t\tgoto err_out;\n\tmvme147_shost->base = 0xfffe4000;\n\tmvme147_shost->irq = MVME147_IRQ_SCSI_PORT;\n\n\tregs.SASR = (volatile unsigned char *)0xfffe4000;\n\tregs.SCMD = (volatile unsigned char *)0xfffe4001;\n\n\thdata = shost_priv(mvme147_shost);\n\thdata->no_sync = 0xff;\n\thdata->fast = 0;\n\thdata->dma_mode = CTRL_DMA;\n\n\twd33c93_init(mvme147_shost, regs, dma_setup, dma_stop, WD33C93_FS_8_10);\n\n\terror = request_irq(MVME147_IRQ_SCSI_PORT, mvme147_intr, 0,\n\t\t\t\"MVME147 SCSI PORT\", mvme147_shost);\n\tif (error)\n\t\tgoto err_unregister;\n\terror = request_irq(MVME147_IRQ_SCSI_DMA, mvme147_intr, 0,\n\t\t\t\"MVME147 SCSI DMA\", mvme147_shost);\n\tif (error)\n\t\tgoto err_free_irq;\n#if 0\t \n\tm147_pcc->scsi_interrupt = 0x10;\t \n\tudelay(100);\n\tm147_pcc->scsi_interrupt = 0x00;\t \n\tudelay(2000);\n\tm147_pcc->scsi_interrupt = 0x40;\t \n#endif\n\tm147_pcc->scsi_interrupt = 0x09;\t \n\n\tm147_pcc->dma_cntrl = 0x00;\t \n\tm147_pcc->dma_intr = 0x89;\t \n\n\terror = scsi_add_host(mvme147_shost, NULL);\n\tif (error)\n\t\tgoto err_free_irq;\n\tscsi_scan_host(mvme147_shost);\n\treturn 0;\n\nerr_free_irq:\n\tfree_irq(MVME147_IRQ_SCSI_PORT, mvme147_shost);\nerr_unregister:\n\tscsi_host_put(mvme147_shost);\nerr_out:\n\treturn error;\n}\n\nstatic void __exit mvme147_exit(void)\n{\n\tscsi_remove_host(mvme147_shost);\n\n\t \n\tfree_irq(MVME147_IRQ_SCSI_PORT, mvme147_shost);\n\tfree_irq(MVME147_IRQ_SCSI_DMA, mvme147_shost);\n\n\tscsi_host_put(mvme147_shost);\n}\n\nmodule_init(mvme147_init);\nmodule_exit(mvme147_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}