{
  "module_name": "drv_fcoe_fw_funcs.c",
  "hash_id": "e9b8a52849e64666b8545b9596cc35dea4f15b1783c603a789e1355f8230bfcd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/qedf/drv_fcoe_fw_funcs.c",
  "human_readable_source": "\n \n#include \"drv_fcoe_fw_funcs.h\"\n#include \"drv_scsi_fw_funcs.h\"\n\n#define FCOE_RX_ID (0xFFFFu)\n\nstatic inline void init_common_sqe(struct fcoe_task_params *task_params,\n\t\t\t\t   enum fcoe_sqe_request_type request_type)\n{\n\tmemset(task_params->sqe, 0, sizeof(*(task_params->sqe)));\n\tSET_FIELD(task_params->sqe->flags, FCOE_WQE_REQ_TYPE,\n\t\t  request_type);\n\ttask_params->sqe->task_id = task_params->itid;\n}\n\nint init_initiator_rw_fcoe_task(struct fcoe_task_params *task_params,\n\t\t\t\tstruct scsi_sgl_task_params *sgl_task_params,\n\t\t\t\tstruct regpair sense_data_buffer_phys_addr,\n\t\t\t\tu32 task_retry_id,\n\t\t\t\tu8 fcp_cmd_payload[32])\n{\n\tstruct fcoe_task_context *ctx = task_params->context;\n\tconst u8 val_byte = ctx->ystorm_ag_context.byte0;\n\tstruct ustorm_fcoe_task_ag_ctx *u_ag_ctx;\n\tstruct ystorm_fcoe_task_st_ctx *y_st_ctx;\n\tstruct tstorm_fcoe_task_st_ctx *t_st_ctx;\n\tstruct mstorm_fcoe_task_st_ctx *m_st_ctx;\n\tu32 io_size, val;\n\tbool slow_sgl;\n\n\tmemset(ctx, 0, sizeof(*(ctx)));\n\tctx->ystorm_ag_context.byte0 = val_byte;\n\tslow_sgl = scsi_is_slow_sgl(sgl_task_params->num_sges,\n\t\t\t\t    sgl_task_params->small_mid_sge);\n\tio_size = (task_params->task_type == FCOE_TASK_TYPE_WRITE_INITIATOR ?\n\t\t   task_params->tx_io_size : task_params->rx_io_size);\n\n\t \n\ty_st_ctx = &ctx->ystorm_st_context;\n\ty_st_ctx->data_2_trns_rem = cpu_to_le32(io_size);\n\ty_st_ctx->task_rety_identifier = cpu_to_le32(task_retry_id);\n\ty_st_ctx->task_type = (u8)task_params->task_type;\n\tmemcpy(&y_st_ctx->tx_info_union.fcp_cmd_payload,\n\t       fcp_cmd_payload, sizeof(struct fcoe_fcp_cmd_payload));\n\n\t \n\tt_st_ctx = &ctx->tstorm_st_context;\n\tt_st_ctx->read_only.dev_type = (u8)(task_params->is_tape_device == 1 ?\n\t\t\t\t\t    FCOE_TASK_DEV_TYPE_TAPE :\n\t\t\t\t\t    FCOE_TASK_DEV_TYPE_DISK);\n\tt_st_ctx->read_only.cid = cpu_to_le32(task_params->conn_cid);\n\tval = cpu_to_le32(task_params->cq_rss_number);\n\tt_st_ctx->read_only.glbl_q_num = val;\n\tt_st_ctx->read_only.fcp_cmd_trns_size = cpu_to_le32(io_size);\n\tt_st_ctx->read_only.task_type = (u8)task_params->task_type;\n\tSET_FIELD(t_st_ctx->read_write.flags,\n\t\t  FCOE_TSTORM_FCOE_TASK_ST_CTX_READ_WRITE_EXP_FIRST_FRAME, 1);\n\tt_st_ctx->read_write.rx_id = cpu_to_le16(FCOE_RX_ID);\n\n\t \n\tu_ag_ctx = &ctx->ustorm_ag_context;\n\tu_ag_ctx->global_cq_num = cpu_to_le32(task_params->cq_rss_number);\n\n\t \n\tm_st_ctx = &ctx->mstorm_st_context;\n\tval = cpu_to_le32(sense_data_buffer_phys_addr.hi);\n\tm_st_ctx->rsp_buf_addr.hi = val;\n\tval = cpu_to_le32(sense_data_buffer_phys_addr.lo);\n\tm_st_ctx->rsp_buf_addr.lo = val;\n\n\tif (task_params->task_type == FCOE_TASK_TYPE_WRITE_INITIATOR) {\n\t\t \n\t\ty_st_ctx->expect_first_xfer = 1;\n\n\t\t \n\t\tSET_FIELD(y_st_ctx->sgl_mode,\n\t\t\t  YSTORM_FCOE_TASK_ST_CTX_TX_SGL_MODE,\n\t\t\t  (slow_sgl ? SCSI_TX_SLOW_SGL : SCSI_FAST_SGL));\n\t\tinit_scsi_sgl_context(&y_st_ctx->sgl_params,\n\t\t\t\t      &y_st_ctx->data_desc,\n\t\t\t\t      sgl_task_params);\n\n\t\t \n\t\tSET_FIELD(m_st_ctx->flags,\n\t\t\t  MSTORM_FCOE_TASK_ST_CTX_TX_SGL_MODE,\n\t\t\t  (slow_sgl ? SCSI_TX_SLOW_SGL : SCSI_FAST_SGL));\n\t\tm_st_ctx->sgl_params.sgl_num_sges =\n\t\t\tcpu_to_le16(sgl_task_params->num_sges);\n\t} else {\n\t\t \n\t\tSET_FIELD(t_st_ctx->read_write.flags,\n\t\t\t  FCOE_TSTORM_FCOE_TASK_ST_CTX_READ_WRITE_RX_SGL_MODE,\n\t\t\t  (slow_sgl ? SCSI_TX_SLOW_SGL : SCSI_FAST_SGL));\n\n\t\t \n\t\tm_st_ctx->data_2_trns_rem = cpu_to_le32(io_size);\n\t\tinit_scsi_sgl_context(&m_st_ctx->sgl_params,\n\t\t\t\t      &m_st_ctx->data_desc,\n\t\t\t\t      sgl_task_params);\n\t}\n\n\t \n\tinit_common_sqe(task_params, SEND_FCOE_CMD);\n\n\treturn 0;\n}\n\nint init_initiator_midpath_unsolicited_fcoe_task(\n\tstruct fcoe_task_params *task_params,\n\tstruct fcoe_tx_mid_path_params *mid_path_fc_header,\n\tstruct scsi_sgl_task_params *tx_sgl_task_params,\n\tstruct scsi_sgl_task_params *rx_sgl_task_params,\n\tu8 fw_to_place_fc_header)\n{\n\tstruct fcoe_task_context *ctx = task_params->context;\n\tconst u8 val_byte = ctx->ystorm_ag_context.byte0;\n\tstruct ustorm_fcoe_task_ag_ctx *u_ag_ctx;\n\tstruct ystorm_fcoe_task_st_ctx *y_st_ctx;\n\tstruct tstorm_fcoe_task_st_ctx *t_st_ctx;\n\tstruct mstorm_fcoe_task_st_ctx *m_st_ctx;\n\tu32 val;\n\n\tmemset(ctx, 0, sizeof(*(ctx)));\n\tctx->ystorm_ag_context.byte0 = val_byte;\n\n\t \n\ty_st_ctx = &ctx->ystorm_st_context;\n\tinit_scsi_sgl_context(&y_st_ctx->sgl_params,\n\t\t\t      &y_st_ctx->data_desc,\n\t\t\t      tx_sgl_task_params);\n\tSET_FIELD(y_st_ctx->sgl_mode,\n\t\t  YSTORM_FCOE_TASK_ST_CTX_TX_SGL_MODE, SCSI_FAST_SGL);\n\ty_st_ctx->data_2_trns_rem = cpu_to_le32(task_params->tx_io_size);\n\ty_st_ctx->task_type = (u8)task_params->task_type;\n\tmemcpy(&y_st_ctx->tx_info_union.tx_params.mid_path,\n\t       mid_path_fc_header, sizeof(struct fcoe_tx_mid_path_params));\n\n\t \n\tm_st_ctx = &ctx->mstorm_st_context;\n\tinit_scsi_sgl_context(&m_st_ctx->sgl_params,\n\t\t\t      &m_st_ctx->data_desc,\n\t\t\t      rx_sgl_task_params);\n\tSET_FIELD(m_st_ctx->flags,\n\t\t  MSTORM_FCOE_TASK_ST_CTX_MP_INCLUDE_FC_HEADER,\n\t\t  fw_to_place_fc_header);\n\tm_st_ctx->data_2_trns_rem = cpu_to_le32(task_params->rx_io_size);\n\n\t \n\tt_st_ctx = &ctx->tstorm_st_context;\n\tt_st_ctx->read_only.cid = cpu_to_le32(task_params->conn_cid);\n\tval = cpu_to_le32(task_params->cq_rss_number);\n\tt_st_ctx->read_only.glbl_q_num = val;\n\tt_st_ctx->read_only.task_type = (u8)task_params->task_type;\n\tSET_FIELD(t_st_ctx->read_write.flags,\n\t\t  FCOE_TSTORM_FCOE_TASK_ST_CTX_READ_WRITE_EXP_FIRST_FRAME, 1);\n\tt_st_ctx->read_write.rx_id = cpu_to_le16(FCOE_RX_ID);\n\n\t \n\tu_ag_ctx = &ctx->ustorm_ag_context;\n\tu_ag_ctx->global_cq_num = cpu_to_le32(task_params->cq_rss_number);\n\n\t \n\tinit_common_sqe(task_params, SEND_FCOE_MIDPATH);\n\ttask_params->sqe->additional_info_union.burst_length =\n\t\t\t\t    tx_sgl_task_params->total_buffer_size;\n\tSET_FIELD(task_params->sqe->flags,\n\t\t  FCOE_WQE_NUM_SGES, tx_sgl_task_params->num_sges);\n\tSET_FIELD(task_params->sqe->flags, FCOE_WQE_SGL_MODE,\n\t\t  SCSI_FAST_SGL);\n\n\treturn 0;\n}\n\nint init_initiator_abort_fcoe_task(struct fcoe_task_params *task_params)\n{\n\tinit_common_sqe(task_params, SEND_FCOE_ABTS_REQUEST);\n\treturn 0;\n}\n\nint init_initiator_cleanup_fcoe_task(struct fcoe_task_params *task_params)\n{\n\tinit_common_sqe(task_params, FCOE_EXCHANGE_CLEANUP);\n\treturn 0;\n}\n\nint init_initiator_sequence_recovery_fcoe_task(\n\tstruct fcoe_task_params *task_params, u32 desired_offset)\n{\n\tinit_common_sqe(task_params, FCOE_SEQUENCE_RECOVERY);\n\ttask_params->sqe->additional_info_union.seq_rec_updated_offset =\n\t\t\t\t\t\t\t\tdesired_offset;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}