{
  "module_name": "scsi_netlink.c",
  "hash_id": "185a32db1a0c30bf1f152f06f4ee432612202452d6ce8bee760753b12d5f9e2f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/scsi/scsi_netlink.c",
  "human_readable_source": "\n \n#include <linux/time.h>\n#include <linux/jiffies.h>\n#include <linux/security.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/export.h>\n#include <net/sock.h>\n#include <net/netlink.h>\n\n#include <scsi/scsi_netlink.h>\n#include \"scsi_priv.h\"\n\nstruct sock *scsi_nl_sock = NULL;\nEXPORT_SYMBOL_GPL(scsi_nl_sock);\n\n \nstatic void\nscsi_nl_rcv_msg(struct sk_buff *skb)\n{\n\tstruct nlmsghdr *nlh;\n\tstruct scsi_nl_hdr *hdr;\n\tu32 rlen;\n\tint err, tport;\n\n\twhile (skb->len >= NLMSG_HDRLEN) {\n\t\terr = 0;\n\n\t\tnlh = nlmsg_hdr(skb);\n\t\tif ((nlh->nlmsg_len < (sizeof(*nlh) + sizeof(*hdr))) ||\n\t\t    (skb->len < nlh->nlmsg_len)) {\n\t\t\tprintk(KERN_WARNING \"%s: discarding partial skb\\n\",\n\t\t\t\t __func__);\n\t\t\treturn;\n\t\t}\n\n\t\trlen = NLMSG_ALIGN(nlh->nlmsg_len);\n\t\tif (rlen > skb->len)\n\t\t\trlen = skb->len;\n\n\t\tif (nlh->nlmsg_type != SCSI_TRANSPORT_MSG) {\n\t\t\terr = -EBADMSG;\n\t\t\tgoto next_msg;\n\t\t}\n\n\t\thdr = nlmsg_data(nlh);\n\t\tif ((hdr->version != SCSI_NL_VERSION) ||\n\t\t    (hdr->magic != SCSI_NL_MAGIC)) {\n\t\t\terr = -EPROTOTYPE;\n\t\t\tgoto next_msg;\n\t\t}\n\n\t\tif (!netlink_capable(skb, CAP_SYS_ADMIN)) {\n\t\t\terr = -EPERM;\n\t\t\tgoto next_msg;\n\t\t}\n\n\t\tif (nlh->nlmsg_len < (sizeof(*nlh) + hdr->msglen)) {\n\t\t\tprintk(KERN_WARNING \"%s: discarding partial message\\n\",\n\t\t\t\t __func__);\n\t\t\tgoto next_msg;\n\t\t}\n\n\t\t \n\t\ttport = hdr->transport;\n\t\tif (tport == SCSI_NL_TRANSPORT) {\n\t\t\tswitch (hdr->msgtype) {\n\t\t\tcase SCSI_NL_SHOST_VENDOR:\n\t\t\t\t \n\t\t\t\terr = -ESRCH;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\terr = -EBADR;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (err)\n\t\t\t\tprintk(KERN_WARNING \"%s: Msgtype %d failed - err %d\\n\",\n\t\t\t\t       __func__, hdr->msgtype, err);\n\t\t}\n\t\telse\n\t\t\terr = -ENOENT;\n\nnext_msg:\n\t\tif ((err) || (nlh->nlmsg_flags & NLM_F_ACK))\n\t\t\tnetlink_ack(skb, nlh, err, NULL);\n\n\t\tskb_pull(skb, rlen);\n\t}\n}\n\n \nvoid\nscsi_netlink_init(void)\n{\n\tstruct netlink_kernel_cfg cfg = {\n\t\t.input\t= scsi_nl_rcv_msg,\n\t\t.groups\t= SCSI_NL_GRP_CNT,\n\t};\n\n\tscsi_nl_sock = netlink_kernel_create(&init_net, NETLINK_SCSITRANSPORT,\n\t\t\t\t\t     &cfg);\n\tif (!scsi_nl_sock) {\n\t\tprintk(KERN_ERR \"%s: register of receive handler failed\\n\",\n\t\t\t\t__func__);\n\t\treturn;\n\t}\n\n\treturn;\n}\n\n\n \nvoid\nscsi_netlink_exit(void)\n{\n\tif (scsi_nl_sock) {\n\t\tnetlink_kernel_release(scsi_nl_sock);\n\t}\n\n\treturn;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}