{
  "module_name": "pcmad.c",
  "hash_id": "3a183d03a40e65eb0b47c017aeed23c6182d2be8f381afa30c8a562ecc187021",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/pcmad.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedidev.h>\n\n#define PCMAD_STATUS\t\t0\n#define PCMAD_LSB\t\t1\n#define PCMAD_MSB\t\t2\n#define PCMAD_CONVERT\t\t1\n\nstruct pcmad_board_struct {\n\tconst char *name;\n\tunsigned int ai_maxdata;\n};\n\nstatic const struct pcmad_board_struct pcmad_boards[] = {\n\t{\n\t\t.name\t\t= \"pcmad12\",\n\t\t.ai_maxdata\t= 0x0fff,\n\t}, {\n\t\t.name\t\t= \"pcmad16\",\n\t\t.ai_maxdata\t= 0xffff,\n\t},\n};\n\nstatic int pcmad_ai_eoc(struct comedi_device *dev,\n\t\t\tstruct comedi_subdevice *s,\n\t\t\tstruct comedi_insn *insn,\n\t\t\tunsigned long context)\n{\n\tunsigned int status;\n\n\tstatus = inb(dev->iobase + PCMAD_STATUS);\n\tif ((status & 0x3) == 0x3)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int pcmad_ai_insn_read(struct comedi_device *dev,\n\t\t\t      struct comedi_subdevice *s,\n\t\t\t      struct comedi_insn *insn,\n\t\t\t      unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int range = CR_RANGE(insn->chanspec);\n\tunsigned int val;\n\tint ret;\n\tint i;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\toutb(chan, dev->iobase + PCMAD_CONVERT);\n\n\t\tret = comedi_timeout(dev, s, insn, pcmad_ai_eoc, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tval = inb(dev->iobase + PCMAD_LSB) |\n\t\t      (inb(dev->iobase + PCMAD_MSB) << 8);\n\n\t\t \n\t\tif (s->maxdata == 0x0fff)\n\t\t\tval >>= 4;\n\n\t\tif (comedi_range_is_bipolar(s, range)) {\n\t\t\t \n\t\t\tval ^= ((s->maxdata + 1) >> 1);\n\t\t}\n\n\t\tdata[i] = val;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int pcmad_attach(struct comedi_device *dev, struct comedi_devconfig *it)\n{\n\tconst struct pcmad_board_struct *board = dev->board_ptr;\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_request_region(dev, it->options[0], 0x04);\n\tif (ret)\n\t\treturn ret;\n\n\tret = comedi_alloc_subdevices(dev, 1);\n\tif (ret)\n\t\treturn ret;\n\n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_AI;\n\tif (it->options[1]) {\n\t\t \n\t\ts->subdev_flags\t= SDF_READABLE | AREF_DIFF;\n\t\ts->n_chan\t= 8;\n\t} else {\n\t\t \n\t\ts->subdev_flags\t= SDF_READABLE | AREF_GROUND;\n\t\ts->n_chan\t= 16;\n\t}\n\ts->len_chanlist\t= 1;\n\ts->maxdata\t= board->ai_maxdata;\n\ts->range_table\t= it->options[2] ? &range_bipolar10 : &range_unipolar5;\n\ts->insn_read\t= pcmad_ai_insn_read;\n\n\treturn 0;\n}\n\nstatic struct comedi_driver pcmad_driver = {\n\t.driver_name\t= \"pcmad\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= pcmad_attach,\n\t.detach\t\t= comedi_legacy_detach,\n\t.board_name\t= &pcmad_boards[0].name,\n\t.num_names\t= ARRAY_SIZE(pcmad_boards),\n\t.offset\t\t= sizeof(pcmad_boards[0]),\n};\nmodule_comedi_driver(pcmad_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi low-level driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}