{
  "module_name": "aio_iiro_16.c",
  "hash_id": "019315de09d678d6c1a6899b7bf01bd7cd934ff3d00f63165878750967d7a6b7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/aio_iiro_16.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedidev.h>\n\n#define AIO_IIRO_16_RELAY_0_7\t\t0x00\n#define AIO_IIRO_16_INPUT_0_7\t\t0x01\n#define AIO_IIRO_16_IRQ\t\t\t0x02\n#define AIO_IIRO_16_RELAY_8_15\t\t0x04\n#define AIO_IIRO_16_INPUT_8_15\t\t0x05\n#define AIO_IIRO_16_STATUS\t\t0x07\n#define AIO_IIRO_16_STATUS_IRQE\t\tBIT(7)\n#define AIO_IIRO_16_STATUS_INPUT_8_15\tBIT(1)\n#define AIO_IIRO_16_STATUS_INPUT_0_7\tBIT(0)\n\nstatic unsigned int aio_iiro_16_read_inputs(struct comedi_device *dev)\n{\n\tunsigned int val;\n\n\tval = inb(dev->iobase + AIO_IIRO_16_INPUT_0_7);\n\tval |= inb(dev->iobase + AIO_IIRO_16_INPUT_8_15) << 8;\n\n\treturn val;\n}\n\nstatic irqreturn_t aio_iiro_16_cos(int irq, void *d)\n{\n\tstruct comedi_device *dev = d;\n\tstruct comedi_subdevice *s = dev->read_subdev;\n\tunsigned int status;\n\tunsigned int val;\n\n\tstatus = inb(dev->iobase + AIO_IIRO_16_STATUS);\n\tif (!(status & AIO_IIRO_16_STATUS_IRQE))\n\t\treturn IRQ_NONE;\n\n\tval = aio_iiro_16_read_inputs(dev);\n\tval |= (status << 16);\n\n\tcomedi_buf_write_samples(s, &val, 1);\n\tcomedi_handle_events(dev, s);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void aio_iiro_enable_irq(struct comedi_device *dev, bool enable)\n{\n\tif (enable)\n\t\tinb(dev->iobase + AIO_IIRO_16_IRQ);\n\telse\n\t\toutb(0, dev->iobase + AIO_IIRO_16_IRQ);\n}\n\nstatic int aio_iiro_16_cos_cancel(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s)\n{\n\taio_iiro_enable_irq(dev, false);\n\n\treturn 0;\n}\n\nstatic int aio_iiro_16_cos_cmd(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s)\n{\n\taio_iiro_enable_irq(dev, true);\n\n\treturn 0;\n}\n\nstatic int aio_iiro_16_cos_cmdtest(struct comedi_device *dev,\n\t\t\t\t   struct comedi_subdevice *s,\n\t\t\t\t   struct comedi_cmd *cmd)\n{\n\tint err = 0;\n\n\t \n\n\terr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);\n\terr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\n\terr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_NONE);\n\n\tif (err)\n\t\treturn 1;\n\n\t \n\t \n\n\t \n\n\terr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\n\t\t\t\t\t   cmd->chanlist_len);\n\terr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\n\n\tif (err)\n\t\treturn 3;\n\n\t \n\n\t \n\n\treturn 0;\n}\n\nstatic int aio_iiro_16_do_insn_bits(struct comedi_device *dev,\n\t\t\t\t    struct comedi_subdevice *s,\n\t\t\t\t    struct comedi_insn *insn,\n\t\t\t\t    unsigned int *data)\n{\n\tif (comedi_dio_update_state(s, data)) {\n\t\toutb(s->state & 0xff, dev->iobase + AIO_IIRO_16_RELAY_0_7);\n\t\toutb((s->state >> 8) & 0xff,\n\t\t     dev->iobase + AIO_IIRO_16_RELAY_8_15);\n\t}\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int aio_iiro_16_di_insn_bits(struct comedi_device *dev,\n\t\t\t\t    struct comedi_subdevice *s,\n\t\t\t\t    struct comedi_insn *insn,\n\t\t\t\t    unsigned int *data)\n{\n\tdata[1] = aio_iiro_16_read_inputs(dev);\n\n\treturn insn->n;\n}\n\nstatic int aio_iiro_16_attach(struct comedi_device *dev,\n\t\t\t      struct comedi_devconfig *it)\n{\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_request_region(dev, it->options[0], 0x8);\n\tif (ret)\n\t\treturn ret;\n\n\taio_iiro_enable_irq(dev, false);\n\n\t \n\tif ((1 << it->options[1]) & 0xdcfc) {\n\t\tret = request_irq(it->options[1], aio_iiro_16_cos, 0,\n\t\t\t\t  dev->board_name, dev);\n\t\tif (ret == 0)\n\t\t\tdev->irq = it->options[1];\n\t}\n\n\tret = comedi_alloc_subdevices(dev, 2);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_DO;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= 16;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= aio_iiro_16_do_insn_bits;\n\n\t \n\ts->state = inb(dev->iobase + AIO_IIRO_16_RELAY_0_7) |\n\t\t   (inb(dev->iobase + AIO_IIRO_16_RELAY_8_15) << 8);\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_DI;\n\ts->subdev_flags\t= SDF_READABLE;\n\ts->n_chan\t= 16;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= aio_iiro_16_di_insn_bits;\n\tif (dev->irq) {\n\t\tdev->read_subdev = s;\n\t\ts->subdev_flags\t|= SDF_CMD_READ | SDF_LSAMPL;\n\t\ts->len_chanlist\t= 1;\n\t\ts->do_cmdtest\t= aio_iiro_16_cos_cmdtest;\n\t\ts->do_cmd\t= aio_iiro_16_cos_cmd;\n\t\ts->cancel\t= aio_iiro_16_cos_cancel;\n\t}\n\n\treturn 0;\n}\n\nstatic struct comedi_driver aio_iiro_16_driver = {\n\t.driver_name\t= \"aio_iiro_16\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= aio_iiro_16_attach,\n\t.detach\t\t= comedi_legacy_detach,\n};\nmodule_comedi_driver(aio_iiro_16_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for Access I/O Products 104-IIRO-16 board\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}