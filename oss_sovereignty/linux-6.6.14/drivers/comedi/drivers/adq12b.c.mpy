{
  "module_name": "adq12b.c",
  "hash_id": "bc82c02bb46a47a956599c406eb0ce05271f7d68a4d81594a48f8e9d665299a8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/adq12b.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/comedi/comedidev.h>\n\n \n#define ADQ12B_CTREG\t\t0x00\n#define ADQ12B_CTREG_MSKP\tBIT(7)\t \n#define ADQ12B_CTREG_GTP\tBIT(6)\t \n#define ADQ12B_CTREG_RANGE(x)\t((x) << 4)\n#define ADQ12B_CTREG_CHAN(x)\t((x) << 0)\n#define ADQ12B_STINR\t\t0x00\n#define ADQ12B_STINR_OUT2\tBIT(7)\t \n#define ADQ12B_STINR_OUTP\tBIT(6)\t \n#define ADQ12B_STINR_EOC\tBIT(5)\t \n#define ADQ12B_STINR_IN_MASK\t(0x1f << 0)\n#define ADQ12B_OUTBR\t\t0x04\n#define ADQ12B_ADLOW\t\t0x08\n#define ADQ12B_ADHIG\t\t0x09\n#define ADQ12B_TIMER_BASE\t0x0c\n\n \nstatic const struct comedi_lrange range_adq12b_ai_bipolar = {\n\t4, {\n\t\tBIP_RANGE(5),\n\t\tBIP_RANGE(2),\n\t\tBIP_RANGE(1),\n\t\tBIP_RANGE(0.5)\n\t}\n};\n\nstatic const struct comedi_lrange range_adq12b_ai_unipolar = {\n\t4, {\n\t\tUNI_RANGE(5),\n\t\tUNI_RANGE(2),\n\t\tUNI_RANGE(1),\n\t\tUNI_RANGE(0.5)\n\t}\n};\n\nstruct adq12b_private {\n\tunsigned int last_ctreg;\n};\n\nstatic int adq12b_ai_eoc(struct comedi_device *dev,\n\t\t\t struct comedi_subdevice *s,\n\t\t\t struct comedi_insn *insn,\n\t\t\t unsigned long context)\n{\n\tunsigned char status;\n\n\tstatus = inb(dev->iobase + ADQ12B_STINR);\n\tif (status & ADQ12B_STINR_EOC)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int adq12b_ai_insn_read(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_insn *insn,\n\t\t\t       unsigned int *data)\n{\n\tstruct adq12b_private *devpriv = dev->private;\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int range = CR_RANGE(insn->chanspec);\n\tunsigned int val;\n\tint ret;\n\tint i;\n\n\t \n\tval = ADQ12B_CTREG_RANGE(range) | ADQ12B_CTREG_CHAN(chan);\n\tif (val != devpriv->last_ctreg) {\n\t\toutb(val, dev->iobase + ADQ12B_CTREG);\n\t\tdevpriv->last_ctreg = val;\n\t\tusleep_range(50, 100);\t \n\t}\n\n\tval = inb(dev->iobase + ADQ12B_ADLOW);\t \n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tret = comedi_timeout(dev, s, insn, adq12b_ai_eoc, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tval = inb(dev->iobase + ADQ12B_ADHIG) << 8;\n\t\tval |= inb(dev->iobase + ADQ12B_ADLOW);\t \n\n\t\tdata[i] = val;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int adq12b_di_insn_bits(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_insn *insn, unsigned int *data)\n{\n\t \n\tdata[1] = (inb(dev->iobase + ADQ12B_STINR) & ADQ12B_STINR_IN_MASK);\n\n\treturn insn->n;\n}\n\nstatic int adq12b_do_insn_bits(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_insn *insn,\n\t\t\t       unsigned int *data)\n{\n\tunsigned int mask;\n\tunsigned int chan;\n\tunsigned int val;\n\n\tmask = comedi_dio_update_state(s, data);\n\tif (mask) {\n\t\tfor (chan = 0; chan < 8; chan++) {\n\t\t\tif ((mask >> chan) & 0x01) {\n\t\t\t\tval = (s->state >> chan) & 0x01;\n\t\t\t\toutb((val << 3) | chan,\n\t\t\t\t     dev->iobase + ADQ12B_OUTBR);\n\t\t\t}\n\t\t}\n\t}\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int adq12b_attach(struct comedi_device *dev, struct comedi_devconfig *it)\n{\n\tstruct adq12b_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_request_region(dev, it->options[0], 0x10);\n\tif (ret)\n\t\treturn ret;\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\tdevpriv->last_ctreg = -1;\t \n\n\tret = comedi_alloc_subdevices(dev, 3);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_AI;\n\tif (it->options[2]) {\n\t\ts->subdev_flags\t= SDF_READABLE | SDF_DIFF;\n\t\ts->n_chan\t= 8;\n\t} else {\n\t\ts->subdev_flags\t= SDF_READABLE | SDF_GROUND;\n\t\ts->n_chan\t= 16;\n\t}\n\ts->maxdata\t= 0xfff;\n\ts->range_table\t= it->options[1] ? &range_adq12b_ai_unipolar\n\t\t\t\t\t : &range_adq12b_ai_bipolar;\n\ts->insn_read\t= adq12b_ai_insn_read;\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_DI;\n\ts->subdev_flags\t= SDF_READABLE;\n\ts->n_chan\t= 5;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= adq12b_di_insn_bits;\n\n\t \n\ts = &dev->subdevices[2];\n\ts->type\t\t= COMEDI_SUBD_DO;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= 8;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= adq12b_do_insn_bits;\n\n\treturn 0;\n}\n\nstatic struct comedi_driver adq12b_driver = {\n\t.driver_name\t= \"adq12b\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= adq12b_attach,\n\t.detach\t\t= comedi_legacy_detach,\n};\nmodule_comedi_driver(adq12b_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi low-level driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}