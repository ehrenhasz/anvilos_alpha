{
  "module_name": "ssv_dnp.c",
  "hash_id": "25a872a90766b0433c31a90636ad81c53662b44d8e032424805a7f0821eb6d13",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/ssv_dnp.c",
  "human_readable_source": "\n \n\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedidev.h>\n\n \n \n \n \n \n \n \n\n#define CSCIR 0x22\t\t \n#define CSCDR 0x23\t\t \n#define PAMR  0xa5\t\t \n#define PADR  0xa9\t\t \n#define PBMR  0xa4\t\t \n#define PBDR  0xa8\t\t \n#define PCMR  0xa3\t\t \n#define PCDR  0xa7\t\t \n\nstatic int dnp_dio_insn_bits(struct comedi_device *dev,\n\t\t\t     struct comedi_subdevice *s,\n\t\t\t     struct comedi_insn *insn,\n\t\t\t     unsigned int *data)\n{\n\tunsigned int mask;\n\tunsigned int val;\n\n\t \n\n\tmask = comedi_dio_update_state(s, data);\n\tif (mask) {\n\t\toutb(PADR, CSCIR);\n\t\toutb(s->state & 0xff, CSCDR);\n\n\t\toutb(PBDR, CSCIR);\n\t\toutb((s->state >> 8) & 0xff, CSCDR);\n\n\t\toutb(PCDR, CSCIR);\n\t\tval = inb(CSCDR) & 0x0f;\n\t\toutb(((s->state >> 12) & 0xf0) | val, CSCDR);\n\t}\n\n\toutb(PADR, CSCIR);\n\tval = inb(CSCDR);\n\toutb(PBDR, CSCIR);\n\tval |= (inb(CSCDR) << 8);\n\toutb(PCDR, CSCIR);\n\tval |= ((inb(CSCDR) & 0xf0) << 12);\n\n\tdata[1] = val;\n\n\treturn insn->n;\n}\n\nstatic int dnp_dio_insn_config(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_insn *insn,\n\t\t\t       unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int mask;\n\tunsigned int val;\n\tint ret;\n\n\tret = comedi_dio_insn_config(dev, s, insn, data, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tif (chan < 8) {\t\t\t \n\t\tmask = 1 << chan;\n\t\toutb(PAMR, CSCIR);\n\t} else if (chan < 16) {\t\t \n\t\tmask = 1 << (chan - 8);\n\t\toutb(PBMR, CSCIR);\n\t} else {\t\t\t \n\t\t \n\t\tmask = 1 << ((chan - 16) * 2);\n\t\toutb(PCMR, CSCIR);\n\t}\n\n\tval = inb(CSCDR);\n\tif (data[0] == COMEDI_OUTPUT)\n\t\tval |= mask;\n\telse\n\t\tval &= ~mask;\n\toutb(val, CSCDR);\n\n\treturn insn->n;\n}\n\nstatic int dnp_attach(struct comedi_device *dev, struct comedi_devconfig *it)\n{\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\t \n\n\tret = comedi_alloc_subdevices(dev, 1);\n\tif (ret)\n\t\treturn ret;\n\n\ts = &dev->subdevices[0];\n\t \n\ts->type = COMEDI_SUBD_DIO;\n\ts->subdev_flags = SDF_READABLE | SDF_WRITABLE;\n\ts->n_chan = 20;\n\ts->maxdata = 1;\n\ts->range_table = &range_digital;\n\ts->insn_bits = dnp_dio_insn_bits;\n\ts->insn_config = dnp_dio_insn_config;\n\n\t \n\toutb(PAMR, CSCIR);\n\toutb(0x00, CSCDR);\n\toutb(PBMR, CSCIR);\n\toutb(0x00, CSCDR);\n\toutb(PCMR, CSCIR);\n\toutb((inb(CSCDR) & 0xAA), CSCDR);\n\n\treturn 0;\n}\n\nstatic void dnp_detach(struct comedi_device *dev)\n{\n\toutb(PAMR, CSCIR);\n\toutb(0x00, CSCDR);\n\toutb(PBMR, CSCIR);\n\toutb(0x00, CSCDR);\n\toutb(PCMR, CSCIR);\n\toutb((inb(CSCDR) & 0xAA), CSCDR);\n}\n\nstatic struct comedi_driver dnp_driver = {\n\t.driver_name\t= \"dnp-1486\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= dnp_attach,\n\t.detach\t\t= dnp_detach,\n};\nmodule_comedi_driver(dnp_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi low-level driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}