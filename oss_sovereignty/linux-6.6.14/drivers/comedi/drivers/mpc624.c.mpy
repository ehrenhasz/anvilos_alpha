{
  "module_name": "mpc624.c",
  "hash_id": "89d0e1eb6188e681bea450014c7cb81aac914962692f8d4659ac3448a340d214",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/mpc624.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedidev.h>\n#include <linux/delay.h>\n\n \n#define MPC624_MASTER_CONTROL\t0  \n#define MPC624_GNMUXCH\t\t1  \n#define MPC624_ADC\t\t2  \n#define MPC624_EE\t\t3  \n#define MPC624_LEDS\t\t4  \n#define MPC624_DIO\t\t5  \n#define MPC624_IRQ_MASK\t\t6  \n\n \n#define MPC624_ADBUSY\t\tBIT(5)\n#define MPC624_ADSDO\t\tBIT(4)\n#define MPC624_ADFO\t\tBIT(3)\n#define MPC624_ADCS\t\tBIT(2)\n#define MPC624_ADSCK\t\tBIT(1)\n#define MPC624_ADSDI\t\tBIT(0)\n\n \n#define MPC624_EOC_BIT\t\tBIT(31)\n#define MPC624_DMY_BIT\t\tBIT(30)\n#define MPC624_SGN_BIT\t\tBIT(29)\n\n \n#define MPC624_OSR(x)\t\t(((x) & 0x1f) << 27)\n#define MPC624_SPEED_3_52_KHZ\tMPC624_OSR(0x11)\n#define MPC624_SPEED_1_76_KHZ\tMPC624_OSR(0x12)\n#define MPC624_SPEED_880_HZ\tMPC624_OSR(0x13)\n#define MPC624_SPEED_440_HZ\tMPC624_OSR(0x14)\n#define MPC624_SPEED_220_HZ\tMPC624_OSR(0x15)\n#define MPC624_SPEED_110_HZ\tMPC624_OSR(0x16)\n#define MPC624_SPEED_55_HZ\tMPC624_OSR(0x17)\n#define MPC624_SPEED_27_5_HZ\tMPC624_OSR(0x18)\n#define MPC624_SPEED_13_75_HZ\tMPC624_OSR(0x19)\n#define MPC624_SPEED_6_875_HZ\tMPC624_OSR(0x1f)\n\nstruct mpc624_private {\n\tunsigned int ai_speed;\n};\n\n \nstatic const struct comedi_lrange range_mpc624_bipolar1 = {\n\t1,\n\t{\n \n\t  \n\t BIP_RANGE(2.02)\n\t}\n};\n\nstatic const struct comedi_lrange range_mpc624_bipolar10 = {\n\t1,\n\t{\n \n\t  \n\t BIP_RANGE(20.2)\n\t}\n};\n\nstatic unsigned int mpc624_ai_get_sample(struct comedi_device *dev,\n\t\t\t\t\t struct comedi_subdevice *s)\n{\n\tstruct mpc624_private *devpriv = dev->private;\n\tunsigned int data_out = devpriv->ai_speed;\n\tunsigned int data_in = 0;\n\tunsigned int bit;\n\tint i;\n\n\t \n\tudelay(1);\n\tfor (i = 0; i < 32; i++) {\n\t\t \n\t\toutb(0, dev->iobase + MPC624_ADC);\n\t\tudelay(1);\n\n\t\t \n\t\tbit = (data_out & BIT(31)) ? MPC624_ADSDI : 0;\n\t\toutb(bit, dev->iobase + MPC624_ADC);\n\t\tudelay(1);\n\n\t\t \n\t\toutb(MPC624_ADSCK | bit, dev->iobase + MPC624_ADC);\n\t\tudelay(1);\n\n\t\t \n\t\tdata_in <<= 1;\n\t\tdata_in |= (inb(dev->iobase + MPC624_ADC) & MPC624_ADSDO) >> 4;\n\t\tudelay(1);\n\n\t\tdata_out <<= 1;\n\t}\n\n\t \n\tif (data_in & MPC624_EOC_BIT)\n\t\tdev_dbg(dev->class_dev, \"EOC bit is set!\");\n\tif (data_in & MPC624_DMY_BIT)\n\t\tdev_dbg(dev->class_dev, \"DMY bit is set!\");\n\n\tif (data_in & MPC624_SGN_BIT) {\n\t\t \n\t\tdata_in &= 0x3fffffff;\n\t} else {\n\t\t \n\t\tdata_in |= MPC624_SGN_BIT;\n\t\tdata_in = ~data_in;\n\t\tdata_in += 1;\n\t\t \n\t\tdata_in &= ~(MPC624_EOC_BIT | MPC624_DMY_BIT);\n\t\tdata_in = 0x20000000 - data_in;\n\t}\n\treturn data_in;\n}\n\nstatic int mpc624_ai_eoc(struct comedi_device *dev,\n\t\t\t struct comedi_subdevice *s,\n\t\t\t struct comedi_insn *insn,\n\t\t\t unsigned long context)\n{\n\tunsigned char status;\n\n\tstatus = inb(dev->iobase + MPC624_ADC);\n\tif ((status & MPC624_ADBUSY) == 0)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int mpc624_ai_insn_read(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_insn *insn,\n\t\t\t       unsigned int *data)\n{\n\tint ret;\n\tint i;\n\n\t \n\toutb(insn->chanspec, dev->iobase + MPC624_GNMUXCH);\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\t \n\t\toutb(MPC624_ADSCK, dev->iobase + MPC624_ADC);\n\t\tudelay(1);\n\t\toutb(MPC624_ADCS | MPC624_ADSCK, dev->iobase + MPC624_ADC);\n\t\tudelay(1);\n\t\toutb(0, dev->iobase + MPC624_ADC);\n\t\tudelay(1);\n\n\t\t \n\t\tret = comedi_timeout(dev, s, insn, mpc624_ai_eoc, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tdata[i] = mpc624_ai_get_sample(dev, s);\n\t}\n\n\treturn insn->n;\n}\n\nstatic int mpc624_attach(struct comedi_device *dev, struct comedi_devconfig *it)\n{\n\tstruct mpc624_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_request_region(dev, it->options[0], 0x10);\n\tif (ret)\n\t\treturn ret;\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\tswitch (it->options[1]) {\n\tcase 0:\n\t\tdevpriv->ai_speed = MPC624_SPEED_3_52_KHZ;\n\t\tbreak;\n\tcase 1:\n\t\tdevpriv->ai_speed = MPC624_SPEED_1_76_KHZ;\n\t\tbreak;\n\tcase 2:\n\t\tdevpriv->ai_speed = MPC624_SPEED_880_HZ;\n\t\tbreak;\n\tcase 3:\n\t\tdevpriv->ai_speed = MPC624_SPEED_440_HZ;\n\t\tbreak;\n\tcase 4:\n\t\tdevpriv->ai_speed = MPC624_SPEED_220_HZ;\n\t\tbreak;\n\tcase 5:\n\t\tdevpriv->ai_speed = MPC624_SPEED_110_HZ;\n\t\tbreak;\n\tcase 6:\n\t\tdevpriv->ai_speed = MPC624_SPEED_55_HZ;\n\t\tbreak;\n\tcase 7:\n\t\tdevpriv->ai_speed = MPC624_SPEED_27_5_HZ;\n\t\tbreak;\n\tcase 8:\n\t\tdevpriv->ai_speed = MPC624_SPEED_13_75_HZ;\n\t\tbreak;\n\tcase 9:\n\t\tdevpriv->ai_speed = MPC624_SPEED_6_875_HZ;\n\t\tbreak;\n\tdefault:\n\t\tdevpriv->ai_speed = MPC624_SPEED_3_52_KHZ;\n\t}\n\n\tret = comedi_alloc_subdevices(dev, 1);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_AI;\n\ts->subdev_flags\t= SDF_READABLE | SDF_DIFF;\n\ts->n_chan\t= 4;\n\ts->maxdata\t= 0x3fffffff;\n\ts->range_table\t= (it->options[1] == 0) ? &range_mpc624_bipolar1\n\t\t\t\t\t\t: &range_mpc624_bipolar10;\n\ts->insn_read\t= mpc624_ai_insn_read;\n\n\treturn 0;\n}\n\nstatic struct comedi_driver mpc624_driver = {\n\t.driver_name\t= \"mpc624\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= mpc624_attach,\n\t.detach\t\t= comedi_legacy_detach,\n};\nmodule_comedi_driver(mpc624_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for Micro/sys MPC-624 PC/104 board\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}