{
  "module_name": "adv_pci1724.c",
  "hash_id": "3e9e69afcd0526a7648efbff5b7bfadff00dffc61a6ac2c96386ab9c38d1f684",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/adv_pci1724.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedi_pci.h>\n\n \n#define PCI1724_DAC_CTRL_REG\t\t0x00\n#define PCI1724_DAC_CTRL_GX(x)\t\tBIT(20 + ((x) / 8))\n#define PCI1724_DAC_CTRL_CX(x)\t\t(((x) % 8) << 16)\n#define PCI1724_DAC_CTRL_MODE(x)\t(((x) & 0x3) << 14)\n#define PCI1724_DAC_CTRL_MODE_GAIN\tPCI1724_DAC_CTRL_MODE(1)\n#define PCI1724_DAC_CTRL_MODE_OFFSET\tPCI1724_DAC_CTRL_MODE(2)\n#define PCI1724_DAC_CTRL_MODE_NORMAL\tPCI1724_DAC_CTRL_MODE(3)\n#define PCI1724_DAC_CTRL_MODE_MASK\tPCI1724_DAC_CTRL_MODE(3)\n#define PCI1724_DAC_CTRL_DATA(x)\t(((x) & 0x3fff) << 0)\n#define PCI1724_SYNC_CTRL_REG\t\t0x04\n#define PCI1724_SYNC_CTRL_DACSTAT\tBIT(1)\n#define PCI1724_SYNC_CTRL_SYN\t\tBIT(0)\n#define PCI1724_EEPROM_CTRL_REG\t\t0x08\n#define PCI1724_SYNC_TRIG_REG\t\t0x0c   \n#define PCI1724_BOARD_ID_REG\t\t0x10\n#define PCI1724_BOARD_ID_MASK\t\t(0xf << 0)\n\nstatic const struct comedi_lrange adv_pci1724_ao_ranges = {\n\t4, {\n\t\tBIP_RANGE(10),\n\t\tRANGE_mA(0, 20),\n\t\tRANGE_mA(4, 20),\n\t\tRANGE_unitless(0, 1)\n\t}\n};\n\nstatic int adv_pci1724_dac_idle(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned long context)\n{\n\tunsigned int status;\n\n\tstatus = inl(dev->iobase + PCI1724_SYNC_CTRL_REG);\n\tif ((status & PCI1724_SYNC_CTRL_DACSTAT) == 0)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int adv_pci1724_insn_write(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s,\n\t\t\t\t  struct comedi_insn *insn,\n\t\t\t\t  unsigned int *data)\n{\n\tunsigned long mode = (unsigned long)s->private;\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int ctrl;\n\tint ret;\n\tint i;\n\n\tctrl = PCI1724_DAC_CTRL_GX(chan) | PCI1724_DAC_CTRL_CX(chan) | mode;\n\n\t \n\toutl(0, dev->iobase + PCI1724_SYNC_CTRL_REG);\n\n\tfor (i = 0; i < insn->n; ++i) {\n\t\tunsigned int val = data[i];\n\n\t\tret = comedi_timeout(dev, s, insn, adv_pci1724_dac_idle, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\toutl(ctrl | PCI1724_DAC_CTRL_DATA(val),\n\t\t     dev->iobase + PCI1724_DAC_CTRL_REG);\n\n\t\ts->readback[chan] = val;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int adv_pci1724_auto_attach(struct comedi_device *dev,\n\t\t\t\t   unsigned long context_unused)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tstruct comedi_subdevice *s;\n\tunsigned int board_id;\n\tint ret;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tdev->iobase = pci_resource_start(pcidev, 2);\n\tboard_id = inl(dev->iobase + PCI1724_BOARD_ID_REG);\n\tdev_info(dev->class_dev, \"board id: %d\\n\",\n\t\t board_id & PCI1724_BOARD_ID_MASK);\n\n\tret = comedi_alloc_subdevices(dev, 3);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_AO;\n\ts->subdev_flags\t= SDF_READABLE | SDF_WRITABLE | SDF_GROUND;\n\ts->n_chan\t= 32;\n\ts->maxdata\t= 0x3fff;\n\ts->range_table\t= &adv_pci1724_ao_ranges;\n\ts->insn_write\t= adv_pci1724_insn_write;\n\ts->private\t= (void *)PCI1724_DAC_CTRL_MODE_NORMAL;\n\n\tret = comedi_alloc_subdev_readback(s);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_CALIB;\n\ts->subdev_flags\t= SDF_READABLE | SDF_WRITABLE | SDF_INTERNAL;\n\ts->n_chan\t= 32;\n\ts->maxdata\t= 0x3fff;\n\ts->insn_write\t= adv_pci1724_insn_write;\n\ts->private\t= (void *)PCI1724_DAC_CTRL_MODE_OFFSET;\n\n\tret = comedi_alloc_subdev_readback(s);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[2];\n\ts->type\t\t= COMEDI_SUBD_CALIB;\n\ts->subdev_flags\t= SDF_READABLE | SDF_WRITABLE | SDF_INTERNAL;\n\ts->n_chan\t= 32;\n\ts->maxdata\t= 0x3fff;\n\ts->insn_write\t= adv_pci1724_insn_write;\n\ts->private\t= (void *)PCI1724_DAC_CTRL_MODE_GAIN;\n\n\treturn comedi_alloc_subdev_readback(s);\n}\n\nstatic struct comedi_driver adv_pci1724_driver = {\n\t.driver_name\t= \"adv_pci1724\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= adv_pci1724_auto_attach,\n\t.detach\t\t= comedi_pci_detach,\n};\n\nstatic int adv_pci1724_pci_probe(struct pci_dev *dev,\n\t\t\t\t const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &adv_pci1724_driver,\n\t\t\t\t      id->driver_data);\n}\n\nstatic const struct pci_device_id adv_pci1724_pci_table[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_ADVANTECH, 0x1724) },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, adv_pci1724_pci_table);\n\nstatic struct pci_driver adv_pci1724_pci_driver = {\n\t.name\t\t= \"adv_pci1724\",\n\t.id_table\t= adv_pci1724_pci_table,\n\t.probe\t\t= adv_pci1724_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(adv_pci1724_driver, adv_pci1724_pci_driver);\n\nMODULE_AUTHOR(\"Frank Mori Hess <fmh6jj@gmail.com>\");\nMODULE_DESCRIPTION(\"Advantech PCI-1724U Comedi driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}