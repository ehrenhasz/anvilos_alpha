{
  "module_name": "addi_apci_16xx.c",
  "hash_id": "304eb52e299ff0470ec55916230cc84aa15ee9d44c2be175c8c35fc940cfd3b8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/addi_apci_16xx.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedi_pci.h>\n\n \n#define APCI16XX_IN_REG(x)\t\t(((x) * 4) + 0x08)\n#define APCI16XX_OUT_REG(x)\t\t(((x) * 4) + 0x14)\n#define APCI16XX_DIR_REG(x)\t\t(((x) * 4) + 0x20)\n\nenum apci16xx_boardid {\n\tBOARD_APCI1648,\n\tBOARD_APCI1696,\n};\n\nstruct apci16xx_boardinfo {\n\tconst char *name;\n\tint n_chan;\n};\n\nstatic const struct apci16xx_boardinfo apci16xx_boardtypes[] = {\n\t[BOARD_APCI1648] = {\n\t\t.name\t\t= \"apci1648\",\n\t\t.n_chan\t\t= 48,\t\t \n\t},\n\t[BOARD_APCI1696] = {\n\t\t.name\t\t= \"apci1696\",\n\t\t.n_chan\t\t= 96,\t\t \n\t},\n};\n\nstatic int apci16xx_insn_config(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int mask;\n\tint ret;\n\n\tif (chan < 8)\n\t\tmask = 0x000000ff;\n\telse if (chan < 16)\n\t\tmask = 0x0000ff00;\n\telse if (chan < 24)\n\t\tmask = 0x00ff0000;\n\telse\n\t\tmask = 0xff000000;\n\n\tret = comedi_dio_insn_config(dev, s, insn, data, mask);\n\tif (ret)\n\t\treturn ret;\n\n\toutl(s->io_bits, dev->iobase + APCI16XX_DIR_REG(s->index));\n\n\treturn insn->n;\n}\n\nstatic int apci16xx_dio_insn_bits(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s,\n\t\t\t\t  struct comedi_insn *insn,\n\t\t\t\t  unsigned int *data)\n{\n\tif (comedi_dio_update_state(s, data))\n\t\toutl(s->state, dev->iobase + APCI16XX_OUT_REG(s->index));\n\n\tdata[1] = inl(dev->iobase + APCI16XX_IN_REG(s->index));\n\n\treturn insn->n;\n}\n\nstatic int apci16xx_auto_attach(struct comedi_device *dev,\n\t\t\t\tunsigned long context)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tconst struct apci16xx_boardinfo *board = NULL;\n\tstruct comedi_subdevice *s;\n\tunsigned int n_subdevs;\n\tunsigned int last;\n\tint i;\n\tint ret;\n\n\tif (context < ARRAY_SIZE(apci16xx_boardtypes))\n\t\tboard = &apci16xx_boardtypes[context];\n\tif (!board)\n\t\treturn -ENODEV;\n\tdev->board_ptr = board;\n\tdev->board_name = board->name;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tdev->iobase = pci_resource_start(pcidev, 0);\n\n\t \n\tn_subdevs = board->n_chan / 32;\n\tif ((n_subdevs * 32) < board->n_chan) {\n\t\tlast = board->n_chan - (n_subdevs * 32);\n\t\tn_subdevs++;\n\t} else {\n\t\tlast = 0;\n\t}\n\n\tret = comedi_alloc_subdevices(dev, n_subdevs);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tfor (i = 0; i < n_subdevs; i++) {\n\t\ts = &dev->subdevices[i];\n\t\ts->type\t\t= COMEDI_SUBD_DIO;\n\t\ts->subdev_flags\t= SDF_WRITABLE | SDF_READABLE;\n\t\ts->n_chan\t= ((i * 32) < board->n_chan) ? 32 : last;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_config\t= apci16xx_insn_config;\n\t\ts->insn_bits\t= apci16xx_dio_insn_bits;\n\n\t\t \n\t\ts->io_bits\t= 0;\n\t\toutl(s->io_bits, dev->iobase + APCI16XX_DIR_REG(i));\n\t}\n\n\treturn 0;\n}\n\nstatic struct comedi_driver apci16xx_driver = {\n\t.driver_name\t= \"addi_apci_16xx\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= apci16xx_auto_attach,\n\t.detach\t\t= comedi_pci_detach,\n};\n\nstatic int apci16xx_pci_probe(struct pci_dev *dev,\n\t\t\t      const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &apci16xx_driver, id->driver_data);\n}\n\nstatic const struct pci_device_id apci16xx_pci_table[] = {\n\t{ PCI_VDEVICE(ADDIDATA, 0x1009), BOARD_APCI1648 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x100a), BOARD_APCI1696 },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, apci16xx_pci_table);\n\nstatic struct pci_driver apci16xx_pci_driver = {\n\t.name\t\t= \"addi_apci_16xx\",\n\t.id_table\t= apci16xx_pci_table,\n\t.probe\t\t= apci16xx_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(apci16xx_driver, apci16xx_pci_driver);\n\nMODULE_DESCRIPTION(\"ADDI-DATA APCI-1648/1696, TTL I/O boards\");\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}