{
  "module_name": "comedi_8255.c",
  "hash_id": "7d1c308f74a546d9fa758c931073af63e7cb487d3a583a1ba640e41b38bc9cac",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/comedi_8255.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedidev.h>\n#include <linux/comedi/comedi_8255.h>\n\nstruct subdev_8255_private {\n\tunsigned long regbase;\n\tint (*io)(struct comedi_device *dev, int dir, int port, int data,\n\t\t  unsigned long regbase);\n};\n\nstatic int subdev_8255_io(struct comedi_device *dev,\n\t\t\t  int dir, int port, int data, unsigned long regbase)\n{\n\tif (dir) {\n\t\toutb(data, dev->iobase + regbase + port);\n\t\treturn 0;\n\t}\n\treturn inb(dev->iobase + regbase + port);\n}\n\nstatic int subdev_8255_mmio(struct comedi_device *dev,\n\t\t\t    int dir, int port, int data, unsigned long regbase)\n{\n\tif (dir) {\n\t\twriteb(data, dev->mmio + regbase + port);\n\t\treturn 0;\n\t}\n\treturn readb(dev->mmio + regbase + port);\n}\n\nstatic int subdev_8255_insn(struct comedi_device *dev,\n\t\t\t    struct comedi_subdevice *s,\n\t\t\t    struct comedi_insn *insn,\n\t\t\t    unsigned int *data)\n{\n\tstruct subdev_8255_private *spriv = s->private;\n\tunsigned long regbase = spriv->regbase;\n\tunsigned int mask;\n\tunsigned int v;\n\n\tmask = comedi_dio_update_state(s, data);\n\tif (mask) {\n\t\tif (mask & 0xff)\n\t\t\tspriv->io(dev, 1, I8255_DATA_A_REG,\n\t\t\t\t  s->state & 0xff, regbase);\n\t\tif (mask & 0xff00)\n\t\t\tspriv->io(dev, 1, I8255_DATA_B_REG,\n\t\t\t\t  (s->state >> 8) & 0xff, regbase);\n\t\tif (mask & 0xff0000)\n\t\t\tspriv->io(dev, 1, I8255_DATA_C_REG,\n\t\t\t\t  (s->state >> 16) & 0xff, regbase);\n\t}\n\n\tv = spriv->io(dev, 0, I8255_DATA_A_REG, 0, regbase);\n\tv |= (spriv->io(dev, 0, I8255_DATA_B_REG, 0, regbase) << 8);\n\tv |= (spriv->io(dev, 0, I8255_DATA_C_REG, 0, regbase) << 16);\n\n\tdata[1] = v;\n\n\treturn insn->n;\n}\n\nstatic void subdev_8255_do_config(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s)\n{\n\tstruct subdev_8255_private *spriv = s->private;\n\tunsigned long regbase = spriv->regbase;\n\tint config;\n\n\tconfig = I8255_CTRL_CW;\n\t \n\tif (!(s->io_bits & 0x0000ff))\n\t\tconfig |= I8255_CTRL_A_IO;\n\tif (!(s->io_bits & 0x00ff00))\n\t\tconfig |= I8255_CTRL_B_IO;\n\tif (!(s->io_bits & 0x0f0000))\n\t\tconfig |= I8255_CTRL_C_LO_IO;\n\tif (!(s->io_bits & 0xf00000))\n\t\tconfig |= I8255_CTRL_C_HI_IO;\n\n\tspriv->io(dev, 1, I8255_CTRL_REG, config, regbase);\n}\n\nstatic int subdev_8255_insn_config(struct comedi_device *dev,\n\t\t\t\t   struct comedi_subdevice *s,\n\t\t\t\t   struct comedi_insn *insn,\n\t\t\t\t   unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int mask;\n\tint ret;\n\n\tif (chan < 8)\n\t\tmask = 0x0000ff;\n\telse if (chan < 16)\n\t\tmask = 0x00ff00;\n\telse if (chan < 20)\n\t\tmask = 0x0f0000;\n\telse\n\t\tmask = 0xf00000;\n\n\tret = comedi_dio_insn_config(dev, s, insn, data, mask);\n\tif (ret)\n\t\treturn ret;\n\n\tsubdev_8255_do_config(dev, s);\n\n\treturn insn->n;\n}\n\nstatic int __subdev_8255_init(struct comedi_device *dev,\n\t\t\t      struct comedi_subdevice *s,\n\t\t\t      int (*io)(struct comedi_device *dev,\n\t\t\t\t\tint dir, int port, int data,\n\t\t\t\t\tunsigned long regbase),\n\t\t\t      unsigned long regbase,\n\t\t\t      bool is_mmio)\n{\n\tstruct subdev_8255_private *spriv;\n\n\tspriv = comedi_alloc_spriv(s, sizeof(*spriv));\n\tif (!spriv)\n\t\treturn -ENOMEM;\n\n\tif (io)\n\t\tspriv->io = io;\n\telse if (is_mmio)\n\t\tspriv->io = subdev_8255_mmio;\n\telse\n\t\tspriv->io = subdev_8255_io;\n\tspriv->regbase\t= regbase;\n\n\ts->type\t\t= COMEDI_SUBD_DIO;\n\ts->subdev_flags\t= SDF_READABLE | SDF_WRITABLE;\n\ts->n_chan\t= 24;\n\ts->range_table\t= &range_digital;\n\ts->maxdata\t= 1;\n\ts->insn_bits\t= subdev_8255_insn;\n\ts->insn_config\t= subdev_8255_insn_config;\n\n\tsubdev_8255_do_config(dev, s);\n\n\treturn 0;\n}\n\n \nint subdev_8255_init(struct comedi_device *dev, struct comedi_subdevice *s,\n\t\t     int (*io)(struct comedi_device *dev, int dir, int port,\n\t\t\t       int data, unsigned long regbase),\n\t\t     unsigned long regbase)\n{\n\treturn __subdev_8255_init(dev, s, io, regbase, false);\n}\nEXPORT_SYMBOL_GPL(subdev_8255_init);\n\n \nint subdev_8255_mm_init(struct comedi_device *dev, struct comedi_subdevice *s,\n\t\t\tint (*io)(struct comedi_device *dev, int dir, int port,\n\t\t\t\t  int data, unsigned long regbase),\n\t\t\tunsigned long regbase)\n{\n\treturn __subdev_8255_init(dev, s, io, regbase, true);\n}\nEXPORT_SYMBOL_GPL(subdev_8255_mm_init);\n\n \nunsigned long subdev_8255_regbase(struct comedi_subdevice *s)\n{\n\tstruct subdev_8255_private *spriv = s->private;\n\n\treturn spriv->regbase;\n}\nEXPORT_SYMBOL_GPL(subdev_8255_regbase);\n\nstatic int __init comedi_8255_module_init(void)\n{\n\treturn 0;\n}\nmodule_init(comedi_8255_module_init);\n\nstatic void __exit comedi_8255_module_exit(void)\n{\n}\nmodule_exit(comedi_8255_module_exit);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi: Generic 8255 digital I/O support\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}