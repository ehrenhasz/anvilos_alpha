{
  "module_name": "addi_apci_3xxx.c",
  "hash_id": "57527587dcda0a8017d63faf7ff732738c21163166ba926d9f5d9b5d6a349df9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/addi_apci_3xxx.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedi_pci.h>\n\n#define CONV_UNIT_NS\t\tBIT(0)\n#define CONV_UNIT_US\t\tBIT(1)\n#define CONV_UNIT_MS\t\tBIT(2)\n\nstatic const struct comedi_lrange apci3xxx_ai_range = {\n\t8, {\n\t\tBIP_RANGE(10),\n\t\tBIP_RANGE(5),\n\t\tBIP_RANGE(2),\n\t\tBIP_RANGE(1),\n\t\tUNI_RANGE(10),\n\t\tUNI_RANGE(5),\n\t\tUNI_RANGE(2),\n\t\tUNI_RANGE(1)\n\t}\n};\n\nstatic const struct comedi_lrange apci3xxx_ao_range = {\n\t2, {\n\t\tBIP_RANGE(10),\n\t\tUNI_RANGE(10)\n\t}\n};\n\nenum apci3xxx_boardid {\n\tBOARD_APCI3000_16,\n\tBOARD_APCI3000_8,\n\tBOARD_APCI3000_4,\n\tBOARD_APCI3006_16,\n\tBOARD_APCI3006_8,\n\tBOARD_APCI3006_4,\n\tBOARD_APCI3010_16,\n\tBOARD_APCI3010_8,\n\tBOARD_APCI3010_4,\n\tBOARD_APCI3016_16,\n\tBOARD_APCI3016_8,\n\tBOARD_APCI3016_4,\n\tBOARD_APCI3100_16_4,\n\tBOARD_APCI3100_8_4,\n\tBOARD_APCI3106_16_4,\n\tBOARD_APCI3106_8_4,\n\tBOARD_APCI3110_16_4,\n\tBOARD_APCI3110_8_4,\n\tBOARD_APCI3116_16_4,\n\tBOARD_APCI3116_8_4,\n\tBOARD_APCI3003,\n\tBOARD_APCI3002_16,\n\tBOARD_APCI3002_8,\n\tBOARD_APCI3002_4,\n\tBOARD_APCI3500,\n};\n\nstruct apci3xxx_boardinfo {\n\tconst char *name;\n\tint ai_subdev_flags;\n\tint ai_n_chan;\n\tunsigned int ai_maxdata;\n\tunsigned char ai_conv_units;\n\tunsigned int ai_min_acq_ns;\n\tunsigned int has_ao:1;\n\tunsigned int has_dig_in:1;\n\tunsigned int has_dig_out:1;\n\tunsigned int has_ttl_io:1;\n};\n\nstatic const struct apci3xxx_boardinfo apci3xxx_boardtypes[] = {\n\t[BOARD_APCI3000_16] = {\n\t\t.name\t\t\t= \"apci3000-16\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 16,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3000_8] = {\n\t\t.name\t\t\t= \"apci3000-8\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 8,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3000_4] = {\n\t\t.name\t\t\t= \"apci3000-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 4,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3006_16] = {\n\t\t.name\t\t\t= \"apci3006-16\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 16,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3006_8] = {\n\t\t.name\t\t\t= \"apci3006-8\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 8,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3006_4] = {\n\t\t.name\t\t\t= \"apci3006-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 4,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3010_16] = {\n\t\t.name\t\t\t= \"apci3010-16\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 16,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3010_8] = {\n\t\t.name\t\t\t= \"apci3010-8\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 8,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3010_4] = {\n\t\t.name\t\t\t= \"apci3010-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 4,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3016_16] = {\n\t\t.name\t\t\t= \"apci3016-16\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 16,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3016_8] = {\n\t\t.name\t\t\t= \"apci3016-8\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 8,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3016_4] = {\n\t\t.name\t\t\t= \"apci3016-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 4,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3100_16_4] = {\n\t\t.name\t\t\t= \"apci3100-16-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 16,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ao\t\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3100_8_4] = {\n\t\t.name\t\t\t= \"apci3100-8-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 8,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ao\t\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3106_16_4] = {\n\t\t.name\t\t\t= \"apci3106-16-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 16,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ao\t\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3106_8_4] = {\n\t\t.name\t\t\t= \"apci3106-8-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 8,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 10000,\n\t\t.has_ao\t\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3110_16_4] = {\n\t\t.name\t\t\t= \"apci3110-16-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 16,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_ao\t\t\t= 1,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3110_8_4] = {\n\t\t.name\t\t\t= \"apci3110-8-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 8,\n\t\t.ai_maxdata\t\t= 0x0fff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_ao\t\t\t= 1,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3116_16_4] = {\n\t\t.name\t\t\t= \"apci3116-16-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 16,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_ao\t\t\t= 1,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3116_8_4] = {\n\t\t.name\t\t\t= \"apci3116-8-4\",\n\t\t.ai_subdev_flags\t= SDF_COMMON | SDF_GROUND | SDF_DIFF,\n\t\t.ai_n_chan\t\t= 8,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_ao\t\t\t= 1,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n\t[BOARD_APCI3003] = {\n\t\t.name\t\t\t= \"apci3003\",\n\t\t.ai_subdev_flags\t= SDF_DIFF,\n\t\t.ai_n_chan\t\t= 4,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US |\n\t\t\t\t\t  CONV_UNIT_NS,\n\t\t.ai_min_acq_ns\t\t= 2500,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t},\n\t[BOARD_APCI3002_16] = {\n\t\t.name\t\t\t= \"apci3002-16\",\n\t\t.ai_subdev_flags\t= SDF_DIFF,\n\t\t.ai_n_chan\t\t= 16,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t},\n\t[BOARD_APCI3002_8] = {\n\t\t.name\t\t\t= \"apci3002-8\",\n\t\t.ai_subdev_flags\t= SDF_DIFF,\n\t\t.ai_n_chan\t\t= 8,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t},\n\t[BOARD_APCI3002_4] = {\n\t\t.name\t\t\t= \"apci3002-4\",\n\t\t.ai_subdev_flags\t= SDF_DIFF,\n\t\t.ai_n_chan\t\t= 4,\n\t\t.ai_maxdata\t\t= 0xffff,\n\t\t.ai_conv_units\t\t= CONV_UNIT_MS | CONV_UNIT_US,\n\t\t.ai_min_acq_ns\t\t= 5000,\n\t\t.has_dig_in\t\t= 1,\n\t\t.has_dig_out\t\t= 1,\n\t},\n\t[BOARD_APCI3500] = {\n\t\t.name\t\t\t= \"apci3500\",\n\t\t.has_ao\t\t\t= 1,\n\t\t.has_ttl_io\t\t= 1,\n\t},\n};\n\nstruct apci3xxx_private {\n\tunsigned int ai_timer;\n\tunsigned char ai_time_base;\n};\n\nstatic irqreturn_t apci3xxx_irq_handler(int irq, void *d)\n{\n\tstruct comedi_device *dev = d;\n\tstruct comedi_subdevice *s = dev->read_subdev;\n\tunsigned int status;\n\tunsigned int val;\n\n\t \n\tstatus = readl(dev->mmio + 16);\n\tif ((status & 0x2) == 0x2) {\n\t\t \n\t\twritel(status, dev->mmio + 16);\n\n\t\tval = readl(dev->mmio + 28);\n\t\tcomedi_buf_write_samples(s, &val, 1);\n\n\t\ts->async->events |= COMEDI_CB_EOA;\n\t\tcomedi_handle_events(dev, s);\n\n\t\treturn IRQ_HANDLED;\n\t}\n\treturn IRQ_NONE;\n}\n\nstatic int apci3xxx_ai_started(struct comedi_device *dev)\n{\n\tif ((readl(dev->mmio + 8) & 0x80000) == 0x80000)\n\t\treturn 1;\n\n\treturn 0;\n}\n\nstatic int apci3xxx_ai_setup(struct comedi_device *dev, unsigned int chanspec)\n{\n\tunsigned int chan = CR_CHAN(chanspec);\n\tunsigned int range = CR_RANGE(chanspec);\n\tunsigned int aref = CR_AREF(chanspec);\n\tunsigned int delay_mode;\n\tunsigned int val;\n\n\tif (apci3xxx_ai_started(dev))\n\t\treturn -EBUSY;\n\n\t \n\twritel(0x10000, dev->mmio + 12);\n\n\t \n\tdelay_mode = readl(dev->mmio + 4);\n\tdelay_mode &= 0xfffffef0;\n\n\t \n\twritel(delay_mode, dev->mmio + 4);\n\n\t \n\tval = (range & 3) | ((range >> 2) << 6) |\n\t      ((aref == AREF_DIFF) << 7);\n\twritel(val, dev->mmio + 0);\n\n\t \n\twritel(delay_mode | 0x100, dev->mmio + 4);\n\twritel(chan, dev->mmio + 0);\n\n\t \n\twritel(delay_mode, dev->mmio + 4);\n\n\t \n\twritel(1, dev->mmio + 48);\n\n\treturn 0;\n}\n\nstatic int apci3xxx_ai_eoc(struct comedi_device *dev,\n\t\t\t   struct comedi_subdevice *s,\n\t\t\t   struct comedi_insn *insn,\n\t\t\t   unsigned long context)\n{\n\tunsigned int status;\n\n\tstatus = readl(dev->mmio + 20);\n\tif (status & 0x1)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int apci3xxx_ai_insn_read(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tint ret;\n\tint i;\n\n\tret = apci3xxx_ai_setup(dev, insn->chanspec);\n\tif (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\t \n\t\twritel(0x80000, dev->mmio + 8);\n\n\t\t \n\t\tret = comedi_timeout(dev, s, insn, apci3xxx_ai_eoc, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tdata[i] = readl(dev->mmio + 28);\n\t}\n\n\treturn insn->n;\n}\n\nstatic int apci3xxx_ai_ns_to_timer(struct comedi_device *dev,\n\t\t\t\t   unsigned int *ns, unsigned int flags)\n{\n\tconst struct apci3xxx_boardinfo *board = dev->board_ptr;\n\tstruct apci3xxx_private *devpriv = dev->private;\n\tunsigned int base;\n\tunsigned int timer;\n\tint time_base;\n\n\t \n\tfor (time_base = 0; time_base < 3; time_base++) {\n\t\t \n\t\tif (!(board->ai_conv_units & (1 << time_base)))\n\t\t\tcontinue;\n\n\t\tswitch (time_base) {\n\t\tcase 0:\n\t\t\tbase = 1;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tbase = 1000;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tbase = 1000000;\n\t\t\tbreak;\n\t\t}\n\n\t\tswitch (flags & CMDF_ROUND_MASK) {\n\t\tcase CMDF_ROUND_NEAREST:\n\t\tdefault:\n\t\t\ttimer = DIV_ROUND_CLOSEST(*ns, base);\n\t\t\tbreak;\n\t\tcase CMDF_ROUND_DOWN:\n\t\t\ttimer = *ns / base;\n\t\t\tbreak;\n\t\tcase CMDF_ROUND_UP:\n\t\t\ttimer = DIV_ROUND_UP(*ns, base);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (timer < 0x10000) {\n\t\t\tdevpriv->ai_time_base = time_base;\n\t\t\tdevpriv->ai_timer = timer;\n\t\t\t*ns = timer * time_base;\n\t\t\treturn 0;\n\t\t}\n\t}\n\treturn -EINVAL;\n}\n\nstatic int apci3xxx_ai_cmdtest(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_cmd *cmd)\n{\n\tconst struct apci3xxx_boardinfo *board = dev->board_ptr;\n\tint err = 0;\n\tunsigned int arg;\n\n\t \n\n\terr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_FOLLOW);\n\terr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_TIMER);\n\terr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\n\terr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_COUNT | TRIG_NONE);\n\n\tif (err)\n\t\treturn 1;\n\n\t \n\n\terr |= comedi_check_trigger_is_unique(cmd->stop_src);\n\n\t \n\n\tif (err)\n\t\treturn 2;\n\n\t \n\n\terr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\n\terr |= comedi_check_trigger_arg_min(&cmd->convert_arg,\n\t\t\t\t\t    board->ai_min_acq_ns);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\n\t\t\t\t\t   cmd->chanlist_len);\n\n\tif (cmd->stop_src == TRIG_COUNT)\n\t\terr |= comedi_check_trigger_arg_min(&cmd->stop_arg, 1);\n\telse\t \n\t\terr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\n\n\tif (err)\n\t\treturn 3;\n\n\t \n\n\targ = cmd->convert_arg;\n\terr |= apci3xxx_ai_ns_to_timer(dev, &arg, cmd->flags);\n\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, arg);\n\n\tif (err)\n\t\treturn 4;\n\n\treturn 0;\n}\n\nstatic int apci3xxx_ai_cmd(struct comedi_device *dev,\n\t\t\t   struct comedi_subdevice *s)\n{\n\tstruct apci3xxx_private *devpriv = dev->private;\n\tstruct comedi_cmd *cmd = &s->async->cmd;\n\tint ret;\n\n\tret = apci3xxx_ai_setup(dev, cmd->chanlist[0]);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\twritel(devpriv->ai_time_base, dev->mmio + 36);\n\n\t \n\twritel(devpriv->ai_timer, dev->mmio + 32);\n\n\t \n\twritel(0x180000, dev->mmio + 8);\n\n\treturn 0;\n}\n\nstatic int apci3xxx_ai_cancel(struct comedi_device *dev,\n\t\t\t      struct comedi_subdevice *s)\n{\n\treturn 0;\n}\n\nstatic int apci3xxx_ao_eoc(struct comedi_device *dev,\n\t\t\t   struct comedi_subdevice *s,\n\t\t\t   struct comedi_insn *insn,\n\t\t\t   unsigned long context)\n{\n\tunsigned int status;\n\n\tstatus = readl(dev->mmio + 96);\n\tif (status & 0x100)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int apci3xxx_ao_insn_write(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s,\n\t\t\t\t  struct comedi_insn *insn,\n\t\t\t\t  unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int range = CR_RANGE(insn->chanspec);\n\tint ret;\n\tint i;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tunsigned int val = data[i];\n\n\t\t \n\t\twritel(range, dev->mmio + 96);\n\n\t\t \n\t\twritel((val << 8) | chan, dev->mmio + 100);\n\n\t\t \n\t\tret = comedi_timeout(dev, s, insn, apci3xxx_ao_eoc, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\ts->readback[chan] = val;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int apci3xxx_di_insn_bits(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tdata[1] = inl(dev->iobase + 32) & 0xf;\n\n\treturn insn->n;\n}\n\nstatic int apci3xxx_do_insn_bits(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\ts->state = inl(dev->iobase + 48) & 0xf;\n\n\tif (comedi_dio_update_state(s, data))\n\t\toutl(s->state, dev->iobase + 48);\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int apci3xxx_dio_insn_config(struct comedi_device *dev,\n\t\t\t\t    struct comedi_subdevice *s,\n\t\t\t\t    struct comedi_insn *insn,\n\t\t\t\t    unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int mask = 0;\n\tint ret;\n\n\t \n\tif (data[0] != INSN_CONFIG_DIO_QUERY) {\n\t\t \n\t\tif (chan < 16)\n\t\t\treturn -EINVAL;\n\n\t\t \n\t\tmask = 0xff0000;\n\t}\n\n\tret = comedi_dio_insn_config(dev, s, insn, data, mask);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\toutl((s->io_bits >> 24) & 0xff, dev->iobase + 224);\n\n\treturn insn->n;\n}\n\nstatic int apci3xxx_dio_insn_bits(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s,\n\t\t\t\t  struct comedi_insn *insn,\n\t\t\t\t  unsigned int *data)\n{\n\tunsigned int mask;\n\tunsigned int val;\n\n\tmask = comedi_dio_update_state(s, data);\n\tif (mask) {\n\t\tif (mask & 0xff)\n\t\t\toutl(s->state & 0xff, dev->iobase + 80);\n\t\tif (mask & 0xff0000)\n\t\t\toutl((s->state >> 16) & 0xff, dev->iobase + 112);\n\t}\n\n\tval = inl(dev->iobase + 80);\n\tval |= (inl(dev->iobase + 64) << 8);\n\tif (s->io_bits & 0xff0000)\n\t\tval |= (inl(dev->iobase + 112) << 16);\n\telse\n\t\tval |= (inl(dev->iobase + 96) << 16);\n\n\tdata[1] = val;\n\n\treturn insn->n;\n}\n\nstatic int apci3xxx_reset(struct comedi_device *dev)\n{\n\tunsigned int val;\n\tint i;\n\n\t \n\tdisable_irq(dev->irq);\n\n\t \n\twritel(0, dev->mmio + 8);\n\n\t \n\tval = readl(dev->mmio + 16);\n\twritel(val, dev->mmio + 16);\n\n\t \n\treadl(dev->mmio + 20);\n\n\t \n\tfor (i = 0; i < 16; i++)\n\t\tval = readl(dev->mmio + 28);\n\n\t \n\tenable_irq(dev->irq);\n\n\treturn 0;\n}\n\nstatic int apci3xxx_auto_attach(struct comedi_device *dev,\n\t\t\t\tunsigned long context)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tconst struct apci3xxx_boardinfo *board = NULL;\n\tstruct apci3xxx_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tint n_subdevices;\n\tint subdev;\n\tint ret;\n\n\tif (context < ARRAY_SIZE(apci3xxx_boardtypes))\n\t\tboard = &apci3xxx_boardtypes[context];\n\tif (!board)\n\t\treturn -ENODEV;\n\tdev->board_ptr = board;\n\tdev->board_name = board->name;\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tdev->iobase = pci_resource_start(pcidev, 2);\n\tdev->mmio = pci_ioremap_bar(pcidev, 3);\n\tif (!dev->mmio)\n\t\treturn -ENOMEM;\n\n\tif (pcidev->irq > 0) {\n\t\tret = request_irq(pcidev->irq, apci3xxx_irq_handler,\n\t\t\t\t  IRQF_SHARED, dev->board_name, dev);\n\t\tif (ret == 0)\n\t\t\tdev->irq = pcidev->irq;\n\t}\n\n\tn_subdevices = (board->ai_n_chan ? 0 : 1) + board->has_ao +\n\t\t       board->has_dig_in + board->has_dig_out +\n\t\t       board->has_ttl_io;\n\tret = comedi_alloc_subdevices(dev, n_subdevices);\n\tif (ret)\n\t\treturn ret;\n\n\tsubdev = 0;\n\n\t \n\tif (board->ai_n_chan) {\n\t\ts = &dev->subdevices[subdev];\n\t\ts->type\t\t= COMEDI_SUBD_AI;\n\t\ts->subdev_flags\t= SDF_READABLE | board->ai_subdev_flags;\n\t\ts->n_chan\t= board->ai_n_chan;\n\t\ts->maxdata\t= board->ai_maxdata;\n\t\ts->range_table\t= &apci3xxx_ai_range;\n\t\ts->insn_read\t= apci3xxx_ai_insn_read;\n\t\tif (dev->irq) {\n\t\t\t \n\t\t\tdev->read_subdev = s;\n\t\t\ts->subdev_flags\t|= SDF_CMD_READ;\n\t\t\ts->len_chanlist\t= 1;\n\t\t\ts->do_cmdtest\t= apci3xxx_ai_cmdtest;\n\t\t\ts->do_cmd\t= apci3xxx_ai_cmd;\n\t\t\ts->cancel\t= apci3xxx_ai_cancel;\n\t\t}\n\n\t\tsubdev++;\n\t}\n\n\t \n\tif (board->has_ao) {\n\t\ts = &dev->subdevices[subdev];\n\t\ts->type\t\t= COMEDI_SUBD_AO;\n\t\ts->subdev_flags\t= SDF_WRITABLE | SDF_GROUND | SDF_COMMON;\n\t\ts->n_chan\t= 4;\n\t\ts->maxdata\t= 0x0fff;\n\t\ts->range_table\t= &apci3xxx_ao_range;\n\t\ts->insn_write\t= apci3xxx_ao_insn_write;\n\n\t\tret = comedi_alloc_subdev_readback(s);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tsubdev++;\n\t}\n\n\t \n\tif (board->has_dig_in) {\n\t\ts = &dev->subdevices[subdev];\n\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\ts->subdev_flags\t= SDF_READABLE;\n\t\ts->n_chan\t= 4;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_bits\t= apci3xxx_di_insn_bits;\n\n\t\tsubdev++;\n\t}\n\n\t \n\tif (board->has_dig_out) {\n\t\ts = &dev->subdevices[subdev];\n\t\ts->type\t\t= COMEDI_SUBD_DO;\n\t\ts->subdev_flags\t= SDF_WRITABLE;\n\t\ts->n_chan\t= 4;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_bits\t= apci3xxx_do_insn_bits;\n\n\t\tsubdev++;\n\t}\n\n\t \n\tif (board->has_ttl_io) {\n\t\ts = &dev->subdevices[subdev];\n\t\ts->type\t\t= COMEDI_SUBD_DIO;\n\t\ts->subdev_flags\t= SDF_READABLE | SDF_WRITABLE;\n\t\ts->n_chan\t= 24;\n\t\ts->maxdata\t= 1;\n\t\ts->io_bits\t= 0xff;\t \n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_config\t= apci3xxx_dio_insn_config;\n\t\ts->insn_bits\t= apci3xxx_dio_insn_bits;\n\n\t\tsubdev++;\n\t}\n\n\tapci3xxx_reset(dev);\n\treturn 0;\n}\n\nstatic void apci3xxx_detach(struct comedi_device *dev)\n{\n\tif (dev->iobase)\n\t\tapci3xxx_reset(dev);\n\tcomedi_pci_detach(dev);\n}\n\nstatic struct comedi_driver apci3xxx_driver = {\n\t.driver_name\t= \"addi_apci_3xxx\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= apci3xxx_auto_attach,\n\t.detach\t\t= apci3xxx_detach,\n};\n\nstatic int apci3xxx_pci_probe(struct pci_dev *dev,\n\t\t\t      const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &apci3xxx_driver, id->driver_data);\n}\n\nstatic const struct pci_device_id apci3xxx_pci_table[] = {\n\t{ PCI_VDEVICE(ADDIDATA, 0x3010), BOARD_APCI3000_16 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x300f), BOARD_APCI3000_8 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x300e), BOARD_APCI3000_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3013), BOARD_APCI3006_16 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3014), BOARD_APCI3006_8 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3015), BOARD_APCI3006_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3016), BOARD_APCI3010_16 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3017), BOARD_APCI3010_8 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3018), BOARD_APCI3010_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3019), BOARD_APCI3016_16 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x301a), BOARD_APCI3016_8 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x301b), BOARD_APCI3016_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x301c), BOARD_APCI3100_16_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x301d), BOARD_APCI3100_8_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x301e), BOARD_APCI3106_16_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x301f), BOARD_APCI3106_8_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3020), BOARD_APCI3110_16_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3021), BOARD_APCI3110_8_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3022), BOARD_APCI3116_16_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3023), BOARD_APCI3116_8_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x300B), BOARD_APCI3003 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3002), BOARD_APCI3002_16 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3003), BOARD_APCI3002_8 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3004), BOARD_APCI3002_4 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x3024), BOARD_APCI3500 },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, apci3xxx_pci_table);\n\nstatic struct pci_driver apci3xxx_pci_driver = {\n\t.name\t\t= \"addi_apci_3xxx\",\n\t.id_table\t= apci3xxx_pci_table,\n\t.probe\t\t= apci3xxx_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(apci3xxx_driver, apci3xxx_pci_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi low-level driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}