{
  "module_name": "amplc_pc236_common.c",
  "hash_id": "30c3125f6209f4ac758f4e4ba50d0681c55f17517d3d4e5d570ad7d4f59faec2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/amplc_pc236_common.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedidev.h>\n#include <linux/comedi/comedi_8255.h>\n\n#include \"amplc_pc236.h\"\n\nstatic void pc236_intr_update(struct comedi_device *dev, bool enable)\n{\n\tconst struct pc236_board *board = dev->board_ptr;\n\tstruct pc236_private *devpriv = dev->private;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&dev->spinlock, flags);\n\tdevpriv->enable_irq = enable;\n\tif (board->intr_update_cb)\n\t\tboard->intr_update_cb(dev, enable);\n\tspin_unlock_irqrestore(&dev->spinlock, flags);\n}\n\n \nstatic bool pc236_intr_check(struct comedi_device *dev)\n{\n\tconst struct pc236_board *board = dev->board_ptr;\n\tstruct pc236_private *devpriv = dev->private;\n\tbool retval = false;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&dev->spinlock, flags);\n\tif (devpriv->enable_irq) {\n\t\tif (board->intr_chk_clr_cb)\n\t\t\tretval = board->intr_chk_clr_cb(dev);\n\t\telse\n\t\t\tretval = true;\n\t}\n\tspin_unlock_irqrestore(&dev->spinlock, flags);\n\n\treturn retval;\n}\n\nstatic int pc236_intr_insn(struct comedi_device *dev,\n\t\t\t   struct comedi_subdevice *s, struct comedi_insn *insn,\n\t\t\t   unsigned int *data)\n{\n\tdata[1] = 0;\n\treturn insn->n;\n}\n\nstatic int pc236_intr_cmdtest(struct comedi_device *dev,\n\t\t\t      struct comedi_subdevice *s,\n\t\t\t      struct comedi_cmd *cmd)\n{\n\tint err = 0;\n\n\t \n\n\terr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);\n\terr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\n\terr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_NONE);\n\n\tif (err)\n\t\treturn 1;\n\n\t \n\t \n\n\t \n\n\terr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\n\t\t\t\t\t   cmd->chanlist_len);\n\terr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\n\n\tif (err)\n\t\treturn 3;\n\n\t \n\n\t \n\n\treturn 0;\n}\n\nstatic int pc236_intr_cmd(struct comedi_device *dev, struct comedi_subdevice *s)\n{\n\tpc236_intr_update(dev, true);\n\n\treturn 0;\n}\n\nstatic int pc236_intr_cancel(struct comedi_device *dev,\n\t\t\t     struct comedi_subdevice *s)\n{\n\tpc236_intr_update(dev, false);\n\n\treturn 0;\n}\n\nstatic irqreturn_t pc236_interrupt(int irq, void *d)\n{\n\tstruct comedi_device *dev = d;\n\tstruct comedi_subdevice *s = dev->read_subdev;\n\tbool handled;\n\n\thandled = pc236_intr_check(dev);\n\tif (dev->attached && handled) {\n\t\tunsigned short val = 0;\n\n\t\tcomedi_buf_write_samples(s, &val, 1);\n\t\tcomedi_handle_events(dev, s);\n\t}\n\treturn IRQ_RETVAL(handled);\n}\n\nint amplc_pc236_common_attach(struct comedi_device *dev, unsigned long iobase,\n\t\t\t      unsigned int irq, unsigned long req_irq_flags)\n{\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tdev->iobase = iobase;\n\n\tret = comedi_alloc_subdevices(dev, 2);\n\tif (ret)\n\t\treturn ret;\n\n\ts = &dev->subdevices[0];\n\t \n\tret = subdev_8255_init(dev, s, NULL, 0x00);\n\tif (ret)\n\t\treturn ret;\n\n\ts = &dev->subdevices[1];\n\tdev->read_subdev = s;\n\ts->type = COMEDI_SUBD_UNUSED;\n\tpc236_intr_update(dev, false);\n\tif (irq) {\n\t\tif (request_irq(irq, pc236_interrupt, req_irq_flags,\n\t\t\t\tdev->board_name, dev) >= 0) {\n\t\t\tdev->irq = irq;\n\t\t\ts->type = COMEDI_SUBD_DI;\n\t\t\ts->subdev_flags = SDF_READABLE | SDF_CMD_READ;\n\t\t\ts->n_chan = 1;\n\t\t\ts->maxdata = 1;\n\t\t\ts->range_table = &range_digital;\n\t\t\ts->insn_bits = pc236_intr_insn;\n\t\t\ts->len_chanlist\t= 1;\n\t\t\ts->do_cmdtest = pc236_intr_cmdtest;\n\t\t\ts->do_cmd = pc236_intr_cmd;\n\t\t\ts->cancel = pc236_intr_cancel;\n\t\t}\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(amplc_pc236_common_attach);\n\nstatic int __init amplc_pc236_common_init(void)\n{\n\treturn 0;\n}\nmodule_init(amplc_pc236_common_init);\n\nstatic void __exit amplc_pc236_common_exit(void)\n{\n}\nmodule_exit(amplc_pc236_common_exit);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi helper for amplc_pc236 and amplc_pci236\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}