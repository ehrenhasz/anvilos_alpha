{
  "module_name": "c6xdigio.c",
  "hash_id": "9e3c338133bfd8f1263fc65b3ef9e9b6f540ccb03c045dcdc81982a1772fd37b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/c6xdigio.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/sched.h>\n#include <linux/mm.h>\n#include <linux/errno.h>\n#include <linux/interrupt.h>\n#include <linux/timex.h>\n#include <linux/timer.h>\n#include <linux/io.h>\n#include <linux/pnp.h>\n#include <linux/comedi/comedidev.h>\n\n \n#define C6XDIGIO_DATA_REG\t0x00\n#define C6XDIGIO_DATA_CHAN(x)\t(((x) + 1) << 4)\n#define C6XDIGIO_DATA_PWM\tBIT(5)\n#define C6XDIGIO_DATA_ENCODER\tBIT(6)\n#define C6XDIGIO_STATUS_REG\t0x01\n#define C6XDIGIO_CTRL_REG\t0x02\n\n#define C6XDIGIO_TIME_OUT 20\n\nstatic int c6xdigio_chk_status(struct comedi_device *dev, unsigned long context)\n{\n\tunsigned int status;\n\tint timeout = 0;\n\n\tdo {\n\t\tstatus = inb(dev->iobase + C6XDIGIO_STATUS_REG);\n\t\tif ((status & 0x80) != context)\n\t\t\treturn 0;\n\t\ttimeout++;\n\t} while  (timeout < C6XDIGIO_TIME_OUT);\n\n\treturn -EBUSY;\n}\n\nstatic int c6xdigio_write_data(struct comedi_device *dev,\n\t\t\t       unsigned int val, unsigned int status)\n{\n\toutb_p(val, dev->iobase + C6XDIGIO_DATA_REG);\n\treturn c6xdigio_chk_status(dev, status);\n}\n\nstatic int c6xdigio_get_encoder_bits(struct comedi_device *dev,\n\t\t\t\t     unsigned int *bits,\n\t\t\t\t     unsigned int cmd,\n\t\t\t\t     unsigned int status)\n{\n\tunsigned int val;\n\n\tval = inb(dev->iobase + C6XDIGIO_STATUS_REG);\n\tval >>= 3;\n\tval &= 0x07;\n\n\t*bits = val;\n\n\treturn c6xdigio_write_data(dev, cmd, status);\n}\n\nstatic void c6xdigio_pwm_write(struct comedi_device *dev,\n\t\t\t       unsigned int chan, unsigned int val)\n{\n\tunsigned int cmd = C6XDIGIO_DATA_PWM | C6XDIGIO_DATA_CHAN(chan);\n\tunsigned int bits;\n\n\tif (val > 498)\n\t\tval = 498;\n\tif (val < 2)\n\t\tval = 2;\n\n\tbits = (val >> 0) & 0x03;\n\tc6xdigio_write_data(dev, cmd | bits | (0 << 2), 0x00);\n\tbits = (val >> 2) & 0x03;\n\tc6xdigio_write_data(dev, cmd | bits | (1 << 2), 0x80);\n\tbits = (val >> 4) & 0x03;\n\tc6xdigio_write_data(dev, cmd | bits | (0 << 2), 0x00);\n\tbits = (val >> 6) & 0x03;\n\tc6xdigio_write_data(dev, cmd | bits | (1 << 2), 0x80);\n\tbits = (val >> 8) & 0x03;\n\tc6xdigio_write_data(dev, cmd | bits | (0 << 2), 0x00);\n\n\tc6xdigio_write_data(dev, 0x00, 0x80);\n}\n\nstatic int c6xdigio_encoder_read(struct comedi_device *dev,\n\t\t\t\t unsigned int chan)\n{\n\tunsigned int cmd = C6XDIGIO_DATA_ENCODER | C6XDIGIO_DATA_CHAN(chan);\n\tunsigned int val = 0;\n\tunsigned int bits;\n\n\tc6xdigio_write_data(dev, cmd, 0x00);\n\n\tc6xdigio_get_encoder_bits(dev, &bits, cmd | (1 << 2), 0x80);\n\tval |= (bits << 0);\n\n\tc6xdigio_get_encoder_bits(dev, &bits, cmd | (0 << 2), 0x00);\n\tval |= (bits << 3);\n\n\tc6xdigio_get_encoder_bits(dev, &bits, cmd | (1 << 2), 0x80);\n\tval |= (bits << 6);\n\n\tc6xdigio_get_encoder_bits(dev, &bits, cmd | (0 << 2), 0x00);\n\tval |= (bits << 9);\n\n\tc6xdigio_get_encoder_bits(dev, &bits, cmd | (1 << 2), 0x80);\n\tval |= (bits << 12);\n\n\tc6xdigio_get_encoder_bits(dev, &bits, cmd | (0 << 2), 0x00);\n\tval |= (bits << 15);\n\n\tc6xdigio_get_encoder_bits(dev, &bits, cmd | (1 << 2), 0x80);\n\tval |= (bits << 18);\n\n\tc6xdigio_get_encoder_bits(dev, &bits, cmd | (0 << 2), 0x00);\n\tval |= (bits << 21);\n\n\tc6xdigio_write_data(dev, 0x00, 0x80);\n\n\treturn val;\n}\n\nstatic int c6xdigio_pwm_insn_write(struct comedi_device *dev,\n\t\t\t\t   struct comedi_subdevice *s,\n\t\t\t\t   struct comedi_insn *insn,\n\t\t\t\t   unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int val = (s->state >> (16 * chan)) & 0xffff;\n\tint i;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tval = data[i];\n\t\tc6xdigio_pwm_write(dev, chan, val);\n\t}\n\n\t \n\ts->state &= (0xffff << (16 * chan));\n\ts->state |= (val << (16 * chan));\n\n\treturn insn->n;\n}\n\nstatic int c6xdigio_pwm_insn_read(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s,\n\t\t\t\t  struct comedi_insn *insn,\n\t\t\t\t  unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int val;\n\tint i;\n\n\tval = (s->state >> (16 * chan)) & 0xffff;\n\n\tfor (i = 0; i < insn->n; i++)\n\t\tdata[i] = val;\n\n\treturn insn->n;\n}\n\nstatic int c6xdigio_encoder_insn_read(struct comedi_device *dev,\n\t\t\t\t      struct comedi_subdevice *s,\n\t\t\t\t      struct comedi_insn *insn,\n\t\t\t\t      unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int val;\n\tint i;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tval = c6xdigio_encoder_read(dev, chan);\n\n\t\t \n\t\tdata[i] = comedi_offset_munge(s, val);\n\t}\n\n\treturn insn->n;\n}\n\nstatic void c6xdigio_init(struct comedi_device *dev)\n{\n\t \n\tc6xdigio_write_data(dev, 0x70, 0x00);\n\tc6xdigio_write_data(dev, 0x74, 0x80);\n\tc6xdigio_write_data(dev, 0x70, 0x00);\n\tc6xdigio_write_data(dev, 0x00, 0x80);\n\n\t \n\tc6xdigio_write_data(dev, 0x68, 0x00);\n\tc6xdigio_write_data(dev, 0x6c, 0x80);\n\tc6xdigio_write_data(dev, 0x68, 0x00);\n\tc6xdigio_write_data(dev, 0x00, 0x80);\n}\n\nstatic const struct pnp_device_id c6xdigio_pnp_tbl[] = {\n\t \n\t{.id = \"PNP0400\", .driver_data = 0},\n\t \n\t{.id = \"PNP0401\", .driver_data = 0},\n\t{}\n};\n\nstatic struct pnp_driver c6xdigio_pnp_driver = {\n\t.name = \"c6xdigio\",\n\t.id_table = c6xdigio_pnp_tbl,\n};\n\nstatic int c6xdigio_attach(struct comedi_device *dev,\n\t\t\t   struct comedi_devconfig *it)\n{\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_request_region(dev, it->options[0], 0x03);\n\tif (ret)\n\t\treturn ret;\n\n\tret = comedi_alloc_subdevices(dev, 2);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tpnp_register_driver(&c6xdigio_pnp_driver);\n\n\ts = &dev->subdevices[0];\n\t \n\ts->type\t\t= COMEDI_SUBD_PWM;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= 2;\n\ts->maxdata\t= 500;\n\ts->range_table\t= &range_unknown;\n\ts->insn_write\t= c6xdigio_pwm_insn_write;\n\ts->insn_read\t= c6xdigio_pwm_insn_read;\n\n\ts = &dev->subdevices[1];\n\t \n\ts->type\t\t= COMEDI_SUBD_COUNTER;\n\ts->subdev_flags\t= SDF_READABLE | SDF_LSAMPL;\n\ts->n_chan\t= 2;\n\ts->maxdata\t= 0xffffff;\n\ts->range_table\t= &range_unknown;\n\ts->insn_read\t= c6xdigio_encoder_insn_read;\n\n\t \n\t \n\tc6xdigio_init(dev);\n\n\treturn 0;\n}\n\nstatic void c6xdigio_detach(struct comedi_device *dev)\n{\n\tcomedi_legacy_detach(dev);\n\tpnp_unregister_driver(&c6xdigio_pnp_driver);\n}\n\nstatic struct comedi_driver c6xdigio_driver = {\n\t.driver_name\t= \"c6xdigio\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= c6xdigio_attach,\n\t.detach\t\t= c6xdigio_detach,\n};\nmodule_comedi_driver(c6xdigio_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for the C6x_DIGIO DSP daughter card\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}