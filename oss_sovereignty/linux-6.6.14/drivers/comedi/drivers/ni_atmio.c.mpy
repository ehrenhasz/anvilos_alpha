{
  "module_name": "ni_atmio.c",
  "hash_id": "dedde33ee1e9541417af4253a95f31f886101e3843e5c95a809d0dd34422811d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/ni_atmio.c",
  "human_readable_source": "\n \n\n \n\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedidev.h>\n#include <linux/isapnp.h>\n#include <linux/comedi/comedi_8255.h>\n\n#include \"ni_stc.h\"\n\n \nstatic const struct ni_board_struct ni_boards[] = {\n\t{\n\t\t.name\t\t= \"at-mio-16e-1\",\n\t\t.device_id\t= 44,\n\t\t.isapnp_id\t= 0x0000,\t \n\t\t.n_adchan\t= 16,\n\t\t.ai_maxdata\t= 0x0fff,\n\t\t.ai_fifo_depth\t= 8192,\n\t\t.gainlkup\t= ai_gain_16,\n\t\t.ai_speed\t= 800,\n\t\t.n_aochan\t= 2,\n\t\t.ao_maxdata\t= 0x0fff,\n\t\t.ao_fifo_depth\t= 2048,\n\t\t.ao_range_table\t= &range_ni_E_ao_ext,\n\t\t.ao_speed\t= 1000,\n\t\t.caldac\t\t= { mb88341 },\n\t}, {\n\t\t.name\t\t= \"at-mio-16e-2\",\n\t\t.device_id\t= 25,\n\t\t.isapnp_id\t= 0x1900,\n\t\t.n_adchan\t= 16,\n\t\t.ai_maxdata\t= 0x0fff,\n\t\t.ai_fifo_depth\t= 2048,\n\t\t.gainlkup\t= ai_gain_16,\n\t\t.ai_speed\t= 2000,\n\t\t.n_aochan\t= 2,\n\t\t.ao_maxdata\t= 0x0fff,\n\t\t.ao_fifo_depth\t= 2048,\n\t\t.ao_range_table\t= &range_ni_E_ao_ext,\n\t\t.ao_speed\t= 1000,\n\t\t.caldac\t\t= { mb88341 },\n\t}, {\n\t\t.name\t\t= \"at-mio-16e-10\",\n\t\t.device_id\t= 36,\n\t\t.isapnp_id\t= 0x2400,\n\t\t.n_adchan\t= 16,\n\t\t.ai_maxdata\t= 0x0fff,\n\t\t.ai_fifo_depth\t= 512,\n\t\t.gainlkup\t= ai_gain_16,\n\t\t.ai_speed\t= 10000,\n\t\t.n_aochan\t= 2,\n\t\t.ao_maxdata\t= 0x0fff,\n\t\t.ao_range_table\t= &range_ni_E_ao_ext,\n\t\t.ao_speed\t= 10000,\n\t\t.caldac\t\t= { ad8804_debug },\n\t}, {\n\t\t.name\t\t= \"at-mio-16de-10\",\n\t\t.device_id\t= 37,\n\t\t.isapnp_id\t= 0x2500,\n\t\t.n_adchan\t= 16,\n\t\t.ai_maxdata\t= 0x0fff,\n\t\t.ai_fifo_depth\t= 512,\n\t\t.gainlkup\t= ai_gain_16,\n\t\t.ai_speed\t= 10000,\n\t\t.n_aochan\t= 2,\n\t\t.ao_maxdata\t= 0x0fff,\n\t\t.ao_range_table\t= &range_ni_E_ao_ext,\n\t\t.ao_speed\t= 10000,\n\t\t.caldac\t\t= { ad8804_debug },\n\t\t.has_8255\t= 1,\n\t}, {\n\t\t.name\t\t= \"at-mio-64e-3\",\n\t\t.device_id\t= 38,\n\t\t.isapnp_id\t= 0x2600,\n\t\t.n_adchan\t= 64,\n\t\t.ai_maxdata\t= 0x0fff,\n\t\t.ai_fifo_depth\t= 2048,\n\t\t.gainlkup\t= ai_gain_16,\n\t\t.ai_speed\t= 2000,\n\t\t.n_aochan\t= 2,\n\t\t.ao_maxdata\t= 0x0fff,\n\t\t.ao_fifo_depth\t= 2048,\n\t\t.ao_range_table\t= &range_ni_E_ao_ext,\n\t\t.ao_speed\t= 1000,\n\t\t.caldac\t\t= { ad8804_debug },\n\t}, {\n\t\t.name\t\t= \"at-mio-16xe-50\",\n\t\t.device_id\t= 39,\n\t\t.isapnp_id\t= 0x2700,\n\t\t.n_adchan\t= 16,\n\t\t.ai_maxdata\t= 0xffff,\n\t\t.ai_fifo_depth\t= 512,\n\t\t.alwaysdither\t= 1,\n\t\t.gainlkup\t= ai_gain_8,\n\t\t.ai_speed\t= 50000,\n\t\t.n_aochan\t= 2,\n\t\t.ao_maxdata\t= 0x0fff,\n\t\t.ao_range_table\t= &range_bipolar10,\n\t\t.ao_speed\t= 50000,\n\t\t.caldac\t\t= { dac8800, dac8043 },\n\t}, {\n\t\t.name\t\t= \"at-mio-16xe-10\",\n\t\t.device_id\t= 50,\n\t\t.isapnp_id\t= 0x0000,\t \n\t\t.n_adchan\t= 16,\n\t\t.ai_maxdata\t= 0xffff,\n\t\t.ai_fifo_depth\t= 512,\n\t\t.alwaysdither\t= 1,\n\t\t.gainlkup\t= ai_gain_14,\n\t\t.ai_speed\t= 10000,\n\t\t.n_aochan\t= 2,\n\t\t.ao_maxdata\t= 0xffff,\n\t\t.ao_fifo_depth\t= 2048,\n\t\t.ao_range_table\t= &range_ni_E_ao_ext,\n\t\t.ao_speed\t= 1000,\n\t\t.caldac\t\t= { dac8800, dac8043, ad8522 },\n\t}, {\n\t\t.name\t\t= \"at-ai-16xe-10\",\n\t\t.device_id\t= 51,\n\t\t.isapnp_id\t= 0x0000,\t \n\t\t.n_adchan\t= 16,\n\t\t.ai_maxdata\t= 0xffff,\n\t\t.ai_fifo_depth\t= 512,\n\t\t.alwaysdither\t= 1,\t\t \n\t\t.gainlkup\t= ai_gain_14,\n\t\t.ai_speed\t= 10000,\n\t\t.caldac\t\t= { dac8800, dac8043, ad8522 },\n\t},\n};\n\nstatic const int ni_irqpin[] = {\n\t-1, -1, -1, 0, 1, 2, -1, 3, -1, -1, 4, 5, 6, -1, -1, 7\n};\n\n#include \"ni_mio_common.c\"\n\nstatic const struct pnp_device_id device_ids[] = {\n\t{.id = \"NIC1900\", .driver_data = 0},\n\t{.id = \"NIC2400\", .driver_data = 0},\n\t{.id = \"NIC2500\", .driver_data = 0},\n\t{.id = \"NIC2600\", .driver_data = 0},\n\t{.id = \"NIC2700\", .driver_data = 0},\n\t{.id = \"\"}\n};\n\nMODULE_DEVICE_TABLE(pnp, device_ids);\n\nstatic int ni_isapnp_find_board(struct pnp_dev **dev)\n{\n\tstruct pnp_dev *isapnp_dev = NULL;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(ni_boards); i++) {\n\t\tisapnp_dev =\n\t\t\tpnp_find_dev(NULL,\n\t\t\t\t     ISAPNP_VENDOR('N', 'I', 'C'),\n\t\t\t\t     ISAPNP_FUNCTION(ni_boards[i].isapnp_id),\n\t\t\t\t     NULL);\n\n\t\tif (!isapnp_dev || !isapnp_dev->card)\n\t\t\tcontinue;\n\n\t\tif (pnp_device_attach(isapnp_dev) < 0)\n\t\t\tcontinue;\n\n\t\tif (pnp_activate_dev(isapnp_dev) < 0) {\n\t\t\tpnp_device_detach(isapnp_dev);\n\t\t\treturn -EAGAIN;\n\t\t}\n\n\t\tif (!pnp_port_valid(isapnp_dev, 0) ||\n\t\t    !pnp_irq_valid(isapnp_dev, 0)) {\n\t\t\tpnp_device_detach(isapnp_dev);\n\t\t\treturn -ENOMEM;\n\t\t}\n\t\tbreak;\n\t}\n\tif (i == ARRAY_SIZE(ni_boards))\n\t\treturn -ENODEV;\n\t*dev = isapnp_dev;\n\treturn 0;\n}\n\nstatic const struct ni_board_struct *ni_atmio_probe(struct comedi_device *dev)\n{\n\tint device_id = ni_read_eeprom(dev, 511);\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(ni_boards); i++) {\n\t\tconst struct ni_board_struct *board = &ni_boards[i];\n\n\t\tif (board->device_id == device_id)\n\t\t\treturn board;\n\t}\n\tif (device_id == 255)\n\t\tdev_err(dev->class_dev, \"can't find board\\n\");\n\telse if (device_id == 0)\n\t\tdev_err(dev->class_dev,\n\t\t\t\"EEPROM read error (?) or device not found\\n\");\n\telse\n\t\tdev_err(dev->class_dev,\n\t\t\t\"unknown device ID %d -- contact author\\n\", device_id);\n\n\treturn NULL;\n}\n\nstatic int ni_atmio_attach(struct comedi_device *dev,\n\t\t\t   struct comedi_devconfig *it)\n{\n\tconst struct ni_board_struct *board;\n\tstruct pnp_dev *isapnp_dev;\n\tint ret;\n\tunsigned long iobase;\n\tunsigned int irq;\n\n\tret = ni_alloc_private(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tiobase = it->options[0];\n\tirq = it->options[1];\n\tisapnp_dev = NULL;\n\tif (iobase == 0) {\n\t\tret = ni_isapnp_find_board(&isapnp_dev);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tiobase = pnp_port_start(isapnp_dev, 0);\n\t\tirq = pnp_irq(isapnp_dev, 0);\n\t\tcomedi_set_hw_dev(dev, &isapnp_dev->dev);\n\t}\n\n\tret = comedi_request_region(dev, iobase, 0x20);\n\tif (ret)\n\t\treturn ret;\n\n\tboard = ni_atmio_probe(dev);\n\tif (!board)\n\t\treturn -ENODEV;\n\tdev->board_ptr = board;\n\tdev->board_name = board->name;\n\n\t \n\n\tif (irq != 0) {\n\t\tif (irq > 15 || ni_irqpin[irq] == -1)\n\t\t\treturn -EINVAL;\n\t\tret = request_irq(irq, ni_E_interrupt, 0,\n\t\t\t\t  dev->board_name, dev);\n\t\tif (ret < 0)\n\t\t\treturn -EINVAL;\n\t\tdev->irq = irq;\n\t}\n\n\t \n\n\tret = ni_E_init(dev, ni_irqpin[dev->irq], 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic void ni_atmio_detach(struct comedi_device *dev)\n{\n\tstruct pnp_dev *isapnp_dev;\n\n\tmio_common_detach(dev);\n\tcomedi_legacy_detach(dev);\n\n\tisapnp_dev = dev->hw_dev ? to_pnp_dev(dev->hw_dev) : NULL;\n\tif (isapnp_dev)\n\t\tpnp_device_detach(isapnp_dev);\n}\n\nstatic struct comedi_driver ni_atmio_driver = {\n\t.driver_name\t= \"ni_atmio\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= ni_atmio_attach,\n\t.detach\t\t= ni_atmio_detach,\n};\nmodule_comedi_driver(ni_atmio_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi low-level driver\");\nMODULE_LICENSE(\"GPL\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}