{
  "module_name": "multiq3.c",
  "hash_id": "0c6878c8ca357a6e888184ad214055e1da53bf39d82bc559bbda2f44d0de1438",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/multiq3.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedidev.h>\n\n \n#define MULTIQ3_DI_REG\t\t\t0x00\n#define MULTIQ3_DO_REG\t\t\t0x00\n#define MULTIQ3_AO_REG\t\t\t0x02\n#define MULTIQ3_AI_REG\t\t\t0x04\n#define MULTIQ3_AI_CONV_REG\t\t0x04\n#define MULTIQ3_STATUS_REG\t\t0x06\n#define MULTIQ3_STATUS_EOC\t\tBIT(3)\n#define MULTIQ3_STATUS_EOC_I\t\tBIT(4)\n#define MULTIQ3_CTRL_REG\t\t0x06\n#define MULTIQ3_CTRL_AO_CHAN(x)\t\t(((x) & 0x7) << 0)\n#define MULTIQ3_CTRL_RC(x)\t\t(((x) & 0x3) << 0)\n#define MULTIQ3_CTRL_AI_CHAN(x)\t\t(((x) & 0x7) << 3)\n#define MULTIQ3_CTRL_E_CHAN(x)\t\t(((x) & 0x7) << 3)\n#define MULTIQ3_CTRL_EN\t\t\tBIT(6)\n#define MULTIQ3_CTRL_AZ\t\t\tBIT(7)\n#define MULTIQ3_CTRL_CAL\t\tBIT(8)\n#define MULTIQ3_CTRL_SH\t\t\tBIT(9)\n#define MULTIQ3_CTRL_CLK\t\tBIT(10)\n#define MULTIQ3_CTRL_LD\t\t\t(3 << 11)\n#define MULTIQ3_CLK_REG\t\t\t0x08\n#define MULTIQ3_ENC_DATA_REG\t\t0x0c\n#define MULTIQ3_ENC_CTRL_REG\t\t0x0e\n\n \n#define MULTIQ3_CLOCK_DATA\t\t0x00\t \n#define MULTIQ3_CLOCK_SETUP\t\t0x18\t \n#define MULTIQ3_INPUT_SETUP\t\t0x41\t \n#define MULTIQ3_QUAD_X4\t\t\t0x38\t \n#define MULTIQ3_BP_RESET\t\t0x01\t \n#define MULTIQ3_CNTR_RESET\t\t0x02\t \n#define MULTIQ3_TRSFRPR_CTR\t\t0x08\t \n#define MULTIQ3_TRSFRCNTR_OL\t\t0x10\t \n#define MULTIQ3_EFLAG_RESET\t\t0x06\t \n\nstatic void multiq3_set_ctrl(struct comedi_device *dev, unsigned int bits)\n{\n\t \n\toutw(MULTIQ3_CTRL_SH | MULTIQ3_CTRL_CLK | bits,\n\t     dev->iobase + MULTIQ3_CTRL_REG);\n}\n\nstatic int multiq3_ai_status(struct comedi_device *dev,\n\t\t\t     struct comedi_subdevice *s,\n\t\t\t     struct comedi_insn *insn,\n\t\t\t     unsigned long context)\n{\n\tunsigned int status;\n\n\tstatus = inw(dev->iobase + MULTIQ3_STATUS_REG);\n\tif (status & context)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int multiq3_ai_insn_read(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int val;\n\tint ret;\n\tint i;\n\n\tmultiq3_set_ctrl(dev, MULTIQ3_CTRL_EN | MULTIQ3_CTRL_AI_CHAN(chan));\n\n\tret = comedi_timeout(dev, s, insn, multiq3_ai_status,\n\t\t\t     MULTIQ3_STATUS_EOC);\n\tif (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\toutw(0, dev->iobase + MULTIQ3_AI_CONV_REG);\n\n\t\tret = comedi_timeout(dev, s, insn, multiq3_ai_status,\n\t\t\t\t     MULTIQ3_STATUS_EOC_I);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tval = inb(dev->iobase + MULTIQ3_AI_REG) << 8;\n\t\tval |= inb(dev->iobase + MULTIQ3_AI_REG);\n\t\tval &= s->maxdata;\n\n\t\t \n\t\tdata[i] = comedi_offset_munge(s, val);\n\t}\n\n\treturn insn->n;\n}\n\nstatic int multiq3_ao_insn_write(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int val = s->readback[chan];\n\tint i;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tval = data[i];\n\t\tmultiq3_set_ctrl(dev, MULTIQ3_CTRL_LD |\n\t\t\t\t      MULTIQ3_CTRL_AO_CHAN(chan));\n\t\toutw(val, dev->iobase + MULTIQ3_AO_REG);\n\t\tmultiq3_set_ctrl(dev, 0);\n\t}\n\ts->readback[chan] = val;\n\n\treturn insn->n;\n}\n\nstatic int multiq3_di_insn_bits(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn, unsigned int *data)\n{\n\tdata[1] = inw(dev->iobase + MULTIQ3_DI_REG);\n\n\treturn insn->n;\n}\n\nstatic int multiq3_do_insn_bits(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tif (comedi_dio_update_state(s, data))\n\t\toutw(s->state, dev->iobase + MULTIQ3_DO_REG);\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int multiq3_encoder_insn_read(struct comedi_device *dev,\n\t\t\t\t     struct comedi_subdevice *s,\n\t\t\t\t     struct comedi_insn *insn,\n\t\t\t\t     unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int val;\n\tint i;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\t \n\t\tmultiq3_set_ctrl(dev, MULTIQ3_CTRL_EN |\n\t\t\t\t      MULTIQ3_CTRL_E_CHAN(chan));\n\n\t\t \n\t\toutb(MULTIQ3_BP_RESET, dev->iobase + MULTIQ3_ENC_CTRL_REG);\n\n\t\t \n\t\toutb(MULTIQ3_TRSFRCNTR_OL, dev->iobase + MULTIQ3_ENC_CTRL_REG);\n\n\t\t \n\t\tval = inb(dev->iobase + MULTIQ3_ENC_DATA_REG);\n\t\tval |= (inb(dev->iobase + MULTIQ3_ENC_DATA_REG) << 8);\n\t\tval |= (inb(dev->iobase + MULTIQ3_ENC_DATA_REG) << 16);\n\n\t\t \n\t\tdata[i] = (val + ((s->maxdata + 1) >> 1)) & s->maxdata;\n\t}\n\n\treturn insn->n;\n}\n\nstatic void multiq3_encoder_reset(struct comedi_device *dev,\n\t\t\t\t  unsigned int chan)\n{\n\tmultiq3_set_ctrl(dev, MULTIQ3_CTRL_EN | MULTIQ3_CTRL_E_CHAN(chan));\n\toutb(MULTIQ3_EFLAG_RESET, dev->iobase + MULTIQ3_ENC_CTRL_REG);\n\toutb(MULTIQ3_BP_RESET, dev->iobase + MULTIQ3_ENC_CTRL_REG);\n\toutb(MULTIQ3_CLOCK_DATA, dev->iobase + MULTIQ3_ENC_DATA_REG);\n\toutb(MULTIQ3_CLOCK_SETUP, dev->iobase + MULTIQ3_ENC_CTRL_REG);\n\toutb(MULTIQ3_INPUT_SETUP, dev->iobase + MULTIQ3_ENC_CTRL_REG);\n\toutb(MULTIQ3_QUAD_X4, dev->iobase + MULTIQ3_ENC_CTRL_REG);\n\toutb(MULTIQ3_CNTR_RESET, dev->iobase + MULTIQ3_ENC_CTRL_REG);\n}\n\nstatic int multiq3_encoder_insn_config(struct comedi_device *dev,\n\t\t\t\t       struct comedi_subdevice *s,\n\t\t\t\t       struct comedi_insn *insn,\n\t\t\t\t       unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\n\tswitch (data[0]) {\n\tcase INSN_CONFIG_RESET:\n\t\tmultiq3_encoder_reset(dev, chan);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int multiq3_attach(struct comedi_device *dev,\n\t\t\t  struct comedi_devconfig *it)\n{\n\tstruct comedi_subdevice *s;\n\tint ret;\n\tint i;\n\n\tret = comedi_request_region(dev, it->options[0], 0x10);\n\tif (ret)\n\t\treturn ret;\n\n\tret = comedi_alloc_subdevices(dev, 5);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_AI;\n\ts->subdev_flags\t= SDF_READABLE | SDF_GROUND;\n\ts->n_chan\t= 8;\n\ts->maxdata\t= 0x1fff;\n\ts->range_table\t= &range_bipolar5;\n\ts->insn_read\t= multiq3_ai_insn_read;\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_AO;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= 8;\n\ts->maxdata\t= 0x0fff;\n\ts->range_table\t= &range_bipolar5;\n\ts->insn_write\t= multiq3_ao_insn_write;\n\n\tret = comedi_alloc_subdev_readback(s);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[2];\n\ts->type\t\t= COMEDI_SUBD_DI;\n\ts->subdev_flags\t= SDF_READABLE;\n\ts->n_chan\t= 16;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= multiq3_di_insn_bits;\n\n\t \n\ts = &dev->subdevices[3];\n\ts->type\t\t= COMEDI_SUBD_DO;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= 16;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= multiq3_do_insn_bits;\n\n\t \n\ts = &dev->subdevices[4];\n\ts->type\t\t= COMEDI_SUBD_COUNTER;\n\ts->subdev_flags\t= SDF_READABLE | SDF_LSAMPL;\n\ts->n_chan\t= it->options[2] * 2;\n\ts->maxdata\t= 0x00ffffff;\n\ts->range_table\t= &range_unknown;\n\ts->insn_read\t= multiq3_encoder_insn_read;\n\ts->insn_config\t= multiq3_encoder_insn_config;\n\n\tfor (i = 0; i < s->n_chan; i++)\n\t\tmultiq3_encoder_reset(dev, i);\n\n\treturn 0;\n}\n\nstatic struct comedi_driver multiq3_driver = {\n\t.driver_name\t= \"multiq3\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= multiq3_attach,\n\t.detach\t\t= comedi_legacy_detach,\n};\nmodule_comedi_driver(multiq3_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for Quanser Consulting MultiQ-3 board\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}