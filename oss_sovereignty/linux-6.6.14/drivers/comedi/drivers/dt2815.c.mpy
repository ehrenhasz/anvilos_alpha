{
  "module_name": "dt2815.c",
  "hash_id": "d26bd8e9681d8b0ff52a2c7e35bd94dcbcb6f364e6e01482169221f758569c79",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/dt2815.c",
  "human_readable_source": "\n \n \n\n#include <linux/module.h>\n#include <linux/comedi/comedidev.h>\n#include <linux/delay.h>\n\n#define DT2815_DATA 0\n#define DT2815_STATUS 1\n\nstruct dt2815_private {\n\tconst struct comedi_lrange *range_type_list[8];\n\tunsigned int ao_readback[8];\n};\n\nstatic int dt2815_ao_status(struct comedi_device *dev,\n\t\t\t    struct comedi_subdevice *s,\n\t\t\t    struct comedi_insn *insn,\n\t\t\t    unsigned long context)\n{\n\tunsigned int status;\n\n\tstatus = inb(dev->iobase + DT2815_STATUS);\n\tif (status == context)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int dt2815_ao_insn_read(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_insn *insn, unsigned int *data)\n{\n\tstruct dt2815_private *devpriv = dev->private;\n\tint i;\n\tint chan = CR_CHAN(insn->chanspec);\n\n\tfor (i = 0; i < insn->n; i++)\n\t\tdata[i] = devpriv->ao_readback[chan];\n\n\treturn i;\n}\n\nstatic int dt2815_ao_insn(struct comedi_device *dev, struct comedi_subdevice *s,\n\t\t\t  struct comedi_insn *insn, unsigned int *data)\n{\n\tstruct dt2815_private *devpriv = dev->private;\n\tint i;\n\tint chan = CR_CHAN(insn->chanspec);\n\tunsigned int lo, hi;\n\tint ret;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\t \n\t\tlo = ((data[i] & 0x0f) << 4) | (chan << 1) | 0x01;\n\t\thi = (data[i] & 0xff0) >> 4;\n\n\t\tret = comedi_timeout(dev, s, insn, dt2815_ao_status, 0x00);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\toutb(lo, dev->iobase + DT2815_DATA);\n\n\t\tret = comedi_timeout(dev, s, insn, dt2815_ao_status, 0x10);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\toutb(hi, dev->iobase + DT2815_DATA);\n\n\t\tdevpriv->ao_readback[chan] = data[i];\n\t}\n\treturn i;\n}\n\n \n\nstatic int dt2815_attach(struct comedi_device *dev, struct comedi_devconfig *it)\n{\n\tstruct dt2815_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tint i;\n\tconst struct comedi_lrange *current_range_type, *voltage_range_type;\n\tint ret;\n\n\tret = comedi_request_region(dev, it->options[0], 0x2);\n\tif (ret)\n\t\treturn ret;\n\n\tret = comedi_alloc_subdevices(dev, 1);\n\tif (ret)\n\t\treturn ret;\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\ts = &dev->subdevices[0];\n\t \n\ts->type = COMEDI_SUBD_AO;\n\ts->subdev_flags = SDF_WRITABLE;\n\ts->maxdata = 0xfff;\n\ts->n_chan = 8;\n\ts->insn_write = dt2815_ao_insn;\n\ts->insn_read = dt2815_ao_insn_read;\n\ts->range_table_list = devpriv->range_type_list;\n\n\tcurrent_range_type = (it->options[3])\n\t    ? &range_4_20mA : &range_0_32mA;\n\tvoltage_range_type = (it->options[2])\n\t    ? &range_bipolar5 : &range_unipolar5;\n\tfor (i = 0; i < 8; i++) {\n\t\tdevpriv->range_type_list[i] = (it->options[5 + i])\n\t\t    ? current_range_type : voltage_range_type;\n\t}\n\n\t \n\toutb(0x00, dev->iobase + DT2815_STATUS);\n\tfor (i = 0; i < 100; i++) {\n\t\t \n\t\tunsigned int status;\n\n\t\tusleep_range(1000, 3000);\n\t\tstatus = inb(dev->iobase + DT2815_STATUS);\n\t\tif (status == 4) {\n\t\t\tunsigned int program;\n\n\t\t\tprogram = (it->options[4] & 0x3) << 3 | 0x7;\n\t\t\toutb(program, dev->iobase + DT2815_DATA);\n\t\t\tdev_dbg(dev->class_dev, \"program: 0x%x (@t=%d)\\n\",\n\t\t\t\tprogram, i);\n\t\t\tbreak;\n\t\t} else if (status != 0x00) {\n\t\t\tdev_dbg(dev->class_dev,\n\t\t\t\t\"unexpected status 0x%x (@t=%d)\\n\",\n\t\t\t\tstatus, i);\n\t\t\tif (status & 0x60)\n\t\t\t\toutb(0x00, dev->iobase + DT2815_STATUS);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic struct comedi_driver dt2815_driver = {\n\t.driver_name\t= \"dt2815\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= dt2815_attach,\n\t.detach\t\t= comedi_legacy_detach,\n};\nmodule_comedi_driver(dt2815_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi low-level driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}