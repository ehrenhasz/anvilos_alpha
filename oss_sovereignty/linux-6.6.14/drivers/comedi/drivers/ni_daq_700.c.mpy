{
  "module_name": "ni_daq_700.c",
  "hash_id": "d5e6caa5cf16fc89dda57455d55b16a02e8e9ec87012d701342e87599fac53d2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/ni_daq_700.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedi_pcmcia.h>\n\n \n#define DIO_W\t\t0x04\t \n#define DIO_R\t\t0x05\t \n#define CMD_R1\t\t0x00\t \n#define CMD_R2\t\t0x07\t \n#define CMD_R3\t\t0x05\t \n#define STA_R1\t\t0x00\t \n#define STA_R2\t\t0x01\t \n#define ADFIFO_R\t0x02\t \n#define ADCLEAR_R\t0x01\t \n#define CDA_R0\t\t0x08\t \n#define CDA_R1\t\t0x09\t \n#define CDA_R2\t\t0x0A\t \n#define CMO_R\t\t0x0B\t \n#define TIC_R\t\t0x06\t \n \n#define CMD_R3_DIFF     0x04     \n\nstatic const struct comedi_lrange range_daq700_ai = {\n\t3,\n\t{\n\t\tBIP_RANGE(10),\n\t\tBIP_RANGE(5),\n\t\tBIP_RANGE(2.5)\n\t}\n};\n\nstatic int daq700_dio_insn_bits(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tunsigned int mask;\n\tunsigned int val;\n\n\tmask = comedi_dio_update_state(s, data);\n\tif (mask) {\n\t\tif (mask & 0xff)\n\t\t\toutb(s->state & 0xff, dev->iobase + DIO_W);\n\t}\n\n\tval = s->state & 0xff;\n\tval |= inb(dev->iobase + DIO_R) << 8;\n\n\tdata[1] = val;\n\n\treturn insn->n;\n}\n\nstatic int daq700_dio_insn_config(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s,\n\t\t\t\t  struct comedi_insn *insn,\n\t\t\t\t  unsigned int *data)\n{\n\tint ret;\n\n\tret = comedi_dio_insn_config(dev, s, insn, data, 0);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts->io_bits = 0x00ff;\n\n\treturn insn->n;\n}\n\nstatic int daq700_ai_eoc(struct comedi_device *dev,\n\t\t\t struct comedi_subdevice *s,\n\t\t\t struct comedi_insn *insn,\n\t\t\t unsigned long context)\n{\n\tunsigned int status;\n\n\tstatus = inb(dev->iobase + STA_R2);\n\tif ((status & 0x03))\n\t\treturn -EOVERFLOW;\n\tstatus = inb(dev->iobase + STA_R1);\n\tif ((status & 0x02))\n\t\treturn -ENODATA;\n\tif ((status & 0x11) == 0x01)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int daq700_ai_rinsn(struct comedi_device *dev,\n\t\t\t   struct comedi_subdevice *s,\n\t\t\t   struct comedi_insn *insn, unsigned int *data)\n{\n\tint n;\n\tint d;\n\tint ret;\n\tunsigned int chan\t= CR_CHAN(insn->chanspec);\n\tunsigned int aref\t= CR_AREF(insn->chanspec);\n\tunsigned int range\t= CR_RANGE(insn->chanspec);\n\tunsigned int r3_bits\t= 0;\n\n\t \n\tif (aref == AREF_DIFF)\n\t\tr3_bits |= CMD_R3_DIFF;\n\t \n\tif (range >= 1)\n\t\trange++;         \n\toutb(r3_bits | (range & 0x03), dev->iobase + CMD_R3);\n\n\t \n\t \n\toutb(chan | 0x80, dev->iobase + CMD_R1);\n\t \n\tudelay(2);\n\n\t \n\tfor (n = 0; n < insn->n; n++) {\n\t\t \n\t\toutb(0x00, dev->iobase + CMD_R2);  \n\t\toutb(0x30, dev->iobase + CMO_R);  \n\t\toutb(0x00, dev->iobase + ADCLEAR_R);\t \n\t\t \n\t\tinw(dev->iobase + ADFIFO_R);\n\t\t \n\t\toutb(0x32, dev->iobase + CMO_R);\n\n\t\t \n\t\tret = comedi_timeout(dev, s, insn, daq700_ai_eoc, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\td = inw(dev->iobase + ADFIFO_R);\n\t\t \n\t\t \n\t\td &= 0x0fff;\n\t\td ^= 0x0800;\n\t\tdata[n] = d;\n\t}\n\treturn n;\n}\n\n \nstatic void daq700_ai_config(struct comedi_device *dev,\n\t\t\t     struct comedi_subdevice *s)\n{\n\tunsigned long iobase = dev->iobase;\n\n\toutb(0x80, iobase + CMD_R1);\t \n\toutb(0x00, iobase + CMD_R2);\t \n\toutb(0x00, iobase + CMD_R3);\t \n\toutb(0x32, iobase + CMO_R);\t \n\toutb(0x00, iobase + TIC_R);\t \n\toutb(0x00, iobase + ADCLEAR_R);\t \n\tinw(iobase + ADFIFO_R);\t\t \n}\n\nstatic int daq700_auto_attach(struct comedi_device *dev,\n\t\t\t      unsigned long context)\n{\n\tstruct pcmcia_device *link = comedi_to_pcmcia_dev(dev);\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tlink->config_flags |= CONF_AUTO_SET_IO;\n\tret = comedi_pcmcia_enable(dev, NULL);\n\tif (ret)\n\t\treturn ret;\n\tdev->iobase = link->resource[0]->start;\n\n\tret = comedi_alloc_subdevices(dev, 2);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_DIO;\n\ts->subdev_flags\t= SDF_READABLE | SDF_WRITABLE;\n\ts->n_chan\t= 16;\n\ts->range_table\t= &range_digital;\n\ts->maxdata\t= 1;\n\ts->insn_bits\t= daq700_dio_insn_bits;\n\ts->insn_config\t= daq700_dio_insn_config;\n\ts->io_bits\t= 0x00ff;\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type = COMEDI_SUBD_AI;\n\ts->subdev_flags = SDF_READABLE | SDF_GROUND | SDF_DIFF;\n\ts->n_chan = 16;\n\ts->maxdata = BIT(12) - 1;\n\ts->range_table = &range_daq700_ai;\n\ts->insn_read = daq700_ai_rinsn;\n\tdaq700_ai_config(dev, s);\n\n\treturn 0;\n}\n\nstatic struct comedi_driver daq700_driver = {\n\t.driver_name\t= \"ni_daq_700\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= daq700_auto_attach,\n\t.detach\t\t= comedi_pcmcia_disable,\n};\n\nstatic int daq700_cs_attach(struct pcmcia_device *link)\n{\n\treturn comedi_pcmcia_auto_config(link, &daq700_driver);\n}\n\nstatic const struct pcmcia_device_id daq700_cs_ids[] = {\n\tPCMCIA_DEVICE_MANF_CARD(0x010b, 0x4743),\n\tPCMCIA_DEVICE_NULL\n};\nMODULE_DEVICE_TABLE(pcmcia, daq700_cs_ids);\n\nstatic struct pcmcia_driver daq700_cs_driver = {\n\t.name\t\t= \"ni_daq_700\",\n\t.owner\t\t= THIS_MODULE,\n\t.id_table\t= daq700_cs_ids,\n\t.probe\t\t= daq700_cs_attach,\n\t.remove\t\t= comedi_pcmcia_auto_unconfig,\n};\nmodule_comedi_pcmcia_driver(daq700_driver, daq700_cs_driver);\n\nMODULE_AUTHOR(\"Fred Brooks <nsaspook@nsaspook.com>\");\nMODULE_DESCRIPTION(\n\t\"Comedi driver for National Instruments PCMCIA DAQCard-700 DIO/AI\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}