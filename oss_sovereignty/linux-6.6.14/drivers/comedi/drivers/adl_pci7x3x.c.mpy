{
  "module_name": "adl_pci7x3x.c",
  "hash_id": "f21619b2243fac6d069edb3540fc2935043b6719ae0cba206b0728f0ef6934e0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/adl_pci7x3x.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedi_pci.h>\n\n#include \"plx9052.h\"\n\n \n#define PCI7X3X_DIO_REG\t\t0x0000\t \n#define PCI743X_DIO_REG\t\t0x0004\n\n#define ADL_PT_CLRIRQ\t\t0x0040\t \n\n#define LINTI1_EN_ACT_IDI0 (PLX9052_INTCSR_LI1ENAB | PLX9052_INTCSR_LI1STAT)\n#define LINTI2_EN_ACT_IDI1 (PLX9052_INTCSR_LI2ENAB | PLX9052_INTCSR_LI2STAT)\n#define EN_PCI_LINT2H_LINT1H\t\\\n\t(PLX9052_INTCSR_PCIENAB | PLX9052_INTCSR_LI2POL | PLX9052_INTCSR_LI1POL)\n\nenum adl_pci7x3x_boardid {\n\tBOARD_PCI7230,\n\tBOARD_PCI7233,\n\tBOARD_PCI7234,\n\tBOARD_PCI7432,\n\tBOARD_PCI7433,\n\tBOARD_PCI7434,\n};\n\nstruct adl_pci7x3x_boardinfo {\n\tconst char *name;\n\tint nsubdevs;\n\tint di_nchan;\n\tint do_nchan;\n\tint irq_nchan;\n};\n\nstatic const struct adl_pci7x3x_boardinfo adl_pci7x3x_boards[] = {\n\t[BOARD_PCI7230] = {\n\t\t.name\t\t= \"adl_pci7230\",\n\t\t.nsubdevs\t= 4,   \n\t\t.di_nchan\t= 16,\n\t\t.do_nchan\t= 16,\n\t\t.irq_nchan\t= 2,\n\t},\n\t[BOARD_PCI7233] = {\n\t\t.name\t\t= \"adl_pci7233\",\n\t\t.nsubdevs\t= 1,\n\t\t.di_nchan\t= 32,\n\t},\n\t[BOARD_PCI7234] = {\n\t\t.name\t\t= \"adl_pci7234\",\n\t\t.nsubdevs\t= 1,\n\t\t.do_nchan\t= 32,\n\t},\n\t[BOARD_PCI7432] = {\n\t\t.name\t\t= \"adl_pci7432\",\n\t\t.nsubdevs\t= 2,\n\t\t.di_nchan\t= 32,\n\t\t.do_nchan\t= 32,\n\t},\n\t[BOARD_PCI7433] = {\n\t\t.name\t\t= \"adl_pci7433\",\n\t\t.nsubdevs\t= 2,\n\t\t.di_nchan\t= 64,\n\t},\n\t[BOARD_PCI7434] = {\n\t\t.name\t\t= \"adl_pci7434\",\n\t\t.nsubdevs\t= 2,\n\t\t.do_nchan\t= 64,\n\t}\n};\n\nstruct adl_pci7x3x_dev_private_data {\n\tunsigned long lcr_io_base;\n\tunsigned int int_ctrl;\n};\n\nstruct adl_pci7x3x_sd_private_data {\n\tspinlock_t subd_slock;\t\t \n\tunsigned long port_offset;\n\tshort int cmd_running;\n};\n\nstatic void process_irq(struct comedi_device *dev, unsigned int subdev,\n\t\t\tunsigned short intcsr)\n{\n\tstruct comedi_subdevice *s = &dev->subdevices[subdev];\n\tstruct adl_pci7x3x_sd_private_data *sd_priv = s->private;\n\tunsigned long reg = sd_priv->port_offset;\n\tstruct comedi_async *async_p = s->async;\n\n\tif (async_p) {\n\t\tunsigned short val = inw(dev->iobase + reg);\n\n\t\tspin_lock(&sd_priv->subd_slock);\n\t\tif (sd_priv->cmd_running)\n\t\t\tcomedi_buf_write_samples(s, &val, 1);\n\t\tspin_unlock(&sd_priv->subd_slock);\n\t\tcomedi_handle_events(dev, s);\n\t}\n}\n\nstatic irqreturn_t adl_pci7x3x_interrupt(int irq, void *p_device)\n{\n\tstruct comedi_device *dev = p_device;\n\tstruct adl_pci7x3x_dev_private_data *dev_private = dev->private;\n\tunsigned long cpu_flags;\n\tunsigned int intcsr;\n\tbool li1stat, li2stat;\n\n\tif (!dev->attached) {\n\t\t \n\t\t \n\t\treturn IRQ_NONE;\n\t}\n\n\t \n\tspin_lock_irqsave(&dev->spinlock, cpu_flags);\n\tintcsr = inl(dev_private->lcr_io_base + PLX9052_INTCSR);\n\tli1stat = (intcsr & LINTI1_EN_ACT_IDI0) == LINTI1_EN_ACT_IDI0;\n\tli2stat = (intcsr & LINTI2_EN_ACT_IDI1) == LINTI2_EN_ACT_IDI1;\n\tif (li1stat || li2stat) {\n\t\t \n\t\t \n\t\toutb(0x00, dev->iobase + ADL_PT_CLRIRQ);\n\t}\n\tspin_unlock_irqrestore(&dev->spinlock, cpu_flags);\n\n\t \n\n\tif (li1stat)\t \n\t\tprocess_irq(dev, 2, intcsr);\n\n\tif (li2stat)\t \n\t\tprocess_irq(dev, 3, intcsr);\n\n\treturn IRQ_RETVAL(li1stat || li2stat);\n}\n\nstatic int adl_pci7x3x_asy_cmdtest(struct comedi_device *dev,\n\t\t\t\t   struct comedi_subdevice *s,\n\t\t\t\t   struct comedi_cmd *cmd)\n{\n\tint err = 0;\n\n\t \n\n\terr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);\n\terr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\n\terr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_NONE);\n\n\tif (err)\n\t\treturn 1;\n\n\t \n\t \n\n\t \n\n\terr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\n\t\t\t\t\t   cmd->chanlist_len);\n\terr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\n\n\tif (err)\n\t\treturn 3;\n\n\t \n\n\t \n\n\treturn 0;\n}\n\nstatic int adl_pci7x3x_asy_cmd(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s)\n{\n\tstruct adl_pci7x3x_dev_private_data *dev_private = dev->private;\n\tstruct adl_pci7x3x_sd_private_data *sd_priv = s->private;\n\tunsigned long cpu_flags;\n\tunsigned int int_enab;\n\n\tif (s->index == 2) {\n\t\t \n\t\tint_enab = PLX9052_INTCSR_LI1ENAB;\n\t} else {\n\t\t \n\t\tint_enab = PLX9052_INTCSR_LI2ENAB;\n\t}\n\n\tspin_lock_irqsave(&dev->spinlock, cpu_flags);\n\tdev_private->int_ctrl |= int_enab;\n\toutl(dev_private->int_ctrl, dev_private->lcr_io_base + PLX9052_INTCSR);\n\tspin_unlock_irqrestore(&dev->spinlock, cpu_flags);\n\n\tspin_lock_irqsave(&sd_priv->subd_slock, cpu_flags);\n\tsd_priv->cmd_running = 1;\n\tspin_unlock_irqrestore(&sd_priv->subd_slock, cpu_flags);\n\n\treturn 0;\n}\n\nstatic int adl_pci7x3x_asy_cancel(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s)\n{\n\tstruct adl_pci7x3x_dev_private_data *dev_private = dev->private;\n\tstruct adl_pci7x3x_sd_private_data *sd_priv = s->private;\n\tunsigned long cpu_flags;\n\tunsigned int int_enab;\n\n\tspin_lock_irqsave(&sd_priv->subd_slock, cpu_flags);\n\tsd_priv->cmd_running = 0;\n\tspin_unlock_irqrestore(&sd_priv->subd_slock, cpu_flags);\n\t \n\tif (s->index == 2)\n\t\tint_enab = PLX9052_INTCSR_LI1ENAB;\n\telse\n\t\tint_enab = PLX9052_INTCSR_LI2ENAB;\n\tspin_lock_irqsave(&dev->spinlock, cpu_flags);\n\tdev_private->int_ctrl &= ~int_enab;\n\toutl(dev_private->int_ctrl, dev_private->lcr_io_base + PLX9052_INTCSR);\n\tspin_unlock_irqrestore(&dev->spinlock, cpu_flags);\n\n\treturn 0;\n}\n\n \nstatic int adl_pci7x3x_dirq_insn_bits(struct comedi_device *dev,\n\t\t\t\t      struct comedi_subdevice *s,\n\t\t\t\t      struct comedi_insn *insn,\n\t\t\t\t      unsigned int *data)\n{\n\tstruct adl_pci7x3x_sd_private_data *sd_priv = s->private;\n\tunsigned long reg = (unsigned long)sd_priv->port_offset;\n\n\tdata[1] = inl(dev->iobase + reg);\n\n\treturn insn->n;\n}\n\nstatic int adl_pci7x3x_do_insn_bits(struct comedi_device *dev,\n\t\t\t\t    struct comedi_subdevice *s,\n\t\t\t\t    struct comedi_insn *insn,\n\t\t\t\t    unsigned int *data)\n{\n\tunsigned long reg = (unsigned long)s->private;\n\n\tif (comedi_dio_update_state(s, data)) {\n\t\tunsigned int val = s->state;\n\n\t\tif (s->n_chan == 16) {\n\t\t\t \n\t\t\tval |= val << 16;\n\t\t}\n\t\toutl(val, dev->iobase + reg);\n\t}\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int adl_pci7x3x_di_insn_bits(struct comedi_device *dev,\n\t\t\t\t    struct comedi_subdevice *s,\n\t\t\t\t    struct comedi_insn *insn,\n\t\t\t\t    unsigned int *data)\n{\n\tunsigned long reg = (unsigned long)s->private;\n\n\tdata[1] = inl(dev->iobase + reg);\n\n\treturn insn->n;\n}\n\nstatic int adl_pci7x3x_reset(struct comedi_device *dev)\n{\n\tstruct adl_pci7x3x_dev_private_data *dev_private = dev->private;\n\n\t \n\tdev_private->int_ctrl = 0x00;   \n\toutl(dev_private->int_ctrl, dev_private->lcr_io_base + PLX9052_INTCSR);\n\n\treturn 0;\n}\n\nstatic int adl_pci7x3x_auto_attach(struct comedi_device *dev,\n\t\t\t\t   unsigned long context)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tconst struct adl_pci7x3x_boardinfo *board = NULL;\n\tstruct comedi_subdevice *s;\n\tstruct adl_pci7x3x_dev_private_data *dev_private;\n\tint subdev;\n\tint nchan;\n\tint ret;\n\tint ic;\n\n\tif (context < ARRAY_SIZE(adl_pci7x3x_boards))\n\t\tboard = &adl_pci7x3x_boards[context];\n\tif (!board)\n\t\treturn -ENODEV;\n\tdev->board_ptr = board;\n\tdev->board_name = board->name;\n\n\tdev_private = comedi_alloc_devpriv(dev, sizeof(*dev_private));\n\tif (!dev_private)\n\t\treturn -ENOMEM;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\tdev->iobase = pci_resource_start(pcidev, 2);\n\tdev_private->lcr_io_base = pci_resource_start(pcidev, 1);\n\n\tadl_pci7x3x_reset(dev);\n\n\tif (board->irq_nchan) {\n\t\t \n\t\toutb(0x00, dev->iobase + ADL_PT_CLRIRQ);\n\n\t\tif (pcidev->irq) {\n\t\t\tret = request_irq(pcidev->irq, adl_pci7x3x_interrupt,\n\t\t\t\t\t  IRQF_SHARED, dev->board_name, dev);\n\t\t\tif (ret == 0) {\n\t\t\t\tdev->irq = pcidev->irq;\n\t\t\t\t \n\t\t\t\tdev_private->int_ctrl = EN_PCI_LINT2H_LINT1H;\n\t\t\t\toutl(dev_private->int_ctrl,\n\t\t\t\t     dev_private->lcr_io_base + PLX9052_INTCSR);\n\t\t\t}\n\t\t}\n\t}\n\n\tret = comedi_alloc_subdevices(dev, board->nsubdevs);\n\tif (ret)\n\t\treturn ret;\n\n\tsubdev = 0;\n\n\tif (board->di_nchan) {\n\t\tnchan = min(board->di_nchan, 32);\n\n\t\ts = &dev->subdevices[subdev];\n\t\t \n\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\ts->subdev_flags\t= SDF_READABLE;\n\t\ts->n_chan\t= nchan;\n\t\ts->maxdata\t= 1;\n\t\ts->insn_bits\t= adl_pci7x3x_di_insn_bits;\n\t\ts->range_table\t= &range_digital;\n\n\t\ts->private\t= (void *)PCI7X3X_DIO_REG;\n\n\t\tsubdev++;\n\n\t\tnchan = board->di_nchan - nchan;\n\t\tif (nchan) {\n\t\t\ts = &dev->subdevices[subdev];\n\t\t\t \n\t\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\t\ts->subdev_flags\t= SDF_READABLE;\n\t\t\ts->n_chan\t= nchan;\n\t\t\ts->maxdata\t= 1;\n\t\t\ts->insn_bits\t= adl_pci7x3x_di_insn_bits;\n\t\t\ts->range_table\t= &range_digital;\n\n\t\t\ts->private\t= (void *)PCI743X_DIO_REG;\n\n\t\t\tsubdev++;\n\t\t}\n\t}\n\n\tif (board->do_nchan) {\n\t\tnchan = min(board->do_nchan, 32);\n\n\t\ts = &dev->subdevices[subdev];\n\t\t \n\t\ts->type\t\t= COMEDI_SUBD_DO;\n\t\ts->subdev_flags\t= SDF_WRITABLE;\n\t\ts->n_chan\t= nchan;\n\t\ts->maxdata\t= 1;\n\t\ts->insn_bits\t= adl_pci7x3x_do_insn_bits;\n\t\ts->range_table\t= &range_digital;\n\n\t\ts->private\t= (void *)PCI7X3X_DIO_REG;\n\n\t\tsubdev++;\n\n\t\tnchan = board->do_nchan - nchan;\n\t\tif (nchan) {\n\t\t\ts = &dev->subdevices[subdev];\n\t\t\t \n\t\t\ts->type\t\t= COMEDI_SUBD_DO;\n\t\t\ts->subdev_flags\t= SDF_WRITABLE;\n\t\t\ts->n_chan\t= nchan;\n\t\t\ts->maxdata\t= 1;\n\t\t\ts->insn_bits\t= adl_pci7x3x_do_insn_bits;\n\t\t\ts->range_table\t= &range_digital;\n\n\t\t\ts->private\t= (void *)PCI743X_DIO_REG;\n\n\t\t\tsubdev++;\n\t\t}\n\t}\n\n\tfor (ic = 0; ic < board->irq_nchan; ++ic) {\n\t\tstruct adl_pci7x3x_sd_private_data *sd_priv;\n\n\t\tnchan = 1;\n\n\t\ts = &dev->subdevices[subdev];\n\t\t \n\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\ts->subdev_flags\t= SDF_READABLE;\n\t\ts->n_chan\t= nchan;\n\t\ts->maxdata\t= 1;\n\t\ts->insn_bits\t= adl_pci7x3x_dirq_insn_bits;\n\t\ts->range_table\t= &range_digital;\n\n\t\tsd_priv = comedi_alloc_spriv(s, sizeof(*sd_priv));\n\t\tif (!sd_priv)\n\t\t\treturn -ENOMEM;\n\n\t\tspin_lock_init(&sd_priv->subd_slock);\n\t\tsd_priv->port_offset = PCI7X3X_DIO_REG;\n\t\tsd_priv->cmd_running = 0;\n\n\t\tif (dev->irq) {\n\t\t\tdev->read_subdev = s;\n\t\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\t\ts->subdev_flags\t= SDF_READABLE | SDF_CMD_READ;\n\t\t\ts->len_chanlist\t= 1;\n\t\t\ts->do_cmdtest\t= adl_pci7x3x_asy_cmdtest;\n\t\t\ts->do_cmd\t= adl_pci7x3x_asy_cmd;\n\t\t\ts->cancel\t= adl_pci7x3x_asy_cancel;\n\t\t}\n\n\t\tsubdev++;\n\t}\n\n\treturn 0;\n}\n\nstatic void adl_pci7x3x_detach(struct comedi_device *dev)\n{\n\tif (dev->iobase)\n\t\tadl_pci7x3x_reset(dev);\n\tcomedi_pci_detach(dev);\n}\n\nstatic struct comedi_driver adl_pci7x3x_driver = {\n\t.driver_name\t= \"adl_pci7x3x\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= adl_pci7x3x_auto_attach,\n\t.detach\t\t= adl_pci7x3x_detach,\n};\n\nstatic int adl_pci7x3x_pci_probe(struct pci_dev *dev,\n\t\t\t\t const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &adl_pci7x3x_driver,\n\t\t\t\t      id->driver_data);\n}\n\nstatic const struct pci_device_id adl_pci7x3x_pci_table[] = {\n\t{ PCI_VDEVICE(ADLINK, 0x7230), BOARD_PCI7230 },\n\t{ PCI_VDEVICE(ADLINK, 0x7233), BOARD_PCI7233 },\n\t{ PCI_VDEVICE(ADLINK, 0x7234), BOARD_PCI7234 },\n\t{ PCI_VDEVICE(ADLINK, 0x7432), BOARD_PCI7432 },\n\t{ PCI_VDEVICE(ADLINK, 0x7433), BOARD_PCI7433 },\n\t{ PCI_VDEVICE(ADLINK, 0x7434), BOARD_PCI7434 },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, adl_pci7x3x_pci_table);\n\nstatic struct pci_driver adl_pci7x3x_pci_driver = {\n\t.name\t\t= \"adl_pci7x3x\",\n\t.id_table\t= adl_pci7x3x_pci_table,\n\t.probe\t\t= adl_pci7x3x_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(adl_pci7x3x_driver, adl_pci7x3x_pci_driver);\n\nMODULE_DESCRIPTION(\"ADLINK PCI-723x/743x Isolated Digital I/O boards\");\nMODULE_AUTHOR(\"H Hartley Sweeten <hsweeten@visionengravers.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}