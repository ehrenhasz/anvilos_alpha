{
  "module_name": "adv_pci1720.c",
  "hash_id": "2057a8e511d7b2538f5a9deaacd72d0ae7f69c30734c5ffaf5ec132b17504499",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/adv_pci1720.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/comedi/comedi_pci.h>\n\n \n#define PCI1720_AO_LSB_REG(x)\t\t(0x00 + ((x) * 2))\n#define PCI1720_AO_MSB_REG(x)\t\t(0x01 + ((x) * 2))\n#define PCI1720_AO_RANGE_REG\t\t0x08\n#define PCI1720_AO_RANGE(c, r)\t\t(((r) & 0x3) << ((c) * 2))\n#define PCI1720_AO_RANGE_MASK(c)\tPCI1720_AO_RANGE((c), 0x3)\n#define PCI1720_SYNC_REG\t\t0x09\n#define PCI1720_SYNC_CTRL_REG\t\t0x0f\n#define PCI1720_SYNC_CTRL_SC0\t\tBIT(0)\n#define PCI1720_BOARDID_REG\t\t0x14\n\nstatic const struct comedi_lrange pci1720_ao_range = {\n\t4, {\n\t\tUNI_RANGE(5),\n\t\tUNI_RANGE(10),\n\t\tBIP_RANGE(5),\n\t\tBIP_RANGE(10)\n\t}\n};\n\nstatic int pci1720_ao_insn_write(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int range = CR_RANGE(insn->chanspec);\n\tunsigned int val;\n\tint i;\n\n\t \n\tval = inb(dev->iobase + PCI1720_AO_RANGE_REG);\n\tval &= ~PCI1720_AO_RANGE_MASK(chan);\n\tval |= PCI1720_AO_RANGE(chan, range);\n\toutb(val, dev->iobase + PCI1720_AO_RANGE_REG);\n\n\tval = s->readback[chan];\n\tfor (i = 0; i < insn->n; i++) {\n\t\tval = data[i];\n\n\t\toutb(val & 0xff, dev->iobase + PCI1720_AO_LSB_REG(chan));\n\t\toutb((val >> 8) & 0xff, dev->iobase + PCI1720_AO_MSB_REG(chan));\n\n\t\t \n\t\tusleep_range(2, 100);\n\t}\n\n\ts->readback[chan] = val;\n\n\treturn insn->n;\n}\n\nstatic int pci1720_di_insn_bits(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tdata[1] = inb(dev->iobase + PCI1720_BOARDID_REG);\n\n\treturn insn->n;\n}\n\nstatic int pci1720_auto_attach(struct comedi_device *dev,\n\t\t\t       unsigned long context)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\tdev->iobase = pci_resource_start(pcidev, 2);\n\n\tret = comedi_alloc_subdevices(dev, 2);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_AO;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= 4;\n\ts->maxdata\t= 0x0fff;\n\ts->range_table\t= &pci1720_ao_range;\n\ts->insn_write\t= pci1720_ao_insn_write;\n\n\tret = comedi_alloc_subdev_readback(s);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_DI;\n\ts->subdev_flags\t= SDF_READABLE;\n\ts->n_chan\t= 4;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= pci1720_di_insn_bits;\n\n\t \n\toutb(0, dev->iobase + PCI1720_SYNC_CTRL_REG);\n\n\treturn 0;\n}\n\nstatic struct comedi_driver adv_pci1720_driver = {\n\t.driver_name\t= \"adv_pci1720\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= pci1720_auto_attach,\n\t.detach\t\t= comedi_pci_detach,\n};\n\nstatic int adv_pci1720_pci_probe(struct pci_dev *dev,\n\t\t\t\t const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &adv_pci1720_driver,\n\t\t\t\t      id->driver_data);\n}\n\nstatic const struct pci_device_id adv_pci1720_pci_table[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_ADVANTECH, 0x1720) },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, adv_pci1720_pci_table);\n\nstatic struct pci_driver adv_pci1720_pci_driver = {\n\t.name\t\t= \"adv_pci1720\",\n\t.id_table\t= adv_pci1720_pci_table,\n\t.probe\t\t= adv_pci1720_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(adv_pci1720_driver, adv_pci1720_pci_driver);\n\nMODULE_AUTHOR(\"H Hartley Sweeten <hsweeten@visionengravers.com>\");\nMODULE_DESCRIPTION(\"Comedi driver for Advantech PCI-1720 Analog Output board\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}