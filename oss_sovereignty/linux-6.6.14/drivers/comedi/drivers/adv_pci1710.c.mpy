{
  "module_name": "adv_pci1710.c",
  "hash_id": "eaddb97a61d0d50972ec613827aa958e254d968606cf77898f618da9223c26a7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/adv_pci1710.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedi_pci.h>\n#include <linux/comedi/comedi_8254.h>\n\n#include \"amcc_s5933.h\"\n\n \n#define PCI171X_AD_DATA_REG\t0x00\t \n#define PCI171X_SOFTTRG_REG\t0x00\t \n#define PCI171X_RANGE_REG\t0x02\t \n#define PCI171X_RANGE_DIFF\tBIT(5)\n#define PCI171X_RANGE_UNI\tBIT(4)\n#define PCI171X_RANGE_GAIN(x)\t(((x) & 0x7) << 0)\n#define PCI171X_MUX_REG\t\t0x04\t \n#define PCI171X_MUX_CHANH(x)\t(((x) & 0xff) << 8)\n#define PCI171X_MUX_CHANL(x)\t(((x) & 0xff) << 0)\n#define PCI171X_MUX_CHAN(x)\t(PCI171X_MUX_CHANH(x) | PCI171X_MUX_CHANL(x))\n#define PCI171X_STATUS_REG\t0x06\t \n#define PCI171X_STATUS_IRQ\tBIT(11)\t \n#define PCI171X_STATUS_FF\tBIT(10)\t \n#define PCI171X_STATUS_FH\tBIT(9)\t \n#define PCI171X_STATUS_FE\tBIT(8)\t \n#define PCI171X_CTRL_REG\t0x06\t \n#define PCI171X_CTRL_CNT0\tBIT(6)\t \n#define PCI171X_CTRL_ONEFH\tBIT(5)\t \n#define PCI171X_CTRL_IRQEN\tBIT(4)\t \n#define PCI171X_CTRL_GATE\tBIT(3)\t \n#define PCI171X_CTRL_EXT\tBIT(2)\t \n#define PCI171X_CTRL_PACER\tBIT(1)\t \n#define PCI171X_CTRL_SW\t\tBIT(0)\t \n#define PCI171X_CLRINT_REG\t0x08\t \n#define PCI171X_CLRFIFO_REG\t0x09\t \n#define PCI171X_DA_REG(x)\t(0x0a + ((x) * 2))  \n#define PCI171X_DAREF_REG\t0x0e\t \n#define PCI171X_DAREF(c, r)\t(((r) & 0x3) << ((c) * 2))\n#define PCI171X_DAREF_MASK(c)\tPCI171X_DAREF((c), 0x3)\n#define PCI171X_DI_REG\t\t0x10\t \n#define PCI171X_DO_REG\t\t0x10\t \n#define PCI171X_TIMER_BASE\t0x18\t \n\nstatic const struct comedi_lrange pci1710_ai_range = {\n\t9, {\n\t\tBIP_RANGE(5),\t\t \n\t\tBIP_RANGE(2.5),\t\t \n\t\tBIP_RANGE(1.25),\t \n\t\tBIP_RANGE(0.625),\t \n\t\tBIP_RANGE(10),\t\t \n\t\tUNI_RANGE(10),\t\t \n\t\tUNI_RANGE(5),\t\t \n\t\tUNI_RANGE(2.5),\t\t \n\t\tUNI_RANGE(1.25)\t\t \n\t}\n};\n\nstatic const struct comedi_lrange pci1710hg_ai_range = {\n\t12, {\n\t\tBIP_RANGE(5),\t\t \n\t\tBIP_RANGE(0.5),\t\t \n\t\tBIP_RANGE(0.05),\t \n\t\tBIP_RANGE(0.005),\t \n\t\tBIP_RANGE(10),\t\t \n\t\tBIP_RANGE(1),\t\t \n\t\tBIP_RANGE(0.1),\t\t \n\t\tBIP_RANGE(0.01),\t \n\t\tUNI_RANGE(10),\t\t \n\t\tUNI_RANGE(1),\t\t \n\t\tUNI_RANGE(0.1),\t\t \n\t\tUNI_RANGE(0.01)\t\t \n\t}\n};\n\nstatic const struct comedi_lrange pci1711_ai_range = {\n\t5, {\n\t\tBIP_RANGE(10),\t\t \n\t\tBIP_RANGE(5),\t\t \n\t\tBIP_RANGE(2.5),\t\t \n\t\tBIP_RANGE(1.25),\t \n\t\tBIP_RANGE(0.625)\t \n\t}\n};\n\nstatic const struct comedi_lrange pci171x_ao_range = {\n\t3, {\n\t\tUNI_RANGE(5),\t\t \n\t\tUNI_RANGE(10),\t\t \n\t\tRANGE_ext(0, 1)\t\t \n\t}\n};\n\nenum pci1710_boardid {\n\tBOARD_PCI1710,\n\tBOARD_PCI1710HG,\n\tBOARD_PCI1711,\n\tBOARD_PCI1713,\n\tBOARD_PCI1731,\n};\n\nstruct boardtype {\n\tconst char *name;\n\tconst struct comedi_lrange *ai_range;\n\tunsigned int is_pci1711:1;\n\tunsigned int is_pci1713:1;\n\tunsigned int has_ao:1;\n};\n\nstatic const struct boardtype boardtypes[] = {\n\t[BOARD_PCI1710] = {\n\t\t.name\t\t= \"pci1710\",\n\t\t.ai_range\t= &pci1710_ai_range,\n\t\t.has_ao\t\t= 1,\n\t},\n\t[BOARD_PCI1710HG] = {\n\t\t.name\t\t= \"pci1710hg\",\n\t\t.ai_range\t= &pci1710hg_ai_range,\n\t\t.has_ao\t\t= 1,\n\t},\n\t[BOARD_PCI1711] = {\n\t\t.name\t\t= \"pci1711\",\n\t\t.ai_range\t= &pci1711_ai_range,\n\t\t.is_pci1711\t= 1,\n\t\t.has_ao\t\t= 1,\n\t},\n\t[BOARD_PCI1713] = {\n\t\t.name\t\t= \"pci1713\",\n\t\t.ai_range\t= &pci1710_ai_range,\n\t\t.is_pci1713\t= 1,\n\t},\n\t[BOARD_PCI1731] = {\n\t\t.name\t\t= \"pci1731\",\n\t\t.ai_range\t= &pci1711_ai_range,\n\t\t.is_pci1711\t= 1,\n\t},\n};\n\nstruct pci1710_private {\n\tunsigned int max_samples;\n\tunsigned int ctrl;\t \n\tunsigned int ctrl_ext;\t \n\tunsigned int mux_scan;\t \n\tunsigned char ai_et;\n\tunsigned int act_chanlist[32];\t \n\tunsigned char saved_seglen;\t \n\tunsigned char da_ranges;\t \n\tunsigned char unipolar_gain;\t \n};\n\nstatic int pci1710_ai_check_chanlist(struct comedi_device *dev,\n\t\t\t\t     struct comedi_subdevice *s,\n\t\t\t\t     struct comedi_cmd *cmd)\n{\n\tstruct pci1710_private *devpriv = dev->private;\n\tunsigned int chan0 = CR_CHAN(cmd->chanlist[0]);\n\tunsigned int last_aref = CR_AREF(cmd->chanlist[0]);\n\tunsigned int next_chan = (chan0 + 1) % s->n_chan;\n\tunsigned int chansegment[32];\n\tunsigned int seglen;\n\tint i;\n\n\tif (cmd->chanlist_len == 1) {\n\t\tdevpriv->saved_seglen = cmd->chanlist_len;\n\t\treturn 0;\n\t}\n\n\t \n\tchansegment[0] = cmd->chanlist[0];\n\n\tfor (i = 1; i < cmd->chanlist_len; i++) {\n\t\tunsigned int chan = CR_CHAN(cmd->chanlist[i]);\n\t\tunsigned int aref = CR_AREF(cmd->chanlist[i]);\n\n\t\tif (cmd->chanlist[0] == cmd->chanlist[i])\n\t\t\tbreak;\t \n\n\t\tif (aref == AREF_DIFF && (chan & 1)) {\n\t\t\tdev_err(dev->class_dev,\n\t\t\t\t\"Odd channel cannot be differential input!\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tif (last_aref == AREF_DIFF)\n\t\t\tnext_chan = (next_chan + 1) % s->n_chan;\n\t\tif (chan != next_chan) {\n\t\t\tdev_err(dev->class_dev,\n\t\t\t\t\"channel list must be continuous! chanlist[%i]=%d but must be %d or %d!\\n\",\n\t\t\t\ti, chan, next_chan, chan0);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tchansegment[i] = cmd->chanlist[i];\n\t\tlast_aref = aref;\n\t}\n\tseglen = i;\n\n\tfor (i = 0; i < cmd->chanlist_len; i++) {\n\t\tif (cmd->chanlist[i] != chansegment[i % seglen]) {\n\t\t\tdev_err(dev->class_dev,\n\t\t\t\t\"bad channel, reference or range number! chanlist[%i]=%d,%d,%d and not %d,%d,%d!\\n\",\n\t\t\t\ti, CR_CHAN(chansegment[i]),\n\t\t\t\tCR_RANGE(chansegment[i]),\n\t\t\t\tCR_AREF(chansegment[i]),\n\t\t\t\tCR_CHAN(cmd->chanlist[i % seglen]),\n\t\t\t\tCR_RANGE(cmd->chanlist[i % seglen]),\n\t\t\t\tCR_AREF(chansegment[i % seglen]));\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\tdevpriv->saved_seglen = seglen;\n\n\treturn 0;\n}\n\nstatic void pci1710_ai_setup_chanlist(struct comedi_device *dev,\n\t\t\t\t      struct comedi_subdevice *s,\n\t\t\t\t      unsigned int *chanlist,\n\t\t\t\t      unsigned int n_chan,\n\t\t\t\t      unsigned int seglen)\n{\n\tstruct pci1710_private *devpriv = dev->private;\n\tunsigned int first_chan = CR_CHAN(chanlist[0]);\n\tunsigned int last_chan = CR_CHAN(chanlist[seglen - 1]);\n\tunsigned int i;\n\n\tfor (i = 0; i < seglen; i++) {\t \n\t\tunsigned int chan = CR_CHAN(chanlist[i]);\n\t\tunsigned int range = CR_RANGE(chanlist[i]);\n\t\tunsigned int aref = CR_AREF(chanlist[i]);\n\t\tunsigned int rangeval = 0;\n\n\t\tif (aref == AREF_DIFF)\n\t\t\trangeval |= PCI171X_RANGE_DIFF;\n\t\tif (comedi_range_is_unipolar(s, range)) {\n\t\t\trangeval |= PCI171X_RANGE_UNI;\n\t\t\trange -= devpriv->unipolar_gain;\n\t\t}\n\t\trangeval |= PCI171X_RANGE_GAIN(range);\n\n\t\t \n\t\toutw(PCI171X_MUX_CHAN(chan), dev->iobase + PCI171X_MUX_REG);\n\t\toutw(rangeval, dev->iobase + PCI171X_RANGE_REG);\n\n\t\tdevpriv->act_chanlist[i] = chan;\n\t}\n\tfor ( ; i < n_chan; i++)\t \n\t\tdevpriv->act_chanlist[i] = CR_CHAN(chanlist[i]);\n\n\t \n\tdevpriv->mux_scan = PCI171X_MUX_CHANL(first_chan) |\n\t\t\t    PCI171X_MUX_CHANH(last_chan);\n\toutw(devpriv->mux_scan, dev->iobase + PCI171X_MUX_REG);\n}\n\nstatic int pci1710_ai_eoc(struct comedi_device *dev,\n\t\t\t  struct comedi_subdevice *s,\n\t\t\t  struct comedi_insn *insn,\n\t\t\t  unsigned long context)\n{\n\tunsigned int status;\n\n\tstatus = inw(dev->iobase + PCI171X_STATUS_REG);\n\tif ((status & PCI171X_STATUS_FE) == 0)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int pci1710_ai_read_sample(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s,\n\t\t\t\t  unsigned int cur_chan,\n\t\t\t\t  unsigned short *val)\n{\n\tconst struct boardtype *board = dev->board_ptr;\n\tstruct pci1710_private *devpriv = dev->private;\n\tunsigned short sample;\n\tunsigned int chan;\n\n\tsample = inw(dev->iobase + PCI171X_AD_DATA_REG);\n\tif (!board->is_pci1713) {\n\t\t \n\t\tchan = sample >> 12;\n\t\tif (chan != devpriv->act_chanlist[cur_chan]) {\n\t\t\tdev_err(dev->class_dev,\n\t\t\t\t\"A/D data dropout: received from channel %d, expected %d\\n\",\n\t\t\t\tchan, devpriv->act_chanlist[cur_chan]);\n\t\t\treturn -ENODATA;\n\t\t}\n\t}\n\t*val = sample & s->maxdata;\n\treturn 0;\n}\n\nstatic int pci1710_ai_insn_read(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tstruct pci1710_private *devpriv = dev->private;\n\tint ret = 0;\n\tint i;\n\n\t \n\tdevpriv->ctrl |= PCI171X_CTRL_SW;\n\toutw(devpriv->ctrl, dev->iobase + PCI171X_CTRL_REG);\n\n\toutb(0, dev->iobase + PCI171X_CLRFIFO_REG);\n\toutb(0, dev->iobase + PCI171X_CLRINT_REG);\n\n\tpci1710_ai_setup_chanlist(dev, s, &insn->chanspec, 1, 1);\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tunsigned short val;\n\n\t\t \n\t\toutw(0, dev->iobase + PCI171X_SOFTTRG_REG);\n\n\t\tret = comedi_timeout(dev, s, insn, pci1710_ai_eoc, 0);\n\t\tif (ret)\n\t\t\tbreak;\n\n\t\tret = pci1710_ai_read_sample(dev, s, 0, &val);\n\t\tif (ret)\n\t\t\tbreak;\n\n\t\tdata[i] = val;\n\t}\n\n\t \n\tdevpriv->ctrl &= ~PCI171X_CTRL_SW;\n\toutw(devpriv->ctrl, dev->iobase + PCI171X_CTRL_REG);\n\n\toutb(0, dev->iobase + PCI171X_CLRFIFO_REG);\n\toutb(0, dev->iobase + PCI171X_CLRINT_REG);\n\n\treturn ret ? ret : insn->n;\n}\n\nstatic int pci1710_ai_cancel(struct comedi_device *dev,\n\t\t\t     struct comedi_subdevice *s)\n{\n\tstruct pci1710_private *devpriv = dev->private;\n\n\t \n\tdevpriv->ctrl &= PCI171X_CTRL_CNT0;\t \n\toutw(devpriv->ctrl, dev->iobase + PCI171X_CTRL_REG);\n\n\t \n\tcomedi_8254_pacer_enable(dev->pacer, 1, 2, false);\n\n\t \n\toutb(0, dev->iobase + PCI171X_CLRFIFO_REG);\n\toutb(0, dev->iobase + PCI171X_CLRINT_REG);\n\n\treturn 0;\n}\n\nstatic void pci1710_handle_every_sample(struct comedi_device *dev,\n\t\t\t\t\tstruct comedi_subdevice *s)\n{\n\tstruct comedi_cmd *cmd = &s->async->cmd;\n\tunsigned int status;\n\tunsigned short val;\n\tint ret;\n\n\tstatus = inw(dev->iobase + PCI171X_STATUS_REG);\n\tif (status & PCI171X_STATUS_FE) {\n\t\tdev_dbg(dev->class_dev, \"A/D FIFO empty (%4x)\\n\", status);\n\t\ts->async->events |= COMEDI_CB_ERROR;\n\t\treturn;\n\t}\n\tif (status & PCI171X_STATUS_FF) {\n\t\tdev_dbg(dev->class_dev,\n\t\t\t\"A/D FIFO Full status (Fatal Error!) (%4x)\\n\", status);\n\t\ts->async->events |= COMEDI_CB_ERROR;\n\t\treturn;\n\t}\n\n\toutb(0, dev->iobase + PCI171X_CLRINT_REG);\n\n\tfor (; !(inw(dev->iobase + PCI171X_STATUS_REG) & PCI171X_STATUS_FE);) {\n\t\tret = pci1710_ai_read_sample(dev, s, s->async->cur_chan, &val);\n\t\tif (ret) {\n\t\t\ts->async->events |= COMEDI_CB_ERROR;\n\t\t\tbreak;\n\t\t}\n\n\t\tcomedi_buf_write_samples(s, &val, 1);\n\n\t\tif (cmd->stop_src == TRIG_COUNT &&\n\t\t    s->async->scans_done >= cmd->stop_arg) {\n\t\t\ts->async->events |= COMEDI_CB_EOA;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\toutb(0, dev->iobase + PCI171X_CLRINT_REG);\n}\n\nstatic void pci1710_handle_fifo(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s)\n{\n\tstruct pci1710_private *devpriv = dev->private;\n\tstruct comedi_async *async = s->async;\n\tstruct comedi_cmd *cmd = &async->cmd;\n\tunsigned int status;\n\tint i;\n\n\tstatus = inw(dev->iobase + PCI171X_STATUS_REG);\n\tif (!(status & PCI171X_STATUS_FH)) {\n\t\tdev_dbg(dev->class_dev, \"A/D FIFO not half full!\\n\");\n\t\tasync->events |= COMEDI_CB_ERROR;\n\t\treturn;\n\t}\n\tif (status & PCI171X_STATUS_FF) {\n\t\tdev_dbg(dev->class_dev,\n\t\t\t\"A/D FIFO Full status (Fatal Error!)\\n\");\n\t\tasync->events |= COMEDI_CB_ERROR;\n\t\treturn;\n\t}\n\n\tfor (i = 0; i < devpriv->max_samples; i++) {\n\t\tunsigned short val;\n\t\tint ret;\n\n\t\tret = pci1710_ai_read_sample(dev, s, s->async->cur_chan, &val);\n\t\tif (ret) {\n\t\t\ts->async->events |= COMEDI_CB_ERROR;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!comedi_buf_write_samples(s, &val, 1))\n\t\t\tbreak;\n\n\t\tif (cmd->stop_src == TRIG_COUNT &&\n\t\t    async->scans_done >= cmd->stop_arg) {\n\t\t\tasync->events |= COMEDI_CB_EOA;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\toutb(0, dev->iobase + PCI171X_CLRINT_REG);\n}\n\nstatic irqreturn_t pci1710_irq_handler(int irq, void *d)\n{\n\tstruct comedi_device *dev = d;\n\tstruct pci1710_private *devpriv = dev->private;\n\tstruct comedi_subdevice *s;\n\tstruct comedi_cmd *cmd;\n\n\tif (!dev->attached)\t \n\t\treturn IRQ_NONE;\t \n\n\ts = dev->read_subdev;\n\tcmd = &s->async->cmd;\n\n\t \n\tif (!(inw(dev->iobase + PCI171X_STATUS_REG) & PCI171X_STATUS_IRQ))\n\t\treturn IRQ_NONE;\t \n\n\tif (devpriv->ai_et) {\t \n\t\tdevpriv->ai_et = 0;\n\t\tdevpriv->ctrl &= PCI171X_CTRL_CNT0;\n\t\tdevpriv->ctrl |= PCI171X_CTRL_SW;  \n\t\toutw(devpriv->ctrl, dev->iobase + PCI171X_CTRL_REG);\n\t\tdevpriv->ctrl = devpriv->ctrl_ext;\n\t\toutb(0, dev->iobase + PCI171X_CLRFIFO_REG);\n\t\toutb(0, dev->iobase + PCI171X_CLRINT_REG);\n\t\t \n\t\toutw(devpriv->mux_scan, dev->iobase + PCI171X_MUX_REG);\n\t\toutw(devpriv->ctrl, dev->iobase + PCI171X_CTRL_REG);\n\t\tcomedi_8254_pacer_enable(dev->pacer, 1, 2, true);\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tif (cmd->flags & CMDF_WAKE_EOS)\n\t\tpci1710_handle_every_sample(dev, s);\n\telse\n\t\tpci1710_handle_fifo(dev, s);\n\n\tcomedi_handle_events(dev, s);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int pci1710_ai_cmd(struct comedi_device *dev, struct comedi_subdevice *s)\n{\n\tstruct pci1710_private *devpriv = dev->private;\n\tstruct comedi_cmd *cmd = &s->async->cmd;\n\n\tpci1710_ai_setup_chanlist(dev, s, cmd->chanlist, cmd->chanlist_len,\n\t\t\t\t  devpriv->saved_seglen);\n\n\toutb(0, dev->iobase + PCI171X_CLRFIFO_REG);\n\toutb(0, dev->iobase + PCI171X_CLRINT_REG);\n\n\tdevpriv->ctrl &= PCI171X_CTRL_CNT0;\n\tif ((cmd->flags & CMDF_WAKE_EOS) == 0)\n\t\tdevpriv->ctrl |= PCI171X_CTRL_ONEFH;\n\n\tif (cmd->convert_src == TRIG_TIMER) {\n\t\tcomedi_8254_update_divisors(dev->pacer);\n\n\t\tdevpriv->ctrl |= PCI171X_CTRL_PACER | PCI171X_CTRL_IRQEN;\n\t\tif (cmd->start_src == TRIG_EXT) {\n\t\t\tdevpriv->ctrl_ext = devpriv->ctrl;\n\t\t\tdevpriv->ctrl &= ~(PCI171X_CTRL_PACER |\n\t\t\t\t\t   PCI171X_CTRL_ONEFH |\n\t\t\t\t\t   PCI171X_CTRL_GATE);\n\t\t\tdevpriv->ctrl |= PCI171X_CTRL_EXT;\n\t\t\tdevpriv->ai_et = 1;\n\t\t} else {\t \n\t\t\tdevpriv->ai_et = 0;\n\t\t}\n\t\toutw(devpriv->ctrl, dev->iobase + PCI171X_CTRL_REG);\n\n\t\tif (cmd->start_src == TRIG_NOW)\n\t\t\tcomedi_8254_pacer_enable(dev->pacer, 1, 2, true);\n\t} else {\t \n\t\tdevpriv->ctrl |= PCI171X_CTRL_EXT | PCI171X_CTRL_IRQEN;\n\t\toutw(devpriv->ctrl, dev->iobase + PCI171X_CTRL_REG);\n\t}\n\n\treturn 0;\n}\n\nstatic int pci1710_ai_cmdtest(struct comedi_device *dev,\n\t\t\t      struct comedi_subdevice *s,\n\t\t\t      struct comedi_cmd *cmd)\n{\n\tint err = 0;\n\n\t \n\n\terr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW | TRIG_EXT);\n\terr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_FOLLOW);\n\terr |= comedi_check_trigger_src(&cmd->convert_src,\n\t\t\t\t\tTRIG_TIMER | TRIG_EXT);\n\terr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\n\terr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_COUNT | TRIG_NONE);\n\n\tif (err)\n\t\treturn 1;\n\n\t \n\n\terr |= comedi_check_trigger_is_unique(cmd->start_src);\n\terr |= comedi_check_trigger_is_unique(cmd->convert_src);\n\terr |= comedi_check_trigger_is_unique(cmd->stop_src);\n\n\t \n\n\tif (err)\n\t\treturn 2;\n\n\t \n\n\terr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\n\n\tif (cmd->convert_src == TRIG_TIMER)\n\t\terr |= comedi_check_trigger_arg_min(&cmd->convert_arg, 10000);\n\telse\t \n\t\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);\n\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\n\t\t\t\t\t   cmd->chanlist_len);\n\n\tif (cmd->stop_src == TRIG_COUNT)\n\t\terr |= comedi_check_trigger_arg_min(&cmd->stop_arg, 1);\n\telse\t \n\t\terr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\n\n\tif (err)\n\t\treturn 3;\n\n\t \n\n\tif (cmd->convert_src == TRIG_TIMER) {\n\t\tunsigned int arg = cmd->convert_arg;\n\n\t\tcomedi_8254_cascade_ns_to_timer(dev->pacer, &arg, cmd->flags);\n\t\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, arg);\n\t}\n\n\tif (err)\n\t\treturn 4;\n\n\t \n\n\terr |= pci1710_ai_check_chanlist(dev, s, cmd);\n\n\tif (err)\n\t\treturn 5;\n\n\treturn 0;\n}\n\nstatic int pci1710_ao_insn_write(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tstruct pci1710_private *devpriv = dev->private;\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int range = CR_RANGE(insn->chanspec);\n\tunsigned int val = s->readback[chan];\n\tint i;\n\n\tdevpriv->da_ranges &= ~PCI171X_DAREF_MASK(chan);\n\tdevpriv->da_ranges |= PCI171X_DAREF(chan, range);\n\toutw(devpriv->da_ranges, dev->iobase + PCI171X_DAREF_REG);\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tval = data[i];\n\t\toutw(val, dev->iobase + PCI171X_DA_REG(chan));\n\t}\n\n\ts->readback[chan] = val;\n\n\treturn insn->n;\n}\n\nstatic int pci1710_di_insn_bits(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tdata[1] = inw(dev->iobase + PCI171X_DI_REG);\n\n\treturn insn->n;\n}\n\nstatic int pci1710_do_insn_bits(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tif (comedi_dio_update_state(s, data))\n\t\toutw(s->state, dev->iobase + PCI171X_DO_REG);\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int pci1710_counter_insn_config(struct comedi_device *dev,\n\t\t\t\t       struct comedi_subdevice *s,\n\t\t\t\t       struct comedi_insn *insn,\n\t\t\t\t       unsigned int *data)\n{\n\tstruct pci1710_private *devpriv = dev->private;\n\n\tswitch (data[0]) {\n\tcase INSN_CONFIG_SET_CLOCK_SRC:\n\t\tswitch (data[1]) {\n\t\tcase 0:\t \n\t\t\tdevpriv->ctrl_ext &= ~PCI171X_CTRL_CNT0;\n\t\t\tbreak;\n\t\tcase 1:\t \n\t\t\tdevpriv->ctrl_ext |= PCI171X_CTRL_CNT0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\toutw(devpriv->ctrl_ext, dev->iobase + PCI171X_CTRL_REG);\n\t\tbreak;\n\tcase INSN_CONFIG_GET_CLOCK_SRC:\n\t\tif (devpriv->ctrl_ext & PCI171X_CTRL_CNT0) {\n\t\t\tdata[1] = 1;\n\t\t\tdata[2] = 0;\n\t\t} else {\n\t\t\tdata[1] = 0;\n\t\t\tdata[2] = I8254_OSC_BASE_1MHZ;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn insn->n;\n}\n\nstatic void pci1710_reset(struct comedi_device *dev)\n{\n\tconst struct boardtype *board = dev->board_ptr;\n\n\t \n\toutw(0, dev->iobase + PCI171X_CTRL_REG);\n\n\t \n\toutb(0, dev->iobase + PCI171X_CLRFIFO_REG);\n\toutb(0, dev->iobase + PCI171X_CLRINT_REG);\n\n\tif (board->has_ao) {\n\t\t \n\t\toutb(0, dev->iobase + PCI171X_DAREF_REG);\n\t\toutw(0, dev->iobase + PCI171X_DA_REG(0));\n\t\toutw(0, dev->iobase + PCI171X_DA_REG(1));\n\t}\n\n\t \n\toutw(0, dev->iobase + PCI171X_DO_REG);\n}\n\nstatic int pci1710_auto_attach(struct comedi_device *dev,\n\t\t\t       unsigned long context)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tconst struct boardtype *board = NULL;\n\tstruct pci1710_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tint ret, subdev, n_subdevices;\n\tint i;\n\n\tif (context < ARRAY_SIZE(boardtypes))\n\t\tboard = &boardtypes[context];\n\tif (!board)\n\t\treturn -ENODEV;\n\tdev->board_ptr = board;\n\tdev->board_name = board->name;\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\tdev->iobase = pci_resource_start(pcidev, 2);\n\n\tdev->pacer = comedi_8254_init(dev->iobase + PCI171X_TIMER_BASE,\n\t\t\t\t      I8254_OSC_BASE_10MHZ, I8254_IO16, 0);\n\tif (!dev->pacer)\n\t\treturn -ENOMEM;\n\n\tn_subdevices = 1;\t \n\tif (board->has_ao)\n\t\tn_subdevices++;\n\tif (!board->is_pci1713) {\n\t\t \n\t\tn_subdevices += 3;\n\t}\n\n\tret = comedi_alloc_subdevices(dev, n_subdevices);\n\tif (ret)\n\t\treturn ret;\n\n\tpci1710_reset(dev);\n\n\tif (pcidev->irq) {\n\t\tret = request_irq(pcidev->irq, pci1710_irq_handler,\n\t\t\t\t  IRQF_SHARED, dev->board_name, dev);\n\t\tif (ret == 0)\n\t\t\tdev->irq = pcidev->irq;\n\t}\n\n\tsubdev = 0;\n\n\t \n\ts = &dev->subdevices[subdev++];\n\ts->type\t\t= COMEDI_SUBD_AI;\n\ts->subdev_flags\t= SDF_READABLE | SDF_GROUND;\n\tif (!board->is_pci1711)\n\t\ts->subdev_flags\t|= SDF_DIFF;\n\ts->n_chan\t= board->is_pci1713 ? 32 : 16;\n\ts->maxdata\t= 0x0fff;\n\ts->range_table\t= board->ai_range;\n\ts->insn_read\t= pci1710_ai_insn_read;\n\tif (dev->irq) {\n\t\tdev->read_subdev = s;\n\t\ts->subdev_flags\t|= SDF_CMD_READ;\n\t\ts->len_chanlist\t= s->n_chan;\n\t\ts->do_cmdtest\t= pci1710_ai_cmdtest;\n\t\ts->do_cmd\t= pci1710_ai_cmd;\n\t\ts->cancel\t= pci1710_ai_cancel;\n\t}\n\n\t \n\tfor (i = 0; i < s->range_table->length; i++) {\n\t\tif (comedi_range_is_unipolar(s, i)) {\n\t\t\tdevpriv->unipolar_gain = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (board->has_ao) {\n\t\t \n\t\ts = &dev->subdevices[subdev++];\n\t\ts->type\t\t= COMEDI_SUBD_AO;\n\t\ts->subdev_flags\t= SDF_WRITABLE | SDF_GROUND;\n\t\ts->n_chan\t= 2;\n\t\ts->maxdata\t= 0x0fff;\n\t\ts->range_table\t= &pci171x_ao_range;\n\t\ts->insn_write\t= pci1710_ao_insn_write;\n\n\t\tret = comedi_alloc_subdev_readback(s);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (!board->is_pci1713) {\n\t\t \n\t\ts = &dev->subdevices[subdev++];\n\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\ts->subdev_flags\t= SDF_READABLE;\n\t\ts->n_chan\t= 16;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_bits\t= pci1710_di_insn_bits;\n\n\t\t \n\t\ts = &dev->subdevices[subdev++];\n\t\ts->type\t\t= COMEDI_SUBD_DO;\n\t\ts->subdev_flags\t= SDF_WRITABLE;\n\t\ts->n_chan\t= 16;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_bits\t= pci1710_do_insn_bits;\n\n\t\t \n\t\ts = &dev->subdevices[subdev++];\n\t\tcomedi_8254_subdevice_init(s, dev->pacer);\n\n\t\tdev->pacer->insn_config = pci1710_counter_insn_config;\n\n\t\t \n\t\tcomedi_8254_set_busy(dev->pacer, 1, true);\n\t\tcomedi_8254_set_busy(dev->pacer, 2, true);\n\t}\n\n\t \n\tdevpriv->max_samples = (board->is_pci1711) ? 512 : 2048;\n\n\treturn 0;\n}\n\nstatic struct comedi_driver adv_pci1710_driver = {\n\t.driver_name\t= \"adv_pci1710\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= pci1710_auto_attach,\n\t.detach\t\t= comedi_pci_detach,\n};\n\nstatic int adv_pci1710_pci_probe(struct pci_dev *dev,\n\t\t\t\t const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &adv_pci1710_driver,\n\t\t\t\t      id->driver_data);\n}\n\nstatic const struct pci_device_id adv_pci1710_pci_table[] = {\n\t{\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_PLX, PCI_DEVICE_ID_PLX_9050),\n\t\t.driver_data = BOARD_PCI1710,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0x0000),\n\t\t.driver_data = BOARD_PCI1710,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0xb100),\n\t\t.driver_data = BOARD_PCI1710,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0xb200),\n\t\t.driver_data = BOARD_PCI1710,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0xc100),\n\t\t.driver_data = BOARD_PCI1710,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0xc200),\n\t\t.driver_data = BOARD_PCI1710,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710, 0x1000, 0xd100),\n\t\t.driver_data = BOARD_PCI1710,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0x0002),\n\t\t.driver_data = BOARD_PCI1710HG,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0xb102),\n\t\t.driver_data = BOARD_PCI1710HG,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0xb202),\n\t\t.driver_data = BOARD_PCI1710HG,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0xc102),\n\t\t.driver_data = BOARD_PCI1710HG,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710,\n\t\t\t       PCI_VENDOR_ID_ADVANTECH, 0xc202),\n\t\t.driver_data = BOARD_PCI1710HG,\n\t}, {\n\t\tPCI_DEVICE_SUB(PCI_VENDOR_ID_ADVANTECH, 0x1710, 0x1000, 0xd102),\n\t\t.driver_data = BOARD_PCI1710HG,\n\t},\n\t{ PCI_VDEVICE(ADVANTECH, 0x1711), BOARD_PCI1711 },\n\t{ PCI_VDEVICE(ADVANTECH, 0x1713), BOARD_PCI1713 },\n\t{ PCI_VDEVICE(ADVANTECH, 0x1731), BOARD_PCI1731 },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, adv_pci1710_pci_table);\n\nstatic struct pci_driver adv_pci1710_pci_driver = {\n\t.name\t\t= \"adv_pci1710\",\n\t.id_table\t= adv_pci1710_pci_table,\n\t.probe\t\t= adv_pci1710_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(adv_pci1710_driver, adv_pci1710_pci_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi: Advantech PCI-1710 Series Multifunction DAS Cards\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}