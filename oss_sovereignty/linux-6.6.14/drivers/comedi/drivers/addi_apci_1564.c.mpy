{
  "module_name": "addi_apci_1564.c",
  "hash_id": "2002ce2f7c9043b8bb57ec2632510c57a31d2cf4161b7702c5d569598dcd9efb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/addi_apci_1564.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedi_pci.h>\n\n#include \"addi_tcw.h\"\n#include \"addi_watchdog.h\"\n\n \n#define APCI1564_EEPROM_REG\t\t\t0x00\n#define APCI1564_EEPROM_VCC_STATUS\t\tBIT(8)\n#define APCI1564_EEPROM_TO_REV(x)\t\t(((x) >> 4) & 0xf)\n#define APCI1564_EEPROM_DI\t\t\tBIT(3)\n#define APCI1564_EEPROM_DO\t\t\tBIT(2)\n#define APCI1564_EEPROM_CS\t\t\tBIT(1)\n#define APCI1564_EEPROM_CLK\t\t\tBIT(0)\n#define APCI1564_REV1_TIMER_IOBASE\t\t0x04\n#define APCI1564_REV2_MAIN_IOBASE\t\t0x04\n#define APCI1564_REV2_TIMER_IOBASE\t\t0x48\n\n \n#define APCI1564_REV1_MAIN_IOBASE\t\t0x00\n\n \n#define APCI1564_DI_REG\t\t\t\t0x00\n#define APCI1564_DI_INT_MODE1_REG\t\t0x04\n#define APCI1564_DI_INT_MODE2_REG\t\t0x08\n#define APCI1564_DI_INT_MODE_MASK\t\t0x000ffff0  \n#define APCI1564_DI_INT_STATUS_REG\t\t0x0c\n#define APCI1564_DI_IRQ_REG\t\t\t0x10\n#define APCI1564_DI_IRQ_ENA\t\t\tBIT(2)\n#define APCI1564_DI_IRQ_MODE\t\t\tBIT(1)\t \n#define APCI1564_DO_REG\t\t\t\t0x14\n#define APCI1564_DO_INT_CTRL_REG\t\t0x18\n#define APCI1564_DO_INT_CTRL_CC_INT_ENA\t\tBIT(1)\n#define APCI1564_DO_INT_CTRL_VCC_INT_ENA\tBIT(0)\n#define APCI1564_DO_INT_STATUS_REG\t\t0x1c\n#define APCI1564_DO_INT_STATUS_CC\t\tBIT(1)\n#define APCI1564_DO_INT_STATUS_VCC\t\tBIT(0)\n#define APCI1564_DO_IRQ_REG\t\t\t0x20\n#define APCI1564_DO_IRQ_INTR\t\t\tBIT(0)\n#define APCI1564_WDOG_IOBASE\t\t\t0x24\n\n \n\n \n#define APCI1564_COUNTER(x)\t\t\t((x) * 0x20)\n\n \n#define APCI1564_EVENT_COS\t\t\tBIT(31)\n#define APCI1564_EVENT_TIMER\t\t\tBIT(30)\n#define APCI1564_EVENT_COUNTER(x)\t\tBIT(27 + (x))  \n#define APCI1564_EVENT_MASK\t\t\t0xfff0000f  \n\nstruct apci1564_private {\n\tunsigned long eeprom;\t \n\tunsigned long timer;\t \n\tunsigned long counters;\t \n\tunsigned int mode1;\t \n\tunsigned int mode2;\t \n\tunsigned int ctrl;\t \n};\n\nstatic int apci1564_reset(struct comedi_device *dev)\n{\n\tstruct apci1564_private *devpriv = dev->private;\n\n\t \n\toutl(0x0, dev->iobase + APCI1564_DI_IRQ_REG);\n\tinl(dev->iobase + APCI1564_DI_INT_STATUS_REG);\n\toutl(0x0, dev->iobase + APCI1564_DI_INT_MODE1_REG);\n\toutl(0x0, dev->iobase + APCI1564_DI_INT_MODE2_REG);\n\n\t \n\toutl(0x0, dev->iobase + APCI1564_DO_REG);\n\toutl(0x0, dev->iobase + APCI1564_DO_INT_CTRL_REG);\n\n\t \n\taddi_watchdog_reset(dev->iobase + APCI1564_WDOG_IOBASE);\n\n\t \n\toutl(0x0, devpriv->timer + ADDI_TCW_CTRL_REG);\n\toutl(0x0, devpriv->timer + ADDI_TCW_RELOAD_REG);\n\n\tif (devpriv->counters) {\n\t\tunsigned long iobase = devpriv->counters + ADDI_TCW_CTRL_REG;\n\n\t\t \n\t\toutl(0x0, iobase + APCI1564_COUNTER(0));\n\t\toutl(0x0, iobase + APCI1564_COUNTER(1));\n\t\toutl(0x0, iobase + APCI1564_COUNTER(2));\n\t}\n\n\treturn 0;\n}\n\nstatic irqreturn_t apci1564_interrupt(int irq, void *d)\n{\n\tstruct comedi_device *dev = d;\n\tstruct apci1564_private *devpriv = dev->private;\n\tstruct comedi_subdevice *s = dev->read_subdev;\n\tunsigned int status;\n\tunsigned int ctrl;\n\tunsigned int chan;\n\n\ts->state &= ~APCI1564_EVENT_MASK;\n\n\tstatus = inl(dev->iobase + APCI1564_DI_IRQ_REG);\n\tif (status & APCI1564_DI_IRQ_ENA) {\n\t\t \n\t\ts->state = inl(dev->iobase + APCI1564_DI_INT_STATUS_REG);\n\t\ts->state &= APCI1564_DI_INT_MODE_MASK;\n\t\ts->state |= APCI1564_EVENT_COS;\n\n\t\t \n\t\toutl(status & ~APCI1564_DI_IRQ_ENA,\n\t\t     dev->iobase + APCI1564_DI_IRQ_REG);\n\t\toutl(status, dev->iobase + APCI1564_DI_IRQ_REG);\n\t}\n\n\tstatus = inl(devpriv->timer + ADDI_TCW_IRQ_REG);\n\tif (status & ADDI_TCW_IRQ) {\n\t\ts->state |= APCI1564_EVENT_TIMER;\n\n\t\t \n\t\tctrl = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\n\t\toutl(0x0, devpriv->timer + ADDI_TCW_CTRL_REG);\n\t\toutl(ctrl, devpriv->timer + ADDI_TCW_CTRL_REG);\n\t}\n\n\tif (devpriv->counters) {\n\t\tfor (chan = 0; chan < 3; chan++) {\n\t\t\tunsigned long iobase;\n\n\t\t\tiobase = devpriv->counters + APCI1564_COUNTER(chan);\n\n\t\t\tstatus = inl(iobase + ADDI_TCW_IRQ_REG);\n\t\t\tif (status & ADDI_TCW_IRQ) {\n\t\t\t\ts->state |= APCI1564_EVENT_COUNTER(chan);\n\n\t\t\t\t \n\t\t\t\tctrl = inl(iobase + ADDI_TCW_CTRL_REG);\n\t\t\t\toutl(0x0, iobase + ADDI_TCW_CTRL_REG);\n\t\t\t\toutl(ctrl, iobase + ADDI_TCW_CTRL_REG);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (s->state & APCI1564_EVENT_MASK) {\n\t\tcomedi_buf_write_samples(s, &s->state, 1);\n\t\tcomedi_handle_events(dev, s);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int apci1564_di_insn_bits(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tdata[1] = inl(dev->iobase + APCI1564_DI_REG);\n\n\treturn insn->n;\n}\n\nstatic int apci1564_do_insn_bits(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\ts->state = inl(dev->iobase + APCI1564_DO_REG);\n\n\tif (comedi_dio_update_state(s, data))\n\t\toutl(s->state, dev->iobase + APCI1564_DO_REG);\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int apci1564_diag_insn_bits(struct comedi_device *dev,\n\t\t\t\t   struct comedi_subdevice *s,\n\t\t\t\t   struct comedi_insn *insn,\n\t\t\t\t   unsigned int *data)\n{\n\tdata[1] = inl(dev->iobase + APCI1564_DO_INT_STATUS_REG) & 3;\n\n\treturn insn->n;\n}\n\n \nstatic int apci1564_cos_insn_config(struct comedi_device *dev,\n\t\t\t\t    struct comedi_subdevice *s,\n\t\t\t\t    struct comedi_insn *insn,\n\t\t\t\t    unsigned int *data)\n{\n\tstruct apci1564_private *devpriv = dev->private;\n\tunsigned int shift, oldmask, himask, lomask;\n\n\tswitch (data[0]) {\n\tcase INSN_CONFIG_DIGITAL_TRIG:\n\t\tif (data[1] != 0)\n\t\t\treturn -EINVAL;\n\t\tshift = data[3];\n\t\tif (shift < 32) {\n\t\t\toldmask = (1U << shift) - 1;\n\t\t\thimask = data[4] << shift;\n\t\t\tlomask = data[5] << shift;\n\t\t} else {\n\t\t\toldmask = 0xffffffffu;\n\t\t\thimask = 0;\n\t\t\tlomask = 0;\n\t\t}\n\t\tswitch (data[2]) {\n\t\tcase COMEDI_DIGITAL_TRIG_DISABLE:\n\t\t\tdevpriv->ctrl = 0;\n\t\t\tdevpriv->mode1 = 0;\n\t\t\tdevpriv->mode2 = 0;\n\t\t\toutl(0x0, dev->iobase + APCI1564_DI_IRQ_REG);\n\t\t\tinl(dev->iobase + APCI1564_DI_INT_STATUS_REG);\n\t\t\toutl(0x0, dev->iobase + APCI1564_DI_INT_MODE1_REG);\n\t\t\toutl(0x0, dev->iobase + APCI1564_DI_INT_MODE2_REG);\n\t\t\tbreak;\n\t\tcase COMEDI_DIGITAL_TRIG_ENABLE_EDGES:\n\t\t\tif (devpriv->ctrl != APCI1564_DI_IRQ_ENA) {\n\t\t\t\t \n\t\t\t\tdevpriv->ctrl = APCI1564_DI_IRQ_ENA;\n\t\t\t\t \n\t\t\t\tdevpriv->mode1 = 0;\n\t\t\t\tdevpriv->mode2 = 0;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tdevpriv->mode1 &= oldmask;\n\t\t\t\tdevpriv->mode2 &= oldmask;\n\t\t\t}\n\t\t\t \n\t\t\tdevpriv->mode1 |= himask;\n\t\t\tdevpriv->mode2 |= lomask;\n\t\t\tbreak;\n\t\tcase COMEDI_DIGITAL_TRIG_ENABLE_LEVELS:\n\t\t\tif (devpriv->ctrl != (APCI1564_DI_IRQ_ENA |\n\t\t\t\t\t      APCI1564_DI_IRQ_MODE)) {\n\t\t\t\t \n\t\t\t\tdevpriv->ctrl = APCI1564_DI_IRQ_ENA |\n\t\t\t\t\t\tAPCI1564_DI_IRQ_MODE;\n\t\t\t\t \n\t\t\t\tdevpriv->mode1 = 0;\n\t\t\t\tdevpriv->mode2 = 0;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tdevpriv->mode1 &= oldmask;\n\t\t\t\tdevpriv->mode2 &= oldmask;\n\t\t\t}\n\t\t\t \n\t\t\tdevpriv->mode1 |= himask;\n\t\t\tdevpriv->mode2 |= lomask;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tdevpriv->mode1 &= APCI1564_DI_INT_MODE_MASK;\n\t\tdevpriv->mode2 &= APCI1564_DI_INT_MODE_MASK;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn insn->n;\n}\n\nstatic int apci1564_cos_insn_bits(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s,\n\t\t\t\t  struct comedi_insn *insn,\n\t\t\t\t  unsigned int *data)\n{\n\tdata[1] = s->state;\n\n\treturn 0;\n}\n\nstatic int apci1564_cos_cmdtest(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_cmd *cmd)\n{\n\tint err = 0;\n\n\t \n\n\terr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);\n\terr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\n\terr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_NONE);\n\n\tif (err)\n\t\treturn 1;\n\n\t \n\t \n\n\t \n\n\terr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\n\t\t\t\t\t   cmd->chanlist_len);\n\terr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\n\n\tif (err)\n\t\treturn 3;\n\n\t \n\n\t \n\n\treturn 0;\n}\n\n \nstatic int apci1564_cos_cmd(struct comedi_device *dev,\n\t\t\t    struct comedi_subdevice *s)\n{\n\tstruct apci1564_private *devpriv = dev->private;\n\n\tif (!devpriv->ctrl && !(devpriv->mode1 || devpriv->mode2)) {\n\t\tdev_warn(dev->class_dev,\n\t\t\t \"Interrupts disabled due to mode configuration!\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\toutl(devpriv->mode1, dev->iobase + APCI1564_DI_INT_MODE1_REG);\n\toutl(devpriv->mode2, dev->iobase + APCI1564_DI_INT_MODE2_REG);\n\toutl(devpriv->ctrl, dev->iobase + APCI1564_DI_IRQ_REG);\n\n\treturn 0;\n}\n\nstatic int apci1564_cos_cancel(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s)\n{\n\toutl(0x0, dev->iobase + APCI1564_DI_IRQ_REG);\n\tinl(dev->iobase + APCI1564_DI_INT_STATUS_REG);\n\toutl(0x0, dev->iobase + APCI1564_DI_INT_MODE1_REG);\n\toutl(0x0, dev->iobase + APCI1564_DI_INT_MODE2_REG);\n\n\treturn 0;\n}\n\nstatic int apci1564_timer_insn_config(struct comedi_device *dev,\n\t\t\t\t      struct comedi_subdevice *s,\n\t\t\t\t      struct comedi_insn *insn,\n\t\t\t\t      unsigned int *data)\n{\n\tstruct apci1564_private *devpriv = dev->private;\n\tunsigned int val;\n\n\tswitch (data[0]) {\n\tcase INSN_CONFIG_ARM:\n\t\tif (data[1] > s->maxdata)\n\t\t\treturn -EINVAL;\n\t\toutl(data[1], devpriv->timer + ADDI_TCW_RELOAD_REG);\n\t\toutl(ADDI_TCW_CTRL_IRQ_ENA | ADDI_TCW_CTRL_TIMER_ENA,\n\t\t     devpriv->timer + ADDI_TCW_CTRL_REG);\n\t\tbreak;\n\tcase INSN_CONFIG_DISARM:\n\t\toutl(0x0, devpriv->timer + ADDI_TCW_CTRL_REG);\n\t\tbreak;\n\tcase INSN_CONFIG_GET_COUNTER_STATUS:\n\t\tdata[1] = 0;\n\t\tval = inl(devpriv->timer + ADDI_TCW_CTRL_REG);\n\t\tif (val & ADDI_TCW_CTRL_IRQ_ENA)\n\t\t\tdata[1] |= COMEDI_COUNTER_ARMED;\n\t\tif (val & ADDI_TCW_CTRL_TIMER_ENA)\n\t\t\tdata[1] |= COMEDI_COUNTER_COUNTING;\n\t\tval = inl(devpriv->timer + ADDI_TCW_STATUS_REG);\n\t\tif (val & ADDI_TCW_STATUS_OVERFLOW)\n\t\t\tdata[1] |= COMEDI_COUNTER_TERMINAL_COUNT;\n\t\tdata[2] = COMEDI_COUNTER_ARMED | COMEDI_COUNTER_COUNTING |\n\t\t\t  COMEDI_COUNTER_TERMINAL_COUNT;\n\t\tbreak;\n\tcase INSN_CONFIG_SET_CLOCK_SRC:\n\t\tif (data[2] > s->maxdata)\n\t\t\treturn -EINVAL;\n\t\toutl(data[1], devpriv->timer + ADDI_TCW_TIMEBASE_REG);\n\t\toutl(data[2], devpriv->timer + ADDI_TCW_RELOAD_REG);\n\t\tbreak;\n\tcase INSN_CONFIG_GET_CLOCK_SRC:\n\t\tdata[1] = inl(devpriv->timer + ADDI_TCW_TIMEBASE_REG);\n\t\tdata[2] = inl(devpriv->timer + ADDI_TCW_RELOAD_REG);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int apci1564_timer_insn_write(struct comedi_device *dev,\n\t\t\t\t     struct comedi_subdevice *s,\n\t\t\t\t     struct comedi_insn *insn,\n\t\t\t\t     unsigned int *data)\n{\n\tstruct apci1564_private *devpriv = dev->private;\n\n\t \n\tif (insn->n) {\n\t\tunsigned int val = data[insn->n - 1];\n\n\t\toutl(val, devpriv->timer + ADDI_TCW_RELOAD_REG);\n\t}\n\n\treturn insn->n;\n}\n\nstatic int apci1564_timer_insn_read(struct comedi_device *dev,\n\t\t\t\t    struct comedi_subdevice *s,\n\t\t\t\t    struct comedi_insn *insn,\n\t\t\t\t    unsigned int *data)\n{\n\tstruct apci1564_private *devpriv = dev->private;\n\tint i;\n\n\t \n\tfor (i = 0; i < insn->n; i++)\n\t\tdata[i] = inl(devpriv->timer + ADDI_TCW_VAL_REG);\n\n\treturn insn->n;\n}\n\nstatic int apci1564_counter_insn_config(struct comedi_device *dev,\n\t\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\t\tunsigned int *data)\n{\n\tstruct apci1564_private *devpriv = dev->private;\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\n\tunsigned int val;\n\n\tswitch (data[0]) {\n\tcase INSN_CONFIG_ARM:\n\t\tval = inl(iobase + ADDI_TCW_CTRL_REG);\n\t\tval |= ADDI_TCW_CTRL_IRQ_ENA | ADDI_TCW_CTRL_CNTR_ENA;\n\t\toutl(data[1], iobase + ADDI_TCW_RELOAD_REG);\n\t\toutl(val, iobase + ADDI_TCW_CTRL_REG);\n\t\tbreak;\n\tcase INSN_CONFIG_DISARM:\n\t\tval = inl(iobase + ADDI_TCW_CTRL_REG);\n\t\tval &= ~(ADDI_TCW_CTRL_IRQ_ENA | ADDI_TCW_CTRL_CNTR_ENA);\n\t\toutl(val, iobase + ADDI_TCW_CTRL_REG);\n\t\tbreak;\n\tcase INSN_CONFIG_SET_COUNTER_MODE:\n\t\t \n\t\toutl(data[1], iobase + ADDI_TCW_CTRL_REG);\n\t\tbreak;\n\tcase INSN_CONFIG_GET_COUNTER_STATUS:\n\t\tdata[1] = 0;\n\t\tval = inl(iobase + ADDI_TCW_CTRL_REG);\n\t\tif (val & ADDI_TCW_CTRL_IRQ_ENA)\n\t\t\tdata[1] |= COMEDI_COUNTER_ARMED;\n\t\tif (val & ADDI_TCW_CTRL_CNTR_ENA)\n\t\t\tdata[1] |= COMEDI_COUNTER_COUNTING;\n\t\tval = inl(iobase + ADDI_TCW_STATUS_REG);\n\t\tif (val & ADDI_TCW_STATUS_OVERFLOW)\n\t\t\tdata[1] |= COMEDI_COUNTER_TERMINAL_COUNT;\n\t\tdata[2] = COMEDI_COUNTER_ARMED | COMEDI_COUNTER_COUNTING |\n\t\t\t  COMEDI_COUNTER_TERMINAL_COUNT;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int apci1564_counter_insn_write(struct comedi_device *dev,\n\t\t\t\t       struct comedi_subdevice *s,\n\t\t\t\t       struct comedi_insn *insn,\n\t\t\t\t       unsigned int *data)\n{\n\tstruct apci1564_private *devpriv = dev->private;\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\n\n\t \n\tif (insn->n) {\n\t\tunsigned int val = data[insn->n - 1];\n\n\t\toutl(val, iobase + ADDI_TCW_RELOAD_REG);\n\t}\n\n\treturn insn->n;\n}\n\nstatic int apci1564_counter_insn_read(struct comedi_device *dev,\n\t\t\t\t      struct comedi_subdevice *s,\n\t\t\t\t      struct comedi_insn *insn,\n\t\t\t\t      unsigned int *data)\n{\n\tstruct apci1564_private *devpriv = dev->private;\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned long iobase = devpriv->counters + APCI1564_COUNTER(chan);\n\tint i;\n\n\t \n\tfor (i = 0; i < insn->n; i++)\n\t\tdata[i] = inl(iobase + ADDI_TCW_VAL_REG);\n\n\treturn insn->n;\n}\n\nstatic int apci1564_auto_attach(struct comedi_device *dev,\n\t\t\t\tunsigned long context_unused)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tstruct apci1564_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tunsigned int val;\n\tint ret;\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tdevpriv->eeprom = pci_resource_start(pcidev, 0);\n\tval = inl(devpriv->eeprom + APCI1564_EEPROM_REG);\n\tif (APCI1564_EEPROM_TO_REV(val) == 0) {\n\t\t \n\t\tdev->iobase = pci_resource_start(pcidev, 1) +\n\t\t\t      APCI1564_REV1_MAIN_IOBASE;\n\t\tdevpriv->timer = devpriv->eeprom + APCI1564_REV1_TIMER_IOBASE;\n\t} else {\n\t\t \n\t\tdev->iobase = devpriv->eeprom + APCI1564_REV2_MAIN_IOBASE;\n\t\tdevpriv->timer = devpriv->eeprom + APCI1564_REV2_TIMER_IOBASE;\n\t\tdevpriv->counters = pci_resource_start(pcidev, 1);\n\t}\n\n\tapci1564_reset(dev);\n\n\tif (pcidev->irq > 0) {\n\t\tret = request_irq(pcidev->irq, apci1564_interrupt, IRQF_SHARED,\n\t\t\t\t  dev->board_name, dev);\n\t\tif (ret == 0)\n\t\t\tdev->irq = pcidev->irq;\n\t}\n\n\tret = comedi_alloc_subdevices(dev, 7);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_DI;\n\ts->subdev_flags\t= SDF_READABLE;\n\ts->n_chan\t= 32;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= apci1564_di_insn_bits;\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_DO;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= 32;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= apci1564_do_insn_bits;\n\n\t \n\ts = &dev->subdevices[2];\n\tif (dev->irq) {\n\t\tdev->read_subdev = s;\n\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\ts->subdev_flags\t= SDF_READABLE | SDF_CMD_READ | SDF_LSAMPL;\n\t\ts->n_chan\t= 1;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->len_chanlist\t= 1;\n\t\ts->insn_config\t= apci1564_cos_insn_config;\n\t\ts->insn_bits\t= apci1564_cos_insn_bits;\n\t\ts->do_cmdtest\t= apci1564_cos_cmdtest;\n\t\ts->do_cmd\t= apci1564_cos_cmd;\n\t\ts->cancel\t= apci1564_cos_cancel;\n\t} else {\n\t\ts->type\t\t= COMEDI_SUBD_UNUSED;\n\t}\n\n\t \n\ts = &dev->subdevices[3];\n\ts->type\t\t= COMEDI_SUBD_TIMER;\n\ts->subdev_flags\t= SDF_WRITABLE | SDF_READABLE;\n\ts->n_chan\t= 1;\n\ts->maxdata\t= 0x0fff;\n\ts->range_table\t= &range_digital;\n\ts->insn_config\t= apci1564_timer_insn_config;\n\ts->insn_write\t= apci1564_timer_insn_write;\n\ts->insn_read\t= apci1564_timer_insn_read;\n\n\t \n\ts = &dev->subdevices[4];\n\tif (devpriv->counters) {\n\t\ts->type\t\t= COMEDI_SUBD_COUNTER;\n\t\ts->subdev_flags\t= SDF_WRITABLE | SDF_READABLE | SDF_LSAMPL;\n\t\ts->n_chan\t= 3;\n\t\ts->maxdata\t= 0xffffffff;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_config\t= apci1564_counter_insn_config;\n\t\ts->insn_write\t= apci1564_counter_insn_write;\n\t\ts->insn_read\t= apci1564_counter_insn_read;\n\t} else {\n\t\ts->type\t\t= COMEDI_SUBD_UNUSED;\n\t}\n\n\t \n\ts = &dev->subdevices[5];\n\tret = addi_watchdog_init(s, dev->iobase + APCI1564_WDOG_IOBASE);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[6];\n\ts->type\t\t= COMEDI_SUBD_DI;\n\ts->subdev_flags\t= SDF_READABLE;\n\ts->n_chan\t= 2;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= apci1564_diag_insn_bits;\n\n\treturn 0;\n}\n\nstatic void apci1564_detach(struct comedi_device *dev)\n{\n\tif (dev->iobase)\n\t\tapci1564_reset(dev);\n\tcomedi_pci_detach(dev);\n}\n\nstatic struct comedi_driver apci1564_driver = {\n\t.driver_name\t= \"addi_apci_1564\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= apci1564_auto_attach,\n\t.detach\t\t= apci1564_detach,\n};\n\nstatic int apci1564_pci_probe(struct pci_dev *dev,\n\t\t\t      const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &apci1564_driver, id->driver_data);\n}\n\nstatic const struct pci_device_id apci1564_pci_table[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_ADDIDATA, 0x1006) },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, apci1564_pci_table);\n\nstatic struct pci_driver apci1564_pci_driver = {\n\t.name\t\t= \"addi_apci_1564\",\n\t.id_table\t= apci1564_pci_table,\n\t.probe\t\t= apci1564_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(apci1564_driver, apci1564_pci_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"ADDI-DATA APCI-1564, 32 channel DI / 32 channel DO boards\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}