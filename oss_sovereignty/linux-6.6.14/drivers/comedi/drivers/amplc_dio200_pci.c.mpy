{
  "module_name": "amplc_dio200_pci.c",
  "hash_id": "e5574f1a88766adc71e1e06263f246aa3b78f035358df2dc5eb59694024d380b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/amplc_dio200_pci.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedi_pci.h>\n\n#include \"amplc_dio200.h\"\n\n \n\nenum dio200_pci_model {\n\tpci215_model,\n\tpci272_model,\n\tpcie215_model,\n\tpcie236_model,\n\tpcie296_model\n};\n\nstatic const struct dio200_board dio200_pci_boards[] = {\n\t[pci215_model] = {\n\t\t.name\t\t= \"pci215\",\n\t\t.mainbar\t= 2,\n\t\t.n_subdevs\t= 5,\n\t\t.sdtype\t\t= {\n\t\t\tsd_8255, sd_8255, sd_8254, sd_8254, sd_intr\n\t\t},\n\t\t.sdinfo\t\t= { 0x00, 0x08, 0x10, 0x14, 0x3f },\n\t\t.has_int_sce\t= true,\n\t\t.has_clk_gat_sce = true,\n\t},\n\t[pci272_model] = {\n\t\t.name\t\t= \"pci272\",\n\t\t.mainbar\t= 2,\n\t\t.n_subdevs\t= 4,\n\t\t.sdtype\t\t= {\n\t\t\tsd_8255, sd_8255, sd_8255, sd_intr\n\t\t},\n\t\t.sdinfo\t\t= { 0x00, 0x08, 0x10, 0x3f },\n\t\t.has_int_sce\t= true,\n\t},\n\t[pcie215_model] = {\n\t\t.name\t\t= \"pcie215\",\n\t\t.mainbar\t= 1,\n\t\t.n_subdevs\t= 8,\n\t\t.sdtype\t\t= {\n\t\t\tsd_8255, sd_none, sd_8255, sd_none,\n\t\t\tsd_8254, sd_8254, sd_timer, sd_intr\n\t\t},\n\t\t.sdinfo\t\t= {\n\t\t\t0x00, 0x00, 0x08, 0x00, 0x10, 0x14, 0x00, 0x3f\n\t\t},\n\t\t.has_int_sce\t= true,\n\t\t.has_clk_gat_sce = true,\n\t\t.is_pcie\t= true,\n\t},\n\t[pcie236_model] = {\n\t\t.name\t\t= \"pcie236\",\n\t\t.mainbar\t= 1,\n\t\t.n_subdevs\t= 8,\n\t\t.sdtype\t\t= {\n\t\t\tsd_8255, sd_none, sd_none, sd_none,\n\t\t\tsd_8254, sd_8254, sd_timer, sd_intr\n\t\t},\n\t\t.sdinfo\t\t= {\n\t\t\t0x00, 0x00, 0x00, 0x00, 0x10, 0x14, 0x00, 0x3f\n\t\t},\n\t\t.has_int_sce\t= true,\n\t\t.has_clk_gat_sce = true,\n\t\t.is_pcie\t= true,\n\t},\n\t[pcie296_model] = {\n\t\t.name\t\t= \"pcie296\",\n\t\t.mainbar\t= 1,\n\t\t.n_subdevs\t= 8,\n\t\t.sdtype\t\t= {\n\t\t\tsd_8255, sd_8255, sd_8255, sd_8255,\n\t\t\tsd_8254, sd_8254, sd_timer, sd_intr\n\t\t},\n\t\t.sdinfo\t\t= {\n\t\t\t0x00, 0x04, 0x08, 0x0c, 0x10, 0x14, 0x00, 0x3f\n\t\t},\n\t\t.has_int_sce\t= true,\n\t\t.has_clk_gat_sce = true,\n\t\t.is_pcie\t= true,\n\t},\n};\n\n \nstatic int dio200_pcie_board_setup(struct comedi_device *dev)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tvoid __iomem *brbase;\n\n\t \n\tif (pci_resource_len(pcidev, 0) < 0x4000) {\n\t\tdev_err(dev->class_dev, \"error! bad PCI region!\\n\");\n\t\treturn -EINVAL;\n\t}\n\tbrbase = pci_ioremap_bar(pcidev, 0);\n\tif (!brbase) {\n\t\tdev_err(dev->class_dev, \"error! failed to map registers!\\n\");\n\t\treturn -ENOMEM;\n\t}\n\twritel(0x80, brbase + 0x50);\n\tiounmap(brbase);\n\t \n\tamplc_dio200_set_enhance(dev, 1);\n\treturn 0;\n}\n\nstatic int dio200_pci_auto_attach(struct comedi_device *dev,\n\t\t\t\t  unsigned long context_model)\n{\n\tstruct pci_dev *pci_dev = comedi_to_pci_dev(dev);\n\tconst struct dio200_board *board = NULL;\n\tunsigned int bar;\n\tint ret;\n\n\tif (context_model < ARRAY_SIZE(dio200_pci_boards))\n\t\tboard = &dio200_pci_boards[context_model];\n\tif (!board)\n\t\treturn -EINVAL;\n\tdev->board_ptr = board;\n\tdev->board_name = board->name;\n\n\tdev_info(dev->class_dev, \"%s: attach pci %s (%s)\\n\",\n\t\t dev->driver->driver_name, pci_name(pci_dev), dev->board_name);\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tbar = board->mainbar;\n\tif (pci_resource_flags(pci_dev, bar) & IORESOURCE_MEM) {\n\t\tdev->mmio = pci_ioremap_bar(pci_dev, bar);\n\t\tif (!dev->mmio) {\n\t\t\tdev_err(dev->class_dev,\n\t\t\t\t\"error! cannot remap registers\\n\");\n\t\t\treturn -ENOMEM;\n\t\t}\n\t} else {\n\t\tdev->iobase = pci_resource_start(pci_dev, bar);\n\t}\n\n\tif (board->is_pcie) {\n\t\tret = dio200_pcie_board_setup(dev);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn amplc_dio200_common_attach(dev, pci_dev->irq, IRQF_SHARED);\n}\n\nstatic struct comedi_driver dio200_pci_comedi_driver = {\n\t.driver_name\t= \"amplc_dio200_pci\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= dio200_pci_auto_attach,\n\t.detach\t\t= comedi_pci_detach,\n};\n\nstatic const struct pci_device_id dio200_pci_table[] = {\n\t{ PCI_VDEVICE(AMPLICON, 0x000b), pci215_model },\n\t{ PCI_VDEVICE(AMPLICON, 0x000a), pci272_model },\n\t{ PCI_VDEVICE(AMPLICON, 0x0011), pcie236_model },\n\t{ PCI_VDEVICE(AMPLICON, 0x0012), pcie215_model },\n\t{ PCI_VDEVICE(AMPLICON, 0x0014), pcie296_model },\n\t{0}\n};\n\nMODULE_DEVICE_TABLE(pci, dio200_pci_table);\n\nstatic int dio200_pci_probe(struct pci_dev *dev, const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &dio200_pci_comedi_driver,\n\t\t\t\t      id->driver_data);\n}\n\nstatic struct pci_driver dio200_pci_pci_driver = {\n\t.name\t\t= \"amplc_dio200_pci\",\n\t.id_table\t= dio200_pci_table,\n\t.probe\t\t= dio200_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(dio200_pci_comedi_driver, dio200_pci_pci_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for Amplicon 200 Series PCI(e) DIO boards\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}