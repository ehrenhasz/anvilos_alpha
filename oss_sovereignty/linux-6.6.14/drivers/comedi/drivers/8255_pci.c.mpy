{
  "module_name": "8255_pci.c",
  "hash_id": "24babec9864200b07d7897db43058eb7f1af50a1f18d0276bcf879fcc5d244e1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/8255_pci.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedi_pci.h>\n#include <linux/comedi/comedi_8255.h>\n\nenum pci_8255_boardid {\n\tBOARD_ADLINK_PCI7224,\n\tBOARD_ADLINK_PCI7248,\n\tBOARD_ADLINK_PCI7296,\n\tBOARD_CB_PCIDIO24,\n\tBOARD_CB_PCIDIO24H,\n\tBOARD_CB_PCIDIO48H_OLD,\n\tBOARD_CB_PCIDIO48H_NEW,\n\tBOARD_CB_PCIDIO96H,\n\tBOARD_NI_PCIDIO96,\n\tBOARD_NI_PCIDIO96B,\n\tBOARD_NI_PXI6508,\n\tBOARD_NI_PCI6503,\n\tBOARD_NI_PCI6503B,\n\tBOARD_NI_PCI6503X,\n\tBOARD_NI_PXI_6503,\n};\n\nstruct pci_8255_boardinfo {\n\tconst char *name;\n\tint dio_badr;\n\tint n_8255;\n\tunsigned int has_mite:1;\n};\n\nstatic const struct pci_8255_boardinfo pci_8255_boards[] = {\n\t[BOARD_ADLINK_PCI7224] = {\n\t\t.name\t\t= \"adl_pci-7224\",\n\t\t.dio_badr\t= 2,\n\t\t.n_8255\t\t= 1,\n\t},\n\t[BOARD_ADLINK_PCI7248] = {\n\t\t.name\t\t= \"adl_pci-7248\",\n\t\t.dio_badr\t= 2,\n\t\t.n_8255\t\t= 2,\n\t},\n\t[BOARD_ADLINK_PCI7296] = {\n\t\t.name\t\t= \"adl_pci-7296\",\n\t\t.dio_badr\t= 2,\n\t\t.n_8255\t\t= 4,\n\t},\n\t[BOARD_CB_PCIDIO24] = {\n\t\t.name\t\t= \"cb_pci-dio24\",\n\t\t.dio_badr\t= 2,\n\t\t.n_8255\t\t= 1,\n\t},\n\t[BOARD_CB_PCIDIO24H] = {\n\t\t.name\t\t= \"cb_pci-dio24h\",\n\t\t.dio_badr\t= 2,\n\t\t.n_8255\t\t= 1,\n\t},\n\t[BOARD_CB_PCIDIO48H_OLD] = {\n\t\t.name\t\t= \"cb_pci-dio48h\",\n\t\t.dio_badr\t= 1,\n\t\t.n_8255\t\t= 2,\n\t},\n\t[BOARD_CB_PCIDIO48H_NEW] = {\n\t\t.name\t\t= \"cb_pci-dio48h\",\n\t\t.dio_badr\t= 2,\n\t\t.n_8255\t\t= 2,\n\t},\n\t[BOARD_CB_PCIDIO96H] = {\n\t\t.name\t\t= \"cb_pci-dio96h\",\n\t\t.dio_badr\t= 2,\n\t\t.n_8255\t\t= 4,\n\t},\n\t[BOARD_NI_PCIDIO96] = {\n\t\t.name\t\t= \"ni_pci-dio-96\",\n\t\t.dio_badr\t= 1,\n\t\t.n_8255\t\t= 4,\n\t\t.has_mite\t= 1,\n\t},\n\t[BOARD_NI_PCIDIO96B] = {\n\t\t.name\t\t= \"ni_pci-dio-96b\",\n\t\t.dio_badr\t= 1,\n\t\t.n_8255\t\t= 4,\n\t\t.has_mite\t= 1,\n\t},\n\t[BOARD_NI_PXI6508] = {\n\t\t.name\t\t= \"ni_pxi-6508\",\n\t\t.dio_badr\t= 1,\n\t\t.n_8255\t\t= 4,\n\t\t.has_mite\t= 1,\n\t},\n\t[BOARD_NI_PCI6503] = {\n\t\t.name\t\t= \"ni_pci-6503\",\n\t\t.dio_badr\t= 1,\n\t\t.n_8255\t\t= 1,\n\t\t.has_mite\t= 1,\n\t},\n\t[BOARD_NI_PCI6503B] = {\n\t\t.name\t\t= \"ni_pci-6503b\",\n\t\t.dio_badr\t= 1,\n\t\t.n_8255\t\t= 1,\n\t\t.has_mite\t= 1,\n\t},\n\t[BOARD_NI_PCI6503X] = {\n\t\t.name\t\t= \"ni_pci-6503x\",\n\t\t.dio_badr\t= 1,\n\t\t.n_8255\t\t= 1,\n\t\t.has_mite\t= 1,\n\t},\n\t[BOARD_NI_PXI_6503] = {\n\t\t.name\t\t= \"ni_pxi-6503\",\n\t\t.dio_badr\t= 1,\n\t\t.n_8255\t\t= 1,\n\t\t.has_mite\t= 1,\n\t},\n};\n\n \n#define MITE_IODWBSR\t0xc0\t \n#define WENAB\t\tBIT(7)\t \n\nstatic int pci_8255_mite_init(struct pci_dev *pcidev)\n{\n\tvoid __iomem *mite_base;\n\tu32 main_phys_addr;\n\n\t \n\tmite_base = pci_ioremap_bar(pcidev, 0);\n\tif (!mite_base)\n\t\treturn -ENOMEM;\n\n\t \n\tmain_phys_addr = pci_resource_start(pcidev, 1);\n\twritel(main_phys_addr | WENAB, mite_base + MITE_IODWBSR);\n\n\t \n\tiounmap(mite_base);\n\treturn 0;\n}\n\nstatic int pci_8255_auto_attach(struct comedi_device *dev,\n\t\t\t\tunsigned long context)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tconst struct pci_8255_boardinfo *board = NULL;\n\tstruct comedi_subdevice *s;\n\tint ret;\n\tint i;\n\n\tif (context < ARRAY_SIZE(pci_8255_boards))\n\t\tboard = &pci_8255_boards[context];\n\tif (!board)\n\t\treturn -ENODEV;\n\tdev->board_ptr = board;\n\tdev->board_name = board->name;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tif (board->has_mite) {\n\t\tret = pci_8255_mite_init(pcidev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif ((pci_resource_flags(pcidev, board->dio_badr) & IORESOURCE_MEM)) {\n\t\tdev->mmio = pci_ioremap_bar(pcidev, board->dio_badr);\n\t\tif (!dev->mmio)\n\t\t\treturn -ENOMEM;\n\t} else {\n\t\tdev->iobase = pci_resource_start(pcidev, board->dio_badr);\n\t}\n\n\t \n\tret = comedi_alloc_subdevices(dev, board->n_8255);\n\tif (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < board->n_8255; i++) {\n\t\ts = &dev->subdevices[i];\n\t\tif (dev->mmio)\n\t\t\tret = subdev_8255_mm_init(dev, s, NULL, i * I8255_SIZE);\n\t\telse\n\t\t\tret = subdev_8255_init(dev, s, NULL, i * I8255_SIZE);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic struct comedi_driver pci_8255_driver = {\n\t.driver_name\t= \"8255_pci\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= pci_8255_auto_attach,\n\t.detach\t\t= comedi_pci_detach,\n};\n\nstatic int pci_8255_pci_probe(struct pci_dev *dev,\n\t\t\t      const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &pci_8255_driver, id->driver_data);\n}\n\nstatic const struct pci_device_id pci_8255_pci_table[] = {\n\t{ PCI_VDEVICE(ADLINK, 0x7224), BOARD_ADLINK_PCI7224 },\n\t{ PCI_VDEVICE(ADLINK, 0x7248), BOARD_ADLINK_PCI7248 },\n\t{ PCI_VDEVICE(ADLINK, 0x7296), BOARD_ADLINK_PCI7296 },\n\t{ PCI_VDEVICE(CB, 0x0028), BOARD_CB_PCIDIO24 },\n\t{ PCI_VDEVICE(CB, 0x0014), BOARD_CB_PCIDIO24H },\n\t{ PCI_DEVICE_SUB(PCI_VENDOR_ID_CB, 0x000b, 0x0000, 0x0000),\n\t  .driver_data = BOARD_CB_PCIDIO48H_OLD },\n\t{ PCI_DEVICE_SUB(PCI_VENDOR_ID_CB, 0x000b, PCI_VENDOR_ID_CB, 0x000b),\n\t  .driver_data = BOARD_CB_PCIDIO48H_NEW },\n\t{ PCI_VDEVICE(CB, 0x0017), BOARD_CB_PCIDIO96H },\n\t{ PCI_VDEVICE(NI, 0x0160), BOARD_NI_PCIDIO96 },\n\t{ PCI_VDEVICE(NI, 0x1630), BOARD_NI_PCIDIO96B },\n\t{ PCI_VDEVICE(NI, 0x13c0), BOARD_NI_PXI6508 },\n\t{ PCI_VDEVICE(NI, 0x0400), BOARD_NI_PCI6503 },\n\t{ PCI_VDEVICE(NI, 0x1250), BOARD_NI_PCI6503B },\n\t{ PCI_VDEVICE(NI, 0x17d0), BOARD_NI_PCI6503X },\n\t{ PCI_VDEVICE(NI, 0x1800), BOARD_NI_PXI_6503 },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, pci_8255_pci_table);\n\nstatic struct pci_driver pci_8255_pci_driver = {\n\t.name\t\t= \"8255_pci\",\n\t.id_table\t= pci_8255_pci_table,\n\t.probe\t\t= pci_8255_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(pci_8255_driver, pci_8255_pci_driver);\n\nMODULE_DESCRIPTION(\"COMEDI - Generic PCI based 8255 Digital I/O boards\");\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}