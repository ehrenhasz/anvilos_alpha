{
  "module_name": "addi_apci_1516.c",
  "hash_id": "285509f05cd5550054a03f4eddde905e4f8194477345d1566be5f56c8ed08e69",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/addi_apci_1516.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedi_pci.h>\n\n#include \"addi_watchdog.h\"\n\n \n#define APCI1516_DI_REG\t\t\t0x00\n#define APCI1516_DO_REG\t\t\t0x04\n\n \n#define APCI1516_WDOG_REG\t\t0x00\n\nenum apci1516_boardid {\n\tBOARD_APCI1016,\n\tBOARD_APCI1516,\n\tBOARD_APCI2016,\n};\n\nstruct apci1516_boardinfo {\n\tconst char *name;\n\tint di_nchan;\n\tint do_nchan;\n\tint has_wdog;\n};\n\nstatic const struct apci1516_boardinfo apci1516_boardtypes[] = {\n\t[BOARD_APCI1016] = {\n\t\t.name\t\t= \"apci1016\",\n\t\t.di_nchan\t= 16,\n\t},\n\t[BOARD_APCI1516] = {\n\t\t.name\t\t= \"apci1516\",\n\t\t.di_nchan\t= 8,\n\t\t.do_nchan\t= 8,\n\t\t.has_wdog\t= 1,\n\t},\n\t[BOARD_APCI2016] = {\n\t\t.name\t\t= \"apci2016\",\n\t\t.do_nchan\t= 16,\n\t\t.has_wdog\t= 1,\n\t},\n};\n\nstruct apci1516_private {\n\tunsigned long wdog_iobase;\n};\n\nstatic int apci1516_di_insn_bits(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tdata[1] = inw(dev->iobase + APCI1516_DI_REG);\n\n\treturn insn->n;\n}\n\nstatic int apci1516_do_insn_bits(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\ts->state = inw(dev->iobase + APCI1516_DO_REG);\n\n\tif (comedi_dio_update_state(s, data))\n\t\toutw(s->state, dev->iobase + APCI1516_DO_REG);\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int apci1516_reset(struct comedi_device *dev)\n{\n\tconst struct apci1516_boardinfo *board = dev->board_ptr;\n\tstruct apci1516_private *devpriv = dev->private;\n\n\tif (!board->has_wdog)\n\t\treturn 0;\n\n\toutw(0x0, dev->iobase + APCI1516_DO_REG);\n\n\taddi_watchdog_reset(devpriv->wdog_iobase);\n\n\treturn 0;\n}\n\nstatic int apci1516_auto_attach(struct comedi_device *dev,\n\t\t\t\tunsigned long context)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tconst struct apci1516_boardinfo *board = NULL;\n\tstruct apci1516_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tif (context < ARRAY_SIZE(apci1516_boardtypes))\n\t\tboard = &apci1516_boardtypes[context];\n\tif (!board)\n\t\treturn -ENODEV;\n\tdev->board_ptr = board;\n\tdev->board_name = board->name;\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tdev->iobase = pci_resource_start(pcidev, 1);\n\tdevpriv->wdog_iobase = pci_resource_start(pcidev, 2);\n\n\tret = comedi_alloc_subdevices(dev, 3);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\tif (board->di_nchan) {\n\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\ts->subdev_flags\t= SDF_READABLE;\n\t\ts->n_chan\t= board->di_nchan;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_bits\t= apci1516_di_insn_bits;\n\t} else {\n\t\ts->type\t\t= COMEDI_SUBD_UNUSED;\n\t}\n\n\t \n\ts = &dev->subdevices[1];\n\tif (board->do_nchan) {\n\t\ts->type\t\t= COMEDI_SUBD_DO;\n\t\ts->subdev_flags\t= SDF_WRITABLE;\n\t\ts->n_chan\t= board->do_nchan;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_bits\t= apci1516_do_insn_bits;\n\t} else {\n\t\ts->type\t\t= COMEDI_SUBD_UNUSED;\n\t}\n\n\t \n\ts = &dev->subdevices[2];\n\tif (board->has_wdog) {\n\t\tret = addi_watchdog_init(s, devpriv->wdog_iobase);\n\t\tif (ret)\n\t\t\treturn ret;\n\t} else {\n\t\ts->type\t\t= COMEDI_SUBD_UNUSED;\n\t}\n\n\tapci1516_reset(dev);\n\treturn 0;\n}\n\nstatic void apci1516_detach(struct comedi_device *dev)\n{\n\tif (dev->iobase)\n\t\tapci1516_reset(dev);\n\tcomedi_pci_detach(dev);\n}\n\nstatic struct comedi_driver apci1516_driver = {\n\t.driver_name\t= \"addi_apci_1516\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= apci1516_auto_attach,\n\t.detach\t\t= apci1516_detach,\n};\n\nstatic int apci1516_pci_probe(struct pci_dev *dev,\n\t\t\t      const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &apci1516_driver, id->driver_data);\n}\n\nstatic const struct pci_device_id apci1516_pci_table[] = {\n\t{ PCI_VDEVICE(ADDIDATA, 0x1000), BOARD_APCI1016 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x1001), BOARD_APCI1516 },\n\t{ PCI_VDEVICE(ADDIDATA, 0x1002), BOARD_APCI2016 },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, apci1516_pci_table);\n\nstatic struct pci_driver apci1516_pci_driver = {\n\t.name\t\t= \"addi_apci_1516\",\n\t.id_table\t= apci1516_pci_table,\n\t.probe\t\t= apci1516_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(apci1516_driver, apci1516_pci_driver);\n\nMODULE_DESCRIPTION(\"ADDI-DATA APCI-1016/1516/2016, 16 channel DIO boards\");\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}