{
  "module_name": "comedi_parport.c",
  "hash_id": "5e1bb61fda8039790cfc8a18ffb317085b245fe06e432eaf1a6679d5d6aa84cc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/comedi_parport.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedidev.h>\n\n \n#define PARPORT_DATA_REG\t0x00\n#define PARPORT_STATUS_REG\t0x01\n#define PARPORT_CTRL_REG\t0x02\n#define PARPORT_CTRL_IRQ_ENA\tBIT(4)\n#define PARPORT_CTRL_BIDIR_ENA\tBIT(5)\n\nstatic int parport_data_reg_insn_bits(struct comedi_device *dev,\n\t\t\t\t      struct comedi_subdevice *s,\n\t\t\t\t      struct comedi_insn *insn,\n\t\t\t\t      unsigned int *data)\n{\n\tif (comedi_dio_update_state(s, data))\n\t\toutb(s->state, dev->iobase + PARPORT_DATA_REG);\n\n\tdata[1] = inb(dev->iobase + PARPORT_DATA_REG);\n\n\treturn insn->n;\n}\n\nstatic int parport_data_reg_insn_config(struct comedi_device *dev,\n\t\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\t\tunsigned int *data)\n{\n\tunsigned int ctrl;\n\tint ret;\n\n\tret = comedi_dio_insn_config(dev, s, insn, data, 0xff);\n\tif (ret)\n\t\treturn ret;\n\n\tctrl = inb(dev->iobase + PARPORT_CTRL_REG);\n\tif (s->io_bits)\n\t\tctrl &= ~PARPORT_CTRL_BIDIR_ENA;\n\telse\n\t\tctrl |= PARPORT_CTRL_BIDIR_ENA;\n\toutb(ctrl, dev->iobase + PARPORT_CTRL_REG);\n\n\treturn insn->n;\n}\n\nstatic int parport_status_reg_insn_bits(struct comedi_device *dev,\n\t\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\t\tunsigned int *data)\n{\n\tdata[1] = inb(dev->iobase + PARPORT_STATUS_REG) >> 3;\n\n\treturn insn->n;\n}\n\nstatic int parport_ctrl_reg_insn_bits(struct comedi_device *dev,\n\t\t\t\t      struct comedi_subdevice *s,\n\t\t\t\t      struct comedi_insn *insn,\n\t\t\t\t      unsigned int *data)\n{\n\tunsigned int ctrl;\n\n\tif (comedi_dio_update_state(s, data)) {\n\t\tctrl = inb(dev->iobase + PARPORT_CTRL_REG);\n\t\tctrl &= (PARPORT_CTRL_IRQ_ENA | PARPORT_CTRL_BIDIR_ENA);\n\t\tctrl |= s->state;\n\t\toutb(ctrl, dev->iobase + PARPORT_CTRL_REG);\n\t}\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int parport_intr_insn_bits(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s,\n\t\t\t\t  struct comedi_insn *insn,\n\t\t\t\t  unsigned int *data)\n{\n\tdata[1] = 0;\n\treturn insn->n;\n}\n\nstatic int parport_intr_cmdtest(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_cmd *cmd)\n{\n\tint err = 0;\n\n\t \n\n\terr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);\n\terr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\n\terr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_NONE);\n\n\tif (err)\n\t\treturn 1;\n\n\t \n\t \n\n\t \n\n\terr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\n\t\t\t\t\t   cmd->chanlist_len);\n\terr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\n\n\tif (err)\n\t\treturn 3;\n\n\t \n\n\t \n\n\treturn 0;\n}\n\nstatic int parport_intr_cmd(struct comedi_device *dev,\n\t\t\t    struct comedi_subdevice *s)\n{\n\tunsigned int ctrl;\n\n\tctrl = inb(dev->iobase + PARPORT_CTRL_REG);\n\tctrl |= PARPORT_CTRL_IRQ_ENA;\n\toutb(ctrl, dev->iobase + PARPORT_CTRL_REG);\n\n\treturn 0;\n}\n\nstatic int parport_intr_cancel(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s)\n{\n\tunsigned int ctrl;\n\n\tctrl = inb(dev->iobase + PARPORT_CTRL_REG);\n\tctrl &= ~PARPORT_CTRL_IRQ_ENA;\n\toutb(ctrl, dev->iobase + PARPORT_CTRL_REG);\n\n\treturn 0;\n}\n\nstatic irqreturn_t parport_interrupt(int irq, void *d)\n{\n\tstruct comedi_device *dev = d;\n\tstruct comedi_subdevice *s = dev->read_subdev;\n\tunsigned int ctrl;\n\tunsigned short val = 0;\n\n\tctrl = inb(dev->iobase + PARPORT_CTRL_REG);\n\tif (!(ctrl & PARPORT_CTRL_IRQ_ENA))\n\t\treturn IRQ_NONE;\n\n\tcomedi_buf_write_samples(s, &val, 1);\n\tcomedi_handle_events(dev, s);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int parport_attach(struct comedi_device *dev,\n\t\t\t  struct comedi_devconfig *it)\n{\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_request_region(dev, it->options[0], 0x03);\n\tif (ret)\n\t\treturn ret;\n\n\tif (it->options[1]) {\n\t\tret = request_irq(it->options[1], parport_interrupt, 0,\n\t\t\t\t  dev->board_name, dev);\n\t\tif (ret == 0)\n\t\t\tdev->irq = it->options[1];\n\t}\n\n\tret = comedi_alloc_subdevices(dev, dev->irq ? 4 : 3);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_DIO;\n\ts->subdev_flags\t= SDF_READABLE | SDF_WRITABLE;\n\ts->n_chan\t= 8;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= parport_data_reg_insn_bits;\n\ts->insn_config\t= parport_data_reg_insn_config;\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_DI;\n\ts->subdev_flags\t= SDF_READABLE;\n\ts->n_chan\t= 5;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= parport_status_reg_insn_bits;\n\n\t \n\ts = &dev->subdevices[2];\n\ts->type\t\t= COMEDI_SUBD_DO;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= 4;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= parport_ctrl_reg_insn_bits;\n\n\tif (dev->irq) {\n\t\t \n\t\ts = &dev->subdevices[3];\n\t\tdev->read_subdev = s;\n\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\ts->subdev_flags\t= SDF_READABLE | SDF_CMD_READ;\n\t\ts->n_chan\t= 1;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_bits\t= parport_intr_insn_bits;\n\t\ts->len_chanlist\t= 1;\n\t\ts->do_cmdtest\t= parport_intr_cmdtest;\n\t\ts->do_cmd\t= parport_intr_cmd;\n\t\ts->cancel\t= parport_intr_cancel;\n\t}\n\n\toutb(0, dev->iobase + PARPORT_DATA_REG);\n\toutb(0, dev->iobase + PARPORT_CTRL_REG);\n\n\treturn 0;\n}\n\nstatic struct comedi_driver parport_driver = {\n\t.driver_name\t= \"comedi_parport\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= parport_attach,\n\t.detach\t\t= comedi_legacy_detach,\n};\nmodule_comedi_driver(parport_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi: Standard parallel port driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}