{
  "module_name": "pcl726.c",
  "hash_id": "5e869553bf8f3342f2db383995011ff6be1a5feb69020ec042d11bd68d538bdf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/pcl726.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/comedi/comedidev.h>\n\n#define PCL726_AO_MSB_REG(x)\t(0x00 + ((x) * 2))\n#define PCL726_AO_LSB_REG(x)\t(0x01 + ((x) * 2))\n#define PCL726_DO_MSB_REG\t0x0c\n#define PCL726_DO_LSB_REG\t0x0d\n#define PCL726_DI_MSB_REG\t0x0e\n#define PCL726_DI_LSB_REG\t0x0f\n\n#define PCL727_DI_MSB_REG\t0x00\n#define PCL727_DI_LSB_REG\t0x01\n#define PCL727_DO_MSB_REG\t0x18\n#define PCL727_DO_LSB_REG\t0x19\n\nstatic const struct comedi_lrange *const rangelist_726[] = {\n\t&range_unipolar5,\n\t&range_unipolar10,\n\t&range_bipolar5,\n\t&range_bipolar10,\n\t&range_4_20mA,\n\t&range_unknown\n};\n\nstatic const struct comedi_lrange *const rangelist_727[] = {\n\t&range_unipolar5,\n\t&range_unipolar10,\n\t&range_bipolar5,\n\t&range_4_20mA\n};\n\nstatic const struct comedi_lrange *const rangelist_728[] = {\n\t&range_unipolar5,\n\t&range_unipolar10,\n\t&range_bipolar5,\n\t&range_bipolar10,\n\t&range_4_20mA,\n\t&range_0_20mA\n};\n\nstruct pcl726_board {\n\tconst char *name;\n\tunsigned long io_len;\n\tunsigned int irq_mask;\n\tconst struct comedi_lrange *const *ao_ranges;\n\tint ao_num_ranges;\n\tint ao_nchan;\n\tunsigned int have_dio:1;\n\tunsigned int is_pcl727:1;\n};\n\nstatic const struct pcl726_board pcl726_boards[] = {\n\t{\n\t\t.name\t\t= \"pcl726\",\n\t\t.io_len\t\t= 0x10,\n\t\t.ao_ranges\t= &rangelist_726[0],\n\t\t.ao_num_ranges\t= ARRAY_SIZE(rangelist_726),\n\t\t.ao_nchan\t= 6,\n\t\t.have_dio\t= 1,\n\t}, {\n\t\t.name\t\t= \"pcl727\",\n\t\t.io_len\t\t= 0x20,\n\t\t.ao_ranges\t= &rangelist_727[0],\n\t\t.ao_num_ranges\t= ARRAY_SIZE(rangelist_727),\n\t\t.ao_nchan\t= 12,\n\t\t.have_dio\t= 1,\n\t\t.is_pcl727\t= 1,\n\t}, {\n\t\t.name\t\t= \"pcl728\",\n\t\t.io_len\t\t= 0x08,\n\t\t.ao_num_ranges\t= ARRAY_SIZE(rangelist_728),\n\t\t.ao_ranges\t= &rangelist_728[0],\n\t\t.ao_nchan\t= 2,\n\t}, {\n\t\t.name\t\t= \"acl6126\",\n\t\t.io_len\t\t= 0x10,\n\t\t.irq_mask\t= 0x96e8,\n\t\t.ao_num_ranges\t= ARRAY_SIZE(rangelist_726),\n\t\t.ao_ranges\t= &rangelist_726[0],\n\t\t.ao_nchan\t= 6,\n\t\t.have_dio\t= 1,\n\t}, {\n\t\t.name\t\t= \"acl6128\",\n\t\t.io_len\t\t= 0x08,\n\t\t.ao_num_ranges\t= ARRAY_SIZE(rangelist_728),\n\t\t.ao_ranges\t= &rangelist_728[0],\n\t\t.ao_nchan\t= 2,\n\t},\n};\n\nstruct pcl726_private {\n\tconst struct comedi_lrange *rangelist[12];\n\tunsigned int cmd_running:1;\n};\n\nstatic int pcl726_intr_insn_bits(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tdata[1] = 0;\n\treturn insn->n;\n}\n\nstatic int pcl726_intr_cmdtest(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_cmd *cmd)\n{\n\tint err = 0;\n\n\t \n\n\terr |= comedi_check_trigger_src(&cmd->start_src, TRIG_NOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);\n\terr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\n\terr |= comedi_check_trigger_src(&cmd->stop_src, TRIG_NONE);\n\n\tif (err)\n\t\treturn 1;\n\n\t \n\t \n\n\t \n\n\terr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\n\t\t\t\t\t   cmd->chanlist_len);\n\terr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\n\n\tif (err)\n\t\treturn 3;\n\n\t \n\n\t \n\n\treturn 0;\n}\n\nstatic int pcl726_intr_cmd(struct comedi_device *dev,\n\t\t\t   struct comedi_subdevice *s)\n{\n\tstruct pcl726_private *devpriv = dev->private;\n\n\tdevpriv->cmd_running = 1;\n\n\treturn 0;\n}\n\nstatic int pcl726_intr_cancel(struct comedi_device *dev,\n\t\t\t      struct comedi_subdevice *s)\n{\n\tstruct pcl726_private *devpriv = dev->private;\n\n\tdevpriv->cmd_running = 0;\n\n\treturn 0;\n}\n\nstatic irqreturn_t pcl726_interrupt(int irq, void *d)\n{\n\tstruct comedi_device *dev = d;\n\tstruct comedi_subdevice *s = dev->read_subdev;\n\tstruct pcl726_private *devpriv = dev->private;\n\n\tif (devpriv->cmd_running) {\n\t\tunsigned short val = 0;\n\n\t\tpcl726_intr_cancel(dev, s);\n\n\t\tcomedi_buf_write_samples(s, &val, 1);\n\t\tcomedi_handle_events(dev, s);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int pcl726_ao_insn_write(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int range = CR_RANGE(insn->chanspec);\n\tint i;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tunsigned int val = data[i];\n\n\t\ts->readback[chan] = val;\n\n\t\t \n\t\tif (comedi_chan_range_is_bipolar(s, chan, range))\n\t\t\tval = comedi_offset_munge(s, val);\n\n\t\t \n\t\toutb((val >> 8) & 0xff, dev->iobase + PCL726_AO_MSB_REG(chan));\n\t\toutb(val & 0xff, dev->iobase + PCL726_AO_LSB_REG(chan));\n\t}\n\n\treturn insn->n;\n}\n\nstatic int pcl726_di_insn_bits(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_insn *insn,\n\t\t\t       unsigned int *data)\n{\n\tconst struct pcl726_board *board = dev->board_ptr;\n\tunsigned int val;\n\n\tif (board->is_pcl727) {\n\t\tval = inb(dev->iobase + PCL727_DI_LSB_REG);\n\t\tval |= (inb(dev->iobase + PCL727_DI_MSB_REG) << 8);\n\t} else {\n\t\tval = inb(dev->iobase + PCL726_DI_LSB_REG);\n\t\tval |= (inb(dev->iobase + PCL726_DI_MSB_REG) << 8);\n\t}\n\n\tdata[1] = val;\n\n\treturn insn->n;\n}\n\nstatic int pcl726_do_insn_bits(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_insn *insn,\n\t\t\t       unsigned int *data)\n{\n\tconst struct pcl726_board *board = dev->board_ptr;\n\tunsigned long io = dev->iobase;\n\tunsigned int mask;\n\n\tmask = comedi_dio_update_state(s, data);\n\tif (mask) {\n\t\tif (board->is_pcl727) {\n\t\t\tif (mask & 0x00ff)\n\t\t\t\toutb(s->state & 0xff, io + PCL727_DO_LSB_REG);\n\t\t\tif (mask & 0xff00)\n\t\t\t\toutb((s->state >> 8), io + PCL727_DO_MSB_REG);\n\t\t} else {\n\t\t\tif (mask & 0x00ff)\n\t\t\t\toutb(s->state & 0xff, io + PCL726_DO_LSB_REG);\n\t\t\tif (mask & 0xff00)\n\t\t\t\toutb((s->state >> 8), io + PCL726_DO_MSB_REG);\n\t\t}\n\t}\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int pcl726_attach(struct comedi_device *dev,\n\t\t\t struct comedi_devconfig *it)\n{\n\tconst struct pcl726_board *board = dev->board_ptr;\n\tstruct pcl726_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tint subdev;\n\tint ret;\n\tint i;\n\n\tret = comedi_request_region(dev, it->options[0], board->io_len);\n\tif (ret)\n\t\treturn ret;\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\t \n\tif (it->options[1] && (board->irq_mask & (1 << it->options[1]))) {\n\t\tret = request_irq(it->options[1], pcl726_interrupt, 0,\n\t\t\t\t  dev->board_name, dev);\n\t\tif (ret == 0) {\n\t\t\t \n\t\t\tdev->irq = it->options[1];\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; i < 12; i++) {\n\t\tunsigned int opt = it->options[2 + i];\n\n\t\tif (opt < board->ao_num_ranges && i < board->ao_nchan)\n\t\t\tdevpriv->rangelist[i] = board->ao_ranges[opt];\n\t\telse\n\t\t\tdevpriv->rangelist[i] = &range_unknown;\n\t}\n\n\tsubdev = board->have_dio ? 3 : 1;\n\tif (dev->irq)\n\t\tsubdev++;\n\tret = comedi_alloc_subdevices(dev, subdev);\n\tif (ret)\n\t\treturn ret;\n\n\tsubdev = 0;\n\n\t \n\ts = &dev->subdevices[subdev++];\n\ts->type\t\t= COMEDI_SUBD_AO;\n\ts->subdev_flags\t= SDF_WRITABLE | SDF_GROUND;\n\ts->n_chan\t= board->ao_nchan;\n\ts->maxdata\t= 0x0fff;\n\ts->range_table_list = devpriv->rangelist;\n\ts->insn_write\t= pcl726_ao_insn_write;\n\n\tret = comedi_alloc_subdev_readback(s);\n\tif (ret)\n\t\treturn ret;\n\n\tif (board->have_dio) {\n\t\t \n\t\ts = &dev->subdevices[subdev++];\n\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\ts->subdev_flags\t= SDF_READABLE;\n\t\ts->n_chan\t= 16;\n\t\ts->maxdata\t= 1;\n\t\ts->insn_bits\t= pcl726_di_insn_bits;\n\t\ts->range_table\t= &range_digital;\n\n\t\t \n\t\ts = &dev->subdevices[subdev++];\n\t\ts->type\t\t= COMEDI_SUBD_DO;\n\t\ts->subdev_flags\t= SDF_WRITABLE;\n\t\ts->n_chan\t= 16;\n\t\ts->maxdata\t= 1;\n\t\ts->insn_bits\t= pcl726_do_insn_bits;\n\t\ts->range_table\t= &range_digital;\n\t}\n\n\tif (dev->irq) {\n\t\t \n\t\ts = &dev->subdevices[subdev++];\n\t\tdev->read_subdev = s;\n\t\ts->type\t\t= COMEDI_SUBD_DI;\n\t\ts->subdev_flags\t= SDF_READABLE | SDF_CMD_READ;\n\t\ts->n_chan\t= 1;\n\t\ts->maxdata\t= 1;\n\t\ts->range_table\t= &range_digital;\n\t\ts->insn_bits\t= pcl726_intr_insn_bits;\n\t\ts->len_chanlist\t= 1;\n\t\ts->do_cmdtest\t= pcl726_intr_cmdtest;\n\t\ts->do_cmd\t= pcl726_intr_cmd;\n\t\ts->cancel\t= pcl726_intr_cancel;\n\t}\n\n\treturn 0;\n}\n\nstatic struct comedi_driver pcl726_driver = {\n\t.driver_name\t= \"pcl726\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= pcl726_attach,\n\t.detach\t\t= comedi_legacy_detach,\n\t.board_name\t= &pcl726_boards[0].name,\n\t.num_names\t= ARRAY_SIZE(pcl726_boards),\n\t.offset\t\t= sizeof(struct pcl726_board),\n};\nmodule_comedi_driver(pcl726_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for Advantech PCL-726 & compatibles\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}