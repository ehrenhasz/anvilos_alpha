{
  "module_name": "adv_pci1760.c",
  "hash_id": "af7d52ff8b6e92bd2f0c9440bc346d0e44e0199b693a9a197fbb06b39b8ae902",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/adv_pci1760.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedi_pci.h>\n\n \n#define PCI1760_OMB_REG(x)\t\t(0x0c + (x))\n#define PCI1760_IMB_REG(x)\t\t(0x1c + (x))\n#define PCI1760_INTCSR_REG(x)\t\t(0x38 + (x))\n#define PCI1760_INTCSR1_IRQ_ENA\t\tBIT(5)\n#define PCI1760_INTCSR2_OMB_IRQ\t\tBIT(0)\n#define PCI1760_INTCSR2_IMB_IRQ\t\tBIT(1)\n#define PCI1760_INTCSR2_IRQ_STATUS\tBIT(6)\n#define PCI1760_INTCSR2_IRQ_ASSERTED\tBIT(7)\n\n \n#define PCI1760_CMD_CLR_IMB2\t\t0x00\t \n#define PCI1760_CMD_SET_DO\t\t0x01\t \n#define PCI1760_CMD_GET_DO\t\t0x02\t \n#define PCI1760_CMD_GET_STATUS\t\t0x07\t \n#define PCI1760_CMD_GET_FW_VER\t\t0x0e\t \n#define PCI1760_CMD_GET_HW_VER\t\t0x0f\t \n#define PCI1760_CMD_SET_PWM_HI(x)\t(0x10 + (x) * 2)  \n#define PCI1760_CMD_SET_PWM_LO(x)\t(0x11 + (x) * 2)  \n#define PCI1760_CMD_SET_PWM_CNT(x)\t(0x14 + (x))  \n#define PCI1760_CMD_ENA_PWM\t\t0x1f\t \n#define PCI1760_CMD_ENA_FILT\t\t0x20\t \n#define PCI1760_CMD_ENA_PAT_MATCH\t0x21\t \n#define PCI1760_CMD_SET_PAT_MATCH\t0x22\t \n#define PCI1760_CMD_ENA_RISE_EDGE\t0x23\t \n#define PCI1760_CMD_ENA_FALL_EDGE\t0x24\t \n#define PCI1760_CMD_ENA_CNT\t\t0x28\t \n#define PCI1760_CMD_RST_CNT\t\t0x29\t \n#define PCI1760_CMD_ENA_CNT_OFLOW\t0x2a\t \n#define PCI1760_CMD_ENA_CNT_MATCH\t0x2b\t \n#define PCI1760_CMD_SET_CNT_EDGE\t0x2c\t \n#define PCI1760_CMD_GET_CNT\t\t0x2f\t \n#define PCI1760_CMD_SET_HI_SAMP(x)\t(0x30 + (x))  \n#define PCI1760_CMD_SET_LO_SAMP(x)\t(0x38 + (x))  \n#define PCI1760_CMD_SET_CNT(x)\t\t(0x40 + (x))  \n#define PCI1760_CMD_SET_CNT_MATCH(x)\t(0x48 + (x))  \n#define PCI1760_CMD_GET_INT_FLAGS\t0x60\t \n#define PCI1760_CMD_GET_INT_FLAGS_MATCH\tBIT(0)\n#define PCI1760_CMD_GET_INT_FLAGS_COS\tBIT(1)\n#define PCI1760_CMD_GET_INT_FLAGS_OFLOW\tBIT(2)\n#define PCI1760_CMD_GET_OS\t\t0x61\t \n#define PCI1760_CMD_GET_CNT_STATUS\t0x62\t \n\n#define PCI1760_CMD_TIMEOUT\t\t250\t \n#define PCI1760_CMD_RETRIES\t\t3\t \n\n#define PCI1760_PWM_TIMEBASE\t\t100000\t \n\nstatic int pci1760_send_cmd(struct comedi_device *dev,\n\t\t\t    unsigned char cmd, unsigned short val)\n{\n\tunsigned long timeout;\n\n\t \n\toutb(val & 0xff, dev->iobase + PCI1760_OMB_REG(0));\n\toutb((val >> 8) & 0xff, dev->iobase + PCI1760_OMB_REG(1));\n\toutb(cmd, dev->iobase + PCI1760_OMB_REG(2));\n\toutb(0, dev->iobase + PCI1760_OMB_REG(3));\n\n\t \n\ttimeout = jiffies + usecs_to_jiffies(PCI1760_CMD_TIMEOUT);\n\tdo {\n\t\tif (inb(dev->iobase + PCI1760_IMB_REG(2)) == cmd) {\n\t\t\t \n\t\t\treturn inb(dev->iobase + PCI1760_IMB_REG(0)) |\n\t\t\t       (inb(dev->iobase + PCI1760_IMB_REG(1)) << 8);\n\t\t}\n\t\tcpu_relax();\n\t} while (time_before(jiffies, timeout));\n\n\treturn -EBUSY;\n}\n\nstatic int pci1760_cmd(struct comedi_device *dev,\n\t\t       unsigned char cmd, unsigned short val)\n{\n\tint repeats;\n\tint ret;\n\n\t \n\tif (inb(dev->iobase + PCI1760_IMB_REG(2)) == cmd) {\n\t\tret = pci1760_send_cmd(dev, PCI1760_CMD_CLR_IMB2, 0);\n\t\tif (ret < 0) {\n\t\t\t \n\t\t\tret = pci1760_send_cmd(dev, PCI1760_CMD_CLR_IMB2, 0);\n\t\t\tif (ret < 0)\n\t\t\t\treturn -ETIMEDOUT;\n\t\t}\n\t}\n\n\t \n\tfor (repeats = 0; repeats < PCI1760_CMD_RETRIES; repeats++) {\n\t\tret = pci1760_send_cmd(dev, cmd, val);\n\t\tif (ret >= 0)\n\t\t\treturn ret;\n\t}\n\n\t \n\treturn -ETIMEDOUT;\n}\n\nstatic int pci1760_di_insn_bits(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tdata[1] = inb(dev->iobase + PCI1760_IMB_REG(3));\n\n\treturn insn->n;\n}\n\nstatic int pci1760_do_insn_bits(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tint ret;\n\n\tif (comedi_dio_update_state(s, data)) {\n\t\tret = pci1760_cmd(dev, PCI1760_CMD_SET_DO, s->state);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tdata[1] = s->state;\n\n\treturn insn->n;\n}\n\nstatic int pci1760_pwm_ns_to_div(unsigned int flags, unsigned int ns)\n{\n\tunsigned int divisor;\n\n\tswitch (flags) {\n\tcase CMDF_ROUND_NEAREST:\n\t\tdivisor = DIV_ROUND_CLOSEST(ns, PCI1760_PWM_TIMEBASE);\n\t\tbreak;\n\tcase CMDF_ROUND_UP:\n\t\tdivisor = DIV_ROUND_UP(ns, PCI1760_PWM_TIMEBASE);\n\t\tbreak;\n\tcase CMDF_ROUND_DOWN:\n\t\tdivisor = ns / PCI1760_PWM_TIMEBASE;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (divisor < 1)\n\t\tdivisor = 1;\n\tif (divisor > 0xffff)\n\t\tdivisor = 0xffff;\n\n\treturn divisor;\n}\n\nstatic int pci1760_pwm_enable(struct comedi_device *dev,\n\t\t\t      unsigned int chan, bool enable)\n{\n\tint ret;\n\n\tret = pci1760_cmd(dev, PCI1760_CMD_GET_STATUS, PCI1760_CMD_ENA_PWM);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (enable)\n\t\tret |= BIT(chan);\n\telse\n\t\tret &= ~BIT(chan);\n\n\treturn pci1760_cmd(dev, PCI1760_CMD_ENA_PWM, ret);\n}\n\nstatic int pci1760_pwm_insn_config(struct comedi_device *dev,\n\t\t\t\t   struct comedi_subdevice *s,\n\t\t\t\t   struct comedi_insn *insn,\n\t\t\t\t   unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tint hi_div;\n\tint lo_div;\n\tint ret;\n\n\tswitch (data[0]) {\n\tcase INSN_CONFIG_ARM:\n\t\tret = pci1760_pwm_enable(dev, chan, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tif (data[1] > 0xffff)\n\t\t\treturn -EINVAL;\n\t\tret = pci1760_cmd(dev, PCI1760_CMD_SET_PWM_CNT(chan), data[1]);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tret = pci1760_pwm_enable(dev, chan, true);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase INSN_CONFIG_DISARM:\n\t\tret = pci1760_pwm_enable(dev, chan, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase INSN_CONFIG_PWM_OUTPUT:\n\t\tret = pci1760_pwm_enable(dev, chan, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\thi_div = pci1760_pwm_ns_to_div(data[1], data[2]);\n\t\tlo_div = pci1760_pwm_ns_to_div(data[3], data[4]);\n\t\tif (hi_div < 0 || lo_div < 0)\n\t\t\treturn -EINVAL;\n\t\tif ((hi_div * PCI1760_PWM_TIMEBASE) != data[2] ||\n\t\t    (lo_div * PCI1760_PWM_TIMEBASE) != data[4]) {\n\t\t\tdata[2] = hi_div * PCI1760_PWM_TIMEBASE;\n\t\t\tdata[4] = lo_div * PCI1760_PWM_TIMEBASE;\n\t\t\treturn -EAGAIN;\n\t\t}\n\t\tret = pci1760_cmd(dev, PCI1760_CMD_SET_PWM_HI(chan), hi_div);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tret = pci1760_cmd(dev, PCI1760_CMD_SET_PWM_LO(chan), lo_div);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase INSN_CONFIG_GET_PWM_OUTPUT:\n\t\thi_div = pci1760_cmd(dev, PCI1760_CMD_GET_STATUS,\n\t\t\t\t     PCI1760_CMD_SET_PWM_HI(chan));\n\t\tlo_div = pci1760_cmd(dev, PCI1760_CMD_GET_STATUS,\n\t\t\t\t     PCI1760_CMD_SET_PWM_LO(chan));\n\t\tif (hi_div < 0 || lo_div < 0)\n\t\t\treturn -ETIMEDOUT;\n\n\t\tdata[1] = hi_div * PCI1760_PWM_TIMEBASE;\n\t\tdata[2] = lo_div * PCI1760_PWM_TIMEBASE;\n\t\tbreak;\n\tcase INSN_CONFIG_GET_PWM_STATUS:\n\t\tret = pci1760_cmd(dev, PCI1760_CMD_GET_STATUS,\n\t\t\t\t  PCI1760_CMD_ENA_PWM);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tdata[1] = (ret & BIT(chan)) ? 1 : 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn insn->n;\n}\n\nstatic void pci1760_reset(struct comedi_device *dev)\n{\n\tint i;\n\n\t \n\toutb(0, dev->iobase + PCI1760_INTCSR_REG(0));\n\toutb(0, dev->iobase + PCI1760_INTCSR_REG(1));\n\toutb(0, dev->iobase + PCI1760_INTCSR_REG(3));\n\n\t \n\tpci1760_cmd(dev, PCI1760_CMD_ENA_CNT, 0);\n\n\t \n\tpci1760_cmd(dev, PCI1760_CMD_ENA_CNT_OFLOW, 0);\n\n\t \n\tpci1760_cmd(dev, PCI1760_CMD_ENA_CNT_MATCH, 0);\n\n\t \n\tfor (i = 0; i < 8; i++) {\n\t\tpci1760_cmd(dev, PCI1760_CMD_SET_CNT_MATCH(i), 0x8000);\n\t\tpci1760_cmd(dev, PCI1760_CMD_SET_CNT(i), 0x0000);\n\t}\n\n\t \n\tpci1760_cmd(dev, PCI1760_CMD_RST_CNT, 0xff);\n\n\t \n\tpci1760_cmd(dev, PCI1760_CMD_SET_CNT_EDGE, 0);\n\n\t \n\tpci1760_cmd(dev, PCI1760_CMD_ENA_FILT, 0);\n\n\t \n\tpci1760_cmd(dev, PCI1760_CMD_ENA_PAT_MATCH, 0);\n\n\t \n\tpci1760_cmd(dev, PCI1760_CMD_SET_PAT_MATCH, 0);\n}\n\nstatic int pci1760_auto_attach(struct comedi_device *dev,\n\t\t\t       unsigned long context)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\tdev->iobase = pci_resource_start(pcidev, 0);\n\n\tpci1760_reset(dev);\n\n\tret = comedi_alloc_subdevices(dev, 4);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_DI;\n\ts->subdev_flags\t= SDF_READABLE;\n\ts->n_chan\t= 8;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= pci1760_di_insn_bits;\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_DO;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= 8;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= pci1760_do_insn_bits;\n\n\t \n\tret = pci1760_cmd(dev, PCI1760_CMD_GET_DO, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\ts->state\t= ret;\n\n\t \n\ts = &dev->subdevices[2];\n\ts->type\t\t= COMEDI_SUBD_PWM;\n\ts->subdev_flags\t= SDF_PWM_COUNTER;\n\ts->n_chan\t= 2;\n\ts->insn_config\t= pci1760_pwm_insn_config;\n\n\t \n\ts = &dev->subdevices[3];\n\ts->type\t\t= COMEDI_SUBD_UNUSED;\n\n\treturn 0;\n}\n\nstatic struct comedi_driver pci1760_driver = {\n\t.driver_name\t= \"adv_pci1760\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= pci1760_auto_attach,\n\t.detach\t\t= comedi_pci_detach,\n};\n\nstatic int pci1760_pci_probe(struct pci_dev *dev,\n\t\t\t     const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &pci1760_driver, id->driver_data);\n}\n\nstatic const struct pci_device_id pci1760_pci_table[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_ADVANTECH, 0x1760) },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, pci1760_pci_table);\n\nstatic struct pci_driver pci1760_pci_driver = {\n\t.name\t\t= \"adv_pci1760\",\n\t.id_table\t= pci1760_pci_table,\n\t.probe\t\t= pci1760_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(pci1760_driver, pci1760_pci_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for Advantech PCI-1760\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}