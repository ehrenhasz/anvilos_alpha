{
  "module_name": "adv_pci1723.c",
  "hash_id": "88124314f219e3d938af83efd57677aa5c017f7fb208d761c2106f8c9e7bb215",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/adv_pci1723.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedi_pci.h>\n\n \n#define PCI1723_AO_REG(x)\t\t(0x00 + ((x) * 2))\n#define PCI1723_BOARD_ID_REG\t\t0x10\n#define PCI1723_BOARD_ID_MASK\t\t(0xf << 0)\n#define PCI1723_SYNC_CTRL_REG\t\t0x12\n#define PCI1723_SYNC_CTRL(x)\t\t(((x) & 0x1) << 0)\n#define PCI1723_SYNC_CTRL_ASYNC\t\tPCI1723_SYNC_CTRL(0)\n#define PCI1723_SYNC_CTRL_SYNC\t\tPCI1723_SYNC_CTRL(1)\n#define PCI1723_CTRL_REG\t\t0x14\n#define PCI1723_CTRL_BUSY\t\tBIT(15)\n#define PCI1723_CTRL_INIT\t\tBIT(14)\n#define PCI1723_CTRL_SELF\t\tBIT(8)\n#define PCI1723_CTRL_IDX(x)\t\t(((x) & 0x3) << 6)\n#define PCI1723_CTRL_RANGE(x)\t\t(((x) & 0x3) << 4)\n#define PCI1723_CTRL_SEL(x)\t\t(((x) & 0x1) << 3)\n#define PCI1723_CTRL_GAIN\t\tPCI1723_CTRL_SEL(0)\n#define PCI1723_CTRL_OFFSET\t\tPCI1723_CTRL_SEL(1)\n#define PCI1723_CTRL_CHAN(x)\t\t(((x) & 0x7) << 0)\n#define PCI1723_CALIB_CTRL_REG\t\t0x16\n#define PCI1723_CALIB_CTRL_CS\t\tBIT(2)\n#define PCI1723_CALIB_CTRL_DAT\t\tBIT(1)\n#define PCI1723_CALIB_CTRL_CLK\t\tBIT(0)\n#define PCI1723_CALIB_STROBE_REG\t0x18\n#define PCI1723_DIO_CTRL_REG\t\t0x1a\n#define PCI1723_DIO_CTRL_HDIO\t\tBIT(1)\n#define PCI1723_DIO_CTRL_LDIO\t\tBIT(0)\n#define PCI1723_DIO_DATA_REG\t\t0x1c\n#define PCI1723_CALIB_DATA_REG\t\t0x1e\n#define PCI1723_SYNC_STROBE_REG\t\t0x20\n#define PCI1723_RESET_AO_STROBE_REG\t0x22\n#define PCI1723_RESET_CALIB_STROBE_REG\t0x24\n#define PCI1723_RANGE_STROBE_REG\t0x26\n#define PCI1723_VREF_REG\t\t0x28\n#define PCI1723_VREF(x)\t\t\t(((x) & 0x3) << 0)\n#define PCI1723_VREF_NEG10V\t\tPCI1723_VREF(0)\n#define PCI1723_VREF_0V\t\t\tPCI1723_VREF(1)\n#define PCI1723_VREF_POS10V\t\tPCI1723_VREF(3)\n\nstatic int pci1723_ao_insn_write(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tint i;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tunsigned int val = data[i];\n\n\t\toutw(val, dev->iobase + PCI1723_AO_REG(chan));\n\t\ts->readback[chan] = val;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int pci1723_dio_insn_config(struct comedi_device *dev,\n\t\t\t\t   struct comedi_subdevice *s,\n\t\t\t\t   struct comedi_insn *insn,\n\t\t\t\t   unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int mask = (chan < 8) ? 0x00ff : 0xff00;\n\tunsigned short mode = 0x0000;\t\t \n\tint ret;\n\n\tret = comedi_dio_insn_config(dev, s, insn, data, mask);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!(s->io_bits & 0x00ff))\n\t\tmode |= PCI1723_DIO_CTRL_LDIO;\t \n\tif (!(s->io_bits & 0xff00))\n\t\tmode |= PCI1723_DIO_CTRL_HDIO;\t \n\toutw(mode, dev->iobase + PCI1723_DIO_CTRL_REG);\n\n\treturn insn->n;\n}\n\nstatic int pci1723_dio_insn_bits(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tif (comedi_dio_update_state(s, data))\n\t\toutw(s->state, dev->iobase + PCI1723_DIO_DATA_REG);\n\n\tdata[1] = inw(dev->iobase + PCI1723_DIO_DATA_REG);\n\n\treturn insn->n;\n}\n\nstatic int pci1723_auto_attach(struct comedi_device *dev,\n\t\t\t       unsigned long context_unused)\n{\n\tstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\n\tstruct comedi_subdevice *s;\n\tunsigned int val;\n\tint ret;\n\tint i;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\tdev->iobase = pci_resource_start(pcidev, 2);\n\n\tret = comedi_alloc_subdevices(dev, 2);\n\tif (ret)\n\t\treturn ret;\n\n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_AO;\n\ts->subdev_flags\t= SDF_WRITABLE | SDF_GROUND | SDF_COMMON;\n\ts->n_chan\t= 8;\n\ts->maxdata\t= 0xffff;\n\ts->range_table\t= &range_bipolar10;\n\ts->insn_write\t= pci1723_ao_insn_write;\n\n\tret = comedi_alloc_subdev_readback(s);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\toutw(PCI1723_SYNC_CTRL_SYNC, dev->iobase + PCI1723_SYNC_CTRL_REG);\n\tfor (i = 0; i < s->n_chan; i++) {\n\t\toutw(PCI1723_CTRL_RANGE(0) | PCI1723_CTRL_CHAN(i),\n\t\t     PCI1723_CTRL_REG);\n\t\toutw(0, dev->iobase + PCI1723_RANGE_STROBE_REG);\n\n\t\toutw(0x8000, dev->iobase + PCI1723_AO_REG(i));\n\t\ts->readback[i] = 0x8000;\n\t}\n\toutw(0, dev->iobase + PCI1723_SYNC_STROBE_REG);\n\n\t \n\toutw(PCI1723_SYNC_CTRL_ASYNC, dev->iobase + PCI1723_SYNC_CTRL_REG);\n\n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_DIO;\n\ts->subdev_flags\t= SDF_READABLE | SDF_WRITABLE;\n\ts->n_chan\t= 16;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_config\t= pci1723_dio_insn_config;\n\ts->insn_bits\t= pci1723_dio_insn_bits;\n\n\t \n\tval = inw(dev->iobase + PCI1723_DIO_CTRL_REG);\n\tif (!(val & PCI1723_DIO_CTRL_LDIO))\n\t\ts->io_bits |= 0x00ff;\t \n\tif (!(val & PCI1723_DIO_CTRL_HDIO))\n\t\ts->io_bits |= 0xff00;\t \n\ts->state = inw(dev->iobase + PCI1723_DIO_DATA_REG);\n\n\treturn 0;\n}\n\nstatic struct comedi_driver adv_pci1723_driver = {\n\t.driver_name\t= \"adv_pci1723\",\n\t.module\t\t= THIS_MODULE,\n\t.auto_attach\t= pci1723_auto_attach,\n\t.detach\t\t= comedi_pci_detach,\n};\n\nstatic int adv_pci1723_pci_probe(struct pci_dev *dev,\n\t\t\t\t const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &adv_pci1723_driver,\n\t\t\t\t      id->driver_data);\n}\n\nstatic const struct pci_device_id adv_pci1723_pci_table[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_ADVANTECH, 0x1723) },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, adv_pci1723_pci_table);\n\nstatic struct pci_driver adv_pci1723_pci_driver = {\n\t.name\t\t= \"adv_pci1723\",\n\t.id_table\t= adv_pci1723_pci_table,\n\t.probe\t\t= adv_pci1723_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(adv_pci1723_driver, adv_pci1723_pci_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Advantech PCI-1723 Comedi driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}