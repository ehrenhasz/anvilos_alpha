{
  "module_name": "aio_aio12_8.c",
  "hash_id": "47d34868a1ee9661a646dc029d48d46f29e5aa8ceff22514398ce7012a9c1148",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/aio_aio12_8.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedidev.h>\n#include <linux/comedi/comedi_8255.h>\n#include <linux/comedi/comedi_8254.h>\n\n \n#define AIO12_8_STATUS_REG\t\t0x00\n#define AIO12_8_STATUS_ADC_EOC\t\tBIT(7)\n#define AIO12_8_STATUS_PORT_C_COS\tBIT(6)\n#define AIO12_8_STATUS_IRQ_ENA\t\tBIT(2)\n#define AIO12_8_INTERRUPT_REG\t\t0x01\n#define AIO12_8_INTERRUPT_ADC\t\tBIT(7)\n#define AIO12_8_INTERRUPT_COS\t\tBIT(6)\n#define AIO12_8_INTERRUPT_COUNTER1\tBIT(5)\n#define AIO12_8_INTERRUPT_PORT_C3\tBIT(4)\n#define AIO12_8_INTERRUPT_PORT_C0\tBIT(3)\n#define AIO12_8_INTERRUPT_ENA\t\tBIT(2)\n#define AIO12_8_ADC_REG\t\t\t0x02\n#define AIO12_8_ADC_MODE(x)\t\t(((x) & 0x3) << 6)\n#define AIO12_8_ADC_MODE_NORMAL\t\tAIO12_8_ADC_MODE(0)\n#define AIO12_8_ADC_MODE_INT_CLK\tAIO12_8_ADC_MODE(1)\n#define AIO12_8_ADC_MODE_STANDBY\tAIO12_8_ADC_MODE(2)\n#define AIO12_8_ADC_MODE_POWERDOWN\tAIO12_8_ADC_MODE(3)\n#define AIO12_8_ADC_ACQ(x)\t\t(((x) & 0x1) << 5)\n#define AIO12_8_ADC_ACQ_3USEC\t\tAIO12_8_ADC_ACQ(0)\n#define AIO12_8_ADC_ACQ_PROGRAM\t\tAIO12_8_ADC_ACQ(1)\n#define AIO12_8_ADC_RANGE(x)\t\t((x) << 3)\n#define AIO12_8_ADC_CHAN(x)\t\t((x) << 0)\n#define AIO12_8_DAC_REG(x)\t\t(0x04 + (x) * 2)\n#define AIO12_8_8254_BASE_REG\t\t0x0c\n#define AIO12_8_8255_BASE_REG\t\t0x10\n#define AIO12_8_DIO_CONTROL_REG\t\t0x14\n#define AIO12_8_DIO_CONTROL_TST\t\tBIT(0)\n#define AIO12_8_ADC_TRIGGER_REG\t\t0x15\n#define AIO12_8_ADC_TRIGGER_RANGE(x)\t((x) << 3)\n#define AIO12_8_ADC_TRIGGER_CHAN(x)\t((x) << 0)\n#define AIO12_8_TRIGGER_REG\t\t0x16\n#define AIO12_8_TRIGGER_ADTRIG\t\tBIT(1)\n#define AIO12_8_TRIGGER_DACTRIG\t\tBIT(0)\n#define AIO12_8_COS_REG\t\t\t0x17\n#define AIO12_8_DAC_ENABLE_REG\t\t0x18\n#define AIO12_8_DAC_ENABLE_REF_ENA\tBIT(0)\n\nstatic const struct comedi_lrange aio_aio12_8_range = {\n\t4, {\n\t\tUNI_RANGE(5),\n\t\tBIP_RANGE(5),\n\t\tUNI_RANGE(10),\n\t\tBIP_RANGE(10)\n\t}\n};\n\nstruct aio12_8_boardtype {\n\tconst char *name;\n\tunsigned int has_ai:1;\n\tunsigned int has_ao:1;\n};\n\nstatic const struct aio12_8_boardtype board_types[] = {\n\t{\n\t\t.name\t\t= \"aio_aio12_8\",\n\t\t.has_ai\t\t= 1,\n\t\t.has_ao\t\t= 1,\n\t}, {\n\t\t.name\t\t= \"aio_ai12_8\",\n\t\t.has_ai\t\t= 1,\n\t}, {\n\t\t.name\t\t= \"aio_ao12_4\",\n\t\t.has_ao\t\t= 1,\n\t},\n};\n\nstatic int aio_aio12_8_ai_eoc(struct comedi_device *dev,\n\t\t\t      struct comedi_subdevice *s,\n\t\t\t      struct comedi_insn *insn,\n\t\t\t      unsigned long context)\n{\n\tunsigned int status;\n\n\tstatus = inb(dev->iobase + AIO12_8_STATUS_REG);\n\tif (status & AIO12_8_STATUS_ADC_EOC)\n\t\treturn 0;\n\treturn -EBUSY;\n}\n\nstatic int aio_aio12_8_ai_read(struct comedi_device *dev,\n\t\t\t       struct comedi_subdevice *s,\n\t\t\t       struct comedi_insn *insn,\n\t\t\t       unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int range = CR_RANGE(insn->chanspec);\n\tunsigned int val;\n\tunsigned char control;\n\tint ret;\n\tint i;\n\n\t \n\tcontrol = AIO12_8_ADC_MODE_NORMAL | AIO12_8_ADC_ACQ_3USEC |\n\t\t  AIO12_8_ADC_RANGE(range) | AIO12_8_ADC_CHAN(chan);\n\n\t \n\tinb(dev->iobase + AIO12_8_STATUS_REG);\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\t \n\t\toutb(control, dev->iobase + AIO12_8_ADC_REG);\n\n\t\t \n\t\tret = comedi_timeout(dev, s, insn, aio_aio12_8_ai_eoc, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tval = inw(dev->iobase + AIO12_8_ADC_REG) & s->maxdata;\n\n\t\t \n\t\tif (comedi_range_is_bipolar(s, range))\n\t\t\tval = comedi_offset_munge(s, val);\n\n\t\tdata[i] = val;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int aio_aio12_8_ao_insn_write(struct comedi_device *dev,\n\t\t\t\t     struct comedi_subdevice *s,\n\t\t\t\t     struct comedi_insn *insn,\n\t\t\t\t     unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int val = s->readback[chan];\n\tint i;\n\n\t \n\toutb(AIO12_8_DAC_ENABLE_REF_ENA, dev->iobase + AIO12_8_DAC_ENABLE_REG);\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tval = data[i];\n\t\toutw(val, dev->iobase + AIO12_8_DAC_REG(chan));\n\t}\n\ts->readback[chan] = val;\n\n\treturn insn->n;\n}\n\nstatic int aio_aio12_8_counter_insn_config(struct comedi_device *dev,\n\t\t\t\t\t   struct comedi_subdevice *s,\n\t\t\t\t\t   struct comedi_insn *insn,\n\t\t\t\t\t   unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\n\tswitch (data[0]) {\n\tcase INSN_CONFIG_GET_CLOCK_SRC:\n\t\t \n\t\tdata[0] = 0;\n\t\tdata[1] = (chan == 1) ? I8254_OSC_BASE_1MHZ : 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn insn->n;\n}\n\nstatic int aio_aio12_8_attach(struct comedi_device *dev,\n\t\t\t      struct comedi_devconfig *it)\n{\n\tconst struct aio12_8_boardtype *board = dev->board_ptr;\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_request_region(dev, it->options[0], 32);\n\tif (ret)\n\t\treturn ret;\n\n\tdev->pacer = comedi_8254_init(dev->iobase + AIO12_8_8254_BASE_REG,\n\t\t\t\t      0, I8254_IO8, 0);\n\tif (!dev->pacer)\n\t\treturn -ENOMEM;\n\n\tret = comedi_alloc_subdevices(dev, 4);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\tif (board->has_ai) {\n\t\ts->type\t\t= COMEDI_SUBD_AI;\n\t\ts->subdev_flags\t= SDF_READABLE | SDF_GROUND | SDF_DIFF;\n\t\ts->n_chan\t= 8;\n\t\ts->maxdata\t= 0x0fff;\n\t\ts->range_table\t= &aio_aio12_8_range;\n\t\ts->insn_read\t= aio_aio12_8_ai_read;\n\t} else {\n\t\ts->type = COMEDI_SUBD_UNUSED;\n\t}\n\n\t \n\ts = &dev->subdevices[1];\n\tif (board->has_ao) {\n\t\ts->type\t\t= COMEDI_SUBD_AO;\n\t\ts->subdev_flags\t= SDF_WRITABLE | SDF_GROUND;\n\t\ts->n_chan\t= 4;\n\t\ts->maxdata\t= 0x0fff;\n\t\ts->range_table\t= &aio_aio12_8_range;\n\t\ts->insn_write\t= aio_aio12_8_ao_insn_write;\n\n\t\tret = comedi_alloc_subdev_readback(s);\n\t\tif (ret)\n\t\t\treturn ret;\n\t} else {\n\t\ts->type = COMEDI_SUBD_UNUSED;\n\t}\n\n\t \n\ts = &dev->subdevices[2];\n\tret = subdev_8255_init(dev, s, NULL, AIO12_8_8255_BASE_REG);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[3];\n\tcomedi_8254_subdevice_init(s, dev->pacer);\n\n\tdev->pacer->insn_config = aio_aio12_8_counter_insn_config;\n\n\treturn 0;\n}\n\nstatic struct comedi_driver aio_aio12_8_driver = {\n\t.driver_name\t= \"aio_aio12_8\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= aio_aio12_8_attach,\n\t.detach\t\t= comedi_legacy_detach,\n\t.board_name\t= &board_types[0].name,\n\t.num_names\t= ARRAY_SIZE(board_types),\n\t.offset\t\t= sizeof(struct aio12_8_boardtype),\n};\nmodule_comedi_driver(aio_aio12_8_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for Access I/O AIO12-8 Analog I/O Board\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}