{
  "module_name": "amplc_pci224.c",
  "hash_id": "f9133c541449a328c63cd96face22d3efc522ad39caf12e79a4fe9de26b955dd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/amplc_pci224.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/slab.h>\n#include <linux/comedi/comedi_pci.h>\n#include <linux/comedi/comedi_8254.h>\n\n \n#define PCI224_Z2_BASE\t0x14\t \n#define PCI224_ZCLK_SCE\t0x1A\t \n#define PCI224_ZGAT_SCE\t0x1D\t \n#define PCI224_INT_SCE\t0x1E\t \n\t\t\t\t \n\n \n#define PCI224_DACDATA\t0x00\t \n#define PCI224_SOFTTRIG\t0x00\t \n#define PCI224_DACCON\t0x02\t \n#define PCI224_FIFOSIZ\t0x04\t \n#define PCI224_DACCEN\t0x06\t \n\n \n \n#define PCI224_DACCON_TRIG(x)\t\t(((x) & 0x7) << 0)\n#define PCI224_DACCON_TRIG_MASK\t\tPCI224_DACCON_TRIG(7)\n#define PCI224_DACCON_TRIG_NONE\t\tPCI224_DACCON_TRIG(0)\t \n#define PCI224_DACCON_TRIG_SW\t\tPCI224_DACCON_TRIG(1)\t \n#define PCI224_DACCON_TRIG_EXTP\t\tPCI224_DACCON_TRIG(2)\t \n#define PCI224_DACCON_TRIG_EXTN\t\tPCI224_DACCON_TRIG(3)\t \n#define PCI224_DACCON_TRIG_Z2CT0\tPCI224_DACCON_TRIG(4)\t \n#define PCI224_DACCON_TRIG_Z2CT1\tPCI224_DACCON_TRIG(5)\t \n#define PCI224_DACCON_TRIG_Z2CT2\tPCI224_DACCON_TRIG(6)\t \n \n#define PCI224_DACCON_POLAR(x)\t\t(((x) & 0x1) << 3)\n#define PCI224_DACCON_POLAR_MASK\tPCI224_DACCON_POLAR(1)\n#define PCI224_DACCON_POLAR_UNI\t\tPCI224_DACCON_POLAR(0)\t \n#define PCI224_DACCON_POLAR_BI\t\tPCI224_DACCON_POLAR(1)\t \n \n#define PCI224_DACCON_VREF(x)\t\t(((x) & 0x3) << 4)\n#define PCI224_DACCON_VREF_MASK\t\tPCI224_DACCON_VREF(3)\n#define PCI224_DACCON_VREF_1_25\t\tPCI224_DACCON_VREF(0)\t \n#define PCI224_DACCON_VREF_2_5\t\tPCI224_DACCON_VREF(1)\t \n#define PCI224_DACCON_VREF_5\t\tPCI224_DACCON_VREF(2)\t \n#define PCI224_DACCON_VREF_10\t\tPCI224_DACCON_VREF(3)\t \n \n#define PCI224_DACCON_FIFOWRAP\t\tBIT(7)\n \n#define PCI224_DACCON_FIFOENAB\t\tBIT(8)\n \n#define PCI224_DACCON_FIFOINTR(x)\t(((x) & 0x7) << 9)\n#define PCI224_DACCON_FIFOINTR_MASK\tPCI224_DACCON_FIFOINTR(7)\n#define PCI224_DACCON_FIFOINTR_EMPTY\tPCI224_DACCON_FIFOINTR(0)  \n#define PCI224_DACCON_FIFOINTR_NEMPTY\tPCI224_DACCON_FIFOINTR(1)  \n#define PCI224_DACCON_FIFOINTR_NHALF\tPCI224_DACCON_FIFOINTR(2)  \n#define PCI224_DACCON_FIFOINTR_HALF\tPCI224_DACCON_FIFOINTR(3)  \n#define PCI224_DACCON_FIFOINTR_NFULL\tPCI224_DACCON_FIFOINTR(4)  \n#define PCI224_DACCON_FIFOINTR_FULL\tPCI224_DACCON_FIFOINTR(5)  \n \n#define PCI224_DACCON_FIFOFL(x)\t\t(((x) & 0x7) << 12)\n#define PCI224_DACCON_FIFOFL_MASK\tPCI224_DACCON_FIFOFL(7)\n#define PCI224_DACCON_FIFOFL_EMPTY\tPCI224_DACCON_FIFOFL(1)\t \n#define PCI224_DACCON_FIFOFL_ONETOHALF\tPCI224_DACCON_FIFOFL(0)\t \n#define PCI224_DACCON_FIFOFL_HALFTOFULL\tPCI224_DACCON_FIFOFL(4)\t \n#define PCI224_DACCON_FIFOFL_FULL\tPCI224_DACCON_FIFOFL(6)\t \n \n#define PCI224_DACCON_BUSY\t\tBIT(15)\n \n#define PCI224_DACCON_FIFORESET\t\tBIT(12)\n \n#define PCI224_DACCON_GLOBALRESET\tBIT(13)\n\n \n#define PCI224_FIFO_SIZE\t4096\n\n \n#define PCI224_FIFO_ROOM_EMPTY\t\tPCI224_FIFO_SIZE\n#define PCI224_FIFO_ROOM_ONETOHALF\t(PCI224_FIFO_SIZE / 2)\n#define PCI224_FIFO_ROOM_HALFTOFULL\t1\n#define PCI224_FIFO_ROOM_FULL\t\t0\n\n \n#define CLK_CLK\t\t0\t \n#define CLK_10MHZ\t1\t \n#define CLK_1MHZ\t2\t \n#define CLK_100KHZ\t3\t \n#define CLK_10KHZ\t4\t \n#define CLK_1KHZ\t5\t \n#define CLK_OUTNM1\t6\t \n#define CLK_EXT\t\t7\t \n\nstatic unsigned int pci224_clk_config(unsigned int chan, unsigned int src)\n{\n\treturn ((chan & 3) << 3) | (src & 7);\n}\n\n \n#define GAT_VCC\t\t0\t \n#define GAT_GND\t\t1\t \n#define GAT_EXT\t\t2\t \n#define GAT_NOUTNM2\t3\t \n\nstatic unsigned int pci224_gat_config(unsigned int chan, unsigned int src)\n{\n\treturn ((chan & 3) << 3) | (src & 7);\n}\n\n \n\n \n#define PCI224_INTR_EXT\t\t0x01\t \n#define PCI224_INTR_DAC\t\t0x04\t \n#define PCI224_INTR_Z2CT1\t0x20\t \n\n#define PCI224_INTR_EDGE_BITS\t(PCI224_INTR_EXT | PCI224_INTR_Z2CT1)\n#define PCI224_INTR_LEVEL_BITS\tPCI224_INTR_DACFIFO\n\n \n\n \n#define COMBINE(old, new, mask)\t(((old) & ~(mask)) | ((new) & (mask)))\n\n \n#define THISCPU\t\tsmp_processor_id()\n\n \n#define AO_CMD_STARTED\t0\n\n \n\n \nstatic const struct comedi_lrange range_pci224 = {\n\t10, {\n\t\t \n\t\tBIP_RANGE(10),\n\t\tBIP_RANGE(5),\n\t\tBIP_RANGE(2.5),\n\t\tBIP_RANGE(1.25),\n\t\tUNI_RANGE(10),\n\t\tUNI_RANGE(5),\n\t\tUNI_RANGE(2.5),\n\t\tUNI_RANGE(1.25),\n\t\t \n\t\tRANGE_ext(-1, 1),\t \n\t\tRANGE_ext(0, 1),\t \n\t}\n};\n\nstatic const unsigned short hwrange_pci224[10] = {\n\t \n\tPCI224_DACCON_POLAR_BI | PCI224_DACCON_VREF_10,\n\tPCI224_DACCON_POLAR_BI | PCI224_DACCON_VREF_5,\n\tPCI224_DACCON_POLAR_BI | PCI224_DACCON_VREF_2_5,\n\tPCI224_DACCON_POLAR_BI | PCI224_DACCON_VREF_1_25,\n\tPCI224_DACCON_POLAR_UNI | PCI224_DACCON_VREF_10,\n\tPCI224_DACCON_POLAR_UNI | PCI224_DACCON_VREF_5,\n\tPCI224_DACCON_POLAR_UNI | PCI224_DACCON_VREF_2_5,\n\tPCI224_DACCON_POLAR_UNI | PCI224_DACCON_VREF_1_25,\n\t \n\tPCI224_DACCON_POLAR_BI,\n\tPCI224_DACCON_POLAR_UNI,\n};\n\n \nstatic const unsigned char range_check_pci224[10] = {\n\t0, 1, 2, 3, 4, 5, 6, 7, 8, 9,\n};\n\n \nstatic const struct comedi_lrange range_pci234 = {\n\t4, {\n\t\t \n\t\tBIP_RANGE(10),\n\t\t \n\t\tBIP_RANGE(5),\n\t\t \n\t\tRANGE_ext(-2, 2),\t \n\t\t \n\t\tRANGE_ext(-1, 1),\t \n\t}\n};\n\n \nstatic const unsigned short hwrange_pci234[4] = {\n\tPCI224_DACCON_POLAR_BI,\n\tPCI224_DACCON_POLAR_BI,\n\tPCI224_DACCON_POLAR_BI,\n\tPCI224_DACCON_POLAR_BI,\n};\n\n \nstatic const unsigned char range_check_pci234[4] = {\n\t0, 0, 1, 1,\n};\n\n \n\nenum pci224_model { pci224_model, pci234_model };\n\nstruct pci224_board {\n\tconst char *name;\n\tunsigned int ao_chans;\n\tunsigned int ao_bits;\n\tconst struct comedi_lrange *ao_range;\n\tconst unsigned short *ao_hwrange;\n\tconst unsigned char *ao_range_check;\n};\n\nstatic const struct pci224_board pci224_boards[] = {\n\t[pci224_model] = {\n\t\t.name\t\t= \"pci224\",\n\t\t.ao_chans\t= 16,\n\t\t.ao_bits\t= 12,\n\t\t.ao_range\t= &range_pci224,\n\t\t.ao_hwrange\t= &hwrange_pci224[0],\n\t\t.ao_range_check\t= &range_check_pci224[0],\n\t},\n\t[pci234_model] = {\n\t\t.name\t\t= \"pci234\",\n\t\t.ao_chans\t= 4,\n\t\t.ao_bits\t= 16,\n\t\t.ao_range\t= &range_pci234,\n\t\t.ao_hwrange\t= &hwrange_pci234[0],\n\t\t.ao_range_check\t= &range_check_pci234[0],\n\t},\n};\n\nstruct pci224_private {\n\tunsigned long iobase1;\n\tunsigned long state;\n\tspinlock_t ao_spinlock;\t \n\tunsigned short *ao_scan_vals;\n\tunsigned char *ao_scan_order;\n\tint intr_cpuid;\n\tshort intr_running;\n\tunsigned short daccon;\n\tunsigned short ao_enab;\t \n\tunsigned char intsce;\n};\n\n \nstatic void\npci224_ao_set_data(struct comedi_device *dev, int chan, int range,\n\t\t   unsigned int data)\n{\n\tconst struct pci224_board *board = dev->board_ptr;\n\tstruct pci224_private *devpriv = dev->private;\n\tunsigned short mangled;\n\n\t \n\toutw(1 << chan, dev->iobase + PCI224_DACCEN);\n\t \n\tdevpriv->daccon = COMBINE(devpriv->daccon, board->ao_hwrange[range],\n\t\t\t\t  PCI224_DACCON_POLAR_MASK |\n\t\t\t\t  PCI224_DACCON_VREF_MASK);\n\toutw(devpriv->daccon | PCI224_DACCON_FIFORESET,\n\t     dev->iobase + PCI224_DACCON);\n\t \n\tmangled = (unsigned short)data << (16 - board->ao_bits);\n\tif ((devpriv->daccon & PCI224_DACCON_POLAR_MASK) ==\n\t    PCI224_DACCON_POLAR_BI) {\n\t\tmangled ^= 0x8000;\n\t}\n\t \n\toutw(mangled, dev->iobase + PCI224_DACDATA);\n\t \n\tinw(dev->iobase + PCI224_SOFTTRIG);\n}\n\nstatic int pci224_ao_insn_write(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int range = CR_RANGE(insn->chanspec);\n\tunsigned int val = s->readback[chan];\n\tint i;\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tval = data[i];\n\t\tpci224_ao_set_data(dev, chan, range, val);\n\t}\n\ts->readback[chan] = val;\n\n\treturn insn->n;\n}\n\n \nstatic void pci224_ao_stop(struct comedi_device *dev,\n\t\t\t   struct comedi_subdevice *s)\n{\n\tstruct pci224_private *devpriv = dev->private;\n\tunsigned long flags;\n\n\tif (!test_and_clear_bit(AO_CMD_STARTED, &devpriv->state))\n\t\treturn;\n\n\tspin_lock_irqsave(&devpriv->ao_spinlock, flags);\n\t \n\tdevpriv->intsce = 0;\n\toutb(0, devpriv->iobase1 + PCI224_INT_SCE);\n\t \n\twhile (devpriv->intr_running && devpriv->intr_cpuid != THISCPU) {\n\t\tspin_unlock_irqrestore(&devpriv->ao_spinlock, flags);\n\t\tspin_lock_irqsave(&devpriv->ao_spinlock, flags);\n\t}\n\tspin_unlock_irqrestore(&devpriv->ao_spinlock, flags);\n\t \n\toutw(0, dev->iobase + PCI224_DACCEN);\t \n\tdevpriv->daccon =\n\t     COMBINE(devpriv->daccon,\n\t\t     PCI224_DACCON_TRIG_SW | PCI224_DACCON_FIFOINTR_EMPTY,\n\t\t     PCI224_DACCON_TRIG_MASK | PCI224_DACCON_FIFOINTR_MASK);\n\toutw(devpriv->daccon | PCI224_DACCON_FIFORESET,\n\t     dev->iobase + PCI224_DACCON);\n}\n\n \nstatic void pci224_ao_start(struct comedi_device *dev,\n\t\t\t    struct comedi_subdevice *s)\n{\n\tstruct pci224_private *devpriv = dev->private;\n\tstruct comedi_cmd *cmd = &s->async->cmd;\n\tunsigned long flags;\n\n\tset_bit(AO_CMD_STARTED, &devpriv->state);\n\n\t \n\tspin_lock_irqsave(&devpriv->ao_spinlock, flags);\n\tif (cmd->stop_src == TRIG_EXT)\n\t\tdevpriv->intsce = PCI224_INTR_EXT | PCI224_INTR_DAC;\n\telse\n\t\tdevpriv->intsce = PCI224_INTR_DAC;\n\n\toutb(devpriv->intsce, devpriv->iobase1 + PCI224_INT_SCE);\n\tspin_unlock_irqrestore(&devpriv->ao_spinlock, flags);\n}\n\n \nstatic void pci224_ao_handle_fifo(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s)\n{\n\tstruct pci224_private *devpriv = dev->private;\n\tstruct comedi_cmd *cmd = &s->async->cmd;\n\tunsigned int num_scans = comedi_nscans_left(s, 0);\n\tunsigned int room;\n\tunsigned short dacstat;\n\tunsigned int i, n;\n\n\t \n\tdacstat = inw(dev->iobase + PCI224_DACCON);\n\tswitch (dacstat & PCI224_DACCON_FIFOFL_MASK) {\n\tcase PCI224_DACCON_FIFOFL_EMPTY:\n\t\troom = PCI224_FIFO_ROOM_EMPTY;\n\t\tif (cmd->stop_src == TRIG_COUNT &&\n\t\t    s->async->scans_done >= cmd->stop_arg) {\n\t\t\t \n\t\t\ts->async->events |= COMEDI_CB_EOA;\n\t\t\tcomedi_handle_events(dev, s);\n\t\t\treturn;\n\t\t}\n\t\tbreak;\n\tcase PCI224_DACCON_FIFOFL_ONETOHALF:\n\t\troom = PCI224_FIFO_ROOM_ONETOHALF;\n\t\tbreak;\n\tcase PCI224_DACCON_FIFOFL_HALFTOFULL:\n\t\troom = PCI224_FIFO_ROOM_HALFTOFULL;\n\t\tbreak;\n\tdefault:\n\t\troom = PCI224_FIFO_ROOM_FULL;\n\t\tbreak;\n\t}\n\tif (room >= PCI224_FIFO_ROOM_ONETOHALF) {\n\t\t \n\t\tif (num_scans == 0) {\n\t\t\t \n\t\t\tdev_err(dev->class_dev, \"AO buffer underrun\\n\");\n\t\t\ts->async->events |= COMEDI_CB_OVERFLOW;\n\t\t}\n\t}\n\t \n\troom /= cmd->chanlist_len;\n\n\t \n\tif (num_scans > room)\n\t\tnum_scans = room;\n\n\t \n\tfor (n = 0; n < num_scans; n++) {\n\t\tcomedi_buf_read_samples(s, &devpriv->ao_scan_vals[0],\n\t\t\t\t\tcmd->chanlist_len);\n\t\tfor (i = 0; i < cmd->chanlist_len; i++) {\n\t\t\toutw(devpriv->ao_scan_vals[devpriv->ao_scan_order[i]],\n\t\t\t     dev->iobase + PCI224_DACDATA);\n\t\t}\n\t}\n\tif (cmd->stop_src == TRIG_COUNT &&\n\t    s->async->scans_done >= cmd->stop_arg) {\n\t\t \n\t\tdevpriv->daccon = COMBINE(devpriv->daccon,\n\t\t\t\t\t  PCI224_DACCON_FIFOINTR_EMPTY,\n\t\t\t\t\t  PCI224_DACCON_FIFOINTR_MASK);\n\t\toutw(devpriv->daccon, dev->iobase + PCI224_DACCON);\n\t}\n\tif ((devpriv->daccon & PCI224_DACCON_TRIG_MASK) ==\n\t    PCI224_DACCON_TRIG_NONE) {\n\t\tunsigned short trig;\n\n\t\t \n\t\tif (cmd->scan_begin_src == TRIG_TIMER) {\n\t\t\ttrig = PCI224_DACCON_TRIG_Z2CT0;\n\t\t} else {\n\t\t\t \n\t\t\tif (cmd->scan_begin_arg & CR_INVERT)\n\t\t\t\ttrig = PCI224_DACCON_TRIG_EXTN;\n\t\t\telse\n\t\t\t\ttrig = PCI224_DACCON_TRIG_EXTP;\n\t\t}\n\t\tdevpriv->daccon =\n\t\t    COMBINE(devpriv->daccon, trig, PCI224_DACCON_TRIG_MASK);\n\t\toutw(devpriv->daccon, dev->iobase + PCI224_DACCON);\n\t}\n\n\tcomedi_handle_events(dev, s);\n}\n\nstatic int pci224_ao_inttrig_start(struct comedi_device *dev,\n\t\t\t\t   struct comedi_subdevice *s,\n\t\t\t\t   unsigned int trig_num)\n{\n\tstruct comedi_cmd *cmd = &s->async->cmd;\n\n\tif (trig_num != cmd->start_arg)\n\t\treturn -EINVAL;\n\n\ts->async->inttrig = NULL;\n\tpci224_ao_start(dev, s);\n\n\treturn 1;\n}\n\nstatic int pci224_ao_check_chanlist(struct comedi_device *dev,\n\t\t\t\t    struct comedi_subdevice *s,\n\t\t\t\t    struct comedi_cmd *cmd)\n{\n\tconst struct pci224_board *board = dev->board_ptr;\n\tunsigned int range_check_0;\n\tunsigned int chan_mask = 0;\n\tint i;\n\n\trange_check_0 = board->ao_range_check[CR_RANGE(cmd->chanlist[0])];\n\tfor (i = 0; i < cmd->chanlist_len; i++) {\n\t\tunsigned int chan = CR_CHAN(cmd->chanlist[i]);\n\n\t\tif (chan_mask & (1 << chan)) {\n\t\t\tdev_dbg(dev->class_dev,\n\t\t\t\t\"%s: entries in chanlist must contain no duplicate channels\\n\",\n\t\t\t\t__func__);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tchan_mask |= 1 << chan;\n\n\t\tif (board->ao_range_check[CR_RANGE(cmd->chanlist[i])] !=\n\t\t    range_check_0) {\n\t\t\tdev_dbg(dev->class_dev,\n\t\t\t\t\"%s: entries in chanlist have incompatible ranges\\n\",\n\t\t\t\t__func__);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n#define MAX_SCAN_PERIOD\t\t0xFFFFFFFFU\n#define MIN_SCAN_PERIOD\t\t2500\n#define CONVERT_PERIOD\t\t625\n\n \nstatic int\npci224_ao_cmdtest(struct comedi_device *dev, struct comedi_subdevice *s,\n\t\t  struct comedi_cmd *cmd)\n{\n\tint err = 0;\n\tunsigned int arg;\n\n\t \n\n\terr |= comedi_check_trigger_src(&cmd->start_src, TRIG_INT | TRIG_EXT);\n\terr |= comedi_check_trigger_src(&cmd->scan_begin_src,\n\t\t\t\t\tTRIG_EXT | TRIG_TIMER);\n\terr |= comedi_check_trigger_src(&cmd->convert_src, TRIG_NOW);\n\terr |= comedi_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\n\terr |= comedi_check_trigger_src(&cmd->stop_src,\n\t\t\t\t\tTRIG_COUNT | TRIG_EXT | TRIG_NONE);\n\n\tif (err)\n\t\treturn 1;\n\n\t \n\n\terr |= comedi_check_trigger_is_unique(cmd->start_src);\n\terr |= comedi_check_trigger_is_unique(cmd->scan_begin_src);\n\terr |= comedi_check_trigger_is_unique(cmd->stop_src);\n\n\t \n\n\t \n\targ = 0;\n\tif (cmd->start_src & TRIG_EXT)\n\t\targ++;\n\tif (cmd->scan_begin_src & TRIG_EXT)\n\t\targ++;\n\tif (cmd->stop_src & TRIG_EXT)\n\t\targ++;\n\tif (arg > 1)\n\t\terr |= -EINVAL;\n\n\tif (err)\n\t\treturn 2;\n\n\t \n\n\tswitch (cmd->start_src) {\n\tcase TRIG_INT:\n\t\terr |= comedi_check_trigger_arg_is(&cmd->start_arg, 0);\n\t\tbreak;\n\tcase TRIG_EXT:\n\t\t \n\t\tif (cmd->start_arg & ~CR_FLAGS_MASK) {\n\t\t\tcmd->start_arg =\n\t\t\t    COMBINE(cmd->start_arg, 0, ~CR_FLAGS_MASK);\n\t\t\terr |= -EINVAL;\n\t\t}\n\t\t \n\t\tif (cmd->start_arg & CR_FLAGS_MASK & ~CR_EDGE) {\n\t\t\tcmd->start_arg = COMBINE(cmd->start_arg, 0,\n\t\t\t\t\t\t CR_FLAGS_MASK & ~CR_EDGE);\n\t\t\terr |= -EINVAL;\n\t\t}\n\t\tbreak;\n\t}\n\n\tswitch (cmd->scan_begin_src) {\n\tcase TRIG_TIMER:\n\t\terr |= comedi_check_trigger_arg_max(&cmd->scan_begin_arg,\n\t\t\t\t\t\t    MAX_SCAN_PERIOD);\n\n\t\targ = cmd->chanlist_len * CONVERT_PERIOD;\n\t\tif (arg < MIN_SCAN_PERIOD)\n\t\t\targ = MIN_SCAN_PERIOD;\n\t\terr |= comedi_check_trigger_arg_min(&cmd->scan_begin_arg, arg);\n\t\tbreak;\n\tcase TRIG_EXT:\n\t\t \n\t\tif (cmd->scan_begin_arg & ~CR_FLAGS_MASK) {\n\t\t\tcmd->scan_begin_arg =\n\t\t\t    COMBINE(cmd->scan_begin_arg, 0, ~CR_FLAGS_MASK);\n\t\t\terr |= -EINVAL;\n\t\t}\n\t\t \n\t\tif (cmd->scan_begin_arg & CR_FLAGS_MASK &\n\t\t    ~(CR_EDGE | CR_INVERT)) {\n\t\t\tcmd->scan_begin_arg =\n\t\t\t    COMBINE(cmd->scan_begin_arg, 0,\n\t\t\t\t    CR_FLAGS_MASK & ~(CR_EDGE | CR_INVERT));\n\t\t\terr |= -EINVAL;\n\t\t}\n\t\tbreak;\n\t}\n\n\terr |= comedi_check_trigger_arg_is(&cmd->convert_arg, 0);\n\terr |= comedi_check_trigger_arg_is(&cmd->scan_end_arg,\n\t\t\t\t\t   cmd->chanlist_len);\n\n\tswitch (cmd->stop_src) {\n\tcase TRIG_COUNT:\n\t\terr |= comedi_check_trigger_arg_min(&cmd->stop_arg, 1);\n\t\tbreak;\n\tcase TRIG_EXT:\n\t\t \n\t\tif (cmd->stop_arg & ~CR_FLAGS_MASK) {\n\t\t\tcmd->stop_arg =\n\t\t\t    COMBINE(cmd->stop_arg, 0, ~CR_FLAGS_MASK);\n\t\t\terr |= -EINVAL;\n\t\t}\n\t\t \n\t\tif (cmd->stop_arg & CR_FLAGS_MASK & ~CR_EDGE) {\n\t\t\tcmd->stop_arg =\n\t\t\t    COMBINE(cmd->stop_arg, 0, CR_FLAGS_MASK & ~CR_EDGE);\n\t\t}\n\t\tbreak;\n\tcase TRIG_NONE:\n\t\terr |= comedi_check_trigger_arg_is(&cmd->stop_arg, 0);\n\t\tbreak;\n\t}\n\n\tif (err)\n\t\treturn 3;\n\n\t \n\n\tif (cmd->scan_begin_src == TRIG_TIMER) {\n\t\targ = cmd->scan_begin_arg;\n\t\t \n\t\tcomedi_8254_cascade_ns_to_timer(dev->pacer, &arg, cmd->flags);\n\t\terr |= comedi_check_trigger_arg_is(&cmd->scan_begin_arg, arg);\n\t}\n\n\tif (err)\n\t\treturn 4;\n\n\t \n\tif (cmd->chanlist && cmd->chanlist_len > 0)\n\t\terr |= pci224_ao_check_chanlist(dev, s, cmd);\n\n\tif (err)\n\t\treturn 5;\n\n\treturn 0;\n}\n\nstatic void pci224_ao_start_pacer(struct comedi_device *dev,\n\t\t\t\t  struct comedi_subdevice *s)\n{\n\tstruct pci224_private *devpriv = dev->private;\n\n\t \n\t \n\toutb(pci224_gat_config(0, GAT_VCC), devpriv->iobase1 + PCI224_ZGAT_SCE);\n\t \n\t \n\toutb(pci224_gat_config(2, GAT_VCC), devpriv->iobase1 + PCI224_ZGAT_SCE);\n\t \n\toutb(pci224_clk_config(2, CLK_10MHZ),\n\t     devpriv->iobase1 + PCI224_ZCLK_SCE);\n\t \n\toutb(pci224_clk_config(0, CLK_OUTNM1),\n\t     devpriv->iobase1 + PCI224_ZCLK_SCE);\n\n\tcomedi_8254_pacer_enable(dev->pacer, 2, 0, false);\n}\n\nstatic int pci224_ao_cmd(struct comedi_device *dev, struct comedi_subdevice *s)\n{\n\tconst struct pci224_board *board = dev->board_ptr;\n\tstruct pci224_private *devpriv = dev->private;\n\tstruct comedi_cmd *cmd = &s->async->cmd;\n\tint range;\n\tunsigned int i, j;\n\tunsigned int ch;\n\tunsigned int rank;\n\tunsigned long flags;\n\n\t \n\tif (!cmd->chanlist || cmd->chanlist_len == 0)\n\t\treturn -EINVAL;\n\n\t \n\tdevpriv->ao_enab = 0;\n\n\tfor (i = 0; i < cmd->chanlist_len; i++) {\n\t\tch = CR_CHAN(cmd->chanlist[i]);\n\t\tdevpriv->ao_enab |= 1U << ch;\n\t\trank = 0;\n\t\tfor (j = 0; j < cmd->chanlist_len; j++) {\n\t\t\tif (CR_CHAN(cmd->chanlist[j]) < ch)\n\t\t\t\trank++;\n\t\t}\n\t\tdevpriv->ao_scan_order[rank] = i;\n\t}\n\n\t \n\toutw(devpriv->ao_enab, dev->iobase + PCI224_DACCEN);\n\n\t \n\trange = CR_RANGE(cmd->chanlist[0]);\n\n\t \n\tdevpriv->daccon =\n\t    COMBINE(devpriv->daccon,\n\t\t    board->ao_hwrange[range] | PCI224_DACCON_TRIG_NONE |\n\t\t    PCI224_DACCON_FIFOINTR_NHALF,\n\t\t    PCI224_DACCON_POLAR_MASK | PCI224_DACCON_VREF_MASK |\n\t\t    PCI224_DACCON_TRIG_MASK | PCI224_DACCON_FIFOINTR_MASK);\n\toutw(devpriv->daccon | PCI224_DACCON_FIFORESET,\n\t     dev->iobase + PCI224_DACCON);\n\n\tif (cmd->scan_begin_src == TRIG_TIMER) {\n\t\tcomedi_8254_update_divisors(dev->pacer);\n\t\tpci224_ao_start_pacer(dev, s);\n\t}\n\n\tspin_lock_irqsave(&devpriv->ao_spinlock, flags);\n\tif (cmd->start_src == TRIG_INT) {\n\t\ts->async->inttrig = pci224_ao_inttrig_start;\n\t} else {\t \n\t\t \n\t\tdevpriv->intsce |= PCI224_INTR_EXT;\n\t\toutb(devpriv->intsce, devpriv->iobase1 + PCI224_INT_SCE);\n\t}\n\tspin_unlock_irqrestore(&devpriv->ao_spinlock, flags);\n\n\treturn 0;\n}\n\n \nstatic int pci224_ao_cancel(struct comedi_device *dev,\n\t\t\t    struct comedi_subdevice *s)\n{\n\tpci224_ao_stop(dev, s);\n\treturn 0;\n}\n\n \nstatic void\npci224_ao_munge(struct comedi_device *dev, struct comedi_subdevice *s,\n\t\tvoid *data, unsigned int num_bytes, unsigned int chan_index)\n{\n\tconst struct pci224_board *board = dev->board_ptr;\n\tstruct comedi_cmd *cmd = &s->async->cmd;\n\tunsigned short *array = data;\n\tunsigned int length = num_bytes / sizeof(*array);\n\tunsigned int offset;\n\tunsigned int shift;\n\tunsigned int i;\n\n\t \n\tshift = 16 - board->ao_bits;\n\t \n\tif ((board->ao_hwrange[CR_RANGE(cmd->chanlist[0])] &\n\t     PCI224_DACCON_POLAR_MASK) == PCI224_DACCON_POLAR_UNI) {\n\t\t \n\t\toffset = 0;\n\t} else {\n\t\t \n\t\toffset = 32768;\n\t}\n\t \n\tfor (i = 0; i < length; i++)\n\t\tarray[i] = (array[i] << shift) - offset;\n}\n\n \nstatic irqreturn_t pci224_interrupt(int irq, void *d)\n{\n\tstruct comedi_device *dev = d;\n\tstruct pci224_private *devpriv = dev->private;\n\tstruct comedi_subdevice *s = dev->write_subdev;\n\tstruct comedi_cmd *cmd;\n\tunsigned char intstat, valid_intstat;\n\tunsigned char curenab;\n\tint retval = 0;\n\tunsigned long flags;\n\n\tintstat = inb(devpriv->iobase1 + PCI224_INT_SCE) & 0x3F;\n\tif (intstat) {\n\t\tretval = 1;\n\t\tspin_lock_irqsave(&devpriv->ao_spinlock, flags);\n\t\tvalid_intstat = devpriv->intsce & intstat;\n\t\t \n\t\tcurenab = devpriv->intsce & ~intstat;\n\t\toutb(curenab, devpriv->iobase1 + PCI224_INT_SCE);\n\t\tdevpriv->intr_running = 1;\n\t\tdevpriv->intr_cpuid = THISCPU;\n\t\tspin_unlock_irqrestore(&devpriv->ao_spinlock, flags);\n\t\tif (valid_intstat) {\n\t\t\tcmd = &s->async->cmd;\n\t\t\tif (valid_intstat & PCI224_INTR_EXT) {\n\t\t\t\tdevpriv->intsce &= ~PCI224_INTR_EXT;\n\t\t\t\tif (cmd->start_src == TRIG_EXT)\n\t\t\t\t\tpci224_ao_start(dev, s);\n\t\t\t\telse if (cmd->stop_src == TRIG_EXT)\n\t\t\t\t\tpci224_ao_stop(dev, s);\n\t\t\t}\n\t\t\tif (valid_intstat & PCI224_INTR_DAC)\n\t\t\t\tpci224_ao_handle_fifo(dev, s);\n\t\t}\n\t\t \n\t\tspin_lock_irqsave(&devpriv->ao_spinlock, flags);\n\t\tif (curenab != devpriv->intsce) {\n\t\t\toutb(devpriv->intsce,\n\t\t\t     devpriv->iobase1 + PCI224_INT_SCE);\n\t\t}\n\t\tdevpriv->intr_running = 0;\n\t\tspin_unlock_irqrestore(&devpriv->ao_spinlock, flags);\n\t}\n\treturn IRQ_RETVAL(retval);\n}\n\nstatic int\npci224_auto_attach(struct comedi_device *dev, unsigned long context_model)\n{\n\tstruct pci_dev *pci_dev = comedi_to_pci_dev(dev);\n\tconst struct pci224_board *board = NULL;\n\tstruct pci224_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tunsigned int irq;\n\tint ret;\n\n\tif (context_model < ARRAY_SIZE(pci224_boards))\n\t\tboard = &pci224_boards[context_model];\n\tif (!board || !board->name) {\n\t\tdev_err(dev->class_dev,\n\t\t\t\"amplc_pci224: BUG! cannot determine board type!\\n\");\n\t\treturn -EINVAL;\n\t}\n\tdev->board_ptr = board;\n\tdev->board_name = board->name;\n\n\tdev_info(dev->class_dev, \"amplc_pci224: attach pci %s - %s\\n\",\n\t\t pci_name(pci_dev), dev->board_name);\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\tret = comedi_pci_enable(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tspin_lock_init(&devpriv->ao_spinlock);\n\n\tdevpriv->iobase1 = pci_resource_start(pci_dev, 2);\n\tdev->iobase = pci_resource_start(pci_dev, 3);\n\tirq = pci_dev->irq;\n\n\t \n\tdevpriv->ao_scan_vals = kmalloc_array(board->ao_chans,\n\t\t\t\t\t      sizeof(devpriv->ao_scan_vals[0]),\n\t\t\t\t\t      GFP_KERNEL);\n\tif (!devpriv->ao_scan_vals)\n\t\treturn -ENOMEM;\n\n\t \n\tdevpriv->ao_scan_order =\n\t\t\t\tkmalloc_array(board->ao_chans,\n\t\t\t\t\t      sizeof(devpriv->ao_scan_order[0]),\n\t\t\t\t\t      GFP_KERNEL);\n\tif (!devpriv->ao_scan_order)\n\t\treturn -ENOMEM;\n\n\t \n\tdevpriv->intsce = 0;\n\toutb(0, devpriv->iobase1 + PCI224_INT_SCE);\n\n\t \n\toutw(PCI224_DACCON_GLOBALRESET, dev->iobase + PCI224_DACCON);\n\toutw(0, dev->iobase + PCI224_DACCEN);\n\toutw(0, dev->iobase + PCI224_FIFOSIZ);\n\tdevpriv->daccon = PCI224_DACCON_TRIG_SW | PCI224_DACCON_POLAR_BI |\n\t\t\t  PCI224_DACCON_FIFOENAB | PCI224_DACCON_FIFOINTR_EMPTY;\n\toutw(devpriv->daccon | PCI224_DACCON_FIFORESET,\n\t     dev->iobase + PCI224_DACCON);\n\n\tdev->pacer = comedi_8254_init(devpriv->iobase1 + PCI224_Z2_BASE,\n\t\t\t\t      I8254_OSC_BASE_10MHZ, I8254_IO8, 0);\n\tif (!dev->pacer)\n\t\treturn -ENOMEM;\n\n\tret = comedi_alloc_subdevices(dev, 1);\n\tif (ret)\n\t\treturn ret;\n\n\ts = &dev->subdevices[0];\n\t \n\ts->type = COMEDI_SUBD_AO;\n\ts->subdev_flags = SDF_WRITABLE | SDF_GROUND | SDF_CMD_WRITE;\n\ts->n_chan = board->ao_chans;\n\ts->maxdata = (1 << board->ao_bits) - 1;\n\ts->range_table = board->ao_range;\n\ts->insn_write = pci224_ao_insn_write;\n\ts->len_chanlist = s->n_chan;\n\tdev->write_subdev = s;\n\ts->do_cmd = pci224_ao_cmd;\n\ts->do_cmdtest = pci224_ao_cmdtest;\n\ts->cancel = pci224_ao_cancel;\n\ts->munge = pci224_ao_munge;\n\n\tret = comedi_alloc_subdev_readback(s);\n\tif (ret)\n\t\treturn ret;\n\n\tif (irq) {\n\t\tret = request_irq(irq, pci224_interrupt, IRQF_SHARED,\n\t\t\t\t  dev->board_name, dev);\n\t\tif (ret < 0) {\n\t\t\tdev_err(dev->class_dev,\n\t\t\t\t\"error! unable to allocate irq %u\\n\", irq);\n\t\t\treturn ret;\n\t\t}\n\t\tdev->irq = irq;\n\t}\n\n\treturn 0;\n}\n\nstatic void pci224_detach(struct comedi_device *dev)\n{\n\tstruct pci224_private *devpriv = dev->private;\n\n\tcomedi_pci_detach(dev);\n\tif (devpriv) {\n\t\tkfree(devpriv->ao_scan_vals);\n\t\tkfree(devpriv->ao_scan_order);\n\t}\n}\n\nstatic struct comedi_driver amplc_pci224_driver = {\n\t.driver_name\t= \"amplc_pci224\",\n\t.module\t\t= THIS_MODULE,\n\t.detach\t\t= pci224_detach,\n\t.auto_attach\t= pci224_auto_attach,\n\t.board_name\t= &pci224_boards[0].name,\n\t.offset\t\t= sizeof(struct pci224_board),\n\t.num_names\t= ARRAY_SIZE(pci224_boards),\n};\n\nstatic int amplc_pci224_pci_probe(struct pci_dev *dev,\n\t\t\t\t  const struct pci_device_id *id)\n{\n\treturn comedi_pci_auto_config(dev, &amplc_pci224_driver,\n\t\t\t\t      id->driver_data);\n}\n\nstatic const struct pci_device_id amplc_pci224_pci_table[] = {\n\t{ PCI_VDEVICE(AMPLICON, 0x0007), pci224_model },\n\t{ PCI_VDEVICE(AMPLICON, 0x0008), pci234_model },\n\t{ 0 }\n};\nMODULE_DEVICE_TABLE(pci, amplc_pci224_pci_table);\n\nstatic struct pci_driver amplc_pci224_pci_driver = {\n\t.name\t\t= \"amplc_pci224\",\n\t.id_table\t= amplc_pci224_pci_table,\n\t.probe\t\t= amplc_pci224_pci_probe,\n\t.remove\t\t= comedi_pci_auto_unconfig,\n};\nmodule_comedi_pci_driver(amplc_pci224_driver, amplc_pci224_pci_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for Amplicon PCI224 and PCI234 AO boards\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}