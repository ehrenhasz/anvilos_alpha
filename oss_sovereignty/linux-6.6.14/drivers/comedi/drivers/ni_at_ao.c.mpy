{
  "module_name": "ni_at_ao.c",
  "hash_id": "c1edcb8ab0c461eeaef8c6325e75fdcf69be38a2180768158ca69fc323a2c52d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/comedi/drivers/ni_at_ao.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/comedi/comedidev.h>\n#include <linux/comedi/comedi_8254.h>\n\n \n#define ATAO_DIO_REG\t\t0x00\n#define ATAO_CFG2_REG\t\t0x02\n#define ATAO_CFG2_CALLD_NOP\t(0 << 14)\n#define ATAO_CFG2_CALLD(x)\t((((x) >> 3) + 1) << 14)\n#define ATAO_CFG2_FFRTEN\tBIT(13)\n#define ATAO_CFG2_DACS(x)\t(1 << (((x) / 2) + 8))\n#define ATAO_CFG2_LDAC(x)\t(1 << (((x) / 2) + 3))\n#define ATAO_CFG2_PROMEN\tBIT(2)\n#define ATAO_CFG2_SCLK\t\tBIT(1)\n#define ATAO_CFG2_SDATA\t\tBIT(0)\n#define ATAO_CFG3_REG\t\t0x04\n#define ATAO_CFG3_DMAMODE\tBIT(6)\n#define ATAO_CFG3_CLKOUT\tBIT(5)\n#define ATAO_CFG3_RCLKEN\tBIT(4)\n#define ATAO_CFG3_DOUTEN2\tBIT(3)\n#define ATAO_CFG3_DOUTEN1\tBIT(2)\n#define ATAO_CFG3_EN2_5V\tBIT(1)\n#define ATAO_CFG3_SCANEN\tBIT(0)\n#define ATAO_82C53_BASE\t\t0x06\n#define ATAO_CFG1_REG\t\t0x0a\n#define ATAO_CFG1_EXTINT2EN\tBIT(15)\n#define ATAO_CFG1_EXTINT1EN\tBIT(14)\n#define ATAO_CFG1_CNTINT2EN\tBIT(13)\n#define ATAO_CFG1_CNTINT1EN\tBIT(12)\n#define ATAO_CFG1_TCINTEN\tBIT(11)\n#define ATAO_CFG1_CNT1SRC\tBIT(10)\n#define ATAO_CFG1_CNT2SRC\tBIT(9)\n#define ATAO_CFG1_FIFOEN\tBIT(8)\n#define ATAO_CFG1_GRP2WR\tBIT(7)\n#define ATAO_CFG1_EXTUPDEN\tBIT(6)\n#define ATAO_CFG1_DMARQ\t\tBIT(5)\n#define ATAO_CFG1_DMAEN\t\tBIT(4)\n#define ATAO_CFG1_CH(x)\t\t(((x) & 0xf) << 0)\n#define ATAO_STATUS_REG\t\t0x0a\n#define ATAO_STATUS_FH\t\tBIT(6)\n#define ATAO_STATUS_FE\t\tBIT(5)\n#define ATAO_STATUS_FF\t\tBIT(4)\n#define ATAO_STATUS_INT2\tBIT(3)\n#define ATAO_STATUS_INT1\tBIT(2)\n#define ATAO_STATUS_TCINT\tBIT(1)\n#define ATAO_STATUS_PROMOUT\tBIT(0)\n#define ATAO_FIFO_WRITE_REG\t0x0c\n#define ATAO_FIFO_CLEAR_REG\t0x0c\n#define ATAO_AO_REG(x)\t\t(0x0c + ((x) * 2))\n\n \n#define ATAO_2_DMATCCLR_REG\t0x00\n#define ATAO_2_INT1CLR_REG\t0x02\n#define ATAO_2_INT2CLR_REG\t0x04\n#define ATAO_2_RTSISHFT_REG\t0x06\n#define ATAO_2_RTSISHFT_RSI\tBIT(0)\n#define ATAO_2_RTSISTRB_REG\t0x07\n\nstruct atao_board {\n\tconst char *name;\n\tint n_ao_chans;\n};\n\nstatic const struct atao_board atao_boards[] = {\n\t{\n\t\t.name\t\t= \"at-ao-6\",\n\t\t.n_ao_chans\t= 6,\n\t}, {\n\t\t.name\t\t= \"at-ao-10\",\n\t\t.n_ao_chans\t= 10,\n\t},\n};\n\nstruct atao_private {\n\tunsigned short cfg1;\n\tunsigned short cfg3;\n\n\t \n\tunsigned char caldac[21];\n};\n\nstatic void atao_select_reg_group(struct comedi_device *dev, int group)\n{\n\tstruct atao_private *devpriv = dev->private;\n\n\tif (group)\n\t\tdevpriv->cfg1 |= ATAO_CFG1_GRP2WR;\n\telse\n\t\tdevpriv->cfg1 &= ~ATAO_CFG1_GRP2WR;\n\toutw(devpriv->cfg1, dev->iobase + ATAO_CFG1_REG);\n}\n\nstatic int atao_ao_insn_write(struct comedi_device *dev,\n\t\t\t      struct comedi_subdevice *s,\n\t\t\t      struct comedi_insn *insn,\n\t\t\t      unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int val = s->readback[chan];\n\tint i;\n\n\tif (chan == 0)\n\t\tatao_select_reg_group(dev, 1);\n\n\tfor (i = 0; i < insn->n; i++) {\n\t\tval = data[i];\n\n\t\t \n\t\toutw(comedi_offset_munge(s, val),\n\t\t     dev->iobase + ATAO_AO_REG(chan));\n\t}\n\ts->readback[chan] = val;\n\n\tif (chan == 0)\n\t\tatao_select_reg_group(dev, 0);\n\n\treturn insn->n;\n}\n\nstatic int atao_dio_insn_bits(struct comedi_device *dev,\n\t\t\t      struct comedi_subdevice *s,\n\t\t\t      struct comedi_insn *insn,\n\t\t\t      unsigned int *data)\n{\n\tif (comedi_dio_update_state(s, data))\n\t\toutw(s->state, dev->iobase + ATAO_DIO_REG);\n\n\tdata[1] = inw(dev->iobase + ATAO_DIO_REG);\n\n\treturn insn->n;\n}\n\nstatic int atao_dio_insn_config(struct comedi_device *dev,\n\t\t\t\tstruct comedi_subdevice *s,\n\t\t\t\tstruct comedi_insn *insn,\n\t\t\t\tunsigned int *data)\n{\n\tstruct atao_private *devpriv = dev->private;\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\tunsigned int mask;\n\tint ret;\n\n\tif (chan < 4)\n\t\tmask = 0x0f;\n\telse\n\t\tmask = 0xf0;\n\n\tret = comedi_dio_insn_config(dev, s, insn, data, mask);\n\tif (ret)\n\t\treturn ret;\n\n\tif (s->io_bits & 0x0f)\n\t\tdevpriv->cfg3 |= ATAO_CFG3_DOUTEN1;\n\telse\n\t\tdevpriv->cfg3 &= ~ATAO_CFG3_DOUTEN1;\n\tif (s->io_bits & 0xf0)\n\t\tdevpriv->cfg3 |= ATAO_CFG3_DOUTEN2;\n\telse\n\t\tdevpriv->cfg3 &= ~ATAO_CFG3_DOUTEN2;\n\n\toutw(devpriv->cfg3, dev->iobase + ATAO_CFG3_REG);\n\n\treturn insn->n;\n}\n\n \nstatic int atao_calib_insn_write(struct comedi_device *dev,\n\t\t\t\t struct comedi_subdevice *s,\n\t\t\t\t struct comedi_insn *insn,\n\t\t\t\t unsigned int *data)\n{\n\tunsigned int chan = CR_CHAN(insn->chanspec);\n\n\tif (insn->n) {\n\t\tunsigned int val = data[insn->n - 1];\n\t\tunsigned int bitstring = ((chan & 0x7) << 8) | val;\n\t\tunsigned int bits;\n\t\tint bit;\n\n\t\t \n\t\t \n\t\tfor (bit = BIT(10); bit; bit >>= 1) {\n\t\t\tbits = (bit & bitstring) ? ATAO_CFG2_SDATA : 0;\n\n\t\t\toutw(bits, dev->iobase + ATAO_CFG2_REG);\n\t\t\toutw(bits | ATAO_CFG2_SCLK,\n\t\t\t     dev->iobase + ATAO_CFG2_REG);\n\t\t}\n\n\t\t \n\t\toutw(ATAO_CFG2_CALLD(chan), dev->iobase + ATAO_CFG2_REG);\n\t\toutw(ATAO_CFG2_CALLD_NOP, dev->iobase + ATAO_CFG2_REG);\n\n\t\ts->readback[chan] = val;\n\t}\n\n\treturn insn->n;\n}\n\nstatic void atao_reset(struct comedi_device *dev)\n{\n\tstruct atao_private *devpriv = dev->private;\n\n\t \n\n\tdevpriv->cfg1 = 0;\n\toutw(devpriv->cfg1, dev->iobase + ATAO_CFG1_REG);\n\n\t \n\tcomedi_8254_set_mode(dev->pacer, 0, I8254_MODE4 | I8254_BINARY);\n\tcomedi_8254_set_mode(dev->pacer, 1, I8254_MODE4 | I8254_BINARY);\n\tcomedi_8254_write(dev->pacer, 0, 0x0003);\n\n\toutw(ATAO_CFG2_CALLD_NOP, dev->iobase + ATAO_CFG2_REG);\n\n\tdevpriv->cfg3 = 0;\n\toutw(devpriv->cfg3, dev->iobase + ATAO_CFG3_REG);\n\n\tinw(dev->iobase + ATAO_FIFO_CLEAR_REG);\n\n\tatao_select_reg_group(dev, 1);\n\toutw(0, dev->iobase + ATAO_2_INT1CLR_REG);\n\toutw(0, dev->iobase + ATAO_2_INT2CLR_REG);\n\toutw(0, dev->iobase + ATAO_2_DMATCCLR_REG);\n\tatao_select_reg_group(dev, 0);\n}\n\nstatic int atao_attach(struct comedi_device *dev, struct comedi_devconfig *it)\n{\n\tconst struct atao_board *board = dev->board_ptr;\n\tstruct atao_private *devpriv;\n\tstruct comedi_subdevice *s;\n\tint ret;\n\n\tret = comedi_request_region(dev, it->options[0], 0x20);\n\tif (ret)\n\t\treturn ret;\n\n\tdevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\n\tif (!devpriv)\n\t\treturn -ENOMEM;\n\n\tdev->pacer = comedi_8254_init(dev->iobase + ATAO_82C53_BASE,\n\t\t\t\t      0, I8254_IO8, 0);\n\tif (!dev->pacer)\n\t\treturn -ENOMEM;\n\n\tret = comedi_alloc_subdevices(dev, 4);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[0];\n\ts->type\t\t= COMEDI_SUBD_AO;\n\ts->subdev_flags\t= SDF_WRITABLE;\n\ts->n_chan\t= board->n_ao_chans;\n\ts->maxdata\t= 0x0fff;\n\ts->range_table\t= it->options[3] ? &range_unipolar10 : &range_bipolar10;\n\ts->insn_write\t= atao_ao_insn_write;\n\n\tret = comedi_alloc_subdev_readback(s);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[1];\n\ts->type\t\t= COMEDI_SUBD_DIO;\n\ts->subdev_flags\t= SDF_READABLE | SDF_WRITABLE;\n\ts->n_chan\t= 8;\n\ts->maxdata\t= 1;\n\ts->range_table\t= &range_digital;\n\ts->insn_bits\t= atao_dio_insn_bits;\n\ts->insn_config\t= atao_dio_insn_config;\n\n\t \n\ts = &dev->subdevices[2];\n\ts->type\t\t= COMEDI_SUBD_CALIB;\n\ts->subdev_flags\t= SDF_WRITABLE | SDF_INTERNAL;\n\ts->n_chan\t= (board->n_ao_chans * 2) + 1;\n\ts->maxdata\t= 0xff;\n\ts->insn_write\t= atao_calib_insn_write;\n\n\tret = comedi_alloc_subdev_readback(s);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ts = &dev->subdevices[3];\n\ts->type\t\t= COMEDI_SUBD_UNUSED;\n\n\tatao_reset(dev);\n\n\treturn 0;\n}\n\nstatic struct comedi_driver ni_at_ao_driver = {\n\t.driver_name\t= \"ni_at_ao\",\n\t.module\t\t= THIS_MODULE,\n\t.attach\t\t= atao_attach,\n\t.detach\t\t= comedi_legacy_detach,\n\t.board_name\t= &atao_boards[0].name,\n\t.offset\t\t= sizeof(struct atao_board),\n\t.num_names\t= ARRAY_SIZE(atao_boards),\n};\nmodule_comedi_driver(ni_at_ao_driver);\n\nMODULE_AUTHOR(\"Comedi https://www.comedi.org\");\nMODULE_DESCRIPTION(\"Comedi driver for NI AT-AO-6/10 boards\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}