{
  "module_name": "snvs_lpgpr.c",
  "hash_id": "10077fb9a2a56655f1e67186bfdd2d35826f75dc3d1dfa111f117f3a3906930b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nvmem/snvs_lpgpr.c",
  "human_readable_source": "\n \n\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/nvmem-provider.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define IMX6Q_SNVS_HPLR\t\t0x00\n#define IMX6Q_SNVS_LPLR\t\t0x34\n#define IMX6Q_SNVS_LPGPR\t0x68\n\n#define IMX7D_SNVS_HPLR\t\t0x00\n#define IMX7D_SNVS_LPLR\t\t0x34\n#define IMX7D_SNVS_LPGPR\t0x90\n\n#define IMX_GPR_SL\t\tBIT(5)\n#define IMX_GPR_HL\t\tBIT(5)\n\nstruct snvs_lpgpr_cfg {\n\tint offset;\n\tint offset_hplr;\n\tint offset_lplr;\n\tint size;\n};\n\nstruct snvs_lpgpr_priv {\n\tstruct device_d\t\t\t*dev;\n\tstruct regmap\t\t\t*regmap;\n\tstruct nvmem_config\t\tcfg;\n\tconst struct snvs_lpgpr_cfg\t*dcfg;\n};\n\nstatic const struct snvs_lpgpr_cfg snvs_lpgpr_cfg_imx6q = {\n\t.offset\t\t= IMX6Q_SNVS_LPGPR,\n\t.offset_hplr\t= IMX6Q_SNVS_HPLR,\n\t.offset_lplr\t= IMX6Q_SNVS_LPLR,\n\t.size\t\t= 4,\n};\n\nstatic const struct snvs_lpgpr_cfg snvs_lpgpr_cfg_imx7d = {\n\t.offset\t\t= IMX7D_SNVS_LPGPR,\n\t.offset_hplr\t= IMX7D_SNVS_HPLR,\n\t.offset_lplr\t= IMX7D_SNVS_LPLR,\n\t.size\t\t= 16,\n};\n\nstatic int snvs_lpgpr_write(void *context, unsigned int offset, void *val,\n\t\t\t    size_t bytes)\n{\n\tstruct snvs_lpgpr_priv *priv = context;\n\tconst struct snvs_lpgpr_cfg *dcfg = priv->dcfg;\n\tunsigned int lock_reg;\n\tint ret;\n\n\tret = regmap_read(priv->regmap, dcfg->offset_hplr, &lock_reg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (lock_reg & IMX_GPR_SL)\n\t\treturn -EPERM;\n\n\tret = regmap_read(priv->regmap, dcfg->offset_lplr, &lock_reg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (lock_reg & IMX_GPR_HL)\n\t\treturn -EPERM;\n\n\treturn regmap_bulk_write(priv->regmap, dcfg->offset + offset, val,\n\t\t\t\tbytes / 4);\n}\n\nstatic int snvs_lpgpr_read(void *context, unsigned int offset, void *val,\n\t\t\t   size_t bytes)\n{\n\tstruct snvs_lpgpr_priv *priv = context;\n\tconst struct snvs_lpgpr_cfg *dcfg = priv->dcfg;\n\n\treturn regmap_bulk_read(priv->regmap, dcfg->offset + offset,\n\t\t\t       val, bytes / 4);\n}\n\nstatic int snvs_lpgpr_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *node = dev->of_node;\n\tstruct device_node *syscon_node;\n\tstruct snvs_lpgpr_priv *priv;\n\tstruct nvmem_config *cfg;\n\tstruct nvmem_device *nvmem;\n\tconst struct snvs_lpgpr_cfg *dcfg;\n\n\tif (!node)\n\t\treturn -ENOENT;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tdcfg = of_device_get_match_data(dev);\n\tif (!dcfg)\n\t\treturn -EINVAL;\n\n\tsyscon_node = of_get_parent(node);\n\tif (!syscon_node)\n\t\treturn -ENODEV;\n\n\tpriv->regmap = syscon_node_to_regmap(syscon_node);\n\tof_node_put(syscon_node);\n\tif (IS_ERR(priv->regmap))\n\t\treturn PTR_ERR(priv->regmap);\n\n\tpriv->dcfg = dcfg;\n\n\tcfg = &priv->cfg;\n\tcfg->priv = priv;\n\tcfg->name = dev_name(dev);\n\tcfg->dev = dev;\n\tcfg->stride = 4;\n\tcfg->word_size = 4;\n\tcfg->size = dcfg->size;\n\tcfg->owner = THIS_MODULE;\n\tcfg->reg_read  = snvs_lpgpr_read;\n\tcfg->reg_write = snvs_lpgpr_write;\n\n\tnvmem = devm_nvmem_register(dev, cfg);\n\n\treturn PTR_ERR_OR_ZERO(nvmem);\n}\n\nstatic const struct of_device_id snvs_lpgpr_dt_ids[] = {\n\t{ .compatible = \"fsl,imx6q-snvs-lpgpr\", .data = &snvs_lpgpr_cfg_imx6q },\n\t{ .compatible = \"fsl,imx6ul-snvs-lpgpr\",\n\t  .data = &snvs_lpgpr_cfg_imx6q },\n\t{ .compatible = \"fsl,imx7d-snvs-lpgpr\",\t.data = &snvs_lpgpr_cfg_imx7d },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, snvs_lpgpr_dt_ids);\n\nstatic struct platform_driver snvs_lpgpr_driver = {\n\t.probe\t= snvs_lpgpr_probe,\n\t.driver = {\n\t\t.name\t= \"snvs_lpgpr\",\n\t\t.of_match_table = snvs_lpgpr_dt_ids,\n\t},\n};\nmodule_platform_driver(snvs_lpgpr_driver);\n\nMODULE_AUTHOR(\"Oleksij Rempel <o.rempel@pengutronix.de>\");\nMODULE_DESCRIPTION(\"Low Power General Purpose Register in i.MX6 and i.MX7 Secure Non-Volatile Storage\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}