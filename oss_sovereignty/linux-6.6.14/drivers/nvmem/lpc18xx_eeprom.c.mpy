{
  "module_name": "lpc18xx_eeprom.c",
  "hash_id": "a506a6843a85dcc4683ede77090ea20770157eea59039ec491fa43cecae434fc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nvmem/lpc18xx_eeprom.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/device.h>\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/nvmem-provider.h>\n#include <linux/platform_device.h>\n#include <linux/reset.h>\n\n \n#define LPC18XX_EEPROM_AUTOPROG\t\t\t0x00c\n#define LPC18XX_EEPROM_AUTOPROG_WORD\t\t0x1\n\n#define LPC18XX_EEPROM_CLKDIV\t\t\t0x014\n\n#define LPC18XX_EEPROM_PWRDWN\t\t\t0x018\n#define LPC18XX_EEPROM_PWRDWN_NO\t\t0x0\n#define LPC18XX_EEPROM_PWRDWN_YES\t\t0x1\n\n#define LPC18XX_EEPROM_INTSTAT\t\t\t0xfe0\n#define LPC18XX_EEPROM_INTSTAT_END_OF_PROG\tBIT(2)\n\n#define LPC18XX_EEPROM_INTSTATCLR\t\t0xfe8\n#define LPC18XX_EEPROM_INTSTATCLR_PROG_CLR_ST\tBIT(2)\n\n \n#define LPC18XX_EEPROM_PAGE_SIZE\t\t0x80\n\n \n#define LPC18XX_EEPROM_CLOCK_HZ\t\t\t1500000\n\n \n#define LPC18XX_EEPROM_PROGRAM_TIME\t\t3\n\nstruct lpc18xx_eeprom_dev {\n\tstruct clk *clk;\n\tvoid __iomem *reg_base;\n\tvoid __iomem *mem_base;\n\tstruct nvmem_device *nvmem;\n\tunsigned reg_bytes;\n\tunsigned val_bytes;\n\tint size;\n};\n\nstatic inline void lpc18xx_eeprom_writel(struct lpc18xx_eeprom_dev *eeprom,\n\t\t\t\t\t u32 reg, u32 val)\n{\n\twritel(val, eeprom->reg_base + reg);\n}\n\nstatic inline u32 lpc18xx_eeprom_readl(struct lpc18xx_eeprom_dev *eeprom,\n\t\t\t\t       u32 reg)\n{\n\treturn readl(eeprom->reg_base + reg);\n}\n\nstatic int lpc18xx_eeprom_busywait_until_prog(struct lpc18xx_eeprom_dev *eeprom)\n{\n\tunsigned long end;\n\tu32 val;\n\n\t \n\tend = jiffies + msecs_to_jiffies(LPC18XX_EEPROM_PROGRAM_TIME * 10);\n\n\twhile (time_is_after_jiffies(end)) {\n\t\tval = lpc18xx_eeprom_readl(eeprom, LPC18XX_EEPROM_INTSTAT);\n\n\t\tif (val & LPC18XX_EEPROM_INTSTAT_END_OF_PROG) {\n\t\t\tlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_INTSTATCLR,\n\t\t\t\t\tLPC18XX_EEPROM_INTSTATCLR_PROG_CLR_ST);\n\t\t\treturn 0;\n\t\t}\n\n\t\tusleep_range(LPC18XX_EEPROM_PROGRAM_TIME * USEC_PER_MSEC,\n\t\t\t     (LPC18XX_EEPROM_PROGRAM_TIME + 1) * USEC_PER_MSEC);\n\t}\n\n\treturn -ETIMEDOUT;\n}\n\nstatic int lpc18xx_eeprom_gather_write(void *context, unsigned int reg,\n\t\t\t\t       void *val, size_t bytes)\n{\n\tstruct lpc18xx_eeprom_dev *eeprom = context;\n\tunsigned int offset = reg;\n\tint ret;\n\n\t \n\tif ((reg > eeprom->size - LPC18XX_EEPROM_PAGE_SIZE) ||\n\t\t\t(reg + bytes > eeprom->size - LPC18XX_EEPROM_PAGE_SIZE))\n\t\treturn -EINVAL;\n\n\n\tlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\n\t\t\t      LPC18XX_EEPROM_PWRDWN_NO);\n\n\t \n\tusleep_range(100, 200);\n\n\twhile (bytes) {\n\t\twritel(*(u32 *)val, eeprom->mem_base + offset);\n\t\tret = lpc18xx_eeprom_busywait_until_prog(eeprom);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tbytes -= eeprom->val_bytes;\n\t\tval += eeprom->val_bytes;\n\t\toffset += eeprom->val_bytes;\n\t}\n\n\tlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\n\t\t\t      LPC18XX_EEPROM_PWRDWN_YES);\n\n\treturn 0;\n}\n\nstatic int lpc18xx_eeprom_read(void *context, unsigned int offset,\n\t\t\t       void *val, size_t bytes)\n{\n\tstruct lpc18xx_eeprom_dev *eeprom = context;\n\n\tlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\n\t\t\t      LPC18XX_EEPROM_PWRDWN_NO);\n\n\t \n\tusleep_range(100, 200);\n\n\twhile (bytes) {\n\t\t*(u32 *)val = readl(eeprom->mem_base + offset);\n\t\tbytes -= eeprom->val_bytes;\n\t\tval += eeprom->val_bytes;\n\t\toffset += eeprom->val_bytes;\n\t}\n\n\tlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\n\t\t\t      LPC18XX_EEPROM_PWRDWN_YES);\n\n\treturn 0;\n}\n\n\nstatic struct nvmem_config lpc18xx_nvmem_config = {\n\t.name = \"lpc18xx-eeprom\",\n\t.stride = 4,\n\t.word_size = 4,\n\t.reg_read = lpc18xx_eeprom_read,\n\t.reg_write = lpc18xx_eeprom_gather_write,\n};\n\nstatic int lpc18xx_eeprom_probe(struct platform_device *pdev)\n{\n\tstruct lpc18xx_eeprom_dev *eeprom;\n\tstruct device *dev = &pdev->dev;\n\tstruct reset_control *rst;\n\tunsigned long clk_rate;\n\tstruct resource *res;\n\tint ret;\n\n\teeprom = devm_kzalloc(dev, sizeof(*eeprom), GFP_KERNEL);\n\tif (!eeprom)\n\t\treturn -ENOMEM;\n\n\tres = platform_get_resource_byname(pdev, IORESOURCE_MEM, \"reg\");\n\teeprom->reg_base = devm_ioremap_resource(dev, res);\n\tif (IS_ERR(eeprom->reg_base))\n\t\treturn PTR_ERR(eeprom->reg_base);\n\n\tres = platform_get_resource_byname(pdev, IORESOURCE_MEM, \"mem\");\n\teeprom->mem_base = devm_ioremap_resource(dev, res);\n\tif (IS_ERR(eeprom->mem_base))\n\t\treturn PTR_ERR(eeprom->mem_base);\n\n\teeprom->clk = devm_clk_get(&pdev->dev, \"eeprom\");\n\tif (IS_ERR(eeprom->clk)) {\n\t\tdev_err(&pdev->dev, \"failed to get eeprom clock\\n\");\n\t\treturn PTR_ERR(eeprom->clk);\n\t}\n\n\tret = clk_prepare_enable(eeprom->clk);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"failed to prepare/enable eeprom clk: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\trst = devm_reset_control_get_exclusive(dev, NULL);\n\tif (IS_ERR(rst)) {\n\t\tdev_err(dev, \"failed to get reset: %ld\\n\", PTR_ERR(rst));\n\t\tret = PTR_ERR(rst);\n\t\tgoto err_clk;\n\t}\n\n\tret = reset_control_assert(rst);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"failed to assert reset: %d\\n\", ret);\n\t\tgoto err_clk;\n\t}\n\n\teeprom->val_bytes = 4;\n\teeprom->reg_bytes = 4;\n\n\t \n\tclk_rate = clk_get_rate(eeprom->clk);\n\tclk_rate = DIV_ROUND_UP(clk_rate, LPC18XX_EEPROM_CLOCK_HZ) - 1;\n\tlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_CLKDIV, clk_rate);\n\n\t \n\tlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_AUTOPROG,\n\t\t\t      LPC18XX_EEPROM_AUTOPROG_WORD);\n\n\tlpc18xx_eeprom_writel(eeprom, LPC18XX_EEPROM_PWRDWN,\n\t\t\t      LPC18XX_EEPROM_PWRDWN_YES);\n\n\teeprom->size = resource_size(res);\n\tlpc18xx_nvmem_config.size = resource_size(res);\n\tlpc18xx_nvmem_config.dev = dev;\n\tlpc18xx_nvmem_config.priv = eeprom;\n\n\teeprom->nvmem = devm_nvmem_register(dev, &lpc18xx_nvmem_config);\n\tif (IS_ERR(eeprom->nvmem)) {\n\t\tret = PTR_ERR(eeprom->nvmem);\n\t\tgoto err_clk;\n\t}\n\n\tplatform_set_drvdata(pdev, eeprom);\n\n\treturn 0;\n\nerr_clk:\n\tclk_disable_unprepare(eeprom->clk);\n\n\treturn ret;\n}\n\nstatic int lpc18xx_eeprom_remove(struct platform_device *pdev)\n{\n\tstruct lpc18xx_eeprom_dev *eeprom = platform_get_drvdata(pdev);\n\n\tclk_disable_unprepare(eeprom->clk);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id lpc18xx_eeprom_of_match[] = {\n\t{ .compatible = \"nxp,lpc1857-eeprom\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, lpc18xx_eeprom_of_match);\n\nstatic struct platform_driver lpc18xx_eeprom_driver = {\n\t.probe = lpc18xx_eeprom_probe,\n\t.remove = lpc18xx_eeprom_remove,\n\t.driver = {\n\t\t.name = \"lpc18xx-eeprom\",\n\t\t.of_match_table = lpc18xx_eeprom_of_match,\n\t},\n};\n\nmodule_platform_driver(lpc18xx_eeprom_driver);\n\nMODULE_AUTHOR(\"Ariel D'Alessandro <ariel@vanguardiasur.com.ar>\");\nMODULE_DESCRIPTION(\"NXP LPC18xx EEPROM memory Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}