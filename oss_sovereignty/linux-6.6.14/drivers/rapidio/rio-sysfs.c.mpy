{
  "module_name": "rio-sysfs.c",
  "hash_id": "165e889d33eb1acda2049a3f33d3d9987bb6cdd90cdc019a058cf4a8d6bc271e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rapidio/rio-sysfs.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/rio.h>\n#include <linux/rio_drv.h>\n#include <linux/stat.h>\n#include <linux/capability.h>\n\n#include \"rio.h\"\n\n \n#define rio_config_attr(field, format_string)\t\t\t\t\t\\\nstatic ssize_t\t\t\t\t\t\t\t\t\\\nfield##_show(struct device *dev, struct device_attribute *attr, char *buf)\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tstruct rio_dev *rdev = to_rio_dev(dev);\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\treturn sprintf(buf, format_string, rdev->field);\t\t\\\n}\t\t\t\t\t\t\t\t\t\\\nstatic DEVICE_ATTR_RO(field);\n\nrio_config_attr(did, \"0x%04x\\n\");\nrio_config_attr(vid, \"0x%04x\\n\");\nrio_config_attr(device_rev, \"0x%08x\\n\");\nrio_config_attr(asm_did, \"0x%04x\\n\");\nrio_config_attr(asm_vid, \"0x%04x\\n\");\nrio_config_attr(asm_rev, \"0x%04x\\n\");\nrio_config_attr(destid, \"0x%04x\\n\");\nrio_config_attr(hopcount, \"0x%02x\\n\");\n\nstatic ssize_t routes_show(struct device *dev, struct device_attribute *attr, char *buf)\n{\n\tstruct rio_dev *rdev = to_rio_dev(dev);\n\tchar *str = buf;\n\tint i;\n\n\tfor (i = 0; i < RIO_MAX_ROUTE_ENTRIES(rdev->net->hport->sys_size);\n\t\t\ti++) {\n\t\tif (rdev->rswitch->route_table[i] == RIO_INVALID_ROUTE)\n\t\t\tcontinue;\n\t\tstr +=\n\t\t    sprintf(str, \"%04x %02x\\n\", i,\n\t\t\t    rdev->rswitch->route_table[i]);\n\t}\n\n\treturn (str - buf);\n}\nstatic DEVICE_ATTR_RO(routes);\n\nstatic ssize_t lprev_show(struct device *dev,\n\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tstruct rio_dev *rdev = to_rio_dev(dev);\n\n\treturn sprintf(buf, \"%s\\n\",\n\t\t\t(rdev->prev) ? rio_name(rdev->prev) : \"root\");\n}\nstatic DEVICE_ATTR_RO(lprev);\n\nstatic ssize_t lnext_show(struct device *dev,\n\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tstruct rio_dev *rdev = to_rio_dev(dev);\n\tchar *str = buf;\n\tint i;\n\n\tif (rdev->pef & RIO_PEF_SWITCH) {\n\t\tfor (i = 0; i < RIO_GET_TOTAL_PORTS(rdev->swpinfo); i++) {\n\t\t\tif (rdev->rswitch->nextdev[i])\n\t\t\t\tstr += sprintf(str, \"%s\\n\",\n\t\t\t\t\trio_name(rdev->rswitch->nextdev[i]));\n\t\t\telse\n\t\t\t\tstr += sprintf(str, \"null\\n\");\n\t\t}\n\t}\n\n\treturn str - buf;\n}\nstatic DEVICE_ATTR_RO(lnext);\n\nstatic ssize_t modalias_show(struct device *dev,\n\t\t\t     struct device_attribute *attr, char *buf)\n{\n\tstruct rio_dev *rdev = to_rio_dev(dev);\n\n\treturn sprintf(buf, \"rapidio:v%04Xd%04Xav%04Xad%04X\\n\",\n\t\t       rdev->vid, rdev->did, rdev->asm_vid, rdev->asm_did);\n}\nstatic DEVICE_ATTR_RO(modalias);\n\nstatic struct attribute *rio_dev_attrs[] = {\n\t&dev_attr_did.attr,\n\t&dev_attr_vid.attr,\n\t&dev_attr_device_rev.attr,\n\t&dev_attr_asm_did.attr,\n\t&dev_attr_asm_vid.attr,\n\t&dev_attr_asm_rev.attr,\n\t&dev_attr_lprev.attr,\n\t&dev_attr_destid.attr,\n\t&dev_attr_modalias.attr,\n\n\t \n\t&dev_attr_routes.attr,\n\t&dev_attr_lnext.attr,\n\t&dev_attr_hopcount.attr,\n\tNULL,\n};\n\nstatic ssize_t\nrio_read_config(struct file *filp, struct kobject *kobj,\n\t\tstruct bin_attribute *bin_attr,\n\t\tchar *buf, loff_t off, size_t count)\n{\n\tstruct rio_dev *dev = to_rio_dev(kobj_to_dev(kobj));\n\tunsigned int size = 0x100;\n\tloff_t init_off = off;\n\tu8 *data = (u8 *) buf;\n\n\t \n\tif (capable(CAP_SYS_ADMIN))\n\t\tsize = RIO_MAINT_SPACE_SZ;\n\n\tif (off >= size)\n\t\treturn 0;\n\tif (off + count > size) {\n\t\tsize -= off;\n\t\tcount = size;\n\t} else {\n\t\tsize = count;\n\t}\n\n\tif ((off & 1) && size) {\n\t\tu8 val;\n\t\trio_read_config_8(dev, off, &val);\n\t\tdata[off - init_off] = val;\n\t\toff++;\n\t\tsize--;\n\t}\n\n\tif ((off & 3) && size > 2) {\n\t\tu16 val;\n\t\trio_read_config_16(dev, off, &val);\n\t\tdata[off - init_off] = (val >> 8) & 0xff;\n\t\tdata[off - init_off + 1] = val & 0xff;\n\t\toff += 2;\n\t\tsize -= 2;\n\t}\n\n\twhile (size > 3) {\n\t\tu32 val;\n\t\trio_read_config_32(dev, off, &val);\n\t\tdata[off - init_off] = (val >> 24) & 0xff;\n\t\tdata[off - init_off + 1] = (val >> 16) & 0xff;\n\t\tdata[off - init_off + 2] = (val >> 8) & 0xff;\n\t\tdata[off - init_off + 3] = val & 0xff;\n\t\toff += 4;\n\t\tsize -= 4;\n\t}\n\n\tif (size >= 2) {\n\t\tu16 val;\n\t\trio_read_config_16(dev, off, &val);\n\t\tdata[off - init_off] = (val >> 8) & 0xff;\n\t\tdata[off - init_off + 1] = val & 0xff;\n\t\toff += 2;\n\t\tsize -= 2;\n\t}\n\n\tif (size > 0) {\n\t\tu8 val;\n\t\trio_read_config_8(dev, off, &val);\n\t\tdata[off - init_off] = val;\n\t\toff++;\n\t\t--size;\n\t}\n\n\treturn count;\n}\n\nstatic ssize_t\nrio_write_config(struct file *filp, struct kobject *kobj,\n\t\t struct bin_attribute *bin_attr,\n\t\t char *buf, loff_t off, size_t count)\n{\n\tstruct rio_dev *dev = to_rio_dev(kobj_to_dev(kobj));\n\tunsigned int size = count;\n\tloff_t init_off = off;\n\tu8 *data = (u8 *) buf;\n\n\tif (off >= RIO_MAINT_SPACE_SZ)\n\t\treturn 0;\n\tif (off + count > RIO_MAINT_SPACE_SZ) {\n\t\tsize = RIO_MAINT_SPACE_SZ - off;\n\t\tcount = size;\n\t}\n\n\tif ((off & 1) && size) {\n\t\trio_write_config_8(dev, off, data[off - init_off]);\n\t\toff++;\n\t\tsize--;\n\t}\n\n\tif ((off & 3) && (size > 2)) {\n\t\tu16 val = data[off - init_off + 1];\n\t\tval |= (u16) data[off - init_off] << 8;\n\t\trio_write_config_16(dev, off, val);\n\t\toff += 2;\n\t\tsize -= 2;\n\t}\n\n\twhile (size > 3) {\n\t\tu32 val = data[off - init_off + 3];\n\t\tval |= (u32) data[off - init_off + 2] << 8;\n\t\tval |= (u32) data[off - init_off + 1] << 16;\n\t\tval |= (u32) data[off - init_off] << 24;\n\t\trio_write_config_32(dev, off, val);\n\t\toff += 4;\n\t\tsize -= 4;\n\t}\n\n\tif (size >= 2) {\n\t\tu16 val = data[off - init_off + 1];\n\t\tval |= (u16) data[off - init_off] << 8;\n\t\trio_write_config_16(dev, off, val);\n\t\toff += 2;\n\t\tsize -= 2;\n\t}\n\n\tif (size) {\n\t\trio_write_config_8(dev, off, data[off - init_off]);\n\t\toff++;\n\t\t--size;\n\t}\n\n\treturn count;\n}\n\nstatic struct bin_attribute rio_config_attr = {\n\t.attr = {\n\t\t .name = \"config\",\n\t\t .mode = S_IRUGO | S_IWUSR,\n\t\t },\n\t.size = RIO_MAINT_SPACE_SZ,\n\t.read = rio_read_config,\n\t.write = rio_write_config,\n};\n\nstatic struct bin_attribute *rio_dev_bin_attrs[] = {\n\t&rio_config_attr,\n\tNULL,\n};\n\nstatic umode_t rio_dev_is_attr_visible(struct kobject *kobj,\n\t\t\t\t       struct attribute *attr, int n)\n{\n\tstruct rio_dev *rdev = to_rio_dev(kobj_to_dev(kobj));\n\tumode_t mode = attr->mode;\n\n\tif (!(rdev->pef & RIO_PEF_SWITCH) &&\n\t    (attr == &dev_attr_routes.attr ||\n\t     attr == &dev_attr_lnext.attr ||\n\t     attr == &dev_attr_hopcount.attr)) {\n\t\t \n\t\tmode = 0;\n\t}\n\n\treturn mode;\n}\n\nstatic const struct attribute_group rio_dev_group = {\n\t.attrs\t\t= rio_dev_attrs,\n\t.is_visible\t= rio_dev_is_attr_visible,\n\t.bin_attrs\t= rio_dev_bin_attrs,\n};\n\nconst struct attribute_group *rio_dev_groups[] = {\n\t&rio_dev_group,\n\tNULL,\n};\n\nstatic ssize_t scan_store(const struct bus_type *bus, const char *buf, size_t count)\n{\n\tlong val;\n\tint rc;\n\n\tif (kstrtol(buf, 0, &val) < 0)\n\t\treturn -EINVAL;\n\n\tif (val == RIO_MPORT_ANY) {\n\t\trc = rio_init_mports();\n\t\tgoto exit;\n\t}\n\n\tif (val < 0 || val >= RIO_MAX_MPORTS)\n\t\treturn -EINVAL;\n\n\trc = rio_mport_scan((int)val);\nexit:\n\tif (!rc)\n\t\trc = count;\n\n\treturn rc;\n}\nstatic BUS_ATTR_WO(scan);\n\nstatic struct attribute *rio_bus_attrs[] = {\n\t&bus_attr_scan.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group rio_bus_group = {\n\t.attrs = rio_bus_attrs,\n};\n\nconst struct attribute_group *rio_bus_groups[] = {\n\t&rio_bus_group,\n\tNULL,\n};\n\nstatic ssize_t\nport_destid_show(struct device *dev, struct device_attribute *attr,\n\t\t char *buf)\n{\n\tstruct rio_mport *mport = to_rio_mport(dev);\n\n\tif (mport)\n\t\treturn sprintf(buf, \"0x%04x\\n\", mport->host_deviceid);\n\telse\n\t\treturn -ENODEV;\n}\nstatic DEVICE_ATTR_RO(port_destid);\n\nstatic ssize_t sys_size_show(struct device *dev, struct device_attribute *attr,\n\t\t\t   char *buf)\n{\n\tstruct rio_mport *mport = to_rio_mport(dev);\n\n\tif (mport)\n\t\treturn sprintf(buf, \"%u\\n\", mport->sys_size);\n\telse\n\t\treturn -ENODEV;\n}\nstatic DEVICE_ATTR_RO(sys_size);\n\nstatic struct attribute *rio_mport_attrs[] = {\n\t&dev_attr_port_destid.attr,\n\t&dev_attr_sys_size.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group rio_mport_group = {\n\t.attrs = rio_mport_attrs,\n};\n\nconst struct attribute_group *rio_mport_groups[] = {\n\t&rio_mport_group,\n\tNULL,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}