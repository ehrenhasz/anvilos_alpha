{
  "module_name": "rio-driver.c",
  "hash_id": "caaff48a65a2a06d644fcac70aa46d1ad5f177608a7c091ee318a41681b0f590",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rapidio/rio-driver.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/rio.h>\n#include <linux/rio_ids.h>\n#include <linux/rio_drv.h>\n\n#include \"rio.h\"\n\n \nstatic const struct rio_device_id *rio_match_device(const struct rio_device_id\n\t\t\t\t\t\t    *id,\n\t\t\t\t\t\t    const struct rio_dev *rdev)\n{\n\twhile (id->vid || id->asm_vid) {\n\t\tif (((id->vid == RIO_ANY_ID) || (id->vid == rdev->vid)) &&\n\t\t    ((id->did == RIO_ANY_ID) || (id->did == rdev->did)) &&\n\t\t    ((id->asm_vid == RIO_ANY_ID)\n\t\t     || (id->asm_vid == rdev->asm_vid))\n\t\t    && ((id->asm_did == RIO_ANY_ID)\n\t\t\t|| (id->asm_did == rdev->asm_did)))\n\t\t\treturn id;\n\t\tid++;\n\t}\n\treturn NULL;\n}\n\n \nstruct rio_dev *rio_dev_get(struct rio_dev *rdev)\n{\n\tif (rdev)\n\t\tget_device(&rdev->dev);\n\n\treturn rdev;\n}\n\n \nvoid rio_dev_put(struct rio_dev *rdev)\n{\n\tif (rdev)\n\t\tput_device(&rdev->dev);\n}\n\n \nstatic int rio_device_probe(struct device *dev)\n{\n\tstruct rio_driver *rdrv = to_rio_driver(dev->driver);\n\tstruct rio_dev *rdev = to_rio_dev(dev);\n\tint error = -ENODEV;\n\tconst struct rio_device_id *id;\n\n\tif (!rdev->driver && rdrv->probe) {\n\t\tif (!rdrv->id_table)\n\t\t\treturn error;\n\t\tid = rio_match_device(rdrv->id_table, rdev);\n\t\trio_dev_get(rdev);\n\t\tif (id)\n\t\t\terror = rdrv->probe(rdev, id);\n\t\tif (error >= 0) {\n\t\t\trdev->driver = rdrv;\n\t\t\terror = 0;\n\t\t} else\n\t\t\trio_dev_put(rdev);\n\t}\n\treturn error;\n}\n\n \nstatic void rio_device_remove(struct device *dev)\n{\n\tstruct rio_dev *rdev = to_rio_dev(dev);\n\tstruct rio_driver *rdrv = rdev->driver;\n\n\tif (rdrv) {\n\t\tif (rdrv->remove)\n\t\t\trdrv->remove(rdev);\n\t\trdev->driver = NULL;\n\t}\n\n\trio_dev_put(rdev);\n}\n\nstatic void rio_device_shutdown(struct device *dev)\n{\n\tstruct rio_dev *rdev = to_rio_dev(dev);\n\tstruct rio_driver *rdrv = rdev->driver;\n\n\tdev_dbg(dev, \"RIO: %s\\n\", __func__);\n\n\tif (rdrv && rdrv->shutdown)\n\t\trdrv->shutdown(rdev);\n}\n\n \nint rio_register_driver(struct rio_driver *rdrv)\n{\n\t \n\trdrv->driver.name = rdrv->name;\n\trdrv->driver.bus = &rio_bus_type;\n\n\t \n\treturn driver_register(&rdrv->driver);\n}\n\n \nvoid rio_unregister_driver(struct rio_driver *rdrv)\n{\n\tdriver_unregister(&rdrv->driver);\n}\n\nvoid rio_attach_device(struct rio_dev *rdev)\n{\n\trdev->dev.bus = &rio_bus_type;\n}\nEXPORT_SYMBOL_GPL(rio_attach_device);\n\n \nstatic int rio_match_bus(struct device *dev, struct device_driver *drv)\n{\n\tstruct rio_dev *rdev = to_rio_dev(dev);\n\tstruct rio_driver *rdrv = to_rio_driver(drv);\n\tconst struct rio_device_id *id = rdrv->id_table;\n\tconst struct rio_device_id *found_id;\n\n\tif (!id)\n\t\tgoto out;\n\n\tfound_id = rio_match_device(id, rdev);\n\n\tif (found_id)\n\t\treturn 1;\n\n      out:return 0;\n}\n\nstatic int rio_uevent(const struct device *dev, struct kobj_uevent_env *env)\n{\n\tconst struct rio_dev *rdev;\n\n\tif (!dev)\n\t\treturn -ENODEV;\n\n\trdev = to_rio_dev(dev);\n\tif (!rdev)\n\t\treturn -ENODEV;\n\n\tif (add_uevent_var(env, \"MODALIAS=rapidio:v%04Xd%04Xav%04Xad%04X\",\n\t\t\t   rdev->vid, rdev->did, rdev->asm_vid, rdev->asm_did))\n\t\treturn -ENOMEM;\n\treturn 0;\n}\n\nstruct class rio_mport_class = {\n\t.name\t\t= \"rapidio_port\",\n\t.dev_groups\t= rio_mport_groups,\n};\nEXPORT_SYMBOL_GPL(rio_mport_class);\n\nstruct bus_type rio_bus_type = {\n\t.name = \"rapidio\",\n\t.match = rio_match_bus,\n\t.dev_groups = rio_dev_groups,\n\t.bus_groups = rio_bus_groups,\n\t.probe = rio_device_probe,\n\t.remove = rio_device_remove,\n\t.shutdown = rio_device_shutdown,\n\t.uevent\t= rio_uevent,\n};\n\n \nstatic int __init rio_bus_init(void)\n{\n\tint ret;\n\n\tret = class_register(&rio_mport_class);\n\tif (!ret) {\n\t\tret = bus_register(&rio_bus_type);\n\t\tif (ret)\n\t\t\tclass_unregister(&rio_mport_class);\n\t}\n\treturn ret;\n}\n\npostcore_initcall(rio_bus_init);\n\nEXPORT_SYMBOL_GPL(rio_register_driver);\nEXPORT_SYMBOL_GPL(rio_unregister_driver);\nEXPORT_SYMBOL_GPL(rio_bus_type);\nEXPORT_SYMBOL_GPL(rio_dev_get);\nEXPORT_SYMBOL_GPL(rio_dev_put);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}