{
  "module_name": "fault_inject.c",
  "hash_id": "786ed99ab9586a4a9488fc097bcdfbc97d88202ccc41da14c314fa8e93831b0d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nvme/host/fault_inject.c",
  "human_readable_source": "\n \n\n#include <linux/moduleparam.h>\n#include \"nvme.h\"\n\nstatic DECLARE_FAULT_ATTR(fail_default_attr);\n \nstatic char *fail_request;\nmodule_param(fail_request, charp, 0000);\n\nvoid nvme_fault_inject_init(struct nvme_fault_inject *fault_inj,\n\t\t\t    const char *dev_name)\n{\n\tstruct dentry *dir, *parent;\n\tstruct fault_attr *attr = &fault_inj->attr;\n\n\t \n\tif (fail_request)\n\t\tsetup_fault_attr(&fail_default_attr, fail_request);\n\n\t \n\tparent = debugfs_create_dir(dev_name, NULL);\n\tif (IS_ERR(parent)) {\n\t\tpr_warn(\"%s: failed to create debugfs directory\\n\", dev_name);\n\t\treturn;\n\t}\n\n\t*attr = fail_default_attr;\n\tdir = fault_create_debugfs_attr(\"fault_inject\", parent, attr);\n\tif (IS_ERR(dir)) {\n\t\tpr_warn(\"%s: failed to create debugfs attr\\n\", dev_name);\n\t\tdebugfs_remove_recursive(parent);\n\t\treturn;\n\t}\n\tfault_inj->parent = parent;\n\n\t \n\tfault_inj->status = NVME_SC_INVALID_OPCODE;\n\tfault_inj->dont_retry = true;\n\tdebugfs_create_x16(\"status\", 0600, dir,\t&fault_inj->status);\n\tdebugfs_create_bool(\"dont_retry\", 0600, dir, &fault_inj->dont_retry);\n}\n\nvoid nvme_fault_inject_fini(struct nvme_fault_inject *fault_inject)\n{\n\t \n\tdebugfs_remove_recursive(fault_inject->parent);\n}\n\nvoid nvme_should_fail(struct request *req)\n{\n\tstruct gendisk *disk = req->q->disk;\n\tstruct nvme_fault_inject *fault_inject = NULL;\n\tu16 status;\n\n\tif (disk) {\n\t\tstruct nvme_ns *ns = disk->private_data;\n\n\t\tif (ns)\n\t\t\tfault_inject = &ns->fault_inject;\n\t\telse\n\t\t\tWARN_ONCE(1, \"No namespace found for request\\n\");\n\t} else {\n\t\tfault_inject = &nvme_req(req)->ctrl->fault_inject;\n\t}\n\n\tif (fault_inject && should_fail(&fault_inject->attr, 1)) {\n\t\t \n\t\tstatus = fault_inject->status;\n\t\tif (fault_inject->dont_retry)\n\t\t\tstatus |= NVME_SC_DNR;\n\t\tnvme_req(req)->status =\tstatus;\n\t}\n}\nEXPORT_SYMBOL_GPL(nvme_should_fail);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}