{
  "module_name": "amd_sfh_hid_desc.c",
  "hash_id": "e4f1b2eb2a8c668ec62d463789bba93e68dac718a0560cf8acb67cc91878f548",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/amd-sfh-hid/hid_descriptor/amd_sfh_hid_desc.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/slab.h>\n#include \"amd_sfh_pcie.h\"\n#include \"amd_sfh_hid_desc.h\"\n#include \"amd_sfh_hid_report_desc.h\"\n#include \"amd_sfh_hid.h\"\n\n#define\tAMD_SFH_FW_MULTIPLIER (1000)\n#define HID_USAGE_SENSOR_PROP_REPORTING_STATE_ALL_EVENTS_ENUM\t0x41\n#define HID_USAGE_SENSOR_PROP_POWER_STATE_D0_FULL_POWER_ENUM\t0x51\n#define HID_DEFAULT_REPORT_INTERVAL\t\t\t\t0x50\n#define HID_DEFAULT_MIN_VALUE\t\t\t\t\t0X7F\n#define HID_DEFAULT_MAX_VALUE\t\t\t\t\t0x80\n#define HID_DEFAULT_SENSITIVITY\t\t\t\t\t0x7F\n#define HID_USAGE_SENSOR_PROPERTY_CONNECTION_TYPE_PC_INTEGRATED_ENUM  0x01\n \n#define HID_USAGE_SENSOR_STATE_READY_ENUM                             0x02\n#define HID_USAGE_SENSOR_STATE_INITIALIZING_ENUM                      0x05\n#define HID_USAGE_SENSOR_EVENT_DATA_UPDATED_ENUM                      0x04\n#define ILLUMINANCE_MASK\t\t\t\t\tGENMASK(14, 0)\n\nstatic int get_report_descriptor(int sensor_idx, u8 *rep_desc)\n{\n\tswitch (sensor_idx) {\n\tcase accel_idx:  \n\t\tmemset(rep_desc, 0, sizeof(accel3_report_descriptor));\n\t\tmemcpy(rep_desc, accel3_report_descriptor,\n\t\t       sizeof(accel3_report_descriptor));\n\t\tbreak;\n\tcase gyro_idx:  \n\t\tmemset(rep_desc, 0, sizeof(gyro3_report_descriptor));\n\t\tmemcpy(rep_desc, gyro3_report_descriptor,\n\t\t       sizeof(gyro3_report_descriptor));\n\t\tbreak;\n\tcase mag_idx:  \n\t\tmemset(rep_desc, 0, sizeof(comp3_report_descriptor));\n\t\tmemcpy(rep_desc, comp3_report_descriptor,\n\t\t       sizeof(comp3_report_descriptor));\n\t\tbreak;\n\tcase als_idx:  \n\tcase ACS_IDX:  \n\t\tmemset(rep_desc, 0, sizeof(als_report_descriptor));\n\t\tmemcpy(rep_desc, als_report_descriptor,\n\t\t       sizeof(als_report_descriptor));\n\t\tbreak;\n\tcase HPD_IDX:  \n\t\tmemset(rep_desc, 0, sizeof(hpd_report_descriptor));\n\t\tmemcpy(rep_desc, hpd_report_descriptor,\n\t\t       sizeof(hpd_report_descriptor));\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic u32 get_descr_sz(int sensor_idx, int descriptor_name)\n{\n\tswitch (sensor_idx) {\n\tcase accel_idx:\n\t\tswitch (descriptor_name) {\n\t\tcase descr_size:\n\t\t\treturn sizeof(accel3_report_descriptor);\n\t\tcase input_size:\n\t\t\treturn sizeof(struct accel3_input_report);\n\t\tcase feature_size:\n\t\t\treturn sizeof(struct accel3_feature_report);\n\t\t}\n\t\tbreak;\n\tcase gyro_idx:\n\t\tswitch (descriptor_name) {\n\t\tcase descr_size:\n\t\t\treturn sizeof(gyro3_report_descriptor);\n\t\tcase input_size:\n\t\t\treturn sizeof(struct gyro_input_report);\n\t\tcase feature_size:\n\t\t\treturn sizeof(struct gyro_feature_report);\n\t\t}\n\t\tbreak;\n\tcase mag_idx:\n\t\tswitch (descriptor_name) {\n\t\tcase descr_size:\n\t\t\treturn sizeof(comp3_report_descriptor);\n\t\tcase input_size:\n\t\t\treturn sizeof(struct magno_input_report);\n\t\tcase feature_size:\n\t\t\treturn sizeof(struct magno_feature_report);\n\t\t}\n\t\tbreak;\n\tcase als_idx:\n\tcase ACS_IDX:  \n\t\tswitch (descriptor_name) {\n\t\tcase descr_size:\n\t\t\treturn sizeof(als_report_descriptor);\n\t\tcase input_size:\n\t\t\treturn sizeof(struct als_input_report);\n\t\tcase feature_size:\n\t\t\treturn sizeof(struct als_feature_report);\n\t\t}\n\t\tbreak;\n\tcase HPD_IDX:\n\t\tswitch (descriptor_name) {\n\t\tcase descr_size:\n\t\t\treturn sizeof(hpd_report_descriptor);\n\t\tcase input_size:\n\t\t\treturn sizeof(struct hpd_input_report);\n\t\tcase feature_size:\n\t\t\treturn sizeof(struct hpd_feature_report);\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic void get_common_features(struct common_feature_property *common, int report_id)\n{\n\tcommon->report_id = report_id;\n\tcommon->connection_type = HID_USAGE_SENSOR_PROPERTY_CONNECTION_TYPE_PC_INTEGRATED_ENUM;\n\tcommon->report_state = HID_USAGE_SENSOR_PROP_REPORTING_STATE_ALL_EVENTS_ENUM;\n\tcommon->power_state = HID_USAGE_SENSOR_PROP_POWER_STATE_D0_FULL_POWER_ENUM;\n\tcommon->sensor_state = HID_USAGE_SENSOR_STATE_INITIALIZING_ENUM;\n\tcommon->report_interval =  HID_DEFAULT_REPORT_INTERVAL;\n}\n\nstatic u8 get_feature_report(int sensor_idx, int report_id, u8 *feature_report)\n{\n\tstruct accel3_feature_report acc_feature;\n\tstruct gyro_feature_report gyro_feature;\n\tstruct magno_feature_report magno_feature;\n\tstruct hpd_feature_report hpd_feature;\n\tstruct als_feature_report als_feature;\n\tu8 report_size = 0;\n\n\tif (!feature_report)\n\t\treturn report_size;\n\n\tswitch (sensor_idx) {\n\tcase accel_idx:  \n\t\tget_common_features(&acc_feature.common_property, report_id);\n\t\tacc_feature.accel_change_sesnitivity = HID_DEFAULT_SENSITIVITY;\n\t\tacc_feature.accel_sensitivity_min = HID_DEFAULT_MIN_VALUE;\n\t\tacc_feature.accel_sensitivity_max = HID_DEFAULT_MAX_VALUE;\n\t\tmemcpy(feature_report, &acc_feature, sizeof(acc_feature));\n\t\treport_size = sizeof(acc_feature);\n\t\tbreak;\n\tcase gyro_idx:  \n\t\tget_common_features(&gyro_feature.common_property, report_id);\n\t\tgyro_feature.gyro_change_sesnitivity = HID_DEFAULT_SENSITIVITY;\n\t\tgyro_feature.gyro_sensitivity_min = HID_DEFAULT_MIN_VALUE;\n\t\tgyro_feature.gyro_sensitivity_max = HID_DEFAULT_MAX_VALUE;\n\t\tmemcpy(feature_report, &gyro_feature, sizeof(gyro_feature));\n\t\treport_size = sizeof(gyro_feature);\n\t\tbreak;\n\tcase mag_idx:  \n\t\tget_common_features(&magno_feature.common_property, report_id);\n\t\tmagno_feature.magno_headingchange_sensitivity = HID_DEFAULT_SENSITIVITY;\n\t\tmagno_feature.heading_min = HID_DEFAULT_MIN_VALUE;\n\t\tmagno_feature.heading_max = HID_DEFAULT_MAX_VALUE;\n\t\tmagno_feature.flux_change_sensitivity = HID_DEFAULT_MIN_VALUE;\n\t\tmagno_feature.flux_min = HID_DEFAULT_MIN_VALUE;\n\t\tmagno_feature.flux_max = HID_DEFAULT_MAX_VALUE;\n\t\tmemcpy(feature_report, &magno_feature, sizeof(magno_feature));\n\t\treport_size = sizeof(magno_feature);\n\t\tbreak;\n\tcase als_idx:   \n\tcase ACS_IDX:  \n\t\tget_common_features(&als_feature.common_property, report_id);\n\t\tals_feature.als_change_sesnitivity = HID_DEFAULT_SENSITIVITY;\n\t\tals_feature.als_sensitivity_min = HID_DEFAULT_MIN_VALUE;\n\t\tals_feature.als_sensitivity_max = HID_DEFAULT_MAX_VALUE;\n\t\tmemcpy(feature_report, &als_feature, sizeof(als_feature));\n\t\treport_size = sizeof(als_feature);\n\t\tbreak;\n\tcase HPD_IDX:   \n\t\tget_common_features(&hpd_feature.common_property, report_id);\n\t\tmemcpy(feature_report, &hpd_feature, sizeof(hpd_feature));\n\t\treport_size = sizeof(hpd_feature);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\treturn report_size;\n}\n\nstatic void get_common_inputs(struct common_input_property *common, int report_id)\n{\n\tcommon->report_id = report_id;\n\tcommon->sensor_state = HID_USAGE_SENSOR_STATE_READY_ENUM;\n\tcommon->event_type = HID_USAGE_SENSOR_EVENT_DATA_UPDATED_ENUM;\n}\n\nstatic u8 get_input_report(u8 current_index, int sensor_idx, int report_id,\n\t\t\t   struct amd_input_data *in_data)\n{\n\tstruct amd_mp2_dev *privdata = container_of(in_data, struct amd_mp2_dev, in_data);\n\tu32 *sensor_virt_addr = in_data->sensor_virt_addr[current_index];\n\tu8 *input_report = in_data->input_report[current_index];\n\tu8 supported_input = privdata->mp2_acs & GENMASK(3, 0);\n\tstruct magno_input_report magno_input;\n\tstruct accel3_input_report acc_input;\n\tstruct gyro_input_report gyro_input;\n\tstruct hpd_input_report hpd_input;\n\tstruct als_input_report als_input;\n\tstruct hpd_status hpdstatus;\n\tu8 report_size = 0;\n\n\tif (!sensor_virt_addr || !input_report)\n\t\treturn report_size;\n\n\tswitch (sensor_idx) {\n\tcase accel_idx:  \n\t\tget_common_inputs(&acc_input.common_property, report_id);\n\t\tacc_input.in_accel_x_value = (int)sensor_virt_addr[0] / AMD_SFH_FW_MULTIPLIER;\n\t\tacc_input.in_accel_y_value = (int)sensor_virt_addr[1] / AMD_SFH_FW_MULTIPLIER;\n\t\tacc_input.in_accel_z_value =  (int)sensor_virt_addr[2] / AMD_SFH_FW_MULTIPLIER;\n\t\tmemcpy(input_report, &acc_input, sizeof(acc_input));\n\t\treport_size = sizeof(acc_input);\n\t\tbreak;\n\tcase gyro_idx:  \n\t\tget_common_inputs(&gyro_input.common_property, report_id);\n\t\tgyro_input.in_angel_x_value = (int)sensor_virt_addr[0] / AMD_SFH_FW_MULTIPLIER;\n\t\tgyro_input.in_angel_y_value = (int)sensor_virt_addr[1] / AMD_SFH_FW_MULTIPLIER;\n\t\tgyro_input.in_angel_z_value =  (int)sensor_virt_addr[2] / AMD_SFH_FW_MULTIPLIER;\n\t\tmemcpy(input_report, &gyro_input, sizeof(gyro_input));\n\t\treport_size = sizeof(gyro_input);\n\t\tbreak;\n\tcase mag_idx:  \n\t\tget_common_inputs(&magno_input.common_property, report_id);\n\t\tmagno_input.in_magno_x = (int)sensor_virt_addr[0] / AMD_SFH_FW_MULTIPLIER;\n\t\tmagno_input.in_magno_y = (int)sensor_virt_addr[1] / AMD_SFH_FW_MULTIPLIER;\n\t\tmagno_input.in_magno_z = (int)sensor_virt_addr[2] / AMD_SFH_FW_MULTIPLIER;\n\t\tmagno_input.in_magno_accuracy = (u16)sensor_virt_addr[3] / AMD_SFH_FW_MULTIPLIER;\n\t\tmemcpy(input_report, &magno_input, sizeof(magno_input));\n\t\treport_size = sizeof(magno_input);\n\t\tbreak;\n\tcase als_idx:  \n\tcase ACS_IDX:  \n\t\tget_common_inputs(&als_input.common_property, report_id);\n\t\t \n\t\tif (supported_input == V2_STATUS)\n\t\t\tals_input.illuminance_value =\n\t\t\t\treadl(privdata->mmio + AMD_C2P_MSG(5)) & ILLUMINANCE_MASK;\n\t\telse\n\t\t\tals_input.illuminance_value =\n\t\t\t\t(int)sensor_virt_addr[0] / AMD_SFH_FW_MULTIPLIER;\n\t\treport_size = sizeof(als_input);\n\t\tmemcpy(input_report, &als_input, sizeof(als_input));\n\t\tbreak;\n\tcase HPD_IDX:  \n\t\tget_common_inputs(&hpd_input.common_property, report_id);\n\t\thpdstatus.val = readl(privdata->mmio + AMD_C2P_MSG(4));\n\t\thpd_input.human_presence = hpdstatus.shpd.human_presence_actual;\n\t\treport_size = sizeof(hpd_input);\n\t\tmemcpy(input_report, &hpd_input, sizeof(hpd_input));\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn report_size;\n}\n\nvoid amd_sfh_set_desc_ops(struct amd_mp2_ops *mp2_ops)\n{\n\tmp2_ops->get_rep_desc = get_report_descriptor;\n\tmp2_ops->get_feat_rep = get_feature_report;\n\tmp2_ops->get_in_rep = get_input_report;\n\tmp2_ops->get_desc_sz = get_descr_sz;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}