{
  "module_name": "hid-creative-sb0540.c",
  "hash_id": "7f5519f3335294596c923282b8f7e01f47193c0cbe0f3947c934440d4be4bbd0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-creative-sb0540.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/hid.h>\n#include <linux/module.h>\n#include \"hid-ids.h\"\n\nMODULE_AUTHOR(\"Bastien Nocera <hadess@hadess.net>\");\nMODULE_DESCRIPTION(\"HID Creative SB0540 receiver\");\nMODULE_LICENSE(\"GPL\");\n\nstatic const unsigned short creative_sb0540_key_table[] = {\n\tKEY_POWER,\n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_RESERVED,\t\t \n\tKEY_MUTE,\n\tKEY_VOLUMEUP,\n\tKEY_VOLUMEDOWN,\n\tKEY_UP,\n\tKEY_LEFT,\n\tKEY_RIGHT,\n\tKEY_REWIND,\n\tKEY_OK,\n\tKEY_FASTFORWARD,\n\tKEY_DOWN,\n\tKEY_AGAIN,\t\t \n\tKEY_PLAY,\t\t \n\tKEY_ESC,\t\t \n\tKEY_RECORD,\n\tKEY_OPTION,\n\tKEY_MENU,\t\t \n\tKEY_PREVIOUS,\n\tKEY_PLAYPAUSE,\n\tKEY_NEXT,\n\tKEY_SLOW,\n\tKEY_STOP,\n\tKEY_NUMERIC_1,\n\tKEY_NUMERIC_2,\n\tKEY_NUMERIC_3,\n\tKEY_NUMERIC_4,\n\tKEY_NUMERIC_5,\n\tKEY_NUMERIC_6,\n\tKEY_NUMERIC_7,\n\tKEY_NUMERIC_8,\n\tKEY_NUMERIC_9,\n\tKEY_NUMERIC_0\n};\n\n \nstatic const unsigned short creative_sb0540_codes[] = {\n\t0x619E,\n\t0x916E,\n\t0x926D,\n\t0x936C,\n\t0x718E,\n\t0x946B,\n\t0x956A,\n\t0x8C73,\n\t0x9669,\n\t0x9768,\n\t0x9867,\n\t0x9966,\n\t0x9A65,\n\t0x6E91,\n\t0x629D,\n\t0x639C,\n\t0x7B84,\n\t0x6B94,\n\t0x728D,\n\t0x8778,\n\t0x817E,\n\t0x758A,\n\t0x8D72,\n\t0x8E71,\n\t0x8877,\n\t0x7C83,\n\t0x738C,\n\t0x827D,\n\t0x7689,\n\t0x7F80,\n\t0x7986,\n\t0x7A85,\n\t0x7D82,\n\t0x857A,\n\t0x8B74,\n\t0x8F70,\n\t0x906F,\n\t0x8A75,\n\t0x847B,\n\t0x7887,\n\t0x8976,\n\t0x837C,\n\t0x7788,\n\t0x807F\n};\n\nstruct creative_sb0540 {\n\tstruct input_dev *input_dev;\n\tstruct hid_device *hid;\n\tunsigned short keymap[ARRAY_SIZE(creative_sb0540_key_table)];\n};\n\nstatic inline u64 reverse(u64 data, int bits)\n{\n\tint i;\n\tu64 c;\n\n\tc = 0;\n\tfor (i = 0; i < bits; i++) {\n\t\tc |= (u64) (((data & (((u64) 1) << i)) ? 1 : 0))\n\t\t\t<< (bits - 1 - i);\n\t}\n\treturn (c);\n}\n\nstatic int get_key(struct creative_sb0540 *creative_sb0540, u64 keycode)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(creative_sb0540_codes); i++) {\n\t\tif (creative_sb0540_codes[i] == keycode)\n\t\t\treturn creative_sb0540->keymap[i];\n\t}\n\n\treturn 0;\n\n}\n\nstatic int creative_sb0540_raw_event(struct hid_device *hid,\n\tstruct hid_report *report, u8 *data, int len)\n{\n\tstruct creative_sb0540 *creative_sb0540 = hid_get_drvdata(hid);\n\tu64 code, main_code;\n\tint key;\n\n\tif (len != 6)\n\t\treturn 0;\n\n\t \n\tcode = reverse(data[5], 8);\n\tmain_code = (code << 8) + ((~code) & 0xff);\n\n\t \n\tmain_code = ((main_code & 0xff) << 8) +\n\t\t((main_code & 0xff00) >> 8);\n\n\tkey = get_key(creative_sb0540, main_code);\n\tif (key == 0 || key == KEY_RESERVED) {\n\t\thid_err(hid, \"Could not get a key for main_code %llX\\n\",\n\t\t\tmain_code);\n\t\treturn 0;\n\t}\n\n\tinput_report_key(creative_sb0540->input_dev, key, 1);\n\tinput_report_key(creative_sb0540->input_dev, key, 0);\n\tinput_sync(creative_sb0540->input_dev);\n\n\t \n\treturn 0;\n}\n\nstatic int creative_sb0540_input_configured(struct hid_device *hid,\n\t\tstruct hid_input *hidinput)\n{\n\tstruct input_dev *input_dev = hidinput->input;\n\tstruct creative_sb0540 *creative_sb0540 = hid_get_drvdata(hid);\n\tint i;\n\n\tcreative_sb0540->input_dev = input_dev;\n\n\tinput_dev->keycode = creative_sb0540->keymap;\n\tinput_dev->keycodesize = sizeof(unsigned short);\n\tinput_dev->keycodemax = ARRAY_SIZE(creative_sb0540->keymap);\n\n\tinput_dev->evbit[0] = BIT(EV_KEY) | BIT(EV_REP);\n\n\tmemcpy(creative_sb0540->keymap, creative_sb0540_key_table,\n\t\tsizeof(creative_sb0540->keymap));\n\tfor (i = 0; i < ARRAY_SIZE(creative_sb0540_key_table); i++)\n\t\tset_bit(creative_sb0540->keymap[i], input_dev->keybit);\n\tclear_bit(KEY_RESERVED, input_dev->keybit);\n\n\treturn 0;\n}\n\nstatic int creative_sb0540_input_mapping(struct hid_device *hid,\n\t\tstruct hid_input *hi, struct hid_field *field,\n\t\tstruct hid_usage *usage, unsigned long **bit, int *max)\n{\n\t \n\treturn -1;\n}\n\nstatic int creative_sb0540_probe(struct hid_device *hid,\n\t\tconst struct hid_device_id *id)\n{\n\tint ret;\n\tstruct creative_sb0540 *creative_sb0540;\n\n\tcreative_sb0540 = devm_kzalloc(&hid->dev,\n\t\tsizeof(struct creative_sb0540), GFP_KERNEL);\n\n\tif (!creative_sb0540)\n\t\treturn -ENOMEM;\n\n\tcreative_sb0540->hid = hid;\n\n\t \n\thid->quirks |= HID_QUIRK_HIDINPUT_FORCE;\n\n\thid_set_drvdata(hid, creative_sb0540);\n\n\tret = hid_parse(hid);\n\tif (ret) {\n\t\thid_err(hid, \"parse failed\\n\");\n\t\treturn ret;\n\t}\n\n\tret = hid_hw_start(hid, HID_CONNECT_DEFAULT);\n\tif (ret) {\n\t\thid_err(hid, \"hw start failed\\n\");\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct hid_device_id creative_sb0540_devices[] = {\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_CREATIVELABS, USB_DEVICE_ID_CREATIVE_SB0540) },\n\t{ }\n};\nMODULE_DEVICE_TABLE(hid, creative_sb0540_devices);\n\nstatic struct hid_driver creative_sb0540_driver = {\n\t.name = \"creative-sb0540\",\n\t.id_table = creative_sb0540_devices,\n\t.raw_event = creative_sb0540_raw_event,\n\t.input_configured = creative_sb0540_input_configured,\n\t.probe = creative_sb0540_probe,\n\t.input_mapping = creative_sb0540_input_mapping,\n};\nmodule_hid_driver(creative_sb0540_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}