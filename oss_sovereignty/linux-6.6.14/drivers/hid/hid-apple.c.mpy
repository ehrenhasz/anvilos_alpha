{
  "module_name": "hid-apple.c",
  "hash_id": "ba923946167ba8cd5800173459af2f821514a9a19800a2988e0d0a955677b64a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-apple.c",
  "human_readable_source": "\n \n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/device.h>\n#include <linux/hid.h>\n#include <linux/jiffies.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/timer.h>\n#include <linux/string.h>\n#include <linux/leds.h>\n\n#include \"hid-ids.h\"\n\n#define APPLE_RDESC_JIS\t\tBIT(0)\n#define APPLE_IGNORE_MOUSE\tBIT(1)\n#define APPLE_HAS_FN\t\tBIT(2)\n \n#define APPLE_ISO_TILDE_QUIRK\tBIT(4)\n#define APPLE_MIGHTYMOUSE\tBIT(5)\n#define APPLE_INVERT_HWHEEL\tBIT(6)\n \n#define APPLE_NUMLOCK_EMULATION\tBIT(8)\n#define APPLE_RDESC_BATTERY\tBIT(9)\n#define APPLE_BACKLIGHT_CTL\tBIT(10)\n#define APPLE_IS_NON_APPLE\tBIT(11)\n\n#define APPLE_FLAG_FKEY\t\t0x01\n\n#define HID_COUNTRY_INTERNATIONAL_ISO\t13\n#define APPLE_BATTERY_TIMEOUT_MS\t60000\n\nstatic unsigned int fnmode = 3;\nmodule_param(fnmode, uint, 0644);\nMODULE_PARM_DESC(fnmode, \"Mode of fn key on Apple keyboards (0 = disabled, \"\n\t\t\"1 = fkeyslast, 2 = fkeysfirst, [3] = auto)\");\n\nstatic int iso_layout = -1;\nmodule_param(iso_layout, int, 0644);\nMODULE_PARM_DESC(iso_layout, \"Swap the backtick/tilde and greater-than/less-than keys. \"\n\t\t\"([-1] = auto, 0 = disabled, 1 = enabled)\");\n\nstatic unsigned int swap_opt_cmd;\nmodule_param(swap_opt_cmd, uint, 0644);\nMODULE_PARM_DESC(swap_opt_cmd, \"Swap the Option (\\\"Alt\\\") and Command (\\\"Flag\\\") keys. \"\n\t\t\"(For people who want to keep Windows PC keyboard muscle memory. \"\n\t\t\"[0] = as-is, Mac layout. 1 = swapped, Windows layout., 2 = swapped, Swap only left side)\");\n\nstatic unsigned int swap_ctrl_cmd;\nmodule_param(swap_ctrl_cmd, uint, 0644);\nMODULE_PARM_DESC(swap_ctrl_cmd, \"Swap the Control (\\\"Ctrl\\\") and Command (\\\"Flag\\\") keys. \"\n\t\t\"(For people who are used to Mac shortcuts involving Command instead of Control. \"\n\t\t\"[0] = No change. 1 = Swapped.)\");\n\nstatic unsigned int swap_fn_leftctrl;\nmodule_param(swap_fn_leftctrl, uint, 0644);\nMODULE_PARM_DESC(swap_fn_leftctrl, \"Swap the Fn and left Control keys. \"\n\t\t\"(For people who want to keep PC keyboard muscle memory. \"\n\t\t\"[0] = as-is, Mac layout, 1 = swapped, PC layout)\");\n\nstruct apple_non_apple_keyboard {\n\tchar *name;\n};\n\nstruct apple_sc_backlight {\n\tstruct led_classdev cdev;\n\tstruct hid_device *hdev;\n\tunsigned short backlight_off, backlight_on_min, backlight_on_max;\n};\n\nstruct apple_sc {\n\tstruct hid_device *hdev;\n\tunsigned long quirks;\n\tunsigned int fn_on;\n\tunsigned int fn_found;\n\tDECLARE_BITMAP(pressed_numlock, KEY_CNT);\n\tstruct timer_list battery_timer;\n\tstruct apple_sc_backlight *backlight;\n};\n\nstruct apple_key_translation {\n\tu16 from;\n\tu16 to;\n\tu8 flags;\n};\n\nstatic const struct apple_key_translation magic_keyboard_alu_fn_keys[] = {\n\t{ KEY_BACKSPACE, KEY_DELETE },\n\t{ KEY_ENTER,\tKEY_INSERT },\n\t{ KEY_F1,\tKEY_BRIGHTNESSDOWN, APPLE_FLAG_FKEY },\n\t{ KEY_F2,\tKEY_BRIGHTNESSUP,   APPLE_FLAG_FKEY },\n\t{ KEY_F3,\tKEY_SCALE,          APPLE_FLAG_FKEY },\n\t{ KEY_F4,\tKEY_DASHBOARD,      APPLE_FLAG_FKEY },\n\t{ KEY_F6,\tKEY_NUMLOCK,        APPLE_FLAG_FKEY },\n\t{ KEY_F7,\tKEY_PREVIOUSSONG,   APPLE_FLAG_FKEY },\n\t{ KEY_F8,\tKEY_PLAYPAUSE,      APPLE_FLAG_FKEY },\n\t{ KEY_F9,\tKEY_NEXTSONG,       APPLE_FLAG_FKEY },\n\t{ KEY_F10,\tKEY_MUTE,           APPLE_FLAG_FKEY },\n\t{ KEY_F11,\tKEY_VOLUMEDOWN,     APPLE_FLAG_FKEY },\n\t{ KEY_F12,\tKEY_VOLUMEUP,       APPLE_FLAG_FKEY },\n\t{ KEY_UP,\tKEY_PAGEUP },\n\t{ KEY_DOWN,\tKEY_PAGEDOWN },\n\t{ KEY_LEFT,\tKEY_HOME },\n\t{ KEY_RIGHT,\tKEY_END },\n\t{ }\n};\n\nstatic const struct apple_key_translation magic_keyboard_2015_fn_keys[] = {\n\t{ KEY_BACKSPACE, KEY_DELETE },\n\t{ KEY_ENTER,\tKEY_INSERT },\n\t{ KEY_F1,\tKEY_BRIGHTNESSDOWN, APPLE_FLAG_FKEY },\n\t{ KEY_F2,\tKEY_BRIGHTNESSUP,   APPLE_FLAG_FKEY },\n\t{ KEY_F3,\tKEY_SCALE,          APPLE_FLAG_FKEY },\n\t{ KEY_F4,\tKEY_DASHBOARD,      APPLE_FLAG_FKEY },\n\t{ KEY_F7,\tKEY_PREVIOUSSONG,   APPLE_FLAG_FKEY },\n\t{ KEY_F8,\tKEY_PLAYPAUSE,      APPLE_FLAG_FKEY },\n\t{ KEY_F9,\tKEY_NEXTSONG,       APPLE_FLAG_FKEY },\n\t{ KEY_F10,\tKEY_MUTE,           APPLE_FLAG_FKEY },\n\t{ KEY_F11,\tKEY_VOLUMEDOWN,     APPLE_FLAG_FKEY },\n\t{ KEY_F12,\tKEY_VOLUMEUP,       APPLE_FLAG_FKEY },\n\t{ KEY_UP,\tKEY_PAGEUP },\n\t{ KEY_DOWN,\tKEY_PAGEDOWN },\n\t{ KEY_LEFT,\tKEY_HOME },\n\t{ KEY_RIGHT,\tKEY_END },\n\t{ }\n};\n\nstruct apple_backlight_config_report {\n\tu8 report_id;\n\tu8 version;\n\tu16 backlight_off, backlight_on_min, backlight_on_max;\n};\n\nstruct apple_backlight_set_report {\n\tu8 report_id;\n\tu8 version;\n\tu16 backlight;\n\tu16 rate;\n};\n\n\nstatic const struct apple_key_translation apple2021_fn_keys[] = {\n\t{ KEY_BACKSPACE, KEY_DELETE },\n\t{ KEY_ENTER,\tKEY_INSERT },\n\t{ KEY_F1,\tKEY_BRIGHTNESSDOWN, APPLE_FLAG_FKEY },\n\t{ KEY_F2,\tKEY_BRIGHTNESSUP,   APPLE_FLAG_FKEY },\n\t{ KEY_F3,\tKEY_SCALE,          APPLE_FLAG_FKEY },\n\t{ KEY_F4,\tKEY_SEARCH,         APPLE_FLAG_FKEY },\n\t{ KEY_F5,\tKEY_MICMUTE,        APPLE_FLAG_FKEY },\n\t{ KEY_F6,\tKEY_SLEEP,          APPLE_FLAG_FKEY },\n\t{ KEY_F7,\tKEY_PREVIOUSSONG,   APPLE_FLAG_FKEY },\n\t{ KEY_F8,\tKEY_PLAYPAUSE,      APPLE_FLAG_FKEY },\n\t{ KEY_F9,\tKEY_NEXTSONG,       APPLE_FLAG_FKEY },\n\t{ KEY_F10,\tKEY_MUTE,           APPLE_FLAG_FKEY },\n\t{ KEY_F11,\tKEY_VOLUMEDOWN,     APPLE_FLAG_FKEY },\n\t{ KEY_F12,\tKEY_VOLUMEUP,       APPLE_FLAG_FKEY },\n\t{ KEY_UP,\tKEY_PAGEUP },\n\t{ KEY_DOWN,\tKEY_PAGEDOWN },\n\t{ KEY_LEFT,\tKEY_HOME },\n\t{ KEY_RIGHT,\tKEY_END },\n\t{ }\n};\n\nstatic const struct apple_key_translation macbookair_fn_keys[] = {\n\t{ KEY_BACKSPACE, KEY_DELETE },\n\t{ KEY_ENTER,\tKEY_INSERT },\n\t{ KEY_F1,\tKEY_BRIGHTNESSDOWN, APPLE_FLAG_FKEY },\n\t{ KEY_F2,\tKEY_BRIGHTNESSUP,   APPLE_FLAG_FKEY },\n\t{ KEY_F3,\tKEY_SCALE,          APPLE_FLAG_FKEY },\n\t{ KEY_F4,\tKEY_DASHBOARD,      APPLE_FLAG_FKEY },\n\t{ KEY_F6,\tKEY_PREVIOUSSONG,   APPLE_FLAG_FKEY },\n\t{ KEY_F7,\tKEY_PLAYPAUSE,      APPLE_FLAG_FKEY },\n\t{ KEY_F8,\tKEY_NEXTSONG,       APPLE_FLAG_FKEY },\n\t{ KEY_F9,\tKEY_MUTE,           APPLE_FLAG_FKEY },\n\t{ KEY_F10,\tKEY_VOLUMEDOWN,     APPLE_FLAG_FKEY },\n\t{ KEY_F11,\tKEY_VOLUMEUP,       APPLE_FLAG_FKEY },\n\t{ KEY_F12,\tKEY_EJECTCD,        APPLE_FLAG_FKEY },\n\t{ KEY_UP,\tKEY_PAGEUP },\n\t{ KEY_DOWN,\tKEY_PAGEDOWN },\n\t{ KEY_LEFT,\tKEY_HOME },\n\t{ KEY_RIGHT,\tKEY_END },\n\t{ }\n};\n\nstatic const struct apple_key_translation macbookpro_no_esc_fn_keys[] = {\n\t{ KEY_BACKSPACE, KEY_DELETE },\n\t{ KEY_ENTER,\tKEY_INSERT },\n\t{ KEY_GRAVE,\tKEY_ESC },\n\t{ KEY_1,\tKEY_F1 },\n\t{ KEY_2,\tKEY_F2 },\n\t{ KEY_3,\tKEY_F3 },\n\t{ KEY_4,\tKEY_F4 },\n\t{ KEY_5,\tKEY_F5 },\n\t{ KEY_6,\tKEY_F6 },\n\t{ KEY_7,\tKEY_F7 },\n\t{ KEY_8,\tKEY_F8 },\n\t{ KEY_9,\tKEY_F9 },\n\t{ KEY_0,\tKEY_F10 },\n\t{ KEY_MINUS,\tKEY_F11 },\n\t{ KEY_EQUAL,\tKEY_F12 },\n\t{ KEY_UP,\tKEY_PAGEUP },\n\t{ KEY_DOWN,\tKEY_PAGEDOWN },\n\t{ KEY_LEFT,\tKEY_HOME },\n\t{ KEY_RIGHT,\tKEY_END },\n\t{ }\n};\n\nstatic const struct apple_key_translation macbookpro_dedicated_esc_fn_keys[] = {\n\t{ KEY_BACKSPACE, KEY_DELETE },\n\t{ KEY_ENTER,\tKEY_INSERT },\n\t{ KEY_1,\tKEY_F1 },\n\t{ KEY_2,\tKEY_F2 },\n\t{ KEY_3,\tKEY_F3 },\n\t{ KEY_4,\tKEY_F4 },\n\t{ KEY_5,\tKEY_F5 },\n\t{ KEY_6,\tKEY_F6 },\n\t{ KEY_7,\tKEY_F7 },\n\t{ KEY_8,\tKEY_F8 },\n\t{ KEY_9,\tKEY_F9 },\n\t{ KEY_0,\tKEY_F10 },\n\t{ KEY_MINUS,\tKEY_F11 },\n\t{ KEY_EQUAL,\tKEY_F12 },\n\t{ KEY_UP,\tKEY_PAGEUP },\n\t{ KEY_DOWN,\tKEY_PAGEDOWN },\n\t{ KEY_LEFT,\tKEY_HOME },\n\t{ KEY_RIGHT,\tKEY_END },\n\t{ }\n};\n\nstatic const struct apple_key_translation apple_fn_keys[] = {\n\t{ KEY_BACKSPACE, KEY_DELETE },\n\t{ KEY_ENTER,\tKEY_INSERT },\n\t{ KEY_F1,\tKEY_BRIGHTNESSDOWN, APPLE_FLAG_FKEY },\n\t{ KEY_F2,\tKEY_BRIGHTNESSUP,   APPLE_FLAG_FKEY },\n\t{ KEY_F3,\tKEY_SCALE,          APPLE_FLAG_FKEY },\n\t{ KEY_F4,\tKEY_DASHBOARD,      APPLE_FLAG_FKEY },\n\t{ KEY_F5,\tKEY_KBDILLUMDOWN,   APPLE_FLAG_FKEY },\n\t{ KEY_F6,\tKEY_KBDILLUMUP,     APPLE_FLAG_FKEY },\n\t{ KEY_F7,\tKEY_PREVIOUSSONG,   APPLE_FLAG_FKEY },\n\t{ KEY_F8,\tKEY_PLAYPAUSE,      APPLE_FLAG_FKEY },\n\t{ KEY_F9,\tKEY_NEXTSONG,       APPLE_FLAG_FKEY },\n\t{ KEY_F10,\tKEY_MUTE,           APPLE_FLAG_FKEY },\n\t{ KEY_F11,\tKEY_VOLUMEDOWN,     APPLE_FLAG_FKEY },\n\t{ KEY_F12,\tKEY_VOLUMEUP,       APPLE_FLAG_FKEY },\n\t{ KEY_UP,\tKEY_PAGEUP },\n\t{ KEY_DOWN,\tKEY_PAGEDOWN },\n\t{ KEY_LEFT,\tKEY_HOME },\n\t{ KEY_RIGHT,\tKEY_END },\n\t{ }\n};\n\nstatic const struct apple_key_translation powerbook_fn_keys[] = {\n\t{ KEY_BACKSPACE, KEY_DELETE },\n\t{ KEY_F1,\tKEY_BRIGHTNESSDOWN,     APPLE_FLAG_FKEY },\n\t{ KEY_F2,\tKEY_BRIGHTNESSUP,       APPLE_FLAG_FKEY },\n\t{ KEY_F3,\tKEY_MUTE,               APPLE_FLAG_FKEY },\n\t{ KEY_F4,\tKEY_VOLUMEDOWN,         APPLE_FLAG_FKEY },\n\t{ KEY_F5,\tKEY_VOLUMEUP,           APPLE_FLAG_FKEY },\n\t{ KEY_F6,\tKEY_NUMLOCK,            APPLE_FLAG_FKEY },\n\t{ KEY_F7,\tKEY_SWITCHVIDEOMODE,    APPLE_FLAG_FKEY },\n\t{ KEY_F8,\tKEY_KBDILLUMTOGGLE,     APPLE_FLAG_FKEY },\n\t{ KEY_F9,\tKEY_KBDILLUMDOWN,       APPLE_FLAG_FKEY },\n\t{ KEY_F10,\tKEY_KBDILLUMUP,         APPLE_FLAG_FKEY },\n\t{ KEY_UP,\tKEY_PAGEUP },\n\t{ KEY_DOWN,\tKEY_PAGEDOWN },\n\t{ KEY_LEFT,\tKEY_HOME },\n\t{ KEY_RIGHT,\tKEY_END },\n\t{ }\n};\n\nstatic const struct apple_key_translation powerbook_numlock_keys[] = {\n\t{ KEY_J,\tKEY_KP1 },\n\t{ KEY_K,\tKEY_KP2 },\n\t{ KEY_L,\tKEY_KP3 },\n\t{ KEY_U,\tKEY_KP4 },\n\t{ KEY_I,\tKEY_KP5 },\n\t{ KEY_O,\tKEY_KP6 },\n\t{ KEY_7,\tKEY_KP7 },\n\t{ KEY_8,\tKEY_KP8 },\n\t{ KEY_9,\tKEY_KP9 },\n\t{ KEY_M,\tKEY_KP0 },\n\t{ KEY_DOT,\tKEY_KPDOT },\n\t{ KEY_SLASH,\tKEY_KPPLUS },\n\t{ KEY_SEMICOLON, KEY_KPMINUS },\n\t{ KEY_P,\tKEY_KPASTERISK },\n\t{ KEY_MINUS,\tKEY_KPEQUAL },\n\t{ KEY_0,\tKEY_KPSLASH },\n\t{ KEY_F6,\tKEY_NUMLOCK },\n\t{ KEY_KPENTER,\tKEY_KPENTER },\n\t{ KEY_BACKSPACE, KEY_BACKSPACE },\n\t{ }\n};\n\nstatic const struct apple_key_translation apple_iso_keyboard[] = {\n\t{ KEY_GRAVE,\tKEY_102ND },\n\t{ KEY_102ND,\tKEY_GRAVE },\n\t{ }\n};\n\nstatic const struct apple_key_translation swapped_option_cmd_keys[] = {\n\t{ KEY_LEFTALT,\tKEY_LEFTMETA },\n\t{ KEY_LEFTMETA,\tKEY_LEFTALT },\n\t{ KEY_RIGHTALT,\tKEY_RIGHTMETA },\n\t{ KEY_RIGHTMETA, KEY_RIGHTALT },\n\t{ }\n};\n\nstatic const struct apple_key_translation swapped_option_cmd_left_keys[] = {\n\t{ KEY_LEFTALT,\tKEY_LEFTMETA },\n\t{ KEY_LEFTMETA,\tKEY_LEFTALT },\n\t{ }\n};\n\nstatic const struct apple_key_translation swapped_ctrl_cmd_keys[] = {\n\t{ KEY_LEFTCTRL,\tKEY_LEFTMETA },\n\t{ KEY_LEFTMETA,\tKEY_LEFTCTRL },\n\t{ KEY_RIGHTCTRL, KEY_RIGHTMETA },\n\t{ KEY_RIGHTMETA, KEY_RIGHTCTRL },\n\t{ }\n};\n\nstatic const struct apple_key_translation swapped_fn_leftctrl_keys[] = {\n\t{ KEY_FN, KEY_LEFTCTRL },\n\t{ KEY_LEFTCTRL, KEY_FN },\n\t{ }\n};\n\nstatic const struct apple_non_apple_keyboard non_apple_keyboards[] = {\n\t{ \"SONiX USB DEVICE\" },\n\t{ \"Keychron\" },\n\t{ \"AONE\" },\n\t{ \"GANSS\" },\n\t{ \"Hailuck\" },\n\t{ \"Jamesdonkey\" },\n\t{ \"A3R\" },\n};\n\nstatic bool apple_is_non_apple_keyboard(struct hid_device *hdev)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(non_apple_keyboards); i++) {\n\t\tchar *non_apple = non_apple_keyboards[i].name;\n\n\t\tif (strncmp(hdev->name, non_apple, strlen(non_apple)) == 0)\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic inline void apple_setup_key_translation(struct input_dev *input,\n\t\tconst struct apple_key_translation *table)\n{\n\tconst struct apple_key_translation *trans;\n\n\tfor (trans = table; trans->from; trans++)\n\t\tset_bit(trans->to, input->keybit);\n}\n\nstatic const struct apple_key_translation *apple_find_translation(\n\t\tconst struct apple_key_translation *table, u16 from)\n{\n\tconst struct apple_key_translation *trans;\n\n\t \n\tfor (trans = table; trans->from; trans++)\n\t\tif (trans->from == from)\n\t\t\treturn trans;\n\n\treturn NULL;\n}\n\nstatic void input_event_with_scancode(struct input_dev *input,\n\t\t__u8 type, __u16 code, unsigned int hid, __s32 value)\n{\n\tif (type == EV_KEY &&\n\t    (!test_bit(code, input->key)) == value)\n\t\tinput_event(input, EV_MSC, MSC_SCAN, hid);\n\tinput_event(input, type, code, value);\n}\n\nstatic int hidinput_apple_event(struct hid_device *hid, struct input_dev *input,\n\t\tstruct hid_usage *usage, __s32 value)\n{\n\tstruct apple_sc *asc = hid_get_drvdata(hid);\n\tconst struct apple_key_translation *trans, *table;\n\tbool do_translate;\n\tu16 code = usage->code;\n\tunsigned int real_fnmode;\n\n\tif (fnmode == 3) {\n\t\treal_fnmode = (asc->quirks & APPLE_IS_NON_APPLE) ? 2 : 1;\n\t} else {\n\t\treal_fnmode = fnmode;\n\t}\n\n\tif (swap_fn_leftctrl) {\n\t\ttrans = apple_find_translation(swapped_fn_leftctrl_keys, code);\n\n\t\tif (trans)\n\t\t\tcode = trans->to;\n\t}\n\n\tif (iso_layout > 0 || (iso_layout < 0 && (asc->quirks & APPLE_ISO_TILDE_QUIRK) &&\n\t\t\thid->country == HID_COUNTRY_INTERNATIONAL_ISO)) {\n\t\ttrans = apple_find_translation(apple_iso_keyboard, code);\n\n\t\tif (trans)\n\t\t\tcode = trans->to;\n\t}\n\n\tif (swap_opt_cmd) {\n\t\tif (swap_opt_cmd == 2)\n\t\t\ttrans = apple_find_translation(swapped_option_cmd_left_keys, code);\n\t\telse\n\t\t\ttrans = apple_find_translation(swapped_option_cmd_keys, code);\n\n\t\tif (trans)\n\t\t\tcode = trans->to;\n\t}\n\n\tif (swap_ctrl_cmd) {\n\t\ttrans = apple_find_translation(swapped_ctrl_cmd_keys, code);\n\n\t\tif (trans)\n\t\t\tcode = trans->to;\n\t}\n\n\tif (code == KEY_FN)\n\t\tasc->fn_on = !!value;\n\n\tif (real_fnmode) {\n\t\tif (hid->product == USB_DEVICE_ID_APPLE_ALU_WIRELESS_ANSI ||\n\t\t    hid->product == USB_DEVICE_ID_APPLE_ALU_WIRELESS_ISO ||\n\t\t    hid->product == USB_DEVICE_ID_APPLE_ALU_WIRELESS_JIS ||\n\t\t    hid->product == USB_DEVICE_ID_APPLE_ALU_WIRELESS_2009_ANSI ||\n\t\t    hid->product == USB_DEVICE_ID_APPLE_ALU_WIRELESS_2009_ISO ||\n\t\t    hid->product == USB_DEVICE_ID_APPLE_ALU_WIRELESS_2009_JIS ||\n\t\t    hid->product == USB_DEVICE_ID_APPLE_ALU_WIRELESS_2011_ANSI ||\n\t\t    hid->product == USB_DEVICE_ID_APPLE_ALU_WIRELESS_2011_ISO ||\n\t\t    hid->product == USB_DEVICE_ID_APPLE_ALU_WIRELESS_2011_JIS)\n\t\t\ttable = magic_keyboard_alu_fn_keys;\n\t\telse if (hid->product == USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_2015 ||\n\t\t\t hid->product == USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_NUMPAD_2015)\n\t\t\ttable = magic_keyboard_2015_fn_keys;\n\t\telse if (hid->product == USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_2021 ||\n\t\t\t hid->product == USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_FINGERPRINT_2021 ||\n\t\t\t hid->product == USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_NUMPAD_2021)\n\t\t\ttable = apple2021_fn_keys;\n\t\telse if (hid->product == USB_DEVICE_ID_APPLE_WELLSPRINGT2_J132 ||\n\t\t\t hid->product == USB_DEVICE_ID_APPLE_WELLSPRINGT2_J680 ||\n\t\t\t hid->product == USB_DEVICE_ID_APPLE_WELLSPRINGT2_J213)\n\t\t\t\ttable = macbookpro_no_esc_fn_keys;\n\t\telse if (hid->product == USB_DEVICE_ID_APPLE_WELLSPRINGT2_J214K ||\n\t\t\t hid->product == USB_DEVICE_ID_APPLE_WELLSPRINGT2_J223 ||\n\t\t\t hid->product == USB_DEVICE_ID_APPLE_WELLSPRINGT2_J152F)\n\t\t\t\ttable = macbookpro_dedicated_esc_fn_keys;\n\t\telse if (hid->product == USB_DEVICE_ID_APPLE_WELLSPRINGT2_J140K ||\n\t\t\t hid->product == USB_DEVICE_ID_APPLE_WELLSPRINGT2_J230K)\n\t\t\t\ttable = apple_fn_keys;\n\t\telse if (hid->product >= USB_DEVICE_ID_APPLE_WELLSPRING4_ANSI &&\n\t\t\t\thid->product <= USB_DEVICE_ID_APPLE_WELLSPRING4A_JIS)\n\t\t\ttable = macbookair_fn_keys;\n\t\telse if (hid->product < 0x21d || hid->product >= 0x300)\n\t\t\ttable = powerbook_fn_keys;\n\t\telse\n\t\t\ttable = apple_fn_keys;\n\n\t\ttrans = apple_find_translation(table, code);\n\n\t\tif (trans) {\n\t\t\tbool from_is_set = test_bit(trans->from, input->key);\n\t\t\tbool to_is_set = test_bit(trans->to, input->key);\n\n\t\t\tif (from_is_set)\n\t\t\t\tcode = trans->from;\n\t\t\telse if (to_is_set)\n\t\t\t\tcode = trans->to;\n\n\t\t\tif (!(from_is_set || to_is_set)) {\n\t\t\t\tif (trans->flags & APPLE_FLAG_FKEY) {\n\t\t\t\t\tswitch (real_fnmode) {\n\t\t\t\t\tcase 1:\n\t\t\t\t\t\tdo_translate = !asc->fn_on;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 2:\n\t\t\t\t\t\tdo_translate = asc->fn_on;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\t \n\t\t\t\t\t\tdo_translate = false;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tdo_translate = asc->fn_on;\n\t\t\t\t}\n\n\t\t\t\tif (do_translate)\n\t\t\t\t\tcode = trans->to;\n\t\t\t}\n\t\t}\n\n\t\tif (asc->quirks & APPLE_NUMLOCK_EMULATION &&\n\t\t\t\t(test_bit(code, asc->pressed_numlock) ||\n\t\t\t\ttest_bit(LED_NUML, input->led))) {\n\t\t\ttrans = apple_find_translation(powerbook_numlock_keys, code);\n\n\t\t\tif (trans) {\n\t\t\t\tif (value)\n\t\t\t\t\tset_bit(code, asc->pressed_numlock);\n\t\t\t\telse\n\t\t\t\t\tclear_bit(code, asc->pressed_numlock);\n\n\t\t\t\tcode = trans->to;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (usage->code != code) {\n\t\tinput_event_with_scancode(input, usage->type, code, usage->hid, value);\n\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\nstatic int apple_event(struct hid_device *hdev, struct hid_field *field,\n\t\tstruct hid_usage *usage, __s32 value)\n{\n\tstruct apple_sc *asc = hid_get_drvdata(hdev);\n\n\tif (!(hdev->claimed & HID_CLAIMED_INPUT) || !field->hidinput ||\n\t\t\t!usage->type)\n\t\treturn 0;\n\n\tif ((asc->quirks & APPLE_INVERT_HWHEEL) &&\n\t\t\tusage->code == REL_HWHEEL) {\n\t\tinput_event_with_scancode(field->hidinput->input, usage->type,\n\t\t\t\tusage->code, usage->hid, -value);\n\t\treturn 1;\n\t}\n\n\tif ((asc->quirks & APPLE_HAS_FN) &&\n\t\t\thidinput_apple_event(hdev, field->hidinput->input,\n\t\t\t\tusage, value))\n\t\treturn 1;\n\n\n\treturn 0;\n}\n\nstatic int apple_fetch_battery(struct hid_device *hdev)\n{\n#ifdef CONFIG_HID_BATTERY_STRENGTH\n\tstruct apple_sc *asc = hid_get_drvdata(hdev);\n\tstruct hid_report_enum *report_enum;\n\tstruct hid_report *report;\n\n\tif (!(asc->quirks & APPLE_RDESC_BATTERY) || !hdev->battery)\n\t\treturn -1;\n\n\treport_enum = &hdev->report_enum[hdev->battery_report_type];\n\treport = report_enum->report_id_hash[hdev->battery_report_id];\n\n\tif (!report || report->maxfield < 1)\n\t\treturn -1;\n\n\tif (hdev->battery_capacity == hdev->battery_max)\n\t\treturn -1;\n\n\thid_hw_request(hdev, report, HID_REQ_GET_REPORT);\n\treturn 0;\n#else\n\treturn -1;\n#endif\n}\n\nstatic void apple_battery_timer_tick(struct timer_list *t)\n{\n\tstruct apple_sc *asc = from_timer(asc, t, battery_timer);\n\tstruct hid_device *hdev = asc->hdev;\n\n\tif (apple_fetch_battery(hdev) == 0) {\n\t\tmod_timer(&asc->battery_timer,\n\t\t\t  jiffies + msecs_to_jiffies(APPLE_BATTERY_TIMEOUT_MS));\n\t}\n}\n\n \nstatic __u8 *apple_report_fixup(struct hid_device *hdev, __u8 *rdesc,\n\t\tunsigned int *rsize)\n{\n\tstruct apple_sc *asc = hid_get_drvdata(hdev);\n\n\tif(*rsize >=71 && rdesc[70] == 0x65 && rdesc[64] == 0x65) {\n\t\thid_info(hdev,\n\t\t\t \"fixing up Magic Keyboard JIS report descriptor\\n\");\n\t\trdesc[64] = rdesc[70] = 0xe7;\n\t}\n\n\tif ((asc->quirks & APPLE_RDESC_JIS) && *rsize >= 60 &&\n\t\t\trdesc[53] == 0x65 && rdesc[59] == 0x65) {\n\t\thid_info(hdev,\n\t\t\t \"fixing up MacBook JIS keyboard report descriptor\\n\");\n\t\trdesc[53] = rdesc[59] = 0xe7;\n\t}\n\n\t \n\tif ((asc->quirks & APPLE_RDESC_BATTERY) && *rsize == 83 &&\n\t    rdesc[46] == 0x84 && rdesc[58] == 0x85) {\n\t\thid_info(hdev,\n\t\t\t \"fixing up Magic Keyboard battery report descriptor\\n\");\n\t\t*rsize = *rsize - 1;\n\t\trdesc = kmemdup(rdesc + 1, *rsize, GFP_KERNEL);\n\t\tif (!rdesc)\n\t\t\treturn NULL;\n\n\t\trdesc[0] = 0x05;\n\t\trdesc[1] = 0x01;\n\t\trdesc[2] = 0x09;\n\t\trdesc[3] = 0x06;\n\t}\n\n\treturn rdesc;\n}\n\nstatic void apple_setup_input(struct input_dev *input)\n{\n\tset_bit(KEY_NUMLOCK, input->keybit);\n\n\t \n\tapple_setup_key_translation(input, apple_fn_keys);\n\tapple_setup_key_translation(input, powerbook_fn_keys);\n\tapple_setup_key_translation(input, powerbook_numlock_keys);\n\tapple_setup_key_translation(input, apple_iso_keyboard);\n\tapple_setup_key_translation(input, magic_keyboard_alu_fn_keys);\n\tapple_setup_key_translation(input, magic_keyboard_2015_fn_keys);\n\tapple_setup_key_translation(input, apple2021_fn_keys);\n\tapple_setup_key_translation(input, macbookpro_no_esc_fn_keys);\n\tapple_setup_key_translation(input, macbookpro_dedicated_esc_fn_keys);\n}\n\nstatic int apple_input_mapping(struct hid_device *hdev, struct hid_input *hi,\n\t\tstruct hid_field *field, struct hid_usage *usage,\n\t\tunsigned long **bit, int *max)\n{\n\tstruct apple_sc *asc = hid_get_drvdata(hdev);\n\n\tif (usage->hid == (HID_UP_CUSTOM | 0x0003) ||\n\t\t\tusage->hid == (HID_UP_MSVENDOR | 0x0003) ||\n\t\t\tusage->hid == (HID_UP_HPVENDOR2 | 0x0003)) {\n\t\t \n\t\tset_bit(EV_REP, hi->input->evbit);\n\t\thid_map_usage_clear(hi, usage, bit, max, EV_KEY, KEY_FN);\n\t\tasc->fn_found = true;\n\t\tapple_setup_input(hi->input);\n\t\treturn 1;\n\t}\n\n\t \n\treturn 0;\n}\n\nstatic int apple_input_mapped(struct hid_device *hdev, struct hid_input *hi,\n\t\tstruct hid_field *field, struct hid_usage *usage,\n\t\tunsigned long **bit, int *max)\n{\n\tstruct apple_sc *asc = hid_get_drvdata(hdev);\n\n\tif (asc->quirks & APPLE_MIGHTYMOUSE) {\n\t\tif (usage->hid == HID_GD_Z)\n\t\t\thid_map_usage(hi, usage, bit, max, EV_REL, REL_HWHEEL);\n\t\telse if (usage->code == BTN_1)\n\t\t\thid_map_usage(hi, usage, bit, max, EV_KEY, BTN_2);\n\t\telse if (usage->code == BTN_2)\n\t\t\thid_map_usage(hi, usage, bit, max, EV_KEY, BTN_1);\n\t}\n\n\treturn 0;\n}\n\nstatic int apple_input_configured(struct hid_device *hdev,\n\t\tstruct hid_input *hidinput)\n{\n\tstruct apple_sc *asc = hid_get_drvdata(hdev);\n\n\tif ((asc->quirks & APPLE_HAS_FN) && !asc->fn_found) {\n\t\thid_info(hdev, \"Fn key not found (Apple Wireless Keyboard clone?), disabling Fn key handling\\n\");\n\t\tasc->quirks &= ~APPLE_HAS_FN;\n\t}\n\n\tif (apple_is_non_apple_keyboard(hdev)) {\n\t\thid_info(hdev, \"Non-apple keyboard detected; function keys will default to fnmode=2 behavior\\n\");\n\t\tasc->quirks |= APPLE_IS_NON_APPLE;\n\t}\n\n\treturn 0;\n}\n\nstatic bool apple_backlight_check_support(struct hid_device *hdev)\n{\n\tint i;\n\tunsigned int hid;\n\tstruct hid_report *report;\n\n\tlist_for_each_entry(report, &hdev->report_enum[HID_INPUT_REPORT].report_list, list) {\n\t\tfor (i = 0; i < report->maxfield; i++) {\n\t\t\thid = report->field[i]->usage->hid;\n\t\t\tif ((hid & HID_USAGE_PAGE) == HID_UP_MSVENDOR && (hid & HID_USAGE) == 0xf)\n\t\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\nstatic int apple_backlight_set(struct hid_device *hdev, u16 value, u16 rate)\n{\n\tint ret = 0;\n\tstruct apple_backlight_set_report *rep;\n\n\trep = kmalloc(sizeof(*rep), GFP_KERNEL);\n\tif (rep == NULL)\n\t\treturn -ENOMEM;\n\n\trep->report_id = 0xB0;\n\trep->version = 1;\n\trep->backlight = value;\n\trep->rate = rate;\n\n\tret = hid_hw_raw_request(hdev, 0xB0u, (u8 *) rep, sizeof(*rep),\n\t\t\t\t HID_OUTPUT_REPORT, HID_REQ_SET_REPORT);\n\n\tkfree(rep);\n\treturn ret;\n}\n\nstatic int apple_backlight_led_set(struct led_classdev *led_cdev,\n\tenum led_brightness brightness)\n{\n\tstruct apple_sc_backlight *backlight = container_of(led_cdev,\n\t\t\t\t\t\t\t    struct apple_sc_backlight, cdev);\n\n\treturn apple_backlight_set(backlight->hdev, brightness, 0);\n}\n\nstatic int apple_backlight_init(struct hid_device *hdev)\n{\n\tint ret;\n\tstruct apple_sc *asc = hid_get_drvdata(hdev);\n\tstruct apple_backlight_config_report *rep;\n\n\tif (!apple_backlight_check_support(hdev))\n\t\treturn -EINVAL;\n\n\trep = kmalloc(0x200, GFP_KERNEL);\n\tif (rep == NULL)\n\t\treturn -ENOMEM;\n\n\tret = hid_hw_raw_request(hdev, 0xBFu, (u8 *) rep, sizeof(*rep),\n\t\t\t\t HID_FEATURE_REPORT, HID_REQ_GET_REPORT);\n\tif (ret < 0) {\n\t\thid_err(hdev, \"backlight request failed: %d\\n\", ret);\n\t\tgoto cleanup_and_exit;\n\t}\n\tif (ret < 8 || rep->version != 1) {\n\t\thid_err(hdev, \"backlight config struct: bad version %i\\n\", rep->version);\n\t\tret = -EINVAL;\n\t\tgoto cleanup_and_exit;\n\t}\n\n\thid_dbg(hdev, \"backlight config: off=%u, on_min=%u, on_max=%u\\n\",\n\t\trep->backlight_off, rep->backlight_on_min, rep->backlight_on_max);\n\n\tasc->backlight = devm_kzalloc(&hdev->dev, sizeof(*asc->backlight), GFP_KERNEL);\n\tif (!asc->backlight) {\n\t\tret = -ENOMEM;\n\t\tgoto cleanup_and_exit;\n\t}\n\n\tasc->backlight->hdev = hdev;\n\tasc->backlight->cdev.name = \"apple::kbd_backlight\";\n\tasc->backlight->cdev.max_brightness = rep->backlight_on_max;\n\tasc->backlight->cdev.brightness_set_blocking = apple_backlight_led_set;\n\n\tret = apple_backlight_set(hdev, 0, 0);\n\tif (ret < 0) {\n\t\thid_err(hdev, \"backlight set request failed: %d\\n\", ret);\n\t\tgoto cleanup_and_exit;\n\t}\n\n\tret = devm_led_classdev_register(&hdev->dev, &asc->backlight->cdev);\n\ncleanup_and_exit:\n\tkfree(rep);\n\treturn ret;\n}\n\nstatic int apple_probe(struct hid_device *hdev,\n\t\tconst struct hid_device_id *id)\n{\n\tunsigned long quirks = id->driver_data;\n\tstruct apple_sc *asc;\n\tint ret;\n\n\tasc = devm_kzalloc(&hdev->dev, sizeof(*asc), GFP_KERNEL);\n\tif (asc == NULL) {\n\t\thid_err(hdev, \"can't alloc apple descriptor\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tasc->hdev = hdev;\n\tasc->quirks = quirks;\n\n\thid_set_drvdata(hdev, asc);\n\n\tret = hid_parse(hdev);\n\tif (ret) {\n\t\thid_err(hdev, \"parse failed\\n\");\n\t\treturn ret;\n\t}\n\n\tret = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\n\tif (ret) {\n\t\thid_err(hdev, \"hw start failed\\n\");\n\t\treturn ret;\n\t}\n\n\ttimer_setup(&asc->battery_timer, apple_battery_timer_tick, 0);\n\tmod_timer(&asc->battery_timer,\n\t\t  jiffies + msecs_to_jiffies(APPLE_BATTERY_TIMEOUT_MS));\n\tapple_fetch_battery(hdev);\n\n\tif (quirks & APPLE_BACKLIGHT_CTL)\n\t\tapple_backlight_init(hdev);\n\n\treturn 0;\n}\n\nstatic void apple_remove(struct hid_device *hdev)\n{\n\tstruct apple_sc *asc = hid_get_drvdata(hdev);\n\n\tdel_timer_sync(&asc->battery_timer);\n\n\thid_hw_stop(hdev);\n}\n\nstatic const struct hid_device_id apple_devices[] = {\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MIGHTYMOUSE),\n\t\t.driver_data = APPLE_MIGHTYMOUSE | APPLE_INVERT_HWHEEL },\n\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_FOUNTAIN_ANSI),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_FOUNTAIN_ISO),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER_ANSI),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER_ISO),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER_JIS),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER3_ANSI),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER3_ISO),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN |\n\t\t\tAPPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER3_JIS),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN |\n\t\t\tAPPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER4_ANSI),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER4_ISO),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN |\n\t\t\tAPPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER4_JIS),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN |\n\t\t\tAPPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_MINI_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_MINI_ISO),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_MINI_JIS),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_ISO),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_JIS),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER4_HF_ANSI),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER4_HF_ISO),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN |\n\t\t\tAPPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER4_HF_JIS),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN |\n\t\t\tAPPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_REVB_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_REVB_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_REVB_ISO),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_REVB_ISO),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_REVB_JIS),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_WIRELESS_ANSI),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_WIRELESS_ISO),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN |\n\t\t\tAPPLE_ISO_TILDE_QUIRK },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_WIRELESS_2011_ISO),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN |\n\t\t\tAPPLE_ISO_TILDE_QUIRK },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE,\n\t\t\t\tUSB_DEVICE_ID_APPLE_ALU_WIRELESS_2011_ANSI),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE,\n\t\t\t\tUSB_DEVICE_ID_APPLE_ALU_WIRELESS_2011_JIS),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_WIRELESS_JIS),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_2015),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK | APPLE_RDESC_BATTERY },\n\t{ HID_BLUETOOTH_DEVICE(BT_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_2015),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_NUMPAD_2015),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK | APPLE_RDESC_BATTERY },\n\t{ HID_BLUETOOTH_DEVICE(BT_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_NUMPAD_2015),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING2_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING2_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING2_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING3_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING3_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING3_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING4_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING4_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING4_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING4A_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING4A_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING4A_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING5_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING5_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING5_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING6_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING6_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING6_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING6A_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING6A_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING6A_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING5A_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING5A_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING5A_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING7_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING7_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING7_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING7A_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING7A_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING7A_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING8_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING8_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING8_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING9_ANSI),\n\t\t.driver_data = APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING9_ISO),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRING9_JIS),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_RDESC_JIS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRINGT2_J140K),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_BACKLIGHT_CTL | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRINGT2_J132),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_BACKLIGHT_CTL | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRINGT2_J680),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_BACKLIGHT_CTL | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRINGT2_J213),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_BACKLIGHT_CTL | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRINGT2_J214K),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRINGT2_J223),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRINGT2_J230K),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_WELLSPRINGT2_J152F),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_WIRELESS_2009_ANSI),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_WIRELESS_2009_ISO),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN |\n\t\t\tAPPLE_ISO_TILDE_QUIRK },\n\t{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_ALU_WIRELESS_2009_JIS),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_FOUNTAIN_TP_ONLY),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_GEYSER1_TP_ONLY),\n\t\t.driver_data = APPLE_NUMLOCK_EMULATION | APPLE_HAS_FN },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_2021),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK | APPLE_RDESC_BATTERY },\n\t{ HID_BLUETOOTH_DEVICE(BT_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_2021),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_FINGERPRINT_2021),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK | APPLE_RDESC_BATTERY },\n\t{ HID_BLUETOOTH_DEVICE(BT_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_FINGERPRINT_2021),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_NUMPAD_2021),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK | APPLE_RDESC_BATTERY },\n\t{ HID_BLUETOOTH_DEVICE(BT_VENDOR_ID_APPLE, USB_DEVICE_ID_APPLE_MAGIC_KEYBOARD_NUMPAD_2021),\n\t\t.driver_data = APPLE_HAS_FN | APPLE_ISO_TILDE_QUIRK },\n\n\t{ }\n};\nMODULE_DEVICE_TABLE(hid, apple_devices);\n\nstatic struct hid_driver apple_driver = {\n\t.name = \"apple\",\n\t.id_table = apple_devices,\n\t.report_fixup = apple_report_fixup,\n\t.probe = apple_probe,\n\t.remove = apple_remove,\n\t.event = apple_event,\n\t.input_mapping = apple_input_mapping,\n\t.input_mapped = apple_input_mapped,\n\t.input_configured = apple_input_configured,\n};\nmodule_hid_driver(apple_driver);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}