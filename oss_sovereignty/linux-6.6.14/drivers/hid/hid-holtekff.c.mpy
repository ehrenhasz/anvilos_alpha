{
  "module_name": "hid-holtekff.c",
  "hash_id": "2ccdad9a2e35eddf8672744d6fce6134c869eef891124d1749cb2c2fca185b68",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-holtekff.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/hid.h>\n#include <linux/input.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n\n#include \"hid-ids.h\"\n\n#ifdef CONFIG_HOLTEK_FF\n\n \n\n#define HOLTEKFF_MSG_LENGTH     7\n\nstatic const u8 start_effect_1[] = { 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00 };\nstatic const u8 stop_all4[] =\t   { 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };\nstatic const u8 stop_all6[] =\t   { 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };\n\nstruct holtekff_device {\n\tstruct hid_field *field;\n};\n\nstatic void holtekff_send(struct holtekff_device *holtekff,\n\t\t\t  struct hid_device *hid,\n\t\t\t  const u8 data[HOLTEKFF_MSG_LENGTH])\n{\n\tint i;\n\n\tfor (i = 0; i < HOLTEKFF_MSG_LENGTH; i++) {\n\t\tholtekff->field->value[i] = data[i];\n\t}\n\n\tdbg_hid(\"sending %7ph\\n\", data);\n\n\thid_hw_request(hid, holtekff->field->report, HID_REQ_SET_REPORT);\n}\n\nstatic int holtekff_play(struct input_dev *dev, void *data,\n\t\t\t struct ff_effect *effect)\n{\n\tstruct hid_device *hid = input_get_drvdata(dev);\n\tstruct holtekff_device *holtekff = data;\n\tint left, right;\n\t \n\tu8 buf[HOLTEKFF_MSG_LENGTH] =\n\t\t{ 0x01, 0x01, 0xff, 0xff, 0x10, 0xe0, 0x00 };\n\n\tleft = effect->u.rumble.strong_magnitude;\n\tright = effect->u.rumble.weak_magnitude;\n\tdbg_hid(\"called with 0x%04x 0x%04x\\n\", left, right);\n\n\tif (!left && !right) {\n\t\tholtekff_send(holtekff, hid, stop_all6);\n\t\treturn 0;\n\t}\n\n\tif (left)\n\t\tbuf[1] |= 0x80;\n\tif (right)\n\t\tbuf[1] |= 0x40;\n\n\t \n\tbuf[6] = min(0xf, (left >> 12) + (right >> 12));\n\n\tholtekff_send(holtekff, hid, buf);\n\tholtekff_send(holtekff, hid, start_effect_1);\n\n\treturn 0;\n}\n\nstatic int holtekff_init(struct hid_device *hid)\n{\n\tstruct holtekff_device *holtekff;\n\tstruct hid_report *report;\n\tstruct hid_input *hidinput;\n\tstruct list_head *report_list =\n\t\t\t&hid->report_enum[HID_OUTPUT_REPORT].report_list;\n\tstruct input_dev *dev;\n\tint error;\n\n\tif (list_empty(&hid->inputs)) {\n\t\thid_err(hid, \"no inputs found\\n\");\n\t\treturn -ENODEV;\n\t}\n\thidinput = list_entry(hid->inputs.next, struct hid_input, list);\n\tdev = hidinput->input;\n\n\tif (list_empty(report_list)) {\n\t\thid_err(hid, \"no output report found\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\treport = list_entry(report_list->next, struct hid_report, list);\n\n\tif (report->maxfield < 1 || report->field[0]->report_count != 7) {\n\t\thid_err(hid, \"unexpected output report layout\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tholtekff = kzalloc(sizeof(*holtekff), GFP_KERNEL);\n\tif (!holtekff)\n\t\treturn -ENOMEM;\n\n\tset_bit(FF_RUMBLE, dev->ffbit);\n\n\tholtekff->field = report->field[0];\n\n\t \n\tholtekff_send(holtekff, hid, stop_all4);\n\tholtekff_send(holtekff, hid, stop_all6);\n\n\terror = input_ff_create_memless(dev, holtekff, holtekff_play);\n\tif (error) {\n\t\tkfree(holtekff);\n\t\treturn error;\n\t}\n\n\thid_info(hid, \"Force feedback for Holtek On Line Grip based devices by Anssi Hannula <anssi.hannula@iki.fi>\\n\");\n\n\treturn 0;\n}\n#else\nstatic inline int holtekff_init(struct hid_device *hid)\n{\n\treturn 0;\n}\n#endif\n\nstatic int holtek_probe(struct hid_device *hdev, const struct hid_device_id *id)\n{\n\tint ret;\n\n\tret = hid_parse(hdev);\n\tif (ret) {\n\t\thid_err(hdev, \"parse failed\\n\");\n\t\tgoto err;\n\t}\n\n\tret = hid_hw_start(hdev, HID_CONNECT_DEFAULT & ~HID_CONNECT_FF);\n\tif (ret) {\n\t\thid_err(hdev, \"hw start failed\\n\");\n\t\tgoto err;\n\t}\n\n\tholtekff_init(hdev);\n\n\treturn 0;\nerr:\n\treturn ret;\n}\n\nstatic const struct hid_device_id holtek_devices[] = {\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_HOLTEK, USB_DEVICE_ID_HOLTEK_ON_LINE_GRIP) },\n\t{ }\n};\nMODULE_DEVICE_TABLE(hid, holtek_devices);\n\nstatic struct hid_driver holtek_driver = {\n\t.name = \"holtek\",\n\t.id_table = holtek_devices,\n\t.probe = holtek_probe,\n};\nmodule_hid_driver(holtek_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Anssi Hannula <anssi.hannula@iki.fi>\");\nMODULE_DESCRIPTION(\"Force feedback support for Holtek On Line Grip based devices\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}