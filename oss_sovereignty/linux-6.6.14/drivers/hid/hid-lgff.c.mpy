{
  "module_name": "hid-lgff.c",
  "hash_id": "399d43e6595506f6f6174becb26425fb73bd31332814f63a25ec4299b37de751",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-lgff.c",
  "human_readable_source": "\n \n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/input.h>\n#include <linux/hid.h>\n\n#include \"hid-lg.h\"\n\nstruct dev_type {\n\tu16 idVendor;\n\tu16 idProduct;\n\tconst signed short *ff;\n};\n\nstatic const signed short ff_rumble[] = {\n\tFF_RUMBLE,\n\t-1\n};\n\nstatic const signed short ff_joystick[] = {\n\tFF_CONSTANT,\n\t-1\n};\n\nstatic const signed short ff_joystick_ac[] = {\n\tFF_CONSTANT,\n\tFF_AUTOCENTER,\n\t-1\n};\n\nstatic const struct dev_type devices[] = {\n\t{ 0x046d, 0xc211, ff_rumble },\n\t{ 0x046d, 0xc219, ff_rumble },\n\t{ 0x046d, 0xc283, ff_joystick },\n\t{ 0x046d, 0xc286, ff_joystick_ac },\n\t{ 0x046d, 0xc287, ff_joystick_ac },\n\t{ 0x046d, 0xc293, ff_joystick },\n\t{ 0x046d, 0xc295, ff_joystick },\n};\n\nstatic int hid_lgff_play(struct input_dev *dev, void *data, struct ff_effect *effect)\n{\n\tstruct hid_device *hid = input_get_drvdata(dev);\n\tstruct list_head *report_list = &hid->report_enum[HID_OUTPUT_REPORT].report_list;\n\tstruct hid_report *report = list_entry(report_list->next, struct hid_report, list);\n\tint x, y;\n\tunsigned int left, right;\n\n#define CLAMP(x) if (x < 0) x = 0; if (x > 0xff) x = 0xff\n\n\tswitch (effect->type) {\n\tcase FF_CONSTANT:\n\t\tx = effect->u.ramp.start_level + 0x7f;\t \n\t\ty = effect->u.ramp.end_level + 0x7f;\n\t\tCLAMP(x);\n\t\tCLAMP(y);\n\t\treport->field[0]->value[0] = 0x51;\n\t\treport->field[0]->value[1] = 0x08;\n\t\treport->field[0]->value[2] = x;\n\t\treport->field[0]->value[3] = y;\n\t\tdbg_hid(\"(x, y)=(%04x, %04x)\\n\", x, y);\n\t\thid_hw_request(hid, report, HID_REQ_SET_REPORT);\n\t\tbreak;\n\n\tcase FF_RUMBLE:\n\t\tright = effect->u.rumble.strong_magnitude;\n\t\tleft = effect->u.rumble.weak_magnitude;\n\t\tright = right * 0xff / 0xffff;\n\t\tleft = left * 0xff / 0xffff;\n\t\tCLAMP(left);\n\t\tCLAMP(right);\n\t\treport->field[0]->value[0] = 0x42;\n\t\treport->field[0]->value[1] = 0x00;\n\t\treport->field[0]->value[2] = left;\n\t\treport->field[0]->value[3] = right;\n\t\tdbg_hid(\"(left, right)=(%04x, %04x)\\n\", left, right);\n\t\thid_hw_request(hid, report, HID_REQ_SET_REPORT);\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic void hid_lgff_set_autocenter(struct input_dev *dev, u16 magnitude)\n{\n\tstruct hid_device *hid = input_get_drvdata(dev);\n\tstruct list_head *report_list = &hid->report_enum[HID_OUTPUT_REPORT].report_list;\n\tstruct hid_report *report = list_entry(report_list->next, struct hid_report, list);\n\t__s32 *value = report->field[0]->value;\n\tmagnitude = (magnitude >> 12) & 0xf;\n\t*value++ = 0xfe;\n\t*value++ = 0x0d;\n\t*value++ = magnitude;    \n\t*value++ = magnitude;    \n\t*value++ = 0x80;\n\t*value++ = 0x00;\n\t*value = 0x00;\n\thid_hw_request(hid, report, HID_REQ_SET_REPORT);\n}\n\nint lgff_init(struct hid_device* hid)\n{\n\tstruct hid_input *hidinput;\n\tstruct input_dev *dev;\n\tconst signed short *ff_bits = ff_joystick;\n\tint error;\n\tint i;\n\n\tif (list_empty(&hid->inputs)) {\n\t\thid_err(hid, \"no inputs found\\n\");\n\t\treturn -ENODEV;\n\t}\n\thidinput = list_entry(hid->inputs.next, struct hid_input, list);\n\tdev = hidinput->input;\n\n\t \n\tif (!hid_validate_values(hid, HID_OUTPUT_REPORT, 0, 0, 7))\n\t\treturn -ENODEV;\n\n\tfor (i = 0; i < ARRAY_SIZE(devices); i++) {\n\t\tif (dev->id.vendor == devices[i].idVendor &&\n\t\t    dev->id.product == devices[i].idProduct) {\n\t\t\tff_bits = devices[i].ff;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tfor (i = 0; ff_bits[i] >= 0; i++)\n\t\tset_bit(ff_bits[i], dev->ffbit);\n\n\terror = input_ff_create_memless(dev, NULL, hid_lgff_play);\n\tif (error)\n\t\treturn error;\n\n\tif ( test_bit(FF_AUTOCENTER, dev->ffbit) )\n\t\tdev->ff->set_autocenter = hid_lgff_set_autocenter;\n\n\tpr_info(\"Force feedback for Logitech force feedback devices by Johann Deneux <johann.deneux@it.uu.se>\\n\");\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}