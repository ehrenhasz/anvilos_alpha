{
  "module_name": "hid-vivaldi-common.c",
  "hash_id": "abfa293e9060075f416e508d31b1b4f5c46fa0da42d2201ac6a7bfa7987ed64d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-vivaldi-common.c",
  "human_readable_source": "\n \n\n#include <linux/export.h>\n#include <linux/hid.h>\n#include <linux/input/vivaldi-fmap.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/types.h>\n\n#include \"hid-vivaldi-common.h\"\n\n#define MIN_FN_ROW_KEY 1\n#define MAX_FN_ROW_KEY VIVALDI_MAX_FUNCTION_ROW_KEYS\n#define HID_VD_FN_ROW_PHYSMAP 0x00000001\n#define HID_USAGE_FN_ROW_PHYSMAP (HID_UP_GOOGLEVENDOR | HID_VD_FN_ROW_PHYSMAP)\n\n \nvoid vivaldi_feature_mapping(struct hid_device *hdev,\n\t\t\t     struct hid_field *field, struct hid_usage *usage)\n{\n\tstruct vivaldi_data *data = hid_get_drvdata(hdev);\n\tstruct hid_report *report = field->report;\n\tu8 *report_data, *buf;\n\tu32 report_len;\n\tunsigned int fn_key;\n\tint ret;\n\n\tif (field->logical != HID_USAGE_FN_ROW_PHYSMAP ||\n\t    (usage->hid & HID_USAGE_PAGE) != HID_UP_ORDINAL)\n\t\treturn;\n\n\tfn_key = usage->hid & HID_USAGE;\n\tif (fn_key < MIN_FN_ROW_KEY || fn_key > MAX_FN_ROW_KEY)\n\t\treturn;\n\n\tif (fn_key > data->num_function_row_keys)\n\t\tdata->num_function_row_keys = fn_key;\n\n\treport_data = buf = hid_alloc_report_buf(report, GFP_KERNEL);\n\tif (!report_data)\n\t\treturn;\n\n\treport_len = hid_report_len(report);\n\tif (!report->id) {\n\t\t \n\t\treport_len++;\n\t}\n\n\tret = hid_hw_raw_request(hdev, report->id, report_data,\n\t\t\t\t report_len, HID_FEATURE_REPORT,\n\t\t\t\t HID_REQ_GET_REPORT);\n\tif (ret < 0) {\n\t\tdev_warn(&hdev->dev, \"failed to fetch feature %d\\n\",\n\t\t\t field->report->id);\n\t\tgoto out;\n\t}\n\n\tif (!report->id) {\n\t\t \n\t\treport_data++;\n\t\treport_len--;\n\t}\n\n\tret = hid_report_raw_event(hdev, HID_FEATURE_REPORT, report_data,\n\t\t\t\t   report_len, 0);\n\tif (ret) {\n\t\tdev_warn(&hdev->dev, \"failed to report feature %d\\n\",\n\t\t\t field->report->id);\n\t\tgoto out;\n\t}\n\n\tdata->function_row_physmap[fn_key - MIN_FN_ROW_KEY] =\n\t\tfield->value[usage->usage_index];\n\nout:\n\tkfree(buf);\n}\nEXPORT_SYMBOL_GPL(vivaldi_feature_mapping);\n\nstatic ssize_t function_row_physmap_show(struct device *dev,\n\t\t\t\t\t struct device_attribute *attr,\n\t\t\t\t\t char *buf)\n{\n\tstruct hid_device *hdev = to_hid_device(dev);\n\tstruct vivaldi_data *data = hid_get_drvdata(hdev);\n\n\treturn vivaldi_function_row_physmap_show(data, buf);\n}\n\nstatic DEVICE_ATTR_RO(function_row_physmap);\nstatic struct attribute *vivaldi_sysfs_attrs[] = {\n\t&dev_attr_function_row_physmap.attr,\n\tNULL\n};\n\nstatic umode_t vivaldi_is_visible(struct kobject *kobj, struct attribute *attr,\n\t\t\t\t  int n)\n{\n\tstruct hid_device *hdev = to_hid_device(kobj_to_dev(kobj));\n\tstruct vivaldi_data *data = hid_get_drvdata(hdev);\n\n\tif (!data->num_function_row_keys)\n\t\treturn 0;\n\treturn attr->mode;\n}\n\nstatic const struct attribute_group vivaldi_attribute_group = {\n\t.attrs = vivaldi_sysfs_attrs,\n\t.is_visible = vivaldi_is_visible,\n};\n\nconst struct attribute_group *vivaldi_attribute_groups[] = {\n\t&vivaldi_attribute_group,\n\tNULL,\n};\nEXPORT_SYMBOL_GPL(vivaldi_attribute_groups);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}