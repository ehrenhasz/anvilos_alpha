{
  "module_name": "hid-roccat-kone.c",
  "hash_id": "d005b145af8a4ead5c61323ce93adf28242a3c903c6166cf69ed55c65e09d45d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-roccat-kone.c",
  "human_readable_source": "\n \n\n \n\n \n\n#include <linux/device.h>\n#include <linux/input.h>\n#include <linux/hid.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/hid-roccat.h>\n#include \"hid-ids.h\"\n#include \"hid-roccat-common.h\"\n#include \"hid-roccat-kone.h\"\n\nstatic uint profile_numbers[5] = {0, 1, 2, 3, 4};\n\nstatic void kone_profile_activated(struct kone_device *kone, uint new_profile)\n{\n\tkone->actual_profile = new_profile;\n\tkone->actual_dpi = kone->profiles[new_profile - 1].startup_dpi;\n}\n\nstatic void kone_profile_report(struct kone_device *kone, uint new_profile)\n{\n\tstruct kone_roccat_report roccat_report;\n\n\troccat_report.event = kone_mouse_event_switch_profile;\n\troccat_report.value = new_profile;\n\troccat_report.key = 0;\n\troccat_report_event(kone->chrdev_minor, (uint8_t *)&roccat_report);\n}\n\nstatic int kone_receive(struct usb_device *usb_dev, uint usb_command,\n\t\tvoid *data, uint size)\n{\n\tchar *buf;\n\tint len;\n\n\tbuf = kmalloc(size, GFP_KERNEL);\n\tif (buf == NULL)\n\t\treturn -ENOMEM;\n\n\tlen = usb_control_msg(usb_dev, usb_rcvctrlpipe(usb_dev, 0),\n\t\t\tHID_REQ_GET_REPORT,\n\t\t\tUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_IN,\n\t\t\tusb_command, 0, buf, size, USB_CTRL_SET_TIMEOUT);\n\n\tmemcpy(data, buf, size);\n\tkfree(buf);\n\treturn ((len < 0) ? len : ((len != size) ? -EIO : 0));\n}\n\nstatic int kone_send(struct usb_device *usb_dev, uint usb_command,\n\t\tvoid const *data, uint size)\n{\n\tchar *buf;\n\tint len;\n\n\tbuf = kmemdup(data, size, GFP_KERNEL);\n\tif (buf == NULL)\n\t\treturn -ENOMEM;\n\n\tlen = usb_control_msg(usb_dev, usb_sndctrlpipe(usb_dev, 0),\n\t\t\tHID_REQ_SET_REPORT,\n\t\t\tUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_OUT,\n\t\t\tusb_command, 0, buf, size, USB_CTRL_SET_TIMEOUT);\n\n\tkfree(buf);\n\treturn ((len < 0) ? len : ((len != size) ? -EIO : 0));\n}\n\nstatic void kone_set_settings_checksum(struct kone_settings *settings)\n{\n\tuint16_t checksum = 0;\n\tunsigned char *address = (unsigned char *)settings;\n\tint i;\n\n\tfor (i = 0; i < sizeof(struct kone_settings) - 2; ++i, ++address)\n\t\tchecksum += *address;\n\tsettings->checksum = cpu_to_le16(checksum);\n}\n\n \nstatic int kone_check_write(struct usb_device *usb_dev)\n{\n\tint retval;\n\tuint8_t data;\n\n\tdo {\n\t\t \n\t\tmsleep(80);\n\n\t\tretval = kone_receive(usb_dev,\n\t\t\t\tkone_command_confirm_write, &data, 1);\n\t\tif (retval)\n\t\t\treturn retval;\n\n\t\t \n\t} while (data == 3);\n\n\tif (data == 1)  \n\t\treturn 0;\n\n\t \n\tdev_err(&usb_dev->dev, \"got retval %d when checking write\\n\", data);\n\treturn -EIO;\n}\n\n \nstatic int kone_get_settings(struct usb_device *usb_dev,\n\t\tstruct kone_settings *buf)\n{\n\treturn kone_receive(usb_dev, kone_command_settings, buf,\n\t\t\tsizeof(struct kone_settings));\n}\n\n \nstatic int kone_set_settings(struct usb_device *usb_dev,\n\t\tstruct kone_settings const *settings)\n{\n\tint retval;\n\n\tretval = kone_send(usb_dev, kone_command_settings,\n\t\t\tsettings, sizeof(struct kone_settings));\n\tif (retval)\n\t\treturn retval;\n\treturn kone_check_write(usb_dev);\n}\n\n \nstatic int kone_get_profile(struct usb_device *usb_dev,\n\t\tstruct kone_profile *buf, int number)\n{\n\tint len;\n\n\tif (number < 1 || number > 5)\n\t\treturn -EINVAL;\n\n\tlen = usb_control_msg(usb_dev, usb_rcvctrlpipe(usb_dev, 0),\n\t\t\tUSB_REQ_CLEAR_FEATURE,\n\t\t\tUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_IN,\n\t\t\tkone_command_profile, number, buf,\n\t\t\tsizeof(struct kone_profile), USB_CTRL_SET_TIMEOUT);\n\n\tif (len != sizeof(struct kone_profile))\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\n \nstatic int kone_set_profile(struct usb_device *usb_dev,\n\t\tstruct kone_profile const *profile, int number)\n{\n\tint len;\n\n\tif (number < 1 || number > 5)\n\t\treturn -EINVAL;\n\n\tlen = usb_control_msg(usb_dev, usb_sndctrlpipe(usb_dev, 0),\n\t\t\tUSB_REQ_SET_CONFIGURATION,\n\t\t\tUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_OUT,\n\t\t\tkone_command_profile, number, (void *)profile,\n\t\t\tsizeof(struct kone_profile),\n\t\t\tUSB_CTRL_SET_TIMEOUT);\n\n\tif (len != sizeof(struct kone_profile))\n\t\treturn len;\n\n\tif (kone_check_write(usb_dev))\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\n \nstatic int kone_get_weight(struct usb_device *usb_dev, int *result)\n{\n\tint retval;\n\tuint8_t data;\n\n\tretval = kone_receive(usb_dev, kone_command_weight, &data, 1);\n\n\tif (retval)\n\t\treturn retval;\n\n\t*result = (int)data;\n\treturn 0;\n}\n\n \nstatic int kone_get_firmware_version(struct usb_device *usb_dev, int *result)\n{\n\tint retval;\n\tuint16_t data;\n\n\tretval = kone_receive(usb_dev, kone_command_firmware_version,\n\t\t\t&data, 2);\n\tif (retval)\n\t\treturn retval;\n\n\t*result = le16_to_cpu(data);\n\treturn 0;\n}\n\nstatic ssize_t kone_sysfs_read_settings(struct file *fp, struct kobject *kobj,\n\t\tstruct bin_attribute *attr, char *buf,\n\t\tloff_t off, size_t count) {\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct kone_device *kone = hid_get_drvdata(dev_get_drvdata(dev));\n\n\tif (off >= sizeof(struct kone_settings))\n\t\treturn 0;\n\n\tif (off + count > sizeof(struct kone_settings))\n\t\tcount = sizeof(struct kone_settings) - off;\n\n\tmutex_lock(&kone->kone_lock);\n\tmemcpy(buf, ((char const *)&kone->settings) + off, count);\n\tmutex_unlock(&kone->kone_lock);\n\n\treturn count;\n}\n\n \nstatic ssize_t kone_sysfs_write_settings(struct file *fp, struct kobject *kobj,\n\t\tstruct bin_attribute *attr, char *buf,\n\t\tloff_t off, size_t count) {\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct kone_device *kone = hid_get_drvdata(dev_get_drvdata(dev));\n\tstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\n\tint retval = 0, difference, old_profile;\n\tstruct kone_settings *settings = (struct kone_settings *)buf;\n\n\t \n\tif (off != 0 || count != sizeof(struct kone_settings))\n\t\treturn -EINVAL;\n\n\tmutex_lock(&kone->kone_lock);\n\tdifference = memcmp(settings, &kone->settings,\n\t\t\t    sizeof(struct kone_settings));\n\tif (difference) {\n\t\tif (settings->startup_profile < 1 ||\n\t\t    settings->startup_profile > 5) {\n\t\t\tretval = -EINVAL;\n\t\t\tgoto unlock;\n\t\t}\n\n\t\tretval = kone_set_settings(usb_dev, settings);\n\t\tif (retval)\n\t\t\tgoto unlock;\n\n\t\told_profile = kone->settings.startup_profile;\n\t\tmemcpy(&kone->settings, settings, sizeof(struct kone_settings));\n\n\t\tkone_profile_activated(kone, kone->settings.startup_profile);\n\n\t\tif (kone->settings.startup_profile != old_profile)\n\t\t\tkone_profile_report(kone, kone->settings.startup_profile);\n\t}\nunlock:\n\tmutex_unlock(&kone->kone_lock);\n\n\tif (retval)\n\t\treturn retval;\n\n\treturn sizeof(struct kone_settings);\n}\nstatic BIN_ATTR(settings, 0660, kone_sysfs_read_settings,\n\t\tkone_sysfs_write_settings, sizeof(struct kone_settings));\n\nstatic ssize_t kone_sysfs_read_profilex(struct file *fp,\n\t\tstruct kobject *kobj, struct bin_attribute *attr,\n\t\tchar *buf, loff_t off, size_t count) {\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct kone_device *kone = hid_get_drvdata(dev_get_drvdata(dev));\n\n\tif (off >= sizeof(struct kone_profile))\n\t\treturn 0;\n\n\tif (off + count > sizeof(struct kone_profile))\n\t\tcount = sizeof(struct kone_profile) - off;\n\n\tmutex_lock(&kone->kone_lock);\n\tmemcpy(buf, ((char const *)&kone->profiles[*(uint *)(attr->private)]) + off, count);\n\tmutex_unlock(&kone->kone_lock);\n\n\treturn count;\n}\n\n \nstatic ssize_t kone_sysfs_write_profilex(struct file *fp,\n\t\tstruct kobject *kobj, struct bin_attribute *attr,\n\t\tchar *buf, loff_t off, size_t count) {\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct kone_device *kone = hid_get_drvdata(dev_get_drvdata(dev));\n\tstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\n\tstruct kone_profile *profile;\n\tint retval = 0, difference;\n\n\t \n\tif (off != 0 || count != sizeof(struct kone_profile))\n\t\treturn -EINVAL;\n\n\tprofile = &kone->profiles[*(uint *)(attr->private)];\n\n\tmutex_lock(&kone->kone_lock);\n\tdifference = memcmp(buf, profile, sizeof(struct kone_profile));\n\tif (difference) {\n\t\tretval = kone_set_profile(usb_dev,\n\t\t\t\t(struct kone_profile const *)buf,\n\t\t\t\t*(uint *)(attr->private) + 1);\n\t\tif (!retval)\n\t\t\tmemcpy(profile, buf, sizeof(struct kone_profile));\n\t}\n\tmutex_unlock(&kone->kone_lock);\n\n\tif (retval)\n\t\treturn retval;\n\n\treturn sizeof(struct kone_profile);\n}\n#define PROFILE_ATTR(number)\t\t\t\t\t\\\nstatic struct bin_attribute bin_attr_profile##number = {\t\\\n\t.attr = { .name = \"profile\" #number, .mode = 0660 },\t\\\n\t.size = sizeof(struct kone_profile),\t\t\t\\\n\t.read = kone_sysfs_read_profilex,\t\t\t\\\n\t.write = kone_sysfs_write_profilex,\t\t\t\\\n\t.private = &profile_numbers[number-1],\t\t\t\\\n}\nPROFILE_ATTR(1);\nPROFILE_ATTR(2);\nPROFILE_ATTR(3);\nPROFILE_ATTR(4);\nPROFILE_ATTR(5);\n\nstatic ssize_t kone_sysfs_show_actual_profile(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kone_device *kone =\n\t\t\thid_get_drvdata(dev_get_drvdata(dev->parent->parent));\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", kone->actual_profile);\n}\nstatic DEVICE_ATTR(actual_profile, 0440, kone_sysfs_show_actual_profile, NULL);\n\nstatic ssize_t kone_sysfs_show_actual_dpi(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kone_device *kone =\n\t\t\thid_get_drvdata(dev_get_drvdata(dev->parent->parent));\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", kone->actual_dpi);\n}\nstatic DEVICE_ATTR(actual_dpi, 0440, kone_sysfs_show_actual_dpi, NULL);\n\n \nstatic ssize_t kone_sysfs_show_weight(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kone_device *kone;\n\tstruct usb_device *usb_dev;\n\tint weight = 0;\n\tint retval;\n\n\tdev = dev->parent->parent;\n\tkone = hid_get_drvdata(dev_get_drvdata(dev));\n\tusb_dev = interface_to_usbdev(to_usb_interface(dev));\n\n\tmutex_lock(&kone->kone_lock);\n\tretval = kone_get_weight(usb_dev, &weight);\n\tmutex_unlock(&kone->kone_lock);\n\n\tif (retval)\n\t\treturn retval;\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", weight);\n}\nstatic DEVICE_ATTR(weight, 0440, kone_sysfs_show_weight, NULL);\n\nstatic ssize_t kone_sysfs_show_firmware_version(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kone_device *kone =\n\t\t\thid_get_drvdata(dev_get_drvdata(dev->parent->parent));\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", kone->firmware_version);\n}\nstatic DEVICE_ATTR(firmware_version, 0440, kone_sysfs_show_firmware_version,\n\t\t   NULL);\n\nstatic ssize_t kone_sysfs_show_tcu(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kone_device *kone =\n\t\t\thid_get_drvdata(dev_get_drvdata(dev->parent->parent));\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", kone->settings.tcu);\n}\n\nstatic int kone_tcu_command(struct usb_device *usb_dev, int number)\n{\n\tunsigned char value;\n\n\tvalue = number;\n\treturn kone_send(usb_dev, kone_command_calibrate, &value, 1);\n}\n\n \nstatic ssize_t kone_sysfs_set_tcu(struct device *dev,\n\t\tstruct device_attribute *attr, char const *buf, size_t size)\n{\n\tstruct kone_device *kone;\n\tstruct usb_device *usb_dev;\n\tint retval;\n\tunsigned long state;\n\n\tdev = dev->parent->parent;\n\tkone = hid_get_drvdata(dev_get_drvdata(dev));\n\tusb_dev = interface_to_usbdev(to_usb_interface(dev));\n\n\tretval = kstrtoul(buf, 10, &state);\n\tif (retval)\n\t\treturn retval;\n\n\tif (state != 0 && state != 1)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&kone->kone_lock);\n\n\tif (state == 1) {  \n\t\tretval = kone_tcu_command(usb_dev, 1);\n\t\tif (retval)\n\t\t\tgoto exit_unlock;\n\t\tretval = kone_tcu_command(usb_dev, 2);\n\t\tif (retval)\n\t\t\tgoto exit_unlock;\n\t\tssleep(5);  \n\t\tretval = kone_tcu_command(usb_dev, 3);\n\t\tif (retval)\n\t\t\tgoto exit_unlock;\n\t\tretval = kone_tcu_command(usb_dev, 0);\n\t\tif (retval)\n\t\t\tgoto exit_unlock;\n\t\tretval = kone_tcu_command(usb_dev, 4);\n\t\tif (retval)\n\t\t\tgoto exit_unlock;\n\t\t \n\t\tssleep(1);\n\t}\n\n\t \n\tretval = kone_get_settings(usb_dev, &kone->settings);\n\tif (retval)\n\t\tgoto exit_no_settings;\n\n\t \n\tif (kone->settings.tcu != state) {\n\t\tkone->settings.tcu = state;\n\t\tkone_set_settings_checksum(&kone->settings);\n\n\t\tretval = kone_set_settings(usb_dev, &kone->settings);\n\t\tif (retval) {\n\t\t\tdev_err(&usb_dev->dev, \"couldn't set tcu state\\n\");\n\t\t\t \n\t\t\tretval = kone_get_settings(usb_dev, &kone->settings);\n\t\t\tif (retval)\n\t\t\t\tgoto exit_no_settings;\n\t\t\tgoto exit_unlock;\n\t\t}\n\t\t \n\t\tkone_profile_activated(kone, kone->settings.startup_profile);\n\t}\n\n\tretval = size;\nexit_no_settings:\n\tdev_err(&usb_dev->dev, \"couldn't read settings\\n\");\nexit_unlock:\n\tmutex_unlock(&kone->kone_lock);\n\treturn retval;\n}\nstatic DEVICE_ATTR(tcu, 0660, kone_sysfs_show_tcu, kone_sysfs_set_tcu);\n\nstatic ssize_t kone_sysfs_show_startup_profile(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kone_device *kone =\n\t\t\thid_get_drvdata(dev_get_drvdata(dev->parent->parent));\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", kone->settings.startup_profile);\n}\n\nstatic ssize_t kone_sysfs_set_startup_profile(struct device *dev,\n\t\tstruct device_attribute *attr, char const *buf, size_t size)\n{\n\tstruct kone_device *kone;\n\tstruct usb_device *usb_dev;\n\tint retval;\n\tunsigned long new_startup_profile;\n\n\tdev = dev->parent->parent;\n\tkone = hid_get_drvdata(dev_get_drvdata(dev));\n\tusb_dev = interface_to_usbdev(to_usb_interface(dev));\n\n\tretval = kstrtoul(buf, 10, &new_startup_profile);\n\tif (retval)\n\t\treturn retval;\n\n\tif (new_startup_profile  < 1 || new_startup_profile > 5)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&kone->kone_lock);\n\n\tkone->settings.startup_profile = new_startup_profile;\n\tkone_set_settings_checksum(&kone->settings);\n\n\tretval = kone_set_settings(usb_dev, &kone->settings);\n\tif (retval) {\n\t\tmutex_unlock(&kone->kone_lock);\n\t\treturn retval;\n\t}\n\n\t \n\tkone_profile_activated(kone, new_startup_profile);\n\tkone_profile_report(kone, new_startup_profile);\n\n\tmutex_unlock(&kone->kone_lock);\n\treturn size;\n}\nstatic DEVICE_ATTR(startup_profile, 0660, kone_sysfs_show_startup_profile,\n\t\t   kone_sysfs_set_startup_profile);\n\nstatic struct attribute *kone_attrs[] = {\n\t \n\t&dev_attr_actual_dpi.attr,\n\t&dev_attr_actual_profile.attr,\n\n\t \n\t&dev_attr_weight.attr,\n\n\t \n\t&dev_attr_firmware_version.attr,\n\n\t \n\t&dev_attr_tcu.attr,\n\n\t \n\t&dev_attr_startup_profile.attr,\n\tNULL,\n};\n\nstatic struct bin_attribute *kone_bin_attributes[] = {\n\t&bin_attr_settings,\n\t&bin_attr_profile1,\n\t&bin_attr_profile2,\n\t&bin_attr_profile3,\n\t&bin_attr_profile4,\n\t&bin_attr_profile5,\n\tNULL,\n};\n\nstatic const struct attribute_group kone_group = {\n\t.attrs = kone_attrs,\n\t.bin_attrs = kone_bin_attributes,\n};\n\nstatic const struct attribute_group *kone_groups[] = {\n\t&kone_group,\n\tNULL,\n};\n\n \nstatic const struct class kone_class = {\n\t.name = \"kone\",\n\t.dev_groups = kone_groups,\n};\n\nstatic int kone_init_kone_device_struct(struct usb_device *usb_dev,\n\t\tstruct kone_device *kone)\n{\n\tuint i;\n\tint retval;\n\n\tmutex_init(&kone->kone_lock);\n\n\tfor (i = 0; i < 5; ++i) {\n\t\tretval = kone_get_profile(usb_dev, &kone->profiles[i], i + 1);\n\t\tif (retval)\n\t\t\treturn retval;\n\t}\n\n\tretval = kone_get_settings(usb_dev, &kone->settings);\n\tif (retval)\n\t\treturn retval;\n\n\tretval = kone_get_firmware_version(usb_dev, &kone->firmware_version);\n\tif (retval)\n\t\treturn retval;\n\n\tkone_profile_activated(kone, kone->settings.startup_profile);\n\n\treturn 0;\n}\n\n \nstatic int kone_init_specials(struct hid_device *hdev)\n{\n\tstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\n\tstruct usb_device *usb_dev = interface_to_usbdev(intf);\n\tstruct kone_device *kone;\n\tint retval;\n\n\tif (intf->cur_altsetting->desc.bInterfaceProtocol\n\t\t\t== USB_INTERFACE_PROTOCOL_MOUSE) {\n\n\t\tkone = kzalloc(sizeof(*kone), GFP_KERNEL);\n\t\tif (!kone)\n\t\t\treturn -ENOMEM;\n\t\thid_set_drvdata(hdev, kone);\n\n\t\tretval = kone_init_kone_device_struct(usb_dev, kone);\n\t\tif (retval) {\n\t\t\thid_err(hdev, \"couldn't init struct kone_device\\n\");\n\t\t\tgoto exit_free;\n\t\t}\n\n\t\tretval = roccat_connect(&kone_class, hdev,\n\t\t\t\t\tsizeof(struct kone_roccat_report));\n\t\tif (retval < 0) {\n\t\t\thid_err(hdev, \"couldn't init char dev\\n\");\n\t\t\t \n\t\t} else {\n\t\t\tkone->roccat_claimed = 1;\n\t\t\tkone->chrdev_minor = retval;\n\t\t}\n\t} else {\n\t\thid_set_drvdata(hdev, NULL);\n\t}\n\n\treturn 0;\nexit_free:\n\tkfree(kone);\n\treturn retval;\n}\n\nstatic void kone_remove_specials(struct hid_device *hdev)\n{\n\tstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\n\tstruct kone_device *kone;\n\n\tif (intf->cur_altsetting->desc.bInterfaceProtocol\n\t\t\t== USB_INTERFACE_PROTOCOL_MOUSE) {\n\t\tkone = hid_get_drvdata(hdev);\n\t\tif (kone->roccat_claimed)\n\t\t\troccat_disconnect(kone->chrdev_minor);\n\t\tkfree(hid_get_drvdata(hdev));\n\t}\n}\n\nstatic int kone_probe(struct hid_device *hdev, const struct hid_device_id *id)\n{\n\tint retval;\n\n\tif (!hid_is_usb(hdev))\n\t\treturn -EINVAL;\n\n\tretval = hid_parse(hdev);\n\tif (retval) {\n\t\thid_err(hdev, \"parse failed\\n\");\n\t\tgoto exit;\n\t}\n\n\tretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\n\tif (retval) {\n\t\thid_err(hdev, \"hw start failed\\n\");\n\t\tgoto exit;\n\t}\n\n\tretval = kone_init_specials(hdev);\n\tif (retval) {\n\t\thid_err(hdev, \"couldn't install mouse\\n\");\n\t\tgoto exit_stop;\n\t}\n\n\treturn 0;\n\nexit_stop:\n\thid_hw_stop(hdev);\nexit:\n\treturn retval;\n}\n\nstatic void kone_remove(struct hid_device *hdev)\n{\n\tkone_remove_specials(hdev);\n\thid_hw_stop(hdev);\n}\n\n \nstatic void kone_keep_values_up_to_date(struct kone_device *kone,\n\t\tstruct kone_mouse_event const *event)\n{\n\tswitch (event->event) {\n\tcase kone_mouse_event_switch_profile:\n\t\tkone->actual_dpi = kone->profiles[event->value - 1].\n\t\t\t\tstartup_dpi;\n\t\tfallthrough;\n\tcase kone_mouse_event_osd_profile:\n\t\tkone->actual_profile = event->value;\n\t\tbreak;\n\tcase kone_mouse_event_switch_dpi:\n\tcase kone_mouse_event_osd_dpi:\n\t\tkone->actual_dpi = event->value;\n\t\tbreak;\n\t}\n}\n\nstatic void kone_report_to_chrdev(struct kone_device const *kone,\n\t\tstruct kone_mouse_event const *event)\n{\n\tstruct kone_roccat_report roccat_report;\n\n\tswitch (event->event) {\n\tcase kone_mouse_event_switch_profile:\n\tcase kone_mouse_event_switch_dpi:\n\tcase kone_mouse_event_osd_profile:\n\tcase kone_mouse_event_osd_dpi:\n\t\troccat_report.event = event->event;\n\t\troccat_report.value = event->value;\n\t\troccat_report.key = 0;\n\t\troccat_report_event(kone->chrdev_minor,\n\t\t\t\t(uint8_t *)&roccat_report);\n\t\tbreak;\n\tcase kone_mouse_event_call_overlong_macro:\n\tcase kone_mouse_event_multimedia:\n\t\tif (event->value == kone_keystroke_action_press) {\n\t\t\troccat_report.event = event->event;\n\t\t\troccat_report.value = kone->actual_profile;\n\t\t\troccat_report.key = event->macro_key;\n\t\t\troccat_report_event(kone->chrdev_minor,\n\t\t\t\t\t(uint8_t *)&roccat_report);\n\t\t}\n\t\tbreak;\n\t}\n\n}\n\n \nstatic int kone_raw_event(struct hid_device *hdev, struct hid_report *report,\n\t\tu8 *data, int size)\n{\n\tstruct kone_device *kone = hid_get_drvdata(hdev);\n\tstruct kone_mouse_event *event = (struct kone_mouse_event *)data;\n\n\t \n\tif (size != sizeof(struct kone_mouse_event))\n\t\treturn 0;\n\n\tif (kone == NULL)\n\t\treturn 0;\n\n\t \n\tif (memcmp(&kone->last_mouse_event.tilt, &event->tilt, 5))\n\t\tmemcpy(&kone->last_mouse_event, event,\n\t\t\t\tsizeof(struct kone_mouse_event));\n\telse\n\t\tmemset(&event->wipe, 0, sizeof(event->wipe));\n\n\tkone_keep_values_up_to_date(kone, event);\n\n\tif (kone->roccat_claimed)\n\t\tkone_report_to_chrdev(kone, event);\n\n\treturn 0;  \n}\n\nstatic const struct hid_device_id kone_devices[] = {\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_ROCCAT, USB_DEVICE_ID_ROCCAT_KONE) },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(hid, kone_devices);\n\nstatic struct hid_driver kone_driver = {\n\t\t.name = \"kone\",\n\t\t.id_table = kone_devices,\n\t\t.probe = kone_probe,\n\t\t.remove = kone_remove,\n\t\t.raw_event = kone_raw_event\n};\n\nstatic int __init kone_init(void)\n{\n\tint retval;\n\n\t \n\tretval = class_register(&kone_class);\n\tif (retval)\n\t\treturn retval;\n\n\tretval = hid_register_driver(&kone_driver);\n\tif (retval)\n\t\tclass_unregister(&kone_class);\n\treturn retval;\n}\n\nstatic void __exit kone_exit(void)\n{\n\thid_unregister_driver(&kone_driver);\n\tclass_unregister(&kone_class);\n}\n\nmodule_init(kone_init);\nmodule_exit(kone_exit);\n\nMODULE_AUTHOR(\"Stefan Achatz\");\nMODULE_DESCRIPTION(\"USB Roccat Kone driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}