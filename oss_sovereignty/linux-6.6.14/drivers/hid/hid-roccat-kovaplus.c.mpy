{
  "module_name": "hid-roccat-kovaplus.c",
  "hash_id": "a1a51b90b52794491d0282a8639c7f5ba134773516c29f29079d048ac16456b0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-roccat-kovaplus.c",
  "human_readable_source": "\n \n\n \n\n \n\n#include <linux/device.h>\n#include <linux/input.h>\n#include <linux/hid.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/hid-roccat.h>\n#include \"hid-ids.h\"\n#include \"hid-roccat-common.h\"\n#include \"hid-roccat-kovaplus.h\"\n\nstatic uint profile_numbers[5] = {0, 1, 2, 3, 4};\n\nstatic uint kovaplus_convert_event_cpi(uint value)\n{\n\treturn (value == 7 ? 4 : (value == 4 ? 3 : value));\n}\n\nstatic void kovaplus_profile_activated(struct kovaplus_device *kovaplus,\n\t\tuint new_profile_index)\n{\n\tif (new_profile_index >= ARRAY_SIZE(kovaplus->profile_settings))\n\t\treturn;\n\tkovaplus->actual_profile = new_profile_index;\n\tkovaplus->actual_cpi = kovaplus->profile_settings[new_profile_index].cpi_startup_level;\n\tkovaplus->actual_x_sensitivity = kovaplus->profile_settings[new_profile_index].sensitivity_x;\n\tkovaplus->actual_y_sensitivity = kovaplus->profile_settings[new_profile_index].sensitivity_y;\n}\n\nstatic int kovaplus_send_control(struct usb_device *usb_dev, uint value,\n\t\tenum kovaplus_control_requests request)\n{\n\tint retval;\n\tstruct roccat_common2_control control;\n\n\tif ((request == KOVAPLUS_CONTROL_REQUEST_PROFILE_SETTINGS ||\n\t\t\trequest == KOVAPLUS_CONTROL_REQUEST_PROFILE_BUTTONS) &&\n\t\t\tvalue > 4)\n\t\treturn -EINVAL;\n\n\tcontrol.command = ROCCAT_COMMON_COMMAND_CONTROL;\n\tcontrol.value = value;\n\tcontrol.request = request;\n\n\tretval = roccat_common2_send(usb_dev, ROCCAT_COMMON_COMMAND_CONTROL,\n\t\t\t&control, sizeof(struct roccat_common2_control));\n\n\treturn retval;\n}\n\nstatic int kovaplus_select_profile(struct usb_device *usb_dev, uint number,\n\t\tenum kovaplus_control_requests request)\n{\n\treturn kovaplus_send_control(usb_dev, number, request);\n}\n\nstatic int kovaplus_get_profile_settings(struct usb_device *usb_dev,\n\t\tstruct kovaplus_profile_settings *buf, uint number)\n{\n\tint retval;\n\n\tretval = kovaplus_select_profile(usb_dev, number,\n\t\t\tKOVAPLUS_CONTROL_REQUEST_PROFILE_SETTINGS);\n\tif (retval)\n\t\treturn retval;\n\n\treturn roccat_common2_receive(usb_dev, KOVAPLUS_COMMAND_PROFILE_SETTINGS,\n\t\t\tbuf, KOVAPLUS_SIZE_PROFILE_SETTINGS);\n}\n\nstatic int kovaplus_get_profile_buttons(struct usb_device *usb_dev,\n\t\tstruct kovaplus_profile_buttons *buf, int number)\n{\n\tint retval;\n\n\tretval = kovaplus_select_profile(usb_dev, number,\n\t\t\tKOVAPLUS_CONTROL_REQUEST_PROFILE_BUTTONS);\n\tif (retval)\n\t\treturn retval;\n\n\treturn roccat_common2_receive(usb_dev, KOVAPLUS_COMMAND_PROFILE_BUTTONS,\n\t\t\tbuf, KOVAPLUS_SIZE_PROFILE_BUTTONS);\n}\n\n \nstatic int kovaplus_get_actual_profile(struct usb_device *usb_dev)\n{\n\tstruct kovaplus_actual_profile buf;\n\tint retval;\n\n\tretval = roccat_common2_receive(usb_dev, KOVAPLUS_COMMAND_ACTUAL_PROFILE,\n\t\t\t&buf, sizeof(struct kovaplus_actual_profile));\n\n\treturn retval ? retval : buf.actual_profile;\n}\n\nstatic int kovaplus_set_actual_profile(struct usb_device *usb_dev,\n\t\tint new_profile)\n{\n\tstruct kovaplus_actual_profile buf;\n\n\tbuf.command = KOVAPLUS_COMMAND_ACTUAL_PROFILE;\n\tbuf.size = sizeof(struct kovaplus_actual_profile);\n\tbuf.actual_profile = new_profile;\n\n\treturn roccat_common2_send_with_status(usb_dev,\n\t\t\tKOVAPLUS_COMMAND_ACTUAL_PROFILE,\n\t\t\t&buf, sizeof(struct kovaplus_actual_profile));\n}\n\nstatic ssize_t kovaplus_sysfs_read(struct file *fp, struct kobject *kobj,\n\t\tchar *buf, loff_t off, size_t count,\n\t\tsize_t real_size, uint command)\n{\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct kovaplus_device *kovaplus = hid_get_drvdata(dev_get_drvdata(dev));\n\tstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\n\tint retval;\n\n\tif (off >= real_size)\n\t\treturn 0;\n\n\tif (off != 0 || count != real_size)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&kovaplus->kovaplus_lock);\n\tretval = roccat_common2_receive(usb_dev, command, buf, real_size);\n\tmutex_unlock(&kovaplus->kovaplus_lock);\n\n\tif (retval)\n\t\treturn retval;\n\n\treturn real_size;\n}\n\nstatic ssize_t kovaplus_sysfs_write(struct file *fp, struct kobject *kobj,\n\t\tvoid const *buf, loff_t off, size_t count,\n\t\tsize_t real_size, uint command)\n{\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct kovaplus_device *kovaplus = hid_get_drvdata(dev_get_drvdata(dev));\n\tstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\n\tint retval;\n\n\tif (off != 0 || count != real_size)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&kovaplus->kovaplus_lock);\n\tretval = roccat_common2_send_with_status(usb_dev, command,\n\t\t\tbuf, real_size);\n\tmutex_unlock(&kovaplus->kovaplus_lock);\n\n\tif (retval)\n\t\treturn retval;\n\n\treturn real_size;\n}\n\n#define KOVAPLUS_SYSFS_W(thingy, THINGY) \\\nstatic ssize_t kovaplus_sysfs_write_ ## thingy(struct file *fp, \\\n\t\tstruct kobject *kobj, struct bin_attribute *attr, char *buf, \\\n\t\tloff_t off, size_t count) \\\n{ \\\n\treturn kovaplus_sysfs_write(fp, kobj, buf, off, count, \\\n\t\t\tKOVAPLUS_SIZE_ ## THINGY, KOVAPLUS_COMMAND_ ## THINGY); \\\n}\n\n#define KOVAPLUS_SYSFS_R(thingy, THINGY) \\\nstatic ssize_t kovaplus_sysfs_read_ ## thingy(struct file *fp, \\\n\t\tstruct kobject *kobj, struct bin_attribute *attr, char *buf, \\\n\t\tloff_t off, size_t count) \\\n{ \\\n\treturn kovaplus_sysfs_read(fp, kobj, buf, off, count, \\\n\t\t\tKOVAPLUS_SIZE_ ## THINGY, KOVAPLUS_COMMAND_ ## THINGY); \\\n}\n\n#define KOVAPLUS_SYSFS_RW(thingy, THINGY) \\\nKOVAPLUS_SYSFS_W(thingy, THINGY) \\\nKOVAPLUS_SYSFS_R(thingy, THINGY)\n\n#define KOVAPLUS_BIN_ATTRIBUTE_RW(thingy, THINGY) \\\nKOVAPLUS_SYSFS_RW(thingy, THINGY); \\\nstatic struct bin_attribute bin_attr_##thingy = { \\\n\t.attr = { .name = #thingy, .mode = 0660 }, \\\n\t.size = KOVAPLUS_SIZE_ ## THINGY, \\\n\t.read = kovaplus_sysfs_read_ ## thingy, \\\n\t.write = kovaplus_sysfs_write_ ## thingy \\\n}\n\n#define KOVAPLUS_BIN_ATTRIBUTE_W(thingy, THINGY) \\\nKOVAPLUS_SYSFS_W(thingy, THINGY); \\\nstatic struct bin_attribute bin_attr_##thingy = { \\\n\t.attr = { .name = #thingy, .mode = 0220 }, \\\n\t.size = KOVAPLUS_SIZE_ ## THINGY, \\\n\t.write = kovaplus_sysfs_write_ ## thingy \\\n}\nKOVAPLUS_BIN_ATTRIBUTE_W(control, CONTROL);\nKOVAPLUS_BIN_ATTRIBUTE_RW(info, INFO);\nKOVAPLUS_BIN_ATTRIBUTE_RW(profile_settings, PROFILE_SETTINGS);\nKOVAPLUS_BIN_ATTRIBUTE_RW(profile_buttons, PROFILE_BUTTONS);\n\nstatic ssize_t kovaplus_sysfs_read_profilex_settings(struct file *fp,\n\t\tstruct kobject *kobj, struct bin_attribute *attr, char *buf,\n\t\tloff_t off, size_t count)\n{\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\n\tssize_t retval;\n\n\tretval = kovaplus_select_profile(usb_dev, *(uint *)(attr->private),\n\t\t\tKOVAPLUS_CONTROL_REQUEST_PROFILE_SETTINGS);\n\tif (retval)\n\t\treturn retval;\n\n\treturn kovaplus_sysfs_read(fp, kobj, buf, off, count,\n\t\t\tKOVAPLUS_SIZE_PROFILE_SETTINGS,\n\t\t\tKOVAPLUS_COMMAND_PROFILE_SETTINGS);\n}\n\nstatic ssize_t kovaplus_sysfs_read_profilex_buttons(struct file *fp,\n\t\tstruct kobject *kobj, struct bin_attribute *attr, char *buf,\n\t\tloff_t off, size_t count)\n{\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\n\tssize_t retval;\n\n\tretval = kovaplus_select_profile(usb_dev, *(uint *)(attr->private),\n\t\t\tKOVAPLUS_CONTROL_REQUEST_PROFILE_BUTTONS);\n\tif (retval)\n\t\treturn retval;\n\n\treturn kovaplus_sysfs_read(fp, kobj, buf, off, count,\n\t\t\tKOVAPLUS_SIZE_PROFILE_BUTTONS,\n\t\t\tKOVAPLUS_COMMAND_PROFILE_BUTTONS);\n}\n\n#define PROFILE_ATTR(number)\t\t\t\t\t\t\\\nstatic struct bin_attribute bin_attr_profile##number##_settings = {\t\\\n\t.attr = { .name = \"profile\" #number \"_settings\", .mode = 0440 },\t\\\n\t.size = KOVAPLUS_SIZE_PROFILE_SETTINGS,\t\t\t\t\\\n\t.read = kovaplus_sysfs_read_profilex_settings,\t\t\t\\\n\t.private = &profile_numbers[number-1],\t\t\t\t\\\n};\t\t\t\t\t\t\t\t\t\\\nstatic struct bin_attribute bin_attr_profile##number##_buttons = {\t\\\n\t.attr = { .name = \"profile\" #number \"_buttons\", .mode = 0440 },\t\\\n\t.size = KOVAPLUS_SIZE_PROFILE_BUTTONS,\t\t\t\t\\\n\t.read = kovaplus_sysfs_read_profilex_buttons,\t\t\t\\\n\t.private = &profile_numbers[number-1],\t\t\t\t\\\n};\nPROFILE_ATTR(1);\nPROFILE_ATTR(2);\nPROFILE_ATTR(3);\nPROFILE_ATTR(4);\nPROFILE_ATTR(5);\n\nstatic ssize_t kovaplus_sysfs_show_actual_profile(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kovaplus_device *kovaplus =\n\t\t\thid_get_drvdata(dev_get_drvdata(dev->parent->parent));\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", kovaplus->actual_profile);\n}\n\nstatic ssize_t kovaplus_sysfs_set_actual_profile(struct device *dev,\n\t\tstruct device_attribute *attr, char const *buf, size_t size)\n{\n\tstruct kovaplus_device *kovaplus;\n\tstruct usb_device *usb_dev;\n\tunsigned long profile;\n\tint retval;\n\tstruct kovaplus_roccat_report roccat_report;\n\n\tdev = dev->parent->parent;\n\tkovaplus = hid_get_drvdata(dev_get_drvdata(dev));\n\tusb_dev = interface_to_usbdev(to_usb_interface(dev));\n\n\tretval = kstrtoul(buf, 10, &profile);\n\tif (retval)\n\t\treturn retval;\n\n\tif (profile >= 5)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&kovaplus->kovaplus_lock);\n\tretval = kovaplus_set_actual_profile(usb_dev, profile);\n\tif (retval) {\n\t\tmutex_unlock(&kovaplus->kovaplus_lock);\n\t\treturn retval;\n\t}\n\n\tkovaplus_profile_activated(kovaplus, profile);\n\n\troccat_report.type = KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_PROFILE_1;\n\troccat_report.profile = profile + 1;\n\troccat_report.button = 0;\n\troccat_report.data1 = profile + 1;\n\troccat_report.data2 = 0;\n\troccat_report_event(kovaplus->chrdev_minor,\n\t\t\t(uint8_t const *)&roccat_report);\n\n\tmutex_unlock(&kovaplus->kovaplus_lock);\n\n\treturn size;\n}\nstatic DEVICE_ATTR(actual_profile, 0660,\n\t\t   kovaplus_sysfs_show_actual_profile,\n\t\t   kovaplus_sysfs_set_actual_profile);\n\nstatic ssize_t kovaplus_sysfs_show_actual_cpi(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kovaplus_device *kovaplus =\n\t\t\thid_get_drvdata(dev_get_drvdata(dev->parent->parent));\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", kovaplus->actual_cpi);\n}\nstatic DEVICE_ATTR(actual_cpi, 0440, kovaplus_sysfs_show_actual_cpi, NULL);\n\nstatic ssize_t kovaplus_sysfs_show_actual_sensitivity_x(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kovaplus_device *kovaplus =\n\t\t\thid_get_drvdata(dev_get_drvdata(dev->parent->parent));\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", kovaplus->actual_x_sensitivity);\n}\nstatic DEVICE_ATTR(actual_sensitivity_x, 0440,\n\t\t   kovaplus_sysfs_show_actual_sensitivity_x, NULL);\n\nstatic ssize_t kovaplus_sysfs_show_actual_sensitivity_y(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kovaplus_device *kovaplus =\n\t\t\thid_get_drvdata(dev_get_drvdata(dev->parent->parent));\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", kovaplus->actual_y_sensitivity);\n}\nstatic DEVICE_ATTR(actual_sensitivity_y, 0440,\n\t\t   kovaplus_sysfs_show_actual_sensitivity_y, NULL);\n\nstatic ssize_t kovaplus_sysfs_show_firmware_version(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct kovaplus_device *kovaplus;\n\tstruct usb_device *usb_dev;\n\tstruct kovaplus_info info;\n\n\tdev = dev->parent->parent;\n\tkovaplus = hid_get_drvdata(dev_get_drvdata(dev));\n\tusb_dev = interface_to_usbdev(to_usb_interface(dev));\n\n\tmutex_lock(&kovaplus->kovaplus_lock);\n\troccat_common2_receive(usb_dev, KOVAPLUS_COMMAND_INFO,\n\t\t\t&info, KOVAPLUS_SIZE_INFO);\n\tmutex_unlock(&kovaplus->kovaplus_lock);\n\n\treturn snprintf(buf, PAGE_SIZE, \"%d\\n\", info.firmware_version);\n}\nstatic DEVICE_ATTR(firmware_version, 0440,\n\t\t   kovaplus_sysfs_show_firmware_version, NULL);\n\nstatic struct attribute *kovaplus_attrs[] = {\n\t&dev_attr_actual_cpi.attr,\n\t&dev_attr_firmware_version.attr,\n\t&dev_attr_actual_profile.attr,\n\t&dev_attr_actual_sensitivity_x.attr,\n\t&dev_attr_actual_sensitivity_y.attr,\n\tNULL,\n};\n\nstatic struct bin_attribute *kovaplus_bin_attributes[] = {\n\t&bin_attr_control,\n\t&bin_attr_info,\n\t&bin_attr_profile_settings,\n\t&bin_attr_profile_buttons,\n\t&bin_attr_profile1_settings,\n\t&bin_attr_profile2_settings,\n\t&bin_attr_profile3_settings,\n\t&bin_attr_profile4_settings,\n\t&bin_attr_profile5_settings,\n\t&bin_attr_profile1_buttons,\n\t&bin_attr_profile2_buttons,\n\t&bin_attr_profile3_buttons,\n\t&bin_attr_profile4_buttons,\n\t&bin_attr_profile5_buttons,\n\tNULL,\n};\n\nstatic const struct attribute_group kovaplus_group = {\n\t.attrs = kovaplus_attrs,\n\t.bin_attrs = kovaplus_bin_attributes,\n};\n\nstatic const struct attribute_group *kovaplus_groups[] = {\n\t&kovaplus_group,\n\tNULL,\n};\n\nstatic const struct class kovaplus_class = {\n\t.name = \"kovaplus\",\n\t.dev_groups = kovaplus_groups,\n};\n\nstatic int kovaplus_init_kovaplus_device_struct(struct usb_device *usb_dev,\n\t\tstruct kovaplus_device *kovaplus)\n{\n\tint retval, i;\n\tstatic uint wait = 70;  \n\n\tmutex_init(&kovaplus->kovaplus_lock);\n\n\tfor (i = 0; i < 5; ++i) {\n\t\tmsleep(wait);\n\t\tretval = kovaplus_get_profile_settings(usb_dev,\n\t\t\t\t&kovaplus->profile_settings[i], i);\n\t\tif (retval)\n\t\t\treturn retval;\n\n\t\tmsleep(wait);\n\t\tretval = kovaplus_get_profile_buttons(usb_dev,\n\t\t\t\t&kovaplus->profile_buttons[i], i);\n\t\tif (retval)\n\t\t\treturn retval;\n\t}\n\n\tmsleep(wait);\n\tretval = kovaplus_get_actual_profile(usb_dev);\n\tif (retval < 0)\n\t\treturn retval;\n\tkovaplus_profile_activated(kovaplus, retval);\n\n\treturn 0;\n}\n\nstatic int kovaplus_init_specials(struct hid_device *hdev)\n{\n\tstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\n\tstruct usb_device *usb_dev = interface_to_usbdev(intf);\n\tstruct kovaplus_device *kovaplus;\n\tint retval;\n\n\tif (intf->cur_altsetting->desc.bInterfaceProtocol\n\t\t\t== USB_INTERFACE_PROTOCOL_MOUSE) {\n\n\t\tkovaplus = kzalloc(sizeof(*kovaplus), GFP_KERNEL);\n\t\tif (!kovaplus) {\n\t\t\thid_err(hdev, \"can't alloc device descriptor\\n\");\n\t\t\treturn -ENOMEM;\n\t\t}\n\t\thid_set_drvdata(hdev, kovaplus);\n\n\t\tretval = kovaplus_init_kovaplus_device_struct(usb_dev, kovaplus);\n\t\tif (retval) {\n\t\t\thid_err(hdev, \"couldn't init struct kovaplus_device\\n\");\n\t\t\tgoto exit_free;\n\t\t}\n\n\t\tretval = roccat_connect(&kovaplus_class, hdev,\n\t\t\t\t\tsizeof(struct kovaplus_roccat_report));\n\t\tif (retval < 0) {\n\t\t\thid_err(hdev, \"couldn't init char dev\\n\");\n\t\t} else {\n\t\t\tkovaplus->chrdev_minor = retval;\n\t\t\tkovaplus->roccat_claimed = 1;\n\t\t}\n\n\t} else {\n\t\thid_set_drvdata(hdev, NULL);\n\t}\n\n\treturn 0;\nexit_free:\n\tkfree(kovaplus);\n\treturn retval;\n}\n\nstatic void kovaplus_remove_specials(struct hid_device *hdev)\n{\n\tstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\n\tstruct kovaplus_device *kovaplus;\n\n\tif (intf->cur_altsetting->desc.bInterfaceProtocol\n\t\t\t== USB_INTERFACE_PROTOCOL_MOUSE) {\n\t\tkovaplus = hid_get_drvdata(hdev);\n\t\tif (kovaplus->roccat_claimed)\n\t\t\troccat_disconnect(kovaplus->chrdev_minor);\n\t\tkfree(kovaplus);\n\t}\n}\n\nstatic int kovaplus_probe(struct hid_device *hdev,\n\t\tconst struct hid_device_id *id)\n{\n\tint retval;\n\n\tif (!hid_is_usb(hdev))\n\t\treturn -EINVAL;\n\n\tretval = hid_parse(hdev);\n\tif (retval) {\n\t\thid_err(hdev, \"parse failed\\n\");\n\t\tgoto exit;\n\t}\n\n\tretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\n\tif (retval) {\n\t\thid_err(hdev, \"hw start failed\\n\");\n\t\tgoto exit;\n\t}\n\n\tretval = kovaplus_init_specials(hdev);\n\tif (retval) {\n\t\thid_err(hdev, \"couldn't install mouse\\n\");\n\t\tgoto exit_stop;\n\t}\n\n\treturn 0;\n\nexit_stop:\n\thid_hw_stop(hdev);\nexit:\n\treturn retval;\n}\n\nstatic void kovaplus_remove(struct hid_device *hdev)\n{\n\tkovaplus_remove_specials(hdev);\n\thid_hw_stop(hdev);\n}\n\nstatic void kovaplus_keep_values_up_to_date(struct kovaplus_device *kovaplus,\n\t\tu8 const *data)\n{\n\tstruct kovaplus_mouse_report_button const *button_report;\n\n\tif (data[0] != KOVAPLUS_MOUSE_REPORT_NUMBER_BUTTON)\n\t\treturn;\n\n\tbutton_report = (struct kovaplus_mouse_report_button const *)data;\n\n\tswitch (button_report->type) {\n\tcase KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_PROFILE_1:\n\t\tkovaplus_profile_activated(kovaplus, button_report->data1 - 1);\n\t\tbreak;\n\tcase KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_CPI:\n\t\tkovaplus->actual_cpi = kovaplus_convert_event_cpi(button_report->data1);\n\t\tbreak;\n\tcase KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_SENSITIVITY:\n\t\tkovaplus->actual_x_sensitivity = button_report->data1;\n\t\tkovaplus->actual_y_sensitivity = button_report->data2;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void kovaplus_report_to_chrdev(struct kovaplus_device const *kovaplus,\n\t\tu8 const *data)\n{\n\tstruct kovaplus_roccat_report roccat_report;\n\tstruct kovaplus_mouse_report_button const *button_report;\n\n\tif (data[0] != KOVAPLUS_MOUSE_REPORT_NUMBER_BUTTON)\n\t\treturn;\n\n\tbutton_report = (struct kovaplus_mouse_report_button const *)data;\n\n\tif (button_report->type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_PROFILE_2)\n\t\treturn;\n\n\troccat_report.type = button_report->type;\n\troccat_report.profile = kovaplus->actual_profile + 1;\n\n\tif (roccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_MACRO ||\n\t\t\troccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_SHORTCUT ||\n\t\t\troccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_QUICKLAUNCH ||\n\t\t\troccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_TIMER)\n\t\troccat_report.button = button_report->data1;\n\telse\n\t\troccat_report.button = 0;\n\n\tif (roccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_CPI)\n\t\troccat_report.data1 = kovaplus_convert_event_cpi(button_report->data1);\n\telse\n\t\troccat_report.data1 = button_report->data1;\n\n\troccat_report.data2 = button_report->data2;\n\n\troccat_report_event(kovaplus->chrdev_minor,\n\t\t\t(uint8_t const *)&roccat_report);\n}\n\nstatic int kovaplus_raw_event(struct hid_device *hdev,\n\t\tstruct hid_report *report, u8 *data, int size)\n{\n\tstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\n\tstruct kovaplus_device *kovaplus = hid_get_drvdata(hdev);\n\n\tif (intf->cur_altsetting->desc.bInterfaceProtocol\n\t\t\t!= USB_INTERFACE_PROTOCOL_MOUSE)\n\t\treturn 0;\n\n\tif (kovaplus == NULL)\n\t\treturn 0;\n\n\tkovaplus_keep_values_up_to_date(kovaplus, data);\n\n\tif (kovaplus->roccat_claimed)\n\t\tkovaplus_report_to_chrdev(kovaplus, data);\n\n\treturn 0;\n}\n\nstatic const struct hid_device_id kovaplus_devices[] = {\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_ROCCAT, USB_DEVICE_ID_ROCCAT_KOVAPLUS) },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(hid, kovaplus_devices);\n\nstatic struct hid_driver kovaplus_driver = {\n\t\t.name = \"kovaplus\",\n\t\t.id_table = kovaplus_devices,\n\t\t.probe = kovaplus_probe,\n\t\t.remove = kovaplus_remove,\n\t\t.raw_event = kovaplus_raw_event\n};\n\nstatic int __init kovaplus_init(void)\n{\n\tint retval;\n\n\tretval = class_register(&kovaplus_class);\n\tif (retval)\n\t\treturn retval;\n\n\tretval = hid_register_driver(&kovaplus_driver);\n\tif (retval)\n\t\tclass_unregister(&kovaplus_class);\n\treturn retval;\n}\n\nstatic void __exit kovaplus_exit(void)\n{\n\thid_unregister_driver(&kovaplus_driver);\n\tclass_unregister(&kovaplus_class);\n}\n\nmodule_init(kovaplus_init);\nmodule_exit(kovaplus_exit);\n\nMODULE_AUTHOR(\"Stefan Achatz\");\nMODULE_DESCRIPTION(\"USB Roccat Kova[+] driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}