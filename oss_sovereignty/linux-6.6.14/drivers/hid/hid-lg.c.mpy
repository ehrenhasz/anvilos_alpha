{
  "module_name": "hid-lg.c",
  "hash_id": "58b39f567f477ed54d1f57cfdca3dcf248547bfc02687736f293a7fc7207bf0a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-lg.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/device.h>\n#include <linux/hid.h>\n#include <linux/module.h>\n#include <linux/random.h>\n#include <linux/sched.h>\n#include <linux/usb.h>\n#include <linux/wait.h>\n\n#include \"usbhid/usbhid.h\"\n#include \"hid-ids.h\"\n#include \"hid-lg.h\"\n#include \"hid-lg4ff.h\"\n\n#define LG_RDESC\t\t0x001\n#define LG_BAD_RELATIVE_KEYS\t0x002\n#define LG_DUPLICATE_USAGES\t0x004\n#define LG_EXPANDED_KEYMAP\t0x010\n#define LG_IGNORE_DOUBLED_WHEEL\t0x020\n#define LG_WIRELESS\t\t0x040\n#define LG_INVERT_HWHEEL\t0x080\n#define LG_NOGET\t\t0x100\n#define LG_FF\t\t\t0x200\n#define LG_FF2\t\t\t0x400\n#define LG_RDESC_REL_ABS\t0x800\n#define LG_FF3\t\t\t0x1000\n#define LG_FF4\t\t\t0x2000\n\n \n#define DF_RDESC_ORIG_SIZE\t130\n#define DFP_RDESC_ORIG_SIZE\t97\n#define FV_RDESC_ORIG_SIZE\t130\n#define MOMO_RDESC_ORIG_SIZE\t87\n#define MOMO2_RDESC_ORIG_SIZE\t87\n#define FFG_RDESC_ORIG_SIZE\t85\n#define FG_RDESC_ORIG_SIZE\t82\n\n \nstatic __u8 df_rdesc_fixed[] = {\n0x05, 0x01,          \n0x09, 0x04,          \n0xA1, 0x01,          \n0xA1, 0x02,          \n0x95, 0x01,          \n0x75, 0x0A,          \n0x14,                \n0x26, 0xFF, 0x03,    \n0x34,                \n0x46, 0xFF, 0x03,    \n0x09, 0x30,          \n0x81, 0x02,          \n0x95, 0x0C,          \n0x75, 0x01,          \n0x25, 0x01,          \n0x45, 0x01,          \n0x05, 0x09,          \n0x19, 0x01,          \n0x29, 0x0c,          \n0x81, 0x02,          \n0x95, 0x02,          \n0x06, 0x00, 0xFF,    \n0x09, 0x01,          \n0x81, 0x02,          \n0x05, 0x01,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x95, 0x01,          \n0x75, 0x08,          \n0x81, 0x02,          \n0x25, 0x07,          \n0x46, 0x3B, 0x01,    \n0x75, 0x04,          \n0x65, 0x14,          \n0x09, 0x39,          \n0x81, 0x42,          \n0x75, 0x01,          \n0x95, 0x04,          \n0x65, 0x00,          \n0x06, 0x00, 0xFF,    \n0x09, 0x01,          \n0x25, 0x01,          \n0x45, 0x01,          \n0x81, 0x02,          \n0x05, 0x01,          \n0x95, 0x01,          \n0x75, 0x08,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x09, 0x31,          \n0x81, 0x02,          \n0x09, 0x35,          \n0x81, 0x02,          \n0xC0,                \n0xA1, 0x02,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x95, 0x07,          \n0x75, 0x08,          \n0x09, 0x03,          \n0x91, 0x02,          \n0xC0,                \n0xC0                 \n};\n\nstatic __u8 dfp_rdesc_fixed[] = {\n0x05, 0x01,          \n0x09, 0x04,          \n0xA1, 0x01,          \n0xA1, 0x02,          \n0x95, 0x01,          \n0x75, 0x0E,          \n0x14,                \n0x26, 0xFF, 0x3F,    \n0x34,                \n0x46, 0xFF, 0x3F,    \n0x09, 0x30,          \n0x81, 0x02,          \n0x95, 0x0E,          \n0x75, 0x01,          \n0x25, 0x01,          \n0x45, 0x01,          \n0x05, 0x09,          \n0x19, 0x01,          \n0x29, 0x0E,          \n0x81, 0x02,          \n0x05, 0x01,          \n0x95, 0x01,          \n0x75, 0x04,          \n0x25, 0x07,          \n0x46, 0x3B, 0x01,    \n0x65, 0x14,          \n0x09, 0x39,          \n0x81, 0x42,          \n0x65, 0x00,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x75, 0x08,          \n0x81, 0x01,          \n0x09, 0x31,          \n0x81, 0x02,          \n0x09, 0x35,          \n0x81, 0x02,          \n0x81, 0x01,          \n0xC0,                \n0xA1, 0x02,          \n0x09, 0x02,          \n0x95, 0x07,          \n0x91, 0x02,          \n0xC0,                \n0xC0                 \n};\n\nstatic __u8 fv_rdesc_fixed[] = {\n0x05, 0x01,          \n0x09, 0x04,          \n0xA1, 0x01,          \n0xA1, 0x02,          \n0x95, 0x01,          \n0x75, 0x0A,          \n0x15, 0x00,          \n0x26, 0xFF, 0x03,    \n0x35, 0x00,          \n0x46, 0xFF, 0x03,    \n0x09, 0x30,          \n0x81, 0x02,          \n0x95, 0x0C,          \n0x75, 0x01,          \n0x25, 0x01,          \n0x45, 0x01,          \n0x05, 0x09,          \n0x19, 0x01,          \n0x29, 0x0C,          \n0x81, 0x02,          \n0x95, 0x02,          \n0x06, 0x00, 0xFF,    \n0x09, 0x01,          \n0x81, 0x02,          \n0x09, 0x02,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x95, 0x01,          \n0x75, 0x08,          \n0x81, 0x02,          \n0x05, 0x01,          \n0x25, 0x07,          \n0x46, 0x3B, 0x01,    \n0x75, 0x04,          \n0x65, 0x14,          \n0x09, 0x39,          \n0x81, 0x42,          \n0x75, 0x01,          \n0x95, 0x04,          \n0x65, 0x00,          \n0x06, 0x00, 0xFF,    \n0x09, 0x01,          \n0x25, 0x01,          \n0x45, 0x01,          \n0x81, 0x02,          \n0x05, 0x01,          \n0x95, 0x01,          \n0x75, 0x08,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x09, 0x31,          \n0x81, 0x02,          \n0x09, 0x32,          \n0x81, 0x02,          \n0xC0,                \n0xA1, 0x02,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x95, 0x07,          \n0x75, 0x08,          \n0x09, 0x03,          \n0x91, 0x02,          \n0xC0,                \n0xC0                 \n};\n\nstatic __u8 momo_rdesc_fixed[] = {\n0x05, 0x01,          \n0x09, 0x04,          \n0xA1, 0x01,          \n0xA1, 0x02,          \n0x95, 0x01,          \n0x75, 0x0A,          \n0x15, 0x00,          \n0x26, 0xFF, 0x03,    \n0x35, 0x00,          \n0x46, 0xFF, 0x03,    \n0x09, 0x30,          \n0x81, 0x02,          \n0x95, 0x08,          \n0x75, 0x01,          \n0x25, 0x01,          \n0x45, 0x01,          \n0x05, 0x09,          \n0x19, 0x01,          \n0x29, 0x08,          \n0x81, 0x02,          \n0x06, 0x00, 0xFF,    \n0x75, 0x0E,          \n0x95, 0x01,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x09, 0x00,          \n0x81, 0x02,          \n0x05, 0x01,          \n0x75, 0x08,          \n0x09, 0x31,          \n0x81, 0x02,          \n0x09, 0x32,          \n0x81, 0x02,          \n0x06, 0x00, 0xFF,    \n0x09, 0x01,          \n0x81, 0x02,          \n0xC0,                \n0xA1, 0x02,          \n0x09, 0x02,          \n0x95, 0x07,          \n0x91, 0x02,          \n0xC0,                \n0xC0                 \n};\n\nstatic __u8 momo2_rdesc_fixed[] = {\n0x05, 0x01,          \n0x09, 0x04,          \n0xA1, 0x01,          \n0xA1, 0x02,          \n0x95, 0x01,          \n0x75, 0x0A,          \n0x15, 0x00,          \n0x26, 0xFF, 0x03,    \n0x35, 0x00,          \n0x46, 0xFF, 0x03,    \n0x09, 0x30,          \n0x81, 0x02,          \n0x95, 0x0A,          \n0x75, 0x01,          \n0x25, 0x01,          \n0x45, 0x01,          \n0x05, 0x09,          \n0x19, 0x01,          \n0x29, 0x0A,          \n0x81, 0x02,          \n0x06, 0x00, 0xFF,    \n0x09, 0x00,          \n0x95, 0x04,          \n0x81, 0x02,          \n0x95, 0x01,          \n0x75, 0x08,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x09, 0x01,          \n0x81, 0x02,          \n0x05, 0x01,          \n0x09, 0x31,          \n0x81, 0x02,          \n0x09, 0x32,          \n0x81, 0x02,          \n0x06, 0x00, 0xFF,    \n0x09, 0x00,          \n0x81, 0x02,          \n0xC0,                \n0xA1, 0x02,          \n0x09, 0x02,          \n0x95, 0x07,          \n0x91, 0x02,          \n0xC0,                \n0xC0                 \n};\n\nstatic __u8 ffg_rdesc_fixed[] = {\n0x05, 0x01,          \n0x09, 0x04,          \n0xA1, 0x01,          \n0xA1, 0x02,          \n0x95, 0x01,          \n0x75, 0x0A,          \n0x15, 0x00,          \n0x26, 0xFF, 0x03,    \n0x35, 0x00,          \n0x46, 0xFF, 0x03,    \n0x09, 0x30,          \n0x81, 0x02,          \n0x95, 0x06,          \n0x75, 0x01,          \n0x25, 0x01,          \n0x45, 0x01,          \n0x05, 0x09,          \n0x19, 0x01,          \n0x29, 0x06,          \n0x81, 0x02,          \n0x95, 0x01,          \n0x75, 0x08,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x06, 0x00, 0xFF,    \n0x09, 0x01,          \n0x81, 0x02,          \n0x05, 0x01,          \n0x81, 0x01,          \n0x09, 0x31,          \n0x81, 0x02,          \n0x09, 0x32,          \n0x81, 0x02,          \n0x06, 0x00, 0xFF,    \n0x09, 0x01,          \n0x81, 0x02,          \n0xC0,                \n0xA1, 0x02,          \n0x09, 0x02,          \n0x95, 0x07,          \n0x91, 0x02,          \n0xC0,                \n0xC0                 \n};\n\nstatic __u8 fg_rdesc_fixed[] = {\n0x05, 0x01,          \n0x09, 0x04,          \n0xA1, 0x01,          \n0xA1, 0x02,          \n0x15, 0x00,          \n0x26, 0xFF, 0x00,    \n0x35, 0x00,          \n0x46, 0xFF, 0x00,    \n0x75, 0x08,          \n0x95, 0x01,          \n0x09, 0x30,          \n0x81, 0x02,          \n0xA4,                \n0x25, 0x01,          \n0x45, 0x01,          \n0x75, 0x01,          \n0x95, 0x02,          \n0x81, 0x01,          \n0x95, 0x06,          \n0x05, 0x09,          \n0x19, 0x01,          \n0x29, 0x06,          \n0x81, 0x02,          \n0x05, 0x01,          \n0xB4,                \n0x81, 0x02,          \n0x09, 0x31,          \n0x81, 0x02,          \n0x09, 0x32,          \n0x81, 0x02,          \n0xC0,                \n0xA1, 0x02,          \n0x26, 0xFF, 0x00,    \n0x46, 0xFF, 0x00,    \n0x75, 0x08,          \n0x95, 0x04,          \n0x09, 0x02,          \n0xB1, 0x02,          \n0xC0,                \n0xC0                 \n};\n\n \nstatic __u8 *lg_report_fixup(struct hid_device *hdev, __u8 *rdesc,\n\t\tunsigned int *rsize)\n{\n\tstruct lg_drv_data *drv_data = hid_get_drvdata(hdev);\n\n\tif ((drv_data->quirks & LG_RDESC) && *rsize >= 91 && rdesc[83] == 0x26 &&\n\t\t\trdesc[84] == 0x8c && rdesc[85] == 0x02) {\n\t\thid_info(hdev,\n\t\t\t \"fixing up Logitech keyboard report descriptor\\n\");\n\t\trdesc[84] = rdesc[89] = 0x4d;\n\t\trdesc[85] = rdesc[90] = 0x10;\n\t}\n\tif ((drv_data->quirks & LG_RDESC_REL_ABS) && *rsize >= 51 &&\n\t\t\trdesc[32] == 0x81 && rdesc[33] == 0x06 &&\n\t\t\trdesc[49] == 0x81 && rdesc[50] == 0x06) {\n\t\thid_info(hdev,\n\t\t\t \"fixing up rel/abs in Logitech report descriptor\\n\");\n\t\trdesc[33] = rdesc[50] = 0x02;\n\t}\n\n\tswitch (hdev->product) {\n\n\tcase USB_DEVICE_ID_LOGITECH_WINGMAN_FG:\n\t\tif (*rsize == FG_RDESC_ORIG_SIZE) {\n\t\t\thid_info(hdev,\n\t\t\t\t\"fixing up Logitech Wingman Formula GP report descriptor\\n\");\n\t\t\trdesc = fg_rdesc_fixed;\n\t\t\t*rsize = sizeof(fg_rdesc_fixed);\n\t\t} else {\n\t\t\thid_info(hdev,\n\t\t\t\t\"rdesc size test failed for formula gp\\n\");\n\t\t}\n\t\tbreak;\n\n\n\tcase USB_DEVICE_ID_LOGITECH_WINGMAN_FFG:\n\t\tif (*rsize == FFG_RDESC_ORIG_SIZE) {\n\t\t\thid_info(hdev,\n\t\t\t\t\"fixing up Logitech Wingman Formula Force GP report descriptor\\n\");\n\t\t\trdesc = ffg_rdesc_fixed;\n\t\t\t*rsize = sizeof(ffg_rdesc_fixed);\n\t\t}\n\t\tbreak;\n\n\t \n\tcase USB_DEVICE_ID_LOGITECH_WHEEL:\n\t\tif (*rsize == DF_RDESC_ORIG_SIZE) {\n\t\t\thid_info(hdev,\n\t\t\t\t\"fixing up Logitech Driving Force report descriptor\\n\");\n\t\t\trdesc = df_rdesc_fixed;\n\t\t\t*rsize = sizeof(df_rdesc_fixed);\n\t\t}\n\t\tbreak;\n\n\tcase USB_DEVICE_ID_LOGITECH_MOMO_WHEEL:\n\t\tif (*rsize == MOMO_RDESC_ORIG_SIZE) {\n\t\t\thid_info(hdev,\n\t\t\t\t\"fixing up Logitech Momo Force (Red) report descriptor\\n\");\n\t\t\trdesc = momo_rdesc_fixed;\n\t\t\t*rsize = sizeof(momo_rdesc_fixed);\n\t\t}\n\t\tbreak;\n\n\tcase USB_DEVICE_ID_LOGITECH_MOMO_WHEEL2:\n\t\tif (*rsize == MOMO2_RDESC_ORIG_SIZE) {\n\t\t\thid_info(hdev,\n\t\t\t\t\"fixing up Logitech Momo Racing Force (Black) report descriptor\\n\");\n\t\t\trdesc = momo2_rdesc_fixed;\n\t\t\t*rsize = sizeof(momo2_rdesc_fixed);\n\t\t}\n\t\tbreak;\n\n\tcase USB_DEVICE_ID_LOGITECH_VIBRATION_WHEEL:\n\t\tif (*rsize == FV_RDESC_ORIG_SIZE) {\n\t\t\thid_info(hdev,\n\t\t\t\t\"fixing up Logitech Formula Vibration report descriptor\\n\");\n\t\t\trdesc = fv_rdesc_fixed;\n\t\t\t*rsize = sizeof(fv_rdesc_fixed);\n\t\t}\n\t\tbreak;\n\n\tcase USB_DEVICE_ID_LOGITECH_DFP_WHEEL:\n\t\tif (*rsize == DFP_RDESC_ORIG_SIZE) {\n\t\t\thid_info(hdev,\n\t\t\t\t\"fixing up Logitech Driving Force Pro report descriptor\\n\");\n\t\t\trdesc = dfp_rdesc_fixed;\n\t\t\t*rsize = sizeof(dfp_rdesc_fixed);\n\t\t}\n\t\tbreak;\n\n\tcase USB_DEVICE_ID_LOGITECH_WII_WHEEL:\n\t\tif (*rsize >= 101 && rdesc[41] == 0x95 && rdesc[42] == 0x0B &&\n\t\t\t\trdesc[47] == 0x05 && rdesc[48] == 0x09) {\n\t\t\thid_info(hdev, \"fixing up Logitech Speed Force Wireless report descriptor\\n\");\n\t\t\trdesc[41] = 0x05;\n\t\t\trdesc[42] = 0x09;\n\t\t\trdesc[47] = 0x95;\n\t\t\trdesc[48] = 0x0B;\n\t\t}\n\t\tbreak;\n\t}\n\n\treturn rdesc;\n}\n\n#define lg_map_key_clear(c)\thid_map_usage_clear(hi, usage, bit, max, \\\n\t\tEV_KEY, (c))\n\nstatic int lg_ultrax_remote_mapping(struct hid_input *hi,\n\t\tstruct hid_usage *usage, unsigned long **bit, int *max)\n{\n\tif ((usage->hid & HID_USAGE_PAGE) != HID_UP_LOGIVENDOR)\n\t\treturn 0;\n\n\tset_bit(EV_REP, hi->input->evbit);\n\tswitch (usage->hid & HID_USAGE) {\n\t \n\tcase 0x004: lg_map_key_clear(KEY_AGAIN);\tbreak;\n\tcase 0x00d: lg_map_key_clear(KEY_HOME);\t\tbreak;\n\tcase 0x024: lg_map_key_clear(KEY_SHUFFLE);\tbreak;\n\tcase 0x025: lg_map_key_clear(KEY_TV);\t\tbreak;\n\tcase 0x026: lg_map_key_clear(KEY_MENU);\t\tbreak;\n\tcase 0x031: lg_map_key_clear(KEY_AUDIO);\tbreak;\n\tcase 0x032: lg_map_key_clear(KEY_TEXT);\t\tbreak;\n\tcase 0x033: lg_map_key_clear(KEY_LAST);\t\tbreak;\n\tcase 0x047: lg_map_key_clear(KEY_MP3);\t\tbreak;\n\tcase 0x048: lg_map_key_clear(KEY_DVD);\t\tbreak;\n\tcase 0x049: lg_map_key_clear(KEY_MEDIA);\tbreak;\n\tcase 0x04a: lg_map_key_clear(KEY_VIDEO);\tbreak;\n\tcase 0x04b: lg_map_key_clear(KEY_ANGLE);\tbreak;\n\tcase 0x04c: lg_map_key_clear(KEY_LANGUAGE);\tbreak;\n\tcase 0x04d: lg_map_key_clear(KEY_SUBTITLE);\tbreak;\n\tcase 0x051: lg_map_key_clear(KEY_RED);\t\tbreak;\n\tcase 0x052: lg_map_key_clear(KEY_CLOSE);\tbreak;\n\n\tdefault:\n\t\treturn 0;\n\t}\n\treturn 1;\n}\n\nstatic int lg_wireless_mapping(struct hid_input *hi, struct hid_usage *usage,\n\t\tunsigned long **bit, int *max)\n{\n\tif ((usage->hid & HID_USAGE_PAGE) != HID_UP_CONSUMER)\n\t\treturn 0;\n\n\tswitch (usage->hid & HID_USAGE) {\n\tcase 0x1001: lg_map_key_clear(KEY_MESSENGER);\t\tbreak;\n\tcase 0x1003: lg_map_key_clear(KEY_SOUND);\t\tbreak;\n\tcase 0x1004: lg_map_key_clear(KEY_VIDEO);\t\tbreak;\n\tcase 0x1005: lg_map_key_clear(KEY_AUDIO);\t\tbreak;\n\tcase 0x100a: lg_map_key_clear(KEY_DOCUMENTS);\t\tbreak;\n\t \n\tcase 0x100f: lg_map_key_clear(KEY_FN_1);\t\tbreak;\n\tcase 0x1010: lg_map_key_clear(KEY_FN_2);\t\tbreak;\n\tcase 0x1011: lg_map_key_clear(KEY_PREVIOUSSONG);\tbreak;\n\tcase 0x1012: lg_map_key_clear(KEY_NEXTSONG);\t\tbreak;\n\tcase 0x1013: lg_map_key_clear(KEY_CAMERA);\t\tbreak;\n\tcase 0x1014: lg_map_key_clear(KEY_MESSENGER);\t\tbreak;\n\tcase 0x1015: lg_map_key_clear(KEY_RECORD);\t\tbreak;\n\tcase 0x1016: lg_map_key_clear(KEY_PLAYER);\t\tbreak;\n\tcase 0x1017: lg_map_key_clear(KEY_EJECTCD);\t\tbreak;\n\tcase 0x1018: lg_map_key_clear(KEY_MEDIA);\t\tbreak;\n\tcase 0x1019: lg_map_key_clear(KEY_PROG1);\t\tbreak;\n\tcase 0x101a: lg_map_key_clear(KEY_PROG2);\t\tbreak;\n\tcase 0x101b: lg_map_key_clear(KEY_PROG3);\t\tbreak;\n\tcase 0x101c: lg_map_key_clear(KEY_CYCLEWINDOWS);\tbreak;\n\tcase 0x101f: lg_map_key_clear(KEY_ZOOMIN);\t\tbreak;\n\tcase 0x1020: lg_map_key_clear(KEY_ZOOMOUT);\t\tbreak;\n\tcase 0x1021: lg_map_key_clear(KEY_ZOOMRESET);\t\tbreak;\n\tcase 0x1023: lg_map_key_clear(KEY_CLOSE);\t\tbreak;\n\tcase 0x1027: lg_map_key_clear(KEY_MENU);\t\tbreak;\n\t \n\tcase 0x1028: lg_map_key_clear(KEY_ANGLE);\t\tbreak;\n\tcase 0x1029: lg_map_key_clear(KEY_SHUFFLE);\t\tbreak;\n\tcase 0x102a: lg_map_key_clear(KEY_BACK);\t\tbreak;\n\tcase 0x102b: lg_map_key_clear(KEY_CYCLEWINDOWS);\tbreak;\n\tcase 0x102d: lg_map_key_clear(KEY_WWW);\t\t\tbreak;\n\t \n\tcase 0x1031: lg_map_key_clear(KEY_OK);\t\t\tbreak;\n\tcase 0x1032: lg_map_key_clear(KEY_CANCEL);\t\tbreak;\n\tcase 0x1041: lg_map_key_clear(KEY_BATTERY);\t\tbreak;\n\tcase 0x1042: lg_map_key_clear(KEY_WORDPROCESSOR);\tbreak;\n\tcase 0x1043: lg_map_key_clear(KEY_SPREADSHEET);\t\tbreak;\n\tcase 0x1044: lg_map_key_clear(KEY_PRESENTATION);\tbreak;\n\tcase 0x1045: lg_map_key_clear(KEY_UNDO);\t\tbreak;\n\tcase 0x1046: lg_map_key_clear(KEY_REDO);\t\tbreak;\n\tcase 0x1047: lg_map_key_clear(KEY_PRINT);\t\tbreak;\n\tcase 0x1048: lg_map_key_clear(KEY_SAVE);\t\tbreak;\n\tcase 0x1049: lg_map_key_clear(KEY_PROG1);\t\tbreak;\n\tcase 0x104a: lg_map_key_clear(KEY_PROG2);\t\tbreak;\n\tcase 0x104b: lg_map_key_clear(KEY_PROG3);\t\tbreak;\n\tcase 0x104c: lg_map_key_clear(KEY_PROG4);\t\tbreak;\n\n\tdefault:\n\t\treturn 0;\n\t}\n\treturn 1;\n}\n\nstatic int lg_input_mapping(struct hid_device *hdev, struct hid_input *hi,\n\t\tstruct hid_field *field, struct hid_usage *usage,\n\t\tunsigned long **bit, int *max)\n{\n\t \n\tstatic const u8 e_keymap[] = {\n\t\t  0,216,  0,213,175,156,  0,  0,  0,  0,\n\t\t144,  0,  0,  0,  0,  0,  0,  0,  0,212,\n\t\t174,167,152,161,112,  0,  0,  0,154,  0,\n\t\t  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,\n\t\t  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,\n\t\t  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,\n\t\t  0,  0,  0,  0,  0,183,184,185,186,187,\n\t\t188,189,190,191,192,193,194,  0,  0,  0\n\t};\n\tstruct lg_drv_data *drv_data = hid_get_drvdata(hdev);\n\tunsigned int hid = usage->hid;\n\n\tif (hdev->product == USB_DEVICE_ID_LOGITECH_RECEIVER &&\n\t\t\tlg_ultrax_remote_mapping(hi, usage, bit, max))\n\t\treturn 1;\n\n\tif ((drv_data->quirks & LG_WIRELESS) && lg_wireless_mapping(hi, usage, bit, max))\n\t\treturn 1;\n\n\tif ((hid & HID_USAGE_PAGE) != HID_UP_BUTTON)\n\t\treturn 0;\n\n\thid &= HID_USAGE;\n\n\t \n\tif (field->application == HID_GD_MOUSE) {\n\t\tif ((drv_data->quirks & LG_IGNORE_DOUBLED_WHEEL) &&\n\t\t\t\t(hid == 7 || hid == 8))\n\t\t\treturn -1;\n\t} else {\n\t\tif ((drv_data->quirks & LG_EXPANDED_KEYMAP) &&\n\t\t\t\thid < ARRAY_SIZE(e_keymap) &&\n\t\t\t\te_keymap[hid] != 0) {\n\t\t\thid_map_usage(hi, usage, bit, max, EV_KEY,\n\t\t\t\t\te_keymap[hid]);\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int lg_input_mapped(struct hid_device *hdev, struct hid_input *hi,\n\t\tstruct hid_field *field, struct hid_usage *usage,\n\t\tunsigned long **bit, int *max)\n{\n\tstruct lg_drv_data *drv_data = hid_get_drvdata(hdev);\n\n\tif ((drv_data->quirks & LG_BAD_RELATIVE_KEYS) && usage->type == EV_KEY &&\n\t\t\t(field->flags & HID_MAIN_ITEM_RELATIVE))\n\t\tfield->flags &= ~HID_MAIN_ITEM_RELATIVE;\n\n\tif ((drv_data->quirks & LG_DUPLICATE_USAGES) && (usage->type == EV_KEY ||\n\t\t\t usage->type == EV_REL || usage->type == EV_ABS))\n\t\tclear_bit(usage->code, *bit);\n\n\t \n\tif (usage->type == EV_ABS && (usage->code == ABS_X ||\n\t\t\tusage->code == ABS_Y || usage->code == ABS_Z ||\n\t\t\tusage->code == ABS_RZ)) {\n\t\tswitch (hdev->product) {\n\t\tcase USB_DEVICE_ID_LOGITECH_G29_WHEEL:\n\t\tcase USB_DEVICE_ID_LOGITECH_WINGMAN_FG:\n\t\tcase USB_DEVICE_ID_LOGITECH_WINGMAN_FFG:\n\t\tcase USB_DEVICE_ID_LOGITECH_WHEEL:\n\t\tcase USB_DEVICE_ID_LOGITECH_MOMO_WHEEL:\n\t\tcase USB_DEVICE_ID_LOGITECH_DFP_WHEEL:\n\t\tcase USB_DEVICE_ID_LOGITECH_G25_WHEEL:\n\t\tcase USB_DEVICE_ID_LOGITECH_DFGT_WHEEL:\n\t\tcase USB_DEVICE_ID_LOGITECH_G27_WHEEL:\n\t\tcase USB_DEVICE_ID_LOGITECH_WII_WHEEL:\n\t\tcase USB_DEVICE_ID_LOGITECH_MOMO_WHEEL2:\n\t\tcase USB_DEVICE_ID_LOGITECH_VIBRATION_WHEEL:\n\t\t\tfield->application = HID_GD_MULTIAXIS;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int lg_event(struct hid_device *hdev, struct hid_field *field,\n\t\tstruct hid_usage *usage, __s32 value)\n{\n\tstruct lg_drv_data *drv_data = hid_get_drvdata(hdev);\n\n\tif ((drv_data->quirks & LG_INVERT_HWHEEL) && usage->code == REL_HWHEEL) {\n\t\tinput_event(field->hidinput->input, usage->type, usage->code,\n\t\t\t\t-value);\n\t\treturn 1;\n\t}\n\tif (drv_data->quirks & LG_FF4) {\n\t\treturn lg4ff_adjust_input_event(hdev, field, usage, value, drv_data);\n\t}\n\n\treturn 0;\n}\n\nstatic int lg_raw_event(struct hid_device *hdev, struct hid_report *report,\n\t\tu8 *rd, int size)\n{\n\tstruct lg_drv_data *drv_data = hid_get_drvdata(hdev);\n\n\tif (drv_data->quirks & LG_FF4)\n\t\treturn lg4ff_raw_event(hdev, report, rd, size, drv_data);\n\n\treturn 0;\n}\n\nstatic int lg_probe(struct hid_device *hdev, const struct hid_device_id *id)\n{\n\tstruct usb_interface *iface;\n\t__u8 iface_num;\n\tunsigned int connect_mask = HID_CONNECT_DEFAULT;\n\tstruct lg_drv_data *drv_data;\n\tint ret;\n\n\tif (!hid_is_usb(hdev))\n\t\treturn -EINVAL;\n\n\tiface = to_usb_interface(hdev->dev.parent);\n\tiface_num = iface->cur_altsetting->desc.bInterfaceNumber;\n\n\t \n\tif ((hdev->product == USB_DEVICE_ID_LOGITECH_G29_WHEEL) &&\n\t    (iface_num != 0)) {\n\t\tdbg_hid(\"%s: ignoring ifnum %d\\n\", __func__, iface_num);\n\t\treturn -ENODEV;\n\t}\n\n\tdrv_data = kzalloc(sizeof(struct lg_drv_data), GFP_KERNEL);\n\tif (!drv_data) {\n\t\thid_err(hdev, \"Insufficient memory, cannot allocate driver data\\n\");\n\t\treturn -ENOMEM;\n\t}\n\tdrv_data->quirks = id->driver_data;\n\n\thid_set_drvdata(hdev, (void *)drv_data);\n\n\tif (drv_data->quirks & LG_NOGET)\n\t\thdev->quirks |= HID_QUIRK_NOGET;\n\n\tret = hid_parse(hdev);\n\tif (ret) {\n\t\thid_err(hdev, \"parse failed\\n\");\n\t\tgoto err_free;\n\t}\n\n\tif (drv_data->quirks & (LG_FF | LG_FF2 | LG_FF3 | LG_FF4))\n\t\tconnect_mask &= ~HID_CONNECT_FF;\n\n\tret = hid_hw_start(hdev, connect_mask);\n\tif (ret) {\n\t\thid_err(hdev, \"hw start failed\\n\");\n\t\tgoto err_free;\n\t}\n\n\t \n\tif (hdev->product == USB_DEVICE_ID_LOGITECH_WII_WHEEL) {\n\t\tstatic const unsigned char cbuf[] = {\n\t\t\t0x00, 0xAF,  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\n\t\t};\n\t\tu8 *buf = kmemdup(cbuf, sizeof(cbuf), GFP_KERNEL);\n\n\t\tif (!buf) {\n\t\t\tret = -ENOMEM;\n\t\t\tgoto err_stop;\n\t\t}\n\n\t\tret = hid_hw_raw_request(hdev, buf[0], buf, sizeof(cbuf),\n\t\t\t\t\tHID_FEATURE_REPORT, HID_REQ_SET_REPORT);\n\t\tif (ret >= 0) {\n\t\t\t \n\t\t\twait_queue_head_t wait;\n\t\t\tinit_waitqueue_head (&wait);\n\t\t\twait_event_interruptible_timeout(wait, 0,\n\t\t\t\t\t\t\t msecs_to_jiffies(40));\n\n\t\t\t \n\t\t\tbuf[1] = 0xB2;\n\t\t\tget_random_bytes(&buf[2], 2);\n\n\t\t\tret = hid_hw_raw_request(hdev, buf[0], buf, sizeof(cbuf),\n\t\t\t\t\tHID_FEATURE_REPORT, HID_REQ_SET_REPORT);\n\t\t}\n\t\tkfree(buf);\n\t}\n\n\tif (drv_data->quirks & LG_FF)\n\t\tret = lgff_init(hdev);\n\telse if (drv_data->quirks & LG_FF2)\n\t\tret = lg2ff_init(hdev);\n\telse if (drv_data->quirks & LG_FF3)\n\t\tret = lg3ff_init(hdev);\n\telse if (drv_data->quirks & LG_FF4)\n\t\tret = lg4ff_init(hdev);\n\n\tif (ret)\n\t\tgoto err_stop;\n\n\treturn 0;\n\nerr_stop:\n\thid_hw_stop(hdev);\nerr_free:\n\tkfree(drv_data);\n\treturn ret;\n}\n\nstatic void lg_remove(struct hid_device *hdev)\n{\n\tstruct lg_drv_data *drv_data = hid_get_drvdata(hdev);\n\tif (drv_data->quirks & LG_FF4)\n\t\tlg4ff_deinit(hdev);\n\thid_hw_stop(hdev);\n\tkfree(drv_data);\n}\n\nstatic const struct hid_device_id lg_devices[] = {\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_S510_RECEIVER),\n\t\t.driver_data = LG_RDESC | LG_WIRELESS },\n\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_RECEIVER),\n\t\t.driver_data = LG_BAD_RELATIVE_KEYS },\n\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_DINOVO_DESKTOP),\n\t\t.driver_data = LG_DUPLICATE_USAGES },\n\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_ELITE_KBD),\n\t\t.driver_data = LG_IGNORE_DOUBLED_WHEEL | LG_EXPANDED_KEYMAP },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_CORDLESS_DESKTOP_LX500),\n\t\t.driver_data = LG_IGNORE_DOUBLED_WHEEL | LG_EXPANDED_KEYMAP },\n\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_EXTREME_3D),\n\t\t.driver_data = LG_NOGET },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_DUAL_ACTION),\n\t\t.driver_data = LG_NOGET },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_WHEEL),\n\t\t.driver_data = LG_NOGET | LG_FF4 },\n\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_RUMBLEPAD_CORD),\n\t\t.driver_data = LG_FF2 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_RUMBLEPAD),\n\t\t.driver_data = LG_FF },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_RUMBLEPAD2_2),\n\t\t.driver_data = LG_FF },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_G29_WHEEL),\n\t\t.driver_data = LG_FF4 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_WINGMAN_F3D),\n\t\t.driver_data = LG_FF },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_FORCE3D_PRO),\n\t\t.driver_data = LG_FF },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_MOMO_WHEEL),\n\t\t.driver_data = LG_NOGET | LG_FF4 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_MOMO_WHEEL2),\n\t\t.driver_data = LG_FF4 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_VIBRATION_WHEEL),\n\t\t.driver_data = LG_FF2 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_G25_WHEEL),\n\t\t.driver_data = LG_FF4 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_DFGT_WHEEL),\n\t\t.driver_data = LG_FF4 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_G27_WHEEL),\n\t\t.driver_data = LG_FF4 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_DFP_WHEEL),\n\t\t.driver_data = LG_NOGET | LG_FF4 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_WII_WHEEL),\n\t\t.driver_data = LG_FF4 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_WINGMAN_FG),\n\t\t.driver_data = LG_NOGET },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_WINGMAN_FFG),\n\t\t.driver_data = LG_NOGET | LG_FF4 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_RUMBLEPAD2),\n\t\t.driver_data = LG_NOGET | LG_FF2 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_LOGITECH_FLIGHT_SYSTEM_G940),\n\t\t.driver_data = LG_FF3 },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_SPACENAVIGATOR),\n\t\t.driver_data = LG_RDESC_REL_ABS },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_LOGITECH, USB_DEVICE_ID_SPACETRAVELLER),\n\t\t.driver_data = LG_RDESC_REL_ABS },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(hid, lg_devices);\n\nstatic struct hid_driver lg_driver = {\n\t.name = \"logitech\",\n\t.id_table = lg_devices,\n\t.report_fixup = lg_report_fixup,\n\t.input_mapping = lg_input_mapping,\n\t.input_mapped = lg_input_mapped,\n\t.event = lg_event,\n\t.raw_event = lg_raw_event,\n\t.probe = lg_probe,\n\t.remove = lg_remove,\n};\nmodule_hid_driver(lg_driver);\n\n#ifdef CONFIG_LOGIWHEELS_FF\nint lg4ff_no_autoswitch = 0;\nmodule_param_named(lg4ff_no_autoswitch, lg4ff_no_autoswitch, int, S_IRUGO);\nMODULE_PARM_DESC(lg4ff_no_autoswitch, \"Do not switch multimode wheels to their native mode automatically\");\n#endif\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}