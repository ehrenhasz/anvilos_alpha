{
  "module_name": "i2c-hid-of-goodix.c",
  "hash_id": "e46f997048bd73ff25e62874503a48a52b6c3a6d6f934ca3a4a850998c75eee3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/i2c-hid/i2c-hid-of-goodix.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/gpio/consumer.h>\n#include <linux/i2c.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/pm.h>\n#include <linux/regulator/consumer.h>\n\n#include \"i2c-hid.h\"\n\nstruct goodix_i2c_hid_timing_data {\n\tunsigned int post_gpio_reset_delay_ms;\n\tunsigned int post_power_delay_ms;\n};\n\nstruct i2c_hid_of_goodix {\n\tstruct i2chid_ops ops;\n\n\tstruct regulator *vdd;\n\tstruct regulator *vddio;\n\tstruct gpio_desc *reset_gpio;\n\tbool no_reset_during_suspend;\n\tconst struct goodix_i2c_hid_timing_data *timings;\n};\n\nstatic int goodix_i2c_hid_power_up(struct i2chid_ops *ops)\n{\n\tstruct i2c_hid_of_goodix *ihid_goodix =\n\t\tcontainer_of(ops, struct i2c_hid_of_goodix, ops);\n\tint ret;\n\n\t \n\tif (ihid_goodix->no_reset_during_suspend)\n\t\tgpiod_set_value_cansleep(ihid_goodix->reset_gpio, 1);\n\n\tret = regulator_enable(ihid_goodix->vdd);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regulator_enable(ihid_goodix->vddio);\n\tif (ret)\n\t\treturn ret;\n\n\tif (ihid_goodix->timings->post_power_delay_ms)\n\t\tmsleep(ihid_goodix->timings->post_power_delay_ms);\n\n\tgpiod_set_value_cansleep(ihid_goodix->reset_gpio, 0);\n\tif (ihid_goodix->timings->post_gpio_reset_delay_ms)\n\t\tmsleep(ihid_goodix->timings->post_gpio_reset_delay_ms);\n\n\treturn 0;\n}\n\nstatic void goodix_i2c_hid_power_down(struct i2chid_ops *ops)\n{\n\tstruct i2c_hid_of_goodix *ihid_goodix =\n\t\tcontainer_of(ops, struct i2c_hid_of_goodix, ops);\n\n\tif (!ihid_goodix->no_reset_during_suspend)\n\t\tgpiod_set_value_cansleep(ihid_goodix->reset_gpio, 1);\n\n\tregulator_disable(ihid_goodix->vddio);\n\tregulator_disable(ihid_goodix->vdd);\n}\n\nstatic int i2c_hid_of_goodix_probe(struct i2c_client *client)\n{\n\tstruct i2c_hid_of_goodix *ihid_goodix;\n\n\tihid_goodix = devm_kzalloc(&client->dev, sizeof(*ihid_goodix),\n\t\t\t\t   GFP_KERNEL);\n\tif (!ihid_goodix)\n\t\treturn -ENOMEM;\n\n\tihid_goodix->ops.power_up = goodix_i2c_hid_power_up;\n\tihid_goodix->ops.power_down = goodix_i2c_hid_power_down;\n\n\t \n\tihid_goodix->reset_gpio =\n\t\tdevm_gpiod_get_optional(&client->dev, \"reset\", GPIOD_OUT_HIGH);\n\tif (IS_ERR(ihid_goodix->reset_gpio))\n\t\treturn PTR_ERR(ihid_goodix->reset_gpio);\n\n\tihid_goodix->vdd = devm_regulator_get(&client->dev, \"vdd\");\n\tif (IS_ERR(ihid_goodix->vdd))\n\t\treturn PTR_ERR(ihid_goodix->vdd);\n\n\tihid_goodix->vddio = devm_regulator_get(&client->dev, \"mainboard-vddio\");\n\tif (IS_ERR(ihid_goodix->vddio))\n\t\treturn PTR_ERR(ihid_goodix->vddio);\n\n\tihid_goodix->no_reset_during_suspend =\n\t\tof_property_read_bool(client->dev.of_node, \"goodix,no-reset-during-suspend\");\n\n\tihid_goodix->timings = device_get_match_data(&client->dev);\n\n\treturn i2c_hid_core_probe(client, &ihid_goodix->ops, 0x0001, 0);\n}\n\nstatic const struct goodix_i2c_hid_timing_data goodix_gt7375p_timing_data = {\n\t.post_power_delay_ms = 10,\n\t.post_gpio_reset_delay_ms = 180,\n};\n\nstatic const struct of_device_id goodix_i2c_hid_of_match[] = {\n\t{ .compatible = \"goodix,gt7375p\", .data = &goodix_gt7375p_timing_data },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, goodix_i2c_hid_of_match);\n\nstatic struct i2c_driver goodix_i2c_hid_ts_driver = {\n\t.driver = {\n\t\t.name\t= \"i2c_hid_of_goodix\",\n\t\t.pm\t= &i2c_hid_core_pm,\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.of_match_table = of_match_ptr(goodix_i2c_hid_of_match),\n\t},\n\t.probe\t\t= i2c_hid_of_goodix_probe,\n\t.remove\t\t= i2c_hid_core_remove,\n\t.shutdown\t= i2c_hid_core_shutdown,\n};\nmodule_i2c_driver(goodix_i2c_hid_ts_driver);\n\nMODULE_AUTHOR(\"Douglas Anderson <dianders@chromium.org>\");\nMODULE_DESCRIPTION(\"Goodix i2c-hid touchscreen driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}