{
  "module_name": "hid-bigbenff.c",
  "hash_id": "e1fb0bef761f3db08e780e1adfb6b48363355e05c19dd25e98077f2938fc0aad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-bigbenff.c",
  "human_readable_source": "\n\n \n\n#include <linux/input.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/leds.h>\n#include <linux/hid.h>\n\n#include \"hid-ids.h\"\n\n\n \n\n#define PID0902_RDESC_ORIG_SIZE 137\n\n \nstatic __u8 pid0902_rdesc_fixed[] = {\n\t0x05, 0x01,         \n\t0x09, 0x05,         \n\t0xA1, 0x01,         \n\t0x15, 0x00,         \n\t0x25, 0x01,         \n\t0x35, 0x00,         \n\t0x45, 0x01,         \n\t0x75, 0x01,         \n\t0x95, 0x0D,         \n\t0x05, 0x09,         \n\t0x09, 0x05,         \n\t0x09, 0x01,         \n\t0x09, 0x02,         \n\t0x09, 0x04,         \n\t0x09, 0x07,         \n\t0x09, 0x08,         \n\t0x09, 0x09,         \n\t0x09, 0x0A,         \n\t0x09, 0x0B,         \n\t0x09, 0x0C,         \n\t0x09, 0x0E,         \n\t0x09, 0x0F,         \n\t0x09, 0x0D,         \n\t0x81, 0x02,         \n\t0x75, 0x01,         \n\t0x95, 0x03,         \n\t0x81, 0x01,         \n\t0x05, 0x01,         \n\t0x25, 0x07,         \n\t0x46, 0x3B, 0x01,   \n\t0x75, 0x04,         \n\t0x95, 0x01,         \n\t0x65, 0x14,         \n\t0x09, 0x39,         \n\t0x81, 0x42,         \n\t0x65, 0x00,         \n\t0x95, 0x01,         \n\t0x81, 0x01,         \n\t0x26, 0xFF, 0x00,   \n\t0x46, 0xFF, 0x00,   \n\t0x09, 0x30,         \n\t0x09, 0x31,         \n\t0x09, 0x33,         \n\t0x09, 0x34,         \n\t0x75, 0x08,         \n\t0x95, 0x04,         \n\t0x81, 0x02,         \n\t0x95, 0x0A,         \n\t0x81, 0x01,         \n\t0x05, 0x01,         \n\t0x26, 0xFF, 0x00,   \n\t0x46, 0xFF, 0x00,   \n\t0x09, 0x32,         \n\t0x09, 0x35,         \n\t0x95, 0x02,         \n\t0x81, 0x02,         \n\t0x95, 0x08,         \n\t0x81, 0x01,         \n\t0x06, 0x00, 0xFF,   \n\t0xB1, 0x02,         \n\t0x0A, 0x21, 0x26,   \n\t0x95, 0x08,         \n\t0x91, 0x02,         \n\t0x0A, 0x21, 0x26,   \n\t0x95, 0x08,         \n\t0x81, 0x02,         \n\t0xC0,               \n};\n\n#define NUM_LEDS 4\n\nstruct bigben_device {\n\tstruct hid_device *hid;\n\tstruct hid_report *report;\n\tspinlock_t lock;\n\tbool removed;\n\tu8 led_state;          \n\tu8 right_motor_on;     \n\tu8 left_motor_force;   \n\tstruct led_classdev *leds[NUM_LEDS];\n\tbool work_led;\n\tbool work_ff;\n\tstruct work_struct worker;\n};\n\nstatic inline void bigben_schedule_work(struct bigben_device *bigben)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&bigben->lock, flags);\n\tif (!bigben->removed)\n\t\tschedule_work(&bigben->worker);\n\tspin_unlock_irqrestore(&bigben->lock, flags);\n}\n\nstatic void bigben_worker(struct work_struct *work)\n{\n\tstruct bigben_device *bigben = container_of(work,\n\t\tstruct bigben_device, worker);\n\tstruct hid_field *report_field = bigben->report->field[0];\n\tbool do_work_led = false;\n\tbool do_work_ff = false;\n\tu8 *buf;\n\tu32 len;\n\tunsigned long flags;\n\n\tbuf = hid_alloc_report_buf(bigben->report, GFP_KERNEL);\n\tif (!buf)\n\t\treturn;\n\n\tlen = hid_report_len(bigben->report);\n\n\t \n\tspin_lock_irqsave(&bigben->lock, flags);\n\n\tif (bigben->work_led) {\n\t\tbigben->work_led = false;\n\t\tdo_work_led = true;\n\t\treport_field->value[0] = 0x01;  \n\t\treport_field->value[1] = 0x08;  \n\t\treport_field->value[2] = bigben->led_state;\n\t\treport_field->value[3] = 0x00;  \n\t\treport_field->value[4] = 0x00;  \n\t\treport_field->value[5] = 0x00;  \n\t\treport_field->value[6] = 0x00;  \n\t\treport_field->value[7] = 0x00;  \n\t\thid_output_report(bigben->report, buf);\n\t}\n\n\tspin_unlock_irqrestore(&bigben->lock, flags);\n\n\tif (do_work_led) {\n\t\thid_hw_raw_request(bigben->hid, bigben->report->id, buf, len,\n\t\t\t\t   bigben->report->type, HID_REQ_SET_REPORT);\n\t}\n\n\t \n\tspin_lock_irqsave(&bigben->lock, flags);\n\n\tif (bigben->work_ff) {\n\t\tbigben->work_ff = false;\n\t\tdo_work_ff = true;\n\t\treport_field->value[0] = 0x02;  \n\t\treport_field->value[1] = 0x08;  \n\t\treport_field->value[2] = bigben->right_motor_on;\n\t\treport_field->value[3] = bigben->left_motor_force;\n\t\treport_field->value[4] = 0xff;  \n\t\treport_field->value[5] = 0x00;  \n\t\treport_field->value[6] = 0x00;  \n\t\treport_field->value[7] = 0x00;  \n\t\thid_output_report(bigben->report, buf);\n\t}\n\n\tspin_unlock_irqrestore(&bigben->lock, flags);\n\n\tif (do_work_ff) {\n\t\thid_hw_raw_request(bigben->hid, bigben->report->id, buf, len,\n\t\t\t\t   bigben->report->type, HID_REQ_SET_REPORT);\n\t}\n\n\tkfree(buf);\n}\n\nstatic int hid_bigben_play_effect(struct input_dev *dev, void *data,\n\t\t\t struct ff_effect *effect)\n{\n\tstruct hid_device *hid = input_get_drvdata(dev);\n\tstruct bigben_device *bigben = hid_get_drvdata(hid);\n\tu8 right_motor_on;\n\tu8 left_motor_force;\n\tunsigned long flags;\n\n\tif (!bigben) {\n\t\thid_err(hid, \"no device data\\n\");\n\t\treturn 0;\n\t}\n\n\tif (effect->type != FF_RUMBLE)\n\t\treturn 0;\n\n\tright_motor_on   = effect->u.rumble.weak_magnitude ? 1 : 0;\n\tleft_motor_force = effect->u.rumble.strong_magnitude / 256;\n\n\tif (right_motor_on != bigben->right_motor_on ||\n\t\t\tleft_motor_force != bigben->left_motor_force) {\n\t\tspin_lock_irqsave(&bigben->lock, flags);\n\t\tbigben->right_motor_on   = right_motor_on;\n\t\tbigben->left_motor_force = left_motor_force;\n\t\tbigben->work_ff = true;\n\t\tspin_unlock_irqrestore(&bigben->lock, flags);\n\n\t\tbigben_schedule_work(bigben);\n\t}\n\n\treturn 0;\n}\n\nstatic void bigben_set_led(struct led_classdev *led,\n\tenum led_brightness value)\n{\n\tstruct device *dev = led->dev->parent;\n\tstruct hid_device *hid = to_hid_device(dev);\n\tstruct bigben_device *bigben = hid_get_drvdata(hid);\n\tint n;\n\tbool work;\n\tunsigned long flags;\n\n\tif (!bigben) {\n\t\thid_err(hid, \"no device data\\n\");\n\t\treturn;\n\t}\n\n\tfor (n = 0; n < NUM_LEDS; n++) {\n\t\tif (led == bigben->leds[n]) {\n\t\t\tspin_lock_irqsave(&bigben->lock, flags);\n\t\t\tif (value == LED_OFF) {\n\t\t\t\twork = (bigben->led_state & BIT(n));\n\t\t\t\tbigben->led_state &= ~BIT(n);\n\t\t\t} else {\n\t\t\t\twork = !(bigben->led_state & BIT(n));\n\t\t\t\tbigben->led_state |= BIT(n);\n\t\t\t}\n\t\t\tspin_unlock_irqrestore(&bigben->lock, flags);\n\n\t\t\tif (work) {\n\t\t\t\tbigben->work_led = true;\n\t\t\t\tbigben_schedule_work(bigben);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t}\n}\n\nstatic enum led_brightness bigben_get_led(struct led_classdev *led)\n{\n\tstruct device *dev = led->dev->parent;\n\tstruct hid_device *hid = to_hid_device(dev);\n\tstruct bigben_device *bigben = hid_get_drvdata(hid);\n\tint n;\n\n\tif (!bigben) {\n\t\thid_err(hid, \"no device data\\n\");\n\t\treturn LED_OFF;\n\t}\n\n\tfor (n = 0; n < NUM_LEDS; n++) {\n\t\tif (led == bigben->leds[n])\n\t\t\treturn (bigben->led_state & BIT(n)) ? LED_ON : LED_OFF;\n\t}\n\n\treturn LED_OFF;\n}\n\nstatic void bigben_remove(struct hid_device *hid)\n{\n\tstruct bigben_device *bigben = hid_get_drvdata(hid);\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&bigben->lock, flags);\n\tbigben->removed = true;\n\tspin_unlock_irqrestore(&bigben->lock, flags);\n\n\tcancel_work_sync(&bigben->worker);\n\thid_hw_stop(hid);\n}\n\nstatic int bigben_probe(struct hid_device *hid,\n\tconst struct hid_device_id *id)\n{\n\tstruct bigben_device *bigben;\n\tstruct hid_input *hidinput;\n\tstruct led_classdev *led;\n\tchar *name;\n\tsize_t name_sz;\n\tint n, error;\n\n\tbigben = devm_kzalloc(&hid->dev, sizeof(*bigben), GFP_KERNEL);\n\tif (!bigben)\n\t\treturn -ENOMEM;\n\thid_set_drvdata(hid, bigben);\n\tbigben->hid = hid;\n\tbigben->removed = false;\n\n\terror = hid_parse(hid);\n\tif (error) {\n\t\thid_err(hid, \"parse failed\\n\");\n\t\treturn error;\n\t}\n\n\terror = hid_hw_start(hid, HID_CONNECT_DEFAULT & ~HID_CONNECT_FF);\n\tif (error) {\n\t\thid_err(hid, \"hw start failed\\n\");\n\t\treturn error;\n\t}\n\n\tbigben->report = hid_validate_values(hid, HID_OUTPUT_REPORT, 0, 0, 8);\n\tif (!bigben->report) {\n\t\thid_err(hid, \"no output report found\\n\");\n\t\terror = -ENODEV;\n\t\tgoto error_hw_stop;\n\t}\n\n\tif (list_empty(&hid->inputs)) {\n\t\thid_err(hid, \"no inputs found\\n\");\n\t\terror = -ENODEV;\n\t\tgoto error_hw_stop;\n\t}\n\n\thidinput = list_first_entry(&hid->inputs, struct hid_input, list);\n\tset_bit(FF_RUMBLE, hidinput->input->ffbit);\n\n\tINIT_WORK(&bigben->worker, bigben_worker);\n\tspin_lock_init(&bigben->lock);\n\n\terror = input_ff_create_memless(hidinput->input, NULL,\n\t\thid_bigben_play_effect);\n\tif (error)\n\t\tgoto error_hw_stop;\n\n\tname_sz = strlen(dev_name(&hid->dev)) + strlen(\":red:bigben#\") + 1;\n\n\tfor (n = 0; n < NUM_LEDS; n++) {\n\t\tled = devm_kzalloc(\n\t\t\t&hid->dev,\n\t\t\tsizeof(struct led_classdev) + name_sz,\n\t\t\tGFP_KERNEL\n\t\t);\n\t\tif (!led) {\n\t\t\terror = -ENOMEM;\n\t\t\tgoto error_hw_stop;\n\t\t}\n\t\tname = (void *)(&led[1]);\n\t\tsnprintf(name, name_sz,\n\t\t\t\"%s:red:bigben%d\",\n\t\t\tdev_name(&hid->dev), n + 1\n\t\t);\n\t\tled->name = name;\n\t\tled->brightness = (n == 0) ? LED_ON : LED_OFF;\n\t\tled->max_brightness = 1;\n\t\tled->brightness_get = bigben_get_led;\n\t\tled->brightness_set = bigben_set_led;\n\t\tbigben->leds[n] = led;\n\t\terror = devm_led_classdev_register(&hid->dev, led);\n\t\tif (error)\n\t\t\tgoto error_hw_stop;\n\t}\n\n\t \n\tbigben->led_state = BIT(0);\n\tbigben->right_motor_on = 0;\n\tbigben->left_motor_force = 0;\n\tbigben->work_led = true;\n\tbigben->work_ff = true;\n\tbigben_schedule_work(bigben);\n\n\thid_info(hid, \"LED and force feedback support for BigBen gamepad\\n\");\n\n\treturn 0;\n\nerror_hw_stop:\n\thid_hw_stop(hid);\n\treturn error;\n}\n\nstatic __u8 *bigben_report_fixup(struct hid_device *hid, __u8 *rdesc,\n\tunsigned int *rsize)\n{\n\tif (*rsize == PID0902_RDESC_ORIG_SIZE) {\n\t\trdesc = pid0902_rdesc_fixed;\n\t\t*rsize = sizeof(pid0902_rdesc_fixed);\n\t} else\n\t\thid_warn(hid, \"unexpected rdesc, please submit for review\\n\");\n\treturn rdesc;\n}\n\nstatic const struct hid_device_id bigben_devices[] = {\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_BIGBEN, USB_DEVICE_ID_BIGBEN_PS3OFMINIPAD) },\n\t{ }\n};\nMODULE_DEVICE_TABLE(hid, bigben_devices);\n\nstatic struct hid_driver bigben_driver = {\n\t.name = \"bigben\",\n\t.id_table = bigben_devices,\n\t.probe = bigben_probe,\n\t.report_fixup = bigben_report_fixup,\n\t.remove = bigben_remove,\n};\nmodule_hid_driver(bigben_driver);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}