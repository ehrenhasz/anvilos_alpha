{
  "module_name": "hid-roccat-ryos.c",
  "hash_id": "5a128ec87e64401eef201fae38d349cc83735a897f3f149f352171fc10f8c43b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-roccat-ryos.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/types.h>\n#include <linux/device.h>\n#include <linux/input.h>\n#include <linux/hid.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/hid-roccat.h>\n#include \"hid-ids.h\"\n#include \"hid-roccat-common.h\"\n\nenum {\n\tRYOS_REPORT_NUMBER_SPECIAL = 3,\n\tRYOS_USB_INTERFACE_PROTOCOL = 0,\n};\n\nstruct ryos_report_special {\n\tuint8_t number;  \n\tuint8_t data[4];\n} __packed;\n\nROCCAT_COMMON2_BIN_ATTRIBUTE_W(control, 0x04, 0x03);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(profile, 0x05, 0x03);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(keys_primary, 0x06, 0x7d);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(keys_function, 0x07, 0x5f);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(keys_macro, 0x08, 0x23);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(keys_thumbster, 0x09, 0x17);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(keys_extra, 0x0a, 0x08);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(keys_easyzone, 0x0b, 0x126);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(key_mask, 0x0c, 0x06);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(light, 0x0d, 0x10);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(macro, 0x0e, 0x7d2);\nROCCAT_COMMON2_BIN_ATTRIBUTE_R(info, 0x0f, 0x08);\nROCCAT_COMMON2_BIN_ATTRIBUTE_W(reset, 0x11, 0x03);\nROCCAT_COMMON2_BIN_ATTRIBUTE_W(light_control, 0x13, 0x08);\nROCCAT_COMMON2_BIN_ATTRIBUTE_W(talk, 0x16, 0x10);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(stored_lights, 0x17, 0x0566);\nROCCAT_COMMON2_BIN_ATTRIBUTE_W(custom_lights, 0x18, 0x14);\nROCCAT_COMMON2_BIN_ATTRIBUTE_RW(light_macro, 0x19, 0x07d2);\n\nstatic struct bin_attribute *ryos_bin_attrs[] = {\n\t&bin_attr_control,\n\t&bin_attr_profile,\n\t&bin_attr_keys_primary,\n\t&bin_attr_keys_function,\n\t&bin_attr_keys_macro,\n\t&bin_attr_keys_thumbster,\n\t&bin_attr_keys_extra,\n\t&bin_attr_keys_easyzone,\n\t&bin_attr_key_mask,\n\t&bin_attr_light,\n\t&bin_attr_macro,\n\t&bin_attr_info,\n\t&bin_attr_reset,\n\t&bin_attr_light_control,\n\t&bin_attr_talk,\n\t&bin_attr_stored_lights,\n\t&bin_attr_custom_lights,\n\t&bin_attr_light_macro,\n\tNULL,\n};\n\nstatic const struct attribute_group ryos_group = {\n\t.bin_attrs = ryos_bin_attrs,\n};\n\nstatic const struct attribute_group *ryos_groups[] = {\n\t&ryos_group,\n\tNULL,\n};\n\nstatic const struct class ryos_class = {\n\t.name = \"ryos\",\n\t.dev_groups = ryos_groups,\n};\n\nstatic int ryos_init_specials(struct hid_device *hdev)\n{\n\tstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\n\tstruct usb_device *usb_dev = interface_to_usbdev(intf);\n\tstruct roccat_common2_device *ryos;\n\tint retval;\n\n\tif (intf->cur_altsetting->desc.bInterfaceProtocol\n\t\t\t!= RYOS_USB_INTERFACE_PROTOCOL) {\n\t\thid_set_drvdata(hdev, NULL);\n\t\treturn 0;\n\t}\n\n\tryos = kzalloc(sizeof(*ryos), GFP_KERNEL);\n\tif (!ryos) {\n\t\thid_err(hdev, \"can't alloc device descriptor\\n\");\n\t\treturn -ENOMEM;\n\t}\n\thid_set_drvdata(hdev, ryos);\n\n\tretval = roccat_common2_device_init_struct(usb_dev, ryos);\n\tif (retval) {\n\t\thid_err(hdev, \"couldn't init Ryos device\\n\");\n\t\tgoto exit_free;\n\t}\n\n\tretval = roccat_connect(&ryos_class, hdev,\n\t\t\tsizeof(struct ryos_report_special));\n\tif (retval < 0) {\n\t\thid_err(hdev, \"couldn't init char dev\\n\");\n\t} else {\n\t\tryos->chrdev_minor = retval;\n\t\tryos->roccat_claimed = 1;\n\t}\n\n\treturn 0;\nexit_free:\n\tkfree(ryos);\n\treturn retval;\n}\n\nstatic void ryos_remove_specials(struct hid_device *hdev)\n{\n\tstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\n\tstruct roccat_common2_device *ryos;\n\n\tif (intf->cur_altsetting->desc.bInterfaceProtocol\n\t\t\t!= RYOS_USB_INTERFACE_PROTOCOL)\n\t\treturn;\n\n\tryos = hid_get_drvdata(hdev);\n\tif (ryos->roccat_claimed)\n\t\troccat_disconnect(ryos->chrdev_minor);\n\tkfree(ryos);\n}\n\nstatic int ryos_probe(struct hid_device *hdev,\n\t\tconst struct hid_device_id *id)\n{\n\tint retval;\n\n\tif (!hid_is_usb(hdev))\n\t\treturn -EINVAL;\n\n\tretval = hid_parse(hdev);\n\tif (retval) {\n\t\thid_err(hdev, \"parse failed\\n\");\n\t\tgoto exit;\n\t}\n\n\tretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\n\tif (retval) {\n\t\thid_err(hdev, \"hw start failed\\n\");\n\t\tgoto exit;\n\t}\n\n\tretval = ryos_init_specials(hdev);\n\tif (retval) {\n\t\thid_err(hdev, \"couldn't install mouse\\n\");\n\t\tgoto exit_stop;\n\t}\n\n\treturn 0;\n\nexit_stop:\n\thid_hw_stop(hdev);\nexit:\n\treturn retval;\n}\n\nstatic void ryos_remove(struct hid_device *hdev)\n{\n\tryos_remove_specials(hdev);\n\thid_hw_stop(hdev);\n}\n\nstatic int ryos_raw_event(struct hid_device *hdev,\n\t\tstruct hid_report *report, u8 *data, int size)\n{\n\tstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\n\tstruct roccat_common2_device *ryos = hid_get_drvdata(hdev);\n\n\tif (intf->cur_altsetting->desc.bInterfaceProtocol\n\t\t\t!= RYOS_USB_INTERFACE_PROTOCOL)\n\t\treturn 0;\n\n\tif (data[0] != RYOS_REPORT_NUMBER_SPECIAL)\n\t\treturn 0;\n\n\tif (ryos != NULL && ryos->roccat_claimed)\n\t\troccat_report_event(ryos->chrdev_minor, data);\n\n\treturn 0;\n}\n\nstatic const struct hid_device_id ryos_devices[] = {\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_ROCCAT, USB_DEVICE_ID_ROCCAT_RYOS_MK) },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_ROCCAT, USB_DEVICE_ID_ROCCAT_RYOS_MK_GLOW) },\n\t{ HID_USB_DEVICE(USB_VENDOR_ID_ROCCAT, USB_DEVICE_ID_ROCCAT_RYOS_MK_PRO) },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(hid, ryos_devices);\n\nstatic struct hid_driver ryos_driver = {\n\t\t.name = \"ryos\",\n\t\t.id_table = ryos_devices,\n\t\t.probe = ryos_probe,\n\t\t.remove = ryos_remove,\n\t\t.raw_event = ryos_raw_event\n};\n\nstatic int __init ryos_init(void)\n{\n\tint retval;\n\n\tretval = class_register(&ryos_class);\n\tif (retval)\n\t\treturn retval;\n\n\tretval = hid_register_driver(&ryos_driver);\n\tif (retval)\n\t\tclass_unregister(&ryos_class);\n\treturn retval;\n}\n\nstatic void __exit ryos_exit(void)\n{\n\thid_unregister_driver(&ryos_driver);\n\tclass_unregister(&ryos_class);\n}\n\nmodule_init(ryos_init);\nmodule_exit(ryos_exit);\n\nMODULE_AUTHOR(\"Stefan Achatz\");\nMODULE_DESCRIPTION(\"USB Roccat Ryos MK/Glow/Pro driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}