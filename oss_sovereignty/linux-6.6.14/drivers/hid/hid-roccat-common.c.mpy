{
  "module_name": "hid-roccat-common.c",
  "hash_id": "d8871d50fa6c75c49eafd6d212d94e613091d58e0dad399c377be5216a090bdd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hid/hid-roccat-common.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/hid.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include \"hid-roccat-common.h\"\n\nstatic inline uint16_t roccat_common2_feature_report(uint8_t report_id)\n{\n\treturn 0x300 | report_id;\n}\n\nint roccat_common2_receive(struct usb_device *usb_dev, uint report_id,\n\t\tvoid *data, uint size)\n{\n\tchar *buf;\n\tint len;\n\n\tbuf = kmalloc(size, GFP_KERNEL);\n\tif (buf == NULL)\n\t\treturn -ENOMEM;\n\n\tlen = usb_control_msg(usb_dev, usb_rcvctrlpipe(usb_dev, 0),\n\t\t\tHID_REQ_GET_REPORT,\n\t\t\tUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_IN,\n\t\t\troccat_common2_feature_report(report_id),\n\t\t\t0, buf, size, USB_CTRL_SET_TIMEOUT);\n\n\tmemcpy(data, buf, size);\n\tkfree(buf);\n\treturn ((len < 0) ? len : ((len != size) ? -EIO : 0));\n}\nEXPORT_SYMBOL_GPL(roccat_common2_receive);\n\nint roccat_common2_send(struct usb_device *usb_dev, uint report_id,\n\t\tvoid const *data, uint size)\n{\n\tchar *buf;\n\tint len;\n\n\tbuf = kmemdup(data, size, GFP_KERNEL);\n\tif (buf == NULL)\n\t\treturn -ENOMEM;\n\n\tlen = usb_control_msg(usb_dev, usb_sndctrlpipe(usb_dev, 0),\n\t\t\tHID_REQ_SET_REPORT,\n\t\t\tUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_OUT,\n\t\t\troccat_common2_feature_report(report_id),\n\t\t\t0, buf, size, USB_CTRL_SET_TIMEOUT);\n\n\tkfree(buf);\n\treturn ((len < 0) ? len : ((len != size) ? -EIO : 0));\n}\nEXPORT_SYMBOL_GPL(roccat_common2_send);\n\nenum roccat_common2_control_states {\n\tROCCAT_COMMON_CONTROL_STATUS_CRITICAL = 0,\n\tROCCAT_COMMON_CONTROL_STATUS_OK = 1,\n\tROCCAT_COMMON_CONTROL_STATUS_INVALID = 2,\n\tROCCAT_COMMON_CONTROL_STATUS_BUSY = 3,\n\tROCCAT_COMMON_CONTROL_STATUS_CRITICAL_NEW = 4,\n};\n\nstatic int roccat_common2_receive_control_status(struct usb_device *usb_dev)\n{\n\tint retval;\n\tstruct roccat_common2_control control;\n\n\tdo {\n\t\tmsleep(50);\n\t\tretval = roccat_common2_receive(usb_dev,\n\t\t\t\tROCCAT_COMMON_COMMAND_CONTROL,\n\t\t\t\t&control, sizeof(struct roccat_common2_control));\n\n\t\tif (retval)\n\t\t\treturn retval;\n\n\t\tswitch (control.value) {\n\t\tcase ROCCAT_COMMON_CONTROL_STATUS_OK:\n\t\t\treturn 0;\n\t\tcase ROCCAT_COMMON_CONTROL_STATUS_BUSY:\n\t\t\tmsleep(500);\n\t\t\tcontinue;\n\t\tcase ROCCAT_COMMON_CONTROL_STATUS_INVALID:\n\t\tcase ROCCAT_COMMON_CONTROL_STATUS_CRITICAL:\n\t\tcase ROCCAT_COMMON_CONTROL_STATUS_CRITICAL_NEW:\n\t\t\treturn -EINVAL;\n\t\tdefault:\n\t\t\tdev_err(&usb_dev->dev,\n\t\t\t\t\t\"roccat_common2_receive_control_status: \"\n\t\t\t\t\t\"unknown response value 0x%x\\n\",\n\t\t\t\t\tcontrol.value);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t} while (1);\n}\n\nint roccat_common2_send_with_status(struct usb_device *usb_dev,\n\t\tuint command, void const *buf, uint size)\n{\n\tint retval;\n\n\tretval = roccat_common2_send(usb_dev, command, buf, size);\n\tif (retval)\n\t\treturn retval;\n\n\tmsleep(100);\n\n\treturn roccat_common2_receive_control_status(usb_dev);\n}\nEXPORT_SYMBOL_GPL(roccat_common2_send_with_status);\n\nint roccat_common2_device_init_struct(struct usb_device *usb_dev,\n\t\tstruct roccat_common2_device *dev)\n{\n\tmutex_init(&dev->lock);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(roccat_common2_device_init_struct);\n\nssize_t roccat_common2_sysfs_read(struct file *fp, struct kobject *kobj,\n\t\tchar *buf, loff_t off, size_t count,\n\t\tsize_t real_size, uint command)\n{\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct roccat_common2_device *roccat_dev = hid_get_drvdata(dev_get_drvdata(dev));\n\tstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\n\tint retval;\n\n\tif (off >= real_size)\n\t\treturn 0;\n\n\tif (off != 0 || count != real_size)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&roccat_dev->lock);\n\tretval = roccat_common2_receive(usb_dev, command, buf, real_size);\n\tmutex_unlock(&roccat_dev->lock);\n\n\treturn retval ? retval : real_size;\n}\nEXPORT_SYMBOL_GPL(roccat_common2_sysfs_read);\n\nssize_t roccat_common2_sysfs_write(struct file *fp, struct kobject *kobj,\n\t\tvoid const *buf, loff_t off, size_t count,\n\t\tsize_t real_size, uint command)\n{\n\tstruct device *dev = kobj_to_dev(kobj)->parent->parent;\n\tstruct roccat_common2_device *roccat_dev = hid_get_drvdata(dev_get_drvdata(dev));\n\tstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\n\tint retval;\n\n\tif (off != 0 || count != real_size)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&roccat_dev->lock);\n\tretval = roccat_common2_send_with_status(usb_dev, command, buf, real_size);\n\tmutex_unlock(&roccat_dev->lock);\n\n\treturn retval ? retval : real_size;\n}\nEXPORT_SYMBOL_GPL(roccat_common2_sysfs_write);\n\nMODULE_AUTHOR(\"Stefan Achatz\");\nMODULE_DESCRIPTION(\"USB Roccat common driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}