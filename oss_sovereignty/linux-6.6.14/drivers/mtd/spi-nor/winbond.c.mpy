{
  "module_name": "winbond.c",
  "hash_id": "9b7d6b169cd48eab0570b04732d5e2365f1e92b5796cfc69765247c7940ed5ad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/spi-nor/winbond.c",
  "human_readable_source": "\n \n\n#include <linux/mtd/spi-nor.h>\n\n#include \"core.h\"\n\n#define WINBOND_NOR_OP_RDEAR\t0xc8\t \n#define WINBOND_NOR_OP_WREAR\t0xc5\t \n\n#define WINBOND_NOR_WREAR_OP(buf)\t\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(WINBOND_NOR_OP_WREAR, 0),\t\t\\\n\t\t   SPI_MEM_OP_NO_ADDR,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_OUT(1, buf, 0))\n\nstatic int\nw25q256_post_bfpt_fixups(struct spi_nor *nor,\n\t\t\t const struct sfdp_parameter_header *bfpt_header,\n\t\t\t const struct sfdp_bfpt *bfpt)\n{\n\t \n\tif (bfpt_header->major == SFDP_JESD216_MAJOR &&\n\t    bfpt_header->minor == SFDP_JESD216A_MINOR)\n\t\tnor->flags |= SNOR_F_4B_OPCODES;\n\n\treturn 0;\n}\n\nstatic const struct spi_nor_fixups w25q256_fixups = {\n\t.post_bfpt = w25q256_post_bfpt_fixups,\n};\n\nstatic const struct flash_info winbond_nor_parts[] = {\n\t \n\t{ \"w25x05\", INFO(0xef3010, 0, 64 * 1024,  1)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25x10\", INFO(0xef3011, 0, 64 * 1024,  2)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25x20\", INFO(0xef3012, 0, 64 * 1024,  4)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25x40\", INFO(0xef3013, 0, 64 * 1024,  8)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25x80\", INFO(0xef3014, 0, 64 * 1024,  16)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25x16\", INFO(0xef3015, 0, 64 * 1024,  32)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q16dw\", INFO(0xef6015, 0, 64 * 1024,  32)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25x32\", INFO(0xef3016, 0, 64 * 1024,  64)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q16jv-im/jm\", INFO(0xef7015, 0, 64 * 1024,  32)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25q20cl\", INFO(0xef4012, 0, 64 * 1024,  4)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q20bw\", INFO(0xef5012, 0, 64 * 1024,  4)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q20ew\", INFO(0xef6012, 0, 64 * 1024,  4)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q32\", INFO(0xef4016, 0, 64 * 1024,  64)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q32dw\", INFO(0xef6016, 0, 64 * 1024,  64)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ)\n\t\tOTP_INFO(256, 3, 0x1000, 0x1000) },\n\t{ \"w25q32jv\", INFO(0xef7016, 0, 64 * 1024,  64)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25q32jwm\", INFO(0xef8016, 0, 64 * 1024,  64)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ)\n\t\tOTP_INFO(256, 3, 0x1000, 0x1000) },\n\t{ \"w25q64jwm\", INFO(0xef8017, 0, 64 * 1024, 128)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25q128jwm\", INFO(0xef8018, 0, 64 * 1024, 256)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25q256jwm\", INFO(0xef8019, 0, 64 * 1024, 512)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25x64\", INFO(0xef3017, 0, 64 * 1024, 128)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q64\", INFO(0xef4017, 0, 64 * 1024, 128)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25q64dw\", INFO(0xef6017, 0, 64 * 1024, 128)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25q64jvm\", INFO(0xef7017, 0, 64 * 1024, 128)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q128fw\", INFO(0xef6018, 0, 64 * 1024, 256)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25q128jv\", INFO(0xef7018, 0, 64 * 1024, 256)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25q80\", INFO(0xef5014, 0, 64 * 1024,  16)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q80bl\", INFO(0xef4014, 0, 64 * 1024,  16)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"w25q128\", INFO(0xef4018, 0, 0, 0)\n\t\tPARSE_SFDP\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB) },\n\t{ \"w25q256\", INFO(0xef4019, 0, 64 * 1024, 512)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ)\n\t\t.fixups = &w25q256_fixups },\n\t{ \"w25q256jvm\", INFO(0xef7019, 0, 64 * 1024, 512)\n\t\tPARSE_SFDP },\n\t{ \"w25q256jw\", INFO(0xef6019, 0, 64 * 1024, 512)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n\t{ \"w25m512jv\", INFO(0xef7119, 0, 64 * 1024, 1024)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ |\n\t\t\t      SPI_NOR_DUAL_READ) },\n\t{ \"w25q512nwq\", INFO(0xef6020, 0, 0, 0)\n\t\tPARSE_SFDP\n\t\tOTP_INFO(256, 3, 0x1000, 0x1000) },\n\t{ \"w25q512nwm\", INFO(0xef8020, 0, 64 * 1024, 1024)\n\t\tPARSE_SFDP\n\t\tOTP_INFO(256, 3, 0x1000, 0x1000) },\n\t{ \"w25q512jvq\", INFO(0xef4020, 0, 64 * 1024, 1024)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ) },\n};\n\n \nstatic int winbond_nor_write_ear(struct spi_nor *nor, u8 ear)\n{\n\tint ret;\n\n\tnor->bouncebuf[0] = ear;\n\n\tif (nor->spimem) {\n\t\tstruct spi_mem_op op = WINBOND_NOR_WREAR_OP(nor->bouncebuf);\n\n\t\tspi_nor_spimem_setup_op(nor, &op, nor->reg_proto);\n\n\t\tret = spi_mem_exec_op(nor->spimem, &op);\n\t} else {\n\t\tret = spi_nor_controller_ops_write_reg(nor,\n\t\t\t\t\t\t       WINBOND_NOR_OP_WREAR,\n\t\t\t\t\t\t       nor->bouncebuf, 1);\n\t}\n\n\tif (ret)\n\t\tdev_dbg(nor->dev, \"error %d writing EAR\\n\", ret);\n\n\treturn ret;\n}\n\n \nstatic int winbond_nor_set_4byte_addr_mode(struct spi_nor *nor, bool enable)\n{\n\tint ret;\n\n\tret = spi_nor_set_4byte_addr_mode_en4b_ex4b(nor, enable);\n\tif (ret || enable)\n\t\treturn ret;\n\n\t \n\tret = spi_nor_write_enable(nor);\n\tif (ret)\n\t\treturn ret;\n\n\tret = winbond_nor_write_ear(nor, 0);\n\tif (ret)\n\t\treturn ret;\n\n\treturn spi_nor_write_disable(nor);\n}\n\nstatic const struct spi_nor_otp_ops winbond_nor_otp_ops = {\n\t.read = spi_nor_otp_read_secr,\n\t.write = spi_nor_otp_write_secr,\n\t.erase = spi_nor_otp_erase_secr,\n\t.lock = spi_nor_otp_lock_sr2,\n\t.is_locked = spi_nor_otp_is_locked_sr2,\n};\n\nstatic int winbond_nor_late_init(struct spi_nor *nor)\n{\n\tstruct spi_nor_flash_parameter *params = nor->params;\n\n\tif (params->otp.org->n_regions)\n\t\tparams->otp.ops = &winbond_nor_otp_ops;\n\n\t \n\tparams->set_4byte_addr_mode = winbond_nor_set_4byte_addr_mode;\n\n\treturn 0;\n}\n\nstatic const struct spi_nor_fixups winbond_nor_fixups = {\n\t.late_init = winbond_nor_late_init,\n};\n\nconst struct spi_nor_manufacturer spi_nor_winbond = {\n\t.name = \"winbond\",\n\t.parts = winbond_nor_parts,\n\t.nparts = ARRAY_SIZE(winbond_nor_parts),\n\t.fixups = &winbond_nor_fixups,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}