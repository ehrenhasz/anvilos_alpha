{
  "module_name": "micron-st.c",
  "hash_id": "fae9f3403461ec9e5b2c5f44ce1c4fe051fa54d5c49376e23af4d4fa147c6f17",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/spi-nor/micron-st.c",
  "human_readable_source": "\n \n\n#include <linux/mtd/spi-nor.h>\n\n#include \"core.h\"\n\n \n#define USE_FSR\t\tBIT(0)\n\n#define SPINOR_OP_RDFSR\t\t0x70\t \n#define SPINOR_OP_CLFSR\t\t0x50\t \n#define SPINOR_OP_MT_DTR_RD\t0xfd\t \n#define SPINOR_OP_MT_RD_ANY_REG\t0x85\t \n#define SPINOR_OP_MT_WR_ANY_REG\t0x81\t \n#define SPINOR_REG_MT_CFR0V\t0x00\t \n#define SPINOR_REG_MT_CFR1V\t0x01\t \n#define SPINOR_REG_MT_CFR1V_DEF\t0x1f\t \n#define SPINOR_MT_OCT_DTR\t0xe7\t \n#define SPINOR_MT_EXSPI\t\t0xff\t \n\n \n#define FSR_READY\t\tBIT(7)\t \n#define FSR_E_ERR\t\tBIT(5)\t \n#define FSR_P_ERR\t\tBIT(4)\t \n#define FSR_PT_ERR\t\tBIT(1)\t \n\n \n#define MICRON_ST_NOR_WR_ANY_REG_OP(naddr, addr, ndata, buf)\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(SPINOR_OP_MT_WR_ANY_REG, 0),\t\t\\\n\t\t   SPI_MEM_OP_ADDR(naddr, addr, 0),\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_OUT(ndata, buf, 0))\n\n#define MICRON_ST_RDFSR_OP(buf)\t\t\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(SPINOR_OP_RDFSR, 0),\t\t\t\\\n\t\t   SPI_MEM_OP_NO_ADDR,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(1, buf, 0))\n\n#define MICRON_ST_CLFSR_OP\t\t\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(SPINOR_OP_CLFSR, 0),\t\t\t\\\n\t\t   SPI_MEM_OP_NO_ADDR,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DATA)\n\nstatic int micron_st_nor_octal_dtr_en(struct spi_nor *nor)\n{\n\tstruct spi_mem_op op;\n\tu8 *buf = nor->bouncebuf;\n\tint ret;\n\tu8 addr_mode_nbytes = nor->params->addr_mode_nbytes;\n\n\t \n\t*buf = 20;\n\top = (struct spi_mem_op)\n\t\tMICRON_ST_NOR_WR_ANY_REG_OP(addr_mode_nbytes,\n\t\t\t\t\t    SPINOR_REG_MT_CFR1V, 1, buf);\n\tret = spi_nor_write_any_volatile_reg(nor, &op, nor->reg_proto);\n\tif (ret)\n\t\treturn ret;\n\n\tbuf[0] = SPINOR_MT_OCT_DTR;\n\top = (struct spi_mem_op)\n\t\tMICRON_ST_NOR_WR_ANY_REG_OP(addr_mode_nbytes,\n\t\t\t\t\t    SPINOR_REG_MT_CFR0V, 1, buf);\n\tret = spi_nor_write_any_volatile_reg(nor, &op, nor->reg_proto);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = spi_nor_read_id(nor, 0, 8, buf, SNOR_PROTO_8_8_8_DTR);\n\tif (ret) {\n\t\tdev_dbg(nor->dev, \"error %d reading JEDEC ID after enabling 8D-8D-8D mode\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (memcmp(buf, nor->info->id, nor->info->id_len))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int micron_st_nor_octal_dtr_dis(struct spi_nor *nor)\n{\n\tstruct spi_mem_op op;\n\tu8 *buf = nor->bouncebuf;\n\tint ret;\n\n\t \n\tbuf[0] = SPINOR_MT_EXSPI;\n\tbuf[1] = SPINOR_REG_MT_CFR1V_DEF;\n\top = (struct spi_mem_op)\n\t\tMICRON_ST_NOR_WR_ANY_REG_OP(nor->addr_nbytes,\n\t\t\t\t\t    SPINOR_REG_MT_CFR0V, 2, buf);\n\tret = spi_nor_write_any_volatile_reg(nor, &op, SNOR_PROTO_8_8_8_DTR);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = spi_nor_read_id(nor, 0, 0, buf, SNOR_PROTO_1_1_1);\n\tif (ret) {\n\t\tdev_dbg(nor->dev, \"error %d reading JEDEC ID after disabling 8D-8D-8D mode\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (memcmp(buf, nor->info->id, nor->info->id_len))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int micron_st_nor_set_octal_dtr(struct spi_nor *nor, bool enable)\n{\n\treturn enable ? micron_st_nor_octal_dtr_en(nor) :\n\t\t\tmicron_st_nor_octal_dtr_dis(nor);\n}\n\nstatic void mt35xu512aba_default_init(struct spi_nor *nor)\n{\n\tnor->params->set_octal_dtr = micron_st_nor_set_octal_dtr;\n}\n\nstatic int mt35xu512aba_post_sfdp_fixup(struct spi_nor *nor)\n{\n\t \n\tnor->params->hwcaps.mask |= SNOR_HWCAPS_READ_8_8_8_DTR;\n\tspi_nor_set_read_settings(&nor->params->reads[SNOR_CMD_READ_8_8_8_DTR],\n\t\t\t\t  0, 20, SPINOR_OP_MT_DTR_RD,\n\t\t\t\t  SNOR_PROTO_8_8_8_DTR);\n\n\tnor->cmd_ext_type = SPI_NOR_EXT_REPEAT;\n\tnor->params->rdsr_dummy = 8;\n\tnor->params->rdsr_addr_nbytes = 0;\n\n\t \n\tnor->params->quad_enable = NULL;\n\n\treturn 0;\n}\n\nstatic const struct spi_nor_fixups mt35xu512aba_fixups = {\n\t.default_init = mt35xu512aba_default_init,\n\t.post_sfdp = mt35xu512aba_post_sfdp_fixup,\n};\n\nstatic const struct flash_info micron_nor_parts[] = {\n\t{ \"mt35xu512aba\", INFO(0x2c5b1a, 0, 128 * 1024, 512)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_OCTAL_READ |\n\t\t\t   SPI_NOR_OCTAL_DTR_READ | SPI_NOR_OCTAL_DTR_PP)\n\t\tFIXUP_FLAGS(SPI_NOR_4B_OPCODES | SPI_NOR_IO_MODE_EN_VOLATILE)\n\t\tMFR_FLAGS(USE_FSR)\n\t\t.fixups = &mt35xu512aba_fixups\n\t},\n\t{ \"mt35xu02g\", INFO(0x2c5b1c, 0, 128 * 1024, 2048)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_OCTAL_READ)\n\t\tFIXUP_FLAGS(SPI_NOR_4B_OPCODES)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n};\n\nstatic const struct flash_info st_nor_parts[] = {\n\t{ \"n25q016a\",\t INFO(0x20bb15, 0, 64 * 1024,   32)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ) },\n\t{ \"n25q032\",\t INFO(0x20ba16, 0, 64 * 1024,   64)\n\t\tNO_SFDP_FLAGS(SPI_NOR_QUAD_READ) },\n\t{ \"n25q032a\",\t INFO(0x20bb16, 0, 64 * 1024,   64)\n\t\tNO_SFDP_FLAGS(SPI_NOR_QUAD_READ) },\n\t{ \"n25q064\",     INFO(0x20ba17, 0, 64 * 1024,  128)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ) },\n\t{ \"n25q064a\",    INFO(0x20bb17, 0, 64 * 1024,  128)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ) },\n\t{ \"n25q128a11\",  INFO(0x20bb18, 0, 64 * 1024,  256)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB | SPI_NOR_4BIT_BP |\n\t\t      SPI_NOR_BP3_SR_BIT6)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"n25q128a13\",  INFO(0x20ba18, 0, 64 * 1024,  256)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB | SPI_NOR_4BIT_BP |\n\t\t      SPI_NOR_BP3_SR_BIT6)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"mt25ql256a\",  INFO6(0x20ba19, 0x104400, 64 * 1024,  512)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ)\n\t\tFIXUP_FLAGS(SPI_NOR_4B_OPCODES)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"n25q256a\",    INFO(0x20ba19, 0, 64 * 1024,  512)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"mt25qu256a\",  INFO6(0x20bb19, 0x104400, 64 * 1024,  512)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB | SPI_NOR_4BIT_BP |\n\t\t      SPI_NOR_BP3_SR_BIT6)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ)\n\t\tFIXUP_FLAGS(SPI_NOR_4B_OPCODES)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"n25q256ax1\",  INFO(0x20bb19, 0, 64 * 1024,  512)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"mt25ql512a\",  INFO6(0x20ba20, 0x104400, 64 * 1024, 1024)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ)\n\t\tFIXUP_FLAGS(SPI_NOR_4B_OPCODES)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"n25q512ax3\",  INFO(0x20ba20, 0, 64 * 1024, 1024)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB | SPI_NOR_4BIT_BP |\n\t\t      SPI_NOR_BP3_SR_BIT6)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"mt25qu512a\",  INFO6(0x20bb20, 0x104400, 64 * 1024, 1024)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ)\n\t\tFIXUP_FLAGS(SPI_NOR_4B_OPCODES)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"n25q512a\",    INFO(0x20bb20, 0, 64 * 1024, 1024)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB | SPI_NOR_4BIT_BP |\n\t\t      SPI_NOR_BP3_SR_BIT6)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"n25q00\",      INFO(0x20ba21, 0, 64 * 1024, 2048)\n\t\tFLAGS(SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB | SPI_NOR_4BIT_BP |\n\t\t      SPI_NOR_BP3_SR_BIT6 | NO_CHIP_ERASE)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"n25q00a\",     INFO(0x20bb21, 0, 64 * 1024, 2048)\n\t\tFLAGS(NO_CHIP_ERASE)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"mt25ql02g\",   INFO(0x20ba22, 0, 64 * 1024, 4096)\n\t\tFLAGS(NO_CHIP_ERASE)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\t{ \"mt25qu02g\",   INFO(0x20bb22, 0, 64 * 1024, 4096)\n\t\tFLAGS(NO_CHIP_ERASE)\n\t\tNO_SFDP_FLAGS(SECT_4K | SPI_NOR_DUAL_READ |\n\t\t\t      SPI_NOR_QUAD_READ)\n\t\tMFR_FLAGS(USE_FSR)\n\t},\n\n\t{ \"m25p05\",  INFO(0x202010,  0,  32 * 1024,   2) },\n\t{ \"m25p10\",  INFO(0x202011,  0,  32 * 1024,   4) },\n\t{ \"m25p20\",  INFO(0x202012,  0,  64 * 1024,   4) },\n\t{ \"m25p40\",  INFO(0x202013,  0,  64 * 1024,   8) },\n\t{ \"m25p80\",  INFO(0x202014,  0,  64 * 1024,  16) },\n\t{ \"m25p16\",  INFO(0x202015,  0,  64 * 1024,  32) },\n\t{ \"m25p32\",  INFO(0x202016,  0,  64 * 1024,  64) },\n\t{ \"m25p64\",  INFO(0x202017,  0,  64 * 1024, 128) },\n\t{ \"m25p128\", INFO(0x202018,  0, 256 * 1024,  64) },\n\n\t{ \"m25p05-nonjedec\",  INFO(0, 0,  32 * 1024,   2) },\n\t{ \"m25p10-nonjedec\",  INFO(0, 0,  32 * 1024,   4) },\n\t{ \"m25p20-nonjedec\",  INFO(0, 0,  64 * 1024,   4) },\n\t{ \"m25p40-nonjedec\",  INFO(0, 0,  64 * 1024,   8) },\n\t{ \"m25p80-nonjedec\",  INFO(0, 0,  64 * 1024,  16) },\n\t{ \"m25p16-nonjedec\",  INFO(0, 0,  64 * 1024,  32) },\n\t{ \"m25p32-nonjedec\",  INFO(0, 0,  64 * 1024,  64) },\n\t{ \"m25p64-nonjedec\",  INFO(0, 0,  64 * 1024, 128) },\n\t{ \"m25p128-nonjedec\", INFO(0, 0, 256 * 1024,  64) },\n\n\t{ \"m45pe10\", INFO(0x204011,  0, 64 * 1024,    2) },\n\t{ \"m45pe80\", INFO(0x204014,  0, 64 * 1024,   16) },\n\t{ \"m45pe16\", INFO(0x204015,  0, 64 * 1024,   32) },\n\n\t{ \"m25pe20\", INFO(0x208012,  0, 64 * 1024,  4) },\n\t{ \"m25pe80\", INFO(0x208014,  0, 64 * 1024, 16) },\n\t{ \"m25pe16\", INFO(0x208015,  0, 64 * 1024, 32)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\n\t{ \"m25px16\",    INFO(0x207115,  0, 64 * 1024, 32)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"m25px32\",    INFO(0x207116,  0, 64 * 1024, 64)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"m25px32-s0\", INFO(0x207316,  0, 64 * 1024, 64)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"m25px32-s1\", INFO(0x206316,  0, 64 * 1024, 64)\n\t\tNO_SFDP_FLAGS(SECT_4K) },\n\t{ \"m25px64\",    INFO(0x207117,  0, 64 * 1024, 128) },\n\t{ \"m25px80\",    INFO(0x207114,  0, 64 * 1024, 16) },\n};\n\n \nstatic int micron_st_nor_read_fsr(struct spi_nor *nor, u8 *fsr)\n{\n\tint ret;\n\n\tif (nor->spimem) {\n\t\tstruct spi_mem_op op = MICRON_ST_RDFSR_OP(fsr);\n\n\t\tif (nor->reg_proto == SNOR_PROTO_8_8_8_DTR) {\n\t\t\top.addr.nbytes = nor->params->rdsr_addr_nbytes;\n\t\t\top.dummy.nbytes = nor->params->rdsr_dummy;\n\t\t\t \n\t\t\top.data.nbytes = 2;\n\t\t}\n\n\t\tspi_nor_spimem_setup_op(nor, &op, nor->reg_proto);\n\n\t\tret = spi_mem_exec_op(nor->spimem, &op);\n\t} else {\n\t\tret = spi_nor_controller_ops_read_reg(nor, SPINOR_OP_RDFSR, fsr,\n\t\t\t\t\t\t      1);\n\t}\n\n\tif (ret)\n\t\tdev_dbg(nor->dev, \"error %d reading FSR\\n\", ret);\n\n\treturn ret;\n}\n\n \nstatic void micron_st_nor_clear_fsr(struct spi_nor *nor)\n{\n\tint ret;\n\n\tif (nor->spimem) {\n\t\tstruct spi_mem_op op = MICRON_ST_CLFSR_OP;\n\n\t\tspi_nor_spimem_setup_op(nor, &op, nor->reg_proto);\n\n\t\tret = spi_mem_exec_op(nor->spimem, &op);\n\t} else {\n\t\tret = spi_nor_controller_ops_write_reg(nor, SPINOR_OP_CLFSR,\n\t\t\t\t\t\t       NULL, 0);\n\t}\n\n\tif (ret)\n\t\tdev_dbg(nor->dev, \"error %d clearing FSR\\n\", ret);\n}\n\n \nstatic int micron_st_nor_ready(struct spi_nor *nor)\n{\n\tint sr_ready, ret;\n\n\tsr_ready = spi_nor_sr_ready(nor);\n\tif (sr_ready < 0)\n\t\treturn sr_ready;\n\n\tret = micron_st_nor_read_fsr(nor, nor->bouncebuf);\n\tif (ret) {\n\t\t \n\t\treturn ret == -EOPNOTSUPP ? sr_ready : ret;\n\t}\n\n\tif (nor->bouncebuf[0] & (FSR_E_ERR | FSR_P_ERR)) {\n\t\tif (nor->bouncebuf[0] & FSR_E_ERR)\n\t\t\tdev_err(nor->dev, \"Erase operation failed.\\n\");\n\t\telse\n\t\t\tdev_err(nor->dev, \"Program operation failed.\\n\");\n\n\t\tif (nor->bouncebuf[0] & FSR_PT_ERR)\n\t\t\tdev_err(nor->dev,\n\t\t\t\t\"Attempted to modify a protected sector.\\n\");\n\n\t\tmicron_st_nor_clear_fsr(nor);\n\n\t\t \n\t\tret = spi_nor_write_disable(nor);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\treturn -EIO;\n\t}\n\n\treturn sr_ready && !!(nor->bouncebuf[0] & FSR_READY);\n}\n\nstatic void micron_st_nor_default_init(struct spi_nor *nor)\n{\n\tnor->flags |= SNOR_F_HAS_LOCK;\n\tnor->flags &= ~SNOR_F_HAS_16BIT_SR;\n\tnor->params->quad_enable = NULL;\n}\n\nstatic int micron_st_nor_late_init(struct spi_nor *nor)\n{\n\tstruct spi_nor_flash_parameter *params = nor->params;\n\n\tif (nor->info->mfr_flags & USE_FSR)\n\t\tparams->ready = micron_st_nor_ready;\n\n\tif (!params->set_4byte_addr_mode)\n\t\tparams->set_4byte_addr_mode = spi_nor_set_4byte_addr_mode_wren_en4b_ex4b;\n\n\treturn 0;\n}\n\nstatic const struct spi_nor_fixups micron_st_nor_fixups = {\n\t.default_init = micron_st_nor_default_init,\n\t.late_init = micron_st_nor_late_init,\n};\n\nconst struct spi_nor_manufacturer spi_nor_micron = {\n\t.name = \"micron\",\n\t.parts = micron_nor_parts,\n\t.nparts = ARRAY_SIZE(micron_nor_parts),\n\t.fixups = &micron_st_nor_fixups,\n};\n\nconst struct spi_nor_manufacturer spi_nor_st = {\n\t.name = \"st\",\n\t.parts = st_nor_parts,\n\t.nparts = ARRAY_SIZE(st_nor_parts),\n\t.fixups = &micron_st_nor_fixups,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}