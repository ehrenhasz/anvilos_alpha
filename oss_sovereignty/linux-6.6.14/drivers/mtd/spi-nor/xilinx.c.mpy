{
  "module_name": "xilinx.c",
  "hash_id": "b29a8be6c7cbc3bbac852395b5f794351322736065d947da27c3760842a39b4d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/spi-nor/xilinx.c",
  "human_readable_source": "\n \n\n#include <linux/mtd/spi-nor.h>\n\n#include \"core.h\"\n\n#define XILINX_OP_SE\t\t0x50\t \n#define XILINX_OP_PP\t\t0x82\t \n#define XILINX_OP_RDSR\t\t0xd7\t \n\n#define XSR_PAGESIZE\t\tBIT(0)\t \n#define XSR_RDY\t\t\tBIT(7)\t \n\n#define XILINX_RDSR_OP(buf)\t\t\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(XILINX_OP_RDSR, 0),\t\t\t\\\n\t\t   SPI_MEM_OP_NO_ADDR,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(1, buf, 0))\n\n#define S3AN_INFO(_jedec_id, _n_sectors, _page_size)\t\t\t\\\n\t\t.id = {\t\t\t\t\t\t\t\\\n\t\t\t((_jedec_id) >> 16) & 0xff,\t\t\t\\\n\t\t\t((_jedec_id) >> 8) & 0xff,\t\t\t\\\n\t\t\t(_jedec_id) & 0xff\t\t\t\t\\\n\t\t\t},\t\t\t\t\t\t\\\n\t\t.id_len = 3,\t\t\t\t\t\t\\\n\t\t.sector_size = (8 * (_page_size)),\t\t\t\\\n\t\t.n_sectors = (_n_sectors),\t\t\t\t\\\n\t\t.page_size = (_page_size),\t\t\t\t\\\n\t\t.n_banks = 1,\t\t\t\t\t\t\\\n\t\t.addr_nbytes = 3,\t\t\t\t\t\\\n\t\t.flags = SPI_NOR_NO_FR\n\n \nstatic const struct flash_info xilinx_nor_parts[] = {\n\t \n\t{ \"3S50AN\", S3AN_INFO(0x1f2200, 64, 264) },\n\t{ \"3S200AN\", S3AN_INFO(0x1f2400, 256, 264) },\n\t{ \"3S400AN\", S3AN_INFO(0x1f2400, 256, 264) },\n\t{ \"3S700AN\", S3AN_INFO(0x1f2500, 512, 264) },\n\t{ \"3S1400AN\", S3AN_INFO(0x1f2600, 512, 528) },\n};\n\n \nstatic u32 s3an_nor_convert_addr(struct spi_nor *nor, u32 addr)\n{\n\tu32 page_size = nor->params->page_size;\n\tu32 offset, page;\n\n\toffset = addr % page_size;\n\tpage = addr / page_size;\n\tpage <<= (page_size > 512) ? 10 : 9;\n\n\treturn page | offset;\n}\n\n \nstatic int xilinx_nor_read_sr(struct spi_nor *nor, u8 *sr)\n{\n\tint ret;\n\n\tif (nor->spimem) {\n\t\tstruct spi_mem_op op = XILINX_RDSR_OP(sr);\n\n\t\tspi_nor_spimem_setup_op(nor, &op, nor->reg_proto);\n\n\t\tret = spi_mem_exec_op(nor->spimem, &op);\n\t} else {\n\t\tret = spi_nor_controller_ops_read_reg(nor, XILINX_OP_RDSR, sr,\n\t\t\t\t\t\t      1);\n\t}\n\n\tif (ret)\n\t\tdev_dbg(nor->dev, \"error %d reading SR\\n\", ret);\n\n\treturn ret;\n}\n\n \nstatic int xilinx_nor_sr_ready(struct spi_nor *nor)\n{\n\tint ret;\n\n\tret = xilinx_nor_read_sr(nor, nor->bouncebuf);\n\tif (ret)\n\t\treturn ret;\n\n\treturn !!(nor->bouncebuf[0] & XSR_RDY);\n}\n\nstatic int xilinx_nor_setup(struct spi_nor *nor,\n\t\t\t    const struct spi_nor_hwcaps *hwcaps)\n{\n\tu32 page_size;\n\tint ret;\n\n\tret = xilinx_nor_read_sr(nor, nor->bouncebuf);\n\tif (ret)\n\t\treturn ret;\n\n\tnor->erase_opcode = XILINX_OP_SE;\n\tnor->program_opcode = XILINX_OP_PP;\n\tnor->read_opcode = SPINOR_OP_READ;\n\tnor->flags |= SNOR_F_NO_OP_CHIP_ERASE;\n\n\t \n\tif (nor->bouncebuf[0] & XSR_PAGESIZE) {\n\t\t \n\t\tpage_size = (nor->params->page_size == 264) ? 256 : 512;\n\t\tnor->params->page_size = page_size;\n\t\tnor->mtd.writebufsize = page_size;\n\t\tnor->params->size = 8 * page_size * nor->info->n_sectors;\n\t\tnor->mtd.erasesize = 8 * page_size;\n\t} else {\n\t\t \n\t\tnor->params->convert_addr = s3an_nor_convert_addr;\n\t\tnor->mtd.erasesize = nor->info->sector_size;\n\t}\n\n\treturn 0;\n}\n\nstatic int xilinx_nor_late_init(struct spi_nor *nor)\n{\n\tnor->params->setup = xilinx_nor_setup;\n\tnor->params->ready = xilinx_nor_sr_ready;\n\n\treturn 0;\n}\n\nstatic const struct spi_nor_fixups xilinx_nor_fixups = {\n\t.late_init = xilinx_nor_late_init,\n};\n\nconst struct spi_nor_manufacturer spi_nor_xilinx = {\n\t.name = \"xilinx\",\n\t.parts = xilinx_nor_parts,\n\t.nparts = ARRAY_SIZE(xilinx_nor_parts),\n\t.fixups = &xilinx_nor_fixups,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}