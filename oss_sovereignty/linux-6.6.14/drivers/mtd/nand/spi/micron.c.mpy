{
  "module_name": "micron.c",
  "hash_id": "f6e4da0ccf617ba4086f8bf0a7952a1cdf7f8e9b252cb3e3b024a271fbf01296",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/nand/spi/micron.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/mtd/spinand.h>\n\n#define SPINAND_MFR_MICRON\t\t0x2c\n\n#define MICRON_STATUS_ECC_MASK\t\tGENMASK(6, 4)\n#define MICRON_STATUS_ECC_NO_BITFLIPS\t(0 << 4)\n#define MICRON_STATUS_ECC_1TO3_BITFLIPS\t(1 << 4)\n#define MICRON_STATUS_ECC_4TO6_BITFLIPS\t(3 << 4)\n#define MICRON_STATUS_ECC_7TO8_BITFLIPS\t(5 << 4)\n\n#define MICRON_CFG_CR\t\t\tBIT(0)\n\n \n#define MICRON_DIE_SELECT_REG\t0xD0\n\n#define MICRON_SELECT_DIE(x)\t((x) << 6)\n\nstatic SPINAND_OP_VARIANTS(quadio_read_cache_variants,\n\t\tSPINAND_PAGE_READ_FROM_CACHE_QUADIO_OP(0, 2, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_X4_OP(0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_DUALIO_OP(0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_X2_OP(0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_OP(true, 0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_OP(false, 0, 1, NULL, 0));\n\nstatic SPINAND_OP_VARIANTS(x4_write_cache_variants,\n\t\tSPINAND_PROG_LOAD_X4(true, 0, NULL, 0),\n\t\tSPINAND_PROG_LOAD(true, 0, NULL, 0));\n\nstatic SPINAND_OP_VARIANTS(x4_update_cache_variants,\n\t\tSPINAND_PROG_LOAD_X4(false, 0, NULL, 0),\n\t\tSPINAND_PROG_LOAD(false, 0, NULL, 0));\n\n \nstatic SPINAND_OP_VARIANTS(x4_read_cache_variants,\n\t\t\t   SPINAND_PAGE_READ_FROM_CACHE_X4_OP(0, 1, NULL, 0),\n\t\t\t   SPINAND_PAGE_READ_FROM_CACHE_X2_OP(0, 1, NULL, 0),\n\t\t\t   SPINAND_PAGE_READ_FROM_CACHE_OP(true, 0, 1, NULL, 0),\n\t\t\t   SPINAND_PAGE_READ_FROM_CACHE_OP(false, 0, 1, NULL, 0));\n\nstatic SPINAND_OP_VARIANTS(x1_write_cache_variants,\n\t\t\t   SPINAND_PROG_LOAD(true, 0, NULL, 0));\n\nstatic SPINAND_OP_VARIANTS(x1_update_cache_variants,\n\t\t\t   SPINAND_PROG_LOAD(false, 0, NULL, 0));\n\nstatic int micron_8_ooblayout_ecc(struct mtd_info *mtd, int section,\n\t\t\t\t  struct mtd_oob_region *region)\n{\n\tif (section)\n\t\treturn -ERANGE;\n\n\tregion->offset = mtd->oobsize / 2;\n\tregion->length = mtd->oobsize / 2;\n\n\treturn 0;\n}\n\nstatic int micron_8_ooblayout_free(struct mtd_info *mtd, int section,\n\t\t\t\t   struct mtd_oob_region *region)\n{\n\tif (section)\n\t\treturn -ERANGE;\n\n\t \n\tregion->offset = 2;\n\tregion->length = (mtd->oobsize / 2) - 2;\n\n\treturn 0;\n}\n\nstatic const struct mtd_ooblayout_ops micron_8_ooblayout = {\n\t.ecc = micron_8_ooblayout_ecc,\n\t.free = micron_8_ooblayout_free,\n};\n\nstatic int micron_4_ooblayout_ecc(struct mtd_info *mtd, int section,\n\t\t\t\t  struct mtd_oob_region *region)\n{\n\tstruct spinand_device *spinand = mtd_to_spinand(mtd);\n\n\tif (section >= spinand->base.memorg.pagesize /\n\t\t\tmtd->ecc_step_size)\n\t\treturn -ERANGE;\n\n\tregion->offset = (section * 16) + 8;\n\tregion->length = 8;\n\n\treturn 0;\n}\n\nstatic int micron_4_ooblayout_free(struct mtd_info *mtd, int section,\n\t\t\t\t   struct mtd_oob_region *region)\n{\n\tstruct spinand_device *spinand = mtd_to_spinand(mtd);\n\n\tif (section >= spinand->base.memorg.pagesize /\n\t\t\tmtd->ecc_step_size)\n\t\treturn -ERANGE;\n\n\tif (section) {\n\t\tregion->offset = 16 * section;\n\t\tregion->length = 8;\n\t} else {\n\t\t \n\t\tregion->offset = 2;\n\t\tregion->length = 6;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct mtd_ooblayout_ops micron_4_ooblayout = {\n\t.ecc = micron_4_ooblayout_ecc,\n\t.free = micron_4_ooblayout_free,\n};\n\nstatic int micron_select_target(struct spinand_device *spinand,\n\t\t\t\tunsigned int target)\n{\n\tstruct spi_mem_op op = SPINAND_SET_FEATURE_OP(MICRON_DIE_SELECT_REG,\n\t\t\t\t\t\t      spinand->scratchbuf);\n\n\tif (target > 1)\n\t\treturn -EINVAL;\n\n\t*spinand->scratchbuf = MICRON_SELECT_DIE(target);\n\n\treturn spi_mem_exec_op(spinand->spimem, &op);\n}\n\nstatic int micron_8_ecc_get_status(struct spinand_device *spinand,\n\t\t\t\t   u8 status)\n{\n\tswitch (status & MICRON_STATUS_ECC_MASK) {\n\tcase STATUS_ECC_NO_BITFLIPS:\n\t\treturn 0;\n\n\tcase STATUS_ECC_UNCOR_ERROR:\n\t\treturn -EBADMSG;\n\n\tcase MICRON_STATUS_ECC_1TO3_BITFLIPS:\n\t\treturn 3;\n\n\tcase MICRON_STATUS_ECC_4TO6_BITFLIPS:\n\t\treturn 6;\n\n\tcase MICRON_STATUS_ECC_7TO8_BITFLIPS:\n\t\treturn 8;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic const struct spinand_info micron_spinand_table[] = {\n\t \n\tSPINAND_INFO(\"MT29F2G01ABAGD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x24),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 2048, 40, 2, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&quadio_read_cache_variants,\n\t\t\t\t\t      &x4_write_cache_variants,\n\t\t\t\t\t      &x4_update_cache_variants),\n\t\t     0,\n\t\t     SPINAND_ECCINFO(&micron_8_ooblayout,\n\t\t\t\t     micron_8_ecc_get_status)),\n\t \n\tSPINAND_INFO(\"MT29F2G01ABBGD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x25),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 2048, 40, 2, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&quadio_read_cache_variants,\n\t\t\t\t\t      &x4_write_cache_variants,\n\t\t\t\t\t      &x4_update_cache_variants),\n\t\t     0,\n\t\t     SPINAND_ECCINFO(&micron_8_ooblayout,\n\t\t\t\t     micron_8_ecc_get_status)),\n\t \n\tSPINAND_INFO(\"MT29F1G01ABAFD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x14),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&quadio_read_cache_variants,\n\t\t\t\t\t      &x4_write_cache_variants,\n\t\t\t\t\t      &x4_update_cache_variants),\n\t\t     0,\n\t\t     SPINAND_ECCINFO(&micron_8_ooblayout,\n\t\t\t\t     micron_8_ecc_get_status)),\n\t \n\tSPINAND_INFO(\"MT29F1G01ABAFD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x15),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&quadio_read_cache_variants,\n\t\t\t\t\t      &x4_write_cache_variants,\n\t\t\t\t\t      &x4_update_cache_variants),\n\t\t     0,\n\t\t     SPINAND_ECCINFO(&micron_8_ooblayout,\n\t\t\t\t     micron_8_ecc_get_status)),\n\t \n\tSPINAND_INFO(\"MT29F4G01ADAGD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x36),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 2048, 80, 2, 1, 2),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&quadio_read_cache_variants,\n\t\t\t\t\t      &x4_write_cache_variants,\n\t\t\t\t\t      &x4_update_cache_variants),\n\t\t     0,\n\t\t     SPINAND_ECCINFO(&micron_8_ooblayout,\n\t\t\t\t     micron_8_ecc_get_status),\n\t\t     SPINAND_SELECT_TARGET(micron_select_target)),\n\t \n\tSPINAND_INFO(\"MT29F4G01ABAFD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x34),\n\t\t     NAND_MEMORG(1, 4096, 256, 64, 2048, 40, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&quadio_read_cache_variants,\n\t\t\t\t\t      &x4_write_cache_variants,\n\t\t\t\t\t      &x4_update_cache_variants),\n\t\t     SPINAND_HAS_CR_FEAT_BIT,\n\t\t     SPINAND_ECCINFO(&micron_8_ooblayout,\n\t\t\t\t     micron_8_ecc_get_status)),\n\t \n\tSPINAND_INFO(\"MT29F4G01ABBFD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x35),\n\t\t     NAND_MEMORG(1, 4096, 256, 64, 2048, 40, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&quadio_read_cache_variants,\n\t\t\t\t\t      &x4_write_cache_variants,\n\t\t\t\t\t      &x4_update_cache_variants),\n\t\t     SPINAND_HAS_CR_FEAT_BIT,\n\t\t     SPINAND_ECCINFO(&micron_8_ooblayout,\n\t\t\t\t     micron_8_ecc_get_status)),\n\t \n\tSPINAND_INFO(\"MT29F8G01ADAFD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x46),\n\t\t     NAND_MEMORG(1, 4096, 256, 64, 2048, 40, 1, 1, 2),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&quadio_read_cache_variants,\n\t\t\t\t\t      &x4_write_cache_variants,\n\t\t\t\t\t      &x4_update_cache_variants),\n\t\t     SPINAND_HAS_CR_FEAT_BIT,\n\t\t     SPINAND_ECCINFO(&micron_8_ooblayout,\n\t\t\t\t     micron_8_ecc_get_status),\n\t\t     SPINAND_SELECT_TARGET(micron_select_target)),\n\t \n\tSPINAND_INFO(\"MT29F8G01ADBFD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x47),\n\t\t     NAND_MEMORG(1, 4096, 256, 64, 2048, 40, 1, 1, 2),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&quadio_read_cache_variants,\n\t\t\t\t\t      &x4_write_cache_variants,\n\t\t\t\t\t      &x4_update_cache_variants),\n\t\t     SPINAND_HAS_CR_FEAT_BIT,\n\t\t     SPINAND_ECCINFO(&micron_8_ooblayout,\n\t\t\t\t     micron_8_ecc_get_status),\n\t\t     SPINAND_SELECT_TARGET(micron_select_target)),\n\t \n\tSPINAND_INFO(\"MT29F2G01AAAED\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x9F),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 2048, 80, 2, 1, 1),\n\t\t     NAND_ECCREQ(4, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&x4_read_cache_variants,\n\t\t\t\t\t      &x1_write_cache_variants,\n\t\t\t\t\t      &x1_update_cache_variants),\n\t\t     0,\n\t\t     SPINAND_ECCINFO(&micron_4_ooblayout, NULL)),\n};\n\nstatic int micron_spinand_init(struct spinand_device *spinand)\n{\n\t \n\tif (spinand->flags & SPINAND_HAS_CR_FEAT_BIT)\n\t\treturn spinand_upd_cfg(spinand, MICRON_CFG_CR, 0);\n\n\treturn 0;\n}\n\nstatic const struct spinand_manufacturer_ops micron_spinand_manuf_ops = {\n\t.init = micron_spinand_init,\n};\n\nconst struct spinand_manufacturer micron_spinand_manufacturer = {\n\t.id = SPINAND_MFR_MICRON,\n\t.name = \"Micron\",\n\t.chips = micron_spinand_table,\n\t.nchips = ARRAY_SIZE(micron_spinand_table),\n\t.ops = &micron_spinand_manuf_ops,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}