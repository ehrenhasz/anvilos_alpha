{
  "module_name": "alliancememory.c",
  "hash_id": "bccf2ac59366f47bd6c79caee7ccd314ce36fd87f33c5131a5c8d8a9a4e95cd8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/nand/spi/alliancememory.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/mtd/spinand.h>\n\n#define SPINAND_MFR_ALLIANCEMEMORY\t0x52\n\n#define AM_STATUS_ECC_BITMASK\t\t(3 << 4)\n\n#define AM_STATUS_ECC_NONE_DETECTED\t(0 << 4)\n#define AM_STATUS_ECC_CORRECTED\t\t(1 << 4)\n#define AM_STATUS_ECC_ERRORED\t\t(2 << 4)\n#define AM_STATUS_ECC_MAX_CORRECTED\t(3 << 4)\n\nstatic SPINAND_OP_VARIANTS(read_cache_variants,\n\t\tSPINAND_PAGE_READ_FROM_CACHE_QUADIO_OP(0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_X4_OP(0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_DUALIO_OP(0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_X2_OP(0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_OP(true, 0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_OP(false, 0, 1, NULL, 0));\n\nstatic SPINAND_OP_VARIANTS(write_cache_variants,\n\t\t\t   SPINAND_PROG_LOAD_X4(true, 0, NULL, 0),\n\t\t\t   SPINAND_PROG_LOAD(true, 0, NULL, 0));\n\nstatic SPINAND_OP_VARIANTS(update_cache_variants,\n\t\t\t   SPINAND_PROG_LOAD_X4(false, 0, NULL, 0),\n\t\t\t   SPINAND_PROG_LOAD(false, 0, NULL, 0));\n\nstatic int am_get_eccsize(struct mtd_info *mtd)\n{\n\tif (mtd->oobsize == 64)\n\t\treturn 0x20;\n\telse if (mtd->oobsize == 128)\n\t\treturn 0x38;\n\telse if (mtd->oobsize == 256)\n\t\treturn 0x70;\n\telse\n\t\treturn -EINVAL;\n}\n\nstatic int am_ooblayout_ecc(struct mtd_info *mtd, int section,\n\t\t\t    struct mtd_oob_region *region)\n{\n\tint ecc_bytes;\n\n\tecc_bytes = am_get_eccsize(mtd);\n\tif (ecc_bytes < 0)\n\t\treturn ecc_bytes;\n\n\tregion->offset = mtd->oobsize - ecc_bytes;\n\tregion->length = ecc_bytes;\n\n\treturn 0;\n}\n\nstatic int am_ooblayout_free(struct mtd_info *mtd, int section,\n\t\t\t     struct mtd_oob_region *region)\n{\n\tint ecc_bytes;\n\n\tif (section)\n\t\treturn -ERANGE;\n\n\tecc_bytes = am_get_eccsize(mtd);\n\tif (ecc_bytes < 0)\n\t\treturn ecc_bytes;\n\n\t \n\n\tregion->offset = 2;\n\tregion->length = mtd->oobsize - 2 - ecc_bytes;\n\n\treturn 0;\n}\n\nstatic const struct mtd_ooblayout_ops am_ooblayout = {\n\t.ecc = am_ooblayout_ecc,\n\t.free = am_ooblayout_free,\n};\n\nstatic int am_ecc_get_status(struct spinand_device *spinand, u8 status)\n{\n\tswitch (status & AM_STATUS_ECC_BITMASK) {\n\tcase AM_STATUS_ECC_NONE_DETECTED:\n\t\treturn 0;\n\n\tcase AM_STATUS_ECC_CORRECTED:\n\t\t \n\t\tif (spinand->base.mtd.oobsize == 64)\n\t\t\treturn 3;\n\t\telse\n\t\t\treturn 7;\n\n\tcase AM_STATUS_ECC_ERRORED:\n\t\treturn -EBADMSG;\n\n\tcase AM_STATUS_ECC_MAX_CORRECTED:\n\t\t \n\t\tif (spinand->base.mtd.oobsize == 64)\n\t\t\treturn 4;\n\t\telse\n\t\t\treturn 8;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic const struct spinand_info alliancememory_spinand_table[] = {\n\tSPINAND_INFO(\"AS5F34G04SND\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x2f),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 4096, 80, 1, 1, 1),\n\t\t     NAND_ECCREQ(4, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&am_ooblayout,\n\t\t\t\t     am_ecc_get_status)),\n};\n\nstatic const struct spinand_manufacturer_ops alliancememory_spinand_manuf_ops = {\n};\n\nconst struct spinand_manufacturer alliancememory_spinand_manufacturer = {\n\t.id = SPINAND_MFR_ALLIANCEMEMORY,\n\t.name = \"AllianceMemory\",\n\t.chips = alliancememory_spinand_table,\n\t.nchips = ARRAY_SIZE(alliancememory_spinand_table),\n\t.ops = &alliancememory_spinand_manuf_ops,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}