{
  "module_name": "macronix.c",
  "hash_id": "5953e7fc6d040f4f9357c2221c658732308c27480f405dc96d314a01d9ae970d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/nand/spi/macronix.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/mtd/spinand.h>\n\n#define SPINAND_MFR_MACRONIX\t\t0xC2\n#define MACRONIX_ECCSR_MASK\t\t0x0F\n\nstatic SPINAND_OP_VARIANTS(read_cache_variants,\n\t\tSPINAND_PAGE_READ_FROM_CACHE_X4_OP(0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_X2_OP(0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_OP(true, 0, 1, NULL, 0),\n\t\tSPINAND_PAGE_READ_FROM_CACHE_OP(false, 0, 1, NULL, 0));\n\nstatic SPINAND_OP_VARIANTS(write_cache_variants,\n\t\tSPINAND_PROG_LOAD_X4(true, 0, NULL, 0),\n\t\tSPINAND_PROG_LOAD(false, 0, NULL, 0));\n\nstatic SPINAND_OP_VARIANTS(update_cache_variants,\n\t\tSPINAND_PROG_LOAD_X4(false, 0, NULL, 0),\n\t\tSPINAND_PROG_LOAD(false, 0, NULL, 0));\n\nstatic int mx35lfxge4ab_ooblayout_ecc(struct mtd_info *mtd, int section,\n\t\t\t\t      struct mtd_oob_region *region)\n{\n\treturn -ERANGE;\n}\n\nstatic int mx35lfxge4ab_ooblayout_free(struct mtd_info *mtd, int section,\n\t\t\t\t       struct mtd_oob_region *region)\n{\n\tif (section)\n\t\treturn -ERANGE;\n\n\tregion->offset = 2;\n\tregion->length = mtd->oobsize - 2;\n\n\treturn 0;\n}\n\nstatic const struct mtd_ooblayout_ops mx35lfxge4ab_ooblayout = {\n\t.ecc = mx35lfxge4ab_ooblayout_ecc,\n\t.free = mx35lfxge4ab_ooblayout_free,\n};\n\nstatic int mx35lf1ge4ab_get_eccsr(struct spinand_device *spinand, u8 *eccsr)\n{\n\tstruct spi_mem_op op = SPI_MEM_OP(SPI_MEM_OP_CMD(0x7c, 1),\n\t\t\t\t\t  SPI_MEM_OP_NO_ADDR,\n\t\t\t\t\t  SPI_MEM_OP_DUMMY(1, 1),\n\t\t\t\t\t  SPI_MEM_OP_DATA_IN(1, eccsr, 1));\n\n\tint ret = spi_mem_exec_op(spinand->spimem, &op);\n\tif (ret)\n\t\treturn ret;\n\n\t*eccsr &= MACRONIX_ECCSR_MASK;\n\treturn 0;\n}\n\nstatic int mx35lf1ge4ab_ecc_get_status(struct spinand_device *spinand,\n\t\t\t\t       u8 status)\n{\n\tstruct nand_device *nand = spinand_to_nand(spinand);\n\tu8 eccsr;\n\n\tswitch (status & STATUS_ECC_MASK) {\n\tcase STATUS_ECC_NO_BITFLIPS:\n\t\treturn 0;\n\n\tcase STATUS_ECC_UNCOR_ERROR:\n\t\treturn -EBADMSG;\n\n\tcase STATUS_ECC_HAS_BITFLIPS:\n\t\t \n\t\tif (mx35lf1ge4ab_get_eccsr(spinand, spinand->scratchbuf))\n\t\t\treturn nanddev_get_ecc_conf(nand)->strength;\n\n\t\teccsr = *spinand->scratchbuf;\n\t\tif (WARN_ON(eccsr > nanddev_get_ecc_conf(nand)->strength ||\n\t\t\t    !eccsr))\n\t\t\treturn nanddev_get_ecc_conf(nand)->strength;\n\n\t\treturn eccsr;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic const struct spinand_info macronix_spinand_table[] = {\n\tSPINAND_INFO(\"MX35LF1GE4AB\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x12),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(4, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35LF2GE4AB\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x22),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 2048, 40, 2, 1, 1),\n\t\t     NAND_ECCREQ(4, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout, NULL)),\n\tSPINAND_INFO(\"MX35LF2GE4AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x26),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 2048, 40, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35LF4GE4AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x37),\n\t\t     NAND_MEMORG(1, 4096, 128, 64, 2048, 40, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35LF1G24AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x14),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout, NULL)),\n\tSPINAND_INFO(\"MX35LF2G24AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x24),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 2048, 40, 2, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout, NULL)),\n\tSPINAND_INFO(\"MX35LF4G24AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x35),\n\t\t     NAND_MEMORG(1, 4096, 256, 64, 2048, 40, 2, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout, NULL)),\n\tSPINAND_INFO(\"MX31LF1GE4BC\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x1e),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX31UF1GE4BC\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x9e),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\n\tSPINAND_INFO(\"MX35LF2G14AC\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x20),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 2048, 40, 2, 1, 1),\n\t\t     NAND_ECCREQ(4, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF4G24AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xb5),\n\t\t     NAND_MEMORG(1, 4096, 256, 64, 2048, 40, 2, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF4GE4AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xb7),\n\t\t     NAND_MEMORG(1, 4096, 256, 64, 2048, 40, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF2G14AC\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xa0),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 2048, 40, 2, 1, 1),\n\t\t     NAND_ECCREQ(4, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF2G24AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xa4),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 2048, 40, 2, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF2GE4AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xa6),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 2048, 40, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF2GE4AC\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xa2),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 2048, 40, 1, 1, 1),\n\t\t     NAND_ECCREQ(4, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF1G14AC\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x90),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(4, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF1G24AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x94),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF1GE4AD\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x96),\n\t\t     NAND_MEMORG(1, 2048, 128, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX35UF1GE4AC\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x92),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 1024, 20, 1, 1, 1),\n\t\t     NAND_ECCREQ(4, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\n\tSPINAND_INFO(\"MX31LF2GE4BC\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0x2e),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 2048, 40, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n\tSPINAND_INFO(\"MX3UF2GE4BC\",\n\t\t     SPINAND_ID(SPINAND_READID_METHOD_OPCODE_DUMMY, 0xae),\n\t\t     NAND_MEMORG(1, 2048, 64, 64, 2048, 40, 1, 1, 1),\n\t\t     NAND_ECCREQ(8, 512),\n\t\t     SPINAND_INFO_OP_VARIANTS(&read_cache_variants,\n\t\t\t\t\t      &write_cache_variants,\n\t\t\t\t\t      &update_cache_variants),\n\t\t     SPINAND_HAS_QE_BIT,\n\t\t     SPINAND_ECCINFO(&mx35lfxge4ab_ooblayout,\n\t\t\t\t     mx35lf1ge4ab_ecc_get_status)),\n};\n\nstatic const struct spinand_manufacturer_ops macronix_spinand_manuf_ops = {\n};\n\nconst struct spinand_manufacturer macronix_spinand_manufacturer = {\n\t.id = SPINAND_MFR_MACRONIX,\n\t.name = \"Macronix\",\n\t.chips = macronix_spinand_table,\n\t.nchips = ARRAY_SIZE(macronix_spinand_table),\n\t.ops = &macronix_spinand_manuf_ops,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}