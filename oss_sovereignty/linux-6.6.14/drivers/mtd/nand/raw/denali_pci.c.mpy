{
  "module_name": "denali_pci.c",
  "hash_id": "970e3faf7e8bc992c614aca2f06f0c2a3bf4b45524e749b6f1962c460c2a2d9e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/nand/raw/denali_pci.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n\n#include \"denali.h\"\n\n#define DENALI_NAND_NAME    \"denali-nand-pci\"\n\n#define INTEL_CE4100\t1\n#define INTEL_MRST\t2\n\n \nstatic const struct pci_device_id denali_pci_ids[] = {\n\t{ PCI_VDEVICE(INTEL, 0x0701), INTEL_CE4100 },\n\t{ PCI_VDEVICE(INTEL, 0x0809), INTEL_MRST },\n\t{   }\n};\nMODULE_DEVICE_TABLE(pci, denali_pci_ids);\n\nNAND_ECC_CAPS_SINGLE(denali_pci_ecc_caps, denali_calc_ecc_bytes, 512, 8, 15);\n\nstatic int denali_pci_probe(struct pci_dev *dev, const struct pci_device_id *id)\n{\n\tresource_size_t csr_base, mem_base;\n\tunsigned long csr_len, mem_len;\n\tstruct denali_controller *denali;\n\tstruct denali_chip *dchip;\n\tint nsels, ret, i;\n\n\tdenali = devm_kzalloc(&dev->dev, sizeof(*denali), GFP_KERNEL);\n\tif (!denali)\n\t\treturn -ENOMEM;\n\n\tret = pcim_enable_device(dev);\n\tif (ret) {\n\t\tdev_err(&dev->dev, \"Spectra: pci_enable_device failed.\\n\");\n\t\treturn ret;\n\t}\n\n\tif (id->driver_data == INTEL_CE4100) {\n\t\tmem_base = pci_resource_start(dev, 0);\n\t\tmem_len = pci_resource_len(dev, 1);\n\t\tcsr_base = pci_resource_start(dev, 1);\n\t\tcsr_len = pci_resource_len(dev, 1);\n\t} else {\n\t\tcsr_base = pci_resource_start(dev, 0);\n\t\tcsr_len = pci_resource_len(dev, 0);\n\t\tmem_base = pci_resource_start(dev, 1);\n\t\tmem_len = pci_resource_len(dev, 1);\n\t\tif (!mem_len) {\n\t\t\tmem_base = csr_base + csr_len;\n\t\t\tmem_len = csr_len;\n\t\t}\n\t}\n\n\tpci_set_master(dev);\n\tdenali->dev = &dev->dev;\n\tdenali->irq = dev->irq;\n\tdenali->ecc_caps = &denali_pci_ecc_caps;\n\tdenali->clk_rate = 50000000;\t\t \n\tdenali->clk_x_rate = 200000000;\t\t \n\n\tret = pci_request_regions(dev, DENALI_NAND_NAME);\n\tif (ret) {\n\t\tdev_err(&dev->dev, \"Spectra: Unable to request memory regions\\n\");\n\t\treturn ret;\n\t}\n\n\tdenali->reg = devm_ioremap(denali->dev, csr_base, csr_len);\n\tif (!denali->reg) {\n\t\tdev_err(&dev->dev, \"Spectra: Unable to remap memory region\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tdenali->host = devm_ioremap(denali->dev, mem_base, mem_len);\n\tif (!denali->host) {\n\t\tdev_err(&dev->dev, \"Spectra: ioremap failed!\");\n\t\treturn -ENOMEM;\n\t}\n\n\tret = denali_init(denali);\n\tif (ret)\n\t\treturn ret;\n\n\tnsels = denali->nbanks;\n\n\tdchip = devm_kzalloc(denali->dev, struct_size(dchip, sels, nsels),\n\t\t\t     GFP_KERNEL);\n\tif (!dchip) {\n\t\tret = -ENOMEM;\n\t\tgoto out_remove_denali;\n\t}\n\n\tdchip->chip.base.ecc.user_conf.flags |= NAND_ECC_MAXIMIZE_STRENGTH;\n\n\tdchip->nsels = nsels;\n\n\tfor (i = 0; i < nsels; i++)\n\t\tdchip->sels[i].bank = i;\n\n\tret = denali_chip_init(denali, dchip);\n\tif (ret)\n\t\tgoto out_remove_denali;\n\n\tpci_set_drvdata(dev, denali);\n\n\treturn 0;\n\nout_remove_denali:\n\tdenali_remove(denali);\n\treturn ret;\n}\n\nstatic void denali_pci_remove(struct pci_dev *dev)\n{\n\tstruct denali_controller *denali = pci_get_drvdata(dev);\n\n\tdenali_remove(denali);\n}\n\nstatic struct pci_driver denali_pci_driver = {\n\t.name = DENALI_NAND_NAME,\n\t.id_table = denali_pci_ids,\n\t.probe = denali_pci_probe,\n\t.remove = denali_pci_remove,\n};\nmodule_pci_driver(denali_pci_driver);\n\nMODULE_DESCRIPTION(\"PCI driver for Denali NAND controller\");\nMODULE_AUTHOR(\"Intel Corporation and its suppliers\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}