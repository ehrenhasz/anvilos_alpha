{
  "module_name": "bbt.c",
  "hash_id": "a2ff5640b1a7b1b6985ddcf65e2a8e353c2093433de9c99bb22fedc57019b9d2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/nand/bbt.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt)\t\"nand-bbt: \" fmt\n\n#include <linux/mtd/nand.h>\n#include <linux/slab.h>\n\n \nint nanddev_bbt_init(struct nand_device *nand)\n{\n\tunsigned int bits_per_block = fls(NAND_BBT_BLOCK_NUM_STATUS);\n\tunsigned int nblocks = nanddev_neraseblocks(nand);\n\n\tnand->bbt.cache = bitmap_zalloc(nblocks * bits_per_block, GFP_KERNEL);\n\tif (!nand->bbt.cache)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(nanddev_bbt_init);\n\n \nvoid nanddev_bbt_cleanup(struct nand_device *nand)\n{\n\tbitmap_free(nand->bbt.cache);\n}\nEXPORT_SYMBOL_GPL(nanddev_bbt_cleanup);\n\n \nint nanddev_bbt_update(struct nand_device *nand)\n{\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(nanddev_bbt_update);\n\n \nint nanddev_bbt_get_block_status(const struct nand_device *nand,\n\t\t\t\t unsigned int entry)\n{\n\tunsigned int bits_per_block = fls(NAND_BBT_BLOCK_NUM_STATUS);\n\tunsigned long *pos = nand->bbt.cache +\n\t\t\t     ((entry * bits_per_block) / BITS_PER_LONG);\n\tunsigned int offs = (entry * bits_per_block) % BITS_PER_LONG;\n\tunsigned long status;\n\n\tif (entry >= nanddev_neraseblocks(nand))\n\t\treturn -ERANGE;\n\n\tstatus = pos[0] >> offs;\n\tif (bits_per_block + offs > BITS_PER_LONG)\n\t\tstatus |= pos[1] << (BITS_PER_LONG - offs);\n\n\treturn status & GENMASK(bits_per_block - 1, 0);\n}\nEXPORT_SYMBOL_GPL(nanddev_bbt_get_block_status);\n\n \nint nanddev_bbt_set_block_status(struct nand_device *nand, unsigned int entry,\n\t\t\t\t enum nand_bbt_block_status status)\n{\n\tunsigned int bits_per_block = fls(NAND_BBT_BLOCK_NUM_STATUS);\n\tunsigned long *pos = nand->bbt.cache +\n\t\t\t     ((entry * bits_per_block) / BITS_PER_LONG);\n\tunsigned int offs = (entry * bits_per_block) % BITS_PER_LONG;\n\tunsigned long val = status & GENMASK(bits_per_block - 1, 0);\n\n\tif (entry >= nanddev_neraseblocks(nand))\n\t\treturn -ERANGE;\n\n\tpos[0] &= ~GENMASK(offs + bits_per_block - 1, offs);\n\tpos[0] |= val << offs;\n\n\tif (bits_per_block + offs > BITS_PER_LONG) {\n\t\tunsigned int rbits = bits_per_block + offs - BITS_PER_LONG;\n\n\t\tpos[1] &= ~GENMASK(rbits - 1, 0);\n\t\tpos[1] |= val >> (bits_per_block - rbits);\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(nanddev_bbt_set_block_status);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}