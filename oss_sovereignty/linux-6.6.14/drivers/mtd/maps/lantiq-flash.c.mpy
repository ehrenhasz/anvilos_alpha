{
  "module_name": "lantiq-flash.c",
  "hash_id": "679f62b3d5570e6f5c8fafe5cb6976e09e238329cf81b9628d4c1fa5a64f7373",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/maps/lantiq-flash.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/io.h>\n#include <linux/slab.h>\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/map.h>\n#include <linux/mtd/partitions.h>\n#include <linux/mtd/cfi.h>\n#include <linux/platform_device.h>\n#include <linux/mtd/physmap.h>\n#include <linux/of.h>\n\n#include <lantiq_soc.h>\n\n \n\nenum {\n\tLTQ_NOR_PROBING,\n\tLTQ_NOR_NORMAL\n};\n\nstruct ltq_mtd {\n\tstruct resource *res;\n\tstruct mtd_info *mtd;\n\tstruct map_info *map;\n};\n\nstatic const char ltq_map_name[] = \"ltq_nor\";\n\nstatic map_word\nltq_read16(struct map_info *map, unsigned long adr)\n{\n\tunsigned long flags;\n\tmap_word temp;\n\n\tif (map->map_priv_1 == LTQ_NOR_PROBING)\n\t\tadr ^= 2;\n\tspin_lock_irqsave(&ebu_lock, flags);\n\ttemp.x[0] = *(u16 *)(map->virt + adr);\n\tspin_unlock_irqrestore(&ebu_lock, flags);\n\treturn temp;\n}\n\nstatic void\nltq_write16(struct map_info *map, map_word d, unsigned long adr)\n{\n\tunsigned long flags;\n\n\tif (map->map_priv_1 == LTQ_NOR_PROBING)\n\t\tadr ^= 2;\n\tspin_lock_irqsave(&ebu_lock, flags);\n\t*(u16 *)(map->virt + adr) = d.x[0];\n\tspin_unlock_irqrestore(&ebu_lock, flags);\n}\n\n \nstatic void\nltq_copy_from(struct map_info *map, void *to,\n\tunsigned long from, ssize_t len)\n{\n\tunsigned char *f = (unsigned char *)map->virt + from;\n\tunsigned char *t = (unsigned char *)to;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&ebu_lock, flags);\n\twhile (len--)\n\t\t*t++ = *f++;\n\tspin_unlock_irqrestore(&ebu_lock, flags);\n}\n\nstatic void\nltq_copy_to(struct map_info *map, unsigned long to,\n\tconst void *from, ssize_t len)\n{\n\tunsigned char *f = (unsigned char *)from;\n\tunsigned char *t = (unsigned char *)map->virt + to;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&ebu_lock, flags);\n\twhile (len--)\n\t\t*t++ = *f++;\n\tspin_unlock_irqrestore(&ebu_lock, flags);\n}\n\nstatic int\nltq_mtd_probe(struct platform_device *pdev)\n{\n\tstruct ltq_mtd *ltq_mtd;\n\tstruct cfi_private *cfi;\n\tint err;\n\n\tltq_mtd = devm_kzalloc(&pdev->dev, sizeof(struct ltq_mtd), GFP_KERNEL);\n\tif (!ltq_mtd)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, ltq_mtd);\n\n\tltq_mtd->map->virt = devm_platform_get_and_ioremap_resource(pdev, 0, &ltq_mtd->res);\n\tif (IS_ERR(ltq_mtd->map->virt))\n\t\treturn PTR_ERR(ltq_mtd->map->virt);\n\n\tltq_mtd->map = devm_kzalloc(&pdev->dev, sizeof(struct map_info),\n\t\t\t\t    GFP_KERNEL);\n\tif (!ltq_mtd->map)\n\t\treturn -ENOMEM;\n\n\tltq_mtd->map->phys = ltq_mtd->res->start;\n\tltq_mtd->map->size = resource_size(ltq_mtd->res);\n\n\tltq_mtd->map->name = ltq_map_name;\n\tltq_mtd->map->bankwidth = 2;\n\tltq_mtd->map->read = ltq_read16;\n\tltq_mtd->map->write = ltq_write16;\n\tltq_mtd->map->copy_from = ltq_copy_from;\n\tltq_mtd->map->copy_to = ltq_copy_to;\n\n\tltq_mtd->map->map_priv_1 = LTQ_NOR_PROBING;\n\tltq_mtd->mtd = do_map_probe(\"cfi_probe\", ltq_mtd->map);\n\tltq_mtd->map->map_priv_1 = LTQ_NOR_NORMAL;\n\n\tif (!ltq_mtd->mtd) {\n\t\tdev_err(&pdev->dev, \"probing failed\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\tltq_mtd->mtd->dev.parent = &pdev->dev;\n\tmtd_set_of_node(ltq_mtd->mtd, pdev->dev.of_node);\n\n\tcfi = ltq_mtd->map->fldrv_priv;\n\tcfi->addr_unlock1 ^= 1;\n\tcfi->addr_unlock2 ^= 1;\n\n\terr = mtd_device_register(ltq_mtd->mtd, NULL, 0);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"failed to add partitions\\n\");\n\t\tgoto err_destroy;\n\t}\n\n\treturn 0;\n\nerr_destroy:\n\tmap_destroy(ltq_mtd->mtd);\n\treturn err;\n}\n\nstatic int\nltq_mtd_remove(struct platform_device *pdev)\n{\n\tstruct ltq_mtd *ltq_mtd = platform_get_drvdata(pdev);\n\n\tif (ltq_mtd && ltq_mtd->mtd) {\n\t\tmtd_device_unregister(ltq_mtd->mtd);\n\t\tmap_destroy(ltq_mtd->mtd);\n\t}\n\treturn 0;\n}\n\nstatic const struct of_device_id ltq_mtd_match[] = {\n\t{ .compatible = \"lantiq,nor\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, ltq_mtd_match);\n\nstatic struct platform_driver ltq_mtd_driver = {\n\t.probe = ltq_mtd_probe,\n\t.remove = ltq_mtd_remove,\n\t.driver = {\n\t\t.name = \"ltq-nor\",\n\t\t.of_match_table = ltq_mtd_match,\n\t},\n};\n\nmodule_platform_driver(ltq_mtd_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"John Crispin <john@phrozen.org>\");\nMODULE_DESCRIPTION(\"Lantiq SoC NOR\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}