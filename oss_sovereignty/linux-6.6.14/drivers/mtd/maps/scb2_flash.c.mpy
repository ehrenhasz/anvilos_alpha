{
  "module_name": "scb2_flash.c",
  "hash_id": "0328c4a9a5a4a3b6f16bb5e2d4d2e9a8d2c6712c702cfd941db2f12898ac3d63",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/maps/scb2_flash.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <asm/io.h>\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/map.h>\n#include <linux/mtd/cfi.h>\n#include <linux/pci.h>\n#include <linux/pci_ids.h>\n\n#define MODNAME\t\t\"scb2_flash\"\n#define SCB2_ADDR\t0xfff00000\n#define SCB2_WINDOW\t0x00100000\n\n\nstatic void __iomem *scb2_ioaddr;\nstatic struct mtd_info *scb2_mtd;\nstatic struct map_info scb2_map = {\n\t.name =      \"SCB2 BIOS Flash\",\n\t.size =      0,\n\t.bankwidth =  1,\n};\nstatic int region_fail;\n\nstatic int scb2_fixup_mtd(struct mtd_info *mtd)\n{\n\tint i;\n\tint done = 0;\n\tstruct map_info *map = mtd->priv;\n\tstruct cfi_private *cfi = map->fldrv_priv;\n\n\t \n\tif (cfi->cfiq->InterfaceDesc != CFI_INTERFACE_X16_ASYNC) {\n\t\tprintk(KERN_ERR MODNAME \": unsupported InterfaceDesc: %#x\\n\",\n\t\t    cfi->cfiq->InterfaceDesc);\n\t\treturn -1;\n\t}\n\n\t \n\n\t \n\tmtd->size = map->size;\n\n\t \n\tmtd->erasesize /= 2;\n\tfor (i = 0; i < mtd->numeraseregions; i++) {\n\t\tstruct mtd_erase_region_info *region = &mtd->eraseregions[i];\n\t\tregion->erasesize /= 2;\n\t}\n\n\t \n\tfor (i = 0; !done && i < mtd->numeraseregions; i++) {\n\t\tstruct mtd_erase_region_info *region = &mtd->eraseregions[i];\n\n\t\tif (region->numblocks * region->erasesize > mtd->size) {\n\t\t\tregion->numblocks = ((unsigned long)mtd->size /\n\t\t\t\t\t\tregion->erasesize);\n\t\t\tdone = 1;\n\t\t} else {\n\t\t\tregion->numblocks = 0;\n\t\t}\n\t\tregion->offset = 0;\n\t}\n\n\treturn 0;\n}\n\n \n#define CSB5_FCR\t0x41\n#define CSB5_FCR_DECODE_ALL 0x0e\nstatic int scb2_flash_probe(struct pci_dev *dev,\n\t\t\t    const struct pci_device_id *ent)\n{\n\tu8 reg;\n\n\t \n\tpci_read_config_byte(dev, CSB5_FCR, &reg);\n\tpci_write_config_byte(dev, CSB5_FCR, reg | CSB5_FCR_DECODE_ALL);\n\n\tif (!request_mem_region(SCB2_ADDR, SCB2_WINDOW, scb2_map.name)) {\n\t\t \n\t\tprintk(KERN_WARNING MODNAME\n\t\t    \": warning - can't reserve rom window, continuing\\n\");\n\t\tregion_fail = 1;\n\t}\n\n\t \n\tscb2_ioaddr = ioremap(SCB2_ADDR, SCB2_WINDOW);\n\tif (!scb2_ioaddr) {\n\t\tprintk(KERN_ERR MODNAME \": Failed to ioremap window!\\n\");\n\t\tif (!region_fail)\n\t\t\trelease_mem_region(SCB2_ADDR, SCB2_WINDOW);\n\t\treturn -ENOMEM;\n\t}\n\n\tscb2_map.phys = SCB2_ADDR;\n\tscb2_map.virt = scb2_ioaddr;\n\tscb2_map.size = SCB2_WINDOW;\n\n\tsimple_map_init(&scb2_map);\n\n\t \n\tscb2_mtd = do_map_probe(\"cfi_probe\", &scb2_map);\n\n\tif (!scb2_mtd) {\n\t\tprintk(KERN_ERR MODNAME \": flash probe failed!\\n\");\n\t\tiounmap(scb2_ioaddr);\n\t\tif (!region_fail)\n\t\t\trelease_mem_region(SCB2_ADDR, SCB2_WINDOW);\n\t\treturn -ENODEV;\n\t}\n\n\tscb2_mtd->owner = THIS_MODULE;\n\tif (scb2_fixup_mtd(scb2_mtd) < 0) {\n\t\tmtd_device_unregister(scb2_mtd);\n\t\tmap_destroy(scb2_mtd);\n\t\tiounmap(scb2_ioaddr);\n\t\tif (!region_fail)\n\t\t\trelease_mem_region(SCB2_ADDR, SCB2_WINDOW);\n\t\treturn -ENODEV;\n\t}\n\n\tprintk(KERN_NOTICE MODNAME \": chip size 0x%llx at offset 0x%llx\\n\",\n\t       (unsigned long long)scb2_mtd->size,\n\t       (unsigned long long)(SCB2_WINDOW - scb2_mtd->size));\n\n\tmtd_device_register(scb2_mtd, NULL, 0);\n\n\treturn 0;\n}\n\nstatic void scb2_flash_remove(struct pci_dev *dev)\n{\n\tif (!scb2_mtd)\n\t\treturn;\n\n\t \n\tmtd_lock(scb2_mtd, 0, scb2_mtd->size);\n\n\tmtd_device_unregister(scb2_mtd);\n\tmap_destroy(scb2_mtd);\n\n\tiounmap(scb2_ioaddr);\n\tscb2_ioaddr = NULL;\n\n\tif (!region_fail)\n\t\trelease_mem_region(SCB2_ADDR, SCB2_WINDOW);\n}\n\nstatic struct pci_device_id scb2_flash_pci_ids[] = {\n\t{\n\t  .vendor = PCI_VENDOR_ID_SERVERWORKS,\n\t  .device = PCI_DEVICE_ID_SERVERWORKS_CSB5,\n\t  .subvendor = PCI_ANY_ID,\n\t  .subdevice = PCI_ANY_ID\n\t},\n\t{ 0, }\n};\n\nstatic struct pci_driver scb2_flash_driver = {\n\t.name =     \"Intel SCB2 BIOS Flash\",\n\t.id_table = scb2_flash_pci_ids,\n\t.probe =    scb2_flash_probe,\n\t.remove =   scb2_flash_remove,\n};\n\nmodule_pci_driver(scb2_flash_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Tim Hockin <thockin@sun.com>\");\nMODULE_DESCRIPTION(\"MTD map driver for Intel SCB2 BIOS Flash\");\nMODULE_DEVICE_TABLE(pci, scb2_flash_pci_ids);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}