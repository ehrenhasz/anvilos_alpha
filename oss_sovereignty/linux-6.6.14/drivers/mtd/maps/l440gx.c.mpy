{
  "module_name": "l440gx.c",
  "hash_id": "e362a40ae8735796702f618caf443cb0e7626e008d08eb7a0a76095550b04748",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/maps/l440gx.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <asm/io.h>\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/map.h>\n\n#define PIIXE_IOBASE_RESOURCE\t11\n\n#define WINDOW_ADDR 0xfff00000\n#define WINDOW_SIZE 0x00100000\n#define BUSWIDTH 1\n\nstatic u32 iobase;\n#define IOBASE iobase\n#define TRIBUF_PORT (IOBASE+0x37)\n#define VPP_PORT (IOBASE+0x28)\n\nstatic struct mtd_info *mymtd;\n\n\n \nstatic DEFINE_SPINLOCK(l440gx_vpp_lock);\nstatic int l440gx_vpp_refcnt;\nstatic void l440gx_set_vpp(struct map_info *map, int vpp)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&l440gx_vpp_lock, flags);\n\tif (vpp) {\n\t\tif (++l440gx_vpp_refcnt == 1)    \n\t\t\toutl(inl(VPP_PORT) | 1, VPP_PORT);\n\t} else {\n\t\tif (--l440gx_vpp_refcnt == 0)    \n\t\t\toutl(inl(VPP_PORT) & ~1, VPP_PORT);\n\t}\n\tspin_unlock_irqrestore(&l440gx_vpp_lock, flags);\n}\n\nstatic struct map_info l440gx_map = {\n\t.name = \"L440GX BIOS\",\n\t.size = WINDOW_SIZE,\n\t.bankwidth = BUSWIDTH,\n\t.phys = WINDOW_ADDR,\n#if 0\n\t \n\t.set_vpp = l440gx_set_vpp\n#endif\n};\n\nstatic int __init init_l440gx(void)\n{\n\tstruct pci_dev *dev, *pm_dev;\n\tstruct resource *pm_iobase;\n\t__u16 word;\n\n\tdev = pci_get_device(PCI_VENDOR_ID_INTEL,\n\t\tPCI_DEVICE_ID_INTEL_82371AB_0, NULL);\n\n\tpm_dev = pci_get_device(PCI_VENDOR_ID_INTEL,\n\t\tPCI_DEVICE_ID_INTEL_82371AB_3, NULL);\n\n\tpci_dev_put(dev);\n\n\tif (!dev || !pm_dev) {\n\t\tprintk(KERN_NOTICE \"L440GX flash mapping: failed to find PIIX4 ISA bridge, cannot continue\\n\");\n\t\tpci_dev_put(pm_dev);\n\t\treturn -ENODEV;\n\t}\n\n\tl440gx_map.virt = ioremap(WINDOW_ADDR, WINDOW_SIZE);\n\n\tif (!l440gx_map.virt) {\n\t\tprintk(KERN_WARNING \"Failed to ioremap L440GX flash region\\n\");\n\t\tpci_dev_put(pm_dev);\n\t\treturn -ENOMEM;\n\t}\n\tsimple_map_init(&l440gx_map);\n\tpr_debug(\"window_addr = %p\\n\", l440gx_map.virt);\n\n\t \n\tpm_iobase = &pm_dev->resource[PIIXE_IOBASE_RESOURCE];\n\tif (!(pm_iobase->flags & IORESOURCE_IO)) {\n\t\tpm_iobase->name = \"pm iobase\";\n\t\tpm_iobase->start = 0;\n\t\tpm_iobase->end = 63;\n\t\tpm_iobase->flags = IORESOURCE_IO;\n\n\t\t \n\t\tpci_read_config_dword(pm_dev, 0x40, &iobase);\n\t\tiobase &= ~1;\n\t\tpm_iobase->start += iobase & ~1;\n\t\tpm_iobase->end += iobase & ~1;\n\n\t\tpci_dev_put(pm_dev);\n\n\t\t \n\t\tif (pci_assign_resource(pm_dev, PIIXE_IOBASE_RESOURCE) != 0) {\n\t\t\tpci_dev_put(dev);\n\t\t\tpci_dev_put(pm_dev);\n\t\t\tprintk(KERN_WARNING \"Could not allocate pm iobase resource\\n\");\n\t\t\tiounmap(l440gx_map.virt);\n\t\t\treturn -ENXIO;\n\t\t}\n\t}\n\t \n\tiobase = pm_iobase->start;\n\tpci_write_config_dword(pm_dev, 0x40, iobase | 1);\n\n\n\t \n\tpci_read_config_word(dev, 0x4e, &word);\n\tword |= 0x4;\n        pci_write_config_word(dev, 0x4e, word);\n\n\t \n\tl440gx_set_vpp(&l440gx_map, 1);\n\n\t \n\toutb(inb(TRIBUF_PORT) & ~1, TRIBUF_PORT);\n\n       \tprintk(KERN_NOTICE \"Enabled WE line to L440GX BIOS flash chip.\\n\");\n\n\tmymtd = do_map_probe(\"jedec_probe\", &l440gx_map);\n\tif (!mymtd) {\n\t\tprintk(KERN_NOTICE \"JEDEC probe on BIOS chip failed. Using ROM\\n\");\n\t\tmymtd = do_map_probe(\"map_rom\", &l440gx_map);\n\t}\n\tif (mymtd) {\n\t\tmymtd->owner = THIS_MODULE;\n\n\t\tmtd_device_register(mymtd, NULL, 0);\n\t\treturn 0;\n\t}\n\n\tiounmap(l440gx_map.virt);\n\treturn -ENXIO;\n}\n\nstatic void __exit cleanup_l440gx(void)\n{\n\tmtd_device_unregister(mymtd);\n\tmap_destroy(mymtd);\n\n\tiounmap(l440gx_map.virt);\n}\n\nmodule_init(init_l440gx);\nmodule_exit(cleanup_l440gx);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"David Woodhouse <dwmw2@infradead.org>\");\nMODULE_DESCRIPTION(\"MTD map driver for BIOS chips on Intel L440GX motherboards\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}