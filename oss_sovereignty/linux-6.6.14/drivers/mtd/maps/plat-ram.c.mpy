{
  "module_name": "plat-ram.c",
  "hash_id": "8d8128903a3dc296ee9739f6b50d135922e65864bcf9063762368796949adcdd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/maps/plat-ram.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/ioport.h>\n#include <linux/device.h>\n#include <linux/slab.h>\n#include <linux/platform_device.h>\n\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/map.h>\n#include <linux/mtd/partitions.h>\n#include <linux/mtd/plat-ram.h>\n\n#include <asm/io.h>\n\n \n\nstruct platram_info {\n\tstruct device\t\t*dev;\n\tstruct mtd_info\t\t*mtd;\n\tstruct map_info\t\t map;\n\tstruct platdata_mtd_ram\t*pdata;\n};\n\n \n\nstatic inline struct platram_info *to_platram_info(struct platform_device *dev)\n{\n\treturn platform_get_drvdata(dev);\n}\n\n \n\nstatic inline void platram_setrw(struct platram_info *info, int to)\n{\n\tif (info->pdata == NULL)\n\t\treturn;\n\n\tif (info->pdata->set_rw != NULL)\n\t\t(info->pdata->set_rw)(info->dev, to);\n}\n\n \n\nstatic int platram_remove(struct platform_device *pdev)\n{\n\tstruct platram_info *info = to_platram_info(pdev);\n\n\tdev_dbg(&pdev->dev, \"removing device\\n\");\n\n\tif (info == NULL)\n\t\treturn 0;\n\n\tif (info->mtd) {\n\t\tmtd_device_unregister(info->mtd);\n\t\tmap_destroy(info->mtd);\n\t}\n\n\t \n\n\tplatram_setrw(info, PLATRAM_RO);\n\n\tkfree(info);\n\n\treturn 0;\n}\n\n \n\nstatic int platram_probe(struct platform_device *pdev)\n{\n\tstruct platdata_mtd_ram\t*pdata;\n\tstruct platram_info *info;\n\tstruct resource *res;\n\tint err = 0;\n\n\tdev_dbg(&pdev->dev, \"probe entered\\n\");\n\n\tif (dev_get_platdata(&pdev->dev) == NULL) {\n\t\tdev_err(&pdev->dev, \"no platform data supplied\\n\");\n\t\terr = -ENOENT;\n\t\tgoto exit_error;\n\t}\n\n\tpdata = dev_get_platdata(&pdev->dev);\n\n\tinfo = kzalloc(sizeof(*info), GFP_KERNEL);\n\tif (info == NULL) {\n\t\terr = -ENOMEM;\n\t\tgoto exit_error;\n\t}\n\n\tplatform_set_drvdata(pdev, info);\n\n\tinfo->dev = &pdev->dev;\n\tinfo->pdata = pdata;\n\n\t \n\tinfo->map.virt = devm_platform_get_and_ioremap_resource(pdev, 0, &res);\n\tif (IS_ERR(info->map.virt)) {\n\t\terr = PTR_ERR(info->map.virt);\n\t\tgoto exit_free;\n\t}\n\n\tdev_dbg(&pdev->dev, \"got platform resource %p (0x%llx)\\n\", res,\n\t\t(unsigned long long)res->start);\n\n\t \n\n\tinfo->map.phys = res->start;\n\tinfo->map.size = resource_size(res);\n\tinfo->map.name = pdata->mapname != NULL ?\n\t\t\t(char *)pdata->mapname : (char *)pdev->name;\n\tinfo->map.bankwidth = pdata->bankwidth;\n\n\tdev_dbg(&pdev->dev, \"virt %p, %lu bytes\\n\", info->map.virt, info->map.size);\n\n\tsimple_map_init(&info->map);\n\n\tdev_dbg(&pdev->dev, \"initialised map, probing for mtd\\n\");\n\n\t \n\n\tif (pdata->map_probes) {\n\t\tconst char * const *map_probes = pdata->map_probes;\n\n\t\tfor ( ; !info->mtd && *map_probes; map_probes++)\n\t\t\tinfo->mtd = do_map_probe(*map_probes , &info->map);\n\t}\n\t \n\telse\n\t\tinfo->mtd = do_map_probe(\"map_ram\", &info->map);\n\n\tif (info->mtd == NULL) {\n\t\tdev_err(&pdev->dev, \"failed to probe for map_ram\\n\");\n\t\terr = -ENOMEM;\n\t\tgoto exit_free;\n\t}\n\n\tinfo->mtd->dev.parent = &pdev->dev;\n\n\tplatram_setrw(info, PLATRAM_RW);\n\n\t \n\n\terr = mtd_device_parse_register(info->mtd, pdata->probes, NULL,\n\t\t\t\t\tpdata->partitions,\n\t\t\t\t\tpdata->nr_partitions);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"failed to register mtd device\\n\");\n\t\tgoto exit_free;\n\t}\n\n\tdev_info(&pdev->dev, \"registered mtd device\\n\");\n\n\tif (pdata->nr_partitions) {\n\t\t \n\t\terr = mtd_device_register(info->mtd, NULL, 0);\n\t\tif (err) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"failed to register the entire device\\n\");\n\t\t\tgoto exit_free;\n\t\t}\n\t}\n\n\treturn 0;\n\n exit_free:\n\tplatram_remove(pdev);\n exit_error:\n\treturn err;\n}\n\n \n\n \nMODULE_ALIAS(\"platform:mtd-ram\");\n\nstatic struct platform_driver platram_driver = {\n\t.probe\t\t= platram_probe,\n\t.remove\t\t= platram_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"mtd-ram\",\n\t},\n};\n\nmodule_platform_driver(platram_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Ben Dooks <ben@simtec.co.uk>\");\nMODULE_DESCRIPTION(\"MTD platform RAM map driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}