{
  "module_name": "tsunami_flash.c",
  "hash_id": "4f2d946806497706ab1c0e3db38d87a1506eadff80a82ed41652f44e601f8d18",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/maps/tsunami_flash.c",
  "human_readable_source": "\n \n#include <asm/io.h>\n#include <asm/core_tsunami.h>\n#include <linux/init.h>\n#include <linux/mtd/map.h>\n#include <linux/mtd/mtd.h>\n\n#define FLASH_ENABLE_PORT 0x00C00001\n#define FLASH_ENABLE_BYTE 0x01\n#define FLASH_DISABLE_BYTE 0x00\n\n#define MAX_TIG_FLASH_SIZE (12*1024*1024)\nstatic inline map_word tsunami_flash_read8(struct map_info *map, unsigned long offset)\n{\n\tmap_word val;\n\tval.x[0] = tsunami_tig_readb(offset);\n\treturn val;\n}\n\nstatic void tsunami_flash_write8(struct map_info *map, map_word value, unsigned long offset)\n{\n\ttsunami_tig_writeb(value.x[0], offset);\n}\n\nstatic void tsunami_flash_copy_from(\n\tstruct map_info *map, void *addr, unsigned long offset, ssize_t len)\n{\n\tunsigned char *dest;\n\tdest = addr;\n\twhile(len && (offset < MAX_TIG_FLASH_SIZE)) {\n\t\t*dest = tsunami_tig_readb(offset);\n\t\toffset++;\n\t\tdest++;\n\t\tlen--;\n\t}\n}\n\nstatic void tsunami_flash_copy_to(\n\tstruct map_info *map, unsigned long offset,\n\tconst void *addr, ssize_t len)\n{\n\tconst unsigned char *src;\n\tsrc = addr;\n\twhile(len && (offset < MAX_TIG_FLASH_SIZE)) {\n\t\ttsunami_tig_writeb(*src, offset);\n\t\toffset++;\n\t\tsrc++;\n\t\tlen--;\n\t}\n}\n\n \nstatic struct map_info tsunami_flash_map = {\n\t.name = \"flash chip on the Tsunami TIG bus\",\n\t.size = MAX_TIG_FLASH_SIZE,\n\t.phys = NO_XIP,\n\t.bankwidth = 1,\n\t.read = tsunami_flash_read8,\n\t.copy_from = tsunami_flash_copy_from,\n\t.write = tsunami_flash_write8,\n\t.copy_to = tsunami_flash_copy_to,\n};\n\nstatic struct mtd_info *tsunami_flash_mtd;\n\nstatic void __exit  cleanup_tsunami_flash(void)\n{\n\tstruct mtd_info *mtd;\n\tmtd = tsunami_flash_mtd;\n\tif (mtd) {\n\t\tmtd_device_unregister(mtd);\n\t\tmap_destroy(mtd);\n\t}\n\ttsunami_flash_mtd = 0;\n}\n\nstatic const char * const rom_probe_types[] = {\n\t\"cfi_probe\", \"jedec_probe\", \"map_rom\", NULL };\n\nstatic int __init init_tsunami_flash(void)\n{\n\tconst char * const *type;\n\n\ttsunami_tig_writeb(FLASH_ENABLE_BYTE, FLASH_ENABLE_PORT);\n\n\ttsunami_flash_mtd = 0;\n\ttype = rom_probe_types;\n\tfor(; !tsunami_flash_mtd && *type; type++) {\n\t\ttsunami_flash_mtd = do_map_probe(*type, &tsunami_flash_map);\n\t}\n\tif (tsunami_flash_mtd) {\n\t\ttsunami_flash_mtd->owner = THIS_MODULE;\n\t\tmtd_device_register(tsunami_flash_mtd, NULL, 0);\n\t\treturn 0;\n\t}\n\treturn -ENXIO;\n}\n\nmodule_init(init_tsunami_flash);\nmodule_exit(cleanup_tsunami_flash);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}