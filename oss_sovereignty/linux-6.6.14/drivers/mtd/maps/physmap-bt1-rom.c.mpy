{
  "module_name": "physmap-bt1-rom.c",
  "hash_id": "eb2f7b5868ce5e4b3fe15845d5b1b6a379d40ae98e112e081b88c2568580a534",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/maps/physmap-bt1-rom.c",
  "human_readable_source": "\n \n#include <linux/bits.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/mtd/map.h>\n#include <linux/mtd/xip.h>\n#include <linux/mux/consumer.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/string.h>\n#include <linux/types.h>\n\n#include \"physmap-bt1-rom.h\"\n\n \nstatic map_word __xipram bt1_rom_map_read(struct map_info *map,\n\t\t\t\t\t  unsigned long ofs)\n{\n\tvoid __iomem *src = map->virt + ofs;\n\tunsigned int shift;\n\tmap_word ret;\n\tu32 data;\n\n\t \n\tshift = (uintptr_t)src & 0x3;\n\tdata = readl_relaxed(src - shift);\n\tif (!shift) {\n\t\tret.x[0] = data;\n\t\treturn ret;\n\t}\n\tret.x[0] = data >> (shift * BITS_PER_BYTE);\n\n\t \n\tshift = 4 - shift;\n\tif (ofs + shift >= map->size)\n\t\treturn ret;\n\n\tdata = readl_relaxed(src + shift);\n\tret.x[0] |= data << (shift * BITS_PER_BYTE);\n\n\treturn ret;\n}\n\nstatic void __xipram bt1_rom_map_copy_from(struct map_info *map,\n\t\t\t\t\t   void *to, unsigned long from,\n\t\t\t\t\t   ssize_t len)\n{\n\tvoid __iomem *src = map->virt + from;\n\tunsigned int shift, chunk;\n\tu32 data;\n\n\tif (len <= 0 || from >= map->size)\n\t\treturn;\n\n\t \n\tlen = min_t(ssize_t, map->size - from, len);\n\n\t \n\tshift = (uintptr_t)src & 0x3;\n\tif (shift) {\n\t\tchunk = min_t(ssize_t, 4 - shift, len);\n\t\tdata = readl_relaxed(src - shift);\n\t\tmemcpy(to, (char *)&data + shift, chunk);\n\t\tsrc += chunk;\n\t\tto += chunk;\n\t\tlen -= chunk;\n\t}\n\n\twhile (len >= 4) {\n\t\tdata = readl_relaxed(src);\n\t\tmemcpy(to, &data, 4);\n\t\tsrc += 4;\n\t\tto += 4;\n\t\tlen -= 4;\n\t}\n\n\tif (len) {\n\t\tdata = readl_relaxed(src);\n\t\tmemcpy(to, &data, len);\n\t}\n}\n\nint of_flash_probe_bt1_rom(struct platform_device *pdev,\n\t\t\t   struct device_node *np,\n\t\t\t   struct map_info *map)\n{\n\tstruct device *dev = &pdev->dev;\n\n\t \n\tif (!of_device_is_compatible(np, \"mtd-rom\")) {\n\t\tdev_info(dev, \"No mtd-rom compatible string\\n\");\n\t\treturn 0;\n\t}\n\n\t \n\tif (!of_device_is_compatible(np, \"baikal,bt1-int-rom\"))\n\t\treturn 0;\n\n\t \n\tif (map->bankwidth != 4)\n\t\tdev_warn(dev, \"Bank width is supposed to be 32 bits wide\\n\");\n\n\tmap->read = bt1_rom_map_read;\n\tmap->copy_from = bt1_rom_map_copy_from;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}