{
  "module_name": "pxa2xx-flash.c",
  "hash_id": "eb9d0270be1a9514378b92452a2d5b9da2d9a9c54f10a3b5ed2f6bdcdad807dd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/maps/pxa2xx-flash.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/slab.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/map.h>\n#include <linux/mtd/partitions.h>\n\n#include <asm/io.h>\n#include <asm/mach/flash.h>\n\n#define CACHELINESIZE\t32\n\nstatic void pxa2xx_map_inval_cache(struct map_info *map, unsigned long from,\n\t\t\t\t      ssize_t len)\n{\n\tunsigned long start = (unsigned long)map->cached + from;\n\tunsigned long end = start + len;\n\n\tstart &= ~(CACHELINESIZE - 1);\n\twhile (start < end) {\n\t\t \n\t\tasm volatile (\"mcr p15, 0, %0, c7, c6, 1\" : : \"r\" (start));\n\t\tstart += CACHELINESIZE;\n\t}\n}\n\nstruct pxa2xx_flash_info {\n\tstruct mtd_info\t\t*mtd;\n\tstruct map_info\t\tmap;\n};\n\nstatic const char * const probes[] = { \"RedBoot\", \"cmdlinepart\", NULL };\n\nstatic int pxa2xx_flash_probe(struct platform_device *pdev)\n{\n\tstruct flash_platform_data *flash = dev_get_platdata(&pdev->dev);\n\tstruct pxa2xx_flash_info *info;\n\tstruct resource *res;\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!res)\n\t\treturn -ENODEV;\n\n\tinfo = kzalloc(sizeof(struct pxa2xx_flash_info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->map.name = flash->name;\n\tinfo->map.bankwidth = flash->width;\n\tinfo->map.phys = res->start;\n\tinfo->map.size = resource_size(res);\n\n\tinfo->map.virt = ioremap(info->map.phys, info->map.size);\n\tif (!info->map.virt) {\n\t\tprintk(KERN_WARNING \"Failed to ioremap %s\\n\",\n\t\t       info->map.name);\n\t\tkfree(info);\n\t\treturn -ENOMEM;\n\t}\n\tinfo->map.cached = ioremap_cache(info->map.phys, info->map.size);\n\tif (!info->map.cached)\n\t\tprintk(KERN_WARNING \"Failed to ioremap cached %s\\n\",\n\t\t       info->map.name);\n\tinfo->map.inval_cache = pxa2xx_map_inval_cache;\n\tsimple_map_init(&info->map);\n\n\tprintk(KERN_NOTICE\n\t       \"Probing %s at physical address 0x%08lx\"\n\t       \" (%d-bit bankwidth)\\n\",\n\t       info->map.name, (unsigned long)info->map.phys,\n\t       info->map.bankwidth * 8);\n\n\tinfo->mtd = do_map_probe(flash->map_name, &info->map);\n\n\tif (!info->mtd) {\n\t\tiounmap((void *)info->map.virt);\n\t\tif (info->map.cached)\n\t\t\tiounmap(info->map.cached);\n\t\tkfree(info);\n\t\treturn -EIO;\n\t}\n\tinfo->mtd->dev.parent = &pdev->dev;\n\n\tmtd_device_parse_register(info->mtd, probes, NULL, flash->parts,\n\t\t\t\t  flash->nr_parts);\n\n\tplatform_set_drvdata(pdev, info);\n\treturn 0;\n}\n\nstatic int pxa2xx_flash_remove(struct platform_device *dev)\n{\n\tstruct pxa2xx_flash_info *info = platform_get_drvdata(dev);\n\n\tmtd_device_unregister(info->mtd);\n\n\tmap_destroy(info->mtd);\n\tiounmap(info->map.virt);\n\tif (info->map.cached)\n\t\tiounmap(info->map.cached);\n\tkfree(info);\n\treturn 0;\n}\n\n#ifdef CONFIG_PM\nstatic void pxa2xx_flash_shutdown(struct platform_device *dev)\n{\n\tstruct pxa2xx_flash_info *info = platform_get_drvdata(dev);\n\n\tif (info && mtd_suspend(info->mtd) == 0)\n\t\tmtd_resume(info->mtd);\n}\n#else\n#define pxa2xx_flash_shutdown NULL\n#endif\n\nstatic struct platform_driver pxa2xx_flash_driver = {\n\t.driver = {\n\t\t.name\t\t= \"pxa2xx-flash\",\n\t},\n\t.probe\t\t= pxa2xx_flash_probe,\n\t.remove\t\t= pxa2xx_flash_remove,\n\t.shutdown\t= pxa2xx_flash_shutdown,\n};\n\nmodule_platform_driver(pxa2xx_flash_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Nicolas Pitre <nico@fluxnic.net>\");\nMODULE_DESCRIPTION(\"MTD map driver for Intel XScale PXA2xx\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}