{
  "module_name": "hyperbus-core.c",
  "hash_id": "795900ac5f9d3e1e4b0e3a2242cb734076ef62b5986602e4deb8729e261b6acf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/hyperbus/hyperbus-core.c",
  "human_readable_source": "\n\n\n\n\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mtd/hyperbus.h>\n#include <linux/mtd/map.h>\n#include <linux/mtd/mtd.h>\n#include <linux/of.h>\n#include <linux/types.h>\n\nstatic struct hyperbus_device *map_to_hbdev(struct map_info *map)\n{\n\treturn container_of(map, struct hyperbus_device, map);\n}\n\nstatic map_word hyperbus_read16(struct map_info *map, unsigned long addr)\n{\n\tstruct hyperbus_device *hbdev = map_to_hbdev(map);\n\tstruct hyperbus_ctlr *ctlr = hbdev->ctlr;\n\tmap_word read_data;\n\n\tread_data.x[0] = ctlr->ops->read16(hbdev, addr);\n\n\treturn read_data;\n}\n\nstatic void hyperbus_write16(struct map_info *map, map_word d,\n\t\t\t     unsigned long addr)\n{\n\tstruct hyperbus_device *hbdev = map_to_hbdev(map);\n\tstruct hyperbus_ctlr *ctlr = hbdev->ctlr;\n\n\tctlr->ops->write16(hbdev, addr, d.x[0]);\n}\n\nstatic void hyperbus_copy_from(struct map_info *map, void *to,\n\t\t\t       unsigned long from, ssize_t len)\n{\n\tstruct hyperbus_device *hbdev = map_to_hbdev(map);\n\tstruct hyperbus_ctlr *ctlr = hbdev->ctlr;\n\n\tctlr->ops->copy_from(hbdev, to, from, len);\n}\n\nstatic void hyperbus_copy_to(struct map_info *map, unsigned long to,\n\t\t\t     const void *from, ssize_t len)\n{\n\tstruct hyperbus_device *hbdev = map_to_hbdev(map);\n\tstruct hyperbus_ctlr *ctlr = hbdev->ctlr;\n\n\tctlr->ops->copy_to(hbdev, to, from, len);\n}\n\nint hyperbus_register_device(struct hyperbus_device *hbdev)\n{\n\tconst struct hyperbus_ops *ops;\n\tstruct hyperbus_ctlr *ctlr;\n\tstruct device_node *np;\n\tstruct map_info *map;\n\tstruct device *dev;\n\tint ret;\n\n\tif (!hbdev || !hbdev->np || !hbdev->ctlr || !hbdev->ctlr->dev) {\n\t\tpr_err(\"hyperbus: please fill all the necessary fields!\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tnp = hbdev->np;\n\tctlr = hbdev->ctlr;\n\tif (!of_device_is_compatible(np, \"cypress,hyperflash\")) {\n\t\tdev_err(ctlr->dev, \"\\\"cypress,hyperflash\\\" compatible missing\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\thbdev->memtype = HYPERFLASH;\n\n\tdev = ctlr->dev;\n\tmap = &hbdev->map;\n\tmap->name = dev_name(dev);\n\tmap->bankwidth = 2;\n\tmap->device_node = np;\n\n\tsimple_map_init(map);\n\tops = ctlr->ops;\n\tif (ops) {\n\t\tif (ops->read16)\n\t\t\tmap->read = hyperbus_read16;\n\t\tif (ops->write16)\n\t\t\tmap->write = hyperbus_write16;\n\t\tif (ops->copy_to)\n\t\t\tmap->copy_to = hyperbus_copy_to;\n\t\tif (ops->copy_from)\n\t\t\tmap->copy_from = hyperbus_copy_from;\n\n\t\tif (ops->calibrate && !ctlr->calibrated) {\n\t\t\tret = ops->calibrate(hbdev);\n\t\t\tif (!ret) {\n\t\t\t\tdev_err(dev, \"Calibration failed\\n\");\n\t\t\t\treturn -ENODEV;\n\t\t\t}\n\t\t\tctlr->calibrated = true;\n\t\t}\n\t}\n\n\thbdev->mtd = do_map_probe(\"cfi_probe\", map);\n\tif (!hbdev->mtd) {\n\t\tdev_err(dev, \"probing of hyperbus device failed\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\thbdev->mtd->dev.parent = dev;\n\tmtd_set_of_node(hbdev->mtd, np);\n\n\tret = mtd_device_register(hbdev->mtd, NULL, 0);\n\tif (ret) {\n\t\tdev_err(dev, \"failed to register mtd device\\n\");\n\t\tmap_destroy(hbdev->mtd);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hyperbus_register_device);\n\nvoid hyperbus_unregister_device(struct hyperbus_device *hbdev)\n{\n\tif (hbdev && hbdev->mtd) {\n\t\tWARN_ON(mtd_device_unregister(hbdev->mtd));\n\t\tmap_destroy(hbdev->mtd);\n\t}\n}\nEXPORT_SYMBOL_GPL(hyperbus_unregister_device);\n\nMODULE_DESCRIPTION(\"HyperBus Framework\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Vignesh Raghavendra <vigneshr@ti.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}