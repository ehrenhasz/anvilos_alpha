{
  "module_name": "mtdsuper.c",
  "hash_id": "413cddfd6a0869b2c3c4b0d7d9f69a2415e6a3858de81d6f83994543475a8375",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/mtdsuper.c",
  "human_readable_source": "\n \n\n#include <linux/mtd/super.h>\n#include <linux/namei.h>\n#include <linux/export.h>\n#include <linux/ctype.h>\n#include <linux/slab.h>\n#include <linux/major.h>\n#include <linux/backing-dev.h>\n#include <linux/blkdev.h>\n#include <linux/fs_context.h>\n#include \"mtdcore.h\"\n\n \nstatic int mtd_get_sb(struct fs_context *fc,\n\t\t      struct mtd_info *mtd,\n\t\t      int (*fill_super)(struct super_block *,\n\t\t\t\t\tstruct fs_context *))\n{\n\tstruct super_block *sb;\n\tint ret;\n\n\tsb = sget_dev(fc, MKDEV(MTD_BLOCK_MAJOR, mtd->index));\n\tif (IS_ERR(sb))\n\t\treturn PTR_ERR(sb);\n\n\tif (sb->s_root) {\n\t\t \n\t\tpr_debug(\"MTDSB: Device %d (\\\"%s\\\") is already mounted\\n\",\n\t\t\t mtd->index, mtd->name);\n\t\tput_mtd_device(mtd);\n\t} else {\n\t\t \n\t\tpr_debug(\"MTDSB: New superblock for device %d (\\\"%s\\\")\\n\",\n\t\t\t mtd->index, mtd->name);\n\n\t\t \n\t\tsb->s_mtd = mtd;\n\t\tsb->s_bdi = bdi_get(mtd_bdi);\n\n\t\tret = fill_super(sb, fc);\n\t\tif (ret < 0)\n\t\t\tgoto error_sb;\n\n\t\tsb->s_flags |= SB_ACTIVE;\n\t}\n\n\tBUG_ON(fc->root);\n\tfc->root = dget(sb->s_root);\n\treturn 0;\n\nerror_sb:\n\tdeactivate_locked_super(sb);\n\treturn ret;\n}\n\n \nstatic int mtd_get_sb_by_nr(struct fs_context *fc, int mtdnr,\n\t\t\t    int (*fill_super)(struct super_block *,\n\t\t\t\t\t      struct fs_context *))\n{\n\tstruct mtd_info *mtd;\n\n\tmtd = get_mtd_device(NULL, mtdnr);\n\tif (IS_ERR(mtd)) {\n\t\terrorf(fc, \"MTDSB: Device #%u doesn't appear to exist\\n\", mtdnr);\n\t\treturn PTR_ERR(mtd);\n\t}\n\n\treturn mtd_get_sb(fc, mtd, fill_super);\n}\n\n \nint get_tree_mtd(struct fs_context *fc,\n\t      int (*fill_super)(struct super_block *sb,\n\t\t\t\tstruct fs_context *fc))\n{\n#ifdef CONFIG_BLOCK\n\tdev_t dev;\n\tint ret;\n#endif\n\tint mtdnr;\n\n\tif (!fc->source)\n\t\treturn invalf(fc, \"No source specified\");\n\n\tpr_debug(\"MTDSB: dev_name \\\"%s\\\"\\n\", fc->source);\n\n\t \n\tif (fc->source[0] == 'm' &&\n\t    fc->source[1] == 't' &&\n\t    fc->source[2] == 'd') {\n\t\tif (fc->source[3] == ':') {\n\t\t\tstruct mtd_info *mtd;\n\n\t\t\t \n\t\t\tpr_debug(\"MTDSB: mtd:%%s, name \\\"%s\\\"\\n\",\n\t\t\t\t fc->source + 4);\n\n\t\t\tmtd = get_mtd_device_nm(fc->source + 4);\n\t\t\tif (!IS_ERR(mtd))\n\t\t\t\treturn mtd_get_sb(fc, mtd, fill_super);\n\n\t\t\terrorf(fc, \"MTD: MTD device with name \\\"%s\\\" not found\",\n\t\t\t       fc->source + 4);\n\n\t\t} else if (isdigit(fc->source[3])) {\n\t\t\t \n\t\t\tchar *endptr;\n\n\t\t\tmtdnr = simple_strtoul(fc->source + 3, &endptr, 0);\n\t\t\tif (!*endptr) {\n\t\t\t\t \n\t\t\t\tpr_debug(\"MTDSB: mtd%%d, mtdnr %d\\n\", mtdnr);\n\t\t\t\treturn mtd_get_sb_by_nr(fc, mtdnr, fill_super);\n\t\t\t}\n\t\t}\n\t}\n\n#ifdef CONFIG_BLOCK\n\t \n\tret = lookup_bdev(fc->source, &dev);\n\tif (ret) {\n\t\terrorf(fc, \"MTD: Couldn't look up '%s': %d\", fc->source, ret);\n\t\treturn ret;\n\t}\n\tpr_debug(\"MTDSB: lookup_bdev() returned 0\\n\");\n\n\tif (MAJOR(dev) == MTD_BLOCK_MAJOR)\n\t\treturn mtd_get_sb_by_nr(fc, MINOR(dev), fill_super);\n\n#endif  \n\n\tif (!(fc->sb_flags & SB_SILENT))\n\t\terrorf(fc, \"MTD: Attempt to mount non-MTD device \\\"%s\\\"\",\n\t\t       fc->source);\n\treturn -EINVAL;\n}\nEXPORT_SYMBOL_GPL(get_tree_mtd);\n\n \nvoid kill_mtd_super(struct super_block *sb)\n{\n\tgeneric_shutdown_super(sb);\n\tput_mtd_device(sb->s_mtd);\n\tsb->s_mtd = NULL;\n}\n\nEXPORT_SYMBOL_GPL(kill_mtd_super);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}