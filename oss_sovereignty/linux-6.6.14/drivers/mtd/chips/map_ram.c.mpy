{
  "module_name": "map_ram.c",
  "hash_id": "c0ca752ffbf7885774624f01dae4a3e2ba053e82828375de346306251cc38f16",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/chips/map_ram.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <asm/io.h>\n#include <asm/byteorder.h>\n#include <linux/errno.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/map.h>\n\n\nstatic int mapram_read (struct mtd_info *, loff_t, size_t, size_t *, u_char *);\nstatic int mapram_write (struct mtd_info *, loff_t, size_t, size_t *, const u_char *);\nstatic int mapram_erase (struct mtd_info *, struct erase_info *);\nstatic void mapram_nop (struct mtd_info *);\nstatic struct mtd_info *map_ram_probe(struct map_info *map);\nstatic int mapram_point (struct mtd_info *mtd, loff_t from, size_t len,\n\t\t\t size_t *retlen, void **virt, resource_size_t *phys);\nstatic int mapram_unpoint(struct mtd_info *mtd, loff_t from, size_t len);\n\n\nstatic struct mtd_chip_driver mapram_chipdrv = {\n\t.probe\t= map_ram_probe,\n\t.name\t= \"map_ram\",\n\t.module\t= THIS_MODULE\n};\n\nstatic struct mtd_info *map_ram_probe(struct map_info *map)\n{\n\tstruct mtd_info *mtd;\n\n\t \n#if 0\n\tmap_write8(map, 0x55, 0);\n\tif (map_read8(map, 0) != 0x55)\n\t\treturn NULL;\n\n\tmap_write8(map, 0xAA, 0);\n\tif (map_read8(map, 0) != 0xAA)\n\t\treturn NULL;\n\n\t \n\tmap_write8(map, 0x55, map->size-1);\n\tif (map_read8(map, map->size-1) != 0x55)\n\t\treturn NULL;\n\n\tmap_write8(map, 0xAA, map->size-1);\n\tif (map_read8(map, map->size-1) != 0xAA)\n\t\treturn NULL;\n#endif\n\t \n\n\tmtd = kzalloc(sizeof(*mtd), GFP_KERNEL);\n\tif (!mtd)\n\t\treturn NULL;\n\n\tmap->fldrv = &mapram_chipdrv;\n\tmtd->priv = map;\n\tmtd->name = map->name;\n\tmtd->type = MTD_RAM;\n\tmtd->size = map->size;\n\tmtd->_erase = mapram_erase;\n\tmtd->_read = mapram_read;\n\tmtd->_write = mapram_write;\n\tmtd->_panic_write = mapram_write;\n\tmtd->_point = mapram_point;\n\tmtd->_sync = mapram_nop;\n\tmtd->_unpoint = mapram_unpoint;\n\tmtd->flags = MTD_CAP_RAM;\n\tmtd->writesize = 1;\n\n\tmtd->erasesize = PAGE_SIZE;\n \twhile(mtd->size & (mtd->erasesize - 1))\n\t\tmtd->erasesize >>= 1;\n\n\t__module_get(THIS_MODULE);\n\treturn mtd;\n}\n\nstatic int mapram_point(struct mtd_info *mtd, loff_t from, size_t len,\n\t\t\tsize_t *retlen, void **virt, resource_size_t *phys)\n{\n\tstruct map_info *map = mtd->priv;\n\n\tif (!map->virt)\n\t\treturn -EINVAL;\n\t*virt = map->virt + from;\n\tif (phys)\n\t\t*phys = map->phys + from;\n\t*retlen = len;\n\treturn 0;\n}\n\nstatic int mapram_unpoint(struct mtd_info *mtd, loff_t from, size_t len)\n{\n\treturn 0;\n}\n\nstatic int mapram_read (struct mtd_info *mtd, loff_t from, size_t len, size_t *retlen, u_char *buf)\n{\n\tstruct map_info *map = mtd->priv;\n\n\tmap_copy_from(map, buf, from, len);\n\t*retlen = len;\n\treturn 0;\n}\n\nstatic int mapram_write (struct mtd_info *mtd, loff_t to, size_t len, size_t *retlen, const u_char *buf)\n{\n\tstruct map_info *map = mtd->priv;\n\n\tmap_copy_to(map, to, buf, len);\n\t*retlen = len;\n\treturn 0;\n}\n\nstatic int mapram_erase (struct mtd_info *mtd, struct erase_info *instr)\n{\n\t \n\tstruct map_info *map = mtd->priv;\n\tmap_word allff;\n\tunsigned long i;\n\n\tallff = map_word_ff(map);\n\tfor (i=0; i<instr->len; i += map_bankwidth(map))\n\t\tmap_write(map, allff, instr->addr + i);\n\treturn 0;\n}\n\nstatic void mapram_nop(struct mtd_info *mtd)\n{\n\t \n}\n\nstatic int __init map_ram_init(void)\n{\n\tregister_mtd_chip_driver(&mapram_chipdrv);\n\treturn 0;\n}\n\nstatic void __exit map_ram_exit(void)\n{\n\tunregister_mtd_chip_driver(&mapram_chipdrv);\n}\n\nmodule_init(map_ram_init);\nmodule_exit(map_ram_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"David Woodhouse <dwmw2@infradead.org>\");\nMODULE_DESCRIPTION(\"MTD chip driver for RAM chips\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}