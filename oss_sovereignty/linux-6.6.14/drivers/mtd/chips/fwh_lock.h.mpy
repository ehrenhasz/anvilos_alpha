{
  "module_name": "fwh_lock.h",
  "hash_id": "d2372abaf348b433bea7ea38f61aceadedd1de0526b2e4ba264e9b664a785b65",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/chips/fwh_lock.h",
  "human_readable_source": " \n#ifndef FWH_LOCK_H\n#define FWH_LOCK_H\n\n\nenum fwh_lock_state {\n        FWH_UNLOCKED   = 0,\n\tFWH_DENY_WRITE = 1,\n\tFWH_IMMUTABLE  = 2,\n\tFWH_DENY_READ  = 4,\n};\n\nstruct fwh_xxlock_thunk {\n\tenum fwh_lock_state val;\n\tflstate_t state;\n};\n\n\n#define FWH_XXLOCK_ONEBLOCK_LOCK   ((struct fwh_xxlock_thunk){ FWH_DENY_WRITE, FL_LOCKING})\n#define FWH_XXLOCK_ONEBLOCK_UNLOCK ((struct fwh_xxlock_thunk){ FWH_UNLOCKED,   FL_UNLOCKING})\n\n \nstatic int fwh_xxlock_oneblock(struct map_info *map, struct flchip *chip,\n\tunsigned long adr, int len, void *thunk)\n{\n\tstruct cfi_private *cfi = map->fldrv_priv;\n\tstruct fwh_xxlock_thunk *xxlt = (struct fwh_xxlock_thunk *)thunk;\n\tint ret;\n\n\t \n\tif (chip->start < 0x400000) {\n\t\tpr_debug( \"MTD %s(): chip->start: %lx wanted >= 0x400000\\n\",\n\t\t\t__func__, chip->start );\n\t\treturn -EIO;\n\t}\n\t \n\tadr = (adr & ~0xffffUL) | 0x2;\n\tadr += chip->start - 0x400000;\n\n\t \n\tmutex_lock(&chip->mutex);\n\tret = get_chip(map, chip, adr, FL_LOCKING);\n\tif (ret) {\n\t\tmutex_unlock(&chip->mutex);\n\t\treturn ret;\n\t}\n\n\tchip->oldstate = chip->state;\n\tchip->state = xxlt->state;\n\tmap_write(map, CMD(xxlt->val), adr);\n\n\t \n\tchip->state = chip->oldstate;\n\tput_chip(map, chip, adr);\n\tmutex_unlock(&chip->mutex);\n\treturn 0;\n}\n\n\nstatic int fwh_lock_varsize(struct mtd_info *mtd, loff_t ofs, uint64_t len)\n{\n\tint ret;\n\n\tret = cfi_varsize_frob(mtd, fwh_xxlock_oneblock, ofs, len,\n\t\t(void *)&FWH_XXLOCK_ONEBLOCK_LOCK);\n\n\treturn ret;\n}\n\n\nstatic int fwh_unlock_varsize(struct mtd_info *mtd, loff_t ofs, uint64_t len)\n{\n\tint ret;\n\n\tret = cfi_varsize_frob(mtd, fwh_xxlock_oneblock, ofs, len,\n\t\t(void *)&FWH_XXLOCK_ONEBLOCK_UNLOCK);\n\n\treturn ret;\n}\n\nstatic void fixup_use_fwh_lock(struct mtd_info *mtd)\n{\n\tprintk(KERN_NOTICE \"using fwh lock/unlock method\\n\");\n\t \n\tmtd->_lock   = fwh_lock_varsize;\n\tmtd->_unlock = fwh_unlock_varsize;\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}