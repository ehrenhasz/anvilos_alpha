{
  "module_name": "ar7part.c",
  "hash_id": "af094e58e9a4920e4a59d6e20ecff5719a2098ce05b3e3d06a1fc88b897bda24",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/parsers/ar7part.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/partitions.h>\n#include <linux/memblock.h>\n#include <linux/module.h>\n\n#include <uapi/linux/magic.h>\n\n#define AR7_PARTS\t4\n#define ROOT_OFFSET\t0xe0000\n\n#define LOADER_MAGIC1\tle32_to_cpu(0xfeedfa42)\n#define LOADER_MAGIC2\tle32_to_cpu(0xfeed1281)\n\nstruct ar7_bin_rec {\n\tunsigned int checksum;\n\tunsigned int length;\n\tunsigned int address;\n};\n\nstatic int create_mtd_partitions(struct mtd_info *master,\n\t\t\t\t const struct mtd_partition **pparts,\n\t\t\t\t struct mtd_part_parser_data *data)\n{\n\tstruct ar7_bin_rec header;\n\tunsigned int offset;\n\tsize_t len;\n\tunsigned int pre_size = master->erasesize, post_size = 0;\n\tunsigned int root_offset = ROOT_OFFSET;\n\n\tint retries = 10;\n\tstruct mtd_partition *ar7_parts;\n\n\tar7_parts = kcalloc(AR7_PARTS, sizeof(*ar7_parts), GFP_KERNEL);\n\tif (!ar7_parts)\n\t\treturn -ENOMEM;\n\tar7_parts[0].name = \"loader\";\n\tar7_parts[0].offset = 0;\n\tar7_parts[0].size = master->erasesize;\n\tar7_parts[0].mask_flags = MTD_WRITEABLE;\n\n\tar7_parts[1].name = \"config\";\n\tar7_parts[1].offset = 0;\n\tar7_parts[1].size = master->erasesize;\n\tar7_parts[1].mask_flags = 0;\n\n\tdo {  \n\t\toffset = pre_size;\n\t\tmtd_read(master, offset, sizeof(header), &len,\n\t\t\t (uint8_t *)&header);\n\t\tif (!strncmp((char *)&header, \"TIENV0.8\", 8))\n\t\t\tar7_parts[1].offset = pre_size;\n\t\tif (header.checksum == LOADER_MAGIC1)\n\t\t\tbreak;\n\t\tif (header.checksum == LOADER_MAGIC2)\n\t\t\tbreak;\n\t\tpre_size += master->erasesize;\n\t} while (retries--);\n\n\tpre_size = offset;\n\n\tif (!ar7_parts[1].offset) {\n\t\tar7_parts[1].offset = master->size - master->erasesize;\n\t\tpost_size = master->erasesize;\n\t}\n\n\tswitch (header.checksum) {\n\tcase LOADER_MAGIC1:\n\t\twhile (header.length) {\n\t\t\toffset += sizeof(header) + header.length;\n\t\t\tmtd_read(master, offset, sizeof(header), &len,\n\t\t\t\t (uint8_t *)&header);\n\t\t}\n\t\troot_offset = offset + sizeof(header) + 4;\n\t\tbreak;\n\tcase LOADER_MAGIC2:\n\t\twhile (header.length) {\n\t\t\toffset += sizeof(header) + header.length;\n\t\t\tmtd_read(master, offset, sizeof(header), &len,\n\t\t\t\t (uint8_t *)&header);\n\t\t}\n\t\troot_offset = offset + sizeof(header) + 4 + 0xff;\n\t\troot_offset &= ~(uint32_t)0xff;\n\t\tbreak;\n\tdefault:\n\t\tprintk(KERN_WARNING \"Unknown magic: %08x\\n\", header.checksum);\n\t\tbreak;\n\t}\n\n\tmtd_read(master, root_offset, sizeof(header), &len, (u8 *)&header);\n\tif (header.checksum != SQUASHFS_MAGIC) {\n\t\troot_offset += master->erasesize - 1;\n\t\troot_offset &= ~(master->erasesize - 1);\n\t}\n\n\tar7_parts[2].name = \"linux\";\n\tar7_parts[2].offset = pre_size;\n\tar7_parts[2].size = master->size - pre_size - post_size;\n\tar7_parts[2].mask_flags = 0;\n\n\tar7_parts[3].name = \"rootfs\";\n\tar7_parts[3].offset = root_offset;\n\tar7_parts[3].size = master->size - root_offset - post_size;\n\tar7_parts[3].mask_flags = 0;\n\n\t*pparts = ar7_parts;\n\treturn AR7_PARTS;\n}\n\nstatic struct mtd_part_parser ar7_parser = {\n\t.parse_fn = create_mtd_partitions,\n\t.name = \"ar7part\",\n};\nmodule_mtd_part_parser(ar7_parser);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\t\"Felix Fietkau <nbd@openwrt.org>, \"\n\t\t\"Eugene Konev <ejka@openwrt.org>\");\nMODULE_DESCRIPTION(\"MTD partitioning for TI AR7\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}