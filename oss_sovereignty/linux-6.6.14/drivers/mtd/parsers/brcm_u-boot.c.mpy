{
  "module_name": "brcm_u-boot.c",
  "hash_id": "bf86ea9ea46a3c3693934b662345c952e5b7d2f7ceceb8871731963bedecf213",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/parsers/brcm_u-boot.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/partitions.h>\n\n#define BRCM_U_BOOT_MAX_OFFSET\t\t0x200000\n#define BRCM_U_BOOT_STEP\t\t0x1000\n\n#define BRCM_U_BOOT_MAX_PARTS\t\t2\n\n#define BRCM_U_BOOT_MAGIC\t\t0x75456e76\t \n\nstruct brcm_u_boot_header {\n\t__le32 magic;\n\t__le32 length;\n} __packed;\n\nstatic const char *names[BRCM_U_BOOT_MAX_PARTS] = {\n\t\"u-boot-env\",\n\t\"u-boot-env-backup\",\n};\n\nstatic int brcm_u_boot_parse(struct mtd_info *mtd,\n\t\t\t     const struct mtd_partition **pparts,\n\t\t\t     struct mtd_part_parser_data *data)\n{\n\tstruct brcm_u_boot_header header;\n\tstruct mtd_partition *parts;\n\tsize_t bytes_read;\n\tsize_t offset;\n\tint err;\n\tint i = 0;\n\n\tparts = kcalloc(BRCM_U_BOOT_MAX_PARTS, sizeof(*parts), GFP_KERNEL);\n\tif (!parts)\n\t\treturn -ENOMEM;\n\n\tfor (offset = 0;\n\t     offset < min_t(size_t, mtd->size, BRCM_U_BOOT_MAX_OFFSET);\n\t     offset += BRCM_U_BOOT_STEP) {\n\t\terr = mtd_read(mtd, offset, sizeof(header), &bytes_read, (uint8_t *)&header);\n\t\tif (err && !mtd_is_bitflip(err)) {\n\t\t\tpr_err(\"Failed to read from %s at 0x%zx: %d\\n\", mtd->name, offset, err);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (le32_to_cpu(header.magic) != BRCM_U_BOOT_MAGIC)\n\t\t\tcontinue;\n\n\t\tparts[i].name = names[i];\n\t\tparts[i].offset = offset;\n\t\tparts[i].size = sizeof(header) + le32_to_cpu(header.length);\n\t\ti++;\n\t\tpr_info(\"offset:0x%zx magic:0x%08x BINGO\\n\", offset, header.magic);\n\n\t\tif (i == BRCM_U_BOOT_MAX_PARTS)\n\t\t\tbreak;\n\t}\n\n\t*pparts = parts;\n\n\treturn i;\n};\n\nstatic const struct of_device_id brcm_u_boot_of_match_table[] = {\n\t{ .compatible = \"brcm,u-boot\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, brcm_u_boot_of_match_table);\n\nstatic struct mtd_part_parser brcm_u_boot_mtd_parser = {\n\t.parse_fn = brcm_u_boot_parse,\n\t.name = \"brcm_u-boot\",\n\t.of_match_table = brcm_u_boot_of_match_table,\n};\nmodule_mtd_part_parser(brcm_u_boot_mtd_parser);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}