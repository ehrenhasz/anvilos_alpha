{
  "module_name": "mchp23k256.c",
  "hash_id": "e734a81ecac4e889d4e757a600344c68bdc643605f58f3cb6bc9c76ed00ffcca",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mtd/devices/mchp23k256.c",
  "human_readable_source": "\n \n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/partitions.h>\n#include <linux/mutex.h>\n#include <linux/sched.h>\n#include <linux/sizes.h>\n#include <linux/spi/flash.h>\n#include <linux/spi/spi.h>\n#include <linux/of.h>\n\n#define MAX_CMD_SIZE\t\t4\n\nstruct mchp23_caps {\n\tu8 addr_width;\n\tunsigned int size;\n};\n\nstruct mchp23k256_flash {\n\tstruct spi_device\t*spi;\n\tstruct mutex\t\tlock;\n\tstruct mtd_info\t\tmtd;\n\tconst struct mchp23_caps\t*caps;\n};\n\n#define MCHP23K256_CMD_WRITE_STATUS\t0x01\n#define MCHP23K256_CMD_WRITE\t\t0x02\n#define MCHP23K256_CMD_READ\t\t0x03\n#define MCHP23K256_MODE_SEQ\t\tBIT(6)\n\n#define to_mchp23k256_flash(x) container_of(x, struct mchp23k256_flash, mtd)\n\nstatic void mchp23k256_addr2cmd(struct mchp23k256_flash *flash,\n\t\t\t\tunsigned int addr, u8 *cmd)\n{\n\tint i;\n\n\t \n\tfor (i = flash->caps->addr_width; i > 0; i--, addr >>= 8)\n\t\tcmd[i] = addr;\n}\n\nstatic int mchp23k256_cmdsz(struct mchp23k256_flash *flash)\n{\n\treturn 1 + flash->caps->addr_width;\n}\n\nstatic int mchp23k256_write(struct mtd_info *mtd, loff_t to, size_t len,\n\t\t\t    size_t *retlen, const unsigned char *buf)\n{\n\tstruct mchp23k256_flash *flash = to_mchp23k256_flash(mtd);\n\tstruct spi_transfer transfer[2] = {};\n\tstruct spi_message message;\n\tunsigned char command[MAX_CMD_SIZE];\n\tint ret, cmd_len;\n\n\tspi_message_init(&message);\n\n\tcmd_len = mchp23k256_cmdsz(flash);\n\n\tcommand[0] = MCHP23K256_CMD_WRITE;\n\tmchp23k256_addr2cmd(flash, to, command);\n\n\ttransfer[0].tx_buf = command;\n\ttransfer[0].len = cmd_len;\n\tspi_message_add_tail(&transfer[0], &message);\n\n\ttransfer[1].tx_buf = buf;\n\ttransfer[1].len = len;\n\tspi_message_add_tail(&transfer[1], &message);\n\n\tmutex_lock(&flash->lock);\n\n\tret = spi_sync(flash->spi, &message);\n\n\tmutex_unlock(&flash->lock);\n\n\tif (ret)\n\t\treturn ret;\n\n\tif (retlen && message.actual_length > cmd_len)\n\t\t*retlen += message.actual_length - cmd_len;\n\n\treturn 0;\n}\n\nstatic int mchp23k256_read(struct mtd_info *mtd, loff_t from, size_t len,\n\t\t\t   size_t *retlen, unsigned char *buf)\n{\n\tstruct mchp23k256_flash *flash = to_mchp23k256_flash(mtd);\n\tstruct spi_transfer transfer[2] = {};\n\tstruct spi_message message;\n\tunsigned char command[MAX_CMD_SIZE];\n\tint ret, cmd_len;\n\n\tspi_message_init(&message);\n\n\tcmd_len = mchp23k256_cmdsz(flash);\n\n\tmemset(&transfer, 0, sizeof(transfer));\n\tcommand[0] = MCHP23K256_CMD_READ;\n\tmchp23k256_addr2cmd(flash, from, command);\n\n\ttransfer[0].tx_buf = command;\n\ttransfer[0].len = cmd_len;\n\tspi_message_add_tail(&transfer[0], &message);\n\n\ttransfer[1].rx_buf = buf;\n\ttransfer[1].len = len;\n\tspi_message_add_tail(&transfer[1], &message);\n\n\tmutex_lock(&flash->lock);\n\n\tret = spi_sync(flash->spi, &message);\n\n\tmutex_unlock(&flash->lock);\n\n\tif (ret)\n\t\treturn ret;\n\n\tif (retlen && message.actual_length > cmd_len)\n\t\t*retlen += message.actual_length - cmd_len;\n\n\treturn 0;\n}\n\n \nstatic int mchp23k256_set_mode(struct spi_device *spi)\n{\n\tstruct spi_transfer transfer = {};\n\tstruct spi_message message;\n\tunsigned char command[2];\n\n\tspi_message_init(&message);\n\n\tcommand[0] = MCHP23K256_CMD_WRITE_STATUS;\n\tcommand[1] = MCHP23K256_MODE_SEQ;\n\n\ttransfer.tx_buf = command;\n\ttransfer.len = sizeof(command);\n\tspi_message_add_tail(&transfer, &message);\n\n\treturn spi_sync(spi, &message);\n}\n\nstatic const struct mchp23_caps mchp23k256_caps = {\n\t.size = SZ_32K,\n\t.addr_width = 2,\n};\n\nstatic const struct mchp23_caps mchp23lcv1024_caps = {\n\t.size = SZ_128K,\n\t.addr_width = 3,\n};\n\nstatic int mchp23k256_probe(struct spi_device *spi)\n{\n\tstruct mchp23k256_flash *flash;\n\tstruct flash_platform_data *data;\n\tint err;\n\n\tflash = devm_kzalloc(&spi->dev, sizeof(*flash), GFP_KERNEL);\n\tif (!flash)\n\t\treturn -ENOMEM;\n\n\tflash->spi = spi;\n\tmutex_init(&flash->lock);\n\tspi_set_drvdata(spi, flash);\n\n\terr = mchp23k256_set_mode(spi);\n\tif (err)\n\t\treturn err;\n\n\tdata = dev_get_platdata(&spi->dev);\n\n\tflash->caps = of_device_get_match_data(&spi->dev);\n\tif (!flash->caps)\n\t\tflash->caps = &mchp23k256_caps;\n\n\tmtd_set_of_node(&flash->mtd, spi->dev.of_node);\n\tflash->mtd.dev.parent\t= &spi->dev;\n\tflash->mtd.type\t\t= MTD_RAM;\n\tflash->mtd.flags\t= MTD_CAP_RAM;\n\tflash->mtd.writesize\t= 1;\n\tflash->mtd.size\t\t= flash->caps->size;\n\tflash->mtd._read\t= mchp23k256_read;\n\tflash->mtd._write\t= mchp23k256_write;\n\n\terr = mtd_device_register(&flash->mtd, data ? data->parts : NULL,\n\t\t\t\t  data ? data->nr_parts : 0);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic void mchp23k256_remove(struct spi_device *spi)\n{\n\tstruct mchp23k256_flash *flash = spi_get_drvdata(spi);\n\n\tWARN_ON(mtd_device_unregister(&flash->mtd));\n}\n\nstatic const struct of_device_id mchp23k256_of_table[] = {\n\t{\n\t\t.compatible = \"microchip,mchp23k256\",\n\t\t.data = &mchp23k256_caps,\n\t},\n\t{\n\t\t.compatible = \"microchip,mchp23lcv1024\",\n\t\t.data = &mchp23lcv1024_caps,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, mchp23k256_of_table);\n\nstatic const struct spi_device_id mchp23k256_spi_ids[] = {\n\t{\n\t\t.name = \"mchp23k256\",\n\t\t.driver_data = (kernel_ulong_t)&mchp23k256_caps,\n\t},\n\t{\n\t\t.name = \"mchp23lcv1024\",\n\t\t.driver_data = (kernel_ulong_t)&mchp23lcv1024_caps,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, mchp23k256_spi_ids);\n\nstatic struct spi_driver mchp23k256_driver = {\n\t.driver = {\n\t\t.name\t= \"mchp23k256\",\n\t\t.of_match_table = mchp23k256_of_table,\n\t},\n\t.probe\t\t= mchp23k256_probe,\n\t.remove\t\t= mchp23k256_remove,\n\t.id_table\t= mchp23k256_spi_ids,\n};\n\nmodule_spi_driver(mchp23k256_driver);\n\nMODULE_DESCRIPTION(\"MTD SPI driver for MCHP23K256 RAM chips\");\nMODULE_AUTHOR(\"Andrew Lunn <andre@lunn.ch>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"spi:mchp23k256\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}