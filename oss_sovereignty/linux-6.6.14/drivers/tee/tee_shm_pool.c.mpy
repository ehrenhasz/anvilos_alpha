{
  "module_name": "tee_shm_pool.c",
  "hash_id": "c5343c77ba77bd41d01abefc6d726532ca0b57a38ee517170dd08e34bc1be6b3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/tee/tee_shm_pool.c",
  "human_readable_source": "\n \n#include <linux/device.h>\n#include <linux/dma-buf.h>\n#include <linux/genalloc.h>\n#include <linux/slab.h>\n#include <linux/tee_drv.h>\n#include \"tee_private.h\"\n\nstatic int pool_op_gen_alloc(struct tee_shm_pool *pool, struct tee_shm *shm,\n\t\t\t     size_t size, size_t align)\n{\n\tunsigned long va;\n\tstruct gen_pool *genpool = pool->private_data;\n\tsize_t a = max_t(size_t, align, BIT(genpool->min_alloc_order));\n\tstruct genpool_data_align data = { .align = a };\n\tsize_t s = roundup(size, a);\n\n\tva = gen_pool_alloc_algo(genpool, s, gen_pool_first_fit_align, &data);\n\tif (!va)\n\t\treturn -ENOMEM;\n\n\tmemset((void *)va, 0, s);\n\tshm->kaddr = (void *)va;\n\tshm->paddr = gen_pool_virt_to_phys(genpool, va);\n\tshm->size = s;\n\t \n\tshm->flags &= ~TEE_SHM_DYNAMIC;\n\treturn 0;\n}\n\nstatic void pool_op_gen_free(struct tee_shm_pool *pool, struct tee_shm *shm)\n{\n\tgen_pool_free(pool->private_data, (unsigned long)shm->kaddr,\n\t\t      shm->size);\n\tshm->kaddr = NULL;\n}\n\nstatic void pool_op_gen_destroy_pool(struct tee_shm_pool *pool)\n{\n\tgen_pool_destroy(pool->private_data);\n\tkfree(pool);\n}\n\nstatic const struct tee_shm_pool_ops pool_ops_generic = {\n\t.alloc = pool_op_gen_alloc,\n\t.free = pool_op_gen_free,\n\t.destroy_pool = pool_op_gen_destroy_pool,\n};\n\nstruct tee_shm_pool *tee_shm_pool_alloc_res_mem(unsigned long vaddr,\n\t\t\t\t\t\tphys_addr_t paddr, size_t size,\n\t\t\t\t\t\tint min_alloc_order)\n{\n\tconst size_t page_mask = PAGE_SIZE - 1;\n\tstruct tee_shm_pool *pool;\n\tint rc;\n\n\t \n\tif (vaddr & page_mask || paddr & page_mask || size & page_mask)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tpool = kzalloc(sizeof(*pool), GFP_KERNEL);\n\tif (!pool)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tpool->private_data = gen_pool_create(min_alloc_order, -1);\n\tif (!pool->private_data) {\n\t\trc = -ENOMEM;\n\t\tgoto err;\n\t}\n\n\trc = gen_pool_add_virt(pool->private_data, vaddr, paddr, size, -1);\n\tif (rc) {\n\t\tgen_pool_destroy(pool->private_data);\n\t\tgoto err;\n\t}\n\n\tpool->ops = &pool_ops_generic;\n\n\treturn pool;\nerr:\n\tkfree(pool);\n\n\treturn ERR_PTR(rc);\n}\nEXPORT_SYMBOL_GPL(tee_shm_pool_alloc_res_mem);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}