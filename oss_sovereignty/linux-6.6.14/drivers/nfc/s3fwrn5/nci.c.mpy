{
  "module_name": "nci.c",
  "hash_id": "d1cb0bb4c2febbe317b6f76aa06676e63830174ac6396e42521416bd108a35b8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nfc/s3fwrn5/nci.c",
  "human_readable_source": "\n \n\n#include <linux/completion.h>\n#include <linux/firmware.h>\n\n#include \"s3fwrn5.h\"\n#include \"nci.h\"\n\nstatic int s3fwrn5_nci_prop_rsp(struct nci_dev *ndev, struct sk_buff *skb)\n{\n\t__u8 status = skb->data[0];\n\n\tnci_req_complete(ndev, status);\n\treturn 0;\n}\n\nconst struct nci_driver_ops s3fwrn5_nci_prop_ops[4] = {\n\t{\n\t\t.opcode = nci_opcode_pack(NCI_GID_PROPRIETARY,\n\t\t\t\tNCI_PROP_SET_RFREG),\n\t\t.rsp = s3fwrn5_nci_prop_rsp,\n\t},\n\t{\n\t\t.opcode = nci_opcode_pack(NCI_GID_PROPRIETARY,\n\t\t\t\tNCI_PROP_START_RFREG),\n\t\t.rsp = s3fwrn5_nci_prop_rsp,\n\t},\n\t{\n\t\t.opcode = nci_opcode_pack(NCI_GID_PROPRIETARY,\n\t\t\t\tNCI_PROP_STOP_RFREG),\n\t\t.rsp = s3fwrn5_nci_prop_rsp,\n\t},\n\t{\n\t\t.opcode = nci_opcode_pack(NCI_GID_PROPRIETARY,\n\t\t\t\tNCI_PROP_FW_CFG),\n\t\t.rsp = s3fwrn5_nci_prop_rsp,\n\t},\n};\n\n#define S3FWRN5_RFREG_SECTION_SIZE 252\n\nint s3fwrn5_nci_rf_configure(struct s3fwrn5_info *info, const char *fw_name)\n{\n\tstruct device *dev = &info->ndev->nfc_dev->dev;\n\tconst struct firmware *fw;\n\tstruct nci_prop_fw_cfg_cmd fw_cfg;\n\tstruct nci_prop_set_rfreg_cmd set_rfreg;\n\tstruct nci_prop_stop_rfreg_cmd stop_rfreg;\n\tu32 checksum;\n\tint i, len;\n\tint ret;\n\n\tret = request_firmware(&fw, fw_name, dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\n\tchecksum = 0;\n\tfor (i = 0; i < fw->size; i += 4)\n\t\tchecksum += *((u32 *)(fw->data+i));\n\n\t \n\n\tfw_cfg.clk_type = 0x01;\n\tfw_cfg.clk_speed = 0xff;\n\tfw_cfg.clk_req = 0xff;\n\tret = nci_prop_cmd(info->ndev, NCI_PROP_FW_CFG,\n\t\tsizeof(fw_cfg), (__u8 *)&fw_cfg);\n\tif (ret < 0)\n\t\tgoto out;\n\n\t \n\n\tdev_info(dev, \"rfreg configuration update: %s\\n\", fw_name);\n\n\tret = nci_prop_cmd(info->ndev, NCI_PROP_START_RFREG, 0, NULL);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Unable to start rfreg update\\n\");\n\t\tgoto out;\n\t}\n\n\t \n\n\tset_rfreg.index = 0;\n\tfor (i = 0; i < fw->size; i += S3FWRN5_RFREG_SECTION_SIZE) {\n\t\tlen = (fw->size - i < S3FWRN5_RFREG_SECTION_SIZE) ?\n\t\t\t(fw->size - i) : S3FWRN5_RFREG_SECTION_SIZE;\n\t\tmemcpy(set_rfreg.data, fw->data+i, len);\n\t\tret = nci_prop_cmd(info->ndev, NCI_PROP_SET_RFREG,\n\t\t\tlen+1, (__u8 *)&set_rfreg);\n\t\tif (ret < 0) {\n\t\t\tdev_err(dev, \"rfreg update error (code=%d)\\n\", ret);\n\t\t\tgoto out;\n\t\t}\n\t\tset_rfreg.index++;\n\t}\n\n\t \n\n\tstop_rfreg.checksum = checksum & 0xffff;\n\tret = nci_prop_cmd(info->ndev, NCI_PROP_STOP_RFREG,\n\t\tsizeof(stop_rfreg), (__u8 *)&stop_rfreg);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Unable to stop rfreg update\\n\");\n\t\tgoto out;\n\t}\n\n\tdev_info(dev, \"rfreg configuration update: success\\n\");\nout:\n\trelease_firmware(fw);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}