{
  "module_name": "core.c",
  "hash_id": "a0d52404acd6f94694bcfe8525e64134c6ae98c19787450f31301becdf3836b3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nfc/s3fwrn5/core.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <net/nfc/nci_core.h>\n\n#include \"s3fwrn5.h\"\n#include \"firmware.h\"\n#include \"nci.h\"\n\n#define S3FWRN5_NFC_PROTOCOLS  (NFC_PROTO_JEWEL_MASK | \\\n\t\t\t\tNFC_PROTO_MIFARE_MASK | \\\n\t\t\t\tNFC_PROTO_FELICA_MASK | \\\n\t\t\t\tNFC_PROTO_ISO14443_MASK | \\\n\t\t\t\tNFC_PROTO_ISO14443_B_MASK | \\\n\t\t\t\tNFC_PROTO_ISO15693_MASK)\n\nstatic int s3fwrn5_firmware_init(struct s3fwrn5_info *info)\n{\n\tstruct s3fwrn5_fw_info *fw_info = &info->fw_info;\n\tint ret;\n\n\ts3fwrn5_fw_init(fw_info, \"sec_s3fwrn5_firmware.bin\");\n\n\t \n\tret = s3fwrn5_fw_request_firmware(fw_info);\n\tif (ret < 0)\n\t\tdev_err(&fw_info->ndev->nfc_dev->dev,\n\t\t\t\"Failed to get fw file, ret=%02x\\n\", ret);\n\treturn ret;\n}\n\nstatic int s3fwrn5_firmware_update(struct s3fwrn5_info *info)\n{\n\tbool need_update;\n\tint ret;\n\n\t \n\n\ts3fwrn5_set_wake(info, false);\n\ts3fwrn5_set_mode(info, S3FWRN5_MODE_FW);\n\n\tret = s3fwrn5_fw_setup(&info->fw_info);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tneed_update = s3fwrn5_fw_check_version(&info->fw_info,\n\t\tinfo->ndev->manufact_specific_info);\n\tif (!need_update)\n\t\tgoto out;\n\n\tdev_info(&info->ndev->nfc_dev->dev, \"Detected new firmware version\\n\");\n\n\tret = s3fwrn5_fw_download(&info->fw_info);\n\tif (ret < 0)\n\t\tgoto out;\n\n\t \n\n\ts3fwrn5_set_mode(info, S3FWRN5_MODE_NCI);\n\n\ts3fwrn5_set_wake(info, true);\n\tret = s3fwrn5_nci_rf_configure(info, \"sec_s3fwrn5_rfreg.bin\");\n\ts3fwrn5_set_wake(info, false);\n\nout:\n\ts3fwrn5_set_mode(info, S3FWRN5_MODE_COLD);\n\ts3fwrn5_fw_cleanup(&info->fw_info);\n\treturn ret;\n}\n\nstatic int s3fwrn5_nci_open(struct nci_dev *ndev)\n{\n\tstruct s3fwrn5_info *info = nci_get_drvdata(ndev);\n\n\tif (s3fwrn5_get_mode(info) != S3FWRN5_MODE_COLD)\n\t\treturn  -EBUSY;\n\n\ts3fwrn5_set_mode(info, S3FWRN5_MODE_NCI);\n\ts3fwrn5_set_wake(info, true);\n\n\treturn 0;\n}\n\nstatic int s3fwrn5_nci_close(struct nci_dev *ndev)\n{\n\tstruct s3fwrn5_info *info = nci_get_drvdata(ndev);\n\n\ts3fwrn5_set_wake(info, false);\n\ts3fwrn5_set_mode(info, S3FWRN5_MODE_COLD);\n\n\treturn 0;\n}\n\nstatic int s3fwrn5_nci_send(struct nci_dev *ndev, struct sk_buff *skb)\n{\n\tstruct s3fwrn5_info *info = nci_get_drvdata(ndev);\n\tint ret;\n\n\tmutex_lock(&info->mutex);\n\n\tif (s3fwrn5_get_mode(info) != S3FWRN5_MODE_NCI) {\n\t\tkfree_skb(skb);\n\t\tmutex_unlock(&info->mutex);\n\t\treturn -EINVAL;\n\t}\n\n\tret = s3fwrn5_write(info, skb);\n\tif (ret < 0) {\n\t\tkfree_skb(skb);\n\t\tmutex_unlock(&info->mutex);\n\t\treturn ret;\n\t}\n\n\tconsume_skb(skb);\n\tmutex_unlock(&info->mutex);\n\treturn 0;\n}\n\nstatic int s3fwrn5_nci_post_setup(struct nci_dev *ndev)\n{\n\tstruct s3fwrn5_info *info = nci_get_drvdata(ndev);\n\tint ret;\n\n\tif (s3fwrn5_firmware_init(info)) {\n\t\t\n\t\treturn 0;\n\t}\n\n\tret = s3fwrn5_firmware_update(info);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\n\ts3fwrn5_set_mode(info, S3FWRN5_MODE_NCI);\n\ts3fwrn5_set_wake(info, true);\n\n\tret = nci_core_reset(info->ndev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn nci_core_init(info->ndev);\n}\n\nstatic const struct nci_ops s3fwrn5_nci_ops = {\n\t.open = s3fwrn5_nci_open,\n\t.close = s3fwrn5_nci_close,\n\t.send = s3fwrn5_nci_send,\n\t.post_setup = s3fwrn5_nci_post_setup,\n\t.prop_ops = s3fwrn5_nci_prop_ops,\n\t.n_prop_ops = ARRAY_SIZE(s3fwrn5_nci_prop_ops),\n};\n\nint s3fwrn5_probe(struct nci_dev **ndev, void *phy_id, struct device *pdev,\n\tconst struct s3fwrn5_phy_ops *phy_ops)\n{\n\tstruct s3fwrn5_info *info;\n\tint ret;\n\n\tinfo = devm_kzalloc(pdev, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->phy_id = phy_id;\n\tinfo->pdev = pdev;\n\tinfo->phy_ops = phy_ops;\n\tmutex_init(&info->mutex);\n\n\ts3fwrn5_set_mode(info, S3FWRN5_MODE_COLD);\n\n\tinfo->ndev = nci_allocate_device(&s3fwrn5_nci_ops,\n\t\tS3FWRN5_NFC_PROTOCOLS, 0, 0);\n\tif (!info->ndev)\n\t\treturn -ENOMEM;\n\n\tnci_set_parent_dev(info->ndev, pdev);\n\tnci_set_drvdata(info->ndev, info);\n\n\tret = nci_register_device(info->ndev);\n\tif (ret < 0) {\n\t\tnci_free_device(info->ndev);\n\t\treturn ret;\n\t}\n\n\tinfo->fw_info.ndev = info->ndev;\n\n\t*ndev = info->ndev;\n\n\treturn ret;\n}\nEXPORT_SYMBOL(s3fwrn5_probe);\n\nvoid s3fwrn5_remove(struct nci_dev *ndev)\n{\n\tstruct s3fwrn5_info *info = nci_get_drvdata(ndev);\n\n\ts3fwrn5_set_mode(info, S3FWRN5_MODE_COLD);\n\n\tnci_unregister_device(ndev);\n\tnci_free_device(ndev);\n}\nEXPORT_SYMBOL(s3fwrn5_remove);\n\nint s3fwrn5_recv_frame(struct nci_dev *ndev, struct sk_buff *skb,\n\tenum s3fwrn5_mode mode)\n{\n\tswitch (mode) {\n\tcase S3FWRN5_MODE_NCI:\n\t\treturn nci_recv_frame(ndev, skb);\n\tcase S3FWRN5_MODE_FW:\n\t\treturn s3fwrn5_fw_recv_frame(ndev, skb);\n\tdefault:\n\t\tkfree_skb(skb);\n\t\treturn -ENODEV;\n\t}\n}\nEXPORT_SYMBOL(s3fwrn5_recv_frame);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"Samsung S3FWRN5 NFC driver\");\nMODULE_AUTHOR(\"Robert Baldyga <r.baldyga@samsung.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}