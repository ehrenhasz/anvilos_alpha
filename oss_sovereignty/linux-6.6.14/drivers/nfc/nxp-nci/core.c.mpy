{
  "module_name": "core.c",
  "hash_id": "4f2dc5daf503fd841e273738728256dff1a36f140b09ed2dbe211cfee2e45bb5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nfc/nxp-nci/core.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/module.h>\n#include <linux/nfc.h>\n\n#include <net/nfc/nci_core.h>\n\n#include \"nxp-nci.h\"\n\n#define NXP_NCI_HDR_LEN\t4\n\n#define NXP_NCI_NFC_PROTOCOLS (NFC_PROTO_JEWEL_MASK | \\\n\t\t\t       NFC_PROTO_MIFARE_MASK | \\\n\t\t\t       NFC_PROTO_FELICA_MASK | \\\n\t\t\t       NFC_PROTO_ISO14443_MASK | \\\n\t\t\t       NFC_PROTO_ISO14443_B_MASK | \\\n\t\t\t       NFC_PROTO_NFC_DEP_MASK)\n\n#define NXP_NCI_RF_PLL_UNLOCKED_NTF nci_opcode_pack(NCI_GID_RF_MGMT, 0x21)\n#define NXP_NCI_RF_TXLDO_ERROR_NTF nci_opcode_pack(NCI_GID_RF_MGMT, 0x23)\n\nstatic int nxp_nci_open(struct nci_dev *ndev)\n{\n\tstruct nxp_nci_info *info = nci_get_drvdata(ndev);\n\tint r = 0;\n\n\tmutex_lock(&info->info_lock);\n\n\tif (info->mode != NXP_NCI_MODE_COLD) {\n\t\tr = -EBUSY;\n\t\tgoto open_exit;\n\t}\n\n\tif (info->phy_ops->set_mode)\n\t\tr = info->phy_ops->set_mode(info->phy_id, NXP_NCI_MODE_NCI);\n\n\tinfo->mode = NXP_NCI_MODE_NCI;\n\nopen_exit:\n\tmutex_unlock(&info->info_lock);\n\treturn r;\n}\n\nstatic int nxp_nci_close(struct nci_dev *ndev)\n{\n\tstruct nxp_nci_info *info = nci_get_drvdata(ndev);\n\tint r = 0;\n\n\tmutex_lock(&info->info_lock);\n\n\tif (info->phy_ops->set_mode)\n\t\tr = info->phy_ops->set_mode(info->phy_id, NXP_NCI_MODE_COLD);\n\n\tinfo->mode = NXP_NCI_MODE_COLD;\n\n\tmutex_unlock(&info->info_lock);\n\treturn r;\n}\n\nstatic int nxp_nci_send(struct nci_dev *ndev, struct sk_buff *skb)\n{\n\tstruct nxp_nci_info *info = nci_get_drvdata(ndev);\n\tint r;\n\n\tif (!info->phy_ops->write) {\n\t\tkfree_skb(skb);\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif (info->mode != NXP_NCI_MODE_NCI) {\n\t\tkfree_skb(skb);\n\t\treturn -EINVAL;\n\t}\n\n\tr = info->phy_ops->write(info->phy_id, skb);\n\tif (r < 0) {\n\t\tkfree_skb(skb);\n\t\treturn r;\n\t}\n\n\tconsume_skb(skb);\n\treturn 0;\n}\n\nstatic int nxp_nci_rf_pll_unlocked_ntf(struct nci_dev *ndev,\n\t\t\t\t       struct sk_buff *skb)\n{\n\tnfc_err(&ndev->nfc_dev->dev,\n\t\t\"PLL didn't lock. Missing or unstable clock?\\n\");\n\n\treturn 0;\n}\n\nstatic int nxp_nci_rf_txldo_error_ntf(struct nci_dev *ndev,\n\t\t\t\t      struct sk_buff *skb)\n{\n\tnfc_err(&ndev->nfc_dev->dev,\n\t\t\"RF transmitter couldn't start. Bad power and/or configuration?\\n\");\n\n\treturn 0;\n}\n\nstatic const struct nci_driver_ops nxp_nci_core_ops[] = {\n\t{\n\t\t.opcode = NXP_NCI_RF_PLL_UNLOCKED_NTF,\n\t\t.ntf = nxp_nci_rf_pll_unlocked_ntf,\n\t},\n\t{\n\t\t.opcode = NXP_NCI_RF_TXLDO_ERROR_NTF,\n\t\t.ntf = nxp_nci_rf_txldo_error_ntf,\n\t},\n};\n\nstatic const struct nci_ops nxp_nci_ops = {\n\t.open = nxp_nci_open,\n\t.close = nxp_nci_close,\n\t.send = nxp_nci_send,\n\t.fw_download = nxp_nci_fw_download,\n\t.core_ops = nxp_nci_core_ops,\n\t.n_core_ops = ARRAY_SIZE(nxp_nci_core_ops),\n};\n\nint nxp_nci_probe(void *phy_id, struct device *pdev,\n\t\t  const struct nxp_nci_phy_ops *phy_ops,\n\t\t  unsigned int max_payload,\n\t\t  struct nci_dev **ndev)\n{\n\tstruct nxp_nci_info *info;\n\tint r;\n\n\tinfo = devm_kzalloc(pdev, sizeof(struct nxp_nci_info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->phy_id = phy_id;\n\tinfo->pdev = pdev;\n\tinfo->phy_ops = phy_ops;\n\tinfo->max_payload = max_payload;\n\tINIT_WORK(&info->fw_info.work, nxp_nci_fw_work);\n\tinit_completion(&info->fw_info.cmd_completion);\n\tmutex_init(&info->info_lock);\n\n\tif (info->phy_ops->set_mode) {\n\t\tr = info->phy_ops->set_mode(info->phy_id, NXP_NCI_MODE_COLD);\n\t\tif (r < 0)\n\t\t\treturn r;\n\t}\n\n\tinfo->mode = NXP_NCI_MODE_COLD;\n\n\tinfo->ndev = nci_allocate_device(&nxp_nci_ops, NXP_NCI_NFC_PROTOCOLS,\n\t\t\t\t\t NXP_NCI_HDR_LEN, 0);\n\tif (!info->ndev)\n\t\treturn -ENOMEM;\n\n\tnci_set_parent_dev(info->ndev, pdev);\n\tnci_set_drvdata(info->ndev, info);\n\tr = nci_register_device(info->ndev);\n\tif (r < 0) {\n\t\tnci_free_device(info->ndev);\n\t\treturn r;\n\t}\n\n\t*ndev = info->ndev;\n\treturn r;\n}\nEXPORT_SYMBOL(nxp_nci_probe);\n\nvoid nxp_nci_remove(struct nci_dev *ndev)\n{\n\tstruct nxp_nci_info *info = nci_get_drvdata(ndev);\n\n\tif (info->mode == NXP_NCI_MODE_FW)\n\t\tnxp_nci_fw_work_complete(info, -ESHUTDOWN);\n\tcancel_work_sync(&info->fw_info.work);\n\n\tmutex_lock(&info->info_lock);\n\n\tif (info->phy_ops->set_mode)\n\t\tinfo->phy_ops->set_mode(info->phy_id, NXP_NCI_MODE_COLD);\n\n\tnci_unregister_device(ndev);\n\tnci_free_device(ndev);\n\n\tmutex_unlock(&info->info_lock);\n}\nEXPORT_SYMBOL(nxp_nci_remove);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"NXP NCI NFC driver\");\nMODULE_AUTHOR(\"Cl\u00e9ment Perrochaud <clement.perrochaud@nxp.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}