{
  "module_name": "dep.c",
  "hash_id": "e1895335de104298b24b3cd158825076cccf875021a39012ce780ecd02ddc10e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nfc/st21nfca/dep.c",
  "human_readable_source": "\n \n\n#include <net/nfc/hci.h>\n\n#include \"st21nfca.h\"\n\n#define ST21NFCA_NFCIP1_INITIATOR 0x00\n#define ST21NFCA_NFCIP1_REQ 0xd4\n#define ST21NFCA_NFCIP1_RES 0xd5\n#define ST21NFCA_NFCIP1_ATR_REQ 0x00\n#define ST21NFCA_NFCIP1_ATR_RES 0x01\n#define ST21NFCA_NFCIP1_PSL_REQ 0x04\n#define ST21NFCA_NFCIP1_PSL_RES 0x05\n#define ST21NFCA_NFCIP1_DEP_REQ 0x06\n#define ST21NFCA_NFCIP1_DEP_RES 0x07\n\n#define ST21NFCA_NFC_DEP_PFB_PNI(pfb)     ((pfb) & 0x03)\n#define ST21NFCA_NFC_DEP_PFB_TYPE(pfb) ((pfb) & 0xE0)\n#define ST21NFCA_NFC_DEP_PFB_IS_TIMEOUT(pfb) \\\n\t\t\t\t((pfb) & ST21NFCA_NFC_DEP_PFB_TIMEOUT_BIT)\n#define ST21NFCA_NFC_DEP_DID_BIT_SET(pfb) ((pfb) & 0x04)\n#define ST21NFCA_NFC_DEP_NAD_BIT_SET(pfb) ((pfb) & 0x08)\n#define ST21NFCA_NFC_DEP_PFB_TIMEOUT_BIT 0x10\n\n#define ST21NFCA_NFC_DEP_PFB_IS_TIMEOUT(pfb) \\\n\t\t\t\t((pfb) & ST21NFCA_NFC_DEP_PFB_TIMEOUT_BIT)\n\n#define ST21NFCA_NFC_DEP_PFB_I_PDU          0x00\n#define ST21NFCA_NFC_DEP_PFB_ACK_NACK_PDU   0x40\n#define ST21NFCA_NFC_DEP_PFB_SUPERVISOR_PDU 0x80\n\n#define ST21NFCA_ATR_REQ_MIN_SIZE 17\n#define ST21NFCA_ATR_REQ_MAX_SIZE 65\n#define ST21NFCA_LR_BITS_PAYLOAD_SIZE_254B 0x30\n#define ST21NFCA_GB_BIT  0x02\n\n#define ST21NFCA_EVT_SEND_DATA\t\t0x10\n#define ST21NFCA_EVT_FIELD_ON           0x11\n#define ST21NFCA_EVT_CARD_DEACTIVATED   0x12\n#define ST21NFCA_EVT_CARD_ACTIVATED     0x13\n#define ST21NFCA_EVT_FIELD_OFF          0x14\n\n#define ST21NFCA_EVT_CARD_F_BITRATE 0x16\n#define ST21NFCA_EVT_READER_F_BITRATE 0x13\n#define\tST21NFCA_PSL_REQ_SEND_SPEED(brs) (brs & 0x38)\n#define ST21NFCA_PSL_REQ_RECV_SPEED(brs) (brs & 0x07)\n#define ST21NFCA_PP2LRI(pp) ((pp & 0x30) >> 4)\n#define ST21NFCA_CARD_BITRATE_212 0x01\n#define ST21NFCA_CARD_BITRATE_424 0x02\n\n#define ST21NFCA_DEFAULT_TIMEOUT 0x0a\n\n\n#define PROTOCOL_ERR(req) pr_err(\"%d: ST21NFCA Protocol error: %s\\n\", \\\n\t\t\t\t __LINE__, req)\n\nstruct st21nfca_atr_req {\n\tu8 length;\n\tu8 cmd0;\n\tu8 cmd1;\n\tu8 nfcid3[NFC_NFCID3_MAXSIZE];\n\tu8 did;\n\tu8 bsi;\n\tu8 bri;\n\tu8 ppi;\n\tu8 gbi[];\n} __packed;\n\nstruct st21nfca_atr_res {\n\tu8 length;\n\tu8 cmd0;\n\tu8 cmd1;\n\tu8 nfcid3[NFC_NFCID3_MAXSIZE];\n\tu8 did;\n\tu8 bsi;\n\tu8 bri;\n\tu8 to;\n\tu8 ppi;\n\tu8 gbi[];\n} __packed;\n\nstruct st21nfca_psl_req {\n\tu8 length;\n\tu8 cmd0;\n\tu8 cmd1;\n\tu8 did;\n\tu8 brs;\n\tu8 fsl;\n} __packed;\n\nstruct st21nfca_psl_res {\n\tu8 length;\n\tu8 cmd0;\n\tu8 cmd1;\n\tu8 did;\n} __packed;\n\nstruct st21nfca_dep_req_res {\n\tu8 length;\n\tu8 cmd0;\n\tu8 cmd1;\n\tu8 pfb;\n\tu8 did;\n\tu8 nad;\n} __packed;\n\nstatic void st21nfca_tx_work(struct work_struct *work)\n{\n\tstruct st21nfca_hci_info *info = container_of(work,\n\t\t\t\t\t\tstruct st21nfca_hci_info,\n\t\t\t\t\t\tdep_info.tx_work);\n\n\tstruct nfc_dev *dev;\n\tstruct sk_buff *skb;\n\n\tif (info) {\n\t\tdev = info->hdev->ndev;\n\t\tskb = info->dep_info.tx_pending;\n\n\t\tdevice_lock(&dev->dev);\n\n\t\tnfc_hci_send_cmd_async(info->hdev, ST21NFCA_RF_READER_F_GATE,\n\t\t\t\tST21NFCA_WR_XCHG_DATA, skb->data, skb->len,\n\t\t\t\tinfo->async_cb, info);\n\t\tdevice_unlock(&dev->dev);\n\t\tkfree_skb(skb);\n\t}\n}\n\nstatic void st21nfca_im_send_pdu(struct st21nfca_hci_info *info,\n\t\t\t\t\t\tstruct sk_buff *skb)\n{\n\tinfo->dep_info.tx_pending = skb;\n\tschedule_work(&info->dep_info.tx_work);\n}\n\nstatic int st21nfca_tm_send_atr_res(struct nfc_hci_dev *hdev,\n\t\t\t\t    struct st21nfca_atr_req *atr_req)\n{\n\tstruct st21nfca_atr_res *atr_res;\n\tstruct sk_buff *skb;\n\tsize_t gb_len;\n\tint r;\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tgb_len = atr_req->length - sizeof(struct st21nfca_atr_req);\n\tskb = alloc_skb(atr_req->length + 1, GFP_KERNEL);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_put(skb, sizeof(struct st21nfca_atr_res));\n\n\tatr_res = (struct st21nfca_atr_res *)skb->data;\n\tmemset(atr_res, 0, sizeof(struct st21nfca_atr_res));\n\n\tatr_res->length = atr_req->length + 1;\n\tatr_res->cmd0 = ST21NFCA_NFCIP1_RES;\n\tatr_res->cmd1 = ST21NFCA_NFCIP1_ATR_RES;\n\n\tmemcpy(atr_res->nfcid3, atr_req->nfcid3, 6);\n\tatr_res->bsi = 0x00;\n\tatr_res->bri = 0x00;\n\tatr_res->to = ST21NFCA_DEFAULT_TIMEOUT;\n\tatr_res->ppi = ST21NFCA_LR_BITS_PAYLOAD_SIZE_254B;\n\n\tif (gb_len) {\n\t\tskb_put(skb, gb_len);\n\n\t\tatr_res->ppi |= ST21NFCA_GB_BIT;\n\t\tmemcpy(atr_res->gbi, atr_req->gbi, gb_len);\n\t\tr = nfc_set_remote_general_bytes(hdev->ndev, atr_res->gbi,\n\t\t\t\t\t\t  gb_len);\n\t\tif (r < 0) {\n\t\t\tkfree_skb(skb);\n\t\t\treturn r;\n\t\t}\n\t}\n\n\tinfo->dep_info.curr_nfc_dep_pni = 0;\n\n\tr = nfc_hci_send_event(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\t\tST21NFCA_EVT_SEND_DATA, skb->data, skb->len);\n\tkfree_skb(skb);\n\treturn r;\n}\n\nstatic int st21nfca_tm_recv_atr_req(struct nfc_hci_dev *hdev,\n\t\t\t\t    struct sk_buff *skb)\n{\n\tstruct st21nfca_atr_req *atr_req;\n\tsize_t gb_len;\n\tint r;\n\n\tskb_trim(skb, skb->len - 1);\n\n\tif (!skb->len)\n\t\treturn -EIO;\n\n\tif (skb->len < ST21NFCA_ATR_REQ_MIN_SIZE)\n\t\treturn -EPROTO;\n\n\tatr_req = (struct st21nfca_atr_req *)skb->data;\n\n\tif (atr_req->length < sizeof(struct st21nfca_atr_req))\n\t\treturn -EPROTO;\n\n\tr = st21nfca_tm_send_atr_res(hdev, atr_req);\n\tif (r)\n\t\treturn r;\n\n\tgb_len = skb->len - sizeof(struct st21nfca_atr_req);\n\n\tr = nfc_tm_activated(hdev->ndev, NFC_PROTO_NFC_DEP_MASK,\n\t\t\t      NFC_COMM_PASSIVE, atr_req->gbi, gb_len);\n\tif (r)\n\t\treturn r;\n\n\treturn 0;\n}\n\nstatic int st21nfca_tm_send_psl_res(struct nfc_hci_dev *hdev,\n\t\t\t\t    struct st21nfca_psl_req *psl_req)\n{\n\tstruct st21nfca_psl_res *psl_res;\n\tstruct sk_buff *skb;\n\tu8 bitrate[2] = {0, 0};\n\tint r;\n\n\tskb = alloc_skb(sizeof(struct st21nfca_psl_res), GFP_KERNEL);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\tskb_put(skb, sizeof(struct st21nfca_psl_res));\n\n\tpsl_res = (struct st21nfca_psl_res *)skb->data;\n\n\tpsl_res->length = sizeof(struct st21nfca_psl_res);\n\tpsl_res->cmd0 = ST21NFCA_NFCIP1_RES;\n\tpsl_res->cmd1 = ST21NFCA_NFCIP1_PSL_RES;\n\tpsl_res->did = psl_req->did;\n\n\tr = nfc_hci_send_event(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\t\tST21NFCA_EVT_SEND_DATA, skb->data, skb->len);\n\tif (r < 0)\n\t\tgoto error;\n\n\t \n\tif (ST21NFCA_PSL_REQ_SEND_SPEED(psl_req->brs) &&\n\t    ST21NFCA_PSL_REQ_RECV_SPEED(psl_req->brs)) {\n\t\tbitrate[0] = ST21NFCA_CARD_BITRATE_424;\n\t\tbitrate[1] = ST21NFCA_CARD_BITRATE_424;\n\t}\n\n\t \n\tr = nfc_hci_send_event(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\tST21NFCA_EVT_CARD_F_BITRATE, bitrate, 2);\nerror:\n\tkfree_skb(skb);\n\treturn r;\n}\n\nstatic int st21nfca_tm_recv_psl_req(struct nfc_hci_dev *hdev,\n\t\t\t\t    struct sk_buff *skb)\n{\n\tstruct st21nfca_psl_req *psl_req;\n\n\tskb_trim(skb, skb->len - 1);\n\n\tif (!skb->len)\n\t\treturn -EIO;\n\n\tpsl_req = (struct st21nfca_psl_req *)skb->data;\n\n\tif (skb->len < sizeof(struct st21nfca_psl_req))\n\t\treturn -EIO;\n\n\treturn st21nfca_tm_send_psl_res(hdev, psl_req);\n}\n\nint st21nfca_tm_send_dep_res(struct nfc_hci_dev *hdev, struct sk_buff *skb)\n{\n\tint r;\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\t*(u8 *)skb_push(skb, 1) = info->dep_info.curr_nfc_dep_pni;\n\t*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_DEP_RES;\n\t*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_RES;\n\t*(u8 *)skb_push(skb, 1) = skb->len;\n\n\tr = nfc_hci_send_event(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\tST21NFCA_EVT_SEND_DATA, skb->data, skb->len);\n\tkfree_skb(skb);\n\n\treturn r;\n}\nEXPORT_SYMBOL(st21nfca_tm_send_dep_res);\n\nstatic int st21nfca_tm_recv_dep_req(struct nfc_hci_dev *hdev,\n\t\t\t\t    struct sk_buff *skb)\n{\n\tstruct st21nfca_dep_req_res *dep_req;\n\tu8 size;\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tskb_trim(skb, skb->len - 1);\n\n\tsize = 4;\n\n\tdep_req = (struct st21nfca_dep_req_res *)skb->data;\n\tif (skb->len < size)\n\t\treturn -EIO;\n\n\tif (ST21NFCA_NFC_DEP_DID_BIT_SET(dep_req->pfb))\n\t\tsize++;\n\tif (ST21NFCA_NFC_DEP_NAD_BIT_SET(dep_req->pfb))\n\t\tsize++;\n\n\tif (skb->len < size)\n\t\treturn -EIO;\n\n\t \n\tswitch (ST21NFCA_NFC_DEP_PFB_TYPE(dep_req->pfb)) {\n\tcase ST21NFCA_NFC_DEP_PFB_I_PDU:\n\t\tinfo->dep_info.curr_nfc_dep_pni =\n\t\t\t\tST21NFCA_NFC_DEP_PFB_PNI(dep_req->pfb);\n\t\tbreak;\n\tcase ST21NFCA_NFC_DEP_PFB_ACK_NACK_PDU:\n\t\tpr_err(\"Received a ACK/NACK PDU\\n\");\n\t\tbreak;\n\tcase ST21NFCA_NFC_DEP_PFB_SUPERVISOR_PDU:\n\t\tpr_err(\"Received a SUPERVISOR PDU\\n\");\n\t\tbreak;\n\t}\n\n\tskb_pull(skb, size);\n\n\treturn nfc_tm_data_received(hdev->ndev, skb);\n}\n\nstatic int st21nfca_tm_event_send_data(struct nfc_hci_dev *hdev,\n\t\t\t\tstruct sk_buff *skb)\n{\n\tu8 cmd0, cmd1;\n\tint r;\n\n\tcmd0 = skb->data[1];\n\tswitch (cmd0) {\n\tcase ST21NFCA_NFCIP1_REQ:\n\t\tcmd1 = skb->data[2];\n\t\tswitch (cmd1) {\n\t\tcase ST21NFCA_NFCIP1_ATR_REQ:\n\t\t\tr = st21nfca_tm_recv_atr_req(hdev, skb);\n\t\t\tbreak;\n\t\tcase ST21NFCA_NFCIP1_PSL_REQ:\n\t\t\tr = st21nfca_tm_recv_psl_req(hdev, skb);\n\t\t\tbreak;\n\t\tcase ST21NFCA_NFCIP1_DEP_REQ:\n\t\t\tr = st21nfca_tm_recv_dep_req(hdev, skb);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn 1;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn 1;\n\t}\n\treturn r;\n}\n\n \nint st21nfca_dep_event_received(struct nfc_hci_dev *hdev,\n\t\t\t\tu8 event, struct sk_buff *skb)\n{\n\tint r = 0;\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tpr_debug(\"dep event: %d\\n\", event);\n\n\tswitch (event) {\n\tcase ST21NFCA_EVT_CARD_ACTIVATED:\n\t\tinfo->dep_info.curr_nfc_dep_pni = 0;\n\t\tbreak;\n\tcase ST21NFCA_EVT_CARD_DEACTIVATED:\n\t\tbreak;\n\tcase ST21NFCA_EVT_FIELD_ON:\n\t\tbreak;\n\tcase ST21NFCA_EVT_FIELD_OFF:\n\t\tbreak;\n\tcase ST21NFCA_EVT_SEND_DATA:\n\t\tr = st21nfca_tm_event_send_data(hdev, skb);\n\t\tif (r < 0)\n\t\t\treturn r;\n\t\treturn 0;\n\tdefault:\n\t\tnfc_err(&hdev->ndev->dev, \"Unexpected event on card f gate\\n\");\n\t\treturn 1;\n\t}\n\tkfree_skb(skb);\n\treturn r;\n}\nEXPORT_SYMBOL(st21nfca_dep_event_received);\n\nstatic void st21nfca_im_send_psl_req(struct nfc_hci_dev *hdev, u8 did, u8 bsi,\n\t\t\t\t     u8 bri, u8 lri)\n{\n\tstruct sk_buff *skb;\n\tstruct st21nfca_psl_req *psl_req;\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tskb =\n\t    alloc_skb(sizeof(struct st21nfca_psl_req) + 1, GFP_KERNEL);\n\tif (!skb)\n\t\treturn;\n\tskb_reserve(skb, 1);\n\n\tskb_put(skb, sizeof(struct st21nfca_psl_req));\n\tpsl_req = (struct st21nfca_psl_req *) skb->data;\n\n\tpsl_req->length = sizeof(struct st21nfca_psl_req);\n\tpsl_req->cmd0 = ST21NFCA_NFCIP1_REQ;\n\tpsl_req->cmd1 = ST21NFCA_NFCIP1_PSL_REQ;\n\tpsl_req->did = did;\n\tpsl_req->brs = (0x30 & bsi << 4) | (bri & 0x03);\n\tpsl_req->fsl = lri;\n\n\t*(u8 *)skb_push(skb, 1) = info->dep_info.to | 0x10;\n\n\tst21nfca_im_send_pdu(info, skb);\n}\n\n#define ST21NFCA_CB_TYPE_READER_F 1\nstatic void st21nfca_im_recv_atr_res_cb(void *context, struct sk_buff *skb,\n\t\t\t\t\tint err)\n{\n\tstruct st21nfca_hci_info *info = context;\n\tstruct st21nfca_atr_res *atr_res;\n\tint r;\n\n\tif (err != 0)\n\t\treturn;\n\n\tif (!skb)\n\t\treturn;\n\n\tswitch (info->async_cb_type) {\n\tcase ST21NFCA_CB_TYPE_READER_F:\n\t\tskb_trim(skb, skb->len - 1);\n\t\tatr_res = (struct st21nfca_atr_res *)skb->data;\n\t\tr = nfc_set_remote_general_bytes(info->hdev->ndev,\n\t\t\t\tatr_res->gbi,\n\t\t\t\tskb->len - sizeof(struct st21nfca_atr_res));\n\t\tif (r < 0)\n\t\t\treturn;\n\n\t\tif (atr_res->to >= 0x0e)\n\t\t\tinfo->dep_info.to = 0x0e;\n\t\telse\n\t\t\tinfo->dep_info.to = atr_res->to + 1;\n\n\t\tinfo->dep_info.to |= 0x10;\n\n\t\tr = nfc_dep_link_is_up(info->hdev->ndev, info->dep_info.idx,\n\t\t\t\t\tNFC_COMM_PASSIVE, NFC_RF_INITIATOR);\n\t\tif (r < 0)\n\t\t\treturn;\n\n\t\tinfo->dep_info.curr_nfc_dep_pni = 0;\n\t\tif (ST21NFCA_PP2LRI(atr_res->ppi) != info->dep_info.lri)\n\t\t\tst21nfca_im_send_psl_req(info->hdev, atr_res->did,\n\t\t\t\t\t\tatr_res->bsi, atr_res->bri,\n\t\t\t\t\t\tST21NFCA_PP2LRI(atr_res->ppi));\n\t\tbreak;\n\tdefault:\n\t\tkfree_skb(skb);\n\t\tbreak;\n\t}\n}\n\nint st21nfca_im_send_atr_req(struct nfc_hci_dev *hdev, u8 *gb, size_t gb_len)\n{\n\tstruct sk_buff *skb;\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\tstruct st21nfca_atr_req *atr_req;\n\tstruct nfc_target *target;\n\tuint size;\n\n\tinfo->dep_info.to = ST21NFCA_DEFAULT_TIMEOUT;\n\tsize = ST21NFCA_ATR_REQ_MIN_SIZE + gb_len;\n\tif (size > ST21NFCA_ATR_REQ_MAX_SIZE) {\n\t\tPROTOCOL_ERR(\"14.6.1.1\");\n\t\treturn -EINVAL;\n\t}\n\n\tskb =\n\t    alloc_skb(sizeof(struct st21nfca_atr_req) + gb_len + 1, GFP_KERNEL);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tskb_reserve(skb, 1);\n\n\tskb_put(skb, sizeof(struct st21nfca_atr_req));\n\n\tatr_req = (struct st21nfca_atr_req *)skb->data;\n\tmemset(atr_req, 0, sizeof(struct st21nfca_atr_req));\n\n\tatr_req->cmd0 = ST21NFCA_NFCIP1_REQ;\n\tatr_req->cmd1 = ST21NFCA_NFCIP1_ATR_REQ;\n\tmemset(atr_req->nfcid3, 0, NFC_NFCID3_MAXSIZE);\n\ttarget = hdev->ndev->targets;\n\n\tif (target->sensf_res_len > 0)\n\t\tmemcpy(atr_req->nfcid3, target->sensf_res,\n\t\t\t\ttarget->sensf_res_len);\n\telse\n\t\tget_random_bytes(atr_req->nfcid3, NFC_NFCID3_MAXSIZE);\n\n\tatr_req->did = 0x0;\n\n\tatr_req->bsi = 0x00;\n\tatr_req->bri = 0x00;\n\tatr_req->ppi = ST21NFCA_LR_BITS_PAYLOAD_SIZE_254B;\n\tif (gb_len) {\n\t\tatr_req->ppi |= ST21NFCA_GB_BIT;\n\t\tskb_put_data(skb, gb, gb_len);\n\t}\n\tatr_req->length = sizeof(struct st21nfca_atr_req) + hdev->gb_len;\n\n\t*(u8 *)skb_push(skb, 1) = info->dep_info.to | 0x10;  \n\n\tinfo->async_cb_type = ST21NFCA_CB_TYPE_READER_F;\n\tinfo->async_cb_context = info;\n\tinfo->async_cb = st21nfca_im_recv_atr_res_cb;\n\tinfo->dep_info.bri = atr_req->bri;\n\tinfo->dep_info.bsi = atr_req->bsi;\n\tinfo->dep_info.lri = ST21NFCA_PP2LRI(atr_req->ppi);\n\n\treturn nfc_hci_send_cmd_async(hdev, ST21NFCA_RF_READER_F_GATE,\n\t\t\t\tST21NFCA_WR_XCHG_DATA, skb->data,\n\t\t\t\tskb->len, info->async_cb, info);\n}\nEXPORT_SYMBOL(st21nfca_im_send_atr_req);\n\nstatic void st21nfca_im_recv_dep_res_cb(void *context, struct sk_buff *skb,\n\t\t\t\t\tint err)\n{\n\tstruct st21nfca_hci_info *info = context;\n\tstruct st21nfca_dep_req_res *dep_res;\n\n\tint size;\n\n\tif (err != 0)\n\t\treturn;\n\n\tif (!skb)\n\t\treturn;\n\n\tswitch (info->async_cb_type) {\n\tcase ST21NFCA_CB_TYPE_READER_F:\n\t\tdep_res = (struct st21nfca_dep_req_res *)skb->data;\n\n\t\tsize = 3;\n\t\tif (skb->len < size)\n\t\t\tgoto exit;\n\n\t\tif (ST21NFCA_NFC_DEP_DID_BIT_SET(dep_res->pfb))\n\t\t\tsize++;\n\t\tif (ST21NFCA_NFC_DEP_NAD_BIT_SET(dep_res->pfb))\n\t\t\tsize++;\n\n\t\tif (skb->len < size)\n\t\t\tgoto exit;\n\n\t\tskb_trim(skb, skb->len - 1);\n\n\t\t \n\t\tswitch (ST21NFCA_NFC_DEP_PFB_TYPE(dep_res->pfb)) {\n\t\tcase ST21NFCA_NFC_DEP_PFB_ACK_NACK_PDU:\n\t\t\tpr_err(\"Received a ACK/NACK PDU\\n\");\n\t\t\tfallthrough;\n\t\tcase ST21NFCA_NFC_DEP_PFB_I_PDU:\n\t\t\tinfo->dep_info.curr_nfc_dep_pni =\n\t\t\t    ST21NFCA_NFC_DEP_PFB_PNI(dep_res->pfb + 1);\n\t\t\tsize++;\n\t\t\tskb_pull(skb, size);\n\t\t\tnfc_tm_data_received(info->hdev->ndev, skb);\n\t\t\tbreak;\n\t\tcase ST21NFCA_NFC_DEP_PFB_SUPERVISOR_PDU:\n\t\t\tpr_err(\"Received a SUPERVISOR PDU\\n\");\n\t\t\tskb_pull(skb, size);\n\t\t\t*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_DEP_REQ;\n\t\t\t*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_REQ;\n\t\t\t*(u8 *)skb_push(skb, 1) = skb->len;\n\t\t\t*(u8 *)skb_push(skb, 1) = info->dep_info.to | 0x10;\n\n\t\t\tst21nfca_im_send_pdu(info, skb);\n\t\t\tbreak;\n\t\t}\n\n\t\treturn;\n\tdefault:\n\t\tbreak;\n\t}\n\nexit:\n\tkfree_skb(skb);\n}\n\nint st21nfca_im_send_dep_req(struct nfc_hci_dev *hdev, struct sk_buff *skb)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tinfo->async_cb_type = ST21NFCA_CB_TYPE_READER_F;\n\tinfo->async_cb_context = info;\n\tinfo->async_cb = st21nfca_im_recv_dep_res_cb;\n\n\t*(u8 *)skb_push(skb, 1) = info->dep_info.curr_nfc_dep_pni;\n\t*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_DEP_REQ;\n\t*(u8 *)skb_push(skb, 1) = ST21NFCA_NFCIP1_REQ;\n\t*(u8 *)skb_push(skb, 1) = skb->len;\n\n\t*(u8 *)skb_push(skb, 1) = info->dep_info.to | 0x10;\n\n\treturn nfc_hci_send_cmd_async(hdev, ST21NFCA_RF_READER_F_GATE,\n\t\t\t\t      ST21NFCA_WR_XCHG_DATA,\n\t\t\t\t      skb->data, skb->len,\n\t\t\t\t      info->async_cb, info);\n}\nEXPORT_SYMBOL(st21nfca_im_send_dep_req);\n\nvoid st21nfca_dep_init(struct nfc_hci_dev *hdev)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tINIT_WORK(&info->dep_info.tx_work, st21nfca_tx_work);\n\tinfo->dep_info.curr_nfc_dep_pni = 0;\n\tinfo->dep_info.idx = 0;\n\tinfo->dep_info.to = ST21NFCA_DEFAULT_TIMEOUT;\n}\nEXPORT_SYMBOL(st21nfca_dep_init);\n\nvoid st21nfca_dep_deinit(struct nfc_hci_dev *hdev)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tcancel_work_sync(&info->dep_info.tx_work);\n}\nEXPORT_SYMBOL(st21nfca_dep_deinit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}