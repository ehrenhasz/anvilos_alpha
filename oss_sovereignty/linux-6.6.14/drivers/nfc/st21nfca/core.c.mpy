{
  "module_name": "core.c",
  "hash_id": "ed4042b685cd96d4518fcbe75ed2f3c8e890e5d5558376361708c7b1d3d1727f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nfc/st21nfca/core.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/nfc.h>\n#include <net/nfc/hci.h>\n\n#include \"st21nfca.h\"\n\n#define DRIVER_DESC \"HCI NFC driver for ST21NFCA\"\n\n#define FULL_VERSION_LEN 3\n\n \n\n \n#define ST21NFCA_RF_READER_CMD_PRESENCE_CHECK\t0x30\n\n#define ST21NFCA_RF_READER_ISO15693_GATE\t0x12\n#define ST21NFCA_RF_READER_ISO15693_INVENTORY\t0x01\n\n \n#define ST21NFCA_RF_READER_14443_3_A_GATE\t0x15\n#define ST21NFCA_RF_READER_14443_3_A_UID\t0x02\n#define ST21NFCA_RF_READER_14443_3_A_ATQA\t0x03\n#define ST21NFCA_RF_READER_14443_3_A_SAK\t0x04\n\n#define ST21NFCA_RF_READER_F_DATARATE\t\t0x01\n#define ST21NFCA_RF_READER_F_DATARATE_106\t0x01\n#define ST21NFCA_RF_READER_F_DATARATE_212\t0x02\n#define ST21NFCA_RF_READER_F_DATARATE_424\t0x04\n#define ST21NFCA_RF_READER_F_POL_REQ\t\t0x02\n#define ST21NFCA_RF_READER_F_POL_REQ_DEFAULT\t0xffff0000\n#define ST21NFCA_RF_READER_F_NFCID2\t\t0x03\n#define ST21NFCA_RF_READER_F_NFCID1\t\t0x04\n\n#define ST21NFCA_RF_CARD_F_MODE\t\t\t0x01\n#define ST21NFCA_RF_CARD_F_NFCID2_LIST\t\t0x04\n#define ST21NFCA_RF_CARD_F_NFCID1\t\t0x05\n#define ST21NFCA_RF_CARD_F_SENS_RES\t\t0x06\n#define ST21NFCA_RF_CARD_F_SEL_RES\t\t0x07\n#define ST21NFCA_RF_CARD_F_DATARATE\t\t0x08\n#define ST21NFCA_RF_CARD_F_DATARATE_212_424\t0x01\n\n#define ST21NFCA_DEVICE_MGNT_PIPE\t\t0x02\n\n#define ST21NFCA_DM_GETINFO\t\t\t0x13\n#define ST21NFCA_DM_GETINFO_PIPE_LIST\t\t0x02\n#define ST21NFCA_DM_GETINFO_PIPE_INFO\t\t0x01\n#define ST21NFCA_DM_PIPE_CREATED\t\t0x02\n#define ST21NFCA_DM_PIPE_OPEN\t\t\t0x04\n#define ST21NFCA_DM_RF_ACTIVE\t\t\t0x80\n#define ST21NFCA_DM_DISCONNECT\t\t\t0x30\n\n#define ST21NFCA_DM_IS_PIPE_OPEN(p) \\\n\t((p & 0x0f) == (ST21NFCA_DM_PIPE_CREATED | ST21NFCA_DM_PIPE_OPEN))\n\n#define ST21NFCA_NFC_MODE\t\t\t0x03\t \n\n#define ST21NFCA_EVT_HOT_PLUG\t\t\t0x03\n#define ST21NFCA_EVT_HOT_PLUG_IS_INHIBITED(x) (x->data[0] & 0x80)\n\n#define ST21NFCA_SE_TO_PIPES\t\t\t2000\n\nstatic DECLARE_BITMAP(dev_mask, ST21NFCA_NUM_DEVICES);\n\nstatic const struct nfc_hci_gate st21nfca_gates[] = {\n\t{NFC_HCI_ADMIN_GATE, NFC_HCI_ADMIN_PIPE},\n\t{NFC_HCI_LINK_MGMT_GATE, NFC_HCI_LINK_MGMT_PIPE},\n\t{ST21NFCA_DEVICE_MGNT_GATE, ST21NFCA_DEVICE_MGNT_PIPE},\n\n\t{NFC_HCI_LOOPBACK_GATE, NFC_HCI_INVALID_PIPE},\n\t{NFC_HCI_ID_MGMT_GATE, NFC_HCI_INVALID_PIPE},\n\t{NFC_HCI_RF_READER_B_GATE, NFC_HCI_INVALID_PIPE},\n\t{NFC_HCI_RF_READER_A_GATE, NFC_HCI_INVALID_PIPE},\n\t{ST21NFCA_RF_READER_F_GATE, NFC_HCI_INVALID_PIPE},\n\t{ST21NFCA_RF_READER_14443_3_A_GATE, NFC_HCI_INVALID_PIPE},\n\t{ST21NFCA_RF_READER_ISO15693_GATE, NFC_HCI_INVALID_PIPE},\n\t{ST21NFCA_RF_CARD_F_GATE, NFC_HCI_INVALID_PIPE},\n\n\t \n\t{ST21NFCA_CONNECTIVITY_GATE, NFC_HCI_DO_NOT_CREATE_PIPE},\n\t{ST21NFCA_APDU_READER_GATE, NFC_HCI_DO_NOT_CREATE_PIPE},\n};\n\nstruct st21nfca_pipe_info {\n\tu8 pipe_state;\n\tu8 src_host_id;\n\tu8 src_gate_id;\n\tu8 dst_host_id;\n\tu8 dst_gate_id;\n} __packed;\n\n \n#define ST21NFCA_CMDS_HEADROOM  7\n\nstatic int st21nfca_hci_load_session(struct nfc_hci_dev *hdev)\n{\n\tint i, j, r;\n\tstruct sk_buff *skb_pipe_list, *skb_pipe_info;\n\tstruct st21nfca_pipe_info *info;\n\n\tu8 pipe_list[] = { ST21NFCA_DM_GETINFO_PIPE_LIST,\n\t\tNFC_HCI_TERMINAL_HOST_ID\n\t};\n\tu8 pipe_info[] = { ST21NFCA_DM_GETINFO_PIPE_INFO,\n\t\tNFC_HCI_TERMINAL_HOST_ID, 0\n\t};\n\n\t \n\tr = nfc_hci_connect_gate(hdev, NFC_HCI_HOST_CONTROLLER_ID,\n\t\t\t\tST21NFCA_DEVICE_MGNT_GATE,\n\t\t\t\tST21NFCA_DEVICE_MGNT_PIPE);\n\tif (r < 0)\n\t\treturn r;\n\n\t \n\tr = nfc_hci_send_cmd(hdev, ST21NFCA_DEVICE_MGNT_GATE,\n\t\t\tST21NFCA_DM_GETINFO, pipe_list, sizeof(pipe_list),\n\t\t\t&skb_pipe_list);\n\tif (r < 0)\n\t\treturn r;\n\n\t \n\tfor (i = 0; i < skb_pipe_list->len; i++) {\n\t\tpipe_info[2] = skb_pipe_list->data[i];\n\t\tr = nfc_hci_send_cmd(hdev, ST21NFCA_DEVICE_MGNT_GATE,\n\t\t\t\t\tST21NFCA_DM_GETINFO, pipe_info,\n\t\t\t\t\tsizeof(pipe_info), &skb_pipe_info);\n\t\tif (r)\n\t\t\tcontinue;\n\n\t\t \n\t\tinfo = (struct st21nfca_pipe_info *) skb_pipe_info->data;\n\t\tif (info->dst_gate_id == ST21NFCA_APDU_READER_GATE &&\n\t\t\tinfo->src_host_id == NFC_HCI_UICC_HOST_ID) {\n\t\t\tpr_err(\"Unexpected apdu_reader pipe on host %x\\n\",\n\t\t\t\tinfo->src_host_id);\n\t\t\tkfree_skb(skb_pipe_info);\n\t\t\tcontinue;\n\t\t}\n\n\t\tfor (j = 3; (j < ARRAY_SIZE(st21nfca_gates)) &&\n\t\t\t(st21nfca_gates[j].gate != info->dst_gate_id) ; j++)\n\t\t\t;\n\n\t\tif (j < ARRAY_SIZE(st21nfca_gates) &&\n\t\t\tst21nfca_gates[j].gate == info->dst_gate_id &&\n\t\t\tST21NFCA_DM_IS_PIPE_OPEN(info->pipe_state)) {\n\t\t\thdev->init_data.gates[j].pipe = pipe_info[2];\n\n\t\t\thdev->gate2pipe[st21nfca_gates[j].gate] =\n\t\t\t\t\t\tpipe_info[2];\n\t\t\thdev->pipes[pipe_info[2]].gate =\n\t\t\t\t\t\tst21nfca_gates[j].gate;\n\t\t\thdev->pipes[pipe_info[2]].dest_host =\n\t\t\t\t\t\tinfo->src_host_id;\n\t\t}\n\t\tkfree_skb(skb_pipe_info);\n\t}\n\n\t \n\tr = nfc_hci_connect_gate(hdev, NFC_HCI_HOST_CONTROLLER_ID,\n\t\t\t\t NFC_HCI_LINK_MGMT_GATE,\n\t\t\t\t NFC_HCI_LINK_MGMT_PIPE);\n\n\tkfree_skb(skb_pipe_list);\n\treturn r;\n}\n\nstatic int st21nfca_hci_open(struct nfc_hci_dev *hdev)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\tint r;\n\n\tmutex_lock(&info->info_lock);\n\n\tif (info->state != ST21NFCA_ST_COLD) {\n\t\tr = -EBUSY;\n\t\tgoto out;\n\t}\n\n\tr = info->phy_ops->enable(info->phy_id);\n\n\tif (r == 0)\n\t\tinfo->state = ST21NFCA_ST_READY;\n\nout:\n\tmutex_unlock(&info->info_lock);\n\treturn r;\n}\n\nstatic void st21nfca_hci_close(struct nfc_hci_dev *hdev)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tmutex_lock(&info->info_lock);\n\n\tif (info->state == ST21NFCA_ST_COLD)\n\t\tgoto out;\n\n\tinfo->phy_ops->disable(info->phy_id);\n\tinfo->state = ST21NFCA_ST_COLD;\n\nout:\n\tmutex_unlock(&info->info_lock);\n}\n\nstatic int st21nfca_hci_ready(struct nfc_hci_dev *hdev)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\tstruct sk_buff *skb;\n\n\tu8 param;\n\tu8 white_list[2];\n\tint wl_size = 0;\n\tint r;\n\n\tif (info->se_status->is_uicc_present)\n\t\twhite_list[wl_size++] = NFC_HCI_UICC_HOST_ID;\n\tif (info->se_status->is_ese_present)\n\t\twhite_list[wl_size++] = ST21NFCA_ESE_HOST_ID;\n\n\tif (wl_size) {\n\t\tr = nfc_hci_set_param(hdev, NFC_HCI_ADMIN_GATE,\n\t\t\t\t\tNFC_HCI_ADMIN_WHITELIST,\n\t\t\t\t\t(u8 *) &white_list, wl_size);\n\t\tif (r < 0)\n\t\t\treturn r;\n\t}\n\n\t \n\tr = nfc_hci_get_param(hdev, ST21NFCA_DEVICE_MGNT_GATE,\n\t\t\t      ST21NFCA_NFC_MODE, &skb);\n\tif (r < 0)\n\t\treturn r;\n\n\tparam = skb->data[0];\n\tkfree_skb(skb);\n\tif (param == 0) {\n\t\tparam = 1;\n\n\t\tr = nfc_hci_set_param(hdev, ST21NFCA_DEVICE_MGNT_GATE,\n\t\t\t\t\tST21NFCA_NFC_MODE, &param, 1);\n\t\tif (r < 0)\n\t\t\treturn r;\n\t}\n\n\tr = nfc_hci_send_event(hdev, NFC_HCI_RF_READER_A_GATE,\n\t\t\t       NFC_HCI_EVT_END_OPERATION, NULL, 0);\n\tif (r < 0)\n\t\treturn r;\n\n\tr = nfc_hci_get_param(hdev, NFC_HCI_ID_MGMT_GATE,\n\t\t\t      NFC_HCI_ID_MGMT_VERSION_SW, &skb);\n\tif (r < 0)\n\t\treturn r;\n\n\tif (skb->len != FULL_VERSION_LEN) {\n\t\tkfree_skb(skb);\n\t\treturn -EINVAL;\n\t}\n\n\tprint_hex_dump(KERN_DEBUG, \"FULL VERSION SOFTWARE INFO: \",\n\t\t       DUMP_PREFIX_NONE, 16, 1,\n\t\t       skb->data, FULL_VERSION_LEN, false);\n\n\tkfree_skb(skb);\n\n\treturn 0;\n}\n\nstatic int st21nfca_hci_xmit(struct nfc_hci_dev *hdev, struct sk_buff *skb)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\treturn info->phy_ops->write(info->phy_id, skb);\n}\n\nstatic int st21nfca_hci_start_poll(struct nfc_hci_dev *hdev,\n\t\t\t\t   u32 im_protocols, u32 tm_protocols)\n{\n\tint r;\n\tu32 pol_req;\n\tu8 param[19];\n\tstruct sk_buff *datarate_skb;\n\n\tpr_info(DRIVER_DESC \": %s protocols 0x%x 0x%x\\n\",\n\t\t__func__, im_protocols, tm_protocols);\n\n\tr = nfc_hci_send_event(hdev, NFC_HCI_RF_READER_A_GATE,\n\t\t\t       NFC_HCI_EVT_END_OPERATION, NULL, 0);\n\tif (r < 0)\n\t\treturn r;\n\tif (im_protocols) {\n\t\t \n\t\tif ((NFC_HCI_RF_READER_B_GATE & im_protocols) == 0) {\n\t\t\tr = nfc_hci_disconnect_gate(hdev,\n\t\t\t\t\tNFC_HCI_RF_READER_B_GATE);\n\t\t\tif (r < 0)\n\t\t\t\treturn r;\n\t\t}\n\n\t\tif ((NFC_HCI_RF_READER_A_GATE & im_protocols) == 0) {\n\t\t\tr = nfc_hci_disconnect_gate(hdev,\n\t\t\t\t\tNFC_HCI_RF_READER_A_GATE);\n\t\t\tif (r < 0)\n\t\t\t\treturn r;\n\t\t}\n\n\t\tif ((ST21NFCA_RF_READER_F_GATE & im_protocols) == 0) {\n\t\t\tr = nfc_hci_disconnect_gate(hdev,\n\t\t\t\t\tST21NFCA_RF_READER_F_GATE);\n\t\t\tif (r < 0)\n\t\t\t\treturn r;\n\t\t} else {\n\t\t\thdev->gb = nfc_get_local_general_bytes(hdev->ndev,\n\t\t\t\t\t\t\t       &hdev->gb_len);\n\n\t\t\tif (hdev->gb == NULL || hdev->gb_len == 0) {\n\t\t\t\tim_protocols &= ~NFC_PROTO_NFC_DEP_MASK;\n\t\t\t\ttm_protocols &= ~NFC_PROTO_NFC_DEP_MASK;\n\t\t\t}\n\n\t\t\tparam[0] = ST21NFCA_RF_READER_F_DATARATE_106 |\n\t\t\t    ST21NFCA_RF_READER_F_DATARATE_212 |\n\t\t\t    ST21NFCA_RF_READER_F_DATARATE_424;\n\t\t\tr = nfc_hci_set_param(hdev, ST21NFCA_RF_READER_F_GATE,\n\t\t\t\t\t      ST21NFCA_RF_READER_F_DATARATE,\n\t\t\t\t\t      param, 1);\n\t\t\tif (r < 0)\n\t\t\t\treturn r;\n\n\t\t\tpol_req = be32_to_cpu((__force __be32)\n\t\t\t\t\tST21NFCA_RF_READER_F_POL_REQ_DEFAULT);\n\t\t\tr = nfc_hci_set_param(hdev, ST21NFCA_RF_READER_F_GATE,\n\t\t\t\t\t      ST21NFCA_RF_READER_F_POL_REQ,\n\t\t\t\t\t      (u8 *) &pol_req, 4);\n\t\t\tif (r < 0)\n\t\t\t\treturn r;\n\t\t}\n\n\t\tif ((ST21NFCA_RF_READER_14443_3_A_GATE & im_protocols) == 0) {\n\t\t\tr = nfc_hci_disconnect_gate(hdev,\n\t\t\t\t\tST21NFCA_RF_READER_14443_3_A_GATE);\n\t\t\tif (r < 0)\n\t\t\t\treturn r;\n\t\t}\n\n\t\tif ((ST21NFCA_RF_READER_ISO15693_GATE & im_protocols) == 0) {\n\t\t\tr = nfc_hci_disconnect_gate(hdev,\n\t\t\t\t\tST21NFCA_RF_READER_ISO15693_GATE);\n\t\t\tif (r < 0)\n\t\t\t\treturn r;\n\t\t}\n\n\t\tr = nfc_hci_send_event(hdev, NFC_HCI_RF_READER_A_GATE,\n\t\t\t\t       NFC_HCI_EVT_READER_REQUESTED, NULL, 0);\n\t\tif (r < 0)\n\t\t\tnfc_hci_send_event(hdev, NFC_HCI_RF_READER_A_GATE,\n\t\t\t\t\t   NFC_HCI_EVT_END_OPERATION, NULL, 0);\n\t}\n\n\tif (tm_protocols & NFC_PROTO_NFC_DEP_MASK) {\n\t\tr = nfc_hci_get_param(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\t\t      ST21NFCA_RF_CARD_F_DATARATE,\n\t\t\t\t      &datarate_skb);\n\t\tif (r < 0)\n\t\t\treturn r;\n\n\t\t \n\t\tif (datarate_skb->len > 0 &&\n\t\t    datarate_skb->data[0] !=\n\t\t    ST21NFCA_RF_CARD_F_DATARATE_212_424) {\n\t\t\tparam[0] = ST21NFCA_RF_CARD_F_DATARATE_212_424;\n\t\t\tr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\t\t\t      ST21NFCA_RF_CARD_F_DATARATE,\n\t\t\t\t\t      param, 1);\n\t\t\tif (r < 0) {\n\t\t\t\tkfree_skb(datarate_skb);\n\t\t\t\treturn r;\n\t\t\t}\n\t\t}\n\t\tkfree_skb(datarate_skb);\n\n\t\t \n\t\tparam[0] = 0x00;\n\t\tparam[1] = 0x08;\n\t\tr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\t\t      ST21NFCA_RF_CARD_F_SENS_RES, param, 2);\n\t\tif (r < 0)\n\t\t\treturn r;\n\n\t\t \n\t\tparam[0] = 0x40;\n\t\tr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\t\t      ST21NFCA_RF_CARD_F_SEL_RES, param, 1);\n\t\tif (r < 0)\n\t\t\treturn r;\n\n\t\t \n\t\tr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\t\t      ST21NFCA_RF_CARD_F_NFCID1, NULL, 0);\n\t\tif (r < 0)\n\t\t\treturn r;\n\n\t\t \n\t\t \n\t\tparam[0] = 0x00;\n\t\tparam[1] = 0x00;\n\t\t \n\t\tparam[2] = 0x01;\n\t\tparam[3] = 0xfe;\n\t\tparam[4] = 'S';\n\t\tparam[5] = 'T';\n\t\tparam[6] = 'M';\n\t\tparam[7] = 'i';\n\t\tparam[8] = 'c';\n\t\tparam[9] = 'r';\n\t\t \n\n\t\t \n\t\tparam[18] = 0x01;\n\t\tr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\t\t      ST21NFCA_RF_CARD_F_NFCID2_LIST, param,\n\t\t\t\t      19);\n\t\tif (r < 0)\n\t\t\treturn r;\n\n\t\tparam[0] = 0x02;\n\t\tr = nfc_hci_set_param(hdev, ST21NFCA_RF_CARD_F_GATE,\n\t\t\t\t      ST21NFCA_RF_CARD_F_MODE, param, 1);\n\t}\n\n\treturn r;\n}\n\nstatic void st21nfca_hci_stop_poll(struct nfc_hci_dev *hdev)\n{\n\tnfc_hci_send_cmd(hdev, ST21NFCA_DEVICE_MGNT_GATE,\n\t\t\tST21NFCA_DM_DISCONNECT, NULL, 0, NULL);\n}\n\nstatic int st21nfca_get_iso14443_3_atqa(struct nfc_hci_dev *hdev, u16 *atqa)\n{\n\tint r;\n\tstruct sk_buff *atqa_skb = NULL;\n\n\tr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_14443_3_A_GATE,\n\t\t\t      ST21NFCA_RF_READER_14443_3_A_ATQA, &atqa_skb);\n\tif (r < 0)\n\t\tgoto exit;\n\n\tif (atqa_skb->len != 2) {\n\t\tr = -EPROTO;\n\t\tgoto exit;\n\t}\n\n\t*atqa = be16_to_cpu(*(__be16 *) atqa_skb->data);\n\nexit:\n\tkfree_skb(atqa_skb);\n\treturn r;\n}\n\nstatic int st21nfca_get_iso14443_3_sak(struct nfc_hci_dev *hdev, u8 *sak)\n{\n\tint r;\n\tstruct sk_buff *sak_skb = NULL;\n\n\tr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_14443_3_A_GATE,\n\t\t\t      ST21NFCA_RF_READER_14443_3_A_SAK, &sak_skb);\n\tif (r < 0)\n\t\tgoto exit;\n\n\tif (sak_skb->len != 1) {\n\t\tr = -EPROTO;\n\t\tgoto exit;\n\t}\n\n\t*sak = sak_skb->data[0];\n\nexit:\n\tkfree_skb(sak_skb);\n\treturn r;\n}\n\nstatic int st21nfca_get_iso14443_3_uid(struct nfc_hci_dev *hdev, u8 *uid,\n\t\t\t\t       int *len)\n{\n\tint r;\n\tstruct sk_buff *uid_skb = NULL;\n\n\tr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_14443_3_A_GATE,\n\t\t\t      ST21NFCA_RF_READER_14443_3_A_UID, &uid_skb);\n\tif (r < 0)\n\t\tgoto exit;\n\n\tif (uid_skb->len == 0 || uid_skb->len > NFC_NFCID1_MAXSIZE) {\n\t\tr = -EPROTO;\n\t\tgoto exit;\n\t}\n\n\tmemcpy(uid, uid_skb->data, uid_skb->len);\n\t*len = uid_skb->len;\nexit:\n\tkfree_skb(uid_skb);\n\treturn r;\n}\n\nstatic int st21nfca_get_iso15693_inventory(struct nfc_hci_dev *hdev,\n\t\t\t\t\t   struct nfc_target *target)\n{\n\tint r;\n\tstruct sk_buff *inventory_skb = NULL;\n\n\tr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_ISO15693_GATE,\n\t\t\t      ST21NFCA_RF_READER_ISO15693_INVENTORY,\n\t\t\t      &inventory_skb);\n\tif (r < 0)\n\t\tgoto exit;\n\n\tskb_pull(inventory_skb, 2);\n\n\tif (inventory_skb->len == 0 ||\n\t    inventory_skb->len > NFC_ISO15693_UID_MAXSIZE) {\n\t\tr = -EPROTO;\n\t\tgoto exit;\n\t}\n\n\tmemcpy(target->iso15693_uid, inventory_skb->data, inventory_skb->len);\n\ttarget->iso15693_dsfid\t= inventory_skb->data[1];\n\ttarget->is_iso15693 = 1;\nexit:\n\tkfree_skb(inventory_skb);\n\treturn r;\n}\n\nstatic int st21nfca_hci_dep_link_up(struct nfc_hci_dev *hdev,\n\t\t\t\t    struct nfc_target *target, u8 comm_mode,\n\t\t\t\t    u8 *gb, size_t gb_len)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tinfo->dep_info.idx = target->idx;\n\treturn st21nfca_im_send_atr_req(hdev, gb, gb_len);\n}\n\nstatic int st21nfca_hci_dep_link_down(struct nfc_hci_dev *hdev)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tinfo->state = ST21NFCA_ST_READY;\n\n\treturn nfc_hci_send_cmd(hdev, ST21NFCA_DEVICE_MGNT_GATE,\n\t\t\t\tST21NFCA_DM_DISCONNECT, NULL, 0, NULL);\n}\n\nstatic int st21nfca_hci_target_from_gate(struct nfc_hci_dev *hdev, u8 gate,\n\t\t\t\t\t struct nfc_target *target)\n{\n\tint r, len;\n\tu16 atqa;\n\tu8 sak;\n\tu8 uid[NFC_NFCID1_MAXSIZE];\n\n\tswitch (gate) {\n\tcase ST21NFCA_RF_READER_F_GATE:\n\t\ttarget->supported_protocols = NFC_PROTO_FELICA_MASK;\n\t\tbreak;\n\tcase ST21NFCA_RF_READER_14443_3_A_GATE:\n\t\t \n\t\tr = st21nfca_get_iso14443_3_atqa(hdev, &atqa);\n\t\tif (r < 0)\n\t\t\treturn r;\n\t\tif (atqa == 0x000c) {\n\t\t\ttarget->supported_protocols = NFC_PROTO_JEWEL_MASK;\n\t\t\ttarget->sens_res = 0x0c00;\n\t\t} else {\n\t\t\tr = st21nfca_get_iso14443_3_sak(hdev, &sak);\n\t\t\tif (r < 0)\n\t\t\t\treturn r;\n\n\t\t\tr = st21nfca_get_iso14443_3_uid(hdev, uid, &len);\n\t\t\tif (r < 0)\n\t\t\t\treturn r;\n\n\t\t\ttarget->supported_protocols =\n\t\t\t    nfc_hci_sak_to_protocol(sak);\n\t\t\tif (target->supported_protocols == 0xffffffff)\n\t\t\t\treturn -EPROTO;\n\n\t\t\ttarget->sens_res = atqa;\n\t\t\ttarget->sel_res = sak;\n\t\t\tmemcpy(target->nfcid1, uid, len);\n\t\t\ttarget->nfcid1_len = len;\n\t\t}\n\n\t\tbreak;\n\tcase ST21NFCA_RF_READER_ISO15693_GATE:\n\t\ttarget->supported_protocols = NFC_PROTO_ISO15693_MASK;\n\t\tr = st21nfca_get_iso15693_inventory(hdev, target);\n\t\tif (r < 0)\n\t\t\treturn r;\n\t\tbreak;\n\tdefault:\n\t\treturn -EPROTO;\n\t}\n\n\treturn 0;\n}\n\nstatic int st21nfca_hci_complete_target_discovered(struct nfc_hci_dev *hdev,\n\t\t\t\t\t\tu8 gate,\n\t\t\t\t\t\tstruct nfc_target *target)\n{\n\tint r;\n\tstruct sk_buff *nfcid_skb = NULL;\n\n\tif (gate == ST21NFCA_RF_READER_F_GATE) {\n\t\tr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_F_GATE,\n\t\t\t\tST21NFCA_RF_READER_F_NFCID2, &nfcid_skb);\n\t\tif (r < 0)\n\t\t\tgoto exit;\n\n\t\tif (nfcid_skb->len > NFC_SENSF_RES_MAXSIZE) {\n\t\t\tr = -EPROTO;\n\t\t\tgoto exit;\n\t\t}\n\n\t\t \n\t\tif (nfcid_skb->len > 0) {\n\t\t\t \n\t\t\tmemcpy(target->sensf_res, nfcid_skb->data,\n\t\t\t\tnfcid_skb->len);\n\t\t\ttarget->sensf_res_len = nfcid_skb->len;\n\t\t\t \n\t\t\tif (target->sensf_res[0] == 0x01 &&\n\t\t\t    target->sensf_res[1] == 0xfe)\n\t\t\t\ttarget->supported_protocols =\n\t\t\t\t\t\t\tNFC_PROTO_NFC_DEP_MASK;\n\t\t\telse\n\t\t\t\ttarget->supported_protocols =\n\t\t\t\t\t\t\tNFC_PROTO_FELICA_MASK;\n\t\t} else {\n\t\t\tkfree_skb(nfcid_skb);\n\t\t\tnfcid_skb = NULL;\n\t\t\t \n\t\t\tr = nfc_hci_get_param(hdev, ST21NFCA_RF_READER_F_GATE,\n\t\t\t\t\tST21NFCA_RF_READER_F_NFCID1,\n\t\t\t\t\t&nfcid_skb);\n\t\t\tif (r < 0)\n\t\t\t\tgoto exit;\n\n\t\t\tif (nfcid_skb->len > NFC_NFCID1_MAXSIZE) {\n\t\t\t\tr = -EPROTO;\n\t\t\t\tgoto exit;\n\t\t\t}\n\t\t\tmemcpy(target->sensf_res, nfcid_skb->data,\n\t\t\t\tnfcid_skb->len);\n\t\t\ttarget->sensf_res_len = nfcid_skb->len;\n\t\t\ttarget->supported_protocols = NFC_PROTO_NFC_DEP_MASK;\n\t\t}\n\t\ttarget->hci_reader_gate = ST21NFCA_RF_READER_F_GATE;\n\t}\n\tr = 1;\nexit:\n\tkfree_skb(nfcid_skb);\n\treturn r;\n}\n\n#define ST21NFCA_CB_TYPE_READER_ISO15693 1\nstatic void st21nfca_hci_data_exchange_cb(void *context, struct sk_buff *skb,\n\t\t\t\t\t  int err)\n{\n\tstruct st21nfca_hci_info *info = context;\n\n\tswitch (info->async_cb_type) {\n\tcase ST21NFCA_CB_TYPE_READER_ISO15693:\n\t\tif (err == 0)\n\t\t\tskb_trim(skb, skb->len - 1);\n\t\tinfo->async_cb(info->async_cb_context, skb, err);\n\t\tbreak;\n\tdefault:\n\t\tif (err == 0)\n\t\t\tkfree_skb(skb);\n\t\tbreak;\n\t}\n}\n\n \nstatic int st21nfca_hci_im_transceive(struct nfc_hci_dev *hdev,\n\t\t\t\t      struct nfc_target *target,\n\t\t\t\t      struct sk_buff *skb,\n\t\t\t\t      data_exchange_cb_t cb, void *cb_context)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tpr_info(DRIVER_DESC \": %s for gate=%d len=%d\\n\", __func__,\n\t\ttarget->hci_reader_gate, skb->len);\n\n\tswitch (target->hci_reader_gate) {\n\tcase ST21NFCA_RF_READER_F_GATE:\n\t\tif (target->supported_protocols == NFC_PROTO_NFC_DEP_MASK)\n\t\t\treturn st21nfca_im_send_dep_req(hdev, skb);\n\n\t\t*(u8 *)skb_push(skb, 1) = 0x1a;\n\t\treturn nfc_hci_send_cmd_async(hdev, target->hci_reader_gate,\n\t\t\t\t\t      ST21NFCA_WR_XCHG_DATA, skb->data,\n\t\t\t\t\t      skb->len, cb, cb_context);\n\tcase ST21NFCA_RF_READER_14443_3_A_GATE:\n\t\t*(u8 *)skb_push(skb, 1) = 0x1a;\t \n\n\t\treturn nfc_hci_send_cmd_async(hdev, target->hci_reader_gate,\n\t\t\t\t\t      ST21NFCA_WR_XCHG_DATA, skb->data,\n\t\t\t\t\t      skb->len, cb, cb_context);\n\tcase ST21NFCA_RF_READER_ISO15693_GATE:\n\t\tinfo->async_cb_type = ST21NFCA_CB_TYPE_READER_ISO15693;\n\t\tinfo->async_cb = cb;\n\t\tinfo->async_cb_context = cb_context;\n\n\t\t*(u8 *)skb_push(skb, 1) = 0x17;\n\n\t\treturn nfc_hci_send_cmd_async(hdev, target->hci_reader_gate,\n\t\t\t\t\t      ST21NFCA_WR_XCHG_DATA, skb->data,\n\t\t\t\t\t      skb->len,\n\t\t\t\t\t      st21nfca_hci_data_exchange_cb,\n\t\t\t\t\t      info);\n\tdefault:\n\t\treturn 1;\n\t}\n}\n\nstatic int st21nfca_hci_tm_send(struct nfc_hci_dev *hdev, struct sk_buff *skb)\n{\n\treturn st21nfca_tm_send_dep_res(hdev, skb);\n}\n\nstatic int st21nfca_hci_check_presence(struct nfc_hci_dev *hdev,\n\t\t\t\t       struct nfc_target *target)\n{\n\tu8 fwi = 0x11;\n\n\tswitch (target->hci_reader_gate) {\n\tcase NFC_HCI_RF_READER_A_GATE:\n\tcase NFC_HCI_RF_READER_B_GATE:\n\t\t \n\t\treturn nfc_hci_send_cmd(hdev, target->hci_reader_gate,\n\t\t\t\t\tST21NFCA_WR_XCHG_DATA, &fwi, 1, NULL);\n\tcase ST21NFCA_RF_READER_14443_3_A_GATE:\n\t\treturn nfc_hci_send_cmd(hdev, target->hci_reader_gate,\n\t\t\t\t\tST21NFCA_RF_READER_CMD_PRESENCE_CHECK,\n\t\t\t\t\tNULL, 0, NULL);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic void st21nfca_hci_cmd_received(struct nfc_hci_dev *hdev, u8 pipe, u8 cmd,\n\t\t\t\tstruct sk_buff *skb)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\tu8 gate = hdev->pipes[pipe].gate;\n\n\tpr_debug(\"cmd: %x\\n\", cmd);\n\n\tswitch (cmd) {\n\tcase NFC_HCI_ANY_OPEN_PIPE:\n\t\tif (gate != ST21NFCA_APDU_READER_GATE &&\n\t\t\thdev->pipes[pipe].dest_host != NFC_HCI_UICC_HOST_ID)\n\t\t\tinfo->se_info.count_pipes++;\n\n\t\tif (info->se_info.count_pipes == info->se_info.expected_pipes) {\n\t\t\tdel_timer_sync(&info->se_info.se_active_timer);\n\t\t\tinfo->se_info.se_active = false;\n\t\t\tinfo->se_info.count_pipes = 0;\n\t\t\tcomplete(&info->se_info.req_completion);\n\t\t}\n\tbreak;\n\t}\n}\n\nstatic int st21nfca_admin_event_received(struct nfc_hci_dev *hdev, u8 event,\n\t\t\t\t\tstruct sk_buff *skb)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tpr_debug(\"admin event: %x\\n\", event);\n\n\tswitch (event) {\n\tcase ST21NFCA_EVT_HOT_PLUG:\n\t\tif (info->se_info.se_active) {\n\t\t\tif (!ST21NFCA_EVT_HOT_PLUG_IS_INHIBITED(skb)) {\n\t\t\t\tdel_timer_sync(&info->se_info.se_active_timer);\n\t\t\t\tinfo->se_info.se_active = false;\n\t\t\t\tcomplete(&info->se_info.req_completion);\n\t\t\t} else {\n\t\t\t\tmod_timer(&info->se_info.se_active_timer,\n\t\t\t\t\tjiffies +\n\t\t\t\t\tmsecs_to_jiffies(ST21NFCA_SE_TO_PIPES));\n\t\t\t}\n\t\t}\n\tbreak;\n\tdefault:\n\t\tnfc_err(&hdev->ndev->dev, \"Unexpected event on admin gate\\n\");\n\t}\n\tkfree_skb(skb);\n\treturn 0;\n}\n\n \nstatic int st21nfca_hci_event_received(struct nfc_hci_dev *hdev, u8 pipe,\n\t\t\t\t       u8 event, struct sk_buff *skb)\n{\n\tu8 gate = hdev->pipes[pipe].gate;\n\tu8 host = hdev->pipes[pipe].dest_host;\n\n\tpr_debug(\"hci event: %d gate: %x\\n\", event, gate);\n\n\tswitch (gate) {\n\tcase NFC_HCI_ADMIN_GATE:\n\t\treturn st21nfca_admin_event_received(hdev, event, skb);\n\tcase ST21NFCA_RF_CARD_F_GATE:\n\t\treturn st21nfca_dep_event_received(hdev, event, skb);\n\tcase ST21NFCA_CONNECTIVITY_GATE:\n\t\treturn st21nfca_connectivity_event_received(hdev, host,\n\t\t\t\t\t\t\tevent, skb);\n\tcase ST21NFCA_APDU_READER_GATE:\n\t\treturn st21nfca_apdu_reader_event_received(hdev, event, skb);\n\tcase NFC_HCI_LOOPBACK_GATE:\n\t\treturn st21nfca_hci_loopback_event_received(hdev, event, skb);\n\tdefault:\n\t\treturn 1;\n\t}\n}\n\nstatic const struct nfc_hci_ops st21nfca_hci_ops = {\n\t.open = st21nfca_hci_open,\n\t.close = st21nfca_hci_close,\n\t.load_session = st21nfca_hci_load_session,\n\t.hci_ready = st21nfca_hci_ready,\n\t.xmit = st21nfca_hci_xmit,\n\t.start_poll = st21nfca_hci_start_poll,\n\t.stop_poll = st21nfca_hci_stop_poll,\n\t.dep_link_up = st21nfca_hci_dep_link_up,\n\t.dep_link_down = st21nfca_hci_dep_link_down,\n\t.target_from_gate = st21nfca_hci_target_from_gate,\n\t.complete_target_discovered = st21nfca_hci_complete_target_discovered,\n\t.im_transceive = st21nfca_hci_im_transceive,\n\t.tm_send = st21nfca_hci_tm_send,\n\t.check_presence = st21nfca_hci_check_presence,\n\t.event_received = st21nfca_hci_event_received,\n\t.cmd_received = st21nfca_hci_cmd_received,\n\t.discover_se = st21nfca_hci_discover_se,\n\t.enable_se = st21nfca_hci_enable_se,\n\t.disable_se = st21nfca_hci_disable_se,\n\t.se_io = st21nfca_hci_se_io,\n};\n\nint st21nfca_hci_probe(void *phy_id, const struct nfc_phy_ops *phy_ops,\n\t\t       char *llc_name, int phy_headroom, int phy_tailroom,\n\t\t       int phy_payload, struct nfc_hci_dev **hdev,\n\t\t\t   struct st21nfca_se_status *se_status)\n{\n\tstruct st21nfca_hci_info *info;\n\tint r = 0;\n\tint dev_num;\n\tu32 protocols;\n\tstruct nfc_hci_init_data init_data;\n\tunsigned long quirks = 0;\n\n\tinfo = kzalloc(sizeof(struct st21nfca_hci_info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->phy_ops = phy_ops;\n\tinfo->phy_id = phy_id;\n\tinfo->state = ST21NFCA_ST_COLD;\n\tmutex_init(&info->info_lock);\n\n\tinit_data.gate_count = ARRAY_SIZE(st21nfca_gates);\n\n\tmemcpy(init_data.gates, st21nfca_gates, sizeof(st21nfca_gates));\n\n\t \n\tdev_num = find_first_zero_bit(dev_mask, ST21NFCA_NUM_DEVICES);\n\tif (dev_num >= ST21NFCA_NUM_DEVICES) {\n\t\tr = -ENODEV;\n\t\tgoto err_alloc_hdev;\n\t}\n\n\tset_bit(dev_num, dev_mask);\n\n\tscnprintf(init_data.session_id, sizeof(init_data.session_id), \"%s%2x\",\n\t\t  \"ST21AH\", dev_num);\n\n\tprotocols = NFC_PROTO_JEWEL_MASK |\n\t    NFC_PROTO_MIFARE_MASK |\n\t    NFC_PROTO_FELICA_MASK |\n\t    NFC_PROTO_ISO14443_MASK |\n\t    NFC_PROTO_ISO14443_B_MASK |\n\t    NFC_PROTO_ISO15693_MASK |\n\t    NFC_PROTO_NFC_DEP_MASK;\n\n\tset_bit(NFC_HCI_QUIRK_SHORT_CLEAR, &quirks);\n\n\tinfo->hdev =\n\t    nfc_hci_allocate_device(&st21nfca_hci_ops, &init_data, quirks,\n\t\t\t\t    protocols, llc_name,\n\t\t\t\t    phy_headroom + ST21NFCA_CMDS_HEADROOM,\n\t\t\t\t    phy_tailroom, phy_payload);\n\n\tif (!info->hdev) {\n\t\tpr_err(\"Cannot allocate nfc hdev.\\n\");\n\t\tr = -ENOMEM;\n\t\tgoto err_alloc_hdev;\n\t}\n\n\tinfo->se_status = se_status;\n\n\tnfc_hci_set_clientdata(info->hdev, info);\n\n\tr = nfc_hci_register_device(info->hdev);\n\tif (r)\n\t\tgoto err_regdev;\n\n\t*hdev = info->hdev;\n\tst21nfca_dep_init(info->hdev);\n\tst21nfca_se_init(info->hdev);\n\tst21nfca_vendor_cmds_init(info->hdev);\n\n\treturn 0;\n\nerr_regdev:\n\tnfc_hci_free_device(info->hdev);\n\nerr_alloc_hdev:\n\tkfree(info);\n\n\treturn r;\n}\nEXPORT_SYMBOL(st21nfca_hci_probe);\n\nvoid st21nfca_hci_remove(struct nfc_hci_dev *hdev)\n{\n\tstruct st21nfca_hci_info *info = nfc_hci_get_clientdata(hdev);\n\n\tst21nfca_dep_deinit(hdev);\n\tst21nfca_se_deinit(hdev);\n\tnfc_hci_unregister_device(hdev);\n\tnfc_hci_free_device(hdev);\n\tkfree(info);\n}\nEXPORT_SYMBOL(st21nfca_hci_remove);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(DRIVER_DESC);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}