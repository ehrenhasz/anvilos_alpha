{
  "module_name": "vendor_cmds.c",
  "hash_id": "09c0b585c25a3cbd1c113995cd27338b2592d47cf79fcfc69e1342fc96385a1c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nfc/st-nci/vendor_cmds.c",
  "human_readable_source": "\n \n\n#include <net/genetlink.h>\n#include <linux/module.h>\n#include <linux/nfc.h>\n#include <linux/delay.h>\n#include <net/nfc/nci_core.h>\n\n#include \"st-nci.h\"\n\n#define ST_NCI_HCI_DM_GETDATA\t\t\t0x10\n#define ST_NCI_HCI_DM_PUTDATA\t\t\t0x11\n#define ST_NCI_HCI_DM_LOAD\t\t\t0x12\n#define ST_NCI_HCI_DM_GETINFO\t\t\t0x13\n#define ST_NCI_HCI_DM_FWUPD_START\t\t0x14\n#define ST_NCI_HCI_DM_FWUPD_STOP\t\t0x15\n#define ST_NCI_HCI_DM_UPDATE_AID\t\t0x20\n#define ST_NCI_HCI_DM_RESET\t\t\t0x3e\n\n#define ST_NCI_HCI_DM_FIELD_GENERATOR\t\t0x32\n#define ST_NCI_HCI_DM_VDC_MEASUREMENT_VALUE\t0x33\n#define ST_NCI_HCI_DM_VDC_VALUE_COMPARISON\t0x34\n\n#define ST_NCI_FACTORY_MODE_ON\t\t\t1\n#define ST_NCI_FACTORY_MODE_OFF\t\t\t0\n\n#define ST_NCI_EVT_POST_DATA\t\t\t0x02\n\nstruct get_param_data {\n\tu8 gate;\n\tu8 data;\n} __packed;\n\nstatic int st_nci_factory_mode(struct nfc_dev *dev, void *data,\n\t\t\t       size_t data_len)\n{\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\tstruct st_nci_info *info = nci_get_drvdata(ndev);\n\n\tif (data_len != 1)\n\t\treturn -EINVAL;\n\n\tpr_debug(\"factory mode: %x\\n\", ((u8 *)data)[0]);\n\n\tswitch (((u8 *)data)[0]) {\n\tcase ST_NCI_FACTORY_MODE_ON:\n\t\ttest_and_set_bit(ST_NCI_FACTORY_MODE, &info->flags);\n\tbreak;\n\tcase ST_NCI_FACTORY_MODE_OFF:\n\t\tclear_bit(ST_NCI_FACTORY_MODE, &info->flags);\n\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int st_nci_hci_clear_all_pipes(struct nfc_dev *dev, void *data,\n\t\t\t\t      size_t data_len)\n{\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\treturn nci_hci_clear_all_pipes(ndev);\n}\n\nstatic int st_nci_hci_dm_put_data(struct nfc_dev *dev, void *data,\n\t\t\t\t  size_t data_len)\n{\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\treturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\n\t\t\t\tST_NCI_HCI_DM_PUTDATA, data,\n\t\t\t\tdata_len, NULL);\n}\n\nstatic int st_nci_hci_dm_update_aid(struct nfc_dev *dev, void *data,\n\t\t\t\t    size_t data_len)\n{\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\treturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\n\t\t\tST_NCI_HCI_DM_UPDATE_AID, data, data_len, NULL);\n}\n\nstatic int st_nci_hci_dm_get_info(struct nfc_dev *dev, void *data,\n\t\t\t\t  size_t data_len)\n{\n\tint r;\n\tstruct sk_buff *msg, *skb;\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\tr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE, ST_NCI_HCI_DM_GETINFO,\n\t\t\t     data, data_len, &skb);\n\tif (r)\n\t\treturn r;\n\n\tmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\n\t\t\t\t\t     HCI_DM_GET_INFO, skb->len);\n\tif (!msg) {\n\t\tr = -ENOMEM;\n\t\tgoto free_skb;\n\t}\n\n\tif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\n\t\tkfree_skb(msg);\n\t\tr = -ENOBUFS;\n\t\tgoto free_skb;\n\t}\n\n\tr = nfc_vendor_cmd_reply(msg);\n\nfree_skb:\n\tkfree_skb(skb);\n\treturn r;\n}\n\nstatic int st_nci_hci_dm_get_data(struct nfc_dev *dev, void *data,\n\t\t\t\t  size_t data_len)\n{\n\tint r;\n\tstruct sk_buff *msg, *skb;\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\tr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE, ST_NCI_HCI_DM_GETDATA,\n\t\t\t     data, data_len, &skb);\n\tif (r)\n\t\treturn r;\n\n\tmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\n\t\t\t\t\t     HCI_DM_GET_DATA, skb->len);\n\tif (!msg) {\n\t\tr = -ENOMEM;\n\t\tgoto free_skb;\n\t}\n\n\tif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\n\t\tkfree_skb(msg);\n\t\tr = -ENOBUFS;\n\t\tgoto free_skb;\n\t}\n\n\tr = nfc_vendor_cmd_reply(msg);\n\nfree_skb:\n\tkfree_skb(skb);\n\treturn r;\n}\n\nstatic int st_nci_hci_dm_fwupd_start(struct nfc_dev *dev, void *data,\n\t\t\t\t     size_t data_len)\n{\n\tint r;\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\tdev->fw_download_in_progress = true;\n\tr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\n\t\t\tST_NCI_HCI_DM_FWUPD_START, data, data_len, NULL);\n\tif (r)\n\t\tdev->fw_download_in_progress = false;\n\n\treturn r;\n}\n\nstatic int st_nci_hci_dm_fwupd_end(struct nfc_dev *dev, void *data,\n\t\t\t\t   size_t data_len)\n{\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\treturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\n\t\t\tST_NCI_HCI_DM_FWUPD_STOP, data, data_len, NULL);\n}\n\nstatic int st_nci_hci_dm_direct_load(struct nfc_dev *dev, void *data,\n\t\t\t\t     size_t data_len)\n{\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\tif (dev->fw_download_in_progress) {\n\t\tdev->fw_download_in_progress = false;\n\t\treturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\n\t\t\t\tST_NCI_HCI_DM_LOAD, data, data_len, NULL);\n\t}\n\treturn -EPROTO;\n}\n\nstatic int st_nci_hci_dm_reset(struct nfc_dev *dev, void *data,\n\t\t\t       size_t data_len)\n{\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\tnci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\n\t\t\tST_NCI_HCI_DM_RESET, data, data_len, NULL);\n\tmsleep(200);\n\n\treturn 0;\n}\n\nstatic int st_nci_hci_get_param(struct nfc_dev *dev, void *data,\n\t\t\t\tsize_t data_len)\n{\n\tint r;\n\tstruct sk_buff *msg, *skb;\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\tstruct get_param_data *param = (struct get_param_data *)data;\n\n\tif (data_len < sizeof(struct get_param_data))\n\t\treturn -EPROTO;\n\n\tr = nci_hci_get_param(ndev, param->gate, param->data, &skb);\n\tif (r)\n\t\treturn r;\n\n\tmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\n\t\t\t\t\t     HCI_GET_PARAM, skb->len);\n\tif (!msg) {\n\t\tr = -ENOMEM;\n\t\tgoto free_skb;\n\t}\n\n\tif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\n\t\tkfree_skb(msg);\n\t\tr = -ENOBUFS;\n\t\tgoto free_skb;\n\t}\n\n\tr = nfc_vendor_cmd_reply(msg);\n\nfree_skb:\n\tkfree_skb(skb);\n\treturn r;\n}\n\nstatic int st_nci_hci_dm_field_generator(struct nfc_dev *dev, void *data,\n\t\t\t\t\t size_t data_len)\n{\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\treturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\n\t\t\t\tST_NCI_HCI_DM_FIELD_GENERATOR, data, data_len, NULL);\n}\n\nstatic int st_nci_hci_dm_vdc_measurement_value(struct nfc_dev *dev, void *data,\n\t\t\t\t\t       size_t data_len)\n{\n\tint r;\n\tstruct sk_buff *msg, *skb;\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\tif (data_len != 4)\n\t\treturn -EPROTO;\n\n\tr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\n\t\t\t     ST_NCI_HCI_DM_VDC_MEASUREMENT_VALUE,\n\t\t\t     data, data_len, &skb);\n\tif (r)\n\t\treturn r;\n\n\tmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\n\t\t\t\tHCI_DM_VDC_MEASUREMENT_VALUE, skb->len);\n\tif (!msg) {\n\t\tr = -ENOMEM;\n\t\tgoto free_skb;\n\t}\n\n\tif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\n\t\tkfree_skb(msg);\n\t\tr = -ENOBUFS;\n\t\tgoto free_skb;\n\t}\n\n\tr = nfc_vendor_cmd_reply(msg);\n\nfree_skb:\n\tkfree_skb(skb);\n\treturn r;\n}\n\nstatic int st_nci_hci_dm_vdc_value_comparison(struct nfc_dev *dev, void *data,\n\t\t\t\t\t      size_t data_len)\n{\n\tint r;\n\tstruct sk_buff *msg, *skb;\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\tif (data_len != 2)\n\t\treturn -EPROTO;\n\n\tr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\n\t\t\t     ST_NCI_HCI_DM_VDC_VALUE_COMPARISON,\n\t\t\t     data, data_len, &skb);\n\tif (r)\n\t\treturn r;\n\n\tmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\n\t\t\t\t\tHCI_DM_VDC_VALUE_COMPARISON, skb->len);\n\tif (!msg) {\n\t\tr = -ENOMEM;\n\t\tgoto free_skb;\n\t}\n\n\tif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\n\t\tkfree_skb(msg);\n\t\tr = -ENOBUFS;\n\t\tgoto free_skb;\n\t}\n\n\tr = nfc_vendor_cmd_reply(msg);\n\nfree_skb:\n\tkfree_skb(skb);\n\treturn r;\n}\n\nstatic int st_nci_loopback(struct nfc_dev *dev, void *data,\n\t\t\t   size_t data_len)\n{\n\tint r;\n\tstruct sk_buff *msg, *skb;\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\tif (data_len <= 0)\n\t\treturn -EPROTO;\n\n\tr = nci_nfcc_loopback(ndev, data, data_len, &skb);\n\tif (r < 0)\n\t\treturn r;\n\n\tmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\n\t\t\t\t\t     LOOPBACK, skb->len);\n\tif (!msg) {\n\t\tr = -ENOMEM;\n\t\tgoto free_skb;\n\t}\n\n\tif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\n\t\tkfree_skb(msg);\n\t\tr = -ENOBUFS;\n\t\tgoto free_skb;\n\t}\n\n\tr = nfc_vendor_cmd_reply(msg);\nfree_skb:\n\tkfree_skb(skb);\n\treturn r;\n}\n\nstatic int st_nci_manufacturer_specific(struct nfc_dev *dev, void *data,\n\t\t\t\t\tsize_t data_len)\n{\n\tstruct sk_buff *msg;\n\tstruct nci_dev *ndev = nfc_get_drvdata(dev);\n\n\tmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\n\t\t\t\t\tMANUFACTURER_SPECIFIC,\n\t\t\t\t\tsizeof(ndev->manufact_specific_info));\n\tif (!msg)\n\t\treturn -ENOMEM;\n\n\tif (nla_put(msg, NFC_ATTR_VENDOR_DATA, sizeof(ndev->manufact_specific_info),\n\t\t    &ndev->manufact_specific_info)) {\n\t\tkfree_skb(msg);\n\t\treturn -ENOBUFS;\n\t}\n\n\treturn nfc_vendor_cmd_reply(msg);\n}\n\nstatic const struct nfc_vendor_cmd st_nci_vendor_cmds[] = {\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = FACTORY_MODE,\n\t\t.doit = st_nci_factory_mode,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_CLEAR_ALL_PIPES,\n\t\t.doit = st_nci_hci_clear_all_pipes,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_PUT_DATA,\n\t\t.doit = st_nci_hci_dm_put_data,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_UPDATE_AID,\n\t\t.doit = st_nci_hci_dm_update_aid,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_GET_INFO,\n\t\t.doit = st_nci_hci_dm_get_info,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_GET_DATA,\n\t\t.doit = st_nci_hci_dm_get_data,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_DIRECT_LOAD,\n\t\t.doit = st_nci_hci_dm_direct_load,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_RESET,\n\t\t.doit = st_nci_hci_dm_reset,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_GET_PARAM,\n\t\t.doit = st_nci_hci_get_param,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_FIELD_GENERATOR,\n\t\t.doit = st_nci_hci_dm_field_generator,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_FWUPD_START,\n\t\t.doit = st_nci_hci_dm_fwupd_start,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_FWUPD_END,\n\t\t.doit = st_nci_hci_dm_fwupd_end,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = LOOPBACK,\n\t\t.doit = st_nci_loopback,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_VDC_MEASUREMENT_VALUE,\n\t\t.doit = st_nci_hci_dm_vdc_measurement_value,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = HCI_DM_VDC_VALUE_COMPARISON,\n\t\t.doit = st_nci_hci_dm_vdc_value_comparison,\n\t},\n\t{\n\t\t.vendor_id = ST_NCI_VENDOR_OUI,\n\t\t.subcmd = MANUFACTURER_SPECIFIC,\n\t\t.doit = st_nci_manufacturer_specific,\n\t},\n};\n\nint st_nci_vendor_cmds_init(struct nci_dev *ndev)\n{\n\treturn nci_set_vendor_cmds(ndev, st_nci_vendor_cmds,\n\t\t\t\t   sizeof(st_nci_vendor_cmds));\n}\nEXPORT_SYMBOL(st_nci_vendor_cmds_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}