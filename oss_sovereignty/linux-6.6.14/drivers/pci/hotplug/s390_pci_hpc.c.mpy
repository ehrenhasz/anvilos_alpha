{
  "module_name": "s390_pci_hpc.c",
  "hash_id": "072c1f87d8343131d9c8eb41b1dc9a201bf920c50707806b171773a539ddff59",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pci/hotplug/s390_pci_hpc.c",
  "human_readable_source": "\n \n\n#define KMSG_COMPONENT \"zpci\"\n#define pr_fmt(fmt) KMSG_COMPONENT \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/pci.h>\n#include <linux/pci_hotplug.h>\n#include <asm/pci_debug.h>\n#include <asm/sclp.h>\n\n#define SLOT_NAME_SIZE\t10\n\nstatic int enable_slot(struct hotplug_slot *hotplug_slot)\n{\n\tstruct zpci_dev *zdev = container_of(hotplug_slot, struct zpci_dev,\n\t\t\t\t\t     hotplug_slot);\n\tint rc;\n\n\tif (zdev->state != ZPCI_FN_STATE_STANDBY)\n\t\treturn -EIO;\n\n\trc = sclp_pci_configure(zdev->fid);\n\tzpci_dbg(3, \"conf fid:%x, rc:%d\\n\", zdev->fid, rc);\n\tif (rc)\n\t\treturn rc;\n\tzdev->state = ZPCI_FN_STATE_CONFIGURED;\n\n\treturn zpci_scan_configured_device(zdev, zdev->fh);\n}\n\nstatic int disable_slot(struct hotplug_slot *hotplug_slot)\n{\n\tstruct zpci_dev *zdev = container_of(hotplug_slot, struct zpci_dev,\n\t\t\t\t\t     hotplug_slot);\n\tstruct pci_dev *pdev;\n\n\tif (zdev->state != ZPCI_FN_STATE_CONFIGURED)\n\t\treturn -EIO;\n\n\tpdev = pci_get_slot(zdev->zbus->bus, zdev->devfn);\n\tif (pdev && pci_num_vf(pdev)) {\n\t\tpci_dev_put(pdev);\n\t\treturn -EBUSY;\n\t}\n\tpci_dev_put(pdev);\n\n\treturn zpci_deconfigure_device(zdev);\n}\n\nstatic int reset_slot(struct hotplug_slot *hotplug_slot, bool probe)\n{\n\tstruct zpci_dev *zdev = container_of(hotplug_slot, struct zpci_dev,\n\t\t\t\t\t     hotplug_slot);\n\n\tif (zdev->state != ZPCI_FN_STATE_CONFIGURED)\n\t\treturn -EIO;\n\t \n\n\t \n\tif (probe)\n\t\treturn 0;\n\n\treturn zpci_hot_reset_device(zdev);\n}\n\nstatic int get_power_status(struct hotplug_slot *hotplug_slot, u8 *value)\n{\n\tstruct zpci_dev *zdev = container_of(hotplug_slot, struct zpci_dev,\n\t\t\t\t\t     hotplug_slot);\n\n\t*value = zpci_is_device_configured(zdev) ? 1 : 0;\n\treturn 0;\n}\n\nstatic int get_adapter_status(struct hotplug_slot *hotplug_slot, u8 *value)\n{\n\t \n\t*value = 1;\n\treturn 0;\n}\n\nstatic const struct hotplug_slot_ops s390_hotplug_slot_ops = {\n\t.enable_slot =\t\tenable_slot,\n\t.disable_slot =\t\tdisable_slot,\n\t.reset_slot =\t\treset_slot,\n\t.get_power_status =\tget_power_status,\n\t.get_adapter_status =\tget_adapter_status,\n};\n\nint zpci_init_slot(struct zpci_dev *zdev)\n{\n\tchar name[SLOT_NAME_SIZE];\n\tstruct zpci_bus *zbus = zdev->zbus;\n\n\tzdev->hotplug_slot.ops = &s390_hotplug_slot_ops;\n\n\tsnprintf(name, SLOT_NAME_SIZE, \"%08x\", zdev->fid);\n\treturn pci_hp_register(&zdev->hotplug_slot, zbus->bus,\n\t\t\t       zdev->devfn, name);\n}\n\nvoid zpci_exit_slot(struct zpci_dev *zdev)\n{\n\tpci_hp_deregister(&zdev->hotplug_slot);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}