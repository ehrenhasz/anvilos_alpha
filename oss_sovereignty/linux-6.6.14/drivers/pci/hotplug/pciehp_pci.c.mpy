{
  "module_name": "pciehp_pci.c",
  "hash_id": "d4682ce8b16807bdfd810a280e03277338fb230eda08c4b5656a0d5db096a367",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pci/hotplug/pciehp_pci.c",
  "human_readable_source": "\n \n\n#define dev_fmt(fmt) \"pciehp: \" fmt\n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/pci.h>\n#include \"../pci.h\"\n#include \"pciehp.h\"\n\n \nint pciehp_configure_device(struct controller *ctrl)\n{\n\tstruct pci_dev *dev;\n\tstruct pci_dev *bridge = ctrl->pcie->port;\n\tstruct pci_bus *parent = bridge->subordinate;\n\tint num, ret = 0;\n\n\tpci_lock_rescan_remove();\n\n\tdev = pci_get_slot(parent, PCI_DEVFN(0, 0));\n\tif (dev) {\n\t\t \n\t\tctrl_dbg(ctrl, \"Device %s already exists at %04x:%02x:00, skipping hot-add\\n\",\n\t\t\t pci_name(dev), pci_domain_nr(parent), parent->number);\n\t\tpci_dev_put(dev);\n\t\tret = -EEXIST;\n\t\tgoto out;\n\t}\n\n\tnum = pci_scan_slot(parent, PCI_DEVFN(0, 0));\n\tif (num == 0) {\n\t\tctrl_err(ctrl, \"No new device found\\n\");\n\t\tret = -ENODEV;\n\t\tgoto out;\n\t}\n\n\tfor_each_pci_bridge(dev, parent)\n\t\tpci_hp_add_bridge(dev);\n\n\tpci_assign_unassigned_bridge_resources(bridge);\n\tpcie_bus_configure_settings(parent);\n\n\t \n\tup_read(&ctrl->reset_lock);\n\tpci_bus_add_devices(parent);\n\tdown_read_nested(&ctrl->reset_lock, ctrl->depth);\n\n out:\n\tpci_unlock_rescan_remove();\n\treturn ret;\n}\n\n \nvoid pciehp_unconfigure_device(struct controller *ctrl, bool presence)\n{\n\tstruct pci_dev *dev, *temp;\n\tstruct pci_bus *parent = ctrl->pcie->port->subordinate;\n\tu16 command;\n\n\tctrl_dbg(ctrl, \"%s: domain:bus:dev = %04x:%02x:00\\n\",\n\t\t __func__, pci_domain_nr(parent), parent->number);\n\n\tif (!presence)\n\t\tpci_walk_bus(parent, pci_dev_set_disconnected, NULL);\n\n\tpci_lock_rescan_remove();\n\n\t \n\tlist_for_each_entry_safe_reverse(dev, temp, &parent->devices,\n\t\t\t\t\t bus_list) {\n\t\tpci_dev_get(dev);\n\n\t\t \n\t\tup_read(&ctrl->reset_lock);\n\t\tpci_stop_and_remove_bus_device(dev);\n\t\tdown_read_nested(&ctrl->reset_lock, ctrl->depth);\n\n\t\t \n\t\tif (presence) {\n\t\t\tpci_read_config_word(dev, PCI_COMMAND, &command);\n\t\t\tcommand &= ~(PCI_COMMAND_MASTER | PCI_COMMAND_SERR);\n\t\t\tcommand |= PCI_COMMAND_INTX_DISABLE;\n\t\t\tpci_write_config_word(dev, PCI_COMMAND, command);\n\t\t}\n\t\tpci_dev_put(dev);\n\t}\n\n\tpci_unlock_rescan_remove();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}