{
  "module_name": "shpchp_pci.c",
  "hash_id": "9864b0fc21a0f107b655aefa648eb6f4424a36d116cd837b780104124c5aee2c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pci/hotplug/shpchp_pci.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/pci.h>\n#include \"../pci.h\"\n#include \"shpchp.h\"\n\nint shpchp_configure_device(struct slot *p_slot)\n{\n\tstruct pci_dev *dev;\n\tstruct controller *ctrl = p_slot->ctrl;\n\tstruct pci_dev *bridge = ctrl->pci_dev;\n\tstruct pci_bus *parent = bridge->subordinate;\n\tint num, ret = 0;\n\n\tpci_lock_rescan_remove();\n\n\tdev = pci_get_slot(parent, PCI_DEVFN(p_slot->device, 0));\n\tif (dev) {\n\t\tctrl_err(ctrl, \"Device %s already exists at %04x:%02x:%02x, cannot hot-add\\n\",\n\t\t\t pci_name(dev), pci_domain_nr(parent),\n\t\t\t p_slot->bus, p_slot->device);\n\t\tpci_dev_put(dev);\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tnum = pci_scan_slot(parent, PCI_DEVFN(p_slot->device, 0));\n\tif (num == 0) {\n\t\tctrl_err(ctrl, \"No new device found\\n\");\n\t\tret = -ENODEV;\n\t\tgoto out;\n\t}\n\n\tfor_each_pci_bridge(dev, parent) {\n\t\tif (PCI_SLOT(dev->devfn) == p_slot->device)\n\t\t\tpci_hp_add_bridge(dev);\n\t}\n\n\tpci_assign_unassigned_bridge_resources(bridge);\n\tpcie_bus_configure_settings(parent);\n\tpci_bus_add_devices(parent);\n\n out:\n\tpci_unlock_rescan_remove();\n\treturn ret;\n}\n\nvoid shpchp_unconfigure_device(struct slot *p_slot)\n{\n\tstruct pci_bus *parent = p_slot->ctrl->pci_dev->subordinate;\n\tstruct pci_dev *dev, *temp;\n\tstruct controller *ctrl = p_slot->ctrl;\n\n\tctrl_dbg(ctrl, \"%s: domain:bus:dev = %04x:%02x:%02x\\n\",\n\t\t __func__, pci_domain_nr(parent), p_slot->bus, p_slot->device);\n\n\tpci_lock_rescan_remove();\n\n\tlist_for_each_entry_safe(dev, temp, &parent->devices, bus_list) {\n\t\tif (PCI_SLOT(dev->devfn) != p_slot->device)\n\t\t\tcontinue;\n\n\t\tpci_dev_get(dev);\n\t\tpci_stop_and_remove_bus_device(dev);\n\t\tpci_dev_put(dev);\n\t}\n\n\tpci_unlock_rescan_remove();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}