{
  "module_name": "rom.c",
  "hash_id": "0ce2ca531eaff3a3ac67fa2d050071b2867b7bf1b6aa0bf7bd4dae653973f55a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pci/rom.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/export.h>\n#include <linux/pci.h>\n#include <linux/slab.h>\n\n#include \"pci.h\"\n\n \nint pci_enable_rom(struct pci_dev *pdev)\n{\n\tstruct resource *res = &pdev->resource[PCI_ROM_RESOURCE];\n\tstruct pci_bus_region region;\n\tu32 rom_addr;\n\n\tif (!res->flags)\n\t\treturn -1;\n\n\t \n\tif (res->flags & IORESOURCE_ROM_SHADOW)\n\t\treturn 0;\n\n\t \n\tpcibios_resource_to_bus(pdev->bus, &region, res);\n\tpci_read_config_dword(pdev, pdev->rom_base_reg, &rom_addr);\n\trom_addr &= ~PCI_ROM_ADDRESS_MASK;\n\trom_addr |= region.start | PCI_ROM_ADDRESS_ENABLE;\n\tpci_write_config_dword(pdev, pdev->rom_base_reg, rom_addr);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(pci_enable_rom);\n\n \nvoid pci_disable_rom(struct pci_dev *pdev)\n{\n\tstruct resource *res = &pdev->resource[PCI_ROM_RESOURCE];\n\tu32 rom_addr;\n\n\tif (res->flags & IORESOURCE_ROM_SHADOW)\n\t\treturn;\n\n\tpci_read_config_dword(pdev, pdev->rom_base_reg, &rom_addr);\n\trom_addr &= ~PCI_ROM_ADDRESS_ENABLE;\n\tpci_write_config_dword(pdev, pdev->rom_base_reg, rom_addr);\n}\nEXPORT_SYMBOL_GPL(pci_disable_rom);\n\n \nstatic size_t pci_get_rom_size(struct pci_dev *pdev, void __iomem *rom,\n\t\t\t       size_t size)\n{\n\tvoid __iomem *image;\n\tint last_image;\n\tunsigned int length;\n\n\timage = rom;\n\tdo {\n\t\tvoid __iomem *pds;\n\t\t \n\t\tif (readw(image) != 0xAA55) {\n\t\t\tpci_info(pdev, \"Invalid PCI ROM header signature: expecting 0xaa55, got %#06x\\n\",\n\t\t\t\t readw(image));\n\t\t\tbreak;\n\t\t}\n\t\t \n\t\tpds = image + readw(image + 24);\n\t\tif (readl(pds) != 0x52494350) {\n\t\t\tpci_info(pdev, \"Invalid PCI ROM data signature: expecting 0x52494350, got %#010x\\n\",\n\t\t\t\t readl(pds));\n\t\t\tbreak;\n\t\t}\n\t\tlast_image = readb(pds + 21) & 0x80;\n\t\tlength = readw(pds + 16);\n\t\timage += length * 512;\n\t\t \n\t\tif (image >= rom + size)\n\t\t\tbreak;\n\t\tif (!last_image) {\n\t\t\tif (readw(image) != 0xAA55) {\n\t\t\t\tpci_info(pdev, \"No more image in the PCI ROM\\n\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t} while (length && !last_image);\n\n\t \n\t \n\treturn min((size_t)(image - rom), size);\n}\n\n \nvoid __iomem *pci_map_rom(struct pci_dev *pdev, size_t *size)\n{\n\tstruct resource *res = &pdev->resource[PCI_ROM_RESOURCE];\n\tloff_t start;\n\tvoid __iomem *rom;\n\n\t \n\tif (res->parent == NULL && pci_assign_resource(pdev, PCI_ROM_RESOURCE))\n\t\treturn NULL;\n\n\tstart = pci_resource_start(pdev, PCI_ROM_RESOURCE);\n\t*size = pci_resource_len(pdev, PCI_ROM_RESOURCE);\n\tif (*size == 0)\n\t\treturn NULL;\n\n\t \n\tif (pci_enable_rom(pdev))\n\t\treturn NULL;\n\n\trom = ioremap(start, *size);\n\tif (!rom)\n\t\tgoto err_ioremap;\n\n\t \n\t*size = pci_get_rom_size(pdev, rom, *size);\n\tif (!*size)\n\t\tgoto invalid_rom;\n\n\treturn rom;\n\ninvalid_rom:\n\tiounmap(rom);\nerr_ioremap:\n\t \n\tif (!(res->flags & IORESOURCE_ROM_ENABLE))\n\t\tpci_disable_rom(pdev);\n\treturn NULL;\n}\nEXPORT_SYMBOL(pci_map_rom);\n\n \nvoid pci_unmap_rom(struct pci_dev *pdev, void __iomem *rom)\n{\n\tstruct resource *res = &pdev->resource[PCI_ROM_RESOURCE];\n\n\tiounmap(rom);\n\n\t \n\tif (!(res->flags & IORESOURCE_ROM_ENABLE))\n\t\tpci_disable_rom(pdev);\n}\nEXPORT_SYMBOL(pci_unmap_rom);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}