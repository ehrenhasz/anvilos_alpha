{
  "module_name": "pcie-cadence-plat.c",
  "hash_id": "780b811bee5cb1adae373260466fee229d5bc778c53e656033009f8b7fe54021",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pci/controller/cadence/pcie-cadence-plat.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/of_pci.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include \"pcie-cadence.h\"\n\n#define CDNS_PLAT_CPU_TO_BUS_ADDR\t0x0FFFFFFF\n\n \nstruct cdns_plat_pcie {\n\tstruct cdns_pcie        *pcie;\n\tbool is_rc;\n};\n\nstruct cdns_plat_pcie_of_data {\n\tbool is_rc;\n};\n\nstatic const struct of_device_id cdns_plat_pcie_of_match[];\n\nstatic u64 cdns_plat_cpu_addr_fixup(struct cdns_pcie *pcie, u64 cpu_addr)\n{\n\treturn cpu_addr & CDNS_PLAT_CPU_TO_BUS_ADDR;\n}\n\nstatic const struct cdns_pcie_ops cdns_plat_ops = {\n\t.cpu_addr_fixup = cdns_plat_cpu_addr_fixup,\n};\n\nstatic int cdns_plat_pcie_probe(struct platform_device *pdev)\n{\n\tconst struct cdns_plat_pcie_of_data *data;\n\tstruct cdns_plat_pcie *cdns_plat_pcie;\n\tstruct device *dev = &pdev->dev;\n\tstruct pci_host_bridge *bridge;\n\tstruct cdns_pcie_ep *ep;\n\tstruct cdns_pcie_rc *rc;\n\tint phy_count;\n\tbool is_rc;\n\tint ret;\n\n\tdata = of_device_get_match_data(dev);\n\tif (!data)\n\t\treturn -EINVAL;\n\n\tis_rc = data->is_rc;\n\n\tpr_debug(\" Started %s with is_rc: %d\\n\", __func__, is_rc);\n\tcdns_plat_pcie = devm_kzalloc(dev, sizeof(*cdns_plat_pcie), GFP_KERNEL);\n\tif (!cdns_plat_pcie)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, cdns_plat_pcie);\n\tif (is_rc) {\n\t\tif (!IS_ENABLED(CONFIG_PCIE_CADENCE_PLAT_HOST))\n\t\t\treturn -ENODEV;\n\n\t\tbridge = devm_pci_alloc_host_bridge(dev, sizeof(*rc));\n\t\tif (!bridge)\n\t\t\treturn -ENOMEM;\n\n\t\trc = pci_host_bridge_priv(bridge);\n\t\trc->pcie.dev = dev;\n\t\trc->pcie.ops = &cdns_plat_ops;\n\t\tcdns_plat_pcie->pcie = &rc->pcie;\n\t\tcdns_plat_pcie->is_rc = is_rc;\n\n\t\tret = cdns_pcie_init_phy(dev, cdns_plat_pcie->pcie);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"failed to init phy\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\tpm_runtime_enable(dev);\n\t\tret = pm_runtime_get_sync(dev);\n\t\tif (ret < 0) {\n\t\t\tdev_err(dev, \"pm_runtime_get_sync() failed\\n\");\n\t\t\tgoto err_get_sync;\n\t\t}\n\n\t\tret = cdns_pcie_host_setup(rc);\n\t\tif (ret)\n\t\t\tgoto err_init;\n\t} else {\n\t\tif (!IS_ENABLED(CONFIG_PCIE_CADENCE_PLAT_EP))\n\t\t\treturn -ENODEV;\n\n\t\tep = devm_kzalloc(dev, sizeof(*ep), GFP_KERNEL);\n\t\tif (!ep)\n\t\t\treturn -ENOMEM;\n\n\t\tep->pcie.dev = dev;\n\t\tep->pcie.ops = &cdns_plat_ops;\n\t\tcdns_plat_pcie->pcie = &ep->pcie;\n\t\tcdns_plat_pcie->is_rc = is_rc;\n\n\t\tret = cdns_pcie_init_phy(dev, cdns_plat_pcie->pcie);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"failed to init phy\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tpm_runtime_enable(dev);\n\t\tret = pm_runtime_get_sync(dev);\n\t\tif (ret < 0) {\n\t\t\tdev_err(dev, \"pm_runtime_get_sync() failed\\n\");\n\t\t\tgoto err_get_sync;\n\t\t}\n\n\t\tret = cdns_pcie_ep_setup(ep);\n\t\tif (ret)\n\t\t\tgoto err_init;\n\t}\n\n\treturn 0;\n\n err_init:\n err_get_sync:\n\tpm_runtime_put_sync(dev);\n\tpm_runtime_disable(dev);\n\tcdns_pcie_disable_phy(cdns_plat_pcie->pcie);\n\tphy_count = cdns_plat_pcie->pcie->phy_count;\n\twhile (phy_count--)\n\t\tdevice_link_del(cdns_plat_pcie->pcie->link[phy_count]);\n\n\treturn 0;\n}\n\nstatic void cdns_plat_pcie_shutdown(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct cdns_pcie *pcie = dev_get_drvdata(dev);\n\tint ret;\n\n\tret = pm_runtime_put_sync(dev);\n\tif (ret < 0)\n\t\tdev_dbg(dev, \"pm_runtime_put_sync failed\\n\");\n\n\tpm_runtime_disable(dev);\n\n\tcdns_pcie_disable_phy(pcie);\n}\n\nstatic const struct cdns_plat_pcie_of_data cdns_plat_pcie_host_of_data = {\n\t.is_rc = true,\n};\n\nstatic const struct cdns_plat_pcie_of_data cdns_plat_pcie_ep_of_data = {\n\t.is_rc = false,\n};\n\nstatic const struct of_device_id cdns_plat_pcie_of_match[] = {\n\t{\n\t\t.compatible = \"cdns,cdns-pcie-host\",\n\t\t.data = &cdns_plat_pcie_host_of_data,\n\t},\n\t{\n\t\t.compatible = \"cdns,cdns-pcie-ep\",\n\t\t.data = &cdns_plat_pcie_ep_of_data,\n\t},\n\t{},\n};\n\nstatic struct platform_driver cdns_plat_pcie_driver = {\n\t.driver = {\n\t\t.name = \"cdns-pcie\",\n\t\t.of_match_table = cdns_plat_pcie_of_match,\n\t\t.pm\t= &cdns_pcie_pm_ops,\n\t},\n\t.probe = cdns_plat_pcie_probe,\n\t.shutdown = cdns_plat_pcie_shutdown,\n};\nbuiltin_platform_driver(cdns_plat_pcie_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}