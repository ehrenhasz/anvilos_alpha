{
  "module_name": "pcie-rcar.c",
  "hash_id": "b7fc09dc729fc27c02668cf6c426f5a1547f5683276fc5c38b63fd67294f4bff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pci/controller/pcie-rcar.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/pci.h>\n\n#include \"pcie-rcar.h\"\n\nvoid rcar_pci_write_reg(struct rcar_pcie *pcie, u32 val, unsigned int reg)\n{\n\twritel(val, pcie->base + reg);\n}\n\nu32 rcar_pci_read_reg(struct rcar_pcie *pcie, unsigned int reg)\n{\n\treturn readl(pcie->base + reg);\n}\n\nvoid rcar_rmw32(struct rcar_pcie *pcie, int where, u32 mask, u32 data)\n{\n\tunsigned int shift = BITS_PER_BYTE * (where & 3);\n\tu32 val = rcar_pci_read_reg(pcie, where & ~3);\n\n\tval &= ~(mask << shift);\n\tval |= data << shift;\n\trcar_pci_write_reg(pcie, val, where & ~3);\n}\n\nint rcar_pcie_wait_for_phyrdy(struct rcar_pcie *pcie)\n{\n\tunsigned int timeout = 10;\n\n\twhile (timeout--) {\n\t\tif (rcar_pci_read_reg(pcie, PCIEPHYSR) & PHYRDY)\n\t\t\treturn 0;\n\n\t\tmsleep(5);\n\t}\n\n\treturn -ETIMEDOUT;\n}\n\nint rcar_pcie_wait_for_dl(struct rcar_pcie *pcie)\n{\n\tunsigned int timeout = 10000;\n\n\twhile (timeout--) {\n\t\tif ((rcar_pci_read_reg(pcie, PCIETSTR) & DATA_LINK_ACTIVE))\n\t\t\treturn 0;\n\n\t\tudelay(5);\n\t\tcpu_relax();\n\t}\n\n\treturn -ETIMEDOUT;\n}\n\nvoid rcar_pcie_set_outbound(struct rcar_pcie *pcie, int win,\n\t\t\t    struct resource_entry *window)\n{\n\t \n\tstruct resource *res = window->res;\n\tresource_size_t res_start;\n\tresource_size_t size;\n\tu32 mask;\n\n\trcar_pci_write_reg(pcie, 0x00000000, PCIEPTCTLR(win));\n\n\t \n\tsize = resource_size(res);\n\tif (size > 128)\n\t\tmask = (roundup_pow_of_two(size) / SZ_128) - 1;\n\telse\n\t\tmask = 0x0;\n\trcar_pci_write_reg(pcie, mask << 7, PCIEPAMR(win));\n\n\tif (res->flags & IORESOURCE_IO)\n\t\tres_start = pci_pio_to_address(res->start) - window->offset;\n\telse\n\t\tres_start = res->start - window->offset;\n\n\trcar_pci_write_reg(pcie, upper_32_bits(res_start), PCIEPAUR(win));\n\trcar_pci_write_reg(pcie, lower_32_bits(res_start) & ~0x7F,\n\t\t\t   PCIEPALR(win));\n\n\t \n\tmask = PAR_ENABLE;\n\tif (res->flags & IORESOURCE_IO)\n\t\tmask |= IO_SPACE;\n\n\trcar_pci_write_reg(pcie, mask, PCIEPTCTLR(win));\n}\n\nvoid rcar_pcie_set_inbound(struct rcar_pcie *pcie, u64 cpu_addr,\n\t\t\t   u64 pci_addr, u64 flags, int idx, bool host)\n{\n\t \n\tif (host)\n\t\trcar_pci_write_reg(pcie, lower_32_bits(pci_addr),\n\t\t\t\t   PCIEPRAR(idx));\n\trcar_pci_write_reg(pcie, lower_32_bits(cpu_addr), PCIELAR(idx));\n\trcar_pci_write_reg(pcie, flags, PCIELAMR(idx));\n\n\tif (host)\n\t\trcar_pci_write_reg(pcie, upper_32_bits(pci_addr),\n\t\t\t\t   PCIEPRAR(idx + 1));\n\trcar_pci_write_reg(pcie, upper_32_bits(cpu_addr), PCIELAR(idx + 1));\n\trcar_pci_write_reg(pcie, 0, PCIELAMR(idx + 1));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}