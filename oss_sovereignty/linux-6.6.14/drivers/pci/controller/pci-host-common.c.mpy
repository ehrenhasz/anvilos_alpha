{
  "module_name": "pci-host-common.c",
  "hash_id": "740d926fe85eceed8a65e958d29dd9323ad87b329b9333921fe322dac46f71a5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pci/controller/pci-host-common.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_pci.h>\n#include <linux/pci-ecam.h>\n#include <linux/platform_device.h>\n\nstatic void gen_pci_unmap_cfg(void *ptr)\n{\n\tpci_ecam_free((struct pci_config_window *)ptr);\n}\n\nstatic struct pci_config_window *gen_pci_init(struct device *dev,\n\t\tstruct pci_host_bridge *bridge, const struct pci_ecam_ops *ops)\n{\n\tint err;\n\tstruct resource cfgres;\n\tstruct resource_entry *bus;\n\tstruct pci_config_window *cfg;\n\n\terr = of_address_to_resource(dev->of_node, 0, &cfgres);\n\tif (err) {\n\t\tdev_err(dev, \"missing \\\"reg\\\" property\\n\");\n\t\treturn ERR_PTR(err);\n\t}\n\n\tbus = resource_list_first_type(&bridge->windows, IORESOURCE_BUS);\n\tif (!bus)\n\t\treturn ERR_PTR(-ENODEV);\n\n\tcfg = pci_ecam_create(dev, &cfgres, bus->res, ops);\n\tif (IS_ERR(cfg))\n\t\treturn cfg;\n\n\terr = devm_add_action_or_reset(dev, gen_pci_unmap_cfg, cfg);\n\tif (err)\n\t\treturn ERR_PTR(err);\n\n\treturn cfg;\n}\n\nint pci_host_common_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct pci_host_bridge *bridge;\n\tstruct pci_config_window *cfg;\n\tconst struct pci_ecam_ops *ops;\n\n\tops = of_device_get_match_data(&pdev->dev);\n\tif (!ops)\n\t\treturn -ENODEV;\n\n\tbridge = devm_pci_alloc_host_bridge(dev, 0);\n\tif (!bridge)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, bridge);\n\n\tof_pci_check_probe_only();\n\n\t \n\tcfg = gen_pci_init(dev, bridge, ops);\n\tif (IS_ERR(cfg))\n\t\treturn PTR_ERR(cfg);\n\n\t \n\tif (!pci_has_flag(PCI_PROBE_ONLY))\n\t\tpci_add_flags(PCI_REASSIGN_ALL_BUS);\n\n\tbridge->sysdata = cfg;\n\tbridge->ops = (struct pci_ops *)&ops->pci_ops;\n\tbridge->msi_domain = true;\n\n\treturn pci_host_probe(bridge);\n}\nEXPORT_SYMBOL_GPL(pci_host_common_probe);\n\nint pci_host_common_remove(struct platform_device *pdev)\n{\n\tstruct pci_host_bridge *bridge = platform_get_drvdata(pdev);\n\n\tpci_lock_rescan_remove();\n\tpci_stop_root_bus(bridge->bus);\n\tpci_remove_root_bus(bridge->bus);\n\tpci_unlock_rescan_remove();\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(pci_host_common_remove);\n\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}