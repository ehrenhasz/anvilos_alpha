{
  "module_name": "pwm-twl-led.c",
  "hash_id": "ded03ec7e0aaa94193fef5a0576439f3c32215626ada6fda50e2abdca3f1fe07",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pwm/pwm-twl-led.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/pwm.h>\n#include <linux/mfd/twl.h>\n#include <linux/slab.h>\n\n \n\n#define TWL4030_LED_MAX\t\t0x7f\n#define TWL6030_LED_MAX\t\t0xff\n\n \n#define TWL4030_LEDEN_REG\t0x00\n#define TWL4030_PWMA_REG\t0x01\n\n#define TWL4030_LEDXON\t\t(1 << 0)\n#define TWL4030_LEDXPWM\t\t(1 << 4)\n#define TWL4030_LED_PINS\t(TWL4030_LEDXON | TWL4030_LEDXPWM)\n#define TWL4030_LED_TOGGLE(led, x)\t((x) << (led))\n\n \n#define TWL6030_LED_PWM_CTRL1\t0xf4\n#define TWL6030_LED_PWM_CTRL2\t0xf5\n\n#define TWL6040_LED_MODE_HW\t0x00\n#define TWL6040_LED_MODE_ON\t0x01\n#define TWL6040_LED_MODE_OFF\t0x02\n#define TWL6040_LED_MODE_MASK\t0x03\n\nstruct twl_pwmled_chip {\n\tstruct pwm_chip chip;\n\tstruct mutex mutex;\n};\n\nstatic inline struct twl_pwmled_chip *to_twl(struct pwm_chip *chip)\n{\n\treturn container_of(chip, struct twl_pwmled_chip, chip);\n}\n\nstatic int twl4030_pwmled_config(struct pwm_chip *chip, struct pwm_device *pwm,\n\t\t\t      int duty_ns, int period_ns)\n{\n\tint duty_cycle = DIV_ROUND_UP(duty_ns * TWL4030_LED_MAX, period_ns) + 1;\n\tu8 pwm_config[2] = { 1, 0 };\n\tint base, ret;\n\n\t \n\tif (duty_cycle == 1)\n\t\tduty_cycle = 2;\n\telse if (duty_cycle > TWL4030_LED_MAX)\n\t\tduty_cycle = 1;\n\n\tbase = pwm->hwpwm * 2 + TWL4030_PWMA_REG;\n\n\tpwm_config[1] = duty_cycle;\n\n\tret = twl_i2c_write(TWL4030_MODULE_LED, pwm_config, base, 2);\n\tif (ret < 0)\n\t\tdev_err(chip->dev, \"%s: Failed to configure PWM\\n\", pwm->label);\n\n\treturn ret;\n}\n\nstatic int twl4030_pwmled_enable(struct pwm_chip *chip, struct pwm_device *pwm)\n{\n\tstruct twl_pwmled_chip *twl = to_twl(chip);\n\tint ret;\n\tu8 val;\n\n\tmutex_lock(&twl->mutex);\n\tret = twl_i2c_read_u8(TWL4030_MODULE_LED, &val, TWL4030_LEDEN_REG);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"%s: Failed to read LEDEN\\n\", pwm->label);\n\t\tgoto out;\n\t}\n\n\tval |= TWL4030_LED_TOGGLE(pwm->hwpwm, TWL4030_LED_PINS);\n\n\tret = twl_i2c_write_u8(TWL4030_MODULE_LED, val, TWL4030_LEDEN_REG);\n\tif (ret < 0)\n\t\tdev_err(chip->dev, \"%s: Failed to enable PWM\\n\", pwm->label);\n\nout:\n\tmutex_unlock(&twl->mutex);\n\treturn ret;\n}\n\nstatic void twl4030_pwmled_disable(struct pwm_chip *chip,\n\t\t\t\t   struct pwm_device *pwm)\n{\n\tstruct twl_pwmled_chip *twl = to_twl(chip);\n\tint ret;\n\tu8 val;\n\n\tmutex_lock(&twl->mutex);\n\tret = twl_i2c_read_u8(TWL4030_MODULE_LED, &val, TWL4030_LEDEN_REG);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"%s: Failed to read LEDEN\\n\", pwm->label);\n\t\tgoto out;\n\t}\n\n\tval &= ~TWL4030_LED_TOGGLE(pwm->hwpwm, TWL4030_LED_PINS);\n\n\tret = twl_i2c_write_u8(TWL4030_MODULE_LED, val, TWL4030_LEDEN_REG);\n\tif (ret < 0)\n\t\tdev_err(chip->dev, \"%s: Failed to disable PWM\\n\", pwm->label);\n\nout:\n\tmutex_unlock(&twl->mutex);\n}\n\nstatic int twl4030_pwmled_apply(struct pwm_chip *chip, struct pwm_device *pwm,\n\t\t\t\tconst struct pwm_state *state)\n{\n\tint ret;\n\n\tif (state->polarity != PWM_POLARITY_NORMAL)\n\t\treturn -EINVAL;\n\n\tif (!state->enabled) {\n\t\tif (pwm->state.enabled)\n\t\t\ttwl4030_pwmled_disable(chip, pwm);\n\n\t\treturn 0;\n\t}\n\n\t \n\tret = twl4030_pwmled_config(pwm->chip, pwm,\n\t\t\t\t    state->duty_cycle, state->period);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!pwm->state.enabled)\n\t\tret = twl4030_pwmled_enable(chip, pwm);\n\n\treturn ret;\n}\n\n\nstatic const struct pwm_ops twl4030_pwmled_ops = {\n\t.apply = twl4030_pwmled_apply,\n\t.owner = THIS_MODULE,\n};\n\nstatic int twl6030_pwmled_config(struct pwm_chip *chip, struct pwm_device *pwm,\n\t\t\t      int duty_ns, int period_ns)\n{\n\tint duty_cycle = (duty_ns * TWL6030_LED_MAX) / period_ns;\n\tu8 on_time;\n\tint ret;\n\n\ton_time = duty_cycle & 0xff;\n\n\tret = twl_i2c_write_u8(TWL6030_MODULE_ID1, on_time,\n\t\t\t       TWL6030_LED_PWM_CTRL1);\n\tif (ret < 0)\n\t\tdev_err(chip->dev, \"%s: Failed to configure PWM\\n\", pwm->label);\n\n\treturn ret;\n}\n\nstatic int twl6030_pwmled_enable(struct pwm_chip *chip, struct pwm_device *pwm)\n{\n\tstruct twl_pwmled_chip *twl = to_twl(chip);\n\tint ret;\n\tu8 val;\n\n\tmutex_lock(&twl->mutex);\n\tret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, TWL6030_LED_PWM_CTRL2);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"%s: Failed to read PWM_CTRL2\\n\",\n\t\t\tpwm->label);\n\t\tgoto out;\n\t}\n\n\tval &= ~TWL6040_LED_MODE_MASK;\n\tval |= TWL6040_LED_MODE_ON;\n\n\tret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_LED_PWM_CTRL2);\n\tif (ret < 0)\n\t\tdev_err(chip->dev, \"%s: Failed to enable PWM\\n\", pwm->label);\n\nout:\n\tmutex_unlock(&twl->mutex);\n\treturn ret;\n}\n\nstatic void twl6030_pwmled_disable(struct pwm_chip *chip,\n\t\t\t\t   struct pwm_device *pwm)\n{\n\tstruct twl_pwmled_chip *twl = to_twl(chip);\n\tint ret;\n\tu8 val;\n\n\tmutex_lock(&twl->mutex);\n\tret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, TWL6030_LED_PWM_CTRL2);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"%s: Failed to read PWM_CTRL2\\n\",\n\t\t\tpwm->label);\n\t\tgoto out;\n\t}\n\n\tval &= ~TWL6040_LED_MODE_MASK;\n\tval |= TWL6040_LED_MODE_OFF;\n\n\tret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_LED_PWM_CTRL2);\n\tif (ret < 0)\n\t\tdev_err(chip->dev, \"%s: Failed to disable PWM\\n\", pwm->label);\n\nout:\n\tmutex_unlock(&twl->mutex);\n}\n\nstatic int twl6030_pwmled_apply(struct pwm_chip *chip, struct pwm_device *pwm,\n\t\t\t\tconst struct pwm_state *state)\n{\n\tint err;\n\n\tif (state->polarity != pwm->state.polarity)\n\t\treturn -EINVAL;\n\n\tif (!state->enabled) {\n\t\tif (pwm->state.enabled)\n\t\t\ttwl6030_pwmled_disable(chip, pwm);\n\n\t\treturn 0;\n\t}\n\n\terr = twl6030_pwmled_config(pwm->chip, pwm,\n\t\t\t\t    state->duty_cycle, state->period);\n\tif (err)\n\t\treturn err;\n\n\tif (!pwm->state.enabled)\n\t\terr = twl6030_pwmled_enable(chip, pwm);\n\n\treturn err;\n}\n\nstatic int twl6030_pwmled_request(struct pwm_chip *chip, struct pwm_device *pwm)\n{\n\tstruct twl_pwmled_chip *twl = to_twl(chip);\n\tint ret;\n\tu8 val;\n\n\tmutex_lock(&twl->mutex);\n\tret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, TWL6030_LED_PWM_CTRL2);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"%s: Failed to read PWM_CTRL2\\n\",\n\t\t\tpwm->label);\n\t\tgoto out;\n\t}\n\n\tval &= ~TWL6040_LED_MODE_MASK;\n\tval |= TWL6040_LED_MODE_OFF;\n\n\tret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_LED_PWM_CTRL2);\n\tif (ret < 0)\n\t\tdev_err(chip->dev, \"%s: Failed to request PWM\\n\", pwm->label);\n\nout:\n\tmutex_unlock(&twl->mutex);\n\treturn ret;\n}\n\nstatic void twl6030_pwmled_free(struct pwm_chip *chip, struct pwm_device *pwm)\n{\n\tstruct twl_pwmled_chip *twl = to_twl(chip);\n\tint ret;\n\tu8 val;\n\n\tmutex_lock(&twl->mutex);\n\tret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, TWL6030_LED_PWM_CTRL2);\n\tif (ret < 0) {\n\t\tdev_err(chip->dev, \"%s: Failed to read PWM_CTRL2\\n\",\n\t\t\tpwm->label);\n\t\tgoto out;\n\t}\n\n\tval &= ~TWL6040_LED_MODE_MASK;\n\tval |= TWL6040_LED_MODE_HW;\n\n\tret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_LED_PWM_CTRL2);\n\tif (ret < 0)\n\t\tdev_err(chip->dev, \"%s: Failed to free PWM\\n\", pwm->label);\n\nout:\n\tmutex_unlock(&twl->mutex);\n}\n\nstatic const struct pwm_ops twl6030_pwmled_ops = {\n\t.apply = twl6030_pwmled_apply,\n\t.request = twl6030_pwmled_request,\n\t.free = twl6030_pwmled_free,\n\t.owner = THIS_MODULE,\n};\n\nstatic int twl_pwmled_probe(struct platform_device *pdev)\n{\n\tstruct twl_pwmled_chip *twl;\n\n\ttwl = devm_kzalloc(&pdev->dev, sizeof(*twl), GFP_KERNEL);\n\tif (!twl)\n\t\treturn -ENOMEM;\n\n\tif (twl_class_is_4030()) {\n\t\ttwl->chip.ops = &twl4030_pwmled_ops;\n\t\ttwl->chip.npwm = 2;\n\t} else {\n\t\ttwl->chip.ops = &twl6030_pwmled_ops;\n\t\ttwl->chip.npwm = 1;\n\t}\n\n\ttwl->chip.dev = &pdev->dev;\n\n\tmutex_init(&twl->mutex);\n\n\treturn devm_pwmchip_add(&pdev->dev, &twl->chip);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id twl_pwmled_of_match[] = {\n\t{ .compatible = \"ti,twl4030-pwmled\" },\n\t{ .compatible = \"ti,twl6030-pwmled\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, twl_pwmled_of_match);\n#endif\n\nstatic struct platform_driver twl_pwmled_driver = {\n\t.driver = {\n\t\t.name = \"twl-pwmled\",\n\t\t.of_match_table = of_match_ptr(twl_pwmled_of_match),\n\t},\n\t.probe = twl_pwmled_probe,\n};\nmodule_platform_driver(twl_pwmled_driver);\n\nMODULE_AUTHOR(\"Peter Ujfalusi <peter.ujfalusi@ti.com>\");\nMODULE_DESCRIPTION(\"PWM driver for TWL4030 and TWL6030 LED outputs\");\nMODULE_ALIAS(\"platform:twl-pwmled\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}