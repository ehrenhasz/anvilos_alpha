{
  "module_name": "pwm-iqs620a.c",
  "hash_id": "d9866a36730241b55e0681a948444e3d860ad9fdd5b3870dbdcc0d2fdcf642bf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pwm/pwm-iqs620a.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/mfd/iqs62x.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/notifier.h>\n#include <linux/platform_device.h>\n#include <linux/pwm.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\n#define IQS620_PWR_SETTINGS\t\t\t0xd2\n#define IQS620_PWR_SETTINGS_PWM_OUT\t\tBIT(7)\n\n#define IQS620_PWM_DUTY_CYCLE\t\t\t0xd8\n\n#define IQS620_PWM_PERIOD_NS\t\t\t1000000\n\nstruct iqs620_pwm_private {\n\tstruct iqs62x_core *iqs62x;\n\tstruct pwm_chip chip;\n\tstruct notifier_block notifier;\n\tstruct mutex lock;\n\tunsigned int duty_scale;\n};\n\nstatic int iqs620_pwm_init(struct iqs620_pwm_private *iqs620_pwm,\n\t\t\t   unsigned int duty_scale)\n{\n\tstruct iqs62x_core *iqs62x = iqs620_pwm->iqs62x;\n\tint ret;\n\n\tif (!duty_scale)\n\t\treturn regmap_clear_bits(iqs62x->regmap, IQS620_PWR_SETTINGS,\n\t\t\t\t\t IQS620_PWR_SETTINGS_PWM_OUT);\n\n\tret = regmap_write(iqs62x->regmap, IQS620_PWM_DUTY_CYCLE,\n\t\t\t   duty_scale - 1);\n\tif (ret)\n\t\treturn ret;\n\n\treturn regmap_set_bits(iqs62x->regmap, IQS620_PWR_SETTINGS,\n\t\t\t       IQS620_PWR_SETTINGS_PWM_OUT);\n}\n\nstatic int iqs620_pwm_apply(struct pwm_chip *chip, struct pwm_device *pwm,\n\t\t\t    const struct pwm_state *state)\n{\n\tstruct iqs620_pwm_private *iqs620_pwm;\n\tunsigned int duty_cycle;\n\tunsigned int duty_scale;\n\tint ret;\n\n\tif (state->polarity != PWM_POLARITY_NORMAL)\n\t\treturn -EINVAL;\n\n\tif (state->period < IQS620_PWM_PERIOD_NS)\n\t\treturn -EINVAL;\n\n\tiqs620_pwm = container_of(chip, struct iqs620_pwm_private, chip);\n\n\t \n\tduty_cycle = min_t(u64, state->duty_cycle, IQS620_PWM_PERIOD_NS);\n\tduty_scale = duty_cycle * 256 / IQS620_PWM_PERIOD_NS;\n\n\tif (!state->enabled)\n\t\tduty_scale = 0;\n\n\tmutex_lock(&iqs620_pwm->lock);\n\n\tret = iqs620_pwm_init(iqs620_pwm, duty_scale);\n\tif (!ret)\n\t\tiqs620_pwm->duty_scale = duty_scale;\n\n\tmutex_unlock(&iqs620_pwm->lock);\n\n\treturn ret;\n}\n\nstatic int iqs620_pwm_get_state(struct pwm_chip *chip, struct pwm_device *pwm,\n\t\t\t\tstruct pwm_state *state)\n{\n\tstruct iqs620_pwm_private *iqs620_pwm;\n\n\tiqs620_pwm = container_of(chip, struct iqs620_pwm_private, chip);\n\n\tmutex_lock(&iqs620_pwm->lock);\n\n\t \n\tstate->enabled = iqs620_pwm->duty_scale > 0;\n\tstate->duty_cycle = DIV_ROUND_UP(iqs620_pwm->duty_scale *\n\t\t\t\t\t IQS620_PWM_PERIOD_NS, 256);\n\n\tmutex_unlock(&iqs620_pwm->lock);\n\n\tstate->period = IQS620_PWM_PERIOD_NS;\n\tstate->polarity = PWM_POLARITY_NORMAL;\n\n\treturn 0;\n}\n\nstatic int iqs620_pwm_notifier(struct notifier_block *notifier,\n\t\t\t       unsigned long event_flags, void *context)\n{\n\tstruct iqs620_pwm_private *iqs620_pwm;\n\tint ret;\n\n\tif (!(event_flags & BIT(IQS62X_EVENT_SYS_RESET)))\n\t\treturn NOTIFY_DONE;\n\n\tiqs620_pwm = container_of(notifier, struct iqs620_pwm_private,\n\t\t\t\t  notifier);\n\n\tmutex_lock(&iqs620_pwm->lock);\n\n\t \n\tret = iqs620_pwm_init(iqs620_pwm, iqs620_pwm->duty_scale);\n\n\tmutex_unlock(&iqs620_pwm->lock);\n\n\tif (ret) {\n\t\tdev_err(iqs620_pwm->chip.dev,\n\t\t\t\"Failed to re-initialize device: %d\\n\", ret);\n\t\treturn NOTIFY_BAD;\n\t}\n\n\treturn NOTIFY_OK;\n}\n\nstatic const struct pwm_ops iqs620_pwm_ops = {\n\t.apply = iqs620_pwm_apply,\n\t.get_state = iqs620_pwm_get_state,\n\t.owner = THIS_MODULE,\n};\n\nstatic void iqs620_pwm_notifier_unregister(void *context)\n{\n\tstruct iqs620_pwm_private *iqs620_pwm = context;\n\tint ret;\n\n\tret = blocking_notifier_chain_unregister(&iqs620_pwm->iqs62x->nh,\n\t\t\t\t\t\t &iqs620_pwm->notifier);\n\tif (ret)\n\t\tdev_err(iqs620_pwm->chip.dev,\n\t\t\t\"Failed to unregister notifier: %d\\n\", ret);\n}\n\nstatic int iqs620_pwm_probe(struct platform_device *pdev)\n{\n\tstruct iqs62x_core *iqs62x = dev_get_drvdata(pdev->dev.parent);\n\tstruct iqs620_pwm_private *iqs620_pwm;\n\tunsigned int val;\n\tint ret;\n\n\tiqs620_pwm = devm_kzalloc(&pdev->dev, sizeof(*iqs620_pwm), GFP_KERNEL);\n\tif (!iqs620_pwm)\n\t\treturn -ENOMEM;\n\n\tiqs620_pwm->iqs62x = iqs62x;\n\n\tret = regmap_read(iqs62x->regmap, IQS620_PWR_SETTINGS, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tif (val & IQS620_PWR_SETTINGS_PWM_OUT) {\n\t\tret = regmap_read(iqs62x->regmap, IQS620_PWM_DUTY_CYCLE, &val);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tiqs620_pwm->duty_scale = val + 1;\n\t}\n\n\tiqs620_pwm->chip.dev = &pdev->dev;\n\tiqs620_pwm->chip.ops = &iqs620_pwm_ops;\n\tiqs620_pwm->chip.npwm = 1;\n\n\tmutex_init(&iqs620_pwm->lock);\n\n\tiqs620_pwm->notifier.notifier_call = iqs620_pwm_notifier;\n\tret = blocking_notifier_chain_register(&iqs620_pwm->iqs62x->nh,\n\t\t\t\t\t       &iqs620_pwm->notifier);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to register notifier: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_add_action_or_reset(&pdev->dev,\n\t\t\t\t       iqs620_pwm_notifier_unregister,\n\t\t\t\t       iqs620_pwm);\n\tif (ret)\n\t\treturn ret;\n\n\tret = devm_pwmchip_add(&pdev->dev, &iqs620_pwm->chip);\n\tif (ret)\n\t\tdev_err(&pdev->dev, \"Failed to add device: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic struct platform_driver iqs620_pwm_platform_driver = {\n\t.driver = {\n\t\t.name = \"iqs620a-pwm\",\n\t},\n\t.probe = iqs620_pwm_probe,\n};\nmodule_platform_driver(iqs620_pwm_platform_driver);\n\nMODULE_AUTHOR(\"Jeff LaBundy <jeff@labundy.com>\");\nMODULE_DESCRIPTION(\"Azoteq IQS620A PWM Generator\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:iqs620a-pwm\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}