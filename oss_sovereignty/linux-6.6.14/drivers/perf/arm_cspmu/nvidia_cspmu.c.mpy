{
  "module_name": "nvidia_cspmu.c",
  "hash_id": "cde5205307c6d2815a95e448d0114ab7ef1f702b17556a3517a546fc0248fd76",
  "original_prompt": "Ingested from linux-6.6.14/drivers/perf/arm_cspmu/nvidia_cspmu.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/topology.h>\n\n#include \"nvidia_cspmu.h\"\n\n#define NV_PCIE_PORT_COUNT           10ULL\n#define NV_PCIE_FILTER_ID_MASK       GENMASK_ULL(NV_PCIE_PORT_COUNT - 1, 0)\n\n#define NV_NVL_C2C_PORT_COUNT        2ULL\n#define NV_NVL_C2C_FILTER_ID_MASK    GENMASK_ULL(NV_NVL_C2C_PORT_COUNT - 1, 0)\n\n#define NV_CNVL_PORT_COUNT           4ULL\n#define NV_CNVL_FILTER_ID_MASK       GENMASK_ULL(NV_CNVL_PORT_COUNT - 1, 0)\n\n#define NV_GENERIC_FILTER_ID_MASK    GENMASK_ULL(31, 0)\n\n#define NV_PRODID_MASK               GENMASK(31, 0)\n\n#define NV_FORMAT_NAME_GENERIC\t0\n\n#define to_nv_cspmu_ctx(cspmu)\t((struct nv_cspmu_ctx *)(cspmu->impl.ctx))\n\n#define NV_CSPMU_EVENT_ATTR_4_INNER(_pref, _num, _suff, _config)\t\\\n\tARM_CSPMU_EVENT_ATTR(_pref##_num##_suff, _config)\n\n#define NV_CSPMU_EVENT_ATTR_4(_pref, _suff, _config)\t\t\t\\\n\tNV_CSPMU_EVENT_ATTR_4_INNER(_pref, _0_, _suff, _config),\t\\\n\tNV_CSPMU_EVENT_ATTR_4_INNER(_pref, _1_, _suff, _config + 1),\t\\\n\tNV_CSPMU_EVENT_ATTR_4_INNER(_pref, _2_, _suff, _config + 2),\t\\\n\tNV_CSPMU_EVENT_ATTR_4_INNER(_pref, _3_, _suff, _config + 3)\n\nstruct nv_cspmu_ctx {\n\tconst char *name;\n\tu32 filter_mask;\n\tu32 filter_default_val;\n\tstruct attribute **event_attr;\n\tstruct attribute **format_attr;\n};\n\nstatic struct attribute *scf_pmu_event_attrs[] = {\n\tARM_CSPMU_EVENT_ATTR(bus_cycles,\t\t\t0x1d),\n\n\tARM_CSPMU_EVENT_ATTR(scf_cache_allocate,\t\t0xF0),\n\tARM_CSPMU_EVENT_ATTR(scf_cache_refill,\t\t\t0xF1),\n\tARM_CSPMU_EVENT_ATTR(scf_cache,\t\t\t\t0xF2),\n\tARM_CSPMU_EVENT_ATTR(scf_cache_wb,\t\t\t0xF3),\n\n\tNV_CSPMU_EVENT_ATTR_4(socket, rd_data,\t\t\t0x101),\n\tNV_CSPMU_EVENT_ATTR_4(socket, dl_rsp,\t\t\t0x105),\n\tNV_CSPMU_EVENT_ATTR_4(socket, wb_data,\t\t\t0x109),\n\tNV_CSPMU_EVENT_ATTR_4(socket, ev_rsp,\t\t\t0x10d),\n\tNV_CSPMU_EVENT_ATTR_4(socket, prb_data,\t\t\t0x111),\n\n\tNV_CSPMU_EVENT_ATTR_4(socket, rd_outstanding,\t\t0x115),\n\tNV_CSPMU_EVENT_ATTR_4(socket, dl_outstanding,\t\t0x119),\n\tNV_CSPMU_EVENT_ATTR_4(socket, wb_outstanding,\t\t0x11d),\n\tNV_CSPMU_EVENT_ATTR_4(socket, wr_outstanding,\t\t0x121),\n\tNV_CSPMU_EVENT_ATTR_4(socket, ev_outstanding,\t\t0x125),\n\tNV_CSPMU_EVENT_ATTR_4(socket, prb_outstanding,\t\t0x129),\n\n\tNV_CSPMU_EVENT_ATTR_4(socket, rd_access,\t\t0x12d),\n\tNV_CSPMU_EVENT_ATTR_4(socket, dl_access,\t\t0x131),\n\tNV_CSPMU_EVENT_ATTR_4(socket, wb_access,\t\t0x135),\n\tNV_CSPMU_EVENT_ATTR_4(socket, wr_access,\t\t0x139),\n\tNV_CSPMU_EVENT_ATTR_4(socket, ev_access,\t\t0x13d),\n\tNV_CSPMU_EVENT_ATTR_4(socket, prb_access,\t\t0x141),\n\n\tNV_CSPMU_EVENT_ATTR_4(ocu, gmem_rd_data,\t\t0x145),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, gmem_rd_access,\t\t0x149),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, gmem_wb_access,\t\t0x14d),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, gmem_rd_outstanding,\t\t0x151),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, gmem_wr_outstanding,\t\t0x155),\n\n\tNV_CSPMU_EVENT_ATTR_4(ocu, rem_rd_data,\t\t\t0x159),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, rem_rd_access,\t\t0x15d),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, rem_wb_access,\t\t0x161),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, rem_rd_outstanding,\t\t0x165),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, rem_wr_outstanding,\t\t0x169),\n\n\tARM_CSPMU_EVENT_ATTR(gmem_rd_data,\t\t\t0x16d),\n\tARM_CSPMU_EVENT_ATTR(gmem_rd_access,\t\t\t0x16e),\n\tARM_CSPMU_EVENT_ATTR(gmem_rd_outstanding,\t\t0x16f),\n\tARM_CSPMU_EVENT_ATTR(gmem_dl_rsp,\t\t\t0x170),\n\tARM_CSPMU_EVENT_ATTR(gmem_dl_access,\t\t\t0x171),\n\tARM_CSPMU_EVENT_ATTR(gmem_dl_outstanding,\t\t0x172),\n\tARM_CSPMU_EVENT_ATTR(gmem_wb_data,\t\t\t0x173),\n\tARM_CSPMU_EVENT_ATTR(gmem_wb_access,\t\t\t0x174),\n\tARM_CSPMU_EVENT_ATTR(gmem_wb_outstanding,\t\t0x175),\n\tARM_CSPMU_EVENT_ATTR(gmem_ev_rsp,\t\t\t0x176),\n\tARM_CSPMU_EVENT_ATTR(gmem_ev_access,\t\t\t0x177),\n\tARM_CSPMU_EVENT_ATTR(gmem_ev_outstanding,\t\t0x178),\n\tARM_CSPMU_EVENT_ATTR(gmem_wr_data,\t\t\t0x179),\n\tARM_CSPMU_EVENT_ATTR(gmem_wr_outstanding,\t\t0x17a),\n\tARM_CSPMU_EVENT_ATTR(gmem_wr_access,\t\t\t0x17b),\n\n\tNV_CSPMU_EVENT_ATTR_4(socket, wr_data,\t\t\t0x17c),\n\n\tNV_CSPMU_EVENT_ATTR_4(ocu, gmem_wr_data,\t\t0x180),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, gmem_wb_data,\t\t0x184),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, gmem_wr_access,\t\t0x188),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, gmem_wb_outstanding,\t\t0x18c),\n\n\tNV_CSPMU_EVENT_ATTR_4(ocu, rem_wr_data,\t\t\t0x190),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, rem_wb_data,\t\t\t0x194),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, rem_wr_access,\t\t0x198),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, rem_wb_outstanding,\t\t0x19c),\n\n\tARM_CSPMU_EVENT_ATTR(gmem_wr_total_bytes,\t\t0x1a0),\n\tARM_CSPMU_EVENT_ATTR(remote_socket_wr_total_bytes,\t0x1a1),\n\tARM_CSPMU_EVENT_ATTR(remote_socket_rd_data,\t\t0x1a2),\n\tARM_CSPMU_EVENT_ATTR(remote_socket_rd_outstanding,\t0x1a3),\n\tARM_CSPMU_EVENT_ATTR(remote_socket_rd_access,\t\t0x1a4),\n\n\tARM_CSPMU_EVENT_ATTR(cmem_rd_data,\t\t\t0x1a5),\n\tARM_CSPMU_EVENT_ATTR(cmem_rd_access,\t\t\t0x1a6),\n\tARM_CSPMU_EVENT_ATTR(cmem_rd_outstanding,\t\t0x1a7),\n\tARM_CSPMU_EVENT_ATTR(cmem_dl_rsp,\t\t\t0x1a8),\n\tARM_CSPMU_EVENT_ATTR(cmem_dl_access,\t\t\t0x1a9),\n\tARM_CSPMU_EVENT_ATTR(cmem_dl_outstanding,\t\t0x1aa),\n\tARM_CSPMU_EVENT_ATTR(cmem_wb_data,\t\t\t0x1ab),\n\tARM_CSPMU_EVENT_ATTR(cmem_wb_access,\t\t\t0x1ac),\n\tARM_CSPMU_EVENT_ATTR(cmem_wb_outstanding,\t\t0x1ad),\n\tARM_CSPMU_EVENT_ATTR(cmem_ev_rsp,\t\t\t0x1ae),\n\tARM_CSPMU_EVENT_ATTR(cmem_ev_access,\t\t\t0x1af),\n\tARM_CSPMU_EVENT_ATTR(cmem_ev_outstanding,\t\t0x1b0),\n\tARM_CSPMU_EVENT_ATTR(cmem_wr_data,\t\t\t0x1b1),\n\tARM_CSPMU_EVENT_ATTR(cmem_wr_outstanding,\t\t0x1b2),\n\n\tNV_CSPMU_EVENT_ATTR_4(ocu, cmem_rd_data,\t\t0x1b3),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, cmem_rd_access,\t\t0x1b7),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, cmem_wb_access,\t\t0x1bb),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, cmem_rd_outstanding,\t\t0x1bf),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, cmem_wr_outstanding,\t\t0x1c3),\n\n\tARM_CSPMU_EVENT_ATTR(ocu_prb_access,\t\t\t0x1c7),\n\tARM_CSPMU_EVENT_ATTR(ocu_prb_data,\t\t\t0x1c8),\n\tARM_CSPMU_EVENT_ATTR(ocu_prb_outstanding,\t\t0x1c9),\n\n\tARM_CSPMU_EVENT_ATTR(cmem_wr_access,\t\t\t0x1ca),\n\n\tNV_CSPMU_EVENT_ATTR_4(ocu, cmem_wr_access,\t\t0x1cb),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, cmem_wb_data,\t\t0x1cf),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, cmem_wr_data,\t\t0x1d3),\n\tNV_CSPMU_EVENT_ATTR_4(ocu, cmem_wb_outstanding,\t\t0x1d7),\n\n\tARM_CSPMU_EVENT_ATTR(cmem_wr_total_bytes,\t\t0x1db),\n\n\tARM_CSPMU_EVENT_ATTR(cycles, ARM_CSPMU_EVT_CYCLES_DEFAULT),\n\tNULL,\n};\n\nstatic struct attribute *mcf_pmu_event_attrs[] = {\n\tARM_CSPMU_EVENT_ATTR(rd_bytes_loc,\t\t\t0x0),\n\tARM_CSPMU_EVENT_ATTR(rd_bytes_rem,\t\t\t0x1),\n\tARM_CSPMU_EVENT_ATTR(wr_bytes_loc,\t\t\t0x2),\n\tARM_CSPMU_EVENT_ATTR(wr_bytes_rem,\t\t\t0x3),\n\tARM_CSPMU_EVENT_ATTR(total_bytes_loc,\t\t\t0x4),\n\tARM_CSPMU_EVENT_ATTR(total_bytes_rem,\t\t\t0x5),\n\tARM_CSPMU_EVENT_ATTR(rd_req_loc,\t\t\t0x6),\n\tARM_CSPMU_EVENT_ATTR(rd_req_rem,\t\t\t0x7),\n\tARM_CSPMU_EVENT_ATTR(wr_req_loc,\t\t\t0x8),\n\tARM_CSPMU_EVENT_ATTR(wr_req_rem,\t\t\t0x9),\n\tARM_CSPMU_EVENT_ATTR(total_req_loc,\t\t\t0xa),\n\tARM_CSPMU_EVENT_ATTR(total_req_rem,\t\t\t0xb),\n\tARM_CSPMU_EVENT_ATTR(rd_cum_outs_loc,\t\t\t0xc),\n\tARM_CSPMU_EVENT_ATTR(rd_cum_outs_rem,\t\t\t0xd),\n\tARM_CSPMU_EVENT_ATTR(cycles, ARM_CSPMU_EVT_CYCLES_DEFAULT),\n\tNULL,\n};\n\nstatic struct attribute *generic_pmu_event_attrs[] = {\n\tARM_CSPMU_EVENT_ATTR(cycles, ARM_CSPMU_EVT_CYCLES_DEFAULT),\n\tNULL,\n};\n\nstatic struct attribute *scf_pmu_format_attrs[] = {\n\tARM_CSPMU_FORMAT_EVENT_ATTR,\n\tNULL,\n};\n\nstatic struct attribute *pcie_pmu_format_attrs[] = {\n\tARM_CSPMU_FORMAT_EVENT_ATTR,\n\tARM_CSPMU_FORMAT_ATTR(root_port, \"config1:0-9\"),\n\tNULL,\n};\n\nstatic struct attribute *nvlink_c2c_pmu_format_attrs[] = {\n\tARM_CSPMU_FORMAT_EVENT_ATTR,\n\tNULL,\n};\n\nstatic struct attribute *cnvlink_pmu_format_attrs[] = {\n\tARM_CSPMU_FORMAT_EVENT_ATTR,\n\tARM_CSPMU_FORMAT_ATTR(rem_socket, \"config1:0-3\"),\n\tNULL,\n};\n\nstatic struct attribute *generic_pmu_format_attrs[] = {\n\tARM_CSPMU_FORMAT_EVENT_ATTR,\n\tARM_CSPMU_FORMAT_FILTER_ATTR,\n\tNULL,\n};\n\nstatic struct attribute **\nnv_cspmu_get_event_attrs(const struct arm_cspmu *cspmu)\n{\n\tconst struct nv_cspmu_ctx *ctx = to_nv_cspmu_ctx(cspmu);\n\n\treturn ctx->event_attr;\n}\n\nstatic struct attribute **\nnv_cspmu_get_format_attrs(const struct arm_cspmu *cspmu)\n{\n\tconst struct nv_cspmu_ctx *ctx = to_nv_cspmu_ctx(cspmu);\n\n\treturn ctx->format_attr;\n}\n\nstatic const char *\nnv_cspmu_get_name(const struct arm_cspmu *cspmu)\n{\n\tconst struct nv_cspmu_ctx *ctx = to_nv_cspmu_ctx(cspmu);\n\n\treturn ctx->name;\n}\n\nstatic u32 nv_cspmu_event_filter(const struct perf_event *event)\n{\n\tconst struct nv_cspmu_ctx *ctx =\n\t\tto_nv_cspmu_ctx(to_arm_cspmu(event->pmu));\n\n\tif (ctx->filter_mask == 0)\n\t\treturn ctx->filter_default_val;\n\n\treturn event->attr.config1 & ctx->filter_mask;\n}\n\nenum nv_cspmu_name_fmt {\n\tNAME_FMT_GENERIC,\n\tNAME_FMT_SOCKET\n};\n\nstruct nv_cspmu_match {\n\tu32 prodid;\n\tu32 prodid_mask;\n\tu64 filter_mask;\n\tu32 filter_default_val;\n\tconst char *name_pattern;\n\tenum nv_cspmu_name_fmt name_fmt;\n\tstruct attribute **event_attr;\n\tstruct attribute **format_attr;\n};\n\nstatic const struct nv_cspmu_match nv_cspmu_match[] = {\n\t{\n\t  .prodid = 0x103,\n\t  .prodid_mask = NV_PRODID_MASK,\n\t  .filter_mask = NV_PCIE_FILTER_ID_MASK,\n\t  .filter_default_val = NV_PCIE_FILTER_ID_MASK,\n\t  .name_pattern = \"nvidia_pcie_pmu_%u\",\n\t  .name_fmt = NAME_FMT_SOCKET,\n\t  .event_attr = mcf_pmu_event_attrs,\n\t  .format_attr = pcie_pmu_format_attrs\n\t},\n\t{\n\t  .prodid = 0x104,\n\t  .prodid_mask = NV_PRODID_MASK,\n\t  .filter_mask = 0x0,\n\t  .filter_default_val = NV_NVL_C2C_FILTER_ID_MASK,\n\t  .name_pattern = \"nvidia_nvlink_c2c1_pmu_%u\",\n\t  .name_fmt = NAME_FMT_SOCKET,\n\t  .event_attr = mcf_pmu_event_attrs,\n\t  .format_attr = nvlink_c2c_pmu_format_attrs\n\t},\n\t{\n\t  .prodid = 0x105,\n\t  .prodid_mask = NV_PRODID_MASK,\n\t  .filter_mask = 0x0,\n\t  .filter_default_val = NV_NVL_C2C_FILTER_ID_MASK,\n\t  .name_pattern = \"nvidia_nvlink_c2c0_pmu_%u\",\n\t  .name_fmt = NAME_FMT_SOCKET,\n\t  .event_attr = mcf_pmu_event_attrs,\n\t  .format_attr = nvlink_c2c_pmu_format_attrs\n\t},\n\t{\n\t  .prodid = 0x106,\n\t  .prodid_mask = NV_PRODID_MASK,\n\t  .filter_mask = NV_CNVL_FILTER_ID_MASK,\n\t  .filter_default_val = NV_CNVL_FILTER_ID_MASK,\n\t  .name_pattern = \"nvidia_cnvlink_pmu_%u\",\n\t  .name_fmt = NAME_FMT_SOCKET,\n\t  .event_attr = mcf_pmu_event_attrs,\n\t  .format_attr = cnvlink_pmu_format_attrs\n\t},\n\t{\n\t  .prodid = 0x2CF,\n\t  .prodid_mask = NV_PRODID_MASK,\n\t  .filter_mask = 0x0,\n\t  .filter_default_val = 0x0,\n\t  .name_pattern = \"nvidia_scf_pmu_%u\",\n\t  .name_fmt = NAME_FMT_SOCKET,\n\t  .event_attr = scf_pmu_event_attrs,\n\t  .format_attr = scf_pmu_format_attrs\n\t},\n\t{\n\t  .prodid = 0,\n\t  .prodid_mask = 0,\n\t  .filter_mask = NV_GENERIC_FILTER_ID_MASK,\n\t  .filter_default_val = NV_GENERIC_FILTER_ID_MASK,\n\t  .name_pattern = \"nvidia_uncore_pmu_%u\",\n\t  .name_fmt = NAME_FMT_GENERIC,\n\t  .event_attr = generic_pmu_event_attrs,\n\t  .format_attr = generic_pmu_format_attrs\n\t},\n};\n\nstatic char *nv_cspmu_format_name(const struct arm_cspmu *cspmu,\n\t\t\t\t  const struct nv_cspmu_match *match)\n{\n\tchar *name;\n\tstruct device *dev = cspmu->dev;\n\n\tstatic atomic_t pmu_generic_idx = {0};\n\n\tswitch (match->name_fmt) {\n\tcase NAME_FMT_SOCKET: {\n\t\tconst int cpu = cpumask_first(&cspmu->associated_cpus);\n\t\tconst int socket = cpu_to_node(cpu);\n\n\t\tname = devm_kasprintf(dev, GFP_KERNEL, match->name_pattern,\n\t\t\t\t       socket);\n\t\tbreak;\n\t}\n\tcase NAME_FMT_GENERIC:\n\t\tname = devm_kasprintf(dev, GFP_KERNEL, match->name_pattern,\n\t\t\t\t       atomic_fetch_inc(&pmu_generic_idx));\n\t\tbreak;\n\tdefault:\n\t\tname = NULL;\n\t\tbreak;\n\t}\n\n\treturn name;\n}\n\nint nv_cspmu_init_ops(struct arm_cspmu *cspmu)\n{\n\tu32 prodid;\n\tstruct nv_cspmu_ctx *ctx;\n\tstruct device *dev = cspmu->dev;\n\tstruct arm_cspmu_impl_ops *impl_ops = &cspmu->impl.ops;\n\tconst struct nv_cspmu_match *match = nv_cspmu_match;\n\n\tctx = devm_kzalloc(dev, sizeof(struct nv_cspmu_ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tprodid = FIELD_GET(ARM_CSPMU_PMIIDR_PRODUCTID, cspmu->impl.pmiidr);\n\n\t \n\tfor (; match->prodid; match++) {\n\t\tconst u32 prodid_mask = match->prodid_mask;\n\n\t\tif ((match->prodid & prodid_mask) == (prodid & prodid_mask))\n\t\t\tbreak;\n\t}\n\n\tctx->name\t\t= nv_cspmu_format_name(cspmu, match);\n\tctx->filter_mask\t= match->filter_mask;\n\tctx->filter_default_val = match->filter_default_val;\n\tctx->event_attr\t\t= match->event_attr;\n\tctx->format_attr\t= match->format_attr;\n\n\tcspmu->impl.ctx = ctx;\n\n\t \n\timpl_ops->event_filter\t\t\t= nv_cspmu_event_filter;\n\timpl_ops->get_event_attrs\t\t= nv_cspmu_get_event_attrs;\n\timpl_ops->get_format_attrs\t\t= nv_cspmu_get_format_attrs;\n\timpl_ops->get_name\t\t\t= nv_cspmu_get_name;\n\n\t \n\timpl_ops->event_type\t\t\t= NULL;\n\timpl_ops->event_attr_is_visible\t\t= NULL;\n\timpl_ops->get_identifier\t\t= NULL;\n\timpl_ops->is_cycle_counter_event\t= NULL;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(nv_cspmu_init_ops);\n\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}