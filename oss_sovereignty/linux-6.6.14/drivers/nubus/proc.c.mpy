{
  "module_name": "proc.c",
  "hash_id": "5ebf57d952d0564c1eb1ec11bae1c2dcc3104bb6987b75c14544b22bc45c0754",
  "original_prompt": "Ingested from linux-6.6.14/drivers/nubus/proc.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/nubus.h>\n#include <linux/proc_fs.h>\n#include <linux/seq_file.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/uaccess.h>\n#include <asm/byteorder.h>\n\n \n\nstatic int\nnubus_devices_proc_show(struct seq_file *m, void *v)\n{\n\tstruct nubus_rsrc *fres;\n\n\tfor_each_func_rsrc(fres)\n\t\tseq_printf(m, \"%x\\t%04x %04x %04x %04x\\t%08lx\\n\",\n\t\t\t   fres->board->slot, fres->category, fres->type,\n\t\t\t   fres->dr_sw, fres->dr_hw, fres->board->slot_addr);\n\treturn 0;\n}\n\nstatic struct proc_dir_entry *proc_bus_nubus_dir;\n\n \n\nstruct proc_dir_entry *nubus_proc_add_board(struct nubus_board *board)\n{\n\tchar name[2];\n\n\tif (!proc_bus_nubus_dir || !nubus_populate_procfs)\n\t\treturn NULL;\n\tsnprintf(name, sizeof(name), \"%x\", board->slot);\n\treturn proc_mkdir(name, proc_bus_nubus_dir);\n}\n\n \n\nstruct proc_dir_entry *nubus_proc_add_rsrc_dir(struct proc_dir_entry *procdir,\n\t\t\t\t\t       const struct nubus_dirent *ent,\n\t\t\t\t\t       struct nubus_board *board)\n{\n\tchar name[9];\n\tint lanes = board->lanes;\n\n\tif (!procdir || !nubus_populate_procfs)\n\t\treturn NULL;\n\tsnprintf(name, sizeof(name), \"%x\", ent->type);\n\tremove_proc_subtree(name, procdir);\n\treturn proc_mkdir_data(name, 0555, procdir, (void *)lanes);\n}\n\n \n\nstruct nubus_proc_pde_data {\n\tunsigned char *res_ptr;\n\tunsigned int res_size;\n};\n\nstatic struct nubus_proc_pde_data *\nnubus_proc_alloc_pde_data(unsigned char *ptr, unsigned int size)\n{\n\tstruct nubus_proc_pde_data *pded;\n\n\tpded = kmalloc(sizeof(*pded), GFP_KERNEL);\n\tif (!pded)\n\t\treturn NULL;\n\n\tpded->res_ptr = ptr;\n\tpded->res_size = size;\n\treturn pded;\n}\n\nstatic int nubus_proc_rsrc_show(struct seq_file *m, void *v)\n{\n\tstruct inode *inode = m->private;\n\tstruct nubus_proc_pde_data *pded;\n\n\tpded = pde_data(inode);\n\tif (!pded)\n\t\treturn 0;\n\n\tif (pded->res_size > m->size)\n\t\treturn -EFBIG;\n\n\tif (pded->res_size) {\n\t\tint lanes = (int)proc_get_parent_data(inode);\n\t\tstruct nubus_dirent ent;\n\n\t\tif (!lanes)\n\t\t\treturn 0;\n\n\t\tent.mask = lanes;\n\t\tent.base = pded->res_ptr;\n\t\tent.data = 0;\n\t\tnubus_seq_write_rsrc_mem(m, &ent, pded->res_size);\n\t} else {\n\t\tunsigned int data = (unsigned int)pded->res_ptr;\n\n\t\tseq_putc(m, data >> 16);\n\t\tseq_putc(m, data >> 8);\n\t\tseq_putc(m, data >> 0);\n\t}\n\treturn 0;\n}\n\nstatic int nubus_rsrc_proc_open(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, nubus_proc_rsrc_show, inode);\n}\n\nstatic const struct proc_ops nubus_rsrc_proc_ops = {\n\t.proc_open\t= nubus_rsrc_proc_open,\n\t.proc_read\t= seq_read,\n\t.proc_lseek\t= seq_lseek,\n\t.proc_release\t= single_release,\n};\n\nvoid nubus_proc_add_rsrc_mem(struct proc_dir_entry *procdir,\n\t\t\t     const struct nubus_dirent *ent,\n\t\t\t     unsigned int size)\n{\n\tchar name[9];\n\tstruct nubus_proc_pde_data *pded;\n\n\tif (!procdir || !nubus_populate_procfs)\n\t\treturn;\n\n\tsnprintf(name, sizeof(name), \"%x\", ent->type);\n\tif (size)\n\t\tpded = nubus_proc_alloc_pde_data(nubus_dirptr(ent), size);\n\telse\n\t\tpded = NULL;\n\tremove_proc_subtree(name, procdir);\n\tproc_create_data(name, S_IFREG | 0444, procdir,\n\t\t\t &nubus_rsrc_proc_ops, pded);\n}\n\nvoid nubus_proc_add_rsrc(struct proc_dir_entry *procdir,\n\t\t\t const struct nubus_dirent *ent)\n{\n\tchar name[9];\n\tunsigned char *data = (unsigned char *)ent->data;\n\n\tif (!procdir || !nubus_populate_procfs)\n\t\treturn;\n\n\tsnprintf(name, sizeof(name), \"%x\", ent->type);\n\tremove_proc_subtree(name, procdir);\n\tproc_create_data(name, S_IFREG | 0444, procdir,\n\t\t\t &nubus_rsrc_proc_ops,\n\t\t\t nubus_proc_alloc_pde_data(data, 0));\n}\n\n \n\nvoid __init nubus_proc_init(void)\n{\n\tproc_create_single(\"nubus\", 0, NULL, nubus_proc_show);\n\tproc_bus_nubus_dir = proc_mkdir(\"bus/nubus\", NULL);\n\tif (!proc_bus_nubus_dir)\n\t\treturn;\n\tproc_create_single(\"devices\", 0, proc_bus_nubus_dir,\n\t\t\tnubus_devices_proc_show);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}