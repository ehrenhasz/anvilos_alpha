{
  "module_name": "ib_isert.h",
  "hash_id": "b4099837bf1b0e71e3247a30529b989091ac44ee08a94ef10b15fc11ffab19e6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/ulp/isert/ib_isert.h",
  "human_readable_source": " \n#include <linux/socket.h>\n#include <linux/in.h>\n#include <linux/in6.h>\n#include <rdma/ib_verbs.h>\n#include <rdma/rdma_cm.h>\n#include <rdma/rw.h>\n#include <scsi/iser.h>\n\n\n#define DRV_NAME\t\"isert\"\n#define PFX\t\tDRV_NAME \": \"\n\n#define isert_dbg(fmt, arg...)\t\t\t\t \\\n\tdo {\t\t\t\t\t\t \\\n\t\tif (unlikely(isert_debug_level > 2))\t \\\n\t\t\tprintk(KERN_DEBUG PFX \"%s: \" fmt,\\\n\t\t\t\t__func__ , ## arg);\t \\\n\t} while (0)\n\n#define isert_warn(fmt, arg...)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\tif (unlikely(isert_debug_level > 0))\t\\\n\t\t\tpr_warn(PFX \"%s: \" fmt,         \\\n\t\t\t\t__func__ , ## arg);\t\\\n\t} while (0)\n\n#define isert_info(fmt, arg...)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\tif (unlikely(isert_debug_level > 1))\t\\\n\t\t\tpr_info(PFX \"%s: \" fmt,         \\\n\t\t\t\t__func__ , ## arg);\t\\\n\t} while (0)\n\n#define isert_err(fmt, arg...) \\\n\tpr_err(PFX \"%s: \" fmt, __func__ , ## arg)\n\n \n#define ISER_HEADERS_LEN\t(sizeof(struct iser_ctrl) + \\\n\t\t\t\t sizeof(struct iscsi_hdr))\n#define ISER_RX_PAYLOAD_SIZE\t(ISER_HEADERS_LEN + ISCSI_DEF_MAX_RECV_SEG_LEN)\n\n \n \n#define ISERT_MAX_TX_MISC_PDUS\t4  \n\n#define ISERT_MAX_RX_MISC_PDUS\t6  \n\n#define ISCSI_DEF_XMIT_CMDS_MAX 128  \n\n#define ISERT_QP_MAX_RECV_DTOS\t(ISCSI_DEF_XMIT_CMDS_MAX)\n\n#define ISERT_MIN_POSTED_RX\t(ISCSI_DEF_XMIT_CMDS_MAX >> 2)\n\n#define ISERT_QP_MAX_REQ_DTOS\t(ISCSI_DEF_XMIT_CMDS_MAX +    \\\n\t\t\t\tISERT_MAX_TX_MISC_PDUS\t+ \\\n\t\t\t\tISERT_MAX_RX_MISC_PDUS)\n\n \n#define ISER_RX_SIZE\t\t(ISCSI_DEF_MAX_RECV_SEG_LEN + 1024)\n\n \n#define ISCSI_ISER_MIN_SG_TABLESIZE 128\n\n \n#define ISCSI_ISER_MAX_SG_TABLESIZE\t4096\n\nenum isert_desc_type {\n\tISCSI_TX_CONTROL,\n\tISCSI_TX_DATAIN\n};\n\nenum iser_conn_state {\n\tISER_CONN_INIT,\n\tISER_CONN_UP,\n\tISER_CONN_BOUND,\n\tISER_CONN_FULL_FEATURE,\n\tISER_CONN_TERMINATING,\n\tISER_CONN_DOWN,\n};\n\nstruct iser_rx_desc {\n\tchar\t\tbuf[ISER_RX_SIZE];\n\tu64\t\tdma_addr;\n\tstruct ib_sge\trx_sg;\n\tstruct ib_cqe\trx_cqe;\n\tbool\t\tin_use;\n};\n\nstatic inline struct iser_rx_desc *cqe_to_rx_desc(struct ib_cqe *cqe)\n{\n\treturn container_of(cqe, struct iser_rx_desc, rx_cqe);\n}\n\nstatic void *isert_get_iser_hdr(struct iser_rx_desc *desc)\n{\n\treturn PTR_ALIGN(desc->buf + ISER_HEADERS_LEN, 512) - ISER_HEADERS_LEN;\n}\n\nstatic size_t isert_get_hdr_offset(struct iser_rx_desc *desc)\n{\n\treturn isert_get_iser_hdr(desc) - (void *)desc->buf;\n}\n\nstatic void *isert_get_iscsi_hdr(struct iser_rx_desc *desc)\n{\n\treturn isert_get_iser_hdr(desc) + sizeof(struct iser_ctrl);\n}\n\nstatic void *isert_get_data(struct iser_rx_desc *desc)\n{\n\tvoid *data = isert_get_iser_hdr(desc) + ISER_HEADERS_LEN;\n\n\tWARN_ON((uintptr_t)data & 511);\n\treturn data;\n}\n\nstruct iser_tx_desc {\n\tstruct iser_ctrl iser_header;\n\tstruct iscsi_hdr iscsi_header;\n\tenum isert_desc_type type;\n\tu64\t\tdma_addr;\n\tstruct ib_sge\ttx_sg[2];\n\tstruct ib_cqe\ttx_cqe;\n\tint\t\tnum_sge;\n\tstruct ib_send_wr send_wr;\n} __packed;\n\nstatic inline struct iser_tx_desc *cqe_to_tx_desc(struct ib_cqe *cqe)\n{\n\treturn container_of(cqe, struct iser_tx_desc, tx_cqe);\n}\n\nstruct isert_cmd {\n\tuint32_t\t\tread_stag;\n\tuint32_t\t\twrite_stag;\n\tuint64_t\t\tread_va;\n\tuint64_t\t\twrite_va;\n\tuint32_t\t\tinv_rkey;\n\tu64\t\t\tpdu_buf_dma;\n\tu32\t\t\tpdu_buf_len;\n\tstruct isert_conn\t*conn;\n\tstruct iscsit_cmd\t*iscsit_cmd;\n\tstruct iser_tx_desc\ttx_desc;\n\tstruct iser_rx_desc\t*rx_desc;\n\tstruct rdma_rw_ctx\trw;\n\tstruct work_struct\tcomp_work;\n\tstruct scatterlist\tsg;\n\tbool\t\t\tctx_init_done;\n};\n\nstatic inline struct isert_cmd *tx_desc_to_cmd(struct iser_tx_desc *desc)\n{\n\treturn container_of(desc, struct isert_cmd, tx_desc);\n}\n\nstruct isert_device;\n\nstruct isert_conn {\n\tenum iser_conn_state\tstate;\n\tu32\t\t\tresponder_resources;\n\tu32\t\t\tinitiator_depth;\n\tbool\t\t\tpi_support;\n\tstruct iser_rx_desc\t*login_desc;\n\tchar\t\t\t*login_rsp_buf;\n\tint\t\t\tlogin_req_len;\n\tu64\t\t\tlogin_rsp_dma;\n\tstruct iser_rx_desc\t*rx_descs;\n\tstruct ib_recv_wr\trx_wr[ISERT_QP_MAX_RECV_DTOS];\n\tstruct iscsit_conn\t*conn;\n\tstruct list_head\tnode;\n\tstruct completion\tlogin_comp;\n\tstruct completion\tlogin_req_comp;\n\tstruct iser_tx_desc\tlogin_tx_desc;\n\tstruct rdma_cm_id\t*cm_id;\n\tstruct ib_qp\t\t*qp;\n\tstruct ib_cq\t\t*cq;\n\tu32\t\t\tcq_size;\n\tstruct isert_device\t*device;\n\tstruct mutex\t\tmutex;\n\tstruct kref\t\tkref;\n\tstruct work_struct\trelease_work;\n\tbool                    logout_posted;\n\tbool                    snd_w_inv;\n\twait_queue_head_t\trem_wait;\n\tbool\t\t\tdev_removed;\n};\n\nstruct isert_device {\n\tbool\t\t\tpi_capable;\n\tint\t\t\trefcount;\n\tstruct ib_device\t*ib_device;\n\tstruct ib_pd\t\t*pd;\n\tstruct isert_comp\t*comps;\n\tint                     comps_used;\n\tstruct list_head\tdev_node;\n};\n\nstruct isert_np {\n\tstruct iscsi_np         *np;\n\tstruct semaphore\tsem;\n\tstruct rdma_cm_id\t*cm_id;\n\tstruct mutex\t\tmutex;\n\tstruct list_head\taccepted;\n\tstruct list_head\tpending;\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}