{
  "module_name": "iscsi_iser.h",
  "hash_id": "5a9a5eb289acc0d84b9dfe9ab161c92d3203af302985b598fe06e464f212bfe2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/ulp/iser/iscsi_iser.h",
  "human_readable_source": " \n#ifndef __ISCSI_ISER_H__\n#define __ISCSI_ISER_H__\n\n#include <linux/types.h>\n#include <linux/net.h>\n#include <linux/printk.h>\n#include <scsi/libiscsi.h>\n#include <scsi/scsi_transport_iscsi.h>\n#include <scsi/scsi_cmnd.h>\n#include <scsi/scsi_device.h>\n#include <scsi/iser.h>\n\n#include <linux/interrupt.h>\n#include <linux/wait.h>\n#include <linux/sched.h>\n#include <linux/list.h>\n#include <linux/slab.h>\n#include <linux/dma-mapping.h>\n#include <linux/mutex.h>\n#include <linux/mempool.h>\n#include <linux/uio.h>\n\n#include <linux/socket.h>\n#include <linux/in.h>\n#include <linux/in6.h>\n\n#include <rdma/ib_verbs.h>\n#include <rdma/rdma_cm.h>\n\n#define DRV_NAME\t\"iser\"\n#define PFX\t\tDRV_NAME \": \"\n#define DRV_VER\t\t\"1.6\"\n\n#define iser_dbg(fmt, arg...)\t\t\t\t \\\n\tdo {\t\t\t\t\t\t \\\n\t\tif (unlikely(iser_debug_level > 2))\t \\\n\t\t\tprintk(KERN_DEBUG PFX \"%s: \" fmt,\\\n\t\t\t\t__func__ , ## arg);\t \\\n\t} while (0)\n\n#define iser_warn(fmt, arg...)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\tif (unlikely(iser_debug_level > 0))\t\\\n\t\t\tpr_warn(PFX \"%s: \" fmt,\t\t\\\n\t\t\t\t__func__ , ## arg);\t\\\n\t} while (0)\n\n#define iser_info(fmt, arg...)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\tif (unlikely(iser_debug_level > 1))\t\\\n\t\t\tpr_info(PFX \"%s: \" fmt,\t\t\\\n\t\t\t\t__func__ , ## arg);\t\\\n\t} while (0)\n\n#define iser_err(fmt, arg...) \\\n\tpr_err(PFX \"%s: \" fmt, __func__ , ## arg)\n\n \n#define ISER_DEF_MAX_SECTORS\t\t1024\n#define ISCSI_ISER_DEF_SG_TABLESIZE                                            \\\n\t((ISER_DEF_MAX_SECTORS * SECTOR_SIZE) >> ilog2(SZ_4K))\n \n#define ISCSI_ISER_MAX_SG_TABLESIZE ((32768 * SECTOR_SIZE) >> ilog2(SZ_4K))\n\n#define ISER_DEF_XMIT_CMDS_DEFAULT\t\t512\n#if ISCSI_DEF_XMIT_CMDS_MAX > ISER_DEF_XMIT_CMDS_DEFAULT\n\t#define ISER_DEF_XMIT_CMDS_MAX\t\tISCSI_DEF_XMIT_CMDS_MAX\n#else\n\t#define ISER_DEF_XMIT_CMDS_MAX\t\tISER_DEF_XMIT_CMDS_DEFAULT\n#endif\n#define ISER_DEF_CMD_PER_LUN\t\tISER_DEF_XMIT_CMDS_MAX\n\n \n \n#define ISER_MAX_RX_MISC_PDUS\t\t4  \n\n#define ISER_MAX_TX_MISC_PDUS\t\t6  \n\n#define ISER_QP_MAX_RECV_DTOS\t\t(ISER_DEF_XMIT_CMDS_MAX)\n\n \n\n#define ISER_INFLIGHT_DATAOUTS\t\t8\n\n#define ISER_QP_MAX_REQ_DTOS\t\t(ISER_DEF_XMIT_CMDS_MAX *    \\\n\t\t\t\t\t(1 + ISER_INFLIGHT_DATAOUTS) + \\\n\t\t\t\t\tISER_MAX_TX_MISC_PDUS        + \\\n\t\t\t\t\tISER_MAX_RX_MISC_PDUS)\n\n \n#define ISER_MAX_REG_WR_PER_CMD\t\t5\n\n \n#define ISER_QP_SIG_MAX_REQ_DTOS\t(ISER_DEF_XMIT_CMDS_MAX\t*       \\\n\t\t\t\t\t(1 + ISER_MAX_REG_WR_PER_CMD) + \\\n\t\t\t\t\tISER_MAX_TX_MISC_PDUS         + \\\n\t\t\t\t\tISER_MAX_RX_MISC_PDUS)\n\n#define ISER_GET_MAX_XMIT_CMDS(send_wr) ((send_wr\t\t\t\\\n\t\t\t\t\t - ISER_MAX_TX_MISC_PDUS\t\\\n\t\t\t\t\t - ISER_MAX_RX_MISC_PDUS) /\t\\\n\t\t\t\t\t (1 + ISER_INFLIGHT_DATAOUTS))\n\n \n#define ISER_HEADERS_LEN\t(sizeof(struct iser_ctrl) + sizeof(struct iscsi_hdr))\n\n#define ISER_RECV_DATA_SEG_LEN\t128\n#define ISER_RX_PAYLOAD_SIZE\t(ISER_HEADERS_LEN + ISER_RECV_DATA_SEG_LEN)\n#define ISER_RX_LOGIN_SIZE\t(ISER_HEADERS_LEN + ISCSI_DEF_MAX_RECV_SEG_LEN)\n\n \n#define ISER_OBJECT_NAME_SIZE\t\t    64\n\nenum iser_conn_state {\n\tISER_CONN_INIT,\t\t    \n\tISER_CONN_PENDING,\t    \n\tISER_CONN_UP,\t\t    \n\tISER_CONN_TERMINATING,\t    \n\tISER_CONN_DOWN,\t\t    \n\tISER_CONN_STATES_NUM\n};\n\nenum iser_task_status {\n\tISER_TASK_STATUS_INIT = 0,\n\tISER_TASK_STATUS_STARTED,\n\tISER_TASK_STATUS_COMPLETED\n};\n\nenum iser_data_dir {\n\tISER_DIR_IN = 0,\t    \n\tISER_DIR_OUT,\t\t    \n\tISER_DIRS_NUM\n};\n\n \nstruct iser_data_buf {\n\tstruct scatterlist *sg;\n\tint                size;\n\tunsigned long      data_len;\n\tint                dma_nents;\n};\n\n \nstruct iser_device;\nstruct iscsi_iser_task;\nstruct iscsi_endpoint;\nstruct iser_reg_resources;\n\n \nstruct iser_mem_reg {\n\tstruct ib_sge sge;\n\tu32 rkey;\n\tstruct iser_fr_desc *desc;\n};\n\nenum iser_desc_type {\n\tISCSI_TX_CONTROL ,\n\tISCSI_TX_SCSI_COMMAND,\n\tISCSI_TX_DATAOUT\n};\n\n \nstruct iser_tx_desc {\n\tstruct iser_ctrl             iser_header;\n\tstruct iscsi_hdr             iscsi_header;\n\tenum   iser_desc_type        type;\n\tu64\t\t             dma_addr;\n\tstruct ib_sge\t\t     tx_sg[2];\n\tint                          num_sge;\n\tstruct ib_cqe\t\t     cqe;\n\tbool\t\t\t     mapped;\n\tstruct ib_reg_wr\t     reg_wr;\n\tstruct ib_send_wr\t     send_wr;\n\tstruct ib_send_wr\t     inv_wr;\n};\n\n#define ISER_RX_PAD_SIZE\t(256 - (ISER_RX_PAYLOAD_SIZE + \\\n\t\t\t\t sizeof(u64) + sizeof(struct ib_sge) + \\\n\t\t\t\t sizeof(struct ib_cqe)))\n \nstruct iser_rx_desc {\n\tstruct iser_ctrl             iser_header;\n\tstruct iscsi_hdr             iscsi_header;\n\tchar\t\t             data[ISER_RECV_DATA_SEG_LEN];\n\tu64\t\t             dma_addr;\n\tstruct ib_sge\t\t     rx_sg;\n\tstruct ib_cqe\t\t     cqe;\n\tchar\t\t             pad[ISER_RX_PAD_SIZE];\n} __packed;\n\n \nstruct iser_login_desc {\n\tvoid                         *req;\n\tvoid                         *rsp;\n\tu64                          req_dma;\n\tu64                          rsp_dma;\n\tstruct ib_sge                sge;\n\tstruct ib_cqe\t\t     cqe;\n} __packed;\n\nstruct iser_conn;\nstruct ib_conn;\n\n \nstruct iser_device {\n\tstruct ib_device             *ib_device;\n\tstruct ib_pd\t             *pd;\n\tstruct ib_event_handler      event_handler;\n\tstruct list_head             ig_list;\n\tint                          refcount;\n};\n\n \nstruct iser_reg_resources {\n\tstruct ib_mr                     *mr;\n\tstruct ib_mr                     *sig_mr;\n};\n\n \nstruct iser_fr_desc {\n\tstruct list_head\t\t  list;\n\tstruct iser_reg_resources\t  rsc;\n\tbool\t\t\t\t  sig_protected;\n\tstruct list_head                  all_list;\n};\n\n \nstruct iser_fr_pool {\n\tstruct list_head        list;\n\tspinlock_t              lock;\n\tint                     size;\n\tstruct list_head        all_list;\n};\n\n \nstruct ib_conn {\n\tstruct rdma_cm_id           *cma_id;\n\tstruct ib_qp\t            *qp;\n\tstruct ib_cq\t\t    *cq;\n\tu32\t\t\t    cq_size;\n\tstruct iser_device          *device;\n\tstruct iser_fr_pool          fr_pool;\n\tbool\t\t\t     pi_support;\n\tstruct ib_cqe\t\t     reg_cqe;\n};\n\n \nstruct iser_conn {\n\tstruct ib_conn\t\t     ib_conn;\n\tstruct iscsi_conn\t     *iscsi_conn;\n\tstruct iscsi_endpoint\t     *ep;\n\tenum iser_conn_state\t     state;\n\tunsigned\t\t     qp_max_recv_dtos;\n\tu16                          max_cmds;\n\tchar \t\t\t     name[ISER_OBJECT_NAME_SIZE];\n\tstruct work_struct\t     release_work;\n\tstruct mutex\t\t     state_mutex;\n\tstruct completion\t     stop_completion;\n\tstruct completion\t     ib_completion;\n\tstruct completion\t     up_completion;\n\tstruct list_head\t     conn_list;\n\tstruct iser_login_desc       login_desc;\n\tstruct iser_rx_desc\t     *rx_descs;\n\tu32                          num_rx_descs;\n\tunsigned short               scsi_sg_tablesize;\n\tunsigned short               pages_per_mr;\n\tbool\t\t\t     snd_w_inv;\n};\n\n \nstruct iscsi_iser_task {\n\tstruct iser_tx_desc          desc;\n\tstruct iser_conn\t     *iser_conn;\n\tenum iser_task_status \t     status;\n\tstruct scsi_cmnd\t     *sc;\n\tint                          command_sent;\n\tint                          dir[ISER_DIRS_NUM];\n\tstruct iser_mem_reg          rdma_reg[ISER_DIRS_NUM];\n\tstruct iser_data_buf         data[ISER_DIRS_NUM];\n\tstruct iser_data_buf         prot[ISER_DIRS_NUM];\n};\n\n \nstruct iser_global {\n\tstruct mutex      device_list_mutex;\n\tstruct list_head  device_list;\n\tstruct mutex      connlist_mutex;\n\tstruct list_head  connlist;\n\tstruct kmem_cache *desc_cache;\n};\n\nextern struct iser_global ig;\nextern int iser_debug_level;\nextern bool iser_pi_enable;\nextern unsigned int iser_max_sectors;\nextern bool iser_always_reg;\n\nint iser_send_control(struct iscsi_conn *conn,\n\t\t      struct iscsi_task *task);\n\nint iser_send_command(struct iscsi_conn *conn,\n\t\t      struct iscsi_task *task);\n\nint iser_send_data_out(struct iscsi_conn *conn,\n\t\t       struct iscsi_task *task,\n\t\t       struct iscsi_data *hdr);\n\nvoid iscsi_iser_recv(struct iscsi_conn *conn,\n\t\t     struct iscsi_hdr *hdr,\n\t\t     char *rx_data,\n\t\t     int rx_data_len);\n\nvoid iser_conn_init(struct iser_conn *iser_conn);\n\nvoid iser_conn_release(struct iser_conn *iser_conn);\n\nint iser_conn_terminate(struct iser_conn *iser_conn);\n\nvoid iser_release_work(struct work_struct *work);\n\nvoid iser_err_comp(struct ib_wc *wc, const char *type);\nvoid iser_login_rsp(struct ib_cq *cq, struct ib_wc *wc);\nvoid iser_task_rsp(struct ib_cq *cq, struct ib_wc *wc);\nvoid iser_cmd_comp(struct ib_cq *cq, struct ib_wc *wc);\nvoid iser_ctrl_comp(struct ib_cq *cq, struct ib_wc *wc);\nvoid iser_dataout_comp(struct ib_cq *cq, struct ib_wc *wc);\nvoid iser_reg_comp(struct ib_cq *cq, struct ib_wc *wc);\n\nvoid iser_task_rdma_init(struct iscsi_iser_task *task);\n\nvoid iser_task_rdma_finalize(struct iscsi_iser_task *task);\n\nvoid iser_free_rx_descriptors(struct iser_conn *iser_conn);\n\nvoid iser_finalize_rdma_unaligned_sg(struct iscsi_iser_task *iser_task,\n\t\t\t\t     struct iser_data_buf *mem,\n\t\t\t\t     enum iser_data_dir cmd_dir);\n\nint iser_reg_mem_fastreg(struct iscsi_iser_task *task,\n\t\t\t enum iser_data_dir dir,\n\t\t\t bool all_imm);\nvoid iser_unreg_mem_fastreg(struct iscsi_iser_task *task,\n\t\t\t    enum iser_data_dir dir);\n\nint  iser_connect(struct iser_conn *iser_conn,\n\t\t  struct sockaddr *src_addr,\n\t\t  struct sockaddr *dst_addr,\n\t\t  int non_blocking);\n\nint  iser_post_recvl(struct iser_conn *iser_conn);\nint  iser_post_recvm(struct iser_conn *iser_conn,\n\t\t     struct iser_rx_desc *rx_desc);\nint  iser_post_send(struct ib_conn *ib_conn, struct iser_tx_desc *tx_desc);\n\nint iser_dma_map_task_data(struct iscsi_iser_task *iser_task,\n\t\t\t   enum iser_data_dir iser_dir,\n\t\t\t   enum dma_data_direction dma_dir);\n\nvoid iser_dma_unmap_task_data(struct iscsi_iser_task *iser_task,\n\t\t\t      enum iser_data_dir iser_dir,\n\t\t\t      enum dma_data_direction dma_dir);\n\nint  iser_initialize_task_headers(struct iscsi_task *task,\n\t\t\tstruct iser_tx_desc *tx_desc);\nint iser_alloc_rx_descriptors(struct iser_conn *iser_conn,\n\t\t\t      struct iscsi_session *session);\nint iser_alloc_fastreg_pool(struct ib_conn *ib_conn,\n\t\t\t    unsigned cmds_max,\n\t\t\t    unsigned int size);\nvoid iser_free_fastreg_pool(struct ib_conn *ib_conn);\nu8 iser_check_task_pi_status(struct iscsi_iser_task *iser_task,\n\t\t\t     enum iser_data_dir cmd_dir, sector_t *sector);\n\nstatic inline struct iser_conn *\nto_iser_conn(struct ib_conn *ib_conn)\n{\n\treturn container_of(ib_conn, struct iser_conn, ib_conn);\n}\n\nstatic inline struct iser_rx_desc *\niser_rx(struct ib_cqe *cqe)\n{\n\treturn container_of(cqe, struct iser_rx_desc, cqe);\n}\n\nstatic inline struct iser_tx_desc *\niser_tx(struct ib_cqe *cqe)\n{\n\treturn container_of(cqe, struct iser_tx_desc, cqe);\n}\n\nstatic inline struct iser_login_desc *\niser_login(struct ib_cqe *cqe)\n{\n\treturn container_of(cqe, struct iser_login_desc, cqe);\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}