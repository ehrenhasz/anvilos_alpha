{
  "module_name": "ipoib_ethtool.c",
  "hash_id": "8442e6a738cf74645c965f8c8cb612b40b95de0514bd4ff580ba1042cd42088c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/ulp/ipoib/ipoib_ethtool.c",
  "human_readable_source": " \n\n#include <linux/kernel.h>\n#include <linux/ethtool.h>\n#include <linux/netdevice.h>\n\n#include \"ipoib.h\"\n\nstruct ipoib_stats {\n\tchar stat_string[ETH_GSTRING_LEN];\n\tint stat_offset;\n};\n\n#define IPOIB_NETDEV_STAT(m) { \\\n\t\t.stat_string = #m, \\\n\t\t.stat_offset = offsetof(struct rtnl_link_stats64, m) }\n\nstatic const struct ipoib_stats ipoib_gstrings_stats[] = {\n\tIPOIB_NETDEV_STAT(rx_packets),\n\tIPOIB_NETDEV_STAT(tx_packets),\n\tIPOIB_NETDEV_STAT(rx_bytes),\n\tIPOIB_NETDEV_STAT(tx_bytes),\n\tIPOIB_NETDEV_STAT(tx_errors),\n\tIPOIB_NETDEV_STAT(rx_dropped),\n\tIPOIB_NETDEV_STAT(tx_dropped),\n\tIPOIB_NETDEV_STAT(multicast),\n};\n\n#define IPOIB_GLOBAL_STATS_LEN\tARRAY_SIZE(ipoib_gstrings_stats)\n\nstatic void ipoib_get_drvinfo(struct net_device *netdev,\n\t\t\t      struct ethtool_drvinfo *drvinfo)\n{\n\tstruct ipoib_dev_priv *priv = ipoib_priv(netdev);\n\n\tib_get_device_fw_str(priv->ca, drvinfo->fw_version);\n\n\tstrscpy(drvinfo->bus_info, dev_name(priv->ca->dev.parent),\n\t\tsizeof(drvinfo->bus_info));\n\n\tstrscpy(drvinfo->driver, \"ib_ipoib\", sizeof(drvinfo->driver));\n}\n\nstatic int ipoib_get_coalesce(struct net_device *dev,\n\t\t\t      struct ethtool_coalesce *coal,\n\t\t\t      struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t      struct netlink_ext_ack *extack)\n{\n\tstruct ipoib_dev_priv *priv = ipoib_priv(dev);\n\n\tcoal->rx_coalesce_usecs = priv->ethtool.coalesce_usecs;\n\tcoal->rx_max_coalesced_frames = priv->ethtool.max_coalesced_frames;\n\n\treturn 0;\n}\n\nstatic int ipoib_set_coalesce(struct net_device *dev,\n\t\t\t      struct ethtool_coalesce *coal,\n\t\t\t      struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t      struct netlink_ext_ack *extack)\n{\n\tstruct ipoib_dev_priv *priv = ipoib_priv(dev);\n\tint ret;\n\n\t \n\tif (coal->rx_coalesce_usecs       > 0xffff ||\n\t    coal->rx_max_coalesced_frames > 0xffff)\n\t\treturn -EINVAL;\n\n\tret = rdma_set_cq_moderation(priv->recv_cq,\n\t\t\t\t     coal->rx_max_coalesced_frames,\n\t\t\t\t     coal->rx_coalesce_usecs);\n\tif (ret && ret != -EOPNOTSUPP) {\n\t\tipoib_warn(priv, \"failed modifying CQ (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tpriv->ethtool.coalesce_usecs       = coal->rx_coalesce_usecs;\n\tpriv->ethtool.max_coalesced_frames = coal->rx_max_coalesced_frames;\n\n\treturn 0;\n}\nstatic void ipoib_get_ethtool_stats(struct net_device *dev,\n\t\t\t\t    struct ethtool_stats __always_unused *stats,\n\t\t\t\t    u64 *data)\n{\n\tint i;\n\tstruct net_device_stats *net_stats = &dev->stats;\n\tu8 *p = (u8 *)net_stats;\n\n\tfor (i = 0; i < IPOIB_GLOBAL_STATS_LEN; i++)\n\t\tdata[i] = *(u64 *)(p + ipoib_gstrings_stats[i].stat_offset);\n\n}\nstatic void ipoib_get_strings(struct net_device __always_unused *dev,\n\t\t\t      u32 stringset, u8 *data)\n{\n\tu8 *p = data;\n\tint i;\n\n\tswitch (stringset) {\n\tcase ETH_SS_STATS:\n\t\tfor (i = 0; i < IPOIB_GLOBAL_STATS_LEN; i++) {\n\t\t\tmemcpy(p, ipoib_gstrings_stats[i].stat_string,\n\t\t\t\tETH_GSTRING_LEN);\n\t\t\tp += ETH_GSTRING_LEN;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\nstatic int ipoib_get_sset_count(struct net_device __always_unused *dev,\n\t\t\t\t int sset)\n{\n\tswitch (sset) {\n\tcase ETH_SS_STATS:\n\t\treturn IPOIB_GLOBAL_STATS_LEN;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn -EOPNOTSUPP;\n}\n\n \nstatic inline int ib_speed_enum_to_int(int speed)\n{\n\tswitch (speed) {\n\tcase IB_SPEED_SDR:\n\t\treturn SPEED_2500;\n\tcase IB_SPEED_DDR:\n\t\treturn SPEED_5000;\n\tcase IB_SPEED_QDR:\n\tcase IB_SPEED_FDR10:\n\t\treturn SPEED_10000;\n\tcase IB_SPEED_FDR:\n\t\treturn SPEED_14000;\n\tcase IB_SPEED_EDR:\n\t\treturn SPEED_25000;\n\tcase IB_SPEED_HDR:\n\t\treturn SPEED_50000;\n\tcase IB_SPEED_NDR:\n\t\treturn SPEED_100000;\n\t}\n\n\treturn SPEED_UNKNOWN;\n}\n\nstatic int ipoib_get_link_ksettings(struct net_device *netdev,\n\t\t\t\t    struct ethtool_link_ksettings *cmd)\n{\n\tstruct ipoib_dev_priv *priv = ipoib_priv(netdev);\n\tstruct ib_port_attr attr;\n\tint ret, speed, width;\n\n\tif (!netif_carrier_ok(netdev)) {\n\t\tcmd->base.speed = SPEED_UNKNOWN;\n\t\tcmd->base.duplex = DUPLEX_UNKNOWN;\n\t\treturn 0;\n\t}\n\n\tret = ib_query_port(priv->ca, priv->port, &attr);\n\tif (ret < 0)\n\t\treturn -EINVAL;\n\n\tspeed = ib_speed_enum_to_int(attr.active_speed);\n\twidth = ib_width_enum_to_int(attr.active_width);\n\n\tif (speed < 0 || width < 0)\n\t\treturn -EINVAL;\n\n\t \n\tcmd->base.speed\t\t = speed * width;\n\tcmd->base.duplex\t = DUPLEX_FULL;\n\n\tcmd->base.phy_address\t = 0xFF;\n\n\tcmd->base.autoneg\t = AUTONEG_ENABLE;\n\tcmd->base.port\t\t = PORT_OTHER;\n\n\treturn 0;\n}\n\nstatic const struct ethtool_ops ipoib_ethtool_ops = {\n\t.supported_coalesce_params = ETHTOOL_COALESCE_RX_USECS |\n\t\t\t\t     ETHTOOL_COALESCE_RX_MAX_FRAMES,\n\t.get_link_ksettings\t= ipoib_get_link_ksettings,\n\t.get_drvinfo\t\t= ipoib_get_drvinfo,\n\t.get_coalesce\t\t= ipoib_get_coalesce,\n\t.set_coalesce\t\t= ipoib_set_coalesce,\n\t.get_strings\t\t= ipoib_get_strings,\n\t.get_ethtool_stats\t= ipoib_get_ethtool_stats,\n\t.get_sset_count\t\t= ipoib_get_sset_count,\n\t.get_link\t\t= ethtool_op_get_link,\n};\n\nvoid ipoib_set_ethtool_ops(struct net_device *dev)\n{\n\tdev->ethtool_ops = &ipoib_ethtool_ops;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}