{
  "module_name": "ah.c",
  "hash_id": "9f14ffc671b2cc200a3e9beaccceff26b39f4a5035fd38eb2d514096ae75b835",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/sw/rdmavt/ah.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n#include \"ah.h\"\n#include \"vt.h\"  \n\n \nint rvt_check_ah(struct ib_device *ibdev,\n\t\t struct rdma_ah_attr *ah_attr)\n{\n\tint err;\n\tint port_num = rdma_ah_get_port_num(ah_attr);\n\tstruct ib_port_attr port_attr;\n\tstruct rvt_dev_info *rdi = ib_to_rvt(ibdev);\n\tu8 ah_flags = rdma_ah_get_ah_flags(ah_attr);\n\tu8 static_rate = rdma_ah_get_static_rate(ah_attr);\n\n\terr = ib_query_port(ibdev, port_num, &port_attr);\n\tif (err)\n\t\treturn -EINVAL;\n\tif (port_num < 1 ||\n\t    port_num > ibdev->phys_port_cnt)\n\t\treturn -EINVAL;\n\tif (static_rate != IB_RATE_PORT_CURRENT &&\n\t    ib_rate_to_mbps(static_rate) < 0)\n\t\treturn -EINVAL;\n\tif ((ah_flags & IB_AH_GRH) &&\n\t    rdma_ah_read_grh(ah_attr)->sgid_index >= port_attr.gid_tbl_len)\n\t\treturn -EINVAL;\n\tif (rdi->driver_f.check_ah)\n\t\treturn rdi->driver_f.check_ah(ibdev, ah_attr);\n\treturn 0;\n}\nEXPORT_SYMBOL(rvt_check_ah);\n\n \nint rvt_create_ah(struct ib_ah *ibah, struct rdma_ah_init_attr *init_attr,\n\t\t  struct ib_udata *udata)\n{\n\tstruct rvt_ah *ah = ibah_to_rvtah(ibah);\n\tstruct rvt_dev_info *dev = ib_to_rvt(ibah->device);\n\tunsigned long flags;\n\n\tif (rvt_check_ah(ibah->device, init_attr->ah_attr))\n\t\treturn -EINVAL;\n\n\tspin_lock_irqsave(&dev->n_ahs_lock, flags);\n\tif (dev->n_ahs_allocated == dev->dparms.props.max_ah) {\n\t\tspin_unlock_irqrestore(&dev->n_ahs_lock, flags);\n\t\treturn -ENOMEM;\n\t}\n\n\tdev->n_ahs_allocated++;\n\tspin_unlock_irqrestore(&dev->n_ahs_lock, flags);\n\n\trdma_copy_ah_attr(&ah->attr, init_attr->ah_attr);\n\n\tif (dev->driver_f.notify_new_ah)\n\t\tdev->driver_f.notify_new_ah(ibah->device,\n\t\t\t\t\t    init_attr->ah_attr, ah);\n\n\treturn 0;\n}\n\n \nint rvt_destroy_ah(struct ib_ah *ibah, u32 destroy_flags)\n{\n\tstruct rvt_dev_info *dev = ib_to_rvt(ibah->device);\n\tstruct rvt_ah *ah = ibah_to_rvtah(ibah);\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&dev->n_ahs_lock, flags);\n\tdev->n_ahs_allocated--;\n\tspin_unlock_irqrestore(&dev->n_ahs_lock, flags);\n\n\trdma_destroy_ah_attr(&ah->attr);\n\treturn 0;\n}\n\n \nint rvt_modify_ah(struct ib_ah *ibah, struct rdma_ah_attr *ah_attr)\n{\n\tstruct rvt_ah *ah = ibah_to_rvtah(ibah);\n\n\tif (rvt_check_ah(ibah->device, ah_attr))\n\t\treturn -EINVAL;\n\n\tah->attr = *ah_attr;\n\n\treturn 0;\n}\n\n \nint rvt_query_ah(struct ib_ah *ibah, struct rdma_ah_attr *ah_attr)\n{\n\tstruct rvt_ah *ah = ibah_to_rvtah(ibah);\n\n\t*ah_attr = ah->attr;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}