{
  "module_name": "efa_com_cmd.c",
  "hash_id": "bbed6d7f7f41f0bcdb84411dd9120218b1531f00f220b36f7f37a23d8d4317c7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/efa/efa_com_cmd.c",
  "human_readable_source": "\n \n\n#include \"efa_com.h\"\n#include \"efa_com_cmd.h\"\n\nint efa_com_create_qp(struct efa_com_dev *edev,\n\t\t      struct efa_com_create_qp_params *params,\n\t\t      struct efa_com_create_qp_result *res)\n{\n\tstruct efa_admin_create_qp_cmd create_qp_cmd = {};\n\tstruct efa_admin_create_qp_resp cmd_completion;\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tint err;\n\n\tcreate_qp_cmd.aq_common_desc.opcode = EFA_ADMIN_CREATE_QP;\n\n\tcreate_qp_cmd.pd = params->pd;\n\tcreate_qp_cmd.qp_type = params->qp_type;\n\tcreate_qp_cmd.rq_base_addr = params->rq_base_addr;\n\tcreate_qp_cmd.send_cq_idx = params->send_cq_idx;\n\tcreate_qp_cmd.recv_cq_idx = params->recv_cq_idx;\n\tcreate_qp_cmd.qp_alloc_size.send_queue_ring_size =\n\t\tparams->sq_ring_size_in_bytes;\n\tcreate_qp_cmd.qp_alloc_size.send_queue_depth =\n\t\t\tparams->sq_depth;\n\tcreate_qp_cmd.qp_alloc_size.recv_queue_ring_size =\n\t\t\tparams->rq_ring_size_in_bytes;\n\tcreate_qp_cmd.qp_alloc_size.recv_queue_depth =\n\t\t\tparams->rq_depth;\n\tcreate_qp_cmd.uar = params->uarn;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&create_qp_cmd,\n\t\t\t       sizeof(create_qp_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&cmd_completion,\n\t\t\t       sizeof(cmd_completion));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to create qp [%d]\\n\", err);\n\t\treturn err;\n\t}\n\n\tres->qp_handle = cmd_completion.qp_handle;\n\tres->qp_num = cmd_completion.qp_num;\n\tres->sq_db_offset = cmd_completion.sq_db_offset;\n\tres->rq_db_offset = cmd_completion.rq_db_offset;\n\tres->llq_descriptors_offset = cmd_completion.llq_descriptors_offset;\n\tres->send_sub_cq_idx = cmd_completion.send_sub_cq_idx;\n\tres->recv_sub_cq_idx = cmd_completion.recv_sub_cq_idx;\n\n\treturn 0;\n}\n\nint efa_com_modify_qp(struct efa_com_dev *edev,\n\t\t      struct efa_com_modify_qp_params *params)\n{\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_modify_qp_cmd cmd = {};\n\tstruct efa_admin_modify_qp_resp resp;\n\tint err;\n\n\tcmd.aq_common_desc.opcode = EFA_ADMIN_MODIFY_QP;\n\tcmd.modify_mask = params->modify_mask;\n\tcmd.qp_handle = params->qp_handle;\n\tcmd.qp_state = params->qp_state;\n\tcmd.cur_qp_state = params->cur_qp_state;\n\tcmd.qkey = params->qkey;\n\tcmd.sq_psn = params->sq_psn;\n\tcmd.sq_drained_async_notify = params->sq_drained_async_notify;\n\tcmd.rnr_retry = params->rnr_retry;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&cmd,\n\t\t\t       sizeof(cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&resp,\n\t\t\t       sizeof(resp));\n\tif (err) {\n\t\tibdev_err_ratelimited(\n\t\t\tedev->efa_dev,\n\t\t\t\"Failed to modify qp-%u modify_mask[%#x] [%d]\\n\",\n\t\t\tcmd.qp_handle, cmd.modify_mask, err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint efa_com_query_qp(struct efa_com_dev *edev,\n\t\t     struct efa_com_query_qp_params *params,\n\t\t     struct efa_com_query_qp_result *result)\n{\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_query_qp_cmd cmd = {};\n\tstruct efa_admin_query_qp_resp resp;\n\tint err;\n\n\tcmd.aq_common_desc.opcode = EFA_ADMIN_QUERY_QP;\n\tcmd.qp_handle = params->qp_handle;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&cmd,\n\t\t\t       sizeof(cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&resp,\n\t\t\t       sizeof(resp));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to query qp-%u [%d]\\n\",\n\t\t\t\t      cmd.qp_handle, err);\n\t\treturn err;\n\t}\n\n\tresult->qp_state = resp.qp_state;\n\tresult->qkey = resp.qkey;\n\tresult->sq_draining = resp.sq_draining;\n\tresult->sq_psn = resp.sq_psn;\n\tresult->rnr_retry = resp.rnr_retry;\n\n\treturn 0;\n}\n\nint efa_com_destroy_qp(struct efa_com_dev *edev,\n\t\t       struct efa_com_destroy_qp_params *params)\n{\n\tstruct efa_admin_destroy_qp_resp cmd_completion;\n\tstruct efa_admin_destroy_qp_cmd qp_cmd = {};\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tint err;\n\n\tqp_cmd.aq_common_desc.opcode = EFA_ADMIN_DESTROY_QP;\n\tqp_cmd.qp_handle = params->qp_handle;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&qp_cmd,\n\t\t\t       sizeof(qp_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&cmd_completion,\n\t\t\t       sizeof(cmd_completion));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to destroy qp-%u [%d]\\n\",\n\t\t\t\t      qp_cmd.qp_handle, err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint efa_com_create_cq(struct efa_com_dev *edev,\n\t\t      struct efa_com_create_cq_params *params,\n\t\t      struct efa_com_create_cq_result *result)\n{\n\tstruct efa_admin_create_cq_resp cmd_completion = {};\n\tstruct efa_admin_create_cq_cmd create_cmd = {};\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tint err;\n\n\tcreate_cmd.aq_common_desc.opcode = EFA_ADMIN_CREATE_CQ;\n\tEFA_SET(&create_cmd.cq_caps_2,\n\t\tEFA_ADMIN_CREATE_CQ_CMD_CQ_ENTRY_SIZE_WORDS,\n\t\tparams->entry_size_in_bytes / 4);\n\tcreate_cmd.cq_depth = params->cq_depth;\n\tcreate_cmd.num_sub_cqs = params->num_sub_cqs;\n\tcreate_cmd.uar = params->uarn;\n\tif (params->interrupt_mode_enabled) {\n\t\tEFA_SET(&create_cmd.cq_caps_1,\n\t\t\tEFA_ADMIN_CREATE_CQ_CMD_INTERRUPT_MODE_ENABLED, 1);\n\t\tcreate_cmd.eqn = params->eqn;\n\t}\n\tif (params->set_src_addr) {\n\t\tEFA_SET(&create_cmd.cq_caps_2,\n\t\t\tEFA_ADMIN_CREATE_CQ_CMD_SET_SRC_ADDR, 1);\n\t}\n\tefa_com_set_dma_addr(params->dma_addr,\n\t\t\t     &create_cmd.cq_ba.mem_addr_high,\n\t\t\t     &create_cmd.cq_ba.mem_addr_low);\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&create_cmd,\n\t\t\t       sizeof(create_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&cmd_completion,\n\t\t\t       sizeof(cmd_completion));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to create cq[%d]\\n\", err);\n\t\treturn err;\n\t}\n\n\tresult->cq_idx = cmd_completion.cq_idx;\n\tresult->actual_depth = params->cq_depth;\n\tresult->db_off = cmd_completion.db_offset;\n\tresult->db_valid = EFA_GET(&cmd_completion.flags,\n\t\t\t\t   EFA_ADMIN_CREATE_CQ_RESP_DB_VALID);\n\n\treturn 0;\n}\n\nint efa_com_destroy_cq(struct efa_com_dev *edev,\n\t\t       struct efa_com_destroy_cq_params *params)\n{\n\tstruct efa_admin_destroy_cq_cmd destroy_cmd = {};\n\tstruct efa_admin_destroy_cq_resp destroy_resp;\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tint err;\n\n\tdestroy_cmd.cq_idx = params->cq_idx;\n\tdestroy_cmd.aq_common_desc.opcode = EFA_ADMIN_DESTROY_CQ;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&destroy_cmd,\n\t\t\t       sizeof(destroy_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&destroy_resp,\n\t\t\t       sizeof(destroy_resp));\n\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to destroy CQ-%u [%d]\\n\",\n\t\t\t\t      params->cq_idx, err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint efa_com_register_mr(struct efa_com_dev *edev,\n\t\t\tstruct efa_com_reg_mr_params *params,\n\t\t\tstruct efa_com_reg_mr_result *result)\n{\n\tstruct efa_admin_reg_mr_resp cmd_completion;\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_reg_mr_cmd mr_cmd = {};\n\tint err;\n\n\tmr_cmd.aq_common_desc.opcode = EFA_ADMIN_REG_MR;\n\tmr_cmd.pd = params->pd;\n\tmr_cmd.mr_length = params->mr_length_in_bytes;\n\tEFA_SET(&mr_cmd.flags, EFA_ADMIN_REG_MR_CMD_PHYS_PAGE_SIZE_SHIFT,\n\t\tparams->page_shift);\n\tmr_cmd.iova = params->iova;\n\tmr_cmd.permissions = params->permissions;\n\n\tif (params->inline_pbl) {\n\t\tmemcpy(mr_cmd.pbl.inline_pbl_array,\n\t\t       params->pbl.inline_pbl_array,\n\t\t       sizeof(mr_cmd.pbl.inline_pbl_array));\n\t} else {\n\t\tmr_cmd.pbl.pbl.length = params->pbl.pbl.length;\n\t\tmr_cmd.pbl.pbl.address.mem_addr_low =\n\t\t\tparams->pbl.pbl.address.mem_addr_low;\n\t\tmr_cmd.pbl.pbl.address.mem_addr_high =\n\t\t\tparams->pbl.pbl.address.mem_addr_high;\n\t\tEFA_SET(&mr_cmd.aq_common_desc.flags,\n\t\t\tEFA_ADMIN_AQ_COMMON_DESC_CTRL_DATA, 1);\n\t\tif (params->indirect)\n\t\t\tEFA_SET(&mr_cmd.aq_common_desc.flags,\n\t\t\t\tEFA_ADMIN_AQ_COMMON_DESC_CTRL_DATA_INDIRECT, 1);\n\t}\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&mr_cmd,\n\t\t\t       sizeof(mr_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&cmd_completion,\n\t\t\t       sizeof(cmd_completion));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to register mr [%d]\\n\", err);\n\t\treturn err;\n\t}\n\n\tresult->l_key = cmd_completion.l_key;\n\tresult->r_key = cmd_completion.r_key;\n\n\treturn 0;\n}\n\nint efa_com_dereg_mr(struct efa_com_dev *edev,\n\t\t     struct efa_com_dereg_mr_params *params)\n{\n\tstruct efa_admin_dereg_mr_resp cmd_completion;\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_dereg_mr_cmd mr_cmd = {};\n\tint err;\n\n\tmr_cmd.aq_common_desc.opcode = EFA_ADMIN_DEREG_MR;\n\tmr_cmd.l_key = params->l_key;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&mr_cmd,\n\t\t\t       sizeof(mr_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&cmd_completion,\n\t\t\t       sizeof(cmd_completion));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to de-register mr(lkey-%u) [%d]\\n\",\n\t\t\t\t      mr_cmd.l_key, err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint efa_com_create_ah(struct efa_com_dev *edev,\n\t\t      struct efa_com_create_ah_params *params,\n\t\t      struct efa_com_create_ah_result *result)\n{\n\tstruct efa_admin_create_ah_resp cmd_completion;\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_create_ah_cmd ah_cmd = {};\n\tint err;\n\n\tah_cmd.aq_common_desc.opcode = EFA_ADMIN_CREATE_AH;\n\n\tmemcpy(ah_cmd.dest_addr, params->dest_addr, sizeof(ah_cmd.dest_addr));\n\tah_cmd.pd = params->pdn;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&ah_cmd,\n\t\t\t       sizeof(ah_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&cmd_completion,\n\t\t\t       sizeof(cmd_completion));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to create ah for %pI6 [%d]\\n\",\n\t\t\t\t      ah_cmd.dest_addr, err);\n\t\treturn err;\n\t}\n\n\tresult->ah = cmd_completion.ah;\n\n\treturn 0;\n}\n\nint efa_com_destroy_ah(struct efa_com_dev *edev,\n\t\t       struct efa_com_destroy_ah_params *params)\n{\n\tstruct efa_admin_destroy_ah_resp cmd_completion;\n\tstruct efa_admin_destroy_ah_cmd ah_cmd = {};\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tint err;\n\n\tah_cmd.aq_common_desc.opcode = EFA_ADMIN_DESTROY_AH;\n\tah_cmd.ah = params->ah;\n\tah_cmd.pd = params->pdn;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&ah_cmd,\n\t\t\t       sizeof(ah_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&cmd_completion,\n\t\t\t       sizeof(cmd_completion));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to destroy ah-%d pd-%d [%d]\\n\",\n\t\t\t\t      ah_cmd.ah, ah_cmd.pd, err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nbool\nefa_com_check_supported_feature_id(struct efa_com_dev *edev,\n\t\t\t\t   enum efa_admin_aq_feature_id feature_id)\n{\n\tu32 feature_mask = 1 << feature_id;\n\n\t \n\tif (feature_id != EFA_ADMIN_DEVICE_ATTR &&\n\t    !(edev->supported_features & feature_mask))\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic int efa_com_get_feature_ex(struct efa_com_dev *edev,\n\t\t\t\t  struct efa_admin_get_feature_resp *get_resp,\n\t\t\t\t  enum efa_admin_aq_feature_id feature_id,\n\t\t\t\t  dma_addr_t control_buf_dma_addr,\n\t\t\t\t  u32 control_buff_size)\n{\n\tstruct efa_admin_get_feature_cmd get_cmd = {};\n\tstruct efa_com_admin_queue *aq;\n\tint err;\n\n\tif (!efa_com_check_supported_feature_id(edev, feature_id)) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Feature %d isn't supported\\n\",\n\t\t\t\t      feature_id);\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\taq = &edev->aq;\n\n\tget_cmd.aq_common_descriptor.opcode = EFA_ADMIN_GET_FEATURE;\n\n\tif (control_buff_size)\n\t\tEFA_SET(&get_cmd.aq_common_descriptor.flags,\n\t\t\tEFA_ADMIN_AQ_COMMON_DESC_CTRL_DATA, 1);\n\n\tefa_com_set_dma_addr(control_buf_dma_addr,\n\t\t\t     &get_cmd.control_buffer.address.mem_addr_high,\n\t\t\t     &get_cmd.control_buffer.address.mem_addr_low);\n\n\tget_cmd.control_buffer.length = control_buff_size;\n\tget_cmd.feature_common.feature_id = feature_id;\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)\n\t\t\t       &get_cmd,\n\t\t\t       sizeof(get_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)\n\t\t\t       get_resp,\n\t\t\t       sizeof(*get_resp));\n\n\tif (err) {\n\t\tibdev_err_ratelimited(\n\t\t\tedev->efa_dev,\n\t\t\t\"Failed to submit get_feature command %d [%d]\\n\",\n\t\t\tfeature_id, err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int efa_com_get_feature(struct efa_com_dev *edev,\n\t\t\t       struct efa_admin_get_feature_resp *get_resp,\n\t\t\t       enum efa_admin_aq_feature_id feature_id)\n{\n\treturn efa_com_get_feature_ex(edev, get_resp, feature_id, 0, 0);\n}\n\nint efa_com_get_device_attr(struct efa_com_dev *edev,\n\t\t\t    struct efa_com_get_device_attr_result *result)\n{\n\tstruct efa_admin_get_feature_resp resp;\n\tint err;\n\n\terr = efa_com_get_feature(edev, &resp, EFA_ADMIN_DEVICE_ATTR);\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to get device attributes %d\\n\",\n\t\t\t\t      err);\n\t\treturn err;\n\t}\n\n\tresult->page_size_cap = resp.u.device_attr.page_size_cap;\n\tresult->fw_version = resp.u.device_attr.fw_version;\n\tresult->admin_api_version = resp.u.device_attr.admin_api_version;\n\tresult->device_version = resp.u.device_attr.device_version;\n\tresult->supported_features = resp.u.device_attr.supported_features;\n\tresult->phys_addr_width = resp.u.device_attr.phys_addr_width;\n\tresult->virt_addr_width = resp.u.device_attr.virt_addr_width;\n\tresult->db_bar = resp.u.device_attr.db_bar;\n\tresult->max_rdma_size = resp.u.device_attr.max_rdma_size;\n\tresult->device_caps = resp.u.device_attr.device_caps;\n\n\tif (result->admin_api_version < 1) {\n\t\tibdev_err_ratelimited(\n\t\t\tedev->efa_dev,\n\t\t\t\"Failed to get device attr api version [%u < 1]\\n\",\n\t\t\tresult->admin_api_version);\n\t\treturn -EINVAL;\n\t}\n\n\tedev->supported_features = resp.u.device_attr.supported_features;\n\terr = efa_com_get_feature(edev, &resp,\n\t\t\t\t  EFA_ADMIN_QUEUE_ATTR);\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to get queue attributes %d\\n\",\n\t\t\t\t      err);\n\t\treturn err;\n\t}\n\n\tresult->max_qp = resp.u.queue_attr.max_qp;\n\tresult->max_sq_depth = resp.u.queue_attr.max_sq_depth;\n\tresult->max_rq_depth = resp.u.queue_attr.max_rq_depth;\n\tresult->max_cq = resp.u.queue_attr.max_cq;\n\tresult->max_cq_depth = resp.u.queue_attr.max_cq_depth;\n\tresult->inline_buf_size = resp.u.queue_attr.inline_buf_size;\n\tresult->max_sq_sge = resp.u.queue_attr.max_wr_send_sges;\n\tresult->max_rq_sge = resp.u.queue_attr.max_wr_recv_sges;\n\tresult->max_mr = resp.u.queue_attr.max_mr;\n\tresult->max_mr_pages = resp.u.queue_attr.max_mr_pages;\n\tresult->max_pd = resp.u.queue_attr.max_pd;\n\tresult->max_ah = resp.u.queue_attr.max_ah;\n\tresult->max_llq_size = resp.u.queue_attr.max_llq_size;\n\tresult->sub_cqs_per_cq = resp.u.queue_attr.sub_cqs_per_cq;\n\tresult->max_wr_rdma_sge = resp.u.queue_attr.max_wr_rdma_sges;\n\tresult->max_tx_batch = resp.u.queue_attr.max_tx_batch;\n\tresult->min_sq_depth = resp.u.queue_attr.min_sq_depth;\n\n\terr = efa_com_get_feature(edev, &resp, EFA_ADMIN_NETWORK_ATTR);\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to get network attributes %d\\n\",\n\t\t\t\t      err);\n\t\treturn err;\n\t}\n\n\tmemcpy(result->addr, resp.u.network_attr.addr,\n\t       sizeof(resp.u.network_attr.addr));\n\tresult->mtu = resp.u.network_attr.mtu;\n\n\tif (efa_com_check_supported_feature_id(edev,\n\t\t\t\t\t       EFA_ADMIN_EVENT_QUEUE_ATTR)) {\n\t\terr = efa_com_get_feature(edev, &resp,\n\t\t\t\t\t  EFA_ADMIN_EVENT_QUEUE_ATTR);\n\t\tif (err) {\n\t\t\tibdev_err_ratelimited(\n\t\t\t\tedev->efa_dev,\n\t\t\t\t\"Failed to get event queue attributes %d\\n\",\n\t\t\t\terr);\n\t\t\treturn err;\n\t\t}\n\n\t\tresult->max_eq = resp.u.event_queue_attr.max_eq;\n\t\tresult->max_eq_depth = resp.u.event_queue_attr.max_eq_depth;\n\t\tresult->event_bitmask = resp.u.event_queue_attr.event_bitmask;\n\t}\n\n\treturn 0;\n}\n\nint efa_com_get_hw_hints(struct efa_com_dev *edev,\n\t\t\t struct efa_com_get_hw_hints_result *result)\n{\n\tstruct efa_admin_get_feature_resp resp;\n\tint err;\n\n\terr = efa_com_get_feature(edev, &resp, EFA_ADMIN_HW_HINTS);\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to get hw hints %d\\n\", err);\n\t\treturn err;\n\t}\n\n\tresult->admin_completion_timeout = resp.u.hw_hints.admin_completion_timeout;\n\tresult->driver_watchdog_timeout = resp.u.hw_hints.driver_watchdog_timeout;\n\tresult->mmio_read_timeout = resp.u.hw_hints.mmio_read_timeout;\n\tresult->poll_interval = resp.u.hw_hints.poll_interval;\n\n\treturn 0;\n}\n\nint efa_com_set_feature_ex(struct efa_com_dev *edev,\n\t\t\t   struct efa_admin_set_feature_resp *set_resp,\n\t\t\t   struct efa_admin_set_feature_cmd *set_cmd,\n\t\t\t   enum efa_admin_aq_feature_id feature_id,\n\t\t\t   dma_addr_t control_buf_dma_addr,\n\t\t\t   u32 control_buff_size)\n{\n\tstruct efa_com_admin_queue *aq;\n\tint err;\n\n\tif (!efa_com_check_supported_feature_id(edev, feature_id)) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Feature %d isn't supported\\n\",\n\t\t\t\t      feature_id);\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\taq = &edev->aq;\n\n\tset_cmd->aq_common_descriptor.opcode = EFA_ADMIN_SET_FEATURE;\n\tif (control_buff_size) {\n\t\tset_cmd->aq_common_descriptor.flags = 0;\n\t\tEFA_SET(&set_cmd->aq_common_descriptor.flags,\n\t\t\tEFA_ADMIN_AQ_COMMON_DESC_CTRL_DATA, 1);\n\t\tefa_com_set_dma_addr(control_buf_dma_addr,\n\t\t\t\t     &set_cmd->control_buffer.address.mem_addr_high,\n\t\t\t\t     &set_cmd->control_buffer.address.mem_addr_low);\n\t}\n\n\tset_cmd->control_buffer.length = control_buff_size;\n\tset_cmd->feature_common.feature_id = feature_id;\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)set_cmd,\n\t\t\t       sizeof(*set_cmd),\n\t\t\t       (struct efa_admin_acq_entry *)set_resp,\n\t\t\t       sizeof(*set_resp));\n\n\tif (err) {\n\t\tibdev_err_ratelimited(\n\t\t\tedev->efa_dev,\n\t\t\t\"Failed to submit set_feature command %d error: %d\\n\",\n\t\t\tfeature_id, err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int efa_com_set_feature(struct efa_com_dev *edev,\n\t\t\t       struct efa_admin_set_feature_resp *set_resp,\n\t\t\t       struct efa_admin_set_feature_cmd *set_cmd,\n\t\t\t       enum efa_admin_aq_feature_id feature_id)\n{\n\treturn efa_com_set_feature_ex(edev, set_resp, set_cmd, feature_id,\n\t\t\t\t      0, 0);\n}\n\nint efa_com_set_aenq_config(struct efa_com_dev *edev, u32 groups)\n{\n\tstruct efa_admin_get_feature_resp get_resp;\n\tstruct efa_admin_set_feature_resp set_resp;\n\tstruct efa_admin_set_feature_cmd cmd = {};\n\tint err;\n\n\tibdev_dbg(edev->efa_dev, \"Configuring aenq with groups[%#x]\\n\", groups);\n\n\terr = efa_com_get_feature(edev, &get_resp, EFA_ADMIN_AENQ_CONFIG);\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to get aenq attributes: %d\\n\",\n\t\t\t\t      err);\n\t\treturn err;\n\t}\n\n\tibdev_dbg(edev->efa_dev,\n\t\t  \"Get aenq groups: supported[%#x] enabled[%#x]\\n\",\n\t\t  get_resp.u.aenq.supported_groups,\n\t\t  get_resp.u.aenq.enabled_groups);\n\n\tif ((get_resp.u.aenq.supported_groups & groups) != groups) {\n\t\tibdev_err_ratelimited(\n\t\t\tedev->efa_dev,\n\t\t\t\"Trying to set unsupported aenq groups[%#x] supported[%#x]\\n\",\n\t\t\tgroups, get_resp.u.aenq.supported_groups);\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tcmd.u.aenq.enabled_groups = groups;\n\terr = efa_com_set_feature(edev, &set_resp, &cmd,\n\t\t\t\t  EFA_ADMIN_AENQ_CONFIG);\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to set aenq attributes: %d\\n\",\n\t\t\t\t      err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint efa_com_alloc_pd(struct efa_com_dev *edev,\n\t\t     struct efa_com_alloc_pd_result *result)\n{\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_alloc_pd_cmd cmd = {};\n\tstruct efa_admin_alloc_pd_resp resp;\n\tint err;\n\n\tcmd.aq_common_descriptor.opcode = EFA_ADMIN_ALLOC_PD;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&cmd,\n\t\t\t       sizeof(cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&resp,\n\t\t\t       sizeof(resp));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to allocate pd[%d]\\n\", err);\n\t\treturn err;\n\t}\n\n\tresult->pdn = resp.pd;\n\n\treturn 0;\n}\n\nint efa_com_dealloc_pd(struct efa_com_dev *edev,\n\t\t       struct efa_com_dealloc_pd_params *params)\n{\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_dealloc_pd_cmd cmd = {};\n\tstruct efa_admin_dealloc_pd_resp resp;\n\tint err;\n\n\tcmd.aq_common_descriptor.opcode = EFA_ADMIN_DEALLOC_PD;\n\tcmd.pd = params->pdn;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&cmd,\n\t\t\t       sizeof(cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&resp,\n\t\t\t       sizeof(resp));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to deallocate pd-%u [%d]\\n\",\n\t\t\t\t      cmd.pd, err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint efa_com_alloc_uar(struct efa_com_dev *edev,\n\t\t      struct efa_com_alloc_uar_result *result)\n{\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_alloc_uar_cmd cmd = {};\n\tstruct efa_admin_alloc_uar_resp resp;\n\tint err;\n\n\tcmd.aq_common_descriptor.opcode = EFA_ADMIN_ALLOC_UAR;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&cmd,\n\t\t\t       sizeof(cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&resp,\n\t\t\t       sizeof(resp));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to allocate uar[%d]\\n\", err);\n\t\treturn err;\n\t}\n\n\tresult->uarn = resp.uar;\n\n\treturn 0;\n}\n\nint efa_com_dealloc_uar(struct efa_com_dev *edev,\n\t\t\tstruct efa_com_dealloc_uar_params *params)\n{\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_dealloc_uar_cmd cmd = {};\n\tstruct efa_admin_dealloc_uar_resp resp;\n\tint err;\n\n\tcmd.aq_common_descriptor.opcode = EFA_ADMIN_DEALLOC_UAR;\n\tcmd.uar = params->uarn;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&cmd,\n\t\t\t       sizeof(cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&resp,\n\t\t\t       sizeof(resp));\n\tif (err) {\n\t\tibdev_err_ratelimited(edev->efa_dev,\n\t\t\t\t      \"Failed to deallocate uar-%u [%d]\\n\",\n\t\t\t\t      cmd.uar, err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint efa_com_get_stats(struct efa_com_dev *edev,\n\t\t      struct efa_com_get_stats_params *params,\n\t\t      union efa_com_get_stats_result *result)\n{\n\tstruct efa_com_admin_queue *aq = &edev->aq;\n\tstruct efa_admin_aq_get_stats_cmd cmd = {};\n\tstruct efa_admin_acq_get_stats_resp resp;\n\tint err;\n\n\tcmd.aq_common_descriptor.opcode = EFA_ADMIN_GET_STATS;\n\tcmd.type = params->type;\n\tcmd.scope = params->scope;\n\tcmd.scope_modifier = params->scope_modifier;\n\n\terr = efa_com_cmd_exec(aq,\n\t\t\t       (struct efa_admin_aq_entry *)&cmd,\n\t\t\t       sizeof(cmd),\n\t\t\t       (struct efa_admin_acq_entry *)&resp,\n\t\t\t       sizeof(resp));\n\tif (err) {\n\t\tibdev_err_ratelimited(\n\t\t\tedev->efa_dev,\n\t\t\t\"Failed to get stats type-%u scope-%u.%u [%d]\\n\",\n\t\t\tcmd.type, cmd.scope, cmd.scope_modifier, err);\n\t\treturn err;\n\t}\n\n\tswitch (cmd.type) {\n\tcase EFA_ADMIN_GET_STATS_TYPE_BASIC:\n\t\tresult->basic_stats.tx_bytes = resp.u.basic_stats.tx_bytes;\n\t\tresult->basic_stats.tx_pkts = resp.u.basic_stats.tx_pkts;\n\t\tresult->basic_stats.rx_bytes = resp.u.basic_stats.rx_bytes;\n\t\tresult->basic_stats.rx_pkts = resp.u.basic_stats.rx_pkts;\n\t\tresult->basic_stats.rx_drops = resp.u.basic_stats.rx_drops;\n\t\tbreak;\n\tcase EFA_ADMIN_GET_STATS_TYPE_MESSAGES:\n\t\tresult->messages_stats.send_bytes = resp.u.messages_stats.send_bytes;\n\t\tresult->messages_stats.send_wrs = resp.u.messages_stats.send_wrs;\n\t\tresult->messages_stats.recv_bytes = resp.u.messages_stats.recv_bytes;\n\t\tresult->messages_stats.recv_wrs = resp.u.messages_stats.recv_wrs;\n\t\tbreak;\n\tcase EFA_ADMIN_GET_STATS_TYPE_RDMA_READ:\n\t\tresult->rdma_read_stats.read_wrs = resp.u.rdma_read_stats.read_wrs;\n\t\tresult->rdma_read_stats.read_bytes = resp.u.rdma_read_stats.read_bytes;\n\t\tresult->rdma_read_stats.read_wr_err = resp.u.rdma_read_stats.read_wr_err;\n\t\tresult->rdma_read_stats.read_resp_bytes = resp.u.rdma_read_stats.read_resp_bytes;\n\t\tbreak;\n\tcase EFA_ADMIN_GET_STATS_TYPE_RDMA_WRITE:\n\t\tresult->rdma_write_stats.write_wrs = resp.u.rdma_write_stats.write_wrs;\n\t\tresult->rdma_write_stats.write_bytes = resp.u.rdma_write_stats.write_bytes;\n\t\tresult->rdma_write_stats.write_wr_err = resp.u.rdma_write_stats.write_wr_err;\n\t\tresult->rdma_write_stats.write_recv_bytes = resp.u.rdma_write_stats.write_recv_bytes;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}