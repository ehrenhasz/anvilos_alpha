{
  "module_name": "pvrdma_cmd.c",
  "hash_id": "dc16b04d9871c1ff9da8968a8c382697fb6c75cd9171d776b3364b97e1ff9d7a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/vmw_pvrdma/pvrdma_cmd.c",
  "human_readable_source": " \n\n#include <linux/list.h>\n\n#include \"pvrdma.h\"\n\n#define PVRDMA_CMD_TIMEOUT\t10000  \n\nstatic inline int pvrdma_cmd_recv(struct pvrdma_dev *dev,\n\t\t\t\t  union pvrdma_cmd_resp *resp,\n\t\t\t\t  unsigned resp_code)\n{\n\tint err;\n\n\tdev_dbg(&dev->pdev->dev, \"receive response from device\\n\");\n\n\terr = wait_for_completion_interruptible_timeout(&dev->cmd_done,\n\t\t\tmsecs_to_jiffies(PVRDMA_CMD_TIMEOUT));\n\tif (err == 0 || err == -ERESTARTSYS) {\n\t\tdev_warn(&dev->pdev->dev,\n\t\t\t \"completion timeout or interrupted\\n\");\n\t\treturn -ETIMEDOUT;\n\t}\n\n\tspin_lock(&dev->cmd_lock);\n\tmemcpy(resp, dev->resp_slot, sizeof(*resp));\n\tspin_unlock(&dev->cmd_lock);\n\n\tif (resp->hdr.ack != resp_code) {\n\t\tdev_warn(&dev->pdev->dev,\n\t\t\t \"unknown response %#x expected %#x\\n\",\n\t\t\t resp->hdr.ack, resp_code);\n\t\treturn -EFAULT;\n\t}\n\n\treturn 0;\n}\n\nint\npvrdma_cmd_post(struct pvrdma_dev *dev, union pvrdma_cmd_req *req,\n\t\tunion pvrdma_cmd_resp *resp, unsigned resp_code)\n{\n\tint err;\n\n\tdev_dbg(&dev->pdev->dev, \"post request to device\\n\");\n\n\t \n\tdown(&dev->cmd_sema);\n\n\tBUILD_BUG_ON(sizeof(union pvrdma_cmd_req) !=\n\t\t     sizeof(struct pvrdma_cmd_modify_qp));\n\n\tspin_lock(&dev->cmd_lock);\n\tmemcpy(dev->cmd_slot, req, sizeof(*req));\n\tspin_unlock(&dev->cmd_lock);\n\n\tinit_completion(&dev->cmd_done);\n\tpvrdma_write_reg(dev, PVRDMA_REG_REQUEST, 0);\n\n\t \n\tmb();\n\n\terr = pvrdma_read_reg(dev, PVRDMA_REG_ERR);\n\tif (err == 0) {\n\t\tif (resp != NULL)\n\t\t\terr = pvrdma_cmd_recv(dev, resp, resp_code);\n\t} else {\n\t\tdev_warn(&dev->pdev->dev,\n\t\t\t \"failed to write request error reg: %d\\n\", err);\n\t\terr = -EFAULT;\n\t}\n\n\tup(&dev->cmd_sema);\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}