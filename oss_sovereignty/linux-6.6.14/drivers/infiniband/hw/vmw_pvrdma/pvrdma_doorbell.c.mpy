{
  "module_name": "pvrdma_doorbell.c",
  "hash_id": "c46290c2723d3f0581d4f4ae25886cbe0cdc5c4453f7f6a926471eda17a925a6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/vmw_pvrdma/pvrdma_doorbell.c",
  "human_readable_source": " \n\n#include <linux/bitmap.h>\n#include <linux/errno.h>\n#include <linux/slab.h>\n\n#include \"pvrdma.h\"\n\nint pvrdma_uar_table_init(struct pvrdma_dev *dev)\n{\n\tu32 num = dev->dsr->caps.max_uar;\n\tu32 mask = num - 1;\n\tstruct pvrdma_id_table *tbl = &dev->uar_table.tbl;\n\n\tif (!is_power_of_2(num))\n\t\treturn -EINVAL;\n\n\ttbl->last = 0;\n\ttbl->top = 0;\n\ttbl->max = num;\n\ttbl->mask = mask;\n\tspin_lock_init(&tbl->lock);\n\ttbl->table = bitmap_zalloc(num, GFP_KERNEL);\n\tif (!tbl->table)\n\t\treturn -ENOMEM;\n\n\t \n\t__set_bit(0, tbl->table);\n\n\treturn 0;\n}\n\nvoid pvrdma_uar_table_cleanup(struct pvrdma_dev *dev)\n{\n\tstruct pvrdma_id_table *tbl = &dev->uar_table.tbl;\n\n\tbitmap_free(tbl->table);\n}\n\nint pvrdma_uar_alloc(struct pvrdma_dev *dev, struct pvrdma_uar_map *uar)\n{\n\tstruct pvrdma_id_table *tbl;\n\tunsigned long flags;\n\tu32 obj;\n\n\ttbl = &dev->uar_table.tbl;\n\n\tspin_lock_irqsave(&tbl->lock, flags);\n\tobj = find_next_zero_bit(tbl->table, tbl->max, tbl->last);\n\tif (obj >= tbl->max) {\n\t\ttbl->top = (tbl->top + tbl->max) & tbl->mask;\n\t\tobj = find_first_zero_bit(tbl->table, tbl->max);\n\t}\n\n\tif (obj >= tbl->max) {\n\t\tspin_unlock_irqrestore(&tbl->lock, flags);\n\t\treturn -ENOMEM;\n\t}\n\n\t__set_bit(obj, tbl->table);\n\tobj |= tbl->top;\n\n\tspin_unlock_irqrestore(&tbl->lock, flags);\n\n\tuar->index = obj;\n\tuar->pfn = (pci_resource_start(dev->pdev, PVRDMA_PCI_RESOURCE_UAR) >>\n\t\t    PAGE_SHIFT) + uar->index;\n\n\treturn 0;\n}\n\nvoid pvrdma_uar_free(struct pvrdma_dev *dev, struct pvrdma_uar_map *uar)\n{\n\tstruct pvrdma_id_table *tbl = &dev->uar_table.tbl;\n\tunsigned long flags;\n\tu32 obj;\n\n\tobj = uar->index & (tbl->max - 1);\n\tspin_lock_irqsave(&tbl->lock, flags);\n\t__clear_bit(obj, tbl->table);\n\ttbl->last = min(tbl->last, obj);\n\ttbl->top = (tbl->top + tbl->max) & tbl->mask;\n\tspin_unlock_irqrestore(&tbl->lock, flags);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}