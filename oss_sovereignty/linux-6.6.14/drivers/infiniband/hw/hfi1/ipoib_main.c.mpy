{
  "module_name": "ipoib_main.c",
  "hash_id": "3df64b46a9573792f01333bfd698c26d8f755c6400a8f3275a9faab27637e07b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hfi1/ipoib_main.c",
  "human_readable_source": "\n \n\n \n\n#include \"ipoib.h\"\n#include \"hfi.h\"\n\nstatic u32 qpn_from_mac(const u8 *mac_arr)\n{\n\treturn (u32)mac_arr[1] << 16 | mac_arr[2] << 8 | mac_arr[3];\n}\n\nstatic int hfi1_ipoib_dev_init(struct net_device *dev)\n{\n\tstruct hfi1_ipoib_dev_priv *priv = hfi1_ipoib_priv(dev);\n\tint ret;\n\n\tdev->tstats = netdev_alloc_pcpu_stats(struct pcpu_sw_netstats);\n\tif (!dev->tstats)\n\t\treturn -ENOMEM;\n\n\tret = priv->netdev_ops->ndo_init(dev);\n\tif (ret)\n\t\tgoto out_ret;\n\n\tret = hfi1_netdev_add_data(priv->dd,\n\t\t\t\t   qpn_from_mac(priv->netdev->dev_addr),\n\t\t\t\t   dev);\n\tif (ret < 0) {\n\t\tpriv->netdev_ops->ndo_uninit(dev);\n\t\tgoto out_ret;\n\t}\n\n\treturn 0;\nout_ret:\n\tfree_percpu(dev->tstats);\n\tdev->tstats = NULL;\n\treturn ret;\n}\n\nstatic void hfi1_ipoib_dev_uninit(struct net_device *dev)\n{\n\tstruct hfi1_ipoib_dev_priv *priv = hfi1_ipoib_priv(dev);\n\n\tfree_percpu(dev->tstats);\n\tdev->tstats = NULL;\n\n\thfi1_netdev_remove_data(priv->dd, qpn_from_mac(priv->netdev->dev_addr));\n\n\tpriv->netdev_ops->ndo_uninit(dev);\n}\n\nstatic int hfi1_ipoib_dev_open(struct net_device *dev)\n{\n\tstruct hfi1_ipoib_dev_priv *priv = hfi1_ipoib_priv(dev);\n\tint ret;\n\n\tret = priv->netdev_ops->ndo_open(dev);\n\tif (!ret) {\n\t\tstruct hfi1_ibport *ibp = to_iport(priv->device,\n\t\t\t\t\t\t   priv->port_num);\n\t\tstruct rvt_qp *qp;\n\t\tu32 qpn = qpn_from_mac(priv->netdev->dev_addr);\n\n\t\trcu_read_lock();\n\t\tqp = rvt_lookup_qpn(ib_to_rvt(priv->device), &ibp->rvp, qpn);\n\t\tif (!qp) {\n\t\t\trcu_read_unlock();\n\t\t\tpriv->netdev_ops->ndo_stop(dev);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\trvt_get_qp(qp);\n\t\tpriv->qp = qp;\n\t\trcu_read_unlock();\n\n\t\thfi1_netdev_enable_queues(priv->dd);\n\t\thfi1_ipoib_napi_tx_enable(dev);\n\t}\n\n\treturn ret;\n}\n\nstatic int hfi1_ipoib_dev_stop(struct net_device *dev)\n{\n\tstruct hfi1_ipoib_dev_priv *priv = hfi1_ipoib_priv(dev);\n\n\tif (!priv->qp)\n\t\treturn 0;\n\n\thfi1_ipoib_napi_tx_disable(dev);\n\thfi1_netdev_disable_queues(priv->dd);\n\n\trvt_put_qp(priv->qp);\n\tpriv->qp = NULL;\n\n\treturn priv->netdev_ops->ndo_stop(dev);\n}\n\nstatic const struct net_device_ops hfi1_ipoib_netdev_ops = {\n\t.ndo_init         = hfi1_ipoib_dev_init,\n\t.ndo_uninit       = hfi1_ipoib_dev_uninit,\n\t.ndo_open         = hfi1_ipoib_dev_open,\n\t.ndo_stop         = hfi1_ipoib_dev_stop,\n\t.ndo_get_stats64  = dev_get_tstats64,\n};\n\nstatic int hfi1_ipoib_mcast_attach(struct net_device *dev,\n\t\t\t\t   struct ib_device *device,\n\t\t\t\t   union ib_gid *mgid,\n\t\t\t\t   u16 mlid,\n\t\t\t\t   int set_qkey,\n\t\t\t\t   u32 qkey)\n{\n\tstruct hfi1_ipoib_dev_priv *priv = hfi1_ipoib_priv(dev);\n\tu32 qpn = (u32)qpn_from_mac(priv->netdev->dev_addr);\n\tstruct hfi1_ibport *ibp = to_iport(priv->device, priv->port_num);\n\tstruct rvt_qp *qp;\n\tint ret = -EINVAL;\n\n\trcu_read_lock();\n\n\tqp = rvt_lookup_qpn(ib_to_rvt(priv->device), &ibp->rvp, qpn);\n\tif (qp) {\n\t\trvt_get_qp(qp);\n\t\trcu_read_unlock();\n\t\tif (set_qkey)\n\t\t\tpriv->qkey = qkey;\n\n\t\t \n\t\tret = ib_attach_mcast(&qp->ibqp, mgid, mlid);\n\t\trvt_put_qp(qp);\n\t} else {\n\t\trcu_read_unlock();\n\t}\n\n\treturn ret;\n}\n\nstatic int hfi1_ipoib_mcast_detach(struct net_device *dev,\n\t\t\t\t   struct ib_device *device,\n\t\t\t\t   union ib_gid *mgid,\n\t\t\t\t   u16 mlid)\n{\n\tstruct hfi1_ipoib_dev_priv *priv = hfi1_ipoib_priv(dev);\n\tu32 qpn = (u32)qpn_from_mac(priv->netdev->dev_addr);\n\tstruct hfi1_ibport *ibp = to_iport(priv->device, priv->port_num);\n\tstruct rvt_qp *qp;\n\tint ret = -EINVAL;\n\n\trcu_read_lock();\n\n\tqp = rvt_lookup_qpn(ib_to_rvt(priv->device), &ibp->rvp, qpn);\n\tif (qp) {\n\t\trvt_get_qp(qp);\n\t\trcu_read_unlock();\n\t\tret = ib_detach_mcast(&qp->ibqp, mgid, mlid);\n\t\trvt_put_qp(qp);\n\t} else {\n\t\trcu_read_unlock();\n\t}\n\treturn ret;\n}\n\nstatic void hfi1_ipoib_netdev_dtor(struct net_device *dev)\n{\n\tstruct hfi1_ipoib_dev_priv *priv = hfi1_ipoib_priv(dev);\n\n\thfi1_ipoib_txreq_deinit(priv);\n\thfi1_ipoib_rxq_deinit(priv->netdev);\n\n\tfree_percpu(dev->tstats);\n\tdev->tstats = NULL;\n}\n\nstatic void hfi1_ipoib_set_id(struct net_device *dev, int id)\n{\n\tstruct hfi1_ipoib_dev_priv *priv = hfi1_ipoib_priv(dev);\n\n\tpriv->pkey_index = (u16)id;\n\tib_query_pkey(priv->device,\n\t\t      priv->port_num,\n\t\t      priv->pkey_index,\n\t\t      &priv->pkey);\n}\n\nstatic int hfi1_ipoib_setup_rn(struct ib_device *device,\n\t\t\t       u32 port_num,\n\t\t\t       struct net_device *netdev,\n\t\t\t       void *param)\n{\n\tstruct hfi1_devdata *dd = dd_from_ibdev(device);\n\tstruct rdma_netdev *rn = netdev_priv(netdev);\n\tstruct hfi1_ipoib_dev_priv *priv;\n\tint rc;\n\n\trn->send = hfi1_ipoib_send;\n\trn->tx_timeout = hfi1_ipoib_tx_timeout;\n\trn->attach_mcast = hfi1_ipoib_mcast_attach;\n\trn->detach_mcast = hfi1_ipoib_mcast_detach;\n\trn->set_id = hfi1_ipoib_set_id;\n\trn->hca = device;\n\trn->port_num = port_num;\n\trn->mtu = netdev->mtu;\n\n\tpriv = hfi1_ipoib_priv(netdev);\n\tpriv->dd = dd;\n\tpriv->netdev = netdev;\n\tpriv->device = device;\n\tpriv->port_num = port_num;\n\tpriv->netdev_ops = netdev->netdev_ops;\n\n\tib_query_pkey(device, port_num, priv->pkey_index, &priv->pkey);\n\n\trc = hfi1_ipoib_txreq_init(priv);\n\tif (rc) {\n\t\tdd_dev_err(dd, \"IPoIB netdev TX init - failed(%d)\\n\", rc);\n\t\treturn rc;\n\t}\n\n\trc = hfi1_ipoib_rxq_init(netdev);\n\tif (rc) {\n\t\tdd_dev_err(dd, \"IPoIB netdev RX init - failed(%d)\\n\", rc);\n\t\thfi1_ipoib_txreq_deinit(priv);\n\t\treturn rc;\n\t}\n\n\tnetdev->netdev_ops = &hfi1_ipoib_netdev_ops;\n\n\tnetdev->priv_destructor = hfi1_ipoib_netdev_dtor;\n\tnetdev->needs_free_netdev = true;\n\n\treturn 0;\n}\n\nint hfi1_ipoib_rn_get_params(struct ib_device *device,\n\t\t\t     u32 port_num,\n\t\t\t     enum rdma_netdev_t type,\n\t\t\t     struct rdma_netdev_alloc_params *params)\n{\n\tstruct hfi1_devdata *dd = dd_from_ibdev(device);\n\n\tif (type != RDMA_NETDEV_IPOIB)\n\t\treturn -EOPNOTSUPP;\n\n\tif (!HFI1_CAP_IS_KSET(AIP) || !dd->num_netdev_contexts)\n\t\treturn -EOPNOTSUPP;\n\n\tif (!port_num || port_num > dd->num_pports)\n\t\treturn -EINVAL;\n\n\tparams->sizeof_priv = sizeof(struct hfi1_ipoib_rdma_netdev);\n\tparams->txqs = dd->num_sdma;\n\tparams->rxqs = dd->num_netdev_contexts;\n\tparams->param = NULL;\n\tparams->initialize_rdma_netdev = hfi1_ipoib_setup_rn;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}