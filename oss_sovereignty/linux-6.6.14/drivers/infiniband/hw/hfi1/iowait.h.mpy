{
  "module_name": "iowait.h",
  "hash_id": "8bb7f965c2bc25f7fd81ea01b73ed56f8377d4b391f250ba5885ab9936e2ecaa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hfi1/iowait.h",
  "human_readable_source": " \n \n\n#ifndef _HFI1_IOWAIT_H\n#define _HFI1_IOWAIT_H\n\n#include <linux/list.h>\n#include <linux/workqueue.h>\n#include <linux/wait.h>\n#include <linux/sched.h>\n\n#include \"sdma_txreq.h\"\n\n \ntypedef void (*restart_t)(struct work_struct *work);\n\n#define IOWAIT_PENDING_IB  0x0\n#define IOWAIT_PENDING_TID 0x1\n\n \n#define IOWAIT_SES 2\n#define IOWAIT_IB_SE 0\n#define IOWAIT_TID_SE 1\n\nstruct sdma_txreq;\nstruct sdma_engine;\n \nstruct iowait;\nstruct iowait_work {\n\tstruct work_struct iowork;\n\tstruct list_head tx_head;\n\tstruct iowait *iow;\n};\n\n \nstruct iowait {\n\tstruct list_head list;\n\tint (*sleep)(\n\t\tstruct sdma_engine *sde,\n\t\tstruct iowait_work *wait,\n\t\tstruct sdma_txreq *tx,\n\t\tuint seq,\n\t\tbool pkts_sent\n\t\t);\n\tvoid (*wakeup)(struct iowait *wait, int reason);\n\tvoid (*sdma_drained)(struct iowait *wait);\n\tvoid (*init_priority)(struct iowait *wait);\n\tseqlock_t *lock;\n\twait_queue_head_t wait_dma;\n\twait_queue_head_t wait_pio;\n\tatomic_t sdma_busy;\n\tatomic_t pio_busy;\n\tu32 count;\n\tu32 tx_limit;\n\tu32 tx_count;\n\tu8 starved_cnt;\n\tu8 priority;\n\tunsigned long flags;\n\tstruct iowait_work wait[IOWAIT_SES];\n};\n\n#define SDMA_AVAIL_REASON 0\n\nvoid iowait_set_flag(struct iowait *wait, u32 flag);\nbool iowait_flag_set(struct iowait *wait, u32 flag);\nvoid iowait_clear_flag(struct iowait *wait, u32 flag);\n\nvoid iowait_init(struct iowait *wait, u32 tx_limit,\n\t\t void (*func)(struct work_struct *work),\n\t\t void (*tidfunc)(struct work_struct *work),\n\t\t int (*sleep)(struct sdma_engine *sde,\n\t\t\t      struct iowait_work *wait,\n\t\t\t      struct sdma_txreq *tx,\n\t\t\t      uint seq,\n\t\t\t      bool pkts_sent),\n\t\t void (*wakeup)(struct iowait *wait, int reason),\n\t\t void (*sdma_drained)(struct iowait *wait),\n\t\t void (*init_priority)(struct iowait *wait));\n\n \nstatic inline bool iowait_schedule(struct iowait *wait,\n\t\t\t\t   struct workqueue_struct *wq, int cpu)\n{\n\treturn !!queue_work_on(cpu, wq, &wait->wait[IOWAIT_IB_SE].iowork);\n}\n\n \nstatic inline bool iowait_tid_schedule(struct iowait *wait,\n\t\t\t\t       struct workqueue_struct *wq, int cpu)\n{\n\treturn !!queue_work_on(cpu, wq, &wait->wait[IOWAIT_TID_SE].iowork);\n}\n\n \nstatic inline void iowait_sdma_drain(struct iowait *wait)\n{\n\twait_event(wait->wait_dma, !atomic_read(&wait->sdma_busy));\n}\n\n \nstatic inline int iowait_sdma_pending(struct iowait *wait)\n{\n\treturn atomic_read(&wait->sdma_busy);\n}\n\n \nstatic inline void iowait_sdma_inc(struct iowait *wait)\n{\n\tatomic_inc(&wait->sdma_busy);\n}\n\n \nstatic inline void iowait_sdma_add(struct iowait *wait, int count)\n{\n\tatomic_add(count, &wait->sdma_busy);\n}\n\n \nstatic inline int iowait_sdma_dec(struct iowait *wait)\n{\n\tif (!wait)\n\t\treturn 0;\n\treturn atomic_dec_and_test(&wait->sdma_busy);\n}\n\n \nstatic inline void iowait_pio_drain(struct iowait *wait)\n{\n\twait_event_timeout(wait->wait_pio,\n\t\t\t   !atomic_read(&wait->pio_busy),\n\t\t\t   HZ);\n}\n\n \nstatic inline int iowait_pio_pending(struct iowait *wait)\n{\n\treturn atomic_read(&wait->pio_busy);\n}\n\n \nstatic inline void iowait_pio_inc(struct iowait *wait)\n{\n\tatomic_inc(&wait->pio_busy);\n}\n\n \nstatic inline int iowait_pio_dec(struct iowait *wait)\n{\n\tif (!wait)\n\t\treturn 0;\n\treturn atomic_dec_and_test(&wait->pio_busy);\n}\n\n \nstatic inline void iowait_drain_wakeup(struct iowait *wait)\n{\n\twake_up(&wait->wait_dma);\n\twake_up(&wait->wait_pio);\n\tif (wait->sdma_drained)\n\t\twait->sdma_drained(wait);\n}\n\n \nstatic inline struct sdma_txreq *iowait_get_txhead(struct iowait_work *wait)\n{\n\tstruct sdma_txreq *tx = NULL;\n\n\tif (!list_empty(&wait->tx_head)) {\n\t\ttx = list_first_entry(\n\t\t\t&wait->tx_head,\n\t\t\tstruct sdma_txreq,\n\t\t\tlist);\n\t\tlist_del_init(&tx->list);\n\t}\n\treturn tx;\n}\n\nstatic inline u16 iowait_get_desc(struct iowait_work *w)\n{\n\tu16 num_desc = 0;\n\tstruct sdma_txreq *tx = NULL;\n\n\tif (!list_empty(&w->tx_head)) {\n\t\ttx = list_first_entry(&w->tx_head, struct sdma_txreq,\n\t\t\t\t      list);\n\t\tnum_desc = tx->num_desc;\n\t\tif (tx->flags & SDMA_TXREQ_F_VIP)\n\t\t\tw->iow->priority++;\n\t}\n\treturn num_desc;\n}\n\nstatic inline u32 iowait_get_all_desc(struct iowait *w)\n{\n\tu32 num_desc = 0;\n\n\tnum_desc = iowait_get_desc(&w->wait[IOWAIT_IB_SE]);\n\tnum_desc += iowait_get_desc(&w->wait[IOWAIT_TID_SE]);\n\treturn num_desc;\n}\n\nstatic inline void iowait_update_priority(struct iowait_work *w)\n{\n\tstruct sdma_txreq *tx = NULL;\n\n\tif (!list_empty(&w->tx_head)) {\n\t\ttx = list_first_entry(&w->tx_head, struct sdma_txreq,\n\t\t\t\t      list);\n\t\tif (tx->flags & SDMA_TXREQ_F_VIP)\n\t\t\tw->iow->priority++;\n\t}\n}\n\nstatic inline void iowait_update_all_priority(struct iowait *w)\n{\n\tiowait_update_priority(&w->wait[IOWAIT_IB_SE]);\n\tiowait_update_priority(&w->wait[IOWAIT_TID_SE]);\n}\n\nstatic inline void iowait_init_priority(struct iowait *w)\n{\n\tw->priority = 0;\n\tif (w->init_priority)\n\t\tw->init_priority(w);\n}\n\nstatic inline void iowait_get_priority(struct iowait *w)\n{\n\tiowait_init_priority(w);\n\tiowait_update_all_priority(w);\n}\n\n \nstatic inline void iowait_queue(bool pkts_sent, struct iowait *w,\n\t\t\t\tstruct list_head *wait_head)\n{\n\t \n\tif (pkts_sent)\n\t\tw->starved_cnt = 0;\n\telse\n\t\tw->starved_cnt++;\n\n\tif (w->priority > 0 || !pkts_sent)\n\t\tlist_add(&w->list, wait_head);\n\telse\n\t\tlist_add_tail(&w->list, wait_head);\n}\n\n \nstatic inline void iowait_starve_clear(bool pkts_sent, struct iowait *w)\n{\n\tif (pkts_sent)\n\t\tw->starved_cnt = 0;\n}\n\n \nuint iowait_priority_update_top(struct iowait *w,\n\t\t\t\tstruct iowait *top,\n\t\t\t\tuint idx, uint top_idx);\n\n \nstatic inline bool iowait_packet_queued(struct iowait_work *wait)\n{\n\treturn !list_empty(&wait->tx_head);\n}\n\n \nstatic inline void iowait_inc_wait_count(struct iowait_work *w, u16 n)\n{\n\tif (!w)\n\t\treturn;\n\tw->iow->tx_count++;\n\tw->iow->count += n;\n}\n\n \nstatic inline struct iowait_work *iowait_get_tid_work(struct iowait *w)\n{\n\treturn &w->wait[IOWAIT_TID_SE];\n}\n\n \nstatic inline struct iowait_work *iowait_get_ib_work(struct iowait *w)\n{\n\treturn &w->wait[IOWAIT_IB_SE];\n}\n\n \nstatic inline struct iowait *iowait_ioww_to_iow(struct iowait_work *w)\n{\n\tif (likely(w))\n\t\treturn w->iow;\n\treturn NULL;\n}\n\nvoid iowait_cancel_work(struct iowait *w);\nint iowait_set_work_flag(struct iowait_work *w);\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}