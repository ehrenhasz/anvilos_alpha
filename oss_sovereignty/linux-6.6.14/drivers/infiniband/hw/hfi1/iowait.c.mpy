{
  "module_name": "iowait.c",
  "hash_id": "8834b4a02090ff340c792aa5f67b4d79a061046822cf7fd40b853574e7c58fb0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hfi1/iowait.c",
  "human_readable_source": "\n \n#include \"iowait.h\"\n#include \"trace_iowait.h\"\n\n \n#define IOWAIT_PRIORITY_STARVE_SHIFT 4\n\nvoid iowait_set_flag(struct iowait *wait, u32 flag)\n{\n\ttrace_hfi1_iowait_set(wait, flag);\n\tset_bit(flag, &wait->flags);\n}\n\nbool iowait_flag_set(struct iowait *wait, u32 flag)\n{\n\treturn test_bit(flag, &wait->flags);\n}\n\ninline void iowait_clear_flag(struct iowait *wait, u32 flag)\n{\n\ttrace_hfi1_iowait_clear(wait, flag);\n\tclear_bit(flag, &wait->flags);\n}\n\n \nvoid iowait_init(struct iowait *wait, u32 tx_limit,\n\t\t void (*func)(struct work_struct *work),\n\t\t void (*tidfunc)(struct work_struct *work),\n\t\t int (*sleep)(struct sdma_engine *sde,\n\t\t\t      struct iowait_work *wait,\n\t\t\t      struct sdma_txreq *tx,\n\t\t\t      uint seq,\n\t\t\t      bool pkts_sent),\n\t\t void (*wakeup)(struct iowait *wait, int reason),\n\t\t void (*sdma_drained)(struct iowait *wait),\n\t\t void (*init_priority)(struct iowait *wait))\n{\n\tint i;\n\n\twait->count = 0;\n\tINIT_LIST_HEAD(&wait->list);\n\tinit_waitqueue_head(&wait->wait_dma);\n\tinit_waitqueue_head(&wait->wait_pio);\n\tatomic_set(&wait->sdma_busy, 0);\n\tatomic_set(&wait->pio_busy, 0);\n\twait->tx_limit = tx_limit;\n\twait->sleep = sleep;\n\twait->wakeup = wakeup;\n\twait->sdma_drained = sdma_drained;\n\twait->init_priority = init_priority;\n\twait->flags = 0;\n\tfor (i = 0; i < IOWAIT_SES; i++) {\n\t\twait->wait[i].iow = wait;\n\t\tINIT_LIST_HEAD(&wait->wait[i].tx_head);\n\t\tif (i == IOWAIT_IB_SE)\n\t\t\tINIT_WORK(&wait->wait[i].iowork, func);\n\t\telse\n\t\t\tINIT_WORK(&wait->wait[i].iowork, tidfunc);\n\t}\n}\n\n \nvoid iowait_cancel_work(struct iowait *w)\n{\n\tcancel_work_sync(&iowait_get_ib_work(w)->iowork);\n\t \n\tif (iowait_get_tid_work(w)->iowork.func)\n\t\tcancel_work_sync(&iowait_get_tid_work(w)->iowork);\n}\n\n \nint iowait_set_work_flag(struct iowait_work *w)\n{\n\tif (w == &w->iow->wait[IOWAIT_IB_SE]) {\n\t\tiowait_set_flag(w->iow, IOWAIT_PENDING_IB);\n\t\treturn IOWAIT_IB_SE;\n\t}\n\tiowait_set_flag(w->iow, IOWAIT_PENDING_TID);\n\treturn IOWAIT_TID_SE;\n}\n\n \nuint iowait_priority_update_top(struct iowait *w,\n\t\t\t\tstruct iowait *top,\n\t\t\t\tuint idx, uint top_idx)\n{\n\tu8 cnt, tcnt;\n\n\t \n\tcnt = (w->priority << IOWAIT_PRIORITY_STARVE_SHIFT) + w->starved_cnt;\n\ttcnt = (top->priority << IOWAIT_PRIORITY_STARVE_SHIFT) +\n\t\ttop->starved_cnt;\n\tif (cnt > tcnt)\n\t\treturn idx;\n\telse\n\t\treturn top_idx;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}