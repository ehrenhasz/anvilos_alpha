{
  "module_name": "verbs.h",
  "hash_id": "de54a763d8293b5446e8a6f394e1956c594a96314cc600e9705bd08a6e84c0ac",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hfi1/verbs.h",
  "human_readable_source": " \n \n\n#ifndef HFI1_VERBS_H\n#define HFI1_VERBS_H\n\n#include <linux/types.h>\n#include <linux/seqlock.h>\n#include <linux/kernel.h>\n#include <linux/interrupt.h>\n#include <linux/kref.h>\n#include <linux/workqueue.h>\n#include <linux/kthread.h>\n#include <linux/completion.h>\n#include <linux/slab.h>\n#include <rdma/ib_pack.h>\n#include <rdma/ib_user_verbs.h>\n#include <rdma/ib_mad.h>\n#include <rdma/ib_hdrs.h>\n#include <rdma/rdma_vt.h>\n#include <rdma/rdmavt_qp.h>\n#include <rdma/rdmavt_cq.h>\n\nstruct hfi1_ctxtdata;\nstruct hfi1_pportdata;\nstruct hfi1_devdata;\nstruct hfi1_packet;\n\n#include \"iowait.h\"\n#include \"tid_rdma.h\"\n#include \"opfn.h\"\n\n#define HFI1_MAX_RDMA_ATOMIC     16\n\n \n#define HFI1_UVERBS_ABI_VERSION       2\n\n \n#define IB_PMA_SAMPLE_STATUS_DONE       0x00\n#define IB_PMA_SAMPLE_STATUS_STARTED    0x01\n#define IB_PMA_SAMPLE_STATUS_RUNNING    0x02\n\n \n#define IB_PMA_PORT_XMIT_DATA   cpu_to_be16(0x0001)\n#define IB_PMA_PORT_RCV_DATA    cpu_to_be16(0x0002)\n#define IB_PMA_PORT_XMIT_PKTS   cpu_to_be16(0x0003)\n#define IB_PMA_PORT_RCV_PKTS    cpu_to_be16(0x0004)\n#define IB_PMA_PORT_XMIT_WAIT   cpu_to_be16(0x0005)\n\n#define HFI1_VENDOR_IPG\t\tcpu_to_be16(0xFFA0)\n\n#define IB_DEFAULT_GID_PREFIX\tcpu_to_be64(0xfe80000000000000ULL)\n#define OPA_BTH_MIG_REQ\t\tBIT(31)\n\n#define RC_OP(x) IB_OPCODE_RC_##x\n#define UC_OP(x) IB_OPCODE_UC_##x\n\n \nenum {\n\tHFI1_HAS_GRH = (1 << 0),\n};\n\n#define LRH_16B_BYTES (sizeof_field(struct hfi1_16b_header, lrh))\n#define LRH_16B_DWORDS (LRH_16B_BYTES / sizeof(u32))\n#define LRH_9B_BYTES (sizeof_field(struct ib_header, lrh))\n#define LRH_9B_DWORDS (LRH_9B_BYTES / sizeof(u32))\n\n \nstruct opa_16b_mgmt {\n\t__be32 dest_qpn;\n\t__be32 src_qpn;\n};\n\nstruct hfi1_16b_header {\n\tu32 lrh[4];\n\tunion {\n\t\tstruct {\n\t\t\tstruct ib_grh grh;\n\t\t\tstruct ib_other_headers oth;\n\t\t} l;\n\t\tstruct ib_other_headers oth;\n\t\tstruct opa_16b_mgmt mgmt;\n\t} u;\n} __packed;\n\nstruct hfi1_opa_header {\n\tunion {\n\t\tstruct ib_header ibh;  \n\t\tstruct hfi1_16b_header opah;  \n\t};\n\tu8 hdr_type;  \n} __packed;\n\nstruct hfi1_ahg_info {\n\tu32 ahgdesc[2];\n\tu16 tx_flags;\n\tu8 ahgcount;\n\tu8 ahgidx;\n};\n\nstruct hfi1_sdma_header {\n\t__le64 pbc;\n\tstruct hfi1_opa_header hdr;\n} __packed;\n\n \nstruct hfi1_qp_priv {\n\tstruct hfi1_ahg_info *s_ahg;               \n\tstruct sdma_engine *s_sde;                 \n\tstruct send_context *s_sendcontext;        \n\tstruct hfi1_ctxtdata *rcd;                 \n\tstruct page **pages;                       \n\tu32 tid_enqueue;                           \n\tu8 s_sc;\t\t                   \n\tstruct iowait s_iowait;\n\tstruct timer_list s_tid_timer;             \n\tstruct timer_list s_tid_retry_timer;       \n\tstruct list_head tid_wait;                 \n\tstruct hfi1_opfn_data opfn;\n\tstruct tid_flow_state flow_state;\n\tstruct tid_rdma_qp_params tid_rdma;\n\tstruct rvt_qp *owner;\n\tu16 s_running_pkt_size;\n\tu8 hdr_type;  \n\tstruct rvt_sge_state tid_ss;        \n\tatomic_t n_requests;                \n\t\t\t\t\t    \n\tatomic_t n_tid_requests;             \n\tunsigned long tid_timer_timeout_jiffies;\n\tunsigned long tid_retry_timeout_jiffies;\n\n\t \n\tu8 s_state;\n\tu8 s_retry;\n\tu8 rnr_nak_state;        \n\tu8 s_nak_state;\n\tu32 s_nak_psn;\n\tu32 s_flags;\n\tu32 s_tid_cur;\n\tu32 s_tid_head;\n\tu32 s_tid_tail;\n\tu32 r_tid_head;      \n\tu32 r_tid_tail;      \n\tu32 r_tid_ack;       \n\tu32 r_tid_alloc;     \n\tu32 pending_tid_w_segs;  \n\tu32 pending_tid_w_resp;  \n\tu32 alloc_w_segs;        \n\t\t\t        \n\n\t \n\tu32 tid_r_reqs;          \n\tu32 tid_r_comp;          \n\tu32 pending_tid_r_segs;  \n\tu16 pkts_ps;             \n\tu8 timeout_shift;        \n\n\tu32 r_next_psn_kdeth;\n\tu32 r_next_psn_kdeth_save;\n\tu32 s_resync_psn;\n\tu8 sync_pt;            \n\tu8 resync;\n};\n\n#define HFI1_QP_WQE_INVALID   ((u32)-1)\n\nstruct hfi1_swqe_priv {\n\tstruct tid_rdma_request tid_req;\n\tstruct rvt_sge_state ss;   \n};\n\nstruct hfi1_ack_priv {\n\tstruct rvt_sge_state ss;                \n\tstruct tid_rdma_request tid_req;\n};\n\n \nstruct iowait_work;\nstruct hfi1_pkt_state {\n\tstruct hfi1_ibdev *dev;\n\tstruct hfi1_ibport *ibp;\n\tstruct hfi1_pportdata *ppd;\n\tstruct verbs_txreq *s_txreq;\n\tstruct iowait_work *wait;\n\tunsigned long flags;\n\tunsigned long timeout;\n\tunsigned long timeout_int;\n\tint cpu;\n\tu8 opcode;\n\tbool in_thread;\n\tbool pkts_sent;\n};\n\n#define HFI1_PSN_CREDIT  16\n\nstruct hfi1_opcode_stats {\n\tu64 n_packets;           \n\tu64 n_bytes;             \n};\n\nstruct hfi1_opcode_stats_perctx {\n\tstruct hfi1_opcode_stats stats[256];\n};\n\nstatic inline void inc_opstats(\n\tu32 tlen,\n\tstruct hfi1_opcode_stats *stats)\n{\n#ifdef CONFIG_DEBUG_FS\n\tstats->n_bytes += tlen;\n\tstats->n_packets++;\n#endif\n}\n\nstruct hfi1_ibport {\n\tstruct rvt_qp __rcu *qp[2];\n\tstruct rvt_ibport rvp;\n\n\t \n\tu8 sl_to_sc[32];\n\tu8 sc_to_sl[32];\n};\n\nstruct hfi1_ibdev {\n\tstruct rvt_dev_info rdi;  \n\n\t \n\t \n\tseqlock_t txwait_lock ____cacheline_aligned_in_smp;\n\tstruct list_head txwait;         \n\tstruct list_head memwait;        \n\tstruct kmem_cache *verbs_txreq_cache;\n\tu64 n_txwait;\n\tu64 n_kmem_wait;\n\tu64 n_tidwait;\n\n\t \n\tseqlock_t iowait_lock ____cacheline_aligned_in_smp;\n\tu64 n_piowait;\n\tu64 n_piodrain;\n\tstruct timer_list mem_timer;\n\n#ifdef CONFIG_DEBUG_FS\n\t \n\tstruct dentry *hfi1_ibdev_dbg;\n\t \n\tstruct dentry *hfi1_ibdev_link;\n#ifdef CONFIG_FAULT_INJECTION\n\tstruct fault *fault;\n#endif\n#endif\n};\n\nstatic inline struct hfi1_ibdev *to_idev(struct ib_device *ibdev)\n{\n\tstruct rvt_dev_info *rdi;\n\n\trdi = container_of(ibdev, struct rvt_dev_info, ibdev);\n\treturn container_of(rdi, struct hfi1_ibdev, rdi);\n}\n\nstatic inline struct rvt_qp *iowait_to_qp(struct iowait *s_iowait)\n{\n\tstruct hfi1_qp_priv *priv;\n\n\tpriv = container_of(s_iowait, struct hfi1_qp_priv, s_iowait);\n\treturn priv->owner;\n}\n\n \nvoid hfi1_bad_pkey(struct hfi1_ibport *ibp, u32 key, u32 sl,\n\t\t   u32 qp1, u32 qp2, u32 lid1, u32 lid2);\nvoid hfi1_cap_mask_chg(struct rvt_dev_info *rdi, u32 port_num);\nvoid hfi1_sys_guid_chg(struct hfi1_ibport *ibp);\nvoid hfi1_node_desc_chg(struct hfi1_ibport *ibp);\nint hfi1_process_mad(struct ib_device *ibdev, int mad_flags, u32 port,\n\t\t     const struct ib_wc *in_wc, const struct ib_grh *in_grh,\n\t\t     const struct ib_mad *in_mad, struct ib_mad *out_mad,\n\t\t     size_t *out_mad_size, u16 *out_mad_pkey_index);\n\n \n#define PSN_MASK 0x7FFFFFFF\n#define PSN_SHIFT 1\n#define PSN_MODIFY_MASK 0xFFFFFF\n\n \nstatic inline int cmp_psn(u32 a, u32 b)\n{\n\treturn (((int)a) - ((int)b)) << PSN_SHIFT;\n}\n\n \nstatic inline u32 mask_psn(u32 a)\n{\n\treturn a & PSN_MASK;\n}\n\n \nstatic inline u32 delta_psn(u32 a, u32 b)\n{\n\treturn (((int)a - (int)b) << PSN_SHIFT) >> PSN_SHIFT;\n}\n\nstatic inline struct tid_rdma_request *wqe_to_tid_req(struct rvt_swqe *wqe)\n{\n\treturn &((struct hfi1_swqe_priv *)wqe->priv)->tid_req;\n}\n\nstatic inline struct tid_rdma_request *ack_to_tid_req(struct rvt_ack_entry *e)\n{\n\treturn &((struct hfi1_ack_priv *)e->priv)->tid_req;\n}\n\n \nstatic inline u32 __full_flow_psn(struct flow_state *state, u32 psn)\n{\n\treturn mask_psn((state->generation << HFI1_KDETH_BTH_SEQ_SHIFT) |\n\t\t\t(psn & HFI1_KDETH_BTH_SEQ_MASK));\n}\n\nstatic inline u32 full_flow_psn(struct tid_rdma_flow *flow, u32 psn)\n{\n\treturn __full_flow_psn(&flow->flow_state, psn);\n}\n\nstruct verbs_txreq;\nvoid hfi1_put_txreq(struct verbs_txreq *tx);\n\nint hfi1_verbs_send(struct rvt_qp *qp, struct hfi1_pkt_state *ps);\n\nvoid hfi1_cnp_rcv(struct hfi1_packet *packet);\n\nvoid hfi1_uc_rcv(struct hfi1_packet *packet);\n\nvoid hfi1_rc_rcv(struct hfi1_packet *packet);\n\nvoid hfi1_rc_hdrerr(\n\tstruct hfi1_ctxtdata *rcd,\n\tstruct hfi1_packet *packet,\n\tstruct rvt_qp *qp);\n\nu8 ah_to_sc(struct ib_device *ibdev, struct rdma_ah_attr *ah_attr);\n\nvoid hfi1_rc_verbs_aborted(struct rvt_qp *qp, struct hfi1_opa_header *opah);\nvoid hfi1_rc_send_complete(struct rvt_qp *qp, struct hfi1_opa_header *opah);\n\nvoid hfi1_ud_rcv(struct hfi1_packet *packet);\n\nint hfi1_lookup_pkey_idx(struct hfi1_ibport *ibp, u16 pkey);\n\nvoid hfi1_migrate_qp(struct rvt_qp *qp);\n\nint hfi1_check_modify_qp(struct rvt_qp *qp, struct ib_qp_attr *attr,\n\t\t\t int attr_mask, struct ib_udata *udata);\n\nvoid hfi1_modify_qp(struct rvt_qp *qp, struct ib_qp_attr *attr,\n\t\t    int attr_mask, struct ib_udata *udata);\nvoid hfi1_restart_rc(struct rvt_qp *qp, u32 psn, int wait);\nint hfi1_setup_wqe(struct rvt_qp *qp, struct rvt_swqe *wqe,\n\t\t   bool *call_send);\n\nint hfi1_ruc_check_hdr(struct hfi1_ibport *ibp, struct hfi1_packet *packet);\n\nu32 hfi1_make_grh(struct hfi1_ibport *ibp, struct ib_grh *hdr,\n\t\t  const struct ib_global_route *grh, u32 hwords, u32 nwords);\n\nvoid hfi1_make_ruc_header(struct rvt_qp *qp, struct ib_other_headers *ohdr,\n\t\t\t  u32 bth0, u32 bth1, u32 bth2, int middle,\n\t\t\t  struct hfi1_pkt_state *ps);\n\nbool hfi1_schedule_send_yield(struct rvt_qp *qp, struct hfi1_pkt_state *ps,\n\t\t\t      bool tid);\n\nvoid _hfi1_do_send(struct work_struct *work);\n\nvoid hfi1_do_send_from_rvt(struct rvt_qp *qp);\n\nvoid hfi1_do_send(struct rvt_qp *qp, bool in_thread);\n\nvoid hfi1_send_rc_ack(struct hfi1_packet *packet, bool is_fecn);\n\nint hfi1_make_rc_req(struct rvt_qp *qp, struct hfi1_pkt_state *ps);\n\nint hfi1_make_uc_req(struct rvt_qp *qp, struct hfi1_pkt_state *ps);\n\nint hfi1_make_ud_req(struct rvt_qp *qp, struct hfi1_pkt_state *ps);\n\nint hfi1_register_ib_device(struct hfi1_devdata *);\n\nvoid hfi1_unregister_ib_device(struct hfi1_devdata *);\n\nvoid hfi1_kdeth_eager_rcv(struct hfi1_packet *packet);\n\nvoid hfi1_kdeth_expected_rcv(struct hfi1_packet *packet);\n\nvoid hfi1_ib_rcv(struct hfi1_packet *packet);\n\nvoid hfi1_16B_rcv(struct hfi1_packet *packet);\n\nunsigned hfi1_get_npkeys(struct hfi1_devdata *);\n\nint hfi1_verbs_send_dma(struct rvt_qp *qp, struct hfi1_pkt_state *ps,\n\t\t\tu64 pbc);\n\nint hfi1_verbs_send_pio(struct rvt_qp *qp, struct hfi1_pkt_state *ps,\n\t\t\tu64 pbc);\n\nstatic inline bool opa_bth_is_migration(struct ib_other_headers *ohdr)\n{\n\treturn ohdr->bth[1] & cpu_to_be32(OPA_BTH_MIG_REQ);\n}\n\nvoid hfi1_wait_kmem(struct rvt_qp *qp);\n\nstatic inline void hfi1_trdma_send_complete(struct rvt_qp *qp,\n\t\t\t\t\t    struct rvt_swqe *wqe,\n\t\t\t\t\t    enum ib_wc_status status)\n{\n\ttrdma_clean_swqe(qp, wqe);\n\trvt_send_complete(qp, wqe, status);\n}\n\nextern const enum ib_wc_opcode ib_hfi1_wc_opcode[];\n\nextern const u8 hdr_len_by_opcode[];\n\nextern const int ib_rvt_state_ops[];\n\nextern __be64 ib_hfi1_sys_image_guid;     \n\nextern unsigned int hfi1_max_cqes;\n\nextern unsigned int hfi1_max_cqs;\n\nextern unsigned int hfi1_max_qp_wrs;\n\nextern unsigned int hfi1_max_qps;\n\nextern unsigned int hfi1_max_sges;\n\nextern unsigned int hfi1_max_mcast_grps;\n\nextern unsigned int hfi1_max_mcast_qp_attached;\n\nextern unsigned int hfi1_max_srqs;\n\nextern unsigned int hfi1_max_srq_sges;\n\nextern unsigned int hfi1_max_srq_wrs;\n\nextern unsigned short piothreshold;\n\nextern const u32 ib_hfi1_rnr_table[];\n\n#endif                           \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}