{
  "module_name": "verbs_txreq.c",
  "hash_id": "ae0da1b1690f710ee104a688fcdcbfb7d9d6952a2df00ff63c730a71e6215d46",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hfi1/verbs_txreq.c",
  "human_readable_source": "\n \n\n#include \"hfi.h\"\n#include \"verbs_txreq.h\"\n#include \"qp.h\"\n#include \"trace.h\"\n\n#define TXREQ_LEN 24\n\nvoid hfi1_put_txreq(struct verbs_txreq *tx)\n{\n\tstruct hfi1_ibdev *dev;\n\tstruct rvt_qp *qp;\n\tunsigned long flags;\n\tunsigned int seq;\n\tstruct hfi1_qp_priv *priv;\n\n\tqp = tx->qp;\n\tdev = to_idev(qp->ibqp.device);\n\n\tif (tx->mr)\n\t\trvt_put_mr(tx->mr);\n\n\tsdma_txclean(dd_from_dev(dev), &tx->txreq);\n\n\t \n\tkmem_cache_free(dev->verbs_txreq_cache, tx);\n\n\tdo {\n\t\tseq = read_seqbegin(&dev->txwait_lock);\n\t\tif (!list_empty(&dev->txwait)) {\n\t\t\tstruct iowait *wait;\n\n\t\t\twrite_seqlock_irqsave(&dev->txwait_lock, flags);\n\t\t\twait = list_first_entry(&dev->txwait, struct iowait,\n\t\t\t\t\t\tlist);\n\t\t\tqp = iowait_to_qp(wait);\n\t\t\tpriv = qp->priv;\n\t\t\tlist_del_init(&priv->s_iowait.list);\n\t\t\t \n\t\t\twrite_sequnlock_irqrestore(&dev->txwait_lock, flags);\n\t\t\thfi1_qp_wakeup(qp, RVT_S_WAIT_TX);\n\t\t\tbreak;\n\t\t}\n\t} while (read_seqretry(&dev->txwait_lock, seq));\n}\n\nstruct verbs_txreq *__get_txreq(struct hfi1_ibdev *dev,\n\t\t\t\tstruct rvt_qp *qp)\n\t__must_hold(&qp->s_lock)\n{\n\tstruct verbs_txreq *tx = NULL;\n\n\twrite_seqlock(&dev->txwait_lock);\n\tif (ib_rvt_state_ops[qp->state] & RVT_PROCESS_RECV_OK) {\n\t\tstruct hfi1_qp_priv *priv;\n\n\t\ttx = kmem_cache_alloc(dev->verbs_txreq_cache, VERBS_TXREQ_GFP);\n\t\tif (tx)\n\t\t\tgoto out;\n\t\tpriv = qp->priv;\n\t\tif (list_empty(&priv->s_iowait.list)) {\n\t\t\tdev->n_txwait++;\n\t\t\tqp->s_flags |= RVT_S_WAIT_TX;\n\t\t\tlist_add_tail(&priv->s_iowait.list, &dev->txwait);\n\t\t\tpriv->s_iowait.lock = &dev->txwait_lock;\n\t\t\ttrace_hfi1_qpsleep(qp, RVT_S_WAIT_TX);\n\t\t\trvt_get_qp(qp);\n\t\t}\n\t\tqp->s_flags &= ~RVT_S_BUSY;\n\t}\nout:\n\twrite_sequnlock(&dev->txwait_lock);\n\treturn tx;\n}\n\nint verbs_txreq_init(struct hfi1_ibdev *dev)\n{\n\tchar buf[TXREQ_LEN];\n\tstruct hfi1_devdata *dd = dd_from_dev(dev);\n\n\tsnprintf(buf, sizeof(buf), \"hfi1_%u_vtxreq_cache\", dd->unit);\n\tdev->verbs_txreq_cache = kmem_cache_create(buf,\n\t\t\t\t\t\t   sizeof(struct verbs_txreq),\n\t\t\t\t\t\t   0, SLAB_HWCACHE_ALIGN,\n\t\t\t\t\t\t   NULL);\n\tif (!dev->verbs_txreq_cache)\n\t\treturn -ENOMEM;\n\treturn 0;\n}\n\nvoid verbs_txreq_exit(struct hfi1_ibdev *dev)\n{\n\tkmem_cache_destroy(dev->verbs_txreq_cache);\n\tdev->verbs_txreq_cache = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}