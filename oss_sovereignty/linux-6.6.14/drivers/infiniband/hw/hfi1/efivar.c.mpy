{
  "module_name": "efivar.c",
  "hash_id": "6f3517f249b9311a731bf67b550d6b4a3884cda08525a2f9172d777de552c2ba",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hfi1/efivar.c",
  "human_readable_source": "\n \n\n#include <linux/string.h>\n#include <linux/string_helpers.h>\n\n#include \"efivar.h\"\n\n \n#define HFI1_EFIVAR_GUID EFI_GUID(0xc50a953e, 0xa8b2, 0x42a6, \\\n\t\t0xbf, 0x89, 0xd3, 0x33, 0xa6, 0xe9, 0xe6, 0xd4)\n \n#define EFI_DATA_SIZE 4096\n\n \nstatic int read_efi_var(const char *name, unsigned long *size,\n\t\t\tvoid **return_data)\n{\n\tefi_status_t status;\n\tefi_char16_t *uni_name;\n\tefi_guid_t guid;\n\tunsigned long temp_size;\n\tvoid *temp_buffer;\n\tvoid *data;\n\tint i;\n\tint ret;\n\n\t \n\t*size = 0;\n\t*return_data = NULL;\n\n\tif (!efi_rt_services_supported(EFI_RT_SUPPORTED_GET_VARIABLE))\n\t\treturn -EOPNOTSUPP;\n\n\tuni_name = kcalloc(strlen(name) + 1, sizeof(efi_char16_t), GFP_KERNEL);\n\ttemp_buffer = kzalloc(EFI_DATA_SIZE, GFP_KERNEL);\n\n\tif (!uni_name || !temp_buffer) {\n\t\tret = -ENOMEM;\n\t\tgoto fail;\n\t}\n\n\t \n\ttemp_size = EFI_DATA_SIZE;\n\n\t \n\tfor (i = 0; name[i]; i++)\n\t\tuni_name[i] = name[i];\n\n\t \n\tguid = HFI1_EFIVAR_GUID;\n\n\t \n\tstatus = efi.get_variable(\n\t\t\tuni_name,\n\t\t\t&guid,\n\t\t\tNULL,\n\t\t\t&temp_size,\n\t\t\ttemp_buffer);\n\n\t \n\tret = status == EFI_SUCCESS   ? 0 :\n\t      status == EFI_NOT_FOUND ? -ENOENT :\n\t\t\t\t\t-EINVAL;\n\tif (ret)\n\t\tgoto fail;\n\n\t \n\tdata = kmemdup(temp_buffer, temp_size, GFP_KERNEL);\n\tif (!data) {\n\t\tret = -ENOMEM;\n\t\tgoto fail;\n\t}\n\n\t*size = temp_size;\n\t*return_data = data;\n\nfail:\n\tkfree(uni_name);\n\tkfree(temp_buffer);\n\n\treturn ret;\n}\n\n \nint read_hfi1_efi_var(struct hfi1_devdata *dd, const char *kind,\n\t\t      unsigned long *size, void **return_data)\n{\n\tchar prefix_name[64];\n\tchar name[128];\n\tint result;\n\n\t \n\tsnprintf(prefix_name, sizeof(prefix_name), \"%04x:%02x:%02x.%x\",\n\t\t pci_domain_nr(dd->pcidev->bus),\n\t\t dd->pcidev->bus->number,\n\t\t PCI_SLOT(dd->pcidev->devfn),\n\t\t PCI_FUNC(dd->pcidev->devfn));\n\tsnprintf(name, sizeof(name), \"%s-%s\", prefix_name, kind);\n\tresult = read_efi_var(name, size, return_data);\n\n\t \n\tif (result) {\n\t\tstring_upper(prefix_name, prefix_name);\n\t\tsnprintf(name, sizeof(name), \"%s-%s\", prefix_name, kind);\n\t\tresult = read_efi_var(name, size, return_data);\n\t}\n\n\treturn result;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}