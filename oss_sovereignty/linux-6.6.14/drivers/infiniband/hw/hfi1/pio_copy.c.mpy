{
  "module_name": "pio_copy.c",
  "hash_id": "56b312dbf15967c23651da98baeff92dcea69c425ec27e41e3c59d377e3ae3d5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hfi1/pio_copy.c",
  "human_readable_source": "\n \n\n#include \"hfi.h\"\n\n \n#define SOP_DISTANCE (TXE_PIO_SIZE / 2)\n#define PIO_BLOCK_MASK (PIO_BLOCK_SIZE - 1)\n \n#define PIO_BLOCK_QWS (PIO_BLOCK_SIZE / sizeof(u64))\n\n \nvoid pio_copy(struct hfi1_devdata *dd, struct pio_buf *pbuf, u64 pbc,\n\t      const void *from, size_t count)\n{\n\tvoid __iomem *dest = pbuf->start + SOP_DISTANCE;\n\tvoid __iomem *send = dest + PIO_BLOCK_SIZE;\n\tvoid __iomem *dend;\t\t\t \n\n\t \n\twriteq(pbc, dest);\n\tdest += sizeof(u64);\n\n\t \n\tdend = dest + ((count >> 1) * sizeof(u64));\n\n\tif (dend < send) {\n\t\t \n\n\t\twhile (dest < dend) {\n\t\t\twriteq(*(u64 *)from, dest);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\t\t \n\t} else {\n\t\t \n\n\t\t \n\t\twhile (dest < send) {\n\t\t\twriteq(*(u64 *)from, dest);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\t\t \n\t\tdest -= SOP_DISTANCE;\n\t\tdend -= SOP_DISTANCE;\n\n\t\t \n\t\tif (pbuf->end <= dend) {\n\t\t\twhile (dest < pbuf->end) {\n\t\t\t\twriteq(*(u64 *)from, dest);\n\t\t\t\tfrom += sizeof(u64);\n\t\t\t\tdest += sizeof(u64);\n\t\t\t}\n\n\t\t\tdest -= pbuf->sc->size;\n\t\t\tdend -= pbuf->sc->size;\n\t\t}\n\n\t\t \n\t\twhile (dest < dend) {\n\t\t\twriteq(*(u64 *)from, dest);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\t}\n\t \n\n\t \n\tif (count & 1) {\n\t\tunion mix val;\n\n\t\tval.val64 = 0;\n\t\tval.val32[0] = *(u32 *)from;\n\t\twriteq(val.val64, dest);\n\t\tdest += sizeof(u64);\n\t}\n\t \n\twhile (((unsigned long)dest & PIO_BLOCK_MASK) != 0) {\n\t\twriteq(0, dest);\n\t\tdest += sizeof(u64);\n\t}\n\n\t \n\tthis_cpu_dec(*pbuf->sc->buffers_allocated);\n\tpreempt_enable();\n}\n\n \n\n \n#define zshift(x) (8 * (8 - (x)))\n\n \n#define mshift(x) (8 * (x))\n\n \nstatic inline void jcopy(u8 *dest, const u8 *src, u32 n)\n{\n\tswitch (n) {\n\tcase 7:\n\t\t*dest++ = *src++;\n\t\tfallthrough;\n\tcase 6:\n\t\t*dest++ = *src++;\n\t\tfallthrough;\n\tcase 5:\n\t\t*dest++ = *src++;\n\t\tfallthrough;\n\tcase 4:\n\t\t*dest++ = *src++;\n\t\tfallthrough;\n\tcase 3:\n\t\t*dest++ = *src++;\n\t\tfallthrough;\n\tcase 2:\n\t\t*dest++ = *src++;\n\t\tfallthrough;\n\tcase 1:\n\t\t*dest++ = *src++;\n\t}\n}\n\n \nstatic inline void read_low_bytes(struct pio_buf *pbuf, const void *from,\n\t\t\t\t  unsigned int nbytes)\n{\n\tpbuf->carry.val64 = 0;\n\tjcopy(&pbuf->carry.val8[0], from, nbytes);\n\tpbuf->carry_bytes = nbytes;\n}\n\n \nstatic inline void read_extra_bytes(struct pio_buf *pbuf,\n\t\t\t\t    const void *from, unsigned int nbytes)\n{\n\tjcopy(&pbuf->carry.val8[pbuf->carry_bytes], from, nbytes);\n\tpbuf->carry_bytes += nbytes;\n}\n\n \nstatic inline void merge_write8(\n\tstruct pio_buf *pbuf,\n\tvoid __iomem *dest,\n\tconst void *src)\n{\n\tu64 new, temp;\n\n\tnew = *(u64 *)src;\n\ttemp = pbuf->carry.val64 | (new << mshift(pbuf->carry_bytes));\n\twriteq(temp, dest);\n\tpbuf->carry.val64 = new >> zshift(pbuf->carry_bytes);\n}\n\n \nstatic inline void carry8_write8(union mix carry, void __iomem *dest)\n{\n\twriteq(carry.val64, dest);\n}\n\n \nstatic inline int carry_write8(struct pio_buf *pbuf, void __iomem *dest)\n{\n\tif (pbuf->carry_bytes) {\n\t\t \n\t\twriteq(pbuf->carry.val64, dest);\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\n \nvoid seg_pio_copy_start(struct pio_buf *pbuf, u64 pbc,\n\t\t\tconst void *from, size_t nbytes)\n{\n\tvoid __iomem *dest = pbuf->start + SOP_DISTANCE;\n\tvoid __iomem *send = dest + PIO_BLOCK_SIZE;\n\tvoid __iomem *dend;\t\t\t \n\n\twriteq(pbc, dest);\n\tdest += sizeof(u64);\n\n\t \n\tdend = dest + ((nbytes >> 3) * sizeof(u64));\n\n\tif (dend < send) {\n\t\t \n\n\t\twhile (dest < dend) {\n\t\t\twriteq(*(u64 *)from, dest);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\t\t \n\t} else {\n\t\t \n\n\t\t \n\t\twhile (dest < send) {\n\t\t\twriteq(*(u64 *)from, dest);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\t\t \n\t\tdest -= SOP_DISTANCE;\n\t\tdend -= SOP_DISTANCE;\n\n\t\t \n\t\tif (pbuf->end <= dend) {\n\t\t\twhile (dest < pbuf->end) {\n\t\t\t\twriteq(*(u64 *)from, dest);\n\t\t\t\tfrom += sizeof(u64);\n\t\t\t\tdest += sizeof(u64);\n\t\t\t}\n\n\t\t\tdest -= pbuf->sc->size;\n\t\t\tdend -= pbuf->sc->size;\n\t\t}\n\n\t\t \n\t\twhile (dest < dend) {\n\t\t\twriteq(*(u64 *)from, dest);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\t}\n\t \n\n\t \n\n\t \n\tread_low_bytes(pbuf, from, nbytes & 0x7);\n\n\tpbuf->qw_written = 1   + (nbytes >> 3);\n}\n\n \nstatic void mid_copy_mix(struct pio_buf *pbuf, const void *from, size_t nbytes)\n{\n\tvoid __iomem *dest = pbuf->start + (pbuf->qw_written * sizeof(u64));\n\tvoid __iomem *dend;\t\t\t \n\tunsigned long qw_to_write = nbytes >> 3;\n\tunsigned long bytes_left = nbytes & 0x7;\n\n\t \n\tdend = dest + (qw_to_write * sizeof(u64));\n\n\tif (pbuf->qw_written < PIO_BLOCK_QWS) {\n\t\t \n\t\tvoid __iomem *send;\t\t \n\t\tvoid __iomem *xend;\n\n\t\t \n\t\tsend = pbuf->start + PIO_BLOCK_SIZE;\n\t\txend = min(send, dend);\n\n\t\t \n\t\tdest += SOP_DISTANCE;\n\t\txend += SOP_DISTANCE;\n\n\t\t \n\t\twhile (dest < xend) {\n\t\t\tmerge_write8(pbuf, dest, from);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\n\t\t \n\t\tdest -= SOP_DISTANCE;\n\t}\n\t \n\n\t \n\tif (pbuf->end <= dend) {\n\t\twhile (dest < pbuf->end) {\n\t\t\tmerge_write8(pbuf, dest, from);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\n\t\tdest -= pbuf->sc->size;\n\t\tdend -= pbuf->sc->size;\n\t}\n\n\t \n\twhile (dest < dend) {\n\t\tmerge_write8(pbuf, dest, from);\n\t\tfrom += sizeof(u64);\n\t\tdest += sizeof(u64);\n\t}\n\n\tpbuf->qw_written += qw_to_write;\n\n\t \n\tif (pbuf->carry_bytes + bytes_left >= 8) {\n\t\tunsigned long nread;\n\n\t\t \n\t\tnread = 8 - pbuf->carry_bytes;\n\t\tread_extra_bytes(pbuf, from, nread);\n\n\t\t \n\t\t \n\t\tif (dest >= pbuf->end)\n\t\t\tdest -= pbuf->sc->size;\n\t\t \n\t\telse if (pbuf->qw_written < PIO_BLOCK_QWS)\n\t\t\tdest += SOP_DISTANCE;\n\n\t\t \n\t\tcarry8_write8(pbuf->carry, dest);\n\t\tpbuf->qw_written++;\n\n\t\t \n\t\tbytes_left -= nread;\n\t\tfrom += nread;  \n\t\tread_low_bytes(pbuf, from, bytes_left);\n\t} else {\n\t\t \n\t\tread_extra_bytes(pbuf, from, bytes_left);\n\t}\n}\n\n \nstatic void mid_copy_straight(struct pio_buf *pbuf,\n\t\t\t      const void *from, size_t nbytes)\n{\n\tvoid __iomem *dest = pbuf->start + (pbuf->qw_written * sizeof(u64));\n\tvoid __iomem *dend;\t\t\t \n\n\t \n\tdend = dest + ((nbytes >> 3) * sizeof(u64));\n\n\tif (pbuf->qw_written < PIO_BLOCK_QWS) {\n\t\t \n\t\tvoid __iomem *send;\t\t \n\t\tvoid __iomem *xend;\n\n\t\t \n\t\tsend = pbuf->start + PIO_BLOCK_SIZE;\n\t\txend = min(send, dend);\n\n\t\t \n\t\tdest += SOP_DISTANCE;\n\t\txend += SOP_DISTANCE;\n\n\t\t \n\t\twhile (dest < xend) {\n\t\t\twriteq(*(u64 *)from, dest);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\n\t\t \n\t\tdest -= SOP_DISTANCE;\n\t}\n\t \n\n\t \n\tif (pbuf->end <= dend) {\n\t\twhile (dest < pbuf->end) {\n\t\t\twriteq(*(u64 *)from, dest);\n\t\t\tfrom += sizeof(u64);\n\t\t\tdest += sizeof(u64);\n\t\t}\n\n\t\tdest -= pbuf->sc->size;\n\t\tdend -= pbuf->sc->size;\n\t}\n\n\t \n\twhile (dest < dend) {\n\t\twriteq(*(u64 *)from, dest);\n\t\tfrom += sizeof(u64);\n\t\tdest += sizeof(u64);\n\t}\n\n\t \n\tread_low_bytes(pbuf, from, nbytes & 0x7);\n\n\tpbuf->qw_written += nbytes >> 3;\n}\n\n \nvoid seg_pio_copy_mid(struct pio_buf *pbuf, const void *from, size_t nbytes)\n{\n\tunsigned long from_align = (unsigned long)from & 0x7;\n\n\tif (pbuf->carry_bytes + nbytes < 8) {\n\t\t \n\t\tread_extra_bytes(pbuf, from, nbytes);\n\t\treturn;\n\t}\n\n\tif (from_align) {\n\t\t \n\t\tunsigned long to_align;\n\n\t\t \n\t\tto_align = 8 - from_align;\n\n\t\t \n\t\tif (pbuf->carry_bytes + to_align < 8) {\n\t\t\t \n\t\t\tread_extra_bytes(pbuf, from, to_align);\n\t\t\tfrom += to_align;\n\t\t\tnbytes -= to_align;\n\t\t} else {\n\t\t\t \n\t\t\tunsigned long to_fill = 8 - pbuf->carry_bytes;\n\t\t\t \n\t\t\tunsigned long extra = to_align - to_fill;\n\t\t\tvoid __iomem *dest;\n\n\t\t\t \n\t\t\tread_extra_bytes(pbuf, from, to_fill);\n\t\t\tfrom += to_fill;\n\t\t\tnbytes -= to_fill;\n\t\t\t \n\t\t\tif (extra > nbytes)\n\t\t\t\textra = nbytes;\n\n\t\t\t \n\t\t\tdest = pbuf->start + (pbuf->qw_written * sizeof(u64));\n\n\t\t\t \n\t\t\t \n\t\t\tif (dest >= pbuf->end)\n\t\t\t\tdest -= pbuf->sc->size;\n\t\t\t \n\t\t\telse if (pbuf->qw_written < PIO_BLOCK_QWS)\n\t\t\t\tdest += SOP_DISTANCE;\n\n\t\t\tcarry8_write8(pbuf->carry, dest);\n\t\t\tpbuf->qw_written++;\n\n\t\t\t \n\t\t\t \n\t\t\tread_low_bytes(pbuf, from, extra);\n\t\t\tfrom += extra;\n\t\t\tnbytes -= extra;\n\t\t\t \n\t\t\tif (nbytes == 0)\n\t\t\t\treturn;\n\t\t}\n\n\t\t \n\t}\n\n\tif (pbuf->carry_bytes)\n\t\tmid_copy_mix(pbuf, from, nbytes);\n\telse\n\t\tmid_copy_straight(pbuf, from, nbytes);\n}\n\n \nvoid seg_pio_copy_end(struct pio_buf *pbuf)\n{\n\tvoid __iomem *dest = pbuf->start + (pbuf->qw_written * sizeof(u64));\n\n\t \n\t \n\tif (dest >= pbuf->end)\n\t\tdest -= pbuf->sc->size;\n\t \n\telse if (pbuf->qw_written < PIO_BLOCK_QWS)\n\t\tdest += SOP_DISTANCE;\n\n\t \n\tif (carry_write8(pbuf, dest)) {\n\t\tdest += sizeof(u64);\n\t\t \n\t}\n\n\t \n\twhile (((unsigned long)dest & PIO_BLOCK_MASK) != 0) {\n\t\twriteq(0, dest);\n\t\tdest += sizeof(u64);\n\t}\n\n\t \n\tthis_cpu_dec(*pbuf->sc->buffers_allocated);\n\tpreempt_enable();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}