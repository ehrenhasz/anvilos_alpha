{
  "module_name": "ipoib_rx.c",
  "hash_id": "40d9a7080b1ccada9934d41dfa7d335de2ce21e7579b075d501183134a0593c7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hfi1/ipoib_rx.c",
  "human_readable_source": "\n \n\n#include \"netdev.h\"\n#include \"ipoib.h\"\n\n#define HFI1_IPOIB_SKB_PAD ((NET_SKB_PAD) + (NET_IP_ALIGN))\n\nstatic void copy_ipoib_buf(struct sk_buff *skb, void *data, int size)\n{\n\tskb_checksum_none_assert(skb);\n\tskb->protocol = *((__be16 *)data);\n\n\tskb_put_data(skb, data, size);\n\tskb->mac_header = HFI1_IPOIB_PSEUDO_LEN;\n\tskb_pull(skb, HFI1_IPOIB_ENCAP_LEN);\n}\n\nstatic struct sk_buff *prepare_frag_skb(struct napi_struct *napi, int size)\n{\n\tstruct sk_buff *skb;\n\tint skb_size = SKB_DATA_ALIGN(size + HFI1_IPOIB_SKB_PAD);\n\tvoid *frag;\n\n\tskb_size += SKB_DATA_ALIGN(sizeof(struct skb_shared_info));\n\tskb_size = SKB_DATA_ALIGN(skb_size);\n\tfrag = napi_alloc_frag(skb_size);\n\n\tif (unlikely(!frag))\n\t\treturn napi_alloc_skb(napi, size);\n\n\tskb = build_skb(frag, skb_size);\n\n\tif (unlikely(!skb)) {\n\t\tskb_free_frag(frag);\n\t\treturn NULL;\n\t}\n\n\tskb_reserve(skb, HFI1_IPOIB_SKB_PAD);\n\treturn skb;\n}\n\nstruct sk_buff *hfi1_ipoib_prepare_skb(struct hfi1_netdev_rxq *rxq,\n\t\t\t\t       int size, void *data)\n{\n\tstruct napi_struct *napi = &rxq->napi;\n\tint skb_size = size + HFI1_IPOIB_ENCAP_LEN;\n\tstruct sk_buff *skb;\n\n\t \n\tif (size <= SKB_WITH_OVERHEAD(PAGE_SIZE))\n\t\tskb = napi_alloc_skb(napi, skb_size);\n\telse\n\t\tskb = prepare_frag_skb(napi, skb_size);\n\n\tif (unlikely(!skb))\n\t\treturn NULL;\n\n\tcopy_ipoib_buf(skb, data, size);\n\n\treturn skb;\n}\n\nint hfi1_ipoib_rxq_init(struct net_device *netdev)\n{\n\tstruct hfi1_ipoib_dev_priv *ipoib_priv = hfi1_ipoib_priv(netdev);\n\tstruct hfi1_devdata *dd = ipoib_priv->dd;\n\tint ret;\n\n\tret = hfi1_netdev_rx_init(dd);\n\tif (ret)\n\t\treturn ret;\n\n\thfi1_init_aip_rsm(dd);\n\n\treturn ret;\n}\n\nvoid hfi1_ipoib_rxq_deinit(struct net_device *netdev)\n{\n\tstruct hfi1_ipoib_dev_priv *ipoib_priv = hfi1_ipoib_priv(netdev);\n\tstruct hfi1_devdata *dd = ipoib_priv->dd;\n\n\thfi1_deinit_aip_rsm(dd);\n\thfi1_netdev_rx_destroy(dd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}