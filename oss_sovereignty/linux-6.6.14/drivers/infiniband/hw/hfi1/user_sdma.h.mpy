{
  "module_name": "user_sdma.h",
  "hash_id": "ebf46cb6641f074e5e95093b19dea85eecc7781cc105ec212e1082ea40ac3c63",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hfi1/user_sdma.h",
  "human_readable_source": " \n \n#ifndef _HFI1_USER_SDMA_H\n#define _HFI1_USER_SDMA_H\n\n#include <linux/device.h>\n#include <linux/wait.h>\n\n#include \"common.h\"\n#include \"iowait.h\"\n#include \"user_exp_rcv.h\"\n#include \"mmu_rb.h\"\n#include \"pinning.h\"\n#include \"sdma.h\"\n\n \n#define MAX_VECTORS_PER_REQ 8\n \n#define MAX_PKTS_PER_QUEUE 16\n\n#define num_pages(x) (1 + ((((x) - 1) & PAGE_MASK) >> PAGE_SHIFT))\n\n#define req_opcode(x) \\\n\t(((x) >> HFI1_SDMA_REQ_OPCODE_SHIFT) & HFI1_SDMA_REQ_OPCODE_MASK)\n#define req_version(x) \\\n\t(((x) >> HFI1_SDMA_REQ_VERSION_SHIFT) & HFI1_SDMA_REQ_OPCODE_MASK)\n#define req_iovcnt(x) \\\n\t(((x) >> HFI1_SDMA_REQ_IOVCNT_SHIFT) & HFI1_SDMA_REQ_IOVCNT_MASK)\n\n \n#define BTH_SEQ_MASK 0x7ffull\n\n#define AHG_KDETH_INTR_SHIFT 12\n#define AHG_KDETH_SH_SHIFT   13\n#define AHG_KDETH_ARRAY_SIZE  9\n\n#define PBC2LRH(x) ((((x) & 0xfff) << 2) - 4)\n#define LRH2PBC(x) ((((x) >> 2) + 1) & 0xfff)\n\n \nstatic inline int ahg_header_set(u32 *arr, int idx, size_t array_size,\n\t\t\t\t u8 dw, u8 bit, u8 width, u16 value)\n{\n\tif ((size_t)idx >= array_size)\n\t\treturn -ERANGE;\n\tarr[idx++] = sdma_build_ahg_descriptor(value, dw, bit, width);\n\treturn idx;\n}\n\n \n#define TXREQ_FLAGS_REQ_ACK   BIT(0)       \n#define TXREQ_FLAGS_REQ_DISABLE_SH BIT(1)  \n\nenum pkt_q_sdma_state {\n\tSDMA_PKT_Q_ACTIVE,\n\tSDMA_PKT_Q_DEFERRED,\n};\n\n#define SDMA_IOWAIT_TIMEOUT 1000  \n\n#define SDMA_DBG(req, fmt, ...)\t\t\t\t     \\\n\thfi1_cdbg(SDMA, \"[%u:%u:%u:%u] \" fmt, (req)->pq->dd->unit, \\\n\t\t (req)->pq->ctxt, (req)->pq->subctxt, (req)->info.comp_idx, \\\n\t\t ##__VA_ARGS__)\n\nstruct hfi1_user_sdma_pkt_q {\n\tu16 ctxt;\n\tu16 subctxt;\n\tu16 n_max_reqs;\n\tatomic_t n_reqs;\n\tu16 reqidx;\n\tstruct hfi1_devdata *dd;\n\tstruct kmem_cache *txreq_cache;\n\tstruct user_sdma_request *reqs;\n\tunsigned long *req_in_use;\n\tstruct iowait busy;\n\tenum pkt_q_sdma_state state;\n\twait_queue_head_t wait;\n\tunsigned long unpinned;\n\tstruct mmu_rb_handler *handler;\n\tatomic_t n_locked;\n};\n\nstruct hfi1_user_sdma_comp_q {\n\tu16 nentries;\n\tstruct hfi1_sdma_comp_entry *comps;\n};\n\nstruct user_sdma_iovec {\n\tstruct list_head list;\n\tstruct iovec iov;\n\t \n\tu64 offset;\n};\n\n \nstruct evict_data {\n\tu32 cleared;\t \n\tu32 target;\t \n};\n\nstruct user_sdma_request {\n\t \n\tstruct hfi1_pkt_header hdr;\n\n\t \n\tstruct hfi1_user_sdma_pkt_q *pq ____cacheline_aligned_in_smp;\n\tstruct hfi1_user_sdma_comp_q *cq;\n\t \n\tstruct sdma_engine *sde;\n\tstruct sdma_req_info info;\n\t \n\tu32 *tids;\n\t \n\tu32 data_len;\n\t \n\tu16 n_tids;\n\t \n\tu8 data_iovs;\n\ts8 ahg_idx;\n\n\t \n\tu16 seqcomp ____cacheline_aligned_in_smp;\n\tu16 seqsubmitted;\n\n\t \n\tstruct list_head txps ____cacheline_aligned_in_smp;\n\tu16 seqnum;\n\t \n\tu32 tidoffset;\n\t \n\tu32 koffset;\n\tu32 sent;\n\t \n\tu16 tididx;\n\t \n\tu8 iov_idx;\n\tu8 has_error;\n\n\tstruct user_sdma_iovec iovs[MAX_VECTORS_PER_REQ];\n} ____cacheline_aligned_in_smp;\n\n \nstruct user_sdma_txreq {\n\t \n\tstruct hfi1_pkt_header hdr;\n\tstruct sdma_txreq txreq;\n\tstruct list_head list;\n\tstruct user_sdma_request *req;\n\tu16 flags;\n\tu16 seqnum;\n};\n\nint hfi1_user_sdma_alloc_queues(struct hfi1_ctxtdata *uctxt,\n\t\t\t\tstruct hfi1_filedata *fd);\nint hfi1_user_sdma_free_queues(struct hfi1_filedata *fd,\n\t\t\t       struct hfi1_ctxtdata *uctxt);\nint hfi1_user_sdma_process_request(struct hfi1_filedata *fd,\n\t\t\t\t   struct iovec *iovec, unsigned long dim,\n\t\t\t\t   unsigned long *count);\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}