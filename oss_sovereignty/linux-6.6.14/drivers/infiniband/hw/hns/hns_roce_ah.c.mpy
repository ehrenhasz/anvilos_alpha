{
  "module_name": "hns_roce_ah.c",
  "hash_id": "2e829a0b1a73539a441cfa4476ce16b120fee021e022c449d2c207e233ce2ab5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/hns/hns_roce_ah.c",
  "human_readable_source": " \n\n#include <linux/pci.h>\n#include <rdma/ib_addr.h>\n#include <rdma/ib_cache.h>\n#include \"hnae3.h\"\n#include \"hns_roce_device.h\"\n#include \"hns_roce_hw_v2.h\"\n\nstatic inline u16 get_ah_udp_sport(const struct rdma_ah_attr *ah_attr)\n{\n\tu32 fl = ah_attr->grh.flow_label;\n\tu16 sport;\n\n\tif (!fl)\n\t\tsport = get_random_u32_inclusive(IB_ROCE_UDP_ENCAP_VALID_PORT_MIN,\n\t\t\t\t\t\t IB_ROCE_UDP_ENCAP_VALID_PORT_MAX);\n\telse\n\t\tsport = rdma_flow_label_to_udp_sport(fl);\n\n\treturn sport;\n}\n\nint hns_roce_create_ah(struct ib_ah *ibah, struct rdma_ah_init_attr *init_attr,\n\t\t       struct ib_udata *udata)\n{\n\tstruct rdma_ah_attr *ah_attr = init_attr->ah_attr;\n\tconst struct ib_global_route *grh = rdma_ah_read_grh(ah_attr);\n\tstruct hns_roce_dev *hr_dev = to_hr_dev(ibah->device);\n\tstruct hns_roce_ah *ah = to_hr_ah(ibah);\n\tint ret = 0;\n\tu32 max_sl;\n\n\tif (hr_dev->pci_dev->revision == PCI_REVISION_ID_HIP08 && udata)\n\t\treturn -EOPNOTSUPP;\n\n\tah->av.port = rdma_ah_get_port_num(ah_attr);\n\tah->av.gid_index = grh->sgid_index;\n\n\tif (rdma_ah_get_static_rate(ah_attr))\n\t\tah->av.stat_rate = IB_RATE_10_GBPS;\n\n\tah->av.hop_limit = grh->hop_limit;\n\tah->av.flowlabel = grh->flow_label;\n\tah->av.udp_sport = get_ah_udp_sport(ah_attr);\n\tah->av.tclass = get_tclass(grh);\n\n\tah->av.sl = rdma_ah_get_sl(ah_attr);\n\tmax_sl = min_t(u32, MAX_SERVICE_LEVEL, hr_dev->caps.sl_num - 1);\n\tif (unlikely(ah->av.sl > max_sl)) {\n\t\tibdev_err_ratelimited(&hr_dev->ib_dev,\n\t\t\t\t      \"failed to set sl, sl (%u) shouldn't be larger than %u.\\n\",\n\t\t\t\t      ah->av.sl, max_sl);\n\t\treturn -EINVAL;\n\t}\n\n\tmemcpy(ah->av.dgid, grh->dgid.raw, HNS_ROCE_GID_SIZE);\n\tmemcpy(ah->av.mac, ah_attr->roce.dmac, ETH_ALEN);\n\n\t \n\tif (hr_dev->pci_dev->revision == PCI_REVISION_ID_HIP08) {\n\t\tret = rdma_read_gid_l2_fields(ah_attr->grh.sgid_attr,\n\t\t\t\t\t      &ah->av.vlan_id, NULL);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tah->av.vlan_en = ah->av.vlan_id < VLAN_N_VID;\n\t}\n\n\treturn ret;\n}\n\nint hns_roce_query_ah(struct ib_ah *ibah, struct rdma_ah_attr *ah_attr)\n{\n\tstruct hns_roce_ah *ah = to_hr_ah(ibah);\n\n\tmemset(ah_attr, 0, sizeof(*ah_attr));\n\n\trdma_ah_set_sl(ah_attr, ah->av.sl);\n\trdma_ah_set_port_num(ah_attr, ah->av.port);\n\trdma_ah_set_static_rate(ah_attr, ah->av.stat_rate);\n\trdma_ah_set_grh(ah_attr, NULL, ah->av.flowlabel,\n\t\t\tah->av.gid_index, ah->av.hop_limit, ah->av.tclass);\n\trdma_ah_set_dgid_raw(ah_attr, ah->av.dgid);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}