{
  "module_name": "cmd.c",
  "hash_id": "a578b9e9b4e9e9a396fbf3ec93c068674e1243d2d03578167388bf00b00aa3f4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/mlx5/cmd.c",
  "human_readable_source": "\n \n\n#include \"cmd.h\"\n\nint mlx5r_cmd_query_special_mkeys(struct mlx5_ib_dev *dev)\n{\n\tu32 out[MLX5_ST_SZ_DW(query_special_contexts_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(query_special_contexts_in)] = {};\n\tbool is_terminate, is_dump, is_null;\n\tint err;\n\n\tis_terminate = MLX5_CAP_GEN(dev->mdev, terminate_scatter_list_mkey);\n\tis_dump = MLX5_CAP_GEN(dev->mdev, dump_fill_mkey);\n\tis_null = MLX5_CAP_GEN(dev->mdev, null_mkey);\n\n\tdev->mkeys.terminate_scatter_list_mkey = MLX5_TERMINATE_SCATTER_LIST_LKEY;\n\tif (!is_terminate && !is_dump && !is_null)\n\t\treturn 0;\n\n\tMLX5_SET(query_special_contexts_in, in, opcode,\n\t\t MLX5_CMD_OP_QUERY_SPECIAL_CONTEXTS);\n\terr = mlx5_cmd_exec_inout(dev->mdev, query_special_contexts, in, out);\n\tif (err)\n\t\treturn err;\n\n\tif (is_dump)\n\t\tdev->mkeys.dump_fill_mkey = MLX5_GET(query_special_contexts_out,\n\t\t\t\t\t\t     out, dump_fill_mkey);\n\n\tif (is_null)\n\t\tdev->mkeys.null_mkey = cpu_to_be32(\n\t\t\tMLX5_GET(query_special_contexts_out, out, null_mkey));\n\n\tif (is_terminate)\n\t\tdev->mkeys.terminate_scatter_list_mkey =\n\t\t\tcpu_to_be32(MLX5_GET(query_special_contexts_out, out,\n\t\t\t\t\t     terminate_scatter_list_mkey));\n\n\treturn 0;\n}\n\nint mlx5_cmd_query_cong_params(struct mlx5_core_dev *dev, int cong_point,\n\t\t\t       void *out)\n{\n\tu32 in[MLX5_ST_SZ_DW(query_cong_params_in)] = {};\n\n\tMLX5_SET(query_cong_params_in, in, opcode,\n\t\t MLX5_CMD_OP_QUERY_CONG_PARAMS);\n\tMLX5_SET(query_cong_params_in, in, cong_protocol, cong_point);\n\n\treturn mlx5_cmd_exec_inout(dev, query_cong_params, in, out);\n}\n\nvoid mlx5_cmd_destroy_tir(struct mlx5_core_dev *dev, u32 tirn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_tir_in)] = {};\n\n\tMLX5_SET(destroy_tir_in, in, opcode, MLX5_CMD_OP_DESTROY_TIR);\n\tMLX5_SET(destroy_tir_in, in, tirn, tirn);\n\tMLX5_SET(destroy_tir_in, in, uid, uid);\n\tmlx5_cmd_exec_in(dev, destroy_tir, in);\n}\n\nvoid mlx5_cmd_destroy_tis(struct mlx5_core_dev *dev, u32 tisn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_tis_in)] = {};\n\n\tMLX5_SET(destroy_tis_in, in, opcode, MLX5_CMD_OP_DESTROY_TIS);\n\tMLX5_SET(destroy_tis_in, in, tisn, tisn);\n\tMLX5_SET(destroy_tis_in, in, uid, uid);\n\tmlx5_cmd_exec_in(dev, destroy_tis, in);\n}\n\nint mlx5_cmd_destroy_rqt(struct mlx5_core_dev *dev, u32 rqtn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_rqt_in)] = {};\n\n\tMLX5_SET(destroy_rqt_in, in, opcode, MLX5_CMD_OP_DESTROY_RQT);\n\tMLX5_SET(destroy_rqt_in, in, rqtn, rqtn);\n\tMLX5_SET(destroy_rqt_in, in, uid, uid);\n\treturn mlx5_cmd_exec_in(dev, destroy_rqt, in);\n}\n\nint mlx5_cmd_alloc_transport_domain(struct mlx5_core_dev *dev, u32 *tdn,\n\t\t\t\t    u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(alloc_transport_domain_in)] = {};\n\tu32 out[MLX5_ST_SZ_DW(alloc_transport_domain_out)] = {};\n\tint err;\n\n\tMLX5_SET(alloc_transport_domain_in, in, opcode,\n\t\t MLX5_CMD_OP_ALLOC_TRANSPORT_DOMAIN);\n\tMLX5_SET(alloc_transport_domain_in, in, uid, uid);\n\n\terr = mlx5_cmd_exec_inout(dev, alloc_transport_domain, in, out);\n\tif (!err)\n\t\t*tdn = MLX5_GET(alloc_transport_domain_out, out,\n\t\t\t\ttransport_domain);\n\n\treturn err;\n}\n\nvoid mlx5_cmd_dealloc_transport_domain(struct mlx5_core_dev *dev, u32 tdn,\n\t\t\t\t       u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(dealloc_transport_domain_in)] = {};\n\n\tMLX5_SET(dealloc_transport_domain_in, in, opcode,\n\t\t MLX5_CMD_OP_DEALLOC_TRANSPORT_DOMAIN);\n\tMLX5_SET(dealloc_transport_domain_in, in, uid, uid);\n\tMLX5_SET(dealloc_transport_domain_in, in, transport_domain, tdn);\n\tmlx5_cmd_exec_in(dev, dealloc_transport_domain, in);\n}\n\nint mlx5_cmd_dealloc_pd(struct mlx5_core_dev *dev, u32 pdn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(dealloc_pd_in)] = {};\n\n\tMLX5_SET(dealloc_pd_in, in, opcode, MLX5_CMD_OP_DEALLOC_PD);\n\tMLX5_SET(dealloc_pd_in, in, pd, pdn);\n\tMLX5_SET(dealloc_pd_in, in, uid, uid);\n\treturn mlx5_cmd_exec_in(dev, dealloc_pd, in);\n}\n\nint mlx5_cmd_attach_mcg(struct mlx5_core_dev *dev, union ib_gid *mgid,\n\t\t\tu32 qpn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(attach_to_mcg_in)] = {};\n\tvoid *gid;\n\n\tMLX5_SET(attach_to_mcg_in, in, opcode, MLX5_CMD_OP_ATTACH_TO_MCG);\n\tMLX5_SET(attach_to_mcg_in, in, qpn, qpn);\n\tMLX5_SET(attach_to_mcg_in, in, uid, uid);\n\tgid = MLX5_ADDR_OF(attach_to_mcg_in, in, multicast_gid);\n\tmemcpy(gid, mgid, sizeof(*mgid));\n\treturn mlx5_cmd_exec_in(dev, attach_to_mcg, in);\n}\n\nint mlx5_cmd_detach_mcg(struct mlx5_core_dev *dev, union ib_gid *mgid,\n\t\t\tu32 qpn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(detach_from_mcg_in)] = {};\n\tvoid *gid;\n\n\tMLX5_SET(detach_from_mcg_in, in, opcode, MLX5_CMD_OP_DETACH_FROM_MCG);\n\tMLX5_SET(detach_from_mcg_in, in, qpn, qpn);\n\tMLX5_SET(detach_from_mcg_in, in, uid, uid);\n\tgid = MLX5_ADDR_OF(detach_from_mcg_in, in, multicast_gid);\n\tmemcpy(gid, mgid, sizeof(*mgid));\n\treturn mlx5_cmd_exec_in(dev, detach_from_mcg, in);\n}\n\nint mlx5_cmd_xrcd_alloc(struct mlx5_core_dev *dev, u32 *xrcdn, u16 uid)\n{\n\tu32 out[MLX5_ST_SZ_DW(alloc_xrcd_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(alloc_xrcd_in)] = {};\n\tint err;\n\n\tMLX5_SET(alloc_xrcd_in, in, opcode, MLX5_CMD_OP_ALLOC_XRCD);\n\tMLX5_SET(alloc_xrcd_in, in, uid, uid);\n\terr = mlx5_cmd_exec_inout(dev, alloc_xrcd, in, out);\n\tif (!err)\n\t\t*xrcdn = MLX5_GET(alloc_xrcd_out, out, xrcd);\n\treturn err;\n}\n\nint mlx5_cmd_xrcd_dealloc(struct mlx5_core_dev *dev, u32 xrcdn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(dealloc_xrcd_in)] = {};\n\n\tMLX5_SET(dealloc_xrcd_in, in, opcode, MLX5_CMD_OP_DEALLOC_XRCD);\n\tMLX5_SET(dealloc_xrcd_in, in, xrcd, xrcdn);\n\tMLX5_SET(dealloc_xrcd_in, in, uid, uid);\n\treturn mlx5_cmd_exec_in(dev, dealloc_xrcd, in);\n}\n\nint mlx5_cmd_mad_ifc(struct mlx5_core_dev *dev, const void *inb, void *outb,\n\t\t     u16 opmod, u8 port)\n{\n\tint outlen = MLX5_ST_SZ_BYTES(mad_ifc_out);\n\tint inlen = MLX5_ST_SZ_BYTES(mad_ifc_in);\n\tint err = -ENOMEM;\n\tvoid *data;\n\tvoid *resp;\n\tu32 *out;\n\tu32 *in;\n\n\tin = kzalloc(inlen, GFP_KERNEL);\n\tout = kzalloc(outlen, GFP_KERNEL);\n\tif (!in || !out)\n\t\tgoto out;\n\n\tMLX5_SET(mad_ifc_in, in, opcode, MLX5_CMD_OP_MAD_IFC);\n\tMLX5_SET(mad_ifc_in, in, op_mod, opmod);\n\tMLX5_SET(mad_ifc_in, in, port, port);\n\n\tdata = MLX5_ADDR_OF(mad_ifc_in, in, mad);\n\tmemcpy(data, inb, MLX5_FLD_SZ_BYTES(mad_ifc_in, mad));\n\n\terr = mlx5_cmd_exec_inout(dev, mad_ifc, in, out);\n\tif (err)\n\t\tgoto out;\n\n\tresp = MLX5_ADDR_OF(mad_ifc_out, out, response_mad_packet);\n\tmemcpy(outb, resp,\n\t       MLX5_FLD_SZ_BYTES(mad_ifc_out, response_mad_packet));\n\nout:\n\tkfree(out);\n\tkfree(in);\n\treturn err;\n}\n\nint mlx5_cmd_uar_alloc(struct mlx5_core_dev *dev, u32 *uarn, u16 uid)\n{\n\tu32 out[MLX5_ST_SZ_DW(alloc_uar_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(alloc_uar_in)] = {};\n\tint err;\n\n\tMLX5_SET(alloc_uar_in, in, opcode, MLX5_CMD_OP_ALLOC_UAR);\n\tMLX5_SET(alloc_uar_in, in, uid, uid);\n\terr = mlx5_cmd_exec_inout(dev, alloc_uar, in, out);\n\tif (err)\n\t\treturn err;\n\n\t*uarn = MLX5_GET(alloc_uar_out, out, uar);\n\treturn 0;\n}\n\nint mlx5_cmd_uar_dealloc(struct mlx5_core_dev *dev, u32 uarn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(dealloc_uar_in)] = {};\n\n\tMLX5_SET(dealloc_uar_in, in, opcode, MLX5_CMD_OP_DEALLOC_UAR);\n\tMLX5_SET(dealloc_uar_in, in, uar, uarn);\n\tMLX5_SET(dealloc_uar_in, in, uid, uid);\n\treturn mlx5_cmd_exec_in(dev, dealloc_uar, in);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}