{
  "module_name": "qpc.c",
  "hash_id": "e77054bb9842f639a14ca82f45bb153e4f2ba047a2b2a5be573ccc1fe6954ced",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/mlx5/qpc.c",
  "human_readable_source": "\n \n\n#include <linux/gfp.h>\n#include <linux/mlx5/qp.h>\n#include <linux/mlx5/driver.h>\n#include \"mlx5_ib.h\"\n#include \"qp.h\"\n\nstatic int mlx5_core_drain_dct(struct mlx5_ib_dev *dev,\n\t\t\t       struct mlx5_core_dct *dct);\n\nstatic struct mlx5_core_rsc_common *\nmlx5_get_rsc(struct mlx5_qp_table *table, u32 rsn)\n{\n\tstruct mlx5_core_rsc_common *common;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&table->lock, flags);\n\n\tcommon = radix_tree_lookup(&table->tree, rsn);\n\tif (common)\n\t\trefcount_inc(&common->refcount);\n\n\tspin_unlock_irqrestore(&table->lock, flags);\n\n\treturn common;\n}\n\nvoid mlx5_core_put_rsc(struct mlx5_core_rsc_common *common)\n{\n\tif (refcount_dec_and_test(&common->refcount))\n\t\tcomplete(&common->free);\n}\n\nstatic u64 qp_allowed_event_types(void)\n{\n\tu64 mask;\n\n\tmask = BIT(MLX5_EVENT_TYPE_PATH_MIG) |\n\t       BIT(MLX5_EVENT_TYPE_COMM_EST) |\n\t       BIT(MLX5_EVENT_TYPE_SQ_DRAINED) |\n\t       BIT(MLX5_EVENT_TYPE_SRQ_LAST_WQE) |\n\t       BIT(MLX5_EVENT_TYPE_WQ_CATAS_ERROR) |\n\t       BIT(MLX5_EVENT_TYPE_PATH_MIG_FAILED) |\n\t       BIT(MLX5_EVENT_TYPE_WQ_INVAL_REQ_ERROR) |\n\t       BIT(MLX5_EVENT_TYPE_WQ_ACCESS_ERROR);\n\n\treturn mask;\n}\n\nstatic u64 rq_allowed_event_types(void)\n{\n\tu64 mask;\n\n\tmask = BIT(MLX5_EVENT_TYPE_SRQ_LAST_WQE) |\n\t       BIT(MLX5_EVENT_TYPE_WQ_CATAS_ERROR);\n\n\treturn mask;\n}\n\nstatic u64 sq_allowed_event_types(void)\n{\n\treturn BIT(MLX5_EVENT_TYPE_WQ_CATAS_ERROR);\n}\n\nstatic u64 dct_allowed_event_types(void)\n{\n\treturn BIT(MLX5_EVENT_TYPE_DCT_DRAINED);\n}\n\nstatic bool is_event_type_allowed(int rsc_type, int event_type)\n{\n\tswitch (rsc_type) {\n\tcase MLX5_EVENT_QUEUE_TYPE_QP:\n\t\treturn BIT(event_type) & qp_allowed_event_types();\n\tcase MLX5_EVENT_QUEUE_TYPE_RQ:\n\t\treturn BIT(event_type) & rq_allowed_event_types();\n\tcase MLX5_EVENT_QUEUE_TYPE_SQ:\n\t\treturn BIT(event_type) & sq_allowed_event_types();\n\tcase MLX5_EVENT_QUEUE_TYPE_DCT:\n\t\treturn BIT(event_type) & dct_allowed_event_types();\n\tdefault:\n\t\tWARN(1, \"Event arrived for unknown resource type\");\n\t\treturn false;\n\t}\n}\n\nstatic int dct_event_notifier(struct mlx5_ib_dev *dev, struct mlx5_eqe *eqe)\n{\n\tstruct mlx5_core_dct *dct;\n\tunsigned long flags;\n\tu32 qpn;\n\n\tqpn = be32_to_cpu(eqe->data.dct.dctn) & 0xFFFFFF;\n\txa_lock_irqsave(&dev->qp_table.dct_xa, flags);\n\tdct = xa_load(&dev->qp_table.dct_xa, qpn);\n\tif (dct)\n\t\tcomplete(&dct->drained);\n\txa_unlock_irqrestore(&dev->qp_table.dct_xa, flags);\n\treturn NOTIFY_OK;\n}\n\nstatic int rsc_event_notifier(struct notifier_block *nb,\n\t\t\t      unsigned long type, void *data)\n{\n\tstruct mlx5_ib_dev *dev =\n\t\tcontainer_of(nb, struct mlx5_ib_dev, qp_table.nb);\n\tstruct mlx5_core_rsc_common *common;\n\tstruct mlx5_eqe *eqe = data;\n\tu8 event_type = (u8)type;\n\tstruct mlx5_core_qp *qp;\n\tu32 rsn;\n\n\tswitch (event_type) {\n\tcase MLX5_EVENT_TYPE_DCT_DRAINED:\n\t\treturn dct_event_notifier(dev, eqe);\n\tcase MLX5_EVENT_TYPE_PATH_MIG:\n\tcase MLX5_EVENT_TYPE_COMM_EST:\n\tcase MLX5_EVENT_TYPE_SQ_DRAINED:\n\tcase MLX5_EVENT_TYPE_SRQ_LAST_WQE:\n\tcase MLX5_EVENT_TYPE_WQ_CATAS_ERROR:\n\tcase MLX5_EVENT_TYPE_PATH_MIG_FAILED:\n\tcase MLX5_EVENT_TYPE_WQ_INVAL_REQ_ERROR:\n\tcase MLX5_EVENT_TYPE_WQ_ACCESS_ERROR:\n\t\trsn = be32_to_cpu(eqe->data.qp_srq.qp_srq_n) & 0xffffff;\n\t\trsn |= (eqe->data.qp_srq.type << MLX5_USER_INDEX_LEN);\n\t\tbreak;\n\tdefault:\n\t\treturn NOTIFY_DONE;\n\t}\n\n\tcommon = mlx5_get_rsc(&dev->qp_table, rsn);\n\tif (!common)\n\t\treturn NOTIFY_OK;\n\n\tif (!is_event_type_allowed((rsn >> MLX5_USER_INDEX_LEN), event_type))\n\t\tgoto out;\n\n\tswitch (common->res) {\n\tcase MLX5_RES_QP:\n\tcase MLX5_RES_RQ:\n\tcase MLX5_RES_SQ:\n\t\tqp = (struct mlx5_core_qp *)common;\n\t\tqp->event(qp, event_type);\n\t\t \n\t\treturn NOTIFY_OK;\n\tdefault:\n\t\tbreak;\n\t}\nout:\n\tmlx5_core_put_rsc(common);\n\n\treturn NOTIFY_OK;\n}\n\nstatic int create_resource_common(struct mlx5_ib_dev *dev,\n\t\t\t\t  struct mlx5_core_qp *qp, int rsc_type)\n{\n\tstruct mlx5_qp_table *table = &dev->qp_table;\n\tint err;\n\n\tqp->common.res = rsc_type;\n\tspin_lock_irq(&table->lock);\n\terr = radix_tree_insert(&table->tree,\n\t\t\t\tqp->qpn | (rsc_type << MLX5_USER_INDEX_LEN),\n\t\t\t\tqp);\n\tspin_unlock_irq(&table->lock);\n\tif (err)\n\t\treturn err;\n\n\trefcount_set(&qp->common.refcount, 1);\n\tinit_completion(&qp->common.free);\n\tqp->pid = current->pid;\n\n\treturn 0;\n}\n\nstatic void destroy_resource_common(struct mlx5_ib_dev *dev,\n\t\t\t\t    struct mlx5_core_qp *qp)\n{\n\tstruct mlx5_qp_table *table = &dev->qp_table;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&table->lock, flags);\n\tradix_tree_delete(&table->tree,\n\t\t\t  qp->qpn | (qp->common.res << MLX5_USER_INDEX_LEN));\n\tspin_unlock_irqrestore(&table->lock, flags);\n\tmlx5_core_put_rsc((struct mlx5_core_rsc_common *)qp);\n\twait_for_completion(&qp->common.free);\n}\n\nstatic int _mlx5_core_destroy_dct(struct mlx5_ib_dev *dev,\n\t\t\t\t  struct mlx5_core_dct *dct)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_dct_in)] = {};\n\tstruct mlx5_core_qp *qp = &dct->mqp;\n\n\tMLX5_SET(destroy_dct_in, in, opcode, MLX5_CMD_OP_DESTROY_DCT);\n\tMLX5_SET(destroy_dct_in, in, dctn, qp->qpn);\n\tMLX5_SET(destroy_dct_in, in, uid, qp->uid);\n\treturn mlx5_cmd_exec_in(dev->mdev, destroy_dct, in);\n}\n\nint mlx5_core_create_dct(struct mlx5_ib_dev *dev, struct mlx5_core_dct *dct,\n\t\t\t u32 *in, int inlen, u32 *out, int outlen)\n{\n\tstruct mlx5_core_qp *qp = &dct->mqp;\n\tint err;\n\n\tinit_completion(&dct->drained);\n\tMLX5_SET(create_dct_in, in, opcode, MLX5_CMD_OP_CREATE_DCT);\n\n\terr = mlx5_cmd_do(dev->mdev, in, inlen, out, outlen);\n\tif (err)\n\t\treturn err;\n\n\tqp->qpn = MLX5_GET(create_dct_out, out, dctn);\n\tqp->uid = MLX5_GET(create_dct_in, in, uid);\n\terr = xa_err(xa_store_irq(&dev->qp_table.dct_xa, qp->qpn, dct, GFP_KERNEL));\n\tif (err)\n\t\tgoto err_cmd;\n\n\treturn 0;\nerr_cmd:\n\t_mlx5_core_destroy_dct(dev, dct);\n\treturn err;\n}\n\nint mlx5_qpc_create_qp(struct mlx5_ib_dev *dev, struct mlx5_core_qp *qp,\n\t\t       u32 *in, int inlen, u32 *out)\n{\n\tu32 din[MLX5_ST_SZ_DW(destroy_qp_in)] = {};\n\tint err;\n\n\tMLX5_SET(create_qp_in, in, opcode, MLX5_CMD_OP_CREATE_QP);\n\n\terr = mlx5_cmd_exec(dev->mdev, in, inlen, out,\n\t\t\t    MLX5_ST_SZ_BYTES(create_qp_out));\n\tif (err)\n\t\treturn err;\n\n\tqp->uid = MLX5_GET(create_qp_in, in, uid);\n\tqp->qpn = MLX5_GET(create_qp_out, out, qpn);\n\n\terr = create_resource_common(dev, qp, MLX5_RES_QP);\n\tif (err)\n\t\tgoto err_cmd;\n\n\tmlx5_debug_qp_add(dev->mdev, qp);\n\n\treturn 0;\n\nerr_cmd:\n\tMLX5_SET(destroy_qp_in, din, opcode, MLX5_CMD_OP_DESTROY_QP);\n\tMLX5_SET(destroy_qp_in, din, qpn, qp->qpn);\n\tMLX5_SET(destroy_qp_in, din, uid, qp->uid);\n\tmlx5_cmd_exec_in(dev->mdev, destroy_qp, din);\n\treturn err;\n}\n\nstatic int mlx5_core_drain_dct(struct mlx5_ib_dev *dev,\n\t\t\t       struct mlx5_core_dct *dct)\n{\n\tu32 in[MLX5_ST_SZ_DW(drain_dct_in)] = {};\n\tstruct mlx5_core_qp *qp = &dct->mqp;\n\n\tMLX5_SET(drain_dct_in, in, opcode, MLX5_CMD_OP_DRAIN_DCT);\n\tMLX5_SET(drain_dct_in, in, dctn, qp->qpn);\n\tMLX5_SET(drain_dct_in, in, uid, qp->uid);\n\treturn mlx5_cmd_exec_in(dev->mdev, drain_dct, in);\n}\n\nint mlx5_core_destroy_dct(struct mlx5_ib_dev *dev,\n\t\t\t  struct mlx5_core_dct *dct)\n{\n\tstruct mlx5_qp_table *table = &dev->qp_table;\n\tstruct mlx5_core_dct *tmp;\n\tint err;\n\n\terr = mlx5_core_drain_dct(dev, dct);\n\tif (err) {\n\t\tif (dev->mdev->state == MLX5_DEVICE_STATE_INTERNAL_ERROR)\n\t\t\tgoto destroy;\n\n\t\treturn err;\n\t}\n\twait_for_completion(&dct->drained);\n\ndestroy:\n\ttmp = xa_cmpxchg_irq(&table->dct_xa, dct->mqp.qpn, dct, XA_ZERO_ENTRY, GFP_KERNEL);\n\tif (WARN_ON(tmp != dct))\n\t\treturn xa_err(tmp) ?: -EINVAL;\n\n\terr = _mlx5_core_destroy_dct(dev, dct);\n\tif (err) {\n\t\txa_cmpxchg_irq(&table->dct_xa, dct->mqp.qpn, XA_ZERO_ENTRY, dct, 0);\n\t\treturn err;\n\t}\n\txa_erase_irq(&table->dct_xa, dct->mqp.qpn);\n\treturn 0;\n}\n\nint mlx5_core_destroy_qp(struct mlx5_ib_dev *dev, struct mlx5_core_qp *qp)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_qp_in)] = {};\n\n\tmlx5_debug_qp_remove(dev->mdev, qp);\n\n\tdestroy_resource_common(dev, qp);\n\n\tMLX5_SET(destroy_qp_in, in, opcode, MLX5_CMD_OP_DESTROY_QP);\n\tMLX5_SET(destroy_qp_in, in, qpn, qp->qpn);\n\tMLX5_SET(destroy_qp_in, in, uid, qp->uid);\n\treturn mlx5_cmd_exec_in(dev->mdev, destroy_qp, in);\n}\n\nint mlx5_core_set_delay_drop(struct mlx5_ib_dev *dev,\n\t\t\t     u32 timeout_usec)\n{\n\tu32 in[MLX5_ST_SZ_DW(set_delay_drop_params_in)] = {};\n\n\tMLX5_SET(set_delay_drop_params_in, in, opcode,\n\t\t MLX5_CMD_OP_SET_DELAY_DROP_PARAMS);\n\tMLX5_SET(set_delay_drop_params_in, in, delay_drop_timeout,\n\t\t timeout_usec / 100);\n\treturn mlx5_cmd_exec_in(dev->mdev, set_delay_drop_params, in);\n}\n\nstruct mbox_info {\n\tu32 *in;\n\tu32 *out;\n\tint inlen;\n\tint outlen;\n};\n\nstatic int mbox_alloc(struct mbox_info *mbox, int inlen, int outlen)\n{\n\tmbox->inlen  = inlen;\n\tmbox->outlen = outlen;\n\tmbox->in = kzalloc(mbox->inlen, GFP_KERNEL);\n\tmbox->out = kzalloc(mbox->outlen, GFP_KERNEL);\n\tif (!mbox->in || !mbox->out) {\n\t\tkfree(mbox->in);\n\t\tkfree(mbox->out);\n\t\treturn -ENOMEM;\n\t}\n\n\treturn 0;\n}\n\nstatic void mbox_free(struct mbox_info *mbox)\n{\n\tkfree(mbox->in);\n\tkfree(mbox->out);\n}\n\nstatic int get_ece_from_mbox(void *out, u16 opcode)\n{\n\tint ece = 0;\n\n\tswitch (opcode) {\n\tcase MLX5_CMD_OP_INIT2INIT_QP:\n\t\tece = MLX5_GET(init2init_qp_out, out, ece);\n\t\tbreak;\n\tcase MLX5_CMD_OP_INIT2RTR_QP:\n\t\tece = MLX5_GET(init2rtr_qp_out, out, ece);\n\t\tbreak;\n\tcase MLX5_CMD_OP_RTR2RTS_QP:\n\t\tece = MLX5_GET(rtr2rts_qp_out, out, ece);\n\t\tbreak;\n\tcase MLX5_CMD_OP_RTS2RTS_QP:\n\t\tece = MLX5_GET(rts2rts_qp_out, out, ece);\n\t\tbreak;\n\tcase MLX5_CMD_OP_RST2INIT_QP:\n\t\tece = MLX5_GET(rst2init_qp_out, out, ece);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn ece;\n}\n\nstatic int modify_qp_mbox_alloc(struct mlx5_core_dev *dev, u16 opcode, int qpn,\n\t\t\t\tu32 opt_param_mask, void *qpc,\n\t\t\t\tstruct mbox_info *mbox, u16 uid, u32 ece)\n{\n\tmbox->out = NULL;\n\tmbox->in = NULL;\n\n#define MBOX_ALLOC(mbox, typ)  \\\n\tmbox_alloc(mbox, MLX5_ST_SZ_BYTES(typ##_in), MLX5_ST_SZ_BYTES(typ##_out))\n\n#define MOD_QP_IN_SET(typ, in, _opcode, _qpn, _uid)                            \\\n\tdo {                                                                   \\\n\t\tMLX5_SET(typ##_in, in, opcode, _opcode);                       \\\n\t\tMLX5_SET(typ##_in, in, qpn, _qpn);                             \\\n\t\tMLX5_SET(typ##_in, in, uid, _uid);                             \\\n\t} while (0)\n\n#define MOD_QP_IN_SET_QPC(typ, in, _opcode, _qpn, _opt_p, _qpc, _uid)          \\\n\tdo {                                                                   \\\n\t\tMOD_QP_IN_SET(typ, in, _opcode, _qpn, _uid);                   \\\n\t\tMLX5_SET(typ##_in, in, opt_param_mask, _opt_p);                \\\n\t\tmemcpy(MLX5_ADDR_OF(typ##_in, in, qpc), _qpc,                  \\\n\t\t       MLX5_ST_SZ_BYTES(qpc));                                 \\\n\t} while (0)\n\n\tswitch (opcode) {\n\t \n\tcase MLX5_CMD_OP_2RST_QP:\n\t\tif (MBOX_ALLOC(mbox, qp_2rst))\n\t\t\treturn -ENOMEM;\n\t\tMOD_QP_IN_SET(qp_2rst, mbox->in, opcode, qpn, uid);\n\t\tbreak;\n\tcase MLX5_CMD_OP_2ERR_QP:\n\t\tif (MBOX_ALLOC(mbox, qp_2err))\n\t\t\treturn -ENOMEM;\n\t\tMOD_QP_IN_SET(qp_2err, mbox->in, opcode, qpn, uid);\n\t\tbreak;\n\n\t \n\tcase MLX5_CMD_OP_RST2INIT_QP:\n\t\tif (MBOX_ALLOC(mbox, rst2init_qp))\n\t\t\treturn -ENOMEM;\n\t\tMOD_QP_IN_SET_QPC(rst2init_qp, mbox->in, opcode, qpn,\n\t\t\t\t  opt_param_mask, qpc, uid);\n\t\tMLX5_SET(rst2init_qp_in, mbox->in, ece, ece);\n\t\tbreak;\n\tcase MLX5_CMD_OP_INIT2RTR_QP:\n\t\tif (MBOX_ALLOC(mbox, init2rtr_qp))\n\t\t\treturn -ENOMEM;\n\t\tMOD_QP_IN_SET_QPC(init2rtr_qp, mbox->in, opcode, qpn,\n\t\t\t\t  opt_param_mask, qpc, uid);\n\t\tMLX5_SET(init2rtr_qp_in, mbox->in, ece, ece);\n\t\tbreak;\n\tcase MLX5_CMD_OP_RTR2RTS_QP:\n\t\tif (MBOX_ALLOC(mbox, rtr2rts_qp))\n\t\t\treturn -ENOMEM;\n\t\tMOD_QP_IN_SET_QPC(rtr2rts_qp, mbox->in, opcode, qpn,\n\t\t\t\t  opt_param_mask, qpc, uid);\n\t\tMLX5_SET(rtr2rts_qp_in, mbox->in, ece, ece);\n\t\tbreak;\n\tcase MLX5_CMD_OP_RTS2RTS_QP:\n\t\tif (MBOX_ALLOC(mbox, rts2rts_qp))\n\t\t\treturn -ENOMEM;\n\t\tMOD_QP_IN_SET_QPC(rts2rts_qp, mbox->in, opcode, qpn,\n\t\t\t\t  opt_param_mask, qpc, uid);\n\t\tMLX5_SET(rts2rts_qp_in, mbox->in, ece, ece);\n\t\tbreak;\n\tcase MLX5_CMD_OP_SQERR2RTS_QP:\n\t\tif (MBOX_ALLOC(mbox, sqerr2rts_qp))\n\t\t\treturn -ENOMEM;\n\t\tMOD_QP_IN_SET_QPC(sqerr2rts_qp, mbox->in, opcode, qpn,\n\t\t\t\t  opt_param_mask, qpc, uid);\n\t\tbreak;\n\tcase MLX5_CMD_OP_SQD_RTS_QP:\n\t\tif (MBOX_ALLOC(mbox, sqd2rts_qp))\n\t\t\treturn -ENOMEM;\n\t\tMOD_QP_IN_SET_QPC(sqd2rts_qp, mbox->in, opcode, qpn,\n\t\t\t\t  opt_param_mask, qpc, uid);\n\t\tbreak;\n\tcase MLX5_CMD_OP_INIT2INIT_QP:\n\t\tif (MBOX_ALLOC(mbox, init2init_qp))\n\t\t\treturn -ENOMEM;\n\t\tMOD_QP_IN_SET_QPC(init2init_qp, mbox->in, opcode, qpn,\n\t\t\t\t  opt_param_mask, qpc, uid);\n\t\tMLX5_SET(init2init_qp_in, mbox->in, ece, ece);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nint mlx5_core_qp_modify(struct mlx5_ib_dev *dev, u16 opcode, u32 opt_param_mask,\n\t\t\tvoid *qpc, struct mlx5_core_qp *qp, u32 *ece)\n{\n\tstruct mbox_info mbox;\n\tint err;\n\n\terr = modify_qp_mbox_alloc(dev->mdev, opcode, qp->qpn, opt_param_mask,\n\t\t\t\t   qpc, &mbox, qp->uid, (ece) ? *ece : 0);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5_cmd_exec(dev->mdev, mbox.in, mbox.inlen, mbox.out,\n\t\t\t    mbox.outlen);\n\n\tif (ece)\n\t\t*ece = get_ece_from_mbox(mbox.out, opcode);\n\n\tmbox_free(&mbox);\n\treturn err;\n}\n\nint mlx5_init_qp_table(struct mlx5_ib_dev *dev)\n{\n\tstruct mlx5_qp_table *table = &dev->qp_table;\n\n\tspin_lock_init(&table->lock);\n\tINIT_RADIX_TREE(&table->tree, GFP_ATOMIC);\n\txa_init(&table->dct_xa);\n\tmlx5_qp_debugfs_init(dev->mdev);\n\n\ttable->nb.notifier_call = rsc_event_notifier;\n\tmlx5_notifier_register(dev->mdev, &table->nb);\n\n\treturn 0;\n}\n\nvoid mlx5_cleanup_qp_table(struct mlx5_ib_dev *dev)\n{\n\tstruct mlx5_qp_table *table = &dev->qp_table;\n\n\tmlx5_notifier_unregister(dev->mdev, &table->nb);\n\tmlx5_qp_debugfs_cleanup(dev->mdev);\n}\n\nint mlx5_core_qp_query(struct mlx5_ib_dev *dev, struct mlx5_core_qp *qp,\n\t\t       u32 *out, int outlen, bool qpc_ext)\n{\n\tu32 in[MLX5_ST_SZ_DW(query_qp_in)] = {};\n\n\tMLX5_SET(query_qp_in, in, opcode, MLX5_CMD_OP_QUERY_QP);\n\tMLX5_SET(query_qp_in, in, qpn, qp->qpn);\n\tMLX5_SET(query_qp_in, in, qpc_ext, qpc_ext);\n\n\treturn mlx5_cmd_exec(dev->mdev, in, sizeof(in), out, outlen);\n}\n\nint mlx5_core_dct_query(struct mlx5_ib_dev *dev, struct mlx5_core_dct *dct,\n\t\t\tu32 *out, int outlen)\n{\n\tu32 in[MLX5_ST_SZ_DW(query_dct_in)] = {};\n\tstruct mlx5_core_qp *qp = &dct->mqp;\n\n\tMLX5_SET(query_dct_in, in, opcode, MLX5_CMD_OP_QUERY_DCT);\n\tMLX5_SET(query_dct_in, in, dctn, qp->qpn);\n\n\treturn mlx5_cmd_exec(dev->mdev, (void *)&in, sizeof(in), (void *)out,\n\t\t\t     outlen);\n}\n\nint mlx5_core_xrcd_alloc(struct mlx5_ib_dev *dev, u32 *xrcdn)\n{\n\tu32 out[MLX5_ST_SZ_DW(alloc_xrcd_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(alloc_xrcd_in)] = {};\n\tint err;\n\n\tMLX5_SET(alloc_xrcd_in, in, opcode, MLX5_CMD_OP_ALLOC_XRCD);\n\terr = mlx5_cmd_exec_inout(dev->mdev, alloc_xrcd, in, out);\n\tif (!err)\n\t\t*xrcdn = MLX5_GET(alloc_xrcd_out, out, xrcd);\n\treturn err;\n}\n\nint mlx5_core_xrcd_dealloc(struct mlx5_ib_dev *dev, u32 xrcdn)\n{\n\tu32 in[MLX5_ST_SZ_DW(dealloc_xrcd_in)] = {};\n\n\tMLX5_SET(dealloc_xrcd_in, in, opcode, MLX5_CMD_OP_DEALLOC_XRCD);\n\tMLX5_SET(dealloc_xrcd_in, in, xrcd, xrcdn);\n\treturn mlx5_cmd_exec_in(dev->mdev, dealloc_xrcd, in);\n}\n\nstatic int destroy_rq_tracked(struct mlx5_ib_dev *dev, u32 rqn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_rq_in)] = {};\n\n\tMLX5_SET(destroy_rq_in, in, opcode, MLX5_CMD_OP_DESTROY_RQ);\n\tMLX5_SET(destroy_rq_in, in, rqn, rqn);\n\tMLX5_SET(destroy_rq_in, in, uid, uid);\n\treturn mlx5_cmd_exec_in(dev->mdev, destroy_rq, in);\n}\n\nint mlx5_core_create_rq_tracked(struct mlx5_ib_dev *dev, u32 *in, int inlen,\n\t\t\t\tstruct mlx5_core_qp *rq)\n{\n\tint err;\n\tu32 rqn;\n\n\terr = mlx5_core_create_rq(dev->mdev, in, inlen, &rqn);\n\tif (err)\n\t\treturn err;\n\n\trq->uid = MLX5_GET(create_rq_in, in, uid);\n\trq->qpn = rqn;\n\terr = create_resource_common(dev, rq, MLX5_RES_RQ);\n\tif (err)\n\t\tgoto err_destroy_rq;\n\n\treturn 0;\n\nerr_destroy_rq:\n\tdestroy_rq_tracked(dev, rq->qpn, rq->uid);\n\n\treturn err;\n}\n\nint mlx5_core_destroy_rq_tracked(struct mlx5_ib_dev *dev,\n\t\t\t\t struct mlx5_core_qp *rq)\n{\n\tdestroy_resource_common(dev, rq);\n\treturn destroy_rq_tracked(dev, rq->qpn, rq->uid);\n}\n\nstatic void destroy_sq_tracked(struct mlx5_ib_dev *dev, u32 sqn, u16 uid)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_sq_in)] = {};\n\n\tMLX5_SET(destroy_sq_in, in, opcode, MLX5_CMD_OP_DESTROY_SQ);\n\tMLX5_SET(destroy_sq_in, in, sqn, sqn);\n\tMLX5_SET(destroy_sq_in, in, uid, uid);\n\tmlx5_cmd_exec_in(dev->mdev, destroy_sq, in);\n}\n\nint mlx5_core_create_sq_tracked(struct mlx5_ib_dev *dev, u32 *in, int inlen,\n\t\t\t\tstruct mlx5_core_qp *sq)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_sq_out)] = {};\n\tint err;\n\n\tMLX5_SET(create_sq_in, in, opcode, MLX5_CMD_OP_CREATE_SQ);\n\terr = mlx5_cmd_exec(dev->mdev, in, inlen, out, sizeof(out));\n\tif (err)\n\t\treturn err;\n\n\tsq->qpn = MLX5_GET(create_sq_out, out, sqn);\n\tsq->uid = MLX5_GET(create_sq_in, in, uid);\n\terr = create_resource_common(dev, sq, MLX5_RES_SQ);\n\tif (err)\n\t\tgoto err_destroy_sq;\n\n\treturn 0;\n\nerr_destroy_sq:\n\tdestroy_sq_tracked(dev, sq->qpn, sq->uid);\n\n\treturn err;\n}\n\nvoid mlx5_core_destroy_sq_tracked(struct mlx5_ib_dev *dev,\n\t\t\t\t  struct mlx5_core_qp *sq)\n{\n\tdestroy_resource_common(dev, sq);\n\tdestroy_sq_tracked(dev, sq->qpn, sq->uid);\n}\n\nstruct mlx5_core_rsc_common *mlx5_core_res_hold(struct mlx5_ib_dev *dev,\n\t\t\t\t\t\tint res_num,\n\t\t\t\t\t\tenum mlx5_res_type res_type)\n{\n\tu32 rsn = res_num | (res_type << MLX5_USER_INDEX_LEN);\n\tstruct mlx5_qp_table *table = &dev->qp_table;\n\n\treturn mlx5_get_rsc(table, rsn);\n}\n\nvoid mlx5_core_res_put(struct mlx5_core_rsc_common *res)\n{\n\tmlx5_core_put_rsc(res);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}