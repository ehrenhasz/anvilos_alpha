{
  "module_name": "qib_user_pages.c",
  "hash_id": "a67ef139e2ff7918de5c73d44a9a0ca96c43a3f5260a838db4476815c9e6fe02",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/qib/qib_user_pages.c",
  "human_readable_source": " \n\n#include <linux/mm.h>\n#include <linux/sched/signal.h>\n#include <linux/device.h>\n\n#include \"qib.h\"\n\nstatic void __qib_release_user_pages(struct page **p, size_t num_pages,\n\t\t\t\t     int dirty)\n{\n\tunpin_user_pages_dirty_lock(p, num_pages, dirty);\n}\n\n \nint qib_map_page(struct pci_dev *hwdev, struct page *page, dma_addr_t *daddr)\n{\n\tdma_addr_t phys;\n\n\tphys = dma_map_page(&hwdev->dev, page, 0, PAGE_SIZE, DMA_FROM_DEVICE);\n\tif (dma_mapping_error(&hwdev->dev, phys))\n\t\treturn -ENOMEM;\n\n\tif (!phys) {\n\t\tdma_unmap_page(&hwdev->dev, phys, PAGE_SIZE, DMA_FROM_DEVICE);\n\t\tphys = dma_map_page(&hwdev->dev, page, 0, PAGE_SIZE,\n\t\t\t\t    DMA_FROM_DEVICE);\n\t\tif (dma_mapping_error(&hwdev->dev, phys))\n\t\t\treturn -ENOMEM;\n\t\t \n\t}\n\t*daddr = phys;\n\treturn 0;\n}\n\n \nint qib_get_user_pages(unsigned long start_page, size_t num_pages,\n\t\t       struct page **p)\n{\n\tunsigned long locked, lock_limit;\n\tsize_t got;\n\tint ret;\n\n\tlock_limit = rlimit(RLIMIT_MEMLOCK) >> PAGE_SHIFT;\n\tlocked = atomic64_add_return(num_pages, &current->mm->pinned_vm);\n\n\tif (locked > lock_limit && !capable(CAP_IPC_LOCK)) {\n\t\tret = -ENOMEM;\n\t\tgoto bail;\n\t}\n\n\tmmap_read_lock(current->mm);\n\tfor (got = 0; got < num_pages; got += ret) {\n\t\tret = pin_user_pages(start_page + got * PAGE_SIZE,\n\t\t\t\t     num_pages - got,\n\t\t\t\t     FOLL_LONGTERM | FOLL_WRITE,\n\t\t\t\t     p + got);\n\t\tif (ret < 0) {\n\t\t\tmmap_read_unlock(current->mm);\n\t\t\tgoto bail_release;\n\t\t}\n\t}\n\tmmap_read_unlock(current->mm);\n\n\treturn 0;\nbail_release:\n\t__qib_release_user_pages(p, got, 0);\nbail:\n\tatomic64_sub(num_pages, &current->mm->pinned_vm);\n\treturn ret;\n}\n\nvoid qib_release_user_pages(struct page **p, size_t num_pages)\n{\n\t__qib_release_user_pages(p, num_pages, 1);\n\n\t \n\tif (current->mm)\n\t\tatomic64_sub(num_pages, &current->mm->pinned_vm);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}