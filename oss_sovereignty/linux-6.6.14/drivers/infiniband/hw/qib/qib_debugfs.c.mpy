{
  "module_name": "qib_debugfs.c",
  "hash_id": "b62ba6d77813c1af30bb033f5ab5ad8353f2037f53209e33fa5f4f7685444dba",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/qib/qib_debugfs.c",
  "human_readable_source": " \n#include <linux/debugfs.h>\n#include <linux/seq_file.h>\n#include <linux/kernel.h>\n#include <linux/export.h>\n\n#include \"qib.h\"\n#include \"qib_verbs.h\"\n#include \"qib_debugfs.h\"\n\nstatic struct dentry *qib_dbg_root;\n\n#define DEBUGFS_FILE(name) \\\nstatic const struct seq_operations _##name##_seq_ops = { \\\n\t.start = _##name##_seq_start, \\\n\t.next  = _##name##_seq_next, \\\n\t.stop  = _##name##_seq_stop, \\\n\t.show  = _##name##_seq_show \\\n}; \\\nstatic int _##name##_open(struct inode *inode, struct file *s) \\\n{ \\\n\tstruct seq_file *seq; \\\n\tint ret; \\\n\tret =  seq_open(s, &_##name##_seq_ops); \\\n\tif (ret) \\\n\t\treturn ret; \\\n\tseq = s->private_data; \\\n\tseq->private = inode->i_private; \\\n\treturn 0; \\\n} \\\nstatic const struct file_operations _##name##_file_ops = { \\\n\t.owner   = THIS_MODULE, \\\n\t.open    = _##name##_open, \\\n\t.read    = seq_read, \\\n\t.llseek  = seq_lseek, \\\n\t.release = seq_release \\\n};\n\nstatic void *_opcode_stats_seq_start(struct seq_file *s, loff_t *pos)\n{\n\tstruct qib_opcode_stats_perctx *opstats;\n\n\tif (*pos >= ARRAY_SIZE(opstats->stats))\n\t\treturn NULL;\n\treturn pos;\n}\n\nstatic void *_opcode_stats_seq_next(struct seq_file *s, void *v, loff_t *pos)\n{\n\tstruct qib_opcode_stats_perctx *opstats;\n\n\t++*pos;\n\tif (*pos >= ARRAY_SIZE(opstats->stats))\n\t\treturn NULL;\n\treturn pos;\n}\n\n\nstatic void _opcode_stats_seq_stop(struct seq_file *s, void *v)\n{\n\t \n}\n\nstatic int _opcode_stats_seq_show(struct seq_file *s, void *v)\n{\n\tloff_t *spos = v;\n\tloff_t i = *spos, j;\n\tu64 n_packets = 0, n_bytes = 0;\n\tstruct qib_ibdev *ibd = (struct qib_ibdev *)s->private;\n\tstruct qib_devdata *dd = dd_from_dev(ibd);\n\n\tfor (j = 0; j < dd->first_user_ctxt; j++) {\n\t\tif (!dd->rcd[j])\n\t\t\tcontinue;\n\t\tn_packets += dd->rcd[j]->opstats->stats[i].n_packets;\n\t\tn_bytes += dd->rcd[j]->opstats->stats[i].n_bytes;\n\t}\n\tif (!n_packets && !n_bytes)\n\t\treturn SEQ_SKIP;\n\tseq_printf(s, \"%02llx %llu/%llu\\n\", i,\n\t\t(unsigned long long) n_packets,\n\t\t(unsigned long long) n_bytes);\n\n\treturn 0;\n}\n\nDEBUGFS_FILE(opcode_stats)\n\nstatic void *_ctx_stats_seq_start(struct seq_file *s, loff_t *pos)\n{\n\tstruct qib_ibdev *ibd = (struct qib_ibdev *)s->private;\n\tstruct qib_devdata *dd = dd_from_dev(ibd);\n\n\tif (!*pos)\n\t\treturn SEQ_START_TOKEN;\n\tif (*pos >= dd->first_user_ctxt)\n\t\treturn NULL;\n\treturn pos;\n}\n\nstatic void *_ctx_stats_seq_next(struct seq_file *s, void *v, loff_t *pos)\n{\n\tstruct qib_ibdev *ibd = (struct qib_ibdev *)s->private;\n\tstruct qib_devdata *dd = dd_from_dev(ibd);\n\n\tif (v == SEQ_START_TOKEN)\n\t\treturn pos;\n\n\t++*pos;\n\tif (*pos >= dd->first_user_ctxt)\n\t\treturn NULL;\n\treturn pos;\n}\n\nstatic void _ctx_stats_seq_stop(struct seq_file *s, void *v)\n{\n\t \n}\n\nstatic int _ctx_stats_seq_show(struct seq_file *s, void *v)\n{\n\tloff_t *spos;\n\tloff_t i, j;\n\tu64 n_packets = 0;\n\tstruct qib_ibdev *ibd = (struct qib_ibdev *)s->private;\n\tstruct qib_devdata *dd = dd_from_dev(ibd);\n\n\tif (v == SEQ_START_TOKEN) {\n\t\tseq_puts(s, \"Ctx:npkts\\n\");\n\t\treturn 0;\n\t}\n\n\tspos = v;\n\ti = *spos;\n\n\tif (!dd->rcd[i])\n\t\treturn SEQ_SKIP;\n\n\tfor (j = 0; j < ARRAY_SIZE(dd->rcd[i]->opstats->stats); j++)\n\t\tn_packets += dd->rcd[i]->opstats->stats[j].n_packets;\n\n\tif (!n_packets)\n\t\treturn SEQ_SKIP;\n\n\tseq_printf(s, \"  %llu:%llu\\n\", i, n_packets);\n\treturn 0;\n}\n\nDEBUGFS_FILE(ctx_stats)\n\nstatic void *_qp_stats_seq_start(struct seq_file *s, loff_t *pos)\n\t__acquires(RCU)\n{\n\tstruct rvt_qp_iter *iter;\n\tloff_t n = *pos;\n\n\titer = rvt_qp_iter_init(s->private, 0, NULL);\n\n\t \n\trcu_read_lock();\n\n\tif (!iter)\n\t\treturn NULL;\n\n\tdo {\n\t\tif (rvt_qp_iter_next(iter)) {\n\t\t\tkfree(iter);\n\t\t\treturn NULL;\n\t\t}\n\t} while (n--);\n\n\treturn iter;\n}\n\nstatic void *_qp_stats_seq_next(struct seq_file *s, void *iter_ptr,\n\t\t\t\t   loff_t *pos)\n\t__must_hold(RCU)\n{\n\tstruct rvt_qp_iter *iter = iter_ptr;\n\n\t(*pos)++;\n\n\tif (rvt_qp_iter_next(iter)) {\n\t\tkfree(iter);\n\t\treturn NULL;\n\t}\n\n\treturn iter;\n}\n\nstatic void _qp_stats_seq_stop(struct seq_file *s, void *iter_ptr)\n\t__releases(RCU)\n{\n\trcu_read_unlock();\n}\n\nstatic int _qp_stats_seq_show(struct seq_file *s, void *iter_ptr)\n{\n\tstruct rvt_qp_iter *iter = iter_ptr;\n\n\tif (!iter)\n\t\treturn 0;\n\n\tqib_qp_iter_print(s, iter);\n\n\treturn 0;\n}\n\nDEBUGFS_FILE(qp_stats)\n\nvoid qib_dbg_ibdev_init(struct qib_ibdev *ibd)\n{\n\tstruct dentry *root;\n\tchar name[10];\n\n\tsnprintf(name, sizeof(name), \"qib%d\", dd_from_dev(ibd)->unit);\n\troot = debugfs_create_dir(name, qib_dbg_root);\n\tibd->qib_ibdev_dbg = root;\n\n\tdebugfs_create_file(\"opcode_stats\", 0400, root, ibd,\n\t\t\t    &_opcode_stats_file_ops);\n\tdebugfs_create_file(\"ctx_stats\", 0400, root, ibd, &_ctx_stats_file_ops);\n\tdebugfs_create_file(\"qp_stats\", 0400, root, ibd, &_qp_stats_file_ops);\n}\n\nvoid qib_dbg_ibdev_exit(struct qib_ibdev *ibd)\n{\n\tif (!qib_dbg_root)\n\t\tgoto out;\n\tdebugfs_remove_recursive(ibd->qib_ibdev_dbg);\nout:\n\tibd->qib_ibdev_dbg = NULL;\n}\n\nvoid qib_dbg_init(void)\n{\n\tqib_dbg_root = debugfs_create_dir(QIB_DRV_NAME, NULL);\n}\n\nvoid qib_dbg_exit(void)\n{\n\tdebugfs_remove_recursive(qib_dbg_root);\n\tqib_dbg_root = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}