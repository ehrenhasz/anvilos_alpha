{
  "module_name": "qib_uc.c",
  "hash_id": "0a322c2cbc3d781056b11e8fee477116218e490ec0c67abf3e211ecc9525ad6b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/qib/qib_uc.c",
  "human_readable_source": " \n\n#include \"qib.h\"\n\n \n#define OP(x) IB_OPCODE_UC_##x\n\n \nint qib_make_uc_req(struct rvt_qp *qp, unsigned long *flags)\n{\n\tstruct qib_qp_priv *priv = qp->priv;\n\tstruct ib_other_headers *ohdr;\n\tstruct rvt_swqe *wqe;\n\tu32 hwords;\n\tu32 bth0;\n\tu32 len;\n\tu32 pmtu = qp->pmtu;\n\tint ret = 0;\n\n\tif (!(ib_rvt_state_ops[qp->state] & RVT_PROCESS_SEND_OK)) {\n\t\tif (!(ib_rvt_state_ops[qp->state] & RVT_FLUSH_SEND))\n\t\t\tgoto bail;\n\t\t \n\t\tif (qp->s_last == READ_ONCE(qp->s_head))\n\t\t\tgoto bail;\n\t\t \n\t\tif (atomic_read(&priv->s_dma_busy)) {\n\t\t\tqp->s_flags |= RVT_S_WAIT_DMA;\n\t\t\tgoto bail;\n\t\t}\n\t\twqe = rvt_get_swqe_ptr(qp, qp->s_last);\n\t\trvt_send_complete(qp, wqe, IB_WC_WR_FLUSH_ERR);\n\t\tgoto done;\n\t}\n\n\tohdr = &priv->s_hdr->u.oth;\n\tif (rdma_ah_get_ah_flags(&qp->remote_ah_attr) & IB_AH_GRH)\n\t\tohdr = &priv->s_hdr->u.l.oth;\n\n\t \n\thwords = 5;\n\tbth0 = 0;\n\n\t \n\twqe = rvt_get_swqe_ptr(qp, qp->s_cur);\n\tqp->s_wqe = NULL;\n\tswitch (qp->s_state) {\n\tdefault:\n\t\tif (!(ib_rvt_state_ops[qp->state] &\n\t\t    RVT_PROCESS_NEXT_SEND_OK))\n\t\t\tgoto bail;\n\t\t \n\t\tif (qp->s_cur == READ_ONCE(qp->s_head))\n\t\t\tgoto bail;\n\t\t \n\t\tqp->s_psn = wqe->psn;\n\t\tqp->s_sge.sge = wqe->sg_list[0];\n\t\tqp->s_sge.sg_list = wqe->sg_list + 1;\n\t\tqp->s_sge.num_sge = wqe->wr.num_sge;\n\t\tqp->s_sge.total_len = wqe->length;\n\t\tlen = wqe->length;\n\t\tqp->s_len = len;\n\t\tswitch (wqe->wr.opcode) {\n\t\tcase IB_WR_SEND:\n\t\tcase IB_WR_SEND_WITH_IMM:\n\t\t\tif (len > pmtu) {\n\t\t\t\tqp->s_state = OP(SEND_FIRST);\n\t\t\t\tlen = pmtu;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (wqe->wr.opcode == IB_WR_SEND)\n\t\t\t\tqp->s_state = OP(SEND_ONLY);\n\t\t\telse {\n\t\t\t\tqp->s_state =\n\t\t\t\t\tOP(SEND_ONLY_WITH_IMMEDIATE);\n\t\t\t\t \n\t\t\t\tohdr->u.imm_data = wqe->wr.ex.imm_data;\n\t\t\t\thwords += 1;\n\t\t\t}\n\t\t\tif (wqe->wr.send_flags & IB_SEND_SOLICITED)\n\t\t\t\tbth0 |= IB_BTH_SOLICITED;\n\t\t\tqp->s_wqe = wqe;\n\t\t\tif (++qp->s_cur >= qp->s_size)\n\t\t\t\tqp->s_cur = 0;\n\t\t\tbreak;\n\n\t\tcase IB_WR_RDMA_WRITE:\n\t\tcase IB_WR_RDMA_WRITE_WITH_IMM:\n\t\t\tohdr->u.rc.reth.vaddr =\n\t\t\t\tcpu_to_be64(wqe->rdma_wr.remote_addr);\n\t\t\tohdr->u.rc.reth.rkey =\n\t\t\t\tcpu_to_be32(wqe->rdma_wr.rkey);\n\t\t\tohdr->u.rc.reth.length = cpu_to_be32(len);\n\t\t\thwords += sizeof(struct ib_reth) / 4;\n\t\t\tif (len > pmtu) {\n\t\t\t\tqp->s_state = OP(RDMA_WRITE_FIRST);\n\t\t\t\tlen = pmtu;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (wqe->wr.opcode == IB_WR_RDMA_WRITE)\n\t\t\t\tqp->s_state = OP(RDMA_WRITE_ONLY);\n\t\t\telse {\n\t\t\t\tqp->s_state =\n\t\t\t\t\tOP(RDMA_WRITE_ONLY_WITH_IMMEDIATE);\n\t\t\t\t \n\t\t\t\tohdr->u.rc.imm_data = wqe->wr.ex.imm_data;\n\t\t\t\thwords += 1;\n\t\t\t\tif (wqe->wr.send_flags & IB_SEND_SOLICITED)\n\t\t\t\t\tbth0 |= IB_BTH_SOLICITED;\n\t\t\t}\n\t\t\tqp->s_wqe = wqe;\n\t\t\tif (++qp->s_cur >= qp->s_size)\n\t\t\t\tqp->s_cur = 0;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tgoto bail;\n\t\t}\n\t\tbreak;\n\n\tcase OP(SEND_FIRST):\n\t\tqp->s_state = OP(SEND_MIDDLE);\n\t\tfallthrough;\n\tcase OP(SEND_MIDDLE):\n\t\tlen = qp->s_len;\n\t\tif (len > pmtu) {\n\t\t\tlen = pmtu;\n\t\t\tbreak;\n\t\t}\n\t\tif (wqe->wr.opcode == IB_WR_SEND)\n\t\t\tqp->s_state = OP(SEND_LAST);\n\t\telse {\n\t\t\tqp->s_state = OP(SEND_LAST_WITH_IMMEDIATE);\n\t\t\t \n\t\t\tohdr->u.imm_data = wqe->wr.ex.imm_data;\n\t\t\thwords += 1;\n\t\t}\n\t\tif (wqe->wr.send_flags & IB_SEND_SOLICITED)\n\t\t\tbth0 |= IB_BTH_SOLICITED;\n\t\tqp->s_wqe = wqe;\n\t\tif (++qp->s_cur >= qp->s_size)\n\t\t\tqp->s_cur = 0;\n\t\tbreak;\n\n\tcase OP(RDMA_WRITE_FIRST):\n\t\tqp->s_state = OP(RDMA_WRITE_MIDDLE);\n\t\tfallthrough;\n\tcase OP(RDMA_WRITE_MIDDLE):\n\t\tlen = qp->s_len;\n\t\tif (len > pmtu) {\n\t\t\tlen = pmtu;\n\t\t\tbreak;\n\t\t}\n\t\tif (wqe->wr.opcode == IB_WR_RDMA_WRITE)\n\t\t\tqp->s_state = OP(RDMA_WRITE_LAST);\n\t\telse {\n\t\t\tqp->s_state =\n\t\t\t\tOP(RDMA_WRITE_LAST_WITH_IMMEDIATE);\n\t\t\t \n\t\t\tohdr->u.imm_data = wqe->wr.ex.imm_data;\n\t\t\thwords += 1;\n\t\t\tif (wqe->wr.send_flags & IB_SEND_SOLICITED)\n\t\t\t\tbth0 |= IB_BTH_SOLICITED;\n\t\t}\n\t\tqp->s_wqe = wqe;\n\t\tif (++qp->s_cur >= qp->s_size)\n\t\t\tqp->s_cur = 0;\n\t\tbreak;\n\t}\n\tqp->s_len -= len;\n\tqp->s_hdrwords = hwords;\n\tqp->s_cur_sge = &qp->s_sge;\n\tqp->s_cur_size = len;\n\tqib_make_ruc_header(qp, ohdr, bth0 | (qp->s_state << 24),\n\t\t\t    qp->s_psn++ & QIB_PSN_MASK);\ndone:\n\treturn 1;\nbail:\n\tqp->s_flags &= ~RVT_S_BUSY;\n\treturn ret;\n}\n\n \nvoid qib_uc_rcv(struct qib_ibport *ibp, struct ib_header *hdr,\n\t\tint has_grh, void *data, u32 tlen, struct rvt_qp *qp)\n{\n\tstruct ib_other_headers *ohdr;\n\tu32 opcode;\n\tu32 hdrsize;\n\tu32 psn;\n\tu32 pad;\n\tstruct ib_wc wc;\n\tu32 pmtu = qp->pmtu;\n\tstruct ib_reth *reth;\n\tint ret;\n\n\t \n\tif (!has_grh) {\n\t\tohdr = &hdr->u.oth;\n\t\thdrsize = 8 + 12;        \n\t} else {\n\t\tohdr = &hdr->u.l.oth;\n\t\thdrsize = 8 + 40 + 12;   \n\t}\n\n\topcode = be32_to_cpu(ohdr->bth[0]);\n\tif (qib_ruc_check_hdr(ibp, hdr, has_grh, qp, opcode))\n\t\treturn;\n\n\tpsn = be32_to_cpu(ohdr->bth[2]);\n\topcode >>= 24;\n\n\t \n\tif (unlikely(qib_cmp24(psn, qp->r_psn) != 0)) {\n\t\t \n\t\tqp->r_psn = psn;\ninv:\n\t\tif (qp->r_state == OP(SEND_FIRST) ||\n\t\t    qp->r_state == OP(SEND_MIDDLE)) {\n\t\t\tset_bit(RVT_R_REWIND_SGE, &qp->r_aflags);\n\t\t\tqp->r_sge.num_sge = 0;\n\t\t} else\n\t\t\trvt_put_ss(&qp->r_sge);\n\t\tqp->r_state = OP(SEND_LAST);\n\t\tswitch (opcode) {\n\t\tcase OP(SEND_FIRST):\n\t\tcase OP(SEND_ONLY):\n\t\tcase OP(SEND_ONLY_WITH_IMMEDIATE):\n\t\t\tgoto send_first;\n\n\t\tcase OP(RDMA_WRITE_FIRST):\n\t\tcase OP(RDMA_WRITE_ONLY):\n\t\tcase OP(RDMA_WRITE_ONLY_WITH_IMMEDIATE):\n\t\t\tgoto rdma_first;\n\n\t\tdefault:\n\t\t\tgoto drop;\n\t\t}\n\t}\n\n\t \n\tswitch (qp->r_state) {\n\tcase OP(SEND_FIRST):\n\tcase OP(SEND_MIDDLE):\n\t\tif (opcode == OP(SEND_MIDDLE) ||\n\t\t    opcode == OP(SEND_LAST) ||\n\t\t    opcode == OP(SEND_LAST_WITH_IMMEDIATE))\n\t\t\tbreak;\n\t\tgoto inv;\n\n\tcase OP(RDMA_WRITE_FIRST):\n\tcase OP(RDMA_WRITE_MIDDLE):\n\t\tif (opcode == OP(RDMA_WRITE_MIDDLE) ||\n\t\t    opcode == OP(RDMA_WRITE_LAST) ||\n\t\t    opcode == OP(RDMA_WRITE_LAST_WITH_IMMEDIATE))\n\t\t\tbreak;\n\t\tgoto inv;\n\n\tdefault:\n\t\tif (opcode == OP(SEND_FIRST) ||\n\t\t    opcode == OP(SEND_ONLY) ||\n\t\t    opcode == OP(SEND_ONLY_WITH_IMMEDIATE) ||\n\t\t    opcode == OP(RDMA_WRITE_FIRST) ||\n\t\t    opcode == OP(RDMA_WRITE_ONLY) ||\n\t\t    opcode == OP(RDMA_WRITE_ONLY_WITH_IMMEDIATE))\n\t\t\tbreak;\n\t\tgoto inv;\n\t}\n\n\tif (qp->state == IB_QPS_RTR && !(qp->r_flags & RVT_R_COMM_EST))\n\t\trvt_comm_est(qp);\n\n\t \n\tswitch (opcode) {\n\tcase OP(SEND_FIRST):\n\tcase OP(SEND_ONLY):\n\tcase OP(SEND_ONLY_WITH_IMMEDIATE):\nsend_first:\n\t\tif (test_and_clear_bit(RVT_R_REWIND_SGE, &qp->r_aflags))\n\t\t\tqp->r_sge = qp->s_rdma_read_sge;\n\t\telse {\n\t\t\tret = rvt_get_rwqe(qp, false);\n\t\t\tif (ret < 0)\n\t\t\t\tgoto op_err;\n\t\t\tif (!ret)\n\t\t\t\tgoto drop;\n\t\t\t \n\t\t\tqp->s_rdma_read_sge = qp->r_sge;\n\t\t}\n\t\tqp->r_rcv_len = 0;\n\t\tif (opcode == OP(SEND_ONLY))\n\t\t\tgoto no_immediate_data;\n\t\telse if (opcode == OP(SEND_ONLY_WITH_IMMEDIATE))\n\t\t\tgoto send_last_imm;\n\t\tfallthrough;\n\tcase OP(SEND_MIDDLE):\n\t\t \n\t\tif (unlikely(tlen != (hdrsize + pmtu + 4)))\n\t\t\tgoto rewind;\n\t\tqp->r_rcv_len += pmtu;\n\t\tif (unlikely(qp->r_rcv_len > qp->r_len))\n\t\t\tgoto rewind;\n\t\trvt_copy_sge(qp, &qp->r_sge, data, pmtu, false, false);\n\t\tbreak;\n\n\tcase OP(SEND_LAST_WITH_IMMEDIATE):\nsend_last_imm:\n\t\twc.ex.imm_data = ohdr->u.imm_data;\n\t\thdrsize += 4;\n\t\twc.wc_flags = IB_WC_WITH_IMM;\n\t\tgoto send_last;\n\tcase OP(SEND_LAST):\nno_immediate_data:\n\t\twc.ex.imm_data = 0;\n\t\twc.wc_flags = 0;\nsend_last:\n\t\t \n\t\tpad = (be32_to_cpu(ohdr->bth[0]) >> 20) & 3;\n\t\t \n\t\t \n\t\tif (unlikely(tlen < (hdrsize + pad + 4)))\n\t\t\tgoto rewind;\n\t\t \n\t\ttlen -= (hdrsize + pad + 4);\n\t\twc.byte_len = tlen + qp->r_rcv_len;\n\t\tif (unlikely(wc.byte_len > qp->r_len))\n\t\t\tgoto rewind;\n\t\twc.opcode = IB_WC_RECV;\n\t\trvt_copy_sge(qp, &qp->r_sge, data, tlen, false, false);\n\t\trvt_put_ss(&qp->s_rdma_read_sge);\nlast_imm:\n\t\twc.wr_id = qp->r_wr_id;\n\t\twc.status = IB_WC_SUCCESS;\n\t\twc.qp = &qp->ibqp;\n\t\twc.src_qp = qp->remote_qpn;\n\t\twc.slid = rdma_ah_get_dlid(&qp->remote_ah_attr);\n\t\twc.sl = rdma_ah_get_sl(&qp->remote_ah_attr);\n\t\t \n\t\twc.vendor_err = 0;\n\t\twc.pkey_index = 0;\n\t\twc.dlid_path_bits = 0;\n\t\twc.port_num = 0;\n\t\t \n\t\trvt_recv_cq(qp, &wc, ib_bth_is_solicited(ohdr));\n\t\tbreak;\n\n\tcase OP(RDMA_WRITE_FIRST):\n\tcase OP(RDMA_WRITE_ONLY):\n\tcase OP(RDMA_WRITE_ONLY_WITH_IMMEDIATE):  \nrdma_first:\n\t\tif (unlikely(!(qp->qp_access_flags &\n\t\t\t       IB_ACCESS_REMOTE_WRITE))) {\n\t\t\tgoto drop;\n\t\t}\n\t\treth = &ohdr->u.rc.reth;\n\t\thdrsize += sizeof(*reth);\n\t\tqp->r_len = be32_to_cpu(reth->length);\n\t\tqp->r_rcv_len = 0;\n\t\tqp->r_sge.sg_list = NULL;\n\t\tif (qp->r_len != 0) {\n\t\t\tu32 rkey = be32_to_cpu(reth->rkey);\n\t\t\tu64 vaddr = be64_to_cpu(reth->vaddr);\n\t\t\tint ok;\n\n\t\t\t \n\t\t\tok = rvt_rkey_ok(qp, &qp->r_sge.sge, qp->r_len,\n\t\t\t\t\t vaddr, rkey, IB_ACCESS_REMOTE_WRITE);\n\t\t\tif (unlikely(!ok))\n\t\t\t\tgoto drop;\n\t\t\tqp->r_sge.num_sge = 1;\n\t\t} else {\n\t\t\tqp->r_sge.num_sge = 0;\n\t\t\tqp->r_sge.sge.mr = NULL;\n\t\t\tqp->r_sge.sge.vaddr = NULL;\n\t\t\tqp->r_sge.sge.length = 0;\n\t\t\tqp->r_sge.sge.sge_length = 0;\n\t\t}\n\t\tif (opcode == OP(RDMA_WRITE_ONLY))\n\t\t\tgoto rdma_last;\n\t\telse if (opcode == OP(RDMA_WRITE_ONLY_WITH_IMMEDIATE)) {\n\t\t\twc.ex.imm_data = ohdr->u.rc.imm_data;\n\t\t\tgoto rdma_last_imm;\n\t\t}\n\t\tfallthrough;\n\tcase OP(RDMA_WRITE_MIDDLE):\n\t\t \n\t\tif (unlikely(tlen != (hdrsize + pmtu + 4)))\n\t\t\tgoto drop;\n\t\tqp->r_rcv_len += pmtu;\n\t\tif (unlikely(qp->r_rcv_len > qp->r_len))\n\t\t\tgoto drop;\n\t\trvt_copy_sge(qp, &qp->r_sge, data, pmtu, true, false);\n\t\tbreak;\n\n\tcase OP(RDMA_WRITE_LAST_WITH_IMMEDIATE):\n\t\twc.ex.imm_data = ohdr->u.imm_data;\nrdma_last_imm:\n\t\thdrsize += 4;\n\t\twc.wc_flags = IB_WC_WITH_IMM;\n\n\t\t \n\t\tpad = (be32_to_cpu(ohdr->bth[0]) >> 20) & 3;\n\t\t \n\t\t \n\t\tif (unlikely(tlen < (hdrsize + pad + 4)))\n\t\t\tgoto drop;\n\t\t \n\t\ttlen -= (hdrsize + pad + 4);\n\t\tif (unlikely(tlen + qp->r_rcv_len != qp->r_len))\n\t\t\tgoto drop;\n\t\tif (test_and_clear_bit(RVT_R_REWIND_SGE, &qp->r_aflags))\n\t\t\trvt_put_ss(&qp->s_rdma_read_sge);\n\t\telse {\n\t\t\tret = rvt_get_rwqe(qp, true);\n\t\t\tif (ret < 0)\n\t\t\t\tgoto op_err;\n\t\t\tif (!ret)\n\t\t\t\tgoto drop;\n\t\t}\n\t\twc.byte_len = qp->r_len;\n\t\twc.opcode = IB_WC_RECV_RDMA_WITH_IMM;\n\t\trvt_copy_sge(qp, &qp->r_sge, data, tlen, true, false);\n\t\trvt_put_ss(&qp->r_sge);\n\t\tgoto last_imm;\n\n\tcase OP(RDMA_WRITE_LAST):\nrdma_last:\n\t\t \n\t\tpad = (be32_to_cpu(ohdr->bth[0]) >> 20) & 3;\n\t\t \n\t\t \n\t\tif (unlikely(tlen < (hdrsize + pad + 4)))\n\t\t\tgoto drop;\n\t\t \n\t\ttlen -= (hdrsize + pad + 4);\n\t\tif (unlikely(tlen + qp->r_rcv_len != qp->r_len))\n\t\t\tgoto drop;\n\t\trvt_copy_sge(qp, &qp->r_sge, data, tlen, true, false);\n\t\trvt_put_ss(&qp->r_sge);\n\t\tbreak;\n\n\tdefault:\n\t\t \n\t\tgoto drop;\n\t}\n\tqp->r_psn++;\n\tqp->r_state = opcode;\n\treturn;\n\nrewind:\n\tset_bit(RVT_R_REWIND_SGE, &qp->r_aflags);\n\tqp->r_sge.num_sge = 0;\ndrop:\n\tibp->rvp.n_pkt_drops++;\n\treturn;\n\nop_err:\n\trvt_rc_error(qp, IB_WC_LOC_QP_OP_ERR);\n\treturn;\n\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}