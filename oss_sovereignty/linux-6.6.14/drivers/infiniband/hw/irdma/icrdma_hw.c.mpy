{
  "module_name": "icrdma_hw.c",
  "hash_id": "3a26c2939f32085db9c7382aa692d1fddada15f78b0df58cfdd68c83ac2d553f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/irdma/icrdma_hw.c",
  "human_readable_source": "\n \n#include \"osdep.h\"\n#include \"type.h\"\n#include \"icrdma_hw.h\"\n\nstatic u32 icrdma_regs[IRDMA_MAX_REGS] = {\n\tPFPE_CQPTAIL,\n\tPFPE_CQPDB,\n\tPFPE_CCQPSTATUS,\n\tPFPE_CCQPHIGH,\n\tPFPE_CCQPLOW,\n\tPFPE_CQARM,\n\tPFPE_CQACK,\n\tPFPE_AEQALLOC,\n\tPFPE_CQPERRCODES,\n\tPFPE_WQEALLOC,\n\tGLINT_DYN_CTL(0),\n\tICRDMA_DB_ADDR_OFFSET,\n\n\tGLPCI_LBARCTRL,\n\tGLPE_CPUSTATUS0,\n\tGLPE_CPUSTATUS1,\n\tGLPE_CPUSTATUS2,\n\tPFINT_AEQCTL,\n\tGLINT_CEQCTL(0),\n\tVSIQF_PE_CTL1(0),\n\tPFHMC_PDINV,\n\tGLHMC_VFPDINV(0),\n\tGLPE_CRITERR,\n\tGLINT_RATE(0),\n};\n\nstatic u64 icrdma_masks[IRDMA_MAX_MASKS] = {\n\tICRDMA_CCQPSTATUS_CCQP_DONE,\n\tICRDMA_CCQPSTATUS_CCQP_ERR,\n\tICRDMA_CQPSQ_STAG_PDID,\n\tICRDMA_CQPSQ_CQ_CEQID,\n\tICRDMA_CQPSQ_CQ_CQID,\n\tICRDMA_COMMIT_FPM_CQCNT,\n};\n\nstatic u64 icrdma_shifts[IRDMA_MAX_SHIFTS] = {\n\tICRDMA_CCQPSTATUS_CCQP_DONE_S,\n\tICRDMA_CCQPSTATUS_CCQP_ERR_S,\n\tICRDMA_CQPSQ_STAG_PDID_S,\n\tICRDMA_CQPSQ_CQ_CEQID_S,\n\tICRDMA_CQPSQ_CQ_CQID_S,\n\tICRDMA_COMMIT_FPM_CQCNT_S,\n};\n\n \nstatic void icrdma_ena_irq(struct irdma_sc_dev *dev, u32 idx)\n{\n\tu32 val;\n\tu32 interval = 0;\n\n\tif (dev->ceq_itr && dev->aeq->msix_idx != idx)\n\t\tinterval = dev->ceq_itr >> 1;  \n\tval = FIELD_PREP(IRDMA_GLINT_DYN_CTL_ITR_INDX, 0) |\n\t      FIELD_PREP(IRDMA_GLINT_DYN_CTL_INTERVAL, interval) |\n\t      FIELD_PREP(IRDMA_GLINT_DYN_CTL_INTENA, 1) |\n\t      FIELD_PREP(IRDMA_GLINT_DYN_CTL_CLEARPBA, 1);\n\n\tif (dev->hw_attrs.uk_attrs.hw_rev != IRDMA_GEN_1)\n\t\twritel(val, dev->hw_regs[IRDMA_GLINT_DYN_CTL] + idx);\n\telse\n\t\twritel(val, dev->hw_regs[IRDMA_GLINT_DYN_CTL] + (idx - 1));\n}\n\n \nstatic void icrdma_disable_irq(struct irdma_sc_dev *dev, u32 idx)\n{\n\tif (dev->hw_attrs.uk_attrs.hw_rev != IRDMA_GEN_1)\n\t\twritel(0, dev->hw_regs[IRDMA_GLINT_DYN_CTL] + idx);\n\telse\n\t\twritel(0, dev->hw_regs[IRDMA_GLINT_DYN_CTL] + (idx - 1));\n}\n\n \nstatic void icrdma_cfg_ceq(struct irdma_sc_dev *dev, u32 ceq_id, u32 idx,\n\t\t\t   bool enable)\n{\n\tu32 reg_val;\n\n\treg_val = FIELD_PREP(IRDMA_GLINT_CEQCTL_CAUSE_ENA, enable) |\n\t\t  FIELD_PREP(IRDMA_GLINT_CEQCTL_MSIX_INDX, idx) |\n\t\t  FIELD_PREP(IRDMA_GLINT_CEQCTL_ITR_INDX, 3);\n\n\twritel(reg_val, dev->hw_regs[IRDMA_GLINT_CEQCTL] + ceq_id);\n}\n\nstatic const struct irdma_irq_ops icrdma_irq_ops = {\n\t.irdma_cfg_aeq = irdma_cfg_aeq,\n\t.irdma_cfg_ceq = icrdma_cfg_ceq,\n\t.irdma_dis_irq = icrdma_disable_irq,\n\t.irdma_en_irq = icrdma_ena_irq,\n};\n\nstatic const struct irdma_hw_stat_map icrdma_hw_stat_map[] = {\n\t[IRDMA_HW_STAT_INDEX_RXVLANERR]\t=\t{   0, 32, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXOCTS] =\t{   8,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXPKTS] =\t{  16,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXDISCARD] =\t{  24, 32, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXTRUNC] =\t{  24,  0, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXFRAGS] =\t{  32,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXMCOCTS] =\t{  40,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXMCPKTS] =\t{  48,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXOCTS] =\t{  56,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXPKTS] =\t{  64,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXDISCARD] =\t{  72, 32, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXTRUNC] =\t{  72,  0, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXFRAGS] =\t{  80,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXMCOCTS] =\t{  88,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXMCPKTS] =\t{  96,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXOCTS] =\t{ 104,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXPKTS] =\t{ 112,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXFRAGS] =\t{ 120,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXMCOCTS] =\t{ 128,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXMCPKTS] =\t{ 136,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXOCTS] =\t{ 144,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXPKTS] =\t{ 152,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXFRAGS] =\t{ 160,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXMCOCTS] =\t{ 168,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXMCPKTS] =\t{ 176,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXNOROUTE] =\t{ 184, 32, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXNOROUTE] =\t{ 184,  0, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_TCPRXSEGS] =\t{ 192, 32, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_TCPRXOPTERR] =\t{ 200, 32, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_TCPRXPROTOERR] =\t{ 200,  0, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_TCPTXSEG] =\t{ 208,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_TCPRTXSEG] =\t{ 216, 32, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_UDPRXPKTS] =\t{ 224,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_UDPTXPKTS] =\t{ 232,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMARXWRS] =\t{ 240,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMARXRDS] =\t{ 248,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMARXSNDS] =\t{ 256,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMATXWRS] =\t{ 264,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMATXRDS] =\t{ 272,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMATXSNDS] =\t{ 280,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMAVBND] =\t{ 288,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMAVINV] =\t{ 296,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RXNPECNMARKEDPKTS] = { 304,  0, IRDMA_MAX_STATS_56 },\n\t[IRDMA_HW_STAT_INDEX_RXRPCNPIGNORED] =\t{ 312, 32, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_RXRPCNPHANDLED] =\t{ 312,  0, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_TXNPCNPSENT] =\t{ 320,  0, IRDMA_MAX_STATS_32 },\n};\n\nvoid icrdma_init_hw(struct irdma_sc_dev *dev)\n{\n\tint i;\n\tu8 __iomem *hw_addr;\n\n\tfor (i = 0; i < IRDMA_MAX_REGS; ++i) {\n\t\thw_addr = dev->hw->hw_addr;\n\n\t\tif (i == IRDMA_DB_ADDR_OFFSET)\n\t\t\thw_addr = NULL;\n\n\t\tdev->hw_regs[i] = (u32 __iomem *)(hw_addr + icrdma_regs[i]);\n\t}\n\tdev->hw_attrs.max_hw_vf_fpm_id = IRDMA_MAX_VF_FPM_ID;\n\tdev->hw_attrs.first_hw_vf_fpm_id = IRDMA_FIRST_VF_FPM_ID;\n\n\tfor (i = 0; i < IRDMA_MAX_SHIFTS; ++i)\n\t\tdev->hw_shifts[i] = icrdma_shifts[i];\n\n\tfor (i = 0; i < IRDMA_MAX_MASKS; ++i)\n\t\tdev->hw_masks[i] = icrdma_masks[i];\n\n\tdev->wqe_alloc_db = dev->hw_regs[IRDMA_WQEALLOC];\n\tdev->cq_arm_db = dev->hw_regs[IRDMA_CQARM];\n\tdev->aeq_alloc_db = dev->hw_regs[IRDMA_AEQALLOC];\n\tdev->cqp_db = dev->hw_regs[IRDMA_CQPDB];\n\tdev->cq_ack_db = dev->hw_regs[IRDMA_CQACK];\n\tdev->irq_ops = &icrdma_irq_ops;\n\tdev->hw_attrs.page_size_cap = SZ_4K | SZ_2M | SZ_1G;\n\tdev->hw_stats_map = icrdma_hw_stat_map;\n\tdev->hw_attrs.max_hw_ird = ICRDMA_MAX_IRD_SIZE;\n\tdev->hw_attrs.max_hw_ord = ICRDMA_MAX_ORD_SIZE;\n\tdev->hw_attrs.max_stat_inst = ICRDMA_MAX_STATS_COUNT;\n\tdev->hw_attrs.max_stat_idx = IRDMA_HW_STAT_INDEX_MAX_GEN_2;\n\n\tdev->hw_attrs.uk_attrs.min_hw_wq_size = ICRDMA_MIN_WQ_SIZE;\n\tdev->hw_attrs.uk_attrs.max_hw_sq_chunk = IRDMA_MAX_QUANTA_PER_WR;\n\tdev->hw_attrs.uk_attrs.feature_flags |= IRDMA_FEATURE_RTS_AE |\n\t\t\t\t\t\tIRDMA_FEATURE_CQ_RESIZE;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}