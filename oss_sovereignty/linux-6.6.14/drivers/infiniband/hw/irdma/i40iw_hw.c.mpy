{
  "module_name": "i40iw_hw.c",
  "hash_id": "642e69217b2217132398df5962e8a89b0bb52078e5ce7725a5bb51aebc512adf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/irdma/i40iw_hw.c",
  "human_readable_source": "\n \n#include \"osdep.h\"\n#include \"type.h\"\n#include \"i40iw_hw.h\"\n#include \"protos.h\"\n\nstatic u32 i40iw_regs[IRDMA_MAX_REGS] = {\n\tI40E_PFPE_CQPTAIL,\n\tI40E_PFPE_CQPDB,\n\tI40E_PFPE_CCQPSTATUS,\n\tI40E_PFPE_CCQPHIGH,\n\tI40E_PFPE_CCQPLOW,\n\tI40E_PFPE_CQARM,\n\tI40E_PFPE_CQACK,\n\tI40E_PFPE_AEQALLOC,\n\tI40E_PFPE_CQPERRCODES,\n\tI40E_PFPE_WQEALLOC,\n\tI40E_PFINT_DYN_CTLN(0),\n\tI40IW_DB_ADDR_OFFSET,\n\n\tI40E_GLPCI_LBARCTRL,\n\tI40E_GLPE_CPUSTATUS0,\n\tI40E_GLPE_CPUSTATUS1,\n\tI40E_GLPE_CPUSTATUS2,\n\tI40E_PFINT_AEQCTL,\n\tI40E_PFINT_CEQCTL(0),\n\tI40E_VSIQF_CTL(0),\n\tI40E_PFHMC_PDINV,\n\tI40E_GLHMC_VFPDINV(0),\n\tI40E_GLPE_CRITERR,\n\t0xffffffff       \n};\n\nstatic u32 i40iw_stat_offsets[] = {\n\tI40E_GLPES_PFIP4RXDISCARD(0),\n\tI40E_GLPES_PFIP4RXTRUNC(0),\n\tI40E_GLPES_PFIP4TXNOROUTE(0),\n\tI40E_GLPES_PFIP6RXDISCARD(0),\n\tI40E_GLPES_PFIP6RXTRUNC(0),\n\tI40E_GLPES_PFIP6TXNOROUTE(0),\n\tI40E_GLPES_PFTCPRTXSEG(0),\n\tI40E_GLPES_PFTCPRXOPTERR(0),\n\tI40E_GLPES_PFTCPRXPROTOERR(0),\n\tI40E_GLPES_PFRXVLANERR(0),\n\n\tI40E_GLPES_PFIP4RXOCTSLO(0),\n\tI40E_GLPES_PFIP4RXPKTSLO(0),\n\tI40E_GLPES_PFIP4RXFRAGSLO(0),\n\tI40E_GLPES_PFIP4RXMCPKTSLO(0),\n\tI40E_GLPES_PFIP4TXOCTSLO(0),\n\tI40E_GLPES_PFIP4TXPKTSLO(0),\n\tI40E_GLPES_PFIP4TXFRAGSLO(0),\n\tI40E_GLPES_PFIP4TXMCPKTSLO(0),\n\tI40E_GLPES_PFIP6RXOCTSLO(0),\n\tI40E_GLPES_PFIP6RXPKTSLO(0),\n\tI40E_GLPES_PFIP6RXFRAGSLO(0),\n\tI40E_GLPES_PFIP6RXMCPKTSLO(0),\n\tI40E_GLPES_PFIP6TXOCTSLO(0),\n\tI40E_GLPES_PFIP6TXPKTSLO(0),\n\tI40E_GLPES_PFIP6TXFRAGSLO(0),\n\tI40E_GLPES_PFIP6TXMCPKTSLO(0),\n\tI40E_GLPES_PFTCPRXSEGSLO(0),\n\tI40E_GLPES_PFTCPTXSEGLO(0),\n\tI40E_GLPES_PFRDMARXRDSLO(0),\n\tI40E_GLPES_PFRDMARXSNDSLO(0),\n\tI40E_GLPES_PFRDMARXWRSLO(0),\n\tI40E_GLPES_PFRDMATXRDSLO(0),\n\tI40E_GLPES_PFRDMATXSNDSLO(0),\n\tI40E_GLPES_PFRDMATXWRSLO(0),\n\tI40E_GLPES_PFRDMAVBNDLO(0),\n\tI40E_GLPES_PFRDMAVINVLO(0),\n\tI40E_GLPES_PFIP4RXMCOCTSLO(0),\n\tI40E_GLPES_PFIP4TXMCOCTSLO(0),\n\tI40E_GLPES_PFIP6RXMCOCTSLO(0),\n\tI40E_GLPES_PFIP6TXMCOCTSLO(0),\n\tI40E_GLPES_PFUDPRXPKTSLO(0),\n\tI40E_GLPES_PFUDPTXPKTSLO(0)\n};\n\nstatic u64 i40iw_masks[IRDMA_MAX_MASKS] = {\n\tI40E_PFPE_CCQPSTATUS_CCQP_DONE,\n\tI40E_PFPE_CCQPSTATUS_CCQP_ERR,\n\tI40E_CQPSQ_STAG_PDID,\n\tI40E_CQPSQ_CQ_CEQID,\n\tI40E_CQPSQ_CQ_CQID,\n\tI40E_COMMIT_FPM_CQCNT,\n};\n\nstatic u64 i40iw_shifts[IRDMA_MAX_SHIFTS] = {\n\tI40E_PFPE_CCQPSTATUS_CCQP_DONE_S,\n\tI40E_PFPE_CCQPSTATUS_CCQP_ERR_S,\n\tI40E_CQPSQ_STAG_PDID_S,\n\tI40E_CQPSQ_CQ_CEQID_S,\n\tI40E_CQPSQ_CQ_CQID_S,\n\tI40E_COMMIT_FPM_CQCNT_S,\n};\n\n \nstatic void i40iw_config_ceq(struct irdma_sc_dev *dev, u32 ceq_id, u32 idx,\n\t\t\t     bool enable)\n{\n\tu32 reg_val;\n\n\treg_val = FIELD_PREP(I40E_PFINT_LNKLSTN_FIRSTQ_INDX, ceq_id) |\n\t\t  FIELD_PREP(I40E_PFINT_LNKLSTN_FIRSTQ_TYPE, QUEUE_TYPE_CEQ);\n\twr32(dev->hw, I40E_PFINT_LNKLSTN(idx - 1), reg_val);\n\n\treg_val = FIELD_PREP(I40E_PFINT_DYN_CTLN_ITR_INDX, 0x3) |\n\t\t  FIELD_PREP(I40E_PFINT_DYN_CTLN_INTENA, 0x1);\n\twr32(dev->hw, I40E_PFINT_DYN_CTLN(idx - 1), reg_val);\n\n\treg_val = FIELD_PREP(IRDMA_GLINT_CEQCTL_CAUSE_ENA, enable) |\n\t\t  FIELD_PREP(IRDMA_GLINT_CEQCTL_MSIX_INDX, idx) |\n\t\t  FIELD_PREP(I40E_PFINT_CEQCTL_NEXTQ_INDX, NULL_QUEUE_INDEX) |\n\t\t  FIELD_PREP(IRDMA_GLINT_CEQCTL_ITR_INDX, 0x3);\n\n\twr32(dev->hw, i40iw_regs[IRDMA_GLINT_CEQCTL] + 4 * ceq_id, reg_val);\n}\n\n \nstatic void i40iw_ena_irq(struct irdma_sc_dev *dev, u32 idx)\n{\n\tu32 val;\n\n\tval = FIELD_PREP(IRDMA_GLINT_DYN_CTL_INTENA, 0x1) |\n\t      FIELD_PREP(IRDMA_GLINT_DYN_CTL_CLEARPBA, 0x1) |\n\t      FIELD_PREP(IRDMA_GLINT_DYN_CTL_ITR_INDX, 0x3);\n\twr32(dev->hw, i40iw_regs[IRDMA_GLINT_DYN_CTL] + 4 * (idx - 1), val);\n}\n\n \nstatic void i40iw_disable_irq(struct irdma_sc_dev *dev, u32 idx)\n{\n\twr32(dev->hw, i40iw_regs[IRDMA_GLINT_DYN_CTL] + 4 * (idx - 1), 0);\n}\n\nstatic const struct irdma_irq_ops i40iw_irq_ops = {\n\t.irdma_cfg_aeq = irdma_cfg_aeq,\n\t.irdma_cfg_ceq = i40iw_config_ceq,\n\t.irdma_dis_irq = i40iw_disable_irq,\n\t.irdma_en_irq = i40iw_ena_irq,\n};\n\nstatic const struct irdma_hw_stat_map i40iw_hw_stat_map[] = {\n\t[IRDMA_HW_STAT_INDEX_RXVLANERR]\t=\t{   0,  0, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXOCTS] =\t{   8,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXPKTS] =\t{  16,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXDISCARD] =\t{  24,  0, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXTRUNC] =\t{  32,  0, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXFRAGS] =      {  40,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXMCPKTS] =     {  48,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXOCTS] =       {  56,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXPKTS] =       {  64,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXDISCARD] =    {  72,  0, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXTRUNC] =      {  80,  0, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXFRAGS] =      {  88,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXMCPKTS] =     {  96,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXOCTS] =       { 104,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXPKTS] =       { 112,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXFRAGS] =      { 120,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXMCPKTS] =     { 128,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXOCTS] =       { 136,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXPKTS] =       { 144,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXFRAGS] =      { 152,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXMCPKTS] =     { 160,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXNOROUTE] =    { 168,  0, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXNOROUTE] =    { 176,  0, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_TCPRXSEGS] =       { 184,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_TCPRXOPTERR] =     { 192,  0, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_TCPRXPROTOERR] =   { 200,  0, IRDMA_MAX_STATS_24 },\n\t[IRDMA_HW_STAT_INDEX_TCPTXSEG] =        { 208,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_TCPRTXSEG] =       { 216,  0, IRDMA_MAX_STATS_32 },\n\t[IRDMA_HW_STAT_INDEX_RDMARXWRS] =       { 224,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMARXRDS] =       { 232,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMARXSNDS] =      { 240,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMATXWRS] =       { 248,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMATXRDS] =       { 256,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMATXSNDS] =      { 264,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMAVBND] =        { 272,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_RDMAVINV] =        { 280,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4RXMCOCTS] =     { 288,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP4TXMCOCTS] =     { 296,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6RXMCOCTS] =     { 304,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_IP6TXMCOCTS] =     { 312,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_UDPRXPKTS] =       { 320,  0, IRDMA_MAX_STATS_48 },\n\t[IRDMA_HW_STAT_INDEX_UDPTXPKTS] =       { 328,  0, IRDMA_MAX_STATS_48 },\n};\n\nvoid i40iw_init_hw(struct irdma_sc_dev *dev)\n{\n\tint i;\n\tu8 __iomem *hw_addr;\n\n\tfor (i = 0; i < IRDMA_MAX_REGS; ++i) {\n\t\thw_addr = dev->hw->hw_addr;\n\n\t\tif (i == IRDMA_DB_ADDR_OFFSET)\n\t\t\thw_addr = NULL;\n\n\t\tdev->hw_regs[i] = (u32 __iomem *)(i40iw_regs[i] + hw_addr);\n\t}\n\n\tfor (i = 0; i < IRDMA_HW_STAT_INDEX_MAX_GEN_1; ++i)\n\t\tdev->hw_stats_regs[i] = i40iw_stat_offsets[i];\n\n\tdev->hw_attrs.first_hw_vf_fpm_id = I40IW_FIRST_VF_FPM_ID;\n\tdev->hw_attrs.max_hw_vf_fpm_id = IRDMA_MAX_VF_FPM_ID;\n\n\tfor (i = 0; i < IRDMA_MAX_SHIFTS; ++i)\n\t\tdev->hw_shifts[i] = i40iw_shifts[i];\n\n\tfor (i = 0; i < IRDMA_MAX_MASKS; ++i)\n\t\tdev->hw_masks[i] = i40iw_masks[i];\n\n\tdev->wqe_alloc_db = dev->hw_regs[IRDMA_WQEALLOC];\n\tdev->cq_arm_db = dev->hw_regs[IRDMA_CQARM];\n\tdev->aeq_alloc_db = dev->hw_regs[IRDMA_AEQALLOC];\n\tdev->cqp_db = dev->hw_regs[IRDMA_CQPDB];\n\tdev->cq_ack_db = dev->hw_regs[IRDMA_CQACK];\n\tdev->ceq_itr_mask_db = NULL;\n\tdev->aeq_itr_mask_db = NULL;\n\tdev->irq_ops = &i40iw_irq_ops;\n\tdev->hw_stats_map = i40iw_hw_stat_map;\n\n\t \n\tdev->hw_attrs.uk_attrs.max_hw_wq_frags = I40IW_MAX_WQ_FRAGMENT_COUNT;\n\tdev->hw_attrs.uk_attrs.max_hw_read_sges = I40IW_MAX_SGE_RD;\n\tdev->hw_attrs.max_hw_device_pages = I40IW_MAX_PUSH_PAGE_COUNT;\n\tdev->hw_attrs.uk_attrs.max_hw_inline = I40IW_MAX_INLINE_DATA_SIZE;\n\tdev->hw_attrs.page_size_cap = SZ_4K | SZ_2M;\n\tdev->hw_attrs.max_hw_ird = I40IW_MAX_IRD_SIZE;\n\tdev->hw_attrs.max_hw_ord = I40IW_MAX_ORD_SIZE;\n\tdev->hw_attrs.max_hw_wqes = I40IW_MAX_WQ_ENTRIES;\n\tdev->hw_attrs.uk_attrs.max_hw_rq_quanta = I40IW_QP_SW_MAX_RQ_QUANTA;\n\tdev->hw_attrs.uk_attrs.max_hw_wq_quanta = I40IW_QP_SW_MAX_WQ_QUANTA;\n\tdev->hw_attrs.uk_attrs.max_hw_sq_chunk = I40IW_MAX_QUANTA_PER_WR;\n\tdev->hw_attrs.max_hw_pds = I40IW_MAX_PDS;\n\tdev->hw_attrs.max_stat_inst = I40IW_MAX_STATS_COUNT;\n\tdev->hw_attrs.max_stat_idx = IRDMA_HW_STAT_INDEX_MAX_GEN_1;\n\tdev->hw_attrs.max_hw_outbound_msg_size = I40IW_MAX_OUTBOUND_MSG_SIZE;\n\tdev->hw_attrs.max_hw_inbound_msg_size = I40IW_MAX_INBOUND_MSG_SIZE;\n\tdev->hw_attrs.uk_attrs.min_hw_wq_size = I40IW_MIN_WQ_SIZE;\n\tdev->hw_attrs.max_qp_wr = I40IW_MAX_QP_WRS;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}