{
  "module_name": "ctrl.c",
  "hash_id": "46db69e70931122a632a5ddb534b2bd2dc71e225c75398bd0f3c9908630615f1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/irdma/ctrl.c",
  "human_readable_source": "\n \n#include <linux/etherdevice.h>\n\n#include \"osdep.h\"\n#include \"hmc.h\"\n#include \"defs.h\"\n#include \"type.h\"\n#include \"ws.h\"\n#include \"protos.h\"\n\n \nstruct irdma_sc_qp *irdma_get_qp_from_list(struct list_head *head,\n\t\t\t\t\t   struct irdma_sc_qp *qp)\n{\n\tstruct list_head *lastentry;\n\tstruct list_head *entry = NULL;\n\n\tif (list_empty(head))\n\t\treturn NULL;\n\n\tif (!qp) {\n\t\tentry = head->next;\n\t} else {\n\t\tlastentry = &qp->list;\n\t\tentry = lastentry->next;\n\t\tif (entry == head)\n\t\t\treturn NULL;\n\t}\n\n\treturn container_of(entry, struct irdma_sc_qp, list);\n}\n\n \nvoid irdma_sc_suspend_resume_qps(struct irdma_sc_vsi *vsi, u8 op)\n{\n\tstruct irdma_sc_qp *qp = NULL;\n\tu8 i;\n\n\tfor (i = 0; i < IRDMA_MAX_USER_PRIORITY; i++) {\n\t\tmutex_lock(&vsi->qos[i].qos_mutex);\n\t\tqp = irdma_get_qp_from_list(&vsi->qos[i].qplist, qp);\n\t\twhile (qp) {\n\t\t\tif (op == IRDMA_OP_RESUME) {\n\t\t\t\tif (!qp->dev->ws_add(vsi, i)) {\n\t\t\t\t\tqp->qs_handle =\n\t\t\t\t\t\tvsi->qos[qp->user_pri].qs_handle;\n\t\t\t\t\tirdma_cqp_qp_suspend_resume(qp, op);\n\t\t\t\t} else {\n\t\t\t\t\tirdma_cqp_qp_suspend_resume(qp, op);\n\t\t\t\t\tirdma_modify_qp_to_err(qp);\n\t\t\t\t}\n\t\t\t} else if (op == IRDMA_OP_SUSPEND) {\n\t\t\t\t \n\t\t\t\tif (!irdma_cqp_qp_suspend_resume(qp, op))\n\t\t\t\t\tatomic_inc(&vsi->qp_suspend_reqs);\n\t\t\t}\n\t\t\tqp = irdma_get_qp_from_list(&vsi->qos[i].qplist, qp);\n\t\t}\n\t\tmutex_unlock(&vsi->qos[i].qos_mutex);\n\t}\n}\n\nstatic void irdma_set_qos_info(struct irdma_sc_vsi  *vsi,\n\t\t\t       struct irdma_l2params *l2p)\n{\n\tu8 i;\n\n\tvsi->qos_rel_bw = l2p->vsi_rel_bw;\n\tvsi->qos_prio_type = l2p->vsi_prio_type;\n\tvsi->dscp_mode = l2p->dscp_mode;\n\tif (l2p->dscp_mode) {\n\t\tmemcpy(vsi->dscp_map, l2p->dscp_map, sizeof(vsi->dscp_map));\n\t\tfor (i = 0; i < IRDMA_MAX_USER_PRIORITY; i++)\n\t\t\tl2p->up2tc[i] = i;\n\t}\n\tfor (i = 0; i < IRDMA_MAX_USER_PRIORITY; i++) {\n\t\tif (vsi->dev->hw_attrs.uk_attrs.hw_rev == IRDMA_GEN_1)\n\t\t\tvsi->qos[i].qs_handle = l2p->qs_handle_list[i];\n\t\tvsi->qos[i].traffic_class = l2p->up2tc[i];\n\t\tvsi->qos[i].rel_bw =\n\t\t\tl2p->tc_info[vsi->qos[i].traffic_class].rel_bw;\n\t\tvsi->qos[i].prio_type =\n\t\t\tl2p->tc_info[vsi->qos[i].traffic_class].prio_type;\n\t\tvsi->qos[i].valid = false;\n\t}\n}\n\n \nvoid irdma_change_l2params(struct irdma_sc_vsi *vsi,\n\t\t\t   struct irdma_l2params *l2params)\n{\n\tif (l2params->mtu_changed) {\n\t\tvsi->mtu = l2params->mtu;\n\t\tif (vsi->ieq)\n\t\t\tirdma_reinitialize_ieq(vsi);\n\t}\n\n\tif (!l2params->tc_changed)\n\t\treturn;\n\n\tvsi->tc_change_pending = false;\n\tirdma_set_qos_info(vsi, l2params);\n\tirdma_sc_suspend_resume_qps(vsi, IRDMA_OP_RESUME);\n}\n\n \nvoid irdma_qp_rem_qos(struct irdma_sc_qp *qp)\n{\n\tstruct irdma_sc_vsi *vsi = qp->vsi;\n\n\tibdev_dbg(to_ibdev(qp->dev),\n\t\t  \"DCB: DCB: Remove qp[%d] UP[%d] qset[%d] on_qoslist[%d]\\n\",\n\t\t  qp->qp_uk.qp_id, qp->user_pri, qp->qs_handle,\n\t\t  qp->on_qoslist);\n\tmutex_lock(&vsi->qos[qp->user_pri].qos_mutex);\n\tif (qp->on_qoslist) {\n\t\tqp->on_qoslist = false;\n\t\tlist_del(&qp->list);\n\t}\n\tmutex_unlock(&vsi->qos[qp->user_pri].qos_mutex);\n}\n\n \nvoid irdma_qp_add_qos(struct irdma_sc_qp *qp)\n{\n\tstruct irdma_sc_vsi *vsi = qp->vsi;\n\n\tibdev_dbg(to_ibdev(qp->dev),\n\t\t  \"DCB: DCB: Add qp[%d] UP[%d] qset[%d] on_qoslist[%d]\\n\",\n\t\t  qp->qp_uk.qp_id, qp->user_pri, qp->qs_handle,\n\t\t  qp->on_qoslist);\n\tmutex_lock(&vsi->qos[qp->user_pri].qos_mutex);\n\tif (!qp->on_qoslist) {\n\t\tlist_add(&qp->list, &vsi->qos[qp->user_pri].qplist);\n\t\tqp->on_qoslist = true;\n\t\tqp->qs_handle = vsi->qos[qp->user_pri].qs_handle;\n\t}\n\tmutex_unlock(&vsi->qos[qp->user_pri].qos_mutex);\n}\n\n \nvoid irdma_sc_pd_init(struct irdma_sc_dev *dev, struct irdma_sc_pd *pd, u32 pd_id,\n\t\t      int abi_ver)\n{\n\tpd->pd_id = pd_id;\n\tpd->abi_ver = abi_ver;\n\tpd->dev = dev;\n}\n\n \nstatic int irdma_sc_add_arp_cache_entry(struct irdma_sc_cqp *cqp,\n\t\t\t\t\tstruct irdma_add_arp_cache_entry_info *info,\n\t\t\t\t\tu64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\tset_64bit_val(wqe, 8, info->reach_max);\n\tset_64bit_val(wqe, 16, ether_addr_to_u64(info->mac_addr));\n\n\thdr = info->arp_index |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_MANAGE_ARP) |\n\t      FIELD_PREP(IRDMA_CQPSQ_MAT_PERMANENT, (info->permanent ? 1 : 0)) |\n\t      FIELD_PREP(IRDMA_CQPSQ_MAT_ENTRYVALID, 1) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: ARP_CACHE_ENTRY WQE\", DUMP_PREFIX_OFFSET,\n\t\t\t     16, 8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_del_arp_cache_entry(struct irdma_sc_cqp *cqp, u64 scratch,\n\t\t\t\t\tu16 arp_index, bool post_sq)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\thdr = arp_index |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_MANAGE_ARP) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: ARP_CACHE_DEL_ENTRY WQE\",\n\t\t\t     DUMP_PREFIX_OFFSET, 16, 8, wqe,\n\t\t\t     IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_manage_apbvt_entry(struct irdma_sc_cqp *cqp,\n\t\t\t\t       struct irdma_apbvt_info *info,\n\t\t\t\t       u64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16, info->port);\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_MANAGE_APBVT) |\n\t      FIELD_PREP(IRDMA_CQPSQ_MAPT_ADDPORT, info->add) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: MANAGE_APBVT WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int\nirdma_sc_manage_qhash_table_entry(struct irdma_sc_cqp *cqp,\n\t\t\t\t  struct irdma_qhash_table_info *info,\n\t\t\t\t  u64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tu64 qw1 = 0;\n\tu64 qw2 = 0;\n\tu64 temp;\n\tstruct irdma_sc_vsi *vsi = info->vsi;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 0, ether_addr_to_u64(info->mac_addr));\n\n\tqw1 = FIELD_PREP(IRDMA_CQPSQ_QHASH_QPN, info->qp_num) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_DEST_PORT, info->dest_port);\n\tif (info->ipv4_valid) {\n\t\tset_64bit_val(wqe, 48,\n\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR3, info->dest_ip[0]));\n\t} else {\n\t\tset_64bit_val(wqe, 56,\n\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR0, info->dest_ip[0]) |\n\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR1, info->dest_ip[1]));\n\n\t\tset_64bit_val(wqe, 48,\n\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR2, info->dest_ip[2]) |\n\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR3, info->dest_ip[3]));\n\t}\n\tqw2 = FIELD_PREP(IRDMA_CQPSQ_QHASH_QS_HANDLE,\n\t\t\t vsi->qos[info->user_pri].qs_handle);\n\tif (info->vlan_valid)\n\t\tqw2 |= FIELD_PREP(IRDMA_CQPSQ_QHASH_VLANID, info->vlan_id);\n\tset_64bit_val(wqe, 16, qw2);\n\tif (info->entry_type == IRDMA_QHASH_TYPE_TCP_ESTABLISHED) {\n\t\tqw1 |= FIELD_PREP(IRDMA_CQPSQ_QHASH_SRC_PORT, info->src_port);\n\t\tif (!info->ipv4_valid) {\n\t\t\tset_64bit_val(wqe, 40,\n\t\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR0, info->src_ip[0]) |\n\t\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR1, info->src_ip[1]));\n\t\t\tset_64bit_val(wqe, 32,\n\t\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR2, info->src_ip[2]) |\n\t\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR3, info->src_ip[3]));\n\t\t} else {\n\t\t\tset_64bit_val(wqe, 32,\n\t\t\t\t      FIELD_PREP(IRDMA_CQPSQ_QHASH_ADDR3, info->src_ip[0]));\n\t\t}\n\t}\n\n\tset_64bit_val(wqe, 8, qw1);\n\ttemp = FIELD_PREP(IRDMA_CQPSQ_QHASH_WQEVALID, cqp->polarity) |\n\t       FIELD_PREP(IRDMA_CQPSQ_QHASH_OPCODE,\n\t\t\t  IRDMA_CQP_OP_MANAGE_QUAD_HASH_TABLE_ENTRY) |\n\t       FIELD_PREP(IRDMA_CQPSQ_QHASH_MANAGE, info->manage) |\n\t       FIELD_PREP(IRDMA_CQPSQ_QHASH_IPV4VALID, info->ipv4_valid) |\n\t       FIELD_PREP(IRDMA_CQPSQ_QHASH_VLANVALID, info->vlan_valid) |\n\t       FIELD_PREP(IRDMA_CQPSQ_QHASH_ENTRYTYPE, info->entry_type);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, temp);\n\n\tprint_hex_dump_debug(\"WQE: MANAGE_QHASH WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nint irdma_sc_qp_init(struct irdma_sc_qp *qp, struct irdma_qp_init_info *info)\n{\n\tint ret_code;\n\tu32 pble_obj_cnt;\n\tu16 wqe_size;\n\n\tif (info->qp_uk_init_info.max_sq_frag_cnt >\n\t    info->pd->dev->hw_attrs.uk_attrs.max_hw_wq_frags ||\n\t    info->qp_uk_init_info.max_rq_frag_cnt >\n\t    info->pd->dev->hw_attrs.uk_attrs.max_hw_wq_frags)\n\t\treturn -EINVAL;\n\n\tqp->dev = info->pd->dev;\n\tqp->vsi = info->vsi;\n\tqp->ieq_qp = info->vsi->exception_lan_q;\n\tqp->sq_pa = info->sq_pa;\n\tqp->rq_pa = info->rq_pa;\n\tqp->hw_host_ctx_pa = info->host_ctx_pa;\n\tqp->q2_pa = info->q2_pa;\n\tqp->shadow_area_pa = info->shadow_area_pa;\n\tqp->q2_buf = info->q2;\n\tqp->pd = info->pd;\n\tqp->hw_host_ctx = info->host_ctx;\n\tinfo->qp_uk_init_info.wqe_alloc_db = qp->pd->dev->wqe_alloc_db;\n\tret_code = irdma_uk_qp_init(&qp->qp_uk, &info->qp_uk_init_info);\n\tif (ret_code)\n\t\treturn ret_code;\n\n\tqp->virtual_map = info->virtual_map;\n\tpble_obj_cnt = info->pd->dev->hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt;\n\n\tif ((info->virtual_map && info->sq_pa >= pble_obj_cnt) ||\n\t    (info->virtual_map && info->rq_pa >= pble_obj_cnt))\n\t\treturn -EINVAL;\n\n\tqp->llp_stream_handle = (void *)(-1);\n\tqp->hw_sq_size = irdma_get_encoded_wqe_size(qp->qp_uk.sq_ring.size,\n\t\t\t\t\t\t    IRDMA_QUEUE_TYPE_SQ_RQ);\n\tibdev_dbg(to_ibdev(qp->dev),\n\t\t  \"WQE: hw_sq_size[%04d] sq_ring.size[%04d]\\n\",\n\t\t  qp->hw_sq_size, qp->qp_uk.sq_ring.size);\n\tif (qp->qp_uk.uk_attrs->hw_rev == IRDMA_GEN_1 && qp->pd->abi_ver > 4)\n\t\twqe_size = IRDMA_WQE_SIZE_128;\n\telse\n\t\tret_code = irdma_fragcnt_to_wqesize_rq(qp->qp_uk.max_rq_frag_cnt,\n\t\t\t\t\t\t       &wqe_size);\n\tif (ret_code)\n\t\treturn ret_code;\n\n\tqp->hw_rq_size = irdma_get_encoded_wqe_size(qp->qp_uk.rq_size *\n\t\t\t\t(wqe_size / IRDMA_QP_WQE_MIN_SIZE), IRDMA_QUEUE_TYPE_SQ_RQ);\n\tibdev_dbg(to_ibdev(qp->dev),\n\t\t  \"WQE: hw_rq_size[%04d] qp_uk.rq_size[%04d] wqe_size[%04d]\\n\",\n\t\t  qp->hw_rq_size, qp->qp_uk.rq_size, wqe_size);\n\tqp->sq_tph_val = info->sq_tph_val;\n\tqp->rq_tph_val = info->rq_tph_val;\n\tqp->sq_tph_en = info->sq_tph_en;\n\tqp->rq_tph_en = info->rq_tph_en;\n\tqp->rcv_tph_en = info->rcv_tph_en;\n\tqp->xmit_tph_en = info->xmit_tph_en;\n\tqp->qp_uk.first_sq_wq = info->qp_uk_init_info.first_sq_wq;\n\tqp->qs_handle = qp->vsi->qos[qp->user_pri].qs_handle;\n\n\treturn 0;\n}\n\n \nint irdma_sc_qp_create(struct irdma_sc_qp *qp, struct irdma_create_qp_info *info,\n\t\t       u64 scratch, bool post_sq)\n{\n\tstruct irdma_sc_cqp *cqp;\n\t__le64 *wqe;\n\tu64 hdr;\n\n\tcqp = qp->dev->cqp;\n\tif (qp->qp_uk.qp_id < cqp->dev->hw_attrs.min_hw_qp_id ||\n\t    qp->qp_uk.qp_id >= cqp->dev->hmc_info->hmc_obj[IRDMA_HMC_IW_QP].max_cnt)\n\t\treturn -EINVAL;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16, qp->hw_host_ctx_pa);\n\tset_64bit_val(wqe, 40, qp->shadow_area_pa);\n\n\thdr = qp->qp_uk.qp_id |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_CREATE_QP) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_ORDVALID, (info->ord_valid ? 1 : 0)) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_TOECTXVALID, info->tcp_ctx_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_MACVALID, info->mac_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_QPTYPE, qp->qp_uk.qp_type) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_VQ, qp->virtual_map) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_FORCELOOPBACK, info->force_lpb) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_CQNUMVALID, info->cq_num_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_ARPTABIDXVALID,\n\t\t\t info->arp_cache_idx_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_NEXTIWSTATE, info->next_iwarp_state) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: QP_CREATE WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nint irdma_sc_qp_modify(struct irdma_sc_qp *qp, struct irdma_modify_qp_info *info,\n\t\t       u64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\tu64 hdr;\n\tu8 term_actions = 0;\n\tu8 term_len = 0;\n\n\tcqp = qp->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tif (info->next_iwarp_state == IRDMA_QP_STATE_TERMINATE) {\n\t\tif (info->dont_send_fin)\n\t\t\tterm_actions += IRDMAQP_TERM_SEND_TERM_ONLY;\n\t\tif (info->dont_send_term)\n\t\t\tterm_actions += IRDMAQP_TERM_SEND_FIN_ONLY;\n\t\tif (term_actions == IRDMAQP_TERM_SEND_TERM_AND_FIN ||\n\t\t    term_actions == IRDMAQP_TERM_SEND_TERM_ONLY)\n\t\t\tterm_len = info->termlen;\n\t}\n\n\tset_64bit_val(wqe, 8,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_QP_NEWMSS, info->new_mss) |\n\t\t      FIELD_PREP(IRDMA_CQPSQ_QP_TERMLEN, term_len));\n\tset_64bit_val(wqe, 16, qp->hw_host_ctx_pa);\n\tset_64bit_val(wqe, 40, qp->shadow_area_pa);\n\n\thdr = qp->qp_uk.qp_id |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_MODIFY_QP) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_ORDVALID, info->ord_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_TOECTXVALID, info->tcp_ctx_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_CACHEDVARVALID,\n\t\t\t info->cached_var_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_VQ, qp->virtual_map) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_FORCELOOPBACK, info->force_lpb) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_CQNUMVALID, info->cq_num_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_MACVALID, info->mac_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_QPTYPE, qp->qp_uk.qp_type) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_MSSCHANGE, info->mss_change) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_REMOVEHASHENTRY,\n\t\t\t info->remove_hash_idx) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_TERMACT, term_actions) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_RESETCON, info->reset_tcp_conn) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_ARPTABIDXVALID,\n\t\t\t info->arp_cache_idx_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_NEXTIWSTATE, info->next_iwarp_state) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: QP_MODIFY WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nint irdma_sc_qp_destroy(struct irdma_sc_qp *qp, u64 scratch,\n\t\t\tbool remove_hash_idx, bool ignore_mw_bnd, bool post_sq)\n{\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\tu64 hdr;\n\n\tcqp = qp->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16, qp->hw_host_ctx_pa);\n\tset_64bit_val(wqe, 40, qp->shadow_area_pa);\n\n\thdr = qp->qp_uk.qp_id |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_DESTROY_QP) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_QPTYPE, qp->qp_uk.qp_type) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_IGNOREMWBOUND, ignore_mw_bnd) |\n\t      FIELD_PREP(IRDMA_CQPSQ_QP_REMOVEHASHENTRY, remove_hash_idx) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: QP_DESTROY WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic u8 irdma_sc_get_encoded_ird_size(u16 ird_size)\n{\n\tswitch (ird_size ?\n\t\troundup_pow_of_two(2 * ird_size) : 4) {\n\tcase 256:\n\t\treturn IRDMA_IRD_HW_SIZE_256;\n\tcase 128:\n\t\treturn IRDMA_IRD_HW_SIZE_128;\n\tcase 64:\n\tcase 32:\n\t\treturn IRDMA_IRD_HW_SIZE_64;\n\tcase 16:\n\tcase 8:\n\t\treturn IRDMA_IRD_HW_SIZE_16;\n\tcase 4:\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn IRDMA_IRD_HW_SIZE_4;\n}\n\n \nvoid irdma_sc_qp_setctx_roce(struct irdma_sc_qp *qp, __le64 *qp_ctx,\n\t\t\t     struct irdma_qp_host_ctx_info *info)\n{\n\tstruct irdma_roce_offload_info *roce_info;\n\tstruct irdma_udp_offload_info *udp;\n\tu8 push_mode_en;\n\tu32 push_idx;\n\n\troce_info = info->roce_info;\n\tudp = info->udp_info;\n\tqp->user_pri = info->user_pri;\n\tif (qp->push_idx == IRDMA_INVALID_PUSH_PAGE_INDEX) {\n\t\tpush_mode_en = 0;\n\t\tpush_idx = 0;\n\t} else {\n\t\tpush_mode_en = 1;\n\t\tpush_idx = qp->push_idx;\n\t}\n\tset_64bit_val(qp_ctx, 0,\n\t\t      FIELD_PREP(IRDMAQPC_RQWQESIZE, qp->qp_uk.rq_wqe_size) |\n\t\t      FIELD_PREP(IRDMAQPC_RCVTPHEN, qp->rcv_tph_en) |\n\t\t      FIELD_PREP(IRDMAQPC_XMITTPHEN, qp->xmit_tph_en) |\n\t\t      FIELD_PREP(IRDMAQPC_RQTPHEN, qp->rq_tph_en) |\n\t\t      FIELD_PREP(IRDMAQPC_SQTPHEN, qp->sq_tph_en) |\n\t\t      FIELD_PREP(IRDMAQPC_PPIDX, push_idx) |\n\t\t      FIELD_PREP(IRDMAQPC_PMENA, push_mode_en) |\n\t\t      FIELD_PREP(IRDMAQPC_PDIDXHI, roce_info->pd_id >> 16) |\n\t\t      FIELD_PREP(IRDMAQPC_DC_TCP_EN, roce_info->dctcp_en) |\n\t\t      FIELD_PREP(IRDMAQPC_ERR_RQ_IDX_VALID, roce_info->err_rq_idx_valid) |\n\t\t      FIELD_PREP(IRDMAQPC_ISQP1, roce_info->is_qp1) |\n\t\t      FIELD_PREP(IRDMAQPC_ROCE_TVER, roce_info->roce_tver) |\n\t\t      FIELD_PREP(IRDMAQPC_IPV4, udp->ipv4) |\n\t\t      FIELD_PREP(IRDMAQPC_INSERTVLANTAG, udp->insert_vlan_tag));\n\tset_64bit_val(qp_ctx, 8, qp->sq_pa);\n\tset_64bit_val(qp_ctx, 16, qp->rq_pa);\n\tif ((roce_info->dcqcn_en || roce_info->dctcp_en) &&\n\t    !(udp->tos & 0x03))\n\t\tudp->tos |= ECN_CODE_PT_VAL;\n\tset_64bit_val(qp_ctx, 24,\n\t\t      FIELD_PREP(IRDMAQPC_RQSIZE, qp->hw_rq_size) |\n\t\t      FIELD_PREP(IRDMAQPC_SQSIZE, qp->hw_sq_size) |\n\t\t      FIELD_PREP(IRDMAQPC_TTL, udp->ttl) | FIELD_PREP(IRDMAQPC_TOS, udp->tos) |\n\t\t      FIELD_PREP(IRDMAQPC_SRCPORTNUM, udp->src_port) |\n\t\t      FIELD_PREP(IRDMAQPC_DESTPORTNUM, udp->dst_port));\n\tset_64bit_val(qp_ctx, 32,\n\t\t      FIELD_PREP(IRDMAQPC_DESTIPADDR2, udp->dest_ip_addr[2]) |\n\t\t      FIELD_PREP(IRDMAQPC_DESTIPADDR3, udp->dest_ip_addr[3]));\n\tset_64bit_val(qp_ctx, 40,\n\t\t      FIELD_PREP(IRDMAQPC_DESTIPADDR0, udp->dest_ip_addr[0]) |\n\t\t      FIELD_PREP(IRDMAQPC_DESTIPADDR1, udp->dest_ip_addr[1]));\n\tset_64bit_val(qp_ctx, 48,\n\t\t      FIELD_PREP(IRDMAQPC_SNDMSS, udp->snd_mss) |\n\t\t      FIELD_PREP(IRDMAQPC_VLANTAG, udp->vlan_tag) |\n\t\t      FIELD_PREP(IRDMAQPC_ARPIDX, udp->arp_idx));\n\tset_64bit_val(qp_ctx, 56,\n\t\t      FIELD_PREP(IRDMAQPC_PKEY, roce_info->p_key) |\n\t\t      FIELD_PREP(IRDMAQPC_PDIDX, roce_info->pd_id) |\n\t\t      FIELD_PREP(IRDMAQPC_ACKCREDITS, roce_info->ack_credits) |\n\t\t      FIELD_PREP(IRDMAQPC_FLOWLABEL, udp->flow_label));\n\tset_64bit_val(qp_ctx, 64,\n\t\t      FIELD_PREP(IRDMAQPC_QKEY, roce_info->qkey) |\n\t\t      FIELD_PREP(IRDMAQPC_DESTQP, roce_info->dest_qp));\n\tset_64bit_val(qp_ctx, 80,\n\t\t      FIELD_PREP(IRDMAQPC_PSNNXT, udp->psn_nxt) |\n\t\t      FIELD_PREP(IRDMAQPC_LSN, udp->lsn));\n\tset_64bit_val(qp_ctx, 88,\n\t\t      FIELD_PREP(IRDMAQPC_EPSN, udp->epsn));\n\tset_64bit_val(qp_ctx, 96,\n\t\t      FIELD_PREP(IRDMAQPC_PSNMAX, udp->psn_max) |\n\t\t      FIELD_PREP(IRDMAQPC_PSNUNA, udp->psn_una));\n\tset_64bit_val(qp_ctx, 112,\n\t\t      FIELD_PREP(IRDMAQPC_CWNDROCE, udp->cwnd));\n\tset_64bit_val(qp_ctx, 128,\n\t\t      FIELD_PREP(IRDMAQPC_ERR_RQ_IDX, roce_info->err_rq_idx) |\n\t\t      FIELD_PREP(IRDMAQPC_RNRNAK_THRESH, udp->rnr_nak_thresh) |\n\t\t      FIELD_PREP(IRDMAQPC_REXMIT_THRESH, udp->rexmit_thresh) |\n\t\t      FIELD_PREP(IRDMAQPC_RTOMIN, roce_info->rtomin));\n\tset_64bit_val(qp_ctx, 136,\n\t\t      FIELD_PREP(IRDMAQPC_TXCQNUM, info->send_cq_num) |\n\t\t      FIELD_PREP(IRDMAQPC_RXCQNUM, info->rcv_cq_num));\n\tset_64bit_val(qp_ctx, 144,\n\t\t      FIELD_PREP(IRDMAQPC_STAT_INDEX, info->stats_idx));\n\tset_64bit_val(qp_ctx, 152, ether_addr_to_u64(roce_info->mac_addr) << 16);\n\tset_64bit_val(qp_ctx, 160,\n\t\t      FIELD_PREP(IRDMAQPC_ORDSIZE, roce_info->ord_size) |\n\t\t      FIELD_PREP(IRDMAQPC_IRDSIZE, irdma_sc_get_encoded_ird_size(roce_info->ird_size)) |\n\t\t      FIELD_PREP(IRDMAQPC_WRRDRSPOK, roce_info->wr_rdresp_en) |\n\t\t      FIELD_PREP(IRDMAQPC_RDOK, roce_info->rd_en) |\n\t\t      FIELD_PREP(IRDMAQPC_USESTATSINSTANCE, info->stats_idx_valid) |\n\t\t      FIELD_PREP(IRDMAQPC_BINDEN, roce_info->bind_en) |\n\t\t      FIELD_PREP(IRDMAQPC_FASTREGEN, roce_info->fast_reg_en) |\n\t\t      FIELD_PREP(IRDMAQPC_DCQCNENABLE, roce_info->dcqcn_en) |\n\t\t      FIELD_PREP(IRDMAQPC_RCVNOICRC, roce_info->rcv_no_icrc) |\n\t\t      FIELD_PREP(IRDMAQPC_FW_CC_ENABLE, roce_info->fw_cc_enable) |\n\t\t      FIELD_PREP(IRDMAQPC_UDPRIVCQENABLE, roce_info->udprivcq_en) |\n\t\t      FIELD_PREP(IRDMAQPC_PRIVEN, roce_info->priv_mode_en) |\n\t\t      FIELD_PREP(IRDMAQPC_TIMELYENABLE, roce_info->timely_en));\n\tset_64bit_val(qp_ctx, 168,\n\t\t      FIELD_PREP(IRDMAQPC_QPCOMPCTX, info->qp_compl_ctx));\n\tset_64bit_val(qp_ctx, 176,\n\t\t      FIELD_PREP(IRDMAQPC_SQTPHVAL, qp->sq_tph_val) |\n\t\t      FIELD_PREP(IRDMAQPC_RQTPHVAL, qp->rq_tph_val) |\n\t\t      FIELD_PREP(IRDMAQPC_QSHANDLE, qp->qs_handle));\n\tset_64bit_val(qp_ctx, 184,\n\t\t      FIELD_PREP(IRDMAQPC_LOCAL_IPADDR3, udp->local_ipaddr[3]) |\n\t\t      FIELD_PREP(IRDMAQPC_LOCAL_IPADDR2, udp->local_ipaddr[2]));\n\tset_64bit_val(qp_ctx, 192,\n\t\t      FIELD_PREP(IRDMAQPC_LOCAL_IPADDR1, udp->local_ipaddr[1]) |\n\t\t      FIELD_PREP(IRDMAQPC_LOCAL_IPADDR0, udp->local_ipaddr[0]));\n\tset_64bit_val(qp_ctx, 200,\n\t\t      FIELD_PREP(IRDMAQPC_THIGH, roce_info->t_high) |\n\t\t      FIELD_PREP(IRDMAQPC_TLOW, roce_info->t_low));\n\tset_64bit_val(qp_ctx, 208,\n\t\t      FIELD_PREP(IRDMAQPC_REMENDPOINTIDX, info->rem_endpoint_idx));\n\n\tprint_hex_dump_debug(\"WQE: QP_HOST CTX WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, qp_ctx, IRDMA_QP_CTX_SIZE, false);\n}\n\n \nstatic int irdma_sc_alloc_local_mac_entry(struct irdma_sc_cqp *cqp, u64 scratch,\n\t\t\t\t\t  bool post_sq)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE,\n\t\t\t IRDMA_CQP_OP_ALLOCATE_LOC_MAC_TABLE_ENTRY) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: ALLOCATE_LOCAL_MAC WQE\",\n\t\t\t     DUMP_PREFIX_OFFSET, 16, 8, wqe,\n\t\t\t     IRDMA_CQP_WQE_SIZE * 8, false);\n\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\treturn 0;\n}\n\n \nstatic int irdma_sc_add_local_mac_entry(struct irdma_sc_cqp *cqp,\n\t\t\t\t\tstruct irdma_local_mac_entry_info *info,\n\t\t\t\t\tu64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tu64 header;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 32, ether_addr_to_u64(info->mac_addr));\n\n\theader = FIELD_PREP(IRDMA_CQPSQ_MLM_TABLEIDX, info->entry_idx) |\n\t\t FIELD_PREP(IRDMA_CQPSQ_OPCODE,\n\t\t\t    IRDMA_CQP_OP_MANAGE_LOC_MAC_TABLE) |\n\t\t FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, header);\n\n\tprint_hex_dump_debug(\"WQE: ADD_LOCAL_MAC WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\treturn 0;\n}\n\n \nstatic int irdma_sc_del_local_mac_entry(struct irdma_sc_cqp *cqp, u64 scratch,\n\t\t\t\t\tu16 entry_idx, u8 ignore_ref_count,\n\t\t\t\t\tbool post_sq)\n{\n\t__le64 *wqe;\n\tu64 header;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\theader = FIELD_PREP(IRDMA_CQPSQ_MLM_TABLEIDX, entry_idx) |\n\t\t FIELD_PREP(IRDMA_CQPSQ_OPCODE,\n\t\t\t    IRDMA_CQP_OP_MANAGE_LOC_MAC_TABLE) |\n\t\t FIELD_PREP(IRDMA_CQPSQ_MLM_FREEENTRY, 1) |\n\t\t FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity) |\n\t\t FIELD_PREP(IRDMA_CQPSQ_MLM_IGNORE_REF_CNT, ignore_ref_count);\n\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, header);\n\n\tprint_hex_dump_debug(\"WQE: DEL_LOCAL_MAC_IPADDR WQE\",\n\t\t\t     DUMP_PREFIX_OFFSET, 16, 8, wqe,\n\t\t\t     IRDMA_CQP_WQE_SIZE * 8, false);\n\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\treturn 0;\n}\n\n \nvoid irdma_sc_qp_setctx(struct irdma_sc_qp *qp, __le64 *qp_ctx,\n\t\t\tstruct irdma_qp_host_ctx_info *info)\n{\n\tstruct irdma_iwarp_offload_info *iw;\n\tstruct irdma_tcp_offload_info *tcp;\n\tstruct irdma_sc_dev *dev;\n\tu8 push_mode_en;\n\tu32 push_idx;\n\tu64 qw0, qw3, qw7 = 0, qw16 = 0;\n\tu64 mac = 0;\n\n\tiw = info->iwarp_info;\n\ttcp = info->tcp_info;\n\tdev = qp->dev;\n\tif (iw->rcv_mark_en) {\n\t\tqp->pfpdu.marker_len = 4;\n\t\tqp->pfpdu.rcv_start_seq = tcp->rcv_nxt;\n\t}\n\tqp->user_pri = info->user_pri;\n\tif (qp->push_idx == IRDMA_INVALID_PUSH_PAGE_INDEX) {\n\t\tpush_mode_en = 0;\n\t\tpush_idx = 0;\n\t} else {\n\t\tpush_mode_en = 1;\n\t\tpush_idx = qp->push_idx;\n\t}\n\tqw0 = FIELD_PREP(IRDMAQPC_RQWQESIZE, qp->qp_uk.rq_wqe_size) |\n\t      FIELD_PREP(IRDMAQPC_RCVTPHEN, qp->rcv_tph_en) |\n\t      FIELD_PREP(IRDMAQPC_XMITTPHEN, qp->xmit_tph_en) |\n\t      FIELD_PREP(IRDMAQPC_RQTPHEN, qp->rq_tph_en) |\n\t      FIELD_PREP(IRDMAQPC_SQTPHEN, qp->sq_tph_en) |\n\t      FIELD_PREP(IRDMAQPC_PPIDX, push_idx) |\n\t      FIELD_PREP(IRDMAQPC_PMENA, push_mode_en);\n\n\tset_64bit_val(qp_ctx, 8, qp->sq_pa);\n\tset_64bit_val(qp_ctx, 16, qp->rq_pa);\n\n\tqw3 = FIELD_PREP(IRDMAQPC_RQSIZE, qp->hw_rq_size) |\n\t      FIELD_PREP(IRDMAQPC_SQSIZE, qp->hw_sq_size);\n\tif (dev->hw_attrs.uk_attrs.hw_rev == IRDMA_GEN_1)\n\t\tqw3 |= FIELD_PREP(IRDMAQPC_GEN1_SRCMACADDRIDX,\n\t\t\t\t  qp->src_mac_addr_idx);\n\tset_64bit_val(qp_ctx, 136,\n\t\t      FIELD_PREP(IRDMAQPC_TXCQNUM, info->send_cq_num) |\n\t\t      FIELD_PREP(IRDMAQPC_RXCQNUM, info->rcv_cq_num));\n\tset_64bit_val(qp_ctx, 168,\n\t\t      FIELD_PREP(IRDMAQPC_QPCOMPCTX, info->qp_compl_ctx));\n\tset_64bit_val(qp_ctx, 176,\n\t\t      FIELD_PREP(IRDMAQPC_SQTPHVAL, qp->sq_tph_val) |\n\t\t      FIELD_PREP(IRDMAQPC_RQTPHVAL, qp->rq_tph_val) |\n\t\t      FIELD_PREP(IRDMAQPC_QSHANDLE, qp->qs_handle) |\n\t\t      FIELD_PREP(IRDMAQPC_EXCEPTION_LAN_QUEUE, qp->ieq_qp));\n\tif (info->iwarp_info_valid) {\n\t\tqw0 |= FIELD_PREP(IRDMAQPC_DDP_VER, iw->ddp_ver) |\n\t\t       FIELD_PREP(IRDMAQPC_RDMAP_VER, iw->rdmap_ver) |\n\t\t       FIELD_PREP(IRDMAQPC_DC_TCP_EN, iw->dctcp_en) |\n\t\t       FIELD_PREP(IRDMAQPC_ECN_EN, iw->ecn_en) |\n\t\t       FIELD_PREP(IRDMAQPC_IBRDENABLE, iw->ib_rd_en) |\n\t\t       FIELD_PREP(IRDMAQPC_PDIDXHI, iw->pd_id >> 16) |\n\t\t       FIELD_PREP(IRDMAQPC_ERR_RQ_IDX_VALID,\n\t\t\t\t  iw->err_rq_idx_valid);\n\t\tqw7 |= FIELD_PREP(IRDMAQPC_PDIDX, iw->pd_id);\n\t\tqw16 |= FIELD_PREP(IRDMAQPC_ERR_RQ_IDX, iw->err_rq_idx) |\n\t\t\tFIELD_PREP(IRDMAQPC_RTOMIN, iw->rtomin);\n\t\tset_64bit_val(qp_ctx, 144,\n\t\t\t      FIELD_PREP(IRDMAQPC_Q2ADDR, qp->q2_pa >> 8) |\n\t\t\t      FIELD_PREP(IRDMAQPC_STAT_INDEX, info->stats_idx));\n\n\t\tif (dev->hw_attrs.uk_attrs.hw_rev >= IRDMA_GEN_2)\n\t\t\tmac = ether_addr_to_u64(iw->mac_addr);\n\n\t\tset_64bit_val(qp_ctx, 152,\n\t\t\t      mac << 16 | FIELD_PREP(IRDMAQPC_LASTBYTESENT, iw->last_byte_sent));\n\t\tset_64bit_val(qp_ctx, 160,\n\t\t\t      FIELD_PREP(IRDMAQPC_ORDSIZE, iw->ord_size) |\n\t\t\t      FIELD_PREP(IRDMAQPC_IRDSIZE, irdma_sc_get_encoded_ird_size(iw->ird_size)) |\n\t\t\t      FIELD_PREP(IRDMAQPC_WRRDRSPOK, iw->wr_rdresp_en) |\n\t\t\t      FIELD_PREP(IRDMAQPC_RDOK, iw->rd_en) |\n\t\t\t      FIELD_PREP(IRDMAQPC_SNDMARKERS, iw->snd_mark_en) |\n\t\t\t      FIELD_PREP(IRDMAQPC_BINDEN, iw->bind_en) |\n\t\t\t      FIELD_PREP(IRDMAQPC_FASTREGEN, iw->fast_reg_en) |\n\t\t\t      FIELD_PREP(IRDMAQPC_PRIVEN, iw->priv_mode_en) |\n\t\t\t      FIELD_PREP(IRDMAQPC_USESTATSINSTANCE, info->stats_idx_valid) |\n\t\t\t      FIELD_PREP(IRDMAQPC_IWARPMODE, 1) |\n\t\t\t      FIELD_PREP(IRDMAQPC_RCVMARKERS, iw->rcv_mark_en) |\n\t\t\t      FIELD_PREP(IRDMAQPC_ALIGNHDRS, iw->align_hdrs) |\n\t\t\t      FIELD_PREP(IRDMAQPC_RCVNOMPACRC, iw->rcv_no_mpa_crc) |\n\t\t\t      FIELD_PREP(IRDMAQPC_RCVMARKOFFSET, iw->rcv_mark_offset || !tcp ? iw->rcv_mark_offset : tcp->rcv_nxt) |\n\t\t\t      FIELD_PREP(IRDMAQPC_SNDMARKOFFSET, iw->snd_mark_offset || !tcp ? iw->snd_mark_offset : tcp->snd_nxt) |\n\t\t\t      FIELD_PREP(IRDMAQPC_TIMELYENABLE, iw->timely_en));\n\t}\n\tif (info->tcp_info_valid) {\n\t\tqw0 |= FIELD_PREP(IRDMAQPC_IPV4, tcp->ipv4) |\n\t\t       FIELD_PREP(IRDMAQPC_NONAGLE, tcp->no_nagle) |\n\t\t       FIELD_PREP(IRDMAQPC_INSERTVLANTAG,\n\t\t\t\t  tcp->insert_vlan_tag) |\n\t\t       FIELD_PREP(IRDMAQPC_TIMESTAMP, tcp->time_stamp) |\n\t\t       FIELD_PREP(IRDMAQPC_LIMIT, tcp->cwnd_inc_limit) |\n\t\t       FIELD_PREP(IRDMAQPC_DROPOOOSEG, tcp->drop_ooo_seg) |\n\t\t       FIELD_PREP(IRDMAQPC_DUPACK_THRESH, tcp->dup_ack_thresh);\n\n\t\tif ((iw->ecn_en || iw->dctcp_en) && !(tcp->tos & 0x03))\n\t\t\ttcp->tos |= ECN_CODE_PT_VAL;\n\n\t\tqw3 |= FIELD_PREP(IRDMAQPC_TTL, tcp->ttl) |\n\t\t       FIELD_PREP(IRDMAQPC_AVOIDSTRETCHACK, tcp->avoid_stretch_ack) |\n\t\t       FIELD_PREP(IRDMAQPC_TOS, tcp->tos) |\n\t\t       FIELD_PREP(IRDMAQPC_SRCPORTNUM, tcp->src_port) |\n\t\t       FIELD_PREP(IRDMAQPC_DESTPORTNUM, tcp->dst_port);\n\t\tif (dev->hw_attrs.uk_attrs.hw_rev == IRDMA_GEN_1) {\n\t\t\tqw3 |= FIELD_PREP(IRDMAQPC_GEN1_SRCMACADDRIDX, tcp->src_mac_addr_idx);\n\n\t\t\tqp->src_mac_addr_idx = tcp->src_mac_addr_idx;\n\t\t}\n\t\tset_64bit_val(qp_ctx, 32,\n\t\t\t      FIELD_PREP(IRDMAQPC_DESTIPADDR2, tcp->dest_ip_addr[2]) |\n\t\t\t      FIELD_PREP(IRDMAQPC_DESTIPADDR3, tcp->dest_ip_addr[3]));\n\t\tset_64bit_val(qp_ctx, 40,\n\t\t\t      FIELD_PREP(IRDMAQPC_DESTIPADDR0, tcp->dest_ip_addr[0]) |\n\t\t\t      FIELD_PREP(IRDMAQPC_DESTIPADDR1, tcp->dest_ip_addr[1]));\n\t\tset_64bit_val(qp_ctx, 48,\n\t\t\t      FIELD_PREP(IRDMAQPC_SNDMSS, tcp->snd_mss) |\n\t\t\t      FIELD_PREP(IRDMAQPC_SYN_RST_HANDLING, tcp->syn_rst_handling) |\n\t\t\t      FIELD_PREP(IRDMAQPC_VLANTAG, tcp->vlan_tag) |\n\t\t\t      FIELD_PREP(IRDMAQPC_ARPIDX, tcp->arp_idx));\n\t\tqw7 |= FIELD_PREP(IRDMAQPC_FLOWLABEL, tcp->flow_label) |\n\t\t       FIELD_PREP(IRDMAQPC_WSCALE, tcp->wscale) |\n\t\t       FIELD_PREP(IRDMAQPC_IGNORE_TCP_OPT,\n\t\t\t\t  tcp->ignore_tcp_opt) |\n\t\t       FIELD_PREP(IRDMAQPC_IGNORE_TCP_UNS_OPT,\n\t\t\t\t  tcp->ignore_tcp_uns_opt) |\n\t\t       FIELD_PREP(IRDMAQPC_TCPSTATE, tcp->tcp_state) |\n\t\t       FIELD_PREP(IRDMAQPC_RCVSCALE, tcp->rcv_wscale) |\n\t\t       FIELD_PREP(IRDMAQPC_SNDSCALE, tcp->snd_wscale);\n\t\tset_64bit_val(qp_ctx, 72,\n\t\t\t      FIELD_PREP(IRDMAQPC_TIMESTAMP_RECENT, tcp->time_stamp_recent) |\n\t\t\t      FIELD_PREP(IRDMAQPC_TIMESTAMP_AGE, tcp->time_stamp_age));\n\t\tset_64bit_val(qp_ctx, 80,\n\t\t\t      FIELD_PREP(IRDMAQPC_SNDNXT, tcp->snd_nxt) |\n\t\t\t      FIELD_PREP(IRDMAQPC_SNDWND, tcp->snd_wnd));\n\t\tset_64bit_val(qp_ctx, 88,\n\t\t\t      FIELD_PREP(IRDMAQPC_RCVNXT, tcp->rcv_nxt) |\n\t\t\t      FIELD_PREP(IRDMAQPC_RCVWND, tcp->rcv_wnd));\n\t\tset_64bit_val(qp_ctx, 96,\n\t\t\t      FIELD_PREP(IRDMAQPC_SNDMAX, tcp->snd_max) |\n\t\t\t      FIELD_PREP(IRDMAQPC_SNDUNA, tcp->snd_una));\n\t\tset_64bit_val(qp_ctx, 104,\n\t\t\t      FIELD_PREP(IRDMAQPC_SRTT, tcp->srtt) |\n\t\t\t      FIELD_PREP(IRDMAQPC_RTTVAR, tcp->rtt_var));\n\t\tset_64bit_val(qp_ctx, 112,\n\t\t\t      FIELD_PREP(IRDMAQPC_SSTHRESH, tcp->ss_thresh) |\n\t\t\t      FIELD_PREP(IRDMAQPC_CWND, tcp->cwnd));\n\t\tset_64bit_val(qp_ctx, 120,\n\t\t\t      FIELD_PREP(IRDMAQPC_SNDWL1, tcp->snd_wl1) |\n\t\t\t      FIELD_PREP(IRDMAQPC_SNDWL2, tcp->snd_wl2));\n\t\tqw16 |= FIELD_PREP(IRDMAQPC_MAXSNDWND, tcp->max_snd_window) |\n\t\t\tFIELD_PREP(IRDMAQPC_REXMIT_THRESH, tcp->rexmit_thresh);\n\t\tset_64bit_val(qp_ctx, 184,\n\t\t\t      FIELD_PREP(IRDMAQPC_LOCAL_IPADDR3, tcp->local_ipaddr[3]) |\n\t\t\t      FIELD_PREP(IRDMAQPC_LOCAL_IPADDR2, tcp->local_ipaddr[2]));\n\t\tset_64bit_val(qp_ctx, 192,\n\t\t\t      FIELD_PREP(IRDMAQPC_LOCAL_IPADDR1, tcp->local_ipaddr[1]) |\n\t\t\t      FIELD_PREP(IRDMAQPC_LOCAL_IPADDR0, tcp->local_ipaddr[0]));\n\t\tset_64bit_val(qp_ctx, 200,\n\t\t\t      FIELD_PREP(IRDMAQPC_THIGH, iw->t_high) |\n\t\t\t      FIELD_PREP(IRDMAQPC_TLOW, iw->t_low));\n\t\tset_64bit_val(qp_ctx, 208,\n\t\t\t      FIELD_PREP(IRDMAQPC_REMENDPOINTIDX, info->rem_endpoint_idx));\n\t}\n\n\tset_64bit_val(qp_ctx, 0, qw0);\n\tset_64bit_val(qp_ctx, 24, qw3);\n\tset_64bit_val(qp_ctx, 56, qw7);\n\tset_64bit_val(qp_ctx, 128, qw16);\n\n\tprint_hex_dump_debug(\"WQE: QP_HOST CTX\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     qp_ctx, IRDMA_QP_CTX_SIZE, false);\n}\n\n \nstatic int irdma_sc_alloc_stag(struct irdma_sc_dev *dev,\n\t\t\t       struct irdma_allocate_stag_info *info,\n\t\t\t       u64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\tu64 hdr;\n\tenum irdma_page_size page_size;\n\n\tif (!info->total_len && !info->all_memory)\n\t\treturn -EINVAL;\n\n\tif (info->page_size == 0x40000000)\n\t\tpage_size = IRDMA_PAGE_SIZE_1G;\n\telse if (info->page_size == 0x200000)\n\t\tpage_size = IRDMA_PAGE_SIZE_2M;\n\telse\n\t\tpage_size = IRDMA_PAGE_SIZE_4K;\n\n\tcqp = dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 8,\n\t\t      FLD_LS_64(dev, info->pd_id, IRDMA_CQPSQ_STAG_PDID) |\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_STAGLEN, info->total_len));\n\tset_64bit_val(wqe, 16,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_IDX, info->stag_idx));\n\tset_64bit_val(wqe, 40,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_HMCFNIDX, info->hmc_fcn_index));\n\n\tif (info->chunk_size)\n\t\tset_64bit_val(wqe, 48,\n\t\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_FIRSTPMPBLIDX, info->first_pm_pbl_idx));\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_ALLOC_STAG) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_MR, 1) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_ARIGHTS, info->access_rights) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_LPBLSIZE, info->chunk_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_HPAGESIZE, page_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_REMACCENABLED, info->remote_access) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_USEHMCFNIDX, info->use_hmc_fcn_index) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_USEPFRID, info->use_pf_rid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: ALLOC_STAG WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_mr_reg_non_shared(struct irdma_sc_dev *dev,\n\t\t\t\t      struct irdma_reg_ns_stag_info *info,\n\t\t\t\t      u64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tu64 fbo;\n\tstruct irdma_sc_cqp *cqp;\n\tu64 hdr;\n\tu32 pble_obj_cnt;\n\tbool remote_access;\n\tu8 addr_type;\n\tenum irdma_page_size page_size;\n\n\tif (!info->total_len && !info->all_memory)\n\t\treturn -EINVAL;\n\n\tif (info->page_size == 0x40000000)\n\t\tpage_size = IRDMA_PAGE_SIZE_1G;\n\telse if (info->page_size == 0x200000)\n\t\tpage_size = IRDMA_PAGE_SIZE_2M;\n\telse if (info->page_size == 0x1000)\n\t\tpage_size = IRDMA_PAGE_SIZE_4K;\n\telse\n\t\treturn -EINVAL;\n\n\tif (info->access_rights & (IRDMA_ACCESS_FLAGS_REMOTEREAD_ONLY |\n\t\t\t\t   IRDMA_ACCESS_FLAGS_REMOTEWRITE_ONLY))\n\t\tremote_access = true;\n\telse\n\t\tremote_access = false;\n\n\tpble_obj_cnt = dev->hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt;\n\tif (info->chunk_size && info->first_pm_pbl_index >= pble_obj_cnt)\n\t\treturn -EINVAL;\n\n\tcqp = dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\tfbo = info->va & (info->page_size - 1);\n\n\tset_64bit_val(wqe, 0,\n\t\t      (info->addr_type == IRDMA_ADDR_TYPE_VA_BASED ?\n\t\t      info->va : fbo));\n\tset_64bit_val(wqe, 8,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_STAGLEN, info->total_len) |\n\t\t      FLD_LS_64(dev, info->pd_id, IRDMA_CQPSQ_STAG_PDID));\n\tset_64bit_val(wqe, 16,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_KEY, info->stag_key) |\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_IDX, info->stag_idx));\n\tif (!info->chunk_size) {\n\t\tset_64bit_val(wqe, 32, info->reg_addr_pa);\n\t\tset_64bit_val(wqe, 48, 0);\n\t} else {\n\t\tset_64bit_val(wqe, 32, 0);\n\t\tset_64bit_val(wqe, 48,\n\t\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_FIRSTPMPBLIDX, info->first_pm_pbl_index));\n\t}\n\tset_64bit_val(wqe, 40, info->hmc_fcn_index);\n\tset_64bit_val(wqe, 56, 0);\n\n\taddr_type = (info->addr_type == IRDMA_ADDR_TYPE_VA_BASED) ? 1 : 0;\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_REG_MR) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_MR, 1) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_LPBLSIZE, info->chunk_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_HPAGESIZE, page_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_ARIGHTS, info->access_rights) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_REMACCENABLED, remote_access) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_VABASEDTO, addr_type) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_USEHMCFNIDX, info->use_hmc_fcn_index) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_USEPFRID, info->use_pf_rid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: MR_REG_NS WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_dealloc_stag(struct irdma_sc_dev *dev,\n\t\t\t\t struct irdma_dealloc_stag_info *info,\n\t\t\t\t u64 scratch, bool post_sq)\n{\n\tu64 hdr;\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\n\tcqp = dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 8,\n\t\t      FLD_LS_64(dev, info->pd_id, IRDMA_CQPSQ_STAG_PDID));\n\tset_64bit_val(wqe, 16,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_IDX, info->stag_idx));\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_DEALLOC_STAG) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_MR, info->mr) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: DEALLOC_STAG WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_mw_alloc(struct irdma_sc_dev *dev,\n\t\t\t     struct irdma_mw_alloc_info *info, u64 scratch,\n\t\t\t     bool post_sq)\n{\n\tu64 hdr;\n\tstruct irdma_sc_cqp *cqp;\n\t__le64 *wqe;\n\n\tcqp = dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 8,\n\t\t      FLD_LS_64(dev, info->pd_id, IRDMA_CQPSQ_STAG_PDID));\n\tset_64bit_val(wqe, 16,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STAG_IDX, info->mw_stag_index));\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_ALLOC_STAG) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_MWTYPE, info->mw_wide) |\n\t      FIELD_PREP(IRDMA_CQPSQ_STAG_MW1_BIND_DONT_VLDT_KEY,\n\t\t\t info->mw1_bind_dont_vldt_key) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: MW_ALLOC WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nint irdma_sc_mr_fast_register(struct irdma_sc_qp *qp,\n\t\t\t      struct irdma_fast_reg_stag_info *info,\n\t\t\t      bool post_sq)\n{\n\tu64 temp, hdr;\n\t__le64 *wqe;\n\tu32 wqe_idx;\n\tenum irdma_page_size page_size;\n\tstruct irdma_post_sq_info sq_info = {};\n\n\tif (info->page_size == 0x40000000)\n\t\tpage_size = IRDMA_PAGE_SIZE_1G;\n\telse if (info->page_size == 0x200000)\n\t\tpage_size = IRDMA_PAGE_SIZE_2M;\n\telse\n\t\tpage_size = IRDMA_PAGE_SIZE_4K;\n\n\tsq_info.wr_id = info->wr_id;\n\tsq_info.signaled = info->signaled;\n\n\twqe = irdma_qp_get_next_send_wqe(&qp->qp_uk, &wqe_idx,\n\t\t\t\t\t IRDMA_QP_WQE_MIN_QUANTA, 0, &sq_info);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tirdma_clr_wqes(&qp->qp_uk, wqe_idx);\n\n\tibdev_dbg(to_ibdev(qp->dev),\n\t\t  \"MR: wr_id[%llxh] wqe_idx[%04d] location[%p]\\n\",\n\t\t  info->wr_id, wqe_idx,\n\t\t  &qp->qp_uk.sq_wrtrk_array[wqe_idx].wrid);\n\n\ttemp = (info->addr_type == IRDMA_ADDR_TYPE_VA_BASED) ?\n\t\t(uintptr_t)info->va : info->fbo;\n\tset_64bit_val(wqe, 0, temp);\n\n\ttemp = FIELD_GET(IRDMAQPSQ_FIRSTPMPBLIDXHI,\n\t\t\t info->first_pm_pbl_index >> 16);\n\tset_64bit_val(wqe, 8,\n\t\t      FIELD_PREP(IRDMAQPSQ_FIRSTPMPBLIDXHI, temp) |\n\t\t      FIELD_PREP(IRDMAQPSQ_PBLADDR >> IRDMA_HW_PAGE_SHIFT, info->reg_addr_pa));\n\tset_64bit_val(wqe, 16,\n\t\t      info->total_len |\n\t\t      FIELD_PREP(IRDMAQPSQ_FIRSTPMPBLIDXLO, info->first_pm_pbl_index));\n\n\thdr = FIELD_PREP(IRDMAQPSQ_STAGKEY, info->stag_key) |\n\t      FIELD_PREP(IRDMAQPSQ_STAGINDEX, info->stag_idx) |\n\t      FIELD_PREP(IRDMAQPSQ_OPCODE, IRDMAQP_OP_FAST_REGISTER) |\n\t      FIELD_PREP(IRDMAQPSQ_LPBLSIZE, info->chunk_size) |\n\t      FIELD_PREP(IRDMAQPSQ_HPAGESIZE, page_size) |\n\t      FIELD_PREP(IRDMAQPSQ_STAGRIGHTS, info->access_rights) |\n\t      FIELD_PREP(IRDMAQPSQ_VABASEDTO, info->addr_type) |\n\t      FIELD_PREP(IRDMAQPSQ_READFENCE, info->read_fence) |\n\t      FIELD_PREP(IRDMAQPSQ_LOCALFENCE, info->local_fence) |\n\t      FIELD_PREP(IRDMAQPSQ_SIGCOMPL, info->signaled) |\n\t      FIELD_PREP(IRDMAQPSQ_VALID, qp->qp_uk.swqe_polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: FAST_REG WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_QP_WQE_MIN_SIZE, false);\n\n\tif (post_sq)\n\t\tirdma_uk_qp_post_wr(&qp->qp_uk);\n\n\treturn 0;\n}\n\n \nstatic void irdma_sc_gen_rts_ae(struct irdma_sc_qp *qp)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\tstruct irdma_qp_uk *qp_uk;\n\n\tqp_uk = &qp->qp_uk;\n\n\twqe = qp_uk->sq_base[1].elem;\n\n\thdr = FIELD_PREP(IRDMAQPSQ_OPCODE, IRDMAQP_OP_NOP) |\n\t      FIELD_PREP(IRDMAQPSQ_LOCALFENCE, 1) |\n\t      FIELD_PREP(IRDMAQPSQ_VALID, qp->qp_uk.swqe_polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\tprint_hex_dump_debug(\"QP: NOP W/LOCAL FENCE WQE\", DUMP_PREFIX_OFFSET,\n\t\t\t     16, 8, wqe, IRDMA_QP_WQE_MIN_SIZE, false);\n\n\twqe = qp_uk->sq_base[2].elem;\n\thdr = FIELD_PREP(IRDMAQPSQ_OPCODE, IRDMAQP_OP_GEN_RTS_AE) |\n\t      FIELD_PREP(IRDMAQPSQ_VALID, qp->qp_uk.swqe_polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\tprint_hex_dump_debug(\"QP: CONN EST WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_QP_WQE_MIN_SIZE, false);\n}\n\n \nvoid irdma_sc_send_lsmm(struct irdma_sc_qp *qp, void *lsmm_buf, u32 size,\n\t\t\tirdma_stag stag)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\tstruct irdma_qp_uk *qp_uk;\n\n\tqp_uk = &qp->qp_uk;\n\twqe = qp_uk->sq_base->elem;\n\n\tset_64bit_val(wqe, 0, (uintptr_t)lsmm_buf);\n\tif (qp->qp_uk.uk_attrs->hw_rev == IRDMA_GEN_1) {\n\t\tset_64bit_val(wqe, 8,\n\t\t\t      FIELD_PREP(IRDMAQPSQ_GEN1_FRAG_LEN, size) |\n\t\t\t      FIELD_PREP(IRDMAQPSQ_GEN1_FRAG_STAG, stag));\n\t} else {\n\t\tset_64bit_val(wqe, 8,\n\t\t\t      FIELD_PREP(IRDMAQPSQ_FRAG_LEN, size) |\n\t\t\t      FIELD_PREP(IRDMAQPSQ_FRAG_STAG, stag) |\n\t\t\t      FIELD_PREP(IRDMAQPSQ_VALID, qp->qp_uk.swqe_polarity));\n\t}\n\tset_64bit_val(wqe, 16, 0);\n\n\thdr = FIELD_PREP(IRDMAQPSQ_OPCODE, IRDMAQP_OP_RDMA_SEND) |\n\t      FIELD_PREP(IRDMAQPSQ_STREAMMODE, 1) |\n\t      FIELD_PREP(IRDMAQPSQ_WAITFORRCVPDU, 1) |\n\t      FIELD_PREP(IRDMAQPSQ_VALID, qp->qp_uk.swqe_polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: SEND_LSMM WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_QP_WQE_MIN_SIZE, false);\n\n\tif (qp->dev->hw_attrs.uk_attrs.feature_flags & IRDMA_FEATURE_RTS_AE)\n\t\tirdma_sc_gen_rts_ae(qp);\n}\n\n \nvoid irdma_sc_send_rtt(struct irdma_sc_qp *qp, bool read)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\tstruct irdma_qp_uk *qp_uk;\n\n\tqp_uk = &qp->qp_uk;\n\twqe = qp_uk->sq_base->elem;\n\n\tset_64bit_val(wqe, 0, 0);\n\tset_64bit_val(wqe, 16, 0);\n\tif (read) {\n\t\tif (qp->qp_uk.uk_attrs->hw_rev == IRDMA_GEN_1) {\n\t\t\tset_64bit_val(wqe, 8,\n\t\t\t\t      FIELD_PREP(IRDMAQPSQ_GEN1_FRAG_STAG, 0xabcd));\n\t\t} else {\n\t\t\tset_64bit_val(wqe, 8,\n\t\t\t\t      (u64)0xabcd | FIELD_PREP(IRDMAQPSQ_VALID, qp->qp_uk.swqe_polarity));\n\t\t}\n\t\thdr = FIELD_PREP(IRDMAQPSQ_REMSTAG, 0x1234) |\n\t\t      FIELD_PREP(IRDMAQPSQ_OPCODE, IRDMAQP_OP_RDMA_READ) |\n\t\t      FIELD_PREP(IRDMAQPSQ_VALID, qp->qp_uk.swqe_polarity);\n\n\t} else {\n\t\tif (qp->qp_uk.uk_attrs->hw_rev == IRDMA_GEN_1) {\n\t\t\tset_64bit_val(wqe, 8, 0);\n\t\t} else {\n\t\t\tset_64bit_val(wqe, 8,\n\t\t\t\t      FIELD_PREP(IRDMAQPSQ_VALID, qp->qp_uk.swqe_polarity));\n\t\t}\n\t\thdr = FIELD_PREP(IRDMAQPSQ_OPCODE, IRDMAQP_OP_RDMA_WRITE) |\n\t\t      FIELD_PREP(IRDMAQPSQ_VALID, qp->qp_uk.swqe_polarity);\n\t}\n\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: RTR WQE\", DUMP_PREFIX_OFFSET, 16, 8, wqe,\n\t\t\t     IRDMA_QP_WQE_MIN_SIZE, false);\n\n\tif (qp->dev->hw_attrs.uk_attrs.feature_flags & IRDMA_FEATURE_RTS_AE)\n\t\tirdma_sc_gen_rts_ae(qp);\n}\n\n \nstatic u32 irdma_iwarp_opcode(struct irdma_aeqe_info *info, u8 *pkt)\n{\n\t__be16 *mpa;\n\tu32 opcode = 0xffffffff;\n\n\tif (info->q2_data_written) {\n\t\tmpa = (__be16 *)pkt;\n\t\topcode = ntohs(mpa[1]) & 0xf;\n\t}\n\n\treturn opcode;\n}\n\n \nstatic u8 *irdma_locate_mpa(u8 *pkt)\n{\n\t \n\tpkt += IRDMA_MAC_HLEN;\n\n\t \n\tpkt += 4 * (pkt[0] & 0x0f);\n\tpkt += 4 * ((pkt[12] >> 4) & 0x0f);\n\n\treturn pkt;\n}\n\n \nstatic void irdma_bld_termhdr_ctrl(struct irdma_sc_qp *qp,\n\t\t\t\t   struct irdma_terminate_hdr *hdr,\n\t\t\t\t   enum irdma_flush_opcode opcode,\n\t\t\t\t   u8 layer_etype, u8 err)\n{\n\tqp->flush_code = opcode;\n\thdr->layer_etype = layer_etype;\n\thdr->error_code = err;\n}\n\n \nstatic void irdma_bld_termhdr_ddp_rdma(u8 *pkt, struct irdma_terminate_hdr *hdr,\n\t\t\t\t       int *copy_len, u8 *is_tagged)\n{\n\tu16 ddp_seg_len;\n\n\tddp_seg_len = ntohs(*(__be16 *)pkt);\n\tif (ddp_seg_len) {\n\t\t*copy_len = 2;\n\t\thdr->hdrct = DDP_LEN_FLAG;\n\t\tif (pkt[2] & 0x80) {\n\t\t\t*is_tagged = 1;\n\t\t\tif (ddp_seg_len >= TERM_DDP_LEN_TAGGED) {\n\t\t\t\t*copy_len += TERM_DDP_LEN_TAGGED;\n\t\t\t\thdr->hdrct |= DDP_HDR_FLAG;\n\t\t\t}\n\t\t} else {\n\t\t\tif (ddp_seg_len >= TERM_DDP_LEN_UNTAGGED) {\n\t\t\t\t*copy_len += TERM_DDP_LEN_UNTAGGED;\n\t\t\t\thdr->hdrct |= DDP_HDR_FLAG;\n\t\t\t}\n\t\t\tif (ddp_seg_len >= (TERM_DDP_LEN_UNTAGGED + TERM_RDMA_LEN) &&\n\t\t\t    ((pkt[3] & RDMA_OPCODE_M) == RDMA_READ_REQ_OPCODE)) {\n\t\t\t\t*copy_len += TERM_RDMA_LEN;\n\t\t\t\thdr->hdrct |= RDMA_HDR_FLAG;\n\t\t\t}\n\t\t}\n\t}\n}\n\n \nstatic int irdma_bld_terminate_hdr(struct irdma_sc_qp *qp,\n\t\t\t\t   struct irdma_aeqe_info *info)\n{\n\tu8 *pkt = qp->q2_buf + Q2_BAD_FRAME_OFFSET;\n\tint copy_len = 0;\n\tu8 is_tagged = 0;\n\tu32 opcode;\n\tstruct irdma_terminate_hdr *termhdr;\n\n\ttermhdr = (struct irdma_terminate_hdr *)qp->q2_buf;\n\tmemset(termhdr, 0, Q2_BAD_FRAME_OFFSET);\n\n\tif (info->q2_data_written) {\n\t\tpkt = irdma_locate_mpa(pkt);\n\t\tirdma_bld_termhdr_ddp_rdma(pkt, termhdr, &copy_len, &is_tagged);\n\t}\n\n\topcode = irdma_iwarp_opcode(info, pkt);\n\tqp->event_type = IRDMA_QP_EVENT_CATASTROPHIC;\n\tqp->sq_flush_code = info->sq;\n\tqp->rq_flush_code = info->rq;\n\n\tswitch (info->ae_id) {\n\tcase IRDMA_AE_AMP_UNALLOCATED_STAG:\n\t\tqp->event_type = IRDMA_QP_EVENT_ACCESS_ERR;\n\t\tif (opcode == IRDMA_OP_TYPE_RDMA_WRITE)\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_PROT_ERR,\n\t\t\t\t\t       (LAYER_DDP << 4) | DDP_TAGGED_BUF,\n\t\t\t\t\t       DDP_TAGGED_INV_STAG);\n\t\telse\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_ACCESS_ERR,\n\t\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_PROT,\n\t\t\t\t\t       RDMAP_INV_STAG);\n\t\tbreak;\n\tcase IRDMA_AE_AMP_BOUNDS_VIOLATION:\n\t\tqp->event_type = IRDMA_QP_EVENT_ACCESS_ERR;\n\t\tif (info->q2_data_written)\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_PROT_ERR,\n\t\t\t\t\t       (LAYER_DDP << 4) | DDP_TAGGED_BUF,\n\t\t\t\t\t       DDP_TAGGED_BOUNDS);\n\t\telse\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_ACCESS_ERR,\n\t\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_PROT,\n\t\t\t\t\t       RDMAP_INV_BOUNDS);\n\t\tbreak;\n\tcase IRDMA_AE_AMP_BAD_PD:\n\t\tswitch (opcode) {\n\t\tcase IRDMA_OP_TYPE_RDMA_WRITE:\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_PROT_ERR,\n\t\t\t\t\t       (LAYER_DDP << 4) | DDP_TAGGED_BUF,\n\t\t\t\t\t       DDP_TAGGED_UNASSOC_STAG);\n\t\t\tbreak;\n\t\tcase IRDMA_OP_TYPE_SEND_INV:\n\t\tcase IRDMA_OP_TYPE_SEND_SOL_INV:\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_ACCESS_ERR,\n\t\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_PROT,\n\t\t\t\t\t       RDMAP_CANT_INV_STAG);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_ACCESS_ERR,\n\t\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_PROT,\n\t\t\t\t\t       RDMAP_UNASSOC_STAG);\n\t\t}\n\t\tbreak;\n\tcase IRDMA_AE_AMP_INVALID_STAG:\n\t\tqp->event_type = IRDMA_QP_EVENT_ACCESS_ERR;\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_ACCESS_ERR,\n\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_PROT,\n\t\t\t\t       RDMAP_INV_STAG);\n\t\tbreak;\n\tcase IRDMA_AE_AMP_BAD_QP:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_LOC_QP_OP_ERR,\n\t\t\t\t       (LAYER_DDP << 4) | DDP_UNTAGGED_BUF,\n\t\t\t\t       DDP_UNTAGGED_INV_QN);\n\t\tbreak;\n\tcase IRDMA_AE_AMP_BAD_STAG_KEY:\n\tcase IRDMA_AE_AMP_BAD_STAG_INDEX:\n\t\tqp->event_type = IRDMA_QP_EVENT_ACCESS_ERR;\n\t\tswitch (opcode) {\n\t\tcase IRDMA_OP_TYPE_SEND_INV:\n\t\tcase IRDMA_OP_TYPE_SEND_SOL_INV:\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_OP_ERR,\n\t\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_OP,\n\t\t\t\t\t       RDMAP_CANT_INV_STAG);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_ACCESS_ERR,\n\t\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_OP,\n\t\t\t\t\t       RDMAP_INV_STAG);\n\t\t}\n\t\tbreak;\n\tcase IRDMA_AE_AMP_RIGHTS_VIOLATION:\n\tcase IRDMA_AE_AMP_INVALIDATE_NO_REMOTE_ACCESS_RIGHTS:\n\tcase IRDMA_AE_PRIV_OPERATION_DENIED:\n\t\tqp->event_type = IRDMA_QP_EVENT_ACCESS_ERR;\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_ACCESS_ERR,\n\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_PROT,\n\t\t\t\t       RDMAP_ACCESS);\n\t\tbreak;\n\tcase IRDMA_AE_AMP_TO_WRAP:\n\t\tqp->event_type = IRDMA_QP_EVENT_ACCESS_ERR;\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_ACCESS_ERR,\n\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_PROT,\n\t\t\t\t       RDMAP_TO_WRAP);\n\t\tbreak;\n\tcase IRDMA_AE_LLP_RECEIVED_MPA_CRC_ERROR:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_GENERAL_ERR,\n\t\t\t\t       (LAYER_MPA << 4) | DDP_LLP, MPA_CRC);\n\t\tbreak;\n\tcase IRDMA_AE_LLP_SEGMENT_TOO_SMALL:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_LOC_LEN_ERR,\n\t\t\t\t       (LAYER_DDP << 4) | DDP_CATASTROPHIC,\n\t\t\t\t       DDP_CATASTROPHIC_LOCAL);\n\t\tbreak;\n\tcase IRDMA_AE_LCE_QP_CATASTROPHIC:\n\tcase IRDMA_AE_DDP_NO_L_BIT:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_FATAL_ERR,\n\t\t\t\t       (LAYER_DDP << 4) | DDP_CATASTROPHIC,\n\t\t\t\t       DDP_CATASTROPHIC_LOCAL);\n\t\tbreak;\n\tcase IRDMA_AE_DDP_INVALID_MSN_GAP_IN_MSN:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_GENERAL_ERR,\n\t\t\t\t       (LAYER_DDP << 4) | DDP_UNTAGGED_BUF,\n\t\t\t\t       DDP_UNTAGGED_INV_MSN_RANGE);\n\t\tbreak;\n\tcase IRDMA_AE_DDP_UBE_DDP_MESSAGE_TOO_LONG_FOR_AVAILABLE_BUFFER:\n\t\tqp->event_type = IRDMA_QP_EVENT_ACCESS_ERR;\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_LOC_LEN_ERR,\n\t\t\t\t       (LAYER_DDP << 4) | DDP_UNTAGGED_BUF,\n\t\t\t\t       DDP_UNTAGGED_INV_TOO_LONG);\n\t\tbreak;\n\tcase IRDMA_AE_DDP_UBE_INVALID_DDP_VERSION:\n\t\tif (is_tagged)\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_GENERAL_ERR,\n\t\t\t\t\t       (LAYER_DDP << 4) | DDP_TAGGED_BUF,\n\t\t\t\t\t       DDP_TAGGED_INV_DDP_VER);\n\t\telse\n\t\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_GENERAL_ERR,\n\t\t\t\t\t       (LAYER_DDP << 4) | DDP_UNTAGGED_BUF,\n\t\t\t\t\t       DDP_UNTAGGED_INV_DDP_VER);\n\t\tbreak;\n\tcase IRDMA_AE_DDP_UBE_INVALID_MO:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_GENERAL_ERR,\n\t\t\t\t       (LAYER_DDP << 4) | DDP_UNTAGGED_BUF,\n\t\t\t\t       DDP_UNTAGGED_INV_MO);\n\t\tbreak;\n\tcase IRDMA_AE_DDP_UBE_INVALID_MSN_NO_BUFFER_AVAILABLE:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_REM_OP_ERR,\n\t\t\t\t       (LAYER_DDP << 4) | DDP_UNTAGGED_BUF,\n\t\t\t\t       DDP_UNTAGGED_INV_MSN_NO_BUF);\n\t\tbreak;\n\tcase IRDMA_AE_DDP_UBE_INVALID_QN:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_GENERAL_ERR,\n\t\t\t\t       (LAYER_DDP << 4) | DDP_UNTAGGED_BUF,\n\t\t\t\t       DDP_UNTAGGED_INV_QN);\n\t\tbreak;\n\tcase IRDMA_AE_RDMAP_ROE_INVALID_RDMAP_VERSION:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_GENERAL_ERR,\n\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_OP,\n\t\t\t\t       RDMAP_INV_RDMAP_VER);\n\t\tbreak;\n\tdefault:\n\t\tirdma_bld_termhdr_ctrl(qp, termhdr, FLUSH_FATAL_ERR,\n\t\t\t\t       (LAYER_RDMA << 4) | RDMAP_REMOTE_OP,\n\t\t\t\t       RDMAP_UNSPECIFIED);\n\t\tbreak;\n\t}\n\n\tif (copy_len)\n\t\tmemcpy(termhdr + 1, pkt, copy_len);\n\n\treturn sizeof(struct irdma_terminate_hdr) + copy_len;\n}\n\n \nvoid irdma_terminate_send_fin(struct irdma_sc_qp *qp)\n{\n\tirdma_term_modify_qp(qp, IRDMA_QP_STATE_TERMINATE,\n\t\t\t     IRDMAQP_TERM_SEND_FIN_ONLY, 0);\n}\n\n \nvoid irdma_terminate_connection(struct irdma_sc_qp *qp,\n\t\t\t\tstruct irdma_aeqe_info *info)\n{\n\tu8 termlen = 0;\n\n\tif (qp->term_flags & IRDMA_TERM_SENT)\n\t\treturn;\n\n\ttermlen = irdma_bld_terminate_hdr(qp, info);\n\tirdma_terminate_start_timer(qp);\n\tqp->term_flags |= IRDMA_TERM_SENT;\n\tirdma_term_modify_qp(qp, IRDMA_QP_STATE_TERMINATE,\n\t\t\t     IRDMAQP_TERM_SEND_TERM_ONLY, termlen);\n}\n\n \nvoid irdma_terminate_received(struct irdma_sc_qp *qp,\n\t\t\t      struct irdma_aeqe_info *info)\n{\n\tu8 *pkt = qp->q2_buf + Q2_BAD_FRAME_OFFSET;\n\t__be32 *mpa;\n\tu8 ddp_ctl;\n\tu8 rdma_ctl;\n\tu16 aeq_id = 0;\n\tstruct irdma_terminate_hdr *termhdr;\n\n\tmpa = (__be32 *)irdma_locate_mpa(pkt);\n\tif (info->q2_data_written) {\n\t\t \n\t\tddp_ctl = (ntohl(mpa[0]) >> 8) & 0xff;\n\t\trdma_ctl = ntohl(mpa[0]) & 0xff;\n\t\tif ((ddp_ctl & 0xc0) != 0x40)\n\t\t\taeq_id = IRDMA_AE_LCE_QP_CATASTROPHIC;\n\t\telse if ((ddp_ctl & 0x03) != 1)\n\t\t\taeq_id = IRDMA_AE_DDP_UBE_INVALID_DDP_VERSION;\n\t\telse if (ntohl(mpa[2]) != 2)\n\t\t\taeq_id = IRDMA_AE_DDP_UBE_INVALID_QN;\n\t\telse if (ntohl(mpa[3]) != 1)\n\t\t\taeq_id = IRDMA_AE_DDP_INVALID_MSN_GAP_IN_MSN;\n\t\telse if (ntohl(mpa[4]) != 0)\n\t\t\taeq_id = IRDMA_AE_DDP_UBE_INVALID_MO;\n\t\telse if ((rdma_ctl & 0xc0) != 0x40)\n\t\t\taeq_id = IRDMA_AE_RDMAP_ROE_INVALID_RDMAP_VERSION;\n\n\t\tinfo->ae_id = aeq_id;\n\t\tif (info->ae_id) {\n\t\t\t \n\t\t\tirdma_terminate_connection(qp, info);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tqp->term_flags |= IRDMA_TERM_RCVD;\n\tqp->event_type = IRDMA_QP_EVENT_CATASTROPHIC;\n\ttermhdr = (struct irdma_terminate_hdr *)&mpa[5];\n\tif (termhdr->layer_etype == RDMAP_REMOTE_PROT ||\n\t    termhdr->layer_etype == RDMAP_REMOTE_OP) {\n\t\tirdma_terminate_done(qp, 0);\n\t} else {\n\t\tirdma_terminate_start_timer(qp);\n\t\tirdma_terminate_send_fin(qp);\n\t}\n}\n\nstatic int irdma_null_ws_add(struct irdma_sc_vsi *vsi, u8 user_pri)\n{\n\treturn 0;\n}\n\nstatic void irdma_null_ws_remove(struct irdma_sc_vsi *vsi, u8 user_pri)\n{\n\t \n}\n\nstatic void irdma_null_ws_reset(struct irdma_sc_vsi *vsi)\n{\n\t \n}\n\n \nvoid irdma_sc_vsi_init(struct irdma_sc_vsi  *vsi,\n\t\t       struct irdma_vsi_init_info *info)\n{\n\tint i;\n\n\tvsi->dev = info->dev;\n\tvsi->back_vsi = info->back_vsi;\n\tvsi->register_qset = info->register_qset;\n\tvsi->unregister_qset = info->unregister_qset;\n\tvsi->mtu = info->params->mtu;\n\tvsi->exception_lan_q = info->exception_lan_q;\n\tvsi->vsi_idx = info->pf_data_vsi_num;\n\n\tirdma_set_qos_info(vsi, info->params);\n\tfor (i = 0; i < IRDMA_MAX_USER_PRIORITY; i++) {\n\t\tmutex_init(&vsi->qos[i].qos_mutex);\n\t\tINIT_LIST_HEAD(&vsi->qos[i].qplist);\n\t}\n\tif (vsi->register_qset) {\n\t\tvsi->dev->ws_add = irdma_ws_add;\n\t\tvsi->dev->ws_remove = irdma_ws_remove;\n\t\tvsi->dev->ws_reset = irdma_ws_reset;\n\t} else {\n\t\tvsi->dev->ws_add = irdma_null_ws_add;\n\t\tvsi->dev->ws_remove = irdma_null_ws_remove;\n\t\tvsi->dev->ws_reset = irdma_null_ws_reset;\n\t}\n}\n\n \nstatic u8 irdma_get_stats_idx(struct irdma_sc_vsi *vsi)\n{\n\tstruct irdma_stats_inst_info stats_info = {};\n\tstruct irdma_sc_dev *dev = vsi->dev;\n\tu8 i;\n\n\tif (dev->hw_attrs.uk_attrs.hw_rev >= IRDMA_GEN_2) {\n\t\tif (!irdma_cqp_stats_inst_cmd(vsi, IRDMA_OP_STATS_ALLOCATE,\n\t\t\t\t\t      &stats_info))\n\t\t\treturn stats_info.stats_idx;\n\t}\n\n\tfor (i = 0; i < IRDMA_MAX_STATS_COUNT_GEN_1; i++) {\n\t\tif (!dev->stats_idx_array[i]) {\n\t\t\tdev->stats_idx_array[i] = true;\n\t\t\treturn i;\n\t\t}\n\t}\n\n\treturn IRDMA_INVALID_STATS_IDX;\n}\n\n \nstatic void irdma_hw_stats_init_gen1(struct irdma_sc_vsi *vsi)\n{\n\tstruct irdma_sc_dev *dev = vsi->dev;\n\tconst struct irdma_hw_stat_map *map;\n\tu64 *stat_reg = vsi->hw_stats_regs;\n\tu64 *regs = dev->hw_stats_regs;\n\tu16 i, stats_reg_set = vsi->stats_idx;\n\n\tmap = dev->hw_stats_map;\n\n\t \n\tstats_reg_set += vsi->stats_inst_alloc ? IRDMA_FIRST_NON_PF_STAT : 0;\n\n\tfor (i = 0; i < dev->hw_attrs.max_stat_idx; i++) {\n\t\tif (map[i].bitmask <= IRDMA_MAX_STATS_32)\n\t\t\tstat_reg[i] = regs[i] + stats_reg_set * sizeof(u32);\n\t\telse\n\t\t\tstat_reg[i] = regs[i] + stats_reg_set * sizeof(u64);\n\t}\n}\n\n \nint irdma_vsi_stats_init(struct irdma_sc_vsi *vsi,\n\t\t\t struct irdma_vsi_stats_info *info)\n{\n\tstruct irdma_dma_mem *stats_buff_mem;\n\n\tvsi->pestat = info->pestat;\n\tvsi->pestat->hw = vsi->dev->hw;\n\tvsi->pestat->vsi = vsi;\n\tstats_buff_mem = &vsi->pestat->gather_info.stats_buff_mem;\n\tstats_buff_mem->size = ALIGN(IRDMA_GATHER_STATS_BUF_SIZE * 2, 1);\n\tstats_buff_mem->va = dma_alloc_coherent(vsi->pestat->hw->device,\n\t\t\t\t\t\tstats_buff_mem->size,\n\t\t\t\t\t\t&stats_buff_mem->pa,\n\t\t\t\t\t\tGFP_KERNEL);\n\tif (!stats_buff_mem->va)\n\t\treturn -ENOMEM;\n\n\tvsi->pestat->gather_info.gather_stats_va = stats_buff_mem->va;\n\tvsi->pestat->gather_info.last_gather_stats_va =\n\t\t(void *)((uintptr_t)stats_buff_mem->va +\n\t\t\t IRDMA_GATHER_STATS_BUF_SIZE);\n\n\tirdma_hw_stats_start_timer(vsi);\n\n\t \n\tvsi->stats_idx = info->fcn_id;\n\tif (info->alloc_stats_inst) {\n\t\tu8 stats_idx = irdma_get_stats_idx(vsi);\n\n\t\tif (stats_idx != IRDMA_INVALID_STATS_IDX) {\n\t\t\tvsi->stats_inst_alloc = true;\n\t\t\tvsi->stats_idx = stats_idx;\n\t\t\tvsi->pestat->gather_info.use_stats_inst = true;\n\t\t\tvsi->pestat->gather_info.stats_inst_index = stats_idx;\n\t\t}\n\t}\n\n\tif (vsi->dev->hw_attrs.uk_attrs.hw_rev == IRDMA_GEN_1)\n\t\tirdma_hw_stats_init_gen1(vsi);\n\n\treturn 0;\n}\n\n \nvoid irdma_vsi_stats_free(struct irdma_sc_vsi *vsi)\n{\n\tstruct irdma_stats_inst_info stats_info = {};\n\tstruct irdma_sc_dev *dev = vsi->dev;\n\tu8 stats_idx = vsi->stats_idx;\n\n\tif (dev->hw_attrs.uk_attrs.hw_rev >= IRDMA_GEN_2) {\n\t\tif (vsi->stats_inst_alloc) {\n\t\t\tstats_info.stats_idx = vsi->stats_idx;\n\t\t\tirdma_cqp_stats_inst_cmd(vsi, IRDMA_OP_STATS_FREE,\n\t\t\t\t\t\t &stats_info);\n\t\t}\n\t} else {\n\t\tif (vsi->stats_inst_alloc &&\n\t\t    stats_idx < vsi->dev->hw_attrs.max_stat_inst)\n\t\t\tvsi->dev->stats_idx_array[stats_idx] = false;\n\t}\n\n\tif (!vsi->pestat)\n\t\treturn;\n\tirdma_hw_stats_stop_timer(vsi);\n\tdma_free_coherent(vsi->pestat->hw->device,\n\t\t\t  vsi->pestat->gather_info.stats_buff_mem.size,\n\t\t\t  vsi->pestat->gather_info.stats_buff_mem.va,\n\t\t\t  vsi->pestat->gather_info.stats_buff_mem.pa);\n\tvsi->pestat->gather_info.stats_buff_mem.va = NULL;\n}\n\n \nu8 irdma_get_encoded_wqe_size(u32 wqsize, enum irdma_queue_type queue_type)\n{\n\tu8 encoded_size = 0;\n\n\t \n\tif (queue_type == IRDMA_QUEUE_TYPE_CQP)\n\t\tencoded_size = 1;\n\twqsize >>= 2;\n\twhile (wqsize >>= 1)\n\t\tencoded_size++;\n\n\treturn encoded_size;\n}\n\n \nstatic int irdma_sc_gather_stats(struct irdma_sc_cqp *cqp,\n\t\t\t\t struct irdma_stats_gather_info *info,\n\t\t\t\t u64 scratch)\n{\n\t__le64 *wqe;\n\tu64 temp;\n\n\tif (info->stats_buff_mem.size < IRDMA_GATHER_STATS_BUF_SIZE)\n\t\treturn -ENOMEM;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 40,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STATS_HMC_FCN_INDEX, info->hmc_fcn_index));\n\tset_64bit_val(wqe, 32, info->stats_buff_mem.pa);\n\n\ttemp = FIELD_PREP(IRDMA_CQPSQ_STATS_WQEVALID, cqp->polarity) |\n\t       FIELD_PREP(IRDMA_CQPSQ_STATS_USE_INST, info->use_stats_inst) |\n\t       FIELD_PREP(IRDMA_CQPSQ_STATS_INST_INDEX,\n\t\t\t  info->stats_inst_index) |\n\t       FIELD_PREP(IRDMA_CQPSQ_STATS_USE_HMC_FCN_INDEX,\n\t\t\t  info->use_hmc_fcn_index) |\n\t       FIELD_PREP(IRDMA_CQPSQ_STATS_OP, IRDMA_CQP_OP_GATHER_STATS);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, temp);\n\n\tprint_hex_dump_debug(\"STATS: GATHER_STATS WQE\", DUMP_PREFIX_OFFSET,\n\t\t\t     16, 8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\n\tirdma_sc_cqp_post_sq(cqp);\n\tibdev_dbg(to_ibdev(cqp->dev),\n\t\t  \"STATS: CQP SQ head 0x%x tail 0x%x size 0x%x\\n\",\n\t\t  cqp->sq_ring.head, cqp->sq_ring.tail, cqp->sq_ring.size);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_manage_stats_inst(struct irdma_sc_cqp *cqp,\n\t\t\t\t      struct irdma_stats_inst_info *info,\n\t\t\t\t      bool alloc, u64 scratch)\n{\n\t__le64 *wqe;\n\tu64 temp;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 40,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_STATS_HMC_FCN_INDEX, info->hmc_fn_id));\n\ttemp = FIELD_PREP(IRDMA_CQPSQ_STATS_WQEVALID, cqp->polarity) |\n\t       FIELD_PREP(IRDMA_CQPSQ_STATS_ALLOC_INST, alloc) |\n\t       FIELD_PREP(IRDMA_CQPSQ_STATS_USE_HMC_FCN_INDEX,\n\t\t\t  info->use_hmc_fcn_index) |\n\t       FIELD_PREP(IRDMA_CQPSQ_STATS_INST_INDEX, info->stats_idx) |\n\t       FIELD_PREP(IRDMA_CQPSQ_STATS_OP, IRDMA_CQP_OP_MANAGE_STATS);\n\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, temp);\n\n\tprint_hex_dump_debug(\"WQE: MANAGE_STATS WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\n\tirdma_sc_cqp_post_sq(cqp);\n\treturn 0;\n}\n\n \nstatic int irdma_sc_set_up_map(struct irdma_sc_cqp *cqp,\n\t\t\t       struct irdma_up_info *info, u64 scratch)\n{\n\t__le64 *wqe;\n\tu64 temp = 0;\n\tint i;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < IRDMA_MAX_USER_PRIORITY; i++)\n\t\ttemp |= (u64)info->map[i] << (i * 8);\n\n\tset_64bit_val(wqe, 0, temp);\n\tset_64bit_val(wqe, 40,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_UP_CNPOVERRIDE, info->cnp_up_override) |\n\t\t      FIELD_PREP(IRDMA_CQPSQ_UP_HMCFCNIDX, info->hmc_fcn_idx));\n\n\ttemp = FIELD_PREP(IRDMA_CQPSQ_UP_WQEVALID, cqp->polarity) |\n\t       FIELD_PREP(IRDMA_CQPSQ_UP_USEVLAN, info->use_vlan) |\n\t       FIELD_PREP(IRDMA_CQPSQ_UP_USEOVERRIDE,\n\t\t\t  info->use_cnp_up_override) |\n\t       FIELD_PREP(IRDMA_CQPSQ_UP_OP, IRDMA_CQP_OP_UP_MAP);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, temp);\n\n\tprint_hex_dump_debug(\"WQE: UPMAP WQE\", DUMP_PREFIX_OFFSET, 16, 8, wqe,\n\t\t\t     IRDMA_CQP_WQE_SIZE * 8, false);\n\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_manage_ws_node(struct irdma_sc_cqp *cqp,\n\t\t\t\t   struct irdma_ws_node_info *info,\n\t\t\t\t   enum irdma_ws_node_op node_op, u64 scratch)\n{\n\t__le64 *wqe;\n\tu64 temp = 0;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 32,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_WS_VSI, info->vsi) |\n\t\t      FIELD_PREP(IRDMA_CQPSQ_WS_WEIGHT, info->weight));\n\n\ttemp = FIELD_PREP(IRDMA_CQPSQ_WS_WQEVALID, cqp->polarity) |\n\t       FIELD_PREP(IRDMA_CQPSQ_WS_NODEOP, node_op) |\n\t       FIELD_PREP(IRDMA_CQPSQ_WS_ENABLENODE, info->enable) |\n\t       FIELD_PREP(IRDMA_CQPSQ_WS_NODETYPE, info->type_leaf) |\n\t       FIELD_PREP(IRDMA_CQPSQ_WS_PRIOTYPE, info->prio_type) |\n\t       FIELD_PREP(IRDMA_CQPSQ_WS_TC, info->tc) |\n\t       FIELD_PREP(IRDMA_CQPSQ_WS_OP, IRDMA_CQP_OP_WORK_SCHED_NODE) |\n\t       FIELD_PREP(IRDMA_CQPSQ_WS_PARENTID, info->parent_id) |\n\t       FIELD_PREP(IRDMA_CQPSQ_WS_NODEID, info->id);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, temp);\n\n\tprint_hex_dump_debug(\"WQE: MANAGE_WS WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nint irdma_sc_qp_flush_wqes(struct irdma_sc_qp *qp,\n\t\t\t   struct irdma_qp_flush_info *info, u64 scratch,\n\t\t\t   bool post_sq)\n{\n\tu64 temp = 0;\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\tu64 hdr;\n\tbool flush_sq = false, flush_rq = false;\n\n\tif (info->rq && !qp->flush_rq)\n\t\tflush_rq = true;\n\tif (info->sq && !qp->flush_sq)\n\t\tflush_sq = true;\n\tqp->flush_sq |= flush_sq;\n\tqp->flush_rq |= flush_rq;\n\n\tif (!flush_sq && !flush_rq) {\n\t\tibdev_dbg(to_ibdev(qp->dev),\n\t\t\t  \"CQP: Additional flush request ignored for qp %x\\n\",\n\t\t\t  qp->qp_uk.qp_id);\n\t\treturn -EALREADY;\n\t}\n\n\tcqp = qp->pd->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tif (info->userflushcode) {\n\t\tif (flush_rq)\n\t\t\ttemp |= FIELD_PREP(IRDMA_CQPSQ_FWQE_RQMNERR,\n\t\t\t\t\t   info->rq_minor_code) |\n\t\t\t\tFIELD_PREP(IRDMA_CQPSQ_FWQE_RQMJERR,\n\t\t\t\t\t   info->rq_major_code);\n\t\tif (flush_sq)\n\t\t\ttemp |= FIELD_PREP(IRDMA_CQPSQ_FWQE_SQMNERR,\n\t\t\t\t\t   info->sq_minor_code) |\n\t\t\t\tFIELD_PREP(IRDMA_CQPSQ_FWQE_SQMJERR,\n\t\t\t\t\t   info->sq_major_code);\n\t}\n\tset_64bit_val(wqe, 16, temp);\n\n\ttemp = (info->generate_ae) ?\n\t\tinfo->ae_code | FIELD_PREP(IRDMA_CQPSQ_FWQE_AESOURCE,\n\t\t\t\t\t   info->ae_src) : 0;\n\tset_64bit_val(wqe, 8, temp);\n\n\thdr = qp->qp_uk.qp_id |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_FLUSH_WQES) |\n\t      FIELD_PREP(IRDMA_CQPSQ_FWQE_GENERATE_AE, info->generate_ae) |\n\t      FIELD_PREP(IRDMA_CQPSQ_FWQE_USERFLCODE, info->userflushcode) |\n\t      FIELD_PREP(IRDMA_CQPSQ_FWQE_FLUSHSQ, flush_sq) |\n\t      FIELD_PREP(IRDMA_CQPSQ_FWQE_FLUSHRQ, flush_rq) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: QP_FLUSH WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_gen_ae(struct irdma_sc_qp *qp,\n\t\t\t   struct irdma_gen_ae_info *info, u64 scratch,\n\t\t\t   bool post_sq)\n{\n\tu64 temp;\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\tu64 hdr;\n\n\tcqp = qp->pd->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\ttemp = info->ae_code | FIELD_PREP(IRDMA_CQPSQ_FWQE_AESOURCE,\n\t\t\t\t\t  info->ae_src);\n\tset_64bit_val(wqe, 8, temp);\n\n\thdr = qp->qp_uk.qp_id | FIELD_PREP(IRDMA_CQPSQ_OPCODE,\n\t\t\t\t\t   IRDMA_CQP_OP_GEN_AE) |\n\t      FIELD_PREP(IRDMA_CQPSQ_FWQE_GENERATE_AE, 1) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: GEN_AE WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_qp_upload_context(struct irdma_sc_dev *dev,\n\t\t\t\t      struct irdma_upload_context_info *info,\n\t\t\t\t      u64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\tu64 hdr;\n\n\tcqp = dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16, info->buf_pa);\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_UCTX_QPID, info->qp_id) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_UPLOAD_CONTEXT) |\n\t      FIELD_PREP(IRDMA_CQPSQ_UCTX_QPTYPE, info->qp_type) |\n\t      FIELD_PREP(IRDMA_CQPSQ_UCTX_RAWFORMAT, info->raw_format) |\n\t      FIELD_PREP(IRDMA_CQPSQ_UCTX_FREEZEQP, info->freeze_qp) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: QP_UPLOAD_CTX WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_manage_push_page(struct irdma_sc_cqp *cqp,\n\t\t\t\t     struct irdma_cqp_manage_push_page_info *info,\n\t\t\t\t     u64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\n\tif (info->free_page &&\n\t    info->push_idx >= cqp->dev->hw_attrs.max_hw_device_pages)\n\t\treturn -EINVAL;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16, info->qs_handle);\n\thdr = FIELD_PREP(IRDMA_CQPSQ_MPP_PPIDX, info->push_idx) |\n\t      FIELD_PREP(IRDMA_CQPSQ_MPP_PPTYPE, info->push_page_type) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_MANAGE_PUSH_PAGES) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity) |\n\t      FIELD_PREP(IRDMA_CQPSQ_MPP_FREE_PAGE, info->free_page);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: MANAGE_PUSH_PAGES WQE\", DUMP_PREFIX_OFFSET,\n\t\t\t     16, 8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_suspend_qp(struct irdma_sc_cqp *cqp, struct irdma_sc_qp *qp,\n\t\t\t       u64 scratch)\n{\n\tu64 hdr;\n\t__le64 *wqe;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_SUSPENDQP_QPID, qp->qp_uk.qp_id) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_SUSPEND_QP) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: SUSPEND_QP WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_resume_qp(struct irdma_sc_cqp *cqp, struct irdma_sc_qp *qp,\n\t\t\t      u64 scratch)\n{\n\tu64 hdr;\n\t__le64 *wqe;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_RESUMEQP_QSHANDLE, qp->qs_handle));\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_RESUMEQP_QPID, qp->qp_uk.qp_id) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_RESUME_QP) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: RESUME_QP WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic inline void irdma_sc_cq_ack(struct irdma_sc_cq *cq)\n{\n\twritel(cq->cq_uk.cq_id, cq->cq_uk.cq_ack_db);\n}\n\n \nint irdma_sc_cq_init(struct irdma_sc_cq *cq, struct irdma_cq_init_info *info)\n{\n\tu32 pble_obj_cnt;\n\n\tpble_obj_cnt = info->dev->hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt;\n\tif (info->virtual_map && info->first_pm_pbl_idx >= pble_obj_cnt)\n\t\treturn -EINVAL;\n\n\tcq->cq_pa = info->cq_base_pa;\n\tcq->dev = info->dev;\n\tcq->ceq_id = info->ceq_id;\n\tinfo->cq_uk_init_info.cqe_alloc_db = cq->dev->cq_arm_db;\n\tinfo->cq_uk_init_info.cq_ack_db = cq->dev->cq_ack_db;\n\tirdma_uk_cq_init(&cq->cq_uk, &info->cq_uk_init_info);\n\n\tcq->virtual_map = info->virtual_map;\n\tcq->pbl_chunk_size = info->pbl_chunk_size;\n\tcq->ceqe_mask = info->ceqe_mask;\n\tcq->cq_type = (info->type) ? info->type : IRDMA_CQ_TYPE_IWARP;\n\tcq->shadow_area_pa = info->shadow_area_pa;\n\tcq->shadow_read_threshold = info->shadow_read_threshold;\n\tcq->ceq_id_valid = info->ceq_id_valid;\n\tcq->tph_en = info->tph_en;\n\tcq->tph_val = info->tph_val;\n\tcq->first_pm_pbl_idx = info->first_pm_pbl_idx;\n\tcq->vsi = info->vsi;\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_cq_create(struct irdma_sc_cq *cq, u64 scratch,\n\t\t\t      bool check_overflow, bool post_sq)\n{\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\tu64 hdr;\n\tstruct irdma_sc_ceq *ceq;\n\tint ret_code = 0;\n\n\tcqp = cq->dev->cqp;\n\tif (cq->cq_uk.cq_id >= cqp->dev->hmc_info->hmc_obj[IRDMA_HMC_IW_CQ].max_cnt)\n\t\treturn -EINVAL;\n\n\tif (cq->ceq_id >= cq->dev->hmc_fpm_misc.max_ceqs)\n\t\treturn -EINVAL;\n\n\tceq = cq->dev->ceq[cq->ceq_id];\n\tif (ceq && ceq->reg_cq)\n\t\tret_code = irdma_sc_add_cq_ctx(ceq, cq);\n\n\tif (ret_code)\n\t\treturn ret_code;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe) {\n\t\tif (ceq && ceq->reg_cq)\n\t\t\tirdma_sc_remove_cq_ctx(ceq, cq);\n\t\treturn -ENOMEM;\n\t}\n\n\tset_64bit_val(wqe, 0, cq->cq_uk.cq_size);\n\tset_64bit_val(wqe, 8, (uintptr_t)cq >> 1);\n\tset_64bit_val(wqe, 16,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_CQ_SHADOW_READ_THRESHOLD, cq->shadow_read_threshold));\n\tset_64bit_val(wqe, 32, (cq->virtual_map ? 0 : cq->cq_pa));\n\tset_64bit_val(wqe, 40, cq->shadow_area_pa);\n\tset_64bit_val(wqe, 48,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_CQ_FIRSTPMPBLIDX, (cq->virtual_map ? cq->first_pm_pbl_idx : 0)));\n\tset_64bit_val(wqe, 56,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_TPHVAL, cq->tph_val) |\n\t\t      FIELD_PREP(IRDMA_CQPSQ_VSIIDX, cq->vsi->vsi_idx));\n\n\thdr = FLD_LS_64(cq->dev, cq->cq_uk.cq_id, IRDMA_CQPSQ_CQ_CQID) |\n\t      FLD_LS_64(cq->dev, (cq->ceq_id_valid ? cq->ceq_id : 0),\n\t\t\tIRDMA_CQPSQ_CQ_CEQID) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_CREATE_CQ) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_LPBLSIZE, cq->pbl_chunk_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_CHKOVERFLOW, check_overflow) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_VIRTMAP, cq->virtual_map) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_ENCEQEMASK, cq->ceqe_mask) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_CEQIDVALID, cq->ceq_id_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_TPHEN, cq->tph_en) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_AVOIDMEMCNFLCT,\n\t\t\t cq->cq_uk.avoid_mem_cflct) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: CQ_CREATE WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nint irdma_sc_cq_destroy(struct irdma_sc_cq *cq, u64 scratch, bool post_sq)\n{\n\tstruct irdma_sc_cqp *cqp;\n\t__le64 *wqe;\n\tu64 hdr;\n\tstruct irdma_sc_ceq *ceq;\n\n\tcqp = cq->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tceq = cq->dev->ceq[cq->ceq_id];\n\tif (ceq && ceq->reg_cq)\n\t\tirdma_sc_remove_cq_ctx(ceq, cq);\n\n\tset_64bit_val(wqe, 0, cq->cq_uk.cq_size);\n\tset_64bit_val(wqe, 8, (uintptr_t)cq >> 1);\n\tset_64bit_val(wqe, 40, cq->shadow_area_pa);\n\tset_64bit_val(wqe, 48,\n\t\t      (cq->virtual_map ? cq->first_pm_pbl_idx : 0));\n\n\thdr = cq->cq_uk.cq_id |\n\t      FLD_LS_64(cq->dev, (cq->ceq_id_valid ? cq->ceq_id : 0),\n\t\t\tIRDMA_CQPSQ_CQ_CEQID) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_DESTROY_CQ) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_LPBLSIZE, cq->pbl_chunk_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_VIRTMAP, cq->virtual_map) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_ENCEQEMASK, cq->ceqe_mask) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_CEQIDVALID, cq->ceq_id_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_TPHEN, cq->tph_en) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_AVOIDMEMCNFLCT, cq->cq_uk.avoid_mem_cflct) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: CQ_DESTROY WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nvoid irdma_sc_cq_resize(struct irdma_sc_cq *cq, struct irdma_modify_cq_info *info)\n{\n\tcq->virtual_map = info->virtual_map;\n\tcq->cq_pa = info->cq_pa;\n\tcq->first_pm_pbl_idx = info->first_pm_pbl_idx;\n\tcq->pbl_chunk_size = info->pbl_chunk_size;\n\tirdma_uk_cq_resize(&cq->cq_uk, info->cq_base, info->cq_size);\n}\n\n \nstatic int irdma_sc_cq_modify(struct irdma_sc_cq *cq,\n\t\t\t      struct irdma_modify_cq_info *info, u64 scratch,\n\t\t\t      bool post_sq)\n{\n\tstruct irdma_sc_cqp *cqp;\n\t__le64 *wqe;\n\tu64 hdr;\n\tu32 pble_obj_cnt;\n\n\tpble_obj_cnt = cq->dev->hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt;\n\tif (info->cq_resize && info->virtual_map &&\n\t    info->first_pm_pbl_idx >= pble_obj_cnt)\n\t\treturn -EINVAL;\n\n\tcqp = cq->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 0, info->cq_size);\n\tset_64bit_val(wqe, 8, (uintptr_t)cq >> 1);\n\tset_64bit_val(wqe, 16,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_CQ_SHADOW_READ_THRESHOLD, info->shadow_read_threshold));\n\tset_64bit_val(wqe, 32, info->cq_pa);\n\tset_64bit_val(wqe, 40, cq->shadow_area_pa);\n\tset_64bit_val(wqe, 48, info->first_pm_pbl_idx);\n\tset_64bit_val(wqe, 56,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_TPHVAL, cq->tph_val) |\n\t\t      FIELD_PREP(IRDMA_CQPSQ_VSIIDX, cq->vsi->vsi_idx));\n\n\thdr = cq->cq_uk.cq_id |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_MODIFY_CQ) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_CQRESIZE, info->cq_resize) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_LPBLSIZE, info->pbl_chunk_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_CHKOVERFLOW, info->check_overflow) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_VIRTMAP, info->virtual_map) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_ENCEQEMASK, cq->ceqe_mask) |\n\t      FIELD_PREP(IRDMA_CQPSQ_TPHEN, cq->tph_en) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_AVOIDMEMCNFLCT,\n\t\t\t cq->cq_uk.avoid_mem_cflct) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: CQ_MODIFY WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nvoid irdma_check_cqp_progress(struct irdma_cqp_timeout *timeout, struct irdma_sc_dev *dev)\n{\n\tu64 completed_ops = atomic64_read(&dev->cqp->completed_ops);\n\n\tif (timeout->compl_cqp_cmds != completed_ops) {\n\t\ttimeout->compl_cqp_cmds = completed_ops;\n\t\ttimeout->count = 0;\n\t} else if (timeout->compl_cqp_cmds != dev->cqp->requested_ops) {\n\t\ttimeout->count++;\n\t}\n}\n\n \nstatic inline void irdma_get_cqp_reg_info(struct irdma_sc_cqp *cqp, u32 *val,\n\t\t\t\t\t  u32 *tail, u32 *error)\n{\n\t*val = readl(cqp->dev->hw_regs[IRDMA_CQPTAIL]);\n\t*tail = FIELD_GET(IRDMA_CQPTAIL_WQTAIL, *val);\n\t*error = FIELD_GET(IRDMA_CQPTAIL_CQP_OP_ERR, *val);\n}\n\n \nstatic int irdma_cqp_poll_registers(struct irdma_sc_cqp *cqp, u32 tail,\n\t\t\t\t    u32 count)\n{\n\tu32 i = 0;\n\tu32 newtail, error, val;\n\n\twhile (i++ < count) {\n\t\tirdma_get_cqp_reg_info(cqp, &val, &newtail, &error);\n\t\tif (error) {\n\t\t\terror = readl(cqp->dev->hw_regs[IRDMA_CQPERRCODES]);\n\t\t\tibdev_dbg(to_ibdev(cqp->dev),\n\t\t\t\t  \"CQP: CQPERRCODES error_code[x%08X]\\n\",\n\t\t\t\t  error);\n\t\t\treturn -EIO;\n\t\t}\n\t\tif (newtail != tail) {\n\t\t\t \n\t\t\tIRDMA_RING_MOVE_TAIL(cqp->sq_ring);\n\t\t\tatomic64_inc(&cqp->completed_ops);\n\t\t\treturn 0;\n\t\t}\n\t\tudelay(cqp->dev->hw_attrs.max_sleep_count);\n\t}\n\n\treturn -ETIMEDOUT;\n}\n\n \nstatic u64 irdma_sc_decode_fpm_commit(struct irdma_sc_dev *dev, __le64 *buf,\n\t\t\t\t      u32 buf_idx, struct irdma_hmc_obj_info *obj_info,\n\t\t\t\t      u32 rsrc_idx)\n{\n\tu64 temp;\n\n\tget_64bit_val(buf, buf_idx, &temp);\n\n\tswitch (rsrc_idx) {\n\tcase IRDMA_HMC_IW_QP:\n\t\tobj_info[rsrc_idx].cnt = (u32)FIELD_GET(IRDMA_COMMIT_FPM_QPCNT, temp);\n\t\tbreak;\n\tcase IRDMA_HMC_IW_CQ:\n\t\tobj_info[rsrc_idx].cnt = (u32)FLD_RS_64(dev, temp, IRDMA_COMMIT_FPM_CQCNT);\n\t\tbreak;\n\tcase IRDMA_HMC_IW_APBVT_ENTRY:\n\t\tobj_info[rsrc_idx].cnt = 1;\n\t\tbreak;\n\tdefault:\n\t\tobj_info[rsrc_idx].cnt = (u32)temp;\n\t\tbreak;\n\t}\n\n\tobj_info[rsrc_idx].base = (temp >> IRDMA_COMMIT_FPM_BASE_S) * 512;\n\n\treturn temp;\n}\n\n \nstatic void\nirdma_sc_parse_fpm_commit_buf(struct irdma_sc_dev *dev, __le64 *buf,\n\t\t\t      struct irdma_hmc_obj_info *info, u32 *sd)\n{\n\tu64 size;\n\tu32 i;\n\tu64 max_base = 0;\n\tu32 last_hmc_obj = 0;\n\n\tirdma_sc_decode_fpm_commit(dev, buf, 0, info,\n\t\t\t\t   IRDMA_HMC_IW_QP);\n\tirdma_sc_decode_fpm_commit(dev, buf, 8, info,\n\t\t\t\t   IRDMA_HMC_IW_CQ);\n\t \n\tirdma_sc_decode_fpm_commit(dev, buf, 24, info,\n\t\t\t\t   IRDMA_HMC_IW_HTE);\n\tirdma_sc_decode_fpm_commit(dev, buf, 32, info,\n\t\t\t\t   IRDMA_HMC_IW_ARP);\n\tirdma_sc_decode_fpm_commit(dev, buf, 40, info,\n\t\t\t\t   IRDMA_HMC_IW_APBVT_ENTRY);\n\tirdma_sc_decode_fpm_commit(dev, buf, 48, info,\n\t\t\t\t   IRDMA_HMC_IW_MR);\n\tirdma_sc_decode_fpm_commit(dev, buf, 56, info,\n\t\t\t\t   IRDMA_HMC_IW_XF);\n\tirdma_sc_decode_fpm_commit(dev, buf, 64, info,\n\t\t\t\t   IRDMA_HMC_IW_XFFL);\n\tirdma_sc_decode_fpm_commit(dev, buf, 72, info,\n\t\t\t\t   IRDMA_HMC_IW_Q1);\n\tirdma_sc_decode_fpm_commit(dev, buf, 80, info,\n\t\t\t\t   IRDMA_HMC_IW_Q1FL);\n\tirdma_sc_decode_fpm_commit(dev, buf, 88, info,\n\t\t\t\t   IRDMA_HMC_IW_TIMER);\n\tirdma_sc_decode_fpm_commit(dev, buf, 112, info,\n\t\t\t\t   IRDMA_HMC_IW_PBLE);\n\t \n\tif (dev->hw_attrs.uk_attrs.hw_rev != IRDMA_GEN_1) {\n\t\tirdma_sc_decode_fpm_commit(dev, buf, 96, info,\n\t\t\t\t\t   IRDMA_HMC_IW_FSIMC);\n\t\tirdma_sc_decode_fpm_commit(dev, buf, 104, info,\n\t\t\t\t\t   IRDMA_HMC_IW_FSIAV);\n\t\tirdma_sc_decode_fpm_commit(dev, buf, 128, info,\n\t\t\t\t\t   IRDMA_HMC_IW_RRF);\n\t\tirdma_sc_decode_fpm_commit(dev, buf, 136, info,\n\t\t\t\t\t   IRDMA_HMC_IW_RRFFL);\n\t\tirdma_sc_decode_fpm_commit(dev, buf, 144, info,\n\t\t\t\t\t   IRDMA_HMC_IW_HDR);\n\t\tirdma_sc_decode_fpm_commit(dev, buf, 152, info,\n\t\t\t\t\t   IRDMA_HMC_IW_MD);\n\t\tirdma_sc_decode_fpm_commit(dev, buf, 160, info,\n\t\t\t\t\t   IRDMA_HMC_IW_OOISC);\n\t\tirdma_sc_decode_fpm_commit(dev, buf, 168, info,\n\t\t\t\t\t   IRDMA_HMC_IW_OOISCFFL);\n\t}\n\n\t \n\tfor (i = IRDMA_HMC_IW_QP; i < IRDMA_HMC_IW_MAX; i++) {\n\t\tif (info[i].base > max_base) {\n\t\t\tmax_base = info[i].base;\n\t\t\tlast_hmc_obj = i;\n\t\t}\n\t}\n\n\tsize = info[last_hmc_obj].cnt * info[last_hmc_obj].size +\n\t       info[last_hmc_obj].base;\n\n\tif (size & 0x1FFFFF)\n\t\t*sd = (u32)((size >> 21) + 1);  \n\telse\n\t\t*sd = (u32)(size >> 21);\n\n}\n\n \nstatic u64 irdma_sc_decode_fpm_query(__le64 *buf, u32 buf_idx,\n\t\t\t\t     struct irdma_hmc_obj_info *obj_info,\n\t\t\t\t     u32 rsrc_idx)\n{\n\tu64 temp;\n\tu32 size;\n\n\tget_64bit_val(buf, buf_idx, &temp);\n\tobj_info[rsrc_idx].max_cnt = (u32)temp;\n\tsize = (u32)(temp >> 32);\n\tobj_info[rsrc_idx].size = BIT_ULL(size);\n\n\treturn temp;\n}\n\n \nstatic int irdma_sc_parse_fpm_query_buf(struct irdma_sc_dev *dev, __le64 *buf,\n\t\t\t\t\tstruct irdma_hmc_info *hmc_info,\n\t\t\t\t\tstruct irdma_hmc_fpm_misc *hmc_fpm_misc)\n{\n\tstruct irdma_hmc_obj_info *obj_info;\n\tu64 temp;\n\tu32 size;\n\tu16 max_pe_sds;\n\n\tobj_info = hmc_info->hmc_obj;\n\n\tget_64bit_val(buf, 0, &temp);\n\thmc_info->first_sd_index = (u16)FIELD_GET(IRDMA_QUERY_FPM_FIRST_PE_SD_INDEX, temp);\n\tmax_pe_sds = (u16)FIELD_GET(IRDMA_QUERY_FPM_MAX_PE_SDS, temp);\n\n\thmc_fpm_misc->max_sds = max_pe_sds;\n\thmc_info->sd_table.sd_cnt = max_pe_sds + hmc_info->first_sd_index;\n\tget_64bit_val(buf, 8, &temp);\n\tobj_info[IRDMA_HMC_IW_QP].max_cnt = (u32)FIELD_GET(IRDMA_QUERY_FPM_MAX_QPS, temp);\n\tsize = (u32)(temp >> 32);\n\tobj_info[IRDMA_HMC_IW_QP].size = BIT_ULL(size);\n\n\tget_64bit_val(buf, 16, &temp);\n\tobj_info[IRDMA_HMC_IW_CQ].max_cnt = (u32)FIELD_GET(IRDMA_QUERY_FPM_MAX_CQS, temp);\n\tsize = (u32)(temp >> 32);\n\tobj_info[IRDMA_HMC_IW_CQ].size = BIT_ULL(size);\n\n\tirdma_sc_decode_fpm_query(buf, 32, obj_info, IRDMA_HMC_IW_HTE);\n\tirdma_sc_decode_fpm_query(buf, 40, obj_info, IRDMA_HMC_IW_ARP);\n\n\tobj_info[IRDMA_HMC_IW_APBVT_ENTRY].size = 8192;\n\tobj_info[IRDMA_HMC_IW_APBVT_ENTRY].max_cnt = 1;\n\n\tirdma_sc_decode_fpm_query(buf, 48, obj_info, IRDMA_HMC_IW_MR);\n\tirdma_sc_decode_fpm_query(buf, 56, obj_info, IRDMA_HMC_IW_XF);\n\n\tget_64bit_val(buf, 64, &temp);\n\tobj_info[IRDMA_HMC_IW_XFFL].max_cnt = (u32)temp;\n\tobj_info[IRDMA_HMC_IW_XFFL].size = 4;\n\thmc_fpm_misc->xf_block_size = FIELD_GET(IRDMA_QUERY_FPM_XFBLOCKSIZE, temp);\n\tif (!hmc_fpm_misc->xf_block_size)\n\t\treturn -EINVAL;\n\n\tirdma_sc_decode_fpm_query(buf, 72, obj_info, IRDMA_HMC_IW_Q1);\n\tget_64bit_val(buf, 80, &temp);\n\tobj_info[IRDMA_HMC_IW_Q1FL].max_cnt = (u32)temp;\n\tobj_info[IRDMA_HMC_IW_Q1FL].size = 4;\n\n\thmc_fpm_misc->q1_block_size = FIELD_GET(IRDMA_QUERY_FPM_Q1BLOCKSIZE, temp);\n\tif (!hmc_fpm_misc->q1_block_size)\n\t\treturn -EINVAL;\n\n\tirdma_sc_decode_fpm_query(buf, 88, obj_info, IRDMA_HMC_IW_TIMER);\n\n\tget_64bit_val(buf, 112, &temp);\n\tobj_info[IRDMA_HMC_IW_PBLE].max_cnt = (u32)temp;\n\tobj_info[IRDMA_HMC_IW_PBLE].size = 8;\n\n\tget_64bit_val(buf, 120, &temp);\n\thmc_fpm_misc->max_ceqs = FIELD_GET(IRDMA_QUERY_FPM_MAX_CEQS, temp);\n\thmc_fpm_misc->ht_multiplier = FIELD_GET(IRDMA_QUERY_FPM_HTMULTIPLIER, temp);\n\thmc_fpm_misc->timer_bucket = FIELD_GET(IRDMA_QUERY_FPM_TIMERBUCKET, temp);\n\tif (dev->hw_attrs.uk_attrs.hw_rev == IRDMA_GEN_1)\n\t\treturn 0;\n\tirdma_sc_decode_fpm_query(buf, 96, obj_info, IRDMA_HMC_IW_FSIMC);\n\tirdma_sc_decode_fpm_query(buf, 104, obj_info, IRDMA_HMC_IW_FSIAV);\n\tirdma_sc_decode_fpm_query(buf, 128, obj_info, IRDMA_HMC_IW_RRF);\n\n\tget_64bit_val(buf, 136, &temp);\n\tobj_info[IRDMA_HMC_IW_RRFFL].max_cnt = (u32)temp;\n\tobj_info[IRDMA_HMC_IW_RRFFL].size = 4;\n\thmc_fpm_misc->rrf_block_size = FIELD_GET(IRDMA_QUERY_FPM_RRFBLOCKSIZE, temp);\n\tif (!hmc_fpm_misc->rrf_block_size &&\n\t    obj_info[IRDMA_HMC_IW_RRFFL].max_cnt)\n\t\treturn -EINVAL;\n\n\tirdma_sc_decode_fpm_query(buf, 144, obj_info, IRDMA_HMC_IW_HDR);\n\tirdma_sc_decode_fpm_query(buf, 152, obj_info, IRDMA_HMC_IW_MD);\n\tirdma_sc_decode_fpm_query(buf, 160, obj_info, IRDMA_HMC_IW_OOISC);\n\n\tget_64bit_val(buf, 168, &temp);\n\tobj_info[IRDMA_HMC_IW_OOISCFFL].max_cnt = (u32)temp;\n\tobj_info[IRDMA_HMC_IW_OOISCFFL].size = 4;\n\thmc_fpm_misc->ooiscf_block_size = FIELD_GET(IRDMA_QUERY_FPM_OOISCFBLOCKSIZE, temp);\n\tif (!hmc_fpm_misc->ooiscf_block_size &&\n\t    obj_info[IRDMA_HMC_IW_OOISCFFL].max_cnt)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\n \nstatic u32 irdma_sc_find_reg_cq(struct irdma_sc_ceq *ceq,\n\t\t\t\tstruct irdma_sc_cq *cq)\n{\n\tu32 i;\n\n\tfor (i = 0; i < ceq->reg_cq_size; i++) {\n\t\tif (cq == ceq->reg_cq[i])\n\t\t\treturn i;\n\t}\n\n\treturn IRDMA_INVALID_CQ_IDX;\n}\n\n \nint irdma_sc_add_cq_ctx(struct irdma_sc_ceq *ceq, struct irdma_sc_cq *cq)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&ceq->req_cq_lock, flags);\n\n\tif (ceq->reg_cq_size == ceq->elem_cnt) {\n\t\tspin_unlock_irqrestore(&ceq->req_cq_lock, flags);\n\t\treturn -ENOMEM;\n\t}\n\n\tceq->reg_cq[ceq->reg_cq_size++] = cq;\n\n\tspin_unlock_irqrestore(&ceq->req_cq_lock, flags);\n\n\treturn 0;\n}\n\n \nvoid irdma_sc_remove_cq_ctx(struct irdma_sc_ceq *ceq, struct irdma_sc_cq *cq)\n{\n\tunsigned long flags;\n\tu32 cq_ctx_idx;\n\n\tspin_lock_irqsave(&ceq->req_cq_lock, flags);\n\tcq_ctx_idx = irdma_sc_find_reg_cq(ceq, cq);\n\tif (cq_ctx_idx == IRDMA_INVALID_CQ_IDX)\n\t\tgoto exit;\n\n\tceq->reg_cq_size--;\n\tif (cq_ctx_idx != ceq->reg_cq_size)\n\t\tceq->reg_cq[cq_ctx_idx] = ceq->reg_cq[ceq->reg_cq_size];\n\tceq->reg_cq[ceq->reg_cq_size] = NULL;\n\nexit:\n\tspin_unlock_irqrestore(&ceq->req_cq_lock, flags);\n}\n\n \nint irdma_sc_cqp_init(struct irdma_sc_cqp *cqp,\n\t\t      struct irdma_cqp_init_info *info)\n{\n\tu8 hw_sq_size;\n\n\tif (info->sq_size > IRDMA_CQP_SW_SQSIZE_2048 ||\n\t    info->sq_size < IRDMA_CQP_SW_SQSIZE_4 ||\n\t    ((info->sq_size & (info->sq_size - 1))))\n\t\treturn -EINVAL;\n\n\thw_sq_size = irdma_get_encoded_wqe_size(info->sq_size,\n\t\t\t\t\t\tIRDMA_QUEUE_TYPE_CQP);\n\tcqp->size = sizeof(*cqp);\n\tcqp->sq_size = info->sq_size;\n\tcqp->hw_sq_size = hw_sq_size;\n\tcqp->sq_base = info->sq;\n\tcqp->host_ctx = info->host_ctx;\n\tcqp->sq_pa = info->sq_pa;\n\tcqp->host_ctx_pa = info->host_ctx_pa;\n\tcqp->dev = info->dev;\n\tcqp->struct_ver = info->struct_ver;\n\tcqp->hw_maj_ver = info->hw_maj_ver;\n\tcqp->hw_min_ver = info->hw_min_ver;\n\tcqp->scratch_array = info->scratch_array;\n\tcqp->polarity = 0;\n\tcqp->en_datacenter_tcp = info->en_datacenter_tcp;\n\tcqp->ena_vf_count = info->ena_vf_count;\n\tcqp->hmc_profile = info->hmc_profile;\n\tcqp->ceqs_per_vf = info->ceqs_per_vf;\n\tcqp->disable_packed = info->disable_packed;\n\tcqp->rocev2_rto_policy = info->rocev2_rto_policy;\n\tcqp->protocol_used = info->protocol_used;\n\tmemcpy(&cqp->dcqcn_params, &info->dcqcn_params, sizeof(cqp->dcqcn_params));\n\tinfo->dev->cqp = cqp;\n\n\tIRDMA_RING_INIT(cqp->sq_ring, cqp->sq_size);\n\tcqp->requested_ops = 0;\n\tatomic64_set(&cqp->completed_ops, 0);\n\t \n\tINIT_LIST_HEAD(&cqp->dev->cqp_cmd_head);\n\n\twritel(0, cqp->dev->hw_regs[IRDMA_CQPTAIL]);\n\twritel(0, cqp->dev->hw_regs[IRDMA_CQPDB]);\n\twritel(0, cqp->dev->hw_regs[IRDMA_CCQPSTATUS]);\n\n\tibdev_dbg(to_ibdev(cqp->dev),\n\t\t  \"WQE: sq_size[%04d] hw_sq_size[%04d] sq_base[%p] sq_pa[%pK] cqp[%p] polarity[x%04x]\\n\",\n\t\t  cqp->sq_size, cqp->hw_sq_size, cqp->sq_base,\n\t\t  (u64 *)(uintptr_t)cqp->sq_pa, cqp, cqp->polarity);\n\treturn 0;\n}\n\n \nint irdma_sc_cqp_create(struct irdma_sc_cqp *cqp, u16 *maj_err, u16 *min_err)\n{\n\tu64 temp;\n\tu8 hw_rev;\n\tu32 cnt = 0, p1, p2, val = 0, err_code;\n\tint ret_code;\n\n\thw_rev = cqp->dev->hw_attrs.uk_attrs.hw_rev;\n\tcqp->sdbuf.size = ALIGN(IRDMA_UPDATE_SD_BUFF_SIZE * cqp->sq_size,\n\t\t\t\tIRDMA_SD_BUF_ALIGNMENT);\n\tcqp->sdbuf.va = dma_alloc_coherent(cqp->dev->hw->device,\n\t\t\t\t\t   cqp->sdbuf.size, &cqp->sdbuf.pa,\n\t\t\t\t\t   GFP_KERNEL);\n\tif (!cqp->sdbuf.va)\n\t\treturn -ENOMEM;\n\n\tspin_lock_init(&cqp->dev->cqp_lock);\n\n\ttemp = FIELD_PREP(IRDMA_CQPHC_SQSIZE, cqp->hw_sq_size) |\n\t       FIELD_PREP(IRDMA_CQPHC_SVER, cqp->struct_ver) |\n\t       FIELD_PREP(IRDMA_CQPHC_DISABLE_PFPDUS, cqp->disable_packed) |\n\t       FIELD_PREP(IRDMA_CQPHC_CEQPERVF, cqp->ceqs_per_vf);\n\tif (hw_rev >= IRDMA_GEN_2) {\n\t\ttemp |= FIELD_PREP(IRDMA_CQPHC_ROCEV2_RTO_POLICY,\n\t\t\t\t   cqp->rocev2_rto_policy) |\n\t\t\tFIELD_PREP(IRDMA_CQPHC_PROTOCOL_USED,\n\t\t\t\t   cqp->protocol_used);\n\t}\n\n\tset_64bit_val(cqp->host_ctx, 0, temp);\n\tset_64bit_val(cqp->host_ctx, 8, cqp->sq_pa);\n\n\ttemp = FIELD_PREP(IRDMA_CQPHC_ENABLED_VFS, cqp->ena_vf_count) |\n\t       FIELD_PREP(IRDMA_CQPHC_HMC_PROFILE, cqp->hmc_profile);\n\tset_64bit_val(cqp->host_ctx, 16, temp);\n\tset_64bit_val(cqp->host_ctx, 24, (uintptr_t)cqp);\n\ttemp = FIELD_PREP(IRDMA_CQPHC_HW_MAJVER, cqp->hw_maj_ver) |\n\t       FIELD_PREP(IRDMA_CQPHC_HW_MINVER, cqp->hw_min_ver);\n\tif (hw_rev >= IRDMA_GEN_2) {\n\t\ttemp |= FIELD_PREP(IRDMA_CQPHC_MIN_RATE, cqp->dcqcn_params.min_rate) |\n\t\t\tFIELD_PREP(IRDMA_CQPHC_MIN_DEC_FACTOR, cqp->dcqcn_params.min_dec_factor);\n\t}\n\tset_64bit_val(cqp->host_ctx, 32, temp);\n\tset_64bit_val(cqp->host_ctx, 40, 0);\n\ttemp = 0;\n\tif (hw_rev >= IRDMA_GEN_2) {\n\t\ttemp |= FIELD_PREP(IRDMA_CQPHC_DCQCN_T, cqp->dcqcn_params.dcqcn_t) |\n\t\t\tFIELD_PREP(IRDMA_CQPHC_RAI_FACTOR, cqp->dcqcn_params.rai_factor) |\n\t\t\tFIELD_PREP(IRDMA_CQPHC_HAI_FACTOR, cqp->dcqcn_params.hai_factor);\n\t}\n\tset_64bit_val(cqp->host_ctx, 48, temp);\n\ttemp = 0;\n\tif (hw_rev >= IRDMA_GEN_2) {\n\t\ttemp |= FIELD_PREP(IRDMA_CQPHC_DCQCN_B, cqp->dcqcn_params.dcqcn_b) |\n\t\t\tFIELD_PREP(IRDMA_CQPHC_DCQCN_F, cqp->dcqcn_params.dcqcn_f) |\n\t\t\tFIELD_PREP(IRDMA_CQPHC_CC_CFG_VALID, cqp->dcqcn_params.cc_cfg_valid) |\n\t\t\tFIELD_PREP(IRDMA_CQPHC_RREDUCE_MPERIOD, cqp->dcqcn_params.rreduce_mperiod);\n\t}\n\tset_64bit_val(cqp->host_ctx, 56, temp);\n\tprint_hex_dump_debug(\"WQE: CQP_HOST_CTX WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, cqp->host_ctx, IRDMA_CQP_CTX_SIZE * 8, false);\n\tp1 = cqp->host_ctx_pa >> 32;\n\tp2 = (u32)cqp->host_ctx_pa;\n\n\twritel(p1, cqp->dev->hw_regs[IRDMA_CCQPHIGH]);\n\twritel(p2, cqp->dev->hw_regs[IRDMA_CCQPLOW]);\n\n\tdo {\n\t\tif (cnt++ > cqp->dev->hw_attrs.max_done_count) {\n\t\t\tret_code = -ETIMEDOUT;\n\t\t\tgoto err;\n\t\t}\n\t\tudelay(cqp->dev->hw_attrs.max_sleep_count);\n\t\tval = readl(cqp->dev->hw_regs[IRDMA_CCQPSTATUS]);\n\t} while (!val);\n\n\tif (FLD_RS_32(cqp->dev, val, IRDMA_CCQPSTATUS_CCQP_ERR)) {\n\t\tret_code = -EOPNOTSUPP;\n\t\tgoto err;\n\t}\n\n\tcqp->process_cqp_sds = irdma_update_sds_noccq;\n\treturn 0;\n\nerr:\n\tdma_free_coherent(cqp->dev->hw->device, cqp->sdbuf.size,\n\t\t\t  cqp->sdbuf.va, cqp->sdbuf.pa);\n\tcqp->sdbuf.va = NULL;\n\terr_code = readl(cqp->dev->hw_regs[IRDMA_CQPERRCODES]);\n\t*min_err = FIELD_GET(IRDMA_CQPERRCODES_CQP_MINOR_CODE, err_code);\n\t*maj_err = FIELD_GET(IRDMA_CQPERRCODES_CQP_MAJOR_CODE, err_code);\n\treturn ret_code;\n}\n\n \nvoid irdma_sc_cqp_post_sq(struct irdma_sc_cqp *cqp)\n{\n\twritel(IRDMA_RING_CURRENT_HEAD(cqp->sq_ring), cqp->dev->cqp_db);\n\n\tibdev_dbg(to_ibdev(cqp->dev),\n\t\t  \"WQE: CQP SQ head 0x%x tail 0x%x size 0x%x\\n\",\n\t\t  cqp->sq_ring.head, cqp->sq_ring.tail, cqp->sq_ring.size);\n}\n\n \n__le64 *irdma_sc_cqp_get_next_send_wqe_idx(struct irdma_sc_cqp *cqp, u64 scratch,\n\t\t\t\t\t   u32 *wqe_idx)\n{\n\t__le64 *wqe = NULL;\n\tint ret_code;\n\n\tif (IRDMA_RING_FULL_ERR(cqp->sq_ring)) {\n\t\tibdev_dbg(to_ibdev(cqp->dev),\n\t\t\t  \"WQE: CQP SQ is full, head 0x%x tail 0x%x size 0x%x\\n\",\n\t\t\t  cqp->sq_ring.head, cqp->sq_ring.tail,\n\t\t\t  cqp->sq_ring.size);\n\t\treturn NULL;\n\t}\n\tIRDMA_ATOMIC_RING_MOVE_HEAD(cqp->sq_ring, *wqe_idx, ret_code);\n\tif (ret_code)\n\t\treturn NULL;\n\n\tcqp->requested_ops++;\n\tif (!*wqe_idx)\n\t\tcqp->polarity = !cqp->polarity;\n\twqe = cqp->sq_base[*wqe_idx].elem;\n\tcqp->scratch_array[*wqe_idx] = scratch;\n\tIRDMA_CQP_INIT_WQE(wqe);\n\n\treturn wqe;\n}\n\n \nint irdma_sc_cqp_destroy(struct irdma_sc_cqp *cqp)\n{\n\tu32 cnt = 0, val;\n\tint ret_code = 0;\n\n\twritel(0, cqp->dev->hw_regs[IRDMA_CCQPHIGH]);\n\twritel(0, cqp->dev->hw_regs[IRDMA_CCQPLOW]);\n\tdo {\n\t\tif (cnt++ > cqp->dev->hw_attrs.max_done_count) {\n\t\t\tret_code = -ETIMEDOUT;\n\t\t\tbreak;\n\t\t}\n\t\tudelay(cqp->dev->hw_attrs.max_sleep_count);\n\t\tval = readl(cqp->dev->hw_regs[IRDMA_CCQPSTATUS]);\n\t} while (FLD_RS_32(cqp->dev, val, IRDMA_CCQPSTATUS_CCQP_DONE));\n\n\tdma_free_coherent(cqp->dev->hw->device, cqp->sdbuf.size,\n\t\t\t  cqp->sdbuf.va, cqp->sdbuf.pa);\n\tcqp->sdbuf.va = NULL;\n\treturn ret_code;\n}\n\n \nvoid irdma_sc_ccq_arm(struct irdma_sc_cq *ccq)\n{\n\tu64 temp_val;\n\tu16 sw_cq_sel;\n\tu8 arm_next_se;\n\tu8 arm_seq_num;\n\n\tget_64bit_val(ccq->cq_uk.shadow_area, 32, &temp_val);\n\tsw_cq_sel = (u16)FIELD_GET(IRDMA_CQ_DBSA_SW_CQ_SELECT, temp_val);\n\tarm_next_se = (u8)FIELD_GET(IRDMA_CQ_DBSA_ARM_NEXT_SE, temp_val);\n\tarm_seq_num = (u8)FIELD_GET(IRDMA_CQ_DBSA_ARM_SEQ_NUM, temp_val);\n\tarm_seq_num++;\n\ttemp_val = FIELD_PREP(IRDMA_CQ_DBSA_ARM_SEQ_NUM, arm_seq_num) |\n\t\t   FIELD_PREP(IRDMA_CQ_DBSA_SW_CQ_SELECT, sw_cq_sel) |\n\t\t   FIELD_PREP(IRDMA_CQ_DBSA_ARM_NEXT_SE, arm_next_se) |\n\t\t   FIELD_PREP(IRDMA_CQ_DBSA_ARM_NEXT, 1);\n\tset_64bit_val(ccq->cq_uk.shadow_area, 32, temp_val);\n\n\tdma_wmb();  \n\n\twritel(ccq->cq_uk.cq_id, ccq->dev->cq_arm_db);\n}\n\n \nint irdma_sc_ccq_get_cqe_info(struct irdma_sc_cq *ccq,\n\t\t\t      struct irdma_ccq_cqe_info *info)\n{\n\tu64 qp_ctx, temp, temp1;\n\t__le64 *cqe;\n\tstruct irdma_sc_cqp *cqp;\n\tu32 wqe_idx;\n\tu32 error;\n\tu8 polarity;\n\tint ret_code = 0;\n\n\tif (ccq->cq_uk.avoid_mem_cflct)\n\t\tcqe = IRDMA_GET_CURRENT_EXTENDED_CQ_ELEM(&ccq->cq_uk);\n\telse\n\t\tcqe = IRDMA_GET_CURRENT_CQ_ELEM(&ccq->cq_uk);\n\n\tget_64bit_val(cqe, 24, &temp);\n\tpolarity = (u8)FIELD_GET(IRDMA_CQ_VALID, temp);\n\tif (polarity != ccq->cq_uk.polarity)\n\t\treturn -ENOENT;\n\n\t \n\tdma_rmb();\n\n\tget_64bit_val(cqe, 8, &qp_ctx);\n\tcqp = (struct irdma_sc_cqp *)(unsigned long)qp_ctx;\n\tinfo->error = (bool)FIELD_GET(IRDMA_CQ_ERROR, temp);\n\tinfo->maj_err_code = IRDMA_CQPSQ_MAJ_NO_ERROR;\n\tinfo->min_err_code = (u16)FIELD_GET(IRDMA_CQ_MINERR, temp);\n\tif (info->error) {\n\t\tinfo->maj_err_code = (u16)FIELD_GET(IRDMA_CQ_MAJERR, temp);\n\t\terror = readl(cqp->dev->hw_regs[IRDMA_CQPERRCODES]);\n\t\tibdev_dbg(to_ibdev(cqp->dev),\n\t\t\t  \"CQP: CQPERRCODES error_code[x%08X]\\n\", error);\n\t}\n\n\twqe_idx = (u32)FIELD_GET(IRDMA_CQ_WQEIDX, temp);\n\tinfo->scratch = cqp->scratch_array[wqe_idx];\n\n\tget_64bit_val(cqe, 16, &temp1);\n\tinfo->op_ret_val = (u32)FIELD_GET(IRDMA_CCQ_OPRETVAL, temp1);\n\tget_64bit_val(cqp->sq_base[wqe_idx].elem, 24, &temp1);\n\tinfo->op_code = (u8)FIELD_GET(IRDMA_CQPSQ_OPCODE, temp1);\n\tinfo->cqp = cqp;\n\n\t \n\tIRDMA_RING_MOVE_HEAD(ccq->cq_uk.cq_ring, ret_code);\n\tif (!IRDMA_RING_CURRENT_HEAD(ccq->cq_uk.cq_ring))\n\t\tccq->cq_uk.polarity ^= 1;\n\n\t \n\tIRDMA_RING_MOVE_TAIL(ccq->cq_uk.cq_ring);\n\tset_64bit_val(ccq->cq_uk.shadow_area, 0,\n\t\t      IRDMA_RING_CURRENT_HEAD(ccq->cq_uk.cq_ring));\n\n\tdma_wmb();  \n\n\tIRDMA_RING_MOVE_TAIL(cqp->sq_ring);\n\tatomic64_inc(&cqp->completed_ops);\n\n\treturn ret_code;\n}\n\n \nint irdma_sc_poll_for_cqp_op_done(struct irdma_sc_cqp *cqp, u8 op_code,\n\t\t\t\t  struct irdma_ccq_cqe_info *compl_info)\n{\n\tstruct irdma_ccq_cqe_info info = {};\n\tstruct irdma_sc_cq *ccq;\n\tint ret_code = 0;\n\tu32 cnt = 0;\n\n\tccq = cqp->dev->ccq;\n\twhile (1) {\n\t\tif (cnt++ > 100 * cqp->dev->hw_attrs.max_done_count)\n\t\t\treturn -ETIMEDOUT;\n\n\t\tif (irdma_sc_ccq_get_cqe_info(ccq, &info)) {\n\t\t\tudelay(cqp->dev->hw_attrs.max_sleep_count);\n\t\t\tcontinue;\n\t\t}\n\t\tif (info.error && info.op_code != IRDMA_CQP_OP_QUERY_STAG) {\n\t\t\tret_code = -EIO;\n\t\t\tbreak;\n\t\t}\n\t\t \n\t\tif (op_code == info.op_code)\n\t\t\tbreak;\n\t\tibdev_dbg(to_ibdev(cqp->dev),\n\t\t\t  \"WQE: opcode mismatch for my op code 0x%x, returned opcode %x\\n\",\n\t\t\t  op_code, info.op_code);\n\t}\n\n\tif (compl_info)\n\t\tmemcpy(compl_info, &info, sizeof(*compl_info));\n\n\treturn ret_code;\n}\n\n \nstatic int irdma_sc_manage_hmc_pm_func_table(struct irdma_sc_cqp *cqp,\n\t\t\t\t\t     struct irdma_hmc_fcn_info *info,\n\t\t\t\t\t     u64 scratch, bool post_sq)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 0, 0);\n\tset_64bit_val(wqe, 8, 0);\n\tset_64bit_val(wqe, 16, 0);\n\tset_64bit_val(wqe, 32, 0);\n\tset_64bit_val(wqe, 40, 0);\n\tset_64bit_val(wqe, 48, 0);\n\tset_64bit_val(wqe, 56, 0);\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_MHMC_VFIDX, info->vf_id) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE,\n\t\t\t IRDMA_CQP_OP_MANAGE_HMC_PM_FUNC_TABLE) |\n\t      FIELD_PREP(IRDMA_CQPSQ_MHMC_FREEPMFN, info->free_fcn) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: MANAGE_HMC_PM_FUNC_TABLE WQE\",\n\t\t\t     DUMP_PREFIX_OFFSET, 16, 8, wqe,\n\t\t\t     IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_commit_fpm_val_done(struct irdma_sc_cqp *cqp)\n{\n\treturn irdma_sc_poll_for_cqp_op_done(cqp, IRDMA_CQP_OP_COMMIT_FPM_VAL,\n\t\t\t\t\t     NULL);\n}\n\n \nstatic int irdma_sc_commit_fpm_val(struct irdma_sc_cqp *cqp, u64 scratch,\n\t\t\t\t   u8 hmc_fn_id,\n\t\t\t\t   struct irdma_dma_mem *commit_fpm_mem,\n\t\t\t\t   bool post_sq, u8 wait_type)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\tu32 tail, val, error;\n\tint ret_code = 0;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16, hmc_fn_id);\n\tset_64bit_val(wqe, 32, commit_fpm_mem->pa);\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_BUFSIZE, IRDMA_COMMIT_FPM_BUF_SIZE) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_COMMIT_FPM_VAL) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: COMMIT_FPM_VAL WQE\", DUMP_PREFIX_OFFSET,\n\t\t\t     16, 8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tirdma_get_cqp_reg_info(cqp, &val, &tail, &error);\n\n\tif (post_sq) {\n\t\tirdma_sc_cqp_post_sq(cqp);\n\t\tif (wait_type == IRDMA_CQP_WAIT_POLL_REGS)\n\t\t\tret_code = irdma_cqp_poll_registers(cqp, tail,\n\t\t\t\t\t\t\t    cqp->dev->hw_attrs.max_done_count);\n\t\telse if (wait_type == IRDMA_CQP_WAIT_POLL_CQ)\n\t\t\tret_code = irdma_sc_commit_fpm_val_done(cqp);\n\t}\n\n\treturn ret_code;\n}\n\n \nstatic int irdma_sc_query_fpm_val_done(struct irdma_sc_cqp *cqp)\n{\n\treturn irdma_sc_poll_for_cqp_op_done(cqp, IRDMA_CQP_OP_QUERY_FPM_VAL,\n\t\t\t\t\t     NULL);\n}\n\n \nstatic int irdma_sc_query_fpm_val(struct irdma_sc_cqp *cqp, u64 scratch,\n\t\t\t\t  u8 hmc_fn_id,\n\t\t\t\t  struct irdma_dma_mem *query_fpm_mem,\n\t\t\t\t  bool post_sq, u8 wait_type)\n{\n\t__le64 *wqe;\n\tu64 hdr;\n\tu32 tail, val, error;\n\tint ret_code = 0;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16, hmc_fn_id);\n\tset_64bit_val(wqe, 32, query_fpm_mem->pa);\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_QUERY_FPM_VAL) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: QUERY_FPM WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tirdma_get_cqp_reg_info(cqp, &val, &tail, &error);\n\n\tif (post_sq) {\n\t\tirdma_sc_cqp_post_sq(cqp);\n\t\tif (wait_type == IRDMA_CQP_WAIT_POLL_REGS)\n\t\t\tret_code = irdma_cqp_poll_registers(cqp, tail,\n\t\t\t\t\t\t\t    cqp->dev->hw_attrs.max_done_count);\n\t\telse if (wait_type == IRDMA_CQP_WAIT_POLL_CQ)\n\t\t\tret_code = irdma_sc_query_fpm_val_done(cqp);\n\t}\n\n\treturn ret_code;\n}\n\n \nint irdma_sc_ceq_init(struct irdma_sc_ceq *ceq,\n\t\t      struct irdma_ceq_init_info *info)\n{\n\tu32 pble_obj_cnt;\n\n\tif (info->elem_cnt < info->dev->hw_attrs.min_hw_ceq_size ||\n\t    info->elem_cnt > info->dev->hw_attrs.max_hw_ceq_size)\n\t\treturn -EINVAL;\n\n\tif (info->ceq_id >= info->dev->hmc_fpm_misc.max_ceqs)\n\t\treturn -EINVAL;\n\tpble_obj_cnt = info->dev->hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt;\n\n\tif (info->virtual_map && info->first_pm_pbl_idx >= pble_obj_cnt)\n\t\treturn -EINVAL;\n\n\tceq->size = sizeof(*ceq);\n\tceq->ceqe_base = (struct irdma_ceqe *)info->ceqe_base;\n\tceq->ceq_id = info->ceq_id;\n\tceq->dev = info->dev;\n\tceq->elem_cnt = info->elem_cnt;\n\tceq->ceq_elem_pa = info->ceqe_pa;\n\tceq->virtual_map = info->virtual_map;\n\tceq->itr_no_expire = info->itr_no_expire;\n\tceq->reg_cq = info->reg_cq;\n\tceq->reg_cq_size = 0;\n\tspin_lock_init(&ceq->req_cq_lock);\n\tceq->pbl_chunk_size = (ceq->virtual_map ? info->pbl_chunk_size : 0);\n\tceq->first_pm_pbl_idx = (ceq->virtual_map ? info->first_pm_pbl_idx : 0);\n\tceq->pbl_list = (ceq->virtual_map ? info->pbl_list : NULL);\n\tceq->tph_en = info->tph_en;\n\tceq->tph_val = info->tph_val;\n\tceq->vsi = info->vsi;\n\tceq->polarity = 1;\n\tIRDMA_RING_INIT(ceq->ceq_ring, ceq->elem_cnt);\n\tceq->dev->ceq[info->ceq_id] = ceq;\n\n\treturn 0;\n}\n\n \n\nstatic int irdma_sc_ceq_create(struct irdma_sc_ceq *ceq, u64 scratch,\n\t\t\t       bool post_sq)\n{\n\tstruct irdma_sc_cqp *cqp;\n\t__le64 *wqe;\n\tu64 hdr;\n\n\tcqp = ceq->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\tset_64bit_val(wqe, 16, ceq->elem_cnt);\n\tset_64bit_val(wqe, 32,\n\t\t      (ceq->virtual_map ? 0 : ceq->ceq_elem_pa));\n\tset_64bit_val(wqe, 48,\n\t\t      (ceq->virtual_map ? ceq->first_pm_pbl_idx : 0));\n\tset_64bit_val(wqe, 56,\n\t\t      FIELD_PREP(IRDMA_CQPSQ_TPHVAL, ceq->tph_val) |\n\t\t      FIELD_PREP(IRDMA_CQPSQ_VSIIDX, ceq->vsi->vsi_idx));\n\thdr = FIELD_PREP(IRDMA_CQPSQ_CEQ_CEQID, ceq->ceq_id) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_CREATE_CEQ) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CEQ_LPBLSIZE, ceq->pbl_chunk_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CEQ_VMAP, ceq->virtual_map) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CEQ_ITRNOEXPIRE, ceq->itr_no_expire) |\n\t      FIELD_PREP(IRDMA_CQPSQ_TPHEN, ceq->tph_en) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: CEQ_CREATE WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_cceq_create_done(struct irdma_sc_ceq *ceq)\n{\n\tstruct irdma_sc_cqp *cqp;\n\n\tcqp = ceq->dev->cqp;\n\treturn irdma_sc_poll_for_cqp_op_done(cqp, IRDMA_CQP_OP_CREATE_CEQ,\n\t\t\t\t\t     NULL);\n}\n\n \nint irdma_sc_cceq_destroy_done(struct irdma_sc_ceq *ceq)\n{\n\tstruct irdma_sc_cqp *cqp;\n\n\tif (ceq->reg_cq)\n\t\tirdma_sc_remove_cq_ctx(ceq, ceq->dev->ccq);\n\n\tcqp = ceq->dev->cqp;\n\tcqp->process_cqp_sds = irdma_update_sds_noccq;\n\n\treturn irdma_sc_poll_for_cqp_op_done(cqp, IRDMA_CQP_OP_DESTROY_CEQ,\n\t\t\t\t\t     NULL);\n}\n\n \nint irdma_sc_cceq_create(struct irdma_sc_ceq *ceq, u64 scratch)\n{\n\tint ret_code;\n\tstruct irdma_sc_dev *dev = ceq->dev;\n\n\tdev->ccq->vsi = ceq->vsi;\n\tif (ceq->reg_cq) {\n\t\tret_code = irdma_sc_add_cq_ctx(ceq, ceq->dev->ccq);\n\t\tif (ret_code)\n\t\t\treturn ret_code;\n\t}\n\n\tret_code = irdma_sc_ceq_create(ceq, scratch, true);\n\tif (!ret_code)\n\t\treturn irdma_sc_cceq_create_done(ceq);\n\n\treturn ret_code;\n}\n\n \nint irdma_sc_ceq_destroy(struct irdma_sc_ceq *ceq, u64 scratch, bool post_sq)\n{\n\tstruct irdma_sc_cqp *cqp;\n\t__le64 *wqe;\n\tu64 hdr;\n\n\tcqp = ceq->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16, ceq->elem_cnt);\n\tset_64bit_val(wqe, 48, ceq->first_pm_pbl_idx);\n\thdr = ceq->ceq_id |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_DESTROY_CEQ) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CEQ_LPBLSIZE, ceq->pbl_chunk_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CEQ_VMAP, ceq->virtual_map) |\n\t      FIELD_PREP(IRDMA_CQPSQ_TPHEN, ceq->tph_en) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: CEQ_DESTROY WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nvoid *irdma_sc_process_ceq(struct irdma_sc_dev *dev, struct irdma_sc_ceq *ceq)\n{\n\tu64 temp;\n\t__le64 *ceqe;\n\tstruct irdma_sc_cq *cq = NULL;\n\tstruct irdma_sc_cq *temp_cq;\n\tu8 polarity;\n\tu32 cq_idx;\n\tunsigned long flags;\n\n\tdo {\n\t\tcq_idx = 0;\n\t\tceqe = IRDMA_GET_CURRENT_CEQ_ELEM(ceq);\n\t\tget_64bit_val(ceqe, 0, &temp);\n\t\tpolarity = (u8)FIELD_GET(IRDMA_CEQE_VALID, temp);\n\t\tif (polarity != ceq->polarity)\n\t\t\treturn NULL;\n\n\t\ttemp_cq = (struct irdma_sc_cq *)(unsigned long)(temp << 1);\n\t\tif (!temp_cq) {\n\t\t\tcq_idx = IRDMA_INVALID_CQ_IDX;\n\t\t\tIRDMA_RING_MOVE_TAIL(ceq->ceq_ring);\n\n\t\t\tif (!IRDMA_RING_CURRENT_TAIL(ceq->ceq_ring))\n\t\t\t\tceq->polarity ^= 1;\n\t\t\tcontinue;\n\t\t}\n\n\t\tcq = temp_cq;\n\t\tif (ceq->reg_cq) {\n\t\t\tspin_lock_irqsave(&ceq->req_cq_lock, flags);\n\t\t\tcq_idx = irdma_sc_find_reg_cq(ceq, cq);\n\t\t\tspin_unlock_irqrestore(&ceq->req_cq_lock, flags);\n\t\t}\n\n\t\tIRDMA_RING_MOVE_TAIL(ceq->ceq_ring);\n\t\tif (!IRDMA_RING_CURRENT_TAIL(ceq->ceq_ring))\n\t\t\tceq->polarity ^= 1;\n\t} while (cq_idx == IRDMA_INVALID_CQ_IDX);\n\n\tif (cq)\n\t\tirdma_sc_cq_ack(cq);\n\treturn cq;\n}\n\n \nvoid irdma_sc_cleanup_ceqes(struct irdma_sc_cq *cq, struct irdma_sc_ceq *ceq)\n{\n\tstruct irdma_sc_cq *next_cq;\n\tu8 ceq_polarity = ceq->polarity;\n\t__le64 *ceqe;\n\tu8 polarity;\n\tu64 temp;\n\tint next;\n\tu32 i;\n\n\tnext = IRDMA_RING_GET_NEXT_TAIL(ceq->ceq_ring, 0);\n\n\tfor (i = 1; i <= IRDMA_RING_SIZE(*ceq); i++) {\n\t\tceqe = IRDMA_GET_CEQ_ELEM_AT_POS(ceq, next);\n\n\t\tget_64bit_val(ceqe, 0, &temp);\n\t\tpolarity = (u8)FIELD_GET(IRDMA_CEQE_VALID, temp);\n\t\tif (polarity != ceq_polarity)\n\t\t\treturn;\n\n\t\tnext_cq = (struct irdma_sc_cq *)(unsigned long)(temp << 1);\n\t\tif (cq == next_cq)\n\t\t\tset_64bit_val(ceqe, 0, temp & IRDMA_CEQE_VALID);\n\n\t\tnext = IRDMA_RING_GET_NEXT_TAIL(ceq->ceq_ring, i);\n\t\tif (!next)\n\t\t\tceq_polarity ^= 1;\n\t}\n}\n\n \nint irdma_sc_aeq_init(struct irdma_sc_aeq *aeq,\n\t\t      struct irdma_aeq_init_info *info)\n{\n\tu32 pble_obj_cnt;\n\n\tif (info->elem_cnt < info->dev->hw_attrs.min_hw_aeq_size ||\n\t    info->elem_cnt > info->dev->hw_attrs.max_hw_aeq_size)\n\t\treturn -EINVAL;\n\n\tpble_obj_cnt = info->dev->hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt;\n\n\tif (info->virtual_map && info->first_pm_pbl_idx >= pble_obj_cnt)\n\t\treturn -EINVAL;\n\n\taeq->size = sizeof(*aeq);\n\taeq->polarity = 1;\n\taeq->aeqe_base = (struct irdma_sc_aeqe *)info->aeqe_base;\n\taeq->dev = info->dev;\n\taeq->elem_cnt = info->elem_cnt;\n\taeq->aeq_elem_pa = info->aeq_elem_pa;\n\tIRDMA_RING_INIT(aeq->aeq_ring, aeq->elem_cnt);\n\taeq->virtual_map = info->virtual_map;\n\taeq->pbl_list = (aeq->virtual_map ? info->pbl_list : NULL);\n\taeq->pbl_chunk_size = (aeq->virtual_map ? info->pbl_chunk_size : 0);\n\taeq->first_pm_pbl_idx = (aeq->virtual_map ? info->first_pm_pbl_idx : 0);\n\taeq->msix_idx = info->msix_idx;\n\tinfo->dev->aeq = aeq;\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_aeq_create(struct irdma_sc_aeq *aeq, u64 scratch,\n\t\t\t       bool post_sq)\n{\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\tu64 hdr;\n\n\tcqp = aeq->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\tset_64bit_val(wqe, 16, aeq->elem_cnt);\n\tset_64bit_val(wqe, 32,\n\t\t      (aeq->virtual_map ? 0 : aeq->aeq_elem_pa));\n\tset_64bit_val(wqe, 48,\n\t\t      (aeq->virtual_map ? aeq->first_pm_pbl_idx : 0));\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_CREATE_AEQ) |\n\t      FIELD_PREP(IRDMA_CQPSQ_AEQ_LPBLSIZE, aeq->pbl_chunk_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_AEQ_VMAP, aeq->virtual_map) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: AEQ_CREATE WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nstatic int irdma_sc_aeq_destroy(struct irdma_sc_aeq *aeq, u64 scratch,\n\t\t\t\tbool post_sq)\n{\n\t__le64 *wqe;\n\tstruct irdma_sc_cqp *cqp;\n\tstruct irdma_sc_dev *dev;\n\tu64 hdr;\n\n\tdev = aeq->dev;\n\twritel(0, dev->hw_regs[IRDMA_PFINT_AEQCTL]);\n\n\tcqp = dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\tset_64bit_val(wqe, 16, aeq->elem_cnt);\n\tset_64bit_val(wqe, 48, aeq->first_pm_pbl_idx);\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_DESTROY_AEQ) |\n\t      FIELD_PREP(IRDMA_CQPSQ_AEQ_LPBLSIZE, aeq->pbl_chunk_size) |\n\t      FIELD_PREP(IRDMA_CQPSQ_AEQ_VMAP, aeq->virtual_map) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: AEQ_DESTROY WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tif (post_sq)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\treturn 0;\n}\n\n \nint irdma_sc_get_next_aeqe(struct irdma_sc_aeq *aeq,\n\t\t\t   struct irdma_aeqe_info *info)\n{\n\tu64 temp, compl_ctx;\n\t__le64 *aeqe;\n\tu8 ae_src;\n\tu8 polarity;\n\n\taeqe = IRDMA_GET_CURRENT_AEQ_ELEM(aeq);\n\tget_64bit_val(aeqe, 8, &temp);\n\tpolarity = (u8)FIELD_GET(IRDMA_AEQE_VALID, temp);\n\n\tif (aeq->polarity != polarity)\n\t\treturn -ENOENT;\n\n\t \n\tdma_rmb();\n\n\tget_64bit_val(aeqe, 0, &compl_ctx);\n\n\tprint_hex_dump_debug(\"WQE: AEQ_ENTRY WQE\", DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t     aeqe, 16, false);\n\n\tae_src = (u8)FIELD_GET(IRDMA_AEQE_AESRC, temp);\n\tinfo->wqe_idx = (u16)FIELD_GET(IRDMA_AEQE_WQDESCIDX, temp);\n\tinfo->qp_cq_id = (u32)FIELD_GET(IRDMA_AEQE_QPCQID_LOW, temp) |\n\t\t\t ((u32)FIELD_GET(IRDMA_AEQE_QPCQID_HI, temp) << 18);\n\tinfo->ae_id = (u16)FIELD_GET(IRDMA_AEQE_AECODE, temp);\n\tinfo->tcp_state = (u8)FIELD_GET(IRDMA_AEQE_TCPSTATE, temp);\n\tinfo->iwarp_state = (u8)FIELD_GET(IRDMA_AEQE_IWSTATE, temp);\n\tinfo->q2_data_written = (u8)FIELD_GET(IRDMA_AEQE_Q2DATA, temp);\n\tinfo->aeqe_overflow = (bool)FIELD_GET(IRDMA_AEQE_OVERFLOW, temp);\n\n\tinfo->ae_src = ae_src;\n\tswitch (info->ae_id) {\n\tcase IRDMA_AE_PRIV_OPERATION_DENIED:\n\tcase IRDMA_AE_AMP_INVALIDATE_TYPE1_MW:\n\tcase IRDMA_AE_AMP_MWBIND_ZERO_BASED_TYPE1_MW:\n\tcase IRDMA_AE_AMP_FASTREG_INVALID_PBL_HPS_CFG:\n\tcase IRDMA_AE_AMP_FASTREG_PBLE_MISMATCH:\n\tcase IRDMA_AE_UDA_XMIT_DGRAM_TOO_LONG:\n\tcase IRDMA_AE_UDA_XMIT_BAD_PD:\n\tcase IRDMA_AE_UDA_XMIT_DGRAM_TOO_SHORT:\n\tcase IRDMA_AE_BAD_CLOSE:\n\tcase IRDMA_AE_RDMA_READ_WHILE_ORD_ZERO:\n\tcase IRDMA_AE_STAG_ZERO_INVALID:\n\tcase IRDMA_AE_IB_RREQ_AND_Q1_FULL:\n\tcase IRDMA_AE_IB_INVALID_REQUEST:\n\tcase IRDMA_AE_WQE_UNEXPECTED_OPCODE:\n\tcase IRDMA_AE_IB_REMOTE_ACCESS_ERROR:\n\tcase IRDMA_AE_IB_REMOTE_OP_ERROR:\n\tcase IRDMA_AE_DDP_UBE_INVALID_DDP_VERSION:\n\tcase IRDMA_AE_DDP_UBE_INVALID_MO:\n\tcase IRDMA_AE_DDP_UBE_INVALID_QN:\n\tcase IRDMA_AE_DDP_NO_L_BIT:\n\tcase IRDMA_AE_RDMAP_ROE_INVALID_RDMAP_VERSION:\n\tcase IRDMA_AE_RDMAP_ROE_UNEXPECTED_OPCODE:\n\tcase IRDMA_AE_ROE_INVALID_RDMA_READ_REQUEST:\n\tcase IRDMA_AE_ROE_INVALID_RDMA_WRITE_OR_READ_RESP:\n\tcase IRDMA_AE_ROCE_RSP_LENGTH_ERROR:\n\tcase IRDMA_AE_INVALID_ARP_ENTRY:\n\tcase IRDMA_AE_INVALID_TCP_OPTION_RCVD:\n\tcase IRDMA_AE_STALE_ARP_ENTRY:\n\tcase IRDMA_AE_INVALID_AH_ENTRY:\n\tcase IRDMA_AE_LLP_RECEIVED_MPA_CRC_ERROR:\n\tcase IRDMA_AE_LLP_SEGMENT_TOO_SMALL:\n\tcase IRDMA_AE_LLP_TOO_MANY_RETRIES:\n\tcase IRDMA_AE_LLP_DOUBT_REACHABILITY:\n\tcase IRDMA_AE_LLP_CONNECTION_ESTABLISHED:\n\tcase IRDMA_AE_RESET_SENT:\n\tcase IRDMA_AE_TERMINATE_SENT:\n\tcase IRDMA_AE_RESET_NOT_SENT:\n\tcase IRDMA_AE_LCE_QP_CATASTROPHIC:\n\tcase IRDMA_AE_QP_SUSPEND_COMPLETE:\n\tcase IRDMA_AE_UDA_L4LEN_INVALID:\n\t\tinfo->qp = true;\n\t\tinfo->compl_ctx = compl_ctx;\n\t\tbreak;\n\tcase IRDMA_AE_LCE_CQ_CATASTROPHIC:\n\t\tinfo->cq = true;\n\t\tinfo->compl_ctx = compl_ctx << 1;\n\t\tae_src = IRDMA_AE_SOURCE_RSVD;\n\t\tbreak;\n\tcase IRDMA_AE_ROCE_EMPTY_MCG:\n\tcase IRDMA_AE_ROCE_BAD_MC_IP_ADDR:\n\tcase IRDMA_AE_ROCE_BAD_MC_QPID:\n\tcase IRDMA_AE_MCG_QP_PROTOCOL_MISMATCH:\n\t\tfallthrough;\n\tcase IRDMA_AE_LLP_CONNECTION_RESET:\n\tcase IRDMA_AE_LLP_SYN_RECEIVED:\n\tcase IRDMA_AE_LLP_FIN_RECEIVED:\n\tcase IRDMA_AE_LLP_CLOSE_COMPLETE:\n\tcase IRDMA_AE_LLP_TERMINATE_RECEIVED:\n\tcase IRDMA_AE_RDMAP_ROE_BAD_LLP_CLOSE:\n\t\tae_src = IRDMA_AE_SOURCE_RSVD;\n\t\tinfo->qp = true;\n\t\tinfo->compl_ctx = compl_ctx;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tswitch (ae_src) {\n\tcase IRDMA_AE_SOURCE_RQ:\n\tcase IRDMA_AE_SOURCE_RQ_0011:\n\t\tinfo->qp = true;\n\t\tinfo->rq = true;\n\t\tinfo->compl_ctx = compl_ctx;\n\t\tbreak;\n\tcase IRDMA_AE_SOURCE_CQ:\n\tcase IRDMA_AE_SOURCE_CQ_0110:\n\tcase IRDMA_AE_SOURCE_CQ_1010:\n\tcase IRDMA_AE_SOURCE_CQ_1110:\n\t\tinfo->cq = true;\n\t\tinfo->compl_ctx = compl_ctx << 1;\n\t\tbreak;\n\tcase IRDMA_AE_SOURCE_SQ:\n\tcase IRDMA_AE_SOURCE_SQ_0111:\n\t\tinfo->qp = true;\n\t\tinfo->sq = true;\n\t\tinfo->compl_ctx = compl_ctx;\n\t\tbreak;\n\tcase IRDMA_AE_SOURCE_IN_RR_WR:\n\tcase IRDMA_AE_SOURCE_IN_RR_WR_1011:\n\t\tinfo->qp = true;\n\t\tinfo->compl_ctx = compl_ctx;\n\t\tinfo->in_rdrsp_wr = true;\n\t\tbreak;\n\tcase IRDMA_AE_SOURCE_OUT_RR:\n\tcase IRDMA_AE_SOURCE_OUT_RR_1111:\n\t\tinfo->qp = true;\n\t\tinfo->compl_ctx = compl_ctx;\n\t\tinfo->out_rdrsp = true;\n\t\tbreak;\n\tcase IRDMA_AE_SOURCE_RSVD:\n\tdefault:\n\t\tbreak;\n\t}\n\n\tIRDMA_RING_MOVE_TAIL(aeq->aeq_ring);\n\tif (!IRDMA_RING_CURRENT_TAIL(aeq->aeq_ring))\n\t\taeq->polarity ^= 1;\n\n\treturn 0;\n}\n\n \nvoid irdma_sc_repost_aeq_entries(struct irdma_sc_dev *dev, u32 count)\n{\n\twritel(count, dev->hw_regs[IRDMA_AEQALLOC]);\n}\n\n \nint irdma_sc_ccq_init(struct irdma_sc_cq *cq, struct irdma_ccq_init_info *info)\n{\n\tu32 pble_obj_cnt;\n\n\tif (info->num_elem < info->dev->hw_attrs.uk_attrs.min_hw_cq_size ||\n\t    info->num_elem > info->dev->hw_attrs.uk_attrs.max_hw_cq_size)\n\t\treturn -EINVAL;\n\n\tif (info->ceq_id >= info->dev->hmc_fpm_misc.max_ceqs)\n\t\treturn -EINVAL;\n\n\tpble_obj_cnt = info->dev->hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt;\n\n\tif (info->virtual_map && info->first_pm_pbl_idx >= pble_obj_cnt)\n\t\treturn -EINVAL;\n\n\tcq->cq_pa = info->cq_pa;\n\tcq->cq_uk.cq_base = info->cq_base;\n\tcq->shadow_area_pa = info->shadow_area_pa;\n\tcq->cq_uk.shadow_area = info->shadow_area;\n\tcq->shadow_read_threshold = info->shadow_read_threshold;\n\tcq->dev = info->dev;\n\tcq->ceq_id = info->ceq_id;\n\tcq->cq_uk.cq_size = info->num_elem;\n\tcq->cq_type = IRDMA_CQ_TYPE_CQP;\n\tcq->ceqe_mask = info->ceqe_mask;\n\tIRDMA_RING_INIT(cq->cq_uk.cq_ring, info->num_elem);\n\tcq->cq_uk.cq_id = 0;  \n\tcq->ceq_id_valid = info->ceq_id_valid;\n\tcq->tph_en = info->tph_en;\n\tcq->tph_val = info->tph_val;\n\tcq->cq_uk.avoid_mem_cflct = info->avoid_mem_cflct;\n\tcq->pbl_list = info->pbl_list;\n\tcq->virtual_map = info->virtual_map;\n\tcq->pbl_chunk_size = info->pbl_chunk_size;\n\tcq->first_pm_pbl_idx = info->first_pm_pbl_idx;\n\tcq->cq_uk.polarity = true;\n\tcq->vsi = info->vsi;\n\tcq->cq_uk.cq_ack_db = cq->dev->cq_ack_db;\n\n\t \n\tcq->cq_uk.cqe_alloc_db = NULL;\n\n\tinfo->dev->ccq = cq;\n\treturn 0;\n}\n\n \nstatic inline int irdma_sc_ccq_create_done(struct irdma_sc_cq *ccq)\n{\n\tstruct irdma_sc_cqp *cqp;\n\n\tcqp = ccq->dev->cqp;\n\n\treturn irdma_sc_poll_for_cqp_op_done(cqp, IRDMA_CQP_OP_CREATE_CQ, NULL);\n}\n\n \nint irdma_sc_ccq_create(struct irdma_sc_cq *ccq, u64 scratch,\n\t\t\tbool check_overflow, bool post_sq)\n{\n\tint ret_code;\n\n\tret_code = irdma_sc_cq_create(ccq, scratch, check_overflow, post_sq);\n\tif (ret_code)\n\t\treturn ret_code;\n\n\tif (post_sq) {\n\t\tret_code = irdma_sc_ccq_create_done(ccq);\n\t\tif (ret_code)\n\t\t\treturn ret_code;\n\t}\n\tccq->dev->cqp->process_cqp_sds = irdma_cqp_sds_cmd;\n\n\treturn 0;\n}\n\n \nint irdma_sc_ccq_destroy(struct irdma_sc_cq *ccq, u64 scratch, bool post_sq)\n{\n\tstruct irdma_sc_cqp *cqp;\n\t__le64 *wqe;\n\tu64 hdr;\n\tint ret_code = 0;\n\tu32 tail, val, error;\n\n\tcqp = ccq->dev->cqp;\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 0, ccq->cq_uk.cq_size);\n\tset_64bit_val(wqe, 8, (uintptr_t)ccq >> 1);\n\tset_64bit_val(wqe, 40, ccq->shadow_area_pa);\n\n\thdr = ccq->cq_uk.cq_id |\n\t      FLD_LS_64(ccq->dev, (ccq->ceq_id_valid ? ccq->ceq_id : 0),\n\t\t\tIRDMA_CQPSQ_CQ_CEQID) |\n\t      FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_DESTROY_CQ) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_ENCEQEMASK, ccq->ceqe_mask) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_CEQIDVALID, ccq->ceq_id_valid) |\n\t      FIELD_PREP(IRDMA_CQPSQ_TPHEN, ccq->tph_en) |\n\t      FIELD_PREP(IRDMA_CQPSQ_CQ_AVOIDMEMCNFLCT, ccq->cq_uk.avoid_mem_cflct) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: CCQ_DESTROY WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tirdma_get_cqp_reg_info(cqp, &val, &tail, &error);\n\n\tif (post_sq) {\n\t\tirdma_sc_cqp_post_sq(cqp);\n\t\tret_code = irdma_cqp_poll_registers(cqp, tail,\n\t\t\t\t\t\t    cqp->dev->hw_attrs.max_done_count);\n\t}\n\n\tcqp->process_cqp_sds = irdma_update_sds_noccq;\n\n\treturn ret_code;\n}\n\n \nint irdma_sc_init_iw_hmc(struct irdma_sc_dev *dev, u8 hmc_fn_id)\n{\n\tstruct irdma_hmc_info *hmc_info;\n\tstruct irdma_hmc_fpm_misc *hmc_fpm_misc;\n\tstruct irdma_dma_mem query_fpm_mem;\n\tint ret_code = 0;\n\tu8 wait_type;\n\n\thmc_info = dev->hmc_info;\n\thmc_fpm_misc = &dev->hmc_fpm_misc;\n\tquery_fpm_mem.pa = dev->fpm_query_buf_pa;\n\tquery_fpm_mem.va = dev->fpm_query_buf;\n\thmc_info->hmc_fn_id = hmc_fn_id;\n\twait_type = (u8)IRDMA_CQP_WAIT_POLL_REGS;\n\n\tret_code = irdma_sc_query_fpm_val(dev->cqp, 0, hmc_info->hmc_fn_id,\n\t\t\t\t\t  &query_fpm_mem, true, wait_type);\n\tif (ret_code)\n\t\treturn ret_code;\n\n\t \n\tret_code = irdma_sc_parse_fpm_query_buf(dev, query_fpm_mem.va, hmc_info,\n\t\t\t\t\t\thmc_fpm_misc);\n\n\tprint_hex_dump_debug(\"HMC: QUERY FPM BUFFER\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, query_fpm_mem.va, IRDMA_QUERY_FPM_BUF_SIZE,\n\t\t\t     false);\n\treturn ret_code;\n}\n\n \nstatic int irdma_sc_cfg_iw_fpm(struct irdma_sc_dev *dev, u8 hmc_fn_id)\n{\n\tstruct irdma_hmc_info *hmc_info;\n\tstruct irdma_hmc_obj_info *obj_info;\n\t__le64 *buf;\n\tstruct irdma_dma_mem commit_fpm_mem;\n\tint ret_code = 0;\n\tu8 wait_type;\n\n\thmc_info = dev->hmc_info;\n\tobj_info = hmc_info->hmc_obj;\n\tbuf = dev->fpm_commit_buf;\n\n\tset_64bit_val(buf, 0, (u64)obj_info[IRDMA_HMC_IW_QP].cnt);\n\tset_64bit_val(buf, 8, (u64)obj_info[IRDMA_HMC_IW_CQ].cnt);\n\tset_64bit_val(buf, 16, (u64)0);  \n\tset_64bit_val(buf, 24, (u64)obj_info[IRDMA_HMC_IW_HTE].cnt);\n\tset_64bit_val(buf, 32, (u64)obj_info[IRDMA_HMC_IW_ARP].cnt);\n\tset_64bit_val(buf, 40, (u64)0);  \n\tset_64bit_val(buf, 48, (u64)obj_info[IRDMA_HMC_IW_MR].cnt);\n\tset_64bit_val(buf, 56, (u64)obj_info[IRDMA_HMC_IW_XF].cnt);\n\tset_64bit_val(buf, 64, (u64)obj_info[IRDMA_HMC_IW_XFFL].cnt);\n\tset_64bit_val(buf, 72, (u64)obj_info[IRDMA_HMC_IW_Q1].cnt);\n\tset_64bit_val(buf, 80, (u64)obj_info[IRDMA_HMC_IW_Q1FL].cnt);\n\tset_64bit_val(buf, 88,\n\t\t      (u64)obj_info[IRDMA_HMC_IW_TIMER].cnt);\n\tset_64bit_val(buf, 96,\n\t\t      (u64)obj_info[IRDMA_HMC_IW_FSIMC].cnt);\n\tset_64bit_val(buf, 104,\n\t\t      (u64)obj_info[IRDMA_HMC_IW_FSIAV].cnt);\n\tset_64bit_val(buf, 112,\n\t\t      (u64)obj_info[IRDMA_HMC_IW_PBLE].cnt);\n\tset_64bit_val(buf, 120, (u64)0);  \n\tset_64bit_val(buf, 128, (u64)obj_info[IRDMA_HMC_IW_RRF].cnt);\n\tset_64bit_val(buf, 136,\n\t\t      (u64)obj_info[IRDMA_HMC_IW_RRFFL].cnt);\n\tset_64bit_val(buf, 144, (u64)obj_info[IRDMA_HMC_IW_HDR].cnt);\n\tset_64bit_val(buf, 152, (u64)obj_info[IRDMA_HMC_IW_MD].cnt);\n\tset_64bit_val(buf, 160,\n\t\t      (u64)obj_info[IRDMA_HMC_IW_OOISC].cnt);\n\tset_64bit_val(buf, 168,\n\t\t      (u64)obj_info[IRDMA_HMC_IW_OOISCFFL].cnt);\n\n\tcommit_fpm_mem.pa = dev->fpm_commit_buf_pa;\n\tcommit_fpm_mem.va = dev->fpm_commit_buf;\n\n\twait_type = (u8)IRDMA_CQP_WAIT_POLL_REGS;\n\tprint_hex_dump_debug(\"HMC: COMMIT FPM BUFFER\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, commit_fpm_mem.va, IRDMA_COMMIT_FPM_BUF_SIZE,\n\t\t\t     false);\n\tret_code = irdma_sc_commit_fpm_val(dev->cqp, 0, hmc_info->hmc_fn_id,\n\t\t\t\t\t   &commit_fpm_mem, true, wait_type);\n\tif (!ret_code)\n\t\tirdma_sc_parse_fpm_commit_buf(dev, dev->fpm_commit_buf,\n\t\t\t\t\t      hmc_info->hmc_obj,\n\t\t\t\t\t      &hmc_info->sd_table.sd_cnt);\n\tprint_hex_dump_debug(\"HMC: COMMIT FPM BUFFER\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, commit_fpm_mem.va, IRDMA_COMMIT_FPM_BUF_SIZE,\n\t\t\t     false);\n\n\treturn ret_code;\n}\n\n \nstatic int cqp_sds_wqe_fill(struct irdma_sc_cqp *cqp,\n\t\t\t    struct irdma_update_sds_info *info, u64 scratch)\n{\n\tu64 data;\n\tu64 hdr;\n\t__le64 *wqe;\n\tint mem_entries, wqe_entries;\n\tstruct irdma_dma_mem *sdbuf = &cqp->sdbuf;\n\tu64 offset = 0;\n\tu32 wqe_idx;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe_idx(cqp, scratch, &wqe_idx);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\twqe_entries = (info->cnt > 3) ? 3 : info->cnt;\n\tmem_entries = info->cnt - wqe_entries;\n\n\tif (mem_entries) {\n\t\toffset = wqe_idx * IRDMA_UPDATE_SD_BUFF_SIZE;\n\t\tmemcpy(((char *)sdbuf->va + offset), &info->entry[3], mem_entries << 4);\n\n\t\tdata = (u64)sdbuf->pa + offset;\n\t} else {\n\t\tdata = 0;\n\t}\n\tdata |= FIELD_PREP(IRDMA_CQPSQ_UPESD_HMCFNID, info->hmc_fn_id);\n\tset_64bit_val(wqe, 16, data);\n\n\tswitch (wqe_entries) {\n\tcase 3:\n\t\tset_64bit_val(wqe, 48,\n\t\t\t      (FIELD_PREP(IRDMA_CQPSQ_UPESD_SDCMD, info->entry[2].cmd) |\n\t\t\t       FIELD_PREP(IRDMA_CQPSQ_UPESD_ENTRY_VALID, 1)));\n\n\t\tset_64bit_val(wqe, 56, info->entry[2].data);\n\t\tfallthrough;\n\tcase 2:\n\t\tset_64bit_val(wqe, 32,\n\t\t\t      (FIELD_PREP(IRDMA_CQPSQ_UPESD_SDCMD, info->entry[1].cmd) |\n\t\t\t       FIELD_PREP(IRDMA_CQPSQ_UPESD_ENTRY_VALID, 1)));\n\n\t\tset_64bit_val(wqe, 40, info->entry[1].data);\n\t\tfallthrough;\n\tcase 1:\n\t\tset_64bit_val(wqe, 0,\n\t\t\t      FIELD_PREP(IRDMA_CQPSQ_UPESD_SDCMD, info->entry[0].cmd));\n\n\t\tset_64bit_val(wqe, 8, info->entry[0].data);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE, IRDMA_CQP_OP_UPDATE_PE_SDS) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity) |\n\t      FIELD_PREP(IRDMA_CQPSQ_UPESD_ENTRY_COUNT, mem_entries);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tif (mem_entries)\n\t\tprint_hex_dump_debug(\"WQE: UPDATE_PE_SDS WQE Buffer\",\n\t\t\t\t     DUMP_PREFIX_OFFSET, 16, 8,\n\t\t\t\t     (char *)sdbuf->va + offset,\n\t\t\t\t     mem_entries << 4, false);\n\n\tprint_hex_dump_debug(\"WQE: UPDATE_PE_SDS WQE\", DUMP_PREFIX_OFFSET, 16,\n\t\t\t     8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\n\treturn 0;\n}\n\n \nstatic int irdma_update_pe_sds(struct irdma_sc_dev *dev,\n\t\t\t       struct irdma_update_sds_info *info, u64 scratch)\n{\n\tstruct irdma_sc_cqp *cqp = dev->cqp;\n\tint ret_code;\n\n\tret_code = cqp_sds_wqe_fill(cqp, info, scratch);\n\tif (!ret_code)\n\t\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn ret_code;\n}\n\n \nint irdma_update_sds_noccq(struct irdma_sc_dev *dev,\n\t\t\t   struct irdma_update_sds_info *info)\n{\n\tu32 error, val, tail;\n\tstruct irdma_sc_cqp *cqp = dev->cqp;\n\tint ret_code;\n\n\tret_code = cqp_sds_wqe_fill(cqp, info, 0);\n\tif (ret_code)\n\t\treturn ret_code;\n\n\tirdma_get_cqp_reg_info(cqp, &val, &tail, &error);\n\n\tirdma_sc_cqp_post_sq(cqp);\n\treturn irdma_cqp_poll_registers(cqp, tail,\n\t\t\t\t\tcqp->dev->hw_attrs.max_done_count);\n}\n\n \nint irdma_sc_static_hmc_pages_allocated(struct irdma_sc_cqp *cqp, u64 scratch,\n\t\t\t\t\tu8 hmc_fn_id, bool post_sq,\n\t\t\t\t\tbool poll_registers)\n{\n\tu64 hdr;\n\t__le64 *wqe;\n\tu32 tail, val, error;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\tset_64bit_val(wqe, 16,\n\t\t      FIELD_PREP(IRDMA_SHMC_PAGE_ALLOCATED_HMC_FN_ID, hmc_fn_id));\n\n\thdr = FIELD_PREP(IRDMA_CQPSQ_OPCODE,\n\t\t\t IRDMA_CQP_OP_SHMC_PAGES_ALLOCATED) |\n\t      FIELD_PREP(IRDMA_CQPSQ_WQEVALID, cqp->polarity);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, hdr);\n\n\tprint_hex_dump_debug(\"WQE: SHMC_PAGES_ALLOCATED WQE\",\n\t\t\t     DUMP_PREFIX_OFFSET, 16, 8, wqe,\n\t\t\t     IRDMA_CQP_WQE_SIZE * 8, false);\n\tirdma_get_cqp_reg_info(cqp, &val, &tail, &error);\n\n\tif (post_sq) {\n\t\tirdma_sc_cqp_post_sq(cqp);\n\t\tif (poll_registers)\n\t\t\t \n\t\t\treturn irdma_cqp_poll_registers(cqp, tail,\n\t\t\t\t\t\t\tcqp->dev->hw_attrs.max_done_count);\n\t\telse\n\t\t\treturn irdma_sc_poll_for_cqp_op_done(cqp,\n\t\t\t\t\t\t\t     IRDMA_CQP_OP_SHMC_PAGES_ALLOCATED,\n\t\t\t\t\t\t\t     NULL);\n\t}\n\n\treturn 0;\n}\n\n \nstatic bool irdma_cqp_ring_full(struct irdma_sc_cqp *cqp)\n{\n\treturn IRDMA_RING_FULL_ERR(cqp->sq_ring);\n}\n\n \nstatic u32 irdma_est_sd(struct irdma_sc_dev *dev,\n\t\t\tstruct irdma_hmc_info *hmc_info)\n{\n\tint i;\n\tu64 size = 0;\n\tu64 sd;\n\n\tfor (i = IRDMA_HMC_IW_QP; i < IRDMA_HMC_IW_MAX; i++)\n\t\tif (i != IRDMA_HMC_IW_PBLE)\n\t\t\tsize += round_up(hmc_info->hmc_obj[i].cnt *\n\t\t\t\t\t hmc_info->hmc_obj[i].size, 512);\n\tsize += round_up(hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt *\n\t\t\t hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].size, 512);\n\tif (size & 0x1FFFFF)\n\t\tsd = (size >> 21) + 1;  \n\telse\n\t\tsd = size >> 21;\n\tif (sd > 0xFFFFFFFF) {\n\t\tibdev_dbg(to_ibdev(dev), \"HMC: sd overflow[%lld]\\n\", sd);\n\t\tsd = 0xFFFFFFFF - 1;\n\t}\n\n\treturn (u32)sd;\n}\n\n \nstatic int irdma_sc_query_rdma_features_done(struct irdma_sc_cqp *cqp)\n{\n\treturn irdma_sc_poll_for_cqp_op_done(cqp,\n\t\t\t\t\t     IRDMA_CQP_OP_QUERY_RDMA_FEATURES,\n\t\t\t\t\t     NULL);\n}\n\n \nstatic int irdma_sc_query_rdma_features(struct irdma_sc_cqp *cqp,\n\t\t\t\t\tstruct irdma_dma_mem *buf, u64 scratch)\n{\n\t__le64 *wqe;\n\tu64 temp;\n\n\twqe = irdma_sc_cqp_get_next_send_wqe(cqp, scratch);\n\tif (!wqe)\n\t\treturn -ENOMEM;\n\n\ttemp = buf->pa;\n\tset_64bit_val(wqe, 32, temp);\n\n\ttemp = FIELD_PREP(IRDMA_CQPSQ_QUERY_RDMA_FEATURES_WQEVALID,\n\t\t\t  cqp->polarity) |\n\t       FIELD_PREP(IRDMA_CQPSQ_QUERY_RDMA_FEATURES_BUF_LEN, buf->size) |\n\t       FIELD_PREP(IRDMA_CQPSQ_UP_OP, IRDMA_CQP_OP_QUERY_RDMA_FEATURES);\n\tdma_wmb();  \n\n\tset_64bit_val(wqe, 24, temp);\n\n\tprint_hex_dump_debug(\"WQE: QUERY RDMA FEATURES\", DUMP_PREFIX_OFFSET,\n\t\t\t     16, 8, wqe, IRDMA_CQP_WQE_SIZE * 8, false);\n\tirdma_sc_cqp_post_sq(cqp);\n\n\treturn 0;\n}\n\n \nint irdma_get_rdma_features(struct irdma_sc_dev *dev)\n{\n\tint ret_code;\n\tstruct irdma_dma_mem feat_buf;\n\tu64 temp;\n\tu16 byte_idx, feat_type, feat_cnt, feat_idx;\n\n\tfeat_buf.size = ALIGN(IRDMA_FEATURE_BUF_SIZE,\n\t\t\t      IRDMA_FEATURE_BUF_ALIGNMENT);\n\tfeat_buf.va = dma_alloc_coherent(dev->hw->device, feat_buf.size,\n\t\t\t\t\t &feat_buf.pa, GFP_KERNEL);\n\tif (!feat_buf.va)\n\t\treturn -ENOMEM;\n\n\tret_code = irdma_sc_query_rdma_features(dev->cqp, &feat_buf, 0);\n\tif (!ret_code)\n\t\tret_code = irdma_sc_query_rdma_features_done(dev->cqp);\n\tif (ret_code)\n\t\tgoto exit;\n\n\tget_64bit_val(feat_buf.va, 0, &temp);\n\tfeat_cnt = (u16)FIELD_GET(IRDMA_FEATURE_CNT, temp);\n\tif (feat_cnt < 2) {\n\t\tret_code = -EINVAL;\n\t\tgoto exit;\n\t} else if (feat_cnt > IRDMA_MAX_FEATURES) {\n\t\tibdev_dbg(to_ibdev(dev),\n\t\t\t  \"DEV: feature buf size insufficient, retrying with larger buffer\\n\");\n\t\tdma_free_coherent(dev->hw->device, feat_buf.size, feat_buf.va,\n\t\t\t\t  feat_buf.pa);\n\t\tfeat_buf.va = NULL;\n\t\tfeat_buf.size = ALIGN(8 * feat_cnt,\n\t\t\t\t      IRDMA_FEATURE_BUF_ALIGNMENT);\n\t\tfeat_buf.va = dma_alloc_coherent(dev->hw->device,\n\t\t\t\t\t\t feat_buf.size, &feat_buf.pa,\n\t\t\t\t\t\t GFP_KERNEL);\n\t\tif (!feat_buf.va)\n\t\t\treturn -ENOMEM;\n\n\t\tret_code = irdma_sc_query_rdma_features(dev->cqp, &feat_buf, 0);\n\t\tif (!ret_code)\n\t\t\tret_code = irdma_sc_query_rdma_features_done(dev->cqp);\n\t\tif (ret_code)\n\t\t\tgoto exit;\n\n\t\tget_64bit_val(feat_buf.va, 0, &temp);\n\t\tfeat_cnt = (u16)FIELD_GET(IRDMA_FEATURE_CNT, temp);\n\t\tif (feat_cnt < 2) {\n\t\t\tret_code = -EINVAL;\n\t\t\tgoto exit;\n\t\t}\n\t}\n\n\tprint_hex_dump_debug(\"WQE: QUERY RDMA FEATURES\", DUMP_PREFIX_OFFSET,\n\t\t\t     16, 8, feat_buf.va, feat_cnt * 8, false);\n\n\tfor (byte_idx = 0, feat_idx = 0; feat_idx < min(feat_cnt, (u16)IRDMA_MAX_FEATURES);\n\t     feat_idx++, byte_idx += 8) {\n\t\tget_64bit_val(feat_buf.va, byte_idx, &temp);\n\t\tfeat_type = FIELD_GET(IRDMA_FEATURE_TYPE, temp);\n\t\tif (feat_type >= IRDMA_MAX_FEATURES) {\n\t\t\tibdev_dbg(to_ibdev(dev),\n\t\t\t\t  \"DEV: found unrecognized feature type %d\\n\",\n\t\t\t\t  feat_type);\n\t\t\tcontinue;\n\t\t}\n\t\tdev->feature_info[feat_type] = temp;\n\t}\nexit:\n\tdma_free_coherent(dev->hw->device, feat_buf.size, feat_buf.va,\n\t\t\t  feat_buf.pa);\n\tfeat_buf.va = NULL;\n\treturn ret_code;\n}\n\nstatic u32 irdma_q1_cnt(struct irdma_sc_dev *dev,\n\t\t\tstruct irdma_hmc_info *hmc_info, u32 qpwanted)\n{\n\tu32 q1_cnt;\n\n\tif (dev->hw_attrs.uk_attrs.hw_rev == IRDMA_GEN_1) {\n\t\tq1_cnt = roundup_pow_of_two(dev->hw_attrs.max_hw_ird * 2 * qpwanted);\n\t} else {\n\t\tif (dev->cqp->protocol_used != IRDMA_IWARP_PROTOCOL_ONLY)\n\t\t\tq1_cnt = roundup_pow_of_two(dev->hw_attrs.max_hw_ird * 2 * qpwanted + 512);\n\t\telse\n\t\t\tq1_cnt = dev->hw_attrs.max_hw_ird * 2 * qpwanted;\n\t}\n\n\treturn q1_cnt;\n}\n\nstatic void cfg_fpm_value_gen_1(struct irdma_sc_dev *dev,\n\t\t\t\tstruct irdma_hmc_info *hmc_info, u32 qpwanted)\n{\n\thmc_info->hmc_obj[IRDMA_HMC_IW_XF].cnt = roundup_pow_of_two(qpwanted * dev->hw_attrs.max_hw_wqes);\n}\n\nstatic void cfg_fpm_value_gen_2(struct irdma_sc_dev *dev,\n\t\t\t\tstruct irdma_hmc_info *hmc_info, u32 qpwanted)\n{\n\tstruct irdma_hmc_fpm_misc *hmc_fpm_misc = &dev->hmc_fpm_misc;\n\n\thmc_info->hmc_obj[IRDMA_HMC_IW_XF].cnt =\n\t\t4 * hmc_fpm_misc->xf_block_size * qpwanted;\n\n\thmc_info->hmc_obj[IRDMA_HMC_IW_HDR].cnt = qpwanted;\n\n\tif (hmc_info->hmc_obj[IRDMA_HMC_IW_RRF].max_cnt)\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_RRF].cnt = 32 * qpwanted;\n\tif (hmc_info->hmc_obj[IRDMA_HMC_IW_RRFFL].max_cnt)\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_RRFFL].cnt =\n\t\t\thmc_info->hmc_obj[IRDMA_HMC_IW_RRF].cnt /\n\t\t\thmc_fpm_misc->rrf_block_size;\n\tif (hmc_info->hmc_obj[IRDMA_HMC_IW_OOISC].max_cnt)\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_OOISC].cnt = 32 * qpwanted;\n\tif (hmc_info->hmc_obj[IRDMA_HMC_IW_OOISCFFL].max_cnt)\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_OOISCFFL].cnt =\n\t\t\thmc_info->hmc_obj[IRDMA_HMC_IW_OOISC].cnt /\n\t\t\thmc_fpm_misc->ooiscf_block_size;\n}\n\n \nint irdma_cfg_fpm_val(struct irdma_sc_dev *dev, u32 qp_count)\n{\n\tstruct irdma_virt_mem virt_mem;\n\tu32 i, mem_size;\n\tu32 qpwanted, mrwanted, pblewanted;\n\tu32 powerof2, hte;\n\tu32 sd_needed;\n\tu32 sd_diff;\n\tu32 loop_count = 0;\n\tstruct irdma_hmc_info *hmc_info;\n\tstruct irdma_hmc_fpm_misc *hmc_fpm_misc;\n\tint ret_code = 0;\n\n\thmc_info = dev->hmc_info;\n\thmc_fpm_misc = &dev->hmc_fpm_misc;\n\n\tret_code = irdma_sc_init_iw_hmc(dev, dev->hmc_fn_id);\n\tif (ret_code) {\n\t\tibdev_dbg(to_ibdev(dev),\n\t\t\t  \"HMC: irdma_sc_init_iw_hmc returned error_code = %d\\n\",\n\t\t\t  ret_code);\n\t\treturn ret_code;\n\t}\n\n\tfor (i = IRDMA_HMC_IW_QP; i < IRDMA_HMC_IW_MAX; i++)\n\t\thmc_info->hmc_obj[i].cnt = hmc_info->hmc_obj[i].max_cnt;\n\tsd_needed = irdma_est_sd(dev, hmc_info);\n\tibdev_dbg(to_ibdev(dev),\n\t\t  \"HMC: FW max resources sd_needed[%08d] first_sd_index[%04d]\\n\",\n\t\t  sd_needed, hmc_info->first_sd_index);\n\tibdev_dbg(to_ibdev(dev), \"HMC: sd count %d where max sd is %d\\n\",\n\t\t  hmc_info->sd_table.sd_cnt, hmc_fpm_misc->max_sds);\n\n\tqpwanted = min(qp_count, hmc_info->hmc_obj[IRDMA_HMC_IW_QP].max_cnt);\n\n\tpowerof2 = 1;\n\twhile (powerof2 <= qpwanted)\n\t\tpowerof2 *= 2;\n\tpowerof2 /= 2;\n\tqpwanted = powerof2;\n\n\tmrwanted = hmc_info->hmc_obj[IRDMA_HMC_IW_MR].max_cnt;\n\tpblewanted = hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].max_cnt;\n\n\tibdev_dbg(to_ibdev(dev),\n\t\t  \"HMC: req_qp=%d max_sd=%d, max_qp = %d, max_cq=%d, max_mr=%d, max_pble=%d, mc=%d, av=%d\\n\",\n\t\t  qp_count, hmc_fpm_misc->max_sds,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_QP].max_cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_CQ].max_cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_MR].max_cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].max_cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_FSIMC].max_cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_FSIAV].max_cnt);\n\thmc_info->hmc_obj[IRDMA_HMC_IW_FSIMC].cnt =\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_FSIMC].max_cnt;\n\thmc_info->hmc_obj[IRDMA_HMC_IW_FSIAV].cnt =\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_FSIAV].max_cnt;\n\thmc_info->hmc_obj[IRDMA_HMC_IW_ARP].cnt =\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_ARP].max_cnt;\n\n\thmc_info->hmc_obj[IRDMA_HMC_IW_APBVT_ENTRY].cnt = 1;\n\n\twhile (irdma_q1_cnt(dev, hmc_info, qpwanted) > hmc_info->hmc_obj[IRDMA_HMC_IW_Q1].max_cnt)\n\t\tqpwanted /= 2;\n\n\tdo {\n\t\t++loop_count;\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_QP].cnt = qpwanted;\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_CQ].cnt =\n\t\t\tmin(2 * qpwanted, hmc_info->hmc_obj[IRDMA_HMC_IW_CQ].cnt);\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_RESERVED].cnt = 0;  \n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_MR].cnt = mrwanted;\n\n\t\thte = round_up(qpwanted + hmc_info->hmc_obj[IRDMA_HMC_IW_FSIMC].cnt, 512);\n\t\tpowerof2 = 1;\n\t\twhile (powerof2 < hte)\n\t\t\tpowerof2 *= 2;\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_HTE].cnt =\n\t\t\tpowerof2 * hmc_fpm_misc->ht_multiplier;\n\t\tif (dev->hw_attrs.uk_attrs.hw_rev == IRDMA_GEN_1)\n\t\t\tcfg_fpm_value_gen_1(dev, hmc_info, qpwanted);\n\t\telse\n\t\t\tcfg_fpm_value_gen_2(dev, hmc_info, qpwanted);\n\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_Q1].cnt = irdma_q1_cnt(dev, hmc_info, qpwanted);\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_XFFL].cnt =\n\t\t\thmc_info->hmc_obj[IRDMA_HMC_IW_XF].cnt / hmc_fpm_misc->xf_block_size;\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_Q1FL].cnt =\n\t\t\thmc_info->hmc_obj[IRDMA_HMC_IW_Q1].cnt / hmc_fpm_misc->q1_block_size;\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_TIMER].cnt =\n\t\t\t(round_up(qpwanted, 512) / 512 + 1) * hmc_fpm_misc->timer_bucket;\n\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt = pblewanted;\n\t\tsd_needed = irdma_est_sd(dev, hmc_info);\n\t\tibdev_dbg(to_ibdev(dev),\n\t\t\t  \"HMC: sd_needed = %d, hmc_fpm_misc->max_sds=%d, mrwanted=%d, pblewanted=%d qpwanted=%d\\n\",\n\t\t\t  sd_needed, hmc_fpm_misc->max_sds, mrwanted,\n\t\t\t  pblewanted, qpwanted);\n\n\t\t \n\t\tif (sd_needed <= hmc_fpm_misc->max_sds)\n\t\t\tbreak;\n\n\t\tsd_diff = sd_needed - hmc_fpm_misc->max_sds;\n\t\tif (sd_diff > 128) {\n\t\t\tif (!(loop_count % 2) && qpwanted > 128) {\n\t\t\t\tqpwanted /= 2;\n\t\t\t} else {\n\t\t\t\tmrwanted /= 2;\n\t\t\t\tpblewanted /= 2;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\tif (dev->cqp->hmc_profile != IRDMA_HMC_PROFILE_FAVOR_VF &&\n\t\t    pblewanted > (512 * FPM_MULTIPLIER * sd_diff)) {\n\t\t\tpblewanted -= 256 * FPM_MULTIPLIER * sd_diff;\n\t\t\tcontinue;\n\t\t} else if (pblewanted > (100 * FPM_MULTIPLIER)) {\n\t\t\tpblewanted -= 10 * FPM_MULTIPLIER;\n\t\t} else if (pblewanted > FPM_MULTIPLIER) {\n\t\t\tpblewanted -= FPM_MULTIPLIER;\n\t\t} else if (qpwanted <= 128) {\n\t\t\tif (hmc_info->hmc_obj[IRDMA_HMC_IW_FSIMC].cnt > 256)\n\t\t\t\thmc_info->hmc_obj[IRDMA_HMC_IW_FSIMC].cnt /= 2;\n\t\t\tif (hmc_info->hmc_obj[IRDMA_HMC_IW_FSIAV].cnt > 256)\n\t\t\t\thmc_info->hmc_obj[IRDMA_HMC_IW_FSIAV].cnt /= 2;\n\t\t}\n\t\tif (mrwanted > FPM_MULTIPLIER)\n\t\t\tmrwanted -= FPM_MULTIPLIER;\n\t\tif (!(loop_count % 10) && qpwanted > 128) {\n\t\t\tqpwanted /= 2;\n\t\t\tif (hmc_info->hmc_obj[IRDMA_HMC_IW_FSIAV].cnt > 256)\n\t\t\t\thmc_info->hmc_obj[IRDMA_HMC_IW_FSIAV].cnt /= 2;\n\t\t}\n\t} while (loop_count < 2000);\n\n\tif (sd_needed > hmc_fpm_misc->max_sds) {\n\t\tibdev_dbg(to_ibdev(dev),\n\t\t\t  \"HMC: cfg_fpm failed loop_cnt=%d, sd_needed=%d, max sd count %d\\n\",\n\t\t\t  loop_count, sd_needed, hmc_info->sd_table.sd_cnt);\n\t\treturn -EINVAL;\n\t}\n\n\tif (loop_count > 1 && sd_needed < hmc_fpm_misc->max_sds) {\n\t\tpblewanted += (hmc_fpm_misc->max_sds - sd_needed) * 256 *\n\t\t\t      FPM_MULTIPLIER;\n\t\thmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt = pblewanted;\n\t\tsd_needed = irdma_est_sd(dev, hmc_info);\n\t}\n\n\tibdev_dbg(to_ibdev(dev),\n\t\t  \"HMC: loop_cnt=%d, sd_needed=%d, qpcnt = %d, cqcnt=%d, mrcnt=%d, pblecnt=%d, mc=%d, ah=%d, max sd count %d, first sd index %d\\n\",\n\t\t  loop_count, sd_needed,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_QP].cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_CQ].cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_MR].cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_PBLE].cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_FSIMC].cnt,\n\t\t  hmc_info->hmc_obj[IRDMA_HMC_IW_FSIAV].cnt,\n\t\t  hmc_info->sd_table.sd_cnt, hmc_info->first_sd_index);\n\n\tret_code = irdma_sc_cfg_iw_fpm(dev, dev->hmc_fn_id);\n\tif (ret_code) {\n\t\tibdev_dbg(to_ibdev(dev),\n\t\t\t  \"HMC: cfg_iw_fpm returned error_code[x%08X]\\n\",\n\t\t\t  readl(dev->hw_regs[IRDMA_CQPERRCODES]));\n\t\treturn ret_code;\n\t}\n\n\tmem_size = sizeof(struct irdma_hmc_sd_entry) *\n\t\t   (hmc_info->sd_table.sd_cnt + hmc_info->first_sd_index + 1);\n\tvirt_mem.size = mem_size;\n\tvirt_mem.va = kzalloc(virt_mem.size, GFP_KERNEL);\n\tif (!virt_mem.va) {\n\t\tibdev_dbg(to_ibdev(dev),\n\t\t\t  \"HMC: failed to allocate memory for sd_entry buffer\\n\");\n\t\treturn -ENOMEM;\n\t}\n\thmc_info->sd_table.sd_entry = virt_mem.va;\n\n\treturn ret_code;\n}\n\n \nstatic int irdma_exec_cqp_cmd(struct irdma_sc_dev *dev,\n\t\t\t      struct cqp_cmds_info *pcmdinfo)\n{\n\tint status;\n\tstruct irdma_dma_mem val_mem;\n\tbool alloc = false;\n\n\tdev->cqp_cmd_stats[pcmdinfo->cqp_cmd]++;\n\tswitch (pcmdinfo->cqp_cmd) {\n\tcase IRDMA_OP_CEQ_DESTROY:\n\t\tstatus = irdma_sc_ceq_destroy(pcmdinfo->in.u.ceq_destroy.ceq,\n\t\t\t\t\t      pcmdinfo->in.u.ceq_destroy.scratch,\n\t\t\t\t\t      pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_AEQ_DESTROY:\n\t\tstatus = irdma_sc_aeq_destroy(pcmdinfo->in.u.aeq_destroy.aeq,\n\t\t\t\t\t      pcmdinfo->in.u.aeq_destroy.scratch,\n\t\t\t\t\t      pcmdinfo->post_sq);\n\n\t\tbreak;\n\tcase IRDMA_OP_CEQ_CREATE:\n\t\tstatus = irdma_sc_ceq_create(pcmdinfo->in.u.ceq_create.ceq,\n\t\t\t\t\t     pcmdinfo->in.u.ceq_create.scratch,\n\t\t\t\t\t     pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_AEQ_CREATE:\n\t\tstatus = irdma_sc_aeq_create(pcmdinfo->in.u.aeq_create.aeq,\n\t\t\t\t\t     pcmdinfo->in.u.aeq_create.scratch,\n\t\t\t\t\t     pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_QP_UPLOAD_CONTEXT:\n\t\tstatus = irdma_sc_qp_upload_context(pcmdinfo->in.u.qp_upload_context.dev,\n\t\t\t\t\t\t    &pcmdinfo->in.u.qp_upload_context.info,\n\t\t\t\t\t\t    pcmdinfo->in.u.qp_upload_context.scratch,\n\t\t\t\t\t\t    pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_CQ_CREATE:\n\t\tstatus = irdma_sc_cq_create(pcmdinfo->in.u.cq_create.cq,\n\t\t\t\t\t    pcmdinfo->in.u.cq_create.scratch,\n\t\t\t\t\t    pcmdinfo->in.u.cq_create.check_overflow,\n\t\t\t\t\t    pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_CQ_MODIFY:\n\t\tstatus = irdma_sc_cq_modify(pcmdinfo->in.u.cq_modify.cq,\n\t\t\t\t\t    &pcmdinfo->in.u.cq_modify.info,\n\t\t\t\t\t    pcmdinfo->in.u.cq_modify.scratch,\n\t\t\t\t\t    pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_CQ_DESTROY:\n\t\tstatus = irdma_sc_cq_destroy(pcmdinfo->in.u.cq_destroy.cq,\n\t\t\t\t\t     pcmdinfo->in.u.cq_destroy.scratch,\n\t\t\t\t\t     pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_QP_FLUSH_WQES:\n\t\tstatus = irdma_sc_qp_flush_wqes(pcmdinfo->in.u.qp_flush_wqes.qp,\n\t\t\t\t\t\t&pcmdinfo->in.u.qp_flush_wqes.info,\n\t\t\t\t\t\tpcmdinfo->in.u.qp_flush_wqes.scratch,\n\t\t\t\t\t\tpcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_GEN_AE:\n\t\tstatus = irdma_sc_gen_ae(pcmdinfo->in.u.gen_ae.qp,\n\t\t\t\t\t &pcmdinfo->in.u.gen_ae.info,\n\t\t\t\t\t pcmdinfo->in.u.gen_ae.scratch,\n\t\t\t\t\t pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_MANAGE_PUSH_PAGE:\n\t\tstatus = irdma_sc_manage_push_page(pcmdinfo->in.u.manage_push_page.cqp,\n\t\t\t\t\t\t   &pcmdinfo->in.u.manage_push_page.info,\n\t\t\t\t\t\t   pcmdinfo->in.u.manage_push_page.scratch,\n\t\t\t\t\t\t   pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_UPDATE_PE_SDS:\n\t\tstatus = irdma_update_pe_sds(pcmdinfo->in.u.update_pe_sds.dev,\n\t\t\t\t\t     &pcmdinfo->in.u.update_pe_sds.info,\n\t\t\t\t\t     pcmdinfo->in.u.update_pe_sds.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_MANAGE_HMC_PM_FUNC_TABLE:\n\t\t \n\t\tstatus =\n\t\t\tirdma_sc_manage_hmc_pm_func_table(pcmdinfo->in.u.manage_hmc_pm.dev->cqp,\n\t\t\t\t\t\t\t  &pcmdinfo->in.u.manage_hmc_pm.info,\n\t\t\t\t\t\t\t  pcmdinfo->in.u.manage_hmc_pm.scratch,\n\t\t\t\t\t\t\t  true);\n\t\tbreak;\n\tcase IRDMA_OP_SUSPEND:\n\t\tstatus = irdma_sc_suspend_qp(pcmdinfo->in.u.suspend_resume.cqp,\n\t\t\t\t\t     pcmdinfo->in.u.suspend_resume.qp,\n\t\t\t\t\t     pcmdinfo->in.u.suspend_resume.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_RESUME:\n\t\tstatus = irdma_sc_resume_qp(pcmdinfo->in.u.suspend_resume.cqp,\n\t\t\t\t\t    pcmdinfo->in.u.suspend_resume.qp,\n\t\t\t\t\t    pcmdinfo->in.u.suspend_resume.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_QUERY_FPM_VAL:\n\t\tval_mem.pa = pcmdinfo->in.u.query_fpm_val.fpm_val_pa;\n\t\tval_mem.va = pcmdinfo->in.u.query_fpm_val.fpm_val_va;\n\t\tstatus = irdma_sc_query_fpm_val(pcmdinfo->in.u.query_fpm_val.cqp,\n\t\t\t\t\t\tpcmdinfo->in.u.query_fpm_val.scratch,\n\t\t\t\t\t\tpcmdinfo->in.u.query_fpm_val.hmc_fn_id,\n\t\t\t\t\t\t&val_mem, true, IRDMA_CQP_WAIT_EVENT);\n\t\tbreak;\n\tcase IRDMA_OP_COMMIT_FPM_VAL:\n\t\tval_mem.pa = pcmdinfo->in.u.commit_fpm_val.fpm_val_pa;\n\t\tval_mem.va = pcmdinfo->in.u.commit_fpm_val.fpm_val_va;\n\t\tstatus = irdma_sc_commit_fpm_val(pcmdinfo->in.u.commit_fpm_val.cqp,\n\t\t\t\t\t\t pcmdinfo->in.u.commit_fpm_val.scratch,\n\t\t\t\t\t\t pcmdinfo->in.u.commit_fpm_val.hmc_fn_id,\n\t\t\t\t\t\t &val_mem,\n\t\t\t\t\t\t true,\n\t\t\t\t\t\t IRDMA_CQP_WAIT_EVENT);\n\t\tbreak;\n\tcase IRDMA_OP_STATS_ALLOCATE:\n\t\talloc = true;\n\t\tfallthrough;\n\tcase IRDMA_OP_STATS_FREE:\n\t\tstatus = irdma_sc_manage_stats_inst(pcmdinfo->in.u.stats_manage.cqp,\n\t\t\t\t\t\t    &pcmdinfo->in.u.stats_manage.info,\n\t\t\t\t\t\t    alloc,\n\t\t\t\t\t\t    pcmdinfo->in.u.stats_manage.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_STATS_GATHER:\n\t\tstatus = irdma_sc_gather_stats(pcmdinfo->in.u.stats_gather.cqp,\n\t\t\t\t\t       &pcmdinfo->in.u.stats_gather.info,\n\t\t\t\t\t       pcmdinfo->in.u.stats_gather.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_WS_MODIFY_NODE:\n\t\tstatus = irdma_sc_manage_ws_node(pcmdinfo->in.u.ws_node.cqp,\n\t\t\t\t\t\t &pcmdinfo->in.u.ws_node.info,\n\t\t\t\t\t\t IRDMA_MODIFY_NODE,\n\t\t\t\t\t\t pcmdinfo->in.u.ws_node.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_WS_DELETE_NODE:\n\t\tstatus = irdma_sc_manage_ws_node(pcmdinfo->in.u.ws_node.cqp,\n\t\t\t\t\t\t &pcmdinfo->in.u.ws_node.info,\n\t\t\t\t\t\t IRDMA_DEL_NODE,\n\t\t\t\t\t\t pcmdinfo->in.u.ws_node.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_WS_ADD_NODE:\n\t\tstatus = irdma_sc_manage_ws_node(pcmdinfo->in.u.ws_node.cqp,\n\t\t\t\t\t\t &pcmdinfo->in.u.ws_node.info,\n\t\t\t\t\t\t IRDMA_ADD_NODE,\n\t\t\t\t\t\t pcmdinfo->in.u.ws_node.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_SET_UP_MAP:\n\t\tstatus = irdma_sc_set_up_map(pcmdinfo->in.u.up_map.cqp,\n\t\t\t\t\t     &pcmdinfo->in.u.up_map.info,\n\t\t\t\t\t     pcmdinfo->in.u.up_map.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_QUERY_RDMA_FEATURES:\n\t\tstatus = irdma_sc_query_rdma_features(pcmdinfo->in.u.query_rdma.cqp,\n\t\t\t\t\t\t      &pcmdinfo->in.u.query_rdma.query_buff_mem,\n\t\t\t\t\t\t      pcmdinfo->in.u.query_rdma.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_DELETE_ARP_CACHE_ENTRY:\n\t\tstatus = irdma_sc_del_arp_cache_entry(pcmdinfo->in.u.del_arp_cache_entry.cqp,\n\t\t\t\t\t\t      pcmdinfo->in.u.del_arp_cache_entry.scratch,\n\t\t\t\t\t\t      pcmdinfo->in.u.del_arp_cache_entry.arp_index,\n\t\t\t\t\t\t      pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_MANAGE_APBVT_ENTRY:\n\t\tstatus = irdma_sc_manage_apbvt_entry(pcmdinfo->in.u.manage_apbvt_entry.cqp,\n\t\t\t\t\t\t     &pcmdinfo->in.u.manage_apbvt_entry.info,\n\t\t\t\t\t\t     pcmdinfo->in.u.manage_apbvt_entry.scratch,\n\t\t\t\t\t\t     pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_MANAGE_QHASH_TABLE_ENTRY:\n\t\tstatus = irdma_sc_manage_qhash_table_entry(pcmdinfo->in.u.manage_qhash_table_entry.cqp,\n\t\t\t\t\t\t\t   &pcmdinfo->in.u.manage_qhash_table_entry.info,\n\t\t\t\t\t\t\t   pcmdinfo->in.u.manage_qhash_table_entry.scratch,\n\t\t\t\t\t\t\t   pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_QP_MODIFY:\n\t\tstatus = irdma_sc_qp_modify(pcmdinfo->in.u.qp_modify.qp,\n\t\t\t\t\t    &pcmdinfo->in.u.qp_modify.info,\n\t\t\t\t\t    pcmdinfo->in.u.qp_modify.scratch,\n\t\t\t\t\t    pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_QP_CREATE:\n\t\tstatus = irdma_sc_qp_create(pcmdinfo->in.u.qp_create.qp,\n\t\t\t\t\t    &pcmdinfo->in.u.qp_create.info,\n\t\t\t\t\t    pcmdinfo->in.u.qp_create.scratch,\n\t\t\t\t\t    pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_QP_DESTROY:\n\t\tstatus = irdma_sc_qp_destroy(pcmdinfo->in.u.qp_destroy.qp,\n\t\t\t\t\t     pcmdinfo->in.u.qp_destroy.scratch,\n\t\t\t\t\t     pcmdinfo->in.u.qp_destroy.remove_hash_idx,\n\t\t\t\t\t     pcmdinfo->in.u.qp_destroy.ignore_mw_bnd,\n\t\t\t\t\t     pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_ALLOC_STAG:\n\t\tstatus = irdma_sc_alloc_stag(pcmdinfo->in.u.alloc_stag.dev,\n\t\t\t\t\t     &pcmdinfo->in.u.alloc_stag.info,\n\t\t\t\t\t     pcmdinfo->in.u.alloc_stag.scratch,\n\t\t\t\t\t     pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_MR_REG_NON_SHARED:\n\t\tstatus = irdma_sc_mr_reg_non_shared(pcmdinfo->in.u.mr_reg_non_shared.dev,\n\t\t\t\t\t\t    &pcmdinfo->in.u.mr_reg_non_shared.info,\n\t\t\t\t\t\t    pcmdinfo->in.u.mr_reg_non_shared.scratch,\n\t\t\t\t\t\t    pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_DEALLOC_STAG:\n\t\tstatus = irdma_sc_dealloc_stag(pcmdinfo->in.u.dealloc_stag.dev,\n\t\t\t\t\t       &pcmdinfo->in.u.dealloc_stag.info,\n\t\t\t\t\t       pcmdinfo->in.u.dealloc_stag.scratch,\n\t\t\t\t\t       pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_MW_ALLOC:\n\t\tstatus = irdma_sc_mw_alloc(pcmdinfo->in.u.mw_alloc.dev,\n\t\t\t\t\t   &pcmdinfo->in.u.mw_alloc.info,\n\t\t\t\t\t   pcmdinfo->in.u.mw_alloc.scratch,\n\t\t\t\t\t   pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_ADD_ARP_CACHE_ENTRY:\n\t\tstatus = irdma_sc_add_arp_cache_entry(pcmdinfo->in.u.add_arp_cache_entry.cqp,\n\t\t\t\t\t\t      &pcmdinfo->in.u.add_arp_cache_entry.info,\n\t\t\t\t\t\t      pcmdinfo->in.u.add_arp_cache_entry.scratch,\n\t\t\t\t\t\t      pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_ALLOC_LOCAL_MAC_ENTRY:\n\t\tstatus = irdma_sc_alloc_local_mac_entry(pcmdinfo->in.u.alloc_local_mac_entry.cqp,\n\t\t\t\t\t\t\tpcmdinfo->in.u.alloc_local_mac_entry.scratch,\n\t\t\t\t\t\t\tpcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_ADD_LOCAL_MAC_ENTRY:\n\t\tstatus = irdma_sc_add_local_mac_entry(pcmdinfo->in.u.add_local_mac_entry.cqp,\n\t\t\t\t\t\t      &pcmdinfo->in.u.add_local_mac_entry.info,\n\t\t\t\t\t\t      pcmdinfo->in.u.add_local_mac_entry.scratch,\n\t\t\t\t\t\t      pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_DELETE_LOCAL_MAC_ENTRY:\n\t\tstatus = irdma_sc_del_local_mac_entry(pcmdinfo->in.u.del_local_mac_entry.cqp,\n\t\t\t\t\t\t      pcmdinfo->in.u.del_local_mac_entry.scratch,\n\t\t\t\t\t\t      pcmdinfo->in.u.del_local_mac_entry.entry_idx,\n\t\t\t\t\t\t      pcmdinfo->in.u.del_local_mac_entry.ignore_ref_count,\n\t\t\t\t\t\t      pcmdinfo->post_sq);\n\t\tbreak;\n\tcase IRDMA_OP_AH_CREATE:\n\t\tstatus = irdma_sc_create_ah(pcmdinfo->in.u.ah_create.cqp,\n\t\t\t\t\t    &pcmdinfo->in.u.ah_create.info,\n\t\t\t\t\t    pcmdinfo->in.u.ah_create.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_AH_DESTROY:\n\t\tstatus = irdma_sc_destroy_ah(pcmdinfo->in.u.ah_destroy.cqp,\n\t\t\t\t\t     &pcmdinfo->in.u.ah_destroy.info,\n\t\t\t\t\t     pcmdinfo->in.u.ah_destroy.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_MC_CREATE:\n\t\tstatus = irdma_sc_create_mcast_grp(pcmdinfo->in.u.mc_create.cqp,\n\t\t\t\t\t\t   &pcmdinfo->in.u.mc_create.info,\n\t\t\t\t\t\t   pcmdinfo->in.u.mc_create.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_MC_DESTROY:\n\t\tstatus = irdma_sc_destroy_mcast_grp(pcmdinfo->in.u.mc_destroy.cqp,\n\t\t\t\t\t\t    &pcmdinfo->in.u.mc_destroy.info,\n\t\t\t\t\t\t    pcmdinfo->in.u.mc_destroy.scratch);\n\t\tbreak;\n\tcase IRDMA_OP_MC_MODIFY:\n\t\tstatus = irdma_sc_modify_mcast_grp(pcmdinfo->in.u.mc_modify.cqp,\n\t\t\t\t\t\t   &pcmdinfo->in.u.mc_modify.info,\n\t\t\t\t\t\t   pcmdinfo->in.u.mc_modify.scratch);\n\t\tbreak;\n\tdefault:\n\t\tstatus = -EOPNOTSUPP;\n\t\tbreak;\n\t}\n\n\treturn status;\n}\n\n \nint irdma_process_cqp_cmd(struct irdma_sc_dev *dev,\n\t\t\t  struct cqp_cmds_info *pcmdinfo)\n{\n\tint status = 0;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&dev->cqp_lock, flags);\n\tif (list_empty(&dev->cqp_cmd_head) && !irdma_cqp_ring_full(dev->cqp))\n\t\tstatus = irdma_exec_cqp_cmd(dev, pcmdinfo);\n\telse\n\t\tlist_add_tail(&pcmdinfo->cqp_cmd_entry, &dev->cqp_cmd_head);\n\tspin_unlock_irqrestore(&dev->cqp_lock, flags);\n\treturn status;\n}\n\n \nint irdma_process_bh(struct irdma_sc_dev *dev)\n{\n\tint status = 0;\n\tstruct cqp_cmds_info *pcmdinfo;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&dev->cqp_lock, flags);\n\twhile (!list_empty(&dev->cqp_cmd_head) &&\n\t       !irdma_cqp_ring_full(dev->cqp)) {\n\t\tpcmdinfo = (struct cqp_cmds_info *)irdma_remove_cqp_head(dev);\n\t\tstatus = irdma_exec_cqp_cmd(dev, pcmdinfo);\n\t\tif (status)\n\t\t\tbreak;\n\t}\n\tspin_unlock_irqrestore(&dev->cqp_lock, flags);\n\treturn status;\n}\n\n \nvoid irdma_cfg_aeq(struct irdma_sc_dev *dev, u32 idx, bool enable)\n{\n\tu32 reg_val;\n\n\treg_val = FIELD_PREP(IRDMA_PFINT_AEQCTL_CAUSE_ENA, enable) |\n\t\t  FIELD_PREP(IRDMA_PFINT_AEQCTL_MSIX_INDX, idx) |\n\t\t  FIELD_PREP(IRDMA_PFINT_AEQCTL_ITR_INDX, 3);\n\twritel(reg_val, dev->hw_regs[IRDMA_PFINT_AEQCTL]);\n}\n\n \nvoid sc_vsi_update_stats(struct irdma_sc_vsi *vsi)\n{\n\tstruct irdma_gather_stats *gather_stats;\n\tstruct irdma_gather_stats *last_gather_stats;\n\n\tgather_stats = vsi->pestat->gather_info.gather_stats_va;\n\tlast_gather_stats = vsi->pestat->gather_info.last_gather_stats_va;\n\tirdma_update_stats(&vsi->pestat->hw_stats, gather_stats,\n\t\t\t   last_gather_stats, vsi->dev->hw_stats_map,\n\t\t\t   vsi->dev->hw_attrs.max_stat_idx);\n}\n\n \nstatic int irdma_wait_pe_ready(struct irdma_sc_dev *dev)\n{\n\tu32 statuscpu0;\n\tu32 statuscpu1;\n\tu32 statuscpu2;\n\tu32 retrycount = 0;\n\n\tdo {\n\t\tstatuscpu0 = readl(dev->hw_regs[IRDMA_GLPE_CPUSTATUS0]);\n\t\tstatuscpu1 = readl(dev->hw_regs[IRDMA_GLPE_CPUSTATUS1]);\n\t\tstatuscpu2 = readl(dev->hw_regs[IRDMA_GLPE_CPUSTATUS2]);\n\t\tif (statuscpu0 == 0x80 && statuscpu1 == 0x80 &&\n\t\t    statuscpu2 == 0x80)\n\t\t\treturn 0;\n\t\tmdelay(1000);\n\t} while (retrycount++ < dev->hw_attrs.max_pe_ready_count);\n\treturn -1;\n}\n\nstatic inline void irdma_sc_init_hw(struct irdma_sc_dev *dev)\n{\n\tswitch (dev->hw_attrs.uk_attrs.hw_rev) {\n\tcase IRDMA_GEN_1:\n\t\ti40iw_init_hw(dev);\n\t\tbreak;\n\tcase IRDMA_GEN_2:\n\t\ticrdma_init_hw(dev);\n\t\tbreak;\n\t}\n}\n\n \nint irdma_sc_dev_init(enum irdma_vers ver, struct irdma_sc_dev *dev,\n\t\t      struct irdma_device_init_info *info)\n{\n\tu32 val;\n\tint ret_code = 0;\n\tu8 db_size;\n\n\tINIT_LIST_HEAD(&dev->cqp_cmd_head);  \n\tmutex_init(&dev->ws_mutex);\n\tdev->hmc_fn_id = info->hmc_fn_id;\n\tdev->fpm_query_buf_pa = info->fpm_query_buf_pa;\n\tdev->fpm_query_buf = info->fpm_query_buf;\n\tdev->fpm_commit_buf_pa = info->fpm_commit_buf_pa;\n\tdev->fpm_commit_buf = info->fpm_commit_buf;\n\tdev->hw = info->hw;\n\tdev->hw->hw_addr = info->bar0;\n\t \n\tdev->hw_attrs.min_hw_qp_id = IRDMA_MIN_IW_QP_ID;\n\tdev->hw_attrs.min_hw_aeq_size = IRDMA_MIN_AEQ_ENTRIES;\n\tdev->hw_attrs.max_hw_aeq_size = IRDMA_MAX_AEQ_ENTRIES;\n\tdev->hw_attrs.min_hw_ceq_size = IRDMA_MIN_CEQ_ENTRIES;\n\tdev->hw_attrs.max_hw_ceq_size = IRDMA_MAX_CEQ_ENTRIES;\n\tdev->hw_attrs.uk_attrs.min_hw_cq_size = IRDMA_MIN_CQ_SIZE;\n\tdev->hw_attrs.uk_attrs.max_hw_cq_size = IRDMA_MAX_CQ_SIZE;\n\tdev->hw_attrs.uk_attrs.max_hw_wq_frags = IRDMA_MAX_WQ_FRAGMENT_COUNT;\n\tdev->hw_attrs.uk_attrs.max_hw_read_sges = IRDMA_MAX_SGE_RD;\n\tdev->hw_attrs.max_hw_outbound_msg_size = IRDMA_MAX_OUTBOUND_MSG_SIZE;\n\tdev->hw_attrs.max_mr_size = IRDMA_MAX_MR_SIZE;\n\tdev->hw_attrs.max_hw_inbound_msg_size = IRDMA_MAX_INBOUND_MSG_SIZE;\n\tdev->hw_attrs.max_hw_device_pages = IRDMA_MAX_PUSH_PAGE_COUNT;\n\tdev->hw_attrs.uk_attrs.max_hw_inline = IRDMA_MAX_INLINE_DATA_SIZE;\n\tdev->hw_attrs.max_hw_wqes = IRDMA_MAX_WQ_ENTRIES;\n\tdev->hw_attrs.max_qp_wr = IRDMA_MAX_QP_WRS(IRDMA_MAX_QUANTA_PER_WR);\n\n\tdev->hw_attrs.uk_attrs.max_hw_rq_quanta = IRDMA_QP_SW_MAX_RQ_QUANTA;\n\tdev->hw_attrs.uk_attrs.max_hw_wq_quanta = IRDMA_QP_SW_MAX_WQ_QUANTA;\n\tdev->hw_attrs.max_hw_pds = IRDMA_MAX_PDS;\n\tdev->hw_attrs.max_hw_ena_vf_count = IRDMA_MAX_PE_ENA_VF_COUNT;\n\n\tdev->hw_attrs.max_pe_ready_count = 14;\n\tdev->hw_attrs.max_done_count = IRDMA_DONE_COUNT;\n\tdev->hw_attrs.max_sleep_count = IRDMA_SLEEP_COUNT;\n\tdev->hw_attrs.max_cqp_compl_wait_time_ms = CQP_COMPL_WAIT_TIME_MS;\n\n\tdev->hw_attrs.uk_attrs.hw_rev = ver;\n\tirdma_sc_init_hw(dev);\n\n\tif (irdma_wait_pe_ready(dev))\n\t\treturn -ETIMEDOUT;\n\n\tval = readl(dev->hw_regs[IRDMA_GLPCI_LBARCTRL]);\n\tdb_size = (u8)FIELD_GET(IRDMA_GLPCI_LBARCTRL_PE_DB_SIZE, val);\n\tif (db_size != IRDMA_PE_DB_SIZE_4M && db_size != IRDMA_PE_DB_SIZE_8M) {\n\t\tibdev_dbg(to_ibdev(dev),\n\t\t\t  \"DEV: RDMA PE doorbell is not enabled in CSR val 0x%x db_size=%d\\n\",\n\t\t\t  val, db_size);\n\t\treturn -ENODEV;\n\t}\n\tdev->db_addr = dev->hw->hw_addr + (uintptr_t)dev->hw_regs[IRDMA_DB_ADDR_OFFSET];\n\n\treturn ret_code;\n}\n\n \nstatic inline u64 irdma_stat_val(const u64 *stats_val, u16 byteoff, u8 bitoff,\n\t\t\t\t u64 bitmask)\n{\n\tu16 idx = byteoff / sizeof(*stats_val);\n\n\treturn (stats_val[idx] >> bitoff) & bitmask;\n}\n\n \nstatic inline u64 irdma_stat_delta(u64 new_val, u64 old_val, u64 max_val)\n{\n\tif (new_val >= old_val)\n\t\treturn new_val - old_val;\n\n\t \n\treturn max_val - old_val + new_val + 1;\n}\n\n \nvoid irdma_update_stats(struct irdma_dev_hw_stats *hw_stats,\n\t\t\tstruct irdma_gather_stats *gather_stats,\n\t\t\tstruct irdma_gather_stats *last_gather_stats,\n\t\t\tconst struct irdma_hw_stat_map *map, u16 max_stat_idx)\n{\n\tu64 *stats_val = hw_stats->stats_val;\n\tu16 i;\n\n\tfor (i = 0; i < max_stat_idx; i++) {\n\t\tu64 new_val = irdma_stat_val(gather_stats->val, map[i].byteoff,\n\t\t\t\t\t     map[i].bitoff, map[i].bitmask);\n\t\tu64 last_val = irdma_stat_val(last_gather_stats->val,\n\t\t\t\t\t      map[i].byteoff, map[i].bitoff,\n\t\t\t\t\t      map[i].bitmask);\n\n\t\tstats_val[i] +=\n\t\t\tirdma_stat_delta(new_val, last_val, map[i].bitmask);\n\t}\n\n\tmemcpy(last_gather_stats, gather_stats, sizeof(*last_gather_stats));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}