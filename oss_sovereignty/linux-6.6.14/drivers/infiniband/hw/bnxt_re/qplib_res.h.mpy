{
  "module_name": "qplib_res.h",
  "hash_id": "7ffcac7d3653ac460efdff1f1e6cdda2ca3b24b4fe5d5ab19a9d47e8b718f722",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/hw/bnxt_re/qplib_res.h",
  "human_readable_source": " \n\n#ifndef __BNXT_QPLIB_RES_H__\n#define __BNXT_QPLIB_RES_H__\n\nextern const struct bnxt_qplib_gid bnxt_qplib_gid_zero;\n\n#define CHIP_NUM_57508\t\t0x1750\n#define CHIP_NUM_57504\t\t0x1751\n#define CHIP_NUM_57502\t\t0x1752\n\nstruct bnxt_qplib_drv_modes {\n\tu8\twqe_mode;\n\tbool db_push;\n\tbool dbr_pacing;\n};\n\nstruct bnxt_qplib_chip_ctx {\n\tu16\tchip_num;\n\tu8\tchip_rev;\n\tu8\tchip_metal;\n\tu16\thw_stats_size;\n\tu16\thwrm_cmd_max_timeout;\n\tstruct bnxt_qplib_drv_modes modes;\n\tu64\thwrm_intf_ver;\n\tu32     dbr_stat_db_fifo;\n};\n\nstruct bnxt_qplib_db_pacing_data {\n\tu32 do_pacing;\n\tu32 pacing_th;\n\tu32 alarm_th;\n\tu32 fifo_max_depth;\n\tu32 fifo_room_mask;\n\tu32 fifo_room_shift;\n\tu32 grc_reg_offset;\n};\n\n#define BNXT_QPLIB_DBR_PF_DB_OFFSET     0x10000\n#define BNXT_QPLIB_DBR_VF_DB_OFFSET     0x4000\n\n#define PTR_CNT_PER_PG\t\t(PAGE_SIZE / sizeof(void *))\n#define PTR_MAX_IDX_PER_PG\t(PTR_CNT_PER_PG - 1)\n#define PTR_PG(x)\t\t(((x) & ~PTR_MAX_IDX_PER_PG) / PTR_CNT_PER_PG)\n#define PTR_IDX(x)\t\t((x) & PTR_MAX_IDX_PER_PG)\n\n#define HWQ_CMP(idx, hwq)\t((idx) & ((hwq)->max_elements - 1))\n\n#define HWQ_FREE_SLOTS(hwq)\t(hwq->max_elements - \\\n\t\t\t\t((HWQ_CMP(hwq->prod, hwq)\\\n\t\t\t\t- HWQ_CMP(hwq->cons, hwq))\\\n\t\t\t\t& (hwq->max_elements - 1)))\nenum bnxt_qplib_hwq_type {\n\tHWQ_TYPE_CTX,\n\tHWQ_TYPE_QUEUE,\n\tHWQ_TYPE_L2_CMPL,\n\tHWQ_TYPE_MR\n};\n\n#define MAX_PBL_LVL_0_PGS\t\t1\n#define MAX_PBL_LVL_1_PGS\t\t512\n#define MAX_PBL_LVL_1_PGS_SHIFT\t\t9\n#define MAX_PBL_LVL_1_PGS_FOR_LVL_2\t256\n#define MAX_PBL_LVL_2_PGS\t\t(256 * 512)\n#define MAX_PDL_LVL_SHIFT               9\n\nenum bnxt_qplib_pbl_lvl {\n\tPBL_LVL_0,\n\tPBL_LVL_1,\n\tPBL_LVL_2,\n\tPBL_LVL_MAX\n};\n\n#define ROCE_PG_SIZE_4K\t\t(4 * 1024)\n#define ROCE_PG_SIZE_8K\t\t(8 * 1024)\n#define ROCE_PG_SIZE_64K\t(64 * 1024)\n#define ROCE_PG_SIZE_2M\t\t(2 * 1024 * 1024)\n#define ROCE_PG_SIZE_8M\t\t(8 * 1024 * 1024)\n#define ROCE_PG_SIZE_1G\t\t(1024 * 1024 * 1024)\n\nenum bnxt_qplib_hwrm_pg_size {\n\tBNXT_QPLIB_HWRM_PG_SIZE_4K\t= 0,\n\tBNXT_QPLIB_HWRM_PG_SIZE_8K\t= 1,\n\tBNXT_QPLIB_HWRM_PG_SIZE_64K\t= 2,\n\tBNXT_QPLIB_HWRM_PG_SIZE_2M\t= 3,\n\tBNXT_QPLIB_HWRM_PG_SIZE_8M\t= 4,\n\tBNXT_QPLIB_HWRM_PG_SIZE_1G\t= 5,\n};\n\nstruct bnxt_qplib_reg_desc {\n\tu8\t\tbar_id;\n\tresource_size_t\tbar_base;\n\tunsigned long\toffset;\n\tvoid __iomem\t*bar_reg;\n\tsize_t\t\tlen;\n};\n\nstruct bnxt_qplib_pbl {\n\tu32\t\t\t\tpg_count;\n\tu32\t\t\t\tpg_size;\n\tvoid\t\t\t\t**pg_arr;\n\tdma_addr_t\t\t\t*pg_map_arr;\n};\n\nstruct bnxt_qplib_sg_info {\n\tstruct ib_umem\t\t\t*umem;\n\tu32\t\t\t\tnpages;\n\tu32\t\t\t\tpgshft;\n\tu32\t\t\t\tpgsize;\n\tbool\t\t\t\tnopte;\n};\n\nstruct bnxt_qplib_hwq_attr {\n\tstruct bnxt_qplib_res\t\t*res;\n\tstruct bnxt_qplib_sg_info\t*sginfo;\n\tenum bnxt_qplib_hwq_type\ttype;\n\tu32\t\t\t\tdepth;\n\tu32\t\t\t\tstride;\n\tu32\t\t\t\taux_stride;\n\tu32\t\t\t\taux_depth;\n};\n\nstruct bnxt_qplib_hwq {\n\tstruct pci_dev\t\t\t*pdev;\n\t \n\tspinlock_t\t\t\tlock;\n\tstruct bnxt_qplib_pbl\t\tpbl[PBL_LVL_MAX + 1];\n\tenum bnxt_qplib_pbl_lvl\t\tlevel;\t\t \n\t \n\tvoid\t\t\t\t**pbl_ptr;\n\t \n\tdma_addr_t\t\t\t*pbl_dma_ptr;\n\tu32\t\t\t\tmax_elements;\n\tu32\t\t\t\tdepth;\n\tu16\t\t\t\telement_size;\t \n\tu16\t\t\t\tqe_ppg;\t \n\n\tu32\t\t\t\tprod;\t\t \n\tu32\t\t\t\tcons;\t\t \n\tu8\t\t\t\tcp_bit;\n\tu8\t\t\t\tis_user;\n\tu64\t\t\t\t*pad_pg;\n\tu32\t\t\t\tpad_stride;\n\tu32\t\t\t\tpad_pgofft;\n};\n\nstruct bnxt_qplib_db_info {\n\tvoid __iomem\t\t*db;\n\tvoid __iomem\t\t*priv_db;\n\tstruct bnxt_qplib_hwq\t*hwq;\n\tu32\t\t\txid;\n\tu32\t\t\tmax_slot;\n};\n\n \nstruct bnxt_qplib_pd_tbl {\n\tunsigned long\t\t\t*tbl;\n\tu32\t\t\t\tmax;\n};\n\nstruct bnxt_qplib_sgid_tbl {\n\tstruct bnxt_qplib_gid_info\t*tbl;\n\tu16\t\t\t\t*hw_id;\n\tu16\t\t\t\tmax;\n\tu16\t\t\t\tactive;\n\tvoid\t\t\t\t*ctx;\n\tu8\t\t\t\t*vlan;\n};\n\nenum {\n\tBNXT_QPLIB_DPI_TYPE_KERNEL      = 0,\n\tBNXT_QPLIB_DPI_TYPE_UC          = 1,\n\tBNXT_QPLIB_DPI_TYPE_WC          = 2\n};\n\nstruct bnxt_qplib_dpi {\n\tu32\t\t\t\tdpi;\n\tu32\t\t\t\tbit;\n\tvoid __iomem\t\t\t*dbr;\n\tu64\t\t\t\tumdbr;\n\tu8\t\t\t\ttype;\n};\n\nstruct bnxt_qplib_dpi_tbl {\n\tvoid\t\t\t\t**app_tbl;\n\tunsigned long\t\t\t*tbl;\n\tu16\t\t\t\tmax;\n\tstruct bnxt_qplib_reg_desc\tucreg;  \n\tstruct bnxt_qplib_reg_desc\twcreg;\n\tvoid __iomem\t\t\t*priv_db;\n};\n\nstruct bnxt_qplib_stats {\n\tdma_addr_t\t\t\tdma_map;\n\tvoid\t\t\t\t*dma;\n\tu32\t\t\t\tsize;\n\tu32\t\t\t\tfw_id;\n};\n\nstruct bnxt_qplib_vf_res {\n\tu32 max_qp_per_vf;\n\tu32 max_mrw_per_vf;\n\tu32 max_srq_per_vf;\n\tu32 max_cq_per_vf;\n\tu32 max_gid_per_vf;\n};\n\n#define BNXT_QPLIB_MAX_QP_CTX_ENTRY_SIZE\t448\n#define BNXT_QPLIB_MAX_SRQ_CTX_ENTRY_SIZE\t64\n#define BNXT_QPLIB_MAX_CQ_CTX_ENTRY_SIZE\t64\n#define BNXT_QPLIB_MAX_MRW_CTX_ENTRY_SIZE\t128\n\n#define MAX_TQM_ALLOC_REQ               48\n#define MAX_TQM_ALLOC_BLK_SIZE          8\nstruct bnxt_qplib_tqm_ctx {\n\tstruct bnxt_qplib_hwq           pde;\n\tu8                              pde_level;  \n\tstruct bnxt_qplib_hwq           qtbl[MAX_TQM_ALLOC_REQ];\n\tu8                              qcount[MAX_TQM_ALLOC_REQ];\n};\n\nstruct bnxt_qplib_ctx {\n\tu32\t\t\t\tqpc_count;\n\tstruct bnxt_qplib_hwq\t\tqpc_tbl;\n\tu32\t\t\t\tmrw_count;\n\tstruct bnxt_qplib_hwq\t\tmrw_tbl;\n\tu32\t\t\t\tsrqc_count;\n\tstruct bnxt_qplib_hwq\t\tsrqc_tbl;\n\tu32\t\t\t\tcq_count;\n\tstruct bnxt_qplib_hwq\t\tcq_tbl;\n\tstruct bnxt_qplib_hwq\t\ttim_tbl;\n\tstruct bnxt_qplib_tqm_ctx\ttqm_ctx;\n\tstruct bnxt_qplib_stats\t\tstats;\n\tstruct bnxt_qplib_vf_res\tvf_res;\n};\n\nstruct bnxt_qplib_res {\n\tstruct pci_dev\t\t\t*pdev;\n\tstruct bnxt_qplib_chip_ctx\t*cctx;\n\tstruct bnxt_qplib_dev_attr      *dattr;\n\tstruct net_device\t\t*netdev;\n\tstruct bnxt_qplib_rcfw\t\t*rcfw;\n\tstruct bnxt_qplib_pd_tbl\tpd_tbl;\n\t \n\tstruct mutex\t\t\tpd_tbl_lock;\n\tstruct bnxt_qplib_sgid_tbl\tsgid_tbl;\n\tstruct bnxt_qplib_dpi_tbl\tdpi_tbl;\n\t \n\tstruct mutex                    dpi_tbl_lock;\n\tbool\t\t\t\tprio;\n\tbool                            is_vf;\n\tstruct bnxt_qplib_db_pacing_data *pacing_data;\n};\n\nstatic inline bool bnxt_qplib_is_chip_gen_p5(struct bnxt_qplib_chip_ctx *cctx)\n{\n\treturn (cctx->chip_num == CHIP_NUM_57508 ||\n\t\tcctx->chip_num == CHIP_NUM_57504 ||\n\t\tcctx->chip_num == CHIP_NUM_57502);\n}\n\nstatic inline u8 bnxt_qplib_get_hwq_type(struct bnxt_qplib_res *res)\n{\n\treturn bnxt_qplib_is_chip_gen_p5(res->cctx) ?\n\t\t\t\t\tHWQ_TYPE_QUEUE : HWQ_TYPE_L2_CMPL;\n}\n\nstatic inline u8 bnxt_qplib_get_ring_type(struct bnxt_qplib_chip_ctx *cctx)\n{\n\treturn bnxt_qplib_is_chip_gen_p5(cctx) ?\n\t       RING_ALLOC_REQ_RING_TYPE_NQ :\n\t       RING_ALLOC_REQ_RING_TYPE_ROCE_CMPL;\n}\n\nstatic inline u8 bnxt_qplib_base_pg_size(struct bnxt_qplib_hwq *hwq)\n{\n\tu8 pg_size = BNXT_QPLIB_HWRM_PG_SIZE_4K;\n\tstruct bnxt_qplib_pbl *pbl;\n\n\tpbl = &hwq->pbl[PBL_LVL_0];\n\tswitch (pbl->pg_size) {\n\tcase ROCE_PG_SIZE_4K:\n\t\tpg_size = BNXT_QPLIB_HWRM_PG_SIZE_4K;\n\t\tbreak;\n\tcase ROCE_PG_SIZE_8K:\n\t\tpg_size = BNXT_QPLIB_HWRM_PG_SIZE_8K;\n\t\tbreak;\n\tcase ROCE_PG_SIZE_64K:\n\t\tpg_size = BNXT_QPLIB_HWRM_PG_SIZE_64K;\n\t\tbreak;\n\tcase ROCE_PG_SIZE_2M:\n\t\tpg_size = BNXT_QPLIB_HWRM_PG_SIZE_2M;\n\t\tbreak;\n\tcase ROCE_PG_SIZE_8M:\n\t\tpg_size = BNXT_QPLIB_HWRM_PG_SIZE_8M;\n\t\tbreak;\n\tcase ROCE_PG_SIZE_1G:\n\t\tpg_size = BNXT_QPLIB_HWRM_PG_SIZE_1G;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn pg_size;\n}\n\nstatic inline void *bnxt_qplib_get_qe(struct bnxt_qplib_hwq *hwq,\n\t\t\t\t      u32 indx, u64 *pg)\n{\n\tu32 pg_num, pg_idx;\n\n\tpg_num = (indx / hwq->qe_ppg);\n\tpg_idx = (indx % hwq->qe_ppg);\n\tif (pg)\n\t\t*pg = (u64)&hwq->pbl_ptr[pg_num];\n\treturn (void *)(hwq->pbl_ptr[pg_num] + hwq->element_size * pg_idx);\n}\n\nstatic inline void *bnxt_qplib_get_prod_qe(struct bnxt_qplib_hwq *hwq, u32 idx)\n{\n\tidx += hwq->prod;\n\tif (idx >= hwq->depth)\n\t\tidx -= hwq->depth;\n\treturn bnxt_qplib_get_qe(hwq, idx, NULL);\n}\n\n#define to_bnxt_qplib(ptr, type, member)\t\\\n\tcontainer_of(ptr, type, member)\n\nstruct bnxt_qplib_pd;\nstruct bnxt_qplib_dev_attr;\n\nvoid bnxt_qplib_free_hwq(struct bnxt_qplib_res *res,\n\t\t\t struct bnxt_qplib_hwq *hwq);\nint bnxt_qplib_alloc_init_hwq(struct bnxt_qplib_hwq *hwq,\n\t\t\t      struct bnxt_qplib_hwq_attr *hwq_attr);\nint bnxt_qplib_alloc_pd(struct bnxt_qplib_res *res,\n\t\t\tstruct bnxt_qplib_pd *pd);\nint bnxt_qplib_dealloc_pd(struct bnxt_qplib_res *res,\n\t\t\t  struct bnxt_qplib_pd_tbl *pd_tbl,\n\t\t\t  struct bnxt_qplib_pd *pd);\nint bnxt_qplib_alloc_dpi(struct bnxt_qplib_res *res,\n\t\t\t struct bnxt_qplib_dpi *dpi,\n\t\t\t void *app, u8 type);\nint bnxt_qplib_dealloc_dpi(struct bnxt_qplib_res *res,\n\t\t\t   struct bnxt_qplib_dpi *dpi);\nvoid bnxt_qplib_cleanup_res(struct bnxt_qplib_res *res);\nint bnxt_qplib_init_res(struct bnxt_qplib_res *res);\nvoid bnxt_qplib_free_res(struct bnxt_qplib_res *res);\nint bnxt_qplib_alloc_res(struct bnxt_qplib_res *res, struct pci_dev *pdev,\n\t\t\t struct net_device *netdev,\n\t\t\t struct bnxt_qplib_dev_attr *dev_attr);\nvoid bnxt_qplib_free_ctx(struct bnxt_qplib_res *res,\n\t\t\t struct bnxt_qplib_ctx *ctx);\nint bnxt_qplib_alloc_ctx(struct bnxt_qplib_res *res,\n\t\t\t struct bnxt_qplib_ctx *ctx,\n\t\t\t bool virt_fn, bool is_p5);\nint bnxt_qplib_map_db_bar(struct bnxt_qplib_res *res);\nvoid bnxt_qplib_unmap_db_bar(struct bnxt_qplib_res *res);\n\nint bnxt_qplib_determine_atomics(struct pci_dev *dev);\n\nstatic inline void bnxt_qplib_hwq_incr_prod(struct bnxt_qplib_hwq *hwq, u32 cnt)\n{\n\thwq->prod = (hwq->prod + cnt) % hwq->depth;\n}\n\nstatic inline void bnxt_qplib_hwq_incr_cons(struct bnxt_qplib_hwq *hwq,\n\t\t\t\t\t    u32 cnt)\n{\n\thwq->cons = (hwq->cons + cnt) % hwq->depth;\n}\n\nstatic inline void bnxt_qplib_ring_db32(struct bnxt_qplib_db_info *info,\n\t\t\t\t\tbool arm)\n{\n\tu32 key;\n\n\tkey = info->hwq->cons & (info->hwq->max_elements - 1);\n\tkey |= (CMPL_DOORBELL_IDX_VALID |\n\t\t(CMPL_DOORBELL_KEY_CMPL & CMPL_DOORBELL_KEY_MASK));\n\tif (!arm)\n\t\tkey |= CMPL_DOORBELL_MASK;\n\twritel(key, info->db);\n}\n\nstatic inline void bnxt_qplib_ring_db(struct bnxt_qplib_db_info *info,\n\t\t\t\t      u32 type)\n{\n\tu64 key = 0;\n\n\tkey = (info->xid & DBC_DBC_XID_MASK) | DBC_DBC_PATH_ROCE | type;\n\tkey <<= 32;\n\tkey |= (info->hwq->cons & (info->hwq->max_elements - 1)) &\n\t\tDBC_DBC_INDEX_MASK;\n\twriteq(key, info->db);\n}\n\nstatic inline void bnxt_qplib_ring_prod_db(struct bnxt_qplib_db_info *info,\n\t\t\t\t\t   u32 type)\n{\n\tu64 key = 0;\n\n\tkey = (info->xid & DBC_DBC_XID_MASK) | DBC_DBC_PATH_ROCE | type;\n\tkey <<= 32;\n\tkey |= ((info->hwq->prod / info->max_slot)) & DBC_DBC_INDEX_MASK;\n\twriteq(key, info->db);\n}\n\nstatic inline void bnxt_qplib_armen_db(struct bnxt_qplib_db_info *info,\n\t\t\t\t       u32 type)\n{\n\tu64 key = 0;\n\n\tkey = (info->xid & DBC_DBC_XID_MASK) | DBC_DBC_PATH_ROCE | type;\n\tkey <<= 32;\n\twriteq(key, info->priv_db);\n}\n\nstatic inline void bnxt_qplib_srq_arm_db(struct bnxt_qplib_db_info *info,\n\t\t\t\t\t u32 th)\n{\n\tu64 key = 0;\n\n\tkey = (info->xid & DBC_DBC_XID_MASK) | DBC_DBC_PATH_ROCE | th;\n\tkey <<= 32;\n\tkey |=  th & DBC_DBC_INDEX_MASK;\n\twriteq(key, info->priv_db);\n}\n\nstatic inline void bnxt_qplib_ring_nq_db(struct bnxt_qplib_db_info *info,\n\t\t\t\t\t struct bnxt_qplib_chip_ctx *cctx,\n\t\t\t\t\t bool arm)\n{\n\tu32 type;\n\n\ttype = arm ? DBC_DBC_TYPE_NQ_ARM : DBC_DBC_TYPE_NQ;\n\tif (bnxt_qplib_is_chip_gen_p5(cctx))\n\t\tbnxt_qplib_ring_db(info, type);\n\telse\n\t\tbnxt_qplib_ring_db32(info, arm);\n}\n\nstatic inline bool _is_ext_stats_supported(u16 dev_cap_flags)\n{\n\treturn dev_cap_flags &\n\t\tCREQ_QUERY_FUNC_RESP_SB_EXT_STATS;\n}\n\nstatic inline u8 bnxt_qplib_dbr_pacing_en(struct bnxt_qplib_chip_ctx *cctx)\n{\n\treturn cctx->modes.dbr_pacing;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}