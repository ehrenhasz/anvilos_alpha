{
  "module_name": "uverbs_std_types_mr.c",
  "hash_id": "568ca23b4371a8e14a695ee18e01ebc346f8370e0770ac501547d251e6d871cd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/core/uverbs_std_types_mr.c",
  "human_readable_source": " \n\n#include \"rdma_core.h\"\n#include \"uverbs.h\"\n#include <rdma/uverbs_std_types.h>\n#include \"restrack.h\"\n\nstatic int uverbs_free_mr(struct ib_uobject *uobject,\n\t\t\t  enum rdma_remove_reason why,\n\t\t\t  struct uverbs_attr_bundle *attrs)\n{\n\treturn ib_dereg_mr_user((struct ib_mr *)uobject->object,\n\t\t\t\t&attrs->driver_udata);\n}\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_ADVISE_MR)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_pd *pd =\n\t\tuverbs_attr_get_obj(attrs, UVERBS_ATTR_ADVISE_MR_PD_HANDLE);\n\tenum ib_uverbs_advise_mr_advice advice;\n\tstruct ib_device *ib_dev = pd->device;\n\tstruct ib_sge *sg_list;\n\tint num_sge;\n\tu32 flags;\n\tint ret;\n\n\t \n\tif (!ib_dev->ops.advise_mr)\n\t\treturn -EOPNOTSUPP;\n\n\tret = uverbs_get_const(&advice, attrs, UVERBS_ATTR_ADVISE_MR_ADVICE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_get_flags32(&flags, attrs, UVERBS_ATTR_ADVISE_MR_FLAGS,\n\t\t\t\t IB_UVERBS_ADVISE_MR_FLAG_FLUSH);\n\tif (ret)\n\t\treturn ret;\n\n\tnum_sge = uverbs_attr_ptr_get_array_size(\n\t\tattrs, UVERBS_ATTR_ADVISE_MR_SGE_LIST, sizeof(struct ib_sge));\n\tif (num_sge <= 0)\n\t\treturn num_sge;\n\n\tsg_list = uverbs_attr_get_alloced_ptr(attrs,\n\t\t\t\t\t      UVERBS_ATTR_ADVISE_MR_SGE_LIST);\n\treturn ib_dev->ops.advise_mr(pd, advice, flags, sg_list, num_sge,\n\t\t\t\t     attrs);\n}\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_DM_MR_REG)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_dm_mr_attr attr = {};\n\tstruct ib_uobject *uobj =\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_REG_DM_MR_HANDLE);\n\tstruct ib_dm *dm =\n\t\tuverbs_attr_get_obj(attrs, UVERBS_ATTR_REG_DM_MR_DM_HANDLE);\n\tstruct ib_pd *pd =\n\t\tuverbs_attr_get_obj(attrs, UVERBS_ATTR_REG_DM_MR_PD_HANDLE);\n\tstruct ib_device *ib_dev = pd->device;\n\n\tstruct ib_mr *mr;\n\tint ret;\n\n\tif (!ib_dev->ops.reg_dm_mr)\n\t\treturn -EOPNOTSUPP;\n\n\tret = uverbs_copy_from(&attr.offset, attrs, UVERBS_ATTR_REG_DM_MR_OFFSET);\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_from(&attr.length, attrs,\n\t\t\t       UVERBS_ATTR_REG_DM_MR_LENGTH);\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_get_flags32(&attr.access_flags, attrs,\n\t\t\t\t UVERBS_ATTR_REG_DM_MR_ACCESS_FLAGS,\n\t\t\t\t IB_ACCESS_SUPPORTED);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!(attr.access_flags & IB_ZERO_BASED))\n\t\treturn -EINVAL;\n\n\tret = ib_check_mr_access(ib_dev, attr.access_flags);\n\tif (ret)\n\t\treturn ret;\n\n\tif (attr.offset > dm->length || attr.length > dm->length ||\n\t    attr.length > dm->length - attr.offset)\n\t\treturn -EINVAL;\n\n\tmr = pd->device->ops.reg_dm_mr(pd, dm, &attr, attrs);\n\tif (IS_ERR(mr))\n\t\treturn PTR_ERR(mr);\n\n\tmr->device  = pd->device;\n\tmr->pd      = pd;\n\tmr->type    = IB_MR_TYPE_DM;\n\tmr->dm      = dm;\n\tmr->uobject = uobj;\n\tatomic_inc(&pd->usecnt);\n\tatomic_inc(&dm->usecnt);\n\n\trdma_restrack_new(&mr->res, RDMA_RESTRACK_MR);\n\trdma_restrack_set_name(&mr->res, NULL);\n\trdma_restrack_add(&mr->res);\n\tuobj->object = mr;\n\n\tuverbs_finalize_uobj_create(attrs, UVERBS_ATTR_REG_DM_MR_HANDLE);\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_REG_DM_MR_RESP_LKEY, &mr->lkey,\n\t\t\t     sizeof(mr->lkey));\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_REG_DM_MR_RESP_RKEY,\n\t\t\t     &mr->rkey, sizeof(mr->rkey));\n\treturn ret;\n}\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_QUERY_MR)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_mr *mr =\n\t\tuverbs_attr_get_obj(attrs, UVERBS_ATTR_QUERY_MR_HANDLE);\n\tint ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_QUERY_MR_RESP_LKEY, &mr->lkey,\n\t\t\t     sizeof(mr->lkey));\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_QUERY_MR_RESP_RKEY,\n\t\t\t     &mr->rkey, sizeof(mr->rkey));\n\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_QUERY_MR_RESP_LENGTH,\n\t\t\t     &mr->length, sizeof(mr->length));\n\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_QUERY_MR_RESP_IOVA,\n\t\t\t     &mr->iova, sizeof(mr->iova));\n\n\treturn IS_UVERBS_COPY_ERR(ret) ? ret : 0;\n}\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_REG_DMABUF_MR)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_uobject *uobj =\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_REG_DMABUF_MR_HANDLE);\n\tstruct ib_pd *pd =\n\t\tuverbs_attr_get_obj(attrs, UVERBS_ATTR_REG_DMABUF_MR_PD_HANDLE);\n\tstruct ib_device *ib_dev = pd->device;\n\n\tu64 offset, length, iova;\n\tu32 fd, access_flags;\n\tstruct ib_mr *mr;\n\tint ret;\n\n\tif (!ib_dev->ops.reg_user_mr_dmabuf)\n\t\treturn -EOPNOTSUPP;\n\n\tret = uverbs_copy_from(&offset, attrs,\n\t\t\t       UVERBS_ATTR_REG_DMABUF_MR_OFFSET);\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_from(&length, attrs,\n\t\t\t       UVERBS_ATTR_REG_DMABUF_MR_LENGTH);\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_from(&iova, attrs,\n\t\t\t       UVERBS_ATTR_REG_DMABUF_MR_IOVA);\n\tif (ret)\n\t\treturn ret;\n\n\tif ((offset & ~PAGE_MASK) != (iova & ~PAGE_MASK))\n\t\treturn -EINVAL;\n\n\tret = uverbs_copy_from(&fd, attrs,\n\t\t\t       UVERBS_ATTR_REG_DMABUF_MR_FD);\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_get_flags32(&access_flags, attrs,\n\t\t\t\t UVERBS_ATTR_REG_DMABUF_MR_ACCESS_FLAGS,\n\t\t\t\t IB_ACCESS_LOCAL_WRITE |\n\t\t\t\t IB_ACCESS_REMOTE_READ |\n\t\t\t\t IB_ACCESS_REMOTE_WRITE |\n\t\t\t\t IB_ACCESS_REMOTE_ATOMIC |\n\t\t\t\t IB_ACCESS_RELAXED_ORDERING);\n\tif (ret)\n\t\treturn ret;\n\n\tret = ib_check_mr_access(ib_dev, access_flags);\n\tif (ret)\n\t\treturn ret;\n\n\tmr = pd->device->ops.reg_user_mr_dmabuf(pd, offset, length, iova, fd,\n\t\t\t\t\t\taccess_flags,\n\t\t\t\t\t\t&attrs->driver_udata);\n\tif (IS_ERR(mr))\n\t\treturn PTR_ERR(mr);\n\n\tmr->device = pd->device;\n\tmr->pd = pd;\n\tmr->type = IB_MR_TYPE_USER;\n\tmr->uobject = uobj;\n\tatomic_inc(&pd->usecnt);\n\n\trdma_restrack_new(&mr->res, RDMA_RESTRACK_MR);\n\trdma_restrack_set_name(&mr->res, NULL);\n\trdma_restrack_add(&mr->res);\n\tuobj->object = mr;\n\n\tuverbs_finalize_uobj_create(attrs, UVERBS_ATTR_REG_DMABUF_MR_HANDLE);\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_REG_DMABUF_MR_RESP_LKEY,\n\t\t\t     &mr->lkey, sizeof(mr->lkey));\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_REG_DMABUF_MR_RESP_RKEY,\n\t\t\t     &mr->rkey, sizeof(mr->rkey));\n\treturn ret;\n}\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_ADVISE_MR,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_ADVISE_MR_PD_HANDLE,\n\t\t\tUVERBS_OBJECT_PD,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_CONST_IN(UVERBS_ATTR_ADVISE_MR_ADVICE,\n\t\t\t     enum ib_uverbs_advise_mr_advice,\n\t\t\t     UA_MANDATORY),\n\tUVERBS_ATTR_FLAGS_IN(UVERBS_ATTR_ADVISE_MR_FLAGS,\n\t\t\t     enum ib_uverbs_advise_mr_flag,\n\t\t\t     UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_ADVISE_MR_SGE_LIST,\n\t\t\t   UVERBS_ATTR_MIN_SIZE(sizeof(struct ib_uverbs_sge)),\n\t\t\t   UA_MANDATORY,\n\t\t\t   UA_ALLOC_AND_COPY));\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_QUERY_MR,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_QUERY_MR_HANDLE,\n\t\t\tUVERBS_OBJECT_MR,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_QUERY_MR_RESP_RKEY,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_QUERY_MR_RESP_LKEY,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_QUERY_MR_RESP_LENGTH,\n\t\t\t    UVERBS_ATTR_TYPE(u64),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_QUERY_MR_RESP_IOVA,\n\t\t\t    UVERBS_ATTR_TYPE(u64),\n\t\t\t    UA_OPTIONAL));\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_DM_MR_REG,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_REG_DM_MR_HANDLE,\n\t\t\tUVERBS_OBJECT_MR,\n\t\t\tUVERBS_ACCESS_NEW,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_REG_DM_MR_OFFSET,\n\t\t\t   UVERBS_ATTR_TYPE(u64),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_REG_DM_MR_LENGTH,\n\t\t\t   UVERBS_ATTR_TYPE(u64),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_REG_DM_MR_PD_HANDLE,\n\t\t\tUVERBS_OBJECT_PD,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_FLAGS_IN(UVERBS_ATTR_REG_DM_MR_ACCESS_FLAGS,\n\t\t\t     enum ib_access_flags),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_REG_DM_MR_DM_HANDLE,\n\t\t\tUVERBS_OBJECT_DM,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_REG_DM_MR_RESP_LKEY,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_REG_DM_MR_RESP_RKEY,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY));\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_REG_DMABUF_MR,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_REG_DMABUF_MR_HANDLE,\n\t\t\tUVERBS_OBJECT_MR,\n\t\t\tUVERBS_ACCESS_NEW,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_REG_DMABUF_MR_PD_HANDLE,\n\t\t\tUVERBS_OBJECT_PD,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_REG_DMABUF_MR_OFFSET,\n\t\t\t   UVERBS_ATTR_TYPE(u64),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_REG_DMABUF_MR_LENGTH,\n\t\t\t   UVERBS_ATTR_TYPE(u64),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_REG_DMABUF_MR_IOVA,\n\t\t\t   UVERBS_ATTR_TYPE(u64),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_REG_DMABUF_MR_FD,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_FLAGS_IN(UVERBS_ATTR_REG_DMABUF_MR_ACCESS_FLAGS,\n\t\t\t     enum ib_access_flags),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_REG_DMABUF_MR_RESP_LKEY,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_REG_DMABUF_MR_RESP_RKEY,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY));\n\nDECLARE_UVERBS_NAMED_METHOD_DESTROY(\n\tUVERBS_METHOD_MR_DESTROY,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_DESTROY_MR_HANDLE,\n\t\t\tUVERBS_OBJECT_MR,\n\t\t\tUVERBS_ACCESS_DESTROY,\n\t\t\tUA_MANDATORY));\n\nDECLARE_UVERBS_NAMED_OBJECT(\n\tUVERBS_OBJECT_MR,\n\tUVERBS_TYPE_ALLOC_IDR(uverbs_free_mr),\n\t&UVERBS_METHOD(UVERBS_METHOD_ADVISE_MR),\n\t&UVERBS_METHOD(UVERBS_METHOD_DM_MR_REG),\n\t&UVERBS_METHOD(UVERBS_METHOD_MR_DESTROY),\n\t&UVERBS_METHOD(UVERBS_METHOD_QUERY_MR),\n\t&UVERBS_METHOD(UVERBS_METHOD_REG_DMABUF_MR));\n\nconst struct uapi_definition uverbs_def_obj_mr[] = {\n\tUAPI_DEF_CHAIN_OBJ_TREE_NAMED(UVERBS_OBJECT_MR,\n\t\t\t\t      UAPI_DEF_OBJ_NEEDS_FN(dereg_mr)),\n\t{}\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}