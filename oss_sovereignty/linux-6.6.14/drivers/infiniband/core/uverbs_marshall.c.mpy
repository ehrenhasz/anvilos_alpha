{
  "module_name": "uverbs_marshall.c",
  "hash_id": "4d07dc1ffa7cd117e655a6dd44cc80954fafc836358bdad7aee8320a2740b88e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/core/uverbs_marshall.c",
  "human_readable_source": " \n\n#include <linux/export.h>\n#include <rdma/ib_marshall.h>\n\n#define OPA_DEFAULT_GID_PREFIX cpu_to_be64(0xfe80000000000000ULL)\nstatic int rdma_ah_conv_opa_to_ib(struct ib_device *dev,\n\t\t\t\t  struct rdma_ah_attr *ib,\n\t\t\t\t  struct rdma_ah_attr *opa)\n{\n\tstruct ib_port_attr port_attr;\n\tint ret = 0;\n\n\t \n\t*ib = *opa;\n\n\tib->type = RDMA_AH_ATTR_TYPE_IB;\n\trdma_ah_set_grh(ib, NULL, 0, 0, 1, 0);\n\n\tif (ib_query_port(dev, opa->port_num, &port_attr)) {\n\t\t \n\t\trdma_ah_set_subnet_prefix(ib, OPA_DEFAULT_GID_PREFIX);\n\t\tret = -EINVAL;\n\t} else {\n\t\trdma_ah_set_subnet_prefix(ib,\n\t\t\t\t\t  cpu_to_be64(port_attr.subnet_prefix));\n\t}\n\trdma_ah_set_interface_id(ib, OPA_MAKE_ID(rdma_ah_get_dlid(opa)));\n\treturn ret;\n}\n\nvoid ib_copy_ah_attr_to_user(struct ib_device *device,\n\t\t\t     struct ib_uverbs_ah_attr *dst,\n\t\t\t     struct rdma_ah_attr *ah_attr)\n{\n\tstruct rdma_ah_attr *src = ah_attr;\n\tstruct rdma_ah_attr conv_ah;\n\n\tmemset(&dst->grh, 0, sizeof(dst->grh));\n\n\tif ((ah_attr->type == RDMA_AH_ATTR_TYPE_OPA) &&\n\t    (rdma_ah_get_dlid(ah_attr) > be16_to_cpu(IB_LID_PERMISSIVE)) &&\n\t    (!rdma_ah_conv_opa_to_ib(device, &conv_ah, ah_attr)))\n\t\tsrc = &conv_ah;\n\n\tdst->dlid\t\t   = rdma_ah_get_dlid(src);\n\tdst->sl\t\t\t   = rdma_ah_get_sl(src);\n\tdst->src_path_bits\t   = rdma_ah_get_path_bits(src);\n\tdst->static_rate\t   = rdma_ah_get_static_rate(src);\n\tdst->is_global             = rdma_ah_get_ah_flags(src) &\n\t\t\t\t\tIB_AH_GRH ? 1 : 0;\n\tif (dst->is_global) {\n\t\tconst struct ib_global_route *grh = rdma_ah_read_grh(src);\n\n\t\tmemcpy(dst->grh.dgid, grh->dgid.raw, sizeof(grh->dgid));\n\t\tdst->grh.flow_label        = grh->flow_label;\n\t\tdst->grh.sgid_index        = grh->sgid_index;\n\t\tdst->grh.hop_limit         = grh->hop_limit;\n\t\tdst->grh.traffic_class     = grh->traffic_class;\n\t}\n\tdst->port_num\t\t   = rdma_ah_get_port_num(src);\n\tdst->reserved \t\t   = 0;\n}\nEXPORT_SYMBOL(ib_copy_ah_attr_to_user);\n\nvoid ib_copy_qp_attr_to_user(struct ib_device *device,\n\t\t\t     struct ib_uverbs_qp_attr *dst,\n\t\t\t     struct ib_qp_attr *src)\n{\n\tdst->qp_state\t        = src->qp_state;\n\tdst->cur_qp_state\t= src->cur_qp_state;\n\tdst->path_mtu\t\t= src->path_mtu;\n\tdst->path_mig_state\t= src->path_mig_state;\n\tdst->qkey\t\t= src->qkey;\n\tdst->rq_psn\t\t= src->rq_psn;\n\tdst->sq_psn\t\t= src->sq_psn;\n\tdst->dest_qp_num\t= src->dest_qp_num;\n\tdst->qp_access_flags\t= src->qp_access_flags;\n\n\tdst->max_send_wr\t= src->cap.max_send_wr;\n\tdst->max_recv_wr\t= src->cap.max_recv_wr;\n\tdst->max_send_sge\t= src->cap.max_send_sge;\n\tdst->max_recv_sge\t= src->cap.max_recv_sge;\n\tdst->max_inline_data\t= src->cap.max_inline_data;\n\n\tib_copy_ah_attr_to_user(device, &dst->ah_attr, &src->ah_attr);\n\tib_copy_ah_attr_to_user(device, &dst->alt_ah_attr, &src->alt_ah_attr);\n\n\tdst->pkey_index\t\t= src->pkey_index;\n\tdst->alt_pkey_index\t= src->alt_pkey_index;\n\tdst->en_sqd_async_notify = src->en_sqd_async_notify;\n\tdst->sq_draining\t= src->sq_draining;\n\tdst->max_rd_atomic\t= src->max_rd_atomic;\n\tdst->max_dest_rd_atomic\t= src->max_dest_rd_atomic;\n\tdst->min_rnr_timer\t= src->min_rnr_timer;\n\tdst->port_num\t\t= src->port_num;\n\tdst->timeout\t\t= src->timeout;\n\tdst->retry_cnt\t\t= src->retry_cnt;\n\tdst->rnr_retry\t\t= src->rnr_retry;\n\tdst->alt_port_num\t= src->alt_port_num;\n\tdst->alt_timeout\t= src->alt_timeout;\n\tmemset(dst->reserved, 0, sizeof(dst->reserved));\n}\nEXPORT_SYMBOL(ib_copy_qp_attr_to_user);\n\nstatic void __ib_copy_path_rec_to_user(struct ib_user_path_rec *dst,\n\t\t\t\t       struct sa_path_rec *src)\n{\n\tmemcpy(dst->dgid, src->dgid.raw, sizeof(src->dgid));\n\tmemcpy(dst->sgid, src->sgid.raw, sizeof(src->sgid));\n\n\tdst->dlid\t\t= htons(ntohl(sa_path_get_dlid(src)));\n\tdst->slid\t\t= htons(ntohl(sa_path_get_slid(src)));\n\tdst->raw_traffic\t= sa_path_get_raw_traffic(src);\n\tdst->flow_label\t\t= src->flow_label;\n\tdst->hop_limit\t\t= src->hop_limit;\n\tdst->traffic_class\t= src->traffic_class;\n\tdst->reversible\t\t= src->reversible;\n\tdst->numb_path\t\t= src->numb_path;\n\tdst->pkey\t\t= src->pkey;\n\tdst->sl\t\t\t= src->sl;\n\tdst->mtu_selector\t= src->mtu_selector;\n\tdst->mtu\t\t= src->mtu;\n\tdst->rate_selector\t= src->rate_selector;\n\tdst->rate\t\t= src->rate;\n\tdst->packet_life_time\t= src->packet_life_time;\n\tdst->preference\t\t= src->preference;\n\tdst->packet_life_time_selector = src->packet_life_time_selector;\n}\n\nvoid ib_copy_path_rec_to_user(struct ib_user_path_rec *dst,\n\t\t\t      struct sa_path_rec *src)\n{\n\tstruct sa_path_rec rec;\n\n\tif (src->rec_type == SA_PATH_REC_TYPE_OPA) {\n\t\tsa_convert_path_opa_to_ib(&rec, src);\n\t\t__ib_copy_path_rec_to_user(dst, &rec);\n\t\treturn;\n\t}\n\t__ib_copy_path_rec_to_user(dst, src);\n}\nEXPORT_SYMBOL(ib_copy_path_rec_to_user);\n\nvoid ib_copy_path_rec_from_user(struct sa_path_rec *dst,\n\t\t\t\tstruct ib_user_path_rec *src)\n{\n\tu32 slid, dlid;\n\n\tmemset(dst, 0, sizeof(*dst));\n\tif ((ib_is_opa_gid((union ib_gid *)src->sgid)) ||\n\t    (ib_is_opa_gid((union ib_gid *)src->dgid))) {\n\t\tdst->rec_type = SA_PATH_REC_TYPE_OPA;\n\t\tslid = opa_get_lid_from_gid((union ib_gid *)src->sgid);\n\t\tdlid = opa_get_lid_from_gid((union ib_gid *)src->dgid);\n\t} else {\n\t\tdst->rec_type = SA_PATH_REC_TYPE_IB;\n\t\tslid = ntohs(src->slid);\n\t\tdlid = ntohs(src->dlid);\n\t}\n\tmemcpy(dst->dgid.raw, src->dgid, sizeof dst->dgid);\n\tmemcpy(dst->sgid.raw, src->sgid, sizeof dst->sgid);\n\n\tsa_path_set_dlid(dst, dlid);\n\tsa_path_set_slid(dst, slid);\n\tsa_path_set_raw_traffic(dst, src->raw_traffic);\n\tdst->flow_label\t\t= src->flow_label;\n\tdst->hop_limit\t\t= src->hop_limit;\n\tdst->traffic_class\t= src->traffic_class;\n\tdst->reversible\t\t= src->reversible;\n\tdst->numb_path\t\t= src->numb_path;\n\tdst->pkey\t\t= src->pkey;\n\tdst->sl\t\t\t= src->sl;\n\tdst->mtu_selector\t= src->mtu_selector;\n\tdst->mtu\t\t= src->mtu;\n\tdst->rate_selector\t= src->rate_selector;\n\tdst->rate\t\t= src->rate;\n\tdst->packet_life_time\t= src->packet_life_time;\n\tdst->preference\t\t= src->preference;\n\tdst->packet_life_time_selector = src->packet_life_time_selector;\n\n\t \n\tsa_path_set_dmac_zero(dst);\n}\nEXPORT_SYMBOL(ib_copy_path_rec_from_user);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}