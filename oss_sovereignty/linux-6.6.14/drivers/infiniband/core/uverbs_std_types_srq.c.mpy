{
  "module_name": "uverbs_std_types_srq.c",
  "hash_id": "b848bb237033b7bd436e8c970b4c284382732cfed1dfa29af2bbb2164641ef81",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/core/uverbs_std_types_srq.c",
  "human_readable_source": "\n \n\n#include <rdma/uverbs_std_types.h>\n#include \"rdma_core.h\"\n#include \"uverbs.h\"\n\nstatic int uverbs_free_srq(struct ib_uobject *uobject,\n\t\t    enum rdma_remove_reason why,\n\t\t    struct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_srq *srq = uobject->object;\n\tstruct ib_uevent_object *uevent =\n\t\tcontainer_of(uobject, struct ib_uevent_object, uobject);\n\tenum ib_srq_type srq_type = srq->srq_type;\n\tint ret;\n\n\tret = ib_destroy_srq_user(srq, &attrs->driver_udata);\n\tif (ret)\n\t\treturn ret;\n\n\tif (srq_type == IB_SRQT_XRC) {\n\t\tstruct ib_usrq_object *us =\n\t\t\tcontainer_of(uobject, struct ib_usrq_object,\n\t\t\t\t     uevent.uobject);\n\n\t\tatomic_dec(&us->uxrcd->refcnt);\n\t}\n\n\tib_uverbs_release_uevent(uevent);\n\treturn 0;\n}\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_SRQ_CREATE)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_usrq_object *obj = container_of(\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_CREATE_SRQ_HANDLE),\n\t\ttypeof(*obj), uevent.uobject);\n\tstruct ib_pd *pd =\n\t\tuverbs_attr_get_obj(attrs, UVERBS_ATTR_CREATE_SRQ_PD_HANDLE);\n\tstruct ib_srq_init_attr attr = {};\n\tstruct ib_uobject *xrcd_uobj;\n\tstruct ib_srq *srq;\n\tu64 user_handle;\n\tint ret;\n\n\tret = uverbs_copy_from(&attr.attr.max_sge, attrs,\n\t\t\t       UVERBS_ATTR_CREATE_SRQ_MAX_SGE);\n\tif (!ret)\n\t\tret = uverbs_copy_from(&attr.attr.max_wr, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_SRQ_MAX_WR);\n\tif (!ret)\n\t\tret = uverbs_copy_from(&attr.attr.srq_limit, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_SRQ_LIMIT);\n\tif (!ret)\n\t\tret = uverbs_copy_from(&user_handle, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_SRQ_USER_HANDLE);\n\tif (!ret)\n\t\tret = uverbs_get_const(&attr.srq_type, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_SRQ_TYPE);\n\tif (ret)\n\t\treturn ret;\n\n\tif (ib_srq_has_cq(attr.srq_type)) {\n\t\tattr.ext.cq = uverbs_attr_get_obj(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_SRQ_CQ_HANDLE);\n\t\tif (IS_ERR(attr.ext.cq))\n\t\t\treturn PTR_ERR(attr.ext.cq);\n\t}\n\n\tswitch (attr.srq_type) {\n\tcase IB_UVERBS_SRQT_XRC:\n\t\txrcd_uobj = uverbs_attr_get_uobject(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_SRQ_XRCD_HANDLE);\n\t\tif (IS_ERR(xrcd_uobj))\n\t\t\treturn PTR_ERR(xrcd_uobj);\n\n\t\tattr.ext.xrc.xrcd = (struct ib_xrcd *)xrcd_uobj->object;\n\t\tif (!attr.ext.xrc.xrcd)\n\t\t\treturn -EINVAL;\n\t\tobj->uxrcd = container_of(xrcd_uobj, struct ib_uxrcd_object,\n\t\t\t\t\t  uobject);\n\t\tatomic_inc(&obj->uxrcd->refcnt);\n\t\tbreak;\n\tcase IB_UVERBS_SRQT_TM:\n\t\tret = uverbs_copy_from(&attr.ext.tag_matching.max_num_tags,\n\t\t\t\t       attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_SRQ_MAX_NUM_TAGS);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase IB_UVERBS_SRQT_BASIC:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tobj->uevent.event_file = ib_uverbs_get_async_event(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_SRQ_EVENT_FD);\n\tINIT_LIST_HEAD(&obj->uevent.event_list);\n\tattr.event_handler = ib_uverbs_srq_event_handler;\n\tobj->uevent.uobject.user_handle = user_handle;\n\n\tsrq = ib_create_srq_user(pd, &attr, obj, &attrs->driver_udata);\n\tif (IS_ERR(srq)) {\n\t\tret = PTR_ERR(srq);\n\t\tgoto err;\n\t}\n\n\tobj->uevent.uobject.object = srq;\n\tuverbs_finalize_uobj_create(attrs, UVERBS_ATTR_CREATE_SRQ_HANDLE);\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_CREATE_SRQ_RESP_MAX_WR,\n\t\t\t     &attr.attr.max_wr,\n\t\t\t     sizeof(attr.attr.max_wr));\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_CREATE_SRQ_RESP_MAX_SGE,\n\t\t\t     &attr.attr.max_sge,\n\t\t\t     sizeof(attr.attr.max_sge));\n\tif (ret)\n\t\treturn ret;\n\n\tif (attr.srq_type == IB_SRQT_XRC) {\n\t\tret = uverbs_copy_to(attrs,\n\t\t\t\t     UVERBS_ATTR_CREATE_SRQ_RESP_SRQ_NUM,\n\t\t\t\t     &srq->ext.xrc.srq_num,\n\t\t\t\t     sizeof(srq->ext.xrc.srq_num));\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\nerr:\n\tif (obj->uevent.event_file)\n\t\tuverbs_uobject_put(&obj->uevent.event_file->uobj);\n\tif (attr.srq_type == IB_SRQT_XRC)\n\t\tatomic_dec(&obj->uxrcd->refcnt);\n\treturn ret;\n};\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_SRQ_CREATE,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_SRQ_HANDLE,\n\t\t\tUVERBS_OBJECT_SRQ,\n\t\t\tUVERBS_ACCESS_NEW,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_SRQ_PD_HANDLE,\n\t\t\tUVERBS_OBJECT_PD,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_CONST_IN(UVERBS_ATTR_CREATE_SRQ_TYPE,\n\t\t\t     enum ib_uverbs_srq_type,\n\t\t\t     UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_SRQ_USER_HANDLE,\n\t\t\t   UVERBS_ATTR_TYPE(u64),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_SRQ_MAX_WR,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_SRQ_MAX_SGE,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_SRQ_LIMIT,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_SRQ_XRCD_HANDLE,\n\t\t\tUVERBS_OBJECT_XRCD,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_OPTIONAL),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_SRQ_CQ_HANDLE,\n\t\t\tUVERBS_OBJECT_CQ,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_OPTIONAL),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_SRQ_MAX_NUM_TAGS,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_OPTIONAL),\n\tUVERBS_ATTR_FD(UVERBS_ATTR_CREATE_SRQ_EVENT_FD,\n\t\t       UVERBS_OBJECT_ASYNC_EVENT,\n\t\t       UVERBS_ACCESS_READ,\n\t\t       UA_OPTIONAL),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_CREATE_SRQ_RESP_MAX_WR,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_CREATE_SRQ_RESP_MAX_SGE,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_CREATE_SRQ_RESP_SRQ_NUM,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_OPTIONAL),\n\tUVERBS_ATTR_UHW());\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_SRQ_DESTROY)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_uobject *uobj =\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_DESTROY_SRQ_HANDLE);\n\tstruct ib_usrq_object *obj =\n\t\tcontainer_of(uobj, struct ib_usrq_object, uevent.uobject);\n\tstruct ib_uverbs_destroy_srq_resp resp = {\n\t\t.events_reported = obj->uevent.events_reported\n\t};\n\n\treturn uverbs_copy_to(attrs, UVERBS_ATTR_DESTROY_SRQ_RESP, &resp,\n\t\t\t      sizeof(resp));\n}\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_SRQ_DESTROY,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_DESTROY_SRQ_HANDLE,\n\t\t\tUVERBS_OBJECT_SRQ,\n\t\t\tUVERBS_ACCESS_DESTROY,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_DESTROY_SRQ_RESP,\n\t\t\t    UVERBS_ATTR_TYPE(struct ib_uverbs_destroy_srq_resp),\n\t\t\t    UA_MANDATORY));\n\nDECLARE_UVERBS_NAMED_OBJECT(\n\tUVERBS_OBJECT_SRQ,\n\tUVERBS_TYPE_ALLOC_IDR_SZ(sizeof(struct ib_usrq_object),\n\t\t\t\t uverbs_free_srq),\n\t&UVERBS_METHOD(UVERBS_METHOD_SRQ_CREATE),\n\t&UVERBS_METHOD(UVERBS_METHOD_SRQ_DESTROY)\n);\n\nconst struct uapi_definition uverbs_def_obj_srq[] = {\n\tUAPI_DEF_CHAIN_OBJ_TREE_NAMED(UVERBS_OBJECT_SRQ,\n\t\t\t\t      UAPI_DEF_OBJ_NEEDS_FN(destroy_srq)),\n\t{}\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}