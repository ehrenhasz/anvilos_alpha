{
  "module_name": "uverbs_std_types_qp.c",
  "hash_id": "0b9f60436fa8f225eae7990d28cf0bfb3dcdd5dae7b5dbee1ea0d1e172b8cc4c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/core/uverbs_std_types_qp.c",
  "human_readable_source": "\n \n\n#include <rdma/uverbs_std_types.h>\n#include \"rdma_core.h\"\n#include \"uverbs.h\"\n#include \"core_priv.h\"\n\nstatic int uverbs_free_qp(struct ib_uobject *uobject,\n\t\t\t  enum rdma_remove_reason why,\n\t\t\t  struct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_qp *qp = uobject->object;\n\tstruct ib_uqp_object *uqp =\n\t\tcontainer_of(uobject, struct ib_uqp_object, uevent.uobject);\n\tint ret;\n\n\t \n\tif (why == RDMA_REMOVE_DESTROY) {\n\t\tif (!list_empty(&uqp->mcast_list))\n\t\t\treturn -EBUSY;\n\t} else if (qp == qp->real_qp) {\n\t\tib_uverbs_detach_umcast(qp, uqp);\n\t}\n\n\tret = ib_destroy_qp_user(qp, &attrs->driver_udata);\n\tif (ret)\n\t\treturn ret;\n\n\tif (uqp->uxrcd)\n\t\tatomic_dec(&uqp->uxrcd->refcnt);\n\n\tib_uverbs_release_uevent(&uqp->uevent);\n\treturn 0;\n}\n\nstatic int check_creation_flags(enum ib_qp_type qp_type,\n\t\t\t\tu32 create_flags)\n{\n\tcreate_flags &= ~IB_UVERBS_QP_CREATE_SQ_SIG_ALL;\n\n\tif (!create_flags || qp_type == IB_QPT_DRIVER)\n\t\treturn 0;\n\n\tif (qp_type != IB_QPT_RAW_PACKET && qp_type != IB_QPT_UD)\n\t\treturn -EINVAL;\n\n\tif ((create_flags & IB_UVERBS_QP_CREATE_SCATTER_FCS ||\n\t     create_flags & IB_UVERBS_QP_CREATE_CVLAN_STRIPPING) &&\n\t     qp_type != IB_QPT_RAW_PACKET)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic void set_caps(struct ib_qp_init_attr *attr,\n\t\t     struct ib_uverbs_qp_cap *cap, bool req)\n{\n\tif (req) {\n\t\tattr->cap.max_send_wr = cap->max_send_wr;\n\t\tattr->cap.max_recv_wr = cap->max_recv_wr;\n\t\tattr->cap.max_send_sge = cap->max_send_sge;\n\t\tattr->cap.max_recv_sge = cap->max_recv_sge;\n\t\tattr->cap.max_inline_data = cap->max_inline_data;\n\t} else {\n\t\tcap->max_send_wr = attr->cap.max_send_wr;\n\t\tcap->max_recv_wr = attr->cap.max_recv_wr;\n\t\tcap->max_send_sge = attr->cap.max_send_sge;\n\t\tcap->max_recv_sge = attr->cap.max_recv_sge;\n\t\tcap->max_inline_data = attr->cap.max_inline_data;\n\t}\n}\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_QP_CREATE)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_uqp_object *obj = container_of(\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_CREATE_QP_HANDLE),\n\t\ttypeof(*obj), uevent.uobject);\n\tstruct ib_qp_init_attr attr = {};\n\tstruct ib_uverbs_qp_cap cap = {};\n\tstruct ib_rwq_ind_table *rwq_ind_tbl = NULL;\n\tstruct ib_qp *qp;\n\tstruct ib_pd *pd = NULL;\n\tstruct ib_srq *srq = NULL;\n\tstruct ib_cq *recv_cq = NULL;\n\tstruct ib_cq *send_cq = NULL;\n\tstruct ib_xrcd *xrcd = NULL;\n\tstruct ib_uobject *xrcd_uobj = NULL;\n\tstruct ib_device *device;\n\tu64 user_handle;\n\tint ret;\n\n\tret = uverbs_copy_from_or_zero(&cap, attrs,\n\t\t\t       UVERBS_ATTR_CREATE_QP_CAP);\n\tif (!ret)\n\t\tret = uverbs_copy_from(&user_handle, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_QP_USER_HANDLE);\n\tif (!ret)\n\t\tret = uverbs_get_const(&attr.qp_type, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_QP_TYPE);\n\tif (ret)\n\t\treturn ret;\n\n\tswitch (attr.qp_type) {\n\tcase IB_QPT_XRC_TGT:\n\t\tif (uverbs_attr_is_valid(attrs,\n\t\t\t\tUVERBS_ATTR_CREATE_QP_RECV_CQ_HANDLE) ||\n\t\t    uverbs_attr_is_valid(attrs,\n\t\t\t\tUVERBS_ATTR_CREATE_QP_SEND_CQ_HANDLE) ||\n\t\t    uverbs_attr_is_valid(attrs,\n\t\t\t\tUVERBS_ATTR_CREATE_QP_PD_HANDLE) ||\n\t\t    uverbs_attr_is_valid(attrs,\n\t\t\t\tUVERBS_ATTR_CREATE_QP_IND_TABLE_HANDLE))\n\t\t\treturn -EINVAL;\n\n\t\txrcd_uobj = uverbs_attr_get_uobject(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_QP_XRCD_HANDLE);\n\t\tif (IS_ERR(xrcd_uobj))\n\t\t\treturn PTR_ERR(xrcd_uobj);\n\n\t\txrcd = (struct ib_xrcd *)xrcd_uobj->object;\n\t\tif (!xrcd)\n\t\t\treturn -EINVAL;\n\t\tdevice = xrcd->device;\n\t\tbreak;\n\tcase IB_UVERBS_QPT_RAW_PACKET:\n\t\tif (!capable(CAP_NET_RAW))\n\t\t\treturn -EPERM;\n\t\tfallthrough;\n\tcase IB_UVERBS_QPT_RC:\n\tcase IB_UVERBS_QPT_UC:\n\tcase IB_UVERBS_QPT_UD:\n\tcase IB_UVERBS_QPT_XRC_INI:\n\tcase IB_UVERBS_QPT_DRIVER:\n\t\tif (uverbs_attr_is_valid(attrs,\n\t\t\t\t\t UVERBS_ATTR_CREATE_QP_XRCD_HANDLE) ||\n\t\t   (uverbs_attr_is_valid(attrs,\n\t\t\t\t\t UVERBS_ATTR_CREATE_QP_SRQ_HANDLE) &&\n\t\t\tattr.qp_type == IB_QPT_XRC_INI))\n\t\t\treturn -EINVAL;\n\n\t\tpd = uverbs_attr_get_obj(attrs,\n\t\t\t\t\t UVERBS_ATTR_CREATE_QP_PD_HANDLE);\n\t\tif (IS_ERR(pd))\n\t\t\treturn PTR_ERR(pd);\n\n\t\trwq_ind_tbl = uverbs_attr_get_obj(attrs,\n\t\t\tUVERBS_ATTR_CREATE_QP_IND_TABLE_HANDLE);\n\t\tif (!IS_ERR(rwq_ind_tbl)) {\n\t\t\tif (cap.max_recv_wr || cap.max_recv_sge ||\n\t\t\t    uverbs_attr_is_valid(attrs,\n\t\t\t\tUVERBS_ATTR_CREATE_QP_RECV_CQ_HANDLE) ||\n\t\t\t    uverbs_attr_is_valid(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_QP_SRQ_HANDLE))\n\t\t\t\treturn -EINVAL;\n\n\t\t\t \n\t\t\tif (cap.max_send_wr) {\n\t\t\t\tsend_cq = uverbs_attr_get_obj(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_QP_SEND_CQ_HANDLE);\n\t\t\t\tif (IS_ERR(send_cq))\n\t\t\t\t\treturn PTR_ERR(send_cq);\n\t\t\t}\n\t\t\tattr.rwq_ind_tbl = rwq_ind_tbl;\n\t\t} else {\n\t\t\tsend_cq = uverbs_attr_get_obj(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_QP_SEND_CQ_HANDLE);\n\t\t\tif (IS_ERR(send_cq))\n\t\t\t\treturn PTR_ERR(send_cq);\n\n\t\t\tif (attr.qp_type != IB_QPT_XRC_INI) {\n\t\t\t\trecv_cq = uverbs_attr_get_obj(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_QP_RECV_CQ_HANDLE);\n\t\t\t\tif (IS_ERR(recv_cq))\n\t\t\t\t\treturn PTR_ERR(recv_cq);\n\t\t\t}\n\t\t}\n\n\t\tdevice = pd->device;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = uverbs_get_flags32(&attr.create_flags, attrs,\n\t\t\t UVERBS_ATTR_CREATE_QP_FLAGS,\n\t\t\t IB_UVERBS_QP_CREATE_BLOCK_MULTICAST_LOOPBACK |\n\t\t\t IB_UVERBS_QP_CREATE_SCATTER_FCS |\n\t\t\t IB_UVERBS_QP_CREATE_CVLAN_STRIPPING |\n\t\t\t IB_UVERBS_QP_CREATE_PCI_WRITE_END_PADDING |\n\t\t\t IB_UVERBS_QP_CREATE_SQ_SIG_ALL);\n\tif (ret)\n\t\treturn ret;\n\n\tret = check_creation_flags(attr.qp_type, attr.create_flags);\n\tif (ret)\n\t\treturn ret;\n\n\tif (uverbs_attr_is_valid(attrs,\n\t\t\tUVERBS_ATTR_CREATE_QP_SOURCE_QPN)) {\n\t\tret = uverbs_copy_from(&attr.source_qpn, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_QP_SOURCE_QPN);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tattr.create_flags |= IB_QP_CREATE_SOURCE_QPN;\n\t}\n\n\tsrq = uverbs_attr_get_obj(attrs,\n\t\t\t\t  UVERBS_ATTR_CREATE_QP_SRQ_HANDLE);\n\tif (!IS_ERR(srq)) {\n\t\tif ((srq->srq_type == IB_SRQT_XRC &&\n\t\t\tattr.qp_type != IB_QPT_XRC_TGT) ||\n\t\t    (srq->srq_type != IB_SRQT_XRC &&\n\t\t\tattr.qp_type == IB_QPT_XRC_TGT))\n\t\t\treturn -EINVAL;\n\t\tattr.srq = srq;\n\t}\n\n\tobj->uevent.event_file = ib_uverbs_get_async_event(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_QP_EVENT_FD);\n\tINIT_LIST_HEAD(&obj->uevent.event_list);\n\tINIT_LIST_HEAD(&obj->mcast_list);\n\tobj->uevent.uobject.user_handle = user_handle;\n\tattr.event_handler = ib_uverbs_qp_event_handler;\n\tattr.send_cq = send_cq;\n\tattr.recv_cq = recv_cq;\n\tattr.xrcd = xrcd;\n\tif (attr.create_flags & IB_UVERBS_QP_CREATE_SQ_SIG_ALL) {\n\t\t \n\t\tattr.create_flags &= ~IB_UVERBS_QP_CREATE_SQ_SIG_ALL;\n\t\tattr.sq_sig_type = IB_SIGNAL_ALL_WR;\n\t} else {\n\t\tattr.sq_sig_type = IB_SIGNAL_REQ_WR;\n\t}\n\n\tset_caps(&attr, &cap, true);\n\tmutex_init(&obj->mcast_lock);\n\n\tqp = ib_create_qp_user(device, pd, &attr, &attrs->driver_udata, obj,\n\t\t\t       KBUILD_MODNAME);\n\tif (IS_ERR(qp)) {\n\t\tret = PTR_ERR(qp);\n\t\tgoto err_put;\n\t}\n\tib_qp_usecnt_inc(qp);\n\n\tif (attr.qp_type == IB_QPT_XRC_TGT) {\n\t\tobj->uxrcd = container_of(xrcd_uobj, struct ib_uxrcd_object,\n\t\t\t\t\t  uobject);\n\t\tatomic_inc(&obj->uxrcd->refcnt);\n\t}\n\n\tobj->uevent.uobject.object = qp;\n\tuverbs_finalize_uobj_create(attrs, UVERBS_ATTR_CREATE_QP_HANDLE);\n\n\tset_caps(&attr, &cap, false);\n\tret = uverbs_copy_to_struct_or_zero(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_QP_RESP_CAP, &cap,\n\t\t\t\t\tsizeof(cap));\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_CREATE_QP_RESP_QP_NUM,\n\t\t\t     &qp->qp_num,\n\t\t\t     sizeof(qp->qp_num));\n\n\treturn ret;\nerr_put:\n\tif (obj->uevent.event_file)\n\t\tuverbs_uobject_put(&obj->uevent.event_file->uobj);\n\treturn ret;\n};\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_QP_CREATE,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_QP_HANDLE,\n\t\t\tUVERBS_OBJECT_QP,\n\t\t\tUVERBS_ACCESS_NEW,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_QP_XRCD_HANDLE,\n\t\t\tUVERBS_OBJECT_XRCD,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_OPTIONAL),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_QP_PD_HANDLE,\n\t\t\tUVERBS_OBJECT_PD,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_OPTIONAL),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_QP_SRQ_HANDLE,\n\t\t\tUVERBS_OBJECT_SRQ,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_OPTIONAL),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_QP_SEND_CQ_HANDLE,\n\t\t\tUVERBS_OBJECT_CQ,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_OPTIONAL),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_QP_RECV_CQ_HANDLE,\n\t\t\tUVERBS_OBJECT_CQ,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_OPTIONAL),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_QP_IND_TABLE_HANDLE,\n\t\t\tUVERBS_OBJECT_RWQ_IND_TBL,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_OPTIONAL),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_QP_USER_HANDLE,\n\t\t\t   UVERBS_ATTR_TYPE(u64),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_QP_CAP,\n\t\t\t   UVERBS_ATTR_STRUCT(struct ib_uverbs_qp_cap,\n\t\t\t\t\t      max_inline_data),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_CONST_IN(UVERBS_ATTR_CREATE_QP_TYPE,\n\t\t\t     enum ib_uverbs_qp_type,\n\t\t\t     UA_MANDATORY),\n\tUVERBS_ATTR_FLAGS_IN(UVERBS_ATTR_CREATE_QP_FLAGS,\n\t\t\t     enum ib_uverbs_qp_create_flags,\n\t\t\t     UA_OPTIONAL),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_QP_SOURCE_QPN,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_OPTIONAL),\n\tUVERBS_ATTR_FD(UVERBS_ATTR_CREATE_QP_EVENT_FD,\n\t\t       UVERBS_OBJECT_ASYNC_EVENT,\n\t\t       UVERBS_ACCESS_READ,\n\t\t       UA_OPTIONAL),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_CREATE_QP_RESP_CAP,\n\t\t\t    UVERBS_ATTR_STRUCT(struct ib_uverbs_qp_cap,\n\t\t\t\t\t       max_inline_data),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_CREATE_QP_RESP_QP_NUM,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_UHW());\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_QP_DESTROY)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_uobject *uobj =\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_DESTROY_QP_HANDLE);\n\tstruct ib_uqp_object *obj =\n\t\tcontainer_of(uobj, struct ib_uqp_object, uevent.uobject);\n\tstruct ib_uverbs_destroy_qp_resp resp = {\n\t\t.events_reported = obj->uevent.events_reported\n\t};\n\n\treturn uverbs_copy_to(attrs, UVERBS_ATTR_DESTROY_QP_RESP, &resp,\n\t\t\t      sizeof(resp));\n}\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_QP_DESTROY,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_DESTROY_QP_HANDLE,\n\t\t\tUVERBS_OBJECT_QP,\n\t\t\tUVERBS_ACCESS_DESTROY,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_DESTROY_QP_RESP,\n\t\t\t    UVERBS_ATTR_TYPE(struct ib_uverbs_destroy_qp_resp),\n\t\t\t    UA_MANDATORY));\n\nDECLARE_UVERBS_NAMED_OBJECT(\n\tUVERBS_OBJECT_QP,\n\tUVERBS_TYPE_ALLOC_IDR_SZ(sizeof(struct ib_uqp_object), uverbs_free_qp),\n\t&UVERBS_METHOD(UVERBS_METHOD_QP_CREATE),\n\t&UVERBS_METHOD(UVERBS_METHOD_QP_DESTROY));\n\nconst struct uapi_definition uverbs_def_obj_qp[] = {\n\tUAPI_DEF_CHAIN_OBJ_TREE_NAMED(UVERBS_OBJECT_QP,\n\t\t\t\t      UAPI_DEF_OBJ_NEEDS_FN(destroy_qp)),\n\t{}\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}