{
  "module_name": "uverbs_std_types_wq.c",
  "hash_id": "29f879756a0a7dae9be0b4932f96cc3117c4b2c32bb9a5c58dd38562906f19cc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/core/uverbs_std_types_wq.c",
  "human_readable_source": "\n \n\n#include <rdma/uverbs_std_types.h>\n#include \"rdma_core.h\"\n#include \"uverbs.h\"\n\nstatic int uverbs_free_wq(struct ib_uobject *uobject,\n\t\t\t  enum rdma_remove_reason why,\n\t\t\t  struct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_wq *wq = uobject->object;\n\tstruct ib_uwq_object *uwq =\n\t\tcontainer_of(uobject, struct ib_uwq_object, uevent.uobject);\n\tint ret;\n\n\tret = ib_destroy_wq_user(wq, &attrs->driver_udata);\n\tif (ret)\n\t\treturn ret;\n\n\tib_uverbs_release_uevent(&uwq->uevent);\n\treturn 0;\n}\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_WQ_CREATE)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_uwq_object *obj = container_of(\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_CREATE_WQ_HANDLE),\n\t\ttypeof(*obj), uevent.uobject);\n\tstruct ib_pd *pd =\n\t\tuverbs_attr_get_obj(attrs, UVERBS_ATTR_CREATE_WQ_PD_HANDLE);\n\tstruct ib_cq *cq =\n\t\tuverbs_attr_get_obj(attrs, UVERBS_ATTR_CREATE_WQ_CQ_HANDLE);\n\tstruct ib_wq_init_attr wq_init_attr = {};\n\tstruct ib_wq *wq;\n\tu64 user_handle;\n\tint ret;\n\n\tret = uverbs_get_flags32(&wq_init_attr.create_flags, attrs,\n\t\t\t\t UVERBS_ATTR_CREATE_WQ_FLAGS,\n\t\t\t\t IB_UVERBS_WQ_FLAGS_CVLAN_STRIPPING |\n\t\t\t\t IB_UVERBS_WQ_FLAGS_SCATTER_FCS |\n\t\t\t\t IB_UVERBS_WQ_FLAGS_DELAY_DROP |\n\t\t\t\t IB_UVERBS_WQ_FLAGS_PCI_WRITE_END_PADDING);\n\tif (!ret)\n\t\tret = uverbs_copy_from(&wq_init_attr.max_sge, attrs,\n\t\t\t       UVERBS_ATTR_CREATE_WQ_MAX_SGE);\n\tif (!ret)\n\t\tret = uverbs_copy_from(&wq_init_attr.max_wr, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_WQ_MAX_WR);\n\tif (!ret)\n\t\tret = uverbs_copy_from(&user_handle, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_WQ_USER_HANDLE);\n\tif (!ret)\n\t\tret = uverbs_get_const(&wq_init_attr.wq_type, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_WQ_TYPE);\n\tif (ret)\n\t\treturn ret;\n\n\tif (wq_init_attr.wq_type != IB_WQT_RQ)\n\t\treturn -EINVAL;\n\n\tobj->uevent.event_file = ib_uverbs_get_async_event(attrs,\n\t\t\t\t\tUVERBS_ATTR_CREATE_WQ_EVENT_FD);\n\tobj->uevent.uobject.user_handle = user_handle;\n\tINIT_LIST_HEAD(&obj->uevent.event_list);\n\twq_init_attr.event_handler = ib_uverbs_wq_event_handler;\n\twq_init_attr.wq_context = attrs->ufile;\n\twq_init_attr.cq = cq;\n\n\twq = pd->device->ops.create_wq(pd, &wq_init_attr, &attrs->driver_udata);\n\tif (IS_ERR(wq)) {\n\t\tret = PTR_ERR(wq);\n\t\tgoto err;\n\t}\n\n\tobj->uevent.uobject.object = wq;\n\twq->wq_type = wq_init_attr.wq_type;\n\twq->cq = cq;\n\twq->pd = pd;\n\twq->device = pd->device;\n\twq->wq_context = wq_init_attr.wq_context;\n\tatomic_set(&wq->usecnt, 0);\n\tatomic_inc(&pd->usecnt);\n\tatomic_inc(&cq->usecnt);\n\twq->uobject = obj;\n\tuverbs_finalize_uobj_create(attrs, UVERBS_ATTR_CREATE_WQ_HANDLE);\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_CREATE_WQ_RESP_MAX_WR,\n\t\t\t     &wq_init_attr.max_wr,\n\t\t\t     sizeof(wq_init_attr.max_wr));\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_CREATE_WQ_RESP_MAX_SGE,\n\t\t\t     &wq_init_attr.max_sge,\n\t\t\t     sizeof(wq_init_attr.max_sge));\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_CREATE_WQ_RESP_WQ_NUM,\n\t\t\t     &wq->wq_num,\n\t\t\t     sizeof(wq->wq_num));\n\treturn ret;\n\nerr:\n\tif (obj->uevent.event_file)\n\t\tuverbs_uobject_put(&obj->uevent.event_file->uobj);\n\treturn ret;\n};\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_WQ_CREATE,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_WQ_HANDLE,\n\t\t\tUVERBS_OBJECT_WQ,\n\t\t\tUVERBS_ACCESS_NEW,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_WQ_PD_HANDLE,\n\t\t\tUVERBS_OBJECT_PD,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_CONST_IN(UVERBS_ATTR_CREATE_WQ_TYPE,\n\t\t\t     enum ib_wq_type,\n\t\t\t     UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_WQ_USER_HANDLE,\n\t\t\t   UVERBS_ATTR_TYPE(u64),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_WQ_MAX_WR,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_WQ_MAX_SGE,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_FLAGS_IN(UVERBS_ATTR_CREATE_WQ_FLAGS,\n\t\t\t     enum ib_uverbs_wq_flags,\n\t\t\t     UA_MANDATORY),\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_WQ_CQ_HANDLE,\n\t\t\tUVERBS_OBJECT_CQ,\n\t\t\tUVERBS_ACCESS_READ,\n\t\t\tUA_OPTIONAL),\n\tUVERBS_ATTR_FD(UVERBS_ATTR_CREATE_WQ_EVENT_FD,\n\t\t       UVERBS_OBJECT_ASYNC_EVENT,\n\t\t       UVERBS_ACCESS_READ,\n\t\t       UA_OPTIONAL),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_CREATE_WQ_RESP_MAX_WR,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_CREATE_WQ_RESP_MAX_SGE,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_CREATE_WQ_RESP_WQ_NUM,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_OPTIONAL),\n\tUVERBS_ATTR_UHW());\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_WQ_DESTROY)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_uobject *uobj =\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_DESTROY_WQ_HANDLE);\n\tstruct ib_uwq_object *obj =\n\t\tcontainer_of(uobj, struct ib_uwq_object, uevent.uobject);\n\n\treturn uverbs_copy_to(attrs, UVERBS_ATTR_DESTROY_WQ_RESP,\n\t\t\t      &obj->uevent.events_reported,\n\t\t\t      sizeof(obj->uevent.events_reported));\n}\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_WQ_DESTROY,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_DESTROY_WQ_HANDLE,\n\t\t\tUVERBS_OBJECT_WQ,\n\t\t\tUVERBS_ACCESS_DESTROY,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_DESTROY_WQ_RESP,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY));\n\n\nDECLARE_UVERBS_NAMED_OBJECT(\n\tUVERBS_OBJECT_WQ,\n\tUVERBS_TYPE_ALLOC_IDR_SZ(sizeof(struct ib_uwq_object), uverbs_free_wq),\n\t&UVERBS_METHOD(UVERBS_METHOD_WQ_CREATE),\n\t&UVERBS_METHOD(UVERBS_METHOD_WQ_DESTROY)\n);\n\nconst struct uapi_definition uverbs_def_obj_wq[] = {\n\tUAPI_DEF_CHAIN_OBJ_TREE_NAMED(UVERBS_OBJECT_WQ,\n\t\t\t\t      UAPI_DEF_OBJ_NEEDS_FN(destroy_wq)),\n\t{}\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}