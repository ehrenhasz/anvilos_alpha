{
  "module_name": "uverbs_std_types_cq.c",
  "hash_id": "81b7f8cf97e07bbcbb809ef1277c343f8f6395452d24b9d399011bfb6df39fe1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/infiniband/core/uverbs_std_types_cq.c",
  "human_readable_source": " \n\n#include <rdma/uverbs_std_types.h>\n#include \"rdma_core.h\"\n#include \"uverbs.h\"\n#include \"restrack.h\"\n\nstatic int uverbs_free_cq(struct ib_uobject *uobject,\n\t\t\t  enum rdma_remove_reason why,\n\t\t\t  struct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_cq *cq = uobject->object;\n\tstruct ib_uverbs_event_queue *ev_queue = cq->cq_context;\n\tstruct ib_ucq_object *ucq =\n\t\tcontainer_of(uobject, struct ib_ucq_object, uevent.uobject);\n\tint ret;\n\n\tret = ib_destroy_cq_user(cq, &attrs->driver_udata);\n\tif (ret)\n\t\treturn ret;\n\n\tib_uverbs_release_ucq(\n\t\tev_queue ? container_of(ev_queue,\n\t\t\t\t\tstruct ib_uverbs_completion_event_file,\n\t\t\t\t\tev_queue) :\n\t\t\t   NULL,\n\t\tucq);\n\treturn 0;\n}\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_CQ_CREATE)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_ucq_object *obj = container_of(\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_CREATE_CQ_HANDLE),\n\t\ttypeof(*obj), uevent.uobject);\n\tstruct ib_device *ib_dev = attrs->context->device;\n\tint ret;\n\tu64 user_handle;\n\tstruct ib_cq_init_attr attr = {};\n\tstruct ib_cq                   *cq;\n\tstruct ib_uverbs_completion_event_file    *ev_file = NULL;\n\tstruct ib_uobject *ev_file_uobj;\n\n\tif (!ib_dev->ops.create_cq || !ib_dev->ops.destroy_cq)\n\t\treturn -EOPNOTSUPP;\n\n\tret = uverbs_copy_from(&attr.comp_vector, attrs,\n\t\t\t       UVERBS_ATTR_CREATE_CQ_COMP_VECTOR);\n\tif (!ret)\n\t\tret = uverbs_copy_from(&attr.cqe, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_CQ_CQE);\n\tif (!ret)\n\t\tret = uverbs_copy_from(&user_handle, attrs,\n\t\t\t\t       UVERBS_ATTR_CREATE_CQ_USER_HANDLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = uverbs_get_flags32(&attr.flags, attrs,\n\t\t\t\t UVERBS_ATTR_CREATE_CQ_FLAGS,\n\t\t\t\t IB_UVERBS_CQ_FLAGS_TIMESTAMP_COMPLETION |\n\t\t\t\t\t IB_UVERBS_CQ_FLAGS_IGNORE_OVERRUN);\n\tif (ret)\n\t\treturn ret;\n\n\tev_file_uobj = uverbs_attr_get_uobject(attrs, UVERBS_ATTR_CREATE_CQ_COMP_CHANNEL);\n\tif (!IS_ERR(ev_file_uobj)) {\n\t\tev_file = container_of(ev_file_uobj,\n\t\t\t\t       struct ib_uverbs_completion_event_file,\n\t\t\t\t       uobj);\n\t\tuverbs_uobject_get(ev_file_uobj);\n\t}\n\n\tobj->uevent.event_file = ib_uverbs_get_async_event(\n\t\tattrs, UVERBS_ATTR_CREATE_CQ_EVENT_FD);\n\n\tif (attr.comp_vector >= attrs->ufile->device->num_comp_vectors) {\n\t\tret = -EINVAL;\n\t\tgoto err_event_file;\n\t}\n\n\tINIT_LIST_HEAD(&obj->comp_list);\n\tINIT_LIST_HEAD(&obj->uevent.event_list);\n\n\tcq = rdma_zalloc_drv_obj(ib_dev, ib_cq);\n\tif (!cq) {\n\t\tret = -ENOMEM;\n\t\tgoto err_event_file;\n\t}\n\n\tcq->device        = ib_dev;\n\tcq->uobject       = obj;\n\tcq->comp_handler  = ib_uverbs_comp_handler;\n\tcq->event_handler = ib_uverbs_cq_event_handler;\n\tcq->cq_context    = ev_file ? &ev_file->ev_queue : NULL;\n\tatomic_set(&cq->usecnt, 0);\n\n\trdma_restrack_new(&cq->res, RDMA_RESTRACK_CQ);\n\trdma_restrack_set_name(&cq->res, NULL);\n\n\tret = ib_dev->ops.create_cq(cq, &attr, &attrs->driver_udata);\n\tif (ret)\n\t\tgoto err_free;\n\n\tobj->uevent.uobject.object = cq;\n\tobj->uevent.uobject.user_handle = user_handle;\n\trdma_restrack_add(&cq->res);\n\tuverbs_finalize_uobj_create(attrs, UVERBS_ATTR_CREATE_CQ_HANDLE);\n\n\tret = uverbs_copy_to(attrs, UVERBS_ATTR_CREATE_CQ_RESP_CQE, &cq->cqe,\n\t\t\t     sizeof(cq->cqe));\n\treturn ret;\n\nerr_free:\n\trdma_restrack_put(&cq->res);\n\tkfree(cq);\nerr_event_file:\n\tif (obj->uevent.event_file)\n\t\tuverbs_uobject_put(&obj->uevent.event_file->uobj);\n\tif (ev_file)\n\t\tuverbs_uobject_put(ev_file_uobj);\n\treturn ret;\n};\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_CQ_CREATE,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_CREATE_CQ_HANDLE,\n\t\t\tUVERBS_OBJECT_CQ,\n\t\t\tUVERBS_ACCESS_NEW,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_CQ_CQE,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_CQ_USER_HANDLE,\n\t\t\t   UVERBS_ATTR_TYPE(u64),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_FD(UVERBS_ATTR_CREATE_CQ_COMP_CHANNEL,\n\t\t       UVERBS_OBJECT_COMP_CHANNEL,\n\t\t       UVERBS_ACCESS_READ,\n\t\t       UA_OPTIONAL),\n\tUVERBS_ATTR_PTR_IN(UVERBS_ATTR_CREATE_CQ_COMP_VECTOR,\n\t\t\t   UVERBS_ATTR_TYPE(u32),\n\t\t\t   UA_MANDATORY),\n\tUVERBS_ATTR_FLAGS_IN(UVERBS_ATTR_CREATE_CQ_FLAGS,\n\t\t\t     enum ib_uverbs_ex_create_cq_flags),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_CREATE_CQ_RESP_CQE,\n\t\t\t    UVERBS_ATTR_TYPE(u32),\n\t\t\t    UA_MANDATORY),\n\tUVERBS_ATTR_FD(UVERBS_ATTR_CREATE_CQ_EVENT_FD,\n\t\t       UVERBS_OBJECT_ASYNC_EVENT,\n\t\t       UVERBS_ACCESS_READ,\n\t\t       UA_OPTIONAL),\n\tUVERBS_ATTR_UHW());\n\nstatic int UVERBS_HANDLER(UVERBS_METHOD_CQ_DESTROY)(\n\tstruct uverbs_attr_bundle *attrs)\n{\n\tstruct ib_uobject *uobj =\n\t\tuverbs_attr_get_uobject(attrs, UVERBS_ATTR_DESTROY_CQ_HANDLE);\n\tstruct ib_ucq_object *obj =\n\t\tcontainer_of(uobj, struct ib_ucq_object, uevent.uobject);\n\tstruct ib_uverbs_destroy_cq_resp resp = {\n\t\t.comp_events_reported = obj->comp_events_reported,\n\t\t.async_events_reported = obj->uevent.events_reported\n\t};\n\n\treturn uverbs_copy_to(attrs, UVERBS_ATTR_DESTROY_CQ_RESP, &resp,\n\t\t\t      sizeof(resp));\n}\n\nDECLARE_UVERBS_NAMED_METHOD(\n\tUVERBS_METHOD_CQ_DESTROY,\n\tUVERBS_ATTR_IDR(UVERBS_ATTR_DESTROY_CQ_HANDLE,\n\t\t\tUVERBS_OBJECT_CQ,\n\t\t\tUVERBS_ACCESS_DESTROY,\n\t\t\tUA_MANDATORY),\n\tUVERBS_ATTR_PTR_OUT(UVERBS_ATTR_DESTROY_CQ_RESP,\n\t\t\t    UVERBS_ATTR_TYPE(struct ib_uverbs_destroy_cq_resp),\n\t\t\t    UA_MANDATORY));\n\nDECLARE_UVERBS_NAMED_OBJECT(\n\tUVERBS_OBJECT_CQ,\n\tUVERBS_TYPE_ALLOC_IDR_SZ(sizeof(struct ib_ucq_object), uverbs_free_cq),\n\t&UVERBS_METHOD(UVERBS_METHOD_CQ_CREATE),\n\t&UVERBS_METHOD(UVERBS_METHOD_CQ_DESTROY)\n);\n\nconst struct uapi_definition uverbs_def_obj_cq[] = {\n\tUAPI_DEF_CHAIN_OBJ_TREE_NAMED(UVERBS_OBJECT_CQ,\n\t\t\t\t      UAPI_DEF_OBJ_NEEDS_FN(destroy_cq)),\n\t{}\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}