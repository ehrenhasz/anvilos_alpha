{
  "module_name": "leds-lp8788.c",
  "hash_id": "701da4e87d88e69b2e268c66e6d2e6385e51ea0c3bda30acae7b36f24e968b1a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/leds-lp8788.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/leds.h>\n#include <linux/mutex.h>\n#include <linux/mfd/lp8788.h>\n#include <linux/mfd/lp8788-isink.h>\n\n#define MAX_BRIGHTNESS\t\t\tLP8788_ISINK_MAX_PWM\n#define DEFAULT_LED_NAME\t\t\"keyboard-backlight\"\n\nstruct lp8788_led {\n\tstruct lp8788 *lp;\n\tstruct mutex lock;\n\tstruct led_classdev led_dev;\n\tenum lp8788_isink_number isink_num;\n\tint on;\n};\n\nstruct lp8788_led_config {\n\tenum lp8788_isink_scale scale;\n\tenum lp8788_isink_number num;\n\tint iout;\n};\n\nstatic struct lp8788_led_config default_led_config = {\n\t.scale = LP8788_ISINK_SCALE_100mA,\n\t.num   = LP8788_ISINK_3,\n\t.iout  = 0,\n};\n\nstatic int lp8788_led_init_device(struct lp8788_led *led,\n\t\t\t\tstruct lp8788_led_platform_data *pdata)\n{\n\tstruct lp8788_led_config *cfg = &default_led_config;\n\tu8 addr, mask, val;\n\tint ret;\n\n\tif (pdata) {\n\t\tcfg->scale = pdata->scale;\n\t\tcfg->num = pdata->num;\n\t\tcfg->iout = pdata->iout_code;\n\t}\n\n\tled->isink_num = cfg->num;\n\n\t \n\taddr = LP8788_ISINK_CTRL;\n\tmask = 1 << (cfg->num + LP8788_ISINK_SCALE_OFFSET);\n\tval = cfg->scale << (cfg->num + LP8788_ISINK_SCALE_OFFSET);\n\tret = lp8788_update_bits(led->lp, addr, mask, val);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\taddr = lp8788_iout_addr[cfg->num];\n\tmask = lp8788_iout_mask[cfg->num];\n\tval = cfg->iout;\n\n\treturn lp8788_update_bits(led->lp, addr, mask, val);\n}\n\nstatic int lp8788_led_enable(struct lp8788_led *led,\n\t\t\tenum lp8788_isink_number num, int on)\n{\n\tint ret;\n\n\tu8 mask = 1 << num;\n\tu8 val = on << num;\n\n\tret = lp8788_update_bits(led->lp, LP8788_ISINK_CTRL, mask, val);\n\tif (ret == 0)\n\t\tled->on = on;\n\n\treturn ret;\n}\n\nstatic int lp8788_brightness_set(struct led_classdev *led_cdev,\n\t\t\t\tenum led_brightness val)\n{\n\tstruct lp8788_led *led =\n\t\t\tcontainer_of(led_cdev, struct lp8788_led, led_dev);\n\n\tenum lp8788_isink_number num = led->isink_num;\n\tint enable, ret;\n\n\tmutex_lock(&led->lock);\n\n\tswitch (num) {\n\tcase LP8788_ISINK_1:\n\tcase LP8788_ISINK_2:\n\tcase LP8788_ISINK_3:\n\t\tret = lp8788_write_byte(led->lp, lp8788_pwm_addr[num], val);\n\t\tif (ret < 0)\n\t\t\tgoto unlock;\n\t\tbreak;\n\tdefault:\n\t\tmutex_unlock(&led->lock);\n\t\treturn -EINVAL;\n\t}\n\n\tenable = (val > 0) ? 1 : 0;\n\tif (enable != led->on)\n\t\tret = lp8788_led_enable(led, num, enable);\nunlock:\n\tmutex_unlock(&led->lock);\n\treturn ret;\n}\n\nstatic int lp8788_led_probe(struct platform_device *pdev)\n{\n\tstruct lp8788 *lp = dev_get_drvdata(pdev->dev.parent);\n\tstruct lp8788_led_platform_data *led_pdata;\n\tstruct lp8788_led *led;\n\tstruct device *dev = &pdev->dev;\n\tint ret;\n\n\tled = devm_kzalloc(dev, sizeof(struct lp8788_led), GFP_KERNEL);\n\tif (!led)\n\t\treturn -ENOMEM;\n\n\tled->lp = lp;\n\tled->led_dev.max_brightness = MAX_BRIGHTNESS;\n\tled->led_dev.brightness_set_blocking = lp8788_brightness_set;\n\n\tled_pdata = lp->pdata ? lp->pdata->led_pdata : NULL;\n\n\tif (!led_pdata || !led_pdata->name)\n\t\tled->led_dev.name = DEFAULT_LED_NAME;\n\telse\n\t\tled->led_dev.name = led_pdata->name;\n\n\tmutex_init(&led->lock);\n\n\tret = lp8788_led_init_device(led, led_pdata);\n\tif (ret) {\n\t\tdev_err(dev, \"led init device err: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_led_classdev_register(dev, &led->led_dev);\n\tif (ret) {\n\t\tdev_err(dev, \"led register err: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver lp8788_led_driver = {\n\t.probe = lp8788_led_probe,\n\t.driver = {\n\t\t.name = LP8788_DEV_KEYLED,\n\t},\n};\nmodule_platform_driver(lp8788_led_driver);\n\nMODULE_DESCRIPTION(\"Texas Instruments LP8788 Keyboard LED Driver\");\nMODULE_AUTHOR(\"Milo Kim\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:lp8788-keyled\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}