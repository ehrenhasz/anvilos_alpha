{
  "module_name": "leds-dac124s085.c",
  "hash_id": "8fc7fe01a70860dc232de05077d375c8abdd5a6bab7f3784b49df9ef67f17a25",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/leds-dac124s085.c",
  "human_readable_source": "\n \n\n#include <linux/leds.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/slab.h>\n#include <linux/spi/spi.h>\n\nstruct dac124s085_led {\n\tstruct led_classdev\tldev;\n\tstruct spi_device\t*spi;\n\tint\t\t\tid;\n\tchar\t\t\tname[sizeof(\"dac124s085-3\")];\n\n\tstruct mutex\t\tmutex;\n};\n\nstruct dac124s085 {\n\tstruct dac124s085_led leds[4];\n};\n\n#define REG_WRITE\t\t(0 << 12)\n#define REG_WRITE_UPDATE\t(1 << 12)\n#define ALL_WRITE_UPDATE\t(2 << 12)\n#define POWER_DOWN_OUTPUT\t(3 << 12)\n\nstatic int dac124s085_set_brightness(struct led_classdev *ldev,\n\t\t\t\t      enum led_brightness brightness)\n{\n\tstruct dac124s085_led *led = container_of(ldev, struct dac124s085_led,\n\t\t\t\t\t\t  ldev);\n\tu16 word;\n\tint ret;\n\n\tmutex_lock(&led->mutex);\n\tword = cpu_to_le16(((led->id) << 14) | REG_WRITE_UPDATE |\n\t\t\t   (brightness & 0xfff));\n\tret = spi_write(led->spi, (const u8 *)&word, sizeof(word));\n\tmutex_unlock(&led->mutex);\n\n\treturn ret;\n}\n\nstatic int dac124s085_probe(struct spi_device *spi)\n{\n\tstruct dac124s085\t*dac;\n\tstruct dac124s085_led\t*led;\n\tint i, ret;\n\n\tdac = devm_kzalloc(&spi->dev, sizeof(*dac), GFP_KERNEL);\n\tif (!dac)\n\t\treturn -ENOMEM;\n\n\tspi->bits_per_word = 16;\n\n\tfor (i = 0; i < ARRAY_SIZE(dac->leds); i++) {\n\t\tled\t\t= dac->leds + i;\n\t\tled->id\t\t= i;\n\t\tled->spi\t= spi;\n\t\tsnprintf(led->name, sizeof(led->name), \"dac124s085-%d\", i);\n\t\tmutex_init(&led->mutex);\n\t\tled->ldev.name = led->name;\n\t\tled->ldev.brightness = LED_OFF;\n\t\tled->ldev.max_brightness = 0xfff;\n\t\tled->ldev.brightness_set_blocking = dac124s085_set_brightness;\n\t\tret = led_classdev_register(&spi->dev, &led->ldev);\n\t\tif (ret < 0)\n\t\t\tgoto eledcr;\n\t}\n\n\tspi_set_drvdata(spi, dac);\n\n\treturn 0;\n\neledcr:\n\twhile (i--)\n\t\tled_classdev_unregister(&dac->leds[i].ldev);\n\n\treturn ret;\n}\n\nstatic void dac124s085_remove(struct spi_device *spi)\n{\n\tstruct dac124s085\t*dac = spi_get_drvdata(spi);\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(dac->leds); i++)\n\t\tled_classdev_unregister(&dac->leds[i].ldev);\n}\n\nstatic struct spi_driver dac124s085_driver = {\n\t.probe\t\t= dac124s085_probe,\n\t.remove\t\t= dac124s085_remove,\n\t.driver = {\n\t\t.name\t= \"dac124s085\",\n\t},\n};\n\nmodule_spi_driver(dac124s085_driver);\n\nMODULE_AUTHOR(\"Guennadi Liakhovetski <lg@denx.de>\");\nMODULE_DESCRIPTION(\"DAC124S085 LED driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"spi:dac124s085\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}