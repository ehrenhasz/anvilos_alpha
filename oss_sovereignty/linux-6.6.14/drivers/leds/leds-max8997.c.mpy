{
  "module_name": "leds-max8997.c",
  "hash_id": "fef57ef959b54b65a89697658752dcce179df61514d71245b10de333945151ef",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/leds-max8997.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/err.h>\n#include <linux/slab.h>\n#include <linux/leds.h>\n#include <linux/mfd/max8997.h>\n#include <linux/mfd/max8997-private.h>\n#include <linux/platform_device.h>\n\n#define MAX8997_LED_FLASH_SHIFT\t\t\t3\n#define MAX8997_LED_FLASH_CUR_MASK\t\t0xf8\n#define MAX8997_LED_MOVIE_SHIFT\t\t\t4\n#define MAX8997_LED_MOVIE_CUR_MASK\t\t0xf0\n\n#define MAX8997_LED_FLASH_MAX_BRIGHTNESS\t0x1f\n#define MAX8997_LED_MOVIE_MAX_BRIGHTNESS\t0xf\n#define MAX8997_LED_NONE_MAX_BRIGHTNESS\t\t0\n\n#define MAX8997_LED0_FLASH_MASK\t\t\t0x1\n#define MAX8997_LED0_FLASH_PIN_MASK\t\t0x5\n#define MAX8997_LED0_MOVIE_MASK\t\t\t0x8\n#define MAX8997_LED0_MOVIE_PIN_MASK\t\t0x28\n\n#define MAX8997_LED1_FLASH_MASK\t\t\t0x2\n#define MAX8997_LED1_FLASH_PIN_MASK\t\t0x6\n#define MAX8997_LED1_MOVIE_MASK\t\t\t0x10\n#define MAX8997_LED1_MOVIE_PIN_MASK\t\t0x30\n\n#define MAX8997_LED_BOOST_ENABLE_MASK\t\t(1 << 6)\n\nstruct max8997_led {\n\tstruct max8997_dev *iodev;\n\tstruct led_classdev cdev;\n\tbool enabled;\n\tint id;\n\tenum max8997_led_mode led_mode;\n\tstruct mutex mutex;\n};\n\nstatic void max8997_led_set_mode(struct max8997_led *led,\n\t\t\tenum max8997_led_mode mode)\n{\n\tint ret;\n\tstruct i2c_client *client = led->iodev->i2c;\n\tu8 mask = 0, val;\n\n\tswitch (mode) {\n\tcase MAX8997_FLASH_MODE:\n\t\tmask = MAX8997_LED1_FLASH_MASK | MAX8997_LED0_FLASH_MASK;\n\t\tval = led->id ?\n\t\t      MAX8997_LED1_FLASH_MASK : MAX8997_LED0_FLASH_MASK;\n\t\tled->cdev.max_brightness = MAX8997_LED_FLASH_MAX_BRIGHTNESS;\n\t\tbreak;\n\tcase MAX8997_MOVIE_MODE:\n\t\tmask = MAX8997_LED1_MOVIE_MASK | MAX8997_LED0_MOVIE_MASK;\n\t\tval = led->id ?\n\t\t      MAX8997_LED1_MOVIE_MASK : MAX8997_LED0_MOVIE_MASK;\n\t\tled->cdev.max_brightness = MAX8997_LED_MOVIE_MAX_BRIGHTNESS;\n\t\tbreak;\n\tcase MAX8997_FLASH_PIN_CONTROL_MODE:\n\t\tmask = MAX8997_LED1_FLASH_PIN_MASK |\n\t\t       MAX8997_LED0_FLASH_PIN_MASK;\n\t\tval = led->id ?\n\t\t      MAX8997_LED1_FLASH_PIN_MASK : MAX8997_LED0_FLASH_PIN_MASK;\n\t\tled->cdev.max_brightness = MAX8997_LED_FLASH_MAX_BRIGHTNESS;\n\t\tbreak;\n\tcase MAX8997_MOVIE_PIN_CONTROL_MODE:\n\t\tmask = MAX8997_LED1_MOVIE_PIN_MASK |\n\t\t       MAX8997_LED0_MOVIE_PIN_MASK;\n\t\tval = led->id ?\n\t\t      MAX8997_LED1_MOVIE_PIN_MASK : MAX8997_LED0_MOVIE_PIN_MASK;\n\t\tled->cdev.max_brightness = MAX8997_LED_MOVIE_MAX_BRIGHTNESS;\n\t\tbreak;\n\tdefault:\n\t\tled->cdev.max_brightness = MAX8997_LED_NONE_MAX_BRIGHTNESS;\n\t\tbreak;\n\t}\n\n\tif (mask) {\n\t\tret = max8997_update_reg(client, MAX8997_REG_LEN_CNTL, val,\n\t\t\t\t\t mask);\n\t\tif (ret)\n\t\t\tdev_err(led->iodev->dev,\n\t\t\t\t\"failed to update register(%d)\\n\", ret);\n\t}\n\n\tled->led_mode = mode;\n}\n\nstatic void max8997_led_enable(struct max8997_led *led, bool enable)\n{\n\tint ret;\n\tstruct i2c_client *client = led->iodev->i2c;\n\tu8 val = 0, mask = MAX8997_LED_BOOST_ENABLE_MASK;\n\n\tif (led->enabled == enable)\n\t\treturn;\n\n\tval = enable ? MAX8997_LED_BOOST_ENABLE_MASK : 0;\n\n\tret = max8997_update_reg(client, MAX8997_REG_BOOST_CNTL, val, mask);\n\tif (ret)\n\t\tdev_err(led->iodev->dev,\n\t\t\t\"failed to update register(%d)\\n\", ret);\n\n\tled->enabled = enable;\n}\n\nstatic void max8997_led_set_current(struct max8997_led *led,\n\t\t\t\tenum led_brightness value)\n{\n\tint ret;\n\tstruct i2c_client *client = led->iodev->i2c;\n\tu8 val = 0, mask = 0, reg = 0;\n\n\tswitch (led->led_mode) {\n\tcase MAX8997_FLASH_MODE:\n\tcase MAX8997_FLASH_PIN_CONTROL_MODE:\n\t\tval = value << MAX8997_LED_FLASH_SHIFT;\n\t\tmask = MAX8997_LED_FLASH_CUR_MASK;\n\t\treg = led->id ? MAX8997_REG_FLASH2_CUR : MAX8997_REG_FLASH1_CUR;\n\t\tbreak;\n\tcase MAX8997_MOVIE_MODE:\n\tcase MAX8997_MOVIE_PIN_CONTROL_MODE:\n\t\tval = value << MAX8997_LED_MOVIE_SHIFT;\n\t\tmask = MAX8997_LED_MOVIE_CUR_MASK;\n\t\treg = MAX8997_REG_MOVIE_CUR;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (mask) {\n\t\tret = max8997_update_reg(client, reg, val, mask);\n\t\tif (ret)\n\t\t\tdev_err(led->iodev->dev,\n\t\t\t\t\"failed to update register(%d)\\n\", ret);\n\t}\n}\n\nstatic void max8997_led_brightness_set(struct led_classdev *led_cdev,\n\t\t\t\tenum led_brightness value)\n{\n\tstruct max8997_led *led =\n\t\t\tcontainer_of(led_cdev, struct max8997_led, cdev);\n\n\tif (value) {\n\t\tmax8997_led_set_current(led, value);\n\t\tmax8997_led_enable(led, true);\n\t} else {\n\t\tmax8997_led_set_current(led, value);\n\t\tmax8997_led_enable(led, false);\n\t}\n}\n\nstatic ssize_t mode_show(struct device *dev,\n\t\t\t struct device_attribute *attr, char *buf)\n{\n\tstruct led_classdev *led_cdev = dev_get_drvdata(dev);\n\tstruct max8997_led *led =\n\t\t\tcontainer_of(led_cdev, struct max8997_led, cdev);\n\tssize_t ret = 0;\n\n\tmutex_lock(&led->mutex);\n\n\tswitch (led->led_mode) {\n\tcase MAX8997_FLASH_MODE:\n\t\tret += sprintf(buf, \"FLASH\\n\");\n\t\tbreak;\n\tcase MAX8997_MOVIE_MODE:\n\t\tret += sprintf(buf, \"MOVIE\\n\");\n\t\tbreak;\n\tcase MAX8997_FLASH_PIN_CONTROL_MODE:\n\t\tret += sprintf(buf, \"FLASH_PIN_CONTROL\\n\");\n\t\tbreak;\n\tcase MAX8997_MOVIE_PIN_CONTROL_MODE:\n\t\tret += sprintf(buf, \"MOVIE_PIN_CONTROL\\n\");\n\t\tbreak;\n\tdefault:\n\t\tret += sprintf(buf, \"NONE\\n\");\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&led->mutex);\n\n\treturn ret;\n}\n\nstatic ssize_t mode_store(struct device *dev,\n\t\t\t  struct device_attribute *attr,\n\t\t\t  const char *buf, size_t size)\n{\n\tstruct led_classdev *led_cdev = dev_get_drvdata(dev);\n\tstruct max8997_led *led =\n\t\t\tcontainer_of(led_cdev, struct max8997_led, cdev);\n\tenum max8997_led_mode mode;\n\n\tmutex_lock(&led->mutex);\n\n\tif (!strncmp(buf, \"FLASH_PIN_CONTROL\", 17))\n\t\tmode = MAX8997_FLASH_PIN_CONTROL_MODE;\n\telse if (!strncmp(buf, \"MOVIE_PIN_CONTROL\", 17))\n\t\tmode = MAX8997_MOVIE_PIN_CONTROL_MODE;\n\telse if (!strncmp(buf, \"FLASH\", 5))\n\t\tmode = MAX8997_FLASH_MODE;\n\telse if (!strncmp(buf, \"MOVIE\", 5))\n\t\tmode = MAX8997_MOVIE_MODE;\n\telse\n\t\tmode = MAX8997_NONE;\n\n\tmax8997_led_set_mode(led, mode);\n\n\tmutex_unlock(&led->mutex);\n\n\treturn size;\n}\n\nstatic DEVICE_ATTR_RW(mode);\n\nstatic struct attribute *max8997_attrs[] = {\n\t&dev_attr_mode.attr,\n\tNULL\n};\nATTRIBUTE_GROUPS(max8997);\n\nstatic int max8997_led_probe(struct platform_device *pdev)\n{\n\tstruct max8997_dev *iodev = dev_get_drvdata(pdev->dev.parent);\n\tstruct max8997_platform_data *pdata = dev_get_platdata(iodev->dev);\n\tstruct max8997_led *led;\n\tchar name[20];\n\tint ret = 0;\n\n\tled = devm_kzalloc(&pdev->dev, sizeof(*led), GFP_KERNEL);\n\tif (led == NULL)\n\t\treturn -ENOMEM;\n\n\tled->id = pdev->id;\n\tsnprintf(name, sizeof(name), \"max8997-led%d\", pdev->id);\n\n\tled->cdev.name = name;\n\tled->cdev.brightness_set = max8997_led_brightness_set;\n\tled->cdev.flags |= LED_CORE_SUSPENDRESUME;\n\tled->cdev.brightness = 0;\n\tled->cdev.groups = max8997_groups;\n\tled->iodev = iodev;\n\n\t \n\tif (pdata && pdata->led_pdata) {\n\t\tu8 mode = 0, brightness = 0;\n\n\t\tmode = pdata->led_pdata->mode[led->id];\n\t\tbrightness = pdata->led_pdata->brightness[led->id];\n\n\t\tmax8997_led_set_mode(led, mode);\n\n\t\tif (brightness > led->cdev.max_brightness)\n\t\t\tbrightness = led->cdev.max_brightness;\n\t\tmax8997_led_set_current(led, brightness);\n\t\tled->cdev.brightness = brightness;\n\t} else {\n\t\tmax8997_led_set_mode(led, MAX8997_NONE);\n\t\tmax8997_led_set_current(led, 0);\n\t}\n\n\tmutex_init(&led->mutex);\n\n\tret = devm_led_classdev_register(&pdev->dev, &led->cdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic struct platform_driver max8997_led_driver = {\n\t.driver = {\n\t\t.name  = \"max8997-led\",\n\t},\n\t.probe  = max8997_led_probe,\n};\n\nmodule_platform_driver(max8997_led_driver);\n\nMODULE_AUTHOR(\"Donggeun Kim <dg77.kim@samsung.com>\");\nMODULE_DESCRIPTION(\"MAX8997 LED driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:max8997-led\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}