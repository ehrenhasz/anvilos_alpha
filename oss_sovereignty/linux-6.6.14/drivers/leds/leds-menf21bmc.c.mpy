{
  "module_name": "leds-menf21bmc.c",
  "hash_id": "67f052c4f90fcc2c81e6b88bef02e309d7c15cb826339a2a8a303281d513a415",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/leds-menf21bmc.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/leds.h>\n#include <linux/i2c.h>\n\n#define BMC_CMD_LED_GET_SET\t0xA0\n#define BMC_BIT_LED_STATUS\tBIT(0)\n#define BMC_BIT_LED_HOTSWAP\tBIT(1)\n#define BMC_BIT_LED_USER1\tBIT(2)\n#define BMC_BIT_LED_USER2\tBIT(3)\n\nstruct menf21bmc_led {\n\tstruct led_classdev cdev;\n\tu8 led_bit;\n\tconst char *name;\n\tstruct i2c_client *i2c_client;\n};\n\nstatic struct menf21bmc_led leds[] = {\n\t{\n\t\t.name = \"menf21bmc:led_status\",\n\t\t.led_bit = BMC_BIT_LED_STATUS,\n\t},\n\t{\n\t\t.name = \"menf21bmc:led_hotswap\",\n\t\t.led_bit = BMC_BIT_LED_HOTSWAP,\n\t},\n\t{\n\t\t.name = \"menf21bmc:led_user1\",\n\t\t.led_bit = BMC_BIT_LED_USER1,\n\t},\n\t{\n\t\t.name = \"menf21bmc:led_user2\",\n\t\t.led_bit = BMC_BIT_LED_USER2,\n\t}\n};\n\nstatic DEFINE_MUTEX(led_lock);\n\nstatic void\nmenf21bmc_led_set(struct led_classdev *led_cdev, enum led_brightness value)\n{\n\tint led_val;\n\tstruct menf21bmc_led *led = container_of(led_cdev,\n\t\t\t\t\tstruct menf21bmc_led, cdev);\n\n\tmutex_lock(&led_lock);\n\tled_val = i2c_smbus_read_byte_data(led->i2c_client,\n\t\t\t\t\t   BMC_CMD_LED_GET_SET);\n\tif (led_val < 0)\n\t\tgoto err_out;\n\n\tif (value == LED_OFF)\n\t\tled_val &= ~led->led_bit;\n\telse\n\t\tled_val |= led->led_bit;\n\n\ti2c_smbus_write_byte_data(led->i2c_client,\n\t\t\t\t  BMC_CMD_LED_GET_SET, led_val);\nerr_out:\n\tmutex_unlock(&led_lock);\n}\n\nstatic int menf21bmc_led_probe(struct platform_device *pdev)\n{\n\tint i;\n\tint ret;\n\tstruct i2c_client *i2c_client = to_i2c_client(pdev->dev.parent);\n\n\tfor (i = 0; i < ARRAY_SIZE(leds); i++) {\n\t\tleds[i].cdev.name = leds[i].name;\n\t\tleds[i].cdev.brightness_set = menf21bmc_led_set;\n\t\tleds[i].i2c_client = i2c_client;\n\t\tret = devm_led_classdev_register(&pdev->dev, &leds[i].cdev);\n\t\tif (ret < 0) {\n\t\t\tdev_err(&pdev->dev, \"failed to register LED device\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\tdev_info(&pdev->dev, \"MEN 140F21P00 BMC LED device enabled\\n\");\n\n\treturn 0;\n\n}\n\nstatic struct platform_driver menf21bmc_led = {\n\t.probe\t\t= menf21bmc_led_probe,\n\t.driver\t\t= {\n\t\t.name\t\t= \"menf21bmc_led\",\n\t},\n};\n\nmodule_platform_driver(menf21bmc_led);\n\nMODULE_AUTHOR(\"Andreas Werner <andreas.werner@men.de>\");\nMODULE_DESCRIPTION(\"MEN 14F021P00 BMC led driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:menf21bmc_led\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}