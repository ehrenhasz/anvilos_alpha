{
  "module_name": "leds-ti-lmu-common.c",
  "hash_id": "f4efec57a3940bcd99fb5f089c6a0b564b8c7d8d0a625f0d52ddb752f2a3ff16",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/leds-ti-lmu-common.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/bitops.h>\n#include <linux/err.h>\n#include <linux/property.h>\n\n#include <linux/leds-ti-lmu-common.h>\n\nstatic const unsigned int ramp_table[16] = {2048, 262000, 524000, 1049000,\n\t\t\t\t2090000, 4194000, 8389000, 16780000, 33550000,\n\t\t\t\t41940000, 50330000, 58720000, 67110000,\n\t\t\t\t83880000, 100660000, 117440000};\n\nstatic int ti_lmu_common_update_brightness(struct ti_lmu_bank *lmu_bank,\n\t\t\t\t\t   int brightness)\n{\n\tstruct regmap *regmap = lmu_bank->regmap;\n\tu8 reg, val;\n\tint ret;\n\n\t \n\tif (lmu_bank->max_brightness == MAX_BRIGHTNESS_11BIT) {\n\t\treg = lmu_bank->lsb_brightness_reg;\n\t\tret = regmap_update_bits(regmap, reg,\n\t\t\t\t\t LMU_11BIT_LSB_MASK,\n\t\t\t\t\t brightness);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tval = brightness >> LMU_11BIT_MSB_SHIFT;\n\t} else {\n\t\tval = brightness;\n\t}\n\n\treg = lmu_bank->msb_brightness_reg;\n\n\treturn regmap_write(regmap, reg, val);\n}\n\nint ti_lmu_common_set_brightness(struct ti_lmu_bank *lmu_bank, int brightness)\n{\n\treturn ti_lmu_common_update_brightness(lmu_bank, brightness);\n}\nEXPORT_SYMBOL(ti_lmu_common_set_brightness);\n\nstatic unsigned int ti_lmu_common_convert_ramp_to_index(unsigned int usec)\n{\n\tint size = ARRAY_SIZE(ramp_table);\n\tint i;\n\n\tif (usec <= ramp_table[0])\n\t\treturn 0;\n\n\tif (usec > ramp_table[size - 1])\n\t\treturn size - 1;\n\n\tfor (i = 1; i < size; i++) {\n\t\tif (usec == ramp_table[i])\n\t\t\treturn i;\n\n\t\t \n\t\tif (usec > ramp_table[i - 1] && usec < ramp_table[i]) {\n\t\t\tif (usec - ramp_table[i - 1] < ramp_table[i] - usec)\n\t\t\t\treturn i - 1;\n\t\t\telse\n\t\t\t\treturn i;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint ti_lmu_common_set_ramp(struct ti_lmu_bank *lmu_bank)\n{\n\tstruct regmap *regmap = lmu_bank->regmap;\n\tu8 ramp, ramp_up, ramp_down;\n\n\tif (lmu_bank->ramp_up_usec == 0 && lmu_bank->ramp_down_usec == 0) {\n\t\tramp_up = 0;\n\t\tramp_down = 0;\n\t} else {\n\t\tramp_up = ti_lmu_common_convert_ramp_to_index(lmu_bank->ramp_up_usec);\n\t\tramp_down = ti_lmu_common_convert_ramp_to_index(lmu_bank->ramp_down_usec);\n\t}\n\n\tramp = (ramp_up << 4) | ramp_down;\n\n\treturn regmap_write(regmap, lmu_bank->runtime_ramp_reg, ramp);\n\n}\nEXPORT_SYMBOL(ti_lmu_common_set_ramp);\n\nint ti_lmu_common_get_ramp_params(struct device *dev,\n\t\t\t\t  struct fwnode_handle *child,\n\t\t\t\t  struct ti_lmu_bank *lmu_data)\n{\n\tint ret;\n\n\tret = fwnode_property_read_u32(child, \"ramp-up-us\",\n\t\t\t\t &lmu_data->ramp_up_usec);\n\tif (ret)\n\t\tdev_warn(dev, \"ramp-up-us property missing\\n\");\n\n\n\tret = fwnode_property_read_u32(child, \"ramp-down-us\",\n\t\t\t\t &lmu_data->ramp_down_usec);\n\tif (ret)\n\t\tdev_warn(dev, \"ramp-down-us property missing\\n\");\n\n\treturn 0;\n}\nEXPORT_SYMBOL(ti_lmu_common_get_ramp_params);\n\nint ti_lmu_common_get_brt_res(struct device *dev, struct fwnode_handle *child,\n\t\t\t\t  struct ti_lmu_bank *lmu_data)\n{\n\tint ret;\n\n\tret = device_property_read_u32(dev, \"ti,brightness-resolution\",\n\t\t\t\t       &lmu_data->max_brightness);\n\tif (ret)\n\t\tret = fwnode_property_read_u32(child,\n\t\t\t\t\t       \"ti,brightness-resolution\",\n\t\t\t\t\t       &lmu_data->max_brightness);\n\tif (lmu_data->max_brightness <= 0) {\n\t\tlmu_data->max_brightness = MAX_BRIGHTNESS_8BIT;\n\t\treturn ret;\n\t}\n\n\tif (lmu_data->max_brightness > MAX_BRIGHTNESS_11BIT)\n\t\t\tlmu_data->max_brightness = MAX_BRIGHTNESS_11BIT;\n\n\n\treturn 0;\n}\nEXPORT_SYMBOL(ti_lmu_common_get_brt_res);\n\nMODULE_DESCRIPTION(\"TI LMU common LED framework\");\nMODULE_AUTHOR(\"Sebastian Reichel\");\nMODULE_AUTHOR(\"Dan Murphy <dmurphy@ti.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"ti-lmu-led-common\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}