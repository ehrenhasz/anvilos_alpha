{
  "module_name": "ledtrig-backlight.c",
  "hash_id": "30e0e62bc324ed2cc1956d767a1ac0cde28c729f09dc0047e04d473321ef8dd6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/trigger/ledtrig-backlight.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/fb.h>\n#include <linux/leds.h>\n#include \"../leds.h\"\n\n#define BLANK\t\t1\n#define UNBLANK\t\t0\n\nstruct bl_trig_notifier {\n\tstruct led_classdev *led;\n\tint brightness;\n\tint old_status;\n\tstruct notifier_block notifier;\n\tunsigned invert;\n};\n\nstatic int fb_notifier_callback(struct notifier_block *p,\n\t\t\t\tunsigned long event, void *data)\n{\n\tstruct bl_trig_notifier *n = container_of(p,\n\t\t\t\t\tstruct bl_trig_notifier, notifier);\n\tstruct led_classdev *led = n->led;\n\tstruct fb_event *fb_event = data;\n\tint *blank;\n\tint new_status;\n\n\t \n\tif (event != FB_EVENT_BLANK)\n\t\treturn 0;\n\n\tblank = fb_event->data;\n\tnew_status = *blank ? BLANK : UNBLANK;\n\n\tif (new_status == n->old_status)\n\t\treturn 0;\n\n\tif ((n->old_status == UNBLANK) ^ n->invert) {\n\t\tn->brightness = led->brightness;\n\t\tled_set_brightness_nosleep(led, LED_OFF);\n\t} else {\n\t\tled_set_brightness_nosleep(led, n->brightness);\n\t}\n\n\tn->old_status = new_status;\n\n\treturn 0;\n}\n\nstatic ssize_t bl_trig_invert_show(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct bl_trig_notifier *n = led_trigger_get_drvdata(dev);\n\n\treturn sprintf(buf, \"%u\\n\", n->invert);\n}\n\nstatic ssize_t bl_trig_invert_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t num)\n{\n\tstruct led_classdev *led = led_trigger_get_led(dev);\n\tstruct bl_trig_notifier *n = led_trigger_get_drvdata(dev);\n\tunsigned long invert;\n\tint ret;\n\n\tret = kstrtoul(buf, 10, &invert);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (invert > 1)\n\t\treturn -EINVAL;\n\n\tn->invert = invert;\n\n\t \n\tif ((n->old_status == BLANK) ^ n->invert)\n\t\tled_set_brightness_nosleep(led, LED_OFF);\n\telse\n\t\tled_set_brightness_nosleep(led, n->brightness);\n\n\treturn num;\n}\nstatic DEVICE_ATTR(inverted, 0644, bl_trig_invert_show, bl_trig_invert_store);\n\nstatic struct attribute *bl_trig_attrs[] = {\n\t&dev_attr_inverted.attr,\n\tNULL,\n};\nATTRIBUTE_GROUPS(bl_trig);\n\nstatic int bl_trig_activate(struct led_classdev *led)\n{\n\tint ret;\n\n\tstruct bl_trig_notifier *n;\n\n\tn = kzalloc(sizeof(struct bl_trig_notifier), GFP_KERNEL);\n\tif (!n)\n\t\treturn -ENOMEM;\n\tled_set_trigger_data(led, n);\n\n\tn->led = led;\n\tn->brightness = led->brightness;\n\tn->old_status = UNBLANK;\n\tn->notifier.notifier_call = fb_notifier_callback;\n\n\tret = fb_register_client(&n->notifier);\n\tif (ret)\n\t\tdev_err(led->dev, \"unable to register backlight trigger\\n\");\n\n\treturn 0;\n}\n\nstatic void bl_trig_deactivate(struct led_classdev *led)\n{\n\tstruct bl_trig_notifier *n = led_get_trigger_data(led);\n\n\tfb_unregister_client(&n->notifier);\n\tkfree(n);\n}\n\nstatic struct led_trigger bl_led_trigger = {\n\t.name\t\t= \"backlight\",\n\t.activate\t= bl_trig_activate,\n\t.deactivate\t= bl_trig_deactivate,\n\t.groups\t\t= bl_trig_groups,\n};\nmodule_led_trigger(bl_led_trigger);\n\nMODULE_AUTHOR(\"Rodolfo Giometti <giometti@linux.it>\");\nMODULE_DESCRIPTION(\"Backlight emulation LED trigger\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}