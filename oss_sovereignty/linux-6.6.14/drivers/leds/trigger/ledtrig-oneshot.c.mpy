{
  "module_name": "ledtrig-oneshot.c",
  "hash_id": "0ce4a31755a3d3682829f52a85becfd160cb8ca72743a9d941a45151e88f0be5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/trigger/ledtrig-oneshot.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/device.h>\n#include <linux/ctype.h>\n#include <linux/slab.h>\n#include <linux/leds.h>\n#include \"../leds.h\"\n\n#define DEFAULT_DELAY 100\n\nstruct oneshot_trig_data {\n\tunsigned int invert;\n};\n\nstatic ssize_t led_shot(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t size)\n{\n\tstruct led_classdev *led_cdev = led_trigger_get_led(dev);\n\tstruct oneshot_trig_data *oneshot_data = led_trigger_get_drvdata(dev);\n\n\tled_blink_set_oneshot(led_cdev,\n\t\t\t&led_cdev->blink_delay_on, &led_cdev->blink_delay_off,\n\t\t\toneshot_data->invert);\n\n\t \n\treturn size;\n}\nstatic ssize_t led_invert_show(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct oneshot_trig_data *oneshot_data = led_trigger_get_drvdata(dev);\n\n\treturn sprintf(buf, \"%u\\n\", oneshot_data->invert);\n}\n\nstatic ssize_t led_invert_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t size)\n{\n\tstruct led_classdev *led_cdev = led_trigger_get_led(dev);\n\tstruct oneshot_trig_data *oneshot_data = led_trigger_get_drvdata(dev);\n\tunsigned long state;\n\tint ret;\n\n\tret = kstrtoul(buf, 0, &state);\n\tif (ret)\n\t\treturn ret;\n\n\toneshot_data->invert = !!state;\n\n\tif (oneshot_data->invert)\n\t\tled_set_brightness_nosleep(led_cdev, LED_FULL);\n\telse\n\t\tled_set_brightness_nosleep(led_cdev, LED_OFF);\n\n\treturn size;\n}\n\nstatic ssize_t led_delay_on_show(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct led_classdev *led_cdev = led_trigger_get_led(dev);\n\n\treturn sprintf(buf, \"%lu\\n\", led_cdev->blink_delay_on);\n}\n\nstatic ssize_t led_delay_on_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t size)\n{\n\tstruct led_classdev *led_cdev = led_trigger_get_led(dev);\n\tunsigned long state;\n\tint ret;\n\n\tret = kstrtoul(buf, 0, &state);\n\tif (ret)\n\t\treturn ret;\n\n\tled_cdev->blink_delay_on = state;\n\n\treturn size;\n}\n\nstatic ssize_t led_delay_off_show(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct led_classdev *led_cdev = led_trigger_get_led(dev);\n\n\treturn sprintf(buf, \"%lu\\n\", led_cdev->blink_delay_off);\n}\n\nstatic ssize_t led_delay_off_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t size)\n{\n\tstruct led_classdev *led_cdev = led_trigger_get_led(dev);\n\tunsigned long state;\n\tint ret;\n\n\tret = kstrtoul(buf, 0, &state);\n\tif (ret)\n\t\treturn ret;\n\n\tled_cdev->blink_delay_off = state;\n\n\treturn size;\n}\n\nstatic DEVICE_ATTR(delay_on, 0644, led_delay_on_show, led_delay_on_store);\nstatic DEVICE_ATTR(delay_off, 0644, led_delay_off_show, led_delay_off_store);\nstatic DEVICE_ATTR(invert, 0644, led_invert_show, led_invert_store);\nstatic DEVICE_ATTR(shot, 0200, NULL, led_shot);\n\nstatic struct attribute *oneshot_trig_attrs[] = {\n\t&dev_attr_delay_on.attr,\n\t&dev_attr_delay_off.attr,\n\t&dev_attr_invert.attr,\n\t&dev_attr_shot.attr,\n\tNULL\n};\nATTRIBUTE_GROUPS(oneshot_trig);\n\nstatic void pattern_init(struct led_classdev *led_cdev)\n{\n\tu32 *pattern;\n\tunsigned int size = 0;\n\n\tpattern = led_get_default_pattern(led_cdev, &size);\n\tif (!pattern)\n\t\tgoto out_default;\n\n\tif (size != 2) {\n\t\tdev_warn(led_cdev->dev,\n\t\t\t \"Expected 2 but got %u values for delays pattern\\n\",\n\t\t\t size);\n\t\tgoto out_default;\n\t}\n\n\tled_cdev->blink_delay_on = pattern[0];\n\tled_cdev->blink_delay_off = pattern[1];\n\tkfree(pattern);\n\n\treturn;\n\nout_default:\n\tkfree(pattern);\n\tled_cdev->blink_delay_on = DEFAULT_DELAY;\n\tled_cdev->blink_delay_off = DEFAULT_DELAY;\n}\n\nstatic int oneshot_trig_activate(struct led_classdev *led_cdev)\n{\n\tstruct oneshot_trig_data *oneshot_data;\n\n\toneshot_data = kzalloc(sizeof(*oneshot_data), GFP_KERNEL);\n\tif (!oneshot_data)\n\t\treturn -ENOMEM;\n\n\tled_set_trigger_data(led_cdev, oneshot_data);\n\n\tif (led_cdev->flags & LED_INIT_DEFAULT_TRIGGER) {\n\t\tpattern_init(led_cdev);\n\t\t \n\t\tled_cdev->flags &= ~LED_INIT_DEFAULT_TRIGGER;\n\t}\n\n\treturn 0;\n}\n\nstatic void oneshot_trig_deactivate(struct led_classdev *led_cdev)\n{\n\tstruct oneshot_trig_data *oneshot_data = led_get_trigger_data(led_cdev);\n\n\tkfree(oneshot_data);\n\n\t \n\tled_set_brightness(led_cdev, LED_OFF);\n}\n\nstatic struct led_trigger oneshot_led_trigger = {\n\t.name     = \"oneshot\",\n\t.activate = oneshot_trig_activate,\n\t.deactivate = oneshot_trig_deactivate,\n\t.groups = oneshot_trig_groups,\n};\nmodule_led_trigger(oneshot_led_trigger);\n\nMODULE_AUTHOR(\"Fabio Baltieri <fabio.baltieri@gmail.com>\");\nMODULE_DESCRIPTION(\"One-shot LED trigger\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}