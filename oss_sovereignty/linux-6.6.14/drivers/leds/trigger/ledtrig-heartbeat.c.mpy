{
  "module_name": "ledtrig-heartbeat.c",
  "hash_id": "e90ce554dc0c3e8c83b3a8d825631c3c3681d103790a6deae9defb7d963ba1e8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/trigger/ledtrig-heartbeat.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/panic_notifier.h>\n#include <linux/slab.h>\n#include <linux/timer.h>\n#include <linux/sched.h>\n#include <linux/sched/loadavg.h>\n#include <linux/leds.h>\n#include <linux/reboot.h>\n#include \"../leds.h\"\n\nstatic int panic_heartbeats;\n\nstruct heartbeat_trig_data {\n\tstruct led_classdev *led_cdev;\n\tunsigned int phase;\n\tunsigned int period;\n\tstruct timer_list timer;\n\tunsigned int invert;\n};\n\nstatic void led_heartbeat_function(struct timer_list *t)\n{\n\tstruct heartbeat_trig_data *heartbeat_data =\n\t\tfrom_timer(heartbeat_data, t, timer);\n\tstruct led_classdev *led_cdev;\n\tunsigned long brightness = LED_OFF;\n\tunsigned long delay = 0;\n\n\tled_cdev = heartbeat_data->led_cdev;\n\n\tif (unlikely(panic_heartbeats)) {\n\t\tled_set_brightness_nosleep(led_cdev, LED_OFF);\n\t\treturn;\n\t}\n\n\tif (test_and_clear_bit(LED_BLINK_BRIGHTNESS_CHANGE, &led_cdev->work_flags))\n\t\tled_cdev->blink_brightness = led_cdev->new_blink_brightness;\n\n\t \n\tswitch (heartbeat_data->phase) {\n\tcase 0:\n\t\t \n\t\theartbeat_data->period = 300 +\n\t\t\t(6720 << FSHIFT) / (5 * avenrun[0] + (7 << FSHIFT));\n\t\theartbeat_data->period =\n\t\t\tmsecs_to_jiffies(heartbeat_data->period);\n\t\tdelay = msecs_to_jiffies(70);\n\t\theartbeat_data->phase++;\n\t\tif (!heartbeat_data->invert)\n\t\t\tbrightness = led_cdev->blink_brightness;\n\t\tbreak;\n\tcase 1:\n\t\tdelay = heartbeat_data->period / 4 - msecs_to_jiffies(70);\n\t\theartbeat_data->phase++;\n\t\tif (heartbeat_data->invert)\n\t\t\tbrightness = led_cdev->blink_brightness;\n\t\tbreak;\n\tcase 2:\n\t\tdelay = msecs_to_jiffies(70);\n\t\theartbeat_data->phase++;\n\t\tif (!heartbeat_data->invert)\n\t\t\tbrightness = led_cdev->blink_brightness;\n\t\tbreak;\n\tdefault:\n\t\tdelay = heartbeat_data->period - heartbeat_data->period / 4 -\n\t\t\tmsecs_to_jiffies(70);\n\t\theartbeat_data->phase = 0;\n\t\tif (heartbeat_data->invert)\n\t\t\tbrightness = led_cdev->blink_brightness;\n\t\tbreak;\n\t}\n\n\tled_set_brightness_nosleep(led_cdev, brightness);\n\tmod_timer(&heartbeat_data->timer, jiffies + delay);\n}\n\nstatic ssize_t led_invert_show(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct heartbeat_trig_data *heartbeat_data =\n\t\tled_trigger_get_drvdata(dev);\n\n\treturn sprintf(buf, \"%u\\n\", heartbeat_data->invert);\n}\n\nstatic ssize_t led_invert_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t size)\n{\n\tstruct heartbeat_trig_data *heartbeat_data =\n\t\tled_trigger_get_drvdata(dev);\n\tunsigned long state;\n\tint ret;\n\n\tret = kstrtoul(buf, 0, &state);\n\tif (ret)\n\t\treturn ret;\n\n\theartbeat_data->invert = !!state;\n\n\treturn size;\n}\n\nstatic DEVICE_ATTR(invert, 0644, led_invert_show, led_invert_store);\n\nstatic struct attribute *heartbeat_trig_attrs[] = {\n\t&dev_attr_invert.attr,\n\tNULL\n};\nATTRIBUTE_GROUPS(heartbeat_trig);\n\nstatic int heartbeat_trig_activate(struct led_classdev *led_cdev)\n{\n\tstruct heartbeat_trig_data *heartbeat_data;\n\n\theartbeat_data = kzalloc(sizeof(*heartbeat_data), GFP_KERNEL);\n\tif (!heartbeat_data)\n\t\treturn -ENOMEM;\n\n\tled_set_trigger_data(led_cdev, heartbeat_data);\n\theartbeat_data->led_cdev = led_cdev;\n\n\ttimer_setup(&heartbeat_data->timer, led_heartbeat_function, 0);\n\theartbeat_data->phase = 0;\n\tif (!led_cdev->blink_brightness)\n\t\tled_cdev->blink_brightness = led_cdev->max_brightness;\n\tled_heartbeat_function(&heartbeat_data->timer);\n\tset_bit(LED_BLINK_SW, &led_cdev->work_flags);\n\n\treturn 0;\n}\n\nstatic void heartbeat_trig_deactivate(struct led_classdev *led_cdev)\n{\n\tstruct heartbeat_trig_data *heartbeat_data =\n\t\tled_get_trigger_data(led_cdev);\n\n\ttimer_shutdown_sync(&heartbeat_data->timer);\n\tkfree(heartbeat_data);\n\tclear_bit(LED_BLINK_SW, &led_cdev->work_flags);\n}\n\nstatic struct led_trigger heartbeat_led_trigger = {\n\t.name     = \"heartbeat\",\n\t.activate = heartbeat_trig_activate,\n\t.deactivate = heartbeat_trig_deactivate,\n\t.groups = heartbeat_trig_groups,\n};\n\nstatic int heartbeat_reboot_notifier(struct notifier_block *nb,\n\t\t\t\t     unsigned long code, void *unused)\n{\n\tled_trigger_unregister(&heartbeat_led_trigger);\n\treturn NOTIFY_DONE;\n}\n\nstatic int heartbeat_panic_notifier(struct notifier_block *nb,\n\t\t\t\t     unsigned long code, void *unused)\n{\n\tpanic_heartbeats = 1;\n\treturn NOTIFY_DONE;\n}\n\nstatic struct notifier_block heartbeat_reboot_nb = {\n\t.notifier_call = heartbeat_reboot_notifier,\n};\n\nstatic struct notifier_block heartbeat_panic_nb = {\n\t.notifier_call = heartbeat_panic_notifier,\n};\n\nstatic int __init heartbeat_trig_init(void)\n{\n\tint rc = led_trigger_register(&heartbeat_led_trigger);\n\n\tif (!rc) {\n\t\tatomic_notifier_chain_register(&panic_notifier_list,\n\t\t\t\t\t       &heartbeat_panic_nb);\n\t\tregister_reboot_notifier(&heartbeat_reboot_nb);\n\t}\n\treturn rc;\n}\n\nstatic void __exit heartbeat_trig_exit(void)\n{\n\tunregister_reboot_notifier(&heartbeat_reboot_nb);\n\tatomic_notifier_chain_unregister(&panic_notifier_list,\n\t\t\t\t\t &heartbeat_panic_nb);\n\tled_trigger_unregister(&heartbeat_led_trigger);\n}\n\nmodule_init(heartbeat_trig_init);\nmodule_exit(heartbeat_trig_exit);\n\nMODULE_AUTHOR(\"Atsushi Nemoto <anemo@mba.ocn.ne.jp>\");\nMODULE_DESCRIPTION(\"Heartbeat LED trigger\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}