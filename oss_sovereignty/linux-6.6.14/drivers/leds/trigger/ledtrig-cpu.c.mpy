{
  "module_name": "ledtrig-cpu.c",
  "hash_id": "b3ae1411a38bb40db56fe176d2fc1dcbf64173d9834df4e5f0955fa4b80ef716",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/trigger/ledtrig-cpu.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/percpu.h>\n#include <linux/syscore_ops.h>\n#include <linux/rwsem.h>\n#include <linux/cpu.h>\n#include \"../leds.h\"\n\n#define MAX_NAME_LEN\t8\n\nstruct led_trigger_cpu {\n\tbool is_active;\n\tchar name[MAX_NAME_LEN];\n\tstruct led_trigger *_trig;\n};\n\nstatic DEFINE_PER_CPU(struct led_trigger_cpu, cpu_trig);\n\nstatic struct led_trigger *trig_cpu_all;\nstatic atomic_t num_active_cpus = ATOMIC_INIT(0);\n\n \nvoid ledtrig_cpu(enum cpu_led_event ledevt)\n{\n\tstruct led_trigger_cpu *trig = this_cpu_ptr(&cpu_trig);\n\tbool is_active = trig->is_active;\n\n\t \n\tswitch (ledevt) {\n\tcase CPU_LED_IDLE_END:\n\tcase CPU_LED_START:\n\t\t \n\t\tis_active = true;\n\t\tbreak;\n\n\tcase CPU_LED_IDLE_START:\n\tcase CPU_LED_STOP:\n\tcase CPU_LED_HALTED:\n\t\t \n\t\tis_active = false;\n\t\tbreak;\n\n\tdefault:\n\t\t \n\t\tbreak;\n\t}\n\n\tif (is_active != trig->is_active) {\n\t\tunsigned int active_cpus;\n\t\tunsigned int total_cpus;\n\n\t\t \n\t\ttrig->is_active = is_active;\n\t\tatomic_add(is_active ? 1 : -1, &num_active_cpus);\n\t\tactive_cpus = atomic_read(&num_active_cpus);\n\t\ttotal_cpus = num_present_cpus();\n\n\t\tled_trigger_event(trig->_trig,\n\t\t\tis_active ? LED_FULL : LED_OFF);\n\n\n\t\tled_trigger_event(trig_cpu_all,\n\t\t\tDIV_ROUND_UP(LED_FULL * active_cpus, total_cpus));\n\n\t}\n}\nEXPORT_SYMBOL(ledtrig_cpu);\n\nstatic int ledtrig_cpu_syscore_suspend(void)\n{\n\tledtrig_cpu(CPU_LED_STOP);\n\treturn 0;\n}\n\nstatic void ledtrig_cpu_syscore_resume(void)\n{\n\tledtrig_cpu(CPU_LED_START);\n}\n\nstatic void ledtrig_cpu_syscore_shutdown(void)\n{\n\tledtrig_cpu(CPU_LED_HALTED);\n}\n\nstatic struct syscore_ops ledtrig_cpu_syscore_ops = {\n\t.shutdown\t= ledtrig_cpu_syscore_shutdown,\n\t.suspend\t= ledtrig_cpu_syscore_suspend,\n\t.resume\t\t= ledtrig_cpu_syscore_resume,\n};\n\nstatic int ledtrig_online_cpu(unsigned int cpu)\n{\n\tledtrig_cpu(CPU_LED_START);\n\treturn 0;\n}\n\nstatic int ledtrig_prepare_down_cpu(unsigned int cpu)\n{\n\tledtrig_cpu(CPU_LED_STOP);\n\treturn 0;\n}\n\nstatic int __init ledtrig_cpu_init(void)\n{\n\tunsigned int cpu;\n\tint ret;\n\n\t \n\tBUILD_BUG_ON(CONFIG_NR_CPUS > 9999);\n\n\t \n\tled_trigger_register_simple(\"cpu\", &trig_cpu_all);\n\n\t \n\tfor_each_possible_cpu(cpu) {\n\t\tstruct led_trigger_cpu *trig = &per_cpu(cpu_trig, cpu);\n\n\t\tif (cpu >= 8)\n\t\t\tcontinue;\n\n\t\tsnprintf(trig->name, MAX_NAME_LEN, \"cpu%u\", cpu);\n\n\t\tled_trigger_register_simple(trig->name, &trig->_trig);\n\t}\n\n\tregister_syscore_ops(&ledtrig_cpu_syscore_ops);\n\n\tret = cpuhp_setup_state(CPUHP_AP_ONLINE_DYN, \"leds/trigger:starting\",\n\t\t\t\tledtrig_online_cpu, ledtrig_prepare_down_cpu);\n\tif (ret < 0)\n\t\tpr_err(\"CPU hotplug notifier for ledtrig-cpu could not be registered: %d\\n\",\n\t\t       ret);\n\n\tpr_info(\"ledtrig-cpu: registered to indicate activity on CPUs\\n\");\n\n\treturn 0;\n}\ndevice_initcall(ledtrig_cpu_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}