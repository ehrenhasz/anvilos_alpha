{
  "module_name": "leds-mc13783.c",
  "hash_id": "fe2df3f28aa6cdc9c7a17c31b26a4eb96643ee5363c313b3d5fa55280df2b8b2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/leds-mc13783.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/leds.h>\n#include <linux/of.h>\n#include <linux/mfd/mc13xxx.h>\n\nstruct mc13xxx_led_devtype {\n\tint\tled_min;\n\tint\tled_max;\n\tint\tnum_regs;\n\tu32\tledctrl_base;\n};\n\nstruct mc13xxx_led {\n\tstruct led_classdev\tcdev;\n\tint\t\t\tid;\n\tstruct mc13xxx_leds\t*leds;\n};\n\nstruct mc13xxx_leds {\n\tstruct mc13xxx\t\t\t*master;\n\tstruct mc13xxx_led_devtype\t*devtype;\n\tint\t\t\t\tnum_leds;\n\tstruct mc13xxx_led\t\t*led;\n};\n\nstatic unsigned int mc13xxx_max_brightness(int id)\n{\n\tif (id >= MC13783_LED_MD && id <= MC13783_LED_KP)\n\t\treturn 0x0f;\n\telse if (id >= MC13783_LED_R1 && id <= MC13783_LED_B3)\n\t\treturn 0x1f;\n\n\treturn 0x3f;\n}\n\nstatic int mc13xxx_led_set(struct led_classdev *led_cdev,\n\t\t\t    enum led_brightness value)\n{\n\tstruct mc13xxx_led *led =\n\t\tcontainer_of(led_cdev, struct mc13xxx_led, cdev);\n\tstruct mc13xxx_leds *leds = led->leds;\n\tunsigned int reg, bank, off, shift;\n\n\tswitch (led->id) {\n\tcase MC13783_LED_MD:\n\tcase MC13783_LED_AD:\n\tcase MC13783_LED_KP:\n\t\treg = 2;\n\t\tshift = 9 + (led->id - MC13783_LED_MD) * 4;\n\t\tbreak;\n\tcase MC13783_LED_R1:\n\tcase MC13783_LED_G1:\n\tcase MC13783_LED_B1:\n\tcase MC13783_LED_R2:\n\tcase MC13783_LED_G2:\n\tcase MC13783_LED_B2:\n\tcase MC13783_LED_R3:\n\tcase MC13783_LED_G3:\n\tcase MC13783_LED_B3:\n\t\toff = led->id - MC13783_LED_R1;\n\t\tbank = off / 3;\n\t\treg = 3 + bank;\n\t\tshift = (off - bank * 3) * 5 + 6;\n\t\tbreak;\n\tcase MC13892_LED_MD:\n\tcase MC13892_LED_AD:\n\tcase MC13892_LED_KP:\n\t\toff = led->id - MC13892_LED_MD;\n\t\treg = off / 2;\n\t\tshift = 3 + (off - reg * 2) * 12;\n\t\tbreak;\n\tcase MC13892_LED_R:\n\tcase MC13892_LED_G:\n\tcase MC13892_LED_B:\n\t\toff = led->id - MC13892_LED_R;\n\t\tbank = off / 2;\n\t\treg = 2 + bank;\n\t\tshift = (off - bank * 2) * 12 + 3;\n\t\tbreak;\n\tcase MC34708_LED_R:\n\tcase MC34708_LED_G:\n\t\treg = 0;\n\t\tshift = 3 + (led->id - MC34708_LED_R) * 12;\n\t\tbreak;\n\tdefault:\n\t\tBUG();\n\t}\n\n\treturn mc13xxx_reg_rmw(leds->master, leds->devtype->ledctrl_base + reg,\n\t\t\tmc13xxx_max_brightness(led->id) << shift,\n\t\t\tvalue << shift);\n}\n\n#ifdef CONFIG_OF\nstatic struct mc13xxx_leds_platform_data __init *mc13xxx_led_probe_dt(\n\tstruct platform_device *pdev)\n{\n\tstruct mc13xxx_leds *leds = platform_get_drvdata(pdev);\n\tstruct mc13xxx_leds_platform_data *pdata;\n\tstruct device_node *parent, *child;\n\tstruct device *dev = &pdev->dev;\n\tint i = 0, ret = -ENODATA;\n\n\tpdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\n\tif (!pdata)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tparent = of_get_child_by_name(dev_of_node(dev->parent), \"leds\");\n\tif (!parent)\n\t\tgoto out_node_put;\n\n\tret = of_property_read_u32_array(parent, \"led-control\",\n\t\t\t\t\t pdata->led_control,\n\t\t\t\t\t leds->devtype->num_regs);\n\tif (ret)\n\t\tgoto out_node_put;\n\n\tpdata->num_leds = of_get_available_child_count(parent);\n\n\tpdata->led = devm_kcalloc(dev, pdata->num_leds, sizeof(*pdata->led),\n\t\t\t\t  GFP_KERNEL);\n\tif (!pdata->led) {\n\t\tret = -ENOMEM;\n\t\tgoto out_node_put;\n\t}\n\n\tfor_each_available_child_of_node(parent, child) {\n\t\tconst char *str;\n\t\tu32 tmp;\n\n\t\tif (of_property_read_u32(child, \"reg\", &tmp))\n\t\t\tcontinue;\n\t\tpdata->led[i].id = leds->devtype->led_min + tmp;\n\n\t\tif (!of_property_read_string(child, \"label\", &str))\n\t\t\tpdata->led[i].name = str;\n\t\tif (!of_property_read_string(child, \"linux,default-trigger\",\n\t\t\t\t\t     &str))\n\t\t\tpdata->led[i].default_trigger = str;\n\n\t\ti++;\n\t}\n\n\tpdata->num_leds = i;\n\tret = i > 0 ? 0 : -ENODATA;\n\nout_node_put:\n\tof_node_put(parent);\n\n\treturn ret ? ERR_PTR(ret) : pdata;\n}\n#else\nstatic inline struct mc13xxx_leds_platform_data __init *mc13xxx_led_probe_dt(\n\tstruct platform_device *pdev)\n{\n\treturn ERR_PTR(-ENOSYS);\n}\n#endif\n\nstatic int __init mc13xxx_led_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct mc13xxx_leds_platform_data *pdata = dev_get_platdata(dev);\n\tstruct mc13xxx *mcdev = dev_get_drvdata(dev->parent);\n\tstruct mc13xxx_led_devtype *devtype =\n\t\t(struct mc13xxx_led_devtype *)pdev->id_entry->driver_data;\n\tstruct mc13xxx_leds *leds;\n\tint i, id, ret = -ENODATA;\n\tu32 init_led = 0;\n\n\tleds = devm_kzalloc(dev, sizeof(*leds), GFP_KERNEL);\n\tif (!leds)\n\t\treturn -ENOMEM;\n\n\tleds->devtype = devtype;\n\tleds->master = mcdev;\n\tplatform_set_drvdata(pdev, leds);\n\n\tif (dev_of_node(dev->parent)) {\n\t\tpdata = mc13xxx_led_probe_dt(pdev);\n\t\tif (IS_ERR(pdata))\n\t\t\treturn PTR_ERR(pdata);\n\t} else if (!pdata)\n\t\treturn -ENODATA;\n\n\tleds->num_leds = pdata->num_leds;\n\n\tif ((leds->num_leds < 1) ||\n\t    (leds->num_leds > (devtype->led_max - devtype->led_min + 1))) {\n\t\tdev_err(dev, \"Invalid LED count %d\\n\", leds->num_leds);\n\t\treturn -EINVAL;\n\t}\n\n\tleds->led = devm_kcalloc(dev, leds->num_leds, sizeof(*leds->led),\n\t\t\t\t GFP_KERNEL);\n\tif (!leds->led)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < devtype->num_regs; i++) {\n\t\tret = mc13xxx_reg_write(mcdev, leds->devtype->ledctrl_base + i,\n\t\t\t\t\tpdata->led_control[i]);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tfor (i = 0; i < leds->num_leds; i++) {\n\t\tconst char *name, *trig;\n\n\t\tret = -EINVAL;\n\n\t\tid = pdata->led[i].id;\n\t\tname = pdata->led[i].name;\n\t\ttrig = pdata->led[i].default_trigger;\n\n\t\tif ((id > devtype->led_max) || (id < devtype->led_min)) {\n\t\t\tdev_err(dev, \"Invalid ID %i\\n\", id);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (init_led & (1 << id)) {\n\t\t\tdev_warn(dev, \"LED %i already initialized\\n\", id);\n\t\t\tbreak;\n\t\t}\n\n\t\tinit_led |= 1 << id;\n\t\tleds->led[i].id = id;\n\t\tleds->led[i].leds = leds;\n\t\tleds->led[i].cdev.name = name;\n\t\tleds->led[i].cdev.default_trigger = trig;\n\t\tleds->led[i].cdev.flags = LED_CORE_SUSPENDRESUME;\n\t\tleds->led[i].cdev.brightness_set_blocking = mc13xxx_led_set;\n\t\tleds->led[i].cdev.max_brightness = mc13xxx_max_brightness(id);\n\n\t\tret = led_classdev_register(dev->parent, &leds->led[i].cdev);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to register LED %i\\n\", id);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (ret)\n\t\twhile (--i >= 0)\n\t\t\tled_classdev_unregister(&leds->led[i].cdev);\n\n\treturn ret;\n}\n\nstatic int mc13xxx_led_remove(struct platform_device *pdev)\n{\n\tstruct mc13xxx_leds *leds = platform_get_drvdata(pdev);\n\tint i;\n\n\tfor (i = 0; i < leds->num_leds; i++)\n\t\tled_classdev_unregister(&leds->led[i].cdev);\n\n\treturn 0;\n}\n\nstatic const struct mc13xxx_led_devtype mc13783_led_devtype = {\n\t.led_min\t= MC13783_LED_MD,\n\t.led_max\t= MC13783_LED_B3,\n\t.num_regs\t= 6,\n\t.ledctrl_base\t= 51,\n};\n\nstatic const struct mc13xxx_led_devtype mc13892_led_devtype = {\n\t.led_min\t= MC13892_LED_MD,\n\t.led_max\t= MC13892_LED_B,\n\t.num_regs\t= 4,\n\t.ledctrl_base\t= 51,\n};\n\nstatic const struct mc13xxx_led_devtype mc34708_led_devtype = {\n\t.led_min\t= MC34708_LED_R,\n\t.led_max\t= MC34708_LED_G,\n\t.num_regs\t= 1,\n\t.ledctrl_base\t= 54,\n};\n\nstatic const struct platform_device_id mc13xxx_led_id_table[] = {\n\t{ \"mc13783-led\", (kernel_ulong_t)&mc13783_led_devtype, },\n\t{ \"mc13892-led\", (kernel_ulong_t)&mc13892_led_devtype, },\n\t{ \"mc34708-led\", (kernel_ulong_t)&mc34708_led_devtype, },\n\t{ }\n};\nMODULE_DEVICE_TABLE(platform, mc13xxx_led_id_table);\n\nstatic struct platform_driver mc13xxx_led_driver = {\n\t.driver\t= {\n\t\t.name\t= \"mc13xxx-led\",\n\t},\n\t.remove\t\t= mc13xxx_led_remove,\n\t.id_table\t= mc13xxx_led_id_table,\n};\nmodule_platform_driver_probe(mc13xxx_led_driver, mc13xxx_led_probe);\n\nMODULE_DESCRIPTION(\"LEDs driver for Freescale MC13XXX PMIC\");\nMODULE_AUTHOR(\"Philippe Retornaz <philippe.retornaz@epfl.ch>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}