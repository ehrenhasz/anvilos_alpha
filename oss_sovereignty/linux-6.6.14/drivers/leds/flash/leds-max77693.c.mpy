{
  "module_name": "leds-max77693.c",
  "hash_id": "6da94254a08757a34fc1a72d341950b09b2aebf2ba5ecc32726d5cfca299f013",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/flash/leds-max77693.c",
  "human_readable_source": "\n \n\n#include <linux/led-class-flash.h>\n#include <linux/mfd/max77693.h>\n#include <linux/mfd/max77693-common.h>\n#include <linux/mfd/max77693-private.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n#include <media/v4l2-flash-led-class.h>\n\n#define MODE_OFF\t\t0\n#define MODE_FLASH(a)\t\t(1 << (a))\n#define MODE_TORCH(a)\t\t(1 << (2 + (a)))\n#define MODE_FLASH_EXTERNAL(a)\t(1 << (4 + (a)))\n\n#define MODE_FLASH_MASK\t\t(MODE_FLASH(FLED1) | MODE_FLASH(FLED2) | \\\n\t\t\t\t MODE_FLASH_EXTERNAL(FLED1) | \\\n\t\t\t\t MODE_FLASH_EXTERNAL(FLED2))\n#define MODE_TORCH_MASK\t\t(MODE_TORCH(FLED1) | MODE_TORCH(FLED2))\n\n#define FLED1_IOUT\t\t(1 << 0)\n#define FLED2_IOUT\t\t(1 << 1)\n\nenum max77693_fled {\n\tFLED1,\n\tFLED2,\n};\n\nenum max77693_led_mode {\n\tFLASH,\n\tTORCH,\n};\n\nstruct max77693_led_config_data {\n\tconst char *label[2];\n\tu32 iout_torch_max[2];\n\tu32 iout_flash_max[2];\n\tu32 flash_timeout_max[2];\n\tu32 num_leds;\n\tu32 boost_mode;\n\tu32 boost_vout;\n\tu32 low_vsys;\n};\n\nstruct max77693_sub_led {\n\t \n\tint fled_id;\n\t \n\tstruct led_classdev_flash fled_cdev;\n\t \n\tstruct v4l2_flash *v4l2_flash;\n\n\t \n\tunsigned int torch_brightness;\n\t \n\tunsigned int flash_timeout;\n\t \n\tu32 flash_faults;\n};\n\nstruct max77693_led_device {\n\t \n\tstruct regmap *regmap;\n\t \n\tstruct platform_device *pdev;\n\t \n\tstruct mutex lock;\n\n\t \n\tstruct max77693_sub_led sub_leds[2];\n\n\t \n\tu32 iout_torch_max[2];\n\t \n\tu32 iout_flash_max[2];\n\n\t \n\tunsigned int current_flash_timeout;\n\t \n\tu8 torch_iout_reg;\n\t \n\tunsigned int mode_flags;\n\t \n\tint strobing_sub_led_id;\n\t \n\tu8 fled_mask;\n\t \n\tu8 allowed_modes;\n\n\t \n\tbool iout_joint;\n};\n\nstatic u8 max77693_led_iout_to_reg(u32 ua)\n{\n\tif (ua < FLASH_IOUT_MIN)\n\t\tua = FLASH_IOUT_MIN;\n\treturn (ua - FLASH_IOUT_MIN) / FLASH_IOUT_STEP;\n}\n\nstatic u8 max77693_flash_timeout_to_reg(u32 us)\n{\n\treturn (us - FLASH_TIMEOUT_MIN) / FLASH_TIMEOUT_STEP;\n}\n\nstatic inline struct max77693_sub_led *flcdev_to_sub_led(\n\t\t\t\t\tstruct led_classdev_flash *fled_cdev)\n{\n\treturn container_of(fled_cdev, struct max77693_sub_led, fled_cdev);\n}\n\nstatic inline struct max77693_led_device *sub_led_to_led(\n\t\t\t\t\tstruct max77693_sub_led *sub_led)\n{\n\treturn container_of(sub_led, struct max77693_led_device,\n\t\t\t\tsub_leds[sub_led->fled_id]);\n}\n\nstatic inline u8 max77693_led_vsys_to_reg(u32 mv)\n{\n\treturn ((mv - MAX_FLASH1_VSYS_MIN) / MAX_FLASH1_VSYS_STEP) << 2;\n}\n\nstatic inline u8 max77693_led_vout_to_reg(u32 mv)\n{\n\treturn (mv - FLASH_VOUT_MIN) / FLASH_VOUT_STEP + FLASH_VOUT_RMIN;\n}\n\nstatic inline bool max77693_fled_used(struct max77693_led_device *led,\n\t\t\t\t\t int fled_id)\n{\n\tu8 fled_bit = (fled_id == FLED1) ? FLED1_IOUT : FLED2_IOUT;\n\n\treturn led->fled_mask & fled_bit;\n}\n\nstatic int max77693_set_mode_reg(struct max77693_led_device *led, u8 mode)\n{\n\tstruct regmap *rmap = led->regmap;\n\tint ret, v = 0, i;\n\n\tfor (i = FLED1; i <= FLED2; ++i) {\n\t\tif (mode & MODE_TORCH(i))\n\t\t\tv |= FLASH_EN_ON << TORCH_EN_SHIFT(i);\n\n\t\tif (mode & MODE_FLASH(i)) {\n\t\t\tv |= FLASH_EN_ON << FLASH_EN_SHIFT(i);\n\t\t} else if (mode & MODE_FLASH_EXTERNAL(i)) {\n\t\t\tv |= FLASH_EN_FLASH << FLASH_EN_SHIFT(i);\n\t\t\t \n\t\t\tv |= FLASH_EN_TORCH << TORCH_EN_SHIFT(i);\n\t\t}\n\t}\n\n\t \n\tif (mode & ~(MODE_TORCH(FLED1) | MODE_TORCH(FLED2))) {\n\t\tret = regmap_write(rmap, MAX77693_LED_REG_FLASH_EN, 0);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn regmap_write(rmap, MAX77693_LED_REG_FLASH_EN, v);\n}\n\nstatic int max77693_add_mode(struct max77693_led_device *led, u8 mode)\n{\n\tu8 new_mode_flags;\n\tint i, ret;\n\n\tif (led->iout_joint)\n\t\t \n\t\tmode |= (mode << 1);\n\n\t \n\tfor (i = FLED1; i <= FLED2; ++i)\n\t\tif (mode & MODE_FLASH_EXTERNAL(i))\n\t\t\tled->mode_flags &= (~MODE_TORCH(i) & ~MODE_FLASH(i));\n\n\tnew_mode_flags = mode | led->mode_flags;\n\tnew_mode_flags &= led->allowed_modes;\n\n\tif (new_mode_flags ^ led->mode_flags)\n\t\tled->mode_flags = new_mode_flags;\n\telse\n\t\treturn 0;\n\n\tret = max77693_set_mode_reg(led, led->mode_flags);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tif (mode & MODE_FLASH_MASK)\n\t\tled->mode_flags &= ~mode;\n\n\treturn ret;\n}\n\nstatic int max77693_clear_mode(struct max77693_led_device *led,\n\t\t\t\tu8 mode)\n{\n\tif (led->iout_joint)\n\t\t \n\t\tmode |= (mode << 1);\n\n\tled->mode_flags &= ~mode;\n\n\treturn max77693_set_mode_reg(led, led->mode_flags);\n}\n\nstatic void max77693_add_allowed_modes(struct max77693_led_device *led,\n\t\t\t\tint fled_id, enum max77693_led_mode mode)\n{\n\tif (mode == FLASH)\n\t\tled->allowed_modes |= (MODE_FLASH(fled_id) |\n\t\t\t\t       MODE_FLASH_EXTERNAL(fled_id));\n\telse\n\t\tled->allowed_modes |= MODE_TORCH(fled_id);\n}\n\nstatic void max77693_distribute_currents(struct max77693_led_device *led,\n\t\t\t\tint fled_id, enum max77693_led_mode mode,\n\t\t\t\tu32 micro_amp, u32 iout_max[2], u32 iout[2])\n{\n\tif (!led->iout_joint) {\n\t\tiout[fled_id] = micro_amp;\n\t\tmax77693_add_allowed_modes(led, fled_id, mode);\n\t\treturn;\n\t}\n\n\tiout[FLED1] = min(micro_amp, iout_max[FLED1]);\n\tiout[FLED2] = micro_amp - iout[FLED1];\n\n\tif (mode == FLASH)\n\t\tled->allowed_modes &= ~MODE_FLASH_MASK;\n\telse\n\t\tled->allowed_modes &= ~MODE_TORCH_MASK;\n\n\tmax77693_add_allowed_modes(led, FLED1, mode);\n\n\tif (iout[FLED2])\n\t\tmax77693_add_allowed_modes(led, FLED2, mode);\n}\n\nstatic int max77693_set_torch_current(struct max77693_led_device *led,\n\t\t\t\tint fled_id, u32 micro_amp)\n{\n\tstruct regmap *rmap = led->regmap;\n\tu8 iout1_reg = 0, iout2_reg = 0;\n\tu32 iout[2];\n\n\tmax77693_distribute_currents(led, fled_id, TORCH, micro_amp,\n\t\t\t\t\tled->iout_torch_max, iout);\n\n\tif (fled_id == FLED1 || led->iout_joint) {\n\t\tiout1_reg = max77693_led_iout_to_reg(iout[FLED1]);\n\t\tled->torch_iout_reg &= TORCH_IOUT_MASK(TORCH_IOUT2_SHIFT);\n\t}\n\tif (fled_id == FLED2 || led->iout_joint) {\n\t\tiout2_reg = max77693_led_iout_to_reg(iout[FLED2]);\n\t\tled->torch_iout_reg &= TORCH_IOUT_MASK(TORCH_IOUT1_SHIFT);\n\t}\n\n\tled->torch_iout_reg |= ((iout1_reg << TORCH_IOUT1_SHIFT) |\n\t\t\t\t(iout2_reg << TORCH_IOUT2_SHIFT));\n\n\treturn regmap_write(rmap, MAX77693_LED_REG_ITORCH,\n\t\t\t\t\t\tled->torch_iout_reg);\n}\n\nstatic int max77693_set_flash_current(struct max77693_led_device *led,\n\t\t\t\t\tint fled_id,\n\t\t\t\t\tu32 micro_amp)\n{\n\tstruct regmap *rmap = led->regmap;\n\tu8 iout1_reg, iout2_reg;\n\tu32 iout[2];\n\tint ret = -EINVAL;\n\n\tmax77693_distribute_currents(led, fled_id, FLASH, micro_amp,\n\t\t\t\t\tled->iout_flash_max, iout);\n\n\tif (fled_id == FLED1 || led->iout_joint) {\n\t\tiout1_reg = max77693_led_iout_to_reg(iout[FLED1]);\n\t\tret = regmap_write(rmap, MAX77693_LED_REG_IFLASH1,\n\t\t\t\t\t\t\tiout1_reg);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\tif (fled_id == FLED2 || led->iout_joint) {\n\t\tiout2_reg = max77693_led_iout_to_reg(iout[FLED2]);\n\t\tret = regmap_write(rmap, MAX77693_LED_REG_IFLASH2,\n\t\t\t\t\t\t\tiout2_reg);\n\t}\n\n\treturn ret;\n}\n\nstatic int max77693_set_timeout(struct max77693_led_device *led, u32 microsec)\n{\n\tstruct regmap *rmap = led->regmap;\n\tu8 v;\n\tint ret;\n\n\tv = max77693_flash_timeout_to_reg(microsec) | FLASH_TMR_LEVEL;\n\n\tret = regmap_write(rmap, MAX77693_LED_REG_FLASH_TIMER, v);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tled->current_flash_timeout = microsec;\n\n\treturn 0;\n}\n\nstatic int max77693_get_strobe_status(struct max77693_led_device *led,\n\t\t\t\t\tbool *state)\n{\n\tstruct regmap *rmap = led->regmap;\n\tunsigned int v;\n\tint ret;\n\n\tret = regmap_read(rmap, MAX77693_LED_REG_FLASH_STATUS, &v);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*state = v & FLASH_STATUS_FLASH_ON;\n\n\treturn ret;\n}\n\nstatic int max77693_get_flash_faults(struct max77693_sub_led *sub_led)\n{\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tstruct regmap *rmap = led->regmap;\n\tunsigned int v;\n\tu8 fault_open_mask, fault_short_mask;\n\tint ret;\n\n\tsub_led->flash_faults = 0;\n\n\tif (led->iout_joint) {\n\t\tfault_open_mask = FLASH_INT_FLED1_OPEN | FLASH_INT_FLED2_OPEN;\n\t\tfault_short_mask = FLASH_INT_FLED1_SHORT |\n\t\t\t\t\t\t\tFLASH_INT_FLED2_SHORT;\n\t} else {\n\t\tfault_open_mask = (sub_led->fled_id == FLED1) ?\n\t\t\t\t\t\tFLASH_INT_FLED1_OPEN :\n\t\t\t\t\t\tFLASH_INT_FLED2_OPEN;\n\t\tfault_short_mask = (sub_led->fled_id == FLED1) ?\n\t\t\t\t\t\tFLASH_INT_FLED1_SHORT :\n\t\t\t\t\t\tFLASH_INT_FLED2_SHORT;\n\t}\n\n\tret = regmap_read(rmap, MAX77693_LED_REG_FLASH_INT, &v);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (v & fault_open_mask)\n\t\tsub_led->flash_faults |= LED_FAULT_OVER_VOLTAGE;\n\tif (v & fault_short_mask)\n\t\tsub_led->flash_faults |= LED_FAULT_SHORT_CIRCUIT;\n\tif (v & FLASH_INT_OVER_CURRENT)\n\t\tsub_led->flash_faults |= LED_FAULT_OVER_CURRENT;\n\n\treturn 0;\n}\n\nstatic int max77693_setup(struct max77693_led_device *led,\n\t\t\t struct max77693_led_config_data *led_cfg)\n{\n\tstruct regmap *rmap = led->regmap;\n\tint i, first_led, last_led, ret;\n\tu32 max_flash_curr[2];\n\tu8 v;\n\n\t \n\tif (led->iout_joint) {\n\t\tfirst_led = FLED1;\n\t\tlast_led = FLED1;\n\t\tmax_flash_curr[FLED1] = led_cfg->iout_flash_max[FLED1] +\n\t\t\t\t\tled_cfg->iout_flash_max[FLED2];\n\t} else {\n\t\tfirst_led = max77693_fled_used(led, FLED1) ? FLED1 : FLED2;\n\t\tlast_led = max77693_fled_used(led, FLED2) ? FLED2 : FLED1;\n\t\tmax_flash_curr[FLED1] = led_cfg->iout_flash_max[FLED1];\n\t\tmax_flash_curr[FLED2] = led_cfg->iout_flash_max[FLED2];\n\t}\n\n\tfor (i = first_led; i <= last_led; ++i) {\n\t\tret = max77693_set_flash_current(led, i,\n\t\t\t\t\tmax_flash_curr[i]);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tv = TORCH_TMR_NO_TIMER | MAX77693_LED_TRIG_TYPE_LEVEL;\n\tret = regmap_write(rmap, MAX77693_LED_REG_ITORCHTIMER, v);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (led_cfg->low_vsys > 0)\n\t\tv = max77693_led_vsys_to_reg(led_cfg->low_vsys) |\n\t\t\t\t\t\tMAX_FLASH1_MAX_FL_EN;\n\telse\n\t\tv = 0;\n\n\tret = regmap_write(rmap, MAX77693_LED_REG_MAX_FLASH1, v);\n\tif (ret < 0)\n\t\treturn ret;\n\tret = regmap_write(rmap, MAX77693_LED_REG_MAX_FLASH2, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (led_cfg->boost_mode == MAX77693_LED_BOOST_FIXED)\n\t\tv = FLASH_BOOST_FIXED;\n\telse\n\t\tv = led_cfg->boost_mode | led_cfg->boost_mode << 1;\n\n\tif (max77693_fled_used(led, FLED1) && max77693_fled_used(led, FLED2))\n\t\tv |= FLASH_BOOST_LEDNUM_2;\n\n\tret = regmap_write(rmap, MAX77693_LED_REG_VOUT_CNTL, v);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tv = max77693_led_vout_to_reg(led_cfg->boost_vout);\n\tret = regmap_write(rmap, MAX77693_LED_REG_VOUT_FLASH1, v);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn max77693_set_mode_reg(led, MODE_OFF);\n}\n\n \nstatic int max77693_led_brightness_set(struct led_classdev *led_cdev,\n\t\t\t\t\tenum led_brightness value)\n{\n\tstruct led_classdev_flash *fled_cdev = lcdev_to_flcdev(led_cdev);\n\tstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tint fled_id = sub_led->fled_id, ret;\n\n\tmutex_lock(&led->lock);\n\n\tif (value == 0) {\n\t\tret = max77693_clear_mode(led, MODE_TORCH(fled_id));\n\t\tif (ret < 0)\n\t\t\tdev_dbg(&led->pdev->dev,\n\t\t\t\t\"Failed to clear torch mode (%d)\\n\",\n\t\t\t\tret);\n\t\tgoto unlock;\n\t}\n\n\tret = max77693_set_torch_current(led, fled_id, value * TORCH_IOUT_STEP);\n\tif (ret < 0) {\n\t\tdev_dbg(&led->pdev->dev,\n\t\t\t\"Failed to set torch current (%d)\\n\",\n\t\t\tret);\n\t\tgoto unlock;\n\t}\n\n\tret = max77693_add_mode(led, MODE_TORCH(fled_id));\n\tif (ret < 0)\n\t\tdev_dbg(&led->pdev->dev,\n\t\t\t\"Failed to set torch mode (%d)\\n\",\n\t\t\tret);\nunlock:\n\tmutex_unlock(&led->lock);\n\n\treturn ret;\n}\n\nstatic int max77693_led_flash_brightness_set(\n\t\t\t\tstruct led_classdev_flash *fled_cdev,\n\t\t\t\tu32 brightness)\n{\n\tstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tint ret;\n\n\tmutex_lock(&led->lock);\n\tret = max77693_set_flash_current(led, sub_led->fled_id, brightness);\n\tmutex_unlock(&led->lock);\n\n\treturn ret;\n}\n\nstatic int max77693_led_flash_strobe_set(\n\t\t\t\tstruct led_classdev_flash *fled_cdev,\n\t\t\t\tbool state)\n{\n\tstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tint fled_id = sub_led->fled_id;\n\tint ret;\n\n\tmutex_lock(&led->lock);\n\n\tif (!state) {\n\t\tret = max77693_clear_mode(led, MODE_FLASH(fled_id));\n\t\tgoto unlock;\n\t}\n\n\tif (sub_led->flash_timeout != led->current_flash_timeout) {\n\t\tret = max77693_set_timeout(led, sub_led->flash_timeout);\n\t\tif (ret < 0)\n\t\t\tgoto unlock;\n\t}\n\n\tled->strobing_sub_led_id = fled_id;\n\n\tret = max77693_add_mode(led, MODE_FLASH(fled_id));\n\tif (ret < 0)\n\t\tgoto unlock;\n\n\tret = max77693_get_flash_faults(sub_led);\n\nunlock:\n\tmutex_unlock(&led->lock);\n\treturn ret;\n}\n\nstatic int max77693_led_flash_fault_get(\n\t\t\t\tstruct led_classdev_flash *fled_cdev,\n\t\t\t\tu32 *fault)\n{\n\tstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\n\n\t*fault = sub_led->flash_faults;\n\n\treturn 0;\n}\n\nstatic int max77693_led_flash_strobe_get(\n\t\t\t\tstruct led_classdev_flash *fled_cdev,\n\t\t\t\tbool *state)\n{\n\tstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tint ret;\n\n\tif (!state)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&led->lock);\n\n\tret = max77693_get_strobe_status(led, state);\n\n\t*state = !!(*state && (led->strobing_sub_led_id == sub_led->fled_id));\n\n\tmutex_unlock(&led->lock);\n\n\treturn ret;\n}\n\nstatic int max77693_led_flash_timeout_set(\n\t\t\t\tstruct led_classdev_flash *fled_cdev,\n\t\t\t\tu32 timeout)\n{\n\tstruct max77693_sub_led *sub_led = flcdev_to_sub_led(fled_cdev);\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\n\tmutex_lock(&led->lock);\n\tsub_led->flash_timeout = timeout;\n\tmutex_unlock(&led->lock);\n\n\treturn 0;\n}\n\nstatic int max77693_led_parse_dt(struct max77693_led_device *led,\n\t\t\t\tstruct max77693_led_config_data *cfg,\n\t\t\t\tstruct device_node **sub_nodes)\n{\n\tstruct device *dev = &led->pdev->dev;\n\tstruct max77693_sub_led *sub_leds = led->sub_leds;\n\tstruct device_node *node = dev_of_node(dev), *child_node;\n\tstruct property *prop;\n\tu32 led_sources[2];\n\tint i, ret, fled_id;\n\n\tof_property_read_u32(node, \"maxim,boost-mode\", &cfg->boost_mode);\n\tof_property_read_u32(node, \"maxim,boost-mvout\", &cfg->boost_vout);\n\tof_property_read_u32(node, \"maxim,mvsys-min\", &cfg->low_vsys);\n\n\tfor_each_available_child_of_node(node, child_node) {\n\t\tprop = of_find_property(child_node, \"led-sources\", NULL);\n\t\tif (prop) {\n\t\t\tconst __be32 *srcs = NULL;\n\n\t\t\tfor (i = 0; i < ARRAY_SIZE(led_sources); ++i) {\n\t\t\t\tsrcs = of_prop_next_u32(prop, srcs,\n\t\t\t\t\t\t\t&led_sources[i]);\n\t\t\t\tif (!srcs)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t} else {\n\t\t\tdev_err(dev,\n\t\t\t\t\"led-sources DT property missing\\n\");\n\t\t\tof_node_put(child_node);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tif (i == 2) {\n\t\t\tfled_id = FLED1;\n\t\t\tled->fled_mask = FLED1_IOUT | FLED2_IOUT;\n\t\t} else if (led_sources[0] == FLED1) {\n\t\t\tfled_id = FLED1;\n\t\t\tled->fled_mask |= FLED1_IOUT;\n\t\t} else if (led_sources[0] == FLED2) {\n\t\t\tfled_id = FLED2;\n\t\t\tled->fled_mask |= FLED2_IOUT;\n\t\t} else {\n\t\t\tdev_err(dev,\n\t\t\t\t\"Wrong led-sources DT property value.\\n\");\n\t\t\tof_node_put(child_node);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tif (sub_nodes[fled_id]) {\n\t\t\tdev_err(dev,\n\t\t\t\t\"Conflicting \\\"led-sources\\\" DT properties\\n\");\n\t\t\tof_node_put(child_node);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tsub_nodes[fled_id] = child_node;\n\t\tsub_leds[fled_id].fled_id = fled_id;\n\n\t\tcfg->label[fled_id] =\n\t\t\tof_get_property(child_node, \"label\", NULL) ? :\n\t\t\t\t\t\tchild_node->name;\n\n\t\tret = of_property_read_u32(child_node, \"led-max-microamp\",\n\t\t\t\t\t&cfg->iout_torch_max[fled_id]);\n\t\tif (ret < 0) {\n\t\t\tcfg->iout_torch_max[fled_id] = TORCH_IOUT_MIN;\n\t\t\tdev_warn(dev, \"led-max-microamp DT property missing\\n\");\n\t\t}\n\n\t\tret = of_property_read_u32(child_node, \"flash-max-microamp\",\n\t\t\t\t\t&cfg->iout_flash_max[fled_id]);\n\t\tif (ret < 0) {\n\t\t\tcfg->iout_flash_max[fled_id] = FLASH_IOUT_MIN;\n\t\t\tdev_warn(dev,\n\t\t\t\t \"flash-max-microamp DT property missing\\n\");\n\t\t}\n\n\t\tret = of_property_read_u32(child_node, \"flash-max-timeout-us\",\n\t\t\t\t\t&cfg->flash_timeout_max[fled_id]);\n\t\tif (ret < 0) {\n\t\t\tcfg->flash_timeout_max[fled_id] = FLASH_TIMEOUT_MIN;\n\t\t\tdev_warn(dev,\n\t\t\t\t \"flash-max-timeout-us DT property missing\\n\");\n\t\t}\n\n\t\tif (++cfg->num_leds == 2 ||\n\t\t    (max77693_fled_used(led, FLED1) &&\n\t\t     max77693_fled_used(led, FLED2))) {\n\t\t\tof_node_put(child_node);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (cfg->num_leds == 0) {\n\t\tdev_err(dev, \"No DT child node found for connected LED(s).\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void clamp_align(u32 *v, u32 min, u32 max, u32 step)\n{\n\t*v = clamp_val(*v, min, max);\n\tif (step > 1)\n\t\t*v = (*v - min) / step * step + min;\n}\n\nstatic void max77693_align_iout_current(struct max77693_led_device *led,\n\t\t\t\t\tu32 *iout, u32 min, u32 max, u32 step)\n{\n\tint i;\n\n\tif (led->iout_joint) {\n\t\tif (iout[FLED1] > min) {\n\t\t\tiout[FLED1] /= 2;\n\t\t\tiout[FLED2] = iout[FLED1];\n\t\t} else {\n\t\t\tiout[FLED1] = min;\n\t\t\tiout[FLED2] = 0;\n\t\t\treturn;\n\t\t}\n\t}\n\n\tfor (i = FLED1; i <= FLED2; ++i)\n\t\tif (max77693_fled_used(led, i))\n\t\t\tclamp_align(&iout[i], min, max, step);\n\t\telse\n\t\t\tiout[i] = 0;\n}\n\nstatic void max77693_led_validate_configuration(struct max77693_led_device *led,\n\t\t\t\t\tstruct max77693_led_config_data *cfg)\n{\n\tu32 flash_iout_max = cfg->boost_mode ? FLASH_IOUT_MAX_2LEDS :\n\t\t\t\t\t       FLASH_IOUT_MAX_1LED;\n\tint i;\n\n\tif (cfg->num_leds == 1 &&\n\t    max77693_fled_used(led, FLED1) && max77693_fled_used(led, FLED2))\n\t\tled->iout_joint = true;\n\n\tcfg->boost_mode = clamp_val(cfg->boost_mode, MAX77693_LED_BOOST_NONE,\n\t\t\t    MAX77693_LED_BOOST_FIXED);\n\n\t \n\tif ((cfg->boost_mode == MAX77693_LED_BOOST_NONE) && led->iout_joint)\n\t\tcfg->boost_mode = MAX77693_LED_BOOST_FIXED;\n\n\tmax77693_align_iout_current(led, cfg->iout_torch_max,\n\t\t\tTORCH_IOUT_MIN, TORCH_IOUT_MAX, TORCH_IOUT_STEP);\n\n\tmax77693_align_iout_current(led, cfg->iout_flash_max,\n\t\t\tFLASH_IOUT_MIN, flash_iout_max, FLASH_IOUT_STEP);\n\n\tfor (i = 0; i < ARRAY_SIZE(cfg->flash_timeout_max); ++i)\n\t\tclamp_align(&cfg->flash_timeout_max[i], FLASH_TIMEOUT_MIN,\n\t\t\t\tFLASH_TIMEOUT_MAX, FLASH_TIMEOUT_STEP);\n\n\tclamp_align(&cfg->boost_vout, FLASH_VOUT_MIN, FLASH_VOUT_MAX,\n\t\t\t\t\t\t\tFLASH_VOUT_STEP);\n\n\tif (cfg->low_vsys)\n\t\tclamp_align(&cfg->low_vsys, MAX_FLASH1_VSYS_MIN,\n\t\t\t\tMAX_FLASH1_VSYS_MAX, MAX_FLASH1_VSYS_STEP);\n}\n\nstatic int max77693_led_get_configuration(struct max77693_led_device *led,\n\t\t\t\tstruct max77693_led_config_data *cfg,\n\t\t\t\tstruct device_node **sub_nodes)\n{\n\tint ret;\n\n\tret = max77693_led_parse_dt(led, cfg, sub_nodes);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tmax77693_led_validate_configuration(led, cfg);\n\n\tmemcpy(led->iout_torch_max, cfg->iout_torch_max,\n\t\t\t\tsizeof(led->iout_torch_max));\n\tmemcpy(led->iout_flash_max, cfg->iout_flash_max,\n\t\t\t\tsizeof(led->iout_flash_max));\n\n\treturn 0;\n}\n\nstatic const struct led_flash_ops flash_ops = {\n\t.flash_brightness_set\t= max77693_led_flash_brightness_set,\n\t.strobe_set\t\t= max77693_led_flash_strobe_set,\n\t.strobe_get\t\t= max77693_led_flash_strobe_get,\n\t.timeout_set\t\t= max77693_led_flash_timeout_set,\n\t.fault_get\t\t= max77693_led_flash_fault_get,\n};\n\nstatic void max77693_init_flash_settings(struct max77693_sub_led *sub_led,\n\t\t\t\t struct max77693_led_config_data *led_cfg)\n{\n\tstruct led_classdev_flash *fled_cdev = &sub_led->fled_cdev;\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tint fled_id = sub_led->fled_id;\n\tstruct led_flash_setting *setting;\n\n\t \n\tsetting = &fled_cdev->brightness;\n\tsetting->min = FLASH_IOUT_MIN;\n\tsetting->max = led->iout_joint ?\n\t\tled_cfg->iout_flash_max[FLED1] +\n\t\tled_cfg->iout_flash_max[FLED2] :\n\t\tled_cfg->iout_flash_max[fled_id];\n\tsetting->step = FLASH_IOUT_STEP;\n\tsetting->val = setting->max;\n\n\t \n\tsetting = &fled_cdev->timeout;\n\tsetting->min = FLASH_TIMEOUT_MIN;\n\tsetting->max = led_cfg->flash_timeout_max[fled_id];\n\tsetting->step = FLASH_TIMEOUT_STEP;\n\tsetting->val = setting->max;\n}\n\n#if IS_ENABLED(CONFIG_V4L2_FLASH_LED_CLASS)\n\nstatic int max77693_led_external_strobe_set(\n\t\t\t\tstruct v4l2_flash *v4l2_flash,\n\t\t\t\tbool enable)\n{\n\tstruct max77693_sub_led *sub_led =\n\t\t\t\tflcdev_to_sub_led(v4l2_flash->fled_cdev);\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tint fled_id = sub_led->fled_id;\n\tint ret;\n\n\tmutex_lock(&led->lock);\n\n\tif (enable)\n\t\tret = max77693_add_mode(led, MODE_FLASH_EXTERNAL(fled_id));\n\telse\n\t\tret = max77693_clear_mode(led, MODE_FLASH_EXTERNAL(fled_id));\n\n\tmutex_unlock(&led->lock);\n\n\treturn ret;\n}\n\nstatic void max77693_init_v4l2_flash_config(struct max77693_sub_led *sub_led,\n\t\t\t\tstruct max77693_led_config_data *led_cfg,\n\t\t\t\tstruct v4l2_flash_config *v4l2_sd_cfg)\n{\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tstruct device *dev = &led->pdev->dev;\n\tstruct max77693_dev *iodev = dev_get_drvdata(dev->parent);\n\tstruct i2c_client *i2c = iodev->i2c;\n\tstruct led_flash_setting *s;\n\n\tsnprintf(v4l2_sd_cfg->dev_name, sizeof(v4l2_sd_cfg->dev_name),\n\t\t \"%s %d-%04x\", sub_led->fled_cdev.led_cdev.name,\n\t\t i2c_adapter_id(i2c->adapter), i2c->addr);\n\n\ts = &v4l2_sd_cfg->intensity;\n\ts->min = TORCH_IOUT_MIN;\n\ts->max = sub_led->fled_cdev.led_cdev.max_brightness * TORCH_IOUT_STEP;\n\ts->step = TORCH_IOUT_STEP;\n\ts->val = s->max;\n\n\t \n\tv4l2_sd_cfg->flash_faults = LED_FAULT_OVER_VOLTAGE |\n\t\t\t\tLED_FAULT_SHORT_CIRCUIT |\n\t\t\t\tLED_FAULT_OVER_CURRENT;\n\n\tv4l2_sd_cfg->has_external_strobe = true;\n}\n\nstatic const struct v4l2_flash_ops v4l2_flash_ops = {\n\t.external_strobe_set = max77693_led_external_strobe_set,\n};\n#else\nstatic inline void max77693_init_v4l2_flash_config(\n\t\t\t\tstruct max77693_sub_led *sub_led,\n\t\t\t\tstruct max77693_led_config_data *led_cfg,\n\t\t\t\tstruct v4l2_flash_config *v4l2_sd_cfg)\n{\n}\nstatic const struct v4l2_flash_ops v4l2_flash_ops;\n#endif\n\nstatic void max77693_init_fled_cdev(struct max77693_sub_led *sub_led,\n\t\t\t\tstruct max77693_led_config_data *led_cfg)\n{\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tint fled_id = sub_led->fled_id;\n\tstruct led_classdev_flash *fled_cdev;\n\tstruct led_classdev *led_cdev;\n\n\t \n\tfled_cdev = &sub_led->fled_cdev;\n\tfled_cdev->ops = &flash_ops;\n\tled_cdev = &fled_cdev->led_cdev;\n\n\tled_cdev->name = led_cfg->label[fled_id];\n\n\tled_cdev->brightness_set_blocking = max77693_led_brightness_set;\n\tled_cdev->max_brightness = (led->iout_joint ?\n\t\t\t\t\tled_cfg->iout_torch_max[FLED1] +\n\t\t\t\t\tled_cfg->iout_torch_max[FLED2] :\n\t\t\t\t\tled_cfg->iout_torch_max[fled_id]) /\n\t\t\t\t   TORCH_IOUT_STEP;\n\tled_cdev->flags |= LED_DEV_CAP_FLASH;\n\n\tmax77693_init_flash_settings(sub_led, led_cfg);\n\n\t \n\tsub_led->flash_timeout = fled_cdev->timeout.val;\n}\n\nstatic int max77693_register_led(struct max77693_sub_led *sub_led,\n\t\t\t\t struct max77693_led_config_data *led_cfg,\n\t\t\t\t struct device_node *sub_node)\n{\n\tstruct max77693_led_device *led = sub_led_to_led(sub_led);\n\tstruct led_classdev_flash *fled_cdev = &sub_led->fled_cdev;\n\tstruct device *dev = &led->pdev->dev;\n\tstruct v4l2_flash_config v4l2_sd_cfg = {};\n\tint ret;\n\n\t \n\tret = led_classdev_flash_register(dev, fled_cdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tmax77693_init_v4l2_flash_config(sub_led, led_cfg, &v4l2_sd_cfg);\n\n\t \n\tsub_led->v4l2_flash = v4l2_flash_init(dev, of_fwnode_handle(sub_node),\n\t\t\t\t\t      fled_cdev, &v4l2_flash_ops,\n\t\t\t\t\t      &v4l2_sd_cfg);\n\tif (IS_ERR(sub_led->v4l2_flash)) {\n\t\tret = PTR_ERR(sub_led->v4l2_flash);\n\t\tgoto err_v4l2_flash_init;\n\t}\n\n\treturn 0;\n\nerr_v4l2_flash_init:\n\tled_classdev_flash_unregister(fled_cdev);\n\treturn ret;\n}\n\nstatic int max77693_led_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct max77693_dev *iodev = dev_get_drvdata(dev->parent);\n\tstruct max77693_led_device *led;\n\tstruct max77693_sub_led *sub_leds;\n\tstruct device_node *sub_nodes[2] = {};\n\tstruct max77693_led_config_data led_cfg = {};\n\tint init_fled_cdev[2], i, ret;\n\n\tled = devm_kzalloc(dev, sizeof(*led), GFP_KERNEL);\n\tif (!led)\n\t\treturn -ENOMEM;\n\n\tled->pdev = pdev;\n\tled->regmap = iodev->regmap;\n\tled->allowed_modes = MODE_FLASH_MASK;\n\tsub_leds = led->sub_leds;\n\n\tplatform_set_drvdata(pdev, led);\n\tret = max77693_led_get_configuration(led, &led_cfg, sub_nodes);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = max77693_setup(led, &led_cfg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tmutex_init(&led->lock);\n\n\tinit_fled_cdev[FLED1] =\n\t\t\tled->iout_joint || max77693_fled_used(led, FLED1);\n\tinit_fled_cdev[FLED2] =\n\t\t\t!led->iout_joint && max77693_fled_used(led, FLED2);\n\n\tfor (i = FLED1; i <= FLED2; ++i) {\n\t\tif (!init_fled_cdev[i])\n\t\t\tcontinue;\n\n\t\t \n\t\tmax77693_init_fled_cdev(&sub_leds[i], &led_cfg);\n\n\t\t \n\t\tret = max77693_register_led(&sub_leds[i], &led_cfg,\n\t\t\t\t\t\tsub_nodes[i]);\n\t\tif (ret < 0) {\n\t\t\t \n\t\t\tif (i == FLED2)\n\t\t\t\tgoto err_register_led2;\n\t\t\telse\n\t\t\t\tgoto err_register_led1;\n\t\t}\n\t}\n\n\treturn 0;\n\nerr_register_led2:\n\t \n\tif (!init_fled_cdev[FLED1])\n\t\tgoto err_register_led1;\n\tv4l2_flash_release(sub_leds[FLED1].v4l2_flash);\n\tled_classdev_flash_unregister(&sub_leds[FLED1].fled_cdev);\nerr_register_led1:\n\tmutex_destroy(&led->lock);\n\n\treturn ret;\n}\n\nstatic int max77693_led_remove(struct platform_device *pdev)\n{\n\tstruct max77693_led_device *led = platform_get_drvdata(pdev);\n\tstruct max77693_sub_led *sub_leds = led->sub_leds;\n\n\tif (led->iout_joint || max77693_fled_used(led, FLED1)) {\n\t\tv4l2_flash_release(sub_leds[FLED1].v4l2_flash);\n\t\tled_classdev_flash_unregister(&sub_leds[FLED1].fled_cdev);\n\t}\n\n\tif (!led->iout_joint && max77693_fled_used(led, FLED2)) {\n\t\tv4l2_flash_release(sub_leds[FLED2].v4l2_flash);\n\t\tled_classdev_flash_unregister(&sub_leds[FLED2].fled_cdev);\n\t}\n\n\tmutex_destroy(&led->lock);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id max77693_led_dt_match[] = {\n\t{ .compatible = \"maxim,max77693-led\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, max77693_led_dt_match);\n\nstatic struct platform_driver max77693_led_driver = {\n\t.probe\t\t= max77693_led_probe,\n\t.remove\t\t= max77693_led_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"max77693-led\",\n\t\t.of_match_table = max77693_led_dt_match,\n\t},\n};\n\nmodule_platform_driver(max77693_led_driver);\n\nMODULE_AUTHOR(\"Jacek Anaszewski <j.anaszewski@samsung.com>\");\nMODULE_AUTHOR(\"Andrzej Hajda <a.hajda@samsung.com>\");\nMODULE_DESCRIPTION(\"Maxim MAX77693 led flash driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}