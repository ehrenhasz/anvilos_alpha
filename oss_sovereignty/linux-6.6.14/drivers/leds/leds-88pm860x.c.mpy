{
  "module_name": "leds-88pm860x.c",
  "hash_id": "bc7e4e0252228a9fb2f9e83bf0dc78a6e54e28228e445903a3a462c6155bb4aa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/leds/leds-88pm860x.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/i2c.h>\n#include <linux/leds.h>\n#include <linux/slab.h>\n#include <linux/mfd/88pm860x.h>\n#include <linux/module.h>\n\n#define LED_PWM_MASK\t\t(0x1F)\n#define LED_CURRENT_MASK\t(0x07 << 5)\n\n#define LED_BLINK_MASK\t\t(0x7F)\n\n#define LED_ON_CONTINUOUS\t(0x0F << 3)\n\n#define LED1_BLINK_EN\t\t(1 << 1)\n#define LED2_BLINK_EN\t\t(1 << 2)\n\nstruct pm860x_led {\n\tstruct led_classdev cdev;\n\tstruct i2c_client *i2c;\n\tstruct pm860x_chip *chip;\n\tstruct mutex lock;\n\tchar name[MFD_NAME_SIZE];\n\n\tint port;\n\tint iset;\n\tunsigned char brightness;\n\tunsigned char current_brightness;\n\n\tint reg_control;\n\tint reg_blink;\n\tint blink_mask;\n};\n\nstatic int led_power_set(struct pm860x_chip *chip, int port, int on)\n{\n\tint ret = -EINVAL;\n\n\tswitch (port) {\n\tcase 0:\n\tcase 1:\n\tcase 2:\n\t\tret = on ? pm8606_osc_enable(chip, RGB1_ENABLE) :\n\t\t\tpm8606_osc_disable(chip, RGB1_ENABLE);\n\t\tbreak;\n\tcase 3:\n\tcase 4:\n\tcase 5:\n\t\tret = on ? pm8606_osc_enable(chip, RGB2_ENABLE) :\n\t\t\tpm8606_osc_disable(chip, RGB2_ENABLE);\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic int pm860x_led_set(struct led_classdev *cdev,\n\t\t\t   enum led_brightness value)\n{\n\tstruct pm860x_led *led = container_of(cdev, struct pm860x_led, cdev);\n\tstruct pm860x_chip *chip;\n\tunsigned char buf[3];\n\tint ret;\n\n\tchip = led->chip;\n\tmutex_lock(&led->lock);\n\tled->brightness = value >> 3;\n\n\tif ((led->current_brightness == 0) && led->brightness) {\n\t\tled_power_set(chip, led->port, 1);\n\t\tif (led->iset) {\n\t\t\tpm860x_set_bits(led->i2c, led->reg_control,\n\t\t\t\t\tLED_CURRENT_MASK, led->iset);\n\t\t}\n\t\tpm860x_set_bits(led->i2c, led->reg_blink,\n\t\t\t\tLED_BLINK_MASK, LED_ON_CONTINUOUS);\n\t\tpm860x_set_bits(led->i2c, PM8606_WLED3B, led->blink_mask,\n\t\t\t\tled->blink_mask);\n\t}\n\tpm860x_set_bits(led->i2c, led->reg_control, LED_PWM_MASK,\n\t\t\tled->brightness);\n\n\tif (led->brightness == 0) {\n\t\tpm860x_bulk_read(led->i2c, led->reg_control, 3, buf);\n\t\tret = buf[0] & LED_PWM_MASK;\n\t\tret |= buf[1] & LED_PWM_MASK;\n\t\tret |= buf[2] & LED_PWM_MASK;\n\t\tif (ret == 0) {\n\t\t\t \n\t\t\tpm860x_set_bits(led->i2c, led->reg_control,\n\t\t\t\t\tLED_CURRENT_MASK, 0);\n\t\t\tpm860x_set_bits(led->i2c, PM8606_WLED3B,\n\t\t\t\t\tled->blink_mask, 0);\n\t\t\tled_power_set(chip, led->port, 0);\n\t\t}\n\t}\n\tled->current_brightness = led->brightness;\n\tdev_dbg(chip->dev, \"Update LED. (reg:%d, brightness:%d)\\n\",\n\t\tled->reg_control, led->brightness);\n\tmutex_unlock(&led->lock);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_OF\nstatic int pm860x_led_dt_init(struct platform_device *pdev,\n\t\t\t      struct pm860x_led *data)\n{\n\tstruct device_node *nproot, *np;\n\tint iset = 0;\n\n\tif (!dev_of_node(pdev->dev.parent))\n\t\treturn -ENODEV;\n\tnproot = of_get_child_by_name(dev_of_node(pdev->dev.parent), \"leds\");\n\tif (!nproot) {\n\t\tdev_err(&pdev->dev, \"failed to find leds node\\n\");\n\t\treturn -ENODEV;\n\t}\n\tfor_each_available_child_of_node(nproot, np) {\n\t\tif (of_node_name_eq(np, data->name)) {\n\t\t\tof_property_read_u32(np, \"marvell,88pm860x-iset\",\n\t\t\t\t\t     &iset);\n\t\t\tdata->iset = PM8606_LED_CURRENT(iset);\n\t\t\tof_node_put(np);\n\t\t\tbreak;\n\t\t}\n\t}\n\tof_node_put(nproot);\n\treturn 0;\n}\n#else\n#define pm860x_led_dt_init(x, y)\t(-1)\n#endif\n\nstatic int pm860x_led_probe(struct platform_device *pdev)\n{\n\tstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\n\tstruct pm860x_led_pdata *pdata = dev_get_platdata(&pdev->dev);\n\tstruct pm860x_led *data;\n\tstruct resource *res;\n\tint ret = 0;\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(struct pm860x_led), GFP_KERNEL);\n\tif (data == NULL)\n\t\treturn -ENOMEM;\n\tres = platform_get_resource_byname(pdev, IORESOURCE_REG, \"control\");\n\tif (!res) {\n\t\tdev_err(&pdev->dev, \"No REG resource for control\\n\");\n\t\treturn -ENXIO;\n\t}\n\tdata->reg_control = res->start;\n\tres = platform_get_resource_byname(pdev, IORESOURCE_REG, \"blink\");\n\tif (!res) {\n\t\tdev_err(&pdev->dev, \"No REG resource for blink\\n\");\n\t\treturn -ENXIO;\n\t}\n\tdata->reg_blink = res->start;\n\tmemset(data->name, 0, MFD_NAME_SIZE);\n\tswitch (pdev->id) {\n\tcase 0:\n\t\tdata->blink_mask = LED1_BLINK_EN;\n\t\tsprintf(data->name, \"led0-red\");\n\t\tbreak;\n\tcase 1:\n\t\tdata->blink_mask = LED1_BLINK_EN;\n\t\tsprintf(data->name, \"led0-green\");\n\t\tbreak;\n\tcase 2:\n\t\tdata->blink_mask = LED1_BLINK_EN;\n\t\tsprintf(data->name, \"led0-blue\");\n\t\tbreak;\n\tcase 3:\n\t\tdata->blink_mask = LED2_BLINK_EN;\n\t\tsprintf(data->name, \"led1-red\");\n\t\tbreak;\n\tcase 4:\n\t\tdata->blink_mask = LED2_BLINK_EN;\n\t\tsprintf(data->name, \"led1-green\");\n\t\tbreak;\n\tcase 5:\n\t\tdata->blink_mask = LED2_BLINK_EN;\n\t\tsprintf(data->name, \"led1-blue\");\n\t\tbreak;\n\t}\n\tdata->chip = chip;\n\tdata->i2c = (chip->id == CHIP_PM8606) ? chip->client : chip->companion;\n\tdata->port = pdev->id;\n\tif (pm860x_led_dt_init(pdev, data))\n\t\tif (pdata)\n\t\t\tdata->iset = pdata->iset;\n\n\tdata->current_brightness = 0;\n\tdata->cdev.name = data->name;\n\tdata->cdev.brightness_set_blocking = pm860x_led_set;\n\tmutex_init(&data->lock);\n\n\tret = led_classdev_register(chip->dev, &data->cdev);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"Failed to register LED: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tpm860x_led_set(&data->cdev, 0);\n\n\tplatform_set_drvdata(pdev, data);\n\n\treturn 0;\n}\n\nstatic int pm860x_led_remove(struct platform_device *pdev)\n{\n\tstruct pm860x_led *data = platform_get_drvdata(pdev);\n\n\tled_classdev_unregister(&data->cdev);\n\n\treturn 0;\n}\n\nstatic struct platform_driver pm860x_led_driver = {\n\t.driver\t= {\n\t\t.name\t= \"88pm860x-led\",\n\t},\n\t.probe\t= pm860x_led_probe,\n\t.remove\t= pm860x_led_remove,\n};\n\nmodule_platform_driver(pm860x_led_driver);\n\nMODULE_DESCRIPTION(\"LED driver for Marvell PM860x\");\nMODULE_AUTHOR(\"Haojian Zhuang <haojian.zhuang@marvell.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:88pm860x-led\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}